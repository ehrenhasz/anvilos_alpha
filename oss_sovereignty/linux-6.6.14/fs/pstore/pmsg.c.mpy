{
  "module_name": "pmsg.c",
  "hash_id": "4de81a40711751c558417a7adc89e29010c371d6f17628c2c4c8fe9550dfb0e0",
  "original_prompt": "Ingested from linux-6.6.14/fs/pstore/pmsg.c",
  "human_readable_source": "\n \n\n#include <linux/cdev.h>\n#include <linux/device.h>\n#include <linux/fs.h>\n#include <linux/uaccess.h>\n#include \"internal.h\"\n\nstatic DEFINE_MUTEX(pmsg_lock);\n\nstatic ssize_t write_pmsg(struct file *file, const char __user *buf,\n\t\t\t  size_t count, loff_t *ppos)\n{\n\tstruct pstore_record record;\n\tint ret;\n\n\tif (!count)\n\t\treturn 0;\n\n\tpstore_record_init(&record, psinfo);\n\trecord.type = PSTORE_TYPE_PMSG;\n\trecord.size = count;\n\n\t \n\tif (!access_ok(buf, count))\n\t\treturn -EFAULT;\n\n\tmutex_lock(&pmsg_lock);\n\tret = psinfo->write_user(&record, buf);\n\tmutex_unlock(&pmsg_lock);\n\treturn ret ? ret : count;\n}\n\nstatic const struct file_operations pmsg_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.llseek\t\t= noop_llseek,\n\t.write\t\t= write_pmsg,\n};\n\nstatic struct class *pmsg_class;\nstatic int pmsg_major;\n#define PMSG_NAME \"pmsg\"\n#undef pr_fmt\n#define pr_fmt(fmt) PMSG_NAME \": \" fmt\n\nstatic char *pmsg_devnode(const struct device *dev, umode_t *mode)\n{\n\tif (mode)\n\t\t*mode = 0220;\n\treturn NULL;\n}\n\nvoid pstore_register_pmsg(void)\n{\n\tstruct device *pmsg_device;\n\n\tpmsg_major = register_chrdev(0, PMSG_NAME, &pmsg_fops);\n\tif (pmsg_major < 0) {\n\t\tpr_err(\"register_chrdev failed\\n\");\n\t\tgoto err;\n\t}\n\n\tpmsg_class = class_create(PMSG_NAME);\n\tif (IS_ERR(pmsg_class)) {\n\t\tpr_err(\"device class file already in use\\n\");\n\t\tgoto err_class;\n\t}\n\tpmsg_class->devnode = pmsg_devnode;\n\n\tpmsg_device = device_create(pmsg_class, NULL, MKDEV(pmsg_major, 0),\n\t\t\t\t\tNULL, \"%s%d\", PMSG_NAME, 0);\n\tif (IS_ERR(pmsg_device)) {\n\t\tpr_err(\"failed to create device\\n\");\n\t\tgoto err_device;\n\t}\n\treturn;\n\nerr_device:\n\tclass_destroy(pmsg_class);\nerr_class:\n\tunregister_chrdev(pmsg_major, PMSG_NAME);\nerr:\n\treturn;\n}\n\nvoid pstore_unregister_pmsg(void)\n{\n\tdevice_destroy(pmsg_class, MKDEV(pmsg_major, 0));\n\tclass_destroy(pmsg_class);\n\tunregister_chrdev(pmsg_major, PMSG_NAME);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}