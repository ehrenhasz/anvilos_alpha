{
  "module_name": "lcnalloc.c",
  "hash_id": "b4331871458e7d95ca4aded97f877d1939fb4ba616bb26d6e449d8b0babf9363",
  "original_prompt": "Ingested from linux-6.6.14/fs/ntfs/lcnalloc.c",
  "human_readable_source": "\n \n\n#ifdef NTFS_RW\n\n#include <linux/pagemap.h>\n\n#include \"lcnalloc.h\"\n#include \"debug.h\"\n#include \"bitmap.h\"\n#include \"inode.h\"\n#include \"volume.h\"\n#include \"attrib.h\"\n#include \"malloc.h\"\n#include \"aops.h\"\n#include \"ntfs.h\"\n\n \nint ntfs_cluster_free_from_rl_nolock(ntfs_volume *vol,\n\t\tconst runlist_element *rl)\n{\n\tstruct inode *lcnbmp_vi = vol->lcnbmp_ino;\n\tint ret = 0;\n\n\tntfs_debug(\"Entering.\");\n\tif (!rl)\n\t\treturn 0;\n\tfor (; rl->length; rl++) {\n\t\tint err;\n\n\t\tif (rl->lcn < 0)\n\t\t\tcontinue;\n\t\terr = ntfs_bitmap_clear_run(lcnbmp_vi, rl->lcn, rl->length);\n\t\tif (unlikely(err && (!ret || ret == -ENOMEM) && ret != err))\n\t\t\tret = err;\n\t}\n\tntfs_debug(\"Done.\");\n\treturn ret;\n}\n\n \nrunlist_element *ntfs_cluster_alloc(ntfs_volume *vol, const VCN start_vcn,\n\t\tconst s64 count, const LCN start_lcn,\n\t\tconst NTFS_CLUSTER_ALLOCATION_ZONES zone,\n\t\tconst bool is_extension)\n{\n\tLCN zone_start, zone_end, bmp_pos, bmp_initial_pos, last_read_pos, lcn;\n\tLCN prev_lcn = 0, prev_run_len = 0, mft_zone_size;\n\ts64 clusters;\n\tloff_t i_size;\n\tstruct inode *lcnbmp_vi;\n\trunlist_element *rl = NULL;\n\tstruct address_space *mapping;\n\tstruct page *page = NULL;\n\tu8 *buf, *byte;\n\tint err = 0, rlpos, rlsize, buf_size;\n\tu8 pass, done_zones, search_zone, need_writeback = 0, bit;\n\n\tntfs_debug(\"Entering for start_vcn 0x%llx, count 0x%llx, start_lcn \"\n\t\t\t\"0x%llx, zone %s_ZONE.\", (unsigned long long)start_vcn,\n\t\t\t(unsigned long long)count,\n\t\t\t(unsigned long long)start_lcn,\n\t\t\tzone == MFT_ZONE ? \"MFT\" : \"DATA\");\n\tBUG_ON(!vol);\n\tlcnbmp_vi = vol->lcnbmp_ino;\n\tBUG_ON(!lcnbmp_vi);\n\tBUG_ON(start_vcn < 0);\n\tBUG_ON(count < 0);\n\tBUG_ON(start_lcn < -1);\n\tBUG_ON(zone < FIRST_ZONE);\n\tBUG_ON(zone > LAST_ZONE);\n\n\t \n\tif (!count)\n\t\treturn NULL;\n\t \n\tdown_write(&vol->lcnbmp_lock);\n\t \n\tdone_zones = 0;\n\tpass = 1;\n\t \n\tzone_start = start_lcn;\n\tif (zone_start < 0) {\n\t\tif (zone == DATA_ZONE)\n\t\t\tzone_start = vol->data1_zone_pos;\n\t\telse\n\t\t\tzone_start = vol->mft_zone_pos;\n\t\tif (!zone_start) {\n\t\t\t \n\t\t\tpass = 2;\n\t\t}\n\t} else if (zone == DATA_ZONE && zone_start >= vol->mft_zone_start &&\n\t\t\tzone_start < vol->mft_zone_end) {\n\t\tzone_start = vol->mft_zone_end;\n\t\t \n\t\tpass = 2;\n\t} else if (zone == MFT_ZONE && (zone_start < vol->mft_zone_start ||\n\t\t\tzone_start >= vol->mft_zone_end)) {\n\t\tzone_start = vol->mft_lcn;\n\t\tif (!vol->mft_zone_end)\n\t\t\tzone_start = 0;\n\t\t \n\t\tpass = 2;\n\t}\n\tif (zone == MFT_ZONE) {\n\t\tzone_end = vol->mft_zone_end;\n\t\tsearch_zone = 1;\n\t} else   {\n\t\t \n\t\tdone_zones |= 1;\n\t\tif (zone_start >= vol->mft_zone_end) {\n\t\t\tzone_end = vol->nr_clusters;\n\t\t\tsearch_zone = 2;\n\t\t} else {\n\t\t\tzone_end = vol->mft_zone_start;\n\t\t\tsearch_zone = 4;\n\t\t}\n\t}\n\t \n\tbmp_pos = bmp_initial_pos = zone_start;\n\n\t \n\tclusters = count;\n\trlpos = rlsize = 0;\n\tmapping = lcnbmp_vi->i_mapping;\n\ti_size = i_size_read(lcnbmp_vi);\n\twhile (1) {\n\t\tntfs_debug(\"Start of outer while loop: done_zones 0x%x, \"\n\t\t\t\t\"search_zone %i, pass %i, zone_start 0x%llx, \"\n\t\t\t\t\"zone_end 0x%llx, bmp_initial_pos 0x%llx, \"\n\t\t\t\t\"bmp_pos 0x%llx, rlpos %i, rlsize %i.\",\n\t\t\t\tdone_zones, search_zone, pass,\n\t\t\t\t(unsigned long long)zone_start,\n\t\t\t\t(unsigned long long)zone_end,\n\t\t\t\t(unsigned long long)bmp_initial_pos,\n\t\t\t\t(unsigned long long)bmp_pos, rlpos, rlsize);\n\t\t \n\t\tlast_read_pos = bmp_pos >> 3;\n\t\tntfs_debug(\"last_read_pos 0x%llx.\",\n\t\t\t\t(unsigned long long)last_read_pos);\n\t\tif (last_read_pos > i_size) {\n\t\t\tntfs_debug(\"End of attribute reached.  \"\n\t\t\t\t\t\"Skipping to zone_pass_done.\");\n\t\t\tgoto zone_pass_done;\n\t\t}\n\t\tif (likely(page)) {\n\t\t\tif (need_writeback) {\n\t\t\t\tntfs_debug(\"Marking page dirty.\");\n\t\t\t\tflush_dcache_page(page);\n\t\t\t\tset_page_dirty(page);\n\t\t\t\tneed_writeback = 0;\n\t\t\t}\n\t\t\tntfs_unmap_page(page);\n\t\t}\n\t\tpage = ntfs_map_page(mapping, last_read_pos >>\n\t\t\t\tPAGE_SHIFT);\n\t\tif (IS_ERR(page)) {\n\t\t\terr = PTR_ERR(page);\n\t\t\tntfs_error(vol->sb, \"Failed to map page.\");\n\t\t\tgoto out;\n\t\t}\n\t\tbuf_size = last_read_pos & ~PAGE_MASK;\n\t\tbuf = page_address(page) + buf_size;\n\t\tbuf_size = PAGE_SIZE - buf_size;\n\t\tif (unlikely(last_read_pos + buf_size > i_size))\n\t\t\tbuf_size = i_size - last_read_pos;\n\t\tbuf_size <<= 3;\n\t\tlcn = bmp_pos & 7;\n\t\tbmp_pos &= ~(LCN)7;\n\t\tntfs_debug(\"Before inner while loop: buf_size %i, lcn 0x%llx, \"\n\t\t\t\t\"bmp_pos 0x%llx, need_writeback %i.\", buf_size,\n\t\t\t\t(unsigned long long)lcn,\n\t\t\t\t(unsigned long long)bmp_pos, need_writeback);\n\t\twhile (lcn < buf_size && lcn + bmp_pos < zone_end) {\n\t\t\tbyte = buf + (lcn >> 3);\n\t\t\tntfs_debug(\"In inner while loop: buf_size %i, \"\n\t\t\t\t\t\"lcn 0x%llx, bmp_pos 0x%llx, \"\n\t\t\t\t\t\"need_writeback %i, byte ofs 0x%x, \"\n\t\t\t\t\t\"*byte 0x%x.\", buf_size,\n\t\t\t\t\t(unsigned long long)lcn,\n\t\t\t\t\t(unsigned long long)bmp_pos,\n\t\t\t\t\tneed_writeback,\n\t\t\t\t\t(unsigned int)(lcn >> 3),\n\t\t\t\t\t(unsigned int)*byte);\n\t\t\t \n\t\t\tif (*byte == 0xff) {\n\t\t\t\tlcn = (lcn + 8) & ~(LCN)7;\n\t\t\t\tntfs_debug(\"Continuing while loop 1.\");\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tbit = 1 << (lcn & 7);\n\t\t\tntfs_debug(\"bit 0x%x.\", bit);\n\t\t\t \n\t\t\tif (*byte & bit) {\n\t\t\t\tlcn++;\n\t\t\t\tntfs_debug(\"Continuing while loop 2.\");\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t \n\t\t\tif ((rlpos + 2) * sizeof(*rl) > rlsize) {\n\t\t\t\trunlist_element *rl2;\n\n\t\t\t\tntfs_debug(\"Reallocating memory.\");\n\t\t\t\tif (!rl)\n\t\t\t\t\tntfs_debug(\"First free bit is at LCN \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\t(lcn + bmp_pos));\n\t\t\t\trl2 = ntfs_malloc_nofs(rlsize + (int)PAGE_SIZE);\n\t\t\t\tif (unlikely(!rl2)) {\n\t\t\t\t\terr = -ENOMEM;\n\t\t\t\t\tntfs_error(vol->sb, \"Failed to \"\n\t\t\t\t\t\t\t\"allocate memory.\");\n\t\t\t\t\tgoto out;\n\t\t\t\t}\n\t\t\t\tmemcpy(rl2, rl, rlsize);\n\t\t\t\tntfs_free(rl);\n\t\t\t\trl = rl2;\n\t\t\t\trlsize += PAGE_SIZE;\n\t\t\t\tntfs_debug(\"Reallocated memory, rlsize 0x%x.\",\n\t\t\t\t\t\trlsize);\n\t\t\t}\n\t\t\t \n\t\t\t*byte |= bit;\n\t\t\t \n\t\t\tneed_writeback = 1;\n\t\t\tntfs_debug(\"*byte 0x%x, need_writeback is set.\",\n\t\t\t\t\t(unsigned int)*byte);\n\t\t\t \n\t\t\tntfs_debug(\"Adding run (lcn 0x%llx, len 0x%llx), \"\n\t\t\t\t\t\"prev_lcn 0x%llx, lcn 0x%llx, \"\n\t\t\t\t\t\"bmp_pos 0x%llx, prev_run_len 0x%llx, \"\n\t\t\t\t\t\"rlpos %i.\",\n\t\t\t\t\t(unsigned long long)(lcn + bmp_pos),\n\t\t\t\t\t1ULL, (unsigned long long)prev_lcn,\n\t\t\t\t\t(unsigned long long)lcn,\n\t\t\t\t\t(unsigned long long)bmp_pos,\n\t\t\t\t\t(unsigned long long)prev_run_len,\n\t\t\t\t\trlpos);\n\t\t\tif (prev_lcn == lcn + bmp_pos - prev_run_len && rlpos) {\n\t\t\t\tntfs_debug(\"Coalescing to run (lcn 0x%llx, \"\n\t\t\t\t\t\t\"len 0x%llx).\",\n\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\trl[rlpos - 1].lcn,\n\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\trl[rlpos - 1].length);\n\t\t\t\trl[rlpos - 1].length = ++prev_run_len;\n\t\t\t\tntfs_debug(\"Run now (lcn 0x%llx, len 0x%llx), \"\n\t\t\t\t\t\t\"prev_run_len 0x%llx.\",\n\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\trl[rlpos - 1].lcn,\n\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\trl[rlpos - 1].length,\n\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\tprev_run_len);\n\t\t\t} else {\n\t\t\t\tif (likely(rlpos)) {\n\t\t\t\t\tntfs_debug(\"Adding new run, (previous \"\n\t\t\t\t\t\t\t\"run lcn 0x%llx, \"\n\t\t\t\t\t\t\t\"len 0x%llx).\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\trl[rlpos - 1].lcn,\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\trl[rlpos - 1].length);\n\t\t\t\t\trl[rlpos].vcn = rl[rlpos - 1].vcn +\n\t\t\t\t\t\t\tprev_run_len;\n\t\t\t\t} else {\n\t\t\t\t\tntfs_debug(\"Adding new run, is first \"\n\t\t\t\t\t\t\t\"run.\");\n\t\t\t\t\trl[rlpos].vcn = start_vcn;\n\t\t\t\t}\n\t\t\t\trl[rlpos].lcn = prev_lcn = lcn + bmp_pos;\n\t\t\t\trl[rlpos].length = prev_run_len = 1;\n\t\t\t\trlpos++;\n\t\t\t}\n\t\t\t \n\t\t\tif (!--clusters) {\n\t\t\t\tLCN tc;\n\t\t\t\t \n\t\t\t\ttc = lcn + bmp_pos + 1;\n\t\t\t\tntfs_debug(\"Done. Updating current zone \"\n\t\t\t\t\t\t\"position, tc 0x%llx, \"\n\t\t\t\t\t\t\"search_zone %i.\",\n\t\t\t\t\t\t(unsigned long long)tc,\n\t\t\t\t\t\tsearch_zone);\n\t\t\t\tswitch (search_zone) {\n\t\t\t\tcase 1:\n\t\t\t\t\tntfs_debug(\"Before checks, \"\n\t\t\t\t\t\t\t\"vol->mft_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->mft_zone_pos);\n\t\t\t\t\tif (tc >= vol->mft_zone_end) {\n\t\t\t\t\t\tvol->mft_zone_pos =\n\t\t\t\t\t\t\t\tvol->mft_lcn;\n\t\t\t\t\t\tif (!vol->mft_zone_end)\n\t\t\t\t\t\t\tvol->mft_zone_pos = 0;\n\t\t\t\t\t} else if ((bmp_initial_pos >=\n\t\t\t\t\t\t\tvol->mft_zone_pos ||\n\t\t\t\t\t\t\ttc > vol->mft_zone_pos)\n\t\t\t\t\t\t\t&& tc >= vol->mft_lcn)\n\t\t\t\t\t\tvol->mft_zone_pos = tc;\n\t\t\t\t\tntfs_debug(\"After checks, \"\n\t\t\t\t\t\t\t\"vol->mft_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->mft_zone_pos);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\tntfs_debug(\"Before checks, \"\n\t\t\t\t\t\t\t\"vol->data1_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data1_zone_pos);\n\t\t\t\t\tif (tc >= vol->nr_clusters)\n\t\t\t\t\t\tvol->data1_zone_pos =\n\t\t\t\t\t\t\t     vol->mft_zone_end;\n\t\t\t\t\telse if ((bmp_initial_pos >=\n\t\t\t\t\t\t    vol->data1_zone_pos ||\n\t\t\t\t\t\t    tc > vol->data1_zone_pos)\n\t\t\t\t\t\t    && tc >= vol->mft_zone_end)\n\t\t\t\t\t\tvol->data1_zone_pos = tc;\n\t\t\t\t\tntfs_debug(\"After checks, \"\n\t\t\t\t\t\t\t\"vol->data1_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data1_zone_pos);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\tntfs_debug(\"Before checks, \"\n\t\t\t\t\t\t\t\"vol->data2_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data2_zone_pos);\n\t\t\t\t\tif (tc >= vol->mft_zone_start)\n\t\t\t\t\t\tvol->data2_zone_pos = 0;\n\t\t\t\t\telse if (bmp_initial_pos >=\n\t\t\t\t\t\t      vol->data2_zone_pos ||\n\t\t\t\t\t\t      tc > vol->data2_zone_pos)\n\t\t\t\t\t\tvol->data2_zone_pos = tc;\n\t\t\t\t\tntfs_debug(\"After checks, \"\n\t\t\t\t\t\t\t\"vol->data2_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data2_zone_pos);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tBUG();\n\t\t\t\t}\n\t\t\t\tntfs_debug(\"Finished.  Going to out.\");\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t\tlcn++;\n\t\t}\n\t\tbmp_pos += buf_size;\n\t\tntfs_debug(\"After inner while loop: buf_size 0x%x, lcn \"\n\t\t\t\t\"0x%llx, bmp_pos 0x%llx, need_writeback %i.\",\n\t\t\t\tbuf_size, (unsigned long long)lcn,\n\t\t\t\t(unsigned long long)bmp_pos, need_writeback);\n\t\tif (bmp_pos < zone_end) {\n\t\t\tntfs_debug(\"Continuing outer while loop, \"\n\t\t\t\t\t\"bmp_pos 0x%llx, zone_end 0x%llx.\",\n\t\t\t\t\t(unsigned long long)bmp_pos,\n\t\t\t\t\t(unsigned long long)zone_end);\n\t\t\tcontinue;\n\t\t}\nzone_pass_done:\t \n\t\tntfs_debug(\"At zone_pass_done, pass %i.\", pass);\n\t\tif (pass == 1) {\n\t\t\t \n\t\t\tpass = 2;\n\t\t\tzone_end = zone_start;\n\t\t\tswitch (search_zone) {\n\t\t\tcase 1:  \n\t\t\t\tzone_start = vol->mft_zone_start;\n\t\t\t\tbreak;\n\t\t\tcase 2:  \n\t\t\t\tzone_start = vol->mft_zone_end;\n\t\t\t\tbreak;\n\t\t\tcase 4:  \n\t\t\t\tzone_start = 0;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tBUG();\n\t\t\t}\n\t\t\t \n\t\t\tif (zone_end < zone_start)\n\t\t\t\tzone_end = zone_start;\n\t\t\tbmp_pos = zone_start;\n\t\t\tntfs_debug(\"Continuing outer while loop, pass 2, \"\n\t\t\t\t\t\"zone_start 0x%llx, zone_end 0x%llx, \"\n\t\t\t\t\t\"bmp_pos 0x%llx.\",\n\t\t\t\t\t(unsigned long long)zone_start,\n\t\t\t\t\t(unsigned long long)zone_end,\n\t\t\t\t\t(unsigned long long)bmp_pos);\n\t\t\tcontinue;\n\t\t}  \ndone_zones_check:\n\t\tntfs_debug(\"At done_zones_check, search_zone %i, done_zones \"\n\t\t\t\t\"before 0x%x, done_zones after 0x%x.\",\n\t\t\t\tsearch_zone, done_zones,\n\t\t\t\tdone_zones | search_zone);\n\t\tdone_zones |= search_zone;\n\t\tif (done_zones < 7) {\n\t\t\tntfs_debug(\"Switching zone.\");\n\t\t\t \n\t\t\tpass = 1;\n\t\t\tswitch (search_zone) {\n\t\t\tcase 1:\n\t\t\t\tntfs_debug(\"Switching from mft zone to data1 \"\n\t\t\t\t\t\t\"zone.\");\n\t\t\t\t \n\t\t\t\tif (rlpos) {\n\t\t\t\t\tLCN tc;\n\n\t\t\t\t\tntfs_debug(\"Before checks, \"\n\t\t\t\t\t\t\t\"vol->mft_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->mft_zone_pos);\n\t\t\t\t\ttc = rl[rlpos - 1].lcn +\n\t\t\t\t\t\t\trl[rlpos - 1].length;\n\t\t\t\t\tif (tc >= vol->mft_zone_end) {\n\t\t\t\t\t\tvol->mft_zone_pos =\n\t\t\t\t\t\t\t\tvol->mft_lcn;\n\t\t\t\t\t\tif (!vol->mft_zone_end)\n\t\t\t\t\t\t\tvol->mft_zone_pos = 0;\n\t\t\t\t\t} else if ((bmp_initial_pos >=\n\t\t\t\t\t\t\tvol->mft_zone_pos ||\n\t\t\t\t\t\t\ttc > vol->mft_zone_pos)\n\t\t\t\t\t\t\t&& tc >= vol->mft_lcn)\n\t\t\t\t\t\tvol->mft_zone_pos = tc;\n\t\t\t\t\tntfs_debug(\"After checks, \"\n\t\t\t\t\t\t\t\"vol->mft_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->mft_zone_pos);\n\t\t\t\t}\n\t\t\t\t \nswitch_to_data1_zone:\t\tsearch_zone = 2;\n\t\t\t\tzone_start = bmp_initial_pos =\n\t\t\t\t\t\tvol->data1_zone_pos;\n\t\t\t\tzone_end = vol->nr_clusters;\n\t\t\t\tif (zone_start == vol->mft_zone_end)\n\t\t\t\t\tpass = 2;\n\t\t\t\tif (zone_start >= zone_end) {\n\t\t\t\t\tvol->data1_zone_pos = zone_start =\n\t\t\t\t\t\t\tvol->mft_zone_end;\n\t\t\t\t\tpass = 2;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tntfs_debug(\"Switching from data1 zone to \"\n\t\t\t\t\t\t\"data2 zone.\");\n\t\t\t\t \n\t\t\t\tif (rlpos) {\n\t\t\t\t\tLCN tc;\n\n\t\t\t\t\tntfs_debug(\"Before checks, \"\n\t\t\t\t\t\t\t\"vol->data1_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data1_zone_pos);\n\t\t\t\t\ttc = rl[rlpos - 1].lcn +\n\t\t\t\t\t\t\trl[rlpos - 1].length;\n\t\t\t\t\tif (tc >= vol->nr_clusters)\n\t\t\t\t\t\tvol->data1_zone_pos =\n\t\t\t\t\t\t\t     vol->mft_zone_end;\n\t\t\t\t\telse if ((bmp_initial_pos >=\n\t\t\t\t\t\t    vol->data1_zone_pos ||\n\t\t\t\t\t\t    tc > vol->data1_zone_pos)\n\t\t\t\t\t\t    && tc >= vol->mft_zone_end)\n\t\t\t\t\t\tvol->data1_zone_pos = tc;\n\t\t\t\t\tntfs_debug(\"After checks, \"\n\t\t\t\t\t\t\t\"vol->data1_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data1_zone_pos);\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tsearch_zone = 4;\n\t\t\t\tzone_start = bmp_initial_pos =\n\t\t\t\t\t\tvol->data2_zone_pos;\n\t\t\t\tzone_end = vol->mft_zone_start;\n\t\t\t\tif (!zone_start)\n\t\t\t\t\tpass = 2;\n\t\t\t\tif (zone_start >= zone_end) {\n\t\t\t\t\tvol->data2_zone_pos = zone_start =\n\t\t\t\t\t\t\tbmp_initial_pos = 0;\n\t\t\t\t\tpass = 2;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tntfs_debug(\"Switching from data2 zone to \"\n\t\t\t\t\t\t\"data1 zone.\");\n\t\t\t\t \n\t\t\t\tif (rlpos) {\n\t\t\t\t\tLCN tc;\n\n\t\t\t\t\tntfs_debug(\"Before checks, \"\n\t\t\t\t\t\t\t\"vol->data2_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data2_zone_pos);\n\t\t\t\t\ttc = rl[rlpos - 1].lcn +\n\t\t\t\t\t\t\trl[rlpos - 1].length;\n\t\t\t\t\tif (tc >= vol->mft_zone_start)\n\t\t\t\t\t\tvol->data2_zone_pos = 0;\n\t\t\t\t\telse if (bmp_initial_pos >=\n\t\t\t\t\t\t      vol->data2_zone_pos ||\n\t\t\t\t\t\t      tc > vol->data2_zone_pos)\n\t\t\t\t\t\tvol->data2_zone_pos = tc;\n\t\t\t\t\tntfs_debug(\"After checks, \"\n\t\t\t\t\t\t\t\"vol->data2_zone_pos \"\n\t\t\t\t\t\t\t\"0x%llx.\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\tvol->data2_zone_pos);\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tgoto switch_to_data1_zone;\n\t\t\tdefault:\n\t\t\t\tBUG();\n\t\t\t}\n\t\t\tntfs_debug(\"After zone switch, search_zone %i, \"\n\t\t\t\t\t\"pass %i, bmp_initial_pos 0x%llx, \"\n\t\t\t\t\t\"zone_start 0x%llx, zone_end 0x%llx.\",\n\t\t\t\t\tsearch_zone, pass,\n\t\t\t\t\t(unsigned long long)bmp_initial_pos,\n\t\t\t\t\t(unsigned long long)zone_start,\n\t\t\t\t\t(unsigned long long)zone_end);\n\t\t\tbmp_pos = zone_start;\n\t\t\tif (zone_start == zone_end) {\n\t\t\t\tntfs_debug(\"Empty zone, going to \"\n\t\t\t\t\t\t\"done_zones_check.\");\n\t\t\t\t \n\t\t\t\tgoto done_zones_check;\n\t\t\t}\n\t\t\tntfs_debug(\"Continuing outer while loop.\");\n\t\t\tcontinue;\n\t\t}  \n\t\tntfs_debug(\"All zones are finished.\");\n\t\t \n\t\tmft_zone_size = vol->mft_zone_end - vol->mft_zone_start;\n\t\tntfs_debug(\"vol->mft_zone_start 0x%llx, vol->mft_zone_end \"\n\t\t\t\t\"0x%llx, mft_zone_size 0x%llx.\",\n\t\t\t\t(unsigned long long)vol->mft_zone_start,\n\t\t\t\t(unsigned long long)vol->mft_zone_end,\n\t\t\t\t(unsigned long long)mft_zone_size);\n\t\tif (zone == MFT_ZONE || mft_zone_size <= 0) {\n\t\t\tntfs_debug(\"No free clusters left, going to out.\");\n\t\t\t \n\t\t\terr = -ENOSPC;\n\t\t\tgoto out;\n\t\t}  \n\t\tntfs_debug(\"Shrinking mft zone.\");\n\t\tzone_end = vol->mft_zone_end;\n\t\tmft_zone_size >>= 1;\n\t\tif (mft_zone_size > 0)\n\t\t\tvol->mft_zone_end = vol->mft_zone_start + mft_zone_size;\n\t\telse  \n\t\t\tvol->data2_zone_pos = vol->mft_zone_start =\n\t\t\t\t\tvol->mft_zone_end = 0;\n\t\tif (vol->mft_zone_pos >= vol->mft_zone_end) {\n\t\t\tvol->mft_zone_pos = vol->mft_lcn;\n\t\t\tif (!vol->mft_zone_end)\n\t\t\t\tvol->mft_zone_pos = 0;\n\t\t}\n\t\tbmp_pos = zone_start = bmp_initial_pos =\n\t\t\t\tvol->data1_zone_pos = vol->mft_zone_end;\n\t\tsearch_zone = 2;\n\t\tpass = 2;\n\t\tdone_zones &= ~2;\n\t\tntfs_debug(\"After shrinking mft zone, mft_zone_size 0x%llx, \"\n\t\t\t\t\"vol->mft_zone_start 0x%llx, \"\n\t\t\t\t\"vol->mft_zone_end 0x%llx, \"\n\t\t\t\t\"vol->mft_zone_pos 0x%llx, search_zone 2, \"\n\t\t\t\t\"pass 2, dones_zones 0x%x, zone_start 0x%llx, \"\n\t\t\t\t\"zone_end 0x%llx, vol->data1_zone_pos 0x%llx, \"\n\t\t\t\t\"continuing outer while loop.\",\n\t\t\t\t(unsigned long long)mft_zone_size,\n\t\t\t\t(unsigned long long)vol->mft_zone_start,\n\t\t\t\t(unsigned long long)vol->mft_zone_end,\n\t\t\t\t(unsigned long long)vol->mft_zone_pos,\n\t\t\t\tdone_zones, (unsigned long long)zone_start,\n\t\t\t\t(unsigned long long)zone_end,\n\t\t\t\t(unsigned long long)vol->data1_zone_pos);\n\t}\n\tntfs_debug(\"After outer while loop.\");\nout:\n\tntfs_debug(\"At out.\");\n\t \n\tif (likely(rl)) {\n\t\trl[rlpos].vcn = rl[rlpos - 1].vcn + rl[rlpos - 1].length;\n\t\trl[rlpos].lcn = is_extension ? LCN_ENOENT : LCN_RL_NOT_MAPPED;\n\t\trl[rlpos].length = 0;\n\t}\n\tif (likely(page && !IS_ERR(page))) {\n\t\tif (need_writeback) {\n\t\t\tntfs_debug(\"Marking page dirty.\");\n\t\t\tflush_dcache_page(page);\n\t\t\tset_page_dirty(page);\n\t\t\tneed_writeback = 0;\n\t\t}\n\t\tntfs_unmap_page(page);\n\t}\n\tif (likely(!err)) {\n\t\tup_write(&vol->lcnbmp_lock);\n\t\tntfs_debug(\"Done.\");\n\t\treturn rl;\n\t}\n\tntfs_error(vol->sb, \"Failed to allocate clusters, aborting \"\n\t\t\t\"(error %i).\", err);\n\tif (rl) {\n\t\tint err2;\n\n\t\tif (err == -ENOSPC)\n\t\t\tntfs_debug(\"Not enough space to complete allocation, \"\n\t\t\t\t\t\"err -ENOSPC, first free lcn 0x%llx, \"\n\t\t\t\t\t\"could allocate up to 0x%llx \"\n\t\t\t\t\t\"clusters.\",\n\t\t\t\t\t(unsigned long long)rl[0].lcn,\n\t\t\t\t\t(unsigned long long)(count - clusters));\n\t\t \n\t\tntfs_debug(\"Attempting rollback...\");\n\t\terr2 = ntfs_cluster_free_from_rl_nolock(vol, rl);\n\t\tif (err2) {\n\t\t\tntfs_error(vol->sb, \"Failed to rollback (error %i).  \"\n\t\t\t\t\t\"Leaving inconsistent metadata!  \"\n\t\t\t\t\t\"Unmount and run chkdsk.\", err2);\n\t\t\tNVolSetErrors(vol);\n\t\t}\n\t\t \n\t\tntfs_free(rl);\n\t} else if (err == -ENOSPC)\n\t\tntfs_debug(\"No space left at all, err = -ENOSPC, first free \"\n\t\t\t\t\"lcn = 0x%llx.\",\n\t\t\t\t(long long)vol->data1_zone_pos);\n\tup_write(&vol->lcnbmp_lock);\n\treturn ERR_PTR(err);\n}\n\n \ns64 __ntfs_cluster_free(ntfs_inode *ni, const VCN start_vcn, s64 count,\n\t\tntfs_attr_search_ctx *ctx, const bool is_rollback)\n{\n\ts64 delta, to_free, total_freed, real_freed;\n\tntfs_volume *vol;\n\tstruct inode *lcnbmp_vi;\n\trunlist_element *rl;\n\tint err;\n\n\tBUG_ON(!ni);\n\tntfs_debug(\"Entering for i_ino 0x%lx, start_vcn 0x%llx, count \"\n\t\t\t\"0x%llx.%s\", ni->mft_no, (unsigned long long)start_vcn,\n\t\t\t(unsigned long long)count,\n\t\t\tis_rollback ? \" (rollback)\" : \"\");\n\tvol = ni->vol;\n\tlcnbmp_vi = vol->lcnbmp_ino;\n\tBUG_ON(!lcnbmp_vi);\n\tBUG_ON(start_vcn < 0);\n\tBUG_ON(count < -1);\n\t \n\tif (likely(!is_rollback))\n\t\tdown_write(&vol->lcnbmp_lock);\n\n\ttotal_freed = real_freed = 0;\n\n\trl = ntfs_attr_find_vcn_nolock(ni, start_vcn, ctx);\n\tif (IS_ERR(rl)) {\n\t\tif (!is_rollback)\n\t\t\tntfs_error(vol->sb, \"Failed to find first runlist \"\n\t\t\t\t\t\"element (error %li), aborting.\",\n\t\t\t\t\tPTR_ERR(rl));\n\t\terr = PTR_ERR(rl);\n\t\tgoto err_out;\n\t}\n\tif (unlikely(rl->lcn < LCN_HOLE)) {\n\t\tif (!is_rollback)\n\t\t\tntfs_error(vol->sb, \"First runlist element has \"\n\t\t\t\t\t\"invalid lcn, aborting.\");\n\t\terr = -EIO;\n\t\tgoto err_out;\n\t}\n\t \n\tdelta = start_vcn - rl->vcn;\n\n\t \n\tto_free = rl->length - delta;\n\tif (count >= 0 && to_free > count)\n\t\tto_free = count;\n\n\tif (likely(rl->lcn >= 0)) {\n\t\t \n\t\terr = ntfs_bitmap_set_bits_in_run(lcnbmp_vi, rl->lcn + delta,\n\t\t\t\tto_free, likely(!is_rollback) ? 0 : 1);\n\t\tif (unlikely(err)) {\n\t\t\tif (!is_rollback)\n\t\t\t\tntfs_error(vol->sb, \"Failed to clear first run \"\n\t\t\t\t\t\t\"(error %i), aborting.\", err);\n\t\t\tgoto err_out;\n\t\t}\n\t\t \n\t\treal_freed = to_free;\n\t};\n\t \n\t++rl;\n\tif (count >= 0)\n\t\tcount -= to_free;\n\n\t \n\ttotal_freed = to_free;\n\t \n\tfor (; rl->length && count != 0; ++rl) {\n\t\tif (unlikely(rl->lcn < LCN_HOLE)) {\n\t\t\tVCN vcn;\n\n\t\t\t \n\t\t\tvcn = rl->vcn;\n\t\t\trl = ntfs_attr_find_vcn_nolock(ni, vcn, ctx);\n\t\t\tif (IS_ERR(rl)) {\n\t\t\t\terr = PTR_ERR(rl);\n\t\t\t\tif (!is_rollback)\n\t\t\t\t\tntfs_error(vol->sb, \"Failed to map \"\n\t\t\t\t\t\t\t\"runlist fragment or \"\n\t\t\t\t\t\t\t\"failed to find \"\n\t\t\t\t\t\t\t\"subsequent runlist \"\n\t\t\t\t\t\t\t\"element.\");\n\t\t\t\tgoto err_out;\n\t\t\t}\n\t\t\tif (unlikely(rl->lcn < LCN_HOLE)) {\n\t\t\t\tif (!is_rollback)\n\t\t\t\t\tntfs_error(vol->sb, \"Runlist element \"\n\t\t\t\t\t\t\t\"has invalid lcn \"\n\t\t\t\t\t\t\t\"(0x%llx).\",\n\t\t\t\t\t\t\t(unsigned long long)\n\t\t\t\t\t\t\trl->lcn);\n\t\t\t\terr = -EIO;\n\t\t\t\tgoto err_out;\n\t\t\t}\n\t\t}\n\t\t \n\t\tto_free = rl->length;\n\t\tif (count >= 0 && to_free > count)\n\t\t\tto_free = count;\n\n\t\tif (likely(rl->lcn >= 0)) {\n\t\t\t \n\t\t\terr = ntfs_bitmap_set_bits_in_run(lcnbmp_vi, rl->lcn,\n\t\t\t\t\tto_free, likely(!is_rollback) ? 0 : 1);\n\t\t\tif (unlikely(err)) {\n\t\t\t\tif (!is_rollback)\n\t\t\t\t\tntfs_error(vol->sb, \"Failed to clear \"\n\t\t\t\t\t\t\t\"subsequent run.\");\n\t\t\t\tgoto err_out;\n\t\t\t}\n\t\t\t \n\t\t\treal_freed += to_free;\n\t\t}\n\t\t \n\t\tif (count >= 0)\n\t\t\tcount -= to_free;\n\t\n\t\t \n\t\ttotal_freed += to_free;\n\t}\n\tif (likely(!is_rollback))\n\t\tup_write(&vol->lcnbmp_lock);\n\n\tBUG_ON(count > 0);\n\n\t \n\tntfs_debug(\"Done.\");\n\treturn real_freed;\nerr_out:\n\tif (is_rollback)\n\t\treturn err;\n\t \n\tif (!real_freed) {\n\t\tup_write(&vol->lcnbmp_lock);\n\t\treturn err;\n\t}\n\t \n\tdelta = __ntfs_cluster_free(ni, start_vcn, total_freed, ctx, true);\n\tif (delta < 0) {\n\t\tntfs_error(vol->sb, \"Failed to rollback (error %i).  Leaving \"\n\t\t\t\t\"inconsistent metadata!  Unmount and run \"\n\t\t\t\t\"chkdsk.\", (int)delta);\n\t\tNVolSetErrors(vol);\n\t}\n\tup_write(&vol->lcnbmp_lock);\n\tntfs_error(vol->sb, \"Aborting (error %i).\", err);\n\treturn err;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}