{
  "module_name": "mst.c",
  "hash_id": "dccbf798f490d712f72d979ffd92ad683d1afa919b3ac66bd04f722e4d5ff7a0",
  "original_prompt": "Ingested from linux-6.6.14/fs/ntfs/mst.c",
  "human_readable_source": "\n \n\n#include \"ntfs.h\"\n\n \nint post_read_mst_fixup(NTFS_RECORD *b, const u32 size)\n{\n\tu16 usa_ofs, usa_count, usn;\n\tu16 *usa_pos, *data_pos;\n\n\t \n\tusa_ofs = le16_to_cpu(b->usa_ofs);\n\t \n\tusa_count = le16_to_cpu(b->usa_count) - 1;\n\t \n\tif ( size & (NTFS_BLOCK_SIZE - 1)\t||\n\t     usa_ofs & 1\t\t\t||\n\t     usa_ofs + (usa_count * 2) > size\t||\n\t     (size >> NTFS_BLOCK_SIZE_BITS) != usa_count)\n\t\treturn 0;\n\t \n\tusa_pos = (u16*)b + usa_ofs/sizeof(u16);\n\t \n\tusn = *usa_pos;\n\t \n\tdata_pos = (u16*)b + NTFS_BLOCK_SIZE/sizeof(u16) - 1;\n\t \n\twhile (usa_count--) {\n\t\tif (*data_pos != usn) {\n\t\t\t \n\t\t\tb->magic = magic_BAAD;\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tdata_pos += NTFS_BLOCK_SIZE/sizeof(u16);\n\t}\n\t \n\tusa_count = le16_to_cpu(b->usa_count) - 1;\n\tdata_pos = (u16*)b + NTFS_BLOCK_SIZE/sizeof(u16) - 1;\n\t \n\twhile (usa_count--) {\n\t\t \n\t\t*data_pos = *(++usa_pos);\n\t\t \n\t\tdata_pos += NTFS_BLOCK_SIZE/sizeof(u16);\n\t}\n\treturn 0;\n}\n\n \nint pre_write_mst_fixup(NTFS_RECORD *b, const u32 size)\n{\n\tle16 *usa_pos, *data_pos;\n\tu16 usa_ofs, usa_count, usn;\n\tle16 le_usn;\n\n\t \n\tif (!b || ntfs_is_baad_record(b->magic) ||\n\t\t\tntfs_is_hole_record(b->magic))\n\t\treturn -EINVAL;\n\t \n\tusa_ofs = le16_to_cpu(b->usa_ofs);\n\t \n\tusa_count = le16_to_cpu(b->usa_count) - 1;\n\t \n\tif ( size & (NTFS_BLOCK_SIZE - 1)\t||\n\t     usa_ofs & 1\t\t\t||\n\t     usa_ofs + (usa_count * 2) > size\t||\n\t     (size >> NTFS_BLOCK_SIZE_BITS) != usa_count)\n\t\treturn -EINVAL;\n\t \n\tusa_pos = (le16*)((u8*)b + usa_ofs);\n\t \n\tusn = le16_to_cpup(usa_pos) + 1;\n\tif (usn == 0xffff || !usn)\n\t\tusn = 1;\n\tle_usn = cpu_to_le16(usn);\n\t*usa_pos = le_usn;\n\t \n\tdata_pos = (le16*)b + NTFS_BLOCK_SIZE/sizeof(le16) - 1;\n\t \n\twhile (usa_count--) {\n\t\t \n\t\t*(++usa_pos) = *data_pos;\n\t\t \n\t\t*data_pos = le_usn;\n\t\t \n\t\tdata_pos += NTFS_BLOCK_SIZE/sizeof(le16);\n\t}\n\treturn 0;\n}\n\n \nvoid post_write_mst_fixup(NTFS_RECORD *b)\n{\n\tle16 *usa_pos, *data_pos;\n\n\tu16 usa_ofs = le16_to_cpu(b->usa_ofs);\n\tu16 usa_count = le16_to_cpu(b->usa_count) - 1;\n\n\t \n\tusa_pos = (le16*)b + usa_ofs/sizeof(le16);\n\n\t \n\tdata_pos = (le16*)b + NTFS_BLOCK_SIZE/sizeof(le16) - 1;\n\n\t \n\twhile (usa_count--) {\n\t\t \n\t\t*data_pos = *(++usa_pos);\n\n\t\t \n\t\tdata_pos += NTFS_BLOCK_SIZE/sizeof(le16);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}