{
  "module_name": "xfs_health.c",
  "hash_id": "80b24e4f08c0442d654e30e803868b2a21bcc904f0ba1c850497a3022754458d",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_health.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_health.h\"\n#include \"xfs_ag.h\"\n\n \nvoid\nxfs_health_unmount(\n\tstruct xfs_mount\t*mp)\n{\n\tstruct xfs_perag\t*pag;\n\txfs_agnumber_t\t\tagno;\n\tunsigned int\t\tsick = 0;\n\tunsigned int\t\tchecked = 0;\n\tbool\t\t\twarn = false;\n\n\tif (xfs_is_shutdown(mp))\n\t\treturn;\n\n\t \n\tfor_each_perag(mp, agno, pag) {\n\t\txfs_ag_measure_sickness(pag, &sick, &checked);\n\t\tif (sick) {\n\t\t\ttrace_xfs_ag_unfixed_corruption(mp, agno, sick);\n\t\t\twarn = true;\n\t\t}\n\t}\n\n\t \n\txfs_rt_measure_sickness(mp, &sick, &checked);\n\tif (sick) {\n\t\ttrace_xfs_rt_unfixed_corruption(mp, sick);\n\t\twarn = true;\n\t}\n\n\t \n\txfs_fs_measure_sickness(mp, &sick, &checked);\n\tif (sick & ~XFS_SICK_FS_COUNTERS) {\n\t\ttrace_xfs_fs_unfixed_corruption(mp, sick);\n\t\twarn = true;\n\t}\n\n\tif (warn) {\n\t\txfs_warn(mp,\n\"Uncorrected metadata errors detected; please run xfs_repair.\");\n\n\t\t \n\t\tif (sick & XFS_SICK_FS_COUNTERS)\n\t\t\txfs_fs_mark_healthy(mp, XFS_SICK_FS_COUNTERS);\n\t}\n}\n\n \nvoid\nxfs_fs_mark_sick(\n\tstruct xfs_mount\t*mp,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_FS_PRIMARY));\n\ttrace_xfs_fs_mark_sick(mp, mask);\n\n\tspin_lock(&mp->m_sb_lock);\n\tmp->m_fs_sick |= mask;\n\tmp->m_fs_checked |= mask;\n\tspin_unlock(&mp->m_sb_lock);\n}\n\n \nvoid\nxfs_fs_mark_healthy(\n\tstruct xfs_mount\t*mp,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_FS_PRIMARY));\n\ttrace_xfs_fs_mark_healthy(mp, mask);\n\n\tspin_lock(&mp->m_sb_lock);\n\tmp->m_fs_sick &= ~mask;\n\tmp->m_fs_checked |= mask;\n\tspin_unlock(&mp->m_sb_lock);\n}\n\n \nvoid\nxfs_fs_measure_sickness(\n\tstruct xfs_mount\t*mp,\n\tunsigned int\t\t*sick,\n\tunsigned int\t\t*checked)\n{\n\tspin_lock(&mp->m_sb_lock);\n\t*sick = mp->m_fs_sick;\n\t*checked = mp->m_fs_checked;\n\tspin_unlock(&mp->m_sb_lock);\n}\n\n \nvoid\nxfs_rt_mark_sick(\n\tstruct xfs_mount\t*mp,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_RT_PRIMARY));\n\ttrace_xfs_rt_mark_sick(mp, mask);\n\n\tspin_lock(&mp->m_sb_lock);\n\tmp->m_rt_sick |= mask;\n\tmp->m_rt_checked |= mask;\n\tspin_unlock(&mp->m_sb_lock);\n}\n\n \nvoid\nxfs_rt_mark_healthy(\n\tstruct xfs_mount\t*mp,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_RT_PRIMARY));\n\ttrace_xfs_rt_mark_healthy(mp, mask);\n\n\tspin_lock(&mp->m_sb_lock);\n\tmp->m_rt_sick &= ~mask;\n\tmp->m_rt_checked |= mask;\n\tspin_unlock(&mp->m_sb_lock);\n}\n\n \nvoid\nxfs_rt_measure_sickness(\n\tstruct xfs_mount\t*mp,\n\tunsigned int\t\t*sick,\n\tunsigned int\t\t*checked)\n{\n\tspin_lock(&mp->m_sb_lock);\n\t*sick = mp->m_rt_sick;\n\t*checked = mp->m_rt_checked;\n\tspin_unlock(&mp->m_sb_lock);\n}\n\n \nvoid\nxfs_ag_mark_sick(\n\tstruct xfs_perag\t*pag,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_AG_PRIMARY));\n\ttrace_xfs_ag_mark_sick(pag->pag_mount, pag->pag_agno, mask);\n\n\tspin_lock(&pag->pag_state_lock);\n\tpag->pag_sick |= mask;\n\tpag->pag_checked |= mask;\n\tspin_unlock(&pag->pag_state_lock);\n}\n\n \nvoid\nxfs_ag_mark_healthy(\n\tstruct xfs_perag\t*pag,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_AG_PRIMARY));\n\ttrace_xfs_ag_mark_healthy(pag->pag_mount, pag->pag_agno, mask);\n\n\tspin_lock(&pag->pag_state_lock);\n\tpag->pag_sick &= ~mask;\n\tpag->pag_checked |= mask;\n\tspin_unlock(&pag->pag_state_lock);\n}\n\n \nvoid\nxfs_ag_measure_sickness(\n\tstruct xfs_perag\t*pag,\n\tunsigned int\t\t*sick,\n\tunsigned int\t\t*checked)\n{\n\tspin_lock(&pag->pag_state_lock);\n\t*sick = pag->pag_sick;\n\t*checked = pag->pag_checked;\n\tspin_unlock(&pag->pag_state_lock);\n}\n\n \nvoid\nxfs_inode_mark_sick(\n\tstruct xfs_inode\t*ip,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_INO_PRIMARY));\n\ttrace_xfs_inode_mark_sick(ip, mask);\n\n\tspin_lock(&ip->i_flags_lock);\n\tip->i_sick |= mask;\n\tip->i_checked |= mask;\n\tspin_unlock(&ip->i_flags_lock);\n\n\t \n\tspin_lock(&VFS_I(ip)->i_lock);\n\tVFS_I(ip)->i_state &= ~I_DONTCACHE;\n\tspin_unlock(&VFS_I(ip)->i_lock);\n}\n\n \nvoid\nxfs_inode_mark_healthy(\n\tstruct xfs_inode\t*ip,\n\tunsigned int\t\tmask)\n{\n\tASSERT(!(mask & ~XFS_SICK_INO_PRIMARY));\n\ttrace_xfs_inode_mark_healthy(ip, mask);\n\n\tspin_lock(&ip->i_flags_lock);\n\tip->i_sick &= ~mask;\n\tip->i_checked |= mask;\n\tspin_unlock(&ip->i_flags_lock);\n}\n\n \nvoid\nxfs_inode_measure_sickness(\n\tstruct xfs_inode\t*ip,\n\tunsigned int\t\t*sick,\n\tunsigned int\t\t*checked)\n{\n\tspin_lock(&ip->i_flags_lock);\n\t*sick = ip->i_sick;\n\t*checked = ip->i_checked;\n\tspin_unlock(&ip->i_flags_lock);\n}\n\n \n\nstruct ioctl_sick_map {\n\tunsigned int\t\tsick_mask;\n\tunsigned int\t\tioctl_mask;\n};\n\nstatic const struct ioctl_sick_map fs_map[] = {\n\t{ XFS_SICK_FS_COUNTERS,\tXFS_FSOP_GEOM_SICK_COUNTERS},\n\t{ XFS_SICK_FS_UQUOTA,\tXFS_FSOP_GEOM_SICK_UQUOTA },\n\t{ XFS_SICK_FS_GQUOTA,\tXFS_FSOP_GEOM_SICK_GQUOTA },\n\t{ XFS_SICK_FS_PQUOTA,\tXFS_FSOP_GEOM_SICK_PQUOTA },\n\t{ 0, 0 },\n};\n\nstatic const struct ioctl_sick_map rt_map[] = {\n\t{ XFS_SICK_RT_BITMAP,\tXFS_FSOP_GEOM_SICK_RT_BITMAP },\n\t{ XFS_SICK_RT_SUMMARY,\tXFS_FSOP_GEOM_SICK_RT_SUMMARY },\n\t{ 0, 0 },\n};\n\nstatic inline void\nxfgeo_health_tick(\n\tstruct xfs_fsop_geom\t\t*geo,\n\tunsigned int\t\t\tsick,\n\tunsigned int\t\t\tchecked,\n\tconst struct ioctl_sick_map\t*m)\n{\n\tif (checked & m->sick_mask)\n\t\tgeo->checked |= m->ioctl_mask;\n\tif (sick & m->sick_mask)\n\t\tgeo->sick |= m->ioctl_mask;\n}\n\n \nvoid\nxfs_fsop_geom_health(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_fsop_geom\t\t*geo)\n{\n\tconst struct ioctl_sick_map\t*m;\n\tunsigned int\t\t\tsick;\n\tunsigned int\t\t\tchecked;\n\n\tgeo->sick = 0;\n\tgeo->checked = 0;\n\n\txfs_fs_measure_sickness(mp, &sick, &checked);\n\tfor (m = fs_map; m->sick_mask; m++)\n\t\txfgeo_health_tick(geo, sick, checked, m);\n\n\txfs_rt_measure_sickness(mp, &sick, &checked);\n\tfor (m = rt_map; m->sick_mask; m++)\n\t\txfgeo_health_tick(geo, sick, checked, m);\n}\n\nstatic const struct ioctl_sick_map ag_map[] = {\n\t{ XFS_SICK_AG_SB,\tXFS_AG_GEOM_SICK_SB },\n\t{ XFS_SICK_AG_AGF,\tXFS_AG_GEOM_SICK_AGF },\n\t{ XFS_SICK_AG_AGFL,\tXFS_AG_GEOM_SICK_AGFL },\n\t{ XFS_SICK_AG_AGI,\tXFS_AG_GEOM_SICK_AGI },\n\t{ XFS_SICK_AG_BNOBT,\tXFS_AG_GEOM_SICK_BNOBT },\n\t{ XFS_SICK_AG_CNTBT,\tXFS_AG_GEOM_SICK_CNTBT },\n\t{ XFS_SICK_AG_INOBT,\tXFS_AG_GEOM_SICK_INOBT },\n\t{ XFS_SICK_AG_FINOBT,\tXFS_AG_GEOM_SICK_FINOBT },\n\t{ XFS_SICK_AG_RMAPBT,\tXFS_AG_GEOM_SICK_RMAPBT },\n\t{ XFS_SICK_AG_REFCNTBT,\tXFS_AG_GEOM_SICK_REFCNTBT },\n\t{ 0, 0 },\n};\n\n \nvoid\nxfs_ag_geom_health(\n\tstruct xfs_perag\t\t*pag,\n\tstruct xfs_ag_geometry\t\t*ageo)\n{\n\tconst struct ioctl_sick_map\t*m;\n\tunsigned int\t\t\tsick;\n\tunsigned int\t\t\tchecked;\n\n\tageo->ag_sick = 0;\n\tageo->ag_checked = 0;\n\n\txfs_ag_measure_sickness(pag, &sick, &checked);\n\tfor (m = ag_map; m->sick_mask; m++) {\n\t\tif (checked & m->sick_mask)\n\t\t\tageo->ag_checked |= m->ioctl_mask;\n\t\tif (sick & m->sick_mask)\n\t\t\tageo->ag_sick |= m->ioctl_mask;\n\t}\n}\n\nstatic const struct ioctl_sick_map ino_map[] = {\n\t{ XFS_SICK_INO_CORE,\tXFS_BS_SICK_INODE },\n\t{ XFS_SICK_INO_BMBTD,\tXFS_BS_SICK_BMBTD },\n\t{ XFS_SICK_INO_BMBTA,\tXFS_BS_SICK_BMBTA },\n\t{ XFS_SICK_INO_BMBTC,\tXFS_BS_SICK_BMBTC },\n\t{ XFS_SICK_INO_DIR,\tXFS_BS_SICK_DIR },\n\t{ XFS_SICK_INO_XATTR,\tXFS_BS_SICK_XATTR },\n\t{ XFS_SICK_INO_SYMLINK,\tXFS_BS_SICK_SYMLINK },\n\t{ XFS_SICK_INO_PARENT,\tXFS_BS_SICK_PARENT },\n\t{ 0, 0 },\n};\n\n \nvoid\nxfs_bulkstat_health(\n\tstruct xfs_inode\t\t*ip,\n\tstruct xfs_bulkstat\t\t*bs)\n{\n\tconst struct ioctl_sick_map\t*m;\n\tunsigned int\t\t\tsick;\n\tunsigned int\t\t\tchecked;\n\n\tbs->bs_sick = 0;\n\tbs->bs_checked = 0;\n\n\txfs_inode_measure_sickness(ip, &sick, &checked);\n\tfor (m = ino_map; m->sick_mask; m++) {\n\t\tif (checked & m->sick_mask)\n\t\t\tbs->bs_checked |= m->ioctl_mask;\n\t\tif (sick & m->sick_mask)\n\t\t\tbs->bs_sick |= m->ioctl_mask;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}