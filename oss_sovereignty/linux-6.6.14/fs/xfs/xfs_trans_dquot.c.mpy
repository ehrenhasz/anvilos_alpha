{
  "module_name": "xfs_trans_dquot.c",
  "hash_id": "420966308907d907d4ce37c96bac074947f619c702065f90919148a143b2ba3a",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_trans_dquot.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_trans_priv.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_qm.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_error.h\"\n\nSTATIC void\txfs_trans_alloc_dqinfo(xfs_trans_t *);\n\n \nvoid\nxfs_trans_dqjoin(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_dquot\t*dqp)\n{\n\tASSERT(XFS_DQ_IS_LOCKED(dqp));\n\tASSERT(dqp->q_logitem.qli_dquot == dqp);\n\n\t \n\txfs_trans_add_item(tp, &dqp->q_logitem.qli_item);\n}\n\n \nvoid\nxfs_trans_log_dquot(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_dquot\t*dqp)\n{\n\tASSERT(XFS_DQ_IS_LOCKED(dqp));\n\n\t \n\tif (dqp->q_id != 0 &&\n\t    xfs_has_bigtime(tp->t_mountp) &&\n\t    !(dqp->q_type & XFS_DQTYPE_BIGTIME))\n\t\tdqp->q_type |= XFS_DQTYPE_BIGTIME;\n\n\ttp->t_flags |= XFS_TRANS_DIRTY;\n\tset_bit(XFS_LI_DIRTY, &dqp->q_logitem.qli_item.li_flags);\n}\n\n \nvoid\nxfs_trans_dup_dqinfo(\n\tstruct xfs_trans\t*otp,\n\tstruct xfs_trans\t*ntp)\n{\n\tstruct xfs_dqtrx\t*oq, *nq;\n\tint\t\t\ti, j;\n\tstruct xfs_dqtrx\t*oqa, *nqa;\n\tuint64_t\t\tblk_res_used;\n\n\tif (!otp->t_dqinfo)\n\t\treturn;\n\n\txfs_trans_alloc_dqinfo(ntp);\n\n\tfor (j = 0; j < XFS_QM_TRANS_DQTYPES; j++) {\n\t\toqa = otp->t_dqinfo->dqs[j];\n\t\tnqa = ntp->t_dqinfo->dqs[j];\n\t\tfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\n\t\t\tblk_res_used = 0;\n\n\t\t\tif (oqa[i].qt_dquot == NULL)\n\t\t\t\tbreak;\n\t\t\toq = &oqa[i];\n\t\t\tnq = &nqa[i];\n\n\t\t\tif (oq->qt_blk_res && oq->qt_bcount_delta > 0)\n\t\t\t\tblk_res_used = oq->qt_bcount_delta;\n\n\t\t\tnq->qt_dquot = oq->qt_dquot;\n\t\t\tnq->qt_bcount_delta = nq->qt_icount_delta = 0;\n\t\t\tnq->qt_rtbcount_delta = 0;\n\n\t\t\t \n\t\t\tnq->qt_blk_res = oq->qt_blk_res - blk_res_used;\n\t\t\toq->qt_blk_res = blk_res_used;\n\n\t\t\tnq->qt_rtblk_res = oq->qt_rtblk_res -\n\t\t\t\toq->qt_rtblk_res_used;\n\t\t\toq->qt_rtblk_res = oq->qt_rtblk_res_used;\n\n\t\t\tnq->qt_ino_res = oq->qt_ino_res - oq->qt_ino_res_used;\n\t\t\toq->qt_ino_res = oq->qt_ino_res_used;\n\n\t\t}\n\t}\n}\n\n \nvoid\nxfs_trans_mod_dquot_byino(\n\txfs_trans_t\t*tp,\n\txfs_inode_t\t*ip,\n\tuint\t\tfield,\n\tint64_t\t\tdelta)\n{\n\txfs_mount_t\t*mp = tp->t_mountp;\n\n\tif (!XFS_IS_QUOTA_ON(mp) ||\n\t    xfs_is_quota_inode(&mp->m_sb, ip->i_ino))\n\t\treturn;\n\n\tif (XFS_IS_UQUOTA_ON(mp) && ip->i_udquot)\n\t\t(void) xfs_trans_mod_dquot(tp, ip->i_udquot, field, delta);\n\tif (XFS_IS_GQUOTA_ON(mp) && ip->i_gdquot)\n\t\t(void) xfs_trans_mod_dquot(tp, ip->i_gdquot, field, delta);\n\tif (XFS_IS_PQUOTA_ON(mp) && ip->i_pdquot)\n\t\t(void) xfs_trans_mod_dquot(tp, ip->i_pdquot, field, delta);\n}\n\nSTATIC struct xfs_dqtrx *\nxfs_trans_get_dqtrx(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_dquot\t*dqp)\n{\n\tint\t\t\ti;\n\tstruct xfs_dqtrx\t*qa;\n\n\tswitch (xfs_dquot_type(dqp)) {\n\tcase XFS_DQTYPE_USER:\n\t\tqa = tp->t_dqinfo->dqs[XFS_QM_TRANS_USR];\n\t\tbreak;\n\tcase XFS_DQTYPE_GROUP:\n\t\tqa = tp->t_dqinfo->dqs[XFS_QM_TRANS_GRP];\n\t\tbreak;\n\tcase XFS_DQTYPE_PROJ:\n\t\tqa = tp->t_dqinfo->dqs[XFS_QM_TRANS_PRJ];\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\tfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\n\t\tif (qa[i].qt_dquot == NULL ||\n\t\t    qa[i].qt_dquot == dqp)\n\t\t\treturn &qa[i];\n\t}\n\n\treturn NULL;\n}\n\n \nvoid\nxfs_trans_mod_dquot(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_dquot\t*dqp,\n\tuint\t\t\tfield,\n\tint64_t\t\t\tdelta)\n{\n\tstruct xfs_dqtrx\t*qtrx;\n\n\tASSERT(tp);\n\tASSERT(XFS_IS_QUOTA_ON(tp->t_mountp));\n\tqtrx = NULL;\n\n\tif (!delta)\n\t\treturn;\n\n\tif (tp->t_dqinfo == NULL)\n\t\txfs_trans_alloc_dqinfo(tp);\n\t \n\tqtrx = xfs_trans_get_dqtrx(tp, dqp);\n\tASSERT(qtrx);\n\tif (qtrx->qt_dquot == NULL)\n\t\tqtrx->qt_dquot = dqp;\n\n\ttrace_xfs_trans_mod_dquot_before(qtrx);\n\ttrace_xfs_trans_mod_dquot(tp, dqp, field, delta);\n\n\tswitch (field) {\n\t \n\tcase XFS_TRANS_DQ_RES_BLKS:\n\t\tqtrx->qt_blk_res += delta;\n\t\tbreak;\n\n\t \n\tcase XFS_TRANS_DQ_RES_INOS:\n\t\tqtrx->qt_ino_res += delta;\n\t\tbreak;\n\n\t \n\tcase XFS_TRANS_DQ_BCOUNT:\n\t\tqtrx->qt_bcount_delta += delta;\n\t\tbreak;\n\n\tcase XFS_TRANS_DQ_DELBCOUNT:\n\t\tqtrx->qt_delbcnt_delta += delta;\n\t\tbreak;\n\n\t \n\tcase XFS_TRANS_DQ_ICOUNT:\n\t\tif (qtrx->qt_ino_res && delta > 0) {\n\t\t\tqtrx->qt_ino_res_used += delta;\n\t\t\tASSERT(qtrx->qt_ino_res >= qtrx->qt_ino_res_used);\n\t\t}\n\t\tqtrx->qt_icount_delta += delta;\n\t\tbreak;\n\n\t \n\tcase XFS_TRANS_DQ_RES_RTBLKS:\n\t\tqtrx->qt_rtblk_res += delta;\n\t\tbreak;\n\n\t \n\tcase XFS_TRANS_DQ_RTBCOUNT:\n\t\tif (qtrx->qt_rtblk_res && delta > 0) {\n\t\t\tqtrx->qt_rtblk_res_used += delta;\n\t\t\tASSERT(qtrx->qt_rtblk_res >= qtrx->qt_rtblk_res_used);\n\t\t}\n\t\tqtrx->qt_rtbcount_delta += delta;\n\t\tbreak;\n\n\tcase XFS_TRANS_DQ_DELRTBCOUNT:\n\t\tqtrx->qt_delrtb_delta += delta;\n\t\tbreak;\n\n\tdefault:\n\t\tASSERT(0);\n\t}\n\n\ttrace_xfs_trans_mod_dquot_after(qtrx);\n}\n\n\n \nSTATIC void\nxfs_trans_dqlockedjoin(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_dqtrx\t*q)\n{\n\tASSERT(q[0].qt_dquot != NULL);\n\tif (q[1].qt_dquot == NULL) {\n\t\txfs_dqlock(q[0].qt_dquot);\n\t\txfs_trans_dqjoin(tp, q[0].qt_dquot);\n\t} else {\n\t\tASSERT(XFS_QM_TRANS_MAXDQS == 2);\n\t\txfs_dqlock2(q[0].qt_dquot, q[1].qt_dquot);\n\t\txfs_trans_dqjoin(tp, q[0].qt_dquot);\n\t\txfs_trans_dqjoin(tp, q[1].qt_dquot);\n\t}\n}\n\n \nstatic inline void\nxfs_apply_quota_reservation_deltas(\n\tstruct xfs_dquot_res\t*res,\n\tuint64_t\t\treserved,\n\tint64_t\t\t\tres_used,\n\tint64_t\t\t\tcount_delta)\n{\n\tif (reserved != 0) {\n\t\t \n\t\tres->reserved -= abs(reserved - res_used);\n\t} else if (count_delta != 0) {\n\t\t \n\t\tres->reserved += count_delta;\n\t}\n}\n\n \nvoid\nxfs_trans_apply_dquot_deltas(\n\tstruct xfs_trans\t*tp)\n{\n\tint\t\t\ti, j;\n\tstruct xfs_dquot\t*dqp;\n\tstruct xfs_dqtrx\t*qtrx, *qa;\n\tint64_t\t\t\ttotalbdelta;\n\tint64_t\t\t\ttotalrtbdelta;\n\n\tif (!tp->t_dqinfo)\n\t\treturn;\n\n\tASSERT(tp->t_dqinfo);\n\tfor (j = 0; j < XFS_QM_TRANS_DQTYPES; j++) {\n\t\tqa = tp->t_dqinfo->dqs[j];\n\t\tif (qa[0].qt_dquot == NULL)\n\t\t\tcontinue;\n\n\t\t \n\t\txfs_trans_dqlockedjoin(tp, qa);\n\n\t\tfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\n\t\t\tuint64_t\tblk_res_used;\n\n\t\t\tqtrx = &qa[i];\n\t\t\t \n\t\t\tif ((dqp = qtrx->qt_dquot) == NULL)\n\t\t\t\tbreak;\n\n\t\t\tASSERT(XFS_DQ_IS_LOCKED(dqp));\n\n\t\t\t \n\n\t\t\t \n\t\t\ttotalbdelta = qtrx->qt_bcount_delta +\n\t\t\t\tqtrx->qt_delbcnt_delta;\n\t\t\ttotalrtbdelta = qtrx->qt_rtbcount_delta +\n\t\t\t\tqtrx->qt_delrtb_delta;\n\n\t\t\tif (totalbdelta != 0 || totalrtbdelta != 0 ||\n\t\t\t    qtrx->qt_icount_delta != 0) {\n\t\t\t\ttrace_xfs_trans_apply_dquot_deltas_before(dqp);\n\t\t\t\ttrace_xfs_trans_apply_dquot_deltas(qtrx);\n\t\t\t}\n\n#ifdef DEBUG\n\t\t\tif (totalbdelta < 0)\n\t\t\t\tASSERT(dqp->q_blk.count >= -totalbdelta);\n\n\t\t\tif (totalrtbdelta < 0)\n\t\t\t\tASSERT(dqp->q_rtb.count >= -totalrtbdelta);\n\n\t\t\tif (qtrx->qt_icount_delta < 0)\n\t\t\t\tASSERT(dqp->q_ino.count >= -qtrx->qt_icount_delta);\n#endif\n\t\t\tif (totalbdelta)\n\t\t\t\tdqp->q_blk.count += totalbdelta;\n\n\t\t\tif (qtrx->qt_icount_delta)\n\t\t\t\tdqp->q_ino.count += qtrx->qt_icount_delta;\n\n\t\t\tif (totalrtbdelta)\n\t\t\t\tdqp->q_rtb.count += totalrtbdelta;\n\n\t\t\tif (totalbdelta != 0 || totalrtbdelta != 0 ||\n\t\t\t    qtrx->qt_icount_delta != 0)\n\t\t\t\ttrace_xfs_trans_apply_dquot_deltas_after(dqp);\n\n\t\t\t \n\t\t\tif (dqp->q_id) {\n\t\t\t\txfs_qm_adjust_dqlimits(dqp);\n\t\t\t\txfs_qm_adjust_dqtimers(dqp);\n\t\t\t}\n\n\t\t\tdqp->q_flags |= XFS_DQFLAG_DIRTY;\n\t\t\t \n\t\t\txfs_trans_log_dquot(tp, dqp);\n\t\t\t \n\t\t\tblk_res_used = max_t(int64_t, 0, qtrx->qt_bcount_delta);\n\t\t\txfs_apply_quota_reservation_deltas(&dqp->q_blk,\n\t\t\t\t\tqtrx->qt_blk_res, blk_res_used,\n\t\t\t\t\tqtrx->qt_bcount_delta);\n\n\t\t\t \n\t\t\txfs_apply_quota_reservation_deltas(&dqp->q_rtb,\n\t\t\t\t\tqtrx->qt_rtblk_res,\n\t\t\t\t\tqtrx->qt_rtblk_res_used,\n\t\t\t\t\tqtrx->qt_rtbcount_delta);\n\n\t\t\t \n\t\t\tASSERT(qtrx->qt_ino_res >= qtrx->qt_ino_res_used);\n\t\t\txfs_apply_quota_reservation_deltas(&dqp->q_ino,\n\t\t\t\t\tqtrx->qt_ino_res,\n\t\t\t\t\tqtrx->qt_ino_res_used,\n\t\t\t\t\tqtrx->qt_icount_delta);\n\n\t\t\tASSERT(dqp->q_blk.reserved >= dqp->q_blk.count);\n\t\t\tASSERT(dqp->q_ino.reserved >= dqp->q_ino.count);\n\t\t\tASSERT(dqp->q_rtb.reserved >= dqp->q_rtb.count);\n\t\t}\n\t}\n}\n\n \nvoid\nxfs_trans_unreserve_and_mod_dquots(\n\tstruct xfs_trans\t*tp)\n{\n\tint\t\t\ti, j;\n\tstruct xfs_dquot\t*dqp;\n\tstruct xfs_dqtrx\t*qtrx, *qa;\n\tbool\t\t\tlocked;\n\n\tif (!tp->t_dqinfo)\n\t\treturn;\n\n\tfor (j = 0; j < XFS_QM_TRANS_DQTYPES; j++) {\n\t\tqa = tp->t_dqinfo->dqs[j];\n\n\t\tfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\n\t\t\tqtrx = &qa[i];\n\t\t\t \n\t\t\tif ((dqp = qtrx->qt_dquot) == NULL)\n\t\t\t\tbreak;\n\t\t\t \n\t\t\tlocked = false;\n\t\t\tif (qtrx->qt_blk_res) {\n\t\t\t\txfs_dqlock(dqp);\n\t\t\t\tlocked = true;\n\t\t\t\tdqp->q_blk.reserved -=\n\t\t\t\t\t(xfs_qcnt_t)qtrx->qt_blk_res;\n\t\t\t}\n\t\t\tif (qtrx->qt_ino_res) {\n\t\t\t\tif (!locked) {\n\t\t\t\t\txfs_dqlock(dqp);\n\t\t\t\t\tlocked = true;\n\t\t\t\t}\n\t\t\t\tdqp->q_ino.reserved -=\n\t\t\t\t\t(xfs_qcnt_t)qtrx->qt_ino_res;\n\t\t\t}\n\n\t\t\tif (qtrx->qt_rtblk_res) {\n\t\t\t\tif (!locked) {\n\t\t\t\t\txfs_dqlock(dqp);\n\t\t\t\t\tlocked = true;\n\t\t\t\t}\n\t\t\t\tdqp->q_rtb.reserved -=\n\t\t\t\t\t(xfs_qcnt_t)qtrx->qt_rtblk_res;\n\t\t\t}\n\t\t\tif (locked)\n\t\t\t\txfs_dqunlock(dqp);\n\n\t\t}\n\t}\n}\n\nSTATIC void\nxfs_quota_warn(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dquot\t*dqp,\n\tint\t\t\ttype)\n{\n\tenum quota_type\t\tqtype;\n\n\tswitch (xfs_dquot_type(dqp)) {\n\tcase XFS_DQTYPE_PROJ:\n\t\tqtype = PRJQUOTA;\n\t\tbreak;\n\tcase XFS_DQTYPE_USER:\n\t\tqtype = USRQUOTA;\n\t\tbreak;\n\tcase XFS_DQTYPE_GROUP:\n\t\tqtype = GRPQUOTA;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tquota_send_warning(make_kqid(&init_user_ns, qtype, dqp->q_id),\n\t\t\t   mp->m_super->s_dev, type);\n}\n\n \nstatic inline int\nxfs_dqresv_check(\n\tstruct xfs_dquot_res\t*res,\n\tstruct xfs_quota_limits\t*qlim,\n\tint64_t\t\t\tdelta,\n\tbool\t\t\t*fatal)\n{\n\txfs_qcnt_t\t\thardlimit = res->hardlimit;\n\txfs_qcnt_t\t\tsoftlimit = res->softlimit;\n\txfs_qcnt_t\t\ttotal_count = res->reserved + delta;\n\n\tBUILD_BUG_ON(QUOTA_NL_BHARDWARN     != QUOTA_NL_IHARDWARN + 3);\n\tBUILD_BUG_ON(QUOTA_NL_BSOFTLONGWARN != QUOTA_NL_ISOFTLONGWARN + 3);\n\tBUILD_BUG_ON(QUOTA_NL_BSOFTWARN     != QUOTA_NL_ISOFTWARN + 3);\n\n\t*fatal = false;\n\tif (delta <= 0)\n\t\treturn QUOTA_NL_NOWARN;\n\n\tif (!hardlimit)\n\t\thardlimit = qlim->hard;\n\tif (!softlimit)\n\t\tsoftlimit = qlim->soft;\n\n\tif (hardlimit && total_count > hardlimit) {\n\t\t*fatal = true;\n\t\treturn QUOTA_NL_IHARDWARN;\n\t}\n\n\tif (softlimit && total_count > softlimit) {\n\t\ttime64_t\tnow = ktime_get_real_seconds();\n\n\t\tif (res->timer != 0 && now > res->timer) {\n\t\t\t*fatal = true;\n\t\t\treturn QUOTA_NL_ISOFTLONGWARN;\n\t\t}\n\n\t\treturn QUOTA_NL_ISOFTWARN;\n\t}\n\n\treturn QUOTA_NL_NOWARN;\n}\n\n \nSTATIC int\nxfs_trans_dqresv(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dquot\t*dqp,\n\tint64_t\t\t\tnblks,\n\tlong\t\t\tninos,\n\tuint\t\t\tflags)\n{\n\tstruct xfs_quotainfo\t*q = mp->m_quotainfo;\n\tstruct xfs_def_quota\t*defq;\n\tstruct xfs_dquot_res\t*blkres;\n\tstruct xfs_quota_limits\t*qlim;\n\n\txfs_dqlock(dqp);\n\n\tdefq = xfs_get_defquota(q, xfs_dquot_type(dqp));\n\n\tif (flags & XFS_TRANS_DQ_RES_BLKS) {\n\t\tblkres = &dqp->q_blk;\n\t\tqlim = &defq->blk;\n\t} else {\n\t\tblkres = &dqp->q_rtb;\n\t\tqlim = &defq->rtb;\n\t}\n\n\tif ((flags & XFS_QMOPT_FORCE_RES) == 0 && dqp->q_id &&\n\t    xfs_dquot_is_enforced(dqp)) {\n\t\tint\t\tquota_nl;\n\t\tbool\t\tfatal;\n\n\t\t \n\t\tquota_nl = xfs_dqresv_check(blkres, qlim, nblks, &fatal);\n\t\tif (quota_nl != QUOTA_NL_NOWARN) {\n\t\t\t \n\t\t\txfs_quota_warn(mp, dqp, quota_nl + 3);\n\t\t\tif (fatal)\n\t\t\t\tgoto error_return;\n\t\t}\n\n\t\tquota_nl = xfs_dqresv_check(&dqp->q_ino, &defq->ino, ninos,\n\t\t\t\t&fatal);\n\t\tif (quota_nl != QUOTA_NL_NOWARN) {\n\t\t\txfs_quota_warn(mp, dqp, quota_nl);\n\t\t\tif (fatal)\n\t\t\t\tgoto error_return;\n\t\t}\n\t}\n\n\t \n\tblkres->reserved += (xfs_qcnt_t)nblks;\n\tdqp->q_ino.reserved += (xfs_qcnt_t)ninos;\n\n\t \n\tif (tp) {\n\t\tASSERT(flags & XFS_QMOPT_RESBLK_MASK);\n\t\txfs_trans_mod_dquot(tp, dqp, flags & XFS_QMOPT_RESBLK_MASK,\n\t\t\t\t    nblks);\n\t\txfs_trans_mod_dquot(tp, dqp, XFS_TRANS_DQ_RES_INOS, ninos);\n\t}\n\n\tif (XFS_IS_CORRUPT(mp, dqp->q_blk.reserved < dqp->q_blk.count) ||\n\t    XFS_IS_CORRUPT(mp, dqp->q_rtb.reserved < dqp->q_rtb.count) ||\n\t    XFS_IS_CORRUPT(mp, dqp->q_ino.reserved < dqp->q_ino.count))\n\t\tgoto error_corrupt;\n\n\txfs_dqunlock(dqp);\n\treturn 0;\n\nerror_return:\n\txfs_dqunlock(dqp);\n\tif (xfs_dquot_type(dqp) == XFS_DQTYPE_PROJ)\n\t\treturn -ENOSPC;\n\treturn -EDQUOT;\nerror_corrupt:\n\txfs_dqunlock(dqp);\n\txfs_force_shutdown(mp, SHUTDOWN_CORRUPT_INCORE);\n\treturn -EFSCORRUPTED;\n}\n\n\n \nint\nxfs_trans_reserve_quota_bydquots(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dquot\t*udqp,\n\tstruct xfs_dquot\t*gdqp,\n\tstruct xfs_dquot\t*pdqp,\n\tint64_t\t\t\tnblks,\n\tlong\t\t\tninos,\n\tuint\t\t\tflags)\n{\n\tint\t\terror;\n\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn 0;\n\n\tASSERT(flags & XFS_QMOPT_RESBLK_MASK);\n\n\tif (udqp) {\n\t\terror = xfs_trans_dqresv(tp, mp, udqp, nblks, ninos, flags);\n\t\tif (error)\n\t\t\treturn error;\n\t}\n\n\tif (gdqp) {\n\t\terror = xfs_trans_dqresv(tp, mp, gdqp, nblks, ninos, flags);\n\t\tif (error)\n\t\t\tgoto unwind_usr;\n\t}\n\n\tif (pdqp) {\n\t\terror = xfs_trans_dqresv(tp, mp, pdqp, nblks, ninos, flags);\n\t\tif (error)\n\t\t\tgoto unwind_grp;\n\t}\n\n\t \n\treturn 0;\n\nunwind_grp:\n\tflags |= XFS_QMOPT_FORCE_RES;\n\tif (gdqp)\n\t\txfs_trans_dqresv(tp, mp, gdqp, -nblks, -ninos, flags);\nunwind_usr:\n\tflags |= XFS_QMOPT_FORCE_RES;\n\tif (udqp)\n\t\txfs_trans_dqresv(tp, mp, udqp, -nblks, -ninos, flags);\n\treturn error;\n}\n\n\n \nint\nxfs_trans_reserve_quota_nblks(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*ip,\n\tint64_t\t\t\tdblocks,\n\tint64_t\t\t\trblocks,\n\tbool\t\t\tforce)\n{\n\tstruct xfs_mount\t*mp = ip->i_mount;\n\tunsigned int\t\tqflags = 0;\n\tint\t\t\terror;\n\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn 0;\n\n\tASSERT(!xfs_is_quota_inode(&mp->m_sb, ip->i_ino));\n\tASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\n\n\tif (force)\n\t\tqflags |= XFS_QMOPT_FORCE_RES;\n\n\t \n\terror = xfs_trans_reserve_quota_bydquots(tp, mp, ip->i_udquot,\n\t\t\tip->i_gdquot, ip->i_pdquot, dblocks, 0,\n\t\t\tXFS_QMOPT_RES_REGBLKS | qflags);\n\tif (error)\n\t\treturn error;\n\n\t \n\terror = xfs_trans_reserve_quota_bydquots(tp, mp, ip->i_udquot,\n\t\t\tip->i_gdquot, ip->i_pdquot, rblocks, 0,\n\t\t\tXFS_QMOPT_RES_RTBLKS | qflags);\n\tif (error) {\n\t\txfs_trans_reserve_quota_bydquots(tp, mp, ip->i_udquot,\n\t\t\t\tip->i_gdquot, ip->i_pdquot, -dblocks, 0,\n\t\t\t\tXFS_QMOPT_RES_REGBLKS);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\n \nint\nxfs_trans_reserve_quota_icreate(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_dquot\t*udqp,\n\tstruct xfs_dquot\t*gdqp,\n\tstruct xfs_dquot\t*pdqp,\n\tint64_t\t\t\tdblocks)\n{\n\tstruct xfs_mount\t*mp = tp->t_mountp;\n\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn 0;\n\n\treturn xfs_trans_reserve_quota_bydquots(tp, mp, udqp, gdqp, pdqp,\n\t\t\tdblocks, 1, XFS_QMOPT_RES_REGBLKS);\n}\n\nSTATIC void\nxfs_trans_alloc_dqinfo(\n\txfs_trans_t\t*tp)\n{\n\ttp->t_dqinfo = kmem_cache_zalloc(xfs_dqtrx_cache,\n\t\t\t\t\t GFP_KERNEL | __GFP_NOFAIL);\n}\n\nvoid\nxfs_trans_free_dqinfo(\n\txfs_trans_t\t*tp)\n{\n\tif (!tp->t_dqinfo)\n\t\treturn;\n\tkmem_cache_free(xfs_dqtrx_cache, tp->t_dqinfo);\n\ttp->t_dqinfo = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}