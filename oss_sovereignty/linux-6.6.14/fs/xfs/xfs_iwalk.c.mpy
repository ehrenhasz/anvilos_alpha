{
  "module_name": "xfs_iwalk.c",
  "hash_id": "e121d6edd377214d0e07a904f73cedde97180d31af58b8150437eec2319c5f4f",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_iwalk.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_ialloc.h\"\n#include \"xfs_ialloc_btree.h\"\n#include \"xfs_iwalk.h\"\n#include \"xfs_error.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_icache.h\"\n#include \"xfs_health.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_pwork.h\"\n#include \"xfs_ag.h\"\n\n \n\nstruct xfs_iwalk_ag {\n\t \n\tstruct xfs_pwork\t\tpwork;\n\n\tstruct xfs_mount\t\t*mp;\n\tstruct xfs_trans\t\t*tp;\n\tstruct xfs_perag\t\t*pag;\n\n\t \n\txfs_ino_t\t\t\tstartino;\n\n\t \n\txfs_ino_t\t\t\tlastino;\n\n\t \n\tstruct xfs_inobt_rec_incore\t*recs;\n\n\t \n\tunsigned int\t\t\tsz_recs;\n\n\t \n\tunsigned int\t\t\tnr_recs;\n\n\t \n\txfs_iwalk_fn\t\t\tiwalk_fn;\n\txfs_inobt_walk_fn\t\tinobt_walk_fn;\n\tvoid\t\t\t\t*data;\n\n\t \n\tunsigned int\t\t\ttrim_start:1;\n\n\t \n\tunsigned int\t\t\tskip_empty:1;\n\n\t \n\tunsigned int\t\t\tdrop_trans:1;\n};\n\n \nSTATIC void\nxfs_iwalk_ichunk_ra(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_perag\t\t*pag,\n\tstruct xfs_inobt_rec_incore\t*irec)\n{\n\tstruct xfs_ino_geometry\t\t*igeo = M_IGEO(mp);\n\txfs_agblock_t\t\t\tagbno;\n\tstruct blk_plug\t\t\tplug;\n\tint\t\t\t\ti;\t \n\n\tagbno = XFS_AGINO_TO_AGBNO(mp, irec->ir_startino);\n\n\tblk_start_plug(&plug);\n\tfor (i = 0; i < XFS_INODES_PER_CHUNK; i += igeo->inodes_per_cluster) {\n\t\txfs_inofree_t\timask;\n\n\t\timask = xfs_inobt_maskn(i, igeo->inodes_per_cluster);\n\t\tif (imask & ~irec->ir_free) {\n\t\t\txfs_btree_reada_bufs(mp, pag->pag_agno, agbno,\n\t\t\t\t\tigeo->blocks_per_cluster,\n\t\t\t\t\t&xfs_inode_buf_ops);\n\t\t}\n\t\tagbno += igeo->blocks_per_cluster;\n\t}\n\tblk_finish_plug(&plug);\n}\n\n \nSTATIC void\nxfs_iwalk_adjust_start(\n\txfs_agino_t\t\t\tagino,\t \n\tstruct xfs_inobt_rec_incore\t*irec)\t \n{\n\tint\t\t\t\tidx;\t \n\tint\t\t\t\ti;\n\n\tidx = agino - irec->ir_startino;\n\n\t \n\tfor (i = 0; i < idx; i++) {\n\t\tif (XFS_INOBT_MASK(i) & ~irec->ir_free)\n\t\t\tirec->ir_freecount++;\n\t}\n\n\tirec->ir_free |= xfs_inobt_maskn(0, idx);\n}\n\n \nSTATIC int\nxfs_iwalk_alloc(\n\tstruct xfs_iwalk_ag\t*iwag)\n{\n\tsize_t\t\t\tsize;\n\n\tASSERT(iwag->recs == NULL);\n\tiwag->nr_recs = 0;\n\n\t \n\tsize = iwag->sz_recs * sizeof(struct xfs_inobt_rec_incore);\n\tiwag->recs = kmem_alloc(size, KM_MAYFAIL);\n\tif (iwag->recs == NULL)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\n \nSTATIC void\nxfs_iwalk_free(\n\tstruct xfs_iwalk_ag\t*iwag)\n{\n\tkmem_free(iwag->recs);\n\tiwag->recs = NULL;\n}\n\n \nSTATIC int\nxfs_iwalk_ag_recs(\n\tstruct xfs_iwalk_ag\t*iwag)\n{\n\tstruct xfs_mount\t*mp = iwag->mp;\n\tstruct xfs_trans\t*tp = iwag->tp;\n\tstruct xfs_perag\t*pag = iwag->pag;\n\txfs_ino_t\t\tino;\n\tunsigned int\t\ti, j;\n\tint\t\t\terror;\n\n\tfor (i = 0; i < iwag->nr_recs; i++) {\n\t\tstruct xfs_inobt_rec_incore\t*irec = &iwag->recs[i];\n\n\t\ttrace_xfs_iwalk_ag_rec(mp, pag->pag_agno, irec);\n\n\t\tif (xfs_pwork_want_abort(&iwag->pwork))\n\t\t\treturn 0;\n\n\t\tif (iwag->inobt_walk_fn) {\n\t\t\terror = iwag->inobt_walk_fn(mp, tp, pag->pag_agno, irec,\n\t\t\t\t\tiwag->data);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t}\n\n\t\tif (!iwag->iwalk_fn)\n\t\t\tcontinue;\n\n\t\tfor (j = 0; j < XFS_INODES_PER_CHUNK; j++) {\n\t\t\tif (xfs_pwork_want_abort(&iwag->pwork))\n\t\t\t\treturn 0;\n\n\t\t\t \n\t\t\tif (XFS_INOBT_MASK(j) & irec->ir_free)\n\t\t\t\tcontinue;\n\n\t\t\t \n\t\t\tino = XFS_AGINO_TO_INO(mp, pag->pag_agno,\n\t\t\t\t\t\tirec->ir_startino + j);\n\t\t\terror = iwag->iwalk_fn(mp, tp, ino, iwag->data);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic inline void\nxfs_iwalk_del_inobt(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_btree_cur\t**curpp,\n\tstruct xfs_buf\t\t**agi_bpp,\n\tint\t\t\terror)\n{\n\tif (*curpp) {\n\t\txfs_btree_del_cursor(*curpp, error);\n\t\t*curpp = NULL;\n\t}\n\tif (*agi_bpp) {\n\t\txfs_trans_brelse(tp, *agi_bpp);\n\t\t*agi_bpp = NULL;\n\t}\n}\n\n \nSTATIC int\nxfs_iwalk_ag_start(\n\tstruct xfs_iwalk_ag\t*iwag,\n\txfs_agino_t\t\tagino,\n\tstruct xfs_btree_cur\t**curpp,\n\tstruct xfs_buf\t\t**agi_bpp,\n\tint\t\t\t*has_more)\n{\n\tstruct xfs_mount\t*mp = iwag->mp;\n\tstruct xfs_trans\t*tp = iwag->tp;\n\tstruct xfs_perag\t*pag = iwag->pag;\n\tstruct xfs_inobt_rec_incore *irec;\n\tint\t\t\terror;\n\n\t \n\tiwag->nr_recs = 0;\n\terror = xfs_inobt_cur(pag, tp, XFS_BTNUM_INO, curpp, agi_bpp);\n\tif (error)\n\t\treturn error;\n\n\t \n\tif (agino == 0)\n\t\treturn xfs_inobt_lookup(*curpp, 0, XFS_LOOKUP_GE, has_more);\n\n\t \n\terror = xfs_inobt_lookup(*curpp, agino, XFS_LOOKUP_LE, has_more);\n\tif (error)\n\t\treturn error;\n\n\t \n\tif (!*has_more)\n\t\tgoto out_advance;\n\n\t \n\tirec = &iwag->recs[iwag->nr_recs];\n\terror = xfs_inobt_get_rec(*curpp, irec, has_more);\n\tif (error)\n\t\treturn error;\n\tif (XFS_IS_CORRUPT(mp, *has_more != 1))\n\t\treturn -EFSCORRUPTED;\n\n\tiwag->lastino = XFS_AGINO_TO_INO(mp, pag->pag_agno,\n\t\t\t\tirec->ir_startino + XFS_INODES_PER_CHUNK - 1);\n\n\t \n\tif (irec->ir_startino + XFS_INODES_PER_CHUNK <= agino)\n\t\tgoto out_advance;\n\n\t \n\tif (iwag->trim_start)\n\t\txfs_iwalk_adjust_start(agino, irec);\n\n\t \n\tiwag->nr_recs++;\n\tASSERT(iwag->nr_recs < iwag->sz_recs);\n\nout_advance:\n\treturn xfs_btree_increment(*curpp, 0, has_more);\n}\n\n \nSTATIC int\nxfs_iwalk_run_callbacks(\n\tstruct xfs_iwalk_ag\t\t*iwag,\n\tstruct xfs_btree_cur\t\t**curpp,\n\tstruct xfs_buf\t\t\t**agi_bpp,\n\tint\t\t\t\t*has_more)\n{\n\tstruct xfs_mount\t\t*mp = iwag->mp;\n\tstruct xfs_inobt_rec_incore\t*irec;\n\txfs_agino_t\t\t\tnext_agino;\n\tint\t\t\t\terror;\n\n\tnext_agino = XFS_INO_TO_AGINO(mp, iwag->lastino) + 1;\n\n\tASSERT(iwag->nr_recs > 0);\n\n\t \n\txfs_iwalk_del_inobt(iwag->tp, curpp, agi_bpp, 0);\n\tirec = &iwag->recs[iwag->nr_recs - 1];\n\tASSERT(next_agino >= irec->ir_startino + XFS_INODES_PER_CHUNK);\n\n\tif (iwag->drop_trans) {\n\t\txfs_trans_cancel(iwag->tp);\n\t\tiwag->tp = NULL;\n\t}\n\n\terror = xfs_iwalk_ag_recs(iwag);\n\tif (error)\n\t\treturn error;\n\n\t \n\tiwag->nr_recs = 0;\n\n\tif (!has_more)\n\t\treturn 0;\n\n\tif (iwag->drop_trans) {\n\t\terror = xfs_trans_alloc_empty(mp, &iwag->tp);\n\t\tif (error)\n\t\t\treturn error;\n\t}\n\n\t \n\terror = xfs_inobt_cur(iwag->pag, iwag->tp, XFS_BTNUM_INO, curpp,\n\t\t\tagi_bpp);\n\tif (error)\n\t\treturn error;\n\n\treturn xfs_inobt_lookup(*curpp, next_agino, XFS_LOOKUP_GE, has_more);\n}\n\n \nSTATIC int\nxfs_iwalk_ag(\n\tstruct xfs_iwalk_ag\t\t*iwag)\n{\n\tstruct xfs_mount\t\t*mp = iwag->mp;\n\tstruct xfs_perag\t\t*pag = iwag->pag;\n\tstruct xfs_buf\t\t\t*agi_bp = NULL;\n\tstruct xfs_btree_cur\t\t*cur = NULL;\n\txfs_agino_t\t\t\tagino;\n\tint\t\t\t\thas_more;\n\tint\t\t\t\terror = 0;\n\n\t \n\tASSERT(pag->pag_agno == XFS_INO_TO_AGNO(mp, iwag->startino));\n\tagino = XFS_INO_TO_AGINO(mp, iwag->startino);\n\terror = xfs_iwalk_ag_start(iwag, agino, &cur, &agi_bp, &has_more);\n\n\twhile (!error && has_more) {\n\t\tstruct xfs_inobt_rec_incore\t*irec;\n\t\txfs_ino_t\t\t\trec_fsino;\n\n\t\tcond_resched();\n\t\tif (xfs_pwork_want_abort(&iwag->pwork))\n\t\t\tgoto out;\n\n\t\t \n\t\tirec = &iwag->recs[iwag->nr_recs];\n\t\terror = xfs_inobt_get_rec(cur, irec, &has_more);\n\t\tif (error || !has_more)\n\t\t\tbreak;\n\n\t\t \n\t\trec_fsino = XFS_AGINO_TO_INO(mp, pag->pag_agno, irec->ir_startino);\n\t\tif (iwag->lastino != NULLFSINO &&\n\t\t    XFS_IS_CORRUPT(mp, iwag->lastino >= rec_fsino)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out;\n\t\t}\n\t\tiwag->lastino = rec_fsino + XFS_INODES_PER_CHUNK - 1;\n\n\t\t \n\t\tif (iwag->skip_empty && irec->ir_freecount == irec->ir_count) {\n\t\t\terror = xfs_btree_increment(cur, 0, &has_more);\n\t\t\tif (error)\n\t\t\t\tbreak;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (iwag->iwalk_fn)\n\t\t\txfs_iwalk_ichunk_ra(mp, pag, irec);\n\n\t\t \n\t\tif (++iwag->nr_recs < iwag->sz_recs) {\n\t\t\terror = xfs_btree_increment(cur, 0, &has_more);\n\t\t\tif (error || !has_more)\n\t\t\t\tbreak;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tASSERT(has_more);\n\t\terror = xfs_iwalk_run_callbacks(iwag, &cur, &agi_bp, &has_more);\n\t}\n\n\tif (iwag->nr_recs == 0 || error)\n\t\tgoto out;\n\n\t \n\terror = xfs_iwalk_run_callbacks(iwag, &cur, &agi_bp, &has_more);\n\nout:\n\txfs_iwalk_del_inobt(iwag->tp, &cur, &agi_bp, error);\n\treturn error;\n}\n\n \n#define IWALK_MAX_INODE_PREFETCH\t(2048U)\n\n \nstatic inline unsigned int\nxfs_iwalk_prefetch(\n\tunsigned int\t\tinodes)\n{\n\tunsigned int\t\tinobt_records;\n\n\t \n\tif (inodes == 0)\n\t\tinodes = IWALK_MAX_INODE_PREFETCH;\n\tinodes = min(inodes, IWALK_MAX_INODE_PREFETCH);\n\n\t \n\tinodes = round_up(inodes, XFS_INODES_PER_CHUNK);\n\n\t \n\tinobt_records = (inodes * 5) / (4 * XFS_INODES_PER_CHUNK);\n\n\t \n\treturn max(inobt_records, 2U);\n}\n\n \nint\nxfs_iwalk(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\txfs_ino_t\t\tstartino,\n\tunsigned int\t\tflags,\n\txfs_iwalk_fn\t\tiwalk_fn,\n\tunsigned int\t\tinode_records,\n\tvoid\t\t\t*data)\n{\n\tstruct xfs_iwalk_ag\tiwag = {\n\t\t.mp\t\t= mp,\n\t\t.tp\t\t= tp,\n\t\t.iwalk_fn\t= iwalk_fn,\n\t\t.data\t\t= data,\n\t\t.startino\t= startino,\n\t\t.sz_recs\t= xfs_iwalk_prefetch(inode_records),\n\t\t.trim_start\t= 1,\n\t\t.skip_empty\t= 1,\n\t\t.pwork\t\t= XFS_PWORK_SINGLE_THREADED,\n\t\t.lastino\t= NULLFSINO,\n\t};\n\tstruct xfs_perag\t*pag;\n\txfs_agnumber_t\t\tagno = XFS_INO_TO_AGNO(mp, startino);\n\tint\t\t\terror;\n\n\tASSERT(agno < mp->m_sb.sb_agcount);\n\tASSERT(!(flags & ~XFS_IWALK_FLAGS_ALL));\n\n\terror = xfs_iwalk_alloc(&iwag);\n\tif (error)\n\t\treturn error;\n\n\tfor_each_perag_from(mp, agno, pag) {\n\t\tiwag.pag = pag;\n\t\terror = xfs_iwalk_ag(&iwag);\n\t\tif (error)\n\t\t\tbreak;\n\t\tiwag.startino = XFS_AGINO_TO_INO(mp, agno + 1, 0);\n\t\tif (flags & XFS_INOBT_WALK_SAME_AG)\n\t\t\tbreak;\n\t\tiwag.pag = NULL;\n\t}\n\n\tif (iwag.pag)\n\t\txfs_perag_rele(pag);\n\txfs_iwalk_free(&iwag);\n\treturn error;\n}\n\n \nstatic int\nxfs_iwalk_ag_work(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_pwork\t*pwork)\n{\n\tstruct xfs_iwalk_ag\t*iwag;\n\tint\t\t\terror = 0;\n\n\tiwag = container_of(pwork, struct xfs_iwalk_ag, pwork);\n\tif (xfs_pwork_want_abort(pwork))\n\t\tgoto out;\n\n\terror = xfs_iwalk_alloc(iwag);\n\tif (error)\n\t\tgoto out;\n\t \n\terror = xfs_trans_alloc_empty(mp, &iwag->tp);\n\tif (error)\n\t\tgoto out;\n\tiwag->drop_trans = 1;\n\n\terror = xfs_iwalk_ag(iwag);\n\tif (iwag->tp)\n\t\txfs_trans_cancel(iwag->tp);\n\txfs_iwalk_free(iwag);\nout:\n\txfs_perag_put(iwag->pag);\n\tkmem_free(iwag);\n\treturn error;\n}\n\n \nint\nxfs_iwalk_threaded(\n\tstruct xfs_mount\t*mp,\n\txfs_ino_t\t\tstartino,\n\tunsigned int\t\tflags,\n\txfs_iwalk_fn\t\tiwalk_fn,\n\tunsigned int\t\tinode_records,\n\tbool\t\t\tpolled,\n\tvoid\t\t\t*data)\n{\n\tstruct xfs_pwork_ctl\tpctl;\n\tstruct xfs_perag\t*pag;\n\txfs_agnumber_t\t\tagno = XFS_INO_TO_AGNO(mp, startino);\n\tint\t\t\terror;\n\n\tASSERT(agno < mp->m_sb.sb_agcount);\n\tASSERT(!(flags & ~XFS_IWALK_FLAGS_ALL));\n\n\terror = xfs_pwork_init(mp, &pctl, xfs_iwalk_ag_work, \"xfs_iwalk\");\n\tif (error)\n\t\treturn error;\n\n\tfor_each_perag_from(mp, agno, pag) {\n\t\tstruct xfs_iwalk_ag\t*iwag;\n\n\t\tif (xfs_pwork_ctl_want_abort(&pctl))\n\t\t\tbreak;\n\n\t\tiwag = kmem_zalloc(sizeof(struct xfs_iwalk_ag), 0);\n\t\tiwag->mp = mp;\n\n\t\t \n\t\tiwag->pag = xfs_perag_hold(pag);\n\t\tiwag->iwalk_fn = iwalk_fn;\n\t\tiwag->data = data;\n\t\tiwag->startino = startino;\n\t\tiwag->sz_recs = xfs_iwalk_prefetch(inode_records);\n\t\tiwag->lastino = NULLFSINO;\n\t\txfs_pwork_queue(&pctl, &iwag->pwork);\n\t\tstartino = XFS_AGINO_TO_INO(mp, pag->pag_agno + 1, 0);\n\t\tif (flags & XFS_INOBT_WALK_SAME_AG)\n\t\t\tbreak;\n\t}\n\tif (pag)\n\t\txfs_perag_rele(pag);\n\tif (polled)\n\t\txfs_pwork_poll(&pctl);\n\treturn xfs_pwork_destroy(&pctl);\n}\n\n \n#define MAX_INOBT_WALK_PREFETCH\t\\\n\t(PAGE_SIZE / sizeof(struct xfs_inobt_rec_incore))\n\n \nstatic inline unsigned int\nxfs_inobt_walk_prefetch(\n\tunsigned int\t\tinobt_records)\n{\n\t \n\tif (inobt_records == 0)\n\t\tinobt_records = MAX_INOBT_WALK_PREFETCH;\n\n\t \n\tinobt_records = max(inobt_records, 2U);\n\n\t \n\treturn min_t(unsigned int, inobt_records, MAX_INOBT_WALK_PREFETCH);\n}\n\n \nint\nxfs_inobt_walk(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\txfs_ino_t\t\tstartino,\n\tunsigned int\t\tflags,\n\txfs_inobt_walk_fn\tinobt_walk_fn,\n\tunsigned int\t\tinobt_records,\n\tvoid\t\t\t*data)\n{\n\tstruct xfs_iwalk_ag\tiwag = {\n\t\t.mp\t\t= mp,\n\t\t.tp\t\t= tp,\n\t\t.inobt_walk_fn\t= inobt_walk_fn,\n\t\t.data\t\t= data,\n\t\t.startino\t= startino,\n\t\t.sz_recs\t= xfs_inobt_walk_prefetch(inobt_records),\n\t\t.pwork\t\t= XFS_PWORK_SINGLE_THREADED,\n\t\t.lastino\t= NULLFSINO,\n\t};\n\tstruct xfs_perag\t*pag;\n\txfs_agnumber_t\t\tagno = XFS_INO_TO_AGNO(mp, startino);\n\tint\t\t\terror;\n\n\tASSERT(agno < mp->m_sb.sb_agcount);\n\tASSERT(!(flags & ~XFS_INOBT_WALK_FLAGS_ALL));\n\n\terror = xfs_iwalk_alloc(&iwag);\n\tif (error)\n\t\treturn error;\n\n\tfor_each_perag_from(mp, agno, pag) {\n\t\tiwag.pag = pag;\n\t\terror = xfs_iwalk_ag(&iwag);\n\t\tif (error)\n\t\t\tbreak;\n\t\tiwag.startino = XFS_AGINO_TO_INO(mp, pag->pag_agno + 1, 0);\n\t\tif (flags & XFS_INOBT_WALK_SAME_AG)\n\t\t\tbreak;\n\t\tiwag.pag = NULL;\n\t}\n\n\tif (iwag.pag)\n\t\txfs_perag_rele(pag);\n\txfs_iwalk_free(&iwag);\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}