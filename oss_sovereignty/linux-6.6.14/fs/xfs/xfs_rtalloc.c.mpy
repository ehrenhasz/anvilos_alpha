{
  "module_name": "xfs_rtalloc.c",
  "hash_id": "fb10a90d87e0030bf9eba47f7a95582f0b9e8e2dea6b4801b51613f2486051e9",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_rtalloc.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_bit.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_bmap_btree.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_trans_space.h\"\n#include \"xfs_icache.h\"\n#include \"xfs_rtalloc.h\"\n#include \"xfs_sb.h\"\n\n \nstatic int\nxfs_rtget_summary(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\tint\t\tlog,\t\t \n\txfs_rtblock_t\tbbno,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\txfs_suminfo_t\t*sum)\t\t \n{\n\treturn xfs_rtmodify_summary_int(mp, tp, log, bbno, 0, rbpp, rsb, sum);\n}\n\n \nSTATIC int\t\t\t\t \nxfs_rtany_summary(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\tint\t\tlow,\t\t \n\tint\t\thigh,\t\t \n\txfs_rtblock_t\tbbno,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\tint\t\t*stat)\t\t \n{\n\tint\t\terror;\t\t \n\tint\t\tlog;\t\t \n\txfs_suminfo_t\tsum;\t\t \n\n\t \n\tif (mp->m_rsum_cache && low < mp->m_rsum_cache[bbno])\n\t\tlow = mp->m_rsum_cache[bbno];\n\n\t \n\tfor (log = low; log <= high; log++) {\n\t\t \n\t\terror = xfs_rtget_summary(mp, tp, log, bbno, rbpp, rsb, &sum);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t\t \n\t\tif (sum) {\n\t\t\t*stat = 1;\n\t\t\tgoto out;\n\t\t}\n\t}\n\t \n\t*stat = 0;\nout:\n\t \n\tif (mp->m_rsum_cache && log > mp->m_rsum_cache[bbno])\n\t\tmp->m_rsum_cache[bbno] = log;\n\treturn 0;\n}\n\n\n \nSTATIC int\t\t\t\t \nxfs_rtcopy_summary(\n\txfs_mount_t\t*omp,\t\t \n\txfs_mount_t\t*nmp,\t\t \n\txfs_trans_t\t*tp)\t\t \n{\n\txfs_rtblock_t\tbbno;\t\t \n\tstruct xfs_buf\t*bp;\t\t \n\tint\t\terror;\t\t \n\tint\t\tlog;\t\t \n\txfs_suminfo_t\tsum;\t\t \n\txfs_fsblock_t\tsumbno;\t\t \n\n\tbp = NULL;\n\tfor (log = omp->m_rsumlevels - 1; log >= 0; log--) {\n\t\tfor (bbno = omp->m_sb.sb_rbmblocks - 1;\n\t\t     (xfs_srtblock_t)bbno >= 0;\n\t\t     bbno--) {\n\t\t\terror = xfs_rtget_summary(omp, tp, log, bbno, &bp,\n\t\t\t\t&sumbno, &sum);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t\tif (sum == 0)\n\t\t\t\tcontinue;\n\t\t\terror = xfs_rtmodify_summary(omp, tp, log, bbno, -sum,\n\t\t\t\t&bp, &sumbno);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t\terror = xfs_rtmodify_summary(nmp, tp, log, bbno, sum,\n\t\t\t\t&bp, &sumbno);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t\tASSERT(sum > 0);\n\t\t}\n\t}\n\treturn 0;\n}\n \nSTATIC int\t\t\t\t \nxfs_rtallocate_range(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tstart,\t\t \n\txfs_extlen_t\tlen,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb)\t\t \n{\n\txfs_rtblock_t\tend;\t\t \n\tint\t\terror;\t\t \n\txfs_rtblock_t\tpostblock = 0;\t \n\txfs_rtblock_t\tpreblock = 0;\t \n\n\tend = start + len - 1;\n\t \n\terror = xfs_rtfind_back(mp, tp, start, 0, &preblock);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\terror = xfs_rtfind_forw(mp, tp, end, mp->m_sb.sb_rextents - 1,\n\t\t&postblock);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\terror = xfs_rtmodify_summary(mp, tp,\n\t\tXFS_RTBLOCKLOG(postblock + 1 - preblock),\n\t\tXFS_BITTOBLOCK(mp, preblock), -1, rbpp, rsb);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\tif (preblock < start) {\n\t\terror = xfs_rtmodify_summary(mp, tp,\n\t\t\tXFS_RTBLOCKLOG(start - preblock),\n\t\t\tXFS_BITTOBLOCK(mp, preblock), 1, rbpp, rsb);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t}\n\t \n\tif (postblock > end) {\n\t\terror = xfs_rtmodify_summary(mp, tp,\n\t\t\tXFS_RTBLOCKLOG(postblock - end),\n\t\t\tXFS_BITTOBLOCK(mp, end + 1), 1, rbpp, rsb);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t}\n\t \n\terror = xfs_rtmodify_range(mp, tp, start, len, 0);\n\treturn error;\n}\n\n \nSTATIC int\t\t\t\t \nxfs_rtallocate_extent_block(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tbbno,\t\t \n\txfs_extlen_t\tminlen,\t\t \n\txfs_extlen_t\tmaxlen,\t\t \n\txfs_extlen_t\t*len,\t\t \n\txfs_rtblock_t\t*nextp,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\txfs_extlen_t\tprod,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\txfs_rtblock_t\tbesti;\t\t \n\txfs_rtblock_t\tbestlen;\t \n\txfs_rtblock_t\tend;\t\t \n\tint\t\terror;\t\t \n\txfs_rtblock_t\ti;\t\t \n\txfs_rtblock_t\tnext;\t\t \n\tint\t\tstat;\t\t \n\n\t \n\tfor (i = XFS_BLOCKTOBIT(mp, bbno), besti = -1, bestlen = 0,\n\t\tend = XFS_BLOCKTOBIT(mp, bbno + 1) - 1;\n\t     i <= end;\n\t     i++) {\n\t\t \n\t\tmaxlen = min(mp->m_sb.sb_rextents, i + maxlen) - i;\n\n\t\t \n\t\terror = xfs_rtcheck_range(mp, tp, i, maxlen, 1, &next, &stat);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t\tif (stat) {\n\t\t\t \n\t\t\terror = xfs_rtallocate_range(mp, tp, i, maxlen, rbpp,\n\t\t\t\trsb);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\t*len = maxlen;\n\t\t\t*rtblock = i;\n\t\t\treturn 0;\n\t\t}\n\t\t \n\t\tif (minlen < maxlen) {\n\t\t\txfs_rtblock_t\tthislen;\t \n\n\t\t\tthislen = next - i;\n\t\t\tif (thislen >= minlen && thislen > bestlen) {\n\t\t\t\tbesti = i;\n\t\t\t\tbestlen = thislen;\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (next < end) {\n\t\t\terror = xfs_rtfind_forw(mp, tp, next, end, &i);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t} else\n\t\t\tbreak;\n\t}\n\t \n\tif (minlen < maxlen && besti != -1) {\n\t\txfs_extlen_t\tp;\t \n\n\t\t \n\t\tif (prod > 1) {\n\t\t\tdiv_u64_rem(bestlen, prod, &p);\n\t\t\tif (p)\n\t\t\t\tbestlen -= p;\n\t\t}\n\n\t\t \n\t\terror = xfs_rtallocate_range(mp, tp, besti, bestlen, rbpp, rsb);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t\t*len = bestlen;\n\t\t*rtblock = besti;\n\t\treturn 0;\n\t}\n\t \n\t*nextp = next;\n\t*rtblock = NULLRTBLOCK;\n\treturn 0;\n}\n\n \nSTATIC int\t\t\t\t \nxfs_rtallocate_extent_exact(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tbno,\t\t \n\txfs_extlen_t\tminlen,\t\t \n\txfs_extlen_t\tmaxlen,\t\t \n\txfs_extlen_t\t*len,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\txfs_extlen_t\tprod,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\tint\t\terror;\t\t \n\txfs_extlen_t\ti;\t\t \n\tint\t\tisfree;\t\t \n\txfs_rtblock_t\tnext;\t\t \n\n\tASSERT(minlen % prod == 0 && maxlen % prod == 0);\n\t \n\terror = xfs_rtcheck_range(mp, tp, bno, maxlen, 1, &next, &isfree);\n\tif (error) {\n\t\treturn error;\n\t}\n\tif (isfree) {\n\t\t \n\t\terror = xfs_rtallocate_range(mp, tp, bno, maxlen, rbpp, rsb);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t\t*len = maxlen;\n\t\t*rtblock = bno;\n\t\treturn 0;\n\t}\n\t \n\tmaxlen = next - bno;\n\tif (maxlen < minlen) {\n\t\t \n\t\t*rtblock = NULLRTBLOCK;\n\t\treturn 0;\n\t}\n\t \n\tif (prod > 1 && (i = maxlen % prod)) {\n\t\tmaxlen -= i;\n\t\tif (maxlen < minlen) {\n\t\t\t \n\t\t\t*rtblock = NULLRTBLOCK;\n\t\t\treturn 0;\n\t\t}\n\t}\n\t \n\terror = xfs_rtallocate_range(mp, tp, bno, maxlen, rbpp, rsb);\n\tif (error) {\n\t\treturn error;\n\t}\n\t*len = maxlen;\n\t*rtblock = bno;\n\treturn 0;\n}\n\n \nSTATIC int\t\t\t\t \nxfs_rtallocate_extent_near(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tbno,\t\t \n\txfs_extlen_t\tminlen,\t\t \n\txfs_extlen_t\tmaxlen,\t\t \n\txfs_extlen_t\t*len,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\txfs_extlen_t\tprod,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\tint\t\tany;\t\t \n\txfs_rtblock_t\tbbno;\t\t \n\tint\t\terror;\t\t \n\tint\t\ti;\t\t \n\tint\t\tj;\t\t \n\tint\t\tlog2len;\t \n\txfs_rtblock_t\tn;\t\t \n\txfs_rtblock_t\tr;\t\t \n\n\tASSERT(minlen % prod == 0 && maxlen % prod == 0);\n\t \n\tif (bno >= mp->m_sb.sb_rextents)\n\t\tbno = mp->m_sb.sb_rextents - 1;\n\n\t \n\tmaxlen = min(mp->m_sb.sb_rextents, bno + maxlen) - bno;\n\tif (maxlen < minlen) {\n\t\t*rtblock = NULLRTBLOCK;\n\t\treturn 0;\n\t}\n\n\t \n\terror = xfs_rtallocate_extent_exact(mp, tp, bno, minlen, maxlen, len,\n\t\trbpp, rsb, prod, &r);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\tif (r != NULLRTBLOCK) {\n\t\t*rtblock = r;\n\t\treturn 0;\n\t}\n\tbbno = XFS_BITTOBLOCK(mp, bno);\n\ti = 0;\n\tASSERT(minlen != 0);\n\tlog2len = xfs_highbit32(minlen);\n\t \n\tfor (;;) {\n\t\t \n\t\terror = xfs_rtany_summary(mp, tp, log2len, mp->m_rsumlevels - 1,\n\t\t\tbbno + i, rbpp, rsb, &any);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t\t \n\t\tif (any) {\n\t\t\t \n\t\t\tif (i >= 0) {\n\t\t\t\t \n\t\t\t\terror = xfs_rtallocate_extent_block(mp, tp,\n\t\t\t\t\tbbno + i, minlen, maxlen, len, &n, rbpp,\n\t\t\t\t\trsb, prod, &r);\n\t\t\t\tif (error) {\n\t\t\t\t\treturn error;\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tif (r != NULLRTBLOCK) {\n\t\t\t\t\t*rtblock = r;\n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\t \n\t\t\telse {\t\t \n\t\t\t\t \n\t\t\t\tfor (j = -1; j > i; j--) {\n\t\t\t\t\t \n\t\t\t\t\terror = xfs_rtany_summary(mp, tp,\n\t\t\t\t\t\tlog2len, mp->m_rsumlevels - 1,\n\t\t\t\t\t\tbbno + j, rbpp, rsb, &any);\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treturn error;\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\tif (any)\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\terror = xfs_rtallocate_extent_block(mp,\n\t\t\t\t\t\ttp, bbno + j, minlen, maxlen,\n\t\t\t\t\t\tlen, &n, rbpp, rsb, prod, &r);\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treturn error;\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\tif (r != NULLRTBLOCK) {\n\t\t\t\t\t\t*rtblock = r;\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\terror = xfs_rtallocate_extent_block(mp, tp,\n\t\t\t\t\tbbno + i, minlen, maxlen, len, &n, rbpp,\n\t\t\t\t\trsb, prod, &r);\n\t\t\t\tif (error) {\n\t\t\t\t\treturn error;\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tif (r != NULLRTBLOCK) {\n\t\t\t\t\t*rtblock = r;\n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (i > 0 && (int)bbno - i >= 0)\n\t\t\ti = -i;\n\t\t \n\t\telse if (i > 0 && (int)bbno + i < mp->m_sb.sb_rbmblocks - 1)\n\t\t\ti++;\n\t\t \n\t\telse if (i <= 0 && (int)bbno - i < mp->m_sb.sb_rbmblocks - 1)\n\t\t\ti = 1 - i;\n\t\t \n\t\telse if (i <= 0 && (int)bbno + i > 0)\n\t\t\ti--;\n\t\t \n\t\telse\n\t\t\tbreak;\n\t}\n\t*rtblock = NULLRTBLOCK;\n\treturn 0;\n}\n\n \nSTATIC int\t\t\t\t \nxfs_rtallocate_extent_size(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_extlen_t\tminlen,\t\t \n\txfs_extlen_t\tmaxlen,\t\t \n\txfs_extlen_t\t*len,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\txfs_extlen_t\tprod,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\tint\t\terror;\t\t \n\tint\t\ti;\t\t \n\tint\t\tl;\t\t \n\txfs_rtblock_t\tn;\t\t \n\txfs_rtblock_t\tr;\t\t \n\txfs_suminfo_t\tsum;\t\t \n\n\tASSERT(minlen % prod == 0 && maxlen % prod == 0);\n\tASSERT(maxlen != 0);\n\n\t \n\tfor (l = xfs_highbit32(maxlen); l < mp->m_rsumlevels; l++) {\n\t\t \n\t\tfor (i = 0; i < mp->m_sb.sb_rbmblocks; i++) {\n\t\t\t \n\t\t\terror = xfs_rtget_summary(mp, tp, l, i, rbpp, rsb,\n\t\t\t\t&sum);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\t \n\t\t\tif (!sum)\n\t\t\t\tcontinue;\n\t\t\t \n\t\t\terror = xfs_rtallocate_extent_block(mp, tp, i, maxlen,\n\t\t\t\tmaxlen, len, &n, rbpp, rsb, prod, &r);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\t \n\t\t\tif (r != NULLRTBLOCK) {\n\t\t\t\t*rtblock = r;\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t \n\t\t\tif (XFS_BITTOBLOCK(mp, n) > i + 1)\n\t\t\t\ti = XFS_BITTOBLOCK(mp, n) - 1;\n\t\t}\n\t}\n\t \n\tif (minlen > --maxlen) {\n\t\t*rtblock = NULLRTBLOCK;\n\t\treturn 0;\n\t}\n\tASSERT(minlen != 0);\n\tASSERT(maxlen != 0);\n\n\t \n\tfor (l = xfs_highbit32(maxlen); l >= xfs_highbit32(minlen); l--) {\n\t\t \n\t\tfor (i = 0; i < mp->m_sb.sb_rbmblocks; i++) {\n\t\t\t \n\t\t\terror =\txfs_rtget_summary(mp, tp, l, i, rbpp, rsb,\n\t\t\t\t\t\t  &sum);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\t \n\t\t\tif (!sum)\n\t\t\t\tcontinue;\n\t\t\t \n\t\t\terror = xfs_rtallocate_extent_block(mp, tp, i,\n\t\t\t\t\tXFS_RTMAX(minlen, 1 << l),\n\t\t\t\t\tXFS_RTMIN(maxlen, (1 << (l + 1)) - 1),\n\t\t\t\t\tlen, &n, rbpp, rsb, prod, &r);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\t \n\t\t\tif (r != NULLRTBLOCK) {\n\t\t\t\t*rtblock = r;\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t \n\t\t\tif (XFS_BITTOBLOCK(mp, n) > i + 1)\n\t\t\t\ti = XFS_BITTOBLOCK(mp, n) - 1;\n\t\t}\n\t}\n\t \n\t*rtblock = NULLRTBLOCK;\n\treturn 0;\n}\n\n \nSTATIC int\nxfs_growfs_rt_alloc(\n\tstruct xfs_mount\t*mp,\t\t \n\txfs_extlen_t\t\toblocks,\t \n\txfs_extlen_t\t\tnblocks,\t \n\tstruct xfs_inode\t*ip)\t\t \n{\n\txfs_fileoff_t\t\tbno;\t\t \n\tstruct xfs_buf\t\t*bp;\t \n\txfs_daddr_t\t\td;\t\t \n\tint\t\t\terror;\t\t \n\txfs_fsblock_t\t\tfsbno;\t\t \n\tstruct xfs_bmbt_irec\tmap;\t\t \n\tint\t\t\tnmap;\t\t \n\tint\t\t\tresblks;\t \n\tenum xfs_blft\t\tbuf_type;\n\tstruct xfs_trans\t*tp;\n\n\tif (ip == mp->m_rsumip)\n\t\tbuf_type = XFS_BLFT_RTSUMMARY_BUF;\n\telse\n\t\tbuf_type = XFS_BLFT_RTBITMAP_BUF;\n\n\t \n\twhile (oblocks < nblocks) {\n\t\tresblks = XFS_GROWFSRT_SPACE_RES(mp, nblocks - oblocks);\n\t\t \n\t\terror = xfs_trans_alloc(mp, &M_RES(mp)->tr_growrtalloc, resblks,\n\t\t\t\t0, 0, &tp);\n\t\tif (error)\n\t\t\treturn error;\n\t\t \n\t\txfs_ilock(ip, XFS_ILOCK_EXCL);\n\t\txfs_trans_ijoin(tp, ip, XFS_ILOCK_EXCL);\n\n\t\terror = xfs_iext_count_may_overflow(ip, XFS_DATA_FORK,\n\t\t\t\tXFS_IEXT_ADD_NOSPLIT_CNT);\n\t\tif (error == -EFBIG)\n\t\t\terror = xfs_iext_count_upgrade(tp, ip,\n\t\t\t\t\tXFS_IEXT_ADD_NOSPLIT_CNT);\n\t\tif (error)\n\t\t\tgoto out_trans_cancel;\n\n\t\t \n\t\tnmap = 1;\n\t\terror = xfs_bmapi_write(tp, ip, oblocks, nblocks - oblocks,\n\t\t\t\t\tXFS_BMAPI_METADATA, 0, &map, &nmap);\n\t\tif (!error && nmap < 1)\n\t\t\terror = -ENOSPC;\n\t\tif (error)\n\t\t\tgoto out_trans_cancel;\n\t\t \n\t\terror = xfs_trans_commit(tp);\n\t\tif (error)\n\t\t\treturn error;\n\t\t \n\t\tfor (bno = map.br_startoff, fsbno = map.br_startblock;\n\t\t     bno < map.br_startoff + map.br_blockcount;\n\t\t     bno++, fsbno++) {\n\t\t\t \n\t\t\terror = xfs_trans_alloc(mp, &M_RES(mp)->tr_growrtzero,\n\t\t\t\t\t0, 0, 0, &tp);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t\t \n\t\t\txfs_ilock(ip, XFS_ILOCK_EXCL);\n\t\t\txfs_trans_ijoin(tp, ip, XFS_ILOCK_EXCL);\n\t\t\t \n\t\t\td = XFS_FSB_TO_DADDR(mp, fsbno);\n\t\t\terror = xfs_trans_get_buf(tp, mp->m_ddev_targp, d,\n\t\t\t\t\tmp->m_bsize, 0, &bp);\n\t\t\tif (error)\n\t\t\t\tgoto out_trans_cancel;\n\n\t\t\txfs_trans_buf_set_type(tp, bp, buf_type);\n\t\t\tbp->b_ops = &xfs_rtbuf_ops;\n\t\t\tmemset(bp->b_addr, 0, mp->m_sb.sb_blocksize);\n\t\t\txfs_trans_log_buf(tp, bp, 0, mp->m_sb.sb_blocksize - 1);\n\t\t\t \n\t\t\terror = xfs_trans_commit(tp);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t}\n\t\t \n\t\toblocks = map.br_startoff + map.br_blockcount;\n\t}\n\n\treturn 0;\n\nout_trans_cancel:\n\txfs_trans_cancel(tp);\n\treturn error;\n}\n\nstatic void\nxfs_alloc_rsum_cache(\n\txfs_mount_t\t*mp,\t\t \n\txfs_extlen_t\trbmblocks)\t \n{\n\t \n\tmp->m_rsum_cache = kvzalloc(rbmblocks, GFP_KERNEL);\n\tif (!mp->m_rsum_cache)\n\t\txfs_warn(mp, \"could not allocate realtime summary cache\");\n}\n\n \n\n \nint\nxfs_growfs_rt(\n\txfs_mount_t\t*mp,\t\t \n\txfs_growfs_rt_t\t*in)\t\t \n{\n\txfs_rtblock_t\tbmbno;\t\t \n\tstruct xfs_buf\t*bp;\t\t \n\tint\t\terror;\t\t \n\txfs_mount_t\t*nmp;\t\t \n\txfs_rfsblock_t\tnrblocks;\t \n\txfs_extlen_t\tnrbmblocks;\t \n\txfs_rtblock_t\tnrextents;\t \n\tuint8_t\t\tnrextslog;\t \n\txfs_extlen_t\tnrsumblocks;\t \n\tuint\t\tnrsumlevels;\t \n\tuint\t\tnrsumsize;\t \n\txfs_sb_t\t*nsbp;\t\t \n\txfs_extlen_t\trbmblocks;\t \n\txfs_extlen_t\trsumblocks;\t \n\txfs_sb_t\t*sbp;\t\t \n\txfs_fsblock_t\tsumbno;\t\t \n\tuint8_t\t\t*rsum_cache;\t \n\n\tsbp = &mp->m_sb;\n\n\tif (!capable(CAP_SYS_ADMIN))\n\t\treturn -EPERM;\n\n\t \n\tif (!XFS_IS_REALTIME_MOUNT(mp))\n\t\treturn -EINVAL;\n\t \n\tif (!mp->m_rbmip || !mp->m_rsumip)\n\t\treturn -EINVAL;\n\n\t \n\tif (in->newblocks <= sbp->sb_rblocks)\n\t\treturn -EINVAL;\n\n\t \n\tif (sbp->sb_rblocks > 0 && in->extsize != sbp->sb_rextsize)\n\t\treturn -EINVAL;\n\n\t \n\tif (XFS_FSB_TO_B(mp, in->extsize) > XFS_MAX_RTEXTSIZE ||\n\t    XFS_FSB_TO_B(mp, in->extsize) < XFS_MIN_RTEXTSIZE)\n\t\treturn -EINVAL;\n\n\t \n\tif (xfs_has_rmapbt(mp) || xfs_has_reflink(mp))\n\t\treturn -EOPNOTSUPP;\n\n\tnrblocks = in->newblocks;\n\terror = xfs_sb_validate_fsb_count(sbp, nrblocks);\n\tif (error)\n\t\treturn error;\n\t \n\terror = xfs_buf_read_uncached(mp->m_rtdev_targp,\n\t\t\t\tXFS_FSB_TO_BB(mp, nrblocks - 1),\n\t\t\t\tXFS_FSB_TO_BB(mp, 1), 0, &bp, NULL);\n\tif (error)\n\t\treturn error;\n\txfs_buf_relse(bp);\n\n\t \n\tnrextents = nrblocks;\n\tdo_div(nrextents, in->extsize);\n\tnrbmblocks = howmany_64(nrextents, NBBY * sbp->sb_blocksize);\n\tnrextslog = xfs_highbit32(nrextents);\n\tnrsumlevels = nrextslog + 1;\n\tnrsumsize = (uint)sizeof(xfs_suminfo_t) * nrsumlevels * nrbmblocks;\n\tnrsumblocks = XFS_B_TO_FSB(mp, nrsumsize);\n\tnrsumsize = XFS_FSB_TO_B(mp, nrsumblocks);\n\t \n\tif (nrsumblocks > (mp->m_sb.sb_logblocks >> 1))\n\t\treturn -EINVAL;\n\t \n\trbmblocks = XFS_B_TO_FSB(mp, mp->m_rbmip->i_disk_size);\n\trsumblocks = XFS_B_TO_FSB(mp, mp->m_rsumip->i_disk_size);\n\t \n\terror = xfs_growfs_rt_alloc(mp, rbmblocks, nrbmblocks, mp->m_rbmip);\n\tif (error)\n\t\treturn error;\n\terror = xfs_growfs_rt_alloc(mp, rsumblocks, nrsumblocks, mp->m_rsumip);\n\tif (error)\n\t\treturn error;\n\n\trsum_cache = mp->m_rsum_cache;\n\tif (nrbmblocks != sbp->sb_rbmblocks)\n\t\txfs_alloc_rsum_cache(mp, nrbmblocks);\n\n\t \n\tnmp = kmem_alloc(sizeof(*nmp), 0);\n\t \n\tfor (bmbno = sbp->sb_rbmblocks -\n\t\t     ((sbp->sb_rextents & ((1 << mp->m_blkbit_log) - 1)) != 0);\n\t     bmbno < nrbmblocks;\n\t     bmbno++) {\n\t\tstruct xfs_trans\t*tp;\n\t\txfs_rfsblock_t\t\tnrblocks_step;\n\n\t\t*nmp = *mp;\n\t\tnsbp = &nmp->m_sb;\n\t\t \n\t\tnsbp->sb_rextsize = in->extsize;\n\t\tnsbp->sb_rbmblocks = bmbno + 1;\n\t\tnrblocks_step = (bmbno + 1) * NBBY * nsbp->sb_blocksize *\n\t\t\t\tnsbp->sb_rextsize;\n\t\tnsbp->sb_rblocks = min(nrblocks, nrblocks_step);\n\t\tnsbp->sb_rextents = nsbp->sb_rblocks;\n\t\tdo_div(nsbp->sb_rextents, nsbp->sb_rextsize);\n\t\tASSERT(nsbp->sb_rextents != 0);\n\t\tnsbp->sb_rextslog = xfs_highbit32(nsbp->sb_rextents);\n\t\tnrsumlevels = nmp->m_rsumlevels = nsbp->sb_rextslog + 1;\n\t\tnrsumsize =\n\t\t\t(uint)sizeof(xfs_suminfo_t) * nrsumlevels *\n\t\t\tnsbp->sb_rbmblocks;\n\t\tnrsumblocks = XFS_B_TO_FSB(mp, nrsumsize);\n\t\tnmp->m_rsumsize = nrsumsize = XFS_FSB_TO_B(mp, nrsumblocks);\n\t\t \n\t\terror = xfs_trans_alloc(mp, &M_RES(mp)->tr_growrtfree, 0, 0, 0,\n\t\t\t\t&tp);\n\t\tif (error)\n\t\t\tbreak;\n\t\t \n\t\txfs_ilock(mp->m_rbmip, XFS_ILOCK_EXCL | XFS_ILOCK_RTBITMAP);\n\t\txfs_trans_ijoin(tp, mp->m_rbmip, XFS_ILOCK_EXCL);\n\t\t \n\t\tmp->m_rbmip->i_disk_size =\n\t\t\tnsbp->sb_rbmblocks * nsbp->sb_blocksize;\n\t\ti_size_write(VFS_I(mp->m_rbmip), mp->m_rbmip->i_disk_size);\n\t\txfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\n\t\t \n\t\txfs_ilock(mp->m_rsumip, XFS_ILOCK_EXCL | XFS_ILOCK_RTSUM);\n\t\txfs_trans_ijoin(tp, mp->m_rsumip, XFS_ILOCK_EXCL);\n\t\t \n\t\tmp->m_rsumip->i_disk_size = nmp->m_rsumsize;\n\t\ti_size_write(VFS_I(mp->m_rsumip), mp->m_rsumip->i_disk_size);\n\t\txfs_trans_log_inode(tp, mp->m_rsumip, XFS_ILOG_CORE);\n\t\t \n\t\tif (sbp->sb_rbmblocks != nsbp->sb_rbmblocks ||\n\t\t    mp->m_rsumlevels != nmp->m_rsumlevels) {\n\t\t\terror = xfs_rtcopy_summary(mp, nmp, tp);\n\t\t\tif (error)\n\t\t\t\tgoto error_cancel;\n\t\t}\n\t\t \n\t\tif (nsbp->sb_rextsize != sbp->sb_rextsize)\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_REXTSIZE,\n\t\t\t\tnsbp->sb_rextsize - sbp->sb_rextsize);\n\t\tif (nsbp->sb_rbmblocks != sbp->sb_rbmblocks)\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_RBMBLOCKS,\n\t\t\t\tnsbp->sb_rbmblocks - sbp->sb_rbmblocks);\n\t\tif (nsbp->sb_rblocks != sbp->sb_rblocks)\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_RBLOCKS,\n\t\t\t\tnsbp->sb_rblocks - sbp->sb_rblocks);\n\t\tif (nsbp->sb_rextents != sbp->sb_rextents)\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_REXTENTS,\n\t\t\t\tnsbp->sb_rextents - sbp->sb_rextents);\n\t\tif (nsbp->sb_rextslog != sbp->sb_rextslog)\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_REXTSLOG,\n\t\t\t\tnsbp->sb_rextslog - sbp->sb_rextslog);\n\t\t \n\t\tbp = NULL;\n\t\terror = xfs_rtfree_range(nmp, tp, sbp->sb_rextents,\n\t\t\tnsbp->sb_rextents - sbp->sb_rextents, &bp, &sumbno);\n\t\tif (error) {\nerror_cancel:\n\t\t\txfs_trans_cancel(tp);\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS,\n\t\t\tnsbp->sb_rextents - sbp->sb_rextents);\n\t\t \n\t\tmp->m_rsumlevels = nrsumlevels;\n\t\tmp->m_rsumsize = nrsumsize;\n\n\t\terror = xfs_trans_commit(tp);\n\t\tif (error)\n\t\t\tbreak;\n\n\t\t \n\t\tmp->m_features |= XFS_FEAT_REALTIME;\n\t}\n\tif (error)\n\t\tgoto out_free;\n\n\t \n\terror = xfs_update_secondary_sbs(mp);\n\nout_free:\n\t \n\tkmem_free(nmp);\n\n\t \n\tif (rsum_cache != mp->m_rsum_cache) {\n\t\tif (error) {\n\t\t\tkmem_free(mp->m_rsum_cache);\n\t\t\tmp->m_rsum_cache = rsum_cache;\n\t\t} else {\n\t\t\tkmem_free(rsum_cache);\n\t\t}\n\t}\n\n\treturn error;\n}\n\n \nint\t\t\t\t\t \nxfs_rtallocate_extent(\n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tbno,\t\t \n\txfs_extlen_t\tminlen,\t\t \n\txfs_extlen_t\tmaxlen,\t\t \n\txfs_extlen_t\t*len,\t\t \n\tint\t\twasdel,\t\t \n\txfs_extlen_t\tprod,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\txfs_mount_t\t*mp = tp->t_mountp;\n\tint\t\terror;\t\t \n\txfs_rtblock_t\tr;\t\t \n\txfs_fsblock_t\tsb;\t\t \n\tstruct xfs_buf\t*sumbp;\t\t \n\n\tASSERT(xfs_isilocked(mp->m_rbmip, XFS_ILOCK_EXCL));\n\tASSERT(minlen > 0 && minlen <= maxlen);\n\n\t \n\tif (prod > 1) {\n\t\txfs_extlen_t\ti;\n\n\t\tif ((i = maxlen % prod))\n\t\t\tmaxlen -= i;\n\t\tif ((i = minlen % prod))\n\t\t\tminlen += prod - i;\n\t\tif (maxlen < minlen) {\n\t\t\t*rtblock = NULLRTBLOCK;\n\t\t\treturn 0;\n\t\t}\n\t}\n\nretry:\n\tsumbp = NULL;\n\tif (bno == 0) {\n\t\terror = xfs_rtallocate_extent_size(mp, tp, minlen, maxlen, len,\n\t\t\t\t&sumbp,\t&sb, prod, &r);\n\t} else {\n\t\terror = xfs_rtallocate_extent_near(mp, tp, bno, minlen, maxlen,\n\t\t\t\tlen, &sumbp, &sb, prod, &r);\n\t}\n\n\tif (error)\n\t\treturn error;\n\n\t \n\tif (r != NULLRTBLOCK) {\n\t\tlong\tslen = (long)*len;\n\n\t\tASSERT(*len >= minlen && *len <= maxlen);\n\t\tif (wasdel)\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_RES_FREXTENTS, -slen);\n\t\telse\n\t\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS, -slen);\n\t} else if (prod > 1) {\n\t\tprod = 1;\n\t\tgoto retry;\n\t}\n\n\t*rtblock = r;\n\treturn 0;\n}\n\n \nint\t\t\t\t \nxfs_rtmount_init(\n\tstruct xfs_mount\t*mp)\t \n{\n\tstruct xfs_buf\t\t*bp;\t \n\tstruct xfs_sb\t\t*sbp;\t \n\txfs_daddr_t\t\td;\t \n\tint\t\t\terror;\n\n\tsbp = &mp->m_sb;\n\tif (sbp->sb_rblocks == 0)\n\t\treturn 0;\n\tif (mp->m_rtdev_targp == NULL) {\n\t\txfs_warn(mp,\n\t\"Filesystem has a realtime volume, use rtdev=device option\");\n\t\treturn -ENODEV;\n\t}\n\tmp->m_rsumlevels = sbp->sb_rextslog + 1;\n\tmp->m_rsumsize =\n\t\t(uint)sizeof(xfs_suminfo_t) * mp->m_rsumlevels *\n\t\tsbp->sb_rbmblocks;\n\tmp->m_rsumsize = roundup(mp->m_rsumsize, sbp->sb_blocksize);\n\tmp->m_rbmip = mp->m_rsumip = NULL;\n\t \n\td = (xfs_daddr_t)XFS_FSB_TO_BB(mp, mp->m_sb.sb_rblocks);\n\tif (XFS_BB_TO_FSB(mp, d) != mp->m_sb.sb_rblocks) {\n\t\txfs_warn(mp, \"realtime mount -- %llu != %llu\",\n\t\t\t(unsigned long long) XFS_BB_TO_FSB(mp, d),\n\t\t\t(unsigned long long) mp->m_sb.sb_rblocks);\n\t\treturn -EFBIG;\n\t}\n\terror = xfs_buf_read_uncached(mp->m_rtdev_targp,\n\t\t\t\t\td - XFS_FSB_TO_BB(mp, 1),\n\t\t\t\t\tXFS_FSB_TO_BB(mp, 1), 0, &bp, NULL);\n\tif (error) {\n\t\txfs_warn(mp, \"realtime device size check failed\");\n\t\treturn error;\n\t}\n\txfs_buf_relse(bp);\n\treturn 0;\n}\n\nstatic int\nxfs_rtalloc_count_frextent(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_trans\t\t*tp,\n\tconst struct xfs_rtalloc_rec\t*rec,\n\tvoid\t\t\t\t*priv)\n{\n\tuint64_t\t\t\t*valp = priv;\n\n\t*valp += rec->ar_extcount;\n\treturn 0;\n}\n\n \nint\nxfs_rtalloc_reinit_frextents(\n\tstruct xfs_mount\t*mp)\n{\n\tuint64_t\t\tval = 0;\n\tint\t\t\terror;\n\n\txfs_ilock(mp->m_rbmip, XFS_ILOCK_SHARED | XFS_ILOCK_RTBITMAP);\n\terror = xfs_rtalloc_query_all(mp, NULL, xfs_rtalloc_count_frextent,\n\t\t\t&val);\n\txfs_iunlock(mp->m_rbmip, XFS_ILOCK_SHARED | XFS_ILOCK_RTBITMAP);\n\tif (error)\n\t\treturn error;\n\n\tspin_lock(&mp->m_sb_lock);\n\tmp->m_sb.sb_frextents = val;\n\tspin_unlock(&mp->m_sb_lock);\n\tpercpu_counter_set(&mp->m_frextents, mp->m_sb.sb_frextents);\n\treturn 0;\n}\n\n \nstatic inline int\nxfs_rtmount_iread_extents(\n\tstruct xfs_inode\t*ip,\n\tunsigned int\t\tlock_class)\n{\n\tstruct xfs_trans\t*tp;\n\tint\t\t\terror;\n\n\terror = xfs_trans_alloc_empty(ip->i_mount, &tp);\n\tif (error)\n\t\treturn error;\n\n\txfs_ilock(ip, XFS_ILOCK_EXCL | lock_class);\n\n\terror = xfs_iread_extents(tp, ip, XFS_DATA_FORK);\n\tif (error)\n\t\tgoto out_unlock;\n\n\tif (xfs_inode_has_attr_fork(ip)) {\n\t\terror = xfs_iread_extents(tp, ip, XFS_ATTR_FORK);\n\t\tif (error)\n\t\t\tgoto out_unlock;\n\t}\n\nout_unlock:\n\txfs_iunlock(ip, XFS_ILOCK_EXCL | lock_class);\n\txfs_trans_cancel(tp);\n\treturn error;\n}\n\n \nint\t\t\t\t\t \nxfs_rtmount_inodes(\n\txfs_mount_t\t*mp)\t\t \n{\n\tint\t\terror;\t\t \n\txfs_sb_t\t*sbp;\n\n\tsbp = &mp->m_sb;\n\terror = xfs_iget(mp, NULL, sbp->sb_rbmino, 0, 0, &mp->m_rbmip);\n\tif (error)\n\t\treturn error;\n\tASSERT(mp->m_rbmip != NULL);\n\n\terror = xfs_rtmount_iread_extents(mp->m_rbmip, XFS_ILOCK_RTBITMAP);\n\tif (error)\n\t\tgoto out_rele_bitmap;\n\n\terror = xfs_iget(mp, NULL, sbp->sb_rsumino, 0, 0, &mp->m_rsumip);\n\tif (error)\n\t\tgoto out_rele_bitmap;\n\tASSERT(mp->m_rsumip != NULL);\n\n\terror = xfs_rtmount_iread_extents(mp->m_rsumip, XFS_ILOCK_RTSUM);\n\tif (error)\n\t\tgoto out_rele_summary;\n\n\txfs_alloc_rsum_cache(mp, sbp->sb_rbmblocks);\n\treturn 0;\n\nout_rele_summary:\n\txfs_irele(mp->m_rsumip);\nout_rele_bitmap:\n\txfs_irele(mp->m_rbmip);\n\treturn error;\n}\n\nvoid\nxfs_rtunmount_inodes(\n\tstruct xfs_mount\t*mp)\n{\n\tkmem_free(mp->m_rsum_cache);\n\tif (mp->m_rbmip)\n\t\txfs_irele(mp->m_rbmip);\n\tif (mp->m_rsumip)\n\t\txfs_irele(mp->m_rsumip);\n}\n\n \nint\t\t\t\t\t \nxfs_rtpick_extent(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_extlen_t\tlen,\t\t \n\txfs_rtblock_t\t*pick)\t\t \n{\n\txfs_rtblock_t\tb;\t\t \n\tint\t\tlog2;\t\t \n\tuint64_t\tresid;\t\t \n\tuint64_t\tseq;\t\t \n\tuint64_t\t*seqp;\t\t \n\n\tASSERT(xfs_isilocked(mp->m_rbmip, XFS_ILOCK_EXCL));\n\n\tseqp = (uint64_t *)&VFS_I(mp->m_rbmip)->i_atime;\n\tif (!(mp->m_rbmip->i_diflags & XFS_DIFLAG_NEWRTBM)) {\n\t\tmp->m_rbmip->i_diflags |= XFS_DIFLAG_NEWRTBM;\n\t\t*seqp = 0;\n\t}\n\tseq = *seqp;\n\tif ((log2 = xfs_highbit64(seq)) == -1)\n\t\tb = 0;\n\telse {\n\t\tresid = seq - (1ULL << log2);\n\t\tb = (mp->m_sb.sb_rextents * ((resid << 1) + 1ULL)) >>\n\t\t    (log2 + 1);\n\t\tif (b >= mp->m_sb.sb_rextents)\n\t\t\tdiv64_u64_rem(b, mp->m_sb.sb_rextents, &b);\n\t\tif (b + len > mp->m_sb.sb_rextents)\n\t\t\tb = mp->m_sb.sb_rextents - len;\n\t}\n\t*seqp = seq + 1;\n\txfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\n\t*pick = b;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}