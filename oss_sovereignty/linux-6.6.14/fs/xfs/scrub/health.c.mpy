{
  "module_name": "health.c",
  "hash_id": "7436a441cb745c47084eaf3f1ac3e5c89462bac995d22b86e1312c0a43d43d08",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/health.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_ag.h\"\n#include \"xfs_health.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/health.h\"\n\n \n\n \n\nenum xchk_health_group {\n\tXHG_FS = 1,\n\tXHG_RT,\n\tXHG_AG,\n\tXHG_INO,\n};\n\nstruct xchk_health_map {\n\tenum xchk_health_group\tgroup;\n\tunsigned int\t\tsick_mask;\n};\n\nstatic const struct xchk_health_map type_to_health_flag[XFS_SCRUB_TYPE_NR] = {\n\t[XFS_SCRUB_TYPE_SB]\t\t= { XHG_AG,  XFS_SICK_AG_SB },\n\t[XFS_SCRUB_TYPE_AGF]\t\t= { XHG_AG,  XFS_SICK_AG_AGF },\n\t[XFS_SCRUB_TYPE_AGFL]\t\t= { XHG_AG,  XFS_SICK_AG_AGFL },\n\t[XFS_SCRUB_TYPE_AGI]\t\t= { XHG_AG,  XFS_SICK_AG_AGI },\n\t[XFS_SCRUB_TYPE_BNOBT]\t\t= { XHG_AG,  XFS_SICK_AG_BNOBT },\n\t[XFS_SCRUB_TYPE_CNTBT]\t\t= { XHG_AG,  XFS_SICK_AG_CNTBT },\n\t[XFS_SCRUB_TYPE_INOBT]\t\t= { XHG_AG,  XFS_SICK_AG_INOBT },\n\t[XFS_SCRUB_TYPE_FINOBT]\t\t= { XHG_AG,  XFS_SICK_AG_FINOBT },\n\t[XFS_SCRUB_TYPE_RMAPBT]\t\t= { XHG_AG,  XFS_SICK_AG_RMAPBT },\n\t[XFS_SCRUB_TYPE_REFCNTBT]\t= { XHG_AG,  XFS_SICK_AG_REFCNTBT },\n\t[XFS_SCRUB_TYPE_INODE]\t\t= { XHG_INO, XFS_SICK_INO_CORE },\n\t[XFS_SCRUB_TYPE_BMBTD]\t\t= { XHG_INO, XFS_SICK_INO_BMBTD },\n\t[XFS_SCRUB_TYPE_BMBTA]\t\t= { XHG_INO, XFS_SICK_INO_BMBTA },\n\t[XFS_SCRUB_TYPE_BMBTC]\t\t= { XHG_INO, XFS_SICK_INO_BMBTC },\n\t[XFS_SCRUB_TYPE_DIR]\t\t= { XHG_INO, XFS_SICK_INO_DIR },\n\t[XFS_SCRUB_TYPE_XATTR]\t\t= { XHG_INO, XFS_SICK_INO_XATTR },\n\t[XFS_SCRUB_TYPE_SYMLINK]\t= { XHG_INO, XFS_SICK_INO_SYMLINK },\n\t[XFS_SCRUB_TYPE_PARENT]\t\t= { XHG_INO, XFS_SICK_INO_PARENT },\n\t[XFS_SCRUB_TYPE_RTBITMAP]\t= { XHG_RT,  XFS_SICK_RT_BITMAP },\n\t[XFS_SCRUB_TYPE_RTSUM]\t\t= { XHG_RT,  XFS_SICK_RT_SUMMARY },\n\t[XFS_SCRUB_TYPE_UQUOTA]\t\t= { XHG_FS,  XFS_SICK_FS_UQUOTA },\n\t[XFS_SCRUB_TYPE_GQUOTA]\t\t= { XHG_FS,  XFS_SICK_FS_GQUOTA },\n\t[XFS_SCRUB_TYPE_PQUOTA]\t\t= { XHG_FS,  XFS_SICK_FS_PQUOTA },\n\t[XFS_SCRUB_TYPE_FSCOUNTERS]\t= { XHG_FS,  XFS_SICK_FS_COUNTERS },\n};\n\n \nunsigned int\nxchk_health_mask_for_scrub_type(\n\t__u32\t\t\tscrub_type)\n{\n\treturn type_to_health_flag[scrub_type].sick_mask;\n}\n\n \nvoid\nxchk_update_health(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_perag\t*pag;\n\tbool\t\t\tbad;\n\n\tif (!sc->sick_mask)\n\t\treturn;\n\n\tbad = (sc->sm->sm_flags & (XFS_SCRUB_OFLAG_CORRUPT |\n\t\t\t\t   XFS_SCRUB_OFLAG_XCORRUPT));\n\tswitch (type_to_health_flag[sc->sm->sm_type].group) {\n\tcase XHG_AG:\n\t\tpag = xfs_perag_get(sc->mp, sc->sm->sm_agno);\n\t\tif (bad)\n\t\t\txfs_ag_mark_sick(pag, sc->sick_mask);\n\t\telse\n\t\t\txfs_ag_mark_healthy(pag, sc->sick_mask);\n\t\txfs_perag_put(pag);\n\t\tbreak;\n\tcase XHG_INO:\n\t\tif (!sc->ip)\n\t\t\treturn;\n\t\tif (bad)\n\t\t\txfs_inode_mark_sick(sc->ip, sc->sick_mask);\n\t\telse\n\t\t\txfs_inode_mark_healthy(sc->ip, sc->sick_mask);\n\t\tbreak;\n\tcase XHG_FS:\n\t\tif (bad)\n\t\t\txfs_fs_mark_sick(sc->mp, sc->sick_mask);\n\t\telse\n\t\t\txfs_fs_mark_healthy(sc->mp, sc->sick_mask);\n\t\tbreak;\n\tcase XHG_RT:\n\t\tif (bad)\n\t\t\txfs_rt_mark_sick(sc->mp, sc->sick_mask);\n\t\telse\n\t\t\txfs_rt_mark_healthy(sc->mp, sc->sick_mask);\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\tbreak;\n\t}\n}\n\n \nbool\nxchk_ag_btree_healthy_enough(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_perag\t*pag,\n\txfs_btnum_t\t\tbtnum)\n{\n\tunsigned int\t\tmask = 0;\n\n\t \n\tswitch (btnum) {\n\tcase XFS_BTNUM_BNO:\n\t\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_BNOBT)\n\t\t\treturn true;\n\t\tmask = XFS_SICK_AG_BNOBT;\n\t\tbreak;\n\tcase XFS_BTNUM_CNT:\n\t\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_CNTBT)\n\t\t\treturn true;\n\t\tmask = XFS_SICK_AG_CNTBT;\n\t\tbreak;\n\tcase XFS_BTNUM_INO:\n\t\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_INOBT)\n\t\t\treturn true;\n\t\tmask = XFS_SICK_AG_INOBT;\n\t\tbreak;\n\tcase XFS_BTNUM_FINO:\n\t\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_FINOBT)\n\t\t\treturn true;\n\t\tmask = XFS_SICK_AG_FINOBT;\n\t\tbreak;\n\tcase XFS_BTNUM_RMAP:\n\t\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_RMAPBT)\n\t\t\treturn true;\n\t\tmask = XFS_SICK_AG_RMAPBT;\n\t\tbreak;\n\tcase XFS_BTNUM_REFC:\n\t\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_REFCNTBT)\n\t\t\treturn true;\n\t\tmask = XFS_SICK_AG_REFCNTBT;\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\treturn true;\n\t}\n\n\t \n\tif ((sc->flags & XREP_ALREADY_FIXED) &&\n\t    type_to_health_flag[sc->sm->sm_type].group == XHG_AG)\n\t\tmask &= ~sc->sick_mask;\n\n\tif (xfs_ag_has_sickness(pag, mask)) {\n\t\tsc->sm->sm_flags |= XFS_SCRUB_OFLAG_XFAIL;\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}