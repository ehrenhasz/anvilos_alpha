{
  "module_name": "readdir.c",
  "hash_id": "8fcecfd635b404cffd8c9ff91a19ac543b8389d0110fcee0cdfc95588cca5fd3",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/readdir.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_dir2.h\"\n#include \"xfs_dir2_priv.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_error.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/readdir.h\"\n\n \nSTATIC int\nxchk_dir_walk_sf(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_inode\t*dp,\n\txchk_dirent_fn\t\tdirent_fn,\n\tvoid\t\t\t*priv)\n{\n\tstruct xfs_name\t\tname = {\n\t\t.name\t\t= \".\",\n\t\t.len\t\t= 1,\n\t\t.type\t\t= XFS_DIR3_FT_DIR,\n\t};\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tstruct xfs_da_geometry\t*geo = mp->m_dir_geo;\n\tstruct xfs_dir2_sf_entry *sfep;\n\tstruct xfs_dir2_sf_hdr\t*sfp;\n\txfs_ino_t\t\tino;\n\txfs_dir2_dataptr_t\tdapos;\n\tunsigned int\t\ti;\n\tint\t\t\terror;\n\n\tASSERT(dp->i_df.if_bytes == dp->i_disk_size);\n\tASSERT(dp->i_df.if_u1.if_data != NULL);\n\n\tsfp = (struct xfs_dir2_sf_hdr *)dp->i_df.if_u1.if_data;\n\n\t \n\tdapos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\n\t\t\tgeo->data_entry_offset);\n\n\terror = dirent_fn(sc, dp, dapos, &name, dp->i_ino, priv);\n\tif (error)\n\t\treturn error;\n\n\t \n\tdapos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\n\t\t\tgeo->data_entry_offset +\n\t\t\txfs_dir2_data_entsize(mp, sizeof(\".\") - 1));\n\tino = xfs_dir2_sf_get_parent_ino(sfp);\n\tname.name = \"..\";\n\tname.len = 2;\n\n\terror = dirent_fn(sc, dp, dapos, &name, ino, priv);\n\tif (error)\n\t\treturn error;\n\n\t \n\tsfep = xfs_dir2_sf_firstentry(sfp);\n\tfor (i = 0; i < sfp->count; i++) {\n\t\tdapos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\n\t\t\t\txfs_dir2_sf_get_offset(sfep));\n\t\tino = xfs_dir2_sf_get_ino(mp, sfp, sfep);\n\t\tname.name = sfep->name;\n\t\tname.len = sfep->namelen;\n\t\tname.type = xfs_dir2_sf_get_ftype(mp, sfep);\n\n\t\terror = dirent_fn(sc, dp, dapos, &name, ino, priv);\n\t\tif (error)\n\t\t\treturn error;\n\n\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t}\n\n\treturn 0;\n}\n\n \nSTATIC int\nxchk_dir_walk_block(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_inode\t*dp,\n\txchk_dirent_fn\t\tdirent_fn,\n\tvoid\t\t\t*priv)\n{\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tstruct xfs_da_geometry\t*geo = mp->m_dir_geo;\n\tstruct xfs_buf\t\t*bp;\n\tunsigned int\t\toff, next_off, end;\n\tint\t\t\terror;\n\n\terror = xfs_dir3_block_read(sc->tp, dp, &bp);\n\tif (error)\n\t\treturn error;\n\n\t \n\tend = xfs_dir3_data_end_offset(geo, bp->b_addr);\n\tfor (off = geo->data_entry_offset; off < end; off = next_off) {\n\t\tstruct xfs_name\t\t\tname = { };\n\t\tstruct xfs_dir2_data_unused\t*dup = bp->b_addr + off;\n\t\tstruct xfs_dir2_data_entry\t*dep = bp->b_addr + off;\n\t\txfs_ino_t\t\t\tino;\n\t\txfs_dir2_dataptr_t\t\tdapos;\n\n\t\t \n\t\tif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t\tnext_off = off + be16_to_cpu(dup->length);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tnext_off = off + xfs_dir2_data_entsize(mp, dep->namelen);\n\t\tif (next_off > end)\n\t\t\tbreak;\n\n\t\tdapos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk, off);\n\t\tino = be64_to_cpu(dep->inumber);\n\t\tname.name = dep->name;\n\t\tname.len = dep->namelen;\n\t\tname.type = xfs_dir2_data_get_ftype(mp, dep);\n\n\t\terror = dirent_fn(sc, dp, dapos, &name, ino, priv);\n\t\tif (error)\n\t\t\tbreak;\n\t}\n\n\txfs_trans_brelse(sc->tp, bp);\n\treturn error;\n}\n\n \nSTATIC int\nxchk_read_leaf_dir_buf(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*dp,\n\tstruct xfs_da_geometry\t*geo,\n\txfs_dir2_off_t\t\t*curoff,\n\tstruct xfs_buf\t\t**bpp)\n{\n\tstruct xfs_iext_cursor\ticur;\n\tstruct xfs_bmbt_irec\tmap;\n\tstruct xfs_ifork\t*ifp = xfs_ifork_ptr(dp, XFS_DATA_FORK);\n\txfs_dablk_t\t\tlast_da;\n\txfs_dablk_t\t\tmap_off;\n\txfs_dir2_off_t\t\tnew_off;\n\n\t*bpp = NULL;\n\n\t \n\tlast_da = xfs_dir2_byte_to_da(geo, XFS_DIR2_LEAF_OFFSET);\n\tmap_off = xfs_dir2_db_to_da(geo, xfs_dir2_byte_to_db(geo, *curoff));\n\n\tif (!xfs_iext_lookup_extent(dp, ifp, map_off, &icur, &map))\n\t\treturn 0;\n\tif (map.br_startoff >= last_da)\n\t\treturn 0;\n\txfs_trim_extent(&map, map_off, last_da - map_off);\n\n\t \n\tnew_off = xfs_dir2_da_to_byte(geo, map.br_startoff);\n\tif (new_off > *curoff)\n\t\t*curoff = new_off;\n\n\treturn xfs_dir3_data_read(tp, dp, map.br_startoff, 0, bpp);\n}\n\n \nSTATIC int\nxchk_dir_walk_leaf(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_inode\t*dp,\n\txchk_dirent_fn\t\tdirent_fn,\n\tvoid\t\t\t*priv)\n{\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tstruct xfs_da_geometry\t*geo = mp->m_dir_geo;\n\tstruct xfs_buf\t\t*bp = NULL;\n\txfs_dir2_off_t\t\tcuroff = 0;\n\tunsigned int\t\toffset = 0;\n\tint\t\t\terror;\n\n\t \n\twhile (curoff < XFS_DIR2_LEAF_OFFSET) {\n\t\tstruct xfs_name\t\t\tname = { };\n\t\tstruct xfs_dir2_data_unused\t*dup;\n\t\tstruct xfs_dir2_data_entry\t*dep;\n\t\txfs_ino_t\t\t\tino;\n\t\tunsigned int\t\t\tlength;\n\t\txfs_dir2_dataptr_t\t\tdapos;\n\n\t\t \n\t\tif (!bp || offset >= geo->blksize) {\n\t\t\tif (bp) {\n\t\t\t\txfs_trans_brelse(sc->tp, bp);\n\t\t\t\tbp = NULL;\n\t\t\t}\n\n\t\t\terror = xchk_read_leaf_dir_buf(sc->tp, dp, geo, &curoff,\n\t\t\t\t\t&bp);\n\t\t\tif (error || !bp)\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\toffset = geo->data_entry_offset;\n\t\t\tcuroff += geo->data_entry_offset;\n\t\t}\n\n\t\t \n\t\tdup = bp->b_addr + offset;\n\t\tif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t\tlength = be16_to_cpu(dup->length);\n\t\t\toffset += length;\n\t\t\tcuroff += length;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tdep = bp->b_addr + offset;\n\t\tlength = xfs_dir2_data_entsize(mp, dep->namelen);\n\n\t\tdapos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\n\t\tino = be64_to_cpu(dep->inumber);\n\t\tname.name = dep->name;\n\t\tname.len = dep->namelen;\n\t\tname.type = xfs_dir2_data_get_ftype(mp, dep);\n\n\t\terror = dirent_fn(sc, dp, dapos, &name, ino, priv);\n\t\tif (error)\n\t\t\tbreak;\n\n\t\t \n\t\toffset += length;\n\t\tcuroff += length;\n\t}\n\n\tif (bp)\n\t\txfs_trans_brelse(sc->tp, bp);\n\treturn error;\n}\n\n \nint\nxchk_dir_walk(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_inode\t*dp,\n\txchk_dirent_fn\t\tdirent_fn,\n\tvoid\t\t\t*priv)\n{\n\tstruct xfs_da_args\targs = {\n\t\t.dp\t\t= dp,\n\t\t.geo\t\t= dp->i_mount->m_dir_geo,\n\t\t.trans\t\t= sc->tp,\n\t};\n\tbool\t\t\tisblock;\n\tint\t\t\terror;\n\n\tif (xfs_is_shutdown(dp->i_mount))\n\t\treturn -EIO;\n\n\tASSERT(S_ISDIR(VFS_I(dp)->i_mode));\n\tASSERT(xfs_isilocked(dp, XFS_ILOCK_SHARED | XFS_ILOCK_EXCL));\n\n\tif (dp->i_df.if_format == XFS_DINODE_FMT_LOCAL)\n\t\treturn xchk_dir_walk_sf(sc, dp, dirent_fn, priv);\n\n\t \n\terror = xfs_iread_extents(sc->tp, dp, XFS_DATA_FORK);\n\tif (error)\n\t\treturn error;\n\n\terror = xfs_dir2_isblock(&args, &isblock);\n\tif (error)\n\t\treturn error;\n\n\tif (isblock)\n\t\treturn xchk_dir_walk_block(sc, dp, dirent_fn, priv);\n\n\treturn xchk_dir_walk_leaf(sc, dp, dirent_fn, priv);\n}\n\n \nint\nxchk_dir_lookup(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_inode\t*dp,\n\tconst struct xfs_name\t*name,\n\txfs_ino_t\t\t*ino)\n{\n\tstruct xfs_da_args\targs = {\n\t\t.dp\t\t= dp,\n\t\t.geo\t\t= dp->i_mount->m_dir_geo,\n\t\t.trans\t\t= sc->tp,\n\t\t.name\t\t= name->name,\n\t\t.namelen\t= name->len,\n\t\t.filetype\t= name->type,\n\t\t.hashval\t= xfs_dir2_hashname(dp->i_mount, name),\n\t\t.whichfork\t= XFS_DATA_FORK,\n\t\t.op_flags\t= XFS_DA_OP_OKNOENT,\n\t};\n\tbool\t\t\tisblock, isleaf;\n\tint\t\t\terror;\n\n\tif (xfs_is_shutdown(dp->i_mount))\n\t\treturn -EIO;\n\n\tASSERT(S_ISDIR(VFS_I(dp)->i_mode));\n\tASSERT(xfs_isilocked(dp, XFS_ILOCK_SHARED | XFS_ILOCK_EXCL));\n\n\tif (dp->i_df.if_format == XFS_DINODE_FMT_LOCAL) {\n\t\terror = xfs_dir2_sf_lookup(&args);\n\t\tgoto out_check_rval;\n\t}\n\n\t \n\terror = xfs_iread_extents(sc->tp, dp, XFS_DATA_FORK);\n\tif (error)\n\t\treturn error;\n\n\terror = xfs_dir2_isblock(&args, &isblock);\n\tif (error)\n\t\treturn error;\n\n\tif (isblock) {\n\t\terror = xfs_dir2_block_lookup(&args);\n\t\tgoto out_check_rval;\n\t}\n\n\terror = xfs_dir2_isleaf(&args, &isleaf);\n\tif (error)\n\t\treturn error;\n\n\tif (isleaf) {\n\t\terror = xfs_dir2_leaf_lookup(&args);\n\t\tgoto out_check_rval;\n\t}\n\n\terror = xfs_dir2_node_lookup(&args);\n\nout_check_rval:\n\tif (error == -EEXIST)\n\t\terror = 0;\n\tif (!error)\n\t\t*ino = args.inumber;\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}