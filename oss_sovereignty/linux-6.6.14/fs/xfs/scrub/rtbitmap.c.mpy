{
  "module_name": "rtbitmap.c",
  "hash_id": "64abfbc31f23015e3efc1b6ecb61debb68e90fdedf68f8a90e13c2415a6cc297",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/rtbitmap.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_rtalloc.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_bmap.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/common.h\"\n\n \nint\nxchk_setup_rtbitmap(\n\tstruct xfs_scrub\t*sc)\n{\n\tint\t\t\terror;\n\n\terror = xchk_trans_alloc(sc, 0);\n\tif (error)\n\t\treturn error;\n\n\terror = xchk_install_live_inode(sc, sc->mp->m_rbmip);\n\tif (error)\n\t\treturn error;\n\n\txchk_ilock(sc, XFS_ILOCK_EXCL | XFS_ILOCK_RTBITMAP);\n\treturn 0;\n}\n\n \n\n \nSTATIC int\nxchk_rtbitmap_rec(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tconst struct xfs_rtalloc_rec *rec,\n\tvoid\t\t\t*priv)\n{\n\tstruct xfs_scrub\t*sc = priv;\n\txfs_rtblock_t\t\tstartblock;\n\txfs_rtblock_t\t\tblockcount;\n\n\tstartblock = rec->ar_startext * mp->m_sb.sb_rextsize;\n\tblockcount = rec->ar_extcount * mp->m_sb.sb_rextsize;\n\n\tif (!xfs_verify_rtext(mp, startblock, blockcount))\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\treturn 0;\n}\n\n \nSTATIC int\nxchk_rtbitmap_check_extents(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_mount\t*mp = sc->mp;\n\tstruct xfs_bmbt_irec\tmap;\n\txfs_rtblock_t\t\toff;\n\tint\t\t\tnmap;\n\tint\t\t\terror = 0;\n\n\tfor (off = 0; off < mp->m_sb.sb_rbmblocks;) {\n\t\tif (xchk_should_terminate(sc, &error) ||\n\t\t    (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT))\n\t\t\tbreak;\n\n\t\t \n\t\tnmap = 1;\n\t\terror = xfs_bmapi_read(mp->m_rbmip, off,\n\t\t\t\tmp->m_sb.sb_rbmblocks - off, &map, &nmap,\n\t\t\t\tXFS_DATA_FORK);\n\t\tif (!xchk_fblock_process_error(sc, XFS_DATA_FORK, off, &error))\n\t\t\tbreak;\n\n\t\tif (nmap != 1 || !xfs_bmap_is_written_extent(&map)) {\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, off);\n\t\t\tbreak;\n\t\t}\n\n\t\toff += map.br_blockcount;\n\t}\n\n\treturn error;\n}\n\n \nint\nxchk_rtbitmap(\n\tstruct xfs_scrub\t*sc)\n{\n\tint\t\t\terror;\n\n\t \n\tif (sc->mp->m_rbmip->i_disk_size !=\n\t    XFS_FSB_TO_B(sc->mp, sc->mp->m_sb.sb_rbmblocks)) {\n\t\txchk_ino_set_corrupt(sc, sc->mp->m_rbmip->i_ino);\n\t\treturn 0;\n\t}\n\n\t \n\terror = xchk_metadata_inode_forks(sc);\n\tif (error || (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT))\n\t\treturn error;\n\n\terror = xchk_rtbitmap_check_extents(sc);\n\tif (error || (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT))\n\t\treturn error;\n\n\terror = xfs_rtalloc_query_all(sc->mp, sc->tp, xchk_rtbitmap_rec, sc);\n\tif (!xchk_fblock_process_error(sc, XFS_DATA_FORK, 0, &error))\n\t\tgoto out;\n\nout:\n\treturn error;\n}\n\n \nvoid\nxchk_xref_is_used_rt_space(\n\tstruct xfs_scrub\t*sc,\n\txfs_rtblock_t\t\tfsbno,\n\txfs_extlen_t\t\tlen)\n{\n\txfs_rtblock_t\t\tstartext;\n\txfs_rtblock_t\t\tendext;\n\txfs_rtblock_t\t\textcount;\n\tbool\t\t\tis_free;\n\tint\t\t\terror;\n\n\tif (xchk_skip_xref(sc->sm))\n\t\treturn;\n\n\tstartext = fsbno;\n\tendext = fsbno + len - 1;\n\tdo_div(startext, sc->mp->m_sb.sb_rextsize);\n\tdo_div(endext, sc->mp->m_sb.sb_rextsize);\n\textcount = endext - startext + 1;\n\txfs_ilock(sc->mp->m_rbmip, XFS_ILOCK_SHARED | XFS_ILOCK_RTBITMAP);\n\terror = xfs_rtalloc_extent_is_free(sc->mp, sc->tp, startext, extcount,\n\t\t\t&is_free);\n\tif (!xchk_should_check_xref(sc, &error, NULL))\n\t\tgoto out_unlock;\n\tif (is_free)\n\t\txchk_ino_xref_set_corrupt(sc, sc->mp->m_rbmip->i_ino);\nout_unlock:\n\txfs_iunlock(sc->mp->m_rbmip, XFS_ILOCK_SHARED | XFS_ILOCK_RTBITMAP);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}