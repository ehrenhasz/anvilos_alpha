{
  "module_name": "parent.c",
  "hash_id": "ce3d4c158132f124c95a0db5059a7dd81dabd1e5dc971a34c2d51aed07d0150c",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/parent.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_icache.h\"\n#include \"xfs_dir2.h\"\n#include \"xfs_dir2_priv.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/common.h\"\n#include \"scrub/readdir.h\"\n\n \nint\nxchk_setup_parent(\n\tstruct xfs_scrub\t*sc)\n{\n\treturn xchk_setup_inode_contents(sc, 0);\n}\n\n \n\n \n\nstruct xchk_parent_ctx {\n\tstruct xfs_scrub\t*sc;\n\txfs_nlink_t\t\tnlink;\n};\n\n \nSTATIC int\nxchk_parent_actor(\n\tstruct xfs_scrub\t*sc,\n\tstruct xfs_inode\t*dp,\n\txfs_dir2_dataptr_t\tdapos,\n\tconst struct xfs_name\t*name,\n\txfs_ino_t\t\tino,\n\tvoid\t\t\t*priv)\n{\n\tstruct xchk_parent_ctx\t*spc = priv;\n\tint\t\t\terror = 0;\n\n\t \n\tif (!xfs_dir2_namecheck(name->name, name->len))\n\t\terror = -EFSCORRUPTED;\n\tif (!xchk_fblock_xref_process_error(sc, XFS_DATA_FORK, 0, &error))\n\t\treturn error;\n\n\tif (sc->ip->i_ino == ino)\n\t\tspc->nlink++;\n\n\tif (xchk_should_terminate(spc->sc, &error))\n\t\treturn error;\n\n\treturn 0;\n}\n\n \nSTATIC unsigned int\nxchk_parent_ilock_dir(\n\tstruct xfs_inode\t*dp)\n{\n\tif (!xfs_ilock_nowait(dp, XFS_ILOCK_SHARED))\n\t\treturn 0;\n\n\tif (!xfs_need_iread_extents(&dp->i_df))\n\t\treturn XFS_ILOCK_SHARED;\n\n\txfs_iunlock(dp, XFS_ILOCK_SHARED);\n\n\tif (!xfs_ilock_nowait(dp, XFS_ILOCK_EXCL))\n\t\treturn 0;\n\n\treturn XFS_ILOCK_EXCL;\n}\n\n \nSTATIC int\nxchk_parent_validate(\n\tstruct xfs_scrub\t*sc,\n\txfs_ino_t\t\tparent_ino)\n{\n\tstruct xchk_parent_ctx\tspc = {\n\t\t.sc\t\t= sc,\n\t\t.nlink\t\t= 0,\n\t};\n\tstruct xfs_mount\t*mp = sc->mp;\n\tstruct xfs_inode\t*dp = NULL;\n\txfs_nlink_t\t\texpected_nlink;\n\tunsigned int\t\tlock_mode;\n\tint\t\t\terror = 0;\n\n\t \n\tif (sc->ip == mp->m_rootip) {\n\t\tif (sc->ip->i_ino != mp->m_sb.sb_rootino ||\n\t\t    sc->ip->i_ino != parent_ino)\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\t\treturn 0;\n\t}\n\n\t \n\tif (sc->ip->i_ino == parent_ino) {\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\t\treturn 0;\n\t}\n\n\t \n\texpected_nlink = VFS_I(sc->ip)->i_nlink == 0 ? 0 : 1;\n\n\t \n\terror = xchk_iget(sc, parent_ino, &dp);\n\tif (error == -EINVAL || error == -ENOENT) {\n\t\terror = -EFSCORRUPTED;\n\t\txchk_fblock_process_error(sc, XFS_DATA_FORK, 0, &error);\n\t\treturn error;\n\t}\n\tif (!xchk_fblock_xref_process_error(sc, XFS_DATA_FORK, 0, &error))\n\t\treturn error;\n\tif (dp == sc->ip || !S_ISDIR(VFS_I(dp)->i_mode)) {\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\t\tgoto out_rele;\n\t}\n\n\tlock_mode = xchk_parent_ilock_dir(dp);\n\tif (!lock_mode) {\n\t\txchk_iunlock(sc, XFS_ILOCK_EXCL);\n\t\txchk_ilock(sc, XFS_ILOCK_EXCL);\n\t\terror = -EAGAIN;\n\t\tgoto out_rele;\n\t}\n\n\t \n\terror = xchk_dir_walk(sc, dp, xchk_parent_actor, &spc);\n\tif (!xchk_fblock_xref_process_error(sc, XFS_DATA_FORK, 0, &error))\n\t\tgoto out_unlock;\n\n\t \n\tif (spc.nlink != expected_nlink)\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\nout_unlock:\n\txfs_iunlock(dp, lock_mode);\nout_rele:\n\txchk_irele(sc, dp);\n\treturn error;\n}\n\n \nint\nxchk_parent(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_mount\t*mp = sc->mp;\n\txfs_ino_t\t\tparent_ino;\n\tint\t\t\terror = 0;\n\n\t \n\tif (!S_ISDIR(VFS_I(sc->ip)->i_mode))\n\t\treturn -ENOENT;\n\n\t \n\tif (!xfs_verify_dir_ino(mp, sc->ip->i_ino)) {\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\t\treturn 0;\n\t}\n\n\tdo {\n\t\tif (xchk_should_terminate(sc, &error))\n\t\t\tbreak;\n\n\t\t \n\t\terror = xchk_dir_lookup(sc, sc->ip, &xfs_name_dotdot,\n\t\t\t\t&parent_ino);\n\t\tif (!xchk_fblock_process_error(sc, XFS_DATA_FORK, 0, &error))\n\t\t\treturn error;\n\t\tif (!xfs_verify_dir_ino(mp, parent_ino)) {\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, 0);\n\t\t\treturn 0;\n\t\t}\n\n\t\t \n\t\terror = xchk_parent_validate(sc, parent_ino);\n\t} while (error == -EAGAIN);\n\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}