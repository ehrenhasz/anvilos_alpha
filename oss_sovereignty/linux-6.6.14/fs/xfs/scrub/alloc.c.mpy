{
  "module_name": "alloc.c",
  "hash_id": "7c14d9246b1b027f5ab727b5ab6625201ca43d60156ba7ed0a27d671a29c7bfe",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/alloc.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_alloc.h\"\n#include \"xfs_rmap.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/common.h\"\n#include \"scrub/btree.h\"\n#include \"xfs_ag.h\"\n\n \nint\nxchk_setup_ag_allocbt(\n\tstruct xfs_scrub\t*sc)\n{\n\tif (xchk_need_intent_drain(sc))\n\t\txchk_fsgates_enable(sc, XCHK_FSGATES_DRAIN);\n\n\treturn xchk_setup_ag_btree(sc, false);\n}\n\n \n\nstruct xchk_alloc {\n\t \n\tstruct xfs_alloc_rec_incore\tprev;\n};\n\n \nSTATIC void\nxchk_allocbt_xref_other(\n\tstruct xfs_scrub\t*sc,\n\txfs_agblock_t\t\tagbno,\n\txfs_extlen_t\t\tlen)\n{\n\tstruct xfs_btree_cur\t**pcur;\n\txfs_agblock_t\t\tfbno;\n\txfs_extlen_t\t\tflen;\n\tint\t\t\thas_otherrec;\n\tint\t\t\terror;\n\n\tif (sc->sm->sm_type == XFS_SCRUB_TYPE_BNOBT)\n\t\tpcur = &sc->sa.cnt_cur;\n\telse\n\t\tpcur = &sc->sa.bno_cur;\n\tif (!*pcur || xchk_skip_xref(sc->sm))\n\t\treturn;\n\n\terror = xfs_alloc_lookup_le(*pcur, agbno, len, &has_otherrec);\n\tif (!xchk_should_check_xref(sc, &error, pcur))\n\t\treturn;\n\tif (!has_otherrec) {\n\t\txchk_btree_xref_set_corrupt(sc, *pcur, 0);\n\t\treturn;\n\t}\n\n\terror = xfs_alloc_get_rec(*pcur, &fbno, &flen, &has_otherrec);\n\tif (!xchk_should_check_xref(sc, &error, pcur))\n\t\treturn;\n\tif (!has_otherrec) {\n\t\txchk_btree_xref_set_corrupt(sc, *pcur, 0);\n\t\treturn;\n\t}\n\n\tif (fbno != agbno || flen != len)\n\t\txchk_btree_xref_set_corrupt(sc, *pcur, 0);\n}\n\n \nSTATIC void\nxchk_allocbt_xref(\n\tstruct xfs_scrub\t*sc,\n\tconst struct xfs_alloc_rec_incore *irec)\n{\n\txfs_agblock_t\t\tagbno = irec->ar_startblock;\n\txfs_extlen_t\t\tlen = irec->ar_blockcount;\n\n\tif (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT)\n\t\treturn;\n\n\txchk_allocbt_xref_other(sc, agbno, len);\n\txchk_xref_is_not_inode_chunk(sc, agbno, len);\n\txchk_xref_has_no_owner(sc, agbno, len);\n\txchk_xref_is_not_shared(sc, agbno, len);\n\txchk_xref_is_not_cow_staging(sc, agbno, len);\n}\n\n \nSTATIC void\nxchk_allocbt_mergeable(\n\tstruct xchk_btree\t*bs,\n\tstruct xchk_alloc\t*ca,\n\tconst struct xfs_alloc_rec_incore *irec)\n{\n\tif (bs->sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT)\n\t\treturn;\n\n\tif (ca->prev.ar_blockcount > 0 &&\n\t    ca->prev.ar_startblock + ca->prev.ar_blockcount == irec->ar_startblock &&\n\t    ca->prev.ar_blockcount + irec->ar_blockcount < (uint32_t)~0U)\n\t\txchk_btree_set_corrupt(bs->sc, bs->cur, 0);\n\n\tmemcpy(&ca->prev, irec, sizeof(*irec));\n}\n\n \nSTATIC int\nxchk_allocbt_rec(\n\tstruct xchk_btree\t\t*bs,\n\tconst union xfs_btree_rec\t*rec)\n{\n\tstruct xfs_alloc_rec_incore\tirec;\n\tstruct xchk_alloc\t*ca = bs->private;\n\n\txfs_alloc_btrec_to_irec(rec, &irec);\n\tif (xfs_alloc_check_irec(bs->cur, &irec) != NULL) {\n\t\txchk_btree_set_corrupt(bs->sc, bs->cur, 0);\n\t\treturn 0;\n\t}\n\n\txchk_allocbt_mergeable(bs, ca, &irec);\n\txchk_allocbt_xref(bs->sc, &irec);\n\n\treturn 0;\n}\n\n \nSTATIC int\nxchk_allocbt(\n\tstruct xfs_scrub\t*sc,\n\txfs_btnum_t\t\twhich)\n{\n\tstruct xchk_alloc\tca = { };\n\tstruct xfs_btree_cur\t*cur;\n\n\tcur = which == XFS_BTNUM_BNO ? sc->sa.bno_cur : sc->sa.cnt_cur;\n\treturn xchk_btree(sc, cur, xchk_allocbt_rec, &XFS_RMAP_OINFO_AG, &ca);\n}\n\nint\nxchk_bnobt(\n\tstruct xfs_scrub\t*sc)\n{\n\treturn xchk_allocbt(sc, XFS_BTNUM_BNO);\n}\n\nint\nxchk_cntbt(\n\tstruct xfs_scrub\t*sc)\n{\n\treturn xchk_allocbt(sc, XFS_BTNUM_CNT);\n}\n\n \nvoid\nxchk_xref_is_used_space(\n\tstruct xfs_scrub\t*sc,\n\txfs_agblock_t\t\tagbno,\n\txfs_extlen_t\t\tlen)\n{\n\tenum xbtree_recpacking\toutcome;\n\tint\t\t\terror;\n\n\tif (!sc->sa.bno_cur || xchk_skip_xref(sc->sm))\n\t\treturn;\n\n\terror = xfs_alloc_has_records(sc->sa.bno_cur, agbno, len, &outcome);\n\tif (!xchk_should_check_xref(sc, &error, &sc->sa.bno_cur))\n\t\treturn;\n\tif (outcome != XBTREE_RECPACKING_EMPTY)\n\t\txchk_btree_xref_set_corrupt(sc, sc->sa.bno_cur, 0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}