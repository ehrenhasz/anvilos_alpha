{
  "module_name": "rtsummary.c",
  "hash_id": "f2f541298a8f0cf78f5610033899f65fadf3b395b36fdac20d0452d3292a4872",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/rtsummary.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_rtalloc.h\"\n#include \"xfs_bit.h\"\n#include \"xfs_bmap.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/common.h\"\n#include \"scrub/trace.h\"\n#include \"scrub/xfile.h\"\n\n \n\n \nint\nxchk_setup_rtsummary(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_mount\t*mp = sc->mp;\n\tchar\t\t\t*descr;\n\tint\t\t\terror;\n\n\t \n\tdescr = xchk_xfile_descr(sc, \"realtime summary file\");\n\terror = xfile_create(descr, mp->m_rsumsize, &sc->xfile);\n\tkfree(descr);\n\tif (error)\n\t\treturn error;\n\n\terror = xchk_trans_alloc(sc, 0);\n\tif (error)\n\t\treturn error;\n\n\t \n\tsc->buf = kvmalloc(mp->m_sb.sb_blocksize, XCHK_GFP_FLAGS);\n\tif (!sc->buf)\n\t\treturn -ENOMEM;\n\n\terror = xchk_install_live_inode(sc, mp->m_rsumip);\n\tif (error)\n\t\treturn error;\n\n\t \n\txfs_ilock(mp->m_rbmip, XFS_ILOCK_SHARED | XFS_ILOCK_RTBITMAP);\n\txchk_ilock(sc, XFS_ILOCK_EXCL | XFS_ILOCK_RTSUM);\n\treturn 0;\n}\n\n \n\ntypedef unsigned int xchk_rtsumoff_t;\n\nstatic inline int\nxfsum_load(\n\tstruct xfs_scrub\t*sc,\n\txchk_rtsumoff_t\t\tsumoff,\n\txfs_suminfo_t\t\t*info)\n{\n\treturn xfile_obj_load(sc->xfile, info, sizeof(xfs_suminfo_t),\n\t\t\tsumoff << XFS_WORDLOG);\n}\n\nstatic inline int\nxfsum_store(\n\tstruct xfs_scrub\t*sc,\n\txchk_rtsumoff_t\t\tsumoff,\n\tconst xfs_suminfo_t\tinfo)\n{\n\treturn xfile_obj_store(sc->xfile, &info, sizeof(xfs_suminfo_t),\n\t\t\tsumoff << XFS_WORDLOG);\n}\n\nstatic inline int\nxfsum_copyout(\n\tstruct xfs_scrub\t*sc,\n\txchk_rtsumoff_t\t\tsumoff,\n\txfs_suminfo_t\t\t*info,\n\tunsigned int\t\tnr_words)\n{\n\treturn xfile_obj_load(sc->xfile, info, nr_words << XFS_WORDLOG,\n\t\t\tsumoff << XFS_WORDLOG);\n}\n\n \nSTATIC int\nxchk_rtsum_record_free(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_trans\t\t*tp,\n\tconst struct xfs_rtalloc_rec\t*rec,\n\tvoid\t\t\t\t*priv)\n{\n\tstruct xfs_scrub\t\t*sc = priv;\n\txfs_fileoff_t\t\t\trbmoff;\n\txfs_rtblock_t\t\t\trtbno;\n\txfs_filblks_t\t\t\trtlen;\n\txchk_rtsumoff_t\t\t\toffs;\n\tunsigned int\t\t\tlenlog;\n\txfs_suminfo_t\t\t\tv = 0;\n\tint\t\t\t\terror = 0;\n\n\tif (xchk_should_terminate(sc, &error))\n\t\treturn error;\n\n\t \n\trbmoff = XFS_BITTOBLOCK(mp, rec->ar_startext);\n\tlenlog = XFS_RTBLOCKLOG(rec->ar_extcount);\n\toffs = XFS_SUMOFFS(mp, lenlog, rbmoff);\n\n\trtbno = rec->ar_startext * mp->m_sb.sb_rextsize;\n\trtlen = rec->ar_extcount * mp->m_sb.sb_rextsize;\n\n\tif (!xfs_verify_rtext(mp, rtbno, rtlen)) {\n\t\txchk_ino_xref_set_corrupt(sc, mp->m_rbmip->i_ino);\n\t\treturn -EFSCORRUPTED;\n\t}\n\n\t \n\terror = xfsum_load(sc, offs, &v);\n\tif (error)\n\t\treturn error;\n\n\tv++;\n\ttrace_xchk_rtsum_record_free(mp, rec->ar_startext, rec->ar_extcount,\n\t\t\tlenlog, offs, v);\n\n\treturn xfsum_store(sc, offs, v);\n}\n\n \nSTATIC int\nxchk_rtsum_compute(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_mount\t*mp = sc->mp;\n\tunsigned long long\trtbmp_bytes;\n\n\t \n\trtbmp_bytes = howmany_64(mp->m_sb.sb_rextents, NBBY);\n\tif (roundup_64(rtbmp_bytes, mp->m_sb.sb_blocksize) !=\n\t\t\tmp->m_rbmip->i_disk_size)\n\t\treturn -EFSCORRUPTED;\n\n\treturn xfs_rtalloc_query_all(sc->mp, sc->tp, xchk_rtsum_record_free,\n\t\t\tsc);\n}\n\n \nSTATIC int\nxchk_rtsum_compare(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_mount\t*mp = sc->mp;\n\tstruct xfs_buf\t\t*bp;\n\tstruct xfs_bmbt_irec\tmap;\n\txfs_fileoff_t\t\toff;\n\txchk_rtsumoff_t\t\tsumoff = 0;\n\tint\t\t\tnmap;\n\n\tfor (off = 0; off < XFS_B_TO_FSB(mp, mp->m_rsumsize); off++) {\n\t\tint\t\terror = 0;\n\n\t\tif (xchk_should_terminate(sc, &error))\n\t\t\treturn error;\n\t\tif (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT)\n\t\t\treturn 0;\n\n\t\t \n\t\tnmap = 1;\n\t\terror = xfs_bmapi_read(mp->m_rsumip, off, 1, &map, &nmap,\n\t\t\t\tXFS_DATA_FORK);\n\t\tif (!xchk_fblock_process_error(sc, XFS_DATA_FORK, off, &error))\n\t\t\treturn error;\n\n\t\tif (nmap != 1 || !xfs_bmap_is_written_extent(&map)) {\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, off);\n\t\t\treturn 0;\n\t\t}\n\n\t\t \n\t\terror = xfs_rtbuf_get(mp, sc->tp, off, 1, &bp);\n\t\tif (!xchk_fblock_process_error(sc, XFS_DATA_FORK, off, &error))\n\t\t\treturn error;\n\n\t\t \n\t\terror = xfsum_copyout(sc, sumoff, sc->buf, mp->m_blockwsize);\n\t\tif (error) {\n\t\t\txfs_trans_brelse(sc->tp, bp);\n\t\t\treturn error;\n\t\t}\n\n\t\tif (memcmp(bp->b_addr, sc->buf,\n\t\t\t\t\tmp->m_blockwsize << XFS_WORDLOG) != 0)\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, off);\n\n\t\txfs_trans_brelse(sc->tp, bp);\n\t\tsumoff += mp->m_blockwsize;\n\t}\n\n\treturn 0;\n}\n\n \nint\nxchk_rtsummary(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_mount\t*mp = sc->mp;\n\tint\t\t\terror = 0;\n\n\t \n\terror = xchk_metadata_inode_forks(sc);\n\tif (error || (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT))\n\t\tgoto out_rbm;\n\n\t \n\terror = xchk_rtsum_compute(sc);\n\tif (error == -EFSCORRUPTED) {\n\t\t \n\t\txchk_ino_xref_set_corrupt(sc, mp->m_rbmip->i_ino);\n\t\terror = 0;\n\t\tgoto out_rbm;\n\t}\n\tif (error)\n\t\tgoto out_rbm;\n\n\t \n\terror = xchk_rtsum_compare(sc);\n\nout_rbm:\n\t \n\txfs_iunlock(mp->m_rbmip, XFS_ILOCK_SHARED | XFS_ILOCK_RTBITMAP);\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}