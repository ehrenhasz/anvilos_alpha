{
  "module_name": "quota.c",
  "hash_id": "4678a8aab38a155f05d0dc96fd67acb5966119afd9f82d8358d8fd4da908c5da",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/scrub/quota.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_qm.h\"\n#include \"xfs_bmap.h\"\n#include \"scrub/scrub.h\"\n#include \"scrub/common.h\"\n\n \nstatic inline xfs_dqtype_t\nxchk_quota_to_dqtype(\n\tstruct xfs_scrub\t*sc)\n{\n\tswitch (sc->sm->sm_type) {\n\tcase XFS_SCRUB_TYPE_UQUOTA:\n\t\treturn XFS_DQTYPE_USER;\n\tcase XFS_SCRUB_TYPE_GQUOTA:\n\t\treturn XFS_DQTYPE_GROUP;\n\tcase XFS_SCRUB_TYPE_PQUOTA:\n\t\treturn XFS_DQTYPE_PROJ;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\n \nint\nxchk_setup_quota(\n\tstruct xfs_scrub\t*sc)\n{\n\txfs_dqtype_t\t\tdqtype;\n\tint\t\t\terror;\n\n\tif (!XFS_IS_QUOTA_ON(sc->mp))\n\t\treturn -ENOENT;\n\n\tdqtype = xchk_quota_to_dqtype(sc);\n\tif (dqtype == 0)\n\t\treturn -EINVAL;\n\n\tif (!xfs_this_quota_on(sc->mp, dqtype))\n\t\treturn -ENOENT;\n\n\tif (xchk_need_intent_drain(sc))\n\t\txchk_fsgates_enable(sc, XCHK_FSGATES_DRAIN);\n\n\terror = xchk_setup_fs(sc);\n\tif (error)\n\t\treturn error;\n\n\terror = xchk_install_live_inode(sc, xfs_quota_inode(sc->mp, dqtype));\n\tif (error)\n\t\treturn error;\n\n\txchk_ilock(sc, XFS_ILOCK_EXCL);\n\treturn 0;\n}\n\n \n\nstruct xchk_quota_info {\n\tstruct xfs_scrub\t*sc;\n\txfs_dqid_t\t\tlast_id;\n};\n\n \nSTATIC int\nxchk_quota_item(\n\tstruct xfs_dquot\t*dq,\n\txfs_dqtype_t\t\tdqtype,\n\tvoid\t\t\t*priv)\n{\n\tstruct xchk_quota_info\t*sqi = priv;\n\tstruct xfs_scrub\t*sc = sqi->sc;\n\tstruct xfs_mount\t*mp = sc->mp;\n\tstruct xfs_quotainfo\t*qi = mp->m_quotainfo;\n\txfs_fileoff_t\t\toffset;\n\txfs_ino_t\t\tfs_icount;\n\tint\t\t\terror = 0;\n\n\tif (xchk_should_terminate(sc, &error))\n\t\treturn error;\n\n\t \n\toffset = dq->q_id / qi->qi_dqperchunk;\n\tif (dq->q_id && dq->q_id <= sqi->last_id)\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, offset);\n\n\tsqi->last_id = dq->q_id;\n\n\t \n\tif (dq->q_blk.hardlimit > mp->m_sb.sb_dblocks)\n\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK, offset);\n\tif (dq->q_blk.softlimit > dq->q_blk.hardlimit)\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, offset);\n\n\tif (dq->q_ino.hardlimit > M_IGEO(mp)->maxicount)\n\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK, offset);\n\tif (dq->q_ino.softlimit > dq->q_ino.hardlimit)\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, offset);\n\n\tif (dq->q_rtb.hardlimit > mp->m_sb.sb_rblocks)\n\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK, offset);\n\tif (dq->q_rtb.softlimit > dq->q_rtb.hardlimit)\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, offset);\n\n\t \n\tfs_icount = percpu_counter_sum(&mp->m_icount);\n\n\t \n\tif (xfs_has_reflink(mp)) {\n\t\tif (mp->m_sb.sb_dblocks < dq->q_blk.count)\n\t\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK,\n\t\t\t\t\toffset);\n\t} else {\n\t\tif (mp->m_sb.sb_dblocks < dq->q_blk.count)\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK,\n\t\t\t\t\toffset);\n\t}\n\tif (dq->q_ino.count > fs_icount || dq->q_rtb.count > mp->m_sb.sb_rblocks)\n\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK, offset);\n\n\t \n\tif (dq->q_id == 0)\n\t\tgoto out;\n\n\tif (dq->q_blk.hardlimit != 0 &&\n\t    dq->q_blk.count > dq->q_blk.hardlimit)\n\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK, offset);\n\n\tif (dq->q_ino.hardlimit != 0 &&\n\t    dq->q_ino.count > dq->q_ino.hardlimit)\n\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK, offset);\n\n\tif (dq->q_rtb.hardlimit != 0 &&\n\t    dq->q_rtb.count > dq->q_rtb.hardlimit)\n\t\txchk_fblock_set_warning(sc, XFS_DATA_FORK, offset);\n\nout:\n\tif (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT)\n\t\treturn -ECANCELED;\n\n\treturn 0;\n}\n\n \nSTATIC int\nxchk_quota_data_fork(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xfs_bmbt_irec\tirec = { 0 };\n\tstruct xfs_iext_cursor\ticur;\n\tstruct xfs_quotainfo\t*qi = sc->mp->m_quotainfo;\n\tstruct xfs_ifork\t*ifp;\n\txfs_fileoff_t\t\tmax_dqid_off;\n\tint\t\t\terror = 0;\n\n\t \n\terror = xchk_metadata_inode_forks(sc);\n\tif (error || (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT))\n\t\treturn error;\n\n\t \n\tmax_dqid_off = ((xfs_dqid_t)-1) / qi->qi_dqperchunk;\n\tifp = xfs_ifork_ptr(sc->ip, XFS_DATA_FORK);\n\tfor_each_xfs_iext(ifp, &icur, &irec) {\n\t\tif (xchk_should_terminate(sc, &error))\n\t\t\tbreak;\n\n\t\t \n\t\tif (!xfs_bmap_is_written_extent(&irec) ||\n\t\t    irec.br_startoff > max_dqid_off ||\n\t\t    irec.br_startoff + irec.br_blockcount - 1 > max_dqid_off) {\n\t\t\txchk_fblock_set_corrupt(sc, XFS_DATA_FORK,\n\t\t\t\t\tirec.br_startoff);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn error;\n}\n\n \nint\nxchk_quota(\n\tstruct xfs_scrub\t*sc)\n{\n\tstruct xchk_quota_info\tsqi;\n\tstruct xfs_mount\t*mp = sc->mp;\n\tstruct xfs_quotainfo\t*qi = mp->m_quotainfo;\n\txfs_dqtype_t\t\tdqtype;\n\tint\t\t\terror = 0;\n\n\tdqtype = xchk_quota_to_dqtype(sc);\n\n\t \n\terror = xchk_quota_data_fork(sc);\n\tif (error)\n\t\tgoto out;\n\tif (sc->sm->sm_flags & XFS_SCRUB_OFLAG_CORRUPT)\n\t\tgoto out;\n\n\t \n\txchk_iunlock(sc, sc->ilock_flags);\n\tsqi.sc = sc;\n\tsqi.last_id = 0;\n\terror = xfs_qm_dqiterate(mp, dqtype, xchk_quota_item, &sqi);\n\txchk_ilock(sc, XFS_ILOCK_EXCL);\n\tif (error == -ECANCELED)\n\t\terror = 0;\n\tif (!xchk_fblock_process_error(sc, XFS_DATA_FORK,\n\t\t\tsqi.last_id * qi->qi_dqperchunk, &error))\n\t\tgoto out;\n\nout:\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}