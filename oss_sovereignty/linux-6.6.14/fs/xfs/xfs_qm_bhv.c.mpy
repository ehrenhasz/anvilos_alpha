{
  "module_name": "xfs_qm_bhv.c",
  "hash_id": "585c95344323fa75d163f4c46f569c48fbb337ad85a5f5be2a652ac4e3f7515b",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_qm_bhv.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_qm.h\"\n\n\nSTATIC void\nxfs_fill_statvfs_from_dquot(\n\tstruct kstatfs\t\t*statp,\n\tstruct xfs_dquot\t*dqp)\n{\n\tuint64_t\t\tlimit;\n\n\tlimit = dqp->q_blk.softlimit ?\n\t\tdqp->q_blk.softlimit :\n\t\tdqp->q_blk.hardlimit;\n\tif (limit && statp->f_blocks > limit) {\n\t\tstatp->f_blocks = limit;\n\t\tstatp->f_bfree = statp->f_bavail =\n\t\t\t(statp->f_blocks > dqp->q_blk.reserved) ?\n\t\t\t (statp->f_blocks - dqp->q_blk.reserved) : 0;\n\t}\n\n\tlimit = dqp->q_ino.softlimit ?\n\t\tdqp->q_ino.softlimit :\n\t\tdqp->q_ino.hardlimit;\n\tif (limit && statp->f_files > limit) {\n\t\tstatp->f_files = limit;\n\t\tstatp->f_ffree =\n\t\t\t(statp->f_files > dqp->q_ino.reserved) ?\n\t\t\t (statp->f_files - dqp->q_ino.reserved) : 0;\n\t}\n}\n\n\n \nvoid\nxfs_qm_statvfs(\n\tstruct xfs_inode\t*ip,\n\tstruct kstatfs\t\t*statp)\n{\n\tstruct xfs_mount\t*mp = ip->i_mount;\n\tstruct xfs_dquot\t*dqp;\n\n\tif (!xfs_qm_dqget(mp, ip->i_projid, XFS_DQTYPE_PROJ, false, &dqp)) {\n\t\txfs_fill_statvfs_from_dquot(statp, dqp);\n\t\txfs_qm_dqput(dqp);\n\t}\n}\n\nint\nxfs_qm_newmount(\n\txfs_mount_t\t*mp,\n\tuint\t\t*needquotamount,\n\tuint\t\t*quotaflags)\n{\n\tuint\t\tquotaondisk;\n\tuint\t\tuquotaondisk = 0, gquotaondisk = 0, pquotaondisk = 0;\n\n\tquotaondisk = xfs_has_quota(mp) &&\n\t\t\t\t(mp->m_sb.sb_qflags & XFS_ALL_QUOTA_ACCT);\n\n\tif (quotaondisk) {\n\t\tuquotaondisk = mp->m_sb.sb_qflags & XFS_UQUOTA_ACCT;\n\t\tpquotaondisk = mp->m_sb.sb_qflags & XFS_PQUOTA_ACCT;\n\t\tgquotaondisk = mp->m_sb.sb_qflags & XFS_GQUOTA_ACCT;\n\t}\n\n\t \n\n\tif (((uquotaondisk && !XFS_IS_UQUOTA_ON(mp)) ||\n\t    (!uquotaondisk &&  XFS_IS_UQUOTA_ON(mp)) ||\n\t     (gquotaondisk && !XFS_IS_GQUOTA_ON(mp)) ||\n\t    (!gquotaondisk &&  XFS_IS_GQUOTA_ON(mp)) ||\n\t     (pquotaondisk && !XFS_IS_PQUOTA_ON(mp)) ||\n\t    (!pquotaondisk &&  XFS_IS_PQUOTA_ON(mp)))  &&\n\t    xfs_dev_is_read_only(mp, \"changing quota state\")) {\n\t\txfs_warn(mp, \"please mount with%s%s%s%s.\",\n\t\t\t(!quotaondisk ? \"out quota\" : \"\"),\n\t\t\t(uquotaondisk ? \" usrquota\" : \"\"),\n\t\t\t(gquotaondisk ? \" grpquota\" : \"\"),\n\t\t\t(pquotaondisk ? \" prjquota\" : \"\"));\n\t\treturn -EPERM;\n\t}\n\n\tif (XFS_IS_QUOTA_ON(mp) || quotaondisk) {\n\t\t \n\t\tif (quotaondisk && !XFS_QM_NEED_QUOTACHECK(mp)) {\n\t\t\t \n\t\t\txfs_qm_mount_quotas(mp);\n\t\t} else {\n\t\t\t \n\t\t\t*needquotamount = true;\n\t\t\t*quotaflags = mp->m_qflags;\n\t\t\tmp->m_qflags = 0;\n\t\t}\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}