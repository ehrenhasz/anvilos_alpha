{
  "module_name": "xfs_trans_buf.c",
  "hash_id": "d153eef080e8cd9be3cdcf3fbff05c8c8bbddf6f0d90a5259e004a360e510524",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_trans_buf.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_buf_item.h\"\n#include \"xfs_trans_priv.h\"\n#include \"xfs_trace.h\"\n\n \nSTATIC struct xfs_buf *\nxfs_trans_buf_item_match(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buftarg\t*target,\n\tstruct xfs_buf_map\t*map,\n\tint\t\t\tnmaps)\n{\n\tstruct xfs_log_item\t*lip;\n\tstruct xfs_buf_log_item\t*blip;\n\tint\t\t\tlen = 0;\n\tint\t\t\ti;\n\n\tfor (i = 0; i < nmaps; i++)\n\t\tlen += map[i].bm_len;\n\n\tlist_for_each_entry(lip, &tp->t_items, li_trans) {\n\t\tblip = (struct xfs_buf_log_item *)lip;\n\t\tif (blip->bli_item.li_type == XFS_LI_BUF &&\n\t\t    blip->bli_buf->b_target == target &&\n\t\t    xfs_buf_daddr(blip->bli_buf) == map[0].bm_bn &&\n\t\t    blip->bli_buf->b_length == len) {\n\t\t\tASSERT(blip->bli_buf->b_map_count == nmaps);\n\t\t\treturn blip->bli_buf;\n\t\t}\n\t}\n\n\treturn NULL;\n}\n\n \nSTATIC void\n_xfs_trans_bjoin(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp,\n\tint\t\t\treset_recur)\n{\n\tstruct xfs_buf_log_item\t*bip;\n\n\tASSERT(bp->b_transp == NULL);\n\n\t \n\txfs_buf_item_init(bp, tp->t_mountp);\n\tbip = bp->b_log_item;\n\tASSERT(!(bip->bli_flags & XFS_BLI_STALE));\n\tASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\n\tASSERT(!(bip->bli_flags & XFS_BLI_LOGGED));\n\tif (reset_recur)\n\t\tbip->bli_recur = 0;\n\n\t \n\tatomic_inc(&bip->bli_refcount);\n\n\t \n\txfs_trans_add_item(tp, &bip->bli_item);\n\tbp->b_transp = tp;\n\n}\n\nvoid\nxfs_trans_bjoin(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\t_xfs_trans_bjoin(tp, bp, 0);\n\ttrace_xfs_trans_bjoin(bp->b_log_item);\n}\n\n \nint\nxfs_trans_get_buf_map(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buftarg\t*target,\n\tstruct xfs_buf_map\t*map,\n\tint\t\t\tnmaps,\n\txfs_buf_flags_t\t\tflags,\n\tstruct xfs_buf\t\t**bpp)\n{\n\tstruct xfs_buf\t\t*bp;\n\tstruct xfs_buf_log_item\t*bip;\n\tint\t\t\terror;\n\n\t*bpp = NULL;\n\tif (!tp)\n\t\treturn xfs_buf_get_map(target, map, nmaps, flags, bpp);\n\n\t \n\tbp = xfs_trans_buf_item_match(tp, target, map, nmaps);\n\tif (bp != NULL) {\n\t\tASSERT(xfs_buf_islocked(bp));\n\t\tif (xfs_is_shutdown(tp->t_mountp)) {\n\t\t\txfs_buf_stale(bp);\n\t\t\tbp->b_flags |= XBF_DONE;\n\t\t}\n\n\t\tASSERT(bp->b_transp == tp);\n\t\tbip = bp->b_log_item;\n\t\tASSERT(bip != NULL);\n\t\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\t\tbip->bli_recur++;\n\t\ttrace_xfs_trans_get_buf_recur(bip);\n\t\t*bpp = bp;\n\t\treturn 0;\n\t}\n\n\terror = xfs_buf_get_map(target, map, nmaps, flags, &bp);\n\tif (error)\n\t\treturn error;\n\n\tASSERT(!bp->b_error);\n\n\t_xfs_trans_bjoin(tp, bp, 1);\n\ttrace_xfs_trans_get_buf(bp->b_log_item);\n\t*bpp = bp;\n\treturn 0;\n}\n\n \nstruct xfs_buf *\nxfs_trans_getsb(\n\tstruct xfs_trans\t*tp)\n{\n\tstruct xfs_buf\t\t*bp = tp->t_mountp->m_sb_bp;\n\n\t \n\tif (bp->b_transp == tp) {\n\t\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\t\tASSERT(bip != NULL);\n\t\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\t\tbip->bli_recur++;\n\n\t\ttrace_xfs_trans_getsb_recur(bip);\n\t} else {\n\t\txfs_buf_lock(bp);\n\t\txfs_buf_hold(bp);\n\t\t_xfs_trans_bjoin(tp, bp, 1);\n\n\t\ttrace_xfs_trans_getsb(bp->b_log_item);\n\t}\n\n\treturn bp;\n}\n\n \nint\nxfs_trans_read_buf_map(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buftarg\t*target,\n\tstruct xfs_buf_map\t*map,\n\tint\t\t\tnmaps,\n\txfs_buf_flags_t\t\tflags,\n\tstruct xfs_buf\t\t**bpp,\n\tconst struct xfs_buf_ops *ops)\n{\n\tstruct xfs_buf\t\t*bp = NULL;\n\tstruct xfs_buf_log_item\t*bip;\n\tint\t\t\terror;\n\n\t*bpp = NULL;\n\t \n\tif (tp)\n\t\tbp = xfs_trans_buf_item_match(tp, target, map, nmaps);\n\tif (bp) {\n\t\tASSERT(xfs_buf_islocked(bp));\n\t\tASSERT(bp->b_transp == tp);\n\t\tASSERT(bp->b_log_item != NULL);\n\t\tASSERT(!bp->b_error);\n\t\tASSERT(bp->b_flags & XBF_DONE);\n\n\t\t \n\t\tif (xfs_is_shutdown(mp)) {\n\t\t\ttrace_xfs_trans_read_buf_shut(bp, _RET_IP_);\n\t\t\treturn -EIO;\n\t\t}\n\n\t\t \n\t\tASSERT(bp->b_ops != NULL);\n\t\terror = xfs_buf_reverify(bp, ops);\n\t\tif (error) {\n\t\t\txfs_buf_ioerror_alert(bp, __return_address);\n\n\t\t\tif (tp->t_flags & XFS_TRANS_DIRTY)\n\t\t\t\txfs_force_shutdown(tp->t_mountp,\n\t\t\t\t\t\tSHUTDOWN_META_IO_ERROR);\n\n\t\t\t \n\t\t\tif (error == -EFSBADCRC)\n\t\t\t\terror = -EFSCORRUPTED;\n\t\t\treturn error;\n\t\t}\n\n\t\tbip = bp->b_log_item;\n\t\tbip->bli_recur++;\n\n\t\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\t\ttrace_xfs_trans_read_buf_recur(bip);\n\t\tASSERT(bp->b_ops != NULL || ops == NULL);\n\t\t*bpp = bp;\n\t\treturn 0;\n\t}\n\n\terror = xfs_buf_read_map(target, map, nmaps, flags, &bp, ops,\n\t\t\t__return_address);\n\tswitch (error) {\n\tcase 0:\n\t\tbreak;\n\tdefault:\n\t\tif (tp && (tp->t_flags & XFS_TRANS_DIRTY))\n\t\t\txfs_force_shutdown(tp->t_mountp, SHUTDOWN_META_IO_ERROR);\n\t\tfallthrough;\n\tcase -ENOMEM:\n\tcase -EAGAIN:\n\t\treturn error;\n\t}\n\n\tif (xfs_is_shutdown(mp)) {\n\t\txfs_buf_relse(bp);\n\t\ttrace_xfs_trans_read_buf_shut(bp, _RET_IP_);\n\t\treturn -EIO;\n\t}\n\n\tif (tp) {\n\t\t_xfs_trans_bjoin(tp, bp, 1);\n\t\ttrace_xfs_trans_read_buf(bp->b_log_item);\n\t}\n\tASSERT(bp->b_ops != NULL || ops == NULL);\n\t*bpp = bp;\n\treturn 0;\n\n}\n\n \nbool\nxfs_trans_buf_is_dirty(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tif (!bip)\n\t\treturn false;\n\tASSERT(bip->bli_item.li_type == XFS_LI_BUF);\n\treturn test_bit(XFS_LI_DIRTY, &bip->bli_item.li_flags);\n}\n\n \nvoid\nxfs_trans_brelse(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\n\tif (!tp) {\n\t\txfs_buf_relse(bp);\n\t\treturn;\n\t}\n\n\ttrace_xfs_trans_brelse(bip);\n\tASSERT(bip->bli_item.li_type == XFS_LI_BUF);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\t \n\tif (bip->bli_recur > 0) {\n\t\tbip->bli_recur--;\n\t\treturn;\n\t}\n\n\t \n\tif (test_bit(XFS_LI_DIRTY, &bip->bli_item.li_flags))\n\t\treturn;\n\tif (bip->bli_flags & XFS_BLI_STALE)\n\t\treturn;\n\n\t \n\tASSERT(!(bip->bli_flags & XFS_BLI_LOGGED));\n\txfs_trans_del_item(&bip->bli_item);\n\tbip->bli_flags &= ~XFS_BLI_HOLD;\n\n\t \n\txfs_buf_item_put(bip);\n\n\tbp->b_transp = NULL;\n\txfs_buf_relse(bp);\n}\n\n \n \nvoid\nxfs_trans_bhold(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(!(bip->bli_flags & XFS_BLI_STALE));\n\tASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\tbip->bli_flags |= XFS_BLI_HOLD;\n\ttrace_xfs_trans_bhold(bip);\n}\n\n \nvoid\nxfs_trans_bhold_release(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(!(bip->bli_flags & XFS_BLI_STALE));\n\tASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\tASSERT(bip->bli_flags & XFS_BLI_HOLD);\n\n\tbip->bli_flags &= ~XFS_BLI_HOLD;\n\ttrace_xfs_trans_bhold_release(bip);\n}\n\n \nvoid\nxfs_trans_dirty_buf(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\n\t \n\tbp->b_flags |= XBF_DONE;\n\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\t \n\tif (bip->bli_flags & XFS_BLI_STALE) {\n\t\tbip->bli_flags &= ~XFS_BLI_STALE;\n\t\tASSERT(bp->b_flags & XBF_STALE);\n\t\tbp->b_flags &= ~XBF_STALE;\n\t\tbip->__bli_format.blf_flags &= ~XFS_BLF_CANCEL;\n\t}\n\tbip->bli_flags |= XFS_BLI_DIRTY | XFS_BLI_LOGGED;\n\n\ttp->t_flags |= XFS_TRANS_DIRTY;\n\tset_bit(XFS_LI_DIRTY, &bip->bli_item.li_flags);\n}\n\n \nvoid\nxfs_trans_log_buf(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp,\n\tuint\t\t\tfirst,\n\tuint\t\t\tlast)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(first <= last && last < BBTOB(bp->b_length));\n\tASSERT(!(bip->bli_flags & XFS_BLI_ORDERED));\n\n\txfs_trans_dirty_buf(tp, bp);\n\n\ttrace_xfs_trans_log_buf(bip);\n\txfs_buf_item_log(bip, first, last);\n}\n\n\n \nvoid\nxfs_trans_binval(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\tint\t\t\ti;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\ttrace_xfs_trans_binval(bip);\n\n\tif (bip->bli_flags & XFS_BLI_STALE) {\n\t\t \n\t\tASSERT(bp->b_flags & XBF_STALE);\n\t\tASSERT(!(bip->bli_flags & (XFS_BLI_LOGGED | XFS_BLI_DIRTY)));\n\t\tASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_INODE_BUF));\n\t\tASSERT(!(bip->__bli_format.blf_flags & XFS_BLFT_MASK));\n\t\tASSERT(bip->__bli_format.blf_flags & XFS_BLF_CANCEL);\n\t\tASSERT(test_bit(XFS_LI_DIRTY, &bip->bli_item.li_flags));\n\t\tASSERT(tp->t_flags & XFS_TRANS_DIRTY);\n\t\treturn;\n\t}\n\n\txfs_buf_stale(bp);\n\n\tbip->bli_flags |= XFS_BLI_STALE;\n\tbip->bli_flags &= ~(XFS_BLI_INODE_BUF | XFS_BLI_LOGGED | XFS_BLI_DIRTY);\n\tbip->__bli_format.blf_flags &= ~XFS_BLF_INODE_BUF;\n\tbip->__bli_format.blf_flags |= XFS_BLF_CANCEL;\n\tbip->__bli_format.blf_flags &= ~XFS_BLFT_MASK;\n\tfor (i = 0; i < bip->bli_format_count; i++) {\n\t\tmemset(bip->bli_formats[i].blf_data_map, 0,\n\t\t       (bip->bli_formats[i].blf_map_size * sizeof(uint)));\n\t}\n\tset_bit(XFS_LI_DIRTY, &bip->bli_item.li_flags);\n\ttp->t_flags |= XFS_TRANS_DIRTY;\n}\n\n \nvoid\nxfs_trans_inode_buf(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\tbip->bli_flags |= XFS_BLI_INODE_BUF;\n\tbp->b_flags |= _XBF_INODES;\n\txfs_trans_buf_set_type(tp, bp, XFS_BLFT_DINO_BUF);\n}\n\n \nvoid\nxfs_trans_stale_inode_buf(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\tbip->bli_flags |= XFS_BLI_STALE_INODE;\n\tbp->b_flags |= _XBF_INODES;\n\txfs_trans_buf_set_type(tp, bp, XFS_BLFT_DINO_BUF);\n}\n\n \n \nvoid\nxfs_trans_inode_alloc_buf(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\tbip->bli_flags |= XFS_BLI_INODE_ALLOC_BUF;\n\tbp->b_flags |= _XBF_INODES;\n\txfs_trans_buf_set_type(tp, bp, XFS_BLFT_DINO_BUF);\n}\n\n \nbool\nxfs_trans_ordered_buf(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\tif (xfs_buf_item_dirty_format(bip))\n\t\treturn false;\n\n\tbip->bli_flags |= XFS_BLI_ORDERED;\n\ttrace_xfs_buf_item_ordered(bip);\n\n\t \n\txfs_trans_dirty_buf(tp, bp);\n\treturn true;\n}\n\n \nvoid\nxfs_trans_buf_set_type(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp,\n\tenum xfs_blft\t\ttype)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tif (!tp)\n\t\treturn;\n\n\tASSERT(bp->b_transp == tp);\n\tASSERT(bip != NULL);\n\tASSERT(atomic_read(&bip->bli_refcount) > 0);\n\n\txfs_blft_to_flags(&bip->__bli_format, type);\n}\n\nvoid\nxfs_trans_buf_copy_type(\n\tstruct xfs_buf\t\t*dst_bp,\n\tstruct xfs_buf\t\t*src_bp)\n{\n\tstruct xfs_buf_log_item\t*sbip = src_bp->b_log_item;\n\tstruct xfs_buf_log_item\t*dbip = dst_bp->b_log_item;\n\tenum xfs_blft\t\ttype;\n\n\ttype = xfs_blft_from_flags(&sbip->__bli_format);\n\txfs_blft_to_flags(&dbip->__bli_format, type);\n}\n\n \n \nvoid\nxfs_trans_dquot_buf(\n\txfs_trans_t\t\t*tp,\n\tstruct xfs_buf\t\t*bp,\n\tuint\t\t\ttype)\n{\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\n\tASSERT(type == XFS_BLF_UDQUOT_BUF ||\n\t       type == XFS_BLF_PDQUOT_BUF ||\n\t       type == XFS_BLF_GDQUOT_BUF);\n\n\tbip->__bli_format.blf_flags |= type;\n\n\tswitch (type) {\n\tcase XFS_BLF_UDQUOT_BUF:\n\t\ttype = XFS_BLFT_UDQUOT_BUF;\n\t\tbreak;\n\tcase XFS_BLF_PDQUOT_BUF:\n\t\ttype = XFS_BLFT_PDQUOT_BUF;\n\t\tbreak;\n\tcase XFS_BLF_GDQUOT_BUF:\n\t\ttype = XFS_BLFT_GDQUOT_BUF;\n\t\tbreak;\n\tdefault:\n\t\ttype = XFS_BLFT_UNKNOWN_BUF;\n\t\tbreak;\n\t}\n\n\tbp->b_flags |= _XBF_DQUOTS;\n\txfs_trans_buf_set_type(tp, bp, type);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}