{
  "module_name": "xfs_quotaops.c",
  "hash_id": "5dc81f999635cd19736c5d05baf03565c1decd27ebc01f274cf532836fe94192",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_quotaops.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_icache.h\"\n#include \"xfs_qm.h\"\n\n\nstatic void\nxfs_qm_fill_state(\n\tstruct qc_type_state\t*tstate,\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_inode\t*ip,\n\txfs_ino_t\t\tino,\n\tstruct xfs_def_quota\t*defq)\n{\n\tbool\t\t\ttempqip = false;\n\n\ttstate->ino = ino;\n\tif (!ip && ino == NULLFSINO)\n\t\treturn;\n\tif (!ip) {\n\t\tif (xfs_iget(mp, NULL, ino, 0, 0, &ip))\n\t\t\treturn;\n\t\ttempqip = true;\n\t}\n\ttstate->flags |= QCI_SYSFILE;\n\ttstate->blocks = ip->i_nblocks;\n\ttstate->nextents = ip->i_df.if_nextents;\n\ttstate->spc_timelimit = (u32)defq->blk.time;\n\ttstate->ino_timelimit = (u32)defq->ino.time;\n\ttstate->rt_spc_timelimit = (u32)defq->rtb.time;\n\ttstate->spc_warnlimit = 0;\n\ttstate->ino_warnlimit = 0;\n\ttstate->rt_spc_warnlimit = 0;\n\tif (tempqip)\n\t\txfs_irele(ip);\n}\n\n \nstatic int\nxfs_fs_get_quota_state(\n\tstruct super_block\t*sb,\n\tstruct qc_state\t\t*state)\n{\n\tstruct xfs_mount *mp = XFS_M(sb);\n\tstruct xfs_quotainfo *q = mp->m_quotainfo;\n\n\tmemset(state, 0, sizeof(*state));\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn 0;\n\tstate->s_incoredqs = q->qi_dquots;\n\tif (XFS_IS_UQUOTA_ON(mp))\n\t\tstate->s_state[USRQUOTA].flags |= QCI_ACCT_ENABLED;\n\tif (XFS_IS_UQUOTA_ENFORCED(mp))\n\t\tstate->s_state[USRQUOTA].flags |= QCI_LIMITS_ENFORCED;\n\tif (XFS_IS_GQUOTA_ON(mp))\n\t\tstate->s_state[GRPQUOTA].flags |= QCI_ACCT_ENABLED;\n\tif (XFS_IS_GQUOTA_ENFORCED(mp))\n\t\tstate->s_state[GRPQUOTA].flags |= QCI_LIMITS_ENFORCED;\n\tif (XFS_IS_PQUOTA_ON(mp))\n\t\tstate->s_state[PRJQUOTA].flags |= QCI_ACCT_ENABLED;\n\tif (XFS_IS_PQUOTA_ENFORCED(mp))\n\t\tstate->s_state[PRJQUOTA].flags |= QCI_LIMITS_ENFORCED;\n\n\txfs_qm_fill_state(&state->s_state[USRQUOTA], mp, q->qi_uquotaip,\n\t\t\t  mp->m_sb.sb_uquotino, &q->qi_usr_default);\n\txfs_qm_fill_state(&state->s_state[GRPQUOTA], mp, q->qi_gquotaip,\n\t\t\t  mp->m_sb.sb_gquotino, &q->qi_grp_default);\n\txfs_qm_fill_state(&state->s_state[PRJQUOTA], mp, q->qi_pquotaip,\n\t\t\t  mp->m_sb.sb_pquotino, &q->qi_prj_default);\n\treturn 0;\n}\n\nSTATIC xfs_dqtype_t\nxfs_quota_type(int type)\n{\n\tswitch (type) {\n\tcase USRQUOTA:\n\t\treturn XFS_DQTYPE_USER;\n\tcase GRPQUOTA:\n\t\treturn XFS_DQTYPE_GROUP;\n\tdefault:\n\t\treturn XFS_DQTYPE_PROJ;\n\t}\n}\n\n#define XFS_QC_SETINFO_MASK (QC_TIMER_MASK)\n\n \nstatic int\nxfs_fs_set_info(\n\tstruct super_block\t*sb,\n\tint\t\t\ttype,\n\tstruct qc_info\t\t*info)\n{\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\tstruct qc_dqblk\t\tnewlim;\n\n\tif (sb_rdonly(sb))\n\t\treturn -EROFS;\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn -ENOSYS;\n\tif (info->i_fieldmask & ~XFS_QC_SETINFO_MASK)\n\t\treturn -EINVAL;\n\tif ((info->i_fieldmask & XFS_QC_SETINFO_MASK) == 0)\n\t\treturn 0;\n\n\tnewlim.d_fieldmask = info->i_fieldmask;\n\tnewlim.d_spc_timer = info->i_spc_timelimit;\n\tnewlim.d_ino_timer = info->i_ino_timelimit;\n\tnewlim.d_rt_spc_timer = info->i_rt_spc_timelimit;\n\tnewlim.d_ino_warns = info->i_ino_warnlimit;\n\tnewlim.d_spc_warns = info->i_spc_warnlimit;\n\tnewlim.d_rt_spc_warns = info->i_rt_spc_warnlimit;\n\n\treturn xfs_qm_scall_setqlim(mp, 0, xfs_quota_type(type), &newlim);\n}\n\nstatic unsigned int\nxfs_quota_flags(unsigned int uflags)\n{\n\tunsigned int flags = 0;\n\n\tif (uflags & FS_QUOTA_UDQ_ACCT)\n\t\tflags |= XFS_UQUOTA_ACCT;\n\tif (uflags & FS_QUOTA_PDQ_ACCT)\n\t\tflags |= XFS_PQUOTA_ACCT;\n\tif (uflags & FS_QUOTA_GDQ_ACCT)\n\t\tflags |= XFS_GQUOTA_ACCT;\n\tif (uflags & FS_QUOTA_UDQ_ENFD)\n\t\tflags |= XFS_UQUOTA_ENFD;\n\tif (uflags & FS_QUOTA_GDQ_ENFD)\n\t\tflags |= XFS_GQUOTA_ENFD;\n\tif (uflags & FS_QUOTA_PDQ_ENFD)\n\t\tflags |= XFS_PQUOTA_ENFD;\n\n\treturn flags;\n}\n\nSTATIC int\nxfs_quota_enable(\n\tstruct super_block\t*sb,\n\tunsigned int\t\tuflags)\n{\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\n\tif (sb_rdonly(sb))\n\t\treturn -EROFS;\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn -ENOSYS;\n\n\treturn xfs_qm_scall_quotaon(mp, xfs_quota_flags(uflags));\n}\n\nSTATIC int\nxfs_quota_disable(\n\tstruct super_block\t*sb,\n\tunsigned int\t\tuflags)\n{\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\n\tif (sb_rdonly(sb))\n\t\treturn -EROFS;\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn -ENOSYS;\n\n\treturn xfs_qm_scall_quotaoff(mp, xfs_quota_flags(uflags));\n}\n\nSTATIC int\nxfs_fs_rm_xquota(\n\tstruct super_block\t*sb,\n\tunsigned int\t\tuflags)\n{\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\tunsigned int\t\tflags = 0;\n\n\tif (sb_rdonly(sb))\n\t\treturn -EROFS;\n\n\tif (XFS_IS_QUOTA_ON(mp))\n\t\treturn -EINVAL;\n\n\tif (uflags & ~(FS_USER_QUOTA | FS_GROUP_QUOTA | FS_PROJ_QUOTA))\n\t\treturn -EINVAL;\n\n\tif (uflags & FS_USER_QUOTA)\n\t\tflags |= XFS_QMOPT_UQUOTA;\n\tif (uflags & FS_GROUP_QUOTA)\n\t\tflags |= XFS_QMOPT_GQUOTA;\n\tif (uflags & FS_PROJ_QUOTA)\n\t\tflags |= XFS_QMOPT_PQUOTA;\n\n\treturn xfs_qm_scall_trunc_qfiles(mp, flags);\n}\n\nSTATIC int\nxfs_fs_get_dqblk(\n\tstruct super_block\t*sb,\n\tstruct kqid\t\tqid,\n\tstruct qc_dqblk\t\t*qdq)\n{\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\txfs_dqid_t\t\tid;\n\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn -ENOSYS;\n\n\tid = from_kqid(&init_user_ns, qid);\n\treturn xfs_qm_scall_getquota(mp, id, xfs_quota_type(qid.type), qdq);\n}\n\n \nSTATIC int\nxfs_fs_get_nextdqblk(\n\tstruct super_block\t*sb,\n\tstruct kqid\t\t*qid,\n\tstruct qc_dqblk\t\t*qdq)\n{\n\tint\t\t\tret;\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\txfs_dqid_t\t\tid;\n\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn -ENOSYS;\n\n\tid = from_kqid(&init_user_ns, *qid);\n\tret = xfs_qm_scall_getquota_next(mp, &id, xfs_quota_type(qid->type),\n\t\t\tqdq);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\t*qid = make_kqid(current_user_ns(), qid->type, id);\n\treturn 0;\n}\n\nSTATIC int\nxfs_fs_set_dqblk(\n\tstruct super_block\t*sb,\n\tstruct kqid\t\tqid,\n\tstruct qc_dqblk\t\t*qdq)\n{\n\tstruct xfs_mount\t*mp = XFS_M(sb);\n\n\tif (sb_rdonly(sb))\n\t\treturn -EROFS;\n\tif (!XFS_IS_QUOTA_ON(mp))\n\t\treturn -ENOSYS;\n\n\treturn xfs_qm_scall_setqlim(mp, from_kqid(&init_user_ns, qid),\n\t\t\t\t     xfs_quota_type(qid.type), qdq);\n}\n\nconst struct quotactl_ops xfs_quotactl_operations = {\n\t.get_state\t\t= xfs_fs_get_quota_state,\n\t.set_info\t\t= xfs_fs_set_info,\n\t.quota_enable\t\t= xfs_quota_enable,\n\t.quota_disable\t\t= xfs_quota_disable,\n\t.rm_xquota\t\t= xfs_fs_rm_xquota,\n\t.get_dqblk\t\t= xfs_fs_get_dqblk,\n\t.get_nextdqblk\t\t= xfs_fs_get_nextdqblk,\n\t.set_dqblk\t\t= xfs_fs_set_dqblk,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}