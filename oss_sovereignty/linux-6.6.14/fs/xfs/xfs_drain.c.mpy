{
  "module_name": "xfs_drain.c",
  "hash_id": "5c191c77bea468de0bbb756d6e5a08b66c2d9b8fb085db64b4a8ed87422ff048",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_drain.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_ag.h\"\n#include \"xfs_trace.h\"\n\n \nstatic DEFINE_STATIC_KEY_FALSE(xfs_drain_waiter_gate);\n\nvoid\nxfs_drain_wait_disable(void)\n{\n\tstatic_branch_dec(&xfs_drain_waiter_gate);\n}\n\nvoid\nxfs_drain_wait_enable(void)\n{\n\tstatic_branch_inc(&xfs_drain_waiter_gate);\n}\n\nvoid\nxfs_defer_drain_init(\n\tstruct xfs_defer_drain\t*dr)\n{\n\tatomic_set(&dr->dr_count, 0);\n\tinit_waitqueue_head(&dr->dr_waiters);\n}\n\nvoid\nxfs_defer_drain_free(struct xfs_defer_drain\t*dr)\n{\n\tASSERT(atomic_read(&dr->dr_count) == 0);\n}\n\n \nstatic inline void xfs_defer_drain_grab(struct xfs_defer_drain *dr)\n{\n\tatomic_inc(&dr->dr_count);\n}\n\nstatic inline bool has_waiters(struct wait_queue_head *wq_head)\n{\n\t \n\tsmp_mb__after_atomic();\n\treturn waitqueue_active(wq_head);\n}\n\n \nstatic inline void xfs_defer_drain_rele(struct xfs_defer_drain *dr)\n{\n\tif (atomic_dec_and_test(&dr->dr_count) &&\n\t    static_branch_unlikely(&xfs_drain_waiter_gate) &&\n\t    has_waiters(&dr->dr_waiters))\n\t\twake_up(&dr->dr_waiters);\n}\n\n \nstatic inline bool xfs_defer_drain_busy(struct xfs_defer_drain *dr)\n{\n\treturn atomic_read(&dr->dr_count) > 0;\n}\n\n \nstatic inline int xfs_defer_drain_wait(struct xfs_defer_drain *dr)\n{\n\treturn wait_event_killable(dr->dr_waiters, !xfs_defer_drain_busy(dr));\n}\n\n \nstruct xfs_perag *\nxfs_perag_intent_get(\n\tstruct xfs_mount\t*mp,\n\txfs_agnumber_t\t\tagno)\n{\n\tstruct xfs_perag\t*pag;\n\n\tpag = xfs_perag_get(mp, agno);\n\tif (!pag)\n\t\treturn NULL;\n\n\txfs_perag_intent_hold(pag);\n\treturn pag;\n}\n\n \nvoid\nxfs_perag_intent_put(\n\tstruct xfs_perag\t*pag)\n{\n\txfs_perag_intent_rele(pag);\n\txfs_perag_put(pag);\n}\n\n \nvoid\nxfs_perag_intent_hold(\n\tstruct xfs_perag\t*pag)\n{\n\ttrace_xfs_perag_intent_hold(pag, __return_address);\n\txfs_defer_drain_grab(&pag->pag_intents_drain);\n}\n\n \nvoid\nxfs_perag_intent_rele(\n\tstruct xfs_perag\t*pag)\n{\n\ttrace_xfs_perag_intent_rele(pag, __return_address);\n\txfs_defer_drain_rele(&pag->pag_intents_drain);\n}\n\n \nint\nxfs_perag_intent_drain(\n\tstruct xfs_perag\t*pag)\n{\n\ttrace_xfs_perag_wait_intents(pag, __return_address);\n\treturn xfs_defer_drain_wait(&pag->pag_intents_drain);\n}\n\n \nbool\nxfs_perag_intent_busy(\n\tstruct xfs_perag\t*pag)\n{\n\treturn xfs_defer_drain_busy(&pag->pag_intents_drain);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}