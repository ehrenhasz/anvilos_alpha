{
  "module_name": "xfs_stats.c",
  "hash_id": "25ea3a5002d1db660808859d3f977d0bcec846019cf7f69f097d06f612db9ac3",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_stats.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n\nstruct xstats xfsstats;\n\nstatic int counter_val(struct xfsstats __percpu *stats, int idx)\n{\n\tint val = 0, cpu;\n\n\tfor_each_possible_cpu(cpu)\n\t\tval += *(((__u32 *)per_cpu_ptr(stats, cpu) + idx));\n\treturn val;\n}\n\nint xfs_stats_format(struct xfsstats __percpu *stats, char *buf)\n{\n\tint\t\ti, j;\n\tint\t\tlen = 0;\n\tuint64_t\txs_xstrat_bytes = 0;\n\tuint64_t\txs_write_bytes = 0;\n\tuint64_t\txs_read_bytes = 0;\n\tuint64_t\tdefer_relog = 0;\n\n\tstatic const struct xstats_entry {\n\t\tchar\t*desc;\n\t\tint\tendpoint;\n\t} xstats[] = {\n\t\t{ \"extent_alloc\",\txfsstats_offset(xs_abt_lookup)\t},\n\t\t{ \"abt\",\t\txfsstats_offset(xs_blk_mapr)\t},\n\t\t{ \"blk_map\",\t\txfsstats_offset(xs_bmbt_lookup)\t},\n\t\t{ \"bmbt\",\t\txfsstats_offset(xs_dir_lookup)\t},\n\t\t{ \"dir\",\t\txfsstats_offset(xs_trans_sync)\t},\n\t\t{ \"trans\",\t\txfsstats_offset(xs_ig_attempts)\t},\n\t\t{ \"ig\",\t\t\txfsstats_offset(xs_log_writes)\t},\n\t\t{ \"log\",\t\txfsstats_offset(xs_try_logspace)},\n\t\t{ \"push_ail\",\t\txfsstats_offset(xs_xstrat_quick)},\n\t\t{ \"xstrat\",\t\txfsstats_offset(xs_write_calls)\t},\n\t\t{ \"rw\",\t\t\txfsstats_offset(xs_attr_get)\t},\n\t\t{ \"attr\",\t\txfsstats_offset(xs_iflush_count)},\n\t\t{ \"icluster\",\t\txfsstats_offset(vn_active)\t},\n\t\t{ \"vnodes\",\t\txfsstats_offset(xb_get)\t\t},\n\t\t{ \"buf\",\t\txfsstats_offset(xs_abtb_2)\t},\n\t\t{ \"abtb2\",\t\txfsstats_offset(xs_abtc_2)\t},\n\t\t{ \"abtc2\",\t\txfsstats_offset(xs_bmbt_2)\t},\n\t\t{ \"bmbt2\",\t\txfsstats_offset(xs_ibt_2)\t},\n\t\t{ \"ibt2\",\t\txfsstats_offset(xs_fibt_2)\t},\n\t\t{ \"fibt2\",\t\txfsstats_offset(xs_rmap_2)\t},\n\t\t{ \"rmapbt\",\t\txfsstats_offset(xs_refcbt_2)\t},\n\t\t{ \"refcntbt\",\t\txfsstats_offset(xs_qm_dqreclaims)},\n\t\t \n\t\t{ \"qm\",\t\t\txfsstats_offset(xs_xstrat_bytes)},\n\t};\n\n\t \n\n\tfor (i = j = 0; i < ARRAY_SIZE(xstats); i++) {\n\t\tlen += scnprintf(buf + len, PATH_MAX - len, \"%s\",\n\t\t\t\txstats[i].desc);\n\t\t \n\t\tfor (; j < xstats[i].endpoint; j++)\n\t\t\tlen += scnprintf(buf + len, PATH_MAX - len, \" %u\",\n\t\t\t\t\tcounter_val(stats, j));\n\t\tlen += scnprintf(buf + len, PATH_MAX - len, \"\\n\");\n\t}\n\t \n\tfor_each_possible_cpu(i) {\n\t\txs_xstrat_bytes += per_cpu_ptr(stats, i)->s.xs_xstrat_bytes;\n\t\txs_write_bytes += per_cpu_ptr(stats, i)->s.xs_write_bytes;\n\t\txs_read_bytes += per_cpu_ptr(stats, i)->s.xs_read_bytes;\n\t\tdefer_relog += per_cpu_ptr(stats, i)->s.defer_relog;\n\t}\n\n\tlen += scnprintf(buf + len, PATH_MAX-len, \"xpc %llu %llu %llu\\n\",\n\t\t\txs_xstrat_bytes, xs_write_bytes, xs_read_bytes);\n\tlen += scnprintf(buf + len, PATH_MAX-len, \"defer_relog %llu\\n\",\n\t\t\tdefer_relog);\n\tlen += scnprintf(buf + len, PATH_MAX-len, \"debug %u\\n\",\n#if defined(DEBUG)\n\t\t1);\n#else\n\t\t0);\n#endif\n\n\treturn len;\n}\n\nvoid xfs_stats_clearall(struct xfsstats __percpu *stats)\n{\n\tint\t\tc;\n\tuint32_t\tvn_active;\n\n\txfs_notice(NULL, \"Clearing xfsstats\");\n\tfor_each_possible_cpu(c) {\n\t\tpreempt_disable();\n\t\t \n\t\tvn_active = per_cpu_ptr(stats, c)->s.vn_active;\n\t\tmemset(per_cpu_ptr(stats, c), 0, sizeof(*stats));\n\t\tper_cpu_ptr(stats, c)->s.vn_active = vn_active;\n\t\tpreempt_enable();\n\t}\n}\n\n#ifdef CONFIG_PROC_FS\n \n#ifdef CONFIG_XFS_QUOTA\n\n#define XFSSTAT_START_XQMSTAT xfsstats_offset(xs_qm_dqreclaims)\n#define XFSSTAT_END_XQMSTAT xfsstats_offset(xs_qm_dquot)\n\nstatic int xqm_proc_show(struct seq_file *m, void *v)\n{\n\t \n\tseq_printf(m, \"%d\\t%d\\t%d\\t%u\\n\",\n\t\t   0, counter_val(xfsstats.xs_stats, XFSSTAT_END_XQMSTAT),\n\t\t   0, counter_val(xfsstats.xs_stats, XFSSTAT_END_XQMSTAT + 1));\n\treturn 0;\n}\n\n \nstatic int xqmstat_proc_show(struct seq_file *m, void *v)\n{\n\tint j;\n\n\tseq_puts(m, \"qm\");\n\tfor (j = XFSSTAT_START_XQMSTAT; j < XFSSTAT_END_XQMSTAT; j++)\n\t\tseq_printf(m, \" %u\", counter_val(xfsstats.xs_stats, j));\n\tseq_putc(m, '\\n');\n\treturn 0;\n}\n#endif  \n\nint\nxfs_init_procfs(void)\n{\n\tif (!proc_mkdir(\"fs/xfs\", NULL))\n\t\treturn -ENOMEM;\n\n\tif (!proc_symlink(\"fs/xfs/stat\", NULL,\n\t\t\t  \"/sys/fs/xfs/stats/stats\"))\n\t\tgoto out;\n\n#ifdef CONFIG_XFS_QUOTA\n\tif (!proc_create_single(\"fs/xfs/xqmstat\", 0, NULL, xqmstat_proc_show))\n\t\tgoto out;\n\tif (!proc_create_single(\"fs/xfs/xqm\", 0, NULL, xqm_proc_show))\n\t\tgoto out;\n#endif\n\treturn 0;\n\nout:\n\tremove_proc_subtree(\"fs/xfs\", NULL);\n\treturn -ENOMEM;\n}\n\nvoid\nxfs_cleanup_procfs(void)\n{\n\tremove_proc_subtree(\"fs/xfs\", NULL);\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}