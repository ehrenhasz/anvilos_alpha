{
  "module_name": "xfs_dquot_item_recover.c",
  "hash_id": "7f863582fda52396df648f5b9288e39260539366a382571b5a168e9bfa601809",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_dquot_item_recover.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_buf_item.h\"\n#include \"xfs_trans_priv.h\"\n#include \"xfs_qm.h\"\n#include \"xfs_log.h\"\n#include \"xfs_log_priv.h\"\n#include \"xfs_log_recover.h\"\n\nSTATIC void\nxlog_recover_dquot_ra_pass2(\n\tstruct xlog\t\t\t*log,\n\tstruct xlog_recover_item\t*item)\n{\n\tstruct xfs_mount\t*mp = log->l_mp;\n\tstruct xfs_disk_dquot\t*recddq;\n\tstruct xfs_dq_logformat\t*dq_f;\n\tuint\t\t\ttype;\n\n\tif (mp->m_qflags == 0)\n\t\treturn;\n\n\trecddq = item->ri_buf[1].i_addr;\n\tif (recddq == NULL)\n\t\treturn;\n\tif (item->ri_buf[1].i_len < sizeof(struct xfs_disk_dquot))\n\t\treturn;\n\n\ttype = recddq->d_type & XFS_DQTYPE_REC_MASK;\n\tASSERT(type);\n\tif (log->l_quotaoffs_flag & type)\n\t\treturn;\n\n\tdq_f = item->ri_buf[0].i_addr;\n\tASSERT(dq_f);\n\tASSERT(dq_f->qlf_len == 1);\n\n\txlog_buf_readahead(log, dq_f->qlf_blkno,\n\t\t\tXFS_FSB_TO_BB(mp, dq_f->qlf_len),\n\t\t\t&xfs_dquot_buf_ra_ops);\n}\n\n \nSTATIC int\nxlog_recover_dquot_commit_pass2(\n\tstruct xlog\t\t\t*log,\n\tstruct list_head\t\t*buffer_list,\n\tstruct xlog_recover_item\t*item,\n\txfs_lsn_t\t\t\tcurrent_lsn)\n{\n\tstruct xfs_mount\t\t*mp = log->l_mp;\n\tstruct xfs_buf\t\t\t*bp;\n\tstruct xfs_disk_dquot\t\t*ddq, *recddq;\n\tstruct xfs_dq_logformat\t\t*dq_f;\n\txfs_failaddr_t\t\t\tfa;\n\tint\t\t\t\terror;\n\tuint\t\t\t\ttype;\n\n\t \n\tif (mp->m_qflags == 0)\n\t\treturn 0;\n\n\trecddq = item->ri_buf[1].i_addr;\n\tif (recddq == NULL) {\n\t\txfs_alert(log->l_mp, \"NULL dquot in %s.\", __func__);\n\t\treturn -EFSCORRUPTED;\n\t}\n\tif (item->ri_buf[1].i_len < sizeof(struct xfs_disk_dquot)) {\n\t\txfs_alert(log->l_mp, \"dquot too small (%d) in %s.\",\n\t\t\titem->ri_buf[1].i_len, __func__);\n\t\treturn -EFSCORRUPTED;\n\t}\n\n\t \n\ttype = recddq->d_type & XFS_DQTYPE_REC_MASK;\n\tASSERT(type);\n\tif (log->l_quotaoffs_flag & type)\n\t\treturn 0;\n\n\t \n\tdq_f = item->ri_buf[0].i_addr;\n\tASSERT(dq_f);\n\tfa = xfs_dquot_verify(mp, recddq, dq_f->qlf_id);\n\tif (fa) {\n\t\txfs_alert(mp, \"corrupt dquot ID 0x%x in log at %pS\",\n\t\t\t\tdq_f->qlf_id, fa);\n\t\treturn -EFSCORRUPTED;\n\t}\n\tASSERT(dq_f->qlf_len == 1);\n\n\t \n\terror = xfs_trans_read_buf(mp, NULL, mp->m_ddev_targp, dq_f->qlf_blkno,\n\t\t\t\t   XFS_FSB_TO_BB(mp, dq_f->qlf_len), 0, &bp,\n\t\t\t\t   &xfs_dquot_buf_ops);\n\tif (error)\n\t\treturn error;\n\n\tASSERT(bp);\n\tddq = xfs_buf_offset(bp, dq_f->qlf_boffset);\n\n\t \n\tif (xfs_has_crc(mp)) {\n\t\tstruct xfs_dqblk *dqb = (struct xfs_dqblk *)ddq;\n\t\txfs_lsn_t\tlsn = be64_to_cpu(dqb->dd_lsn);\n\n\t\tif (lsn && lsn != -1 && XFS_LSN_CMP(lsn, current_lsn) >= 0) {\n\t\t\tgoto out_release;\n\t\t}\n\t}\n\n\tmemcpy(ddq, recddq, item->ri_buf[1].i_len);\n\tif (xfs_has_crc(mp)) {\n\t\txfs_update_cksum((char *)ddq, sizeof(struct xfs_dqblk),\n\t\t\t\t XFS_DQUOT_CRC_OFF);\n\t}\n\n\tASSERT(dq_f->qlf_size == 2);\n\tASSERT(bp->b_mount == mp);\n\tbp->b_flags |= _XBF_LOGRECOVERY;\n\txfs_buf_delwri_queue(bp, buffer_list);\n\nout_release:\n\txfs_buf_relse(bp);\n\treturn 0;\n}\n\nconst struct xlog_recover_item_ops xlog_dquot_item_ops = {\n\t.item_type\t\t= XFS_LI_DQUOT,\n\t.ra_pass2\t\t= xlog_recover_dquot_ra_pass2,\n\t.commit_pass2\t\t= xlog_recover_dquot_commit_pass2,\n};\n\n \nSTATIC int\nxlog_recover_quotaoff_commit_pass1(\n\tstruct xlog\t\t\t*log,\n\tstruct xlog_recover_item\t*item)\n{\n\tstruct xfs_qoff_logformat\t*qoff_f = item->ri_buf[0].i_addr;\n\tASSERT(qoff_f);\n\n\t \n\tif (qoff_f->qf_flags & XFS_UQUOTA_ACCT)\n\t\tlog->l_quotaoffs_flag |= XFS_DQTYPE_USER;\n\tif (qoff_f->qf_flags & XFS_PQUOTA_ACCT)\n\t\tlog->l_quotaoffs_flag |= XFS_DQTYPE_PROJ;\n\tif (qoff_f->qf_flags & XFS_GQUOTA_ACCT)\n\t\tlog->l_quotaoffs_flag |= XFS_DQTYPE_GROUP;\n\n\treturn 0;\n}\n\nconst struct xlog_recover_item_ops xlog_quotaoff_item_ops = {\n\t.item_type\t\t= XFS_LI_QUOTAOFF,\n\t.commit_pass1\t\t= xlog_recover_quotaoff_commit_pass1,\n\t \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}