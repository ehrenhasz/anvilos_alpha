{
  "module_name": "xfs_ag_resv.c",
  "hash_id": "9c790626c745dcdb19203feb2d3f9909c7d2f7a1b99b14d4899f04a853ed6714",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_ag_resv.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_alloc.h\"\n#include \"xfs_errortag.h\"\n#include \"xfs_error.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_rmap_btree.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_refcount_btree.h\"\n#include \"xfs_ialloc_btree.h\"\n#include \"xfs_ag.h\"\n#include \"xfs_ag_resv.h\"\n\n \n\n \nbool\nxfs_ag_resv_critical(\n\tstruct xfs_perag\t\t*pag,\n\tenum xfs_ag_resv_type\t\ttype)\n{\n\txfs_extlen_t\t\t\tavail;\n\txfs_extlen_t\t\t\torig;\n\n\tswitch (type) {\n\tcase XFS_AG_RESV_METADATA:\n\t\tavail = pag->pagf_freeblks - pag->pag_rmapbt_resv.ar_reserved;\n\t\torig = pag->pag_meta_resv.ar_asked;\n\t\tbreak;\n\tcase XFS_AG_RESV_RMAPBT:\n\t\tavail = pag->pagf_freeblks + pag->pagf_flcount -\n\t\t\tpag->pag_meta_resv.ar_reserved;\n\t\torig = pag->pag_rmapbt_resv.ar_asked;\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\treturn false;\n\t}\n\n\ttrace_xfs_ag_resv_critical(pag, type, avail);\n\n\t \n\treturn XFS_TEST_ERROR(avail < orig / 10 ||\n\t\t\t      avail < pag->pag_mount->m_agbtree_maxlevels,\n\t\t\tpag->pag_mount, XFS_ERRTAG_AG_RESV_CRITICAL);\n}\n\n \nxfs_extlen_t\nxfs_ag_resv_needed(\n\tstruct xfs_perag\t\t*pag,\n\tenum xfs_ag_resv_type\t\ttype)\n{\n\txfs_extlen_t\t\t\tlen;\n\n\tlen = pag->pag_meta_resv.ar_reserved + pag->pag_rmapbt_resv.ar_reserved;\n\tswitch (type) {\n\tcase XFS_AG_RESV_METADATA:\n\tcase XFS_AG_RESV_RMAPBT:\n\t\tlen -= xfs_perag_resv(pag, type)->ar_reserved;\n\t\tbreak;\n\tcase XFS_AG_RESV_NONE:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t}\n\n\ttrace_xfs_ag_resv_needed(pag, type, len);\n\n\treturn len;\n}\n\n \nstatic int\n__xfs_ag_resv_free(\n\tstruct xfs_perag\t\t*pag,\n\tenum xfs_ag_resv_type\t\ttype)\n{\n\tstruct xfs_ag_resv\t\t*resv;\n\txfs_extlen_t\t\t\toldresv;\n\tint\t\t\t\terror;\n\n\ttrace_xfs_ag_resv_free(pag, type, 0);\n\n\tresv = xfs_perag_resv(pag, type);\n\tif (pag->pag_agno == 0)\n\t\tpag->pag_mount->m_ag_max_usable += resv->ar_asked;\n\t \n\tif (type == XFS_AG_RESV_RMAPBT)\n\t\toldresv = resv->ar_orig_reserved;\n\telse\n\t\toldresv = resv->ar_reserved;\n\terror = xfs_mod_fdblocks(pag->pag_mount, oldresv, true);\n\tresv->ar_reserved = 0;\n\tresv->ar_asked = 0;\n\tresv->ar_orig_reserved = 0;\n\n\tif (error)\n\t\ttrace_xfs_ag_resv_free_error(pag->pag_mount, pag->pag_agno,\n\t\t\t\terror, _RET_IP_);\n\treturn error;\n}\n\n \nint\nxfs_ag_resv_free(\n\tstruct xfs_perag\t\t*pag)\n{\n\tint\t\t\t\terror;\n\tint\t\t\t\terr2;\n\n\terror = __xfs_ag_resv_free(pag, XFS_AG_RESV_RMAPBT);\n\terr2 = __xfs_ag_resv_free(pag, XFS_AG_RESV_METADATA);\n\tif (err2 && !error)\n\t\terror = err2;\n\treturn error;\n}\n\nstatic int\n__xfs_ag_resv_init(\n\tstruct xfs_perag\t\t*pag,\n\tenum xfs_ag_resv_type\t\ttype,\n\txfs_extlen_t\t\t\task,\n\txfs_extlen_t\t\t\tused)\n{\n\tstruct xfs_mount\t\t*mp = pag->pag_mount;\n\tstruct xfs_ag_resv\t\t*resv;\n\tint\t\t\t\terror;\n\txfs_extlen_t\t\t\thidden_space;\n\n\tif (used > ask)\n\t\task = used;\n\n\tswitch (type) {\n\tcase XFS_AG_RESV_RMAPBT:\n\t\t \n\t\thidden_space = ask;\n\t\tbreak;\n\tcase XFS_AG_RESV_METADATA:\n\t\t \n\t\thidden_space = ask - used;\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\treturn -EINVAL;\n\t}\n\n\tif (XFS_TEST_ERROR(false, mp, XFS_ERRTAG_AG_RESV_FAIL))\n\t\terror = -ENOSPC;\n\telse\n\t\terror = xfs_mod_fdblocks(mp, -(int64_t)hidden_space, true);\n\tif (error) {\n\t\ttrace_xfs_ag_resv_init_error(pag->pag_mount, pag->pag_agno,\n\t\t\t\terror, _RET_IP_);\n\t\txfs_warn(mp,\n\"Per-AG reservation for AG %u failed.  Filesystem may run out of space.\",\n\t\t\t\tpag->pag_agno);\n\t\treturn error;\n\t}\n\n\t \n\tif (pag->pag_agno == 0)\n\t\tmp->m_ag_max_usable -= ask;\n\n\tresv = xfs_perag_resv(pag, type);\n\tresv->ar_asked = ask;\n\tresv->ar_orig_reserved = hidden_space;\n\tresv->ar_reserved = ask - used;\n\n\ttrace_xfs_ag_resv_init(pag, type, ask);\n\treturn 0;\n}\n\n \nint\nxfs_ag_resv_init(\n\tstruct xfs_perag\t\t*pag,\n\tstruct xfs_trans\t\t*tp)\n{\n\tstruct xfs_mount\t\t*mp = pag->pag_mount;\n\txfs_extlen_t\t\t\task;\n\txfs_extlen_t\t\t\tused;\n\tint\t\t\t\terror = 0, error2;\n\tbool\t\t\t\thas_resv = false;\n\n\t \n\tif (pag->pag_meta_resv.ar_asked == 0) {\n\t\task = used = 0;\n\n\t\terror = xfs_refcountbt_calc_reserves(mp, tp, pag, &ask, &used);\n\t\tif (error)\n\t\t\tgoto out;\n\n\t\terror = xfs_finobt_calc_reserves(pag, tp, &ask, &used);\n\t\tif (error)\n\t\t\tgoto out;\n\n\t\terror = __xfs_ag_resv_init(pag, XFS_AG_RESV_METADATA,\n\t\t\t\task, used);\n\t\tif (error) {\n\t\t\t \n\t\t\task = used = 0;\n\n\t\t\tmp->m_finobt_nores = true;\n\n\t\t\terror = xfs_refcountbt_calc_reserves(mp, tp, pag, &ask,\n\t\t\t\t\t&used);\n\t\t\tif (error)\n\t\t\t\tgoto out;\n\n\t\t\terror = __xfs_ag_resv_init(pag, XFS_AG_RESV_METADATA,\n\t\t\t\t\task, used);\n\t\t\tif (error)\n\t\t\t\tgoto out;\n\t\t}\n\t\tif (ask)\n\t\t\thas_resv = true;\n\t}\n\n\t \n\tif (pag->pag_rmapbt_resv.ar_asked == 0) {\n\t\task = used = 0;\n\n\t\terror = xfs_rmapbt_calc_reserves(mp, tp, pag, &ask, &used);\n\t\tif (error)\n\t\t\tgoto out;\n\n\t\terror = __xfs_ag_resv_init(pag, XFS_AG_RESV_RMAPBT, ask, used);\n\t\tif (error)\n\t\t\tgoto out;\n\t\tif (ask)\n\t\t\thas_resv = true;\n\t}\n\nout:\n\t \n\tif (has_resv) {\n\t\terror2 = xfs_alloc_read_agf(pag, tp, 0, NULL);\n\t\tif (error2)\n\t\t\treturn error2;\n\n\t\t \n\t\tif (!error &&\n\t\t    xfs_perag_resv(pag, XFS_AG_RESV_METADATA)->ar_reserved +\n\t\t    xfs_perag_resv(pag, XFS_AG_RESV_RMAPBT)->ar_reserved >\n\t\t    pag->pagf_freeblks + pag->pagf_flcount)\n\t\t\terror = -ENOSPC;\n\t}\n\n\treturn error;\n}\n\n \nvoid\nxfs_ag_resv_alloc_extent(\n\tstruct xfs_perag\t\t*pag,\n\tenum xfs_ag_resv_type\t\ttype,\n\tstruct xfs_alloc_arg\t\t*args)\n{\n\tstruct xfs_ag_resv\t\t*resv;\n\txfs_extlen_t\t\t\tlen;\n\tuint\t\t\t\tfield;\n\n\ttrace_xfs_ag_resv_alloc_extent(pag, type, args->len);\n\n\tswitch (type) {\n\tcase XFS_AG_RESV_AGFL:\n\t\treturn;\n\tcase XFS_AG_RESV_METADATA:\n\tcase XFS_AG_RESV_RMAPBT:\n\t\tresv = xfs_perag_resv(pag, type);\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\tfallthrough;\n\tcase XFS_AG_RESV_NONE:\n\t\tfield = args->wasdel ? XFS_TRANS_SB_RES_FDBLOCKS :\n\t\t\t\t       XFS_TRANS_SB_FDBLOCKS;\n\t\txfs_trans_mod_sb(args->tp, field, -(int64_t)args->len);\n\t\treturn;\n\t}\n\n\tlen = min_t(xfs_extlen_t, args->len, resv->ar_reserved);\n\tresv->ar_reserved -= len;\n\tif (type == XFS_AG_RESV_RMAPBT)\n\t\treturn;\n\t \n\txfs_trans_mod_sb(args->tp, XFS_TRANS_SB_RES_FDBLOCKS, -(int64_t)len);\n\t \n\tif (args->len > len)\n\t\txfs_trans_mod_sb(args->tp, XFS_TRANS_SB_FDBLOCKS,\n\t\t\t\t-((int64_t)args->len - len));\n}\n\n \nvoid\nxfs_ag_resv_free_extent(\n\tstruct xfs_perag\t\t*pag,\n\tenum xfs_ag_resv_type\t\ttype,\n\tstruct xfs_trans\t\t*tp,\n\txfs_extlen_t\t\t\tlen)\n{\n\txfs_extlen_t\t\t\tleftover;\n\tstruct xfs_ag_resv\t\t*resv;\n\n\ttrace_xfs_ag_resv_free_extent(pag, type, len);\n\n\tswitch (type) {\n\tcase XFS_AG_RESV_AGFL:\n\t\treturn;\n\tcase XFS_AG_RESV_METADATA:\n\tcase XFS_AG_RESV_RMAPBT:\n\t\tresv = xfs_perag_resv(pag, type);\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\tfallthrough;\n\tcase XFS_AG_RESV_NONE:\n\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_FDBLOCKS, (int64_t)len);\n\t\treturn;\n\t}\n\n\tleftover = min_t(xfs_extlen_t, len, resv->ar_asked - resv->ar_reserved);\n\tresv->ar_reserved += leftover;\n\tif (type == XFS_AG_RESV_RMAPBT)\n\t\treturn;\n\t \n\txfs_trans_mod_sb(tp, XFS_TRANS_SB_RES_FDBLOCKS, len);\n\t \n\tif (len > leftover)\n\t\txfs_trans_mod_sb(tp, XFS_TRANS_SB_FDBLOCKS, len - leftover);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}