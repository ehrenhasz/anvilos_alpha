{
  "module_name": "xfs_refcount.c",
  "hash_id": "1fd4d269c9db36f68fce83d2912d0302375bcad1940607d27b87e11df3d24e29",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_refcount.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_defer.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_refcount_btree.h\"\n#include \"xfs_alloc.h\"\n#include \"xfs_errortag.h\"\n#include \"xfs_error.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_bit.h\"\n#include \"xfs_refcount.h\"\n#include \"xfs_rmap.h\"\n#include \"xfs_ag.h\"\n\nstruct kmem_cache\t*xfs_refcount_intent_cache;\n\n \nenum xfs_refc_adjust_op {\n\tXFS_REFCOUNT_ADJUST_INCREASE\t= 1,\n\tXFS_REFCOUNT_ADJUST_DECREASE\t= -1,\n\tXFS_REFCOUNT_ADJUST_COW_ALLOC\t= 0,\n\tXFS_REFCOUNT_ADJUST_COW_FREE\t= -1,\n};\n\nSTATIC int __xfs_refcount_cow_alloc(struct xfs_btree_cur *rcur,\n\t\txfs_agblock_t agbno, xfs_extlen_t aglen);\nSTATIC int __xfs_refcount_cow_free(struct xfs_btree_cur *rcur,\n\t\txfs_agblock_t agbno, xfs_extlen_t aglen);\n\n \nint\nxfs_refcount_lookup_le(\n\tstruct xfs_btree_cur\t*cur,\n\tenum xfs_refc_domain\tdomain,\n\txfs_agblock_t\t\tbno,\n\tint\t\t\t*stat)\n{\n\ttrace_xfs_refcount_lookup(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\txfs_refcount_encode_startblock(bno, domain),\n\t\t\tXFS_LOOKUP_LE);\n\tcur->bc_rec.rc.rc_startblock = bno;\n\tcur->bc_rec.rc.rc_blockcount = 0;\n\tcur->bc_rec.rc.rc_domain = domain;\n\treturn xfs_btree_lookup(cur, XFS_LOOKUP_LE, stat);\n}\n\n \nint\nxfs_refcount_lookup_ge(\n\tstruct xfs_btree_cur\t*cur,\n\tenum xfs_refc_domain\tdomain,\n\txfs_agblock_t\t\tbno,\n\tint\t\t\t*stat)\n{\n\ttrace_xfs_refcount_lookup(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\txfs_refcount_encode_startblock(bno, domain),\n\t\t\tXFS_LOOKUP_GE);\n\tcur->bc_rec.rc.rc_startblock = bno;\n\tcur->bc_rec.rc.rc_blockcount = 0;\n\tcur->bc_rec.rc.rc_domain = domain;\n\treturn xfs_btree_lookup(cur, XFS_LOOKUP_GE, stat);\n}\n\n \nint\nxfs_refcount_lookup_eq(\n\tstruct xfs_btree_cur\t*cur,\n\tenum xfs_refc_domain\tdomain,\n\txfs_agblock_t\t\tbno,\n\tint\t\t\t*stat)\n{\n\ttrace_xfs_refcount_lookup(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\txfs_refcount_encode_startblock(bno, domain),\n\t\t\tXFS_LOOKUP_LE);\n\tcur->bc_rec.rc.rc_startblock = bno;\n\tcur->bc_rec.rc.rc_blockcount = 0;\n\tcur->bc_rec.rc.rc_domain = domain;\n\treturn xfs_btree_lookup(cur, XFS_LOOKUP_EQ, stat);\n}\n\n \nvoid\nxfs_refcount_btrec_to_irec(\n\tconst union xfs_btree_rec\t*rec,\n\tstruct xfs_refcount_irec\t*irec)\n{\n\tuint32_t\t\t\tstart;\n\n\tstart = be32_to_cpu(rec->refc.rc_startblock);\n\tif (start & XFS_REFC_COWFLAG) {\n\t\tstart &= ~XFS_REFC_COWFLAG;\n\t\tirec->rc_domain = XFS_REFC_DOMAIN_COW;\n\t} else {\n\t\tirec->rc_domain = XFS_REFC_DOMAIN_SHARED;\n\t}\n\n\tirec->rc_startblock = start;\n\tirec->rc_blockcount = be32_to_cpu(rec->refc.rc_blockcount);\n\tirec->rc_refcount = be32_to_cpu(rec->refc.rc_refcount);\n}\n\n \nxfs_failaddr_t\nxfs_refcount_check_irec(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst struct xfs_refcount_irec\t*irec)\n{\n\tstruct xfs_perag\t\t*pag = cur->bc_ag.pag;\n\n\tif (irec->rc_blockcount == 0 || irec->rc_blockcount > MAXREFCEXTLEN)\n\t\treturn __this_address;\n\n\tif (!xfs_refcount_check_domain(irec))\n\t\treturn __this_address;\n\n\t \n\tif (!xfs_verify_agbext(pag, irec->rc_startblock, irec->rc_blockcount))\n\t\treturn __this_address;\n\n\tif (irec->rc_refcount == 0 || irec->rc_refcount > MAXREFCOUNT)\n\t\treturn __this_address;\n\n\treturn NULL;\n}\n\nstatic inline int\nxfs_refcount_complain_bad_rec(\n\tstruct xfs_btree_cur\t\t*cur,\n\txfs_failaddr_t\t\t\tfa,\n\tconst struct xfs_refcount_irec\t*irec)\n{\n\tstruct xfs_mount\t\t*mp = cur->bc_mp;\n\n\txfs_warn(mp,\n \"Refcount BTree record corruption in AG %d detected at %pS!\",\n\t\t\t\tcur->bc_ag.pag->pag_agno, fa);\n\txfs_warn(mp,\n\t\t\"Start block 0x%x, block count 0x%x, references 0x%x\",\n\t\tirec->rc_startblock, irec->rc_blockcount, irec->rc_refcount);\n\treturn -EFSCORRUPTED;\n}\n\n \nint\nxfs_refcount_get_rec(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*irec,\n\tint\t\t\t\t*stat)\n{\n\tunion xfs_btree_rec\t\t*rec;\n\txfs_failaddr_t\t\t\tfa;\n\tint\t\t\t\terror;\n\n\terror = xfs_btree_get_rec(cur, &rec, stat);\n\tif (error || !*stat)\n\t\treturn error;\n\n\txfs_refcount_btrec_to_irec(rec, irec);\n\tfa = xfs_refcount_check_irec(cur, irec);\n\tif (fa)\n\t\treturn xfs_refcount_complain_bad_rec(cur, fa, irec);\n\n\ttrace_xfs_refcount_get(cur->bc_mp, cur->bc_ag.pag->pag_agno, irec);\n\treturn 0;\n}\n\n \nSTATIC int\nxfs_refcount_update(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*irec)\n{\n\tunion xfs_btree_rec\trec;\n\tuint32_t\t\tstart;\n\tint\t\t\terror;\n\n\ttrace_xfs_refcount_update(cur->bc_mp, cur->bc_ag.pag->pag_agno, irec);\n\n\tstart = xfs_refcount_encode_startblock(irec->rc_startblock,\n\t\t\tirec->rc_domain);\n\trec.refc.rc_startblock = cpu_to_be32(start);\n\trec.refc.rc_blockcount = cpu_to_be32(irec->rc_blockcount);\n\trec.refc.rc_refcount = cpu_to_be32(irec->rc_refcount);\n\n\terror = xfs_btree_update(cur, &rec);\n\tif (error)\n\t\ttrace_xfs_refcount_update_error(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nint\nxfs_refcount_insert(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*irec,\n\tint\t\t\t\t*i)\n{\n\tint\t\t\t\terror;\n\n\ttrace_xfs_refcount_insert(cur->bc_mp, cur->bc_ag.pag->pag_agno, irec);\n\n\tcur->bc_rec.rc.rc_startblock = irec->rc_startblock;\n\tcur->bc_rec.rc.rc_blockcount = irec->rc_blockcount;\n\tcur->bc_rec.rc.rc_refcount = irec->rc_refcount;\n\tcur->bc_rec.rc.rc_domain = irec->rc_domain;\n\n\terror = xfs_btree_insert(cur, i);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, *i != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\nout_error:\n\tif (error)\n\t\ttrace_xfs_refcount_insert_error(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_delete(\n\tstruct xfs_btree_cur\t*cur,\n\tint\t\t\t*i)\n{\n\tstruct xfs_refcount_irec\tirec;\n\tint\t\t\tfound_rec;\n\tint\t\t\terror;\n\n\terror = xfs_refcount_get_rec(cur, &irec, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\ttrace_xfs_refcount_delete(cur->bc_mp, cur->bc_ag.pag->pag_agno, &irec);\n\terror = xfs_btree_delete(cur, i);\n\tif (XFS_IS_CORRUPT(cur->bc_mp, *i != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\tif (error)\n\t\tgoto out_error;\n\terror = xfs_refcount_lookup_ge(cur, irec.rc_domain, irec.rc_startblock,\n\t\t\t&found_rec);\nout_error:\n\tif (error)\n\t\ttrace_xfs_refcount_delete_error(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \n\n \nstatic inline xfs_agblock_t\nxfs_refc_next(\n\tstruct xfs_refcount_irec\t*rc)\n{\n\treturn rc->rc_startblock + rc->rc_blockcount;\n}\n\n \nSTATIC int\nxfs_refcount_split_extent(\n\tstruct xfs_btree_cur\t\t*cur,\n\tenum xfs_refc_domain\t\tdomain,\n\txfs_agblock_t\t\t\tagbno,\n\tbool\t\t\t\t*shape_changed)\n{\n\tstruct xfs_refcount_irec\trcext, tmp;\n\tint\t\t\t\tfound_rec;\n\tint\t\t\t\terror;\n\n\t*shape_changed = false;\n\terror = xfs_refcount_lookup_le(cur, domain, agbno, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (!found_rec)\n\t\treturn 0;\n\n\terror = xfs_refcount_get_rec(cur, &rcext, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\tif (rcext.rc_domain != domain)\n\t\treturn 0;\n\tif (rcext.rc_startblock == agbno || xfs_refc_next(&rcext) <= agbno)\n\t\treturn 0;\n\n\t*shape_changed = true;\n\ttrace_xfs_refcount_split_extent(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\t&rcext, agbno);\n\n\t \n\ttmp = rcext;\n\ttmp.rc_startblock = agbno;\n\ttmp.rc_blockcount -= (agbno - rcext.rc_startblock);\n\terror = xfs_refcount_update(cur, &tmp);\n\tif (error)\n\t\tgoto out_error;\n\n\t \n\ttmp = rcext;\n\ttmp.rc_blockcount = agbno - rcext.rc_startblock;\n\terror = xfs_refcount_insert(cur, &tmp, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\treturn error;\n\nout_error:\n\ttrace_xfs_refcount_split_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_merge_center_extents(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*left,\n\tstruct xfs_refcount_irec\t*center,\n\tstruct xfs_refcount_irec\t*right,\n\tunsigned long long\t\textlen,\n\txfs_extlen_t\t\t\t*aglen)\n{\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec;\n\n\ttrace_xfs_refcount_merge_center_extents(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, left, center, right);\n\n\tASSERT(left->rc_domain == center->rc_domain);\n\tASSERT(right->rc_domain == center->rc_domain);\n\n\t \n\terror = xfs_refcount_lookup_ge(cur, center->rc_domain,\n\t\t\tcenter->rc_startblock, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\terror = xfs_refcount_delete(cur, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\tif (center->rc_refcount > 1) {\n\t\terror = xfs_refcount_delete(cur, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t}\n\n\t \n\terror = xfs_refcount_lookup_le(cur, left->rc_domain,\n\t\t\tleft->rc_startblock, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\tleft->rc_blockcount = extlen;\n\terror = xfs_refcount_update(cur, left);\n\tif (error)\n\t\tgoto out_error;\n\n\t*aglen = 0;\n\treturn error;\n\nout_error:\n\ttrace_xfs_refcount_merge_center_extents_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_merge_left_extent(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*left,\n\tstruct xfs_refcount_irec\t*cleft,\n\txfs_agblock_t\t\t\t*agbno,\n\txfs_extlen_t\t\t\t*aglen)\n{\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec;\n\n\ttrace_xfs_refcount_merge_left_extent(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, left, cleft);\n\n\tASSERT(left->rc_domain == cleft->rc_domain);\n\n\t \n\tif (cleft->rc_refcount > 1) {\n\t\terror = xfs_refcount_lookup_le(cur, cleft->rc_domain,\n\t\t\t\tcleft->rc_startblock, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\terror = xfs_refcount_delete(cur, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t}\n\n\t \n\terror = xfs_refcount_lookup_le(cur, left->rc_domain,\n\t\t\tleft->rc_startblock, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\tleft->rc_blockcount += cleft->rc_blockcount;\n\terror = xfs_refcount_update(cur, left);\n\tif (error)\n\t\tgoto out_error;\n\n\t*agbno += cleft->rc_blockcount;\n\t*aglen -= cleft->rc_blockcount;\n\treturn error;\n\nout_error:\n\ttrace_xfs_refcount_merge_left_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_merge_right_extent(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*right,\n\tstruct xfs_refcount_irec\t*cright,\n\txfs_extlen_t\t\t\t*aglen)\n{\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec;\n\n\ttrace_xfs_refcount_merge_right_extent(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, cright, right);\n\n\tASSERT(right->rc_domain == cright->rc_domain);\n\n\t \n\tif (cright->rc_refcount > 1) {\n\t\terror = xfs_refcount_lookup_le(cur, cright->rc_domain,\n\t\t\t\tcright->rc_startblock, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\terror = xfs_refcount_delete(cur, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t}\n\n\t \n\terror = xfs_refcount_lookup_le(cur, right->rc_domain,\n\t\t\tright->rc_startblock, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\tright->rc_startblock -= cright->rc_blockcount;\n\tright->rc_blockcount += cright->rc_blockcount;\n\terror = xfs_refcount_update(cur, right);\n\tif (error)\n\t\tgoto out_error;\n\n\t*aglen -= cright->rc_blockcount;\n\treturn error;\n\nout_error:\n\ttrace_xfs_refcount_merge_right_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_find_left_extents(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*left,\n\tstruct xfs_refcount_irec\t*cleft,\n\tenum xfs_refc_domain\t\tdomain,\n\txfs_agblock_t\t\t\tagbno,\n\txfs_extlen_t\t\t\taglen)\n{\n\tstruct xfs_refcount_irec\ttmp;\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec;\n\n\tleft->rc_startblock = cleft->rc_startblock = NULLAGBLOCK;\n\terror = xfs_refcount_lookup_le(cur, domain, agbno - 1, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (!found_rec)\n\t\treturn 0;\n\n\terror = xfs_refcount_get_rec(cur, &tmp, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\tif (tmp.rc_domain != domain)\n\t\treturn 0;\n\tif (xfs_refc_next(&tmp) != agbno)\n\t\treturn 0;\n\t \n\t*left = tmp;\n\n\terror = xfs_btree_increment(cur, 0, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (found_rec) {\n\t\terror = xfs_refcount_get_rec(cur, &tmp, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\tif (tmp.rc_domain != domain)\n\t\t\tgoto not_found;\n\n\t\t \n\t\tif (tmp.rc_startblock == agbno)\n\t\t\t*cleft = tmp;\n\t\telse {\n\t\t\t \n\t\t\tcleft->rc_startblock = agbno;\n\t\t\tcleft->rc_blockcount = min(aglen,\n\t\t\t\t\ttmp.rc_startblock - agbno);\n\t\t\tcleft->rc_refcount = 1;\n\t\t\tcleft->rc_domain = domain;\n\t\t}\n\t} else {\nnot_found:\n\t\t \n\t\tcleft->rc_startblock = agbno;\n\t\tcleft->rc_blockcount = aglen;\n\t\tcleft->rc_refcount = 1;\n\t\tcleft->rc_domain = domain;\n\t}\n\ttrace_xfs_refcount_find_left_extent(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\tleft, cleft, agbno);\n\treturn error;\n\nout_error:\n\ttrace_xfs_refcount_find_left_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_find_right_extents(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_irec\t*right,\n\tstruct xfs_refcount_irec\t*cright,\n\tenum xfs_refc_domain\t\tdomain,\n\txfs_agblock_t\t\t\tagbno,\n\txfs_extlen_t\t\t\taglen)\n{\n\tstruct xfs_refcount_irec\ttmp;\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec;\n\n\tright->rc_startblock = cright->rc_startblock = NULLAGBLOCK;\n\terror = xfs_refcount_lookup_ge(cur, domain, agbno + aglen, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (!found_rec)\n\t\treturn 0;\n\n\terror = xfs_refcount_get_rec(cur, &tmp, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\n\tif (tmp.rc_domain != domain)\n\t\treturn 0;\n\tif (tmp.rc_startblock != agbno + aglen)\n\t\treturn 0;\n\t \n\t*right = tmp;\n\n\terror = xfs_btree_decrement(cur, 0, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (found_rec) {\n\t\terror = xfs_refcount_get_rec(cur, &tmp, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\tif (tmp.rc_domain != domain)\n\t\t\tgoto not_found;\n\n\t\t \n\t\tif (xfs_refc_next(&tmp) == agbno + aglen)\n\t\t\t*cright = tmp;\n\t\telse {\n\t\t\t \n\t\t\tcright->rc_startblock = max(agbno, xfs_refc_next(&tmp));\n\t\t\tcright->rc_blockcount = right->rc_startblock -\n\t\t\t\t\tcright->rc_startblock;\n\t\t\tcright->rc_refcount = 1;\n\t\t\tcright->rc_domain = domain;\n\t\t}\n\t} else {\nnot_found:\n\t\t \n\t\tcright->rc_startblock = agbno;\n\t\tcright->rc_blockcount = aglen;\n\t\tcright->rc_refcount = 1;\n\t\tcright->rc_domain = domain;\n\t}\n\ttrace_xfs_refcount_find_right_extent(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\tcright, right, agbno + aglen);\n\treturn error;\n\nout_error:\n\ttrace_xfs_refcount_find_right_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nstatic inline bool\nxfs_refc_valid(\n\tconst struct xfs_refcount_irec\t*rc)\n{\n\treturn rc->rc_startblock != NULLAGBLOCK;\n}\n\nstatic inline xfs_nlink_t\nxfs_refc_merge_refcount(\n\tconst struct xfs_refcount_irec\t*irec,\n\tenum xfs_refc_adjust_op\t\tadjust)\n{\n\t \n\tif (irec->rc_refcount == MAXREFCOUNT)\n\t\treturn MAXREFCOUNT;\n\treturn irec->rc_refcount + adjust;\n}\n\nstatic inline bool\nxfs_refc_want_merge_center(\n\tconst struct xfs_refcount_irec\t*left,\n\tconst struct xfs_refcount_irec\t*cleft,\n\tconst struct xfs_refcount_irec\t*cright,\n\tconst struct xfs_refcount_irec\t*right,\n\tbool\t\t\t\tcleft_is_cright,\n\tenum xfs_refc_adjust_op\t\tadjust,\n\tunsigned long long\t\t*ulenp)\n{\n\tunsigned long long\t\tulen = left->rc_blockcount;\n\txfs_nlink_t\t\t\tnew_refcount;\n\n\t \n\tif (!xfs_refc_valid(left)  || !xfs_refc_valid(right) ||\n\t    !xfs_refc_valid(cleft) || !xfs_refc_valid(cright))\n\t\treturn false;\n\n\t \n\tif (!cleft_is_cright)\n\t\treturn false;\n\n\t \n\tnew_refcount = xfs_refc_merge_refcount(cleft, adjust);\n\tif (left->rc_refcount != new_refcount)\n\t\treturn false;\n\tif (right->rc_refcount != new_refcount)\n\t\treturn false;\n\n\t \n\tulen += cleft->rc_blockcount + right->rc_blockcount;\n\tif (ulen >= MAXREFCEXTLEN)\n\t\treturn false;\n\n\t*ulenp = ulen;\n\treturn true;\n}\n\nstatic inline bool\nxfs_refc_want_merge_left(\n\tconst struct xfs_refcount_irec\t*left,\n\tconst struct xfs_refcount_irec\t*cleft,\n\tenum xfs_refc_adjust_op\t\tadjust)\n{\n\tunsigned long long\t\tulen = left->rc_blockcount;\n\txfs_nlink_t\t\t\tnew_refcount;\n\n\t \n\tif (!xfs_refc_valid(left) || !xfs_refc_valid(cleft))\n\t\treturn false;\n\n\t \n\tnew_refcount = xfs_refc_merge_refcount(cleft, adjust);\n\tif (left->rc_refcount != new_refcount)\n\t\treturn false;\n\n\t \n\tulen += cleft->rc_blockcount;\n\tif (ulen >= MAXREFCEXTLEN)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic inline bool\nxfs_refc_want_merge_right(\n\tconst struct xfs_refcount_irec\t*cright,\n\tconst struct xfs_refcount_irec\t*right,\n\tenum xfs_refc_adjust_op\t\tadjust)\n{\n\tunsigned long long\t\tulen = right->rc_blockcount;\n\txfs_nlink_t\t\t\tnew_refcount;\n\n\t \n\tif (!xfs_refc_valid(right) || !xfs_refc_valid(cright))\n\t\treturn false;\n\n\t \n\tnew_refcount = xfs_refc_merge_refcount(cright, adjust);\n\tif (right->rc_refcount != new_refcount)\n\t\treturn false;\n\n\t \n\tulen += cright->rc_blockcount;\n\tif (ulen >= MAXREFCEXTLEN)\n\t\treturn false;\n\n\treturn true;\n}\n\n \nSTATIC int\nxfs_refcount_merge_extents(\n\tstruct xfs_btree_cur\t*cur,\n\tenum xfs_refc_domain\tdomain,\n\txfs_agblock_t\t\t*agbno,\n\txfs_extlen_t\t\t*aglen,\n\tenum xfs_refc_adjust_op adjust,\n\tbool\t\t\t*shape_changed)\n{\n\tstruct xfs_refcount_irec\tleft = {0}, cleft = {0};\n\tstruct xfs_refcount_irec\tcright = {0}, right = {0};\n\tint\t\t\t\terror;\n\tunsigned long long\t\tulen;\n\tbool\t\t\t\tcequal;\n\n\t*shape_changed = false;\n\t \n\terror = xfs_refcount_find_left_extents(cur, &left, &cleft, domain,\n\t\t\t*agbno, *aglen);\n\tif (error)\n\t\treturn error;\n\terror = xfs_refcount_find_right_extents(cur, &right, &cright, domain,\n\t\t\t*agbno, *aglen);\n\tif (error)\n\t\treturn error;\n\n\t \n\tif (!xfs_refc_valid(&left) && !xfs_refc_valid(&right))\n\t\treturn 0;\n\n\tcequal = (cleft.rc_startblock == cright.rc_startblock) &&\n\t\t (cleft.rc_blockcount == cright.rc_blockcount);\n\n\t \n\tif (xfs_refc_want_merge_center(&left, &cleft, &cright, &right, cequal,\n\t\t\t\tadjust, &ulen)) {\n\t\t*shape_changed = true;\n\t\treturn xfs_refcount_merge_center_extents(cur, &left, &cleft,\n\t\t\t\t&right, ulen, aglen);\n\t}\n\n\t \n\tif (xfs_refc_want_merge_left(&left, &cleft, adjust)) {\n\t\t*shape_changed = true;\n\t\terror = xfs_refcount_merge_left_extent(cur, &left, &cleft,\n\t\t\t\tagbno, aglen);\n\t\tif (error)\n\t\t\treturn error;\n\n\t\t \n\t\tif (cequal)\n\t\t\treturn 0;\n\t}\n\n\t \n\tif (xfs_refc_want_merge_right(&cright, &right, adjust)) {\n\t\t*shape_changed = true;\n\t\treturn xfs_refcount_merge_right_extent(cur, &right, &cright,\n\t\t\t\taglen);\n\t}\n\n\treturn 0;\n}\n\n \nstatic bool\nxfs_refcount_still_have_space(\n\tstruct xfs_btree_cur\t\t*cur)\n{\n\tunsigned long\t\t\toverhead;\n\n\t \n\toverhead = xfs_allocfree_block_count(cur->bc_mp,\n\t\t\t\tcur->bc_ag.refc.shape_changes);\n\toverhead += cur->bc_mp->m_refc_maxlevels;\n\toverhead *= cur->bc_mp->m_sb.sb_blocksize;\n\n\t \n\tif (cur->bc_ag.refc.nr_ops > 2 &&\n\t    XFS_TEST_ERROR(false, cur->bc_mp,\n\t\t\tXFS_ERRTAG_REFCOUNT_CONTINUE_UPDATE))\n\t\treturn false;\n\n\tif (cur->bc_ag.refc.nr_ops == 0)\n\t\treturn true;\n\telse if (overhead > cur->bc_tp->t_log_res)\n\t\treturn false;\n\treturn  cur->bc_tp->t_log_res - overhead >\n\t\tcur->bc_ag.refc.nr_ops * XFS_REFCOUNT_ITEM_OVERHEAD;\n}\n\n \nSTATIC int\nxfs_refcount_adjust_extents(\n\tstruct xfs_btree_cur\t*cur,\n\txfs_agblock_t\t\t*agbno,\n\txfs_extlen_t\t\t*aglen,\n\tenum xfs_refc_adjust_op\tadj)\n{\n\tstruct xfs_refcount_irec\text, tmp;\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec, found_tmp;\n\txfs_fsblock_t\t\t\tfsbno;\n\n\t \n\tif (*aglen == 0)\n\t\treturn 0;\n\n\terror = xfs_refcount_lookup_ge(cur, XFS_REFC_DOMAIN_SHARED, *agbno,\n\t\t\t&found_rec);\n\tif (error)\n\t\tgoto out_error;\n\n\twhile (*aglen > 0 && xfs_refcount_still_have_space(cur)) {\n\t\terror = xfs_refcount_get_rec(cur, &ext, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (!found_rec || ext.rc_domain != XFS_REFC_DOMAIN_SHARED) {\n\t\t\text.rc_startblock = cur->bc_mp->m_sb.sb_agblocks;\n\t\t\text.rc_blockcount = 0;\n\t\t\text.rc_refcount = 0;\n\t\t\text.rc_domain = XFS_REFC_DOMAIN_SHARED;\n\t\t}\n\n\t\t \n\t\tif (ext.rc_startblock != *agbno) {\n\t\t\ttmp.rc_startblock = *agbno;\n\t\t\ttmp.rc_blockcount = min(*aglen,\n\t\t\t\t\text.rc_startblock - *agbno);\n\t\t\ttmp.rc_refcount = 1 + adj;\n\t\t\ttmp.rc_domain = XFS_REFC_DOMAIN_SHARED;\n\n\t\t\ttrace_xfs_refcount_modify_extent(cur->bc_mp,\n\t\t\t\t\tcur->bc_ag.pag->pag_agno, &tmp);\n\n\t\t\t \n\t\t\tcur->bc_ag.refc.nr_ops++;\n\t\t\tif (tmp.rc_refcount) {\n\t\t\t\terror = xfs_refcount_insert(cur, &tmp,\n\t\t\t\t\t\t&found_tmp);\n\t\t\t\tif (error)\n\t\t\t\t\tgoto out_error;\n\t\t\t\tif (XFS_IS_CORRUPT(cur->bc_mp,\n\t\t\t\t\t\t   found_tmp != 1)) {\n\t\t\t\t\terror = -EFSCORRUPTED;\n\t\t\t\t\tgoto out_error;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfsbno = XFS_AGB_TO_FSB(cur->bc_mp,\n\t\t\t\t\t\tcur->bc_ag.pag->pag_agno,\n\t\t\t\t\t\ttmp.rc_startblock);\n\t\t\t\terror = xfs_free_extent_later(cur->bc_tp, fsbno,\n\t\t\t\t\t\t  tmp.rc_blockcount, NULL,\n\t\t\t\t\t\t  XFS_AG_RESV_NONE);\n\t\t\t\tif (error)\n\t\t\t\t\tgoto out_error;\n\t\t\t}\n\n\t\t\t(*agbno) += tmp.rc_blockcount;\n\t\t\t(*aglen) -= tmp.rc_blockcount;\n\n\t\t\t \n\t\t\tif (*aglen == 0 || !xfs_refcount_still_have_space(cur))\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\terror = xfs_refcount_lookup_ge(cur,\n\t\t\t\t\tXFS_REFC_DOMAIN_SHARED, *agbno,\n\t\t\t\t\t&found_rec);\n\t\t\tif (error)\n\t\t\t\tgoto out_error;\n\t\t}\n\n\t\t \n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, ext.rc_blockcount == 0) ||\n\t\t    XFS_IS_CORRUPT(cur->bc_mp, ext.rc_blockcount > *aglen)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\t \n\t\tif (ext.rc_refcount == MAXREFCOUNT)\n\t\t\tgoto skip;\n\t\text.rc_refcount += adj;\n\t\ttrace_xfs_refcount_modify_extent(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, &ext);\n\t\tcur->bc_ag.refc.nr_ops++;\n\t\tif (ext.rc_refcount > 1) {\n\t\t\terror = xfs_refcount_update(cur, &ext);\n\t\t\tif (error)\n\t\t\t\tgoto out_error;\n\t\t} else if (ext.rc_refcount == 1) {\n\t\t\terror = xfs_refcount_delete(cur, &found_rec);\n\t\t\tif (error)\n\t\t\t\tgoto out_error;\n\t\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\t\terror = -EFSCORRUPTED;\n\t\t\t\tgoto out_error;\n\t\t\t}\n\t\t\tgoto advloop;\n\t\t} else {\n\t\t\tfsbno = XFS_AGB_TO_FSB(cur->bc_mp,\n\t\t\t\t\tcur->bc_ag.pag->pag_agno,\n\t\t\t\t\text.rc_startblock);\n\t\t\terror = xfs_free_extent_later(cur->bc_tp, fsbno,\n\t\t\t\t\text.rc_blockcount, NULL,\n\t\t\t\t\tXFS_AG_RESV_NONE);\n\t\t\tif (error)\n\t\t\t\tgoto out_error;\n\t\t}\n\nskip:\n\t\terror = xfs_btree_increment(cur, 0, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\nadvloop:\n\t\t(*agbno) += ext.rc_blockcount;\n\t\t(*aglen) -= ext.rc_blockcount;\n\t}\n\n\treturn error;\nout_error:\n\ttrace_xfs_refcount_modify_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_adjust(\n\tstruct xfs_btree_cur\t*cur,\n\txfs_agblock_t\t\t*agbno,\n\txfs_extlen_t\t\t*aglen,\n\tenum xfs_refc_adjust_op\tadj)\n{\n\tbool\t\t\tshape_changed;\n\tint\t\t\tshape_changes = 0;\n\tint\t\t\terror;\n\n\tif (adj == XFS_REFCOUNT_ADJUST_INCREASE)\n\t\ttrace_xfs_refcount_increase(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, *agbno, *aglen);\n\telse\n\t\ttrace_xfs_refcount_decrease(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, *agbno, *aglen);\n\n\t \n\terror = xfs_refcount_split_extent(cur, XFS_REFC_DOMAIN_SHARED,\n\t\t\t*agbno, &shape_changed);\n\tif (error)\n\t\tgoto out_error;\n\tif (shape_changed)\n\t\tshape_changes++;\n\n\terror = xfs_refcount_split_extent(cur, XFS_REFC_DOMAIN_SHARED,\n\t\t\t*agbno + *aglen, &shape_changed);\n\tif (error)\n\t\tgoto out_error;\n\tif (shape_changed)\n\t\tshape_changes++;\n\n\t \n\terror = xfs_refcount_merge_extents(cur, XFS_REFC_DOMAIN_SHARED,\n\t\t\tagbno, aglen, adj, &shape_changed);\n\tif (error)\n\t\tgoto out_error;\n\tif (shape_changed)\n\t\tshape_changes++;\n\tif (shape_changes)\n\t\tcur->bc_ag.refc.shape_changes++;\n\n\t \n\terror = xfs_refcount_adjust_extents(cur, agbno, aglen, adj);\n\tif (error)\n\t\tgoto out_error;\n\n\treturn 0;\n\nout_error:\n\ttrace_xfs_refcount_adjust_error(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\terror, _RET_IP_);\n\treturn error;\n}\n\n \nvoid\nxfs_refcount_finish_one_cleanup(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_btree_cur\t*rcur,\n\tint\t\t\terror)\n{\n\tstruct xfs_buf\t\t*agbp;\n\n\tif (rcur == NULL)\n\t\treturn;\n\tagbp = rcur->bc_ag.agbp;\n\txfs_btree_del_cursor(rcur, error);\n\tif (error)\n\t\txfs_trans_brelse(tp, agbp);\n}\n\n \nstatic inline int\nxfs_refcount_continue_op(\n\tstruct xfs_btree_cur\t\t*cur,\n\tstruct xfs_refcount_intent\t*ri,\n\txfs_agblock_t\t\t\tnew_agbno)\n{\n\tstruct xfs_mount\t\t*mp = cur->bc_mp;\n\tstruct xfs_perag\t\t*pag = cur->bc_ag.pag;\n\n\tif (XFS_IS_CORRUPT(mp, !xfs_verify_agbext(pag, new_agbno,\n\t\t\t\t\tri->ri_blockcount)))\n\t\treturn -EFSCORRUPTED;\n\n\tri->ri_startblock = XFS_AGB_TO_FSB(mp, pag->pag_agno, new_agbno);\n\n\tASSERT(xfs_verify_fsbext(mp, ri->ri_startblock, ri->ri_blockcount));\n\tASSERT(pag->pag_agno == XFS_FSB_TO_AGNO(mp, ri->ri_startblock));\n\n\treturn 0;\n}\n\n \nint\nxfs_refcount_finish_one(\n\tstruct xfs_trans\t\t*tp,\n\tstruct xfs_refcount_intent\t*ri,\n\tstruct xfs_btree_cur\t\t**pcur)\n{\n\tstruct xfs_mount\t\t*mp = tp->t_mountp;\n\tstruct xfs_btree_cur\t\t*rcur;\n\tstruct xfs_buf\t\t\t*agbp = NULL;\n\tint\t\t\t\terror = 0;\n\txfs_agblock_t\t\t\tbno;\n\tunsigned long\t\t\tnr_ops = 0;\n\tint\t\t\t\tshape_changes = 0;\n\n\tbno = XFS_FSB_TO_AGBNO(mp, ri->ri_startblock);\n\n\ttrace_xfs_refcount_deferred(mp, XFS_FSB_TO_AGNO(mp, ri->ri_startblock),\n\t\t\tri->ri_type, XFS_FSB_TO_AGBNO(mp, ri->ri_startblock),\n\t\t\tri->ri_blockcount);\n\n\tif (XFS_TEST_ERROR(false, mp, XFS_ERRTAG_REFCOUNT_FINISH_ONE))\n\t\treturn -EIO;\n\n\t \n\trcur = *pcur;\n\tif (rcur != NULL && rcur->bc_ag.pag != ri->ri_pag) {\n\t\tnr_ops = rcur->bc_ag.refc.nr_ops;\n\t\tshape_changes = rcur->bc_ag.refc.shape_changes;\n\t\txfs_refcount_finish_one_cleanup(tp, rcur, 0);\n\t\trcur = NULL;\n\t\t*pcur = NULL;\n\t}\n\tif (rcur == NULL) {\n\t\terror = xfs_alloc_read_agf(ri->ri_pag, tp,\n\t\t\t\tXFS_ALLOC_FLAG_FREEING, &agbp);\n\t\tif (error)\n\t\t\treturn error;\n\n\t\trcur = xfs_refcountbt_init_cursor(mp, tp, agbp, ri->ri_pag);\n\t\trcur->bc_ag.refc.nr_ops = nr_ops;\n\t\trcur->bc_ag.refc.shape_changes = shape_changes;\n\t}\n\t*pcur = rcur;\n\n\tswitch (ri->ri_type) {\n\tcase XFS_REFCOUNT_INCREASE:\n\t\terror = xfs_refcount_adjust(rcur, &bno, &ri->ri_blockcount,\n\t\t\t\tXFS_REFCOUNT_ADJUST_INCREASE);\n\t\tif (error)\n\t\t\treturn error;\n\t\tif (ri->ri_blockcount > 0)\n\t\t\terror = xfs_refcount_continue_op(rcur, ri, bno);\n\t\tbreak;\n\tcase XFS_REFCOUNT_DECREASE:\n\t\terror = xfs_refcount_adjust(rcur, &bno, &ri->ri_blockcount,\n\t\t\t\tXFS_REFCOUNT_ADJUST_DECREASE);\n\t\tif (error)\n\t\t\treturn error;\n\t\tif (ri->ri_blockcount > 0)\n\t\t\terror = xfs_refcount_continue_op(rcur, ri, bno);\n\t\tbreak;\n\tcase XFS_REFCOUNT_ALLOC_COW:\n\t\terror = __xfs_refcount_cow_alloc(rcur, bno, ri->ri_blockcount);\n\t\tif (error)\n\t\t\treturn error;\n\t\tri->ri_blockcount = 0;\n\t\tbreak;\n\tcase XFS_REFCOUNT_FREE_COW:\n\t\terror = __xfs_refcount_cow_free(rcur, bno, ri->ri_blockcount);\n\t\tif (error)\n\t\t\treturn error;\n\t\tri->ri_blockcount = 0;\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t\treturn -EFSCORRUPTED;\n\t}\n\tif (!error && ri->ri_blockcount > 0)\n\t\ttrace_xfs_refcount_finish_one_leftover(mp, ri->ri_pag->pag_agno,\n\t\t\t\tri->ri_type, bno, ri->ri_blockcount);\n\treturn error;\n}\n\n \nstatic void\n__xfs_refcount_add(\n\tstruct xfs_trans\t\t*tp,\n\tenum xfs_refcount_intent_type\ttype,\n\txfs_fsblock_t\t\t\tstartblock,\n\txfs_extlen_t\t\t\tblockcount)\n{\n\tstruct xfs_refcount_intent\t*ri;\n\n\ttrace_xfs_refcount_defer(tp->t_mountp,\n\t\t\tXFS_FSB_TO_AGNO(tp->t_mountp, startblock),\n\t\t\ttype, XFS_FSB_TO_AGBNO(tp->t_mountp, startblock),\n\t\t\tblockcount);\n\n\tri = kmem_cache_alloc(xfs_refcount_intent_cache,\n\t\t\tGFP_NOFS | __GFP_NOFAIL);\n\tINIT_LIST_HEAD(&ri->ri_list);\n\tri->ri_type = type;\n\tri->ri_startblock = startblock;\n\tri->ri_blockcount = blockcount;\n\n\txfs_refcount_update_get_group(tp->t_mountp, ri);\n\txfs_defer_add(tp, XFS_DEFER_OPS_TYPE_REFCOUNT, &ri->ri_list);\n}\n\n \nvoid\nxfs_refcount_increase_extent(\n\tstruct xfs_trans\t\t*tp,\n\tstruct xfs_bmbt_irec\t\t*PREV)\n{\n\tif (!xfs_has_reflink(tp->t_mountp))\n\t\treturn;\n\n\t__xfs_refcount_add(tp, XFS_REFCOUNT_INCREASE, PREV->br_startblock,\n\t\t\tPREV->br_blockcount);\n}\n\n \nvoid\nxfs_refcount_decrease_extent(\n\tstruct xfs_trans\t\t*tp,\n\tstruct xfs_bmbt_irec\t\t*PREV)\n{\n\tif (!xfs_has_reflink(tp->t_mountp))\n\t\treturn;\n\n\t__xfs_refcount_add(tp, XFS_REFCOUNT_DECREASE, PREV->br_startblock,\n\t\t\tPREV->br_blockcount);\n}\n\n \nint\nxfs_refcount_find_shared(\n\tstruct xfs_btree_cur\t\t*cur,\n\txfs_agblock_t\t\t\tagbno,\n\txfs_extlen_t\t\t\taglen,\n\txfs_agblock_t\t\t\t*fbno,\n\txfs_extlen_t\t\t\t*flen,\n\tbool\t\t\t\tfind_end_of_shared)\n{\n\tstruct xfs_refcount_irec\ttmp;\n\tint\t\t\t\ti;\n\tint\t\t\t\thave;\n\tint\t\t\t\terror;\n\n\ttrace_xfs_refcount_find_shared(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\tagbno, aglen);\n\n\t \n\t*fbno = NULLAGBLOCK;\n\t*flen = 0;\n\n\t \n\terror = xfs_refcount_lookup_le(cur, XFS_REFC_DOMAIN_SHARED, agbno,\n\t\t\t&have);\n\tif (error)\n\t\tgoto out_error;\n\tif (!have) {\n\t\t \n\t\terror = xfs_btree_increment(cur, 0, &have);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (!have)\n\t\t\tgoto done;\n\t}\n\terror = xfs_refcount_get_rec(cur, &tmp, &i);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, i != 1)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\tif (tmp.rc_domain != XFS_REFC_DOMAIN_SHARED)\n\t\tgoto done;\n\n\t \n\tif (tmp.rc_startblock + tmp.rc_blockcount <= agbno) {\n\t\terror = xfs_btree_increment(cur, 0, &have);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (!have)\n\t\t\tgoto done;\n\t\terror = xfs_refcount_get_rec(cur, &tmp, &i);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, i != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t\tif (tmp.rc_domain != XFS_REFC_DOMAIN_SHARED)\n\t\t\tgoto done;\n\t}\n\n\t \n\tif (tmp.rc_startblock >= agbno + aglen)\n\t\tgoto done;\n\n\t \n\tif (tmp.rc_startblock < agbno) {\n\t\ttmp.rc_blockcount -= (agbno - tmp.rc_startblock);\n\t\ttmp.rc_startblock = agbno;\n\t}\n\n\t*fbno = tmp.rc_startblock;\n\t*flen = min(tmp.rc_blockcount, agbno + aglen - *fbno);\n\tif (!find_end_of_shared)\n\t\tgoto done;\n\n\t \n\twhile (*fbno + *flen < agbno + aglen) {\n\t\terror = xfs_btree_increment(cur, 0, &have);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (!have)\n\t\t\tbreak;\n\t\terror = xfs_refcount_get_rec(cur, &tmp, &i);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, i != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t\tif (tmp.rc_domain != XFS_REFC_DOMAIN_SHARED ||\n\t\t    tmp.rc_startblock >= agbno + aglen ||\n\t\t    tmp.rc_startblock != *fbno + *flen)\n\t\t\tbreak;\n\t\t*flen = min(*flen + tmp.rc_blockcount, agbno + aglen - *fbno);\n\t}\n\ndone:\n\ttrace_xfs_refcount_find_shared_result(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, *fbno, *flen);\n\nout_error:\n\tif (error)\n\t\ttrace_xfs_refcount_find_shared_error(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \n \nSTATIC int\nxfs_refcount_adjust_cow_extents(\n\tstruct xfs_btree_cur\t*cur,\n\txfs_agblock_t\t\tagbno,\n\txfs_extlen_t\t\taglen,\n\tenum xfs_refc_adjust_op\tadj)\n{\n\tstruct xfs_refcount_irec\text, tmp;\n\tint\t\t\t\terror;\n\tint\t\t\t\tfound_rec, found_tmp;\n\n\tif (aglen == 0)\n\t\treturn 0;\n\n\t \n\terror = xfs_refcount_lookup_ge(cur, XFS_REFC_DOMAIN_COW, agbno,\n\t\t\t&found_rec);\n\tif (error)\n\t\tgoto out_error;\n\terror = xfs_refcount_get_rec(cur, &ext, &found_rec);\n\tif (error)\n\t\tgoto out_error;\n\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec &&\n\t\t\t\text.rc_domain != XFS_REFC_DOMAIN_COW)) {\n\t\terror = -EFSCORRUPTED;\n\t\tgoto out_error;\n\t}\n\tif (!found_rec) {\n\t\text.rc_startblock = cur->bc_mp->m_sb.sb_agblocks;\n\t\text.rc_blockcount = 0;\n\t\text.rc_refcount = 0;\n\t\text.rc_domain = XFS_REFC_DOMAIN_COW;\n\t}\n\n\tswitch (adj) {\n\tcase XFS_REFCOUNT_ADJUST_COW_ALLOC:\n\t\t \n\t\tif (XFS_IS_CORRUPT(cur->bc_mp,\n\t\t\t\t   agbno + aglen > ext.rc_startblock)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\ttmp.rc_startblock = agbno;\n\t\ttmp.rc_blockcount = aglen;\n\t\ttmp.rc_refcount = 1;\n\t\ttmp.rc_domain = XFS_REFC_DOMAIN_COW;\n\n\t\ttrace_xfs_refcount_modify_extent(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, &tmp);\n\n\t\terror = xfs_refcount_insert(cur, &tmp,\n\t\t\t\t&found_tmp);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_tmp != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t\tbreak;\n\tcase XFS_REFCOUNT_ADJUST_COW_FREE:\n\t\t \n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, ext.rc_startblock != agbno)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, ext.rc_blockcount != aglen)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, ext.rc_refcount != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\n\t\text.rc_refcount = 0;\n\t\ttrace_xfs_refcount_modify_extent(cur->bc_mp,\n\t\t\t\tcur->bc_ag.pag->pag_agno, &ext);\n\t\terror = xfs_refcount_delete(cur, &found_rec);\n\t\tif (error)\n\t\t\tgoto out_error;\n\t\tif (XFS_IS_CORRUPT(cur->bc_mp, found_rec != 1)) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_error;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);\n\t}\n\n\treturn error;\nout_error:\n\ttrace_xfs_refcount_modify_extent_error(cur->bc_mp,\n\t\t\tcur->bc_ag.pag->pag_agno, error, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_refcount_adjust_cow(\n\tstruct xfs_btree_cur\t*cur,\n\txfs_agblock_t\t\tagbno,\n\txfs_extlen_t\t\taglen,\n\tenum xfs_refc_adjust_op\tadj)\n{\n\tbool\t\t\tshape_changed;\n\tint\t\t\terror;\n\n\t \n\terror = xfs_refcount_split_extent(cur, XFS_REFC_DOMAIN_COW,\n\t\t\tagbno, &shape_changed);\n\tif (error)\n\t\tgoto out_error;\n\n\terror = xfs_refcount_split_extent(cur, XFS_REFC_DOMAIN_COW,\n\t\t\tagbno + aglen, &shape_changed);\n\tif (error)\n\t\tgoto out_error;\n\n\t \n\terror = xfs_refcount_merge_extents(cur, XFS_REFC_DOMAIN_COW, &agbno,\n\t\t\t&aglen, adj, &shape_changed);\n\tif (error)\n\t\tgoto out_error;\n\n\t \n\terror = xfs_refcount_adjust_cow_extents(cur, agbno, aglen, adj);\n\tif (error)\n\t\tgoto out_error;\n\n\treturn 0;\n\nout_error:\n\ttrace_xfs_refcount_adjust_cow_error(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\terror, _RET_IP_);\n\treturn error;\n}\n\n \nSTATIC int\n__xfs_refcount_cow_alloc(\n\tstruct xfs_btree_cur\t*rcur,\n\txfs_agblock_t\t\tagbno,\n\txfs_extlen_t\t\taglen)\n{\n\ttrace_xfs_refcount_cow_increase(rcur->bc_mp, rcur->bc_ag.pag->pag_agno,\n\t\t\tagbno, aglen);\n\n\t \n\treturn xfs_refcount_adjust_cow(rcur, agbno, aglen,\n\t\t\tXFS_REFCOUNT_ADJUST_COW_ALLOC);\n}\n\n \nSTATIC int\n__xfs_refcount_cow_free(\n\tstruct xfs_btree_cur\t*rcur,\n\txfs_agblock_t\t\tagbno,\n\txfs_extlen_t\t\taglen)\n{\n\ttrace_xfs_refcount_cow_decrease(rcur->bc_mp, rcur->bc_ag.pag->pag_agno,\n\t\t\tagbno, aglen);\n\n\t \n\treturn xfs_refcount_adjust_cow(rcur, agbno, aglen,\n\t\t\tXFS_REFCOUNT_ADJUST_COW_FREE);\n}\n\n \nvoid\nxfs_refcount_alloc_cow_extent(\n\tstruct xfs_trans\t\t*tp,\n\txfs_fsblock_t\t\t\tfsb,\n\txfs_extlen_t\t\t\tlen)\n{\n\tstruct xfs_mount\t\t*mp = tp->t_mountp;\n\n\tif (!xfs_has_reflink(mp))\n\t\treturn;\n\n\t__xfs_refcount_add(tp, XFS_REFCOUNT_ALLOC_COW, fsb, len);\n\n\t \n\txfs_rmap_alloc_extent(tp, XFS_FSB_TO_AGNO(mp, fsb),\n\t\t\tXFS_FSB_TO_AGBNO(mp, fsb), len, XFS_RMAP_OWN_COW);\n}\n\n \nvoid\nxfs_refcount_free_cow_extent(\n\tstruct xfs_trans\t\t*tp,\n\txfs_fsblock_t\t\t\tfsb,\n\txfs_extlen_t\t\t\tlen)\n{\n\tstruct xfs_mount\t\t*mp = tp->t_mountp;\n\n\tif (!xfs_has_reflink(mp))\n\t\treturn;\n\n\t \n\txfs_rmap_free_extent(tp, XFS_FSB_TO_AGNO(mp, fsb),\n\t\t\tXFS_FSB_TO_AGBNO(mp, fsb), len, XFS_RMAP_OWN_COW);\n\t__xfs_refcount_add(tp, XFS_REFCOUNT_FREE_COW, fsb, len);\n}\n\nstruct xfs_refcount_recovery {\n\tstruct list_head\t\trr_list;\n\tstruct xfs_refcount_irec\trr_rrec;\n};\n\n \nSTATIC int\nxfs_refcount_recover_extent(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_rec\t*rec,\n\tvoid\t\t\t\t*priv)\n{\n\tstruct list_head\t\t*debris = priv;\n\tstruct xfs_refcount_recovery\t*rr;\n\n\tif (XFS_IS_CORRUPT(cur->bc_mp,\n\t\t\t   be32_to_cpu(rec->refc.rc_refcount) != 1))\n\t\treturn -EFSCORRUPTED;\n\n\trr = kmalloc(sizeof(struct xfs_refcount_recovery),\n\t\t\tGFP_KERNEL | __GFP_NOFAIL);\n\tINIT_LIST_HEAD(&rr->rr_list);\n\txfs_refcount_btrec_to_irec(rec, &rr->rr_rrec);\n\n\tif (xfs_refcount_check_irec(cur, &rr->rr_rrec) != NULL ||\n\t    XFS_IS_CORRUPT(cur->bc_mp,\n\t\t\t   rr->rr_rrec.rc_domain != XFS_REFC_DOMAIN_COW)) {\n\t\tkfree(rr);\n\t\treturn -EFSCORRUPTED;\n\t}\n\n\tlist_add_tail(&rr->rr_list, debris);\n\treturn 0;\n}\n\n \nint\nxfs_refcount_recover_cow_leftovers(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_perag\t\t*pag)\n{\n\tstruct xfs_trans\t\t*tp;\n\tstruct xfs_btree_cur\t\t*cur;\n\tstruct xfs_buf\t\t\t*agbp;\n\tstruct xfs_refcount_recovery\t*rr, *n;\n\tstruct list_head\t\tdebris;\n\tunion xfs_btree_irec\t\tlow = {\n\t\t.rc.rc_domain\t\t= XFS_REFC_DOMAIN_COW,\n\t};\n\tunion xfs_btree_irec\t\thigh = {\n\t\t.rc.rc_domain\t\t= XFS_REFC_DOMAIN_COW,\n\t\t.rc.rc_startblock\t= -1U,\n\t};\n\txfs_fsblock_t\t\t\tfsb;\n\tint\t\t\t\terror;\n\n\t \n\tBUILD_BUG_ON(XFS_MAX_CRC_AG_BLOCKS >= XFS_REFC_COWFLAG);\n\tif (mp->m_sb.sb_agblocks > XFS_MAX_CRC_AG_BLOCKS)\n\t\treturn -EOPNOTSUPP;\n\n\tINIT_LIST_HEAD(&debris);\n\n\t \n\terror = xfs_trans_alloc_empty(mp, &tp);\n\tif (error)\n\t\treturn error;\n\n\terror = xfs_alloc_read_agf(pag, tp, 0, &agbp);\n\tif (error)\n\t\tgoto out_trans;\n\tcur = xfs_refcountbt_init_cursor(mp, tp, agbp, pag);\n\n\t \n\terror = xfs_btree_query_range(cur, &low, &high,\n\t\t\txfs_refcount_recover_extent, &debris);\n\txfs_btree_del_cursor(cur, error);\n\txfs_trans_brelse(tp, agbp);\n\txfs_trans_cancel(tp);\n\tif (error)\n\t\tgoto out_free;\n\n\t \n\tlist_for_each_entry_safe(rr, n, &debris, rr_list) {\n\t\t \n\t\terror = xfs_trans_alloc(mp, &M_RES(mp)->tr_write, 0, 0, 0, &tp);\n\t\tif (error)\n\t\t\tgoto out_free;\n\n\t\ttrace_xfs_refcount_recover_extent(mp, pag->pag_agno,\n\t\t\t\t&rr->rr_rrec);\n\n\t\t \n\t\tfsb = XFS_AGB_TO_FSB(mp, pag->pag_agno,\n\t\t\t\trr->rr_rrec.rc_startblock);\n\t\txfs_refcount_free_cow_extent(tp, fsb,\n\t\t\t\trr->rr_rrec.rc_blockcount);\n\n\t\t \n\t\terror = xfs_free_extent_later(tp, fsb,\n\t\t\t\trr->rr_rrec.rc_blockcount, NULL,\n\t\t\t\tXFS_AG_RESV_NONE);\n\t\tif (error)\n\t\t\tgoto out_trans;\n\n\t\terror = xfs_trans_commit(tp);\n\t\tif (error)\n\t\t\tgoto out_free;\n\n\t\tlist_del(&rr->rr_list);\n\t\tkfree(rr);\n\t}\n\n\treturn error;\nout_trans:\n\txfs_trans_cancel(tp);\nout_free:\n\t \n\tlist_for_each_entry_safe(rr, n, &debris, rr_list) {\n\t\tlist_del(&rr->rr_list);\n\t\tkfree(rr);\n\t}\n\treturn error;\n}\n\n \nint\nxfs_refcount_has_records(\n\tstruct xfs_btree_cur\t*cur,\n\tenum xfs_refc_domain\tdomain,\n\txfs_agblock_t\t\tbno,\n\txfs_extlen_t\t\tlen,\n\tenum xbtree_recpacking\t*outcome)\n{\n\tunion xfs_btree_irec\tlow;\n\tunion xfs_btree_irec\thigh;\n\n\tmemset(&low, 0, sizeof(low));\n\tlow.rc.rc_startblock = bno;\n\tmemset(&high, 0xFF, sizeof(high));\n\thigh.rc.rc_startblock = bno + len - 1;\n\tlow.rc.rc_domain = high.rc.rc_domain = domain;\n\n\treturn xfs_btree_has_records(cur, &low, &high, NULL, outcome);\n}\n\nint __init\nxfs_refcount_intent_init_cache(void)\n{\n\txfs_refcount_intent_cache = kmem_cache_create(\"xfs_refc_intent\",\n\t\t\tsizeof(struct xfs_refcount_intent),\n\t\t\t0, 0, NULL);\n\n\treturn xfs_refcount_intent_cache != NULL ? 0 : -ENOMEM;\n}\n\nvoid\nxfs_refcount_intent_destroy_cache(void)\n{\n\tkmem_cache_destroy(xfs_refcount_intent_cache);\n\txfs_refcount_intent_cache = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}