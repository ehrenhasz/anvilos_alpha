{
  "module_name": "xfs_refcount_btree.c",
  "hash_id": "1721b7c6ca62c18fe232d034a654e51ff35f9f9c00cf3ee112fecc75ce60d7dc",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_refcount_btree.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_btree_staging.h\"\n#include \"xfs_refcount_btree.h\"\n#include \"xfs_refcount.h\"\n#include \"xfs_alloc.h\"\n#include \"xfs_error.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_bit.h\"\n#include \"xfs_rmap.h\"\n#include \"xfs_ag.h\"\n\nstatic struct kmem_cache\t*xfs_refcountbt_cur_cache;\n\nstatic struct xfs_btree_cur *\nxfs_refcountbt_dup_cursor(\n\tstruct xfs_btree_cur\t*cur)\n{\n\treturn xfs_refcountbt_init_cursor(cur->bc_mp, cur->bc_tp,\n\t\t\tcur->bc_ag.agbp, cur->bc_ag.pag);\n}\n\nSTATIC void\nxfs_refcountbt_set_root(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_ptr\t*ptr,\n\tint\t\t\t\tinc)\n{\n\tstruct xfs_buf\t\t*agbp = cur->bc_ag.agbp;\n\tstruct xfs_agf\t\t*agf = agbp->b_addr;\n\tstruct xfs_perag\t*pag = agbp->b_pag;\n\n\tASSERT(ptr->s != 0);\n\n\tagf->agf_refcount_root = ptr->s;\n\tbe32_add_cpu(&agf->agf_refcount_level, inc);\n\tpag->pagf_refcount_level += inc;\n\n\txfs_alloc_log_agf(cur->bc_tp, agbp,\n\t\t\tXFS_AGF_REFCOUNT_ROOT | XFS_AGF_REFCOUNT_LEVEL);\n}\n\nSTATIC int\nxfs_refcountbt_alloc_block(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_ptr\t*start,\n\tunion xfs_btree_ptr\t\t*new,\n\tint\t\t\t\t*stat)\n{\n\tstruct xfs_buf\t\t*agbp = cur->bc_ag.agbp;\n\tstruct xfs_agf\t\t*agf = agbp->b_addr;\n\tstruct xfs_alloc_arg\targs;\t\t \n\tint\t\t\terror;\t\t \n\n\tmemset(&args, 0, sizeof(args));\n\targs.tp = cur->bc_tp;\n\targs.mp = cur->bc_mp;\n\targs.pag = cur->bc_ag.pag;\n\targs.oinfo = XFS_RMAP_OINFO_REFC;\n\targs.minlen = args.maxlen = args.prod = 1;\n\targs.resv = XFS_AG_RESV_METADATA;\n\n\terror = xfs_alloc_vextent_near_bno(&args,\n\t\t\tXFS_AGB_TO_FSB(args.mp, args.pag->pag_agno,\n\t\t\t\t\txfs_refc_block(args.mp)));\n\tif (error)\n\t\tgoto out_error;\n\ttrace_xfs_refcountbt_alloc_block(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\targs.agbno, 1);\n\tif (args.fsbno == NULLFSBLOCK) {\n\t\t*stat = 0;\n\t\treturn 0;\n\t}\n\tASSERT(args.agno == cur->bc_ag.pag->pag_agno);\n\tASSERT(args.len == 1);\n\n\tnew->s = cpu_to_be32(args.agbno);\n\tbe32_add_cpu(&agf->agf_refcount_blocks, 1);\n\txfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_REFCOUNT_BLOCKS);\n\n\t*stat = 1;\n\treturn 0;\n\nout_error:\n\treturn error;\n}\n\nSTATIC int\nxfs_refcountbt_free_block(\n\tstruct xfs_btree_cur\t*cur,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = cur->bc_mp;\n\tstruct xfs_buf\t\t*agbp = cur->bc_ag.agbp;\n\tstruct xfs_agf\t\t*agf = agbp->b_addr;\n\txfs_fsblock_t\t\tfsbno = XFS_DADDR_TO_FSB(mp, xfs_buf_daddr(bp));\n\n\ttrace_xfs_refcountbt_free_block(cur->bc_mp, cur->bc_ag.pag->pag_agno,\n\t\t\tXFS_FSB_TO_AGBNO(cur->bc_mp, fsbno), 1);\n\tbe32_add_cpu(&agf->agf_refcount_blocks, -1);\n\txfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_REFCOUNT_BLOCKS);\n\treturn xfs_free_extent_later(cur->bc_tp, fsbno, 1,\n\t\t\t&XFS_RMAP_OINFO_REFC, XFS_AG_RESV_METADATA);\n}\n\nSTATIC int\nxfs_refcountbt_get_minrecs(\n\tstruct xfs_btree_cur\t*cur,\n\tint\t\t\tlevel)\n{\n\treturn cur->bc_mp->m_refc_mnr[level != 0];\n}\n\nSTATIC int\nxfs_refcountbt_get_maxrecs(\n\tstruct xfs_btree_cur\t*cur,\n\tint\t\t\tlevel)\n{\n\treturn cur->bc_mp->m_refc_mxr[level != 0];\n}\n\nSTATIC void\nxfs_refcountbt_init_key_from_rec(\n\tunion xfs_btree_key\t\t*key,\n\tconst union xfs_btree_rec\t*rec)\n{\n\tkey->refc.rc_startblock = rec->refc.rc_startblock;\n}\n\nSTATIC void\nxfs_refcountbt_init_high_key_from_rec(\n\tunion xfs_btree_key\t\t*key,\n\tconst union xfs_btree_rec\t*rec)\n{\n\t__u32\t\t\t\tx;\n\n\tx = be32_to_cpu(rec->refc.rc_startblock);\n\tx += be32_to_cpu(rec->refc.rc_blockcount) - 1;\n\tkey->refc.rc_startblock = cpu_to_be32(x);\n}\n\nSTATIC void\nxfs_refcountbt_init_rec_from_cur(\n\tstruct xfs_btree_cur\t*cur,\n\tunion xfs_btree_rec\t*rec)\n{\n\tconst struct xfs_refcount_irec *irec = &cur->bc_rec.rc;\n\tuint32_t\t\tstart;\n\n\tstart = xfs_refcount_encode_startblock(irec->rc_startblock,\n\t\t\tirec->rc_domain);\n\trec->refc.rc_startblock = cpu_to_be32(start);\n\trec->refc.rc_blockcount = cpu_to_be32(cur->bc_rec.rc.rc_blockcount);\n\trec->refc.rc_refcount = cpu_to_be32(cur->bc_rec.rc.rc_refcount);\n}\n\nSTATIC void\nxfs_refcountbt_init_ptr_from_cur(\n\tstruct xfs_btree_cur\t*cur,\n\tunion xfs_btree_ptr\t*ptr)\n{\n\tstruct xfs_agf\t\t*agf = cur->bc_ag.agbp->b_addr;\n\n\tASSERT(cur->bc_ag.pag->pag_agno == be32_to_cpu(agf->agf_seqno));\n\n\tptr->s = agf->agf_refcount_root;\n}\n\nSTATIC int64_t\nxfs_refcountbt_key_diff(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*key)\n{\n\tconst struct xfs_refcount_key\t*kp = &key->refc;\n\tconst struct xfs_refcount_irec\t*irec = &cur->bc_rec.rc;\n\tuint32_t\t\t\tstart;\n\n\tstart = xfs_refcount_encode_startblock(irec->rc_startblock,\n\t\t\tirec->rc_domain);\n\treturn (int64_t)be32_to_cpu(kp->rc_startblock) - start;\n}\n\nSTATIC int64_t\nxfs_refcountbt_diff_two_keys(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*k1,\n\tconst union xfs_btree_key\t*k2,\n\tconst union xfs_btree_key\t*mask)\n{\n\tASSERT(!mask || mask->refc.rc_startblock);\n\n\treturn (int64_t)be32_to_cpu(k1->refc.rc_startblock) -\n\t\t\tbe32_to_cpu(k2->refc.rc_startblock);\n}\n\nSTATIC xfs_failaddr_t\nxfs_refcountbt_verify(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\tstruct xfs_btree_block\t*block = XFS_BUF_TO_BLOCK(bp);\n\tstruct xfs_perag\t*pag = bp->b_pag;\n\txfs_failaddr_t\t\tfa;\n\tunsigned int\t\tlevel;\n\n\tif (!xfs_verify_magic(bp, block->bb_magic))\n\t\treturn __this_address;\n\n\tif (!xfs_has_reflink(mp))\n\t\treturn __this_address;\n\tfa = xfs_btree_sblock_v5hdr_verify(bp);\n\tif (fa)\n\t\treturn fa;\n\n\tlevel = be16_to_cpu(block->bb_level);\n\tif (pag && xfs_perag_initialised_agf(pag)) {\n\t\tif (level >= pag->pagf_refcount_level)\n\t\t\treturn __this_address;\n\t} else if (level >= mp->m_refc_maxlevels)\n\t\treturn __this_address;\n\n\treturn xfs_btree_sblock_verify(bp, mp->m_refc_mxr[level != 0]);\n}\n\nSTATIC void\nxfs_refcountbt_read_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_failaddr_t\tfa;\n\n\tif (!xfs_btree_sblock_verify_crc(bp))\n\t\txfs_verifier_error(bp, -EFSBADCRC, __this_address);\n\telse {\n\t\tfa = xfs_refcountbt_verify(bp);\n\t\tif (fa)\n\t\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t}\n\n\tif (bp->b_error)\n\t\ttrace_xfs_btree_corrupt(bp, _RET_IP_);\n}\n\nSTATIC void\nxfs_refcountbt_write_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_failaddr_t\tfa;\n\n\tfa = xfs_refcountbt_verify(bp);\n\tif (fa) {\n\t\ttrace_xfs_btree_corrupt(bp, _RET_IP_);\n\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t\treturn;\n\t}\n\txfs_btree_sblock_calc_crc(bp);\n\n}\n\nconst struct xfs_buf_ops xfs_refcountbt_buf_ops = {\n\t.name\t\t\t= \"xfs_refcountbt\",\n\t.magic\t\t\t= { 0, cpu_to_be32(XFS_REFC_CRC_MAGIC) },\n\t.verify_read\t\t= xfs_refcountbt_read_verify,\n\t.verify_write\t\t= xfs_refcountbt_write_verify,\n\t.verify_struct\t\t= xfs_refcountbt_verify,\n};\n\nSTATIC int\nxfs_refcountbt_keys_inorder(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*k1,\n\tconst union xfs_btree_key\t*k2)\n{\n\treturn be32_to_cpu(k1->refc.rc_startblock) <\n\t       be32_to_cpu(k2->refc.rc_startblock);\n}\n\nSTATIC int\nxfs_refcountbt_recs_inorder(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_rec\t*r1,\n\tconst union xfs_btree_rec\t*r2)\n{\n\treturn  be32_to_cpu(r1->refc.rc_startblock) +\n\t\tbe32_to_cpu(r1->refc.rc_blockcount) <=\n\t\tbe32_to_cpu(r2->refc.rc_startblock);\n}\n\nSTATIC enum xbtree_key_contig\nxfs_refcountbt_keys_contiguous(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*key1,\n\tconst union xfs_btree_key\t*key2,\n\tconst union xfs_btree_key\t*mask)\n{\n\tASSERT(!mask || mask->refc.rc_startblock);\n\n\treturn xbtree_key_contig(be32_to_cpu(key1->refc.rc_startblock),\n\t\t\t\t be32_to_cpu(key2->refc.rc_startblock));\n}\n\nstatic const struct xfs_btree_ops xfs_refcountbt_ops = {\n\t.rec_len\t\t= sizeof(struct xfs_refcount_rec),\n\t.key_len\t\t= sizeof(struct xfs_refcount_key),\n\n\t.dup_cursor\t\t= xfs_refcountbt_dup_cursor,\n\t.set_root\t\t= xfs_refcountbt_set_root,\n\t.alloc_block\t\t= xfs_refcountbt_alloc_block,\n\t.free_block\t\t= xfs_refcountbt_free_block,\n\t.get_minrecs\t\t= xfs_refcountbt_get_minrecs,\n\t.get_maxrecs\t\t= xfs_refcountbt_get_maxrecs,\n\t.init_key_from_rec\t= xfs_refcountbt_init_key_from_rec,\n\t.init_high_key_from_rec\t= xfs_refcountbt_init_high_key_from_rec,\n\t.init_rec_from_cur\t= xfs_refcountbt_init_rec_from_cur,\n\t.init_ptr_from_cur\t= xfs_refcountbt_init_ptr_from_cur,\n\t.key_diff\t\t= xfs_refcountbt_key_diff,\n\t.buf_ops\t\t= &xfs_refcountbt_buf_ops,\n\t.diff_two_keys\t\t= xfs_refcountbt_diff_two_keys,\n\t.keys_inorder\t\t= xfs_refcountbt_keys_inorder,\n\t.recs_inorder\t\t= xfs_refcountbt_recs_inorder,\n\t.keys_contiguous\t= xfs_refcountbt_keys_contiguous,\n};\n\n \nstatic struct xfs_btree_cur *\nxfs_refcountbt_init_common(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_perag\t*pag)\n{\n\tstruct xfs_btree_cur\t*cur;\n\n\tASSERT(pag->pag_agno < mp->m_sb.sb_agcount);\n\n\tcur = xfs_btree_alloc_cursor(mp, tp, XFS_BTNUM_REFC,\n\t\t\tmp->m_refc_maxlevels, xfs_refcountbt_cur_cache);\n\tcur->bc_statoff = XFS_STATS_CALC_INDEX(xs_refcbt_2);\n\n\tcur->bc_flags |= XFS_BTREE_CRC_BLOCKS;\n\n\tcur->bc_ag.pag = xfs_perag_hold(pag);\n\tcur->bc_ag.refc.nr_ops = 0;\n\tcur->bc_ag.refc.shape_changes = 0;\n\tcur->bc_ops = &xfs_refcountbt_ops;\n\treturn cur;\n}\n\n \nstruct xfs_btree_cur *\nxfs_refcountbt_init_cursor(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*agbp,\n\tstruct xfs_perag\t*pag)\n{\n\tstruct xfs_agf\t\t*agf = agbp->b_addr;\n\tstruct xfs_btree_cur\t*cur;\n\n\tcur = xfs_refcountbt_init_common(mp, tp, pag);\n\tcur->bc_nlevels = be32_to_cpu(agf->agf_refcount_level);\n\tcur->bc_ag.agbp = agbp;\n\treturn cur;\n}\n\n \nstruct xfs_btree_cur *\nxfs_refcountbt_stage_cursor(\n\tstruct xfs_mount\t*mp,\n\tstruct xbtree_afakeroot\t*afake,\n\tstruct xfs_perag\t*pag)\n{\n\tstruct xfs_btree_cur\t*cur;\n\n\tcur = xfs_refcountbt_init_common(mp, NULL, pag);\n\txfs_btree_stage_afakeroot(cur, afake);\n\treturn cur;\n}\n\n \nvoid\nxfs_refcountbt_commit_staged_btree(\n\tstruct xfs_btree_cur\t*cur,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*agbp)\n{\n\tstruct xfs_agf\t\t*agf = agbp->b_addr;\n\tstruct xbtree_afakeroot\t*afake = cur->bc_ag.afake;\n\n\tASSERT(cur->bc_flags & XFS_BTREE_STAGING);\n\n\tagf->agf_refcount_root = cpu_to_be32(afake->af_root);\n\tagf->agf_refcount_level = cpu_to_be32(afake->af_levels);\n\tagf->agf_refcount_blocks = cpu_to_be32(afake->af_blocks);\n\txfs_alloc_log_agf(tp, agbp, XFS_AGF_REFCOUNT_BLOCKS |\n\t\t\t\t    XFS_AGF_REFCOUNT_ROOT |\n\t\t\t\t    XFS_AGF_REFCOUNT_LEVEL);\n\txfs_btree_commit_afakeroot(cur, tp, agbp, &xfs_refcountbt_ops);\n}\n\n \nstatic inline unsigned int\nxfs_refcountbt_block_maxrecs(\n\tunsigned int\t\tblocklen,\n\tbool\t\t\tleaf)\n{\n\tif (leaf)\n\t\treturn blocklen / sizeof(struct xfs_refcount_rec);\n\treturn blocklen / (sizeof(struct xfs_refcount_key) +\n\t\t\t   sizeof(xfs_refcount_ptr_t));\n}\n\n \nint\nxfs_refcountbt_maxrecs(\n\tint\t\t\tblocklen,\n\tbool\t\t\tleaf)\n{\n\tblocklen -= XFS_REFCOUNT_BLOCK_LEN;\n\treturn xfs_refcountbt_block_maxrecs(blocklen, leaf);\n}\n\n \nunsigned int\nxfs_refcountbt_maxlevels_ondisk(void)\n{\n\tunsigned int\t\tminrecs[2];\n\tunsigned int\t\tblocklen;\n\n\tblocklen = XFS_MIN_CRC_BLOCKSIZE - XFS_BTREE_SBLOCK_CRC_LEN;\n\n\tminrecs[0] = xfs_refcountbt_block_maxrecs(blocklen, true) / 2;\n\tminrecs[1] = xfs_refcountbt_block_maxrecs(blocklen, false) / 2;\n\n\treturn xfs_btree_compute_maxlevels(minrecs, XFS_MAX_CRC_AG_BLOCKS);\n}\n\n \nvoid\nxfs_refcountbt_compute_maxlevels(\n\tstruct xfs_mount\t\t*mp)\n{\n\tif (!xfs_has_reflink(mp)) {\n\t\tmp->m_refc_maxlevels = 0;\n\t\treturn;\n\t}\n\n\tmp->m_refc_maxlevels = xfs_btree_compute_maxlevels(\n\t\t\tmp->m_refc_mnr, mp->m_sb.sb_agblocks);\n\tASSERT(mp->m_refc_maxlevels <= xfs_refcountbt_maxlevels_ondisk());\n}\n\n \nxfs_extlen_t\nxfs_refcountbt_calc_size(\n\tstruct xfs_mount\t*mp,\n\tunsigned long long\tlen)\n{\n\treturn xfs_btree_calc_size(mp->m_refc_mnr, len);\n}\n\n \nxfs_extlen_t\nxfs_refcountbt_max_size(\n\tstruct xfs_mount\t*mp,\n\txfs_agblock_t\t\tagblocks)\n{\n\t \n\tif (mp->m_refc_mxr[0] == 0)\n\t\treturn 0;\n\n\treturn xfs_refcountbt_calc_size(mp, agblocks);\n}\n\n \nint\nxfs_refcountbt_calc_reserves(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_perag\t*pag,\n\txfs_extlen_t\t\t*ask,\n\txfs_extlen_t\t\t*used)\n{\n\tstruct xfs_buf\t\t*agbp;\n\tstruct xfs_agf\t\t*agf;\n\txfs_agblock_t\t\tagblocks;\n\txfs_extlen_t\t\ttree_len;\n\tint\t\t\terror;\n\n\tif (!xfs_has_reflink(mp))\n\t\treturn 0;\n\n\terror = xfs_alloc_read_agf(pag, tp, 0, &agbp);\n\tif (error)\n\t\treturn error;\n\n\tagf = agbp->b_addr;\n\tagblocks = be32_to_cpu(agf->agf_length);\n\ttree_len = be32_to_cpu(agf->agf_refcount_blocks);\n\txfs_trans_brelse(tp, agbp);\n\n\t \n\tif (xfs_ag_contains_log(mp, pag->pag_agno))\n\t\tagblocks -= mp->m_sb.sb_logblocks;\n\n\t*ask += xfs_refcountbt_max_size(mp, agblocks);\n\t*used += tree_len;\n\n\treturn error;\n}\n\nint __init\nxfs_refcountbt_init_cur_cache(void)\n{\n\txfs_refcountbt_cur_cache = kmem_cache_create(\"xfs_refcbt_cur\",\n\t\t\txfs_btree_cur_sizeof(xfs_refcountbt_maxlevels_ondisk()),\n\t\t\t0, 0, NULL);\n\n\tif (!xfs_refcountbt_cur_cache)\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n\nvoid\nxfs_refcountbt_destroy_cur_cache(void)\n{\n\tkmem_cache_destroy(xfs_refcountbt_cur_cache);\n\txfs_refcountbt_cur_cache = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}