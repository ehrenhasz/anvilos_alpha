{
  "module_name": "xfs_bmap_btree.c",
  "hash_id": "c3a6e364ad620711ddeac08880c1abb827a7f8159419441305c1ee11eb27b72a",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_bmap_btree.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_bit.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_alloc.h\"\n#include \"xfs_btree.h\"\n#include \"xfs_bmap_btree.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_error.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_rmap.h\"\n#include \"xfs_ag.h\"\n\nstatic struct kmem_cache\t*xfs_bmbt_cur_cache;\n\n \nvoid\nxfs_bmdr_to_bmbt(\n\tstruct xfs_inode\t*ip,\n\txfs_bmdr_block_t\t*dblock,\n\tint\t\t\tdblocklen,\n\tstruct xfs_btree_block\t*rblock,\n\tint\t\t\trblocklen)\n{\n\tstruct xfs_mount\t*mp = ip->i_mount;\n\tint\t\t\tdmxr;\n\txfs_bmbt_key_t\t\t*fkp;\n\t__be64\t\t\t*fpp;\n\txfs_bmbt_key_t\t\t*tkp;\n\t__be64\t\t\t*tpp;\n\n\txfs_btree_init_block_int(mp, rblock, XFS_BUF_DADDR_NULL,\n\t\t\t\t XFS_BTNUM_BMAP, 0, 0, ip->i_ino,\n\t\t\t\t XFS_BTREE_LONG_PTRS);\n\trblock->bb_level = dblock->bb_level;\n\tASSERT(be16_to_cpu(rblock->bb_level) > 0);\n\trblock->bb_numrecs = dblock->bb_numrecs;\n\tdmxr = xfs_bmdr_maxrecs(dblocklen, 0);\n\tfkp = XFS_BMDR_KEY_ADDR(dblock, 1);\n\ttkp = XFS_BMBT_KEY_ADDR(mp, rblock, 1);\n\tfpp = XFS_BMDR_PTR_ADDR(dblock, 1, dmxr);\n\ttpp = XFS_BMAP_BROOT_PTR_ADDR(mp, rblock, 1, rblocklen);\n\tdmxr = be16_to_cpu(dblock->bb_numrecs);\n\tmemcpy(tkp, fkp, sizeof(*fkp) * dmxr);\n\tmemcpy(tpp, fpp, sizeof(*fpp) * dmxr);\n}\n\nvoid\nxfs_bmbt_disk_get_all(\n\tconst struct xfs_bmbt_rec *rec,\n\tstruct xfs_bmbt_irec\t*irec)\n{\n\tuint64_t\t\tl0 = get_unaligned_be64(&rec->l0);\n\tuint64_t\t\tl1 = get_unaligned_be64(&rec->l1);\n\n\tirec->br_startoff = (l0 & xfs_mask64lo(64 - BMBT_EXNTFLAG_BITLEN)) >> 9;\n\tirec->br_startblock = ((l0 & xfs_mask64lo(9)) << 43) | (l1 >> 21);\n\tirec->br_blockcount = l1 & xfs_mask64lo(21);\n\tif (l0 >> (64 - BMBT_EXNTFLAG_BITLEN))\n\t\tirec->br_state = XFS_EXT_UNWRITTEN;\n\telse\n\t\tirec->br_state = XFS_EXT_NORM;\n}\n\n \nxfs_filblks_t\nxfs_bmbt_disk_get_blockcount(\n\tconst struct xfs_bmbt_rec\t*r)\n{\n\treturn (xfs_filblks_t)(be64_to_cpu(r->l1) & xfs_mask64lo(21));\n}\n\n \nxfs_fileoff_t\nxfs_bmbt_disk_get_startoff(\n\tconst struct xfs_bmbt_rec\t*r)\n{\n\treturn ((xfs_fileoff_t)be64_to_cpu(r->l0) &\n\t\t xfs_mask64lo(64 - BMBT_EXNTFLAG_BITLEN)) >> 9;\n}\n\n \nvoid\nxfs_bmbt_disk_set_all(\n\tstruct xfs_bmbt_rec\t*r,\n\tstruct xfs_bmbt_irec\t*s)\n{\n\tint\t\t\textent_flag = (s->br_state != XFS_EXT_NORM);\n\n\tASSERT(s->br_state == XFS_EXT_NORM || s->br_state == XFS_EXT_UNWRITTEN);\n\tASSERT(!(s->br_startoff & xfs_mask64hi(64-BMBT_STARTOFF_BITLEN)));\n\tASSERT(!(s->br_blockcount & xfs_mask64hi(64-BMBT_BLOCKCOUNT_BITLEN)));\n\tASSERT(!(s->br_startblock & xfs_mask64hi(64-BMBT_STARTBLOCK_BITLEN)));\n\n\tput_unaligned_be64(\n\t\t((xfs_bmbt_rec_base_t)extent_flag << 63) |\n\t\t ((xfs_bmbt_rec_base_t)s->br_startoff << 9) |\n\t\t ((xfs_bmbt_rec_base_t)s->br_startblock >> 43), &r->l0);\n\tput_unaligned_be64(\n\t\t((xfs_bmbt_rec_base_t)s->br_startblock << 21) |\n\t\t ((xfs_bmbt_rec_base_t)s->br_blockcount &\n\t\t  (xfs_bmbt_rec_base_t)xfs_mask64lo(21)), &r->l1);\n}\n\n \nvoid\nxfs_bmbt_to_bmdr(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_btree_block\t*rblock,\n\tint\t\t\trblocklen,\n\txfs_bmdr_block_t\t*dblock,\n\tint\t\t\tdblocklen)\n{\n\tint\t\t\tdmxr;\n\txfs_bmbt_key_t\t\t*fkp;\n\t__be64\t\t\t*fpp;\n\txfs_bmbt_key_t\t\t*tkp;\n\t__be64\t\t\t*tpp;\n\n\tif (xfs_has_crc(mp)) {\n\t\tASSERT(rblock->bb_magic == cpu_to_be32(XFS_BMAP_CRC_MAGIC));\n\t\tASSERT(uuid_equal(&rblock->bb_u.l.bb_uuid,\n\t\t       &mp->m_sb.sb_meta_uuid));\n\t\tASSERT(rblock->bb_u.l.bb_blkno ==\n\t\t       cpu_to_be64(XFS_BUF_DADDR_NULL));\n\t} else\n\t\tASSERT(rblock->bb_magic == cpu_to_be32(XFS_BMAP_MAGIC));\n\tASSERT(rblock->bb_u.l.bb_leftsib == cpu_to_be64(NULLFSBLOCK));\n\tASSERT(rblock->bb_u.l.bb_rightsib == cpu_to_be64(NULLFSBLOCK));\n\tASSERT(rblock->bb_level != 0);\n\tdblock->bb_level = rblock->bb_level;\n\tdblock->bb_numrecs = rblock->bb_numrecs;\n\tdmxr = xfs_bmdr_maxrecs(dblocklen, 0);\n\tfkp = XFS_BMBT_KEY_ADDR(mp, rblock, 1);\n\ttkp = XFS_BMDR_KEY_ADDR(dblock, 1);\n\tfpp = XFS_BMAP_BROOT_PTR_ADDR(mp, rblock, 1, rblocklen);\n\ttpp = XFS_BMDR_PTR_ADDR(dblock, 1, dmxr);\n\tdmxr = be16_to_cpu(dblock->bb_numrecs);\n\tmemcpy(tkp, fkp, sizeof(*fkp) * dmxr);\n\tmemcpy(tpp, fpp, sizeof(*fpp) * dmxr);\n}\n\nSTATIC struct xfs_btree_cur *\nxfs_bmbt_dup_cursor(\n\tstruct xfs_btree_cur\t*cur)\n{\n\tstruct xfs_btree_cur\t*new;\n\n\tnew = xfs_bmbt_init_cursor(cur->bc_mp, cur->bc_tp,\n\t\t\tcur->bc_ino.ip, cur->bc_ino.whichfork);\n\n\t \n\tnew->bc_ino.flags = cur->bc_ino.flags;\n\n\treturn new;\n}\n\nSTATIC void\nxfs_bmbt_update_cursor(\n\tstruct xfs_btree_cur\t*src,\n\tstruct xfs_btree_cur\t*dst)\n{\n\tASSERT((dst->bc_tp->t_highest_agno != NULLAGNUMBER) ||\n\t       (dst->bc_ino.ip->i_diflags & XFS_DIFLAG_REALTIME));\n\n\tdst->bc_ino.allocated += src->bc_ino.allocated;\n\tdst->bc_tp->t_highest_agno = src->bc_tp->t_highest_agno;\n\n\tsrc->bc_ino.allocated = 0;\n}\n\nSTATIC int\nxfs_bmbt_alloc_block(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_ptr\t*start,\n\tunion xfs_btree_ptr\t\t*new,\n\tint\t\t\t\t*stat)\n{\n\tstruct xfs_alloc_arg\targs;\n\tint\t\t\terror;\n\n\tmemset(&args, 0, sizeof(args));\n\targs.tp = cur->bc_tp;\n\targs.mp = cur->bc_mp;\n\txfs_rmap_ino_bmbt_owner(&args.oinfo, cur->bc_ino.ip->i_ino,\n\t\t\tcur->bc_ino.whichfork);\n\targs.minlen = args.maxlen = args.prod = 1;\n\targs.wasdel = cur->bc_ino.flags & XFS_BTCUR_BMBT_WASDEL;\n\tif (!args.wasdel && args.tp->t_blk_res == 0)\n\t\treturn -ENOSPC;\n\n\t \n\tif (cur->bc_tp->t_highest_agno == NULLAGNUMBER)\n\t\targs.minleft = xfs_bmapi_minleft(cur->bc_tp, cur->bc_ino.ip,\n\t\t\t\t\tcur->bc_ino.whichfork);\n\n\terror = xfs_alloc_vextent_start_ag(&args, be64_to_cpu(start->l));\n\tif (error)\n\t\treturn error;\n\n\tif (args.fsbno == NULLFSBLOCK && args.minleft) {\n\t\t \n\t\targs.minleft = 0;\n\t\terror = xfs_alloc_vextent_start_ag(&args, 0);\n\t\tif (error)\n\t\t\treturn error;\n\t\tcur->bc_tp->t_flags |= XFS_TRANS_LOWMODE;\n\t}\n\tif (WARN_ON_ONCE(args.fsbno == NULLFSBLOCK)) {\n\t\t*stat = 0;\n\t\treturn 0;\n\t}\n\n\tASSERT(args.len == 1);\n\tcur->bc_ino.allocated++;\n\tcur->bc_ino.ip->i_nblocks++;\n\txfs_trans_log_inode(args.tp, cur->bc_ino.ip, XFS_ILOG_CORE);\n\txfs_trans_mod_dquot_byino(args.tp, cur->bc_ino.ip,\n\t\t\tXFS_TRANS_DQ_BCOUNT, 1L);\n\n\tnew->l = cpu_to_be64(args.fsbno);\n\n\t*stat = 1;\n\treturn 0;\n}\n\nSTATIC int\nxfs_bmbt_free_block(\n\tstruct xfs_btree_cur\t*cur,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = cur->bc_mp;\n\tstruct xfs_inode\t*ip = cur->bc_ino.ip;\n\tstruct xfs_trans\t*tp = cur->bc_tp;\n\txfs_fsblock_t\t\tfsbno = XFS_DADDR_TO_FSB(mp, xfs_buf_daddr(bp));\n\tstruct xfs_owner_info\toinfo;\n\tint\t\t\terror;\n\n\txfs_rmap_ino_bmbt_owner(&oinfo, ip->i_ino, cur->bc_ino.whichfork);\n\terror = xfs_free_extent_later(cur->bc_tp, fsbno, 1, &oinfo,\n\t\t\tXFS_AG_RESV_NONE);\n\tif (error)\n\t\treturn error;\n\n\tip->i_nblocks--;\n\txfs_trans_log_inode(tp, ip, XFS_ILOG_CORE);\n\txfs_trans_mod_dquot_byino(tp, ip, XFS_TRANS_DQ_BCOUNT, -1L);\n\treturn 0;\n}\n\nSTATIC int\nxfs_bmbt_get_minrecs(\n\tstruct xfs_btree_cur\t*cur,\n\tint\t\t\tlevel)\n{\n\tif (level == cur->bc_nlevels - 1) {\n\t\tstruct xfs_ifork\t*ifp;\n\n\t\tifp = xfs_ifork_ptr(cur->bc_ino.ip,\n\t\t\t\t    cur->bc_ino.whichfork);\n\n\t\treturn xfs_bmbt_maxrecs(cur->bc_mp,\n\t\t\t\t\tifp->if_broot_bytes, level == 0) / 2;\n\t}\n\n\treturn cur->bc_mp->m_bmap_dmnr[level != 0];\n}\n\nint\nxfs_bmbt_get_maxrecs(\n\tstruct xfs_btree_cur\t*cur,\n\tint\t\t\tlevel)\n{\n\tif (level == cur->bc_nlevels - 1) {\n\t\tstruct xfs_ifork\t*ifp;\n\n\t\tifp = xfs_ifork_ptr(cur->bc_ino.ip,\n\t\t\t\t    cur->bc_ino.whichfork);\n\n\t\treturn xfs_bmbt_maxrecs(cur->bc_mp,\n\t\t\t\t\tifp->if_broot_bytes, level == 0);\n\t}\n\n\treturn cur->bc_mp->m_bmap_dmxr[level != 0];\n\n}\n\n \nSTATIC int\nxfs_bmbt_get_dmaxrecs(\n\tstruct xfs_btree_cur\t*cur,\n\tint\t\t\tlevel)\n{\n\tif (level != cur->bc_nlevels - 1)\n\t\treturn cur->bc_mp->m_bmap_dmxr[level != 0];\n\treturn xfs_bmdr_maxrecs(cur->bc_ino.forksize, level == 0);\n}\n\nSTATIC void\nxfs_bmbt_init_key_from_rec(\n\tunion xfs_btree_key\t\t*key,\n\tconst union xfs_btree_rec\t*rec)\n{\n\tkey->bmbt.br_startoff =\n\t\tcpu_to_be64(xfs_bmbt_disk_get_startoff(&rec->bmbt));\n}\n\nSTATIC void\nxfs_bmbt_init_high_key_from_rec(\n\tunion xfs_btree_key\t\t*key,\n\tconst union xfs_btree_rec\t*rec)\n{\n\tkey->bmbt.br_startoff = cpu_to_be64(\n\t\t\txfs_bmbt_disk_get_startoff(&rec->bmbt) +\n\t\t\txfs_bmbt_disk_get_blockcount(&rec->bmbt) - 1);\n}\n\nSTATIC void\nxfs_bmbt_init_rec_from_cur(\n\tstruct xfs_btree_cur\t*cur,\n\tunion xfs_btree_rec\t*rec)\n{\n\txfs_bmbt_disk_set_all(&rec->bmbt, &cur->bc_rec.b);\n}\n\nSTATIC void\nxfs_bmbt_init_ptr_from_cur(\n\tstruct xfs_btree_cur\t*cur,\n\tunion xfs_btree_ptr\t*ptr)\n{\n\tptr->l = 0;\n}\n\nSTATIC int64_t\nxfs_bmbt_key_diff(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*key)\n{\n\treturn (int64_t)be64_to_cpu(key->bmbt.br_startoff) -\n\t\t\t\t      cur->bc_rec.b.br_startoff;\n}\n\nSTATIC int64_t\nxfs_bmbt_diff_two_keys(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*k1,\n\tconst union xfs_btree_key\t*k2,\n\tconst union xfs_btree_key\t*mask)\n{\n\tuint64_t\t\t\ta = be64_to_cpu(k1->bmbt.br_startoff);\n\tuint64_t\t\t\tb = be64_to_cpu(k2->bmbt.br_startoff);\n\n\tASSERT(!mask || mask->bmbt.br_startoff);\n\n\t \n\tif (a > b)\n\t\treturn 1;\n\tif (b > a)\n\t\treturn -1;\n\treturn 0;\n}\n\nstatic xfs_failaddr_t\nxfs_bmbt_verify(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\tstruct xfs_btree_block\t*block = XFS_BUF_TO_BLOCK(bp);\n\txfs_failaddr_t\t\tfa;\n\tunsigned int\t\tlevel;\n\n\tif (!xfs_verify_magic(bp, block->bb_magic))\n\t\treturn __this_address;\n\n\tif (xfs_has_crc(mp)) {\n\t\t \n\t\tfa = xfs_btree_lblock_v5hdr_verify(bp, XFS_RMAP_OWN_UNKNOWN);\n\t\tif (fa)\n\t\t\treturn fa;\n\t}\n\n\t \n\tlevel = be16_to_cpu(block->bb_level);\n\tif (level > max(mp->m_bm_maxlevels[0], mp->m_bm_maxlevels[1]))\n\t\treturn __this_address;\n\n\treturn xfs_btree_lblock_verify(bp, mp->m_bmap_dmxr[level != 0]);\n}\n\nstatic void\nxfs_bmbt_read_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_failaddr_t\tfa;\n\n\tif (!xfs_btree_lblock_verify_crc(bp))\n\t\txfs_verifier_error(bp, -EFSBADCRC, __this_address);\n\telse {\n\t\tfa = xfs_bmbt_verify(bp);\n\t\tif (fa)\n\t\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t}\n\n\tif (bp->b_error)\n\t\ttrace_xfs_btree_corrupt(bp, _RET_IP_);\n}\n\nstatic void\nxfs_bmbt_write_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_failaddr_t\tfa;\n\n\tfa = xfs_bmbt_verify(bp);\n\tif (fa) {\n\t\ttrace_xfs_btree_corrupt(bp, _RET_IP_);\n\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t\treturn;\n\t}\n\txfs_btree_lblock_calc_crc(bp);\n}\n\nconst struct xfs_buf_ops xfs_bmbt_buf_ops = {\n\t.name = \"xfs_bmbt\",\n\t.magic = { cpu_to_be32(XFS_BMAP_MAGIC),\n\t\t   cpu_to_be32(XFS_BMAP_CRC_MAGIC) },\n\t.verify_read = xfs_bmbt_read_verify,\n\t.verify_write = xfs_bmbt_write_verify,\n\t.verify_struct = xfs_bmbt_verify,\n};\n\n\nSTATIC int\nxfs_bmbt_keys_inorder(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*k1,\n\tconst union xfs_btree_key\t*k2)\n{\n\treturn be64_to_cpu(k1->bmbt.br_startoff) <\n\t\tbe64_to_cpu(k2->bmbt.br_startoff);\n}\n\nSTATIC int\nxfs_bmbt_recs_inorder(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_rec\t*r1,\n\tconst union xfs_btree_rec\t*r2)\n{\n\treturn xfs_bmbt_disk_get_startoff(&r1->bmbt) +\n\t\txfs_bmbt_disk_get_blockcount(&r1->bmbt) <=\n\t\txfs_bmbt_disk_get_startoff(&r2->bmbt);\n}\n\nSTATIC enum xbtree_key_contig\nxfs_bmbt_keys_contiguous(\n\tstruct xfs_btree_cur\t\t*cur,\n\tconst union xfs_btree_key\t*key1,\n\tconst union xfs_btree_key\t*key2,\n\tconst union xfs_btree_key\t*mask)\n{\n\tASSERT(!mask || mask->bmbt.br_startoff);\n\n\treturn xbtree_key_contig(be64_to_cpu(key1->bmbt.br_startoff),\n\t\t\t\t be64_to_cpu(key2->bmbt.br_startoff));\n}\n\nstatic const struct xfs_btree_ops xfs_bmbt_ops = {\n\t.rec_len\t\t= sizeof(xfs_bmbt_rec_t),\n\t.key_len\t\t= sizeof(xfs_bmbt_key_t),\n\n\t.dup_cursor\t\t= xfs_bmbt_dup_cursor,\n\t.update_cursor\t\t= xfs_bmbt_update_cursor,\n\t.alloc_block\t\t= xfs_bmbt_alloc_block,\n\t.free_block\t\t= xfs_bmbt_free_block,\n\t.get_maxrecs\t\t= xfs_bmbt_get_maxrecs,\n\t.get_minrecs\t\t= xfs_bmbt_get_minrecs,\n\t.get_dmaxrecs\t\t= xfs_bmbt_get_dmaxrecs,\n\t.init_key_from_rec\t= xfs_bmbt_init_key_from_rec,\n\t.init_high_key_from_rec\t= xfs_bmbt_init_high_key_from_rec,\n\t.init_rec_from_cur\t= xfs_bmbt_init_rec_from_cur,\n\t.init_ptr_from_cur\t= xfs_bmbt_init_ptr_from_cur,\n\t.key_diff\t\t= xfs_bmbt_key_diff,\n\t.diff_two_keys\t\t= xfs_bmbt_diff_two_keys,\n\t.buf_ops\t\t= &xfs_bmbt_buf_ops,\n\t.keys_inorder\t\t= xfs_bmbt_keys_inorder,\n\t.recs_inorder\t\t= xfs_bmbt_recs_inorder,\n\t.keys_contiguous\t= xfs_bmbt_keys_contiguous,\n};\n\n \nstruct xfs_btree_cur *\t\t\t\t \nxfs_bmbt_init_cursor(\n\tstruct xfs_mount\t*mp,\t\t \n\tstruct xfs_trans\t*tp,\t\t \n\tstruct xfs_inode\t*ip,\t\t \n\tint\t\t\twhichfork)\t \n{\n\tstruct xfs_ifork\t*ifp = xfs_ifork_ptr(ip, whichfork);\n\tstruct xfs_btree_cur\t*cur;\n\tASSERT(whichfork != XFS_COW_FORK);\n\n\tcur = xfs_btree_alloc_cursor(mp, tp, XFS_BTNUM_BMAP,\n\t\t\tmp->m_bm_maxlevels[whichfork], xfs_bmbt_cur_cache);\n\tcur->bc_nlevels = be16_to_cpu(ifp->if_broot->bb_level) + 1;\n\tcur->bc_statoff = XFS_STATS_CALC_INDEX(xs_bmbt_2);\n\n\tcur->bc_ops = &xfs_bmbt_ops;\n\tcur->bc_flags = XFS_BTREE_LONG_PTRS | XFS_BTREE_ROOT_IN_INODE;\n\tif (xfs_has_crc(mp))\n\t\tcur->bc_flags |= XFS_BTREE_CRC_BLOCKS;\n\n\tcur->bc_ino.forksize = xfs_inode_fork_size(ip, whichfork);\n\tcur->bc_ino.ip = ip;\n\tcur->bc_ino.allocated = 0;\n\tcur->bc_ino.flags = 0;\n\tcur->bc_ino.whichfork = whichfork;\n\n\treturn cur;\n}\n\n \nstatic inline unsigned int\nxfs_bmbt_block_maxrecs(\n\tunsigned int\t\tblocklen,\n\tbool\t\t\tleaf)\n{\n\tif (leaf)\n\t\treturn blocklen / sizeof(xfs_bmbt_rec_t);\n\treturn blocklen / (sizeof(xfs_bmbt_key_t) + sizeof(xfs_bmbt_ptr_t));\n}\n\n \nint\nxfs_bmbt_maxrecs(\n\tstruct xfs_mount\t*mp,\n\tint\t\t\tblocklen,\n\tint\t\t\tleaf)\n{\n\tblocklen -= XFS_BMBT_BLOCK_LEN(mp);\n\treturn xfs_bmbt_block_maxrecs(blocklen, leaf);\n}\n\n \nunsigned int\nxfs_bmbt_maxlevels_ondisk(void)\n{\n\tunsigned int\t\tminrecs[2];\n\tunsigned int\t\tblocklen;\n\n\tblocklen = min(XFS_MIN_BLOCKSIZE - XFS_BTREE_SBLOCK_LEN,\n\t\t       XFS_MIN_CRC_BLOCKSIZE - XFS_BTREE_SBLOCK_CRC_LEN);\n\n\tminrecs[0] = xfs_bmbt_block_maxrecs(blocklen, true) / 2;\n\tminrecs[1] = xfs_bmbt_block_maxrecs(blocklen, false) / 2;\n\n\t \n\treturn xfs_btree_compute_maxlevels(minrecs,\n\t\t\tXFS_MAX_EXTCNT_DATA_FORK_LARGE) + 1;\n}\n\n \nint\nxfs_bmdr_maxrecs(\n\tint\t\t\tblocklen,\n\tint\t\t\tleaf)\n{\n\tblocklen -= sizeof(xfs_bmdr_block_t);\n\n\tif (leaf)\n\t\treturn blocklen / sizeof(xfs_bmdr_rec_t);\n\treturn blocklen / (sizeof(xfs_bmdr_key_t) + sizeof(xfs_bmdr_ptr_t));\n}\n\n \nint\nxfs_bmbt_change_owner(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*ip,\n\tint\t\t\twhichfork,\n\txfs_ino_t\t\tnew_owner,\n\tstruct list_head\t*buffer_list)\n{\n\tstruct xfs_btree_cur\t*cur;\n\tint\t\t\terror;\n\n\tASSERT(tp || buffer_list);\n\tASSERT(!(tp && buffer_list));\n\tASSERT(xfs_ifork_ptr(ip, whichfork)->if_format == XFS_DINODE_FMT_BTREE);\n\n\tcur = xfs_bmbt_init_cursor(ip->i_mount, tp, ip, whichfork);\n\tcur->bc_ino.flags |= XFS_BTCUR_BMBT_INVALID_OWNER;\n\n\terror = xfs_btree_change_owner(cur, new_owner, buffer_list);\n\txfs_btree_del_cursor(cur, error);\n\treturn error;\n}\n\n \nunsigned long long\nxfs_bmbt_calc_size(\n\tstruct xfs_mount\t*mp,\n\tunsigned long long\tlen)\n{\n\treturn xfs_btree_calc_size(mp->m_bmap_dmnr, len);\n}\n\nint __init\nxfs_bmbt_init_cur_cache(void)\n{\n\txfs_bmbt_cur_cache = kmem_cache_create(\"xfs_bmbt_cur\",\n\t\t\txfs_btree_cur_sizeof(xfs_bmbt_maxlevels_ondisk()),\n\t\t\t0, 0, NULL);\n\n\tif (!xfs_bmbt_cur_cache)\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n\nvoid\nxfs_bmbt_destroy_cur_cache(void)\n{\n\tkmem_cache_destroy(xfs_bmbt_cur_cache);\n\txfs_bmbt_cur_cache = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}