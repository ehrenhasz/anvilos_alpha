{
  "module_name": "xfs_dir2_sf.c",
  "hash_id": "401cd9a35053ca15cddb03a9bcc1814bd2325c42dfacf2fcc9763812c8f0866b",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_dir2_sf.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_dir2.h\"\n#include \"xfs_dir2_priv.h\"\n#include \"xfs_trace.h\"\n\n \nstatic void xfs_dir2_sf_addname_easy(xfs_da_args_t *args,\n\t\t\t\t     xfs_dir2_sf_entry_t *sfep,\n\t\t\t\t     xfs_dir2_data_aoff_t offset,\n\t\t\t\t     int new_isize);\nstatic void xfs_dir2_sf_addname_hard(xfs_da_args_t *args, int objchange,\n\t\t\t\t     int new_isize);\nstatic int xfs_dir2_sf_addname_pick(xfs_da_args_t *args, int objchange,\n\t\t\t\t    xfs_dir2_sf_entry_t **sfepp,\n\t\t\t\t    xfs_dir2_data_aoff_t *offsetp);\n#ifdef DEBUG\nstatic void xfs_dir2_sf_check(xfs_da_args_t *args);\n#else\n#define\txfs_dir2_sf_check(args)\n#endif  \n\nstatic void xfs_dir2_sf_toino4(xfs_da_args_t *args);\nstatic void xfs_dir2_sf_toino8(xfs_da_args_t *args);\n\nint\nxfs_dir2_sf_entsize(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dir2_sf_hdr\t*hdr,\n\tint\t\t\tlen)\n{\n\tint\t\t\tcount = len;\n\n\tcount += sizeof(struct xfs_dir2_sf_entry);\t \n\tcount += hdr->i8count ? XFS_INO64_SIZE : XFS_INO32_SIZE;  \n\n\tif (xfs_has_ftype(mp))\n\t\tcount += sizeof(uint8_t);\n\treturn count;\n}\n\nstruct xfs_dir2_sf_entry *\nxfs_dir2_sf_nextentry(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dir2_sf_hdr\t*hdr,\n\tstruct xfs_dir2_sf_entry *sfep)\n{\n\treturn (void *)sfep + xfs_dir2_sf_entsize(mp, hdr, sfep->namelen);\n}\n\n \nxfs_ino_t\nxfs_dir2_sf_get_ino(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_dir2_sf_hdr\t\t*hdr,\n\tstruct xfs_dir2_sf_entry\t*sfep)\n{\n\tuint8_t\t\t\t\t*from = sfep->name + sfep->namelen;\n\n\tif (xfs_has_ftype(mp))\n\t\tfrom++;\n\n\tif (!hdr->i8count)\n\t\treturn get_unaligned_be32(from);\n\treturn get_unaligned_be64(from) & XFS_MAXINUMBER;\n}\n\nvoid\nxfs_dir2_sf_put_ino(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_dir2_sf_hdr\t\t*hdr,\n\tstruct xfs_dir2_sf_entry\t*sfep,\n\txfs_ino_t\t\t\tino)\n{\n\tuint8_t\t\t\t\t*to = sfep->name + sfep->namelen;\n\n\tASSERT(ino <= XFS_MAXINUMBER);\n\n\tif (xfs_has_ftype(mp))\n\t\tto++;\n\n\tif (hdr->i8count)\n\t\tput_unaligned_be64(ino, to);\n\telse\n\t\tput_unaligned_be32(ino, to);\n}\n\nxfs_ino_t\nxfs_dir2_sf_get_parent_ino(\n\tstruct xfs_dir2_sf_hdr\t*hdr)\n{\n\tif (!hdr->i8count)\n\t\treturn get_unaligned_be32(hdr->parent);\n\treturn get_unaligned_be64(hdr->parent) & XFS_MAXINUMBER;\n}\n\nvoid\nxfs_dir2_sf_put_parent_ino(\n\tstruct xfs_dir2_sf_hdr\t\t*hdr,\n\txfs_ino_t\t\t\tino)\n{\n\tASSERT(ino <= XFS_MAXINUMBER);\n\n\tif (hdr->i8count)\n\t\tput_unaligned_be64(ino, hdr->parent);\n\telse\n\t\tput_unaligned_be32(ino, hdr->parent);\n}\n\n \nuint8_t\nxfs_dir2_sf_get_ftype(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_dir2_sf_entry\t*sfep)\n{\n\tif (xfs_has_ftype(mp)) {\n\t\tuint8_t\t\t\tftype = sfep->name[sfep->namelen];\n\n\t\tif (ftype < XFS_DIR3_FT_MAX)\n\t\t\treturn ftype;\n\t}\n\n\treturn XFS_DIR3_FT_UNKNOWN;\n}\n\nvoid\nxfs_dir2_sf_put_ftype(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dir2_sf_entry *sfep,\n\tuint8_t\t\t\tftype)\n{\n\tASSERT(ftype < XFS_DIR3_FT_MAX);\n\n\tif (xfs_has_ftype(mp))\n\t\tsfep->name[sfep->namelen] = ftype;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_sfsize(\n\txfs_inode_t\t\t*dp,\t\t \n\txfs_dir2_data_hdr_t\t*hdr,\t\t \n\txfs_dir2_sf_hdr_t\t*sfhp)\t\t \n{\n\txfs_dir2_dataptr_t\taddr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\tint\t\t\tcount;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\tint\t\t\ti;\t\t \n\tint\t\t\ti8count;\t \n\tint\t\t\tisdot;\t\t \n\tint\t\t\tisdotdot;\t \n\txfs_mount_t\t\t*mp;\t\t \n\tint\t\t\tnamelen;\t \n\txfs_ino_t\t\tparent = 0;\t \n\tint\t\t\tsize=0;\t\t \n\tint\t\t\thas_ftype;\n\tstruct xfs_da_geometry\t*geo;\n\n\tmp = dp->i_mount;\n\tgeo = mp->m_dir_geo;\n\n\t \n\thas_ftype = xfs_has_ftype(mp) ? 1 : 0;\n\n\tcount = i8count = namelen = 0;\n\tbtp = xfs_dir2_block_tail_p(geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\n\t \n\tfor (i = 0; i < be32_to_cpu(btp->count); i++) {\n\t\tif ((addr = be32_to_cpu(blp[i].address)) == XFS_DIR2_NULL_DATAPTR)\n\t\t\tcontinue;\n\t\t \n\t\tdep = (xfs_dir2_data_entry_t *)((char *)hdr +\n\t\t\t\txfs_dir2_dataptr_to_off(geo, addr));\n\t\t \n\t\tisdot = dep->namelen == 1 && dep->name[0] == '.';\n\t\tisdotdot =\n\t\t\tdep->namelen == 2 &&\n\t\t\tdep->name[0] == '.' && dep->name[1] == '.';\n\n\t\tif (!isdot)\n\t\t\ti8count += be64_to_cpu(dep->inumber) > XFS_DIR2_MAX_SHORT_INUM;\n\n\t\t \n\t\tif (!isdot && !isdotdot) {\n\t\t\tcount++;\n\t\t\tnamelen += dep->namelen + has_ftype;\n\t\t} else if (isdotdot)\n\t\t\tparent = be64_to_cpu(dep->inumber);\n\t\t \n\t\tsize = xfs_dir2_sf_hdr_size(i8count) +\t \n\t\t       count * 3 * sizeof(u8) +\t\t \n\t\t       namelen +\t\t\t \n\t\t       (i8count ?\t\t\t \n\t\t\t\tcount * XFS_INO64_SIZE :\n\t\t\t\tcount * XFS_INO32_SIZE);\n\t\tif (size > xfs_inode_data_fork_size(dp))\n\t\t\treturn size;\t\t \n\t}\n\t \n\tsfhp->count = count;\n\tsfhp->i8count = i8count;\n\txfs_dir2_sf_put_parent_ino(sfhp, parent);\n\treturn size;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_to_sf(\n\tstruct xfs_da_args\t*args,\t\t \n\tstruct xfs_buf\t\t*bp,\n\tint\t\t\tsize,\t\t \n\tstruct xfs_dir2_sf_hdr\t*sfhp)\t\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\terror;\t\t \n\tint\t\t\tlogflags;\t \n\tstruct xfs_dir2_sf_entry *sfep;\t\t \n\tstruct xfs_dir2_sf_hdr\t*sfp;\t\t \n\tunsigned int\t\toffset = args->geo->data_entry_offset;\n\tunsigned int\t\tend;\n\n\ttrace_xfs_dir2_block_to_sf(args);\n\n\t \n\tsfp = kmem_alloc(mp->m_sb.sb_inodesize, 0);\n\tmemcpy(sfp, sfhp, xfs_dir2_sf_hdr_size(sfhp->i8count));\n\n\t \n\tend = xfs_dir3_data_end_offset(args->geo, bp->b_addr);\n\tsfep = xfs_dir2_sf_firstentry(sfp);\n\twhile (offset < end) {\n\t\tstruct xfs_dir2_data_unused\t*dup = bp->b_addr + offset;\n\t\tstruct xfs_dir2_data_entry\t*dep = bp->b_addr + offset;\n\n\t\t \n\t\tif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t\toffset += be16_to_cpu(dup->length);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (dep->namelen == 1 && dep->name[0] == '.')\n\t\t\tASSERT(be64_to_cpu(dep->inumber) == dp->i_ino);\n\t\t \n\t\telse if (dep->namelen == 2 &&\n\t\t\t dep->name[0] == '.' && dep->name[1] == '.')\n\t\t\tASSERT(be64_to_cpu(dep->inumber) ==\n\t\t\t       xfs_dir2_sf_get_parent_ino(sfp));\n\t\t \n\t\telse {\n\t\t\tsfep->namelen = dep->namelen;\n\t\t\txfs_dir2_sf_put_offset(sfep, offset);\n\t\t\tmemcpy(sfep->name, dep->name, dep->namelen);\n\t\t\txfs_dir2_sf_put_ino(mp, sfp, sfep,\n\t\t\t\t\t      be64_to_cpu(dep->inumber));\n\t\t\txfs_dir2_sf_put_ftype(mp, sfep,\n\t\t\t\t\txfs_dir2_data_get_ftype(mp, dep));\n\n\t\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t\t}\n\t\toffset += xfs_dir2_data_entsize(mp, dep->namelen);\n\t}\n\tASSERT((char *)sfep - (char *)sfp == size);\n\n\t \n\tlogflags = XFS_ILOG_CORE;\n\terror = xfs_dir2_shrink_inode(args, args->geo->datablk, bp);\n\tif (error) {\n\t\tASSERT(error != -ENOSPC);\n\t\tgoto out;\n\t}\n\n\t \n\tASSERT(dp->i_df.if_bytes == 0);\n\txfs_init_local_fork(dp, XFS_DATA_FORK, sfp, size);\n\tdp->i_df.if_format = XFS_DINODE_FMT_LOCAL;\n\tdp->i_disk_size = size;\n\n\tlogflags |= XFS_ILOG_DDATA;\n\txfs_dir2_sf_check(args);\nout:\n\txfs_trans_log_inode(args->trans, dp, logflags);\n\tkmem_free(sfp);\n\treturn error;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_sf_addname(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tincr_isize;\t \n\tint\t\t\tnew_isize;\t \n\tint\t\t\tobjchange;\t \n\txfs_dir2_data_aoff_t\toffset = 0;\t \n\tint\t\t\tpick;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\txfs_dir2_sf_entry_t\t*sfep = NULL;\t \n\n\ttrace_xfs_dir2_sf_addname(args);\n\n\tASSERT(xfs_dir2_sf_lookup(args) == -ENOENT);\n\tdp = args->dp;\n\tASSERT(dp->i_df.if_format == XFS_DINODE_FMT_LOCAL);\n\tASSERT(dp->i_disk_size >= offsetof(struct xfs_dir2_sf_hdr, parent));\n\tASSERT(dp->i_df.if_bytes == dp->i_disk_size);\n\tASSERT(dp->i_df.if_u1.if_data != NULL);\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tASSERT(dp->i_disk_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\n\t \n\tincr_isize = xfs_dir2_sf_entsize(dp->i_mount, sfp, args->namelen);\n\tobjchange = 0;\n\n\t \n\tif (args->inumber > XFS_DIR2_MAX_SHORT_INUM && sfp->i8count == 0) {\n\t\t \n\t\tincr_isize += (sfp->count + 2) * XFS_INO64_DIFF;\n\t\tobjchange = 1;\n\t}\n\n\tnew_isize = (int)dp->i_disk_size + incr_isize;\n\t \n\tif (new_isize > xfs_inode_data_fork_size(dp) ||\n\t    (pick =\n\t     xfs_dir2_sf_addname_pick(args, objchange, &sfep, &offset)) == 0) {\n\t\t \n\t\tif ((args->op_flags & XFS_DA_OP_JUSTCHECK) || args->total == 0)\n\t\t\treturn -ENOSPC;\n\t\t \n\t\terror = xfs_dir2_sf_to_block(args);\n\t\tif (error)\n\t\t\treturn error;\n\t\treturn xfs_dir2_block_addname(args);\n\t}\n\t \n\tif (args->op_flags & XFS_DA_OP_JUSTCHECK)\n\t\treturn 0;\n\t \n\tif (pick == 1)\n\t\txfs_dir2_sf_addname_easy(args, sfep, offset, new_isize);\n\t \n\telse {\n\t\tASSERT(pick == 2);\n\t\tif (objchange)\n\t\t\txfs_dir2_sf_toino8(args);\n\t\txfs_dir2_sf_addname_hard(args, objchange, new_isize);\n\t}\n\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\n\treturn 0;\n}\n\n \nstatic void\nxfs_dir2_sf_addname_easy(\n\txfs_da_args_t\t\t*args,\t\t \n\txfs_dir2_sf_entry_t\t*sfep,\t\t \n\txfs_dir2_data_aoff_t\toffset,\t\t \n\tint\t\t\tnew_isize)\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\tbyteoff;\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tbyteoff = (int)((char *)sfep - (char *)sfp);\n\t \n\txfs_idata_realloc(dp, xfs_dir2_sf_entsize(mp, sfp, args->namelen),\n\t\t\t  XFS_DATA_FORK);\n\t \n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tsfep = (xfs_dir2_sf_entry_t *)((char *)sfp + byteoff);\n\t \n\tsfep->namelen = args->namelen;\n\txfs_dir2_sf_put_offset(sfep, offset);\n\tmemcpy(sfep->name, args->name, sfep->namelen);\n\txfs_dir2_sf_put_ino(mp, sfp, sfep, args->inumber);\n\txfs_dir2_sf_put_ftype(mp, sfep, args->filetype);\n\n\t \n\tsfp->count++;\n\tif (args->inumber > XFS_DIR2_MAX_SHORT_INUM)\n\t\tsfp->i8count++;\n\tdp->i_disk_size = new_isize;\n\txfs_dir2_sf_check(args);\n}\n\n \n \nstatic void\nxfs_dir2_sf_addname_hard(\n\txfs_da_args_t\t\t*args,\t\t \n\tint\t\t\tobjchange,\t \n\tint\t\t\tnew_isize)\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\tadd_datasize;\t \n\tchar\t\t\t*buf;\t\t \n\tint\t\t\teof;\t\t \n\tint\t\t\tnbytes;\t\t \n\txfs_dir2_data_aoff_t\tnew_offset;\t \n\txfs_dir2_data_aoff_t\toffset;\t\t \n\tint\t\t\told_isize;\t \n\txfs_dir2_sf_entry_t\t*oldsfep;\t \n\txfs_dir2_sf_hdr_t\t*oldsfp;\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\t \n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\told_isize = (int)dp->i_disk_size;\n\tbuf = kmem_alloc(old_isize, 0);\n\toldsfp = (xfs_dir2_sf_hdr_t *)buf;\n\tmemcpy(oldsfp, sfp, old_isize);\n\t \n\tfor (offset = args->geo->data_first_offset,\n\t      oldsfep = xfs_dir2_sf_firstentry(oldsfp),\n\t      add_datasize = xfs_dir2_data_entsize(mp, args->namelen),\n\t      eof = (char *)oldsfep == &buf[old_isize];\n\t     !eof;\n\t     offset = new_offset + xfs_dir2_data_entsize(mp, oldsfep->namelen),\n\t      oldsfep = xfs_dir2_sf_nextentry(mp, oldsfp, oldsfep),\n\t      eof = (char *)oldsfep == &buf[old_isize]) {\n\t\tnew_offset = xfs_dir2_sf_get_offset(oldsfep);\n\t\tif (offset + add_datasize <= new_offset)\n\t\t\tbreak;\n\t}\n\t \n\txfs_idata_realloc(dp, -old_isize, XFS_DATA_FORK);\n\txfs_idata_realloc(dp, new_isize, XFS_DATA_FORK);\n\t \n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\t \n\tnbytes = (int)((char *)oldsfep - (char *)oldsfp);\n\tmemcpy(sfp, oldsfp, nbytes);\n\tsfep = (xfs_dir2_sf_entry_t *)((char *)sfp + nbytes);\n\t \n\tsfep->namelen = args->namelen;\n\txfs_dir2_sf_put_offset(sfep, offset);\n\tmemcpy(sfep->name, args->name, sfep->namelen);\n\txfs_dir2_sf_put_ino(mp, sfp, sfep, args->inumber);\n\txfs_dir2_sf_put_ftype(mp, sfep, args->filetype);\n\tsfp->count++;\n\tif (args->inumber > XFS_DIR2_MAX_SHORT_INUM && !objchange)\n\t\tsfp->i8count++;\n\t \n\tif (!eof) {\n\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t\tmemcpy(sfep, oldsfep, old_isize - nbytes);\n\t}\n\tkmem_free(buf);\n\tdp->i_disk_size = new_isize;\n\txfs_dir2_sf_check(args);\n}\n\n \n \nstatic int\t\t\t\t\t \nxfs_dir2_sf_addname_pick(\n\txfs_da_args_t\t\t*args,\t\t \n\tint\t\t\tobjchange,\t \n\txfs_dir2_sf_entry_t\t**sfepp,\t \n\txfs_dir2_data_aoff_t\t*offsetp)\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\tholefit;\t \n\tint\t\t\ti;\t\t \n\txfs_dir2_data_aoff_t\toffset;\t\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\tint\t\t\tsize;\t\t \n\tint\t\t\tused;\t\t \n\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tsize = xfs_dir2_data_entsize(mp, args->namelen);\n\toffset = args->geo->data_first_offset;\n\tsfep = xfs_dir2_sf_firstentry(sfp);\n\tholefit = 0;\n\t \n\tfor (i = 0; i < sfp->count; i++) {\n\t\tif (!holefit)\n\t\t\tholefit = offset + size <= xfs_dir2_sf_get_offset(sfep);\n\t\toffset = xfs_dir2_sf_get_offset(sfep) +\n\t\t\t xfs_dir2_data_entsize(mp, sfep->namelen);\n\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t}\n\t \n\tused = offset +\n\t       (sfp->count + 3) * (uint)sizeof(xfs_dir2_leaf_entry_t) +\n\t       (uint)sizeof(xfs_dir2_block_tail_t);\n\t \n\tif (used + (holefit ? 0 : size) > args->geo->blksize)\n\t\treturn 0;\n\t \n\tif (objchange)\n\t\treturn 2;\n\t \n\tif (used + size > args->geo->blksize)\n\t\treturn 2;\n\t \n\t*sfepp = sfep;\n\t*offsetp = offset;\n\treturn 1;\n}\n\n#ifdef DEBUG\n \nstatic void\nxfs_dir2_sf_check(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\ti;\t\t \n\tint\t\t\ti8count;\t \n\txfs_ino_t\t\tino;\t\t \n\tint\t\t\toffset;\t\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\toffset = args->geo->data_first_offset;\n\tino = xfs_dir2_sf_get_parent_ino(sfp);\n\ti8count = ino > XFS_DIR2_MAX_SHORT_INUM;\n\n\tfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp);\n\t     i < sfp->count;\n\t     i++, sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep)) {\n\t\tASSERT(xfs_dir2_sf_get_offset(sfep) >= offset);\n\t\tino = xfs_dir2_sf_get_ino(mp, sfp, sfep);\n\t\ti8count += ino > XFS_DIR2_MAX_SHORT_INUM;\n\t\toffset =\n\t\t\txfs_dir2_sf_get_offset(sfep) +\n\t\t\txfs_dir2_data_entsize(mp, sfep->namelen);\n\t\tASSERT(xfs_dir2_sf_get_ftype(mp, sfep) < XFS_DIR3_FT_MAX);\n\t}\n\tASSERT(i8count == sfp->i8count);\n\tASSERT((char *)sfep - (char *)sfp == dp->i_disk_size);\n\tASSERT(offset +\n\t       (sfp->count + 2) * (uint)sizeof(xfs_dir2_leaf_entry_t) +\n\t       (uint)sizeof(xfs_dir2_block_tail_t) <= args->geo->blksize);\n}\n#endif\t \n\n \nxfs_failaddr_t\nxfs_dir2_sf_verify(\n\tstruct xfs_inode\t\t*ip)\n{\n\tstruct xfs_mount\t\t*mp = ip->i_mount;\n\tstruct xfs_ifork\t\t*ifp = xfs_ifork_ptr(ip, XFS_DATA_FORK);\n\tstruct xfs_dir2_sf_hdr\t\t*sfp;\n\tstruct xfs_dir2_sf_entry\t*sfep;\n\tstruct xfs_dir2_sf_entry\t*next_sfep;\n\tchar\t\t\t\t*endp;\n\txfs_ino_t\t\t\tino;\n\tint\t\t\t\ti;\n\tint\t\t\t\ti8count;\n\tint\t\t\t\toffset;\n\tint64_t\t\t\t\tsize;\n\tint\t\t\t\terror;\n\tuint8_t\t\t\t\tfiletype;\n\n\tASSERT(ifp->if_format == XFS_DINODE_FMT_LOCAL);\n\n\tsfp = (struct xfs_dir2_sf_hdr *)ifp->if_u1.if_data;\n\tsize = ifp->if_bytes;\n\n\t \n\tif (size <= offsetof(struct xfs_dir2_sf_hdr, parent) ||\n\t    size < xfs_dir2_sf_hdr_size(sfp->i8count))\n\t\treturn __this_address;\n\n\tendp = (char *)sfp + size;\n\n\t \n\tino = xfs_dir2_sf_get_parent_ino(sfp);\n\ti8count = ino > XFS_DIR2_MAX_SHORT_INUM;\n\terror = xfs_dir_ino_validate(mp, ino);\n\tif (error)\n\t\treturn __this_address;\n\toffset = mp->m_dir_geo->data_first_offset;\n\n\t \n\tsfep = xfs_dir2_sf_firstentry(sfp);\n\tfor (i = 0; i < sfp->count; i++) {\n\t\t \n\t\tif (((char *)sfep + sizeof(*sfep)) >= endp)\n\t\t\treturn __this_address;\n\n\t\t \n\t\tif (sfep->namelen == 0)\n\t\t\treturn __this_address;\n\n\t\t \n\t\tnext_sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t\tif (endp < (char *)next_sfep)\n\t\t\treturn __this_address;\n\n\t\t \n\t\tif (xfs_dir2_sf_get_offset(sfep) < offset)\n\t\t\treturn __this_address;\n\n\t\t \n\t\tino = xfs_dir2_sf_get_ino(mp, sfp, sfep);\n\t\ti8count += ino > XFS_DIR2_MAX_SHORT_INUM;\n\t\terror = xfs_dir_ino_validate(mp, ino);\n\t\tif (error)\n\t\t\treturn __this_address;\n\n\t\t \n\t\tfiletype = xfs_dir2_sf_get_ftype(mp, sfep);\n\t\tif (filetype >= XFS_DIR3_FT_MAX)\n\t\t\treturn __this_address;\n\n\t\toffset = xfs_dir2_sf_get_offset(sfep) +\n\t\t\t\txfs_dir2_data_entsize(mp, sfep->namelen);\n\n\t\tsfep = next_sfep;\n\t}\n\tif (i8count != sfp->i8count)\n\t\treturn __this_address;\n\tif ((void *)sfep != (void *)endp)\n\t\treturn __this_address;\n\n\t \n\tif (offset + (sfp->count + 2) * (uint)sizeof(xfs_dir2_leaf_entry_t) +\n\t    (uint)sizeof(xfs_dir2_block_tail_t) > mp->m_dir_geo->blksize)\n\t\treturn __this_address;\n\n\treturn NULL;\n}\n\n \nint\t\t\t\t\t \nxfs_dir2_sf_create(\n\txfs_da_args_t\t*args,\t\t \n\txfs_ino_t\tpino)\t\t \n{\n\txfs_inode_t\t*dp;\t\t \n\tint\t\ti8count;\t \n\txfs_dir2_sf_hdr_t *sfp;\t\t \n\tint\t\tsize;\t\t \n\n\ttrace_xfs_dir2_sf_create(args);\n\n\tdp = args->dp;\n\n\tASSERT(dp != NULL);\n\tASSERT(dp->i_disk_size == 0);\n\t \n\tif (dp->i_df.if_format == XFS_DINODE_FMT_EXTENTS) {\n\t\tdp->i_df.if_format = XFS_DINODE_FMT_LOCAL;\n\t\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE);\n\t}\n\tASSERT(dp->i_df.if_format == XFS_DINODE_FMT_LOCAL);\n\tASSERT(dp->i_df.if_bytes == 0);\n\ti8count = pino > XFS_DIR2_MAX_SHORT_INUM;\n\tsize = xfs_dir2_sf_hdr_size(i8count);\n\t \n\txfs_idata_realloc(dp, size, XFS_DATA_FORK);\n\t \n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tsfp->i8count = i8count;\n\t \n\txfs_dir2_sf_put_parent_ino(sfp, pino);\n\tsfp->count = 0;\n\tdp->i_disk_size = size;\n\txfs_dir2_sf_check(args);\n\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\n\treturn 0;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_sf_lookup(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\ti;\t\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\tenum xfs_dacmp\t\tcmp;\t\t \n\txfs_dir2_sf_entry_t\t*ci_sfep;\t \n\n\ttrace_xfs_dir2_sf_lookup(args);\n\n\txfs_dir2_sf_check(args);\n\n\tASSERT(dp->i_df.if_format == XFS_DINODE_FMT_LOCAL);\n\tASSERT(dp->i_disk_size >= offsetof(struct xfs_dir2_sf_hdr, parent));\n\tASSERT(dp->i_df.if_bytes == dp->i_disk_size);\n\tASSERT(dp->i_df.if_u1.if_data != NULL);\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tASSERT(dp->i_disk_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\n\t \n\tif (args->namelen == 1 && args->name[0] == '.') {\n\t\targs->inumber = dp->i_ino;\n\t\targs->cmpresult = XFS_CMP_EXACT;\n\t\targs->filetype = XFS_DIR3_FT_DIR;\n\t\treturn -EEXIST;\n\t}\n\t \n\tif (args->namelen == 2 &&\n\t    args->name[0] == '.' && args->name[1] == '.') {\n\t\targs->inumber = xfs_dir2_sf_get_parent_ino(sfp);\n\t\targs->cmpresult = XFS_CMP_EXACT;\n\t\targs->filetype = XFS_DIR3_FT_DIR;\n\t\treturn -EEXIST;\n\t}\n\t \n\tci_sfep = NULL;\n\tfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp); i < sfp->count;\n\t     i++, sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep)) {\n\t\t \n\t\tcmp = xfs_dir2_compname(args, sfep->name, sfep->namelen);\n\t\tif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\n\t\t\targs->cmpresult = cmp;\n\t\t\targs->inumber = xfs_dir2_sf_get_ino(mp, sfp, sfep);\n\t\t\targs->filetype = xfs_dir2_sf_get_ftype(mp, sfep);\n\t\t\tif (cmp == XFS_CMP_EXACT)\n\t\t\t\treturn -EEXIST;\n\t\t\tci_sfep = sfep;\n\t\t}\n\t}\n\tASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\n\t \n\tif (!ci_sfep)\n\t\treturn -ENOENT;\n\t \n\treturn xfs_dir_cilookup_result(args, ci_sfep->name, ci_sfep->namelen);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_sf_removename(\n\txfs_da_args_t\t\t*args)\n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\tbyteoff;\t \n\tint\t\t\tentsize;\t \n\tint\t\t\ti;\t\t \n\tint\t\t\tnewsize;\t \n\tint\t\t\toldsize;\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\ttrace_xfs_dir2_sf_removename(args);\n\n\tASSERT(dp->i_df.if_format == XFS_DINODE_FMT_LOCAL);\n\toldsize = (int)dp->i_disk_size;\n\tASSERT(oldsize >= offsetof(struct xfs_dir2_sf_hdr, parent));\n\tASSERT(dp->i_df.if_bytes == oldsize);\n\tASSERT(dp->i_df.if_u1.if_data != NULL);\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tASSERT(oldsize >= xfs_dir2_sf_hdr_size(sfp->i8count));\n\t \n\tfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp); i < sfp->count;\n\t     i++, sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep)) {\n\t\tif (xfs_da_compname(args, sfep->name, sfep->namelen) ==\n\t\t\t\t\t\t\t\tXFS_CMP_EXACT) {\n\t\t\tASSERT(xfs_dir2_sf_get_ino(mp, sfp, sfep) ==\n\t\t\t       args->inumber);\n\t\t\tbreak;\n\t\t}\n\t}\n\t \n\tif (i == sfp->count)\n\t\treturn -ENOENT;\n\t \n\tbyteoff = (int)((char *)sfep - (char *)sfp);\n\tentsize = xfs_dir2_sf_entsize(mp, sfp, args->namelen);\n\tnewsize = oldsize - entsize;\n\t \n\tif (byteoff + entsize < oldsize)\n\t\tmemmove((char *)sfp + byteoff, (char *)sfp + byteoff + entsize,\n\t\t\toldsize - (byteoff + entsize));\n\t \n\tsfp->count--;\n\tdp->i_disk_size = newsize;\n\t \n\txfs_idata_realloc(dp, newsize - oldsize, XFS_DATA_FORK);\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\t \n\tif (args->inumber > XFS_DIR2_MAX_SHORT_INUM) {\n\t\tif (sfp->i8count == 1)\n\t\t\txfs_dir2_sf_toino4(args);\n\t\telse\n\t\t\tsfp->i8count--;\n\t}\n\txfs_dir2_sf_check(args);\n\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\n\treturn 0;\n}\n\n \nstatic bool\nxfs_dir2_sf_replace_needblock(\n\tstruct xfs_inode\t*dp,\n\txfs_ino_t\t\tinum)\n{\n\tint\t\t\tnewsize;\n\tstruct xfs_dir2_sf_hdr\t*sfp;\n\n\tif (dp->i_df.if_format != XFS_DINODE_FMT_LOCAL)\n\t\treturn false;\n\n\tsfp = (struct xfs_dir2_sf_hdr *)dp->i_df.if_u1.if_data;\n\tnewsize = dp->i_df.if_bytes + (sfp->count + 1) * XFS_INO64_DIFF;\n\n\treturn inum > XFS_DIR2_MAX_SHORT_INUM &&\n\t       sfp->i8count == 0 && newsize > xfs_inode_data_fork_size(dp);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_sf_replace(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tint\t\t\ti;\t\t \n\txfs_ino_t\t\tino=0;\t\t \n\tint\t\t\ti8elevated;\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\ttrace_xfs_dir2_sf_replace(args);\n\n\tASSERT(dp->i_df.if_format == XFS_DINODE_FMT_LOCAL);\n\tASSERT(dp->i_disk_size >= offsetof(struct xfs_dir2_sf_hdr, parent));\n\tASSERT(dp->i_df.if_bytes == dp->i_disk_size);\n\tASSERT(dp->i_df.if_u1.if_data != NULL);\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tASSERT(dp->i_disk_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\n\n\t \n\tif (args->inumber > XFS_DIR2_MAX_SHORT_INUM && sfp->i8count == 0) {\n\t\tint\terror;\t\t\t \n\n\t\t \n\t\tif (xfs_dir2_sf_replace_needblock(dp, args->inumber)) {\n\t\t\terror = xfs_dir2_sf_to_block(args);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t\treturn xfs_dir2_block_replace(args);\n\t\t}\n\t\t \n\t\txfs_dir2_sf_toino8(args);\n\t\ti8elevated = 1;\n\t\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\t} else\n\t\ti8elevated = 0;\n\n\tASSERT(args->namelen != 1 || args->name[0] != '.');\n\t \n\tif (args->namelen == 2 &&\n\t    args->name[0] == '.' && args->name[1] == '.') {\n\t\tino = xfs_dir2_sf_get_parent_ino(sfp);\n\t\tASSERT(args->inumber != ino);\n\t\txfs_dir2_sf_put_parent_ino(sfp, args->inumber);\n\t}\n\t \n\telse {\n\t\tfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp); i < sfp->count;\n\t\t     i++, sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep)) {\n\t\t\tif (xfs_da_compname(args, sfep->name, sfep->namelen) ==\n\t\t\t\t\t\t\t\tXFS_CMP_EXACT) {\n\t\t\t\tino = xfs_dir2_sf_get_ino(mp, sfp, sfep);\n\t\t\t\tASSERT(args->inumber != ino);\n\t\t\t\txfs_dir2_sf_put_ino(mp, sfp, sfep,\n\t\t\t\t\t\targs->inumber);\n\t\t\t\txfs_dir2_sf_put_ftype(mp, sfep, args->filetype);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (i == sfp->count) {\n\t\t\tASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\n\t\t\tif (i8elevated)\n\t\t\t\txfs_dir2_sf_toino4(args);\n\t\t\treturn -ENOENT;\n\t\t}\n\t}\n\t \n\tif (ino > XFS_DIR2_MAX_SHORT_INUM &&\n\t    args->inumber <= XFS_DIR2_MAX_SHORT_INUM) {\n\t\t \n\t\tif (sfp->i8count == 1)\n\t\t\txfs_dir2_sf_toino4(args);\n\t\telse\n\t\t\tsfp->i8count--;\n\t}\n\t \n\tif (ino <= XFS_DIR2_MAX_SHORT_INUM &&\n\t    args->inumber > XFS_DIR2_MAX_SHORT_INUM) {\n\t\t \n\t\tASSERT(sfp->i8count != 0);\n\t\tif (!i8elevated)\n\t\t\tsfp->i8count++;\n\t}\n\txfs_dir2_sf_check(args);\n\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_DDATA);\n\treturn 0;\n}\n\n \nstatic void\nxfs_dir2_sf_toino4(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tchar\t\t\t*buf;\t\t \n\tint\t\t\ti;\t\t \n\tint\t\t\tnewsize;\t \n\txfs_dir2_sf_entry_t\t*oldsfep;\t \n\txfs_dir2_sf_hdr_t\t*oldsfp;\t \n\tint\t\t\toldsize;\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\ttrace_xfs_dir2_sf_toino4(args);\n\n\t \n\toldsize = dp->i_df.if_bytes;\n\tbuf = kmem_alloc(oldsize, 0);\n\toldsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tASSERT(oldsfp->i8count == 1);\n\tmemcpy(buf, oldsfp, oldsize);\n\t \n\tnewsize = oldsize - (oldsfp->count + 1) * XFS_INO64_DIFF;\n\txfs_idata_realloc(dp, -oldsize, XFS_DATA_FORK);\n\txfs_idata_realloc(dp, newsize, XFS_DATA_FORK);\n\t \n\toldsfp = (xfs_dir2_sf_hdr_t *)buf;\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\t \n\tsfp->count = oldsfp->count;\n\tsfp->i8count = 0;\n\txfs_dir2_sf_put_parent_ino(sfp, xfs_dir2_sf_get_parent_ino(oldsfp));\n\t \n\tfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp),\n\t\t    oldsfep = xfs_dir2_sf_firstentry(oldsfp);\n\t     i < sfp->count;\n\t     i++, sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep),\n\t\t  oldsfep = xfs_dir2_sf_nextentry(mp, oldsfp, oldsfep)) {\n\t\tsfep->namelen = oldsfep->namelen;\n\t\tmemcpy(sfep->offset, oldsfep->offset, sizeof(sfep->offset));\n\t\tmemcpy(sfep->name, oldsfep->name, sfep->namelen);\n\t\txfs_dir2_sf_put_ino(mp, sfp, sfep,\n\t\t\t\txfs_dir2_sf_get_ino(mp, oldsfp, oldsfep));\n\t\txfs_dir2_sf_put_ftype(mp, sfep,\n\t\t\t\txfs_dir2_sf_get_ftype(mp, oldsfep));\n\t}\n\t \n\tkmem_free(buf);\n\tdp->i_disk_size = newsize;\n\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\n}\n\n \nstatic void\nxfs_dir2_sf_toino8(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tchar\t\t\t*buf;\t\t \n\tint\t\t\ti;\t\t \n\tint\t\t\tnewsize;\t \n\txfs_dir2_sf_entry_t\t*oldsfep;\t \n\txfs_dir2_sf_hdr_t\t*oldsfp;\t \n\tint\t\t\toldsize;\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\n\ttrace_xfs_dir2_sf_toino8(args);\n\n\t \n\toldsize = dp->i_df.if_bytes;\n\tbuf = kmem_alloc(oldsize, 0);\n\toldsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\tASSERT(oldsfp->i8count == 0);\n\tmemcpy(buf, oldsfp, oldsize);\n\t \n\tnewsize = oldsize + (oldsfp->count + 1) * XFS_INO64_DIFF;\n\txfs_idata_realloc(dp, -oldsize, XFS_DATA_FORK);\n\txfs_idata_realloc(dp, newsize, XFS_DATA_FORK);\n\t \n\toldsfp = (xfs_dir2_sf_hdr_t *)buf;\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\t \n\tsfp->count = oldsfp->count;\n\tsfp->i8count = 1;\n\txfs_dir2_sf_put_parent_ino(sfp, xfs_dir2_sf_get_parent_ino(oldsfp));\n\t \n\tfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp),\n\t\t    oldsfep = xfs_dir2_sf_firstentry(oldsfp);\n\t     i < sfp->count;\n\t     i++, sfep = xfs_dir2_sf_nextentry(mp, sfp, sfep),\n\t\t  oldsfep = xfs_dir2_sf_nextentry(mp, oldsfp, oldsfep)) {\n\t\tsfep->namelen = oldsfep->namelen;\n\t\tmemcpy(sfep->offset, oldsfep->offset, sizeof(sfep->offset));\n\t\tmemcpy(sfep->name, oldsfep->name, sfep->namelen);\n\t\txfs_dir2_sf_put_ino(mp, sfp, sfep,\n\t\t\t\txfs_dir2_sf_get_ino(mp, oldsfp, oldsfep));\n\t\txfs_dir2_sf_put_ftype(mp, sfep,\n\t\t\t\txfs_dir2_sf_get_ftype(mp, oldsfep));\n\t}\n\t \n\tkmem_free(buf);\n\tdp->i_disk_size = newsize;\n\txfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}