{
  "module_name": "xfs_rtbitmap.c",
  "hash_id": "6da33f8e52692bacf097c5f2a478e01d87a88de9f0feeeb1abfc3c173a84a3b5",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_rtbitmap.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_bit.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_rtalloc.h\"\n#include \"xfs_error.h\"\n\n \n\n \nstatic void\nxfs_rtbuf_verify_read(\n\tstruct xfs_buf\t*bp)\n{\n\treturn;\n}\n\nstatic void\nxfs_rtbuf_verify_write(\n\tstruct xfs_buf\t*bp)\n{\n\treturn;\n}\n\nconst struct xfs_buf_ops xfs_rtbuf_ops = {\n\t.name = \"rtbuf\",\n\t.verify_read = xfs_rtbuf_verify_read,\n\t.verify_write = xfs_rtbuf_verify_write,\n};\n\n \nint\nxfs_rtbuf_get(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tblock,\t\t \n\tint\t\tissum,\t\t \n\tstruct xfs_buf\t**bpp)\t\t \n{\n\tstruct xfs_buf\t*bp;\t\t \n\txfs_inode_t\t*ip;\t\t \n\txfs_bmbt_irec_t\tmap;\n\tint\t\tnmap = 1;\n\tint\t\terror;\t\t \n\n\tip = issum ? mp->m_rsumip : mp->m_rbmip;\n\n\terror = xfs_bmapi_read(ip, block, 1, &map, &nmap, 0);\n\tif (error)\n\t\treturn error;\n\n\tif (XFS_IS_CORRUPT(mp, nmap == 0 || !xfs_bmap_is_written_extent(&map)))\n\t\treturn -EFSCORRUPTED;\n\n\tASSERT(map.br_startblock != NULLFSBLOCK);\n\terror = xfs_trans_read_buf(mp, tp, mp->m_ddev_targp,\n\t\t\t\t   XFS_FSB_TO_DADDR(mp, map.br_startblock),\n\t\t\t\t   mp->m_bsize, 0, &bp, &xfs_rtbuf_ops);\n\tif (error)\n\t\treturn error;\n\n\txfs_trans_buf_set_type(tp, bp, issum ? XFS_BLFT_RTSUMMARY_BUF\n\t\t\t\t\t     : XFS_BLFT_RTBITMAP_BUF);\n\t*bpp = bp;\n\treturn 0;\n}\n\n \nint\nxfs_rtfind_back(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tstart,\t\t \n\txfs_rtblock_t\tlimit,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\txfs_rtword_t\t*b;\t\t \n\tint\t\tbit;\t\t \n\txfs_rtblock_t\tblock;\t\t \n\tstruct xfs_buf\t*bp;\t\t \n\txfs_rtword_t\t*bufp;\t\t \n\tint\t\terror;\t\t \n\txfs_rtblock_t\tfirstbit;\t \n\txfs_rtblock_t\ti;\t\t \n\txfs_rtblock_t\tlen;\t\t \n\txfs_rtword_t\tmask;\t\t \n\txfs_rtword_t\twant;\t\t \n\txfs_rtword_t\twdiff;\t\t \n\tint\t\tword;\t\t \n\n\t \n\tblock = XFS_BITTOBLOCK(mp, start);\n\terror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\n\tif (error) {\n\t\treturn error;\n\t}\n\tbufp = bp->b_addr;\n\t \n\tword = XFS_BITTOWORD(mp, start);\n\tb = &bufp[word];\n\tbit = (int)(start & (XFS_NBWORD - 1));\n\tlen = start - limit + 1;\n\t \n\twant = (*b & ((xfs_rtword_t)1 << bit)) ? -1 : 0;\n\t \n\tif (bit < XFS_NBWORD - 1) {\n\t\t \n\t\tfirstbit = XFS_RTMAX((xfs_srtblock_t)(bit - len + 1), 0);\n\t\tmask = (((xfs_rtword_t)1 << (bit - firstbit + 1)) - 1) <<\n\t\t\tfirstbit;\n\t\t \n\t\tif ((wdiff = (*b ^ want) & mask)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti = bit - XFS_RTHIBIT(wdiff);\n\t\t\t*rtblock = start - i + 1;\n\t\t\treturn 0;\n\t\t}\n\t\ti = bit - firstbit + 1;\n\t\t \n\t\tif (--word == -1 && i < len) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\terror = xfs_rtbuf_get(mp, tp, --block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tbufp = bp->b_addr;\n\t\t\tword = XFS_BLOCKWMASK(mp);\n\t\t\tb = &bufp[word];\n\t\t} else {\n\t\t\t \n\t\t\tb--;\n\t\t}\n\t} else {\n\t\t \n\t\ti = 0;\n\t}\n\t \n\twhile (len - i >= XFS_NBWORD) {\n\t\t \n\t\tif ((wdiff = *b ^ want)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti += XFS_NBWORD - 1 - XFS_RTHIBIT(wdiff);\n\t\t\t*rtblock = start - i + 1;\n\t\t\treturn 0;\n\t\t}\n\t\ti += XFS_NBWORD;\n\t\t \n\t\tif (--word == -1 && i < len) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\terror = xfs_rtbuf_get(mp, tp, --block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tbufp = bp->b_addr;\n\t\t\tword = XFS_BLOCKWMASK(mp);\n\t\t\tb = &bufp[word];\n\t\t} else {\n\t\t\t \n\t\t\tb--;\n\t\t}\n\t}\n\t \n\tif (len - i) {\n\t\t \n\t\tfirstbit = XFS_NBWORD - (len - i);\n\t\tmask = (((xfs_rtword_t)1 << (len - i)) - 1) << firstbit;\n\t\t \n\t\tif ((wdiff = (*b ^ want) & mask)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti += XFS_NBWORD - 1 - XFS_RTHIBIT(wdiff);\n\t\t\t*rtblock = start - i + 1;\n\t\t\treturn 0;\n\t\t} else\n\t\t\ti = len;\n\t}\n\t \n\txfs_trans_brelse(tp, bp);\n\t*rtblock = start - i + 1;\n\treturn 0;\n}\n\n \nint\nxfs_rtfind_forw(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tstart,\t\t \n\txfs_rtblock_t\tlimit,\t\t \n\txfs_rtblock_t\t*rtblock)\t \n{\n\txfs_rtword_t\t*b;\t\t \n\tint\t\tbit;\t\t \n\txfs_rtblock_t\tblock;\t\t \n\tstruct xfs_buf\t*bp;\t\t \n\txfs_rtword_t\t*bufp;\t\t \n\tint\t\terror;\t\t \n\txfs_rtblock_t\ti;\t\t \n\txfs_rtblock_t\tlastbit;\t \n\txfs_rtblock_t\tlen;\t\t \n\txfs_rtword_t\tmask;\t\t \n\txfs_rtword_t\twant;\t\t \n\txfs_rtword_t\twdiff;\t\t \n\tint\t\tword;\t\t \n\n\t \n\tblock = XFS_BITTOBLOCK(mp, start);\n\terror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\n\tif (error) {\n\t\treturn error;\n\t}\n\tbufp = bp->b_addr;\n\t \n\tword = XFS_BITTOWORD(mp, start);\n\tb = &bufp[word];\n\tbit = (int)(start & (XFS_NBWORD - 1));\n\tlen = limit - start + 1;\n\t \n\twant = (*b & ((xfs_rtword_t)1 << bit)) ? -1 : 0;\n\t \n\tif (bit) {\n\t\t \n\t\tlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\n\t\tmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\n\t\t \n\t\tif ((wdiff = (*b ^ want) & mask)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti = XFS_RTLOBIT(wdiff) - bit;\n\t\t\t*rtblock = start + i - 1;\n\t\t\treturn 0;\n\t\t}\n\t\ti = lastbit - bit;\n\t\t \n\t\tif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\terror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tb = bufp = bp->b_addr;\n\t\t\tword = 0;\n\t\t} else {\n\t\t\t \n\t\t\tb++;\n\t\t}\n\t} else {\n\t\t \n\t\ti = 0;\n\t}\n\t \n\twhile (len - i >= XFS_NBWORD) {\n\t\t \n\t\tif ((wdiff = *b ^ want)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti += XFS_RTLOBIT(wdiff);\n\t\t\t*rtblock = start + i - 1;\n\t\t\treturn 0;\n\t\t}\n\t\ti += XFS_NBWORD;\n\t\t \n\t\tif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\terror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tb = bufp = bp->b_addr;\n\t\t\tword = 0;\n\t\t} else {\n\t\t\t \n\t\t\tb++;\n\t\t}\n\t}\n\t \n\tif ((lastbit = len - i)) {\n\t\t \n\t\tmask = ((xfs_rtword_t)1 << lastbit) - 1;\n\t\t \n\t\tif ((wdiff = (*b ^ want) & mask)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti += XFS_RTLOBIT(wdiff);\n\t\t\t*rtblock = start + i - 1;\n\t\t\treturn 0;\n\t\t} else\n\t\t\ti = len;\n\t}\n\t \n\txfs_trans_brelse(tp, bp);\n\t*rtblock = start + i - 1;\n\treturn 0;\n}\n\n \nint\nxfs_rtmodify_summary_int(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\tint\t\tlog,\t\t \n\txfs_rtblock_t\tbbno,\t\t \n\tint\t\tdelta,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb,\t\t \n\txfs_suminfo_t\t*sum)\t\t \n{\n\tstruct xfs_buf\t*bp;\t\t \n\tint\t\terror;\t\t \n\txfs_fsblock_t\tsb;\t\t \n\tint\t\tso;\t\t \n\txfs_suminfo_t\t*sp;\t\t \n\n\t \n\tso = XFS_SUMOFFS(mp, log, bbno);\n\t \n\tsb = XFS_SUMOFFSTOBLOCK(mp, so);\n\t \n\tif (*rbpp && *rsb == sb)\n\t\tbp = *rbpp;\n\t \n\telse {\n\t\t \n\t\tif (*rbpp)\n\t\t\txfs_trans_brelse(tp, *rbpp);\n\t\terror = xfs_rtbuf_get(mp, tp, sb, 1, &bp);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t\t \n\t\t*rbpp = bp;\n\t\t*rsb = sb;\n\t}\n\t \n\tsp = XFS_SUMPTR(mp, bp, so);\n\tif (delta) {\n\t\tuint first = (uint)((char *)sp - (char *)bp->b_addr);\n\n\t\t*sp += delta;\n\t\tif (mp->m_rsum_cache) {\n\t\t\tif (*sp == 0 && log == mp->m_rsum_cache[bbno])\n\t\t\t\tmp->m_rsum_cache[bbno]++;\n\t\t\tif (*sp != 0 && log < mp->m_rsum_cache[bbno])\n\t\t\t\tmp->m_rsum_cache[bbno] = log;\n\t\t}\n\t\txfs_trans_log_buf(tp, bp, first, first + sizeof(*sp) - 1);\n\t}\n\tif (sum)\n\t\t*sum = *sp;\n\treturn 0;\n}\n\nint\nxfs_rtmodify_summary(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\tint\t\tlog,\t\t \n\txfs_rtblock_t\tbbno,\t\t \n\tint\t\tdelta,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb)\t\t \n{\n\treturn xfs_rtmodify_summary_int(mp, tp, log, bbno,\n\t\t\t\t\tdelta, rbpp, rsb, NULL);\n}\n\n \nint\nxfs_rtmodify_range(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tstart,\t\t \n\txfs_extlen_t\tlen,\t\t \n\tint\t\tval)\t\t \n{\n\txfs_rtword_t\t*b;\t\t \n\tint\t\tbit;\t\t \n\txfs_rtblock_t\tblock;\t\t \n\tstruct xfs_buf\t*bp;\t\t \n\txfs_rtword_t\t*bufp;\t\t \n\tint\t\terror;\t\t \n\txfs_rtword_t\t*first;\t\t \n\tint\t\ti;\t\t \n\tint\t\tlastbit;\t \n\txfs_rtword_t\tmask;\t\t \n\tint\t\tword;\t\t \n\n\t \n\tblock = XFS_BITTOBLOCK(mp, start);\n\t \n\terror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\n\tif (error) {\n\t\treturn error;\n\t}\n\tbufp = bp->b_addr;\n\t \n\tword = XFS_BITTOWORD(mp, start);\n\tfirst = b = &bufp[word];\n\tbit = (int)(start & (XFS_NBWORD - 1));\n\t \n\tval = -val;\n\t \n\tif (bit) {\n\t\t \n\t\tlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\n\t\tmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\n\t\t \n\t\tif (val)\n\t\t\t*b |= mask;\n\t\telse\n\t\t\t*b &= ~mask;\n\t\ti = lastbit - bit;\n\t\t \n\t\tif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\n\t\t\t \n\t\t\txfs_trans_log_buf(tp, bp,\n\t\t\t\t(uint)((char *)first - (char *)bufp),\n\t\t\t\t(uint)((char *)b - (char *)bufp));\n\t\t\terror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tfirst = b = bufp = bp->b_addr;\n\t\t\tword = 0;\n\t\t} else {\n\t\t\t \n\t\t\tb++;\n\t\t}\n\t} else {\n\t\t \n\t\ti = 0;\n\t}\n\t \n\twhile (len - i >= XFS_NBWORD) {\n\t\t \n\t\t*b = val;\n\t\ti += XFS_NBWORD;\n\t\t \n\t\tif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\n\t\t\t \n\t\t\txfs_trans_log_buf(tp, bp,\n\t\t\t\t(uint)((char *)first - (char *)bufp),\n\t\t\t\t(uint)((char *)b - (char *)bufp));\n\t\t\terror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tfirst = b = bufp = bp->b_addr;\n\t\t\tword = 0;\n\t\t} else {\n\t\t\t \n\t\t\tb++;\n\t\t}\n\t}\n\t \n\tif ((lastbit = len - i)) {\n\t\t \n\t\tmask = ((xfs_rtword_t)1 << lastbit) - 1;\n\t\t \n\t\tif (val)\n\t\t\t*b |= mask;\n\t\telse\n\t\t\t*b &= ~mask;\n\t\tb++;\n\t}\n\t \n\tif (b > first)\n\t\txfs_trans_log_buf(tp, bp, (uint)((char *)first - (char *)bufp),\n\t\t\t(uint)((char *)b - (char *)bufp - 1));\n\treturn 0;\n}\n\n \nint\nxfs_rtfree_range(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tstart,\t\t \n\txfs_extlen_t\tlen,\t\t \n\tstruct xfs_buf\t**rbpp,\t\t \n\txfs_fsblock_t\t*rsb)\t\t \n{\n\txfs_rtblock_t\tend;\t\t \n\tint\t\terror;\t\t \n\txfs_rtblock_t\tpostblock;\t \n\txfs_rtblock_t\tpreblock;\t \n\n\tend = start + len - 1;\n\t \n\terror = xfs_rtmodify_range(mp, tp, start, len, 1);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\terror = xfs_rtfind_back(mp, tp, start, 0, &preblock);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\terror = xfs_rtfind_forw(mp, tp, end, mp->m_sb.sb_rextents - 1,\n\t\t&postblock);\n\tif (error)\n\t\treturn error;\n\t \n\tif (preblock < start) {\n\t\terror = xfs_rtmodify_summary(mp, tp,\n\t\t\tXFS_RTBLOCKLOG(start - preblock),\n\t\t\tXFS_BITTOBLOCK(mp, preblock), -1, rbpp, rsb);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t}\n\t \n\tif (postblock > end) {\n\t\terror = xfs_rtmodify_summary(mp, tp,\n\t\t\tXFS_RTBLOCKLOG(postblock - end),\n\t\t\tXFS_BITTOBLOCK(mp, end + 1), -1, rbpp, rsb);\n\t\tif (error) {\n\t\t\treturn error;\n\t\t}\n\t}\n\t \n\terror = xfs_rtmodify_summary(mp, tp,\n\t\tXFS_RTBLOCKLOG(postblock + 1 - preblock),\n\t\tXFS_BITTOBLOCK(mp, preblock), 1, rbpp, rsb);\n\treturn error;\n}\n\n \nint\nxfs_rtcheck_range(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tstart,\t\t \n\txfs_extlen_t\tlen,\t\t \n\tint\t\tval,\t\t \n\txfs_rtblock_t\t*new,\t\t \n\tint\t\t*stat)\t\t \n{\n\txfs_rtword_t\t*b;\t\t \n\tint\t\tbit;\t\t \n\txfs_rtblock_t\tblock;\t\t \n\tstruct xfs_buf\t*bp;\t\t \n\txfs_rtword_t\t*bufp;\t\t \n\tint\t\terror;\t\t \n\txfs_rtblock_t\ti;\t\t \n\txfs_rtblock_t\tlastbit;\t \n\txfs_rtword_t\tmask;\t\t \n\txfs_rtword_t\twdiff;\t\t \n\tint\t\tword;\t\t \n\n\t \n\tblock = XFS_BITTOBLOCK(mp, start);\n\t \n\terror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\n\tif (error) {\n\t\treturn error;\n\t}\n\tbufp = bp->b_addr;\n\t \n\tword = XFS_BITTOWORD(mp, start);\n\tb = &bufp[word];\n\tbit = (int)(start & (XFS_NBWORD - 1));\n\t \n\tval = -val;\n\t \n\tif (bit) {\n\t\t \n\t\tlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\n\t\t \n\t\tmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\n\t\t \n\t\tif ((wdiff = (*b ^ val) & mask)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti = XFS_RTLOBIT(wdiff) - bit;\n\t\t\t*new = start + i;\n\t\t\t*stat = 0;\n\t\t\treturn 0;\n\t\t}\n\t\ti = lastbit - bit;\n\t\t \n\t\tif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\terror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tb = bufp = bp->b_addr;\n\t\t\tword = 0;\n\t\t} else {\n\t\t\t \n\t\t\tb++;\n\t\t}\n\t} else {\n\t\t \n\t\ti = 0;\n\t}\n\t \n\twhile (len - i >= XFS_NBWORD) {\n\t\t \n\t\tif ((wdiff = *b ^ val)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti += XFS_RTLOBIT(wdiff);\n\t\t\t*new = start + i;\n\t\t\t*stat = 0;\n\t\t\treturn 0;\n\t\t}\n\t\ti += XFS_NBWORD;\n\t\t \n\t\tif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\terror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\n\t\t\tif (error) {\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tb = bufp = bp->b_addr;\n\t\t\tword = 0;\n\t\t} else {\n\t\t\t \n\t\t\tb++;\n\t\t}\n\t}\n\t \n\tif ((lastbit = len - i)) {\n\t\t \n\t\tmask = ((xfs_rtword_t)1 << lastbit) - 1;\n\t\t \n\t\tif ((wdiff = (*b ^ val) & mask)) {\n\t\t\t \n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\ti += XFS_RTLOBIT(wdiff);\n\t\t\t*new = start + i;\n\t\t\t*stat = 0;\n\t\t\treturn 0;\n\t\t} else\n\t\t\ti = len;\n\t}\n\t \n\txfs_trans_brelse(tp, bp);\n\t*new = start + i;\n\t*stat = 1;\n\treturn 0;\n}\n\n#ifdef DEBUG\n \nSTATIC int\t\t\t\t \nxfs_rtcheck_alloc_range(\n\txfs_mount_t\t*mp,\t\t \n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tbno,\t\t \n\txfs_extlen_t\tlen)\t\t \n{\n\txfs_rtblock_t\tnew;\t\t \n\tint\t\tstat;\n\tint\t\terror;\n\n\terror = xfs_rtcheck_range(mp, tp, bno, len, 0, &new, &stat);\n\tif (error)\n\t\treturn error;\n\tASSERT(stat);\n\treturn 0;\n}\n#else\n#define xfs_rtcheck_alloc_range(m,t,b,l)\t(0)\n#endif\n \nint\t\t\t\t\t \nxfs_rtfree_extent(\n\txfs_trans_t\t*tp,\t\t \n\txfs_rtblock_t\tbno,\t\t \n\txfs_extlen_t\tlen)\t\t \n{\n\tint\t\terror;\t\t \n\txfs_mount_t\t*mp;\t\t \n\txfs_fsblock_t\tsb;\t\t \n\tstruct xfs_buf\t*sumbp = NULL;\t \n\n\tmp = tp->t_mountp;\n\n\tASSERT(mp->m_rbmip->i_itemp != NULL);\n\tASSERT(xfs_isilocked(mp->m_rbmip, XFS_ILOCK_EXCL));\n\n\terror = xfs_rtcheck_alloc_range(mp, tp, bno, len);\n\tif (error)\n\t\treturn error;\n\n\t \n\terror = xfs_rtfree_range(mp, tp, bno, len, &sumbp, &sb);\n\tif (error) {\n\t\treturn error;\n\t}\n\t \n\txfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS, (long)len);\n\t \n\tif (tp->t_frextents_delta + mp->m_sb.sb_frextents ==\n\t    mp->m_sb.sb_rextents) {\n\t\tif (!(mp->m_rbmip->i_diflags & XFS_DIFLAG_NEWRTBM))\n\t\t\tmp->m_rbmip->i_diflags |= XFS_DIFLAG_NEWRTBM;\n\t\t*(uint64_t *)&VFS_I(mp->m_rbmip)->i_atime = 0;\n\t\txfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\n\t}\n\treturn 0;\n}\n\n \nint\nxfs_rtalloc_query_range(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_trans\t\t*tp,\n\tconst struct xfs_rtalloc_rec\t*low_rec,\n\tconst struct xfs_rtalloc_rec\t*high_rec,\n\txfs_rtalloc_query_range_fn\tfn,\n\tvoid\t\t\t\t*priv)\n{\n\tstruct xfs_rtalloc_rec\t\trec;\n\txfs_rtblock_t\t\t\trtstart;\n\txfs_rtblock_t\t\t\trtend;\n\txfs_rtblock_t\t\t\thigh_key;\n\tint\t\t\t\tis_free;\n\tint\t\t\t\terror = 0;\n\n\tif (low_rec->ar_startext > high_rec->ar_startext)\n\t\treturn -EINVAL;\n\tif (low_rec->ar_startext >= mp->m_sb.sb_rextents ||\n\t    low_rec->ar_startext == high_rec->ar_startext)\n\t\treturn 0;\n\n\thigh_key = min(high_rec->ar_startext, mp->m_sb.sb_rextents - 1);\n\n\t \n\trtstart = low_rec->ar_startext;\n\twhile (rtstart <= high_key) {\n\t\t \n\t\terror = xfs_rtcheck_range(mp, tp, rtstart, 1, 1, &rtend,\n\t\t\t\t&is_free);\n\t\tif (error)\n\t\t\tbreak;\n\n\t\t \n\t\terror = xfs_rtfind_forw(mp, tp, rtstart, high_key, &rtend);\n\t\tif (error)\n\t\t\tbreak;\n\n\t\tif (is_free) {\n\t\t\trec.ar_startext = rtstart;\n\t\t\trec.ar_extcount = rtend - rtstart + 1;\n\n\t\t\terror = fn(mp, tp, &rec, priv);\n\t\t\tif (error)\n\t\t\t\tbreak;\n\t\t}\n\n\t\trtstart = rtend + 1;\n\t}\n\n\treturn error;\n}\n\n \nint\nxfs_rtalloc_query_all(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_trans\t\t*tp,\n\txfs_rtalloc_query_range_fn\tfn,\n\tvoid\t\t\t\t*priv)\n{\n\tstruct xfs_rtalloc_rec\t\tkeys[2];\n\n\tkeys[0].ar_startext = 0;\n\tkeys[1].ar_startext = mp->m_sb.sb_rextents - 1;\n\tkeys[0].ar_extcount = keys[1].ar_extcount = 0;\n\n\treturn xfs_rtalloc_query_range(mp, tp, &keys[0], &keys[1], fn, priv);\n}\n\n \nint\nxfs_rtalloc_extent_is_free(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_trans\t\t*tp,\n\txfs_rtblock_t\t\t\tstart,\n\txfs_extlen_t\t\t\tlen,\n\tbool\t\t\t\t*is_free)\n{\n\txfs_rtblock_t\t\t\tend;\n\tint\t\t\t\tmatches;\n\tint\t\t\t\terror;\n\n\terror = xfs_rtcheck_range(mp, tp, start, len, 1, &end, &matches);\n\tif (error)\n\t\treturn error;\n\n\t*is_free = matches;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}