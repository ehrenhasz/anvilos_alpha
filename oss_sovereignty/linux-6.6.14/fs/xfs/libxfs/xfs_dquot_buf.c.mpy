{
  "module_name": "xfs_dquot_buf.c",
  "hash_id": "3dd76284e7ea01b835cf5142ef1d20bfaf2a746fe474a8cd90795e618d1b4e72",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_dquot_buf.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_qm.h\"\n#include \"xfs_error.h\"\n\nint\nxfs_calc_dquots_per_chunk(\n\tunsigned int\t\tnbblks)\t \n{\n\tASSERT(nbblks > 0);\n\treturn BBTOB(nbblks) / sizeof(struct xfs_dqblk);\n}\n\n \n\nxfs_failaddr_t\nxfs_dquot_verify(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_disk_dquot\t*ddq,\n\txfs_dqid_t\t\tid)\t \n{\n\t__u8\t\t\tddq_type;\n\n\t \n\tif (ddq->d_magic != cpu_to_be16(XFS_DQUOT_MAGIC))\n\t\treturn __this_address;\n\tif (ddq->d_version != XFS_DQUOT_VERSION)\n\t\treturn __this_address;\n\n\tif (ddq->d_type & ~XFS_DQTYPE_ANY)\n\t\treturn __this_address;\n\tddq_type = ddq->d_type & XFS_DQTYPE_REC_MASK;\n\tif (ddq_type != XFS_DQTYPE_USER &&\n\t    ddq_type != XFS_DQTYPE_PROJ &&\n\t    ddq_type != XFS_DQTYPE_GROUP)\n\t\treturn __this_address;\n\n\tif ((ddq->d_type & XFS_DQTYPE_BIGTIME) &&\n\t    !xfs_has_bigtime(mp))\n\t\treturn __this_address;\n\n\tif ((ddq->d_type & XFS_DQTYPE_BIGTIME) && !ddq->d_id)\n\t\treturn __this_address;\n\n\tif (id != -1 && id != be32_to_cpu(ddq->d_id))\n\t\treturn __this_address;\n\n\tif (!ddq->d_id)\n\t\treturn NULL;\n\n\tif (ddq->d_blk_softlimit &&\n\t    be64_to_cpu(ddq->d_bcount) > be64_to_cpu(ddq->d_blk_softlimit) &&\n\t    !ddq->d_btimer)\n\t\treturn __this_address;\n\n\tif (ddq->d_ino_softlimit &&\n\t    be64_to_cpu(ddq->d_icount) > be64_to_cpu(ddq->d_ino_softlimit) &&\n\t    !ddq->d_itimer)\n\t\treturn __this_address;\n\n\tif (ddq->d_rtb_softlimit &&\n\t    be64_to_cpu(ddq->d_rtbcount) > be64_to_cpu(ddq->d_rtb_softlimit) &&\n\t    !ddq->d_rtbtimer)\n\t\treturn __this_address;\n\n\treturn NULL;\n}\n\nxfs_failaddr_t\nxfs_dqblk_verify(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dqblk\t*dqb,\n\txfs_dqid_t\t\tid)\t \n{\n\tif (xfs_has_crc(mp) &&\n\t    !uuid_equal(&dqb->dd_uuid, &mp->m_sb.sb_meta_uuid))\n\t\treturn __this_address;\n\n\treturn xfs_dquot_verify(mp, &dqb->dd_diskdq, id);\n}\n\n \nvoid\nxfs_dqblk_repair(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dqblk\t*dqb,\n\txfs_dqid_t\t\tid,\n\txfs_dqtype_t\t\ttype)\n{\n\t \n\tASSERT(id != -1);\n\tmemset(dqb, 0, sizeof(struct xfs_dqblk));\n\n\tdqb->dd_diskdq.d_magic = cpu_to_be16(XFS_DQUOT_MAGIC);\n\tdqb->dd_diskdq.d_version = XFS_DQUOT_VERSION;\n\tdqb->dd_diskdq.d_type = type;\n\tdqb->dd_diskdq.d_id = cpu_to_be32(id);\n\n\tif (xfs_has_crc(mp)) {\n\t\tuuid_copy(&dqb->dd_uuid, &mp->m_sb.sb_meta_uuid);\n\t\txfs_update_cksum((char *)dqb, sizeof(struct xfs_dqblk),\n\t\t\t\t XFS_DQUOT_CRC_OFF);\n\t}\n}\n\nSTATIC bool\nxfs_dquot_buf_verify_crc(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_buf\t\t*bp,\n\tbool\t\t\treadahead)\n{\n\tstruct xfs_dqblk\t*d = (struct xfs_dqblk *)bp->b_addr;\n\tint\t\t\tndquots;\n\tint\t\t\ti;\n\n\tif (!xfs_has_crc(mp))\n\t\treturn true;\n\n\t \n\tif (mp->m_quotainfo)\n\t\tndquots = mp->m_quotainfo->qi_dqperchunk;\n\telse\n\t\tndquots = xfs_calc_dquots_per_chunk(bp->b_length);\n\n\tfor (i = 0; i < ndquots; i++, d++) {\n\t\tif (!xfs_verify_cksum((char *)d, sizeof(struct xfs_dqblk),\n\t\t\t\t XFS_DQUOT_CRC_OFF)) {\n\t\t\tif (!readahead)\n\t\t\t\txfs_buf_verifier_error(bp, -EFSBADCRC, __func__,\n\t\t\t\t\td, sizeof(*d), __this_address);\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\nSTATIC xfs_failaddr_t\nxfs_dquot_buf_verify(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_buf\t\t*bp,\n\tbool\t\t\treadahead)\n{\n\tstruct xfs_dqblk\t*dqb = bp->b_addr;\n\txfs_failaddr_t\t\tfa;\n\txfs_dqid_t\t\tid = 0;\n\tint\t\t\tndquots;\n\tint\t\t\ti;\n\n\t \n\tif (mp->m_quotainfo)\n\t\tndquots = mp->m_quotainfo->qi_dqperchunk;\n\telse\n\t\tndquots = xfs_calc_dquots_per_chunk(bp->b_length);\n\n\t \n\tfor (i = 0; i < ndquots; i++) {\n\t\tstruct xfs_disk_dquot\t*ddq;\n\n\t\tddq = &dqb[i].dd_diskdq;\n\n\t\tif (i == 0)\n\t\t\tid = be32_to_cpu(ddq->d_id);\n\n\t\tfa = xfs_dqblk_verify(mp, &dqb[i], id + i);\n\t\tif (fa) {\n\t\t\tif (!readahead)\n\t\t\t\txfs_buf_verifier_error(bp, -EFSCORRUPTED,\n\t\t\t\t\t__func__, &dqb[i],\n\t\t\t\t\tsizeof(struct xfs_dqblk), fa);\n\t\t\treturn fa;\n\t\t}\n\t}\n\n\treturn NULL;\n}\n\nstatic xfs_failaddr_t\nxfs_dquot_buf_verify_struct(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\n\treturn xfs_dquot_buf_verify(mp, bp, false);\n}\n\nstatic void\nxfs_dquot_buf_read_verify(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\n\tif (!xfs_dquot_buf_verify_crc(mp, bp, false))\n\t\treturn;\n\txfs_dquot_buf_verify(mp, bp, false);\n}\n\n \nstatic void\nxfs_dquot_buf_readahead_verify(\n\tstruct xfs_buf\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\n\tif (!xfs_dquot_buf_verify_crc(mp, bp, true) ||\n\t    xfs_dquot_buf_verify(mp, bp, true) != NULL) {\n\t\txfs_buf_ioerror(bp, -EIO);\n\t\tbp->b_flags &= ~XBF_DONE;\n\t}\n}\n\n \nstatic void\nxfs_dquot_buf_write_verify(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\n\txfs_dquot_buf_verify(mp, bp, false);\n}\n\nconst struct xfs_buf_ops xfs_dquot_buf_ops = {\n\t.name = \"xfs_dquot\",\n\t.magic16 = { cpu_to_be16(XFS_DQUOT_MAGIC),\n\t\t     cpu_to_be16(XFS_DQUOT_MAGIC) },\n\t.verify_read = xfs_dquot_buf_read_verify,\n\t.verify_write = xfs_dquot_buf_write_verify,\n\t.verify_struct = xfs_dquot_buf_verify_struct,\n};\n\nconst struct xfs_buf_ops xfs_dquot_buf_ra_ops = {\n\t.name = \"xfs_dquot_ra\",\n\t.magic16 = { cpu_to_be16(XFS_DQUOT_MAGIC),\n\t\t     cpu_to_be16(XFS_DQUOT_MAGIC) },\n\t.verify_read = xfs_dquot_buf_readahead_verify,\n\t.verify_write = xfs_dquot_buf_write_verify,\n};\n\n \ntime64_t\nxfs_dquot_from_disk_ts(\n\tstruct xfs_disk_dquot\t*ddq,\n\t__be32\t\t\tdtimer)\n{\n\tuint32_t\t\tt = be32_to_cpu(dtimer);\n\n\tif (t != 0 && (ddq->d_type & XFS_DQTYPE_BIGTIME))\n\t\treturn xfs_dq_bigtime_to_unix(t);\n\n\treturn t;\n}\n\n \n__be32\nxfs_dquot_to_disk_ts(\n\tstruct xfs_dquot\t*dqp,\n\ttime64_t\t\ttimer)\n{\n\tuint32_t\t\tt = timer;\n\n\tif (timer != 0 && (dqp->q_type & XFS_DQTYPE_BIGTIME))\n\t\tt = xfs_dq_unix_to_bigtime(timer);\n\n\treturn cpu_to_be32(t);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}