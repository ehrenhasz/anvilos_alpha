{
  "module_name": "xfs_dir2_leaf.c",
  "hash_id": "27351805d274b91b127b413f9c6d6381193097fed88acc452a5af5ecd21d854a",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_dir2_leaf.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_dir2.h\"\n#include \"xfs_dir2_priv.h\"\n#include \"xfs_error.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_buf_item.h\"\n\n \nstatic int xfs_dir2_leaf_lookup_int(xfs_da_args_t *args, struct xfs_buf **lbpp,\n\t\t\t\t    int *indexp, struct xfs_buf **dbpp,\n\t\t\t\t    struct xfs_dir3_icleaf_hdr *leafhdr);\nstatic void xfs_dir3_leaf_log_bests(struct xfs_da_args *args,\n\t\t\t\t    struct xfs_buf *bp, int first, int last);\nstatic void xfs_dir3_leaf_log_tail(struct xfs_da_args *args,\n\t\t\t\t   struct xfs_buf *bp);\n\nvoid\nxfs_dir2_leaf_hdr_from_disk(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_dir3_icleaf_hdr\t*to,\n\tstruct xfs_dir2_leaf\t\t*from)\n{\n\tif (xfs_has_crc(mp)) {\n\t\tstruct xfs_dir3_leaf *from3 = (struct xfs_dir3_leaf *)from;\n\n\t\tto->forw = be32_to_cpu(from3->hdr.info.hdr.forw);\n\t\tto->back = be32_to_cpu(from3->hdr.info.hdr.back);\n\t\tto->magic = be16_to_cpu(from3->hdr.info.hdr.magic);\n\t\tto->count = be16_to_cpu(from3->hdr.count);\n\t\tto->stale = be16_to_cpu(from3->hdr.stale);\n\t\tto->ents = from3->__ents;\n\n\t\tASSERT(to->magic == XFS_DIR3_LEAF1_MAGIC ||\n\t\t       to->magic == XFS_DIR3_LEAFN_MAGIC);\n\t} else {\n\t\tto->forw = be32_to_cpu(from->hdr.info.forw);\n\t\tto->back = be32_to_cpu(from->hdr.info.back);\n\t\tto->magic = be16_to_cpu(from->hdr.info.magic);\n\t\tto->count = be16_to_cpu(from->hdr.count);\n\t\tto->stale = be16_to_cpu(from->hdr.stale);\n\t\tto->ents = from->__ents;\n\n\t\tASSERT(to->magic == XFS_DIR2_LEAF1_MAGIC ||\n\t\t       to->magic == XFS_DIR2_LEAFN_MAGIC);\n\t}\n}\n\nvoid\nxfs_dir2_leaf_hdr_to_disk(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_dir2_leaf\t\t*to,\n\tstruct xfs_dir3_icleaf_hdr\t*from)\n{\n\tif (xfs_has_crc(mp)) {\n\t\tstruct xfs_dir3_leaf *to3 = (struct xfs_dir3_leaf *)to;\n\n\t\tASSERT(from->magic == XFS_DIR3_LEAF1_MAGIC ||\n\t\t       from->magic == XFS_DIR3_LEAFN_MAGIC);\n\n\t\tto3->hdr.info.hdr.forw = cpu_to_be32(from->forw);\n\t\tto3->hdr.info.hdr.back = cpu_to_be32(from->back);\n\t\tto3->hdr.info.hdr.magic = cpu_to_be16(from->magic);\n\t\tto3->hdr.count = cpu_to_be16(from->count);\n\t\tto3->hdr.stale = cpu_to_be16(from->stale);\n\t} else {\n\t\tASSERT(from->magic == XFS_DIR2_LEAF1_MAGIC ||\n\t\t       from->magic == XFS_DIR2_LEAFN_MAGIC);\n\n\t\tto->hdr.info.forw = cpu_to_be32(from->forw);\n\t\tto->hdr.info.back = cpu_to_be32(from->back);\n\t\tto->hdr.info.magic = cpu_to_be16(from->magic);\n\t\tto->hdr.count = cpu_to_be16(from->count);\n\t\tto->hdr.stale = cpu_to_be16(from->stale);\n\t}\n}\n\n \n#ifdef DEBUG\nstatic xfs_failaddr_t\nxfs_dir3_leaf1_check(\n\tstruct xfs_inode\t*dp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_dir2_leaf\t*leaf = bp->b_addr;\n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\txfs_dir2_leaf_hdr_from_disk(dp->i_mount, &leafhdr, leaf);\n\n\tif (leafhdr.magic == XFS_DIR3_LEAF1_MAGIC) {\n\t\tstruct xfs_dir3_leaf_hdr *leaf3 = bp->b_addr;\n\t\tif (be64_to_cpu(leaf3->info.blkno) != xfs_buf_daddr(bp))\n\t\t\treturn __this_address;\n\t} else if (leafhdr.magic != XFS_DIR2_LEAF1_MAGIC)\n\t\treturn __this_address;\n\n\treturn xfs_dir3_leaf_check_int(dp->i_mount, &leafhdr, leaf, false);\n}\n\nstatic inline void\nxfs_dir3_leaf_check(\n\tstruct xfs_inode\t*dp,\n\tstruct xfs_buf\t\t*bp)\n{\n\txfs_failaddr_t\t\tfa;\n\n\tfa = xfs_dir3_leaf1_check(dp, bp);\n\tif (!fa)\n\t\treturn;\n\txfs_corruption_error(__func__, XFS_ERRLEVEL_LOW, dp->i_mount,\n\t\t\tbp->b_addr, BBTOB(bp->b_length), __FILE__, __LINE__,\n\t\t\tfa);\n\tASSERT(0);\n}\n#else\n#define\txfs_dir3_leaf_check(dp, bp)\n#endif\n\nxfs_failaddr_t\nxfs_dir3_leaf_check_int(\n\tstruct xfs_mount\t\t*mp,\n\tstruct xfs_dir3_icleaf_hdr\t*hdr,\n\tstruct xfs_dir2_leaf\t\t*leaf,\n\tbool\t\t\t\texpensive_checking)\n{\n\tstruct xfs_da_geometry\t\t*geo = mp->m_dir_geo;\n\txfs_dir2_leaf_tail_t\t\t*ltp;\n\tint\t\t\t\tstale;\n\tint\t\t\t\ti;\n\tbool\t\t\t\tisleaf1 = (hdr->magic == XFS_DIR2_LEAF1_MAGIC ||\n\t\t\t\t\t\t   hdr->magic == XFS_DIR3_LEAF1_MAGIC);\n\n\tltp = xfs_dir2_leaf_tail_p(geo, leaf);\n\n\t \n\tif (hdr->count > geo->leaf_max_ents)\n\t\treturn __this_address;\n\n\t \n\tif (isleaf1 &&\n\t    (char *)&hdr->ents[hdr->count] > (char *)xfs_dir2_leaf_bests_p(ltp))\n\t\treturn __this_address;\n\n\tif (!expensive_checking)\n\t\treturn NULL;\n\n\t \n\tfor (i = stale = 0; i < hdr->count; i++) {\n\t\tif (i + 1 < hdr->count) {\n\t\t\tif (be32_to_cpu(hdr->ents[i].hashval) >\n\t\t\t\t\tbe32_to_cpu(hdr->ents[i + 1].hashval))\n\t\t\t\treturn __this_address;\n\t\t}\n\t\tif (hdr->ents[i].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\n\t\t\tstale++;\n\t\tif (isleaf1 && xfs_dir2_dataptr_to_db(geo,\n\t\t\t\tbe32_to_cpu(hdr->ents[i].address)) >=\n\t\t\t\tbe32_to_cpu(ltp->bestcount))\n\t\t\treturn __this_address;\n\t}\n\tif (hdr->stale != stale)\n\t\treturn __this_address;\n\treturn NULL;\n}\n\n \nstatic xfs_failaddr_t\nxfs_dir3_leaf_verify(\n\tstruct xfs_buf\t\t\t*bp)\n{\n\tstruct xfs_mount\t\t*mp = bp->b_mount;\n\tstruct xfs_dir3_icleaf_hdr\tleafhdr;\n\txfs_failaddr_t\t\t\tfa;\n\n\tfa = xfs_da3_blkinfo_verify(bp, bp->b_addr);\n\tif (fa)\n\t\treturn fa;\n\n\txfs_dir2_leaf_hdr_from_disk(mp, &leafhdr, bp->b_addr);\n\treturn xfs_dir3_leaf_check_int(mp, &leafhdr, bp->b_addr, true);\n}\n\nstatic void\nxfs_dir3_leaf_read_verify(\n\tstruct xfs_buf  *bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\txfs_failaddr_t\t\tfa;\n\n\tif (xfs_has_crc(mp) &&\n\t     !xfs_buf_verify_cksum(bp, XFS_DIR3_LEAF_CRC_OFF))\n\t\txfs_verifier_error(bp, -EFSBADCRC, __this_address);\n\telse {\n\t\tfa = xfs_dir3_leaf_verify(bp);\n\t\tif (fa)\n\t\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t}\n}\n\nstatic void\nxfs_dir3_leaf_write_verify(\n\tstruct xfs_buf  *bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\tstruct xfs_dir3_leaf_hdr *hdr3 = bp->b_addr;\n\txfs_failaddr_t\t\tfa;\n\n\tfa = xfs_dir3_leaf_verify(bp);\n\tif (fa) {\n\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t\treturn;\n\t}\n\n\tif (!xfs_has_crc(mp))\n\t\treturn;\n\n\tif (bip)\n\t\thdr3->info.lsn = cpu_to_be64(bip->bli_item.li_lsn);\n\n\txfs_buf_update_cksum(bp, XFS_DIR3_LEAF_CRC_OFF);\n}\n\nconst struct xfs_buf_ops xfs_dir3_leaf1_buf_ops = {\n\t.name = \"xfs_dir3_leaf1\",\n\t.magic16 = { cpu_to_be16(XFS_DIR2_LEAF1_MAGIC),\n\t\t     cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) },\n\t.verify_read = xfs_dir3_leaf_read_verify,\n\t.verify_write = xfs_dir3_leaf_write_verify,\n\t.verify_struct = xfs_dir3_leaf_verify,\n};\n\nconst struct xfs_buf_ops xfs_dir3_leafn_buf_ops = {\n\t.name = \"xfs_dir3_leafn\",\n\t.magic16 = { cpu_to_be16(XFS_DIR2_LEAFN_MAGIC),\n\t\t     cpu_to_be16(XFS_DIR3_LEAFN_MAGIC) },\n\t.verify_read = xfs_dir3_leaf_read_verify,\n\t.verify_write = xfs_dir3_leaf_write_verify,\n\t.verify_struct = xfs_dir3_leaf_verify,\n};\n\nint\nxfs_dir3_leaf_read(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*dp,\n\txfs_dablk_t\t\tfbno,\n\tstruct xfs_buf\t\t**bpp)\n{\n\tint\t\t\terr;\n\n\terr = xfs_da_read_buf(tp, dp, fbno, 0, bpp, XFS_DATA_FORK,\n\t\t\t&xfs_dir3_leaf1_buf_ops);\n\tif (!err && tp && *bpp)\n\t\txfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_LEAF1_BUF);\n\treturn err;\n}\n\nint\nxfs_dir3_leafn_read(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*dp,\n\txfs_dablk_t\t\tfbno,\n\tstruct xfs_buf\t\t**bpp)\n{\n\tint\t\t\terr;\n\n\terr = xfs_da_read_buf(tp, dp, fbno, 0, bpp, XFS_DATA_FORK,\n\t\t\t&xfs_dir3_leafn_buf_ops);\n\tif (!err && tp && *bpp)\n\t\txfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_LEAFN_BUF);\n\treturn err;\n}\n\n \nstatic void\nxfs_dir3_leaf_init(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp,\n\txfs_ino_t\t\towner,\n\tuint16_t\t\ttype)\n{\n\tstruct xfs_dir2_leaf\t*leaf = bp->b_addr;\n\n\tASSERT(type == XFS_DIR2_LEAF1_MAGIC || type == XFS_DIR2_LEAFN_MAGIC);\n\n\tif (xfs_has_crc(mp)) {\n\t\tstruct xfs_dir3_leaf_hdr *leaf3 = bp->b_addr;\n\n\t\tmemset(leaf3, 0, sizeof(*leaf3));\n\n\t\tleaf3->info.hdr.magic = (type == XFS_DIR2_LEAF1_MAGIC)\n\t\t\t\t\t ? cpu_to_be16(XFS_DIR3_LEAF1_MAGIC)\n\t\t\t\t\t : cpu_to_be16(XFS_DIR3_LEAFN_MAGIC);\n\t\tleaf3->info.blkno = cpu_to_be64(xfs_buf_daddr(bp));\n\t\tleaf3->info.owner = cpu_to_be64(owner);\n\t\tuuid_copy(&leaf3->info.uuid, &mp->m_sb.sb_meta_uuid);\n\t} else {\n\t\tmemset(leaf, 0, sizeof(*leaf));\n\t\tleaf->hdr.info.magic = cpu_to_be16(type);\n\t}\n\n\t \n\tif (type == XFS_DIR2_LEAF1_MAGIC) {\n\t\tstruct xfs_dir2_leaf_tail *ltp;\n\n\t\tltp = xfs_dir2_leaf_tail_p(mp->m_dir_geo, leaf);\n\t\tltp->bestcount = 0;\n\t\tbp->b_ops = &xfs_dir3_leaf1_buf_ops;\n\t\txfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_LEAF1_BUF);\n\t} else {\n\t\tbp->b_ops = &xfs_dir3_leafn_buf_ops;\n\t\txfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_LEAFN_BUF);\n\t}\n}\n\nint\nxfs_dir3_leaf_get_buf(\n\txfs_da_args_t\t\t*args,\n\txfs_dir2_db_t\t\tbno,\n\tstruct xfs_buf\t\t**bpp,\n\tuint16_t\t\tmagic)\n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_trans\t*tp = args->trans;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tstruct xfs_buf\t\t*bp;\n\tint\t\t\terror;\n\n\tASSERT(magic == XFS_DIR2_LEAF1_MAGIC || magic == XFS_DIR2_LEAFN_MAGIC);\n\tASSERT(bno >= xfs_dir2_byte_to_db(args->geo, XFS_DIR2_LEAF_OFFSET) &&\n\t       bno < xfs_dir2_byte_to_db(args->geo, XFS_DIR2_FREE_OFFSET));\n\n\terror = xfs_da_get_buf(tp, dp, xfs_dir2_db_to_da(args->geo, bno),\n\t\t\t       &bp, XFS_DATA_FORK);\n\tif (error)\n\t\treturn error;\n\n\txfs_dir3_leaf_init(mp, tp, bp, dp->i_ino, magic);\n\txfs_dir3_leaf_log_header(args, bp);\n\tif (magic == XFS_DIR2_LEAF1_MAGIC)\n\t\txfs_dir3_leaf_log_tail(args, bp);\n\t*bpp = bp;\n\treturn 0;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_to_leaf(\n\txfs_da_args_t\t\t*args,\t\t \n\tstruct xfs_buf\t\t*dbp)\t\t \n{\n\t__be16\t\t\t*bestsp;\t \n\txfs_dablk_t\t\tblkno;\t\t \n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\txfs_dir2_db_t\t\tldb;\t\t \n\txfs_dir2_leaf_t\t\t*leaf;\t\t \n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\txfs_trans_t\t\t*tp;\t\t \n\tstruct xfs_dir2_data_free *bf;\n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\ttrace_xfs_dir2_block_to_leaf(args);\n\n\tdp = args->dp;\n\ttp = args->trans;\n\t \n\tif ((error = xfs_da_grow_inode(args, &blkno))) {\n\t\treturn error;\n\t}\n\tldb = xfs_dir2_da_to_db(args->geo, blkno);\n\tASSERT(ldb == xfs_dir2_byte_to_db(args->geo, XFS_DIR2_LEAF_OFFSET));\n\t \n\terror = xfs_dir3_leaf_get_buf(args, ldb, &lbp, XFS_DIR2_LEAF1_MAGIC);\n\tif (error)\n\t\treturn error;\n\n\tleaf = lbp->b_addr;\n\thdr = dbp->b_addr;\n\txfs_dir3_data_check(dp, dbp);\n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\tbf = xfs_dir2_data_bestfree_p(dp->i_mount, hdr);\n\n\t \n\txfs_dir2_leaf_hdr_from_disk(dp->i_mount, &leafhdr, leaf);\n\tleafhdr.count = be32_to_cpu(btp->count);\n\tleafhdr.stale = be32_to_cpu(btp->stale);\n\txfs_dir2_leaf_hdr_to_disk(dp->i_mount, leaf, &leafhdr);\n\txfs_dir3_leaf_log_header(args, lbp);\n\n\t \n\tmemcpy(leafhdr.ents, blp,\n\t\tbe32_to_cpu(btp->count) * sizeof(struct xfs_dir2_leaf_entry));\n\txfs_dir3_leaf_log_ents(args, &leafhdr, lbp, 0, leafhdr.count - 1);\n\tneedscan = 0;\n\tneedlog = 1;\n\t \n\txfs_dir2_data_make_free(args, dbp,\n\t\t(xfs_dir2_data_aoff_t)((char *)blp - (char *)hdr),\n\t\t(xfs_dir2_data_aoff_t)((char *)hdr + args->geo->blksize -\n\t\t\t\t       (char *)blp),\n\t\t&needlog, &needscan);\n\t \n\tdbp->b_ops = &xfs_dir3_data_buf_ops;\n\txfs_trans_buf_set_type(tp, dbp, XFS_BLFT_DIR_DATA_BUF);\n\tif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC))\n\t\thdr->magic = cpu_to_be32(XFS_DIR2_DATA_MAGIC);\n\telse\n\t\thdr->magic = cpu_to_be32(XFS_DIR3_DATA_MAGIC);\n\n\tif (needscan)\n\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\t \n\tltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\n\tltp->bestcount = cpu_to_be32(1);\n\tbestsp = xfs_dir2_leaf_bests_p(ltp);\n\tbestsp[0] =  bf[0].length;\n\t \n\tif (needlog)\n\t\txfs_dir2_data_log_header(args, dbp);\n\txfs_dir3_leaf_check(dp, lbp);\n\txfs_dir3_data_check(dp, dbp);\n\txfs_dir3_leaf_log_bests(args, lbp, 0, 0);\n\treturn 0;\n}\n\nSTATIC void\nxfs_dir3_leaf_find_stale(\n\tstruct xfs_dir3_icleaf_hdr *leafhdr,\n\tstruct xfs_dir2_leaf_entry *ents,\n\tint\t\t\tindex,\n\tint\t\t\t*lowstale,\n\tint\t\t\t*highstale)\n{\n\t \n\tfor (*lowstale = index - 1; *lowstale >= 0; --*lowstale) {\n\t\tif (ents[*lowstale].address ==\n\t\t    cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\n\t\t\tbreak;\n\t}\n\n\t \n\tfor (*highstale = index; *highstale < leafhdr->count; ++*highstale) {\n\t\tif (ents[*highstale].address ==\n\t\t    cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\n\t\t\tbreak;\n\t\tif (*lowstale >= 0 && index - *lowstale <= *highstale - index)\n\t\t\tbreak;\n\t}\n}\n\nstruct xfs_dir2_leaf_entry *\nxfs_dir3_leaf_find_entry(\n\tstruct xfs_dir3_icleaf_hdr *leafhdr,\n\tstruct xfs_dir2_leaf_entry *ents,\n\tint\t\t\tindex,\t\t \n\tint\t\t\tcompact,\t \n\tint\t\t\tlowstale,\t \n\tint\t\t\thighstale,\t \n\tint\t\t\t*lfloglow,\t \n\tint\t\t\t*lfloghigh)\t \n{\n\tif (!leafhdr->stale) {\n\t\txfs_dir2_leaf_entry_t\t*lep;\t \n\n\t\t \n\t\tlep = &ents[index];\n\t\tif (index < leafhdr->count)\n\t\t\tmemmove(lep + 1, lep,\n\t\t\t\t(leafhdr->count - index) * sizeof(*lep));\n\n\t\t \n\t\t*lfloglow = index;\n\t\t*lfloghigh = leafhdr->count++;\n\t\treturn lep;\n\t}\n\n\t \n\tif (compact == 0)\n\t\txfs_dir3_leaf_find_stale(leafhdr, ents, index,\n\t\t\t\t\t &lowstale, &highstale);\n\n\t \n\tif (lowstale >= 0 &&\n\t    (highstale == leafhdr->count ||\n\t     index - lowstale - 1 < highstale - index)) {\n\t\tASSERT(index - lowstale - 1 >= 0);\n\t\tASSERT(ents[lowstale].address ==\n\t\t       cpu_to_be32(XFS_DIR2_NULL_DATAPTR));\n\n\t\t \n\t\tif (index - lowstale - 1 > 0) {\n\t\t\tmemmove(&ents[lowstale], &ents[lowstale + 1],\n\t\t\t\t(index - lowstale - 1) *\n\t\t\t\t\tsizeof(xfs_dir2_leaf_entry_t));\n\t\t}\n\t\t*lfloglow = min(lowstale, *lfloglow);\n\t\t*lfloghigh = max(index - 1, *lfloghigh);\n\t\tleafhdr->stale--;\n\t\treturn &ents[index - 1];\n\t}\n\n\t \n\tASSERT(highstale - index >= 0);\n\tASSERT(ents[highstale].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR));\n\n\t \n\tif (highstale - index > 0) {\n\t\tmemmove(&ents[index + 1], &ents[index],\n\t\t\t(highstale - index) * sizeof(xfs_dir2_leaf_entry_t));\n\t}\n\t*lfloglow = min(index, *lfloglow);\n\t*lfloghigh = max(highstale, *lfloghigh);\n\tleafhdr->stale--;\n\treturn &ents[index];\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_leaf_addname(\n\tstruct xfs_da_args\t*args)\t\t \n{\n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\tstruct xfs_trans\t*tp = args->trans;\n\t__be16\t\t\t*bestsp;\t \n\t__be16\t\t\t*tagp;\t\t \n\tstruct xfs_buf\t\t*dbp;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\tstruct xfs_dir2_leaf\t*leaf;\t\t \n\tstruct xfs_inode\t*dp = args->dp;\t \n\tstruct xfs_dir2_data_hdr *hdr;\t\t \n\tstruct xfs_dir2_data_entry *dep;\t \n\tstruct xfs_dir2_leaf_entry *lep;\t \n\tstruct xfs_dir2_leaf_entry *ents;\n\tstruct xfs_dir2_data_unused *dup;\t \n\tstruct xfs_dir2_leaf_tail *ltp;\t\t \n\tstruct xfs_dir2_data_free *bf;\t\t \n\tint\t\t\tcompact;\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tgrown;\t\t \n\tint\t\t\thighstale = 0;\t \n\tint\t\t\ti;\t\t \n\tint\t\t\tindex;\t\t \n\tint\t\t\tlength;\t\t \n\tint\t\t\tlfloglow;\t \n\tint\t\t\tlfloghigh;\t \n\tint\t\t\tlowstale = 0;\t \n\tint\t\t\tneedbytes;\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\txfs_dir2_db_t\t\tuse_block;\t \n\n\ttrace_xfs_dir2_leaf_addname(args);\n\n\terror = xfs_dir3_leaf_read(tp, dp, args->geo->leafblk, &lbp);\n\tif (error)\n\t\treturn error;\n\n\t \n\tindex = xfs_dir2_leaf_search_hash(args, lbp);\n\tleaf = lbp->b_addr;\n\tltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\n\txfs_dir2_leaf_hdr_from_disk(dp->i_mount, &leafhdr, leaf);\n\tents = leafhdr.ents;\n\tbestsp = xfs_dir2_leaf_bests_p(ltp);\n\tlength = xfs_dir2_data_entsize(dp->i_mount, args->namelen);\n\n\t \n\tfor (use_block = -1, lep = &ents[index];\n\t     index < leafhdr.count && be32_to_cpu(lep->hashval) == args->hashval;\n\t     index++, lep++) {\n\t\tif (be32_to_cpu(lep->address) == XFS_DIR2_NULL_DATAPTR)\n\t\t\tcontinue;\n\t\ti = xfs_dir2_dataptr_to_db(args->geo, be32_to_cpu(lep->address));\n\t\tASSERT(i < be32_to_cpu(ltp->bestcount));\n\t\tASSERT(bestsp[i] != cpu_to_be16(NULLDATAOFF));\n\t\tif (be16_to_cpu(bestsp[i]) >= length) {\n\t\t\tuse_block = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\t \n\tif (use_block == -1) {\n\t\tfor (i = 0; i < be32_to_cpu(ltp->bestcount); i++) {\n\t\t\t \n\t\t\tif (bestsp[i] == cpu_to_be16(NULLDATAOFF) &&\n\t\t\t    use_block == -1)\n\t\t\t\tuse_block = i;\n\t\t\telse if (be16_to_cpu(bestsp[i]) >= length) {\n\t\t\t\tuse_block = i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t \n\tneedbytes = 0;\n\tif (!leafhdr.stale)\n\t\tneedbytes += sizeof(xfs_dir2_leaf_entry_t);\n\tif (use_block == -1)\n\t\tneedbytes += sizeof(xfs_dir2_data_off_t);\n\n\t \n\tif (use_block != -1 && bestsp[use_block] == cpu_to_be16(NULLDATAOFF))\n\t\tuse_block = -1;\n\t \n\tif ((char *)bestsp - (char *)&ents[leafhdr.count] < needbytes &&\n\t    leafhdr.stale > 1)\n\t\tcompact = 1;\n\n\t \n\telse if ((char *)bestsp - (char *)&ents[leafhdr.count] < needbytes) {\n\t\t \n\t\tif ((args->op_flags & XFS_DA_OP_JUSTCHECK) ||\n\t\t\t\t\t\t\targs->total == 0) {\n\t\t\txfs_trans_brelse(tp, lbp);\n\t\t\treturn -ENOSPC;\n\t\t}\n\t\t \n\t\terror = xfs_dir2_leaf_to_node(args, lbp);\n\t\tif (error)\n\t\t\treturn error;\n\t\t \n\t\treturn xfs_dir2_node_addname(args);\n\t}\n\t \n\telse\n\t\tcompact = 0;\n\t \n\tif (args->op_flags & XFS_DA_OP_JUSTCHECK) {\n\t\txfs_trans_brelse(tp, lbp);\n\t\treturn use_block == -1 ? -ENOSPC : 0;\n\t}\n\t \n\tif (args->total == 0 && use_block == -1) {\n\t\txfs_trans_brelse(tp, lbp);\n\t\treturn -ENOSPC;\n\t}\n\t \n\tif (compact) {\n\t\txfs_dir3_leaf_compact_x1(&leafhdr, ents, &index, &lowstale,\n\t\t\t&highstale, &lfloglow, &lfloghigh);\n\t}\n\t \n\telse if (leafhdr.stale) {\n\t\tlfloglow = leafhdr.count;\n\t\tlfloghigh = -1;\n\t}\n\t \n\tif (use_block == -1) {\n\t\t \n\t\tif ((error = xfs_dir2_grow_inode(args, XFS_DIR2_DATA_SPACE,\n\t\t\t\t&use_block))) {\n\t\t\txfs_trans_brelse(tp, lbp);\n\t\t\treturn error;\n\t\t}\n\t\t \n\t\tif ((error = xfs_dir3_data_init(args, use_block, &dbp))) {\n\t\t\txfs_trans_brelse(tp, lbp);\n\t\t\treturn error;\n\t\t}\n\t\t \n\t\tif (use_block >= be32_to_cpu(ltp->bestcount)) {\n\t\t\tbestsp--;\n\t\t\tmemmove(&bestsp[0], &bestsp[1],\n\t\t\t\tbe32_to_cpu(ltp->bestcount) * sizeof(bestsp[0]));\n\t\t\tbe32_add_cpu(&ltp->bestcount, 1);\n\t\t\txfs_dir3_leaf_log_tail(args, lbp);\n\t\t\txfs_dir3_leaf_log_bests(args, lbp, 0,\n\t\t\t\t\t\tbe32_to_cpu(ltp->bestcount) - 1);\n\t\t}\n\t\t \n\t\telse\n\t\t\txfs_dir3_leaf_log_bests(args, lbp, use_block, use_block);\n\t\thdr = dbp->b_addr;\n\t\tbf = xfs_dir2_data_bestfree_p(dp->i_mount, hdr);\n\t\tbestsp[use_block] = bf[0].length;\n\t\tgrown = 1;\n\t} else {\n\t\t \n\t\terror = xfs_dir3_data_read(tp, dp,\n\t\t\t\t   xfs_dir2_db_to_da(args->geo, use_block),\n\t\t\t\t   0, &dbp);\n\t\tif (error) {\n\t\t\txfs_trans_brelse(tp, lbp);\n\t\t\treturn error;\n\t\t}\n\t\thdr = dbp->b_addr;\n\t\tbf = xfs_dir2_data_bestfree_p(dp->i_mount, hdr);\n\t\tgrown = 0;\n\t}\n\t \n\tdup = (xfs_dir2_data_unused_t *)\n\t      ((char *)hdr + be16_to_cpu(bf[0].offset));\n\tneedscan = needlog = 0;\n\t \n\terror = xfs_dir2_data_use_free(args, dbp, dup,\n\t\t\t(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr),\n\t\t\tlength, &needlog, &needscan);\n\tif (error) {\n\t\txfs_trans_brelse(tp, lbp);\n\t\treturn error;\n\t}\n\t \n\tdep = (xfs_dir2_data_entry_t *)dup;\n\tdep->inumber = cpu_to_be64(args->inumber);\n\tdep->namelen = args->namelen;\n\tmemcpy(dep->name, args->name, dep->namelen);\n\txfs_dir2_data_put_ftype(dp->i_mount, dep, args->filetype);\n\ttagp = xfs_dir2_data_entry_tag_p(dp->i_mount, dep);\n\t*tagp = cpu_to_be16((char *)dep - (char *)hdr);\n\t \n\tif (needscan)\n\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\t \n\tif (needlog)\n\t\txfs_dir2_data_log_header(args, dbp);\n\txfs_dir2_data_log_entry(args, dbp, dep);\n\t \n\tif (be16_to_cpu(bestsp[use_block]) != be16_to_cpu(bf[0].length)) {\n\t\tbestsp[use_block] = bf[0].length;\n\t\tif (!grown)\n\t\t\txfs_dir3_leaf_log_bests(args, lbp, use_block, use_block);\n\t}\n\n\tlep = xfs_dir3_leaf_find_entry(&leafhdr, ents, index, compact, lowstale,\n\t\t\t\t       highstale, &lfloglow, &lfloghigh);\n\n\t \n\tlep->hashval = cpu_to_be32(args->hashval);\n\tlep->address = cpu_to_be32(\n\t\t\t\txfs_dir2_db_off_to_dataptr(args->geo, use_block,\n\t\t\t\tbe16_to_cpu(*tagp)));\n\t \n\txfs_dir2_leaf_hdr_to_disk(dp->i_mount, leaf, &leafhdr);\n\txfs_dir3_leaf_log_header(args, lbp);\n\txfs_dir3_leaf_log_ents(args, &leafhdr, lbp, lfloglow, lfloghigh);\n\txfs_dir3_leaf_check(dp, lbp);\n\txfs_dir3_data_check(dp, dbp);\n\treturn 0;\n}\n\n \nvoid\nxfs_dir3_leaf_compact(\n\txfs_da_args_t\t*args,\t\t \n\tstruct xfs_dir3_icleaf_hdr *leafhdr,\n\tstruct xfs_buf\t*bp)\t\t \n{\n\tint\t\tfrom;\t\t \n\txfs_dir2_leaf_t\t*leaf;\t\t \n\tint\t\tloglow;\t\t \n\tint\t\tto;\t\t \n\tstruct xfs_inode *dp = args->dp;\n\n\tleaf = bp->b_addr;\n\tif (!leafhdr->stale)\n\t\treturn;\n\n\t \n\tfor (from = to = 0, loglow = -1; from < leafhdr->count; from++) {\n\t\tif (leafhdr->ents[from].address ==\n\t\t    cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\n\t\t\tcontinue;\n\t\t \n\t\tif (from > to) {\n\t\t\tif (loglow == -1)\n\t\t\t\tloglow = to;\n\t\t\tleafhdr->ents[to] = leafhdr->ents[from];\n\t\t}\n\t\tto++;\n\t}\n\t \n\tASSERT(leafhdr->stale == from - to);\n\tleafhdr->count -= leafhdr->stale;\n\tleafhdr->stale = 0;\n\n\txfs_dir2_leaf_hdr_to_disk(dp->i_mount, leaf, leafhdr);\n\txfs_dir3_leaf_log_header(args, bp);\n\tif (loglow != -1)\n\t\txfs_dir3_leaf_log_ents(args, leafhdr, bp, loglow, to - 1);\n}\n\n \nvoid\nxfs_dir3_leaf_compact_x1(\n\tstruct xfs_dir3_icleaf_hdr *leafhdr,\n\tstruct xfs_dir2_leaf_entry *ents,\n\tint\t\t*indexp,\t \n\tint\t\t*lowstalep,\t \n\tint\t\t*highstalep,\t \n\tint\t\t*lowlogp,\t \n\tint\t\t*highlogp)\t \n{\n\tint\t\tfrom;\t\t \n\tint\t\thighstale;\t \n\tint\t\tindex;\t\t \n\tint\t\tkeepstale;\t \n\tint\t\tlowstale;\t \n\tint\t\tnewindex=0;\t \n\tint\t\tto;\t\t \n\n\tASSERT(leafhdr->stale > 1);\n\tindex = *indexp;\n\n\txfs_dir3_leaf_find_stale(leafhdr, ents, index, &lowstale, &highstale);\n\n\t \n\tif (lowstale >= 0 &&\n\t    (highstale == leafhdr->count ||\n\t     index - lowstale <= highstale - index))\n\t\tkeepstale = lowstale;\n\telse\n\t\tkeepstale = highstale;\n\t \n\tfor (from = to = 0; from < leafhdr->count; from++) {\n\t\t \n\t\tif (index == from)\n\t\t\tnewindex = to;\n\t\tif (from != keepstale &&\n\t\t    ents[from].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR)) {\n\t\t\tif (from == to)\n\t\t\t\t*lowlogp = to;\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (from == keepstale)\n\t\t\tlowstale = highstale = to;\n\t\t \n\t\tif (from > to)\n\t\t\tents[to] = ents[from];\n\t\tto++;\n\t}\n\tASSERT(from > to);\n\t \n\tif (index == from)\n\t\tnewindex = to;\n\t*indexp = newindex;\n\t \n\tleafhdr->count -= from - to;\n\tleafhdr->stale = 1;\n\t \n\tif (lowstale >= newindex)\n\t\tlowstale = -1;\n\telse\n\t\thighstale = leafhdr->count;\n\t*highlogp = leafhdr->count - 1;\n\t*lowstalep = lowstale;\n\t*highstalep = highstale;\n}\n\n \nstatic void\nxfs_dir3_leaf_log_bests(\n\tstruct xfs_da_args\t*args,\n\tstruct xfs_buf\t\t*bp,\t\t \n\tint\t\t\tfirst,\t\t \n\tint\t\t\tlast)\t\t \n{\n\t__be16\t\t\t*firstb;\t \n\t__be16\t\t\t*lastb;\t\t \n\tstruct xfs_dir2_leaf\t*leaf = bp->b_addr;\n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\n\tASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC));\n\n\tltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\n\tfirstb = xfs_dir2_leaf_bests_p(ltp) + first;\n\tlastb = xfs_dir2_leaf_bests_p(ltp) + last;\n\txfs_trans_log_buf(args->trans, bp,\n\t\t(uint)((char *)firstb - (char *)leaf),\n\t\t(uint)((char *)lastb - (char *)leaf + sizeof(*lastb) - 1));\n}\n\n \nvoid\nxfs_dir3_leaf_log_ents(\n\tstruct xfs_da_args\t*args,\n\tstruct xfs_dir3_icleaf_hdr *hdr,\n\tstruct xfs_buf\t\t*bp,\n\tint\t\t\tfirst,\n\tint\t\t\tlast)\n{\n\txfs_dir2_leaf_entry_t\t*firstlep;\t \n\txfs_dir2_leaf_entry_t\t*lastlep;\t \n\tstruct xfs_dir2_leaf\t*leaf = bp->b_addr;\n\n\tASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAFN_MAGIC));\n\n\tfirstlep = &hdr->ents[first];\n\tlastlep = &hdr->ents[last];\n\txfs_trans_log_buf(args->trans, bp,\n\t\t(uint)((char *)firstlep - (char *)leaf),\n\t\t(uint)((char *)lastlep - (char *)leaf + sizeof(*lastlep) - 1));\n}\n\n \nvoid\nxfs_dir3_leaf_log_header(\n\tstruct xfs_da_args\t*args,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_dir2_leaf\t*leaf = bp->b_addr;\n\n\tASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAFN_MAGIC));\n\n\txfs_trans_log_buf(args->trans, bp,\n\t\t\t  (uint)((char *)&leaf->hdr - (char *)leaf),\n\t\t\t  args->geo->leaf_hdr_size - 1);\n}\n\n \nSTATIC void\nxfs_dir3_leaf_log_tail(\n\tstruct xfs_da_args\t*args,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_dir2_leaf\t*leaf = bp->b_addr;\n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\n\tASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC) ||\n\t       leaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAFN_MAGIC));\n\n\tltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\n\txfs_trans_log_buf(args->trans, bp, (uint)((char *)ltp - (char *)leaf),\n\t\t(uint)(args->geo->blksize - 1));\n}\n\n \nint\nxfs_dir2_leaf_lookup(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_buf\t\t*dbp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tindex;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\txfs_dir2_leaf_entry_t\t*lep;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\ttrace_xfs_dir2_leaf_lookup(args);\n\n\t \n\terror = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp, &leafhdr);\n\tif (error)\n\t\treturn error;\n\n\ttp = args->trans;\n\tdp = args->dp;\n\txfs_dir3_leaf_check(dp, lbp);\n\n\t \n\tlep = &leafhdr.ents[index];\n\n\t \n\tdep = (xfs_dir2_data_entry_t *)\n\t      ((char *)dbp->b_addr +\n\t       xfs_dir2_dataptr_to_off(args->geo, be32_to_cpu(lep->address)));\n\t \n\targs->inumber = be64_to_cpu(dep->inumber);\n\targs->filetype = xfs_dir2_data_get_ftype(dp->i_mount, dep);\n\terror = xfs_dir_cilookup_result(args, dep->name, dep->namelen);\n\txfs_trans_brelse(tp, dbp);\n\txfs_trans_brelse(tp, lbp);\n\treturn error;\n}\n\n \nstatic int\t\t\t\t\t \nxfs_dir2_leaf_lookup_int(\n\txfs_da_args_t\t\t*args,\t\t \n\tstruct xfs_buf\t\t**lbpp,\t\t \n\tint\t\t\t*indexp,\t \n\tstruct xfs_buf\t\t**dbpp,\t\t \n\tstruct xfs_dir3_icleaf_hdr *leafhdr)\n{\n\txfs_dir2_db_t\t\tcurdb = -1;\t \n\tstruct xfs_buf\t\t*dbp = NULL;\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tindex;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\txfs_dir2_leaf_entry_t\t*lep;\t\t \n\txfs_dir2_leaf_t\t\t*leaf;\t\t \n\txfs_mount_t\t\t*mp;\t\t \n\txfs_dir2_db_t\t\tnewdb;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\txfs_dir2_db_t\t\tcidb = -1;\t \n\tenum xfs_dacmp\t\tcmp;\t\t \n\n\tdp = args->dp;\n\ttp = args->trans;\n\tmp = dp->i_mount;\n\n\terror = xfs_dir3_leaf_read(tp, dp, args->geo->leafblk, &lbp);\n\tif (error)\n\t\treturn error;\n\n\t*lbpp = lbp;\n\tleaf = lbp->b_addr;\n\txfs_dir3_leaf_check(dp, lbp);\n\txfs_dir2_leaf_hdr_from_disk(mp, leafhdr, leaf);\n\n\t \n\tindex = xfs_dir2_leaf_search_hash(args, lbp);\n\t \n\tfor (lep = &leafhdr->ents[index];\n\t     index < leafhdr->count &&\n\t\t\tbe32_to_cpu(lep->hashval) == args->hashval;\n\t     lep++, index++) {\n\t\t \n\t\tif (be32_to_cpu(lep->address) == XFS_DIR2_NULL_DATAPTR)\n\t\t\tcontinue;\n\t\t \n\t\tnewdb = xfs_dir2_dataptr_to_db(args->geo,\n\t\t\t\t\t       be32_to_cpu(lep->address));\n\t\t \n\t\tif (newdb != curdb) {\n\t\t\tif (dbp)\n\t\t\t\txfs_trans_brelse(tp, dbp);\n\t\t\terror = xfs_dir3_data_read(tp, dp,\n\t\t\t\t\t   xfs_dir2_db_to_da(args->geo, newdb),\n\t\t\t\t\t   0, &dbp);\n\t\t\tif (error) {\n\t\t\t\txfs_trans_brelse(tp, lbp);\n\t\t\t\treturn error;\n\t\t\t}\n\t\t\tcurdb = newdb;\n\t\t}\n\t\t \n\t\tdep = (xfs_dir2_data_entry_t *)((char *)dbp->b_addr +\n\t\t\txfs_dir2_dataptr_to_off(args->geo,\n\t\t\t\t\t\tbe32_to_cpu(lep->address)));\n\t\t \n\t\tcmp = xfs_dir2_compname(args, dep->name, dep->namelen);\n\t\tif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\n\t\t\targs->cmpresult = cmp;\n\t\t\t*indexp = index;\n\t\t\t \n\t\t\tif (cmp == XFS_CMP_EXACT) {\n\t\t\t\t*dbpp = dbp;\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tcidb = curdb;\n\t\t}\n\t}\n\tASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\n\t \n\tif (args->cmpresult == XFS_CMP_CASE) {\n\t\tASSERT(cidb != -1);\n\t\tif (cidb != curdb) {\n\t\t\txfs_trans_brelse(tp, dbp);\n\t\t\terror = xfs_dir3_data_read(tp, dp,\n\t\t\t\t\t   xfs_dir2_db_to_da(args->geo, cidb),\n\t\t\t\t\t   0, &dbp);\n\t\t\tif (error) {\n\t\t\t\txfs_trans_brelse(tp, lbp);\n\t\t\t\treturn error;\n\t\t\t}\n\t\t}\n\t\t*dbpp = dbp;\n\t\treturn 0;\n\t}\n\t \n\tASSERT(cidb == -1);\n\tif (dbp)\n\t\txfs_trans_brelse(tp, dbp);\n\txfs_trans_brelse(tp, lbp);\n\treturn -ENOENT;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_leaf_removename(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_da_geometry\t*geo = args->geo;\n\t__be16\t\t\t*bestsp;\t \n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_db_t\t\tdb;\t\t \n\tstruct xfs_buf\t\t*dbp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\txfs_dir2_db_t\t\ti;\t\t \n\tint\t\t\tindex;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\txfs_dir2_leaf_t\t\t*leaf;\t\t \n\txfs_dir2_leaf_entry_t\t*lep;\t\t \n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\txfs_dir2_data_off_t\toldbest;\t \n\tstruct xfs_dir2_data_free *bf;\t\t \n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\ttrace_xfs_dir2_leaf_removename(args);\n\n\t \n\terror = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp, &leafhdr);\n\tif (error)\n\t\treturn error;\n\n\tdp = args->dp;\n\tleaf = lbp->b_addr;\n\thdr = dbp->b_addr;\n\txfs_dir3_data_check(dp, dbp);\n\tbf = xfs_dir2_data_bestfree_p(dp->i_mount, hdr);\n\n\t \n\tlep = &leafhdr.ents[index];\n\tdb = xfs_dir2_dataptr_to_db(geo, be32_to_cpu(lep->address));\n\tdep = (xfs_dir2_data_entry_t *)((char *)hdr +\n\t\txfs_dir2_dataptr_to_off(geo, be32_to_cpu(lep->address)));\n\tneedscan = needlog = 0;\n\toldbest = be16_to_cpu(bf[0].length);\n\tltp = xfs_dir2_leaf_tail_p(geo, leaf);\n\tbestsp = xfs_dir2_leaf_bests_p(ltp);\n\tif (be16_to_cpu(bestsp[db]) != oldbest) {\n\t\txfs_buf_mark_corrupt(lbp);\n\t\treturn -EFSCORRUPTED;\n\t}\n\t \n\txfs_dir2_data_make_free(args, dbp,\n\t\t(xfs_dir2_data_aoff_t)((char *)dep - (char *)hdr),\n\t\txfs_dir2_data_entsize(dp->i_mount, dep->namelen), &needlog,\n\t\t&needscan);\n\t \n\tleafhdr.stale++;\n\txfs_dir2_leaf_hdr_to_disk(dp->i_mount, leaf, &leafhdr);\n\txfs_dir3_leaf_log_header(args, lbp);\n\n\tlep->address = cpu_to_be32(XFS_DIR2_NULL_DATAPTR);\n\txfs_dir3_leaf_log_ents(args, &leafhdr, lbp, index, index);\n\n\t \n\tif (needscan)\n\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\tif (needlog)\n\t\txfs_dir2_data_log_header(args, dbp);\n\t \n\tif (be16_to_cpu(bf[0].length) != oldbest) {\n\t\tbestsp[db] = bf[0].length;\n\t\txfs_dir3_leaf_log_bests(args, lbp, db, db);\n\t}\n\txfs_dir3_data_check(dp, dbp);\n\t \n\tif (be16_to_cpu(bf[0].length) ==\n\t    geo->blksize - geo->data_entry_offset) {\n\t\tASSERT(db != geo->datablk);\n\t\tif ((error = xfs_dir2_shrink_inode(args, db, dbp))) {\n\t\t\t \n\t\t\tif (error == -ENOSPC && args->total == 0)\n\t\t\t\terror = 0;\n\t\t\txfs_dir3_leaf_check(dp, lbp);\n\t\t\treturn error;\n\t\t}\n\t\tdbp = NULL;\n\t\t \n\t\tif (db == be32_to_cpu(ltp->bestcount) - 1) {\n\t\t\t \n\t\t\tfor (i = db - 1; i > 0; i--) {\n\t\t\t\tif (bestsp[i] != cpu_to_be16(NULLDATAOFF))\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t \n\t\t\tmemmove(&bestsp[db - i], bestsp,\n\t\t\t\t(be32_to_cpu(ltp->bestcount) - (db - i)) * sizeof(*bestsp));\n\t\t\tbe32_add_cpu(&ltp->bestcount, -(db - i));\n\t\t\txfs_dir3_leaf_log_tail(args, lbp);\n\t\t\txfs_dir3_leaf_log_bests(args, lbp, 0,\n\t\t\t\t\t\tbe32_to_cpu(ltp->bestcount) - 1);\n\t\t} else\n\t\t\tbestsp[db] = cpu_to_be16(NULLDATAOFF);\n\t}\n\t \n\telse if (db != geo->datablk)\n\t\tdbp = NULL;\n\n\txfs_dir3_leaf_check(dp, lbp);\n\t \n\treturn xfs_dir2_leaf_to_block(args, lbp, dbp);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_leaf_replace(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\tstruct xfs_buf\t\t*dbp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tindex;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\txfs_dir2_leaf_entry_t\t*lep;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\ttrace_xfs_dir2_leaf_replace(args);\n\n\t \n\terror = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp, &leafhdr);\n\tif (error)\n\t\treturn error;\n\n\tdp = args->dp;\n\t \n\tlep = &leafhdr.ents[index];\n\t \n\tdep = (xfs_dir2_data_entry_t *)\n\t      ((char *)dbp->b_addr +\n\t       xfs_dir2_dataptr_to_off(args->geo, be32_to_cpu(lep->address)));\n\tASSERT(args->inumber != be64_to_cpu(dep->inumber));\n\t \n\tdep->inumber = cpu_to_be64(args->inumber);\n\txfs_dir2_data_put_ftype(dp->i_mount, dep, args->filetype);\n\ttp = args->trans;\n\txfs_dir2_data_log_entry(args, dbp, dep);\n\txfs_dir3_leaf_check(dp, lbp);\n\txfs_trans_brelse(tp, lbp);\n\treturn 0;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_leaf_search_hash(\n\txfs_da_args_t\t\t*args,\t\t \n\tstruct xfs_buf\t\t*lbp)\t\t \n{\n\txfs_dahash_t\t\thash=0;\t\t \n\txfs_dahash_t\t\thashwant;\t \n\tint\t\t\thigh;\t\t \n\tint\t\t\tlow;\t\t \n\txfs_dir2_leaf_entry_t\t*lep;\t\t \n\tint\t\t\tmid=0;\t\t \n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\txfs_dir2_leaf_hdr_from_disk(args->dp->i_mount, &leafhdr, lbp->b_addr);\n\n\t \n\tfor (lep = leafhdr.ents, low = 0, high = leafhdr.count - 1,\n\t\thashwant = args->hashval;\n\t     low <= high; ) {\n\t\tmid = (low + high) >> 1;\n\t\tif ((hash = be32_to_cpu(lep[mid].hashval)) == hashwant)\n\t\t\tbreak;\n\t\tif (hash < hashwant)\n\t\t\tlow = mid + 1;\n\t\telse\n\t\t\thigh = mid - 1;\n\t}\n\t \n\tif (hash == hashwant) {\n\t\twhile (mid > 0 && be32_to_cpu(lep[mid - 1].hashval) == hashwant) {\n\t\t\tmid--;\n\t\t}\n\t}\n\t \n\telse if (hash < hashwant)\n\t\tmid++;\n\treturn mid;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_leaf_trim_data(\n\txfs_da_args_t\t\t*args,\t\t \n\tstruct xfs_buf\t\t*lbp,\t\t \n\txfs_dir2_db_t\t\tdb)\t\t \n{\n\tstruct xfs_da_geometry\t*geo = args->geo;\n\t__be16\t\t\t*bestsp;\t \n\tstruct xfs_buf\t\t*dbp;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\txfs_dir2_leaf_t\t\t*leaf;\t\t \n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\n\tdp = args->dp;\n\ttp = args->trans;\n\t \n\terror = xfs_dir3_data_read(tp, dp, xfs_dir2_db_to_da(geo, db), 0, &dbp);\n\tif (error)\n\t\treturn error;\n\n\tleaf = lbp->b_addr;\n\tltp = xfs_dir2_leaf_tail_p(geo, leaf);\n\n#ifdef DEBUG\n{\n\tstruct xfs_dir2_data_hdr *hdr = dbp->b_addr;\n\tstruct xfs_dir2_data_free *bf =\n\t\txfs_dir2_data_bestfree_p(dp->i_mount, hdr);\n\n\tASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\n\t       hdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC));\n\tASSERT(be16_to_cpu(bf[0].length) ==\n\t       geo->blksize - geo->data_entry_offset);\n\tASSERT(db == be32_to_cpu(ltp->bestcount) - 1);\n}\n#endif\n\n\t \n\tif ((error = xfs_dir2_shrink_inode(args, db, dbp))) {\n\t\tASSERT(error != -ENOSPC);\n\t\txfs_trans_brelse(tp, dbp);\n\t\treturn error;\n\t}\n\t \n\tbestsp = xfs_dir2_leaf_bests_p(ltp);\n\tbe32_add_cpu(&ltp->bestcount, -1);\n\tmemmove(&bestsp[1], &bestsp[0], be32_to_cpu(ltp->bestcount) * sizeof(*bestsp));\n\txfs_dir3_leaf_log_tail(args, lbp);\n\txfs_dir3_leaf_log_bests(args, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\n\treturn 0;\n}\n\nstatic inline size_t\nxfs_dir3_leaf_size(\n\tstruct xfs_dir3_icleaf_hdr\t*hdr,\n\tint\t\t\t\tcounts)\n{\n\tint\tentries;\n\tint\thdrsize;\n\n\tentries = hdr->count - hdr->stale;\n\tif (hdr->magic == XFS_DIR2_LEAF1_MAGIC ||\n\t    hdr->magic == XFS_DIR2_LEAFN_MAGIC)\n\t\thdrsize = sizeof(struct xfs_dir2_leaf_hdr);\n\telse\n\t\thdrsize = sizeof(struct xfs_dir3_leaf_hdr);\n\n\treturn hdrsize + entries * sizeof(xfs_dir2_leaf_entry_t)\n\t               + counts * sizeof(xfs_dir2_data_off_t)\n\t\t       + sizeof(xfs_dir2_leaf_tail_t);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_node_to_leaf(\n\txfs_da_state_t\t\t*state)\t\t \n{\n\txfs_da_args_t\t\t*args;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\tstruct xfs_buf\t\t*fbp;\t\t \n\txfs_fileoff_t\t\tfo;\t\t \n\tstruct xfs_buf\t\t*lbp;\t\t \n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\txfs_dir2_leaf_t\t\t*leaf;\t\t \n\txfs_mount_t\t\t*mp;\t\t \n\tint\t\t\trval;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\tstruct xfs_dir3_icfree_hdr freehdr;\n\n\t \n\tif (state->path.active > 1)\n\t\treturn 0;\n\targs = state->args;\n\n\ttrace_xfs_dir2_node_to_leaf(args);\n\n\tmp = state->mp;\n\tdp = args->dp;\n\ttp = args->trans;\n\t \n\tif ((error = xfs_bmap_last_offset(dp, &fo, XFS_DATA_FORK))) {\n\t\treturn error;\n\t}\n\tfo -= args->geo->fsbcount;\n\t \n\twhile (fo > args->geo->freeblk) {\n\t\tif ((error = xfs_dir2_node_trim_free(args, fo, &rval))) {\n\t\t\treturn error;\n\t\t}\n\t\tif (rval)\n\t\t\tfo -= args->geo->fsbcount;\n\t\telse\n\t\t\treturn 0;\n\t}\n\t \n\tif ((error = xfs_bmap_last_before(tp, dp, &fo, XFS_DATA_FORK))) {\n\t\treturn error;\n\t}\n\t \n\tif (XFS_FSB_TO_B(mp, fo) > XFS_DIR2_LEAF_OFFSET + args->geo->blksize)\n\t\treturn 0;\n\tlbp = state->path.blk[0].bp;\n\tleaf = lbp->b_addr;\n\txfs_dir2_leaf_hdr_from_disk(mp, &leafhdr, leaf);\n\n\tASSERT(leafhdr.magic == XFS_DIR2_LEAFN_MAGIC ||\n\t       leafhdr.magic == XFS_DIR3_LEAFN_MAGIC);\n\n\t \n\terror = xfs_dir2_free_read(tp, dp,  args->geo->freeblk, &fbp);\n\tif (error)\n\t\treturn error;\n\txfs_dir2_free_hdr_from_disk(mp, &freehdr, fbp->b_addr);\n\n\tASSERT(!freehdr.firstdb);\n\n\t \n\tif (xfs_dir3_leaf_size(&leafhdr, freehdr.nvalid) > args->geo->blksize) {\n\t\txfs_trans_brelse(tp, fbp);\n\t\treturn 0;\n\t}\n\n\t \n\tif (leafhdr.stale)\n\t\txfs_dir3_leaf_compact(args, &leafhdr, lbp);\n\n\tlbp->b_ops = &xfs_dir3_leaf1_buf_ops;\n\txfs_trans_buf_set_type(tp, lbp, XFS_BLFT_DIR_LEAF1_BUF);\n\tleafhdr.magic = (leafhdr.magic == XFS_DIR2_LEAFN_MAGIC)\n\t\t\t\t\t? XFS_DIR2_LEAF1_MAGIC\n\t\t\t\t\t: XFS_DIR3_LEAF1_MAGIC;\n\n\t \n\tltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\n\tltp->bestcount = cpu_to_be32(freehdr.nvalid);\n\n\t \n\tmemcpy(xfs_dir2_leaf_bests_p(ltp), freehdr.bests,\n\t\tfreehdr.nvalid * sizeof(xfs_dir2_data_off_t));\n\n\txfs_dir2_leaf_hdr_to_disk(mp, leaf, &leafhdr);\n\txfs_dir3_leaf_log_header(args, lbp);\n\txfs_dir3_leaf_log_bests(args, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\n\txfs_dir3_leaf_log_tail(args, lbp);\n\txfs_dir3_leaf_check(dp, lbp);\n\n\t \n\terror = xfs_dir2_shrink_inode(args,\n\t\t\txfs_dir2_byte_to_db(args->geo, XFS_DIR2_FREE_OFFSET),\n\t\t\tfbp);\n\tif (error) {\n\t\t \n\t\tASSERT(error != -ENOSPC);\n\t\treturn error;\n\t}\n\tfbp = NULL;\n\t \n\terror = xfs_dir2_leaf_to_block(args, lbp, NULL);\n\tstate->path.blk[0].bp = NULL;\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}