{
  "module_name": "xfs_inode_buf.c",
  "hash_id": "457f9a4d7ed1e9ab942cfa86d575f9dc22e82315b3bd0c1ce039023a726df906",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_inode_buf.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_ag.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_errortag.h\"\n#include \"xfs_error.h\"\n#include \"xfs_icache.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_ialloc.h\"\n#include \"xfs_dir2.h\"\n\n#include <linux/iversion.h>\n\n \nstatic void\nxfs_inode_buf_verify(\n\tstruct xfs_buf\t*bp,\n\tbool\t\treadahead)\n{\n\tstruct xfs_mount *mp = bp->b_mount;\n\tint\t\ti;\n\tint\t\tni;\n\n\t \n\tni = XFS_BB_TO_FSB(mp, bp->b_length) * mp->m_sb.sb_inopblock;\n\tfor (i = 0; i < ni; i++) {\n\t\tstruct xfs_dinode\t*dip;\n\t\txfs_agino_t\t\tunlinked_ino;\n\t\tint\t\t\tdi_ok;\n\n\t\tdip = xfs_buf_offset(bp, (i << mp->m_sb.sb_inodelog));\n\t\tunlinked_ino = be32_to_cpu(dip->di_next_unlinked);\n\t\tdi_ok = xfs_verify_magic16(bp, dip->di_magic) &&\n\t\t\txfs_dinode_good_version(mp, dip->di_version) &&\n\t\t\txfs_verify_agino_or_null(bp->b_pag, unlinked_ino);\n\t\tif (unlikely(XFS_TEST_ERROR(!di_ok, mp,\n\t\t\t\t\t\tXFS_ERRTAG_ITOBP_INOTOBP))) {\n\t\t\tif (readahead) {\n\t\t\t\tbp->b_flags &= ~XBF_DONE;\n\t\t\t\txfs_buf_ioerror(bp, -EIO);\n\t\t\t\treturn;\n\t\t\t}\n\n#ifdef DEBUG\n\t\t\txfs_alert(mp,\n\t\t\t\t\"bad inode magic/vsn daddr %lld #%d (magic=%x)\",\n\t\t\t\t(unsigned long long)xfs_buf_daddr(bp), i,\n\t\t\t\tbe16_to_cpu(dip->di_magic));\n#endif\n\t\t\txfs_buf_verifier_error(bp, -EFSCORRUPTED,\n\t\t\t\t\t__func__, dip, sizeof(*dip),\n\t\t\t\t\tNULL);\n\t\t\treturn;\n\t\t}\n\t}\n}\n\n\nstatic void\nxfs_inode_buf_read_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_inode_buf_verify(bp, false);\n}\n\nstatic void\nxfs_inode_buf_readahead_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_inode_buf_verify(bp, true);\n}\n\nstatic void\nxfs_inode_buf_write_verify(\n\tstruct xfs_buf\t*bp)\n{\n\txfs_inode_buf_verify(bp, false);\n}\n\nconst struct xfs_buf_ops xfs_inode_buf_ops = {\n\t.name = \"xfs_inode\",\n\t.magic16 = { cpu_to_be16(XFS_DINODE_MAGIC),\n\t\t     cpu_to_be16(XFS_DINODE_MAGIC) },\n\t.verify_read = xfs_inode_buf_read_verify,\n\t.verify_write = xfs_inode_buf_write_verify,\n};\n\nconst struct xfs_buf_ops xfs_inode_buf_ra_ops = {\n\t.name = \"xfs_inode_ra\",\n\t.magic16 = { cpu_to_be16(XFS_DINODE_MAGIC),\n\t\t     cpu_to_be16(XFS_DINODE_MAGIC) },\n\t.verify_read = xfs_inode_buf_readahead_verify,\n\t.verify_write = xfs_inode_buf_write_verify,\n};\n\n\n \nint\nxfs_imap_to_bp(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_imap\t\t*imap,\n\tstruct xfs_buf\t\t**bpp)\n{\n\treturn xfs_trans_read_buf(mp, tp, mp->m_ddev_targp, imap->im_blkno,\n\t\t\t\t   imap->im_len, XBF_UNMAPPED, bpp,\n\t\t\t\t   &xfs_inode_buf_ops);\n}\n\nstatic inline struct timespec64 xfs_inode_decode_bigtime(uint64_t ts)\n{\n\tstruct timespec64\ttv;\n\tuint32_t\t\tn;\n\n\ttv.tv_sec = xfs_bigtime_to_unix(div_u64_rem(ts, NSEC_PER_SEC, &n));\n\ttv.tv_nsec = n;\n\n\treturn tv;\n}\n\n \nstruct timespec64\nxfs_inode_from_disk_ts(\n\tstruct xfs_dinode\t\t*dip,\n\tconst xfs_timestamp_t\t\tts)\n{\n\tstruct timespec64\t\ttv;\n\tstruct xfs_legacy_timestamp\t*lts;\n\n\tif (xfs_dinode_has_bigtime(dip))\n\t\treturn xfs_inode_decode_bigtime(be64_to_cpu(ts));\n\n\tlts = (struct xfs_legacy_timestamp *)&ts;\n\ttv.tv_sec = (int)be32_to_cpu(lts->t_sec);\n\ttv.tv_nsec = (int)be32_to_cpu(lts->t_nsec);\n\n\treturn tv;\n}\n\nint\nxfs_inode_from_disk(\n\tstruct xfs_inode\t*ip,\n\tstruct xfs_dinode\t*from)\n{\n\tstruct inode\t\t*inode = VFS_I(ip);\n\tint\t\t\terror;\n\txfs_failaddr_t\t\tfa;\n\n\tASSERT(ip->i_cowfp == NULL);\n\n\tfa = xfs_dinode_verify(ip->i_mount, ip->i_ino, from);\n\tif (fa) {\n\t\txfs_inode_verifier_error(ip, -EFSCORRUPTED, \"dinode\", from,\n\t\t\t\tsizeof(*from), fa);\n\t\treturn -EFSCORRUPTED;\n\t}\n\n\t \n\tif (!xfs_has_v3inodes(ip->i_mount))\n\t\tip->i_flushiter = be16_to_cpu(from->di_flushiter);\n\tinode->i_generation = be32_to_cpu(from->di_gen);\n\tinode->i_mode = be16_to_cpu(from->di_mode);\n\tif (!inode->i_mode)\n\t\treturn 0;\n\n\t \n\tif (unlikely(from->di_version == 1)) {\n\t\tset_nlink(inode, be16_to_cpu(from->di_onlink));\n\t\tip->i_projid = 0;\n\t} else {\n\t\tset_nlink(inode, be32_to_cpu(from->di_nlink));\n\t\tip->i_projid = (prid_t)be16_to_cpu(from->di_projid_hi) << 16 |\n\t\t\t\t\tbe16_to_cpu(from->di_projid_lo);\n\t}\n\n\ti_uid_write(inode, be32_to_cpu(from->di_uid));\n\ti_gid_write(inode, be32_to_cpu(from->di_gid));\n\n\t \n\tinode->i_atime = xfs_inode_from_disk_ts(from, from->di_atime);\n\tinode->i_mtime = xfs_inode_from_disk_ts(from, from->di_mtime);\n\tinode_set_ctime_to_ts(inode,\n\t\t\t      xfs_inode_from_disk_ts(from, from->di_ctime));\n\n\tip->i_disk_size = be64_to_cpu(from->di_size);\n\tip->i_nblocks = be64_to_cpu(from->di_nblocks);\n\tip->i_extsize = be32_to_cpu(from->di_extsize);\n\tip->i_forkoff = from->di_forkoff;\n\tip->i_diflags = be16_to_cpu(from->di_flags);\n\tip->i_next_unlinked = be32_to_cpu(from->di_next_unlinked);\n\n\tif (from->di_dmevmask || from->di_dmstate)\n\t\txfs_iflags_set(ip, XFS_IPRESERVE_DM_FIELDS);\n\n\tif (xfs_has_v3inodes(ip->i_mount)) {\n\t\tinode_set_iversion_queried(inode,\n\t\t\t\t\t   be64_to_cpu(from->di_changecount));\n\t\tip->i_crtime = xfs_inode_from_disk_ts(from, from->di_crtime);\n\t\tip->i_diflags2 = be64_to_cpu(from->di_flags2);\n\t\tip->i_cowextsize = be32_to_cpu(from->di_cowextsize);\n\t}\n\n\terror = xfs_iformat_data_fork(ip, from);\n\tif (error)\n\t\treturn error;\n\tif (from->di_forkoff) {\n\t\terror = xfs_iformat_attr_fork(ip, from);\n\t\tif (error)\n\t\t\tgoto out_destroy_data_fork;\n\t}\n\tif (xfs_is_reflink_inode(ip))\n\t\txfs_ifork_init_cow(ip);\n\treturn 0;\n\nout_destroy_data_fork:\n\txfs_idestroy_fork(&ip->i_df);\n\treturn error;\n}\n\n \nstatic inline xfs_timestamp_t\nxfs_inode_to_disk_ts(\n\tstruct xfs_inode\t\t*ip,\n\tconst struct timespec64\t\ttv)\n{\n\tstruct xfs_legacy_timestamp\t*lts;\n\txfs_timestamp_t\t\t\tts;\n\n\tif (xfs_inode_has_bigtime(ip))\n\t\treturn cpu_to_be64(xfs_inode_encode_bigtime(tv));\n\n\tlts = (struct xfs_legacy_timestamp *)&ts;\n\tlts->t_sec = cpu_to_be32(tv.tv_sec);\n\tlts->t_nsec = cpu_to_be32(tv.tv_nsec);\n\n\treturn ts;\n}\n\nstatic inline void\nxfs_inode_to_disk_iext_counters(\n\tstruct xfs_inode\t*ip,\n\tstruct xfs_dinode\t*to)\n{\n\tif (xfs_inode_has_large_extent_counts(ip)) {\n\t\tto->di_big_nextents = cpu_to_be64(xfs_ifork_nextents(&ip->i_df));\n\t\tto->di_big_anextents = cpu_to_be32(xfs_ifork_nextents(&ip->i_af));\n\t\t \n\t\tto->di_nrext64_pad = cpu_to_be16(0);\n\t} else {\n\t\tto->di_nextents = cpu_to_be32(xfs_ifork_nextents(&ip->i_df));\n\t\tto->di_anextents = cpu_to_be16(xfs_ifork_nextents(&ip->i_af));\n\t}\n}\n\nvoid\nxfs_inode_to_disk(\n\tstruct xfs_inode\t*ip,\n\tstruct xfs_dinode\t*to,\n\txfs_lsn_t\t\tlsn)\n{\n\tstruct inode\t\t*inode = VFS_I(ip);\n\n\tto->di_magic = cpu_to_be16(XFS_DINODE_MAGIC);\n\tto->di_onlink = 0;\n\n\tto->di_format = xfs_ifork_format(&ip->i_df);\n\tto->di_uid = cpu_to_be32(i_uid_read(inode));\n\tto->di_gid = cpu_to_be32(i_gid_read(inode));\n\tto->di_projid_lo = cpu_to_be16(ip->i_projid & 0xffff);\n\tto->di_projid_hi = cpu_to_be16(ip->i_projid >> 16);\n\n\tto->di_atime = xfs_inode_to_disk_ts(ip, inode->i_atime);\n\tto->di_mtime = xfs_inode_to_disk_ts(ip, inode->i_mtime);\n\tto->di_ctime = xfs_inode_to_disk_ts(ip, inode_get_ctime(inode));\n\tto->di_nlink = cpu_to_be32(inode->i_nlink);\n\tto->di_gen = cpu_to_be32(inode->i_generation);\n\tto->di_mode = cpu_to_be16(inode->i_mode);\n\n\tto->di_size = cpu_to_be64(ip->i_disk_size);\n\tto->di_nblocks = cpu_to_be64(ip->i_nblocks);\n\tto->di_extsize = cpu_to_be32(ip->i_extsize);\n\tto->di_forkoff = ip->i_forkoff;\n\tto->di_aformat = xfs_ifork_format(&ip->i_af);\n\tto->di_flags = cpu_to_be16(ip->i_diflags);\n\n\tif (xfs_has_v3inodes(ip->i_mount)) {\n\t\tto->di_version = 3;\n\t\tto->di_changecount = cpu_to_be64(inode_peek_iversion(inode));\n\t\tto->di_crtime = xfs_inode_to_disk_ts(ip, ip->i_crtime);\n\t\tto->di_flags2 = cpu_to_be64(ip->i_diflags2);\n\t\tto->di_cowextsize = cpu_to_be32(ip->i_cowextsize);\n\t\tto->di_ino = cpu_to_be64(ip->i_ino);\n\t\tto->di_lsn = cpu_to_be64(lsn);\n\t\tmemset(to->di_pad2, 0, sizeof(to->di_pad2));\n\t\tuuid_copy(&to->di_uuid, &ip->i_mount->m_sb.sb_meta_uuid);\n\t\tto->di_v3_pad = 0;\n\t} else {\n\t\tto->di_version = 2;\n\t\tto->di_flushiter = cpu_to_be16(ip->i_flushiter);\n\t\tmemset(to->di_v2_pad, 0, sizeof(to->di_v2_pad));\n\t}\n\n\txfs_inode_to_disk_iext_counters(ip, to);\n}\n\nstatic xfs_failaddr_t\nxfs_dinode_verify_fork(\n\tstruct xfs_dinode\t*dip,\n\tstruct xfs_mount\t*mp,\n\tint\t\t\twhichfork)\n{\n\txfs_extnum_t\t\tdi_nextents;\n\txfs_extnum_t\t\tmax_extents;\n\tmode_t\t\t\tmode = be16_to_cpu(dip->di_mode);\n\tuint32_t\t\tfork_size = XFS_DFORK_SIZE(dip, mp, whichfork);\n\tuint32_t\t\tfork_format = XFS_DFORK_FORMAT(dip, whichfork);\n\n\tdi_nextents = xfs_dfork_nextents(dip, whichfork);\n\n\t \n\tif (whichfork == XFS_DATA_FORK) {\n\t\tif (S_ISDIR(mode) || S_ISLNK(mode)) {\n\t\t\tif (be64_to_cpu(dip->di_size) <= fork_size &&\n\t\t\t    fork_format != XFS_DINODE_FMT_LOCAL)\n\t\t\t\treturn __this_address;\n\t\t}\n\n\t\tif (be64_to_cpu(dip->di_size) > fork_size &&\n\t\t    fork_format == XFS_DINODE_FMT_LOCAL)\n\t\t\treturn __this_address;\n\t}\n\n\tswitch (fork_format) {\n\tcase XFS_DINODE_FMT_LOCAL:\n\t\t \n\t\tif (S_ISREG(mode) && whichfork == XFS_DATA_FORK)\n\t\t\treturn __this_address;\n\t\tif (di_nextents)\n\t\t\treturn __this_address;\n\t\tbreak;\n\tcase XFS_DINODE_FMT_EXTENTS:\n\t\tif (di_nextents > XFS_DFORK_MAXEXT(dip, mp, whichfork))\n\t\t\treturn __this_address;\n\t\tbreak;\n\tcase XFS_DINODE_FMT_BTREE:\n\t\tmax_extents = xfs_iext_max_nextents(\n\t\t\t\t\txfs_dinode_has_large_extent_counts(dip),\n\t\t\t\t\twhichfork);\n\t\tif (di_nextents > max_extents)\n\t\t\treturn __this_address;\n\t\tbreak;\n\tdefault:\n\t\treturn __this_address;\n\t}\n\treturn NULL;\n}\n\nstatic xfs_failaddr_t\nxfs_dinode_verify_forkoff(\n\tstruct xfs_dinode\t*dip,\n\tstruct xfs_mount\t*mp)\n{\n\tif (!dip->di_forkoff)\n\t\treturn NULL;\n\n\tswitch (dip->di_format)  {\n\tcase XFS_DINODE_FMT_DEV:\n\t\tif (dip->di_forkoff != (roundup(sizeof(xfs_dev_t), 8) >> 3))\n\t\t\treturn __this_address;\n\t\tbreak;\n\tcase XFS_DINODE_FMT_LOCAL:\t \n\tcase XFS_DINODE_FMT_EXTENTS:     \n\tcase XFS_DINODE_FMT_BTREE:\n\t\tif (dip->di_forkoff >= (XFS_LITINO(mp) >> 3))\n\t\t\treturn __this_address;\n\t\tbreak;\n\tdefault:\n\t\treturn __this_address;\n\t}\n\treturn NULL;\n}\n\nstatic xfs_failaddr_t\nxfs_dinode_verify_nrext64(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dinode\t*dip)\n{\n\tif (xfs_dinode_has_large_extent_counts(dip)) {\n\t\tif (!xfs_has_large_extent_counts(mp))\n\t\t\treturn __this_address;\n\t\tif (dip->di_nrext64_pad != 0)\n\t\t\treturn __this_address;\n\t} else if (dip->di_version >= 3) {\n\t\tif (dip->di_v3_pad != 0)\n\t\t\treturn __this_address;\n\t}\n\n\treturn NULL;\n}\n\nxfs_failaddr_t\nxfs_dinode_verify(\n\tstruct xfs_mount\t*mp,\n\txfs_ino_t\t\tino,\n\tstruct xfs_dinode\t*dip)\n{\n\txfs_failaddr_t\t\tfa;\n\tuint16_t\t\tmode;\n\tuint16_t\t\tflags;\n\tuint64_t\t\tflags2;\n\tuint64_t\t\tdi_size;\n\txfs_extnum_t\t\tnextents;\n\txfs_extnum_t\t\tnaextents;\n\txfs_filblks_t\t\tnblocks;\n\n\tif (dip->di_magic != cpu_to_be16(XFS_DINODE_MAGIC))\n\t\treturn __this_address;\n\n\t \n\tif (dip->di_version >= 3) {\n\t\tif (!xfs_has_v3inodes(mp))\n\t\t\treturn __this_address;\n\t\tif (!xfs_verify_cksum((char *)dip, mp->m_sb.sb_inodesize,\n\t\t\t\t      XFS_DINODE_CRC_OFF))\n\t\t\treturn __this_address;\n\t\tif (be64_to_cpu(dip->di_ino) != ino)\n\t\t\treturn __this_address;\n\t\tif (!uuid_equal(&dip->di_uuid, &mp->m_sb.sb_meta_uuid))\n\t\t\treturn __this_address;\n\t}\n\n\t \n\tdi_size = be64_to_cpu(dip->di_size);\n\tif (di_size & (1ULL << 63))\n\t\treturn __this_address;\n\n\tmode = be16_to_cpu(dip->di_mode);\n\tif (mode && xfs_mode_to_ftype(mode) == XFS_DIR3_FT_UNKNOWN)\n\t\treturn __this_address;\n\n\t \n\tif ((S_ISLNK(mode) || S_ISDIR(mode)) && di_size == 0)\n\t\treturn __this_address;\n\n\tfa = xfs_dinode_verify_nrext64(mp, dip);\n\tif (fa)\n\t\treturn fa;\n\n\tnextents = xfs_dfork_data_extents(dip);\n\tnaextents = xfs_dfork_attr_extents(dip);\n\tnblocks = be64_to_cpu(dip->di_nblocks);\n\n\t \n\tif (mode && nextents + naextents > nblocks)\n\t\treturn __this_address;\n\n\tif (S_ISDIR(mode) && nextents > mp->m_dir_geo->max_extents)\n\t\treturn __this_address;\n\n\tif (mode && XFS_DFORK_BOFF(dip) > mp->m_sb.sb_inodesize)\n\t\treturn __this_address;\n\n\tflags = be16_to_cpu(dip->di_flags);\n\n\tif (mode && (flags & XFS_DIFLAG_REALTIME) && !mp->m_rtdev_targp)\n\t\treturn __this_address;\n\n\t \n\tfa = xfs_dinode_verify_forkoff(dip, mp);\n\tif (fa)\n\t\treturn fa;\n\n\t \n\tswitch (mode & S_IFMT) {\n\tcase S_IFIFO:\n\tcase S_IFCHR:\n\tcase S_IFBLK:\n\tcase S_IFSOCK:\n\t\tif (dip->di_format != XFS_DINODE_FMT_DEV)\n\t\t\treturn __this_address;\n\t\tbreak;\n\tcase S_IFREG:\n\tcase S_IFLNK:\n\tcase S_IFDIR:\n\t\tfa = xfs_dinode_verify_fork(dip, mp, XFS_DATA_FORK);\n\t\tif (fa)\n\t\t\treturn fa;\n\t\tbreak;\n\tcase 0:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\treturn __this_address;\n\t}\n\n\tif (dip->di_forkoff) {\n\t\tfa = xfs_dinode_verify_fork(dip, mp, XFS_ATTR_FORK);\n\t\tif (fa)\n\t\t\treturn fa;\n\t} else {\n\t\t \n\t\tswitch (dip->di_aformat) {\n\t\tcase 0:\n\t\tcase XFS_DINODE_FMT_EXTENTS:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn __this_address;\n\t\t}\n\t\tif (naextents)\n\t\t\treturn __this_address;\n\t}\n\n\t \n\tfa = xfs_inode_validate_extsize(mp, be32_to_cpu(dip->di_extsize),\n\t\t\tmode, flags);\n\tif (fa)\n\t\treturn fa;\n\n\t \n\tif (dip->di_version < 3)\n\t\treturn NULL;\n\n\tflags2 = be64_to_cpu(dip->di_flags2);\n\n\t \n\tif ((flags2 & (XFS_DIFLAG2_REFLINK | XFS_DIFLAG2_COWEXTSIZE)) &&\n\t     !xfs_has_reflink(mp))\n\t\treturn __this_address;\n\n\t \n\tif ((flags2 & XFS_DIFLAG2_REFLINK) && (mode & S_IFMT) != S_IFREG)\n\t\treturn __this_address;\n\n\t \n\tif ((flags2 & XFS_DIFLAG2_REFLINK) && (flags & XFS_DIFLAG_REALTIME))\n\t\treturn __this_address;\n\n\t \n\tfa = xfs_inode_validate_cowextsize(mp, be32_to_cpu(dip->di_cowextsize),\n\t\t\tmode, flags, flags2);\n\tif (fa)\n\t\treturn fa;\n\n\t \n\tif (xfs_dinode_has_bigtime(dip) &&\n\t    !xfs_has_bigtime(mp))\n\t\treturn __this_address;\n\n\treturn NULL;\n}\n\nvoid\nxfs_dinode_calc_crc(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_dinode\t*dip)\n{\n\tuint32_t\t\tcrc;\n\n\tif (dip->di_version < 3)\n\t\treturn;\n\n\tASSERT(xfs_has_crc(mp));\n\tcrc = xfs_start_cksum_update((char *)dip, mp->m_sb.sb_inodesize,\n\t\t\t      XFS_DINODE_CRC_OFF);\n\tdip->di_crc = xfs_end_cksum(crc);\n}\n\n \nxfs_failaddr_t\nxfs_inode_validate_extsize(\n\tstruct xfs_mount\t\t*mp,\n\tuint32_t\t\t\textsize,\n\tuint16_t\t\t\tmode,\n\tuint16_t\t\t\tflags)\n{\n\tbool\t\t\t\trt_flag;\n\tbool\t\t\t\thint_flag;\n\tbool\t\t\t\tinherit_flag;\n\tuint32_t\t\t\textsize_bytes;\n\tuint32_t\t\t\tblocksize_bytes;\n\n\trt_flag = (flags & XFS_DIFLAG_REALTIME);\n\thint_flag = (flags & XFS_DIFLAG_EXTSIZE);\n\tinherit_flag = (flags & XFS_DIFLAG_EXTSZINHERIT);\n\textsize_bytes = XFS_FSB_TO_B(mp, extsize);\n\n\t \n\n\tif (rt_flag)\n\t\tblocksize_bytes = XFS_FSB_TO_B(mp, mp->m_sb.sb_rextsize);\n\telse\n\t\tblocksize_bytes = mp->m_sb.sb_blocksize;\n\n\tif ((hint_flag || inherit_flag) && !(S_ISDIR(mode) || S_ISREG(mode)))\n\t\treturn __this_address;\n\n\tif (hint_flag && !S_ISREG(mode))\n\t\treturn __this_address;\n\n\tif (inherit_flag && !S_ISDIR(mode))\n\t\treturn __this_address;\n\n\tif ((hint_flag || inherit_flag) && extsize == 0)\n\t\treturn __this_address;\n\n\t \n\tif (mode && !(hint_flag || inherit_flag) && extsize != 0)\n\t\treturn __this_address;\n\n\tif (extsize_bytes % blocksize_bytes)\n\t\treturn __this_address;\n\n\tif (extsize > XFS_MAX_BMBT_EXTLEN)\n\t\treturn __this_address;\n\n\tif (!rt_flag && extsize > mp->m_sb.sb_agblocks / 2)\n\t\treturn __this_address;\n\n\treturn NULL;\n}\n\n \nxfs_failaddr_t\nxfs_inode_validate_cowextsize(\n\tstruct xfs_mount\t\t*mp,\n\tuint32_t\t\t\tcowextsize,\n\tuint16_t\t\t\tmode,\n\tuint16_t\t\t\tflags,\n\tuint64_t\t\t\tflags2)\n{\n\tbool\t\t\t\trt_flag;\n\tbool\t\t\t\thint_flag;\n\tuint32_t\t\t\tcowextsize_bytes;\n\n\trt_flag = (flags & XFS_DIFLAG_REALTIME);\n\thint_flag = (flags2 & XFS_DIFLAG2_COWEXTSIZE);\n\tcowextsize_bytes = XFS_FSB_TO_B(mp, cowextsize);\n\n\tif (hint_flag && !xfs_has_reflink(mp))\n\t\treturn __this_address;\n\n\tif (hint_flag && !(S_ISDIR(mode) || S_ISREG(mode)))\n\t\treturn __this_address;\n\n\tif (hint_flag && cowextsize == 0)\n\t\treturn __this_address;\n\n\t \n\tif (mode && !hint_flag && cowextsize != 0)\n\t\treturn __this_address;\n\n\tif (hint_flag && rt_flag)\n\t\treturn __this_address;\n\n\tif (cowextsize_bytes % mp->m_sb.sb_blocksize)\n\t\treturn __this_address;\n\n\tif (cowextsize > XFS_MAX_BMBT_EXTLEN)\n\t\treturn __this_address;\n\n\tif (cowextsize > mp->m_sb.sb_agblocks / 2)\n\t\treturn __this_address;\n\n\treturn NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}