{
  "module_name": "xfs_dir2_block.c",
  "hash_id": "0067c2349add829d1693098afd8acf0a076106a8a92c67beb37eee5f9f58a02f",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/libxfs/xfs_dir2_block.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_buf_item.h\"\n#include \"xfs_dir2.h\"\n#include \"xfs_dir2_priv.h\"\n#include \"xfs_error.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_log.h\"\n\n \nstatic void xfs_dir2_block_log_leaf(xfs_trans_t *tp, struct xfs_buf *bp,\n\t\t\t\t    int first, int last);\nstatic void xfs_dir2_block_log_tail(xfs_trans_t *tp, struct xfs_buf *bp);\nstatic int xfs_dir2_block_lookup_int(xfs_da_args_t *args, struct xfs_buf **bpp,\n\t\t\t\t     int *entno);\nstatic int xfs_dir2_block_sort(const void *a, const void *b);\n\nstatic xfs_dahash_t xfs_dir_hash_dot, xfs_dir_hash_dotdot;\n\n \nvoid\nxfs_dir_startup(void)\n{\n\txfs_dir_hash_dot = xfs_da_hashname((unsigned char *)\".\", 1);\n\txfs_dir_hash_dotdot = xfs_da_hashname((unsigned char *)\"..\", 2);\n}\n\nstatic xfs_failaddr_t\nxfs_dir3_block_verify(\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\tstruct xfs_dir3_blk_hdr\t*hdr3 = bp->b_addr;\n\n\tif (!xfs_verify_magic(bp, hdr3->magic))\n\t\treturn __this_address;\n\n\tif (xfs_has_crc(mp)) {\n\t\tif (!uuid_equal(&hdr3->uuid, &mp->m_sb.sb_meta_uuid))\n\t\t\treturn __this_address;\n\t\tif (be64_to_cpu(hdr3->blkno) != xfs_buf_daddr(bp))\n\t\t\treturn __this_address;\n\t\tif (!xfs_log_check_lsn(mp, be64_to_cpu(hdr3->lsn)))\n\t\t\treturn __this_address;\n\t}\n\treturn __xfs_dir3_data_check(NULL, bp);\n}\n\nstatic void\nxfs_dir3_block_read_verify(\n\tstruct xfs_buf\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\txfs_failaddr_t\t\tfa;\n\n\tif (xfs_has_crc(mp) &&\n\t     !xfs_buf_verify_cksum(bp, XFS_DIR3_DATA_CRC_OFF))\n\t\txfs_verifier_error(bp, -EFSBADCRC, __this_address);\n\telse {\n\t\tfa = xfs_dir3_block_verify(bp);\n\t\tif (fa)\n\t\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t}\n}\n\nstatic void\nxfs_dir3_block_write_verify(\n\tstruct xfs_buf\t*bp)\n{\n\tstruct xfs_mount\t*mp = bp->b_mount;\n\tstruct xfs_buf_log_item\t*bip = bp->b_log_item;\n\tstruct xfs_dir3_blk_hdr\t*hdr3 = bp->b_addr;\n\txfs_failaddr_t\t\tfa;\n\n\tfa = xfs_dir3_block_verify(bp);\n\tif (fa) {\n\t\txfs_verifier_error(bp, -EFSCORRUPTED, fa);\n\t\treturn;\n\t}\n\n\tif (!xfs_has_crc(mp))\n\t\treturn;\n\n\tif (bip)\n\t\thdr3->lsn = cpu_to_be64(bip->bli_item.li_lsn);\n\n\txfs_buf_update_cksum(bp, XFS_DIR3_DATA_CRC_OFF);\n}\n\nconst struct xfs_buf_ops xfs_dir3_block_buf_ops = {\n\t.name = \"xfs_dir3_block\",\n\t.magic = { cpu_to_be32(XFS_DIR2_BLOCK_MAGIC),\n\t\t   cpu_to_be32(XFS_DIR3_BLOCK_MAGIC) },\n\t.verify_read = xfs_dir3_block_read_verify,\n\t.verify_write = xfs_dir3_block_write_verify,\n\t.verify_struct = xfs_dir3_block_verify,\n};\n\nstatic xfs_failaddr_t\nxfs_dir3_block_header_check(\n\tstruct xfs_inode\t*dp,\n\tstruct xfs_buf\t\t*bp)\n{\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\n\tif (xfs_has_crc(mp)) {\n\t\tstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\n\n\t\tif (be64_to_cpu(hdr3->owner) != dp->i_ino)\n\t\t\treturn __this_address;\n\t}\n\n\treturn NULL;\n}\n\nint\nxfs_dir3_block_read(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*dp,\n\tstruct xfs_buf\t\t**bpp)\n{\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\txfs_failaddr_t\t\tfa;\n\tint\t\t\terr;\n\n\terr = xfs_da_read_buf(tp, dp, mp->m_dir_geo->datablk, 0, bpp,\n\t\t\t\tXFS_DATA_FORK, &xfs_dir3_block_buf_ops);\n\tif (err || !*bpp)\n\t\treturn err;\n\n\t \n\tfa = xfs_dir3_block_header_check(dp, *bpp);\n\tif (fa) {\n\t\t__xfs_buf_mark_corrupt(*bpp, fa);\n\t\txfs_trans_brelse(tp, *bpp);\n\t\t*bpp = NULL;\n\t\treturn -EFSCORRUPTED;\n\t}\n\n\txfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_BLOCK_BUF);\n\treturn err;\n}\n\nstatic void\nxfs_dir3_block_init(\n\tstruct xfs_mount\t*mp,\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_buf\t\t*bp,\n\tstruct xfs_inode\t*dp)\n{\n\tstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\n\n\tbp->b_ops = &xfs_dir3_block_buf_ops;\n\txfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_BLOCK_BUF);\n\n\tif (xfs_has_crc(mp)) {\n\t\tmemset(hdr3, 0, sizeof(*hdr3));\n\t\thdr3->magic = cpu_to_be32(XFS_DIR3_BLOCK_MAGIC);\n\t\thdr3->blkno = cpu_to_be64(xfs_buf_daddr(bp));\n\t\thdr3->owner = cpu_to_be64(dp->i_ino);\n\t\tuuid_copy(&hdr3->uuid, &mp->m_sb.sb_meta_uuid);\n\t\treturn;\n\n\t}\n\thdr3->magic = cpu_to_be32(XFS_DIR2_BLOCK_MAGIC);\n}\n\nstatic void\nxfs_dir2_block_need_space(\n\tstruct xfs_inode\t\t*dp,\n\tstruct xfs_dir2_data_hdr\t*hdr,\n\tstruct xfs_dir2_block_tail\t*btp,\n\tstruct xfs_dir2_leaf_entry\t*blp,\n\t__be16\t\t\t\t**tagpp,\n\tstruct xfs_dir2_data_unused\t**dupp,\n\tstruct xfs_dir2_data_unused\t**enddupp,\n\tint\t\t\t\t*compact,\n\tint\t\t\t\tlen)\n{\n\tstruct xfs_dir2_data_free\t*bf;\n\t__be16\t\t\t\t*tagp = NULL;\n\tstruct xfs_dir2_data_unused\t*dup = NULL;\n\tstruct xfs_dir2_data_unused\t*enddup = NULL;\n\n\t*compact = 0;\n\tbf = xfs_dir2_data_bestfree_p(dp->i_mount, hdr);\n\n\t \n\tif (btp->stale) {\n\t\tif (be16_to_cpu(bf[0].length) >= len) {\n\t\t\t \n\t\t\tdup = (xfs_dir2_data_unused_t *)\n\t\t\t      ((char *)hdr + be16_to_cpu(bf[0].offset));\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\t*compact = 1;\n\t\ttagp = (__be16 *)blp - 1;\n\n\t\t \n\t\tdup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\n\n\t\t \n\t\tif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t\tif (be16_to_cpu(dup->length) + (be32_to_cpu(btp->stale) - 1) *\n\t\t\t    (uint)sizeof(*blp) < len)\n\t\t\t\tdup = NULL;\n\t\t} else if ((be32_to_cpu(btp->stale) - 1) * (uint)sizeof(*blp) < len)\n\t\t\tdup = NULL;\n\t\telse\n\t\t\tdup = (xfs_dir2_data_unused_t *)blp;\n\t\tgoto out;\n\t}\n\n\t \n\ttagp = (__be16 *)blp - 1;\n\n\t \n\tenddup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\n\n\t \n\tif (be16_to_cpu(enddup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t \n\t\tdup = (xfs_dir2_data_unused_t *)\n\t\t      ((char *)hdr + be16_to_cpu(bf[0].offset));\n\t\tif (dup != enddup) {\n\t\t\t \n\t\t\tif (be16_to_cpu(dup->length) < len)\n\t\t\t\tdup = NULL;\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tif (be16_to_cpu(dup->length) < len + (uint)sizeof(*blp)) {\n\t\t\t \n\t\t\tif (be16_to_cpu(bf[1].length) >= len)\n\t\t\t\tdup = (xfs_dir2_data_unused_t *)\n\t\t\t\t      ((char *)hdr + be16_to_cpu(bf[1].offset));\n\t\t\telse\n\t\t\t\tdup = NULL;\n\t\t}\n\t}\nout:\n\t*tagpp = tagp;\n\t*dupp = dup;\n\t*enddupp = enddup;\n}\n\n \nstatic void\nxfs_dir2_block_compact(\n\tstruct xfs_da_args\t\t*args,\n\tstruct xfs_buf\t\t\t*bp,\n\tstruct xfs_dir2_data_hdr\t*hdr,\n\tstruct xfs_dir2_block_tail\t*btp,\n\tstruct xfs_dir2_leaf_entry\t*blp,\n\tint\t\t\t\t*needlog,\n\tint\t\t\t\t*lfloghigh,\n\tint\t\t\t\t*lfloglow)\n{\n\tint\t\t\tfromidx;\t \n\tint\t\t\ttoidx;\t\t \n\tint\t\t\tneedscan = 0;\n\tint\t\t\thighstale;\t \n\n\tfromidx = toidx = be32_to_cpu(btp->count) - 1;\n\thighstale = *lfloghigh = -1;\n\tfor (; fromidx >= 0; fromidx--) {\n\t\tif (blp[fromidx].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR)) {\n\t\t\tif (highstale == -1)\n\t\t\t\thighstale = toidx;\n\t\t\telse {\n\t\t\t\tif (*lfloghigh == -1)\n\t\t\t\t\t*lfloghigh = toidx;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\tif (fromidx < toidx)\n\t\t\tblp[toidx] = blp[fromidx];\n\t\ttoidx--;\n\t}\n\t*lfloglow = toidx + 1 - (be32_to_cpu(btp->stale) - 1);\n\t*lfloghigh -= be32_to_cpu(btp->stale) - 1;\n\tbe32_add_cpu(&btp->count, -(be32_to_cpu(btp->stale) - 1));\n\txfs_dir2_data_make_free(args, bp,\n\t\t(xfs_dir2_data_aoff_t)((char *)blp - (char *)hdr),\n\t\t(xfs_dir2_data_aoff_t)((be32_to_cpu(btp->stale) - 1) * sizeof(*blp)),\n\t\tneedlog, &needscan);\n\tbtp->stale = cpu_to_be32(1);\n\t \n\tif (needscan)\n\t\txfs_dir2_data_freescan(args->dp->i_mount, hdr, needlog);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_addname(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\tint\t\t\tcompact;\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\txfs_dir2_data_unused_t\t*dup;\t\t \n\tint\t\t\terror;\t\t \n\txfs_dir2_data_unused_t\t*enddup=NULL;\t \n\txfs_dahash_t\t\thash;\t\t \n\tint\t\t\thigh;\t\t \n\tint\t\t\thighstale;\t \n\tint\t\t\tlfloghigh=0;\t \n\tint\t\t\tlfloglow=0;\t \n\tint\t\t\tlen;\t\t \n\tint\t\t\tlow;\t\t \n\tint\t\t\tlowstale;\t \n\tint\t\t\tmid=0;\t\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\t__be16\t\t\t*tagp;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\n\ttrace_xfs_dir2_block_addname(args);\n\n\tdp = args->dp;\n\ttp = args->trans;\n\n\t \n\terror = xfs_dir3_block_read(tp, dp, &bp);\n\tif (error)\n\t\treturn error;\n\n\tlen = xfs_dir2_data_entsize(dp->i_mount, args->namelen);\n\n\t \n\thdr = bp->b_addr;\n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\n\t \n\txfs_dir2_block_need_space(dp, hdr, btp, blp, &tagp, &dup,\n\t\t\t\t  &enddup, &compact, len);\n\n\t \n\tif (args->op_flags & XFS_DA_OP_JUSTCHECK) {\n\t\txfs_trans_brelse(tp, bp);\n\t\tif (!dup)\n\t\t\treturn -ENOSPC;\n\t\treturn 0;\n\t}\n\n\t \n\tif (!dup) {\n\t\t \n\t\tif (args->total == 0)\n\t\t\treturn -ENOSPC;\n\t\t \n\t\terror = xfs_dir2_block_to_leaf(args, bp);\n\t\tif (error)\n\t\t\treturn error;\n\t\treturn xfs_dir2_leaf_addname(args);\n\t}\n\n\tneedlog = needscan = 0;\n\n\t \n\tif (compact) {\n\t\txfs_dir2_block_compact(args, bp, hdr, btp, blp, &needlog,\n\t\t\t\t      &lfloghigh, &lfloglow);\n\t\t \n\t\tblp = xfs_dir2_block_leaf_p(btp);\n\t} else if (btp->stale) {\n\t\t \n\t\tlfloglow = be32_to_cpu(btp->count);\n\t\tlfloghigh = -1;\n\t}\n\n\t \n\tfor (low = 0, high = be32_to_cpu(btp->count) - 1; low <= high; ) {\n\t\tmid = (low + high) >> 1;\n\t\tif ((hash = be32_to_cpu(blp[mid].hashval)) == args->hashval)\n\t\t\tbreak;\n\t\tif (hash < args->hashval)\n\t\t\tlow = mid + 1;\n\t\telse\n\t\t\thigh = mid - 1;\n\t}\n\twhile (mid >= 0 && be32_to_cpu(blp[mid].hashval) >= args->hashval) {\n\t\tmid--;\n\t}\n\t \n\tif (!btp->stale) {\n\t\txfs_dir2_data_aoff_t\taoff;\n\n\t\t \n\t\taoff = (xfs_dir2_data_aoff_t)((char *)enddup - (char *)hdr +\n\t\t\t\tbe16_to_cpu(enddup->length) - sizeof(*blp));\n\t\terror = xfs_dir2_data_use_free(args, bp, enddup, aoff,\n\t\t\t\t(xfs_dir2_data_aoff_t)sizeof(*blp), &needlog,\n\t\t\t\t&needscan);\n\t\tif (error)\n\t\t\treturn error;\n\n\t\t \n\t\tbe32_add_cpu(&btp->count, 1);\n\t\t \n\t\tif (needscan) {\n\t\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\t\t\tneedscan = 0;\n\t\t}\n\t\t \n\t\tblp--;\n\t\tmid++;\n\t\tif (mid)\n\t\t\tmemmove(blp, &blp[1], mid * sizeof(*blp));\n\t\tlfloglow = 0;\n\t\tlfloghigh = mid;\n\t}\n\t \n\telse {\n\t\tfor (lowstale = mid;\n\t\t     lowstale >= 0 &&\n\t\t\tblp[lowstale].address !=\n\t\t\tcpu_to_be32(XFS_DIR2_NULL_DATAPTR);\n\t\t     lowstale--)\n\t\t\tcontinue;\n\t\tfor (highstale = mid + 1;\n\t\t     highstale < be32_to_cpu(btp->count) &&\n\t\t\tblp[highstale].address !=\n\t\t\tcpu_to_be32(XFS_DIR2_NULL_DATAPTR) &&\n\t\t\t(lowstale < 0 || mid - lowstale > highstale - mid);\n\t\t     highstale++)\n\t\t\tcontinue;\n\t\t \n\t\tif (lowstale >= 0 &&\n\t\t    (highstale == be32_to_cpu(btp->count) ||\n\t\t     mid - lowstale <= highstale - mid)) {\n\t\t\tif (mid - lowstale)\n\t\t\t\tmemmove(&blp[lowstale], &blp[lowstale + 1],\n\t\t\t\t\t(mid - lowstale) * sizeof(*blp));\n\t\t\tlfloglow = min(lowstale, lfloglow);\n\t\t\tlfloghigh = max(mid, lfloghigh);\n\t\t}\n\t\t \n\t\telse {\n\t\t\tASSERT(highstale < be32_to_cpu(btp->count));\n\t\t\tmid++;\n\t\t\tif (highstale - mid)\n\t\t\t\tmemmove(&blp[mid + 1], &blp[mid],\n\t\t\t\t\t(highstale - mid) * sizeof(*blp));\n\t\t\tlfloglow = min(mid, lfloglow);\n\t\t\tlfloghigh = max(highstale, lfloghigh);\n\t\t}\n\t\tbe32_add_cpu(&btp->stale, -1);\n\t}\n\t \n\tdep = (xfs_dir2_data_entry_t *)dup;\n\t \n\tblp[mid].hashval = cpu_to_be32(args->hashval);\n\tblp[mid].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(\n\t\t\t\t(char *)dep - (char *)hdr));\n\txfs_dir2_block_log_leaf(tp, bp, lfloglow, lfloghigh);\n\t \n\terror = xfs_dir2_data_use_free(args, bp, dup,\n\t\t\t(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr),\n\t\t\t(xfs_dir2_data_aoff_t)len, &needlog, &needscan);\n\tif (error)\n\t\treturn error;\n\t \n\tdep->inumber = cpu_to_be64(args->inumber);\n\tdep->namelen = args->namelen;\n\tmemcpy(dep->name, args->name, args->namelen);\n\txfs_dir2_data_put_ftype(dp->i_mount, dep, args->filetype);\n\ttagp = xfs_dir2_data_entry_tag_p(dp->i_mount, dep);\n\t*tagp = cpu_to_be16((char *)dep - (char *)hdr);\n\t \n\tif (needscan)\n\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\tif (needlog)\n\t\txfs_dir2_data_log_header(args, bp);\n\txfs_dir2_block_log_tail(tp, bp);\n\txfs_dir2_data_log_entry(args, bp, dep);\n\txfs_dir3_data_check(dp, bp);\n\treturn 0;\n}\n\n \nstatic void\nxfs_dir2_block_log_leaf(\n\txfs_trans_t\t\t*tp,\t\t \n\tstruct xfs_buf\t\t*bp,\t\t \n\tint\t\t\tfirst,\t\t \n\tint\t\t\tlast)\t\t \n{\n\txfs_dir2_data_hdr_t\t*hdr = bp->b_addr;\n\txfs_dir2_leaf_entry_t\t*blp;\n\txfs_dir2_block_tail_t\t*btp;\n\n\tbtp = xfs_dir2_block_tail_p(tp->t_mountp->m_dir_geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\txfs_trans_log_buf(tp, bp, (uint)((char *)&blp[first] - (char *)hdr),\n\t\t(uint)((char *)&blp[last + 1] - (char *)hdr - 1));\n}\n\n \nstatic void\nxfs_dir2_block_log_tail(\n\txfs_trans_t\t\t*tp,\t\t \n\tstruct xfs_buf\t\t*bp)\t\t \n{\n\txfs_dir2_data_hdr_t\t*hdr = bp->b_addr;\n\txfs_dir2_block_tail_t\t*btp;\n\n\tbtp = xfs_dir2_block_tail_p(tp->t_mountp->m_dir_geo, hdr);\n\txfs_trans_log_buf(tp, bp, (uint)((char *)btp - (char *)hdr),\n\t\t(uint)((char *)(btp + 1) - (char *)hdr - 1));\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_lookup(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\tent;\t\t \n\tint\t\t\terror;\t\t \n\n\ttrace_xfs_dir2_block_lookup(args);\n\n\t \n\tif ((error = xfs_dir2_block_lookup_int(args, &bp, &ent)))\n\t\treturn error;\n\tdp = args->dp;\n\thdr = bp->b_addr;\n\txfs_dir3_data_check(dp, bp);\n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\t \n\tdep = (xfs_dir2_data_entry_t *)((char *)hdr +\n\t\t\txfs_dir2_dataptr_to_off(args->geo,\n\t\t\t\t\t\tbe32_to_cpu(blp[ent].address)));\n\t \n\targs->inumber = be64_to_cpu(dep->inumber);\n\targs->filetype = xfs_dir2_data_get_ftype(dp->i_mount, dep);\n\terror = xfs_dir_cilookup_result(args, dep->name, dep->namelen);\n\txfs_trans_brelse(args->trans, bp);\n\treturn error;\n}\n\n \nstatic int\t\t\t\t\t \nxfs_dir2_block_lookup_int(\n\txfs_da_args_t\t\t*args,\t\t \n\tstruct xfs_buf\t\t**bpp,\t\t \n\tint\t\t\t*entno)\t\t \n{\n\txfs_dir2_dataptr_t\taddr;\t\t \n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\terror;\t\t \n\txfs_dahash_t\t\thash;\t\t \n\tint\t\t\thigh;\t\t \n\tint\t\t\tlow;\t\t \n\tint\t\t\tmid;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\tenum xfs_dacmp\t\tcmp;\t\t \n\n\tdp = args->dp;\n\ttp = args->trans;\n\n\terror = xfs_dir3_block_read(tp, dp, &bp);\n\tif (error)\n\t\treturn error;\n\n\thdr = bp->b_addr;\n\txfs_dir3_data_check(dp, bp);\n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\t \n\tfor (low = 0, high = be32_to_cpu(btp->count) - 1; ; ) {\n\t\tASSERT(low <= high);\n\t\tmid = (low + high) >> 1;\n\t\tif ((hash = be32_to_cpu(blp[mid].hashval)) == args->hashval)\n\t\t\tbreak;\n\t\tif (hash < args->hashval)\n\t\t\tlow = mid + 1;\n\t\telse\n\t\t\thigh = mid - 1;\n\t\tif (low > high) {\n\t\t\tASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\n\t\t\txfs_trans_brelse(tp, bp);\n\t\t\treturn -ENOENT;\n\t\t}\n\t}\n\t \n\twhile (mid > 0 && be32_to_cpu(blp[mid - 1].hashval) == args->hashval) {\n\t\tmid--;\n\t}\n\t \n\tdo {\n\t\tif ((addr = be32_to_cpu(blp[mid].address)) == XFS_DIR2_NULL_DATAPTR)\n\t\t\tcontinue;\n\t\t \n\t\tdep = (xfs_dir2_data_entry_t *)\n\t\t\t((char *)hdr + xfs_dir2_dataptr_to_off(args->geo, addr));\n\t\t \n\t\tcmp = xfs_dir2_compname(args, dep->name, dep->namelen);\n\t\tif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\n\t\t\targs->cmpresult = cmp;\n\t\t\t*bpp = bp;\n\t\t\t*entno = mid;\n\t\t\tif (cmp == XFS_CMP_EXACT)\n\t\t\t\treturn 0;\n\t\t}\n\t} while (++mid < be32_to_cpu(btp->count) &&\n\t\t\tbe32_to_cpu(blp[mid].hashval) == hash);\n\n\tASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\n\t \n\tif (args->cmpresult == XFS_CMP_CASE)\n\t\treturn 0;\n\t \n\txfs_trans_brelse(tp, bp);\n\treturn -ENOENT;\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_removename(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\tent;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\txfs_dir2_sf_hdr_t\tsfh;\t\t \n\tint\t\t\tsize;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\n\ttrace_xfs_dir2_block_removename(args);\n\n\t \n\tif ((error = xfs_dir2_block_lookup_int(args, &bp, &ent))) {\n\t\treturn error;\n\t}\n\tdp = args->dp;\n\ttp = args->trans;\n\thdr = bp->b_addr;\n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\t \n\tdep = (xfs_dir2_data_entry_t *)((char *)hdr +\n\t\t\txfs_dir2_dataptr_to_off(args->geo,\n\t\t\t\t\t\tbe32_to_cpu(blp[ent].address)));\n\t \n\tneedlog = needscan = 0;\n\txfs_dir2_data_make_free(args, bp,\n\t\t(xfs_dir2_data_aoff_t)((char *)dep - (char *)hdr),\n\t\txfs_dir2_data_entsize(dp->i_mount, dep->namelen), &needlog,\n\t\t&needscan);\n\t \n\tbe32_add_cpu(&btp->stale, 1);\n\txfs_dir2_block_log_tail(tp, bp);\n\t \n\tblp[ent].address = cpu_to_be32(XFS_DIR2_NULL_DATAPTR);\n\txfs_dir2_block_log_leaf(tp, bp, ent, ent);\n\t \n\tif (needscan)\n\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\tif (needlog)\n\t\txfs_dir2_data_log_header(args, bp);\n\txfs_dir3_data_check(dp, bp);\n\t \n\tsize = xfs_dir2_block_sfsize(dp, hdr, &sfh);\n\tif (size > xfs_inode_data_fork_size(dp))\n\t\treturn 0;\n\n\t \n\treturn xfs_dir2_block_to_sf(args, bp, size, &sfh);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_block_replace(\n\txfs_da_args_t\t\t*args)\t\t \n{\n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\tint\t\t\tent;\t\t \n\tint\t\t\terror;\t\t \n\n\ttrace_xfs_dir2_block_replace(args);\n\n\t \n\tif ((error = xfs_dir2_block_lookup_int(args, &bp, &ent))) {\n\t\treturn error;\n\t}\n\tdp = args->dp;\n\thdr = bp->b_addr;\n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tblp = xfs_dir2_block_leaf_p(btp);\n\t \n\tdep = (xfs_dir2_data_entry_t *)((char *)hdr +\n\t\t\txfs_dir2_dataptr_to_off(args->geo,\n\t\t\t\t\t\tbe32_to_cpu(blp[ent].address)));\n\tASSERT(be64_to_cpu(dep->inumber) != args->inumber);\n\t \n\tdep->inumber = cpu_to_be64(args->inumber);\n\txfs_dir2_data_put_ftype(dp->i_mount, dep, args->filetype);\n\txfs_dir2_data_log_entry(args, bp, dep);\n\txfs_dir3_data_check(dp, bp);\n\treturn 0;\n}\n\n \nstatic int\t\t\t\t\t \nxfs_dir2_block_sort(\n\tconst void\t\t\t*a,\t \n\tconst void\t\t\t*b)\t \n{\n\tconst xfs_dir2_leaf_entry_t\t*la;\t \n\tconst xfs_dir2_leaf_entry_t\t*lb;\t \n\n\tla = a;\n\tlb = b;\n\treturn be32_to_cpu(la->hashval) < be32_to_cpu(lb->hashval) ? -1 :\n\t\t(be32_to_cpu(la->hashval) > be32_to_cpu(lb->hashval) ? 1 : 0);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_leaf_to_block(\n\txfs_da_args_t\t\t*args,\t\t \n\tstruct xfs_buf\t\t*lbp,\t\t \n\tstruct xfs_buf\t\t*dbp)\t\t \n{\n\t__be16\t\t\t*bestsp;\t \n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_inode_t\t\t*dp;\t\t \n\txfs_dir2_data_unused_t\t*dup;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\tfrom;\t\t \n\txfs_dir2_leaf_t\t\t*leaf;\t\t \n\txfs_dir2_leaf_entry_t\t*lep;\t\t \n\txfs_dir2_leaf_tail_t\t*ltp;\t\t \n\txfs_mount_t\t\t*mp;\t\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\txfs_dir2_sf_hdr_t\tsfh;\t\t \n\tint\t\t\tsize;\t\t \n\t__be16\t\t\t*tagp;\t\t \n\tint\t\t\tto;\t\t \n\txfs_trans_t\t\t*tp;\t\t \n\tstruct xfs_dir3_icleaf_hdr leafhdr;\n\n\ttrace_xfs_dir2_leaf_to_block(args);\n\n\tdp = args->dp;\n\ttp = args->trans;\n\tmp = dp->i_mount;\n\tleaf = lbp->b_addr;\n\txfs_dir2_leaf_hdr_from_disk(mp, &leafhdr, leaf);\n\tltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\n\n\tASSERT(leafhdr.magic == XFS_DIR2_LEAF1_MAGIC ||\n\t       leafhdr.magic == XFS_DIR3_LEAF1_MAGIC);\n\t \n\twhile (dp->i_disk_size > args->geo->blksize) {\n\t\tint hdrsz;\n\n\t\thdrsz = args->geo->data_entry_offset;\n\t\tbestsp = xfs_dir2_leaf_bests_p(ltp);\n\t\tif (be16_to_cpu(bestsp[be32_to_cpu(ltp->bestcount) - 1]) ==\n\t\t\t\t\t    args->geo->blksize - hdrsz) {\n\t\t\tif ((error =\n\t\t\t    xfs_dir2_leaf_trim_data(args, lbp,\n\t\t\t\t    (xfs_dir2_db_t)(be32_to_cpu(ltp->bestcount) - 1))))\n\t\t\t\treturn error;\n\t\t} else\n\t\t\treturn 0;\n\t}\n\t \n\tif (!dbp) {\n\t\terror = xfs_dir3_data_read(tp, dp, args->geo->datablk, 0, &dbp);\n\t\tif (error)\n\t\t\treturn error;\n\t}\n\thdr = dbp->b_addr;\n\tASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\n\t       hdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC));\n\n\t \n\tsize = (uint)sizeof(xfs_dir2_block_tail_t) +\n\t       (uint)sizeof(*lep) * (leafhdr.count - leafhdr.stale);\n\t \n\ttagp = (__be16 *)((char *)hdr + args->geo->blksize) - 1;\n\tdup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\n\t \n\tif (be16_to_cpu(dup->freetag) != XFS_DIR2_DATA_FREE_TAG ||\n\t    be16_to_cpu(dup->length) < size)\n\t\treturn 0;\n\n\t \n\txfs_dir3_block_init(mp, tp, dbp, dp);\n\n\tneedlog = 1;\n\tneedscan = 0;\n\t \n\terror = xfs_dir2_data_use_free(args, dbp, dup,\n\t\t\targs->geo->blksize - size, size, &needlog, &needscan);\n\tif (error)\n\t\treturn error;\n\t \n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tbtp->count = cpu_to_be32(leafhdr.count - leafhdr.stale);\n\tbtp->stale = 0;\n\txfs_dir2_block_log_tail(tp, dbp);\n\t \n\tlep = xfs_dir2_block_leaf_p(btp);\n\tfor (from = to = 0; from < leafhdr.count; from++) {\n\t\tif (leafhdr.ents[from].address ==\n\t\t    cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\n\t\t\tcontinue;\n\t\tlep[to++] = leafhdr.ents[from];\n\t}\n\tASSERT(to == be32_to_cpu(btp->count));\n\txfs_dir2_block_log_leaf(tp, dbp, 0, be32_to_cpu(btp->count) - 1);\n\t \n\tif (needscan)\n\t\txfs_dir2_data_freescan(dp->i_mount, hdr, &needlog);\n\tif (needlog)\n\t\txfs_dir2_data_log_header(args, dbp);\n\t \n\terror = xfs_da_shrink_inode(args, args->geo->leafblk, lbp);\n\tif (error)\n\t\treturn error;\n\n\t \n\tsize = xfs_dir2_block_sfsize(dp, hdr, &sfh);\n\tif (size > xfs_inode_data_fork_size(dp))\n\t\treturn 0;\n\n\treturn xfs_dir2_block_to_sf(args, dbp, size, &sfh);\n}\n\n \nint\t\t\t\t\t\t \nxfs_dir2_sf_to_block(\n\tstruct xfs_da_args\t*args)\n{\n\tstruct xfs_trans\t*tp = args->trans;\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tstruct xfs_ifork\t*ifp = xfs_ifork_ptr(dp, XFS_DATA_FORK);\n\tstruct xfs_da_geometry\t*geo = args->geo;\n\txfs_dir2_db_t\t\tblkno;\t\t \n\txfs_dir2_data_hdr_t\t*hdr;\t\t \n\txfs_dir2_leaf_entry_t\t*blp;\t\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\txfs_dir2_block_tail_t\t*btp;\t\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\tint\t\t\tdummy;\t\t \n\txfs_dir2_data_unused_t\t*dup;\t\t \n\tint\t\t\tendoffset;\t \n\tint\t\t\terror;\t\t \n\tint\t\t\ti;\t\t \n\tint\t\t\tneedlog;\t \n\tint\t\t\tneedscan;\t \n\tint\t\t\tnewoffset;\t \n\tunsigned int\t\toffset = geo->data_entry_offset;\n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*oldsfp;\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\t__be16\t\t\t*tagp;\t\t \n\tstruct xfs_name\t\tname;\n\n\ttrace_xfs_dir2_sf_to_block(args);\n\n\tASSERT(ifp->if_format == XFS_DINODE_FMT_LOCAL);\n\tASSERT(dp->i_disk_size >= offsetof(struct xfs_dir2_sf_hdr, parent));\n\n\toldsfp = (xfs_dir2_sf_hdr_t *)ifp->if_u1.if_data;\n\n\tASSERT(ifp->if_bytes == dp->i_disk_size);\n\tASSERT(ifp->if_u1.if_data != NULL);\n\tASSERT(dp->i_disk_size >= xfs_dir2_sf_hdr_size(oldsfp->i8count));\n\tASSERT(dp->i_df.if_nextents == 0);\n\n\t \n\tsfp = kmem_alloc(ifp->if_bytes, 0);\n\tmemcpy(sfp, oldsfp, ifp->if_bytes);\n\n\txfs_idata_realloc(dp, -ifp->if_bytes, XFS_DATA_FORK);\n\txfs_bmap_local_to_extents_empty(tp, dp, XFS_DATA_FORK);\n\tdp->i_disk_size = 0;\n\n\t \n\terror = xfs_dir2_grow_inode(args, XFS_DIR2_DATA_SPACE, &blkno);\n\tif (error)\n\t\tgoto out_free;\n\t \n\terror = xfs_dir3_data_init(args, blkno, &bp);\n\tif (error)\n\t\tgoto out_free;\n\txfs_dir3_block_init(mp, tp, bp, dp);\n\thdr = bp->b_addr;\n\n\t \n\ti = (uint)sizeof(*btp) +\n\t    (sfp->count + 2) * (uint)sizeof(xfs_dir2_leaf_entry_t);\n\t \n\tdup = bp->b_addr + offset;\n\tneedlog = needscan = 0;\n\terror = xfs_dir2_data_use_free(args, bp, dup, args->geo->blksize - i,\n\t\t\ti, &needlog, &needscan);\n\tif (error)\n\t\tgoto out_free;\n\tASSERT(needscan == 0);\n\t \n\tbtp = xfs_dir2_block_tail_p(args->geo, hdr);\n\tbtp->count = cpu_to_be32(sfp->count + 2);\t \n\tbtp->stale = 0;\n\tblp = xfs_dir2_block_leaf_p(btp);\n\tendoffset = (uint)((char *)blp - (char *)hdr);\n\t \n\terror = xfs_dir2_data_use_free(args, bp, dup,\n\t\t\t(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr),\n\t\t\tbe16_to_cpu(dup->length), &needlog, &needscan);\n\tif (error)\n\t\tgoto out_free;\n\n\t \n\tdep = bp->b_addr + offset;\n\tdep->inumber = cpu_to_be64(dp->i_ino);\n\tdep->namelen = 1;\n\tdep->name[0] = '.';\n\txfs_dir2_data_put_ftype(mp, dep, XFS_DIR3_FT_DIR);\n\ttagp = xfs_dir2_data_entry_tag_p(mp, dep);\n\t*tagp = cpu_to_be16(offset);\n\txfs_dir2_data_log_entry(args, bp, dep);\n\tblp[0].hashval = cpu_to_be32(xfs_dir_hash_dot);\n\tblp[0].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(offset));\n\toffset += xfs_dir2_data_entsize(mp, dep->namelen);\n\n\t \n\tdep = bp->b_addr + offset;\n\tdep->inumber = cpu_to_be64(xfs_dir2_sf_get_parent_ino(sfp));\n\tdep->namelen = 2;\n\tdep->name[0] = dep->name[1] = '.';\n\txfs_dir2_data_put_ftype(mp, dep, XFS_DIR3_FT_DIR);\n\ttagp = xfs_dir2_data_entry_tag_p(mp, dep);\n\t*tagp = cpu_to_be16(offset);\n\txfs_dir2_data_log_entry(args, bp, dep);\n\tblp[1].hashval = cpu_to_be32(xfs_dir_hash_dotdot);\n\tblp[1].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(offset));\n\toffset += xfs_dir2_data_entsize(mp, dep->namelen);\n\n\t \n\ti = 0;\n\tif (!sfp->count)\n\t\tsfep = NULL;\n\telse\n\t\tsfep = xfs_dir2_sf_firstentry(sfp);\n\n\t \n\twhile (offset < endoffset) {\n\t\t \n\t\tif (sfep == NULL)\n\t\t\tnewoffset = endoffset;\n\t\telse\n\t\t\tnewoffset = xfs_dir2_sf_get_offset(sfep);\n\t\t \n\t\tif (offset < newoffset) {\n\t\t\tdup = bp->b_addr + offset;\n\t\t\tdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\n\t\t\tdup->length = cpu_to_be16(newoffset - offset);\n\t\t\t*xfs_dir2_data_unused_tag_p(dup) = cpu_to_be16(offset);\n\t\t\txfs_dir2_data_log_unused(args, bp, dup);\n\t\t\txfs_dir2_data_freeinsert(hdr,\n\t\t\t\t\txfs_dir2_data_bestfree_p(mp, hdr),\n\t\t\t\t\tdup, &dummy);\n\t\t\toffset += be16_to_cpu(dup->length);\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tdep = bp->b_addr + newoffset;\n\t\tdep->inumber = cpu_to_be64(xfs_dir2_sf_get_ino(mp, sfp, sfep));\n\t\tdep->namelen = sfep->namelen;\n\t\txfs_dir2_data_put_ftype(mp, dep,\n\t\t\t\txfs_dir2_sf_get_ftype(mp, sfep));\n\t\tmemcpy(dep->name, sfep->name, dep->namelen);\n\t\ttagp = xfs_dir2_data_entry_tag_p(mp, dep);\n\t\t*tagp = cpu_to_be16(newoffset);\n\t\txfs_dir2_data_log_entry(args, bp, dep);\n\t\tname.name = sfep->name;\n\t\tname.len = sfep->namelen;\n\t\tblp[2 + i].hashval = cpu_to_be32(xfs_dir2_hashname(mp, &name));\n\t\tblp[2 + i].address =\n\t\t\tcpu_to_be32(xfs_dir2_byte_to_dataptr(newoffset));\n\t\toffset = (int)((char *)(tagp + 1) - (char *)hdr);\n\t\tif (++i == sfp->count)\n\t\t\tsfep = NULL;\n\t\telse\n\t\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t}\n\t \n\tkmem_free(sfp);\n\t \n\txfs_sort(blp, be32_to_cpu(btp->count), sizeof(*blp), xfs_dir2_block_sort);\n\t \n\tASSERT(needscan == 0);\n\txfs_dir2_block_log_leaf(tp, bp, 0, be32_to_cpu(btp->count) - 1);\n\txfs_dir2_block_log_tail(tp, bp);\n\txfs_dir3_data_check(dp, bp);\n\treturn 0;\nout_free:\n\tkmem_free(sfp);\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}