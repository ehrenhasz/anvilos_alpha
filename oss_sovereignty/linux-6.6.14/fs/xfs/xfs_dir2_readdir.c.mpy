{
  "module_name": "xfs_dir2_readdir.c",
  "hash_id": "f5950a7401794009f60f0bf2a2940e7a26d9cd4f5715e7c0d6067d98e2393a49",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_dir2_readdir.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_dir2.h\"\n#include \"xfs_dir2_priv.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_error.h\"\n\n \nstatic unsigned char xfs_dir3_filetype_table[] = {\n\tDT_UNKNOWN, DT_REG, DT_DIR, DT_CHR, DT_BLK,\n\tDT_FIFO, DT_SOCK, DT_LNK, DT_WHT,\n};\n\nunsigned char\nxfs_dir3_get_dtype(\n\tstruct xfs_mount\t*mp,\n\tuint8_t\t\t\tfiletype)\n{\n\tif (!xfs_has_ftype(mp))\n\t\treturn DT_UNKNOWN;\n\n\tif (filetype >= XFS_DIR3_FT_MAX)\n\t\treturn DT_UNKNOWN;\n\n\treturn xfs_dir3_filetype_table[filetype];\n}\n\nSTATIC int\nxfs_dir2_sf_getdents(\n\tstruct xfs_da_args\t*args,\n\tstruct dir_context\t*ctx)\n{\n\tint\t\t\ti;\t\t \n\tstruct xfs_inode\t*dp = args->dp;\t \n\tstruct xfs_mount\t*mp = dp->i_mount;\n\txfs_dir2_dataptr_t\toff;\t\t \n\txfs_dir2_sf_entry_t\t*sfep;\t\t \n\txfs_dir2_sf_hdr_t\t*sfp;\t\t \n\txfs_dir2_dataptr_t\tdot_offset;\n\txfs_dir2_dataptr_t\tdotdot_offset;\n\txfs_ino_t\t\tino;\n\tstruct xfs_da_geometry\t*geo = args->geo;\n\n\tASSERT(dp->i_df.if_format == XFS_DINODE_FMT_LOCAL);\n\tASSERT(dp->i_df.if_bytes == dp->i_disk_size);\n\tASSERT(dp->i_df.if_u1.if_data != NULL);\n\n\tsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\n\n\t \n\tif (xfs_dir2_dataptr_to_db(geo, ctx->pos) > geo->datablk)\n\t\treturn 0;\n\n\t \n\tdot_offset = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\n\t\t\tgeo->data_entry_offset);\n\tdotdot_offset = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\n\t\t\tgeo->data_entry_offset +\n\t\t\txfs_dir2_data_entsize(mp, sizeof(\".\") - 1));\n\n\t \n\tif (ctx->pos <= dot_offset) {\n\t\tctx->pos = dot_offset & 0x7fffffff;\n\t\tif (!dir_emit(ctx, \".\", 1, dp->i_ino, DT_DIR))\n\t\t\treturn 0;\n\t}\n\n\t \n\tif (ctx->pos <= dotdot_offset) {\n\t\tino = xfs_dir2_sf_get_parent_ino(sfp);\n\t\tctx->pos = dotdot_offset & 0x7fffffff;\n\t\tif (!dir_emit(ctx, \"..\", 2, ino, DT_DIR))\n\t\t\treturn 0;\n\t}\n\n\t \n\tsfep = xfs_dir2_sf_firstentry(sfp);\n\tfor (i = 0; i < sfp->count; i++) {\n\t\tuint8_t filetype;\n\n\t\toff = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\n\t\t\t\txfs_dir2_sf_get_offset(sfep));\n\n\t\tif (ctx->pos > off) {\n\t\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t\t\tcontinue;\n\t\t}\n\n\t\tino = xfs_dir2_sf_get_ino(mp, sfp, sfep);\n\t\tfiletype = xfs_dir2_sf_get_ftype(mp, sfep);\n\t\tctx->pos = off & 0x7fffffff;\n\t\tif (XFS_IS_CORRUPT(dp->i_mount,\n\t\t\t\t   !xfs_dir2_namecheck(sfep->name,\n\t\t\t\t\t\t       sfep->namelen)))\n\t\t\treturn -EFSCORRUPTED;\n\t\tif (!dir_emit(ctx, (char *)sfep->name, sfep->namelen, ino,\n\t\t\t    xfs_dir3_get_dtype(mp, filetype)))\n\t\t\treturn 0;\n\t\tsfep = xfs_dir2_sf_nextentry(mp, sfp, sfep);\n\t}\n\n\tctx->pos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk + 1, 0) &\n\t\t\t\t\t\t\t\t0x7fffffff;\n\treturn 0;\n}\n\n \nSTATIC int\nxfs_dir2_block_getdents(\n\tstruct xfs_da_args\t*args,\n\tstruct dir_context\t*ctx,\n\tunsigned int\t\t*lock_mode)\n{\n\tstruct xfs_inode\t*dp = args->dp;\t \n\tstruct xfs_buf\t\t*bp;\t\t \n\tint\t\t\terror;\t\t \n\tint\t\t\twantoff;\t \n\txfs_off_t\t\tcook;\n\tstruct xfs_da_geometry\t*geo = args->geo;\n\tunsigned int\t\toffset, next_offset;\n\tunsigned int\t\tend;\n\n\t \n\tif (xfs_dir2_dataptr_to_db(geo, ctx->pos) > geo->datablk)\n\t\treturn 0;\n\n\terror = xfs_dir3_block_read(args->trans, dp, &bp);\n\tif (error)\n\t\treturn error;\n\n\txfs_iunlock(dp, *lock_mode);\n\t*lock_mode = 0;\n\n\t \n\twantoff = xfs_dir2_dataptr_to_off(geo, ctx->pos);\n\txfs_dir3_data_check(dp, bp);\n\n\t \n\tend = xfs_dir3_data_end_offset(geo, bp->b_addr);\n\tfor (offset = geo->data_entry_offset;\n\t     offset < end;\n\t     offset = next_offset) {\n\t\tstruct xfs_dir2_data_unused\t*dup = bp->b_addr + offset;\n\t\tstruct xfs_dir2_data_entry\t*dep = bp->b_addr + offset;\n\t\tuint8_t filetype;\n\n\t\t \n\t\tif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t\tnext_offset = offset + be16_to_cpu(dup->length);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tnext_offset = offset +\n\t\t\txfs_dir2_data_entsize(dp->i_mount, dep->namelen);\n\n\t\t \n\t\tif (offset < wantoff)\n\t\t\tcontinue;\n\n\t\tcook = xfs_dir2_db_off_to_dataptr(geo, geo->datablk, offset);\n\n\t\tctx->pos = cook & 0x7fffffff;\n\t\tfiletype = xfs_dir2_data_get_ftype(dp->i_mount, dep);\n\t\t \n\t\tif (XFS_IS_CORRUPT(dp->i_mount,\n\t\t\t\t   !xfs_dir2_namecheck(dep->name,\n\t\t\t\t\t\t       dep->namelen))) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tgoto out_rele;\n\t\t}\n\t\tif (!dir_emit(ctx, (char *)dep->name, dep->namelen,\n\t\t\t    be64_to_cpu(dep->inumber),\n\t\t\t    xfs_dir3_get_dtype(dp->i_mount, filetype)))\n\t\t\tgoto out_rele;\n\t}\n\n\t \n\tctx->pos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk + 1, 0) &\n\t\t\t\t\t\t\t\t0x7fffffff;\nout_rele:\n\txfs_trans_brelse(args->trans, bp);\n\treturn error;\n}\n\n \nSTATIC int\nxfs_dir2_leaf_readbuf(\n\tstruct xfs_da_args\t*args,\n\tsize_t\t\t\tbufsize,\n\txfs_dir2_off_t\t\t*cur_off,\n\txfs_dablk_t\t\t*ra_blk,\n\tstruct xfs_buf\t\t**bpp)\n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_buf\t\t*bp = NULL;\n\tstruct xfs_da_geometry\t*geo = args->geo;\n\tstruct xfs_ifork\t*ifp = xfs_ifork_ptr(dp, XFS_DATA_FORK);\n\tstruct xfs_bmbt_irec\tmap;\n\tstruct blk_plug\t\tplug;\n\txfs_dir2_off_t\t\tnew_off;\n\txfs_dablk_t\t\tnext_ra;\n\txfs_dablk_t\t\tmap_off;\n\txfs_dablk_t\t\tlast_da;\n\tstruct xfs_iext_cursor\ticur;\n\tint\t\t\tra_want;\n\tint\t\t\terror = 0;\n\n\terror = xfs_iread_extents(args->trans, dp, XFS_DATA_FORK);\n\tif (error)\n\t\tgoto out;\n\n\t \n\tlast_da = xfs_dir2_byte_to_da(geo, XFS_DIR2_LEAF_OFFSET);\n\tmap_off = xfs_dir2_db_to_da(geo, xfs_dir2_byte_to_db(geo, *cur_off));\n\tif (!xfs_iext_lookup_extent(dp, ifp, map_off, &icur, &map))\n\t\tgoto out;\n\tif (map.br_startoff >= last_da)\n\t\tgoto out;\n\txfs_trim_extent(&map, map_off, last_da - map_off);\n\n\t \n\tnew_off = xfs_dir2_da_to_byte(geo, map.br_startoff);\n\tif (new_off > *cur_off)\n\t\t*cur_off = new_off;\n\terror = xfs_dir3_data_read(args->trans, dp, map.br_startoff, 0, &bp);\n\tif (error)\n\t\tgoto out;\n\n\t \n\tra_want = howmany(bufsize + geo->blksize, (1 << geo->fsblog));\n\tif (*ra_blk >= last_da)\n\t\tgoto out;\n\telse if (*ra_blk == 0)\n\t\t*ra_blk = map.br_startoff;\n\tnext_ra = map.br_startoff + geo->fsbcount;\n\tif (next_ra >= last_da)\n\t\tgoto out_no_ra;\n\tif (map.br_blockcount < geo->fsbcount &&\n\t    !xfs_iext_next_extent(ifp, &icur, &map))\n\t\tgoto out_no_ra;\n\tif (map.br_startoff >= last_da)\n\t\tgoto out_no_ra;\n\txfs_trim_extent(&map, next_ra, last_da - next_ra);\n\n\t \n\tblk_start_plug(&plug);\n\twhile (ra_want > 0) {\n\t\tnext_ra = roundup((xfs_dablk_t)map.br_startoff, geo->fsbcount);\n\t\twhile (ra_want > 0 &&\n\t\t       next_ra < map.br_startoff + map.br_blockcount) {\n\t\t\tif (next_ra >= last_da) {\n\t\t\t\t*ra_blk = last_da;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (next_ra > *ra_blk) {\n\t\t\t\txfs_dir3_data_readahead(dp, next_ra,\n\t\t\t\t\t\t\tXFS_DABUF_MAP_HOLE_OK);\n\t\t\t\t*ra_blk = next_ra;\n\t\t\t}\n\t\t\tra_want -= geo->fsbcount;\n\t\t\tnext_ra += geo->fsbcount;\n\t\t}\n\t\tif (!xfs_iext_next_extent(ifp, &icur, &map)) {\n\t\t\t*ra_blk = last_da;\n\t\t\tbreak;\n\t\t}\n\t}\n\tblk_finish_plug(&plug);\n\nout:\n\t*bpp = bp;\n\treturn error;\nout_no_ra:\n\t*ra_blk = last_da;\n\tgoto out;\n}\n\n \nSTATIC int\nxfs_dir2_leaf_getdents(\n\tstruct xfs_da_args\t*args,\n\tstruct dir_context\t*ctx,\n\tsize_t\t\t\tbufsize,\n\tunsigned int\t\t*lock_mode)\n{\n\tstruct xfs_inode\t*dp = args->dp;\n\tstruct xfs_mount\t*mp = dp->i_mount;\n\tstruct xfs_buf\t\t*bp = NULL;\t \n\txfs_dir2_data_entry_t\t*dep;\t\t \n\txfs_dir2_data_unused_t\t*dup;\t\t \n\tstruct xfs_da_geometry\t*geo = args->geo;\n\txfs_dablk_t\t\trablk = 0;\t \n\txfs_dir2_off_t\t\tcuroff;\t\t \n\tint\t\t\tlength;\t\t \n\tint\t\t\tbyteoff;\t \n\tunsigned int\t\toffset = 0;\n\tint\t\t\terror = 0;\t \n\n\t \n\tif (ctx->pos >= XFS_DIR2_MAX_DATAPTR)\n\t\treturn 0;\n\n\t \n\tcuroff = xfs_dir2_dataptr_to_byte(ctx->pos);\n\n\t \n\twhile (curoff < XFS_DIR2_LEAF_OFFSET) {\n\t\tuint8_t filetype;\n\n\t\t \n\t\tif (!bp || offset >= geo->blksize) {\n\t\t\tif (bp) {\n\t\t\t\txfs_trans_brelse(args->trans, bp);\n\t\t\t\tbp = NULL;\n\t\t\t}\n\n\t\t\tif (*lock_mode == 0)\n\t\t\t\t*lock_mode = xfs_ilock_data_map_shared(dp);\n\t\t\terror = xfs_dir2_leaf_readbuf(args, bufsize, &curoff,\n\t\t\t\t\t&rablk, &bp);\n\t\t\tif (error || !bp)\n\t\t\t\tbreak;\n\n\t\t\txfs_iunlock(dp, *lock_mode);\n\t\t\t*lock_mode = 0;\n\n\t\t\txfs_dir3_data_check(dp, bp);\n\t\t\t \n\t\t\toffset = geo->data_entry_offset;\n\t\t\tbyteoff = xfs_dir2_byte_to_off(geo, curoff);\n\t\t\t \n\t\t\tif (byteoff == 0)\n\t\t\t\tcuroff += geo->data_entry_offset;\n\t\t\t \n\t\t\telse {\n\t\t\t\twhile (offset < byteoff) {\n\t\t\t\t\tdup = bp->b_addr + offset;\n\n\t\t\t\t\tif (be16_to_cpu(dup->freetag)\n\t\t\t\t\t\t  == XFS_DIR2_DATA_FREE_TAG) {\n\n\t\t\t\t\t\tlength = be16_to_cpu(dup->length);\n\t\t\t\t\t\toffset += length;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tdep = bp->b_addr + offset;\n\t\t\t\t\tlength = xfs_dir2_data_entsize(mp,\n\t\t\t\t\t\t\tdep->namelen);\n\t\t\t\t\toffset += length;\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tcuroff =\n\t\t\t\t\txfs_dir2_db_off_to_byte(geo,\n\t\t\t\t\t    xfs_dir2_byte_to_db(geo, curoff),\n\t\t\t\t\t    offset);\n\t\t\t\tif (offset >= geo->blksize)\n\t\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tdup = bp->b_addr + offset;\n\n\t\t \n\t\tif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\n\t\t\tlength = be16_to_cpu(dup->length);\n\t\t\toffset += length;\n\t\t\tcuroff += length;\n\t\t\tcontinue;\n\t\t}\n\n\t\tdep = bp->b_addr + offset;\n\t\tlength = xfs_dir2_data_entsize(mp, dep->namelen);\n\t\tfiletype = xfs_dir2_data_get_ftype(mp, dep);\n\n\t\tctx->pos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\n\t\tif (XFS_IS_CORRUPT(dp->i_mount,\n\t\t\t\t   !xfs_dir2_namecheck(dep->name,\n\t\t\t\t\t\t       dep->namelen))) {\n\t\t\terror = -EFSCORRUPTED;\n\t\t\tbreak;\n\t\t}\n\t\tif (!dir_emit(ctx, (char *)dep->name, dep->namelen,\n\t\t\t    be64_to_cpu(dep->inumber),\n\t\t\t    xfs_dir3_get_dtype(dp->i_mount, filetype)))\n\t\t\tbreak;\n\n\t\t \n\t\toffset += length;\n\t\tcuroff += length;\n\t\t \n\t\tbufsize = bufsize > length ? bufsize - length : 0;\n\t}\n\n\t \n\tif (curoff > xfs_dir2_dataptr_to_byte(XFS_DIR2_MAX_DATAPTR))\n\t\tctx->pos = XFS_DIR2_MAX_DATAPTR & 0x7fffffff;\n\telse\n\t\tctx->pos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\n\tif (bp)\n\t\txfs_trans_brelse(args->trans, bp);\n\treturn error;\n}\n\n \nint\nxfs_readdir(\n\tstruct xfs_trans\t*tp,\n\tstruct xfs_inode\t*dp,\n\tstruct dir_context\t*ctx,\n\tsize_t\t\t\tbufsize)\n{\n\tstruct xfs_da_args\targs = { NULL };\n\tunsigned int\t\tlock_mode;\n\tbool\t\t\tisblock;\n\tint\t\t\terror;\n\n\ttrace_xfs_readdir(dp);\n\n\tif (xfs_is_shutdown(dp->i_mount))\n\t\treturn -EIO;\n\n\tASSERT(S_ISDIR(VFS_I(dp)->i_mode));\n\tASSERT(xfs_isilocked(dp, XFS_IOLOCK_SHARED | XFS_IOLOCK_EXCL));\n\tXFS_STATS_INC(dp->i_mount, xs_dir_getdents);\n\n\targs.dp = dp;\n\targs.geo = dp->i_mount->m_dir_geo;\n\targs.trans = tp;\n\n\tif (dp->i_df.if_format == XFS_DINODE_FMT_LOCAL)\n\t\treturn xfs_dir2_sf_getdents(&args, ctx);\n\n\tlock_mode = xfs_ilock_data_map_shared(dp);\n\terror = xfs_dir2_isblock(&args, &isblock);\n\tif (error)\n\t\tgoto out_unlock;\n\n\tif (isblock) {\n\t\terror = xfs_dir2_block_getdents(&args, ctx, &lock_mode);\n\t\tgoto out_unlock;\n\t}\n\n\terror = xfs_dir2_leaf_getdents(&args, ctx, bufsize, &lock_mode);\n\nout_unlock:\n\tif (lock_mode)\n\t\txfs_iunlock(dp, lock_mode);\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}