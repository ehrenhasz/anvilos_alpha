{
  "module_name": "xfs_filestream.c",
  "hash_id": "40a014282fa7b6b02029875cc8e177eadf35d267e5c44f42143f2ce6a73d6f17",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_filestream.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_bmap.h\"\n#include \"xfs_bmap_util.h\"\n#include \"xfs_alloc.h\"\n#include \"xfs_mru_cache.h\"\n#include \"xfs_trace.h\"\n#include \"xfs_ag.h\"\n#include \"xfs_ag_resv.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_filestream.h\"\n\nstruct xfs_fstrm_item {\n\tstruct xfs_mru_cache_elem\tmru;\n\tstruct xfs_perag\t\t*pag;  \n};\n\nenum xfs_fstrm_alloc {\n\tXFS_PICK_USERDATA = 1,\n\tXFS_PICK_LOWSPACE = 2,\n};\n\nstatic void\nxfs_fstrm_free_func(\n\tvoid\t\t\t*data,\n\tstruct xfs_mru_cache_elem *mru)\n{\n\tstruct xfs_fstrm_item\t*item =\n\t\tcontainer_of(mru, struct xfs_fstrm_item, mru);\n\tstruct xfs_perag\t*pag = item->pag;\n\n\ttrace_xfs_filestream_free(pag, mru->key);\n\tatomic_dec(&pag->pagf_fstrms);\n\txfs_perag_rele(pag);\n\n\tkmem_free(item);\n}\n\n \nstatic int\nxfs_filestream_pick_ag(\n\tstruct xfs_alloc_arg\t*args,\n\txfs_ino_t\t\tpino,\n\txfs_agnumber_t\t\tstart_agno,\n\tint\t\t\tflags,\n\txfs_extlen_t\t\t*longest)\n{\n\tstruct xfs_mount\t*mp = args->mp;\n\tstruct xfs_perag\t*pag;\n\tstruct xfs_perag\t*max_pag = NULL;\n\txfs_extlen_t\t\tminlen = *longest;\n\txfs_extlen_t\t\tfree = 0, minfree, maxfree = 0;\n\txfs_agnumber_t\t\tagno;\n\tbool\t\t\tfirst_pass = true;\n\tint\t\t\terr;\n\n\t \n\tminfree = mp->m_sb.sb_agblocks / 50;\n\nrestart:\n\tfor_each_perag_wrap(mp, start_agno, agno, pag) {\n\t\ttrace_xfs_filestream_scan(pag, pino);\n\t\t*longest = 0;\n\t\terr = xfs_bmap_longest_free_extent(pag, NULL, longest);\n\t\tif (err) {\n\t\t\tif (err != -EAGAIN)\n\t\t\t\tbreak;\n\t\t\t \n\t\t\terr = 0;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (pag->pagf_freeblks > maxfree) {\n\t\t\tmaxfree = pag->pagf_freeblks;\n\t\t\tif (max_pag)\n\t\t\t\txfs_perag_rele(max_pag);\n\t\t\tatomic_inc(&pag->pag_active_ref);\n\t\t\tmax_pag = pag;\n\t\t}\n\n\t\t \n\t\tif (atomic_inc_return(&pag->pagf_fstrms) <= 1) {\n\t\t\tif (((minlen && *longest >= minlen) ||\n\t\t\t     (!minlen && pag->pagf_freeblks >= minfree)) &&\n\t\t\t    (!xfs_perag_prefers_metadata(pag) ||\n\t\t\t     !(flags & XFS_PICK_USERDATA) ||\n\t\t\t     (flags & XFS_PICK_LOWSPACE))) {\n\t\t\t\t \n\t\t\t\tfree = pag->pagf_freeblks;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tatomic_dec(&pag->pagf_fstrms);\n\t}\n\n\tif (err) {\n\t\txfs_perag_rele(pag);\n\t\tif (max_pag)\n\t\t\txfs_perag_rele(max_pag);\n\t\treturn err;\n\t}\n\n\tif (!pag) {\n\t\t \n\t\tif (first_pass) {\n\t\t\tfirst_pass = false;\n\t\t\tgoto restart;\n\t\t}\n\n\t\t \n\t\tif (!(flags & XFS_PICK_LOWSPACE)) {\n\t\t\tflags |= XFS_PICK_LOWSPACE;\n\t\t\tgoto restart;\n\t\t}\n\n\t\t \n\t\tif (!max_pag) {\n\t\t\tfor_each_perag_wrap(args->mp, 0, start_agno, args->pag)\n\t\t\t\tbreak;\n\t\t\tatomic_inc(&args->pag->pagf_fstrms);\n\t\t\t*longest = 0;\n\t\t} else {\n\t\t\tpag = max_pag;\n\t\t\tfree = maxfree;\n\t\t\tatomic_inc(&pag->pagf_fstrms);\n\t\t}\n\t} else if (max_pag) {\n\t\txfs_perag_rele(max_pag);\n\t}\n\n\ttrace_xfs_filestream_pick(pag, pino, free);\n\targs->pag = pag;\n\treturn 0;\n\n}\n\nstatic struct xfs_inode *\nxfs_filestream_get_parent(\n\tstruct xfs_inode\t*ip)\n{\n\tstruct inode\t\t*inode = VFS_I(ip), *dir = NULL;\n\tstruct dentry\t\t*dentry, *parent;\n\n\tdentry = d_find_alias(inode);\n\tif (!dentry)\n\t\tgoto out;\n\n\tparent = dget_parent(dentry);\n\tif (!parent)\n\t\tgoto out_dput;\n\n\tdir = igrab(d_inode(parent));\n\tdput(parent);\n\nout_dput:\n\tdput(dentry);\nout:\n\treturn dir ? XFS_I(dir) : NULL;\n}\n\n \nstatic int\nxfs_filestream_lookup_association(\n\tstruct xfs_bmalloca\t*ap,\n\tstruct xfs_alloc_arg\t*args,\n\txfs_ino_t\t\tpino,\n\txfs_extlen_t\t\t*longest)\n{\n\tstruct xfs_mount\t*mp = args->mp;\n\tstruct xfs_perag\t*pag;\n\tstruct xfs_mru_cache_elem *mru;\n\tint\t\t\terror = 0;\n\n\t*longest = 0;\n\tmru = xfs_mru_cache_lookup(mp->m_filestream, pino);\n\tif (!mru)\n\t\treturn 0;\n\t \n\tpag = container_of(mru, struct xfs_fstrm_item, mru)->pag;\n\tatomic_inc(&pag->pag_active_ref);\n\txfs_mru_cache_done(mp->m_filestream);\n\n\ttrace_xfs_filestream_lookup(pag, ap->ip->i_ino);\n\n\tap->blkno = XFS_AGB_TO_FSB(args->mp, pag->pag_agno, 0);\n\txfs_bmap_adjacent(ap);\n\n\t \n\tif (ap->tp->t_flags & XFS_TRANS_LOWMODE) {\n\t\t*longest = 1;\n\t\tgoto out_done;\n\t}\n\n\terror = xfs_bmap_longest_free_extent(pag, args->tp, longest);\n\tif (error == -EAGAIN)\n\t\terror = 0;\n\tif (error || *longest < args->maxlen) {\n\t\t \n\t\t*longest = 0;\n\t\txfs_perag_rele(pag);\n\t\treturn error;\n\t}\n\nout_done:\n\targs->pag = pag;\n\treturn 0;\n}\n\nstatic int\nxfs_filestream_create_association(\n\tstruct xfs_bmalloca\t*ap,\n\tstruct xfs_alloc_arg\t*args,\n\txfs_ino_t\t\tpino,\n\txfs_extlen_t\t\t*longest)\n{\n\tstruct xfs_mount\t*mp = args->mp;\n\tstruct xfs_mru_cache_elem *mru;\n\tstruct xfs_fstrm_item\t*item;\n\txfs_agnumber_t\t\tagno = XFS_INO_TO_AGNO(mp, pino);\n\tint\t\t\tflags = 0;\n\tint\t\t\terror;\n\n\t \n\tmru = xfs_mru_cache_remove(mp->m_filestream, pino);\n\tif (mru) {\n\t\tstruct xfs_fstrm_item *item =\n\t\t\tcontainer_of(mru, struct xfs_fstrm_item, mru);\n\n\t\tagno = (item->pag->pag_agno + 1) % mp->m_sb.sb_agcount;\n\t\txfs_fstrm_free_func(mp, mru);\n\t} else if (xfs_is_inode32(mp)) {\n\t\txfs_agnumber_t\t rotorstep = xfs_rotorstep;\n\n\t\tagno = (mp->m_agfrotor / rotorstep) % mp->m_sb.sb_agcount;\n\t\tmp->m_agfrotor = (mp->m_agfrotor + 1) %\n\t\t\t\t (mp->m_sb.sb_agcount * rotorstep);\n\t}\n\n\tap->blkno = XFS_AGB_TO_FSB(args->mp, agno, 0);\n\txfs_bmap_adjacent(ap);\n\n\tif (ap->datatype & XFS_ALLOC_USERDATA)\n\t\tflags |= XFS_PICK_USERDATA;\n\tif (ap->tp->t_flags & XFS_TRANS_LOWMODE)\n\t\tflags |= XFS_PICK_LOWSPACE;\n\n\t*longest = ap->length;\n\terror = xfs_filestream_pick_ag(args, pino, agno, flags, longest);\n\tif (error)\n\t\treturn error;\n\n\t \n\titem = kmem_alloc(sizeof(*item), KM_MAYFAIL);\n\tif (!item)\n\t\tgoto out_put_fstrms;\n\n\tatomic_inc(&args->pag->pag_active_ref);\n\titem->pag = args->pag;\n\terror = xfs_mru_cache_insert(mp->m_filestream, pino, &item->mru);\n\tif (error)\n\t\tgoto out_free_item;\n\treturn 0;\n\nout_free_item:\n\txfs_perag_rele(item->pag);\n\tkmem_free(item);\nout_put_fstrms:\n\tatomic_dec(&args->pag->pagf_fstrms);\n\treturn 0;\n}\n\n \nint\nxfs_filestream_select_ag(\n\tstruct xfs_bmalloca\t*ap,\n\tstruct xfs_alloc_arg\t*args,\n\txfs_extlen_t\t\t*longest)\n{\n\tstruct xfs_mount\t*mp = args->mp;\n\tstruct xfs_inode\t*pip;\n\txfs_ino_t\t\tino = 0;\n\tint\t\t\terror = 0;\n\n\t*longest = 0;\n\targs->total = ap->total;\n\tpip = xfs_filestream_get_parent(ap->ip);\n\tif (pip) {\n\t\tino = pip->i_ino;\n\t\terror = xfs_filestream_lookup_association(ap, args, ino,\n\t\t\t\tlongest);\n\t\txfs_irele(pip);\n\t\tif (error)\n\t\t\treturn error;\n\t\tif (*longest >= args->maxlen)\n\t\t\tgoto out_select;\n\t\tif (ap->tp->t_flags & XFS_TRANS_LOWMODE)\n\t\t\tgoto out_select;\n\t}\n\n\terror = xfs_filestream_create_association(ap, args, ino, longest);\n\tif (error)\n\t\treturn error;\n\nout_select:\n\tap->blkno = XFS_AGB_TO_FSB(mp, args->pag->pag_agno, 0);\n\treturn 0;\n}\n\nvoid\nxfs_filestream_deassociate(\n\tstruct xfs_inode\t*ip)\n{\n\txfs_mru_cache_delete(ip->i_mount->m_filestream, ip->i_ino);\n}\n\nint\nxfs_filestream_mount(\n\txfs_mount_t\t*mp)\n{\n\t \n\treturn xfs_mru_cache_create(&mp->m_filestream, mp,\n\t\t\txfs_fstrm_centisecs * 10, 10, xfs_fstrm_free_func);\n}\n\nvoid\nxfs_filestream_unmount(\n\txfs_mount_t\t*mp)\n{\n\txfs_mru_cache_destroy(mp->m_filestream);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}