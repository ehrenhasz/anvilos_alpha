{
  "module_name": "xfs_dquot_item.c",
  "hash_id": "ed262f09c5a157509bab8cfde8de315fbbd7ce5ba6e15397d36618b78093371a",
  "original_prompt": "Ingested from linux-6.6.14/fs/xfs/xfs_dquot_item.c",
  "human_readable_source": "\n \n#include \"xfs.h\"\n#include \"xfs_fs.h\"\n#include \"xfs_shared.h\"\n#include \"xfs_format.h\"\n#include \"xfs_log_format.h\"\n#include \"xfs_trans_resv.h\"\n#include \"xfs_mount.h\"\n#include \"xfs_inode.h\"\n#include \"xfs_quota.h\"\n#include \"xfs_trans.h\"\n#include \"xfs_buf_item.h\"\n#include \"xfs_trans_priv.h\"\n#include \"xfs_qm.h\"\n#include \"xfs_log.h\"\n\nstatic inline struct xfs_dq_logitem *DQUOT_ITEM(struct xfs_log_item *lip)\n{\n\treturn container_of(lip, struct xfs_dq_logitem, qli_item);\n}\n\n \nSTATIC void\nxfs_qm_dquot_logitem_size(\n\tstruct xfs_log_item\t*lip,\n\tint\t\t\t*nvecs,\n\tint\t\t\t*nbytes)\n{\n\t*nvecs += 2;\n\t*nbytes += sizeof(struct xfs_dq_logformat) +\n\t\t   sizeof(struct xfs_disk_dquot);\n}\n\n \nSTATIC void\nxfs_qm_dquot_logitem_format(\n\tstruct xfs_log_item\t*lip,\n\tstruct xfs_log_vec\t*lv)\n{\n\tstruct xfs_disk_dquot\tddq;\n\tstruct xfs_dq_logitem\t*qlip = DQUOT_ITEM(lip);\n\tstruct xfs_log_iovec\t*vecp = NULL;\n\tstruct xfs_dq_logformat\t*qlf;\n\n\tqlf = xlog_prepare_iovec(lv, &vecp, XLOG_REG_TYPE_QFORMAT);\n\tqlf->qlf_type = XFS_LI_DQUOT;\n\tqlf->qlf_size = 2;\n\tqlf->qlf_id = qlip->qli_dquot->q_id;\n\tqlf->qlf_blkno = qlip->qli_dquot->q_blkno;\n\tqlf->qlf_len = 1;\n\tqlf->qlf_boffset = qlip->qli_dquot->q_bufoffset;\n\txlog_finish_iovec(lv, vecp, sizeof(struct xfs_dq_logformat));\n\n\txfs_dquot_to_disk(&ddq, qlip->qli_dquot);\n\n\txlog_copy_iovec(lv, &vecp, XLOG_REG_TYPE_DQUOT, &ddq,\n\t\t\tsizeof(struct xfs_disk_dquot));\n}\n\n \nSTATIC void\nxfs_qm_dquot_logitem_pin(\n\tstruct xfs_log_item\t*lip)\n{\n\tstruct xfs_dquot\t*dqp = DQUOT_ITEM(lip)->qli_dquot;\n\n\tASSERT(XFS_DQ_IS_LOCKED(dqp));\n\tatomic_inc(&dqp->q_pincount);\n}\n\n \nSTATIC void\nxfs_qm_dquot_logitem_unpin(\n\tstruct xfs_log_item\t*lip,\n\tint\t\t\tremove)\n{\n\tstruct xfs_dquot\t*dqp = DQUOT_ITEM(lip)->qli_dquot;\n\n\tASSERT(atomic_read(&dqp->q_pincount) > 0);\n\tif (atomic_dec_and_test(&dqp->q_pincount))\n\t\twake_up(&dqp->q_pinwait);\n}\n\n \nvoid\nxfs_qm_dqunpin_wait(\n\tstruct xfs_dquot\t*dqp)\n{\n\tASSERT(XFS_DQ_IS_LOCKED(dqp));\n\tif (atomic_read(&dqp->q_pincount) == 0)\n\t\treturn;\n\n\t \n\txfs_log_force(dqp->q_mount, 0);\n\twait_event(dqp->q_pinwait, (atomic_read(&dqp->q_pincount) == 0));\n}\n\nSTATIC uint\nxfs_qm_dquot_logitem_push(\n\tstruct xfs_log_item\t*lip,\n\tstruct list_head\t*buffer_list)\n\t\t__releases(&lip->li_ailp->ail_lock)\n\t\t__acquires(&lip->li_ailp->ail_lock)\n{\n\tstruct xfs_dquot\t*dqp = DQUOT_ITEM(lip)->qli_dquot;\n\tstruct xfs_buf\t\t*bp = lip->li_buf;\n\tuint\t\t\trval = XFS_ITEM_SUCCESS;\n\tint\t\t\terror;\n\n\tif (atomic_read(&dqp->q_pincount) > 0)\n\t\treturn XFS_ITEM_PINNED;\n\n\tif (!xfs_dqlock_nowait(dqp))\n\t\treturn XFS_ITEM_LOCKED;\n\n\t \n\tif (atomic_read(&dqp->q_pincount) > 0) {\n\t\trval = XFS_ITEM_PINNED;\n\t\tgoto out_unlock;\n\t}\n\n\t \n\tif (!xfs_dqflock_nowait(dqp)) {\n\t\trval = XFS_ITEM_FLUSHING;\n\t\tgoto out_unlock;\n\t}\n\n\tspin_unlock(&lip->li_ailp->ail_lock);\n\n\terror = xfs_qm_dqflush(dqp, &bp);\n\tif (!error) {\n\t\tif (!xfs_buf_delwri_queue(bp, buffer_list))\n\t\t\trval = XFS_ITEM_FLUSHING;\n\t\txfs_buf_relse(bp);\n\t} else if (error == -EAGAIN)\n\t\trval = XFS_ITEM_LOCKED;\n\n\tspin_lock(&lip->li_ailp->ail_lock);\nout_unlock:\n\txfs_dqunlock(dqp);\n\treturn rval;\n}\n\nSTATIC void\nxfs_qm_dquot_logitem_release(\n\tstruct xfs_log_item\t*lip)\n{\n\tstruct xfs_dquot\t*dqp = DQUOT_ITEM(lip)->qli_dquot;\n\n\tASSERT(XFS_DQ_IS_LOCKED(dqp));\n\n\t \n\txfs_dqunlock(dqp);\n}\n\nSTATIC void\nxfs_qm_dquot_logitem_committing(\n\tstruct xfs_log_item\t*lip,\n\txfs_csn_t\t\tseq)\n{\n\treturn xfs_qm_dquot_logitem_release(lip);\n}\n\nstatic const struct xfs_item_ops xfs_dquot_item_ops = {\n\t.iop_size\t= xfs_qm_dquot_logitem_size,\n\t.iop_format\t= xfs_qm_dquot_logitem_format,\n\t.iop_pin\t= xfs_qm_dquot_logitem_pin,\n\t.iop_unpin\t= xfs_qm_dquot_logitem_unpin,\n\t.iop_release\t= xfs_qm_dquot_logitem_release,\n\t.iop_committing\t= xfs_qm_dquot_logitem_committing,\n\t.iop_push\t= xfs_qm_dquot_logitem_push,\n};\n\n \nvoid\nxfs_qm_dquot_logitem_init(\n\tstruct xfs_dquot\t*dqp)\n{\n\tstruct xfs_dq_logitem\t*lp = &dqp->q_logitem;\n\n\txfs_log_item_init(dqp->q_mount, &lp->qli_item, XFS_LI_DQUOT,\n\t\t\t\t\t&xfs_dquot_item_ops);\n\tlp->qli_dquot = dqp;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}