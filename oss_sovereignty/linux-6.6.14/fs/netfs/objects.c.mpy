{
  "module_name": "objects.c",
  "hash_id": "8cfa6ebae56decd51357bfaebaec56772713c328e5826eba252b5a84a1d73b5c",
  "original_prompt": "Ingested from linux-6.6.14/fs/netfs/objects.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include \"internal.h\"\n\n \nstruct netfs_io_request *netfs_alloc_request(struct address_space *mapping,\n\t\t\t\t\t     struct file *file,\n\t\t\t\t\t     loff_t start, size_t len,\n\t\t\t\t\t     enum netfs_io_origin origin)\n{\n\tstatic atomic_t debug_ids;\n\tstruct inode *inode = file ? file_inode(file) : mapping->host;\n\tstruct netfs_inode *ctx = netfs_inode(inode);\n\tstruct netfs_io_request *rreq;\n\tint ret;\n\n\trreq = kzalloc(sizeof(struct netfs_io_request), GFP_KERNEL);\n\tif (!rreq)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\trreq->start\t= start;\n\trreq->len\t= len;\n\trreq->origin\t= origin;\n\trreq->netfs_ops\t= ctx->ops;\n\trreq->mapping\t= mapping;\n\trreq->inode\t= inode;\n\trreq->i_size\t= i_size_read(inode);\n\trreq->debug_id\t= atomic_inc_return(&debug_ids);\n\tINIT_LIST_HEAD(&rreq->subrequests);\n\trefcount_set(&rreq->ref, 1);\n\t__set_bit(NETFS_RREQ_IN_PROGRESS, &rreq->flags);\n\tif (rreq->netfs_ops->init_request) {\n\t\tret = rreq->netfs_ops->init_request(rreq, file);\n\t\tif (ret < 0) {\n\t\t\tkfree(rreq);\n\t\t\treturn ERR_PTR(ret);\n\t\t}\n\t}\n\n\tnetfs_stat(&netfs_n_rh_rreq);\n\treturn rreq;\n}\n\nvoid netfs_get_request(struct netfs_io_request *rreq, enum netfs_rreq_ref_trace what)\n{\n\tint r;\n\n\t__refcount_inc(&rreq->ref, &r);\n\ttrace_netfs_rreq_ref(rreq->debug_id, r + 1, what);\n}\n\nvoid netfs_clear_subrequests(struct netfs_io_request *rreq, bool was_async)\n{\n\tstruct netfs_io_subrequest *subreq;\n\n\twhile (!list_empty(&rreq->subrequests)) {\n\t\tsubreq = list_first_entry(&rreq->subrequests,\n\t\t\t\t\t  struct netfs_io_subrequest, rreq_link);\n\t\tlist_del(&subreq->rreq_link);\n\t\tnetfs_put_subrequest(subreq, was_async,\n\t\t\t\t     netfs_sreq_trace_put_clear);\n\t}\n}\n\nstatic void netfs_free_request(struct work_struct *work)\n{\n\tstruct netfs_io_request *rreq =\n\t\tcontainer_of(work, struct netfs_io_request, work);\n\n\ttrace_netfs_rreq(rreq, netfs_rreq_trace_free);\n\tnetfs_clear_subrequests(rreq, false);\n\tif (rreq->netfs_ops->free_request)\n\t\trreq->netfs_ops->free_request(rreq);\n\tif (rreq->cache_resources.ops)\n\t\trreq->cache_resources.ops->end_operation(&rreq->cache_resources);\n\tkfree(rreq);\n\tnetfs_stat_d(&netfs_n_rh_rreq);\n}\n\nvoid netfs_put_request(struct netfs_io_request *rreq, bool was_async,\n\t\t       enum netfs_rreq_ref_trace what)\n{\n\tunsigned int debug_id = rreq->debug_id;\n\tbool dead;\n\tint r;\n\n\tdead = __refcount_dec_and_test(&rreq->ref, &r);\n\ttrace_netfs_rreq_ref(debug_id, r - 1, what);\n\tif (dead) {\n\t\tif (was_async) {\n\t\t\trreq->work.func = netfs_free_request;\n\t\t\tif (!queue_work(system_unbound_wq, &rreq->work))\n\t\t\t\tBUG();\n\t\t} else {\n\t\t\tnetfs_free_request(&rreq->work);\n\t\t}\n\t}\n}\n\n \nstruct netfs_io_subrequest *netfs_alloc_subrequest(struct netfs_io_request *rreq)\n{\n\tstruct netfs_io_subrequest *subreq;\n\n\tsubreq = kzalloc(sizeof(struct netfs_io_subrequest), GFP_KERNEL);\n\tif (subreq) {\n\t\tINIT_LIST_HEAD(&subreq->rreq_link);\n\t\trefcount_set(&subreq->ref, 2);\n\t\tsubreq->rreq = rreq;\n\t\tnetfs_get_request(rreq, netfs_rreq_trace_get_subreq);\n\t\tnetfs_stat(&netfs_n_rh_sreq);\n\t}\n\n\treturn subreq;\n}\n\nvoid netfs_get_subrequest(struct netfs_io_subrequest *subreq,\n\t\t\t  enum netfs_sreq_ref_trace what)\n{\n\tint r;\n\n\t__refcount_inc(&subreq->ref, &r);\n\ttrace_netfs_sreq_ref(subreq->rreq->debug_id, subreq->debug_index, r + 1,\n\t\t\t     what);\n}\n\nstatic void netfs_free_subrequest(struct netfs_io_subrequest *subreq,\n\t\t\t\t  bool was_async)\n{\n\tstruct netfs_io_request *rreq = subreq->rreq;\n\n\ttrace_netfs_sreq(subreq, netfs_sreq_trace_free);\n\tkfree(subreq);\n\tnetfs_stat_d(&netfs_n_rh_sreq);\n\tnetfs_put_request(rreq, was_async, netfs_rreq_trace_put_subreq);\n}\n\nvoid netfs_put_subrequest(struct netfs_io_subrequest *subreq, bool was_async,\n\t\t\t  enum netfs_sreq_ref_trace what)\n{\n\tunsigned int debug_index = subreq->debug_index;\n\tunsigned int debug_id = subreq->rreq->debug_id;\n\tbool dead;\n\tint r;\n\n\tdead = __refcount_dec_and_test(&subreq->ref, &r);\n\ttrace_netfs_sreq_ref(debug_id, debug_index, r - 1, what);\n\tif (dead)\n\t\tnetfs_free_subrequest(subreq, was_async);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}