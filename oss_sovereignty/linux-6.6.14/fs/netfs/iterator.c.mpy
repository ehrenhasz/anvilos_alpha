{
  "module_name": "iterator.c",
  "hash_id": "d5d3871e9e1e5a981d74926b1836dd61ac5cdf3d04d9fd97eab46c167a72f19b",
  "original_prompt": "Ingested from linux-6.6.14/fs/netfs/iterator.c",
  "human_readable_source": "\n \n\n#include <linux/export.h>\n#include <linux/slab.h>\n#include <linux/mm.h>\n#include <linux/uio.h>\n#include <linux/scatterlist.h>\n#include <linux/netfs.h>\n#include \"internal.h\"\n\n \nssize_t netfs_extract_user_iter(struct iov_iter *orig, size_t orig_len,\n\t\t\t\tstruct iov_iter *new,\n\t\t\t\tiov_iter_extraction_t extraction_flags)\n{\n\tstruct bio_vec *bv = NULL;\n\tstruct page **pages;\n\tunsigned int cur_npages;\n\tunsigned int max_pages;\n\tunsigned int npages = 0;\n\tunsigned int i;\n\tssize_t ret;\n\tsize_t count = orig_len, offset, len;\n\tsize_t bv_size, pg_size;\n\n\tif (WARN_ON_ONCE(!iter_is_ubuf(orig) && !iter_is_iovec(orig)))\n\t\treturn -EIO;\n\n\tmax_pages = iov_iter_npages(orig, INT_MAX);\n\tbv_size = array_size(max_pages, sizeof(*bv));\n\tbv = kvmalloc(bv_size, GFP_KERNEL);\n\tif (!bv)\n\t\treturn -ENOMEM;\n\n\t \n\tpg_size = array_size(max_pages, sizeof(*pages));\n\tpages = (void *)bv + bv_size - pg_size;\n\n\twhile (count && npages < max_pages) {\n\t\tret = iov_iter_extract_pages(orig, &pages, count,\n\t\t\t\t\t     max_pages - npages, extraction_flags,\n\t\t\t\t\t     &offset);\n\t\tif (ret < 0) {\n\t\t\tpr_err(\"Couldn't get user pages (rc=%zd)\\n\", ret);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (ret > count) {\n\t\t\tpr_err(\"get_pages rc=%zd more than %zu\\n\", ret, count);\n\t\t\tbreak;\n\t\t}\n\n\t\tcount -= ret;\n\t\tret += offset;\n\t\tcur_npages = DIV_ROUND_UP(ret, PAGE_SIZE);\n\n\t\tif (npages + cur_npages > max_pages) {\n\t\t\tpr_err(\"Out of bvec array capacity (%u vs %u)\\n\",\n\t\t\t       npages + cur_npages, max_pages);\n\t\t\tbreak;\n\t\t}\n\n\t\tfor (i = 0; i < cur_npages; i++) {\n\t\t\tlen = ret > PAGE_SIZE ? PAGE_SIZE : ret;\n\t\t\tbvec_set_page(bv + npages + i, *pages++, len - offset, offset);\n\t\t\tret -= len;\n\t\t\toffset = 0;\n\t\t}\n\n\t\tnpages += cur_npages;\n\t}\n\n\tiov_iter_bvec(new, orig->data_source, bv, npages, orig_len - count);\n\treturn npages;\n}\nEXPORT_SYMBOL_GPL(netfs_extract_user_iter);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}