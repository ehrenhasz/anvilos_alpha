{
  "module_name": "metric.h",
  "hash_id": "01af23d3cd51c2563501b97ba593699d8aa6734b93cd5840a382b697382f9ae8",
  "original_prompt": "Ingested from linux-6.6.14/fs/ceph/metric.h",
  "human_readable_source": " \n#ifndef _FS_CEPH_MDS_METRIC_H\n#define _FS_CEPH_MDS_METRIC_H\n\n#include <linux/ceph/types.h>\n#include <linux/percpu_counter.h>\n#include <linux/ktime.h>\n\nextern bool disable_send_metrics;\n\nenum ceph_metric_type {\n\tCLIENT_METRIC_TYPE_CAP_INFO,\n\tCLIENT_METRIC_TYPE_READ_LATENCY,\n\tCLIENT_METRIC_TYPE_WRITE_LATENCY,\n\tCLIENT_METRIC_TYPE_METADATA_LATENCY,\n\tCLIENT_METRIC_TYPE_DENTRY_LEASE,\n\tCLIENT_METRIC_TYPE_OPENED_FILES,\n\tCLIENT_METRIC_TYPE_PINNED_ICAPS,\n\tCLIENT_METRIC_TYPE_OPENED_INODES,\n\tCLIENT_METRIC_TYPE_READ_IO_SIZES,\n\tCLIENT_METRIC_TYPE_WRITE_IO_SIZES,\n\tCLIENT_METRIC_TYPE_AVG_READ_LATENCY,\n\tCLIENT_METRIC_TYPE_STDEV_READ_LATENCY,\n\tCLIENT_METRIC_TYPE_AVG_WRITE_LATENCY,\n\tCLIENT_METRIC_TYPE_STDEV_WRITE_LATENCY,\n\tCLIENT_METRIC_TYPE_AVG_METADATA_LATENCY,\n\tCLIENT_METRIC_TYPE_STDEV_METADATA_LATENCY,\n\n\tCLIENT_METRIC_TYPE_MAX = CLIENT_METRIC_TYPE_STDEV_METADATA_LATENCY,\n};\n\n \n#define CEPHFS_METRIC_SPEC_CLIENT_SUPPORTED {\t   \\\n\tCLIENT_METRIC_TYPE_CAP_INFO,\t\t   \\\n\tCLIENT_METRIC_TYPE_READ_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_WRITE_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_METADATA_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_DENTRY_LEASE,\t   \\\n\tCLIENT_METRIC_TYPE_OPENED_FILES,\t   \\\n\tCLIENT_METRIC_TYPE_PINNED_ICAPS,\t   \\\n\tCLIENT_METRIC_TYPE_OPENED_INODES,\t   \\\n\tCLIENT_METRIC_TYPE_READ_IO_SIZES,\t   \\\n\tCLIENT_METRIC_TYPE_WRITE_IO_SIZES,\t   \\\n\tCLIENT_METRIC_TYPE_AVG_READ_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_STDEV_READ_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_AVG_WRITE_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_STDEV_WRITE_LATENCY,\t   \\\n\tCLIENT_METRIC_TYPE_AVG_METADATA_LATENCY,   \\\n\tCLIENT_METRIC_TYPE_STDEV_METADATA_LATENCY, \\\n\t\t\t\t\t\t   \\\n\tCLIENT_METRIC_TYPE_MAX,\t\t\t   \\\n}\n\nstruct ceph_metric_header {\n\t__le32 type;      \n\t__u8  ver;\n\t__u8  compat;\n\t__le32 data_len;  \n} __packed;\n\n \nstruct ceph_metric_cap {\n\tstruct ceph_metric_header header;\n\t__le64 hit;\n\t__le64 mis;\n\t__le64 total;\n} __packed;\n\n \nstruct ceph_metric_read_latency {\n\tstruct ceph_metric_header header;\n\tstruct ceph_timespec lat;\n\tstruct ceph_timespec avg;\n\t__le64 sq_sum;\n\t__le64 count;\n} __packed;\n\n \nstruct ceph_metric_write_latency {\n\tstruct ceph_metric_header header;\n\tstruct ceph_timespec lat;\n\tstruct ceph_timespec avg;\n\t__le64 sq_sum;\n\t__le64 count;\n} __packed;\n\n \nstruct ceph_metric_metadata_latency {\n\tstruct ceph_metric_header header;\n\tstruct ceph_timespec lat;\n\tstruct ceph_timespec avg;\n\t__le64 sq_sum;\n\t__le64 count;\n} __packed;\n\n \nstruct ceph_metric_dlease {\n\tstruct ceph_metric_header header;\n\t__le64 hit;\n\t__le64 mis;\n\t__le64 total;\n} __packed;\n\n \nstruct ceph_opened_files {\n\tstruct ceph_metric_header header;\n\t__le64 opened_files;\n\t__le64 total;\n} __packed;\n\n \nstruct ceph_pinned_icaps {\n\tstruct ceph_metric_header header;\n\t__le64 pinned_icaps;\n\t__le64 total;\n} __packed;\n\n \nstruct ceph_opened_inodes {\n\tstruct ceph_metric_header header;\n\t__le64 opened_inodes;\n\t__le64 total;\n} __packed;\n\n \nstruct ceph_read_io_size {\n\tstruct ceph_metric_header header;\n\t__le64 total_ops;\n\t__le64 total_size;\n} __packed;\n\n \nstruct ceph_write_io_size {\n\tstruct ceph_metric_header header;\n\t__le64 total_ops;\n\t__le64 total_size;\n} __packed;\n\nstruct ceph_metric_head {\n\t__le32 num;\t \n} __packed;\n\nenum metric_type {\n\tMETRIC_READ,\n\tMETRIC_WRITE,\n\tMETRIC_METADATA,\n\tMETRIC_COPYFROM,\n\tMETRIC_MAX\n};\n\nstruct ceph_metric {\n\tspinlock_t lock;\n\tu64 total;\n\tu64 size_sum;\n\tu64 size_min;\n\tu64 size_max;\n\tktime_t latency_sum;\n\tktime_t latency_avg;\n\tktime_t latency_sq_sum;\n\tktime_t latency_min;\n\tktime_t latency_max;\n};\n\n \nstruct ceph_client_metric {\n\tatomic64_t            total_dentries;\n\tstruct percpu_counter d_lease_hit;\n\tstruct percpu_counter d_lease_mis;\n\n\tatomic64_t            total_caps;\n\tstruct percpu_counter i_caps_hit;\n\tstruct percpu_counter i_caps_mis;\n\n\tstruct ceph_metric metric[METRIC_MAX];\n\n\t \n\tatomic64_t opened_files;\n\n\t \n\tstruct percpu_counter opened_inodes;\n\tstruct percpu_counter total_inodes;\n\n\tstruct ceph_mds_session *session;\n\tstruct delayed_work delayed_work;   \n};\n\nstatic inline void metric_schedule_delayed(struct ceph_client_metric *m)\n{\n\tif (disable_send_metrics)\n\t\treturn;\n\n\t \n\tschedule_delayed_work(&m->delayed_work, round_jiffies_relative(HZ));\n}\n\nextern int ceph_metric_init(struct ceph_client_metric *m);\nextern void ceph_metric_destroy(struct ceph_client_metric *m);\n\nstatic inline void ceph_update_cap_hit(struct ceph_client_metric *m)\n{\n\tpercpu_counter_inc(&m->i_caps_hit);\n}\n\nstatic inline void ceph_update_cap_mis(struct ceph_client_metric *m)\n{\n\tpercpu_counter_inc(&m->i_caps_mis);\n}\n\nextern void ceph_update_metrics(struct ceph_metric *m,\n\t\t\t\tktime_t r_start, ktime_t r_end,\n\t\t\t\tunsigned int size, int rc);\n\nstatic inline void ceph_update_read_metrics(struct ceph_client_metric *m,\n\t\t\t\t\t    ktime_t r_start, ktime_t r_end,\n\t\t\t\t\t    unsigned int size, int rc)\n{\n\tceph_update_metrics(&m->metric[METRIC_READ],\n\t\t\t    r_start, r_end, size, rc);\n}\nstatic inline void ceph_update_write_metrics(struct ceph_client_metric *m,\n\t\t\t\t\t     ktime_t r_start, ktime_t r_end,\n\t\t\t\t\t     unsigned int size, int rc)\n{\n\tceph_update_metrics(&m->metric[METRIC_WRITE],\n\t\t\t    r_start, r_end, size, rc);\n}\nstatic inline void ceph_update_metadata_metrics(struct ceph_client_metric *m,\n\t\t\t\t\t\tktime_t r_start, ktime_t r_end,\n\t\t\t\t\t\tint rc)\n{\n\tceph_update_metrics(&m->metric[METRIC_METADATA],\n\t\t\t    r_start, r_end, 0, rc);\n}\nstatic inline void ceph_update_copyfrom_metrics(struct ceph_client_metric *m,\n\t\t\t\t\t\tktime_t r_start, ktime_t r_end,\n\t\t\t\t\t\tunsigned int size, int rc)\n{\n\tceph_update_metrics(&m->metric[METRIC_COPYFROM],\n\t\t\t    r_start, r_end, size, rc);\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}