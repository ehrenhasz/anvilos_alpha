{
  "module_name": "io.c",
  "hash_id": "9533df47d6081e82e83d61bd052117d5511e7e0bd5d6423eb3da04a0dc8531c8",
  "original_prompt": "Ingested from linux-6.6.14/fs/ceph/io.c",
  "human_readable_source": "\n \n\n#include <linux/ceph/ceph_debug.h>\n\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/rwsem.h>\n#include <linux/fs.h>\n\n#include \"super.h\"\n#include \"io.h\"\n\n \nstatic void ceph_block_o_direct(struct ceph_inode_info *ci, struct inode *inode)\n{\n\tlockdep_assert_held_write(&inode->i_rwsem);\n\n\tif (READ_ONCE(ci->i_ceph_flags) & CEPH_I_ODIRECT) {\n\t\tspin_lock(&ci->i_ceph_lock);\n\t\tci->i_ceph_flags &= ~CEPH_I_ODIRECT;\n\t\tspin_unlock(&ci->i_ceph_lock);\n\t\tinode_dio_wait(inode);\n\t}\n}\n\n \nvoid\nceph_start_io_read(struct inode *inode)\n{\n\tstruct ceph_inode_info *ci = ceph_inode(inode);\n\n\t \n\tdown_read(&inode->i_rwsem);\n\tif (!(READ_ONCE(ci->i_ceph_flags) & CEPH_I_ODIRECT))\n\t\treturn;\n\tup_read(&inode->i_rwsem);\n\t \n\tdown_write(&inode->i_rwsem);\n\tceph_block_o_direct(ci, inode);\n\tdowngrade_write(&inode->i_rwsem);\n}\n\n \nvoid\nceph_end_io_read(struct inode *inode)\n{\n\tup_read(&inode->i_rwsem);\n}\n\n \nvoid\nceph_start_io_write(struct inode *inode)\n{\n\tdown_write(&inode->i_rwsem);\n\tceph_block_o_direct(ceph_inode(inode), inode);\n}\n\n \nvoid\nceph_end_io_write(struct inode *inode)\n{\n\tup_write(&inode->i_rwsem);\n}\n\n \nstatic void ceph_block_buffered(struct ceph_inode_info *ci, struct inode *inode)\n{\n\tlockdep_assert_held_write(&inode->i_rwsem);\n\n\tif (!(READ_ONCE(ci->i_ceph_flags) & CEPH_I_ODIRECT)) {\n\t\tspin_lock(&ci->i_ceph_lock);\n\t\tci->i_ceph_flags |= CEPH_I_ODIRECT;\n\t\tspin_unlock(&ci->i_ceph_lock);\n\t\t \n\t\tfilemap_write_and_wait(inode->i_mapping);\n\t}\n}\n\n \nvoid\nceph_start_io_direct(struct inode *inode)\n{\n\tstruct ceph_inode_info *ci = ceph_inode(inode);\n\n\t \n\tdown_read(&inode->i_rwsem);\n\tif (READ_ONCE(ci->i_ceph_flags) & CEPH_I_ODIRECT)\n\t\treturn;\n\tup_read(&inode->i_rwsem);\n\t \n\tdown_write(&inode->i_rwsem);\n\tceph_block_buffered(ci, inode);\n\tdowngrade_write(&inode->i_rwsem);\n}\n\n \nvoid\nceph_end_io_direct(struct inode *inode)\n{\n\tup_read(&inode->i_rwsem);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}