{
  "module_name": "compress.c",
  "hash_id": "b45c0a4ca09ff67fc10dea4fbb7b7c4d14d625ff14ed89005bd52f70f54b527f",
  "original_prompt": "Ingested from linux-6.6.14/fs/ubifs/compress.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/crypto.h>\n#include \"ubifs.h\"\n\n \nstatic struct ubifs_compressor none_compr = {\n\t.compr_type = UBIFS_COMPR_NONE,\n\t.name = \"none\",\n\t.capi_name = \"\",\n};\n\n#ifdef CONFIG_UBIFS_FS_LZO\nstatic DEFINE_MUTEX(lzo_mutex);\n\nstatic struct ubifs_compressor lzo_compr = {\n\t.compr_type = UBIFS_COMPR_LZO,\n\t.comp_mutex = &lzo_mutex,\n\t.name = \"lzo\",\n\t.capi_name = \"lzo\",\n};\n#else\nstatic struct ubifs_compressor lzo_compr = {\n\t.compr_type = UBIFS_COMPR_LZO,\n\t.name = \"lzo\",\n};\n#endif\n\n#ifdef CONFIG_UBIFS_FS_ZLIB\nstatic DEFINE_MUTEX(deflate_mutex);\nstatic DEFINE_MUTEX(inflate_mutex);\n\nstatic struct ubifs_compressor zlib_compr = {\n\t.compr_type = UBIFS_COMPR_ZLIB,\n\t.comp_mutex = &deflate_mutex,\n\t.decomp_mutex = &inflate_mutex,\n\t.name = \"zlib\",\n\t.capi_name = \"deflate\",\n};\n#else\nstatic struct ubifs_compressor zlib_compr = {\n\t.compr_type = UBIFS_COMPR_ZLIB,\n\t.name = \"zlib\",\n};\n#endif\n\n#ifdef CONFIG_UBIFS_FS_ZSTD\nstatic DEFINE_MUTEX(zstd_enc_mutex);\nstatic DEFINE_MUTEX(zstd_dec_mutex);\n\nstatic struct ubifs_compressor zstd_compr = {\n\t.compr_type = UBIFS_COMPR_ZSTD,\n\t.comp_mutex = &zstd_enc_mutex,\n\t.decomp_mutex = &zstd_dec_mutex,\n\t.name = \"zstd\",\n\t.capi_name = \"zstd\",\n};\n#else\nstatic struct ubifs_compressor zstd_compr = {\n\t.compr_type = UBIFS_COMPR_ZSTD,\n\t.name = \"zstd\",\n};\n#endif\n\n \nstruct ubifs_compressor *ubifs_compressors[UBIFS_COMPR_TYPES_CNT];\n\n \nvoid ubifs_compress(const struct ubifs_info *c, const void *in_buf,\n\t\t    int in_len, void *out_buf, int *out_len, int *compr_type)\n{\n\tint err;\n\tstruct ubifs_compressor *compr = ubifs_compressors[*compr_type];\n\n\tif (*compr_type == UBIFS_COMPR_NONE)\n\t\tgoto no_compr;\n\n\t \n\tif (in_len < UBIFS_MIN_COMPR_LEN)\n\t\tgoto no_compr;\n\n\tif (compr->comp_mutex)\n\t\tmutex_lock(compr->comp_mutex);\n\terr = crypto_comp_compress(compr->cc, in_buf, in_len, out_buf,\n\t\t\t\t   (unsigned int *)out_len);\n\tif (compr->comp_mutex)\n\t\tmutex_unlock(compr->comp_mutex);\n\tif (unlikely(err)) {\n\t\tubifs_warn(c, \"cannot compress %d bytes, compressor %s, error %d, leave data uncompressed\",\n\t\t\t   in_len, compr->name, err);\n\t\tgoto no_compr;\n\t}\n\n\t \n\tif (in_len - *out_len < UBIFS_MIN_COMPRESS_DIFF)\n\t\tgoto no_compr;\n\n\treturn;\n\nno_compr:\n\tmemcpy(out_buf, in_buf, in_len);\n\t*out_len = in_len;\n\t*compr_type = UBIFS_COMPR_NONE;\n}\n\n \nint ubifs_decompress(const struct ubifs_info *c, const void *in_buf,\n\t\t     int in_len, void *out_buf, int *out_len, int compr_type)\n{\n\tint err;\n\tstruct ubifs_compressor *compr;\n\n\tif (unlikely(compr_type < 0 || compr_type >= UBIFS_COMPR_TYPES_CNT)) {\n\t\tubifs_err(c, \"invalid compression type %d\", compr_type);\n\t\treturn -EINVAL;\n\t}\n\n\tcompr = ubifs_compressors[compr_type];\n\n\tif (unlikely(!compr->capi_name)) {\n\t\tubifs_err(c, \"%s compression is not compiled in\", compr->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (compr_type == UBIFS_COMPR_NONE) {\n\t\tmemcpy(out_buf, in_buf, in_len);\n\t\t*out_len = in_len;\n\t\treturn 0;\n\t}\n\n\tif (compr->decomp_mutex)\n\t\tmutex_lock(compr->decomp_mutex);\n\terr = crypto_comp_decompress(compr->cc, in_buf, in_len, out_buf,\n\t\t\t\t     (unsigned int *)out_len);\n\tif (compr->decomp_mutex)\n\t\tmutex_unlock(compr->decomp_mutex);\n\tif (err)\n\t\tubifs_err(c, \"cannot decompress %d bytes, compressor %s, error %d\",\n\t\t\t  in_len, compr->name, err);\n\n\treturn err;\n}\n\n \nstatic int __init compr_init(struct ubifs_compressor *compr)\n{\n\tif (compr->capi_name) {\n\t\tcompr->cc = crypto_alloc_comp(compr->capi_name, 0, 0);\n\t\tif (IS_ERR(compr->cc)) {\n\t\t\tpr_err(\"UBIFS error (pid %d): cannot initialize compressor %s, error %ld\",\n\t\t\t       current->pid, compr->name, PTR_ERR(compr->cc));\n\t\t\treturn PTR_ERR(compr->cc);\n\t\t}\n\t}\n\n\tubifs_compressors[compr->compr_type] = compr;\n\treturn 0;\n}\n\n \nstatic void compr_exit(struct ubifs_compressor *compr)\n{\n\tif (compr->capi_name)\n\t\tcrypto_free_comp(compr->cc);\n}\n\n \nint __init ubifs_compressors_init(void)\n{\n\tint err;\n\n\terr = compr_init(&lzo_compr);\n\tif (err)\n\t\treturn err;\n\n\terr = compr_init(&zstd_compr);\n\tif (err)\n\t\tgoto out_lzo;\n\n\terr = compr_init(&zlib_compr);\n\tif (err)\n\t\tgoto out_zstd;\n\n\tubifs_compressors[UBIFS_COMPR_NONE] = &none_compr;\n\treturn 0;\n\nout_zstd:\n\tcompr_exit(&zstd_compr);\nout_lzo:\n\tcompr_exit(&lzo_compr);\n\treturn err;\n}\n\n \nvoid ubifs_compressors_exit(void)\n{\n\tcompr_exit(&lzo_compr);\n\tcompr_exit(&zlib_compr);\n\tcompr_exit(&zstd_compr);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}