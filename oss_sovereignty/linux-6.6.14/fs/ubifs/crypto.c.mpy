{
  "module_name": "crypto.c",
  "hash_id": "724a8265cc0da77096b881430e44f78a796fe3a971802f7986fcd2e909bb609f",
  "original_prompt": "Ingested from linux-6.6.14/fs/ubifs/crypto.c",
  "human_readable_source": "\n#include \"ubifs.h\"\n\nstatic int ubifs_crypt_get_context(struct inode *inode, void *ctx, size_t len)\n{\n\treturn ubifs_xattr_get(inode, UBIFS_XATTR_NAME_ENCRYPTION_CONTEXT,\n\t\t\t       ctx, len);\n}\n\nstatic int ubifs_crypt_set_context(struct inode *inode, const void *ctx,\n\t\t\t\t   size_t len, void *fs_data)\n{\n\t \n\treturn ubifs_xattr_set(inode, UBIFS_XATTR_NAME_ENCRYPTION_CONTEXT,\n\t\t\t       ctx, len, 0, false);\n}\n\nstatic bool ubifs_crypt_empty_dir(struct inode *inode)\n{\n\treturn ubifs_check_dir_empty(inode) == 0;\n}\n\n \nint ubifs_encrypt(const struct inode *inode, struct ubifs_data_node *dn,\n\t\t  unsigned int in_len, unsigned int *out_len, int block)\n{\n\tstruct ubifs_info *c = inode->i_sb->s_fs_info;\n\tvoid *p = &dn->data;\n\tunsigned int pad_len = round_up(in_len, UBIFS_CIPHER_BLOCK_SIZE);\n\tint err;\n\n\tubifs_assert(c, pad_len <= *out_len);\n\tdn->compr_size = cpu_to_le16(in_len);\n\n\t \n\tif (pad_len != in_len)\n\t\tmemset(p + in_len, 0, pad_len - in_len);\n\n\terr = fscrypt_encrypt_block_inplace(inode, virt_to_page(p), pad_len,\n\t\t\t\t\t    offset_in_page(p), block, GFP_NOFS);\n\tif (err) {\n\t\tubifs_err(c, \"fscrypt_encrypt_block_inplace() failed: %d\", err);\n\t\treturn err;\n\t}\n\t*out_len = pad_len;\n\n\treturn 0;\n}\n\nint ubifs_decrypt(const struct inode *inode, struct ubifs_data_node *dn,\n\t\t  unsigned int *out_len, int block)\n{\n\tstruct ubifs_info *c = inode->i_sb->s_fs_info;\n\tint err;\n\tunsigned int clen = le16_to_cpu(dn->compr_size);\n\tunsigned int dlen = *out_len;\n\n\tif (clen <= 0 || clen > UBIFS_BLOCK_SIZE || clen > dlen) {\n\t\tubifs_err(c, \"bad compr_size: %i\", clen);\n\t\treturn -EINVAL;\n\t}\n\n\tubifs_assert(c, dlen <= UBIFS_BLOCK_SIZE);\n\terr = fscrypt_decrypt_block_inplace(inode, virt_to_page(&dn->data),\n\t\t\t\t\t    dlen, offset_in_page(&dn->data),\n\t\t\t\t\t    block);\n\tif (err) {\n\t\tubifs_err(c, \"fscrypt_decrypt_block_inplace() failed: %d\", err);\n\t\treturn err;\n\t}\n\t*out_len = clen;\n\n\treturn 0;\n}\n\nconst struct fscrypt_operations ubifs_crypt_operations = {\n\t.flags\t\t\t= FS_CFLG_OWN_PAGES,\n\t.key_prefix\t\t= \"ubifs:\",\n\t.get_context\t\t= ubifs_crypt_get_context,\n\t.set_context\t\t= ubifs_crypt_set_context,\n\t.empty_dir\t\t= ubifs_crypt_empty_dir,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}