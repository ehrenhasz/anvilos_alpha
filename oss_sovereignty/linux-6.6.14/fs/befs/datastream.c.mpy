{
  "module_name": "datastream.c",
  "hash_id": "565ad105099ee25878bdedd1c82146e15033fe96eefa2b9f2d536fcabdd5c202",
  "original_prompt": "Ingested from linux-6.6.14/fs/befs/datastream.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/buffer_head.h>\n#include <linux/string.h>\n\n#include \"befs.h\"\n#include \"datastream.h\"\n#include \"io.h\"\n\nconst befs_inode_addr BAD_IADDR = { 0, 0, 0 };\n\nstatic int befs_find_brun_direct(struct super_block *sb,\n\t\t\t\t const befs_data_stream *data,\n\t\t\t\t befs_blocknr_t blockno, befs_block_run *run);\n\nstatic int befs_find_brun_indirect(struct super_block *sb,\n\t\t\t\t   const befs_data_stream *data,\n\t\t\t\t   befs_blocknr_t blockno,\n\t\t\t\t   befs_block_run *run);\n\nstatic int befs_find_brun_dblindirect(struct super_block *sb,\n\t\t\t\t      const befs_data_stream *data,\n\t\t\t\t      befs_blocknr_t blockno,\n\t\t\t\t      befs_block_run *run);\n\n \nstruct buffer_head *\nbefs_read_datastream(struct super_block *sb, const befs_data_stream *ds,\n\t\t     befs_off_t pos, uint *off)\n{\n\tstruct buffer_head *bh;\n\tbefs_block_run run;\n\tbefs_blocknr_t block;\t \n\n\tbefs_debug(sb, \"---> %s %llu\", __func__, pos);\n\tblock = pos >> BEFS_SB(sb)->block_shift;\n\tif (off)\n\t\t*off = pos - (block << BEFS_SB(sb)->block_shift);\n\n\tif (befs_fblock2brun(sb, ds, block, &run) != BEFS_OK) {\n\t\tbefs_error(sb, \"BeFS: Error finding disk addr of block %lu\",\n\t\t\t   (unsigned long)block);\n\t\tbefs_debug(sb, \"<--- %s ERROR\", __func__);\n\t\treturn NULL;\n\t}\n\tbh = befs_bread_iaddr(sb, run);\n\tif (!bh) {\n\t\tbefs_error(sb, \"BeFS: Error reading block %lu from datastream\",\n\t\t\t   (unsigned long)block);\n\t\treturn NULL;\n\t}\n\n\tbefs_debug(sb, \"<--- %s read data, starting at %llu\", __func__, pos);\n\n\treturn bh;\n}\n\n \nint\nbefs_fblock2brun(struct super_block *sb, const befs_data_stream *data,\n\t\t befs_blocknr_t fblock, befs_block_run *run)\n{\n\tint err;\n\tbefs_off_t pos = fblock << BEFS_SB(sb)->block_shift;\n\n\tif (pos < data->max_direct_range) {\n\t\terr = befs_find_brun_direct(sb, data, fblock, run);\n\n\t} else if (pos < data->max_indirect_range) {\n\t\terr = befs_find_brun_indirect(sb, data, fblock, run);\n\n\t} else if (pos < data->max_double_indirect_range) {\n\t\terr = befs_find_brun_dblindirect(sb, data, fblock, run);\n\n\t} else {\n\t\tbefs_error(sb,\n\t\t\t   \"befs_fblock2brun() was asked to find block %lu, \"\n\t\t\t   \"which is not mapped by the datastream\\n\",\n\t\t\t   (unsigned long)fblock);\n\t\terr = BEFS_ERR;\n\t}\n\treturn err;\n}\n\n \nsize_t\nbefs_read_lsymlink(struct super_block *sb, const befs_data_stream *ds,\n\t\t   void *buff, befs_off_t len)\n{\n\tbefs_off_t bytes_read = 0;\t \n\tu16 plen;\n\tstruct buffer_head *bh;\n\n\tbefs_debug(sb, \"---> %s length: %llu\", __func__, len);\n\n\twhile (bytes_read < len) {\n\t\tbh = befs_read_datastream(sb, ds, bytes_read, NULL);\n\t\tif (!bh) {\n\t\t\tbefs_error(sb, \"BeFS: Error reading datastream block \"\n\t\t\t\t   \"starting from %llu\", bytes_read);\n\t\t\tbefs_debug(sb, \"<--- %s ERROR\", __func__);\n\t\t\treturn bytes_read;\n\n\t\t}\n\t\tplen = ((bytes_read + BEFS_SB(sb)->block_size) < len) ?\n\t\t    BEFS_SB(sb)->block_size : len - bytes_read;\n\t\tmemcpy(buff + bytes_read, bh->b_data, plen);\n\t\tbrelse(bh);\n\t\tbytes_read += plen;\n\t}\n\n\tbefs_debug(sb, \"<--- %s read %u bytes\", __func__, (unsigned int)\n\t\t   bytes_read);\n\treturn bytes_read;\n}\n\n \n\nbefs_blocknr_t\nbefs_count_blocks(struct super_block *sb, const befs_data_stream *ds)\n{\n\tbefs_blocknr_t blocks;\n\tbefs_blocknr_t datablocks;\t \n\tbefs_blocknr_t metablocks;\t \n\tstruct befs_sb_info *befs_sb = BEFS_SB(sb);\n\n\tbefs_debug(sb, \"---> %s\", __func__);\n\n\tdatablocks = ds->size >> befs_sb->block_shift;\n\tif (ds->size & (befs_sb->block_size - 1))\n\t\tdatablocks += 1;\n\n\tmetablocks = 1;\t\t \n\n\t \n\tif (ds->size > ds->max_direct_range)\n\t\tmetablocks += ds->indirect.len;\n\n\t \n\tif (ds->size > ds->max_indirect_range && ds->max_indirect_range != 0) {\n\t\tuint dbl_bytes;\n\t\tuint dbl_bruns;\n\t\tuint indirblocks;\n\n\t\tdbl_bytes =\n\t\t    ds->max_double_indirect_range - ds->max_indirect_range;\n\t\tdbl_bruns =\n\t\t    dbl_bytes / (befs_sb->block_size * BEFS_DBLINDIR_BRUN_LEN);\n\t\tindirblocks = dbl_bruns / befs_iaddrs_per_block(sb);\n\n\t\tmetablocks += ds->double_indirect.len;\n\t\tmetablocks += indirblocks;\n\t}\n\n\tblocks = datablocks + metablocks;\n\tbefs_debug(sb, \"<--- %s %u blocks\", __func__, (unsigned int)blocks);\n\n\treturn blocks;\n}\n\n \nstatic int\nbefs_find_brun_direct(struct super_block *sb, const befs_data_stream *data,\n\t\t      befs_blocknr_t blockno, befs_block_run *run)\n{\n\tint i;\n\tconst befs_block_run *array = data->direct;\n\tbefs_blocknr_t sum;\n\n\tbefs_debug(sb, \"---> %s, find %lu\", __func__, (unsigned long)blockno);\n\n\tfor (i = 0, sum = 0; i < BEFS_NUM_DIRECT_BLOCKS;\n\t     sum += array[i].len, i++) {\n\t\tif (blockno >= sum && blockno < sum + (array[i].len)) {\n\t\t\tint offset = blockno - sum;\n\n\t\t\trun->allocation_group = array[i].allocation_group;\n\t\t\trun->start = array[i].start + offset;\n\t\t\trun->len = array[i].len - offset;\n\n\t\t\tbefs_debug(sb, \"---> %s, \"\n\t\t\t\t   \"found %lu at direct[%d]\", __func__,\n\t\t\t\t   (unsigned long)blockno, i);\n\t\t\treturn BEFS_OK;\n\t\t}\n\t}\n\n\tbefs_error(sb, \"%s failed to find file block %lu\", __func__,\n\t\t   (unsigned long)blockno);\n\tbefs_debug(sb, \"---> %s ERROR\", __func__);\n\treturn BEFS_ERR;\n}\n\n \nstatic int\nbefs_find_brun_indirect(struct super_block *sb,\n\t\t\tconst befs_data_stream *data,\n\t\t\tbefs_blocknr_t blockno,\n\t\t\tbefs_block_run *run)\n{\n\tint i, j;\n\tbefs_blocknr_t sum = 0;\n\tbefs_blocknr_t indir_start_blk;\n\tbefs_blocknr_t search_blk;\n\tstruct buffer_head *indirblock;\n\tbefs_disk_block_run *array;\n\n\tbefs_block_run indirect = data->indirect;\n\tbefs_blocknr_t indirblockno = iaddr2blockno(sb, &indirect);\n\tint arraylen = befs_iaddrs_per_block(sb);\n\n\tbefs_debug(sb, \"---> %s, find %lu\", __func__, (unsigned long)blockno);\n\n\tindir_start_blk = data->max_direct_range >> BEFS_SB(sb)->block_shift;\n\tsearch_blk = blockno - indir_start_blk;\n\n\t \n\tfor (i = 0; i < indirect.len; i++) {\n\t\tindirblock = sb_bread(sb, indirblockno + i);\n\t\tif (indirblock == NULL) {\n\t\t\tbefs_error(sb, \"---> %s failed to read \"\n\t\t\t\t   \"disk block %lu from the indirect brun\",\n\t\t\t\t   __func__, (unsigned long)indirblockno + i);\n\t\t\tbefs_debug(sb, \"<--- %s ERROR\", __func__);\n\t\t\treturn BEFS_ERR;\n\t\t}\n\n\t\tarray = (befs_disk_block_run *) indirblock->b_data;\n\n\t\tfor (j = 0; j < arraylen; ++j) {\n\t\t\tint len = fs16_to_cpu(sb, array[j].len);\n\n\t\t\tif (search_blk >= sum && search_blk < sum + len) {\n\t\t\t\tint offset = search_blk - sum;\n\t\t\t\trun->allocation_group =\n\t\t\t\t    fs32_to_cpu(sb, array[j].allocation_group);\n\t\t\t\trun->start =\n\t\t\t\t    fs16_to_cpu(sb, array[j].start) + offset;\n\t\t\t\trun->len =\n\t\t\t\t    fs16_to_cpu(sb, array[j].len) - offset;\n\n\t\t\t\tbrelse(indirblock);\n\t\t\t\tbefs_debug(sb,\n\t\t\t\t\t   \"<--- %s found file block \"\n\t\t\t\t\t   \"%lu at indirect[%d]\", __func__,\n\t\t\t\t\t   (unsigned long)blockno,\n\t\t\t\t\t   j + (i * arraylen));\n\t\t\t\treturn BEFS_OK;\n\t\t\t}\n\t\t\tsum += len;\n\t\t}\n\n\t\tbrelse(indirblock);\n\t}\n\n\t \n\tbefs_error(sb, \"BeFS: %s failed to find \"\n\t\t   \"file block %lu\", __func__, (unsigned long)blockno);\n\n\tbefs_debug(sb, \"<--- %s ERROR\", __func__);\n\treturn BEFS_ERR;\n}\n\n \nstatic int\nbefs_find_brun_dblindirect(struct super_block *sb,\n\t\t\t   const befs_data_stream *data,\n\t\t\t   befs_blocknr_t blockno,\n\t\t\t   befs_block_run *run)\n{\n\tint dblindir_indx;\n\tint indir_indx;\n\tint offset;\n\tint dbl_which_block;\n\tint which_block;\n\tint dbl_block_indx;\n\tint block_indx;\n\toff_t dblindir_leftover;\n\tbefs_blocknr_t blockno_at_run_start;\n\tstruct buffer_head *dbl_indir_block;\n\tstruct buffer_head *indir_block;\n\tbefs_block_run indir_run;\n\tbefs_disk_inode_addr *iaddr_array;\n\n\tbefs_blocknr_t indir_start_blk =\n\t    data->max_indirect_range >> BEFS_SB(sb)->block_shift;\n\n\toff_t dbl_indir_off = blockno - indir_start_blk;\n\n\t \n\tsize_t iblklen = BEFS_DBLINDIR_BRUN_LEN;\n\n\t \n\tsize_t diblklen = iblklen * befs_iaddrs_per_block(sb)\n\t    * BEFS_DBLINDIR_BRUN_LEN;\n\n\tbefs_debug(sb, \"---> %s find %lu\", __func__, (unsigned long)blockno);\n\n\t \n\n\tdblindir_indx = dbl_indir_off / diblklen;\n\tdblindir_leftover = dbl_indir_off % diblklen;\n\tindir_indx = dblindir_leftover / diblklen;\n\n\t \n\tdbl_which_block = dblindir_indx / befs_iaddrs_per_block(sb);\n\tif (dbl_which_block > data->double_indirect.len) {\n\t\tbefs_error(sb, \"The double-indirect index calculated by \"\n\t\t\t   \"%s, %d, is outside the range \"\n\t\t\t   \"of the double-indirect block\", __func__,\n\t\t\t   dblindir_indx);\n\t\treturn BEFS_ERR;\n\t}\n\n\tdbl_indir_block =\n\t    sb_bread(sb, iaddr2blockno(sb, &data->double_indirect) +\n\t\t\t\t\tdbl_which_block);\n\tif (dbl_indir_block == NULL) {\n\t\tbefs_error(sb, \"%s couldn't read the \"\n\t\t\t   \"double-indirect block at blockno %lu\", __func__,\n\t\t\t   (unsigned long)\n\t\t\t   iaddr2blockno(sb, &data->double_indirect) +\n\t\t\t   dbl_which_block);\n\t\treturn BEFS_ERR;\n\t}\n\n\tdbl_block_indx =\n\t    dblindir_indx - (dbl_which_block * befs_iaddrs_per_block(sb));\n\tiaddr_array = (befs_disk_inode_addr *) dbl_indir_block->b_data;\n\tindir_run = fsrun_to_cpu(sb, iaddr_array[dbl_block_indx]);\n\tbrelse(dbl_indir_block);\n\n\t \n\twhich_block = indir_indx / befs_iaddrs_per_block(sb);\n\tif (which_block > indir_run.len) {\n\t\tbefs_error(sb, \"The indirect index calculated by \"\n\t\t\t   \"%s, %d, is outside the range \"\n\t\t\t   \"of the indirect block\", __func__, indir_indx);\n\t\treturn BEFS_ERR;\n\t}\n\n\tindir_block =\n\t    sb_bread(sb, iaddr2blockno(sb, &indir_run) + which_block);\n\tif (indir_block == NULL) {\n\t\tbefs_error(sb, \"%s couldn't read the indirect block \"\n\t\t\t   \"at blockno %lu\", __func__, (unsigned long)\n\t\t\t   iaddr2blockno(sb, &indir_run) + which_block);\n\t\treturn BEFS_ERR;\n\t}\n\n\tblock_indx = indir_indx - (which_block * befs_iaddrs_per_block(sb));\n\tiaddr_array = (befs_disk_inode_addr *) indir_block->b_data;\n\t*run = fsrun_to_cpu(sb, iaddr_array[block_indx]);\n\tbrelse(indir_block);\n\n\tblockno_at_run_start = indir_start_blk;\n\tblockno_at_run_start += diblklen * dblindir_indx;\n\tblockno_at_run_start += iblklen * indir_indx;\n\toffset = blockno - blockno_at_run_start;\n\n\trun->start += offset;\n\trun->len -= offset;\n\n\tbefs_debug(sb, \"Found file block %lu in double_indirect[%d][%d],\"\n\t\t   \" double_indirect_leftover = %lu\", (unsigned long)\n\t\t   blockno, dblindir_indx, indir_indx, dblindir_leftover);\n\n\treturn BEFS_OK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}