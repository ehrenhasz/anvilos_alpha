{
  "module_name": "read_metadata.c",
  "hash_id": "94abf2e5342dfd018013292dc77db739c0a830ed60a596064f93649c16a6c6e8",
  "original_prompt": "Ingested from linux-6.6.14/fs/verity/read_metadata.c",
  "human_readable_source": "\n \n\n#include \"fsverity_private.h\"\n\n#include <linux/backing-dev.h>\n#include <linux/highmem.h>\n#include <linux/sched/signal.h>\n#include <linux/uaccess.h>\n\nstatic int fsverity_read_merkle_tree(struct inode *inode,\n\t\t\t\t     const struct fsverity_info *vi,\n\t\t\t\t     void __user *buf, u64 offset, int length)\n{\n\tconst struct fsverity_operations *vops = inode->i_sb->s_vop;\n\tu64 end_offset;\n\tunsigned int offs_in_page;\n\tpgoff_t index, last_index;\n\tint retval = 0;\n\tint err = 0;\n\n\tend_offset = min(offset + length, vi->tree_params.tree_size);\n\tif (offset >= end_offset)\n\t\treturn 0;\n\toffs_in_page = offset_in_page(offset);\n\tlast_index = (end_offset - 1) >> PAGE_SHIFT;\n\n\t \n\tfor (index = offset >> PAGE_SHIFT; index <= last_index; index++) {\n\t\tunsigned long num_ra_pages =\n\t\t\tmin_t(unsigned long, last_index - index + 1,\n\t\t\t      inode->i_sb->s_bdi->io_pages);\n\t\tunsigned int bytes_to_copy = min_t(u64, end_offset - offset,\n\t\t\t\t\t\t   PAGE_SIZE - offs_in_page);\n\t\tstruct page *page;\n\t\tconst void *virt;\n\n\t\tpage = vops->read_merkle_tree_page(inode, index, num_ra_pages);\n\t\tif (IS_ERR(page)) {\n\t\t\terr = PTR_ERR(page);\n\t\t\tfsverity_err(inode,\n\t\t\t\t     \"Error %d reading Merkle tree page %lu\",\n\t\t\t\t     err, index);\n\t\t\tbreak;\n\t\t}\n\n\t\tvirt = kmap_local_page(page);\n\t\tif (copy_to_user(buf, virt + offs_in_page, bytes_to_copy)) {\n\t\t\tkunmap_local(virt);\n\t\t\tput_page(page);\n\t\t\terr = -EFAULT;\n\t\t\tbreak;\n\t\t}\n\t\tkunmap_local(virt);\n\t\tput_page(page);\n\n\t\tretval += bytes_to_copy;\n\t\tbuf += bytes_to_copy;\n\t\toffset += bytes_to_copy;\n\n\t\tif (fatal_signal_pending(current))  {\n\t\t\terr = -EINTR;\n\t\t\tbreak;\n\t\t}\n\t\tcond_resched();\n\t\toffs_in_page = 0;\n\t}\n\treturn retval ? retval : err;\n}\n\n \nstatic int fsverity_read_buffer(void __user *dst, u64 offset, int length,\n\t\t\t\tconst void *src, size_t src_length)\n{\n\tif (offset >= src_length)\n\t\treturn 0;\n\tsrc += offset;\n\tsrc_length -= offset;\n\n\tlength = min_t(size_t, length, src_length);\n\n\tif (copy_to_user(dst, src, length))\n\t\treturn -EFAULT;\n\n\treturn length;\n}\n\nstatic int fsverity_read_descriptor(struct inode *inode,\n\t\t\t\t    void __user *buf, u64 offset, int length)\n{\n\tstruct fsverity_descriptor *desc;\n\tsize_t desc_size;\n\tint res;\n\n\tres = fsverity_get_descriptor(inode, &desc);\n\tif (res)\n\t\treturn res;\n\n\t \n\tdesc_size = offsetof(struct fsverity_descriptor, signature);\n\tdesc->sig_size = 0;\n\n\tres = fsverity_read_buffer(buf, offset, length, desc, desc_size);\n\n\tkfree(desc);\n\treturn res;\n}\n\nstatic int fsverity_read_signature(struct inode *inode,\n\t\t\t\t   void __user *buf, u64 offset, int length)\n{\n\tstruct fsverity_descriptor *desc;\n\tint res;\n\n\tres = fsverity_get_descriptor(inode, &desc);\n\tif (res)\n\t\treturn res;\n\n\tif (desc->sig_size == 0) {\n\t\tres = -ENODATA;\n\t\tgoto out;\n\t}\n\n\t \n\tres = fsverity_read_buffer(buf, offset, length, desc->signature,\n\t\t\t\t   le32_to_cpu(desc->sig_size));\nout:\n\tkfree(desc);\n\treturn res;\n}\n\n \nint fsverity_ioctl_read_metadata(struct file *filp, const void __user *uarg)\n{\n\tstruct inode *inode = file_inode(filp);\n\tconst struct fsverity_info *vi;\n\tstruct fsverity_read_metadata_arg arg;\n\tint length;\n\tvoid __user *buf;\n\n\tvi = fsverity_get_info(inode);\n\tif (!vi)\n\t\treturn -ENODATA;  \n\t \n\n\tif (copy_from_user(&arg, uarg, sizeof(arg)))\n\t\treturn -EFAULT;\n\n\tif (arg.__reserved)\n\t\treturn -EINVAL;\n\n\t \n\tif (arg.offset + arg.length < arg.offset)\n\t\treturn -EINVAL;\n\n\t \n\tlength = min_t(u64, arg.length, INT_MAX);\n\n\tbuf = u64_to_user_ptr(arg.buf_ptr);\n\n\tswitch (arg.metadata_type) {\n\tcase FS_VERITY_METADATA_TYPE_MERKLE_TREE:\n\t\treturn fsverity_read_merkle_tree(inode, vi, buf, arg.offset,\n\t\t\t\t\t\t length);\n\tcase FS_VERITY_METADATA_TYPE_DESCRIPTOR:\n\t\treturn fsverity_read_descriptor(inode, buf, arg.offset, length);\n\tcase FS_VERITY_METADATA_TYPE_SIGNATURE:\n\t\treturn fsverity_read_signature(inode, buf, arg.offset, length);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\nEXPORT_SYMBOL_GPL(fsverity_ioctl_read_metadata);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}