{
  "module_name": "signature.c",
  "hash_id": "6463c0e593267236e0520cc183c1e5151abe2791074b60550d71baa97adee15d",
  "original_prompt": "Ingested from linux-6.6.14/fs/verity/signature.c",
  "human_readable_source": "\n \n\n \n\n#include \"fsverity_private.h\"\n\n#include <linux/cred.h>\n#include <linux/key.h>\n#include <linux/slab.h>\n#include <linux/verification.h>\n\n \nint fsverity_require_signatures;\n\n \nstatic struct key *fsverity_keyring;\n\n \nint fsverity_verify_signature(const struct fsverity_info *vi,\n\t\t\t      const u8 *signature, size_t sig_size)\n{\n\tconst struct inode *inode = vi->inode;\n\tconst struct fsverity_hash_alg *hash_alg = vi->tree_params.hash_alg;\n\tstruct fsverity_formatted_digest *d;\n\tint err;\n\n\tif (sig_size == 0) {\n\t\tif (fsverity_require_signatures) {\n\t\t\tfsverity_err(inode,\n\t\t\t\t     \"require_signatures=1, rejecting unsigned file!\");\n\t\t\treturn -EPERM;\n\t\t}\n\t\treturn 0;\n\t}\n\n\tif (fsverity_keyring->keys.nr_leaves_on_tree == 0) {\n\t\t \n\t\tfsverity_err(inode,\n\t\t\t     \"fs-verity keyring is empty, rejecting signed file!\");\n\t\treturn -ENOKEY;\n\t}\n\n\td = kzalloc(sizeof(*d) + hash_alg->digest_size, GFP_KERNEL);\n\tif (!d)\n\t\treturn -ENOMEM;\n\tmemcpy(d->magic, \"FSVerity\", 8);\n\td->digest_algorithm = cpu_to_le16(hash_alg - fsverity_hash_algs);\n\td->digest_size = cpu_to_le16(hash_alg->digest_size);\n\tmemcpy(d->digest, vi->file_digest, hash_alg->digest_size);\n\n\terr = verify_pkcs7_signature(d, sizeof(*d) + hash_alg->digest_size,\n\t\t\t\t     signature, sig_size, fsverity_keyring,\n\t\t\t\t     VERIFYING_UNSPECIFIED_SIGNATURE,\n\t\t\t\t     NULL, NULL);\n\tkfree(d);\n\n\tif (err) {\n\t\tif (err == -ENOKEY)\n\t\t\tfsverity_err(inode,\n\t\t\t\t     \"File's signing cert isn't in the fs-verity keyring\");\n\t\telse if (err == -EKEYREJECTED)\n\t\t\tfsverity_err(inode, \"Incorrect file signature\");\n\t\telse if (err == -EBADMSG)\n\t\t\tfsverity_err(inode, \"Malformed file signature\");\n\t\telse\n\t\t\tfsverity_err(inode, \"Error %d verifying file signature\",\n\t\t\t\t     err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nvoid __init fsverity_init_signature(void)\n{\n\tfsverity_keyring =\n\t\tkeyring_alloc(\".fs-verity\", KUIDT_INIT(0), KGIDT_INIT(0),\n\t\t\t      current_cred(), KEY_POS_SEARCH |\n\t\t\t\tKEY_USR_VIEW | KEY_USR_READ | KEY_USR_WRITE |\n\t\t\t\tKEY_USR_SEARCH | KEY_USR_SETATTR,\n\t\t\t      KEY_ALLOC_NOT_IN_QUOTA, NULL, NULL);\n\tif (IS_ERR(fsverity_keyring))\n\t\tpanic(\"failed to allocate \\\".fs-verity\\\" keyring\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}