{
  "module_name": "dir.c",
  "hash_id": "74cc1be51b9d8caee60b0ce17ccf8cb30d39b6d0b1cb1f03cc557951f5a2422e",
  "original_prompt": "Ingested from linux-6.6.14/fs/squashfs/dir.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/fs.h>\n#include <linux/vfs.h>\n#include <linux/slab.h>\n\n#include \"squashfs_fs.h\"\n#include \"squashfs_fs_sb.h\"\n#include \"squashfs_fs_i.h\"\n#include \"squashfs.h\"\n\nstatic const unsigned char squashfs_filetype_table[] = {\n\tDT_UNKNOWN, DT_DIR, DT_REG, DT_LNK, DT_BLK, DT_CHR, DT_FIFO, DT_SOCK\n};\n\n \nstatic int get_dir_index_using_offset(struct super_block *sb,\n\tu64 *next_block, int *next_offset, u64 index_start, int index_offset,\n\tint i_count, u64 f_pos)\n{\n\tstruct squashfs_sb_info *msblk = sb->s_fs_info;\n\tint err, i, index, length = 0;\n\tunsigned int size;\n\tstruct squashfs_dir_index dir_index;\n\n\tTRACE(\"Entered get_dir_index_using_offset, i_count %d, f_pos %lld\\n\",\n\t\t\t\t\ti_count, f_pos);\n\n\t \n\tif (f_pos <= 3)\n\t\treturn f_pos;\n\tf_pos -= 3;\n\n\tfor (i = 0; i < i_count; i++) {\n\t\terr = squashfs_read_metadata(sb, &dir_index, &index_start,\n\t\t\t\t&index_offset, sizeof(dir_index));\n\t\tif (err < 0)\n\t\t\tbreak;\n\n\t\tindex = le32_to_cpu(dir_index.index);\n\t\tif (index > f_pos)\n\t\t\t \n\t\t\tbreak;\n\n\t\tsize = le32_to_cpu(dir_index.size) + 1;\n\n\t\t \n\t\tif (size > SQUASHFS_NAME_LEN)\n\t\t\tbreak;\n\n\t\terr = squashfs_read_metadata(sb, NULL, &index_start,\n\t\t\t\t&index_offset, size);\n\t\tif (err < 0)\n\t\t\tbreak;\n\n\t\tlength = index;\n\t\t*next_block = le32_to_cpu(dir_index.start_block) +\n\t\t\t\t\tmsblk->directory_table;\n\t}\n\n\t*next_offset = (length + *next_offset) % SQUASHFS_METADATA_SIZE;\n\n\t \n\treturn length + 3;\n}\n\n\nstatic int squashfs_readdir(struct file *file, struct dir_context *ctx)\n{\n\tstruct inode *inode = file_inode(file);\n\tstruct squashfs_sb_info *msblk = inode->i_sb->s_fs_info;\n\tu64 block = squashfs_i(inode)->start + msblk->directory_table;\n\tint offset = squashfs_i(inode)->offset, length, err;\n\tunsigned int inode_number, dir_count, size, type;\n\tstruct squashfs_dir_header dirh;\n\tstruct squashfs_dir_entry *dire;\n\n\tTRACE(\"Entered squashfs_readdir [%llx:%x]\\n\", block, offset);\n\n\tdire = kmalloc(sizeof(*dire) + SQUASHFS_NAME_LEN + 1, GFP_KERNEL);\n\tif (dire == NULL) {\n\t\tERROR(\"Failed to allocate squashfs_dir_entry\\n\");\n\t\tgoto finish;\n\t}\n\n\t \n\twhile (ctx->pos < 3) {\n\t\tchar *name;\n\t\tint i_ino;\n\n\t\tif (ctx->pos == 0) {\n\t\t\tname = \".\";\n\t\t\tsize = 1;\n\t\t\ti_ino = inode->i_ino;\n\t\t} else {\n\t\t\tname = \"..\";\n\t\t\tsize = 2;\n\t\t\ti_ino = squashfs_i(inode)->parent;\n\t\t}\n\n\t\tif (!dir_emit(ctx, name, size, i_ino,\n\t\t\t\tsquashfs_filetype_table[1]))\n\t\t\tgoto finish;\n\n\t\tctx->pos += size;\n\t}\n\n\tlength = get_dir_index_using_offset(inode->i_sb, &block, &offset,\n\t\t\t\tsquashfs_i(inode)->dir_idx_start,\n\t\t\t\tsquashfs_i(inode)->dir_idx_offset,\n\t\t\t\tsquashfs_i(inode)->dir_idx_cnt,\n\t\t\t\tctx->pos);\n\n\twhile (length < i_size_read(inode)) {\n\t\t \n\t\terr = squashfs_read_metadata(inode->i_sb, &dirh, &block,\n\t\t\t\t\t&offset, sizeof(dirh));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tlength += sizeof(dirh);\n\n\t\tdir_count = le32_to_cpu(dirh.count) + 1;\n\n\t\tif (dir_count > SQUASHFS_DIR_COUNT)\n\t\t\tgoto failed_read;\n\n\t\twhile (dir_count--) {\n\t\t\t \n\t\t\terr = squashfs_read_metadata(inode->i_sb, dire, &block,\n\t\t\t\t\t&offset, sizeof(*dire));\n\t\t\tif (err < 0)\n\t\t\t\tgoto failed_read;\n\n\t\t\tsize = le16_to_cpu(dire->size) + 1;\n\n\t\t\t \n\t\t\tif (size > SQUASHFS_NAME_LEN)\n\t\t\t\tgoto failed_read;\n\n\t\t\terr = squashfs_read_metadata(inode->i_sb, dire->name,\n\t\t\t\t\t&block, &offset, size);\n\t\t\tif (err < 0)\n\t\t\t\tgoto failed_read;\n\n\t\t\tlength += sizeof(*dire) + size;\n\n\t\t\tif (ctx->pos >= length)\n\t\t\t\tcontinue;\n\n\t\t\tdire->name[size] = '\\0';\n\t\t\tinode_number = le32_to_cpu(dirh.inode_number) +\n\t\t\t\t((short) le16_to_cpu(dire->inode_number));\n\t\t\ttype = le16_to_cpu(dire->type);\n\n\t\t\tif (type > SQUASHFS_MAX_DIR_TYPE)\n\t\t\t\tgoto failed_read;\n\n\t\t\tif (!dir_emit(ctx, dire->name, size,\n\t\t\t\t\tinode_number,\n\t\t\t\t\tsquashfs_filetype_table[type]))\n\t\t\t\tgoto finish;\n\n\t\t\tctx->pos = length;\n\t\t}\n\t}\n\nfinish:\n\tkfree(dire);\n\treturn 0;\n\nfailed_read:\n\tERROR(\"Unable to read directory block [%llx:%x]\\n\", block, offset);\n\tkfree(dire);\n\treturn 0;\n}\n\n\nconst struct file_operations squashfs_dir_ops = {\n\t.read = generic_read_dir,\n\t.iterate_shared = squashfs_readdir,\n\t.llseek = generic_file_llseek,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}