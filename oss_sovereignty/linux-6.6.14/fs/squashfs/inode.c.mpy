{
  "module_name": "inode.c",
  "hash_id": "984c107c8701c61ea104ebb30bc05c2f72a56222ebe585f4263f91d777f6fba4",
  "original_prompt": "Ingested from linux-6.6.14/fs/squashfs/inode.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/fs.h>\n#include <linux/vfs.h>\n#include <linux/xattr.h>\n#include <linux/pagemap.h>\n\n#include \"squashfs_fs.h\"\n#include \"squashfs_fs_sb.h\"\n#include \"squashfs_fs_i.h\"\n#include \"squashfs.h\"\n#include \"xattr.h\"\n\n \nstatic int squashfs_new_inode(struct super_block *sb, struct inode *inode,\n\t\t\t\tstruct squashfs_base_inode *sqsh_ino)\n{\n\tuid_t i_uid;\n\tgid_t i_gid;\n\tint err;\n\n\terr = squashfs_get_id(sb, le16_to_cpu(sqsh_ino->uid), &i_uid);\n\tif (err)\n\t\treturn err;\n\n\terr = squashfs_get_id(sb, le16_to_cpu(sqsh_ino->guid), &i_gid);\n\tif (err)\n\t\treturn err;\n\n\ti_uid_write(inode, i_uid);\n\ti_gid_write(inode, i_gid);\n\tinode->i_ino = le32_to_cpu(sqsh_ino->inode_number);\n\tinode->i_mtime.tv_sec = le32_to_cpu(sqsh_ino->mtime);\n\tinode->i_atime.tv_sec = inode->i_mtime.tv_sec;\n\tinode_set_ctime(inode, inode->i_mtime.tv_sec, 0);\n\tinode->i_mode = le16_to_cpu(sqsh_ino->mode);\n\tinode->i_size = 0;\n\n\treturn err;\n}\n\n\nstruct inode *squashfs_iget(struct super_block *sb, long long ino,\n\t\t\t\tunsigned int ino_number)\n{\n\tstruct inode *inode = iget_locked(sb, ino_number);\n\tint err;\n\n\tTRACE(\"Entered squashfs_iget\\n\");\n\n\tif (!inode)\n\t\treturn ERR_PTR(-ENOMEM);\n\tif (!(inode->i_state & I_NEW))\n\t\treturn inode;\n\n\terr = squashfs_read_inode(inode, ino);\n\tif (err) {\n\t\tiget_failed(inode);\n\t\treturn ERR_PTR(err);\n\t}\n\n\tunlock_new_inode(inode);\n\treturn inode;\n}\n\n\n \nint squashfs_read_inode(struct inode *inode, long long ino)\n{\n\tstruct super_block *sb = inode->i_sb;\n\tstruct squashfs_sb_info *msblk = sb->s_fs_info;\n\tu64 block = SQUASHFS_INODE_BLK(ino) + msblk->inode_table;\n\tint err, type, offset = SQUASHFS_INODE_OFFSET(ino);\n\tunion squashfs_inode squashfs_ino;\n\tstruct squashfs_base_inode *sqshb_ino = &squashfs_ino.base;\n\tint xattr_id = SQUASHFS_INVALID_XATTR;\n\n\tTRACE(\"Entered squashfs_read_inode\\n\");\n\n\t \n\terr = squashfs_read_metadata(sb, sqshb_ino, &block,\n\t\t\t\t&offset, sizeof(*sqshb_ino));\n\tif (err < 0)\n\t\tgoto failed_read;\n\n\terr = squashfs_new_inode(sb, inode, sqshb_ino);\n\tif (err)\n\t\tgoto failed_read;\n\n\tblock = SQUASHFS_INODE_BLK(ino) + msblk->inode_table;\n\toffset = SQUASHFS_INODE_OFFSET(ino);\n\n\ttype = le16_to_cpu(sqshb_ino->inode_type);\n\tswitch (type) {\n\tcase SQUASHFS_REG_TYPE: {\n\t\tunsigned int frag_offset, frag;\n\t\tint frag_size;\n\t\tu64 frag_blk;\n\t\tstruct squashfs_reg_inode *sqsh_ino = &squashfs_ino.reg;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tfrag = le32_to_cpu(sqsh_ino->fragment);\n\t\tif (frag != SQUASHFS_INVALID_FRAG) {\n\t\t\tfrag_offset = le32_to_cpu(sqsh_ino->offset);\n\t\t\tfrag_size = squashfs_frag_lookup(sb, frag, &frag_blk);\n\t\t\tif (frag_size < 0) {\n\t\t\t\terr = frag_size;\n\t\t\t\tgoto failed_read;\n\t\t\t}\n\t\t} else {\n\t\t\tfrag_blk = SQUASHFS_INVALID_BLK;\n\t\t\tfrag_size = 0;\n\t\t\tfrag_offset = 0;\n\t\t}\n\n\t\tset_nlink(inode, 1);\n\t\tinode->i_size = le32_to_cpu(sqsh_ino->file_size);\n\t\tinode->i_fop = &generic_ro_fops;\n\t\tinode->i_mode |= S_IFREG;\n\t\tinode->i_blocks = ((inode->i_size - 1) >> 9) + 1;\n\t\tsquashfs_i(inode)->fragment_block = frag_blk;\n\t\tsquashfs_i(inode)->fragment_size = frag_size;\n\t\tsquashfs_i(inode)->fragment_offset = frag_offset;\n\t\tsquashfs_i(inode)->start = le32_to_cpu(sqsh_ino->start_block);\n\t\tsquashfs_i(inode)->block_list_start = block;\n\t\tsquashfs_i(inode)->offset = offset;\n\t\tinode->i_data.a_ops = &squashfs_aops;\n\n\t\tTRACE(\"File inode %x:%x, start_block %llx, block_list_start \"\n\t\t\t\"%llx, offset %x\\n\", SQUASHFS_INODE_BLK(ino),\n\t\t\toffset, squashfs_i(inode)->start, block, offset);\n\t\tbreak;\n\t}\n\tcase SQUASHFS_LREG_TYPE: {\n\t\tunsigned int frag_offset, frag;\n\t\tint frag_size;\n\t\tu64 frag_blk;\n\t\tstruct squashfs_lreg_inode *sqsh_ino = &squashfs_ino.lreg;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tfrag = le32_to_cpu(sqsh_ino->fragment);\n\t\tif (frag != SQUASHFS_INVALID_FRAG) {\n\t\t\tfrag_offset = le32_to_cpu(sqsh_ino->offset);\n\t\t\tfrag_size = squashfs_frag_lookup(sb, frag, &frag_blk);\n\t\t\tif (frag_size < 0) {\n\t\t\t\terr = frag_size;\n\t\t\t\tgoto failed_read;\n\t\t\t}\n\t\t} else {\n\t\t\tfrag_blk = SQUASHFS_INVALID_BLK;\n\t\t\tfrag_size = 0;\n\t\t\tfrag_offset = 0;\n\t\t}\n\n\t\txattr_id = le32_to_cpu(sqsh_ino->xattr);\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\tinode->i_size = le64_to_cpu(sqsh_ino->file_size);\n\t\tinode->i_op = &squashfs_inode_ops;\n\t\tinode->i_fop = &generic_ro_fops;\n\t\tinode->i_mode |= S_IFREG;\n\t\tinode->i_blocks = (inode->i_size -\n\t\t\t\tle64_to_cpu(sqsh_ino->sparse) + 511) >> 9;\n\n\t\tsquashfs_i(inode)->fragment_block = frag_blk;\n\t\tsquashfs_i(inode)->fragment_size = frag_size;\n\t\tsquashfs_i(inode)->fragment_offset = frag_offset;\n\t\tsquashfs_i(inode)->start = le64_to_cpu(sqsh_ino->start_block);\n\t\tsquashfs_i(inode)->block_list_start = block;\n\t\tsquashfs_i(inode)->offset = offset;\n\t\tinode->i_data.a_ops = &squashfs_aops;\n\n\t\tTRACE(\"File inode %x:%x, start_block %llx, block_list_start \"\n\t\t\t\"%llx, offset %x\\n\", SQUASHFS_INODE_BLK(ino),\n\t\t\toffset, squashfs_i(inode)->start, block, offset);\n\t\tbreak;\n\t}\n\tcase SQUASHFS_DIR_TYPE: {\n\t\tstruct squashfs_dir_inode *sqsh_ino = &squashfs_ino.dir;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\tinode->i_size = le16_to_cpu(sqsh_ino->file_size);\n\t\tinode->i_op = &squashfs_dir_inode_ops;\n\t\tinode->i_fop = &squashfs_dir_ops;\n\t\tinode->i_mode |= S_IFDIR;\n\t\tsquashfs_i(inode)->start = le32_to_cpu(sqsh_ino->start_block);\n\t\tsquashfs_i(inode)->offset = le16_to_cpu(sqsh_ino->offset);\n\t\tsquashfs_i(inode)->dir_idx_cnt = 0;\n\t\tsquashfs_i(inode)->parent = le32_to_cpu(sqsh_ino->parent_inode);\n\n\t\tTRACE(\"Directory inode %x:%x, start_block %llx, offset %x\\n\",\n\t\t\t\tSQUASHFS_INODE_BLK(ino), offset,\n\t\t\t\tsquashfs_i(inode)->start,\n\t\t\t\tle16_to_cpu(sqsh_ino->offset));\n\t\tbreak;\n\t}\n\tcase SQUASHFS_LDIR_TYPE: {\n\t\tstruct squashfs_ldir_inode *sqsh_ino = &squashfs_ino.ldir;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\txattr_id = le32_to_cpu(sqsh_ino->xattr);\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\tinode->i_size = le32_to_cpu(sqsh_ino->file_size);\n\t\tinode->i_op = &squashfs_dir_inode_ops;\n\t\tinode->i_fop = &squashfs_dir_ops;\n\t\tinode->i_mode |= S_IFDIR;\n\t\tsquashfs_i(inode)->start = le32_to_cpu(sqsh_ino->start_block);\n\t\tsquashfs_i(inode)->offset = le16_to_cpu(sqsh_ino->offset);\n\t\tsquashfs_i(inode)->dir_idx_start = block;\n\t\tsquashfs_i(inode)->dir_idx_offset = offset;\n\t\tsquashfs_i(inode)->dir_idx_cnt = le16_to_cpu(sqsh_ino->i_count);\n\t\tsquashfs_i(inode)->parent = le32_to_cpu(sqsh_ino->parent_inode);\n\n\t\tTRACE(\"Long directory inode %x:%x, start_block %llx, offset \"\n\t\t\t\t\"%x\\n\", SQUASHFS_INODE_BLK(ino), offset,\n\t\t\t\tsquashfs_i(inode)->start,\n\t\t\t\tle16_to_cpu(sqsh_ino->offset));\n\t\tbreak;\n\t}\n\tcase SQUASHFS_SYMLINK_TYPE:\n\tcase SQUASHFS_LSYMLINK_TYPE: {\n\t\tstruct squashfs_symlink_inode *sqsh_ino = &squashfs_ino.symlink;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\tinode->i_size = le32_to_cpu(sqsh_ino->symlink_size);\n\t\tinode->i_op = &squashfs_symlink_inode_ops;\n\t\tinode_nohighmem(inode);\n\t\tinode->i_data.a_ops = &squashfs_symlink_aops;\n\t\tinode->i_mode |= S_IFLNK;\n\t\tsquashfs_i(inode)->start = block;\n\t\tsquashfs_i(inode)->offset = offset;\n\n\t\tif (type == SQUASHFS_LSYMLINK_TYPE) {\n\t\t\t__le32 xattr;\n\n\t\t\terr = squashfs_read_metadata(sb, NULL, &block,\n\t\t\t\t\t\t&offset, inode->i_size);\n\t\t\tif (err < 0)\n\t\t\t\tgoto failed_read;\n\t\t\terr = squashfs_read_metadata(sb, &xattr, &block,\n\t\t\t\t\t\t&offset, sizeof(xattr));\n\t\t\tif (err < 0)\n\t\t\t\tgoto failed_read;\n\t\t\txattr_id = le32_to_cpu(xattr);\n\t\t}\n\n\t\tTRACE(\"Symbolic link inode %x:%x, start_block %llx, offset \"\n\t\t\t\t\"%x\\n\", SQUASHFS_INODE_BLK(ino), offset,\n\t\t\t\tblock, offset);\n\t\tbreak;\n\t}\n\tcase SQUASHFS_BLKDEV_TYPE:\n\tcase SQUASHFS_CHRDEV_TYPE: {\n\t\tstruct squashfs_dev_inode *sqsh_ino = &squashfs_ino.dev;\n\t\tunsigned int rdev;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tif (type == SQUASHFS_CHRDEV_TYPE)\n\t\t\tinode->i_mode |= S_IFCHR;\n\t\telse\n\t\t\tinode->i_mode |= S_IFBLK;\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\trdev = le32_to_cpu(sqsh_ino->rdev);\n\t\tinit_special_inode(inode, inode->i_mode, new_decode_dev(rdev));\n\n\t\tTRACE(\"Device inode %x:%x, rdev %x\\n\",\n\t\t\t\tSQUASHFS_INODE_BLK(ino), offset, rdev);\n\t\tbreak;\n\t}\n\tcase SQUASHFS_LBLKDEV_TYPE:\n\tcase SQUASHFS_LCHRDEV_TYPE: {\n\t\tstruct squashfs_ldev_inode *sqsh_ino = &squashfs_ino.ldev;\n\t\tunsigned int rdev;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tif (type == SQUASHFS_LCHRDEV_TYPE)\n\t\t\tinode->i_mode |= S_IFCHR;\n\t\telse\n\t\t\tinode->i_mode |= S_IFBLK;\n\t\txattr_id = le32_to_cpu(sqsh_ino->xattr);\n\t\tinode->i_op = &squashfs_inode_ops;\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\trdev = le32_to_cpu(sqsh_ino->rdev);\n\t\tinit_special_inode(inode, inode->i_mode, new_decode_dev(rdev));\n\n\t\tTRACE(\"Device inode %x:%x, rdev %x\\n\",\n\t\t\t\tSQUASHFS_INODE_BLK(ino), offset, rdev);\n\t\tbreak;\n\t}\n\tcase SQUASHFS_FIFO_TYPE:\n\tcase SQUASHFS_SOCKET_TYPE: {\n\t\tstruct squashfs_ipc_inode *sqsh_ino = &squashfs_ino.ipc;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tif (type == SQUASHFS_FIFO_TYPE)\n\t\t\tinode->i_mode |= S_IFIFO;\n\t\telse\n\t\t\tinode->i_mode |= S_IFSOCK;\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\tinit_special_inode(inode, inode->i_mode, 0);\n\t\tbreak;\n\t}\n\tcase SQUASHFS_LFIFO_TYPE:\n\tcase SQUASHFS_LSOCKET_TYPE: {\n\t\tstruct squashfs_lipc_inode *sqsh_ino = &squashfs_ino.lipc;\n\n\t\terr = squashfs_read_metadata(sb, sqsh_ino, &block, &offset,\n\t\t\t\tsizeof(*sqsh_ino));\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\n\t\tif (type == SQUASHFS_LFIFO_TYPE)\n\t\t\tinode->i_mode |= S_IFIFO;\n\t\telse\n\t\t\tinode->i_mode |= S_IFSOCK;\n\t\txattr_id = le32_to_cpu(sqsh_ino->xattr);\n\t\tinode->i_op = &squashfs_inode_ops;\n\t\tset_nlink(inode, le32_to_cpu(sqsh_ino->nlink));\n\t\tinit_special_inode(inode, inode->i_mode, 0);\n\t\tbreak;\n\t}\n\tdefault:\n\t\tERROR(\"Unknown inode type %d in squashfs_iget!\\n\", type);\n\t\treturn -EINVAL;\n\t}\n\n\tif (xattr_id != SQUASHFS_INVALID_XATTR && msblk->xattr_id_table) {\n\t\terr = squashfs_xattr_lookup(sb, xattr_id,\n\t\t\t\t\t&squashfs_i(inode)->xattr_count,\n\t\t\t\t\t&squashfs_i(inode)->xattr_size,\n\t\t\t\t\t&squashfs_i(inode)->xattr);\n\t\tif (err < 0)\n\t\t\tgoto failed_read;\n\t\tinode->i_blocks += ((squashfs_i(inode)->xattr_size - 1) >> 9)\n\t\t\t\t+ 1;\n\t} else\n\t\tsquashfs_i(inode)->xattr_count = 0;\n\n\treturn 0;\n\nfailed_read:\n\tERROR(\"Unable to read inode 0x%llx\\n\", ino);\n\treturn err;\n}\n\n\nconst struct inode_operations squashfs_inode_ops = {\n\t.listxattr = squashfs_listxattr\n};\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}