{
  "module_name": "page_actor.c",
  "hash_id": "69cd98ea055b80b3f1e82c59303afb6362b829e8fc07e316d2c822653057ab8e",
  "original_prompt": "Ingested from linux-6.6.14/fs/squashfs/page_actor.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/pagemap.h>\n#include \"squashfs_fs_sb.h\"\n#include \"decompressor.h\"\n#include \"page_actor.h\"\n\n \n\n \nstatic void *cache_first_page(struct squashfs_page_actor *actor)\n{\n\tactor->next_page = 1;\n\treturn actor->buffer[0];\n}\n\nstatic void *cache_next_page(struct squashfs_page_actor *actor)\n{\n\tif (actor->next_page == actor->pages)\n\t\treturn NULL;\n\n\treturn actor->buffer[actor->next_page++];\n}\n\nstatic void cache_finish_page(struct squashfs_page_actor *actor)\n{\n\t \n}\n\nstruct squashfs_page_actor *squashfs_page_actor_init(void **buffer,\n\tint pages, int length)\n{\n\tstruct squashfs_page_actor *actor = kmalloc(sizeof(*actor), GFP_KERNEL);\n\n\tif (actor == NULL)\n\t\treturn NULL;\n\n\tactor->length = length ? : pages * PAGE_SIZE;\n\tactor->buffer = buffer;\n\tactor->pages = pages;\n\tactor->next_page = 0;\n\tactor->tmp_buffer = NULL;\n\tactor->squashfs_first_page = cache_first_page;\n\tactor->squashfs_next_page = cache_next_page;\n\tactor->squashfs_finish_page = cache_finish_page;\n\treturn actor;\n}\n\n \nstatic void *handle_next_page(struct squashfs_page_actor *actor)\n{\n\tint max_pages = (actor->length + PAGE_SIZE - 1) >> PAGE_SHIFT;\n\n\tif (actor->returned_pages == max_pages)\n\t\treturn NULL;\n\n\tif ((actor->next_page == actor->pages) ||\n\t\t\t(actor->next_index != actor->page[actor->next_page]->index)) {\n\t\tactor->next_index++;\n\t\tactor->returned_pages++;\n\t\tactor->last_page = NULL;\n\t\treturn actor->alloc_buffer ? actor->tmp_buffer : ERR_PTR(-ENOMEM);\n\t}\n\n\tactor->next_index++;\n\tactor->returned_pages++;\n\tactor->last_page = actor->page[actor->next_page];\n\treturn actor->pageaddr = kmap_local_page(actor->page[actor->next_page++]);\n}\n\nstatic void *direct_first_page(struct squashfs_page_actor *actor)\n{\n\treturn handle_next_page(actor);\n}\n\nstatic void *direct_next_page(struct squashfs_page_actor *actor)\n{\n\tif (actor->pageaddr) {\n\t\tkunmap_local(actor->pageaddr);\n\t\tactor->pageaddr = NULL;\n\t}\n\n\treturn handle_next_page(actor);\n}\n\nstatic void direct_finish_page(struct squashfs_page_actor *actor)\n{\n\tif (actor->pageaddr)\n\t\tkunmap_local(actor->pageaddr);\n}\n\nstruct squashfs_page_actor *squashfs_page_actor_init_special(struct squashfs_sb_info *msblk,\n\tstruct page **page, int pages, int length)\n{\n\tstruct squashfs_page_actor *actor = kmalloc(sizeof(*actor), GFP_KERNEL);\n\n\tif (actor == NULL)\n\t\treturn NULL;\n\n\tif (msblk->decompressor->alloc_buffer) {\n\t\tactor->tmp_buffer = kmalloc(PAGE_SIZE, GFP_KERNEL);\n\n\t\tif (actor->tmp_buffer == NULL) {\n\t\t\tkfree(actor);\n\t\t\treturn NULL;\n\t\t}\n\t} else\n\t\tactor->tmp_buffer = NULL;\n\n\tactor->length = length ? : pages * PAGE_SIZE;\n\tactor->page = page;\n\tactor->pages = pages;\n\tactor->next_page = 0;\n\tactor->returned_pages = 0;\n\tactor->next_index = page[0]->index & ~((1 << (msblk->block_log - PAGE_SHIFT)) - 1);\n\tactor->pageaddr = NULL;\n\tactor->last_page = NULL;\n\tactor->alloc_buffer = msblk->decompressor->alloc_buffer;\n\tactor->squashfs_first_page = direct_first_page;\n\tactor->squashfs_next_page = direct_next_page;\n\tactor->squashfs_finish_page = direct_finish_page;\n\treturn actor;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}