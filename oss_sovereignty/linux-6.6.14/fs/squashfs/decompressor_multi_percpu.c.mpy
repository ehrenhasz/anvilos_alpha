{
  "module_name": "decompressor_multi_percpu.c",
  "hash_id": "5d37679a962a078ca1a5b851487d07a49f42694852f747f9cfc4d93864ecc795",
  "original_prompt": "Ingested from linux-6.6.14/fs/squashfs/decompressor_multi_percpu.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/slab.h>\n#include <linux/percpu.h>\n#include <linux/local_lock.h>\n\n#include \"squashfs_fs.h\"\n#include \"squashfs_fs_sb.h\"\n#include \"decompressor.h\"\n#include \"squashfs.h\"\n\n \n\nstruct squashfs_stream {\n\tvoid\t\t\t*stream;\n\tlocal_lock_t\tlock;\n};\n\nstatic void *squashfs_decompressor_create(struct squashfs_sb_info *msblk,\n\t\t\t\t\t\tvoid *comp_opts)\n{\n\tstruct squashfs_stream *stream;\n\tstruct squashfs_stream __percpu *percpu;\n\tint err, cpu;\n\n\tpercpu = alloc_percpu(struct squashfs_stream);\n\tif (percpu == NULL)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tfor_each_possible_cpu(cpu) {\n\t\tstream = per_cpu_ptr(percpu, cpu);\n\t\tstream->stream = msblk->decompressor->init(msblk, comp_opts);\n\t\tif (IS_ERR(stream->stream)) {\n\t\t\terr = PTR_ERR(stream->stream);\n\t\t\tgoto out;\n\t\t}\n\t\tlocal_lock_init(&stream->lock);\n\t}\n\n\tkfree(comp_opts);\n\treturn (__force void *) percpu;\n\nout:\n\tfor_each_possible_cpu(cpu) {\n\t\tstream = per_cpu_ptr(percpu, cpu);\n\t\tif (!IS_ERR_OR_NULL(stream->stream))\n\t\t\tmsblk->decompressor->free(stream->stream);\n\t}\n\tfree_percpu(percpu);\n\treturn ERR_PTR(err);\n}\n\nstatic void squashfs_decompressor_destroy(struct squashfs_sb_info *msblk)\n{\n\tstruct squashfs_stream __percpu *percpu =\n\t\t\t(struct squashfs_stream __percpu *) msblk->stream;\n\tstruct squashfs_stream *stream;\n\tint cpu;\n\n\tif (msblk->stream) {\n\t\tfor_each_possible_cpu(cpu) {\n\t\t\tstream = per_cpu_ptr(percpu, cpu);\n\t\t\tmsblk->decompressor->free(stream->stream);\n\t\t}\n\t\tfree_percpu(percpu);\n\t}\n}\n\nstatic int squashfs_decompress(struct squashfs_sb_info *msblk, struct bio *bio,\n\tint offset, int length, struct squashfs_page_actor *output)\n{\n\tstruct squashfs_stream *stream;\n\tstruct squashfs_stream __percpu *percpu =\n\t\t\t(struct squashfs_stream __percpu *) msblk->stream;\n\tint res;\n\n\tlocal_lock(&percpu->lock);\n\tstream = this_cpu_ptr(percpu);\n\n\tres = msblk->decompressor->decompress(msblk, stream->stream, bio,\n\t\t\t\t\t      offset, length, output);\n\n\tlocal_unlock(&percpu->lock);\n\n\tif (res < 0)\n\t\tERROR(\"%s decompression failed, data probably corrupt\\n\",\n\t\t\tmsblk->decompressor->name);\n\n\treturn res;\n}\n\nstatic int squashfs_max_decompressors(void)\n{\n\treturn num_possible_cpus();\n}\n\nconst struct squashfs_decompressor_thread_ops squashfs_decompressor_percpu = {\n\t.create = squashfs_decompressor_create,\n\t.destroy = squashfs_decompressor_destroy,\n\t.decompress = squashfs_decompress,\n\t.max_decompressors = squashfs_max_decompressors,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}