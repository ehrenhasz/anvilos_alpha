{
  "module_name": "decompressor_multi.c",
  "hash_id": "2fd0ab49d97048818fad277f80af998c9f777a5e875d54208e6513c9b9324fd5",
  "original_prompt": "Ingested from linux-6.6.14/fs/squashfs/decompressor_multi.c",
  "human_readable_source": "\n \n#include <linux/types.h>\n#include <linux/mutex.h>\n#include <linux/slab.h>\n#include <linux/bio.h>\n#include <linux/sched.h>\n#include <linux/wait.h>\n#include <linux/cpumask.h>\n\n#include \"squashfs_fs.h\"\n#include \"squashfs_fs_sb.h\"\n#include \"decompressor.h\"\n#include \"squashfs.h\"\n\n \n\n\n \n#define MAX_DECOMPRESSOR\t(num_online_cpus() * 2)\n\n\nstatic int squashfs_max_decompressors(void)\n{\n\treturn MAX_DECOMPRESSOR;\n}\n\nstruct squashfs_stream {\n\tvoid\t\t\t*comp_opts;\n\tstruct list_head\tstrm_list;\n\tstruct mutex\t\tmutex;\n\tint\t\t\tavail_decomp;\n\twait_queue_head_t\twait;\n};\n\n\nstruct decomp_stream {\n\tvoid *stream;\n\tstruct list_head list;\n};\n\n\nstatic void put_decomp_stream(struct decomp_stream *decomp_strm,\n\t\t\t\tstruct squashfs_stream *stream)\n{\n\tmutex_lock(&stream->mutex);\n\tlist_add(&decomp_strm->list, &stream->strm_list);\n\tmutex_unlock(&stream->mutex);\n\twake_up(&stream->wait);\n}\n\nstatic void *squashfs_decompressor_create(struct squashfs_sb_info *msblk,\n\t\t\t\tvoid *comp_opts)\n{\n\tstruct squashfs_stream *stream;\n\tstruct decomp_stream *decomp_strm = NULL;\n\tint err = -ENOMEM;\n\n\tstream = kzalloc(sizeof(*stream), GFP_KERNEL);\n\tif (!stream)\n\t\tgoto out;\n\n\tstream->comp_opts = comp_opts;\n\tmutex_init(&stream->mutex);\n\tINIT_LIST_HEAD(&stream->strm_list);\n\tinit_waitqueue_head(&stream->wait);\n\n\t \n\tdecomp_strm = kmalloc(sizeof(*decomp_strm), GFP_KERNEL);\n\tif (!decomp_strm)\n\t\tgoto out;\n\n\tdecomp_strm->stream = msblk->decompressor->init(msblk,\n\t\t\t\t\t\tstream->comp_opts);\n\tif (IS_ERR(decomp_strm->stream)) {\n\t\terr = PTR_ERR(decomp_strm->stream);\n\t\tgoto out;\n\t}\n\n\tlist_add(&decomp_strm->list, &stream->strm_list);\n\tstream->avail_decomp = 1;\n\treturn stream;\n\nout:\n\tkfree(decomp_strm);\n\tkfree(stream);\n\treturn ERR_PTR(err);\n}\n\n\nstatic void squashfs_decompressor_destroy(struct squashfs_sb_info *msblk)\n{\n\tstruct squashfs_stream *stream = msblk->stream;\n\tif (stream) {\n\t\tstruct decomp_stream *decomp_strm;\n\n\t\twhile (!list_empty(&stream->strm_list)) {\n\t\t\tdecomp_strm = list_entry(stream->strm_list.prev,\n\t\t\t\t\t\tstruct decomp_stream, list);\n\t\t\tlist_del(&decomp_strm->list);\n\t\t\tmsblk->decompressor->free(decomp_strm->stream);\n\t\t\tkfree(decomp_strm);\n\t\t\tstream->avail_decomp--;\n\t\t}\n\t\tWARN_ON(stream->avail_decomp);\n\t\tkfree(stream->comp_opts);\n\t\tkfree(stream);\n\t}\n}\n\n\nstatic struct decomp_stream *get_decomp_stream(struct squashfs_sb_info *msblk,\n\t\t\t\t\tstruct squashfs_stream *stream)\n{\n\tstruct decomp_stream *decomp_strm;\n\n\twhile (1) {\n\t\tmutex_lock(&stream->mutex);\n\n\t\t \n\t\tif (!list_empty(&stream->strm_list)) {\n\t\t\tdecomp_strm = list_entry(stream->strm_list.prev,\n\t\t\t\tstruct decomp_stream, list);\n\t\t\tlist_del(&decomp_strm->list);\n\t\t\tmutex_unlock(&stream->mutex);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (stream->avail_decomp >= msblk->max_thread_num)\n\t\t\tgoto wait;\n\n\t\t \n\t\tdecomp_strm = kmalloc(sizeof(*decomp_strm), GFP_KERNEL);\n\t\tif (!decomp_strm)\n\t\t\tgoto wait;\n\n\t\tdecomp_strm->stream = msblk->decompressor->init(msblk,\n\t\t\t\t\t\tstream->comp_opts);\n\t\tif (IS_ERR(decomp_strm->stream)) {\n\t\t\tkfree(decomp_strm);\n\t\t\tgoto wait;\n\t\t}\n\n\t\tstream->avail_decomp++;\n\t\tWARN_ON(stream->avail_decomp > msblk->max_thread_num);\n\n\t\tmutex_unlock(&stream->mutex);\n\t\tbreak;\nwait:\n\t\t \n\t\tmutex_unlock(&stream->mutex);\n\t\twait_event(stream->wait,\n\t\t\t!list_empty(&stream->strm_list));\n\t}\n\n\treturn decomp_strm;\n}\n\n\nstatic int squashfs_decompress(struct squashfs_sb_info *msblk, struct bio *bio,\n\t\t\tint offset, int length,\n\t\t\tstruct squashfs_page_actor *output)\n{\n\tint res;\n\tstruct squashfs_stream *stream = msblk->stream;\n\tstruct decomp_stream *decomp_stream = get_decomp_stream(msblk, stream);\n\tres = msblk->decompressor->decompress(msblk, decomp_stream->stream,\n\t\tbio, offset, length, output);\n\tput_decomp_stream(decomp_stream, stream);\n\tif (res < 0)\n\t\tERROR(\"%s decompression failed, data probably corrupt\\n\",\n\t\t\tmsblk->decompressor->name);\n\treturn res;\n}\n\nconst struct squashfs_decompressor_thread_ops squashfs_decompressor_multi = {\n\t.create = squashfs_decompressor_create,\n\t.destroy = squashfs_decompressor_destroy,\n\t.decompress = squashfs_decompress,\n\t.max_decompressors = squashfs_max_decompressors,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}