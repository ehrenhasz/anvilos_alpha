{
  "module_name": "dentry.c",
  "hash_id": "125543acc3ae491457304c7b5c089f28cdc0302e8bee6fb48a4a9df812fec086",
  "original_prompt": "Ingested from linux-6.6.14/fs/gfs2/dentry.c",
  "human_readable_source": "\n \n\n#include <linux/spinlock.h>\n#include <linux/completion.h>\n#include <linux/buffer_head.h>\n#include <linux/gfs2_ondisk.h>\n#include <linux/namei.h>\n#include <linux/crc32.h>\n\n#include \"gfs2.h\"\n#include \"incore.h\"\n#include \"dir.h\"\n#include \"glock.h\"\n#include \"super.h\"\n#include \"util.h\"\n#include \"inode.h\"\n\n \n\nstatic int gfs2_drevalidate(struct dentry *dentry, unsigned int flags)\n{\n\tstruct dentry *parent;\n\tstruct gfs2_sbd *sdp;\n\tstruct gfs2_inode *dip;\n\tstruct inode *inode;\n\tstruct gfs2_holder d_gh;\n\tstruct gfs2_inode *ip = NULL;\n\tint error, valid = 0;\n\tint had_lock = 0;\n\n\tif (flags & LOOKUP_RCU)\n\t\treturn -ECHILD;\n\n\tparent = dget_parent(dentry);\n\tsdp = GFS2_SB(d_inode(parent));\n\tdip = GFS2_I(d_inode(parent));\n\tinode = d_inode(dentry);\n\n\tif (inode) {\n\t\tif (is_bad_inode(inode))\n\t\t\tgoto out;\n\t\tip = GFS2_I(inode);\n\t}\n\n\tif (sdp->sd_lockstruct.ls_ops->lm_mount == NULL) {\n\t\tvalid = 1;\n\t\tgoto out;\n\t}\n\n\thad_lock = (gfs2_glock_is_locked_by_me(dip->i_gl) != NULL);\n\tif (!had_lock) {\n\t\terror = gfs2_glock_nq_init(dip->i_gl, LM_ST_SHARED, 0, &d_gh);\n\t\tif (error)\n\t\t\tgoto out;\n\t}\n\n\terror = gfs2_dir_check(d_inode(parent), &dentry->d_name, ip);\n\tvalid = inode ? !error : (error == -ENOENT);\n\n\tif (!had_lock)\n\t\tgfs2_glock_dq_uninit(&d_gh);\nout:\n\tdput(parent);\n\treturn valid;\n}\n\nstatic int gfs2_dhash(const struct dentry *dentry, struct qstr *str)\n{\n\tstr->hash = gfs2_disk_hash(str->name, str->len);\n\treturn 0;\n}\n\nstatic int gfs2_dentry_delete(const struct dentry *dentry)\n{\n\tstruct gfs2_inode *ginode;\n\n\tif (d_really_is_negative(dentry))\n\t\treturn 0;\n\n\tginode = GFS2_I(d_inode(dentry));\n\tif (!gfs2_holder_initialized(&ginode->i_iopen_gh))\n\t\treturn 0;\n\n\tif (test_bit(GLF_DEMOTE, &ginode->i_iopen_gh.gh_gl->gl_flags))\n\t\treturn 1;\n\n\treturn 0;\n}\n\nconst struct dentry_operations gfs2_dops = {\n\t.d_revalidate = gfs2_drevalidate,\n\t.d_hash = gfs2_dhash,\n\t.d_delete = gfs2_dentry_delete,\n};\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}