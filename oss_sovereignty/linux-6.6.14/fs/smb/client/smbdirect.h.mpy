{
  "module_name": "smbdirect.h",
  "hash_id": "5432ec23680ffe357ad82ac04f54e977b71ca4093d0ca5a914c6f7d2da20cd3f",
  "original_prompt": "Ingested from linux-6.6.14/fs/smb/client/smbdirect.h",
  "human_readable_source": " \n \n#ifndef _SMBDIRECT_H\n#define _SMBDIRECT_H\n\n#ifdef CONFIG_CIFS_SMB_DIRECT\n#define cifs_rdma_enabled(server)\t((server)->rdma)\n\n#include \"cifsglob.h\"\n#include <rdma/ib_verbs.h>\n#include <rdma/rdma_cm.h>\n#include <linux/mempool.h>\n\nextern int rdma_readwrite_threshold;\nextern int smbd_max_frmr_depth;\nextern int smbd_keep_alive_interval;\nextern int smbd_max_receive_size;\nextern int smbd_max_fragmented_recv_size;\nextern int smbd_max_send_size;\nextern int smbd_send_credit_target;\nextern int smbd_receive_credit_max;\n\nenum keep_alive_status {\n\tKEEP_ALIVE_NONE,\n\tKEEP_ALIVE_PENDING,\n\tKEEP_ALIVE_SENT,\n};\n\nenum smbd_connection_status {\n\tSMBD_CREATED,\n\tSMBD_CONNECTING,\n\tSMBD_CONNECTED,\n\tSMBD_NEGOTIATE_FAILED,\n\tSMBD_DISCONNECTING,\n\tSMBD_DISCONNECTED,\n\tSMBD_DESTROYED\n};\n\n \nstruct smbd_connection {\n\tenum smbd_connection_status transport_status;\n\n\t \n\tstruct rdma_cm_id *id;\n\tstruct ib_qp_init_attr qp_attr;\n\tstruct ib_pd *pd;\n\tstruct ib_cq *send_cq, *recv_cq;\n\tstruct ib_device_attr dev_attr;\n\tint ri_rc;\n\tstruct completion ri_done;\n\twait_queue_head_t conn_wait;\n\twait_queue_head_t disconn_wait;\n\n\tstruct completion negotiate_completion;\n\tbool negotiate_done;\n\n\tstruct work_struct disconnect_work;\n\tstruct work_struct post_send_credits_work;\n\n\tspinlock_t lock_new_credits_offered;\n\tint new_credits_offered;\n\n\t \n\tint receive_credit_max;\n\tint send_credit_target;\n\tint max_send_size;\n\tint max_fragmented_recv_size;\n\tint max_fragmented_send_size;\n\tint max_receive_size;\n\tint keep_alive_interval;\n\tint max_readwrite_size;\n\tenum keep_alive_status keep_alive_requested;\n\tint protocol;\n\tatomic_t send_credits;\n\tatomic_t receive_credits;\n\tint receive_credit_target;\n\tint fragment_reassembly_remaining;\n\n\t \n\t \n\tint responder_resources;\n\t \n\tint max_frmr_depth;\n\t \n\tint rdma_readwrite_threshold;\n\tenum ib_mr_type mr_type;\n\tstruct list_head mr_list;\n\tspinlock_t mr_list_lock;\n\t \n\tatomic_t mr_ready_count;\n\tatomic_t mr_used_count;\n\twait_queue_head_t wait_mr;\n\tstruct work_struct mr_recovery_work;\n\t \n\twait_queue_head_t wait_for_mr_cleanup;\n\n\t \n\tatomic_t send_pending;\n\twait_queue_head_t wait_send_pending;\n\twait_queue_head_t wait_post_send;\n\n\t \n\tstruct list_head receive_queue;\n\tint count_receive_queue;\n\tspinlock_t receive_queue_lock;\n\n\tstruct list_head empty_packet_queue;\n\tint count_empty_packet_queue;\n\tspinlock_t empty_packet_queue_lock;\n\n\twait_queue_head_t wait_receive_queues;\n\n\t \n\tstruct list_head reassembly_queue;\n\tspinlock_t reassembly_queue_lock;\n\twait_queue_head_t wait_reassembly_queue;\n\n\t \n\tint reassembly_data_length;\n\tint reassembly_queue_length;\n\t \n\tint first_entry_offset;\n\n\tbool send_immediate;\n\n\twait_queue_head_t wait_send_queue;\n\n\t \n\tbool full_packet_received;\n\n\tstruct workqueue_struct *workqueue;\n\tstruct delayed_work idle_timer_work;\n\n\t \n\t \n\tstruct kmem_cache *request_cache;\n\tmempool_t *request_mempool;\n\n\t \n\tstruct kmem_cache *response_cache;\n\tmempool_t *response_mempool;\n\n\t \n\tunsigned int count_get_receive_buffer;\n\tunsigned int count_put_receive_buffer;\n\tunsigned int count_reassembly_queue;\n\tunsigned int count_enqueue_reassembly_queue;\n\tunsigned int count_dequeue_reassembly_queue;\n\tunsigned int count_send_empty;\n};\n\nenum smbd_message_type {\n\tSMBD_NEGOTIATE_RESP,\n\tSMBD_TRANSFER_DATA,\n};\n\n#define SMB_DIRECT_RESPONSE_REQUESTED 0x0001\n\n \nstruct smbd_negotiate_req {\n\t__le16 min_version;\n\t__le16 max_version;\n\t__le16 reserved;\n\t__le16 credits_requested;\n\t__le32 preferred_send_size;\n\t__le32 max_receive_size;\n\t__le32 max_fragmented_size;\n} __packed;\n\n \nstruct smbd_negotiate_resp {\n\t__le16 min_version;\n\t__le16 max_version;\n\t__le16 negotiated_version;\n\t__le16 reserved;\n\t__le16 credits_requested;\n\t__le16 credits_granted;\n\t__le32 status;\n\t__le32 max_readwrite_size;\n\t__le32 preferred_send_size;\n\t__le32 max_receive_size;\n\t__le32 max_fragmented_size;\n} __packed;\n\n \nstruct smbd_data_transfer {\n\t__le16 credits_requested;\n\t__le16 credits_granted;\n\t__le16 flags;\n\t__le16 reserved;\n\t__le32 remaining_data_length;\n\t__le32 data_offset;\n\t__le32 data_length;\n\t__le32 padding;\n\t__u8 buffer[];\n} __packed;\n\n \nstruct smbd_buffer_descriptor_v1 {\n\t__le64 offset;\n\t__le32 token;\n\t__le32 length;\n} __packed;\n\n \n#define SMBDIRECT_MAX_SEND_SGE\t6\n\n \nstruct smbd_request {\n\tstruct smbd_connection *info;\n\tstruct ib_cqe cqe;\n\n\t \n\tstruct ib_sge sge[SMBDIRECT_MAX_SEND_SGE];\n\tint num_sge;\n\n\t \n\tu8 packet[];\n};\n\n \n#define SMBDIRECT_MAX_RECV_SGE\t1\n\n \nstruct smbd_response {\n\tstruct smbd_connection *info;\n\tstruct ib_cqe cqe;\n\tstruct ib_sge sge;\n\n\tenum smbd_message_type type;\n\n\t \n\tstruct list_head list;\n\n\t \n\tbool first_segment;\n\n\t \n\tu8 packet[];\n};\n\n \nstruct smbd_connection *smbd_get_connection(\n\tstruct TCP_Server_Info *server, struct sockaddr *dstaddr);\n\n \nint smbd_reconnect(struct TCP_Server_Info *server);\n \nvoid smbd_destroy(struct TCP_Server_Info *server);\n\n \nint smbd_recv(struct smbd_connection *info, struct msghdr *msg);\nint smbd_send(struct TCP_Server_Info *server,\n\tint num_rqst, struct smb_rqst *rqst);\n\nenum mr_state {\n\tMR_READY,\n\tMR_REGISTERED,\n\tMR_INVALIDATED,\n\tMR_ERROR\n};\n\nstruct smbd_mr {\n\tstruct smbd_connection\t*conn;\n\tstruct list_head\tlist;\n\tenum mr_state\t\tstate;\n\tstruct ib_mr\t\t*mr;\n\tstruct sg_table\t\tsgt;\n\tenum dma_data_direction\tdir;\n\tunion {\n\t\tstruct ib_reg_wr\twr;\n\t\tstruct ib_send_wr\tinv_wr;\n\t};\n\tstruct ib_cqe\t\tcqe;\n\tbool\t\t\tneed_invalidate;\n\tstruct completion\tinvalidate_done;\n};\n\n \nstruct smbd_mr *smbd_register_mr(\n\tstruct smbd_connection *info, struct iov_iter *iter,\n\tbool writing, bool need_invalidate);\nint smbd_deregister_mr(struct smbd_mr *mr);\n\n#else\n#define cifs_rdma_enabled(server)\t0\nstruct smbd_connection {};\nstatic inline void *smbd_get_connection(\n\tstruct TCP_Server_Info *server, struct sockaddr *dstaddr) {return NULL;}\nstatic inline int smbd_reconnect(struct TCP_Server_Info *server) {return -1; }\nstatic inline void smbd_destroy(struct TCP_Server_Info *server) {}\nstatic inline int smbd_recv(struct smbd_connection *info, struct msghdr *msg) {return -1; }\nstatic inline int smbd_send(struct TCP_Server_Info *server, int num_rqst, struct smb_rqst *rqst) {return -1; }\n#endif\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}