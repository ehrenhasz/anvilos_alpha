{
  "module_name": "dfs.h",
  "hash_id": "6f8d6e2db5bdcdaa35ad732acec644c515df36c1163196d5f6c4de41ad664511",
  "original_prompt": "Ingested from linux-6.6.14/fs/smb/client/dfs.h",
  "human_readable_source": " \n \n\n#ifndef _CIFS_DFS_H\n#define _CIFS_DFS_H\n\n#include \"cifsglob.h\"\n#include \"fs_context.h\"\n#include \"cifs_unicode.h\"\n#include <linux/namei.h>\n\n#define DFS_INTERLINK(v) \\\n\t(((v) & DFSREF_REFERRAL_SERVER) && !((v) & DFSREF_STORAGE_SERVER))\n\nstruct dfs_ref {\n\tchar *path;\n\tchar *full_path;\n\tstruct dfs_cache_tgt_list tl;\n\tstruct dfs_cache_tgt_iterator *tit;\n};\n\nstruct dfs_ref_walk {\n\tstruct dfs_ref *ref;\n\tstruct dfs_ref refs[MAX_NESTED_LINKS];\n};\n\n#define ref_walk_start(w)\t((w)->refs)\n#define ref_walk_end(w)\t(&(w)->refs[ARRAY_SIZE((w)->refs) - 1])\n#define ref_walk_cur(w)\t((w)->ref)\n#define ref_walk_descend(w)\t(--ref_walk_cur(w) >= ref_walk_start(w))\n\n#define ref_walk_tit(w)\t(ref_walk_cur(w)->tit)\n#define ref_walk_empty(w)\t(!ref_walk_tit(w))\n#define ref_walk_path(w)\t(ref_walk_cur(w)->path)\n#define ref_walk_fpath(w)\t(ref_walk_cur(w)->full_path)\n#define ref_walk_tl(w)\t\t(&ref_walk_cur(w)->tl)\n\nstatic inline struct dfs_ref_walk *ref_walk_alloc(void)\n{\n\tstruct dfs_ref_walk *rw;\n\n\trw = kmalloc(sizeof(*rw), GFP_KERNEL);\n\tif (!rw)\n\t\treturn ERR_PTR(-ENOMEM);\n\treturn rw;\n}\n\nstatic inline void ref_walk_init(struct dfs_ref_walk *rw)\n{\n\tmemset(rw, 0, sizeof(*rw));\n\tref_walk_cur(rw) = ref_walk_start(rw);\n}\n\nstatic inline void __ref_walk_free(struct dfs_ref *ref)\n{\n\tkfree(ref->path);\n\tkfree(ref->full_path);\n\tdfs_cache_free_tgts(&ref->tl);\n\tmemset(ref, 0, sizeof(*ref));\n}\n\nstatic inline void ref_walk_free(struct dfs_ref_walk *rw)\n{\n\tstruct dfs_ref *ref = ref_walk_start(rw);\n\n\tfor (; ref <= ref_walk_end(rw); ref++)\n\t\t__ref_walk_free(ref);\n\tkfree(rw);\n}\n\nstatic inline int ref_walk_advance(struct dfs_ref_walk *rw)\n{\n\tstruct dfs_ref *ref = ref_walk_cur(rw) + 1;\n\n\tif (ref > ref_walk_end(rw))\n\t\treturn -ELOOP;\n\t__ref_walk_free(ref);\n\tref_walk_cur(rw) = ref;\n\treturn 0;\n}\n\nstatic inline struct dfs_cache_tgt_iterator *\nref_walk_next_tgt(struct dfs_ref_walk *rw)\n{\n\tstruct dfs_cache_tgt_iterator *tit;\n\tstruct dfs_ref *ref = ref_walk_cur(rw);\n\n\tif (!ref->tit)\n\t\ttit = dfs_cache_get_tgt_iterator(&ref->tl);\n\telse\n\t\ttit = dfs_cache_get_next_tgt(&ref->tl, ref->tit);\n\tref->tit = tit;\n\treturn tit;\n}\n\nstatic inline int ref_walk_get_tgt(struct dfs_ref_walk *rw,\n\t\t\t\t   struct dfs_info3_param *tgt)\n{\n\tzfree_dfs_info_param(tgt);\n\treturn dfs_cache_get_tgt_referral(ref_walk_path(rw) + 1,\n\t\t\t\t\t  ref_walk_tit(rw), tgt);\n}\n\nstatic inline int ref_walk_num_tgts(struct dfs_ref_walk *rw)\n{\n\treturn dfs_cache_get_nr_tgts(ref_walk_tl(rw));\n}\n\nstatic inline void ref_walk_set_tgt_hint(struct dfs_ref_walk *rw)\n{\n\tdfs_cache_noreq_update_tgthint(ref_walk_path(rw) + 1,\n\t\t\t\t       ref_walk_tit(rw));\n}\n\nstruct dfs_root_ses {\n\tstruct list_head list;\n\tstruct cifs_ses *ses;\n};\n\nint dfs_parse_target_referral(const char *full_path, const struct dfs_info3_param *ref,\n\t\t\t      struct smb3_fs_context *ctx);\nint dfs_mount_share(struct cifs_mount_ctx *mnt_ctx, bool *isdfs);\n\nstatic inline char *dfs_get_path(struct cifs_sb_info *cifs_sb, const char *path)\n{\n\treturn dfs_cache_canonical_path(path, cifs_sb->local_nls, cifs_remap(cifs_sb));\n}\n\nstatic inline int dfs_get_referral(struct cifs_mount_ctx *mnt_ctx, const char *path,\n\t\t\t\t   struct dfs_info3_param *ref, struct dfs_cache_tgt_list *tl)\n{\n\tstruct smb3_fs_context *ctx = mnt_ctx->fs_ctx;\n\tstruct cifs_sb_info *cifs_sb = mnt_ctx->cifs_sb;\n\n\treturn dfs_cache_find(mnt_ctx->xid, ctx->dfs_root_ses, cifs_sb->local_nls,\n\t\t\t      cifs_remap(cifs_sb), path, ref, tl);\n}\n\nstatic inline void dfs_put_root_smb_sessions(struct list_head *head)\n{\n\tstruct dfs_root_ses *root, *tmp;\n\n\tlist_for_each_entry_safe(root, tmp, head, list) {\n\t\tlist_del_init(&root->list);\n\t\tcifs_put_smb_ses(root->ses);\n\t\tkfree(root);\n\t}\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}