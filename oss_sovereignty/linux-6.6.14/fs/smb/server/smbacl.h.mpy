{
  "module_name": "smbacl.h",
  "hash_id": "2591dcdb0f3763030357b87b83f6a3e142f3c424ab5c85880b9f285c7b893433",
  "original_prompt": "Ingested from linux-6.6.14/fs/smb/server/smbacl.h",
  "human_readable_source": " \n \n\n#ifndef _SMBACL_H\n#define _SMBACL_H\n\n#include <linux/fs.h>\n#include <linux/namei.h>\n#include <linux/posix_acl.h>\n#include <linux/mnt_idmapping.h>\n\n#include \"mgmt/tree_connect.h\"\n\n#define NUM_AUTHS (6)\t \n#define SID_MAX_SUB_AUTHORITIES (15)  \n\n \nenum {\n\tACCESS_ALLOWED,\n\tACCESS_DENIED,\n};\n\n \nenum {\n\tSIDOWNER = 1,\n\tSIDGROUP,\n\tSIDCREATOR_OWNER,\n\tSIDCREATOR_GROUP,\n\tSIDUNIX_USER,\n\tSIDUNIX_GROUP,\n\tSIDNFS_USER,\n\tSIDNFS_GROUP,\n\tSIDNFS_MODE,\n};\n\n \n#define SD_REVISION\t1\n\n \n#define OWNER_DEFAULTED\t\t0x0001\n#define GROUP_DEFAULTED\t\t0x0002\n#define DACL_PRESENT\t\t0x0004\n#define DACL_DEFAULTED\t\t0x0008\n#define SACL_PRESENT\t\t0x0010\n#define SACL_DEFAULTED\t\t0x0020\n#define DACL_TRUSTED\t\t0x0040\n#define SERVER_SECURITY\t\t0x0080\n#define DACL_AUTO_INHERIT_REQ\t0x0100\n#define SACL_AUTO_INHERIT_REQ\t0x0200\n#define DACL_AUTO_INHERITED\t0x0400\n#define SACL_AUTO_INHERITED\t0x0800\n#define DACL_PROTECTED\t\t0x1000\n#define SACL_PROTECTED\t\t0x2000\n#define RM_CONTROL_VALID\t0x4000\n#define SELF_RELATIVE\t\t0x8000\n\n \n#define ACCESS_ALLOWED_ACE_TYPE 0x00\n#define ACCESS_DENIED_ACE_TYPE  0x01\n#define SYSTEM_AUDIT_ACE_TYPE   0x02\n#define SYSTEM_ALARM_ACE_TYPE   0x03\n#define ACCESS_ALLOWED_COMPOUND_ACE_TYPE 0x04\n#define ACCESS_ALLOWED_OBJECT_ACE_TYPE  0x05\n#define ACCESS_DENIED_OBJECT_ACE_TYPE   0x06\n#define SYSTEM_AUDIT_OBJECT_ACE_TYPE    0x07\n#define SYSTEM_ALARM_OBJECT_ACE_TYPE    0x08\n#define ACCESS_ALLOWED_CALLBACK_ACE_TYPE 0x09\n#define ACCESS_DENIED_CALLBACK_ACE_TYPE 0x0A\n#define ACCESS_ALLOWED_CALLBACK_OBJECT_ACE_TYPE 0x0B\n#define ACCESS_DENIED_CALLBACK_OBJECT_ACE_TYPE  0x0C\n#define SYSTEM_AUDIT_CALLBACK_ACE_TYPE  0x0D\n#define SYSTEM_ALARM_CALLBACK_ACE_TYPE  0x0E  \n#define SYSTEM_AUDIT_CALLBACK_OBJECT_ACE_TYPE 0x0F\n#define SYSTEM_ALARM_CALLBACK_OBJECT_ACE_TYPE 0x10  \n#define SYSTEM_MANDATORY_LABEL_ACE_TYPE 0x11\n#define SYSTEM_RESOURCE_ATTRIBUTE_ACE_TYPE 0x12\n#define SYSTEM_SCOPED_POLICY_ID_ACE_TYPE 0x13\n\n \n#define OBJECT_INHERIT_ACE\t\t0x01\n#define CONTAINER_INHERIT_ACE\t\t0x02\n#define NO_PROPAGATE_INHERIT_ACE\t0x04\n#define INHERIT_ONLY_ACE\t\t0x08\n#define INHERITED_ACE\t\t\t0x10\n#define SUCCESSFUL_ACCESS_ACE_FLAG\t0x40\n#define FAILED_ACCESS_ACE_FLAG\t\t0x80\n\n \n#define SID_STRING_BASE_SIZE (2 + 3 + 15 + 1)\n#define SID_STRING_SUBAUTH_SIZE (11)  \n\n#define DOMAIN_USER_RID_LE\tcpu_to_le32(513)\n\nstruct ksmbd_conn;\n\nstruct smb_ntsd {\n\t__le16 revision;  \n\t__le16 type;\n\t__le32 osidoffset;\n\t__le32 gsidoffset;\n\t__le32 sacloffset;\n\t__le32 dacloffset;\n} __packed;\n\nstruct smb_sid {\n\t__u8 revision;  \n\t__u8 num_subauth;\n\t__u8 authority[NUM_AUTHS];\n\t__le32 sub_auth[SID_MAX_SUB_AUTHORITIES];  \n} __packed;\n\n \n#define CIFS_SID_BASE_SIZE (1 + 1 + NUM_AUTHS)\n\nstruct smb_acl {\n\t__le16 revision;  \n\t__le16 size;\n\t__le32 num_aces;\n} __packed;\n\nstruct smb_ace {\n\t__u8 type;\n\t__u8 flags;\n\t__le16 size;\n\t__le32 access_req;\n\tstruct smb_sid sid;  \n} __packed;\n\nstruct smb_fattr {\n\tkuid_t\tcf_uid;\n\tkgid_t\tcf_gid;\n\tumode_t\tcf_mode;\n\t__le32 daccess;\n\tstruct posix_acl *cf_acls;\n\tstruct posix_acl *cf_dacls;\n};\n\nstruct posix_ace_state {\n\tu32 allow;\n\tu32 deny;\n};\n\nstruct posix_user_ace_state {\n\tunion {\n\t\tkuid_t uid;\n\t\tkgid_t gid;\n\t};\n\tstruct posix_ace_state perms;\n};\n\nstruct posix_ace_state_array {\n\tint n;\n\tstruct posix_user_ace_state aces[];\n};\n\n \n\nstruct posix_acl_state {\n\tstruct posix_ace_state owner;\n\tstruct posix_ace_state group;\n\tstruct posix_ace_state other;\n\tstruct posix_ace_state everyone;\n\tstruct posix_ace_state mask;  \n\tstruct posix_ace_state_array *users;\n\tstruct posix_ace_state_array *groups;\n};\n\nint parse_sec_desc(struct mnt_idmap *idmap, struct smb_ntsd *pntsd,\n\t\t   int acl_len, struct smb_fattr *fattr);\nint build_sec_desc(struct mnt_idmap *idmap, struct smb_ntsd *pntsd,\n\t\t   struct smb_ntsd *ppntsd, int ppntsd_size, int addition_info,\n\t\t   __u32 *secdesclen, struct smb_fattr *fattr);\nint init_acl_state(struct posix_acl_state *state, int cnt);\nvoid free_acl_state(struct posix_acl_state *state);\nvoid posix_state_to_acl(struct posix_acl_state *state,\n\t\t\tstruct posix_acl_entry *pace);\nint compare_sids(const struct smb_sid *ctsid, const struct smb_sid *cwsid);\nbool smb_inherit_flags(int flags, bool is_dir);\nint smb_inherit_dacl(struct ksmbd_conn *conn, const struct path *path,\n\t\t     unsigned int uid, unsigned int gid);\nint smb_check_perm_dacl(struct ksmbd_conn *conn, const struct path *path,\n\t\t\t__le32 *pdaccess, int uid);\nint set_info_sec(struct ksmbd_conn *conn, struct ksmbd_tree_connect *tcon,\n\t\t const struct path *path, struct smb_ntsd *pntsd, int ntsd_len,\n\t\t bool type_check, bool get_write);\nvoid id_to_sid(unsigned int cid, uint sidtype, struct smb_sid *ssid);\nvoid ksmbd_init_domain(u32 *sub_auth);\n\nstatic inline uid_t posix_acl_uid_translate(struct mnt_idmap *idmap,\n\t\t\t\t\t    struct posix_acl_entry *pace)\n{\n\tvfsuid_t vfsuid;\n\n\t \n\tvfsuid = make_vfsuid(idmap, &init_user_ns, pace->e_uid);\n\n\t \n\treturn from_kuid(&init_user_ns, vfsuid_into_kuid(vfsuid));\n}\n\nstatic inline gid_t posix_acl_gid_translate(struct mnt_idmap *idmap,\n\t\t\t\t\t    struct posix_acl_entry *pace)\n{\n\tvfsgid_t vfsgid;\n\n\t \n\tvfsgid = make_vfsgid(idmap, &init_user_ns, pace->e_gid);\n\n\t \n\treturn from_kgid(&init_user_ns, vfsgid_into_kgid(vfsgid));\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}