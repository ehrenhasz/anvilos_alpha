{
  "module_name": "smb2ops.c",
  "hash_id": "86dae1c666daf4d1ab97f5e9c681601e7b598a5dc129ab6e70609e41de673cad",
  "original_prompt": "Ingested from linux-6.6.14/fs/smb/server/smb2ops.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include \"glob.h\"\n\n#include \"auth.h\"\n#include \"connection.h\"\n#include \"smb_common.h\"\n#include \"server.h\"\n\nstatic struct smb_version_values smb21_server_values = {\n\t.version_string = SMB21_VERSION_STRING,\n\t.protocol_id = SMB21_PROT_ID,\n\t.capabilities = SMB2_GLOBAL_CAP_LARGE_MTU,\n\t.max_read_size = SMB21_DEFAULT_IOSIZE,\n\t.max_write_size = SMB21_DEFAULT_IOSIZE,\n\t.max_trans_size = SMB21_DEFAULT_IOSIZE,\n\t.max_credits = SMB2_MAX_CREDITS,\n\t.large_lock_type = 0,\n\t.exclusive_lock_type = SMB2_LOCKFLAG_EXCLUSIVE,\n\t.shared_lock_type = SMB2_LOCKFLAG_SHARED,\n\t.unlock_lock_type = SMB2_LOCKFLAG_UNLOCK,\n\t.header_size = sizeof(struct smb2_hdr),\n\t.max_header_size = MAX_SMB2_HDR_SIZE,\n\t.read_rsp_size = sizeof(struct smb2_read_rsp),\n\t.lock_cmd = SMB2_LOCK,\n\t.cap_unix = 0,\n\t.cap_nt_find = SMB2_NT_FIND,\n\t.cap_large_files = SMB2_LARGE_FILES,\n\t.create_lease_size = sizeof(struct create_lease),\n\t.create_durable_size = sizeof(struct create_durable_rsp),\n\t.create_mxac_size = sizeof(struct create_mxac_rsp),\n\t.create_disk_id_size = sizeof(struct create_disk_id_rsp),\n\t.create_posix_size = sizeof(struct create_posix_rsp),\n};\n\nstatic struct smb_version_values smb30_server_values = {\n\t.version_string = SMB30_VERSION_STRING,\n\t.protocol_id = SMB30_PROT_ID,\n\t.capabilities = SMB2_GLOBAL_CAP_LARGE_MTU,\n\t.max_read_size = SMB3_DEFAULT_IOSIZE,\n\t.max_write_size = SMB3_DEFAULT_IOSIZE,\n\t.max_trans_size = SMB3_DEFAULT_TRANS_SIZE,\n\t.max_credits = SMB2_MAX_CREDITS,\n\t.large_lock_type = 0,\n\t.exclusive_lock_type = SMB2_LOCKFLAG_EXCLUSIVE,\n\t.shared_lock_type = SMB2_LOCKFLAG_SHARED,\n\t.unlock_lock_type = SMB2_LOCKFLAG_UNLOCK,\n\t.header_size = sizeof(struct smb2_hdr),\n\t.max_header_size = MAX_SMB2_HDR_SIZE,\n\t.read_rsp_size = sizeof(struct smb2_read_rsp),\n\t.lock_cmd = SMB2_LOCK,\n\t.cap_unix = 0,\n\t.cap_nt_find = SMB2_NT_FIND,\n\t.cap_large_files = SMB2_LARGE_FILES,\n\t.create_lease_size = sizeof(struct create_lease_v2),\n\t.create_durable_size = sizeof(struct create_durable_rsp),\n\t.create_durable_v2_size = sizeof(struct create_durable_v2_rsp),\n\t.create_mxac_size = sizeof(struct create_mxac_rsp),\n\t.create_disk_id_size = sizeof(struct create_disk_id_rsp),\n\t.create_posix_size = sizeof(struct create_posix_rsp),\n};\n\nstatic struct smb_version_values smb302_server_values = {\n\t.version_string = SMB302_VERSION_STRING,\n\t.protocol_id = SMB302_PROT_ID,\n\t.capabilities = SMB2_GLOBAL_CAP_LARGE_MTU,\n\t.max_read_size = SMB3_DEFAULT_IOSIZE,\n\t.max_write_size = SMB3_DEFAULT_IOSIZE,\n\t.max_trans_size = SMB3_DEFAULT_TRANS_SIZE,\n\t.max_credits = SMB2_MAX_CREDITS,\n\t.large_lock_type = 0,\n\t.exclusive_lock_type = SMB2_LOCKFLAG_EXCLUSIVE,\n\t.shared_lock_type = SMB2_LOCKFLAG_SHARED,\n\t.unlock_lock_type = SMB2_LOCKFLAG_UNLOCK,\n\t.header_size = sizeof(struct smb2_hdr),\n\t.max_header_size = MAX_SMB2_HDR_SIZE,\n\t.read_rsp_size = sizeof(struct smb2_read_rsp),\n\t.lock_cmd = SMB2_LOCK,\n\t.cap_unix = 0,\n\t.cap_nt_find = SMB2_NT_FIND,\n\t.cap_large_files = SMB2_LARGE_FILES,\n\t.create_lease_size = sizeof(struct create_lease_v2),\n\t.create_durable_size = sizeof(struct create_durable_rsp),\n\t.create_durable_v2_size = sizeof(struct create_durable_v2_rsp),\n\t.create_mxac_size = sizeof(struct create_mxac_rsp),\n\t.create_disk_id_size = sizeof(struct create_disk_id_rsp),\n\t.create_posix_size = sizeof(struct create_posix_rsp),\n};\n\nstatic struct smb_version_values smb311_server_values = {\n\t.version_string = SMB311_VERSION_STRING,\n\t.protocol_id = SMB311_PROT_ID,\n\t.capabilities = SMB2_GLOBAL_CAP_LARGE_MTU,\n\t.max_read_size = SMB3_DEFAULT_IOSIZE,\n\t.max_write_size = SMB3_DEFAULT_IOSIZE,\n\t.max_trans_size = SMB3_DEFAULT_TRANS_SIZE,\n\t.max_credits = SMB2_MAX_CREDITS,\n\t.large_lock_type = 0,\n\t.exclusive_lock_type = SMB2_LOCKFLAG_EXCLUSIVE,\n\t.shared_lock_type = SMB2_LOCKFLAG_SHARED,\n\t.unlock_lock_type = SMB2_LOCKFLAG_UNLOCK,\n\t.header_size = sizeof(struct smb2_hdr),\n\t.max_header_size = MAX_SMB2_HDR_SIZE,\n\t.read_rsp_size = sizeof(struct smb2_read_rsp),\n\t.lock_cmd = SMB2_LOCK,\n\t.cap_unix = 0,\n\t.cap_nt_find = SMB2_NT_FIND,\n\t.cap_large_files = SMB2_LARGE_FILES,\n\t.create_lease_size = sizeof(struct create_lease_v2),\n\t.create_durable_size = sizeof(struct create_durable_rsp),\n\t.create_durable_v2_size = sizeof(struct create_durable_v2_rsp),\n\t.create_mxac_size = sizeof(struct create_mxac_rsp),\n\t.create_disk_id_size = sizeof(struct create_disk_id_rsp),\n\t.create_posix_size = sizeof(struct create_posix_rsp),\n};\n\nstatic struct smb_version_ops smb2_0_server_ops = {\n\t.get_cmd_val\t\t=\tget_smb2_cmd_val,\n\t.init_rsp_hdr\t\t=\tinit_smb2_rsp_hdr,\n\t.set_rsp_status\t\t=\tset_smb2_rsp_status,\n\t.allocate_rsp_buf       =       smb2_allocate_rsp_buf,\n\t.set_rsp_credits\t=\tsmb2_set_rsp_credits,\n\t.check_user_session\t=\tsmb2_check_user_session,\n\t.get_ksmbd_tcon\t\t=\tsmb2_get_ksmbd_tcon,\n\t.is_sign_req\t\t=\tsmb2_is_sign_req,\n\t.check_sign_req\t\t=\tsmb2_check_sign_req,\n\t.set_sign_rsp\t\t=\tsmb2_set_sign_rsp\n};\n\nstatic struct smb_version_ops smb3_0_server_ops = {\n\t.get_cmd_val\t\t=\tget_smb2_cmd_val,\n\t.init_rsp_hdr\t\t=\tinit_smb2_rsp_hdr,\n\t.set_rsp_status\t\t=\tset_smb2_rsp_status,\n\t.allocate_rsp_buf       =       smb2_allocate_rsp_buf,\n\t.set_rsp_credits\t=\tsmb2_set_rsp_credits,\n\t.check_user_session\t=\tsmb2_check_user_session,\n\t.get_ksmbd_tcon\t\t=\tsmb2_get_ksmbd_tcon,\n\t.is_sign_req\t\t=\tsmb2_is_sign_req,\n\t.check_sign_req\t\t=\tsmb3_check_sign_req,\n\t.set_sign_rsp\t\t=\tsmb3_set_sign_rsp,\n\t.generate_signingkey\t=\tksmbd_gen_smb30_signingkey,\n\t.generate_encryptionkey\t=\tksmbd_gen_smb30_encryptionkey,\n\t.is_transform_hdr\t=\tsmb3_is_transform_hdr,\n\t.decrypt_req\t\t=\tsmb3_decrypt_req,\n\t.encrypt_resp\t\t=\tsmb3_encrypt_resp\n};\n\nstatic struct smb_version_ops smb3_11_server_ops = {\n\t.get_cmd_val\t\t=\tget_smb2_cmd_val,\n\t.init_rsp_hdr\t\t=\tinit_smb2_rsp_hdr,\n\t.set_rsp_status\t\t=\tset_smb2_rsp_status,\n\t.allocate_rsp_buf       =       smb2_allocate_rsp_buf,\n\t.set_rsp_credits\t=\tsmb2_set_rsp_credits,\n\t.check_user_session\t=\tsmb2_check_user_session,\n\t.get_ksmbd_tcon\t\t=\tsmb2_get_ksmbd_tcon,\n\t.is_sign_req\t\t=\tsmb2_is_sign_req,\n\t.check_sign_req\t\t=\tsmb3_check_sign_req,\n\t.set_sign_rsp\t\t=\tsmb3_set_sign_rsp,\n\t.generate_signingkey\t=\tksmbd_gen_smb311_signingkey,\n\t.generate_encryptionkey\t=\tksmbd_gen_smb311_encryptionkey,\n\t.is_transform_hdr\t=\tsmb3_is_transform_hdr,\n\t.decrypt_req\t\t=\tsmb3_decrypt_req,\n\t.encrypt_resp\t\t=\tsmb3_encrypt_resp\n};\n\nstatic struct smb_version_cmds smb2_0_server_cmds[NUMBER_OF_SMB2_COMMANDS] = {\n\t[SMB2_NEGOTIATE_HE]\t=\t{ .proc = smb2_negotiate_request, },\n\t[SMB2_SESSION_SETUP_HE] =\t{ .proc = smb2_sess_setup, },\n\t[SMB2_TREE_CONNECT_HE]  =\t{ .proc = smb2_tree_connect,},\n\t[SMB2_TREE_DISCONNECT_HE]  =\t{ .proc = smb2_tree_disconnect,},\n\t[SMB2_LOGOFF_HE]\t=\t{ .proc = smb2_session_logoff,},\n\t[SMB2_CREATE_HE]\t=\t{ .proc = smb2_open},\n\t[SMB2_QUERY_INFO_HE]\t=\t{ .proc = smb2_query_info},\n\t[SMB2_QUERY_DIRECTORY_HE] =\t{ .proc = smb2_query_dir},\n\t[SMB2_CLOSE_HE]\t\t=\t{ .proc = smb2_close},\n\t[SMB2_ECHO_HE]\t\t=\t{ .proc = smb2_echo},\n\t[SMB2_SET_INFO_HE]      =       { .proc = smb2_set_info},\n\t[SMB2_READ_HE]\t\t=\t{ .proc = smb2_read},\n\t[SMB2_WRITE_HE]\t\t=\t{ .proc = smb2_write},\n\t[SMB2_FLUSH_HE]\t\t=\t{ .proc = smb2_flush},\n\t[SMB2_CANCEL_HE]\t=\t{ .proc = smb2_cancel},\n\t[SMB2_LOCK_HE]\t\t=\t{ .proc = smb2_lock},\n\t[SMB2_IOCTL_HE]\t\t=\t{ .proc = smb2_ioctl},\n\t[SMB2_OPLOCK_BREAK_HE]\t=\t{ .proc = smb2_oplock_break},\n\t[SMB2_CHANGE_NOTIFY_HE]\t=\t{ .proc = smb2_notify},\n};\n\n \nvoid init_smb2_1_server(struct ksmbd_conn *conn)\n{\n\tconn->vals = &smb21_server_values;\n\tconn->ops = &smb2_0_server_ops;\n\tconn->cmds = smb2_0_server_cmds;\n\tconn->max_cmds = ARRAY_SIZE(smb2_0_server_cmds);\n\tconn->signing_algorithm = SIGNING_ALG_HMAC_SHA256_LE;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_LEASES)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_LEASING;\n}\n\n \nvoid init_smb3_0_server(struct ksmbd_conn *conn)\n{\n\tconn->vals = &smb30_server_values;\n\tconn->ops = &smb3_0_server_ops;\n\tconn->cmds = smb2_0_server_cmds;\n\tconn->max_cmds = ARRAY_SIZE(smb2_0_server_cmds);\n\tconn->signing_algorithm = SIGNING_ALG_AES_CMAC_LE;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_LEASES)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_LEASING |\n\t\t\tSMB2_GLOBAL_CAP_DIRECTORY_LEASING;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_ENCRYPTION &&\n\t    conn->cli_cap & SMB2_GLOBAL_CAP_ENCRYPTION)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_ENCRYPTION;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB3_MULTICHANNEL)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_MULTI_CHANNEL;\n}\n\n \nvoid init_smb3_02_server(struct ksmbd_conn *conn)\n{\n\tconn->vals = &smb302_server_values;\n\tconn->ops = &smb3_0_server_ops;\n\tconn->cmds = smb2_0_server_cmds;\n\tconn->max_cmds = ARRAY_SIZE(smb2_0_server_cmds);\n\tconn->signing_algorithm = SIGNING_ALG_AES_CMAC_LE;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_LEASES)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_LEASING |\n\t\t\tSMB2_GLOBAL_CAP_DIRECTORY_LEASING;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_ENCRYPTION ||\n\t    (!(server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_ENCRYPTION_OFF) &&\n\t     conn->cli_cap & SMB2_GLOBAL_CAP_ENCRYPTION))\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_ENCRYPTION;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB3_MULTICHANNEL)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_MULTI_CHANNEL;\n}\n\n \nint init_smb3_11_server(struct ksmbd_conn *conn)\n{\n\tconn->vals = &smb311_server_values;\n\tconn->ops = &smb3_11_server_ops;\n\tconn->cmds = smb2_0_server_cmds;\n\tconn->max_cmds = ARRAY_SIZE(smb2_0_server_cmds);\n\tconn->signing_algorithm = SIGNING_ALG_AES_CMAC_LE;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_LEASES)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_LEASING |\n\t\t\tSMB2_GLOBAL_CAP_DIRECTORY_LEASING;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_ENCRYPTION ||\n\t    (!(server_conf.flags & KSMBD_GLOBAL_FLAG_SMB2_ENCRYPTION_OFF) &&\n\t     conn->cli_cap & SMB2_GLOBAL_CAP_ENCRYPTION))\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_ENCRYPTION;\n\n\tif (server_conf.flags & KSMBD_GLOBAL_FLAG_SMB3_MULTICHANNEL)\n\t\tconn->vals->capabilities |= SMB2_GLOBAL_CAP_MULTI_CHANNEL;\n\n\tINIT_LIST_HEAD(&conn->preauth_sess_table);\n\treturn 0;\n}\n\nvoid init_smb2_max_read_size(unsigned int sz)\n{\n\tsz = clamp_val(sz, SMB3_MIN_IOSIZE, SMB3_MAX_IOSIZE);\n\tsmb21_server_values.max_read_size = sz;\n\tsmb30_server_values.max_read_size = sz;\n\tsmb302_server_values.max_read_size = sz;\n\tsmb311_server_values.max_read_size = sz;\n}\n\nvoid init_smb2_max_write_size(unsigned int sz)\n{\n\tsz = clamp_val(sz, SMB3_MIN_IOSIZE, SMB3_MAX_IOSIZE);\n\tsmb21_server_values.max_write_size = sz;\n\tsmb30_server_values.max_write_size = sz;\n\tsmb302_server_values.max_write_size = sz;\n\tsmb311_server_values.max_write_size = sz;\n}\n\nvoid init_smb2_max_trans_size(unsigned int sz)\n{\n\tsz = clamp_val(sz, SMB3_MIN_IOSIZE, SMB3_MAX_IOSIZE);\n\tsmb21_server_values.max_trans_size = sz;\n\tsmb30_server_values.max_trans_size = sz;\n\tsmb302_server_values.max_trans_size = sz;\n\tsmb311_server_values.max_trans_size = sz;\n}\n\nvoid init_smb2_max_credits(unsigned int sz)\n{\n\tsmb21_server_values.max_credits = sz;\n\tsmb30_server_values.max_credits = sz;\n\tsmb302_server_values.max_credits = sz;\n\tsmb311_server_values.max_credits = sz;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}