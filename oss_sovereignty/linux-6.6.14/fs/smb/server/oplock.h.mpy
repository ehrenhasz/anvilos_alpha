{
  "module_name": "oplock.h",
  "hash_id": "0cdba67965ce8fc3d91720ab7d439783654e09c3d7e382fd026f98d0c3fce157",
  "original_prompt": "Ingested from linux-6.6.14/fs/smb/server/oplock.h",
  "human_readable_source": " \n \n\n#ifndef __KSMBD_OPLOCK_H\n#define __KSMBD_OPLOCK_H\n\n#include \"smb_common.h\"\n\n#define OPLOCK_WAIT_TIME\t(35 * HZ)\n\n \n#define SMB2_OPLOCK_LEVEL_NONE          0x00\n#define SMB2_OPLOCK_LEVEL_II            0x01\n#define SMB2_OPLOCK_LEVEL_EXCLUSIVE     0x08\n#define SMB2_OPLOCK_LEVEL_BATCH         0x09\n#define SMB2_OPLOCK_LEVEL_LEASE         0xFF\n\n \n#define OPLOCK_STATE_NONE\t0x00\n#define OPLOCK_ACK_WAIT\t\t0x01\n#define OPLOCK_CLOSING\t\t0x02\n\n#define OPLOCK_WRITE_TO_READ\t\t0x01\n#define OPLOCK_READ_HANDLE_TO_READ\t0x02\n#define OPLOCK_WRITE_TO_NONE\t\t0x04\n#define OPLOCK_READ_TO_NONE\t\t0x08\n\nstruct lease_ctx_info {\n\t__u8\t\t\tlease_key[SMB2_LEASE_KEY_SIZE];\n\t__le32\t\t\treq_state;\n\t__le32\t\t\tflags;\n\t__le64\t\t\tduration;\n\t__u8\t\t\tparent_lease_key[SMB2_LEASE_KEY_SIZE];\n\t__le16\t\t\tepoch;\n\tint\t\t\tversion;\n\tbool\t\t\tis_dir;\n};\n\nstruct lease_table {\n\tchar\t\t\tclient_guid[SMB2_CLIENT_GUID_SIZE];\n\tstruct list_head\tlease_list;\n\tstruct list_head\tl_entry;\n\tspinlock_t\t\tlb_lock;\n};\n\nstruct lease {\n\t__u8\t\t\tlease_key[SMB2_LEASE_KEY_SIZE];\n\t__le32\t\t\tstate;\n\t__le32\t\t\tnew_state;\n\t__le32\t\t\tflags;\n\t__le64\t\t\tduration;\n\t__u8\t\t\tparent_lease_key[SMB2_LEASE_KEY_SIZE];\n\tint\t\t\tversion;\n\tunsigned short\t\tepoch;\n\tbool\t\t\tis_dir;\n\tstruct lease_table\t*l_lb;\n};\n\nstruct oplock_info {\n\tstruct ksmbd_conn\t*conn;\n\tstruct ksmbd_session\t*sess;\n\tstruct ksmbd_work\t*work;\n\tstruct ksmbd_file\t*o_fp;\n\tint                     level;\n\tint                     op_state;\n\tunsigned long\t\tpending_break;\n\tu64\t\t\tfid;\n\tatomic_t\t\tbreaking_cnt;\n\tatomic_t\t\trefcount;\n\t__u16                   Tid;\n\tbool\t\t\tis_lease;\n\tbool\t\t\topen_trunc;\t \n\tstruct lease\t\t*o_lease;\n\tstruct list_head        interim_list;\n\tstruct list_head        op_entry;\n\tstruct list_head        lease_entry;\n\twait_queue_head_t oplock_q;  \n\twait_queue_head_t oplock_brk;  \n\tstruct rcu_head\t\trcu_head;\n};\n\nstruct lease_break_info {\n\t__le32\t\t\tcurr_state;\n\t__le32\t\t\tnew_state;\n\t__le16\t\t\tepoch;\n\tchar\t\t\tlease_key[SMB2_LEASE_KEY_SIZE];\n};\n\nstruct oplock_break_info {\n\tint level;\n\tint open_trunc;\n\tint fid;\n};\n\nint smb_grant_oplock(struct ksmbd_work *work, int req_op_level,\n\t\t     u64 pid, struct ksmbd_file *fp, __u16 tid,\n\t\t     struct lease_ctx_info *lctx, int share_ret);\nvoid smb_break_all_levII_oplock(struct ksmbd_work *work,\n\t\t\t\tstruct ksmbd_file *fp, int is_trunc);\nint opinfo_write_to_read(struct oplock_info *opinfo);\nint opinfo_read_handle_to_read(struct oplock_info *opinfo);\nint opinfo_write_to_none(struct oplock_info *opinfo);\nint opinfo_read_to_none(struct oplock_info *opinfo);\nvoid close_id_del_oplock(struct ksmbd_file *fp);\nvoid smb_break_all_oplock(struct ksmbd_work *work, struct ksmbd_file *fp);\nstruct oplock_info *opinfo_get(struct ksmbd_file *fp);\nvoid opinfo_put(struct oplock_info *opinfo);\n\n \nvoid create_lease_buf(u8 *rbuf, struct lease *lease);\nstruct lease_ctx_info *parse_lease_state(void *open_req, bool is_dir);\n__u8 smb2_map_lease_to_oplock(__le32 lease_state);\nint lease_read_to_write(struct oplock_info *opinfo);\n\n \nvoid create_durable_rsp_buf(char *cc);\nvoid create_durable_v2_rsp_buf(char *cc, struct ksmbd_file *fp);\nvoid create_mxac_rsp_buf(char *cc, int maximal_access);\nvoid create_disk_id_rsp_buf(char *cc, __u64 file_id, __u64 vol_id);\nvoid create_posix_rsp_buf(char *cc, struct ksmbd_file *fp);\nstruct create_context *smb2_find_context_vals(void *open_req, const char *tag, int tag_len);\nstruct oplock_info *lookup_lease_in_table(struct ksmbd_conn *conn,\n\t\t\t\t\t  char *lease_key);\nint find_same_lease_key(struct ksmbd_session *sess, struct ksmbd_inode *ci,\n\t\t\tstruct lease_ctx_info *lctx);\nvoid destroy_lease_table(struct ksmbd_conn *conn);\nvoid smb_send_parent_lease_break_noti(struct ksmbd_file *fp,\n\t\t\t\t      struct lease_ctx_info *lctx);\nvoid smb_lazy_parent_lease_break_close(struct ksmbd_file *fp);\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}