{
  "module_name": "namei.c",
  "hash_id": "ef7ba73b26f933007df8bbaa09a121c4855b1a897bf00b53f1d7fdfc0a944bdc",
  "original_prompt": "Ingested from linux-6.6.14/fs/sysv/namei.c",
  "human_readable_source": "\n \n\n#include <linux/pagemap.h>\n#include \"sysv.h\"\n\nstatic int add_nondir(struct dentry *dentry, struct inode *inode)\n{\n\tint err = sysv_add_link(dentry, inode);\n\tif (!err) {\n\t\td_instantiate(dentry, inode);\n\t\treturn 0;\n\t}\n\tinode_dec_link_count(inode);\n\tiput(inode);\n\treturn err;\n}\n\nstatic struct dentry *sysv_lookup(struct inode * dir, struct dentry * dentry, unsigned int flags)\n{\n\tstruct inode * inode = NULL;\n\tino_t ino;\n\n\tif (dentry->d_name.len > SYSV_NAMELEN)\n\t\treturn ERR_PTR(-ENAMETOOLONG);\n\tino = sysv_inode_by_name(dentry);\n\tif (ino)\n\t\tinode = sysv_iget(dir->i_sb, ino);\n\treturn d_splice_alias(inode, dentry);\n}\n\nstatic int sysv_mknod(struct mnt_idmap *idmap, struct inode *dir,\n\t\t      struct dentry *dentry, umode_t mode, dev_t rdev)\n{\n\tstruct inode * inode;\n\tint err;\n\n\tif (!old_valid_dev(rdev))\n\t\treturn -EINVAL;\n\n\tinode = sysv_new_inode(dir, mode);\n\terr = PTR_ERR(inode);\n\n\tif (!IS_ERR(inode)) {\n\t\tsysv_set_inode(inode, rdev);\n\t\tmark_inode_dirty(inode);\n\t\terr = add_nondir(dentry, inode);\n\t}\n\treturn err;\n}\n\nstatic int sysv_create(struct mnt_idmap *idmap, struct inode *dir,\n\t\t       struct dentry *dentry, umode_t mode, bool excl)\n{\n\treturn sysv_mknod(&nop_mnt_idmap, dir, dentry, mode, 0);\n}\n\nstatic int sysv_symlink(struct mnt_idmap *idmap, struct inode *dir,\n\t\t\tstruct dentry *dentry, const char *symname)\n{\n\tint err = -ENAMETOOLONG;\n\tint l = strlen(symname)+1;\n\tstruct inode * inode;\n\n\tif (l > dir->i_sb->s_blocksize)\n\t\tgoto out;\n\n\tinode = sysv_new_inode(dir, S_IFLNK|0777);\n\terr = PTR_ERR(inode);\n\tif (IS_ERR(inode))\n\t\tgoto out;\n\t\n\tsysv_set_inode(inode, 0);\n\terr = page_symlink(inode, symname, l);\n\tif (err)\n\t\tgoto out_fail;\n\n\tmark_inode_dirty(inode);\n\terr = add_nondir(dentry, inode);\nout:\n\treturn err;\n\nout_fail:\n\tinode_dec_link_count(inode);\n\tiput(inode);\n\tgoto out;\n}\n\nstatic int sysv_link(struct dentry * old_dentry, struct inode * dir, \n\tstruct dentry * dentry)\n{\n\tstruct inode *inode = d_inode(old_dentry);\n\n\tinode_set_ctime_current(inode);\n\tinode_inc_link_count(inode);\n\tihold(inode);\n\n\treturn add_nondir(dentry, inode);\n}\n\nstatic int sysv_mkdir(struct mnt_idmap *idmap, struct inode *dir,\n\t\t      struct dentry *dentry, umode_t mode)\n{\n\tstruct inode * inode;\n\tint err;\n\n\tinode_inc_link_count(dir);\n\n\tinode = sysv_new_inode(dir, S_IFDIR|mode);\n\terr = PTR_ERR(inode);\n\tif (IS_ERR(inode))\n\t\tgoto out_dir;\n\n\tsysv_set_inode(inode, 0);\n\n\tinode_inc_link_count(inode);\n\n\terr = sysv_make_empty(inode, dir);\n\tif (err)\n\t\tgoto out_fail;\n\n\terr = sysv_add_link(dentry, inode);\n\tif (err)\n\t\tgoto out_fail;\n\n        d_instantiate(dentry, inode);\nout:\n\treturn err;\n\nout_fail:\n\tinode_dec_link_count(inode);\n\tinode_dec_link_count(inode);\n\tiput(inode);\nout_dir:\n\tinode_dec_link_count(dir);\n\tgoto out;\n}\n\nstatic int sysv_unlink(struct inode * dir, struct dentry * dentry)\n{\n\tstruct inode * inode = d_inode(dentry);\n\tstruct page * page;\n\tstruct sysv_dir_entry * de;\n\tint err;\n\n\tde = sysv_find_entry(dentry, &page);\n\tif (!de)\n\t\treturn -ENOENT;\n\n\terr = sysv_delete_entry(de, page);\n\tif (!err) {\n\t\tinode_set_ctime_to_ts(inode, inode_get_ctime(dir));\n\t\tinode_dec_link_count(inode);\n\t}\n\tunmap_and_put_page(page, de);\n\treturn err;\n}\n\nstatic int sysv_rmdir(struct inode * dir, struct dentry * dentry)\n{\n\tstruct inode *inode = d_inode(dentry);\n\tint err = -ENOTEMPTY;\n\n\tif (sysv_empty_dir(inode)) {\n\t\terr = sysv_unlink(dir, dentry);\n\t\tif (!err) {\n\t\t\tinode->i_size = 0;\n\t\t\tinode_dec_link_count(inode);\n\t\t\tinode_dec_link_count(dir);\n\t\t}\n\t}\n\treturn err;\n}\n\n \nstatic int sysv_rename(struct mnt_idmap *idmap, struct inode *old_dir,\n\t\t       struct dentry *old_dentry, struct inode *new_dir,\n\t\t       struct dentry *new_dentry, unsigned int flags)\n{\n\tstruct inode * old_inode = d_inode(old_dentry);\n\tstruct inode * new_inode = d_inode(new_dentry);\n\tstruct page * dir_page = NULL;\n\tstruct sysv_dir_entry * dir_de = NULL;\n\tstruct page * old_page;\n\tstruct sysv_dir_entry * old_de;\n\tint err = -ENOENT;\n\n\tif (flags & ~RENAME_NOREPLACE)\n\t\treturn -EINVAL;\n\n\told_de = sysv_find_entry(old_dentry, &old_page);\n\tif (!old_de)\n\t\tgoto out;\n\n\tif (S_ISDIR(old_inode->i_mode)) {\n\t\terr = -EIO;\n\t\tdir_de = sysv_dotdot(old_inode, &dir_page);\n\t\tif (!dir_de)\n\t\t\tgoto out_old;\n\t}\n\n\tif (new_inode) {\n\t\tstruct page * new_page;\n\t\tstruct sysv_dir_entry * new_de;\n\n\t\terr = -ENOTEMPTY;\n\t\tif (dir_de && !sysv_empty_dir(new_inode))\n\t\t\tgoto out_dir;\n\n\t\terr = -ENOENT;\n\t\tnew_de = sysv_find_entry(new_dentry, &new_page);\n\t\tif (!new_de)\n\t\t\tgoto out_dir;\n\t\terr = sysv_set_link(new_de, new_page, old_inode);\n\t\tunmap_and_put_page(new_page, new_de);\n\t\tif (err)\n\t\t\tgoto out_dir;\n\t\tinode_set_ctime_current(new_inode);\n\t\tif (dir_de)\n\t\t\tdrop_nlink(new_inode);\n\t\tinode_dec_link_count(new_inode);\n\t} else {\n\t\terr = sysv_add_link(new_dentry, old_inode);\n\t\tif (err)\n\t\t\tgoto out_dir;\n\t\tif (dir_de)\n\t\t\tinode_inc_link_count(new_dir);\n\t}\n\n\terr = sysv_delete_entry(old_de, old_page);\n\tif (err)\n\t\tgoto out_dir;\n\n\tmark_inode_dirty(old_inode);\n\n\tif (dir_de) {\n\t\terr = sysv_set_link(dir_de, dir_page, new_dir);\n\t\tif (!err)\n\t\t\tinode_dec_link_count(old_dir);\n\t}\n\nout_dir:\n\tif (dir_de)\n\t\tunmap_and_put_page(dir_page, dir_de);\nout_old:\n\tunmap_and_put_page(old_page, old_de);\nout:\n\treturn err;\n}\n\n \nconst struct inode_operations sysv_dir_inode_operations = {\n\t.create\t\t= sysv_create,\n\t.lookup\t\t= sysv_lookup,\n\t.link\t\t= sysv_link,\n\t.unlink\t\t= sysv_unlink,\n\t.symlink\t= sysv_symlink,\n\t.mkdir\t\t= sysv_mkdir,\n\t.rmdir\t\t= sysv_rmdir,\n\t.mknod\t\t= sysv_mknod,\n\t.rename\t\t= sysv_rename,\n\t.getattr\t= sysv_getattr,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}