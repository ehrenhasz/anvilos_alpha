{
  "module_name": "suballoc.c",
  "hash_id": "a466f6dadd5b76a090482edf0a67a9befceb5644e6ab78f0fac599f345089989",
  "original_prompt": "Ingested from linux-6.6.14/fs/ocfs2/suballoc.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/types.h>\n#include <linux/slab.h>\n#include <linux/highmem.h>\n\n#include <cluster/masklog.h>\n\n#include \"ocfs2.h\"\n\n#include \"alloc.h\"\n#include \"blockcheck.h\"\n#include \"dlmglue.h\"\n#include \"inode.h\"\n#include \"journal.h\"\n#include \"localalloc.h\"\n#include \"suballoc.h\"\n#include \"super.h\"\n#include \"sysfile.h\"\n#include \"uptodate.h\"\n#include \"ocfs2_trace.h\"\n\n#include \"buffer_head_io.h\"\n\n#define NOT_ALLOC_NEW_GROUP\t\t0\n#define ALLOC_NEW_GROUP\t\t\t0x1\n#define ALLOC_GROUPS_FROM_GLOBAL\t0x2\n\n#define OCFS2_MAX_TO_STEAL\t\t1024\n\nstruct ocfs2_suballoc_result {\n\tu64\t\tsr_bg_blkno;\t \n\tu64\t\tsr_bg_stable_blkno;  \n\tu64\t\tsr_blkno;\t \n\tunsigned int\tsr_bit_offset;\t \n\tunsigned int\tsr_bits;\t \n};\n\nstatic u64 ocfs2_group_from_res(struct ocfs2_suballoc_result *res)\n{\n\tif (res->sr_blkno == 0)\n\t\treturn 0;\n\n\tif (res->sr_bg_blkno)\n\t\treturn res->sr_bg_blkno;\n\n\treturn ocfs2_which_suballoc_group(res->sr_blkno, res->sr_bit_offset);\n}\n\nstatic inline u16 ocfs2_find_victim_chain(struct ocfs2_chain_list *cl);\nstatic int ocfs2_block_group_fill(handle_t *handle,\n\t\t\t\t  struct inode *alloc_inode,\n\t\t\t\t  struct buffer_head *bg_bh,\n\t\t\t\t  u64 group_blkno,\n\t\t\t\t  unsigned int group_clusters,\n\t\t\t\t  u16 my_chain,\n\t\t\t\t  struct ocfs2_chain_list *cl);\nstatic int ocfs2_block_group_alloc(struct ocfs2_super *osb,\n\t\t\t\t   struct inode *alloc_inode,\n\t\t\t\t   struct buffer_head *bh,\n\t\t\t\t   u64 max_block,\n\t\t\t\t   u64 *last_alloc_group,\n\t\t\t\t   int flags);\n\nstatic int ocfs2_cluster_group_search(struct inode *inode,\n\t\t\t\t      struct buffer_head *group_bh,\n\t\t\t\t      u32 bits_wanted, u32 min_bits,\n\t\t\t\t      u64 max_block,\n\t\t\t\t      struct ocfs2_suballoc_result *res);\nstatic int ocfs2_block_group_search(struct inode *inode,\n\t\t\t\t    struct buffer_head *group_bh,\n\t\t\t\t    u32 bits_wanted, u32 min_bits,\n\t\t\t\t    u64 max_block,\n\t\t\t\t    struct ocfs2_suballoc_result *res);\nstatic int ocfs2_claim_suballoc_bits(struct ocfs2_alloc_context *ac,\n\t\t\t\t     handle_t *handle,\n\t\t\t\t     u32 bits_wanted,\n\t\t\t\t     u32 min_bits,\n\t\t\t\t     struct ocfs2_suballoc_result *res);\nstatic int ocfs2_test_bg_bit_allocatable(struct buffer_head *bg_bh,\n\t\t\t\t\t int nr);\nstatic int ocfs2_relink_block_group(handle_t *handle,\n\t\t\t\t    struct inode *alloc_inode,\n\t\t\t\t    struct buffer_head *fe_bh,\n\t\t\t\t    struct buffer_head *bg_bh,\n\t\t\t\t    struct buffer_head *prev_bg_bh,\n\t\t\t\t    u16 chain);\nstatic inline int ocfs2_block_group_reasonably_empty(struct ocfs2_group_desc *bg,\n\t\t\t\t\t\t     u32 wanted);\nstatic inline u32 ocfs2_desc_bitmap_to_cluster_off(struct inode *inode,\n\t\t\t\t\t\t   u64 bg_blkno,\n\t\t\t\t\t\t   u16 bg_bit_off);\nstatic inline void ocfs2_block_to_cluster_group(struct inode *inode,\n\t\t\t\t\t\tu64 data_blkno,\n\t\t\t\t\t\tu64 *bg_blkno,\n\t\t\t\t\t\tu16 *bg_bit_off);\nstatic int ocfs2_reserve_clusters_with_limit(struct ocfs2_super *osb,\n\t\t\t\t\t     u32 bits_wanted, u64 max_block,\n\t\t\t\t\t     int flags,\n\t\t\t\t\t     struct ocfs2_alloc_context **ac);\n\nvoid ocfs2_free_ac_resource(struct ocfs2_alloc_context *ac)\n{\n\tstruct inode *inode = ac->ac_inode;\n\n\tif (inode) {\n\t\tif (ac->ac_which != OCFS2_AC_USE_LOCAL)\n\t\t\tocfs2_inode_unlock(inode, 1);\n\n\t\tinode_unlock(inode);\n\n\t\tiput(inode);\n\t\tac->ac_inode = NULL;\n\t}\n\tbrelse(ac->ac_bh);\n\tac->ac_bh = NULL;\n\tac->ac_resv = NULL;\n\tkfree(ac->ac_find_loc_priv);\n\tac->ac_find_loc_priv = NULL;\n}\n\nvoid ocfs2_free_alloc_context(struct ocfs2_alloc_context *ac)\n{\n\tocfs2_free_ac_resource(ac);\n\tkfree(ac);\n}\n\nstatic u32 ocfs2_bits_per_group(struct ocfs2_chain_list *cl)\n{\n\treturn (u32)le16_to_cpu(cl->cl_cpg) * (u32)le16_to_cpu(cl->cl_bpc);\n}\n\n#define do_error(fmt, ...)\t\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif (resize)\t\t\t\t\t\t\t\\\n\t\tmlog(ML_ERROR, fmt, ##__VA_ARGS__);\t\t\t\\\n\telse\t\t\t\t\t\t\t\t\\\n\t\treturn ocfs2_error(sb, fmt, ##__VA_ARGS__);\t\t\\\n} while (0)\n\nstatic int ocfs2_validate_gd_self(struct super_block *sb,\n\t\t\t\t  struct buffer_head *bh,\n\t\t\t\t  int resize)\n{\n\tstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\n\n\tif (!OCFS2_IS_VALID_GROUP_DESC(gd)) {\n\t\tdo_error(\"Group descriptor #%llu has bad signature %.*s\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr, 7,\n\t\t\t gd->bg_signature);\n\t}\n\n\tif (le64_to_cpu(gd->bg_blkno) != bh->b_blocknr) {\n\t\tdo_error(\"Group descriptor #%llu has an invalid bg_blkno of %llu\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t (unsigned long long)le64_to_cpu(gd->bg_blkno));\n\t}\n\n\tif (le32_to_cpu(gd->bg_generation) != OCFS2_SB(sb)->fs_generation) {\n\t\tdo_error(\"Group descriptor #%llu has an invalid fs_generation of #%u\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t le32_to_cpu(gd->bg_generation));\n\t}\n\n\tif (le16_to_cpu(gd->bg_free_bits_count) > le16_to_cpu(gd->bg_bits)) {\n\t\tdo_error(\"Group descriptor #%llu has bit count %u but claims that %u are free\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t le16_to_cpu(gd->bg_bits),\n\t\t\t le16_to_cpu(gd->bg_free_bits_count));\n\t}\n\n\tif (le16_to_cpu(gd->bg_bits) > (8 * le16_to_cpu(gd->bg_size))) {\n\t\tdo_error(\"Group descriptor #%llu has bit count %u but max bitmap bits of %u\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t le16_to_cpu(gd->bg_bits),\n\t\t\t 8 * le16_to_cpu(gd->bg_size));\n\t}\n\n\treturn 0;\n}\n\nstatic int ocfs2_validate_gd_parent(struct super_block *sb,\n\t\t\t\t    struct ocfs2_dinode *di,\n\t\t\t\t    struct buffer_head *bh,\n\t\t\t\t    int resize)\n{\n\tunsigned int max_bits;\n\tstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\n\n\tif (di->i_blkno != gd->bg_parent_dinode) {\n\t\tdo_error(\"Group descriptor #%llu has bad parent pointer (%llu, expected %llu)\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t (unsigned long long)le64_to_cpu(gd->bg_parent_dinode),\n\t\t\t (unsigned long long)le64_to_cpu(di->i_blkno));\n\t}\n\n\tmax_bits = le16_to_cpu(di->id2.i_chain.cl_cpg) * le16_to_cpu(di->id2.i_chain.cl_bpc);\n\tif (le16_to_cpu(gd->bg_bits) > max_bits) {\n\t\tdo_error(\"Group descriptor #%llu has bit count of %u\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t le16_to_cpu(gd->bg_bits));\n\t}\n\n\t \n\tif ((le16_to_cpu(gd->bg_chain) >\n\t     le16_to_cpu(di->id2.i_chain.cl_next_free_rec)) ||\n\t    ((le16_to_cpu(gd->bg_chain) ==\n\t     le16_to_cpu(di->id2.i_chain.cl_next_free_rec)) && !resize)) {\n\t\tdo_error(\"Group descriptor #%llu has bad chain %u\\n\",\n\t\t\t (unsigned long long)bh->b_blocknr,\n\t\t\t le16_to_cpu(gd->bg_chain));\n\t}\n\n\treturn 0;\n}\n\n#undef do_error\n\n \nint ocfs2_check_group_descriptor(struct super_block *sb,\n\t\t\t\t struct ocfs2_dinode *di,\n\t\t\t\t struct buffer_head *bh)\n{\n\tint rc;\n\tstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\n\n\tBUG_ON(!buffer_uptodate(bh));\n\n\t \n\trc = ocfs2_validate_meta_ecc(sb, bh->b_data, &gd->bg_check);\n\tif (rc) {\n\t\tmlog(ML_ERROR,\n\t\t     \"Checksum failed for group descriptor %llu\\n\",\n\t\t     (unsigned long long)bh->b_blocknr);\n\t} else\n\t\trc = ocfs2_validate_gd_self(sb, bh, 1);\n\tif (!rc)\n\t\trc = ocfs2_validate_gd_parent(sb, di, bh, 1);\n\n\treturn rc;\n}\n\nstatic int ocfs2_validate_group_descriptor(struct super_block *sb,\n\t\t\t\t\t   struct buffer_head *bh)\n{\n\tint rc;\n\tstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\n\n\ttrace_ocfs2_validate_group_descriptor(\n\t\t\t\t\t(unsigned long long)bh->b_blocknr);\n\n\tBUG_ON(!buffer_uptodate(bh));\n\n\t \n\trc = ocfs2_validate_meta_ecc(sb, bh->b_data, &gd->bg_check);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\n\treturn ocfs2_validate_gd_self(sb, bh, 0);\n}\n\nint ocfs2_read_group_descriptor(struct inode *inode, struct ocfs2_dinode *di,\n\t\t\t\tu64 gd_blkno, struct buffer_head **bh)\n{\n\tint rc;\n\tstruct buffer_head *tmp = *bh;\n\n\trc = ocfs2_read_block(INODE_CACHE(inode), gd_blkno, &tmp,\n\t\t\t      ocfs2_validate_group_descriptor);\n\tif (rc)\n\t\tgoto out;\n\n\trc = ocfs2_validate_gd_parent(inode->i_sb, di, tmp, 0);\n\tif (rc) {\n\t\tbrelse(tmp);\n\t\tgoto out;\n\t}\n\n\t \n\tif (!*bh)\n\t\t*bh = tmp;\n\nout:\n\treturn rc;\n}\n\nstatic void ocfs2_bg_discontig_add_extent(struct ocfs2_super *osb,\n\t\t\t\t\t  struct ocfs2_group_desc *bg,\n\t\t\t\t\t  struct ocfs2_chain_list *cl,\n\t\t\t\t\t  u64 p_blkno, unsigned int clusters)\n{\n\tstruct ocfs2_extent_list *el = &bg->bg_list;\n\tstruct ocfs2_extent_rec *rec;\n\n\tBUG_ON(!ocfs2_supports_discontig_bg(osb));\n\tif (!el->l_next_free_rec)\n\t\tel->l_count = cpu_to_le16(ocfs2_extent_recs_per_gd(osb->sb));\n\trec = &el->l_recs[le16_to_cpu(el->l_next_free_rec)];\n\trec->e_blkno = cpu_to_le64(p_blkno);\n\trec->e_cpos = cpu_to_le32(le16_to_cpu(bg->bg_bits) /\n\t\t\t\t  le16_to_cpu(cl->cl_bpc));\n\trec->e_leaf_clusters = cpu_to_le16(clusters);\n\tle16_add_cpu(&bg->bg_bits, clusters * le16_to_cpu(cl->cl_bpc));\n\tle16_add_cpu(&bg->bg_free_bits_count,\n\t\t     clusters * le16_to_cpu(cl->cl_bpc));\n\tle16_add_cpu(&el->l_next_free_rec, 1);\n}\n\nstatic int ocfs2_block_group_fill(handle_t *handle,\n\t\t\t\t  struct inode *alloc_inode,\n\t\t\t\t  struct buffer_head *bg_bh,\n\t\t\t\t  u64 group_blkno,\n\t\t\t\t  unsigned int group_clusters,\n\t\t\t\t  u16 my_chain,\n\t\t\t\t  struct ocfs2_chain_list *cl)\n{\n\tint status = 0;\n\tstruct ocfs2_super *osb = OCFS2_SB(alloc_inode->i_sb);\n\tstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\n\tstruct super_block * sb = alloc_inode->i_sb;\n\n\tif (((unsigned long long) bg_bh->b_blocknr) != group_blkno) {\n\t\tstatus = ocfs2_error(alloc_inode->i_sb,\n\t\t\t\t     \"group block (%llu) != b_blocknr (%llu)\\n\",\n\t\t\t\t     (unsigned long long)group_blkno,\n\t\t\t\t     (unsigned long long) bg_bh->b_blocknr);\n\t\tgoto bail;\n\t}\n\n\tstatus = ocfs2_journal_access_gd(handle,\n\t\t\t\t\t INODE_CACHE(alloc_inode),\n\t\t\t\t\t bg_bh,\n\t\t\t\t\t OCFS2_JOURNAL_ACCESS_CREATE);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tmemset(bg, 0, sb->s_blocksize);\n\tstrcpy(bg->bg_signature, OCFS2_GROUP_DESC_SIGNATURE);\n\tbg->bg_generation = cpu_to_le32(osb->fs_generation);\n\tbg->bg_size = cpu_to_le16(ocfs2_group_bitmap_size(sb, 1,\n\t\t\t\t\t\tosb->s_feature_incompat));\n\tbg->bg_chain = cpu_to_le16(my_chain);\n\tbg->bg_next_group = cl->cl_recs[my_chain].c_blkno;\n\tbg->bg_parent_dinode = cpu_to_le64(OCFS2_I(alloc_inode)->ip_blkno);\n\tbg->bg_blkno = cpu_to_le64(group_blkno);\n\tif (group_clusters == le16_to_cpu(cl->cl_cpg))\n\t\tbg->bg_bits = cpu_to_le16(ocfs2_bits_per_group(cl));\n\telse\n\t\tocfs2_bg_discontig_add_extent(osb, bg, cl, group_blkno,\n\t\t\t\t\t      group_clusters);\n\n\t \n\tocfs2_set_bit(0, (unsigned long *)bg->bg_bitmap);\n\tbg->bg_free_bits_count = cpu_to_le16(le16_to_cpu(bg->bg_bits) - 1);\n\n\tocfs2_journal_dirty(handle, bg_bh);\n\n\t \n\nbail:\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nstatic inline u16 ocfs2_find_smallest_chain(struct ocfs2_chain_list *cl)\n{\n\tu16 curr, best;\n\n\tbest = curr = 0;\n\twhile (curr < le16_to_cpu(cl->cl_count)) {\n\t\tif (le32_to_cpu(cl->cl_recs[best].c_total) >\n\t\t    le32_to_cpu(cl->cl_recs[curr].c_total))\n\t\t\tbest = curr;\n\t\tcurr++;\n\t}\n\treturn best;\n}\n\nstatic struct buffer_head *\nocfs2_block_group_alloc_contig(struct ocfs2_super *osb, handle_t *handle,\n\t\t\t       struct inode *alloc_inode,\n\t\t\t       struct ocfs2_alloc_context *ac,\n\t\t\t       struct ocfs2_chain_list *cl)\n{\n\tint status;\n\tu32 bit_off, num_bits;\n\tu64 bg_blkno;\n\tstruct buffer_head *bg_bh;\n\tunsigned int alloc_rec = ocfs2_find_smallest_chain(cl);\n\n\tstatus = ocfs2_claim_clusters(handle, ac,\n\t\t\t\t      le16_to_cpu(cl->cl_cpg), &bit_off,\n\t\t\t\t      &num_bits);\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\t \n\tbg_blkno = ocfs2_clusters_to_blocks(osb->sb, bit_off);\n\ttrace_ocfs2_block_group_alloc_contig(\n\t     (unsigned long long)bg_blkno, alloc_rec);\n\n\tbg_bh = sb_getblk(osb->sb, bg_blkno);\n\tif (!bg_bh) {\n\t\tstatus = -ENOMEM;\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tocfs2_set_new_buffer_uptodate(INODE_CACHE(alloc_inode), bg_bh);\n\n\tstatus = ocfs2_block_group_fill(handle, alloc_inode, bg_bh,\n\t\t\t\t\tbg_blkno, num_bits, alloc_rec, cl);\n\tif (status < 0) {\n\t\tbrelse(bg_bh);\n\t\tmlog_errno(status);\n\t}\n\nbail:\n\treturn status ? ERR_PTR(status) : bg_bh;\n}\n\nstatic int ocfs2_block_group_claim_bits(struct ocfs2_super *osb,\n\t\t\t\t\thandle_t *handle,\n\t\t\t\t\tstruct ocfs2_alloc_context *ac,\n\t\t\t\t\tunsigned int min_bits,\n\t\t\t\t\tu32 *bit_off, u32 *num_bits)\n{\n\tint status = 0;\n\n\twhile (min_bits) {\n\t\tstatus = ocfs2_claim_clusters(handle, ac, min_bits,\n\t\t\t\t\t      bit_off, num_bits);\n\t\tif (status != -ENOSPC)\n\t\t\tbreak;\n\n\t\tmin_bits >>= 1;\n\t}\n\n\treturn status;\n}\n\nstatic int ocfs2_block_group_grow_discontig(handle_t *handle,\n\t\t\t\t\t    struct inode *alloc_inode,\n\t\t\t\t\t    struct buffer_head *bg_bh,\n\t\t\t\t\t    struct ocfs2_alloc_context *ac,\n\t\t\t\t\t    struct ocfs2_chain_list *cl,\n\t\t\t\t\t    unsigned int min_bits)\n{\n\tint status;\n\tstruct ocfs2_super *osb = OCFS2_SB(alloc_inode->i_sb);\n\tstruct ocfs2_group_desc *bg =\n\t\t(struct ocfs2_group_desc *)bg_bh->b_data;\n\tunsigned int needed = le16_to_cpu(cl->cl_cpg) -\n\t\t\t le16_to_cpu(bg->bg_bits) / le16_to_cpu(cl->cl_bpc);\n\tu32 p_cpos, clusters;\n\tu64 p_blkno;\n\tstruct ocfs2_extent_list *el = &bg->bg_list;\n\n\tstatus = ocfs2_journal_access_gd(handle,\n\t\t\t\t\t INODE_CACHE(alloc_inode),\n\t\t\t\t\t bg_bh,\n\t\t\t\t\t OCFS2_JOURNAL_ACCESS_CREATE);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\twhile ((needed > 0) && (le16_to_cpu(el->l_next_free_rec) <\n\t\t\t\tle16_to_cpu(el->l_count))) {\n\t\tif (min_bits > needed)\n\t\t\tmin_bits = needed;\n\t\tstatus = ocfs2_block_group_claim_bits(osb, handle, ac,\n\t\t\t\t\t\t      min_bits, &p_cpos,\n\t\t\t\t\t\t      &clusters);\n\t\tif (status < 0) {\n\t\t\tif (status != -ENOSPC)\n\t\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t\tp_blkno = ocfs2_clusters_to_blocks(osb->sb, p_cpos);\n\t\tocfs2_bg_discontig_add_extent(osb, bg, cl, p_blkno,\n\t\t\t\t\t      clusters);\n\n\t\tmin_bits = clusters;\n\t\tneeded = le16_to_cpu(cl->cl_cpg) -\n\t\t\t le16_to_cpu(bg->bg_bits) / le16_to_cpu(cl->cl_bpc);\n\t}\n\n\tif (needed > 0) {\n\t\t \n\t\tstatus = -ENOSPC;\n\t\tgoto bail;\n\t}\n\n\tocfs2_journal_dirty(handle, bg_bh);\n\nbail:\n\treturn status;\n}\n\nstatic void ocfs2_bg_alloc_cleanup(handle_t *handle,\n\t\t\t\t   struct ocfs2_alloc_context *cluster_ac,\n\t\t\t\t   struct inode *alloc_inode,\n\t\t\t\t   struct buffer_head *bg_bh)\n{\n\tint i, ret;\n\tstruct ocfs2_group_desc *bg;\n\tstruct ocfs2_extent_list *el;\n\tstruct ocfs2_extent_rec *rec;\n\n\tif (!bg_bh)\n\t\treturn;\n\n\tbg = (struct ocfs2_group_desc *)bg_bh->b_data;\n\tel = &bg->bg_list;\n\tfor (i = 0; i < le16_to_cpu(el->l_next_free_rec); i++) {\n\t\trec = &el->l_recs[i];\n\t\tret = ocfs2_free_clusters(handle, cluster_ac->ac_inode,\n\t\t\t\t\t  cluster_ac->ac_bh,\n\t\t\t\t\t  le64_to_cpu(rec->e_blkno),\n\t\t\t\t\t  le16_to_cpu(rec->e_leaf_clusters));\n\t\tif (ret)\n\t\t\tmlog_errno(ret);\n\t\t \n\t}\n\n\tocfs2_remove_from_cache(INODE_CACHE(alloc_inode), bg_bh);\n\tbrelse(bg_bh);\n}\n\nstatic struct buffer_head *\nocfs2_block_group_alloc_discontig(handle_t *handle,\n\t\t\t\t  struct inode *alloc_inode,\n\t\t\t\t  struct ocfs2_alloc_context *ac,\n\t\t\t\t  struct ocfs2_chain_list *cl)\n{\n\tint status;\n\tu32 bit_off, num_bits;\n\tu64 bg_blkno;\n\tunsigned int min_bits = le16_to_cpu(cl->cl_cpg) >> 1;\n\tstruct buffer_head *bg_bh = NULL;\n\tunsigned int alloc_rec = ocfs2_find_smallest_chain(cl);\n\tstruct ocfs2_super *osb = OCFS2_SB(alloc_inode->i_sb);\n\n\tif (!ocfs2_supports_discontig_bg(osb)) {\n\t\tstatus = -ENOSPC;\n\t\tgoto bail;\n\t}\n\n\tstatus = ocfs2_extend_trans(handle,\n\t\t\t\t    ocfs2_calc_bg_discontig_credits(osb->sb));\n\tif (status) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\t \n\tac->ac_disable_chain_relink = 1;\n\n\t \n\tstatus = ocfs2_block_group_claim_bits(osb, handle, ac, min_bits,\n\t\t\t\t\t      &bit_off, &num_bits);\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tmin_bits = num_bits;\n\n\t \n\tbg_blkno = ocfs2_clusters_to_blocks(osb->sb, bit_off);\n\ttrace_ocfs2_block_group_alloc_discontig(\n\t\t\t\t(unsigned long long)bg_blkno, alloc_rec);\n\n\tbg_bh = sb_getblk(osb->sb, bg_blkno);\n\tif (!bg_bh) {\n\t\tstatus = -ENOMEM;\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tocfs2_set_new_buffer_uptodate(INODE_CACHE(alloc_inode), bg_bh);\n\n\tstatus = ocfs2_block_group_fill(handle, alloc_inode, bg_bh,\n\t\t\t\t\tbg_blkno, num_bits, alloc_rec, cl);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tstatus = ocfs2_block_group_grow_discontig(handle, alloc_inode,\n\t\t\t\t\t\t  bg_bh, ac, cl, min_bits);\n\tif (status)\n\t\tmlog_errno(status);\n\nbail:\n\tif (status)\n\t\tocfs2_bg_alloc_cleanup(handle, ac, alloc_inode, bg_bh);\n\treturn status ? ERR_PTR(status) : bg_bh;\n}\n\n \nstatic int ocfs2_block_group_alloc(struct ocfs2_super *osb,\n\t\t\t\t   struct inode *alloc_inode,\n\t\t\t\t   struct buffer_head *bh,\n\t\t\t\t   u64 max_block,\n\t\t\t\t   u64 *last_alloc_group,\n\t\t\t\t   int flags)\n{\n\tint status, credits;\n\tstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) bh->b_data;\n\tstruct ocfs2_chain_list *cl;\n\tstruct ocfs2_alloc_context *ac = NULL;\n\thandle_t *handle = NULL;\n\tu16 alloc_rec;\n\tstruct buffer_head *bg_bh = NULL;\n\tstruct ocfs2_group_desc *bg;\n\n\tBUG_ON(ocfs2_is_cluster_bitmap(alloc_inode));\n\n\tcl = &fe->id2.i_chain;\n\tstatus = ocfs2_reserve_clusters_with_limit(osb,\n\t\t\t\t\t\t   le16_to_cpu(cl->cl_cpg),\n\t\t\t\t\t\t   max_block, flags, &ac);\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tcredits = ocfs2_calc_group_alloc_credits(osb->sb,\n\t\t\t\t\t\t le16_to_cpu(cl->cl_cpg));\n\thandle = ocfs2_start_trans(osb, credits);\n\tif (IS_ERR(handle)) {\n\t\tstatus = PTR_ERR(handle);\n\t\thandle = NULL;\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tif (last_alloc_group && *last_alloc_group != 0) {\n\t\ttrace_ocfs2_block_group_alloc(\n\t\t\t\t(unsigned long long)*last_alloc_group);\n\t\tac->ac_last_group = *last_alloc_group;\n\t}\n\n\tbg_bh = ocfs2_block_group_alloc_contig(osb, handle, alloc_inode,\n\t\t\t\t\t       ac, cl);\n\tif (PTR_ERR(bg_bh) == -ENOSPC)\n\t\tbg_bh = ocfs2_block_group_alloc_discontig(handle,\n\t\t\t\t\t\t\t  alloc_inode,\n\t\t\t\t\t\t\t  ac, cl);\n\tif (IS_ERR(bg_bh)) {\n\t\tstatus = PTR_ERR(bg_bh);\n\t\tbg_bh = NULL;\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tbg = (struct ocfs2_group_desc *) bg_bh->b_data;\n\n\tstatus = ocfs2_journal_access_di(handle, INODE_CACHE(alloc_inode),\n\t\t\t\t\t bh, OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\talloc_rec = le16_to_cpu(bg->bg_chain);\n\tle32_add_cpu(&cl->cl_recs[alloc_rec].c_free,\n\t\t     le16_to_cpu(bg->bg_free_bits_count));\n\tle32_add_cpu(&cl->cl_recs[alloc_rec].c_total,\n\t\t     le16_to_cpu(bg->bg_bits));\n\tcl->cl_recs[alloc_rec].c_blkno = bg->bg_blkno;\n\tif (le16_to_cpu(cl->cl_next_free_rec) < le16_to_cpu(cl->cl_count))\n\t\tle16_add_cpu(&cl->cl_next_free_rec, 1);\n\n\tle32_add_cpu(&fe->id1.bitmap1.i_used, le16_to_cpu(bg->bg_bits) -\n\t\t\t\t\tle16_to_cpu(bg->bg_free_bits_count));\n\tle32_add_cpu(&fe->id1.bitmap1.i_total, le16_to_cpu(bg->bg_bits));\n\tle32_add_cpu(&fe->i_clusters, le16_to_cpu(cl->cl_cpg));\n\n\tocfs2_journal_dirty(handle, bh);\n\n\tspin_lock(&OCFS2_I(alloc_inode)->ip_lock);\n\tOCFS2_I(alloc_inode)->ip_clusters = le32_to_cpu(fe->i_clusters);\n\tfe->i_size = cpu_to_le64(ocfs2_clusters_to_bytes(alloc_inode->i_sb,\n\t\t\t\t\t     le32_to_cpu(fe->i_clusters)));\n\tspin_unlock(&OCFS2_I(alloc_inode)->ip_lock);\n\ti_size_write(alloc_inode, le64_to_cpu(fe->i_size));\n\talloc_inode->i_blocks = ocfs2_inode_sector_count(alloc_inode);\n\tocfs2_update_inode_fsync_trans(handle, alloc_inode, 0);\n\n\tstatus = 0;\n\n\t \n\tif (last_alloc_group)\n\t\t*last_alloc_group = ac->ac_last_group;\n\nbail:\n\tif (handle)\n\t\tocfs2_commit_trans(osb, handle);\n\n\tif (ac)\n\t\tocfs2_free_alloc_context(ac);\n\n\tbrelse(bg_bh);\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nstatic int ocfs2_reserve_suballoc_bits(struct ocfs2_super *osb,\n\t\t\t\t       struct ocfs2_alloc_context *ac,\n\t\t\t\t       int type,\n\t\t\t\t       u32 slot,\n\t\t\t\t       u64 *last_alloc_group,\n\t\t\t\t       int flags)\n{\n\tint status;\n\tu32 bits_wanted = ac->ac_bits_wanted;\n\tstruct inode *alloc_inode;\n\tstruct buffer_head *bh = NULL;\n\tstruct ocfs2_dinode *fe;\n\tu32 free_bits;\n\n\talloc_inode = ocfs2_get_system_file_inode(osb, type, slot);\n\tif (!alloc_inode) {\n\t\tmlog_errno(-EINVAL);\n\t\treturn -EINVAL;\n\t}\n\n\tinode_lock(alloc_inode);\n\n\tstatus = ocfs2_inode_lock(alloc_inode, &bh, 1);\n\tif (status < 0) {\n\t\tinode_unlock(alloc_inode);\n\t\tiput(alloc_inode);\n\n\t\tmlog_errno(status);\n\t\treturn status;\n\t}\n\n\tac->ac_inode = alloc_inode;\n\tac->ac_alloc_slot = slot;\n\n\tfe = (struct ocfs2_dinode *) bh->b_data;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_DINODE(fe));\n\n\tif (!(fe->i_flags & cpu_to_le32(OCFS2_CHAIN_FL))) {\n\t\tstatus = ocfs2_error(alloc_inode->i_sb,\n\t\t\t\t     \"Invalid chain allocator %llu\\n\",\n\t\t\t\t     (unsigned long long)le64_to_cpu(fe->i_blkno));\n\t\tgoto bail;\n\t}\n\n\tfree_bits = le32_to_cpu(fe->id1.bitmap1.i_total) -\n\t\tle32_to_cpu(fe->id1.bitmap1.i_used);\n\n\tif (bits_wanted > free_bits) {\n\t\t \n\t\tif (ocfs2_is_cluster_bitmap(alloc_inode)) {\n\t\t\ttrace_ocfs2_reserve_suballoc_bits_nospc(bits_wanted,\n\t\t\t\t\t\t\t\tfree_bits);\n\t\t\tstatus = -ENOSPC;\n\t\t\tgoto bail;\n\t\t}\n\n\t\tif (!(flags & ALLOC_NEW_GROUP)) {\n\t\t\ttrace_ocfs2_reserve_suballoc_bits_no_new_group(\n\t\t\t\t\t\tslot, bits_wanted, free_bits);\n\t\t\tstatus = -ENOSPC;\n\t\t\tgoto bail;\n\t\t}\n\n\t\tstatus = ocfs2_block_group_alloc(osb, alloc_inode, bh,\n\t\t\t\t\t\t ac->ac_max_block,\n\t\t\t\t\t\t last_alloc_group, flags);\n\t\tif (status < 0) {\n\t\t\tif (status != -ENOSPC)\n\t\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t\tatomic_inc(&osb->alloc_stats.bg_extends);\n\n\t\t \n\t\tBUG_ON(bits_wanted >\n\t\t       (le32_to_cpu(fe->id1.bitmap1.i_total)\n\t\t\t- le32_to_cpu(fe->id1.bitmap1.i_used)));\n\t}\n\n\tget_bh(bh);\n\tac->ac_bh = bh;\nbail:\n\tbrelse(bh);\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nstatic void ocfs2_init_inode_steal_slot(struct ocfs2_super *osb)\n{\n\tspin_lock(&osb->osb_lock);\n\tosb->s_inode_steal_slot = OCFS2_INVALID_SLOT;\n\tspin_unlock(&osb->osb_lock);\n\tatomic_set(&osb->s_num_inodes_stolen, 0);\n}\n\nstatic void ocfs2_init_meta_steal_slot(struct ocfs2_super *osb)\n{\n\tspin_lock(&osb->osb_lock);\n\tosb->s_meta_steal_slot = OCFS2_INVALID_SLOT;\n\tspin_unlock(&osb->osb_lock);\n\tatomic_set(&osb->s_num_meta_stolen, 0);\n}\n\nvoid ocfs2_init_steal_slots(struct ocfs2_super *osb)\n{\n\tocfs2_init_inode_steal_slot(osb);\n\tocfs2_init_meta_steal_slot(osb);\n}\n\nstatic void __ocfs2_set_steal_slot(struct ocfs2_super *osb, int slot, int type)\n{\n\tspin_lock(&osb->osb_lock);\n\tif (type == INODE_ALLOC_SYSTEM_INODE)\n\t\tosb->s_inode_steal_slot = (u16)slot;\n\telse if (type == EXTENT_ALLOC_SYSTEM_INODE)\n\t\tosb->s_meta_steal_slot = (u16)slot;\n\tspin_unlock(&osb->osb_lock);\n}\n\nstatic int __ocfs2_get_steal_slot(struct ocfs2_super *osb, int type)\n{\n\tint slot = OCFS2_INVALID_SLOT;\n\n\tspin_lock(&osb->osb_lock);\n\tif (type == INODE_ALLOC_SYSTEM_INODE)\n\t\tslot = osb->s_inode_steal_slot;\n\telse if (type == EXTENT_ALLOC_SYSTEM_INODE)\n\t\tslot = osb->s_meta_steal_slot;\n\tspin_unlock(&osb->osb_lock);\n\n\treturn slot;\n}\n\nstatic int ocfs2_get_inode_steal_slot(struct ocfs2_super *osb)\n{\n\treturn __ocfs2_get_steal_slot(osb, INODE_ALLOC_SYSTEM_INODE);\n}\n\nstatic int ocfs2_get_meta_steal_slot(struct ocfs2_super *osb)\n{\n\treturn __ocfs2_get_steal_slot(osb, EXTENT_ALLOC_SYSTEM_INODE);\n}\n\nstatic int ocfs2_steal_resource(struct ocfs2_super *osb,\n\t\t\t\tstruct ocfs2_alloc_context *ac,\n\t\t\t\tint type)\n{\n\tint i, status = -ENOSPC;\n\tint slot = __ocfs2_get_steal_slot(osb, type);\n\n\t \n\tif (slot == OCFS2_INVALID_SLOT)\n\t\tslot = osb->slot_num + 1;\n\n\tfor (i = 0; i < osb->max_slots; i++, slot++) {\n\t\tif (slot == osb->max_slots)\n\t\t\tslot = 0;\n\n\t\tif (slot == osb->slot_num)\n\t\t\tcontinue;\n\n\t\tstatus = ocfs2_reserve_suballoc_bits(osb, ac,\n\t\t\t\t\t\t     type,\n\t\t\t\t\t\t     (u32)slot, NULL,\n\t\t\t\t\t\t     NOT_ALLOC_NEW_GROUP);\n\t\tif (status >= 0) {\n\t\t\t__ocfs2_set_steal_slot(osb, slot, type);\n\t\t\tbreak;\n\t\t}\n\n\t\tocfs2_free_ac_resource(ac);\n\t}\n\n\treturn status;\n}\n\nstatic int ocfs2_steal_inode(struct ocfs2_super *osb,\n\t\t\t     struct ocfs2_alloc_context *ac)\n{\n\treturn ocfs2_steal_resource(osb, ac, INODE_ALLOC_SYSTEM_INODE);\n}\n\nstatic int ocfs2_steal_meta(struct ocfs2_super *osb,\n\t\t\t    struct ocfs2_alloc_context *ac)\n{\n\treturn ocfs2_steal_resource(osb, ac, EXTENT_ALLOC_SYSTEM_INODE);\n}\n\nint ocfs2_reserve_new_metadata_blocks(struct ocfs2_super *osb,\n\t\t\t\t      int blocks,\n\t\t\t\t      struct ocfs2_alloc_context **ac)\n{\n\tint status;\n\tint slot = ocfs2_get_meta_steal_slot(osb);\n\n\t*ac = kzalloc(sizeof(struct ocfs2_alloc_context), GFP_KERNEL);\n\tif (!(*ac)) {\n\t\tstatus = -ENOMEM;\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\t(*ac)->ac_bits_wanted = blocks;\n\t(*ac)->ac_which = OCFS2_AC_USE_META;\n\t(*ac)->ac_group_search = ocfs2_block_group_search;\n\n\tif (slot != OCFS2_INVALID_SLOT &&\n\t\tatomic_read(&osb->s_num_meta_stolen) < OCFS2_MAX_TO_STEAL)\n\t\tgoto extent_steal;\n\n\tatomic_set(&osb->s_num_meta_stolen, 0);\n\tstatus = ocfs2_reserve_suballoc_bits(osb, (*ac),\n\t\t\t\t\t     EXTENT_ALLOC_SYSTEM_INODE,\n\t\t\t\t\t     (u32)osb->slot_num, NULL,\n\t\t\t\t\t     ALLOC_GROUPS_FROM_GLOBAL|ALLOC_NEW_GROUP);\n\n\n\tif (status >= 0) {\n\t\tstatus = 0;\n\t\tif (slot != OCFS2_INVALID_SLOT)\n\t\t\tocfs2_init_meta_steal_slot(osb);\n\t\tgoto bail;\n\t} else if (status < 0 && status != -ENOSPC) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tocfs2_free_ac_resource(*ac);\n\nextent_steal:\n\tstatus = ocfs2_steal_meta(osb, *ac);\n\tatomic_inc(&osb->s_num_meta_stolen);\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tstatus = 0;\nbail:\n\tif ((status < 0) && *ac) {\n\t\tocfs2_free_alloc_context(*ac);\n\t\t*ac = NULL;\n\t}\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nint ocfs2_reserve_new_metadata(struct ocfs2_super *osb,\n\t\t\t       struct ocfs2_extent_list *root_el,\n\t\t\t       struct ocfs2_alloc_context **ac)\n{\n\treturn ocfs2_reserve_new_metadata_blocks(osb,\n\t\t\t\t\tocfs2_extend_meta_needed(root_el),\n\t\t\t\t\tac);\n}\n\nint ocfs2_reserve_new_inode(struct ocfs2_super *osb,\n\t\t\t    struct ocfs2_alloc_context **ac)\n{\n\tint status;\n\tint slot = ocfs2_get_inode_steal_slot(osb);\n\tu64 alloc_group;\n\n\t*ac = kzalloc(sizeof(struct ocfs2_alloc_context), GFP_KERNEL);\n\tif (!(*ac)) {\n\t\tstatus = -ENOMEM;\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\t(*ac)->ac_bits_wanted = 1;\n\t(*ac)->ac_which = OCFS2_AC_USE_INODE;\n\n\t(*ac)->ac_group_search = ocfs2_block_group_search;\n\n\t \n\tif (!(osb->s_mount_opt & OCFS2_MOUNT_INODE64))\n\t\t(*ac)->ac_max_block = (u32)~0U;\n\n\t \n\tif (slot != OCFS2_INVALID_SLOT &&\n\t    atomic_read(&osb->s_num_inodes_stolen) < OCFS2_MAX_TO_STEAL)\n\t\tgoto inode_steal;\n\n\tatomic_set(&osb->s_num_inodes_stolen, 0);\n\talloc_group = osb->osb_inode_alloc_group;\n\tstatus = ocfs2_reserve_suballoc_bits(osb, *ac,\n\t\t\t\t\t     INODE_ALLOC_SYSTEM_INODE,\n\t\t\t\t\t     (u32)osb->slot_num,\n\t\t\t\t\t     &alloc_group,\n\t\t\t\t\t     ALLOC_NEW_GROUP |\n\t\t\t\t\t     ALLOC_GROUPS_FROM_GLOBAL);\n\tif (status >= 0) {\n\t\tstatus = 0;\n\n\t\tspin_lock(&osb->osb_lock);\n\t\tosb->osb_inode_alloc_group = alloc_group;\n\t\tspin_unlock(&osb->osb_lock);\n\t\ttrace_ocfs2_reserve_new_inode_new_group(\n\t\t\t(unsigned long long)alloc_group);\n\n\t\t \n\t\tif (slot != OCFS2_INVALID_SLOT)\n\t\t\tocfs2_init_inode_steal_slot(osb);\n\t\tgoto bail;\n\t} else if (status < 0 && status != -ENOSPC) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tocfs2_free_ac_resource(*ac);\n\ninode_steal:\n\tstatus = ocfs2_steal_inode(osb, *ac);\n\tatomic_inc(&osb->s_num_inodes_stolen);\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tstatus = 0;\nbail:\n\tif ((status < 0) && *ac) {\n\t\tocfs2_free_alloc_context(*ac);\n\t\t*ac = NULL;\n\t}\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\n \nint ocfs2_reserve_cluster_bitmap_bits(struct ocfs2_super *osb,\n\t\t\t\t      struct ocfs2_alloc_context *ac)\n{\n\tint status;\n\n\tac->ac_which = OCFS2_AC_USE_MAIN;\n\tac->ac_group_search = ocfs2_cluster_group_search;\n\n\tstatus = ocfs2_reserve_suballoc_bits(osb, ac,\n\t\t\t\t\t     GLOBAL_BITMAP_SYSTEM_INODE,\n\t\t\t\t\t     OCFS2_INVALID_SLOT, NULL,\n\t\t\t\t\t     ALLOC_NEW_GROUP);\n\tif (status < 0 && status != -ENOSPC)\n\t\tmlog_errno(status);\n\n\treturn status;\n}\n\n \nstatic int ocfs2_reserve_clusters_with_limit(struct ocfs2_super *osb,\n\t\t\t\t\t     u32 bits_wanted, u64 max_block,\n\t\t\t\t\t     int flags,\n\t\t\t\t\t     struct ocfs2_alloc_context **ac)\n{\n\tint status, ret = 0;\n\tint retried = 0;\n\n\t*ac = kzalloc(sizeof(struct ocfs2_alloc_context), GFP_KERNEL);\n\tif (!(*ac)) {\n\t\tstatus = -ENOMEM;\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\t(*ac)->ac_bits_wanted = bits_wanted;\n\t(*ac)->ac_max_block = max_block;\n\n\tstatus = -ENOSPC;\n\tif (!(flags & ALLOC_GROUPS_FROM_GLOBAL) &&\n\t    ocfs2_alloc_should_use_local(osb, bits_wanted)) {\n\t\tstatus = ocfs2_reserve_local_alloc_bits(osb,\n\t\t\t\t\t\t\tbits_wanted,\n\t\t\t\t\t\t\t*ac);\n\t\tif ((status < 0) && (status != -ENOSPC)) {\n\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t}\n\n\tif (status == -ENOSPC) {\nretry:\n\t\tstatus = ocfs2_reserve_cluster_bitmap_bits(osb, *ac);\n\t\t \n\t\tif (status == -ENOSPC && !retried) {\n\t\t\tretried = 1;\n\t\t\tocfs2_inode_unlock((*ac)->ac_inode, 1);\n\t\t\tinode_unlock((*ac)->ac_inode);\n\n\t\t\tret = ocfs2_try_to_free_truncate_log(osb, bits_wanted);\n\t\t\tif (ret == 1) {\n\t\t\t\tiput((*ac)->ac_inode);\n\t\t\t\t(*ac)->ac_inode = NULL;\n\t\t\t\tgoto retry;\n\t\t\t}\n\n\t\t\tif (ret < 0)\n\t\t\t\tmlog_errno(ret);\n\n\t\t\tinode_lock((*ac)->ac_inode);\n\t\t\tret = ocfs2_inode_lock((*ac)->ac_inode, NULL, 1);\n\t\t\tif (ret < 0) {\n\t\t\t\tmlog_errno(ret);\n\t\t\t\tinode_unlock((*ac)->ac_inode);\n\t\t\t\tiput((*ac)->ac_inode);\n\t\t\t\t(*ac)->ac_inode = NULL;\n\t\t\t\tgoto bail;\n\t\t\t}\n\t\t}\n\t\tif (status < 0) {\n\t\t\tif (status != -ENOSPC)\n\t\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t}\n\n\tstatus = 0;\nbail:\n\tif ((status < 0) && *ac) {\n\t\tocfs2_free_alloc_context(*ac);\n\t\t*ac = NULL;\n\t}\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nint ocfs2_reserve_clusters(struct ocfs2_super *osb,\n\t\t\t   u32 bits_wanted,\n\t\t\t   struct ocfs2_alloc_context **ac)\n{\n\treturn ocfs2_reserve_clusters_with_limit(osb, bits_wanted, 0,\n\t\t\t\t\t\t ALLOC_NEW_GROUP, ac);\n}\n\n \nstatic int ocfs2_test_bg_bit_allocatable(struct buffer_head *bg_bh,\n\t\t\t\t\t int nr)\n{\n\tstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\n\tstruct journal_head *jh;\n\tint ret;\n\n\tif (ocfs2_test_bit(nr, (unsigned long *)bg->bg_bitmap))\n\t\treturn 0;\n\n\tjh = jbd2_journal_grab_journal_head(bg_bh);\n\tif (!jh)\n\t\treturn 1;\n\n\tspin_lock(&jh->b_state_lock);\n\tbg = (struct ocfs2_group_desc *) jh->b_committed_data;\n\tif (bg)\n\t\tret = !ocfs2_test_bit(nr, (unsigned long *)bg->bg_bitmap);\n\telse\n\t\tret = 1;\n\tspin_unlock(&jh->b_state_lock);\n\tjbd2_journal_put_journal_head(jh);\n\n\treturn ret;\n}\n\nstatic int ocfs2_block_group_find_clear_bits(struct ocfs2_super *osb,\n\t\t\t\t\t     struct buffer_head *bg_bh,\n\t\t\t\t\t     unsigned int bits_wanted,\n\t\t\t\t\t     unsigned int total_bits,\n\t\t\t\t\t     struct ocfs2_suballoc_result *res)\n{\n\tvoid *bitmap;\n\tu16 best_offset, best_size;\n\tint offset, start, found, status = 0;\n\tstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\n\n\tfound = start = best_offset = best_size = 0;\n\tbitmap = bg->bg_bitmap;\n\n\twhile((offset = ocfs2_find_next_zero_bit(bitmap, total_bits, start)) != -1) {\n\t\tif (offset == total_bits)\n\t\t\tbreak;\n\n\t\tif (!ocfs2_test_bg_bit_allocatable(bg_bh, offset)) {\n\t\t\t \n\t\t\tfound = 0;\n\t\t\tstart = offset + 1;\n\t\t} else if (offset == start) {\n\t\t\t \n\t\t\tfound++;\n\t\t\t \n\t\t\tstart++;\n\t\t} else {\n\t\t\t \n\t\t\tfound = 1;\n\t\t\tstart = offset + 1;\n\t\t}\n\t\tif (found > best_size) {\n\t\t\tbest_size = found;\n\t\t\tbest_offset = start - found;\n\t\t}\n\t\t \n\t\tif (found == bits_wanted) {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (best_size) {\n\t\tres->sr_bit_offset = best_offset;\n\t\tres->sr_bits = best_size;\n\t} else {\n\t\tstatus = -ENOSPC;\n\t\t \n\t}\n\n\treturn status;\n}\n\nint ocfs2_block_group_set_bits(handle_t *handle,\n\t\t\t\t\t     struct inode *alloc_inode,\n\t\t\t\t\t     struct ocfs2_group_desc *bg,\n\t\t\t\t\t     struct buffer_head *group_bh,\n\t\t\t\t\t     unsigned int bit_off,\n\t\t\t\t\t     unsigned int num_bits)\n{\n\tint status;\n\tvoid *bitmap = bg->bg_bitmap;\n\tint journal_type = OCFS2_JOURNAL_ACCESS_WRITE;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\n\tBUG_ON(le16_to_cpu(bg->bg_free_bits_count) < num_bits);\n\n\ttrace_ocfs2_block_group_set_bits(bit_off, num_bits);\n\n\tif (ocfs2_is_cluster_bitmap(alloc_inode))\n\t\tjournal_type = OCFS2_JOURNAL_ACCESS_UNDO;\n\n\tstatus = ocfs2_journal_access_gd(handle,\n\t\t\t\t\t INODE_CACHE(alloc_inode),\n\t\t\t\t\t group_bh,\n\t\t\t\t\t journal_type);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tle16_add_cpu(&bg->bg_free_bits_count, -num_bits);\n\tif (le16_to_cpu(bg->bg_free_bits_count) > le16_to_cpu(bg->bg_bits)) {\n\t\treturn ocfs2_error(alloc_inode->i_sb, \"Group descriptor # %llu has bit count %u but claims %u are freed. num_bits %d\\n\",\n\t\t\t\t   (unsigned long long)le64_to_cpu(bg->bg_blkno),\n\t\t\t\t   le16_to_cpu(bg->bg_bits),\n\t\t\t\t   le16_to_cpu(bg->bg_free_bits_count),\n\t\t\t\t   num_bits);\n\t}\n\twhile(num_bits--)\n\t\tocfs2_set_bit(bit_off++, bitmap);\n\n\tocfs2_journal_dirty(handle, group_bh);\n\nbail:\n\treturn status;\n}\n\n \nstatic inline u16 ocfs2_find_victim_chain(struct ocfs2_chain_list *cl)\n{\n\tu16 curr, best;\n\n\tBUG_ON(!cl->cl_next_free_rec);\n\n\tbest = curr = 0;\n\twhile (curr < le16_to_cpu(cl->cl_next_free_rec)) {\n\t\tif (le32_to_cpu(cl->cl_recs[curr].c_free) >\n\t\t    le32_to_cpu(cl->cl_recs[best].c_free))\n\t\t\tbest = curr;\n\t\tcurr++;\n\t}\n\n\tBUG_ON(best >= le16_to_cpu(cl->cl_next_free_rec));\n\treturn best;\n}\n\nstatic int ocfs2_relink_block_group(handle_t *handle,\n\t\t\t\t    struct inode *alloc_inode,\n\t\t\t\t    struct buffer_head *fe_bh,\n\t\t\t\t    struct buffer_head *bg_bh,\n\t\t\t\t    struct buffer_head *prev_bg_bh,\n\t\t\t\t    u16 chain)\n{\n\tint status;\n\t \n\tu64 bg_ptr, prev_bg_ptr;\n\tstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) fe_bh->b_data;\n\tstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\n\tstruct ocfs2_group_desc *prev_bg = (struct ocfs2_group_desc *) prev_bg_bh->b_data;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\n\tBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(prev_bg));\n\n\ttrace_ocfs2_relink_block_group(\n\t\t(unsigned long long)le64_to_cpu(fe->i_blkno), chain,\n\t\t(unsigned long long)le64_to_cpu(bg->bg_blkno),\n\t\t(unsigned long long)le64_to_cpu(prev_bg->bg_blkno));\n\n\tbg_ptr = le64_to_cpu(bg->bg_next_group);\n\tprev_bg_ptr = le64_to_cpu(prev_bg->bg_next_group);\n\n\tstatus = ocfs2_journal_access_gd(handle, INODE_CACHE(alloc_inode),\n\t\t\t\t\t prev_bg_bh,\n\t\t\t\t\t OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (status < 0)\n\t\tgoto out;\n\n\tprev_bg->bg_next_group = bg->bg_next_group;\n\tocfs2_journal_dirty(handle, prev_bg_bh);\n\n\tstatus = ocfs2_journal_access_gd(handle, INODE_CACHE(alloc_inode),\n\t\t\t\t\t bg_bh, OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (status < 0)\n\t\tgoto out_rollback_prev_bg;\n\n\tbg->bg_next_group = fe->id2.i_chain.cl_recs[chain].c_blkno;\n\tocfs2_journal_dirty(handle, bg_bh);\n\n\tstatus = ocfs2_journal_access_di(handle, INODE_CACHE(alloc_inode),\n\t\t\t\t\t fe_bh, OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (status < 0)\n\t\tgoto out_rollback_bg;\n\n\tfe->id2.i_chain.cl_recs[chain].c_blkno = bg->bg_blkno;\n\tocfs2_journal_dirty(handle, fe_bh);\n\nout:\n\tif (status < 0)\n\t\tmlog_errno(status);\n\treturn status;\n\nout_rollback_bg:\n\tbg->bg_next_group = cpu_to_le64(bg_ptr);\nout_rollback_prev_bg:\n\tprev_bg->bg_next_group = cpu_to_le64(prev_bg_ptr);\n\tgoto out;\n}\n\nstatic inline int ocfs2_block_group_reasonably_empty(struct ocfs2_group_desc *bg,\n\t\t\t\t\t\t     u32 wanted)\n{\n\treturn le16_to_cpu(bg->bg_free_bits_count) > wanted;\n}\n\n \nstatic int ocfs2_cluster_group_search(struct inode *inode,\n\t\t\t\t      struct buffer_head *group_bh,\n\t\t\t\t      u32 bits_wanted, u32 min_bits,\n\t\t\t\t      u64 max_block,\n\t\t\t\t      struct ocfs2_suballoc_result *res)\n{\n\tint search = -ENOSPC;\n\tint ret;\n\tu64 blkoff;\n\tstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *) group_bh->b_data;\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\tunsigned int max_bits, gd_cluster_off;\n\n\tBUG_ON(!ocfs2_is_cluster_bitmap(inode));\n\n\tif (gd->bg_free_bits_count) {\n\t\tmax_bits = le16_to_cpu(gd->bg_bits);\n\n\t\t \n\t\tgd_cluster_off = ocfs2_blocks_to_clusters(inode->i_sb,\n\t\t\t\t\t\t\t  le64_to_cpu(gd->bg_blkno));\n\t\tif ((gd_cluster_off + max_bits) >\n\t\t    OCFS2_I(inode)->ip_clusters) {\n\t\t\tmax_bits = OCFS2_I(inode)->ip_clusters - gd_cluster_off;\n\t\t\ttrace_ocfs2_cluster_group_search_wrong_max_bits(\n\t\t\t\t(unsigned long long)le64_to_cpu(gd->bg_blkno),\n\t\t\t\tle16_to_cpu(gd->bg_bits),\n\t\t\t\tOCFS2_I(inode)->ip_clusters, max_bits);\n\t\t}\n\n\t\tret = ocfs2_block_group_find_clear_bits(osb,\n\t\t\t\t\t\t\tgroup_bh, bits_wanted,\n\t\t\t\t\t\t\tmax_bits, res);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (max_block) {\n\t\t\tblkoff = ocfs2_clusters_to_blocks(inode->i_sb,\n\t\t\t\t\t\t\t  gd_cluster_off +\n\t\t\t\t\t\t\t  res->sr_bit_offset +\n\t\t\t\t\t\t\t  res->sr_bits);\n\t\t\ttrace_ocfs2_cluster_group_search_max_block(\n\t\t\t\t(unsigned long long)blkoff,\n\t\t\t\t(unsigned long long)max_block);\n\t\t\tif (blkoff > max_block)\n\t\t\t\treturn -ENOSPC;\n\t\t}\n\n\t\t \n\t\tif (min_bits <= res->sr_bits)\n\t\t\tsearch = 0;  \n\t\telse if (res->sr_bits) {\n\t\t\t \n\t\t\tocfs2_local_alloc_seen_free_bits(osb, res->sr_bits);\n\t\t}\n\t}\n\n\treturn search;\n}\n\nstatic int ocfs2_block_group_search(struct inode *inode,\n\t\t\t\t    struct buffer_head *group_bh,\n\t\t\t\t    u32 bits_wanted, u32 min_bits,\n\t\t\t\t    u64 max_block,\n\t\t\t\t    struct ocfs2_suballoc_result *res)\n{\n\tint ret = -ENOSPC;\n\tu64 blkoff;\n\tstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) group_bh->b_data;\n\n\tBUG_ON(min_bits != 1);\n\tBUG_ON(ocfs2_is_cluster_bitmap(inode));\n\n\tif (bg->bg_free_bits_count) {\n\t\tret = ocfs2_block_group_find_clear_bits(OCFS2_SB(inode->i_sb),\n\t\t\t\t\t\t\tgroup_bh, bits_wanted,\n\t\t\t\t\t\t\tle16_to_cpu(bg->bg_bits),\n\t\t\t\t\t\t\tres);\n\t\tif (!ret && max_block) {\n\t\t\tblkoff = le64_to_cpu(bg->bg_blkno) +\n\t\t\t\tres->sr_bit_offset + res->sr_bits;\n\t\t\ttrace_ocfs2_block_group_search_max_block(\n\t\t\t\t(unsigned long long)blkoff,\n\t\t\t\t(unsigned long long)max_block);\n\t\t\tif (blkoff > max_block)\n\t\t\t\tret = -ENOSPC;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nint ocfs2_alloc_dinode_update_counts(struct inode *inode,\n\t\t\t\t       handle_t *handle,\n\t\t\t\t       struct buffer_head *di_bh,\n\t\t\t\t       u32 num_bits,\n\t\t\t\t       u16 chain)\n{\n\tint ret;\n\tu32 tmp_used;\n\tstruct ocfs2_dinode *di = (struct ocfs2_dinode *) di_bh->b_data;\n\tstruct ocfs2_chain_list *cl = (struct ocfs2_chain_list *) &di->id2.i_chain;\n\n\tret = ocfs2_journal_access_di(handle, INODE_CACHE(inode), di_bh,\n\t\t\t\t      OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (ret < 0) {\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\ttmp_used = le32_to_cpu(di->id1.bitmap1.i_used);\n\tdi->id1.bitmap1.i_used = cpu_to_le32(num_bits + tmp_used);\n\tle32_add_cpu(&cl->cl_recs[chain].c_free, -num_bits);\n\tocfs2_journal_dirty(handle, di_bh);\n\nout:\n\treturn ret;\n}\n\nvoid ocfs2_rollback_alloc_dinode_counts(struct inode *inode,\n\t\t\t\t       struct buffer_head *di_bh,\n\t\t\t\t       u32 num_bits,\n\t\t\t\t       u16 chain)\n{\n\tu32 tmp_used;\n\tstruct ocfs2_dinode *di = (struct ocfs2_dinode *) di_bh->b_data;\n\tstruct ocfs2_chain_list *cl;\n\n\tcl = (struct ocfs2_chain_list *)&di->id2.i_chain;\n\ttmp_used = le32_to_cpu(di->id1.bitmap1.i_used);\n\tdi->id1.bitmap1.i_used = cpu_to_le32(tmp_used - num_bits);\n\tle32_add_cpu(&cl->cl_recs[chain].c_free, num_bits);\n}\n\nstatic int ocfs2_bg_discontig_fix_by_rec(struct ocfs2_suballoc_result *res,\n\t\t\t\t\t struct ocfs2_extent_rec *rec,\n\t\t\t\t\t struct ocfs2_chain_list *cl)\n{\n\tunsigned int bpc = le16_to_cpu(cl->cl_bpc);\n\tunsigned int bitoff = le32_to_cpu(rec->e_cpos) * bpc;\n\tunsigned int bitcount = le16_to_cpu(rec->e_leaf_clusters) * bpc;\n\n\tif (res->sr_bit_offset < bitoff)\n\t\treturn 0;\n\tif (res->sr_bit_offset >= (bitoff + bitcount))\n\t\treturn 0;\n\tres->sr_blkno = le64_to_cpu(rec->e_blkno) +\n\t\t(res->sr_bit_offset - bitoff);\n\tif ((res->sr_bit_offset + res->sr_bits) > (bitoff + bitcount))\n\t\tres->sr_bits = (bitoff + bitcount) - res->sr_bit_offset;\n\treturn 1;\n}\n\nstatic void ocfs2_bg_discontig_fix_result(struct ocfs2_alloc_context *ac,\n\t\t\t\t\t  struct ocfs2_group_desc *bg,\n\t\t\t\t\t  struct ocfs2_suballoc_result *res)\n{\n\tint i;\n\tu64 bg_blkno = res->sr_bg_blkno;   \n\tstruct ocfs2_extent_rec *rec;\n\tstruct ocfs2_dinode *di = (struct ocfs2_dinode *)ac->ac_bh->b_data;\n\tstruct ocfs2_chain_list *cl = &di->id2.i_chain;\n\n\tif (ocfs2_is_cluster_bitmap(ac->ac_inode)) {\n\t\tres->sr_blkno = 0;\n\t\treturn;\n\t}\n\n\tres->sr_blkno = res->sr_bg_blkno + res->sr_bit_offset;\n\tres->sr_bg_blkno = 0;   \n\tif (!ocfs2_supports_discontig_bg(OCFS2_SB(ac->ac_inode->i_sb)) ||\n\t    !bg->bg_list.l_next_free_rec)\n\t\treturn;\n\n\tfor (i = 0; i < le16_to_cpu(bg->bg_list.l_next_free_rec); i++) {\n\t\trec = &bg->bg_list.l_recs[i];\n\t\tif (ocfs2_bg_discontig_fix_by_rec(res, rec, cl)) {\n\t\t\tres->sr_bg_blkno = bg_blkno;   \n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic int ocfs2_search_one_group(struct ocfs2_alloc_context *ac,\n\t\t\t\t  handle_t *handle,\n\t\t\t\t  u32 bits_wanted,\n\t\t\t\t  u32 min_bits,\n\t\t\t\t  struct ocfs2_suballoc_result *res,\n\t\t\t\t  u16 *bits_left)\n{\n\tint ret;\n\tstruct buffer_head *group_bh = NULL;\n\tstruct ocfs2_group_desc *gd;\n\tstruct ocfs2_dinode *di = (struct ocfs2_dinode *)ac->ac_bh->b_data;\n\tstruct inode *alloc_inode = ac->ac_inode;\n\n\tret = ocfs2_read_group_descriptor(alloc_inode, di,\n\t\t\t\t\t  res->sr_bg_blkno, &group_bh);\n\tif (ret < 0) {\n\t\tmlog_errno(ret);\n\t\treturn ret;\n\t}\n\n\tgd = (struct ocfs2_group_desc *) group_bh->b_data;\n\tret = ac->ac_group_search(alloc_inode, group_bh, bits_wanted, min_bits,\n\t\t\t\t  ac->ac_max_block, res);\n\tif (ret < 0) {\n\t\tif (ret != -ENOSPC)\n\t\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tif (!ret)\n\t\tocfs2_bg_discontig_fix_result(ac, gd, res);\n\n\t \n\tres->sr_bg_stable_blkno = group_bh->b_blocknr;\n\n\tif (ac->ac_find_loc_only)\n\t\tgoto out_loc_only;\n\n\tret = ocfs2_alloc_dinode_update_counts(alloc_inode, handle, ac->ac_bh,\n\t\t\t\t\t       res->sr_bits,\n\t\t\t\t\t       le16_to_cpu(gd->bg_chain));\n\tif (ret < 0) {\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tret = ocfs2_block_group_set_bits(handle, alloc_inode, gd, group_bh,\n\t\t\t\t\t res->sr_bit_offset, res->sr_bits);\n\tif (ret < 0) {\n\t\tocfs2_rollback_alloc_dinode_counts(alloc_inode, ac->ac_bh,\n\t\t\t\t\t       res->sr_bits,\n\t\t\t\t\t       le16_to_cpu(gd->bg_chain));\n\t\tmlog_errno(ret);\n\t}\n\nout_loc_only:\n\t*bits_left = le16_to_cpu(gd->bg_free_bits_count);\n\nout:\n\tbrelse(group_bh);\n\n\treturn ret;\n}\n\nstatic int ocfs2_search_chain(struct ocfs2_alloc_context *ac,\n\t\t\t      handle_t *handle,\n\t\t\t      u32 bits_wanted,\n\t\t\t      u32 min_bits,\n\t\t\t      struct ocfs2_suballoc_result *res,\n\t\t\t      u16 *bits_left)\n{\n\tint status;\n\tu16 chain;\n\tu64 next_group;\n\tstruct inode *alloc_inode = ac->ac_inode;\n\tstruct buffer_head *group_bh = NULL;\n\tstruct buffer_head *prev_group_bh = NULL;\n\tstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) ac->ac_bh->b_data;\n\tstruct ocfs2_chain_list *cl = (struct ocfs2_chain_list *) &fe->id2.i_chain;\n\tstruct ocfs2_group_desc *bg;\n\n\tchain = ac->ac_chain;\n\ttrace_ocfs2_search_chain_begin(\n\t\t(unsigned long long)OCFS2_I(alloc_inode)->ip_blkno,\n\t\tbits_wanted, chain);\n\n\tstatus = ocfs2_read_group_descriptor(alloc_inode, fe,\n\t\t\t\t\t     le64_to_cpu(cl->cl_recs[chain].c_blkno),\n\t\t\t\t\t     &group_bh);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tbg = (struct ocfs2_group_desc *) group_bh->b_data;\n\n\tstatus = -ENOSPC;\n\t \n\twhile ((status = ac->ac_group_search(alloc_inode, group_bh,\n\t\t\t\t\t     bits_wanted, min_bits,\n\t\t\t\t\t     ac->ac_max_block,\n\t\t\t\t\t     res)) == -ENOSPC) {\n\t\tif (!bg->bg_next_group)\n\t\t\tbreak;\n\n\t\tbrelse(prev_group_bh);\n\t\tprev_group_bh = NULL;\n\n\t\tnext_group = le64_to_cpu(bg->bg_next_group);\n\t\tprev_group_bh = group_bh;\n\t\tgroup_bh = NULL;\n\t\tstatus = ocfs2_read_group_descriptor(alloc_inode, fe,\n\t\t\t\t\t\t     next_group, &group_bh);\n\t\tif (status < 0) {\n\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t\tbg = (struct ocfs2_group_desc *) group_bh->b_data;\n\t}\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\ttrace_ocfs2_search_chain_succ(\n\t\t(unsigned long long)le64_to_cpu(bg->bg_blkno), res->sr_bits);\n\n\tres->sr_bg_blkno = le64_to_cpu(bg->bg_blkno);\n\n\tBUG_ON(res->sr_bits == 0);\n\tif (!status)\n\t\tocfs2_bg_discontig_fix_result(ac, bg, res);\n\n\t \n\tres->sr_bg_stable_blkno = group_bh->b_blocknr;\n\n\t \n\tif (!ac->ac_disable_chain_relink &&\n\t    (prev_group_bh) &&\n\t    (ocfs2_block_group_reasonably_empty(bg, res->sr_bits))) {\n\t\tstatus = ocfs2_relink_block_group(handle, alloc_inode,\n\t\t\t\t\t\t  ac->ac_bh, group_bh,\n\t\t\t\t\t\t  prev_group_bh, chain);\n\t\tif (status < 0) {\n\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t}\n\n\tif (ac->ac_find_loc_only)\n\t\tgoto out_loc_only;\n\n\tstatus = ocfs2_alloc_dinode_update_counts(alloc_inode, handle,\n\t\t\t\t\t\t  ac->ac_bh, res->sr_bits,\n\t\t\t\t\t\t  chain);\n\tif (status) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tstatus = ocfs2_block_group_set_bits(handle,\n\t\t\t\t\t    alloc_inode,\n\t\t\t\t\t    bg,\n\t\t\t\t\t    group_bh,\n\t\t\t\t\t    res->sr_bit_offset,\n\t\t\t\t\t    res->sr_bits);\n\tif (status < 0) {\n\t\tocfs2_rollback_alloc_dinode_counts(alloc_inode,\n\t\t\t\t\tac->ac_bh, res->sr_bits, chain);\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\ttrace_ocfs2_search_chain_end(\n\t\t\t(unsigned long long)le64_to_cpu(fe->i_blkno),\n\t\t\tres->sr_bits);\n\nout_loc_only:\n\t*bits_left = le16_to_cpu(bg->bg_free_bits_count);\nbail:\n\tbrelse(group_bh);\n\tbrelse(prev_group_bh);\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\n \nstatic int ocfs2_claim_suballoc_bits(struct ocfs2_alloc_context *ac,\n\t\t\t\t     handle_t *handle,\n\t\t\t\t     u32 bits_wanted,\n\t\t\t\t     u32 min_bits,\n\t\t\t\t     struct ocfs2_suballoc_result *res)\n{\n\tint status;\n\tu16 victim, i;\n\tu16 bits_left = 0;\n\tu64 hint = ac->ac_last_group;\n\tstruct ocfs2_chain_list *cl;\n\tstruct ocfs2_dinode *fe;\n\n\tBUG_ON(ac->ac_bits_given >= ac->ac_bits_wanted);\n\tBUG_ON(bits_wanted > (ac->ac_bits_wanted - ac->ac_bits_given));\n\tBUG_ON(!ac->ac_bh);\n\n\tfe = (struct ocfs2_dinode *) ac->ac_bh->b_data;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_DINODE(fe));\n\n\tif (le32_to_cpu(fe->id1.bitmap1.i_used) >=\n\t    le32_to_cpu(fe->id1.bitmap1.i_total)) {\n\t\tstatus = ocfs2_error(ac->ac_inode->i_sb,\n\t\t\t\t     \"Chain allocator dinode %llu has %u used bits but only %u total\\n\",\n\t\t\t\t     (unsigned long long)le64_to_cpu(fe->i_blkno),\n\t\t\t\t     le32_to_cpu(fe->id1.bitmap1.i_used),\n\t\t\t\t     le32_to_cpu(fe->id1.bitmap1.i_total));\n\t\tgoto bail;\n\t}\n\n\tres->sr_bg_blkno = hint;\n\tif (res->sr_bg_blkno) {\n\t\t \n\t\tstatus = ocfs2_search_one_group(ac, handle, bits_wanted,\n\t\t\t\t\t\tmin_bits, res, &bits_left);\n\t\tif (!status)\n\t\t\tgoto set_hint;\n\t\tif (status < 0 && status != -ENOSPC) {\n\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t}\n\n\tcl = (struct ocfs2_chain_list *) &fe->id2.i_chain;\n\n\tvictim = ocfs2_find_victim_chain(cl);\n\tac->ac_chain = victim;\n\n\tstatus = ocfs2_search_chain(ac, handle, bits_wanted, min_bits,\n\t\t\t\t    res, &bits_left);\n\tif (!status) {\n\t\tif (ocfs2_is_cluster_bitmap(ac->ac_inode))\n\t\t\thint = res->sr_bg_blkno;\n\t\telse\n\t\t\thint = ocfs2_group_from_res(res);\n\t\tgoto set_hint;\n\t}\n\tif (status < 0 && status != -ENOSPC) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\ttrace_ocfs2_claim_suballoc_bits(victim);\n\n\t \n\tac->ac_disable_chain_relink = 1;\n\tfor (i = 0; i < le16_to_cpu(cl->cl_next_free_rec); i ++) {\n\t\tif (i == victim)\n\t\t\tcontinue;\n\t\tif (!cl->cl_recs[i].c_free)\n\t\t\tcontinue;\n\n\t\tac->ac_chain = i;\n\t\tstatus = ocfs2_search_chain(ac, handle, bits_wanted, min_bits,\n\t\t\t\t\t    res, &bits_left);\n\t\tif (!status) {\n\t\t\thint = ocfs2_group_from_res(res);\n\t\t\tbreak;\n\t\t}\n\t\tif (status < 0 && status != -ENOSPC) {\n\t\t\tmlog_errno(status);\n\t\t\tgoto bail;\n\t\t}\n\t}\n\nset_hint:\n\tif (status != -ENOSPC) {\n\t\t \n\t\tif (bits_left < min_bits)\n\t\t\tac->ac_last_group = 0;\n\t\telse\n\t\t\tac->ac_last_group = hint;\n\t}\n\nbail:\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nint ocfs2_claim_metadata(handle_t *handle,\n\t\t\t struct ocfs2_alloc_context *ac,\n\t\t\t u32 bits_wanted,\n\t\t\t u64 *suballoc_loc,\n\t\t\t u16 *suballoc_bit_start,\n\t\t\t unsigned int *num_bits,\n\t\t\t u64 *blkno_start)\n{\n\tint status;\n\tstruct ocfs2_suballoc_result res = { .sr_blkno = 0, };\n\n\tBUG_ON(!ac);\n\tBUG_ON(ac->ac_bits_wanted < (ac->ac_bits_given + bits_wanted));\n\tBUG_ON(ac->ac_which != OCFS2_AC_USE_META);\n\n\tstatus = ocfs2_claim_suballoc_bits(ac,\n\t\t\t\t\t   handle,\n\t\t\t\t\t   bits_wanted,\n\t\t\t\t\t   1,\n\t\t\t\t\t   &res);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tatomic_inc(&OCFS2_SB(ac->ac_inode->i_sb)->alloc_stats.bg_allocs);\n\n\t*suballoc_loc = res.sr_bg_blkno;\n\t*suballoc_bit_start = res.sr_bit_offset;\n\t*blkno_start = res.sr_blkno;\n\tac->ac_bits_given += res.sr_bits;\n\t*num_bits = res.sr_bits;\n\tstatus = 0;\nbail:\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nstatic void ocfs2_init_inode_ac_group(struct inode *dir,\n\t\t\t\t      struct buffer_head *parent_di_bh,\n\t\t\t\t      struct ocfs2_alloc_context *ac)\n{\n\tstruct ocfs2_dinode *di = (struct ocfs2_dinode *)parent_di_bh->b_data;\n\t \n\tif (OCFS2_I(dir)->ip_last_used_group &&\n\t    OCFS2_I(dir)->ip_last_used_slot == ac->ac_alloc_slot)\n\t\tac->ac_last_group = OCFS2_I(dir)->ip_last_used_group;\n\telse if (le16_to_cpu(di->i_suballoc_slot) == ac->ac_alloc_slot) {\n\t\tif (di->i_suballoc_loc)\n\t\t\tac->ac_last_group = le64_to_cpu(di->i_suballoc_loc);\n\t\telse\n\t\t\tac->ac_last_group = ocfs2_which_suballoc_group(\n\t\t\t\t\tle64_to_cpu(di->i_blkno),\n\t\t\t\t\tle16_to_cpu(di->i_suballoc_bit));\n\t}\n}\n\nstatic inline void ocfs2_save_inode_ac_group(struct inode *dir,\n\t\t\t\t\t     struct ocfs2_alloc_context *ac)\n{\n\tOCFS2_I(dir)->ip_last_used_group = ac->ac_last_group;\n\tOCFS2_I(dir)->ip_last_used_slot = ac->ac_alloc_slot;\n}\n\nint ocfs2_find_new_inode_loc(struct inode *dir,\n\t\t\t     struct buffer_head *parent_fe_bh,\n\t\t\t     struct ocfs2_alloc_context *ac,\n\t\t\t     u64 *fe_blkno)\n{\n\tint ret;\n\thandle_t *handle = NULL;\n\tstruct ocfs2_suballoc_result *res;\n\n\tBUG_ON(!ac);\n\tBUG_ON(ac->ac_bits_given != 0);\n\tBUG_ON(ac->ac_bits_wanted != 1);\n\tBUG_ON(ac->ac_which != OCFS2_AC_USE_INODE);\n\n\tres = kzalloc(sizeof(*res), GFP_NOFS);\n\tif (res == NULL) {\n\t\tret = -ENOMEM;\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tocfs2_init_inode_ac_group(dir, parent_fe_bh, ac);\n\n\t \n\thandle = ocfs2_start_trans(OCFS2_SB(dir->i_sb), OCFS2_SUBALLOC_ALLOC);\n\tif (IS_ERR(handle)) {\n\t\tret = PTR_ERR(handle);\n\t\thandle = NULL;\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\t \n\tac->ac_find_loc_only = 1;\n\n\tret = ocfs2_claim_suballoc_bits(ac, handle, 1, 1, res);\n\tif (ret < 0) {\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tac->ac_find_loc_priv = res;\n\t*fe_blkno = res->sr_blkno;\n\tocfs2_update_inode_fsync_trans(handle, dir, 0);\nout:\n\tif (handle)\n\t\tocfs2_commit_trans(OCFS2_SB(dir->i_sb), handle);\n\n\tif (ret)\n\t\tkfree(res);\n\n\treturn ret;\n}\n\nint ocfs2_claim_new_inode_at_loc(handle_t *handle,\n\t\t\t\t struct inode *dir,\n\t\t\t\t struct ocfs2_alloc_context *ac,\n\t\t\t\t u64 *suballoc_loc,\n\t\t\t\t u16 *suballoc_bit,\n\t\t\t\t u64 di_blkno)\n{\n\tint ret;\n\tu16 chain;\n\tstruct ocfs2_suballoc_result *res = ac->ac_find_loc_priv;\n\tstruct buffer_head *bg_bh = NULL;\n\tstruct ocfs2_group_desc *bg;\n\tstruct ocfs2_dinode *di = (struct ocfs2_dinode *) ac->ac_bh->b_data;\n\n\t \n\tBUG_ON(res->sr_blkno != di_blkno);\n\n\tret = ocfs2_read_group_descriptor(ac->ac_inode, di,\n\t\t\t\t\t  res->sr_bg_stable_blkno, &bg_bh);\n\tif (ret) {\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tbg = (struct ocfs2_group_desc *) bg_bh->b_data;\n\tchain = le16_to_cpu(bg->bg_chain);\n\n\tret = ocfs2_alloc_dinode_update_counts(ac->ac_inode, handle,\n\t\t\t\t\t       ac->ac_bh, res->sr_bits,\n\t\t\t\t\t       chain);\n\tif (ret) {\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tret = ocfs2_block_group_set_bits(handle,\n\t\t\t\t\t ac->ac_inode,\n\t\t\t\t\t bg,\n\t\t\t\t\t bg_bh,\n\t\t\t\t\t res->sr_bit_offset,\n\t\t\t\t\t res->sr_bits);\n\tif (ret < 0) {\n\t\tocfs2_rollback_alloc_dinode_counts(ac->ac_inode,\n\t\t\t\t\t       ac->ac_bh, res->sr_bits, chain);\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\ttrace_ocfs2_claim_new_inode_at_loc((unsigned long long)di_blkno,\n\t\t\t\t\t   res->sr_bits);\n\n\tatomic_inc(&OCFS2_SB(ac->ac_inode->i_sb)->alloc_stats.bg_allocs);\n\n\tBUG_ON(res->sr_bits != 1);\n\n\t*suballoc_loc = res->sr_bg_blkno;\n\t*suballoc_bit = res->sr_bit_offset;\n\tac->ac_bits_given++;\n\tocfs2_save_inode_ac_group(dir, ac);\n\nout:\n\tbrelse(bg_bh);\n\n\treturn ret;\n}\n\nint ocfs2_claim_new_inode(handle_t *handle,\n\t\t\t  struct inode *dir,\n\t\t\t  struct buffer_head *parent_fe_bh,\n\t\t\t  struct ocfs2_alloc_context *ac,\n\t\t\t  u64 *suballoc_loc,\n\t\t\t  u16 *suballoc_bit,\n\t\t\t  u64 *fe_blkno)\n{\n\tint status;\n\tstruct ocfs2_suballoc_result res;\n\n\tBUG_ON(!ac);\n\tBUG_ON(ac->ac_bits_given != 0);\n\tBUG_ON(ac->ac_bits_wanted != 1);\n\tBUG_ON(ac->ac_which != OCFS2_AC_USE_INODE);\n\n\tocfs2_init_inode_ac_group(dir, parent_fe_bh, ac);\n\n\tstatus = ocfs2_claim_suballoc_bits(ac,\n\t\t\t\t\t   handle,\n\t\t\t\t\t   1,\n\t\t\t\t\t   1,\n\t\t\t\t\t   &res);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tatomic_inc(&OCFS2_SB(ac->ac_inode->i_sb)->alloc_stats.bg_allocs);\n\n\tBUG_ON(res.sr_bits != 1);\n\n\t*suballoc_loc = res.sr_bg_blkno;\n\t*suballoc_bit = res.sr_bit_offset;\n\t*fe_blkno = res.sr_blkno;\n\tac->ac_bits_given++;\n\tocfs2_save_inode_ac_group(dir, ac);\n\tstatus = 0;\nbail:\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\n \nstatic inline u32 ocfs2_desc_bitmap_to_cluster_off(struct inode *inode,\n\t\t\t\t\t\t   u64 bg_blkno,\n\t\t\t\t\t\t   u16 bg_bit_off)\n{\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\tu32 cluster = 0;\n\n\tBUG_ON(!ocfs2_is_cluster_bitmap(inode));\n\n\tif (bg_blkno != osb->first_cluster_group_blkno)\n\t\tcluster = ocfs2_blocks_to_clusters(inode->i_sb, bg_blkno);\n\tcluster += (u32) bg_bit_off;\n\treturn cluster;\n}\n\n \nu64 ocfs2_which_cluster_group(struct inode *inode, u32 cluster)\n{\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\tu32 group_no;\n\n\tBUG_ON(!ocfs2_is_cluster_bitmap(inode));\n\n\tgroup_no = cluster / osb->bitmap_cpg;\n\tif (!group_no)\n\t\treturn osb->first_cluster_group_blkno;\n\treturn ocfs2_clusters_to_blocks(inode->i_sb,\n\t\t\t\t\tgroup_no * osb->bitmap_cpg);\n}\n\n \nstatic inline void ocfs2_block_to_cluster_group(struct inode *inode,\n\t\t\t\t\t\tu64 data_blkno,\n\t\t\t\t\t\tu64 *bg_blkno,\n\t\t\t\t\t\tu16 *bg_bit_off)\n{\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\tu32 data_cluster = ocfs2_blocks_to_clusters(osb->sb, data_blkno);\n\n\tBUG_ON(!ocfs2_is_cluster_bitmap(inode));\n\n\t*bg_blkno = ocfs2_which_cluster_group(inode,\n\t\t\t\t\t      data_cluster);\n\n\tif (*bg_blkno == osb->first_cluster_group_blkno)\n\t\t*bg_bit_off = (u16) data_cluster;\n\telse\n\t\t*bg_bit_off = (u16) ocfs2_blocks_to_clusters(osb->sb,\n\t\t\t\t\t\t\t     data_blkno - *bg_blkno);\n}\n\n \nint __ocfs2_claim_clusters(handle_t *handle,\n\t\t\t   struct ocfs2_alloc_context *ac,\n\t\t\t   u32 min_clusters,\n\t\t\t   u32 max_clusters,\n\t\t\t   u32 *cluster_start,\n\t\t\t   u32 *num_clusters)\n{\n\tint status;\n\tunsigned int bits_wanted = max_clusters;\n\tstruct ocfs2_suballoc_result res = { .sr_blkno = 0, };\n\tstruct ocfs2_super *osb = OCFS2_SB(ac->ac_inode->i_sb);\n\n\tBUG_ON(ac->ac_bits_given >= ac->ac_bits_wanted);\n\n\tBUG_ON(ac->ac_which != OCFS2_AC_USE_LOCAL\n\t       && ac->ac_which != OCFS2_AC_USE_MAIN);\n\n\tif (ac->ac_which == OCFS2_AC_USE_LOCAL) {\n\t\tWARN_ON(min_clusters > 1);\n\n\t\tstatus = ocfs2_claim_local_alloc_bits(osb,\n\t\t\t\t\t\t      handle,\n\t\t\t\t\t\t      ac,\n\t\t\t\t\t\t      bits_wanted,\n\t\t\t\t\t\t      cluster_start,\n\t\t\t\t\t\t      num_clusters);\n\t\tif (!status)\n\t\t\tatomic_inc(&osb->alloc_stats.local_data);\n\t} else {\n\t\tif (min_clusters > (osb->bitmap_cpg - 1)) {\n\t\t\t \n\t\t\tmlog(ML_ERROR, \"minimum allocation requested %u exceeds \"\n\t\t\t     \"group bitmap size %u!\\n\", min_clusters,\n\t\t\t     osb->bitmap_cpg);\n\t\t\tstatus = -ENOSPC;\n\t\t\tgoto bail;\n\t\t}\n\t\t \n\t\tif (bits_wanted > (osb->bitmap_cpg - 1))\n\t\t\tbits_wanted = osb->bitmap_cpg - 1;\n\n\t\tstatus = ocfs2_claim_suballoc_bits(ac,\n\t\t\t\t\t\t   handle,\n\t\t\t\t\t\t   bits_wanted,\n\t\t\t\t\t\t   min_clusters,\n\t\t\t\t\t\t   &res);\n\t\tif (!status) {\n\t\t\tBUG_ON(res.sr_blkno);  \n\t\t\t*cluster_start =\n\t\t\t\tocfs2_desc_bitmap_to_cluster_off(ac->ac_inode,\n\t\t\t\t\t\t\t\t res.sr_bg_blkno,\n\t\t\t\t\t\t\t\t res.sr_bit_offset);\n\t\t\tatomic_inc(&osb->alloc_stats.bitmap_data);\n\t\t\t*num_clusters = res.sr_bits;\n\t\t}\n\t}\n\tif (status < 0) {\n\t\tif (status != -ENOSPC)\n\t\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tac->ac_bits_given += *num_clusters;\n\nbail:\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\nint ocfs2_claim_clusters(handle_t *handle,\n\t\t\t struct ocfs2_alloc_context *ac,\n\t\t\t u32 min_clusters,\n\t\t\t u32 *cluster_start,\n\t\t\t u32 *num_clusters)\n{\n\tunsigned int bits_wanted = ac->ac_bits_wanted - ac->ac_bits_given;\n\n\treturn __ocfs2_claim_clusters(handle, ac, min_clusters,\n\t\t\t\t      bits_wanted, cluster_start, num_clusters);\n}\n\nstatic int ocfs2_block_group_clear_bits(handle_t *handle,\n\t\t\t\t\tstruct inode *alloc_inode,\n\t\t\t\t\tstruct ocfs2_group_desc *bg,\n\t\t\t\t\tstruct buffer_head *group_bh,\n\t\t\t\t\tunsigned int bit_off,\n\t\t\t\t\tunsigned int num_bits,\n\t\t\t\t\tvoid (*undo_fn)(unsigned int bit,\n\t\t\t\t\t\t\tunsigned long *bmap))\n{\n\tint status;\n\tunsigned int tmp;\n\tstruct ocfs2_group_desc *undo_bg = NULL;\n\tstruct journal_head *jh;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\n\n\ttrace_ocfs2_block_group_clear_bits(bit_off, num_bits);\n\n\tBUG_ON(undo_fn && !ocfs2_is_cluster_bitmap(alloc_inode));\n\tstatus = ocfs2_journal_access_gd(handle, INODE_CACHE(alloc_inode),\n\t\t\t\t\t group_bh,\n\t\t\t\t\t undo_fn ?\n\t\t\t\t\t OCFS2_JOURNAL_ACCESS_UNDO :\n\t\t\t\t\t OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tjh = bh2jh(group_bh);\n\tif (undo_fn) {\n\t\tspin_lock(&jh->b_state_lock);\n\t\tundo_bg = (struct ocfs2_group_desc *) jh->b_committed_data;\n\t\tBUG_ON(!undo_bg);\n\t}\n\n\ttmp = num_bits;\n\twhile(tmp--) {\n\t\tocfs2_clear_bit((bit_off + tmp),\n\t\t\t\t(unsigned long *) bg->bg_bitmap);\n\t\tif (undo_fn)\n\t\t\tundo_fn(bit_off + tmp,\n\t\t\t\t(unsigned long *) undo_bg->bg_bitmap);\n\t}\n\tle16_add_cpu(&bg->bg_free_bits_count, num_bits);\n\tif (le16_to_cpu(bg->bg_free_bits_count) > le16_to_cpu(bg->bg_bits)) {\n\t\tif (undo_fn)\n\t\t\tspin_unlock(&jh->b_state_lock);\n\t\treturn ocfs2_error(alloc_inode->i_sb, \"Group descriptor # %llu has bit count %u but claims %u are freed. num_bits %d\\n\",\n\t\t\t\t   (unsigned long long)le64_to_cpu(bg->bg_blkno),\n\t\t\t\t   le16_to_cpu(bg->bg_bits),\n\t\t\t\t   le16_to_cpu(bg->bg_free_bits_count),\n\t\t\t\t   num_bits);\n\t}\n\n\tif (undo_fn)\n\t\tspin_unlock(&jh->b_state_lock);\n\n\tocfs2_journal_dirty(handle, group_bh);\nbail:\n\treturn status;\n}\n\n \nstatic int _ocfs2_free_suballoc_bits(handle_t *handle,\n\t\t\t\t     struct inode *alloc_inode,\n\t\t\t\t     struct buffer_head *alloc_bh,\n\t\t\t\t     unsigned int start_bit,\n\t\t\t\t     u64 bg_blkno,\n\t\t\t\t     unsigned int count,\n\t\t\t\t     void (*undo_fn)(unsigned int bit,\n\t\t\t\t\t\t     unsigned long *bitmap))\n{\n\tint status = 0;\n\tu32 tmp_used;\n\tstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) alloc_bh->b_data;\n\tstruct ocfs2_chain_list *cl = &fe->id2.i_chain;\n\tstruct buffer_head *group_bh = NULL;\n\tstruct ocfs2_group_desc *group;\n\n\t \n\tBUG_ON(!OCFS2_IS_VALID_DINODE(fe));\n\tBUG_ON((count + start_bit) > ocfs2_bits_per_group(cl));\n\n\ttrace_ocfs2_free_suballoc_bits(\n\t\t(unsigned long long)OCFS2_I(alloc_inode)->ip_blkno,\n\t\t(unsigned long long)bg_blkno,\n\t\tstart_bit, count);\n\n\tstatus = ocfs2_read_group_descriptor(alloc_inode, fe, bg_blkno,\n\t\t\t\t\t     &group_bh);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\tgroup = (struct ocfs2_group_desc *) group_bh->b_data;\n\n\tBUG_ON((count + start_bit) > le16_to_cpu(group->bg_bits));\n\n\tstatus = ocfs2_block_group_clear_bits(handle, alloc_inode,\n\t\t\t\t\t      group, group_bh,\n\t\t\t\t\t      start_bit, count, undo_fn);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto bail;\n\t}\n\n\tstatus = ocfs2_journal_access_di(handle, INODE_CACHE(alloc_inode),\n\t\t\t\t\t alloc_bh, OCFS2_JOURNAL_ACCESS_WRITE);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tocfs2_block_group_set_bits(handle, alloc_inode, group, group_bh,\n\t\t\t\tstart_bit, count);\n\t\tgoto bail;\n\t}\n\n\tle32_add_cpu(&cl->cl_recs[le16_to_cpu(group->bg_chain)].c_free,\n\t\t     count);\n\ttmp_used = le32_to_cpu(fe->id1.bitmap1.i_used);\n\tfe->id1.bitmap1.i_used = cpu_to_le32(tmp_used - count);\n\tocfs2_journal_dirty(handle, alloc_bh);\n\nbail:\n\tbrelse(group_bh);\n\treturn status;\n}\n\nint ocfs2_free_suballoc_bits(handle_t *handle,\n\t\t\t     struct inode *alloc_inode,\n\t\t\t     struct buffer_head *alloc_bh,\n\t\t\t     unsigned int start_bit,\n\t\t\t     u64 bg_blkno,\n\t\t\t     unsigned int count)\n{\n\treturn _ocfs2_free_suballoc_bits(handle, alloc_inode, alloc_bh,\n\t\t\t\t\t start_bit, bg_blkno, count, NULL);\n}\n\nint ocfs2_free_dinode(handle_t *handle,\n\t\t      struct inode *inode_alloc_inode,\n\t\t      struct buffer_head *inode_alloc_bh,\n\t\t      struct ocfs2_dinode *di)\n{\n\tu64 blk = le64_to_cpu(di->i_blkno);\n\tu16 bit = le16_to_cpu(di->i_suballoc_bit);\n\tu64 bg_blkno = ocfs2_which_suballoc_group(blk, bit);\n\n\tif (di->i_suballoc_loc)\n\t\tbg_blkno = le64_to_cpu(di->i_suballoc_loc);\n\treturn ocfs2_free_suballoc_bits(handle, inode_alloc_inode,\n\t\t\t\t\tinode_alloc_bh, bit, bg_blkno, 1);\n}\n\nstatic int _ocfs2_free_clusters(handle_t *handle,\n\t\t\t\tstruct inode *bitmap_inode,\n\t\t\t\tstruct buffer_head *bitmap_bh,\n\t\t\t\tu64 start_blk,\n\t\t\t\tunsigned int num_clusters,\n\t\t\t\tvoid (*undo_fn)(unsigned int bit,\n\t\t\t\t\t\tunsigned long *bitmap))\n{\n\tint status;\n\tu16 bg_start_bit;\n\tu64 bg_blkno;\n\n\t \n\tBUG_ON(start_blk != ocfs2_clusters_to_blocks(bitmap_inode->i_sb,\n\t\t\t\tocfs2_blocks_to_clusters(bitmap_inode->i_sb,\n\t\t\t\t\t\t\t start_blk)));\n\n\n\tocfs2_block_to_cluster_group(bitmap_inode, start_blk, &bg_blkno,\n\t\t\t\t     &bg_start_bit);\n\n\ttrace_ocfs2_free_clusters((unsigned long long)bg_blkno,\n\t\t\t(unsigned long long)start_blk,\n\t\t\tbg_start_bit, num_clusters);\n\n\tstatus = _ocfs2_free_suballoc_bits(handle, bitmap_inode, bitmap_bh,\n\t\t\t\t\t   bg_start_bit, bg_blkno,\n\t\t\t\t\t   num_clusters, undo_fn);\n\tif (status < 0) {\n\t\tmlog_errno(status);\n\t\tgoto out;\n\t}\n\n\tocfs2_local_alloc_seen_free_bits(OCFS2_SB(bitmap_inode->i_sb),\n\t\t\t\t\t num_clusters);\n\nout:\n\treturn status;\n}\n\nint ocfs2_free_clusters(handle_t *handle,\n\t\t\tstruct inode *bitmap_inode,\n\t\t\tstruct buffer_head *bitmap_bh,\n\t\t\tu64 start_blk,\n\t\t\tunsigned int num_clusters)\n{\n\treturn _ocfs2_free_clusters(handle, bitmap_inode, bitmap_bh,\n\t\t\t\t    start_blk, num_clusters,\n\t\t\t\t    _ocfs2_set_bit);\n}\n\n \nint ocfs2_release_clusters(handle_t *handle,\n\t\t\t   struct inode *bitmap_inode,\n\t\t\t   struct buffer_head *bitmap_bh,\n\t\t\t   u64 start_blk,\n\t\t\t   unsigned int num_clusters)\n{\n\treturn _ocfs2_free_clusters(handle, bitmap_inode, bitmap_bh,\n\t\t\t\t    start_blk, num_clusters,\n\t\t\t\t    _ocfs2_clear_bit);\n}\n\n \nint ocfs2_lock_allocators(struct inode *inode,\n\t\t\t  struct ocfs2_extent_tree *et,\n\t\t\t  u32 clusters_to_add, u32 extents_to_split,\n\t\t\t  struct ocfs2_alloc_context **data_ac,\n\t\t\t  struct ocfs2_alloc_context **meta_ac)\n{\n\tint ret = 0, num_free_extents;\n\tunsigned int max_recs_needed = clusters_to_add + 2 * extents_to_split;\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\n\t*meta_ac = NULL;\n\tif (data_ac)\n\t\t*data_ac = NULL;\n\n\tBUG_ON(clusters_to_add != 0 && data_ac == NULL);\n\n\tnum_free_extents = ocfs2_num_free_extents(et);\n\tif (num_free_extents < 0) {\n\t\tret = num_free_extents;\n\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\t \n\tif (!num_free_extents ||\n\t    (ocfs2_sparse_alloc(osb) && num_free_extents < max_recs_needed)) {\n\t\tret = ocfs2_reserve_new_metadata(osb, et->et_root_el, meta_ac);\n\t\tif (ret < 0) {\n\t\t\tif (ret != -ENOSPC)\n\t\t\t\tmlog_errno(ret);\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tif (clusters_to_add == 0)\n\t\tgoto out;\n\n\tret = ocfs2_reserve_clusters(osb, clusters_to_add, data_ac);\n\tif (ret < 0) {\n\t\tif (ret != -ENOSPC)\n\t\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\nout:\n\tif (ret) {\n\t\tif (*meta_ac) {\n\t\t\tocfs2_free_alloc_context(*meta_ac);\n\t\t\t*meta_ac = NULL;\n\t\t}\n\n\t\t \n\t}\n\n\treturn ret;\n}\n\n \nstatic int ocfs2_get_suballoc_slot_bit(struct ocfs2_super *osb, u64 blkno,\n\t\t\t\t       u16 *suballoc_slot, u64 *group_blkno,\n\t\t\t\t       u16 *suballoc_bit)\n{\n\tint status;\n\tstruct buffer_head *inode_bh = NULL;\n\tstruct ocfs2_dinode *inode_fe;\n\n\ttrace_ocfs2_get_suballoc_slot_bit((unsigned long long)blkno);\n\n\t \n\tstatus = ocfs2_read_blocks_sync(osb, blkno, 1, &inode_bh);\n\tif (status < 0) {\n\t\tmlog(ML_ERROR, \"read block %llu failed %d\\n\",\n\t\t     (unsigned long long)blkno, status);\n\t\tgoto bail;\n\t}\n\n\tinode_fe = (struct ocfs2_dinode *) inode_bh->b_data;\n\tif (!OCFS2_IS_VALID_DINODE(inode_fe)) {\n\t\tmlog(ML_ERROR, \"invalid inode %llu requested\\n\",\n\t\t     (unsigned long long)blkno);\n\t\tstatus = -EINVAL;\n\t\tgoto bail;\n\t}\n\n\tif (le16_to_cpu(inode_fe->i_suballoc_slot) != (u16)OCFS2_INVALID_SLOT &&\n\t    (u32)le16_to_cpu(inode_fe->i_suballoc_slot) > osb->max_slots - 1) {\n\t\tmlog(ML_ERROR, \"inode %llu has invalid suballoc slot %u\\n\",\n\t\t     (unsigned long long)blkno,\n\t\t     (u32)le16_to_cpu(inode_fe->i_suballoc_slot));\n\t\tstatus = -EINVAL;\n\t\tgoto bail;\n\t}\n\n\tif (suballoc_slot)\n\t\t*suballoc_slot = le16_to_cpu(inode_fe->i_suballoc_slot);\n\tif (suballoc_bit)\n\t\t*suballoc_bit = le16_to_cpu(inode_fe->i_suballoc_bit);\n\tif (group_blkno)\n\t\t*group_blkno = le64_to_cpu(inode_fe->i_suballoc_loc);\n\nbail:\n\tbrelse(inode_bh);\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\n \nstatic int ocfs2_test_suballoc_bit(struct ocfs2_super *osb,\n\t\t\t\t   struct inode *suballoc,\n\t\t\t\t   struct buffer_head *alloc_bh,\n\t\t\t\t   u64 group_blkno, u64 blkno,\n\t\t\t\t   u16 bit, int *res)\n{\n\tstruct ocfs2_dinode *alloc_di;\n\tstruct ocfs2_group_desc *group;\n\tstruct buffer_head *group_bh = NULL;\n\tu64 bg_blkno;\n\tint status;\n\n\ttrace_ocfs2_test_suballoc_bit((unsigned long long)blkno,\n\t\t\t\t      (unsigned int)bit);\n\n\talloc_di = (struct ocfs2_dinode *)alloc_bh->b_data;\n\tif ((bit + 1) > ocfs2_bits_per_group(&alloc_di->id2.i_chain)) {\n\t\tmlog(ML_ERROR, \"suballoc bit %u out of range of %u\\n\",\n\t\t     (unsigned int)bit,\n\t\t     ocfs2_bits_per_group(&alloc_di->id2.i_chain));\n\t\tstatus = -EINVAL;\n\t\tgoto bail;\n\t}\n\n\tbg_blkno = group_blkno ? group_blkno :\n\t\t   ocfs2_which_suballoc_group(blkno, bit);\n\tstatus = ocfs2_read_group_descriptor(suballoc, alloc_di, bg_blkno,\n\t\t\t\t\t     &group_bh);\n\tif (status < 0) {\n\t\tmlog(ML_ERROR, \"read group %llu failed %d\\n\",\n\t\t     (unsigned long long)bg_blkno, status);\n\t\tgoto bail;\n\t}\n\n\tgroup = (struct ocfs2_group_desc *) group_bh->b_data;\n\t*res = ocfs2_test_bit(bit, (unsigned long *)group->bg_bitmap);\n\nbail:\n\tbrelse(group_bh);\n\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n\n \nint ocfs2_test_inode_bit(struct ocfs2_super *osb, u64 blkno, int *res)\n{\n\tint status;\n\tu64 group_blkno = 0;\n\tu16 suballoc_bit = 0, suballoc_slot = 0;\n\tstruct inode *inode_alloc_inode;\n\tstruct buffer_head *alloc_bh = NULL;\n\n\ttrace_ocfs2_test_inode_bit((unsigned long long)blkno);\n\n\tstatus = ocfs2_get_suballoc_slot_bit(osb, blkno, &suballoc_slot,\n\t\t\t\t\t     &group_blkno, &suballoc_bit);\n\tif (status < 0) {\n\t\tmlog(ML_ERROR, \"get alloc slot and bit failed %d\\n\", status);\n\t\tgoto bail;\n\t}\n\n\tif (suballoc_slot == (u16)OCFS2_INVALID_SLOT)\n\t\tinode_alloc_inode = ocfs2_get_system_file_inode(osb,\n\t\t\tGLOBAL_INODE_ALLOC_SYSTEM_INODE, suballoc_slot);\n\telse\n\t\tinode_alloc_inode = ocfs2_get_system_file_inode(osb,\n\t\t\tINODE_ALLOC_SYSTEM_INODE, suballoc_slot);\n\tif (!inode_alloc_inode) {\n\t\t \n\t\tstatus = -EINVAL;\n\t\tmlog(ML_ERROR, \"unable to get alloc inode in slot %u\\n\",\n\t\t     (u32)suballoc_slot);\n\t\tgoto bail;\n\t}\n\n\tinode_lock(inode_alloc_inode);\n\tstatus = ocfs2_inode_lock(inode_alloc_inode, &alloc_bh, 0);\n\tif (status < 0) {\n\t\tinode_unlock(inode_alloc_inode);\n\t\tiput(inode_alloc_inode);\n\t\tmlog(ML_ERROR, \"lock on alloc inode on slot %u failed %d\\n\",\n\t\t     (u32)suballoc_slot, status);\n\t\tgoto bail;\n\t}\n\n\tstatus = ocfs2_test_suballoc_bit(osb, inode_alloc_inode, alloc_bh,\n\t\t\t\t\t group_blkno, blkno, suballoc_bit, res);\n\tif (status < 0)\n\t\tmlog(ML_ERROR, \"test suballoc bit failed %d\\n\", status);\n\n\tocfs2_inode_unlock(inode_alloc_inode, 0);\n\tinode_unlock(inode_alloc_inode);\n\n\tiput(inode_alloc_inode);\n\tbrelse(alloc_bh);\nbail:\n\tif (status)\n\t\tmlog_errno(status);\n\treturn status;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}