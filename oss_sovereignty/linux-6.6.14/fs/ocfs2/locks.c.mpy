{
  "module_name": "locks.c",
  "hash_id": "29a1b9e85b950976e7b022a3ccf30e5a5cc446b52923f3fc458c8822bfe1ab98",
  "original_prompt": "Ingested from linux-6.6.14/fs/ocfs2/locks.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/filelock.h>\n#include <linux/fcntl.h>\n\n#include <cluster/masklog.h>\n\n#include \"ocfs2.h\"\n\n#include \"dlmglue.h\"\n#include \"file.h\"\n#include \"inode.h\"\n#include \"locks.h\"\n\nstatic int ocfs2_do_flock(struct file *file, struct inode *inode,\n\t\t\t  int cmd, struct file_lock *fl)\n{\n\tint ret = 0, level = 0, trylock = 0;\n\tstruct ocfs2_file_private *fp = file->private_data;\n\tstruct ocfs2_lock_res *lockres = &fp->fp_flock;\n\n\tif (fl->fl_type == F_WRLCK)\n\t\tlevel = 1;\n\tif (!IS_SETLKW(cmd))\n\t\ttrylock = 1;\n\n\tmutex_lock(&fp->fp_mutex);\n\n\tif (lockres->l_flags & OCFS2_LOCK_ATTACHED &&\n\t    lockres->l_level > LKM_NLMODE) {\n\t\tint old_level = 0;\n\t\tstruct file_lock request;\n\n\t\tif (lockres->l_level == LKM_EXMODE)\n\t\t\told_level = 1;\n\n\t\tif (level == old_level)\n\t\t\tgoto out;\n\n\t\t \n\n\t\tlocks_init_lock(&request);\n\t\trequest.fl_type = F_UNLCK;\n\t\trequest.fl_flags = FL_FLOCK;\n\t\tlocks_lock_file_wait(file, &request);\n\n\t\tocfs2_file_unlock(file);\n\t}\n\n\tret = ocfs2_file_lock(file, level, trylock);\n\tif (ret) {\n\t\tif (ret == -EAGAIN && trylock)\n\t\t\tret = -EWOULDBLOCK;\n\t\telse\n\t\t\tmlog_errno(ret);\n\t\tgoto out;\n\t}\n\n\tret = locks_lock_file_wait(file, fl);\n\tif (ret)\n\t\tocfs2_file_unlock(file);\n\nout:\n\tmutex_unlock(&fp->fp_mutex);\n\n\treturn ret;\n}\n\nstatic int ocfs2_do_funlock(struct file *file, int cmd, struct file_lock *fl)\n{\n\tint ret;\n\tstruct ocfs2_file_private *fp = file->private_data;\n\n\tmutex_lock(&fp->fp_mutex);\n\tocfs2_file_unlock(file);\n\tret = locks_lock_file_wait(file, fl);\n\tmutex_unlock(&fp->fp_mutex);\n\n\treturn ret;\n}\n\n \nint ocfs2_flock(struct file *file, int cmd, struct file_lock *fl)\n{\n\tstruct inode *inode = file->f_mapping->host;\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\n\tif (!(fl->fl_flags & FL_FLOCK))\n\t\treturn -ENOLCK;\n\n\tif ((osb->s_mount_opt & OCFS2_MOUNT_LOCALFLOCKS) ||\n\t    ocfs2_mount_local(osb))\n\t\treturn locks_lock_file_wait(file, fl);\n\n\tif (fl->fl_type == F_UNLCK)\n\t\treturn ocfs2_do_funlock(file, cmd, fl);\n\telse\n\t\treturn ocfs2_do_flock(file, inode, cmd, fl);\n}\n\nint ocfs2_lock(struct file *file, int cmd, struct file_lock *fl)\n{\n\tstruct inode *inode = file->f_mapping->host;\n\tstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\n\n\tif (!(fl->fl_flags & FL_POSIX))\n\t\treturn -ENOLCK;\n\n\treturn ocfs2_plock(osb->cconn, OCFS2_I(inode)->ip_blkno, file, cmd, fl);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}