{
  "module_name": "nfsroot.c",
  "hash_id": "0efaedd6fdf74861b4d1045aa65164198de0ee29e490fd625c46c3225f2b8ce5",
  "original_prompt": "Ingested from linux-6.6.14/fs/nfs/nfsroot.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/string.h>\n#include <linux/init.h>\n#include <linux/nfs.h>\n#include <linux/nfs_fs.h>\n#include <linux/utsname.h>\n#include <linux/root_dev.h>\n#include <net/ipconfig.h>\n\n#include \"internal.h\"\n\n#define NFSDBG_FACILITY NFSDBG_ROOT\n\n \n#define NFS_ROOT\t\t\"/tftpboot/%s\"\n\n \n#if defined(CONFIG_NFS_V2)\n#define NFS_DEF_OPTIONS\t\t\"vers=2,tcp,rsize=4096,wsize=4096\"\n#elif defined(CONFIG_NFS_V3)\n#define NFS_DEF_OPTIONS\t\t\"vers=3,tcp,rsize=4096,wsize=4096\"\n#else\n#define NFS_DEF_OPTIONS\t\t\"vers=4,tcp,rsize=4096,wsize=4096\"\n#endif\n\n \nstatic char nfs_root_parms[NFS_MAXPATHLEN + 1] __initdata = \"\";\n\n \nstatic char nfs_root_options[256] __initdata = NFS_DEF_OPTIONS;\n\n \nstatic __be32 servaddr __initdata = htonl(INADDR_NONE);\n\n \nstatic char nfs_export_path[NFS_MAXPATHLEN + 1] __initdata = \"\";\n\n \nstatic char nfs_root_device[NFS_MAXPATHLEN + 1] __initdata = \"\";\n\n#ifdef NFS_DEBUG\n \nstatic int __init nfs_root_debug(char *__unused)\n{\n\tnfs_debug |= NFSDBG_ROOT | NFSDBG_MOUNT;\n\treturn 1;\n}\n\n__setup(\"nfsrootdebug\", nfs_root_debug);\n#endif\n\n \nstatic int __init nfs_root_setup(char *line)\n{\n\tROOT_DEV = Root_NFS;\n\n\tif (line[0] == '/' || line[0] == ',' || (line[0] >= '0' && line[0] <= '9')) {\n\t\tstrscpy(nfs_root_parms, line, sizeof(nfs_root_parms));\n\t} else {\n\t\tsize_t n = strlen(line) + sizeof(NFS_ROOT) - 1;\n\t\tif (n >= sizeof(nfs_root_parms))\n\t\t\tline[sizeof(nfs_root_parms) - sizeof(NFS_ROOT) - 2] = '\\0';\n\t\tsprintf(nfs_root_parms, NFS_ROOT, line);\n\t}\n\n\t \n\troot_server_addr = root_nfs_parse_addr(nfs_root_parms);\n\n\treturn 1;\n}\n\n__setup(\"nfsroot=\", nfs_root_setup);\n\nstatic int __init root_nfs_copy(char *dest, const char *src,\n\t\t\t\t     const size_t destlen)\n{\n\tif (strscpy(dest, src, destlen) == -E2BIG)\n\t\treturn -1;\n\treturn 0;\n}\n\nstatic int __init root_nfs_cat(char *dest, const char *src,\n\t\t\t       const size_t destlen)\n{\n\tsize_t len = strlen(dest);\n\n\tif (len && dest[len - 1] != ',')\n\t\tif (strlcat(dest, \",\", destlen) > destlen)\n\t\t\treturn -1;\n\n\tif (strlcat(dest, src, destlen) > destlen)\n\t\treturn -1;\n\treturn 0;\n}\n\n \nstatic int __init root_nfs_parse_options(char *incoming, char *exppath,\n\t\t\t\t\t const size_t exppathlen)\n{\n\tchar *p;\n\n\t \n\tp = strsep(&incoming, \",\");\n\tif (*p != '\\0' && strcmp(p, \"default\") != 0)\n\t\tif (root_nfs_copy(exppath, p, exppathlen))\n\t\t\treturn -1;\n\n\t \n\tif (incoming != NULL && *incoming != '\\0')\n\t\tif (root_nfs_cat(nfs_root_options, incoming,\n\t\t\t\t\t\tsizeof(nfs_root_options)))\n\t\t\treturn -1;\n\treturn 0;\n}\n\n \nstatic int __init root_nfs_data(char *cmdline)\n{\n\tchar mand_options[sizeof(\"nolock,addr=\") + INET_ADDRSTRLEN + 1];\n\tint len, retval = -1;\n\tchar *tmp = NULL;\n\tconst size_t tmplen = sizeof(nfs_export_path);\n\n\ttmp = kzalloc(tmplen, GFP_KERNEL);\n\tif (tmp == NULL)\n\t\tgoto out_nomem;\n\tstrcpy(tmp, NFS_ROOT);\n\n\tif (root_server_path[0] != '\\0') {\n\t\tdprintk(\"Root-NFS: DHCPv4 option 17: %s\\n\",\n\t\t\troot_server_path);\n\t\tif (root_nfs_parse_options(root_server_path, tmp, tmplen))\n\t\t\tgoto out_optionstoolong;\n\t}\n\n\tif (cmdline[0] != '\\0') {\n\t\tdprintk(\"Root-NFS: nfsroot=%s\\n\", cmdline);\n\t\tif (root_nfs_parse_options(cmdline, tmp, tmplen))\n\t\t\tgoto out_optionstoolong;\n\t}\n\n\t \n\tsnprintf(mand_options, sizeof(mand_options), \"nolock,addr=%pI4\",\n\t\t\t&servaddr);\n\tif (root_nfs_cat(nfs_root_options, mand_options,\n\t\t\t\t\t\tsizeof(nfs_root_options)))\n\t\tgoto out_optionstoolong;\n\n\t \n\tlen = snprintf(nfs_export_path, sizeof(nfs_export_path),\n\t\t\t\ttmp, utsname()->nodename);\n\tif (len >= (int)sizeof(nfs_export_path))\n\t\tgoto out_devnametoolong;\n\tlen = snprintf(nfs_root_device, sizeof(nfs_root_device),\n\t\t\t\t\"%pI4:%s\", &servaddr, nfs_export_path);\n\tif (len >= (int)sizeof(nfs_root_device))\n\t\tgoto out_devnametoolong;\n\n\tretval = 0;\n\nout:\n\tkfree(tmp);\n\treturn retval;\nout_nomem:\n\tprintk(KERN_ERR \"Root-NFS: could not allocate memory\\n\");\n\tgoto out;\nout_optionstoolong:\n\tprintk(KERN_ERR \"Root-NFS: mount options string too long\\n\");\n\tgoto out;\nout_devnametoolong:\n\tprintk(KERN_ERR \"Root-NFS: root device name too long.\\n\");\n\tgoto out;\n}\n\n \nint __init nfs_root_data(char **root_device, char **root_data)\n{\n\tservaddr = root_server_addr;\n\tif (servaddr == htonl(INADDR_NONE)) {\n\t\tprintk(KERN_ERR \"Root-NFS: no NFS server address\\n\");\n\t\treturn -1;\n\t}\n\n\tif (root_nfs_data(nfs_root_parms) < 0)\n\t\treturn -1;\n\n\t*root_device = nfs_root_device;\n\t*root_data = nfs_root_options;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}