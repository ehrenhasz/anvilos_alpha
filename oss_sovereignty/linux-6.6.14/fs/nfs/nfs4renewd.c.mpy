{
  "module_name": "nfs4renewd.c",
  "hash_id": "23a863569770687b23441051d39056f0506d7f24aed551170a43cc0e2b276d94",
  "original_prompt": "Ingested from linux-6.6.14/fs/nfs/nfs4renewd.c",
  "human_readable_source": " \n\n#include <linux/mm.h>\n#include <linux/pagemap.h>\n#include <linux/sunrpc/sched.h>\n#include <linux/sunrpc/clnt.h>\n\n#include <linux/nfs.h>\n#include <linux/nfs4.h>\n#include <linux/nfs_fs.h>\n#include \"nfs4_fs.h\"\n#include \"delegation.h\"\n\n#define NFSDBG_FACILITY\t\tNFSDBG_STATE\n\nvoid\nnfs4_renew_state(struct work_struct *work)\n{\n\tconst struct nfs4_state_maintenance_ops *ops;\n\tstruct nfs_client *clp =\n\t\tcontainer_of(work, struct nfs_client, cl_renewd.work);\n\tconst struct cred *cred;\n\tlong lease;\n\tunsigned long last, now;\n\tunsigned renew_flags = 0;\n\n\tops = clp->cl_mvops->state_renewal_ops;\n\tdprintk(\"%s: start\\n\", __func__);\n\n\tif (test_bit(NFS_CS_STOP_RENEW, &clp->cl_res_state))\n\t\tgoto out;\n\n\tlease = clp->cl_lease_time;\n\tlast = clp->cl_last_renewal;\n\tnow = jiffies;\n\t \n\tif (time_after(now, last + lease/3))\n\t\trenew_flags |= NFS4_RENEW_TIMEOUT;\n\tif (nfs_delegations_present(clp))\n\t\trenew_flags |= NFS4_RENEW_DELEGATION_CB;\n\n\tif (renew_flags != 0) {\n\t\tcred = ops->get_state_renewal_cred(clp);\n\t\tif (cred == NULL) {\n\t\t\tif (!(renew_flags & NFS4_RENEW_DELEGATION_CB)) {\n\t\t\t\tset_bit(NFS4CLNT_LEASE_EXPIRED, &clp->cl_state);\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t\tnfs_expire_all_delegations(clp);\n\t\t} else {\n\t\t\tint ret;\n\n\t\t\t \n\t\t\tret = ops->sched_state_renewal(clp, cred, renew_flags);\n\t\t\tput_cred(cred);\n\t\t\tswitch (ret) {\n\t\t\tdefault:\n\t\t\t\tgoto out_exp;\n\t\t\tcase -EAGAIN:\n\t\t\tcase -ENOMEM:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tdprintk(\"%s: failed to call renewd. Reason: lease not expired \\n\",\n\t\t\t\t__func__);\n\t}\n\tnfs4_schedule_state_renewal(clp);\nout_exp:\n\tnfs_expire_unreferenced_delegations(clp);\nout:\n\tdprintk(\"%s: done\\n\", __func__);\n}\n\nvoid\nnfs4_schedule_state_renewal(struct nfs_client *clp)\n{\n\tlong timeout;\n\n\tspin_lock(&clp->cl_lock);\n\ttimeout = (2 * clp->cl_lease_time) / 3 + (long)clp->cl_last_renewal\n\t\t- (long)jiffies;\n\tif (timeout < 5 * HZ)\n\t\ttimeout = 5 * HZ;\n\tdprintk(\"%s: requeueing work. Lease period = %ld\\n\",\n\t\t\t__func__, (timeout + HZ - 1) / HZ);\n\tmod_delayed_work(system_wq, &clp->cl_renewd, timeout);\n\tset_bit(NFS_CS_RENEWD, &clp->cl_res_state);\n\tspin_unlock(&clp->cl_lock);\n}\n\nvoid\nnfs4_kill_renewd(struct nfs_client *clp)\n{\n\tcancel_delayed_work_sync(&clp->cl_renewd);\n}\n\n \nvoid nfs4_set_lease_period(struct nfs_client *clp,\n\t\tunsigned long lease)\n{\n\tspin_lock(&clp->cl_lock);\n\tclp->cl_lease_time = lease;\n\tspin_unlock(&clp->cl_lock);\n\n\t \n\trpc_set_connect_timeout(clp->cl_rpcclient, lease, lease >> 1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}