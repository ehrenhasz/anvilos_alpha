{
  "module_name": "acl.c",
  "hash_id": "1464565a567030c132311a9749968011fcd65bef4ec248b65854de2ecdeead3a",
  "original_prompt": "Ingested from linux-6.6.14/fs/btrfs/acl.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/string.h>\n#include <linux/xattr.h>\n#include <linux/posix_acl_xattr.h>\n#include <linux/posix_acl.h>\n#include <linux/sched.h>\n#include <linux/sched/mm.h>\n#include <linux/slab.h>\n#include \"ctree.h\"\n#include \"btrfs_inode.h\"\n#include \"xattr.h\"\n#include \"acl.h\"\n\nstruct posix_acl *btrfs_get_acl(struct inode *inode, int type, bool rcu)\n{\n\tint size;\n\tconst char *name;\n\tchar *value = NULL;\n\tstruct posix_acl *acl;\n\n\tif (rcu)\n\t\treturn ERR_PTR(-ECHILD);\n\n\tswitch (type) {\n\tcase ACL_TYPE_ACCESS:\n\t\tname = XATTR_NAME_POSIX_ACL_ACCESS;\n\t\tbreak;\n\tcase ACL_TYPE_DEFAULT:\n\t\tname = XATTR_NAME_POSIX_ACL_DEFAULT;\n\t\tbreak;\n\tdefault:\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tsize = btrfs_getxattr(inode, name, NULL, 0);\n\tif (size > 0) {\n\t\tvalue = kzalloc(size, GFP_KERNEL);\n\t\tif (!value)\n\t\t\treturn ERR_PTR(-ENOMEM);\n\t\tsize = btrfs_getxattr(inode, name, value, size);\n\t}\n\tif (size > 0)\n\t\tacl = posix_acl_from_xattr(&init_user_ns, value, size);\n\telse if (size == -ENODATA || size == 0)\n\t\tacl = NULL;\n\telse\n\t\tacl = ERR_PTR(size);\n\tkfree(value);\n\n\treturn acl;\n}\n\nint __btrfs_set_acl(struct btrfs_trans_handle *trans, struct inode *inode,\n\t\t    struct posix_acl *acl, int type)\n{\n\tint ret, size = 0;\n\tconst char *name;\n\tchar *value = NULL;\n\n\tswitch (type) {\n\tcase ACL_TYPE_ACCESS:\n\t\tname = XATTR_NAME_POSIX_ACL_ACCESS;\n\t\tbreak;\n\tcase ACL_TYPE_DEFAULT:\n\t\tif (!S_ISDIR(inode->i_mode))\n\t\t\treturn acl ? -EINVAL : 0;\n\t\tname = XATTR_NAME_POSIX_ACL_DEFAULT;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (acl) {\n\t\tunsigned int nofs_flag;\n\n\t\tsize = posix_acl_xattr_size(acl->a_count);\n\t\t \n\t\tnofs_flag = memalloc_nofs_save();\n\t\tvalue = kmalloc(size, GFP_KERNEL);\n\t\tmemalloc_nofs_restore(nofs_flag);\n\t\tif (!value) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto out;\n\t\t}\n\n\t\tret = posix_acl_to_xattr(&init_user_ns, acl, value, size);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\t}\n\n\tif (trans)\n\t\tret = btrfs_setxattr(trans, inode, name, value, size, 0);\n\telse\n\t\tret = btrfs_setxattr_trans(inode, name, value, size, 0);\n\nout:\n\tkfree(value);\n\n\tif (!ret)\n\t\tset_cached_acl(inode, type, acl);\n\n\treturn ret;\n}\n\nint btrfs_set_acl(struct mnt_idmap *idmap, struct dentry *dentry,\n\t\t  struct posix_acl *acl, int type)\n{\n\tint ret;\n\tstruct inode *inode = d_inode(dentry);\n\tumode_t old_mode = inode->i_mode;\n\n\tif (type == ACL_TYPE_ACCESS && acl) {\n\t\tret = posix_acl_update_mode(idmap, inode,\n\t\t\t\t\t    &inode->i_mode, &acl);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\tret = __btrfs_set_acl(NULL, inode, acl, type);\n\tif (ret)\n\t\tinode->i_mode = old_mode;\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}