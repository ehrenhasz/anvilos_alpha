{
  "module_name": "zoned.h",
  "hash_id": "7478c72f7907ebdcb0f697f3291a5bb084e29b230086b25c57ea13fb3d2a0372",
  "original_prompt": "Ingested from linux-6.6.14/fs/btrfs/zoned.h",
  "human_readable_source": " \n\n#ifndef BTRFS_ZONED_H\n#define BTRFS_ZONED_H\n\n#include <linux/types.h>\n#include <linux/blkdev.h>\n#include \"messages.h\"\n#include \"volumes.h\"\n#include \"disk-io.h\"\n#include \"block-group.h\"\n#include \"btrfs_inode.h\"\n\n#define BTRFS_DEFAULT_RECLAIM_THRESH           \t\t\t(75)\n\nstruct btrfs_zoned_device_info {\n\t \n\tu64 zone_size;\n\tu8  zone_size_shift;\n\tu32 nr_zones;\n\tunsigned int max_active_zones;\n\t \n\tint reserved_active_zones;\n\tatomic_t active_zones_left;\n\tunsigned long *seq_zones;\n\tunsigned long *empty_zones;\n\tunsigned long *active_zones;\n\tstruct blk_zone *zone_cache;\n\tstruct blk_zone sb_zones[2 * BTRFS_SUPER_MIRROR_MAX];\n};\n\nvoid btrfs_finish_ordered_zoned(struct btrfs_ordered_extent *ordered);\n\n#ifdef CONFIG_BLK_DEV_ZONED\nint btrfs_get_dev_zone(struct btrfs_device *device, u64 pos,\n\t\t       struct blk_zone *zone);\nint btrfs_get_dev_zone_info_all_devices(struct btrfs_fs_info *fs_info);\nint btrfs_get_dev_zone_info(struct btrfs_device *device, bool populate_cache);\nvoid btrfs_destroy_dev_zone_info(struct btrfs_device *device);\nstruct btrfs_zoned_device_info *btrfs_clone_dev_zone_info(struct btrfs_device *orig_dev);\nint btrfs_check_zoned_mode(struct btrfs_fs_info *fs_info);\nint btrfs_check_mountopts_zoned(struct btrfs_fs_info *info);\nint btrfs_sb_log_location_bdev(struct block_device *bdev, int mirror, int rw,\n\t\t\t       u64 *bytenr_ret);\nint btrfs_sb_log_location(struct btrfs_device *device, int mirror, int rw,\n\t\t\t  u64 *bytenr_ret);\nint btrfs_advance_sb_log(struct btrfs_device *device, int mirror);\nint btrfs_reset_sb_log_zones(struct block_device *bdev, int mirror);\nu64 btrfs_find_allocatable_zones(struct btrfs_device *device, u64 hole_start,\n\t\t\t\t u64 hole_end, u64 num_bytes);\nint btrfs_reset_device_zone(struct btrfs_device *device, u64 physical,\n\t\t\t    u64 length, u64 *bytes);\nint btrfs_ensure_empty_zones(struct btrfs_device *device, u64 start, u64 size);\nint btrfs_load_block_group_zone_info(struct btrfs_block_group *cache, bool new);\nvoid btrfs_calc_zone_unusable(struct btrfs_block_group *cache);\nvoid btrfs_redirty_list_add(struct btrfs_transaction *trans,\n\t\t\t    struct extent_buffer *eb);\nbool btrfs_use_zone_append(struct btrfs_bio *bbio);\nvoid btrfs_record_physical_zoned(struct btrfs_bio *bbio);\nint btrfs_check_meta_write_pointer(struct btrfs_fs_info *fs_info,\n\t\t\t\t   struct btrfs_eb_write_context *ctx);\nint btrfs_zoned_issue_zeroout(struct btrfs_device *device, u64 physical, u64 length);\nint btrfs_sync_zone_write_pointer(struct btrfs_device *tgt_dev, u64 logical,\n\t\t\t\t  u64 physical_start, u64 physical_pos);\nbool btrfs_zone_activate(struct btrfs_block_group *block_group);\nint btrfs_zone_finish(struct btrfs_block_group *block_group);\nbool btrfs_can_activate_zone(struct btrfs_fs_devices *fs_devices, u64 flags);\nvoid btrfs_zone_finish_endio(struct btrfs_fs_info *fs_info, u64 logical,\n\t\t\t     u64 length);\nvoid btrfs_schedule_zone_finish_bg(struct btrfs_block_group *bg,\n\t\t\t\t   struct extent_buffer *eb);\nvoid btrfs_clear_data_reloc_bg(struct btrfs_block_group *bg);\nvoid btrfs_free_zone_cache(struct btrfs_fs_info *fs_info);\nbool btrfs_zoned_should_reclaim(struct btrfs_fs_info *fs_info);\nvoid btrfs_zoned_release_data_reloc_bg(struct btrfs_fs_info *fs_info, u64 logical,\n\t\t\t\t       u64 length);\nint btrfs_zone_finish_one_bg(struct btrfs_fs_info *fs_info);\nint btrfs_zoned_activate_one_bg(struct btrfs_fs_info *fs_info,\n\t\t\t\tstruct btrfs_space_info *space_info, bool do_finish);\nvoid btrfs_check_active_zone_reservation(struct btrfs_fs_info *fs_info);\n#else  \nstatic inline int btrfs_get_dev_zone(struct btrfs_device *device, u64 pos,\n\t\t\t\t     struct blk_zone *zone)\n{\n\treturn 0;\n}\n\nstatic inline int btrfs_get_dev_zone_info_all_devices(struct btrfs_fs_info *fs_info)\n{\n\treturn 0;\n}\n\nstatic inline int btrfs_get_dev_zone_info(struct btrfs_device *device,\n\t\t\t\t\t  bool populate_cache)\n{\n\treturn 0;\n}\n\nstatic inline void btrfs_destroy_dev_zone_info(struct btrfs_device *device) { }\n\n \nstatic inline struct btrfs_zoned_device_info *btrfs_clone_dev_zone_info(\n\t\t\t\t\t\t struct btrfs_device *orig_dev)\n{\n\treturn NULL;\n}\n\nstatic inline int btrfs_check_zoned_mode(const struct btrfs_fs_info *fs_info)\n{\n\tif (!btrfs_is_zoned(fs_info))\n\t\treturn 0;\n\n\tbtrfs_err(fs_info, \"zoned block devices support is not enabled\");\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline int btrfs_check_mountopts_zoned(struct btrfs_fs_info *info)\n{\n\treturn 0;\n}\n\nstatic inline int btrfs_sb_log_location_bdev(struct block_device *bdev,\n\t\t\t\t\t     int mirror, int rw, u64 *bytenr_ret)\n{\n\t*bytenr_ret = btrfs_sb_offset(mirror);\n\treturn 0;\n}\n\nstatic inline int btrfs_sb_log_location(struct btrfs_device *device, int mirror,\n\t\t\t\t\tint rw, u64 *bytenr_ret)\n{\n\t*bytenr_ret = btrfs_sb_offset(mirror);\n\treturn 0;\n}\n\nstatic inline int btrfs_advance_sb_log(struct btrfs_device *device, int mirror)\n{\n\treturn 0;\n}\n\nstatic inline int btrfs_reset_sb_log_zones(struct block_device *bdev, int mirror)\n{\n\treturn 0;\n}\n\nstatic inline u64 btrfs_find_allocatable_zones(struct btrfs_device *device,\n\t\t\t\t\t       u64 hole_start, u64 hole_end,\n\t\t\t\t\t       u64 num_bytes)\n{\n\treturn hole_start;\n}\n\nstatic inline int btrfs_reset_device_zone(struct btrfs_device *device,\n\t\t\t\t\t  u64 physical, u64 length, u64 *bytes)\n{\n\t*bytes = 0;\n\treturn 0;\n}\n\nstatic inline int btrfs_ensure_empty_zones(struct btrfs_device *device,\n\t\t\t\t\t   u64 start, u64 size)\n{\n\treturn 0;\n}\n\nstatic inline int btrfs_load_block_group_zone_info(\n\t\tstruct btrfs_block_group *cache, bool new)\n{\n\treturn 0;\n}\n\nstatic inline void btrfs_calc_zone_unusable(struct btrfs_block_group *cache) { }\n\nstatic inline void btrfs_redirty_list_add(struct btrfs_transaction *trans,\n\t\t\t\t\t  struct extent_buffer *eb) { }\n\nstatic inline bool btrfs_use_zone_append(struct btrfs_bio *bbio)\n{\n\treturn false;\n}\n\nstatic inline void btrfs_record_physical_zoned(struct btrfs_bio *bbio)\n{\n}\n\nstatic inline int btrfs_check_meta_write_pointer(struct btrfs_fs_info *fs_info,\n\t\t\t\t\t\t struct btrfs_eb_write_context *ctx)\n{\n\treturn 0;\n}\n\nstatic inline int btrfs_zoned_issue_zeroout(struct btrfs_device *device,\n\t\t\t\t\t    u64 physical, u64 length)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline int btrfs_sync_zone_write_pointer(struct btrfs_device *tgt_dev,\n\t\t\t\t\t\tu64 logical, u64 physical_start,\n\t\t\t\t\t\tu64 physical_pos)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline bool btrfs_zone_activate(struct btrfs_block_group *block_group)\n{\n\treturn true;\n}\n\nstatic inline int btrfs_zone_finish(struct btrfs_block_group *block_group)\n{\n\treturn 0;\n}\n\nstatic inline bool btrfs_can_activate_zone(struct btrfs_fs_devices *fs_devices,\n\t\t\t\t\t   u64 flags)\n{\n\treturn true;\n}\n\nstatic inline void btrfs_zone_finish_endio(struct btrfs_fs_info *fs_info,\n\t\t\t\t\t   u64 logical, u64 length) { }\n\nstatic inline void btrfs_schedule_zone_finish_bg(struct btrfs_block_group *bg,\n\t\t\t\t\t\t struct extent_buffer *eb) { }\n\nstatic inline void btrfs_clear_data_reloc_bg(struct btrfs_block_group *bg) { }\n\nstatic inline void btrfs_free_zone_cache(struct btrfs_fs_info *fs_info) { }\n\nstatic inline bool btrfs_zoned_should_reclaim(struct btrfs_fs_info *fs_info)\n{\n\treturn false;\n}\n\nstatic inline void btrfs_zoned_release_data_reloc_bg(struct btrfs_fs_info *fs_info,\n\t\t\t\t\t\t     u64 logical, u64 length) { }\n\nstatic inline int btrfs_zone_finish_one_bg(struct btrfs_fs_info *fs_info)\n{\n\treturn 1;\n}\n\nstatic inline int btrfs_zoned_activate_one_bg(struct btrfs_fs_info *fs_info,\n\t\t\t\t\t      struct btrfs_space_info *space_info,\n\t\t\t\t\t      bool do_finish)\n{\n\t \n\treturn 0;\n}\n\nstatic inline void btrfs_check_active_zone_reservation(struct btrfs_fs_info *fs_info) { }\n\n#endif\n\nstatic inline bool btrfs_dev_is_sequential(struct btrfs_device *device, u64 pos)\n{\n\tstruct btrfs_zoned_device_info *zone_info = device->zone_info;\n\n\tif (!zone_info)\n\t\treturn false;\n\n\treturn test_bit(pos >> zone_info->zone_size_shift, zone_info->seq_zones);\n}\n\nstatic inline bool btrfs_dev_is_empty_zone(struct btrfs_device *device, u64 pos)\n{\n\tstruct btrfs_zoned_device_info *zone_info = device->zone_info;\n\n\tif (!zone_info)\n\t\treturn true;\n\n\treturn test_bit(pos >> zone_info->zone_size_shift, zone_info->empty_zones);\n}\n\nstatic inline void btrfs_dev_set_empty_zone_bit(struct btrfs_device *device,\n\t\t\t\t\t\tu64 pos, bool set)\n{\n\tstruct btrfs_zoned_device_info *zone_info = device->zone_info;\n\tunsigned int zno;\n\n\tif (!zone_info)\n\t\treturn;\n\n\tzno = pos >> zone_info->zone_size_shift;\n\tif (set)\n\t\tset_bit(zno, zone_info->empty_zones);\n\telse\n\t\tclear_bit(zno, zone_info->empty_zones);\n}\n\nstatic inline void btrfs_dev_set_zone_empty(struct btrfs_device *device, u64 pos)\n{\n\tbtrfs_dev_set_empty_zone_bit(device, pos, true);\n}\n\nstatic inline void btrfs_dev_clear_zone_empty(struct btrfs_device *device, u64 pos)\n{\n\tbtrfs_dev_set_empty_zone_bit(device, pos, false);\n}\n\nstatic inline bool btrfs_check_device_zone_type(const struct btrfs_fs_info *fs_info,\n\t\t\t\t\t\tstruct block_device *bdev)\n{\n\tif (btrfs_is_zoned(fs_info)) {\n\t\t \n\t\tif (!bdev_is_zoned(bdev))\n\t\t\treturn true;\n\n\t\treturn fs_info->zone_size ==\n\t\t\t(bdev_zone_sectors(bdev) << SECTOR_SHIFT);\n\t}\n\n\t \n\treturn bdev_zoned_model(bdev) != BLK_ZONED_HM;\n}\n\nstatic inline bool btrfs_check_super_location(struct btrfs_device *device, u64 pos)\n{\n\t \n\treturn device->zone_info == NULL || !btrfs_dev_is_sequential(device, pos);\n}\n\nstatic inline bool btrfs_can_zone_reset(struct btrfs_device *device,\n\t\t\t\t\tu64 physical, u64 length)\n{\n\tu64 zone_size;\n\n\tif (!btrfs_dev_is_sequential(device, physical))\n\t\treturn false;\n\n\tzone_size = device->zone_info->zone_size;\n\tif (!IS_ALIGNED(physical, zone_size) || !IS_ALIGNED(length, zone_size))\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic inline void btrfs_zoned_meta_io_lock(struct btrfs_fs_info *fs_info)\n{\n\tif (!btrfs_is_zoned(fs_info))\n\t\treturn;\n\tmutex_lock(&fs_info->zoned_meta_io_lock);\n}\n\nstatic inline void btrfs_zoned_meta_io_unlock(struct btrfs_fs_info *fs_info)\n{\n\tif (!btrfs_is_zoned(fs_info))\n\t\treturn;\n\tmutex_unlock(&fs_info->zoned_meta_io_lock);\n}\n\nstatic inline void btrfs_clear_treelog_bg(struct btrfs_block_group *bg)\n{\n\tstruct btrfs_fs_info *fs_info = bg->fs_info;\n\n\tif (!btrfs_is_zoned(fs_info))\n\t\treturn;\n\n\tspin_lock(&fs_info->treelog_bg_lock);\n\tif (fs_info->treelog_bg == bg->start)\n\t\tfs_info->treelog_bg = 0;\n\tspin_unlock(&fs_info->treelog_bg_lock);\n}\n\nstatic inline void btrfs_zoned_data_reloc_lock(struct btrfs_inode *inode)\n{\n\tstruct btrfs_root *root = inode->root;\n\n\tif (btrfs_is_data_reloc_root(root) && btrfs_is_zoned(root->fs_info))\n\t\tmutex_lock(&root->fs_info->zoned_data_reloc_io_lock);\n}\n\nstatic inline void btrfs_zoned_data_reloc_unlock(struct btrfs_inode *inode)\n{\n\tstruct btrfs_root *root = inode->root;\n\n\tif (btrfs_is_data_reloc_root(root) && btrfs_is_zoned(root->fs_info))\n\t\tmutex_unlock(&root->fs_info->zoned_data_reloc_io_lock);\n}\n\nstatic inline bool btrfs_zoned_bg_is_full(const struct btrfs_block_group *bg)\n{\n\tASSERT(btrfs_is_zoned(bg->fs_info));\n\treturn (bg->alloc_offset == bg->zone_capacity);\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}