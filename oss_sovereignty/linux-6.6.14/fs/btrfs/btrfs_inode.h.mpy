{
  "module_name": "btrfs_inode.h",
  "hash_id": "8f9fa29cd0256dbd6d5b340503920dba17fd2f8a86b68f56c80538253adaa525",
  "original_prompt": "Ingested from linux-6.6.14/fs/btrfs/btrfs_inode.h",
  "human_readable_source": " \n \n\n#ifndef BTRFS_INODE_H\n#define BTRFS_INODE_H\n\n#include <linux/hash.h>\n#include <linux/refcount.h>\n#include \"extent_map.h\"\n#include \"extent_io.h\"\n#include \"ordered-data.h\"\n#include \"delayed-inode.h\"\n\n \n#define BTRFS_DIR_START_INDEX 2\n\n \nenum {\n\tBTRFS_INODE_FLUSH_ON_CLOSE,\n\tBTRFS_INODE_DUMMY,\n\tBTRFS_INODE_IN_DEFRAG,\n\tBTRFS_INODE_HAS_ASYNC_EXTENT,\n\t  \n\tBTRFS_INODE_NEEDS_FULL_SYNC,\n\tBTRFS_INODE_COPY_EVERYTHING,\n\tBTRFS_INODE_IN_DELALLOC_LIST,\n\tBTRFS_INODE_HAS_PROPS,\n\tBTRFS_INODE_SNAPSHOT_FLUSH,\n\t \n\tBTRFS_INODE_NO_XATTRS,\n\t \n\tBTRFS_INODE_NO_DELALLOC_FLUSH,\n\t \n\tBTRFS_INODE_VERITY_IN_PROGRESS,\n\t \n\tBTRFS_INODE_FREE_SPACE_INODE,\n};\n\n \nstruct btrfs_inode {\n\t \n\tstruct btrfs_root *root;\n\n\t \n\tstruct btrfs_key location;\n\n\t \n\tspinlock_t lock;\n\n\t \n\tstruct extent_map_tree extent_tree;\n\n\t \n\tstruct extent_io_tree io_tree;\n\n\t \n\tstruct extent_io_tree file_extent_tree;\n\n\t \n\tstruct mutex log_mutex;\n\n\t \n\tstruct btrfs_ordered_inode_tree ordered_tree;\n\n\t \n\tstruct list_head delalloc_inodes;\n\n\t \n\tstruct rb_node rb_node;\n\n\tunsigned long runtime_flags;\n\n\t \n\tu64 generation;\n\n\t \n\tu64 last_trans;\n\n\t \n\tu64 logged_trans;\n\n\t \n\tint last_sub_trans;\n\n\t \n\tint last_log_commit;\n\n\tunion {\n\t\t \n\t\tu64 delalloc_bytes;\n\t\t \n\t\tu64 first_dir_index_to_log;\n\t};\n\n\tunion {\n\t\t \n\t\tu64 new_delalloc_bytes;\n\t\t \n\t\tu64 last_dir_index_offset;\n\t};\n\n\t \n\tu64 defrag_bytes;\n\n\t \n\tu64 disk_i_size;\n\n\t \n\tu64 index_cnt;\n\n\t \n\tu64 dir_index;\n\n\t \n\tu64 last_unlink_trans;\n\n\t \n\tu64 last_reflink_trans;\n\n\t \n\tu64 csum_bytes;\n\n\t \n\tu32 flags;\n\t \n\tu32 ro_flags;\n\n\t \n\tunsigned outstanding_extents;\n\n\tstruct btrfs_block_rsv block_rsv;\n\n\t \n\tunsigned prop_compress;\t\t \n\t \n\tunsigned defrag_compress;\n\n\tstruct btrfs_delayed_node *delayed_node;\n\n\t \n\tstruct timespec64 i_otime;\n\n\t \n\tstruct list_head delayed_iput;\n\n\tstruct rw_semaphore i_mmap_lock;\n\tstruct inode vfs_inode;\n};\n\nstatic inline u64 btrfs_get_first_dir_index_to_log(const struct btrfs_inode *inode)\n{\n\treturn READ_ONCE(inode->first_dir_index_to_log);\n}\n\nstatic inline void btrfs_set_first_dir_index_to_log(struct btrfs_inode *inode,\n\t\t\t\t\t\t    u64 index)\n{\n\tWRITE_ONCE(inode->first_dir_index_to_log, index);\n}\n\nstatic inline struct btrfs_inode *BTRFS_I(const struct inode *inode)\n{\n\treturn container_of(inode, struct btrfs_inode, vfs_inode);\n}\n\nstatic inline unsigned long btrfs_inode_hash(u64 objectid,\n\t\t\t\t\t     const struct btrfs_root *root)\n{\n\tu64 h = objectid ^ (root->root_key.objectid * GOLDEN_RATIO_PRIME);\n\n#if BITS_PER_LONG == 32\n\th = (h >> 32) ^ (h & 0xffffffff);\n#endif\n\n\treturn (unsigned long)h;\n}\n\n#if BITS_PER_LONG == 32\n\n \nstatic inline u64 btrfs_ino(const struct btrfs_inode *inode)\n{\n\tu64 ino = inode->location.objectid;\n\n\t \n\tif (inode->location.type == BTRFS_ROOT_ITEM_KEY)\n\t\tino = inode->vfs_inode.i_ino;\n\treturn ino;\n}\n\n#else\n\nstatic inline u64 btrfs_ino(const struct btrfs_inode *inode)\n{\n\treturn inode->vfs_inode.i_ino;\n}\n\n#endif\n\nstatic inline void btrfs_i_size_write(struct btrfs_inode *inode, u64 size)\n{\n\ti_size_write(&inode->vfs_inode, size);\n\tinode->disk_i_size = size;\n}\n\nstatic inline bool btrfs_is_free_space_inode(struct btrfs_inode *inode)\n{\n\treturn test_bit(BTRFS_INODE_FREE_SPACE_INODE, &inode->runtime_flags);\n}\n\nstatic inline bool is_data_inode(struct inode *inode)\n{\n\treturn btrfs_ino(BTRFS_I(inode)) != BTRFS_BTREE_INODE_OBJECTID;\n}\n\nstatic inline void btrfs_mod_outstanding_extents(struct btrfs_inode *inode,\n\t\t\t\t\t\t int mod)\n{\n\tlockdep_assert_held(&inode->lock);\n\tinode->outstanding_extents += mod;\n\tif (btrfs_is_free_space_inode(inode))\n\t\treturn;\n\ttrace_btrfs_inode_mod_outstanding_extents(inode->root, btrfs_ino(inode),\n\t\t\t\t\t\t  mod, inode->outstanding_extents);\n}\n\n \nstatic inline void btrfs_set_inode_last_sub_trans(struct btrfs_inode *inode)\n{\n\tspin_lock(&inode->lock);\n\tinode->last_sub_trans = inode->root->log_transid;\n\tspin_unlock(&inode->lock);\n}\n\n \nstatic inline void btrfs_set_inode_full_sync(struct btrfs_inode *inode)\n{\n\tset_bit(BTRFS_INODE_NEEDS_FULL_SYNC, &inode->runtime_flags);\n\t \n\tspin_lock(&inode->lock);\n\tif (inode->last_reflink_trans < inode->last_trans)\n\t\tinode->last_reflink_trans = inode->last_trans;\n\tspin_unlock(&inode->lock);\n}\n\nstatic inline bool btrfs_inode_in_log(struct btrfs_inode *inode, u64 generation)\n{\n\tbool ret = false;\n\n\tspin_lock(&inode->lock);\n\tif (inode->logged_trans == generation &&\n\t    inode->last_sub_trans <= inode->last_log_commit &&\n\t    inode->last_sub_trans <= inode->root->last_log_commit)\n\t\tret = true;\n\tspin_unlock(&inode->lock);\n\treturn ret;\n}\n\n \nstatic inline bool btrfs_inode_can_compress(const struct btrfs_inode *inode)\n{\n\tif (inode->flags & BTRFS_INODE_NODATACOW ||\n\t    inode->flags & BTRFS_INODE_NODATASUM)\n\t\treturn false;\n\treturn true;\n}\n\n \n#define CSUM_FMT\t\t\t\t\"0x%*phN\"\n#define CSUM_FMT_VALUE(size, bytes)\t\tsize, bytes\n\nint btrfs_check_sector_csum(struct btrfs_fs_info *fs_info, struct page *page,\n\t\t\t    u32 pgoff, u8 *csum, const u8 * const csum_expected);\nbool btrfs_data_csum_ok(struct btrfs_bio *bbio, struct btrfs_device *dev,\n\t\t\tu32 bio_offset, struct bio_vec *bv);\nnoinline int can_nocow_extent(struct inode *inode, u64 offset, u64 *len,\n\t\t\t      u64 *orig_start, u64 *orig_block_len,\n\t\t\t      u64 *ram_bytes, bool nowait, bool strict);\n\nvoid __btrfs_del_delalloc_inode(struct btrfs_root *root, struct btrfs_inode *inode);\nstruct inode *btrfs_lookup_dentry(struct inode *dir, struct dentry *dentry);\nint btrfs_set_inode_index(struct btrfs_inode *dir, u64 *index);\nint btrfs_unlink_inode(struct btrfs_trans_handle *trans,\n\t\t       struct btrfs_inode *dir, struct btrfs_inode *inode,\n\t\t       const struct fscrypt_str *name);\nint btrfs_add_link(struct btrfs_trans_handle *trans,\n\t\t   struct btrfs_inode *parent_inode, struct btrfs_inode *inode,\n\t\t   const struct fscrypt_str *name, int add_backref, u64 index);\nint btrfs_delete_subvolume(struct btrfs_inode *dir, struct dentry *dentry);\nint btrfs_truncate_block(struct btrfs_inode *inode, loff_t from, loff_t len,\n\t\t\t int front);\n\nint btrfs_start_delalloc_snapshot(struct btrfs_root *root, bool in_reclaim_context);\nint btrfs_start_delalloc_roots(struct btrfs_fs_info *fs_info, long nr,\n\t\t\t       bool in_reclaim_context);\nint btrfs_set_extent_delalloc(struct btrfs_inode *inode, u64 start, u64 end,\n\t\t\t      unsigned int extra_bits,\n\t\t\t      struct extent_state **cached_state);\n\nstruct btrfs_new_inode_args {\n\t \n\tstruct inode *dir;\n\tstruct dentry *dentry;\n\tstruct inode *inode;\n\tbool orphan;\n\tbool subvol;\n\n\t \n\tstruct posix_acl *default_acl;\n\tstruct posix_acl *acl;\n\tstruct fscrypt_name fname;\n};\n\nint btrfs_new_inode_prepare(struct btrfs_new_inode_args *args,\n\t\t\t    unsigned int *trans_num_items);\nint btrfs_create_new_inode(struct btrfs_trans_handle *trans,\n\t\t\t   struct btrfs_new_inode_args *args);\nvoid btrfs_new_inode_args_destroy(struct btrfs_new_inode_args *args);\nstruct inode *btrfs_new_subvol_inode(struct mnt_idmap *idmap,\n\t\t\t\t     struct inode *dir);\n void btrfs_set_delalloc_extent(struct btrfs_inode *inode, struct extent_state *state,\n\t\t\t        u32 bits);\nvoid btrfs_clear_delalloc_extent(struct btrfs_inode *inode,\n\t\t\t\t struct extent_state *state, u32 bits);\nvoid btrfs_merge_delalloc_extent(struct btrfs_inode *inode, struct extent_state *new,\n\t\t\t\t struct extent_state *other);\nvoid btrfs_split_delalloc_extent(struct btrfs_inode *inode,\n\t\t\t\t struct extent_state *orig, u64 split);\nvoid btrfs_set_range_writeback(struct btrfs_inode *inode, u64 start, u64 end);\nvm_fault_t btrfs_page_mkwrite(struct vm_fault *vmf);\nvoid btrfs_evict_inode(struct inode *inode);\nstruct inode *btrfs_alloc_inode(struct super_block *sb);\nvoid btrfs_destroy_inode(struct inode *inode);\nvoid btrfs_free_inode(struct inode *inode);\nint btrfs_drop_inode(struct inode *inode);\nint __init btrfs_init_cachep(void);\nvoid __cold btrfs_destroy_cachep(void);\nstruct inode *btrfs_iget_path(struct super_block *s, u64 ino,\n\t\t\t      struct btrfs_root *root, struct btrfs_path *path);\nstruct inode *btrfs_iget(struct super_block *s, u64 ino, struct btrfs_root *root);\nstruct extent_map *btrfs_get_extent(struct btrfs_inode *inode,\n\t\t\t\t    struct page *page, size_t pg_offset,\n\t\t\t\t    u64 start, u64 end);\nint btrfs_update_inode(struct btrfs_trans_handle *trans,\n\t\t       struct btrfs_root *root, struct btrfs_inode *inode);\nint btrfs_update_inode_fallback(struct btrfs_trans_handle *trans,\n\t\t\t\tstruct btrfs_root *root, struct btrfs_inode *inode);\nint btrfs_orphan_add(struct btrfs_trans_handle *trans, struct btrfs_inode *inode);\nint btrfs_orphan_cleanup(struct btrfs_root *root);\nint btrfs_cont_expand(struct btrfs_inode *inode, loff_t oldsize, loff_t size);\nvoid btrfs_add_delayed_iput(struct btrfs_inode *inode);\nvoid btrfs_run_delayed_iputs(struct btrfs_fs_info *fs_info);\nint btrfs_wait_on_delayed_iputs(struct btrfs_fs_info *fs_info);\nint btrfs_prealloc_file_range(struct inode *inode, int mode,\n\t\t\t      u64 start, u64 num_bytes, u64 min_size,\n\t\t\t      loff_t actual_len, u64 *alloc_hint);\nint btrfs_prealloc_file_range_trans(struct inode *inode,\n\t\t\t\t    struct btrfs_trans_handle *trans, int mode,\n\t\t\t\t    u64 start, u64 num_bytes, u64 min_size,\n\t\t\t\t    loff_t actual_len, u64 *alloc_hint);\nint btrfs_run_delalloc_range(struct btrfs_inode *inode, struct page *locked_page,\n\t\t\t     u64 start, u64 end, struct writeback_control *wbc);\nint btrfs_writepage_cow_fixup(struct page *page);\nint btrfs_encoded_io_compression_from_extent(struct btrfs_fs_info *fs_info,\n\t\t\t\t\t     int compress_type);\nint btrfs_encoded_read_regular_fill_pages(struct btrfs_inode *inode,\n\t\t\t\t\t  u64 file_offset, u64 disk_bytenr,\n\t\t\t\t\t  u64 disk_io_size,\n\t\t\t\t\t  struct page **pages);\nssize_t btrfs_encoded_read(struct kiocb *iocb, struct iov_iter *iter,\n\t\t\t   struct btrfs_ioctl_encoded_io_args *encoded);\nssize_t btrfs_do_encoded_write(struct kiocb *iocb, struct iov_iter *from,\n\t\t\t       const struct btrfs_ioctl_encoded_io_args *encoded);\n\nssize_t btrfs_dio_read(struct kiocb *iocb, struct iov_iter *iter,\n\t\t       size_t done_before);\nstruct iomap_dio *btrfs_dio_write(struct kiocb *iocb, struct iov_iter *iter,\n\t\t\t\t  size_t done_before);\n\nextern const struct dentry_operations btrfs_dentry_operations;\n\n \nenum btrfs_ilock_type {\n\tENUM_BIT(BTRFS_ILOCK_SHARED),\n\tENUM_BIT(BTRFS_ILOCK_TRY),\n\tENUM_BIT(BTRFS_ILOCK_MMAP),\n};\n\nint btrfs_inode_lock(struct btrfs_inode *inode, unsigned int ilock_flags);\nvoid btrfs_inode_unlock(struct btrfs_inode *inode, unsigned int ilock_flags);\nvoid btrfs_update_inode_bytes(struct btrfs_inode *inode, const u64 add_bytes,\n\t\t\t      const u64 del_bytes);\nvoid btrfs_assert_inode_range_clean(struct btrfs_inode *inode, u64 start, u64 end);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}