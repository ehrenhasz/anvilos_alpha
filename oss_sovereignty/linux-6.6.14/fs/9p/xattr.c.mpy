{
  "module_name": "xattr.c",
  "hash_id": "259e6719916ce34d2270a987e16e802d9e568b6350c4842a35b7996b64226cd2",
  "original_prompt": "Ingested from linux-6.6.14/fs/9p/xattr.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/fs.h>\n#include <linux/sched.h>\n#include <linux/uio.h>\n#include <linux/posix_acl_xattr.h>\n#include <net/9p/9p.h>\n#include <net/9p/client.h>\n\n#include \"fid.h\"\n#include \"xattr.h\"\n\nssize_t v9fs_fid_xattr_get(struct p9_fid *fid, const char *name,\n\t\t\t   void *buffer, size_t buffer_size)\n{\n\tssize_t retval;\n\tu64 attr_size;\n\tstruct p9_fid *attr_fid;\n\tstruct kvec kvec = {.iov_base = buffer, .iov_len = buffer_size};\n\tstruct iov_iter to;\n\tint err;\n\n\tiov_iter_kvec(&to, ITER_DEST, &kvec, 1, buffer_size);\n\n\tattr_fid = p9_client_xattrwalk(fid, name, &attr_size);\n\tif (IS_ERR(attr_fid)) {\n\t\tretval = PTR_ERR(attr_fid);\n\t\tp9_debug(P9_DEBUG_VFS, \"p9_client_attrwalk failed %zd\\n\",\n\t\t\t retval);\n\t\treturn retval;\n\t}\n\tif (attr_size > buffer_size) {\n\t\tif (buffer_size)\n\t\t\tretval = -ERANGE;\n\t\telse if (attr_size > SSIZE_MAX)\n\t\t\tretval = -EOVERFLOW;\n\t\telse  \n\t\t\tretval = attr_size;\n\t} else {\n\t\tiov_iter_truncate(&to, attr_size);\n\t\tretval = p9_client_read(attr_fid, 0, &to, &err);\n\t\tif (err)\n\t\t\tretval = err;\n\t}\n\tp9_fid_put(attr_fid);\n\treturn retval;\n}\n\n\n \nssize_t v9fs_xattr_get(struct dentry *dentry, const char *name,\n\t\t       void *buffer, size_t buffer_size)\n{\n\tstruct p9_fid *fid;\n\tint ret;\n\n\tp9_debug(P9_DEBUG_VFS, \"name = '%s' value_len = %zu\\n\",\n\t\t name, buffer_size);\n\tfid = v9fs_fid_lookup(dentry);\n\tif (IS_ERR(fid))\n\t\treturn PTR_ERR(fid);\n\tret = v9fs_fid_xattr_get(fid, name, buffer, buffer_size);\n\tp9_fid_put(fid);\n\n\treturn ret;\n}\n\n \nint v9fs_xattr_set(struct dentry *dentry, const char *name,\n\t\t   const void *value, size_t value_len, int flags)\n{\n\tint ret;\n\tstruct p9_fid *fid;\n\n\tfid  = v9fs_fid_lookup(dentry);\n\tif (IS_ERR(fid))\n\t\treturn PTR_ERR(fid);\n\tret = v9fs_fid_xattr_set(fid, name, value, value_len, flags);\n\tp9_fid_put(fid);\n\treturn ret;\n}\n\nint v9fs_fid_xattr_set(struct p9_fid *fid, const char *name,\n\t\t   const void *value, size_t value_len, int flags)\n{\n\tstruct kvec kvec = {.iov_base = (void *)value, .iov_len = value_len};\n\tstruct iov_iter from;\n\tint retval, err;\n\n\tiov_iter_kvec(&from, ITER_SOURCE, &kvec, 1, value_len);\n\n\tp9_debug(P9_DEBUG_VFS, \"name = %s value_len = %zu flags = %d\\n\",\n\t\t name, value_len, flags);\n\n\t \n\tfid = clone_fid(fid);\n\tif (IS_ERR(fid))\n\t\treturn PTR_ERR(fid);\n\n\t \n\tretval = p9_client_xattrcreate(fid, name, value_len, flags);\n\tif (retval < 0)\n\t\tp9_debug(P9_DEBUG_VFS, \"p9_client_xattrcreate failed %d\\n\",\n\t\t\t retval);\n\telse\n\t\tp9_client_write(fid, 0, &from, &retval);\n\terr = p9_fid_put(fid);\n\tif (!retval && err)\n\t\tretval = err;\n\treturn retval;\n}\n\nssize_t v9fs_listxattr(struct dentry *dentry, char *buffer, size_t buffer_size)\n{\n\t \n\treturn v9fs_xattr_get(dentry, \"\", buffer, buffer_size);\n}\n\nstatic int v9fs_xattr_handler_get(const struct xattr_handler *handler,\n\t\t\t\t  struct dentry *dentry, struct inode *inode,\n\t\t\t\t  const char *name, void *buffer, size_t size)\n{\n\tconst char *full_name = xattr_full_name(handler, name);\n\n\treturn v9fs_xattr_get(dentry, full_name, buffer, size);\n}\n\nstatic int v9fs_xattr_handler_set(const struct xattr_handler *handler,\n\t\t\t\t  struct mnt_idmap *idmap,\n\t\t\t\t  struct dentry *dentry, struct inode *inode,\n\t\t\t\t  const char *name, const void *value,\n\t\t\t\t  size_t size, int flags)\n{\n\tconst char *full_name = xattr_full_name(handler, name);\n\n\treturn v9fs_xattr_set(dentry, full_name, value, size, flags);\n}\n\nstatic struct xattr_handler v9fs_xattr_user_handler = {\n\t.prefix\t= XATTR_USER_PREFIX,\n\t.get\t= v9fs_xattr_handler_get,\n\t.set\t= v9fs_xattr_handler_set,\n};\n\nstatic struct xattr_handler v9fs_xattr_trusted_handler = {\n\t.prefix\t= XATTR_TRUSTED_PREFIX,\n\t.get\t= v9fs_xattr_handler_get,\n\t.set\t= v9fs_xattr_handler_set,\n};\n\n#ifdef CONFIG_9P_FS_SECURITY\nstatic struct xattr_handler v9fs_xattr_security_handler = {\n\t.prefix\t= XATTR_SECURITY_PREFIX,\n\t.get\t= v9fs_xattr_handler_get,\n\t.set\t= v9fs_xattr_handler_set,\n};\n#endif\n\nconst struct xattr_handler *v9fs_xattr_handlers[] = {\n\t&v9fs_xattr_user_handler,\n\t&v9fs_xattr_trusted_handler,\n#ifdef CONFIG_9P_FS_SECURITY\n\t&v9fs_xattr_security_handler,\n#endif\n\tNULL\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}