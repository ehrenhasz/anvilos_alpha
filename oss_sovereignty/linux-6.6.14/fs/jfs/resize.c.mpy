{
  "module_name": "resize.c",
  "hash_id": "8a47b9157c70bc1c8f731b0c5695c11b134dbe10191df2f9c5511463eb4a3efa",
  "original_prompt": "Ingested from linux-6.6.14/fs/jfs/resize.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/buffer_head.h>\n#include <linux/quotaops.h>\n#include <linux/blkdev.h>\n#include \"jfs_incore.h\"\n#include \"jfs_filsys.h\"\n#include \"jfs_metapage.h\"\n#include \"jfs_dinode.h\"\n#include \"jfs_imap.h\"\n#include \"jfs_dmap.h\"\n#include \"jfs_superblock.h\"\n#include \"jfs_txnmgr.h\"\n#include \"jfs_debug.h\"\n\n#define BITSPERPAGE\t(PSIZE << 3)\n#define L2MEGABYTE\t20\n#define MEGABYTE\t(1 << L2MEGABYTE)\n#define MEGABYTE32\t(MEGABYTE << 5)\n\n \n#define BLKTODMAPN(b)\\\n\t(((b) >> 13) + ((b) >> 23) + ((b) >> 33) + 3 + 1)\n\n \nint jfs_extendfs(struct super_block *sb, s64 newLVSize, int newLogSize)\n{\n\tint rc = 0;\n\tstruct jfs_sb_info *sbi = JFS_SBI(sb);\n\tstruct inode *ipbmap = sbi->ipbmap;\n\tstruct inode *ipbmap2;\n\tstruct inode *ipimap = sbi->ipimap;\n\tstruct jfs_log *log = sbi->log;\n\tstruct bmap *bmp = sbi->bmap;\n\ts64 newLogAddress, newFSCKAddress;\n\tint newFSCKSize;\n\ts64 newMapSize = 0, mapSize;\n\ts64 XAddress, XSize, nblocks, xoff, xaddr, t64;\n\ts64 oldLVSize;\n\ts64 newFSSize;\n\ts64 VolumeSize;\n\tint newNpages = 0, nPages, newPage, xlen, t32;\n\tint tid;\n\tint log_formatted = 0;\n\tstruct inode *iplist[1];\n\tstruct jfs_superblock *j_sb, *j_sb2;\n\ts64 old_agsize;\n\tint agsizechanged = 0;\n\tstruct buffer_head *bh, *bh2;\n\n\t \n\n\tif (sbi->mntflag & JFS_INLINELOG)\n\t\toldLVSize = addressPXD(&sbi->logpxd) + lengthPXD(&sbi->logpxd);\n\telse\n\t\toldLVSize = addressPXD(&sbi->fsckpxd) +\n\t\t    lengthPXD(&sbi->fsckpxd);\n\n\tif (oldLVSize >= newLVSize) {\n\t\tprintk(KERN_WARNING\n\t\t       \"jfs_extendfs: volume hasn't grown, returning\\n\");\n\t\tgoto out;\n\t}\n\n\tVolumeSize = sb_bdev_nr_blocks(sb);\n\tif (VolumeSize) {\n\t\tif (newLVSize > VolumeSize) {\n\t\t\tprintk(KERN_WARNING \"jfs_extendfs: invalid size\\n\");\n\t\t\trc = -EINVAL;\n\t\t\tgoto out;\n\t\t}\n\t} else {\n\t\t \n\t\tbh = sb_bread(sb, newLVSize - 1);\n\t\tif (!bh) {\n\t\t\tprintk(KERN_WARNING \"jfs_extendfs: invalid size\\n\");\n\t\t\trc = -EINVAL;\n\t\t\tgoto out;\n\t\t}\n\t\tbforget(bh);\n\t}\n\n\t \n\n\tif (isReadOnly(ipbmap)) {\n\t\tprintk(KERN_WARNING \"jfs_extendfs: read-only file system\\n\");\n\t\trc = -EROFS;\n\t\tgoto out;\n\t}\n\n\t \n\n\t \n\tif ((sbi->mntflag & JFS_INLINELOG)) {\n\t\tif (newLogSize == 0) {\n\t\t\t \n\t\t\tnewLogSize = newLVSize >> 8;\n\t\t\tt32 = (1 << (20 - sbi->l2bsize)) - 1;\n\t\t\tnewLogSize = (newLogSize + t32) & ~t32;\n\t\t\tnewLogSize =\n\t\t\t    min(newLogSize, MEGABYTE32 >> sbi->l2bsize);\n\t\t} else {\n\t\t\t \n\t\t\tnewLogSize = (newLogSize * MEGABYTE) >> sbi->l2bsize;\n\t\t}\n\n\t} else\n\t\tnewLogSize = 0;\n\n\tnewLogAddress = newLVSize - newLogSize;\n\n\t \n\tt64 = ((newLVSize - newLogSize + BPERDMAP - 1) >> L2BPERDMAP)\n\t    << L2BPERDMAP;\n\tt32 = DIV_ROUND_UP(t64, BITSPERPAGE) + 1 + 50;\n\tnewFSCKSize = t32 << sbi->l2nbperpage;\n\tnewFSCKAddress = newLogAddress - newFSCKSize;\n\n\t \n\tnewFSSize = newLVSize - newLogSize - newFSCKSize;\n\n\t \n\tif (newFSSize < bmp->db_mapsize) {\n\t\trc = -EINVAL;\n\t\tgoto out;\n\t}\n\n\t \n\tif ((sbi->mntflag & JFS_INLINELOG) && (newLogAddress > oldLVSize)) {\n\t\tif ((rc = lmLogFormat(log, newLogAddress, newLogSize)))\n\t\t\tgoto out;\n\t\tlog_formatted = 1;\n\t}\n\t \n\ttxQuiesce(sb);\n\n\t \n\tsbi->direct_inode->i_size = bdev_nr_bytes(sb->s_bdev);\n\n\tif (sbi->mntflag & JFS_INLINELOG) {\n\t\t \n\t\tlmLogShutdown(log);\n\n\t\t \n\n\t\t \n\t\tif ((rc = readSuper(sb, &bh)))\n\t\t\tgoto error_out;\n\t\tj_sb = (struct jfs_superblock *)bh->b_data;\n\n\t\t \n\t\tj_sb->s_state |= cpu_to_le32(FM_EXTENDFS);\n\t\tj_sb->s_xsize = cpu_to_le64(newFSSize);\n\t\tPXDaddress(&j_sb->s_xfsckpxd, newFSCKAddress);\n\t\tPXDlength(&j_sb->s_xfsckpxd, newFSCKSize);\n\t\tPXDaddress(&j_sb->s_xlogpxd, newLogAddress);\n\t\tPXDlength(&j_sb->s_xlogpxd, newLogSize);\n\n\t\t \n\t\tmark_buffer_dirty(bh);\n\t\tsync_dirty_buffer(bh);\n\t\tbrelse(bh);\n\n\t\t \n\t\tif (!log_formatted)\n\t\t\tif ((rc = lmLogFormat(log, newLogAddress, newLogSize)))\n\t\t\t\tgoto error_out;\n\n\t\t \n\t\tlog->base = newLogAddress;\n\t\tlog->size = newLogSize >> (L2LOGPSIZE - sb->s_blocksize_bits);\n\t\tif ((rc = lmLogInit(log)))\n\t\t\tgoto error_out;\n\t}\n\n\t \n\t \n\tnewMapSize = newFSSize;\n\t \n\tt64 = (newMapSize - 1) + BPERDMAP;\n\tnewNpages = BLKTODMAPN(t64) + 1;\n\n\t \n      extendBmap:\n\t \n\tmapSize = bmp->db_mapsize;\n\tXAddress = mapSize;\t \n\tXSize = newMapSize - mapSize;\t \n\told_agsize = bmp->db_agsize;\t \n\n\t \n\tt64 = dbMapFileSizeToMapSize(ipbmap);\n\tif (mapSize > t64) {\n\t\tprintk(KERN_ERR \"jfs_extendfs: mapSize (0x%Lx) > t64 (0x%Lx)\\n\",\n\t\t       (long long) mapSize, (long long) t64);\n\t\trc = -EIO;\n\t\tgoto error_out;\n\t}\n\tnblocks = min(t64 - mapSize, XSize);\n\n\t \n\tif ((rc = dbExtendFS(ipbmap, XAddress, nblocks)))\n\t\tgoto error_out;\n\n\tagsizechanged |= (bmp->db_agsize != old_agsize);\n\n\t \n\t \n\tXSize -= nblocks;\n\n\t \n\t \n\tnPages = ipbmap->i_size >> L2PSIZE;\n\n\t \n\tif (nPages == newNpages)\n\t\tgoto finalizeBmap;\n\n\t \n\t \n\t \n\trc = filemap_fdatawait(ipbmap->i_mapping);\n\tif (rc)\n\t\tgoto error_out;\n\n\trc = filemap_write_and_wait(ipbmap->i_mapping);\n\tif (rc)\n\t\tgoto error_out;\n\n\tdiWriteSpecial(ipbmap, 0);\n\n\tnewPage = nPages;\t \n\txoff = newPage << sbi->l2nbperpage;\n\txlen = (newNpages - nPages) << sbi->l2nbperpage;\n\txlen = min(xlen, (int) nblocks) & ~(sbi->nbperpage - 1);\n\txaddr = XAddress;\n\n\ttid = txBegin(sb, COMMIT_FORCE);\n\n\tif ((rc = xtAppend(tid, ipbmap, 0, xoff, nblocks, &xlen, &xaddr, 0))) {\n\t\ttxEnd(tid);\n\t\tgoto error_out;\n\t}\n\t \n\tipbmap->i_size += xlen << sbi->l2bsize;\n\tinode_add_bytes(ipbmap, xlen << sbi->l2bsize);\n\n\tiplist[0] = ipbmap;\n\trc = txCommit(tid, 1, &iplist[0], COMMIT_FORCE);\n\n\ttxEnd(tid);\n\n\tif (rc)\n\t\tgoto error_out;\n\n\t \n\t \n\tif (XSize)\n\t\tgoto extendBmap;\n\n      finalizeBmap:\n\t \n\tdbFinalizeBmap(ipbmap);\n\n\t \n\t \n\tif (agsizechanged) {\n\t\tif ((rc = diExtendFS(ipimap, ipbmap)))\n\t\t\tgoto error_out;\n\n\t\t \n\t\tif ((rc = diSync(ipimap)))\n\t\t\tgoto error_out;\n\t}\n\n\t \n\n\t \n\t \n\n\t \n\tif ((rc = dbSync(ipbmap)))\n\t\tgoto error_out;\n\n\t \n\n\tipbmap2 = diReadSpecial(sb, BMAP_I, 1);\n\tif (ipbmap2 == NULL) {\n\t\tprintk(KERN_ERR \"jfs_extendfs: diReadSpecial(bmap) failed\\n\");\n\t\tgoto error_out;\n\t}\n\tmemcpy(&JFS_IP(ipbmap2)->i_xtroot, &JFS_IP(ipbmap)->i_xtroot, 288);\n\tipbmap2->i_size = ipbmap->i_size;\n\tipbmap2->i_blocks = ipbmap->i_blocks;\n\n\tdiWriteSpecial(ipbmap2, 1);\n\tdiFreeSpecial(ipbmap2);\n\n\t \n\tif ((rc = readSuper(sb, &bh)))\n\t\tgoto error_out;\n\tj_sb = (struct jfs_superblock *)bh->b_data;\n\n\t \n\tj_sb->s_state &= cpu_to_le32(~FM_EXTENDFS);\n\tj_sb->s_size = cpu_to_le64(bmp->db_mapsize <<\n\t\t\t\t   le16_to_cpu(j_sb->s_l2bfactor));\n\tj_sb->s_agsize = cpu_to_le32(bmp->db_agsize);\n\n\t \n\tif (sbi->mntflag & JFS_INLINELOG) {\n\t\tPXDaddress(&(j_sb->s_logpxd), newLogAddress);\n\t\tPXDlength(&(j_sb->s_logpxd), newLogSize);\n\t}\n\n\t \n\tj_sb->s_logserial = cpu_to_le32(log->serial);\n\n\t \n\tPXDaddress(&(j_sb->s_fsckpxd), newFSCKAddress);\n\tPXDlength(&(j_sb->s_fsckpxd), newFSCKSize);\n\tj_sb->s_fscklog = 1;\n\t \n\n\t \n\tbh2 = sb_bread(sb, SUPER2_OFF >> sb->s_blocksize_bits);\n\tif (bh2) {\n\t\tj_sb2 = (struct jfs_superblock *)bh2->b_data;\n\t\tmemcpy(j_sb2, j_sb, sizeof (struct jfs_superblock));\n\n\t\tmark_buffer_dirty(bh);\n\t\tsync_dirty_buffer(bh2);\n\t\tbrelse(bh2);\n\t}\n\n\t \n\tmark_buffer_dirty(bh);\n\tsync_dirty_buffer(bh);\n\tbrelse(bh);\n\n\tgoto resume;\n\n      error_out:\n\tjfs_error(sb, \"\\n\");\n\n      resume:\n\t \n\ttxResume(sb);\n\n      out:\n\treturn rc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}