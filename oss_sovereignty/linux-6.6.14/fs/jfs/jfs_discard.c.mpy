{
  "module_name": "jfs_discard.c",
  "hash_id": "64d22c577db0ad0a9c82dfcd1063cce343df6e7d6a67e8e3194b238dabdb2b03",
  "original_prompt": "Ingested from linux-6.6.14/fs/jfs/jfs_discard.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/slab.h>\n#include <linux/blkdev.h>\n\n#include \"jfs_incore.h\"\n#include \"jfs_superblock.h\"\n#include \"jfs_discard.h\"\n#include \"jfs_dmap.h\"\n#include \"jfs_debug.h\"\n\n\n \nvoid jfs_issue_discard(struct inode *ip, u64 blkno, u64 nblocks)\n{\n\tstruct super_block *sb = ip->i_sb;\n\tint r = 0;\n\n\tr = sb_issue_discard(sb, blkno, nblocks, GFP_NOFS, 0);\n\tif (unlikely(r != 0)) {\n\t\tjfs_err(\"JFS: sb_issue_discard(%p, %llu, %llu, GFP_NOFS, 0) = %d => failed!\",\n\t\t\tsb, (unsigned long long)blkno,\n\t\t\t(unsigned long long)nblocks, r);\n\t}\n\n\tjfs_info(\"JFS: sb_issue_discard(%p, %llu, %llu, GFP_NOFS, 0) = %d\",\n\t\tsb, (unsigned long long)blkno,\n\t\t(unsigned long long)nblocks, r);\n\n\treturn;\n}\n\n \nint jfs_ioc_trim(struct inode *ip, struct fstrim_range *range)\n{\n\tstruct inode *ipbmap = JFS_SBI(ip->i_sb)->ipbmap;\n\tstruct bmap *bmp = JFS_SBI(ip->i_sb)->bmap;\n\tstruct super_block *sb = ipbmap->i_sb;\n\tint agno, agno_end;\n\tu64 start, end, minlen;\n\tu64 trimmed = 0;\n\n\t \n\tstart = range->start >> sb->s_blocksize_bits;\n\tend = start + (range->len >> sb->s_blocksize_bits) - 1;\n\tminlen = range->minlen >> sb->s_blocksize_bits;\n\tif (minlen == 0)\n\t\tminlen = 1;\n\n\tif (minlen > bmp->db_agsize ||\n\t    start >= bmp->db_mapsize ||\n\t    range->len < sb->s_blocksize)\n\t\treturn -EINVAL;\n\n\tif (end >= bmp->db_mapsize)\n\t\tend = bmp->db_mapsize - 1;\n\n\t \n\tagno = BLKTOAG(start, JFS_SBI(ip->i_sb));\n\tagno_end = BLKTOAG(end, JFS_SBI(ip->i_sb));\n\twhile (agno <= agno_end) {\n\t\ttrimmed += dbDiscardAG(ip, agno, minlen);\n\t\tagno++;\n\t}\n\trange->len = trimmed << sb->s_blocksize_bits;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}