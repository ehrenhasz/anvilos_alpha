{
  "module_name": "grace.c",
  "hash_id": "40290098b12ea01074d588adc6d3edb8f72b559d0e9291f24cfd00ea0295450c",
  "original_prompt": "Ingested from linux-6.6.14/fs/nfs_common/grace.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <net/net_namespace.h>\n#include <net/netns/generic.h>\n#include <linux/fs.h>\n#include <linux/filelock.h>\n\nstatic unsigned int grace_net_id;\nstatic DEFINE_SPINLOCK(grace_lock);\n\n \nvoid\nlocks_start_grace(struct net *net, struct lock_manager *lm)\n{\n\tstruct list_head *grace_list = net_generic(net, grace_net_id);\n\n\tspin_lock(&grace_lock);\n\tif (list_empty(&lm->list))\n\t\tlist_add(&lm->list, grace_list);\n\telse\n\t\tWARN(1, \"double list_add attempt detected in net %x %s\\n\",\n\t\t     net->ns.inum, (net == &init_net) ? \"(init_net)\" : \"\");\n\tspin_unlock(&grace_lock);\n}\nEXPORT_SYMBOL_GPL(locks_start_grace);\n\n \nvoid\nlocks_end_grace(struct lock_manager *lm)\n{\n\tspin_lock(&grace_lock);\n\tlist_del_init(&lm->list);\n\tspin_unlock(&grace_lock);\n}\nEXPORT_SYMBOL_GPL(locks_end_grace);\n\nstatic bool\n__state_in_grace(struct net *net, bool open)\n{\n\tstruct list_head *grace_list = net_generic(net, grace_net_id);\n\tstruct lock_manager *lm;\n\n\tif (!open)\n\t\treturn !list_empty(grace_list);\n\n\tspin_lock(&grace_lock);\n\tlist_for_each_entry(lm, grace_list, list) {\n\t\tif (lm->block_opens) {\n\t\t\tspin_unlock(&grace_lock);\n\t\t\treturn true;\n\t\t}\n\t}\n\tspin_unlock(&grace_lock);\n\treturn false;\n}\n\n \nbool locks_in_grace(struct net *net)\n{\n\treturn __state_in_grace(net, false);\n}\nEXPORT_SYMBOL_GPL(locks_in_grace);\n\nbool opens_in_grace(struct net *net)\n{\n\treturn __state_in_grace(net, true);\n}\nEXPORT_SYMBOL_GPL(opens_in_grace);\n\nstatic int __net_init\ngrace_init_net(struct net *net)\n{\n\tstruct list_head *grace_list = net_generic(net, grace_net_id);\n\n\tINIT_LIST_HEAD(grace_list);\n\treturn 0;\n}\n\nstatic void __net_exit\ngrace_exit_net(struct net *net)\n{\n\tstruct list_head *grace_list = net_generic(net, grace_net_id);\n\n\tWARN_ONCE(!list_empty(grace_list),\n\t\t  \"net %x %s: grace_list is not empty\\n\",\n\t\t  net->ns.inum, __func__);\n}\n\nstatic struct pernet_operations grace_net_ops = {\n\t.init = grace_init_net,\n\t.exit = grace_exit_net,\n\t.id   = &grace_net_id,\n\t.size = sizeof(struct list_head),\n};\n\nstatic int __init\ninit_grace(void)\n{\n\treturn register_pernet_subsys(&grace_net_ops);\n}\n\nstatic void __exit\nexit_grace(void)\n{\n\tunregister_pernet_subsys(&grace_net_ops);\n}\n\nMODULE_AUTHOR(\"Jeff Layton <jlayton@primarydata.com>\");\nMODULE_LICENSE(\"GPL\");\nmodule_init(init_grace)\nmodule_exit(exit_grace)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}