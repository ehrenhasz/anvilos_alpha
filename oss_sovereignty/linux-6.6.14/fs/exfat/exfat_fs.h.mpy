{
  "module_name": "exfat_fs.h",
  "hash_id": "c521892968f11e3759a79c2bc255e0177c0a15b1026e34fe54fdd434856f838d",
  "original_prompt": "Ingested from linux-6.6.14/fs/exfat/exfat_fs.h",
  "human_readable_source": " \n \n\n#ifndef _EXFAT_FS_H\n#define _EXFAT_FS_H\n\n#include <linux/fs.h>\n#include <linux/ratelimit.h>\n#include <linux/nls.h>\n#include <linux/blkdev.h>\n\n#define EXFAT_ROOT_INO\t\t1\n\n#define EXFAT_CLUSTERS_UNTRACKED (~0u)\n\n \nenum exfat_error_mode {\n\tEXFAT_ERRORS_CONT,\t \n\tEXFAT_ERRORS_PANIC,\t \n\tEXFAT_ERRORS_RO,\t \n};\n\n \nenum {\n\tNLS_NAME_NO_LOSSY =\t0,\t \n\tNLS_NAME_LOSSY =\t1 << 0,\t \n\tNLS_NAME_OVERLEN =\t1 << 1,\t \n};\n\n#define EXFAT_HASH_BITS\t\t8\n#define EXFAT_HASH_SIZE\t\t(1UL << EXFAT_HASH_BITS)\n\n \n#define ES_2_ENTRIES\t\t2\n#define ES_ALL_ENTRIES\t\t0\n\n#define ES_IDX_FILE\t\t0\n#define ES_IDX_STREAM\t\t1\n#define ES_IDX_FIRST_FILENAME\t2\n#define EXFAT_FILENAME_ENTRY_NUM(name_len) \\\n\tDIV_ROUND_UP(name_len, EXFAT_FILE_NAME_LEN)\n#define ES_IDX_LAST_FILENAME(name_len)\t\\\n\t(ES_IDX_FIRST_FILENAME + EXFAT_FILENAME_ENTRY_NUM(name_len) - 1)\n\n#define DIR_DELETED\t\t0xFFFFFFF7\n\n \n#define TYPE_UNUSED\t\t0x0000\n#define TYPE_DELETED\t\t0x0001\n#define TYPE_INVALID\t\t0x0002\n#define TYPE_CRITICAL_PRI\t0x0100\n#define TYPE_BITMAP\t\t0x0101\n#define TYPE_UPCASE\t\t0x0102\n#define TYPE_VOLUME\t\t0x0103\n#define TYPE_DIR\t\t0x0104\n#define TYPE_FILE\t\t0x011F\n#define TYPE_CRITICAL_SEC\t0x0200\n#define TYPE_STREAM\t\t0x0201\n#define TYPE_EXTEND\t\t0x0202\n#define TYPE_ACL\t\t0x0203\n#define TYPE_BENIGN_PRI\t\t0x0400\n#define TYPE_GUID\t\t0x0401\n#define TYPE_PADDING\t\t0x0402\n#define TYPE_ACLTAB\t\t0x0403\n#define TYPE_BENIGN_SEC\t\t0x0800\n#define TYPE_VENDOR_EXT\t\t0x0801\n#define TYPE_VENDOR_ALLOC\t0x0802\n\n#define MAX_CHARSET_SIZE\t6  \n#define MAX_NAME_LENGTH\t\t255  \n#define MAX_VFSNAME_BUF_SIZE\t((MAX_NAME_LENGTH + 1) * MAX_CHARSET_SIZE)\n\n#define EXFAT_HINT_NONE\t\t-1\n#define EXFAT_MIN_SUBDIR\t2\n\n \n#define EXFAT_CLU_TO_B(b, sbi)\t\t((b) << (sbi)->cluster_size_bits)\n#define EXFAT_B_TO_CLU(b, sbi)\t\t((b) >> (sbi)->cluster_size_bits)\n#define EXFAT_B_TO_CLU_ROUND_UP(b, sbi)\t\\\n\t(((b - 1) >> (sbi)->cluster_size_bits) + 1)\n#define EXFAT_CLU_OFFSET(off, sbi)\t((off) & ((sbi)->cluster_size - 1))\n\n \n#define EXFAT_BLK_TO_B(b, sb)\t\t((b) << (sb)->s_blocksize_bits)\n#define EXFAT_B_TO_BLK(b, sb)\t\t((b) >> (sb)->s_blocksize_bits)\n#define EXFAT_B_TO_BLK_ROUND_UP(b, sb)\t\\\n\t(((b - 1) >> (sb)->s_blocksize_bits) + 1)\n#define EXFAT_BLK_OFFSET(off, sb)\t((off) & ((sb)->s_blocksize - 1))\n\n \n#define EXFAT_B_TO_DEN(b)\t\t((b) >> DENTRY_SIZE_BITS)\n#define EXFAT_DEN_TO_B(b)\t\t((b) << DENTRY_SIZE_BITS)\n\n \n#define EXFAT_CLU_TO_DEN(clu, sbi)\t\\\n\t((clu) << ((sbi)->cluster_size_bits - DENTRY_SIZE_BITS))\n#define EXFAT_DEN_TO_CLU(dentry, sbi)\t\\\n\t((dentry) >> ((sbi)->cluster_size_bits - DENTRY_SIZE_BITS))\n\n \n#define FAT_ENT_SIZE (4)\n#define FAT_ENT_SIZE_BITS (2)\n#define FAT_ENT_OFFSET_SECTOR(sb, loc) (EXFAT_SB(sb)->FAT1_start_sector + \\\n\t(((u64)loc << FAT_ENT_SIZE_BITS) >> sb->s_blocksize_bits))\n#define FAT_ENT_OFFSET_BYTE_IN_SECTOR(sb, loc)\t\\\n\t((loc << FAT_ENT_SIZE_BITS) & (sb->s_blocksize - 1))\n\n \n#define CLUSTER_TO_BITMAP_ENT(clu) ((clu) - EXFAT_RESERVED_CLUSTERS)\n#define BITMAP_ENT_TO_CLUSTER(ent) ((ent) + EXFAT_RESERVED_CLUSTERS)\n#define BITS_PER_SECTOR(sb) ((sb)->s_blocksize * BITS_PER_BYTE)\n#define BITS_PER_SECTOR_MASK(sb) (BITS_PER_SECTOR(sb) - 1)\n#define BITMAP_OFFSET_SECTOR_INDEX(sb, ent) \\\n\t((ent / BITS_PER_BYTE) >> (sb)->s_blocksize_bits)\n#define BITMAP_OFFSET_BIT_IN_SECTOR(sb, ent) (ent & BITS_PER_SECTOR_MASK(sb))\n#define BITMAP_OFFSET_BYTE_IN_SECTOR(sb, ent) \\\n\t((ent / BITS_PER_BYTE) & ((sb)->s_blocksize - 1))\n#define BITS_PER_BYTE_MASK\t0x7\n#define IGNORED_BITS_REMAINED(clu, clu_base) ((1 << ((clu) - (clu_base))) - 1)\n\n#define ES_ENTRY_NUM(name_len)\t(ES_IDX_LAST_FILENAME(name_len) + 1)\n \n#define ES_MAX_ENTRY_NUM\tES_ENTRY_NUM(MAX_NAME_LENGTH)\n\n \n#define DIR_CACHE_SIZE\t\t\\\n\t(DIV_ROUND_UP(EXFAT_DEN_TO_B(ES_MAX_ENTRY_NUM), SECTOR_SIZE) + 1)\n\nstruct exfat_dentry_namebuf {\n\tchar *lfn;\n\tint lfnbuf_len;  \n};\n\n \nstruct exfat_uni_name {\n\t \n\tunsigned short name[MAX_NAME_LENGTH + 3];\n\tu16 name_hash;\n\tunsigned char name_len;\n};\n\n \nstruct exfat_chain {\n\tunsigned int dir;\n\tunsigned int size;\n\tunsigned char flags;\n};\n\n \nstruct exfat_hint_femp {\n\t \n\tint eidx;\n\t \n\tint count;\n\t \n\tstruct exfat_chain cur;\n};\n\n \nstruct exfat_hint {\n\tunsigned int clu;\n\tunion {\n\t\tunsigned int off;  \n\t\tint eidx;  \n\t};\n};\n\nstruct exfat_entry_set_cache {\n\tstruct super_block *sb;\n\tunsigned int start_off;\n\tint num_bh;\n\tstruct buffer_head *__bh[DIR_CACHE_SIZE];\n\tstruct buffer_head **bh;\n\tunsigned int num_entries;\n\tbool modified;\n};\n\n#define IS_DYNAMIC_ES(es)\t((es)->__bh != (es)->bh)\n\nstruct exfat_dir_entry {\n\tstruct exfat_chain dir;\n\tint entry;\n\tunsigned int type;\n\tunsigned int start_clu;\n\tunsigned char flags;\n\tunsigned short attr;\n\tloff_t size;\n\tunsigned int num_subdirs;\n\tstruct timespec64 atime;\n\tstruct timespec64 mtime;\n\tstruct timespec64 crtime;\n\tstruct exfat_dentry_namebuf namebuf;\n};\n\n \nstruct exfat_mount_options {\n\tkuid_t fs_uid;\n\tkgid_t fs_gid;\n\tunsigned short fs_fmask;\n\tunsigned short fs_dmask;\n\t \n\tunsigned short allow_utime;\n\t \n\tchar *iocharset;\n\t \n\tenum exfat_error_mode errors;\n\tunsigned utf8:1,  \n\t\t sys_tz:1,  \n\t\t discard:1,  \n\t\t keep_last_dots:1;  \n\tint time_offset;  \n};\n\n \nstruct exfat_sb_info {\n\tunsigned long long num_sectors;  \n\tunsigned int num_clusters;  \n\tunsigned int cluster_size;  \n\tunsigned int cluster_size_bits;\n\tunsigned int sect_per_clus;  \n\tunsigned int sect_per_clus_bits;\n\tunsigned long long FAT1_start_sector;  \n\tunsigned long long FAT2_start_sector;  \n\tunsigned long long data_start_sector;  \n\tunsigned int num_FAT_sectors;  \n\tunsigned int root_dir;  \n\tunsigned int dentries_per_clu;  \n\tunsigned int vol_flags;  \n\tunsigned int vol_flags_persistent;  \n\tstruct buffer_head *boot_bh;  \n\n\tunsigned int map_clu;  \n\tunsigned int map_sectors;  \n\tstruct buffer_head **vol_amap;  \n\n\tunsigned short *vol_utbl;  \n\n\tunsigned int clu_srch_ptr;  \n\tunsigned int used_clusters;  \n\n\tstruct mutex s_lock;  \n\tstruct mutex bitmap_lock;  \n\tstruct exfat_mount_options options;\n\tstruct nls_table *nls_io;  \n\tstruct ratelimit_state ratelimit;\n\n\tspinlock_t inode_hash_lock;\n\tstruct hlist_head inode_hashtable[EXFAT_HASH_SIZE];\n};\n\n#define EXFAT_CACHE_VALID\t0\n\n \nstruct exfat_inode_info {\n\tstruct exfat_chain dir;\n\tint entry;\n\tunsigned int type;\n\tunsigned short attr;\n\tunsigned int start_clu;\n\tunsigned char flags;\n\t \n\tunsigned int version;\n\n\t \n\tstruct exfat_hint hint_bmap;\n\t \n\tstruct exfat_hint hint_stat;\n\t \n\tstruct exfat_hint_femp hint_femp;\n\n\tspinlock_t cache_lru_lock;\n\tstruct list_head cache_lru;\n\tint nr_caches;\n\t \n\tunsigned int cache_valid_id;\n\n\t \n\tloff_t i_size_ondisk;\n\t \n\tloff_t i_size_aligned;\n\t \n\tloff_t i_pos;\n\t \n\tstruct hlist_node i_hash_fat;\n\t \n\tstruct rw_semaphore truncate_lock;\n\tstruct inode vfs_inode;\n\t \n\tstruct timespec64 i_crtime;\n};\n\nstatic inline struct exfat_sb_info *EXFAT_SB(struct super_block *sb)\n{\n\treturn sb->s_fs_info;\n}\n\nstatic inline struct exfat_inode_info *EXFAT_I(struct inode *inode)\n{\n\treturn container_of(inode, struct exfat_inode_info, vfs_inode);\n}\n\n \nstatic inline int exfat_mode_can_hold_ro(struct inode *inode)\n{\n\tstruct exfat_sb_info *sbi = EXFAT_SB(inode->i_sb);\n\n\tif (S_ISDIR(inode->i_mode))\n\t\treturn 0;\n\n\tif ((~sbi->options.fs_fmask) & 0222)\n\t\treturn 1;\n\treturn 0;\n}\n\n \nstatic inline mode_t exfat_make_mode(struct exfat_sb_info *sbi,\n\t\tunsigned short attr, mode_t mode)\n{\n\tif ((attr & ATTR_READONLY) && !(attr & ATTR_SUBDIR))\n\t\tmode &= ~0222;\n\n\tif (attr & ATTR_SUBDIR)\n\t\treturn (mode & ~sbi->options.fs_dmask) | S_IFDIR;\n\n\treturn (mode & ~sbi->options.fs_fmask) | S_IFREG;\n}\n\n \nstatic inline unsigned short exfat_make_attr(struct inode *inode)\n{\n\tunsigned short attr = EXFAT_I(inode)->attr;\n\n\tif (S_ISDIR(inode->i_mode))\n\t\tattr |= ATTR_SUBDIR;\n\tif (exfat_mode_can_hold_ro(inode) && !(inode->i_mode & 0222))\n\t\tattr |= ATTR_READONLY;\n\treturn attr;\n}\n\nstatic inline void exfat_save_attr(struct inode *inode, unsigned short attr)\n{\n\tif (exfat_mode_can_hold_ro(inode))\n\t\tEXFAT_I(inode)->attr = attr & (ATTR_RWMASK | ATTR_READONLY);\n\telse\n\t\tEXFAT_I(inode)->attr = attr & ATTR_RWMASK;\n}\n\nstatic inline bool exfat_is_last_sector_in_cluster(struct exfat_sb_info *sbi,\n\t\tsector_t sec)\n{\n\treturn ((sec - sbi->data_start_sector + 1) &\n\t\t((1 << sbi->sect_per_clus_bits) - 1)) == 0;\n}\n\nstatic inline sector_t exfat_cluster_to_sector(struct exfat_sb_info *sbi,\n\t\tunsigned int clus)\n{\n\treturn ((sector_t)(clus - EXFAT_RESERVED_CLUSTERS) << sbi->sect_per_clus_bits) +\n\t\tsbi->data_start_sector;\n}\n\nstatic inline unsigned int exfat_sector_to_cluster(struct exfat_sb_info *sbi,\n\t\tsector_t sec)\n{\n\treturn ((sec - sbi->data_start_sector) >> sbi->sect_per_clus_bits) +\n\t\tEXFAT_RESERVED_CLUSTERS;\n}\n\nstatic inline bool is_valid_cluster(struct exfat_sb_info *sbi,\n\t\tunsigned int clus)\n{\n\treturn clus >= EXFAT_FIRST_CLUSTER && clus < sbi->num_clusters;\n}\n\n \nint exfat_set_volume_dirty(struct super_block *sb);\nint exfat_clear_volume_dirty(struct super_block *sb);\n\n \n#define exfat_get_next_cluster(sb, pclu) exfat_ent_get(sb, *(pclu), pclu)\n\nint exfat_alloc_cluster(struct inode *inode, unsigned int num_alloc,\n\t\tstruct exfat_chain *p_chain, bool sync_bmap);\nint exfat_free_cluster(struct inode *inode, struct exfat_chain *p_chain);\nint exfat_ent_get(struct super_block *sb, unsigned int loc,\n\t\tunsigned int *content);\nint exfat_ent_set(struct super_block *sb, unsigned int loc,\n\t\tunsigned int content);\nint exfat_count_ext_entries(struct super_block *sb, struct exfat_chain *p_dir,\n\t\tint entry, struct exfat_dentry *p_entry);\nint exfat_chain_cont_cluster(struct super_block *sb, unsigned int chain,\n\t\tunsigned int len);\nint exfat_zeroed_cluster(struct inode *dir, unsigned int clu);\nint exfat_find_last_cluster(struct super_block *sb, struct exfat_chain *p_chain,\n\t\tunsigned int *ret_clu);\nint exfat_count_num_clusters(struct super_block *sb,\n\t\tstruct exfat_chain *p_chain, unsigned int *ret_count);\n\n \nint exfat_load_bitmap(struct super_block *sb);\nvoid exfat_free_bitmap(struct exfat_sb_info *sbi);\nint exfat_set_bitmap(struct inode *inode, unsigned int clu, bool sync);\nvoid exfat_clear_bitmap(struct inode *inode, unsigned int clu, bool sync);\nunsigned int exfat_find_free_bitmap(struct super_block *sb, unsigned int clu);\nint exfat_count_used_clusters(struct super_block *sb, unsigned int *ret_count);\nint exfat_trim_fs(struct inode *inode, struct fstrim_range *range);\n\n \nextern const struct file_operations exfat_file_operations;\nint __exfat_truncate(struct inode *inode);\nvoid exfat_truncate(struct inode *inode);\nint exfat_setattr(struct mnt_idmap *idmap, struct dentry *dentry,\n\t\t  struct iattr *attr);\nint exfat_getattr(struct mnt_idmap *idmap, const struct path *path,\n\t\t  struct kstat *stat, unsigned int request_mask,\n\t\t  unsigned int query_flags);\nint exfat_file_fsync(struct file *file, loff_t start, loff_t end, int datasync);\nlong exfat_ioctl(struct file *filp, unsigned int cmd, unsigned long arg);\nlong exfat_compat_ioctl(struct file *filp, unsigned int cmd,\n\t\t\t\tunsigned long arg);\n\n \nextern const struct dentry_operations exfat_dentry_ops;\nextern const struct dentry_operations exfat_utf8_dentry_ops;\n\n \nint exfat_cache_init(void);\nvoid exfat_cache_shutdown(void);\nvoid exfat_cache_inval_inode(struct inode *inode);\nint exfat_get_cluster(struct inode *inode, unsigned int cluster,\n\t\tunsigned int *fclus, unsigned int *dclus,\n\t\tunsigned int *last_dclus, int allow_eof);\n\n \nextern const struct inode_operations exfat_dir_inode_operations;\nextern const struct file_operations exfat_dir_operations;\nunsigned int exfat_get_entry_type(struct exfat_dentry *p_entry);\nint exfat_init_dir_entry(struct inode *inode, struct exfat_chain *p_dir,\n\t\tint entry, unsigned int type, unsigned int start_clu,\n\t\tunsigned long long size);\nint exfat_init_ext_entry(struct inode *inode, struct exfat_chain *p_dir,\n\t\tint entry, int num_entries, struct exfat_uni_name *p_uniname);\nint exfat_remove_entries(struct inode *inode, struct exfat_chain *p_dir,\n\t\tint entry, int order, int num_entries);\nint exfat_update_dir_chksum(struct inode *inode, struct exfat_chain *p_dir,\n\t\tint entry);\nvoid exfat_update_dir_chksum_with_entry_set(struct exfat_entry_set_cache *es);\nint exfat_calc_num_entries(struct exfat_uni_name *p_uniname);\nint exfat_find_dir_entry(struct super_block *sb, struct exfat_inode_info *ei,\n\t\tstruct exfat_chain *p_dir, struct exfat_uni_name *p_uniname,\n\t\tstruct exfat_hint *hint_opt);\nint exfat_alloc_new_dir(struct inode *inode, struct exfat_chain *clu);\nstruct exfat_dentry *exfat_get_dentry(struct super_block *sb,\n\t\tstruct exfat_chain *p_dir, int entry, struct buffer_head **bh);\nstruct exfat_dentry *exfat_get_dentry_cached(struct exfat_entry_set_cache *es,\n\t\tint num);\nint exfat_get_dentry_set(struct exfat_entry_set_cache *es,\n\t\tstruct super_block *sb, struct exfat_chain *p_dir, int entry,\n\t\tunsigned int type);\nint exfat_put_dentry_set(struct exfat_entry_set_cache *es, int sync);\nint exfat_count_dir_entries(struct super_block *sb, struct exfat_chain *p_dir);\n\n \nextern const struct inode_operations exfat_file_inode_operations;\nvoid exfat_sync_inode(struct inode *inode);\nstruct inode *exfat_build_inode(struct super_block *sb,\n\t\tstruct exfat_dir_entry *info, loff_t i_pos);\nvoid exfat_hash_inode(struct inode *inode, loff_t i_pos);\nvoid exfat_unhash_inode(struct inode *inode);\nstruct inode *exfat_iget(struct super_block *sb, loff_t i_pos);\nint __exfat_write_inode(struct inode *inode, int sync);\nint exfat_write_inode(struct inode *inode, struct writeback_control *wbc);\nvoid exfat_evict_inode(struct inode *inode);\nint exfat_block_truncate_page(struct inode *inode, loff_t from);\n\n \nunsigned short exfat_toupper(struct super_block *sb, unsigned short a);\nint exfat_uniname_ncmp(struct super_block *sb, unsigned short *a,\n\t\tunsigned short *b, unsigned int len);\nint exfat_utf16_to_nls(struct super_block *sb,\n\t\tstruct exfat_uni_name *uniname, unsigned char *p_cstring,\n\t\tint len);\nint exfat_nls_to_utf16(struct super_block *sb,\n\t\tconst unsigned char *p_cstring, const int len,\n\t\tstruct exfat_uni_name *uniname, int *p_lossy);\nint exfat_create_upcase_table(struct super_block *sb);\nvoid exfat_free_upcase_table(struct exfat_sb_info *sbi);\n\n \nvoid __exfat_fs_error(struct super_block *sb, int report, const char *fmt, ...)\n\t\t__printf(3, 4) __cold;\n#define exfat_fs_error(sb, fmt, args...)          \\\n\t\t__exfat_fs_error(sb, 1, fmt, ## args)\n#define exfat_fs_error_ratelimit(sb, fmt, args...) \\\n\t\t__exfat_fs_error(sb, __ratelimit(&EXFAT_SB(sb)->ratelimit), \\\n\t\tfmt, ## args)\n\n \n#define exfat_err(sb, fmt, ...)\t\t\t\t\t\t\\\n\tpr_err(\"exFAT-fs (%s): \" fmt \"\\n\", (sb)->s_id, ##__VA_ARGS__)\n#define exfat_warn(sb, fmt, ...)\t\t\t\t\t\\\n\tpr_warn(\"exFAT-fs (%s): \" fmt \"\\n\", (sb)->s_id, ##__VA_ARGS__)\n#define exfat_info(sb, fmt, ...)\t\t\t\t\t\\\n\tpr_info(\"exFAT-fs (%s): \" fmt \"\\n\", (sb)->s_id, ##__VA_ARGS__)\n#define exfat_debug(sb, fmt, ...)\t\t\t\t\t\\\n\tpr_debug(\"exFAT-fs (%s): \" fmt \"\\n\", (sb)->s_id, ##__VA_ARGS__)\n\nvoid exfat_get_entry_time(struct exfat_sb_info *sbi, struct timespec64 *ts,\n\t\tu8 tz, __le16 time, __le16 date, u8 time_cs);\nvoid exfat_truncate_atime(struct timespec64 *ts);\nvoid exfat_set_entry_time(struct exfat_sb_info *sbi, struct timespec64 *ts,\n\t\tu8 *tz, __le16 *time, __le16 *date, u8 *time_cs);\nu16 exfat_calc_chksum16(void *data, int len, u16 chksum, int type);\nu32 exfat_calc_chksum32(void *data, int len, u32 chksum, int type);\nvoid exfat_update_bh(struct buffer_head *bh, int sync);\nint exfat_update_bhs(struct buffer_head **bhs, int nr_bhs, int sync);\nvoid exfat_chain_set(struct exfat_chain *ec, unsigned int dir,\n\t\tunsigned int size, unsigned char flags);\nvoid exfat_chain_dup(struct exfat_chain *dup, struct exfat_chain *ec);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}