{
  "module_name": "mmap-nommu.c",
  "hash_id": "7c91a396a5b39d1e66cad8cf210d3bb6c1821408d03b653ccca17770d8f3f359",
  "original_prompt": "Ingested from linux-6.6.14/fs/romfs/mmap-nommu.c",
  "human_readable_source": "\n \n\n#include <linux/mm.h>\n#include <linux/mtd/super.h>\n#include \"internal.h\"\n\n \nstatic unsigned long romfs_get_unmapped_area(struct file *file,\n\t\t\t\t\t     unsigned long addr,\n\t\t\t\t\t     unsigned long len,\n\t\t\t\t\t     unsigned long pgoff,\n\t\t\t\t\t     unsigned long flags)\n{\n\tstruct inode *inode = file->f_mapping->host;\n\tstruct mtd_info *mtd = inode->i_sb->s_mtd;\n\tunsigned long isize, offset, maxpages, lpages;\n\tint ret;\n\n\tif (!mtd)\n\t\treturn (unsigned long) -ENOSYS;\n\n\t \n\tlpages = (len + PAGE_SIZE - 1) >> PAGE_SHIFT;\n\tisize = i_size_read(inode);\n\toffset = pgoff << PAGE_SHIFT;\n\n\tmaxpages = (isize + PAGE_SIZE - 1) >> PAGE_SHIFT;\n\tif ((pgoff >= maxpages) || (maxpages - pgoff < lpages))\n\t\treturn (unsigned long) -EINVAL;\n\n\tif (addr != 0)\n\t\treturn (unsigned long) -EINVAL;\n\n\tif (len > mtd->size || pgoff >= (mtd->size >> PAGE_SHIFT))\n\t\treturn (unsigned long) -EINVAL;\n\n\toffset += ROMFS_I(inode)->i_dataoffset;\n\tif (offset >= mtd->size)\n\t\treturn (unsigned long) -EINVAL;\n\t \n\tif ((offset + len) > mtd->size)\n\t\tlen = mtd->size - offset;\n\n\tret = mtd_get_unmapped_area(mtd, len, offset, flags);\n\tif (ret == -EOPNOTSUPP)\n\t\tret = -ENOSYS;\n\treturn (unsigned long) ret;\n}\n\n \nstatic int romfs_mmap(struct file *file, struct vm_area_struct *vma)\n{\n\treturn is_nommu_shared_mapping(vma->vm_flags) ? 0 : -ENOSYS;\n}\n\nstatic unsigned romfs_mmap_capabilities(struct file *file)\n{\n\tstruct mtd_info *mtd = file_inode(file)->i_sb->s_mtd;\n\n\tif (!mtd)\n\t\treturn NOMMU_MAP_COPY;\n\treturn mtd_mmap_capabilities(mtd);\n}\n\nconst struct file_operations romfs_ro_fops = {\n\t.llseek\t\t\t= generic_file_llseek,\n\t.read_iter\t\t= generic_file_read_iter,\n\t.splice_read\t\t= filemap_splice_read,\n\t.mmap\t\t\t= romfs_mmap,\n\t.get_unmapped_area\t= romfs_get_unmapped_area,\n\t.mmap_capabilities\t= romfs_mmap_capabilities,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}