{
  "module_name": "storage.c",
  "hash_id": "dd7fea0ccf650e286e4ede14f05fb98be146ee0d8da6b8836cb21c1cbc0c1e72",
  "original_prompt": "Ingested from linux-6.6.14/fs/romfs/storage.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/mtd/super.h>\n#include <linux/buffer_head.h>\n#include \"internal.h\"\n\n#if !defined(CONFIG_ROMFS_ON_MTD) && !defined(CONFIG_ROMFS_ON_BLOCK)\n#error no ROMFS backing store interface configured\n#endif\n\n#ifdef CONFIG_ROMFS_ON_MTD\n#define ROMFS_MTD_READ(sb, ...) mtd_read((sb)->s_mtd, ##__VA_ARGS__)\n\n \nstatic int romfs_mtd_read(struct super_block *sb, unsigned long pos,\n\t\t\t  void *buf, size_t buflen)\n{\n\tsize_t rlen;\n\tint ret;\n\n\tret = ROMFS_MTD_READ(sb, pos, buflen, &rlen, buf);\n\treturn (ret < 0 || rlen != buflen) ? -EIO : 0;\n}\n\n \nstatic ssize_t romfs_mtd_strnlen(struct super_block *sb,\n\t\t\t\t unsigned long pos, size_t maxlen)\n{\n\tssize_t n = 0;\n\tsize_t segment;\n\tu_char buf[16], *p;\n\tsize_t len;\n\tint ret;\n\n\t \n\twhile (maxlen > 0) {\n\t\tsegment = min_t(size_t, maxlen, 16);\n\t\tret = ROMFS_MTD_READ(sb, pos, segment, &len, buf);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tp = memchr(buf, 0, len);\n\t\tif (p)\n\t\t\treturn n + (p - buf);\n\t\tmaxlen -= len;\n\t\tpos += len;\n\t\tn += len;\n\t}\n\n\treturn n;\n}\n\n \nstatic int romfs_mtd_strcmp(struct super_block *sb, unsigned long pos,\n\t\t\t    const char *str, size_t size)\n{\n\tu_char buf[17];\n\tsize_t len, segment;\n\tint ret;\n\n\t \n\tbuf[0] = 0xff;\n\n\twhile (size > 0) {\n\t\tsegment = min_t(size_t, size + 1, 17);\n\t\tret = ROMFS_MTD_READ(sb, pos, segment, &len, buf);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen--;\n\t\tif (memcmp(buf, str, len) != 0)\n\t\t\treturn 0;\n\t\tbuf[0] = buf[len];\n\t\tsize -= len;\n\t\tpos += len;\n\t\tstr += len;\n\t}\n\n\t \n\tif (buf[0])\n\t\treturn 0;\n\n\treturn 1;\n}\n#endif  \n\n#ifdef CONFIG_ROMFS_ON_BLOCK\n \nstatic int romfs_blk_read(struct super_block *sb, unsigned long pos,\n\t\t\t  void *buf, size_t buflen)\n{\n\tstruct buffer_head *bh;\n\tunsigned long offset;\n\tsize_t segment;\n\n\t \n\twhile (buflen > 0) {\n\t\toffset = pos & (ROMBSIZE - 1);\n\t\tsegment = min_t(size_t, buflen, ROMBSIZE - offset);\n\t\tbh = sb_bread(sb, pos >> ROMBSBITS);\n\t\tif (!bh)\n\t\t\treturn -EIO;\n\t\tmemcpy(buf, bh->b_data + offset, segment);\n\t\tbrelse(bh);\n\t\tbuf += segment;\n\t\tbuflen -= segment;\n\t\tpos += segment;\n\t}\n\n\treturn 0;\n}\n\n \nstatic ssize_t romfs_blk_strnlen(struct super_block *sb,\n\t\t\t\t unsigned long pos, size_t limit)\n{\n\tstruct buffer_head *bh;\n\tunsigned long offset;\n\tssize_t n = 0;\n\tsize_t segment;\n\tu_char *buf, *p;\n\n\t \n\twhile (limit > 0) {\n\t\toffset = pos & (ROMBSIZE - 1);\n\t\tsegment = min_t(size_t, limit, ROMBSIZE - offset);\n\t\tbh = sb_bread(sb, pos >> ROMBSBITS);\n\t\tif (!bh)\n\t\t\treturn -EIO;\n\t\tbuf = bh->b_data + offset;\n\t\tp = memchr(buf, 0, segment);\n\t\tbrelse(bh);\n\t\tif (p)\n\t\t\treturn n + (p - buf);\n\t\tlimit -= segment;\n\t\tpos += segment;\n\t\tn += segment;\n\t}\n\n\treturn n;\n}\n\n \nstatic int romfs_blk_strcmp(struct super_block *sb, unsigned long pos,\n\t\t\t    const char *str, size_t size)\n{\n\tstruct buffer_head *bh;\n\tunsigned long offset;\n\tsize_t segment;\n\tbool matched, terminated = false;\n\n\t \n\twhile (size > 0) {\n\t\toffset = pos & (ROMBSIZE - 1);\n\t\tsegment = min_t(size_t, size, ROMBSIZE - offset);\n\t\tbh = sb_bread(sb, pos >> ROMBSBITS);\n\t\tif (!bh)\n\t\t\treturn -EIO;\n\t\tmatched = (memcmp(bh->b_data + offset, str, segment) == 0);\n\n\t\tsize -= segment;\n\t\tpos += segment;\n\t\tstr += segment;\n\t\tif (matched && size == 0 && offset + segment < ROMBSIZE) {\n\t\t\tif (!bh->b_data[offset + segment])\n\t\t\t\tterminated = true;\n\t\t\telse\n\t\t\t\tmatched = false;\n\t\t}\n\t\tbrelse(bh);\n\t\tif (!matched)\n\t\t\treturn 0;\n\t}\n\n\tif (!terminated) {\n\t\t \n\t\tBUG_ON((pos & (ROMBSIZE - 1)) != 0);\n\t\tbh = sb_bread(sb, pos >> ROMBSBITS);\n\t\tif (!bh)\n\t\t\treturn -EIO;\n\t\tmatched = !bh->b_data[0];\n\t\tbrelse(bh);\n\t\tif (!matched)\n\t\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n#endif  \n\n \nint romfs_dev_read(struct super_block *sb, unsigned long pos,\n\t\t   void *buf, size_t buflen)\n{\n\tsize_t limit;\n\n\tlimit = romfs_maxsize(sb);\n\tif (pos >= limit || buflen > limit - pos)\n\t\treturn -EIO;\n\n#ifdef CONFIG_ROMFS_ON_MTD\n\tif (sb->s_mtd)\n\t\treturn romfs_mtd_read(sb, pos, buf, buflen);\n#endif\n#ifdef CONFIG_ROMFS_ON_BLOCK\n\tif (sb->s_bdev)\n\t\treturn romfs_blk_read(sb, pos, buf, buflen);\n#endif\n\treturn -EIO;\n}\n\n \nssize_t romfs_dev_strnlen(struct super_block *sb,\n\t\t\t  unsigned long pos, size_t maxlen)\n{\n\tsize_t limit;\n\n\tlimit = romfs_maxsize(sb);\n\tif (pos >= limit)\n\t\treturn -EIO;\n\tif (maxlen > limit - pos)\n\t\tmaxlen = limit - pos;\n\n#ifdef CONFIG_ROMFS_ON_MTD\n\tif (sb->s_mtd)\n\t\treturn romfs_mtd_strnlen(sb, pos, maxlen);\n#endif\n#ifdef CONFIG_ROMFS_ON_BLOCK\n\tif (sb->s_bdev)\n\t\treturn romfs_blk_strnlen(sb, pos, maxlen);\n#endif\n\treturn -EIO;\n}\n\n \nint romfs_dev_strcmp(struct super_block *sb, unsigned long pos,\n\t\t     const char *str, size_t size)\n{\n\tsize_t limit;\n\n\tlimit = romfs_maxsize(sb);\n\tif (pos >= limit)\n\t\treturn -EIO;\n\tif (size > ROMFS_MAXFN)\n\t\treturn -ENAMETOOLONG;\n\tif (size + 1 > limit - pos)\n\t\treturn -EIO;\n\n#ifdef CONFIG_ROMFS_ON_MTD\n\tif (sb->s_mtd)\n\t\treturn romfs_mtd_strcmp(sb, pos, str, size);\n#endif\n#ifdef CONFIG_ROMFS_ON_BLOCK\n\tif (sb->s_bdev)\n\t\treturn romfs_blk_strcmp(sb, pos, str, size);\n#endif\n\treturn -EIO;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}