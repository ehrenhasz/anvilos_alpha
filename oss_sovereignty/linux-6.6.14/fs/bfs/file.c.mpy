{
  "module_name": "file.c",
  "hash_id": "f35c747bda9ebc1e4f386d0a3490ca5761127e5fdb20e9d0f833193b3aff1d5a",
  "original_prompt": "Ingested from linux-6.6.14/fs/bfs/file.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/buffer_head.h>\n#include \"bfs.h\"\n\n#undef DEBUG\n\n#ifdef DEBUG\n#define dprintf(x...)\tprintf(x)\n#else\n#define dprintf(x...)\n#endif\n\nconst struct file_operations bfs_file_operations = {\n\t.llseek \t= generic_file_llseek,\n\t.read_iter\t= generic_file_read_iter,\n\t.write_iter\t= generic_file_write_iter,\n\t.mmap\t\t= generic_file_mmap,\n\t.splice_read\t= filemap_splice_read,\n};\n\nstatic int bfs_move_block(unsigned long from, unsigned long to,\n\t\t\t\t\tstruct super_block *sb)\n{\n\tstruct buffer_head *bh, *new;\n\n\tbh = sb_bread(sb, from);\n\tif (!bh)\n\t\treturn -EIO;\n\tnew = sb_getblk(sb, to);\n\tmemcpy(new->b_data, bh->b_data, bh->b_size);\n\tmark_buffer_dirty(new);\n\tbforget(bh);\n\tbrelse(new);\n\treturn 0;\n}\n\nstatic int bfs_move_blocks(struct super_block *sb, unsigned long start,\n\t\t\t\tunsigned long end, unsigned long where)\n{\n\tunsigned long i;\n\n\tdprintf(\"%08lx-%08lx->%08lx\\n\", start, end, where);\n\tfor (i = start; i <= end; i++)\n\t\tif(bfs_move_block(i, where + i, sb)) {\n\t\t\tdprintf(\"failed to move block %08lx -> %08lx\\n\", i,\n\t\t\t\t\t\t\t\twhere + i);\n\t\t\treturn -EIO;\n\t\t}\n\treturn 0;\n}\n\nstatic int bfs_get_block(struct inode *inode, sector_t block,\n\t\t\tstruct buffer_head *bh_result, int create)\n{\n\tunsigned long phys;\n\tint err;\n\tstruct super_block *sb = inode->i_sb;\n\tstruct bfs_sb_info *info = BFS_SB(sb);\n\tstruct bfs_inode_info *bi = BFS_I(inode);\n\n\tphys = bi->i_sblock + block;\n\tif (!create) {\n\t\tif (phys <= bi->i_eblock) {\n\t\t\tdprintf(\"c=%d, b=%08lx, phys=%09lx (granted)\\n\",\n                                create, (unsigned long)block, phys);\n\t\t\tmap_bh(bh_result, sb, phys);\n\t\t}\n\t\treturn 0;\n\t}\n\n\t \n\tif (bi->i_sblock && (phys <= bi->i_eblock)) {\n\t\tdprintf(\"c=%d, b=%08lx, phys=%08lx (interim block granted)\\n\", \n\t\t\t\tcreate, (unsigned long)block, phys);\n\t\tmap_bh(bh_result, sb, phys);\n\t\treturn 0;\n\t}\n\n\t \n\tif (phys >= info->si_blocks)\n\t\treturn -ENOSPC;\n\n\t \n\tmutex_lock(&info->bfs_lock);\n\n\t \n\tif (bi->i_eblock == info->si_lf_eblk) {\n\t\tdprintf(\"c=%d, b=%08lx, phys=%08lx (simple extension)\\n\", \n\t\t\t\tcreate, (unsigned long)block, phys);\n\t\tmap_bh(bh_result, sb, phys);\n\t\tinfo->si_freeb -= phys - bi->i_eblock;\n\t\tinfo->si_lf_eblk = bi->i_eblock = phys;\n\t\tmark_inode_dirty(inode);\n\t\terr = 0;\n\t\tgoto out;\n\t}\n\n\t \n\tphys = info->si_lf_eblk + 1;\n\tif (phys + block >= info->si_blocks) {\n\t\terr = -ENOSPC;\n\t\tgoto out;\n\t}\n\n\tif (bi->i_sblock) {\n\t\terr = bfs_move_blocks(inode->i_sb, bi->i_sblock, \n\t\t\t\t\t\tbi->i_eblock, phys);\n\t\tif (err) {\n\t\t\tdprintf(\"failed to move ino=%08lx -> fs corruption\\n\",\n\t\t\t\t\t\t\t\tinode->i_ino);\n\t\t\tgoto out;\n\t\t}\n\t} else\n\t\terr = 0;\n\n\tdprintf(\"c=%d, b=%08lx, phys=%08lx (moved)\\n\",\n                create, (unsigned long)block, phys);\n\tbi->i_sblock = phys;\n\tphys += block;\n\tinfo->si_lf_eblk = bi->i_eblock = phys;\n\n\t \n\tinfo->si_freeb -= bi->i_eblock - bi->i_sblock + 1 - inode->i_blocks;\n\tmark_inode_dirty(inode);\n\tmap_bh(bh_result, sb, phys);\nout:\n\tmutex_unlock(&info->bfs_lock);\n\treturn err;\n}\n\nstatic int bfs_writepage(struct page *page, struct writeback_control *wbc)\n{\n\treturn block_write_full_page(page, bfs_get_block, wbc);\n}\n\nstatic int bfs_read_folio(struct file *file, struct folio *folio)\n{\n\treturn block_read_full_folio(folio, bfs_get_block);\n}\n\nstatic void bfs_write_failed(struct address_space *mapping, loff_t to)\n{\n\tstruct inode *inode = mapping->host;\n\n\tif (to > inode->i_size)\n\t\ttruncate_pagecache(inode, inode->i_size);\n}\n\nstatic int bfs_write_begin(struct file *file, struct address_space *mapping,\n\t\t\tloff_t pos, unsigned len,\n\t\t\tstruct page **pagep, void **fsdata)\n{\n\tint ret;\n\n\tret = block_write_begin(mapping, pos, len, pagep, bfs_get_block);\n\tif (unlikely(ret))\n\t\tbfs_write_failed(mapping, pos + len);\n\n\treturn ret;\n}\n\nstatic sector_t bfs_bmap(struct address_space *mapping, sector_t block)\n{\n\treturn generic_block_bmap(mapping, block, bfs_get_block);\n}\n\nconst struct address_space_operations bfs_aops = {\n\t.dirty_folio\t= block_dirty_folio,\n\t.invalidate_folio = block_invalidate_folio,\n\t.read_folio\t= bfs_read_folio,\n\t.writepage\t= bfs_writepage,\n\t.write_begin\t= bfs_write_begin,\n\t.write_end\t= generic_write_end,\n\t.bmap\t\t= bfs_bmap,\n};\n\nconst struct inode_operations bfs_file_inops;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}