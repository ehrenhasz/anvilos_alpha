{
  "module_name": "orangefs-mod.c",
  "hash_id": "e32673a198812a3bc2da177d76dab0120b5777fe6c059c7f38b1c070067761a3",
  "original_prompt": "Ingested from linux-6.6.14/fs/orangefs/orangefs-mod.c",
  "human_readable_source": "\n \n\n#include \"protocol.h\"\n#include \"orangefs-kernel.h\"\n#include \"orangefs-debugfs.h\"\n#include \"orangefs-sysfs.h\"\n\n \n#ifndef ORANGEFS_VERSION\n#define ORANGEFS_VERSION \"upstream\"\n#endif\n\n \n\nstruct orangefs_stats orangefs_stats;\n\n \nint hash_table_size = 509;\n\nstatic ulong module_parm_debug_mask;\n__u64 orangefs_gossip_debug_mask;\nint op_timeout_secs = ORANGEFS_DEFAULT_OP_TIMEOUT_SECS;\nint slot_timeout_secs = ORANGEFS_DEFAULT_SLOT_TIMEOUT_SECS;\nint orangefs_cache_timeout_msecs = 500;\nint orangefs_dcache_timeout_msecs = 50;\nint orangefs_getattr_timeout_msecs = 50;\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"ORANGEFS Development Team\");\nMODULE_DESCRIPTION(\"The Linux Kernel VFS interface to ORANGEFS\");\nMODULE_PARM_DESC(module_parm_debug_mask, \"debugging level (see orangefs-debug.h for values)\");\nMODULE_PARM_DESC(op_timeout_secs, \"Operation timeout in seconds\");\nMODULE_PARM_DESC(slot_timeout_secs, \"Slot timeout in seconds\");\nMODULE_PARM_DESC(hash_table_size,\n\t\t \"size of hash table for operations in progress\");\n\nstatic struct file_system_type orangefs_fs_type = {\n\t.name = \"pvfs2\",\n\t.mount = orangefs_mount,\n\t.kill_sb = orangefs_kill_sb,\n\t.owner = THIS_MODULE,\n};\n\nmodule_param(hash_table_size, int, 0);\nmodule_param(module_parm_debug_mask, ulong, 0644);\nmodule_param(op_timeout_secs, int, 0);\nmodule_param(slot_timeout_secs, int, 0);\n\n \nDEFINE_MUTEX(orangefs_request_mutex);\n\n \nstruct list_head *orangefs_htable_ops_in_progress;\nDEFINE_SPINLOCK(orangefs_htable_ops_in_progress_lock);\n\n \nLIST_HEAD(orangefs_request_list);\n\n \nDEFINE_SPINLOCK(orangefs_request_list_lock);\n\n \nDECLARE_WAIT_QUEUE_HEAD(orangefs_request_list_waitq);\n\nstatic int __init orangefs_init(void)\n{\n\tint ret;\n\t__u32 i = 0;\n\n\tif (op_timeout_secs < 0)\n\t\top_timeout_secs = 0;\n\n\tif (slot_timeout_secs < 0)\n\t\tslot_timeout_secs = 0;\n\n\t \n\tret = op_cache_initialize();\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = orangefs_inode_cache_initialize();\n\tif (ret < 0)\n\t\tgoto cleanup_op;\n\n\torangefs_htable_ops_in_progress =\n\t    kcalloc(hash_table_size, sizeof(struct list_head), GFP_KERNEL);\n\tif (!orangefs_htable_ops_in_progress) {\n\t\tret = -ENOMEM;\n\t\tgoto cleanup_inode;\n\t}\n\n\t \n\tfor (i = 0; i < hash_table_size; i++)\n\t\tINIT_LIST_HEAD(&orangefs_htable_ops_in_progress[i]);\n\n\tret = fsid_key_table_initialize();\n\tif (ret < 0)\n\t\tgoto cleanup_progress_table;\n\n\t \n\tret = orangefs_prepare_debugfs_help_string(1);\n\tif (ret)\n\t\tgoto cleanup_key_table;\n\n\torangefs_debugfs_init(module_parm_debug_mask);\n\n\tret = orangefs_sysfs_init();\n\tif (ret)\n\t\tgoto sysfs_init_failed;\n\n\t \n\tret = orangefs_dev_init();\n\tif (ret < 0) {\n\t\tgossip_err(\"%s: could not initialize device subsystem %d!\\n\",\n\t\t\t   __func__,\n\t\t\t   ret);\n\t\tgoto cleanup_sysfs;\n\t}\n\n\tret = register_filesystem(&orangefs_fs_type);\n\tif (ret == 0) {\n\t\tpr_info(\"%s: module version %s loaded\\n\",\n\t\t\t__func__,\n\t\t\tORANGEFS_VERSION);\n\t\tgoto out;\n\t}\n\n\torangefs_dev_cleanup();\n\ncleanup_sysfs:\n\torangefs_sysfs_exit();\n\nsysfs_init_failed:\n\torangefs_debugfs_cleanup();\n\ncleanup_key_table:\n\tfsid_key_table_finalize();\n\ncleanup_progress_table:\n\tkfree(orangefs_htable_ops_in_progress);\n\ncleanup_inode:\n\torangefs_inode_cache_finalize();\n\ncleanup_op:\n\top_cache_finalize();\n\nout:\n\treturn ret;\n}\n\nstatic void __exit orangefs_exit(void)\n{\n\tint i = 0;\n\tgossip_debug(GOSSIP_INIT_DEBUG, \"orangefs: orangefs_exit called\\n\");\n\n\tunregister_filesystem(&orangefs_fs_type);\n\torangefs_debugfs_cleanup();\n\torangefs_sysfs_exit();\n\tfsid_key_table_finalize();\n\torangefs_dev_cleanup();\n\tBUG_ON(!list_empty(&orangefs_request_list));\n\tfor (i = 0; i < hash_table_size; i++)\n\t\tBUG_ON(!list_empty(&orangefs_htable_ops_in_progress[i]));\n\n\torangefs_inode_cache_finalize();\n\top_cache_finalize();\n\n\tkfree(orangefs_htable_ops_in_progress);\n\n\tpr_info(\"orangefs: module version %s unloaded\\n\", ORANGEFS_VERSION);\n}\n\n \nvoid purge_inprogress_ops(void)\n{\n\tint i;\n\n\tfor (i = 0; i < hash_table_size; i++) {\n\t\tstruct orangefs_kernel_op_s *op;\n\t\tstruct orangefs_kernel_op_s *next;\n\n\t\tspin_lock(&orangefs_htable_ops_in_progress_lock);\n\t\tlist_for_each_entry_safe(op,\n\t\t\t\t\t next,\n\t\t\t\t\t &orangefs_htable_ops_in_progress[i],\n\t\t\t\t\t list) {\n\t\t\tset_op_state_purged(op);\n\t\t\tgossip_debug(GOSSIP_DEV_DEBUG,\n\t\t\t\t     \"%s: op:%s: op_state:%d: process:%s:\\n\",\n\t\t\t\t     __func__,\n\t\t\t\t     get_opname_string(op),\n\t\t\t\t     op->op_state,\n\t\t\t\t     current->comm);\n\t\t}\n\t\tspin_unlock(&orangefs_htable_ops_in_progress_lock);\n\t}\n}\n\nmodule_init(orangefs_init);\nmodule_exit(orangefs_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}