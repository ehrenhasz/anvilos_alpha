{
  "module_name": "mount.c",
  "hash_id": "522aa4acace3b944c12389677b4929d3f8ff1210d4b34d6af23122be6059681f",
  "original_prompt": "Ingested from linux-6.6.14/fs/sysfs/mount.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/magic.h>\n#include <linux/mount.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/user_namespace.h>\n#include <linux/fs_context.h>\n#include <net/net_namespace.h>\n\n#include \"sysfs.h\"\n\nstatic struct kernfs_root *sysfs_root;\nstruct kernfs_node *sysfs_root_kn;\n\nstatic int sysfs_get_tree(struct fs_context *fc)\n{\n\tstruct kernfs_fs_context *kfc = fc->fs_private;\n\tint ret;\n\n\tret = kernfs_get_tree(fc);\n\tif (ret)\n\t\treturn ret;\n\n\tif (kfc->new_sb_created)\n\t\tfc->root->d_sb->s_iflags |= SB_I_USERNS_VISIBLE;\n\treturn 0;\n}\n\nstatic void sysfs_fs_context_free(struct fs_context *fc)\n{\n\tstruct kernfs_fs_context *kfc = fc->fs_private;\n\n\tif (kfc->ns_tag)\n\t\tkobj_ns_drop(KOBJ_NS_TYPE_NET, kfc->ns_tag);\n\tkernfs_free_fs_context(fc);\n\tkfree(kfc);\n}\n\nstatic const struct fs_context_operations sysfs_fs_context_ops = {\n\t.free\t\t= sysfs_fs_context_free,\n\t.get_tree\t= sysfs_get_tree,\n};\n\nstatic int sysfs_init_fs_context(struct fs_context *fc)\n{\n\tstruct kernfs_fs_context *kfc;\n\tstruct net *netns;\n\n\tif (!(fc->sb_flags & SB_KERNMOUNT)) {\n\t\tif (!kobj_ns_current_may_mount(KOBJ_NS_TYPE_NET))\n\t\t\treturn -EPERM;\n\t}\n\n\tkfc = kzalloc(sizeof(struct kernfs_fs_context), GFP_KERNEL);\n\tif (!kfc)\n\t\treturn -ENOMEM;\n\n\tkfc->ns_tag = netns = kobj_ns_grab_current(KOBJ_NS_TYPE_NET);\n\tkfc->root = sysfs_root;\n\tkfc->magic = SYSFS_MAGIC;\n\tfc->fs_private = kfc;\n\tfc->ops = &sysfs_fs_context_ops;\n\tif (netns) {\n\t\tput_user_ns(fc->user_ns);\n\t\tfc->user_ns = get_user_ns(netns->user_ns);\n\t}\n\tfc->global = true;\n\treturn 0;\n}\n\nstatic void sysfs_kill_sb(struct super_block *sb)\n{\n\tvoid *ns = (void *)kernfs_super_ns(sb);\n\n\tkernfs_kill_sb(sb);\n\tkobj_ns_drop(KOBJ_NS_TYPE_NET, ns);\n}\n\nstatic struct file_system_type sysfs_fs_type = {\n\t.name\t\t\t= \"sysfs\",\n\t.init_fs_context\t= sysfs_init_fs_context,\n\t.kill_sb\t\t= sysfs_kill_sb,\n\t.fs_flags\t\t= FS_USERNS_MOUNT,\n};\n\nint __init sysfs_init(void)\n{\n\tint err;\n\n\tsysfs_root = kernfs_create_root(NULL, KERNFS_ROOT_EXTRA_OPEN_PERM_CHECK,\n\t\t\t\t\tNULL);\n\tif (IS_ERR(sysfs_root))\n\t\treturn PTR_ERR(sysfs_root);\n\n\tsysfs_root_kn = kernfs_root_to_node(sysfs_root);\n\n\terr = register_filesystem(&sysfs_fs_type);\n\tif (err) {\n\t\tkernfs_destroy_root(sysfs_root);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}