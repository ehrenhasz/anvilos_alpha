{
  "module_name": "vxfs_fshead.c",
  "hash_id": "86c5b57efdb9f325d4ef1e9d40452851c4388b40ecdb298aa242154f31e5acc1",
  "original_prompt": "Ingested from linux-6.6.14/fs/freevxfs/vxfs_fshead.c",
  "human_readable_source": "\n \n\n \n#include <linux/fs.h>\n#include <linux/buffer_head.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/string.h>\n\n#include \"vxfs.h\"\n#include \"vxfs_inode.h\"\n#include \"vxfs_extern.h\"\n#include \"vxfs_fshead.h\"\n\n\n#ifdef DIAGNOSTIC\nstatic void\nvxfs_dumpfsh(struct vxfs_fsh *fhp)\n{\n\tprintk(\"\\n\\ndumping fileset header:\\n\");\n\tprintk(\"----------------------------\\n\");\n\tprintk(\"version: %u\\n\", fhp->fsh_version);\n\tprintk(\"fsindex: %u\\n\", fhp->fsh_fsindex);\n\tprintk(\"iauino: %u\\tninodes:%u\\n\",\n\t\t\tfhp->fsh_iauino, fhp->fsh_ninodes);\n\tprintk(\"maxinode: %u\\tlctino: %u\\n\",\n\t\t\tfhp->fsh_maxinode, fhp->fsh_lctino);\n\tprintk(\"nau: %u\\n\", fhp->fsh_nau);\n\tprintk(\"ilistino[0]: %u\\tilistino[1]: %u\\n\",\n\t\t\tfhp->fsh_ilistino[0], fhp->fsh_ilistino[1]);\n}\n#endif\n\n \nstatic struct vxfs_fsh *\nvxfs_getfsh(struct inode *ip, int which)\n{\n\tstruct buffer_head\t\t*bp;\n\n\tbp = vxfs_bread(ip, which);\n\tif (bp) {\n\t\tstruct vxfs_fsh\t\t*fhp;\n\n\t\tif (!(fhp = kmalloc(sizeof(*fhp), GFP_KERNEL)))\n\t\t\tgoto out;\n\t\tmemcpy(fhp, bp->b_data, sizeof(*fhp));\n\n\t\tput_bh(bp);\n\t\treturn (fhp);\n\t}\nout:\n\tbrelse(bp);\n\treturn NULL;\n}\n\n \nint\nvxfs_read_fshead(struct super_block *sbp)\n{\n\tstruct vxfs_sb_info\t\t*infp = VXFS_SBI(sbp);\n\tstruct vxfs_fsh\t\t\t*pfp, *sfp;\n\tstruct vxfs_inode_info\t\t*vip;\n\n\tinfp->vsi_fship = vxfs_blkiget(sbp, infp->vsi_iext, infp->vsi_fshino);\n\tif (!infp->vsi_fship) {\n\t\tprintk(KERN_ERR \"vxfs: unable to read fsh inode\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tvip = VXFS_INO(infp->vsi_fship);\n\tif (!VXFS_ISFSH(vip)) {\n\t\tprintk(KERN_ERR \"vxfs: fsh list inode is of wrong type (%x)\\n\",\n\t\t\t\tvip->vii_mode & VXFS_TYPE_MASK); \n\t\tgoto out_iput_fship;\n\t}\n\n#ifdef DIAGNOSTIC\n\tprintk(\"vxfs: fsh inode dump:\\n\");\n\tvxfs_dumpi(vip, infp->vsi_fshino);\n#endif\n\n\tsfp = vxfs_getfsh(infp->vsi_fship, 0);\n\tif (!sfp) {\n\t\tprintk(KERN_ERR \"vxfs: unable to get structural fsh\\n\");\n\t\tgoto out_iput_fship;\n\t} \n\n#ifdef DIAGNOSTIC\n\tvxfs_dumpfsh(sfp);\n#endif\n\n\tpfp = vxfs_getfsh(infp->vsi_fship, 1);\n\tif (!pfp) {\n\t\tprintk(KERN_ERR \"vxfs: unable to get primary fsh\\n\");\n\t\tgoto out_free_sfp;\n\t}\n\n#ifdef DIAGNOSTIC\n\tvxfs_dumpfsh(pfp);\n#endif\n\n\tinfp->vsi_stilist = vxfs_blkiget(sbp, infp->vsi_iext,\n\t\t\tfs32_to_cpu(infp, sfp->fsh_ilistino[0]));\n\tif (!infp->vsi_stilist) {\n\t\tprintk(KERN_ERR \"vxfs: unable to get structural list inode\\n\");\n\t\tgoto out_free_pfp;\n\t}\n\tif (!VXFS_ISILT(VXFS_INO(infp->vsi_stilist))) {\n\t\tprintk(KERN_ERR \"vxfs: structural list inode is of wrong type (%x)\\n\",\n\t\t\t\tVXFS_INO(infp->vsi_stilist)->vii_mode & VXFS_TYPE_MASK); \n\t\tgoto out_iput_stilist;\n\t}\n\n\tinfp->vsi_ilist = vxfs_stiget(sbp, fs32_to_cpu(infp, pfp->fsh_ilistino[0]));\n\tif (!infp->vsi_ilist) {\n\t\tprintk(KERN_ERR \"vxfs: unable to get inode list inode\\n\");\n\t\tgoto out_iput_stilist;\n\t}\n\tif (!VXFS_ISILT(VXFS_INO(infp->vsi_ilist))) {\n\t\tprintk(KERN_ERR \"vxfs: inode list inode is of wrong type (%x)\\n\",\n\t\t\t\tVXFS_INO(infp->vsi_ilist)->vii_mode & VXFS_TYPE_MASK);\n\t\tgoto out_iput_ilist;\n\t}\n\n\tkfree(pfp);\n\tkfree(sfp);\n\treturn 0;\n\n out_iput_ilist:\n \tiput(infp->vsi_ilist);\n out_iput_stilist:\n \tiput(infp->vsi_stilist);\n out_free_pfp:\n\tkfree(pfp);\n out_free_sfp:\n \tkfree(sfp);\n out_iput_fship:\n\tiput(infp->vsi_fship);\n\treturn -EINVAL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}