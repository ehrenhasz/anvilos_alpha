{
  "module_name": "ext4_jbd2.h",
  "hash_id": "bfc21b61db19a93c942d2a8fada33107bc2b8b3306df25c819621a401ed5cb1c",
  "original_prompt": "Ingested from linux-6.6.14/fs/ext4/ext4_jbd2.h",
  "human_readable_source": "\n \n\n#ifndef _EXT4_JBD2_H\n#define _EXT4_JBD2_H\n\n#include <linux/fs.h>\n#include <linux/jbd2.h>\n#include \"ext4.h\"\n\n#define EXT4_JOURNAL(inode)\t(EXT4_SB((inode)->i_sb)->s_journal)\n\n \n\n#define EXT4_SINGLEDATA_TRANS_BLOCKS(sb)\t\t\t\t\\\n\t(ext4_has_feature_extents(sb) ? 20U : 8U)\n\n \n\n#define EXT4_XATTR_TRANS_BLOCKS\t\t6U\n\n \n\n#define EXT4_DATA_TRANS_BLOCKS(sb)\t(EXT4_SINGLEDATA_TRANS_BLOCKS(sb) + \\\n\t\t\t\t\t EXT4_XATTR_TRANS_BLOCKS - 2 + \\\n\t\t\t\t\t EXT4_MAXQUOTAS_TRANS_BLOCKS(sb))\n\n \n#define EXT4_META_TRANS_BLOCKS(sb)\t(EXT4_XATTR_TRANS_BLOCKS + \\\n\t\t\t\t\tEXT4_MAXQUOTAS_TRANS_BLOCKS(sb))\n\n \n\n#define EXT4_MAX_TRANS_DATA\t\t64U\n\n \n\n#define EXT4_RESERVE_TRANS_BLOCKS\t12U\n\n \n#define EXT4_INDEX_EXTRA_TRANS_BLOCKS\t12U\n\n#ifdef CONFIG_QUOTA\n \n#define EXT4_QUOTA_TRANS_BLOCKS(sb) ((ext4_quota_capable(sb)) ? 1 : 0)\n \n#define EXT4_QUOTA_INIT_BLOCKS(sb) ((ext4_quota_capable(sb)) ?\\\n\t\t(DQUOT_INIT_ALLOC*(EXT4_SINGLEDATA_TRANS_BLOCKS(sb)-3)\\\n\t\t +3+DQUOT_INIT_REWRITE) : 0)\n\n#define EXT4_QUOTA_DEL_BLOCKS(sb) ((ext4_quota_capable(sb)) ?\\\n\t\t(DQUOT_DEL_ALLOC*(EXT4_SINGLEDATA_TRANS_BLOCKS(sb)-3)\\\n\t\t +3+DQUOT_DEL_REWRITE) : 0)\n#else\n#define EXT4_QUOTA_TRANS_BLOCKS(sb) 0\n#define EXT4_QUOTA_INIT_BLOCKS(sb) 0\n#define EXT4_QUOTA_DEL_BLOCKS(sb) 0\n#endif\n#define EXT4_MAXQUOTAS_TRANS_BLOCKS(sb) (EXT4_MAXQUOTAS*EXT4_QUOTA_TRANS_BLOCKS(sb))\n#define EXT4_MAXQUOTAS_INIT_BLOCKS(sb) (EXT4_MAXQUOTAS*EXT4_QUOTA_INIT_BLOCKS(sb))\n#define EXT4_MAXQUOTAS_DEL_BLOCKS(sb) (EXT4_MAXQUOTAS*EXT4_QUOTA_DEL_BLOCKS(sb))\n\n \n#define EXT4_HT_MISC             0\n#define EXT4_HT_INODE            1\n#define EXT4_HT_WRITE_PAGE       2\n#define EXT4_HT_MAP_BLOCKS       3\n#define EXT4_HT_DIR              4\n#define EXT4_HT_TRUNCATE         5\n#define EXT4_HT_QUOTA            6\n#define EXT4_HT_RESIZE           7\n#define EXT4_HT_MIGRATE          8\n#define EXT4_HT_MOVE_EXTENTS     9\n#define EXT4_HT_XATTR           10\n#define EXT4_HT_EXT_CONVERT     11\n#define EXT4_HT_MAX             12\n\n \nstruct ext4_journal_cb_entry {\n\t \n\tstruct list_head jce_list;\n\n\t \n\tvoid (*jce_func)(struct super_block *sb,\n\t\t\t struct ext4_journal_cb_entry *jce, int error);\n\n\t \n};\n\n \nstatic inline void _ext4_journal_callback_add(handle_t *handle,\n\t\t\tstruct ext4_journal_cb_entry *jce)\n{\n\t \n\tlist_add_tail(&jce->jce_list, &handle->h_transaction->t_private_list);\n}\n\nstatic inline void ext4_journal_callback_add(handle_t *handle,\n\t\t\tvoid (*func)(struct super_block *sb,\n\t\t\t\t     struct ext4_journal_cb_entry *jce,\n\t\t\t\t     int rc),\n\t\t\tstruct ext4_journal_cb_entry *jce)\n{\n\tstruct ext4_sb_info *sbi =\n\t\t\tEXT4_SB(handle->h_transaction->t_journal->j_private);\n\n\t \n\tjce->jce_func = func;\n\tspin_lock(&sbi->s_md_lock);\n\t_ext4_journal_callback_add(handle, jce);\n\tspin_unlock(&sbi->s_md_lock);\n}\n\n\n \nstatic inline bool ext4_journal_callback_try_del(handle_t *handle,\n\t\t\t\t\t     struct ext4_journal_cb_entry *jce)\n{\n\tbool deleted;\n\tstruct ext4_sb_info *sbi =\n\t\t\tEXT4_SB(handle->h_transaction->t_journal->j_private);\n\n\tspin_lock(&sbi->s_md_lock);\n\tdeleted = !list_empty(&jce->jce_list);\n\tlist_del_init(&jce->jce_list);\n\tspin_unlock(&sbi->s_md_lock);\n\treturn deleted;\n}\n\nint\next4_mark_iloc_dirty(handle_t *handle,\n\t\t     struct inode *inode,\n\t\t     struct ext4_iloc *iloc);\n\n \n\nint ext4_reserve_inode_write(handle_t *handle, struct inode *inode,\n\t\t\tstruct ext4_iloc *iloc);\n\n#define ext4_mark_inode_dirty(__h, __i)\t\t\t\t\t\\\n\t\t__ext4_mark_inode_dirty((__h), (__i), __func__, __LINE__)\nint __ext4_mark_inode_dirty(handle_t *handle, struct inode *inode,\n\t\t\t\tconst char *func, unsigned int line);\n\nint ext4_expand_extra_isize(struct inode *inode,\n\t\t\t    unsigned int new_extra_isize,\n\t\t\t    struct ext4_iloc *iloc);\n \nint __ext4_journal_get_write_access(const char *where, unsigned int line,\n\t\t\t\t    handle_t *handle, struct super_block *sb,\n\t\t\t\t    struct buffer_head *bh,\n\t\t\t\t    enum ext4_journal_trigger_type trigger_type);\n\nint __ext4_forget(const char *where, unsigned int line, handle_t *handle,\n\t\t  int is_metadata, struct inode *inode,\n\t\t  struct buffer_head *bh, ext4_fsblk_t blocknr);\n\nint __ext4_journal_get_create_access(const char *where, unsigned int line,\n\t\t\t\thandle_t *handle, struct super_block *sb,\n\t\t\t\tstruct buffer_head *bh,\n\t\t\t\tenum ext4_journal_trigger_type trigger_type);\n\nint __ext4_handle_dirty_metadata(const char *where, unsigned int line,\n\t\t\t\t handle_t *handle, struct inode *inode,\n\t\t\t\t struct buffer_head *bh);\n\n#define ext4_journal_get_write_access(handle, sb, bh, trigger_type) \\\n\t__ext4_journal_get_write_access(__func__, __LINE__, (handle), (sb), \\\n\t\t\t\t\t(bh), (trigger_type))\n#define ext4_forget(handle, is_metadata, inode, bh, block_nr) \\\n\t__ext4_forget(__func__, __LINE__, (handle), (is_metadata), (inode), \\\n\t\t      (bh), (block_nr))\n#define ext4_journal_get_create_access(handle, sb, bh, trigger_type) \\\n\t__ext4_journal_get_create_access(__func__, __LINE__, (handle), (sb), \\\n\t\t\t\t\t (bh), (trigger_type))\n#define ext4_handle_dirty_metadata(handle, inode, bh) \\\n\t__ext4_handle_dirty_metadata(__func__, __LINE__, (handle), (inode), \\\n\t\t\t\t     (bh))\n\nhandle_t *__ext4_journal_start_sb(struct inode *inode, struct super_block *sb,\n\t\t\t\t  unsigned int line, int type, int blocks,\n\t\t\t\t  int rsv_blocks, int revoke_creds);\nint __ext4_journal_stop(const char *where, unsigned int line, handle_t *handle);\n\n#define EXT4_NOJOURNAL_MAX_REF_COUNT ((unsigned long) 4096)\n\n \nstatic inline int ext4_handle_valid(handle_t *handle)\n{\n\tif ((unsigned long)handle < EXT4_NOJOURNAL_MAX_REF_COUNT)\n\t\treturn 0;\n\treturn 1;\n}\n\nstatic inline void ext4_handle_sync(handle_t *handle)\n{\n\tif (ext4_handle_valid(handle))\n\t\thandle->h_sync = 1;\n}\n\nstatic inline int ext4_handle_is_aborted(handle_t *handle)\n{\n\tif (ext4_handle_valid(handle))\n\t\treturn is_handle_aborted(handle);\n\treturn 0;\n}\n\nstatic inline int ext4_free_metadata_revoke_credits(struct super_block *sb,\n\t\t\t\t\t\t    int blocks)\n{\n\t \n\treturn blocks * EXT4_SB(sb)->s_cluster_ratio;\n}\n\nstatic inline int ext4_trans_default_revoke_credits(struct super_block *sb)\n{\n\treturn ext4_free_metadata_revoke_credits(sb, 8);\n}\n\n#define ext4_journal_start_sb(sb, type, nblocks)\t\t\t\\\n\t__ext4_journal_start_sb(NULL, (sb), __LINE__, (type), (nblocks), 0,\\\n\t\t\t\text4_trans_default_revoke_credits(sb))\n\n#define ext4_journal_start(inode, type, nblocks)\t\t\t\\\n\t__ext4_journal_start((inode), __LINE__, (type), (nblocks), 0,\t\\\n\t\t\t     ext4_trans_default_revoke_credits((inode)->i_sb))\n\n#define ext4_journal_start_with_reserve(inode, type, blocks, rsv_blocks)\\\n\t__ext4_journal_start((inode), __LINE__, (type), (blocks), (rsv_blocks),\\\n\t\t\t     ext4_trans_default_revoke_credits((inode)->i_sb))\n\n#define ext4_journal_start_with_revoke(inode, type, blocks, revoke_creds) \\\n\t__ext4_journal_start((inode), __LINE__, (type), (blocks), 0,\t\\\n\t\t\t     (revoke_creds))\n\nstatic inline handle_t *__ext4_journal_start(struct inode *inode,\n\t\t\t\t\t     unsigned int line, int type,\n\t\t\t\t\t     int blocks, int rsv_blocks,\n\t\t\t\t\t     int revoke_creds)\n{\n\treturn __ext4_journal_start_sb(inode, inode->i_sb, line, type, blocks,\n\t\t\t\t       rsv_blocks, revoke_creds);\n}\n\n#define ext4_journal_stop(handle) \\\n\t__ext4_journal_stop(__func__, __LINE__, (handle))\n\n#define ext4_journal_start_reserved(handle, type) \\\n\t__ext4_journal_start_reserved((handle), __LINE__, (type))\n\nhandle_t *__ext4_journal_start_reserved(handle_t *handle, unsigned int line,\n\t\t\t\t\tint type);\n\nstatic inline handle_t *ext4_journal_current_handle(void)\n{\n\treturn journal_current_handle();\n}\n\nstatic inline int ext4_journal_extend(handle_t *handle, int nblocks, int revoke)\n{\n\tif (ext4_handle_valid(handle))\n\t\treturn jbd2_journal_extend(handle, nblocks, revoke);\n\treturn 0;\n}\n\nstatic inline int ext4_journal_restart(handle_t *handle, int nblocks,\n\t\t\t\t       int revoke)\n{\n\tif (ext4_handle_valid(handle))\n\t\treturn jbd2__journal_restart(handle, nblocks, revoke, GFP_NOFS);\n\treturn 0;\n}\n\nint __ext4_journal_ensure_credits(handle_t *handle, int check_cred,\n\t\t\t\t  int extend_cred, int revoke_cred);\n\n\n \n#define ext4_journal_ensure_credits_fn(handle, check_cred, extend_cred,\t\\\n\t\t\t\t       revoke_cred, fn) \\\n({\t\t\t\t\t\t\t\t\t\\\n\t__label__ __ensure_end;\t\t\t\t\t\t\\\n\tint err = __ext4_journal_ensure_credits((handle), (check_cred),\t\\\n\t\t\t\t\t(extend_cred), (revoke_cred));\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tif (err <= 0)\t\t\t\t\t\t\t\\\n\t\tgoto __ensure_end;\t\t\t\t\t\\\n\terr = (fn);\t\t\t\t\t\t\t\\\n\tif (err < 0)\t\t\t\t\t\t\t\\\n\t\tgoto __ensure_end;\t\t\t\t\t\\\n\terr = ext4_journal_restart((handle), (extend_cred), (revoke_cred)); \\\n\tif (err == 0)\t\t\t\t\t\t\t\\\n\t\terr = 1;\t\t\t\t\t\t\\\n__ensure_end:\t\t\t\t\t\t\t\t\\\n\terr;\t\t\t\t\t\t\t\t\\\n})\n\n \nstatic inline int ext4_journal_ensure_credits(handle_t *handle, int credits,\n\t\t\t\t\t      int revoke_creds)\n{\n\treturn ext4_journal_ensure_credits_fn(handle, credits, credits,\n\t\t\t\trevoke_creds, 0);\n}\n\nstatic inline int ext4_journal_blocks_per_page(struct inode *inode)\n{\n\tif (EXT4_JOURNAL(inode) != NULL)\n\t\treturn jbd2_journal_blocks_per_page(inode);\n\treturn 0;\n}\n\nstatic inline int ext4_journal_force_commit(journal_t *journal)\n{\n\tif (journal)\n\t\treturn jbd2_journal_force_commit(journal);\n\treturn 0;\n}\n\nstatic inline int ext4_jbd2_inode_add_write(handle_t *handle,\n\t\tstruct inode *inode, loff_t start_byte, loff_t length)\n{\n\tif (ext4_handle_valid(handle))\n\t\treturn jbd2_journal_inode_ranged_write(handle,\n\t\t\t\tEXT4_I(inode)->jinode, start_byte, length);\n\treturn 0;\n}\n\nstatic inline int ext4_jbd2_inode_add_wait(handle_t *handle,\n\t\tstruct inode *inode, loff_t start_byte, loff_t length)\n{\n\tif (ext4_handle_valid(handle))\n\t\treturn jbd2_journal_inode_ranged_wait(handle,\n\t\t\t\tEXT4_I(inode)->jinode, start_byte, length);\n\treturn 0;\n}\n\nstatic inline void ext4_update_inode_fsync_trans(handle_t *handle,\n\t\t\t\t\t\t struct inode *inode,\n\t\t\t\t\t\t int datasync)\n{\n\tstruct ext4_inode_info *ei = EXT4_I(inode);\n\n\tif (ext4_handle_valid(handle) && !is_handle_aborted(handle)) {\n\t\tei->i_sync_tid = handle->h_transaction->t_tid;\n\t\tif (datasync)\n\t\t\tei->i_datasync_tid = handle->h_transaction->t_tid;\n\t}\n}\n\n \nint ext4_force_commit(struct super_block *sb);\n\n \n#define EXT4_INODE_JOURNAL_DATA_MODE\t0x01  \n#define EXT4_INODE_ORDERED_DATA_MODE\t0x02  \n#define EXT4_INODE_WRITEBACK_DATA_MODE\t0x04  \n\nint ext4_inode_journal_mode(struct inode *inode);\n\nstatic inline int ext4_should_journal_data(struct inode *inode)\n{\n\treturn ext4_inode_journal_mode(inode) & EXT4_INODE_JOURNAL_DATA_MODE;\n}\n\nstatic inline int ext4_should_order_data(struct inode *inode)\n{\n\treturn ext4_inode_journal_mode(inode) & EXT4_INODE_ORDERED_DATA_MODE;\n}\n\nstatic inline int ext4_should_writeback_data(struct inode *inode)\n{\n\treturn ext4_inode_journal_mode(inode) & EXT4_INODE_WRITEBACK_DATA_MODE;\n}\n\nstatic inline int ext4_free_data_revoke_credits(struct inode *inode, int blocks)\n{\n\tif (test_opt(inode->i_sb, DATA_FLAGS) == EXT4_MOUNT_JOURNAL_DATA)\n\t\treturn 0;\n\tif (!ext4_should_journal_data(inode))\n\t\treturn 0;\n\t \n\treturn blocks + 2*(EXT4_SB(inode->i_sb)->s_cluster_ratio - 1);\n}\n\n \nstatic inline int ext4_should_dioread_nolock(struct inode *inode)\n{\n\tif (!test_opt(inode->i_sb, DIOREAD_NOLOCK))\n\t\treturn 0;\n\tif (!S_ISREG(inode->i_mode))\n\t\treturn 0;\n\tif (!(ext4_test_inode_flag(inode, EXT4_INODE_EXTENTS)))\n\t\treturn 0;\n\tif (ext4_should_journal_data(inode))\n\t\treturn 0;\n\t \n\tif (!test_opt(inode->i_sb, DELALLOC))\n\t\treturn 0;\n\treturn 1;\n}\n\n#endif\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}