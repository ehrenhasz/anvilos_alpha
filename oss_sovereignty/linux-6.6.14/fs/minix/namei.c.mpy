{
  "module_name": "namei.c",
  "hash_id": "292cc8d34968e89a0db6595c6894c84c58c8dc465df9c4e9280e7f9d116d96a3",
  "original_prompt": "Ingested from linux-6.6.14/fs/minix/namei.c",
  "human_readable_source": "\n \n\n#include \"minix.h\"\n\nstatic int add_nondir(struct dentry *dentry, struct inode *inode)\n{\n\tint err = minix_add_link(dentry, inode);\n\tif (!err) {\n\t\td_instantiate(dentry, inode);\n\t\treturn 0;\n\t}\n\tinode_dec_link_count(inode);\n\tiput(inode);\n\treturn err;\n}\n\nstatic struct dentry *minix_lookup(struct inode * dir, struct dentry *dentry, unsigned int flags)\n{\n\tstruct inode * inode = NULL;\n\tino_t ino;\n\n\tif (dentry->d_name.len > minix_sb(dir->i_sb)->s_namelen)\n\t\treturn ERR_PTR(-ENAMETOOLONG);\n\n\tino = minix_inode_by_name(dentry);\n\tif (ino)\n\t\tinode = minix_iget(dir->i_sb, ino);\n\treturn d_splice_alias(inode, dentry);\n}\n\nstatic int minix_mknod(struct mnt_idmap *idmap, struct inode *dir,\n\t\t       struct dentry *dentry, umode_t mode, dev_t rdev)\n{\n\tstruct inode *inode;\n\n\tif (!old_valid_dev(rdev))\n\t\treturn -EINVAL;\n\n\tinode = minix_new_inode(dir, mode);\n\tif (IS_ERR(inode))\n\t\treturn PTR_ERR(inode);\n\n\tminix_set_inode(inode, rdev);\n\tmark_inode_dirty(inode);\n\treturn add_nondir(dentry, inode);\n}\n\nstatic int minix_tmpfile(struct mnt_idmap *idmap, struct inode *dir,\n\t\t\t struct file *file, umode_t mode)\n{\n\tstruct inode *inode = minix_new_inode(dir, mode);\n\n\tif (IS_ERR(inode))\n\t\treturn finish_open_simple(file, PTR_ERR(inode));\n\tminix_set_inode(inode, 0);\n\tmark_inode_dirty(inode);\n\td_tmpfile(file, inode);\n\treturn finish_open_simple(file, 0);\n}\n\nstatic int minix_create(struct mnt_idmap *idmap, struct inode *dir,\n\t\t\tstruct dentry *dentry, umode_t mode, bool excl)\n{\n\treturn minix_mknod(&nop_mnt_idmap, dir, dentry, mode, 0);\n}\n\nstatic int minix_symlink(struct mnt_idmap *idmap, struct inode *dir,\n\t\t\t struct dentry *dentry, const char *symname)\n{\n\tint i = strlen(symname)+1;\n\tstruct inode * inode;\n\tint err;\n\n\tif (i > dir->i_sb->s_blocksize)\n\t\treturn -ENAMETOOLONG;\n\n\tinode = minix_new_inode(dir, S_IFLNK | 0777);\n\tif (IS_ERR(inode))\n\t\treturn PTR_ERR(inode);\n\n\tminix_set_inode(inode, 0);\n\terr = page_symlink(inode, symname, i);\n\tif (unlikely(err)) {\n\t\tinode_dec_link_count(inode);\n\t\tiput(inode);\n\t\treturn err;\n\t}\n\treturn add_nondir(dentry, inode);\n}\n\nstatic int minix_link(struct dentry * old_dentry, struct inode * dir,\n\tstruct dentry *dentry)\n{\n\tstruct inode *inode = d_inode(old_dentry);\n\n\tinode_set_ctime_current(inode);\n\tinode_inc_link_count(inode);\n\tihold(inode);\n\treturn add_nondir(dentry, inode);\n}\n\nstatic int minix_mkdir(struct mnt_idmap *idmap, struct inode *dir,\n\t\t       struct dentry *dentry, umode_t mode)\n{\n\tstruct inode * inode;\n\tint err;\n\n\tinode = minix_new_inode(dir, S_IFDIR | mode);\n\tif (IS_ERR(inode))\n\t\treturn PTR_ERR(inode);\n\n\tinode_inc_link_count(dir);\n\tminix_set_inode(inode, 0);\n\tinode_inc_link_count(inode);\n\n\terr = minix_make_empty(inode, dir);\n\tif (err)\n\t\tgoto out_fail;\n\n\terr = minix_add_link(dentry, inode);\n\tif (err)\n\t\tgoto out_fail;\n\n\td_instantiate(dentry, inode);\nout:\n\treturn err;\n\nout_fail:\n\tinode_dec_link_count(inode);\n\tinode_dec_link_count(inode);\n\tiput(inode);\n\tinode_dec_link_count(dir);\n\tgoto out;\n}\n\nstatic int minix_unlink(struct inode * dir, struct dentry *dentry)\n{\n\tstruct inode * inode = d_inode(dentry);\n\tstruct page * page;\n\tstruct minix_dir_entry * de;\n\tint err;\n\n\tde = minix_find_entry(dentry, &page);\n\tif (!de)\n\t\treturn -ENOENT;\n\terr = minix_delete_entry(de, page);\n\tkunmap(page);\n\tput_page(page);\n\n\tif (err)\n\t\treturn err;\n\tinode_set_ctime_to_ts(inode, inode_get_ctime(dir));\n\tinode_dec_link_count(inode);\n\treturn 0;\n}\n\nstatic int minix_rmdir(struct inode * dir, struct dentry *dentry)\n{\n\tstruct inode * inode = d_inode(dentry);\n\tint err = -ENOTEMPTY;\n\n\tif (minix_empty_dir(inode)) {\n\t\terr = minix_unlink(dir, dentry);\n\t\tif (!err) {\n\t\t\tinode_dec_link_count(dir);\n\t\t\tinode_dec_link_count(inode);\n\t\t}\n\t}\n\treturn err;\n}\n\nstatic int minix_rename(struct mnt_idmap *idmap,\n\t\t\tstruct inode *old_dir, struct dentry *old_dentry,\n\t\t\tstruct inode *new_dir, struct dentry *new_dentry,\n\t\t\tunsigned int flags)\n{\n\tstruct inode * old_inode = d_inode(old_dentry);\n\tstruct inode * new_inode = d_inode(new_dentry);\n\tstruct page * dir_page = NULL;\n\tstruct minix_dir_entry * dir_de = NULL;\n\tstruct page * old_page;\n\tstruct minix_dir_entry * old_de;\n\tint err = -ENOENT;\n\n\tif (flags & ~RENAME_NOREPLACE)\n\t\treturn -EINVAL;\n\n\told_de = minix_find_entry(old_dentry, &old_page);\n\tif (!old_de)\n\t\tgoto out;\n\n\tif (S_ISDIR(old_inode->i_mode)) {\n\t\terr = -EIO;\n\t\tdir_de = minix_dotdot(old_inode, &dir_page);\n\t\tif (!dir_de)\n\t\t\tgoto out_old;\n\t}\n\n\tif (new_inode) {\n\t\tstruct page * new_page;\n\t\tstruct minix_dir_entry * new_de;\n\n\t\terr = -ENOTEMPTY;\n\t\tif (dir_de && !minix_empty_dir(new_inode))\n\t\t\tgoto out_dir;\n\n\t\terr = -ENOENT;\n\t\tnew_de = minix_find_entry(new_dentry, &new_page);\n\t\tif (!new_de)\n\t\t\tgoto out_dir;\n\t\terr = minix_set_link(new_de, new_page, old_inode);\n\t\tkunmap(new_page);\n\t\tput_page(new_page);\n\t\tif (err)\n\t\t\tgoto out_dir;\n\t\tinode_set_ctime_current(new_inode);\n\t\tif (dir_de)\n\t\t\tdrop_nlink(new_inode);\n\t\tinode_dec_link_count(new_inode);\n\t} else {\n\t\terr = minix_add_link(new_dentry, old_inode);\n\t\tif (err)\n\t\t\tgoto out_dir;\n\t\tif (dir_de)\n\t\t\tinode_inc_link_count(new_dir);\n\t}\n\n\terr = minix_delete_entry(old_de, old_page);\n\tif (err)\n\t\tgoto out_dir;\n\n\tmark_inode_dirty(old_inode);\n\n\tif (dir_de) {\n\t\terr = minix_set_link(dir_de, dir_page, new_dir);\n\t\tif (!err)\n\t\t\tinode_dec_link_count(old_dir);\n\t}\nout_dir:\n\tif (dir_de) {\n\t\tkunmap(dir_page);\n\t\tput_page(dir_page);\n\t}\nout_old:\n\tkunmap(old_page);\n\tput_page(old_page);\nout:\n\treturn err;\n}\n\n \nconst struct inode_operations minix_dir_inode_operations = {\n\t.create\t\t= minix_create,\n\t.lookup\t\t= minix_lookup,\n\t.link\t\t= minix_link,\n\t.unlink\t\t= minix_unlink,\n\t.symlink\t= minix_symlink,\n\t.mkdir\t\t= minix_mkdir,\n\t.rmdir\t\t= minix_rmdir,\n\t.mknod\t\t= minix_mknod,\n\t.rename\t\t= minix_rename,\n\t.getattr\t= minix_getattr,\n\t.tmpfile\t= minix_tmpfile,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}