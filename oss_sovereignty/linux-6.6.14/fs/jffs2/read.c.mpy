{
  "module_name": "read.c",
  "hash_id": "7d649e0d1efa278810df21c185dd9011bb808a1192903a6ed894fa2cc1c336bb",
  "original_prompt": "Ingested from linux-6.6.14/fs/jffs2/read.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/crc32.h>\n#include <linux/pagemap.h>\n#include <linux/mtd/mtd.h>\n#include <linux/compiler.h>\n#include \"nodelist.h\"\n#include \"compr.h\"\n\nint jffs2_read_dnode(struct jffs2_sb_info *c, struct jffs2_inode_info *f,\n\t\t     struct jffs2_full_dnode *fd, unsigned char *buf,\n\t\t     int ofs, int len)\n{\n\tstruct jffs2_raw_inode *ri;\n\tsize_t readlen;\n\tuint32_t crc;\n\tunsigned char *decomprbuf = NULL;\n\tunsigned char *readbuf = NULL;\n\tint ret = 0;\n\n\tri = jffs2_alloc_raw_inode();\n\tif (!ri)\n\t\treturn -ENOMEM;\n\n\tret = jffs2_flash_read(c, ref_offset(fd->raw), sizeof(*ri), &readlen, (char *)ri);\n\tif (ret) {\n\t\tjffs2_free_raw_inode(ri);\n\t\tpr_warn(\"Error reading node from 0x%08x: %d\\n\",\n\t\t\tref_offset(fd->raw), ret);\n\t\treturn ret;\n\t}\n\tif (readlen != sizeof(*ri)) {\n\t\tjffs2_free_raw_inode(ri);\n\t\tpr_warn(\"Short read from 0x%08x: wanted 0x%zx bytes, got 0x%zx\\n\",\n\t\t\tref_offset(fd->raw), sizeof(*ri), readlen);\n\t\treturn -EIO;\n\t}\n\tcrc = crc32(0, ri, sizeof(*ri)-8);\n\n\tjffs2_dbg(1, \"Node read from %08x: node_crc %08x, calculated CRC %08x. dsize %x, csize %x, offset %x, buf %p\\n\",\n\t\t  ref_offset(fd->raw), je32_to_cpu(ri->node_crc),\n\t\t  crc, je32_to_cpu(ri->dsize), je32_to_cpu(ri->csize),\n\t\t  je32_to_cpu(ri->offset), buf);\n\tif (crc != je32_to_cpu(ri->node_crc)) {\n\t\tpr_warn(\"Node CRC %08x != calculated CRC %08x for node at %08x\\n\",\n\t\t\tje32_to_cpu(ri->node_crc), crc, ref_offset(fd->raw));\n\t\tret = -EIO;\n\t\tgoto out_ri;\n\t}\n\t \n\tif (ri->compr == JFFS2_COMPR_ZERO && !je32_to_cpu(ri->dsize) &&\n\t    je32_to_cpu(ri->csize)) {\n\t\tri->dsize = ri->csize;\n\t\tri->csize = cpu_to_je32(0);\n\t}\n\n\tD1(if(ofs + len > je32_to_cpu(ri->dsize)) {\n\t\t\tpr_warn(\"jffs2_read_dnode() asked for %d bytes at %d from %d-byte node\\n\",\n\t\t\t\tlen, ofs, je32_to_cpu(ri->dsize));\n\t\tret = -EINVAL;\n\t\tgoto out_ri;\n\t});\n\n\n\tif (ri->compr == JFFS2_COMPR_ZERO) {\n\t\tmemset(buf, 0, len);\n\t\tgoto out_ri;\n\t}\n\n\t \n\tif (ri->compr == JFFS2_COMPR_NONE && len == je32_to_cpu(ri->dsize)) {\n\t\treadbuf = buf;\n\t} else {\n\t\treadbuf = kmalloc(je32_to_cpu(ri->csize), GFP_KERNEL);\n\t\tif (!readbuf) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto out_ri;\n\t\t}\n\t}\n\tif (ri->compr != JFFS2_COMPR_NONE) {\n\t\tif (len < je32_to_cpu(ri->dsize)) {\n\t\t\tdecomprbuf = kmalloc(je32_to_cpu(ri->dsize), GFP_KERNEL);\n\t\t\tif (!decomprbuf) {\n\t\t\t\tret = -ENOMEM;\n\t\t\t\tgoto out_readbuf;\n\t\t\t}\n\t\t} else {\n\t\t\tdecomprbuf = buf;\n\t\t}\n\t} else {\n\t\tdecomprbuf = readbuf;\n\t}\n\n\tjffs2_dbg(2, \"Read %d bytes to %p\\n\", je32_to_cpu(ri->csize),\n\t\t  readbuf);\n\tret = jffs2_flash_read(c, (ref_offset(fd->raw)) + sizeof(*ri),\n\t\t\t       je32_to_cpu(ri->csize), &readlen, readbuf);\n\n\tif (!ret && readlen != je32_to_cpu(ri->csize))\n\t\tret = -EIO;\n\tif (ret)\n\t\tgoto out_decomprbuf;\n\n\tcrc = crc32(0, readbuf, je32_to_cpu(ri->csize));\n\tif (crc != je32_to_cpu(ri->data_crc)) {\n\t\tpr_warn(\"Data CRC %08x != calculated CRC %08x for node at %08x\\n\",\n\t\t\tje32_to_cpu(ri->data_crc), crc, ref_offset(fd->raw));\n\t\tret = -EIO;\n\t\tgoto out_decomprbuf;\n\t}\n\tjffs2_dbg(2, \"Data CRC matches calculated CRC %08x\\n\", crc);\n\tif (ri->compr != JFFS2_COMPR_NONE) {\n\t\tjffs2_dbg(2, \"Decompress %d bytes from %p to %d bytes at %p\\n\",\n\t\t\t  je32_to_cpu(ri->csize), readbuf,\n\t\t\t  je32_to_cpu(ri->dsize), decomprbuf);\n\t\tret = jffs2_decompress(c, f, ri->compr | (ri->usercompr << 8), readbuf, decomprbuf, je32_to_cpu(ri->csize), je32_to_cpu(ri->dsize));\n\t\tif (ret) {\n\t\t\tpr_warn(\"Error: jffs2_decompress returned %d\\n\", ret);\n\t\t\tgoto out_decomprbuf;\n\t\t}\n\t}\n\n\tif (len < je32_to_cpu(ri->dsize)) {\n\t\tmemcpy(buf, decomprbuf+ofs, len);\n\t}\n out_decomprbuf:\n\tif(decomprbuf != buf && decomprbuf != readbuf)\n\t\tkfree(decomprbuf);\n out_readbuf:\n\tif(readbuf != buf)\n\t\tkfree(readbuf);\n out_ri:\n\tjffs2_free_raw_inode(ri);\n\n\treturn ret;\n}\n\nint jffs2_read_inode_range(struct jffs2_sb_info *c, struct jffs2_inode_info *f,\n\t\t\t   unsigned char *buf, uint32_t offset, uint32_t len)\n{\n\tuint32_t end = offset + len;\n\tstruct jffs2_node_frag *frag;\n\tint ret;\n\n\tjffs2_dbg(1, \"%s(): ino #%u, range 0x%08x-0x%08x\\n\",\n\t\t  __func__, f->inocache->ino, offset, offset + len);\n\n\tfrag = jffs2_lookup_node_frag(&f->fragtree, offset);\n\n\t \n\t \n\twhile(offset < end) {\n\t\tjffs2_dbg(2, \"%s(): offset %d, end %d\\n\",\n\t\t\t  __func__, offset, end);\n\t\tif (unlikely(!frag || frag->ofs > offset ||\n\t\t\t     frag->ofs + frag->size <= offset)) {\n\t\t\tuint32_t holesize = end - offset;\n\t\t\tif (frag && frag->ofs > offset) {\n\t\t\t\tjffs2_dbg(1, \"Eep. Hole in ino #%u fraglist. frag->ofs = 0x%08x, offset = 0x%08x\\n\",\n\t\t\t\t\t  f->inocache->ino, frag->ofs, offset);\n\t\t\t\tholesize = min(holesize, frag->ofs - offset);\n\t\t\t}\n\t\t\tjffs2_dbg(1, \"Filling non-frag hole from %d-%d\\n\",\n\t\t\t\t  offset, offset + holesize);\n\t\t\tmemset(buf, 0, holesize);\n\t\t\tbuf += holesize;\n\t\t\toffset += holesize;\n\t\t\tcontinue;\n\t\t} else if (unlikely(!frag->node)) {\n\t\t\tuint32_t holeend = min(end, frag->ofs + frag->size);\n\t\t\tjffs2_dbg(1, \"Filling frag hole from %d-%d (frag 0x%x 0x%x)\\n\",\n\t\t\t\t  offset, holeend, frag->ofs,\n\t\t\t\t  frag->ofs + frag->size);\n\t\t\tmemset(buf, 0, holeend - offset);\n\t\t\tbuf += holeend - offset;\n\t\t\toffset = holeend;\n\t\t\tfrag = frag_next(frag);\n\t\t\tcontinue;\n\t\t} else {\n\t\t\tuint32_t readlen;\n\t\t\tuint32_t fragofs;  \n\n\t\t\tfragofs = offset - frag->ofs;\n\t\t\treadlen = min(frag->size - fragofs, end - offset);\n\t\t\tjffs2_dbg(1, \"Reading %d-%d from node at 0x%08x (%d)\\n\",\n\t\t\t\t  frag->ofs+fragofs,\n\t\t\t\t  frag->ofs + fragofs+readlen,\n\t\t\t\t  ref_offset(frag->node->raw),\n\t\t\t\t  ref_flags(frag->node->raw));\n\t\t\tret = jffs2_read_dnode(c, f, frag->node, buf, fragofs + frag->ofs - frag->node->ofs, readlen);\n\t\t\tjffs2_dbg(2, \"node read done\\n\");\n\t\t\tif (ret) {\n\t\t\t\tjffs2_dbg(1, \"%s(): error %d\\n\",\n\t\t\t\t\t  __func__, ret);\n\t\t\t\tmemset(buf, 0, readlen);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\tbuf += readlen;\n\t\t\toffset += readlen;\n\t\t\tfrag = frag_next(frag);\n\t\t\tjffs2_dbg(2, \"node read was OK. Looping\\n\");\n\t\t}\n\t}\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}