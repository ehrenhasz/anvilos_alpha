{
  "module_name": "compr_lzo.c",
  "hash_id": "478b45bf076c9259d436ea7d68309ba6534a42adb85b6053755f38ad983f18da",
  "original_prompt": "Ingested from linux-6.6.14/fs/jffs2/compr_lzo.c",
  "human_readable_source": " \n\n#include <linux/kernel.h>\n#include <linux/sched.h>\n#include <linux/vmalloc.h>\n#include <linux/init.h>\n#include <linux/lzo.h>\n#include \"compr.h\"\n\nstatic void *lzo_mem;\nstatic void *lzo_compress_buf;\nstatic DEFINE_MUTEX(deflate_mutex);\t \n\nstatic void free_workspace(void)\n{\n\tvfree(lzo_mem);\n\tvfree(lzo_compress_buf);\n}\n\nstatic int __init alloc_workspace(void)\n{\n\tlzo_mem = vmalloc(LZO1X_MEM_COMPRESS);\n\tlzo_compress_buf = vmalloc(lzo1x_worst_compress(PAGE_SIZE));\n\n\tif (!lzo_mem || !lzo_compress_buf) {\n\t\tfree_workspace();\n\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\nstatic int jffs2_lzo_compress(unsigned char *data_in, unsigned char *cpage_out,\n\t\t\t      uint32_t *sourcelen, uint32_t *dstlen)\n{\n\tsize_t compress_size;\n\tint ret;\n\n\tmutex_lock(&deflate_mutex);\n\tret = lzo1x_1_compress(data_in, *sourcelen, lzo_compress_buf, &compress_size, lzo_mem);\n\tif (ret != LZO_E_OK)\n\t\tgoto fail;\n\n\tif (compress_size > *dstlen)\n\t\tgoto fail;\n\n\tmemcpy(cpage_out, lzo_compress_buf, compress_size);\n\tmutex_unlock(&deflate_mutex);\n\n\t*dstlen = compress_size;\n\treturn 0;\n\n fail:\n\tmutex_unlock(&deflate_mutex);\n\treturn -1;\n}\n\nstatic int jffs2_lzo_decompress(unsigned char *data_in, unsigned char *cpage_out,\n\t\t\t\t uint32_t srclen, uint32_t destlen)\n{\n\tsize_t dl = destlen;\n\tint ret;\n\n\tret = lzo1x_decompress_safe(data_in, srclen, cpage_out, &dl);\n\n\tif (ret != LZO_E_OK || dl != destlen)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic struct jffs2_compressor jffs2_lzo_comp = {\n\t.priority = JFFS2_LZO_PRIORITY,\n\t.name = \"lzo\",\n\t.compr = JFFS2_COMPR_LZO,\n\t.compress = &jffs2_lzo_compress,\n\t.decompress = &jffs2_lzo_decompress,\n\t.disabled = 0,\n};\n\nint __init jffs2_lzo_init(void)\n{\n\tint ret;\n\n\tret = alloc_workspace();\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = jffs2_register_compressor(&jffs2_lzo_comp);\n\tif (ret)\n\t\tfree_workspace();\n\n\treturn ret;\n}\n\nvoid jffs2_lzo_exit(void)\n{\n\tjffs2_unregister_compressor(&jffs2_lzo_comp);\n\tfree_workspace();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}