{
  "module_name": "malloc.c",
  "hash_id": "b4d58c347156e7b3446198452646fb0be89d7a4ce95c743000e5ffb9b0d941ac",
  "original_prompt": "Ingested from linux-6.6.14/fs/jffs2/malloc.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/jffs2.h>\n#include \"nodelist.h\"\n\n \nstatic struct kmem_cache *full_dnode_slab;\nstatic struct kmem_cache *raw_dirent_slab;\nstatic struct kmem_cache *raw_inode_slab;\nstatic struct kmem_cache *tmp_dnode_info_slab;\nstatic struct kmem_cache *raw_node_ref_slab;\nstatic struct kmem_cache *node_frag_slab;\nstatic struct kmem_cache *inode_cache_slab;\n#ifdef CONFIG_JFFS2_FS_XATTR\nstatic struct kmem_cache *xattr_datum_cache;\nstatic struct kmem_cache *xattr_ref_cache;\n#endif\n\nint __init jffs2_create_slab_caches(void)\n{\n\tfull_dnode_slab = kmem_cache_create(\"jffs2_full_dnode\",\n\t\t\t\t\t    sizeof(struct jffs2_full_dnode),\n\t\t\t\t\t    0, 0, NULL);\n\tif (!full_dnode_slab)\n\t\tgoto err;\n\n\traw_dirent_slab = kmem_cache_create(\"jffs2_raw_dirent\",\n\t\t\t\t\t    sizeof(struct jffs2_raw_dirent),\n\t\t\t\t\t    0, SLAB_HWCACHE_ALIGN, NULL);\n\tif (!raw_dirent_slab)\n\t\tgoto err;\n\n\traw_inode_slab = kmem_cache_create(\"jffs2_raw_inode\",\n\t\t\t\t\t   sizeof(struct jffs2_raw_inode),\n\t\t\t\t\t   0, SLAB_HWCACHE_ALIGN, NULL);\n\tif (!raw_inode_slab)\n\t\tgoto err;\n\n\ttmp_dnode_info_slab = kmem_cache_create(\"jffs2_tmp_dnode\",\n\t\t\t\t\t\tsizeof(struct jffs2_tmp_dnode_info),\n\t\t\t\t\t\t0, 0, NULL);\n\tif (!tmp_dnode_info_slab)\n\t\tgoto err;\n\n\traw_node_ref_slab = kmem_cache_create(\"jffs2_refblock\",\n\t\t\t\t\t      sizeof(struct jffs2_raw_node_ref) * (REFS_PER_BLOCK + 1),\n\t\t\t\t\t      0, 0, NULL);\n\tif (!raw_node_ref_slab)\n\t\tgoto err;\n\n\tnode_frag_slab = kmem_cache_create(\"jffs2_node_frag\",\n\t\t\t\t\t   sizeof(struct jffs2_node_frag),\n\t\t\t\t\t   0, 0, NULL);\n\tif (!node_frag_slab)\n\t\tgoto err;\n\n\tinode_cache_slab = kmem_cache_create(\"jffs2_inode_cache\",\n\t\t\t\t\t     sizeof(struct jffs2_inode_cache),\n\t\t\t\t\t     0, 0, NULL);\n\tif (!inode_cache_slab)\n\t\tgoto err;\n\n#ifdef CONFIG_JFFS2_FS_XATTR\n\txattr_datum_cache = kmem_cache_create(\"jffs2_xattr_datum\",\n\t\t\t\t\t     sizeof(struct jffs2_xattr_datum),\n\t\t\t\t\t     0, 0, NULL);\n\tif (!xattr_datum_cache)\n\t\tgoto err;\n\n\txattr_ref_cache = kmem_cache_create(\"jffs2_xattr_ref\",\n\t\t\t\t\t   sizeof(struct jffs2_xattr_ref),\n\t\t\t\t\t   0, 0, NULL);\n\tif (!xattr_ref_cache)\n\t\tgoto err;\n#endif\n\n\treturn 0;\n err:\n\tjffs2_destroy_slab_caches();\n\treturn -ENOMEM;\n}\n\nvoid jffs2_destroy_slab_caches(void)\n{\n\tkmem_cache_destroy(full_dnode_slab);\n\tkmem_cache_destroy(raw_dirent_slab);\n\tkmem_cache_destroy(raw_inode_slab);\n\tkmem_cache_destroy(tmp_dnode_info_slab);\n\tkmem_cache_destroy(raw_node_ref_slab);\n\tkmem_cache_destroy(node_frag_slab);\n\tkmem_cache_destroy(inode_cache_slab);\n#ifdef CONFIG_JFFS2_FS_XATTR\n\tkmem_cache_destroy(xattr_datum_cache);\n\tkmem_cache_destroy(xattr_ref_cache);\n#endif\n}\n\nstruct jffs2_full_dirent *jffs2_alloc_full_dirent(int namesize)\n{\n\tstruct jffs2_full_dirent *ret;\n\tret = kmalloc(sizeof(struct jffs2_full_dirent) + namesize, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ret);\n\treturn ret;\n}\n\nvoid jffs2_free_full_dirent(struct jffs2_full_dirent *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkfree(x);\n}\n\nstruct jffs2_full_dnode *jffs2_alloc_full_dnode(void)\n{\n\tstruct jffs2_full_dnode *ret;\n\tret = kmem_cache_alloc(full_dnode_slab, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ret);\n\treturn ret;\n}\n\nvoid jffs2_free_full_dnode(struct jffs2_full_dnode *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(full_dnode_slab, x);\n}\n\nstruct jffs2_raw_dirent *jffs2_alloc_raw_dirent(void)\n{\n\tstruct jffs2_raw_dirent *ret;\n\tret = kmem_cache_alloc(raw_dirent_slab, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ret);\n\treturn ret;\n}\n\nvoid jffs2_free_raw_dirent(struct jffs2_raw_dirent *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(raw_dirent_slab, x);\n}\n\nstruct jffs2_raw_inode *jffs2_alloc_raw_inode(void)\n{\n\tstruct jffs2_raw_inode *ret;\n\tret = kmem_cache_alloc(raw_inode_slab, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ret);\n\treturn ret;\n}\n\nvoid jffs2_free_raw_inode(struct jffs2_raw_inode *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(raw_inode_slab, x);\n}\n\nstruct jffs2_tmp_dnode_info *jffs2_alloc_tmp_dnode_info(void)\n{\n\tstruct jffs2_tmp_dnode_info *ret;\n\tret = kmem_cache_alloc(tmp_dnode_info_slab, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\",\n\t\tret);\n\treturn ret;\n}\n\nvoid jffs2_free_tmp_dnode_info(struct jffs2_tmp_dnode_info *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(tmp_dnode_info_slab, x);\n}\n\nstatic struct jffs2_raw_node_ref *jffs2_alloc_refblock(void)\n{\n\tstruct jffs2_raw_node_ref *ret;\n\n\tret = kmem_cache_alloc(raw_node_ref_slab, GFP_KERNEL);\n\tif (ret) {\n\t\tint i = 0;\n\t\tfor (i=0; i < REFS_PER_BLOCK; i++) {\n\t\t\tret[i].flash_offset = REF_EMPTY_NODE;\n\t\t\tret[i].next_in_ino = NULL;\n\t\t}\n\t\tret[i].flash_offset = REF_LINK_NODE;\n\t\tret[i].next_in_ino = NULL;\n\t}\n\treturn ret;\n}\n\nint jffs2_prealloc_raw_node_refs(struct jffs2_sb_info *c,\n\t\t\t\t struct jffs2_eraseblock *jeb, int nr)\n{\n\tstruct jffs2_raw_node_ref **p, *ref;\n\tint i = nr;\n\n\tdbg_memalloc(\"%d\\n\", nr);\n\n\tp = &jeb->last_node;\n\tref = *p;\n\n\tdbg_memalloc(\"Reserving %d refs for block @0x%08x\\n\", nr, jeb->offset);\n\n\t \n\tif (ref && ref->flash_offset != REF_EMPTY_NODE)\n\t\tref++;\n\n\twhile (i) {\n\t\tif (!ref) {\n\t\t\tdbg_memalloc(\"Allocating new refblock linked from %p\\n\", p);\n\t\t\tref = *p = jffs2_alloc_refblock();\n\t\t\tif (!ref)\n\t\t\t\treturn -ENOMEM;\n\t\t}\n\t\tif (ref->flash_offset == REF_LINK_NODE) {\n\t\t\tp = &ref->next_in_ino;\n\t\t\tref = *p;\n\t\t\tcontinue;\n\t\t}\n\t\ti--;\n\t\tref++;\n\t}\n\tjeb->allocated_refs = nr;\n\n\tdbg_memalloc(\"Reserved %d refs for block @0x%08x, last_node is %p (%08x,%p)\\n\",\n\t\t  nr, jeb->offset, jeb->last_node, jeb->last_node->flash_offset,\n\t\t  jeb->last_node->next_in_ino);\n\n\treturn 0;\n}\n\nvoid jffs2_free_refblock(struct jffs2_raw_node_ref *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(raw_node_ref_slab, x);\n}\n\nstruct jffs2_node_frag *jffs2_alloc_node_frag(void)\n{\n\tstruct jffs2_node_frag *ret;\n\tret = kmem_cache_alloc(node_frag_slab, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ret);\n\treturn ret;\n}\n\nvoid jffs2_free_node_frag(struct jffs2_node_frag *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(node_frag_slab, x);\n}\n\nstruct jffs2_inode_cache *jffs2_alloc_inode_cache(void)\n{\n\tstruct jffs2_inode_cache *ret;\n\tret = kmem_cache_alloc(inode_cache_slab, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ret);\n\treturn ret;\n}\n\nvoid jffs2_free_inode_cache(struct jffs2_inode_cache *x)\n{\n\tdbg_memalloc(\"%p\\n\", x);\n\tkmem_cache_free(inode_cache_slab, x);\n}\n\n#ifdef CONFIG_JFFS2_FS_XATTR\nstruct jffs2_xattr_datum *jffs2_alloc_xattr_datum(void)\n{\n\tstruct jffs2_xattr_datum *xd;\n\txd = kmem_cache_zalloc(xattr_datum_cache, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", xd);\n\tif (!xd)\n\t\treturn NULL;\n\n\txd->class = RAWNODE_CLASS_XATTR_DATUM;\n\txd->node = (void *)xd;\n\tINIT_LIST_HEAD(&xd->xindex);\n\treturn xd;\n}\n\nvoid jffs2_free_xattr_datum(struct jffs2_xattr_datum *xd)\n{\n\tdbg_memalloc(\"%p\\n\", xd);\n\tkmem_cache_free(xattr_datum_cache, xd);\n}\n\nstruct jffs2_xattr_ref *jffs2_alloc_xattr_ref(void)\n{\n\tstruct jffs2_xattr_ref *ref;\n\tref = kmem_cache_zalloc(xattr_ref_cache, GFP_KERNEL);\n\tdbg_memalloc(\"%p\\n\", ref);\n\tif (!ref)\n\t\treturn NULL;\n\n\tref->class = RAWNODE_CLASS_XATTR_REF;\n\tref->node = (void *)ref;\n\treturn ref;\n}\n\nvoid jffs2_free_xattr_ref(struct jffs2_xattr_ref *ref)\n{\n\tdbg_memalloc(\"%p\\n\", ref);\n\tkmem_cache_free(xattr_ref_cache, ref);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}