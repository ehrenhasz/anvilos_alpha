{
  "module_name": "alloc.c",
  "hash_id": "a3f82b08c3dc7c9f20ba43831740f65b79e1a407c2e593799472723492574a90",
  "original_prompt": "Ingested from linux-6.6.14/fs/nilfs2/alloc.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/buffer_head.h>\n#include <linux/fs.h>\n#include <linux/bitops.h>\n#include <linux/slab.h>\n#include \"mdt.h\"\n#include \"alloc.h\"\n\n\n \nstatic inline unsigned long\nnilfs_palloc_groups_per_desc_block(const struct inode *inode)\n{\n\treturn i_blocksize(inode) /\n\t\tsizeof(struct nilfs_palloc_group_desc);\n}\n\n \nstatic inline unsigned long\nnilfs_palloc_groups_count(const struct inode *inode)\n{\n\treturn 1UL << (BITS_PER_LONG - (inode->i_blkbits + 3  ));\n}\n\n \nint nilfs_palloc_init_blockgroup(struct inode *inode, unsigned int entry_size)\n{\n\tstruct nilfs_mdt_info *mi = NILFS_MDT(inode);\n\n\tmi->mi_bgl = kmalloc(sizeof(*mi->mi_bgl), GFP_NOFS);\n\tif (!mi->mi_bgl)\n\t\treturn -ENOMEM;\n\n\tbgl_lock_init(mi->mi_bgl);\n\n\tnilfs_mdt_set_entry_size(inode, entry_size, 0);\n\n\tmi->mi_blocks_per_group =\n\t\tDIV_ROUND_UP(nilfs_palloc_entries_per_group(inode),\n\t\t\t     mi->mi_entries_per_block) + 1;\n\t\t \n\tmi->mi_blocks_per_desc_block =\n\t\tnilfs_palloc_groups_per_desc_block(inode) *\n\t\tmi->mi_blocks_per_group + 1;\n\t\t \n\treturn 0;\n}\n\n \nstatic unsigned long nilfs_palloc_group(const struct inode *inode, __u64 nr,\n\t\t\t\t\tunsigned long *offset)\n{\n\t__u64 group = nr;\n\n\t*offset = do_div(group, nilfs_palloc_entries_per_group(inode));\n\treturn group;\n}\n\n \nstatic unsigned long\nnilfs_palloc_desc_blkoff(const struct inode *inode, unsigned long group)\n{\n\tunsigned long desc_block =\n\t\tgroup / nilfs_palloc_groups_per_desc_block(inode);\n\treturn desc_block * NILFS_MDT(inode)->mi_blocks_per_desc_block;\n}\n\n \nstatic unsigned long\nnilfs_palloc_bitmap_blkoff(const struct inode *inode, unsigned long group)\n{\n\tunsigned long desc_offset =\n\t\tgroup % nilfs_palloc_groups_per_desc_block(inode);\n\treturn nilfs_palloc_desc_blkoff(inode, group) + 1 +\n\t\tdesc_offset * NILFS_MDT(inode)->mi_blocks_per_group;\n}\n\n \nstatic unsigned long\nnilfs_palloc_group_desc_nfrees(const struct nilfs_palloc_group_desc *desc,\n\t\t\t       spinlock_t *lock)\n{\n\tunsigned long nfree;\n\n\tspin_lock(lock);\n\tnfree = le32_to_cpu(desc->pg_nfrees);\n\tspin_unlock(lock);\n\treturn nfree;\n}\n\n \nstatic u32\nnilfs_palloc_group_desc_add_entries(struct nilfs_palloc_group_desc *desc,\n\t\t\t\t    spinlock_t *lock, u32 n)\n{\n\tu32 nfree;\n\n\tspin_lock(lock);\n\tle32_add_cpu(&desc->pg_nfrees, n);\n\tnfree = le32_to_cpu(desc->pg_nfrees);\n\tspin_unlock(lock);\n\treturn nfree;\n}\n\n \nstatic unsigned long\nnilfs_palloc_entry_blkoff(const struct inode *inode, __u64 nr)\n{\n\tunsigned long group, group_offset;\n\n\tgroup = nilfs_palloc_group(inode, nr, &group_offset);\n\n\treturn nilfs_palloc_bitmap_blkoff(inode, group) + 1 +\n\t\tgroup_offset / NILFS_MDT(inode)->mi_entries_per_block;\n}\n\n \nstatic void nilfs_palloc_desc_block_init(struct inode *inode,\n\t\t\t\t\t struct buffer_head *bh, void *kaddr)\n{\n\tstruct nilfs_palloc_group_desc *desc = kaddr + bh_offset(bh);\n\tunsigned long n = nilfs_palloc_groups_per_desc_block(inode);\n\t__le32 nfrees;\n\n\tnfrees = cpu_to_le32(nilfs_palloc_entries_per_group(inode));\n\twhile (n-- > 0) {\n\t\tdesc->pg_nfrees = nfrees;\n\t\tdesc++;\n\t}\n}\n\nstatic int nilfs_palloc_get_block(struct inode *inode, unsigned long blkoff,\n\t\t\t\t  int create,\n\t\t\t\t  void (*init_block)(struct inode *,\n\t\t\t\t\t\t     struct buffer_head *,\n\t\t\t\t\t\t     void *),\n\t\t\t\t  struct buffer_head **bhp,\n\t\t\t\t  struct nilfs_bh_assoc *prev,\n\t\t\t\t  spinlock_t *lock)\n{\n\tint ret;\n\n\tspin_lock(lock);\n\tif (prev->bh && blkoff == prev->blkoff &&\n\t    likely(buffer_uptodate(prev->bh))) {\n\t\tget_bh(prev->bh);\n\t\t*bhp = prev->bh;\n\t\tspin_unlock(lock);\n\t\treturn 0;\n\t}\n\tspin_unlock(lock);\n\n\tret = nilfs_mdt_get_block(inode, blkoff, create, init_block, bhp);\n\tif (!ret) {\n\t\tspin_lock(lock);\n\t\t \n\t\tbrelse(prev->bh);\n\t\tget_bh(*bhp);\n\t\tprev->bh = *bhp;\n\t\tprev->blkoff = blkoff;\n\t\tspin_unlock(lock);\n\t}\n\treturn ret;\n}\n\n \nstatic int nilfs_palloc_delete_block(struct inode *inode, unsigned long blkoff,\n\t\t\t\t     struct nilfs_bh_assoc *prev,\n\t\t\t\t     spinlock_t *lock)\n{\n\tspin_lock(lock);\n\tif (prev->bh && blkoff == prev->blkoff) {\n\t\tbrelse(prev->bh);\n\t\tprev->bh = NULL;\n\t}\n\tspin_unlock(lock);\n\treturn nilfs_mdt_delete_block(inode, blkoff);\n}\n\n \nstatic int nilfs_palloc_get_desc_block(struct inode *inode,\n\t\t\t\t       unsigned long group,\n\t\t\t\t       int create, struct buffer_head **bhp)\n{\n\tstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\n\n\treturn nilfs_palloc_get_block(inode,\n\t\t\t\t      nilfs_palloc_desc_blkoff(inode, group),\n\t\t\t\t      create, nilfs_palloc_desc_block_init,\n\t\t\t\t      bhp, &cache->prev_desc, &cache->lock);\n}\n\n \nstatic int nilfs_palloc_get_bitmap_block(struct inode *inode,\n\t\t\t\t\t unsigned long group,\n\t\t\t\t\t int create, struct buffer_head **bhp)\n{\n\tstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\n\n\treturn nilfs_palloc_get_block(inode,\n\t\t\t\t      nilfs_palloc_bitmap_blkoff(inode, group),\n\t\t\t\t      create, NULL, bhp,\n\t\t\t\t      &cache->prev_bitmap, &cache->lock);\n}\n\n \nstatic int nilfs_palloc_delete_bitmap_block(struct inode *inode,\n\t\t\t\t\t    unsigned long group)\n{\n\tstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\n\n\treturn nilfs_palloc_delete_block(inode,\n\t\t\t\t\t nilfs_palloc_bitmap_blkoff(inode,\n\t\t\t\t\t\t\t\t    group),\n\t\t\t\t\t &cache->prev_bitmap, &cache->lock);\n}\n\n \nint nilfs_palloc_get_entry_block(struct inode *inode, __u64 nr,\n\t\t\t\t int create, struct buffer_head **bhp)\n{\n\tstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\n\n\treturn nilfs_palloc_get_block(inode,\n\t\t\t\t      nilfs_palloc_entry_blkoff(inode, nr),\n\t\t\t\t      create, NULL, bhp,\n\t\t\t\t      &cache->prev_entry, &cache->lock);\n}\n\n \nstatic int nilfs_palloc_delete_entry_block(struct inode *inode, __u64 nr)\n{\n\tstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\n\n\treturn nilfs_palloc_delete_block(inode,\n\t\t\t\t\t nilfs_palloc_entry_blkoff(inode, nr),\n\t\t\t\t\t &cache->prev_entry, &cache->lock);\n}\n\n \nstatic struct nilfs_palloc_group_desc *\nnilfs_palloc_block_get_group_desc(const struct inode *inode,\n\t\t\t\t  unsigned long group,\n\t\t\t\t  const struct buffer_head *bh, void *kaddr)\n{\n\treturn (struct nilfs_palloc_group_desc *)(kaddr + bh_offset(bh)) +\n\t\tgroup % nilfs_palloc_groups_per_desc_block(inode);\n}\n\n \nvoid *nilfs_palloc_block_get_entry(const struct inode *inode, __u64 nr,\n\t\t\t\t   const struct buffer_head *bh, void *kaddr)\n{\n\tunsigned long entry_offset, group_offset;\n\n\tnilfs_palloc_group(inode, nr, &group_offset);\n\tentry_offset = group_offset % NILFS_MDT(inode)->mi_entries_per_block;\n\n\treturn kaddr + bh_offset(bh) +\n\t\tentry_offset * NILFS_MDT(inode)->mi_entry_size;\n}\n\n \nstatic int nilfs_palloc_find_available_slot(unsigned char *bitmap,\n\t\t\t\t\t    unsigned long target,\n\t\t\t\t\t    unsigned int bsize,\n\t\t\t\t\t    spinlock_t *lock)\n{\n\tint pos, end = bsize;\n\n\tif (likely(target < bsize)) {\n\t\tpos = target;\n\t\tdo {\n\t\t\tpos = nilfs_find_next_zero_bit(bitmap, end, pos);\n\t\t\tif (pos >= end)\n\t\t\t\tbreak;\n\t\t\tif (!nilfs_set_bit_atomic(lock, pos, bitmap))\n\t\t\t\treturn pos;\n\t\t} while (++pos < end);\n\n\t\tend = target;\n\t}\n\n\t \n\tfor (pos = 0; pos < end; pos++) {\n\t\tpos = nilfs_find_next_zero_bit(bitmap, end, pos);\n\t\tif (pos >= end)\n\t\t\tbreak;\n\t\tif (!nilfs_set_bit_atomic(lock, pos, bitmap))\n\t\t\treturn pos;\n\t}\n\n\treturn -ENOSPC;\n}\n\n \nstatic unsigned long\nnilfs_palloc_rest_groups_in_desc_block(const struct inode *inode,\n\t\t\t\t       unsigned long curr, unsigned long max)\n{\n\treturn min_t(unsigned long,\n\t\t     nilfs_palloc_groups_per_desc_block(inode) -\n\t\t     curr % nilfs_palloc_groups_per_desc_block(inode),\n\t\t     max - curr + 1);\n}\n\n \nstatic int nilfs_palloc_count_desc_blocks(struct inode *inode,\n\t\t\t\t\t    unsigned long *desc_blocks)\n{\n\t__u64 blknum;\n\tint ret;\n\n\tret = nilfs_bmap_last_key(NILFS_I(inode)->i_bmap, &blknum);\n\tif (likely(!ret))\n\t\t*desc_blocks = DIV_ROUND_UP(\n\t\t\t(unsigned long)blknum,\n\t\t\tNILFS_MDT(inode)->mi_blocks_per_desc_block);\n\treturn ret;\n}\n\n \nstatic inline bool nilfs_palloc_mdt_file_can_grow(struct inode *inode,\n\t\t\t\t\t\t    unsigned long desc_blocks)\n{\n\treturn (nilfs_palloc_groups_per_desc_block(inode) * desc_blocks) <\n\t\t\tnilfs_palloc_groups_count(inode);\n}\n\n \nint nilfs_palloc_count_max_entries(struct inode *inode, u64 nused, u64 *nmaxp)\n{\n\tunsigned long desc_blocks = 0;\n\tu64 entries_per_desc_block, nmax;\n\tint err;\n\n\terr = nilfs_palloc_count_desc_blocks(inode, &desc_blocks);\n\tif (unlikely(err))\n\t\treturn err;\n\n\tentries_per_desc_block = (u64)nilfs_palloc_entries_per_group(inode) *\n\t\t\t\tnilfs_palloc_groups_per_desc_block(inode);\n\tnmax = entries_per_desc_block * desc_blocks;\n\n\tif (nused == nmax &&\n\t\t\tnilfs_palloc_mdt_file_can_grow(inode, desc_blocks))\n\t\tnmax += entries_per_desc_block;\n\n\tif (nused > nmax)\n\t\treturn -ERANGE;\n\n\t*nmaxp = nmax;\n\treturn 0;\n}\n\n \nint nilfs_palloc_prepare_alloc_entry(struct inode *inode,\n\t\t\t\t     struct nilfs_palloc_req *req)\n{\n\tstruct buffer_head *desc_bh, *bitmap_bh;\n\tstruct nilfs_palloc_group_desc *desc;\n\tunsigned char *bitmap;\n\tvoid *desc_kaddr, *bitmap_kaddr;\n\tunsigned long group, maxgroup, ngroups;\n\tunsigned long group_offset, maxgroup_offset;\n\tunsigned long n, entries_per_group;\n\tunsigned long i, j;\n\tspinlock_t *lock;\n\tint pos, ret;\n\n\tngroups = nilfs_palloc_groups_count(inode);\n\tmaxgroup = ngroups - 1;\n\tgroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\n\tentries_per_group = nilfs_palloc_entries_per_group(inode);\n\n\tfor (i = 0; i < ngroups; i += n) {\n\t\tif (group >= ngroups) {\n\t\t\t \n\t\t\tgroup = 0;\n\t\t\tmaxgroup = nilfs_palloc_group(inode, req->pr_entry_nr,\n\t\t\t\t\t\t      &maxgroup_offset) - 1;\n\t\t}\n\t\tret = nilfs_palloc_get_desc_block(inode, group, 1, &desc_bh);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tdesc_kaddr = kmap(desc_bh->b_page);\n\t\tdesc = nilfs_palloc_block_get_group_desc(\n\t\t\tinode, group, desc_bh, desc_kaddr);\n\t\tn = nilfs_palloc_rest_groups_in_desc_block(inode, group,\n\t\t\t\t\t\t\t   maxgroup);\n\t\tfor (j = 0; j < n; j++, desc++, group++) {\n\t\t\tlock = nilfs_mdt_bgl_lock(inode, group);\n\t\t\tif (nilfs_palloc_group_desc_nfrees(desc, lock) > 0) {\n\t\t\t\tret = nilfs_palloc_get_bitmap_block(\n\t\t\t\t\tinode, group, 1, &bitmap_bh);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\tgoto out_desc;\n\t\t\t\tbitmap_kaddr = kmap(bitmap_bh->b_page);\n\t\t\t\tbitmap = bitmap_kaddr + bh_offset(bitmap_bh);\n\t\t\t\tpos = nilfs_palloc_find_available_slot(\n\t\t\t\t\tbitmap, group_offset,\n\t\t\t\t\tentries_per_group, lock);\n\t\t\t\tif (pos >= 0) {\n\t\t\t\t\t \n\t\t\t\t\tnilfs_palloc_group_desc_add_entries(\n\t\t\t\t\t\tdesc, lock, -1);\n\t\t\t\t\treq->pr_entry_nr =\n\t\t\t\t\t\tentries_per_group * group + pos;\n\t\t\t\t\tkunmap(desc_bh->b_page);\n\t\t\t\t\tkunmap(bitmap_bh->b_page);\n\n\t\t\t\t\treq->pr_desc_bh = desc_bh;\n\t\t\t\t\treq->pr_bitmap_bh = bitmap_bh;\n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t\tkunmap(bitmap_bh->b_page);\n\t\t\t\tbrelse(bitmap_bh);\n\t\t\t}\n\n\t\t\tgroup_offset = 0;\n\t\t}\n\n\t\tkunmap(desc_bh->b_page);\n\t\tbrelse(desc_bh);\n\t}\n\n\t \n\treturn -ENOSPC;\n\n out_desc:\n\tkunmap(desc_bh->b_page);\n\tbrelse(desc_bh);\n\treturn ret;\n}\n\n \nvoid nilfs_palloc_commit_alloc_entry(struct inode *inode,\n\t\t\t\t     struct nilfs_palloc_req *req)\n{\n\tmark_buffer_dirty(req->pr_bitmap_bh);\n\tmark_buffer_dirty(req->pr_desc_bh);\n\tnilfs_mdt_mark_dirty(inode);\n\n\tbrelse(req->pr_bitmap_bh);\n\tbrelse(req->pr_desc_bh);\n}\n\n \nvoid nilfs_palloc_commit_free_entry(struct inode *inode,\n\t\t\t\t    struct nilfs_palloc_req *req)\n{\n\tstruct nilfs_palloc_group_desc *desc;\n\tunsigned long group, group_offset;\n\tunsigned char *bitmap;\n\tvoid *desc_kaddr, *bitmap_kaddr;\n\tspinlock_t *lock;\n\n\tgroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\n\tdesc_kaddr = kmap(req->pr_desc_bh->b_page);\n\tdesc = nilfs_palloc_block_get_group_desc(inode, group,\n\t\t\t\t\t\t req->pr_desc_bh, desc_kaddr);\n\tbitmap_kaddr = kmap(req->pr_bitmap_bh->b_page);\n\tbitmap = bitmap_kaddr + bh_offset(req->pr_bitmap_bh);\n\tlock = nilfs_mdt_bgl_lock(inode, group);\n\n\tif (!nilfs_clear_bit_atomic(lock, group_offset, bitmap))\n\t\tnilfs_warn(inode->i_sb,\n\t\t\t   \"%s (ino=%lu): entry number %llu already freed\",\n\t\t\t   __func__, inode->i_ino,\n\t\t\t   (unsigned long long)req->pr_entry_nr);\n\telse\n\t\tnilfs_palloc_group_desc_add_entries(desc, lock, 1);\n\n\tkunmap(req->pr_bitmap_bh->b_page);\n\tkunmap(req->pr_desc_bh->b_page);\n\n\tmark_buffer_dirty(req->pr_desc_bh);\n\tmark_buffer_dirty(req->pr_bitmap_bh);\n\tnilfs_mdt_mark_dirty(inode);\n\n\tbrelse(req->pr_bitmap_bh);\n\tbrelse(req->pr_desc_bh);\n}\n\n \nvoid nilfs_palloc_abort_alloc_entry(struct inode *inode,\n\t\t\t\t    struct nilfs_palloc_req *req)\n{\n\tstruct nilfs_palloc_group_desc *desc;\n\tvoid *desc_kaddr, *bitmap_kaddr;\n\tunsigned char *bitmap;\n\tunsigned long group, group_offset;\n\tspinlock_t *lock;\n\n\tgroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\n\tdesc_kaddr = kmap(req->pr_desc_bh->b_page);\n\tdesc = nilfs_palloc_block_get_group_desc(inode, group,\n\t\t\t\t\t\t req->pr_desc_bh, desc_kaddr);\n\tbitmap_kaddr = kmap(req->pr_bitmap_bh->b_page);\n\tbitmap = bitmap_kaddr + bh_offset(req->pr_bitmap_bh);\n\tlock = nilfs_mdt_bgl_lock(inode, group);\n\n\tif (!nilfs_clear_bit_atomic(lock, group_offset, bitmap))\n\t\tnilfs_warn(inode->i_sb,\n\t\t\t   \"%s (ino=%lu): entry number %llu already freed\",\n\t\t\t   __func__, inode->i_ino,\n\t\t\t   (unsigned long long)req->pr_entry_nr);\n\telse\n\t\tnilfs_palloc_group_desc_add_entries(desc, lock, 1);\n\n\tkunmap(req->pr_bitmap_bh->b_page);\n\tkunmap(req->pr_desc_bh->b_page);\n\n\tbrelse(req->pr_bitmap_bh);\n\tbrelse(req->pr_desc_bh);\n\n\treq->pr_entry_nr = 0;\n\treq->pr_bitmap_bh = NULL;\n\treq->pr_desc_bh = NULL;\n}\n\n \nint nilfs_palloc_prepare_free_entry(struct inode *inode,\n\t\t\t\t    struct nilfs_palloc_req *req)\n{\n\tstruct buffer_head *desc_bh, *bitmap_bh;\n\tunsigned long group, group_offset;\n\tint ret;\n\n\tgroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\n\tret = nilfs_palloc_get_desc_block(inode, group, 1, &desc_bh);\n\tif (ret < 0)\n\t\treturn ret;\n\tret = nilfs_palloc_get_bitmap_block(inode, group, 1, &bitmap_bh);\n\tif (ret < 0) {\n\t\tbrelse(desc_bh);\n\t\treturn ret;\n\t}\n\n\treq->pr_desc_bh = desc_bh;\n\treq->pr_bitmap_bh = bitmap_bh;\n\treturn 0;\n}\n\n \nvoid nilfs_palloc_abort_free_entry(struct inode *inode,\n\t\t\t\t   struct nilfs_palloc_req *req)\n{\n\tbrelse(req->pr_bitmap_bh);\n\tbrelse(req->pr_desc_bh);\n\n\treq->pr_entry_nr = 0;\n\treq->pr_bitmap_bh = NULL;\n\treq->pr_desc_bh = NULL;\n}\n\n \nint nilfs_palloc_freev(struct inode *inode, __u64 *entry_nrs, size_t nitems)\n{\n\tstruct buffer_head *desc_bh, *bitmap_bh;\n\tstruct nilfs_palloc_group_desc *desc;\n\tunsigned char *bitmap;\n\tvoid *desc_kaddr, *bitmap_kaddr;\n\tunsigned long group, group_offset;\n\t__u64 group_min_nr, last_nrs[8];\n\tconst unsigned long epg = nilfs_palloc_entries_per_group(inode);\n\tconst unsigned int epb = NILFS_MDT(inode)->mi_entries_per_block;\n\tunsigned int entry_start, end, pos;\n\tspinlock_t *lock;\n\tint i, j, k, ret;\n\tu32 nfree;\n\n\tfor (i = 0; i < nitems; i = j) {\n\t\tint change_group = false;\n\t\tint nempties = 0, n = 0;\n\n\t\tgroup = nilfs_palloc_group(inode, entry_nrs[i], &group_offset);\n\t\tret = nilfs_palloc_get_desc_block(inode, group, 0, &desc_bh);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tret = nilfs_palloc_get_bitmap_block(inode, group, 0,\n\t\t\t\t\t\t    &bitmap_bh);\n\t\tif (ret < 0) {\n\t\t\tbrelse(desc_bh);\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tgroup_min_nr = (__u64)group * epg;\n\n\t\tbitmap_kaddr = kmap(bitmap_bh->b_page);\n\t\tbitmap = bitmap_kaddr + bh_offset(bitmap_bh);\n\t\tlock = nilfs_mdt_bgl_lock(inode, group);\n\n\t\tj = i;\n\t\tentry_start = rounddown(group_offset, epb);\n\t\tdo {\n\t\t\tif (!nilfs_clear_bit_atomic(lock, group_offset,\n\t\t\t\t\t\t    bitmap)) {\n\t\t\t\tnilfs_warn(inode->i_sb,\n\t\t\t\t\t   \"%s (ino=%lu): entry number %llu already freed\",\n\t\t\t\t\t   __func__, inode->i_ino,\n\t\t\t\t\t   (unsigned long long)entry_nrs[j]);\n\t\t\t} else {\n\t\t\t\tn++;\n\t\t\t}\n\n\t\t\tj++;\n\t\t\tif (j >= nitems || entry_nrs[j] < group_min_nr ||\n\t\t\t    entry_nrs[j] >= group_min_nr + epg) {\n\t\t\t\tchange_group = true;\n\t\t\t} else {\n\t\t\t\tgroup_offset = entry_nrs[j] - group_min_nr;\n\t\t\t\tif (group_offset >= entry_start &&\n\t\t\t\t    group_offset < entry_start + epb) {\n\t\t\t\t\t \n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\tend = entry_start + epb;\n\t\t\tpos = nilfs_find_next_bit(bitmap, end, entry_start);\n\t\t\tif (pos >= end) {\n\t\t\t\tlast_nrs[nempties++] = entry_nrs[j - 1];\n\t\t\t\tif (nempties >= ARRAY_SIZE(last_nrs))\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (change_group)\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\tentry_start = rounddown(group_offset, epb);\n\t\t} while (true);\n\n\t\tkunmap(bitmap_bh->b_page);\n\t\tmark_buffer_dirty(bitmap_bh);\n\t\tbrelse(bitmap_bh);\n\n\t\tfor (k = 0; k < nempties; k++) {\n\t\t\tret = nilfs_palloc_delete_entry_block(inode,\n\t\t\t\t\t\t\t      last_nrs[k]);\n\t\t\tif (ret && ret != -ENOENT)\n\t\t\t\tnilfs_warn(inode->i_sb,\n\t\t\t\t\t   \"error %d deleting block that object (entry=%llu, ino=%lu) belongs to\",\n\t\t\t\t\t   ret, (unsigned long long)last_nrs[k],\n\t\t\t\t\t   inode->i_ino);\n\t\t}\n\n\t\tdesc_kaddr = kmap_atomic(desc_bh->b_page);\n\t\tdesc = nilfs_palloc_block_get_group_desc(\n\t\t\tinode, group, desc_bh, desc_kaddr);\n\t\tnfree = nilfs_palloc_group_desc_add_entries(desc, lock, n);\n\t\tkunmap_atomic(desc_kaddr);\n\t\tmark_buffer_dirty(desc_bh);\n\t\tnilfs_mdt_mark_dirty(inode);\n\t\tbrelse(desc_bh);\n\n\t\tif (nfree == nilfs_palloc_entries_per_group(inode)) {\n\t\t\tret = nilfs_palloc_delete_bitmap_block(inode, group);\n\t\t\tif (ret && ret != -ENOENT)\n\t\t\t\tnilfs_warn(inode->i_sb,\n\t\t\t\t\t   \"error %d deleting bitmap block of group=%lu, ino=%lu\",\n\t\t\t\t\t   ret, group, inode->i_ino);\n\t\t}\n\t}\n\treturn 0;\n}\n\nvoid nilfs_palloc_setup_cache(struct inode *inode,\n\t\t\t      struct nilfs_palloc_cache *cache)\n{\n\tNILFS_MDT(inode)->mi_palloc_cache = cache;\n\tspin_lock_init(&cache->lock);\n}\n\nvoid nilfs_palloc_clear_cache(struct inode *inode)\n{\n\tstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\n\n\tspin_lock(&cache->lock);\n\tbrelse(cache->prev_desc.bh);\n\tbrelse(cache->prev_bitmap.bh);\n\tbrelse(cache->prev_entry.bh);\n\tcache->prev_desc.bh = NULL;\n\tcache->prev_bitmap.bh = NULL;\n\tcache->prev_entry.bh = NULL;\n\tspin_unlock(&cache->lock);\n}\n\nvoid nilfs_palloc_destroy_cache(struct inode *inode)\n{\n\tnilfs_palloc_clear_cache(inode);\n\tNILFS_MDT(inode)->mi_palloc_cache = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}