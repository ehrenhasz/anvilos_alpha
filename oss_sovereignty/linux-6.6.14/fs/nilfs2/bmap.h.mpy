{
  "module_name": "bmap.h",
  "hash_id": "d199b13073d9361e773045e79ea3192306ca017ff06d556dcd229b46bafde4fe",
  "original_prompt": "Ingested from linux-6.6.14/fs/nilfs2/bmap.h",
  "human_readable_source": " \n \n\n#ifndef _NILFS_BMAP_H\n#define _NILFS_BMAP_H\n\n#include <linux/types.h>\n#include <linux/fs.h>\n#include <linux/buffer_head.h>\n#include <linux/nilfs2_ondisk.h>\t \n#include \"alloc.h\"\n#include \"dat.h\"\n\n#define NILFS_BMAP_INVALID_PTR\t0\n\n#define nilfs_bmap_keydiff_abs(diff)\t((diff) < 0 ? -(diff) : (diff))\n\n\nstruct nilfs_bmap;\n\n \nunion nilfs_bmap_ptr_req {\n\t__u64 bpr_ptr;\n\tstruct nilfs_palloc_req bpr_req;\n};\n\n \nstruct nilfs_bmap_stats {\n\tunsigned int bs_nblocks;\n};\n\n \nstruct nilfs_bmap_operations {\n\tint (*bop_lookup)(const struct nilfs_bmap *, __u64, int, __u64 *);\n\tint (*bop_lookup_contig)(const struct nilfs_bmap *, __u64, __u64 *,\n\t\t\t\t unsigned int);\n\tint (*bop_insert)(struct nilfs_bmap *, __u64, __u64);\n\tint (*bop_delete)(struct nilfs_bmap *, __u64);\n\tvoid (*bop_clear)(struct nilfs_bmap *);\n\n\tint (*bop_propagate)(struct nilfs_bmap *, struct buffer_head *);\n\tvoid (*bop_lookup_dirty_buffers)(struct nilfs_bmap *,\n\t\t\t\t\t struct list_head *);\n\n\tint (*bop_assign)(struct nilfs_bmap *,\n\t\t\t  struct buffer_head **,\n\t\t\t  sector_t,\n\t\t\t  union nilfs_binfo *);\n\tint (*bop_mark)(struct nilfs_bmap *, __u64, int);\n\n\tint (*bop_seek_key)(const struct nilfs_bmap *, __u64, __u64 *);\n\tint (*bop_last_key)(const struct nilfs_bmap *, __u64 *);\n\n\t \n\tint (*bop_check_insert)(const struct nilfs_bmap *, __u64);\n\tint (*bop_check_delete)(struct nilfs_bmap *, __u64);\n\tint (*bop_gather_data)(struct nilfs_bmap *, __u64 *, __u64 *, int);\n};\n\n\n#define NILFS_BMAP_SIZE\t\t(NILFS_INODE_BMAP_SIZE * sizeof(__le64))\n#define NILFS_BMAP_KEY_BIT\t(sizeof(unsigned long) * 8  )\n#define NILFS_BMAP_NEW_PTR_INIT\t\\\n\t(1UL << (sizeof(unsigned long) * 8   - 1))\n\nstatic inline int nilfs_bmap_is_new_ptr(unsigned long ptr)\n{\n\treturn !!(ptr & NILFS_BMAP_NEW_PTR_INIT);\n}\n\n\n \nstruct nilfs_bmap {\n\tunion {\n\t\t__u8 u_flags;\n\t\t__le64 u_data[NILFS_BMAP_SIZE / sizeof(__le64)];\n\t} b_u;\n\tstruct rw_semaphore b_sem;\n\tstruct inode *b_inode;\n\tconst struct nilfs_bmap_operations *b_ops;\n\t__u64 b_last_allocated_key;\n\t__u64 b_last_allocated_ptr;\n\tint b_ptr_type;\n\tint b_state;\n\t__u16 b_nchildren_per_block;\n};\n\n \n#define NILFS_BMAP_PTR_P\t0\t \n#define NILFS_BMAP_PTR_VS\t1\t \n#define NILFS_BMAP_PTR_VM\t2\t \n#define NILFS_BMAP_PTR_U\t(-1)\t \n\n#define NILFS_BMAP_USE_VBN(bmap)\t((bmap)->b_ptr_type > 0)\n\n \n#define NILFS_BMAP_DIRTY\t0x00000001\n\n \nstruct nilfs_bmap_store {\n\t__le64 data[NILFS_BMAP_SIZE / sizeof(__le64)];\n\t__u64 last_allocated_key;\n\t__u64 last_allocated_ptr;\n\tint state;\n};\n\nint nilfs_bmap_test_and_clear_dirty(struct nilfs_bmap *);\nint nilfs_bmap_read(struct nilfs_bmap *, struct nilfs_inode *);\nvoid nilfs_bmap_write(struct nilfs_bmap *, struct nilfs_inode *);\nint nilfs_bmap_lookup_contig(struct nilfs_bmap *, __u64, __u64 *, unsigned int);\nint nilfs_bmap_insert(struct nilfs_bmap *bmap, __u64 key, unsigned long rec);\nint nilfs_bmap_delete(struct nilfs_bmap *bmap, __u64 key);\nint nilfs_bmap_seek_key(struct nilfs_bmap *bmap, __u64 start, __u64 *keyp);\nint nilfs_bmap_last_key(struct nilfs_bmap *bmap, __u64 *keyp);\nint nilfs_bmap_truncate(struct nilfs_bmap *bmap, __u64 key);\nvoid nilfs_bmap_clear(struct nilfs_bmap *);\nint nilfs_bmap_propagate(struct nilfs_bmap *, struct buffer_head *);\nvoid nilfs_bmap_lookup_dirty_buffers(struct nilfs_bmap *, struct list_head *);\nint nilfs_bmap_assign(struct nilfs_bmap *, struct buffer_head **,\n\t\t      unsigned long, union nilfs_binfo *);\nint nilfs_bmap_lookup_at_level(struct nilfs_bmap *, __u64, int, __u64 *);\nint nilfs_bmap_mark(struct nilfs_bmap *, __u64, int);\n\nvoid nilfs_bmap_init_gc(struct nilfs_bmap *);\n\nvoid nilfs_bmap_save(const struct nilfs_bmap *, struct nilfs_bmap_store *);\nvoid nilfs_bmap_restore(struct nilfs_bmap *, const struct nilfs_bmap_store *);\n\nstatic inline int nilfs_bmap_lookup(struct nilfs_bmap *bmap, __u64 key,\n\t\t\t\t    __u64 *ptr)\n{\n\treturn nilfs_bmap_lookup_at_level(bmap, key, 1, ptr);\n}\n\n \nstruct inode *nilfs_bmap_get_dat(const struct nilfs_bmap *);\n\nstatic inline int nilfs_bmap_prepare_alloc_ptr(struct nilfs_bmap *bmap,\n\t\t\t\t\t       union nilfs_bmap_ptr_req *req,\n\t\t\t\t\t       struct inode *dat)\n{\n\tif (dat)\n\t\treturn nilfs_dat_prepare_alloc(dat, &req->bpr_req);\n\t \n\treq->bpr_ptr = bmap->b_last_allocated_ptr++;\n\treturn 0;\n}\n\nstatic inline void nilfs_bmap_commit_alloc_ptr(struct nilfs_bmap *bmap,\n\t\t\t\t\t       union nilfs_bmap_ptr_req *req,\n\t\t\t\t\t       struct inode *dat)\n{\n\tif (dat)\n\t\tnilfs_dat_commit_alloc(dat, &req->bpr_req);\n}\n\nstatic inline void nilfs_bmap_abort_alloc_ptr(struct nilfs_bmap *bmap,\n\t\t\t\t\t      union nilfs_bmap_ptr_req *req,\n\t\t\t\t\t      struct inode *dat)\n{\n\tif (dat)\n\t\tnilfs_dat_abort_alloc(dat, &req->bpr_req);\n\telse\n\t\tbmap->b_last_allocated_ptr--;\n}\n\nstatic inline int nilfs_bmap_prepare_end_ptr(struct nilfs_bmap *bmap,\n\t\t\t\t\t     union nilfs_bmap_ptr_req *req,\n\t\t\t\t\t     struct inode *dat)\n{\n\treturn dat ? nilfs_dat_prepare_end(dat, &req->bpr_req) : 0;\n}\n\nstatic inline void nilfs_bmap_commit_end_ptr(struct nilfs_bmap *bmap,\n\t\t\t\t\t     union nilfs_bmap_ptr_req *req,\n\t\t\t\t\t     struct inode *dat)\n{\n\tif (dat)\n\t\tnilfs_dat_commit_end(dat, &req->bpr_req,\n\t\t\t\t     bmap->b_ptr_type == NILFS_BMAP_PTR_VS);\n}\n\nstatic inline void nilfs_bmap_abort_end_ptr(struct nilfs_bmap *bmap,\n\t\t\t\t\t    union nilfs_bmap_ptr_req *req,\n\t\t\t\t\t    struct inode *dat)\n{\n\tif (dat)\n\t\tnilfs_dat_abort_end(dat, &req->bpr_req);\n}\n\nstatic inline void nilfs_bmap_set_target_v(struct nilfs_bmap *bmap, __u64 key,\n\t\t\t\t\t   __u64 ptr)\n{\n\tbmap->b_last_allocated_key = key;\n\tbmap->b_last_allocated_ptr = ptr;\n}\n\n__u64 nilfs_bmap_data_get_key(const struct nilfs_bmap *,\n\t\t\t      const struct buffer_head *);\n\n__u64 nilfs_bmap_find_target_seq(const struct nilfs_bmap *, __u64);\n__u64 nilfs_bmap_find_target_in_group(const struct nilfs_bmap *);\n\n\n \nstatic inline int nilfs_bmap_dirty(const struct nilfs_bmap *bmap)\n{\n\treturn !!(bmap->b_state & NILFS_BMAP_DIRTY);\n}\n\n \nstatic inline void nilfs_bmap_set_dirty(struct nilfs_bmap *bmap)\n{\n\tbmap->b_state |= NILFS_BMAP_DIRTY;\n}\n\n \nstatic inline void nilfs_bmap_clear_dirty(struct nilfs_bmap *bmap)\n{\n\tbmap->b_state &= ~NILFS_BMAP_DIRTY;\n}\n\n\n#define NILFS_BMAP_LARGE\t0x1\n\n#define NILFS_BMAP_SMALL_LOW\tNILFS_DIRECT_KEY_MIN\n#define NILFS_BMAP_SMALL_HIGH\tNILFS_DIRECT_KEY_MAX\n#define NILFS_BMAP_LARGE_LOW\tNILFS_BTREE_ROOT_NCHILDREN_MAX\n#define NILFS_BMAP_LARGE_HIGH\tNILFS_BTREE_KEY_MAX\n\n#endif\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}