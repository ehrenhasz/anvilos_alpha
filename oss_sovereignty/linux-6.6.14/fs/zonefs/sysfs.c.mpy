{
  "module_name": "sysfs.c",
  "hash_id": "851b11d4c1dcbd2be2d92682fcea8a9eb76f5e37c3e50a621e6e8d828d60bef0",
  "original_prompt": "Ingested from linux-6.6.14/fs/zonefs/sysfs.c",
  "human_readable_source": "\n \n#include <linux/fs.h>\n#include <linux/seq_file.h>\n#include <linux/blkdev.h>\n\n#include \"zonefs.h\"\n\nstruct zonefs_sysfs_attr {\n\tstruct attribute attr;\n\tssize_t (*show)(struct zonefs_sb_info *sbi, char *buf);\n};\n\n#define ZONEFS_SYSFS_ATTR_RO(name) \\\nstatic struct zonefs_sysfs_attr zonefs_sysfs_attr_##name = __ATTR_RO(name)\n\n#define ATTR_LIST(name) &zonefs_sysfs_attr_##name.attr\n\nstatic ssize_t zonefs_sysfs_attr_show(struct kobject *kobj,\n\t\t\t\t      struct attribute *attr, char *buf)\n{\n\tstruct zonefs_sb_info *sbi =\n\t\tcontainer_of(kobj, struct zonefs_sb_info, s_kobj);\n\tstruct zonefs_sysfs_attr *zonefs_attr =\n\t\tcontainer_of(attr, struct zonefs_sysfs_attr, attr);\n\n\tif (!zonefs_attr->show)\n\t\treturn 0;\n\n\treturn zonefs_attr->show(sbi, buf);\n}\n\nstatic ssize_t max_wro_seq_files_show(struct zonefs_sb_info *sbi, char *buf)\n{\n\treturn sysfs_emit(buf, \"%u\\n\", sbi->s_max_wro_seq_files);\n}\nZONEFS_SYSFS_ATTR_RO(max_wro_seq_files);\n\nstatic ssize_t nr_wro_seq_files_show(struct zonefs_sb_info *sbi, char *buf)\n{\n\treturn sysfs_emit(buf, \"%d\\n\", atomic_read(&sbi->s_wro_seq_files));\n}\nZONEFS_SYSFS_ATTR_RO(nr_wro_seq_files);\n\nstatic ssize_t max_active_seq_files_show(struct zonefs_sb_info *sbi, char *buf)\n{\n\treturn sysfs_emit(buf, \"%u\\n\", sbi->s_max_active_seq_files);\n}\nZONEFS_SYSFS_ATTR_RO(max_active_seq_files);\n\nstatic ssize_t nr_active_seq_files_show(struct zonefs_sb_info *sbi, char *buf)\n{\n\treturn sysfs_emit(buf, \"%d\\n\", atomic_read(&sbi->s_active_seq_files));\n}\nZONEFS_SYSFS_ATTR_RO(nr_active_seq_files);\n\nstatic struct attribute *zonefs_sysfs_attrs[] = {\n\tATTR_LIST(max_wro_seq_files),\n\tATTR_LIST(nr_wro_seq_files),\n\tATTR_LIST(max_active_seq_files),\n\tATTR_LIST(nr_active_seq_files),\n\tNULL,\n};\nATTRIBUTE_GROUPS(zonefs_sysfs);\n\nstatic void zonefs_sysfs_sb_release(struct kobject *kobj)\n{\n\tstruct zonefs_sb_info *sbi =\n\t\tcontainer_of(kobj, struct zonefs_sb_info, s_kobj);\n\n\tcomplete(&sbi->s_kobj_unregister);\n}\n\nstatic const struct sysfs_ops zonefs_sysfs_attr_ops = {\n\t.show\t= zonefs_sysfs_attr_show,\n};\n\nstatic const struct kobj_type zonefs_sb_ktype = {\n\t.default_groups = zonefs_sysfs_groups,\n\t.sysfs_ops\t= &zonefs_sysfs_attr_ops,\n\t.release\t= zonefs_sysfs_sb_release,\n};\n\nstatic struct kobject *zonefs_sysfs_root;\n\nint zonefs_sysfs_register(struct super_block *sb)\n{\n\tstruct zonefs_sb_info *sbi = ZONEFS_SB(sb);\n\tint ret;\n\n\tinit_completion(&sbi->s_kobj_unregister);\n\tret = kobject_init_and_add(&sbi->s_kobj, &zonefs_sb_ktype,\n\t\t\t\t   zonefs_sysfs_root, \"%s\", sb->s_id);\n\tif (ret) {\n\t\tkobject_put(&sbi->s_kobj);\n\t\twait_for_completion(&sbi->s_kobj_unregister);\n\t\treturn ret;\n\t}\n\n\tsbi->s_sysfs_registered = true;\n\n\treturn 0;\n}\n\nvoid zonefs_sysfs_unregister(struct super_block *sb)\n{\n\tstruct zonefs_sb_info *sbi = ZONEFS_SB(sb);\n\n\tif (!sbi || !sbi->s_sysfs_registered)\n\t\treturn;\n\n\tkobject_del(&sbi->s_kobj);\n\tkobject_put(&sbi->s_kobj);\n\twait_for_completion(&sbi->s_kobj_unregister);\n}\n\nint __init zonefs_sysfs_init(void)\n{\n\tzonefs_sysfs_root = kobject_create_and_add(\"zonefs\", fs_kobj);\n\tif (!zonefs_sysfs_root)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nvoid zonefs_sysfs_exit(void)\n{\n\tkobject_put(zonefs_sysfs_root);\n\tzonefs_sysfs_root = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}