{
  "module_name": "fat.h",
  "hash_id": "174ec4812965791553a0ac930d3b4aa14bb7235c6dc083f14090e0bacda87351",
  "original_prompt": "Ingested from linux-6.6.14/fs/fat/fat.h",
  "human_readable_source": " \n#ifndef _FAT_H\n#define _FAT_H\n\n#include <linux/buffer_head.h>\n#include <linux/nls.h>\n#include <linux/hash.h>\n#include <linux/ratelimit.h>\n#include <linux/msdos_fs.h>\n\n \n#define VFAT_SFN_DISPLAY_LOWER\t0x0001  \n#define VFAT_SFN_DISPLAY_WIN95\t0x0002  \n#define VFAT_SFN_DISPLAY_WINNT\t0x0004  \n#define VFAT_SFN_CREATE_WIN95\t0x0100  \n#define VFAT_SFN_CREATE_WINNT\t0x0200  \n\n#define FAT_ERRORS_CONT\t\t1       \n#define FAT_ERRORS_PANIC\t2       \n#define FAT_ERRORS_RO\t\t3       \n\n#define FAT_NFS_STALE_RW\t1       \n#define FAT_NFS_NOSTALE_RO\t2       \n\nstruct fat_mount_options {\n\tkuid_t fs_uid;\n\tkgid_t fs_gid;\n\tunsigned short fs_fmask;\n\tunsigned short fs_dmask;\n\tunsigned short codepage;    \n\tint time_offset;\t    \n\tchar *iocharset;            \n\tunsigned short shortname;   \n\tunsigned char name_check;   \n\tunsigned char errors;\t    \n\tunsigned char nfs;\t   \n\tunsigned short allow_utime; \n\tunsigned quiet:1,           \n\t\t showexec:1,        \n\t\t sys_immutable:1,   \n\t\t dotsOK:1,          \n\t\t isvfat:1,          \n\t\t utf8:1,\t    \n\t\t unicode_xlate:1,   \n\t\t numtail:1,         \n\t\t flush:1,\t    \n\t\t nocase:1,\t    \n\t\t usefree:1,\t    \n\t\t tz_set:1,\t    \n\t\t rodir:1,\t    \n\t\t discard:1,\t    \n\t\t dos1xfloppy:1;\t    \n};\n\n#define FAT_HASH_BITS\t8\n#define FAT_HASH_SIZE\t(1UL << FAT_HASH_BITS)\n\n \nstruct msdos_sb_info {\n\tunsigned short sec_per_clus;   \n\tunsigned short cluster_bits;   \n\tunsigned int cluster_size;     \n\tunsigned char fats, fat_bits;  \n\tunsigned short fat_start;\n\tunsigned long fat_length;      \n\tunsigned long dir_start;\n\tunsigned short dir_entries;    \n\tunsigned long data_start;      \n\tunsigned long max_cluster;     \n\tunsigned long root_cluster;    \n\tunsigned long fsinfo_sector;   \n\tstruct mutex fat_lock;\n\tstruct mutex nfs_build_inode_lock;\n\tstruct mutex s_lock;\n\tunsigned int prev_free;       \n\tunsigned int free_clusters;   \n\tunsigned int free_clus_valid;  \n\tstruct fat_mount_options options;\n\tstruct nls_table *nls_disk;    \n\tstruct nls_table *nls_io;      \n\tconst void *dir_ops;\t       \n\tint dir_per_block;\t       \n\tint dir_per_block_bits;\t       \n\tunsigned int vol_id;\t\t \n\n\tint fatent_shift;\n\tconst struct fatent_operations *fatent_ops;\n\tstruct inode *fat_inode;\n\tstruct inode *fsinfo_inode;\n\n\tstruct ratelimit_state ratelimit;\n\n\tspinlock_t inode_hash_lock;\n\tstruct hlist_head inode_hashtable[FAT_HASH_SIZE];\n\n\tspinlock_t dir_hash_lock;\n\tstruct hlist_head dir_hashtable[FAT_HASH_SIZE];\n\n\tunsigned int dirty;            \n\tstruct rcu_head rcu;\n};\n\n#define FAT_CACHE_VALID\t0\t \n\n \nstruct msdos_inode_info {\n\tspinlock_t cache_lru_lock;\n\tstruct list_head cache_lru;\n\tint nr_caches;\n\t \n\tunsigned int cache_valid_id;\n\n\t \n\tloff_t mmu_private;\t \n\n\tint i_start;\t\t \n\tint i_logstart;\t\t \n\tint i_attrs;\t\t \n\tloff_t i_pos;\t\t \n\tstruct hlist_node i_fat_hash;\t \n\tstruct hlist_node i_dir_hash;\t \n\tstruct rw_semaphore truncate_lock;  \n\tstruct timespec64 i_crtime;\t \n\tstruct inode vfs_inode;\n};\n\nstruct fat_slot_info {\n\tloff_t i_pos;\t\t \n\tloff_t slot_off;\t \n\tint nr_slots;\t\t \n\tstruct msdos_dir_entry *de;\n\tstruct buffer_head *bh;\n};\n\nstatic inline struct msdos_sb_info *MSDOS_SB(struct super_block *sb)\n{\n\treturn sb->s_fs_info;\n}\n\n \nstatic inline bool is_fat12(const struct msdos_sb_info *sbi)\n{\n\treturn sbi->fat_bits == 12;\n}\n\nstatic inline bool is_fat16(const struct msdos_sb_info *sbi)\n{\n\treturn sbi->fat_bits == 16;\n}\n\nstatic inline bool is_fat32(const struct msdos_sb_info *sbi)\n{\n\treturn sbi->fat_bits == 32;\n}\n\n \nstatic inline u32 max_fat(struct super_block *sb)\n{\n\tstruct msdos_sb_info *sbi = MSDOS_SB(sb);\n\n\treturn is_fat32(sbi) ? MAX_FAT32 :\n\t\tis_fat16(sbi) ? MAX_FAT16 : MAX_FAT12;\n}\n\nstatic inline struct msdos_inode_info *MSDOS_I(struct inode *inode)\n{\n\treturn container_of(inode, struct msdos_inode_info, vfs_inode);\n}\n\n \nstatic inline int fat_mode_can_hold_ro(struct inode *inode)\n{\n\tstruct msdos_sb_info *sbi = MSDOS_SB(inode->i_sb);\n\tumode_t mask;\n\n\tif (S_ISDIR(inode->i_mode)) {\n\t\tif (!sbi->options.rodir)\n\t\t\treturn 0;\n\t\tmask = ~sbi->options.fs_dmask;\n\t} else\n\t\tmask = ~sbi->options.fs_fmask;\n\n\tif (!(mask & S_IWUGO))\n\t\treturn 0;\n\treturn 1;\n}\n\n \nstatic inline umode_t fat_make_mode(struct msdos_sb_info *sbi,\n\t\t\t\t   u8 attrs, umode_t mode)\n{\n\tif (attrs & ATTR_RO && !((attrs & ATTR_DIR) && !sbi->options.rodir))\n\t\tmode &= ~S_IWUGO;\n\n\tif (attrs & ATTR_DIR)\n\t\treturn (mode & ~sbi->options.fs_dmask) | S_IFDIR;\n\telse\n\t\treturn (mode & ~sbi->options.fs_fmask) | S_IFREG;\n}\n\n \nstatic inline u8 fat_make_attrs(struct inode *inode)\n{\n\tu8 attrs = MSDOS_I(inode)->i_attrs;\n\tif (S_ISDIR(inode->i_mode))\n\t\tattrs |= ATTR_DIR;\n\tif (fat_mode_can_hold_ro(inode) && !(inode->i_mode & S_IWUGO))\n\t\tattrs |= ATTR_RO;\n\treturn attrs;\n}\n\nstatic inline void fat_save_attrs(struct inode *inode, u8 attrs)\n{\n\tif (fat_mode_can_hold_ro(inode))\n\t\tMSDOS_I(inode)->i_attrs = attrs & ATTR_UNUSED;\n\telse\n\t\tMSDOS_I(inode)->i_attrs = attrs & (ATTR_UNUSED | ATTR_RO);\n}\n\nstatic inline unsigned char fat_checksum(const __u8 *name)\n{\n\tunsigned char s = name[0];\n\ts = (s<<7) + (s>>1) + name[1];\ts = (s<<7) + (s>>1) + name[2];\n\ts = (s<<7) + (s>>1) + name[3];\ts = (s<<7) + (s>>1) + name[4];\n\ts = (s<<7) + (s>>1) + name[5];\ts = (s<<7) + (s>>1) + name[6];\n\ts = (s<<7) + (s>>1) + name[7];\ts = (s<<7) + (s>>1) + name[8];\n\ts = (s<<7) + (s>>1) + name[9];\ts = (s<<7) + (s>>1) + name[10];\n\treturn s;\n}\n\nstatic inline sector_t fat_clus_to_blknr(struct msdos_sb_info *sbi, int clus)\n{\n\treturn ((sector_t)clus - FAT_START_ENT) * sbi->sec_per_clus\n\t\t+ sbi->data_start;\n}\n\nstatic inline void fat_get_blknr_offset(struct msdos_sb_info *sbi,\n\t\t\t\tloff_t i_pos, sector_t *blknr, int *offset)\n{\n\t*blknr = i_pos >> sbi->dir_per_block_bits;\n\t*offset = i_pos & (sbi->dir_per_block - 1);\n}\n\nstatic inline loff_t fat_i_pos_read(struct msdos_sb_info *sbi,\n\t\t\t\t\tstruct inode *inode)\n{\n\tloff_t i_pos;\n#if BITS_PER_LONG == 32\n\tspin_lock(&sbi->inode_hash_lock);\n#endif\n\ti_pos = MSDOS_I(inode)->i_pos;\n#if BITS_PER_LONG == 32\n\tspin_unlock(&sbi->inode_hash_lock);\n#endif\n\treturn i_pos;\n}\n\nstatic inline void fat16_towchar(wchar_t *dst, const __u8 *src, size_t len)\n{\n#ifdef __BIG_ENDIAN\n\twhile (len--) {\n\t\t*dst++ = src[0] | (src[1] << 8);\n\t\tsrc += 2;\n\t}\n#else\n\tmemcpy(dst, src, len * 2);\n#endif\n}\n\nstatic inline int fat_get_start(const struct msdos_sb_info *sbi,\n\t\t\t\tconst struct msdos_dir_entry *de)\n{\n\tint cluster = le16_to_cpu(de->start);\n\tif (is_fat32(sbi))\n\t\tcluster |= (le16_to_cpu(de->starthi) << 16);\n\treturn cluster;\n}\n\nstatic inline void fat_set_start(struct msdos_dir_entry *de, int cluster)\n{\n\tde->start   = cpu_to_le16(cluster);\n\tde->starthi = cpu_to_le16(cluster >> 16);\n}\n\nstatic inline void fatwchar_to16(__u8 *dst, const wchar_t *src, size_t len)\n{\n#ifdef __BIG_ENDIAN\n\twhile (len--) {\n\t\tdst[0] = *src & 0x00FF;\n\t\tdst[1] = (*src & 0xFF00) >> 8;\n\t\tdst += 2;\n\t\tsrc++;\n\t}\n#else\n\tmemcpy(dst, src, len * 2);\n#endif\n}\n\n \nextern void fat_cache_inval_inode(struct inode *inode);\nextern int fat_get_cluster(struct inode *inode, int cluster,\n\t\t\t   int *fclus, int *dclus);\nextern int fat_get_mapped_cluster(struct inode *inode, sector_t sector,\n\t\t\t\t  sector_t last_block,\n\t\t\t\t  unsigned long *mapped_blocks, sector_t *bmap);\nextern int fat_bmap(struct inode *inode, sector_t sector, sector_t *phys,\n\t\t    unsigned long *mapped_blocks, int create, bool from_bmap);\n\n \nextern const struct file_operations fat_dir_operations;\nextern int fat_search_long(struct inode *inode, const unsigned char *name,\n\t\t\t   int name_len, struct fat_slot_info *sinfo);\nextern int fat_dir_empty(struct inode *dir);\nextern int fat_subdirs(struct inode *dir);\nextern int fat_scan(struct inode *dir, const unsigned char *name,\n\t\t    struct fat_slot_info *sinfo);\nextern int fat_scan_logstart(struct inode *dir, int i_logstart,\n\t\t\t     struct fat_slot_info *sinfo);\nextern int fat_get_dotdot_entry(struct inode *dir, struct buffer_head **bh,\n\t\t\t\tstruct msdos_dir_entry **de);\nextern int fat_alloc_new_dir(struct inode *dir, struct timespec64 *ts);\nextern int fat_add_entries(struct inode *dir, void *slots, int nr_slots,\n\t\t\t   struct fat_slot_info *sinfo);\nextern int fat_remove_entries(struct inode *dir, struct fat_slot_info *sinfo);\n\n \nstruct fat_entry {\n\tint entry;\n\tunion {\n\t\tu8 *ent12_p[2];\n\t\t__le16 *ent16_p;\n\t\t__le32 *ent32_p;\n\t} u;\n\tint nr_bhs;\n\tstruct buffer_head *bhs[2];\n\tstruct inode *fat_inode;\n};\n\nstatic inline void fatent_init(struct fat_entry *fatent)\n{\n\tfatent->nr_bhs = 0;\n\tfatent->entry = 0;\n\tfatent->u.ent32_p = NULL;\n\tfatent->bhs[0] = fatent->bhs[1] = NULL;\n\tfatent->fat_inode = NULL;\n}\n\nstatic inline void fatent_set_entry(struct fat_entry *fatent, int entry)\n{\n\tfatent->entry = entry;\n\tfatent->u.ent32_p = NULL;\n}\n\nstatic inline void fatent_brelse(struct fat_entry *fatent)\n{\n\tint i;\n\tfatent->u.ent32_p = NULL;\n\tfor (i = 0; i < fatent->nr_bhs; i++)\n\t\tbrelse(fatent->bhs[i]);\n\tfatent->nr_bhs = 0;\n\tfatent->bhs[0] = fatent->bhs[1] = NULL;\n\tfatent->fat_inode = NULL;\n}\n\nstatic inline bool fat_valid_entry(struct msdos_sb_info *sbi, int entry)\n{\n\treturn FAT_START_ENT <= entry && entry < sbi->max_cluster;\n}\n\nextern void fat_ent_access_init(struct super_block *sb);\nextern int fat_ent_read(struct inode *inode, struct fat_entry *fatent,\n\t\t\tint entry);\nextern int fat_ent_write(struct inode *inode, struct fat_entry *fatent,\n\t\t\t int new, int wait);\nextern int fat_alloc_clusters(struct inode *inode, int *cluster,\n\t\t\t      int nr_cluster);\nextern int fat_free_clusters(struct inode *inode, int cluster);\nextern int fat_count_free_clusters(struct super_block *sb);\nextern int fat_trim_fs(struct inode *inode, struct fstrim_range *range);\n\n \nextern long fat_generic_ioctl(struct file *filp, unsigned int cmd,\n\t\t\t      unsigned long arg);\nextern const struct file_operations fat_file_operations;\nextern const struct inode_operations fat_file_inode_operations;\nextern int fat_setattr(struct mnt_idmap *idmap, struct dentry *dentry,\n\t\t       struct iattr *attr);\nextern void fat_truncate_blocks(struct inode *inode, loff_t offset);\nextern int fat_getattr(struct mnt_idmap *idmap,\n\t\t       const struct path *path, struct kstat *stat,\n\t\t       u32 request_mask, unsigned int flags);\nextern int fat_file_fsync(struct file *file, loff_t start, loff_t end,\n\t\t\t  int datasync);\n\n \nextern int fat_block_truncate_page(struct inode *inode, loff_t from);\nextern void fat_attach(struct inode *inode, loff_t i_pos);\nextern void fat_detach(struct inode *inode);\nextern struct inode *fat_iget(struct super_block *sb, loff_t i_pos);\nextern struct inode *fat_build_inode(struct super_block *sb,\n\t\t\tstruct msdos_dir_entry *de, loff_t i_pos);\nextern int fat_sync_inode(struct inode *inode);\nextern int fat_fill_super(struct super_block *sb, void *data, int silent,\n\t\t\t  int isvfat, void (*setup)(struct super_block *));\nextern int fat_fill_inode(struct inode *inode, struct msdos_dir_entry *de);\n\nextern int fat_flush_inodes(struct super_block *sb, struct inode *i1,\n\t\t\t    struct inode *i2);\nstatic inline unsigned long fat_dir_hash(int logstart)\n{\n\treturn hash_32(logstart, FAT_HASH_BITS);\n}\nextern int fat_add_cluster(struct inode *inode);\n\n \nextern __printf(3, 4) __cold\nvoid __fat_fs_error(struct super_block *sb, int report, const char *fmt, ...);\n#define fat_fs_error(sb, fmt, args...)\t\t\\\n\t__fat_fs_error(sb, 1, fmt , ## args)\n#define fat_fs_error_ratelimit(sb, fmt, args...) \\\n\t__fat_fs_error(sb, __ratelimit(&MSDOS_SB(sb)->ratelimit), fmt , ## args)\n\n#define FAT_PRINTK_PREFIX \"%sFAT-fs (%s): \"\n#define fat_msg(sb, level, fmt, args...)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tprintk_index_subsys_emit(FAT_PRINTK_PREFIX, level, fmt, ##args);\\\n\t_fat_msg(sb, level, fmt, ##args);\t\t\t\t\\\n} while (0)\n__printf(3, 4) __cold\nvoid _fat_msg(struct super_block *sb, const char *level, const char *fmt, ...);\n#define fat_msg_ratelimit(sb, level, fmt, args...)\t\\\n\tdo {\t\\\n\t\t\tif (__ratelimit(&MSDOS_SB(sb)->ratelimit))\t\\\n\t\t\t\tfat_msg(sb, level, fmt, ## args);\t\\\n\t } while (0)\nextern int fat_clusters_flush(struct super_block *sb);\nextern int fat_chain_add(struct inode *inode, int new_dclus, int nr_cluster);\nextern void fat_time_fat2unix(struct msdos_sb_info *sbi, struct timespec64 *ts,\n\t\t\t      __le16 __time, __le16 __date, u8 time_cs);\nextern void fat_time_unix2fat(struct msdos_sb_info *sbi, struct timespec64 *ts,\n\t\t\t      __le16 *time, __le16 *date, u8 *time_cs);\nextern struct timespec64 fat_truncate_atime(const struct msdos_sb_info *sbi,\n\t\t\t\t\t    const struct timespec64 *ts);\nextern struct timespec64 fat_truncate_mtime(const struct msdos_sb_info *sbi,\n\t\t\t\t\t    const struct timespec64 *ts);\nextern int fat_truncate_time(struct inode *inode, struct timespec64 *now,\n\t\t\t     int flags);\nextern int fat_update_time(struct inode *inode, int flags);\nextern int fat_sync_bhs(struct buffer_head **bhs, int nr_bhs);\n\nint fat_cache_init(void);\nvoid fat_cache_destroy(void);\n\n \nextern const struct export_operations fat_export_ops;\nextern const struct export_operations fat_export_ops_nostale;\n\n \ntypedef unsigned long long\tllu;\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}