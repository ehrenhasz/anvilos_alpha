{
  "module_name": "cfveil.c",
  "hash_id": "54f6a9a2b091863047bd9b710a6d81027b88bd4af7b58ab2b138ee4f3862db44",
  "original_prompt": "Ingested from linux-6.6.14/net/caif/cfveil.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \":%s(): \" fmt, __func__\n\n#include <linux/stddef.h>\n#include <linux/slab.h>\n#include <net/caif/caif_layer.h>\n#include <net/caif/cfsrvl.h>\n#include <net/caif/cfpkt.h>\n\n#define VEI_PAYLOAD  0x00\n#define VEI_CMD_BIT  0x80\n#define VEI_FLOW_OFF 0x81\n#define VEI_FLOW_ON  0x80\n#define VEI_SET_PIN  0x82\n\n#define container_obj(layr) container_of(layr, struct cfsrvl, layer)\n\nstatic int cfvei_receive(struct cflayer *layr, struct cfpkt *pkt);\nstatic int cfvei_transmit(struct cflayer *layr, struct cfpkt *pkt);\n\nstruct cflayer *cfvei_create(u8 channel_id, struct dev_info *dev_info)\n{\n\tstruct cfsrvl *vei = kzalloc(sizeof(struct cfsrvl), GFP_ATOMIC);\n\tif (!vei)\n\t\treturn NULL;\n\tcaif_assert(offsetof(struct cfsrvl, layer) == 0);\n\tcfsrvl_init(vei, channel_id, dev_info, true);\n\tvei->layer.receive = cfvei_receive;\n\tvei->layer.transmit = cfvei_transmit;\n\tsnprintf(vei->layer.name, CAIF_LAYER_NAME_SZ, \"vei%d\", channel_id);\n\treturn &vei->layer;\n}\n\nstatic int cfvei_receive(struct cflayer *layr, struct cfpkt *pkt)\n{\n\tu8 cmd;\n\tint ret;\n\tcaif_assert(layr->up != NULL);\n\tcaif_assert(layr->receive != NULL);\n\tcaif_assert(layr->ctrlcmd != NULL);\n\n\n\tif (cfpkt_extr_head(pkt, &cmd, 1) < 0) {\n\t\tpr_err(\"Packet is erroneous!\\n\");\n\t\tcfpkt_destroy(pkt);\n\t\treturn -EPROTO;\n\t}\n\tswitch (cmd) {\n\tcase VEI_PAYLOAD:\n\t\tret = layr->up->receive(layr->up, pkt);\n\t\treturn ret;\n\tcase VEI_FLOW_OFF:\n\t\tlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_OFF_IND, 0);\n\t\tcfpkt_destroy(pkt);\n\t\treturn 0;\n\tcase VEI_FLOW_ON:\n\t\tlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_ON_IND, 0);\n\t\tcfpkt_destroy(pkt);\n\t\treturn 0;\n\tcase VEI_SET_PIN:\t \n\t\tcfpkt_destroy(pkt);\n\t\treturn 0;\n\tdefault:\t\t \n\t\tpr_warn(\"Unknown VEI control packet %d (0x%x)!\\n\", cmd, cmd);\n\t\tcfpkt_destroy(pkt);\n\t\treturn -EPROTO;\n\t}\n}\n\nstatic int cfvei_transmit(struct cflayer *layr, struct cfpkt *pkt)\n{\n\tu8 tmp = 0;\n\tstruct caif_payload_info *info;\n\tint ret;\n\tstruct cfsrvl *service = container_obj(layr);\n\tif (!cfsrvl_ready(service, &ret))\n\t\tgoto err;\n\tcaif_assert(layr->dn != NULL);\n\tcaif_assert(layr->dn->transmit != NULL);\n\n\tif (cfpkt_add_head(pkt, &tmp, 1) < 0) {\n\t\tpr_err(\"Packet is erroneous!\\n\");\n\t\tret = -EPROTO;\n\t\tgoto err;\n\t}\n\n\t \n\tinfo = cfpkt_info(pkt);\n\tinfo->channel_id = service->layer.id;\n\tinfo->hdr_len = 1;\n\tinfo->dev_info = &service->dev_info;\n\treturn layr->dn->transmit(layr->dn, pkt);\nerr:\n\tcfpkt_destroy(pkt);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}