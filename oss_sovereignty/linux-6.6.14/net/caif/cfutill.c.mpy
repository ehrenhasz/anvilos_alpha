{
  "module_name": "cfutill.c",
  "hash_id": "85dfd06bf530da188bc4bde95bd2042d814a02ceaf786155d066fbe1edec9848",
  "original_prompt": "Ingested from linux-6.6.14/net/caif/cfutill.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \":%s(): \" fmt, __func__\n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/slab.h>\n#include <linux/errno.h>\n#include <net/caif/caif_layer.h>\n#include <net/caif/cfsrvl.h>\n#include <net/caif/cfpkt.h>\n\n#define container_obj(layr) ((struct cfsrvl *) layr)\n#define UTIL_PAYLOAD  0x00\n#define UTIL_CMD_BIT  0x80\n#define UTIL_REMOTE_SHUTDOWN 0x82\n#define UTIL_FLOW_OFF 0x81\n#define UTIL_FLOW_ON  0x80\n\nstatic int cfutill_receive(struct cflayer *layr, struct cfpkt *pkt);\nstatic int cfutill_transmit(struct cflayer *layr, struct cfpkt *pkt);\n\nstruct cflayer *cfutill_create(u8 channel_id, struct dev_info *dev_info)\n{\n\tstruct cfsrvl *util = kzalloc(sizeof(struct cfsrvl), GFP_ATOMIC);\n\tif (!util)\n\t\treturn NULL;\n\tcaif_assert(offsetof(struct cfsrvl, layer) == 0);\n\tcfsrvl_init(util, channel_id, dev_info, true);\n\tutil->layer.receive = cfutill_receive;\n\tutil->layer.transmit = cfutill_transmit;\n\tsnprintf(util->layer.name, CAIF_LAYER_NAME_SZ, \"util1\");\n\treturn &util->layer;\n}\n\nstatic int cfutill_receive(struct cflayer *layr, struct cfpkt *pkt)\n{\n\tu8 cmd = -1;\n\tstruct cfsrvl *service = container_obj(layr);\n\tcaif_assert(layr != NULL);\n\tcaif_assert(layr->up != NULL);\n\tcaif_assert(layr->up->receive != NULL);\n\tcaif_assert(layr->up->ctrlcmd != NULL);\n\tif (cfpkt_extr_head(pkt, &cmd, 1) < 0) {\n\t\tpr_err(\"Packet is erroneous!\\n\");\n\t\tcfpkt_destroy(pkt);\n\t\treturn -EPROTO;\n\t}\n\n\tswitch (cmd) {\n\tcase UTIL_PAYLOAD:\n\t\treturn layr->up->receive(layr->up, pkt);\n\tcase UTIL_FLOW_OFF:\n\t\tlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_OFF_IND, 0);\n\t\tcfpkt_destroy(pkt);\n\t\treturn 0;\n\tcase UTIL_FLOW_ON:\n\t\tlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_ON_IND, 0);\n\t\tcfpkt_destroy(pkt);\n\t\treturn 0;\n\tcase UTIL_REMOTE_SHUTDOWN:\t \n\t\tpr_err(\"REMOTE SHUTDOWN REQUEST RECEIVED\\n\");\n\t\tlayr->ctrlcmd(layr, CAIF_CTRLCMD_REMOTE_SHUTDOWN_IND, 0);\n\t\tservice->open = false;\n\t\tcfpkt_destroy(pkt);\n\t\treturn 0;\n\tdefault:\n\t\tcfpkt_destroy(pkt);\n\t\tpr_warn(\"Unknown service control %d (0x%x)\\n\", cmd, cmd);\n\t\treturn -EPROTO;\n\t}\n}\n\nstatic int cfutill_transmit(struct cflayer *layr, struct cfpkt *pkt)\n{\n\tu8 zero = 0;\n\tstruct caif_payload_info *info;\n\tint ret;\n\tstruct cfsrvl *service = container_obj(layr);\n\tcaif_assert(layr != NULL);\n\tcaif_assert(layr->dn != NULL);\n\tcaif_assert(layr->dn->transmit != NULL);\n\n\tif (!cfsrvl_ready(service, &ret)) {\n\t\tcfpkt_destroy(pkt);\n\t\treturn ret;\n\t}\n\n\tcfpkt_add_head(pkt, &zero, 1);\n\t \n\tinfo = cfpkt_info(pkt);\n\tinfo->channel_id = service->layer.id;\n\t \n\tinfo->hdr_len = 1;\n\tinfo->dev_info = &service->dev_info;\n\treturn layr->dn->transmit(layr->dn, pkt);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}