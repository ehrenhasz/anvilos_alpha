{
  "module_name": "llc_c_ac.c",
  "hash_id": "f8fc917e31011fabb8b22bc4a483b5ef8e6bba75d907f2cdb53753192347c679",
  "original_prompt": "Ingested from linux-6.6.14/net/llc/llc_c_ac.c",
  "human_readable_source": " \n#include <linux/netdevice.h>\n#include <linux/slab.h>\n#include <net/llc_conn.h>\n#include <net/llc_sap.h>\n#include <net/sock.h>\n#include <net/llc_c_ev.h>\n#include <net/llc_c_ac.h>\n#include <net/llc_c_st.h>\n#include <net/llc_pdu.h>\n#include <net/llc.h>\n\n\nstatic int llc_conn_ac_inc_vs_by_1(struct sock *sk, struct sk_buff *skb);\nstatic void llc_process_tmr_ev(struct sock *sk, struct sk_buff *skb);\nstatic int llc_conn_ac_data_confirm(struct sock *sk, struct sk_buff *ev);\n\nstatic int llc_conn_ac_inc_npta_value(struct sock *sk, struct sk_buff *skb);\n\nstatic int llc_conn_ac_send_rr_rsp_f_set_ackpf(struct sock *sk,\n\t\t\t\t\t       struct sk_buff *skb);\n\nstatic int llc_conn_ac_set_p_flag_1(struct sock *sk, struct sk_buff *skb);\n\n#define INCORRECT 0\n\nint llc_conn_ac_clear_remote_busy(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (llc->remote_busy_flag) {\n\t\tu8 nr;\n\t\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\n\t\tllc->remote_busy_flag = 0;\n\t\tdel_timer(&llc->busy_state_timer.timer);\n\t\tnr = LLC_I_GET_NR(pdu);\n\t\tllc_conn_resend_i_pdu_as_cmd(sk, nr, 0);\n\t}\n\treturn 0;\n}\n\nint llc_conn_ac_conn_ind(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\n\tev->ind_prim = LLC_CONN_PRIM;\n\treturn 0;\n}\n\nint llc_conn_ac_conn_confirm(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\n\tev->cfm_prim = LLC_CONN_PRIM;\n\treturn 0;\n}\n\nstatic int llc_conn_ac_data_confirm(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\n\tev->cfm_prim = LLC_DATA_PRIM;\n\treturn 0;\n}\n\nint llc_conn_ac_data_ind(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_conn_rtn_pdu(sk, skb);\n\treturn 0;\n}\n\nint llc_conn_ac_disc_ind(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\tu8 reason = 0;\n\tint rc = 0;\n\n\tif (ev->type == LLC_CONN_EV_TYPE_PDU) {\n\t\tstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\n\n\t\tif (LLC_PDU_IS_RSP(pdu) &&\n\t\t    LLC_PDU_TYPE_IS_U(pdu) &&\n\t\t    LLC_U_PDU_RSP(pdu) == LLC_2_PDU_RSP_DM)\n\t\t\treason = LLC_DISC_REASON_RX_DM_RSP_PDU;\n\t\telse if (LLC_PDU_IS_CMD(pdu) &&\n\t\t\t   LLC_PDU_TYPE_IS_U(pdu) &&\n\t\t\t   LLC_U_PDU_CMD(pdu) == LLC_2_PDU_CMD_DISC)\n\t\t\treason = LLC_DISC_REASON_RX_DISC_CMD_PDU;\n\t} else if (ev->type == LLC_CONN_EV_TYPE_ACK_TMR)\n\t\treason = LLC_DISC_REASON_ACK_TMR_EXP;\n\telse\n\t\trc = -EINVAL;\n\tif (!rc) {\n\t\tev->reason   = reason;\n\t\tev->ind_prim = LLC_DISC_PRIM;\n\t}\n\treturn rc;\n}\n\nint llc_conn_ac_disc_confirm(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\n\tev->reason   = ev->status;\n\tev->cfm_prim = LLC_DISC_PRIM;\n\treturn 0;\n}\n\nint llc_conn_ac_rst_ind(struct sock *sk, struct sk_buff *skb)\n{\n\tu8 reason = 0;\n\tint rc = 1;\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\tstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tswitch (ev->type) {\n\tcase LLC_CONN_EV_TYPE_PDU:\n\t\tif (LLC_PDU_IS_RSP(pdu) &&\n\t\t    LLC_PDU_TYPE_IS_U(pdu) &&\n\t\t    LLC_U_PDU_RSP(pdu) == LLC_2_PDU_RSP_FRMR) {\n\t\t\treason = LLC_RESET_REASON_LOCAL;\n\t\t\trc = 0;\n\t\t} else if (LLC_PDU_IS_CMD(pdu) &&\n\t\t\t   LLC_PDU_TYPE_IS_U(pdu) &&\n\t\t\t   LLC_U_PDU_CMD(pdu) == LLC_2_PDU_CMD_SABME) {\n\t\t\treason = LLC_RESET_REASON_REMOTE;\n\t\t\trc = 0;\n\t\t}\n\t\tbreak;\n\tcase LLC_CONN_EV_TYPE_ACK_TMR:\n\tcase LLC_CONN_EV_TYPE_P_TMR:\n\tcase LLC_CONN_EV_TYPE_REJ_TMR:\n\tcase LLC_CONN_EV_TYPE_BUSY_TMR:\n\t\tif (llc->retry_count > llc->n2) {\n\t\t\treason = LLC_RESET_REASON_LOCAL;\n\t\t\trc = 0;\n\t\t}\n\t\tbreak;\n\t}\n\tif (!rc) {\n\t\tev->reason   = reason;\n\t\tev->ind_prim = LLC_RESET_PRIM;\n\t}\n\treturn rc;\n}\n\nint llc_conn_ac_rst_confirm(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\n\tev->reason   = 0;\n\tev->cfm_prim = LLC_RESET_PRIM;\n\treturn 0;\n}\n\nint llc_conn_ac_clear_remote_busy_if_f_eq_1(struct sock *sk,\n\t\t\t\t\t    struct sk_buff *skb)\n{\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\n\tif (LLC_PDU_IS_RSP(pdu) &&\n\t    LLC_PDU_TYPE_IS_I(pdu) &&\n\t    LLC_I_PF_IS_1(pdu) && llc_sk(sk)->ack_pf)\n\t\tllc_conn_ac_clear_remote_busy(sk, skb);\n\treturn 0;\n}\n\nint llc_conn_ac_stop_rej_tmr_if_data_flag_eq_2(struct sock *sk,\n\t\t\t\t\t       struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (llc->data_flag == 2)\n\t\tdel_timer(&llc->rej_sent_timer.timer);\n\treturn 0;\n}\n\nint llc_conn_ac_send_disc_cmd_p_set_x(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\t\tllc_pdu_init_as_disc_cmd(nskb, 1);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t\tllc_conn_ac_set_p_flag_1(sk, skb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_dm_rsp_f_set_p(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\t\tu8 f_bit;\n\n\t\tllc_pdu_decode_pf_bit(skb, &f_bit);\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_dm_rsp(nskb, f_bit);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_dm_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_dm_rsp(nskb, 1);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_frmr_rsp_f_set_x(struct sock *sk, struct sk_buff *skb)\n{\n\tu8 f_bit;\n\tint rc = -ENOBUFS;\n\tstruct sk_buff *nskb;\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tllc->rx_pdu_hdr = *((u32 *)pdu);\n\tif (LLC_PDU_IS_CMD(pdu))\n\t\tllc_pdu_decode_pf_bit(skb, &f_bit);\n\telse\n\t\tf_bit = 0;\n\tnskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U,\n\t\t\t       sizeof(struct llc_frmr_info));\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_frmr_rsp(nskb, pdu, f_bit, llc->vS,\n\t\t\t\t\t llc->vR, INCORRECT);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_resend_frmr_rsp_f_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U,\n\t\t\t\t\t       sizeof(struct llc_frmr_info));\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\t\tstruct llc_pdu_sn *pdu = (struct llc_pdu_sn *)&llc->rx_pdu_hdr;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_frmr_rsp(nskb, pdu, 0, llc->vS,\n\t\t\t\t\t llc->vR, INCORRECT);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_resend_frmr_rsp_f_set_p(struct sock *sk, struct sk_buff *skb)\n{\n\tu8 f_bit;\n\tint rc = -ENOBUFS;\n\tstruct sk_buff *nskb;\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tllc_pdu_decode_pf_bit(skb, &f_bit);\n\tnskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U,\n\t\t\t       sizeof(struct llc_frmr_info));\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\t\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_frmr_rsp(nskb, pdu, f_bit, llc->vS,\n\t\t\t\t\t llc->vR, INCORRECT);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_i_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct llc_sap *sap = llc->sap;\n\n\tllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\n\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\tllc_pdu_init_as_i_cmd(skb, 1, llc->vS, llc->vR);\n\trc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\n\tif (likely(!rc)) {\n\t\tskb_get(skb);\n\t\tllc_conn_send_pdu(sk, skb);\n\t\tllc_conn_ac_inc_vs_by_1(sk, skb);\n\t}\n\treturn rc;\n}\n\nstatic int llc_conn_ac_send_i_cmd_p_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct llc_sap *sap = llc->sap;\n\n\tllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\n\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\tllc_pdu_init_as_i_cmd(skb, 0, llc->vS, llc->vR);\n\trc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\n\tif (likely(!rc)) {\n\t\tskb_get(skb);\n\t\tllc_conn_send_pdu(sk, skb);\n\t\tllc_conn_ac_inc_vs_by_1(sk, skb);\n\t}\n\treturn rc;\n}\n\nint llc_conn_ac_send_i_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct llc_sap *sap = llc->sap;\n\n\tllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\n\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\tllc_pdu_init_as_i_cmd(skb, 0, llc->vS, llc->vR);\n\trc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\n\tif (likely(!rc)) {\n\t\tskb_get(skb);\n\t\tllc_conn_send_pdu(sk, skb);\n\t\tllc_conn_ac_inc_vs_by_1(sk, skb);\n\t}\n\treturn 0;\n}\n\nint llc_conn_ac_resend_i_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\tu8 nr = LLC_I_GET_NR(pdu);\n\n\tllc_conn_resend_i_pdu_as_cmd(sk, nr, 0);\n\treturn 0;\n}\n\nint llc_conn_ac_resend_i_xxx_x_set_0_or_send_rr(struct sock *sk,\n\t\t\t\t\t\tstruct sk_buff *skb)\n{\n\tu8 nr;\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rr_rsp(nskb, 0, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (likely(!rc))\n\t\t\tllc_conn_send_pdu(sk, nskb);\n\t\telse\n\t\t\tkfree_skb(skb);\n\t}\n\tif (rc) {\n\t\tnr = LLC_I_GET_NR(pdu);\n\t\trc = 0;\n\t\tllc_conn_resend_i_pdu_as_cmd(sk, nr, 0);\n\t}\n\treturn rc;\n}\n\nint llc_conn_ac_resend_i_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\tu8 nr = LLC_I_GET_NR(pdu);\n\n\tllc_conn_resend_i_pdu_as_rsp(sk, nr, 1);\n\treturn 0;\n}\n\nint llc_conn_ac_send_rej_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\t\tllc_pdu_init_as_rej_cmd(nskb, 1, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rej_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rej_rsp(nskb, 1, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rej_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rej_rsp(nskb, 0, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rnr_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\t\tllc_pdu_init_as_rnr_cmd(nskb, 1, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rnr_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rnr_rsp(nskb, 1, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rnr_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rnr_rsp(nskb, 0, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_set_remote_busy(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (!llc->remote_busy_flag) {\n\t\tllc->remote_busy_flag = 1;\n\t\tmod_timer(&llc->busy_state_timer.timer,\n\t\t\t jiffies + llc->busy_state_timer.expire);\n\t}\n\treturn 0;\n}\n\nint llc_conn_ac_opt_send_rnr_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rnr_rsp(nskb, 0, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rr_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\t\tllc_pdu_init_as_rr_cmd(nskb, 1, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rr_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\t\tu8 f_bit = 1;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rr_rsp(nskb, f_bit, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_ack_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rr_rsp(nskb, 1, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_rr_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rr_rsp(nskb, 0, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_ack_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rr_rsp(nskb, 0, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nvoid llc_conn_set_p_flag(struct sock *sk, u8 value)\n{\n\tint state_changed = llc_sk(sk)->p_flag && !value;\n\n\tllc_sk(sk)->p_flag = value;\n\n\tif (state_changed)\n\t\tsk->sk_state_change(sk);\n}\n\nint llc_conn_ac_send_sabme_cmd_p_set_x(struct sock *sk, struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\t\tconst u8 *dmac = llc->daddr.mac;\n\n\t\tif (llc->dev->flags & IFF_LOOPBACK)\n\t\t\tdmac = llc->dev->dev_addr;\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_CMD);\n\t\tllc_pdu_init_as_sabme_cmd(nskb, 1);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, dmac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t\tllc_conn_set_p_flag(sk, 1);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_send_ua_rsp_f_set_p(struct sock *sk, struct sk_buff *skb)\n{\n\tu8 f_bit;\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\n\n\tllc_pdu_decode_pf_bit(skb, &f_bit);\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tnskb->dev = llc->dev;\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_ua_rsp(nskb, f_bit);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\nint llc_conn_ac_set_s_flag_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->s_flag = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_set_s_flag_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->s_flag = 1;\n\treturn 0;\n}\n\nint llc_conn_ac_start_p_timer(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tllc_conn_set_p_flag(sk, 1);\n\tmod_timer(&llc->pf_cycle_timer.timer,\n\t\t  jiffies + llc->pf_cycle_timer.expire);\n\treturn 0;\n}\n\n \nint llc_conn_ac_send_ack_if_needed(struct sock *sk, struct sk_buff *skb)\n{\n\tu8 pf_bit;\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tllc_pdu_decode_pf_bit(skb, &pf_bit);\n\tllc->ack_pf |= pf_bit & 1;\n\tif (!llc->ack_must_be_send) {\n\t\tllc->first_pdu_Ns = llc->vR;\n\t\tllc->ack_must_be_send = 1;\n\t\tllc->ack_pf = pf_bit & 1;\n\t}\n\tif (((llc->vR - llc->first_pdu_Ns + 1 + LLC_2_SEQ_NBR_MODULO)\n\t\t\t% LLC_2_SEQ_NBR_MODULO) >= llc->npta) {\n\t\tllc_conn_ac_send_rr_rsp_f_set_ackpf(sk, skb);\n\t\tllc->ack_must_be_send\t= 0;\n\t\tllc->ack_pf\t\t= 0;\n\t\tllc_conn_ac_inc_npta_value(sk, skb);\n\t}\n\treturn 0;\n}\n\n \nint llc_conn_ac_rst_sendack_flag(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->ack_must_be_send = llc_sk(sk)->ack_pf = 0;\n\treturn 0;\n}\n\n \nstatic int llc_conn_ac_send_i_rsp_f_set_ackpf(struct sock *sk,\n\t\t\t\t\t      struct sk_buff *skb)\n{\n\tint rc;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct llc_sap *sap = llc->sap;\n\n\tllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\n\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\tllc_pdu_init_as_i_cmd(skb, llc->ack_pf, llc->vS, llc->vR);\n\trc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\n\tif (likely(!rc)) {\n\t\tskb_get(skb);\n\t\tllc_conn_send_pdu(sk, skb);\n\t\tllc_conn_ac_inc_vs_by_1(sk, skb);\n\t}\n\treturn rc;\n}\n\n \nint llc_conn_ac_send_i_as_ack(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\tint ret;\n\n\tif (llc->ack_must_be_send) {\n\t\tret = llc_conn_ac_send_i_rsp_f_set_ackpf(sk, skb);\n\t\tllc->ack_must_be_send = 0 ;\n\t\tllc->ack_pf = 0;\n\t} else {\n\t\tret = llc_conn_ac_send_i_cmd_p_set_0(sk, skb);\n\t}\n\n\treturn ret;\n}\n\n \nstatic int llc_conn_ac_send_rr_rsp_f_set_ackpf(struct sock *sk,\n\t\t\t\t\t       struct sk_buff *skb)\n{\n\tint rc = -ENOBUFS;\n\tstruct llc_sock *llc = llc_sk(sk);\n\tstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\n\n\tif (nskb) {\n\t\tstruct llc_sap *sap = llc->sap;\n\n\t\tllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\n\t\t\t\t    llc->daddr.lsap, LLC_PDU_RSP);\n\t\tllc_pdu_init_as_rr_rsp(nskb, llc->ack_pf, llc->vR);\n\t\trc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\n\t\tif (unlikely(rc))\n\t\t\tgoto free;\n\t\tllc_conn_send_pdu(sk, nskb);\n\t}\nout:\n\treturn rc;\nfree:\n\tkfree_skb(nskb);\n\tgoto out;\n}\n\n \nstatic int llc_conn_ac_inc_npta_value(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (!llc->inc_cntr) {\n\t\tllc->dec_step = 0;\n\t\tllc->dec_cntr = llc->inc_cntr = 2;\n\t\t++llc->npta;\n\t\tif (llc->npta > (u8) ~LLC_2_SEQ_NBR_MODULO)\n\t\t\tllc->npta = (u8) ~LLC_2_SEQ_NBR_MODULO;\n\t} else\n\t\t--llc->inc_cntr;\n\treturn 0;\n}\n\n \nint llc_conn_ac_adjust_npta_by_rr(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (!llc->connect_step && !llc->remote_busy_flag) {\n\t\tif (!llc->dec_step) {\n\t\t\tif (!llc->dec_cntr) {\n\t\t\t\tllc->inc_cntr = llc->dec_cntr = 2;\n\t\t\t\tif (llc->npta > 0)\n\t\t\t\t\tllc->npta = llc->npta - 1;\n\t\t\t} else\n\t\t\t\tllc->dec_cntr -=1;\n\t\t}\n\t} else\n\t\tllc->connect_step = 0 ;\n\treturn 0;\n}\n\n \nint llc_conn_ac_adjust_npta_by_rnr(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (llc->remote_busy_flag)\n\t\tif (!llc->dec_step) {\n\t\t\tif (!llc->dec_cntr) {\n\t\t\t\tllc->inc_cntr = llc->dec_cntr = 2;\n\t\t\t\tif (llc->npta > 0)\n\t\t\t\t\t--llc->npta;\n\t\t\t} else\n\t\t\t\t--llc->dec_cntr;\n\t\t}\n\treturn 0;\n}\n\n \nint llc_conn_ac_dec_tx_win_size(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\tu8 unacked_pdu = skb_queue_len(&llc->pdu_unack_q);\n\n\tif (llc->k - unacked_pdu < 1)\n\t\tllc->k = 1;\n\telse\n\t\tllc->k -= unacked_pdu;\n\treturn 0;\n}\n\n \nint llc_conn_ac_inc_tx_win_size(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tllc->k += 1;\n\tif (llc->k > (u8) ~LLC_2_SEQ_NBR_MODULO)\n\t\tllc->k = (u8) ~LLC_2_SEQ_NBR_MODULO;\n\treturn 0;\n}\n\nint llc_conn_ac_stop_all_timers(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk_stop_all_timers(sk, false);\n\treturn 0;\n}\n\nint llc_conn_ac_stop_other_timers(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tdel_timer(&llc->rej_sent_timer.timer);\n\tdel_timer(&llc->pf_cycle_timer.timer);\n\tdel_timer(&llc->busy_state_timer.timer);\n\tllc->ack_must_be_send = 0;\n\tllc->ack_pf = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_start_ack_timer(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tmod_timer(&llc->ack_timer.timer, jiffies + llc->ack_timer.expire);\n\treturn 0;\n}\n\nint llc_conn_ac_start_rej_timer(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tmod_timer(&llc->rej_sent_timer.timer,\n\t\t  jiffies + llc->rej_sent_timer.expire);\n\treturn 0;\n}\n\nint llc_conn_ac_start_ack_tmr_if_not_running(struct sock *sk,\n\t\t\t\t\t     struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tif (!timer_pending(&llc->ack_timer.timer))\n\t\tmod_timer(&llc->ack_timer.timer,\n\t\t\t  jiffies + llc->ack_timer.expire);\n\treturn 0;\n}\n\nint llc_conn_ac_stop_ack_timer(struct sock *sk, struct sk_buff *skb)\n{\n\tdel_timer(&llc_sk(sk)->ack_timer.timer);\n\treturn 0;\n}\n\nint llc_conn_ac_stop_p_timer(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tdel_timer(&llc->pf_cycle_timer.timer);\n\tllc_conn_set_p_flag(sk, 0);\n\treturn 0;\n}\n\nint llc_conn_ac_stop_rej_timer(struct sock *sk, struct sk_buff *skb)\n{\n\tdel_timer(&llc_sk(sk)->rej_sent_timer.timer);\n\treturn 0;\n}\n\nint llc_conn_ac_upd_nr_received(struct sock *sk, struct sk_buff *skb)\n{\n\tint acked;\n\tu16 unacked = 0;\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\tstruct llc_sock *llc = llc_sk(sk);\n\n\tllc->last_nr = PDU_SUPV_GET_Nr(pdu);\n\tacked = llc_conn_remove_acked_pdus(sk, llc->last_nr, &unacked);\n\t \n\tif (acked > 0 || (llc->dev->flags & IFF_LOOPBACK)) {\n\t\tllc->retry_count = 0;\n\t\tdel_timer(&llc->ack_timer.timer);\n\t\tif (llc->failed_data_req) {\n\t\t\t \n\t\t\tllc->failed_data_req = 0;\n\t\t\tllc_conn_ac_data_confirm(sk, skb);\n\t\t}\n\t\tif (unacked)\n\t\t\tmod_timer(&llc->ack_timer.timer,\n\t\t\t\t  jiffies + llc->ack_timer.expire);\n\t} else if (llc->failed_data_req) {\n\t\tu8 f_bit;\n\n\t\tllc_pdu_decode_pf_bit(skb, &f_bit);\n\t\tif (f_bit == 1) {\n\t\t\tllc->failed_data_req = 0;\n\t\t\tllc_conn_ac_data_confirm(sk, skb);\n\t\t}\n\t}\n\treturn 0;\n}\n\nint llc_conn_ac_upd_p_flag(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\n\tif (LLC_PDU_IS_RSP(pdu)) {\n\t\tu8 f_bit;\n\n\t\tllc_pdu_decode_pf_bit(skb, &f_bit);\n\t\tif (f_bit) {\n\t\t\tllc_conn_set_p_flag(sk, 0);\n\t\t\tllc_conn_ac_stop_p_timer(sk, skb);\n\t\t}\n\t}\n\treturn 0;\n}\n\nint llc_conn_ac_set_data_flag_2(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->data_flag = 2;\n\treturn 0;\n}\n\nint llc_conn_ac_set_data_flag_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->data_flag = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_set_data_flag_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->data_flag = 1;\n\treturn 0;\n}\n\nint llc_conn_ac_set_data_flag_1_if_data_flag_eq_0(struct sock *sk,\n\t\t\t\t\t\t  struct sk_buff *skb)\n{\n\tif (!llc_sk(sk)->data_flag)\n\t\tllc_sk(sk)->data_flag = 1;\n\treturn 0;\n}\n\nint llc_conn_ac_set_p_flag_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_conn_set_p_flag(sk, 0);\n\treturn 0;\n}\n\nstatic int llc_conn_ac_set_p_flag_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_conn_set_p_flag(sk, 1);\n\treturn 0;\n}\n\nint llc_conn_ac_set_remote_busy_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->remote_busy_flag = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_set_cause_flag_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->cause_flag = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_set_cause_flag_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->cause_flag = 1;\n\treturn 0;\n}\n\nint llc_conn_ac_set_retry_cnt_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->retry_count = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_inc_retry_cnt_by_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->retry_count++;\n\treturn 0;\n}\n\nint llc_conn_ac_set_vr_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->vR = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_inc_vr_by_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->vR = PDU_GET_NEXT_Vr(llc_sk(sk)->vR);\n\treturn 0;\n}\n\nint llc_conn_ac_set_vs_0(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->vS = 0;\n\treturn 0;\n}\n\nint llc_conn_ac_set_vs_nr(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->vS = llc_sk(sk)->last_nr;\n\treturn 0;\n}\n\nstatic int llc_conn_ac_inc_vs_by_1(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->vS = (llc_sk(sk)->vS + 1) % LLC_2_SEQ_NBR_MODULO;\n\treturn 0;\n}\n\nstatic void llc_conn_tmr_common_cb(struct sock *sk, u8 type)\n{\n\tstruct sk_buff *skb = alloc_skb(0, GFP_ATOMIC);\n\n\tbh_lock_sock(sk);\n\tif (skb) {\n\t\tstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\n\n\t\tskb_set_owner_r(skb, sk);\n\t\tev->type = type;\n\t\tllc_process_tmr_ev(sk, skb);\n\t}\n\tbh_unlock_sock(sk);\n}\n\nvoid llc_conn_pf_cycle_tmr_cb(struct timer_list *t)\n{\n\tstruct llc_sock *llc = from_timer(llc, t, pf_cycle_timer.timer);\n\n\tllc_conn_tmr_common_cb(&llc->sk, LLC_CONN_EV_TYPE_P_TMR);\n}\n\nvoid llc_conn_busy_tmr_cb(struct timer_list *t)\n{\n\tstruct llc_sock *llc = from_timer(llc, t, busy_state_timer.timer);\n\n\tllc_conn_tmr_common_cb(&llc->sk, LLC_CONN_EV_TYPE_BUSY_TMR);\n}\n\nvoid llc_conn_ack_tmr_cb(struct timer_list *t)\n{\n\tstruct llc_sock *llc = from_timer(llc, t, ack_timer.timer);\n\n\tllc_conn_tmr_common_cb(&llc->sk, LLC_CONN_EV_TYPE_ACK_TMR);\n}\n\nvoid llc_conn_rej_tmr_cb(struct timer_list *t)\n{\n\tstruct llc_sock *llc = from_timer(llc, t, rej_sent_timer.timer);\n\n\tllc_conn_tmr_common_cb(&llc->sk, LLC_CONN_EV_TYPE_REJ_TMR);\n}\n\nint llc_conn_ac_rst_vs(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk(sk)->X = llc_sk(sk)->vS;\n\tllc_conn_ac_set_vs_nr(sk, skb);\n\treturn 0;\n}\n\nint llc_conn_ac_upd_vs(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\n\tu8 nr = PDU_SUPV_GET_Nr(pdu);\n\n\tif (llc_circular_between(llc_sk(sk)->vS, nr, llc_sk(sk)->X))\n\t\tllc_conn_ac_set_vs_nr(sk, skb);\n\treturn 0;\n}\n\n \n \nint llc_conn_disc(struct sock *sk, struct sk_buff *skb)\n{\n\t \n\treturn 0;\n}\n\n \nint llc_conn_reset(struct sock *sk, struct sk_buff *skb)\n{\n\tllc_sk_reset(sk);\n\treturn 0;\n}\n\n \nu8 llc_circular_between(u8 a, u8 b, u8 c)\n{\n\tb = b - a;\n\tc = c - a;\n\treturn b <= c;\n}\n\n \nstatic void llc_process_tmr_ev(struct sock *sk, struct sk_buff *skb)\n{\n\tif (llc_sk(sk)->state == LLC_CONN_OUT_OF_SVC) {\n\t\tprintk(KERN_WARNING \"%s: timer called on closed connection\\n\",\n\t\t       __func__);\n\t\tkfree_skb(skb);\n\t} else {\n\t\tif (!sock_owned_by_user(sk))\n\t\t\tllc_conn_state_process(sk, skb);\n\t\telse {\n\t\t\tllc_set_backlog_type(skb, LLC_EVENT);\n\t\t\t__sk_add_backlog(sk, skb);\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}