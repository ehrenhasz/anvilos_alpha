{
  "module_name": "xfrm_interface_bpf.c",
  "hash_id": "b65ce4cb7ebcf553a5fa65cbda4f50349c156cd58748055c91fab169e3938b6b",
  "original_prompt": "Ingested from linux-6.6.14/net/xfrm/xfrm_interface_bpf.c",
  "human_readable_source": "\n \n\n#include <linux/bpf.h>\n#include <linux/btf_ids.h>\n\n#include <net/dst_metadata.h>\n#include <net/xfrm.h>\n\n \nstruct bpf_xfrm_info {\n\tu32 if_id;\n\tint link;\n};\n\n__diag_push();\n__diag_ignore_all(\"-Wmissing-prototypes\",\n\t\t  \"Global functions as their definitions will be in xfrm_interface BTF\");\n\n \n__bpf_kfunc int bpf_skb_get_xfrm_info(struct __sk_buff *skb_ctx, struct bpf_xfrm_info *to)\n{\n\tstruct sk_buff *skb = (struct sk_buff *)skb_ctx;\n\tstruct xfrm_md_info *info;\n\n\tinfo = skb_xfrm_md_info(skb);\n\tif (!info)\n\t\treturn -EINVAL;\n\n\tto->if_id = info->if_id;\n\tto->link = info->link;\n\treturn 0;\n}\n\n \n__bpf_kfunc int bpf_skb_set_xfrm_info(struct __sk_buff *skb_ctx, const struct bpf_xfrm_info *from)\n{\n\tstruct sk_buff *skb = (struct sk_buff *)skb_ctx;\n\tstruct metadata_dst *md_dst;\n\tstruct xfrm_md_info *info;\n\n\tif (unlikely(skb_metadata_dst(skb)))\n\t\treturn -EINVAL;\n\n\tif (!xfrm_bpf_md_dst) {\n\t\tstruct metadata_dst __percpu *tmp;\n\n\t\ttmp = metadata_dst_alloc_percpu(0, METADATA_XFRM, GFP_ATOMIC);\n\t\tif (!tmp)\n\t\t\treturn -ENOMEM;\n\t\tif (cmpxchg(&xfrm_bpf_md_dst, NULL, tmp))\n\t\t\tmetadata_dst_free_percpu(tmp);\n\t}\n\tmd_dst = this_cpu_ptr(xfrm_bpf_md_dst);\n\n\tinfo = &md_dst->u.xfrm_info;\n\n\tinfo->if_id = from->if_id;\n\tinfo->link = from->link;\n\tskb_dst_force(skb);\n\tinfo->dst_orig = skb_dst(skb);\n\n\tdst_hold((struct dst_entry *)md_dst);\n\tskb_dst_set(skb, (struct dst_entry *)md_dst);\n\treturn 0;\n}\n\n__diag_pop()\n\nBTF_SET8_START(xfrm_ifc_kfunc_set)\nBTF_ID_FLAGS(func, bpf_skb_get_xfrm_info)\nBTF_ID_FLAGS(func, bpf_skb_set_xfrm_info)\nBTF_SET8_END(xfrm_ifc_kfunc_set)\n\nstatic const struct btf_kfunc_id_set xfrm_interface_kfunc_set = {\n\t.owner = THIS_MODULE,\n\t.set   = &xfrm_ifc_kfunc_set,\n};\n\nint __init register_xfrm_interface_bpf(void)\n{\n\treturn register_btf_kfunc_id_set(BPF_PROG_TYPE_SCHED_CLS,\n\t\t\t\t\t &xfrm_interface_kfunc_set);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}