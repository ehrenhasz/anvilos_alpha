{
  "module_name": "xfrm_hash.h",
  "hash_id": "0ac5c52d9d4439abb9ae555e0a45dc78a893fe48a4e934f4db8d332982502edb",
  "original_prompt": "Ingested from linux-6.6.14/net/xfrm/xfrm_hash.h",
  "human_readable_source": " \n#ifndef _XFRM_HASH_H\n#define _XFRM_HASH_H\n\n#include <linux/xfrm.h>\n#include <linux/socket.h>\n#include <linux/jhash.h>\n\nstatic inline unsigned int __xfrm4_addr_hash(const xfrm_address_t *addr)\n{\n\treturn ntohl(addr->a4);\n}\n\nstatic inline unsigned int __xfrm6_addr_hash(const xfrm_address_t *addr)\n{\n\treturn jhash2((__force u32 *)addr->a6, 4, 0);\n}\n\nstatic inline unsigned int __xfrm4_daddr_saddr_hash(const xfrm_address_t *daddr,\n\t\t\t\t\t\t    const xfrm_address_t *saddr)\n{\n\tu32 sum = (__force u32)daddr->a4 + (__force u32)saddr->a4;\n\treturn ntohl((__force __be32)sum);\n}\n\nstatic inline unsigned int __xfrm6_daddr_saddr_hash(const xfrm_address_t *daddr,\n\t\t\t\t\t\t    const xfrm_address_t *saddr)\n{\n\treturn __xfrm6_addr_hash(daddr) ^ __xfrm6_addr_hash(saddr);\n}\n\nstatic inline u32 __bits2mask32(__u8 bits)\n{\n\tu32 mask32 = 0xffffffff;\n\n\tif (bits == 0)\n\t\tmask32 = 0;\n\telse if (bits < 32)\n\t\tmask32 <<= (32 - bits);\n\n\treturn mask32;\n}\n\nstatic inline unsigned int __xfrm4_dpref_spref_hash(const xfrm_address_t *daddr,\n\t\t\t\t\t\t    const xfrm_address_t *saddr,\n\t\t\t\t\t\t    __u8 dbits,\n\t\t\t\t\t\t    __u8 sbits)\n{\n\treturn jhash_2words(ntohl(daddr->a4) & __bits2mask32(dbits),\n\t\t\t    ntohl(saddr->a4) & __bits2mask32(sbits),\n\t\t\t    0);\n}\n\nstatic inline unsigned int __xfrm6_pref_hash(const xfrm_address_t *addr,\n\t\t\t\t\t     __u8 prefixlen)\n{\n\tunsigned int pdw;\n\tunsigned int pbi;\n\tu32 initval = 0;\n\n\tpdw = prefixlen >> 5;      \n\tpbi = prefixlen &  0x1f;   \n\n\tif (pbi) {\n\t\t__be32 mask;\n\n\t\tmask = htonl((0xffffffff) << (32 - pbi));\n\n\t\tinitval = (__force u32)(addr->a6[pdw] & mask);\n\t}\n\n\treturn jhash2((__force u32 *)addr->a6, pdw, initval);\n}\n\nstatic inline unsigned int __xfrm6_dpref_spref_hash(const xfrm_address_t *daddr,\n\t\t\t\t\t\t    const xfrm_address_t *saddr,\n\t\t\t\t\t\t    __u8 dbits,\n\t\t\t\t\t\t    __u8 sbits)\n{\n\treturn __xfrm6_pref_hash(daddr, dbits) ^\n\t       __xfrm6_pref_hash(saddr, sbits);\n}\n\nstatic inline unsigned int __xfrm_dst_hash(const xfrm_address_t *daddr,\n\t\t\t\t\t   const xfrm_address_t *saddr,\n\t\t\t\t\t   u32 reqid, unsigned short family,\n\t\t\t\t\t   unsigned int hmask)\n{\n\tunsigned int h = family ^ reqid;\n\tswitch (family) {\n\tcase AF_INET:\n\t\th ^= __xfrm4_daddr_saddr_hash(daddr, saddr);\n\t\tbreak;\n\tcase AF_INET6:\n\t\th ^= __xfrm6_daddr_saddr_hash(daddr, saddr);\n\t\tbreak;\n\t}\n\treturn (h ^ (h >> 16)) & hmask;\n}\n\nstatic inline unsigned int __xfrm_src_hash(const xfrm_address_t *daddr,\n\t\t\t\t\t   const xfrm_address_t *saddr,\n\t\t\t\t\t   unsigned short family,\n\t\t\t\t\t   unsigned int hmask)\n{\n\tunsigned int h = family;\n\tswitch (family) {\n\tcase AF_INET:\n\t\th ^= __xfrm4_daddr_saddr_hash(daddr, saddr);\n\t\tbreak;\n\tcase AF_INET6:\n\t\th ^= __xfrm6_daddr_saddr_hash(daddr, saddr);\n\t\tbreak;\n\t}\n\treturn (h ^ (h >> 16)) & hmask;\n}\n\nstatic inline unsigned int\n__xfrm_spi_hash(const xfrm_address_t *daddr, __be32 spi, u8 proto,\n\t\tunsigned short family, unsigned int hmask)\n{\n\tunsigned int h = (__force u32)spi ^ proto;\n\tswitch (family) {\n\tcase AF_INET:\n\t\th ^= __xfrm4_addr_hash(daddr);\n\t\tbreak;\n\tcase AF_INET6:\n\t\th ^= __xfrm6_addr_hash(daddr);\n\t\tbreak;\n\t}\n\treturn (h ^ (h >> 10) ^ (h >> 20)) & hmask;\n}\n\nstatic inline unsigned int\n__xfrm_seq_hash(u32 seq, unsigned int hmask)\n{\n\tunsigned int h = seq;\n\treturn (h ^ (h >> 10) ^ (h >> 20)) & hmask;\n}\n\nstatic inline unsigned int __idx_hash(u32 index, unsigned int hmask)\n{\n\treturn (index ^ (index >> 8)) & hmask;\n}\n\nstatic inline unsigned int __sel_hash(const struct xfrm_selector *sel,\n\t\t\t\t      unsigned short family, unsigned int hmask,\n\t\t\t\t      u8 dbits, u8 sbits)\n{\n\tconst xfrm_address_t *daddr = &sel->daddr;\n\tconst xfrm_address_t *saddr = &sel->saddr;\n\tunsigned int h = 0;\n\n\tswitch (family) {\n\tcase AF_INET:\n\t\tif (sel->prefixlen_d < dbits ||\n\t\t    sel->prefixlen_s < sbits)\n\t\t\treturn hmask + 1;\n\n\t\th = __xfrm4_dpref_spref_hash(daddr, saddr, dbits, sbits);\n\t\tbreak;\n\n\tcase AF_INET6:\n\t\tif (sel->prefixlen_d < dbits ||\n\t\t    sel->prefixlen_s < sbits)\n\t\t\treturn hmask + 1;\n\n\t\th = __xfrm6_dpref_spref_hash(daddr, saddr, dbits, sbits);\n\t\tbreak;\n\t}\n\th ^= (h >> 16);\n\treturn h & hmask;\n}\n\nstatic inline unsigned int __addr_hash(const xfrm_address_t *daddr,\n\t\t\t\t       const xfrm_address_t *saddr,\n\t\t\t\t       unsigned short family,\n\t\t\t\t       unsigned int hmask,\n\t\t\t\t       u8 dbits, u8 sbits)\n{\n\tunsigned int h = 0;\n\n\tswitch (family) {\n\tcase AF_INET:\n\t\th = __xfrm4_dpref_spref_hash(daddr, saddr, dbits, sbits);\n\t\tbreak;\n\n\tcase AF_INET6:\n\t\th = __xfrm6_dpref_spref_hash(daddr, saddr, dbits, sbits);\n\t\tbreak;\n\t}\n\th ^= (h >> 16);\n\treturn h & hmask;\n}\n\nstruct hlist_head *xfrm_hash_alloc(unsigned int sz);\nvoid xfrm_hash_free(struct hlist_head *n, unsigned int sz);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}