{
  "module_name": "ndisc.c",
  "hash_id": "2f68e1e34ba5e28f572dcc4fc9adaf5e4a1bd704191fba4cc6c3d850e56e1f88",
  "original_prompt": "Ingested from linux-6.6.14/net/6lowpan/ndisc.c",
  "human_readable_source": "\n \n\n#include <net/6lowpan.h>\n#include <net/addrconf.h>\n#include <net/ndisc.h>\n\n#include \"6lowpan_i.h\"\n\nstatic int lowpan_ndisc_is_useropt(u8 nd_opt_type)\n{\n\treturn nd_opt_type == ND_OPT_6CO;\n}\n\n#if IS_ENABLED(CONFIG_IEEE802154_6LOWPAN)\n#define NDISC_802154_SHORT_ADDR_LENGTH\t1\nstatic int lowpan_ndisc_parse_802154_options(const struct net_device *dev,\n\t\t\t\t\t     struct nd_opt_hdr *nd_opt,\n\t\t\t\t\t     struct ndisc_options *ndopts)\n{\n\tswitch (nd_opt->nd_opt_len) {\n\tcase NDISC_802154_SHORT_ADDR_LENGTH:\n\t\tif (ndopts->nd_802154_opt_array[nd_opt->nd_opt_type])\n\t\t\tND_PRINTK(2, warn,\n\t\t\t\t  \"%s: duplicated short addr ND6 option found: type=%d\\n\",\n\t\t\t\t  __func__, nd_opt->nd_opt_type);\n\t\telse\n\t\t\tndopts->nd_802154_opt_array[nd_opt->nd_opt_type] = nd_opt;\n\t\treturn 1;\n\tdefault:\n\t\t \n\t\treturn 0;\n\t}\n}\n\nstatic int lowpan_ndisc_parse_options(const struct net_device *dev,\n\t\t\t\t      struct nd_opt_hdr *nd_opt,\n\t\t\t\t      struct ndisc_options *ndopts)\n{\n\tif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\n\t\treturn 0;\n\n\tswitch (nd_opt->nd_opt_type) {\n\tcase ND_OPT_SOURCE_LL_ADDR:\n\tcase ND_OPT_TARGET_LL_ADDR:\n\t\treturn lowpan_ndisc_parse_802154_options(dev, nd_opt, ndopts);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic void lowpan_ndisc_802154_update(struct neighbour *n, u32 flags,\n\t\t\t\t       u8 icmp6_type,\n\t\t\t\t       const struct ndisc_options *ndopts)\n{\n\tstruct lowpan_802154_neigh *neigh = lowpan_802154_neigh(neighbour_priv(n));\n\tu8 *lladdr_short = NULL;\n\n\tswitch (icmp6_type) {\n\tcase NDISC_ROUTER_SOLICITATION:\n\tcase NDISC_ROUTER_ADVERTISEMENT:\n\tcase NDISC_NEIGHBOUR_SOLICITATION:\n\t\tif (ndopts->nd_802154_opts_src_lladdr) {\n\t\t\tlladdr_short = __ndisc_opt_addr_data(ndopts->nd_802154_opts_src_lladdr,\n\t\t\t\t\t\t\t     IEEE802154_SHORT_ADDR_LEN, 0);\n\t\t\tif (!lladdr_short) {\n\t\t\t\tND_PRINTK(2, warn,\n\t\t\t\t\t  \"NA: invalid short link-layer address length\\n\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase NDISC_REDIRECT:\n\tcase NDISC_NEIGHBOUR_ADVERTISEMENT:\n\t\tif (ndopts->nd_802154_opts_tgt_lladdr) {\n\t\t\tlladdr_short = __ndisc_opt_addr_data(ndopts->nd_802154_opts_tgt_lladdr,\n\t\t\t\t\t\t\t     IEEE802154_SHORT_ADDR_LEN, 0);\n\t\t\tif (!lladdr_short) {\n\t\t\t\tND_PRINTK(2, warn,\n\t\t\t\t\t  \"NA: invalid short link-layer address length\\n\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\twrite_lock_bh(&n->lock);\n\tif (lladdr_short) {\n\t\tieee802154_be16_to_le16(&neigh->short_addr, lladdr_short);\n\t\tif (!lowpan_802154_is_valid_src_short_addr(neigh->short_addr))\n\t\t\tneigh->short_addr = cpu_to_le16(IEEE802154_ADDR_SHORT_UNSPEC);\n\t}\n\twrite_unlock_bh(&n->lock);\n}\n\nstatic void lowpan_ndisc_update(const struct net_device *dev,\n\t\t\t\tstruct neighbour *n, u32 flags, u8 icmp6_type,\n\t\t\t\tconst struct ndisc_options *ndopts)\n{\n\tif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\n\t\treturn;\n\n\t \n\tif (flags & NEIGH_UPDATE_F_OVERRIDE)\n\t\tlowpan_ndisc_802154_update(n, flags, icmp6_type, ndopts);\n}\n\nstatic int lowpan_ndisc_opt_addr_space(const struct net_device *dev,\n\t\t\t\t       u8 icmp6_type, struct neighbour *neigh,\n\t\t\t\t       u8 *ha_buf, u8 **ha)\n{\n\tstruct lowpan_802154_neigh *n;\n\tstruct wpan_dev *wpan_dev;\n\tint addr_space = 0;\n\n\tif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\n\t\treturn 0;\n\n\tswitch (icmp6_type) {\n\tcase NDISC_REDIRECT:\n\t\tn = lowpan_802154_neigh(neighbour_priv(neigh));\n\n\t\tread_lock_bh(&neigh->lock);\n\t\tif (lowpan_802154_is_valid_src_short_addr(n->short_addr)) {\n\t\t\tmemcpy(ha_buf, &n->short_addr,\n\t\t\t       IEEE802154_SHORT_ADDR_LEN);\n\t\t\tread_unlock_bh(&neigh->lock);\n\t\t\taddr_space += __ndisc_opt_addr_space(IEEE802154_SHORT_ADDR_LEN, 0);\n\t\t\t*ha = ha_buf;\n\t\t} else {\n\t\t\tread_unlock_bh(&neigh->lock);\n\t\t}\n\t\tbreak;\n\tcase NDISC_NEIGHBOUR_ADVERTISEMENT:\n\tcase NDISC_NEIGHBOUR_SOLICITATION:\n\tcase NDISC_ROUTER_SOLICITATION:\n\t\twpan_dev = lowpan_802154_dev(dev)->wdev->ieee802154_ptr;\n\n\t\tif (lowpan_802154_is_valid_src_short_addr(wpan_dev->short_addr))\n\t\t\taddr_space = __ndisc_opt_addr_space(IEEE802154_SHORT_ADDR_LEN, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn addr_space;\n}\n\nstatic void lowpan_ndisc_fill_addr_option(const struct net_device *dev,\n\t\t\t\t\t  struct sk_buff *skb, u8 icmp6_type,\n\t\t\t\t\t  const u8 *ha)\n{\n\tstruct wpan_dev *wpan_dev;\n\t__be16 short_addr;\n\tu8 opt_type;\n\n\tif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\n\t\treturn;\n\n\tswitch (icmp6_type) {\n\tcase NDISC_REDIRECT:\n\t\tif (ha) {\n\t\t\tieee802154_le16_to_be16(&short_addr, ha);\n\t\t\t__ndisc_fill_addr_option(skb, ND_OPT_TARGET_LL_ADDR,\n\t\t\t\t\t\t &short_addr,\n\t\t\t\t\t\t IEEE802154_SHORT_ADDR_LEN, 0);\n\t\t}\n\t\treturn;\n\tcase NDISC_NEIGHBOUR_ADVERTISEMENT:\n\t\topt_type = ND_OPT_TARGET_LL_ADDR;\n\t\tbreak;\n\tcase NDISC_ROUTER_SOLICITATION:\n\tcase NDISC_NEIGHBOUR_SOLICITATION:\n\t\topt_type = ND_OPT_SOURCE_LL_ADDR;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\twpan_dev = lowpan_802154_dev(dev)->wdev->ieee802154_ptr;\n\n\tif (lowpan_802154_is_valid_src_short_addr(wpan_dev->short_addr)) {\n\t\tieee802154_le16_to_be16(&short_addr,\n\t\t\t\t\t&wpan_dev->short_addr);\n\t\t__ndisc_fill_addr_option(skb, opt_type, &short_addr,\n\t\t\t\t\t IEEE802154_SHORT_ADDR_LEN, 0);\n\t}\n}\n\nstatic void lowpan_ndisc_prefix_rcv_add_addr(struct net *net,\n\t\t\t\t\t     struct net_device *dev,\n\t\t\t\t\t     const struct prefix_info *pinfo,\n\t\t\t\t\t     struct inet6_dev *in6_dev,\n\t\t\t\t\t     struct in6_addr *addr,\n\t\t\t\t\t     int addr_type, u32 addr_flags,\n\t\t\t\t\t     bool sllao, bool tokenized,\n\t\t\t\t\t     __u32 valid_lft,\n\t\t\t\t\t     u32 prefered_lft,\n\t\t\t\t\t     bool dev_addr_generated)\n{\n\tint err;\n\n\t \n\tif (lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154) && dev_addr_generated &&\n\t    !addrconf_ifid_802154_6lowpan(addr->s6_addr + 8, dev)) {\n\t\terr = addrconf_prefix_rcv_add_addr(net, dev, pinfo, in6_dev,\n\t\t\t\t\t\t   addr, addr_type, addr_flags,\n\t\t\t\t\t\t   sllao, tokenized, valid_lft,\n\t\t\t\t\t\t   prefered_lft);\n\t\tif (err)\n\t\t\tND_PRINTK(2, warn,\n\t\t\t\t  \"RA: could not add a short address based address for prefix: %pI6c\\n\",\n\t\t\t\t  &pinfo->prefix);\n\t}\n}\n#endif\n\nconst struct ndisc_ops lowpan_ndisc_ops = {\n\t.is_useropt\t\t= lowpan_ndisc_is_useropt,\n#if IS_ENABLED(CONFIG_IEEE802154_6LOWPAN)\n\t.parse_options\t\t= lowpan_ndisc_parse_options,\n\t.update\t\t\t= lowpan_ndisc_update,\n\t.opt_addr_space\t\t= lowpan_ndisc_opt_addr_space,\n\t.fill_addr_option\t= lowpan_ndisc_fill_addr_option,\n\t.prefix_rcv_add_addr\t= lowpan_ndisc_prefix_rcv_add_addr,\n#endif\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}