{
  "module_name": "sysfs.c",
  "hash_id": "88bfc620061a2ac1e605d085bb8f439ec5aab29e49289e84aac89d5b475e05cd",
  "original_prompt": "Ingested from linux-6.6.14/net/wireless/sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/nl80211.h>\n#include <linux/rtnetlink.h>\n#include <net/cfg80211.h>\n#include \"sysfs.h\"\n#include \"core.h\"\n#include \"rdev-ops.h\"\n\nstatic inline struct cfg80211_registered_device *dev_to_rdev(\n\tstruct device *dev)\n{\n\treturn container_of(dev, struct cfg80211_registered_device, wiphy.dev);\n}\n\n#define SHOW_FMT(name, fmt, member)\t\t\t\t\t\\\nstatic ssize_t name ## _show(struct device *dev,\t\t\t\\\n\t\t\t      struct device_attribute *attr,\t\t\\\n\t\t\t      char *buf)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\treturn sprintf(buf, fmt \"\\n\", dev_to_rdev(dev)->member);\t\\\n}\t\t\t\t\t\t\t\t\t\\\nstatic DEVICE_ATTR_RO(name)\n\nSHOW_FMT(index, \"%d\", wiphy_idx);\nSHOW_FMT(macaddress, \"%pM\", wiphy.perm_addr);\nSHOW_FMT(address_mask, \"%pM\", wiphy.addr_mask);\n\nstatic ssize_t name_show(struct device *dev,\n\t\t\t struct device_attribute *attr,\n\t\t\t char *buf)\n{\n\tstruct wiphy *wiphy = &dev_to_rdev(dev)->wiphy;\n\n\treturn sprintf(buf, \"%s\\n\", wiphy_name(wiphy));\n}\nstatic DEVICE_ATTR_RO(name);\n\nstatic ssize_t addresses_show(struct device *dev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      char *buf)\n{\n\tstruct wiphy *wiphy = &dev_to_rdev(dev)->wiphy;\n\tchar *start = buf;\n\tint i;\n\n\tif (!wiphy->addresses)\n\t\treturn sprintf(buf, \"%pM\\n\", wiphy->perm_addr);\n\n\tfor (i = 0; i < wiphy->n_addresses; i++)\n\t\tbuf += sprintf(buf, \"%pM\\n\", wiphy->addresses[i].addr);\n\n\treturn buf - start;\n}\nstatic DEVICE_ATTR_RO(addresses);\n\nstatic struct attribute *ieee80211_attrs[] = {\n\t&dev_attr_index.attr,\n\t&dev_attr_macaddress.attr,\n\t&dev_attr_address_mask.attr,\n\t&dev_attr_addresses.attr,\n\t&dev_attr_name.attr,\n\tNULL,\n};\nATTRIBUTE_GROUPS(ieee80211);\n\nstatic void wiphy_dev_release(struct device *dev)\n{\n\tstruct cfg80211_registered_device *rdev = dev_to_rdev(dev);\n\n\tcfg80211_dev_free(rdev);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic void cfg80211_leave_all(struct cfg80211_registered_device *rdev)\n{\n\tstruct wireless_dev *wdev;\n\n\tlist_for_each_entry(wdev, &rdev->wiphy.wdev_list, list)\n\t\tcfg80211_leave(rdev, wdev);\n}\n\nstatic int wiphy_suspend(struct device *dev)\n{\n\tstruct cfg80211_registered_device *rdev = dev_to_rdev(dev);\n\tint ret = 0;\n\n\trdev->suspend_at = ktime_get_boottime_seconds();\n\n\trtnl_lock();\n\twiphy_lock(&rdev->wiphy);\n\tif (rdev->wiphy.registered) {\n\t\tif (!rdev->wiphy.wowlan_config) {\n\t\t\tcfg80211_leave_all(rdev);\n\t\t\tcfg80211_process_rdev_events(rdev);\n\t\t}\n\t\tcfg80211_process_wiphy_works(rdev, NULL);\n\t\tif (rdev->ops->suspend)\n\t\t\tret = rdev_suspend(rdev, rdev->wiphy.wowlan_config);\n\t\tif (ret == 1) {\n\t\t\t \n\t\t\tcfg80211_leave_all(rdev);\n\t\t\tcfg80211_process_rdev_events(rdev);\n\t\t\tcfg80211_process_wiphy_works(rdev, NULL);\n\t\t\tret = rdev_suspend(rdev, NULL);\n\t\t}\n\t\tif (ret == 0)\n\t\t\trdev->suspended = true;\n\t}\n\twiphy_unlock(&rdev->wiphy);\n\trtnl_unlock();\n\n\treturn ret;\n}\n\nstatic int wiphy_resume(struct device *dev)\n{\n\tstruct cfg80211_registered_device *rdev = dev_to_rdev(dev);\n\tint ret = 0;\n\n\t \n\tcfg80211_bss_age(rdev, ktime_get_boottime_seconds() - rdev->suspend_at);\n\n\trtnl_lock();\n\twiphy_lock(&rdev->wiphy);\n\tif (rdev->wiphy.registered && rdev->ops->resume)\n\t\tret = rdev_resume(rdev);\n\trdev->suspended = false;\n\tschedule_work(&rdev->wiphy_work);\n\twiphy_unlock(&rdev->wiphy);\n\n\tif (ret)\n\t\tcfg80211_shutdown_all_interfaces(&rdev->wiphy);\n\n\trtnl_unlock();\n\n\treturn ret;\n}\n\nstatic SIMPLE_DEV_PM_OPS(wiphy_pm_ops, wiphy_suspend, wiphy_resume);\n#define WIPHY_PM_OPS (&wiphy_pm_ops)\n#else\n#define WIPHY_PM_OPS NULL\n#endif\n\nstatic const void *wiphy_namespace(const struct device *d)\n{\n\tstruct wiphy *wiphy = container_of(d, struct wiphy, dev);\n\n\treturn wiphy_net(wiphy);\n}\n\nstruct class ieee80211_class = {\n\t.name = \"ieee80211\",\n\t.dev_release = wiphy_dev_release,\n\t.dev_groups = ieee80211_groups,\n\t.pm = WIPHY_PM_OPS,\n\t.ns_type = &net_ns_type_operations,\n\t.namespace = wiphy_namespace,\n};\n\nint wiphy_sysfs_init(void)\n{\n\treturn class_register(&ieee80211_class);\n}\n\nvoid wiphy_sysfs_exit(void)\n{\n\tclass_unregister(&ieee80211_class);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}