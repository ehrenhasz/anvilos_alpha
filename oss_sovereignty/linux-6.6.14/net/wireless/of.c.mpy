{
  "module_name": "of.c",
  "hash_id": "3d8e91fa950aad57c9a6904fbc789d9fb87c0fc0d3c542d3e7c0397e703202d1",
  "original_prompt": "Ingested from linux-6.6.14/net/wireless/of.c",
  "human_readable_source": " \n\n#include <linux/of.h>\n#include <net/cfg80211.h>\n#include \"core.h\"\n\nstatic bool wiphy_freq_limits_valid_chan(struct wiphy *wiphy,\n\t\t\t\t\t struct ieee80211_freq_range *freq_limits,\n\t\t\t\t\t unsigned int n_freq_limits,\n\t\t\t\t\t struct ieee80211_channel *chan)\n{\n\tu32 bw = MHZ_TO_KHZ(20);\n\tint i;\n\n\tfor (i = 0; i < n_freq_limits; i++) {\n\t\tstruct ieee80211_freq_range *limit = &freq_limits[i];\n\n\t\tif (cfg80211_does_bw_fit_range(limit,\n\t\t\t\t\t       MHZ_TO_KHZ(chan->center_freq),\n\t\t\t\t\t       bw))\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic void wiphy_freq_limits_apply(struct wiphy *wiphy,\n\t\t\t\t    struct ieee80211_freq_range *freq_limits,\n\t\t\t\t    unsigned int n_freq_limits)\n{\n\tenum nl80211_band band;\n\tint i;\n\n\tif (WARN_ON(!n_freq_limits))\n\t\treturn;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++) {\n\t\tstruct ieee80211_supported_band *sband = wiphy->bands[band];\n\n\t\tif (!sband)\n\t\t\tcontinue;\n\n\t\tfor (i = 0; i < sband->n_channels; i++) {\n\t\t\tstruct ieee80211_channel *chan = &sband->channels[i];\n\n\t\t\tif (chan->flags & IEEE80211_CHAN_DISABLED)\n\t\t\t\tcontinue;\n\n\t\t\tif (!wiphy_freq_limits_valid_chan(wiphy, freq_limits,\n\t\t\t\t\t\t\t  n_freq_limits,\n\t\t\t\t\t\t\t  chan)) {\n\t\t\t\tpr_debug(\"Disabling freq %d MHz as it's out of OF limits\\n\",\n\t\t\t\t\t chan->center_freq);\n\t\t\t\tchan->flags |= IEEE80211_CHAN_DISABLED;\n\t\t\t}\n\t\t}\n\t}\n}\n\nvoid wiphy_read_of_freq_limits(struct wiphy *wiphy)\n{\n\tstruct device *dev = wiphy_dev(wiphy);\n\tstruct device_node *np;\n\tstruct property *prop;\n\tstruct ieee80211_freq_range *freq_limits;\n\tunsigned int n_freq_limits;\n\tconst __be32 *p;\n\tint len, i;\n\tint err = 0;\n\n\tif (!dev)\n\t\treturn;\n\tnp = dev_of_node(dev);\n\tif (!np)\n\t\treturn;\n\n\tprop = of_find_property(np, \"ieee80211-freq-limit\", &len);\n\tif (!prop)\n\t\treturn;\n\n\tif (!len || len % sizeof(u32) || len / sizeof(u32) % 2) {\n\t\tdev_err(dev, \"ieee80211-freq-limit wrong format\");\n\t\treturn;\n\t}\n\tn_freq_limits = len / sizeof(u32) / 2;\n\n\tfreq_limits = kcalloc(n_freq_limits, sizeof(*freq_limits), GFP_KERNEL);\n\tif (!freq_limits) {\n\t\terr = -ENOMEM;\n\t\tgoto out_kfree;\n\t}\n\n\tp = NULL;\n\tfor (i = 0; i < n_freq_limits; i++) {\n\t\tstruct ieee80211_freq_range *limit = &freq_limits[i];\n\n\t\tp = of_prop_next_u32(prop, p, &limit->start_freq_khz);\n\t\tif (!p) {\n\t\t\terr = -EINVAL;\n\t\t\tgoto out_kfree;\n\t\t}\n\n\t\tp = of_prop_next_u32(prop, p, &limit->end_freq_khz);\n\t\tif (!p) {\n\t\t\terr = -EINVAL;\n\t\t\tgoto out_kfree;\n\t\t}\n\n\t\tif (!limit->start_freq_khz ||\n\t\t    !limit->end_freq_khz ||\n\t\t    limit->start_freq_khz >= limit->end_freq_khz) {\n\t\t\terr = -EINVAL;\n\t\t\tgoto out_kfree;\n\t\t}\n\t}\n\n\twiphy_freq_limits_apply(wiphy, freq_limits, n_freq_limits);\n\nout_kfree:\n\tkfree(freq_limits);\n\tif (err)\n\t\tdev_err(dev, \"Failed to get limits: %d\\n\", err);\n}\nEXPORT_SYMBOL(wiphy_read_of_freq_limits);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}