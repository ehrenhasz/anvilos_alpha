{
  "module_name": "wext-priv.c",
  "hash_id": "7434df09686a1d4abc82c0c9cfa1d2237c059a4d8fe50c344841f27d037c5c2a",
  "original_prompt": "Ingested from linux-6.6.14/net/wireless/wext-priv.c",
  "human_readable_source": " \n#include <linux/slab.h>\n#include <linux/wireless.h>\n#include <linux/netdevice.h>\n#include <net/iw_handler.h>\n#include <net/wext.h>\n\nint iw_handler_get_private(struct net_device *\t\tdev,\n\t\t\t   struct iw_request_info *\tinfo,\n\t\t\t   union iwreq_data *\t\twrqu,\n\t\t\t   char *\t\t\textra)\n{\n\t \n\tif ((dev->wireless_handlers->num_private_args == 0) ||\n\t   (dev->wireless_handlers->private_args == NULL))\n\t\treturn -EOPNOTSUPP;\n\n\t \n\tif (wrqu->data.length < dev->wireless_handlers->num_private_args) {\n\t\t \n\t\twrqu->data.length = dev->wireless_handlers->num_private_args;\n\t\treturn -E2BIG;\n\t}\n\n\t \n\twrqu->data.length = dev->wireless_handlers->num_private_args;\n\n\t \n\tmemcpy(extra, dev->wireless_handlers->private_args,\n\t       sizeof(struct iw_priv_args) * wrqu->data.length);\n\n\treturn 0;\n}\n\n \nstatic const char iw_priv_type_size[] = {\n\t0,\t\t\t\t \n\t1,\t\t\t\t \n\t1,\t\t\t\t \n\t0,\t\t\t\t \n\tsizeof(__u32),\t\t\t \n\tsizeof(struct iw_freq),\t\t \n\tsizeof(struct sockaddr),\t \n\t0,\t\t\t\t \n};\n\nstatic int get_priv_size(__u16 args)\n{\n\tint\tnum = args & IW_PRIV_SIZE_MASK;\n\tint\ttype = (args & IW_PRIV_TYPE_MASK) >> 12;\n\n\treturn num * iw_priv_type_size[type];\n}\n\nstatic int adjust_priv_size(__u16 args, struct iw_point *iwp)\n{\n\tint\tnum = iwp->length;\n\tint\tmax = args & IW_PRIV_SIZE_MASK;\n\tint\ttype = (args & IW_PRIV_TYPE_MASK) >> 12;\n\n\t \n\tif (max < num)\n\t\tnum = max;\n\n\treturn num * iw_priv_type_size[type];\n}\n\n \nstatic int get_priv_descr_and_size(struct net_device *dev, unsigned int cmd,\n\t\t\t\t   const struct iw_priv_args **descrp)\n{\n\tconst struct iw_priv_args *descr;\n\tint i, extra_size;\n\n\tdescr = NULL;\n\tfor (i = 0; i < dev->wireless_handlers->num_private_args; i++) {\n\t\tif (cmd == dev->wireless_handlers->private_args[i].cmd) {\n\t\t\tdescr = &dev->wireless_handlers->private_args[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\textra_size = 0;\n\tif (descr) {\n\t\tif (IW_IS_SET(cmd)) {\n\t\t\tint\toffset = 0;\t \n\t\t\t \n\t\t\tif (descr->name[0] == '\\0')\n\t\t\t\t \n\t\t\t\toffset = sizeof(__u32);\n\n\t\t\t \n\t\t\textra_size = get_priv_size(descr->set_args);\n\n\t\t\t \n\t\t\tif ((descr->set_args & IW_PRIV_SIZE_FIXED) &&\n\t\t\t   ((extra_size + offset) <= IFNAMSIZ))\n\t\t\t\textra_size = 0;\n\t\t} else {\n\t\t\t \n\t\t\textra_size = get_priv_size(descr->get_args);\n\n\t\t\t \n\t\t\tif ((descr->get_args & IW_PRIV_SIZE_FIXED) &&\n\t\t\t   (extra_size <= IFNAMSIZ))\n\t\t\t\textra_size = 0;\n\t\t}\n\t}\n\t*descrp = descr;\n\treturn extra_size;\n}\n\nstatic int ioctl_private_iw_point(struct iw_point *iwp, unsigned int cmd,\n\t\t\t\t  const struct iw_priv_args *descr,\n\t\t\t\t  iw_handler handler, struct net_device *dev,\n\t\t\t\t  struct iw_request_info *info, int extra_size)\n{\n\tchar *extra;\n\tint err;\n\n\t \n\tif (IW_IS_SET(cmd)) {\n\t\tif (!iwp->pointer && iwp->length != 0)\n\t\t\treturn -EFAULT;\n\n\t\tif (iwp->length > (descr->set_args & IW_PRIV_SIZE_MASK))\n\t\t\treturn -E2BIG;\n\t} else if (!iwp->pointer)\n\t\treturn -EFAULT;\n\n\textra = kzalloc(extra_size, GFP_KERNEL);\n\tif (!extra)\n\t\treturn -ENOMEM;\n\n\t \n\tif (IW_IS_SET(cmd) && (iwp->length != 0)) {\n\t\tif (copy_from_user(extra, iwp->pointer, extra_size)) {\n\t\t\terr = -EFAULT;\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\t \n\terr = handler(dev, info, (union iwreq_data *) iwp, extra);\n\n\t \n\tif (!err && IW_IS_GET(cmd)) {\n\t\t \n\t\tif (!(descr->get_args & IW_PRIV_SIZE_FIXED))\n\t\t\textra_size = adjust_priv_size(descr->get_args, iwp);\n\n\t\tif (copy_to_user(iwp->pointer, extra, extra_size))\n\t\t\terr =  -EFAULT;\n\t}\n\nout:\n\tkfree(extra);\n\treturn err;\n}\n\nint ioctl_private_call(struct net_device *dev, struct iwreq *iwr,\n\t\t       unsigned int cmd, struct iw_request_info *info,\n\t\t       iw_handler handler)\n{\n\tint extra_size = 0, ret = -EINVAL;\n\tconst struct iw_priv_args *descr;\n\n\textra_size = get_priv_descr_and_size(dev, cmd, &descr);\n\n\t \n\tif (extra_size == 0) {\n\t\t \n\t\tret = handler(dev, info, &(iwr->u), (char *) &(iwr->u));\n\t} else {\n\t\tret = ioctl_private_iw_point(&iwr->u.data, cmd, descr,\n\t\t\t\t\t     handler, dev, info, extra_size);\n\t}\n\n\t \n\tif (ret == -EIWCOMMIT)\n\t\tret = call_commit_handler(dev);\n\n\treturn ret;\n}\n\n#ifdef CONFIG_COMPAT\nint compat_private_call(struct net_device *dev, struct iwreq *iwr,\n\t\t\tunsigned int cmd, struct iw_request_info *info,\n\t\t\tiw_handler handler)\n{\n\tconst struct iw_priv_args *descr;\n\tint ret, extra_size;\n\n\textra_size = get_priv_descr_and_size(dev, cmd, &descr);\n\n\t \n\tif (extra_size == 0) {\n\t\t \n\t\tret = handler(dev, info, &(iwr->u), (char *) &(iwr->u));\n\t} else {\n\t\tstruct compat_iw_point *iwp_compat;\n\t\tstruct iw_point iwp;\n\n\t\tiwp_compat = (struct compat_iw_point *) &iwr->u.data;\n\t\tiwp.pointer = compat_ptr(iwp_compat->pointer);\n\t\tiwp.length = iwp_compat->length;\n\t\tiwp.flags = iwp_compat->flags;\n\n\t\tret = ioctl_private_iw_point(&iwp, cmd, descr,\n\t\t\t\t\t     handler, dev, info, extra_size);\n\n\t\tiwp_compat->pointer = ptr_to_compat(iwp.pointer);\n\t\tiwp_compat->length = iwp.length;\n\t\tiwp_compat->flags = iwp.flags;\n\t}\n\n\t \n\tif (ret == -EIWCOMMIT)\n\t\tret = call_commit_handler(dev);\n\n\treturn ret;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}