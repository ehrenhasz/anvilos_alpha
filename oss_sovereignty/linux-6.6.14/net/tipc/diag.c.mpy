{
  "module_name": "diag.c",
  "hash_id": "7b4f7c8dc175efd3e433a45580fd2a00fca6e56b3e28bc4b631edb9e6a5965ec",
  "original_prompt": "Ingested from linux-6.6.14/net/tipc/diag.c",
  "human_readable_source": " \n\n#include \"core.h\"\n#include \"socket.h\"\n#include <linux/sock_diag.h>\n#include <linux/tipc_sockets_diag.h>\n\nstatic u64 __tipc_diag_gen_cookie(struct sock *sk)\n{\n\tu32 res[2];\n\n\tsock_diag_save_cookie(sk, res);\n\treturn *((u64 *)res);\n}\n\nstatic int __tipc_add_sock_diag(struct sk_buff *skb,\n\t\t\t\tstruct netlink_callback *cb,\n\t\t\t\tstruct tipc_sock *tsk)\n{\n\tstruct tipc_sock_diag_req *req = nlmsg_data(cb->nlh);\n\tstruct nlmsghdr *nlh;\n\tint err;\n\n\tnlh = nlmsg_put_answer(skb, cb, SOCK_DIAG_BY_FAMILY, 0,\n\t\t\t       NLM_F_MULTI);\n\tif (!nlh)\n\t\treturn -EMSGSIZE;\n\n\terr = tipc_sk_fill_sock_diag(skb, cb, tsk, req->tidiag_states,\n\t\t\t\t     __tipc_diag_gen_cookie);\n\tif (err)\n\t\treturn err;\n\n\tnlmsg_end(skb, nlh);\n\treturn 0;\n}\n\nstatic int tipc_diag_dump(struct sk_buff *skb, struct netlink_callback *cb)\n{\n\treturn tipc_nl_sk_walk(skb, cb, __tipc_add_sock_diag);\n}\n\nstatic int tipc_sock_diag_handler_dump(struct sk_buff *skb,\n\t\t\t\t       struct nlmsghdr *h)\n{\n\tint hdrlen = sizeof(struct tipc_sock_diag_req);\n\tstruct net *net = sock_net(skb->sk);\n\n\tif (nlmsg_len(h) < hdrlen)\n\t\treturn -EINVAL;\n\n\tif (h->nlmsg_flags & NLM_F_DUMP) {\n\t\tstruct netlink_dump_control c = {\n\t\t\t.start = tipc_dump_start,\n\t\t\t.dump = tipc_diag_dump,\n\t\t\t.done = tipc_dump_done,\n\t\t};\n\t\tnetlink_dump_start(net->diag_nlsk, skb, h, &c);\n\t\treturn 0;\n\t}\n\treturn -EOPNOTSUPP;\n}\n\nstatic const struct sock_diag_handler tipc_sock_diag_handler = {\n\t.family = AF_TIPC,\n\t.dump = tipc_sock_diag_handler_dump,\n};\n\nstatic int __init tipc_diag_init(void)\n{\n\treturn sock_diag_register(&tipc_sock_diag_handler);\n}\n\nstatic void __exit tipc_diag_exit(void)\n{\n\tsock_diag_unregister(&tipc_sock_diag_handler);\n}\n\nmodule_init(tipc_diag_init);\nmodule_exit(tipc_diag_exit);\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\nMODULE_ALIAS_NET_PF_PROTO_TYPE(PF_NETLINK, NETLINK_SOCK_DIAG, AF_TIPC);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}