{
  "module_name": "nf_flow_table_inet.c",
  "hash_id": "b2d4b387e91bac87d6cd9a3658ff279db17327014c4a07e87ce2e6bc9418deda",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/nf_flow_table_inet.c",
  "human_readable_source": "\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/netfilter.h>\n#include <linux/rhashtable.h>\n#include <net/netfilter/nf_flow_table.h>\n#include <net/netfilter/nf_tables.h>\n#include <linux/if_vlan.h>\n\nstatic unsigned int\nnf_flow_offload_inet_hook(void *priv, struct sk_buff *skb,\n\t\t\t  const struct nf_hook_state *state)\n{\n\tstruct vlan_ethhdr *veth;\n\t__be16 proto;\n\n\tswitch (skb->protocol) {\n\tcase htons(ETH_P_8021Q):\n\t\tveth = (struct vlan_ethhdr *)skb_mac_header(skb);\n\t\tproto = veth->h_vlan_encapsulated_proto;\n\t\tbreak;\n\tcase htons(ETH_P_PPP_SES):\n\t\tproto = nf_flow_pppoe_proto(skb);\n\t\tbreak;\n\tdefault:\n\t\tproto = skb->protocol;\n\t\tbreak;\n\t}\n\n\tswitch (proto) {\n\tcase htons(ETH_P_IP):\n\t\treturn nf_flow_offload_ip_hook(priv, skb, state);\n\tcase htons(ETH_P_IPV6):\n\t\treturn nf_flow_offload_ipv6_hook(priv, skb, state);\n\t}\n\n\treturn NF_ACCEPT;\n}\n\nstatic int nf_flow_rule_route_inet(struct net *net,\n\t\t\t\t   struct flow_offload *flow,\n\t\t\t\t   enum flow_offload_tuple_dir dir,\n\t\t\t\t   struct nf_flow_rule *flow_rule)\n{\n\tconst struct flow_offload_tuple *flow_tuple = &flow->tuplehash[dir].tuple;\n\tint err;\n\n\tswitch (flow_tuple->l3proto) {\n\tcase NFPROTO_IPV4:\n\t\terr = nf_flow_rule_route_ipv4(net, flow, dir, flow_rule);\n\t\tbreak;\n\tcase NFPROTO_IPV6:\n\t\terr = nf_flow_rule_route_ipv6(net, flow, dir, flow_rule);\n\t\tbreak;\n\tdefault:\n\t\terr = -1;\n\t\tbreak;\n\t}\n\n\treturn err;\n}\n\nstatic struct nf_flowtable_type flowtable_inet = {\n\t.family\t\t= NFPROTO_INET,\n\t.init\t\t= nf_flow_table_init,\n\t.setup\t\t= nf_flow_table_offload_setup,\n\t.action\t\t= nf_flow_rule_route_inet,\n\t.free\t\t= nf_flow_table_free,\n\t.hook\t\t= nf_flow_offload_inet_hook,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic struct nf_flowtable_type flowtable_ipv4 = {\n\t.family\t\t= NFPROTO_IPV4,\n\t.init\t\t= nf_flow_table_init,\n\t.setup\t\t= nf_flow_table_offload_setup,\n\t.action\t\t= nf_flow_rule_route_ipv4,\n\t.free\t\t= nf_flow_table_free,\n\t.hook\t\t= nf_flow_offload_ip_hook,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic struct nf_flowtable_type flowtable_ipv6 = {\n\t.family\t\t= NFPROTO_IPV6,\n\t.init\t\t= nf_flow_table_init,\n\t.setup\t\t= nf_flow_table_offload_setup,\n\t.action\t\t= nf_flow_rule_route_ipv6,\n\t.free\t\t= nf_flow_table_free,\n\t.hook\t\t= nf_flow_offload_ipv6_hook,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int __init nf_flow_inet_module_init(void)\n{\n\tnft_register_flowtable_type(&flowtable_ipv4);\n\tnft_register_flowtable_type(&flowtable_ipv6);\n\tnft_register_flowtable_type(&flowtable_inet);\n\n\treturn 0;\n}\n\nstatic void __exit nf_flow_inet_module_exit(void)\n{\n\tnft_unregister_flowtable_type(&flowtable_inet);\n\tnft_unregister_flowtable_type(&flowtable_ipv6);\n\tnft_unregister_flowtable_type(&flowtable_ipv4);\n}\n\nmodule_init(nf_flow_inet_module_init);\nmodule_exit(nf_flow_inet_module_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Pablo Neira Ayuso <pablo@netfilter.org>\");\nMODULE_ALIAS_NF_FLOWTABLE(AF_INET);\nMODULE_ALIAS_NF_FLOWTABLE(AF_INET6);\nMODULE_ALIAS_NF_FLOWTABLE(1);  \nMODULE_DESCRIPTION(\"Netfilter flow table mixed IPv4/IPv6 module\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}