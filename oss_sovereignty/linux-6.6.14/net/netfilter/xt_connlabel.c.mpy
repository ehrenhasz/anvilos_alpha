{
  "module_name": "xt_connlabel.c",
  "hash_id": "29482299aa2f3d5b8925e4bcde07feaff29a554d80b227808ac62ad3f9f3a17d",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/xt_connlabel.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/skbuff.h>\n#include <net/netfilter/nf_conntrack.h>\n#include <net/netfilter/nf_conntrack_ecache.h>\n#include <net/netfilter/nf_conntrack_labels.h>\n#include <linux/netfilter/x_tables.h>\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Florian Westphal <fw@strlen.de>\");\nMODULE_DESCRIPTION(\"Xtables: add/match connection tracking labels\");\nMODULE_ALIAS(\"ipt_connlabel\");\nMODULE_ALIAS(\"ip6t_connlabel\");\n\nstatic bool\nconnlabel_mt(const struct sk_buff *skb, struct xt_action_param *par)\n{\n\tconst struct xt_connlabel_mtinfo *info = par->matchinfo;\n\tenum ip_conntrack_info ctinfo;\n\tstruct nf_conn_labels *labels;\n\tstruct nf_conn *ct;\n\tbool invert = info->options & XT_CONNLABEL_OP_INVERT;\n\n\tct = nf_ct_get(skb, &ctinfo);\n\tif (ct == NULL)\n\t\treturn invert;\n\n\tlabels = nf_ct_labels_find(ct);\n\tif (!labels)\n\t\treturn invert;\n\n\tif (test_bit(info->bit, labels->bits))\n\t\treturn !invert;\n\n\tif (info->options & XT_CONNLABEL_OP_SET) {\n\t\tif (!test_and_set_bit(info->bit, labels->bits))\n\t\t\tnf_conntrack_event_cache(IPCT_LABEL, ct);\n\n\t\treturn !invert;\n\t}\n\n\treturn invert;\n}\n\nstatic int connlabel_mt_check(const struct xt_mtchk_param *par)\n{\n\tconst int options = XT_CONNLABEL_OP_INVERT |\n\t\t\t    XT_CONNLABEL_OP_SET;\n\tstruct xt_connlabel_mtinfo *info = par->matchinfo;\n\tint ret;\n\n\tif (info->options & ~options) {\n\t\tpr_info_ratelimited(\"Unknown options in mask %x\\n\",\n\t\t\t\t    info->options);\n\t\treturn -EINVAL;\n\t}\n\n\tret = nf_ct_netns_get(par->net, par->family);\n\tif (ret < 0) {\n\t\tpr_info_ratelimited(\"cannot load conntrack support for proto=%u\\n\",\n\t\t\t\t    par->family);\n\t\treturn ret;\n\t}\n\n\tret = nf_connlabels_get(par->net, info->bit);\n\tif (ret < 0)\n\t\tnf_ct_netns_put(par->net, par->family);\n\treturn ret;\n}\n\nstatic void connlabel_mt_destroy(const struct xt_mtdtor_param *par)\n{\n\tnf_connlabels_put(par->net);\n\tnf_ct_netns_put(par->net, par->family);\n}\n\nstatic struct xt_match connlabels_mt_reg __read_mostly = {\n\t.name           = \"connlabel\",\n\t.family         = NFPROTO_UNSPEC,\n\t.checkentry     = connlabel_mt_check,\n\t.match          = connlabel_mt,\n\t.matchsize      = sizeof(struct xt_connlabel_mtinfo),\n\t.destroy        = connlabel_mt_destroy,\n\t.me             = THIS_MODULE,\n};\n\nstatic int __init connlabel_mt_init(void)\n{\n\treturn xt_register_match(&connlabels_mt_reg);\n}\n\nstatic void __exit connlabel_mt_exit(void)\n{\n\txt_unregister_match(&connlabels_mt_reg);\n}\n\nmodule_init(connlabel_mt_init);\nmodule_exit(connlabel_mt_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}