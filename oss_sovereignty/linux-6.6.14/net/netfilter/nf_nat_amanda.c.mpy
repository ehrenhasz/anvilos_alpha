{
  "module_name": "nf_nat_amanda.c",
  "hash_id": "c6c455bc9145435c7b26b406f6eae22aa27be53df451992b4a0e7659fed7f000",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/nf_nat_amanda.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/skbuff.h>\n#include <linux/udp.h>\n\n#include <net/netfilter/nf_conntrack_helper.h>\n#include <net/netfilter/nf_conntrack_expect.h>\n#include <net/netfilter/nf_nat_helper.h>\n#include <linux/netfilter/nf_conntrack_amanda.h>\n\n#define NAT_HELPER_NAME \"amanda\"\n\nMODULE_AUTHOR(\"Brian J. Murrell <netfilter@interlinx.bc.ca>\");\nMODULE_DESCRIPTION(\"Amanda NAT helper\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS_NF_NAT_HELPER(NAT_HELPER_NAME);\n\nstatic struct nf_conntrack_nat_helper nat_helper_amanda =\n\tNF_CT_NAT_HELPER_INIT(NAT_HELPER_NAME);\n\nstatic unsigned int help(struct sk_buff *skb,\n\t\t\t enum ip_conntrack_info ctinfo,\n\t\t\t unsigned int protoff,\n\t\t\t unsigned int matchoff,\n\t\t\t unsigned int matchlen,\n\t\t\t struct nf_conntrack_expect *exp)\n{\n\tchar buffer[sizeof(\"65535\")];\n\tu_int16_t port;\n\n\t \n\texp->saved_proto.tcp.port = exp->tuple.dst.u.tcp.port;\n\texp->dir = IP_CT_DIR_ORIGINAL;\n\n\t \n\texp->expectfn = nf_nat_follow_master;\n\n\t \n\tport = nf_nat_exp_find_port(exp, ntohs(exp->saved_proto.tcp.port));\n\tif (port == 0) {\n\t\tnf_ct_helper_log(skb, exp->master, \"all ports in use\");\n\t\treturn NF_DROP;\n\t}\n\n\tsprintf(buffer, \"%u\", port);\n\tif (!nf_nat_mangle_udp_packet(skb, exp->master, ctinfo,\n\t\t\t\t      protoff, matchoff, matchlen,\n\t\t\t\t      buffer, strlen(buffer))) {\n\t\tnf_ct_helper_log(skb, exp->master, \"cannot mangle packet\");\n\t\tnf_ct_unexpect_related(exp);\n\t\treturn NF_DROP;\n\t}\n\treturn NF_ACCEPT;\n}\n\nstatic void __exit nf_nat_amanda_fini(void)\n{\n\tnf_nat_helper_unregister(&nat_helper_amanda);\n\tRCU_INIT_POINTER(nf_nat_amanda_hook, NULL);\n\tsynchronize_rcu();\n}\n\nstatic int __init nf_nat_amanda_init(void)\n{\n\tBUG_ON(nf_nat_amanda_hook != NULL);\n\tnf_nat_helper_register(&nat_helper_amanda);\n\tRCU_INIT_POINTER(nf_nat_amanda_hook, help);\n\treturn 0;\n}\n\nmodule_init(nf_nat_amanda_init);\nmodule_exit(nf_nat_amanda_fini);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}