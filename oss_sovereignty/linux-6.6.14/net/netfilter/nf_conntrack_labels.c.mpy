{
  "module_name": "nf_conntrack_labels.c",
  "hash_id": "75ba831f4e484be52f9d7d1a9019d20b82a481c37f23ed1d13be55073da97a12",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/nf_conntrack_labels.c",
  "human_readable_source": "\n \n\n#include <linux/export.h>\n#include <linux/types.h>\n\n#include <net/netfilter/nf_conntrack_ecache.h>\n#include <net/netfilter/nf_conntrack_labels.h>\n\nstatic DEFINE_SPINLOCK(nf_connlabels_lock);\n\nstatic int replace_u32(u32 *address, u32 mask, u32 new)\n{\n\tu32 old, tmp;\n\n\tdo {\n\t\told = *address;\n\t\ttmp = (old & mask) ^ new;\n\t\tif (old == tmp)\n\t\t\treturn 0;\n\t} while (cmpxchg(address, old, tmp) != old);\n\n\treturn 1;\n}\n\nint nf_connlabels_replace(struct nf_conn *ct,\n\t\t\t  const u32 *data,\n\t\t\t  const u32 *mask, unsigned int words32)\n{\n\tstruct nf_conn_labels *labels;\n\tunsigned int size, i;\n\tint changed = 0;\n\tu32 *dst;\n\n\tlabels = nf_ct_labels_find(ct);\n\tif (!labels)\n\t\treturn -ENOSPC;\n\n\tsize = sizeof(labels->bits);\n\tif (size < (words32 * sizeof(u32)))\n\t\twords32 = size / sizeof(u32);\n\n\tdst = (u32 *) labels->bits;\n\tfor (i = 0; i < words32; i++)\n\t\tchanged |= replace_u32(&dst[i], mask ? ~mask[i] : 0, data[i]);\n\n\tsize /= sizeof(u32);\n\tfor (i = words32; i < size; i++)  \n\t\treplace_u32(&dst[i], 0, 0);\n\n\tif (changed)\n\t\tnf_conntrack_event_cache(IPCT_LABEL, ct);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(nf_connlabels_replace);\n\nint nf_connlabels_get(struct net *net, unsigned int bits)\n{\n\tif (BIT_WORD(bits) >= NF_CT_LABELS_MAX_SIZE / sizeof(long))\n\t\treturn -ERANGE;\n\n\tspin_lock(&nf_connlabels_lock);\n\tnet->ct.labels_used++;\n\tspin_unlock(&nf_connlabels_lock);\n\n\tBUILD_BUG_ON(NF_CT_LABELS_MAX_SIZE / sizeof(long) >= U8_MAX);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(nf_connlabels_get);\n\nvoid nf_connlabels_put(struct net *net)\n{\n\tspin_lock(&nf_connlabels_lock);\n\tnet->ct.labels_used--;\n\tspin_unlock(&nf_connlabels_lock);\n}\nEXPORT_SYMBOL_GPL(nf_connlabels_put);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}