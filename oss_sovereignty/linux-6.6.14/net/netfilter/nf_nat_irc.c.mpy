{
  "module_name": "nf_nat_irc.c",
  "hash_id": "07f1a5c09de4a7f75ca14a37c523539d8452ed0504bc8fa9afd1052815e711df",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/nf_nat_irc.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/tcp.h>\n#include <linux/kernel.h>\n\n#include <net/netfilter/nf_nat.h>\n#include <net/netfilter/nf_nat_helper.h>\n#include <net/netfilter/nf_conntrack_helper.h>\n#include <net/netfilter/nf_conntrack_expect.h>\n#include <linux/netfilter/nf_conntrack_irc.h>\n\n#define NAT_HELPER_NAME \"irc\"\n\nMODULE_AUTHOR(\"Harald Welte <laforge@gnumonks.org>\");\nMODULE_DESCRIPTION(\"IRC (DCC) NAT helper\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS_NF_NAT_HELPER(NAT_HELPER_NAME);\n\nstatic struct nf_conntrack_nat_helper nat_helper_irc =\n\tNF_CT_NAT_HELPER_INIT(NAT_HELPER_NAME);\n\nstatic unsigned int help(struct sk_buff *skb,\n\t\t\t enum ip_conntrack_info ctinfo,\n\t\t\t unsigned int protoff,\n\t\t\t unsigned int matchoff,\n\t\t\t unsigned int matchlen,\n\t\t\t struct nf_conntrack_expect *exp)\n{\n\tchar buffer[sizeof(\"4294967296 65635\")];\n\tstruct nf_conn *ct = exp->master;\n\tunion nf_inet_addr newaddr;\n\tu_int16_t port;\n\n\t \n\tnewaddr = ct->tuplehash[IP_CT_DIR_REPLY].tuple.dst.u3;\n\n\texp->saved_proto.tcp.port = exp->tuple.dst.u.tcp.port;\n\texp->dir = IP_CT_DIR_REPLY;\n\texp->expectfn = nf_nat_follow_master;\n\n\tport = nf_nat_exp_find_port(exp,\n\t\t\t\t    ntohs(exp->saved_proto.tcp.port));\n\tif (port == 0) {\n\t\tnf_ct_helper_log(skb, ct, \"all ports in use\");\n\t\treturn NF_DROP;\n\t}\n\n\t \n\t \n\tsnprintf(buffer, sizeof(buffer), \"%u %u\", ntohl(newaddr.ip), port);\n\tpr_debug(\"inserting '%s' == %pI4, port %u\\n\",\n\t\t buffer, &newaddr.ip, port);\n\n\tif (!nf_nat_mangle_tcp_packet(skb, ct, ctinfo, protoff, matchoff,\n\t\t\t\t      matchlen, buffer, strlen(buffer))) {\n\t\tnf_ct_helper_log(skb, ct, \"cannot mangle packet\");\n\t\tnf_ct_unexpect_related(exp);\n\t\treturn NF_DROP;\n\t}\n\n\treturn NF_ACCEPT;\n}\n\nstatic void __exit nf_nat_irc_fini(void)\n{\n\tnf_nat_helper_unregister(&nat_helper_irc);\n\tRCU_INIT_POINTER(nf_nat_irc_hook, NULL);\n\tsynchronize_rcu();\n}\n\nstatic int __init nf_nat_irc_init(void)\n{\n\tBUG_ON(nf_nat_irc_hook != NULL);\n\tnf_nat_helper_register(&nat_helper_irc);\n\tRCU_INIT_POINTER(nf_nat_irc_hook, help);\n\treturn 0;\n}\n\n \nstatic int warn_set(const char *val, const struct kernel_param *kp)\n{\n\tpr_info(\"kernel >= 2.6.10 only uses 'ports' for conntrack modules\\n\");\n\treturn 0;\n}\nmodule_param_call(ports, warn_set, NULL, NULL, 0);\n\nmodule_init(nf_nat_irc_init);\nmodule_exit(nf_nat_irc_fini);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}