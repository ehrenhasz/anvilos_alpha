{
  "module_name": "nft_set_pipapo_avx2.c",
  "hash_id": "cbdae7bf35b908866fbc1e1ce1c25e8641d0d5c8e09d8a72e79ecd8343c2af89",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/nft_set_pipapo_avx2.c",
  "human_readable_source": "\n\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/netlink.h>\n#include <linux/netfilter.h>\n#include <linux/netfilter/nf_tables.h>\n#include <net/netfilter/nf_tables_core.h>\n#include <uapi/linux/netfilter/nf_tables.h>\n#include <linux/bitmap.h>\n#include <linux/bitops.h>\n\n#include <linux/compiler.h>\n#include <asm/fpu/api.h>\n\n#include \"nft_set_pipapo_avx2.h\"\n#include \"nft_set_pipapo.h\"\n\n#define NFT_PIPAPO_LONGS_PER_M256\t(XSAVE_YMM_SIZE / BITS_PER_LONG)\n\n \n#define NFT_PIPAPO_AVX2_LOAD(reg, loc)\t\t\t\t\t\\\n\tasm volatile(\"vmovntdqa %0, %%ymm\" #reg : : \"m\" (loc))\n\n \n#define NFT_PIPAPO_AVX2_BUCKET_LOAD4(reg, lt, group, v, bsize)\t\t\\\n\tNFT_PIPAPO_AVX2_LOAD(reg,\t\t\t\t\t\\\n\t\t\t     lt[((group) * NFT_PIPAPO_BUCKETS(4) +\t\\\n\t\t\t\t (v)) * (bsize)])\n#define NFT_PIPAPO_AVX2_BUCKET_LOAD8(reg, lt, group, v, bsize)\t\t\\\n\tNFT_PIPAPO_AVX2_LOAD(reg,\t\t\t\t\t\\\n\t\t\t     lt[((group) * NFT_PIPAPO_BUCKETS(8) +\t\\\n\t\t\t\t (v)) * (bsize)])\n\n \n#define NFT_PIPAPO_AVX2_AND(dst, a, b)\t\t\t\t\t\\\n\tasm volatile(\"vpand %ymm\" #a \", %ymm\" #b \", %ymm\" #dst)\n\n \n#define NFT_PIPAPO_AVX2_NOMATCH_GOTO(reg, label)\t\t\t\\\n\tasm_volatile_goto(\"vptest %%ymm\" #reg \", %%ymm\" #reg \";\"\t\\\n\t\t\t  \"je %l[\" #label \"]\" : : : : label)\n\n \n#define NFT_PIPAPO_AVX2_STORE(loc, reg)\t\t\t\t\t\\\n\tasm volatile(\"vmovdqa %%ymm\" #reg \", %0\" : \"=m\" (loc))\n\n \n#define NFT_PIPAPO_AVX2_ZERO(reg)\t\t\t\t\t\\\n\tasm volatile(\"vpxor %ymm\" #reg \", %ymm\" #reg \", %ymm\" #reg)\n\n \nstatic DEFINE_PER_CPU(bool, nft_pipapo_avx2_scratch_index);\n\n \nstatic void nft_pipapo_avx2_prepare(void)\n{\n\tNFT_PIPAPO_AVX2_ZERO(15);\n}\n\n \nstatic void nft_pipapo_avx2_fill(unsigned long *data, int start, int len)\n{\n\tint offset = start % BITS_PER_LONG;\n\tunsigned long mask;\n\n\tdata += start / BITS_PER_LONG;\n\n\tif (likely(len == 1)) {\n\t\t*data |= BIT(offset);\n\t\treturn;\n\t}\n\n\tif (likely(len < BITS_PER_LONG || offset)) {\n\t\tif (likely(len + offset <= BITS_PER_LONG)) {\n\t\t\t*data |= GENMASK(len - 1 + offset, offset);\n\t\t\treturn;\n\t\t}\n\n\t\t*data |= ~0UL << offset;\n\t\tlen -= BITS_PER_LONG - offset;\n\t\tdata++;\n\n\t\tif (len <= BITS_PER_LONG) {\n\t\t\tmask = ~0UL >> (BITS_PER_LONG - len);\n\t\t\t*data |= mask;\n\t\t\treturn;\n\t\t}\n\t}\n\n\tmemset(data, 0xff, len / BITS_PER_BYTE);\n\tdata += len / BITS_PER_LONG;\n\n\tlen %= BITS_PER_LONG;\n\tif (len)\n\t\t*data |= ~0UL >> (BITS_PER_LONG - len);\n}\n\n \nstatic int nft_pipapo_avx2_refill(int offset, unsigned long *map,\n\t\t\t\t  unsigned long *dst,\n\t\t\t\t  union nft_pipapo_map_bucket *mt, bool last)\n{\n\tint ret = -1;\n\n#define NFT_PIPAPO_AVX2_REFILL_ONE_WORD(x)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\twhile (map[(x)]) {\t\t\t\t\t\\\n\t\t\tint r = __builtin_ctzl(map[(x)]);\t\t\\\n\t\t\tint i = (offset + (x)) * BITS_PER_LONG + r;\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\t\tif (last)\t\t\t\t\t\\\n\t\t\t\treturn i;\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\t\tnft_pipapo_avx2_fill(dst, mt[i].to, mt[i].n);\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\t\tif (ret == -1)\t\t\t\t\t\\\n\t\t\t\tret = mt[i].to;\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\t\tmap[(x)] &= ~(1UL << r);\t\t\t\\\n\t\t}\t\t\t\t\t\t\t\\\n\t} while (0)\n\n\tNFT_PIPAPO_AVX2_REFILL_ONE_WORD(0);\n\tNFT_PIPAPO_AVX2_REFILL_ONE_WORD(1);\n\tNFT_PIPAPO_AVX2_REFILL_ONE_WORD(2);\n\tNFT_PIPAPO_AVX2_REFILL_ONE_WORD(3);\n#undef NFT_PIPAPO_AVX2_REFILL_ONE_WORD\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_4b_2(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tu8 pg[2] = { pkt[0] >> 4, pkt[0] & 0xf };\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0, lt, 0, pg[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1, lt, 1, pg[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0, lt, 0, pg[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_LOAD(2, map[i_ul]);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1, lt, 1, pg[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(2, nothing);\n\t\t\tNFT_PIPAPO_AVX2_AND(3, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 2, 3);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(4, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 4);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_4b_4(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tu8 pg[4] = { pkt[0] >> 4, pkt[0] & 0xf, pkt[1] >> 4, pkt[1] & 0xf };\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0, lt, 0, pg[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1, lt, 1, pg[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2, lt, 2, pg[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3, lt, 3, pg[3], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_AND(5, 2, 3);\n\t\t\tNFT_PIPAPO_AVX2_AND(7, 4, 5);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0, lt, 0, pg[0], bsize);\n\n\t\t\tNFT_PIPAPO_AVX2_LOAD(1, map[i_ul]);\n\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2, lt, 1, pg[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3, lt, 2, pg[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(4, lt, 3, pg[3], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(5, 0, 1);\n\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(1, nothing);\n\n\t\t\tNFT_PIPAPO_AVX2_AND(6, 2, 3);\n\t\t\tNFT_PIPAPO_AVX2_AND(7, 4, 5);\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(7, 6, 7);\n\t\t}\n\n\t\t \n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(7, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 7);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_4b_8(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tu8 pg[8] = {  pkt[0] >> 4,  pkt[0] & 0xf,  pkt[1] >> 4,  pkt[1] & 0xf,\n\t\t      pkt[2] >> 4,  pkt[2] & 0xf,  pkt[3] >> 4,  pkt[3] & 0xf,\n\t\t   };\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0,  lt, 0, pg[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1,  lt, 1, pg[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2,  lt, 2, pg[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt, 3, pg[3], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(4,  lt, 4, pg[4], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(5,   0,  1);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(6,  lt, 5, pg[5], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(7,  lt, 6, pg[6], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(8,   2,  3);\n\t\t\tNFT_PIPAPO_AVX2_AND(9,   4,  5);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(10, lt, 7, pg[7], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(11,  6,  7);\n\t\t\tNFT_PIPAPO_AVX2_AND(12,  8,  9);\n\t\t\tNFT_PIPAPO_AVX2_AND(13, 10, 11);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(1,  12, 13);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0,  lt, 0, pg[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_LOAD(1, map[i_ul]);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2,  lt, 1, pg[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt, 2, pg[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(4,  lt, 3, pg[3], bsize);\n\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(1, nothing);\n\n\t\t\tNFT_PIPAPO_AVX2_AND(5,   0,  1);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(6,  lt, 4, pg[4], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(7,  lt, 5, pg[5], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(8,   2,  3);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(9,  lt, 6, pg[6], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(10,  4,  5);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(11, lt, 7, pg[7], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(12,  6,  7);\n\t\t\tNFT_PIPAPO_AVX2_AND(13,  8,  9);\n\t\t\tNFT_PIPAPO_AVX2_AND(14, 10, 11);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(1,  12, 13);\n\t\t\tNFT_PIPAPO_AVX2_AND(1,   1, 14);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(1, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 1);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\n\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_4b_12(unsigned long *map, unsigned long *fill,\n\t\t\t\t        struct nft_pipapo_field *f, int offset,\n\t\t\t\t        const u8 *pkt, bool first, bool last)\n{\n\tu8 pg[12] = {  pkt[0] >> 4,  pkt[0] & 0xf,  pkt[1] >> 4,  pkt[1] & 0xf,\n\t\t       pkt[2] >> 4,  pkt[2] & 0xf,  pkt[3] >> 4,  pkt[3] & 0xf,\n\t\t       pkt[4] >> 4,  pkt[4] & 0xf,  pkt[5] >> 4,  pkt[5] & 0xf,\n\t\t    };\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (!first)\n\t\t\tNFT_PIPAPO_AVX2_LOAD(0, map[i_ul]);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1,  lt,  0,  pg[0], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2,  lt,  1,  pg[1], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt,  2,  pg[2], bsize);\n\n\t\tif (!first) {\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(0, nothing);\n\t\t\tNFT_PIPAPO_AVX2_AND(1, 1, 0);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(4,  lt,  3,  pg[3], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(5,  lt,  4,  pg[4], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(6,   2,  3);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(7,  lt,  5,  pg[5], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(8,  lt,  6,  pg[6], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(9,   1,  4);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(10, lt,  7,  pg[7], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(11,  5,  6);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(12, lt,  8,  pg[8], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(13,  7,  8);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(14, lt,  9,  pg[9], bsize);\n\n\t\tNFT_PIPAPO_AVX2_AND(0,   9, 10);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1,  lt, 10,  pg[10], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(2,  11, 12);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt, 11,  pg[11], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(4,  13, 14);\n\t\tNFT_PIPAPO_AVX2_AND(5,   0,  1);\n\n\t\tNFT_PIPAPO_AVX2_AND(6,   2,  3);\n\n\t\t \n\t\tNFT_PIPAPO_AVX2_AND(7,   4,  5);\n\t\tNFT_PIPAPO_AVX2_AND(8,   6,  7);\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(8, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 8);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_4b_32(unsigned long *map, unsigned long *fill,\n\t\t\t\t\tstruct nft_pipapo_field *f, int offset,\n\t\t\t\t\tconst u8 *pkt, bool first, bool last)\n{\n\tu8 pg[32] = {  pkt[0] >> 4,  pkt[0] & 0xf,  pkt[1] >> 4,  pkt[1] & 0xf,\n\t\t       pkt[2] >> 4,  pkt[2] & 0xf,  pkt[3] >> 4,  pkt[3] & 0xf,\n\t\t       pkt[4] >> 4,  pkt[4] & 0xf,  pkt[5] >> 4,  pkt[5] & 0xf,\n\t\t       pkt[6] >> 4,  pkt[6] & 0xf,  pkt[7] >> 4,  pkt[7] & 0xf,\n\t\t       pkt[8] >> 4,  pkt[8] & 0xf,  pkt[9] >> 4,  pkt[9] & 0xf,\n\t\t      pkt[10] >> 4, pkt[10] & 0xf, pkt[11] >> 4, pkt[11] & 0xf,\n\t\t      pkt[12] >> 4, pkt[12] & 0xf, pkt[13] >> 4, pkt[13] & 0xf,\n\t\t      pkt[14] >> 4, pkt[14] & 0xf, pkt[15] >> 4, pkt[15] & 0xf,\n\t\t    };\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (!first)\n\t\t\tNFT_PIPAPO_AVX2_LOAD(0, map[i_ul]);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1,  lt,  0,  pg[0], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2,  lt,  1,  pg[1], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt,  2,  pg[2], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(4,  lt,  3,  pg[3], bsize);\n\t\tif (!first) {\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(0, nothing);\n\t\t\tNFT_PIPAPO_AVX2_AND(1, 1, 0);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_AND(5,   2,  3);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(6,  lt,  4,  pg[4], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(7,  lt,  5,  pg[5], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(8,   1,  4);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(9,  lt,  6,  pg[6], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(10,  5,  6);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(11, lt,  7,  pg[7], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(12,  7,  8);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(13, lt,  8,  pg[8], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(14,  9, 10);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0,  lt,  9,  pg[9], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(1,  11, 12);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(2,  lt, 10, pg[10], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt, 11, pg[11], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(4,  13, 14);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(5,  lt, 12, pg[12], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(6,  lt, 13, pg[13], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(7,   0,  1);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(8,  lt, 14, pg[14], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(9,   2,  3);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(10, lt, 15, pg[15], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(11,  4,  5);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(12, lt, 16, pg[16], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(13,  6,  7);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(14, lt, 17, pg[17], bsize);\n\n\t\tNFT_PIPAPO_AVX2_AND(0,   8,  9);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(1,  lt, 18, pg[18], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(2,  10, 11);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt, 19, pg[19], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(4,  12, 13);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(5,  lt, 20, pg[20], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(6,  14,  0);\n\t\tNFT_PIPAPO_AVX2_AND(7,   1,  2);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(8,  lt, 21, pg[21], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(9,   3,  4);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(10, lt, 22, pg[22], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(11,  5,  6);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(12, lt, 23, pg[23], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(13,  7,  8);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(14, lt, 24, pg[24], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(0,  lt, 25, pg[25], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(1,   9, 10);\n\t\tNFT_PIPAPO_AVX2_AND(2,  11, 12);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(3,  lt, 26, pg[26], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(4,  13, 14);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(5,  lt, 27, pg[27], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(6,   0,  1);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(7,  lt, 28, pg[28], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(8,  lt, 29, pg[29], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(9,   2,  3);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(10, lt, 30, pg[30], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(11,  4,  5);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD4(12, lt, 31, pg[31], bsize);\n\n\t\tNFT_PIPAPO_AVX2_AND(0,   6,  7);\n\t\tNFT_PIPAPO_AVX2_AND(1,   8,  9);\n\t\tNFT_PIPAPO_AVX2_AND(2,  10, 11);\n\t\tNFT_PIPAPO_AVX2_AND(3,  12,  0);\n\n\t\t \n\t\tNFT_PIPAPO_AVX2_AND(4,   1,  2);\n\t\tNFT_PIPAPO_AVX2_AND(5,   3,  4);\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(5, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 5);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_8b_1(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2, lt, 0, pkt[0], bsize);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(0, lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_LOAD(1, map[i_ul]);\n\t\t\tNFT_PIPAPO_AVX2_AND(2, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(1, nothing);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(2, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 2);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_8b_2(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(0, lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1, lt, 1, pkt[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_LOAD(0, map[i_ul]);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1, lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2, lt, 1, pkt[1], bsize);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(3, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(0, nothing);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 3, 2);\n\t\t}\n\n\t\t \n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(4, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 4);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_8b_4(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(0,  lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1,  lt, 1, pkt[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2,  lt, 2, pkt[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3,  lt, 3, pkt[3], bsize);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_AND(5, 2, 3);\n\t\t\tNFT_PIPAPO_AVX2_AND(0, 4, 5);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(0,  lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_LOAD(1, map[i_ul]);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2,  lt, 1, pkt[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3,  lt, 2, pkt[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(4,  lt, 3, pkt[3], bsize);\n\n\t\t\tNFT_PIPAPO_AVX2_AND(5, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(1, nothing);\n\t\t\tNFT_PIPAPO_AVX2_AND(6, 2, 3);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(7, 4, 5);\n\t\t\tNFT_PIPAPO_AVX2_AND(0, 6, 7);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(0, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 0);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\n\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_8b_6(unsigned long *map, unsigned long *fill,\n\t\t\t\t       struct nft_pipapo_field *f, int offset,\n\t\t\t\t       const u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (first) {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(0,  lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1,  lt, 1, pkt[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2,  lt, 2, pkt[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3,  lt, 3, pkt[3], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(4,  lt, 4, pkt[4], bsize);\n\n\t\t\tNFT_PIPAPO_AVX2_AND(5, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(6,  lt, 5, pkt[5], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(7, 2, 3);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(0, 4, 5);\n\t\t\tNFT_PIPAPO_AVX2_AND(1, 6, 7);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\t} else {\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(0,  lt, 0, pkt[0], bsize);\n\t\t\tNFT_PIPAPO_AVX2_LOAD(1, map[i_ul]);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2,  lt, 1, pkt[1], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3,  lt, 2, pkt[2], bsize);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(4,  lt, 3, pkt[3], bsize);\n\n\t\t\tNFT_PIPAPO_AVX2_AND(5, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(1, nothing);\n\n\t\t\tNFT_PIPAPO_AVX2_AND(6, 2, 3);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(7,  lt, 4, pkt[4], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(0, 4, 5);\n\t\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1,  lt, 5, pkt[5], bsize);\n\t\t\tNFT_PIPAPO_AVX2_AND(2, 6, 7);\n\n\t\t\t \n\t\t\tNFT_PIPAPO_AVX2_AND(3, 0, 1);\n\t\t\tNFT_PIPAPO_AVX2_AND(4, 2, 3);\n\t\t}\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(4, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 4);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\n\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_8b_16(unsigned long *map, unsigned long *fill,\n\t\t\t\t\tstruct nft_pipapo_field *f, int offset,\n\t\t\t\t\tconst u8 *pkt, bool first, bool last)\n{\n\tint i, ret = -1, m256_size = f->bsize / NFT_PIPAPO_LONGS_PER_M256, b;\n\tunsigned long *lt = f->lt, bsize = f->bsize;\n\n\tlt += offset * NFT_PIPAPO_LONGS_PER_M256;\n\tfor (i = offset; i < m256_size; i++, lt += NFT_PIPAPO_LONGS_PER_M256) {\n\t\tint i_ul = i * NFT_PIPAPO_LONGS_PER_M256;\n\n\t\tif (!first)\n\t\t\tNFT_PIPAPO_AVX2_LOAD(0, map[i_ul]);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1, lt,  0,  pkt[0], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2, lt,  1,  pkt[1], bsize);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3, lt,  2,  pkt[2], bsize);\n\t\tif (!first) {\n\t\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(0, nothing);\n\t\t\tNFT_PIPAPO_AVX2_AND(1, 1, 0);\n\t\t}\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(4, lt,  3,  pkt[3], bsize);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(5, lt,  4,  pkt[4], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(6, 1, 2);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(7, lt,  5,  pkt[5], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(0, 3, 4);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1, lt,  6,  pkt[6], bsize);\n\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(2, lt,  7,  pkt[7], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(3, 5, 6);\n\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(5, lt,  8,  pkt[8], bsize);\n\n\t\tNFT_PIPAPO_AVX2_AND(6, 2, 3);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(7, lt,  9,  pkt[9], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(0, 4, 5);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1, lt, 10, pkt[10], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(2, 6, 7);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3, lt, 11, pkt[11], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(5, lt, 12, pkt[12], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(6, 2, 3);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(7, lt, 13, pkt[13], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(0, 4, 5);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(1, lt, 14, pkt[14], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(2, 6, 7);\n\t\tNFT_PIPAPO_AVX2_BUCKET_LOAD8(3, lt, 15, pkt[15], bsize);\n\t\tNFT_PIPAPO_AVX2_AND(4, 0, 1);\n\n\t\t \n\t\tNFT_PIPAPO_AVX2_AND(5, 2, 3);\n\t\tNFT_PIPAPO_AVX2_AND(6, 4, 5);\n\n\t\tNFT_PIPAPO_AVX2_NOMATCH_GOTO(6, nomatch);\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 6);\n\n\t\tb = nft_pipapo_avx2_refill(i_ul, &map[i_ul], fill, f->mt, last);\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (unlikely(ret == -1))\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\n\t\tcontinue;\n\nnomatch:\n\t\tNFT_PIPAPO_AVX2_STORE(map[i_ul], 15);\nnothing:\n\t\t;\n\t}\n\n\treturn ret;\n}\n\n \nstatic int nft_pipapo_avx2_lookup_slow(unsigned long *map, unsigned long *fill,\n\t\t\t\t\tstruct nft_pipapo_field *f, int offset,\n\t\t\t\t\tconst u8 *pkt, bool first, bool last)\n{\n\tunsigned long bsize = f->bsize;\n\tint i, ret = -1, b;\n\n\tif (first)\n\t\tmemset(map, 0xff, bsize * sizeof(*map));\n\n\tfor (i = offset; i < bsize; i++) {\n\t\tif (f->bb == 8)\n\t\t\tpipapo_and_field_buckets_8bit(f, map, pkt);\n\t\telse\n\t\t\tpipapo_and_field_buckets_4bit(f, map, pkt);\n\t\tNFT_PIPAPO_GROUP_BITS_ARE_8_OR_4;\n\n\t\tb = pipapo_refill(map, bsize, f->rules, fill, f->mt, last);\n\n\t\tif (last)\n\t\t\treturn b;\n\n\t\tif (ret == -1)\n\t\t\tret = b / XSAVE_YMM_SIZE;\n\t}\n\n\treturn ret;\n}\n\n \nbool nft_pipapo_avx2_estimate(const struct nft_set_desc *desc, u32 features,\n\t\t\t      struct nft_set_estimate *est)\n{\n\tif (!(features & NFT_SET_INTERVAL) ||\n\t    desc->field_count < NFT_PIPAPO_MIN_FIELDS)\n\t\treturn false;\n\n\tif (!boot_cpu_has(X86_FEATURE_AVX2) || !boot_cpu_has(X86_FEATURE_AVX))\n\t\treturn false;\n\n\test->size = pipapo_estimate_size(desc);\n\tif (!est->size)\n\t\treturn false;\n\n\test->lookup = NFT_SET_CLASS_O_LOG_N;\n\n\test->space = NFT_SET_CLASS_O_N;\n\n\treturn true;\n}\n\n \nbool nft_pipapo_avx2_lookup(const struct net *net, const struct nft_set *set,\n\t\t\t    const u32 *key, const struct nft_set_ext **ext)\n{\n\tstruct nft_pipapo *priv = nft_set_priv(set);\n\tunsigned long *res, *fill, *scratch;\n\tu8 genmask = nft_genmask_cur(net);\n\tconst u8 *rp = (const u8 *)key;\n\tstruct nft_pipapo_match *m;\n\tstruct nft_pipapo_field *f;\n\tbool map_index;\n\tint i, ret = 0;\n\n\tif (unlikely(!irq_fpu_usable()))\n\t\treturn nft_pipapo_lookup(net, set, key, ext);\n\n\tm = rcu_dereference(priv->match);\n\n\t \n\tkernel_fpu_begin_mask(0);\n\n\tscratch = *raw_cpu_ptr(m->scratch_aligned);\n\tif (unlikely(!scratch)) {\n\t\tkernel_fpu_end();\n\t\treturn false;\n\t}\n\tmap_index = raw_cpu_read(nft_pipapo_avx2_scratch_index);\n\n\tres  = scratch + (map_index ? m->bsize_max : 0);\n\tfill = scratch + (map_index ? 0 : m->bsize_max);\n\n\t \n\n\tnft_pipapo_avx2_prepare();\n\nnext_match:\n\tnft_pipapo_for_each_field(f, i, m) {\n\t\tbool last = i == m->field_count - 1, first = !i;\n\n#define NFT_SET_PIPAPO_AVX2_LOOKUP(b, n)\t\t\t\t\\\n\t\t(ret = nft_pipapo_avx2_lookup_##b##b_##n(res, fill, f,\t\\\n\t\t\t\t\t\t\t ret, rp,\t\\\n\t\t\t\t\t\t\t first, last))\n\n\t\tif (likely(f->bb == 8)) {\n\t\t\tif (f->groups == 1) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(8, 1);\n\t\t\t} else if (f->groups == 2) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(8, 2);\n\t\t\t} else if (f->groups == 4) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(8, 4);\n\t\t\t} else if (f->groups == 6) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(8, 6);\n\t\t\t} else if (f->groups == 16) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(8, 16);\n\t\t\t} else {\n\t\t\t\tret = nft_pipapo_avx2_lookup_slow(res, fill, f,\n\t\t\t\t\t\t\t\t  ret, rp,\n\t\t\t\t\t\t\t\t  first, last);\n\t\t\t}\n\t\t} else {\n\t\t\tif (f->groups == 2) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(4, 2);\n\t\t\t} else if (f->groups == 4) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(4, 4);\n\t\t\t} else if (f->groups == 8) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(4, 8);\n\t\t\t} else if (f->groups == 12) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(4, 12);\n\t\t\t} else if (f->groups == 32) {\n\t\t\t\tNFT_SET_PIPAPO_AVX2_LOOKUP(4, 32);\n\t\t\t} else {\n\t\t\t\tret = nft_pipapo_avx2_lookup_slow(res, fill, f,\n\t\t\t\t\t\t\t\t  ret, rp,\n\t\t\t\t\t\t\t\t  first, last);\n\t\t\t}\n\t\t}\n\t\tNFT_PIPAPO_GROUP_BITS_ARE_8_OR_4;\n\n#undef NFT_SET_PIPAPO_AVX2_LOOKUP\n\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\n\t\tif (last) {\n\t\t\t*ext = &f->mt[ret].e->ext;\n\t\t\tif (unlikely(nft_set_elem_expired(*ext) ||\n\t\t\t\t     !nft_set_elem_active(*ext, genmask))) {\n\t\t\t\tret = 0;\n\t\t\t\tgoto next_match;\n\t\t\t}\n\n\t\t\tgoto out;\n\t\t}\n\n\t\tswap(res, fill);\n\t\trp += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);\n\t}\n\nout:\n\tif (i % 2)\n\t\traw_cpu_write(nft_pipapo_avx2_scratch_index, !map_index);\n\tkernel_fpu_end();\n\n\treturn ret >= 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}