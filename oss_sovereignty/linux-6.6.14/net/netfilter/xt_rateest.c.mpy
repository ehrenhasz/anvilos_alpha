{
  "module_name": "xt_rateest.c",
  "hash_id": "2d84bc4b6e7c7e5fddf3d920427266ce561273791a8478c38cfe169a81d3a09e",
  "original_prompt": "Ingested from linux-6.6.14/net/netfilter/xt_rateest.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/skbuff.h>\n#include <linux/gen_stats.h>\n\n#include <linux/netfilter/x_tables.h>\n#include <linux/netfilter/xt_rateest.h>\n#include <net/netfilter/xt_rateest.h>\n\n\nstatic bool\nxt_rateest_mt(const struct sk_buff *skb, struct xt_action_param *par)\n{\n\tconst struct xt_rateest_match_info *info = par->matchinfo;\n\tstruct gnet_stats_rate_est64 sample = {0};\n\tu_int32_t bps1, bps2, pps1, pps2;\n\tbool ret = true;\n\n\tgen_estimator_read(&info->est1->rate_est, &sample);\n\n\tif (info->flags & XT_RATEEST_MATCH_DELTA) {\n\t\tbps1 = info->bps1 >= sample.bps ? info->bps1 - sample.bps : 0;\n\t\tpps1 = info->pps1 >= sample.pps ? info->pps1 - sample.pps : 0;\n\t} else {\n\t\tbps1 = sample.bps;\n\t\tpps1 = sample.pps;\n\t}\n\n\tif (info->flags & XT_RATEEST_MATCH_ABS) {\n\t\tbps2 = info->bps2;\n\t\tpps2 = info->pps2;\n\t} else {\n\t\tgen_estimator_read(&info->est2->rate_est, &sample);\n\n\t\tif (info->flags & XT_RATEEST_MATCH_DELTA) {\n\t\t\tbps2 = info->bps2 >= sample.bps ? info->bps2 - sample.bps : 0;\n\t\t\tpps2 = info->pps2 >= sample.pps ? info->pps2 - sample.pps : 0;\n\t\t} else {\n\t\t\tbps2 = sample.bps;\n\t\t\tpps2 = sample.pps;\n\t\t}\n\t}\n\n\tswitch (info->mode) {\n\tcase XT_RATEEST_MATCH_LT:\n\t\tif (info->flags & XT_RATEEST_MATCH_BPS)\n\t\t\tret &= bps1 < bps2;\n\t\tif (info->flags & XT_RATEEST_MATCH_PPS)\n\t\t\tret &= pps1 < pps2;\n\t\tbreak;\n\tcase XT_RATEEST_MATCH_GT:\n\t\tif (info->flags & XT_RATEEST_MATCH_BPS)\n\t\t\tret &= bps1 > bps2;\n\t\tif (info->flags & XT_RATEEST_MATCH_PPS)\n\t\t\tret &= pps1 > pps2;\n\t\tbreak;\n\tcase XT_RATEEST_MATCH_EQ:\n\t\tif (info->flags & XT_RATEEST_MATCH_BPS)\n\t\t\tret &= bps1 == bps2;\n\t\tif (info->flags & XT_RATEEST_MATCH_PPS)\n\t\t\tret &= pps1 == pps2;\n\t\tbreak;\n\t}\n\n\tret ^= info->flags & XT_RATEEST_MATCH_INVERT ? true : false;\n\treturn ret;\n}\n\nstatic int xt_rateest_mt_checkentry(const struct xt_mtchk_param *par)\n{\n\tstruct xt_rateest_match_info *info = par->matchinfo;\n\tstruct xt_rateest *est1, *est2;\n\tint ret = -EINVAL;\n\n\tif (hweight32(info->flags & (XT_RATEEST_MATCH_ABS |\n\t\t\t\t     XT_RATEEST_MATCH_REL)) != 1)\n\t\tgoto err1;\n\n\tif (!(info->flags & (XT_RATEEST_MATCH_BPS | XT_RATEEST_MATCH_PPS)))\n\t\tgoto err1;\n\n\tswitch (info->mode) {\n\tcase XT_RATEEST_MATCH_EQ:\n\tcase XT_RATEEST_MATCH_LT:\n\tcase XT_RATEEST_MATCH_GT:\n\t\tbreak;\n\tdefault:\n\t\tgoto err1;\n\t}\n\n\tret  = -ENOENT;\n\test1 = xt_rateest_lookup(par->net, info->name1);\n\tif (!est1)\n\t\tgoto err1;\n\n\test2 = NULL;\n\tif (info->flags & XT_RATEEST_MATCH_REL) {\n\t\test2 = xt_rateest_lookup(par->net, info->name2);\n\t\tif (!est2)\n\t\t\tgoto err2;\n\t}\n\n\tinfo->est1 = est1;\n\tinfo->est2 = est2;\n\treturn 0;\n\nerr2:\n\txt_rateest_put(par->net, est1);\nerr1:\n\treturn ret;\n}\n\nstatic void xt_rateest_mt_destroy(const struct xt_mtdtor_param *par)\n{\n\tstruct xt_rateest_match_info *info = par->matchinfo;\n\n\txt_rateest_put(par->net, info->est1);\n\tif (info->est2)\n\t\txt_rateest_put(par->net, info->est2);\n}\n\nstatic struct xt_match xt_rateest_mt_reg __read_mostly = {\n\t.name       = \"rateest\",\n\t.revision   = 0,\n\t.family     = NFPROTO_UNSPEC,\n\t.match      = xt_rateest_mt,\n\t.checkentry = xt_rateest_mt_checkentry,\n\t.destroy    = xt_rateest_mt_destroy,\n\t.matchsize  = sizeof(struct xt_rateest_match_info),\n\t.usersize   = offsetof(struct xt_rateest_match_info, est1),\n\t.me         = THIS_MODULE,\n};\n\nstatic int __init xt_rateest_mt_init(void)\n{\n\treturn xt_register_match(&xt_rateest_mt_reg);\n}\n\nstatic void __exit xt_rateest_mt_fini(void)\n{\n\txt_unregister_match(&xt_rateest_mt_reg);\n}\n\nMODULE_AUTHOR(\"Patrick McHardy <kaber@trash.net>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"xtables rate estimator match\");\nMODULE_ALIAS(\"ipt_rateest\");\nMODULE_ALIAS(\"ip6t_rateest\");\nmodule_init(xt_rateest_mt_init);\nmodule_exit(xt_rateest_mt_fini);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}