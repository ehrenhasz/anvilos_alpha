{
  "module_name": "ncsi-cmd.c",
  "hash_id": "31090ec915dd413b5b6d5c7bcb99fc9e9f1c4baed8d316d6ee2e58cd26413fd5",
  "original_prompt": "Ingested from linux-6.6.14/net/ncsi/ncsi-cmd.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/etherdevice.h>\n#include <linux/netdevice.h>\n#include <linux/skbuff.h>\n\n#include <net/ncsi.h>\n#include <net/net_namespace.h>\n#include <net/sock.h>\n#include <net/genetlink.h>\n\n#include \"internal.h\"\n#include \"ncsi-pkt.h\"\n\nstatic const int padding_bytes = 26;\n\nu32 ncsi_calculate_checksum(unsigned char *data, int len)\n{\n\tu32 checksum = 0;\n\tint i;\n\n\tfor (i = 0; i < len; i += 2)\n\t\tchecksum += (((u32)data[i] << 8) | data[i + 1]);\n\n\tchecksum = (~checksum + 1);\n\treturn checksum;\n}\n\n \nstatic void ncsi_cmd_build_header(struct ncsi_pkt_hdr *h,\n\t\t\t\t  struct ncsi_cmd_arg *nca)\n{\n\tu32 checksum;\n\t__be32 *pchecksum;\n\n\th->mc_id        = 0;\n\th->revision     = NCSI_PKT_REVISION;\n\th->reserved     = 0;\n\th->id           = nca->id;\n\th->type         = nca->type;\n\th->channel      = NCSI_TO_CHANNEL(nca->package,\n\t\t\t\t\t  nca->channel);\n\th->length       = htons(nca->payload);\n\th->reserved1[0] = 0;\n\th->reserved1[1] = 0;\n\n\t \n\tchecksum = ncsi_calculate_checksum((unsigned char *)h,\n\t\t\t\t\t   sizeof(*h) + nca->payload);\n\tpchecksum = (__be32 *)((void *)h + sizeof(struct ncsi_pkt_hdr) +\n\t\t    ALIGN(nca->payload, 4));\n\t*pchecksum = htonl(checksum);\n}\n\nstatic int ncsi_cmd_handler_default(struct sk_buff *skb,\n\t\t\t\t    struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_sp(struct sk_buff *skb,\n\t\t\t       struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_sp_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->hw_arbitration = nca->bytes[0];\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_dc(struct sk_buff *skb,\n\t\t\t       struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_dc_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->ald = nca->bytes[0];\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_rc(struct sk_buff *skb,\n\t\t\t       struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_rc_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_ae(struct sk_buff *skb,\n\t\t\t       struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_ae_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->mc_id = nca->bytes[0];\n\tcmd->mode = htonl(nca->dwords[1]);\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_sl(struct sk_buff *skb,\n\t\t\t       struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_sl_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->mode = htonl(nca->dwords[0]);\n\tcmd->oem_mode = htonl(nca->dwords[1]);\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_svf(struct sk_buff *skb,\n\t\t\t\tstruct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_svf_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->vlan = htons(nca->words[1]);\n\tcmd->index = nca->bytes[6];\n\tcmd->enable = nca->bytes[7];\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_ev(struct sk_buff *skb,\n\t\t\t       struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_ev_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->mode = nca->bytes[3];\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_sma(struct sk_buff *skb,\n\t\t\t\tstruct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_sma_pkt *cmd;\n\tint i;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tfor (i = 0; i < 6; i++)\n\t\tcmd->mac[i] = nca->bytes[i];\n\tcmd->index = nca->bytes[6];\n\tcmd->at_e = nca->bytes[7];\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_ebf(struct sk_buff *skb,\n\t\t\t\tstruct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_ebf_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->mode = htonl(nca->dwords[0]);\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_egmf(struct sk_buff *skb,\n\t\t\t\t struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_egmf_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->mode = htonl(nca->dwords[0]);\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_snfc(struct sk_buff *skb,\n\t\t\t\t struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_snfc_pkt *cmd;\n\n\tcmd = skb_put_zero(skb, sizeof(*cmd));\n\tcmd->mode = nca->bytes[0];\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic int ncsi_cmd_handler_oem(struct sk_buff *skb,\n\t\t\t\tstruct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_oem_pkt *cmd;\n\tunsigned int len;\n\tint payload;\n\t \n\n\tpayload = ALIGN(nca->payload, 4);\n\tlen = sizeof(struct ncsi_cmd_pkt_hdr) + 4;\n\tlen += max(payload, padding_bytes);\n\n\tcmd = skb_put_zero(skb, len);\n\tunsafe_memcpy(&cmd->mfr_id, nca->data, nca->payload,\n\t\t       );\n\tncsi_cmd_build_header(&cmd->cmd.common, nca);\n\n\treturn 0;\n}\n\nstatic struct ncsi_cmd_handler {\n\tunsigned char type;\n\tint           payload;\n\tint           (*handler)(struct sk_buff *skb,\n\t\t\t\t struct ncsi_cmd_arg *nca);\n} ncsi_cmd_handlers[] = {\n\t{ NCSI_PKT_CMD_CIS,    0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_SP,     4, ncsi_cmd_handler_sp      },\n\t{ NCSI_PKT_CMD_DP,     0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_EC,     0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_DC,     4, ncsi_cmd_handler_dc      },\n\t{ NCSI_PKT_CMD_RC,     4, ncsi_cmd_handler_rc      },\n\t{ NCSI_PKT_CMD_ECNT,   0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_DCNT,   0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_AE,     8, ncsi_cmd_handler_ae      },\n\t{ NCSI_PKT_CMD_SL,     8, ncsi_cmd_handler_sl      },\n\t{ NCSI_PKT_CMD_GLS,    0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_SVF,    8, ncsi_cmd_handler_svf     },\n\t{ NCSI_PKT_CMD_EV,     4, ncsi_cmd_handler_ev      },\n\t{ NCSI_PKT_CMD_DV,     0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_SMA,    8, ncsi_cmd_handler_sma     },\n\t{ NCSI_PKT_CMD_EBF,    4, ncsi_cmd_handler_ebf     },\n\t{ NCSI_PKT_CMD_DBF,    0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_EGMF,   4, ncsi_cmd_handler_egmf    },\n\t{ NCSI_PKT_CMD_DGMF,   0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_SNFC,   4, ncsi_cmd_handler_snfc    },\n\t{ NCSI_PKT_CMD_GVI,    0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_GC,     0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_GP,     0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_GCPS,   0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_GNS,    0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_GNPTS,  0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_GPS,    0, ncsi_cmd_handler_default },\n\t{ NCSI_PKT_CMD_OEM,   -1, ncsi_cmd_handler_oem     },\n\t{ NCSI_PKT_CMD_PLDM,   0, NULL                     },\n\t{ NCSI_PKT_CMD_GPUUID, 0, ncsi_cmd_handler_default }\n};\n\nstatic struct ncsi_request *ncsi_alloc_command(struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_dev_priv *ndp = nca->ndp;\n\tstruct ncsi_dev *nd = &ndp->ndev;\n\tstruct net_device *dev = nd->dev;\n\tint hlen = LL_RESERVED_SPACE(dev);\n\tint tlen = dev->needed_tailroom;\n\tint payload;\n\tint len = hlen + tlen;\n\tstruct sk_buff *skb;\n\tstruct ncsi_request *nr;\n\n\tnr = ncsi_alloc_request(ndp, nca->req_flags);\n\tif (!nr)\n\t\treturn NULL;\n\n\t \n\tlen += sizeof(struct ncsi_cmd_pkt_hdr) + 4;\n\tpayload = ALIGN(nca->payload, 4);\n\tlen += max(payload, padding_bytes);\n\n\t \n\tskb = alloc_skb(len, GFP_ATOMIC);\n\tif (!skb) {\n\t\tncsi_free_request(nr);\n\t\treturn NULL;\n\t}\n\n\tnr->cmd = skb;\n\tskb_reserve(skb, hlen);\n\tskb_reset_network_header(skb);\n\n\tskb->dev = dev;\n\tskb->protocol = htons(ETH_P_NCSI);\n\n\treturn nr;\n}\n\nint ncsi_xmit_cmd(struct ncsi_cmd_arg *nca)\n{\n\tstruct ncsi_cmd_handler *nch = NULL;\n\tstruct ncsi_request *nr;\n\tunsigned char type;\n\tstruct ethhdr *eh;\n\tint i, ret;\n\n\t \n\tif (nca->req_flags == NCSI_REQ_FLAG_NETLINK_DRIVEN)\n\t\ttype = NCSI_PKT_CMD_OEM;\n\telse\n\t\ttype = nca->type;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(ncsi_cmd_handlers); i++) {\n\t\tif (ncsi_cmd_handlers[i].type == type) {\n\t\t\tif (ncsi_cmd_handlers[i].handler)\n\t\t\t\tnch = &ncsi_cmd_handlers[i];\n\t\t\telse\n\t\t\t\tnch = NULL;\n\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!nch) {\n\t\tnetdev_err(nca->ndp->ndev.dev,\n\t\t\t   \"Cannot send packet with type 0x%02x\\n\", nca->type);\n\t\treturn -ENOENT;\n\t}\n\n\t \n\tif (nch->payload >= 0)\n\t\tnca->payload = nch->payload;\n\tnr = ncsi_alloc_command(nca);\n\tif (!nr)\n\t\treturn -ENOMEM;\n\n\t \n\tif (nca->req_flags == NCSI_REQ_FLAG_NETLINK_DRIVEN) {\n\t\tnr->snd_seq = nca->info->snd_seq;\n\t\tnr->snd_portid = nca->info->snd_portid;\n\t\tnr->nlhdr = *nca->info->nlhdr;\n\t}\n\n\t \n\tnca->id = nr->id;\n\tret = nch->handler(nr->cmd, nca);\n\tif (ret) {\n\t\tncsi_free_request(nr);\n\t\treturn ret;\n\t}\n\n\t \n\teh = skb_push(nr->cmd, sizeof(*eh));\n\teh->h_proto = htons(ETH_P_NCSI);\n\teth_broadcast_addr(eh->h_dest);\n\n\t \n\tif (nca->ndp->gma_flag == 1)\n\t\tmemcpy(eh->h_source, nca->ndp->ndev.dev->dev_addr, ETH_ALEN);\n\telse\n\t\teth_broadcast_addr(eh->h_source);\n\n\t \n\tnr->enabled = true;\n\tmod_timer(&nr->timer, jiffies + 1 * HZ);\n\n\t \n\tskb_get(nr->cmd);\n\tret = dev_queue_xmit(nr->cmd);\n\tif (ret < 0) {\n\t\tncsi_free_request(nr);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}