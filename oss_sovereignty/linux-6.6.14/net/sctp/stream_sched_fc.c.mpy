{
  "module_name": "stream_sched_fc.c",
  "hash_id": "e996c258904721bbe30791fde2932f2f1976cd646bfcd15d4d7c81c8468445e1",
  "original_prompt": "Ingested from linux-6.6.14/net/sctp/stream_sched_fc.c",
  "human_readable_source": "\n \n\n#include <linux/list.h>\n#include <net/sctp/sctp.h>\n#include <net/sctp/sm.h>\n#include <net/sctp/stream_sched.h>\n\n \nstatic void sctp_sched_fc_unsched_all(struct sctp_stream *stream);\n\nstatic int sctp_sched_wfq_set(struct sctp_stream *stream, __u16 sid,\n\t\t\t      __u16 weight, gfp_t gfp)\n{\n\tstruct sctp_stream_out_ext *soute = SCTP_SO(stream, sid)->ext;\n\n\tif (!weight)\n\t\treturn -EINVAL;\n\n\tsoute->fc_weight = weight;\n\treturn 0;\n}\n\nstatic int sctp_sched_wfq_get(struct sctp_stream *stream, __u16 sid,\n\t\t\t      __u16 *value)\n{\n\tstruct sctp_stream_out_ext *soute = SCTP_SO(stream, sid)->ext;\n\n\t*value = soute->fc_weight;\n\treturn 0;\n}\n\nstatic int sctp_sched_fc_set(struct sctp_stream *stream, __u16 sid,\n\t\t\t     __u16 weight, gfp_t gfp)\n{\n\treturn 0;\n}\n\nstatic int sctp_sched_fc_get(struct sctp_stream *stream, __u16 sid,\n\t\t\t     __u16 *value)\n{\n\treturn 0;\n}\n\nstatic int sctp_sched_fc_init(struct sctp_stream *stream)\n{\n\tINIT_LIST_HEAD(&stream->fc_list);\n\n\treturn 0;\n}\n\nstatic int sctp_sched_fc_init_sid(struct sctp_stream *stream, __u16 sid,\n\t\t\t\t  gfp_t gfp)\n{\n\tstruct sctp_stream_out_ext *soute = SCTP_SO(stream, sid)->ext;\n\n\tINIT_LIST_HEAD(&soute->fc_list);\n\tsoute->fc_length = 0;\n\tsoute->fc_weight = 1;\n\n\treturn 0;\n}\n\nstatic void sctp_sched_fc_free_sid(struct sctp_stream *stream, __u16 sid)\n{\n}\n\nstatic void sctp_sched_fc_sched(struct sctp_stream *stream,\n\t\t\t\tstruct sctp_stream_out_ext *soute)\n{\n\tstruct sctp_stream_out_ext *pos;\n\n\tif (!list_empty(&soute->fc_list))\n\t\treturn;\n\n\tlist_for_each_entry(pos, &stream->fc_list, fc_list)\n\t\tif ((__u64)pos->fc_length * soute->fc_weight >=\n\t\t    (__u64)soute->fc_length * pos->fc_weight)\n\t\t\tbreak;\n\tlist_add_tail(&soute->fc_list, &pos->fc_list);\n}\n\nstatic void sctp_sched_fc_enqueue(struct sctp_outq *q,\n\t\t\t\t  struct sctp_datamsg *msg)\n{\n\tstruct sctp_stream *stream;\n\tstruct sctp_chunk *ch;\n\t__u16 sid;\n\n\tch = list_first_entry(&msg->chunks, struct sctp_chunk, frag_list);\n\tsid = sctp_chunk_stream_no(ch);\n\tstream = &q->asoc->stream;\n\tsctp_sched_fc_sched(stream, SCTP_SO(stream, sid)->ext);\n}\n\nstatic struct sctp_chunk *sctp_sched_fc_dequeue(struct sctp_outq *q)\n{\n\tstruct sctp_stream *stream = &q->asoc->stream;\n\tstruct sctp_stream_out_ext *soute;\n\tstruct sctp_chunk *ch;\n\n\t \n\tif (list_empty(&q->out_chunk_list))\n\t\treturn NULL;\n\n\t \n\tif (stream->out_curr)\n\t\tsoute = stream->out_curr->ext;\n\telse\n\t\tsoute = list_entry(stream->fc_list.next, struct sctp_stream_out_ext, fc_list);\n\tch = list_entry(soute->outq.next, struct sctp_chunk, stream_list);\n\n\tsctp_sched_dequeue_common(q, ch);\n\treturn ch;\n}\n\nstatic void sctp_sched_fc_dequeue_done(struct sctp_outq *q,\n\t\t\t\t       struct sctp_chunk *ch)\n{\n\tstruct sctp_stream *stream = &q->asoc->stream;\n\tstruct sctp_stream_out_ext *soute, *pos;\n\t__u16 sid, i;\n\n\tsid = sctp_chunk_stream_no(ch);\n\tsoute = SCTP_SO(stream, sid)->ext;\n\t \n\tif (soute->fc_length > U32_MAX - ch->skb->len) {\n\t\tfor (i = 0; i < stream->outcnt; i++) {\n\t\t\tpos = SCTP_SO(stream, i)->ext;\n\t\t\tif (!pos)\n\t\t\t\tcontinue;\n\t\t\tif (pos->fc_length <= (U32_MAX >> 2)) {\n\t\t\t\tpos->fc_length = 0;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tpos->fc_length -= (U32_MAX >> 2);\n\t\t}\n\t}\n\tsoute->fc_length += ch->skb->len;\n\n\tif (list_empty(&soute->outq)) {\n\t\tlist_del_init(&soute->fc_list);\n\t\treturn;\n\t}\n\n\tpos = soute;\n\tlist_for_each_entry_continue(pos, &stream->fc_list, fc_list)\n\t\tif ((__u64)pos->fc_length * soute->fc_weight >=\n\t\t    (__u64)soute->fc_length * pos->fc_weight)\n\t\t\tbreak;\n\tlist_move_tail(&soute->fc_list, &pos->fc_list);\n}\n\nstatic void sctp_sched_fc_sched_all(struct sctp_stream *stream)\n{\n\tstruct sctp_association *asoc;\n\tstruct sctp_chunk *ch;\n\n\tasoc = container_of(stream, struct sctp_association, stream);\n\tlist_for_each_entry(ch, &asoc->outqueue.out_chunk_list, list) {\n\t\t__u16 sid = sctp_chunk_stream_no(ch);\n\n\t\tif (SCTP_SO(stream, sid)->ext)\n\t\t\tsctp_sched_fc_sched(stream, SCTP_SO(stream, sid)->ext);\n\t}\n}\n\nstatic void sctp_sched_fc_unsched_all(struct sctp_stream *stream)\n{\n\tstruct sctp_stream_out_ext *soute, *tmp;\n\n\tlist_for_each_entry_safe(soute, tmp, &stream->fc_list, fc_list)\n\t\tlist_del_init(&soute->fc_list);\n}\n\nstatic struct sctp_sched_ops sctp_sched_fc = {\n\t.set = sctp_sched_fc_set,\n\t.get = sctp_sched_fc_get,\n\t.init = sctp_sched_fc_init,\n\t.init_sid = sctp_sched_fc_init_sid,\n\t.free_sid = sctp_sched_fc_free_sid,\n\t.enqueue = sctp_sched_fc_enqueue,\n\t.dequeue = sctp_sched_fc_dequeue,\n\t.dequeue_done = sctp_sched_fc_dequeue_done,\n\t.sched_all = sctp_sched_fc_sched_all,\n\t.unsched_all = sctp_sched_fc_unsched_all,\n};\n\nvoid sctp_sched_ops_fc_init(void)\n{\n\tsctp_sched_ops_register(SCTP_SS_FC, &sctp_sched_fc);\n}\n\nstatic struct sctp_sched_ops sctp_sched_wfq = {\n\t.set = sctp_sched_wfq_set,\n\t.get = sctp_sched_wfq_get,\n\t.init = sctp_sched_fc_init,\n\t.init_sid = sctp_sched_fc_init_sid,\n\t.free_sid = sctp_sched_fc_free_sid,\n\t.enqueue = sctp_sched_fc_enqueue,\n\t.dequeue = sctp_sched_fc_dequeue,\n\t.dequeue_done = sctp_sched_fc_dequeue_done,\n\t.sched_all = sctp_sched_fc_sched_all,\n\t.unsched_all = sctp_sched_fc_unsched_all,\n};\n\nvoid sctp_sched_ops_wfq_init(void)\n{\n\tsctp_sched_ops_register(SCTP_SS_WFQ, &sctp_sched_wfq);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}