{
  "module_name": "dp_notify.c",
  "hash_id": "d7ebc4a3dd3ebb45937abbb5649febfc35c6c7e37c397dcb9e08a87759521d98",
  "original_prompt": "Ingested from linux-6.6.14/net/openvswitch/dp_notify.c",
  "human_readable_source": "\n \n\n#include <linux/netdevice.h>\n#include <net/genetlink.h>\n#include <net/netns/generic.h>\n\n#include \"datapath.h\"\n#include \"vport-internal_dev.h\"\n#include \"vport-netdev.h\"\n\nstatic void dp_detach_port_notify(struct vport *vport)\n{\n\tstruct sk_buff *notify;\n\tstruct datapath *dp;\n\n\tdp = vport->dp;\n\tnotify = ovs_vport_cmd_build_info(vport, ovs_dp_get_net(dp),\n\t\t\t\t\t  0, 0, OVS_VPORT_CMD_DEL);\n\tovs_dp_detach_port(vport);\n\tif (IS_ERR(notify)) {\n\t\tgenl_set_err(&dp_vport_genl_family, ovs_dp_get_net(dp), 0,\n\t\t\t     0, PTR_ERR(notify));\n\t\treturn;\n\t}\n\n\tgenlmsg_multicast_netns(&dp_vport_genl_family,\n\t\t\t\tovs_dp_get_net(dp), notify, 0,\n\t\t\t\t0, GFP_KERNEL);\n}\n\nvoid ovs_dp_notify_wq(struct work_struct *work)\n{\n\tstruct ovs_net *ovs_net = container_of(work, struct ovs_net, dp_notify_work);\n\tstruct datapath *dp;\n\n\tovs_lock();\n\tlist_for_each_entry(dp, &ovs_net->dps, list_node) {\n\t\tint i;\n\n\t\tfor (i = 0; i < DP_VPORT_HASH_BUCKETS; i++) {\n\t\t\tstruct vport *vport;\n\t\t\tstruct hlist_node *n;\n\n\t\t\thlist_for_each_entry_safe(vport, n, &dp->ports[i], dp_hash_node) {\n\t\t\t\tif (vport->ops->type == OVS_VPORT_TYPE_INTERNAL)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tif (!(netif_is_ovs_port(vport->dev)))\n\t\t\t\t\tdp_detach_port_notify(vport);\n\t\t\t}\n\t\t}\n\t}\n\tovs_unlock();\n}\n\nstatic int dp_device_event(struct notifier_block *unused, unsigned long event,\n\t\t\t   void *ptr)\n{\n\tstruct ovs_net *ovs_net;\n\tstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\n\tstruct vport *vport = NULL;\n\n\tif (!ovs_is_internal_dev(dev))\n\t\tvport = ovs_netdev_get_vport(dev);\n\n\tif (!vport)\n\t\treturn NOTIFY_DONE;\n\n\tif (event == NETDEV_UNREGISTER) {\n\t\t \n\t\tovs_netdev_detach_dev(vport);\n\n\t\t \n\t\tovs_net = net_generic(dev_net(dev), ovs_net_id);\n\t\tqueue_work(system_wq, &ovs_net->dp_notify_work);\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstruct notifier_block ovs_dp_device_notifier = {\n\t.notifier_call = dp_device_event\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}