{
  "module_name": "devlink.c",
  "hash_id": "402289d4e1d26aae97560caf89aad9bc3365df9bb5d8ed6dfbc4c9c3fb141ffd",
  "original_prompt": "Ingested from linux-6.6.14/net/dsa/devlink.c",
  "human_readable_source": "\n \n\n#include <net/dsa.h>\n#include <net/devlink.h>\n\n#include \"devlink.h\"\n\nstatic int dsa_devlink_info_get(struct devlink *dl,\n\t\t\t\tstruct devlink_info_req *req,\n\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (ds->ops->devlink_info_get)\n\t\treturn ds->ops->devlink_info_get(ds, req, extack);\n\n\treturn -EOPNOTSUPP;\n}\n\nstatic int dsa_devlink_sb_pool_get(struct devlink *dl,\n\t\t\t\t   unsigned int sb_index, u16 pool_index,\n\t\t\t\t   struct devlink_sb_pool_info *pool_info)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (!ds->ops->devlink_sb_pool_get)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_pool_get(ds, sb_index, pool_index,\n\t\t\t\t\t    pool_info);\n}\n\nstatic int dsa_devlink_sb_pool_set(struct devlink *dl, unsigned int sb_index,\n\t\t\t\t   u16 pool_index, u32 size,\n\t\t\t\t   enum devlink_sb_threshold_type threshold_type,\n\t\t\t\t   struct netlink_ext_ack *extack)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (!ds->ops->devlink_sb_pool_set)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_pool_set(ds, sb_index, pool_index, size,\n\t\t\t\t\t    threshold_type, extack);\n}\n\nstatic int dsa_devlink_sb_port_pool_get(struct devlink_port *dlp,\n\t\t\t\t\tunsigned int sb_index, u16 pool_index,\n\t\t\t\t\tu32 *p_threshold)\n{\n\tstruct dsa_switch *ds = dsa_devlink_port_to_ds(dlp);\n\tint port = dsa_devlink_port_to_port(dlp);\n\n\tif (!ds->ops->devlink_sb_port_pool_get)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_port_pool_get(ds, port, sb_index,\n\t\t\t\t\t\t pool_index, p_threshold);\n}\n\nstatic int dsa_devlink_sb_port_pool_set(struct devlink_port *dlp,\n\t\t\t\t\tunsigned int sb_index, u16 pool_index,\n\t\t\t\t\tu32 threshold,\n\t\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct dsa_switch *ds = dsa_devlink_port_to_ds(dlp);\n\tint port = dsa_devlink_port_to_port(dlp);\n\n\tif (!ds->ops->devlink_sb_port_pool_set)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_port_pool_set(ds, port, sb_index,\n\t\t\t\t\t\t pool_index, threshold, extack);\n}\n\nstatic int\ndsa_devlink_sb_tc_pool_bind_get(struct devlink_port *dlp,\n\t\t\t\tunsigned int sb_index, u16 tc_index,\n\t\t\t\tenum devlink_sb_pool_type pool_type,\n\t\t\t\tu16 *p_pool_index, u32 *p_threshold)\n{\n\tstruct dsa_switch *ds = dsa_devlink_port_to_ds(dlp);\n\tint port = dsa_devlink_port_to_port(dlp);\n\n\tif (!ds->ops->devlink_sb_tc_pool_bind_get)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_tc_pool_bind_get(ds, port, sb_index,\n\t\t\t\t\t\t    tc_index, pool_type,\n\t\t\t\t\t\t    p_pool_index, p_threshold);\n}\n\nstatic int\ndsa_devlink_sb_tc_pool_bind_set(struct devlink_port *dlp,\n\t\t\t\tunsigned int sb_index, u16 tc_index,\n\t\t\t\tenum devlink_sb_pool_type pool_type,\n\t\t\t\tu16 pool_index, u32 threshold,\n\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct dsa_switch *ds = dsa_devlink_port_to_ds(dlp);\n\tint port = dsa_devlink_port_to_port(dlp);\n\n\tif (!ds->ops->devlink_sb_tc_pool_bind_set)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_tc_pool_bind_set(ds, port, sb_index,\n\t\t\t\t\t\t    tc_index, pool_type,\n\t\t\t\t\t\t    pool_index, threshold,\n\t\t\t\t\t\t    extack);\n}\n\nstatic int dsa_devlink_sb_occ_snapshot(struct devlink *dl,\n\t\t\t\t       unsigned int sb_index)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (!ds->ops->devlink_sb_occ_snapshot)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_occ_snapshot(ds, sb_index);\n}\n\nstatic int dsa_devlink_sb_occ_max_clear(struct devlink *dl,\n\t\t\t\t\tunsigned int sb_index)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (!ds->ops->devlink_sb_occ_max_clear)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_occ_max_clear(ds, sb_index);\n}\n\nstatic int dsa_devlink_sb_occ_port_pool_get(struct devlink_port *dlp,\n\t\t\t\t\t    unsigned int sb_index,\n\t\t\t\t\t    u16 pool_index, u32 *p_cur,\n\t\t\t\t\t    u32 *p_max)\n{\n\tstruct dsa_switch *ds = dsa_devlink_port_to_ds(dlp);\n\tint port = dsa_devlink_port_to_port(dlp);\n\n\tif (!ds->ops->devlink_sb_occ_port_pool_get)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_occ_port_pool_get(ds, port, sb_index,\n\t\t\t\t\t\t     pool_index, p_cur, p_max);\n}\n\nstatic int\ndsa_devlink_sb_occ_tc_port_bind_get(struct devlink_port *dlp,\n\t\t\t\t    unsigned int sb_index, u16 tc_index,\n\t\t\t\t    enum devlink_sb_pool_type pool_type,\n\t\t\t\t    u32 *p_cur, u32 *p_max)\n{\n\tstruct dsa_switch *ds = dsa_devlink_port_to_ds(dlp);\n\tint port = dsa_devlink_port_to_port(dlp);\n\n\tif (!ds->ops->devlink_sb_occ_tc_port_bind_get)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_sb_occ_tc_port_bind_get(ds, port,\n\t\t\t\t\t\t\tsb_index, tc_index,\n\t\t\t\t\t\t\tpool_type, p_cur,\n\t\t\t\t\t\t\tp_max);\n}\n\nstatic const struct devlink_ops dsa_devlink_ops = {\n\t.info_get\t\t\t= dsa_devlink_info_get,\n\t.sb_pool_get\t\t\t= dsa_devlink_sb_pool_get,\n\t.sb_pool_set\t\t\t= dsa_devlink_sb_pool_set,\n\t.sb_port_pool_get\t\t= dsa_devlink_sb_port_pool_get,\n\t.sb_port_pool_set\t\t= dsa_devlink_sb_port_pool_set,\n\t.sb_tc_pool_bind_get\t\t= dsa_devlink_sb_tc_pool_bind_get,\n\t.sb_tc_pool_bind_set\t\t= dsa_devlink_sb_tc_pool_bind_set,\n\t.sb_occ_snapshot\t\t= dsa_devlink_sb_occ_snapshot,\n\t.sb_occ_max_clear\t\t= dsa_devlink_sb_occ_max_clear,\n\t.sb_occ_port_pool_get\t\t= dsa_devlink_sb_occ_port_pool_get,\n\t.sb_occ_tc_port_bind_get\t= dsa_devlink_sb_occ_tc_port_bind_get,\n};\n\nint dsa_devlink_param_get(struct devlink *dl, u32 id,\n\t\t\t  struct devlink_param_gset_ctx *ctx)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (!ds->ops->devlink_param_get)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_param_get(ds, id, ctx);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_param_get);\n\nint dsa_devlink_param_set(struct devlink *dl, u32 id,\n\t\t\t  struct devlink_param_gset_ctx *ctx)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\n\tif (!ds->ops->devlink_param_set)\n\t\treturn -EOPNOTSUPP;\n\n\treturn ds->ops->devlink_param_set(ds, id, ctx);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_param_set);\n\nint dsa_devlink_params_register(struct dsa_switch *ds,\n\t\t\t\tconst struct devlink_param *params,\n\t\t\t\tsize_t params_count)\n{\n\treturn devlink_params_register(ds->devlink, params, params_count);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_params_register);\n\nvoid dsa_devlink_params_unregister(struct dsa_switch *ds,\n\t\t\t\t   const struct devlink_param *params,\n\t\t\t\t   size_t params_count)\n{\n\tdevlink_params_unregister(ds->devlink, params, params_count);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_params_unregister);\n\nint dsa_devlink_resource_register(struct dsa_switch *ds,\n\t\t\t\t  const char *resource_name,\n\t\t\t\t  u64 resource_size,\n\t\t\t\t  u64 resource_id,\n\t\t\t\t  u64 parent_resource_id,\n\t\t\t\t  const struct devlink_resource_size_params *size_params)\n{\n\treturn devlink_resource_register(ds->devlink, resource_name,\n\t\t\t\t\t resource_size, resource_id,\n\t\t\t\t\t parent_resource_id,\n\t\t\t\t\t size_params);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_resource_register);\n\nvoid dsa_devlink_resources_unregister(struct dsa_switch *ds)\n{\n\tdevlink_resources_unregister(ds->devlink);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_resources_unregister);\n\nvoid dsa_devlink_resource_occ_get_register(struct dsa_switch *ds,\n\t\t\t\t\t   u64 resource_id,\n\t\t\t\t\t   devlink_resource_occ_get_t *occ_get,\n\t\t\t\t\t   void *occ_get_priv)\n{\n\treturn devlink_resource_occ_get_register(ds->devlink, resource_id,\n\t\t\t\t\t\t occ_get, occ_get_priv);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_resource_occ_get_register);\n\nvoid dsa_devlink_resource_occ_get_unregister(struct dsa_switch *ds,\n\t\t\t\t\t     u64 resource_id)\n{\n\tdevlink_resource_occ_get_unregister(ds->devlink, resource_id);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_resource_occ_get_unregister);\n\nstruct devlink_region *\ndsa_devlink_region_create(struct dsa_switch *ds,\n\t\t\t  const struct devlink_region_ops *ops,\n\t\t\t  u32 region_max_snapshots, u64 region_size)\n{\n\treturn devlink_region_create(ds->devlink, ops, region_max_snapshots,\n\t\t\t\t     region_size);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_region_create);\n\nstruct devlink_region *\ndsa_devlink_port_region_create(struct dsa_switch *ds,\n\t\t\t       int port,\n\t\t\t       const struct devlink_port_region_ops *ops,\n\t\t\t       u32 region_max_snapshots, u64 region_size)\n{\n\tstruct dsa_port *dp = dsa_to_port(ds, port);\n\n\treturn devlink_port_region_create(&dp->devlink_port, ops,\n\t\t\t\t\t  region_max_snapshots,\n\t\t\t\t\t  region_size);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_port_region_create);\n\nvoid dsa_devlink_region_destroy(struct devlink_region *region)\n{\n\tdevlink_region_destroy(region);\n}\nEXPORT_SYMBOL_GPL(dsa_devlink_region_destroy);\n\nint dsa_port_devlink_setup(struct dsa_port *dp)\n{\n\tstruct devlink_port *dlp = &dp->devlink_port;\n\tstruct dsa_switch_tree *dst = dp->ds->dst;\n\tstruct devlink_port_attrs attrs = {};\n\tstruct devlink *dl = dp->ds->devlink;\n\tstruct dsa_switch *ds = dp->ds;\n\tconst unsigned char *id;\n\tunsigned char len;\n\tint err;\n\n\tmemset(dlp, 0, sizeof(*dlp));\n\tdevlink_port_init(dl, dlp);\n\n\tif (ds->ops->port_setup) {\n\t\terr = ds->ops->port_setup(ds, dp->index);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tid = (const unsigned char *)&dst->index;\n\tlen = sizeof(dst->index);\n\n\tattrs.phys.port_number = dp->index;\n\tmemcpy(attrs.switch_id.id, id, len);\n\tattrs.switch_id.id_len = len;\n\n\tswitch (dp->type) {\n\tcase DSA_PORT_TYPE_UNUSED:\n\t\tattrs.flavour = DEVLINK_PORT_FLAVOUR_UNUSED;\n\t\tbreak;\n\tcase DSA_PORT_TYPE_CPU:\n\t\tattrs.flavour = DEVLINK_PORT_FLAVOUR_CPU;\n\t\tbreak;\n\tcase DSA_PORT_TYPE_DSA:\n\t\tattrs.flavour = DEVLINK_PORT_FLAVOUR_DSA;\n\t\tbreak;\n\tcase DSA_PORT_TYPE_USER:\n\t\tattrs.flavour = DEVLINK_PORT_FLAVOUR_PHYSICAL;\n\t\tbreak;\n\t}\n\n\tdevlink_port_attrs_set(dlp, &attrs);\n\terr = devlink_port_register(dl, dlp, dp->index);\n\tif (err) {\n\t\tif (ds->ops->port_teardown)\n\t\t\tds->ops->port_teardown(ds, dp->index);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nvoid dsa_port_devlink_teardown(struct dsa_port *dp)\n{\n\tstruct devlink_port *dlp = &dp->devlink_port;\n\tstruct dsa_switch *ds = dp->ds;\n\n\tdevlink_port_unregister(dlp);\n\n\tif (ds->ops->port_teardown)\n\t\tds->ops->port_teardown(ds, dp->index);\n\n\tdevlink_port_fini(dlp);\n}\n\nvoid dsa_switch_devlink_register(struct dsa_switch *ds)\n{\n\tdevlink_register(ds->devlink);\n}\n\nvoid dsa_switch_devlink_unregister(struct dsa_switch *ds)\n{\n\tdevlink_unregister(ds->devlink);\n}\n\nint dsa_switch_devlink_alloc(struct dsa_switch *ds)\n{\n\tstruct dsa_devlink_priv *dl_priv;\n\tstruct devlink *dl;\n\n\t \n\tdl = devlink_alloc(&dsa_devlink_ops, sizeof(*dl_priv), ds->dev);\n\tif (!dl)\n\t\treturn -ENOMEM;\n\n\tds->devlink = dl;\n\n\tdl_priv = devlink_priv(ds->devlink);\n\tdl_priv->ds = ds;\n\n\treturn 0;\n}\n\nvoid dsa_switch_devlink_free(struct dsa_switch *ds)\n{\n\tdevlink_free(ds->devlink);\n\tds->devlink = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}