{
  "module_name": "tag_ar9331.c",
  "hash_id": "b606fead7263ed90dcfdc65a507ceb17873f4b19774ce56865844af0ea455db4",
  "original_prompt": "Ingested from linux-6.6.14/net/dsa/tag_ar9331.c",
  "human_readable_source": "\n \n\n\n#include <linux/bitfield.h>\n#include <linux/etherdevice.h>\n\n#include \"tag.h\"\n\n#define AR9331_NAME\t\t\t\"ar9331\"\n\n#define AR9331_HDR_LEN\t\t\t2\n#define AR9331_HDR_VERSION\t\t1\n\n#define AR9331_HDR_VERSION_MASK\t\tGENMASK(15, 14)\n#define AR9331_HDR_PRIORITY_MASK\tGENMASK(13, 12)\n#define AR9331_HDR_TYPE_MASK\t\tGENMASK(10, 8)\n#define AR9331_HDR_BROADCAST\t\tBIT(7)\n#define AR9331_HDR_FROM_CPU\t\tBIT(6)\n \n#define AR9331_HDR_RESERVED_MASK\tGENMASK(5, 4)\n#define AR9331_HDR_PORT_NUM_MASK\tGENMASK(3, 0)\n\nstatic struct sk_buff *ar9331_tag_xmit(struct sk_buff *skb,\n\t\t\t\t       struct net_device *dev)\n{\n\tstruct dsa_port *dp = dsa_slave_to_port(dev);\n\t__le16 *phdr;\n\tu16 hdr;\n\n\tphdr = skb_push(skb, AR9331_HDR_LEN);\n\n\thdr = FIELD_PREP(AR9331_HDR_VERSION_MASK, AR9331_HDR_VERSION);\n\thdr |= AR9331_HDR_FROM_CPU | dp->index;\n\t \n\thdr |= AR9331_HDR_RESERVED_MASK;\n\n\tphdr[0] = cpu_to_le16(hdr);\n\n\treturn skb;\n}\n\nstatic struct sk_buff *ar9331_tag_rcv(struct sk_buff *skb,\n\t\t\t\t      struct net_device *ndev)\n{\n\tu8 ver, port;\n\tu16 hdr;\n\n\tif (unlikely(!pskb_may_pull(skb, AR9331_HDR_LEN)))\n\t\treturn NULL;\n\n\thdr = le16_to_cpu(*(__le16 *)skb_mac_header(skb));\n\n\tver = FIELD_GET(AR9331_HDR_VERSION_MASK, hdr);\n\tif (unlikely(ver != AR9331_HDR_VERSION)) {\n\t\tnetdev_warn_once(ndev, \"%s:%i wrong header version 0x%2x\\n\",\n\t\t\t\t __func__, __LINE__, hdr);\n\t\treturn NULL;\n\t}\n\n\tif (unlikely(hdr & AR9331_HDR_FROM_CPU)) {\n\t\tnetdev_warn_once(ndev, \"%s:%i packet should not be from cpu 0x%2x\\n\",\n\t\t\t\t __func__, __LINE__, hdr);\n\t\treturn NULL;\n\t}\n\n\tskb_pull_rcsum(skb, AR9331_HDR_LEN);\n\n\t \n\tport = FIELD_GET(AR9331_HDR_PORT_NUM_MASK, hdr);\n\n\tskb->dev = dsa_master_find_slave(ndev, 0, port);\n\tif (!skb->dev)\n\t\treturn NULL;\n\n\treturn skb;\n}\n\nstatic const struct dsa_device_ops ar9331_netdev_ops = {\n\t.name\t= AR9331_NAME,\n\t.proto\t= DSA_TAG_PROTO_AR9331,\n\t.xmit\t= ar9331_tag_xmit,\n\t.rcv\t= ar9331_tag_rcv,\n\t.needed_headroom = AR9331_HDR_LEN,\n};\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS_DSA_TAG_DRIVER(DSA_TAG_PROTO_AR9331, AR9331_NAME);\nmodule_dsa_tag_driver(ar9331_netdev_ops);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}