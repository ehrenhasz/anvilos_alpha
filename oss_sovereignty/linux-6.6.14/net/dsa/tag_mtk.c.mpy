{
  "module_name": "tag_mtk.c",
  "hash_id": "c9cf7ea86a5d6d73054e2d416dd5c7a29a829e569b026440dad97d8983bcfd81",
  "original_prompt": "Ingested from linux-6.6.14/net/dsa/tag_mtk.c",
  "human_readable_source": "\n \n\n#include <linux/etherdevice.h>\n#include <linux/if_vlan.h>\n\n#include \"tag.h\"\n\n#define MTK_NAME\t\t\"mtk\"\n\n#define MTK_HDR_LEN\t\t4\n#define MTK_HDR_XMIT_UNTAGGED\t\t0\n#define MTK_HDR_XMIT_TAGGED_TPID_8100\t1\n#define MTK_HDR_XMIT_TAGGED_TPID_88A8\t2\n#define MTK_HDR_RECV_SOURCE_PORT_MASK\tGENMASK(2, 0)\n#define MTK_HDR_XMIT_DP_BIT_MASK\tGENMASK(5, 0)\n#define MTK_HDR_XMIT_SA_DIS\t\tBIT(6)\n\nstatic struct sk_buff *mtk_tag_xmit(struct sk_buff *skb,\n\t\t\t\t    struct net_device *dev)\n{\n\tstruct dsa_port *dp = dsa_slave_to_port(dev);\n\tu8 xmit_tpid;\n\tu8 *mtk_tag;\n\n\tskb_set_queue_mapping(skb, dp->index);\n\n\t \n\tswitch (skb->protocol) {\n\tcase htons(ETH_P_8021Q):\n\t\txmit_tpid = MTK_HDR_XMIT_TAGGED_TPID_8100;\n\t\tbreak;\n\tcase htons(ETH_P_8021AD):\n\t\txmit_tpid = MTK_HDR_XMIT_TAGGED_TPID_88A8;\n\t\tbreak;\n\tdefault:\n\t\txmit_tpid = MTK_HDR_XMIT_UNTAGGED;\n\t\tskb_push(skb, MTK_HDR_LEN);\n\t\tdsa_alloc_etype_header(skb, MTK_HDR_LEN);\n\t}\n\n\tmtk_tag = dsa_etype_header_pos_tx(skb);\n\n\t \n\tmtk_tag[0] = xmit_tpid;\n\tmtk_tag[1] = (1 << dp->index) & MTK_HDR_XMIT_DP_BIT_MASK;\n\n\t \n\tif (xmit_tpid == MTK_HDR_XMIT_UNTAGGED) {\n\t\tmtk_tag[2] = 0;\n\t\tmtk_tag[3] = 0;\n\t}\n\n\treturn skb;\n}\n\nstatic struct sk_buff *mtk_tag_rcv(struct sk_buff *skb, struct net_device *dev)\n{\n\tu16 hdr;\n\tint port;\n\t__be16 *phdr;\n\n\tif (unlikely(!pskb_may_pull(skb, MTK_HDR_LEN)))\n\t\treturn NULL;\n\n\tphdr = dsa_etype_header_pos_rx(skb);\n\thdr = ntohs(*phdr);\n\n\t \n\tskb_pull_rcsum(skb, MTK_HDR_LEN);\n\n\tdsa_strip_etype_header(skb, MTK_HDR_LEN);\n\n\t \n\tport = (hdr & MTK_HDR_RECV_SOURCE_PORT_MASK);\n\n\tskb->dev = dsa_master_find_slave(dev, 0, port);\n\tif (!skb->dev)\n\t\treturn NULL;\n\n\tdsa_default_offload_fwd_mark(skb);\n\n\treturn skb;\n}\n\nstatic const struct dsa_device_ops mtk_netdev_ops = {\n\t.name\t\t= MTK_NAME,\n\t.proto\t\t= DSA_TAG_PROTO_MTK,\n\t.xmit\t\t= mtk_tag_xmit,\n\t.rcv\t\t= mtk_tag_rcv,\n\t.needed_headroom = MTK_HDR_LEN,\n};\n\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS_DSA_TAG_DRIVER(DSA_TAG_PROTO_MTK, MTK_NAME);\n\nmodule_dsa_tag_driver(mtk_netdev_ops);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}