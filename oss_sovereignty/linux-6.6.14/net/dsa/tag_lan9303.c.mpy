{
  "module_name": "tag_lan9303.c",
  "hash_id": "49c0b5750355f8baf0afdbd1eccee65541c3262fd234cc7ecba6b20acb86e094",
  "original_prompt": "Ingested from linux-6.6.14/net/dsa/tag_lan9303.c",
  "human_readable_source": "\n \n#include <linux/dsa/lan9303.h>\n#include <linux/etherdevice.h>\n#include <linux/list.h>\n#include <linux/slab.h>\n\n#include \"tag.h\"\n\n \n\n#define LAN9303_NAME \"lan9303\"\n\n#define LAN9303_TAG_LEN 4\n# define LAN9303_TAG_TX_USE_ALR BIT(3)\n# define LAN9303_TAG_TX_STP_OVERRIDE BIT(4)\n# define LAN9303_TAG_RX_IGMP BIT(3)\n# define LAN9303_TAG_RX_STP BIT(4)\n# define LAN9303_TAG_RX_TRAPPED_TO_CPU (LAN9303_TAG_RX_IGMP | \\\n\t\t\t\t\tLAN9303_TAG_RX_STP)\n\n \nstatic int lan9303_xmit_use_arl(struct dsa_port *dp, u8 *dest_addr)\n{\n\tstruct lan9303 *chip = dp->ds->priv;\n\n\treturn chip->is_bridged && !is_multicast_ether_addr(dest_addr);\n}\n\nstatic struct sk_buff *lan9303_xmit(struct sk_buff *skb, struct net_device *dev)\n{\n\tstruct dsa_port *dp = dsa_slave_to_port(dev);\n\t__be16 *lan9303_tag;\n\tu16 tag;\n\n\t \n\tskb_push(skb, LAN9303_TAG_LEN);\n\n\t \n\tdsa_alloc_etype_header(skb, LAN9303_TAG_LEN);\n\n\tlan9303_tag = dsa_etype_header_pos_tx(skb);\n\n\ttag = lan9303_xmit_use_arl(dp, skb->data) ?\n\t\tLAN9303_TAG_TX_USE_ALR :\n\t\tdp->index | LAN9303_TAG_TX_STP_OVERRIDE;\n\tlan9303_tag[0] = htons(ETH_P_8021Q);\n\tlan9303_tag[1] = htons(tag);\n\n\treturn skb;\n}\n\nstatic struct sk_buff *lan9303_rcv(struct sk_buff *skb, struct net_device *dev)\n{\n\tu16 lan9303_tag1;\n\tunsigned int source_port;\n\n\tif (unlikely(!pskb_may_pull(skb, LAN9303_TAG_LEN))) {\n\t\tdev_warn_ratelimited(&dev->dev,\n\t\t\t\t     \"Dropping packet, cannot pull\\n\");\n\t\treturn NULL;\n\t}\n\n\tif (skb_vlan_tag_present(skb)) {\n\t\tlan9303_tag1 = skb_vlan_tag_get(skb);\n\t\t__vlan_hwaccel_clear_tag(skb);\n\t} else {\n\t\tskb_push_rcsum(skb, ETH_HLEN);\n\t\t__skb_vlan_pop(skb, &lan9303_tag1);\n\t\tskb_pull_rcsum(skb, ETH_HLEN);\n\t}\n\n\tsource_port = lan9303_tag1 & 0x3;\n\n\tskb->dev = dsa_master_find_slave(dev, 0, source_port);\n\tif (!skb->dev) {\n\t\tdev_warn_ratelimited(&dev->dev, \"Dropping packet due to invalid source port\\n\");\n\t\treturn NULL;\n\t}\n\n\tif (!(lan9303_tag1 & LAN9303_TAG_RX_TRAPPED_TO_CPU))\n\t\tdsa_default_offload_fwd_mark(skb);\n\n\treturn skb;\n}\n\nstatic const struct dsa_device_ops lan9303_netdev_ops = {\n\t.name = LAN9303_NAME,\n\t.proto\t= DSA_TAG_PROTO_LAN9303,\n\t.xmit = lan9303_xmit,\n\t.rcv = lan9303_rcv,\n\t.needed_headroom = LAN9303_TAG_LEN,\n};\n\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS_DSA_TAG_DRIVER(DSA_TAG_PROTO_LAN9303, LAN9303_NAME);\n\nmodule_dsa_tag_driver(lan9303_netdev_ops);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}