{
  "module_name": "tcp_lp.c",
  "hash_id": "8e9b04d1476b0f4499fe07c4baa30a010b1ac1b6159a0b461396c362f1db2efb",
  "original_prompt": "Ingested from linux-6.6.14/net/ipv4/tcp_lp.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <net/tcp.h>\n\n \n#define LP_RESOL       TCP_TS_HZ\n\n \nenum tcp_lp_state {\n\tLP_VALID_RHZ = (1 << 0),\n\tLP_VALID_OWD = (1 << 1),\n\tLP_WITHIN_THR = (1 << 3),\n\tLP_WITHIN_INF = (1 << 4),\n};\n\n \nstruct lp {\n\tu32 flag;\n\tu32 sowd;\n\tu32 owd_min;\n\tu32 owd_max;\n\tu32 owd_max_rsv;\n\tu32 remote_hz;\n\tu32 remote_ref_time;\n\tu32 local_ref_time;\n\tu32 last_drop;\n\tu32 inference;\n};\n\n \nstatic void tcp_lp_init(struct sock *sk)\n{\n\tstruct lp *lp = inet_csk_ca(sk);\n\n\tlp->flag = 0;\n\tlp->sowd = 0;\n\tlp->owd_min = 0xffffffff;\n\tlp->owd_max = 0;\n\tlp->owd_max_rsv = 0;\n\tlp->remote_hz = 0;\n\tlp->remote_ref_time = 0;\n\tlp->local_ref_time = 0;\n\tlp->last_drop = 0;\n\tlp->inference = 0;\n}\n\n \nstatic void tcp_lp_cong_avoid(struct sock *sk, u32 ack, u32 acked)\n{\n\tstruct lp *lp = inet_csk_ca(sk);\n\n\tif (!(lp->flag & LP_WITHIN_INF))\n\t\ttcp_reno_cong_avoid(sk, ack, acked);\n}\n\n \nstatic u32 tcp_lp_remote_hz_estimator(struct sock *sk)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct lp *lp = inet_csk_ca(sk);\n\ts64 rhz = lp->remote_hz << 6;\t \n\ts64 m = 0;\n\n\t \n\tif (lp->remote_ref_time == 0 || lp->local_ref_time == 0)\n\t\tgoto out;\n\n\t \n\tif (tp->rx_opt.rcv_tsval == lp->remote_ref_time ||\n\t    tp->rx_opt.rcv_tsecr == lp->local_ref_time)\n\t\tgoto out;\n\n\tm = TCP_TS_HZ *\n\t    (tp->rx_opt.rcv_tsval - lp->remote_ref_time) /\n\t    (tp->rx_opt.rcv_tsecr - lp->local_ref_time);\n\tif (m < 0)\n\t\tm = -m;\n\n\tif (rhz > 0) {\n\t\tm -= rhz >> 6;\t \n\t\trhz += m;\t \n\t} else\n\t\trhz = m << 6;\n\n out:\n\t \n\tif ((rhz >> 6) > 0)\n\t\tlp->flag |= LP_VALID_RHZ;\n\telse\n\t\tlp->flag &= ~LP_VALID_RHZ;\n\n\t \n\tlp->remote_ref_time = tp->rx_opt.rcv_tsval;\n\tlp->local_ref_time = tp->rx_opt.rcv_tsecr;\n\n\treturn rhz >> 6;\n}\n\n \nstatic u32 tcp_lp_owd_calculator(struct sock *sk)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct lp *lp = inet_csk_ca(sk);\n\ts64 owd = 0;\n\n\tlp->remote_hz = tcp_lp_remote_hz_estimator(sk);\n\n\tif (lp->flag & LP_VALID_RHZ) {\n\t\towd =\n\t\t    tp->rx_opt.rcv_tsval * (LP_RESOL / lp->remote_hz) -\n\t\t    tp->rx_opt.rcv_tsecr * (LP_RESOL / TCP_TS_HZ);\n\t\tif (owd < 0)\n\t\t\towd = -owd;\n\t}\n\n\tif (owd > 0)\n\t\tlp->flag |= LP_VALID_OWD;\n\telse\n\t\tlp->flag &= ~LP_VALID_OWD;\n\n\treturn owd;\n}\n\n \nstatic void tcp_lp_rtt_sample(struct sock *sk, u32 rtt)\n{\n\tstruct lp *lp = inet_csk_ca(sk);\n\ts64 mowd = tcp_lp_owd_calculator(sk);\n\n\t \n\tif (!(lp->flag & LP_VALID_RHZ) || !(lp->flag & LP_VALID_OWD))\n\t\treturn;\n\n\t \n\tif (mowd < lp->owd_min)\n\t\tlp->owd_min = mowd;\n\n\t \n\tif (mowd > lp->owd_max) {\n\t\tif (mowd > lp->owd_max_rsv) {\n\t\t\tif (lp->owd_max_rsv == 0)\n\t\t\t\tlp->owd_max = mowd;\n\t\t\telse\n\t\t\t\tlp->owd_max = lp->owd_max_rsv;\n\t\t\tlp->owd_max_rsv = mowd;\n\t\t} else\n\t\t\tlp->owd_max = mowd;\n\t}\n\n\t \n\tif (lp->sowd != 0) {\n\t\tmowd -= lp->sowd >> 3;\t \n\t\tlp->sowd += mowd;\t \n\t} else\n\t\tlp->sowd = mowd << 3;\t \n}\n\n \nstatic void tcp_lp_pkts_acked(struct sock *sk, const struct ack_sample *sample)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct lp *lp = inet_csk_ca(sk);\n\tu32 now = tcp_time_stamp(tp);\n\tu32 delta;\n\n\tif (sample->rtt_us > 0)\n\t\ttcp_lp_rtt_sample(sk, sample->rtt_us);\n\n\t \n\tdelta = now - tp->rx_opt.rcv_tsecr;\n\tif ((s32)delta > 0)\n\t\tlp->inference = 3 * delta;\n\n\t \n\tif (lp->last_drop && (now - lp->last_drop < lp->inference))\n\t\tlp->flag |= LP_WITHIN_INF;\n\telse\n\t\tlp->flag &= ~LP_WITHIN_INF;\n\n\t \n\tif (lp->sowd >> 3 <\n\t    lp->owd_min + 15 * (lp->owd_max - lp->owd_min) / 100)\n\t\tlp->flag |= LP_WITHIN_THR;\n\telse\n\t\tlp->flag &= ~LP_WITHIN_THR;\n\n\tpr_debug(\"TCP-LP: %05o|%5u|%5u|%15u|%15u|%15u\\n\", lp->flag,\n\t\t tcp_snd_cwnd(tp), lp->remote_hz, lp->owd_min, lp->owd_max,\n\t\t lp->sowd >> 3);\n\n\tif (lp->flag & LP_WITHIN_THR)\n\t\treturn;\n\n\t \n\tlp->owd_min = lp->sowd >> 3;\n\tlp->owd_max = lp->sowd >> 2;\n\tlp->owd_max_rsv = lp->sowd >> 2;\n\n\t \n\tif (lp->flag & LP_WITHIN_INF)\n\t\ttcp_snd_cwnd_set(tp, 1U);\n\n\t \n\telse\n\t\ttcp_snd_cwnd_set(tp, max(tcp_snd_cwnd(tp) >> 1U, 1U));\n\n\t \n\tlp->last_drop = now;\n}\n\nstatic struct tcp_congestion_ops tcp_lp __read_mostly = {\n\t.init = tcp_lp_init,\n\t.ssthresh = tcp_reno_ssthresh,\n\t.undo_cwnd = tcp_reno_undo_cwnd,\n\t.cong_avoid = tcp_lp_cong_avoid,\n\t.pkts_acked = tcp_lp_pkts_acked,\n\n\t.owner = THIS_MODULE,\n\t.name = \"lp\"\n};\n\nstatic int __init tcp_lp_register(void)\n{\n\tBUILD_BUG_ON(sizeof(struct lp) > ICSK_CA_PRIV_SIZE);\n\treturn tcp_register_congestion_control(&tcp_lp);\n}\n\nstatic void __exit tcp_lp_unregister(void)\n{\n\ttcp_unregister_congestion_control(&tcp_lp);\n}\n\nmodule_init(tcp_lp_register);\nmodule_exit(tcp_lp_unregister);\n\nMODULE_AUTHOR(\"Wong Hoi Sing Edison, Hung Hing Lun Mike\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"TCP Low Priority\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}