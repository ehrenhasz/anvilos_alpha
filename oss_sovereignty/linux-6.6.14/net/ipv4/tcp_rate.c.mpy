{
  "module_name": "tcp_rate.c",
  "hash_id": "4e7e690f549be3fa3b332c9727770c6c2b37dcda88339ab41c15dec82bebefd3",
  "original_prompt": "Ingested from linux-6.6.14/net/ipv4/tcp_rate.c",
  "human_readable_source": "\n#include <net/tcp.h>\n\n \n\n \nvoid tcp_rate_skb_sent(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\n\t  \n\tif (!tp->packets_out) {\n\t\tu64 tstamp_us = tcp_skb_timestamp_us(skb);\n\n\t\ttp->first_tx_mstamp  = tstamp_us;\n\t\ttp->delivered_mstamp = tstamp_us;\n\t}\n\n\tTCP_SKB_CB(skb)->tx.first_tx_mstamp\t= tp->first_tx_mstamp;\n\tTCP_SKB_CB(skb)->tx.delivered_mstamp\t= tp->delivered_mstamp;\n\tTCP_SKB_CB(skb)->tx.delivered\t\t= tp->delivered;\n\tTCP_SKB_CB(skb)->tx.delivered_ce\t= tp->delivered_ce;\n\tTCP_SKB_CB(skb)->tx.is_app_limited\t= tp->app_limited ? 1 : 0;\n}\n\n \nvoid tcp_rate_skb_delivered(struct sock *sk, struct sk_buff *skb,\n\t\t\t    struct rate_sample *rs)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct tcp_skb_cb *scb = TCP_SKB_CB(skb);\n\tu64 tx_tstamp;\n\n\tif (!scb->tx.delivered_mstamp)\n\t\treturn;\n\n\ttx_tstamp = tcp_skb_timestamp_us(skb);\n\tif (!rs->prior_delivered ||\n\t    tcp_skb_sent_after(tx_tstamp, tp->first_tx_mstamp,\n\t\t\t       scb->end_seq, rs->last_end_seq)) {\n\t\trs->prior_delivered_ce  = scb->tx.delivered_ce;\n\t\trs->prior_delivered  = scb->tx.delivered;\n\t\trs->prior_mstamp     = scb->tx.delivered_mstamp;\n\t\trs->is_app_limited   = scb->tx.is_app_limited;\n\t\trs->is_retrans\t     = scb->sacked & TCPCB_RETRANS;\n\t\trs->last_end_seq     = scb->end_seq;\n\n\t\t \n\t\ttp->first_tx_mstamp  = tx_tstamp;\n\t\t \n\t\trs->interval_us = tcp_stamp_us_delta(tp->first_tx_mstamp,\n\t\t\t\t\t\t     scb->tx.first_tx_mstamp);\n\n\t}\n\t \n\tif (scb->sacked & TCPCB_SACKED_ACKED)\n\t\tscb->tx.delivered_mstamp = 0;\n}\n\n \nvoid tcp_rate_gen(struct sock *sk, u32 delivered, u32 lost,\n\t\t  bool is_sack_reneg, struct rate_sample *rs)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tu32 snd_us, ack_us;\n\n\t \n\tif (tp->app_limited && after(tp->delivered, tp->app_limited))\n\t\ttp->app_limited = 0;\n\n\t \n\tif (delivered)\n\t\ttp->delivered_mstamp = tp->tcp_mstamp;\n\n\trs->acked_sacked = delivered;\t \n\trs->losses = lost;\t\t \n\t \n\tif (!rs->prior_mstamp || is_sack_reneg) {\n\t\trs->delivered = -1;\n\t\trs->interval_us = -1;\n\t\treturn;\n\t}\n\trs->delivered   = tp->delivered - rs->prior_delivered;\n\n\trs->delivered_ce = tp->delivered_ce - rs->prior_delivered_ce;\n\t \n\trs->delivered_ce &= TCPCB_DELIVERED_CE_MASK;\n\n\t \n\tsnd_us = rs->interval_us;\t\t\t\t \n\tack_us = tcp_stamp_us_delta(tp->tcp_mstamp,\n\t\t\t\t    rs->prior_mstamp);  \n\trs->interval_us = max(snd_us, ack_us);\n\n\t \n\trs->snd_interval_us = snd_us;\n\trs->rcv_interval_us = ack_us;\n\n\t \n\tif (unlikely(rs->interval_us < tcp_min_rtt(tp))) {\n\t\tif (!rs->is_retrans)\n\t\t\tpr_debug(\"tcp rate: %ld %d %u %u %u\\n\",\n\t\t\t\t rs->interval_us, rs->delivered,\n\t\t\t\t inet_csk(sk)->icsk_ca_state,\n\t\t\t\t tp->rx_opt.sack_ok, tcp_min_rtt(tp));\n\t\trs->interval_us = -1;\n\t\treturn;\n\t}\n\n\t \n\tif (!rs->is_app_limited ||\n\t    ((u64)rs->delivered * tp->rate_interval_us >=\n\t     (u64)tp->rate_delivered * rs->interval_us)) {\n\t\ttp->rate_delivered = rs->delivered;\n\t\ttp->rate_interval_us = rs->interval_us;\n\t\ttp->rate_app_limited = rs->is_app_limited;\n\t}\n}\n\n \nvoid tcp_rate_check_app_limited(struct sock *sk)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\n\tif ( \n\t    tp->write_seq - tp->snd_nxt < tp->mss_cache &&\n\t     \n\t    sk_wmem_alloc_get(sk) < SKB_TRUESIZE(1) &&\n\t     \n\t    tcp_packets_in_flight(tp) < tcp_snd_cwnd(tp) &&\n\t     \n\t    tp->lost_out <= tp->retrans_out)\n\t\ttp->app_limited =\n\t\t\t(tp->delivered + tcp_packets_in_flight(tp)) ? : 1;\n}\nEXPORT_SYMBOL_GPL(tcp_rate_check_app_limited);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}