{
  "module_name": "nf_dup_ipv4.c",
  "hash_id": "75ccb5091d8485f13715a7c7af32b438a56228b15f86c5ec021b4db01cab140c",
  "original_prompt": "Ingested from linux-6.6.14/net/ipv4/netfilter/nf_dup_ipv4.c",
  "human_readable_source": "\n \n#include <linux/ip.h>\n#include <linux/module.h>\n#include <linux/percpu.h>\n#include <linux/route.h>\n#include <linux/skbuff.h>\n#include <linux/netfilter.h>\n#include <net/checksum.h>\n#include <net/icmp.h>\n#include <net/ip.h>\n#include <net/route.h>\n#include <net/netfilter/ipv4/nf_dup_ipv4.h>\n#if IS_ENABLED(CONFIG_NF_CONNTRACK)\n#include <net/netfilter/nf_conntrack.h>\n#endif\n\nstatic bool nf_dup_ipv4_route(struct net *net, struct sk_buff *skb,\n\t\t\t      const struct in_addr *gw, int oif)\n{\n\tconst struct iphdr *iph = ip_hdr(skb);\n\tstruct rtable *rt;\n\tstruct flowi4 fl4;\n\n\tmemset(&fl4, 0, sizeof(fl4));\n\tif (oif != -1)\n\t\tfl4.flowi4_oif = oif;\n\n\tfl4.daddr = gw->s_addr;\n\tfl4.flowi4_tos = RT_TOS(iph->tos);\n\tfl4.flowi4_scope = RT_SCOPE_UNIVERSE;\n\tfl4.flowi4_flags = FLOWI_FLAG_KNOWN_NH;\n\trt = ip_route_output_key(net, &fl4);\n\tif (IS_ERR(rt))\n\t\treturn false;\n\n\tskb_dst_drop(skb);\n\tskb_dst_set(skb, &rt->dst);\n\tskb->dev      = rt->dst.dev;\n\tskb->protocol = htons(ETH_P_IP);\n\n\treturn true;\n}\n\nvoid nf_dup_ipv4(struct net *net, struct sk_buff *skb, unsigned int hooknum,\n\t\t const struct in_addr *gw, int oif)\n{\n\tstruct iphdr *iph;\n\n\tif (this_cpu_read(nf_skb_duplicated))\n\t\treturn;\n\t \n\tskb = pskb_copy(skb, GFP_ATOMIC);\n\tif (skb == NULL)\n\t\treturn;\n\n#if IS_ENABLED(CONFIG_NF_CONNTRACK)\n\t \n\tnf_reset_ct(skb);\n\tnf_ct_set(skb, NULL, IP_CT_UNTRACKED);\n#endif\n\t \n\tiph = ip_hdr(skb);\n\tiph->frag_off |= htons(IP_DF);\n\tif (hooknum == NF_INET_PRE_ROUTING ||\n\t    hooknum == NF_INET_LOCAL_IN)\n\t\t--iph->ttl;\n\n\tif (nf_dup_ipv4_route(net, skb, gw, oif)) {\n\t\t__this_cpu_write(nf_skb_duplicated, true);\n\t\tip_local_out(net, skb->sk, skb);\n\t\t__this_cpu_write(nf_skb_duplicated, false);\n\t} else {\n\t\tkfree_skb(skb);\n\t}\n}\nEXPORT_SYMBOL_GPL(nf_dup_ipv4);\n\nMODULE_AUTHOR(\"Sebastian Cla\u00dfen <sebastian.classen@freenet.ag>\");\nMODULE_AUTHOR(\"Jan Engelhardt <jengelh@medozas.de>\");\nMODULE_DESCRIPTION(\"nf_dup_ipv4: Duplicate IPv4 packet\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}