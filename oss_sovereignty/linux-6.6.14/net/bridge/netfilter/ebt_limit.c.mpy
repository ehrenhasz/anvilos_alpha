{
  "module_name": "ebt_limit.c",
  "hash_id": "76b9f3074065fe82c02018461ab37709ca08fc0a6f0ba22d432a61c7822fe901",
  "original_prompt": "Ingested from linux-6.6.14/net/bridge/netfilter/ebt_limit.c",
  "human_readable_source": "\n \n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/spinlock.h>\n#include <linux/netfilter/x_tables.h>\n#include <linux/netfilter_bridge/ebtables.h>\n#include <linux/netfilter_bridge/ebt_limit.h>\n\nstatic DEFINE_SPINLOCK(limit_lock);\n\n#define MAX_CPJ (0xFFFFFFFF / (HZ*60*60*24))\n\n#define _POW2_BELOW2(x) ((x)|((x)>>1))\n#define _POW2_BELOW4(x) (_POW2_BELOW2(x)|_POW2_BELOW2((x)>>2))\n#define _POW2_BELOW8(x) (_POW2_BELOW4(x)|_POW2_BELOW4((x)>>4))\n#define _POW2_BELOW16(x) (_POW2_BELOW8(x)|_POW2_BELOW8((x)>>8))\n#define _POW2_BELOW32(x) (_POW2_BELOW16(x)|_POW2_BELOW16((x)>>16))\n#define POW2_BELOW32(x) ((_POW2_BELOW32(x)>>1) + 1)\n\n#define CREDITS_PER_JIFFY POW2_BELOW32(MAX_CPJ)\n\nstatic bool\nebt_limit_mt(const struct sk_buff *skb, struct xt_action_param *par)\n{\n\tstruct ebt_limit_info *info = (void *)par->matchinfo;\n\tunsigned long now = jiffies;\n\n\tspin_lock_bh(&limit_lock);\n\tinfo->credit += (now - xchg(&info->prev, now)) * CREDITS_PER_JIFFY;\n\tif (info->credit > info->credit_cap)\n\t\tinfo->credit = info->credit_cap;\n\n\tif (info->credit >= info->cost) {\n\t\t \n\t\tinfo->credit -= info->cost;\n\t\tspin_unlock_bh(&limit_lock);\n\t\treturn true;\n\t}\n\n\tspin_unlock_bh(&limit_lock);\n\treturn false;\n}\n\n \nstatic u_int32_t\nuser2credits(u_int32_t user)\n{\n\t \n\tif (user > 0xFFFFFFFF / (HZ*CREDITS_PER_JIFFY))\n\t\t \n\t\treturn (user / EBT_LIMIT_SCALE) * HZ * CREDITS_PER_JIFFY;\n\n\treturn (user * HZ * CREDITS_PER_JIFFY) / EBT_LIMIT_SCALE;\n}\n\nstatic int ebt_limit_mt_check(const struct xt_mtchk_param *par)\n{\n\tstruct ebt_limit_info *info = par->matchinfo;\n\n\t \n\tif (info->burst == 0 ||\n\t    user2credits(info->avg * info->burst) < user2credits(info->avg)) {\n\t\tpr_info_ratelimited(\"overflow, try lower: %u/%u\\n\",\n\t\t\t\t    info->avg, info->burst);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tinfo->prev = jiffies;\n\tinfo->credit = user2credits(info->avg * info->burst);\n\tinfo->credit_cap = user2credits(info->avg * info->burst);\n\tinfo->cost = user2credits(info->avg);\n\treturn 0;\n}\n\n\n#ifdef CONFIG_NETFILTER_XTABLES_COMPAT\n \nstruct ebt_compat_limit_info {\n\tcompat_uint_t avg, burst;\n\tcompat_ulong_t prev;\n\tcompat_uint_t credit, credit_cap, cost;\n};\n#endif\n\nstatic struct xt_match ebt_limit_mt_reg __read_mostly = {\n\t.name\t\t= \"limit\",\n\t.revision\t= 0,\n\t.family\t\t= NFPROTO_BRIDGE,\n\t.match\t\t= ebt_limit_mt,\n\t.checkentry\t= ebt_limit_mt_check,\n\t.matchsize\t= sizeof(struct ebt_limit_info),\n\t.usersize\t= offsetof(struct ebt_limit_info, prev),\n#ifdef CONFIG_NETFILTER_XTABLES_COMPAT\n\t.compatsize\t= sizeof(struct ebt_compat_limit_info),\n#endif\n\t.me\t\t= THIS_MODULE,\n};\n\nstatic int __init ebt_limit_init(void)\n{\n\treturn xt_register_match(&ebt_limit_mt_reg);\n}\n\nstatic void __exit ebt_limit_fini(void)\n{\n\txt_unregister_match(&ebt_limit_mt_reg);\n}\n\nmodule_init(ebt_limit_init);\nmodule_exit(ebt_limit_fini);\nMODULE_DESCRIPTION(\"Ebtables: Rate-limit match\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}