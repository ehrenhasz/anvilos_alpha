{
  "module_name": "ebt_ip6.c",
  "hash_id": "118ef7373635c17a796494e0212eceb2064eba4e76102995dbcf375f9498de30",
  "original_prompt": "Ingested from linux-6.6.14/net/bridge/netfilter/ebt_ip6.c",
  "human_readable_source": "\n \n#include <linux/ipv6.h>\n#include <net/ipv6.h>\n#include <linux/in.h>\n#include <linux/module.h>\n#include <net/dsfield.h>\n#include <linux/netfilter/x_tables.h>\n#include <linux/netfilter_bridge/ebtables.h>\n#include <linux/netfilter_bridge/ebt_ip6.h>\n\nunion pkthdr {\n\tstruct {\n\t\t__be16 src;\n\t\t__be16 dst;\n\t} tcpudphdr;\n\tstruct {\n\t\tu8 type;\n\t\tu8 code;\n\t} icmphdr;\n};\n\nstatic bool\nebt_ip6_mt(const struct sk_buff *skb, struct xt_action_param *par)\n{\n\tconst struct ebt_ip6_info *info = par->matchinfo;\n\tconst struct ipv6hdr *ih6;\n\tstruct ipv6hdr _ip6h;\n\tconst union pkthdr *pptr;\n\tunion pkthdr _pkthdr;\n\n\tih6 = skb_header_pointer(skb, 0, sizeof(_ip6h), &_ip6h);\n\tif (ih6 == NULL)\n\t\treturn false;\n\tif ((info->bitmask & EBT_IP6_TCLASS) &&\n\t    NF_INVF(info, EBT_IP6_TCLASS,\n\t\t    info->tclass != ipv6_get_dsfield(ih6)))\n\t\treturn false;\n\tif (((info->bitmask & EBT_IP6_SOURCE) &&\n\t     NF_INVF(info, EBT_IP6_SOURCE,\n\t\t     ipv6_masked_addr_cmp(&ih6->saddr, &info->smsk,\n\t\t\t\t\t  &info->saddr))) ||\n\t    ((info->bitmask & EBT_IP6_DEST) &&\n\t     NF_INVF(info, EBT_IP6_DEST,\n\t\t     ipv6_masked_addr_cmp(&ih6->daddr, &info->dmsk,\n\t\t\t\t\t  &info->daddr))))\n\t\treturn false;\n\tif (info->bitmask & EBT_IP6_PROTO) {\n\t\tuint8_t nexthdr = ih6->nexthdr;\n\t\t__be16 frag_off;\n\t\tint offset_ph;\n\n\t\toffset_ph = ipv6_skip_exthdr(skb, sizeof(_ip6h), &nexthdr, &frag_off);\n\t\tif (offset_ph == -1)\n\t\t\treturn false;\n\t\tif (NF_INVF(info, EBT_IP6_PROTO, info->protocol != nexthdr))\n\t\t\treturn false;\n\t\tif (!(info->bitmask & (EBT_IP6_DPORT |\n\t\t\t\t       EBT_IP6_SPORT | EBT_IP6_ICMP6)))\n\t\t\treturn true;\n\n\t\t \n\t\tpptr = skb_header_pointer(skb, offset_ph, sizeof(_pkthdr),\n\t\t\t\t\t  &_pkthdr);\n\t\tif (pptr == NULL)\n\t\t\treturn false;\n\t\tif (info->bitmask & EBT_IP6_DPORT) {\n\t\t\tu16 dst = ntohs(pptr->tcpudphdr.dst);\n\t\t\tif (NF_INVF(info, EBT_IP6_DPORT,\n\t\t\t\t    dst < info->dport[0] ||\n\t\t\t\t    dst > info->dport[1]))\n\t\t\t\treturn false;\n\t\t}\n\t\tif (info->bitmask & EBT_IP6_SPORT) {\n\t\t\tu16 src = ntohs(pptr->tcpudphdr.src);\n\t\t\tif (NF_INVF(info, EBT_IP6_SPORT,\n\t\t\t\t    src < info->sport[0] ||\n\t\t\t\t    src > info->sport[1]))\n\t\t\t\treturn false;\n\t\t}\n\t\tif ((info->bitmask & EBT_IP6_ICMP6) &&\n\t\t    NF_INVF(info, EBT_IP6_ICMP6,\n\t\t\t    pptr->icmphdr.type < info->icmpv6_type[0] ||\n\t\t\t    pptr->icmphdr.type > info->icmpv6_type[1] ||\n\t\t\t    pptr->icmphdr.code < info->icmpv6_code[0] ||\n\t\t\t    pptr->icmphdr.code > info->icmpv6_code[1]))\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n\nstatic int ebt_ip6_mt_check(const struct xt_mtchk_param *par)\n{\n\tconst struct ebt_entry *e = par->entryinfo;\n\tstruct ebt_ip6_info *info = par->matchinfo;\n\n\tif (e->ethproto != htons(ETH_P_IPV6) || e->invflags & EBT_IPROTO)\n\t\treturn -EINVAL;\n\tif (info->bitmask & ~EBT_IP6_MASK || info->invflags & ~EBT_IP6_MASK)\n\t\treturn -EINVAL;\n\tif (info->bitmask & (EBT_IP6_DPORT | EBT_IP6_SPORT)) {\n\t\tif (info->invflags & EBT_IP6_PROTO)\n\t\t\treturn -EINVAL;\n\t\tif (info->protocol != IPPROTO_TCP &&\n\t\t    info->protocol != IPPROTO_UDP &&\n\t\t    info->protocol != IPPROTO_UDPLITE &&\n\t\t    info->protocol != IPPROTO_SCTP &&\n\t\t    info->protocol != IPPROTO_DCCP)\n\t\t\treturn -EINVAL;\n\t}\n\tif (info->bitmask & EBT_IP6_DPORT && info->dport[0] > info->dport[1])\n\t\treturn -EINVAL;\n\tif (info->bitmask & EBT_IP6_SPORT && info->sport[0] > info->sport[1])\n\t\treturn -EINVAL;\n\tif (info->bitmask & EBT_IP6_ICMP6) {\n\t\tif ((info->invflags & EBT_IP6_PROTO) ||\n\t\t     info->protocol != IPPROTO_ICMPV6)\n\t\t\treturn -EINVAL;\n\t\tif (info->icmpv6_type[0] > info->icmpv6_type[1] ||\n\t\t    info->icmpv6_code[0] > info->icmpv6_code[1])\n\t\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic struct xt_match ebt_ip6_mt_reg __read_mostly = {\n\t.name\t\t= \"ip6\",\n\t.revision\t= 0,\n\t.family\t\t= NFPROTO_BRIDGE,\n\t.match\t\t= ebt_ip6_mt,\n\t.checkentry\t= ebt_ip6_mt_check,\n\t.matchsize\t= sizeof(struct ebt_ip6_info),\n\t.me\t\t= THIS_MODULE,\n};\n\nstatic int __init ebt_ip6_init(void)\n{\n\treturn xt_register_match(&ebt_ip6_mt_reg);\n}\n\nstatic void __exit ebt_ip6_fini(void)\n{\n\txt_unregister_match(&ebt_ip6_mt_reg);\n}\n\nmodule_init(ebt_ip6_init);\nmodule_exit(ebt_ip6_fini);\nMODULE_DESCRIPTION(\"Ebtables: IPv6 protocol packet match\");\nMODULE_AUTHOR(\"Kuo-Lang Tseng <kuo-lang.tseng@intel.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}