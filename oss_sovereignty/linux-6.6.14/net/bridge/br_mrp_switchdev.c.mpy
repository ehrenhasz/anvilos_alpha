{
  "module_name": "br_mrp_switchdev.c",
  "hash_id": "389f3947197c4827fc78b65fe4e41a13070dae968a7c4549bef1063d8373407b",
  "original_prompt": "Ingested from linux-6.6.14/net/bridge/br_mrp_switchdev.c",
  "human_readable_source": "\n\n#include <net/switchdev.h>\n\n#include \"br_private_mrp.h\"\n\nstatic enum br_mrp_hw_support\nbr_mrp_switchdev_port_obj(struct net_bridge *br,\n\t\t\t  const struct switchdev_obj *obj, bool add)\n{\n\tint err;\n\n\tif (add)\n\t\terr = switchdev_port_obj_add(br->dev, obj, NULL);\n\telse\n\t\terr = switchdev_port_obj_del(br->dev, obj);\n\n\t \n\tif (!err)\n\t\treturn BR_MRP_HW;\n\n\tif (err != -EOPNOTSUPP)\n\t\treturn BR_MRP_NONE;\n\n\t \n\treturn BR_MRP_SW;\n}\n\nint br_mrp_switchdev_add(struct net_bridge *br, struct br_mrp *mrp)\n{\n\tstruct switchdev_obj_mrp mrp_obj = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_MRP,\n\t\t.p_port = rtnl_dereference(mrp->p_port)->dev,\n\t\t.s_port = rtnl_dereference(mrp->s_port)->dev,\n\t\t.ring_id = mrp->ring_id,\n\t\t.prio = mrp->prio,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn 0;\n\n\treturn switchdev_port_obj_add(br->dev, &mrp_obj.obj, NULL);\n}\n\nint br_mrp_switchdev_del(struct net_bridge *br, struct br_mrp *mrp)\n{\n\tstruct switchdev_obj_mrp mrp_obj = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_MRP,\n\t\t.p_port = NULL,\n\t\t.s_port = NULL,\n\t\t.ring_id = mrp->ring_id,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn 0;\n\n\treturn switchdev_port_obj_del(br->dev, &mrp_obj.obj);\n}\n\nenum br_mrp_hw_support\nbr_mrp_switchdev_set_ring_role(struct net_bridge *br, struct br_mrp *mrp,\n\t\t\t       enum br_mrp_ring_role_type role)\n{\n\tstruct switchdev_obj_ring_role_mrp mrp_role = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_RING_ROLE_MRP,\n\t\t.ring_role = role,\n\t\t.ring_id = mrp->ring_id,\n\t\t.sw_backup = false,\n\t};\n\tenum br_mrp_hw_support support;\n\tint err;\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn BR_MRP_SW;\n\n\tsupport = br_mrp_switchdev_port_obj(br, &mrp_role.obj,\n\t\t\t\t\t    role != BR_MRP_RING_ROLE_DISABLED);\n\tif (support != BR_MRP_SW)\n\t\treturn support;\n\n\t \n\tmrp_role.sw_backup = true;\n\tif (role != BR_MRP_RING_ROLE_DISABLED)\n\t\terr = switchdev_port_obj_add(br->dev, &mrp_role.obj, NULL);\n\telse\n\t\terr = switchdev_port_obj_del(br->dev, &mrp_role.obj);\n\n\tif (!err)\n\t\treturn BR_MRP_SW;\n\n\treturn BR_MRP_NONE;\n}\n\nenum br_mrp_hw_support\nbr_mrp_switchdev_send_ring_test(struct net_bridge *br, struct br_mrp *mrp,\n\t\t\t\tu32 interval, u8 max_miss, u32 period,\n\t\t\t\tbool monitor)\n{\n\tstruct switchdev_obj_ring_test_mrp test = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_RING_TEST_MRP,\n\t\t.interval = interval,\n\t\t.max_miss = max_miss,\n\t\t.ring_id = mrp->ring_id,\n\t\t.period = period,\n\t\t.monitor = monitor,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn BR_MRP_SW;\n\n\treturn br_mrp_switchdev_port_obj(br, &test.obj, interval != 0);\n}\n\nint br_mrp_switchdev_set_ring_state(struct net_bridge *br,\n\t\t\t\t    struct br_mrp *mrp,\n\t\t\t\t    enum br_mrp_ring_state_type state)\n{\n\tstruct switchdev_obj_ring_state_mrp mrp_state = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_RING_STATE_MRP,\n\t\t.ring_state = state,\n\t\t.ring_id = mrp->ring_id,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn 0;\n\n\treturn switchdev_port_obj_add(br->dev, &mrp_state.obj, NULL);\n}\n\nenum br_mrp_hw_support\nbr_mrp_switchdev_set_in_role(struct net_bridge *br, struct br_mrp *mrp,\n\t\t\t     u16 in_id, u32 ring_id,\n\t\t\t     enum br_mrp_in_role_type role)\n{\n\tstruct switchdev_obj_in_role_mrp mrp_role = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_IN_ROLE_MRP,\n\t\t.in_role = role,\n\t\t.in_id = mrp->in_id,\n\t\t.ring_id = mrp->ring_id,\n\t\t.i_port = rtnl_dereference(mrp->i_port)->dev,\n\t\t.sw_backup = false,\n\t};\n\tenum br_mrp_hw_support support;\n\tint err;\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn BR_MRP_SW;\n\n\tsupport = br_mrp_switchdev_port_obj(br, &mrp_role.obj,\n\t\t\t\t\t    role != BR_MRP_IN_ROLE_DISABLED);\n\tif (support != BR_MRP_NONE)\n\t\treturn support;\n\n\t \n\tmrp_role.sw_backup = true;\n\tif (role != BR_MRP_IN_ROLE_DISABLED)\n\t\terr = switchdev_port_obj_add(br->dev, &mrp_role.obj, NULL);\n\telse\n\t\terr = switchdev_port_obj_del(br->dev, &mrp_role.obj);\n\n\tif (!err)\n\t\treturn BR_MRP_SW;\n\n\treturn BR_MRP_NONE;\n}\n\nint br_mrp_switchdev_set_in_state(struct net_bridge *br, struct br_mrp *mrp,\n\t\t\t\t  enum br_mrp_in_state_type state)\n{\n\tstruct switchdev_obj_in_state_mrp mrp_state = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_IN_STATE_MRP,\n\t\t.in_state = state,\n\t\t.in_id = mrp->in_id,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn 0;\n\n\treturn switchdev_port_obj_add(br->dev, &mrp_state.obj, NULL);\n}\n\nenum br_mrp_hw_support\nbr_mrp_switchdev_send_in_test(struct net_bridge *br, struct br_mrp *mrp,\n\t\t\t      u32 interval, u8 max_miss, u32 period)\n{\n\tstruct switchdev_obj_in_test_mrp test = {\n\t\t.obj.orig_dev = br->dev,\n\t\t.obj.id = SWITCHDEV_OBJ_ID_IN_TEST_MRP,\n\t\t.interval = interval,\n\t\t.max_miss = max_miss,\n\t\t.in_id = mrp->in_id,\n\t\t.period = period,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn BR_MRP_SW;\n\n\treturn br_mrp_switchdev_port_obj(br, &test.obj, interval != 0);\n}\n\nint br_mrp_port_switchdev_set_state(struct net_bridge_port *p, u32 state)\n{\n\tstruct switchdev_attr attr = {\n\t\t.orig_dev = p->dev,\n\t\t.id = SWITCHDEV_ATTR_ID_PORT_STP_STATE,\n\t\t.u.stp_state = state,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn 0;\n\n\treturn switchdev_port_attr_set(p->dev, &attr, NULL);\n}\n\nint br_mrp_port_switchdev_set_role(struct net_bridge_port *p,\n\t\t\t\t   enum br_mrp_port_role_type role)\n{\n\tstruct switchdev_attr attr = {\n\t\t.orig_dev = p->dev,\n\t\t.id = SWITCHDEV_ATTR_ID_MRP_PORT_ROLE,\n\t\t.u.mrp_port_role = role,\n\t};\n\n\tif (!IS_ENABLED(CONFIG_NET_SWITCHDEV))\n\t\treturn 0;\n\n\treturn switchdev_port_attr_set(p->dev, &attr, NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}