{
  "module_name": "led.c",
  "hash_id": "808212c0213d64ee2a1bd358377a5bcb58edb438ab51979881bef1dc436714f9",
  "original_prompt": "Ingested from linux-6.6.14/net/mac80211/led.c",
  "human_readable_source": "\n \n\n \n#include <linux/if.h>\n#include <linux/slab.h>\n#include <linux/export.h>\n#include \"led.h\"\n\nvoid ieee80211_led_assoc(struct ieee80211_local *local, bool associated)\n{\n\tif (!atomic_read(&local->assoc_led_active))\n\t\treturn;\n\tif (associated)\n\t\tled_trigger_event(&local->assoc_led, LED_FULL);\n\telse\n\t\tled_trigger_event(&local->assoc_led, LED_OFF);\n}\n\nvoid ieee80211_led_radio(struct ieee80211_local *local, bool enabled)\n{\n\tif (!atomic_read(&local->radio_led_active))\n\t\treturn;\n\tif (enabled)\n\t\tled_trigger_event(&local->radio_led, LED_FULL);\n\telse\n\t\tled_trigger_event(&local->radio_led, LED_OFF);\n}\n\nvoid ieee80211_alloc_led_names(struct ieee80211_local *local)\n{\n\tlocal->rx_led.name = kasprintf(GFP_KERNEL, \"%srx\",\n\t\t\t\t       wiphy_name(local->hw.wiphy));\n\tlocal->tx_led.name = kasprintf(GFP_KERNEL, \"%stx\",\n\t\t\t\t       wiphy_name(local->hw.wiphy));\n\tlocal->assoc_led.name = kasprintf(GFP_KERNEL, \"%sassoc\",\n\t\t\t\t\t  wiphy_name(local->hw.wiphy));\n\tlocal->radio_led.name = kasprintf(GFP_KERNEL, \"%sradio\",\n\t\t\t\t\t  wiphy_name(local->hw.wiphy));\n}\n\nvoid ieee80211_free_led_names(struct ieee80211_local *local)\n{\n\tkfree(local->rx_led.name);\n\tkfree(local->tx_led.name);\n\tkfree(local->assoc_led.name);\n\tkfree(local->radio_led.name);\n}\n\nstatic int ieee80211_tx_led_activate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     tx_led);\n\n\tatomic_inc(&local->tx_led_active);\n\n\treturn 0;\n}\n\nstatic void ieee80211_tx_led_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     tx_led);\n\n\tatomic_dec(&local->tx_led_active);\n}\n\nstatic int ieee80211_rx_led_activate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     rx_led);\n\n\tatomic_inc(&local->rx_led_active);\n\n\treturn 0;\n}\n\nstatic void ieee80211_rx_led_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     rx_led);\n\n\tatomic_dec(&local->rx_led_active);\n}\n\nstatic int ieee80211_assoc_led_activate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     assoc_led);\n\n\tatomic_inc(&local->assoc_led_active);\n\n\treturn 0;\n}\n\nstatic void ieee80211_assoc_led_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     assoc_led);\n\n\tatomic_dec(&local->assoc_led_active);\n}\n\nstatic int ieee80211_radio_led_activate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     radio_led);\n\n\tatomic_inc(&local->radio_led_active);\n\n\treturn 0;\n}\n\nstatic void ieee80211_radio_led_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     radio_led);\n\n\tatomic_dec(&local->radio_led_active);\n}\n\nstatic int ieee80211_tpt_led_activate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     tpt_led);\n\n\tatomic_inc(&local->tpt_led_active);\n\n\treturn 0;\n}\n\nstatic void ieee80211_tpt_led_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct ieee80211_local *local = container_of(led_cdev->trigger,\n\t\t\t\t\t\t     struct ieee80211_local,\n\t\t\t\t\t\t     tpt_led);\n\n\tatomic_dec(&local->tpt_led_active);\n}\n\nvoid ieee80211_led_init(struct ieee80211_local *local)\n{\n\tatomic_set(&local->rx_led_active, 0);\n\tlocal->rx_led.activate = ieee80211_rx_led_activate;\n\tlocal->rx_led.deactivate = ieee80211_rx_led_deactivate;\n\tif (local->rx_led.name && led_trigger_register(&local->rx_led)) {\n\t\tkfree(local->rx_led.name);\n\t\tlocal->rx_led.name = NULL;\n\t}\n\n\tatomic_set(&local->tx_led_active, 0);\n\tlocal->tx_led.activate = ieee80211_tx_led_activate;\n\tlocal->tx_led.deactivate = ieee80211_tx_led_deactivate;\n\tif (local->tx_led.name && led_trigger_register(&local->tx_led)) {\n\t\tkfree(local->tx_led.name);\n\t\tlocal->tx_led.name = NULL;\n\t}\n\n\tatomic_set(&local->assoc_led_active, 0);\n\tlocal->assoc_led.activate = ieee80211_assoc_led_activate;\n\tlocal->assoc_led.deactivate = ieee80211_assoc_led_deactivate;\n\tif (local->assoc_led.name && led_trigger_register(&local->assoc_led)) {\n\t\tkfree(local->assoc_led.name);\n\t\tlocal->assoc_led.name = NULL;\n\t}\n\n\tatomic_set(&local->radio_led_active, 0);\n\tlocal->radio_led.activate = ieee80211_radio_led_activate;\n\tlocal->radio_led.deactivate = ieee80211_radio_led_deactivate;\n\tif (local->radio_led.name && led_trigger_register(&local->radio_led)) {\n\t\tkfree(local->radio_led.name);\n\t\tlocal->radio_led.name = NULL;\n\t}\n\n\tatomic_set(&local->tpt_led_active, 0);\n\tif (local->tpt_led_trigger) {\n\t\tlocal->tpt_led.activate = ieee80211_tpt_led_activate;\n\t\tlocal->tpt_led.deactivate = ieee80211_tpt_led_deactivate;\n\t\tif (led_trigger_register(&local->tpt_led)) {\n\t\t\tkfree(local->tpt_led_trigger);\n\t\t\tlocal->tpt_led_trigger = NULL;\n\t\t}\n\t}\n}\n\nvoid ieee80211_led_exit(struct ieee80211_local *local)\n{\n\tif (local->radio_led.name)\n\t\tled_trigger_unregister(&local->radio_led);\n\tif (local->assoc_led.name)\n\t\tled_trigger_unregister(&local->assoc_led);\n\tif (local->tx_led.name)\n\t\tled_trigger_unregister(&local->tx_led);\n\tif (local->rx_led.name)\n\t\tled_trigger_unregister(&local->rx_led);\n\n\tif (local->tpt_led_trigger) {\n\t\tled_trigger_unregister(&local->tpt_led);\n\t\tkfree(local->tpt_led_trigger);\n\t}\n}\n\nconst char *__ieee80211_get_radio_led_name(struct ieee80211_hw *hw)\n{\n\tstruct ieee80211_local *local = hw_to_local(hw);\n\n\treturn local->radio_led.name;\n}\nEXPORT_SYMBOL(__ieee80211_get_radio_led_name);\n\nconst char *__ieee80211_get_assoc_led_name(struct ieee80211_hw *hw)\n{\n\tstruct ieee80211_local *local = hw_to_local(hw);\n\n\treturn local->assoc_led.name;\n}\nEXPORT_SYMBOL(__ieee80211_get_assoc_led_name);\n\nconst char *__ieee80211_get_tx_led_name(struct ieee80211_hw *hw)\n{\n\tstruct ieee80211_local *local = hw_to_local(hw);\n\n\treturn local->tx_led.name;\n}\nEXPORT_SYMBOL(__ieee80211_get_tx_led_name);\n\nconst char *__ieee80211_get_rx_led_name(struct ieee80211_hw *hw)\n{\n\tstruct ieee80211_local *local = hw_to_local(hw);\n\n\treturn local->rx_led.name;\n}\nEXPORT_SYMBOL(__ieee80211_get_rx_led_name);\n\nstatic unsigned long tpt_trig_traffic(struct ieee80211_local *local,\n\t\t\t\t      struct tpt_led_trigger *tpt_trig)\n{\n\tunsigned long traffic, delta;\n\n\ttraffic = tpt_trig->tx_bytes + tpt_trig->rx_bytes;\n\n\tdelta = traffic - tpt_trig->prev_traffic;\n\ttpt_trig->prev_traffic = traffic;\n\treturn DIV_ROUND_UP(delta, 1024 / 8);\n}\n\nstatic void tpt_trig_timer(struct timer_list *t)\n{\n\tstruct tpt_led_trigger *tpt_trig = from_timer(tpt_trig, t, timer);\n\tstruct ieee80211_local *local = tpt_trig->local;\n\tunsigned long on, off, tpt;\n\tint i;\n\n\tif (!tpt_trig->running)\n\t\treturn;\n\n\tmod_timer(&tpt_trig->timer, round_jiffies(jiffies + HZ));\n\n\ttpt = tpt_trig_traffic(local, tpt_trig);\n\n\t \n\ton = 1;\n\toff = 0;\n\n\tfor (i = tpt_trig->blink_table_len - 1; i >= 0; i--) {\n\t\tif (tpt_trig->blink_table[i].throughput < 0 ||\n\t\t    tpt > tpt_trig->blink_table[i].throughput) {\n\t\t\toff = tpt_trig->blink_table[i].blink_time / 2;\n\t\t\ton = tpt_trig->blink_table[i].blink_time - off;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tled_trigger_blink(&local->tpt_led, on, off);\n}\n\nconst char *\n__ieee80211_create_tpt_led_trigger(struct ieee80211_hw *hw,\n\t\t\t\t   unsigned int flags,\n\t\t\t\t   const struct ieee80211_tpt_blink *blink_table,\n\t\t\t\t   unsigned int blink_table_len)\n{\n\tstruct ieee80211_local *local = hw_to_local(hw);\n\tstruct tpt_led_trigger *tpt_trig;\n\n\tif (WARN_ON(local->tpt_led_trigger))\n\t\treturn NULL;\n\n\ttpt_trig = kzalloc(sizeof(struct tpt_led_trigger), GFP_KERNEL);\n\tif (!tpt_trig)\n\t\treturn NULL;\n\n\tsnprintf(tpt_trig->name, sizeof(tpt_trig->name),\n\t\t \"%stpt\", wiphy_name(local->hw.wiphy));\n\n\tlocal->tpt_led.name = tpt_trig->name;\n\n\ttpt_trig->blink_table = blink_table;\n\ttpt_trig->blink_table_len = blink_table_len;\n\ttpt_trig->want = flags;\n\ttpt_trig->local = local;\n\n\ttimer_setup(&tpt_trig->timer, tpt_trig_timer, 0);\n\n\tlocal->tpt_led_trigger = tpt_trig;\n\n\treturn tpt_trig->name;\n}\nEXPORT_SYMBOL(__ieee80211_create_tpt_led_trigger);\n\nstatic void ieee80211_start_tpt_led_trig(struct ieee80211_local *local)\n{\n\tstruct tpt_led_trigger *tpt_trig = local->tpt_led_trigger;\n\n\tif (tpt_trig->running)\n\t\treturn;\n\n\t \n\ttpt_trig_traffic(local, tpt_trig);\n\ttpt_trig->running = true;\n\n\ttpt_trig_timer(&tpt_trig->timer);\n\tmod_timer(&tpt_trig->timer, round_jiffies(jiffies + HZ));\n}\n\nstatic void ieee80211_stop_tpt_led_trig(struct ieee80211_local *local)\n{\n\tstruct tpt_led_trigger *tpt_trig = local->tpt_led_trigger;\n\n\tif (!tpt_trig->running)\n\t\treturn;\n\n\ttpt_trig->running = false;\n\tdel_timer_sync(&tpt_trig->timer);\n\n\tled_trigger_event(&local->tpt_led, LED_OFF);\n}\n\nvoid ieee80211_mod_tpt_led_trig(struct ieee80211_local *local,\n\t\t\t\tunsigned int types_on, unsigned int types_off)\n{\n\tstruct tpt_led_trigger *tpt_trig = local->tpt_led_trigger;\n\tbool allowed;\n\n\tWARN_ON(types_on & types_off);\n\n\tif (!tpt_trig)\n\t\treturn;\n\n\ttpt_trig->active &= ~types_off;\n\ttpt_trig->active |= types_on;\n\n\t \n\tallowed = tpt_trig->active & IEEE80211_TPT_LEDTRIG_FL_RADIO;\n\n\tif (!allowed || !(tpt_trig->active & tpt_trig->want))\n\t\tieee80211_stop_tpt_led_trig(local);\n\telse\n\t\tieee80211_start_tpt_led_trig(local);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}