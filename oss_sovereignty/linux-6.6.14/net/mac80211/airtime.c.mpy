{
  "module_name": "airtime.c",
  "hash_id": "d3ac77ed24f6c1504b6a40038299e86d11e1f3759c1ed2f13635dd8779f481b5",
  "original_prompt": "Ingested from linux-6.6.14/net/mac80211/airtime.c",
  "human_readable_source": "\n \n\n#include <net/mac80211.h>\n#include \"ieee80211_i.h\"\n#include \"sta_info.h\"\n\n#define AVG_PKT_SIZE\t1024\n\n \n#define MCS_NBITS (AVG_PKT_SIZE << 3)\n\n \n#define MCS_N_KSYMS(bps) DIV_ROUND_UP(MCS_NBITS << 10, (bps))\n\n \n#define MCS_SYMBOL_TIME(sgi, ksyms)\t\t\t\t\t\\\n\t(sgi ?\t\t\t\t\t\t\t\t\\\n\t  ((ksyms) * 4 * 18) / 20 :\t\t \t\\\n\t  ((ksyms) * 4)\t\t\t \t\\\n\t)\n\n \n#define MCS_DURATION(streams, sgi, bps) \\\n\t((u32)MCS_SYMBOL_TIME(sgi, MCS_N_KSYMS((streams) * (bps))))\n\n#define MCS_DURATION_S(shift, streams, sgi, bps)\t\t\\\n\t((u16)((MCS_DURATION(streams, sgi, bps) >> shift)))\n\n \n#define HE_GI_08 0\n#define HE_GI_16 1\n#define HE_GI_32 2\n\n \n#define HE_SYMBOL_TIME(gi, ksyms)\t\t\t\t\t\\\n\t(gi == HE_GI_08 ?\t\t\t\t\t\t\\\n\t ((ksyms) * 16 * 17) / 20 :\t\t \t\\\n\t (gi == HE_GI_16 ?\t\t\t\t\t\t\\\n\t  ((ksyms) * 16 * 18) / 20 :\t\t \t\\\n\t  ((ksyms) * 16)\t\t\t \t\\\n\t ))\n\n \n#define HE_DURATION(streams, gi, bps) \\\n\t((u32)HE_SYMBOL_TIME(gi, MCS_N_KSYMS((streams) * (bps))))\n\n#define HE_DURATION_S(shift, streams, gi, bps)\t\t\\\n\t(HE_DURATION(streams, gi, bps) >> shift)\n\n#define BW_20\t\t\t0\n#define BW_40\t\t\t1\n#define BW_80\t\t\t2\n#define BW_160\t\t\t3\n\n \n#define IEEE80211_MAX_STREAMS\t\t4\n#define IEEE80211_HT_STREAM_GROUPS\t4  \n#define IEEE80211_VHT_STREAM_GROUPS\t8  \n\n#define IEEE80211_HE_MAX_STREAMS\t8\n\n#define IEEE80211_HT_GROUPS_NB\t(IEEE80211_MAX_STREAMS *\t\\\n\t\t\t\t IEEE80211_HT_STREAM_GROUPS)\n#define IEEE80211_VHT_GROUPS_NB\t(IEEE80211_MAX_STREAMS *\t\\\n\t\t\t\t\t IEEE80211_VHT_STREAM_GROUPS)\n\n#define IEEE80211_HT_GROUP_0\t0\n#define IEEE80211_VHT_GROUP_0\t(IEEE80211_HT_GROUP_0 + IEEE80211_HT_GROUPS_NB)\n#define IEEE80211_HE_GROUP_0\t(IEEE80211_VHT_GROUP_0 + IEEE80211_VHT_GROUPS_NB)\n\n#define MCS_GROUP_RATES\t\t12\n\n#define HT_GROUP_IDX(_streams, _sgi, _ht40)\t\\\n\tIEEE80211_HT_GROUP_0 +\t\t\t\\\n\tIEEE80211_MAX_STREAMS * 2 * _ht40 +\t\\\n\tIEEE80211_MAX_STREAMS * _sgi +\t\t\\\n\t_streams - 1\n\n#define _MAX(a, b) (((a)>(b))?(a):(b))\n\n#define GROUP_SHIFT(duration)\t\t\t\t\t\t\\\n\t_MAX(0, 16 - __builtin_clz(duration))\n\n \n#define __MCS_GROUP(_streams, _sgi, _ht40, _s)\t\t\t\t\\\n\t[HT_GROUP_IDX(_streams, _sgi, _ht40)] = {\t\t\t\\\n\t.shift = _s,\t\t\t\t\t\t\t\\\n\t.duration = {\t\t\t\t\t\t\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 54 : 26),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 108 : 52),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 162 : 78),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 216 : 104),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 324 : 156),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 432 : 208),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 486 : 234),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi, _ht40 ? 540 : 260)\t\\\n\t}\t\t\t\t\t\t\t\t\\\n}\n\n#define MCS_GROUP_SHIFT(_streams, _sgi, _ht40)\t\t\t\t\\\n\tGROUP_SHIFT(MCS_DURATION(_streams, _sgi, _ht40 ? 54 : 26))\n\n#define MCS_GROUP(_streams, _sgi, _ht40)\t\t\t\t\\\n\t__MCS_GROUP(_streams, _sgi, _ht40,\t\t\t\t\\\n\t\t    MCS_GROUP_SHIFT(_streams, _sgi, _ht40))\n\n#define VHT_GROUP_IDX(_streams, _sgi, _bw)\t\t\t\t\\\n\t(IEEE80211_VHT_GROUP_0 +\t\t\t\t\t\\\n\t IEEE80211_MAX_STREAMS * 2 * (_bw) +\t\t\t\t\\\n\t IEEE80211_MAX_STREAMS * (_sgi) +\t\t\t\t\\\n\t (_streams) - 1)\n\n#define BW2VBPS(_bw, r4, r3, r2, r1)\t\t\t\t\t\\\n\t(_bw == BW_160 ? r4 : _bw == BW_80 ? r3 : _bw == BW_40 ? r2 : r1)\n\n#define __VHT_GROUP(_streams, _sgi, _bw, _s)\t\t\t\t\\\n\t[VHT_GROUP_IDX(_streams, _sgi, _bw)] = {\t\t\t\\\n\t.shift = _s,\t\t\t\t\t\t\t\\\n\t.duration = {\t\t\t\t\t\t\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw,  234,  117,  54,  26)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw,  468,  234, 108,  52)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw,  702,  351, 162,  78)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw,  936,  468, 216, 104)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw, 1404,  702, 324, 156)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw, 1872,  936, 432, 208)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw, 2106, 1053, 486, 234)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw, 2340, 1170, 540, 260)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw, 2808, 1404, 648, 312)),\t\\\n\t\tMCS_DURATION_S(_s, _streams, _sgi,\t\t\t\\\n\t\t\t       BW2VBPS(_bw, 3120, 1560, 720, 346))\t\\\n        }\t\t\t\t\t\t\t\t\\\n}\n\n#define VHT_GROUP_SHIFT(_streams, _sgi, _bw)\t\t\t\t\\\n\tGROUP_SHIFT(MCS_DURATION(_streams, _sgi,\t\t\t\\\n\t\t\t\t BW2VBPS(_bw, 243, 117,  54,  26)))\n\n#define VHT_GROUP(_streams, _sgi, _bw)\t\t\t\t\t\\\n\t__VHT_GROUP(_streams, _sgi, _bw,\t\t\t\t\\\n\t\t    VHT_GROUP_SHIFT(_streams, _sgi, _bw))\n\n\n#define HE_GROUP_IDX(_streams, _gi, _bw)\t\t\t\t\\\n\t(IEEE80211_HE_GROUP_0 +\t\t\t\t\t\\\n\t IEEE80211_HE_MAX_STREAMS * 3 * (_bw) +\t\t\t\\\n\t IEEE80211_HE_MAX_STREAMS * (_gi) +\t\t\t\t\\\n\t (_streams) - 1)\n\n#define __HE_GROUP(_streams, _gi, _bw, _s)\t\t\t\t\\\n\t[HE_GROUP_IDX(_streams, _gi, _bw)] = {\t\t\t\\\n\t.shift = _s,\t\t\t\t\t\t\t\\\n\t.duration = {\t\t\t\t\t\t\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,   979,  489,  230,  115)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  1958,  979,  475,  230)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  2937, 1468,  705,  345)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  3916, 1958,  936,  475)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  5875, 2937, 1411,  705)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  7833, 3916, 1872,  936)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  8827, 4406, 2102, 1051)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw,  9806, 4896, 2347, 1166)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw, 11764, 5875, 2808, 1411)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw, 13060, 6523, 3124, 1555)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw, 14702, 7344, 3513, 1756)),\t\\\n\t\tHE_DURATION_S(_s, _streams, _gi,\t\t\t\\\n\t\t\t      BW2VBPS(_bw, 16329, 8164, 3902, 1944))\t\\\n        }\t\t\t\t\t\t\t\t\\\n}\n\n#define HE_GROUP_SHIFT(_streams, _gi, _bw)\t\t\t\t\\\n\tGROUP_SHIFT(HE_DURATION(_streams, _gi,\t\t\t\\\n\t\t\t\tBW2VBPS(_bw,   979,  489,  230,  115)))\n\n#define HE_GROUP(_streams, _gi, _bw)\t\t\t\t\t\\\n\t__HE_GROUP(_streams, _gi, _bw,\t\t\t\t\\\n\t\t   HE_GROUP_SHIFT(_streams, _gi, _bw))\nstruct mcs_group {\n\tu8 shift;\n\tu16 duration[MCS_GROUP_RATES];\n};\n\nstatic const struct mcs_group airtime_mcs_groups[] = {\n\tMCS_GROUP(1, 0, BW_20),\n\tMCS_GROUP(2, 0, BW_20),\n\tMCS_GROUP(3, 0, BW_20),\n\tMCS_GROUP(4, 0, BW_20),\n\n\tMCS_GROUP(1, 1, BW_20),\n\tMCS_GROUP(2, 1, BW_20),\n\tMCS_GROUP(3, 1, BW_20),\n\tMCS_GROUP(4, 1, BW_20),\n\n\tMCS_GROUP(1, 0, BW_40),\n\tMCS_GROUP(2, 0, BW_40),\n\tMCS_GROUP(3, 0, BW_40),\n\tMCS_GROUP(4, 0, BW_40),\n\n\tMCS_GROUP(1, 1, BW_40),\n\tMCS_GROUP(2, 1, BW_40),\n\tMCS_GROUP(3, 1, BW_40),\n\tMCS_GROUP(4, 1, BW_40),\n\n\tVHT_GROUP(1, 0, BW_20),\n\tVHT_GROUP(2, 0, BW_20),\n\tVHT_GROUP(3, 0, BW_20),\n\tVHT_GROUP(4, 0, BW_20),\n\n\tVHT_GROUP(1, 1, BW_20),\n\tVHT_GROUP(2, 1, BW_20),\n\tVHT_GROUP(3, 1, BW_20),\n\tVHT_GROUP(4, 1, BW_20),\n\n\tVHT_GROUP(1, 0, BW_40),\n\tVHT_GROUP(2, 0, BW_40),\n\tVHT_GROUP(3, 0, BW_40),\n\tVHT_GROUP(4, 0, BW_40),\n\n\tVHT_GROUP(1, 1, BW_40),\n\tVHT_GROUP(2, 1, BW_40),\n\tVHT_GROUP(3, 1, BW_40),\n\tVHT_GROUP(4, 1, BW_40),\n\n\tVHT_GROUP(1, 0, BW_80),\n\tVHT_GROUP(2, 0, BW_80),\n\tVHT_GROUP(3, 0, BW_80),\n\tVHT_GROUP(4, 0, BW_80),\n\n\tVHT_GROUP(1, 1, BW_80),\n\tVHT_GROUP(2, 1, BW_80),\n\tVHT_GROUP(3, 1, BW_80),\n\tVHT_GROUP(4, 1, BW_80),\n\n\tVHT_GROUP(1, 0, BW_160),\n\tVHT_GROUP(2, 0, BW_160),\n\tVHT_GROUP(3, 0, BW_160),\n\tVHT_GROUP(4, 0, BW_160),\n\n\tVHT_GROUP(1, 1, BW_160),\n\tVHT_GROUP(2, 1, BW_160),\n\tVHT_GROUP(3, 1, BW_160),\n\tVHT_GROUP(4, 1, BW_160),\n\n\tHE_GROUP(1, HE_GI_08, BW_20),\n\tHE_GROUP(2, HE_GI_08, BW_20),\n\tHE_GROUP(3, HE_GI_08, BW_20),\n\tHE_GROUP(4, HE_GI_08, BW_20),\n\tHE_GROUP(5, HE_GI_08, BW_20),\n\tHE_GROUP(6, HE_GI_08, BW_20),\n\tHE_GROUP(7, HE_GI_08, BW_20),\n\tHE_GROUP(8, HE_GI_08, BW_20),\n\n\tHE_GROUP(1, HE_GI_16, BW_20),\n\tHE_GROUP(2, HE_GI_16, BW_20),\n\tHE_GROUP(3, HE_GI_16, BW_20),\n\tHE_GROUP(4, HE_GI_16, BW_20),\n\tHE_GROUP(5, HE_GI_16, BW_20),\n\tHE_GROUP(6, HE_GI_16, BW_20),\n\tHE_GROUP(7, HE_GI_16, BW_20),\n\tHE_GROUP(8, HE_GI_16, BW_20),\n\n\tHE_GROUP(1, HE_GI_32, BW_20),\n\tHE_GROUP(2, HE_GI_32, BW_20),\n\tHE_GROUP(3, HE_GI_32, BW_20),\n\tHE_GROUP(4, HE_GI_32, BW_20),\n\tHE_GROUP(5, HE_GI_32, BW_20),\n\tHE_GROUP(6, HE_GI_32, BW_20),\n\tHE_GROUP(7, HE_GI_32, BW_20),\n\tHE_GROUP(8, HE_GI_32, BW_20),\n\n\tHE_GROUP(1, HE_GI_08, BW_40),\n\tHE_GROUP(2, HE_GI_08, BW_40),\n\tHE_GROUP(3, HE_GI_08, BW_40),\n\tHE_GROUP(4, HE_GI_08, BW_40),\n\tHE_GROUP(5, HE_GI_08, BW_40),\n\tHE_GROUP(6, HE_GI_08, BW_40),\n\tHE_GROUP(7, HE_GI_08, BW_40),\n\tHE_GROUP(8, HE_GI_08, BW_40),\n\n\tHE_GROUP(1, HE_GI_16, BW_40),\n\tHE_GROUP(2, HE_GI_16, BW_40),\n\tHE_GROUP(3, HE_GI_16, BW_40),\n\tHE_GROUP(4, HE_GI_16, BW_40),\n\tHE_GROUP(5, HE_GI_16, BW_40),\n\tHE_GROUP(6, HE_GI_16, BW_40),\n\tHE_GROUP(7, HE_GI_16, BW_40),\n\tHE_GROUP(8, HE_GI_16, BW_40),\n\n\tHE_GROUP(1, HE_GI_32, BW_40),\n\tHE_GROUP(2, HE_GI_32, BW_40),\n\tHE_GROUP(3, HE_GI_32, BW_40),\n\tHE_GROUP(4, HE_GI_32, BW_40),\n\tHE_GROUP(5, HE_GI_32, BW_40),\n\tHE_GROUP(6, HE_GI_32, BW_40),\n\tHE_GROUP(7, HE_GI_32, BW_40),\n\tHE_GROUP(8, HE_GI_32, BW_40),\n\n\tHE_GROUP(1, HE_GI_08, BW_80),\n\tHE_GROUP(2, HE_GI_08, BW_80),\n\tHE_GROUP(3, HE_GI_08, BW_80),\n\tHE_GROUP(4, HE_GI_08, BW_80),\n\tHE_GROUP(5, HE_GI_08, BW_80),\n\tHE_GROUP(6, HE_GI_08, BW_80),\n\tHE_GROUP(7, HE_GI_08, BW_80),\n\tHE_GROUP(8, HE_GI_08, BW_80),\n\n\tHE_GROUP(1, HE_GI_16, BW_80),\n\tHE_GROUP(2, HE_GI_16, BW_80),\n\tHE_GROUP(3, HE_GI_16, BW_80),\n\tHE_GROUP(4, HE_GI_16, BW_80),\n\tHE_GROUP(5, HE_GI_16, BW_80),\n\tHE_GROUP(6, HE_GI_16, BW_80),\n\tHE_GROUP(7, HE_GI_16, BW_80),\n\tHE_GROUP(8, HE_GI_16, BW_80),\n\n\tHE_GROUP(1, HE_GI_32, BW_80),\n\tHE_GROUP(2, HE_GI_32, BW_80),\n\tHE_GROUP(3, HE_GI_32, BW_80),\n\tHE_GROUP(4, HE_GI_32, BW_80),\n\tHE_GROUP(5, HE_GI_32, BW_80),\n\tHE_GROUP(6, HE_GI_32, BW_80),\n\tHE_GROUP(7, HE_GI_32, BW_80),\n\tHE_GROUP(8, HE_GI_32, BW_80),\n\n\tHE_GROUP(1, HE_GI_08, BW_160),\n\tHE_GROUP(2, HE_GI_08, BW_160),\n\tHE_GROUP(3, HE_GI_08, BW_160),\n\tHE_GROUP(4, HE_GI_08, BW_160),\n\tHE_GROUP(5, HE_GI_08, BW_160),\n\tHE_GROUP(6, HE_GI_08, BW_160),\n\tHE_GROUP(7, HE_GI_08, BW_160),\n\tHE_GROUP(8, HE_GI_08, BW_160),\n\n\tHE_GROUP(1, HE_GI_16, BW_160),\n\tHE_GROUP(2, HE_GI_16, BW_160),\n\tHE_GROUP(3, HE_GI_16, BW_160),\n\tHE_GROUP(4, HE_GI_16, BW_160),\n\tHE_GROUP(5, HE_GI_16, BW_160),\n\tHE_GROUP(6, HE_GI_16, BW_160),\n\tHE_GROUP(7, HE_GI_16, BW_160),\n\tHE_GROUP(8, HE_GI_16, BW_160),\n\n\tHE_GROUP(1, HE_GI_32, BW_160),\n\tHE_GROUP(2, HE_GI_32, BW_160),\n\tHE_GROUP(3, HE_GI_32, BW_160),\n\tHE_GROUP(4, HE_GI_32, BW_160),\n\tHE_GROUP(5, HE_GI_32, BW_160),\n\tHE_GROUP(6, HE_GI_32, BW_160),\n\tHE_GROUP(7, HE_GI_32, BW_160),\n\tHE_GROUP(8, HE_GI_32, BW_160),\n};\n\nstatic u32\nieee80211_calc_legacy_rate_duration(u16 bitrate, bool short_pre,\n\t\t\t\t    bool cck, int len)\n{\n\tu32 duration;\n\n\tif (cck) {\n\t\tduration = 144 + 48;  \n\t\tif (short_pre)\n\t\t\tduration >>= 1;\n\n\t\tduration += 10;  \n\t} else {\n\t\tduration = 20 + 16;  \n\t}\n\n\tlen <<= 3;\n\tduration += (len * 10) / bitrate;\n\n\treturn duration;\n}\n\nstatic u32 ieee80211_get_rate_duration(struct ieee80211_hw *hw,\n\t\t\t\t       struct ieee80211_rx_status *status,\n\t\t\t\t       u32 *overhead)\n{\n\tbool sgi = status->enc_flags & RX_ENC_FLAG_SHORT_GI;\n\tint bw, streams;\n\tint group, idx;\n\tu32 duration;\n\n\tswitch (status->bw) {\n\tcase RATE_INFO_BW_20:\n\t\tbw = BW_20;\n\t\tbreak;\n\tcase RATE_INFO_BW_40:\n\t\tbw = BW_40;\n\t\tbreak;\n\tcase RATE_INFO_BW_80:\n\t\tbw = BW_80;\n\t\tbreak;\n\tcase RATE_INFO_BW_160:\n\t\tbw = BW_160;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON_ONCE(1);\n\t\treturn 0;\n\t}\n\n\tswitch (status->encoding) {\n\tcase RX_ENC_VHT:\n\t\tstreams = status->nss;\n\t\tidx = status->rate_idx;\n\t\tgroup = VHT_GROUP_IDX(streams, sgi, bw);\n\t\tbreak;\n\tcase RX_ENC_HT:\n\t\tstreams = ((status->rate_idx >> 3) & 3) + 1;\n\t\tidx = status->rate_idx & 7;\n\t\tgroup = HT_GROUP_IDX(streams, sgi, bw);\n\t\tbreak;\n\tcase RX_ENC_HE:\n\t\tstreams = status->nss;\n\t\tidx = status->rate_idx;\n\t\tgroup = HE_GROUP_IDX(streams, status->he_gi, bw);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON_ONCE(1);\n\t\treturn 0;\n\t}\n\n\tif (WARN_ON_ONCE((status->encoding != RX_ENC_HE && streams > 4) ||\n\t\t\t (status->encoding == RX_ENC_HE && streams > 8)))\n\t\treturn 0;\n\n\tif (idx >= MCS_GROUP_RATES)\n\t\treturn 0;\n\n\tduration = airtime_mcs_groups[group].duration[idx];\n\tduration <<= airtime_mcs_groups[group].shift;\n\t*overhead = 36 + (streams << 2);\n\n\treturn duration;\n}\n\n\nu32 ieee80211_calc_rx_airtime(struct ieee80211_hw *hw,\n\t\t\t      struct ieee80211_rx_status *status,\n\t\t\t      int len)\n{\n\tstruct ieee80211_supported_band *sband;\n\tu32 duration, overhead = 0;\n\n\tif (status->encoding == RX_ENC_LEGACY) {\n\t\tconst struct ieee80211_rate *rate;\n\t\tbool sp = status->enc_flags & RX_ENC_FLAG_SHORTPRE;\n\t\tbool cck;\n\n\t\t \n\t\tif (WARN_ON_ONCE(status->band == NL80211_BAND_60GHZ ||\n\t\t\t\t status->band == NL80211_BAND_S1GHZ))\n\t\t\treturn 0;\n\n\t\tsband = hw->wiphy->bands[status->band];\n\t\tif (!sband || status->rate_idx >= sband->n_bitrates)\n\t\t\treturn 0;\n\n\t\trate = &sband->bitrates[status->rate_idx];\n\t\tcck = rate->flags & IEEE80211_RATE_MANDATORY_B;\n\n\t\treturn ieee80211_calc_legacy_rate_duration(rate->bitrate, sp,\n\t\t\t\t\t\t\t   cck, len);\n\t}\n\n\tduration = ieee80211_get_rate_duration(hw, status, &overhead);\n\tif (!duration)\n\t\treturn 0;\n\n\tduration *= len;\n\tduration /= AVG_PKT_SIZE;\n\tduration /= 1024;\n\n\treturn duration + overhead;\n}\nEXPORT_SYMBOL_GPL(ieee80211_calc_rx_airtime);\n\nstatic bool ieee80211_fill_rate_info(struct ieee80211_hw *hw,\n\t\t\t\t     struct ieee80211_rx_status *stat, u8 band,\n\t\t\t\t     struct rate_info *ri)\n{\n\tstruct ieee80211_supported_band *sband = hw->wiphy->bands[band];\n\tint i;\n\n\tif (!ri || !sband)\n\t    return false;\n\n\tstat->bw = ri->bw;\n\tstat->nss = ri->nss;\n\tstat->rate_idx = ri->mcs;\n\n\tif (ri->flags & RATE_INFO_FLAGS_HE_MCS)\n\t\tstat->encoding = RX_ENC_HE;\n\telse if (ri->flags & RATE_INFO_FLAGS_VHT_MCS)\n\t\tstat->encoding = RX_ENC_VHT;\n\telse if (ri->flags & RATE_INFO_FLAGS_MCS)\n\t\tstat->encoding = RX_ENC_HT;\n\telse\n\t\tstat->encoding = RX_ENC_LEGACY;\n\n\tif (ri->flags & RATE_INFO_FLAGS_SHORT_GI)\n\t\tstat->enc_flags |= RX_ENC_FLAG_SHORT_GI;\n\n\tstat->he_gi = ri->he_gi;\n\n\tif (stat->encoding != RX_ENC_LEGACY)\n\t\treturn true;\n\n\tstat->rate_idx = 0;\n\tfor (i = 0; i < sband->n_bitrates; i++) {\n\t\tif (ri->legacy != sband->bitrates[i].bitrate)\n\t\t\tcontinue;\n\n\t\tstat->rate_idx = i;\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic int ieee80211_fill_rx_status(struct ieee80211_rx_status *stat,\n\t\t\t\t    struct ieee80211_hw *hw,\n\t\t\t\t    struct ieee80211_tx_rate *rate,\n\t\t\t\t    struct rate_info *ri, u8 band, int len)\n{\n\tmemset(stat, 0, sizeof(*stat));\n\tstat->band = band;\n\n\tif (ieee80211_fill_rate_info(hw, stat, band, ri))\n\t\treturn 0;\n\n\tif (rate->idx < 0 || !rate->count)\n\t\treturn -1;\n\n\tif (rate->flags & IEEE80211_TX_RC_160_MHZ_WIDTH)\n\t\tstat->bw = RATE_INFO_BW_160;\n\telse if (rate->flags & IEEE80211_TX_RC_80_MHZ_WIDTH)\n\t\tstat->bw = RATE_INFO_BW_80;\n\telse if (rate->flags & IEEE80211_TX_RC_40_MHZ_WIDTH)\n\t\tstat->bw = RATE_INFO_BW_40;\n\telse\n\t\tstat->bw = RATE_INFO_BW_20;\n\n\tstat->enc_flags = 0;\n\tif (rate->flags & IEEE80211_TX_RC_USE_SHORT_PREAMBLE)\n\t\tstat->enc_flags |= RX_ENC_FLAG_SHORTPRE;\n\tif (rate->flags & IEEE80211_TX_RC_SHORT_GI)\n\t\tstat->enc_flags |= RX_ENC_FLAG_SHORT_GI;\n\n\tstat->rate_idx = rate->idx;\n\tif (rate->flags & IEEE80211_TX_RC_VHT_MCS) {\n\t\tstat->encoding = RX_ENC_VHT;\n\t\tstat->rate_idx = ieee80211_rate_get_vht_mcs(rate);\n\t\tstat->nss = ieee80211_rate_get_vht_nss(rate);\n\t} else if (rate->flags & IEEE80211_TX_RC_MCS) {\n\t\tstat->encoding = RX_ENC_HT;\n\t} else {\n\t\tstat->encoding = RX_ENC_LEGACY;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 ieee80211_calc_tx_airtime_rate(struct ieee80211_hw *hw,\n\t\t\t\t\t  struct ieee80211_tx_rate *rate,\n\t\t\t\t\t  struct rate_info *ri,\n\t\t\t\t\t  u8 band, int len)\n{\n\tstruct ieee80211_rx_status stat;\n\n\tif (ieee80211_fill_rx_status(&stat, hw, rate, ri, band, len))\n\t\treturn 0;\n\n\treturn ieee80211_calc_rx_airtime(hw, &stat, len);\n}\n\nu32 ieee80211_calc_tx_airtime(struct ieee80211_hw *hw,\n\t\t\t      struct ieee80211_tx_info *info,\n\t\t\t      int len)\n{\n\tu32 duration = 0;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(info->status.rates); i++) {\n\t\tstruct ieee80211_tx_rate *rate = &info->status.rates[i];\n\t\tu32 cur_duration;\n\n\t\tcur_duration = ieee80211_calc_tx_airtime_rate(hw, rate, NULL,\n\t\t\t\t\t\t\t      info->band, len);\n\t\tif (!cur_duration)\n\t\t\tbreak;\n\n\t\tduration += cur_duration * rate->count;\n\t}\n\n\treturn duration;\n}\nEXPORT_SYMBOL_GPL(ieee80211_calc_tx_airtime);\n\nu32 ieee80211_calc_expected_tx_airtime(struct ieee80211_hw *hw,\n\t\t\t\t       struct ieee80211_vif *vif,\n\t\t\t\t       struct ieee80211_sta *pubsta,\n\t\t\t\t       int len, bool ampdu)\n{\n\tstruct ieee80211_supported_band *sband;\n\tstruct ieee80211_chanctx_conf *conf;\n\tint rateidx, shift = 0;\n\tbool cck, short_pream;\n\tu32 basic_rates;\n\tu8 band = 0;\n\tu16 rate;\n\n\tlen += 38;  \n\n\tconf = rcu_dereference(vif->bss_conf.chanctx_conf);\n\tif (conf) {\n\t\tband = conf->def.chan->band;\n\t\tshift = ieee80211_chandef_get_shift(&conf->def);\n\t}\n\n\tif (pubsta) {\n\t\tstruct sta_info *sta = container_of(pubsta, struct sta_info,\n\t\t\t\t\t\t    sta);\n\t\tstruct ieee80211_rx_status stat;\n\t\tstruct ieee80211_tx_rate *tx_rate = &sta->deflink.tx_stats.last_rate;\n\t\tstruct rate_info *ri = &sta->deflink.tx_stats.last_rate_info;\n\t\tu32 duration, overhead;\n\t\tu8 agg_shift;\n\n\t\tif (ieee80211_fill_rx_status(&stat, hw, tx_rate, ri, band, len))\n\t\t\treturn 0;\n\n\t\tif (stat.encoding == RX_ENC_LEGACY || !ampdu)\n\t\t\treturn ieee80211_calc_rx_airtime(hw, &stat, len);\n\n\t\tduration = ieee80211_get_rate_duration(hw, &stat, &overhead);\n\t\t \n\t\tif (duration > 400 * 1024)  \n\t\t\tagg_shift = 1;\n\t\telse if (duration > 250 * 1024)  \n\t\t\tagg_shift = 2;\n\t\telse if (duration > 150 * 1024)  \n\t\t\tagg_shift = 3;\n\t\telse if (duration > 70 * 1024)  \n\t\t\tagg_shift = 4;\n\t\telse if (stat.encoding != RX_ENC_HE ||\n\t\t\t duration > 20 * 1024)  \n\t\t\tagg_shift = 5;\n\t\telse\n\t\t\tagg_shift = 6;\n\n\t\tduration *= len;\n\t\tduration /= AVG_PKT_SIZE;\n\t\tduration /= 1024;\n\t\tduration += (overhead >> agg_shift);\n\n\t\treturn max_t(u32, duration, 4);\n\t}\n\n\tif (!conf)\n\t\treturn 0;\n\n\t \n\tsband = hw->wiphy->bands[band];\n\n\tbasic_rates = vif->bss_conf.basic_rates;\n\tshort_pream = vif->bss_conf.use_short_preamble;\n\n\trateidx = basic_rates ? ffs(basic_rates) - 1 : 0;\n\trate = sband->bitrates[rateidx].bitrate << shift;\n\tcck = sband->bitrates[rateidx].flags & IEEE80211_RATE_MANDATORY_B;\n\n\treturn ieee80211_calc_legacy_rate_duration(rate, short_pream, cck, len);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}