{
  "module_name": "pm.c",
  "hash_id": "f1aa07f707b316bf000540c9db7a354e58139355051d7bb22d58d9132b052a97",
  "original_prompt": "Ingested from linux-6.6.14/net/mac80211/pm.c",
  "human_readable_source": "\n \n#include <net/mac80211.h>\n#include <net/rtnetlink.h>\n\n#include \"ieee80211_i.h\"\n#include \"mesh.h\"\n#include \"driver-ops.h\"\n#include \"led.h\"\n\nstatic void ieee80211_sched_scan_cancel(struct ieee80211_local *local)\n{\n\tif (ieee80211_request_sched_scan_stop(local))\n\t\treturn;\n\tcfg80211_sched_scan_stopped_locked(local->hw.wiphy, 0);\n}\n\nint __ieee80211_suspend(struct ieee80211_hw *hw, struct cfg80211_wowlan *wowlan)\n{\n\tstruct ieee80211_local *local = hw_to_local(hw);\n\tstruct ieee80211_sub_if_data *sdata;\n\tstruct sta_info *sta;\n\n\tif (!local->open_count)\n\t\tgoto suspend;\n\n\tlocal->suspending = true;\n\tmb();  \n\n\tieee80211_scan_cancel(local);\n\n\tieee80211_dfs_cac_cancel(local);\n\n\tieee80211_roc_purge(local, NULL);\n\n\tieee80211_del_virtual_monitor(local);\n\n\tif (ieee80211_hw_check(hw, AMPDU_AGGREGATION) &&\n\t    !(wowlan && wowlan->any)) {\n\t\tmutex_lock(&local->sta_mtx);\n\t\tlist_for_each_entry(sta, &local->sta_list, list) {\n\t\t\tset_sta_flag(sta, WLAN_STA_BLOCK_BA);\n\t\t\tieee80211_sta_tear_down_BA_sessions(\n\t\t\t\t\tsta, AGG_STOP_LOCAL_REQUEST);\n\t\t}\n\t\tmutex_unlock(&local->sta_mtx);\n\t}\n\n\t \n\tif (!(wowlan && wowlan->any))\n\t\tieee80211_sched_scan_cancel(local);\n\n\tieee80211_stop_queues_by_reason(hw,\n\t\t\t\t\tIEEE80211_MAX_QUEUE_MAP,\n\t\t\t\t\tIEEE80211_QUEUE_STOP_REASON_SUSPEND,\n\t\t\t\t\tfalse);\n\n\t \n\tsynchronize_net();\n\n\tieee80211_flush_queues(local, NULL, true);\n\n\tlocal->quiescing = true;\n\t \n\tmb();\n\n\tflush_workqueue(local->workqueue);\n\n\t \n\tdel_timer_sync(&local->sta_cleanup);\n\n\t  \n\tcancel_work_sync(&local->dynamic_ps_enable_work);\n\tdel_timer_sync(&local->dynamic_ps_timer);\n\n\tlocal->wowlan = wowlan;\n\tif (local->wowlan) {\n\t\tint err;\n\n\t\t \n\t\tlist_for_each_entry(sdata, &local->interfaces, list) {\n\t\t\tif (!ieee80211_sdata_running(sdata))\n\t\t\t\tcontinue;\n\t\t\tif (sdata->vif.type != NL80211_IFTYPE_STATION)\n\t\t\t\tcontinue;\n\t\t\tieee80211_mgd_quiesce(sdata);\n\t\t\t \n\t\t\tif (sdata->u.mgd.associated &&\n\t\t\t    sdata->u.mgd.powersave &&\n\t\t\t     !(local->hw.conf.flags & IEEE80211_CONF_PS)) {\n\t\t\t\tlocal->hw.conf.flags |= IEEE80211_CONF_PS;\n\t\t\t\tieee80211_hw_config(local,\n\t\t\t\t\t\t    IEEE80211_CONF_CHANGE_PS);\n\t\t\t}\n\t\t}\n\n\t\terr = drv_suspend(local, wowlan);\n\t\tif (err < 0) {\n\t\t\tlocal->quiescing = false;\n\t\t\tlocal->wowlan = false;\n\t\t\tif (ieee80211_hw_check(hw, AMPDU_AGGREGATION)) {\n\t\t\t\tmutex_lock(&local->sta_mtx);\n\t\t\t\tlist_for_each_entry(sta,\n\t\t\t\t\t\t    &local->sta_list, list) {\n\t\t\t\t\tclear_sta_flag(sta, WLAN_STA_BLOCK_BA);\n\t\t\t\t}\n\t\t\t\tmutex_unlock(&local->sta_mtx);\n\t\t\t}\n\t\t\tieee80211_wake_queues_by_reason(hw,\n\t\t\t\t\tIEEE80211_MAX_QUEUE_MAP,\n\t\t\t\t\tIEEE80211_QUEUE_STOP_REASON_SUSPEND,\n\t\t\t\t\tfalse);\n\t\t\treturn err;\n\t\t} else if (err > 0) {\n\t\t\tWARN_ON(err != 1);\n\t\t\t \n\t\t\tieee80211_wake_queues_by_reason(hw,\n\t\t\t\t\tIEEE80211_MAX_QUEUE_MAP,\n\t\t\t\t\tIEEE80211_QUEUE_STOP_REASON_SUSPEND,\n\t\t\t\t\tfalse);\n\t\t\treturn err;\n\t\t} else {\n\t\t\tgoto suspend;\n\t\t}\n\t}\n\n\t \n\tlist_for_each_entry(sdata, &local->interfaces, list) {\n\t\tif (!ieee80211_sdata_running(sdata))\n\t\t\tcontinue;\n\t\tswitch (sdata->vif.type) {\n\t\tcase NL80211_IFTYPE_AP_VLAN:\n\t\tcase NL80211_IFTYPE_MONITOR:\n\t\t\tcontinue;\n\t\tcase NL80211_IFTYPE_STATION:\n\t\t\tieee80211_mgd_quiesce(sdata);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tflush_delayed_work(&sdata->dec_tailroom_needed_wk);\n\t\tdrv_remove_interface(local, sdata);\n\t}\n\n\t \n\tWARN_ON(!list_empty(&local->chanctx_list));\n\n\t \n\tieee80211_stop_device(local);\n\n suspend:\n\tlocal->suspended = true;\n\t \n\tbarrier();\n\tlocal->quiescing = false;\n\tlocal->suspending = false;\n\n\treturn 0;\n}\n\n \n\nvoid ieee80211_report_wowlan_wakeup(struct ieee80211_vif *vif,\n\t\t\t\t    struct cfg80211_wowlan_wakeup *wakeup,\n\t\t\t\t    gfp_t gfp)\n{\n\tstruct ieee80211_sub_if_data *sdata = vif_to_sdata(vif);\n\n\tcfg80211_report_wowlan_wakeup(&sdata->wdev, wakeup, gfp);\n}\nEXPORT_SYMBOL(ieee80211_report_wowlan_wakeup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}