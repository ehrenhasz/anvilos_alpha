{
  "module_name": "debugfs_key.c",
  "hash_id": "92ec70e7d26cc52cb46716656792486007a270f33fdec48e0f7fab057f00a192",
  "original_prompt": "Ingested from linux-6.6.14/net/mac80211/debugfs_key.c",
  "human_readable_source": "\n \n\n#include <linux/kobject.h>\n#include <linux/slab.h>\n#include \"ieee80211_i.h\"\n#include \"key.h\"\n#include \"debugfs.h\"\n#include \"debugfs_key.h\"\n\n#define KEY_READ(name, prop, format_string)\t\t\t\t\\\nstatic ssize_t key_##name##_read(struct file *file,\t\t\t\\\n\t\t\t\t char __user *userbuf,\t\t\t\\\n\t\t\t\t size_t count, loff_t *ppos)\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct ieee80211_key *key = file->private_data;\t\t\t\\\n\treturn mac80211_format_buffer(userbuf, count, ppos, \t\t\\\n\t\t\t\t      format_string, key->prop);\t\\\n}\n#define KEY_READ_X(name) KEY_READ(name, name, \"0x%x\\n\")\n\n#define KEY_OPS(name)\t\t\t\t\t\t\t\\\nstatic const struct file_operations key_ ##name## _ops = {\t\t\\\n\t.read = key_##name##_read,\t\t\t\t\t\\\n\t.open = simple_open,\t\t\t\t\t\t\\\n\t.llseek = generic_file_llseek,\t\t\t\t\t\\\n}\n\n#define KEY_OPS_W(name)\t\t\t\t\t\t\t\\\nstatic const struct file_operations key_ ##name## _ops = {\t\t\\\n\t.read = key_##name##_read,\t\t\t\t\t\\\n\t.write = key_##name##_write,\t\t\t\t\t\\\n\t.open = simple_open,\t\t\t\t\t\t\\\n\t.llseek = generic_file_llseek,\t\t\t\t\t\\\n}\n\n#define KEY_FILE(name, format)\t\t\t\t\t\t\\\n\t\t KEY_READ_##format(name)\t\t\t\t\\\n\t\t KEY_OPS(name)\n\n#define KEY_CONF_READ(name, format_string)\t\t\t\t\\\n\tKEY_READ(conf_##name, conf.name, format_string)\n#define KEY_CONF_READ_D(name) KEY_CONF_READ(name, \"%d\\n\")\n\n#define KEY_CONF_OPS(name)\t\t\t\t\t\t\\\nstatic const struct file_operations key_ ##name## _ops = {\t\t\\\n\t.read = key_conf_##name##_read,\t\t\t\t\t\\\n\t.open = simple_open,\t\t\t\t\t\t\\\n\t.llseek = generic_file_llseek,\t\t\t\t\t\\\n}\n\n#define KEY_CONF_FILE(name, format)\t\t\t\t\t\\\n\t\t KEY_CONF_READ_##format(name)\t\t\t\t\\\n\t\t KEY_CONF_OPS(name)\n\nKEY_CONF_FILE(keylen, D);\nKEY_CONF_FILE(keyidx, D);\nKEY_CONF_FILE(hw_key_idx, D);\nKEY_FILE(flags, X);\nKEY_READ(ifindex, sdata->name, \"%s\\n\");\nKEY_OPS(ifindex);\n\nstatic ssize_t key_algorithm_read(struct file *file,\n\t\t\t\t  char __user *userbuf,\n\t\t\t\t  size_t count, loff_t *ppos)\n{\n\tchar buf[15];\n\tstruct ieee80211_key *key = file->private_data;\n\tu32 c = key->conf.cipher;\n\n\tsprintf(buf, \"%.2x-%.2x-%.2x:%d\\n\",\n\t\tc >> 24, (c >> 16) & 0xff, (c >> 8) & 0xff, c & 0xff);\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, strlen(buf));\n}\nKEY_OPS(algorithm);\n\nstatic ssize_t key_tx_spec_write(struct file *file, const char __user *userbuf,\n\t\t\t\t size_t count, loff_t *ppos)\n{\n\tstruct ieee80211_key *key = file->private_data;\n\tu64 pn;\n\tint ret;\n\n\tswitch (key->conf.cipher) {\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\treturn -EINVAL;\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\t \n\t\treturn -EOPNOTSUPP;\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\tcase WLAN_CIPHER_SUITE_CCMP_256:\n\tcase WLAN_CIPHER_SUITE_AES_CMAC:\n\tcase WLAN_CIPHER_SUITE_BIP_CMAC_256:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_128:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_256:\n\tcase WLAN_CIPHER_SUITE_GCMP:\n\tcase WLAN_CIPHER_SUITE_GCMP_256:\n\t\tret = kstrtou64_from_user(userbuf, count, 16, &pn);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\t \n\t\tif (pn >= (1ULL << 48))\n\t\t\treturn -ERANGE;\n\t\tatomic64_set(&key->conf.tx_pn, pn);\n\t\treturn count;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic ssize_t key_tx_spec_read(struct file *file, char __user *userbuf,\n\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tu64 pn;\n\tchar buf[20];\n\tint len;\n\tstruct ieee80211_key *key = file->private_data;\n\n\tswitch (key->conf.cipher) {\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\tlen = scnprintf(buf, sizeof(buf), \"\\n\");\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\tpn = atomic64_read(&key->conf.tx_pn);\n\t\tlen = scnprintf(buf, sizeof(buf), \"%08x %04x\\n\",\n\t\t\t\tTKIP_PN_TO_IV32(pn),\n\t\t\t\tTKIP_PN_TO_IV16(pn));\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\tcase WLAN_CIPHER_SUITE_CCMP_256:\n\tcase WLAN_CIPHER_SUITE_AES_CMAC:\n\tcase WLAN_CIPHER_SUITE_BIP_CMAC_256:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_128:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_256:\n\tcase WLAN_CIPHER_SUITE_GCMP:\n\tcase WLAN_CIPHER_SUITE_GCMP_256:\n\t\tpn = atomic64_read(&key->conf.tx_pn);\n\t\tlen = scnprintf(buf, sizeof(buf), \"%02x%02x%02x%02x%02x%02x\\n\",\n\t\t\t\t(u8)(pn >> 40), (u8)(pn >> 32), (u8)(pn >> 24),\n\t\t\t\t(u8)(pn >> 16), (u8)(pn >> 8), (u8)pn);\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\n}\nKEY_OPS_W(tx_spec);\n\nstatic ssize_t key_rx_spec_read(struct file *file, char __user *userbuf,\n\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct ieee80211_key *key = file->private_data;\n\tchar buf[14*IEEE80211_NUM_TIDS+1], *p = buf;\n\tint i, len;\n\tconst u8 *rpn;\n\n\tswitch (key->conf.cipher) {\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\tlen = scnprintf(buf, sizeof(buf), \"\\n\");\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\tfor (i = 0; i < IEEE80211_NUM_TIDS; i++)\n\t\t\tp += scnprintf(p, sizeof(buf)+buf-p,\n\t\t\t\t       \"%08x %04x\\n\",\n\t\t\t\t       key->u.tkip.rx[i].iv32,\n\t\t\t\t       key->u.tkip.rx[i].iv16);\n\t\tlen = p - buf;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\tcase WLAN_CIPHER_SUITE_CCMP_256:\n\t\tfor (i = 0; i < IEEE80211_NUM_TIDS + 1; i++) {\n\t\t\trpn = key->u.ccmp.rx_pn[i];\n\t\t\tp += scnprintf(p, sizeof(buf)+buf-p,\n\t\t\t\t       \"%02x%02x%02x%02x%02x%02x\\n\",\n\t\t\t\t       rpn[0], rpn[1], rpn[2],\n\t\t\t\t       rpn[3], rpn[4], rpn[5]);\n\t\t}\n\t\tlen = p - buf;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_AES_CMAC:\n\tcase WLAN_CIPHER_SUITE_BIP_CMAC_256:\n\t\trpn = key->u.aes_cmac.rx_pn;\n\t\tp += scnprintf(p, sizeof(buf)+buf-p,\n\t\t\t       \"%02x%02x%02x%02x%02x%02x\\n\",\n\t\t\t       rpn[0], rpn[1], rpn[2],\n\t\t\t       rpn[3], rpn[4], rpn[5]);\n\t\tlen = p - buf;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_128:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_256:\n\t\trpn = key->u.aes_gmac.rx_pn;\n\t\tp += scnprintf(p, sizeof(buf)+buf-p,\n\t\t\t       \"%02x%02x%02x%02x%02x%02x\\n\",\n\t\t\t       rpn[0], rpn[1], rpn[2],\n\t\t\t       rpn[3], rpn[4], rpn[5]);\n\t\tlen = p - buf;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_GCMP:\n\tcase WLAN_CIPHER_SUITE_GCMP_256:\n\t\tfor (i = 0; i < IEEE80211_NUM_TIDS + 1; i++) {\n\t\t\trpn = key->u.gcmp.rx_pn[i];\n\t\t\tp += scnprintf(p, sizeof(buf)+buf-p,\n\t\t\t\t       \"%02x%02x%02x%02x%02x%02x\\n\",\n\t\t\t\t       rpn[0], rpn[1], rpn[2],\n\t\t\t\t       rpn[3], rpn[4], rpn[5]);\n\t\t}\n\t\tlen = p - buf;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\n}\nKEY_OPS(rx_spec);\n\nstatic ssize_t key_replays_read(struct file *file, char __user *userbuf,\n\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct ieee80211_key *key = file->private_data;\n\tchar buf[20];\n\tint len;\n\n\tswitch (key->conf.cipher) {\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\tcase WLAN_CIPHER_SUITE_CCMP_256:\n\t\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\", key->u.ccmp.replays);\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_AES_CMAC:\n\tcase WLAN_CIPHER_SUITE_BIP_CMAC_256:\n\t\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\",\n\t\t\t\tkey->u.aes_cmac.replays);\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_128:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_256:\n\t\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\",\n\t\t\t\tkey->u.aes_gmac.replays);\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_GCMP:\n\tcase WLAN_CIPHER_SUITE_GCMP_256:\n\t\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\", key->u.gcmp.replays);\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\n}\nKEY_OPS(replays);\n\nstatic ssize_t key_icverrors_read(struct file *file, char __user *userbuf,\n\t\t\t\t  size_t count, loff_t *ppos)\n{\n\tstruct ieee80211_key *key = file->private_data;\n\tchar buf[20];\n\tint len;\n\n\tswitch (key->conf.cipher) {\n\tcase WLAN_CIPHER_SUITE_AES_CMAC:\n\tcase WLAN_CIPHER_SUITE_BIP_CMAC_256:\n\t\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\",\n\t\t\t\tkey->u.aes_cmac.icverrors);\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_128:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_256:\n\t\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\",\n\t\t\t\tkey->u.aes_gmac.icverrors);\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\n}\nKEY_OPS(icverrors);\n\nstatic ssize_t key_mic_failures_read(struct file *file, char __user *userbuf,\n\t\t\t\t     size_t count, loff_t *ppos)\n{\n\tstruct ieee80211_key *key = file->private_data;\n\tchar buf[20];\n\tint len;\n\n\tif (key->conf.cipher != WLAN_CIPHER_SUITE_TKIP)\n\t\treturn -EINVAL;\n\n\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\", key->u.tkip.mic_failures);\n\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\n}\nKEY_OPS(mic_failures);\n\nstatic ssize_t key_key_read(struct file *file, char __user *userbuf,\n\t\t\t    size_t count, loff_t *ppos)\n{\n\tstruct ieee80211_key *key = file->private_data;\n\tint i, bufsize = 2 * key->conf.keylen + 2;\n\tchar *buf = kmalloc(bufsize, GFP_KERNEL);\n\tchar *p = buf;\n\tssize_t res;\n\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < key->conf.keylen; i++)\n\t\tp += scnprintf(p, bufsize + buf - p, \"%02x\", key->conf.key[i]);\n\tp += scnprintf(p, bufsize+buf-p, \"\\n\");\n\tres = simple_read_from_buffer(userbuf, count, ppos, buf, p - buf);\n\tkfree(buf);\n\treturn res;\n}\nKEY_OPS(key);\n\n#define DEBUGFS_ADD(name) \\\n\tdebugfs_create_file(#name, 0400, key->debugfs.dir, \\\n\t\t\t    key, &key_##name##_ops)\n#define DEBUGFS_ADD_W(name) \\\n\tdebugfs_create_file(#name, 0600, key->debugfs.dir, \\\n\t\t\t    key, &key_##name##_ops);\n\nvoid ieee80211_debugfs_key_add(struct ieee80211_key *key)\n{\n\tstatic int keycount;\n\tchar buf[100];\n\tstruct sta_info *sta;\n\n\tif (!key->local->debugfs.keys)\n\t\treturn;\n\n\tsprintf(buf, \"%d\", keycount);\n\tkey->debugfs.cnt = keycount;\n\tkeycount++;\n\tkey->debugfs.dir = debugfs_create_dir(buf,\n\t\t\t\t\tkey->local->debugfs.keys);\n\n\tsta = key->sta;\n\tif (sta) {\n\t\tsprintf(buf, \"../../netdev:%s/stations/%pM\",\n\t\t\tsta->sdata->name, sta->sta.addr);\n\t\tkey->debugfs.stalink =\n\t\t\tdebugfs_create_symlink(\"station\", key->debugfs.dir, buf);\n\t}\n\n\tDEBUGFS_ADD(keylen);\n\tDEBUGFS_ADD(flags);\n\tDEBUGFS_ADD(keyidx);\n\tDEBUGFS_ADD(hw_key_idx);\n\tDEBUGFS_ADD(algorithm);\n\tDEBUGFS_ADD_W(tx_spec);\n\tDEBUGFS_ADD(rx_spec);\n\tDEBUGFS_ADD(replays);\n\tDEBUGFS_ADD(icverrors);\n\tDEBUGFS_ADD(mic_failures);\n\tDEBUGFS_ADD(key);\n\tDEBUGFS_ADD(ifindex);\n};\n\nvoid ieee80211_debugfs_key_remove(struct ieee80211_key *key)\n{\n\tif (!key)\n\t\treturn;\n\n\tdebugfs_remove_recursive(key->debugfs.dir);\n\tkey->debugfs.dir = NULL;\n}\n\nvoid ieee80211_debugfs_key_update_default(struct ieee80211_sub_if_data *sdata)\n{\n\tchar buf[50];\n\tstruct ieee80211_key *key;\n\n\tif (!sdata->vif.debugfs_dir)\n\t\treturn;\n\n\tlockdep_assert_held(&sdata->local->key_mtx);\n\n\tdebugfs_remove(sdata->debugfs.default_unicast_key);\n\tsdata->debugfs.default_unicast_key = NULL;\n\n\tif (sdata->default_unicast_key) {\n\t\tkey = key_mtx_dereference(sdata->local,\n\t\t\t\t\t  sdata->default_unicast_key);\n\t\tsprintf(buf, \"../keys/%d\", key->debugfs.cnt);\n\t\tsdata->debugfs.default_unicast_key =\n\t\t\tdebugfs_create_symlink(\"default_unicast_key\",\n\t\t\t\t\t       sdata->vif.debugfs_dir, buf);\n\t}\n\n\tdebugfs_remove(sdata->debugfs.default_multicast_key);\n\tsdata->debugfs.default_multicast_key = NULL;\n\n\tif (sdata->deflink.default_multicast_key) {\n\t\tkey = key_mtx_dereference(sdata->local,\n\t\t\t\t\t  sdata->deflink.default_multicast_key);\n\t\tsprintf(buf, \"../keys/%d\", key->debugfs.cnt);\n\t\tsdata->debugfs.default_multicast_key =\n\t\t\tdebugfs_create_symlink(\"default_multicast_key\",\n\t\t\t\t\t       sdata->vif.debugfs_dir, buf);\n\t}\n}\n\nvoid ieee80211_debugfs_key_add_mgmt_default(struct ieee80211_sub_if_data *sdata)\n{\n\tchar buf[50];\n\tstruct ieee80211_key *key;\n\n\tif (!sdata->vif.debugfs_dir)\n\t\treturn;\n\n\tkey = key_mtx_dereference(sdata->local,\n\t\t\t\t  sdata->deflink.default_mgmt_key);\n\tif (key) {\n\t\tsprintf(buf, \"../keys/%d\", key->debugfs.cnt);\n\t\tsdata->debugfs.default_mgmt_key =\n\t\t\tdebugfs_create_symlink(\"default_mgmt_key\",\n\t\t\t\t\t       sdata->vif.debugfs_dir, buf);\n\t} else\n\t\tieee80211_debugfs_key_remove_mgmt_default(sdata);\n}\n\nvoid ieee80211_debugfs_key_remove_mgmt_default(struct ieee80211_sub_if_data *sdata)\n{\n\tif (!sdata)\n\t\treturn;\n\n\tdebugfs_remove(sdata->debugfs.default_mgmt_key);\n\tsdata->debugfs.default_mgmt_key = NULL;\n}\n\nvoid\nieee80211_debugfs_key_add_beacon_default(struct ieee80211_sub_if_data *sdata)\n{\n\tchar buf[50];\n\tstruct ieee80211_key *key;\n\n\tif (!sdata->vif.debugfs_dir)\n\t\treturn;\n\n\tkey = key_mtx_dereference(sdata->local,\n\t\t\t\t  sdata->deflink.default_beacon_key);\n\tif (key) {\n\t\tsprintf(buf, \"../keys/%d\", key->debugfs.cnt);\n\t\tsdata->debugfs.default_beacon_key =\n\t\t\tdebugfs_create_symlink(\"default_beacon_key\",\n\t\t\t\t\t       sdata->vif.debugfs_dir, buf);\n\t} else {\n\t\tieee80211_debugfs_key_remove_beacon_default(sdata);\n\t}\n}\n\nvoid\nieee80211_debugfs_key_remove_beacon_default(struct ieee80211_sub_if_data *sdata)\n{\n\tif (!sdata)\n\t\treturn;\n\n\tdebugfs_remove(sdata->debugfs.default_beacon_key);\n\tsdata->debugfs.default_beacon_key = NULL;\n}\n\nvoid ieee80211_debugfs_key_sta_del(struct ieee80211_key *key,\n\t\t\t\t   struct sta_info *sta)\n{\n\tdebugfs_remove(key->debugfs.stalink);\n\tkey->debugfs.stalink = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}