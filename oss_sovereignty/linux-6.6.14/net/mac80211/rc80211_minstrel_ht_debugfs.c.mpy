{
  "module_name": "rc80211_minstrel_ht_debugfs.c",
  "hash_id": "cfab3edf54569a880fc5aa7411f162cf3c35fe2d3a9a3d10195b21c351f90eb6",
  "original_prompt": "Ingested from linux-6.6.14/net/mac80211/rc80211_minstrel_ht_debugfs.c",
  "human_readable_source": "\n \n#include <linux/netdevice.h>\n#include <linux/types.h>\n#include <linux/skbuff.h>\n#include <linux/debugfs.h>\n#include <linux/ieee80211.h>\n#include <linux/export.h>\n#include <net/mac80211.h>\n#include \"rc80211_minstrel_ht.h\"\n\nstruct minstrel_debugfs_info {\n\tsize_t len;\n\tchar buf[];\n};\n\nstatic ssize_t\nminstrel_stats_read(struct file *file, char __user *buf, size_t len, loff_t *ppos)\n{\n\tstruct minstrel_debugfs_info *ms;\n\n\tms = file->private_data;\n\treturn simple_read_from_buffer(buf, len, ppos, ms->buf, ms->len);\n}\n\nstatic int\nminstrel_stats_release(struct inode *inode, struct file *file)\n{\n\tkfree(file->private_data);\n\treturn 0;\n}\n\nstatic bool\nminstrel_ht_is_sample_rate(struct minstrel_ht_sta *mi, int idx)\n{\n\tint type, i;\n\n\tfor (type = 0; type < ARRAY_SIZE(mi->sample); type++)\n\t\tfor (i = 0; i < MINSTREL_SAMPLE_RATES; i++)\n\t\t\tif (mi->sample[type].cur_sample_rates[i] == idx)\n\t\t\t\treturn true;\n\treturn false;\n}\n\nstatic char *\nminstrel_ht_stats_dump(struct minstrel_ht_sta *mi, int i, char *p)\n{\n\tconst struct mcs_group *mg;\n\tunsigned int j, tp_max, tp_avg, eprob, tx_time;\n\tchar htmode = '2';\n\tchar gimode = 'L';\n\tu32 gflags;\n\n\tif (!mi->supported[i])\n\t\treturn p;\n\n\tmg = &minstrel_mcs_groups[i];\n\tgflags = mg->flags;\n\n\tif (gflags & IEEE80211_TX_RC_40_MHZ_WIDTH)\n\t\thtmode = '4';\n\telse if (gflags & IEEE80211_TX_RC_80_MHZ_WIDTH)\n\t\thtmode = '8';\n\tif (gflags & IEEE80211_TX_RC_SHORT_GI)\n\t\tgimode = 'S';\n\n\tfor (j = 0; j < MCS_GROUP_RATES; j++) {\n\t\tstruct minstrel_rate_stats *mrs = &mi->groups[i].rates[j];\n\t\tint idx = MI_RATE(i, j);\n\t\tunsigned int duration;\n\n\t\tif (!(mi->supported[i] & BIT(j)))\n\t\t\tcontinue;\n\n\t\tif (gflags & IEEE80211_TX_RC_MCS) {\n\t\t\tp += sprintf(p, \"HT%c0  \", htmode);\n\t\t\tp += sprintf(p, \"%cGI  \", gimode);\n\t\t\tp += sprintf(p, \"%d  \", mg->streams);\n\t\t} else if (gflags & IEEE80211_TX_RC_VHT_MCS) {\n\t\t\tp += sprintf(p, \"VHT%c0 \", htmode);\n\t\t\tp += sprintf(p, \"%cGI \", gimode);\n\t\t\tp += sprintf(p, \"%d  \", mg->streams);\n\t\t} else if (i == MINSTREL_OFDM_GROUP) {\n\t\t\tp += sprintf(p, \"OFDM       \");\n\t\t\tp += sprintf(p, \"1 \");\n\t\t} else {\n\t\t\tp += sprintf(p, \"CCK    \");\n\t\t\tp += sprintf(p, \"%cP  \", j < 4 ? 'L' : 'S');\n\t\t\tp += sprintf(p, \"1 \");\n\t\t}\n\n\t\t*(p++) = (idx == mi->max_tp_rate[0]) ? 'A' : ' ';\n\t\t*(p++) = (idx == mi->max_tp_rate[1]) ? 'B' : ' ';\n\t\t*(p++) = (idx == mi->max_tp_rate[2]) ? 'C' : ' ';\n\t\t*(p++) = (idx == mi->max_tp_rate[3]) ? 'D' : ' ';\n\t\t*(p++) = (idx == mi->max_prob_rate) ? 'P' : ' ';\n\t\t*(p++) = minstrel_ht_is_sample_rate(mi, idx) ? 'S' : ' ';\n\n\t\tif (gflags & IEEE80211_TX_RC_MCS) {\n\t\t\tp += sprintf(p, \"  MCS%-2u\", (mg->streams - 1) * 8 + j);\n\t\t} else if (gflags & IEEE80211_TX_RC_VHT_MCS) {\n\t\t\tp += sprintf(p, \"  MCS%-1u/%1u\", j, mg->streams);\n\t\t} else {\n\t\t\tint r;\n\n\t\t\tif (i == MINSTREL_OFDM_GROUP)\n\t\t\t\tr = minstrel_ofdm_bitrates[j % 8];\n\t\t\telse\n\t\t\t\tr = minstrel_cck_bitrates[j % 4];\n\n\t\t\tp += sprintf(p, \"   %2u.%1uM\", r / 10, r % 10);\n\t\t}\n\n\t\tp += sprintf(p, \"  %3u  \", idx);\n\n\t\t \n\t\tduration = mg->duration[j];\n\t\tduration <<= mg->shift;\n\t\ttx_time = DIV_ROUND_CLOSEST(duration, 1000);\n\t\tp += sprintf(p, \"%6u  \", tx_time);\n\n\t\ttp_max = minstrel_ht_get_tp_avg(mi, i, j, MINSTREL_FRAC(100, 100));\n\t\ttp_avg = minstrel_ht_get_tp_avg(mi, i, j, mrs->prob_avg);\n\t\teprob = MINSTREL_TRUNC(mrs->prob_avg * 1000);\n\n\t\tp += sprintf(p, \"%4u.%1u    %4u.%1u     %3u.%1u\"\n\t\t\t\t\"     %3u   %3u %-3u   \"\n\t\t\t\t\"%9llu   %-9llu\\n\",\n\t\t\t\ttp_max / 10, tp_max % 10,\n\t\t\t\ttp_avg / 10, tp_avg % 10,\n\t\t\t\teprob / 10, eprob % 10,\n\t\t\t\tmrs->retry_count,\n\t\t\t\tmrs->last_success,\n\t\t\t\tmrs->last_attempts,\n\t\t\t\t(unsigned long long)mrs->succ_hist,\n\t\t\t\t(unsigned long long)mrs->att_hist);\n\t}\n\n\treturn p;\n}\n\nstatic int\nminstrel_ht_stats_open(struct inode *inode, struct file *file)\n{\n\tstruct minstrel_ht_sta *mi = inode->i_private;\n\tstruct minstrel_debugfs_info *ms;\n\tunsigned int i;\n\tchar *p;\n\n\tms = kmalloc(32768, GFP_KERNEL);\n\tif (!ms)\n\t\treturn -ENOMEM;\n\n\tfile->private_data = ms;\n\tp = ms->buf;\n\n\tp += sprintf(p, \"\\n\");\n\tp += sprintf(p,\n\t\t     \"              best    ____________rate__________    ____statistics___    _____last____    ______sum-of________\\n\");\n\tp += sprintf(p,\n\t\t     \"mode guard #  rate   [name   idx airtime  max_tp]  [avg(tp) avg(prob)]  [retry|suc|att]  [#success | #attempts]\\n\");\n\n\tp = minstrel_ht_stats_dump(mi, MINSTREL_CCK_GROUP, p);\n\tfor (i = 0; i < MINSTREL_CCK_GROUP; i++)\n\t\tp = minstrel_ht_stats_dump(mi, i, p);\n\tfor (i++; i < ARRAY_SIZE(mi->groups); i++)\n\t\tp = minstrel_ht_stats_dump(mi, i, p);\n\n\tp += sprintf(p, \"\\nTotal packet count::    ideal %d      \"\n\t\t\t\"lookaround %d\\n\",\n\t\t\tmax(0, (int) mi->total_packets - (int) mi->sample_packets),\n\t\t\tmi->sample_packets);\n\tif (mi->avg_ampdu_len)\n\t\tp += sprintf(p, \"Average # of aggregated frames per A-MPDU: %d.%d\\n\",\n\t\t\tMINSTREL_TRUNC(mi->avg_ampdu_len),\n\t\t\tMINSTREL_TRUNC(mi->avg_ampdu_len * 10) % 10);\n\tms->len = p - ms->buf;\n\tWARN_ON(ms->len + sizeof(*ms) > 32768);\n\n\treturn nonseekable_open(inode, file);\n}\n\nstatic const struct file_operations minstrel_ht_stat_fops = {\n\t.owner = THIS_MODULE,\n\t.open = minstrel_ht_stats_open,\n\t.read = minstrel_stats_read,\n\t.release = minstrel_stats_release,\n\t.llseek = no_llseek,\n};\n\nstatic char *\nminstrel_ht_stats_csv_dump(struct minstrel_ht_sta *mi, int i, char *p)\n{\n\tconst struct mcs_group *mg;\n\tunsigned int j, tp_max, tp_avg, eprob, tx_time;\n\tchar htmode = '2';\n\tchar gimode = 'L';\n\tu32 gflags;\n\n\tif (!mi->supported[i])\n\t\treturn p;\n\n\tmg = &minstrel_mcs_groups[i];\n\tgflags = mg->flags;\n\n\tif (gflags & IEEE80211_TX_RC_40_MHZ_WIDTH)\n\t\thtmode = '4';\n\telse if (gflags & IEEE80211_TX_RC_80_MHZ_WIDTH)\n\t\thtmode = '8';\n\tif (gflags & IEEE80211_TX_RC_SHORT_GI)\n\t\tgimode = 'S';\n\n\tfor (j = 0; j < MCS_GROUP_RATES; j++) {\n\t\tstruct minstrel_rate_stats *mrs = &mi->groups[i].rates[j];\n\t\tint idx = MI_RATE(i, j);\n\t\tunsigned int duration;\n\n\t\tif (!(mi->supported[i] & BIT(j)))\n\t\t\tcontinue;\n\n\t\tif (gflags & IEEE80211_TX_RC_MCS) {\n\t\t\tp += sprintf(p, \"HT%c0,\", htmode);\n\t\t\tp += sprintf(p, \"%cGI,\", gimode);\n\t\t\tp += sprintf(p, \"%d,\", mg->streams);\n\t\t} else if (gflags & IEEE80211_TX_RC_VHT_MCS) {\n\t\t\tp += sprintf(p, \"VHT%c0,\", htmode);\n\t\t\tp += sprintf(p, \"%cGI,\", gimode);\n\t\t\tp += sprintf(p, \"%d,\", mg->streams);\n\t\t} else if (i == MINSTREL_OFDM_GROUP) {\n\t\t\tp += sprintf(p, \"OFDM,,1,\");\n\t\t} else {\n\t\t\tp += sprintf(p, \"CCK,\");\n\t\t\tp += sprintf(p, \"%cP,\", j < 4 ? 'L' : 'S');\n\t\t\tp += sprintf(p, \"1,\");\n\t\t}\n\n\t\tp += sprintf(p, \"%s\" ,((idx == mi->max_tp_rate[0]) ? \"A\" : \"\"));\n\t\tp += sprintf(p, \"%s\" ,((idx == mi->max_tp_rate[1]) ? \"B\" : \"\"));\n\t\tp += sprintf(p, \"%s\" ,((idx == mi->max_tp_rate[2]) ? \"C\" : \"\"));\n\t\tp += sprintf(p, \"%s\" ,((idx == mi->max_tp_rate[3]) ? \"D\" : \"\"));\n\t\tp += sprintf(p, \"%s\" ,((idx == mi->max_prob_rate) ? \"P\" : \"\"));\n\t\tp += sprintf(p, \"%s\", (minstrel_ht_is_sample_rate(mi, idx) ? \"S\" : \"\"));\n\n\t\tif (gflags & IEEE80211_TX_RC_MCS) {\n\t\t\tp += sprintf(p, \",MCS%-2u,\", (mg->streams - 1) * 8 + j);\n\t\t} else if (gflags & IEEE80211_TX_RC_VHT_MCS) {\n\t\t\tp += sprintf(p, \",MCS%-1u/%1u,\", j, mg->streams);\n\t\t} else {\n\t\t\tint r;\n\n\t\t\tif (i == MINSTREL_OFDM_GROUP)\n\t\t\t\tr = minstrel_ofdm_bitrates[j % 8];\n\t\t\telse\n\t\t\t\tr = minstrel_cck_bitrates[j % 4];\n\n\t\t\tp += sprintf(p, \",%2u.%1uM,\", r / 10, r % 10);\n\t\t}\n\n\t\tp += sprintf(p, \"%u,\", idx);\n\n\t\tduration = mg->duration[j];\n\t\tduration <<= mg->shift;\n\t\ttx_time = DIV_ROUND_CLOSEST(duration, 1000);\n\t\tp += sprintf(p, \"%u,\", tx_time);\n\n\t\ttp_max = minstrel_ht_get_tp_avg(mi, i, j, MINSTREL_FRAC(100, 100));\n\t\ttp_avg = minstrel_ht_get_tp_avg(mi, i, j, mrs->prob_avg);\n\t\teprob = MINSTREL_TRUNC(mrs->prob_avg * 1000);\n\n\t\tp += sprintf(p, \"%u.%u,%u.%u,%u.%u,%u,%u,\"\n\t\t\t\t\"%u,%llu,%llu,\",\n\t\t\t\ttp_max / 10, tp_max % 10,\n\t\t\t\ttp_avg / 10, tp_avg % 10,\n\t\t\t\teprob / 10, eprob % 10,\n\t\t\t\tmrs->retry_count,\n\t\t\t\tmrs->last_success,\n\t\t\t\tmrs->last_attempts,\n\t\t\t\t(unsigned long long)mrs->succ_hist,\n\t\t\t\t(unsigned long long)mrs->att_hist);\n\t\tp += sprintf(p, \"%d,%d,%d.%d\\n\",\n\t\t\t\tmax(0, (int) mi->total_packets -\n\t\t\t\t(int) mi->sample_packets),\n\t\t\t\tmi->sample_packets,\n\t\t\t\tMINSTREL_TRUNC(mi->avg_ampdu_len),\n\t\t\t\tMINSTREL_TRUNC(mi->avg_ampdu_len * 10) % 10);\n\t}\n\n\treturn p;\n}\n\nstatic int\nminstrel_ht_stats_csv_open(struct inode *inode, struct file *file)\n{\n\tstruct minstrel_ht_sta *mi = inode->i_private;\n\tstruct minstrel_debugfs_info *ms;\n\tunsigned int i;\n\tchar *p;\n\n\tms = kmalloc(32768, GFP_KERNEL);\n\tif (!ms)\n\t\treturn -ENOMEM;\n\n\tfile->private_data = ms;\n\n\tp = ms->buf;\n\n\tp = minstrel_ht_stats_csv_dump(mi, MINSTREL_CCK_GROUP, p);\n\tfor (i = 0; i < MINSTREL_CCK_GROUP; i++)\n\t\tp = minstrel_ht_stats_csv_dump(mi, i, p);\n\tfor (i++; i < ARRAY_SIZE(mi->groups); i++)\n\t\tp = minstrel_ht_stats_csv_dump(mi, i, p);\n\n\tms->len = p - ms->buf;\n\tWARN_ON(ms->len + sizeof(*ms) > 32768);\n\n\treturn nonseekable_open(inode, file);\n}\n\nstatic const struct file_operations minstrel_ht_stat_csv_fops = {\n\t.owner = THIS_MODULE,\n\t.open = minstrel_ht_stats_csv_open,\n\t.read = minstrel_stats_read,\n\t.release = minstrel_stats_release,\n\t.llseek = no_llseek,\n};\n\nvoid\nminstrel_ht_add_sta_debugfs(void *priv, void *priv_sta, struct dentry *dir)\n{\n\tdebugfs_create_file(\"rc_stats\", 0444, dir, priv_sta,\n\t\t\t    &minstrel_ht_stat_fops);\n\tdebugfs_create_file(\"rc_stats_csv\", 0444, dir, priv_sta,\n\t\t\t    &minstrel_ht_stat_csv_fops);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}