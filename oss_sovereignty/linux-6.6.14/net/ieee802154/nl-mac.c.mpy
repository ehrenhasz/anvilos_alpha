{
  "module_name": "nl-mac.c",
  "hash_id": "39e99c56529510793c7cf3104ca53199bab82e1e52fcca79fe5fe207fd096d88",
  "original_prompt": "Ingested from linux-6.6.14/net/ieee802154/nl-mac.c",
  "human_readable_source": "\n \n\n#include <linux/gfp.h>\n#include <linux/kernel.h>\n#include <linux/if_arp.h>\n#include <linux/netdevice.h>\n#include <linux/ieee802154.h>\n#include <net/netlink.h>\n#include <net/genetlink.h>\n#include <net/sock.h>\n#include <linux/nl802154.h>\n#include <linux/export.h>\n#include <net/af_ieee802154.h>\n#include <net/ieee802154_netdev.h>\n#include <net/cfg802154.h>\n\n#include \"ieee802154.h\"\n\nstatic int nla_put_hwaddr(struct sk_buff *msg, int type, __le64 hwaddr,\n\t\t\t  int padattr)\n{\n\treturn nla_put_u64_64bit(msg, type, swab64((__force u64)hwaddr),\n\t\t\t\t padattr);\n}\n\nstatic __le64 nla_get_hwaddr(const struct nlattr *nla)\n{\n\treturn ieee802154_devaddr_from_raw(nla_data(nla));\n}\n\nstatic int nla_put_shortaddr(struct sk_buff *msg, int type, __le16 addr)\n{\n\treturn nla_put_u16(msg, type, le16_to_cpu(addr));\n}\n\nstatic __le16 nla_get_shortaddr(const struct nlattr *nla)\n{\n\treturn cpu_to_le16(nla_get_u16(nla));\n}\n\nstatic int ieee802154_nl_start_confirm(struct net_device *dev, u8 status)\n{\n\tstruct sk_buff *msg;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tmsg = ieee802154_nl_create(0, IEEE802154_START_CONF);\n\tif (!msg)\n\t\treturn -ENOBUFS;\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    nla_put(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\n\t\t    dev->dev_addr) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_STATUS, status))\n\t\tgoto nla_put_failure;\n\treturn ieee802154_nl_mcast(msg, IEEE802154_COORD_MCGRP);\n\nnla_put_failure:\n\tnlmsg_free(msg);\n\treturn -ENOBUFS;\n}\n\nstatic int ieee802154_nl_fill_iface(struct sk_buff *msg, u32 portid,\n\t\t\t\t    u32 seq, int flags, struct net_device *dev)\n{\n\tvoid *hdr;\n\tstruct wpan_phy *phy;\n\tstruct ieee802154_mlme_ops *ops;\n\t__le16 short_addr, pan_id;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\thdr = genlmsg_put(msg, 0, seq, &nl802154_family, flags,\n\t\t\t  IEEE802154_LIST_IFACE);\n\tif (!hdr)\n\t\tgoto out;\n\n\tops = ieee802154_mlme_ops(dev);\n\tphy = dev->ieee802154_ptr->wpan_phy;\n\tBUG_ON(!phy);\n\tget_device(&phy->dev);\n\n\trtnl_lock();\n\tshort_addr = dev->ieee802154_ptr->short_addr;\n\tpan_id = dev->ieee802154_ptr->pan_id;\n\trtnl_unlock();\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    nla_put(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\n\t\t    dev->dev_addr) ||\n\t    nla_put_shortaddr(msg, IEEE802154_ATTR_SHORT_ADDR, short_addr) ||\n\t    nla_put_shortaddr(msg, IEEE802154_ATTR_PAN_ID, pan_id))\n\t\tgoto nla_put_failure;\n\n\tif (ops->get_mac_params) {\n\t\tstruct ieee802154_mac_params params;\n\n\t\trtnl_lock();\n\t\tops->get_mac_params(dev, &params);\n\t\trtnl_unlock();\n\n\t\tif (nla_put_s8(msg, IEEE802154_ATTR_TXPOWER,\n\t\t\t       params.transmit_power / 100) ||\n\t\t    nla_put_u8(msg, IEEE802154_ATTR_LBT_ENABLED, params.lbt) ||\n\t\t    nla_put_u8(msg, IEEE802154_ATTR_CCA_MODE,\n\t\t\t       params.cca.mode) ||\n\t\t    nla_put_s32(msg, IEEE802154_ATTR_CCA_ED_LEVEL,\n\t\t\t\tparams.cca_ed_level / 100) ||\n\t\t    nla_put_u8(msg, IEEE802154_ATTR_CSMA_RETRIES,\n\t\t\t       params.csma_retries) ||\n\t\t    nla_put_u8(msg, IEEE802154_ATTR_CSMA_MIN_BE,\n\t\t\t       params.min_be) ||\n\t\t    nla_put_u8(msg, IEEE802154_ATTR_CSMA_MAX_BE,\n\t\t\t       params.max_be) ||\n\t\t    nla_put_s8(msg, IEEE802154_ATTR_FRAME_RETRIES,\n\t\t\t       params.frame_retries))\n\t\t\tgoto nla_put_failure;\n\t}\n\n\twpan_phy_put(phy);\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nnla_put_failure:\n\twpan_phy_put(phy);\n\tgenlmsg_cancel(msg, hdr);\nout:\n\treturn -EMSGSIZE;\n}\n\n \nstatic struct net_device *ieee802154_nl_get_dev(struct genl_info *info)\n{\n\tstruct net_device *dev;\n\n\tif (info->attrs[IEEE802154_ATTR_DEV_NAME]) {\n\t\tchar name[IFNAMSIZ + 1];\n\n\t\tnla_strscpy(name, info->attrs[IEEE802154_ATTR_DEV_NAME],\n\t\t\t    sizeof(name));\n\t\tdev = dev_get_by_name(&init_net, name);\n\t} else if (info->attrs[IEEE802154_ATTR_DEV_INDEX]) {\n\t\tdev = dev_get_by_index(&init_net,\n\t\t\tnla_get_u32(info->attrs[IEEE802154_ATTR_DEV_INDEX]));\n\t} else {\n\t\treturn NULL;\n\t}\n\n\tif (!dev)\n\t\treturn NULL;\n\n\tif (dev->type != ARPHRD_IEEE802154) {\n\t\tdev_put(dev);\n\t\treturn NULL;\n\t}\n\n\treturn dev;\n}\n\nint ieee802154_associate_req(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev;\n\tstruct ieee802154_addr addr;\n\tu8 page;\n\tint ret = -EOPNOTSUPP;\n\n\tif (!info->attrs[IEEE802154_ATTR_CHANNEL] ||\n\t    !info->attrs[IEEE802154_ATTR_COORD_PAN_ID] ||\n\t    (!info->attrs[IEEE802154_ATTR_COORD_HW_ADDR] &&\n\t\t!info->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]) ||\n\t    !info->attrs[IEEE802154_ATTR_CAPABILITY])\n\t\treturn -EINVAL;\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\tif (!ieee802154_mlme_ops(dev)->assoc_req)\n\t\tgoto out;\n\n\tif (info->attrs[IEEE802154_ATTR_COORD_HW_ADDR]) {\n\t\taddr.mode = IEEE802154_ADDR_LONG;\n\t\taddr.extended_addr = nla_get_hwaddr(\n\t\t\t\tinfo->attrs[IEEE802154_ATTR_COORD_HW_ADDR]);\n\t} else {\n\t\taddr.mode = IEEE802154_ADDR_SHORT;\n\t\taddr.short_addr = nla_get_shortaddr(\n\t\t\t\tinfo->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]);\n\t}\n\taddr.pan_id = nla_get_shortaddr(\n\t\t\tinfo->attrs[IEEE802154_ATTR_COORD_PAN_ID]);\n\n\tif (info->attrs[IEEE802154_ATTR_PAGE])\n\t\tpage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\n\telse\n\t\tpage = 0;\n\n\tret = ieee802154_mlme_ops(dev)->assoc_req(dev, &addr,\n\t\t\tnla_get_u8(info->attrs[IEEE802154_ATTR_CHANNEL]),\n\t\t\tpage,\n\t\t\tnla_get_u8(info->attrs[IEEE802154_ATTR_CAPABILITY]));\n\nout:\n\tdev_put(dev);\n\treturn ret;\n}\n\nint ieee802154_associate_resp(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev;\n\tstruct ieee802154_addr addr;\n\tint ret = -EOPNOTSUPP;\n\n\tif (!info->attrs[IEEE802154_ATTR_STATUS] ||\n\t    !info->attrs[IEEE802154_ATTR_DEST_HW_ADDR] ||\n\t    !info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR])\n\t\treturn -EINVAL;\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\tif (!ieee802154_mlme_ops(dev)->assoc_resp)\n\t\tgoto out;\n\n\taddr.mode = IEEE802154_ADDR_LONG;\n\taddr.extended_addr = nla_get_hwaddr(\n\t\t\tinfo->attrs[IEEE802154_ATTR_DEST_HW_ADDR]);\n\trtnl_lock();\n\taddr.pan_id = dev->ieee802154_ptr->pan_id;\n\trtnl_unlock();\n\n\tret = ieee802154_mlme_ops(dev)->assoc_resp(dev, &addr,\n\t\tnla_get_shortaddr(info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]),\n\t\tnla_get_u8(info->attrs[IEEE802154_ATTR_STATUS]));\n\nout:\n\tdev_put(dev);\n\treturn ret;\n}\n\nint ieee802154_disassociate_req(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev;\n\tstruct ieee802154_addr addr;\n\tint ret = -EOPNOTSUPP;\n\n\tif ((!info->attrs[IEEE802154_ATTR_DEST_HW_ADDR] &&\n\t    !info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]) ||\n\t    !info->attrs[IEEE802154_ATTR_REASON])\n\t\treturn -EINVAL;\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\tif (!ieee802154_mlme_ops(dev)->disassoc_req)\n\t\tgoto out;\n\n\tif (info->attrs[IEEE802154_ATTR_DEST_HW_ADDR]) {\n\t\taddr.mode = IEEE802154_ADDR_LONG;\n\t\taddr.extended_addr = nla_get_hwaddr(\n\t\t\t\tinfo->attrs[IEEE802154_ATTR_DEST_HW_ADDR]);\n\t} else {\n\t\taddr.mode = IEEE802154_ADDR_SHORT;\n\t\taddr.short_addr = nla_get_shortaddr(\n\t\t\t\tinfo->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]);\n\t}\n\trtnl_lock();\n\taddr.pan_id = dev->ieee802154_ptr->pan_id;\n\trtnl_unlock();\n\n\tret = ieee802154_mlme_ops(dev)->disassoc_req(dev, &addr,\n\t\t\tnla_get_u8(info->attrs[IEEE802154_ATTR_REASON]));\n\nout:\n\tdev_put(dev);\n\treturn ret;\n}\n\n \nint ieee802154_start_req(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev;\n\tstruct ieee802154_addr addr;\n\n\tu8 channel, bcn_ord, sf_ord;\n\tu8 page;\n\tint pan_coord, blx, coord_realign;\n\tint ret = -EBUSY;\n\n\tif (!info->attrs[IEEE802154_ATTR_COORD_PAN_ID] ||\n\t    !info->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR] ||\n\t    !info->attrs[IEEE802154_ATTR_CHANNEL] ||\n\t    !info->attrs[IEEE802154_ATTR_BCN_ORD] ||\n\t    !info->attrs[IEEE802154_ATTR_SF_ORD] ||\n\t    !info->attrs[IEEE802154_ATTR_PAN_COORD] ||\n\t    !info->attrs[IEEE802154_ATTR_BAT_EXT] ||\n\t    !info->attrs[IEEE802154_ATTR_COORD_REALIGN]\n\t )\n\t\treturn -EINVAL;\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\tif (netif_running(dev))\n\t\tgoto out;\n\n\tif (!ieee802154_mlme_ops(dev)->start_req) {\n\t\tret = -EOPNOTSUPP;\n\t\tgoto out;\n\t}\n\n\taddr.mode = IEEE802154_ADDR_SHORT;\n\taddr.short_addr = nla_get_shortaddr(\n\t\t\tinfo->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]);\n\taddr.pan_id = nla_get_shortaddr(\n\t\t\tinfo->attrs[IEEE802154_ATTR_COORD_PAN_ID]);\n\n\tchannel = nla_get_u8(info->attrs[IEEE802154_ATTR_CHANNEL]);\n\tbcn_ord = nla_get_u8(info->attrs[IEEE802154_ATTR_BCN_ORD]);\n\tsf_ord = nla_get_u8(info->attrs[IEEE802154_ATTR_SF_ORD]);\n\tpan_coord = nla_get_u8(info->attrs[IEEE802154_ATTR_PAN_COORD]);\n\tblx = nla_get_u8(info->attrs[IEEE802154_ATTR_BAT_EXT]);\n\tcoord_realign = nla_get_u8(info->attrs[IEEE802154_ATTR_COORD_REALIGN]);\n\n\tif (info->attrs[IEEE802154_ATTR_PAGE])\n\t\tpage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\n\telse\n\t\tpage = 0;\n\n\tif (addr.short_addr == cpu_to_le16(IEEE802154_ADDR_BROADCAST)) {\n\t\tieee802154_nl_start_confirm(dev, IEEE802154_NO_SHORT_ADDRESS);\n\t\tdev_put(dev);\n\t\treturn -EINVAL;\n\t}\n\n\trtnl_lock();\n\tret = ieee802154_mlme_ops(dev)->start_req(dev, &addr, channel, page,\n\t\tbcn_ord, sf_ord, pan_coord, blx, coord_realign);\n\trtnl_unlock();\n\n\t \n\tieee802154_nl_start_confirm(dev, IEEE802154_SUCCESS);\n\nout:\n\tdev_put(dev);\n\treturn ret;\n}\n\nint ieee802154_scan_req(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev;\n\tint ret = -EOPNOTSUPP;\n\tu8 type;\n\tu32 channels;\n\tu8 duration;\n\tu8 page;\n\n\tif (!info->attrs[IEEE802154_ATTR_SCAN_TYPE] ||\n\t    !info->attrs[IEEE802154_ATTR_CHANNELS] ||\n\t    !info->attrs[IEEE802154_ATTR_DURATION])\n\t\treturn -EINVAL;\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\tif (!ieee802154_mlme_ops(dev)->scan_req)\n\t\tgoto out;\n\n\ttype = nla_get_u8(info->attrs[IEEE802154_ATTR_SCAN_TYPE]);\n\tchannels = nla_get_u32(info->attrs[IEEE802154_ATTR_CHANNELS]);\n\tduration = nla_get_u8(info->attrs[IEEE802154_ATTR_DURATION]);\n\n\tif (info->attrs[IEEE802154_ATTR_PAGE])\n\t\tpage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\n\telse\n\t\tpage = 0;\n\n\tret = ieee802154_mlme_ops(dev)->scan_req(dev, type, channels,\n\t\t\t\t\t\t page, duration);\n\nout:\n\tdev_put(dev);\n\treturn ret;\n}\n\nint ieee802154_list_iface(struct sk_buff *skb, struct genl_info *info)\n{\n\t \n\tstruct sk_buff *msg;\n\tstruct net_device *dev = NULL;\n\tint rc = -ENOBUFS;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\tmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!msg)\n\t\tgoto out_dev;\n\n\trc = ieee802154_nl_fill_iface(msg, info->snd_portid, info->snd_seq,\n\t\t\t\t      0, dev);\n\tif (rc < 0)\n\t\tgoto out_free;\n\n\tdev_put(dev);\n\n\treturn genlmsg_reply(msg, info);\nout_free:\n\tnlmsg_free(msg);\nout_dev:\n\tdev_put(dev);\n\treturn rc;\n}\n\nint ieee802154_dump_iface(struct sk_buff *skb, struct netlink_callback *cb)\n{\n\tstruct net *net = sock_net(skb->sk);\n\tstruct net_device *dev;\n\tint idx;\n\tint s_idx = cb->args[0];\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tidx = 0;\n\tfor_each_netdev(net, dev) {\n\t\tif (idx < s_idx || dev->type != ARPHRD_IEEE802154)\n\t\t\tgoto cont;\n\n\t\tif (ieee802154_nl_fill_iface(skb, NETLINK_CB(cb->skb).portid,\n\t\t\t\t\t     cb->nlh->nlmsg_seq,\n\t\t\t\t\t     NLM_F_MULTI, dev) < 0)\n\t\t\tbreak;\ncont:\n\t\tidx++;\n\t}\n\tcb->args[0] = idx;\n\n\treturn skb->len;\n}\n\nint ieee802154_set_macparams(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev = NULL;\n\tstruct ieee802154_mlme_ops *ops;\n\tstruct ieee802154_mac_params params;\n\tstruct wpan_phy *phy;\n\tint rc = -EINVAL;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\tops = ieee802154_mlme_ops(dev);\n\n\tif (!ops->get_mac_params || !ops->set_mac_params) {\n\t\trc = -EOPNOTSUPP;\n\t\tgoto out;\n\t}\n\n\tif (netif_running(dev)) {\n\t\trc = -EBUSY;\n\t\tgoto out;\n\t}\n\n\tif (!info->attrs[IEEE802154_ATTR_LBT_ENABLED] &&\n\t    !info->attrs[IEEE802154_ATTR_CCA_MODE] &&\n\t    !info->attrs[IEEE802154_ATTR_CCA_ED_LEVEL] &&\n\t    !info->attrs[IEEE802154_ATTR_CSMA_RETRIES] &&\n\t    !info->attrs[IEEE802154_ATTR_CSMA_MIN_BE] &&\n\t    !info->attrs[IEEE802154_ATTR_CSMA_MAX_BE] &&\n\t    !info->attrs[IEEE802154_ATTR_FRAME_RETRIES])\n\t\tgoto out;\n\n\tphy = dev->ieee802154_ptr->wpan_phy;\n\tget_device(&phy->dev);\n\n\trtnl_lock();\n\tops->get_mac_params(dev, &params);\n\n\tif (info->attrs[IEEE802154_ATTR_TXPOWER])\n\t\tparams.transmit_power = nla_get_s8(info->attrs[IEEE802154_ATTR_TXPOWER]) * 100;\n\n\tif (info->attrs[IEEE802154_ATTR_LBT_ENABLED])\n\t\tparams.lbt = nla_get_u8(info->attrs[IEEE802154_ATTR_LBT_ENABLED]);\n\n\tif (info->attrs[IEEE802154_ATTR_CCA_MODE])\n\t\tparams.cca.mode = nla_get_u8(info->attrs[IEEE802154_ATTR_CCA_MODE]);\n\n\tif (info->attrs[IEEE802154_ATTR_CCA_ED_LEVEL])\n\t\tparams.cca_ed_level = nla_get_s32(info->attrs[IEEE802154_ATTR_CCA_ED_LEVEL]) * 100;\n\n\tif (info->attrs[IEEE802154_ATTR_CSMA_RETRIES])\n\t\tparams.csma_retries = nla_get_u8(info->attrs[IEEE802154_ATTR_CSMA_RETRIES]);\n\n\tif (info->attrs[IEEE802154_ATTR_CSMA_MIN_BE])\n\t\tparams.min_be = nla_get_u8(info->attrs[IEEE802154_ATTR_CSMA_MIN_BE]);\n\n\tif (info->attrs[IEEE802154_ATTR_CSMA_MAX_BE])\n\t\tparams.max_be = nla_get_u8(info->attrs[IEEE802154_ATTR_CSMA_MAX_BE]);\n\n\tif (info->attrs[IEEE802154_ATTR_FRAME_RETRIES])\n\t\tparams.frame_retries = nla_get_s8(info->attrs[IEEE802154_ATTR_FRAME_RETRIES]);\n\n\trc = ops->set_mac_params(dev, &params);\n\trtnl_unlock();\n\n\twpan_phy_put(phy);\n\tdev_put(dev);\n\n\treturn 0;\n\nout:\n\tdev_put(dev);\n\treturn rc;\n}\n\nstatic int\nieee802154_llsec_parse_key_id(struct genl_info *info,\n\t\t\t      struct ieee802154_llsec_key_id *desc)\n{\n\tmemset(desc, 0, sizeof(*desc));\n\n\tif (!info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE])\n\t\treturn -EINVAL;\n\n\tdesc->mode = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE]);\n\n\tif (desc->mode == IEEE802154_SCF_KEY_IMPLICIT) {\n\t\tif (!info->attrs[IEEE802154_ATTR_PAN_ID])\n\t\t\treturn -EINVAL;\n\n\t\tdesc->device_addr.pan_id = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_PAN_ID]);\n\n\t\tif (info->attrs[IEEE802154_ATTR_SHORT_ADDR]) {\n\t\t\tdesc->device_addr.mode = IEEE802154_ADDR_SHORT;\n\t\t\tdesc->device_addr.short_addr = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_SHORT_ADDR]);\n\t\t} else {\n\t\t\tif (!info->attrs[IEEE802154_ATTR_HW_ADDR])\n\t\t\t\treturn -EINVAL;\n\n\t\t\tdesc->device_addr.mode = IEEE802154_ADDR_LONG;\n\t\t\tdesc->device_addr.extended_addr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\n\t\t}\n\t}\n\n\tif (desc->mode != IEEE802154_SCF_KEY_IMPLICIT &&\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_KEY_ID])\n\t\treturn -EINVAL;\n\n\tif (desc->mode == IEEE802154_SCF_KEY_SHORT_INDEX &&\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_SHORT])\n\t\treturn -EINVAL;\n\n\tif (desc->mode == IEEE802154_SCF_KEY_HW_INDEX &&\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_EXTENDED])\n\t\treturn -EINVAL;\n\n\tif (desc->mode != IEEE802154_SCF_KEY_IMPLICIT)\n\t\tdesc->id = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_KEY_ID]);\n\n\tswitch (desc->mode) {\n\tcase IEEE802154_SCF_KEY_SHORT_INDEX:\n\t{\n\t\tu32 source = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_SHORT]);\n\n\t\tdesc->short_source = cpu_to_le32(source);\n\t\tbreak;\n\t}\n\tcase IEEE802154_SCF_KEY_HW_INDEX:\n\t\tdesc->extended_source = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_EXTENDED]);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nieee802154_llsec_fill_key_id(struct sk_buff *msg,\n\t\t\t     const struct ieee802154_llsec_key_id *desc)\n{\n\tif (nla_put_u8(msg, IEEE802154_ATTR_LLSEC_KEY_MODE, desc->mode))\n\t\treturn -EMSGSIZE;\n\n\tif (desc->mode == IEEE802154_SCF_KEY_IMPLICIT) {\n\t\tif (nla_put_shortaddr(msg, IEEE802154_ATTR_PAN_ID,\n\t\t\t\t      desc->device_addr.pan_id))\n\t\t\treturn -EMSGSIZE;\n\n\t\tif (desc->device_addr.mode == IEEE802154_ADDR_SHORT &&\n\t\t    nla_put_shortaddr(msg, IEEE802154_ATTR_SHORT_ADDR,\n\t\t\t\t      desc->device_addr.short_addr))\n\t\t\treturn -EMSGSIZE;\n\n\t\tif (desc->device_addr.mode == IEEE802154_ADDR_LONG &&\n\t\t    nla_put_hwaddr(msg, IEEE802154_ATTR_HW_ADDR,\n\t\t\t\t   desc->device_addr.extended_addr,\n\t\t\t\t   IEEE802154_ATTR_PAD))\n\t\t\treturn -EMSGSIZE;\n\t}\n\n\tif (desc->mode != IEEE802154_SCF_KEY_IMPLICIT &&\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_KEY_ID, desc->id))\n\t\treturn -EMSGSIZE;\n\n\tif (desc->mode == IEEE802154_SCF_KEY_SHORT_INDEX &&\n\t    nla_put_u32(msg, IEEE802154_ATTR_LLSEC_KEY_SOURCE_SHORT,\n\t\t\tle32_to_cpu(desc->short_source)))\n\t\treturn -EMSGSIZE;\n\n\tif (desc->mode == IEEE802154_SCF_KEY_HW_INDEX &&\n\t    nla_put_hwaddr(msg, IEEE802154_ATTR_LLSEC_KEY_SOURCE_EXTENDED,\n\t\t\t   desc->extended_source, IEEE802154_ATTR_PAD))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nint ieee802154_llsec_getparams(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct sk_buff *msg;\n\tstruct net_device *dev = NULL;\n\tint rc = -ENOBUFS;\n\tstruct ieee802154_mlme_ops *ops;\n\tvoid *hdr;\n\tstruct ieee802154_llsec_params params;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\tops = ieee802154_mlme_ops(dev);\n\tif (!ops->llsec) {\n\t\trc = -EOPNOTSUPP;\n\t\tgoto out_dev;\n\t}\n\n\tmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!msg)\n\t\tgoto out_dev;\n\n\thdr = genlmsg_put(msg, 0, info->snd_seq, &nl802154_family, 0,\n\t\t\t  IEEE802154_LLSEC_GETPARAMS);\n\tif (!hdr)\n\t\tgoto out_free;\n\n\trc = ops->llsec->get_params(dev, &params);\n\tif (rc < 0)\n\t\tgoto out_free;\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_ENABLED, params.enabled) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_SECLEVEL, params.out_level) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_LLSEC_FRAME_COUNTER,\n\t\t\tbe32_to_cpu(params.frame_counter)) ||\n\t    ieee802154_llsec_fill_key_id(msg, &params.out_key)) {\n\t\trc = -ENOBUFS;\n\t\tgoto out_free;\n\t}\n\n\tdev_put(dev);\n\n\treturn ieee802154_nl_reply(msg, info);\nout_free:\n\tnlmsg_free(msg);\nout_dev:\n\tdev_put(dev);\n\treturn rc;\n}\n\nint ieee802154_llsec_setparams(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *dev = NULL;\n\tint rc = -EINVAL;\n\tstruct ieee802154_mlme_ops *ops;\n\tstruct ieee802154_llsec_params params;\n\tint changed = 0;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\tif (!info->attrs[IEEE802154_ATTR_LLSEC_ENABLED] &&\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE] &&\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL])\n\t\tgoto out;\n\n\tops = ieee802154_mlme_ops(dev);\n\tif (!ops->llsec) {\n\t\trc = -EOPNOTSUPP;\n\t\tgoto out;\n\t}\n\n\tif (info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL] &&\n\t    nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL]) > 7)\n\t\tgoto out;\n\n\tif (info->attrs[IEEE802154_ATTR_LLSEC_ENABLED]) {\n\t\tparams.enabled = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_ENABLED]);\n\t\tchanged |= IEEE802154_LLSEC_PARAM_ENABLED;\n\t}\n\n\tif (info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE]) {\n\t\tif (ieee802154_llsec_parse_key_id(info, &params.out_key))\n\t\t\tgoto out;\n\n\t\tchanged |= IEEE802154_LLSEC_PARAM_OUT_KEY;\n\t}\n\n\tif (info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL]) {\n\t\tparams.out_level = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL]);\n\t\tchanged |= IEEE802154_LLSEC_PARAM_OUT_LEVEL;\n\t}\n\n\tif (info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]) {\n\t\tu32 fc = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]);\n\n\t\tparams.frame_counter = cpu_to_be32(fc);\n\t\tchanged |= IEEE802154_LLSEC_PARAM_FRAME_COUNTER;\n\t}\n\n\trc = ops->llsec->set_params(dev, &params, changed);\n\n\tdev_put(dev);\n\n\treturn rc;\nout:\n\tdev_put(dev);\n\treturn rc;\n}\n\nstruct llsec_dump_data {\n\tstruct sk_buff *skb;\n\tint s_idx, s_idx2;\n\tint portid;\n\tint nlmsg_seq;\n\tstruct net_device *dev;\n\tstruct ieee802154_mlme_ops *ops;\n\tstruct ieee802154_llsec_table *table;\n};\n\nstatic int\nieee802154_llsec_dump_table(struct sk_buff *skb, struct netlink_callback *cb,\n\t\t\t    int (*step)(struct llsec_dump_data *))\n{\n\tstruct net *net = sock_net(skb->sk);\n\tstruct net_device *dev;\n\tstruct llsec_dump_data data;\n\tint idx = 0;\n\tint first_dev = cb->args[0];\n\tint rc;\n\n\tfor_each_netdev(net, dev) {\n\t\tif (idx < first_dev || dev->type != ARPHRD_IEEE802154)\n\t\t\tgoto skip;\n\n\t\tdata.ops = ieee802154_mlme_ops(dev);\n\t\tif (!data.ops->llsec)\n\t\t\tgoto skip;\n\n\t\tdata.skb = skb;\n\t\tdata.s_idx = cb->args[1];\n\t\tdata.s_idx2 = cb->args[2];\n\t\tdata.dev = dev;\n\t\tdata.portid = NETLINK_CB(cb->skb).portid;\n\t\tdata.nlmsg_seq = cb->nlh->nlmsg_seq;\n\n\t\tdata.ops->llsec->lock_table(dev);\n\t\tdata.ops->llsec->get_table(data.dev, &data.table);\n\t\trc = step(&data);\n\t\tdata.ops->llsec->unlock_table(dev);\n\n\t\tif (rc < 0)\n\t\t\tbreak;\n\nskip:\n\t\tidx++;\n\t}\n\tcb->args[0] = idx;\n\n\treturn skb->len;\n}\n\nstatic int\nieee802154_nl_llsec_change(struct sk_buff *skb, struct genl_info *info,\n\t\t\t   int (*fn)(struct net_device*, struct genl_info*))\n{\n\tstruct net_device *dev = NULL;\n\tint rc = -EINVAL;\n\n\tdev = ieee802154_nl_get_dev(info);\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\tif (!ieee802154_mlme_ops(dev)->llsec)\n\t\trc = -EOPNOTSUPP;\n\telse\n\t\trc = fn(dev, info);\n\n\tdev_put(dev);\n\treturn rc;\n}\n\nstatic int\nieee802154_llsec_parse_key(struct genl_info *info,\n\t\t\t   struct ieee802154_llsec_key *key)\n{\n\tu8 frames;\n\tu32 commands[256 / 32];\n\n\tmemset(key, 0, sizeof(*key));\n\n\tif (!info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_FRAME_TYPES] ||\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_KEY_BYTES])\n\t\treturn -EINVAL;\n\n\tframes = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_FRAME_TYPES]);\n\tif ((frames & BIT(IEEE802154_FC_TYPE_MAC_CMD)) &&\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS])\n\t\treturn -EINVAL;\n\n\tif (info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS]) {\n\t\tnla_memcpy(commands,\n\t\t\t   info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS],\n\t\t\t   256 / 8);\n\n\t\tif (commands[0] || commands[1] || commands[2] || commands[3] ||\n\t\t    commands[4] || commands[5] || commands[6] ||\n\t\t    commands[7] >= BIT(IEEE802154_CMD_GTS_REQ + 1))\n\t\t\treturn -EINVAL;\n\n\t\tkey->cmd_frame_ids = commands[7];\n\t}\n\n\tkey->frame_types = frames;\n\n\tnla_memcpy(key->key, info->attrs[IEEE802154_ATTR_LLSEC_KEY_BYTES],\n\t\t   IEEE802154_LLSEC_KEY_SIZE);\n\n\treturn 0;\n}\n\nstatic int llsec_add_key(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_key key;\n\tstruct ieee802154_llsec_key_id id;\n\n\tif (ieee802154_llsec_parse_key(info, &key) ||\n\t    ieee802154_llsec_parse_key_id(info, &id))\n\t\treturn -EINVAL;\n\n\treturn ops->llsec->add_key(dev, &id, &key);\n}\n\nint ieee802154_llsec_add_key(struct sk_buff *skb, struct genl_info *info)\n{\n\tif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\n\t    (NLM_F_CREATE | NLM_F_EXCL))\n\t\treturn -EINVAL;\n\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_add_key);\n}\n\nstatic int llsec_remove_key(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_key_id id;\n\n\tif (ieee802154_llsec_parse_key_id(info, &id))\n\t\treturn -EINVAL;\n\n\treturn ops->llsec->del_key(dev, &id);\n}\n\nint ieee802154_llsec_del_key(struct sk_buff *skb, struct genl_info *info)\n{\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_remove_key);\n}\n\nstatic int\nieee802154_nl_fill_key(struct sk_buff *msg, u32 portid, u32 seq,\n\t\t       const struct ieee802154_llsec_key_entry *key,\n\t\t       const struct net_device *dev)\n{\n\tvoid *hdr;\n\tu32 commands[256 / 32];\n\n\thdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\n\t\t\t  IEEE802154_LLSEC_LIST_KEY);\n\tif (!hdr)\n\t\tgoto out;\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    ieee802154_llsec_fill_key_id(msg, &key->id) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_KEY_USAGE_FRAME_TYPES,\n\t\t       key->key->frame_types))\n\t\tgoto nla_put_failure;\n\n\tif (key->key->frame_types & BIT(IEEE802154_FC_TYPE_MAC_CMD)) {\n\t\tmemset(commands, 0, sizeof(commands));\n\t\tcommands[7] = key->key->cmd_frame_ids;\n\t\tif (nla_put(msg, IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS,\n\t\t\t    sizeof(commands), commands))\n\t\t\tgoto nla_put_failure;\n\t}\n\n\tif (nla_put(msg, IEEE802154_ATTR_LLSEC_KEY_BYTES,\n\t\t    IEEE802154_LLSEC_KEY_SIZE, key->key->key))\n\t\tgoto nla_put_failure;\n\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nnla_put_failure:\n\tgenlmsg_cancel(msg, hdr);\nout:\n\treturn -EMSGSIZE;\n}\n\nstatic int llsec_iter_keys(struct llsec_dump_data *data)\n{\n\tstruct ieee802154_llsec_key_entry *pos;\n\tint rc = 0, idx = 0;\n\n\tlist_for_each_entry(pos, &data->table->keys, list) {\n\t\tif (idx++ < data->s_idx)\n\t\t\tcontinue;\n\n\t\tif (ieee802154_nl_fill_key(data->skb, data->portid,\n\t\t\t\t\t   data->nlmsg_seq, pos, data->dev)) {\n\t\t\trc = -EMSGSIZE;\n\t\t\tbreak;\n\t\t}\n\n\t\tdata->s_idx++;\n\t}\n\n\treturn rc;\n}\n\nint ieee802154_llsec_dump_keys(struct sk_buff *skb, struct netlink_callback *cb)\n{\n\treturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_keys);\n}\n\nstatic int\nllsec_parse_dev(struct genl_info *info,\n\t\tstruct ieee802154_llsec_device *dev)\n{\n\tmemset(dev, 0, sizeof(*dev));\n\n\tif (!info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER] ||\n\t    !info->attrs[IEEE802154_ATTR_HW_ADDR] ||\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE] ||\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_DEV_KEY_MODE] ||\n\t    (!!info->attrs[IEEE802154_ATTR_PAN_ID] !=\n\t     !!info->attrs[IEEE802154_ATTR_SHORT_ADDR]))\n\t\treturn -EINVAL;\n\n\tif (info->attrs[IEEE802154_ATTR_PAN_ID]) {\n\t\tdev->pan_id = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_PAN_ID]);\n\t\tdev->short_addr = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_SHORT_ADDR]);\n\t} else {\n\t\tdev->short_addr = cpu_to_le16(IEEE802154_ADDR_UNDEF);\n\t}\n\n\tdev->hwaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\n\tdev->frame_counter = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]);\n\tdev->seclevel_exempt = !!nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE]);\n\tdev->key_mode = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_DEV_KEY_MODE]);\n\n\tif (dev->key_mode >= __IEEE802154_LLSEC_DEVKEY_MAX)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int llsec_add_dev(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_device desc;\n\n\tif (llsec_parse_dev(info, &desc))\n\t\treturn -EINVAL;\n\n\treturn ops->llsec->add_dev(dev, &desc);\n}\n\nint ieee802154_llsec_add_dev(struct sk_buff *skb, struct genl_info *info)\n{\n\tif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\n\t    (NLM_F_CREATE | NLM_F_EXCL))\n\t\treturn -EINVAL;\n\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_add_dev);\n}\n\nstatic int llsec_del_dev(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\t__le64 devaddr;\n\n\tif (!info->attrs[IEEE802154_ATTR_HW_ADDR])\n\t\treturn -EINVAL;\n\n\tdevaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\n\n\treturn ops->llsec->del_dev(dev, devaddr);\n}\n\nint ieee802154_llsec_del_dev(struct sk_buff *skb, struct genl_info *info)\n{\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_del_dev);\n}\n\nstatic int\nieee802154_nl_fill_dev(struct sk_buff *msg, u32 portid, u32 seq,\n\t\t       const struct ieee802154_llsec_device *desc,\n\t\t       const struct net_device *dev)\n{\n\tvoid *hdr;\n\n\thdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\n\t\t\t  IEEE802154_LLSEC_LIST_DEV);\n\tif (!hdr)\n\t\tgoto out;\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    nla_put_shortaddr(msg, IEEE802154_ATTR_PAN_ID, desc->pan_id) ||\n\t    nla_put_shortaddr(msg, IEEE802154_ATTR_SHORT_ADDR,\n\t\t\t      desc->short_addr) ||\n\t    nla_put_hwaddr(msg, IEEE802154_ATTR_HW_ADDR, desc->hwaddr,\n\t\t\t   IEEE802154_ATTR_PAD) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_LLSEC_FRAME_COUNTER,\n\t\t\tdesc->frame_counter) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_DEV_OVERRIDE,\n\t\t       desc->seclevel_exempt) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_DEV_KEY_MODE, desc->key_mode))\n\t\tgoto nla_put_failure;\n\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nnla_put_failure:\n\tgenlmsg_cancel(msg, hdr);\nout:\n\treturn -EMSGSIZE;\n}\n\nstatic int llsec_iter_devs(struct llsec_dump_data *data)\n{\n\tstruct ieee802154_llsec_device *pos;\n\tint rc = 0, idx = 0;\n\n\tlist_for_each_entry(pos, &data->table->devices, list) {\n\t\tif (idx++ < data->s_idx)\n\t\t\tcontinue;\n\n\t\tif (ieee802154_nl_fill_dev(data->skb, data->portid,\n\t\t\t\t\t   data->nlmsg_seq, pos, data->dev)) {\n\t\t\trc = -EMSGSIZE;\n\t\t\tbreak;\n\t\t}\n\n\t\tdata->s_idx++;\n\t}\n\n\treturn rc;\n}\n\nint ieee802154_llsec_dump_devs(struct sk_buff *skb, struct netlink_callback *cb)\n{\n\treturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_devs);\n}\n\nstatic int llsec_add_devkey(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_device_key key;\n\t__le64 devaddr;\n\n\tif (!info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER] ||\n\t    !info->attrs[IEEE802154_ATTR_HW_ADDR] ||\n\t    ieee802154_llsec_parse_key_id(info, &key.key_id))\n\t\treturn -EINVAL;\n\n\tdevaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\n\tkey.frame_counter = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]);\n\n\treturn ops->llsec->add_devkey(dev, devaddr, &key);\n}\n\nint ieee802154_llsec_add_devkey(struct sk_buff *skb, struct genl_info *info)\n{\n\tif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\n\t    (NLM_F_CREATE | NLM_F_EXCL))\n\t\treturn -EINVAL;\n\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_add_devkey);\n}\n\nstatic int llsec_del_devkey(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_device_key key;\n\t__le64 devaddr;\n\n\tif (!info->attrs[IEEE802154_ATTR_HW_ADDR] ||\n\t    ieee802154_llsec_parse_key_id(info, &key.key_id))\n\t\treturn -EINVAL;\n\n\tdevaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\n\n\treturn ops->llsec->del_devkey(dev, devaddr, &key);\n}\n\nint ieee802154_llsec_del_devkey(struct sk_buff *skb, struct genl_info *info)\n{\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_del_devkey);\n}\n\nstatic int\nieee802154_nl_fill_devkey(struct sk_buff *msg, u32 portid, u32 seq,\n\t\t\t  __le64 devaddr,\n\t\t\t  const struct ieee802154_llsec_device_key *devkey,\n\t\t\t  const struct net_device *dev)\n{\n\tvoid *hdr;\n\n\thdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\n\t\t\t  IEEE802154_LLSEC_LIST_DEVKEY);\n\tif (!hdr)\n\t\tgoto out;\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    nla_put_hwaddr(msg, IEEE802154_ATTR_HW_ADDR, devaddr,\n\t\t\t   IEEE802154_ATTR_PAD) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_LLSEC_FRAME_COUNTER,\n\t\t\tdevkey->frame_counter) ||\n\t    ieee802154_llsec_fill_key_id(msg, &devkey->key_id))\n\t\tgoto nla_put_failure;\n\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nnla_put_failure:\n\tgenlmsg_cancel(msg, hdr);\nout:\n\treturn -EMSGSIZE;\n}\n\nstatic int llsec_iter_devkeys(struct llsec_dump_data *data)\n{\n\tstruct ieee802154_llsec_device *dpos;\n\tstruct ieee802154_llsec_device_key *kpos;\n\tint idx = 0, idx2;\n\n\tlist_for_each_entry(dpos, &data->table->devices, list) {\n\t\tif (idx++ < data->s_idx)\n\t\t\tcontinue;\n\n\t\tidx2 = 0;\n\n\t\tlist_for_each_entry(kpos, &dpos->keys, list) {\n\t\t\tif (idx2++ < data->s_idx2)\n\t\t\t\tcontinue;\n\n\t\t\tif (ieee802154_nl_fill_devkey(data->skb, data->portid,\n\t\t\t\t\t\t      data->nlmsg_seq,\n\t\t\t\t\t\t      dpos->hwaddr, kpos,\n\t\t\t\t\t\t      data->dev)) {\n\t\t\t\treturn -EMSGSIZE;\n\t\t\t}\n\n\t\t\tdata->s_idx2++;\n\t\t}\n\n\t\tdata->s_idx++;\n\t}\n\n\treturn 0;\n}\n\nint ieee802154_llsec_dump_devkeys(struct sk_buff *skb,\n\t\t\t\t  struct netlink_callback *cb)\n{\n\treturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_devkeys);\n}\n\nstatic int\nllsec_parse_seclevel(struct genl_info *info,\n\t\t     struct ieee802154_llsec_seclevel *sl)\n{\n\tmemset(sl, 0, sizeof(*sl));\n\n\tif (!info->attrs[IEEE802154_ATTR_LLSEC_FRAME_TYPE] ||\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_SECLEVELS] ||\n\t    !info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE])\n\t\treturn -EINVAL;\n\n\tsl->frame_type = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_TYPE]);\n\tif (sl->frame_type == IEEE802154_FC_TYPE_MAC_CMD) {\n\t\tif (!info->attrs[IEEE802154_ATTR_LLSEC_CMD_FRAME_ID])\n\t\t\treturn -EINVAL;\n\n\t\tsl->cmd_frame_id = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_CMD_FRAME_ID]);\n\t}\n\n\tsl->sec_levels = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_SECLEVELS]);\n\tsl->device_override = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE]);\n\n\treturn 0;\n}\n\nstatic int llsec_add_seclevel(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_seclevel sl;\n\n\tif (llsec_parse_seclevel(info, &sl))\n\t\treturn -EINVAL;\n\n\treturn ops->llsec->add_seclevel(dev, &sl);\n}\n\nint ieee802154_llsec_add_seclevel(struct sk_buff *skb, struct genl_info *info)\n{\n\tif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\n\t    (NLM_F_CREATE | NLM_F_EXCL))\n\t\treturn -EINVAL;\n\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_add_seclevel);\n}\n\nstatic int llsec_del_seclevel(struct net_device *dev, struct genl_info *info)\n{\n\tstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\n\tstruct ieee802154_llsec_seclevel sl;\n\n\tif (llsec_parse_seclevel(info, &sl))\n\t\treturn -EINVAL;\n\n\treturn ops->llsec->del_seclevel(dev, &sl);\n}\n\nint ieee802154_llsec_del_seclevel(struct sk_buff *skb, struct genl_info *info)\n{\n\treturn ieee802154_nl_llsec_change(skb, info, llsec_del_seclevel);\n}\n\nstatic int\nieee802154_nl_fill_seclevel(struct sk_buff *msg, u32 portid, u32 seq,\n\t\t\t    const struct ieee802154_llsec_seclevel *sl,\n\t\t\t    const struct net_device *dev)\n{\n\tvoid *hdr;\n\n\thdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\n\t\t\t  IEEE802154_LLSEC_LIST_SECLEVEL);\n\tif (!hdr)\n\t\tgoto out;\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\n\t    nla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_FRAME_TYPE, sl->frame_type) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_SECLEVELS, sl->sec_levels) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_DEV_OVERRIDE,\n\t\t       sl->device_override))\n\t\tgoto nla_put_failure;\n\n\tif (sl->frame_type == IEEE802154_FC_TYPE_MAC_CMD &&\n\t    nla_put_u8(msg, IEEE802154_ATTR_LLSEC_CMD_FRAME_ID,\n\t\t       sl->cmd_frame_id))\n\t\tgoto nla_put_failure;\n\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nnla_put_failure:\n\tgenlmsg_cancel(msg, hdr);\nout:\n\treturn -EMSGSIZE;\n}\n\nstatic int llsec_iter_seclevels(struct llsec_dump_data *data)\n{\n\tstruct ieee802154_llsec_seclevel *pos;\n\tint rc = 0, idx = 0;\n\n\tlist_for_each_entry(pos, &data->table->security_levels, list) {\n\t\tif (idx++ < data->s_idx)\n\t\t\tcontinue;\n\n\t\tif (ieee802154_nl_fill_seclevel(data->skb, data->portid,\n\t\t\t\t\t\tdata->nlmsg_seq, pos,\n\t\t\t\t\t\tdata->dev)) {\n\t\t\trc = -EMSGSIZE;\n\t\t\tbreak;\n\t\t}\n\n\t\tdata->s_idx++;\n\t}\n\n\treturn rc;\n}\n\nint ieee802154_llsec_dump_seclevels(struct sk_buff *skb,\n\t\t\t\t    struct netlink_callback *cb)\n{\n\treturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_seclevels);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}