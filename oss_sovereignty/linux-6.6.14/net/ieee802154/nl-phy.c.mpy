{
  "module_name": "nl-phy.c",
  "hash_id": "4097cac531625732accd506d8403c078db81aefedb4b959e131965c612c8926b",
  "original_prompt": "Ingested from linux-6.6.14/net/ieee802154/nl-phy.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/if_arp.h>\n#include <net/netlink.h>\n#include <net/genetlink.h>\n#include <net/cfg802154.h>\n#include <net/af_ieee802154.h>\n#include <net/ieee802154_netdev.h>\n#include <net/rtnetlink.h>  \n#include <linux/nl802154.h>\n\n#include \"ieee802154.h\"\n#include \"rdev-ops.h\"\n#include \"core.h\"\n\nstatic int ieee802154_nl_fill_phy(struct sk_buff *msg, u32 portid,\n\t\t\t\t  u32 seq, int flags, struct wpan_phy *phy)\n{\n\tvoid *hdr;\n\tint i, pages = 0;\n\tu32 *buf = kcalloc(IEEE802154_MAX_PAGE + 1, sizeof(u32), GFP_KERNEL);\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (!buf)\n\t\treturn -EMSGSIZE;\n\n\thdr = genlmsg_put(msg, 0, seq, &nl802154_family, flags,\n\t\t\t  IEEE802154_LIST_PHY);\n\tif (!hdr)\n\t\tgoto out;\n\n\trtnl_lock();\n\tif (nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_PAGE, phy->current_page) ||\n\t    nla_put_u8(msg, IEEE802154_ATTR_CHANNEL, phy->current_channel))\n\t\tgoto nla_put_failure;\n\tfor (i = 0; i <= IEEE802154_MAX_PAGE; i++) {\n\t\tif (phy->supported.channels[i])\n\t\t\tbuf[pages++] = phy->supported.channels[i] | (i << 27);\n\t}\n\tif (pages &&\n\t    nla_put(msg, IEEE802154_ATTR_CHANNEL_PAGE_LIST,\n\t\t    pages * sizeof(uint32_t), buf))\n\t\tgoto nla_put_failure;\n\trtnl_unlock();\n\tkfree(buf);\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nnla_put_failure:\n\trtnl_unlock();\n\tgenlmsg_cancel(msg, hdr);\nout:\n\tkfree(buf);\n\treturn -EMSGSIZE;\n}\n\nint ieee802154_list_phy(struct sk_buff *skb, struct genl_info *info)\n{\n\t \n\tstruct sk_buff *msg;\n\tstruct wpan_phy *phy;\n\tconst char *name;\n\tint rc = -ENOBUFS;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (!info->attrs[IEEE802154_ATTR_PHY_NAME])\n\t\treturn -EINVAL;\n\n\tname = nla_data(info->attrs[IEEE802154_ATTR_PHY_NAME]);\n\tif (name[nla_len(info->attrs[IEEE802154_ATTR_PHY_NAME]) - 1] != '\\0')\n\t\treturn -EINVAL;  \n\n\tphy = wpan_phy_find(name);\n\tif (!phy)\n\t\treturn -ENODEV;\n\n\tmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!msg)\n\t\tgoto out_dev;\n\n\trc = ieee802154_nl_fill_phy(msg, info->snd_portid, info->snd_seq,\n\t\t\t\t    0, phy);\n\tif (rc < 0)\n\t\tgoto out_free;\n\n\twpan_phy_put(phy);\n\n\treturn genlmsg_reply(msg, info);\nout_free:\n\tnlmsg_free(msg);\nout_dev:\n\twpan_phy_put(phy);\n\treturn rc;\n}\n\nstruct dump_phy_data {\n\tstruct sk_buff *skb;\n\tstruct netlink_callback *cb;\n\tint idx, s_idx;\n};\n\nstatic int ieee802154_dump_phy_iter(struct wpan_phy *phy, void *_data)\n{\n\tint rc;\n\tstruct dump_phy_data *data = _data;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (data->idx++ < data->s_idx)\n\t\treturn 0;\n\n\trc = ieee802154_nl_fill_phy(data->skb,\n\t\t\t\t    NETLINK_CB(data->cb->skb).portid,\n\t\t\t\t    data->cb->nlh->nlmsg_seq,\n\t\t\t\t    NLM_F_MULTI,\n\t\t\t\t    phy);\n\n\tif (rc < 0) {\n\t\tdata->idx--;\n\t\treturn rc;\n\t}\n\n\treturn 0;\n}\n\nint ieee802154_dump_phy(struct sk_buff *skb, struct netlink_callback *cb)\n{\n\tstruct dump_phy_data data = {\n\t\t.cb = cb,\n\t\t.skb = skb,\n\t\t.s_idx = cb->args[0],\n\t\t.idx = 0,\n\t};\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\twpan_phy_for_each(ieee802154_dump_phy_iter, &data);\n\n\tcb->args[0] = data.idx;\n\n\treturn skb->len;\n}\n\nint ieee802154_add_iface(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct sk_buff *msg;\n\tstruct wpan_phy *phy;\n\tconst char *name;\n\tconst char *devname;\n\tint rc = -ENOBUFS;\n\tstruct net_device *dev;\n\tint type = __IEEE802154_DEV_INVALID;\n\tunsigned char name_assign_type;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (!info->attrs[IEEE802154_ATTR_PHY_NAME])\n\t\treturn -EINVAL;\n\n\tname = nla_data(info->attrs[IEEE802154_ATTR_PHY_NAME]);\n\tif (name[nla_len(info->attrs[IEEE802154_ATTR_PHY_NAME]) - 1] != '\\0')\n\t\treturn -EINVAL;  \n\n\tif (info->attrs[IEEE802154_ATTR_DEV_NAME]) {\n\t\tdevname = nla_data(info->attrs[IEEE802154_ATTR_DEV_NAME]);\n\t\tif (devname[nla_len(info->attrs[IEEE802154_ATTR_DEV_NAME]) - 1]\n\t\t\t\t!= '\\0')\n\t\t\treturn -EINVAL;  \n\t\tname_assign_type = NET_NAME_USER;\n\t} else  {\n\t\tdevname = \"wpan%d\";\n\t\tname_assign_type = NET_NAME_ENUM;\n\t}\n\n\tif (strlen(devname) >= IFNAMSIZ)\n\t\treturn -ENAMETOOLONG;\n\n\tphy = wpan_phy_find(name);\n\tif (!phy)\n\t\treturn -ENODEV;\n\n\tmsg = ieee802154_nl_new_reply(info, 0, IEEE802154_ADD_IFACE);\n\tif (!msg)\n\t\tgoto out_dev;\n\n\tif (info->attrs[IEEE802154_ATTR_HW_ADDR] &&\n\t    nla_len(info->attrs[IEEE802154_ATTR_HW_ADDR]) !=\n\t\t\tIEEE802154_ADDR_LEN) {\n\t\trc = -EINVAL;\n\t\tgoto nla_put_failure;\n\t}\n\n\tif (info->attrs[IEEE802154_ATTR_DEV_TYPE]) {\n\t\ttype = nla_get_u8(info->attrs[IEEE802154_ATTR_DEV_TYPE]);\n\t\tif (type >= __IEEE802154_DEV_MAX) {\n\t\t\trc = -EINVAL;\n\t\t\tgoto nla_put_failure;\n\t\t}\n\t}\n\n\tdev = rdev_add_virtual_intf_deprecated(wpan_phy_to_rdev(phy), devname,\n\t\t\t\t\t       name_assign_type, type);\n\tif (IS_ERR(dev)) {\n\t\trc = PTR_ERR(dev);\n\t\tgoto nla_put_failure;\n\t}\n\tdev_hold(dev);\n\n\tif (info->attrs[IEEE802154_ATTR_HW_ADDR]) {\n\t\tstruct sockaddr addr;\n\n\t\taddr.sa_family = ARPHRD_IEEE802154;\n\t\tnla_memcpy(&addr.sa_data, info->attrs[IEEE802154_ATTR_HW_ADDR],\n\t\t\t   IEEE802154_ADDR_LEN);\n\n\t\t \n\t\trtnl_lock();\n\t\trc = dev_set_mac_address(dev, &addr, NULL);\n\t\trtnl_unlock();\n\t\tif (rc)\n\t\t\tgoto dev_unregister;\n\t}\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\n\t    nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name)) {\n\t\trc = -EMSGSIZE;\n\t\tgoto nla_put_failure;\n\t}\n\tdev_put(dev);\n\n\twpan_phy_put(phy);\n\n\treturn ieee802154_nl_reply(msg, info);\n\ndev_unregister:\n\trtnl_lock();  \n\trdev_del_virtual_intf_deprecated(wpan_phy_to_rdev(phy), dev);\n\tdev_put(dev);\n\trtnl_unlock();\nnla_put_failure:\n\tnlmsg_free(msg);\nout_dev:\n\twpan_phy_put(phy);\n\treturn rc;\n}\n\nint ieee802154_del_iface(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct sk_buff *msg;\n\tstruct wpan_phy *phy;\n\tconst char *name;\n\tint rc;\n\tstruct net_device *dev;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (!info->attrs[IEEE802154_ATTR_DEV_NAME])\n\t\treturn -EINVAL;\n\n\tname = nla_data(info->attrs[IEEE802154_ATTR_DEV_NAME]);\n\tif (name[nla_len(info->attrs[IEEE802154_ATTR_DEV_NAME]) - 1] != '\\0')\n\t\treturn -EINVAL;  \n\n\trc = -ENODEV;\n\tdev = dev_get_by_name(genl_info_net(info), name);\n\tif (!dev)\n\t\treturn rc;\n\tif (dev->type != ARPHRD_IEEE802154)\n\t\tgoto out;\n\n\tphy = dev->ieee802154_ptr->wpan_phy;\n\tBUG_ON(!phy);\n\tget_device(&phy->dev);\n\n\trc = -EINVAL;\n\t \n\tif (info->attrs[IEEE802154_ATTR_PHY_NAME]) {\n\t\tstruct wpan_phy *phy2;\n\n\t\tconst char *pname =\n\t\t\tnla_data(info->attrs[IEEE802154_ATTR_PHY_NAME]);\n\t\tif (pname[nla_len(info->attrs[IEEE802154_ATTR_PHY_NAME]) - 1]\n\t\t\t\t!= '\\0')\n\t\t\t \n\t\t\tgoto out_dev;\n\n\t\tphy2 = wpan_phy_find(pname);\n\t\tif (!phy2)\n\t\t\tgoto out_dev;\n\n\t\tif (phy != phy2) {\n\t\t\twpan_phy_put(phy2);\n\t\t\tgoto out_dev;\n\t\t}\n\t}\n\n\trc = -ENOBUFS;\n\n\tmsg = ieee802154_nl_new_reply(info, 0, IEEE802154_DEL_IFACE);\n\tif (!msg)\n\t\tgoto out_dev;\n\n\trtnl_lock();\n\trdev_del_virtual_intf_deprecated(wpan_phy_to_rdev(phy), dev);\n\n\t \n\tdev_put(dev);\n\tdev = NULL;\n\n\trtnl_unlock();\n\n\tif (nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\n\t    nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, name))\n\t\tgoto nla_put_failure;\n\twpan_phy_put(phy);\n\n\treturn ieee802154_nl_reply(msg, info);\n\nnla_put_failure:\n\tnlmsg_free(msg);\nout_dev:\n\twpan_phy_put(phy);\nout:\n\tdev_put(dev);\n\n\treturn rc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}