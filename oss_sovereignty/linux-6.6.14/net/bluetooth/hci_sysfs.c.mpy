{
  "module_name": "hci_sysfs.c",
  "hash_id": "64dbe94d620f49bfcd3f31a787d516e39178e03be13208120fd005cceb032da5",
  "original_prompt": "Ingested from linux-6.6.14/net/bluetooth/hci_sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n\n#include <net/bluetooth/bluetooth.h>\n#include <net/bluetooth/hci_core.h>\n\nstatic const struct class bt_class = {\n\t.name = \"bluetooth\",\n};\n\nstatic void bt_link_release(struct device *dev)\n{\n\tstruct hci_conn *conn = to_hci_conn(dev);\n\tkfree(conn);\n}\n\nstatic const struct device_type bt_link = {\n\t.name    = \"link\",\n\t.release = bt_link_release,\n};\n\n \nstatic int __match_tty(struct device *dev, void *data)\n{\n\treturn !strncmp(dev_name(dev), \"rfcomm\", 6);\n}\n\nvoid hci_conn_init_sysfs(struct hci_conn *conn)\n{\n\tstruct hci_dev *hdev = conn->hdev;\n\n\tbt_dev_dbg(hdev, \"conn %p\", conn);\n\n\tconn->dev.type = &bt_link;\n\tconn->dev.class = &bt_class;\n\tconn->dev.parent = &hdev->dev;\n\n\tdevice_initialize(&conn->dev);\n}\n\nvoid hci_conn_add_sysfs(struct hci_conn *conn)\n{\n\tstruct hci_dev *hdev = conn->hdev;\n\n\tbt_dev_dbg(hdev, \"conn %p\", conn);\n\n\tif (device_is_registered(&conn->dev))\n\t\treturn;\n\n\tdev_set_name(&conn->dev, \"%s:%d\", hdev->name, conn->handle);\n\n\tif (device_add(&conn->dev) < 0)\n\t\tbt_dev_err(hdev, \"failed to register connection device\");\n}\n\nvoid hci_conn_del_sysfs(struct hci_conn *conn)\n{\n\tstruct hci_dev *hdev = conn->hdev;\n\n\tbt_dev_dbg(hdev, \"conn %p\", conn);\n\n\tif (!device_is_registered(&conn->dev)) {\n\t\t \n\t\tput_device(&conn->dev);\n\t\treturn;\n\t}\n\n\twhile (1) {\n\t\tstruct device *dev;\n\n\t\tdev = device_find_child(&conn->dev, NULL, __match_tty);\n\t\tif (!dev)\n\t\t\tbreak;\n\t\tdevice_move(dev, NULL, DPM_ORDER_DEV_LAST);\n\t\tput_device(dev);\n\t}\n\n\tdevice_unregister(&conn->dev);\n}\n\nstatic void bt_host_release(struct device *dev)\n{\n\tstruct hci_dev *hdev = to_hci_dev(dev);\n\n\tif (hci_dev_test_flag(hdev, HCI_UNREGISTER))\n\t\thci_release_dev(hdev);\n\telse\n\t\tkfree(hdev);\n\tmodule_put(THIS_MODULE);\n}\n\nstatic const struct device_type bt_host = {\n\t.name    = \"host\",\n\t.release = bt_host_release,\n};\n\nvoid hci_init_sysfs(struct hci_dev *hdev)\n{\n\tstruct device *dev = &hdev->dev;\n\n\tdev->type = &bt_host;\n\tdev->class = &bt_class;\n\n\t__module_get(THIS_MODULE);\n\tdevice_initialize(dev);\n}\n\nint __init bt_sysfs_init(void)\n{\n\treturn class_register(&bt_class);\n}\n\nvoid bt_sysfs_cleanup(void)\n{\n\tclass_unregister(&bt_class);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}