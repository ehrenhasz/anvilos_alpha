{
  "module_name": "mgmt_config.c",
  "hash_id": "d9ad86b926a2968ddc2dcf1b68544402cfd5a2e23df3c0e002acfae755844dd1",
  "original_prompt": "Ingested from linux-6.6.14/net/bluetooth/mgmt_config.c",
  "human_readable_source": "\n\n \n\n#include <net/bluetooth/bluetooth.h>\n#include <net/bluetooth/hci_core.h>\n#include <net/bluetooth/mgmt.h>\n\n#include \"mgmt_util.h\"\n#include \"mgmt_config.h\"\n\n#define HDEV_PARAM_U16(_param_name_) \\\n\tstruct {\\\n\t\tstruct mgmt_tlv entry; \\\n\t\t__le16 value; \\\n\t} __packed _param_name_\n\n#define HDEV_PARAM_U8(_param_name_) \\\n\tstruct {\\\n\t\tstruct mgmt_tlv entry; \\\n\t\t__u8 value; \\\n\t} __packed _param_name_\n\n#define TLV_SET_U16(_param_code_, _param_name_) \\\n\t{ \\\n\t\t{ cpu_to_le16(_param_code_), sizeof(__u16) }, \\\n\t\tcpu_to_le16(hdev->_param_name_) \\\n\t}\n\n#define TLV_SET_U8(_param_code_, _param_name_) \\\n\t{ \\\n\t\t{ cpu_to_le16(_param_code_), sizeof(__u8) }, \\\n\t\thdev->_param_name_ \\\n\t}\n\n#define TLV_SET_U16_JIFFIES_TO_MSECS(_param_code_, _param_name_) \\\n\t{ \\\n\t\t{ cpu_to_le16(_param_code_), sizeof(__u16) }, \\\n\t\tcpu_to_le16(jiffies_to_msecs(hdev->_param_name_)) \\\n\t}\n\nint read_def_system_config(struct sock *sk, struct hci_dev *hdev, void *data,\n\t\t\t   u16 data_len)\n{\n\tint ret;\n\tstruct mgmt_rp_read_def_system_config {\n\t\t \n\t\tHDEV_PARAM_U16(def_page_scan_type);\n\t\tHDEV_PARAM_U16(def_page_scan_int);\n\t\tHDEV_PARAM_U16(def_page_scan_window);\n\t\tHDEV_PARAM_U16(def_inq_scan_type);\n\t\tHDEV_PARAM_U16(def_inq_scan_int);\n\t\tHDEV_PARAM_U16(def_inq_scan_window);\n\t\tHDEV_PARAM_U16(def_br_lsto);\n\t\tHDEV_PARAM_U16(def_page_timeout);\n\t\tHDEV_PARAM_U16(sniff_min_interval);\n\t\tHDEV_PARAM_U16(sniff_max_interval);\n\t\tHDEV_PARAM_U16(le_adv_min_interval);\n\t\tHDEV_PARAM_U16(le_adv_max_interval);\n\t\tHDEV_PARAM_U16(def_multi_adv_rotation_duration);\n\t\tHDEV_PARAM_U16(le_scan_interval);\n\t\tHDEV_PARAM_U16(le_scan_window);\n\t\tHDEV_PARAM_U16(le_scan_int_suspend);\n\t\tHDEV_PARAM_U16(le_scan_window_suspend);\n\t\tHDEV_PARAM_U16(le_scan_int_discovery);\n\t\tHDEV_PARAM_U16(le_scan_window_discovery);\n\t\tHDEV_PARAM_U16(le_scan_int_adv_monitor);\n\t\tHDEV_PARAM_U16(le_scan_window_adv_monitor);\n\t\tHDEV_PARAM_U16(le_scan_int_connect);\n\t\tHDEV_PARAM_U16(le_scan_window_connect);\n\t\tHDEV_PARAM_U16(le_conn_min_interval);\n\t\tHDEV_PARAM_U16(le_conn_max_interval);\n\t\tHDEV_PARAM_U16(le_conn_latency);\n\t\tHDEV_PARAM_U16(le_supv_timeout);\n\t\tHDEV_PARAM_U16(def_le_autoconnect_timeout);\n\t\tHDEV_PARAM_U16(advmon_allowlist_duration);\n\t\tHDEV_PARAM_U16(advmon_no_filter_duration);\n\t\tHDEV_PARAM_U8(enable_advmon_interleave_scan);\n\t} __packed rp = {\n\t\tTLV_SET_U16(0x0000, def_page_scan_type),\n\t\tTLV_SET_U16(0x0001, def_page_scan_int),\n\t\tTLV_SET_U16(0x0002, def_page_scan_window),\n\t\tTLV_SET_U16(0x0003, def_inq_scan_type),\n\t\tTLV_SET_U16(0x0004, def_inq_scan_int),\n\t\tTLV_SET_U16(0x0005, def_inq_scan_window),\n\t\tTLV_SET_U16(0x0006, def_br_lsto),\n\t\tTLV_SET_U16(0x0007, def_page_timeout),\n\t\tTLV_SET_U16(0x0008, sniff_min_interval),\n\t\tTLV_SET_U16(0x0009, sniff_max_interval),\n\t\tTLV_SET_U16(0x000a, le_adv_min_interval),\n\t\tTLV_SET_U16(0x000b, le_adv_max_interval),\n\t\tTLV_SET_U16(0x000c, def_multi_adv_rotation_duration),\n\t\tTLV_SET_U16(0x000d, le_scan_interval),\n\t\tTLV_SET_U16(0x000e, le_scan_window),\n\t\tTLV_SET_U16(0x000f, le_scan_int_suspend),\n\t\tTLV_SET_U16(0x0010, le_scan_window_suspend),\n\t\tTLV_SET_U16(0x0011, le_scan_int_discovery),\n\t\tTLV_SET_U16(0x0012, le_scan_window_discovery),\n\t\tTLV_SET_U16(0x0013, le_scan_int_adv_monitor),\n\t\tTLV_SET_U16(0x0014, le_scan_window_adv_monitor),\n\t\tTLV_SET_U16(0x0015, le_scan_int_connect),\n\t\tTLV_SET_U16(0x0016, le_scan_window_connect),\n\t\tTLV_SET_U16(0x0017, le_conn_min_interval),\n\t\tTLV_SET_U16(0x0018, le_conn_max_interval),\n\t\tTLV_SET_U16(0x0019, le_conn_latency),\n\t\tTLV_SET_U16(0x001a, le_supv_timeout),\n\t\tTLV_SET_U16_JIFFIES_TO_MSECS(0x001b,\n\t\t\t\t\t     def_le_autoconnect_timeout),\n\t\tTLV_SET_U16(0x001d, advmon_allowlist_duration),\n\t\tTLV_SET_U16(0x001e, advmon_no_filter_duration),\n\t\tTLV_SET_U8(0x001f, enable_advmon_interleave_scan),\n\t};\n\n\tbt_dev_dbg(hdev, \"sock %p\", sk);\n\n\tret = mgmt_cmd_complete(sk, hdev->id,\n\t\t\t\tMGMT_OP_READ_DEF_SYSTEM_CONFIG,\n\t\t\t\t0, &rp, sizeof(rp));\n\treturn ret;\n}\n\n#define TO_TLV(x)\t\t((struct mgmt_tlv *)(x))\n#define TLV_GET_LE16(tlv)\tle16_to_cpu(*((__le16 *)(TO_TLV(tlv)->value)))\n#define TLV_GET_U8(tlv)\t\t(*((__u8 *)(TO_TLV(tlv)->value)))\n\nint set_def_system_config(struct sock *sk, struct hci_dev *hdev, void *data,\n\t\t\t  u16 data_len)\n{\n\tu16 buffer_left = data_len;\n\tu8 *buffer = data;\n\n\tif (buffer_left < sizeof(struct mgmt_tlv)) {\n\t\treturn mgmt_cmd_status(sk, hdev->id,\n\t\t\t\t       MGMT_OP_SET_DEF_SYSTEM_CONFIG,\n\t\t\t\t       MGMT_STATUS_INVALID_PARAMS);\n\t}\n\n\t \n\twhile (buffer_left >= sizeof(struct mgmt_tlv)) {\n\t\tconst u8 len = TO_TLV(buffer)->length;\n\t\tsize_t exp_type_len;\n\t\tconst u16 exp_len = sizeof(struct mgmt_tlv) +\n\t\t\t\t    len;\n\t\tconst u16 type = le16_to_cpu(TO_TLV(buffer)->type);\n\n\t\tif (buffer_left < exp_len) {\n\t\t\tbt_dev_warn(hdev, \"invalid len left %u, exp >= %u\",\n\t\t\t\t    buffer_left, exp_len);\n\n\t\t\treturn mgmt_cmd_status(sk, hdev->id,\n\t\t\t\t\tMGMT_OP_SET_DEF_SYSTEM_CONFIG,\n\t\t\t\t\tMGMT_STATUS_INVALID_PARAMS);\n\t\t}\n\n\t\t \n\t\tswitch (type) {\n\t\tcase 0x0000:\n\t\tcase 0x0001:\n\t\tcase 0x0002:\n\t\tcase 0x0003:\n\t\tcase 0x0004:\n\t\tcase 0x0005:\n\t\tcase 0x0006:\n\t\tcase 0x0007:\n\t\tcase 0x0008:\n\t\tcase 0x0009:\n\t\tcase 0x000a:\n\t\tcase 0x000b:\n\t\tcase 0x000c:\n\t\tcase 0x000d:\n\t\tcase 0x000e:\n\t\tcase 0x000f:\n\t\tcase 0x0010:\n\t\tcase 0x0011:\n\t\tcase 0x0012:\n\t\tcase 0x0013:\n\t\tcase 0x0014:\n\t\tcase 0x0015:\n\t\tcase 0x0016:\n\t\tcase 0x0017:\n\t\tcase 0x0018:\n\t\tcase 0x0019:\n\t\tcase 0x001a:\n\t\tcase 0x001b:\n\t\tcase 0x001d:\n\t\tcase 0x001e:\n\t\t\texp_type_len = sizeof(u16);\n\t\t\tbreak;\n\t\tcase 0x001f:\n\t\t\texp_type_len = sizeof(u8);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\texp_type_len = 0;\n\t\t\tbt_dev_warn(hdev, \"unsupported parameter %u\", type);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (exp_type_len && len != exp_type_len) {\n\t\t\tbt_dev_warn(hdev, \"invalid length %d, exp %zu for type %u\",\n\t\t\t\t    len, exp_type_len, type);\n\n\t\t\treturn mgmt_cmd_status(sk, hdev->id,\n\t\t\t\tMGMT_OP_SET_DEF_SYSTEM_CONFIG,\n\t\t\t\tMGMT_STATUS_INVALID_PARAMS);\n\t\t}\n\n\t\tbuffer_left -= exp_len;\n\t\tbuffer += exp_len;\n\t}\n\n\tbuffer_left = data_len;\n\tbuffer = data;\n\twhile (buffer_left >= sizeof(struct mgmt_tlv)) {\n\t\tconst u8 len = TO_TLV(buffer)->length;\n\t\tconst u16 exp_len = sizeof(struct mgmt_tlv) +\n\t\t\t\t    len;\n\t\tconst u16 type = le16_to_cpu(TO_TLV(buffer)->type);\n\n\t\tswitch (type) {\n\t\tcase 0x0000:\n\t\t\thdev->def_page_scan_type = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0001:\n\t\t\thdev->def_page_scan_int = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0002:\n\t\t\thdev->def_page_scan_window = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0003:\n\t\t\thdev->def_inq_scan_type = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0004:\n\t\t\thdev->def_inq_scan_int = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0005:\n\t\t\thdev->def_inq_scan_window = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0006:\n\t\t\thdev->def_br_lsto = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0007:\n\t\t\thdev->def_page_timeout = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0008:\n\t\t\thdev->sniff_min_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0009:\n\t\t\thdev->sniff_max_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x000a:\n\t\t\thdev->le_adv_min_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x000b:\n\t\t\thdev->le_adv_max_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x000c:\n\t\t\thdev->def_multi_adv_rotation_duration =\n\t\t\t\t\t\t\t   TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x000d:\n\t\t\thdev->le_scan_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x000e:\n\t\t\thdev->le_scan_window = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x000f:\n\t\t\thdev->le_scan_int_suspend = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0010:\n\t\t\thdev->le_scan_window_suspend = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0011:\n\t\t\thdev->le_scan_int_discovery = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00012:\n\t\t\thdev->le_scan_window_discovery = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00013:\n\t\t\thdev->le_scan_int_adv_monitor = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00014:\n\t\t\thdev->le_scan_window_adv_monitor = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00015:\n\t\t\thdev->le_scan_int_connect = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00016:\n\t\t\thdev->le_scan_window_connect = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00017:\n\t\t\thdev->le_conn_min_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00018:\n\t\t\thdev->le_conn_max_interval = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x00019:\n\t\t\thdev->le_conn_latency = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0001a:\n\t\t\thdev->le_supv_timeout = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0001b:\n\t\t\thdev->def_le_autoconnect_timeout =\n\t\t\t\t\tmsecs_to_jiffies(TLV_GET_LE16(buffer));\n\t\t\tbreak;\n\t\tcase 0x0001d:\n\t\t\thdev->advmon_allowlist_duration = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0001e:\n\t\t\thdev->advmon_no_filter_duration = TLV_GET_LE16(buffer);\n\t\t\tbreak;\n\t\tcase 0x0001f:\n\t\t\thdev->enable_advmon_interleave_scan = TLV_GET_U8(buffer);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbt_dev_warn(hdev, \"unsupported parameter %u\", type);\n\t\t\tbreak;\n\t\t}\n\n\t\tbuffer_left -= exp_len;\n\t\tbuffer += exp_len;\n\t}\n\n\treturn mgmt_cmd_complete(sk, hdev->id,\n\t\t\t\t MGMT_OP_SET_DEF_SYSTEM_CONFIG, 0, NULL, 0);\n}\n\nint read_def_runtime_config(struct sock *sk, struct hci_dev *hdev, void *data,\n\t\t\t    u16 data_len)\n{\n\tbt_dev_dbg(hdev, \"sock %p\", sk);\n\n\treturn mgmt_cmd_complete(sk, hdev->id,\n\t\t\t\t MGMT_OP_READ_DEF_RUNTIME_CONFIG, 0, NULL, 0);\n}\n\nint set_def_runtime_config(struct sock *sk, struct hci_dev *hdev, void *data,\n\t\t\t   u16 data_len)\n{\n\tbt_dev_dbg(hdev, \"sock %p\", sk);\n\n\treturn mgmt_cmd_status(sk, hdev->id, MGMT_OP_SET_DEF_SYSTEM_CONFIG,\n\t\t\t       MGMT_STATUS_INVALID_PARAMS);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}