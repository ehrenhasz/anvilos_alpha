{
  "module_name": "aosp.c",
  "hash_id": "894d1c05c257be63c600ac543f831deafd52be958c19d36e313f2e65bfc1a2c9",
  "original_prompt": "Ingested from linux-6.6.14/net/bluetooth/aosp.c",
  "human_readable_source": "\n \n\n#include <net/bluetooth/bluetooth.h>\n#include <net/bluetooth/hci_core.h>\n\n#include \"aosp.h\"\n\n \nstruct aosp_rp_le_get_vendor_capa {\n\t \n\t__u8\tstatus;\n\t__u8\tmax_advt_instances;\n\t__u8\toffloaded_resolution_of_private_address;\n\t__le16\ttotal_scan_results_storage;\n\t__u8\tmax_irk_list_sz;\n\t__u8\tfiltering_support;\n\t__u8\tmax_filter;\n\t__u8\tactivity_energy_info_support;\n\t__le16\tversion_supported;\n\t__le16\ttotal_num_of_advt_tracked;\n\t__u8\textended_scan_support;\n\t__u8\tdebug_logging_supported;\n\t \n\t__u8\tle_address_generation_offloading_support;\n\t \n\t__le32\ta2dp_source_offload_capability_mask;\n\t__u8\tbluetooth_quality_report_support;\n\t \n\t__le32\tdynamic_audio_buffer_support;\n} __packed;\n\n#define VENDOR_CAPA_BASE_SIZE\t\t15\n#define VENDOR_CAPA_0_98_SIZE\t\t21\n\nvoid aosp_do_open(struct hci_dev *hdev)\n{\n\tstruct sk_buff *skb;\n\tstruct aosp_rp_le_get_vendor_capa *rp;\n\tu16 version_supported;\n\n\tif (!hdev->aosp_capable)\n\t\treturn;\n\n\tbt_dev_dbg(hdev, \"Initialize AOSP extension\");\n\n\t \n\tskb = __hci_cmd_sync(hdev, hci_opcode_pack(0x3f, 0x153), 0, NULL,\n\t\t\t     HCI_CMD_TIMEOUT);\n\tif (IS_ERR_OR_NULL(skb)) {\n\t\tif (!skb)\n\t\t\tskb = ERR_PTR(-EIO);\n\n\t\tbt_dev_err(hdev, \"AOSP get vendor capabilities (%ld)\",\n\t\t\t   PTR_ERR(skb));\n\t\treturn;\n\t}\n\n\t \n\tif (skb->len < VENDOR_CAPA_BASE_SIZE)\n\t\tgoto length_error;\n\n\trp = (struct aosp_rp_le_get_vendor_capa *)skb->data;\n\n\tversion_supported = le16_to_cpu(rp->version_supported);\n\t \n\tbt_dev_info(hdev, \"AOSP extensions version v%u.%02u\",\n\t\t    version_supported >> 8, version_supported & 0xff);\n\n\t \n\tif (version_supported < 95) {\n\t\tbt_dev_warn(hdev, \"AOSP capabilities version %u too old\",\n\t\t\t    version_supported);\n\t\tgoto done;\n\t}\n\n\tif (version_supported < 98) {\n\t\tbt_dev_warn(hdev, \"AOSP quality report is not supported\");\n\t\tgoto done;\n\t}\n\n\tif (skb->len < VENDOR_CAPA_0_98_SIZE)\n\t\tgoto length_error;\n\n\t \n\tif (rp->bluetooth_quality_report_support) {\n\t\thdev->aosp_quality_report = true;\n\t\tbt_dev_info(hdev, \"AOSP quality report is supported\");\n\t}\n\n\tgoto done;\n\nlength_error:\n\tbt_dev_err(hdev, \"AOSP capabilities length %d too short\", skb->len);\n\ndone:\n\tkfree_skb(skb);\n}\n\nvoid aosp_do_close(struct hci_dev *hdev)\n{\n\tif (!hdev->aosp_capable)\n\t\treturn;\n\n\tbt_dev_dbg(hdev, \"Cleanup of AOSP extension\");\n}\n\n \n#define BQR_OPCODE\t\t\thci_opcode_pack(0x3f, 0x015e)\n\n \n#define REPORT_ACTION_ADD\t\t0x00\n#define REPORT_ACTION_DELETE\t\t0x01\n#define REPORT_ACTION_CLEAR\t\t0x02\n\n \n#define QUALITY_MONITORING\t\tBIT(0)\n#define APPRAOCHING_LSTO\t\tBIT(1)\n#define A2DP_AUDIO_CHOPPY\t\tBIT(2)\n#define SCO_VOICE_CHOPPY\t\tBIT(3)\n\n#define DEFAULT_BQR_EVENT_MASK\t(QUALITY_MONITORING | APPRAOCHING_LSTO | \\\n\t\t\t\t A2DP_AUDIO_CHOPPY | SCO_VOICE_CHOPPY)\n\n \n#define DEFALUT_REPORT_INTERVAL_MS\t5000\n\nstruct aosp_bqr_cp {\n\t__u8\treport_action;\n\t__u32\tevent_mask;\n\t__u16\tmin_report_interval;\n} __packed;\n\nstatic int enable_quality_report(struct hci_dev *hdev)\n{\n\tstruct sk_buff *skb;\n\tstruct aosp_bqr_cp cp;\n\n\tcp.report_action = REPORT_ACTION_ADD;\n\tcp.event_mask = DEFAULT_BQR_EVENT_MASK;\n\tcp.min_report_interval = DEFALUT_REPORT_INTERVAL_MS;\n\n\tskb = __hci_cmd_sync(hdev, BQR_OPCODE, sizeof(cp), &cp,\n\t\t\t     HCI_CMD_TIMEOUT);\n\tif (IS_ERR_OR_NULL(skb)) {\n\t\tif (!skb)\n\t\t\tskb = ERR_PTR(-EIO);\n\n\t\tbt_dev_err(hdev, \"Enabling Android BQR failed (%ld)\",\n\t\t\t   PTR_ERR(skb));\n\t\treturn PTR_ERR(skb);\n\t}\n\n\tkfree_skb(skb);\n\treturn 0;\n}\n\nstatic int disable_quality_report(struct hci_dev *hdev)\n{\n\tstruct sk_buff *skb;\n\tstruct aosp_bqr_cp cp = { 0 };\n\n\tcp.report_action = REPORT_ACTION_CLEAR;\n\n\tskb = __hci_cmd_sync(hdev, BQR_OPCODE, sizeof(cp), &cp,\n\t\t\t     HCI_CMD_TIMEOUT);\n\tif (IS_ERR_OR_NULL(skb)) {\n\t\tif (!skb)\n\t\t\tskb = ERR_PTR(-EIO);\n\n\t\tbt_dev_err(hdev, \"Disabling Android BQR failed (%ld)\",\n\t\t\t   PTR_ERR(skb));\n\t\treturn PTR_ERR(skb);\n\t}\n\n\tkfree_skb(skb);\n\treturn 0;\n}\n\nbool aosp_has_quality_report(struct hci_dev *hdev)\n{\n\treturn hdev->aosp_quality_report;\n}\n\nint aosp_set_quality_report(struct hci_dev *hdev, bool enable)\n{\n\tif (!aosp_has_quality_report(hdev))\n\t\treturn -EOPNOTSUPP;\n\n\tbt_dev_dbg(hdev, \"quality report enable %d\", enable);\n\n\t \n\tif (enable)\n\t\treturn enable_quality_report(hdev);\n\telse\n\t\treturn disable_quality_report(hdev);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}