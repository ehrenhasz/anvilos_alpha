{
  "module_name": "ip6_icmp.c",
  "hash_id": "904718af3b197e5bacc539e84a9a8dfdd165f134dc0ca46114bde7182435a424",
  "original_prompt": "Ingested from linux-6.6.14/net/ipv6/ip6_icmp.c",
  "human_readable_source": "\n#include <linux/export.h>\n#include <linux/icmpv6.h>\n#include <linux/mutex.h>\n#include <linux/netdevice.h>\n#include <linux/spinlock.h>\n\n#include <net/ipv6.h>\n\n#if IS_ENABLED(CONFIG_IPV6)\n\n#if !IS_BUILTIN(CONFIG_IPV6)\n\nstatic ip6_icmp_send_t __rcu *ip6_icmp_send;\n\nint inet6_register_icmp_sender(ip6_icmp_send_t *fn)\n{\n\treturn (cmpxchg((ip6_icmp_send_t **)&ip6_icmp_send, NULL, fn) == NULL) ?\n\t\t0 : -EBUSY;\n}\nEXPORT_SYMBOL(inet6_register_icmp_sender);\n\nint inet6_unregister_icmp_sender(ip6_icmp_send_t *fn)\n{\n\tint ret;\n\n\tret = (cmpxchg((ip6_icmp_send_t **)&ip6_icmp_send, fn, NULL) == fn) ?\n\t      0 : -EINVAL;\n\n\tsynchronize_net();\n\n\treturn ret;\n}\nEXPORT_SYMBOL(inet6_unregister_icmp_sender);\n\nvoid __icmpv6_send(struct sk_buff *skb, u8 type, u8 code, __u32 info,\n\t\t   const struct inet6_skb_parm *parm)\n{\n\tip6_icmp_send_t *send;\n\n\trcu_read_lock();\n\tsend = rcu_dereference(ip6_icmp_send);\n\tif (send)\n\t\tsend(skb, type, code, info, NULL, parm);\n\trcu_read_unlock();\n}\nEXPORT_SYMBOL(__icmpv6_send);\n#endif\n\n#if IS_ENABLED(CONFIG_NF_NAT)\n#include <net/netfilter/nf_conntrack.h>\nvoid icmpv6_ndo_send(struct sk_buff *skb_in, u8 type, u8 code, __u32 info)\n{\n\tstruct inet6_skb_parm parm = { 0 };\n\tstruct sk_buff *cloned_skb = NULL;\n\tenum ip_conntrack_info ctinfo;\n\tstruct in6_addr orig_ip;\n\tstruct nf_conn *ct;\n\n\tct = nf_ct_get(skb_in, &ctinfo);\n\tif (!ct || !(ct->status & IPS_SRC_NAT)) {\n\t\t__icmpv6_send(skb_in, type, code, info, &parm);\n\t\treturn;\n\t}\n\n\tif (skb_shared(skb_in))\n\t\tskb_in = cloned_skb = skb_clone(skb_in, GFP_ATOMIC);\n\n\tif (unlikely(!skb_in || skb_network_header(skb_in) < skb_in->head ||\n\t    (skb_network_header(skb_in) + sizeof(struct ipv6hdr)) >\n\t    skb_tail_pointer(skb_in) || skb_ensure_writable(skb_in,\n\t    skb_network_offset(skb_in) + sizeof(struct ipv6hdr))))\n\t\tgoto out;\n\n\torig_ip = ipv6_hdr(skb_in)->saddr;\n\tipv6_hdr(skb_in)->saddr = ct->tuplehash[0].tuple.src.u3.in6;\n\t__icmpv6_send(skb_in, type, code, info, &parm);\n\tipv6_hdr(skb_in)->saddr = orig_ip;\nout:\n\tconsume_skb(cloned_skb);\n}\nEXPORT_SYMBOL(icmpv6_ndo_send);\n#endif\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}