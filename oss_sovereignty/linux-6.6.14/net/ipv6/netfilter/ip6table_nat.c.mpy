{
  "module_name": "ip6table_nat.c",
  "hash_id": "89c55f6b9728384c46d9c14a5ed1fe3b2c632d5c46aada800a0f1e198ba55079",
  "original_prompt": "Ingested from linux-6.6.14/net/ipv6/netfilter/ip6table_nat.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/netfilter.h>\n#include <linux/netfilter_ipv6.h>\n#include <linux/netfilter_ipv6/ip6_tables.h>\n#include <linux/ipv6.h>\n#include <net/ipv6.h>\n\n#include <net/netfilter/nf_nat.h>\n\nstruct ip6table_nat_pernet {\n\tstruct nf_hook_ops *nf_nat_ops;\n};\n\nstatic unsigned int ip6table_nat_net_id __read_mostly;\n\nstatic const struct xt_table nf_nat_ipv6_table = {\n\t.name\t\t= \"nat\",\n\t.valid_hooks\t= (1 << NF_INET_PRE_ROUTING) |\n\t\t\t  (1 << NF_INET_POST_ROUTING) |\n\t\t\t  (1 << NF_INET_LOCAL_OUT) |\n\t\t\t  (1 << NF_INET_LOCAL_IN),\n\t.me\t\t= THIS_MODULE,\n\t.af\t\t= NFPROTO_IPV6,\n};\n\nstatic const struct nf_hook_ops nf_nat_ipv6_ops[] = {\n\t{\n\t\t.hook\t\t= ip6t_do_table,\n\t\t.pf\t\t= NFPROTO_IPV6,\n\t\t.hooknum\t= NF_INET_PRE_ROUTING,\n\t\t.priority\t= NF_IP6_PRI_NAT_DST,\n\t},\n\t{\n\t\t.hook\t\t= ip6t_do_table,\n\t\t.pf\t\t= NFPROTO_IPV6,\n\t\t.hooknum\t= NF_INET_POST_ROUTING,\n\t\t.priority\t= NF_IP6_PRI_NAT_SRC,\n\t},\n\t{\n\t\t.hook\t\t= ip6t_do_table,\n\t\t.pf\t\t= NFPROTO_IPV6,\n\t\t.hooknum\t= NF_INET_LOCAL_OUT,\n\t\t.priority\t= NF_IP6_PRI_NAT_DST,\n\t},\n\t{\n\t\t.hook\t\t= ip6t_do_table,\n\t\t.pf\t\t= NFPROTO_IPV6,\n\t\t.hooknum\t= NF_INET_LOCAL_IN,\n\t\t.priority\t= NF_IP6_PRI_NAT_SRC,\n\t},\n};\n\nstatic int ip6t_nat_register_lookups(struct net *net)\n{\n\tstruct ip6table_nat_pernet *xt_nat_net;\n\tstruct nf_hook_ops *ops;\n\tstruct xt_table *table;\n\tint i, ret;\n\n\ttable = xt_find_table(net, NFPROTO_IPV6, \"nat\");\n\tif (WARN_ON_ONCE(!table))\n\t\treturn -ENOENT;\n\n\txt_nat_net = net_generic(net, ip6table_nat_net_id);\n\tops = kmemdup(nf_nat_ipv6_ops, sizeof(nf_nat_ipv6_ops), GFP_KERNEL);\n\tif (!ops)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < ARRAY_SIZE(nf_nat_ipv6_ops); i++) {\n\t\tops[i].priv = table;\n\t\tret = nf_nat_ipv6_register_fn(net, &ops[i]);\n\t\tif (ret) {\n\t\t\twhile (i)\n\t\t\t\tnf_nat_ipv6_unregister_fn(net, &ops[--i]);\n\n\t\t\tkfree(ops);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\txt_nat_net->nf_nat_ops = ops;\n\treturn 0;\n}\n\nstatic void ip6t_nat_unregister_lookups(struct net *net)\n{\n\tstruct ip6table_nat_pernet *xt_nat_net = net_generic(net, ip6table_nat_net_id);\n\tstruct nf_hook_ops *ops = xt_nat_net->nf_nat_ops;\n\tint i;\n\n\tif (!ops)\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(nf_nat_ipv6_ops); i++)\n\t\tnf_nat_ipv6_unregister_fn(net, &ops[i]);\n\n\tkfree(ops);\n}\n\nstatic int ip6table_nat_table_init(struct net *net)\n{\n\tstruct ip6t_replace *repl;\n\tint ret;\n\n\trepl = ip6t_alloc_initial_table(&nf_nat_ipv6_table);\n\tif (repl == NULL)\n\t\treturn -ENOMEM;\n\tret = ip6t_register_table(net, &nf_nat_ipv6_table, repl,\n\t\t\t\t  NULL);\n\tif (ret < 0) {\n\t\tkfree(repl);\n\t\treturn ret;\n\t}\n\n\tret = ip6t_nat_register_lookups(net);\n\tif (ret < 0)\n\t\tip6t_unregister_table_exit(net, \"nat\");\n\n\tkfree(repl);\n\treturn ret;\n}\n\nstatic void __net_exit ip6table_nat_net_pre_exit(struct net *net)\n{\n\tip6t_nat_unregister_lookups(net);\n}\n\nstatic void __net_exit ip6table_nat_net_exit(struct net *net)\n{\n\tip6t_unregister_table_exit(net, \"nat\");\n}\n\nstatic struct pernet_operations ip6table_nat_net_ops = {\n\t.pre_exit = ip6table_nat_net_pre_exit,\n\t.exit\t= ip6table_nat_net_exit,\n\t.id\t= &ip6table_nat_net_id,\n\t.size\t= sizeof(struct ip6table_nat_pernet),\n};\n\nstatic int __init ip6table_nat_init(void)\n{\n\tint ret = xt_register_template(&nf_nat_ipv6_table,\n\t\t\t\t       ip6table_nat_table_init);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = register_pernet_subsys(&ip6table_nat_net_ops);\n\tif (ret)\n\t\txt_unregister_template(&nf_nat_ipv6_table);\n\n\treturn ret;\n}\n\nstatic void __exit ip6table_nat_exit(void)\n{\n\tunregister_pernet_subsys(&ip6table_nat_net_ops);\n\txt_unregister_template(&nf_nat_ipv6_table);\n}\n\nmodule_init(ip6table_nat_init);\nmodule_exit(ip6table_nat_exit);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}