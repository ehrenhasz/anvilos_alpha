{
  "module_name": "nf_dup_ipv6.c",
  "hash_id": "a306ca6729b4a0464d6d3b7c562f77887276de6ee4e48197cecc00fd78bfd43f",
  "original_prompt": "Ingested from linux-6.6.14/net/ipv6/netfilter/nf_dup_ipv6.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/percpu.h>\n#include <linux/skbuff.h>\n#include <linux/netfilter.h>\n#include <net/ipv6.h>\n#include <net/ip6_route.h>\n#include <net/netfilter/ipv6/nf_dup_ipv6.h>\n#if IS_ENABLED(CONFIG_NF_CONNTRACK)\n#include <net/netfilter/nf_conntrack.h>\n#endif\n\nstatic bool nf_dup_ipv6_route(struct net *net, struct sk_buff *skb,\n\t\t\t      const struct in6_addr *gw, int oif)\n{\n\tconst struct ipv6hdr *iph = ipv6_hdr(skb);\n\tstruct dst_entry *dst;\n\tstruct flowi6 fl6;\n\n\tmemset(&fl6, 0, sizeof(fl6));\n\tif (oif != -1)\n\t\tfl6.flowi6_oif = oif;\n\n\tfl6.daddr = *gw;\n\tfl6.flowlabel = (__force __be32)(((iph->flow_lbl[0] & 0xF) << 16) |\n\t\t\t(iph->flow_lbl[1] << 8) | iph->flow_lbl[2]);\n\tfl6.flowi6_flags = FLOWI_FLAG_KNOWN_NH;\n\tdst = ip6_route_output(net, NULL, &fl6);\n\tif (dst->error) {\n\t\tdst_release(dst);\n\t\treturn false;\n\t}\n\tskb_dst_drop(skb);\n\tskb_dst_set(skb, dst);\n\tskb->dev      = dst->dev;\n\tskb->protocol = htons(ETH_P_IPV6);\n\n\treturn true;\n}\n\nvoid nf_dup_ipv6(struct net *net, struct sk_buff *skb, unsigned int hooknum,\n\t\t const struct in6_addr *gw, int oif)\n{\n\tif (this_cpu_read(nf_skb_duplicated))\n\t\treturn;\n\tskb = pskb_copy(skb, GFP_ATOMIC);\n\tif (skb == NULL)\n\t\treturn;\n\n#if IS_ENABLED(CONFIG_NF_CONNTRACK)\n\tnf_reset_ct(skb);\n\tnf_ct_set(skb, NULL, IP_CT_UNTRACKED);\n#endif\n\tif (hooknum == NF_INET_PRE_ROUTING ||\n\t    hooknum == NF_INET_LOCAL_IN) {\n\t\tstruct ipv6hdr *iph = ipv6_hdr(skb);\n\t\t--iph->hop_limit;\n\t}\n\tif (nf_dup_ipv6_route(net, skb, gw, oif)) {\n\t\t__this_cpu_write(nf_skb_duplicated, true);\n\t\tip6_local_out(net, skb->sk, skb);\n\t\t__this_cpu_write(nf_skb_duplicated, false);\n\t} else {\n\t\tkfree_skb(skb);\n\t}\n}\nEXPORT_SYMBOL_GPL(nf_dup_ipv6);\n\nMODULE_AUTHOR(\"Sebastian Cla\u00dfen <sebastian.classen@freenet.ag>\");\nMODULE_AUTHOR(\"Jan Engelhardt <jengelh@medozas.de>\");\nMODULE_DESCRIPTION(\"nf_dup_ipv6: IPv6 packet duplication\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}