{
  "module_name": "ib_ring.c",
  "hash_id": "d350d0667f4f06bc8575436ef7ea7252dda0c7ce7aeb655f6953b2c71861bdcb",
  "original_prompt": "Ingested from linux-6.6.14/net/rds/ib_ring.c",
  "human_readable_source": " \n#include <linux/kernel.h>\n\n#include \"rds.h\"\n#include \"ib.h\"\n\n \n\n \nDECLARE_WAIT_QUEUE_HEAD(rds_ib_ring_empty_wait);\n\nvoid rds_ib_ring_init(struct rds_ib_work_ring *ring, u32 nr)\n{\n\tmemset(ring, 0, sizeof(*ring));\n\tring->w_nr = nr;\n\trdsdebug(\"ring %p nr %u\\n\", ring, ring->w_nr);\n}\n\nstatic inline u32 __rds_ib_ring_used(struct rds_ib_work_ring *ring)\n{\n\tu32 diff;\n\n\t \n\tdiff = ring->w_alloc_ctr - (u32) atomic_read(&ring->w_free_ctr);\n\tBUG_ON(diff > ring->w_nr);\n\n\treturn diff;\n}\n\nvoid rds_ib_ring_resize(struct rds_ib_work_ring *ring, u32 nr)\n{\n\t \n\tBUG_ON(__rds_ib_ring_used(ring));\n\tring->w_nr = nr;\n}\n\nstatic int __rds_ib_ring_empty(struct rds_ib_work_ring *ring)\n{\n\treturn __rds_ib_ring_used(ring) == 0;\n}\n\nu32 rds_ib_ring_alloc(struct rds_ib_work_ring *ring, u32 val, u32 *pos)\n{\n\tu32 ret = 0, avail;\n\n\tavail = ring->w_nr - __rds_ib_ring_used(ring);\n\n\trdsdebug(\"ring %p val %u next %u free %u\\n\", ring, val,\n\t\t ring->w_alloc_ptr, avail);\n\n\tif (val && avail) {\n\t\tret = min(val, avail);\n\t\t*pos = ring->w_alloc_ptr;\n\n\t\tring->w_alloc_ptr = (ring->w_alloc_ptr + ret) % ring->w_nr;\n\t\tring->w_alloc_ctr += ret;\n\t}\n\n\treturn ret;\n}\n\nvoid rds_ib_ring_free(struct rds_ib_work_ring *ring, u32 val)\n{\n\tring->w_free_ptr = (ring->w_free_ptr + val) % ring->w_nr;\n\tatomic_add(val, &ring->w_free_ctr);\n\n\tif (__rds_ib_ring_empty(ring) &&\n\t    waitqueue_active(&rds_ib_ring_empty_wait))\n\t\twake_up(&rds_ib_ring_empty_wait);\n}\n\nvoid rds_ib_ring_unalloc(struct rds_ib_work_ring *ring, u32 val)\n{\n\tring->w_alloc_ptr = (ring->w_alloc_ptr - val) % ring->w_nr;\n\tring->w_alloc_ctr -= val;\n}\n\nint rds_ib_ring_empty(struct rds_ib_work_ring *ring)\n{\n\treturn __rds_ib_ring_empty(ring);\n}\n\nint rds_ib_ring_low(struct rds_ib_work_ring *ring)\n{\n\treturn __rds_ib_ring_used(ring) <= (ring->w_nr >> 1);\n}\n\n \nu32 rds_ib_ring_oldest(struct rds_ib_work_ring *ring)\n{\n\treturn ring->w_free_ptr;\n}\n\n \n\nu32 rds_ib_ring_completed(struct rds_ib_work_ring *ring, u32 wr_id, u32 oldest)\n{\n\tu32 ret;\n\n\tif (oldest <= (unsigned long long)wr_id)\n\t\tret = (unsigned long long)wr_id - oldest + 1;\n\telse\n\t\tret = ring->w_nr - oldest + (unsigned long long)wr_id + 1;\n\n\trdsdebug(\"ring %p ret %u wr_id %u oldest %u\\n\", ring, ret,\n\t\t wr_id, oldest);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}