{
  "module_name": "page.c",
  "hash_id": "ad08dcb0a63d37845ba5a064570f923edf93db52c6f103d47633188e8d69a99c",
  "original_prompt": "Ingested from linux-6.6.14/net/rds/page.c",
  "human_readable_source": " \n#include <linux/highmem.h>\n#include <linux/gfp.h>\n#include <linux/cpu.h>\n#include <linux/export.h>\n\n#include \"rds.h\"\n\nstruct rds_page_remainder {\n\tstruct page\t*r_page;\n\tunsigned long\tr_offset;\n};\n\nstatic\nDEFINE_PER_CPU_SHARED_ALIGNED(struct rds_page_remainder, rds_page_remainders);\n\n \nint rds_page_remainder_alloc(struct scatterlist *scat, unsigned long bytes,\n\t\t\t     gfp_t gfp)\n{\n\tstruct rds_page_remainder *rem;\n\tunsigned long flags;\n\tstruct page *page;\n\tint ret;\n\n\tgfp |= __GFP_HIGHMEM;\n\n\t \n\tif (bytes >= PAGE_SIZE) {\n\t\tpage = alloc_page(gfp);\n\t\tif (!page) {\n\t\t\tret = -ENOMEM;\n\t\t} else {\n\t\t\tsg_set_page(scat, page, PAGE_SIZE, 0);\n\t\t\tret = 0;\n\t\t}\n\t\tgoto out;\n\t}\n\n\trem = &per_cpu(rds_page_remainders, get_cpu());\n\tlocal_irq_save(flags);\n\n\twhile (1) {\n\t\t \n\t\tif (rem->r_page && bytes > (PAGE_SIZE - rem->r_offset)) {\n\t\t\trds_stats_inc(s_page_remainder_miss);\n\t\t\t__free_page(rem->r_page);\n\t\t\trem->r_page = NULL;\n\t\t}\n\n\t\t \n\t\tif (rem->r_page && bytes <= (PAGE_SIZE - rem->r_offset)) {\n\t\t\tsg_set_page(scat, rem->r_page, bytes, rem->r_offset);\n\t\t\tget_page(sg_page(scat));\n\n\t\t\tif (rem->r_offset != 0)\n\t\t\t\trds_stats_inc(s_page_remainder_hit);\n\n\t\t\trem->r_offset += ALIGN(bytes, 8);\n\t\t\tif (rem->r_offset >= PAGE_SIZE) {\n\t\t\t\t__free_page(rem->r_page);\n\t\t\t\trem->r_page = NULL;\n\t\t\t}\n\t\t\tret = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tlocal_irq_restore(flags);\n\t\tput_cpu();\n\n\t\tpage = alloc_page(gfp);\n\n\t\trem = &per_cpu(rds_page_remainders, get_cpu());\n\t\tlocal_irq_save(flags);\n\n\t\tif (!page) {\n\t\t\tret = -ENOMEM;\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (rem->r_page) {\n\t\t\t__free_page(page);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\trem->r_page = page;\n\t\trem->r_offset = 0;\n\t}\n\n\tlocal_irq_restore(flags);\n\tput_cpu();\nout:\n\trdsdebug(\"bytes %lu ret %d %p %u %u\\n\", bytes, ret,\n\t\t ret ? NULL : sg_page(scat), ret ? 0 : scat->offset,\n\t\t ret ? 0 : scat->length);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(rds_page_remainder_alloc);\n\nvoid rds_page_exit(void)\n{\n\tunsigned int cpu;\n\n\tfor_each_possible_cpu(cpu) {\n\t\tstruct rds_page_remainder *rem;\n\n\t\trem = &per_cpu(rds_page_remainders, cpu);\n\t\trdsdebug(\"cpu %u\\n\", cpu);\n\n\t\tif (rem->r_page)\n\t\t\t__free_page(rem->r_page);\n\t\trem->r_page = NULL;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}