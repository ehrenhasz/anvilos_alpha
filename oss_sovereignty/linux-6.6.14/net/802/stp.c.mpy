{
  "module_name": "stp.c",
  "hash_id": "ce19cc17b693f10d5dc4c96836b47e71137fe34f13a1ed7d453b8be2385af130",
  "original_prompt": "Ingested from linux-6.6.14/net/802/stp.c",
  "human_readable_source": "\n \n#include <linux/mutex.h>\n#include <linux/skbuff.h>\n#include <linux/etherdevice.h>\n#include <linux/llc.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <net/llc.h>\n#include <net/llc_pdu.h>\n#include <net/stp.h>\n\n \n#define GARP_ADDR_MIN\t0x20\n#define GARP_ADDR_MAX\t0x2F\n#define GARP_ADDR_RANGE\t(GARP_ADDR_MAX - GARP_ADDR_MIN)\n\nstatic const struct stp_proto __rcu *garp_protos[GARP_ADDR_RANGE + 1] __read_mostly;\nstatic const struct stp_proto __rcu *stp_proto __read_mostly;\n\nstatic struct llc_sap *sap __read_mostly;\nstatic unsigned int sap_registered;\nstatic DEFINE_MUTEX(stp_proto_mutex);\n\n \nstatic int stp_pdu_rcv(struct sk_buff *skb, struct net_device *dev,\n\t\t       struct packet_type *pt, struct net_device *orig_dev)\n{\n\tconst struct ethhdr *eh = eth_hdr(skb);\n\tconst struct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\n\tconst struct stp_proto *proto;\n\n\tif (pdu->ssap != LLC_SAP_BSPAN ||\n\t    pdu->dsap != LLC_SAP_BSPAN ||\n\t    pdu->ctrl_1 != LLC_PDU_TYPE_U)\n\t\tgoto err;\n\n\tif (eh->h_dest[5] >= GARP_ADDR_MIN && eh->h_dest[5] <= GARP_ADDR_MAX) {\n\t\tproto = rcu_dereference(garp_protos[eh->h_dest[5] -\n\t\t\t\t\t\t    GARP_ADDR_MIN]);\n\t\tif (proto &&\n\t\t    !ether_addr_equal(eh->h_dest, proto->group_address))\n\t\t\tgoto err;\n\t} else\n\t\tproto = rcu_dereference(stp_proto);\n\n\tif (!proto)\n\t\tgoto err;\n\n\tproto->rcv(proto, skb, dev);\n\treturn 0;\n\nerr:\n\tkfree_skb(skb);\n\treturn 0;\n}\n\nint stp_proto_register(const struct stp_proto *proto)\n{\n\tint err = 0;\n\n\tmutex_lock(&stp_proto_mutex);\n\tif (sap_registered++ == 0) {\n\t\tsap = llc_sap_open(LLC_SAP_BSPAN, stp_pdu_rcv);\n\t\tif (!sap) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto out;\n\t\t}\n\t}\n\tif (is_zero_ether_addr(proto->group_address))\n\t\trcu_assign_pointer(stp_proto, proto);\n\telse\n\t\trcu_assign_pointer(garp_protos[proto->group_address[5] -\n\t\t\t\t\t       GARP_ADDR_MIN], proto);\nout:\n\tmutex_unlock(&stp_proto_mutex);\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(stp_proto_register);\n\nvoid stp_proto_unregister(const struct stp_proto *proto)\n{\n\tmutex_lock(&stp_proto_mutex);\n\tif (is_zero_ether_addr(proto->group_address))\n\t\tRCU_INIT_POINTER(stp_proto, NULL);\n\telse\n\t\tRCU_INIT_POINTER(garp_protos[proto->group_address[5] -\n\t\t\t\t\t       GARP_ADDR_MIN], NULL);\n\tsynchronize_rcu();\n\n\tif (--sap_registered == 0)\n\t\tllc_sap_put(sap);\n\tmutex_unlock(&stp_proto_mutex);\n}\nEXPORT_SYMBOL_GPL(stp_proto_unregister);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}