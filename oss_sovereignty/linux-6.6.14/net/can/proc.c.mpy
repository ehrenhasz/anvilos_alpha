{
  "module_name": "proc.c",
  "hash_id": "6bb3557ab17416050fcf279121fae39378e9953b19e47bbb484256168c48a67b",
  "original_prompt": "Ingested from linux-6.6.14/net/can/proc.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/proc_fs.h>\n#include <linux/list.h>\n#include <linux/rcupdate.h>\n#include <linux/if_arp.h>\n#include <linux/can/can-ml.h>\n#include <linux/can/core.h>\n\n#include \"af_can.h\"\n\n \n\n#define CAN_PROC_STATS       \"stats\"\n#define CAN_PROC_RESET_STATS \"reset_stats\"\n#define CAN_PROC_RCVLIST_ALL \"rcvlist_all\"\n#define CAN_PROC_RCVLIST_FIL \"rcvlist_fil\"\n#define CAN_PROC_RCVLIST_INV \"rcvlist_inv\"\n#define CAN_PROC_RCVLIST_SFF \"rcvlist_sff\"\n#define CAN_PROC_RCVLIST_EFF \"rcvlist_eff\"\n#define CAN_PROC_RCVLIST_ERR \"rcvlist_err\"\n\nstatic int user_reset;\n\nstatic const char rx_list_name[][8] = {\n\t[RX_ERR] = \"rx_err\",\n\t[RX_ALL] = \"rx_all\",\n\t[RX_FIL] = \"rx_fil\",\n\t[RX_INV] = \"rx_inv\",\n};\n\n \n\nstatic void can_init_stats(struct net *net)\n{\n\tstruct can_pkg_stats *pkg_stats = net->can.pkg_stats;\n\tstruct can_rcv_lists_stats *rcv_lists_stats = net->can.rcv_lists_stats;\n\t \n\tmemset(pkg_stats, 0, sizeof(struct can_pkg_stats));\n\tpkg_stats->jiffies_init = jiffies;\n\n\trcv_lists_stats->stats_reset++;\n\n\tif (user_reset) {\n\t\tuser_reset = 0;\n\t\trcv_lists_stats->user_reset++;\n\t}\n}\n\nstatic unsigned long calc_rate(unsigned long oldjif, unsigned long newjif,\n\t\t\t       unsigned long count)\n{\n\tif (oldjif == newjif)\n\t\treturn 0;\n\n\t \n\tif (count > (ULONG_MAX / HZ)) {\n\t\tprintk(KERN_ERR \"can: calc_rate: count exceeded! %ld\\n\",\n\t\t       count);\n\t\treturn 99999999;\n\t}\n\n\treturn (count * HZ) / (newjif - oldjif);\n}\n\nvoid can_stat_update(struct timer_list *t)\n{\n\tstruct net *net = from_timer(net, t, can.stattimer);\n\tstruct can_pkg_stats *pkg_stats = net->can.pkg_stats;\n\tunsigned long j = jiffies;  \n\n\t \n\tif (user_reset)\n\t\tcan_init_stats(net);\n\n\t \n\tif (j < pkg_stats->jiffies_init)\n\t\tcan_init_stats(net);\n\n\t \n\tif (pkg_stats->rx_frames > (ULONG_MAX / HZ))\n\t\tcan_init_stats(net);\n\n\t \n\tif (pkg_stats->tx_frames > (ULONG_MAX / HZ))\n\t\tcan_init_stats(net);\n\n\t \n\tif (pkg_stats->matches > (ULONG_MAX / 100))\n\t\tcan_init_stats(net);\n\n\t \n\tif (pkg_stats->rx_frames)\n\t\tpkg_stats->total_rx_match_ratio = (pkg_stats->matches * 100) /\n\t\t\tpkg_stats->rx_frames;\n\n\tpkg_stats->total_tx_rate = calc_rate(pkg_stats->jiffies_init, j,\n\t\t\t\t\t    pkg_stats->tx_frames);\n\tpkg_stats->total_rx_rate = calc_rate(pkg_stats->jiffies_init, j,\n\t\t\t\t\t    pkg_stats->rx_frames);\n\n\t \n\tif (pkg_stats->rx_frames_delta)\n\t\tpkg_stats->current_rx_match_ratio =\n\t\t\t(pkg_stats->matches_delta * 100) /\n\t\t\tpkg_stats->rx_frames_delta;\n\n\tpkg_stats->current_tx_rate = calc_rate(0, HZ, pkg_stats->tx_frames_delta);\n\tpkg_stats->current_rx_rate = calc_rate(0, HZ, pkg_stats->rx_frames_delta);\n\n\t \n\tif (pkg_stats->max_tx_rate < pkg_stats->current_tx_rate)\n\t\tpkg_stats->max_tx_rate = pkg_stats->current_tx_rate;\n\n\tif (pkg_stats->max_rx_rate < pkg_stats->current_rx_rate)\n\t\tpkg_stats->max_rx_rate = pkg_stats->current_rx_rate;\n\n\tif (pkg_stats->max_rx_match_ratio < pkg_stats->current_rx_match_ratio)\n\t\tpkg_stats->max_rx_match_ratio = pkg_stats->current_rx_match_ratio;\n\n\t \n\tpkg_stats->tx_frames_delta = 0;\n\tpkg_stats->rx_frames_delta = 0;\n\tpkg_stats->matches_delta   = 0;\n\n\t \n\tmod_timer(&net->can.stattimer, round_jiffies(jiffies + HZ));\n}\n\n \n\nstatic void can_print_rcvlist(struct seq_file *m, struct hlist_head *rx_list,\n\t\t\t      struct net_device *dev)\n{\n\tstruct receiver *r;\n\n\thlist_for_each_entry_rcu(r, rx_list, list) {\n\t\tchar *fmt = (r->can_id & CAN_EFF_FLAG)?\n\t\t\t\"   %-5s  %08x  %08x  %pK  %pK  %8ld  %s\\n\" :\n\t\t\t\"   %-5s     %03x    %08x  %pK  %pK  %8ld  %s\\n\";\n\n\t\tseq_printf(m, fmt, DNAME(dev), r->can_id, r->mask,\n\t\t\t\tr->func, r->data, r->matches, r->ident);\n\t}\n}\n\nstatic void can_print_recv_banner(struct seq_file *m)\n{\n\t \n\tif (IS_ENABLED(CONFIG_64BIT))\n\t\tseq_puts(m, \"  device   can_id   can_mask      function          userdata       matches  ident\\n\");\n\telse\n\t\tseq_puts(m, \"  device   can_id   can_mask  function  userdata   matches  ident\\n\");\n}\n\nstatic int can_stats_proc_show(struct seq_file *m, void *v)\n{\n\tstruct net *net = m->private;\n\tstruct can_pkg_stats *pkg_stats = net->can.pkg_stats;\n\tstruct can_rcv_lists_stats *rcv_lists_stats = net->can.rcv_lists_stats;\n\n\tseq_putc(m, '\\n');\n\tseq_printf(m, \" %8ld transmitted frames (TXF)\\n\", pkg_stats->tx_frames);\n\tseq_printf(m, \" %8ld received frames (RXF)\\n\", pkg_stats->rx_frames);\n\tseq_printf(m, \" %8ld matched frames (RXMF)\\n\", pkg_stats->matches);\n\n\tseq_putc(m, '\\n');\n\n\tif (net->can.stattimer.function == can_stat_update) {\n\t\tseq_printf(m, \" %8ld %% total match ratio (RXMR)\\n\",\n\t\t\t\tpkg_stats->total_rx_match_ratio);\n\n\t\tseq_printf(m, \" %8ld frames/s total tx rate (TXR)\\n\",\n\t\t\t\tpkg_stats->total_tx_rate);\n\t\tseq_printf(m, \" %8ld frames/s total rx rate (RXR)\\n\",\n\t\t\t\tpkg_stats->total_rx_rate);\n\n\t\tseq_putc(m, '\\n');\n\n\t\tseq_printf(m, \" %8ld %% current match ratio (CRXMR)\\n\",\n\t\t\t\tpkg_stats->current_rx_match_ratio);\n\n\t\tseq_printf(m, \" %8ld frames/s current tx rate (CTXR)\\n\",\n\t\t\t\tpkg_stats->current_tx_rate);\n\t\tseq_printf(m, \" %8ld frames/s current rx rate (CRXR)\\n\",\n\t\t\t\tpkg_stats->current_rx_rate);\n\n\t\tseq_putc(m, '\\n');\n\n\t\tseq_printf(m, \" %8ld %% max match ratio (MRXMR)\\n\",\n\t\t\t\tpkg_stats->max_rx_match_ratio);\n\n\t\tseq_printf(m, \" %8ld frames/s max tx rate (MTXR)\\n\",\n\t\t\t\tpkg_stats->max_tx_rate);\n\t\tseq_printf(m, \" %8ld frames/s max rx rate (MRXR)\\n\",\n\t\t\t\tpkg_stats->max_rx_rate);\n\n\t\tseq_putc(m, '\\n');\n\t}\n\n\tseq_printf(m, \" %8ld current receive list entries (CRCV)\\n\",\n\t\t\trcv_lists_stats->rcv_entries);\n\tseq_printf(m, \" %8ld maximum receive list entries (MRCV)\\n\",\n\t\t\trcv_lists_stats->rcv_entries_max);\n\n\tif (rcv_lists_stats->stats_reset)\n\t\tseq_printf(m, \"\\n %8ld statistic resets (STR)\\n\",\n\t\t\t\trcv_lists_stats->stats_reset);\n\n\tif (rcv_lists_stats->user_reset)\n\t\tseq_printf(m, \" %8ld user statistic resets (USTR)\\n\",\n\t\t\t\trcv_lists_stats->user_reset);\n\n\tseq_putc(m, '\\n');\n\treturn 0;\n}\n\nstatic int can_reset_stats_proc_show(struct seq_file *m, void *v)\n{\n\tstruct net *net = m->private;\n\tstruct can_rcv_lists_stats *rcv_lists_stats = net->can.rcv_lists_stats;\n\tstruct can_pkg_stats *pkg_stats = net->can.pkg_stats;\n\n\tuser_reset = 1;\n\n\tif (net->can.stattimer.function == can_stat_update) {\n\t\tseq_printf(m, \"Scheduled statistic reset #%ld.\\n\",\n\t\t\t\trcv_lists_stats->stats_reset + 1);\n\t} else {\n\t\tif (pkg_stats->jiffies_init != jiffies)\n\t\t\tcan_init_stats(net);\n\n\t\tseq_printf(m, \"Performed statistic reset #%ld.\\n\",\n\t\t\t\trcv_lists_stats->stats_reset);\n\t}\n\treturn 0;\n}\n\nstatic inline void can_rcvlist_proc_show_one(struct seq_file *m, int idx,\n\t\t\t\t\t     struct net_device *dev,\n\t\t\t\t\t     struct can_dev_rcv_lists *dev_rcv_lists)\n{\n\tif (!hlist_empty(&dev_rcv_lists->rx[idx])) {\n\t\tcan_print_recv_banner(m);\n\t\tcan_print_rcvlist(m, &dev_rcv_lists->rx[idx], dev);\n\t} else\n\t\tseq_printf(m, \"  (%s: no entry)\\n\", DNAME(dev));\n\n}\n\nstatic int can_rcvlist_proc_show(struct seq_file *m, void *v)\n{\n\t \n\tint idx = (int)(long)pde_data(m->file->f_inode);\n\tstruct net_device *dev;\n\tstruct can_dev_rcv_lists *dev_rcv_lists;\n\tstruct net *net = m->private;\n\n\tseq_printf(m, \"\\nreceive list '%s':\\n\", rx_list_name[idx]);\n\n\trcu_read_lock();\n\n\t \n\tdev_rcv_lists = net->can.rx_alldev_list;\n\tcan_rcvlist_proc_show_one(m, idx, NULL, dev_rcv_lists);\n\n\t \n\tfor_each_netdev_rcu(net, dev) {\n\t\tstruct can_ml_priv *can_ml = can_get_ml_priv(dev);\n\n\t\tif (can_ml)\n\t\t\tcan_rcvlist_proc_show_one(m, idx, dev,\n\t\t\t\t\t\t  &can_ml->dev_rcv_lists);\n\t}\n\n\trcu_read_unlock();\n\n\tseq_putc(m, '\\n');\n\treturn 0;\n}\n\nstatic inline void can_rcvlist_proc_show_array(struct seq_file *m,\n\t\t\t\t\t       struct net_device *dev,\n\t\t\t\t\t       struct hlist_head *rcv_array,\n\t\t\t\t\t       unsigned int rcv_array_sz)\n{\n\tunsigned int i;\n\tint all_empty = 1;\n\n\t \n\tfor (i = 0; i < rcv_array_sz; i++)\n\t\tif (!hlist_empty(&rcv_array[i])) {\n\t\t\tall_empty = 0;\n\t\t\tbreak;\n\t\t}\n\n\tif (!all_empty) {\n\t\tcan_print_recv_banner(m);\n\t\tfor (i = 0; i < rcv_array_sz; i++) {\n\t\t\tif (!hlist_empty(&rcv_array[i]))\n\t\t\t\tcan_print_rcvlist(m, &rcv_array[i], dev);\n\t\t}\n\t} else\n\t\tseq_printf(m, \"  (%s: no entry)\\n\", DNAME(dev));\n}\n\nstatic int can_rcvlist_sff_proc_show(struct seq_file *m, void *v)\n{\n\tstruct net_device *dev;\n\tstruct can_dev_rcv_lists *dev_rcv_lists;\n\tstruct net *net = m->private;\n\n\t \n\tseq_puts(m, \"\\nreceive list 'rx_sff':\\n\");\n\n\trcu_read_lock();\n\n\t \n\tdev_rcv_lists = net->can.rx_alldev_list;\n\tcan_rcvlist_proc_show_array(m, NULL, dev_rcv_lists->rx_sff,\n\t\t\t\t    ARRAY_SIZE(dev_rcv_lists->rx_sff));\n\n\t \n\tfor_each_netdev_rcu(net, dev) {\n\t\tstruct can_ml_priv *can_ml = can_get_ml_priv(dev);\n\n\t\tif (can_ml) {\n\t\t\tdev_rcv_lists = &can_ml->dev_rcv_lists;\n\t\t\tcan_rcvlist_proc_show_array(m, dev, dev_rcv_lists->rx_sff,\n\t\t\t\t\t\t    ARRAY_SIZE(dev_rcv_lists->rx_sff));\n\t\t}\n\t}\n\n\trcu_read_unlock();\n\n\tseq_putc(m, '\\n');\n\treturn 0;\n}\n\nstatic int can_rcvlist_eff_proc_show(struct seq_file *m, void *v)\n{\n\tstruct net_device *dev;\n\tstruct can_dev_rcv_lists *dev_rcv_lists;\n\tstruct net *net = m->private;\n\n\t \n\tseq_puts(m, \"\\nreceive list 'rx_eff':\\n\");\n\n\trcu_read_lock();\n\n\t \n\tdev_rcv_lists = net->can.rx_alldev_list;\n\tcan_rcvlist_proc_show_array(m, NULL, dev_rcv_lists->rx_eff,\n\t\t\t\t    ARRAY_SIZE(dev_rcv_lists->rx_eff));\n\n\t \n\tfor_each_netdev_rcu(net, dev) {\n\t\tstruct can_ml_priv *can_ml = can_get_ml_priv(dev);\n\n\t\tif (can_ml) {\n\t\t\tdev_rcv_lists = &can_ml->dev_rcv_lists;\n\t\t\tcan_rcvlist_proc_show_array(m, dev, dev_rcv_lists->rx_eff,\n\t\t\t\t\t\t    ARRAY_SIZE(dev_rcv_lists->rx_eff));\n\t\t}\n\t}\n\n\trcu_read_unlock();\n\n\tseq_putc(m, '\\n');\n\treturn 0;\n}\n\n \nvoid can_init_proc(struct net *net)\n{\n\t \n\tnet->can.proc_dir = proc_net_mkdir(net, \"can\", net->proc_net);\n\n\tif (!net->can.proc_dir) {\n\t\tprintk(KERN_INFO \"can: failed to create /proc/net/can . \"\n\t\t\t   \"CONFIG_PROC_FS missing?\\n\");\n\t\treturn;\n\t}\n\n\t \n\tnet->can.pde_stats = proc_create_net_single(CAN_PROC_STATS, 0644,\n\t\t\tnet->can.proc_dir, can_stats_proc_show, NULL);\n\tnet->can.pde_reset_stats = proc_create_net_single(CAN_PROC_RESET_STATS,\n\t\t\t0644, net->can.proc_dir, can_reset_stats_proc_show,\n\t\t\tNULL);\n\tnet->can.pde_rcvlist_err = proc_create_net_single(CAN_PROC_RCVLIST_ERR,\n\t\t\t0644, net->can.proc_dir, can_rcvlist_proc_show,\n\t\t\t(void *)RX_ERR);\n\tnet->can.pde_rcvlist_all = proc_create_net_single(CAN_PROC_RCVLIST_ALL,\n\t\t\t0644, net->can.proc_dir, can_rcvlist_proc_show,\n\t\t\t(void *)RX_ALL);\n\tnet->can.pde_rcvlist_fil = proc_create_net_single(CAN_PROC_RCVLIST_FIL,\n\t\t\t0644, net->can.proc_dir, can_rcvlist_proc_show,\n\t\t\t(void *)RX_FIL);\n\tnet->can.pde_rcvlist_inv = proc_create_net_single(CAN_PROC_RCVLIST_INV,\n\t\t\t0644, net->can.proc_dir, can_rcvlist_proc_show,\n\t\t\t(void *)RX_INV);\n\tnet->can.pde_rcvlist_eff = proc_create_net_single(CAN_PROC_RCVLIST_EFF,\n\t\t\t0644, net->can.proc_dir, can_rcvlist_eff_proc_show, NULL);\n\tnet->can.pde_rcvlist_sff = proc_create_net_single(CAN_PROC_RCVLIST_SFF,\n\t\t\t0644, net->can.proc_dir, can_rcvlist_sff_proc_show, NULL);\n}\n\n \nvoid can_remove_proc(struct net *net)\n{\n\tif (!net->can.proc_dir)\n\t\treturn;\n\n\tif (net->can.pde_stats)\n\t\tremove_proc_entry(CAN_PROC_STATS, net->can.proc_dir);\n\n\tif (net->can.pde_reset_stats)\n\t\tremove_proc_entry(CAN_PROC_RESET_STATS, net->can.proc_dir);\n\n\tif (net->can.pde_rcvlist_err)\n\t\tremove_proc_entry(CAN_PROC_RCVLIST_ERR, net->can.proc_dir);\n\n\tif (net->can.pde_rcvlist_all)\n\t\tremove_proc_entry(CAN_PROC_RCVLIST_ALL, net->can.proc_dir);\n\n\tif (net->can.pde_rcvlist_fil)\n\t\tremove_proc_entry(CAN_PROC_RCVLIST_FIL, net->can.proc_dir);\n\n\tif (net->can.pde_rcvlist_inv)\n\t\tremove_proc_entry(CAN_PROC_RCVLIST_INV, net->can.proc_dir);\n\n\tif (net->can.pde_rcvlist_eff)\n\t\tremove_proc_entry(CAN_PROC_RCVLIST_EFF, net->can.proc_dir);\n\n\tif (net->can.pde_rcvlist_sff)\n\t\tremove_proc_entry(CAN_PROC_RCVLIST_SFF, net->can.proc_dir);\n\n\tremove_proc_entry(\"can\", net->proc_net);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}