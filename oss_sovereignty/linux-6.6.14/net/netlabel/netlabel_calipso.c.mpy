{
  "module_name": "netlabel_calipso.c",
  "hash_id": "3ab8bc38f49cfe420ccd043a513927d34e445a20de1560a015171009ca102a1f",
  "original_prompt": "Ingested from linux-6.6.14/net/netlabel/netlabel_calipso.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/types.h>\n#include <linux/socket.h>\n#include <linux/string.h>\n#include <linux/skbuff.h>\n#include <linux/audit.h>\n#include <linux/slab.h>\n#include <net/sock.h>\n#include <net/netlink.h>\n#include <net/genetlink.h>\n#include <net/netlabel.h>\n#include <net/calipso.h>\n#include <linux/atomic.h>\n\n#include \"netlabel_user.h\"\n#include \"netlabel_calipso.h\"\n#include \"netlabel_mgmt.h\"\n#include \"netlabel_domainhash.h\"\n\n \nstruct netlbl_calipso_doiwalk_arg {\n\tstruct netlink_callback *nl_cb;\n\tstruct sk_buff *skb;\n\tu32 seq;\n};\n\n \nstruct netlbl_domhsh_walk_arg {\n\tstruct netlbl_audit *audit_info;\n\tu32 doi;\n};\n\n \nstatic struct genl_family netlbl_calipso_gnl_family;\n\n \nstatic const struct nla_policy calipso_genl_policy[NLBL_CALIPSO_A_MAX + 1] = {\n\t[NLBL_CALIPSO_A_DOI] = { .type = NLA_U32 },\n\t[NLBL_CALIPSO_A_MTYPE] = { .type = NLA_U32 },\n};\n\nstatic const struct netlbl_calipso_ops *calipso_ops;\n\n \nconst struct netlbl_calipso_ops *\nnetlbl_calipso_ops_register(const struct netlbl_calipso_ops *ops)\n{\n\treturn xchg(&calipso_ops, ops);\n}\nEXPORT_SYMBOL(netlbl_calipso_ops_register);\n\nstatic const struct netlbl_calipso_ops *netlbl_calipso_ops_get(void)\n{\n\treturn READ_ONCE(calipso_ops);\n}\n\n \n \nstatic int netlbl_calipso_add_pass(struct genl_info *info,\n\t\t\t\t   struct netlbl_audit *audit_info)\n{\n\tint ret_val;\n\tstruct calipso_doi *doi_def = NULL;\n\n\tdoi_def = kmalloc(sizeof(*doi_def), GFP_KERNEL);\n\tif (!doi_def)\n\t\treturn -ENOMEM;\n\tdoi_def->type = CALIPSO_MAP_PASS;\n\tdoi_def->doi = nla_get_u32(info->attrs[NLBL_CALIPSO_A_DOI]);\n\tret_val = calipso_doi_add(doi_def, audit_info);\n\tif (ret_val != 0)\n\t\tcalipso_doi_free(doi_def);\n\n\treturn ret_val;\n}\n\n \nstatic int netlbl_calipso_add(struct sk_buff *skb, struct genl_info *info)\n{\n\tint ret_val = -EINVAL;\n\tstruct netlbl_audit audit_info;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (!info->attrs[NLBL_CALIPSO_A_DOI] ||\n\t    !info->attrs[NLBL_CALIPSO_A_MTYPE])\n\t\treturn -EINVAL;\n\n\tif (!ops)\n\t\treturn -EOPNOTSUPP;\n\n\tnetlbl_netlink_auditinfo(&audit_info);\n\tswitch (nla_get_u32(info->attrs[NLBL_CALIPSO_A_MTYPE])) {\n\tcase CALIPSO_MAP_PASS:\n\t\tret_val = netlbl_calipso_add_pass(info, &audit_info);\n\t\tbreak;\n\t}\n\tif (ret_val == 0)\n\t\tatomic_inc(&netlabel_mgmt_protocount);\n\n\treturn ret_val;\n}\n\n \nstatic int netlbl_calipso_list(struct sk_buff *skb, struct genl_info *info)\n{\n\tint ret_val;\n\tstruct sk_buff *ans_skb = NULL;\n\tvoid *data;\n\tu32 doi;\n\tstruct calipso_doi *doi_def;\n\n\tif (!info->attrs[NLBL_CALIPSO_A_DOI]) {\n\t\tret_val = -EINVAL;\n\t\tgoto list_failure;\n\t}\n\n\tdoi = nla_get_u32(info->attrs[NLBL_CALIPSO_A_DOI]);\n\n\tdoi_def = calipso_doi_getdef(doi);\n\tif (!doi_def) {\n\t\tret_val = -EINVAL;\n\t\tgoto list_failure;\n\t}\n\n\tans_skb = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!ans_skb) {\n\t\tret_val = -ENOMEM;\n\t\tgoto list_failure_put;\n\t}\n\tdata = genlmsg_put_reply(ans_skb, info, &netlbl_calipso_gnl_family,\n\t\t\t\t 0, NLBL_CALIPSO_C_LIST);\n\tif (!data) {\n\t\tret_val = -ENOMEM;\n\t\tgoto list_failure_put;\n\t}\n\n\tret_val = nla_put_u32(ans_skb, NLBL_CALIPSO_A_MTYPE, doi_def->type);\n\tif (ret_val != 0)\n\t\tgoto list_failure_put;\n\n\tcalipso_doi_putdef(doi_def);\n\n\tgenlmsg_end(ans_skb, data);\n\treturn genlmsg_reply(ans_skb, info);\n\nlist_failure_put:\n\tcalipso_doi_putdef(doi_def);\nlist_failure:\n\tkfree_skb(ans_skb);\n\treturn ret_val;\n}\n\n \nstatic int netlbl_calipso_listall_cb(struct calipso_doi *doi_def, void *arg)\n{\n\tint ret_val = -ENOMEM;\n\tstruct netlbl_calipso_doiwalk_arg *cb_arg = arg;\n\tvoid *data;\n\n\tdata = genlmsg_put(cb_arg->skb, NETLINK_CB(cb_arg->nl_cb->skb).portid,\n\t\t\t   cb_arg->seq, &netlbl_calipso_gnl_family,\n\t\t\t   NLM_F_MULTI, NLBL_CALIPSO_C_LISTALL);\n\tif (!data)\n\t\tgoto listall_cb_failure;\n\n\tret_val = nla_put_u32(cb_arg->skb, NLBL_CALIPSO_A_DOI, doi_def->doi);\n\tif (ret_val != 0)\n\t\tgoto listall_cb_failure;\n\tret_val = nla_put_u32(cb_arg->skb,\n\t\t\t      NLBL_CALIPSO_A_MTYPE,\n\t\t\t      doi_def->type);\n\tif (ret_val != 0)\n\t\tgoto listall_cb_failure;\n\n\tgenlmsg_end(cb_arg->skb, data);\n\treturn 0;\n\nlistall_cb_failure:\n\tgenlmsg_cancel(cb_arg->skb, data);\n\treturn ret_val;\n}\n\n \nstatic int netlbl_calipso_listall(struct sk_buff *skb,\n\t\t\t\t  struct netlink_callback *cb)\n{\n\tstruct netlbl_calipso_doiwalk_arg cb_arg;\n\tu32 doi_skip = cb->args[0];\n\n\tcb_arg.nl_cb = cb;\n\tcb_arg.skb = skb;\n\tcb_arg.seq = cb->nlh->nlmsg_seq;\n\n\tcalipso_doi_walk(&doi_skip, netlbl_calipso_listall_cb, &cb_arg);\n\n\tcb->args[0] = doi_skip;\n\treturn skb->len;\n}\n\n \nstatic int netlbl_calipso_remove_cb(struct netlbl_dom_map *entry, void *arg)\n{\n\tstruct netlbl_domhsh_walk_arg *cb_arg = arg;\n\n\tif (entry->def.type == NETLBL_NLTYPE_CALIPSO &&\n\t    entry->def.calipso->doi == cb_arg->doi)\n\t\treturn netlbl_domhsh_remove_entry(entry, cb_arg->audit_info);\n\n\treturn 0;\n}\n\n \nstatic int netlbl_calipso_remove(struct sk_buff *skb, struct genl_info *info)\n{\n\tint ret_val = -EINVAL;\n\tstruct netlbl_domhsh_walk_arg cb_arg;\n\tstruct netlbl_audit audit_info;\n\tu32 skip_bkt = 0;\n\tu32 skip_chain = 0;\n\n\tif (!info->attrs[NLBL_CALIPSO_A_DOI])\n\t\treturn -EINVAL;\n\n\tnetlbl_netlink_auditinfo(&audit_info);\n\tcb_arg.doi = nla_get_u32(info->attrs[NLBL_CALIPSO_A_DOI]);\n\tcb_arg.audit_info = &audit_info;\n\tret_val = netlbl_domhsh_walk(&skip_bkt, &skip_chain,\n\t\t\t\t     netlbl_calipso_remove_cb, &cb_arg);\n\tif (ret_val == 0 || ret_val == -ENOENT) {\n\t\tret_val = calipso_doi_remove(cb_arg.doi, &audit_info);\n\t\tif (ret_val == 0)\n\t\t\tatomic_dec(&netlabel_mgmt_protocount);\n\t}\n\n\treturn ret_val;\n}\n\n \n\nstatic const struct genl_small_ops netlbl_calipso_ops[] = {\n\t{\n\t.cmd = NLBL_CALIPSO_C_ADD,\n\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t.flags = GENL_ADMIN_PERM,\n\t.doit = netlbl_calipso_add,\n\t.dumpit = NULL,\n\t},\n\t{\n\t.cmd = NLBL_CALIPSO_C_REMOVE,\n\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t.flags = GENL_ADMIN_PERM,\n\t.doit = netlbl_calipso_remove,\n\t.dumpit = NULL,\n\t},\n\t{\n\t.cmd = NLBL_CALIPSO_C_LIST,\n\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t.flags = 0,\n\t.doit = netlbl_calipso_list,\n\t.dumpit = NULL,\n\t},\n\t{\n\t.cmd = NLBL_CALIPSO_C_LISTALL,\n\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t.flags = 0,\n\t.doit = NULL,\n\t.dumpit = netlbl_calipso_listall,\n\t},\n};\n\nstatic struct genl_family netlbl_calipso_gnl_family __ro_after_init = {\n\t.hdrsize = 0,\n\t.name = NETLBL_NLTYPE_CALIPSO_NAME,\n\t.version = NETLBL_PROTO_VERSION,\n\t.maxattr = NLBL_CALIPSO_A_MAX,\n\t.policy = calipso_genl_policy,\n\t.module = THIS_MODULE,\n\t.small_ops = netlbl_calipso_ops,\n\t.n_small_ops = ARRAY_SIZE(netlbl_calipso_ops),\n\t.resv_start_op = NLBL_CALIPSO_C_LISTALL + 1,\n};\n\n \n\n \nint __init netlbl_calipso_genl_init(void)\n{\n\treturn genl_register_family(&netlbl_calipso_gnl_family);\n}\n\n \nint calipso_doi_add(struct calipso_doi *doi_def,\n\t\t    struct netlbl_audit *audit_info)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->doi_add(doi_def, audit_info);\n\treturn ret_val;\n}\n\n \nvoid calipso_doi_free(struct calipso_doi *doi_def)\n{\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tops->doi_free(doi_def);\n}\n\n \nint calipso_doi_remove(u32 doi, struct netlbl_audit *audit_info)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->doi_remove(doi, audit_info);\n\treturn ret_val;\n}\n\n \nstruct calipso_doi *calipso_doi_getdef(u32 doi)\n{\n\tstruct calipso_doi *ret_val = NULL;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->doi_getdef(doi);\n\treturn ret_val;\n}\n\n \nvoid calipso_doi_putdef(struct calipso_doi *doi_def)\n{\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tops->doi_putdef(doi_def);\n}\n\n \nint calipso_doi_walk(u32 *skip_cnt,\n\t\t     int (*callback)(struct calipso_doi *doi_def, void *arg),\n\t\t     void *cb_arg)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->doi_walk(skip_cnt, callback, cb_arg);\n\treturn ret_val;\n}\n\n \nint calipso_sock_getattr(struct sock *sk, struct netlbl_lsm_secattr *secattr)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->sock_getattr(sk, secattr);\n\treturn ret_val;\n}\n\n \nint calipso_sock_setattr(struct sock *sk,\n\t\t\t const struct calipso_doi *doi_def,\n\t\t\t const struct netlbl_lsm_secattr *secattr)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->sock_setattr(sk, doi_def, secattr);\n\treturn ret_val;\n}\n\n \nvoid calipso_sock_delattr(struct sock *sk)\n{\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tops->sock_delattr(sk);\n}\n\n \nint calipso_req_setattr(struct request_sock *req,\n\t\t\tconst struct calipso_doi *doi_def,\n\t\t\tconst struct netlbl_lsm_secattr *secattr)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->req_setattr(req, doi_def, secattr);\n\treturn ret_val;\n}\n\n \nvoid calipso_req_delattr(struct request_sock *req)\n{\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tops->req_delattr(req);\n}\n\n \nunsigned char *calipso_optptr(const struct sk_buff *skb)\n{\n\tunsigned char *ret_val = NULL;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->skbuff_optptr(skb);\n\treturn ret_val;\n}\n\n \nint calipso_getattr(const unsigned char *calipso,\n\t\t    struct netlbl_lsm_secattr *secattr)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->opt_getattr(calipso, secattr);\n\treturn ret_val;\n}\n\n \nint calipso_skbuff_setattr(struct sk_buff *skb,\n\t\t\t   const struct calipso_doi *doi_def,\n\t\t\t   const struct netlbl_lsm_secattr *secattr)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->skbuff_setattr(skb, doi_def, secattr);\n\treturn ret_val;\n}\n\n \nint calipso_skbuff_delattr(struct sk_buff *skb)\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->skbuff_delattr(skb);\n\treturn ret_val;\n}\n\n \nvoid calipso_cache_invalidate(void)\n{\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tops->cache_invalidate();\n}\n\n \nint calipso_cache_add(const unsigned char *calipso_ptr,\n\t\t      const struct netlbl_lsm_secattr *secattr)\n\n{\n\tint ret_val = -ENOMSG;\n\tconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\n\n\tif (ops)\n\t\tret_val = ops->cache_add(calipso_ptr, secattr);\n\treturn ret_val;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}