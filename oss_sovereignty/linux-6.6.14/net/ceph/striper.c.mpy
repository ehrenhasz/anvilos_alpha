{
  "module_name": "striper.c",
  "hash_id": "14b1693bd8604b46a9b208f4b703101c6f4f289e24b847152aed471e61d7e579",
  "original_prompt": "Ingested from linux-6.6.14/net/ceph/striper.c",
  "human_readable_source": " \n\n#include <linux/ceph/ceph_debug.h>\n\n#include <linux/math64.h>\n#include <linux/slab.h>\n\n#include <linux/ceph/striper.h>\n#include <linux/ceph/types.h>\n\n \nvoid ceph_calc_file_object_mapping(struct ceph_file_layout *l,\n\t\t\t\t   u64 off, u64 len,\n\t\t\t\t   u64 *objno, u64 *objoff, u32 *xlen)\n{\n\tu32 stripes_per_object = l->object_size / l->stripe_unit;\n\tu64 blockno;\t \n\tu32 blockoff;\t \n\tu64 stripeno;\t \n\tu32 stripepos;\t \n\tu64 objsetno;\t \n\tu32 objsetpos;\t \n\n\tblockno = div_u64_rem(off, l->stripe_unit, &blockoff);\n\tstripeno = div_u64_rem(blockno, l->stripe_count, &stripepos);\n\tobjsetno = div_u64_rem(stripeno, stripes_per_object, &objsetpos);\n\n\t*objno = objsetno * l->stripe_count + stripepos;\n\t*objoff = objsetpos * l->stripe_unit + blockoff;\n\t*xlen = min_t(u64, len, l->stripe_unit - blockoff);\n}\nEXPORT_SYMBOL(ceph_calc_file_object_mapping);\n\n \nstatic struct ceph_object_extent *\nlookup_last(struct list_head *object_extents, u64 objno,\n\t    struct list_head **add_pos)\n{\n\tstruct list_head *pos;\n\n\tlist_for_each_prev(pos, object_extents) {\n\t\tstruct ceph_object_extent *ex =\n\t\t    list_entry(pos, typeof(*ex), oe_item);\n\n\t\tif (ex->oe_objno == objno)\n\t\t\treturn ex;\n\n\t\tif (ex->oe_objno < objno)\n\t\t\tbreak;\n\t}\n\n\t*add_pos = pos;\n\treturn NULL;\n}\n\nstatic struct ceph_object_extent *\nlookup_containing(struct list_head *object_extents, u64 objno,\n\t\t  u64 objoff, u32 xlen)\n{\n\tstruct ceph_object_extent *ex;\n\n\tlist_for_each_entry(ex, object_extents, oe_item) {\n\t\tif (ex->oe_objno == objno &&\n\t\t    ex->oe_off <= objoff &&\n\t\t    ex->oe_off + ex->oe_len >= objoff + xlen)  \n\t\t\treturn ex;\n\n\t\tif (ex->oe_objno > objno)\n\t\t\tbreak;\n\t}\n\n\treturn NULL;\n}\n\n \nint ceph_file_to_extents(struct ceph_file_layout *l, u64 off, u64 len,\n\t\t\t struct list_head *object_extents,\n\t\t\t struct ceph_object_extent *alloc_fn(void *arg),\n\t\t\t void *alloc_arg,\n\t\t\t ceph_object_extent_fn_t action_fn,\n\t\t\t void *action_arg)\n{\n\tstruct ceph_object_extent *last_ex, *ex;\n\n\twhile (len) {\n\t\tstruct list_head *add_pos = NULL;\n\t\tu64 objno, objoff;\n\t\tu32 xlen;\n\n\t\tceph_calc_file_object_mapping(l, off, len, &objno, &objoff,\n\t\t\t\t\t      &xlen);\n\n\t\tlast_ex = lookup_last(object_extents, objno, &add_pos);\n\t\tif (!last_ex || last_ex->oe_off + last_ex->oe_len != objoff) {\n\t\t\tex = alloc_fn(alloc_arg);\n\t\t\tif (!ex)\n\t\t\t\treturn -ENOMEM;\n\n\t\t\tex->oe_objno = objno;\n\t\t\tex->oe_off = objoff;\n\t\t\tex->oe_len = xlen;\n\t\t\tif (action_fn)\n\t\t\t\taction_fn(ex, xlen, action_arg);\n\n\t\t\tif (!last_ex)\n\t\t\t\tlist_add(&ex->oe_item, add_pos);\n\t\t\telse\n\t\t\t\tlist_add(&ex->oe_item, &last_ex->oe_item);\n\t\t} else {\n\t\t\tlast_ex->oe_len += xlen;\n\t\t\tif (action_fn)\n\t\t\t\taction_fn(last_ex, xlen, action_arg);\n\t\t}\n\n\t\toff += xlen;\n\t\tlen -= xlen;\n\t}\n\n\tfor (last_ex = list_first_entry(object_extents, typeof(*ex), oe_item),\n\t     ex = list_next_entry(last_ex, oe_item);\n\t     &ex->oe_item != object_extents;\n\t     last_ex = ex, ex = list_next_entry(ex, oe_item)) {\n\t\tif (last_ex->oe_objno > ex->oe_objno ||\n\t\t    (last_ex->oe_objno == ex->oe_objno &&\n\t\t     last_ex->oe_off + last_ex->oe_len >= ex->oe_off)) {\n\t\t\tWARN(1, \"%s: object_extents list not sorted!\\n\",\n\t\t\t     __func__);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ceph_file_to_extents);\n\n \nint ceph_iterate_extents(struct ceph_file_layout *l, u64 off, u64 len,\n\t\t\t struct list_head *object_extents,\n\t\t\t ceph_object_extent_fn_t action_fn,\n\t\t\t void *action_arg)\n{\n\twhile (len) {\n\t\tstruct ceph_object_extent *ex;\n\t\tu64 objno, objoff;\n\t\tu32 xlen;\n\n\t\tceph_calc_file_object_mapping(l, off, len, &objno, &objoff,\n\t\t\t\t\t      &xlen);\n\n\t\tex = lookup_containing(object_extents, objno, objoff, xlen);\n\t\tif (!ex) {\n\t\t\tWARN(1, \"%s: objno %llu %llu~%u not found!\\n\",\n\t\t\t     __func__, objno, objoff, xlen);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\taction_fn(ex, xlen, action_arg);\n\n\t\toff += xlen;\n\t\tlen -= xlen;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ceph_iterate_extents);\n\n \nint ceph_extent_to_file(struct ceph_file_layout *l,\n\t\t\tu64 objno, u64 objoff, u64 objlen,\n\t\t\tstruct ceph_file_extent **file_extents,\n\t\t\tu32 *num_file_extents)\n{\n\tu32 stripes_per_object = l->object_size / l->stripe_unit;\n\tu64 blockno;\t \n\tu32 blockoff;\t \n\tu64 stripeno;\t \n\tu32 stripepos;\t \n\tu64 objsetno;\t \n\tu32 i = 0;\n\n\tif (!objlen) {\n\t\t*file_extents = NULL;\n\t\t*num_file_extents = 0;\n\t\treturn 0;\n\t}\n\n\t*num_file_extents = DIV_ROUND_UP_ULL(objoff + objlen, l->stripe_unit) -\n\t\t\t\t     DIV_ROUND_DOWN_ULL(objoff, l->stripe_unit);\n\t*file_extents = kmalloc_array(*num_file_extents, sizeof(**file_extents),\n\t\t\t\t      GFP_NOIO);\n\tif (!*file_extents)\n\t\treturn -ENOMEM;\n\n\tdiv_u64_rem(objoff, l->stripe_unit, &blockoff);\n\twhile (objlen) {\n\t\tu64 off, len;\n\n\t\tobjsetno = div_u64_rem(objno, l->stripe_count, &stripepos);\n\t\tstripeno = div_u64(objoff, l->stripe_unit) +\n\t\t\t\t\t\tobjsetno * stripes_per_object;\n\t\tblockno = stripeno * l->stripe_count + stripepos;\n\t\toff = blockno * l->stripe_unit + blockoff;\n\t\tlen = min_t(u64, objlen, l->stripe_unit - blockoff);\n\n\t\t(*file_extents)[i].fe_off = off;\n\t\t(*file_extents)[i].fe_len = len;\n\n\t\tblockoff = 0;\n\t\tobjoff += len;\n\t\tobjlen -= len;\n\t\ti++;\n\t}\n\n\tBUG_ON(i != *num_file_extents);\n\treturn 0;\n}\nEXPORT_SYMBOL(ceph_extent_to_file);\n\nu64 ceph_get_num_objects(struct ceph_file_layout *l, u64 size)\n{\n\tu64 period = (u64)l->stripe_count * l->object_size;\n\tu64 num_periods = DIV64_U64_ROUND_UP(size, period);\n\tu64 remainder_bytes;\n\tu64 remainder_objs = 0;\n\n\tdiv64_u64_rem(size, period, &remainder_bytes);\n\tif (remainder_bytes > 0 &&\n\t    remainder_bytes < (u64)l->stripe_count * l->stripe_unit)\n\t\tremainder_objs = l->stripe_count -\n\t\t\t    DIV_ROUND_UP_ULL(remainder_bytes, l->stripe_unit);\n\n\treturn num_periods * l->stripe_count - remainder_objs;\n}\nEXPORT_SYMBOL(ceph_get_num_objects);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}