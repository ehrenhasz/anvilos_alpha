{
  "module_name": "health.c",
  "hash_id": "2a1818259b538f9afd7c15965015d72c89e69ee05d12cfb04e96ab5450689fbe",
  "original_prompt": "Ingested from linux-6.6.14/net/devlink/health.c",
  "human_readable_source": "\n \n\n#include <net/genetlink.h>\n#include <net/sock.h>\n#include <trace/events/devlink.h>\n#include \"devl_internal.h\"\n\nstruct devlink_fmsg_item {\n\tstruct list_head list;\n\tint attrtype;\n\tu8 nla_type;\n\tu16 len;\n\tint value[];\n};\n\nstruct devlink_fmsg {\n\tstruct list_head item_list;\n\tbool putting_binary;  \n};\n\nstatic struct devlink_fmsg *devlink_fmsg_alloc(void)\n{\n\tstruct devlink_fmsg *fmsg;\n\n\tfmsg = kzalloc(sizeof(*fmsg), GFP_KERNEL);\n\tif (!fmsg)\n\t\treturn NULL;\n\n\tINIT_LIST_HEAD(&fmsg->item_list);\n\n\treturn fmsg;\n}\n\nstatic void devlink_fmsg_free(struct devlink_fmsg *fmsg)\n{\n\tstruct devlink_fmsg_item *item, *tmp;\n\n\tlist_for_each_entry_safe(item, tmp, &fmsg->item_list, list) {\n\t\tlist_del(&item->list);\n\t\tkfree(item);\n\t}\n\tkfree(fmsg);\n}\n\nstruct devlink_health_reporter {\n\tstruct list_head list;\n\tvoid *priv;\n\tconst struct devlink_health_reporter_ops *ops;\n\tstruct devlink *devlink;\n\tstruct devlink_port *devlink_port;\n\tstruct devlink_fmsg *dump_fmsg;\n\tu64 graceful_period;\n\tbool auto_recover;\n\tbool auto_dump;\n\tu8 health_state;\n\tu64 dump_ts;\n\tu64 dump_real_ts;\n\tu64 error_count;\n\tu64 recovery_count;\n\tu64 last_recovery_ts;\n};\n\nvoid *\ndevlink_health_reporter_priv(struct devlink_health_reporter *reporter)\n{\n\treturn reporter->priv;\n}\nEXPORT_SYMBOL_GPL(devlink_health_reporter_priv);\n\nstatic struct devlink_health_reporter *\n__devlink_health_reporter_find_by_name(struct list_head *reporter_list,\n\t\t\t\t       const char *reporter_name)\n{\n\tstruct devlink_health_reporter *reporter;\n\n\tlist_for_each_entry(reporter, reporter_list, list)\n\t\tif (!strcmp(reporter->ops->name, reporter_name))\n\t\t\treturn reporter;\n\treturn NULL;\n}\n\nstatic struct devlink_health_reporter *\ndevlink_health_reporter_find_by_name(struct devlink *devlink,\n\t\t\t\t     const char *reporter_name)\n{\n\treturn __devlink_health_reporter_find_by_name(&devlink->reporter_list,\n\t\t\t\t\t\t      reporter_name);\n}\n\nstatic struct devlink_health_reporter *\ndevlink_port_health_reporter_find_by_name(struct devlink_port *devlink_port,\n\t\t\t\t\t  const char *reporter_name)\n{\n\treturn __devlink_health_reporter_find_by_name(&devlink_port->reporter_list,\n\t\t\t\t\t\t      reporter_name);\n}\n\nstatic struct devlink_health_reporter *\n__devlink_health_reporter_create(struct devlink *devlink,\n\t\t\t\t const struct devlink_health_reporter_ops *ops,\n\t\t\t\t u64 graceful_period, void *priv)\n{\n\tstruct devlink_health_reporter *reporter;\n\n\tif (WARN_ON(graceful_period && !ops->recover))\n\t\treturn ERR_PTR(-EINVAL);\n\n\treporter = kzalloc(sizeof(*reporter), GFP_KERNEL);\n\tif (!reporter)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\treporter->priv = priv;\n\treporter->ops = ops;\n\treporter->devlink = devlink;\n\treporter->graceful_period = graceful_period;\n\treporter->auto_recover = !!ops->recover;\n\treporter->auto_dump = !!ops->dump;\n\treturn reporter;\n}\n\n \nstruct devlink_health_reporter *\ndevl_port_health_reporter_create(struct devlink_port *port,\n\t\t\t\t const struct devlink_health_reporter_ops *ops,\n\t\t\t\t u64 graceful_period, void *priv)\n{\n\tstruct devlink_health_reporter *reporter;\n\n\tdevl_assert_locked(port->devlink);\n\n\tif (__devlink_health_reporter_find_by_name(&port->reporter_list,\n\t\t\t\t\t\t   ops->name))\n\t\treturn ERR_PTR(-EEXIST);\n\n\treporter = __devlink_health_reporter_create(port->devlink, ops,\n\t\t\t\t\t\t    graceful_period, priv);\n\tif (IS_ERR(reporter))\n\t\treturn reporter;\n\n\treporter->devlink_port = port;\n\tlist_add_tail(&reporter->list, &port->reporter_list);\n\treturn reporter;\n}\nEXPORT_SYMBOL_GPL(devl_port_health_reporter_create);\n\nstruct devlink_health_reporter *\ndevlink_port_health_reporter_create(struct devlink_port *port,\n\t\t\t\t    const struct devlink_health_reporter_ops *ops,\n\t\t\t\t    u64 graceful_period, void *priv)\n{\n\tstruct devlink_health_reporter *reporter;\n\tstruct devlink *devlink = port->devlink;\n\n\tdevl_lock(devlink);\n\treporter = devl_port_health_reporter_create(port, ops,\n\t\t\t\t\t\t    graceful_period, priv);\n\tdevl_unlock(devlink);\n\treturn reporter;\n}\nEXPORT_SYMBOL_GPL(devlink_port_health_reporter_create);\n\n \nstruct devlink_health_reporter *\ndevl_health_reporter_create(struct devlink *devlink,\n\t\t\t    const struct devlink_health_reporter_ops *ops,\n\t\t\t    u64 graceful_period, void *priv)\n{\n\tstruct devlink_health_reporter *reporter;\n\n\tdevl_assert_locked(devlink);\n\n\tif (devlink_health_reporter_find_by_name(devlink, ops->name))\n\t\treturn ERR_PTR(-EEXIST);\n\n\treporter = __devlink_health_reporter_create(devlink, ops,\n\t\t\t\t\t\t    graceful_period, priv);\n\tif (IS_ERR(reporter))\n\t\treturn reporter;\n\n\tlist_add_tail(&reporter->list, &devlink->reporter_list);\n\treturn reporter;\n}\nEXPORT_SYMBOL_GPL(devl_health_reporter_create);\n\nstruct devlink_health_reporter *\ndevlink_health_reporter_create(struct devlink *devlink,\n\t\t\t       const struct devlink_health_reporter_ops *ops,\n\t\t\t       u64 graceful_period, void *priv)\n{\n\tstruct devlink_health_reporter *reporter;\n\n\tdevl_lock(devlink);\n\treporter = devl_health_reporter_create(devlink, ops,\n\t\t\t\t\t       graceful_period, priv);\n\tdevl_unlock(devlink);\n\treturn reporter;\n}\nEXPORT_SYMBOL_GPL(devlink_health_reporter_create);\n\nstatic void\ndevlink_health_reporter_free(struct devlink_health_reporter *reporter)\n{\n\tif (reporter->dump_fmsg)\n\t\tdevlink_fmsg_free(reporter->dump_fmsg);\n\tkfree(reporter);\n}\n\n \nvoid\ndevl_health_reporter_destroy(struct devlink_health_reporter *reporter)\n{\n\tdevl_assert_locked(reporter->devlink);\n\n\tlist_del(&reporter->list);\n\tdevlink_health_reporter_free(reporter);\n}\nEXPORT_SYMBOL_GPL(devl_health_reporter_destroy);\n\nvoid\ndevlink_health_reporter_destroy(struct devlink_health_reporter *reporter)\n{\n\tstruct devlink *devlink = reporter->devlink;\n\n\tdevl_lock(devlink);\n\tdevl_health_reporter_destroy(reporter);\n\tdevl_unlock(devlink);\n}\nEXPORT_SYMBOL_GPL(devlink_health_reporter_destroy);\n\nstatic int\ndevlink_nl_health_reporter_fill(struct sk_buff *msg,\n\t\t\t\tstruct devlink_health_reporter *reporter,\n\t\t\t\tenum devlink_command cmd, u32 portid,\n\t\t\t\tu32 seq, int flags)\n{\n\tstruct devlink *devlink = reporter->devlink;\n\tstruct nlattr *reporter_attr;\n\tvoid *hdr;\n\n\thdr = genlmsg_put(msg, portid, seq, &devlink_nl_family, flags, cmd);\n\tif (!hdr)\n\t\treturn -EMSGSIZE;\n\n\tif (devlink_nl_put_handle(msg, devlink))\n\t\tgoto genlmsg_cancel;\n\n\tif (reporter->devlink_port) {\n\t\tif (nla_put_u32(msg, DEVLINK_ATTR_PORT_INDEX, reporter->devlink_port->index))\n\t\t\tgoto genlmsg_cancel;\n\t}\n\treporter_attr = nla_nest_start_noflag(msg,\n\t\t\t\t\t      DEVLINK_ATTR_HEALTH_REPORTER);\n\tif (!reporter_attr)\n\t\tgoto genlmsg_cancel;\n\tif (nla_put_string(msg, DEVLINK_ATTR_HEALTH_REPORTER_NAME,\n\t\t\t   reporter->ops->name))\n\t\tgoto reporter_nest_cancel;\n\tif (nla_put_u8(msg, DEVLINK_ATTR_HEALTH_REPORTER_STATE,\n\t\t       reporter->health_state))\n\t\tgoto reporter_nest_cancel;\n\tif (nla_put_u64_64bit(msg, DEVLINK_ATTR_HEALTH_REPORTER_ERR_COUNT,\n\t\t\t      reporter->error_count, DEVLINK_ATTR_PAD))\n\t\tgoto reporter_nest_cancel;\n\tif (nla_put_u64_64bit(msg, DEVLINK_ATTR_HEALTH_REPORTER_RECOVER_COUNT,\n\t\t\t      reporter->recovery_count, DEVLINK_ATTR_PAD))\n\t\tgoto reporter_nest_cancel;\n\tif (reporter->ops->recover &&\n\t    nla_put_u64_64bit(msg, DEVLINK_ATTR_HEALTH_REPORTER_GRACEFUL_PERIOD,\n\t\t\t      reporter->graceful_period,\n\t\t\t      DEVLINK_ATTR_PAD))\n\t\tgoto reporter_nest_cancel;\n\tif (reporter->ops->recover &&\n\t    nla_put_u8(msg, DEVLINK_ATTR_HEALTH_REPORTER_AUTO_RECOVER,\n\t\t       reporter->auto_recover))\n\t\tgoto reporter_nest_cancel;\n\tif (reporter->dump_fmsg &&\n\t    nla_put_u64_64bit(msg, DEVLINK_ATTR_HEALTH_REPORTER_DUMP_TS,\n\t\t\t      jiffies_to_msecs(reporter->dump_ts),\n\t\t\t      DEVLINK_ATTR_PAD))\n\t\tgoto reporter_nest_cancel;\n\tif (reporter->dump_fmsg &&\n\t    nla_put_u64_64bit(msg, DEVLINK_ATTR_HEALTH_REPORTER_DUMP_TS_NS,\n\t\t\t      reporter->dump_real_ts, DEVLINK_ATTR_PAD))\n\t\tgoto reporter_nest_cancel;\n\tif (reporter->ops->dump &&\n\t    nla_put_u8(msg, DEVLINK_ATTR_HEALTH_REPORTER_AUTO_DUMP,\n\t\t       reporter->auto_dump))\n\t\tgoto reporter_nest_cancel;\n\n\tnla_nest_end(msg, reporter_attr);\n\tgenlmsg_end(msg, hdr);\n\treturn 0;\n\nreporter_nest_cancel:\n\tnla_nest_cancel(msg, reporter_attr);\ngenlmsg_cancel:\n\tgenlmsg_cancel(msg, hdr);\n\treturn -EMSGSIZE;\n}\n\nstatic struct devlink_health_reporter *\ndevlink_health_reporter_get_from_attrs(struct devlink *devlink,\n\t\t\t\t       struct nlattr **attrs)\n{\n\tstruct devlink_port *devlink_port;\n\tchar *reporter_name;\n\n\tif (!attrs[DEVLINK_ATTR_HEALTH_REPORTER_NAME])\n\t\treturn NULL;\n\n\treporter_name = nla_data(attrs[DEVLINK_ATTR_HEALTH_REPORTER_NAME]);\n\tdevlink_port = devlink_port_get_from_attrs(devlink, attrs);\n\tif (IS_ERR(devlink_port))\n\t\treturn devlink_health_reporter_find_by_name(devlink,\n\t\t\t\t\t\t\t    reporter_name);\n\telse\n\t\treturn devlink_port_health_reporter_find_by_name(devlink_port,\n\t\t\t\t\t\t\t\t reporter_name);\n}\n\nstatic struct devlink_health_reporter *\ndevlink_health_reporter_get_from_info(struct devlink *devlink,\n\t\t\t\t      struct genl_info *info)\n{\n\treturn devlink_health_reporter_get_from_attrs(devlink, info->attrs);\n}\n\nint devlink_nl_health_reporter_get_doit(struct sk_buff *skb,\n\t\t\t\t\tstruct genl_info *info)\n{\n\tstruct devlink *devlink = info->user_ptr[0];\n\tstruct devlink_health_reporter *reporter;\n\tstruct sk_buff *msg;\n\tint err;\n\n\treporter = devlink_health_reporter_get_from_info(devlink, info);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\tmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!msg)\n\t\treturn -ENOMEM;\n\n\terr = devlink_nl_health_reporter_fill(msg, reporter,\n\t\t\t\t\t      DEVLINK_CMD_HEALTH_REPORTER_GET,\n\t\t\t\t\t      info->snd_portid, info->snd_seq,\n\t\t\t\t\t      0);\n\tif (err) {\n\t\tnlmsg_free(msg);\n\t\treturn err;\n\t}\n\n\treturn genlmsg_reply(msg, info);\n}\n\nstatic int devlink_nl_health_reporter_get_dump_one(struct sk_buff *msg,\n\t\t\t\t\t\t   struct devlink *devlink,\n\t\t\t\t\t\t   struct netlink_callback *cb,\n\t\t\t\t\t\t   int flags)\n{\n\tstruct devlink_nl_dump_state *state = devlink_dump_state(cb);\n\tconst struct genl_info *info = genl_info_dump(cb);\n\tstruct devlink_health_reporter *reporter;\n\tunsigned long port_index_end = ULONG_MAX;\n\tstruct nlattr **attrs = info->attrs;\n\tunsigned long port_index_start = 0;\n\tstruct devlink_port *port;\n\tunsigned long port_index;\n\tint idx = 0;\n\tint err;\n\n\tif (attrs && attrs[DEVLINK_ATTR_PORT_INDEX]) {\n\t\tport_index_start = nla_get_u32(attrs[DEVLINK_ATTR_PORT_INDEX]);\n\t\tport_index_end = port_index_start;\n\t\tflags |= NLM_F_DUMP_FILTERED;\n\t\tgoto per_port_dump;\n\t}\n\n\tlist_for_each_entry(reporter, &devlink->reporter_list, list) {\n\t\tif (idx < state->idx) {\n\t\t\tidx++;\n\t\t\tcontinue;\n\t\t}\n\t\terr = devlink_nl_health_reporter_fill(msg, reporter,\n\t\t\t\t\t\t      DEVLINK_CMD_HEALTH_REPORTER_GET,\n\t\t\t\t\t\t      NETLINK_CB(cb->skb).portid,\n\t\t\t\t\t\t      cb->nlh->nlmsg_seq,\n\t\t\t\t\t\t      flags);\n\t\tif (err) {\n\t\t\tstate->idx = idx;\n\t\t\treturn err;\n\t\t}\n\t\tidx++;\n\t}\nper_port_dump:\n\txa_for_each_range(&devlink->ports, port_index, port,\n\t\t\t  port_index_start, port_index_end) {\n\t\tlist_for_each_entry(reporter, &port->reporter_list, list) {\n\t\t\tif (idx < state->idx) {\n\t\t\t\tidx++;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\terr = devlink_nl_health_reporter_fill(msg, reporter,\n\t\t\t\t\t\t\t      DEVLINK_CMD_HEALTH_REPORTER_GET,\n\t\t\t\t\t\t\t      NETLINK_CB(cb->skb).portid,\n\t\t\t\t\t\t\t      cb->nlh->nlmsg_seq,\n\t\t\t\t\t\t\t      flags);\n\t\t\tif (err) {\n\t\t\t\tstate->idx = idx;\n\t\t\t\treturn err;\n\t\t\t}\n\t\t\tidx++;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint devlink_nl_health_reporter_get_dumpit(struct sk_buff *skb,\n\t\t\t\t\t  struct netlink_callback *cb)\n{\n\treturn devlink_nl_dumpit(skb, cb,\n\t\t\t\t devlink_nl_health_reporter_get_dump_one);\n}\n\nint devlink_nl_cmd_health_reporter_set_doit(struct sk_buff *skb,\n\t\t\t\t\t    struct genl_info *info)\n{\n\tstruct devlink *devlink = info->user_ptr[0];\n\tstruct devlink_health_reporter *reporter;\n\n\treporter = devlink_health_reporter_get_from_info(devlink, info);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\tif (!reporter->ops->recover &&\n\t    (info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_GRACEFUL_PERIOD] ||\n\t     info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_RECOVER]))\n\t\treturn -EOPNOTSUPP;\n\n\tif (!reporter->ops->dump &&\n\t    info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_DUMP])\n\t\treturn -EOPNOTSUPP;\n\n\tif (info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_GRACEFUL_PERIOD])\n\t\treporter->graceful_period =\n\t\t\tnla_get_u64(info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_GRACEFUL_PERIOD]);\n\n\tif (info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_RECOVER])\n\t\treporter->auto_recover =\n\t\t\tnla_get_u8(info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_RECOVER]);\n\n\tif (info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_DUMP])\n\t\treporter->auto_dump =\n\t\tnla_get_u8(info->attrs[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_DUMP]);\n\n\treturn 0;\n}\n\nstatic void devlink_recover_notify(struct devlink_health_reporter *reporter,\n\t\t\t\t   enum devlink_command cmd)\n{\n\tstruct devlink *devlink = reporter->devlink;\n\tstruct sk_buff *msg;\n\tint err;\n\n\tWARN_ON(cmd != DEVLINK_CMD_HEALTH_REPORTER_RECOVER);\n\tASSERT_DEVLINK_REGISTERED(devlink);\n\n\tmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!msg)\n\t\treturn;\n\n\terr = devlink_nl_health_reporter_fill(msg, reporter, cmd, 0, 0, 0);\n\tif (err) {\n\t\tnlmsg_free(msg);\n\t\treturn;\n\t}\n\n\tgenlmsg_multicast_netns(&devlink_nl_family, devlink_net(devlink), msg,\n\t\t\t\t0, DEVLINK_MCGRP_CONFIG, GFP_KERNEL);\n}\n\nvoid\ndevlink_health_reporter_recovery_done(struct devlink_health_reporter *reporter)\n{\n\treporter->recovery_count++;\n\treporter->last_recovery_ts = jiffies;\n}\nEXPORT_SYMBOL_GPL(devlink_health_reporter_recovery_done);\n\nstatic int\ndevlink_health_reporter_recover(struct devlink_health_reporter *reporter,\n\t\t\t\tvoid *priv_ctx, struct netlink_ext_ack *extack)\n{\n\tint err;\n\n\tif (reporter->health_state == DEVLINK_HEALTH_REPORTER_STATE_HEALTHY)\n\t\treturn 0;\n\n\tif (!reporter->ops->recover)\n\t\treturn -EOPNOTSUPP;\n\n\terr = reporter->ops->recover(reporter, priv_ctx, extack);\n\tif (err)\n\t\treturn err;\n\n\tdevlink_health_reporter_recovery_done(reporter);\n\treporter->health_state = DEVLINK_HEALTH_REPORTER_STATE_HEALTHY;\n\tdevlink_recover_notify(reporter, DEVLINK_CMD_HEALTH_REPORTER_RECOVER);\n\n\treturn 0;\n}\n\nstatic void\ndevlink_health_dump_clear(struct devlink_health_reporter *reporter)\n{\n\tif (!reporter->dump_fmsg)\n\t\treturn;\n\tdevlink_fmsg_free(reporter->dump_fmsg);\n\treporter->dump_fmsg = NULL;\n}\n\nstatic int devlink_health_do_dump(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *priv_ctx,\n\t\t\t\t  struct netlink_ext_ack *extack)\n{\n\tint err;\n\n\tif (!reporter->ops->dump)\n\t\treturn 0;\n\n\tif (reporter->dump_fmsg)\n\t\treturn 0;\n\n\treporter->dump_fmsg = devlink_fmsg_alloc();\n\tif (!reporter->dump_fmsg) {\n\t\terr = -ENOMEM;\n\t\treturn err;\n\t}\n\n\terr = devlink_fmsg_obj_nest_start(reporter->dump_fmsg);\n\tif (err)\n\t\tgoto dump_err;\n\n\terr = reporter->ops->dump(reporter, reporter->dump_fmsg,\n\t\t\t\t  priv_ctx, extack);\n\tif (err)\n\t\tgoto dump_err;\n\n\terr = devlink_fmsg_obj_nest_end(reporter->dump_fmsg);\n\tif (err)\n\t\tgoto dump_err;\n\n\treporter->dump_ts = jiffies;\n\treporter->dump_real_ts = ktime_get_real_ns();\n\n\treturn 0;\n\ndump_err:\n\tdevlink_health_dump_clear(reporter);\n\treturn err;\n}\n\nint devlink_health_report(struct devlink_health_reporter *reporter,\n\t\t\t  const char *msg, void *priv_ctx)\n{\n\tenum devlink_health_reporter_state prev_health_state;\n\tstruct devlink *devlink = reporter->devlink;\n\tunsigned long recover_ts_threshold;\n\tint ret;\n\n\t \n\tWARN_ON(!msg);\n\ttrace_devlink_health_report(devlink, reporter->ops->name, msg);\n\treporter->error_count++;\n\tprev_health_state = reporter->health_state;\n\treporter->health_state = DEVLINK_HEALTH_REPORTER_STATE_ERROR;\n\tdevlink_recover_notify(reporter, DEVLINK_CMD_HEALTH_REPORTER_RECOVER);\n\n\t \n\trecover_ts_threshold = reporter->last_recovery_ts +\n\t\t\t       msecs_to_jiffies(reporter->graceful_period);\n\tif (reporter->auto_recover &&\n\t    (prev_health_state != DEVLINK_HEALTH_REPORTER_STATE_HEALTHY ||\n\t     (reporter->last_recovery_ts && reporter->recovery_count &&\n\t      time_is_after_jiffies(recover_ts_threshold)))) {\n\t\ttrace_devlink_health_recover_aborted(devlink,\n\t\t\t\t\t\t     reporter->ops->name,\n\t\t\t\t\t\t     reporter->health_state,\n\t\t\t\t\t\t     jiffies -\n\t\t\t\t\t\t     reporter->last_recovery_ts);\n\t\treturn -ECANCELED;\n\t}\n\n\tif (reporter->auto_dump) {\n\t\tdevl_lock(devlink);\n\t\t \n\t\tdevlink_health_do_dump(reporter, priv_ctx, NULL);\n\t\tdevl_unlock(devlink);\n\t}\n\n\tif (!reporter->auto_recover)\n\t\treturn 0;\n\n\tdevl_lock(devlink);\n\tret = devlink_health_reporter_recover(reporter, priv_ctx, NULL);\n\tdevl_unlock(devlink);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(devlink_health_report);\n\nvoid\ndevlink_health_reporter_state_update(struct devlink_health_reporter *reporter,\n\t\t\t\t     enum devlink_health_reporter_state state)\n{\n\tif (WARN_ON(state != DEVLINK_HEALTH_REPORTER_STATE_HEALTHY &&\n\t\t    state != DEVLINK_HEALTH_REPORTER_STATE_ERROR))\n\t\treturn;\n\n\tif (reporter->health_state == state)\n\t\treturn;\n\n\treporter->health_state = state;\n\ttrace_devlink_health_reporter_state_update(reporter->devlink,\n\t\t\t\t\t\t   reporter->ops->name, state);\n\tdevlink_recover_notify(reporter, DEVLINK_CMD_HEALTH_REPORTER_RECOVER);\n}\nEXPORT_SYMBOL_GPL(devlink_health_reporter_state_update);\n\nint devlink_nl_cmd_health_reporter_recover_doit(struct sk_buff *skb,\n\t\t\t\t\t\tstruct genl_info *info)\n{\n\tstruct devlink *devlink = info->user_ptr[0];\n\tstruct devlink_health_reporter *reporter;\n\n\treporter = devlink_health_reporter_get_from_info(devlink, info);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\treturn devlink_health_reporter_recover(reporter, NULL, info->extack);\n}\n\nstatic int devlink_fmsg_nest_common(struct devlink_fmsg *fmsg,\n\t\t\t\t    int attrtype)\n{\n\tstruct devlink_fmsg_item *item;\n\n\titem = kzalloc(sizeof(*item), GFP_KERNEL);\n\tif (!item)\n\t\treturn -ENOMEM;\n\n\titem->attrtype = attrtype;\n\tlist_add_tail(&item->list, &fmsg->item_list);\n\n\treturn 0;\n}\n\nint devlink_fmsg_obj_nest_start(struct devlink_fmsg *fmsg)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_nest_common(fmsg, DEVLINK_ATTR_FMSG_OBJ_NEST_START);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_obj_nest_start);\n\nstatic int devlink_fmsg_nest_end(struct devlink_fmsg *fmsg)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_nest_common(fmsg, DEVLINK_ATTR_FMSG_NEST_END);\n}\n\nint devlink_fmsg_obj_nest_end(struct devlink_fmsg *fmsg)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_nest_end(fmsg);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_obj_nest_end);\n\n#define DEVLINK_FMSG_MAX_SIZE (GENLMSG_DEFAULT_SIZE - GENL_HDRLEN - NLA_HDRLEN)\n\nstatic int devlink_fmsg_put_name(struct devlink_fmsg *fmsg, const char *name)\n{\n\tstruct devlink_fmsg_item *item;\n\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\tif (strlen(name) + 1 > DEVLINK_FMSG_MAX_SIZE)\n\t\treturn -EMSGSIZE;\n\n\titem = kzalloc(sizeof(*item) + strlen(name) + 1, GFP_KERNEL);\n\tif (!item)\n\t\treturn -ENOMEM;\n\n\titem->nla_type = NLA_NUL_STRING;\n\titem->len = strlen(name) + 1;\n\titem->attrtype = DEVLINK_ATTR_FMSG_OBJ_NAME;\n\tmemcpy(&item->value, name, item->len);\n\tlist_add_tail(&item->list, &fmsg->item_list);\n\n\treturn 0;\n}\n\nint devlink_fmsg_pair_nest_start(struct devlink_fmsg *fmsg, const char *name)\n{\n\tint err;\n\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\terr = devlink_fmsg_nest_common(fmsg, DEVLINK_ATTR_FMSG_PAIR_NEST_START);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_put_name(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_pair_nest_start);\n\nint devlink_fmsg_pair_nest_end(struct devlink_fmsg *fmsg)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_nest_end(fmsg);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_pair_nest_end);\n\nint devlink_fmsg_arr_pair_nest_start(struct devlink_fmsg *fmsg,\n\t\t\t\t     const char *name)\n{\n\tint err;\n\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_nest_common(fmsg, DEVLINK_ATTR_FMSG_ARR_NEST_START);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_arr_pair_nest_start);\n\nint devlink_fmsg_arr_pair_nest_end(struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\terr = devlink_fmsg_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_arr_pair_nest_end);\n\nint devlink_fmsg_binary_pair_nest_start(struct devlink_fmsg *fmsg,\n\t\t\t\t\tconst char *name)\n{\n\tint err;\n\n\terr = devlink_fmsg_arr_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\tfmsg->putting_binary = true;\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_binary_pair_nest_start);\n\nint devlink_fmsg_binary_pair_nest_end(struct devlink_fmsg *fmsg)\n{\n\tif (!fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\tfmsg->putting_binary = false;\n\treturn devlink_fmsg_arr_pair_nest_end(fmsg);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_binary_pair_nest_end);\n\nstatic int devlink_fmsg_put_value(struct devlink_fmsg *fmsg,\n\t\t\t\t  const void *value, u16 value_len,\n\t\t\t\t  u8 value_nla_type)\n{\n\tstruct devlink_fmsg_item *item;\n\n\tif (value_len > DEVLINK_FMSG_MAX_SIZE)\n\t\treturn -EMSGSIZE;\n\n\titem = kzalloc(sizeof(*item) + value_len, GFP_KERNEL);\n\tif (!item)\n\t\treturn -ENOMEM;\n\n\titem->nla_type = value_nla_type;\n\titem->len = value_len;\n\titem->attrtype = DEVLINK_ATTR_FMSG_OBJ_VALUE_DATA;\n\tmemcpy(&item->value, value, item->len);\n\tlist_add_tail(&item->list, &fmsg->item_list);\n\n\treturn 0;\n}\n\nstatic int devlink_fmsg_bool_put(struct devlink_fmsg *fmsg, bool value)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_put_value(fmsg, &value, sizeof(value), NLA_FLAG);\n}\n\nstatic int devlink_fmsg_u8_put(struct devlink_fmsg *fmsg, u8 value)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_put_value(fmsg, &value, sizeof(value), NLA_U8);\n}\n\nint devlink_fmsg_u32_put(struct devlink_fmsg *fmsg, u32 value)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_put_value(fmsg, &value, sizeof(value), NLA_U32);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_u32_put);\n\nstatic int devlink_fmsg_u64_put(struct devlink_fmsg *fmsg, u64 value)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_put_value(fmsg, &value, sizeof(value), NLA_U64);\n}\n\nint devlink_fmsg_string_put(struct devlink_fmsg *fmsg, const char *value)\n{\n\tif (fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_put_value(fmsg, value, strlen(value) + 1,\n\t\t\t\t      NLA_NUL_STRING);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_string_put);\n\nint devlink_fmsg_binary_put(struct devlink_fmsg *fmsg, const void *value,\n\t\t\t    u16 value_len)\n{\n\tif (!fmsg->putting_binary)\n\t\treturn -EINVAL;\n\n\treturn devlink_fmsg_put_value(fmsg, value, value_len, NLA_BINARY);\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_binary_put);\n\nint devlink_fmsg_bool_pair_put(struct devlink_fmsg *fmsg, const char *name,\n\t\t\t       bool value)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_bool_put(fmsg, value);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_bool_pair_put);\n\nint devlink_fmsg_u8_pair_put(struct devlink_fmsg *fmsg, const char *name,\n\t\t\t     u8 value)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u8_put(fmsg, value);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_u8_pair_put);\n\nint devlink_fmsg_u32_pair_put(struct devlink_fmsg *fmsg, const char *name,\n\t\t\t      u32 value)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_put(fmsg, value);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_u32_pair_put);\n\nint devlink_fmsg_u64_pair_put(struct devlink_fmsg *fmsg, const char *name,\n\t\t\t      u64 value)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u64_put(fmsg, value);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_u64_pair_put);\n\nint devlink_fmsg_string_pair_put(struct devlink_fmsg *fmsg, const char *name,\n\t\t\t\t const char *value)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_string_put(fmsg, value);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_string_pair_put);\n\nint devlink_fmsg_binary_pair_put(struct devlink_fmsg *fmsg, const char *name,\n\t\t\t\t const void *value, u32 value_len)\n{\n\tu32 data_size;\n\tint end_err;\n\tu32 offset;\n\tint err;\n\n\terr = devlink_fmsg_binary_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\tfor (offset = 0; offset < value_len; offset += data_size) {\n\t\tdata_size = value_len - offset;\n\t\tif (data_size > DEVLINK_FMSG_MAX_SIZE)\n\t\t\tdata_size = DEVLINK_FMSG_MAX_SIZE;\n\t\terr = devlink_fmsg_binary_put(fmsg, value + offset, data_size);\n\t\tif (err)\n\t\t\tbreak;\n\t\t \n\t}\n\n\tend_err = devlink_fmsg_binary_pair_nest_end(fmsg);\n\tif (end_err)\n\t\terr = end_err;\n\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(devlink_fmsg_binary_pair_put);\n\nstatic int\ndevlink_fmsg_item_fill_type(struct devlink_fmsg_item *msg, struct sk_buff *skb)\n{\n\tswitch (msg->nla_type) {\n\tcase NLA_FLAG:\n\tcase NLA_U8:\n\tcase NLA_U32:\n\tcase NLA_U64:\n\tcase NLA_NUL_STRING:\n\tcase NLA_BINARY:\n\t\treturn nla_put_u8(skb, DEVLINK_ATTR_FMSG_OBJ_VALUE_TYPE,\n\t\t\t\t  msg->nla_type);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int\ndevlink_fmsg_item_fill_data(struct devlink_fmsg_item *msg, struct sk_buff *skb)\n{\n\tint attrtype = DEVLINK_ATTR_FMSG_OBJ_VALUE_DATA;\n\tu8 tmp;\n\n\tswitch (msg->nla_type) {\n\tcase NLA_FLAG:\n\t\t \n\t\ttmp = *(bool *)msg->value;\n\n\t\treturn nla_put_u8(skb, attrtype, tmp);\n\tcase NLA_U8:\n\t\treturn nla_put_u8(skb, attrtype, *(u8 *)msg->value);\n\tcase NLA_U32:\n\t\treturn nla_put_u32(skb, attrtype, *(u32 *)msg->value);\n\tcase NLA_U64:\n\t\treturn nla_put_u64_64bit(skb, attrtype, *(u64 *)msg->value,\n\t\t\t\t\t DEVLINK_ATTR_PAD);\n\tcase NLA_NUL_STRING:\n\t\treturn nla_put_string(skb, attrtype, (char *)&msg->value);\n\tcase NLA_BINARY:\n\t\treturn nla_put(skb, attrtype, msg->len, (void *)&msg->value);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int\ndevlink_fmsg_prepare_skb(struct devlink_fmsg *fmsg, struct sk_buff *skb,\n\t\t\t int *start)\n{\n\tstruct devlink_fmsg_item *item;\n\tstruct nlattr *fmsg_nlattr;\n\tint err = 0;\n\tint i = 0;\n\n\tfmsg_nlattr = nla_nest_start_noflag(skb, DEVLINK_ATTR_FMSG);\n\tif (!fmsg_nlattr)\n\t\treturn -EMSGSIZE;\n\n\tlist_for_each_entry(item, &fmsg->item_list, list) {\n\t\tif (i < *start) {\n\t\t\ti++;\n\t\t\tcontinue;\n\t\t}\n\n\t\tswitch (item->attrtype) {\n\t\tcase DEVLINK_ATTR_FMSG_OBJ_NEST_START:\n\t\tcase DEVLINK_ATTR_FMSG_PAIR_NEST_START:\n\t\tcase DEVLINK_ATTR_FMSG_ARR_NEST_START:\n\t\tcase DEVLINK_ATTR_FMSG_NEST_END:\n\t\t\terr = nla_put_flag(skb, item->attrtype);\n\t\t\tbreak;\n\t\tcase DEVLINK_ATTR_FMSG_OBJ_VALUE_DATA:\n\t\t\terr = devlink_fmsg_item_fill_type(item, skb);\n\t\t\tif (err)\n\t\t\t\tbreak;\n\t\t\terr = devlink_fmsg_item_fill_data(item, skb);\n\t\t\tbreak;\n\t\tcase DEVLINK_ATTR_FMSG_OBJ_NAME:\n\t\t\terr = nla_put_string(skb, item->attrtype,\n\t\t\t\t\t     (char *)&item->value);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\terr = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t\tif (!err)\n\t\t\t*start = ++i;\n\t\telse\n\t\t\tbreak;\n\t}\n\n\tnla_nest_end(skb, fmsg_nlattr);\n\treturn err;\n}\n\nstatic int devlink_fmsg_snd(struct devlink_fmsg *fmsg,\n\t\t\t    struct genl_info *info,\n\t\t\t    enum devlink_command cmd, int flags)\n{\n\tstruct nlmsghdr *nlh;\n\tstruct sk_buff *skb;\n\tbool last = false;\n\tint index = 0;\n\tvoid *hdr;\n\tint err;\n\n\twhile (!last) {\n\t\tint tmp_index = index;\n\n\t\tskb = genlmsg_new(GENLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\t\tif (!skb)\n\t\t\treturn -ENOMEM;\n\n\t\thdr = genlmsg_put(skb, info->snd_portid, info->snd_seq,\n\t\t\t\t  &devlink_nl_family, flags | NLM_F_MULTI, cmd);\n\t\tif (!hdr) {\n\t\t\terr = -EMSGSIZE;\n\t\t\tgoto nla_put_failure;\n\t\t}\n\n\t\terr = devlink_fmsg_prepare_skb(fmsg, skb, &index);\n\t\tif (!err)\n\t\t\tlast = true;\n\t\telse if (err != -EMSGSIZE || tmp_index == index)\n\t\t\tgoto nla_put_failure;\n\n\t\tgenlmsg_end(skb, hdr);\n\t\terr = genlmsg_reply(skb, info);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tskb = genlmsg_new(GENLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\tnlh = nlmsg_put(skb, info->snd_portid, info->snd_seq,\n\t\t\tNLMSG_DONE, 0, flags | NLM_F_MULTI);\n\tif (!nlh) {\n\t\terr = -EMSGSIZE;\n\t\tgoto nla_put_failure;\n\t}\n\n\treturn genlmsg_reply(skb, info);\n\nnla_put_failure:\n\tnlmsg_free(skb);\n\treturn err;\n}\n\nstatic int devlink_fmsg_dumpit(struct devlink_fmsg *fmsg, struct sk_buff *skb,\n\t\t\t       struct netlink_callback *cb,\n\t\t\t       enum devlink_command cmd)\n{\n\tstruct devlink_nl_dump_state *state = devlink_dump_state(cb);\n\tint index = state->idx;\n\tint tmp_index = index;\n\tvoid *hdr;\n\tint err;\n\n\thdr = genlmsg_put(skb, NETLINK_CB(cb->skb).portid, cb->nlh->nlmsg_seq,\n\t\t\t  &devlink_nl_family, NLM_F_ACK | NLM_F_MULTI, cmd);\n\tif (!hdr) {\n\t\terr = -EMSGSIZE;\n\t\tgoto nla_put_failure;\n\t}\n\n\terr = devlink_fmsg_prepare_skb(fmsg, skb, &index);\n\tif ((err && err != -EMSGSIZE) || tmp_index == index)\n\t\tgoto nla_put_failure;\n\n\tstate->idx = index;\n\tgenlmsg_end(skb, hdr);\n\treturn skb->len;\n\nnla_put_failure:\n\tgenlmsg_cancel(skb, hdr);\n\treturn err;\n}\n\nint devlink_nl_cmd_health_reporter_diagnose_doit(struct sk_buff *skb,\n\t\t\t\t\t\t struct genl_info *info)\n{\n\tstruct devlink *devlink = info->user_ptr[0];\n\tstruct devlink_health_reporter *reporter;\n\tstruct devlink_fmsg *fmsg;\n\tint err;\n\n\treporter = devlink_health_reporter_get_from_info(devlink, info);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\tif (!reporter->ops->diagnose)\n\t\treturn -EOPNOTSUPP;\n\n\tfmsg = devlink_fmsg_alloc();\n\tif (!fmsg)\n\t\treturn -ENOMEM;\n\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\tgoto out;\n\n\terr = reporter->ops->diagnose(reporter, fmsg, info->extack);\n\tif (err)\n\t\tgoto out;\n\n\terr = devlink_fmsg_obj_nest_end(fmsg);\n\tif (err)\n\t\tgoto out;\n\n\terr = devlink_fmsg_snd(fmsg, info,\n\t\t\t       DEVLINK_CMD_HEALTH_REPORTER_DIAGNOSE, 0);\n\nout:\n\tdevlink_fmsg_free(fmsg);\n\treturn err;\n}\n\nstatic struct devlink_health_reporter *\ndevlink_health_reporter_get_from_cb_lock(struct netlink_callback *cb)\n{\n\tconst struct genl_info *info = genl_info_dump(cb);\n\tstruct devlink_health_reporter *reporter;\n\tstruct nlattr **attrs = info->attrs;\n\tstruct devlink *devlink;\n\n\tdevlink = devlink_get_from_attrs_lock(sock_net(cb->skb->sk), attrs);\n\tif (IS_ERR(devlink))\n\t\treturn NULL;\n\n\treporter = devlink_health_reporter_get_from_attrs(devlink, attrs);\n\tif (!reporter) {\n\t\tdevl_unlock(devlink);\n\t\tdevlink_put(devlink);\n\t}\n\treturn reporter;\n}\n\nint devlink_nl_cmd_health_reporter_dump_get_dumpit(struct sk_buff *skb,\n\t\t\t\t\t\t   struct netlink_callback *cb)\n{\n\tstruct devlink_nl_dump_state *state = devlink_dump_state(cb);\n\tstruct devlink_health_reporter *reporter;\n\tstruct devlink *devlink;\n\tint err;\n\n\treporter = devlink_health_reporter_get_from_cb_lock(cb);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\tdevlink = reporter->devlink;\n\tif (!reporter->ops->dump) {\n\t\tdevl_unlock(devlink);\n\t\tdevlink_put(devlink);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (!state->idx) {\n\t\terr = devlink_health_do_dump(reporter, NULL, cb->extack);\n\t\tif (err)\n\t\t\tgoto unlock;\n\t\tstate->dump_ts = reporter->dump_ts;\n\t}\n\tif (!reporter->dump_fmsg || state->dump_ts != reporter->dump_ts) {\n\t\tNL_SET_ERR_MSG(cb->extack, \"Dump trampled, please retry\");\n\t\terr = -EAGAIN;\n\t\tgoto unlock;\n\t}\n\n\terr = devlink_fmsg_dumpit(reporter->dump_fmsg, skb, cb,\n\t\t\t\t  DEVLINK_CMD_HEALTH_REPORTER_DUMP_GET);\nunlock:\n\tdevl_unlock(devlink);\n\tdevlink_put(devlink);\n\treturn err;\n}\n\nint devlink_nl_cmd_health_reporter_dump_clear_doit(struct sk_buff *skb,\n\t\t\t\t\t\t   struct genl_info *info)\n{\n\tstruct devlink *devlink = info->user_ptr[0];\n\tstruct devlink_health_reporter *reporter;\n\n\treporter = devlink_health_reporter_get_from_info(devlink, info);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\tif (!reporter->ops->dump)\n\t\treturn -EOPNOTSUPP;\n\n\tdevlink_health_dump_clear(reporter);\n\treturn 0;\n}\n\nint devlink_nl_cmd_health_reporter_test_doit(struct sk_buff *skb,\n\t\t\t\t\t     struct genl_info *info)\n{\n\tstruct devlink *devlink = info->user_ptr[0];\n\tstruct devlink_health_reporter *reporter;\n\n\treporter = devlink_health_reporter_get_from_info(devlink, info);\n\tif (!reporter)\n\t\treturn -EINVAL;\n\n\tif (!reporter->ops->test)\n\t\treturn -EOPNOTSUPP;\n\n\treturn reporter->ops->test(reporter, info->extack);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}