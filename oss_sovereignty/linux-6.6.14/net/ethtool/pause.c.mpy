{
  "module_name": "pause.c",
  "hash_id": "89852c151785bc45a5f5dcfa8a3271f59a0bd8cff505eb891e355e5aba9c556f",
  "original_prompt": "Ingested from linux-6.6.14/net/ethtool/pause.c",
  "human_readable_source": "\n\n#include \"netlink.h\"\n#include \"common.h\"\n\nstruct pause_req_info {\n\tstruct ethnl_req_info\t\tbase;\n\tenum ethtool_mac_stats_src\tsrc;\n};\n\n#define PAUSE_REQINFO(__req_base) \\\n\tcontainer_of(__req_base, struct pause_req_info, base)\n\nstruct pause_reply_data {\n\tstruct ethnl_reply_data\t\tbase;\n\tstruct ethtool_pauseparam\tpauseparam;\n\tstruct ethtool_pause_stats\tpausestat;\n};\n\n#define PAUSE_REPDATA(__reply_base) \\\n\tcontainer_of(__reply_base, struct pause_reply_data, base)\n\nconst struct nla_policy ethnl_pause_get_policy[] = {\n\t[ETHTOOL_A_PAUSE_HEADER]\t\t=\n\t\tNLA_POLICY_NESTED(ethnl_header_policy_stats),\n\t[ETHTOOL_A_PAUSE_STATS_SRC]\t\t=\n\t\tNLA_POLICY_MAX(NLA_U32, ETHTOOL_MAC_STATS_SRC_PMAC),\n};\n\nstatic int pause_parse_request(struct ethnl_req_info *req_base,\n\t\t\t       struct nlattr **tb,\n\t\t\t       struct netlink_ext_ack *extack)\n{\n\tenum ethtool_mac_stats_src src = ETHTOOL_MAC_STATS_SRC_AGGREGATE;\n\tstruct pause_req_info *req_info = PAUSE_REQINFO(req_base);\n\n\tif (tb[ETHTOOL_A_PAUSE_STATS_SRC]) {\n\t\tif (!(req_base->flags & ETHTOOL_FLAG_STATS)) {\n\t\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t\t   \"ETHTOOL_FLAG_STATS must be set when requesting a source of stats\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tsrc = nla_get_u32(tb[ETHTOOL_A_PAUSE_STATS_SRC]);\n\t}\n\n\treq_info->src = src;\n\n\treturn 0;\n}\n\nstatic int pause_prepare_data(const struct ethnl_req_info *req_base,\n\t\t\t      struct ethnl_reply_data *reply_base,\n\t\t\t      const struct genl_info *info)\n{\n\tconst struct pause_req_info *req_info = PAUSE_REQINFO(req_base);\n\tstruct pause_reply_data *data = PAUSE_REPDATA(reply_base);\n\tenum ethtool_mac_stats_src src = req_info->src;\n\tstruct net_device *dev = reply_base->dev;\n\tint ret;\n\n\tif (!dev->ethtool_ops->get_pauseparam)\n\t\treturn -EOPNOTSUPP;\n\n\tethtool_stats_init((u64 *)&data->pausestat,\n\t\t\t   sizeof(data->pausestat) / 8);\n\tdata->pausestat.src = src;\n\n\tret = ethnl_ops_begin(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif ((src == ETHTOOL_MAC_STATS_SRC_EMAC ||\n\t     src == ETHTOOL_MAC_STATS_SRC_PMAC) &&\n\t    !__ethtool_dev_mm_supported(dev)) {\n\t\tNL_SET_ERR_MSG_MOD(info->extack,\n\t\t\t\t   \"Device does not support MAC merge layer\");\n\t\tethnl_ops_complete(dev);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tdev->ethtool_ops->get_pauseparam(dev, &data->pauseparam);\n\tif (req_base->flags & ETHTOOL_FLAG_STATS &&\n\t    dev->ethtool_ops->get_pause_stats)\n\t\tdev->ethtool_ops->get_pause_stats(dev, &data->pausestat);\n\n\tethnl_ops_complete(dev);\n\n\treturn 0;\n}\n\nstatic int pause_reply_size(const struct ethnl_req_info *req_base,\n\t\t\t    const struct ethnl_reply_data *reply_base)\n{\n\tint n = nla_total_size(sizeof(u8)) +\t \n\t\tnla_total_size(sizeof(u8)) +\t \n\t\tnla_total_size(sizeof(u8));\t \n\n\tif (req_base->flags & ETHTOOL_FLAG_STATS)\n\t\tn += nla_total_size(0) +\t \n\t\t     nla_total_size(sizeof(u32)) +  \n\t\t     nla_total_size_64bit(sizeof(u64)) * ETHTOOL_PAUSE_STAT_CNT;\n\treturn n;\n}\n\nstatic int ethtool_put_stat(struct sk_buff *skb, u64 val, u16 attrtype,\n\t\t\t    u16 padtype)\n{\n\tif (val == ETHTOOL_STAT_NOT_SET)\n\t\treturn 0;\n\tif (nla_put_u64_64bit(skb, attrtype, val, padtype))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int pause_put_stats(struct sk_buff *skb,\n\t\t\t   const struct ethtool_pause_stats *pause_stats)\n{\n\tconst u16 pad = ETHTOOL_A_PAUSE_STAT_PAD;\n\tstruct nlattr *nest;\n\n\tif (nla_put_u32(skb, ETHTOOL_A_PAUSE_STATS_SRC, pause_stats->src))\n\t\treturn -EMSGSIZE;\n\n\tnest = nla_nest_start(skb, ETHTOOL_A_PAUSE_STATS);\n\tif (!nest)\n\t\treturn -EMSGSIZE;\n\n\tif (ethtool_put_stat(skb, pause_stats->tx_pause_frames,\n\t\t\t     ETHTOOL_A_PAUSE_STAT_TX_FRAMES, pad) ||\n\t    ethtool_put_stat(skb, pause_stats->rx_pause_frames,\n\t\t\t     ETHTOOL_A_PAUSE_STAT_RX_FRAMES, pad))\n\t\tgoto err_cancel;\n\n\tnla_nest_end(skb, nest);\n\treturn 0;\n\nerr_cancel:\n\tnla_nest_cancel(skb, nest);\n\treturn -EMSGSIZE;\n}\n\nstatic int pause_fill_reply(struct sk_buff *skb,\n\t\t\t    const struct ethnl_req_info *req_base,\n\t\t\t    const struct ethnl_reply_data *reply_base)\n{\n\tconst struct pause_reply_data *data = PAUSE_REPDATA(reply_base);\n\tconst struct ethtool_pauseparam *pauseparam = &data->pauseparam;\n\n\tif (nla_put_u8(skb, ETHTOOL_A_PAUSE_AUTONEG, !!pauseparam->autoneg) ||\n\t    nla_put_u8(skb, ETHTOOL_A_PAUSE_RX, !!pauseparam->rx_pause) ||\n\t    nla_put_u8(skb, ETHTOOL_A_PAUSE_TX, !!pauseparam->tx_pause))\n\t\treturn -EMSGSIZE;\n\n\tif (req_base->flags & ETHTOOL_FLAG_STATS &&\n\t    pause_put_stats(skb, &data->pausestat))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\n \n\nconst struct nla_policy ethnl_pause_set_policy[] = {\n\t[ETHTOOL_A_PAUSE_HEADER]\t\t=\n\t\tNLA_POLICY_NESTED(ethnl_header_policy),\n\t[ETHTOOL_A_PAUSE_AUTONEG]\t\t= { .type = NLA_U8 },\n\t[ETHTOOL_A_PAUSE_RX]\t\t\t= { .type = NLA_U8 },\n\t[ETHTOOL_A_PAUSE_TX]\t\t\t= { .type = NLA_U8 },\n};\n\nstatic int\nethnl_set_pause_validate(struct ethnl_req_info *req_info,\n\t\t\t struct genl_info *info)\n{\n\tconst struct ethtool_ops *ops = req_info->dev->ethtool_ops;\n\n\treturn ops->get_pauseparam && ops->set_pauseparam ? 1 : -EOPNOTSUPP;\n}\n\nstatic int\nethnl_set_pause(struct ethnl_req_info *req_info, struct genl_info *info)\n{\n\tstruct net_device *dev = req_info->dev;\n\tstruct ethtool_pauseparam params = {};\n\tstruct nlattr **tb = info->attrs;\n\tbool mod = false;\n\tint ret;\n\n\tdev->ethtool_ops->get_pauseparam(dev, &params);\n\n\tethnl_update_bool32(&params.autoneg, tb[ETHTOOL_A_PAUSE_AUTONEG], &mod);\n\tethnl_update_bool32(&params.rx_pause, tb[ETHTOOL_A_PAUSE_RX], &mod);\n\tethnl_update_bool32(&params.tx_pause, tb[ETHTOOL_A_PAUSE_TX], &mod);\n\tif (!mod)\n\t\treturn 0;\n\n\tret = dev->ethtool_ops->set_pauseparam(dev, &params);\n\treturn ret < 0 ? ret : 1;\n}\n\nconst struct ethnl_request_ops ethnl_pause_request_ops = {\n\t.request_cmd\t\t= ETHTOOL_MSG_PAUSE_GET,\n\t.reply_cmd\t\t= ETHTOOL_MSG_PAUSE_GET_REPLY,\n\t.hdr_attr\t\t= ETHTOOL_A_PAUSE_HEADER,\n\t.req_info_size\t\t= sizeof(struct pause_req_info),\n\t.reply_data_size\t= sizeof(struct pause_reply_data),\n\n\t.parse_request\t\t= pause_parse_request,\n\t.prepare_data\t\t= pause_prepare_data,\n\t.reply_size\t\t= pause_reply_size,\n\t.fill_reply\t\t= pause_fill_reply,\n\n\t.set_validate\t\t= ethnl_set_pause_validate,\n\t.set\t\t\t= ethnl_set_pause,\n\t.set_ntf_cmd\t\t= ETHTOOL_MSG_PAUSE_NTF,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}