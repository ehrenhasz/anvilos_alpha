{
  "module_name": "linkstate.c",
  "hash_id": "d138a28d4732a0a35d57c69ca2a95dc1dbc7fe9340f6b0553c7fa24e829252cd",
  "original_prompt": "Ingested from linux-6.6.14/net/ethtool/linkstate.c",
  "human_readable_source": "\n\n#include \"netlink.h\"\n#include \"common.h\"\n#include <linux/phy.h>\n\nstruct linkstate_req_info {\n\tstruct ethnl_req_info\t\tbase;\n};\n\nstruct linkstate_reply_data {\n\tstruct ethnl_reply_data\t\t\tbase;\n\tint\t\t\t\t\tlink;\n\tint\t\t\t\t\tsqi;\n\tint\t\t\t\t\tsqi_max;\n\tstruct ethtool_link_ext_stats\t\tlink_stats;\n\tbool\t\t\t\t\tlink_ext_state_provided;\n\tstruct ethtool_link_ext_state_info\tethtool_link_ext_state_info;\n};\n\n#define LINKSTATE_REPDATA(__reply_base) \\\n\tcontainer_of(__reply_base, struct linkstate_reply_data, base)\n\nconst struct nla_policy ethnl_linkstate_get_policy[] = {\n\t[ETHTOOL_A_LINKSTATE_HEADER]\t\t=\n\t\tNLA_POLICY_NESTED(ethnl_header_policy_stats),\n};\n\nstatic int linkstate_get_sqi(struct net_device *dev)\n{\n\tstruct phy_device *phydev = dev->phydev;\n\tint ret;\n\n\tif (!phydev)\n\t\treturn -EOPNOTSUPP;\n\n\tmutex_lock(&phydev->lock);\n\tif (!phydev->drv || !phydev->drv->get_sqi)\n\t\tret = -EOPNOTSUPP;\n\telse\n\t\tret = phydev->drv->get_sqi(phydev);\n\tmutex_unlock(&phydev->lock);\n\n\treturn ret;\n}\n\nstatic int linkstate_get_sqi_max(struct net_device *dev)\n{\n\tstruct phy_device *phydev = dev->phydev;\n\tint ret;\n\n\tif (!phydev)\n\t\treturn -EOPNOTSUPP;\n\n\tmutex_lock(&phydev->lock);\n\tif (!phydev->drv || !phydev->drv->get_sqi_max)\n\t\tret = -EOPNOTSUPP;\n\telse\n\t\tret = phydev->drv->get_sqi_max(phydev);\n\tmutex_unlock(&phydev->lock);\n\n\treturn ret;\n};\n\nstatic int linkstate_get_link_ext_state(struct net_device *dev,\n\t\t\t\t\tstruct linkstate_reply_data *data)\n{\n\tint err;\n\n\tif (!dev->ethtool_ops->get_link_ext_state)\n\t\treturn -EOPNOTSUPP;\n\n\terr = dev->ethtool_ops->get_link_ext_state(dev, &data->ethtool_link_ext_state_info);\n\tif (err)\n\t\treturn err;\n\n\tdata->link_ext_state_provided = true;\n\n\treturn 0;\n}\n\nstatic int linkstate_prepare_data(const struct ethnl_req_info *req_base,\n\t\t\t\t  struct ethnl_reply_data *reply_base,\n\t\t\t\t  const struct genl_info *info)\n{\n\tstruct linkstate_reply_data *data = LINKSTATE_REPDATA(reply_base);\n\tstruct net_device *dev = reply_base->dev;\n\tint ret;\n\n\tret = ethnl_ops_begin(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\tdata->link = __ethtool_get_link(dev);\n\n\tret = linkstate_get_sqi(dev);\n\tif (ret < 0 && ret != -EOPNOTSUPP)\n\t\tgoto out;\n\tdata->sqi = ret;\n\n\tret = linkstate_get_sqi_max(dev);\n\tif (ret < 0 && ret != -EOPNOTSUPP)\n\t\tgoto out;\n\tdata->sqi_max = ret;\n\n\tif (dev->flags & IFF_UP) {\n\t\tret = linkstate_get_link_ext_state(dev, data);\n\t\tif (ret < 0 && ret != -EOPNOTSUPP && ret != -ENODATA)\n\t\t\tgoto out;\n\t}\n\n\tethtool_stats_init((u64 *)&data->link_stats,\n\t\t\t   sizeof(data->link_stats) / 8);\n\n\tif (req_base->flags & ETHTOOL_FLAG_STATS) {\n\t\tif (dev->phydev)\n\t\t\tdata->link_stats.link_down_events =\n\t\t\t\tREAD_ONCE(dev->phydev->link_down_events);\n\n\t\tif (dev->ethtool_ops->get_link_ext_stats)\n\t\t\tdev->ethtool_ops->get_link_ext_stats(dev,\n\t\t\t\t\t\t\t     &data->link_stats);\n\t}\n\n\tret = 0;\nout:\n\tethnl_ops_complete(dev);\n\treturn ret;\n}\n\nstatic int linkstate_reply_size(const struct ethnl_req_info *req_base,\n\t\t\t\tconst struct ethnl_reply_data *reply_base)\n{\n\tstruct linkstate_reply_data *data = LINKSTATE_REPDATA(reply_base);\n\tint len;\n\n\tlen = nla_total_size(sizeof(u8))  \n\t\t+ 0;\n\n\tif (data->sqi != -EOPNOTSUPP)\n\t\tlen += nla_total_size(sizeof(u32));\n\n\tif (data->sqi_max != -EOPNOTSUPP)\n\t\tlen += nla_total_size(sizeof(u32));\n\n\tif (data->link_ext_state_provided)\n\t\tlen += nla_total_size(sizeof(u8));  \n\n\tif (data->ethtool_link_ext_state_info.__link_ext_substate)\n\t\tlen += nla_total_size(sizeof(u8));  \n\n\tif (data->link_stats.link_down_events != ETHTOOL_STAT_NOT_SET)\n\t\tlen += nla_total_size(sizeof(u32));\n\n\treturn len;\n}\n\nstatic int linkstate_fill_reply(struct sk_buff *skb,\n\t\t\t\tconst struct ethnl_req_info *req_base,\n\t\t\t\tconst struct ethnl_reply_data *reply_base)\n{\n\tstruct linkstate_reply_data *data = LINKSTATE_REPDATA(reply_base);\n\n\tif (data->link >= 0 &&\n\t    nla_put_u8(skb, ETHTOOL_A_LINKSTATE_LINK, !!data->link))\n\t\treturn -EMSGSIZE;\n\n\tif (data->sqi != -EOPNOTSUPP &&\n\t    nla_put_u32(skb, ETHTOOL_A_LINKSTATE_SQI, data->sqi))\n\t\treturn -EMSGSIZE;\n\n\tif (data->sqi_max != -EOPNOTSUPP &&\n\t    nla_put_u32(skb, ETHTOOL_A_LINKSTATE_SQI_MAX, data->sqi_max))\n\t\treturn -EMSGSIZE;\n\n\tif (data->link_ext_state_provided) {\n\t\tif (nla_put_u8(skb, ETHTOOL_A_LINKSTATE_EXT_STATE,\n\t\t\t       data->ethtool_link_ext_state_info.link_ext_state))\n\t\t\treturn -EMSGSIZE;\n\n\t\tif (data->ethtool_link_ext_state_info.__link_ext_substate &&\n\t\t    nla_put_u8(skb, ETHTOOL_A_LINKSTATE_EXT_SUBSTATE,\n\t\t\t       data->ethtool_link_ext_state_info.__link_ext_substate))\n\t\t\treturn -EMSGSIZE;\n\t}\n\n\tif (data->link_stats.link_down_events != ETHTOOL_STAT_NOT_SET)\n\t\tif (nla_put_u32(skb, ETHTOOL_A_LINKSTATE_EXT_DOWN_CNT,\n\t\t\t\tdata->link_stats.link_down_events))\n\t\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nconst struct ethnl_request_ops ethnl_linkstate_request_ops = {\n\t.request_cmd\t\t= ETHTOOL_MSG_LINKSTATE_GET,\n\t.reply_cmd\t\t= ETHTOOL_MSG_LINKSTATE_GET_REPLY,\n\t.hdr_attr\t\t= ETHTOOL_A_LINKSTATE_HEADER,\n\t.req_info_size\t\t= sizeof(struct linkstate_req_info),\n\t.reply_data_size\t= sizeof(struct linkstate_reply_data),\n\n\t.prepare_data\t\t= linkstate_prepare_data,\n\t.reply_size\t\t= linkstate_reply_size,\n\t.fill_reply\t\t= linkstate_fill_reply,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}