{
  "module_name": "pse-pd.c",
  "hash_id": "58baa1eb870fc9cac142275a88ab69ce0613a24d6a57476cec43000df1b598ea",
  "original_prompt": "Ingested from linux-6.6.14/net/ethtool/pse-pd.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include \"common.h\"\n#include \"linux/pse-pd/pse.h\"\n#include \"netlink.h\"\n#include <linux/ethtool_netlink.h>\n#include <linux/ethtool.h>\n#include <linux/phy.h>\n\nstruct pse_req_info {\n\tstruct ethnl_req_info base;\n};\n\nstruct pse_reply_data {\n\tstruct ethnl_reply_data\tbase;\n\tstruct pse_control_status status;\n};\n\n#define PSE_REPDATA(__reply_base) \\\n\tcontainer_of(__reply_base, struct pse_reply_data, base)\n\n \n\nconst struct nla_policy ethnl_pse_get_policy[ETHTOOL_A_PSE_HEADER + 1] = {\n\t[ETHTOOL_A_PSE_HEADER] = NLA_POLICY_NESTED(ethnl_header_policy),\n};\n\nstatic int pse_get_pse_attributes(struct net_device *dev,\n\t\t\t\t  struct netlink_ext_ack *extack,\n\t\t\t\t  struct pse_reply_data *data)\n{\n\tstruct phy_device *phydev = dev->phydev;\n\n\tif (!phydev) {\n\t\tNL_SET_ERR_MSG(extack, \"No PHY is attached\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (!phydev->psec) {\n\t\tNL_SET_ERR_MSG(extack, \"No PSE is attached\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tmemset(&data->status, 0, sizeof(data->status));\n\n\treturn pse_ethtool_get_status(phydev->psec, extack, &data->status);\n}\n\nstatic int pse_prepare_data(const struct ethnl_req_info *req_base,\n\t\t\t    struct ethnl_reply_data *reply_base,\n\t\t\t    const struct genl_info *info)\n{\n\tstruct pse_reply_data *data = PSE_REPDATA(reply_base);\n\tstruct net_device *dev = reply_base->dev;\n\tint ret;\n\n\tret = ethnl_ops_begin(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = pse_get_pse_attributes(dev, info->extack, data);\n\n\tethnl_ops_complete(dev);\n\n\treturn ret;\n}\n\nstatic int pse_reply_size(const struct ethnl_req_info *req_base,\n\t\t\t  const struct ethnl_reply_data *reply_base)\n{\n\tconst struct pse_reply_data *data = PSE_REPDATA(reply_base);\n\tconst struct pse_control_status *st = &data->status;\n\tint len = 0;\n\n\tif (st->podl_admin_state > 0)\n\t\tlen += nla_total_size(sizeof(u32));  \n\tif (st->podl_pw_status > 0)\n\t\tlen += nla_total_size(sizeof(u32));  \n\n\treturn len;\n}\n\nstatic int pse_fill_reply(struct sk_buff *skb,\n\t\t\t  const struct ethnl_req_info *req_base,\n\t\t\t  const struct ethnl_reply_data *reply_base)\n{\n\tconst struct pse_reply_data *data = PSE_REPDATA(reply_base);\n\tconst struct pse_control_status *st = &data->status;\n\n\tif (st->podl_admin_state > 0 &&\n\t    nla_put_u32(skb, ETHTOOL_A_PODL_PSE_ADMIN_STATE,\n\t\t\tst->podl_admin_state))\n\t\treturn -EMSGSIZE;\n\n\tif (st->podl_pw_status > 0 &&\n\t    nla_put_u32(skb, ETHTOOL_A_PODL_PSE_PW_D_STATUS,\n\t\t\tst->podl_pw_status))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\n \n\nconst struct nla_policy ethnl_pse_set_policy[ETHTOOL_A_PSE_MAX + 1] = {\n\t[ETHTOOL_A_PSE_HEADER] = NLA_POLICY_NESTED(ethnl_header_policy),\n\t[ETHTOOL_A_PODL_PSE_ADMIN_CONTROL] =\n\t\tNLA_POLICY_RANGE(NLA_U32, ETHTOOL_PODL_PSE_ADMIN_STATE_DISABLED,\n\t\t\t\t ETHTOOL_PODL_PSE_ADMIN_STATE_ENABLED),\n};\n\nstatic int\nethnl_set_pse_validate(struct ethnl_req_info *req_info, struct genl_info *info)\n{\n\treturn !!info->attrs[ETHTOOL_A_PODL_PSE_ADMIN_CONTROL];\n}\n\nstatic int\nethnl_set_pse(struct ethnl_req_info *req_info, struct genl_info *info)\n{\n\tstruct net_device *dev = req_info->dev;\n\tstruct pse_control_config config = {};\n\tstruct nlattr **tb = info->attrs;\n\tstruct phy_device *phydev;\n\n\t \n\tconfig.admin_cotrol = nla_get_u32(tb[ETHTOOL_A_PODL_PSE_ADMIN_CONTROL]);\n\n\tphydev = dev->phydev;\n\tif (!phydev) {\n\t\tNL_SET_ERR_MSG(info->extack, \"No PHY is attached\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (!phydev->psec) {\n\t\tNL_SET_ERR_MSG(info->extack, \"No PSE is attached\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\t \n\treturn pse_ethtool_set_config(phydev->psec, info->extack, &config);\n}\n\nconst struct ethnl_request_ops ethnl_pse_request_ops = {\n\t.request_cmd\t\t= ETHTOOL_MSG_PSE_GET,\n\t.reply_cmd\t\t= ETHTOOL_MSG_PSE_GET_REPLY,\n\t.hdr_attr\t\t= ETHTOOL_A_PSE_HEADER,\n\t.req_info_size\t\t= sizeof(struct pse_req_info),\n\t.reply_data_size\t= sizeof(struct pse_reply_data),\n\n\t.prepare_data\t\t= pse_prepare_data,\n\t.reply_size\t\t= pse_reply_size,\n\t.fill_reply\t\t= pse_fill_reply,\n\n\t.set_validate\t\t= ethnl_set_pse_validate,\n\t.set\t\t\t= ethnl_set_pse,\n\t \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}