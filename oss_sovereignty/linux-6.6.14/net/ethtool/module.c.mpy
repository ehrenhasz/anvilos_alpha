{
  "module_name": "module.c",
  "hash_id": "0d251a33697805cd6e61e74a7d0f83735f7b140e412d0c31370b9c77f7cdb36a",
  "original_prompt": "Ingested from linux-6.6.14/net/ethtool/module.c",
  "human_readable_source": "\n\n#include <linux/ethtool.h>\n\n#include \"netlink.h\"\n#include \"common.h\"\n#include \"bitset.h\"\n\nstruct module_req_info {\n\tstruct ethnl_req_info base;\n};\n\nstruct module_reply_data {\n\tstruct ethnl_reply_data\tbase;\n\tstruct ethtool_module_power_mode_params power;\n};\n\n#define MODULE_REPDATA(__reply_base) \\\n\tcontainer_of(__reply_base, struct module_reply_data, base)\n\n \n\nconst struct nla_policy ethnl_module_get_policy[ETHTOOL_A_MODULE_HEADER + 1] = {\n\t[ETHTOOL_A_MODULE_HEADER] = NLA_POLICY_NESTED(ethnl_header_policy),\n};\n\nstatic int module_get_power_mode(struct net_device *dev,\n\t\t\t\t struct module_reply_data *data,\n\t\t\t\t struct netlink_ext_ack *extack)\n{\n\tconst struct ethtool_ops *ops = dev->ethtool_ops;\n\n\tif (!ops->get_module_power_mode)\n\t\treturn 0;\n\n\treturn ops->get_module_power_mode(dev, &data->power, extack);\n}\n\nstatic int module_prepare_data(const struct ethnl_req_info *req_base,\n\t\t\t       struct ethnl_reply_data *reply_base,\n\t\t\t       const struct genl_info *info)\n{\n\tstruct module_reply_data *data = MODULE_REPDATA(reply_base);\n\tstruct net_device *dev = reply_base->dev;\n\tint ret;\n\n\tret = ethnl_ops_begin(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = module_get_power_mode(dev, data, info->extack);\n\tif (ret < 0)\n\t\tgoto out_complete;\n\nout_complete:\n\tethnl_ops_complete(dev);\n\treturn ret;\n}\n\nstatic int module_reply_size(const struct ethnl_req_info *req_base,\n\t\t\t     const struct ethnl_reply_data *reply_base)\n{\n\tstruct module_reply_data *data = MODULE_REPDATA(reply_base);\n\tint len = 0;\n\n\tif (data->power.policy)\n\t\tlen += nla_total_size(sizeof(u8));\t \n\n\tif (data->power.mode)\n\t\tlen += nla_total_size(sizeof(u8));\t \n\n\treturn len;\n}\n\nstatic int module_fill_reply(struct sk_buff *skb,\n\t\t\t     const struct ethnl_req_info *req_base,\n\t\t\t     const struct ethnl_reply_data *reply_base)\n{\n\tconst struct module_reply_data *data = MODULE_REPDATA(reply_base);\n\n\tif (data->power.policy &&\n\t    nla_put_u8(skb, ETHTOOL_A_MODULE_POWER_MODE_POLICY,\n\t\t       data->power.policy))\n\t\treturn -EMSGSIZE;\n\n\tif (data->power.mode &&\n\t    nla_put_u8(skb, ETHTOOL_A_MODULE_POWER_MODE, data->power.mode))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\n \n\nconst struct nla_policy ethnl_module_set_policy[ETHTOOL_A_MODULE_POWER_MODE_POLICY + 1] = {\n\t[ETHTOOL_A_MODULE_HEADER] = NLA_POLICY_NESTED(ethnl_header_policy),\n\t[ETHTOOL_A_MODULE_POWER_MODE_POLICY] =\n\t\tNLA_POLICY_RANGE(NLA_U8, ETHTOOL_MODULE_POWER_MODE_POLICY_HIGH,\n\t\t\t\t ETHTOOL_MODULE_POWER_MODE_POLICY_AUTO),\n};\n\nstatic int\nethnl_set_module_validate(struct ethnl_req_info *req_info,\n\t\t\t  struct genl_info *info)\n{\n\tconst struct ethtool_ops *ops = req_info->dev->ethtool_ops;\n\tstruct nlattr **tb = info->attrs;\n\n\tif (!tb[ETHTOOL_A_MODULE_POWER_MODE_POLICY])\n\t\treturn 0;\n\n\tif (!ops->get_module_power_mode || !ops->set_module_power_mode) {\n\t\tNL_SET_ERR_MSG_ATTR(info->extack,\n\t\t\t\t    tb[ETHTOOL_A_MODULE_POWER_MODE_POLICY],\n\t\t\t\t    \"Setting power mode policy is not supported by this device\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn 1;\n}\n\nstatic int\nethnl_set_module(struct ethnl_req_info *req_info, struct genl_info *info)\n{\n\tstruct ethtool_module_power_mode_params power = {};\n\tstruct ethtool_module_power_mode_params power_new;\n\tconst struct ethtool_ops *ops;\n\tstruct net_device *dev = req_info->dev;\n\tstruct nlattr **tb = info->attrs;\n\tint ret;\n\n\tops = dev->ethtool_ops;\n\n\tpower_new.policy = nla_get_u8(tb[ETHTOOL_A_MODULE_POWER_MODE_POLICY]);\n\tret = ops->get_module_power_mode(dev, &power, info->extack);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (power_new.policy == power.policy)\n\t\treturn 0;\n\n\tret = ops->set_module_power_mode(dev, &power_new, info->extack);\n\treturn ret < 0 ? ret : 1;\n}\n\nconst struct ethnl_request_ops ethnl_module_request_ops = {\n\t.request_cmd\t\t= ETHTOOL_MSG_MODULE_GET,\n\t.reply_cmd\t\t= ETHTOOL_MSG_MODULE_GET_REPLY,\n\t.hdr_attr\t\t= ETHTOOL_A_MODULE_HEADER,\n\t.req_info_size\t\t= sizeof(struct module_req_info),\n\t.reply_data_size\t= sizeof(struct module_reply_data),\n\n\t.prepare_data\t\t= module_prepare_data,\n\t.reply_size\t\t= module_reply_size,\n\t.fill_reply\t\t= module_fill_reply,\n\n\t.set_validate\t\t= ethnl_set_module_validate,\n\t.set\t\t\t= ethnl_set_module,\n\t.set_ntf_cmd\t\t= ETHTOOL_MSG_MODULE_NTF,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}