{
  "module_name": "linkinfo.c",
  "hash_id": "eb9993cf568bbf6029298de829d23620afb378b4680013f96b03fb79075beb2f",
  "original_prompt": "Ingested from linux-6.6.14/net/ethtool/linkinfo.c",
  "human_readable_source": "\n\n#include \"netlink.h\"\n#include \"common.h\"\n\nstruct linkinfo_req_info {\n\tstruct ethnl_req_info\t\tbase;\n};\n\nstruct linkinfo_reply_data {\n\tstruct ethnl_reply_data\t\tbase;\n\tstruct ethtool_link_ksettings\tksettings;\n\tstruct ethtool_link_settings\t*lsettings;\n};\n\n#define LINKINFO_REPDATA(__reply_base) \\\n\tcontainer_of(__reply_base, struct linkinfo_reply_data, base)\n\nconst struct nla_policy ethnl_linkinfo_get_policy[] = {\n\t[ETHTOOL_A_LINKINFO_HEADER]\t\t=\n\t\tNLA_POLICY_NESTED(ethnl_header_policy),\n};\n\nstatic int linkinfo_prepare_data(const struct ethnl_req_info *req_base,\n\t\t\t\t struct ethnl_reply_data *reply_base,\n\t\t\t\t const struct genl_info *info)\n{\n\tstruct linkinfo_reply_data *data = LINKINFO_REPDATA(reply_base);\n\tstruct net_device *dev = reply_base->dev;\n\tint ret;\n\n\tdata->lsettings = &data->ksettings.base;\n\n\tret = ethnl_ops_begin(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\tret = __ethtool_get_link_ksettings(dev, &data->ksettings);\n\tif (ret < 0 && info)\n\t\tGENL_SET_ERR_MSG(info, \"failed to retrieve link settings\");\n\tethnl_ops_complete(dev);\n\n\treturn ret;\n}\n\nstatic int linkinfo_reply_size(const struct ethnl_req_info *req_base,\n\t\t\t       const struct ethnl_reply_data *reply_base)\n{\n\treturn nla_total_size(sizeof(u8))  \n\t\t+ nla_total_size(sizeof(u8))  \n\t\t+ nla_total_size(sizeof(u8))  \n\t\t+ nla_total_size(sizeof(u8))  \n\t\t+ nla_total_size(sizeof(u8))  \n\t\t+ 0;\n}\n\nstatic int linkinfo_fill_reply(struct sk_buff *skb,\n\t\t\t       const struct ethnl_req_info *req_base,\n\t\t\t       const struct ethnl_reply_data *reply_base)\n{\n\tconst struct linkinfo_reply_data *data = LINKINFO_REPDATA(reply_base);\n\n\tif (nla_put_u8(skb, ETHTOOL_A_LINKINFO_PORT, data->lsettings->port) ||\n\t    nla_put_u8(skb, ETHTOOL_A_LINKINFO_PHYADDR,\n\t\t       data->lsettings->phy_address) ||\n\t    nla_put_u8(skb, ETHTOOL_A_LINKINFO_TP_MDIX,\n\t\t       data->lsettings->eth_tp_mdix) ||\n\t    nla_put_u8(skb, ETHTOOL_A_LINKINFO_TP_MDIX_CTRL,\n\t\t       data->lsettings->eth_tp_mdix_ctrl) ||\n\t    nla_put_u8(skb, ETHTOOL_A_LINKINFO_TRANSCEIVER,\n\t\t       data->lsettings->transceiver))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\n \n\nconst struct nla_policy ethnl_linkinfo_set_policy[] = {\n\t[ETHTOOL_A_LINKINFO_HEADER]\t\t=\n\t\tNLA_POLICY_NESTED(ethnl_header_policy),\n\t[ETHTOOL_A_LINKINFO_PORT]\t\t= { .type = NLA_U8 },\n\t[ETHTOOL_A_LINKINFO_PHYADDR]\t\t= { .type = NLA_U8 },\n\t[ETHTOOL_A_LINKINFO_TP_MDIX_CTRL]\t= { .type = NLA_U8 },\n};\n\nstatic int\nethnl_set_linkinfo_validate(struct ethnl_req_info *req_info,\n\t\t\t    struct genl_info *info)\n{\n\tconst struct ethtool_ops *ops = req_info->dev->ethtool_ops;\n\n\tif (!ops->get_link_ksettings || !ops->set_link_ksettings)\n\t\treturn -EOPNOTSUPP;\n\treturn 1;\n}\n\nstatic int\nethnl_set_linkinfo(struct ethnl_req_info *req_info, struct genl_info *info)\n{\n\tstruct ethtool_link_ksettings ksettings = {};\n\tstruct ethtool_link_settings *lsettings;\n\tstruct net_device *dev = req_info->dev;\n\tstruct nlattr **tb = info->attrs;\n\tbool mod = false;\n\tint ret;\n\n\tret = __ethtool_get_link_ksettings(dev, &ksettings);\n\tif (ret < 0) {\n\t\tGENL_SET_ERR_MSG(info, \"failed to retrieve link settings\");\n\t\treturn ret;\n\t}\n\tlsettings = &ksettings.base;\n\n\tethnl_update_u8(&lsettings->port, tb[ETHTOOL_A_LINKINFO_PORT], &mod);\n\tethnl_update_u8(&lsettings->phy_address, tb[ETHTOOL_A_LINKINFO_PHYADDR],\n\t\t\t&mod);\n\tethnl_update_u8(&lsettings->eth_tp_mdix_ctrl,\n\t\t\ttb[ETHTOOL_A_LINKINFO_TP_MDIX_CTRL], &mod);\n\tif (!mod)\n\t\treturn 0;\n\n\tret = dev->ethtool_ops->set_link_ksettings(dev, &ksettings);\n\tif (ret < 0) {\n\t\tGENL_SET_ERR_MSG(info, \"link settings update failed\");\n\t\treturn ret;\n\t}\n\n\treturn 1;\n}\n\nconst struct ethnl_request_ops ethnl_linkinfo_request_ops = {\n\t.request_cmd\t\t= ETHTOOL_MSG_LINKINFO_GET,\n\t.reply_cmd\t\t= ETHTOOL_MSG_LINKINFO_GET_REPLY,\n\t.hdr_attr\t\t= ETHTOOL_A_LINKINFO_HEADER,\n\t.req_info_size\t\t= sizeof(struct linkinfo_req_info),\n\t.reply_data_size\t= sizeof(struct linkinfo_reply_data),\n\n\t.prepare_data\t\t= linkinfo_prepare_data,\n\t.reply_size\t\t= linkinfo_reply_size,\n\t.fill_reply\t\t= linkinfo_fill_reply,\n\n\t.set_validate\t\t= ethnl_set_linkinfo_validate,\n\t.set\t\t\t= ethnl_set_linkinfo,\n\t.set_ntf_cmd\t\t= ETHTOOL_MSG_LINKINFO_NTF,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}