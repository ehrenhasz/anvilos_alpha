{
  "module_name": "tsinfo.c",
  "hash_id": "50341af1b17a7f4b2e1ce5d227e024490415110772bb6d718e99f9ddce756b09",
  "original_prompt": "Ingested from linux-6.6.14/net/ethtool/tsinfo.c",
  "human_readable_source": "\n\n#include <linux/net_tstamp.h>\n\n#include \"netlink.h\"\n#include \"common.h\"\n#include \"bitset.h\"\n\nstruct tsinfo_req_info {\n\tstruct ethnl_req_info\t\tbase;\n};\n\nstruct tsinfo_reply_data {\n\tstruct ethnl_reply_data\t\tbase;\n\tstruct ethtool_ts_info\t\tts_info;\n};\n\n#define TSINFO_REPDATA(__reply_base) \\\n\tcontainer_of(__reply_base, struct tsinfo_reply_data, base)\n\nconst struct nla_policy ethnl_tsinfo_get_policy[] = {\n\t[ETHTOOL_A_TSINFO_HEADER]\t\t=\n\t\tNLA_POLICY_NESTED(ethnl_header_policy),\n};\n\nstatic int tsinfo_prepare_data(const struct ethnl_req_info *req_base,\n\t\t\t       struct ethnl_reply_data *reply_base,\n\t\t\t       const struct genl_info *info)\n{\n\tstruct tsinfo_reply_data *data = TSINFO_REPDATA(reply_base);\n\tstruct net_device *dev = reply_base->dev;\n\tint ret;\n\n\tret = ethnl_ops_begin(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\tret = __ethtool_get_ts_info(dev, &data->ts_info);\n\tethnl_ops_complete(dev);\n\n\treturn ret;\n}\n\nstatic int tsinfo_reply_size(const struct ethnl_req_info *req_base,\n\t\t\t     const struct ethnl_reply_data *reply_base)\n{\n\tconst struct tsinfo_reply_data *data = TSINFO_REPDATA(reply_base);\n\tbool compact = req_base->flags & ETHTOOL_FLAG_COMPACT_BITSETS;\n\tconst struct ethtool_ts_info *ts_info = &data->ts_info;\n\tint len = 0;\n\tint ret;\n\n\tBUILD_BUG_ON(__SOF_TIMESTAMPING_CNT > 32);\n\tBUILD_BUG_ON(__HWTSTAMP_TX_CNT > 32);\n\tBUILD_BUG_ON(__HWTSTAMP_FILTER_CNT > 32);\n\n\tif (ts_info->so_timestamping) {\n\t\tret = ethnl_bitset32_size(&ts_info->so_timestamping, NULL,\n\t\t\t\t\t  __SOF_TIMESTAMPING_CNT,\n\t\t\t\t\t  sof_timestamping_names, compact);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen += ret;\t \n\t}\n\tif (ts_info->tx_types) {\n\t\tret = ethnl_bitset32_size(&ts_info->tx_types, NULL,\n\t\t\t\t\t  __HWTSTAMP_TX_CNT,\n\t\t\t\t\t  ts_tx_type_names, compact);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen += ret;\t \n\t}\n\tif (ts_info->rx_filters) {\n\t\tret = ethnl_bitset32_size(&ts_info->rx_filters, NULL,\n\t\t\t\t\t  __HWTSTAMP_FILTER_CNT,\n\t\t\t\t\t  ts_rx_filter_names, compact);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen += ret;\t \n\t}\n\tif (ts_info->phc_index >= 0)\n\t\tlen += nla_total_size(sizeof(u32));\t \n\n\treturn len;\n}\n\nstatic int tsinfo_fill_reply(struct sk_buff *skb,\n\t\t\t     const struct ethnl_req_info *req_base,\n\t\t\t     const struct ethnl_reply_data *reply_base)\n{\n\tconst struct tsinfo_reply_data *data = TSINFO_REPDATA(reply_base);\n\tbool compact = req_base->flags & ETHTOOL_FLAG_COMPACT_BITSETS;\n\tconst struct ethtool_ts_info *ts_info = &data->ts_info;\n\tint ret;\n\n\tif (ts_info->so_timestamping) {\n\t\tret = ethnl_put_bitset32(skb, ETHTOOL_A_TSINFO_TIMESTAMPING,\n\t\t\t\t\t &ts_info->so_timestamping, NULL,\n\t\t\t\t\t __SOF_TIMESTAMPING_CNT,\n\t\t\t\t\t sof_timestamping_names, compact);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\tif (ts_info->tx_types) {\n\t\tret = ethnl_put_bitset32(skb, ETHTOOL_A_TSINFO_TX_TYPES,\n\t\t\t\t\t &ts_info->tx_types, NULL,\n\t\t\t\t\t __HWTSTAMP_TX_CNT,\n\t\t\t\t\t ts_tx_type_names, compact);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\tif (ts_info->rx_filters) {\n\t\tret = ethnl_put_bitset32(skb, ETHTOOL_A_TSINFO_RX_FILTERS,\n\t\t\t\t\t &ts_info->rx_filters, NULL,\n\t\t\t\t\t __HWTSTAMP_FILTER_CNT,\n\t\t\t\t\t ts_rx_filter_names, compact);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\tif (ts_info->phc_index >= 0 &&\n\t    nla_put_u32(skb, ETHTOOL_A_TSINFO_PHC_INDEX, ts_info->phc_index))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nconst struct ethnl_request_ops ethnl_tsinfo_request_ops = {\n\t.request_cmd\t\t= ETHTOOL_MSG_TSINFO_GET,\n\t.reply_cmd\t\t= ETHTOOL_MSG_TSINFO_GET_REPLY,\n\t.hdr_attr\t\t= ETHTOOL_A_TSINFO_HEADER,\n\t.req_info_size\t\t= sizeof(struct tsinfo_req_info),\n\t.reply_data_size\t= sizeof(struct tsinfo_reply_data),\n\n\t.prepare_data\t\t= tsinfo_prepare_data,\n\t.reply_size\t\t= tsinfo_reply_size,\n\t.fill_reply\t\t= tsinfo_fill_reply,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}