{
  "module_name": "ccid2.c",
  "hash_id": "b8a8548d3b5c8347ddf55474b81bc328f66b17c6c87cc8aa6112c11472b7fc0e",
  "original_prompt": "Ingested from linux-6.6.14/net/dccp/ccids/ccid2.c",
  "human_readable_source": "\n \n\n \n#include <linux/slab.h>\n#include \"../feat.h\"\n#include \"ccid2.h\"\n\n\n#ifdef CONFIG_IP_DCCP_CCID2_DEBUG\nstatic bool ccid2_debug;\n#define ccid2_pr_debug(format, a...)\tDCCP_PR_DEBUG(ccid2_debug, format, ##a)\n#else\n#define ccid2_pr_debug(format, a...)\n#endif\n\nstatic int ccid2_hc_tx_alloc_seq(struct ccid2_hc_tx_sock *hc)\n{\n\tstruct ccid2_seq *seqp;\n\tint i;\n\n\t \n\tif (hc->tx_seqbufc >= (sizeof(hc->tx_seqbuf) /\n\t\t\t       sizeof(struct ccid2_seq *)))\n\t\treturn -ENOMEM;\n\n\t \n\tseqp = kmalloc_array(CCID2_SEQBUF_LEN, sizeof(struct ccid2_seq),\n\t\t\t     gfp_any());\n\tif (seqp == NULL)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < (CCID2_SEQBUF_LEN - 1); i++) {\n\t\tseqp[i].ccid2s_next = &seqp[i + 1];\n\t\tseqp[i + 1].ccid2s_prev = &seqp[i];\n\t}\n\tseqp[CCID2_SEQBUF_LEN - 1].ccid2s_next = seqp;\n\tseqp->ccid2s_prev = &seqp[CCID2_SEQBUF_LEN - 1];\n\n\t \n\tif (hc->tx_seqbufc == 0)\n\t\thc->tx_seqh = hc->tx_seqt = seqp;\n\telse {\n\t\t \n\t\thc->tx_seqh->ccid2s_next = seqp;\n\t\tseqp->ccid2s_prev = hc->tx_seqh;\n\n\t\thc->tx_seqt->ccid2s_prev = &seqp[CCID2_SEQBUF_LEN - 1];\n\t\tseqp[CCID2_SEQBUF_LEN - 1].ccid2s_next = hc->tx_seqt;\n\t}\n\n\t \n\thc->tx_seqbuf[hc->tx_seqbufc] = seqp;\n\thc->tx_seqbufc++;\n\n\treturn 0;\n}\n\nstatic int ccid2_hc_tx_send_packet(struct sock *sk, struct sk_buff *skb)\n{\n\tif (ccid2_cwnd_network_limited(ccid2_hc_tx_sk(sk)))\n\t\treturn CCID_PACKET_WILL_DEQUEUE_LATER;\n\treturn CCID_PACKET_SEND_AT_ONCE;\n}\n\nstatic void ccid2_change_l_ack_ratio(struct sock *sk, u32 val)\n{\n\tu32 max_ratio = DIV_ROUND_UP(ccid2_hc_tx_sk(sk)->tx_cwnd, 2);\n\n\t \n\tif (val == 0 || val > max_ratio) {\n\t\tDCCP_WARN(\"Limiting Ack Ratio (%u) to %u\\n\", val, max_ratio);\n\t\tval = max_ratio;\n\t}\n\tdccp_feat_signal_nn_change(sk, DCCPF_ACK_RATIO,\n\t\t\t\t   min_t(u32, val, DCCPF_ACK_RATIO_MAX));\n}\n\nstatic void ccid2_check_l_ack_ratio(struct sock *sk)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\n\t \n\tif (dccp_feat_nn_get(sk, DCCPF_ACK_RATIO) > hc->tx_cwnd)\n\t\tccid2_change_l_ack_ratio(sk, hc->tx_cwnd/2 ? : 1U);\n}\n\nstatic void ccid2_change_l_seq_window(struct sock *sk, u64 val)\n{\n\tdccp_feat_signal_nn_change(sk, DCCPF_SEQUENCE_WINDOW,\n\t\t\t\t   clamp_val(val, DCCPF_SEQ_WMIN,\n\t\t\t\t\t\t  DCCPF_SEQ_WMAX));\n}\n\nstatic void dccp_tasklet_schedule(struct sock *sk)\n{\n\tstruct tasklet_struct *t = &dccp_sk(sk)->dccps_xmitlet;\n\n\tif (!test_and_set_bit(TASKLET_STATE_SCHED, &t->state)) {\n\t\tsock_hold(sk);\n\t\t__tasklet_schedule(t);\n\t}\n}\n\nstatic void ccid2_hc_tx_rto_expire(struct timer_list *t)\n{\n\tstruct ccid2_hc_tx_sock *hc = from_timer(hc, t, tx_rtotimer);\n\tstruct sock *sk = hc->sk;\n\tconst bool sender_was_blocked = ccid2_cwnd_network_limited(hc);\n\n\tbh_lock_sock(sk);\n\tif (sock_owned_by_user(sk)) {\n\t\tsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + HZ / 5);\n\t\tgoto out;\n\t}\n\n\tccid2_pr_debug(\"RTO_EXPIRE\\n\");\n\n\tif (sk->sk_state == DCCP_CLOSED)\n\t\tgoto out;\n\n\t \n\thc->tx_rto <<= 1;\n\tif (hc->tx_rto > DCCP_RTO_MAX)\n\t\thc->tx_rto = DCCP_RTO_MAX;\n\n\t \n\thc->tx_ssthresh = hc->tx_cwnd / 2;\n\tif (hc->tx_ssthresh < 2)\n\t\thc->tx_ssthresh = 2;\n\thc->tx_cwnd\t= 1;\n\thc->tx_pipe\t= 0;\n\n\t \n\thc->tx_seqt = hc->tx_seqh;\n\thc->tx_packets_acked = 0;\n\n\t \n\thc->tx_rpseq    = 0;\n\thc->tx_rpdupack = -1;\n\tccid2_change_l_ack_ratio(sk, 1);\n\n\t \n\tif (sender_was_blocked)\n\t\tdccp_tasklet_schedule(sk);\n\t \n\tsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + hc->tx_rto);\nout:\n\tbh_unlock_sock(sk);\n\tsock_put(sk);\n}\n\n \nstatic bool ccid2_do_cwv = true;\nmodule_param(ccid2_do_cwv, bool, 0644);\nMODULE_PARM_DESC(ccid2_do_cwv, \"Perform RFC2861 Congestion Window Validation\");\n\n \nstatic void ccid2_update_used_window(struct ccid2_hc_tx_sock *hc, u32 new_wnd)\n{\n\thc->tx_expected_wnd = (3 * hc->tx_expected_wnd + new_wnd) / 4;\n}\n\n \nstatic void ccid2_cwnd_application_limited(struct sock *sk, const u32 now)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\t \n\tu32 init_win = rfc3390_bytes_to_packets(dccp_sk(sk)->dccps_mss_cache),\n\t    win_used = max(hc->tx_cwnd_used, init_win);\n\n\tif (win_used < hc->tx_cwnd) {\n\t\thc->tx_ssthresh = max(hc->tx_ssthresh,\n\t\t\t\t     (hc->tx_cwnd >> 1) + (hc->tx_cwnd >> 2));\n\t\thc->tx_cwnd = (hc->tx_cwnd + win_used) >> 1;\n\t}\n\thc->tx_cwnd_used  = 0;\n\thc->tx_cwnd_stamp = now;\n\n\tccid2_check_l_ack_ratio(sk);\n}\n\n \nstatic void ccid2_cwnd_restart(struct sock *sk, const u32 now)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\tu32 cwnd = hc->tx_cwnd, restart_cwnd,\n\t    iwnd = rfc3390_bytes_to_packets(dccp_sk(sk)->dccps_mss_cache);\n\ts32 delta = now - hc->tx_lsndtime;\n\n\thc->tx_ssthresh = max(hc->tx_ssthresh, (cwnd >> 1) + (cwnd >> 2));\n\n\t \n\trestart_cwnd = min(cwnd, iwnd);\n\n\twhile ((delta -= hc->tx_rto) >= 0 && cwnd > restart_cwnd)\n\t\tcwnd >>= 1;\n\thc->tx_cwnd = max(cwnd, restart_cwnd);\n\thc->tx_cwnd_stamp = now;\n\thc->tx_cwnd_used  = 0;\n\n\tccid2_check_l_ack_ratio(sk);\n}\n\nstatic void ccid2_hc_tx_packet_sent(struct sock *sk, unsigned int len)\n{\n\tstruct dccp_sock *dp = dccp_sk(sk);\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\tconst u32 now = ccid2_jiffies32;\n\tstruct ccid2_seq *next;\n\n\t \n\tif (ccid2_do_cwv && !hc->tx_pipe &&\n\t    (s32)(now - hc->tx_lsndtime) >= hc->tx_rto)\n\t\tccid2_cwnd_restart(sk, now);\n\n\thc->tx_lsndtime = now;\n\thc->tx_pipe    += 1;\n\n\t \n\tif (ccid2_cwnd_network_limited(hc)) {\n\t\tccid2_update_used_window(hc, hc->tx_cwnd);\n\t\thc->tx_cwnd_used  = 0;\n\t\thc->tx_cwnd_stamp = now;\n\t} else {\n\t\tif (hc->tx_pipe > hc->tx_cwnd_used)\n\t\t\thc->tx_cwnd_used = hc->tx_pipe;\n\n\t\tccid2_update_used_window(hc, hc->tx_cwnd_used);\n\n\t\tif (ccid2_do_cwv && (s32)(now - hc->tx_cwnd_stamp) >= hc->tx_rto)\n\t\t\tccid2_cwnd_application_limited(sk, now);\n\t}\n\n\thc->tx_seqh->ccid2s_seq   = dp->dccps_gss;\n\thc->tx_seqh->ccid2s_acked = 0;\n\thc->tx_seqh->ccid2s_sent  = now;\n\n\tnext = hc->tx_seqh->ccid2s_next;\n\t \n\tif (next == hc->tx_seqt) {\n\t\tif (ccid2_hc_tx_alloc_seq(hc)) {\n\t\t\tDCCP_CRIT(\"packet history - out of memory!\");\n\t\t\t \n\t\t\treturn;\n\t\t}\n\t\tnext = hc->tx_seqh->ccid2s_next;\n\t\tBUG_ON(next == hc->tx_seqt);\n\t}\n\thc->tx_seqh = next;\n\n\tccid2_pr_debug(\"cwnd=%d pipe=%d\\n\", hc->tx_cwnd, hc->tx_pipe);\n\n\t \n#if 0\n\t \n\thc->tx_arsent++;\n\t \n\tif (hc->tx_ackloss) {\n\t\tif (hc->tx_arsent >= hc->tx_cwnd) {\n\t\t\thc->tx_arsent  = 0;\n\t\t\thc->tx_ackloss = 0;\n\t\t}\n\t} else {\n\t\t \n\t\t \n\t\tif (dp->dccps_l_ack_ratio > 1) {\n\t\t\t \n\t\t\tint denom = dp->dccps_l_ack_ratio * dp->dccps_l_ack_ratio -\n\t\t\t\t    dp->dccps_l_ack_ratio;\n\n\t\t\tdenom = hc->tx_cwnd * hc->tx_cwnd / denom;\n\n\t\t\tif (hc->tx_arsent >= denom) {\n\t\t\t\tccid2_change_l_ack_ratio(sk, dp->dccps_l_ack_ratio - 1);\n\t\t\t\thc->tx_arsent = 0;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\thc->tx_arsent = 0;  \n\t\t}\n\t}\n#endif\n\n\tsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + hc->tx_rto);\n\n#ifdef CONFIG_IP_DCCP_CCID2_DEBUG\n\tdo {\n\t\tstruct ccid2_seq *seqp = hc->tx_seqt;\n\n\t\twhile (seqp != hc->tx_seqh) {\n\t\t\tccid2_pr_debug(\"out seq=%llu acked=%d time=%u\\n\",\n\t\t\t\t       (unsigned long long)seqp->ccid2s_seq,\n\t\t\t\t       seqp->ccid2s_acked, seqp->ccid2s_sent);\n\t\t\tseqp = seqp->ccid2s_next;\n\t\t}\n\t} while (0);\n\tccid2_pr_debug(\"=========\\n\");\n#endif\n}\n\n \nstatic void ccid2_rtt_estimator(struct sock *sk, const long mrtt)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\tlong m = mrtt ? : 1;\n\n\tif (hc->tx_srtt == 0) {\n\t\t \n\t\thc->tx_srtt = m << 3;\n\t\thc->tx_mdev = m << 1;\n\n\t\thc->tx_mdev_max = max(hc->tx_mdev, tcp_rto_min(sk));\n\t\thc->tx_rttvar   = hc->tx_mdev_max;\n\n\t\thc->tx_rtt_seq  = dccp_sk(sk)->dccps_gss;\n\t} else {\n\t\t \n\t\tm -= (hc->tx_srtt >> 3);\n\t\thc->tx_srtt += m;\n\n\t\t \n\t\tif (m < 0) {\n\t\t\tm = -m;\n\t\t\tm -= (hc->tx_mdev >> 2);\n\t\t\t \n\t\t\tif (m > 0)\n\t\t\t\tm >>= 3;\n\t\t} else {\n\t\t\tm -= (hc->tx_mdev >> 2);\n\t\t}\n\t\thc->tx_mdev += m;\n\n\t\tif (hc->tx_mdev > hc->tx_mdev_max) {\n\t\t\thc->tx_mdev_max = hc->tx_mdev;\n\t\t\tif (hc->tx_mdev_max > hc->tx_rttvar)\n\t\t\t\thc->tx_rttvar = hc->tx_mdev_max;\n\t\t}\n\n\t\t \n\t\tif (after48(dccp_sk(sk)->dccps_gar, hc->tx_rtt_seq)) {\n\t\t\tif (hc->tx_mdev_max < hc->tx_rttvar)\n\t\t\t\thc->tx_rttvar -= (hc->tx_rttvar -\n\t\t\t\t\t\t  hc->tx_mdev_max) >> 2;\n\t\t\thc->tx_rtt_seq  = dccp_sk(sk)->dccps_gss;\n\t\t\thc->tx_mdev_max = tcp_rto_min(sk);\n\t\t}\n\t}\n\n\t \n\thc->tx_rto = (hc->tx_srtt >> 3) + hc->tx_rttvar;\n\n\tif (hc->tx_rto > DCCP_RTO_MAX)\n\t\thc->tx_rto = DCCP_RTO_MAX;\n}\n\nstatic void ccid2_new_ack(struct sock *sk, struct ccid2_seq *seqp,\n\t\t\t  unsigned int *maxincr)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\tstruct dccp_sock *dp = dccp_sk(sk);\n\tint r_seq_used = hc->tx_cwnd / dp->dccps_l_ack_ratio;\n\n\tif (hc->tx_cwnd < dp->dccps_l_seq_win &&\n\t    r_seq_used < dp->dccps_r_seq_win) {\n\t\tif (hc->tx_cwnd < hc->tx_ssthresh) {\n\t\t\tif (*maxincr > 0 && ++hc->tx_packets_acked >= 2) {\n\t\t\t\thc->tx_cwnd += 1;\n\t\t\t\t*maxincr    -= 1;\n\t\t\t\thc->tx_packets_acked = 0;\n\t\t\t}\n\t\t} else if (++hc->tx_packets_acked >= hc->tx_cwnd) {\n\t\t\thc->tx_cwnd += 1;\n\t\t\thc->tx_packets_acked = 0;\n\t\t}\n\t}\n\n\t \n\tif (r_seq_used * CCID2_WIN_CHANGE_FACTOR >= dp->dccps_r_seq_win)\n\t\tccid2_change_l_ack_ratio(sk, dp->dccps_l_ack_ratio * 2);\n\telse if (r_seq_used * CCID2_WIN_CHANGE_FACTOR < dp->dccps_r_seq_win/2)\n\t\tccid2_change_l_ack_ratio(sk, dp->dccps_l_ack_ratio / 2 ? : 1U);\n\n\tif (hc->tx_cwnd * CCID2_WIN_CHANGE_FACTOR >= dp->dccps_l_seq_win)\n\t\tccid2_change_l_seq_window(sk, dp->dccps_l_seq_win * 2);\n\telse if (hc->tx_cwnd * CCID2_WIN_CHANGE_FACTOR < dp->dccps_l_seq_win/2)\n\t\tccid2_change_l_seq_window(sk, dp->dccps_l_seq_win / 2);\n\n\t \n\tccid2_rtt_estimator(sk, ccid2_jiffies32 - seqp->ccid2s_sent);\n}\n\nstatic void ccid2_congestion_event(struct sock *sk, struct ccid2_seq *seqp)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\n\tif ((s32)(seqp->ccid2s_sent - hc->tx_last_cong) < 0) {\n\t\tccid2_pr_debug(\"Multiple losses in an RTT---treating as one\\n\");\n\t\treturn;\n\t}\n\n\thc->tx_last_cong = ccid2_jiffies32;\n\n\thc->tx_cwnd      = hc->tx_cwnd / 2 ? : 1U;\n\thc->tx_ssthresh  = max(hc->tx_cwnd, 2U);\n\n\tccid2_check_l_ack_ratio(sk);\n}\n\nstatic int ccid2_hc_tx_parse_options(struct sock *sk, u8 packet_type,\n\t\t\t\t     u8 option, u8 *optval, u8 optlen)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\n\tswitch (option) {\n\tcase DCCPO_ACK_VECTOR_0:\n\tcase DCCPO_ACK_VECTOR_1:\n\t\treturn dccp_ackvec_parsed_add(&hc->tx_av_chunks, optval, optlen,\n\t\t\t\t\t      option - DCCPO_ACK_VECTOR_0);\n\t}\n\treturn 0;\n}\n\nstatic void ccid2_hc_tx_packet_recv(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct dccp_sock *dp = dccp_sk(sk);\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\tconst bool sender_was_blocked = ccid2_cwnd_network_limited(hc);\n\tstruct dccp_ackvec_parsed *avp;\n\tu64 ackno, seqno;\n\tstruct ccid2_seq *seqp;\n\tint done = 0;\n\tunsigned int maxincr = 0;\n\n\t \n\tseqno = DCCP_SKB_CB(skb)->dccpd_seq;\n\n\t \n\t \n\tif (hc->tx_rpdupack == -1) {\n\t\thc->tx_rpdupack = 0;\n\t\thc->tx_rpseq    = seqno;\n\t} else {\n\t\t \n\t\tif (dccp_delta_seqno(hc->tx_rpseq, seqno) == 1)\n\t\t\thc->tx_rpseq = seqno;\n\t\t \n\t\telse if (after48(seqno, hc->tx_rpseq)) {\n\t\t\thc->tx_rpdupack++;\n\n\t\t\t \n\t\t\tif (hc->tx_rpdupack >= NUMDUPACK) {\n\t\t\t\thc->tx_rpdupack = -1;  \n\t\t\t\thc->tx_rpseq    = 0;\n#ifdef __CCID2_COPES_GRACEFULLY_WITH_ACK_CONGESTION_CONTROL__\n\t\t\t\t \n\t\t\t\tccid2_change_l_ack_ratio(sk, 2 * dp->dccps_l_ack_ratio);\n#endif\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tif (dccp_packet_without_ack(skb))\n\t\treturn;\n\n\t \n\tif (hc->tx_seqh == hc->tx_seqt)\n\t\tgoto done;\n\n\tackno = DCCP_SKB_CB(skb)->dccpd_ack_seq;\n\tif (after48(ackno, hc->tx_high_ack))\n\t\thc->tx_high_ack = ackno;\n\n\tseqp = hc->tx_seqt;\n\twhile (before48(seqp->ccid2s_seq, ackno)) {\n\t\tseqp = seqp->ccid2s_next;\n\t\tif (seqp == hc->tx_seqh) {\n\t\t\tseqp = hc->tx_seqh->ccid2s_prev;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tif (hc->tx_cwnd < hc->tx_ssthresh)\n\t\tmaxincr = DIV_ROUND_UP(dp->dccps_l_ack_ratio, 2);\n\n\t \n\tlist_for_each_entry(avp, &hc->tx_av_chunks, node) {\n\t\t \n\t\tfor (; avp->len--; avp->vec++) {\n\t\t\tu64 ackno_end_rl = SUB48(ackno,\n\t\t\t\t\t\t dccp_ackvec_runlen(avp->vec));\n\n\t\t\tccid2_pr_debug(\"ackvec %llu |%u,%u|\\n\",\n\t\t\t\t       (unsigned long long)ackno,\n\t\t\t\t       dccp_ackvec_state(avp->vec) >> 6,\n\t\t\t\t       dccp_ackvec_runlen(avp->vec));\n\t\t\t \n\t\t\twhile (after48(seqp->ccid2s_seq, ackno)) {\n\t\t\t\tif (seqp == hc->tx_seqt) {\n\t\t\t\t\tdone = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tseqp = seqp->ccid2s_prev;\n\t\t\t}\n\t\t\tif (done)\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\twhile (between48(seqp->ccid2s_seq,ackno_end_rl,ackno)) {\n\t\t\t\tconst u8 state = dccp_ackvec_state(avp->vec);\n\n\t\t\t\t \n\t\t\t\tif (state != DCCPAV_NOT_RECEIVED &&\n\t\t\t\t    !seqp->ccid2s_acked) {\n\t\t\t\t\tif (state == DCCPAV_ECN_MARKED)\n\t\t\t\t\t\tccid2_congestion_event(sk,\n\t\t\t\t\t\t\t\t       seqp);\n\t\t\t\t\telse\n\t\t\t\t\t\tccid2_new_ack(sk, seqp,\n\t\t\t\t\t\t\t      &maxincr);\n\n\t\t\t\t\tseqp->ccid2s_acked = 1;\n\t\t\t\t\tccid2_pr_debug(\"Got ack for %llu\\n\",\n\t\t\t\t\t\t       (unsigned long long)seqp->ccid2s_seq);\n\t\t\t\t\thc->tx_pipe--;\n\t\t\t\t}\n\t\t\t\tif (seqp == hc->tx_seqt) {\n\t\t\t\t\tdone = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tseqp = seqp->ccid2s_prev;\n\t\t\t}\n\t\t\tif (done)\n\t\t\t\tbreak;\n\n\t\t\tackno = SUB48(ackno_end_rl, 1);\n\t\t}\n\t\tif (done)\n\t\t\tbreak;\n\t}\n\n\t \n\tseqp = hc->tx_seqt;\n\twhile (before48(seqp->ccid2s_seq, hc->tx_high_ack)) {\n\t\tseqp = seqp->ccid2s_next;\n\t\tif (seqp == hc->tx_seqh) {\n\t\t\tseqp = hc->tx_seqh->ccid2s_prev;\n\t\t\tbreak;\n\t\t}\n\t}\n\tdone = 0;\n\twhile (1) {\n\t\tif (seqp->ccid2s_acked) {\n\t\t\tdone++;\n\t\t\tif (done == NUMDUPACK)\n\t\t\t\tbreak;\n\t\t}\n\t\tif (seqp == hc->tx_seqt)\n\t\t\tbreak;\n\t\tseqp = seqp->ccid2s_prev;\n\t}\n\n\t \n\tif (done == NUMDUPACK) {\n\t\tstruct ccid2_seq *last_acked = seqp;\n\n\t\t \n\t\twhile (1) {\n\t\t\tif (!seqp->ccid2s_acked) {\n\t\t\t\tccid2_pr_debug(\"Packet lost: %llu\\n\",\n\t\t\t\t\t       (unsigned long long)seqp->ccid2s_seq);\n\t\t\t\t \n\t\t\t\tccid2_congestion_event(sk, seqp);\n\t\t\t\thc->tx_pipe--;\n\t\t\t}\n\t\t\tif (seqp == hc->tx_seqt)\n\t\t\t\tbreak;\n\t\t\tseqp = seqp->ccid2s_prev;\n\t\t}\n\n\t\thc->tx_seqt = last_acked;\n\t}\n\n\t \n\twhile (hc->tx_seqt != hc->tx_seqh) {\n\t\tif (!hc->tx_seqt->ccid2s_acked)\n\t\t\tbreak;\n\n\t\thc->tx_seqt = hc->tx_seqt->ccid2s_next;\n\t}\n\n\t \n\tif (hc->tx_pipe == 0)\n\t\tsk_stop_timer(sk, &hc->tx_rtotimer);\n\telse\n\t\tsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + hc->tx_rto);\ndone:\n\t \n\tif (sender_was_blocked && !ccid2_cwnd_network_limited(hc))\n\t\tdccp_tasklet_schedule(sk);\n\tdccp_ackvec_parsed_cleanup(&hc->tx_av_chunks);\n}\n\nstatic int ccid2_hc_tx_init(struct ccid *ccid, struct sock *sk)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid_priv(ccid);\n\tstruct dccp_sock *dp = dccp_sk(sk);\n\tu32 max_ratio;\n\n\t \n\thc->tx_ssthresh = ~0U;\n\n\t \n\thc->tx_cwnd = rfc3390_bytes_to_packets(dp->dccps_mss_cache);\n\thc->tx_expected_wnd = hc->tx_cwnd;\n\n\t \n\tmax_ratio = DIV_ROUND_UP(hc->tx_cwnd, 2);\n\tif (dp->dccps_l_ack_ratio == 0 || dp->dccps_l_ack_ratio > max_ratio)\n\t\tdp->dccps_l_ack_ratio = max_ratio;\n\n\t \n\tif (ccid2_hc_tx_alloc_seq(hc))\n\t\treturn -ENOMEM;\n\n\thc->tx_rto\t = DCCP_TIMEOUT_INIT;\n\thc->tx_rpdupack  = -1;\n\thc->tx_last_cong = hc->tx_lsndtime = hc->tx_cwnd_stamp = ccid2_jiffies32;\n\thc->tx_cwnd_used = 0;\n\thc->sk\t\t = sk;\n\ttimer_setup(&hc->tx_rtotimer, ccid2_hc_tx_rto_expire, 0);\n\tINIT_LIST_HEAD(&hc->tx_av_chunks);\n\treturn 0;\n}\n\nstatic void ccid2_hc_tx_exit(struct sock *sk)\n{\n\tstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\n\tint i;\n\n\tsk_stop_timer(sk, &hc->tx_rtotimer);\n\n\tfor (i = 0; i < hc->tx_seqbufc; i++)\n\t\tkfree(hc->tx_seqbuf[i]);\n\thc->tx_seqbufc = 0;\n\tdccp_ackvec_parsed_cleanup(&hc->tx_av_chunks);\n}\n\nstatic void ccid2_hc_rx_packet_recv(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct ccid2_hc_rx_sock *hc = ccid2_hc_rx_sk(sk);\n\n\tif (!dccp_data_packet(skb))\n\t\treturn;\n\n\tif (++hc->rx_num_data_pkts >= dccp_sk(sk)->dccps_r_ack_ratio) {\n\t\tdccp_send_ack(sk);\n\t\thc->rx_num_data_pkts = 0;\n\t}\n}\n\nstruct ccid_operations ccid2_ops = {\n\t.ccid_id\t\t  = DCCPC_CCID2,\n\t.ccid_name\t\t  = \"TCP-like\",\n\t.ccid_hc_tx_obj_size\t  = sizeof(struct ccid2_hc_tx_sock),\n\t.ccid_hc_tx_init\t  = ccid2_hc_tx_init,\n\t.ccid_hc_tx_exit\t  = ccid2_hc_tx_exit,\n\t.ccid_hc_tx_send_packet\t  = ccid2_hc_tx_send_packet,\n\t.ccid_hc_tx_packet_sent\t  = ccid2_hc_tx_packet_sent,\n\t.ccid_hc_tx_parse_options = ccid2_hc_tx_parse_options,\n\t.ccid_hc_tx_packet_recv\t  = ccid2_hc_tx_packet_recv,\n\t.ccid_hc_rx_obj_size\t  = sizeof(struct ccid2_hc_rx_sock),\n\t.ccid_hc_rx_packet_recv\t  = ccid2_hc_rx_packet_recv,\n};\n\n#ifdef CONFIG_IP_DCCP_CCID2_DEBUG\nmodule_param(ccid2_debug, bool, 0644);\nMODULE_PARM_DESC(ccid2_debug, \"Enable CCID-2 debug messages\");\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}