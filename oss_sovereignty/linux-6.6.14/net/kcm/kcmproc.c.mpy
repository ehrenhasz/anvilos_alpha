{
  "module_name": "kcmproc.c",
  "hash_id": "3bdfc7216cae553e720dc9d71fcdb100e4a7b5fefd61e59b45d79cef6a392f9f",
  "original_prompt": "Ingested from linux-6.6.14/net/kcm/kcmproc.c",
  "human_readable_source": "\n#include <linux/in.h>\n#include <linux/inet.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/net.h>\n#include <linux/proc_fs.h>\n#include <linux/rculist.h>\n#include <linux/seq_file.h>\n#include <linux/socket.h>\n#include <net/inet_sock.h>\n#include <net/kcm.h>\n#include <net/net_namespace.h>\n#include <net/netns/generic.h>\n#include <net/tcp.h>\n\n#ifdef CONFIG_PROC_FS\nstatic struct kcm_mux *kcm_get_first(struct seq_file *seq)\n{\n\tstruct net *net = seq_file_net(seq);\n\tstruct kcm_net *knet = net_generic(net, kcm_net_id);\n\n\treturn list_first_or_null_rcu(&knet->mux_list,\n\t\t\t\t      struct kcm_mux, kcm_mux_list);\n}\n\nstatic struct kcm_mux *kcm_get_next(struct kcm_mux *mux)\n{\n\tstruct kcm_net *knet = mux->knet;\n\n\treturn list_next_or_null_rcu(&knet->mux_list, &mux->kcm_mux_list,\n\t\t\t\t     struct kcm_mux, kcm_mux_list);\n}\n\nstatic struct kcm_mux *kcm_get_idx(struct seq_file *seq, loff_t pos)\n{\n\tstruct net *net = seq_file_net(seq);\n\tstruct kcm_net *knet = net_generic(net, kcm_net_id);\n\tstruct kcm_mux *m;\n\n\tlist_for_each_entry_rcu(m, &knet->mux_list, kcm_mux_list) {\n\t\tif (!pos)\n\t\t\treturn m;\n\t\t--pos;\n\t}\n\treturn NULL;\n}\n\nstatic void *kcm_seq_next(struct seq_file *seq, void *v, loff_t *pos)\n{\n\tvoid *p;\n\n\tif (v == SEQ_START_TOKEN)\n\t\tp = kcm_get_first(seq);\n\telse\n\t\tp = kcm_get_next(v);\n\t++*pos;\n\treturn p;\n}\n\nstatic void *kcm_seq_start(struct seq_file *seq, loff_t *pos)\n\t__acquires(rcu)\n{\n\trcu_read_lock();\n\n\tif (!*pos)\n\t\treturn SEQ_START_TOKEN;\n\telse\n\t\treturn kcm_get_idx(seq, *pos - 1);\n}\n\nstatic void kcm_seq_stop(struct seq_file *seq, void *v)\n\t__releases(rcu)\n{\n\trcu_read_unlock();\n}\n\nstruct kcm_proc_mux_state {\n\tstruct seq_net_private p;\n\tint idx;\n};\n\nstatic void kcm_format_mux_header(struct seq_file *seq)\n{\n\tstruct net *net = seq_file_net(seq);\n\tstruct kcm_net *knet = net_generic(net, kcm_net_id);\n\n\tseq_printf(seq,\n\t\t   \"*** KCM statistics (%d MUX) ****\\n\",\n\t\t   knet->count);\n\n\tseq_printf(seq,\n\t\t   \"%-14s %-10s %-16s %-10s %-16s %-8s %-8s %-8s %-8s %s\",\n\t\t   \"Object\",\n\t\t   \"RX-Msgs\",\n\t\t   \"RX-Bytes\",\n\t\t   \"TX-Msgs\",\n\t\t   \"TX-Bytes\",\n\t\t   \"Recv-Q\",\n\t\t   \"Rmem\",\n\t\t   \"Send-Q\",\n\t\t   \"Smem\",\n\t\t   \"Status\");\n\n\t \n\tseq_puts(seq, \"\\n\");\n}\n\nstatic void kcm_format_sock(struct kcm_sock *kcm, struct seq_file *seq,\n\t\t\t    int i, int *len)\n{\n\tseq_printf(seq,\n\t\t   \"   kcm-%-7u %-10llu %-16llu %-10llu %-16llu %-8d %-8d %-8d %-8s \",\n\t\t   kcm->index,\n\t\t   kcm->stats.rx_msgs,\n\t\t   kcm->stats.rx_bytes,\n\t\t   kcm->stats.tx_msgs,\n\t\t   kcm->stats.tx_bytes,\n\t\t   kcm->sk.sk_receive_queue.qlen,\n\t\t   sk_rmem_alloc_get(&kcm->sk),\n\t\t   kcm->sk.sk_write_queue.qlen,\n\t\t   \"-\");\n\n\tif (kcm->tx_psock)\n\t\tseq_printf(seq, \"Psck-%u \", kcm->tx_psock->index);\n\n\tif (kcm->tx_wait)\n\t\tseq_puts(seq, \"TxWait \");\n\n\tif (kcm->tx_wait_more)\n\t\tseq_puts(seq, \"WMore \");\n\n\tif (kcm->rx_wait)\n\t\tseq_puts(seq, \"RxWait \");\n\n\tseq_puts(seq, \"\\n\");\n}\n\nstatic void kcm_format_psock(struct kcm_psock *psock, struct seq_file *seq,\n\t\t\t     int i, int *len)\n{\n\tseq_printf(seq,\n\t\t   \"   psock-%-5u %-10llu %-16llu %-10llu %-16llu %-8d %-8d %-8d %-8d \",\n\t\t   psock->index,\n\t\t   psock->strp.stats.msgs,\n\t\t   psock->strp.stats.bytes,\n\t\t   psock->stats.tx_msgs,\n\t\t   psock->stats.tx_bytes,\n\t\t   psock->sk->sk_receive_queue.qlen,\n\t\t   atomic_read(&psock->sk->sk_rmem_alloc),\n\t\t   psock->sk->sk_write_queue.qlen,\n\t\t   refcount_read(&psock->sk->sk_wmem_alloc));\n\n\tif (psock->done)\n\t\tseq_puts(seq, \"Done \");\n\n\tif (psock->tx_stopped)\n\t\tseq_puts(seq, \"TxStop \");\n\n\tif (psock->strp.stopped)\n\t\tseq_puts(seq, \"RxStop \");\n\n\tif (psock->tx_kcm)\n\t\tseq_printf(seq, \"Rsvd-%d \", psock->tx_kcm->index);\n\n\tif (!psock->strp.paused && !psock->ready_rx_msg) {\n\t\tif (psock->sk->sk_receive_queue.qlen) {\n\t\t\tif (psock->strp.need_bytes)\n\t\t\t\tseq_printf(seq, \"RxWait=%u \",\n\t\t\t\t\t   psock->strp.need_bytes);\n\t\t\telse\n\t\t\t\tseq_printf(seq, \"RxWait \");\n\t\t}\n\t} else  {\n\t\tif (psock->strp.paused)\n\t\t\tseq_puts(seq, \"RxPause \");\n\n\t\tif (psock->ready_rx_msg)\n\t\t\tseq_puts(seq, \"RdyRx \");\n\t}\n\n\tseq_puts(seq, \"\\n\");\n}\n\nstatic void\nkcm_format_mux(struct kcm_mux *mux, loff_t idx, struct seq_file *seq)\n{\n\tint i, len;\n\tstruct kcm_sock *kcm;\n\tstruct kcm_psock *psock;\n\n\t \n\tseq_printf(seq,\n\t\t   \"%-6s%-8s %-10llu %-16llu %-10llu %-16llu %-8s %-8s %-8s %-8s \",\n\t\t   \"mux\", \"\",\n\t\t   mux->stats.rx_msgs,\n\t\t   mux->stats.rx_bytes,\n\t\t   mux->stats.tx_msgs,\n\t\t   mux->stats.tx_bytes,\n\t\t   \"-\", \"-\", \"-\", \"-\");\n\n\tseq_printf(seq, \"KCMs: %d, Psocks %d\\n\",\n\t\t   mux->kcm_socks_cnt, mux->psocks_cnt);\n\n\t \n\ti = 0;\n\tspin_lock_bh(&mux->lock);\n\tlist_for_each_entry(kcm, &mux->kcm_socks, kcm_sock_list) {\n\t\tkcm_format_sock(kcm, seq, i, &len);\n\t\ti++;\n\t}\n\ti = 0;\n\tlist_for_each_entry(psock, &mux->psocks, psock_list) {\n\t\tkcm_format_psock(psock, seq, i, &len);\n\t\ti++;\n\t}\n\tspin_unlock_bh(&mux->lock);\n}\n\nstatic int kcm_seq_show(struct seq_file *seq, void *v)\n{\n\tstruct kcm_proc_mux_state *mux_state;\n\n\tmux_state = seq->private;\n\tif (v == SEQ_START_TOKEN) {\n\t\tmux_state->idx = 0;\n\t\tkcm_format_mux_header(seq);\n\t} else {\n\t\tkcm_format_mux(v, mux_state->idx, seq);\n\t\tmux_state->idx++;\n\t}\n\treturn 0;\n}\n\nstatic const struct seq_operations kcm_seq_ops = {\n\t.show\t= kcm_seq_show,\n\t.start\t= kcm_seq_start,\n\t.next\t= kcm_seq_next,\n\t.stop\t= kcm_seq_stop,\n};\n\nstatic int kcm_stats_seq_show(struct seq_file *seq, void *v)\n{\n\tstruct kcm_psock_stats psock_stats;\n\tstruct kcm_mux_stats mux_stats;\n\tstruct strp_aggr_stats strp_stats;\n\tstruct kcm_mux *mux;\n\tstruct kcm_psock *psock;\n\tstruct net *net = seq->private;\n\tstruct kcm_net *knet = net_generic(net, kcm_net_id);\n\n\tmemset(&mux_stats, 0, sizeof(mux_stats));\n\tmemset(&psock_stats, 0, sizeof(psock_stats));\n\tmemset(&strp_stats, 0, sizeof(strp_stats));\n\n\tmutex_lock(&knet->mutex);\n\n\taggregate_mux_stats(&knet->aggregate_mux_stats, &mux_stats);\n\taggregate_psock_stats(&knet->aggregate_psock_stats,\n\t\t\t      &psock_stats);\n\taggregate_strp_stats(&knet->aggregate_strp_stats,\n\t\t\t     &strp_stats);\n\n\tlist_for_each_entry(mux, &knet->mux_list, kcm_mux_list) {\n\t\tspin_lock_bh(&mux->lock);\n\t\taggregate_mux_stats(&mux->stats, &mux_stats);\n\t\taggregate_psock_stats(&mux->aggregate_psock_stats,\n\t\t\t\t      &psock_stats);\n\t\taggregate_strp_stats(&mux->aggregate_strp_stats,\n\t\t\t\t     &strp_stats);\n\t\tlist_for_each_entry(psock, &mux->psocks, psock_list) {\n\t\t\taggregate_psock_stats(&psock->stats, &psock_stats);\n\t\t\tsave_strp_stats(&psock->strp, &strp_stats);\n\t\t}\n\n\t\tspin_unlock_bh(&mux->lock);\n\t}\n\n\tmutex_unlock(&knet->mutex);\n\n\tseq_printf(seq,\n\t\t   \"%-8s %-10s %-16s %-10s %-16s %-10s %-10s %-10s %-10s %-10s\\n\",\n\t\t   \"MUX\",\n\t\t   \"RX-Msgs\",\n\t\t   \"RX-Bytes\",\n\t\t   \"TX-Msgs\",\n\t\t   \"TX-Bytes\",\n\t\t   \"TX-Retries\",\n\t\t   \"Attach\",\n\t\t   \"Unattach\",\n\t\t   \"UnattchRsvd\",\n\t\t   \"RX-RdyDrops\");\n\n\tseq_printf(seq,\n\t\t   \"%-8s %-10llu %-16llu %-10llu %-16llu %-10u %-10u %-10u %-10u %-10u\\n\",\n\t\t   \"\",\n\t\t   mux_stats.rx_msgs,\n\t\t   mux_stats.rx_bytes,\n\t\t   mux_stats.tx_msgs,\n\t\t   mux_stats.tx_bytes,\n\t\t   mux_stats.tx_retries,\n\t\t   mux_stats.psock_attach,\n\t\t   mux_stats.psock_unattach_rsvd,\n\t\t   mux_stats.psock_unattach,\n\t\t   mux_stats.rx_ready_drops);\n\n\tseq_printf(seq,\n\t\t   \"%-8s %-10s %-16s %-10s %-16s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s\\n\",\n\t\t   \"Psock\",\n\t\t   \"RX-Msgs\",\n\t\t   \"RX-Bytes\",\n\t\t   \"TX-Msgs\",\n\t\t   \"TX-Bytes\",\n\t\t   \"Reserved\",\n\t\t   \"Unreserved\",\n\t\t   \"RX-Aborts\",\n\t\t   \"RX-Intr\",\n\t\t   \"RX-Unrecov\",\n\t\t   \"RX-MemFail\",\n\t\t   \"RX-NeedMor\",\n\t\t   \"RX-BadLen\",\n\t\t   \"RX-TooBig\",\n\t\t   \"RX-Timeout\",\n\t\t   \"TX-Aborts\");\n\n\tseq_printf(seq,\n\t\t   \"%-8s %-10llu %-16llu %-10llu %-16llu %-10llu %-10llu %-10u %-10u %-10u %-10u %-10u %-10u %-10u %-10u %-10u\\n\",\n\t\t   \"\",\n\t\t   strp_stats.msgs,\n\t\t   strp_stats.bytes,\n\t\t   psock_stats.tx_msgs,\n\t\t   psock_stats.tx_bytes,\n\t\t   psock_stats.reserved,\n\t\t   psock_stats.unreserved,\n\t\t   strp_stats.aborts,\n\t\t   strp_stats.interrupted,\n\t\t   strp_stats.unrecov_intr,\n\t\t   strp_stats.mem_fail,\n\t\t   strp_stats.need_more_hdr,\n\t\t   strp_stats.bad_hdr_len,\n\t\t   strp_stats.msg_too_big,\n\t\t   strp_stats.msg_timeouts,\n\t\t   psock_stats.tx_aborts);\n\n\treturn 0;\n}\n\nstatic int kcm_proc_init_net(struct net *net)\n{\n\tif (!proc_create_net_single(\"kcm_stats\", 0444, net->proc_net,\n\t\t\t kcm_stats_seq_show, NULL))\n\t\tgoto out_kcm_stats;\n\n\tif (!proc_create_net(\"kcm\", 0444, net->proc_net, &kcm_seq_ops,\n\t\t\tsizeof(struct kcm_proc_mux_state)))\n\t\tgoto out_kcm;\n\n\treturn 0;\n\nout_kcm:\n\tremove_proc_entry(\"kcm_stats\", net->proc_net);\nout_kcm_stats:\n\treturn -ENOMEM;\n}\n\nstatic void kcm_proc_exit_net(struct net *net)\n{\n\tremove_proc_entry(\"kcm\", net->proc_net);\n\tremove_proc_entry(\"kcm_stats\", net->proc_net);\n}\n\nstatic struct pernet_operations kcm_net_ops = {\n\t.init = kcm_proc_init_net,\n\t.exit = kcm_proc_exit_net,\n};\n\nint __init kcm_proc_init(void)\n{\n\treturn register_pernet_subsys(&kcm_net_ops);\n}\n\nvoid __exit kcm_proc_exit(void)\n{\n\tunregister_pernet_subsys(&kcm_net_ops);\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}