{
  "module_name": "digital_dep.c",
  "hash_id": "eaedb4e4a856a74d8501dd79071b598c275871c9e779359ef0388571fd8a936d",
  "original_prompt": "Ingested from linux-6.6.14/net/nfc/digital_dep.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) \"digital: %s: \" fmt, __func__\n\n#include \"digital.h\"\n\n#define DIGITAL_NFC_DEP_N_RETRY_NACK\t2\n#define DIGITAL_NFC_DEP_N_RETRY_ATN\t2\n\n#define DIGITAL_NFC_DEP_FRAME_DIR_OUT 0xD4\n#define DIGITAL_NFC_DEP_FRAME_DIR_IN  0xD5\n\n#define DIGITAL_NFC_DEP_NFCA_SOD_SB   0xF0\n\n#define DIGITAL_CMD_ATR_REQ 0x00\n#define DIGITAL_CMD_ATR_RES 0x01\n#define DIGITAL_CMD_PSL_REQ 0x04\n#define DIGITAL_CMD_PSL_RES 0x05\n#define DIGITAL_CMD_DEP_REQ 0x06\n#define DIGITAL_CMD_DEP_RES 0x07\n\n#define DIGITAL_ATR_REQ_MIN_SIZE 16\n#define DIGITAL_ATR_REQ_MAX_SIZE 64\n\n#define DIGITAL_ATR_RES_TO_WT(s)\t((s) & 0xF)\n\n#define DIGITAL_DID_MAX\t14\n\n#define DIGITAL_PAYLOAD_SIZE_MAX\t254\n#define DIGITAL_PAYLOAD_BITS_TO_PP(s)\t(((s) & 0x3) << 4)\n#define DIGITAL_PAYLOAD_PP_TO_BITS(s)\t(((s) >> 4) & 0x3)\n#define DIGITAL_PAYLOAD_BITS_TO_FSL(s)\t((s) & 0x3)\n#define DIGITAL_PAYLOAD_FSL_TO_BITS(s)\t((s) & 0x3)\n\n#define DIGITAL_GB_BIT\t0x02\n\n#define DIGITAL_NFC_DEP_PFB_TYPE(pfb) ((pfb) & 0xE0)\n\n#define DIGITAL_NFC_DEP_PFB_TIMEOUT_BIT 0x10\n#define DIGITAL_NFC_DEP_PFB_MI_BIT\t0x10\n#define DIGITAL_NFC_DEP_PFB_NACK_BIT\t0x10\n#define DIGITAL_NFC_DEP_PFB_DID_BIT\t0x04\n\n#define DIGITAL_NFC_DEP_PFB_IS_TIMEOUT(pfb) \\\n\t\t\t\t((pfb) & DIGITAL_NFC_DEP_PFB_TIMEOUT_BIT)\n#define DIGITAL_NFC_DEP_MI_BIT_SET(pfb)  ((pfb) & DIGITAL_NFC_DEP_PFB_MI_BIT)\n#define DIGITAL_NFC_DEP_NACK_BIT_SET(pfb) ((pfb) & DIGITAL_NFC_DEP_PFB_NACK_BIT)\n#define DIGITAL_NFC_DEP_NAD_BIT_SET(pfb) ((pfb) & 0x08)\n#define DIGITAL_NFC_DEP_DID_BIT_SET(pfb) ((pfb) & DIGITAL_NFC_DEP_PFB_DID_BIT)\n#define DIGITAL_NFC_DEP_PFB_PNI(pfb)     ((pfb) & 0x03)\n\n#define DIGITAL_NFC_DEP_RTOX_VALUE(data) ((data) & 0x3F)\n#define DIGITAL_NFC_DEP_RTOX_MAX\t 59\n\n#define DIGITAL_NFC_DEP_PFB_I_PDU          0x00\n#define DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU   0x40\n#define DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU 0x80\n\nstruct digital_atr_req {\n\tu8 dir;\n\tu8 cmd;\n\tu8 nfcid3[10];\n\tu8 did;\n\tu8 bs;\n\tu8 br;\n\tu8 pp;\n\tu8 gb[];\n} __packed;\n\nstruct digital_atr_res {\n\tu8 dir;\n\tu8 cmd;\n\tu8 nfcid3[10];\n\tu8 did;\n\tu8 bs;\n\tu8 br;\n\tu8 to;\n\tu8 pp;\n\tu8 gb[];\n} __packed;\n\nstruct digital_psl_req {\n\tu8 dir;\n\tu8 cmd;\n\tu8 did;\n\tu8 brs;\n\tu8 fsl;\n} __packed;\n\nstruct digital_psl_res {\n\tu8 dir;\n\tu8 cmd;\n\tu8 did;\n} __packed;\n\nstruct digital_dep_req_res {\n\tu8 dir;\n\tu8 cmd;\n\tu8 pfb;\n} __packed;\n\nstatic void digital_in_recv_dep_res(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t    struct sk_buff *resp);\nstatic void digital_tg_recv_dep_req(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t    struct sk_buff *resp);\n\nstatic const u8 digital_payload_bits_map[4] = {\n\t[0] = 64,\n\t[1] = 128,\n\t[2] = 192,\n\t[3] = 254\n};\n\n \n#define DIGITAL_ATR_RES_RWT 1337\n\n \n#define DIGITAL_NFC_DEP_IN_MAX_WT 14\n#define DIGITAL_NFC_DEP_TG_MAX_WT 14\nstatic const u16 digital_rwt_map[DIGITAL_NFC_DEP_IN_MAX_WT + 1] = {\n\t100,  101,  101,  102,  105,\n\t110,  119,  139,  177,  255,\n\t409,  719, 1337, 2575, 5049,\n};\n\nstatic u8 digital_payload_bits_to_size(u8 payload_bits)\n{\n\tif (payload_bits >= ARRAY_SIZE(digital_payload_bits_map))\n\t\treturn 0;\n\n\treturn digital_payload_bits_map[payload_bits];\n}\n\nstatic u8 digital_payload_size_to_bits(u8 payload_size)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(digital_payload_bits_map); i++)\n\t\tif (digital_payload_bits_map[i] == payload_size)\n\t\t\treturn i;\n\n\treturn 0xff;\n}\n\nstatic void digital_skb_push_dep_sod(struct nfc_digital_dev *ddev,\n\t\t\t\t     struct sk_buff *skb)\n{\n\tskb_push(skb, sizeof(u8));\n\n\tskb->data[0] = skb->len;\n\n\tif (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)\n\t\t*(u8 *)skb_push(skb, sizeof(u8)) = DIGITAL_NFC_DEP_NFCA_SOD_SB;\n}\n\nstatic int digital_skb_pull_dep_sod(struct nfc_digital_dev *ddev,\n\t\t\t\t    struct sk_buff *skb)\n{\n\tu8 size;\n\n\tif (skb->len < 2)\n\t\treturn -EIO;\n\n\tif (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)\n\t\tskb_pull(skb, sizeof(u8));\n\n\tsize = skb->data[0];\n\tif (size != skb->len)\n\t\treturn -EIO;\n\n\tskb_pull(skb, sizeof(u8));\n\n\treturn 0;\n}\n\nstatic struct sk_buff *\ndigital_send_dep_data_prep(struct nfc_digital_dev *ddev, struct sk_buff *skb,\n\t\t\t   struct digital_dep_req_res *dep_req_res,\n\t\t\t   struct digital_data_exch *data_exch)\n{\n\tstruct sk_buff *new_skb;\n\n\tif (skb->len > ddev->remote_payload_max) {\n\t\tdep_req_res->pfb |= DIGITAL_NFC_DEP_PFB_MI_BIT;\n\n\t\tnew_skb = digital_skb_alloc(ddev, ddev->remote_payload_max);\n\t\tif (!new_skb) {\n\t\t\tkfree_skb(ddev->chaining_skb);\n\t\t\tddev->chaining_skb = NULL;\n\n\t\t\treturn ERR_PTR(-ENOMEM);\n\t\t}\n\n\t\tskb_put_data(new_skb, skb->data, ddev->remote_payload_max);\n\t\tskb_pull(skb, ddev->remote_payload_max);\n\n\t\tddev->chaining_skb = skb;\n\t\tddev->data_exch = data_exch;\n\t} else {\n\t\tddev->chaining_skb = NULL;\n\t\tnew_skb = skb;\n\t}\n\n\treturn new_skb;\n}\n\nstatic struct sk_buff *\ndigital_recv_dep_data_gather(struct nfc_digital_dev *ddev, u8 pfb,\n\t\t\t     struct sk_buff *resp,\n\t\t\t     int (*send_ack)(struct nfc_digital_dev *ddev,\n\t\t\t\t\t     struct digital_data_exch\n\t\t\t\t\t\t\t     *data_exch),\n\t\t\t     struct digital_data_exch *data_exch)\n{\n\tstruct sk_buff *new_skb;\n\tint rc;\n\n\tif (DIGITAL_NFC_DEP_MI_BIT_SET(pfb) && (!ddev->chaining_skb)) {\n\t\tddev->chaining_skb =\n\t\t\tnfc_alloc_recv_skb(8 * ddev->local_payload_max,\n\t\t\t\t\t   GFP_KERNEL);\n\t\tif (!ddev->chaining_skb) {\n\t\t\trc = -ENOMEM;\n\t\t\tgoto error;\n\t\t}\n\t}\n\n\tif (ddev->chaining_skb) {\n\t\tif (resp->len > skb_tailroom(ddev->chaining_skb)) {\n\t\t\tnew_skb = skb_copy_expand(ddev->chaining_skb,\n\t\t\t\t\t\t  skb_headroom(\n\t\t\t\t\t\t\t  ddev->chaining_skb),\n\t\t\t\t\t\t  8 * ddev->local_payload_max,\n\t\t\t\t\t\t  GFP_KERNEL);\n\t\t\tif (!new_skb) {\n\t\t\t\trc = -ENOMEM;\n\t\t\t\tgoto error;\n\t\t\t}\n\n\t\t\tkfree_skb(ddev->chaining_skb);\n\t\t\tddev->chaining_skb = new_skb;\n\t\t}\n\n\t\tskb_put_data(ddev->chaining_skb, resp->data, resp->len);\n\n\t\tkfree_skb(resp);\n\t\tresp = NULL;\n\n\t\tif (DIGITAL_NFC_DEP_MI_BIT_SET(pfb)) {\n\t\t\trc = send_ack(ddev, data_exch);\n\t\t\tif (rc)\n\t\t\t\tgoto error;\n\n\t\t\treturn NULL;\n\t\t}\n\n\t\tresp = ddev->chaining_skb;\n\t\tddev->chaining_skb = NULL;\n\t}\n\n\treturn resp;\n\nerror:\n\tkfree_skb(resp);\n\n\tkfree_skb(ddev->chaining_skb);\n\tddev->chaining_skb = NULL;\n\n\treturn ERR_PTR(rc);\n}\n\nstatic void digital_in_recv_psl_res(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t    struct sk_buff *resp)\n{\n\tstruct nfc_target *target = arg;\n\tstruct digital_psl_res *psl_res;\n\tint rc;\n\n\tif (IS_ERR(resp)) {\n\t\trc = PTR_ERR(resp);\n\t\tresp = NULL;\n\t\tgoto exit;\n\t}\n\n\trc = ddev->skb_check_crc(resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.6\");\n\t\tgoto exit;\n\t}\n\n\trc = digital_skb_pull_dep_sod(ddev, resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.2\");\n\t\tgoto exit;\n\t}\n\n\tpsl_res = (struct digital_psl_res *)resp->data;\n\n\tif ((resp->len != sizeof(*psl_res)) ||\n\t    (psl_res->dir != DIGITAL_NFC_DEP_FRAME_DIR_IN) ||\n\t    (psl_res->cmd != DIGITAL_CMD_PSL_RES)) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\trc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH,\n\t\t\t\t     NFC_DIGITAL_RF_TECH_424F);\n\tif (rc)\n\t\tgoto exit;\n\n\trc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\n\t\t\t\t     NFC_DIGITAL_FRAMING_NFCF_NFC_DEP);\n\tif (rc)\n\t\tgoto exit;\n\n\tif (!DIGITAL_DRV_CAPS_IN_CRC(ddev) &&\n\t    (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)) {\n\t\tddev->skb_add_crc = digital_skb_add_crc_f;\n\t\tddev->skb_check_crc = digital_skb_check_crc_f;\n\t}\n\n\tddev->curr_rf_tech = NFC_DIGITAL_RF_TECH_424F;\n\n\tnfc_dep_link_is_up(ddev->nfc_dev, target->idx, NFC_COMM_ACTIVE,\n\t\t\t   NFC_RF_INITIATOR);\n\n\tddev->curr_nfc_dep_pni = 0;\n\nexit:\n\tdev_kfree_skb(resp);\n\n\tif (rc)\n\t\tddev->curr_protocol = 0;\n}\n\nstatic int digital_in_send_psl_req(struct nfc_digital_dev *ddev,\n\t\t\t\t   struct nfc_target *target)\n{\n\tstruct sk_buff *skb;\n\tstruct digital_psl_req *psl_req;\n\tint rc;\n\tu8 payload_size, payload_bits;\n\n\tskb = digital_skb_alloc(ddev, sizeof(*psl_req));\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_put(skb, sizeof(*psl_req));\n\n\tpsl_req = (struct digital_psl_req *)skb->data;\n\n\tpsl_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tpsl_req->cmd = DIGITAL_CMD_PSL_REQ;\n\tpsl_req->did = 0;\n\tpsl_req->brs = (0x2 << 3) | 0x2;  \n\n\tpayload_size = min(ddev->local_payload_max, ddev->remote_payload_max);\n\tpayload_bits = digital_payload_size_to_bits(payload_size);\n\tpsl_req->fsl = DIGITAL_PAYLOAD_BITS_TO_FSL(payload_bits);\n\n\tddev->local_payload_max = payload_size;\n\tddev->remote_payload_max = payload_size;\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\trc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\n\t\t\t\t digital_in_recv_psl_res, target);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic void digital_in_recv_atr_res(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t struct sk_buff *resp)\n{\n\tstruct nfc_target *target = arg;\n\tstruct digital_atr_res *atr_res;\n\tu8 gb_len, payload_bits;\n\tu8 wt;\n\tint rc;\n\n\tif (IS_ERR(resp)) {\n\t\trc = PTR_ERR(resp);\n\t\tresp = NULL;\n\t\tgoto exit;\n\t}\n\n\trc = ddev->skb_check_crc(resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.6\");\n\t\tgoto exit;\n\t}\n\n\trc = digital_skb_pull_dep_sod(ddev, resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.2\");\n\t\tgoto exit;\n\t}\n\n\tif (resp->len < sizeof(struct digital_atr_res)) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tgb_len = resp->len - sizeof(struct digital_atr_res);\n\n\tatr_res = (struct digital_atr_res *)resp->data;\n\n\twt = DIGITAL_ATR_RES_TO_WT(atr_res->to);\n\tif (wt > DIGITAL_NFC_DEP_IN_MAX_WT)\n\t\twt = DIGITAL_NFC_DEP_IN_MAX_WT;\n\tddev->dep_rwt = digital_rwt_map[wt];\n\n\tpayload_bits = DIGITAL_PAYLOAD_PP_TO_BITS(atr_res->pp);\n\tddev->remote_payload_max = digital_payload_bits_to_size(payload_bits);\n\n\tif (!ddev->remote_payload_max) {\n\t\trc = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\trc = nfc_set_remote_general_bytes(ddev->nfc_dev, atr_res->gb, gb_len);\n\tif (rc)\n\t\tgoto exit;\n\n\tif ((ddev->protocols & NFC_PROTO_FELICA_MASK) &&\n\t    (ddev->curr_rf_tech != NFC_DIGITAL_RF_TECH_424F)) {\n\t\trc = digital_in_send_psl_req(ddev, target);\n\t\tif (!rc)\n\t\t\tgoto exit;\n\t}\n\n\trc = nfc_dep_link_is_up(ddev->nfc_dev, target->idx, NFC_COMM_ACTIVE,\n\t\t\t\tNFC_RF_INITIATOR);\n\n\tddev->curr_nfc_dep_pni = 0;\n\nexit:\n\tdev_kfree_skb(resp);\n\n\tif (rc)\n\t\tddev->curr_protocol = 0;\n}\n\nint digital_in_send_atr_req(struct nfc_digital_dev *ddev,\n\t\t\t    struct nfc_target *target, __u8 comm_mode, __u8 *gb,\n\t\t\t    size_t gb_len)\n{\n\tstruct sk_buff *skb;\n\tstruct digital_atr_req *atr_req;\n\tuint size;\n\tint rc;\n\tu8 payload_bits;\n\n\tsize = DIGITAL_ATR_REQ_MIN_SIZE + gb_len;\n\n\tif (size > DIGITAL_ATR_REQ_MAX_SIZE) {\n\t\tPROTOCOL_ERR(\"14.6.1.1\");\n\t\treturn -EINVAL;\n\t}\n\n\tskb = digital_skb_alloc(ddev, size);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_put(skb, sizeof(struct digital_atr_req));\n\n\tatr_req = (struct digital_atr_req *)skb->data;\n\tmemset(atr_req, 0, sizeof(struct digital_atr_req));\n\n\tatr_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tatr_req->cmd = DIGITAL_CMD_ATR_REQ;\n\tif (target->nfcid2_len)\n\t\tmemcpy(atr_req->nfcid3, target->nfcid2, NFC_NFCID2_MAXSIZE);\n\telse\n\t\tget_random_bytes(atr_req->nfcid3, NFC_NFCID3_MAXSIZE);\n\n\tatr_req->did = 0;\n\tatr_req->bs = 0;\n\tatr_req->br = 0;\n\n\tddev->local_payload_max = DIGITAL_PAYLOAD_SIZE_MAX;\n\tpayload_bits = digital_payload_size_to_bits(ddev->local_payload_max);\n\tatr_req->pp = DIGITAL_PAYLOAD_BITS_TO_PP(payload_bits);\n\n\tif (gb_len) {\n\t\tatr_req->pp |= DIGITAL_GB_BIT;\n\t\tskb_put_data(skb, gb, gb_len);\n\t}\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\trc = digital_in_send_cmd(ddev, skb, DIGITAL_ATR_RES_RWT,\n\t\t\t\t digital_in_recv_atr_res, target);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic int digital_in_send_ack(struct nfc_digital_dev *ddev,\n\t\t\t       struct digital_data_exch *data_exch)\n{\n\tstruct digital_dep_req_res *dep_req;\n\tstruct sk_buff *skb;\n\tint rc;\n\n\tskb = digital_skb_alloc(ddev, 1);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_req = (struct digital_dep_req_res *)skb->data;\n\n\tdep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tdep_req->cmd = DIGITAL_CMD_DEP_REQ;\n\tdep_req->pfb = DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU |\n\t\t       ddev->curr_nfc_dep_pni;\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\tddev->saved_skb = pskb_copy(skb, GFP_KERNEL);\n\n\trc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\n\t\t\t\t digital_in_recv_dep_res, data_exch);\n\tif (rc) {\n\t\tkfree_skb(skb);\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\t}\n\n\treturn rc;\n}\n\nstatic int digital_in_send_nack(struct nfc_digital_dev *ddev,\n\t\t\t\tstruct digital_data_exch *data_exch)\n{\n\tstruct digital_dep_req_res *dep_req;\n\tstruct sk_buff *skb;\n\tint rc;\n\n\tskb = digital_skb_alloc(ddev, 1);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_req = (struct digital_dep_req_res *)skb->data;\n\n\tdep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tdep_req->cmd = DIGITAL_CMD_DEP_REQ;\n\tdep_req->pfb = DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU |\n\t\t       DIGITAL_NFC_DEP_PFB_NACK_BIT | ddev->curr_nfc_dep_pni;\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\trc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\n\t\t\t\t digital_in_recv_dep_res, data_exch);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic int digital_in_send_atn(struct nfc_digital_dev *ddev,\n\t\t\t       struct digital_data_exch *data_exch)\n{\n\tstruct digital_dep_req_res *dep_req;\n\tstruct sk_buff *skb;\n\tint rc;\n\n\tskb = digital_skb_alloc(ddev, 1);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_req = (struct digital_dep_req_res *)skb->data;\n\n\tdep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tdep_req->cmd = DIGITAL_CMD_DEP_REQ;\n\tdep_req->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU;\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\trc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\n\t\t\t\t digital_in_recv_dep_res, data_exch);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic int digital_in_send_rtox(struct nfc_digital_dev *ddev,\n\t\t\t\tstruct digital_data_exch *data_exch, u8 rtox)\n{\n\tstruct digital_dep_req_res *dep_req;\n\tstruct sk_buff *skb;\n\tint rc;\n\tu16 rwt_int;\n\n\trwt_int = ddev->dep_rwt * rtox;\n\tif (rwt_int > digital_rwt_map[DIGITAL_NFC_DEP_IN_MAX_WT])\n\t\trwt_int = digital_rwt_map[DIGITAL_NFC_DEP_IN_MAX_WT];\n\n\tskb = digital_skb_alloc(ddev, 1);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_put_u8(skb, rtox);\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_req = (struct digital_dep_req_res *)skb->data;\n\n\tdep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tdep_req->cmd = DIGITAL_CMD_DEP_REQ;\n\tdep_req->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU |\n\t\t       DIGITAL_NFC_DEP_PFB_TIMEOUT_BIT;\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\trc = digital_in_send_cmd(ddev, skb, rwt_int,\n\t\t\t\t digital_in_recv_dep_res, data_exch);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic int digital_in_send_saved_skb(struct nfc_digital_dev *ddev,\n\t\t\t\t     struct digital_data_exch *data_exch)\n{\n\tint rc;\n\n\tif (!ddev->saved_skb)\n\t\treturn -EINVAL;\n\n\tskb_get(ddev->saved_skb);\n\n\trc = digital_in_send_cmd(ddev, ddev->saved_skb, ddev->dep_rwt,\n\t\t\t\t digital_in_recv_dep_res, data_exch);\n\tif (rc)\n\t\tkfree_skb(ddev->saved_skb);\n\n\treturn rc;\n}\n\nstatic void digital_in_recv_dep_res(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t    struct sk_buff *resp)\n{\n\tstruct digital_data_exch *data_exch = arg;\n\tstruct digital_dep_req_res *dep_res;\n\tu8 pfb;\n\tuint size;\n\tint rc;\n\tu8 rtox;\n\n\tif (IS_ERR(resp)) {\n\t\trc = PTR_ERR(resp);\n\t\tresp = NULL;\n\n\t\tif ((rc == -EIO || (rc == -ETIMEDOUT && ddev->nack_count)) &&\n\t\t    (ddev->nack_count++ < DIGITAL_NFC_DEP_N_RETRY_NACK)) {\n\t\t\tddev->atn_count = 0;\n\n\t\t\trc = digital_in_send_nack(ddev, data_exch);\n\t\t\tif (rc)\n\t\t\t\tgoto error;\n\n\t\t\treturn;\n\t\t} else if ((rc == -ETIMEDOUT) &&\n\t\t\t   (ddev->atn_count++ < DIGITAL_NFC_DEP_N_RETRY_ATN)) {\n\t\t\tddev->nack_count = 0;\n\n\t\t\trc = digital_in_send_atn(ddev, data_exch);\n\t\t\tif (rc)\n\t\t\t\tgoto error;\n\n\t\t\treturn;\n\t\t}\n\n\t\tgoto exit;\n\t}\n\n\trc = digital_skb_pull_dep_sod(ddev, resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.2\");\n\t\tgoto exit;\n\t}\n\n\trc = ddev->skb_check_crc(resp);\n\tif (rc) {\n\t\tif ((resp->len >= 4) &&\n\t\t    (ddev->nack_count++ < DIGITAL_NFC_DEP_N_RETRY_NACK)) {\n\t\t\tddev->atn_count = 0;\n\n\t\t\trc = digital_in_send_nack(ddev, data_exch);\n\t\t\tif (rc)\n\t\t\t\tgoto error;\n\n\t\t\tkfree_skb(resp);\n\n\t\t\treturn;\n\t\t}\n\n\t\tPROTOCOL_ERR(\"14.4.1.6\");\n\t\tgoto error;\n\t}\n\n\tddev->atn_count = 0;\n\tddev->nack_count = 0;\n\n\tif (resp->len > ddev->local_payload_max) {\n\t\trc = -EMSGSIZE;\n\t\tgoto exit;\n\t}\n\n\tsize = sizeof(struct digital_dep_req_res);\n\tdep_res = (struct digital_dep_req_res *)resp->data;\n\n\tif (resp->len < size || dep_res->dir != DIGITAL_NFC_DEP_FRAME_DIR_IN ||\n\t    dep_res->cmd != DIGITAL_CMD_DEP_RES) {\n\t\trc = -EIO;\n\t\tgoto error;\n\t}\n\n\tpfb = dep_res->pfb;\n\n\tif (DIGITAL_NFC_DEP_DID_BIT_SET(pfb)) {\n\t\tPROTOCOL_ERR(\"14.8.2.1\");\n\t\trc = -EIO;\n\t\tgoto error;\n\t}\n\n\tif (DIGITAL_NFC_DEP_NAD_BIT_SET(pfb)) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tif (size > resp->len) {\n\t\trc = -EIO;\n\t\tgoto error;\n\t}\n\n\tskb_pull(resp, size);\n\n\tswitch (DIGITAL_NFC_DEP_PFB_TYPE(pfb)) {\n\tcase DIGITAL_NFC_DEP_PFB_I_PDU:\n\t\tif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\n\t\t\tPROTOCOL_ERR(\"14.12.3.3\");\n\t\t\trc = -EIO;\n\t\t\tgoto error;\n\t\t}\n\n\t\tddev->curr_nfc_dep_pni =\n\t\t\tDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\n\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\n\t\tresp = digital_recv_dep_data_gather(ddev, pfb, resp,\n\t\t\t\t\t\t    digital_in_send_ack,\n\t\t\t\t\t\t    data_exch);\n\t\tif (IS_ERR(resp)) {\n\t\t\trc = PTR_ERR(resp);\n\t\t\tresp = NULL;\n\t\t\tgoto error;\n\t\t}\n\n\t\t \n\t\tif (!resp)\n\t\t\treturn;\n\n\t\trc = 0;\n\t\tbreak;\n\n\tcase DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU:\n\t\tif (DIGITAL_NFC_DEP_NACK_BIT_SET(pfb)) {\n\t\t\tPROTOCOL_ERR(\"14.12.4.5\");\n\t\t\trc = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\n\t\t\tPROTOCOL_ERR(\"14.12.3.3\");\n\t\t\trc = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tddev->curr_nfc_dep_pni =\n\t\t\tDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\n\n\t\tif (!ddev->chaining_skb) {\n\t\t\tPROTOCOL_ERR(\"14.12.4.3\");\n\t\t\trc = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\t \n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\n\t\trc = digital_in_send_dep_req(ddev, NULL,\n\t\t\t\t\t     ddev->chaining_skb,\n\t\t\t\t\t     ddev->data_exch);\n\t\tif (rc)\n\t\t\tgoto error;\n\n\t\tgoto free_resp;\n\n\tcase DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU:\n\t\tif (!DIGITAL_NFC_DEP_PFB_IS_TIMEOUT(pfb)) {  \n\t\t\trc = digital_in_send_saved_skb(ddev, data_exch);\n\t\t\tif (rc)\n\t\t\t\tgoto error;\n\n\t\t\tgoto free_resp;\n\t\t}\n\n\t\tif (ddev->atn_count || ddev->nack_count) {\n\t\t\tPROTOCOL_ERR(\"14.12.4.4\");\n\t\t\trc = -EIO;\n\t\t\tgoto error;\n\t\t}\n\n\t\trtox = DIGITAL_NFC_DEP_RTOX_VALUE(resp->data[0]);\n\t\tif (!rtox || rtox > DIGITAL_NFC_DEP_RTOX_MAX) {\n\t\t\tPROTOCOL_ERR(\"14.8.4.1\");\n\t\t\trc = -EIO;\n\t\t\tgoto error;\n\t\t}\n\n\t\trc = digital_in_send_rtox(ddev, data_exch, rtox);\n\t\tif (rc)\n\t\t\tgoto error;\n\n\t\tgoto free_resp;\n\t}\n\nexit:\n\tdata_exch->cb(data_exch->cb_context, resp, rc);\n\nerror:\n\tkfree(data_exch);\n\n\tkfree_skb(ddev->chaining_skb);\n\tddev->chaining_skb = NULL;\n\n\tkfree_skb(ddev->saved_skb);\n\tddev->saved_skb = NULL;\n\n\tif (rc)\n\t\tkfree_skb(resp);\n\n\treturn;\n\nfree_resp:\n\tdev_kfree_skb(resp);\n}\n\nint digital_in_send_dep_req(struct nfc_digital_dev *ddev,\n\t\t\t    struct nfc_target *target, struct sk_buff *skb,\n\t\t\t    struct digital_data_exch *data_exch)\n{\n\tstruct digital_dep_req_res *dep_req;\n\tstruct sk_buff *chaining_skb, *tmp_skb;\n\tint rc;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_req = (struct digital_dep_req_res *)skb->data;\n\n\tdep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\n\tdep_req->cmd = DIGITAL_CMD_DEP_REQ;\n\tdep_req->pfb = ddev->curr_nfc_dep_pni;\n\n\tddev->atn_count = 0;\n\tddev->nack_count = 0;\n\n\tchaining_skb = ddev->chaining_skb;\n\n\ttmp_skb = digital_send_dep_data_prep(ddev, skb, dep_req, data_exch);\n\tif (IS_ERR(tmp_skb))\n\t\treturn PTR_ERR(tmp_skb);\n\n\tdigital_skb_push_dep_sod(ddev, tmp_skb);\n\n\tddev->skb_add_crc(tmp_skb);\n\n\tddev->saved_skb = pskb_copy(tmp_skb, GFP_KERNEL);\n\n\trc = digital_in_send_cmd(ddev, tmp_skb, ddev->dep_rwt,\n\t\t\t\t digital_in_recv_dep_res, data_exch);\n\tif (rc) {\n\t\tif (tmp_skb != skb)\n\t\t\tkfree_skb(tmp_skb);\n\n\t\tkfree_skb(chaining_skb);\n\t\tddev->chaining_skb = NULL;\n\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\t}\n\n\treturn rc;\n}\n\nstatic void digital_tg_set_rf_tech(struct nfc_digital_dev *ddev, u8 rf_tech)\n{\n\tddev->curr_rf_tech = rf_tech;\n\n\tddev->skb_add_crc = digital_skb_add_crc_none;\n\tddev->skb_check_crc = digital_skb_check_crc_none;\n\n\tif (DIGITAL_DRV_CAPS_TG_CRC(ddev))\n\t\treturn;\n\n\tswitch (ddev->curr_rf_tech) {\n\tcase NFC_DIGITAL_RF_TECH_106A:\n\t\tddev->skb_add_crc = digital_skb_add_crc_a;\n\t\tddev->skb_check_crc = digital_skb_check_crc_a;\n\t\tbreak;\n\n\tcase NFC_DIGITAL_RF_TECH_212F:\n\tcase NFC_DIGITAL_RF_TECH_424F:\n\t\tddev->skb_add_crc = digital_skb_add_crc_f;\n\t\tddev->skb_check_crc = digital_skb_check_crc_f;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic int digital_tg_send_ack(struct nfc_digital_dev *ddev,\n\t\t\t       struct digital_data_exch *data_exch)\n{\n\tstruct digital_dep_req_res *dep_res;\n\tstruct sk_buff *skb;\n\tint rc;\n\n\tskb = digital_skb_alloc(ddev, 1);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_res = (struct digital_dep_req_res *)skb->data;\n\n\tdep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\n\tdep_res->cmd = DIGITAL_CMD_DEP_RES;\n\tdep_res->pfb = DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU |\n\t\t       ddev->curr_nfc_dep_pni;\n\n\tif (ddev->did) {\n\t\tdep_res->pfb |= DIGITAL_NFC_DEP_PFB_DID_BIT;\n\n\t\tskb_put_data(skb, &ddev->did, sizeof(ddev->did));\n\t}\n\n\tddev->curr_nfc_dep_pni =\n\t\tDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\tddev->saved_skb = pskb_copy(skb, GFP_KERNEL);\n\n\trc = digital_tg_send_cmd(ddev, skb, 1500, digital_tg_recv_dep_req,\n\t\t\t\t data_exch);\n\tif (rc) {\n\t\tkfree_skb(skb);\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\t}\n\n\treturn rc;\n}\n\nstatic int digital_tg_send_atn(struct nfc_digital_dev *ddev)\n{\n\tstruct digital_dep_req_res *dep_res;\n\tstruct sk_buff *skb;\n\tint rc;\n\n\tskb = digital_skb_alloc(ddev, 1);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_res = (struct digital_dep_req_res *)skb->data;\n\n\tdep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\n\tdep_res->cmd = DIGITAL_CMD_DEP_RES;\n\tdep_res->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU;\n\n\tif (ddev->did) {\n\t\tdep_res->pfb |= DIGITAL_NFC_DEP_PFB_DID_BIT;\n\n\t\tskb_put_data(skb, &ddev->did, sizeof(ddev->did));\n\t}\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\trc = digital_tg_send_cmd(ddev, skb, 1500, digital_tg_recv_dep_req,\n\t\t\t\t NULL);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic int digital_tg_send_saved_skb(struct nfc_digital_dev *ddev)\n{\n\tint rc;\n\n\tif (!ddev->saved_skb)\n\t\treturn -EINVAL;\n\n\tskb_get(ddev->saved_skb);\n\n\trc = digital_tg_send_cmd(ddev, ddev->saved_skb, 1500,\n\t\t\t\t digital_tg_recv_dep_req, NULL);\n\tif (rc)\n\t\tkfree_skb(ddev->saved_skb);\n\n\treturn rc;\n}\n\nstatic void digital_tg_recv_dep_req(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t    struct sk_buff *resp)\n{\n\tint rc;\n\tstruct digital_dep_req_res *dep_req;\n\tu8 pfb;\n\tsize_t size;\n\n\tif (IS_ERR(resp)) {\n\t\trc = PTR_ERR(resp);\n\t\tresp = NULL;\n\t\tgoto exit;\n\t}\n\n\trc = ddev->skb_check_crc(resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.6\");\n\t\tgoto exit;\n\t}\n\n\trc = digital_skb_pull_dep_sod(ddev, resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.2\");\n\t\tgoto exit;\n\t}\n\n\tif (resp->len > ddev->local_payload_max) {\n\t\trc = -EMSGSIZE;\n\t\tgoto exit;\n\t}\n\n\tsize = sizeof(struct digital_dep_req_res);\n\tdep_req = (struct digital_dep_req_res *)resp->data;\n\n\tif (resp->len < size || dep_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\n\t    dep_req->cmd != DIGITAL_CMD_DEP_REQ) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tpfb = dep_req->pfb;\n\n\tif (DIGITAL_NFC_DEP_DID_BIT_SET(pfb)) {\n\t\tif (ddev->did && (ddev->did == resp->data[3])) {\n\t\t\tsize++;\n\t\t} else {\n\t\t\trc = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\t} else if (ddev->did) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tif (DIGITAL_NFC_DEP_NAD_BIT_SET(pfb)) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tif (size > resp->len) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tskb_pull(resp, size);\n\n\tswitch (DIGITAL_NFC_DEP_PFB_TYPE(pfb)) {\n\tcase DIGITAL_NFC_DEP_PFB_I_PDU:\n\t\tpr_debug(\"DIGITAL_NFC_DEP_PFB_I_PDU\\n\");\n\n\t\tif (ddev->atn_count) {\n\t\t\t \n\t\t\tddev->atn_count = 0;\n\n\t\t\t \n\t\t\tif (DIGITAL_NFC_DEP_PFB_PNI(pfb) ==\n\t\t\t  DIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni - 1)) {\n\t\t\t\trc = digital_tg_send_saved_skb(ddev);\n\t\t\t\tif (rc)\n\t\t\t\t\tgoto exit;\n\n\t\t\t\tgoto free_resp;\n\t\t\t}\n\n\t\t\t \n\t\t}\n\n\t\tif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\n\t\t\tPROTOCOL_ERR(\"14.12.3.4\");\n\t\t\trc = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\n\t\tresp = digital_recv_dep_data_gather(ddev, pfb, resp,\n\t\t\t\t\t\t    digital_tg_send_ack, NULL);\n\t\tif (IS_ERR(resp)) {\n\t\t\trc = PTR_ERR(resp);\n\t\t\tresp = NULL;\n\t\t\tgoto exit;\n\t\t}\n\n\t\t \n\t\tif (!resp)\n\t\t\treturn;\n\n\t\trc = 0;\n\t\tbreak;\n\tcase DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU:\n\t\tif (DIGITAL_NFC_DEP_NACK_BIT_SET(pfb)) {  \n\t\t\tif (DIGITAL_NFC_DEP_PFB_PNI(pfb + 1) !=\n\t\t\t\t\t\tddev->curr_nfc_dep_pni) {\n\t\t\t\trc = -EIO;\n\t\t\t\tgoto exit;\n\t\t\t}\n\n\t\t\tddev->atn_count = 0;\n\n\t\t\trc = digital_tg_send_saved_skb(ddev);\n\t\t\tif (rc)\n\t\t\t\tgoto exit;\n\n\t\t\tgoto free_resp;\n\t\t}\n\n\t\t \n\t\tif (ddev->atn_count) {\n\t\t\t \n\t\t\tddev->atn_count = 0;\n\n\t\t\t \n\t\t\tif (DIGITAL_NFC_DEP_PFB_PNI(pfb + 1) ==\n\t\t\t\t\t\tddev->curr_nfc_dep_pni) {\n\t\t\t\trc = digital_tg_send_saved_skb(ddev);\n\t\t\t\tif (rc)\n\t\t\t\t\tgoto exit;\n\n\t\t\t\tgoto free_resp;\n\t\t\t}\n\n\t\t\t \n\t\t}\n\n\t\t \n\t\tif (!ddev->chaining_skb ||\n\t\t    DIGITAL_NFC_DEP_PFB_PNI(pfb) !=\n\t\t\t\t\tddev->curr_nfc_dep_pni) {\n\t\t\trc = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\n\t\trc = digital_tg_send_dep_res(ddev, ddev->chaining_skb);\n\t\tif (rc)\n\t\t\tgoto exit;\n\n\t\tgoto free_resp;\n\tcase DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU:\n\t\tif (DIGITAL_NFC_DEP_PFB_IS_TIMEOUT(pfb)) {\n\t\t\trc = -EINVAL;\n\t\t\tgoto exit;\n\t\t}\n\n\t\trc = digital_tg_send_atn(ddev);\n\t\tif (rc)\n\t\t\tgoto exit;\n\n\t\tddev->atn_count++;\n\n\t\tgoto free_resp;\n\t}\n\n\trc = nfc_tm_data_received(ddev->nfc_dev, resp);\n\tif (rc)\n\t\tresp = NULL;\n\nexit:\n\tkfree_skb(ddev->chaining_skb);\n\tddev->chaining_skb = NULL;\n\n\tddev->atn_count = 0;\n\n\tkfree_skb(ddev->saved_skb);\n\tddev->saved_skb = NULL;\n\n\tif (rc)\n\t\tkfree_skb(resp);\n\n\treturn;\n\nfree_resp:\n\tdev_kfree_skb(resp);\n}\n\nint digital_tg_send_dep_res(struct nfc_digital_dev *ddev, struct sk_buff *skb)\n{\n\tstruct digital_dep_req_res *dep_res;\n\tstruct sk_buff *chaining_skb, *tmp_skb;\n\tint rc;\n\n\tskb_push(skb, sizeof(struct digital_dep_req_res));\n\n\tdep_res = (struct digital_dep_req_res *)skb->data;\n\n\tdep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\n\tdep_res->cmd = DIGITAL_CMD_DEP_RES;\n\tdep_res->pfb = ddev->curr_nfc_dep_pni;\n\n\tif (ddev->did) {\n\t\tdep_res->pfb |= DIGITAL_NFC_DEP_PFB_DID_BIT;\n\n\t\tskb_put_data(skb, &ddev->did, sizeof(ddev->did));\n\t}\n\n\tddev->curr_nfc_dep_pni =\n\t\tDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\n\n\tchaining_skb = ddev->chaining_skb;\n\n\ttmp_skb = digital_send_dep_data_prep(ddev, skb, dep_res, NULL);\n\tif (IS_ERR(tmp_skb))\n\t\treturn PTR_ERR(tmp_skb);\n\n\tdigital_skb_push_dep_sod(ddev, tmp_skb);\n\n\tddev->skb_add_crc(tmp_skb);\n\n\tddev->saved_skb = pskb_copy(tmp_skb, GFP_KERNEL);\n\n\trc = digital_tg_send_cmd(ddev, tmp_skb, 1500, digital_tg_recv_dep_req,\n\t\t\t\t NULL);\n\tif (rc) {\n\t\tif (tmp_skb != skb)\n\t\t\tkfree_skb(tmp_skb);\n\n\t\tkfree_skb(chaining_skb);\n\t\tddev->chaining_skb = NULL;\n\n\t\tkfree_skb(ddev->saved_skb);\n\t\tddev->saved_skb = NULL;\n\t}\n\n\treturn rc;\n}\n\nstatic void digital_tg_send_psl_res_complete(struct nfc_digital_dev *ddev,\n\t\t\t\t\t     void *arg, struct sk_buff *resp)\n{\n\tu8 rf_tech = (unsigned long)arg;\n\n\tif (IS_ERR(resp))\n\t\treturn;\n\n\tdigital_tg_set_rf_tech(ddev, rf_tech);\n\n\tdigital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH, rf_tech);\n\n\tdigital_tg_listen(ddev, 1500, digital_tg_recv_dep_req, NULL);\n\n\tdev_kfree_skb(resp);\n}\n\nstatic int digital_tg_send_psl_res(struct nfc_digital_dev *ddev, u8 did,\n\t\t\t\t   u8 rf_tech)\n{\n\tstruct digital_psl_res *psl_res;\n\tstruct sk_buff *skb;\n\tint rc;\n\n\tskb = digital_skb_alloc(ddev, sizeof(struct digital_psl_res));\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_put(skb, sizeof(struct digital_psl_res));\n\n\tpsl_res = (struct digital_psl_res *)skb->data;\n\n\tpsl_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\n\tpsl_res->cmd = DIGITAL_CMD_PSL_RES;\n\tpsl_res->did = did;\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\tddev->curr_nfc_dep_pni = 0;\n\n\trc = digital_tg_send_cmd(ddev, skb, 0, digital_tg_send_psl_res_complete,\n\t\t\t\t (void *)(unsigned long)rf_tech);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nstatic void digital_tg_recv_psl_req(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t\t    struct sk_buff *resp)\n{\n\tint rc;\n\tstruct digital_psl_req *psl_req;\n\tu8 rf_tech;\n\tu8 dsi, payload_size, payload_bits;\n\n\tif (IS_ERR(resp)) {\n\t\trc = PTR_ERR(resp);\n\t\tresp = NULL;\n\t\tgoto exit;\n\t}\n\n\trc = ddev->skb_check_crc(resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.6\");\n\t\tgoto exit;\n\t}\n\n\trc = digital_skb_pull_dep_sod(ddev, resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.2\");\n\t\tgoto exit;\n\t}\n\n\tpsl_req = (struct digital_psl_req *)resp->data;\n\n\tif (resp->len != sizeof(struct digital_psl_req) ||\n\t    psl_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\n\t    psl_req->cmd != DIGITAL_CMD_PSL_REQ) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tdsi = (psl_req->brs >> 3) & 0x07;\n\tswitch (dsi) {\n\tcase 0:\n\t\trf_tech = NFC_DIGITAL_RF_TECH_106A;\n\t\tbreak;\n\tcase 1:\n\t\trf_tech = NFC_DIGITAL_RF_TECH_212F;\n\t\tbreak;\n\tcase 2:\n\t\trf_tech = NFC_DIGITAL_RF_TECH_424F;\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Unsupported dsi value %d\\n\", dsi);\n\t\tgoto exit;\n\t}\n\n\tpayload_bits = DIGITAL_PAYLOAD_FSL_TO_BITS(psl_req->fsl);\n\tpayload_size = digital_payload_bits_to_size(payload_bits);\n\n\tif (!payload_size || (payload_size > min(ddev->local_payload_max,\n\t\t\t\t\t\t ddev->remote_payload_max))) {\n\t\trc = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\tddev->local_payload_max = payload_size;\n\tddev->remote_payload_max = payload_size;\n\n\trc = digital_tg_send_psl_res(ddev, psl_req->did, rf_tech);\n\nexit:\n\tkfree_skb(resp);\n}\n\nstatic void digital_tg_send_atr_res_complete(struct nfc_digital_dev *ddev,\n\t\t\t\t\t     void *arg, struct sk_buff *resp)\n{\n\tint offset;\n\n\tif (IS_ERR(resp)) {\n\t\tdigital_poll_next_tech(ddev);\n\t\treturn;\n\t}\n\n\toffset = 2;\n\tif (resp->data[0] == DIGITAL_NFC_DEP_NFCA_SOD_SB)\n\t\toffset++;\n\n\tddev->atn_count = 0;\n\n\tif (resp->data[offset] == DIGITAL_CMD_PSL_REQ)\n\t\tdigital_tg_recv_psl_req(ddev, arg, resp);\n\telse\n\t\tdigital_tg_recv_dep_req(ddev, arg, resp);\n}\n\nstatic int digital_tg_send_atr_res(struct nfc_digital_dev *ddev,\n\t\t\t\t   struct digital_atr_req *atr_req)\n{\n\tstruct digital_atr_res *atr_res;\n\tstruct sk_buff *skb;\n\tu8 *gb, payload_bits;\n\tsize_t gb_len;\n\tint rc;\n\n\tgb = nfc_get_local_general_bytes(ddev->nfc_dev, &gb_len);\n\tif (!gb)\n\t\tgb_len = 0;\n\n\tskb = digital_skb_alloc(ddev, sizeof(struct digital_atr_res) + gb_len);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_put(skb, sizeof(struct digital_atr_res));\n\tatr_res = (struct digital_atr_res *)skb->data;\n\n\tmemset(atr_res, 0, sizeof(struct digital_atr_res));\n\n\tatr_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\n\tatr_res->cmd = DIGITAL_CMD_ATR_RES;\n\tmemcpy(atr_res->nfcid3, atr_req->nfcid3, sizeof(atr_req->nfcid3));\n\tatr_res->to = DIGITAL_NFC_DEP_TG_MAX_WT;\n\n\tddev->local_payload_max = DIGITAL_PAYLOAD_SIZE_MAX;\n\tpayload_bits = digital_payload_size_to_bits(ddev->local_payload_max);\n\tatr_res->pp = DIGITAL_PAYLOAD_BITS_TO_PP(payload_bits);\n\n\tif (gb_len) {\n\t\tskb_put(skb, gb_len);\n\n\t\tatr_res->pp |= DIGITAL_GB_BIT;\n\t\tmemcpy(atr_res->gb, gb, gb_len);\n\t}\n\n\tdigital_skb_push_dep_sod(ddev, skb);\n\n\tddev->skb_add_crc(skb);\n\n\tddev->curr_nfc_dep_pni = 0;\n\n\trc = digital_tg_send_cmd(ddev, skb, 999,\n\t\t\t\t digital_tg_send_atr_res_complete, NULL);\n\tif (rc)\n\t\tkfree_skb(skb);\n\n\treturn rc;\n}\n\nvoid digital_tg_recv_atr_req(struct nfc_digital_dev *ddev, void *arg,\n\t\t\t     struct sk_buff *resp)\n{\n\tint rc;\n\tstruct digital_atr_req *atr_req;\n\tsize_t gb_len, min_size;\n\tu8 poll_tech_count, payload_bits;\n\n\tif (IS_ERR(resp)) {\n\t\trc = PTR_ERR(resp);\n\t\tresp = NULL;\n\t\tgoto exit;\n\t}\n\n\tif (!resp->len) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tif (resp->data[0] == DIGITAL_NFC_DEP_NFCA_SOD_SB) {\n\t\tmin_size = DIGITAL_ATR_REQ_MIN_SIZE + 2;\n\t\tdigital_tg_set_rf_tech(ddev, NFC_DIGITAL_RF_TECH_106A);\n\t} else {\n\t\tmin_size = DIGITAL_ATR_REQ_MIN_SIZE + 1;\n\t\tdigital_tg_set_rf_tech(ddev, NFC_DIGITAL_RF_TECH_212F);\n\t}\n\n\tif (resp->len < min_size) {\n\t\trc = -EIO;\n\t\tgoto exit;\n\t}\n\n\tddev->curr_protocol = NFC_PROTO_NFC_DEP_MASK;\n\n\trc = ddev->skb_check_crc(resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.6\");\n\t\tgoto exit;\n\t}\n\n\trc = digital_skb_pull_dep_sod(ddev, resp);\n\tif (rc) {\n\t\tPROTOCOL_ERR(\"14.4.1.2\");\n\t\tgoto exit;\n\t}\n\n\tatr_req = (struct digital_atr_req *)resp->data;\n\n\tif (atr_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\n\t    atr_req->cmd != DIGITAL_CMD_ATR_REQ ||\n\t    atr_req->did > DIGITAL_DID_MAX) {\n\t\trc = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\tpayload_bits = DIGITAL_PAYLOAD_PP_TO_BITS(atr_req->pp);\n\tddev->remote_payload_max = digital_payload_bits_to_size(payload_bits);\n\n\tif (!ddev->remote_payload_max) {\n\t\trc = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\tddev->did = atr_req->did;\n\n\trc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\n\t\t\t\t     NFC_DIGITAL_FRAMING_NFC_DEP_ACTIVATED);\n\tif (rc)\n\t\tgoto exit;\n\n\trc = digital_tg_send_atr_res(ddev, atr_req);\n\tif (rc)\n\t\tgoto exit;\n\n\tgb_len = resp->len - sizeof(struct digital_atr_req);\n\n\tpoll_tech_count = ddev->poll_tech_count;\n\tddev->poll_tech_count = 0;\n\n\trc = nfc_tm_activated(ddev->nfc_dev, NFC_PROTO_NFC_DEP_MASK,\n\t\t\t      NFC_COMM_PASSIVE, atr_req->gb, gb_len);\n\tif (rc) {\n\t\tddev->poll_tech_count = poll_tech_count;\n\t\tgoto exit;\n\t}\n\n\trc = 0;\nexit:\n\tif (rc)\n\t\tdigital_poll_next_tech(ddev);\n\n\tdev_kfree_skb(resp);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}