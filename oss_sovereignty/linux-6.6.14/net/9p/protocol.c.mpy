{
  "module_name": "protocol.c",
  "hash_id": "f56f3c14d1819f376ccee2e0ddad1c0b585db00b7e53c3cb1fca111982c594f8",
  "original_prompt": "Ingested from linux-6.6.14/net/9p/protocol.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/uaccess.h>\n#include <linux/slab.h>\n#include <linux/sched.h>\n#include <linux/stddef.h>\n#include <linux/types.h>\n#include <linux/uio.h>\n#include <net/9p/9p.h>\n#include <net/9p/client.h>\n#include \"protocol.h\"\n\n#include <trace/events/9p.h>\n\n \n#define P9_STRLEN(s) \\\n\t(2 + min_t(size_t, s ? strlen(s) : 0, USHRT_MAX))\n\n \nsize_t p9_msg_buf_size(struct p9_client *c, enum p9_msg_t type,\n\t\t\tconst char *fmt, va_list ap)\n{\n\t \n\tconst int hdr = 4 + 1 + 2;\n\t \n\tconst int rerror_size = hdr + P9_ERRMAX + 4;\n\t \n\tconst int rlerror_size = hdr + 4;\n\tconst int err_size =\n\t\tc->proto_version == p9_proto_2000L ? rlerror_size : rerror_size;\n\n\tstatic_assert(NAME_MAX <= 4*1024, \"p9_msg_buf_size() currently assumes \"\n\t\t\t\t  \"a max. allowed directory entry name length of 4k\");\n\n\tswitch (type) {\n\n\t \n\tcase P9_TERROR:\n\tcase P9_TLERROR:\n\tcase P9_TAUTH:\n\tcase P9_RAUTH:\n\t\tBUG();\n\n\t \n\tcase P9_TATTACH:\n\t\tBUG_ON(strcmp(\"ddss?u\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tconst char *uname = va_arg(ap, const char *);\n\t\t\tconst char *aname = va_arg(ap, const char *);\n\t\t\t \n\t\t\treturn hdr + 4 + 4 + P9_STRLEN(uname) + P9_STRLEN(aname) + 4;\n\t\t}\n\tcase P9_TWALK:\n\t\tBUG_ON(strcmp(\"ddT\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tuint i, nwname = va_arg(ap, int);\n\t\t\tsize_t wname_all;\n\t\t\tconst char **wnames = va_arg(ap, const char **);\n\t\t\tfor (i = 0, wname_all = 0; i < nwname; ++i) {\n\t\t\t\twname_all += P9_STRLEN(wnames[i]);\n\t\t\t}\n\t\t\t \n\t\t\treturn hdr + 4 + 4 + 2 + wname_all;\n\t\t}\n\tcase P9_RWALK:\n\t\tBUG_ON(strcmp(\"ddT\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tuint nwname = va_arg(ap, int);\n\t\t\t \n\t\t\treturn max_t(size_t, hdr + 2 + nwname * 13, err_size);\n\t\t}\n\tcase P9_TCREATE:\n\t\tBUG_ON(strcmp(\"dsdb?s\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tconst char *name = va_arg(ap, const char *);\n\t\t\tif (c->proto_version == p9_proto_legacy) {\n\t\t\t\t \n\t\t\t\treturn hdr + 4 + P9_STRLEN(name) + 4 + 1;\n\t\t\t} else {\n\t\t\t\tva_arg(ap, int32_t);\n\t\t\t\tva_arg(ap, int);\n\t\t\t\t{\n\t\t\t\t\tconst char *ext = va_arg(ap, const char *);\n\t\t\t\t\t \n\t\t\t\t\treturn hdr + 4 + P9_STRLEN(name) + 4 + 1 + P9_STRLEN(ext);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\tcase P9_TLCREATE:\n\t\tBUG_ON(strcmp(\"dsddg\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tconst char *name = va_arg(ap, const char *);\n\t\t\t \n\t\t\treturn hdr + 4 + P9_STRLEN(name) + 4 + 4 + 4;\n\t\t}\n\tcase P9_RREAD:\n\tcase P9_RREADDIR:\n\t\tBUG_ON(strcmp(\"dqd\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\tva_arg(ap, int64_t);\n\t\t{\n\t\t\tconst int32_t count = va_arg(ap, int32_t);\n\t\t\t \n\t\t\treturn max_t(size_t, hdr + 4 + count, err_size);\n\t\t}\n\tcase P9_TWRITE:\n\t\tBUG_ON(strcmp(\"dqV\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\tva_arg(ap, int64_t);\n\t\t{\n\t\t\tconst int32_t count = va_arg(ap, int32_t);\n\t\t\t \n\t\t\treturn hdr + 4 + 8 + 4 + count;\n\t\t}\n\tcase P9_TRENAMEAT:\n\t\tBUG_ON(strcmp(\"dsds\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tconst char *oldname, *newname;\n\t\t\toldname = va_arg(ap, const char *);\n\t\t\tva_arg(ap, int32_t);\n\t\t\tnewname = va_arg(ap, const char *);\n\t\t\t \n\t\t\treturn hdr + 4 + P9_STRLEN(oldname) + 4 + P9_STRLEN(newname);\n\t\t}\n\tcase P9_TSYMLINK:\n\t\tBUG_ON(strcmp(\"dssg\", fmt));\n\t\tva_arg(ap, int32_t);\n\t\t{\n\t\t\tconst char *name = va_arg(ap, const char *);\n\t\t\tconst char *symtgt = va_arg(ap, const char *);\n\t\t\t \n\t\t\treturn hdr + 4 + P9_STRLEN(name) + P9_STRLEN(symtgt) + 4;\n\t\t}\n\n\tcase P9_RERROR:\n\t\treturn rerror_size;\n\tcase P9_RLERROR:\n\t\treturn rlerror_size;\n\n\t \n\tcase P9_TWSTAT:\n\tcase P9_RSTAT:\n\tcase P9_RREADLINK:\n\tcase P9_TXATTRWALK:\n\tcase P9_TXATTRCREATE:\n\tcase P9_TLINK:\n\tcase P9_TMKDIR:\n\tcase P9_TMKNOD:\n\tcase P9_TRENAME:\n\tcase P9_TUNLINKAT:\n\tcase P9_TLOCK:\n\t\treturn 8 * 1024;\n\n\t \n\tdefault:\n\t\treturn 4 * 1024;\n\n\t}\n}\n\nstatic int\np9pdu_writef(struct p9_fcall *pdu, int proto_version, const char *fmt, ...);\n\nvoid p9stat_free(struct p9_wstat *stbuf)\n{\n\tkfree(stbuf->name);\n\tstbuf->name = NULL;\n\tkfree(stbuf->uid);\n\tstbuf->uid = NULL;\n\tkfree(stbuf->gid);\n\tstbuf->gid = NULL;\n\tkfree(stbuf->muid);\n\tstbuf->muid = NULL;\n\tkfree(stbuf->extension);\n\tstbuf->extension = NULL;\n}\nEXPORT_SYMBOL(p9stat_free);\n\nsize_t pdu_read(struct p9_fcall *pdu, void *data, size_t size)\n{\n\tsize_t len = min(pdu->size - pdu->offset, size);\n\n\tmemcpy(data, &pdu->sdata[pdu->offset], len);\n\tpdu->offset += len;\n\treturn size - len;\n}\n\nstatic size_t pdu_write(struct p9_fcall *pdu, const void *data, size_t size)\n{\n\tsize_t len = min(pdu->capacity - pdu->size, size);\n\n\tmemcpy(&pdu->sdata[pdu->size], data, len);\n\tpdu->size += len;\n\treturn size - len;\n}\n\nstatic size_t\npdu_write_u(struct p9_fcall *pdu, struct iov_iter *from, size_t size)\n{\n\tsize_t len = min(pdu->capacity - pdu->size, size);\n\n\tif (!copy_from_iter_full(&pdu->sdata[pdu->size], len, from))\n\t\tlen = 0;\n\n\tpdu->size += len;\n\treturn size - len;\n}\n\n \n\nstatic int\np9pdu_vreadf(struct p9_fcall *pdu, int proto_version, const char *fmt,\n\t     va_list ap)\n{\n\tconst char *ptr;\n\tint errcode = 0;\n\n\tfor (ptr = fmt; *ptr; ptr++) {\n\t\tswitch (*ptr) {\n\t\tcase 'b':{\n\t\t\t\tint8_t *val = va_arg(ap, int8_t *);\n\t\t\t\tif (pdu_read(pdu, val, sizeof(*val))) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'w':{\n\t\t\t\tint16_t *val = va_arg(ap, int16_t *);\n\t\t\t\t__le16 le_val;\n\t\t\t\tif (pdu_read(pdu, &le_val, sizeof(le_val))) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t*val = le16_to_cpu(le_val);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'd':{\n\t\t\t\tint32_t *val = va_arg(ap, int32_t *);\n\t\t\t\t__le32 le_val;\n\t\t\t\tif (pdu_read(pdu, &le_val, sizeof(le_val))) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t*val = le32_to_cpu(le_val);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'q':{\n\t\t\t\tint64_t *val = va_arg(ap, int64_t *);\n\t\t\t\t__le64 le_val;\n\t\t\t\tif (pdu_read(pdu, &le_val, sizeof(le_val))) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t*val = le64_to_cpu(le_val);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 's':{\n\t\t\t\tchar **sptr = va_arg(ap, char **);\n\t\t\t\tuint16_t len;\n\n\t\t\t\terrcode = p9pdu_readf(pdu, proto_version,\n\t\t\t\t\t\t\t\t\"w\", &len);\n\t\t\t\tif (errcode)\n\t\t\t\t\tbreak;\n\n\t\t\t\t*sptr = kmalloc(len + 1, GFP_NOFS);\n\t\t\t\tif (*sptr == NULL) {\n\t\t\t\t\terrcode = -ENOMEM;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (pdu_read(pdu, *sptr, len)) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tkfree(*sptr);\n\t\t\t\t\t*sptr = NULL;\n\t\t\t\t} else\n\t\t\t\t\t(*sptr)[len] = 0;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'u': {\n\t\t\t\tkuid_t *uid = va_arg(ap, kuid_t *);\n\t\t\t\t__le32 le_val;\n\t\t\t\tif (pdu_read(pdu, &le_val, sizeof(le_val))) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t*uid = make_kuid(&init_user_ns,\n\t\t\t\t\t\t le32_to_cpu(le_val));\n\t\t\t} break;\n\t\tcase 'g': {\n\t\t\t\tkgid_t *gid = va_arg(ap, kgid_t *);\n\t\t\t\t__le32 le_val;\n\t\t\t\tif (pdu_read(pdu, &le_val, sizeof(le_val))) {\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t*gid = make_kgid(&init_user_ns,\n\t\t\t\t\t\t le32_to_cpu(le_val));\n\t\t\t} break;\n\t\tcase 'Q':{\n\t\t\t\tstruct p9_qid *qid =\n\t\t\t\t    va_arg(ap, struct p9_qid *);\n\n\t\t\t\terrcode = p9pdu_readf(pdu, proto_version, \"bdq\",\n\t\t\t\t\t\t      &qid->type, &qid->version,\n\t\t\t\t\t\t      &qid->path);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'S':{\n\t\t\t\tstruct p9_wstat *stbuf =\n\t\t\t\t    va_arg(ap, struct p9_wstat *);\n\n\t\t\t\tmemset(stbuf, 0, sizeof(struct p9_wstat));\n\t\t\t\tstbuf->n_uid = stbuf->n_muid = INVALID_UID;\n\t\t\t\tstbuf->n_gid = INVALID_GID;\n\n\t\t\t\terrcode =\n\t\t\t\t    p9pdu_readf(pdu, proto_version,\n\t\t\t\t\t\t\"wwdQdddqssss?sugu\",\n\t\t\t\t\t\t&stbuf->size, &stbuf->type,\n\t\t\t\t\t\t&stbuf->dev, &stbuf->qid,\n\t\t\t\t\t\t&stbuf->mode, &stbuf->atime,\n\t\t\t\t\t\t&stbuf->mtime, &stbuf->length,\n\t\t\t\t\t\t&stbuf->name, &stbuf->uid,\n\t\t\t\t\t\t&stbuf->gid, &stbuf->muid,\n\t\t\t\t\t\t&stbuf->extension,\n\t\t\t\t\t\t&stbuf->n_uid, &stbuf->n_gid,\n\t\t\t\t\t\t&stbuf->n_muid);\n\t\t\t\tif (errcode)\n\t\t\t\t\tp9stat_free(stbuf);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'D':{\n\t\t\t\tuint32_t *count = va_arg(ap, uint32_t *);\n\t\t\t\tvoid **data = va_arg(ap, void **);\n\n\t\t\t\terrcode =\n\t\t\t\t    p9pdu_readf(pdu, proto_version, \"d\", count);\n\t\t\t\tif (!errcode) {\n\t\t\t\t\t*count =\n\t\t\t\t\t    min_t(uint32_t, *count,\n\t\t\t\t\t\t  pdu->size - pdu->offset);\n\t\t\t\t\t*data = &pdu->sdata[pdu->offset];\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'T':{\n\t\t\t\tuint16_t *nwname = va_arg(ap, uint16_t *);\n\t\t\t\tchar ***wnames = va_arg(ap, char ***);\n\n\t\t\t\t*wnames = NULL;\n\n\t\t\t\terrcode = p9pdu_readf(pdu, proto_version,\n\t\t\t\t\t\t\t\t\"w\", nwname);\n\t\t\t\tif (!errcode) {\n\t\t\t\t\t*wnames =\n\t\t\t\t\t    kmalloc_array(*nwname,\n\t\t\t\t\t\t\t  sizeof(char *),\n\t\t\t\t\t\t\t  GFP_NOFS);\n\t\t\t\t\tif (!*wnames)\n\t\t\t\t\t\terrcode = -ENOMEM;\n\t\t\t\t\telse\n\t\t\t\t\t\t(*wnames)[0] = NULL;\n\t\t\t\t}\n\n\t\t\t\tif (!errcode) {\n\t\t\t\t\tint i;\n\n\t\t\t\t\tfor (i = 0; i < *nwname; i++) {\n\t\t\t\t\t\terrcode =\n\t\t\t\t\t\t    p9pdu_readf(pdu,\n\t\t\t\t\t\t\t\tproto_version,\n\t\t\t\t\t\t\t\t\"s\",\n\t\t\t\t\t\t\t\t&(*wnames)[i]);\n\t\t\t\t\t\tif (errcode) {\n\t\t\t\t\t\t\t(*wnames)[i] = NULL;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (errcode) {\n\t\t\t\t\tif (*wnames) {\n\t\t\t\t\t\tint i;\n\n\t\t\t\t\t\tfor (i = 0; i < *nwname; i++) {\n\t\t\t\t\t\t\tif (!(*wnames)[i])\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tkfree((*wnames)[i]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tkfree(*wnames);\n\t\t\t\t\t\t*wnames = NULL;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'R':{\n\t\t\t\tuint16_t *nwqid = va_arg(ap, uint16_t *);\n\t\t\t\tstruct p9_qid **wqids =\n\t\t\t\t    va_arg(ap, struct p9_qid **);\n\n\t\t\t\t*wqids = NULL;\n\n\t\t\t\terrcode =\n\t\t\t\t    p9pdu_readf(pdu, proto_version, \"w\", nwqid);\n\t\t\t\tif (!errcode) {\n\t\t\t\t\t*wqids =\n\t\t\t\t\t    kmalloc_array(*nwqid,\n\t\t\t\t\t\t\t  sizeof(struct p9_qid),\n\t\t\t\t\t\t\t  GFP_NOFS);\n\t\t\t\t\tif (*wqids == NULL)\n\t\t\t\t\t\terrcode = -ENOMEM;\n\t\t\t\t}\n\n\t\t\t\tif (!errcode) {\n\t\t\t\t\tint i;\n\n\t\t\t\t\tfor (i = 0; i < *nwqid; i++) {\n\t\t\t\t\t\terrcode =\n\t\t\t\t\t\t    p9pdu_readf(pdu,\n\t\t\t\t\t\t\t\tproto_version,\n\t\t\t\t\t\t\t\t\"Q\",\n\t\t\t\t\t\t\t\t&(*wqids)[i]);\n\t\t\t\t\t\tif (errcode)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (errcode) {\n\t\t\t\t\tkfree(*wqids);\n\t\t\t\t\t*wqids = NULL;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'A': {\n\t\t\t\tstruct p9_stat_dotl *stbuf =\n\t\t\t\t    va_arg(ap, struct p9_stat_dotl *);\n\n\t\t\t\tmemset(stbuf, 0, sizeof(struct p9_stat_dotl));\n\t\t\t\terrcode =\n\t\t\t\t    p9pdu_readf(pdu, proto_version,\n\t\t\t\t\t\"qQdugqqqqqqqqqqqqqqq\",\n\t\t\t\t\t&stbuf->st_result_mask,\n\t\t\t\t\t&stbuf->qid,\n\t\t\t\t\t&stbuf->st_mode,\n\t\t\t\t\t&stbuf->st_uid, &stbuf->st_gid,\n\t\t\t\t\t&stbuf->st_nlink,\n\t\t\t\t\t&stbuf->st_rdev, &stbuf->st_size,\n\t\t\t\t\t&stbuf->st_blksize, &stbuf->st_blocks,\n\t\t\t\t\t&stbuf->st_atime_sec,\n\t\t\t\t\t&stbuf->st_atime_nsec,\n\t\t\t\t\t&stbuf->st_mtime_sec,\n\t\t\t\t\t&stbuf->st_mtime_nsec,\n\t\t\t\t\t&stbuf->st_ctime_sec,\n\t\t\t\t\t&stbuf->st_ctime_nsec,\n\t\t\t\t\t&stbuf->st_btime_sec,\n\t\t\t\t\t&stbuf->st_btime_nsec,\n\t\t\t\t\t&stbuf->st_gen,\n\t\t\t\t\t&stbuf->st_data_version);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase '?':\n\t\t\tif ((proto_version != p9_proto_2000u) &&\n\t\t\t\t(proto_version != p9_proto_2000L))\n\t\t\t\treturn 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tBUG();\n\t\t\tbreak;\n\t\t}\n\n\t\tif (errcode)\n\t\t\tbreak;\n\t}\n\n\treturn errcode;\n}\n\nint\np9pdu_vwritef(struct p9_fcall *pdu, int proto_version, const char *fmt,\n\tva_list ap)\n{\n\tconst char *ptr;\n\tint errcode = 0;\n\n\tfor (ptr = fmt; *ptr; ptr++) {\n\t\tswitch (*ptr) {\n\t\tcase 'b':{\n\t\t\t\tint8_t val = va_arg(ap, int);\n\t\t\t\tif (pdu_write(pdu, &val, sizeof(val)))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'w':{\n\t\t\t\t__le16 val = cpu_to_le16(va_arg(ap, int));\n\t\t\t\tif (pdu_write(pdu, &val, sizeof(val)))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'd':{\n\t\t\t\t__le32 val = cpu_to_le32(va_arg(ap, int32_t));\n\t\t\t\tif (pdu_write(pdu, &val, sizeof(val)))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'q':{\n\t\t\t\t__le64 val = cpu_to_le64(va_arg(ap, int64_t));\n\t\t\t\tif (pdu_write(pdu, &val, sizeof(val)))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 's':{\n\t\t\t\tconst char *sptr = va_arg(ap, const char *);\n\t\t\t\tuint16_t len = 0;\n\t\t\t\tif (sptr)\n\t\t\t\t\tlen = min_t(size_t, strlen(sptr),\n\t\t\t\t\t\t\t\tUSHRT_MAX);\n\n\t\t\t\terrcode = p9pdu_writef(pdu, proto_version,\n\t\t\t\t\t\t\t\t\"w\", len);\n\t\t\t\tif (!errcode && pdu_write(pdu, sptr, len))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'u': {\n\t\t\t\tkuid_t uid = va_arg(ap, kuid_t);\n\t\t\t\t__le32 val = cpu_to_le32(\n\t\t\t\t\t\tfrom_kuid(&init_user_ns, uid));\n\t\t\t\tif (pdu_write(pdu, &val, sizeof(val)))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t} break;\n\t\tcase 'g': {\n\t\t\t\tkgid_t gid = va_arg(ap, kgid_t);\n\t\t\t\t__le32 val = cpu_to_le32(\n\t\t\t\t\t\tfrom_kgid(&init_user_ns, gid));\n\t\t\t\tif (pdu_write(pdu, &val, sizeof(val)))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t} break;\n\t\tcase 'Q':{\n\t\t\t\tconst struct p9_qid *qid =\n\t\t\t\t    va_arg(ap, const struct p9_qid *);\n\t\t\t\terrcode =\n\t\t\t\t    p9pdu_writef(pdu, proto_version, \"bdq\",\n\t\t\t\t\t\t qid->type, qid->version,\n\t\t\t\t\t\t qid->path);\n\t\t\t} break;\n\t\tcase 'S':{\n\t\t\t\tconst struct p9_wstat *stbuf =\n\t\t\t\t    va_arg(ap, const struct p9_wstat *);\n\t\t\t\terrcode =\n\t\t\t\t    p9pdu_writef(pdu, proto_version,\n\t\t\t\t\t\t \"wwdQdddqssss?sugu\",\n\t\t\t\t\t\t stbuf->size, stbuf->type,\n\t\t\t\t\t\t stbuf->dev, &stbuf->qid,\n\t\t\t\t\t\t stbuf->mode, stbuf->atime,\n\t\t\t\t\t\t stbuf->mtime, stbuf->length,\n\t\t\t\t\t\t stbuf->name, stbuf->uid,\n\t\t\t\t\t\t stbuf->gid, stbuf->muid,\n\t\t\t\t\t\t stbuf->extension, stbuf->n_uid,\n\t\t\t\t\t\t stbuf->n_gid, stbuf->n_muid);\n\t\t\t} break;\n\t\tcase 'V':{\n\t\t\t\tuint32_t count = va_arg(ap, uint32_t);\n\t\t\t\tstruct iov_iter *from =\n\t\t\t\t\t\tva_arg(ap, struct iov_iter *);\n\t\t\t\terrcode = p9pdu_writef(pdu, proto_version, \"d\",\n\t\t\t\t\t\t\t\t\tcount);\n\t\t\t\tif (!errcode && pdu_write_u(pdu, from, count))\n\t\t\t\t\terrcode = -EFAULT;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'T':{\n\t\t\t\tuint16_t nwname = va_arg(ap, int);\n\t\t\t\tconst char **wnames = va_arg(ap, const char **);\n\n\t\t\t\terrcode = p9pdu_writef(pdu, proto_version, \"w\",\n\t\t\t\t\t\t\t\t\tnwname);\n\t\t\t\tif (!errcode) {\n\t\t\t\t\tint i;\n\n\t\t\t\t\tfor (i = 0; i < nwname; i++) {\n\t\t\t\t\t\terrcode =\n\t\t\t\t\t\t    p9pdu_writef(pdu,\n\t\t\t\t\t\t\t\tproto_version,\n\t\t\t\t\t\t\t\t \"s\",\n\t\t\t\t\t\t\t\t wnames[i]);\n\t\t\t\t\t\tif (errcode)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'R':{\n\t\t\t\tuint16_t nwqid = va_arg(ap, int);\n\t\t\t\tstruct p9_qid *wqids =\n\t\t\t\t    va_arg(ap, struct p9_qid *);\n\n\t\t\t\terrcode = p9pdu_writef(pdu, proto_version, \"w\",\n\t\t\t\t\t\t\t\t\tnwqid);\n\t\t\t\tif (!errcode) {\n\t\t\t\t\tint i;\n\n\t\t\t\t\tfor (i = 0; i < nwqid; i++) {\n\t\t\t\t\t\terrcode =\n\t\t\t\t\t\t    p9pdu_writef(pdu,\n\t\t\t\t\t\t\t\tproto_version,\n\t\t\t\t\t\t\t\t \"Q\",\n\t\t\t\t\t\t\t\t &wqids[i]);\n\t\t\t\t\t\tif (errcode)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'I':{\n\t\t\t\tstruct p9_iattr_dotl *p9attr = va_arg(ap,\n\t\t\t\t\t\t\tstruct p9_iattr_dotl *);\n\n\t\t\t\terrcode = p9pdu_writef(pdu, proto_version,\n\t\t\t\t\t\t\t\"ddugqqqqq\",\n\t\t\t\t\t\t\tp9attr->valid,\n\t\t\t\t\t\t\tp9attr->mode,\n\t\t\t\t\t\t\tp9attr->uid,\n\t\t\t\t\t\t\tp9attr->gid,\n\t\t\t\t\t\t\tp9attr->size,\n\t\t\t\t\t\t\tp9attr->atime_sec,\n\t\t\t\t\t\t\tp9attr->atime_nsec,\n\t\t\t\t\t\t\tp9attr->mtime_sec,\n\t\t\t\t\t\t\tp9attr->mtime_nsec);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase '?':\n\t\t\tif ((proto_version != p9_proto_2000u) &&\n\t\t\t\t(proto_version != p9_proto_2000L))\n\t\t\t\treturn 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tBUG();\n\t\t\tbreak;\n\t\t}\n\n\t\tif (errcode)\n\t\t\tbreak;\n\t}\n\n\treturn errcode;\n}\n\nint p9pdu_readf(struct p9_fcall *pdu, int proto_version, const char *fmt, ...)\n{\n\tva_list ap;\n\tint ret;\n\n\tva_start(ap, fmt);\n\tret = p9pdu_vreadf(pdu, proto_version, fmt, ap);\n\tva_end(ap);\n\n\treturn ret;\n}\n\nstatic int\np9pdu_writef(struct p9_fcall *pdu, int proto_version, const char *fmt, ...)\n{\n\tva_list ap;\n\tint ret;\n\n\tva_start(ap, fmt);\n\tret = p9pdu_vwritef(pdu, proto_version, fmt, ap);\n\tva_end(ap);\n\n\treturn ret;\n}\n\nint p9stat_read(struct p9_client *clnt, char *buf, int len, struct p9_wstat *st)\n{\n\tstruct p9_fcall fake_pdu;\n\tint ret;\n\n\tfake_pdu.size = len;\n\tfake_pdu.capacity = len;\n\tfake_pdu.sdata = buf;\n\tfake_pdu.offset = 0;\n\n\tret = p9pdu_readf(&fake_pdu, clnt->proto_version, \"S\", st);\n\tif (ret) {\n\t\tp9_debug(P9_DEBUG_9P, \"<<< p9stat_read failed: %d\\n\", ret);\n\t\ttrace_9p_protocol_dump(clnt, &fake_pdu);\n\t\treturn ret;\n\t}\n\n\treturn fake_pdu.offset;\n}\nEXPORT_SYMBOL(p9stat_read);\n\nint p9pdu_prepare(struct p9_fcall *pdu, int16_t tag, int8_t type)\n{\n\tpdu->id = type;\n\treturn p9pdu_writef(pdu, 0, \"dbw\", 0, type, tag);\n}\n\nint p9pdu_finalize(struct p9_client *clnt, struct p9_fcall *pdu)\n{\n\tint size = pdu->size;\n\tint err;\n\n\tpdu->size = 0;\n\terr = p9pdu_writef(pdu, 0, \"d\", size);\n\tpdu->size = size;\n\n\ttrace_9p_protocol_dump(clnt, pdu);\n\tp9_debug(P9_DEBUG_9P, \">>> size=%d type: %d tag: %d\\n\",\n\t\t pdu->size, pdu->id, pdu->tag);\n\n\treturn err;\n}\n\nvoid p9pdu_reset(struct p9_fcall *pdu)\n{\n\tpdu->offset = 0;\n\tpdu->size = 0;\n}\n\nint p9dirent_read(struct p9_client *clnt, char *buf, int len,\n\t\t  struct p9_dirent *dirent)\n{\n\tstruct p9_fcall fake_pdu;\n\tint ret;\n\tchar *nameptr;\n\n\tfake_pdu.size = len;\n\tfake_pdu.capacity = len;\n\tfake_pdu.sdata = buf;\n\tfake_pdu.offset = 0;\n\n\tret = p9pdu_readf(&fake_pdu, clnt->proto_version, \"Qqbs\", &dirent->qid,\n\t\t\t  &dirent->d_off, &dirent->d_type, &nameptr);\n\tif (ret) {\n\t\tp9_debug(P9_DEBUG_9P, \"<<< p9dirent_read failed: %d\\n\", ret);\n\t\ttrace_9p_protocol_dump(clnt, &fake_pdu);\n\t\treturn ret;\n\t}\n\n\tret = strscpy(dirent->d_name, nameptr, sizeof(dirent->d_name));\n\tif (ret < 0) {\n\t\tp9_debug(P9_DEBUG_ERROR,\n\t\t\t \"On the wire dirent name too long: %s\\n\",\n\t\t\t nameptr);\n\t\tkfree(nameptr);\n\t\treturn ret;\n\t}\n\tkfree(nameptr);\n\n\treturn fake_pdu.offset;\n}\nEXPORT_SYMBOL(p9dirent_read);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}