{
  "module_name": "token_test.c",
  "hash_id": "7b2ce3bf18eae3782c3642da10a1edb32b5fdefbc4013cf2c1b543a46556193f",
  "original_prompt": "Ingested from linux-6.6.14/net/mptcp/token_test.c",
  "human_readable_source": "\n#include <kunit/test.h>\n\n#include \"protocol.h\"\n\nstatic struct mptcp_subflow_request_sock *build_req_sock(struct kunit *test)\n{\n\tstruct mptcp_subflow_request_sock *req;\n\n\treq = kunit_kzalloc(test, sizeof(struct mptcp_subflow_request_sock),\n\t\t\t    GFP_USER);\n\tKUNIT_EXPECT_NOT_ERR_OR_NULL(test, req);\n\tmptcp_token_init_request((struct request_sock *)req);\n\tsock_net_set((struct sock *)req, &init_net);\n\treturn req;\n}\n\nstatic void mptcp_token_test_req_basic(struct kunit *test)\n{\n\tstruct mptcp_subflow_request_sock *req = build_req_sock(test);\n\tstruct mptcp_sock *null_msk = NULL;\n\n\tKUNIT_ASSERT_EQ(test, 0,\n\t\t\tmptcp_token_new_request((struct request_sock *)req));\n\tKUNIT_EXPECT_NE(test, 0, (int)req->token);\n\tKUNIT_EXPECT_PTR_EQ(test, null_msk, mptcp_token_get_sock(&init_net, req->token));\n\n\t \n\tmptcp_token_destroy_request((struct request_sock *)req);\n}\n\nstatic struct inet_connection_sock *build_icsk(struct kunit *test)\n{\n\tstruct inet_connection_sock *icsk;\n\n\ticsk = kunit_kzalloc(test, sizeof(struct inet_connection_sock),\n\t\t\t     GFP_USER);\n\tKUNIT_EXPECT_NOT_ERR_OR_NULL(test, icsk);\n\treturn icsk;\n}\n\nstatic struct mptcp_subflow_context *build_ctx(struct kunit *test)\n{\n\tstruct mptcp_subflow_context *ctx;\n\n\tctx = kunit_kzalloc(test, sizeof(struct mptcp_subflow_context),\n\t\t\t    GFP_USER);\n\tKUNIT_EXPECT_NOT_ERR_OR_NULL(test, ctx);\n\treturn ctx;\n}\n\nstatic struct mptcp_sock *build_msk(struct kunit *test)\n{\n\tstruct mptcp_sock *msk;\n\n\tmsk = kunit_kzalloc(test, sizeof(struct mptcp_sock), GFP_USER);\n\tKUNIT_EXPECT_NOT_ERR_OR_NULL(test, msk);\n\trefcount_set(&((struct sock *)msk)->sk_refcnt, 1);\n\tsock_net_set((struct sock *)msk, &init_net);\n\n\t \n\t((struct sock *)msk)->sk_prot = &tcp_prot;\n\treturn msk;\n}\n\nstatic void mptcp_token_test_msk_basic(struct kunit *test)\n{\n\tstruct inet_connection_sock *icsk = build_icsk(test);\n\tstruct mptcp_subflow_context *ctx = build_ctx(test);\n\tstruct mptcp_sock *msk = build_msk(test);\n\tstruct mptcp_sock *null_msk = NULL;\n\tstruct sock *sk;\n\n\trcu_assign_pointer(icsk->icsk_ulp_data, ctx);\n\tctx->conn = (struct sock *)msk;\n\tsk = (struct sock *)msk;\n\n\tKUNIT_ASSERT_EQ(test, 0,\n\t\t\tmptcp_token_new_connect((struct sock *)icsk));\n\tKUNIT_EXPECT_NE(test, 0, (int)ctx->token);\n\tKUNIT_EXPECT_EQ(test, ctx->token, msk->token);\n\tKUNIT_EXPECT_PTR_EQ(test, msk, mptcp_token_get_sock(&init_net, ctx->token));\n\tKUNIT_EXPECT_EQ(test, 2, (int)refcount_read(&sk->sk_refcnt));\n\n\tmptcp_token_destroy(msk);\n\tKUNIT_EXPECT_PTR_EQ(test, null_msk, mptcp_token_get_sock(&init_net, ctx->token));\n}\n\nstatic void mptcp_token_test_accept(struct kunit *test)\n{\n\tstruct mptcp_subflow_request_sock *req = build_req_sock(test);\n\tstruct mptcp_sock *msk = build_msk(test);\n\n\tKUNIT_ASSERT_EQ(test, 0,\n\t\t\tmptcp_token_new_request((struct request_sock *)req));\n\tmsk->token = req->token;\n\tmptcp_token_accept(req, msk);\n\tKUNIT_EXPECT_PTR_EQ(test, msk, mptcp_token_get_sock(&init_net, msk->token));\n\n\t \n\tmptcp_token_destroy_request((struct request_sock *)req);\n\tKUNIT_EXPECT_PTR_EQ(test, msk, mptcp_token_get_sock(&init_net, msk->token));\n\n\t \n\tmptcp_token_destroy(msk);\n}\n\nstatic void mptcp_token_test_destroyed(struct kunit *test)\n{\n\tstruct mptcp_subflow_request_sock *req = build_req_sock(test);\n\tstruct mptcp_sock *msk = build_msk(test);\n\tstruct mptcp_sock *null_msk = NULL;\n\tstruct sock *sk;\n\n\tsk = (struct sock *)msk;\n\n\tKUNIT_ASSERT_EQ(test, 0,\n\t\t\tmptcp_token_new_request((struct request_sock *)req));\n\tmsk->token = req->token;\n\tmptcp_token_accept(req, msk);\n\n\t \n\trefcount_set(&sk->sk_refcnt, 0);\n\tKUNIT_EXPECT_PTR_EQ(test, null_msk, mptcp_token_get_sock(&init_net, msk->token));\n\n\t \n\tmptcp_token_destroy(msk);\n}\n\nstatic struct kunit_case mptcp_token_test_cases[] = {\n\tKUNIT_CASE(mptcp_token_test_req_basic),\n\tKUNIT_CASE(mptcp_token_test_msk_basic),\n\tKUNIT_CASE(mptcp_token_test_accept),\n\tKUNIT_CASE(mptcp_token_test_destroyed),\n\t{}\n};\n\nstatic struct kunit_suite mptcp_token_suite = {\n\t.name = \"mptcp-token\",\n\t.test_cases = mptcp_token_test_cases,\n};\n\nkunit_test_suite(mptcp_token_suite);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}