{
  "module_name": "secure_seq.c",
  "hash_id": "bd5260248fb1f5a4d1232cc2168bdbd0e9ac5f790451d9861ed053960d5c4b30",
  "original_prompt": "Ingested from linux-6.6.14/net/core/secure_seq.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/cache.h>\n#include <linux/random.h>\n#include <linux/hrtimer.h>\n#include <linux/ktime.h>\n#include <linux/string.h>\n#include <linux/net.h>\n#include <linux/siphash.h>\n#include <net/secure_seq.h>\n\n#if IS_ENABLED(CONFIG_IPV6) || IS_ENABLED(CONFIG_INET)\n#include <linux/in6.h>\n#include <net/tcp.h>\n\nstatic siphash_aligned_key_t net_secret;\nstatic siphash_aligned_key_t ts_secret;\n\n#define EPHEMERAL_PORT_SHUFFLE_PERIOD (10 * HZ)\n\nstatic __always_inline void net_secret_init(void)\n{\n\tnet_get_random_once(&net_secret, sizeof(net_secret));\n}\n\nstatic __always_inline void ts_secret_init(void)\n{\n\tnet_get_random_once(&ts_secret, sizeof(ts_secret));\n}\n#endif\n\n#ifdef CONFIG_INET\nstatic u32 seq_scale(u32 seq)\n{\n\t \n\treturn seq + (ktime_get_real_ns() >> 6);\n}\n#endif\n\n#if IS_ENABLED(CONFIG_IPV6)\nu32 secure_tcpv6_ts_off(const struct net *net,\n\t\t\tconst __be32 *saddr, const __be32 *daddr)\n{\n\tconst struct {\n\t\tstruct in6_addr saddr;\n\t\tstruct in6_addr daddr;\n\t} __aligned(SIPHASH_ALIGNMENT) combined = {\n\t\t.saddr = *(struct in6_addr *)saddr,\n\t\t.daddr = *(struct in6_addr *)daddr,\n\t};\n\n\tif (READ_ONCE(net->ipv4.sysctl_tcp_timestamps) != 1)\n\t\treturn 0;\n\n\tts_secret_init();\n\treturn siphash(&combined, offsetofend(typeof(combined), daddr),\n\t\t       &ts_secret);\n}\nEXPORT_SYMBOL(secure_tcpv6_ts_off);\n\nu32 secure_tcpv6_seq(const __be32 *saddr, const __be32 *daddr,\n\t\t     __be16 sport, __be16 dport)\n{\n\tconst struct {\n\t\tstruct in6_addr saddr;\n\t\tstruct in6_addr daddr;\n\t\t__be16 sport;\n\t\t__be16 dport;\n\t} __aligned(SIPHASH_ALIGNMENT) combined = {\n\t\t.saddr = *(struct in6_addr *)saddr,\n\t\t.daddr = *(struct in6_addr *)daddr,\n\t\t.sport = sport,\n\t\t.dport = dport\n\t};\n\tu32 hash;\n\n\tnet_secret_init();\n\thash = siphash(&combined, offsetofend(typeof(combined), dport),\n\t\t       &net_secret);\n\treturn seq_scale(hash);\n}\nEXPORT_SYMBOL(secure_tcpv6_seq);\n\nu64 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,\n\t\t\t       __be16 dport)\n{\n\tconst struct {\n\t\tstruct in6_addr saddr;\n\t\tstruct in6_addr daddr;\n\t\tunsigned int timeseed;\n\t\t__be16 dport;\n\t} __aligned(SIPHASH_ALIGNMENT) combined = {\n\t\t.saddr = *(struct in6_addr *)saddr,\n\t\t.daddr = *(struct in6_addr *)daddr,\n\t\t.timeseed = jiffies / EPHEMERAL_PORT_SHUFFLE_PERIOD,\n\t\t.dport = dport,\n\t};\n\tnet_secret_init();\n\treturn siphash(&combined, offsetofend(typeof(combined), dport),\n\t\t       &net_secret);\n}\nEXPORT_SYMBOL(secure_ipv6_port_ephemeral);\n#endif\n\n#ifdef CONFIG_INET\nu32 secure_tcp_ts_off(const struct net *net, __be32 saddr, __be32 daddr)\n{\n\tif (READ_ONCE(net->ipv4.sysctl_tcp_timestamps) != 1)\n\t\treturn 0;\n\n\tts_secret_init();\n\treturn siphash_2u32((__force u32)saddr, (__force u32)daddr,\n\t\t\t    &ts_secret);\n}\n\n \nu32 secure_tcp_seq(__be32 saddr, __be32 daddr,\n\t\t   __be16 sport, __be16 dport)\n{\n\tu32 hash;\n\n\tnet_secret_init();\n\thash = siphash_3u32((__force u32)saddr, (__force u32)daddr,\n\t\t\t    (__force u32)sport << 16 | (__force u32)dport,\n\t\t\t    &net_secret);\n\treturn seq_scale(hash);\n}\nEXPORT_SYMBOL_GPL(secure_tcp_seq);\n\nu64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)\n{\n\tnet_secret_init();\n\treturn siphash_4u32((__force u32)saddr, (__force u32)daddr,\n\t\t\t    (__force u16)dport,\n\t\t\t    jiffies / EPHEMERAL_PORT_SHUFFLE_PERIOD,\n\t\t\t    &net_secret);\n}\nEXPORT_SYMBOL_GPL(secure_ipv4_port_ephemeral);\n#endif\n\n#if IS_ENABLED(CONFIG_IP_DCCP)\nu64 secure_dccp_sequence_number(__be32 saddr, __be32 daddr,\n\t\t\t\t__be16 sport, __be16 dport)\n{\n\tu64 seq;\n\tnet_secret_init();\n\tseq = siphash_3u32((__force u32)saddr, (__force u32)daddr,\n\t\t\t   (__force u32)sport << 16 | (__force u32)dport,\n\t\t\t   &net_secret);\n\tseq += ktime_get_real_ns();\n\tseq &= (1ull << 48) - 1;\n\treturn seq;\n}\nEXPORT_SYMBOL(secure_dccp_sequence_number);\n\n#if IS_ENABLED(CONFIG_IPV6)\nu64 secure_dccpv6_sequence_number(__be32 *saddr, __be32 *daddr,\n\t\t\t\t  __be16 sport, __be16 dport)\n{\n\tconst struct {\n\t\tstruct in6_addr saddr;\n\t\tstruct in6_addr daddr;\n\t\t__be16 sport;\n\t\t__be16 dport;\n\t} __aligned(SIPHASH_ALIGNMENT) combined = {\n\t\t.saddr = *(struct in6_addr *)saddr,\n\t\t.daddr = *(struct in6_addr *)daddr,\n\t\t.sport = sport,\n\t\t.dport = dport\n\t};\n\tu64 seq;\n\tnet_secret_init();\n\tseq = siphash(&combined, offsetofend(typeof(combined), dport),\n\t\t      &net_secret);\n\tseq += ktime_get_real_ns();\n\tseq &= (1ull << 48) - 1;\n\treturn seq;\n}\nEXPORT_SYMBOL(secure_dccpv6_sequence_number);\n#endif\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}