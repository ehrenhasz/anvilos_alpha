{
  "module_name": "dst_cache.c",
  "hash_id": "1464e675af460d3d1aa10db7847becc8c8da56b706049c9f83ff0053c1c7d59d",
  "original_prompt": "Ingested from linux-6.6.14/net/core/dst_cache.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/percpu.h>\n#include <net/dst_cache.h>\n#include <net/route.h>\n#if IS_ENABLED(CONFIG_IPV6)\n#include <net/ip6_fib.h>\n#endif\n#include <uapi/linux/in.h>\n\nstruct dst_cache_pcpu {\n\tunsigned long refresh_ts;\n\tstruct dst_entry *dst;\n\tu32 cookie;\n\tunion {\n\t\tstruct in_addr in_saddr;\n\t\tstruct in6_addr in6_saddr;\n\t};\n};\n\nstatic void dst_cache_per_cpu_dst_set(struct dst_cache_pcpu *dst_cache,\n\t\t\t\t      struct dst_entry *dst, u32 cookie)\n{\n\tdst_release(dst_cache->dst);\n\tif (dst)\n\t\tdst_hold(dst);\n\n\tdst_cache->cookie = cookie;\n\tdst_cache->dst = dst;\n}\n\nstatic struct dst_entry *dst_cache_per_cpu_get(struct dst_cache *dst_cache,\n\t\t\t\t\t       struct dst_cache_pcpu *idst)\n{\n\tstruct dst_entry *dst;\n\n\tdst = idst->dst;\n\tif (!dst)\n\t\tgoto fail;\n\n\t \n\tdst_hold(dst);\n\n\tif (unlikely(!time_after(idst->refresh_ts, dst_cache->reset_ts) ||\n\t\t     (dst->obsolete && !dst->ops->check(dst, idst->cookie)))) {\n\t\tdst_cache_per_cpu_dst_set(idst, NULL, 0);\n\t\tdst_release(dst);\n\t\tgoto fail;\n\t}\n\treturn dst;\n\nfail:\n\tidst->refresh_ts = jiffies;\n\treturn NULL;\n}\n\nstruct dst_entry *dst_cache_get(struct dst_cache *dst_cache)\n{\n\tif (!dst_cache->cache)\n\t\treturn NULL;\n\n\treturn dst_cache_per_cpu_get(dst_cache, this_cpu_ptr(dst_cache->cache));\n}\nEXPORT_SYMBOL_GPL(dst_cache_get);\n\nstruct rtable *dst_cache_get_ip4(struct dst_cache *dst_cache, __be32 *saddr)\n{\n\tstruct dst_cache_pcpu *idst;\n\tstruct dst_entry *dst;\n\n\tif (!dst_cache->cache)\n\t\treturn NULL;\n\n\tidst = this_cpu_ptr(dst_cache->cache);\n\tdst = dst_cache_per_cpu_get(dst_cache, idst);\n\tif (!dst)\n\t\treturn NULL;\n\n\t*saddr = idst->in_saddr.s_addr;\n\treturn container_of(dst, struct rtable, dst);\n}\nEXPORT_SYMBOL_GPL(dst_cache_get_ip4);\n\nvoid dst_cache_set_ip4(struct dst_cache *dst_cache, struct dst_entry *dst,\n\t\t       __be32 saddr)\n{\n\tstruct dst_cache_pcpu *idst;\n\n\tif (!dst_cache->cache)\n\t\treturn;\n\n\tidst = this_cpu_ptr(dst_cache->cache);\n\tdst_cache_per_cpu_dst_set(idst, dst, 0);\n\tidst->in_saddr.s_addr = saddr;\n}\nEXPORT_SYMBOL_GPL(dst_cache_set_ip4);\n\n#if IS_ENABLED(CONFIG_IPV6)\nvoid dst_cache_set_ip6(struct dst_cache *dst_cache, struct dst_entry *dst,\n\t\t       const struct in6_addr *saddr)\n{\n\tstruct dst_cache_pcpu *idst;\n\n\tif (!dst_cache->cache)\n\t\treturn;\n\n\tidst = this_cpu_ptr(dst_cache->cache);\n\tdst_cache_per_cpu_dst_set(this_cpu_ptr(dst_cache->cache), dst,\n\t\t\t\t  rt6_get_cookie((struct rt6_info *)dst));\n\tidst->in6_saddr = *saddr;\n}\nEXPORT_SYMBOL_GPL(dst_cache_set_ip6);\n\nstruct dst_entry *dst_cache_get_ip6(struct dst_cache *dst_cache,\n\t\t\t\t    struct in6_addr *saddr)\n{\n\tstruct dst_cache_pcpu *idst;\n\tstruct dst_entry *dst;\n\n\tif (!dst_cache->cache)\n\t\treturn NULL;\n\n\tidst = this_cpu_ptr(dst_cache->cache);\n\tdst = dst_cache_per_cpu_get(dst_cache, idst);\n\tif (!dst)\n\t\treturn NULL;\n\n\t*saddr = idst->in6_saddr;\n\treturn dst;\n}\nEXPORT_SYMBOL_GPL(dst_cache_get_ip6);\n#endif\n\nint dst_cache_init(struct dst_cache *dst_cache, gfp_t gfp)\n{\n\tdst_cache->cache = alloc_percpu_gfp(struct dst_cache_pcpu,\n\t\t\t\t\t    gfp | __GFP_ZERO);\n\tif (!dst_cache->cache)\n\t\treturn -ENOMEM;\n\n\tdst_cache_reset(dst_cache);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(dst_cache_init);\n\nvoid dst_cache_destroy(struct dst_cache *dst_cache)\n{\n\tint i;\n\n\tif (!dst_cache->cache)\n\t\treturn;\n\n\tfor_each_possible_cpu(i)\n\t\tdst_release(per_cpu_ptr(dst_cache->cache, i)->dst);\n\n\tfree_percpu(dst_cache->cache);\n}\nEXPORT_SYMBOL_GPL(dst_cache_destroy);\n\nvoid dst_cache_reset_now(struct dst_cache *dst_cache)\n{\n\tint i;\n\n\tif (!dst_cache->cache)\n\t\treturn;\n\n\tdst_cache->reset_ts = jiffies;\n\tfor_each_possible_cpu(i) {\n\t\tstruct dst_cache_pcpu *idst = per_cpu_ptr(dst_cache->cache, i);\n\t\tstruct dst_entry *dst = idst->dst;\n\n\t\tidst->cookie = 0;\n\t\tidst->dst = NULL;\n\t\tdst_release(dst);\n\t}\n}\nEXPORT_SYMBOL_GPL(dst_cache_reset_now);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}