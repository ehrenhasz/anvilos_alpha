{
  "module_name": "dev_addr_lists_test.c",
  "hash_id": "4b51bc95e2a3ea48d7f836060c3e60fd68cba4d4b4ea3fda7b556803fa23dd53",
  "original_prompt": "Ingested from linux-6.6.14/net/core/dev_addr_lists_test.c",
  "human_readable_source": "\n\n#include <kunit/test.h>\n#include <linux/etherdevice.h>\n#include <linux/netdevice.h>\n#include <linux/rtnetlink.h>\n\nstatic const struct net_device_ops dummy_netdev_ops = {\n};\n\nstruct dev_addr_test_priv {\n\tu32 addr_seen;\n};\n\nstatic int dev_addr_test_sync(struct net_device *netdev, const unsigned char *a)\n{\n\tstruct dev_addr_test_priv *datp = netdev_priv(netdev);\n\n\tif (a[0] < 31 && !memchr_inv(a, a[0], ETH_ALEN))\n\t\tdatp->addr_seen |= 1 << a[0];\n\treturn 0;\n}\n\nstatic int dev_addr_test_unsync(struct net_device *netdev,\n\t\t\t\tconst unsigned char *a)\n{\n\tstruct dev_addr_test_priv *datp = netdev_priv(netdev);\n\n\tif (a[0] < 31 && !memchr_inv(a, a[0], ETH_ALEN))\n\t\tdatp->addr_seen &= ~(1 << a[0]);\n\treturn 0;\n}\n\nstatic int dev_addr_test_init(struct kunit *test)\n{\n\tstruct dev_addr_test_priv *datp;\n\tstruct net_device *netdev;\n\tint err;\n\n\tnetdev = alloc_etherdev(sizeof(*datp));\n\tKUNIT_ASSERT_TRUE(test, !!netdev);\n\n\ttest->priv = netdev;\n\tnetdev->netdev_ops = &dummy_netdev_ops;\n\n\terr = register_netdev(netdev);\n\tif (err) {\n\t\tfree_netdev(netdev);\n\t\tKUNIT_FAIL(test, \"Can't register netdev %d\", err);\n\t}\n\n\trtnl_lock();\n\treturn 0;\n}\n\nstatic void dev_addr_test_exit(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\n\trtnl_unlock();\n\tunregister_netdev(netdev);\n\tfree_netdev(netdev);\n}\n\nstatic void dev_addr_test_basic(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\tu8 addr[ETH_ALEN];\n\n\tKUNIT_EXPECT_TRUE(test, !!netdev->dev_addr);\n\n\tmemset(addr, 2, sizeof(addr));\n\teth_hw_addr_set(netdev, addr);\n\tKUNIT_EXPECT_MEMEQ(test, netdev->dev_addr, addr, sizeof(addr));\n\n\tmemset(addr, 3, sizeof(addr));\n\tdev_addr_set(netdev, addr);\n\tKUNIT_EXPECT_MEMEQ(test, netdev->dev_addr, addr, sizeof(addr));\n}\n\nstatic void dev_addr_test_sync_one(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\tstruct dev_addr_test_priv *datp;\n\tu8 addr[ETH_ALEN];\n\n\tdatp = netdev_priv(netdev);\n\n\tmemset(addr, 1, sizeof(addr));\n\teth_hw_addr_set(netdev, addr);\n\n\t__hw_addr_sync_dev(&netdev->dev_addrs, netdev, dev_addr_test_sync,\n\t\t\t   dev_addr_test_unsync);\n\tKUNIT_EXPECT_EQ(test, 2, datp->addr_seen);\n\n\tmemset(addr, 2, sizeof(addr));\n\teth_hw_addr_set(netdev, addr);\n\n\tdatp->addr_seen = 0;\n\t__hw_addr_sync_dev(&netdev->dev_addrs, netdev, dev_addr_test_sync,\n\t\t\t   dev_addr_test_unsync);\n\t \n\tKUNIT_EXPECT_EQ(test, 0, datp->addr_seen);\n}\n\nstatic void dev_addr_test_add_del(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\tstruct dev_addr_test_priv *datp;\n\tu8 addr[ETH_ALEN];\n\tint i;\n\n\tdatp = netdev_priv(netdev);\n\n\tfor (i = 1; i < 4; i++) {\n\t\tmemset(addr, i, sizeof(addr));\n\t\tKUNIT_EXPECT_EQ(test, 0, dev_addr_add(netdev, addr,\n\t\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\t}\n\t \n\tKUNIT_EXPECT_EQ(test, 0, dev_addr_add(netdev, addr,\n\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\n\t__hw_addr_sync_dev(&netdev->dev_addrs, netdev, dev_addr_test_sync,\n\t\t\t   dev_addr_test_unsync);\n\tKUNIT_EXPECT_EQ(test, 0xf, datp->addr_seen);\n\n\tKUNIT_EXPECT_EQ(test, 0, dev_addr_del(netdev, addr,\n\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\n\t__hw_addr_sync_dev(&netdev->dev_addrs, netdev, dev_addr_test_sync,\n\t\t\t   dev_addr_test_unsync);\n\tKUNIT_EXPECT_EQ(test, 0xf, datp->addr_seen);\n\n\tfor (i = 1; i < 4; i++) {\n\t\tmemset(addr, i, sizeof(addr));\n\t\tKUNIT_EXPECT_EQ(test, 0, dev_addr_del(netdev, addr,\n\t\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\t}\n\n\t__hw_addr_sync_dev(&netdev->dev_addrs, netdev, dev_addr_test_sync,\n\t\t\t   dev_addr_test_unsync);\n\tKUNIT_EXPECT_EQ(test, 1, datp->addr_seen);\n}\n\nstatic void dev_addr_test_del_main(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\tu8 addr[ETH_ALEN];\n\n\tmemset(addr, 1, sizeof(addr));\n\teth_hw_addr_set(netdev, addr);\n\n\tKUNIT_EXPECT_EQ(test, -ENOENT, dev_addr_del(netdev, addr,\n\t\t\t\t\t\t    NETDEV_HW_ADDR_T_LAN));\n\tKUNIT_EXPECT_EQ(test, 0, dev_addr_add(netdev, addr,\n\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\tKUNIT_EXPECT_EQ(test, 0, dev_addr_del(netdev, addr,\n\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\tKUNIT_EXPECT_EQ(test, -ENOENT, dev_addr_del(netdev, addr,\n\t\t\t\t\t\t    NETDEV_HW_ADDR_T_LAN));\n}\n\nstatic void dev_addr_test_add_set(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\tstruct dev_addr_test_priv *datp;\n\tu8 addr[ETH_ALEN];\n\tint i;\n\n\tdatp = netdev_priv(netdev);\n\n\t \n\tfor (i = 1; i < 16; i++) {\n\t\tmemset(addr, i, sizeof(addr));\n\t\tKUNIT_EXPECT_EQ(test, 0, dev_addr_add(netdev, addr,\n\t\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\t}\n\n\tmemset(addr, i, sizeof(addr));\n\teth_hw_addr_set(netdev, addr);\n\tKUNIT_EXPECT_EQ(test, 0, dev_addr_add(netdev, addr,\n\t\t\t\t\t      NETDEV_HW_ADDR_T_LAN));\n\tmemset(addr, 0, sizeof(addr));\n\teth_hw_addr_set(netdev, addr);\n\n\t__hw_addr_sync_dev(&netdev->dev_addrs, netdev, dev_addr_test_sync,\n\t\t\t   dev_addr_test_unsync);\n\tKUNIT_EXPECT_EQ(test, 0xffff, datp->addr_seen);\n}\n\nstatic void dev_addr_test_add_excl(struct kunit *test)\n{\n\tstruct net_device *netdev = test->priv;\n\tu8 addr[ETH_ALEN];\n\tint i;\n\n\tfor (i = 0; i < 10; i++) {\n\t\tmemset(addr, i, sizeof(addr));\n\t\tKUNIT_EXPECT_EQ(test, 0, dev_uc_add_excl(netdev, addr));\n\t}\n\tKUNIT_EXPECT_EQ(test, -EEXIST, dev_uc_add_excl(netdev, addr));\n\n\tfor (i = 0; i < 10; i += 2) {\n\t\tmemset(addr, i, sizeof(addr));\n\t\tKUNIT_EXPECT_EQ(test, 0, dev_uc_del(netdev, addr));\n\t}\n\tfor (i = 1; i < 10; i += 2) {\n\t\tmemset(addr, i, sizeof(addr));\n\t\tKUNIT_EXPECT_EQ(test, -EEXIST, dev_uc_add_excl(netdev, addr));\n\t}\n}\n\nstatic struct kunit_case dev_addr_test_cases[] = {\n\tKUNIT_CASE(dev_addr_test_basic),\n\tKUNIT_CASE(dev_addr_test_sync_one),\n\tKUNIT_CASE(dev_addr_test_add_del),\n\tKUNIT_CASE(dev_addr_test_del_main),\n\tKUNIT_CASE(dev_addr_test_add_set),\n\tKUNIT_CASE(dev_addr_test_add_excl),\n\t{}\n};\n\nstatic struct kunit_suite dev_addr_test_suite = {\n\t.name = \"dev-addr-list-test\",\n\t.test_cases = dev_addr_test_cases,\n\t.init = dev_addr_test_init,\n\t.exit = dev_addr_test_exit,\n};\nkunit_test_suite(dev_addr_test_suite);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}