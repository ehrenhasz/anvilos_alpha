{
  "module_name": "hwbm.c",
  "hash_id": "9feac65714e276e2f6b0ccdd364519102627c1d26725a91b99fe88ca3206e117",
  "original_prompt": "Ingested from linux-6.6.14/net/core/hwbm.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/printk.h>\n#include <linux/skbuff.h>\n#include <net/hwbm.h>\n\nvoid hwbm_buf_free(struct hwbm_pool *bm_pool, void *buf)\n{\n\tif (likely(bm_pool->frag_size <= PAGE_SIZE))\n\t\tskb_free_frag(buf);\n\telse\n\t\tkfree(buf);\n}\nEXPORT_SYMBOL_GPL(hwbm_buf_free);\n\n \nint hwbm_pool_refill(struct hwbm_pool *bm_pool, gfp_t gfp)\n{\n\tint frag_size = bm_pool->frag_size;\n\tvoid *buf;\n\n\tif (likely(frag_size <= PAGE_SIZE))\n\t\tbuf = netdev_alloc_frag(frag_size);\n\telse\n\t\tbuf = kmalloc(frag_size, gfp);\n\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tif (bm_pool->construct)\n\t\tif (bm_pool->construct(bm_pool, buf)) {\n\t\t\thwbm_buf_free(bm_pool, buf);\n\t\t\treturn -ENOMEM;\n\t\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hwbm_pool_refill);\n\nint hwbm_pool_add(struct hwbm_pool *bm_pool, unsigned int buf_num)\n{\n\tint err, i;\n\n\tmutex_lock(&bm_pool->buf_lock);\n\tif (bm_pool->buf_num == bm_pool->size) {\n\t\tpr_warn(\"pool already filled\\n\");\n\t\tmutex_unlock(&bm_pool->buf_lock);\n\t\treturn bm_pool->buf_num;\n\t}\n\n\tif (buf_num + bm_pool->buf_num > bm_pool->size) {\n\t\tpr_warn(\"cannot allocate %d buffers for pool\\n\",\n\t\t\tbuf_num);\n\t\tmutex_unlock(&bm_pool->buf_lock);\n\t\treturn 0;\n\t}\n\n\tif ((buf_num + bm_pool->buf_num) < bm_pool->buf_num) {\n\t\tpr_warn(\"Adding %d buffers to the %d current buffers will overflow\\n\",\n\t\t\tbuf_num,  bm_pool->buf_num);\n\t\tmutex_unlock(&bm_pool->buf_lock);\n\t\treturn 0;\n\t}\n\n\tfor (i = 0; i < buf_num; i++) {\n\t\terr = hwbm_pool_refill(bm_pool, GFP_KERNEL);\n\t\tif (err < 0)\n\t\t\tbreak;\n\t}\n\n\t \n\tbm_pool->buf_num += i;\n\n\tpr_debug(\"hwpm pool: %d of %d buffers added\\n\", i, buf_num);\n\tmutex_unlock(&bm_pool->buf_lock);\n\n\treturn i;\n}\nEXPORT_SYMBOL_GPL(hwbm_pool_add);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}