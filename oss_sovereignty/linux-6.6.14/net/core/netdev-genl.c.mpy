{
  "module_name": "netdev-genl.c",
  "hash_id": "d7be88a55e2aa1eab2c9d118fc8038ed2b0d064b5708aeb8167736fc6a00319b",
  "original_prompt": "Ingested from linux-6.6.14/net/core/netdev-genl.c",
  "human_readable_source": "\n\n#include <linux/netdevice.h>\n#include <linux/notifier.h>\n#include <linux/rtnetlink.h>\n#include <net/net_namespace.h>\n#include <net/sock.h>\n\n#include \"netdev-genl-gen.h\"\n\nstatic int\nnetdev_nl_dev_fill(struct net_device *netdev, struct sk_buff *rsp,\n\t\t   const struct genl_info *info)\n{\n\tvoid *hdr;\n\n\thdr = genlmsg_iput(rsp, info);\n\tif (!hdr)\n\t\treturn -EMSGSIZE;\n\n\tif (nla_put_u32(rsp, NETDEV_A_DEV_IFINDEX, netdev->ifindex) ||\n\t    nla_put_u64_64bit(rsp, NETDEV_A_DEV_XDP_FEATURES,\n\t\t\t      netdev->xdp_features, NETDEV_A_DEV_PAD)) {\n\t\tgenlmsg_cancel(rsp, hdr);\n\t\treturn -EINVAL;\n\t}\n\n\tif (netdev->xdp_features & NETDEV_XDP_ACT_XSK_ZEROCOPY) {\n\t\tif (nla_put_u32(rsp, NETDEV_A_DEV_XDP_ZC_MAX_SEGS,\n\t\t\t\tnetdev->xdp_zc_max_segs)) {\n\t\t\tgenlmsg_cancel(rsp, hdr);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tgenlmsg_end(rsp, hdr);\n\n\treturn 0;\n}\n\nstatic void\nnetdev_genl_dev_notify(struct net_device *netdev, int cmd)\n{\n\tstruct genl_info info;\n\tstruct sk_buff *ntf;\n\n\tif (!genl_has_listeners(&netdev_nl_family, dev_net(netdev),\n\t\t\t\tNETDEV_NLGRP_MGMT))\n\t\treturn;\n\n\tgenl_info_init_ntf(&info, &netdev_nl_family, cmd);\n\n\tntf = genlmsg_new(GENLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!ntf)\n\t\treturn;\n\n\tif (netdev_nl_dev_fill(netdev, ntf, &info)) {\n\t\tnlmsg_free(ntf);\n\t\treturn;\n\t}\n\n\tgenlmsg_multicast_netns(&netdev_nl_family, dev_net(netdev), ntf,\n\t\t\t\t0, NETDEV_NLGRP_MGMT, GFP_KERNEL);\n}\n\nint netdev_nl_dev_get_doit(struct sk_buff *skb, struct genl_info *info)\n{\n\tstruct net_device *netdev;\n\tstruct sk_buff *rsp;\n\tu32 ifindex;\n\tint err;\n\n\tif (GENL_REQ_ATTR_CHECK(info, NETDEV_A_DEV_IFINDEX))\n\t\treturn -EINVAL;\n\n\tifindex = nla_get_u32(info->attrs[NETDEV_A_DEV_IFINDEX]);\n\n\trsp = genlmsg_new(GENLMSG_DEFAULT_SIZE, GFP_KERNEL);\n\tif (!rsp)\n\t\treturn -ENOMEM;\n\n\trtnl_lock();\n\n\tnetdev = __dev_get_by_index(genl_info_net(info), ifindex);\n\tif (netdev)\n\t\terr = netdev_nl_dev_fill(netdev, rsp, info);\n\telse\n\t\terr = -ENODEV;\n\n\trtnl_unlock();\n\n\tif (err)\n\t\tgoto err_free_msg;\n\n\treturn genlmsg_reply(rsp, info);\n\nerr_free_msg:\n\tnlmsg_free(rsp);\n\treturn err;\n}\n\nint netdev_nl_dev_get_dumpit(struct sk_buff *skb, struct netlink_callback *cb)\n{\n\tstruct net *net = sock_net(skb->sk);\n\tstruct net_device *netdev;\n\tint err = 0;\n\n\trtnl_lock();\n\tfor_each_netdev_dump(net, netdev, cb->args[0]) {\n\t\terr = netdev_nl_dev_fill(netdev, skb, genl_info_dump(cb));\n\t\tif (err < 0)\n\t\t\tbreak;\n\t}\n\trtnl_unlock();\n\n\tif (err != -EMSGSIZE)\n\t\treturn err;\n\n\treturn skb->len;\n}\n\nstatic int netdev_genl_netdevice_event(struct notifier_block *nb,\n\t\t\t\t       unsigned long event, void *ptr)\n{\n\tstruct net_device *netdev = netdev_notifier_info_to_dev(ptr);\n\n\tswitch (event) {\n\tcase NETDEV_REGISTER:\n\t\tnetdev_genl_dev_notify(netdev, NETDEV_CMD_DEV_ADD_NTF);\n\t\tbreak;\n\tcase NETDEV_UNREGISTER:\n\t\tnetdev_genl_dev_notify(netdev, NETDEV_CMD_DEV_DEL_NTF);\n\t\tbreak;\n\tcase NETDEV_XDP_FEAT_CHANGE:\n\t\tnetdev_genl_dev_notify(netdev, NETDEV_CMD_DEV_CHANGE_NTF);\n\t\tbreak;\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic struct notifier_block netdev_genl_nb = {\n\t.notifier_call\t= netdev_genl_netdevice_event,\n};\n\nstatic int __init netdev_genl_init(void)\n{\n\tint err;\n\n\terr = register_netdevice_notifier(&netdev_genl_nb);\n\tif (err)\n\t\treturn err;\n\n\terr = genl_register_family(&netdev_nl_family);\n\tif (err)\n\t\tgoto err_unreg_ntf;\n\n\treturn 0;\n\nerr_unreg_ntf:\n\tunregister_netdevice_notifier(&netdev_genl_nb);\n\treturn err;\n}\n\nsubsys_initcall(netdev_genl_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}