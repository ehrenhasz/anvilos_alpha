{
  "module_name": "gss_krb5_seal.c",
  "hash_id": "5356f6466885e854b9d1c1981552b7b1357520293752b6096696620c694552cc",
  "original_prompt": "Ingested from linux-6.6.14/net/sunrpc/auth_gss/gss_krb5_seal.c",
  "human_readable_source": " \n\n \n\n \n\n#include <linux/types.h>\n#include <linux/jiffies.h>\n#include <linux/sunrpc/gss_krb5.h>\n#include <linux/random.h>\n#include <linux/crypto.h>\n#include <linux/atomic.h>\n\n#include \"gss_krb5_internal.h\"\n\n#if IS_ENABLED(CONFIG_SUNRPC_DEBUG)\n# define RPCDBG_FACILITY        RPCDBG_AUTH\n#endif\n\nstatic void *\nsetup_token_v2(struct krb5_ctx *ctx, struct xdr_netobj *token)\n{\n\tu16 *ptr;\n\tvoid *krb5_hdr;\n\tu8 *p, flags = 0x00;\n\n\tif ((ctx->flags & KRB5_CTX_FLAG_INITIATOR) == 0)\n\t\tflags |= 0x01;\n\tif (ctx->flags & KRB5_CTX_FLAG_ACCEPTOR_SUBKEY)\n\t\tflags |= 0x04;\n\n\t \n\tkrb5_hdr = (u16 *)token->data;\n\tptr = krb5_hdr;\n\n\t*ptr++ = KG2_TOK_MIC;\n\tp = (u8 *)ptr;\n\t*p++ = flags;\n\t*p++ = 0xff;\n\tptr = (u16 *)p;\n\t*ptr++ = 0xffff;\n\t*ptr = 0xffff;\n\n\ttoken->len = GSS_KRB5_TOK_HDR_LEN + ctx->gk5e->cksumlength;\n\treturn krb5_hdr;\n}\n\nu32\ngss_krb5_get_mic_v2(struct krb5_ctx *ctx, struct xdr_buf *text,\n\t\t    struct xdr_netobj *token)\n{\n\tstruct crypto_ahash *tfm = ctx->initiate ?\n\t\t\t\t   ctx->initiator_sign : ctx->acceptor_sign;\n\tstruct xdr_netobj cksumobj = {\n\t\t.len =\tctx->gk5e->cksumlength,\n\t};\n\t__be64 seq_send_be64;\n\tvoid *krb5_hdr;\n\ttime64_t now;\n\n\tdprintk(\"RPC:       %s\\n\", __func__);\n\n\tkrb5_hdr = setup_token_v2(ctx, token);\n\n\t \n\tseq_send_be64 = cpu_to_be64(atomic64_fetch_inc(&ctx->seq_send64));\n\tmemcpy(krb5_hdr + 8, (char *) &seq_send_be64, 8);\n\n\tcksumobj.data = krb5_hdr + GSS_KRB5_TOK_HDR_LEN;\n\tif (gss_krb5_checksum(tfm, krb5_hdr, GSS_KRB5_TOK_HDR_LEN,\n\t\t\t      text, 0, &cksumobj))\n\t\treturn GSS_S_FAILURE;\n\n\tnow = ktime_get_real_seconds();\n\treturn (ctx->endtime < now) ? GSS_S_CONTEXT_EXPIRED : GSS_S_COMPLETE;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}