{
  "module_name": "xprt_rdma.h",
  "hash_id": "61ecbe96c3e7d8c87df515658b7095dccafc287a57a5d4a1682d517c1e8e1e2d",
  "original_prompt": "Ingested from linux-6.6.14/net/sunrpc/xprtrdma/xprt_rdma.h",
  "human_readable_source": " \n \n\n#ifndef _LINUX_SUNRPC_XPRT_RDMA_H\n#define _LINUX_SUNRPC_XPRT_RDMA_H\n\n#include <linux/wait.h> \t\t \n#include <linux/spinlock.h> \t\t \n#include <linux/atomic.h>\t\t \n#include <linux/kref.h>\t\t\t \n#include <linux/workqueue.h>\t\t \n#include <linux/llist.h>\n\n#include <rdma/rdma_cm.h>\t\t \n#include <rdma/ib_verbs.h>\t\t \n\n#include <linux/sunrpc/clnt.h> \t\t \n#include <linux/sunrpc/rpc_rdma_cid.h> \t \n#include <linux/sunrpc/rpc_rdma.h> \t \n#include <linux/sunrpc/xprtrdma.h> \t \n\n#define RDMA_RESOLVE_TIMEOUT\t(5000)\t \n#define RDMA_CONNECT_RETRY_MAX\t(2)\t \n\n#define RPCRDMA_BIND_TO\t\t(60U * HZ)\n#define RPCRDMA_INIT_REEST_TO\t(5U * HZ)\n#define RPCRDMA_MAX_REEST_TO\t(30U * HZ)\n#define RPCRDMA_IDLE_DISC_TO\t(5U * 60 * HZ)\n\n \nstruct rpcrdma_mr;\nstruct rpcrdma_ep {\n\tstruct kref\t\tre_kref;\n\tstruct rdma_cm_id \t*re_id;\n\tstruct ib_pd\t\t*re_pd;\n\tunsigned int\t\tre_max_rdma_segs;\n\tunsigned int\t\tre_max_fr_depth;\n\tstruct rpcrdma_mr\t*re_write_pad_mr;\n\tenum ib_mr_type\t\tre_mrtype;\n\tstruct completion\tre_done;\n\tunsigned int\t\tre_send_count;\n\tunsigned int\t\tre_send_batch;\n\tunsigned int\t\tre_max_inline_send;\n\tunsigned int\t\tre_max_inline_recv;\n\tint\t\t\tre_async_rc;\n\tint\t\t\tre_connect_status;\n\tatomic_t\t\tre_receiving;\n\tatomic_t\t\tre_force_disconnect;\n\tstruct ib_qp_init_attr\tre_attr;\n\twait_queue_head_t       re_connect_wait;\n\tstruct rpc_xprt\t\t*re_xprt;\n\tstruct rpcrdma_connect_private\n\t\t\t\tre_cm_private;\n\tstruct rdma_conn_param\tre_remote_cma;\n\tint\t\t\tre_receive_count;\n\tunsigned int\t\tre_max_requests;  \n\tunsigned int\t\tre_inline_send;\t \n\tunsigned int\t\tre_inline_recv;\t \n\n\tatomic_t\t\tre_completion_ids;\n\n\tchar\t\t\tre_write_pad[XDR_UNIT];\n};\n\n \n#if defined(CONFIG_SUNRPC_BACKCHANNEL)\n#define RPCRDMA_BACKWARD_WRS (32)\n#else\n#define RPCRDMA_BACKWARD_WRS (0)\n#endif\n\n \n\nstruct rpcrdma_regbuf {\n\tstruct ib_sge\t\trg_iov;\n\tstruct ib_device\t*rg_device;\n\tenum dma_data_direction\trg_direction;\n\tvoid\t\t\t*rg_data;\n};\n\nstatic inline u64 rdmab_addr(struct rpcrdma_regbuf *rb)\n{\n\treturn rb->rg_iov.addr;\n}\n\nstatic inline u32 rdmab_length(struct rpcrdma_regbuf *rb)\n{\n\treturn rb->rg_iov.length;\n}\n\nstatic inline u32 rdmab_lkey(struct rpcrdma_regbuf *rb)\n{\n\treturn rb->rg_iov.lkey;\n}\n\nstatic inline struct ib_device *rdmab_device(struct rpcrdma_regbuf *rb)\n{\n\treturn rb->rg_device;\n}\n\nstatic inline void *rdmab_data(const struct rpcrdma_regbuf *rb)\n{\n\treturn rb->rg_data;\n}\n\n \n#define XPRTRDMA_GFP_FLAGS  (__GFP_NOMEMALLOC | __GFP_NORETRY | __GFP_NOWARN)\n\n \nenum {\n\tRPCRDMA_MAX_HDR_SEGS = 16,\n};\n\n \n\nstruct rpcrdma_rep {\n\tstruct ib_cqe\t\trr_cqe;\n\tstruct rpc_rdma_cid\trr_cid;\n\n\t__be32\t\t\trr_xid;\n\t__be32\t\t\trr_vers;\n\t__be32\t\t\trr_proc;\n\tint\t\t\trr_wc_flags;\n\tu32\t\t\trr_inv_rkey;\n\tbool\t\t\trr_temp;\n\tstruct rpcrdma_regbuf\t*rr_rdmabuf;\n\tstruct rpcrdma_xprt\t*rr_rxprt;\n\tstruct rpc_rqst\t\t*rr_rqst;\n\tstruct xdr_buf\t\trr_hdrbuf;\n\tstruct xdr_stream\trr_stream;\n\tstruct llist_node\trr_node;\n\tstruct ib_recv_wr\trr_recv_wr;\n\tstruct list_head\trr_all;\n};\n\n \nenum {\n\tRPCRDMA_MAX_RECV_BATCH = 7,\n};\n\n \nstruct rpcrdma_req;\nstruct rpcrdma_sendctx {\n\tstruct ib_cqe\t\tsc_cqe;\n\tstruct rpc_rdma_cid\tsc_cid;\n\tstruct rpcrdma_req\t*sc_req;\n\tunsigned int\t\tsc_unmap_count;\n\tstruct ib_sge\t\tsc_sges[];\n};\n\n \nstruct rpcrdma_req;\nstruct rpcrdma_mr {\n\tstruct list_head\tmr_list;\n\tstruct rpcrdma_req\t*mr_req;\n\n\tstruct ib_mr\t\t*mr_ibmr;\n\tstruct ib_device\t*mr_device;\n\tstruct scatterlist\t*mr_sg;\n\tint\t\t\tmr_nents;\n\tenum dma_data_direction\tmr_dir;\n\tstruct ib_cqe\t\tmr_cqe;\n\tstruct completion\tmr_linv_done;\n\tunion {\n\t\tstruct ib_reg_wr\tmr_regwr;\n\t\tstruct ib_send_wr\tmr_invwr;\n\t};\n\tstruct rpcrdma_xprt\t*mr_xprt;\n\tu32\t\t\tmr_handle;\n\tu32\t\t\tmr_length;\n\tu64\t\t\tmr_offset;\n\tstruct list_head\tmr_all;\n\tstruct rpc_rdma_cid\tmr_cid;\n};\n\n \n\n \nenum {\n\tRPCRDMA_MAX_IOV_SEGS\t= 3,\n\tRPCRDMA_MAX_DATA_SEGS\t= ((1 * 1024 * 1024) / PAGE_SIZE) + 1,\n\tRPCRDMA_MAX_SEGS\t= RPCRDMA_MAX_DATA_SEGS +\n\t\t\t\t  RPCRDMA_MAX_IOV_SEGS,\n};\n\n \nstruct rpcrdma_mr_seg {\n\tu32\t\tmr_len;\t\t \n\tstruct page\t*mr_page;\t \n\tu64\t\tmr_offset;\t \n};\n\n \nenum {\n\tRPCRDMA_MIN_SEND_SGES = 3,\n\tRPCRDMA_MAX_PAGE_SGES = RPCRDMA_MAX_INLINE >> PAGE_SHIFT,\n\tRPCRDMA_MAX_SEND_SGES = 1 + 1 + RPCRDMA_MAX_PAGE_SGES + 1,\n};\n\nstruct rpcrdma_buffer;\nstruct rpcrdma_req {\n\tstruct list_head\trl_list;\n\tstruct rpc_rqst\t\trl_slot;\n\tstruct rpcrdma_rep\t*rl_reply;\n\tstruct xdr_stream\trl_stream;\n\tstruct xdr_buf\t\trl_hdrbuf;\n\tstruct ib_send_wr\trl_wr;\n\tstruct rpcrdma_sendctx\t*rl_sendctx;\n\tstruct rpcrdma_regbuf\t*rl_rdmabuf;\t \n\tstruct rpcrdma_regbuf\t*rl_sendbuf;\t \n\tstruct rpcrdma_regbuf\t*rl_recvbuf;\t \n\n\tstruct list_head\trl_all;\n\tstruct kref\t\trl_kref;\n\n\tstruct list_head\trl_free_mrs;\n\tstruct list_head\trl_registered;\n\tstruct rpcrdma_mr_seg\trl_segments[RPCRDMA_MAX_SEGS];\n};\n\nstatic inline struct rpcrdma_req *\nrpcr_to_rdmar(const struct rpc_rqst *rqst)\n{\n\treturn container_of(rqst, struct rpcrdma_req, rl_slot);\n}\n\nstatic inline void\nrpcrdma_mr_push(struct rpcrdma_mr *mr, struct list_head *list)\n{\n\tlist_add(&mr->mr_list, list);\n}\n\nstatic inline struct rpcrdma_mr *\nrpcrdma_mr_pop(struct list_head *list)\n{\n\tstruct rpcrdma_mr *mr;\n\n\tmr = list_first_entry_or_null(list, struct rpcrdma_mr, mr_list);\n\tif (mr)\n\t\tlist_del_init(&mr->mr_list);\n\treturn mr;\n}\n\n \nstruct rpcrdma_buffer {\n\tspinlock_t\t\trb_lock;\n\tstruct list_head\trb_send_bufs;\n\tstruct list_head\trb_mrs;\n\n\tunsigned long\t\trb_sc_head;\n\tunsigned long\t\trb_sc_tail;\n\tunsigned long\t\trb_sc_last;\n\tstruct rpcrdma_sendctx\t**rb_sc_ctxs;\n\n\tstruct list_head\trb_allreqs;\n\tstruct list_head\trb_all_mrs;\n\tstruct list_head\trb_all_reps;\n\n\tstruct llist_head\trb_free_reps;\n\n\t__be32\t\t\trb_max_requests;\n\tu32\t\t\trb_credits;\t \n\n\tu32\t\t\trb_bc_srv_max_requests;\n\tu32\t\t\trb_bc_max_requests;\n\n\tstruct work_struct\trb_refresh_worker;\n};\n\n \nstruct rpcrdma_stats {\n\t \n\tunsigned long\t\tread_chunk_count;\n\tunsigned long\t\twrite_chunk_count;\n\tunsigned long\t\treply_chunk_count;\n\tunsigned long long\ttotal_rdma_request;\n\n\t \n\tunsigned long long\tpullup_copy_count;\n\tunsigned long\t\thardway_register_count;\n\tunsigned long\t\tfailed_marshal_count;\n\tunsigned long\t\tbad_reply_count;\n\tunsigned long\t\tmrs_recycled;\n\tunsigned long\t\tmrs_orphaned;\n\tunsigned long\t\tmrs_allocated;\n\tunsigned long\t\tempty_sendctx_q;\n\n\t \n\tunsigned long long\ttotal_rdma_reply;\n\tunsigned long long\tfixup_copy_count;\n\tunsigned long\t\treply_waits_for_send;\n\tunsigned long\t\tlocal_inv_needed;\n\tunsigned long\t\tnomsg_call_count;\n\tunsigned long\t\tbcall_count;\n};\n\n \nstruct rpcrdma_xprt {\n\tstruct rpc_xprt\t\trx_xprt;\n\tstruct rpcrdma_ep\t*rx_ep;\n\tstruct rpcrdma_buffer\trx_buf;\n\tstruct delayed_work\trx_connect_worker;\n\tstruct rpc_timeout\trx_timeout;\n\tstruct rpcrdma_stats\trx_stats;\n};\n\n#define rpcx_to_rdmax(x) container_of(x, struct rpcrdma_xprt, rx_xprt)\n\nstatic inline const char *\nrpcrdma_addrstr(const struct rpcrdma_xprt *r_xprt)\n{\n\treturn r_xprt->rx_xprt.address_strings[RPC_DISPLAY_ADDR];\n}\n\nstatic inline const char *\nrpcrdma_portstr(const struct rpcrdma_xprt *r_xprt)\n{\n\treturn r_xprt->rx_xprt.address_strings[RPC_DISPLAY_PORT];\n}\n\n \nextern int xprt_rdma_pad_optimize;\n\n \nextern unsigned int xprt_rdma_memreg_strategy;\n\n \nvoid rpcrdma_force_disconnect(struct rpcrdma_ep *ep);\nvoid rpcrdma_flush_disconnect(struct rpcrdma_xprt *r_xprt, struct ib_wc *wc);\nint rpcrdma_xprt_connect(struct rpcrdma_xprt *r_xprt);\nvoid rpcrdma_xprt_disconnect(struct rpcrdma_xprt *r_xprt);\n\nvoid rpcrdma_post_recvs(struct rpcrdma_xprt *r_xprt, int needed, bool temp);\n\n \nstruct rpcrdma_req *rpcrdma_req_create(struct rpcrdma_xprt *r_xprt,\n\t\t\t\t       size_t size);\nint rpcrdma_req_setup(struct rpcrdma_xprt *r_xprt, struct rpcrdma_req *req);\nvoid rpcrdma_req_destroy(struct rpcrdma_req *req);\nint rpcrdma_buffer_create(struct rpcrdma_xprt *);\nvoid rpcrdma_buffer_destroy(struct rpcrdma_buffer *);\nstruct rpcrdma_sendctx *rpcrdma_sendctx_get_locked(struct rpcrdma_xprt *r_xprt);\n\nstruct rpcrdma_mr *rpcrdma_mr_get(struct rpcrdma_xprt *r_xprt);\nvoid rpcrdma_mrs_refresh(struct rpcrdma_xprt *r_xprt);\n\nstruct rpcrdma_req *rpcrdma_buffer_get(struct rpcrdma_buffer *);\nvoid rpcrdma_buffer_put(struct rpcrdma_buffer *buffers,\n\t\t\tstruct rpcrdma_req *req);\nvoid rpcrdma_rep_put(struct rpcrdma_buffer *buf, struct rpcrdma_rep *rep);\nvoid rpcrdma_reply_put(struct rpcrdma_buffer *buffers, struct rpcrdma_req *req);\n\nbool rpcrdma_regbuf_realloc(struct rpcrdma_regbuf *rb, size_t size,\n\t\t\t    gfp_t flags);\nbool __rpcrdma_regbuf_dma_map(struct rpcrdma_xprt *r_xprt,\n\t\t\t      struct rpcrdma_regbuf *rb);\n\n \nstatic inline bool rpcrdma_regbuf_is_mapped(struct rpcrdma_regbuf *rb)\n{\n\treturn rb->rg_device != NULL;\n}\n\n \nstatic inline bool rpcrdma_regbuf_dma_map(struct rpcrdma_xprt *r_xprt,\n\t\t\t\t\t  struct rpcrdma_regbuf *rb)\n{\n\tif (likely(rpcrdma_regbuf_is_mapped(rb)))\n\t\treturn true;\n\treturn __rpcrdma_regbuf_dma_map(r_xprt, rb);\n}\n\n \n\nstatic inline enum dma_data_direction\nrpcrdma_data_dir(bool writing)\n{\n\treturn writing ? DMA_FROM_DEVICE : DMA_TO_DEVICE;\n}\n\n \nvoid frwr_reset(struct rpcrdma_req *req);\nint frwr_query_device(struct rpcrdma_ep *ep, const struct ib_device *device);\nint frwr_mr_init(struct rpcrdma_xprt *r_xprt, struct rpcrdma_mr *mr);\nvoid frwr_mr_release(struct rpcrdma_mr *mr);\nstruct rpcrdma_mr_seg *frwr_map(struct rpcrdma_xprt *r_xprt,\n\t\t\t\tstruct rpcrdma_mr_seg *seg,\n\t\t\t\tint nsegs, bool writing, __be32 xid,\n\t\t\t\tstruct rpcrdma_mr *mr);\nint frwr_send(struct rpcrdma_xprt *r_xprt, struct rpcrdma_req *req);\nvoid frwr_reminv(struct rpcrdma_rep *rep, struct list_head *mrs);\nvoid frwr_unmap_sync(struct rpcrdma_xprt *r_xprt, struct rpcrdma_req *req);\nvoid frwr_unmap_async(struct rpcrdma_xprt *r_xprt, struct rpcrdma_req *req);\nint frwr_wp_create(struct rpcrdma_xprt *r_xprt);\n\n \n\nenum rpcrdma_chunktype {\n\trpcrdma_noch = 0,\n\trpcrdma_noch_pullup,\n\trpcrdma_noch_mapped,\n\trpcrdma_readch,\n\trpcrdma_areadch,\n\trpcrdma_writech,\n\trpcrdma_replych\n};\n\nint rpcrdma_prepare_send_sges(struct rpcrdma_xprt *r_xprt,\n\t\t\t      struct rpcrdma_req *req, u32 hdrlen,\n\t\t\t      struct xdr_buf *xdr,\n\t\t\t      enum rpcrdma_chunktype rtype);\nvoid rpcrdma_sendctx_unmap(struct rpcrdma_sendctx *sc);\nint rpcrdma_marshal_req(struct rpcrdma_xprt *r_xprt, struct rpc_rqst *rqst);\nvoid rpcrdma_set_max_header_sizes(struct rpcrdma_ep *ep);\nvoid rpcrdma_reset_cwnd(struct rpcrdma_xprt *r_xprt);\nvoid rpcrdma_complete_rqst(struct rpcrdma_rep *rep);\nvoid rpcrdma_unpin_rqst(struct rpcrdma_rep *rep);\nvoid rpcrdma_reply_handler(struct rpcrdma_rep *rep);\n\nstatic inline void rpcrdma_set_xdrlen(struct xdr_buf *xdr, size_t len)\n{\n\txdr->head[0].iov_len = len;\n\txdr->len = len;\n}\n\n \nextern unsigned int xprt_rdma_max_inline_read;\nextern unsigned int xprt_rdma_max_inline_write;\nvoid xprt_rdma_format_addresses(struct rpc_xprt *xprt, struct sockaddr *sap);\nvoid xprt_rdma_free_addresses(struct rpc_xprt *xprt);\nvoid xprt_rdma_close(struct rpc_xprt *xprt);\nvoid xprt_rdma_print_stats(struct rpc_xprt *xprt, struct seq_file *seq);\nint xprt_rdma_init(void);\nvoid xprt_rdma_cleanup(void);\n\n \n#if defined(CONFIG_SUNRPC_BACKCHANNEL)\nint xprt_rdma_bc_setup(struct rpc_xprt *, unsigned int);\nsize_t xprt_rdma_bc_maxpayload(struct rpc_xprt *);\nunsigned int xprt_rdma_bc_max_slots(struct rpc_xprt *);\nvoid rpcrdma_bc_receive_call(struct rpcrdma_xprt *, struct rpcrdma_rep *);\nint xprt_rdma_bc_send_reply(struct rpc_rqst *rqst);\nvoid xprt_rdma_bc_free_rqst(struct rpc_rqst *);\nvoid xprt_rdma_bc_destroy(struct rpc_xprt *, unsigned int);\n#endif\t \n\nextern struct xprt_class xprt_rdma_bc;\n\n#endif\t\t\t\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}