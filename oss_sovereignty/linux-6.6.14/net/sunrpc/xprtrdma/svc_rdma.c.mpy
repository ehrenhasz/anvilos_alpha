{
  "module_name": "svc_rdma.c",
  "hash_id": "c45d8fe5979885c6341b04a7083ba127f0f46cedfdd1e799f91a8ad7711bf21a",
  "original_prompt": "Ingested from linux-6.6.14/net/sunrpc/xprtrdma/svc_rdma.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include <linux/fs.h>\n#include <linux/sysctl.h>\n#include <linux/workqueue.h>\n#include <linux/sunrpc/clnt.h>\n#include <linux/sunrpc/sched.h>\n#include <linux/sunrpc/svc_rdma.h>\n\n#define RPCDBG_FACILITY\tRPCDBG_SVCXPRT\n\n \nunsigned int svcrdma_ord = 16;\t \nstatic unsigned int min_ord = 1;\nstatic unsigned int max_ord = 255;\nunsigned int svcrdma_max_requests = RPCRDMA_MAX_REQUESTS;\nunsigned int svcrdma_max_bc_requests = RPCRDMA_MAX_BC_REQUESTS;\nstatic unsigned int min_max_requests = 4;\nstatic unsigned int max_max_requests = 16384;\nunsigned int svcrdma_max_req_size = RPCRDMA_DEF_INLINE_THRESH;\nstatic unsigned int min_max_inline = RPCRDMA_DEF_INLINE_THRESH;\nstatic unsigned int max_max_inline = RPCRDMA_MAX_INLINE_THRESH;\nstatic unsigned int svcrdma_stat_unused;\nstatic unsigned int zero;\n\nstruct percpu_counter svcrdma_stat_read;\nstruct percpu_counter svcrdma_stat_recv;\nstruct percpu_counter svcrdma_stat_sq_starve;\nstruct percpu_counter svcrdma_stat_write;\n\nenum {\n\tSVCRDMA_COUNTER_BUFSIZ\t= sizeof(unsigned long long),\n};\n\nstatic int svcrdma_counter_handler(struct ctl_table *table, int write,\n\t\t\t\t   void *buffer, size_t *lenp, loff_t *ppos)\n{\n\tstruct percpu_counter *stat = (struct percpu_counter *)table->data;\n\tchar tmp[SVCRDMA_COUNTER_BUFSIZ + 1];\n\tint len;\n\n\tif (write) {\n\t\tpercpu_counter_set(stat, 0);\n\t\treturn 0;\n\t}\n\n\tlen = snprintf(tmp, SVCRDMA_COUNTER_BUFSIZ, \"%lld\\n\",\n\t\t       percpu_counter_sum_positive(stat));\n\tif (len >= SVCRDMA_COUNTER_BUFSIZ)\n\t\treturn -EFAULT;\n\tlen = strlen(tmp);\n\tif (*ppos > len) {\n\t\t*lenp = 0;\n\t\treturn 0;\n\t}\n\tlen -= *ppos;\n\tif (len > *lenp)\n\t\tlen = *lenp;\n\tif (len)\n\t\tmemcpy(buffer, tmp, len);\n\t*lenp = len;\n\t*ppos += len;\n\n\treturn 0;\n}\n\nstatic struct ctl_table_header *svcrdma_table_header;\nstatic struct ctl_table svcrdma_parm_table[] = {\n\t{\n\t\t.procname\t= \"max_requests\",\n\t\t.data\t\t= &svcrdma_max_requests,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &min_max_requests,\n\t\t.extra2\t\t= &max_max_requests\n\t},\n\t{\n\t\t.procname\t= \"max_req_size\",\n\t\t.data\t\t= &svcrdma_max_req_size,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &min_max_inline,\n\t\t.extra2\t\t= &max_max_inline\n\t},\n\t{\n\t\t.procname\t= \"max_outbound_read_requests\",\n\t\t.data\t\t= &svcrdma_ord,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &min_ord,\n\t\t.extra2\t\t= &max_ord,\n\t},\n\n\t{\n\t\t.procname\t= \"rdma_stat_read\",\n\t\t.data\t\t= &svcrdma_stat_read,\n\t\t.maxlen\t\t= SVCRDMA_COUNTER_BUFSIZ,\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= svcrdma_counter_handler,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_recv\",\n\t\t.data\t\t= &svcrdma_stat_recv,\n\t\t.maxlen\t\t= SVCRDMA_COUNTER_BUFSIZ,\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= svcrdma_counter_handler,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_write\",\n\t\t.data\t\t= &svcrdma_stat_write,\n\t\t.maxlen\t\t= SVCRDMA_COUNTER_BUFSIZ,\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= svcrdma_counter_handler,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_sq_starve\",\n\t\t.data\t\t= &svcrdma_stat_sq_starve,\n\t\t.maxlen\t\t= SVCRDMA_COUNTER_BUFSIZ,\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= svcrdma_counter_handler,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_rq_starve\",\n\t\t.data\t\t= &svcrdma_stat_unused,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &zero,\n\t\t.extra2\t\t= &zero,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_rq_poll\",\n\t\t.data\t\t= &svcrdma_stat_unused,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &zero,\n\t\t.extra2\t\t= &zero,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_rq_prod\",\n\t\t.data\t\t= &svcrdma_stat_unused,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &zero,\n\t\t.extra2\t\t= &zero,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_sq_poll\",\n\t\t.data\t\t= &svcrdma_stat_unused,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &zero,\n\t\t.extra2\t\t= &zero,\n\t},\n\t{\n\t\t.procname\t= \"rdma_stat_sq_prod\",\n\t\t.data\t\t= &svcrdma_stat_unused,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &zero,\n\t\t.extra2\t\t= &zero,\n\t},\n\t{ },\n};\n\nstatic void svc_rdma_proc_cleanup(void)\n{\n\tif (!svcrdma_table_header)\n\t\treturn;\n\tunregister_sysctl_table(svcrdma_table_header);\n\tsvcrdma_table_header = NULL;\n\n\tpercpu_counter_destroy(&svcrdma_stat_write);\n\tpercpu_counter_destroy(&svcrdma_stat_sq_starve);\n\tpercpu_counter_destroy(&svcrdma_stat_recv);\n\tpercpu_counter_destroy(&svcrdma_stat_read);\n}\n\nstatic int svc_rdma_proc_init(void)\n{\n\tint rc;\n\n\tif (svcrdma_table_header)\n\t\treturn 0;\n\n\trc = percpu_counter_init(&svcrdma_stat_read, 0, GFP_KERNEL);\n\tif (rc)\n\t\tgoto out_err;\n\trc = percpu_counter_init(&svcrdma_stat_recv, 0, GFP_KERNEL);\n\tif (rc)\n\t\tgoto out_err;\n\trc = percpu_counter_init(&svcrdma_stat_sq_starve, 0, GFP_KERNEL);\n\tif (rc)\n\t\tgoto out_err;\n\trc = percpu_counter_init(&svcrdma_stat_write, 0, GFP_KERNEL);\n\tif (rc)\n\t\tgoto out_err;\n\n\tsvcrdma_table_header = register_sysctl(\"sunrpc/svc_rdma\",\n\t\t\t\t\t       svcrdma_parm_table);\n\treturn 0;\n\nout_err:\n\tpercpu_counter_destroy(&svcrdma_stat_sq_starve);\n\tpercpu_counter_destroy(&svcrdma_stat_recv);\n\tpercpu_counter_destroy(&svcrdma_stat_read);\n\treturn rc;\n}\n\nvoid svc_rdma_cleanup(void)\n{\n\tdprintk(\"SVCRDMA Module Removed, deregister RPC RDMA transport\\n\");\n\tsvc_unreg_xprt_class(&svc_rdma_class);\n\tsvc_rdma_proc_cleanup();\n}\n\nint svc_rdma_init(void)\n{\n\tint rc;\n\n\tdprintk(\"SVCRDMA Module Init, register RPC RDMA transport\\n\");\n\tdprintk(\"\\tsvcrdma_ord      : %d\\n\", svcrdma_ord);\n\tdprintk(\"\\tmax_requests     : %u\\n\", svcrdma_max_requests);\n\tdprintk(\"\\tmax_bc_requests  : %u\\n\", svcrdma_max_bc_requests);\n\tdprintk(\"\\tmax_inline       : %d\\n\", svcrdma_max_req_size);\n\n\trc = svc_rdma_proc_init();\n\tif (rc)\n\t\treturn rc;\n\n\t \n\tsvc_reg_xprt_class(&svc_rdma_class);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}