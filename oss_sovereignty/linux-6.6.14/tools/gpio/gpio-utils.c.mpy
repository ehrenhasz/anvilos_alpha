{
  "module_name": "gpio-utils.c",
  "hash_id": "9e1193eeda47b2f25243656019c5ac74e80bdba020e0cd973c8b9f1558e60de7",
  "original_prompt": "Ingested from linux-6.6.14/tools/gpio/gpio-utils.c",
  "human_readable_source": "\n \n\n#include <unistd.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <errno.h>\n#include <string.h>\n#include <fcntl.h>\n#include <getopt.h>\n#include <sys/ioctl.h>\n#include <linux/gpio.h>\n#include \"gpio-utils.h\"\n\n#define CONSUMER \"gpio-utils\"\n\n \n\n \nint gpiotools_request_line(const char *device_name, unsigned int *lines,\n\t\t\t   unsigned int num_lines,\n\t\t\t   struct gpio_v2_line_config *config,\n\t\t\t   const char *consumer)\n{\n\tstruct gpio_v2_line_request req;\n\tchar *chrdev_name;\n\tint fd;\n\tint i;\n\tint ret;\n\n\tret = asprintf(&chrdev_name, \"/dev/%s\", device_name);\n\tif (ret < 0)\n\t\treturn -ENOMEM;\n\n\tfd = open(chrdev_name, 0);\n\tif (fd == -1) {\n\t\tret = -errno;\n\t\tfprintf(stderr, \"Failed to open %s, %s\\n\",\n\t\t\tchrdev_name, strerror(errno));\n\t\tgoto exit_free_name;\n\t}\n\n\tmemset(&req, 0, sizeof(req));\n\tfor (i = 0; i < num_lines; i++)\n\t\treq.offsets[i] = lines[i];\n\n\treq.config = *config;\n\tstrcpy(req.consumer, consumer);\n\treq.num_lines = num_lines;\n\n\tret = ioctl(fd, GPIO_V2_GET_LINE_IOCTL, &req);\n\tif (ret == -1) {\n\t\tret = -errno;\n\t\tfprintf(stderr, \"Failed to issue %s (%d), %s\\n\",\n\t\t\t\"GPIO_GET_LINE_IOCTL\", ret, strerror(errno));\n\t}\n\n\tif (close(fd) == -1)\n\t\tperror(\"Failed to close GPIO character device file\");\nexit_free_name:\n\tfree(chrdev_name);\n\treturn ret < 0 ? ret : req.fd;\n}\n\n \nint gpiotools_set_values(const int fd, struct gpio_v2_line_values *values)\n{\n\tint ret;\n\n\tret = ioctl(fd, GPIO_V2_LINE_SET_VALUES_IOCTL, values);\n\tif (ret == -1) {\n\t\tret = -errno;\n\t\tfprintf(stderr, \"Failed to issue %s (%d), %s\\n\",\n\t\t\t\"GPIOHANDLE_SET_LINE_VALUES_IOCTL\", ret,\n\t\t\tstrerror(errno));\n\t}\n\n\treturn ret;\n}\n\n \nint gpiotools_get_values(const int fd, struct gpio_v2_line_values *values)\n{\n\tint ret;\n\n\tret = ioctl(fd, GPIO_V2_LINE_GET_VALUES_IOCTL, values);\n\tif (ret == -1) {\n\t\tret = -errno;\n\t\tfprintf(stderr, \"Failed to issue %s (%d), %s\\n\",\n\t\t\t\"GPIOHANDLE_GET_LINE_VALUES_IOCTL\", ret,\n\t\t\tstrerror(errno));\n\t}\n\n\treturn ret;\n}\n\n \nint gpiotools_release_line(const int fd)\n{\n\tint ret;\n\n\tret = close(fd);\n\tif (ret == -1) {\n\t\tperror(\"Failed to close GPIO LINE device file\");\n\t\tret = -errno;\n\t}\n\n\treturn ret;\n}\n\n \nint gpiotools_get(const char *device_name, unsigned int line)\n{\n\tint ret;\n\tunsigned int value;\n\tunsigned int lines[] = {line};\n\n\tret = gpiotools_gets(device_name, lines, 1, &value);\n\tif (ret)\n\t\treturn ret;\n\treturn value;\n}\n\n\n \nint gpiotools_gets(const char *device_name, unsigned int *lines,\n\t\t   unsigned int num_lines, unsigned int *values)\n{\n\tint fd, i;\n\tint ret;\n\tint ret_close;\n\tstruct gpio_v2_line_config config;\n\tstruct gpio_v2_line_values lv;\n\n\tmemset(&config, 0, sizeof(config));\n\tconfig.flags = GPIO_V2_LINE_FLAG_INPUT;\n\tret = gpiotools_request_line(device_name, lines, num_lines,\n\t\t\t\t     &config, CONSUMER);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfd = ret;\n\tfor (i = 0; i < num_lines; i++)\n\t\tgpiotools_set_bit(&lv.mask, i);\n\tret = gpiotools_get_values(fd, &lv);\n\tif (!ret)\n\t\tfor (i = 0; i < num_lines; i++)\n\t\t\tvalues[i] = gpiotools_test_bit(lv.bits, i);\n\tret_close = gpiotools_release_line(fd);\n\treturn ret < 0 ? ret : ret_close;\n}\n\n \nint gpiotools_set(const char *device_name, unsigned int line,\n\t\t  unsigned int value)\n{\n\tunsigned int lines[] = {line};\n\n\treturn gpiotools_sets(device_name, lines, 1, &value);\n}\n\n \nint gpiotools_sets(const char *device_name, unsigned int *lines,\n\t\t   unsigned int num_lines, unsigned int *values)\n{\n\tint ret, i;\n\tstruct gpio_v2_line_config config;\n\n\tmemset(&config, 0, sizeof(config));\n\tconfig.flags = GPIO_V2_LINE_FLAG_OUTPUT;\n\tconfig.num_attrs = 1;\n\tconfig.attrs[0].attr.id = GPIO_V2_LINE_ATTR_ID_OUTPUT_VALUES;\n\tfor (i = 0; i < num_lines; i++) {\n\t\tgpiotools_set_bit(&config.attrs[0].mask, i);\n\t\tgpiotools_assign_bit(&config.attrs[0].attr.values,\n\t\t\t\t     i, values[i]);\n\t}\n\tret = gpiotools_request_line(device_name, lines, num_lines,\n\t\t\t\t     &config, CONSUMER);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn gpiotools_release_line(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}