{
  "module_name": "gpio-hammer.c",
  "hash_id": "7b1e68aa3741bc8f51ed134a3e6c37b0b68054d1272033b9357a037adfe5e019",
  "original_prompt": "Ingested from linux-6.6.14/tools/gpio/gpio-hammer.c",
  "human_readable_source": "\n \n\n#include <unistd.h>\n#include <stdlib.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <dirent.h>\n#include <errno.h>\n#include <string.h>\n#include <poll.h>\n#include <fcntl.h>\n#include <getopt.h>\n#include <sys/ioctl.h>\n#include <linux/gpio.h>\n#include \"gpio-utils.h\"\n\nint hammer_device(const char *device_name, unsigned int *lines, int num_lines,\n\t\t  unsigned int loops)\n{\n\tstruct gpio_v2_line_values values;\n\tstruct gpio_v2_line_config config;\n\tchar swirr[] = \"-\\\\|/\";\n\tint fd;\n\tint ret;\n\tint i, j;\n\tunsigned int iteration = 0;\n\n\tmemset(&config, 0, sizeof(config));\n\tconfig.flags = GPIO_V2_LINE_FLAG_OUTPUT;\n\n\tret = gpiotools_request_line(device_name, lines, num_lines,\n\t\t\t\t     &config, \"gpio-hammer\");\n\tif (ret < 0)\n\t\tgoto exit_error;\n\telse\n\t\tfd = ret;\n\n\tvalues.mask = 0;\n\tvalues.bits = 0;\n\tfor (i = 0; i < num_lines; i++)\n\t\tgpiotools_set_bit(&values.mask, i);\n\n\tret = gpiotools_get_values(fd, &values);\n\tif (ret < 0)\n\t\tgoto exit_close_error;\n\n\tfprintf(stdout, \"Hammer lines [\");\n\tfor (i = 0; i < num_lines; i++) {\n\t\tfprintf(stdout, \"%d\", lines[i]);\n\t\tif (i != (num_lines - 1))\n\t\t\tfprintf(stdout, \", \");\n\t}\n\tfprintf(stdout, \"] on %s, initial states: [\", device_name);\n\tfor (i = 0; i < num_lines; i++) {\n\t\tfprintf(stdout, \"%d\", gpiotools_test_bit(values.bits, i));\n\t\tif (i != (num_lines - 1))\n\t\t\tfprintf(stdout, \", \");\n\t}\n\tfprintf(stdout, \"]\\n\");\n\n\t \n\tj = 0;\n\twhile (1) {\n\t\t \n\t\tfor (i = 0; i < num_lines; i++)\n\t\t\tgpiotools_change_bit(&values.bits, i);\n\n\t\tret = gpiotools_set_values(fd, &values);\n\t\tif (ret < 0)\n\t\t\tgoto exit_close_error;\n\n\t\t \n\t\tret = gpiotools_get_values(fd, &values);\n\t\tif (ret < 0)\n\t\t\tgoto exit_close_error;\n\n\t\tfprintf(stdout, \"[%c] \", swirr[j]);\n\t\tj++;\n\t\tif (j == sizeof(swirr) - 1)\n\t\t\tj = 0;\n\n\t\tfprintf(stdout, \"[\");\n\t\tfor (i = 0; i < num_lines; i++) {\n\t\t\tfprintf(stdout, \"%d: %d\", lines[i],\n\t\t\t\tgpiotools_test_bit(values.bits, i));\n\t\t\tif (i != (num_lines - 1))\n\t\t\t\tfprintf(stdout, \", \");\n\t\t}\n\t\tfprintf(stdout, \"]\\r\");\n\t\tfflush(stdout);\n\t\tsleep(1);\n\t\titeration++;\n\t\tif (loops && iteration == loops)\n\t\t\tbreak;\n\t}\n\tfprintf(stdout, \"\\n\");\n\tret = 0;\n\nexit_close_error:\n\tgpiotools_release_line(fd);\nexit_error:\n\treturn ret;\n}\n\nvoid print_usage(void)\n{\n\tfprintf(stderr, \"Usage: gpio-hammer [options]...\\n\"\n\t\t\"Hammer GPIO lines, 0->1->0->1...\\n\"\n\t\t\"  -n <name>  Hammer GPIOs on a named device (must be stated)\\n\"\n\t\t\"  -o <n>     Offset[s] to hammer, at least one, several can be stated\\n\"\n\t\t\" [-c <n>]    Do <n> loops (optional, infinite loop if not stated)\\n\"\n\t\t\"  -?         This helptext\\n\"\n\t\t\"\\n\"\n\t\t\"Example:\\n\"\n\t\t\"gpio-hammer -n gpiochip0 -o 4\\n\"\n\t);\n}\n\nint main(int argc, char **argv)\n{\n\tconst char *device_name = NULL;\n\tunsigned int lines[GPIOHANDLES_MAX];\n\tunsigned int loops = 0;\n\tint num_lines;\n\tint c;\n\tint i;\n\n\ti = 0;\n\twhile ((c = getopt(argc, argv, \"c:n:o:?\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 'c':\n\t\t\tloops = strtoul(optarg, NULL, 10);\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\tdevice_name = optarg;\n\t\t\tbreak;\n\t\tcase 'o':\n\t\t\t \n\t\t\tif (i < GPIOHANDLES_MAX)\n\t\t\t\tlines[i] = strtoul(optarg, NULL, 10);\n\n\t\t\ti++;\n\t\t\tbreak;\n\t\tcase '?':\n\t\t\tprint_usage();\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\tif (i >= GPIOHANDLES_MAX) {\n\t\tfprintf(stderr,\n\t\t\t\"Only %d occurrences of '-o' are allowed, %d were found\\n\",\n\t\t\tGPIOHANDLES_MAX, i + 1);\n\t\treturn -1;\n\t}\n\n\tnum_lines = i;\n\n\tif (!device_name || !num_lines) {\n\t\tprint_usage();\n\t\treturn -1;\n\t}\n\treturn hammer_device(device_name, lines, num_lines, loops);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}