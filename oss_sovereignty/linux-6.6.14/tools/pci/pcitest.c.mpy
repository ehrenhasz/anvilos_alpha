{
  "module_name": "pcitest.c",
  "hash_id": "9975ff2317ca92dbb074f4a1f6b1d0cefd67852fe7c9f4a4f1fe08adae99a66d",
  "original_prompt": "Ingested from linux-6.6.14/tools/pci/pcitest.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <fcntl.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/ioctl.h>\n#include <unistd.h>\n\n#include <linux/pcitest.h>\n\n#define BILLION 1E9\n\nstatic char *result[] = { \"NOT OKAY\", \"OKAY\" };\nstatic char *irq[] = { \"LEGACY\", \"MSI\", \"MSI-X\" };\n\nstruct pci_test {\n\tchar\t\t*device;\n\tchar\t\tbarnum;\n\tbool\t\tlegacyirq;\n\tunsigned int\tmsinum;\n\tunsigned int\tmsixnum;\n\tint\t\tirqtype;\n\tbool\t\tset_irqtype;\n\tbool\t\tget_irqtype;\n\tbool\t\tclear_irq;\n\tbool\t\tread;\n\tbool\t\twrite;\n\tbool\t\tcopy;\n\tunsigned long\tsize;\n\tbool\t\tuse_dma;\n};\n\nstatic int run_test(struct pci_test *test)\n{\n\tstruct pci_endpoint_test_xfer_param param = {};\n\tint ret = -EINVAL;\n\tint fd;\n\n\tfd = open(test->device, O_RDWR);\n\tif (fd < 0) {\n\t\tperror(\"can't open PCI Endpoint Test device\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (test->barnum >= 0 && test->barnum <= 5) {\n\t\tret = ioctl(fd, PCITEST_BAR, test->barnum);\n\t\tfprintf(stdout, \"BAR%d:\\t\\t\", test->barnum);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->set_irqtype) {\n\t\tret = ioctl(fd, PCITEST_SET_IRQTYPE, test->irqtype);\n\t\tfprintf(stdout, \"SET IRQ TYPE TO %s:\\t\\t\", irq[test->irqtype]);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->get_irqtype) {\n\t\tret = ioctl(fd, PCITEST_GET_IRQTYPE);\n\t\tfprintf(stdout, \"GET IRQ TYPE:\\t\\t\");\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", irq[ret]);\n\t}\n\n\tif (test->clear_irq) {\n\t\tret = ioctl(fd, PCITEST_CLEAR_IRQ);\n\t\tfprintf(stdout, \"CLEAR IRQ:\\t\\t\");\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->legacyirq) {\n\t\tret = ioctl(fd, PCITEST_LEGACY_IRQ, 0);\n\t\tfprintf(stdout, \"LEGACY IRQ:\\t\");\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->msinum > 0 && test->msinum <= 32) {\n\t\tret = ioctl(fd, PCITEST_MSI, test->msinum);\n\t\tfprintf(stdout, \"MSI%d:\\t\\t\", test->msinum);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->msixnum > 0 && test->msixnum <= 2048) {\n\t\tret = ioctl(fd, PCITEST_MSIX, test->msixnum);\n\t\tfprintf(stdout, \"MSI-X%d:\\t\\t\", test->msixnum);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->write) {\n\t\tparam.size = test->size;\n\t\tif (test->use_dma)\n\t\t\tparam.flags = PCITEST_FLAGS_USE_DMA;\n\t\tret = ioctl(fd, PCITEST_WRITE, &param);\n\t\tfprintf(stdout, \"WRITE (%7ld bytes):\\t\\t\", test->size);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->read) {\n\t\tparam.size = test->size;\n\t\tif (test->use_dma)\n\t\t\tparam.flags = PCITEST_FLAGS_USE_DMA;\n\t\tret = ioctl(fd, PCITEST_READ, &param);\n\t\tfprintf(stdout, \"READ (%7ld bytes):\\t\\t\", test->size);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tif (test->copy) {\n\t\tparam.size = test->size;\n\t\tif (test->use_dma)\n\t\t\tparam.flags = PCITEST_FLAGS_USE_DMA;\n\t\tret = ioctl(fd, PCITEST_COPY, &param);\n\t\tfprintf(stdout, \"COPY (%7ld bytes):\\t\\t\", test->size);\n\t\tif (ret < 0)\n\t\t\tfprintf(stdout, \"TEST FAILED\\n\");\n\t\telse\n\t\t\tfprintf(stdout, \"%s\\n\", result[ret]);\n\t}\n\n\tfflush(stdout);\n\tclose(fd);\n\treturn (ret < 0) ? ret : 1 - ret;  \n}\n\nint main(int argc, char **argv)\n{\n\tint c;\n\tstruct pci_test *test;\n\n\ttest = calloc(1, sizeof(*test));\n\tif (!test) {\n\t\tperror(\"Fail to allocate memory for pci_test\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\t \n\ttest->barnum = -1;\n\n\t \n\ttest->size = 0x19000;\n\n\t \n\ttest->device = \"/dev/pci-endpoint-test.0\";\n\n\twhile ((c = getopt(argc, argv, \"D:b:m:x:i:deIlhrwcs:\")) != EOF)\n\tswitch (c) {\n\tcase 'D':\n\t\ttest->device = optarg;\n\t\tcontinue;\n\tcase 'b':\n\t\ttest->barnum = atoi(optarg);\n\t\tif (test->barnum < 0 || test->barnum > 5)\n\t\t\tgoto usage;\n\t\tcontinue;\n\tcase 'l':\n\t\ttest->legacyirq = true;\n\t\tcontinue;\n\tcase 'm':\n\t\ttest->msinum = atoi(optarg);\n\t\tif (test->msinum < 1 || test->msinum > 32)\n\t\t\tgoto usage;\n\t\tcontinue;\n\tcase 'x':\n\t\ttest->msixnum = atoi(optarg);\n\t\tif (test->msixnum < 1 || test->msixnum > 2048)\n\t\t\tgoto usage;\n\t\tcontinue;\n\tcase 'i':\n\t\ttest->irqtype = atoi(optarg);\n\t\tif (test->irqtype < 0 || test->irqtype > 2)\n\t\t\tgoto usage;\n\t\ttest->set_irqtype = true;\n\t\tcontinue;\n\tcase 'I':\n\t\ttest->get_irqtype = true;\n\t\tcontinue;\n\tcase 'r':\n\t\ttest->read = true;\n\t\tcontinue;\n\tcase 'w':\n\t\ttest->write = true;\n\t\tcontinue;\n\tcase 'c':\n\t\ttest->copy = true;\n\t\tcontinue;\n\tcase 'e':\n\t\ttest->clear_irq = true;\n\t\tcontinue;\n\tcase 's':\n\t\ttest->size = strtoul(optarg, NULL, 0);\n\t\tcontinue;\n\tcase 'd':\n\t\ttest->use_dma = true;\n\t\tcontinue;\n\tcase 'h':\n\tdefault:\nusage:\n\t\tfprintf(stderr,\n\t\t\t\"usage: %s [options]\\n\"\n\t\t\t\"Options:\\n\"\n\t\t\t\"\\t-D <dev>\t\tPCI endpoint test device {default: /dev/pci-endpoint-test.0}\\n\"\n\t\t\t\"\\t-b <bar num>\t\tBAR test (bar number between 0..5)\\n\"\n\t\t\t\"\\t-m <msi num>\t\tMSI test (msi number between 1..32)\\n\"\n\t\t\t\"\\t-x <msix num>\t\\tMSI-X test (msix number between 1..2048)\\n\"\n\t\t\t\"\\t-i <irq type>\t\\tSet IRQ type (0 - Legacy, 1 - MSI, 2 - MSI-X)\\n\"\n\t\t\t\"\\t-e\t\t\tClear IRQ\\n\"\n\t\t\t\"\\t-I\t\t\tGet current IRQ type configured\\n\"\n\t\t\t\"\\t-d\t\t\tUse DMA\\n\"\n\t\t\t\"\\t-l\t\t\tLegacy IRQ test\\n\"\n\t\t\t\"\\t-r\t\t\tRead buffer test\\n\"\n\t\t\t\"\\t-w\t\t\tWrite buffer test\\n\"\n\t\t\t\"\\t-c\t\t\tCopy buffer test\\n\"\n\t\t\t\"\\t-s <size>\t\tSize of buffer {default: 100KB}\\n\"\n\t\t\t\"\\t-h\t\t\tPrint this help message\\n\",\n\t\t\targv[0]);\n\t\treturn -EINVAL;\n\t}\n\n\treturn run_test(test);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}