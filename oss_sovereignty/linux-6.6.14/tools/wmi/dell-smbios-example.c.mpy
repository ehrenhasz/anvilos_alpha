{
  "module_name": "dell-smbios-example.c",
  "hash_id": "1e255e1faca721533b1bdc1248b1b005c5d39d5cce216d50895c52d81db08b98",
  "original_prompt": "Ingested from linux-6.6.14/tools/wmi/dell-smbios-example.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/ioctl.h>\n#include <unistd.h>\n\n \n#ifndef __packed\n#define __packed __attribute__((packed))\n#endif\n#include <linux/wmi.h>\n\n \nstatic const char *ioctl_devfs = \"/dev/wmi/dell-smbios\";\nstatic const char *token_sysfs =\n\t\t\t\"/sys/bus/platform/devices/dell-smbios.0/tokens\";\n\nstatic void show_buffer(struct dell_wmi_smbios_buffer *buffer)\n{\n\tprintf(\"Call: %x/%x [%x,%x,%x,%x]\\nResults: [%8x,%8x,%8x,%8x]\\n\",\n\tbuffer->std.cmd_class, buffer->std.cmd_select,\n\tbuffer->std.input[0], buffer->std.input[1],\n\tbuffer->std.input[2], buffer->std.input[3],\n\tbuffer->std.output[0], buffer->std.output[1],\n\tbuffer->std.output[2], buffer->std.output[3]);\n}\n\nstatic int run_wmi_smbios_cmd(struct dell_wmi_smbios_buffer *buffer)\n{\n\tint fd;\n\tint ret;\n\n\tfd = open(ioctl_devfs, O_NONBLOCK);\n\tret = ioctl(fd, DELL_WMI_SMBIOS_CMD, buffer);\n\tclose(fd);\n\treturn ret;\n}\n\nstatic int find_token(__u16 token, __u16 *location, __u16 *value)\n{\n\tchar location_sysfs[60];\n\tchar value_sysfs[57];\n\tchar buf[4096];\n\tFILE *f;\n\tint ret;\n\n\tret = sprintf(value_sysfs, \"%s/%04x_value\", token_sysfs, token);\n\tif (ret < 0) {\n\t\tprintf(\"sprintf value failed\\n\");\n\t\treturn 2;\n\t}\n\tf = fopen(value_sysfs, \"rb\");\n\tif (!f) {\n\t\tprintf(\"failed to open %s\\n\", value_sysfs);\n\t\treturn 2;\n\t}\n\tfread(buf, 1, 4096, f);\n\tfclose(f);\n\t*value = (__u16) strtol(buf, NULL, 16);\n\n\tret = sprintf(location_sysfs, \"%s/%04x_location\", token_sysfs, token);\n\tif (ret < 0) {\n\t\tprintf(\"sprintf location failed\\n\");\n\t\treturn 1;\n\t}\n\tf = fopen(location_sysfs, \"rb\");\n\tif (!f) {\n\t\tprintf(\"failed to open %s\\n\", location_sysfs);\n\t\treturn 2;\n\t}\n\tfread(buf, 1, 4096, f);\n\tfclose(f);\n\t*location = (__u16) strtol(buf, NULL, 16);\n\n\tif (*location)\n\t\treturn 0;\n\treturn 2;\n}\n\nstatic int token_is_active(__u16 *location, __u16 *cmpvalue,\n\t\t\t   struct dell_wmi_smbios_buffer *buffer)\n{\n\tint ret;\n\n\tbuffer->std.cmd_class = CLASS_TOKEN_READ;\n\tbuffer->std.cmd_select = SELECT_TOKEN_STD;\n\tbuffer->std.input[0] = *location;\n\tret = run_wmi_smbios_cmd(buffer);\n\tif (ret != 0 || buffer->std.output[0] != 0)\n\t\treturn ret;\n\tret = (buffer->std.output[1] == *cmpvalue);\n\treturn ret;\n}\n\nstatic int query_token(__u16 token, struct dell_wmi_smbios_buffer *buffer)\n{\n\t__u16 location;\n\t__u16 value;\n\tint ret;\n\n\tret = find_token(token, &location, &value);\n\tif (ret != 0) {\n\t\tprintf(\"unable to find token %04x\\n\", token);\n\t\treturn 1;\n\t}\n\treturn token_is_active(&location, &value, buffer);\n}\n\nstatic int activate_token(struct dell_wmi_smbios_buffer *buffer,\n\t\t   __u16 token)\n{\n\t__u16 location;\n\t__u16 value;\n\tint ret;\n\n\tret = find_token(token, &location, &value);\n\tif (ret != 0) {\n\t\tprintf(\"unable to find token %04x\\n\", token);\n\t\treturn 1;\n\t}\n\tbuffer->std.cmd_class = CLASS_TOKEN_WRITE;\n\tbuffer->std.cmd_select = SELECT_TOKEN_STD;\n\tbuffer->std.input[0] = location;\n\tbuffer->std.input[1] = 1;\n\tret = run_wmi_smbios_cmd(buffer);\n\treturn ret;\n}\n\nstatic int query_buffer_size(__u64 *buffer_size)\n{\n\tFILE *f;\n\n\tf = fopen(ioctl_devfs, \"rb\");\n\tif (!f)\n\t\treturn -EINVAL;\n\tfread(buffer_size, sizeof(__u64), 1, f);\n\tfclose(f);\n\treturn EXIT_SUCCESS;\n}\n\nint main(void)\n{\n\tstruct dell_wmi_smbios_buffer *buffer;\n\tint ret;\n\t__u64 value = 0;\n\n\tret = query_buffer_size(&value);\n\tif (ret == EXIT_FAILURE || !value) {\n\t\tprintf(\"Unable to read buffer size\\n\");\n\t\tgoto out;\n\t}\n\tprintf(\"Detected required buffer size %lld\\n\", value);\n\n\tbuffer = malloc(value);\n\tif (buffer == NULL) {\n\t\tprintf(\"failed to alloc memory for ioctl\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\tbuffer->length = value;\n\n\t \n\tbuffer->std.cmd_class = CLASS_FLASH_INTERFACE;\n\tbuffer->std.cmd_select = SELECT_FLASH_INTERFACE;\n\tbuffer->std.input[0] = 2;\n\tret = run_wmi_smbios_cmd(buffer);\n\tif (ret) {\n\t\tprintf(\"smbios ioctl failed: %d\\n\", ret);\n\t\tret = EXIT_FAILURE;\n\t\tgoto out;\n\t}\n\tshow_buffer(buffer);\n\n\t \n\tret = query_token(CAPSULE_EN_TOKEN, buffer);\n\tprintf(\"UEFI Capsule enabled token is: %d\\n\", ret);\n\tret = query_token(CAPSULE_DIS_TOKEN, buffer);\n\tprintf(\"UEFI Capsule disabled token is: %d\\n\", ret);\n\n\t \n\tif (ret) {\n\t\tprintf(\"Enabling UEFI capsule token\");\n\t\tif (activate_token(buffer, CAPSULE_EN_TOKEN)) {\n\t\t\tprintf(\"activate failed\\n\");\n\t\t\tret = -1;\n\t\t\tgoto out;\n\t\t}\n\t}\n\tret = EXIT_SUCCESS;\nout:\n\tfree(buffer);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}