{
  "module_name": "iter.c",
  "hash_id": "30936d7247b216a464e678f86b113c5c360c3265c708102d5e858fd8122734ff",
  "original_prompt": "Ingested from linux-6.6.14/tools/bpf/bpftool/iter.c",
  "human_readable_source": "\n\n\n#ifndef _GNU_SOURCE\n#define _GNU_SOURCE\n#endif\n#include <errno.h>\n#include <unistd.h>\n#include <linux/err.h>\n#include <bpf/libbpf.h>\n\n#include \"main.h\"\n\nstatic int do_pin(int argc, char **argv)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_iter_attach_opts, iter_opts);\n\tunion bpf_iter_link_info linfo;\n\tconst char *objfile, *path;\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\tstruct bpf_link *link;\n\tint err = -1, map_fd = -1;\n\n\tif (!REQ_ARGS(2))\n\t\tusage();\n\n\tobjfile = GET_ARG();\n\tpath = GET_ARG();\n\n\t \n\tif (argc) {\n\t\tif (is_prefix(*argv, \"map\")) {\n\t\t\tNEXT_ARG();\n\n\t\t\tif (!REQ_ARGS(2)) {\n\t\t\t\tp_err(\"incorrect map spec\");\n\t\t\t\treturn -1;\n\t\t\t}\n\n\t\t\tmap_fd = map_parse_fd(&argc, &argv);\n\t\t\tif (map_fd < 0)\n\t\t\t\treturn -1;\n\n\t\t\tmemset(&linfo, 0, sizeof(linfo));\n\t\t\tlinfo.map.map_fd = map_fd;\n\t\t\titer_opts.link_info = &linfo;\n\t\t\titer_opts.link_info_len = sizeof(linfo);\n\t\t}\n\t}\n\n\tobj = bpf_object__open(objfile);\n\tif (!obj) {\n\t\terr = -errno;\n\t\tp_err(\"can't open objfile %s\", objfile);\n\t\tgoto close_map_fd;\n\t}\n\n\terr = bpf_object__load(obj);\n\tif (err) {\n\t\tp_err(\"can't load objfile %s\", objfile);\n\t\tgoto close_obj;\n\t}\n\n\tprog = bpf_object__next_program(obj, NULL);\n\tif (!prog) {\n\t\terr = -errno;\n\t\tp_err(\"can't find bpf program in objfile %s\", objfile);\n\t\tgoto close_obj;\n\t}\n\n\tlink = bpf_program__attach_iter(prog, &iter_opts);\n\tif (!link) {\n\t\terr = -errno;\n\t\tp_err(\"attach_iter failed for program %s\",\n\t\t      bpf_program__name(prog));\n\t\tgoto close_obj;\n\t}\n\n\terr = mount_bpffs_for_pin(path, false);\n\tif (err)\n\t\tgoto close_link;\n\n\terr = bpf_link__pin(link, path);\n\tif (err) {\n\t\tp_err(\"pin_iter failed for program %s to path %s\",\n\t\t      bpf_program__name(prog), path);\n\t\tgoto close_link;\n\t}\n\nclose_link:\n\tbpf_link__destroy(link);\nclose_obj:\n\tbpf_object__close(obj);\nclose_map_fd:\n\tif (map_fd >= 0)\n\t\tclose(map_fd);\n\treturn err;\n}\n\nstatic int do_help(int argc, char **argv)\n{\n\tfprintf(stderr,\n\t\t\"Usage: %1$s %2$s pin OBJ PATH [map MAP]\\n\"\n\t\t\"       %1$s %2$s help\\n\"\n\t\t\"\\n\"\n\t\t\"       \" HELP_SPEC_MAP \"\\n\"\n\t\t\"       \" HELP_SPEC_OPTIONS \" }\\n\"\n\t\t\"\",\n\t\tbin_name, \"iter\");\n\n\treturn 0;\n}\n\nstatic const struct cmd cmds[] = {\n\t{ \"help\",\tdo_help },\n\t{ \"pin\",\tdo_pin },\n\t{ 0 }\n};\n\nint do_iter(int argc, char **argv)\n{\n\treturn cmd_select(cmds, argc, argv, do_help);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}