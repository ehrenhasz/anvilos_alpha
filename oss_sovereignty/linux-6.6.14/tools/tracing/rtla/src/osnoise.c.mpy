{
  "module_name": "osnoise.c",
  "hash_id": "fb87bcfd559c8a50423f31fab4bbde9dfa846ab84c3657933b73a4b011d89c76",
  "original_prompt": "Ingested from linux-6.6.14/tools/tracing/rtla/src/osnoise.c",
  "human_readable_source": "\n \n\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <pthread.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <stdio.h>\n\n#include \"osnoise.h\"\n#include \"utils.h\"\n\n \nchar *osnoise_get_cpus(struct osnoise_context *context)\n{\n\tif (context->curr_cpus)\n\t\treturn context->curr_cpus;\n\n\tif (context->orig_cpus)\n\t\treturn context->orig_cpus;\n\n\tcontext->orig_cpus = tracefs_instance_file_read(NULL, \"osnoise/cpus\", NULL);\n\n\t \n\treturn context->orig_cpus;\n}\n\n \nint osnoise_set_cpus(struct osnoise_context *context, char *cpus)\n{\n\tchar *orig_cpus = osnoise_get_cpus(context);\n\tchar buffer[1024];\n\tint retval;\n\n\tif (!orig_cpus)\n\t\treturn -1;\n\n\tcontext->curr_cpus = strdup(cpus);\n\tif (!context->curr_cpus)\n\t\treturn -1;\n\n\tsnprintf(buffer, 1024, \"%s\\n\", cpus);\n\n\tdebug_msg(\"setting cpus to %s from %s\", cpus, context->orig_cpus);\n\n\tretval = tracefs_instance_file_write(NULL, \"osnoise/cpus\", buffer);\n\tif (retval < 0) {\n\t\tfree(context->curr_cpus);\n\t\tcontext->curr_cpus = NULL;\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_cpus(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (!context->orig_cpus)\n\t\treturn;\n\n\tif (!context->curr_cpus)\n\t\treturn;\n\n\t \n\tif (!strcmp(context->orig_cpus, context->curr_cpus))\n\t\tgoto out_done;\n\n\tdebug_msg(\"restoring cpus to %s\", context->orig_cpus);\n\n\tretval = tracefs_instance_file_write(NULL, \"osnoise/cpus\", context->orig_cpus);\n\tif (retval < 0)\n\t\terr_msg(\"could not restore original osnoise cpus\\n\");\n\nout_done:\n\tfree(context->curr_cpus);\n\tcontext->curr_cpus = NULL;\n}\n\n \nvoid osnoise_put_cpus(struct osnoise_context *context)\n{\n\tosnoise_restore_cpus(context);\n\n\tif (!context->orig_cpus)\n\t\treturn;\n\n\tfree(context->orig_cpus);\n\tcontext->orig_cpus = NULL;\n}\n\n \nstatic long long osnoise_read_ll_config(char *rel_path)\n{\n\tlong long retval;\n\tchar *buffer;\n\n\tbuffer = tracefs_instance_file_read(NULL, rel_path, NULL);\n\tif (!buffer)\n\t\treturn -1;\n\n\t \n\tretval = get_llong_from_str(buffer);\n\n\tdebug_msg(\"reading %s returned %lld\\n\", rel_path, retval);\n\n\tfree(buffer);\n\n\treturn retval;\n}\n\n \nstatic long long osnoise_write_ll_config(char *rel_path, long long value)\n{\n\tchar buffer[BUFF_U64_STR_SIZE];\n\tlong long retval;\n\n\tsnprintf(buffer, sizeof(buffer), \"%lld\\n\", value);\n\n\tdebug_msg(\"setting %s to %lld\\n\", rel_path, value);\n\n\tretval = tracefs_instance_file_write(NULL, rel_path, buffer);\n\treturn retval;\n}\n\n \nunsigned long long osnoise_get_runtime(struct osnoise_context *context)\n{\n\tlong long runtime_us;\n\n\tif (context->runtime_us != OSNOISE_TIME_INIT_VAL)\n\t\treturn context->runtime_us;\n\n\tif (context->orig_runtime_us != OSNOISE_TIME_INIT_VAL)\n\t\treturn context->orig_runtime_us;\n\n\truntime_us = osnoise_read_ll_config(\"osnoise/runtime_us\");\n\tif (runtime_us < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_runtime_us = runtime_us;\n\treturn runtime_us;\n\nout_err:\n\treturn OSNOISE_TIME_INIT_VAL;\n}\n\n \nunsigned long long osnoise_get_period(struct osnoise_context *context)\n{\n\tlong long period_us;\n\n\tif (context->period_us != OSNOISE_TIME_INIT_VAL)\n\t\treturn context->period_us;\n\n\tif (context->orig_period_us != OSNOISE_TIME_INIT_VAL)\n\t\treturn context->orig_period_us;\n\n\tperiod_us = osnoise_read_ll_config(\"osnoise/period_us\");\n\tif (period_us < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_period_us = period_us;\n\treturn period_us;\n\nout_err:\n\treturn OSNOISE_TIME_INIT_VAL;\n}\n\nstatic int __osnoise_write_runtime(struct osnoise_context *context,\n\t\t\t\t   unsigned long long runtime)\n{\n\tint retval;\n\n\tif (context->orig_runtime_us == OSNOISE_TIME_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"osnoise/runtime_us\", runtime);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->runtime_us = runtime;\n\treturn 0;\n}\n\nstatic int __osnoise_write_period(struct osnoise_context *context,\n\t\t\t\t  unsigned long long period)\n{\n\tint retval;\n\n\tif (context->orig_period_us == OSNOISE_TIME_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"osnoise/period_us\", period);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->period_us = period;\n\treturn 0;\n}\n\n \nint osnoise_set_runtime_period(struct osnoise_context *context,\n\t\t\t       unsigned long long runtime,\n\t\t\t       unsigned long long period)\n{\n\tunsigned long long curr_runtime_us;\n\tunsigned long long curr_period_us;\n\tint retval;\n\n\tif (!period && !runtime)\n\t\treturn 0;\n\n\tcurr_runtime_us = osnoise_get_runtime(context);\n\tcurr_period_us = osnoise_get_period(context);\n\n\t \n\tif (curr_period_us == OSNOISE_TIME_INIT_VAL || curr_runtime_us == OSNOISE_TIME_INIT_VAL)\n\t\treturn -1;\n\n\tif (!period) {\n\t\tif (runtime > curr_period_us)\n\t\t\treturn -1;\n\t\treturn __osnoise_write_runtime(context, runtime);\n\t} else if (!runtime) {\n\t\tif (period < curr_runtime_us)\n\t\t\treturn -1;\n\t\treturn __osnoise_write_period(context, period);\n\t}\n\n\tif (runtime > curr_period_us) {\n\t\tretval = __osnoise_write_period(context, period);\n\t\tif (retval)\n\t\t\treturn -1;\n\t\tretval = __osnoise_write_runtime(context, runtime);\n\t\tif (retval)\n\t\t\treturn -1;\n\t} else {\n\t\tretval = __osnoise_write_runtime(context, runtime);\n\t\tif (retval)\n\t\t\treturn -1;\n\t\tretval = __osnoise_write_period(context, period);\n\t\tif (retval)\n\t\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_runtime_period(struct osnoise_context *context)\n{\n\tunsigned long long orig_runtime = context->orig_runtime_us;\n\tunsigned long long orig_period = context->orig_period_us;\n\tunsigned long long curr_runtime = context->runtime_us;\n\tunsigned long long curr_period = context->period_us;\n\tint retval;\n\n\tif ((orig_runtime == OSNOISE_TIME_INIT_VAL) && (orig_period == OSNOISE_TIME_INIT_VAL))\n\t\treturn;\n\n\tif ((orig_period == curr_period) && (orig_runtime == curr_runtime))\n\t\tgoto out_done;\n\n\tretval = osnoise_set_runtime_period(context, orig_runtime, orig_period);\n\tif (retval)\n\t\terr_msg(\"Could not restore original osnoise runtime/period\\n\");\n\nout_done:\n\tcontext->runtime_us = OSNOISE_TIME_INIT_VAL;\n\tcontext->period_us = OSNOISE_TIME_INIT_VAL;\n}\n\n \nvoid osnoise_put_runtime_period(struct osnoise_context *context)\n{\n\tosnoise_restore_runtime_period(context);\n\n\tif (context->orig_runtime_us != OSNOISE_TIME_INIT_VAL)\n\t\tcontext->orig_runtime_us = OSNOISE_TIME_INIT_VAL;\n\n\tif (context->orig_period_us != OSNOISE_TIME_INIT_VAL)\n\t\tcontext->orig_period_us = OSNOISE_TIME_INIT_VAL;\n}\n\n \nstatic long long\nosnoise_get_timerlat_period_us(struct osnoise_context *context)\n{\n\tlong long timerlat_period_us;\n\n\tif (context->timerlat_period_us != OSNOISE_TIME_INIT_VAL)\n\t\treturn context->timerlat_period_us;\n\n\tif (context->orig_timerlat_period_us != OSNOISE_TIME_INIT_VAL)\n\t\treturn context->orig_timerlat_period_us;\n\n\ttimerlat_period_us = osnoise_read_ll_config(\"osnoise/timerlat_period_us\");\n\tif (timerlat_period_us < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_timerlat_period_us = timerlat_period_us;\n\treturn timerlat_period_us;\n\nout_err:\n\treturn OSNOISE_TIME_INIT_VAL;\n}\n\n \nint osnoise_set_timerlat_period_us(struct osnoise_context *context, long long timerlat_period_us)\n{\n\tlong long curr_timerlat_period_us = osnoise_get_timerlat_period_us(context);\n\tint retval;\n\n\tif (curr_timerlat_period_us == OSNOISE_TIME_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"osnoise/timerlat_period_us\", timerlat_period_us);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->timerlat_period_us = timerlat_period_us;\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_timerlat_period_us(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_timerlat_period_us == OSNOISE_TIME_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_timerlat_period_us == context->timerlat_period_us)\n\t\tgoto out_done;\n\n\tretval = osnoise_write_ll_config(\"osnoise/timerlat_period_us\", context->orig_timerlat_period_us);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original osnoise timerlat_period_us\\n\");\n\nout_done:\n\tcontext->timerlat_period_us = OSNOISE_TIME_INIT_VAL;\n}\n\n \nvoid osnoise_put_timerlat_period_us(struct osnoise_context *context)\n{\n\tosnoise_restore_timerlat_period_us(context);\n\n\tif (context->orig_timerlat_period_us == OSNOISE_TIME_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_timerlat_period_us = OSNOISE_TIME_INIT_VAL;\n}\n\n \nstatic long long\nosnoise_get_stop_us(struct osnoise_context *context)\n{\n\tlong long stop_us;\n\n\tif (context->stop_us != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->stop_us;\n\n\tif (context->orig_stop_us != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->orig_stop_us;\n\n\tstop_us = osnoise_read_ll_config(\"osnoise/stop_tracing_us\");\n\tif (stop_us < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_stop_us = stop_us;\n\treturn stop_us;\n\nout_err:\n\treturn OSNOISE_OPTION_INIT_VAL;\n}\n\n \nint osnoise_set_stop_us(struct osnoise_context *context, long long stop_us)\n{\n\tlong long curr_stop_us = osnoise_get_stop_us(context);\n\tint retval;\n\n\tif (curr_stop_us == OSNOISE_OPTION_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"osnoise/stop_tracing_us\", stop_us);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->stop_us = stop_us;\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_stop_us(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_stop_us == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_stop_us == context->stop_us)\n\t\tgoto out_done;\n\n\tretval = osnoise_write_ll_config(\"osnoise/stop_tracing_us\", context->orig_stop_us);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original osnoise stop_us\\n\");\n\nout_done:\n\tcontext->stop_us = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nvoid osnoise_put_stop_us(struct osnoise_context *context)\n{\n\tosnoise_restore_stop_us(context);\n\n\tif (context->orig_stop_us == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_stop_us = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nstatic long long\nosnoise_get_stop_total_us(struct osnoise_context *context)\n{\n\tlong long stop_total_us;\n\n\tif (context->stop_total_us != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->stop_total_us;\n\n\tif (context->orig_stop_total_us != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->orig_stop_total_us;\n\n\tstop_total_us = osnoise_read_ll_config(\"osnoise/stop_tracing_total_us\");\n\tif (stop_total_us < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_stop_total_us = stop_total_us;\n\treturn stop_total_us;\n\nout_err:\n\treturn OSNOISE_OPTION_INIT_VAL;\n}\n\n \nint osnoise_set_stop_total_us(struct osnoise_context *context, long long stop_total_us)\n{\n\tlong long curr_stop_total_us = osnoise_get_stop_total_us(context);\n\tint retval;\n\n\tif (curr_stop_total_us == OSNOISE_OPTION_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"osnoise/stop_tracing_total_us\", stop_total_us);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->stop_total_us = stop_total_us;\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_stop_total_us(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_stop_total_us == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_stop_total_us == context->stop_total_us)\n\t\tgoto out_done;\n\n\tretval = osnoise_write_ll_config(\"osnoise/stop_tracing_total_us\",\n\t\t\tcontext->orig_stop_total_us);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original osnoise stop_total_us\\n\");\n\nout_done:\n\tcontext->stop_total_us = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nvoid osnoise_put_stop_total_us(struct osnoise_context *context)\n{\n\tosnoise_restore_stop_total_us(context);\n\n\tif (context->orig_stop_total_us == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_stop_total_us = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nstatic long long\nosnoise_get_print_stack(struct osnoise_context *context)\n{\n\tlong long print_stack;\n\n\tif (context->print_stack != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->print_stack;\n\n\tif (context->orig_print_stack != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->orig_print_stack;\n\n\tprint_stack = osnoise_read_ll_config(\"osnoise/print_stack\");\n\tif (print_stack < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_print_stack = print_stack;\n\treturn print_stack;\n\nout_err:\n\treturn OSNOISE_OPTION_INIT_VAL;\n}\n\n \nint osnoise_set_print_stack(struct osnoise_context *context, long long print_stack)\n{\n\tlong long curr_print_stack = osnoise_get_print_stack(context);\n\tint retval;\n\n\tif (curr_print_stack == OSNOISE_OPTION_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"osnoise/print_stack\", print_stack);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->print_stack = print_stack;\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_print_stack(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_print_stack == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_print_stack == context->print_stack)\n\t\tgoto out_done;\n\n\tretval = osnoise_write_ll_config(\"osnoise/print_stack\", context->orig_print_stack);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original osnoise print_stack\\n\");\n\nout_done:\n\tcontext->print_stack = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nvoid osnoise_put_print_stack(struct osnoise_context *context)\n{\n\tosnoise_restore_print_stack(context);\n\n\tif (context->orig_print_stack == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_print_stack = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nstatic long long\nosnoise_get_tracing_thresh(struct osnoise_context *context)\n{\n\tlong long tracing_thresh;\n\n\tif (context->tracing_thresh != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->tracing_thresh;\n\n\tif (context->orig_tracing_thresh != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->orig_tracing_thresh;\n\n\ttracing_thresh = osnoise_read_ll_config(\"tracing_thresh\");\n\tif (tracing_thresh < 0)\n\t\tgoto out_err;\n\n\tcontext->orig_tracing_thresh = tracing_thresh;\n\treturn tracing_thresh;\n\nout_err:\n\treturn OSNOISE_OPTION_INIT_VAL;\n}\n\n \nint osnoise_set_tracing_thresh(struct osnoise_context *context, long long tracing_thresh)\n{\n\tlong long curr_tracing_thresh = osnoise_get_tracing_thresh(context);\n\tint retval;\n\n\tif (curr_tracing_thresh == OSNOISE_OPTION_INIT_VAL)\n\t\treturn -1;\n\n\tretval = osnoise_write_ll_config(\"tracing_thresh\", tracing_thresh);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->tracing_thresh = tracing_thresh;\n\n\treturn 0;\n}\n\n \nvoid osnoise_restore_tracing_thresh(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_tracing_thresh == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_tracing_thresh == context->tracing_thresh)\n\t\tgoto out_done;\n\n\tretval = osnoise_write_ll_config(\"tracing_thresh\", context->orig_tracing_thresh);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original tracing_thresh\\n\");\n\nout_done:\n\tcontext->tracing_thresh = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nvoid osnoise_put_tracing_thresh(struct osnoise_context *context)\n{\n\tosnoise_restore_tracing_thresh(context);\n\n\tif (context->orig_tracing_thresh == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_tracing_thresh = OSNOISE_OPTION_INIT_VAL;\n}\n\nstatic int osnoise_options_get_option(char *option)\n{\n\tchar *options = tracefs_instance_file_read(NULL, \"osnoise/options\", NULL);\n\tchar no_option[128];\n\tint retval = 0;\n\tchar *opt;\n\n\tif (!options)\n\t\treturn OSNOISE_OPTION_INIT_VAL;\n\n\t \n\tsnprintf(no_option, sizeof(no_option), \"NO_%s\", option);\n\n\topt = strstr(options, no_option);\n\tif (opt)\n\t\tgoto out_free;\n\n\t \n\topt = strstr(options, option);\n\tif (opt)\n\t\tretval = 1;\n\telse\n\t\tretval = OSNOISE_OPTION_INIT_VAL;\n\nout_free:\n\tfree(options);\n\treturn retval;\n}\n\nstatic int osnoise_options_set_option(char *option, bool onoff)\n{\n\tchar no_option[128];\n\n\tif (onoff)\n\t\treturn tracefs_instance_file_write(NULL, \"osnoise/options\", option);\n\n\tsnprintf(no_option, sizeof(no_option), \"NO_%s\", option);\n\n\treturn tracefs_instance_file_write(NULL, \"osnoise/options\", no_option);\n}\n\nstatic int osnoise_get_irq_disable(struct osnoise_context *context)\n{\n\tif (context->opt_irq_disable != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->opt_irq_disable;\n\n\tif (context->orig_opt_irq_disable != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->orig_opt_irq_disable;\n\n\tcontext->orig_opt_irq_disable = osnoise_options_get_option(\"OSNOISE_IRQ_DISABLE\");\n\n\treturn context->orig_opt_irq_disable;\n}\n\nint osnoise_set_irq_disable(struct osnoise_context *context, bool onoff)\n{\n\tint opt_irq_disable = osnoise_get_irq_disable(context);\n\tint retval;\n\n\tif (opt_irq_disable == OSNOISE_OPTION_INIT_VAL)\n\t\treturn -1;\n\n\tif (opt_irq_disable == onoff)\n\t\treturn 0;\n\n\tretval = osnoise_options_set_option(\"OSNOISE_IRQ_DISABLE\", onoff);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->opt_irq_disable = onoff;\n\n\treturn 0;\n}\n\nstatic void osnoise_restore_irq_disable(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_opt_irq_disable == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_opt_irq_disable == context->opt_irq_disable)\n\t\tgoto out_done;\n\n\tretval = osnoise_options_set_option(\"OSNOISE_IRQ_DISABLE\", context->orig_opt_irq_disable);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original OSNOISE_IRQ_DISABLE option\\n\");\n\nout_done:\n\tcontext->orig_opt_irq_disable = OSNOISE_OPTION_INIT_VAL;\n}\n\nstatic void osnoise_put_irq_disable(struct osnoise_context *context)\n{\n\tosnoise_restore_irq_disable(context);\n\n\tif (context->orig_opt_irq_disable == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_opt_irq_disable = OSNOISE_OPTION_INIT_VAL;\n}\n\nstatic int osnoise_get_workload(struct osnoise_context *context)\n{\n\tif (context->opt_workload != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->opt_workload;\n\n\tif (context->orig_opt_workload != OSNOISE_OPTION_INIT_VAL)\n\t\treturn context->orig_opt_workload;\n\n\tcontext->orig_opt_workload = osnoise_options_get_option(\"OSNOISE_WORKLOAD\");\n\n\treturn context->orig_opt_workload;\n}\n\nint osnoise_set_workload(struct osnoise_context *context, bool onoff)\n{\n\tint opt_workload = osnoise_get_workload(context);\n\tint retval;\n\n\tif (opt_workload == OSNOISE_OPTION_INIT_VAL)\n\t\treturn -1;\n\n\tif (opt_workload == onoff)\n\t\treturn 0;\n\n\tretval = osnoise_options_set_option(\"OSNOISE_WORKLOAD\", onoff);\n\tif (retval < 0)\n\t\treturn -1;\n\n\tcontext->opt_workload = onoff;\n\n\treturn 0;\n}\n\nstatic void osnoise_restore_workload(struct osnoise_context *context)\n{\n\tint retval;\n\n\tif (context->orig_opt_workload == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tif (context->orig_opt_workload == context->opt_workload)\n\t\tgoto out_done;\n\n\tretval = osnoise_options_set_option(\"OSNOISE_WORKLOAD\", context->orig_opt_workload);\n\tif (retval < 0)\n\t\terr_msg(\"Could not restore original OSNOISE_WORKLOAD option\\n\");\n\nout_done:\n\tcontext->orig_opt_workload = OSNOISE_OPTION_INIT_VAL;\n}\n\nstatic void osnoise_put_workload(struct osnoise_context *context)\n{\n\tosnoise_restore_workload(context);\n\n\tif (context->orig_opt_workload == OSNOISE_OPTION_INIT_VAL)\n\t\treturn;\n\n\tcontext->orig_opt_workload = OSNOISE_OPTION_INIT_VAL;\n}\n\n \nint enable_osnoise(struct trace_instance *trace)\n{\n\treturn enable_tracer_by_name(trace->inst, \"osnoise\");\n}\n\n \nint enable_timerlat(struct trace_instance *trace)\n{\n\treturn enable_tracer_by_name(trace->inst, \"timerlat\");\n}\n\nenum {\n\tFLAG_CONTEXT_NEWLY_CREATED\t= (1 << 0),\n\tFLAG_CONTEXT_DELETED\t\t= (1 << 1),\n};\n\n \nint osnoise_get_context(struct osnoise_context *context)\n{\n\tint ret;\n\n\tif (context->flags & FLAG_CONTEXT_DELETED) {\n\t\tret = -1;\n\t} else {\n\t\tcontext->ref++;\n\t\tret = 0;\n\t}\n\n\treturn ret;\n}\n\n \nstruct osnoise_context *osnoise_context_alloc(void)\n{\n\tstruct osnoise_context *context;\n\n\tcontext = calloc(1, sizeof(*context));\n\tif (!context)\n\t\treturn NULL;\n\n\tcontext->orig_stop_us\t\t= OSNOISE_OPTION_INIT_VAL;\n\tcontext->stop_us\t\t= OSNOISE_OPTION_INIT_VAL;\n\n\tcontext->orig_stop_total_us\t= OSNOISE_OPTION_INIT_VAL;\n\tcontext->stop_total_us\t\t= OSNOISE_OPTION_INIT_VAL;\n\n\tcontext->orig_print_stack\t= OSNOISE_OPTION_INIT_VAL;\n\tcontext->print_stack\t\t= OSNOISE_OPTION_INIT_VAL;\n\n\tcontext->orig_tracing_thresh\t= OSNOISE_OPTION_INIT_VAL;\n\tcontext->tracing_thresh\t\t= OSNOISE_OPTION_INIT_VAL;\n\n\tcontext->orig_opt_irq_disable\t= OSNOISE_OPTION_INIT_VAL;\n\tcontext->opt_irq_disable\t= OSNOISE_OPTION_INIT_VAL;\n\n\tcontext->orig_opt_workload\t= OSNOISE_OPTION_INIT_VAL;\n\tcontext->opt_workload\t\t= OSNOISE_OPTION_INIT_VAL;\n\n\tosnoise_get_context(context);\n\n\treturn context;\n}\n\n \nvoid osnoise_put_context(struct osnoise_context *context)\n{\n\tif (--context->ref < 1)\n\t\tcontext->flags |= FLAG_CONTEXT_DELETED;\n\n\tif (!(context->flags & FLAG_CONTEXT_DELETED))\n\t\treturn;\n\n\tosnoise_put_cpus(context);\n\tosnoise_put_runtime_period(context);\n\tosnoise_put_stop_us(context);\n\tosnoise_put_stop_total_us(context);\n\tosnoise_put_timerlat_period_us(context);\n\tosnoise_put_print_stack(context);\n\tosnoise_put_tracing_thresh(context);\n\tosnoise_put_irq_disable(context);\n\tosnoise_put_workload(context);\n\n\tfree(context);\n}\n\n \nvoid osnoise_destroy_tool(struct osnoise_tool *top)\n{\n\tif (!top)\n\t\treturn;\n\n\ttrace_instance_destroy(&top->trace);\n\n\tif (top->context)\n\t\tosnoise_put_context(top->context);\n\n\tfree(top);\n}\n\n \nstruct osnoise_tool *osnoise_init_tool(char *tool_name)\n{\n\tstruct osnoise_tool *top;\n\tint retval;\n\n\ttop = calloc(1, sizeof(*top));\n\tif (!top)\n\t\treturn NULL;\n\n\ttop->context = osnoise_context_alloc();\n\tif (!top->context)\n\t\tgoto out_err;\n\n\tretval = trace_instance_init(&top->trace, tool_name);\n\tif (retval)\n\t\tgoto out_err;\n\n\treturn top;\nout_err:\n\tosnoise_destroy_tool(top);\n\treturn NULL;\n}\n\n \nstruct osnoise_tool *osnoise_init_trace_tool(char *tracer)\n{\n\tstruct osnoise_tool *trace;\n\tint retval;\n\n\ttrace = osnoise_init_tool(\"osnoise_trace\");\n\tif (!trace)\n\t\treturn NULL;\n\n\tretval = tracefs_event_enable(trace->trace.inst, \"osnoise\", NULL);\n\tif (retval < 0 && !errno) {\n\t\terr_msg(\"Could not find osnoise events\\n\");\n\t\tgoto out_err;\n\t}\n\n\tretval = enable_tracer_by_name(trace->trace.inst, tracer);\n\tif (retval) {\n\t\terr_msg(\"Could not enable %s tracer for tracing\\n\", tracer);\n\t\tgoto out_err;\n\t}\n\n\treturn trace;\nout_err:\n\tosnoise_destroy_tool(trace);\n\treturn NULL;\n}\n\nstatic void osnoise_usage(int err)\n{\n\tint i;\n\n\tstatic const char *msg[] = {\n\t\t\"\",\n\t\t\"osnoise version \" VERSION,\n\t\t\"\",\n\t\t\"  usage: [rtla] osnoise [MODE] ...\",\n\t\t\"\",\n\t\t\"  modes:\",\n\t\t\"     top   - prints the summary from osnoise tracer\",\n\t\t\"     hist  - prints a histogram of osnoise samples\",\n\t\t\"\",\n\t\t\"if no MODE is given, the top mode is called, passing the arguments\",\n\t\tNULL,\n\t};\n\n\tfor (i = 0; msg[i]; i++)\n\t\tfprintf(stderr, \"%s\\n\", msg[i]);\n\texit(err);\n}\n\nint osnoise_main(int argc, char *argv[])\n{\n\tif (argc == 0)\n\t\tgoto usage;\n\n\t \n\tif (argc == 1) {\n\t\tosnoise_top_main(argc, argv);\n\t\texit(0);\n\t}\n\n\tif ((strcmp(argv[1], \"-h\") == 0) || (strcmp(argv[1], \"--help\") == 0)) {\n\t\tosnoise_usage(0);\n\t} else if (strncmp(argv[1], \"-\", 1) == 0) {\n\t\t \n\t\tosnoise_top_main(argc, argv);\n\t\texit(0);\n\t} else if (strcmp(argv[1], \"top\") == 0) {\n\t\tosnoise_top_main(argc-1, &argv[1]);\n\t\texit(0);\n\t} else if (strcmp(argv[1], \"hist\") == 0) {\n\t\tosnoise_hist_main(argc-1, &argv[1]);\n\t\texit(0);\n\t}\n\nusage:\n\tosnoise_usage(1);\n\texit(1);\n}\n\nint hwnoise_main(int argc, char *argv[])\n{\n\tosnoise_top_main(argc, argv);\n\texit(0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}