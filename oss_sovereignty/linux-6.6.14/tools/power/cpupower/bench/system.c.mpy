{
  "module_name": "system.c",
  "hash_id": "89d35daff115730911ad31d699654ad7eb78281e639f2977a65aded2dd342371",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/bench/system.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <time.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <unistd.h>\n\n#include <sched.h>\n\n#include <cpufreq.h>\n#include <cpupower.h>\n\n#include \"config.h\"\n#include \"system.h\"\n\n \n\nlong long int get_time()\n{\n\tstruct timeval now;\n\n\tgettimeofday(&now, NULL);\n\n\treturn (long long int)(now.tv_sec * 1000000LL + now.tv_usec);\n}\n\n \n\nint set_cpufreq_governor(char *governor, unsigned int cpu)\n{\n\n\tdprintf(\"set %s as cpufreq governor\\n\", governor);\n\n\tif (cpupower_is_cpu_online(cpu) != 1) {\n\t\tperror(\"cpufreq_cpu_exists\");\n\t\tfprintf(stderr, \"error: cpu %u does not exist\\n\", cpu);\n\t\treturn -1;\n\t}\n\n\tif (cpufreq_modify_policy_governor(cpu, governor) != 0) {\n\t\tperror(\"cpufreq_modify_policy_governor\");\n\t\tfprintf(stderr, \"error: unable to set %s governor\\n\", governor);\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\n \n\nint set_cpu_affinity(unsigned int cpu)\n{\n\tcpu_set_t cpuset;\n\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(cpu, &cpuset);\n\n\tdprintf(\"set affinity to cpu #%u\\n\", cpu);\n\n\tif (sched_setaffinity(getpid(), sizeof(cpu_set_t), &cpuset) < 0) {\n\t\tperror(\"sched_setaffinity\");\n\t\tfprintf(stderr, \"warning: unable to set cpu affinity\\n\");\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\n \n\nint set_process_priority(int priority)\n{\n\tstruct sched_param param;\n\n\tdprintf(\"set scheduler priority to %i\\n\", priority);\n\n\tparam.sched_priority = priority;\n\n\tif (sched_setscheduler(0, SCHEDULER, &param) < 0) {\n\t\tperror(\"sched_setscheduler\");\n\t\tfprintf(stderr, \"warning: unable to set scheduler priority\\n\");\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\n \n\nvoid prepare_user(const struct config *config)\n{\n\tunsigned long sleep_time = 0;\n\tunsigned long load_time = 0;\n\tunsigned int round;\n\n\tfor (round = 0; round < config->rounds; round++) {\n\t\tsleep_time +=  2 * config->cycles *\n\t\t\t(config->sleep + config->sleep_step * round);\n\t\tload_time += 2 * config->cycles *\n\t\t\t(config->load + config->load_step * round) +\n\t\t\t(config->load + config->load_step * round * 4);\n\t}\n\n\tif (config->verbose || config->output != stdout)\n\t\tprintf(\"approx. test duration: %im\\n\",\n\t\t       (int)((sleep_time + load_time) / 60000000));\n}\n\n \n\nvoid prepare_system(const struct config *config)\n{\n\tif (config->verbose)\n\t\tprintf(\"set cpu affinity to cpu #%u\\n\", config->cpu);\n\n\tset_cpu_affinity(config->cpu);\n\n\tswitch (config->prio) {\n\tcase SCHED_HIGH:\n\t\tif (config->verbose)\n\t\t\tprintf(\"high priority condition requested\\n\");\n\n\t\tset_process_priority(PRIORITY_HIGH);\n\t\tbreak;\n\tcase SCHED_LOW:\n\t\tif (config->verbose)\n\t\t\tprintf(\"low priority condition requested\\n\");\n\n\t\tset_process_priority(PRIORITY_LOW);\n\t\tbreak;\n\tdefault:\n\t\tif (config->verbose)\n\t\t\tprintf(\"default priority condition requested\\n\");\n\n\t\tset_process_priority(PRIORITY_DEFAULT);\n\t}\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}