{
  "module_name": "benchmark.c",
  "hash_id": "0fcb0a49bea2b76b76cf8a805293dc19a0590e68a09c2c575b651d50224688ff",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/bench/benchmark.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <unistd.h>\n#include <math.h>\n\n#include \"config.h\"\n#include \"system.h\"\n#include \"benchmark.h\"\n\n \n#define show_progress(total_time, progress_time)\t\\\nif (config->output != stdout) {\t\t\t\t\\\n\tfprintf(stdout, \"Progress: %02lu %%\\r\",\t\t\\\n\t\t(progress_time * 100) / total_time);\t\\\n\tfflush(stdout);\t\t\t\t\t\\\n}\n\n \n\nunsigned int calculate_timespace(long load, struct config *config)\n{\n\tint i;\n\tlong long now, then;\n\tunsigned int estimated = GAUGECOUNT;\n\tunsigned int rounds = 0;\n\tunsigned int timed = 0;\n\n\tif (config->verbose)\n\t\tprintf(\"calibrating load of %lius, please wait...\\n\", load);\n\n\t \n\tnow = get_time();\n\tROUNDS(estimated);\n\tthen = get_time();\n\n\ttimed = (unsigned int)(then - now);\n\n\t \n\tfor (i = 0; i < 4; i++) {\n\t\trounds = (unsigned int)(load * estimated / timed);\n\t\tdprintf(\"calibrating with %u rounds\\n\", rounds);\n\t\tnow = get_time();\n\t\tROUNDS(rounds);\n\t\tthen = get_time();\n\n\t\ttimed = (unsigned int)(then - now);\n\t\testimated = rounds;\n\t}\n\tif (config->verbose)\n\t\tprintf(\"calibration done\\n\");\n\n\treturn estimated;\n}\n\n \n\nvoid start_benchmark(struct config *config)\n{\n\tunsigned int _round, cycle;\n\tlong long now, then;\n\tlong sleep_time = 0, load_time = 0;\n\tlong performance_time = 0, powersave_time = 0;\n\tunsigned int calculations;\n\tunsigned long total_time = 0, progress_time = 0;\n\n\tsleep_time = config->sleep;\n\tload_time = config->load;\n\n\t \n\tfor (_round = 1; _round <= config->rounds; _round++)\n\t\ttotal_time += _round * (config->sleep + config->load);\n\ttotal_time *= 2;  \n\n\tfor (_round = 0; _round < config->rounds; _round++) {\n\t\tperformance_time = 0LL;\n\t\tpowersave_time = 0LL;\n\n\t\tshow_progress(total_time, progress_time);\n\n\t\t \n\t\tif (set_cpufreq_governor(\"performance\", config->cpu) != 0)\n\t\t\treturn;\n\n\t\t \n\t\tcalculations = calculate_timespace(load_time, config);\n\n\t\tif (config->verbose)\n\t\t\tprintf(\"_round %i: doing %u cycles with %u calculations\"\n\t\t\t       \" for %lius\\n\", _round + 1, config->cycles,\n\t\t\t       calculations, load_time);\n\n\t\tfprintf(config->output, \"%u %li %li \",\n\t\t\t_round, load_time, sleep_time);\n\n\t\tif (config->verbose)\n\t\t\tprintf(\"average: %lius, rps:%li\\n\",\n\t\t\t\tload_time / calculations,\n\t\t\t\t1000000 * calculations / load_time);\n\n\t\t \n\t\tfor (cycle = 0; cycle < config->cycles; cycle++) {\n\t\t\tnow = get_time();\n\t\t\tusleep(sleep_time);\n\t\t\tROUNDS(calculations);\n\t\t\tthen = get_time();\n\t\t\tperformance_time += then - now - sleep_time;\n\t\t\tif (config->verbose)\n\t\t\t\tprintf(\"performance cycle took %lius, \"\n\t\t\t\t\t\"sleep: %lius, \"\n\t\t\t\t\t\"load: %lius, rounds: %u\\n\",\n\t\t\t\t\t(long)(then - now), sleep_time,\n\t\t\t\t\tload_time, calculations);\n\t\t}\n\t\tfprintf(config->output, \"%li \",\n\t\t\tperformance_time / config->cycles);\n\n\t\tprogress_time += sleep_time + load_time;\n\t\tshow_progress(total_time, progress_time);\n\n\t\t \n\t\tif (set_cpufreq_governor(config->governor, config->cpu) != 0)\n\t\t\treturn;\n\n\t\t \n\t\tfor (cycle = 0; cycle < config->cycles; cycle++) {\n\t\t\tnow = get_time();\n\t\t\tusleep(sleep_time);\n\t\t\tROUNDS(calculations);\n\t\t\tthen = get_time();\n\t\t\tpowersave_time += then - now - sleep_time;\n\t\t\tif (config->verbose)\n\t\t\t\tprintf(\"powersave cycle took %lius, \"\n\t\t\t\t\t\"sleep: %lius, \"\n\t\t\t\t\t\"load: %lius, rounds: %u\\n\",\n\t\t\t\t\t(long)(then - now), sleep_time,\n\t\t\t\t\tload_time, calculations);\n\t\t}\n\n\t\tprogress_time += sleep_time + load_time;\n\n\t\t \n\t\tfprintf(config->output, \"%li \",\n\t\t\tpowersave_time / config->cycles);\n\t\tfprintf(config->output, \"%.3f\\n\",\n\t\t\tperformance_time * 100.0 / powersave_time);\n\t\tfflush(config->output);\n\n\t\tif (config->verbose)\n\t\t\tprintf(\"performance is at %.2f%%\\n\",\n\t\t\t\tperformance_time * 100.0 / powersave_time);\n\n\t\tsleep_time += config->sleep_step;\n\t\tload_time += config->load_step;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}