{
  "module_name": "parse.c",
  "hash_id": "a281068dd91d621829572caf7b13b663069cf5f13efb36dc964a58738b30aa11",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/bench/parse.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdarg.h>\n#include <string.h>\n#include <time.h>\n#include <dirent.h>\n\n#include <sys/utsname.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n\n#include \"parse.h\"\n#include \"config.h\"\n\n \n\nenum sched_prio string_to_prio(const char *str)\n{\n\tif (strncasecmp(\"high\", str, strlen(str)) == 0)\n\t\treturn  SCHED_HIGH;\n\telse if (strncasecmp(\"default\", str, strlen(str)) == 0)\n\t\treturn SCHED_DEFAULT;\n\telse if (strncasecmp(\"low\", str, strlen(str)) == 0)\n\t\treturn SCHED_LOW;\n\telse\n\t\treturn SCHED_ERR;\n}\n\n \n\nFILE *prepare_output(const char *dirname)\n{\n\tFILE *output = NULL;\n\tint len;\n\tchar *filename, *filename_tmp;\n\tstruct utsname sysdata;\n\tDIR *dir;\n\n\tdir = opendir(dirname);\n\tif (dir == NULL) {\n\t\tif (mkdir(dirname, 0755)) {\n\t\t\tperror(\"mkdir\");\n\t\t\tfprintf(stderr, \"error: Cannot create dir %s\\n\",\n\t\t\t\tdirname);\n\t\t\treturn NULL;\n\t\t}\n\t}\n\n\tlen = strlen(dirname) + 30;\n\tfilename = malloc(sizeof(char) * len);\n\tif (!filename) {\n\t\tperror(\"malloc\");\n\t\tgoto out_dir;\n\t}\n\n\tif (uname(&sysdata) == 0) {\n\t\tlen += strlen(sysdata.nodename) + strlen(sysdata.release);\n\t\tfilename_tmp = realloc(filename, sizeof(*filename) * len);\n\n\t\tif (filename_tmp == NULL) {\n\t\t\tfree(filename);\n\t\t\tperror(\"realloc\");\n\t\t\tgoto out_dir;\n\t\t}\n\n\t\tfilename = filename_tmp;\n\t\tsnprintf(filename, len - 1, \"%s/benchmark_%s_%s_%li.log\",\n\t\t\tdirname, sysdata.nodename, sysdata.release, time(NULL));\n\t} else {\n\t\tsnprintf(filename, len - 1, \"%s/benchmark_%li.log\",\n\t\t\tdirname, time(NULL));\n\t}\n\n\tdprintf(\"logfilename: %s\\n\", filename);\n\n\toutput = fopen(filename, \"w+\");\n\tif (output == NULL) {\n\t\tperror(\"fopen\");\n\t\tfprintf(stderr, \"error: unable to open logfile\\n\");\n\t\tgoto out;\n\t}\n\n\tfprintf(stdout, \"Logfile: %s\\n\", filename);\n\n\tfprintf(output, \"#round load sleep performance powersave percentage\\n\");\nout:\n\tfree(filename);\nout_dir:\n\tclosedir(dir);\n\treturn output;\n}\n\n \n\nstruct config *prepare_default_config()\n{\n\tstruct config *config = malloc(sizeof(struct config));\n\n\tdprintf(\"loading defaults\\n\");\n\n\tconfig->sleep = 500000;\n\tconfig->load = 500000;\n\tconfig->sleep_step = 500000;\n\tconfig->load_step = 500000;\n\tconfig->cycles = 5;\n\tconfig->rounds = 50;\n\tconfig->cpu = 0;\n\tconfig->prio = SCHED_HIGH;\n\tconfig->verbose = 0;\n\tstrncpy(config->governor, \"ondemand\", sizeof(config->governor));\n\n\tconfig->output = stdout;\n\n#ifdef DEFAULT_CONFIG_FILE\n\tif (prepare_config(DEFAULT_CONFIG_FILE, config))\n\t\treturn NULL;\n#endif\n\treturn config;\n}\n\n \n\nint prepare_config(const char *path, struct config *config)\n{\n\tsize_t len = 0;\n\tchar opt[16], val[32], *line = NULL;\n\tFILE *configfile;\n\n\tif (config == NULL) {\n\t\tfprintf(stderr, \"error: config is NULL\\n\");\n\t\treturn 1;\n\t}\n\n\tconfigfile = fopen(path, \"r\");\n\tif (configfile == NULL) {\n\t\tperror(\"fopen\");\n\t\tfprintf(stderr, \"error: unable to read configfile\\n\");\n\t\tfree(config);\n\t\treturn 1;\n\t}\n\n\twhile (getline(&line, &len, configfile) != -1) {\n\t\tif (line[0] == '#' || line[0] == ' ' || line[0] == '\\n')\n\t\t\tcontinue;\n\n\t\tif (sscanf(line, \"%14s = %30s\", opt, val) < 2)\n\t\t\tcontinue;\n\n\t\tdprintf(\"parsing: %s -> %s\\n\", opt, val);\n\n\t\tif (strcmp(\"sleep\", opt) == 0)\n\t\t\tsscanf(val, \"%li\", &config->sleep);\n\n\t\telse if (strcmp(\"load\", opt) == 0)\n\t\t\tsscanf(val, \"%li\", &config->load);\n\n\t\telse if (strcmp(\"load_step\", opt) == 0)\n\t\t\tsscanf(val, \"%li\", &config->load_step);\n\n\t\telse if (strcmp(\"sleep_step\", opt) == 0)\n\t\t\tsscanf(val, \"%li\", &config->sleep_step);\n\n\t\telse if (strcmp(\"cycles\", opt) == 0)\n\t\t\tsscanf(val, \"%u\", &config->cycles);\n\n\t\telse if (strcmp(\"rounds\", opt) == 0)\n\t\t\tsscanf(val, \"%u\", &config->rounds);\n\n\t\telse if (strcmp(\"verbose\", opt) == 0)\n\t\t\tsscanf(val, \"%u\", &config->verbose);\n\n\t\telse if (strcmp(\"output\", opt) == 0)\n\t\t\tconfig->output = prepare_output(val); \n\n\t\telse if (strcmp(\"cpu\", opt) == 0)\n\t\t\tsscanf(val, \"%u\", &config->cpu);\n\n\t\telse if (strcmp(\"governor\", opt) == 0) {\n\t\t\tstrncpy(config->governor, val,\n\t\t\t\t\tsizeof(config->governor));\n\t\t\tconfig->governor[sizeof(config->governor) - 1] = '\\0';\n\t\t}\n\n\t\telse if (strcmp(\"priority\", opt) == 0) {\n\t\t\tif (string_to_prio(val) != SCHED_ERR)\n\t\t\t\tconfig->prio = string_to_prio(val);\n\t\t}\n\t}\n\n\tfree(line);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}