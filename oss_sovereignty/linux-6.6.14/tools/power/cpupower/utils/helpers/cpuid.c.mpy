{
  "module_name": "cpuid.c",
  "hash_id": "d468b7933f76643255ae086456f3a3ab1a0b43e934de5249db632fca705dd54b",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/utils/helpers/cpuid.c",
  "human_readable_source": "\n#include <stdio.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdlib.h>\n\n#include \"helpers/helpers.h\"\n\nstatic const char *cpu_vendor_table[X86_VENDOR_MAX] = {\n\t\"Unknown\", \"GenuineIntel\", \"AuthenticAMD\", \"HygonGenuine\",\n};\n\n#if defined(__i386__) || defined(__x86_64__)\n\n \n#include <cpuid.h>\n\n \n#define cpuid_func(reg)\t\t\t\t\t\\\n\tunsigned int cpuid_##reg(unsigned int op)\t\\\n\t{\t\t\t\t\t\t\\\n\tunsigned int eax, ebx, ecx, edx;\t\t\\\n\t__cpuid(op, eax, ebx, ecx, edx);\t\t\\\n\treturn reg;\t\t\t\t\t\\\n\t}\ncpuid_func(eax);\ncpuid_func(ebx);\ncpuid_func(ecx);\ncpuid_func(edx);\n\n#endif  \n\n \nint get_cpu_info(struct cpupower_cpu_info *cpu_info)\n{\n\tFILE *fp;\n\tchar value[64];\n\tunsigned int proc, x;\n\tunsigned int unknown = 0xffffff;\n\tunsigned int cpuid_level, ext_cpuid_level;\n\n\tint ret = -EINVAL;\n\n\tcpu_info->vendor\t\t= X86_VENDOR_UNKNOWN;\n\tcpu_info->family\t\t= unknown;\n\tcpu_info->model\t\t\t= unknown;\n\tcpu_info->stepping\t\t= unknown;\n\tcpu_info->caps\t\t\t= 0;\n\n\tfp = fopen(\"/proc/cpuinfo\", \"r\");\n\tif (!fp)\n\t\treturn -EIO;\n\n\twhile (!feof(fp)) {\n\t\tif (!fgets(value, 64, fp))\n\t\t\tcontinue;\n\t\tvalue[63 - 1] = '\\0';\n\n\t\tif (!strncmp(value, \"processor\\t: \", 12))\n\t\t\tsscanf(value, \"processor\\t: %u\", &proc);\n\n\t\tif (proc != (unsigned int)base_cpu)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (!strncmp(value, \"vendor_id\", 9)) {\n\t\t\tfor (x = 1; x < X86_VENDOR_MAX; x++) {\n\t\t\t\tif (strstr(value, cpu_vendor_table[x]))\n\t\t\t\t\tcpu_info->vendor = x;\n\t\t\t}\n\t\t \n\t\t} else if (!strncmp(value, \"cpu family\\t: \", 13)) {\n\t\t\tsscanf(value, \"cpu family\\t: %u\",\n\t\t\t       &cpu_info->family);\n\t\t} else if (!strncmp(value, \"model\\t\\t: \", 9)) {\n\t\t\tsscanf(value, \"model\\t\\t: %u\",\n\t\t\t       &cpu_info->model);\n\t\t} else if (!strncmp(value, \"stepping\\t: \", 10)) {\n\t\t\tsscanf(value, \"stepping\\t: %u\",\n\t\t\t       &cpu_info->stepping);\n\n\t\t\t \n\t\t\tif (cpu_info->vendor == X86_VENDOR_UNKNOWN ||\n\t\t\t    cpu_info->family == unknown ||\n\t\t\t    cpu_info->model == unknown ||\n\t\t\t    cpu_info->stepping == unknown) {\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto out;\n\t\t\t}\n\n\t\t\tret = 0;\n\t\t\tgoto out;\n\t\t}\n\t}\n\tret = -ENODEV;\nout:\n\tfclose(fp);\n\t \n\tif (cpu_info->vendor != X86_VENDOR_AMD &&\n\t    cpu_info->vendor != X86_VENDOR_HYGON &&\n\t    cpu_info->vendor != X86_VENDOR_INTEL)\n\t\treturn ret;\n\n\tcpuid_level\t= cpuid_eax(0);\n\text_cpuid_level\t= cpuid_eax(0x80000000);\n\n\t \n\tif (ext_cpuid_level >= 0x80000007 &&\n\t    (cpuid_edx(0x80000007) & (1 << 8)))\n\t\tcpu_info->caps |= CPUPOWER_CAP_INV_TSC;\n\n\t \n\tif (cpuid_level >= 6 && (cpuid_ecx(6) & 0x1))\n\t\tcpu_info->caps |= CPUPOWER_CAP_APERF;\n\n\t \n\tif (cpu_info->vendor == X86_VENDOR_AMD ||\n\t    cpu_info->vendor == X86_VENDOR_HYGON) {\n\t\tif (ext_cpuid_level >= 0x80000007) {\n\t\t\tif (cpuid_edx(0x80000007) & (1 << 9)) {\n\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_AMD_CPB;\n\n\t\t\t\tif (cpu_info->family >= 0x17)\n\t\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_AMD_CPB_MSR;\n\t\t\t}\n\n\t\t\tif ((cpuid_edx(0x80000007) & (1 << 7)) &&\n\t\t\t    cpu_info->family != 0x14) {\n\t\t\t\t \n\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_AMD_HW_PSTATE;\n\n\t\t\t\tif (cpu_info->family >= 0x17)\n\t\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_AMD_PSTATEDEF;\n\t\t\t}\n\t\t}\n\n\t\tif (ext_cpuid_level >= 0x80000008 &&\n\t\t    cpuid_ebx(0x80000008) & (1 << 4))\n\t\t\tcpu_info->caps |= CPUPOWER_CAP_AMD_RDPRU;\n\n\t\tif (cpupower_amd_pstate_enabled()) {\n\t\t\tcpu_info->caps |= CPUPOWER_CAP_AMD_PSTATE;\n\n\t\t\t \n\t\t\tcpu_info->caps &= ~CPUPOWER_CAP_AMD_CPB;\n\t\t\tcpu_info->caps &= ~CPUPOWER_CAP_AMD_CPB_MSR;\n\t\t\tcpu_info->caps &= ~CPUPOWER_CAP_AMD_HW_PSTATE;\n\t\t\tcpu_info->caps &= ~CPUPOWER_CAP_AMD_PSTATEDEF;\n\t\t}\n\t}\n\n\tif (cpu_info->vendor == X86_VENDOR_INTEL) {\n\t\tif (cpuid_level >= 6 &&\n\t\t    (cpuid_eax(6) & (1 << 1)))\n\t\t\tcpu_info->caps |= CPUPOWER_CAP_INTEL_IDA;\n\t}\n\n\tif (cpu_info->vendor == X86_VENDOR_INTEL) {\n\t\t \n\t\tif (cpuid_level >= 6 && (cpuid_ecx(6) & (1 << 3)))\n\t\t\tcpu_info->caps |= CPUPOWER_CAP_PERF_BIAS;\n\n\t\t \n\t\tif (cpu_info->family == 6) {\n\t\t\tswitch (cpu_info->model) {\n\t\t\tcase 0x1A:\t \n\t\t\tcase 0x1E:\t \n\t\t\tcase 0x1F:\t \n\t\t\tcase 0x25:\t \n\t\t\tcase 0x2C:\t \n\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_HAS_TURBO_RATIO;\n\t\t\t\tbreak;\n\t\t\tcase 0x2A:\t \n\t\t\tcase 0x2D:\t \n\t\t\tcase 0x3A:\t \n\t\t\tcase 0x3E:\t \n\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_HAS_TURBO_RATIO;\n\t\t\t\tcpu_info->caps |= CPUPOWER_CAP_IS_SNB;\n\t\t\t\tbreak;\n\t\t\tcase 0x2E:\t \n\t\t\tcase 0x2F:\t \n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}