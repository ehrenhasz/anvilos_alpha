{
  "module_name": "misc.c",
  "hash_id": "3e741398f406405dc1bfcd5e0442a2fc98b0076f2e2c0b6729c1500a0ebc8ed2",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/utils/helpers/misc.c",
  "human_readable_source": "\n\n#include <stdio.h>\n#include <errno.h>\n#include <stdlib.h>\n#include <string.h>\n\n#include \"helpers/helpers.h\"\n#include \"helpers/sysfs.h\"\n#include \"cpufreq.h\"\n\n#if defined(__i386__) || defined(__x86_64__)\n\n#include \"cpupower_intern.h\"\n\n#define MSR_AMD_HWCR\t0xc0010015\n\nint cpufreq_has_boost_support(unsigned int cpu, int *support, int *active,\n\t\t\tint *states)\n{\n\tint ret;\n\tunsigned long long val;\n\n\t*support = *active = *states = 0;\n\n\tif (cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_CPB) {\n\t\t*support = 1;\n\n\t\t \n\n\t\tif (cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_CPB_MSR) {\n\t\t\tif (!read_msr(cpu, MSR_AMD_HWCR, &val)) {\n\t\t\t\tif (!(val & CPUPOWER_AMD_CPBDIS))\n\t\t\t\t\t*active = 1;\n\t\t\t}\n\t\t} else {\n\t\t\tret = amd_pci_get_num_boost_states(active, states);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\t} else if (cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) {\n\t\tamd_pstate_boost_init(cpu, support, active);\n\t} else if (cpupower_cpu_info.caps & CPUPOWER_CAP_INTEL_IDA)\n\t\t*support = *active = 1;\n\treturn 0;\n}\n\nint cpupower_intel_get_perf_bias(unsigned int cpu)\n{\n\tchar linebuf[MAX_LINE_LEN];\n\tchar path[SYSFS_PATH_MAX];\n\tunsigned long val;\n\tchar *endp;\n\n\tif (!(cpupower_cpu_info.caps & CPUPOWER_CAP_PERF_BIAS))\n\t\treturn -1;\n\n\tsnprintf(path, sizeof(path), PATH_TO_CPU \"cpu%u/power/energy_perf_bias\", cpu);\n\n\tif (cpupower_read_sysfs(path, linebuf, MAX_LINE_LEN) == 0)\n\t\treturn -1;\n\n\tval = strtol(linebuf, &endp, 0);\n\tif (endp == linebuf || errno == ERANGE)\n\t\treturn -1;\n\n\treturn val;\n}\n\nint cpupower_intel_set_perf_bias(unsigned int cpu, unsigned int val)\n{\n\tchar path[SYSFS_PATH_MAX];\n\tchar linebuf[3] = {};\n\n\tif (!(cpupower_cpu_info.caps & CPUPOWER_CAP_PERF_BIAS))\n\t\treturn -1;\n\n\tsnprintf(path, sizeof(path), PATH_TO_CPU \"cpu%u/power/energy_perf_bias\", cpu);\n\tsnprintf(linebuf, sizeof(linebuf), \"%d\", val);\n\n\tif (cpupower_write_sysfs(path, linebuf, 3) <= 0)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nint cpupower_set_epp(unsigned int cpu, char *epp)\n{\n\tchar path[SYSFS_PATH_MAX];\n\tchar linebuf[30] = {};\n\n\tsnprintf(path, sizeof(path),\n\t\tPATH_TO_CPU \"cpu%u/cpufreq/energy_performance_preference\", cpu);\n\n\tif (!is_valid_path(path))\n\t\treturn -1;\n\n\tsnprintf(linebuf, sizeof(linebuf), \"%s\", epp);\n\n\tif (cpupower_write_sysfs(path, linebuf, 30) <= 0)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nint cpupower_set_amd_pstate_mode(char *mode)\n{\n\tchar path[SYSFS_PATH_MAX];\n\tchar linebuf[20] = {};\n\n\tsnprintf(path, sizeof(path), PATH_TO_CPU \"amd_pstate/status\");\n\n\tif (!is_valid_path(path))\n\t\treturn -1;\n\n\tsnprintf(linebuf, sizeof(linebuf), \"%s\\n\", mode);\n\n\tif (cpupower_write_sysfs(path, linebuf, 20) <= 0)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nint cpupower_set_turbo_boost(int turbo_boost)\n{\n\tchar path[SYSFS_PATH_MAX];\n\tchar linebuf[2] = {};\n\n\tsnprintf(path, sizeof(path), PATH_TO_CPU \"cpufreq/boost\");\n\n\tif (!is_valid_path(path))\n\t\treturn -1;\n\n\tsnprintf(linebuf, sizeof(linebuf), \"%d\", turbo_boost);\n\n\tif (cpupower_write_sysfs(path, linebuf, 2) <= 0)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nbool cpupower_amd_pstate_enabled(void)\n{\n\tchar *driver = cpufreq_get_driver(0);\n\tbool ret = false;\n\n\tif (!driver)\n\t\treturn ret;\n\n\tif (!strncmp(driver, \"amd\", 3))\n\t\tret = true;\n\n\tcpufreq_put_driver(driver);\n\n\treturn ret;\n}\n\n#endif  \n\n \nvoid get_cpustate(void)\n{\n\tunsigned int cpu = 0;\n\n\tbitmask_clearall(online_cpus);\n\tbitmask_clearall(offline_cpus);\n\n\tfor (cpu = bitmask_first(cpus_chosen);\n\t\tcpu <= bitmask_last(cpus_chosen); cpu++) {\n\n\t\tif (cpupower_is_cpu_online(cpu) == 1)\n\t\t\tbitmask_setbit(online_cpus, cpu);\n\t\telse\n\t\t\tbitmask_setbit(offline_cpus, cpu);\n\n\t\tcontinue;\n\t}\n}\n\n \nvoid print_online_cpus(void)\n{\n\tint str_len = 0;\n\tchar *online_cpus_str = NULL;\n\n\tstr_len = online_cpus->size * 5;\n\tonline_cpus_str = (void *)malloc(sizeof(char) * str_len);\n\n\tif (!bitmask_isallclear(online_cpus)) {\n\t\tbitmask_displaylist(online_cpus_str, str_len, online_cpus);\n\t\tprintf(_(\"Following CPUs are online:\\n%s\\n\"), online_cpus_str);\n\t}\n}\n\n \nvoid print_offline_cpus(void)\n{\n\tint str_len = 0;\n\tchar *offline_cpus_str = NULL;\n\n\tstr_len = offline_cpus->size * 5;\n\toffline_cpus_str = (void *)malloc(sizeof(char) * str_len);\n\n\tif (!bitmask_isallclear(offline_cpus)) {\n\t\tbitmask_displaylist(offline_cpus_str, str_len, offline_cpus);\n\t\tprintf(_(\"Following CPUs are offline:\\n%s\\n\"), offline_cpus_str);\n\t\tprintf(_(\"cpupower set operation was not performed on them\\n\"));\n\t}\n}\n\n \nvoid print_speed(unsigned long speed, int no_rounding)\n{\n\tunsigned long tmp;\n\n\tif (no_rounding) {\n\t\tif (speed > 1000000)\n\t\t\tprintf(\"%u.%06u GHz\", ((unsigned int)speed / 1000000),\n\t\t\t       ((unsigned int)speed % 1000000));\n\t\telse if (speed > 1000)\n\t\t\tprintf(\"%u.%03u MHz\", ((unsigned int)speed / 1000),\n\t\t\t       (unsigned int)(speed % 1000));\n\t\telse\n\t\t\tprintf(\"%lu kHz\", speed);\n\t} else {\n\t\tif (speed > 1000000) {\n\t\t\ttmp = speed % 10000;\n\t\t\tif (tmp >= 5000)\n\t\t\t\tspeed += 10000;\n\t\t\tprintf(\"%u.%02u GHz\", ((unsigned int)speed / 1000000),\n\t\t\t       ((unsigned int)(speed % 1000000) / 10000));\n\t\t} else if (speed > 100000) {\n\t\t\ttmp = speed % 1000;\n\t\t\tif (tmp >= 500)\n\t\t\t\tspeed += 1000;\n\t\t\tprintf(\"%u MHz\", ((unsigned int)speed / 1000));\n\t\t} else if (speed > 1000) {\n\t\t\ttmp = speed % 100;\n\t\t\tif (tmp >= 50)\n\t\t\t\tspeed += 100;\n\t\t\tprintf(\"%u.%01u MHz\", ((unsigned int)speed / 1000),\n\t\t\t       ((unsigned int)(speed % 1000) / 100));\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}