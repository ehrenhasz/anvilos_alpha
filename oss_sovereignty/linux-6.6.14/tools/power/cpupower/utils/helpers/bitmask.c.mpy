{
  "module_name": "bitmask.c",
  "hash_id": "0fbff45a08860ddcce2a4a05ce59caccf601784641701355bff63ef394b6b801",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/utils/helpers/bitmask.c",
  "human_readable_source": "\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\n#include <helpers/bitmask.h>\n\n \n#define bitsperlong (8 * sizeof(unsigned long))\n\n \n#define howmany(x, y) (((x)+((y)-1))/(y))\n\n \n#define longsperbits(n) howmany(n, bitsperlong)\n\n#define max(a, b) ((a) > (b) ? (a) : (b))\n\n \n\n \nstruct bitmask *bitmask_alloc(unsigned int n)\n{\n\tstruct bitmask *bmp;\n\n\tbmp = malloc(sizeof(*bmp));\n\tif (!bmp)\n\t\treturn 0;\n\tbmp->size = n;\n\tbmp->maskp = calloc(longsperbits(n), sizeof(unsigned long));\n\tif (!bmp->maskp) {\n\t\tfree(bmp);\n\t\treturn 0;\n\t}\n\treturn bmp;\n}\n\n \nvoid bitmask_free(struct bitmask *bmp)\n{\n\tif (!bmp)\n\t\treturn;\n\tfree(bmp->maskp);\n\tbmp->maskp = (unsigned long *)0xdeadcdef;   \n\tfree(bmp);\n}\n\n \n\n \nstatic unsigned int _getbit(const struct bitmask *bmp, unsigned int n)\n{\n\tif (n < bmp->size)\n\t\treturn (bmp->maskp[n/bitsperlong] >> (n % bitsperlong)) & 1;\n\telse\n\t\treturn 0;\n}\n\n \nstatic void _setbit(struct bitmask *bmp, unsigned int n, unsigned int v)\n{\n\tif (n < bmp->size) {\n\t\tif (v)\n\t\t\tbmp->maskp[n/bitsperlong] |= 1UL << (n % bitsperlong);\n\t\telse\n\t\t\tbmp->maskp[n/bitsperlong] &=\n\t\t\t\t~(1UL << (n % bitsperlong));\n\t}\n}\n\n \nstatic int scan_was_ok(int sret, char nextc, const char *ok_next_chars)\n{\n\treturn sret == 1 ||\n\t\t(sret == 2 && strchr(ok_next_chars, nextc) != NULL);\n}\n\nstatic const char *nexttoken(const char *q,  int sep)\n{\n\tif (q)\n\t\tq = strchr(q, sep);\n\tif (q)\n\t\tq++;\n\treturn q;\n}\n\n \nstruct bitmask *bitmask_setbit(struct bitmask *bmp, unsigned int i)\n{\n\t_setbit(bmp, i, 1);\n\treturn bmp;\n}\n\n \nstruct bitmask *bitmask_setall(struct bitmask *bmp)\n{\n\tunsigned int i;\n\tfor (i = 0; i < bmp->size; i++)\n\t\t_setbit(bmp, i, 1);\n\treturn bmp;\n}\n\n \nstruct bitmask *bitmask_clearall(struct bitmask *bmp)\n{\n\tunsigned int i;\n\tfor (i = 0; i < bmp->size; i++)\n\t\t_setbit(bmp, i, 0);\n\treturn bmp;\n}\n\n \nint bitmask_isallclear(const struct bitmask *bmp)\n{\n\tunsigned int i;\n\tfor (i = 0; i < bmp->size; i++)\n\t\tif (_getbit(bmp, i))\n\t\t\treturn 0;\n\treturn 1;\n}\n\n \nint bitmask_isbitset(const struct bitmask *bmp, unsigned int i)\n{\n\treturn _getbit(bmp, i);\n}\n\n \nunsigned int bitmask_first(const struct bitmask *bmp)\n{\n\treturn bitmask_next(bmp, 0);\n}\n\n \nunsigned int bitmask_last(const struct bitmask *bmp)\n{\n\tunsigned int i;\n\tunsigned int m = bmp->size;\n\tfor (i = 0; i < bmp->size; i++)\n\t\tif (_getbit(bmp, i))\n\t\t\tm = i;\n\treturn m;\n}\n\n \nunsigned int bitmask_next(const struct bitmask *bmp, unsigned int i)\n{\n\tunsigned int n;\n\tfor (n = i; n < bmp->size; n++)\n\t\tif (_getbit(bmp, n))\n\t\t\tbreak;\n\treturn n;\n}\n\n \nint bitmask_parselist(const char *buf, struct bitmask *bmp)\n{\n\tconst char *p, *q;\n\n\tbitmask_clearall(bmp);\n\n\tq = buf;\n\twhile (p = q, q = nexttoken(q, ','), p) {\n\t\tunsigned int a;\t\t \n\t\tunsigned int b;\t\t \n\t\tunsigned int s;\t\t \n\t\tconst char *c1, *c2;\t \n\t\tchar nextc;\t\t \n\t\tint sret;\t\t \n\n\t\tsret = sscanf(p, \"%u%c\", &a, &nextc);\n\t\tif (!scan_was_ok(sret, nextc, \",-\"))\n\t\t\tgoto err;\n\t\tb = a;\n\t\ts = 1;\n\t\tc1 = nexttoken(p, '-');\n\t\tc2 = nexttoken(p, ',');\n\t\tif (c1 != NULL && (c2 == NULL || c1 < c2)) {\n\t\t\tsret = sscanf(c1, \"%u%c\", &b, &nextc);\n\t\t\tif (!scan_was_ok(sret, nextc, \",:\"))\n\t\t\t\tgoto err;\n\t\t\tc1 = nexttoken(c1, ':');\n\t\t\tif (c1 != NULL && (c2 == NULL || c1 < c2)) {\n\t\t\t\tsret = sscanf(c1, \"%u%c\", &s, &nextc);\n\t\t\t\tif (!scan_was_ok(sret, nextc, \",\"))\n\t\t\t\t\tgoto err;\n\t\t\t}\n\t\t}\n\t\tif (!(a <= b))\n\t\t\tgoto err;\n\t\tif (b >= bmp->size)\n\t\t\tgoto err;\n\t\twhile (a <= b) {\n\t\t\t_setbit(bmp, a, 1);\n\t\t\ta += s;\n\t\t}\n\t}\n\treturn 0;\nerr:\n\tbitmask_clearall(bmp);\n\treturn -1;\n}\n\n \n\nstatic inline int emit(char *buf, int buflen, int rbot, int rtop, int len)\n{\n\tif (len > 0)\n\t\tlen += snprintf(buf + len, max(buflen - len, 0), \",\");\n\tif (rbot == rtop)\n\t\tlen += snprintf(buf + len, max(buflen - len, 0), \"%d\", rbot);\n\telse\n\t\tlen += snprintf(buf + len, max(buflen - len, 0), \"%d-%d\",\n\t\t\t\trbot, rtop);\n\treturn len;\n}\n\n \n\nint bitmask_displaylist(char *buf, int buflen, const struct bitmask *bmp)\n{\n\tint len = 0;\n\t \n\tunsigned int cur, rbot, rtop;\n\n\tif (buflen > 0)\n\t\t*buf = 0;\n\trbot = cur = bitmask_first(bmp);\n\twhile (cur < bmp->size) {\n\t\trtop = cur;\n\t\tcur = bitmask_next(bmp, cur+1);\n\t\tif (cur >= bmp->size || cur > rtop + 1) {\n\t\t\tlen = emit(buf, buflen, rbot, rtop, len);\n\t\t\trbot = cur;\n\t\t}\n\t}\n\treturn len;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}