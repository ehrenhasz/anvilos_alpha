{
  "module_name": "cpupower-set.c",
  "hash_id": "5a63b2451f1c0c87660eba86dd21500f7c751125926e2228ea89b5ba70968107",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/utils/cpupower-set.c",
  "human_readable_source": "\n \n\n\n#include <unistd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <string.h>\n#include <getopt.h>\n#include <sys/utsname.h>\n\n#include \"helpers/helpers.h\"\n#include \"helpers/sysfs.h\"\n#include \"helpers/bitmask.h\"\n\nstatic struct option set_opts[] = {\n\t{\"perf-bias\", required_argument, NULL, 'b'},\n\t{\"epp\", required_argument, NULL, 'e'},\n\t{\"amd-pstate-mode\", required_argument, NULL, 'm'},\n\t{\"turbo-boost\", required_argument, NULL, 't'},\n\t{ },\n};\n\nstatic void print_wrong_arg_exit(void)\n{\n\tprintf(_(\"invalid or unknown argument\\n\"));\n\texit(EXIT_FAILURE);\n}\n\nint cmd_set(int argc, char **argv)\n{\n\textern char *optarg;\n\textern int optind, opterr, optopt;\n\tunsigned int cpu;\n\tstruct utsname uts;\n\n\tunion {\n\t\tstruct {\n\t\t\tint perf_bias:1;\n\t\t\tint epp:1;\n\t\t\tint mode:1;\n\t\t\tint turbo_boost:1;\n\t\t};\n\t\tint params;\n\t} params;\n\tint perf_bias = 0, turbo_boost = 1;\n\tint ret = 0;\n\tchar epp[30], mode[20];\n\n\tret = uname(&uts);\n\tif (!ret && (!strcmp(uts.machine, \"ppc64le\") ||\n\t\t     !strcmp(uts.machine, \"ppc64\"))) {\n\t\tfprintf(stderr, _(\"Subcommand not supported on POWER.\\n\"));\n\t\treturn ret;\n\t}\n\n\tsetlocale(LC_ALL, \"\");\n\ttextdomain(PACKAGE);\n\n\tparams.params = 0;\n\t \n\twhile ((ret = getopt_long(argc, argv, \"b:e:m:\",\n\t\t\t\t\t\tset_opts, NULL)) != -1) {\n\t\tswitch (ret) {\n\t\tcase 'b':\n\t\t\tif (params.perf_bias)\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\tperf_bias = atoi(optarg);\n\t\t\tif (perf_bias < 0 || perf_bias > 15) {\n\t\t\t\tprintf(_(\"--perf-bias param out \"\n\t\t\t\t\t \"of range [0-%d]\\n\"), 15);\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\t}\n\t\t\tparams.perf_bias = 1;\n\t\t\tbreak;\n\t\tcase 'e':\n\t\t\tif (params.epp)\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\tif (sscanf(optarg, \"%29s\", epp) != 1) {\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tparams.epp = 1;\n\t\t\tbreak;\n\t\tcase 'm':\n\t\t\tif (cpupower_cpu_info.vendor != X86_VENDOR_AMD)\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\tif (params.mode)\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\tif (sscanf(optarg, \"%19s\", mode) != 1) {\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tparams.mode = 1;\n\t\t\tbreak;\n\t\tcase 't':\n\t\t\tif (params.turbo_boost)\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\tturbo_boost = atoi(optarg);\n\t\t\tif (turbo_boost < 0 || turbo_boost > 1) {\n\t\t\t\tprintf(\"--turbo-boost param out of range [0-1]\\n\");\n\t\t\t\tprint_wrong_arg_exit();\n\t\t\t}\n\t\t\tparams.turbo_boost = 1;\n\t\t\tbreak;\n\n\n\t\tdefault:\n\t\t\tprint_wrong_arg_exit();\n\t\t}\n\t}\n\n\tif (!params.params)\n\t\tprint_wrong_arg_exit();\n\n\tif (params.mode) {\n\t\tret = cpupower_set_amd_pstate_mode(mode);\n\t\tif (ret)\n\t\t\tfprintf(stderr, \"Error setting mode\\n\");\n\t}\n\n\tif (params.turbo_boost) {\n\t\tret = cpupower_set_turbo_boost(turbo_boost);\n\t\tif (ret)\n\t\t\tfprintf(stderr, \"Error setting turbo-boost\\n\");\n\t}\n\n\t \n\tif (bitmask_isallclear(cpus_chosen))\n\t\tbitmask_setall(cpus_chosen);\n\n\t \n\tfor (cpu = bitmask_first(cpus_chosen);\n\t     cpu <= bitmask_last(cpus_chosen); cpu++) {\n\n\t\tif (!bitmask_isbitset(cpus_chosen, cpu))\n\t\t\tcontinue;\n\n\t\tif (sysfs_is_cpu_online(cpu) != 1){\n\t\t\tfprintf(stderr, _(\"Cannot set values on CPU %d:\"), cpu);\n\t\t\tfprintf(stderr, _(\" *is offline\\n\"));\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (params.perf_bias) {\n\t\t\tret = cpupower_intel_set_perf_bias(cpu, perf_bias);\n\t\t\tif (ret) {\n\t\t\t\tfprintf(stderr, _(\"Error setting perf-bias \"\n\t\t\t\t\t\t  \"value on CPU %d\\n\"), cpu);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (params.epp) {\n\t\t\tret = cpupower_set_epp(cpu, epp);\n\t\t\tif (ret) {\n\t\t\t\tfprintf(stderr,\n\t\t\t\t\t\"Error setting epp value on CPU %d\\n\", cpu);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t}\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}