{
  "module_name": "dump_psb.c",
  "hash_id": "fc72e4e39075eead1df9731ba5668e47a6054ef6636b997a3ce3d14fdbf53e8f",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/debug/i386/dump_psb.c",
  "human_readable_source": "\n\n\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\n#define _GNU_SOURCE\n#include <getopt.h>\n\n#include <sys/mman.h>\n\n#define LEN (0x100000 - 0xc0000)\n#define OFFSET (0xc0000)\n\n#ifndef __packed\n#define __packed __attribute((packed))\n#endif\n\nstatic long relevant;\n\nstatic const int fid_to_mult[32] = {\n\t110, 115, 120, 125, 50, 55, 60, 65,\n\t70, 75, 80, 85, 90, 95, 100, 105,\n\t30, 190, 40, 200, 130, 135, 140, 210,\n\t150, 225, 160, 165, 170, 180, -1, -1,\n};\n\nstatic const int vid_to_voltage[32] = {\n\t2000, 1950, 1900, 1850, 1800, 1750, 1700, 1650,\n\t1600, 1550, 1500, 1450, 1400, 1350, 1300, 0,\n\t1275, 1250, 1225, 1200, 1175, 1150, 1125, 1100,\n\t1075, 1050, 1024, 1000, 975, 950, 925, 0,\n};\n\nstruct psb_header {\n\tchar signature[10];\n\tu_char version;\n\tu_char flags;\n\tu_short settlingtime;\n\tu_char res1;\n\tu_char numpst;\n} __packed;\n\nstruct pst_header {\n\tu_int32_t cpuid;\n\tu_char fsb;\n\tu_char maxfid;\n\tu_char startvid;\n\tu_char numpstates;\n} __packed;\n\nstatic u_int fsb;\nstatic u_int sgtc;\n\nstatic int\ndecode_pst(char *p, int npstates)\n{\n\tint i;\n\tint freq, fid, vid;\n\n\tfor (i = 0; i < npstates; ++i) {\n\t\tfid = *p++;\n\t\tvid = *p++;\n\t\tfreq = 100 * fid_to_mult[fid] * fsb;\n\n\t\tprintf(\"   %2d %8dkHz  FID %02x (%2d.%01d)  VID %02x (%4dmV)\\n\",\n\t\t       i,\n\t\t       freq,\n\t\t       fid, fid_to_mult[fid]/10, fid_to_mult[fid]%10,\n\t\t       vid, vid_to_voltage[vid]);\n\t}\n\n\treturn 0;\n}\n\nstatic\nvoid decode_psb(char *p, int numpst)\n{\n\tint i;\n\tstruct psb_header *psb;\n\tstruct pst_header *pst;\n\n\tpsb = (struct psb_header*) p;\n\n\tif (psb->version != 0x12)\n\t\treturn;\n\n\tprintf(\"PSB version: %hhx flags: %hhx settling time %hhuus res1 %hhx num pst %hhu\\n\",\n\t\t\tpsb->version,\n\t\t\tpsb->flags,\n\t\t\tpsb->settlingtime,\n\t\t\tpsb->res1,\n\t\t\tpsb->numpst);\n\tsgtc = psb->settlingtime * 100;\n\n\tif (sgtc < 10000)\n\t\tsgtc = 10000;\n\n\tp = ((char *) psb) + sizeof(struct psb_header);\n\n\tif (numpst < 0)\n\t\tnumpst = psb->numpst;\n\telse\n\t\tprintf(\"Overriding number of pst :%d\\n\", numpst);\n\n\tfor (i = 0; i < numpst; i++) {\n\t\tpst = (struct pst_header*) p;\n\n\t\tif (relevant != 0) {\n\t\t\tif (relevant!= pst->cpuid)\n\t\t\t\tgoto next_one;\n\t\t}\n\n\t\tprintf(\"  PST %d  cpuid %.3x fsb %hhu mfid %hhx svid %hhx numberstates %hhu\\n\",\n\t\t\t\ti+1,\n\t\t\t\tpst->cpuid,\n\t\t\t\tpst->fsb,\n\t\t\t\tpst->maxfid,\n\t\t\t\tpst->startvid,\n\t\t\t\tpst->numpstates);\n\n\t\tfsb = pst->fsb;\n\t\tdecode_pst(p + sizeof(struct pst_header), pst->numpstates);\n\nnext_one:\n\t\tp += sizeof(struct pst_header) + 2*pst->numpstates;\n\t}\n\n}\n\nstatic struct option info_opts[] = {\n     {\"numpst\", no_argument, NULL, 'n'},\n};\n\nvoid print_help(void)\n{\n\tprintf (\"Usage: dump_psb [options]\\n\");\n\tprintf (\"Options:\\n\");\n\tprintf (\"  -n, --numpst     Set number of PST tables to scan\\n\");\n\tprintf (\"  -r, --relevant   Only display PSTs relevant to cpuid N\\n\");\n}\n\nint\nmain(int argc, char *argv[])\n{\n\tint fd;\n\tint numpst=-1;\n\tint ret=0, cont=1;\n\tchar *mem = NULL;\n\tchar *p;\n\n\tdo {\n\t\tret = getopt_long(argc, argv, \"hr:n:\", info_opts, NULL);\n\t\tswitch (ret){\n\t\tcase '?':\n\t\tcase 'h':\n\t\t\tprint_help();\n\t\t\tcont = 0;\n\t\t\tbreak;\n\t\tcase 'r':\n\t\t\trelevant = strtol(optarg, NULL, 16);\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\tnumpst = strtol(optarg, NULL, 10);\n\t\t\tbreak;\n\t\tcase -1:\n\t\t\tcont = 0;\n\t\t\tbreak;\n\t\t}\n\n\t} while(cont);\n\n\tfd = open(\"/dev/mem\", O_RDONLY);\n\tif (fd < 0) {\n\t\tprintf (\"Couldn't open /dev/mem. Are you root?\\n\");\n\t\texit(1);\n\t}\n\n\tmem = mmap(mem, 0x100000 - 0xc0000, PROT_READ, MAP_SHARED, fd, 0xc0000);\n\tclose(fd);\n\n\tfor (p = mem; p - mem < LEN; p+=16) {\n\t\tif (memcmp(p, \"AMDK7PNOW!\", 10) == 0) {\n\t\t\tdecode_psb(p, numpst);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tmunmap(mem, LEN);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}