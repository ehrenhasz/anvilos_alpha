{
  "module_name": "powercap.c",
  "hash_id": "27602fb8d5af72218d15488aabb30100c6a72cd0c793e30d5ed2b8bd5a01a58b",
  "original_prompt": "Ingested from linux-6.6.14/tools/power/cpupower/lib/powercap.c",
  "human_readable_source": "\n \n\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <string.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <dirent.h>\n\n#include \"powercap.h\"\n\nstatic unsigned int sysfs_read_file(const char *path, char *buf, size_t buflen)\n{\n\tint fd;\n\tssize_t numread;\n\n\tfd = open(path, O_RDONLY);\n\tif (fd == -1)\n\t\treturn 0;\n\n\tnumread = read(fd, buf, buflen - 1);\n\tif (numread < 1) {\n\t\tclose(fd);\n\t\treturn 0;\n\t}\n\n\tbuf[numread] = '\\0';\n\tclose(fd);\n\n\treturn (unsigned int) numread;\n}\n\nstatic int sysfs_get_enabled(char *path, int *mode)\n{\n\tint fd;\n\tchar yes_no;\n\tint ret = 0;\n\n\t*mode = 0;\n\n\tfd = open(path, O_RDONLY);\n\tif (fd == -1) {\n\t\tret = -1;\n\t\tgoto out;\n\t}\n\n\tif (read(fd, &yes_no, 1) != 1) {\n\t\tret = -1;\n\t\tgoto out_close;\n\t}\n\n\tif (yes_no == '1') {\n\t\t*mode = 1;\n\t\tgoto out_close;\n\t} else if (yes_no == '0') {\n\t\tgoto out_close;\n\t} else {\n\t\tret = -1;\n\t\tgoto out_close;\n\t}\nout_close:\n\tclose(fd);\nout:\n\treturn ret;\n}\n\nint powercap_get_enabled(int *mode)\n{\n\tchar path[SYSFS_PATH_MAX] = PATH_TO_POWERCAP \"/intel-rapl/enabled\";\n\n\treturn sysfs_get_enabled(path, mode);\n}\n\n \nint powercap_get_driver(char *driver, int buflen)\n{\n\tchar file[SYSFS_PATH_MAX] = PATH_TO_RAPL;\n\n\tstruct stat statbuf;\n\n\tif (stat(file, &statbuf) != 0 || !S_ISDIR(statbuf.st_mode)) {\n\t\tdriver = \"\";\n\t\treturn -1;\n\t} else if (buflen > 10) {\n\t\tstrcpy(driver, \"intel-rapl\");\n\t\treturn 0;\n\t} else\n\t\treturn -1;\n}\n\nenum powercap_get64 {\n\tGET_ENERGY_UJ,\n\tGET_MAX_ENERGY_RANGE_UJ,\n\tGET_POWER_UW,\n\tGET_MAX_POWER_RANGE_UW,\n\tMAX_GET_64_FILES\n};\n\nstatic const char *powercap_get64_files[MAX_GET_64_FILES] = {\n\t[GET_POWER_UW] = \"power_uw\",\n\t[GET_MAX_POWER_RANGE_UW] = \"max_power_range_uw\",\n\t[GET_ENERGY_UJ] = \"energy_uj\",\n\t[GET_MAX_ENERGY_RANGE_UJ] = \"max_energy_range_uj\",\n};\n\nstatic int sysfs_powercap_get64_val(struct powercap_zone *zone,\n\t\t\t\t      enum powercap_get64 which,\n\t\t\t\t      uint64_t *val)\n{\n\tchar file[SYSFS_PATH_MAX] = PATH_TO_POWERCAP \"/\";\n\tint ret;\n\tchar buf[MAX_LINE_LEN];\n\n\tstrcat(file, zone->sys_name);\n\tstrcat(file, \"/\");\n\tstrcat(file, powercap_get64_files[which]);\n\n\tret = sysfs_read_file(file, buf, MAX_LINE_LEN);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret == 0)\n\t\treturn -1;\n\n\t*val = strtoll(buf, NULL, 10);\n\treturn 0;\n}\n\nint powercap_get_max_energy_range_uj(struct powercap_zone *zone, uint64_t *val)\n{\n\treturn sysfs_powercap_get64_val(zone, GET_MAX_ENERGY_RANGE_UJ, val);\n}\n\nint powercap_get_energy_uj(struct powercap_zone *zone, uint64_t *val)\n{\n\treturn sysfs_powercap_get64_val(zone, GET_ENERGY_UJ, val);\n}\n\nint powercap_get_max_power_range_uw(struct powercap_zone *zone, uint64_t *val)\n{\n\treturn sysfs_powercap_get64_val(zone, GET_MAX_POWER_RANGE_UW, val);\n}\n\nint powercap_get_power_uw(struct powercap_zone *zone, uint64_t *val)\n{\n\treturn sysfs_powercap_get64_val(zone, GET_POWER_UW, val);\n}\n\nint powercap_zone_get_enabled(struct powercap_zone *zone, int *mode)\n{\n\tchar path[SYSFS_PATH_MAX] = PATH_TO_POWERCAP;\n\n\tif ((strlen(PATH_TO_POWERCAP) + strlen(zone->sys_name)) +\n\t    strlen(\"/enabled\") + 1 >= SYSFS_PATH_MAX)\n\t\treturn -1;\n\n\tstrcat(path, \"/\");\n\tstrcat(path, zone->sys_name);\n\tstrcat(path, \"/enabled\");\n\n\treturn sysfs_get_enabled(path, mode);\n}\n\nint powercap_zone_set_enabled(struct powercap_zone *zone, int mode)\n{\n\t \n\treturn 0;\n}\n\n\nint powercap_read_zone(struct powercap_zone *zone)\n{\n\tstruct dirent *dent;\n\tDIR *zone_dir;\n\tchar sysfs_dir[SYSFS_PATH_MAX] = PATH_TO_POWERCAP;\n\tstruct powercap_zone *child_zone;\n\tchar file[SYSFS_PATH_MAX] = PATH_TO_POWERCAP;\n\tint i, ret = 0;\n\tuint64_t val = 0;\n\n\tstrcat(sysfs_dir, \"/\");\n\tstrcat(sysfs_dir, zone->sys_name);\n\n\tzone_dir = opendir(sysfs_dir);\n\tif (zone_dir == NULL)\n\t\treturn -1;\n\n\tstrcat(file, \"/\");\n\tstrcat(file, zone->sys_name);\n\tstrcat(file, \"/name\");\n\tsysfs_read_file(file, zone->name, MAX_LINE_LEN);\n\tif (zone->parent)\n\t\tzone->tree_depth = zone->parent->tree_depth + 1;\n\tret = powercap_get_energy_uj(zone, &val);\n\tif (ret == 0)\n\t\tzone->has_energy_uj = 1;\n\tret = powercap_get_power_uw(zone, &val);\n\tif (ret == 0)\n\t\tzone->has_power_uw = 1;\n\n\twhile ((dent = readdir(zone_dir)) != NULL) {\n\t\tstruct stat st;\n\n\t\tif (strcmp(dent->d_name, \".\") == 0 || strcmp(dent->d_name, \"..\") == 0)\n\t\t\tcontinue;\n\n\t\tif (stat(dent->d_name, &st) != 0 || !S_ISDIR(st.st_mode))\n\t\t\tif (fstatat(dirfd(zone_dir), dent->d_name, &st, 0) < 0)\n\t\t\t\tcontinue;\n\n\t\tif (strncmp(dent->d_name, \"intel-rapl:\", 11) != 0)\n\t\t\tcontinue;\n\n\t\tchild_zone = calloc(1, sizeof(struct powercap_zone));\n\t\tif (child_zone == NULL)\n\t\t\treturn -1;\n\t\tfor (i = 0; i < POWERCAP_MAX_CHILD_ZONES; i++) {\n\t\t\tif (zone->children[i] == NULL) {\n\t\t\t\tzone->children[i] = child_zone;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (i == POWERCAP_MAX_CHILD_ZONES - 1) {\n\t\t\t\tfree(child_zone);\n\t\t\t\tfprintf(stderr, \"Reached POWERCAP_MAX_CHILD_ZONES %d\\n\",\n\t\t\t\t       POWERCAP_MAX_CHILD_ZONES);\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t}\n\t\tstrcpy(child_zone->sys_name, zone->sys_name);\n\t\tstrcat(child_zone->sys_name, \"/\");\n\t\tstrcat(child_zone->sys_name, dent->d_name);\n\t\tchild_zone->parent = zone;\n\t\tif (zone->tree_depth >= POWERCAP_MAX_TREE_DEPTH) {\n\t\t\tfprintf(stderr, \"Maximum zone hierarchy depth[%d] reached\\n\",\n\t\t\t\tPOWERCAP_MAX_TREE_DEPTH);\n\t\t\tret = -1;\n\t\t\tbreak;\n\t\t}\n\t\tpowercap_read_zone(child_zone);\n\t}\n\tclosedir(zone_dir);\n\treturn ret;\n}\n\nstruct powercap_zone *powercap_init_zones(void)\n{\n\tint enabled;\n\tstruct powercap_zone *root_zone;\n\tint ret;\n\tchar file[SYSFS_PATH_MAX] = PATH_TO_RAPL \"/enabled\";\n\n\tret = sysfs_get_enabled(file, &enabled);\n\n\tif (ret)\n\t\treturn NULL;\n\n\tif (!enabled)\n\t\treturn NULL;\n\n\troot_zone = calloc(1, sizeof(struct powercap_zone));\n\tif (!root_zone)\n\t\treturn NULL;\n\n\tstrcpy(root_zone->sys_name, \"intel-rapl/intel-rapl:0\");\n\n\tpowercap_read_zone(root_zone);\n\n\treturn root_zone;\n}\n\n \n\nint powercap_walk_zones(struct powercap_zone *zone,\n\t\t\tint (*f)(struct powercap_zone *zone))\n{\n\tint i, ret;\n\n\tif (!zone)\n\t\treturn -1;\n\n\tret = f(zone);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < POWERCAP_MAX_CHILD_ZONES; i++) {\n\t\tif (zone->children[i] != NULL)\n\t\t\tpowercap_walk_zones(zone->children[i], f);\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}