{
  "module_name": "slabinfo-gnuplot.sh",
  "hash_id": "276098c6e6381d25071b62001cf1486a80e394105d16371507fd4ae8970f8485",
  "original_prompt": "Ingested from linux-6.6.14/tools/mm/slabinfo-gnuplot.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0-only\n\n# Sergey Senozhatsky, 2015\n# sergey.senozhatsky.work@gmail.com\n#\n\n\n# This program is intended to plot a `slabinfo -X' stats, collected,\n# for example, using the following command:\n#   while [ 1 ]; do slabinfo -X >> stats; sleep 1; done\n#\n# Use `slabinfo-gnuplot.sh stats' to pre-process collected records\n# and generate graphs (totals, slabs sorted by size, slabs sorted\n# by size).\n#\n# Graphs can be [individually] regenerate with different ranges and\n# size (-r %d,%d and -s %d,%d options).\n#\n# To visually compare N `totals' graphs, do\n# slabinfo-gnuplot.sh -t FILE1-totals FILE2-totals ... FILEN-totals\n#\n\nmin_slab_name_size=11\nxmin=0\nxmax=0\nwidth=1500\nheight=700\nmode=preprocess\n\nusage()\n{\n\techo \"Usage: [-s W,H] [-r MIN,MAX] [-t|-l] FILE1 [FILE2 ..]\"\n\techo \"FILEs must contain 'slabinfo -X' samples\"\n\techo \"-t \t\t\t- plot totals for FILE(s)\"\n\techo \"-l \t\t\t- plot slabs stats for FILE(s)\"\n\techo \"-s %d,%d\t\t- set image width and height\"\n\techo \"-r %d,%d\t\t- use data samples from a given range\"\n}\n\ncheck_file_exist()\n{\n\tif [ ! -f \"$1\" ]; then\n\t\techo \"File '$1' does not exist\"\n\t\texit 1\n\tfi\n}\n\ndo_slabs_plotting()\n{\n\tlocal file=$1\n\tlocal out_file\n\tlocal range=\"every ::$xmin\"\n\tlocal xtic=\"\"\n\tlocal xtic_rotate=\"norotate\"\n\tlocal lines=2000000\n\tlocal wc_lines\n\n\tcheck_file_exist \"$file\"\n\n\tout_file=`basename \"$file\"`\n\tif [ $xmax -ne 0 ]; then\n\t\trange=\"$range::$xmax\"\n\t\tlines=$((xmax-xmin))\n\tfi\n\n\twc_lines=`cat \"$file\" | wc -l`\n\tif [ $? -ne 0 ] || [ \"$wc_lines\" -eq 0 ] ; then\n\t\twc_lines=$lines\n\tfi\n\n\tif [ \"$wc_lines\" -lt \"$lines\" ]; then\n\t\tlines=$wc_lines\n\tfi\n\n\tif [ $((width / lines)) -gt $min_slab_name_size ]; then\n\t\txtic=\":xtic(1)\"\n\t\txtic_rotate=90\n\tfi\n\ngnuplot -p << EOF\n#!/usr/bin/env gnuplot\n\nset terminal png enhanced size $width,$height large\nset output '$out_file.png'\nset autoscale xy\nset xlabel 'samples'\nset ylabel 'bytes'\nset style histogram columnstacked title textcolor lt -1\nset style fill solid 0.15\nset xtics rotate $xtic_rotate\nset key left above Left title reverse\n\nplot \"$file\" $range u 2$xtic title 'SIZE' with boxes,\\\n\t'' $range u 3 title 'LOSS' with boxes\nEOF\n\n\tif [ $? -eq 0 ]; then\n\t\techo \"$out_file.png\"\n\tfi\n}\n\ndo_totals_plotting()\n{\n\tlocal gnuplot_cmd=\"\"\n\tlocal range=\"every ::$xmin\"\n\tlocal file=\"\"\n\n\tif [ $xmax -ne 0 ]; then\n\t\trange=\"$range::$xmax\"\n\tfi\n\n\tfor i in \"${t_files[@]}\"; do\n\t\tcheck_file_exist \"$i\"\n\n\t\tfile=\"$file\"`basename \"$i\"`\n\t\tgnuplot_cmd=\"$gnuplot_cmd '$i' $range using 1 title\\\n\t\t\t'$i Memory usage' with lines,\"\n\t\tgnuplot_cmd=\"$gnuplot_cmd '' $range using 2 title \\\n\t\t\t'$i Loss' with lines,\"\n\tdone\n\ngnuplot -p << EOF\n#!/usr/bin/env gnuplot\n\nset terminal png enhanced size $width,$height large\nset autoscale xy\nset output '$file.png'\nset xlabel 'samples'\nset ylabel 'bytes'\nset key left above Left title reverse\n\nplot $gnuplot_cmd\nEOF\n\n\tif [ $? -eq 0 ]; then\n\t\techo \"$file.png\"\n\tfi\n}\n\ndo_preprocess()\n{\n\tlocal out\n\tlocal lines\n\tlocal in=$1\n\n\tcheck_file_exist \"$in\"\n\n\t# use only 'TOP' slab (biggest memory usage or loss)\n\tlet lines=3\n\tout=`basename \"$in\"`\"-slabs-by-loss\"\n\t`cat \"$in\" | grep -A \"$lines\" 'Slabs sorted by loss' |\\\n\t\tgrep -E -iv '\\-\\-|Name|Slabs'\\\n\t\t| awk '{print $1\" \"$4+$2*$3\" \"$4}' > \"$out\"`\n\tif [ $? -eq 0 ]; then\n\t\tdo_slabs_plotting \"$out\"\n\tfi\n\n\tlet lines=3\n\tout=`basename \"$in\"`\"-slabs-by-size\"\n\t`cat \"$in\" | grep -A \"$lines\" 'Slabs sorted by size' |\\\n\t\tgrep -E -iv '\\-\\-|Name|Slabs'\\\n\t\t| awk '{print $1\" \"$4\" \"$4-$2*$3}' > \"$out\"`\n\tif [ $? -eq 0 ]; then\n\t\tdo_slabs_plotting \"$out\"\n\tfi\n\n\tout=`basename \"$in\"`\"-totals\"\n\t`cat \"$in\" | grep \"Memory used\" |\\\n\t\tawk '{print $3\" \"$7}' > \"$out\"`\n\tif [ $? -eq 0 ]; then\n\t\tt_files[0]=$out\n\t\tdo_totals_plotting\n\tfi\n}\n\nparse_opts()\n{\n\tlocal opt\n\n\twhile getopts \"tlr::s::h\" opt; do\n\t\tcase $opt in\n\t\t\tt)\n\t\t\t\tmode=totals\n\t\t\t\t;;\n\t\t\tl)\n\t\t\t\tmode=slabs\n\t\t\t\t;;\n\t\t\ts)\n\t\t\t\tarray=(${OPTARG//,/ })\n\t\t\t\twidth=${array[0]}\n\t\t\t\theight=${array[1]}\n\t\t\t\t;;\n\t\t\tr)\n\t\t\t\tarray=(${OPTARG//,/ })\n\t\t\t\txmin=${array[0]}\n\t\t\t\txmax=${array[1]}\n\t\t\t\t;;\n\t\t\th)\n\t\t\t\tusage\n\t\t\t\texit 0\n\t\t\t\t;;\n\t\t\t\\?)\n\t\t\t\techo \"Invalid option: -$OPTARG\" >&2\n\t\t\t\texit 1\n\t\t\t\t;;\n\t\t\t:)\n\t\t\t\techo \"-$OPTARG requires an argument.\" >&2\n\t\t\t\texit 1\n\t\t\t\t;;\n\t\tesac\n\tdone\n\n\treturn $OPTIND\n}\n\nparse_args()\n{\n\tlocal idx=0\n\tlocal p\n\n\tfor p in \"$@\"; do\n\t\tcase $mode in\n\t\t\tpreprocess)\n\t\t\t\tfiles[$idx]=$p\n\t\t\t\tidx=$idx+1\n\t\t\t\t;;\n\t\t\ttotals)\n\t\t\t\tt_files[$idx]=$p\n\t\t\t\tidx=$idx+1\n\t\t\t\t;;\n\t\t\tslabs)\n\t\t\t\tfiles[$idx]=$p\n\t\t\t\tidx=$idx+1\n\t\t\t\t;;\n\t\tesac\n\tdone\n}\n\nparse_opts \"$@\"\nargstart=$?\nparse_args \"${@:$argstart}\"\n\nif [ ${#files[@]} -eq 0 ] && [ ${#t_files[@]} -eq 0 ]; then\n\tusage\n\texit 1\nfi\n\ncase $mode in\n\tpreprocess)\n\t\tfor i in \"${files[@]}\"; do\n\t\t\tdo_preprocess \"$i\"\n\t\tdone\n\t\t;;\n\ttotals)\n\t\tdo_totals_plotting\n\t\t;;\n\tslabs)\n\t\tfor i in \"${files[@]}\"; do\n\t\t\tdo_slabs_plotting \"$i\"\n\t\tdone\n\t\t;;\n\t*)\n\t\techo \"Unknown mode $mode\" >&2\n\t\tusage\n\t\texit 1\n\t;;\nesac\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}