{
  "module_name": "gecko.py",
  "hash_id": "9be8c41f6c11cd687600276d5659ad341e955f698f6283e0b0376723304b83c1",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/scripts/python/gecko.py",
  "human_readable_source": "# gecko.py - Convert perf record output to Firefox's gecko profile format\n# SPDX-License-Identifier: GPL-2.0\n#\n# The script converts perf.data to Gecko Profile Format,\n# which can be read by https://profiler.firefox.com/.\n#\n# Usage:\n#\n#     perf record -a -g -F 99 sleep 60\n#     perf script report gecko\n#\n# Combined:\n#\n#     perf script gecko -F 99 -a sleep 60\n\nimport os\nimport sys\nimport time\nimport json\nimport string\nimport random\nimport argparse\nimport threading\nimport webbrowser\nimport urllib.parse\nfrom os import system\nfrom functools import reduce\nfrom dataclasses import dataclass, field\nfrom http.server import HTTPServer, SimpleHTTPRequestHandler, test\nfrom typing import List, Dict, Optional, NamedTuple, Set, Tuple, Any\n\n# Add the Perf-Trace-Util library to the Python path\nsys.path.append(os.environ['PERF_EXEC_PATH'] + \\\n\t'/scripts/python/Perf-Trace-Util/lib/Perf/Trace')\n\nfrom perf_trace_context import *\nfrom Core import *\n\nStringID = int\nStackID = int\nFrameID = int\nCategoryID = int\nMilliseconds = float\n\n# start_time is intialiazed only once for the all event traces.\nstart_time = None\n\n# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/profile.js#L425\n# Follow Brendan Gregg's Flamegraph convention: orange for kernel and yellow for user space by default.\nCATEGORIES = None\n\n# The product name is used by the profiler UI to show the Operating system and Processor.\nPRODUCT = os.popen('uname -op').read().strip()\n\n# store the output file\noutput_file = None\n\n# Here key = tid, value = Thread\ntid_to_thread = dict()\n\n# The HTTP server is used to serve the profile to the profiler UI.\nhttp_server_thread = None\n\n# The category index is used by the profiler UI to show the color of the flame graph.\nUSER_CATEGORY_INDEX = 0\nKERNEL_CATEGORY_INDEX = 1\n\n# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L156\nclass Frame(NamedTuple):\n\tstring_id: StringID\n\trelevantForJS: bool\n\tinnerWindowID: int\n\timplementation: None\n\toptimizations: None\n\tline: None\n\tcolumn: None\n\tcategory: CategoryID\n\tsubcategory: int\n\n# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L216\nclass Stack(NamedTuple):\n\tprefix_id: Optional[StackID]\n\tframe_id: FrameID\n\n# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L90\nclass Sample(NamedTuple):\n\tstack_id: Optional[StackID]\n\ttime_ms: Milliseconds\n\tresponsiveness: int\n\n@dataclass\nclass Thread:\n\t\"\"\"A builder for a profile of the thread.\n\n\tAttributes:\n\t\tcomm: Thread command-line (name).\n\t\tpid: process ID of containing process.\n\t\ttid: thread ID.\n\t\tsamples: Timeline of profile samples.\n\t\tframeTable: interned stack frame ID -> stack frame.\n\t\tstringTable: interned string ID -> string.\n\t\tstringMap: interned string -> string ID.\n\t\tstackTable: interned stack ID -> stack.\n\t\tstackMap: (stack prefix ID, leaf stack frame ID) -> interned Stack ID.\n\t\tframeMap: Stack Frame string -> interned Frame ID.\n\t\tcomm: str\n\t\tpid: int\n\t\ttid: int\n\t\tsamples: List[Sample] = field(default_factory=list)\n\t\tframeTable: List[Frame] = field(default_factory=list)\n\t\tstringTable: List[str] = field(default_factory=list)\n\t\tstringMap: Dict[str, int] = field(default_factory=dict)\n\t\tstackTable: List[Stack] = field(default_factory=list)\n\t\tstackMap: Dict[Tuple[Optional[int], int], int] = field(default_factory=dict)\n\t\tframeMap: Dict[str, int] = field(default_factory=dict)\n\t\"\"\"\n\tcomm: str\n\tpid: int\n\ttid: int\n\tsamples: List[Sample] = field(default_factory=list)\n\tframeTable: List[Frame] = field(default_factory=list)\n\tstringTable: List[str] = field(default_factory=list)\n\tstringMap: Dict[str, int] = field(default_factory=dict)\n\tstackTable: List[Stack] = field(default_factory=list)\n\tstackMap: Dict[Tuple[Optional[int], int], int] = field(default_factory=dict)\n\tframeMap: Dict[str, int] = field(default_factory=dict)\n\n\tdef _intern_stack(self, frame_id: int, prefix_id: Optional[int]) -> int:\n\t\t\"\"\"Gets a matching stack, or saves the new stack. Returns a Stack ID.\"\"\"\n\t\tkey = f\"{frame_id}\" if prefix_id is None else f\"{frame_id},{prefix_id}\"\n\t\t# key = (prefix_id, frame_id)\n\t\tstack_id = self.stackMap.get(key)\n\t\tif stack_id is None:\n\t\t\t# return stack_id\n\t\t\tstack_id = len(self.stackTable)\n\t\t\tself.stackTable.append(Stack(prefix_id=prefix_id, frame_id=frame_id))\n\t\t\tself.stackMap[key] = stack_id\n\t\treturn stack_id\n\n\tdef _intern_string(self, string: str) -> int:\n\t\t\"\"\"Gets a matching string, or saves the new string. Returns a String ID.\"\"\"\n\t\tstring_id = self.stringMap.get(string)\n\t\tif string_id is not None:\n\t\t\treturn string_id\n\t\tstring_id = len(self.stringTable)\n\t\tself.stringTable.append(string)\n\t\tself.stringMap[string] = string_id\n\t\treturn string_id\n\n\tdef _intern_frame(self, frame_str: str) -> int:\n\t\t\"\"\"Gets a matching stack frame, or saves the new frame. Returns a Frame ID.\"\"\"\n\t\tframe_id = self.frameMap.get(frame_str)\n\t\tif frame_id is not None:\n\t\t\treturn frame_id\n\t\tframe_id = len(self.frameTable)\n\t\tself.frameMap[frame_str] = frame_id\n\t\tstring_id = self._intern_string(frame_str)\n\n\t\tsymbol_name_to_category = KERNEL_CATEGORY_INDEX if frame_str.find('kallsyms') != -1 \\\n\t\tor frame_str.find('/vmlinux') != -1 \\\n\t\tor frame_str.endswith('.ko)') \\\n\t\telse USER_CATEGORY_INDEX\n\n\t\tself.frameTable.append(Frame(\n\t\t\tstring_id=string_id,\n\t\t\trelevantForJS=False,\n\t\t\tinnerWindowID=0,\n\t\t\timplementation=None,\n\t\t\toptimizations=None,\n\t\t\tline=None,\n\t\t\tcolumn=None,\n\t\t\tcategory=symbol_name_to_category,\n\t\t\tsubcategory=None,\n\t\t))\n\t\treturn frame_id\n\n\tdef _add_sample(self, comm: str, stack: List[str], time_ms: Milliseconds) -> None:\n\t\t\"\"\"Add a timestamped stack trace sample to the thread builder.\n\t\tArgs:\n\t\t\tcomm: command-line (name) of the thread at this sample\n\t\t\tstack: sampled stack frames. Root first, leaf last.\n\t\t\ttime_ms: timestamp of sample in milliseconds.\n\t\t\"\"\"\n\t\t# Ihreads may not set their names right after they are created.\n\t\t# Instead, they might do it later. In such situations, to use the latest name they have set.\n\t\tif self.comm != comm:\n\t\t\tself.comm = comm\n\n\t\tprefix_stack_id = reduce(lambda prefix_id, frame: self._intern_stack\n\t\t\t\t\t\t(self._intern_frame(frame), prefix_id), stack, None)\n\t\tif prefix_stack_id is not None:\n\t\t\tself.samples.append(Sample(stack_id=prefix_stack_id,\n\t\t\t\t\t\t\t\t\ttime_ms=time_ms,\n\t\t\t\t\t\t\t\t\tresponsiveness=0))\n\n\tdef _to_json_dict(self) -> Dict:\n\t\t\"\"\"Converts current Thread to GeckoThread JSON format.\"\"\"\n\t\t# Gecko profile format is row-oriented data as List[List],\n\t\t# And a schema for interpreting each index.\n\t\t# Schema:\n\t\t# https://github.com/firefox-devtools/profiler/blob/main/docs-developer/gecko-profile-format.md\n\t\t# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L230\n\t\treturn {\n\t\t\t\"tid\": self.tid,\n\t\t\t\"pid\": self.pid,\n\t\t\t\"name\": self.comm,\n\t\t\t# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L51\n\t\t\t\"markers\": {\n\t\t\t\t\"schema\": {\n\t\t\t\t\t\"name\": 0,\n\t\t\t\t\t\"startTime\": 1,\n\t\t\t\t\t\"endTime\": 2,\n\t\t\t\t\t\"phase\": 3,\n\t\t\t\t\t\"category\": 4,\n\t\t\t\t\t\"data\": 5,\n\t\t\t\t},\n\t\t\t\t\"data\": [],\n\t\t\t},\n\n\t\t\t# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L90\n\t\t\t\"samples\": {\n\t\t\t\t\"schema\": {\n\t\t\t\t\t\"stack\": 0,\n\t\t\t\t\t\"time\": 1,\n\t\t\t\t\t\"responsiveness\": 2,\n\t\t\t\t},\n\t\t\t\t\"data\": self.samples\n\t\t\t},\n\n\t\t\t# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L156\n\t\t\t\"frameTable\": {\n\t\t\t\t\"schema\": {\n\t\t\t\t\t\"location\": 0,\n\t\t\t\t\t\"relevantForJS\": 1,\n\t\t\t\t\t\"innerWindowID\": 2,\n\t\t\t\t\t\"implementation\": 3,\n\t\t\t\t\t\"optimizations\": 4,\n\t\t\t\t\t\"line\": 5,\n\t\t\t\t\t\"column\": 6,\n\t\t\t\t\t\"category\": 7,\n\t\t\t\t\t\"subcategory\": 8,\n\t\t\t\t},\n\t\t\t\t\"data\": self.frameTable,\n\t\t\t},\n\n\t\t\t# https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L216\n\t\t\t\"stackTable\": {\n\t\t\t\t\"schema\": {\n\t\t\t\t\t\"prefix\": 0,\n\t\t\t\t\t\"frame\": 1,\n\t\t\t\t},\n\t\t\t\t\"data\": self.stackTable,\n\t\t\t},\n\t\t\t\"stringTable\": self.stringTable,\n\t\t\t\"registerTime\": 0,\n\t\t\t\"unregisterTime\": None,\n\t\t\t\"processType\": \"default\",\n\t\t}\n\n# Uses perf script python interface to parse each\n# event and store the data in the thread builder.\ndef process_event(param_dict: Dict) -> None:\n\tglobal start_time\n\tglobal tid_to_thread\n\ttime_stamp = (param_dict['sample']['time'] // 1000) / 1000\n\tpid = param_dict['sample']['pid']\n\ttid = param_dict['sample']['tid']\n\tcomm = param_dict['comm']\n\n\t# Start time is the time of the first sample\n\tif not start_time:\n\t\tstart_time = time_stamp\n\n\t# Parse and append the callchain of the current sample into a stack.\n\tstack = []\n\tif param_dict['callchain']:\n\t\tfor call in param_dict['callchain']:\n\t\t\tif 'sym' not in call:\n\t\t\t\tcontinue\n\t\t\tstack.append(f'{call[\"sym\"][\"name\"]} (in {call[\"dso\"]})')\n\t\tif len(stack) != 0:\n\t\t\t# Reverse the stack, as root come first and the leaf at the end.\n\t\t\tstack = stack[::-1]\n\n\t# During perf record if -g is not used, the callchain is not available.\n\t# In that case, the symbol and dso are available in the event parameters.\n\telse:\n\t\tfunc = param_dict['symbol'] if 'symbol' in param_dict else '[unknown]'\n\t\tdso = param_dict['dso'] if 'dso' in param_dict else '[unknown]'\n\t\tstack.append(f'{func} (in {dso})')\n\n\t# Add sample to the specific thread.\n\tthread = tid_to_thread.get(tid)\n\tif thread is None:\n\t\tthread = Thread(comm=comm, pid=pid, tid=tid)\n\t\ttid_to_thread[tid] = thread\n\tthread._add_sample(comm=comm, stack=stack, time_ms=time_stamp)\n\ndef trace_begin() -> None:\n\tglobal output_file\n\tif (output_file is None):\n\t\tprint(\"Staring Firefox Profiler on your default browser...\")\n\t\tglobal http_server_thread\n\t\thttp_server_thread = threading.Thread(target=test, args=(CORSRequestHandler, HTTPServer,))\n\t\thttp_server_thread.daemon = True\n\t\thttp_server_thread.start()\n\n# Trace_end runs at the end and will be used to aggregate\n# the data into the final json object and print it out to stdout.\ndef trace_end() -> None:\n\tglobal output_file\n\tthreads = [thread._to_json_dict() for thread in tid_to_thread.values()]\n\n\t# Schema: https://github.com/firefox-devtools/profiler/blob/53970305b51b9b472e26d7457fee1d66cd4e2737/src/types/gecko-profile.js#L305\n\tgecko_profile_with_meta = {\n\t\t\"meta\": {\n\t\t\t\"interval\": 1,\n\t\t\t\"processType\": 0,\n\t\t\t\"product\": PRODUCT,\n\t\t\t\"stackwalk\": 1,\n\t\t\t\"debug\": 0,\n\t\t\t\"gcpoison\": 0,\n\t\t\t\"asyncstack\": 1,\n\t\t\t\"startTime\": start_time,\n\t\t\t\"shutdownTime\": None,\n\t\t\t\"version\": 24,\n\t\t\t\"presymbolicated\": True,\n\t\t\t\"categories\": CATEGORIES,\n\t\t\t\"markerSchema\": [],\n\t\t\t},\n\t\t\"libs\": [],\n\t\t\"threads\": threads,\n\t\t\"processes\": [],\n\t\t\"pausedRanges\": [],\n\t}\n\t# launch the profiler on local host if not specified --save-only args, otherwise print to file\n\tif (output_file is None):\n\t\toutput_file = 'gecko_profile.json'\n\t\twith open(output_file, 'w') as f:\n\t\t\tjson.dump(gecko_profile_with_meta, f, indent=2)\n\t\tlaunchFirefox(output_file)\n\t\ttime.sleep(1)\n\t\tprint(f'[ perf gecko: Captured and wrote into {output_file} ]')\n\telse:\n\t\tprint(f'[ perf gecko: Captured and wrote into {output_file} ]')\n\t\twith open(output_file, 'w') as f:\n\t\t\tjson.dump(gecko_profile_with_meta, f, indent=2)\n\n# Used to enable Cross-Origin Resource Sharing (CORS) for requests coming from 'https://profiler.firefox.com', allowing it to access resources from this server.\nclass CORSRequestHandler(SimpleHTTPRequestHandler):\n\tdef end_headers (self):\n\t\tself.send_header('Access-Control-Allow-Origin', 'https://profiler.firefox.com')\n\t\tSimpleHTTPRequestHandler.end_headers(self)\n\n# start a local server to serve the gecko_profile.json file to the profiler.firefox.com\ndef launchFirefox(file):\n\tsafe_string = urllib.parse.quote_plus(f'http://localhost:8000/{file}')\n\turl = 'https://profiler.firefox.com/from-url/' + safe_string\n\twebbrowser.open(f'{url}')\n\ndef main() -> None:\n\tglobal output_file\n\tglobal CATEGORIES\n\tparser = argparse.ArgumentParser(description=\"Convert perf.data to Firefox\\'s Gecko Profile format which can be uploaded to profiler.firefox.com for visualization\")\n\n\t# Add the command-line options\n\t# Colors must be defined according to this:\n\t# https://github.com/firefox-devtools/profiler/blob/50124adbfa488adba6e2674a8f2618cf34b59cd2/res/css/categories.css\n\tparser.add_argument('--user-color', default='yellow', help='Color for the User category', choices=['yellow', 'blue', 'purple', 'green', 'orange', 'red', 'grey', 'magenta'])\n\tparser.add_argument('--kernel-color', default='orange', help='Color for the Kernel category', choices=['yellow', 'blue', 'purple', 'green', 'orange', 'red', 'grey', 'magenta'])\n\t# If --save-only is specified, the output will be saved to a file instead of opening Firefox's profiler directly.\n\tparser.add_argument('--save-only', help='Save the output to a file instead of opening Firefox\\'s profiler')\n\n\t# Parse the command-line arguments\n\targs = parser.parse_args()\n\t# Access the values provided by the user\n\tuser_color = args.user_color\n\tkernel_color = args.kernel_color\n\toutput_file = args.save_only\n\n\tCATEGORIES = [\n\t\t{\n\t\t\t\"name\": 'User',\n\t\t\t\"color\": user_color,\n\t\t\t\"subcategories\": ['Other']\n\t\t},\n\t\t{\n\t\t\t\"name\": 'Kernel',\n\t\t\t\"color\": kernel_color,\n\t\t\t\"subcategories\": ['Other']\n\t\t},\n\t]\n\nif __name__ == '__main__':\n\tmain()\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}