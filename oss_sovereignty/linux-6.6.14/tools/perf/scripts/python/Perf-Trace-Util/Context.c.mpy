{
  "module_name": "Context.c",
  "hash_id": "9b038ea113fae626e427d00d246d8332f8491790eac488002052479147207376",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/scripts/python/Perf-Trace-Util/Context.c",
  "human_readable_source": "\n \n\n \n#define PY_SSIZE_T_CLEAN\n\n#include <Python.h>\n#include \"../../../util/trace-event.h\"\n#include \"../../../util/event.h\"\n#include \"../../../util/symbol.h\"\n#include \"../../../util/thread.h\"\n#include \"../../../util/map.h\"\n#include \"../../../util/maps.h\"\n#include \"../../../util/auxtrace.h\"\n#include \"../../../util/session.h\"\n#include \"../../../util/srcline.h\"\n#include \"../../../util/srccode.h\"\n\n#if PY_MAJOR_VERSION < 3\n#define _PyCapsule_GetPointer(arg1, arg2) \\\n  PyCObject_AsVoidPtr(arg1)\n#define _PyBytes_FromStringAndSize(arg1, arg2) \\\n  PyString_FromStringAndSize((arg1), (arg2))\n#define _PyUnicode_AsUTF8(arg) \\\n  PyString_AsString(arg)\n\nPyMODINIT_FUNC initperf_trace_context(void);\n#else\n#define _PyCapsule_GetPointer(arg1, arg2) \\\n  PyCapsule_GetPointer((arg1), (arg2))\n#define _PyBytes_FromStringAndSize(arg1, arg2) \\\n  PyBytes_FromStringAndSize((arg1), (arg2))\n#define _PyUnicode_AsUTF8(arg) \\\n  PyUnicode_AsUTF8(arg)\n\nPyMODINIT_FUNC PyInit_perf_trace_context(void);\n#endif\n\nstatic struct scripting_context *get_args(PyObject *args, const char *name, PyObject **arg2)\n{\n\tint cnt = 1 + !!arg2;\n\tPyObject *context;\n\n\tif (!PyArg_UnpackTuple(args, name, 1, cnt, &context, arg2))\n\t\treturn NULL;\n\n\treturn _PyCapsule_GetPointer(context, NULL);\n}\n\nstatic struct scripting_context *get_scripting_context(PyObject *args)\n{\n\treturn get_args(args, \"context\", NULL);\n}\n\n#ifdef HAVE_LIBTRACEEVENT\nstatic PyObject *perf_trace_context_common_pc(PyObject *obj, PyObject *args)\n{\n\tstruct scripting_context *c = get_scripting_context(args);\n\n\tif (!c)\n\t\treturn NULL;\n\n\treturn Py_BuildValue(\"i\", common_pc(c));\n}\n\nstatic PyObject *perf_trace_context_common_flags(PyObject *obj,\n\t\t\t\t\t\t PyObject *args)\n{\n\tstruct scripting_context *c = get_scripting_context(args);\n\n\tif (!c)\n\t\treturn NULL;\n\n\treturn Py_BuildValue(\"i\", common_flags(c));\n}\n\nstatic PyObject *perf_trace_context_common_lock_depth(PyObject *obj,\n\t\t\t\t\t\t      PyObject *args)\n{\n\tstruct scripting_context *c = get_scripting_context(args);\n\n\tif (!c)\n\t\treturn NULL;\n\n\treturn Py_BuildValue(\"i\", common_lock_depth(c));\n}\n#endif\n\nstatic PyObject *perf_sample_insn(PyObject *obj, PyObject *args)\n{\n\tstruct scripting_context *c = get_scripting_context(args);\n\n\tif (!c)\n\t\treturn NULL;\n\n\tif (c->sample->ip && !c->sample->insn_len && thread__maps(c->al->thread)) {\n\t\tstruct machine *machine =  maps__machine(thread__maps(c->al->thread));\n\n\t\tscript_fetch_insn(c->sample, c->al->thread, machine);\n\t}\n\tif (!c->sample->insn_len)\n\t\tPy_RETURN_NONE;  \n\n\treturn _PyBytes_FromStringAndSize(c->sample->insn, c->sample->insn_len);\n}\n\nstatic PyObject *perf_set_itrace_options(PyObject *obj, PyObject *args)\n{\n\tstruct scripting_context *c;\n\tconst char *itrace_options;\n\tint retval = -1;\n\tPyObject *str;\n\n\tc = get_args(args, \"itrace_options\", &str);\n\tif (!c)\n\t\treturn NULL;\n\n\tif (!c->session || !c->session->itrace_synth_opts)\n\t\tgoto out;\n\n\tif (c->session->itrace_synth_opts->set) {\n\t\tretval = 1;\n\t\tgoto out;\n\t}\n\n\titrace_options = _PyUnicode_AsUTF8(str);\n\n\tretval = itrace_do_parse_synth_opts(c->session->itrace_synth_opts, itrace_options, 0);\nout:\n\treturn Py_BuildValue(\"i\", retval);\n}\n\nstatic PyObject *perf_sample_src(PyObject *obj, PyObject *args, bool get_srccode)\n{\n\tstruct scripting_context *c = get_scripting_context(args);\n\tunsigned int line = 0;\n\tchar *srcfile = NULL;\n\tchar *srccode = NULL;\n\tPyObject *result;\n\tstruct map *map;\n\tstruct dso *dso;\n\tint len = 0;\n\tu64 addr;\n\n\tif (!c)\n\t\treturn NULL;\n\n\tmap = c->al->map;\n\taddr = c->al->addr;\n\tdso = map ? map__dso(map) : NULL;\n\n\tif (dso)\n\t\tsrcfile = get_srcline_split(dso, map__rip_2objdump(map, addr), &line);\n\n\tif (get_srccode) {\n\t\tif (srcfile)\n\t\t\tsrccode = find_sourceline(srcfile, line, &len);\n\t\tresult = Py_BuildValue(\"(sIs#)\", srcfile, line, srccode, (Py_ssize_t)len);\n\t} else {\n\t\tresult = Py_BuildValue(\"(sI)\", srcfile, line);\n\t}\n\n\tfree(srcfile);\n\n\treturn result;\n}\n\nstatic PyObject *perf_sample_srcline(PyObject *obj, PyObject *args)\n{\n\treturn perf_sample_src(obj, args, false);\n}\n\nstatic PyObject *perf_sample_srccode(PyObject *obj, PyObject *args)\n{\n\treturn perf_sample_src(obj, args, true);\n}\n\nstatic PyMethodDef ContextMethods[] = {\n#ifdef HAVE_LIBTRACEEVENT\n\t{ \"common_pc\", perf_trace_context_common_pc, METH_VARARGS,\n\t  \"Get the common preempt count event field value.\"},\n\t{ \"common_flags\", perf_trace_context_common_flags, METH_VARARGS,\n\t  \"Get the common flags event field value.\"},\n\t{ \"common_lock_depth\", perf_trace_context_common_lock_depth,\n\t  METH_VARARGS,\t\"Get the common lock depth event field value.\"},\n#endif\n\t{ \"perf_sample_insn\", perf_sample_insn,\n\t  METH_VARARGS,\t\"Get the machine code instruction.\"},\n\t{ \"perf_set_itrace_options\", perf_set_itrace_options,\n\t  METH_VARARGS,\t\"Set --itrace options.\"},\n\t{ \"perf_sample_srcline\", perf_sample_srcline,\n\t  METH_VARARGS,\t\"Get source file name and line number.\"},\n\t{ \"perf_sample_srccode\", perf_sample_srccode,\n\t  METH_VARARGS,\t\"Get source file name, line number and line.\"},\n\t{ NULL, NULL, 0, NULL}\n};\n\n#if PY_MAJOR_VERSION < 3\nPyMODINIT_FUNC initperf_trace_context(void)\n{\n\t(void) Py_InitModule(\"perf_trace_context\", ContextMethods);\n}\n#else\nPyMODINIT_FUNC PyInit_perf_trace_context(void)\n{\n\tstatic struct PyModuleDef moduledef = {\n\t\tPyModuleDef_HEAD_INIT,\n\t\t\"perf_trace_context\",\t \n\t\t\"\",\t\t\t \n\t\t-1,\t\t\t \n\t\tContextMethods,\t\t \n\t\tNULL,\t\t\t \n\t\tNULL,\t\t\t \n\t\tNULL,\t\t\t \n\t\tNULL,\t\t\t \n\t};\n\tPyObject *mod;\n\n\tmod = PyModule_Create(&moduledef);\n\t \n\tPyObject_SetAttrString(mod, \"perf_script_context\", Py_None);\n\n\treturn mod;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}