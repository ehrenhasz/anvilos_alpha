{
  "module_name": "export-to-sqlite.py",
  "hash_id": "c94715217dde13bdb8f363757d69af583ff6ac6cd24d4c236c7b3ee16777cff4",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/scripts/python/export-to-sqlite.py",
  "human_readable_source": "# export-to-sqlite.py: export perf data to a sqlite3 database\n# Copyright (c) 2017, Intel Corporation.\n#\n# This program is free software; you can redistribute it and/or modify it\n# under the terms and conditions of the GNU General Public License,\n# version 2, as published by the Free Software Foundation.\n#\n# This program is distributed in the hope it will be useful, but WITHOUT\n# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for\n# more details.\n\nfrom __future__ import print_function\n\nimport os\nimport sys\nimport struct\nimport datetime\n\n# To use this script you will need to have installed package python-pyside which\n# provides LGPL-licensed Python bindings for Qt.  You will also need the package\n# libqt4-sql-sqlite for Qt sqlite3 support.\n#\n# Examples of installing pyside:\n#\n# ubuntu:\n#\n#\t$ sudo apt-get install python-pyside.qtsql libqt4-sql-psql\n#\n#\tAlternately, to use Python3 and/or pyside 2, one of the following:\n#\n#\t\t$ sudo apt-get install python3-pyside.qtsql libqt4-sql-psql\n#\t\t$ sudo apt-get install python-pyside2.qtsql libqt5sql5-psql\n#\t\t$ sudo apt-get install python3-pyside2.qtsql libqt5sql5-psql\n# fedora:\n#\n#\t$ sudo yum install python-pyside\n#\n#\tAlternately, to use Python3 and/or pyside 2, one of the following:\n#\t\t$ sudo yum install python3-pyside\n#\t\t$ pip install --user PySide2\n#\t\t$ pip3 install --user PySide2\n#\n# An example of using this script with Intel PT:\n#\n#\t$ perf record -e intel_pt//u ls\n#\t$ perf script -s ~/libexec/perf-core/scripts/python/export-to-sqlite.py pt_example branches calls\n#\t2017-07-31 14:26:07.326913 Creating database...\n#\t2017-07-31 14:26:07.538097 Writing records...\n#\t2017-07-31 14:26:09.889292 Adding indexes\n#\t2017-07-31 14:26:09.958746 Done\n#\n# To browse the database, sqlite3 can be used e.g.\n#\n#\t$ sqlite3 pt_example\n#\tsqlite> .header on\n#\tsqlite> select * from samples_view where id < 10;\n#\tsqlite> .mode column\n#\tsqlite> select * from samples_view where id < 10;\n#\tsqlite> .tables\n#\tsqlite> .schema samples_view\n#\tsqlite> .quit\n#\n# An example of using the database is provided by the script\n# exported-sql-viewer.py.  Refer to that script for details.\n#\n# The database structure is practically the same as created by the script\n# export-to-postgresql.py. Refer to that script for details.  A notable\n# difference is  the 'transaction' column of the 'samples' table which is\n# renamed 'transaction_' in sqlite because 'transaction' is a reserved word.\n\npyside_version_1 = True\nif not \"pyside-version-1\" in sys.argv:\n\ttry:\n\t\tfrom PySide2.QtSql import *\n\t\tpyside_version_1 = False\n\texcept:\n\t\tpass\n\nif pyside_version_1:\n\tfrom PySide.QtSql import *\n\nsys.path.append(os.environ['PERF_EXEC_PATH'] + \\\n\t'/scripts/python/Perf-Trace-Util/lib/Perf/Trace')\n\n# These perf imports are not used at present\n#from perf_trace_context import *\n#from Core import *\n\nperf_db_export_mode = True\nperf_db_export_calls = False\nperf_db_export_callchains = False\n\ndef printerr(*args, **keyword_args):\n\tprint(*args, file=sys.stderr, **keyword_args)\n\ndef printdate(*args, **kw_args):\n        print(datetime.datetime.today(), *args, sep=' ', **kw_args)\n\ndef usage():\n\tprinterr(\"Usage is: export-to-sqlite.py <database name> [<columns>] [<calls>] [<callchains>] [<pyside-version-1>]\");\n\tprinterr(\"where:  columns            'all' or 'branches'\");\n\tprinterr(\"        calls              'calls' => create calls and call_paths table\");\n\tprinterr(\"        callchains         'callchains' => create call_paths table\");\n\tprinterr(\"        pyside-version-1   'pyside-version-1' => use pyside version 1\");\n\traise Exception(\"Too few or bad arguments\")\n\nif (len(sys.argv) < 2):\n\tusage()\n\ndbname = sys.argv[1]\n\nif (len(sys.argv) >= 3):\n\tcolumns = sys.argv[2]\nelse:\n\tcolumns = \"all\"\n\nif columns not in (\"all\", \"branches\"):\n\tusage()\n\nbranches = (columns == \"branches\")\n\nfor i in range(3,len(sys.argv)):\n\tif (sys.argv[i] == \"calls\"):\n\t\tperf_db_export_calls = True\n\telif (sys.argv[i] == \"callchains\"):\n\t\tperf_db_export_callchains = True\n\telif (sys.argv[i] == \"pyside-version-1\"):\n\t\tpass\n\telse:\n\t\tusage()\n\ndef do_query(q, s):\n\tif (q.exec_(s)):\n\t\treturn\n\traise Exception(\"Query failed: \" + q.lastError().text())\n\ndef do_query_(q):\n\tif (q.exec_()):\n\t\treturn\n\traise Exception(\"Query failed: \" + q.lastError().text())\n\nprintdate(\"Creating database ...\")\n\ndb_exists = False\ntry:\n\tf = open(dbname)\n\tf.close()\n\tdb_exists = True\nexcept:\n\tpass\n\nif db_exists:\n\traise Exception(dbname + \" already exists\")\n\ndb = QSqlDatabase.addDatabase('QSQLITE')\ndb.setDatabaseName(dbname)\ndb.open()\n\nquery = QSqlQuery(db)\n\ndo_query(query, 'PRAGMA journal_mode = OFF')\ndo_query(query, 'BEGIN TRANSACTION')\n\ndo_query(query, 'CREATE TABLE selected_events ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'name\t\tvarchar(80))')\ndo_query(query, 'CREATE TABLE machines ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'pid\t\tinteger,'\n\t\t'root_dir \tvarchar(4096))')\ndo_query(query, 'CREATE TABLE threads ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'machine_id\tbigint,'\n\t\t'process_id\tbigint,'\n\t\t'pid\t\tinteger,'\n\t\t'tid\t\tinteger)')\ndo_query(query, 'CREATE TABLE comms ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'comm\t\tvarchar(16),'\n\t\t'c_thread_id\tbigint,'\n\t\t'c_time\t\tbigint,'\n\t\t'exec_flag\tboolean)')\ndo_query(query, 'CREATE TABLE comm_threads ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'comm_id\tbigint,'\n\t\t'thread_id\tbigint)')\ndo_query(query, 'CREATE TABLE dsos ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'machine_id\tbigint,'\n\t\t'short_name\tvarchar(256),'\n\t\t'long_name\tvarchar(4096),'\n\t\t'build_id\tvarchar(64))')\ndo_query(query, 'CREATE TABLE symbols ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'dso_id\t\tbigint,'\n\t\t'sym_start\tbigint,'\n\t\t'sym_end\tbigint,'\n\t\t'binding\tinteger,'\n\t\t'name\t\tvarchar(2048))')\ndo_query(query, 'CREATE TABLE branch_types ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'name\t\tvarchar(80))')\n\nif branches:\n\tdo_query(query, 'CREATE TABLE samples ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'evsel_id\tbigint,'\n\t\t'machine_id\tbigint,'\n\t\t'thread_id\tbigint,'\n\t\t'comm_id\tbigint,'\n\t\t'dso_id\t\tbigint,'\n\t\t'symbol_id\tbigint,'\n\t\t'sym_offset\tbigint,'\n\t\t'ip\t\tbigint,'\n\t\t'time\t\tbigint,'\n\t\t'cpu\t\tinteger,'\n\t\t'to_dso_id\tbigint,'\n\t\t'to_symbol_id\tbigint,'\n\t\t'to_sym_offset\tbigint,'\n\t\t'to_ip\t\tbigint,'\n\t\t'branch_type\tinteger,'\n\t\t'in_tx\t\tboolean,'\n\t\t'call_path_id\tbigint,'\n\t\t'insn_count\tbigint,'\n\t\t'cyc_count\tbigint,'\n\t\t'flags\t\tinteger)')\nelse:\n\tdo_query(query, 'CREATE TABLE samples ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'evsel_id\tbigint,'\n\t\t'machine_id\tbigint,'\n\t\t'thread_id\tbigint,'\n\t\t'comm_id\tbigint,'\n\t\t'dso_id\t\tbigint,'\n\t\t'symbol_id\tbigint,'\n\t\t'sym_offset\tbigint,'\n\t\t'ip\t\tbigint,'\n\t\t'time\t\tbigint,'\n\t\t'cpu\t\tinteger,'\n\t\t'to_dso_id\tbigint,'\n\t\t'to_symbol_id\tbigint,'\n\t\t'to_sym_offset\tbigint,'\n\t\t'to_ip\t\tbigint,'\n\t\t'period\t\tbigint,'\n\t\t'weight\t\tbigint,'\n\t\t'transaction_\tbigint,'\n\t\t'data_src\tbigint,'\n\t\t'branch_type\tinteger,'\n\t\t'in_tx\t\tboolean,'\n\t\t'call_path_id\tbigint,'\n\t\t'insn_count\tbigint,'\n\t\t'cyc_count\tbigint,'\n\t\t'flags\t\tinteger)')\n\nif perf_db_export_calls or perf_db_export_callchains:\n\tdo_query(query, 'CREATE TABLE call_paths ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'parent_id\tbigint,'\n\t\t'symbol_id\tbigint,'\n\t\t'ip\t\tbigint)')\nif perf_db_export_calls:\n\tdo_query(query, 'CREATE TABLE calls ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'thread_id\tbigint,'\n\t\t'comm_id\tbigint,'\n\t\t'call_path_id\tbigint,'\n\t\t'call_time\tbigint,'\n\t\t'return_time\tbigint,'\n\t\t'branch_count\tbigint,'\n\t\t'call_id\tbigint,'\n\t\t'return_id\tbigint,'\n\t\t'parent_call_path_id\tbigint,'\n\t\t'flags\t\tinteger,'\n\t\t'parent_id\tbigint,'\n\t\t'insn_count\tbigint,'\n\t\t'cyc_count\tbigint)')\n\ndo_query(query, 'CREATE TABLE ptwrite ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'payload\tbigint,'\n\t\t'exact_ip\tinteger)')\n\ndo_query(query, 'CREATE TABLE cbr ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'cbr\t\tinteger,'\n\t\t'mhz\t\tinteger,'\n\t\t'percent\tinteger)')\n\ndo_query(query, 'CREATE TABLE mwait ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'hints\t\tinteger,'\n\t\t'extensions\tinteger)')\n\ndo_query(query, 'CREATE TABLE pwre ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'cstate\t\tinteger,'\n\t\t'subcstate\tinteger,'\n\t\t'hw\t\tinteger)')\n\ndo_query(query, 'CREATE TABLE exstop ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'exact_ip\tinteger)')\n\ndo_query(query, 'CREATE TABLE pwrx ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'deepest_cstate\tinteger,'\n\t\t'last_cstate\tinteger,'\n\t\t'wake_reason\tinteger)')\n\ndo_query(query, 'CREATE TABLE context_switches ('\n\t\t'id\t\tinteger\t\tNOT NULL\tPRIMARY KEY,'\n\t\t'machine_id\tbigint,'\n\t\t'time\t\tbigint,'\n\t\t'cpu\t\tinteger,'\n\t\t'thread_out_id\tbigint,'\n\t\t'comm_out_id\tbigint,'\n\t\t'thread_in_id\tbigint,'\n\t\t'comm_in_id\tbigint,'\n\t\t'flags\t\tinteger)')\n\n# printf was added to sqlite in version 3.8.3\nsqlite_has_printf = False\ntry:\n\tdo_query(query, 'SELECT printf(\"\") FROM machines')\n\tsqlite_has_printf = True\nexcept:\n\tpass\n\ndef emit_to_hex(x):\n\tif sqlite_has_printf:\n\t\treturn 'printf(\"%x\", ' + x + ')'\n\telse:\n\t\treturn x\n\ndo_query(query, 'CREATE VIEW machines_view AS '\n\t'SELECT '\n\t\t'id,'\n\t\t'pid,'\n\t\t'root_dir,'\n\t\t'CASE WHEN id=0 THEN \\'unknown\\' WHEN pid=-1 THEN \\'host\\' ELSE \\'guest\\' END AS host_or_guest'\n\t' FROM machines')\n\ndo_query(query, 'CREATE VIEW dsos_view AS '\n\t'SELECT '\n\t\t'id,'\n\t\t'machine_id,'\n\t\t'(SELECT host_or_guest FROM machines_view WHERE id = machine_id) AS host_or_guest,'\n\t\t'short_name,'\n\t\t'long_name,'\n\t\t'build_id'\n\t' FROM dsos')\n\ndo_query(query, 'CREATE VIEW symbols_view AS '\n\t'SELECT '\n\t\t'id,'\n\t\t'name,'\n\t\t'(SELECT short_name FROM dsos WHERE id=dso_id) AS dso,'\n\t\t'dso_id,'\n\t\t'sym_start,'\n\t\t'sym_end,'\n\t\t'CASE WHEN binding=0 THEN \\'local\\' WHEN binding=1 THEN \\'global\\' ELSE \\'weak\\' END AS binding'\n\t' FROM symbols')\n\ndo_query(query, 'CREATE VIEW threads_view AS '\n\t'SELECT '\n\t\t'id,'\n\t\t'machine_id,'\n\t\t'(SELECT host_or_guest FROM machines_view WHERE id = machine_id) AS host_or_guest,'\n\t\t'process_id,'\n\t\t'pid,'\n\t\t'tid'\n\t' FROM threads')\n\ndo_query(query, 'CREATE VIEW comm_threads_view AS '\n\t'SELECT '\n\t\t'comm_id,'\n\t\t'(SELECT comm FROM comms WHERE id = comm_id) AS command,'\n\t\t'thread_id,'\n\t\t'(SELECT pid FROM threads WHERE id = thread_id) AS pid,'\n\t\t'(SELECT tid FROM threads WHERE id = thread_id) AS tid'\n\t' FROM comm_threads')\n\nif perf_db_export_calls or perf_db_export_callchains:\n\tdo_query(query, 'CREATE VIEW call_paths_view AS '\n\t\t'SELECT '\n\t\t\t'c.id,'\n\t\t\t+ emit_to_hex('c.ip') + ' AS ip,'\n\t\t\t'c.symbol_id,'\n\t\t\t'(SELECT name FROM symbols WHERE id = c.symbol_id) AS symbol,'\n\t\t\t'(SELECT dso_id FROM symbols WHERE id = c.symbol_id) AS dso_id,'\n\t\t\t'(SELECT dso FROM symbols_view  WHERE id = c.symbol_id) AS dso_short_name,'\n\t\t\t'c.parent_id,'\n\t\t\t+ emit_to_hex('p.ip') + ' AS parent_ip,'\n\t\t\t'p.symbol_id AS parent_symbol_id,'\n\t\t\t'(SELECT name FROM symbols WHERE id = p.symbol_id) AS parent_symbol,'\n\t\t\t'(SELECT dso_id FROM symbols WHERE id = p.symbol_id) AS parent_dso_id,'\n\t\t\t'(SELECT dso FROM symbols_view  WHERE id = p.symbol_id) AS parent_dso_short_name'\n\t\t' FROM call_paths c INNER JOIN call_paths p ON p.id = c.parent_id')\nif perf_db_export_calls:\n\tdo_query(query, 'CREATE VIEW calls_view AS '\n\t\t'SELECT '\n\t\t\t'calls.id,'\n\t\t\t'thread_id,'\n\t\t\t'(SELECT pid FROM threads WHERE id = thread_id) AS pid,'\n\t\t\t'(SELECT tid FROM threads WHERE id = thread_id) AS tid,'\n\t\t\t'(SELECT comm FROM comms WHERE id = comm_id) AS command,'\n\t\t\t'call_path_id,'\n\t\t\t+ emit_to_hex('ip') + ' AS ip,'\n\t\t\t'symbol_id,'\n\t\t\t'(SELECT name FROM symbols WHERE id = symbol_id) AS symbol,'\n\t\t\t'call_time,'\n\t\t\t'return_time,'\n\t\t\t'return_time - call_time AS elapsed_time,'\n\t\t\t'branch_count,'\n\t\t\t'insn_count,'\n\t\t\t'cyc_count,'\n\t\t\t'CASE WHEN cyc_count=0 THEN CAST(0 AS FLOAT) ELSE ROUND(CAST(insn_count AS FLOAT) / cyc_count, 2) END AS IPC,'\n\t\t\t'call_id,'\n\t\t\t'return_id,'\n\t\t\t'CASE WHEN flags=0 THEN \\'\\' WHEN flags=1 THEN \\'no call\\' WHEN flags=2 THEN \\'no return\\' WHEN flags=3 THEN \\'no call/return\\' WHEN flags=6 THEN \\'jump\\' ELSE flags END AS flags,'\n\t\t\t'parent_call_path_id,'\n\t\t\t'calls.parent_id'\n\t\t' FROM calls INNER JOIN call_paths ON call_paths.id = call_path_id')\n\ndo_query(query, 'CREATE VIEW samples_view AS '\n\t'SELECT '\n\t\t'id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t'(SELECT pid FROM threads WHERE id = thread_id) AS pid,'\n\t\t'(SELECT tid FROM threads WHERE id = thread_id) AS tid,'\n\t\t'(SELECT comm FROM comms WHERE id = comm_id) AS command,'\n\t\t'(SELECT name FROM selected_events WHERE id = evsel_id) AS event,'\n\t\t+ emit_to_hex('ip') + ' AS ip_hex,'\n\t\t'(SELECT name FROM symbols WHERE id = symbol_id) AS symbol,'\n\t\t'sym_offset,'\n\t\t'(SELECT short_name FROM dsos WHERE id = dso_id) AS dso_short_name,'\n\t\t+ emit_to_hex('to_ip') + ' AS to_ip_hex,'\n\t\t'(SELECT name FROM symbols WHERE id = to_symbol_id) AS to_symbol,'\n\t\t'to_sym_offset,'\n\t\t'(SELECT short_name FROM dsos WHERE id = to_dso_id) AS to_dso_short_name,'\n\t\t'(SELECT name FROM branch_types WHERE id = branch_type) AS branch_type_name,'\n\t\t'in_tx,'\n\t\t'insn_count,'\n\t\t'cyc_count,'\n\t\t'CASE WHEN cyc_count=0 THEN CAST(0 AS FLOAT) ELSE ROUND(CAST(insn_count AS FLOAT) / cyc_count, 2) END AS IPC,'\n\t\t'flags'\n\t' FROM samples')\n\ndo_query(query, 'CREATE VIEW ptwrite_view AS '\n\t'SELECT '\n\t\t'ptwrite.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t+ emit_to_hex('payload') + ' AS payload_hex,'\n\t\t'CASE WHEN exact_ip=0 THEN \\'False\\' ELSE \\'True\\' END AS exact_ip'\n\t' FROM ptwrite'\n\t' INNER JOIN samples ON samples.id = ptwrite.id')\n\ndo_query(query, 'CREATE VIEW cbr_view AS '\n\t'SELECT '\n\t\t'cbr.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t'cbr,'\n\t\t'mhz,'\n\t\t'percent'\n\t' FROM cbr'\n\t' INNER JOIN samples ON samples.id = cbr.id')\n\ndo_query(query, 'CREATE VIEW mwait_view AS '\n\t'SELECT '\n\t\t'mwait.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t+ emit_to_hex('hints') + ' AS hints_hex,'\n\t\t+ emit_to_hex('extensions') + ' AS extensions_hex'\n\t' FROM mwait'\n\t' INNER JOIN samples ON samples.id = mwait.id')\n\ndo_query(query, 'CREATE VIEW pwre_view AS '\n\t'SELECT '\n\t\t'pwre.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t'cstate,'\n\t\t'subcstate,'\n\t\t'CASE WHEN hw=0 THEN \\'False\\' ELSE \\'True\\' END AS hw'\n\t' FROM pwre'\n\t' INNER JOIN samples ON samples.id = pwre.id')\n\ndo_query(query, 'CREATE VIEW exstop_view AS '\n\t'SELECT '\n\t\t'exstop.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t'CASE WHEN exact_ip=0 THEN \\'False\\' ELSE \\'True\\' END AS exact_ip'\n\t' FROM exstop'\n\t' INNER JOIN samples ON samples.id = exstop.id')\n\ndo_query(query, 'CREATE VIEW pwrx_view AS '\n\t'SELECT '\n\t\t'pwrx.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t'deepest_cstate,'\n\t\t'last_cstate,'\n\t\t'CASE     WHEN wake_reason=1 THEN \\'Interrupt\\''\n\t\t\t' WHEN wake_reason=2 THEN \\'Timer Deadline\\''\n\t\t\t' WHEN wake_reason=4 THEN \\'Monitored Address\\''\n\t\t\t' WHEN wake_reason=8 THEN \\'HW\\''\n\t\t\t' ELSE wake_reason '\n\t\t'END AS wake_reason'\n\t' FROM pwrx'\n\t' INNER JOIN samples ON samples.id = pwrx.id')\n\ndo_query(query, 'CREATE VIEW power_events_view AS '\n\t'SELECT '\n\t\t'samples.id,'\n\t\t'time,'\n\t\t'cpu,'\n\t\t'selected_events.name AS event,'\n\t\t'CASE WHEN selected_events.name=\\'cbr\\' THEN (SELECT cbr FROM cbr WHERE cbr.id = samples.id) ELSE \"\" END AS cbr,'\n\t\t'CASE WHEN selected_events.name=\\'cbr\\' THEN (SELECT mhz FROM cbr WHERE cbr.id = samples.id) ELSE \"\" END AS mhz,'\n\t\t'CASE WHEN selected_events.name=\\'cbr\\' THEN (SELECT percent FROM cbr WHERE cbr.id = samples.id) ELSE \"\" END AS percent,'\n\t\t'CASE WHEN selected_events.name=\\'mwait\\' THEN (SELECT ' + emit_to_hex('hints') + ' FROM mwait WHERE mwait.id = samples.id) ELSE \"\" END AS hints_hex,'\n\t\t'CASE WHEN selected_events.name=\\'mwait\\' THEN (SELECT ' + emit_to_hex('extensions') + ' FROM mwait WHERE mwait.id = samples.id) ELSE \"\" END AS extensions_hex,'\n\t\t'CASE WHEN selected_events.name=\\'pwre\\' THEN (SELECT cstate FROM pwre WHERE pwre.id = samples.id) ELSE \"\" END AS cstate,'\n\t\t'CASE WHEN selected_events.name=\\'pwre\\' THEN (SELECT subcstate FROM pwre WHERE pwre.id = samples.id) ELSE \"\" END AS subcstate,'\n\t\t'CASE WHEN selected_events.name=\\'pwre\\' THEN (SELECT hw FROM pwre WHERE pwre.id = samples.id) ELSE \"\" END AS hw,'\n\t\t'CASE WHEN selected_events.name=\\'exstop\\' THEN (SELECT exact_ip FROM exstop WHERE exstop.id = samples.id) ELSE \"\" END AS exact_ip,'\n\t\t'CASE WHEN selected_events.name=\\'pwrx\\' THEN (SELECT deepest_cstate FROM pwrx WHERE pwrx.id = samples.id) ELSE \"\" END AS deepest_cstate,'\n\t\t'CASE WHEN selected_events.name=\\'pwrx\\' THEN (SELECT last_cstate FROM pwrx WHERE pwrx.id = samples.id) ELSE \"\" END AS last_cstate,'\n\t\t'CASE WHEN selected_events.name=\\'pwrx\\' THEN (SELECT '\n\t\t\t'CASE     WHEN wake_reason=1 THEN \\'Interrupt\\''\n\t\t\t\t' WHEN wake_reason=2 THEN \\'Timer Deadline\\''\n\t\t\t\t' WHEN wake_reason=4 THEN \\'Monitored Address\\''\n\t\t\t\t' WHEN wake_reason=8 THEN \\'HW\\''\n\t\t\t\t' ELSE wake_reason '\n\t\t\t'END'\n\t\t' FROM pwrx WHERE pwrx.id = samples.id) ELSE \"\" END AS wake_reason'\n\t' FROM samples'\n\t' INNER JOIN selected_events ON selected_events.id = evsel_id'\n\t' WHERE selected_events.name IN (\\'cbr\\',\\'mwait\\',\\'exstop\\',\\'pwre\\',\\'pwrx\\')')\n\ndo_query(query, 'CREATE VIEW context_switches_view AS '\n\t'SELECT '\n\t\t'context_switches.id,'\n\t\t'context_switches.machine_id,'\n\t\t'context_switches.time,'\n\t\t'context_switches.cpu,'\n\t\t'th_out.pid AS pid_out,'\n\t\t'th_out.tid AS tid_out,'\n\t\t'comm_out.comm AS comm_out,'\n\t\t'th_in.pid AS pid_in,'\n\t\t'th_in.tid AS tid_in,'\n\t\t'comm_in.comm AS comm_in,'\n\t\t'CASE\t  WHEN context_switches.flags = 0 THEN \\'in\\''\n\t\t\t' WHEN context_switches.flags = 1 THEN \\'out\\''\n\t\t\t' WHEN context_switches.flags = 3 THEN \\'out preempt\\''\n\t\t\t' ELSE context_switches.flags '\n\t\t'END AS flags'\n\t' FROM context_switches'\n\t' INNER JOIN threads AS th_out ON th_out.id   = context_switches.thread_out_id'\n\t' INNER JOIN threads AS th_in  ON th_in.id    = context_switches.thread_in_id'\n\t' INNER JOIN comms AS comm_out ON comm_out.id = context_switches.comm_out_id'\n\t' INNER JOIN comms AS comm_in  ON comm_in.id  = context_switches.comm_in_id')\n\ndo_query(query, 'END TRANSACTION')\n\nevsel_query = QSqlQuery(db)\nevsel_query.prepare(\"INSERT INTO selected_events VALUES (?, ?)\")\nmachine_query = QSqlQuery(db)\nmachine_query.prepare(\"INSERT INTO machines VALUES (?, ?, ?)\")\nthread_query = QSqlQuery(db)\nthread_query.prepare(\"INSERT INTO threads VALUES (?, ?, ?, ?, ?)\")\ncomm_query = QSqlQuery(db)\ncomm_query.prepare(\"INSERT INTO comms VALUES (?, ?, ?, ?, ?)\")\ncomm_thread_query = QSqlQuery(db)\ncomm_thread_query.prepare(\"INSERT INTO comm_threads VALUES (?, ?, ?)\")\ndso_query = QSqlQuery(db)\ndso_query.prepare(\"INSERT INTO dsos VALUES (?, ?, ?, ?, ?)\")\nsymbol_query = QSqlQuery(db)\nsymbol_query.prepare(\"INSERT INTO symbols VALUES (?, ?, ?, ?, ?, ?)\")\nbranch_type_query = QSqlQuery(db)\nbranch_type_query.prepare(\"INSERT INTO branch_types VALUES (?, ?)\")\nsample_query = QSqlQuery(db)\nif branches:\n\tsample_query.prepare(\"INSERT INTO samples VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\")\nelse:\n\tsample_query.prepare(\"INSERT INTO samples VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\")\nif perf_db_export_calls or perf_db_export_callchains:\n\tcall_path_query = QSqlQuery(db)\n\tcall_path_query.prepare(\"INSERT INTO call_paths VALUES (?, ?, ?, ?)\")\nif perf_db_export_calls:\n\tcall_query = QSqlQuery(db)\n\tcall_query.prepare(\"INSERT INTO calls VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\")\nptwrite_query = QSqlQuery(db)\nptwrite_query.prepare(\"INSERT INTO ptwrite VALUES (?, ?, ?)\")\ncbr_query = QSqlQuery(db)\ncbr_query.prepare(\"INSERT INTO cbr VALUES (?, ?, ?, ?)\")\nmwait_query = QSqlQuery(db)\nmwait_query.prepare(\"INSERT INTO mwait VALUES (?, ?, ?)\")\npwre_query = QSqlQuery(db)\npwre_query.prepare(\"INSERT INTO pwre VALUES (?, ?, ?, ?)\")\nexstop_query = QSqlQuery(db)\nexstop_query.prepare(\"INSERT INTO exstop VALUES (?, ?)\")\npwrx_query = QSqlQuery(db)\npwrx_query.prepare(\"INSERT INTO pwrx VALUES (?, ?, ?, ?)\")\ncontext_switch_query = QSqlQuery(db)\ncontext_switch_query.prepare(\"INSERT INTO context_switches VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\")\n\ndef trace_begin():\n\tprintdate(\"Writing records...\")\n\tdo_query(query, 'BEGIN TRANSACTION')\n\t# id == 0 means unknown.  It is easier to create records for them than replace the zeroes with NULLs\n\tevsel_table(0, \"unknown\")\n\tmachine_table(0, 0, \"unknown\")\n\tthread_table(0, 0, 0, -1, -1)\n\tcomm_table(0, \"unknown\", 0, 0, 0)\n\tdso_table(0, 0, \"unknown\", \"unknown\", \"\")\n\tsymbol_table(0, 0, 0, 0, 0, \"unknown\")\n\tsample_table(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)\n\tif perf_db_export_calls or perf_db_export_callchains:\n\t\tcall_path_table(0, 0, 0, 0)\n\t\tcall_return_table(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)\n\nunhandled_count = 0\n\ndef is_table_empty(table_name):\n\tdo_query(query, 'SELECT * FROM ' + table_name + ' LIMIT 1');\n\tif query.next():\n\t\treturn False\n\treturn True\n\ndef drop(table_name):\n\tdo_query(query, 'DROP VIEW ' + table_name + '_view');\n\tdo_query(query, 'DROP TABLE ' + table_name);\n\ndef trace_end():\n\tdo_query(query, 'END TRANSACTION')\n\n\tprintdate(\"Adding indexes\")\n\tif perf_db_export_calls:\n\t\tdo_query(query, 'CREATE INDEX pcpid_idx ON calls (parent_call_path_id)')\n\t\tdo_query(query, 'CREATE INDEX pid_idx ON calls (parent_id)')\n\t\tdo_query(query, 'ALTER TABLE comms ADD has_calls boolean')\n\t\tdo_query(query, 'UPDATE comms SET has_calls = 1 WHERE comms.id IN (SELECT DISTINCT comm_id FROM calls)')\n\n\tprintdate(\"Dropping unused tables\")\n\tif is_table_empty(\"ptwrite\"):\n\t\tdrop(\"ptwrite\")\n\tif is_table_empty(\"mwait\") and is_table_empty(\"pwre\") and is_table_empty(\"exstop\") and is_table_empty(\"pwrx\"):\n\t\tdo_query(query, 'DROP VIEW power_events_view');\n\t\tdrop(\"mwait\")\n\t\tdrop(\"pwre\")\n\t\tdrop(\"exstop\")\n\t\tdrop(\"pwrx\")\n\t\tif is_table_empty(\"cbr\"):\n\t\t\tdrop(\"cbr\")\n\tif is_table_empty(\"context_switches\"):\n\t\tdrop(\"context_switches\")\n\n\tif (unhandled_count):\n\t\tprintdate(\"Warning: \", unhandled_count, \" unhandled events\")\n\tprintdate(\"Done\")\n\ndef trace_unhandled(event_name, context, event_fields_dict):\n\tglobal unhandled_count\n\tunhandled_count += 1\n\ndef sched__sched_switch(*x):\n\tpass\n\ndef bind_exec(q, n, x):\n\tfor xx in x[0:n]:\n\t\tq.addBindValue(str(xx))\n\tdo_query_(q)\n\ndef evsel_table(*x):\n\tbind_exec(evsel_query, 2, x)\n\ndef machine_table(*x):\n\tbind_exec(machine_query, 3, x)\n\ndef thread_table(*x):\n\tbind_exec(thread_query, 5, x)\n\ndef comm_table(*x):\n\tbind_exec(comm_query, 5, x)\n\ndef comm_thread_table(*x):\n\tbind_exec(comm_thread_query, 3, x)\n\ndef dso_table(*x):\n\tbind_exec(dso_query, 5, x)\n\ndef symbol_table(*x):\n\tbind_exec(symbol_query, 6, x)\n\ndef branch_type_table(*x):\n\tbind_exec(branch_type_query, 2, x)\n\ndef sample_table(*x):\n\tif branches:\n\t\tfor xx in x[0:15]:\n\t\t\tsample_query.addBindValue(str(xx))\n\t\tfor xx in x[19:25]:\n\t\t\tsample_query.addBindValue(str(xx))\n\t\tdo_query_(sample_query)\n\telse:\n\t\tbind_exec(sample_query, 25, x)\n\ndef call_path_table(*x):\n\tbind_exec(call_path_query, 4, x)\n\ndef call_return_table(*x):\n\tbind_exec(call_query, 14, x)\n\ndef ptwrite(id, raw_buf):\n\tdata = struct.unpack_from(\"<IQ\", raw_buf)\n\tflags = data[0]\n\tpayload = data[1]\n\texact_ip = flags & 1\n\tptwrite_query.addBindValue(str(id))\n\tptwrite_query.addBindValue(str(payload))\n\tptwrite_query.addBindValue(str(exact_ip))\n\tdo_query_(ptwrite_query)\n\ndef cbr(id, raw_buf):\n\tdata = struct.unpack_from(\"<BBBBII\", raw_buf)\n\tcbr = data[0]\n\tMHz = (data[4] + 500) / 1000\n\tpercent = ((cbr * 1000 / data[2]) + 5) / 10\n\tcbr_query.addBindValue(str(id))\n\tcbr_query.addBindValue(str(cbr))\n\tcbr_query.addBindValue(str(MHz))\n\tcbr_query.addBindValue(str(percent))\n\tdo_query_(cbr_query)\n\ndef mwait(id, raw_buf):\n\tdata = struct.unpack_from(\"<IQ\", raw_buf)\n\tpayload = data[1]\n\thints = payload & 0xff\n\textensions = (payload >> 32) & 0x3\n\tmwait_query.addBindValue(str(id))\n\tmwait_query.addBindValue(str(hints))\n\tmwait_query.addBindValue(str(extensions))\n\tdo_query_(mwait_query)\n\ndef pwre(id, raw_buf):\n\tdata = struct.unpack_from(\"<IQ\", raw_buf)\n\tpayload = data[1]\n\thw = (payload >> 7) & 1\n\tcstate = (payload >> 12) & 0xf\n\tsubcstate = (payload >> 8) & 0xf\n\tpwre_query.addBindValue(str(id))\n\tpwre_query.addBindValue(str(cstate))\n\tpwre_query.addBindValue(str(subcstate))\n\tpwre_query.addBindValue(str(hw))\n\tdo_query_(pwre_query)\n\ndef exstop(id, raw_buf):\n\tdata = struct.unpack_from(\"<I\", raw_buf)\n\tflags = data[0]\n\texact_ip = flags & 1\n\texstop_query.addBindValue(str(id))\n\texstop_query.addBindValue(str(exact_ip))\n\tdo_query_(exstop_query)\n\ndef pwrx(id, raw_buf):\n\tdata = struct.unpack_from(\"<IQ\", raw_buf)\n\tpayload = data[1]\n\tdeepest_cstate = payload & 0xf\n\tlast_cstate = (payload >> 4) & 0xf\n\twake_reason = (payload >> 8) & 0xf\n\tpwrx_query.addBindValue(str(id))\n\tpwrx_query.addBindValue(str(deepest_cstate))\n\tpwrx_query.addBindValue(str(last_cstate))\n\tpwrx_query.addBindValue(str(wake_reason))\n\tdo_query_(pwrx_query)\n\ndef synth_data(id, config, raw_buf, *x):\n\tif config == 0:\n\t\tptwrite(id, raw_buf)\n\telif config == 1:\n\t\tmwait(id, raw_buf)\n\telif config == 2:\n\t\tpwre(id, raw_buf)\n\telif config == 3:\n\t\texstop(id, raw_buf)\n\telif config == 4:\n\t\tpwrx(id, raw_buf)\n\telif config == 5:\n\t\tcbr(id, raw_buf)\n\ndef context_switch_table(*x):\n\tbind_exec(context_switch_query, 9, x)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}