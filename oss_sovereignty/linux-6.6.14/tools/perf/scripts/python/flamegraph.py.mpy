{
  "module_name": "flamegraph.py",
  "hash_id": "4da15c1104a85b6a6299efc88594a6952e96693617af21740a4b46a1c86c0e2d",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/scripts/python/flamegraph.py",
  "human_readable_source": "# flamegraph.py - create flame graphs from perf samples\n# SPDX-License-Identifier: GPL-2.0\n#\n# Usage:\n#\n#     perf record -a -g -F 99 sleep 60\n#     perf script report flamegraph\n#\n# Combined:\n#\n#     perf script flamegraph -a -F 99 sleep 60\n#\n# Written by Andreas Gerstmayr <agerstmayr@redhat.com>\n# Flame Graphs invented by Brendan Gregg <bgregg@netflix.com>\n# Works in tandem with d3-flame-graph by Martin Spier <mspier@netflix.com>\n#\n# pylint: disable=missing-module-docstring\n# pylint: disable=missing-class-docstring\n# pylint: disable=missing-function-docstring\n\nfrom __future__ import print_function\nimport argparse\nimport hashlib\nimport io\nimport json\nimport os\nimport subprocess\nimport sys\nimport urllib.request\n\nminimal_html = \"\"\"<head>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.css\">\n</head>\n<body>\n  <div id=\"chart\"></div>\n  <script type=\"text/javascript\" src=\"https://d3js.org/d3.v7.js\"></script>\n  <script type=\"text/javascript\" src=\"https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.min.js\"></script>\n  <script type=\"text/javascript\">\n  const stacks = [/** @flamegraph_json **/];\n  // Note, options is unused.\n  const options = [/** @options_json **/];\n\n  var chart = flamegraph();\n  d3.select(\"#chart\")\n        .datum(stacks[0])\n        .call(chart);\n  </script>\n</body>\n\"\"\"\n\n# pylint: disable=too-few-public-methods\nclass Node:\n    def __init__(self, name, libtype):\n        self.name = name\n        # \"root\" | \"kernel\" | \"\"\n        # \"\" indicates user space\n        self.libtype = libtype\n        self.value = 0\n        self.children = []\n\n    def to_json(self):\n        return {\n            \"n\": self.name,\n            \"l\": self.libtype,\n            \"v\": self.value,\n            \"c\": self.children\n        }\n\n\nclass FlameGraphCLI:\n    def __init__(self, args):\n        self.args = args\n        self.stack = Node(\"all\", \"root\")\n\n    @staticmethod\n    def get_libtype_from_dso(dso):\n        \"\"\"\n        when kernel-debuginfo is installed,\n        dso points to /usr/lib/debug/lib/modules/*/vmlinux\n        \"\"\"\n        if dso and (dso == \"[kernel.kallsyms]\" or dso.endswith(\"/vmlinux\")):\n            return \"kernel\"\n\n        return \"\"\n\n    @staticmethod\n    def find_or_create_node(node, name, libtype):\n        for child in node.children:\n            if child.name == name:\n                return child\n\n        child = Node(name, libtype)\n        node.children.append(child)\n        return child\n\n    def process_event(self, event):\n        pid = event.get(\"sample\", {}).get(\"pid\", 0)\n        # event[\"dso\"] sometimes contains /usr/lib/debug/lib/modules/*/vmlinux\n        # for user-space processes; let's use pid for kernel or user-space distinction\n        if pid == 0:\n            comm = event[\"comm\"]\n            libtype = \"kernel\"\n        else:\n            comm = \"{} ({})\".format(event[\"comm\"], pid)\n            libtype = \"\"\n        node = self.find_or_create_node(self.stack, comm, libtype)\n\n        if \"callchain\" in event:\n            for entry in reversed(event[\"callchain\"]):\n                name = entry.get(\"sym\", {}).get(\"name\", \"[unknown]\")\n                libtype = self.get_libtype_from_dso(entry.get(\"dso\"))\n                node = self.find_or_create_node(node, name, libtype)\n        else:\n            name = event.get(\"symbol\", \"[unknown]\")\n            libtype = self.get_libtype_from_dso(event.get(\"dso\"))\n            node = self.find_or_create_node(node, name, libtype)\n        node.value += 1\n\n    def get_report_header(self):\n        if self.args.input == \"-\":\n            # when this script is invoked with \"perf script flamegraph\",\n            # no perf.data is created and we cannot read the header of it\n            return \"\"\n\n        try:\n            output = subprocess.check_output([\"perf\", \"report\", \"--header-only\"])\n            return output.decode(\"utf-8\")\n        except Exception as err:  # pylint: disable=broad-except\n            print(\"Error reading report header: {}\".format(err), file=sys.stderr)\n            return \"\"\n\n    def trace_end(self):\n        stacks_json = json.dumps(self.stack, default=lambda x: x.to_json())\n\n        if self.args.format == \"html\":\n            report_header = self.get_report_header()\n            options = {\n                \"colorscheme\": self.args.colorscheme,\n                \"context\": report_header\n            }\n            options_json = json.dumps(options)\n\n            template_md5sum = None\n            if self.args.format == \"html\":\n                if os.path.isfile(self.args.template):\n                    template = f\"file://{self.args.template}\"\n                else:\n                    if not self.args.allow_download:\n                        print(f\"\"\"Warning: Flame Graph template '{self.args.template}'\ndoes not exist. To avoid this please install a package such as the\njs-d3-flame-graph or libjs-d3-flame-graph, specify an existing flame\ngraph template (--template PATH) or use another output format (--format\nFORMAT).\"\"\",\n                              file=sys.stderr)\n                        if self.args.input == \"-\":\n                            print(\"\"\"Not attempting to download Flame Graph template as script command line\ninput is disabled due to using live mode. If you want to download the\ntemplate retry without live mode. For example, use 'perf record -a -g\n-F 99 sleep 60' and 'perf script report flamegraph'. Alternatively,\ndownload the template from:\nhttps://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/templates/d3-flamegraph-base.html\nand place it at:\n/usr/share/d3-flame-graph/d3-flamegraph-base.html\"\"\",\n                                  file=sys.stderr)\n                            quit()\n                        s = None\n                        while s != \"y\" and s != \"n\":\n                            s = input(\"Do you wish to download a template from cdn.jsdelivr.net? (this warning can be suppressed with --allow-download) [yn] \").lower()\n                        if s == \"n\":\n                            quit()\n                    template = \"https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/templates/d3-flamegraph-base.html\"\n                    template_md5sum = \"143e0d06ba69b8370b9848dcd6ae3f36\"\n\n            try:\n                with urllib.request.urlopen(template) as template:\n                    output_str = \"\".join([\n                        l.decode(\"utf-8\") for l in template.readlines()\n                    ])\n            except Exception as err:\n                print(f\"Error reading template {template}: {err}\\n\"\n                      \"a minimal flame graph will be generated\", file=sys.stderr)\n                output_str = minimal_html\n                template_md5sum = None\n\n            if template_md5sum:\n                download_md5sum = hashlib.md5(output_str.encode(\"utf-8\")).hexdigest()\n                if download_md5sum != template_md5sum:\n                    s = None\n                    while s != \"y\" and s != \"n\":\n                        s = input(f\"\"\"Unexpected template md5sum.\n{download_md5sum} != {template_md5sum}, for:\n{output_str}\ncontinue?[yn] \"\"\").lower()\n                    if s == \"n\":\n                        quit()\n\n            output_str = output_str.replace(\"/** @options_json **/\", options_json)\n            output_str = output_str.replace(\"/** @flamegraph_json **/\", stacks_json)\n\n            output_fn = self.args.output or \"flamegraph.html\"\n        else:\n            output_str = stacks_json\n            output_fn = self.args.output or \"stacks.json\"\n\n        if output_fn == \"-\":\n            with io.open(sys.stdout.fileno(), \"w\", encoding=\"utf-8\", closefd=False) as out:\n                out.write(output_str)\n        else:\n            print(\"dumping data to {}\".format(output_fn))\n            try:\n                with io.open(output_fn, \"w\", encoding=\"utf-8\") as out:\n                    out.write(output_str)\n            except IOError as err:\n                print(\"Error writing output file: {}\".format(err), file=sys.stderr)\n                sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    parser = argparse.ArgumentParser(description=\"Create flame graphs.\")\n    parser.add_argument(\"-f\", \"--format\",\n                        default=\"html\", choices=[\"json\", \"html\"],\n                        help=\"output file format\")\n    parser.add_argument(\"-o\", \"--output\",\n                        help=\"output file name\")\n    parser.add_argument(\"--template\",\n                        default=\"/usr/share/d3-flame-graph/d3-flamegraph-base.html\",\n                        help=\"path to flame graph HTML template\")\n    parser.add_argument(\"--colorscheme\",\n                        default=\"blue-green\",\n                        help=\"flame graph color scheme\",\n                        choices=[\"blue-green\", \"orange\"])\n    parser.add_argument(\"-i\", \"--input\",\n                        help=argparse.SUPPRESS)\n    parser.add_argument(\"--allow-download\",\n                        default=False,\n                        action=\"store_true\",\n                        help=\"allow unprompted downloading of HTML template\")\n\n    cli_args = parser.parse_args()\n    cli = FlameGraphCLI(cli_args)\n\n    process_event = cli.process_event\n    trace_end = cli.trace_end\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}