{
  "module_name": "intel-pt-log.c",
  "hash_id": "8852fd3da1168652063cbbf4b91b085d5504f0e0ae4d2bf7e0c488997233d080",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/intel-pt-decoder/intel-pt-log.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdint.h>\n#include <inttypes.h>\n#include <stdarg.h>\n#include <stdbool.h>\n#include <string.h>\n\n#include <linux/zalloc.h>\n#include <linux/kernel.h>\n\n#include \"intel-pt-log.h\"\n#include \"intel-pt-insn-decoder.h\"\n\n#include \"intel-pt-pkt-decoder.h\"\n\n#define MAX_LOG_NAME 256\n\n#define DFLT_BUF_SZ\t(16 * 1024)\n\nstruct log_buf {\n\tchar\t\t\t*buf;\n\tsize_t\t\t\tbuf_sz;\n\tsize_t\t\t\thead;\n\tbool\t\t\twrapped;\n\tFILE\t\t\t*backend;\n};\n\nstatic FILE *f;\nstatic char log_name[MAX_LOG_NAME];\nbool intel_pt_enable_logging;\nstatic bool intel_pt_dump_log_on_error;\nstatic unsigned int intel_pt_log_on_error_size;\nstatic struct log_buf log_buf;\n\nvoid *intel_pt_log_fp(void)\n{\n\treturn f;\n}\n\nvoid intel_pt_log_enable(bool dump_log_on_error, unsigned int log_on_error_size)\n{\n\tintel_pt_enable_logging = true;\n\tintel_pt_dump_log_on_error = dump_log_on_error;\n\tintel_pt_log_on_error_size = log_on_error_size;\n}\n\nvoid intel_pt_log_disable(void)\n{\n\tif (f)\n\t\tfflush(f);\n\tintel_pt_enable_logging = false;\n}\n\nvoid intel_pt_log_set_name(const char *name)\n{\n\tstrncpy(log_name, name, MAX_LOG_NAME - 5);\n\tstrcat(log_name, \".log\");\n}\n\nstatic void intel_pt_print_data(const unsigned char *buf, int len, uint64_t pos,\n\t\t\t\tint indent)\n{\n\tint i;\n\n\tfor (i = 0; i < indent; i++)\n\t\tfprintf(f, \" \");\n\n\tfprintf(f, \"  %08\" PRIx64 \": \", pos);\n\tfor (i = 0; i < len; i++)\n\t\tfprintf(f, \" %02x\", buf[i]);\n\tfor (; i < 16; i++)\n\t\tfprintf(f, \"   \");\n\tfprintf(f, \" \");\n}\n\nstatic void intel_pt_print_no_data(uint64_t pos, int indent)\n{\n\tint i;\n\n\tfor (i = 0; i < indent; i++)\n\t\tfprintf(f, \" \");\n\n\tfprintf(f, \"  %08\" PRIx64 \": \", pos);\n\tfor (i = 0; i < 16; i++)\n\t\tfprintf(f, \"   \");\n\tfprintf(f, \" \");\n}\n\nstatic ssize_t log_buf__write(void *cookie, const char *buf, size_t size)\n{\n\tstruct log_buf *b = cookie;\n\tsize_t sz = size;\n\n\tif (!b->buf)\n\t\treturn size;\n\n\twhile (sz) {\n\t\tsize_t space = b->buf_sz - b->head;\n\t\tsize_t n = min(space, sz);\n\n\t\tmemcpy(b->buf + b->head, buf, n);\n\t\tsz -= n;\n\t\tbuf += n;\n\t\tb->head += n;\n\t\tif (sz && b->head >= b->buf_sz) {\n\t\t\tb->head = 0;\n\t\t\tb->wrapped = true;\n\t\t}\n\t}\n\treturn size;\n}\n\nstatic int log_buf__close(void *cookie)\n{\n\tstruct log_buf *b = cookie;\n\n\tzfree(&b->buf);\n\treturn 0;\n}\n\nstatic FILE *log_buf__open(struct log_buf *b, FILE *backend, unsigned int sz)\n{\n\tcookie_io_functions_t fns = {\n\t\t.write = log_buf__write,\n\t\t.close = log_buf__close,\n\t};\n\tFILE *file;\n\n\tmemset(b, 0, sizeof(*b));\n\tb->buf_sz = sz;\n\tb->buf = malloc(b->buf_sz);\n\tb->backend = backend;\n\tfile = fopencookie(b, \"a\", fns);\n\tif (!file)\n\t\tzfree(&b->buf);\n\treturn file;\n}\n\nstatic bool remove_first_line(const char **p, size_t *n)\n{\n\tfor (; *n && **p != '\\n'; ++*p, --*n)\n\t\t;\n\tif (*n) {\n\t\t*p += 1;\n\t\t*n -= 1;\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic void write_lines(const char *p, size_t n, FILE *fp, bool *remove_first)\n{\n\tif (*remove_first)\n\t\t*remove_first = !remove_first_line(&p, &n);\n\tfwrite(p, n, 1, fp);\n}\n\nstatic void log_buf__dump(struct log_buf *b)\n{\n\tbool remove_first = false;\n\n\tif (!b->buf)\n\t\treturn;\n\n\tfflush(f);  \n\tfprintf(b->backend, \"Dumping debug log buffer\\n\");\n\tif (b->wrapped) {\n\t\tremove_first = true;\n\t\twrite_lines(b->buf + b->head, b->buf_sz - b->head, b->backend, &remove_first);\n\t}\n\twrite_lines(b->buf, b->head, b->backend, &remove_first);\n\tfprintf(b->backend, \"End of debug log buffer dump\\n\");\n\n\tb->head = 0;\n\tb->wrapped = false;\n}\n\nvoid intel_pt_log_dump_buf(void)\n{\n\tlog_buf__dump(&log_buf);\n}\n\nstatic int intel_pt_log_open(void)\n{\n\tif (!intel_pt_enable_logging)\n\t\treturn -1;\n\n\tif (f)\n\t\treturn 0;\n\n\tif (log_name[0])\n\t\tf = fopen(log_name, \"w+\");\n\telse\n\t\tf = stdout;\n\tif (f && intel_pt_dump_log_on_error)\n\t\tf = log_buf__open(&log_buf, f, intel_pt_log_on_error_size);\n\tif (!f) {\n\t\tintel_pt_enable_logging = false;\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nvoid __intel_pt_log_packet(const struct intel_pt_pkt *packet, int pkt_len,\n\t\t\t   uint64_t pos, const unsigned char *buf)\n{\n\tchar desc[INTEL_PT_PKT_DESC_MAX];\n\n\tif (intel_pt_log_open())\n\t\treturn;\n\n\tintel_pt_print_data(buf, pkt_len, pos, 0);\n\tintel_pt_pkt_desc(packet, desc, INTEL_PT_PKT_DESC_MAX);\n\tfprintf(f, \"%s\\n\", desc);\n}\n\nvoid __intel_pt_log_insn(struct intel_pt_insn *intel_pt_insn, uint64_t ip)\n{\n\tchar desc[INTEL_PT_INSN_DESC_MAX];\n\tsize_t len = intel_pt_insn->length;\n\n\tif (intel_pt_log_open())\n\t\treturn;\n\n\tif (len > INTEL_PT_INSN_BUF_SZ)\n\t\tlen = INTEL_PT_INSN_BUF_SZ;\n\tintel_pt_print_data(intel_pt_insn->buf, len, ip, 8);\n\tif (intel_pt_insn_desc(intel_pt_insn, desc, INTEL_PT_INSN_DESC_MAX) > 0)\n\t\tfprintf(f, \"%s\\n\", desc);\n\telse\n\t\tfprintf(f, \"Bad instruction!\\n\");\n}\n\nvoid __intel_pt_log_insn_no_data(struct intel_pt_insn *intel_pt_insn,\n\t\t\t\t uint64_t ip)\n{\n\tchar desc[INTEL_PT_INSN_DESC_MAX];\n\n\tif (intel_pt_log_open())\n\t\treturn;\n\n\tintel_pt_print_no_data(ip, 8);\n\tif (intel_pt_insn_desc(intel_pt_insn, desc, INTEL_PT_INSN_DESC_MAX) > 0)\n\t\tfprintf(f, \"%s\\n\", desc);\n\telse\n\t\tfprintf(f, \"Bad instruction!\\n\");\n}\n\nvoid __intel_pt_log(const char *fmt, ...)\n{\n\tva_list args;\n\n\tif (intel_pt_log_open())\n\t\treturn;\n\n\tva_start(args, fmt);\n\tvfprintf(f, fmt, args);\n\tva_end(args);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}