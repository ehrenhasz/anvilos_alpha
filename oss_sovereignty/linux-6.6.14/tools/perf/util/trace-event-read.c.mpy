{
  "module_name": "trace-event-read.c",
  "hash_id": "f77289c6c0db31c142c49a0481bbd39db26bc97e7f24aa833378bc7fe3614ae2",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/trace-event-read.c",
  "human_readable_source": "\n \n#include <dirent.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <stdarg.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/wait.h>\n#include <sys/mman.h>\n#include <traceevent/event-parse.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <errno.h>\n\n#include \"trace-event.h\"\n#include \"debug.h\"\n#include \"util.h\"\n\nstatic int input_fd;\n\nstatic ssize_t trace_data_size;\nstatic bool repipe;\n\nstatic int __do_read(int fd, void *buf, int size)\n{\n\tint rsize = size;\n\n\twhile (size) {\n\t\tint ret = read(fd, buf, size);\n\n\t\tif (ret <= 0)\n\t\t\treturn -1;\n\n\t\tif (repipe) {\n\t\t\tint retw = write(STDOUT_FILENO, buf, ret);\n\n\t\t\tif (retw <= 0 || retw != ret) {\n\t\t\t\tpr_debug(\"repiping input file\");\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t}\n\n\t\tsize -= ret;\n\t\tbuf += ret;\n\t}\n\n\treturn rsize;\n}\n\nstatic int do_read(void *data, int size)\n{\n\tint r;\n\n\tr = __do_read(input_fd, data, size);\n\tif (r <= 0) {\n\t\tpr_debug(\"reading input file (size expected=%d received=%d)\",\n\t\t\t size, r);\n\t\treturn -1;\n\t}\n\n\ttrace_data_size += r;\n\n\treturn r;\n}\n\n \nstatic void skip(int size)\n{\n\tchar buf[BUFSIZ];\n\tint r;\n\n\twhile (size) {\n\t\tr = size > BUFSIZ ? BUFSIZ : size;\n\t\tdo_read(buf, r);\n\t\tsize -= r;\n\t}\n}\n\nstatic unsigned int read4(struct tep_handle *pevent)\n{\n\tunsigned int data;\n\n\tif (do_read(&data, 4) < 0)\n\t\treturn 0;\n\treturn tep_read_number(pevent, &data, 4);\n}\n\nstatic unsigned long long read8(struct tep_handle *pevent)\n{\n\tunsigned long long data;\n\n\tif (do_read(&data, 8) < 0)\n\t\treturn 0;\n\treturn tep_read_number(pevent, &data, 8);\n}\n\nstatic char *read_string(void)\n{\n\tchar buf[BUFSIZ];\n\tchar *str = NULL;\n\tint size = 0;\n\toff_t r;\n\tchar c;\n\n\tfor (;;) {\n\t\tr = read(input_fd, &c, 1);\n\t\tif (r < 0) {\n\t\t\tpr_debug(\"reading input file\");\n\t\t\tgoto out;\n\t\t}\n\n\t\tif (!r) {\n\t\t\tpr_debug(\"no data\");\n\t\t\tgoto out;\n\t\t}\n\n\t\tif (repipe) {\n\t\t\tint retw = write(STDOUT_FILENO, &c, 1);\n\n\t\t\tif (retw <= 0 || retw != r) {\n\t\t\t\tpr_debug(\"repiping input file string\");\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\n\t\tbuf[size++] = c;\n\n\t\tif (!c)\n\t\t\tbreak;\n\t}\n\n\ttrace_data_size += size;\n\n\tstr = malloc(size);\n\tif (str)\n\t\tmemcpy(str, buf, size);\nout:\n\treturn str;\n}\n\nstatic int read_proc_kallsyms(struct tep_handle *pevent)\n{\n\tunsigned int size;\n\n\tsize = read4(pevent);\n\tif (!size)\n\t\treturn 0;\n\t \n\tlseek(input_fd, size, SEEK_CUR);\n\ttrace_data_size += size;\n\treturn 0;\n}\n\nstatic int read_ftrace_printk(struct tep_handle *pevent)\n{\n\tunsigned int size;\n\tchar *buf;\n\n\t \n\tsize = read4(pevent);\n\tif (!size)\n\t\treturn 0;\n\n\tbuf = malloc(size + 1);\n\tif (buf == NULL)\n\t\treturn -1;\n\n\tif (do_read(buf, size) < 0) {\n\t\tfree(buf);\n\t\treturn -1;\n\t}\n\n\tbuf[size] = '\\0';\n\n\tparse_ftrace_printk(pevent, buf, size);\n\n\tfree(buf);\n\treturn 0;\n}\n\nstatic int read_header_files(struct tep_handle *pevent)\n{\n\tunsigned long long size;\n\tchar *header_page;\n\tchar buf[BUFSIZ];\n\tint ret = 0;\n\n\tif (do_read(buf, 12) < 0)\n\t\treturn -1;\n\n\tif (memcmp(buf, \"header_page\", 12) != 0) {\n\t\tpr_debug(\"did not read header page\");\n\t\treturn -1;\n\t}\n\n\tsize = read8(pevent);\n\n\theader_page = malloc(size);\n\tif (header_page == NULL)\n\t\treturn -1;\n\n\tif (do_read(header_page, size) < 0) {\n\t\tpr_debug(\"did not read header page\");\n\t\tfree(header_page);\n\t\treturn -1;\n\t}\n\n\tif (!tep_parse_header_page(pevent, header_page, size,\n\t\t\t\t   tep_get_long_size(pevent))) {\n\t\t \n\t\ttep_set_long_size(pevent, tep_get_header_page_size(pevent));\n\t}\n\tfree(header_page);\n\n\tif (do_read(buf, 13) < 0)\n\t\treturn -1;\n\n\tif (memcmp(buf, \"header_event\", 13) != 0) {\n\t\tpr_debug(\"did not read header event\");\n\t\treturn -1;\n\t}\n\n\tsize = read8(pevent);\n\tskip(size);\n\n\treturn ret;\n}\n\nstatic int read_ftrace_file(struct tep_handle *pevent, unsigned long long size)\n{\n\tint ret;\n\tchar *buf;\n\n\tbuf = malloc(size);\n\tif (buf == NULL) {\n\t\tpr_debug(\"memory allocation failure\\n\");\n\t\treturn -1;\n\t}\n\n\tret = do_read(buf, size);\n\tif (ret < 0) {\n\t\tpr_debug(\"error reading ftrace file.\\n\");\n\t\tgoto out;\n\t}\n\n\tret = parse_ftrace_file(pevent, buf, size);\n\tif (ret < 0)\n\t\tpr_debug(\"error parsing ftrace file.\\n\");\nout:\n\tfree(buf);\n\treturn ret;\n}\n\nstatic int read_event_file(struct tep_handle *pevent, char *sys,\n\t\t\t   unsigned long long size)\n{\n\tint ret;\n\tchar *buf;\n\n\tbuf = malloc(size);\n\tif (buf == NULL) {\n\t\tpr_debug(\"memory allocation failure\\n\");\n\t\treturn -1;\n\t}\n\n\tret = do_read(buf, size);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = parse_event_file(pevent, buf, size, sys);\n\tif (ret < 0)\n\t\tpr_debug(\"error parsing event file.\\n\");\nout:\n\tfree(buf);\n\treturn ret;\n}\n\nstatic int read_ftrace_files(struct tep_handle *pevent)\n{\n\tunsigned long long size;\n\tint count;\n\tint i;\n\tint ret;\n\n\tcount = read4(pevent);\n\n\tfor (i = 0; i < count; i++) {\n\t\tsize = read8(pevent);\n\t\tret = read_ftrace_file(pevent, size);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int read_event_files(struct tep_handle *pevent)\n{\n\tunsigned long long size;\n\tchar *sys;\n\tint systems;\n\tint count;\n\tint i,x;\n\tint ret;\n\n\tsystems = read4(pevent);\n\n\tfor (i = 0; i < systems; i++) {\n\t\tsys = read_string();\n\t\tif (sys == NULL)\n\t\t\treturn -1;\n\n\t\tcount = read4(pevent);\n\n\t\tfor (x=0; x < count; x++) {\n\t\t\tsize = read8(pevent);\n\t\t\tret = read_event_file(pevent, sys, size);\n\t\t\tif (ret) {\n\t\t\t\tfree(sys);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t\tfree(sys);\n\t}\n\treturn 0;\n}\n\nstatic int read_saved_cmdline(struct tep_handle *pevent)\n{\n\tunsigned long long size;\n\tchar *buf;\n\tint ret;\n\n\t \n\tsize = read8(pevent);\n\tif (!size)\n\t\treturn 0;\n\n\tbuf = malloc(size + 1);\n\tif (buf == NULL) {\n\t\tpr_debug(\"memory allocation failure\\n\");\n\t\treturn -1;\n\t}\n\n\tret = do_read(buf, size);\n\tif (ret < 0) {\n\t\tpr_debug(\"error reading saved cmdlines\\n\");\n\t\tgoto out;\n\t}\n\tbuf[ret] = '\\0';\n\n\tparse_saved_cmdline(pevent, buf, size);\n\tret = 0;\nout:\n\tfree(buf);\n\treturn ret;\n}\n\nssize_t trace_report(int fd, struct trace_event *tevent, bool __repipe)\n{\n\tchar buf[BUFSIZ];\n\tchar test[] = { 23, 8, 68 };\n\tchar *version;\n\tint show_version = 0;\n\tint show_funcs = 0;\n\tint show_printk = 0;\n\tssize_t size = -1;\n\tint file_bigendian;\n\tint host_bigendian;\n\tint file_long_size;\n\tint file_page_size;\n\tstruct tep_handle *pevent = NULL;\n\tint err;\n\n\trepipe = __repipe;\n\tinput_fd = fd;\n\n\tif (do_read(buf, 3) < 0)\n\t\treturn -1;\n\tif (memcmp(buf, test, 3) != 0) {\n\t\tpr_debug(\"no trace data in the file\");\n\t\treturn -1;\n\t}\n\n\tif (do_read(buf, 7) < 0)\n\t\treturn -1;\n\tif (memcmp(buf, \"tracing\", 7) != 0) {\n\t\tpr_debug(\"not a trace file (missing 'tracing' tag)\");\n\t\treturn -1;\n\t}\n\n\tversion = read_string();\n\tif (version == NULL)\n\t\treturn -1;\n\tif (show_version)\n\t\tprintf(\"version = %s\\n\", version);\n\n\tif (do_read(buf, 1) < 0) {\n\t\tfree(version);\n\t\treturn -1;\n\t}\n\tfile_bigendian = buf[0];\n\thost_bigendian = host_is_bigendian() ? 1 : 0;\n\n\tif (trace_event__init(tevent)) {\n\t\tpr_debug(\"trace_event__init failed\");\n\t\tgoto out;\n\t}\n\n\tpevent = tevent->pevent;\n\n\ttep_set_flag(pevent, TEP_NSEC_OUTPUT);\n\ttep_set_file_bigendian(pevent, file_bigendian);\n\ttep_set_local_bigendian(pevent, host_bigendian);\n\n\tif (do_read(buf, 1) < 0)\n\t\tgoto out;\n\tfile_long_size = buf[0];\n\n\tfile_page_size = read4(pevent);\n\tif (!file_page_size)\n\t\tgoto out;\n\n\ttep_set_long_size(pevent, file_long_size);\n\ttep_set_page_size(pevent, file_page_size);\n\n\terr = read_header_files(pevent);\n\tif (err)\n\t\tgoto out;\n\terr = read_ftrace_files(pevent);\n\tif (err)\n\t\tgoto out;\n\terr = read_event_files(pevent);\n\tif (err)\n\t\tgoto out;\n\terr = read_proc_kallsyms(pevent);\n\tif (err)\n\t\tgoto out;\n\terr = read_ftrace_printk(pevent);\n\tif (err)\n\t\tgoto out;\n\tif (atof(version) >= 0.6) {\n\t\terr = read_saved_cmdline(pevent);\n\t\tif (err)\n\t\t\tgoto out;\n\t}\n\n\tsize = trace_data_size;\n\trepipe = false;\n\n\tif (show_funcs) {\n\t\ttep_print_funcs(pevent);\n\t} else if (show_printk) {\n\t\ttep_print_printk(pevent);\n\t}\n\n\tpevent = NULL;\n\nout:\n\tif (pevent)\n\t\ttrace_event__cleanup(tevent);\n\tfree(version);\n\treturn size;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}