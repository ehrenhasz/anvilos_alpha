{
  "module_name": "stream.c",
  "hash_id": "6e882ea013ac971de5cde4838a587ff906e5c16001ca181592d4e04c5ac91eb1",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/stream.c",
  "human_readable_source": "\n \n\n#include <inttypes.h>\n#include <stdlib.h>\n#include <linux/zalloc.h>\n#include \"debug.h\"\n#include \"hist.h\"\n#include \"sort.h\"\n#include \"stream.h\"\n#include \"evlist.h\"\n\nstatic void evsel_streams__delete(struct evsel_streams *es, int nr_evsel)\n{\n\tfor (int i = 0; i < nr_evsel; i++)\n\t\tzfree(&es[i].streams);\n\n\tfree(es);\n}\n\nvoid evlist_streams__delete(struct evlist_streams *els)\n{\n\tevsel_streams__delete(els->ev_streams, els->nr_evsel);\n\tfree(els);\n}\n\nstatic struct evlist_streams *evlist_streams__new(int nr_evsel,\n\t\t\t\t\t\t  int nr_streams_max)\n{\n\tstruct evlist_streams *els;\n\tstruct evsel_streams *es;\n\n\tels = zalloc(sizeof(*els));\n\tif (!els)\n\t\treturn NULL;\n\n\tes = calloc(nr_evsel, sizeof(struct evsel_streams));\n\tif (!es) {\n\t\tfree(els);\n\t\treturn NULL;\n\t}\n\n\tfor (int i = 0; i < nr_evsel; i++) {\n\t\tstruct evsel_streams *s = &es[i];\n\n\t\ts->streams = calloc(nr_streams_max, sizeof(struct stream));\n\t\tif (!s->streams)\n\t\t\tgoto err;\n\n\t\ts->nr_streams_max = nr_streams_max;\n\t\ts->evsel_idx = -1;\n\t}\n\n\tels->ev_streams = es;\n\tels->nr_evsel = nr_evsel;\n\treturn els;\n\nerr:\n\tevsel_streams__delete(es, nr_evsel);\n\treturn NULL;\n}\n\n \nstatic void evsel_streams__set_hot_cnode(struct evsel_streams *es,\n\t\t\t\t\t struct callchain_node *cnode)\n{\n\tint i, idx = 0;\n\tu64 hit;\n\n\tif (es->nr_streams < es->nr_streams_max) {\n\t\ti = es->nr_streams;\n\t\tes->streams[i].cnode = cnode;\n\t\tes->nr_streams++;\n\t\treturn;\n\t}\n\n\t \n\thit = (es->streams[0].cnode)->hit;\n\tfor (i = 1; i < es->nr_streams; i++) {\n\t\tif ((es->streams[i].cnode)->hit < hit) {\n\t\t\thit = (es->streams[i].cnode)->hit;\n\t\t\tidx = i;\n\t\t}\n\t}\n\n\tif (cnode->hit > hit)\n\t\tes->streams[idx].cnode = cnode;\n}\n\nstatic void update_hot_callchain(struct hist_entry *he,\n\t\t\t\t struct evsel_streams *es)\n{\n\tstruct rb_root *root = &he->sorted_chain;\n\tstruct rb_node *rb_node = rb_first(root);\n\tstruct callchain_node *cnode;\n\n\twhile (rb_node) {\n\t\tcnode = rb_entry(rb_node, struct callchain_node, rb_node);\n\t\tevsel_streams__set_hot_cnode(es, cnode);\n\t\trb_node = rb_next(rb_node);\n\t}\n}\n\nstatic void init_hot_callchain(struct hists *hists, struct evsel_streams *es)\n{\n\tstruct rb_node *next = rb_first_cached(&hists->entries);\n\n\twhile (next) {\n\t\tstruct hist_entry *he;\n\n\t\the = rb_entry(next, struct hist_entry, rb_node);\n\t\tupdate_hot_callchain(he, es);\n\t\tnext = rb_next(&he->rb_node);\n\t}\n\n\tes->streams_hits = callchain_total_hits(hists);\n}\n\nstatic int evlist__init_callchain_streams(struct evlist *evlist,\n\t\t\t\t\t  struct evlist_streams *els)\n{\n\tstruct evsel_streams *es = els->ev_streams;\n\tstruct evsel *pos;\n\tint i = 0;\n\n\tBUG_ON(els->nr_evsel < evlist->core.nr_entries);\n\n\tevlist__for_each_entry(evlist, pos) {\n\t\tstruct hists *hists = evsel__hists(pos);\n\n\t\thists__output_resort(hists, NULL);\n\t\tinit_hot_callchain(hists, &es[i]);\n\t\tes[i].evsel_idx = pos->core.idx;\n\t\ti++;\n\t}\n\n\treturn 0;\n}\n\nstruct evlist_streams *evlist__create_streams(struct evlist *evlist,\n\t\t\t\t\t      int nr_streams_max)\n{\n\tint nr_evsel = evlist->core.nr_entries, ret = -1;\n\tstruct evlist_streams *els = evlist_streams__new(nr_evsel,\n\t\t\t\t\t\t\t nr_streams_max);\n\n\tif (!els)\n\t\treturn NULL;\n\n\tret = evlist__init_callchain_streams(evlist, els);\n\tif (ret) {\n\t\tevlist_streams__delete(els);\n\t\treturn NULL;\n\t}\n\n\treturn els;\n}\n\nstruct evsel_streams *evsel_streams__entry(struct evlist_streams *els,\n\t\t\t\t\t   int evsel_idx)\n{\n\tstruct evsel_streams *es = els->ev_streams;\n\n\tfor (int i = 0; i < els->nr_evsel; i++) {\n\t\tif (es[i].evsel_idx == evsel_idx)\n\t\t\treturn &es[i];\n\t}\n\n\treturn NULL;\n}\n\nstatic struct stream *stream__callchain_match(struct stream *base_stream,\n\t\t\t\t\t      struct evsel_streams *es_pair)\n{\n\tfor (int i = 0; i < es_pair->nr_streams; i++) {\n\t\tstruct stream *pair_stream = &es_pair->streams[i];\n\n\t\tif (callchain_cnode_matched(base_stream->cnode,\n\t\t\t\t\t    pair_stream->cnode)) {\n\t\t\treturn pair_stream;\n\t\t}\n\t}\n\n\treturn NULL;\n}\n\nstatic struct stream *stream__match(struct stream *base_stream,\n\t\t\t\t    struct evsel_streams *es_pair)\n{\n\treturn stream__callchain_match(base_stream, es_pair);\n}\n\nstatic void stream__link(struct stream *base_stream, struct stream *pair_stream)\n{\n\tbase_stream->pair_cnode = pair_stream->cnode;\n\tpair_stream->pair_cnode = base_stream->cnode;\n}\n\nvoid evsel_streams__match(struct evsel_streams *es_base,\n\t\t\t  struct evsel_streams *es_pair)\n{\n\tfor (int i = 0; i < es_base->nr_streams; i++) {\n\t\tstruct stream *base_stream = &es_base->streams[i];\n\t\tstruct stream *pair_stream;\n\n\t\tpair_stream = stream__match(base_stream, es_pair);\n\t\tif (pair_stream)\n\t\t\tstream__link(base_stream, pair_stream);\n\t}\n}\n\nstatic void print_callchain_pair(struct stream *base_stream, int idx,\n\t\t\t\t struct evsel_streams *es_base,\n\t\t\t\t struct evsel_streams *es_pair)\n{\n\tstruct callchain_node *base_cnode = base_stream->cnode;\n\tstruct callchain_node *pair_cnode = base_stream->pair_cnode;\n\tstruct callchain_list *base_chain, *pair_chain;\n\tchar buf1[512], buf2[512], cbuf1[256], cbuf2[256];\n\tchar *s1, *s2;\n\tdouble pct;\n\n\tprintf(\"\\nhot chain pair %d:\\n\", idx);\n\n\tpct = (double)base_cnode->hit / (double)es_base->streams_hits;\n\tscnprintf(buf1, sizeof(buf1), \"cycles: %ld, hits: %.2f%%\",\n\t\t  callchain_avg_cycles(base_cnode), pct * 100.0);\n\n\tpct = (double)pair_cnode->hit / (double)es_pair->streams_hits;\n\tscnprintf(buf2, sizeof(buf2), \"cycles: %ld, hits: %.2f%%\",\n\t\t  callchain_avg_cycles(pair_cnode), pct * 100.0);\n\n\tprintf(\"%35s\\t%35s\\n\", buf1, buf2);\n\n\tprintf(\"%35s\\t%35s\\n\",\n\t       \"---------------------------\",\n\t       \"--------------------------\");\n\n\tpair_chain = list_first_entry(&pair_cnode->val,\n\t\t\t\t      struct callchain_list,\n\t\t\t\t      list);\n\n\tlist_for_each_entry(base_chain, &base_cnode->val, list) {\n\t\tif (&pair_chain->list == &pair_cnode->val)\n\t\t\treturn;\n\n\t\ts1 = callchain_list__sym_name(base_chain, cbuf1, sizeof(cbuf1),\n\t\t\t\t\t      false);\n\t\ts2 = callchain_list__sym_name(pair_chain, cbuf2, sizeof(cbuf2),\n\t\t\t\t\t      false);\n\n\t\tscnprintf(buf1, sizeof(buf1), \"%35s\\t%35s\", s1, s2);\n\t\tprintf(\"%s\\n\", buf1);\n\t\tpair_chain = list_next_entry(pair_chain, list);\n\t}\n}\n\nstatic void print_stream_callchain(struct stream *stream, int idx,\n\t\t\t\t   struct evsel_streams *es, bool pair)\n{\n\tstruct callchain_node *cnode = stream->cnode;\n\tstruct callchain_list *chain;\n\tchar buf[512], cbuf[256], *s;\n\tdouble pct;\n\n\tprintf(\"\\nhot chain %d:\\n\", idx);\n\n\tpct = (double)cnode->hit / (double)es->streams_hits;\n\tscnprintf(buf, sizeof(buf), \"cycles: %ld, hits: %.2f%%\",\n\t\t  callchain_avg_cycles(cnode), pct * 100.0);\n\n\tif (pair) {\n\t\tprintf(\"%35s\\t%35s\\n\", \"\", buf);\n\t\tprintf(\"%35s\\t%35s\\n\",\n\t\t       \"\", \"--------------------------\");\n\t} else {\n\t\tprintf(\"%35s\\n\", buf);\n\t\tprintf(\"%35s\\n\", \"--------------------------\");\n\t}\n\n\tlist_for_each_entry(chain, &cnode->val, list) {\n\t\ts = callchain_list__sym_name(chain, cbuf, sizeof(cbuf), false);\n\n\t\tif (pair)\n\t\t\tscnprintf(buf, sizeof(buf), \"%35s\\t%35s\", \"\", s);\n\t\telse\n\t\t\tscnprintf(buf, sizeof(buf), \"%35s\", s);\n\n\t\tprintf(\"%s\\n\", buf);\n\t}\n}\n\nstatic void callchain_streams_report(struct evsel_streams *es_base,\n\t\t\t\t     struct evsel_streams *es_pair)\n{\n\tstruct stream *base_stream;\n\tint i, idx = 0;\n\n\tprintf(\"[ Matched hot streams ]\\n\");\n\tfor (i = 0; i < es_base->nr_streams; i++) {\n\t\tbase_stream = &es_base->streams[i];\n\t\tif (base_stream->pair_cnode) {\n\t\t\tprint_callchain_pair(base_stream, ++idx,\n\t\t\t\t\t     es_base, es_pair);\n\t\t}\n\t}\n\n\tidx = 0;\n\tprintf(\"\\n[ Hot streams in old perf data only ]\\n\");\n\tfor (i = 0; i < es_base->nr_streams; i++) {\n\t\tbase_stream = &es_base->streams[i];\n\t\tif (!base_stream->pair_cnode) {\n\t\t\tprint_stream_callchain(base_stream, ++idx,\n\t\t\t\t\t       es_base, false);\n\t\t}\n\t}\n\n\tidx = 0;\n\tprintf(\"\\n[ Hot streams in new perf data only ]\\n\");\n\tfor (i = 0; i < es_pair->nr_streams; i++) {\n\t\tbase_stream = &es_pair->streams[i];\n\t\tif (!base_stream->pair_cnode) {\n\t\t\tprint_stream_callchain(base_stream, ++idx,\n\t\t\t\t\t       es_pair, true);\n\t\t}\n\t}\n}\n\nvoid evsel_streams__report(struct evsel_streams *es_base,\n\t\t\t   struct evsel_streams *es_pair)\n{\n\treturn callchain_streams_report(es_base, es_pair);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}