{
  "module_name": "cloexec.c",
  "hash_id": "004b736becb03816fbe32dde05d3e7cb3a49a9582cdb214d8058b489c78fa69e",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/cloexec.c",
  "human_readable_source": "\n#include <errno.h>\n#include <sched.h>\n#include \"util.h\" \n#include \"../perf-sys.h\"\n#include \"cloexec.h\"\n#include \"event.h\"\n#include \"asm/bug.h\"\n#include \"debug.h\"\n#include <unistd.h>\n#include <sys/syscall.h>\n#include <linux/string.h>\n\nstatic unsigned long flag = PERF_FLAG_FD_CLOEXEC;\n\nstatic int perf_flag_probe(void)\n{\n\t \n\tstruct perf_event_attr attr = {\n\t\t.type = PERF_TYPE_SOFTWARE,\n\t\t.config = PERF_COUNT_SW_CPU_CLOCK,\n\t\t.exclude_kernel = 1,\n\t};\n\tint fd;\n\tint err;\n\tint cpu;\n\tpid_t pid = -1;\n\tchar sbuf[STRERR_BUFSIZE];\n\n\tcpu = sched_getcpu();\n\tif (cpu < 0)\n\t\tcpu = 0;\n\n\t \n\twhile (1) {\n\t\t \n\t\tfd = sys_perf_event_open(&attr, pid, cpu, -1,\n\t\t\t\t\t PERF_FLAG_FD_CLOEXEC);\n\t\tif (fd < 0 && pid == -1 && errno == EACCES) {\n\t\t\tpid = 0;\n\t\t\tcontinue;\n\t\t}\n\t\tbreak;\n\t}\n\terr = errno;\n\n\tif (fd >= 0) {\n\t\tclose(fd);\n\t\treturn 1;\n\t}\n\n\tWARN_ONCE(err != EINVAL && err != EBUSY && err != EACCES,\n\t\t  \"perf_event_open(..., PERF_FLAG_FD_CLOEXEC) failed with unexpected error %d (%s)\\n\",\n\t\t  err, str_error_r(err, sbuf, sizeof(sbuf)));\n\n\t \n\twhile (1) {\n\t\tfd = sys_perf_event_open(&attr, pid, cpu, -1, 0);\n\t\tif (fd < 0 && pid == -1 && errno == EACCES) {\n\t\t\tpid = 0;\n\t\t\tcontinue;\n\t\t}\n\t\tbreak;\n\t}\n\terr = errno;\n\n\tif (fd >= 0)\n\t\tclose(fd);\n\n\tif (WARN_ONCE(fd < 0 && err != EBUSY && err != EACCES,\n\t\t      \"perf_event_open(..., 0) failed unexpectedly with error %d (%s)\\n\",\n\t\t      err, str_error_r(err, sbuf, sizeof(sbuf))))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nunsigned long perf_event_open_cloexec_flag(void)\n{\n\tstatic bool probed;\n\n\tif (!probed) {\n\t\tif (perf_flag_probe() <= 0)\n\t\t\tflag = 0;\n\t\tprobed = true;\n\t}\n\n\treturn flag;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}