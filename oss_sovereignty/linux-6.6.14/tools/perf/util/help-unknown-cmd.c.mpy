{
  "module_name": "help-unknown-cmd.c",
  "hash_id": "7054a4da92330197b2e363bd5d43597ab34208c788f73b9894f888cffeb812e3",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/help-unknown-cmd.c",
  "human_readable_source": "\n#include \"cache.h\"\n#include \"config.h\"\n#include <poll.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <subcmd/help.h>\n#include \"../builtin.h\"\n#include \"levenshtein.h\"\n#include <linux/zalloc.h>\n\nstatic int autocorrect;\n\nstatic int perf_unknown_cmd_config(const char *var, const char *value,\n\t\t\t\t   void *cb __maybe_unused)\n{\n\tif (!strcmp(var, \"help.autocorrect\"))\n\t\treturn perf_config_int(&autocorrect, var,value);\n\n\treturn 0;\n}\n\nstatic int levenshtein_compare(const void *p1, const void *p2)\n{\n\tconst struct cmdname *const *c1 = p1, *const *c2 = p2;\n\tconst char *s1 = (*c1)->name, *s2 = (*c2)->name;\n\tint l1 = (*c1)->len;\n\tint l2 = (*c2)->len;\n\treturn l1 != l2 ? l1 - l2 : strcmp(s1, s2);\n}\n\nstatic int add_cmd_list(struct cmdnames *cmds, struct cmdnames *old)\n{\n\tunsigned int i, nr = cmds->cnt + old->cnt;\n\tvoid *tmp;\n\n\tif (nr > cmds->alloc) {\n\t\t \n\t\tif (alloc_nr(cmds->alloc) < nr)\n\t\t\tcmds->alloc = nr;\n\t\telse\n\t\t\tcmds->alloc = alloc_nr(cmds->alloc);\n\t\ttmp = realloc(cmds->names, cmds->alloc * sizeof(*cmds->names));\n\t\tif (!tmp)\n\t\t\treturn -1;\n\t\tcmds->names = tmp;\n\t}\n\tfor (i = 0; i < old->cnt; i++)\n\t\tcmds->names[cmds->cnt++] = old->names[i];\n\tzfree(&old->names);\n\told->cnt = 0;\n\treturn 0;\n}\n\nconst char *help_unknown_cmd(const char *cmd)\n{\n\tunsigned int i, n = 0, best_similarity = 0;\n\tstruct cmdnames main_cmds, other_cmds;\n\n\tmemset(&main_cmds, 0, sizeof(main_cmds));\n\tmemset(&other_cmds, 0, sizeof(main_cmds));\n\n\tperf_config(perf_unknown_cmd_config, NULL);\n\n\tload_command_list(\"perf-\", &main_cmds, &other_cmds);\n\n\tif (add_cmd_list(&main_cmds, &other_cmds) < 0) {\n\t\tfprintf(stderr, \"ERROR: Failed to allocate command list for unknown command.\\n\");\n\t\tgoto end;\n\t}\n\tqsort(main_cmds.names, main_cmds.cnt,\n\t      sizeof(main_cmds.names), cmdname_compare);\n\tuniq(&main_cmds);\n\n\tif (main_cmds.cnt) {\n\t\t \n\t\tfor (i = 0; i < main_cmds.cnt; ++i)\n\t\t\tmain_cmds.names[i]->len =\n\t\t\t\tlevenshtein(cmd, main_cmds.names[i]->name, 0, 2, 1, 4);\n\n\t\tqsort(main_cmds.names, main_cmds.cnt,\n\t\t      sizeof(*main_cmds.names), levenshtein_compare);\n\n\t\tbest_similarity = main_cmds.names[0]->len;\n\t\tn = 1;\n\t\twhile (n < main_cmds.cnt && best_similarity == main_cmds.names[n]->len)\n\t\t\t++n;\n\t}\n\n\tif (autocorrect && n == 1) {\n\t\tconst char *assumed = main_cmds.names[0]->name;\n\n\t\tmain_cmds.names[0] = NULL;\n\t\tclean_cmdnames(&main_cmds);\n\t\tclean_cmdnames(&other_cmds);\n\t\tfprintf(stderr, \"WARNING: You called a perf program named '%s', \"\n\t\t\t\"which does not exist.\\n\"\n\t\t\t\"Continuing under the assumption that you meant '%s'\\n\",\n\t\t\tcmd, assumed);\n\t\tif (autocorrect > 0) {\n\t\t\tfprintf(stderr, \"in %0.1f seconds automatically...\\n\",\n\t\t\t\t(float)autocorrect/10.0);\n\t\t\tpoll(NULL, 0, autocorrect * 100);\n\t\t}\n\t\treturn assumed;\n\t}\n\n\tfprintf(stderr, \"perf: '%s' is not a perf-command. See 'perf --help'.\\n\", cmd);\n\n\tif (main_cmds.cnt && best_similarity < 6) {\n\t\tfprintf(stderr, \"\\nDid you mean %s?\\n\",\n\t\t\tn < 2 ? \"this\": \"one of these\");\n\n\t\tfor (i = 0; i < n; i++)\n\t\t\tfprintf(stderr, \"\\t%s\\n\", main_cmds.names[i]->name);\n\t}\nend:\n\tclean_cmdnames(&main_cmds);\n\tclean_cmdnames(&other_cmds);\n\texit(1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}