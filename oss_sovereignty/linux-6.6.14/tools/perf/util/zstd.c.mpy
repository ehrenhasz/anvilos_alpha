{
  "module_name": "zstd.c",
  "hash_id": "eeb80d9e93624b657094c183b4d08326a5521020829ee8c2305acf1ae5dcf315",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/zstd.c",
  "human_readable_source": "\n\n#include <string.h>\n\n#include \"util/compress.h\"\n#include \"util/debug.h\"\n\nint zstd_init(struct zstd_data *data, int level)\n{\n\tsize_t ret;\n\n\tdata->dstream = ZSTD_createDStream();\n\tif (data->dstream == NULL) {\n\t\tpr_err(\"Couldn't create decompression stream.\\n\");\n\t\treturn -1;\n\t}\n\n\tret = ZSTD_initDStream(data->dstream);\n\tif (ZSTD_isError(ret)) {\n\t\tpr_err(\"Failed to initialize decompression stream: %s\\n\", ZSTD_getErrorName(ret));\n\t\treturn -1;\n\t}\n\n\tif (!level)\n\t\treturn 0;\n\n\tdata->cstream = ZSTD_createCStream();\n\tif (data->cstream == NULL) {\n\t\tpr_err(\"Couldn't create compression stream.\\n\");\n\t\treturn -1;\n\t}\n\n\tret = ZSTD_initCStream(data->cstream, level);\n\tif (ZSTD_isError(ret)) {\n\t\tpr_err(\"Failed to initialize compression stream: %s\\n\", ZSTD_getErrorName(ret));\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nint zstd_fini(struct zstd_data *data)\n{\n\tif (data->dstream) {\n\t\tZSTD_freeDStream(data->dstream);\n\t\tdata->dstream = NULL;\n\t}\n\n\tif (data->cstream) {\n\t\tZSTD_freeCStream(data->cstream);\n\t\tdata->cstream = NULL;\n\t}\n\n\treturn 0;\n}\n\nsize_t zstd_compress_stream_to_records(struct zstd_data *data, void *dst, size_t dst_size,\n\t\t\t\t       void *src, size_t src_size, size_t max_record_size,\n\t\t\t\t       size_t process_header(void *record, size_t increment))\n{\n\tsize_t ret, size, compressed = 0;\n\tZSTD_inBuffer input = { src, src_size, 0 };\n\tZSTD_outBuffer output;\n\tvoid *record;\n\n\twhile (input.pos < input.size) {\n\t\trecord = dst;\n\t\tsize = process_header(record, 0);\n\t\tcompressed += size;\n\t\tdst += size;\n\t\tdst_size -= size;\n\t\toutput = (ZSTD_outBuffer){ dst, (dst_size > max_record_size) ?\n\t\t\t\t\t\tmax_record_size : dst_size, 0 };\n\t\tret = ZSTD_compressStream(data->cstream, &output, &input);\n\t\tZSTD_flushStream(data->cstream, &output);\n\t\tif (ZSTD_isError(ret)) {\n\t\t\tpr_err(\"failed to compress %ld bytes: %s\\n\",\n\t\t\t\t(long)src_size, ZSTD_getErrorName(ret));\n\t\t\tmemcpy(dst, src, src_size);\n\t\t\treturn src_size;\n\t\t}\n\t\tsize = output.pos;\n\t\tsize = process_header(record, size);\n\t\tcompressed += size;\n\t\tdst += size;\n\t\tdst_size -= size;\n\t}\n\n\treturn compressed;\n}\n\nsize_t zstd_decompress_stream(struct zstd_data *data, void *src, size_t src_size,\n\t\t\t      void *dst, size_t dst_size)\n{\n\tsize_t ret;\n\tZSTD_inBuffer input = { src, src_size, 0 };\n\tZSTD_outBuffer output = { dst, dst_size, 0 };\n\n\twhile (input.pos < input.size) {\n\t\tret = ZSTD_decompressStream(data->dstream, &output, &input);\n\t\tif (ZSTD_isError(ret)) {\n\t\t\tpr_err(\"failed to decompress (B): %zd -> %zd, dst_size %zd : %s\\n\",\n\t\t\t       src_size, output.size, dst_size, ZSTD_getErrorName(ret));\n\t\t\tbreak;\n\t\t}\n\t\toutput.dst  = dst + output.pos;\n\t\toutput.size = dst_size - output.pos;\n\t}\n\n\treturn output.pos;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}