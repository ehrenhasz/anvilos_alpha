{
  "module_name": "cs-etm-base.c",
  "hash_id": "df062cd505fd1f7fab2d233139b58e07c08a147f4e22d4fe3b4724d08c1e5f60",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/cs-etm-base.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <inttypes.h>\n\n#include \"cs-etm.h\"\n\nstatic const char * const cs_etm_global_header_fmts[] = {\n\t[CS_HEADER_VERSION]\t= \"\tHeader version\t\t       %llx\\n\",\n\t[CS_PMU_TYPE_CPUS]\t= \"\tPMU type/num cpus\t       %llx\\n\",\n\t[CS_ETM_SNAPSHOT]\t= \"\tSnapshot\t\t       %llx\\n\",\n};\n\nstatic const char * const cs_etm_priv_fmts[] = {\n\t[CS_ETM_MAGIC]\t\t= \"\tMagic number\t\t       %llx\\n\",\n\t[CS_ETM_CPU]\t\t= \"\tCPU\t\t\t       %lld\\n\",\n\t[CS_ETM_NR_TRC_PARAMS]\t= \"\tNR_TRC_PARAMS\t\t       %llx\\n\",\n\t[CS_ETM_ETMCR]\t\t= \"\tETMCR\t\t\t       %llx\\n\",\n\t[CS_ETM_ETMTRACEIDR]\t= \"\tETMTRACEIDR\t\t       %llx\\n\",\n\t[CS_ETM_ETMCCER]\t= \"\tETMCCER\t\t\t       %llx\\n\",\n\t[CS_ETM_ETMIDR]\t\t= \"\tETMIDR\t\t\t       %llx\\n\",\n};\n\nstatic const char * const cs_etmv4_priv_fmts[] = {\n\t[CS_ETM_MAGIC]\t\t= \"\tMagic number\t\t       %llx\\n\",\n\t[CS_ETM_CPU]\t\t= \"\tCPU\t\t\t       %lld\\n\",\n\t[CS_ETM_NR_TRC_PARAMS]\t= \"\tNR_TRC_PARAMS\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCCONFIGR]\t= \"\tTRCCONFIGR\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCTRACEIDR]\t= \"\tTRCTRACEIDR\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCIDR0]\t= \"\tTRCIDR0\t\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCIDR1]\t= \"\tTRCIDR1\t\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCIDR2]\t= \"\tTRCIDR2\t\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCIDR8]\t= \"\tTRCIDR8\t\t\t       %llx\\n\",\n\t[CS_ETMV4_TRCAUTHSTATUS] = \"\tTRCAUTHSTATUS\t\t       %llx\\n\",\n\t[CS_ETMV4_TS_SOURCE]\t= \"\tTS_SOURCE\t\t       %lld\\n\",\n};\n\nstatic const char * const cs_ete_priv_fmts[] = {\n\t[CS_ETM_MAGIC]\t\t= \"\tMagic number\t\t       %llx\\n\",\n\t[CS_ETM_CPU]\t\t= \"\tCPU\t\t\t       %lld\\n\",\n\t[CS_ETM_NR_TRC_PARAMS]\t= \"\tNR_TRC_PARAMS\t\t       %llx\\n\",\n\t[CS_ETE_TRCCONFIGR]\t= \"\tTRCCONFIGR\t\t       %llx\\n\",\n\t[CS_ETE_TRCTRACEIDR]\t= \"\tTRCTRACEIDR\t\t       %llx\\n\",\n\t[CS_ETE_TRCIDR0]\t= \"\tTRCIDR0\t\t\t       %llx\\n\",\n\t[CS_ETE_TRCIDR1]\t= \"\tTRCIDR1\t\t\t       %llx\\n\",\n\t[CS_ETE_TRCIDR2]\t= \"\tTRCIDR2\t\t\t       %llx\\n\",\n\t[CS_ETE_TRCIDR8]\t= \"\tTRCIDR8\t\t\t       %llx\\n\",\n\t[CS_ETE_TRCAUTHSTATUS]\t= \"\tTRCAUTHSTATUS\t\t       %llx\\n\",\n\t[CS_ETE_TRCDEVARCH]\t= \"\tTRCDEVARCH                     %llx\\n\",\n\t[CS_ETE_TS_SOURCE]\t= \"\tTS_SOURCE                      %lld\\n\",\n};\n\nstatic const char * const param_unk_fmt =\n\t\"\tUnknown parameter [%d]\t       %\"PRIx64\"\\n\";\nstatic const char * const magic_unk_fmt =\n\t\"\tMagic number Unknown\t       %\"PRIx64\"\\n\";\n\nstatic int cs_etm__print_cpu_metadata_v0(u64 *val, int *offset)\n{\n\tint i = *offset, j, nr_params = 0, fmt_offset;\n\tu64 magic;\n\n\t \n\tmagic = val[i + CS_ETM_MAGIC];\n\tif ((magic != __perf_cs_etmv3_magic) &&\n\t    (magic != __perf_cs_etmv4_magic)) {\n\t\t \n\t\tfprintf(stdout, magic_unk_fmt, magic);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tfprintf(stdout, cs_etm_priv_fmts[CS_ETM_MAGIC], val[i++]);\n\tfprintf(stdout, cs_etm_priv_fmts[CS_ETM_CPU], val[i++]);\n\n\tif (magic == __perf_cs_etmv3_magic) {\n\t\tnr_params = CS_ETM_NR_TRC_PARAMS_V0;\n\t\tfmt_offset = CS_ETM_ETMCR;\n\t\t \n\t\tfor (j = fmt_offset; j < nr_params + fmt_offset; j++, i++)\n\t\t\tfprintf(stdout, cs_etm_priv_fmts[j], val[i]);\n\t} else if (magic == __perf_cs_etmv4_magic) {\n\t\tnr_params = CS_ETMV4_NR_TRC_PARAMS_V0;\n\t\tfmt_offset = CS_ETMV4_TRCCONFIGR;\n\t\t \n\t\tfor (j = fmt_offset; j < nr_params + fmt_offset; j++, i++)\n\t\t\tfprintf(stdout, cs_etmv4_priv_fmts[j], val[i]);\n\t}\n\t*offset = i;\n\treturn 0;\n}\n\nstatic int cs_etm__print_cpu_metadata_v1(u64 *val, int *offset)\n{\n\tint i = *offset, j, total_params = 0;\n\tu64 magic;\n\n\tmagic = val[i + CS_ETM_MAGIC];\n\t \n\ttotal_params = val[i + CS_ETM_NR_TRC_PARAMS] + CS_ETM_COMMON_BLK_MAX_V1;\n\n\tif (magic == __perf_cs_etmv3_magic) {\n\t\tfor (j = 0; j < total_params; j++, i++) {\n\t\t\t \n\t\t\tif (j >= CS_ETM_PRIV_MAX)\n\t\t\t\tfprintf(stdout, param_unk_fmt, j, val[i]);\n\t\t\telse\n\t\t\t\tfprintf(stdout, cs_etm_priv_fmts[j], val[i]);\n\t\t}\n\t} else if (magic == __perf_cs_etmv4_magic) {\n\t\tfor (j = 0; j < total_params; j++, i++) {\n\t\t\t \n\t\t\tif (j >= CS_ETMV4_PRIV_MAX)\n\t\t\t\tfprintf(stdout, param_unk_fmt, j, val[i]);\n\t\t\telse\n\t\t\t\tfprintf(stdout, cs_etmv4_priv_fmts[j], val[i]);\n\t\t}\n\t} else if (magic == __perf_cs_ete_magic) {\n\t\tfor (j = 0; j < total_params; j++, i++) {\n\t\t\t \n\t\t\tif (j >= CS_ETE_PRIV_MAX)\n\t\t\t\tfprintf(stdout, param_unk_fmt, j, val[i]);\n\t\t\telse\n\t\t\t\tfprintf(stdout, cs_ete_priv_fmts[j], val[i]);\n\t\t}\n\t} else {\n\t\t \n\t\tfprintf(stdout, magic_unk_fmt, magic);\n\t\treturn -EINVAL;\n\t}\n\t*offset = i;\n\treturn 0;\n}\n\nstatic void cs_etm__print_auxtrace_info(u64 *val, int num)\n{\n\tint i, cpu = 0, version, err;\n\n\tversion = val[0];\n\n\tfor (i = 0; i < CS_HEADER_VERSION_MAX; i++)\n\t\tfprintf(stdout, cs_etm_global_header_fmts[i], val[i]);\n\n\tfor (i = CS_HEADER_VERSION_MAX; cpu < num; cpu++) {\n\t\tif (version == 0)\n\t\t\terr = cs_etm__print_cpu_metadata_v0(val, &i);\n\t\t \n\t\telse if ((version == 1) || (version == 2))\n\t\t\terr = cs_etm__print_cpu_metadata_v1(val, &i);\n\t\tif (err)\n\t\t\treturn;\n\t}\n}\n\n \nint cs_etm__process_auxtrace_info(union perf_event *event,\n\t\t\t\t  struct perf_session *session)\n{\n\tstruct perf_record_auxtrace_info *auxtrace_info = &event->auxtrace_info;\n\tint event_header_size = sizeof(struct perf_event_header);\n\tint num_cpu;\n\tu64 *ptr = NULL;\n\tu64 hdr_version;\n\n\tif (auxtrace_info->header.size < (event_header_size + INFO_HEADER_SIZE))\n\t\treturn -EINVAL;\n\n\t \n\tptr = (u64 *) auxtrace_info->priv;\n\n\t \n\thdr_version = ptr[0];\n\tif (hdr_version > CS_HEADER_CURRENT_VERSION) {\n\t\tpr_err(\"\\nCS ETM Trace: Unknown Header Version = %#\" PRIx64, hdr_version);\n\t\tpr_err(\", version supported <= %x\\n\", CS_HEADER_CURRENT_VERSION);\n\t\treturn -EINVAL;\n\t}\n\n\tif (dump_trace) {\n\t\tnum_cpu = ptr[CS_PMU_TYPE_CPUS] & 0xffffffff;\n\t\tcs_etm__print_auxtrace_info(ptr, num_cpu);\n\t}\n\n\treturn cs_etm__process_auxtrace_info_full(event, session);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}