{
  "module_name": "setup.py",
  "hash_id": "d4e6a22827d7af43967821534fdc734d5a946aedafb3d38fc9f26eff2ae99387",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/setup.py",
  "human_readable_source": "from os import getenv, path\nfrom subprocess import Popen, PIPE\nfrom re import sub\n\ncc = getenv(\"CC\")\n\n# Check if CC has options, as is the case in yocto, where it uses CC=\"cc --sysroot...\"\ncc_tokens = cc.split()\nif len(cc_tokens) > 1:\n    cc = cc_tokens[0]\n    cc_options = \" \".join([str(e) for e in cc_tokens[1:]]) + \" \"\nelse:\n    cc_options = \"\"\n\ncc_is_clang = b\"clang version\" in Popen([cc, \"-v\"], stderr=PIPE).stderr.readline()\nsrc_feature_tests  = getenv('srctree') + '/tools/build/feature'\n\ndef clang_has_option(option):\n    cc_output = Popen([cc, cc_options + option, path.join(src_feature_tests, \"test-hello.c\") ], stderr=PIPE).stderr.readlines()\n    return [o for o in cc_output if ((b\"unknown argument\" in o) or (b\"is not supported\" in o))] == [ ]\n\nif cc_is_clang:\n    from sysconfig import get_config_vars\n    vars = get_config_vars()\n    for var in ('CFLAGS', 'OPT'):\n        vars[var] = sub(\"-specs=[^ ]+\", \"\", vars[var])\n        if not clang_has_option(\"-mcet\"):\n            vars[var] = sub(\"-mcet\", \"\", vars[var])\n        if not clang_has_option(\"-fcf-protection\"):\n            vars[var] = sub(\"-fcf-protection\", \"\", vars[var])\n        if not clang_has_option(\"-fstack-clash-protection\"):\n            vars[var] = sub(\"-fstack-clash-protection\", \"\", vars[var])\n        if not clang_has_option(\"-fstack-protector-strong\"):\n            vars[var] = sub(\"-fstack-protector-strong\", \"\", vars[var])\n        if not clang_has_option(\"-fno-semantic-interposition\"):\n            vars[var] = sub(\"-fno-semantic-interposition\", \"\", vars[var])\n        if not clang_has_option(\"-ffat-lto-objects\"):\n            vars[var] = sub(\"-ffat-lto-objects\", \"\", vars[var])\n        if not clang_has_option(\"-ftree-loop-distribute-patterns\"):\n            vars[var] = sub(\"-ftree-loop-distribute-patterns\", \"\", vars[var])\n        if not clang_has_option(\"-gno-variable-location-views\"):\n            vars[var] = sub(\"-gno-variable-location-views\", \"\", vars[var])\n\nfrom setuptools import setup, Extension\n\nfrom setuptools.command.build_ext   import build_ext   as _build_ext\nfrom setuptools.command.install_lib import install_lib as _install_lib\n\nclass build_ext(_build_ext):\n    def finalize_options(self):\n        _build_ext.finalize_options(self)\n        self.build_lib  = build_lib\n        self.build_temp = build_tmp\n\nclass install_lib(_install_lib):\n    def finalize_options(self):\n        _install_lib.finalize_options(self)\n        self.build_dir = build_lib\n\n\ncflags = getenv('CFLAGS', '').split()\n# switch off several checks (need to be at the end of cflags list)\ncflags += ['-fno-strict-aliasing', '-Wno-write-strings', '-Wno-unused-parameter', '-Wno-redundant-decls', '-DPYTHON_PERF' ]\nif cc_is_clang:\n    cflags += [\"-Wno-unused-command-line-argument\" ]\nelse:\n    cflags += ['-Wno-cast-function-type' ]\n\n# The python headers have mixed code with declarations (decls after asserts, for instance)\ncflags += [ \"-Wno-declaration-after-statement\" ]\n\nsrc_perf  = getenv('srctree') + '/tools/perf'\nbuild_lib = getenv('PYTHON_EXTBUILD_LIB')\nbuild_tmp = getenv('PYTHON_EXTBUILD_TMP')\nlibtraceevent = getenv('LIBTRACEEVENT')\nlibapikfs = getenv('LIBAPI')\nlibperf = getenv('LIBPERF')\n\next_sources = [f.strip() for f in open('util/python-ext-sources')\n\t\t\t\tif len(f.strip()) > 0 and f[0] != '#']\n\nextra_libraries = []\n\nif '-DHAVE_LIBTRACEEVENT' in cflags:\n    extra_libraries += [ 'traceevent' ]\nelse:\n    ext_sources.remove('util/trace-event.c')\n\n# use full paths with source files\next_sources = list(map(lambda x: '%s/%s' % (src_perf, x) , ext_sources))\n\nif '-DHAVE_LIBNUMA_SUPPORT' in cflags:\n    extra_libraries += [ 'numa' ]\nif '-DHAVE_LIBCAP_SUPPORT' in cflags:\n    extra_libraries += [ 'cap' ]\n\nperf = Extension('perf',\n\t\t  sources = ext_sources,\n\t\t  include_dirs = ['util/include'],\n\t\t  libraries = extra_libraries,\n\t\t  extra_compile_args = cflags,\n\t\t  extra_objects = [ x for x in [libtraceevent, libapikfs, libperf]\n                                    if x is not None],\n                 )\n\nsetup(name='perf',\n      version='0.1',\n      description='Interface with the Linux profiling infrastructure',\n      author='Arnaldo Carvalho de Melo',\n      author_email='acme@redhat.com',\n      license='GPLv2',\n      url='http://perf.wiki.kernel.org',\n      ext_modules=[perf],\n      cmdclass={'build_ext': build_ext, 'install_lib': install_lib})\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}