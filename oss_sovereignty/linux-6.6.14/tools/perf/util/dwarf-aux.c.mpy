{
  "module_name": "dwarf-aux.c",
  "hash_id": "9ce3d3f9867a7e5c2a7ef55bde7599eecdb61441ed5c36c93a633c0157d55151",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/dwarf-aux.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <inttypes.h>\n#include <stdbool.h>\n#include <stdlib.h>\n#include \"debug.h\"\n#include \"dwarf-aux.h\"\n#include \"strbuf.h\"\n#include \"string2.h\"\n\n \nconst char *cu_find_realpath(Dwarf_Die *cu_die, const char *fname)\n{\n\tDwarf_Files *files;\n\tsize_t nfiles, i;\n\tconst char *src = NULL;\n\tint ret;\n\n\tif (!fname)\n\t\treturn NULL;\n\n\tret = dwarf_getsrcfiles(cu_die, &files, &nfiles);\n\tif (ret != 0)\n\t\treturn NULL;\n\n\tfor (i = 0; i < nfiles; i++) {\n\t\tsrc = dwarf_filesrc(files, i, NULL, NULL);\n\t\tif (strtailcmp(src, fname) == 0)\n\t\t\tbreak;\n\t}\n\tif (i == nfiles)\n\t\treturn NULL;\n\treturn src;\n}\n\n \nconst char *cu_get_comp_dir(Dwarf_Die *cu_die)\n{\n\tDwarf_Attribute attr;\n\tif (dwarf_attr(cu_die, DW_AT_comp_dir, &attr) == NULL)\n\t\treturn NULL;\n\treturn dwarf_formstring(&attr);\n}\n\n \nstatic Dwarf_Line *cu_getsrc_die(Dwarf_Die *cu_die, Dwarf_Addr addr)\n{\n\tDwarf_Addr laddr;\n\tDwarf_Lines *lines;\n\tDwarf_Line *line;\n\tsize_t nlines, l, u, n;\n\tbool flag;\n\n\tif (dwarf_getsrclines(cu_die, &lines, &nlines) != 0 ||\n\t    nlines == 0)\n\t\treturn NULL;\n\n\t \n\tl = 0; u = nlines - 1;\n\twhile (l < u) {\n\t\tn = u - (u - l) / 2;\n\t\tline = dwarf_onesrcline(lines, n);\n\t\tif (!line || dwarf_lineaddr(line, &laddr) != 0)\n\t\t\treturn NULL;\n\t\tif (addr < laddr)\n\t\t\tu = n - 1;\n\t\telse\n\t\t\tl = n;\n\t}\n\t \n\tdo {\n\t\tline = dwarf_onesrcline(lines, --l);\n\t\tif (!line || dwarf_lineaddr(line, &laddr) != 0)\n\t\t\treturn NULL;\n\t} while (laddr == addr);\n\tl++;\n\t \n\tdo {\n\t\tline = dwarf_onesrcline(lines, l++);\n\t\tif (!line || dwarf_lineaddr(line, &laddr) != 0 ||\n\t\t    dwarf_linebeginstatement(line, &flag) != 0)\n\t\t\treturn NULL;\n\t\tif (laddr > addr)\n\t\t\treturn NULL;\n\t} while (!flag);\n\n\treturn line;\n}\n\n \nint cu_find_lineinfo(Dwarf_Die *cu_die, Dwarf_Addr addr,\n\t\t     const char **fname, int *lineno)\n{\n\tDwarf_Line *line;\n\tDwarf_Die die_mem;\n\tDwarf_Addr faddr;\n\n\tif (die_find_realfunc(cu_die, addr, &die_mem)\n\t    && die_entrypc(&die_mem, &faddr) == 0 &&\n\t    faddr == addr) {\n\t\t*fname = die_get_decl_file(&die_mem);\n\t\tdwarf_decl_line(&die_mem, lineno);\n\t\tgoto out;\n\t}\n\n\tline = cu_getsrc_die(cu_die, addr);\n\tif (line && dwarf_lineno(line, lineno) == 0) {\n\t\t*fname = dwarf_linesrc(line, NULL, NULL);\n\t\tif (!*fname)\n\t\t\t \n\t\t\t*lineno = 0;\n\t}\n\nout:\n\treturn (*lineno && *fname) ? *lineno : -ENOENT;\n}\n\nstatic int __die_find_inline_cb(Dwarf_Die *die_mem, void *data);\n\n \nint cu_walk_functions_at(Dwarf_Die *cu_die, Dwarf_Addr addr,\n\t\t    int (*callback)(Dwarf_Die *, void *), void *data)\n{\n\tDwarf_Die die_mem;\n\tDwarf_Die *sc_die;\n\tint ret = -ENOENT;\n\n\t \n\tfor (sc_die = die_find_realfunc(cu_die, addr, &die_mem);\n\t     sc_die != NULL;\n\t     sc_die = die_find_child(sc_die, __die_find_inline_cb, &addr,\n\t\t\t\t     &die_mem)) {\n\t\tret = callback(sc_die, data);\n\t\tif (ret)\n\t\t\tbreak;\n\t}\n\n\treturn ret;\n\n}\n\n \nconst char *die_get_linkage_name(Dwarf_Die *dw_die)\n{\n\tDwarf_Attribute attr;\n\n\tif (dwarf_attr_integrate(dw_die, DW_AT_linkage_name, &attr) == NULL)\n\t\treturn NULL;\n\treturn dwarf_formstring(&attr);\n}\n\n \nbool die_compare_name(Dwarf_Die *dw_die, const char *tname)\n{\n\tconst char *name;\n\n\tname = dwarf_diename(dw_die);\n\treturn name ? (strcmp(tname, name) == 0) : false;\n}\n\n \nbool die_match_name(Dwarf_Die *dw_die, const char *glob)\n{\n\tconst char *name;\n\n\tname = dwarf_diename(dw_die);\n\tif (name && strglobmatch(name, glob))\n\t\treturn true;\n\t \n\tname = die_get_linkage_name(dw_die);\n\tif (name && strglobmatch(name, glob))\n\t\treturn true;\n\n\treturn false;\n}\n\n \nint die_get_call_lineno(Dwarf_Die *in_die)\n{\n\tDwarf_Attribute attr;\n\tDwarf_Word ret;\n\n\tif (!dwarf_attr(in_die, DW_AT_call_line, &attr))\n\t\treturn -ENOENT;\n\n\tdwarf_formudata(&attr, &ret);\n\treturn (int)ret;\n}\n\n \nDwarf_Die *die_get_type(Dwarf_Die *vr_die, Dwarf_Die *die_mem)\n{\n\tDwarf_Attribute attr;\n\n\tif (dwarf_attr_integrate(vr_die, DW_AT_type, &attr) &&\n\t    dwarf_formref_die(&attr, die_mem))\n\t\treturn die_mem;\n\telse\n\t\treturn NULL;\n}\n\n \nstatic Dwarf_Die *__die_get_real_type(Dwarf_Die *vr_die, Dwarf_Die *die_mem)\n{\n\tint tag;\n\n\tdo {\n\t\tvr_die = die_get_type(vr_die, die_mem);\n\t\tif (!vr_die)\n\t\t\tbreak;\n\t\ttag = dwarf_tag(vr_die);\n\t} while (tag == DW_TAG_const_type ||\n\t\t tag == DW_TAG_restrict_type ||\n\t\t tag == DW_TAG_volatile_type ||\n\t\t tag == DW_TAG_shared_type);\n\n\treturn vr_die;\n}\n\n \nDwarf_Die *die_get_real_type(Dwarf_Die *vr_die, Dwarf_Die *die_mem)\n{\n\tdo {\n\t\tvr_die = __die_get_real_type(vr_die, die_mem);\n\t} while (vr_die && dwarf_tag(vr_die) == DW_TAG_typedef);\n\n\treturn vr_die;\n}\n\n \nstatic int die_get_attr_udata(Dwarf_Die *tp_die, unsigned int attr_name,\n\t\t\t      Dwarf_Word *result)\n{\n\tDwarf_Attribute attr;\n\n\tif (dwarf_attr_integrate(tp_die, attr_name, &attr) == NULL ||\n\t    dwarf_formudata(&attr, result) != 0)\n\t\treturn -ENOENT;\n\n\treturn 0;\n}\n\n \nbool die_is_signed_type(Dwarf_Die *tp_die)\n{\n\tDwarf_Word ret;\n\n\tif (die_get_attr_udata(tp_die, DW_AT_encoding, &ret))\n\t\treturn false;\n\n\treturn (ret == DW_ATE_signed_char || ret == DW_ATE_signed ||\n\t\tret == DW_ATE_signed_fixed);\n}\n\n \nbool die_is_func_def(Dwarf_Die *dw_die)\n{\n\tDwarf_Attribute attr;\n\tDwarf_Addr addr = 0;\n\n\tif (dwarf_tag(dw_die) != DW_TAG_subprogram)\n\t\treturn false;\n\n\tif (dwarf_attr(dw_die, DW_AT_declaration, &attr))\n\t\treturn false;\n\n\t \n\tif (!dwarf_attr(dw_die, DW_AT_inline, &attr) &&\n\t    die_entrypc(dw_die, &addr) < 0)\n\t\treturn false;\n\n\treturn true;\n}\n\n \nint die_entrypc(Dwarf_Die *dw_die, Dwarf_Addr *addr)\n{\n\tDwarf_Addr base, end;\n\tDwarf_Attribute attr;\n\n\tif (!addr)\n\t\treturn -EINVAL;\n\n\tif (dwarf_entrypc(dw_die, addr) == 0)\n\t\treturn 0;\n\n\t \n\tif (!dwarf_attr(dw_die, DW_AT_ranges, &attr))\n\t\treturn -ENOENT;\n\n\treturn dwarf_ranges(dw_die, 0, &base, addr, &end) < 0 ? -ENOENT : 0;\n}\n\n \nbool die_is_func_instance(Dwarf_Die *dw_die)\n{\n\tDwarf_Addr tmp;\n\tDwarf_Attribute attr_mem;\n\tint tag = dwarf_tag(dw_die);\n\n\tif (tag != DW_TAG_subprogram &&\n\t    tag != DW_TAG_inlined_subroutine)\n\t\treturn false;\n\n\treturn dwarf_entrypc(dw_die, &tmp) == 0 ||\n\t\tdwarf_attr(dw_die, DW_AT_ranges, &attr_mem) != NULL;\n}\n\n \nint die_get_data_member_location(Dwarf_Die *mb_die, Dwarf_Word *offs)\n{\n\tDwarf_Attribute attr;\n\tDwarf_Op *expr;\n\tsize_t nexpr;\n\tint ret;\n\n\tif (dwarf_attr(mb_die, DW_AT_data_member_location, &attr) == NULL)\n\t\treturn -ENOENT;\n\n\tif (dwarf_formudata(&attr, offs) != 0) {\n\t\t \n\t\tret = dwarf_getlocation(&attr, &expr, &nexpr);\n\t\tif (ret < 0 || nexpr == 0)\n\t\t\treturn -ENOENT;\n\n\t\tif (expr[0].atom != DW_OP_plus_uconst || nexpr != 1) {\n\t\t\tpr_debug(\"Unable to get offset:Unexpected OP %x (%zd)\\n\",\n\t\t\t\t expr[0].atom, nexpr);\n\t\t\treturn -ENOTSUP;\n\t\t}\n\t\t*offs = (Dwarf_Word)expr[0].number;\n\t}\n\treturn 0;\n}\n\n \nstatic int die_get_call_fileno(Dwarf_Die *in_die)\n{\n\tDwarf_Word idx;\n\n\tif (die_get_attr_udata(in_die, DW_AT_call_file, &idx) == 0)\n\t\treturn (int)idx;\n\telse\n\t\treturn -ENOENT;\n}\n\n \nstatic int die_get_decl_fileno(Dwarf_Die *pdie)\n{\n\tDwarf_Word idx;\n\n\tif (die_get_attr_udata(pdie, DW_AT_decl_file, &idx) == 0)\n\t\treturn (int)idx;\n\telse\n\t\treturn -ENOENT;\n}\n\n \nstatic const char *die_get_file_name(Dwarf_Die *dw_die, int idx)\n{\n\tDwarf_Die cu_die;\n\tDwarf_Files *files;\n\tDwarf_Attribute attr_mem;\n\n\tif (idx < 0 || !dwarf_attr_integrate(dw_die, DW_AT_decl_file, &attr_mem) ||\n\t    !dwarf_cu_die(attr_mem.cu, &cu_die, NULL, NULL, NULL, NULL, NULL, NULL) ||\n\t    dwarf_getsrcfiles(&cu_die, &files, NULL) != 0)\n\t\treturn NULL;\n\n\treturn dwarf_filesrc(files, idx, NULL, NULL);\n}\n\n \nconst char *die_get_call_file(Dwarf_Die *in_die)\n{\n\treturn die_get_file_name(in_die, die_get_call_fileno(in_die));\n}\n\n \nconst char *die_get_decl_file(Dwarf_Die *dw_die)\n{\n\treturn die_get_file_name(dw_die, die_get_decl_fileno(dw_die));\n}\n\n \nDwarf_Die *die_find_child(Dwarf_Die *rt_die,\n\t\t\t  int (*callback)(Dwarf_Die *, void *),\n\t\t\t  void *data, Dwarf_Die *die_mem)\n{\n\tDwarf_Die child_die;\n\tint ret;\n\n\tret = dwarf_child(rt_die, die_mem);\n\tif (ret != 0)\n\t\treturn NULL;\n\n\tdo {\n\t\tret = callback(die_mem, data);\n\t\tif (ret == DIE_FIND_CB_END)\n\t\t\treturn die_mem;\n\n\t\tif ((ret & DIE_FIND_CB_CHILD) &&\n\t\t    die_find_child(die_mem, callback, data, &child_die)) {\n\t\t\tmemcpy(die_mem, &child_die, sizeof(Dwarf_Die));\n\t\t\treturn die_mem;\n\t\t}\n\t} while ((ret & DIE_FIND_CB_SIBLING) &&\n\t\t dwarf_siblingof(die_mem, die_mem) == 0);\n\n\treturn NULL;\n}\n\nstruct __addr_die_search_param {\n\tDwarf_Addr\taddr;\n\tDwarf_Die\t*die_mem;\n};\n\nstatic int __die_search_func_tail_cb(Dwarf_Die *fn_die, void *data)\n{\n\tstruct __addr_die_search_param *ad = data;\n\tDwarf_Addr addr = 0;\n\n\tif (dwarf_tag(fn_die) == DW_TAG_subprogram &&\n\t    !dwarf_highpc(fn_die, &addr) &&\n\t    addr == ad->addr) {\n\t\tmemcpy(ad->die_mem, fn_die, sizeof(Dwarf_Die));\n\t\treturn DWARF_CB_ABORT;\n\t}\n\treturn DWARF_CB_OK;\n}\n\n \nDwarf_Die *die_find_tailfunc(Dwarf_Die *cu_die, Dwarf_Addr addr,\n\t\t\t\t    Dwarf_Die *die_mem)\n{\n\tstruct __addr_die_search_param ad;\n\tad.addr = addr;\n\tad.die_mem = die_mem;\n\t \n\tif (!dwarf_getfuncs(cu_die, __die_search_func_tail_cb, &ad, 0))\n\t\treturn NULL;\n\telse\n\t\treturn die_mem;\n}\n\n \nstatic int __die_search_func_cb(Dwarf_Die *fn_die, void *data)\n{\n\tstruct __addr_die_search_param *ad = data;\n\n\t \n\tif (dwarf_tag(fn_die) == DW_TAG_subprogram &&\n\t    dwarf_haspc(fn_die, ad->addr)) {\n\t\tmemcpy(ad->die_mem, fn_die, sizeof(Dwarf_Die));\n\t\treturn DWARF_CB_ABORT;\n\t}\n\treturn DWARF_CB_OK;\n}\n\n \nDwarf_Die *die_find_realfunc(Dwarf_Die *cu_die, Dwarf_Addr addr,\n\t\t\t\t    Dwarf_Die *die_mem)\n{\n\tstruct __addr_die_search_param ad;\n\tad.addr = addr;\n\tad.die_mem = die_mem;\n\t \n\tif (!dwarf_getfuncs(cu_die, __die_search_func_cb, &ad, 0))\n\t\treturn NULL;\n\telse\n\t\treturn die_mem;\n}\n\n \nstatic int __die_find_inline_cb(Dwarf_Die *die_mem, void *data)\n{\n\tDwarf_Addr *addr = data;\n\n\tif (dwarf_tag(die_mem) == DW_TAG_inlined_subroutine &&\n\t    dwarf_haspc(die_mem, *addr))\n\t\treturn DIE_FIND_CB_END;\n\n\treturn DIE_FIND_CB_CONTINUE;\n}\n\n \nDwarf_Die *die_find_top_inlinefunc(Dwarf_Die *sp_die, Dwarf_Addr addr,\n\t\t\t\t   Dwarf_Die *die_mem)\n{\n\treturn die_find_child(sp_die, __die_find_inline_cb, &addr, die_mem);\n}\n\n \nDwarf_Die *die_find_inlinefunc(Dwarf_Die *sp_die, Dwarf_Addr addr,\n\t\t\t       Dwarf_Die *die_mem)\n{\n\tDwarf_Die tmp_die;\n\n\tsp_die = die_find_child(sp_die, __die_find_inline_cb, &addr, &tmp_die);\n\tif (!sp_die)\n\t\treturn NULL;\n\n\t \n\twhile (sp_die) {\n\t\tmemcpy(die_mem, sp_die, sizeof(Dwarf_Die));\n\t\tsp_die = die_find_child(sp_die, __die_find_inline_cb, &addr,\n\t\t\t\t\t&tmp_die);\n\t}\n\n\treturn die_mem;\n}\n\nstruct __instance_walk_param {\n\tvoid    *addr;\n\tint\t(*callback)(Dwarf_Die *, void *);\n\tvoid    *data;\n\tint\tretval;\n};\n\nstatic int __die_walk_instances_cb(Dwarf_Die *inst, void *data)\n{\n\tstruct __instance_walk_param *iwp = data;\n\tDwarf_Attribute attr_mem;\n\tDwarf_Die origin_mem;\n\tDwarf_Attribute *attr;\n\tDwarf_Die *origin;\n\tint tmp;\n\n\tif (!die_is_func_instance(inst))\n\t\treturn DIE_FIND_CB_CONTINUE;\n\n\tattr = dwarf_attr(inst, DW_AT_abstract_origin, &attr_mem);\n\tif (attr == NULL)\n\t\treturn DIE_FIND_CB_CONTINUE;\n\n\torigin = dwarf_formref_die(attr, &origin_mem);\n\tif (origin == NULL || origin->addr != iwp->addr)\n\t\treturn DIE_FIND_CB_CONTINUE;\n\n\t \n\tif (dwarf_tag(inst) == DW_TAG_inlined_subroutine) {\n\t\tdwarf_decl_line(origin, &tmp);\n\t\tif (die_get_call_lineno(inst) == tmp) {\n\t\t\ttmp = die_get_decl_fileno(origin);\n\t\t\tif (die_get_call_fileno(inst) == tmp)\n\t\t\t\treturn DIE_FIND_CB_CONTINUE;\n\t\t}\n\t}\n\n\tiwp->retval = iwp->callback(inst, iwp->data);\n\n\treturn (iwp->retval) ? DIE_FIND_CB_END : DIE_FIND_CB_CONTINUE;\n}\n\n \nint die_walk_instances(Dwarf_Die *or_die, int (*callback)(Dwarf_Die *, void *),\n\t\t       void *data)\n{\n\tDwarf_Die cu_die;\n\tDwarf_Die die_mem;\n\tstruct __instance_walk_param iwp = {\n\t\t.addr = or_die->addr,\n\t\t.callback = callback,\n\t\t.data = data,\n\t\t.retval = -ENOENT,\n\t};\n\n\tif (dwarf_diecu(or_die, &cu_die, NULL, NULL) == NULL)\n\t\treturn -ENOENT;\n\n\tdie_find_child(&cu_die, __die_walk_instances_cb, &iwp, &die_mem);\n\n\treturn iwp.retval;\n}\n\n \nstruct __line_walk_param {\n\tbool recursive;\n\tline_walk_callback_t callback;\n\tvoid *data;\n\tint retval;\n};\n\nstatic int __die_walk_funclines_cb(Dwarf_Die *in_die, void *data)\n{\n\tstruct __line_walk_param *lw = data;\n\tDwarf_Addr addr = 0;\n\tconst char *fname;\n\tint lineno;\n\n\tif (dwarf_tag(in_die) == DW_TAG_inlined_subroutine) {\n\t\tfname = die_get_call_file(in_die);\n\t\tlineno = die_get_call_lineno(in_die);\n\t\tif (fname && lineno > 0 && die_entrypc(in_die, &addr) == 0) {\n\t\t\tlw->retval = lw->callback(fname, lineno, addr, lw->data);\n\t\t\tif (lw->retval != 0)\n\t\t\t\treturn DIE_FIND_CB_END;\n\t\t}\n\t\tif (!lw->recursive)\n\t\t\treturn DIE_FIND_CB_SIBLING;\n\t}\n\n\tif (addr) {\n\t\tfname = die_get_decl_file(in_die);\n\t\tif (fname && dwarf_decl_line(in_die, &lineno) == 0) {\n\t\t\tlw->retval = lw->callback(fname, lineno, addr, lw->data);\n\t\t\tif (lw->retval != 0)\n\t\t\t\treturn DIE_FIND_CB_END;\n\t\t}\n\t}\n\n\t \n\treturn DIE_FIND_CB_CONTINUE;\n}\n\n \nstatic int __die_walk_funclines(Dwarf_Die *sp_die, bool recursive,\n\t\t\t\tline_walk_callback_t callback, void *data)\n{\n\tstruct __line_walk_param lw = {\n\t\t.recursive = recursive,\n\t\t.callback = callback,\n\t\t.data = data,\n\t\t.retval = 0,\n\t};\n\tDwarf_Die die_mem;\n\tDwarf_Addr addr;\n\tconst char *fname;\n\tint lineno;\n\n\t \n\tfname = die_get_decl_file(sp_die);\n\tif (fname && dwarf_decl_line(sp_die, &lineno) == 0 &&\n\t    die_entrypc(sp_die, &addr) == 0) {\n\t\tlw.retval = callback(fname, lineno, addr, data);\n\t\tif (lw.retval != 0)\n\t\t\tgoto done;\n\t}\n\tdie_find_child(sp_die, __die_walk_funclines_cb, &lw, &die_mem);\ndone:\n\treturn lw.retval;\n}\n\nstatic int __die_walk_culines_cb(Dwarf_Die *sp_die, void *data)\n{\n\tstruct __line_walk_param *lw = data;\n\n\t \n\tlw->retval = __die_walk_funclines(sp_die, true, lw->callback, lw->data);\n\tif (lw->retval != 0)\n\t\treturn DWARF_CB_ABORT;\n\n\treturn DWARF_CB_OK;\n}\n\n \nint die_walk_lines(Dwarf_Die *rt_die, line_walk_callback_t callback, void *data)\n{\n\tDwarf_Lines *lines;\n\tDwarf_Line *line;\n\tDwarf_Addr addr;\n\tconst char *fname, *decf = NULL, *inf = NULL;\n\tint lineno, ret = 0;\n\tint decl = 0, inl;\n\tDwarf_Die die_mem, *cu_die;\n\tsize_t nlines, i;\n\tbool flag;\n\n\t \n\tif (dwarf_tag(rt_die) != DW_TAG_compile_unit) {\n\t\tcu_die = dwarf_diecu(rt_die, &die_mem, NULL, NULL);\n\t\tdwarf_decl_line(rt_die, &decl);\n\t\tdecf = die_get_decl_file(rt_die);\n\t\tif (!decf) {\n\t\t\tpr_debug2(\"Failed to get the declared file name of %s\\n\",\n\t\t\t\t  dwarf_diename(rt_die));\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else\n\t\tcu_die = rt_die;\n\tif (!cu_die) {\n\t\tpr_debug2(\"Failed to get CU from given DIE.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (dwarf_getsrclines(cu_die, &lines, &nlines) != 0) {\n\t\tpr_debug2(\"Failed to get source lines on this CU.\\n\");\n\t\treturn -ENOENT;\n\t}\n\tpr_debug2(\"Get %zd lines from this CU\\n\", nlines);\n\n\t \n\tfor (i = 0; i < nlines; i++) {\n\t\tline = dwarf_onesrcline(lines, i);\n\t\tif (line == NULL ||\n\t\t    dwarf_lineno(line, &lineno) != 0 ||\n\t\t    dwarf_lineaddr(line, &addr) != 0) {\n\t\t\tpr_debug2(\"Failed to get line info. \"\n\t\t\t\t  \"Possible error in debuginfo.\\n\");\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (dwarf_lineendsequence(line, &flag) != 0 || flag)\n\t\t\tcontinue;\n\t\t \n\t\tif (dwarf_linebeginstatement(line, &flag) != 0 || !flag)\n\t\t\tcontinue;\n\t\t \n\t\tif (rt_die != cu_die) {\n\t\t\t \n\t\t\tif (!dwarf_haspc(rt_die, addr))\n\t\t\t\tcontinue;\n\n\t\t\tif (die_find_inlinefunc(rt_die, addr, &die_mem)) {\n\t\t\t\t \n\t\t\t\tinf = die_get_call_file(&die_mem);\n\t\t\t\tif ((inf && !strcmp(inf, decf)) &&\n\t\t\t\t    die_get_call_lineno(&die_mem) == lineno)\n\t\t\t\t\tgoto found;\n\n\t\t\t\tdwarf_decl_line(&die_mem, &inl);\n\t\t\t\tif (inl != decl ||\n\t\t\t\t    decf != die_get_decl_file(&die_mem))\n\t\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\nfound:\n\t\t \n\t\tfname = dwarf_linesrc(line, NULL, NULL);\n\n\t\tret = callback(fname, lineno, addr, data);\n\t\tif (ret != 0)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (rt_die != cu_die)\n\t\t \n\t\tret = __die_walk_funclines(rt_die, false, callback, data);\n\telse {\n\t\tstruct __line_walk_param param = {\n\t\t\t.callback = callback,\n\t\t\t.data = data,\n\t\t\t.retval = 0,\n\t\t};\n\t\tdwarf_getfuncs(cu_die, __die_walk_culines_cb, &param, 0);\n\t\tret = param.retval;\n\t}\n\n\treturn ret;\n}\n\nstruct __find_variable_param {\n\tconst char *name;\n\tDwarf_Addr addr;\n};\n\nstatic int __die_find_variable_cb(Dwarf_Die *die_mem, void *data)\n{\n\tstruct __find_variable_param *fvp = data;\n\tDwarf_Attribute attr;\n\tint tag;\n\n\ttag = dwarf_tag(die_mem);\n\tif ((tag == DW_TAG_formal_parameter ||\n\t     tag == DW_TAG_variable) &&\n\t    die_compare_name(die_mem, fvp->name) &&\n\t \n\t    (dwarf_attr(die_mem, DW_AT_external, &attr) ||\n\t     dwarf_attr(die_mem, DW_AT_location, &attr) ||\n\t     dwarf_attr(die_mem, DW_AT_const_value, &attr)))\n\t\treturn DIE_FIND_CB_END;\n\tif (dwarf_haspc(die_mem, fvp->addr))\n\t\treturn DIE_FIND_CB_CONTINUE;\n\telse\n\t\treturn DIE_FIND_CB_SIBLING;\n}\n\n \nDwarf_Die *die_find_variable_at(Dwarf_Die *sp_die, const char *name,\n\t\t\t\tDwarf_Addr addr, Dwarf_Die *die_mem)\n{\n\tstruct __find_variable_param fvp = { .name = name, .addr = addr};\n\n\treturn die_find_child(sp_die, __die_find_variable_cb, (void *)&fvp,\n\t\t\t      die_mem);\n}\n\nstatic int __die_find_member_cb(Dwarf_Die *die_mem, void *data)\n{\n\tconst char *name = data;\n\n\tif (dwarf_tag(die_mem) == DW_TAG_member) {\n\t\tif (die_compare_name(die_mem, name))\n\t\t\treturn DIE_FIND_CB_END;\n\t\telse if (!dwarf_diename(die_mem)) {\t \n\t\t\tDwarf_Die type_die, tmp_die;\n\t\t\tif (die_get_type(die_mem, &type_die) &&\n\t\t\t    die_find_member(&type_die, name, &tmp_die))\n\t\t\t\treturn DIE_FIND_CB_END;\n\t\t}\n\t}\n\treturn DIE_FIND_CB_SIBLING;\n}\n\n \nDwarf_Die *die_find_member(Dwarf_Die *st_die, const char *name,\n\t\t\t   Dwarf_Die *die_mem)\n{\n\treturn die_find_child(st_die, __die_find_member_cb, (void *)name,\n\t\t\t      die_mem);\n}\n\n \nint die_get_typename(Dwarf_Die *vr_die, struct strbuf *buf)\n{\n\tDwarf_Die type;\n\tint tag, ret;\n\tconst char *tmp = \"\";\n\n\tif (__die_get_real_type(vr_die, &type) == NULL)\n\t\treturn -ENOENT;\n\n\ttag = dwarf_tag(&type);\n\tif (tag == DW_TAG_array_type || tag == DW_TAG_pointer_type)\n\t\ttmp = \"*\";\n\telse if (tag == DW_TAG_subroutine_type) {\n\t\t \n\t\treturn strbuf_add(buf, \"(function_type)\", 15);\n\t} else {\n\t\tconst char *name = dwarf_diename(&type);\n\n\t\tif (tag == DW_TAG_union_type)\n\t\t\ttmp = \"union \";\n\t\telse if (tag == DW_TAG_structure_type)\n\t\t\ttmp = \"struct \";\n\t\telse if (tag == DW_TAG_enumeration_type)\n\t\t\ttmp = \"enum \";\n\t\telse if (name == NULL)\n\t\t\treturn -ENOENT;\n\t\t \n\t\treturn strbuf_addf(buf, \"%s%s\", tmp, name ?: \"\");\n\t}\n\tret = die_get_typename(&type, buf);\n\treturn ret ? ret : strbuf_addstr(buf, tmp);\n}\n\n \nint die_get_varname(Dwarf_Die *vr_die, struct strbuf *buf)\n{\n\tint ret;\n\n\tret = die_get_typename(vr_die, buf);\n\tif (ret < 0) {\n\t\tpr_debug(\"Failed to get type, make it unknown.\\n\");\n\t\tret = strbuf_add(buf, \"(unknown_type)\", 14);\n\t}\n\n\treturn ret < 0 ? ret : strbuf_addf(buf, \"\\t%s\", dwarf_diename(vr_die));\n}\n\n#ifdef HAVE_DWARF_GETLOCATIONS_SUPPORT\n \nstatic int die_get_var_innermost_scope(Dwarf_Die *sp_die, Dwarf_Die *vr_die,\n\t\t\t\tstruct strbuf *buf)\n{\n\tDwarf_Die *scopes;\n\tint count;\n\tsize_t offset = 0;\n\tDwarf_Addr base;\n\tDwarf_Addr start, end;\n\tDwarf_Addr entry;\n\tint ret;\n\tbool first = true;\n\tconst char *name;\n\n\tret = die_entrypc(sp_die, &entry);\n\tif (ret)\n\t\treturn ret;\n\n\tname = dwarf_diename(sp_die);\n\tif (!name)\n\t\treturn -ENOENT;\n\n\tcount = dwarf_getscopes_die(vr_die, &scopes);\n\n\t \n\tif (count <= 1) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\twhile ((offset = dwarf_ranges(&scopes[1], offset, &base,\n\t\t\t\t\t&start, &end)) > 0) {\n\t\tstart -= entry;\n\t\tend -= entry;\n\n\t\tif (first) {\n\t\t\tret = strbuf_addf(buf, \"@<%s+[%\" PRIu64 \"-%\" PRIu64,\n\t\t\t\t\t  name, start, end);\n\t\t\tfirst = false;\n\t\t} else {\n\t\t\tret = strbuf_addf(buf, \",%\" PRIu64 \"-%\" PRIu64,\n\t\t\t\t\t  start, end);\n\t\t}\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\t}\n\n\tif (!first)\n\t\tret = strbuf_add(buf, \"]>\", 2);\n\nout:\n\tfree(scopes);\n\treturn ret;\n}\n\n \nint die_get_var_range(Dwarf_Die *sp_die, Dwarf_Die *vr_die, struct strbuf *buf)\n{\n\tint ret = 0;\n\tDwarf_Addr base;\n\tDwarf_Addr start, end;\n\tDwarf_Addr entry;\n\tDwarf_Op *op;\n\tsize_t nops;\n\tsize_t offset = 0;\n\tDwarf_Attribute attr;\n\tbool first = true;\n\tconst char *name;\n\n\tret = die_entrypc(sp_die, &entry);\n\tif (ret)\n\t\treturn ret;\n\n\tname = dwarf_diename(sp_die);\n\tif (!name)\n\t\treturn -ENOENT;\n\n\tif (dwarf_attr(vr_die, DW_AT_location, &attr) == NULL)\n\t\treturn -EINVAL;\n\n\twhile ((offset = dwarf_getlocations(&attr, offset, &base,\n\t\t\t\t\t&start, &end, &op, &nops)) > 0) {\n\t\tif (start == 0) {\n\t\t\t \n\t\t\tret = die_get_var_innermost_scope(sp_die, vr_die, buf);\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tstart -= entry;\n\t\tend -= entry;\n\t\tif (first) {\n\t\t\tret = strbuf_addf(buf, \"@<%s+[%\" PRIu64 \"-%\" PRIu64,\n\t\t\t\t\t  name, start, end);\n\t\t\tfirst = false;\n\t\t} else {\n\t\t\tret = strbuf_addf(buf, \",%\" PRIu64 \"-%\" PRIu64,\n\t\t\t\t\t  start, end);\n\t\t}\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\t}\n\n\tif (!first)\n\t\tret = strbuf_add(buf, \"]>\", 2);\nout:\n\treturn ret;\n}\n#else\nint die_get_var_range(Dwarf_Die *sp_die __maybe_unused,\n\t\t      Dwarf_Die *vr_die __maybe_unused,\n\t\t      struct strbuf *buf __maybe_unused)\n{\n\treturn -ENOTSUP;\n}\n#endif\n\n \nstatic bool die_has_loclist(Dwarf_Die *vr_die)\n{\n\tDwarf_Attribute loc;\n\tint tag = dwarf_tag(vr_die);\n\n\tif (tag != DW_TAG_formal_parameter &&\n\t    tag != DW_TAG_variable)\n\t\treturn false;\n\n\treturn (dwarf_attr_integrate(vr_die, DW_AT_location, &loc) &&\n\t\tdwarf_whatform(&loc) == DW_FORM_sec_offset);\n}\n\n \nbool die_is_optimized_target(Dwarf_Die *cu_die)\n{\n\tDwarf_Die tmp_die;\n\n\tif (die_has_loclist(cu_die))\n\t\treturn true;\n\n\tif (!dwarf_child(cu_die, &tmp_die) &&\n\t    die_is_optimized_target(&tmp_die))\n\t\treturn true;\n\n\tif (!dwarf_siblingof(cu_die, &tmp_die) &&\n\t    die_is_optimized_target(&tmp_die))\n\t\treturn true;\n\n\treturn false;\n}\n\n \nstatic bool die_search_idx(Dwarf_Lines *lines, unsigned long nr_lines,\n\t\t\t   Dwarf_Addr addr, unsigned long *idx)\n{\n\tunsigned long i;\n\tDwarf_Addr tmp;\n\n\tfor (i = 0; i < nr_lines; i++) {\n\t\tif (dwarf_lineaddr(dwarf_onesrcline(lines, i), &tmp))\n\t\t\treturn false;\n\n\t\tif (tmp == addr) {\n\t\t\t*idx = i;\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n \nstatic bool die_get_postprologue_addr(unsigned long entrypc_idx,\n\t\t\t\t      Dwarf_Lines *lines,\n\t\t\t\t      unsigned long nr_lines,\n\t\t\t\t      Dwarf_Addr highpc,\n\t\t\t\t      Dwarf_Addr *postprologue_addr)\n{\n\tunsigned long i;\n\tint entrypc_lno, lno;\n\tDwarf_Line *line;\n\tDwarf_Addr addr;\n\tbool p_end;\n\n\t \n\tline = dwarf_onesrcline(lines, entrypc_idx);\n\tif (dwarf_lineno(line, &entrypc_lno))\n\t\treturn false;\n\n\tfor (i = entrypc_idx; i < nr_lines; i++) {\n\t\tline = dwarf_onesrcline(lines, i);\n\n\t\tif (dwarf_lineaddr(line, &addr) ||\n\t\t    dwarf_lineno(line, &lno)    ||\n\t\t    dwarf_lineprologueend(line, &p_end))\n\t\t\treturn false;\n\n\t\t \n\t\tif (addr >= highpc)\n\t\t\tbreak;\n\n\t\t \n\t\tif (p_end)\n\t\t\tbreak;\n\n\t\t \n\t\tif (lno != entrypc_lno)\n\t\t\tbreak;\n\n\t\t \n\t\tif (i != entrypc_idx)\n\t\t\tbreak;\n\t}\n\n\tdwarf_lineaddr(line, postprologue_addr);\n\tif (*postprologue_addr >= highpc)\n\t\tdwarf_lineaddr(dwarf_onesrcline(lines, i - 1),\n\t\t\t       postprologue_addr);\n\n\treturn true;\n}\n\n \nvoid die_skip_prologue(Dwarf_Die *sp_die, Dwarf_Die *cu_die,\n\t\t       Dwarf_Addr *entrypc)\n{\n\tsize_t nr_lines = 0;\n\tunsigned long entrypc_idx = 0;\n\tDwarf_Lines *lines = NULL;\n\tDwarf_Addr postprologue_addr;\n\tDwarf_Addr highpc;\n\n\tif (dwarf_highpc(sp_die, &highpc))\n\t\treturn;\n\n\tif (dwarf_getsrclines(cu_die, &lines, &nr_lines))\n\t\treturn;\n\n\tif (!die_search_idx(lines, nr_lines, *entrypc, &entrypc_idx))\n\t\treturn;\n\n\tif (!die_get_postprologue_addr(entrypc_idx, lines, nr_lines,\n\t\t\t\t       highpc, &postprologue_addr))\n\t\treturn;\n\n\t*entrypc = postprologue_addr;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}