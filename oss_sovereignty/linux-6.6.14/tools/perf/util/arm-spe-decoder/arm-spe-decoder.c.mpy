{
  "module_name": "arm-spe-decoder.c",
  "hash_id": "89f30655176d1ccaccd3c57637c5f95b1f228dfda8982100fee239ea44a861ea",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/arm-spe-decoder/arm-spe-decoder.c",
  "human_readable_source": "\n \n\n#ifndef _GNU_SOURCE\n#define _GNU_SOURCE\n#endif\n#include <errno.h>\n#include <inttypes.h>\n#include <stdbool.h>\n#include <string.h>\n#include <stdint.h>\n#include <stdlib.h>\n#include <linux/bitops.h>\n#include <linux/compiler.h>\n#include <linux/zalloc.h>\n\n#include \"../auxtrace.h\"\n#include \"../debug.h\"\n#include \"../util.h\"\n\n#include \"arm-spe-decoder.h\"\n\nstatic u64 arm_spe_calc_ip(int index, u64 payload)\n{\n\tu64 ns, el, val;\n\n\t \n\tif (index == SPE_ADDR_PKT_HDR_INDEX_INS ||\n\t    index == SPE_ADDR_PKT_HDR_INDEX_BRANCH) {\n\t\tns = SPE_ADDR_PKT_GET_NS(payload);\n\t\tel = SPE_ADDR_PKT_GET_EL(payload);\n\n\t\t \n\t\tpayload = SPE_ADDR_PKT_ADDR_GET_BYTES_0_6(payload);\n\n\t\t \n\t\tif (ns && (el == SPE_ADDR_PKT_EL1 || el == SPE_ADDR_PKT_EL2))\n\t\t\tpayload |= 0xffULL << SPE_ADDR_PKT_ADDR_BYTE7_SHIFT;\n\n\t \n\t} else if (index == SPE_ADDR_PKT_HDR_INDEX_DATA_VIRT) {\n\n\t\t \n\t\tpayload = SPE_ADDR_PKT_ADDR_GET_BYTES_0_6(payload);\n\n\t\t \n\t\tval = SPE_ADDR_PKT_ADDR_GET_BYTE_6(payload);\n\t\tif ((val & 0xf0ULL) == 0xf0ULL)\n\t\t\tpayload |= 0xffULL << SPE_ADDR_PKT_ADDR_BYTE7_SHIFT;\n\n\t \n\t} else if (index == SPE_ADDR_PKT_HDR_INDEX_DATA_PHYS) {\n\t\t \n\t\tpayload = SPE_ADDR_PKT_ADDR_GET_BYTES_0_6(payload);\n\t} else {\n\t\tstatic u32 seen_idx = 0;\n\t\tif (!(seen_idx & BIT(index))) {\n\t\t\tseen_idx |= BIT(index);\n\t\t\tpr_warning(\"ignoring unsupported address packet index: 0x%x\\n\", index);\n\t\t}\n\t}\n\n\treturn payload;\n}\n\nstruct arm_spe_decoder *arm_spe_decoder_new(struct arm_spe_params *params)\n{\n\tstruct arm_spe_decoder *decoder;\n\n\tif (!params->get_trace)\n\t\treturn NULL;\n\n\tdecoder = zalloc(sizeof(struct arm_spe_decoder));\n\tif (!decoder)\n\t\treturn NULL;\n\n\tdecoder->get_trace = params->get_trace;\n\tdecoder->data = params->data;\n\n\treturn decoder;\n}\n\nvoid arm_spe_decoder_free(struct arm_spe_decoder *decoder)\n{\n\tfree(decoder);\n}\n\nstatic int arm_spe_get_data(struct arm_spe_decoder *decoder)\n{\n\tstruct arm_spe_buffer buffer = { .buf = 0, };\n\tint ret;\n\n\tpr_debug(\"Getting more data\\n\");\n\tret = decoder->get_trace(&buffer, decoder->data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdecoder->buf = buffer.buf;\n\tdecoder->len = buffer.len;\n\n\tif (!decoder->len)\n\t\tpr_debug(\"No more data\\n\");\n\n\treturn decoder->len;\n}\n\nstatic int arm_spe_get_next_packet(struct arm_spe_decoder *decoder)\n{\n\tint ret;\n\n\tdo {\n\t\tif (!decoder->len) {\n\t\t\tret = arm_spe_get_data(decoder);\n\n\t\t\t \n\t\t\tif (ret <= 0)\n\t\t\t\treturn ret;\n\t\t}\n\n\t\tret = arm_spe_get_packet(decoder->buf, decoder->len,\n\t\t\t\t\t &decoder->packet);\n\t\tif (ret <= 0) {\n\t\t\t \n\t\t\tdecoder->buf += 1;\n\t\t\tdecoder->len -= 1;\n\t\t\treturn -EBADMSG;\n\t\t}\n\n\t\tdecoder->buf += ret;\n\t\tdecoder->len -= ret;\n\t} while (decoder->packet.type == ARM_SPE_PAD);\n\n\treturn 1;\n}\n\nstatic int arm_spe_read_record(struct arm_spe_decoder *decoder)\n{\n\tint err;\n\tint idx;\n\tu64 payload, ip;\n\n\tmemset(&decoder->record, 0x0, sizeof(decoder->record));\n\tdecoder->record.context_id = (u64)-1;\n\n\twhile (1) {\n\t\terr = arm_spe_get_next_packet(decoder);\n\t\tif (err <= 0)\n\t\t\treturn err;\n\n\t\tidx = decoder->packet.index;\n\t\tpayload = decoder->packet.payload;\n\n\t\tswitch (decoder->packet.type) {\n\t\tcase ARM_SPE_TIMESTAMP:\n\t\t\tdecoder->record.timestamp = payload;\n\t\t\treturn 1;\n\t\tcase ARM_SPE_END:\n\t\t\treturn 1;\n\t\tcase ARM_SPE_ADDRESS:\n\t\t\tip = arm_spe_calc_ip(idx, payload);\n\t\t\tif (idx == SPE_ADDR_PKT_HDR_INDEX_INS)\n\t\t\t\tdecoder->record.from_ip = ip;\n\t\t\telse if (idx == SPE_ADDR_PKT_HDR_INDEX_BRANCH)\n\t\t\t\tdecoder->record.to_ip = ip;\n\t\t\telse if (idx == SPE_ADDR_PKT_HDR_INDEX_DATA_VIRT)\n\t\t\t\tdecoder->record.virt_addr = ip;\n\t\t\telse if (idx == SPE_ADDR_PKT_HDR_INDEX_DATA_PHYS)\n\t\t\t\tdecoder->record.phys_addr = ip;\n\t\t\tbreak;\n\t\tcase ARM_SPE_COUNTER:\n\t\t\tif (idx == SPE_CNT_PKT_HDR_INDEX_TOTAL_LAT)\n\t\t\t\tdecoder->record.latency = payload;\n\t\t\tbreak;\n\t\tcase ARM_SPE_CONTEXT:\n\t\t\tdecoder->record.context_id = payload;\n\t\t\tbreak;\n\t\tcase ARM_SPE_OP_TYPE:\n\t\t\tswitch (idx) {\n\t\t\tcase SPE_OP_PKT_HDR_CLASS_LD_ST_ATOMIC:\n\t\t\t\tdecoder->record.op |= ARM_SPE_OP_LDST;\n\t\t\t\tif (payload & SPE_OP_PKT_ST)\n\t\t\t\t\tdecoder->record.op |= ARM_SPE_OP_ST;\n\t\t\t\telse\n\t\t\t\t\tdecoder->record.op |= ARM_SPE_OP_LD;\n\t\t\t\tif (SPE_OP_PKT_IS_LDST_SVE(payload))\n\t\t\t\t\tdecoder->record.op |= ARM_SPE_OP_SVE_LDST;\n\t\t\t\tbreak;\n\t\t\tcase SPE_OP_PKT_HDR_CLASS_OTHER:\n\t\t\t\tdecoder->record.op |= ARM_SPE_OP_OTHER;\n\t\t\t\tif (SPE_OP_PKT_IS_OTHER_SVE_OP(payload))\n\t\t\t\t\tdecoder->record.op |= ARM_SPE_OP_SVE_OTHER;\n\t\t\t\tbreak;\n\t\t\tcase SPE_OP_PKT_HDR_CLASS_BR_ERET:\n\t\t\t\tdecoder->record.op |= ARM_SPE_OP_BRANCH_ERET;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Get packet error!\\n\");\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase ARM_SPE_EVENTS:\n\t\t\tif (payload & BIT(EV_L1D_REFILL))\n\t\t\t\tdecoder->record.type |= ARM_SPE_L1D_MISS;\n\n\t\t\tif (payload & BIT(EV_L1D_ACCESS))\n\t\t\t\tdecoder->record.type |= ARM_SPE_L1D_ACCESS;\n\n\t\t\tif (payload & BIT(EV_TLB_WALK))\n\t\t\t\tdecoder->record.type |= ARM_SPE_TLB_MISS;\n\n\t\t\tif (payload & BIT(EV_TLB_ACCESS))\n\t\t\t\tdecoder->record.type |= ARM_SPE_TLB_ACCESS;\n\n\t\t\tif (payload & BIT(EV_LLC_MISS))\n\t\t\t\tdecoder->record.type |= ARM_SPE_LLC_MISS;\n\n\t\t\tif (payload & BIT(EV_LLC_ACCESS))\n\t\t\t\tdecoder->record.type |= ARM_SPE_LLC_ACCESS;\n\n\t\t\tif (payload & BIT(EV_REMOTE_ACCESS))\n\t\t\t\tdecoder->record.type |= ARM_SPE_REMOTE_ACCESS;\n\n\t\t\tif (payload & BIT(EV_MISPRED))\n\t\t\t\tdecoder->record.type |= ARM_SPE_BRANCH_MISS;\n\n\t\t\tif (payload & BIT(EV_PARTIAL_PREDICATE))\n\t\t\t\tdecoder->record.type |= ARM_SPE_SVE_PARTIAL_PRED;\n\n\t\t\tif (payload & BIT(EV_EMPTY_PREDICATE))\n\t\t\t\tdecoder->record.type |= ARM_SPE_SVE_EMPTY_PRED;\n\n\t\t\tbreak;\n\t\tcase ARM_SPE_DATA_SOURCE:\n\t\t\tdecoder->record.source = payload;\n\t\t\tbreak;\n\t\tcase ARM_SPE_BAD:\n\t\t\tbreak;\n\t\tcase ARM_SPE_PAD:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_err(\"Get packet error!\\n\");\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint arm_spe_decode(struct arm_spe_decoder *decoder)\n{\n\treturn arm_spe_read_record(decoder);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}