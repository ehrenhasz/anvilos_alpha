{
  "module_name": "func_latency.bpf.c",
  "hash_id": "763ce4e7ba242dac0bcfd3549356aa57660eaa1b1e0213b60296b2cb753f6633",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/bpf_skel/func_latency.bpf.c",
  "human_readable_source": "\n\n#include \"vmlinux.h\"\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\n\n#define NUM_BUCKET  22\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__uint(key_size, sizeof(__u64));\n\t__uint(value_size, sizeof(__u64));\n\t__uint(max_entries, 10000);\n} functime SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__uint(key_size, sizeof(__u32));\n\t__uint(value_size, sizeof(__u8));\n\t__uint(max_entries, 1);\n} cpu_filter SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__uint(key_size, sizeof(__u32));\n\t__uint(value_size, sizeof(__u8));\n\t__uint(max_entries, 1);\n} task_filter SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);\n\t__uint(key_size, sizeof(__u32));\n\t__uint(value_size, sizeof(__u64));\n\t__uint(max_entries, NUM_BUCKET);\n} latency SEC(\".maps\");\n\n\nint enabled = 0;\nint has_cpu = 0;\nint has_task = 0;\nint use_nsec = 0;\n\nSEC(\"kprobe/func\")\nint BPF_PROG(func_begin)\n{\n\t__u64 key, now;\n\n\tif (!enabled)\n\t\treturn 0;\n\n\tkey = bpf_get_current_pid_tgid();\n\n\tif (has_cpu) {\n\t\t__u32 cpu = bpf_get_smp_processor_id();\n\t\t__u8 *ok;\n\n\t\tok = bpf_map_lookup_elem(&cpu_filter, &cpu);\n\t\tif (!ok)\n\t\t\treturn 0;\n\t}\n\n\tif (has_task) {\n\t\t__u32 pid = key & 0xffffffff;\n\t\t__u8 *ok;\n\n\t\tok = bpf_map_lookup_elem(&task_filter, &pid);\n\t\tif (!ok)\n\t\t\treturn 0;\n\t}\n\n\tnow = bpf_ktime_get_ns();\n\n\t\n\tbpf_map_update_elem(&functime, &key, &now, BPF_ANY);\n\treturn 0;\n}\n\nSEC(\"kretprobe/func\")\nint BPF_PROG(func_end)\n{\n\t__u64 tid;\n\t__u64 *start;\n\t__u64 cmp_base = use_nsec ? 1 : 1000;\n\n\tif (!enabled)\n\t\treturn 0;\n\n\ttid = bpf_get_current_pid_tgid();\n\n\tstart = bpf_map_lookup_elem(&functime, &tid);\n\tif (start) {\n\t\t__s64 delta = bpf_ktime_get_ns() - *start;\n\t\t__u32 key;\n\t\t__u64 *hist;\n\n\t\tbpf_map_delete_elem(&functime, &tid);\n\n\t\tif (delta < 0)\n\t\t\treturn 0;\n\n\t\t\n\t\tfor (key = 0; key < (NUM_BUCKET - 1); key++) {\n\t\t\tif (delta < (cmp_base << key))\n\t\t\t\tbreak;\n\t\t}\n\n\t\thist = bpf_map_lookup_elem(&latency, &key);\n\t\tif (!hist)\n\t\t\treturn 0;\n\n\t\t*hist += 1;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}