{
  "module_name": "perf_api_probe.c",
  "hash_id": "67fbe0bbf2fd2c38baca3711bb9928d93e4c1611d0a47568db3c5fccef3d00c8",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/perf_api_probe.c",
  "human_readable_source": " \n\n#include \"perf-sys.h\"\n#include \"util/cloexec.h\"\n#include \"util/evlist.h\"\n#include \"util/evsel.h\"\n#include \"util/parse-events.h\"\n#include \"util/perf_api_probe.h\"\n#include <perf/cpumap.h>\n#include <errno.h>\n\ntypedef void (*setup_probe_fn_t)(struct evsel *evsel);\n\nstatic int perf_do_probe_api(setup_probe_fn_t fn, struct perf_cpu cpu, const char *str)\n{\n\tstruct evlist *evlist;\n\tstruct evsel *evsel;\n\tunsigned long flags = perf_event_open_cloexec_flag();\n\tint err = -EAGAIN, fd;\n\tstatic pid_t pid = -1;\n\n\tevlist = evlist__new();\n\tif (!evlist)\n\t\treturn -ENOMEM;\n\n\tif (parse_event(evlist, str))\n\t\tgoto out_delete;\n\n\tevsel = evlist__first(evlist);\n\n\twhile (1) {\n\t\tfd = sys_perf_event_open(&evsel->core.attr, pid, cpu.cpu, -1, flags);\n\t\tif (fd < 0) {\n\t\t\tif (pid == -1 && errno == EACCES) {\n\t\t\t\tpid = 0;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tgoto out_delete;\n\t\t}\n\t\tbreak;\n\t}\n\tclose(fd);\n\n\tfn(evsel);\n\n\tfd = sys_perf_event_open(&evsel->core.attr, pid, cpu.cpu, -1, flags);\n\tif (fd < 0) {\n\t\tif (errno == EINVAL)\n\t\t\terr = -EINVAL;\n\t\tgoto out_delete;\n\t}\n\tclose(fd);\n\terr = 0;\n\nout_delete:\n\tevlist__delete(evlist);\n\treturn err;\n}\n\nstatic bool perf_probe_api(setup_probe_fn_t fn)\n{\n\tconst char *try[] = {\"cycles:u\", \"instructions:u\", \"cpu-clock:u\", NULL};\n\tstruct perf_cpu_map *cpus;\n\tstruct perf_cpu cpu;\n\tint ret, i = 0;\n\n\tcpus = perf_cpu_map__new(NULL);\n\tif (!cpus)\n\t\treturn false;\n\tcpu = perf_cpu_map__cpu(cpus, 0);\n\tperf_cpu_map__put(cpus);\n\n\tdo {\n\t\tret = perf_do_probe_api(fn, cpu, try[i++]);\n\t\tif (!ret)\n\t\t\treturn true;\n\t} while (ret == -EAGAIN && try[i]);\n\n\treturn false;\n}\n\nstatic void perf_probe_sample_identifier(struct evsel *evsel)\n{\n\tevsel->core.attr.sample_type |= PERF_SAMPLE_IDENTIFIER;\n}\n\nstatic void perf_probe_comm_exec(struct evsel *evsel)\n{\n\tevsel->core.attr.comm_exec = 1;\n}\n\nstatic void perf_probe_context_switch(struct evsel *evsel)\n{\n\tevsel->core.attr.context_switch = 1;\n}\n\nstatic void perf_probe_text_poke(struct evsel *evsel)\n{\n\tevsel->core.attr.text_poke = 1;\n}\n\nstatic void perf_probe_build_id(struct evsel *evsel)\n{\n\tevsel->core.attr.build_id = 1;\n}\n\nstatic void perf_probe_cgroup(struct evsel *evsel)\n{\n\tevsel->core.attr.cgroup = 1;\n}\n\nbool perf_can_sample_identifier(void)\n{\n\treturn perf_probe_api(perf_probe_sample_identifier);\n}\n\nbool perf_can_comm_exec(void)\n{\n\treturn perf_probe_api(perf_probe_comm_exec);\n}\n\nbool perf_can_record_switch_events(void)\n{\n\treturn perf_probe_api(perf_probe_context_switch);\n}\n\nbool perf_can_record_text_poke_events(void)\n{\n\treturn perf_probe_api(perf_probe_text_poke);\n}\n\nbool perf_can_record_cpu_wide(void)\n{\n\tstruct perf_event_attr attr = {\n\t\t.type = PERF_TYPE_SOFTWARE,\n\t\t.config = PERF_COUNT_SW_CPU_CLOCK,\n\t\t.exclude_kernel = 1,\n\t};\n\tstruct perf_cpu_map *cpus;\n\tstruct perf_cpu cpu;\n\tint fd;\n\n\tcpus = perf_cpu_map__new(NULL);\n\tif (!cpus)\n\t\treturn false;\n\n\tcpu = perf_cpu_map__cpu(cpus, 0);\n\tperf_cpu_map__put(cpus);\n\n\tfd = sys_perf_event_open(&attr, -1, cpu.cpu, -1, 0);\n\tif (fd < 0)\n\t\treturn false;\n\tclose(fd);\n\n\treturn true;\n}\n\n \nbool perf_can_aux_sample(void)\n{\n\tstruct perf_event_attr attr = {\n\t\t.size = sizeof(struct perf_event_attr),\n\t\t.exclude_kernel = 1,\n\t\t \n\t\t.aux_sample_size = 1,\n\t};\n\tint fd;\n\n\tfd = sys_perf_event_open(&attr, -1, 0, -1, 0);\n\t \n\tif (fd < 0 && errno == E2BIG)\n\t\treturn false;\n\tif (fd >= 0)\n\t\tclose(fd);\n\n\treturn true;\n}\n\nbool perf_can_record_build_id(void)\n{\n\treturn perf_probe_api(perf_probe_build_id);\n}\n\nbool perf_can_record_cgroup(void)\n{\n\treturn perf_probe_api(perf_probe_cgroup);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}