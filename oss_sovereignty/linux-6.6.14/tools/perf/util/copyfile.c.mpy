{
  "module_name": "copyfile.c",
  "hash_id": "ed27755eb103ffce23d5df7f6c4bffaf9007df7cfe9c192fe67cd0dba9cf263c",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/copyfile.c",
  "human_readable_source": "\n#include \"util/copyfile.h\"\n#include \"util/namespaces.h\"\n#include <internal/lib.h>\n#include <sys/mman.h>\n#include <sys/stat.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\nstatic int slow_copyfile(const char *from, const char *to, struct nsinfo *nsi)\n{\n\tint err = -1;\n\tchar *line = NULL;\n\tsize_t n;\n\tFILE *from_fp, *to_fp;\n\tstruct nscookie nsc;\n\n\tnsinfo__mountns_enter(nsi, &nsc);\n\tfrom_fp = fopen(from, \"r\");\n\tnsinfo__mountns_exit(&nsc);\n\tif (from_fp == NULL)\n\t\tgoto out;\n\n\tto_fp = fopen(to, \"w\");\n\tif (to_fp == NULL)\n\t\tgoto out_fclose_from;\n\n\twhile (getline(&line, &n, from_fp) > 0)\n\t\tif (fputs(line, to_fp) == EOF)\n\t\t\tgoto out_fclose_to;\n\terr = 0;\nout_fclose_to:\n\tfclose(to_fp);\n\tfree(line);\nout_fclose_from:\n\tfclose(from_fp);\nout:\n\treturn err;\n}\n\nint copyfile_offset(int ifd, loff_t off_in, int ofd, loff_t off_out, u64 size)\n{\n\tvoid *ptr;\n\tloff_t pgoff;\n\n\tpgoff = off_in & ~(page_size - 1);\n\toff_in -= pgoff;\n\n\tptr = mmap(NULL, off_in + size, PROT_READ, MAP_PRIVATE, ifd, pgoff);\n\tif (ptr == MAP_FAILED)\n\t\treturn -1;\n\n\twhile (size) {\n\t\tssize_t ret = pwrite(ofd, ptr + off_in, size, off_out);\n\t\tif (ret < 0 && errno == EINTR)\n\t\t\tcontinue;\n\t\tif (ret <= 0)\n\t\t\tbreak;\n\n\t\tsize -= ret;\n\t\toff_in += ret;\n\t\toff_out += ret;\n\t}\n\tmunmap(ptr, off_in + size);\n\n\treturn size ? -1 : 0;\n}\n\nstatic int copyfile_mode_ns(const char *from, const char *to, mode_t mode,\n\t\t\t    struct nsinfo *nsi)\n{\n\tint fromfd, tofd;\n\tstruct stat st;\n\tint err;\n\tchar *tmp = NULL, *ptr = NULL;\n\tstruct nscookie nsc;\n\n\tnsinfo__mountns_enter(nsi, &nsc);\n\terr = stat(from, &st);\n\tnsinfo__mountns_exit(&nsc);\n\tif (err)\n\t\tgoto out;\n\terr = -1;\n\n\t \n\tif (asprintf(&tmp, \"%s.XXXXXXx\", to) < 0) {\n\t\ttmp = NULL;\n\t\tgoto out;\n\t}\n\tptr = strrchr(tmp, '/');\n\tif (!ptr)\n\t\tgoto out;\n\tptr = memmove(ptr + 1, ptr, strlen(ptr) - 1);\n\t*ptr = '.';\n\n\ttofd = mkstemp(tmp);\n\tif (tofd < 0)\n\t\tgoto out;\n\n\tif (st.st_size == 0) {  \n\t\terr = slow_copyfile(from, tmp, nsi);\n\t\tif (!err && fchmod(tofd, mode))\n\t\t\terr = -1;\n\t\tgoto out_close_to;\n\t}\n\n\tif (fchmod(tofd, mode))\n\t\tgoto out_close_to;\n\n\tnsinfo__mountns_enter(nsi, &nsc);\n\tfromfd = open(from, O_RDONLY);\n\tnsinfo__mountns_exit(&nsc);\n\tif (fromfd < 0)\n\t\tgoto out_close_to;\n\n\terr = copyfile_offset(fromfd, 0, tofd, 0, st.st_size);\n\n\tclose(fromfd);\nout_close_to:\n\tclose(tofd);\n\tif (!err)\n\t\terr = link(tmp, to);\n\tunlink(tmp);\nout:\n\tfree(tmp);\n\treturn err;\n}\n\nint copyfile_ns(const char *from, const char *to, struct nsinfo *nsi)\n{\n\treturn copyfile_mode_ns(from, to, 0755, nsi);\n}\n\nint copyfile_mode(const char *from, const char *to, mode_t mode)\n{\n\treturn copyfile_mode_ns(from, to, mode, NULL);\n}\n\nint copyfile(const char *from, const char *to)\n{\n\treturn copyfile_mode(from, to, 0755);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}