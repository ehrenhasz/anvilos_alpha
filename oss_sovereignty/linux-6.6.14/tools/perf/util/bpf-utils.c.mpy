{
  "module_name": "bpf-utils.c",
  "hash_id": "73ca860e6b2e4499e714af249a50c8336fd11c1e121cae733d379957c48151b3",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/util/bpf-utils.c",
  "human_readable_source": "\n\n#ifndef _GNU_SOURCE\n#define _GNU_SOURCE\n#endif\n\n#include <errno.h>\n#include <stdlib.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <bpf/bpf.h>\n#include \"bpf-utils.h\"\n#include \"debug.h\"\n\nstruct bpil_array_desc {\n\tint\tarray_offset;\t \n\tint\tcount_offset;\t \n\tint\tsize_offset;\t \n};\n\nstatic struct bpil_array_desc bpil_array_desc[] = {\n\t[PERF_BPIL_JITED_INSNS] = {\n\t\toffsetof(struct bpf_prog_info, jited_prog_insns),\n\t\toffsetof(struct bpf_prog_info, jited_prog_len),\n\t\t-1,\n\t},\n\t[PERF_BPIL_XLATED_INSNS] = {\n\t\toffsetof(struct bpf_prog_info, xlated_prog_insns),\n\t\toffsetof(struct bpf_prog_info, xlated_prog_len),\n\t\t-1,\n\t},\n\t[PERF_BPIL_MAP_IDS] = {\n\t\toffsetof(struct bpf_prog_info, map_ids),\n\t\toffsetof(struct bpf_prog_info, nr_map_ids),\n\t\t-(int)sizeof(__u32),\n\t},\n\t[PERF_BPIL_JITED_KSYMS] = {\n\t\toffsetof(struct bpf_prog_info, jited_ksyms),\n\t\toffsetof(struct bpf_prog_info, nr_jited_ksyms),\n\t\t-(int)sizeof(__u64),\n\t},\n\t[PERF_BPIL_JITED_FUNC_LENS] = {\n\t\toffsetof(struct bpf_prog_info, jited_func_lens),\n\t\toffsetof(struct bpf_prog_info, nr_jited_func_lens),\n\t\t-(int)sizeof(__u32),\n\t},\n\t[PERF_BPIL_FUNC_INFO] = {\n\t\toffsetof(struct bpf_prog_info, func_info),\n\t\toffsetof(struct bpf_prog_info, nr_func_info),\n\t\toffsetof(struct bpf_prog_info, func_info_rec_size),\n\t},\n\t[PERF_BPIL_LINE_INFO] = {\n\t\toffsetof(struct bpf_prog_info, line_info),\n\t\toffsetof(struct bpf_prog_info, nr_line_info),\n\t\toffsetof(struct bpf_prog_info, line_info_rec_size),\n\t},\n\t[PERF_BPIL_JITED_LINE_INFO] = {\n\t\toffsetof(struct bpf_prog_info, jited_line_info),\n\t\toffsetof(struct bpf_prog_info, nr_jited_line_info),\n\t\toffsetof(struct bpf_prog_info, jited_line_info_rec_size),\n\t},\n\t[PERF_BPIL_PROG_TAGS] = {\n\t\toffsetof(struct bpf_prog_info, prog_tags),\n\t\toffsetof(struct bpf_prog_info, nr_prog_tags),\n\t\t-(int)sizeof(__u8) * BPF_TAG_SIZE,\n\t},\n\n};\n\nstatic __u32 bpf_prog_info_read_offset_u32(struct bpf_prog_info *info,\n\t\t\t\t\t   int offset)\n{\n\t__u32 *array = (__u32 *)info;\n\n\tif (offset >= 0)\n\t\treturn array[offset / sizeof(__u32)];\n\treturn -(int)offset;\n}\n\nstatic __u64 bpf_prog_info_read_offset_u64(struct bpf_prog_info *info,\n\t\t\t\t\t   int offset)\n{\n\t__u64 *array = (__u64 *)info;\n\n\tif (offset >= 0)\n\t\treturn array[offset / sizeof(__u64)];\n\treturn -(int)offset;\n}\n\nstatic void bpf_prog_info_set_offset_u32(struct bpf_prog_info *info, int offset,\n\t\t\t\t\t __u32 val)\n{\n\t__u32 *array = (__u32 *)info;\n\n\tif (offset >= 0)\n\t\tarray[offset / sizeof(__u32)] = val;\n}\n\nstatic void bpf_prog_info_set_offset_u64(struct bpf_prog_info *info, int offset,\n\t\t\t\t\t __u64 val)\n{\n\t__u64 *array = (__u64 *)info;\n\n\tif (offset >= 0)\n\t\tarray[offset / sizeof(__u64)] = val;\n}\n\nstruct perf_bpil *\nget_bpf_prog_info_linear(int fd, __u64 arrays)\n{\n\tstruct bpf_prog_info info = {};\n\tstruct perf_bpil *info_linear;\n\t__u32 info_len = sizeof(info);\n\t__u32 data_len = 0;\n\tint i, err;\n\tvoid *ptr;\n\n\tif (arrays >> PERF_BPIL_LAST_ARRAY)\n\t\treturn ERR_PTR(-EINVAL);\n\n\t \n\terr = bpf_obj_get_info_by_fd(fd, &info, &info_len);\n\tif (err) {\n\t\tpr_debug(\"can't get prog info: %s\", strerror(errno));\n\t\treturn ERR_PTR(-EFAULT);\n\t}\n\n\t \n\tfor (i = PERF_BPIL_FIRST_ARRAY; i < PERF_BPIL_LAST_ARRAY; ++i) {\n\t\tbool include_array = (arrays & (1UL << i)) > 0;\n\t\tstruct bpil_array_desc *desc;\n\t\t__u32 count, size;\n\n\t\tdesc = bpil_array_desc + i;\n\n\t\t \n\t\tif (info_len < desc->array_offset + sizeof(__u32) ||\n\t\t    info_len < desc->count_offset + sizeof(__u32) ||\n\t\t    (desc->size_offset > 0 && info_len < (__u32)desc->size_offset))\n\t\t\tinclude_array = false;\n\n\t\tif (!include_array) {\n\t\t\tarrays &= ~(1UL << i);\t \n\t\t\tcontinue;\n\t\t}\n\n\t\tcount = bpf_prog_info_read_offset_u32(&info, desc->count_offset);\n\t\tsize  = bpf_prog_info_read_offset_u32(&info, desc->size_offset);\n\n\t\tdata_len += roundup(count * size, sizeof(__u64));\n\t}\n\n\t \n\tinfo_linear = malloc(sizeof(struct perf_bpil) + data_len);\n\tif (!info_linear)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\t \n\tinfo_linear->arrays = arrays;\n\tmemset(&info_linear->info, 0, sizeof(info));\n\tptr = info_linear->data;\n\n\tfor (i = PERF_BPIL_FIRST_ARRAY; i < PERF_BPIL_LAST_ARRAY; ++i) {\n\t\tstruct bpil_array_desc *desc;\n\t\t__u32 count, size;\n\n\t\tif ((arrays & (1UL << i)) == 0)\n\t\t\tcontinue;\n\n\t\tdesc  = bpil_array_desc + i;\n\t\tcount = bpf_prog_info_read_offset_u32(&info, desc->count_offset);\n\t\tsize  = bpf_prog_info_read_offset_u32(&info, desc->size_offset);\n\t\tbpf_prog_info_set_offset_u32(&info_linear->info,\n\t\t\t\t\t     desc->count_offset, count);\n\t\tbpf_prog_info_set_offset_u32(&info_linear->info,\n\t\t\t\t\t     desc->size_offset, size);\n\t\tbpf_prog_info_set_offset_u64(&info_linear->info,\n\t\t\t\t\t     desc->array_offset,\n\t\t\t\t\t     ptr_to_u64(ptr));\n\t\tptr += roundup(count * size, sizeof(__u64));\n\t}\n\n\t \n\terr = bpf_obj_get_info_by_fd(fd, &info_linear->info, &info_len);\n\tif (err) {\n\t\tpr_debug(\"can't get prog info: %s\", strerror(errno));\n\t\tfree(info_linear);\n\t\treturn ERR_PTR(-EFAULT);\n\t}\n\n\t \n\tfor (i = PERF_BPIL_FIRST_ARRAY; i < PERF_BPIL_LAST_ARRAY; ++i) {\n\t\tstruct bpil_array_desc *desc;\n\t\t__u32 v1, v2;\n\n\t\tif ((arrays & (1UL << i)) == 0)\n\t\t\tcontinue;\n\n\t\tdesc = bpil_array_desc + i;\n\t\tv1 = bpf_prog_info_read_offset_u32(&info, desc->count_offset);\n\t\tv2 = bpf_prog_info_read_offset_u32(&info_linear->info,\n\t\t\t\t\t\t   desc->count_offset);\n\t\tif (v1 != v2)\n\t\t\tpr_warning(\"%s: mismatch in element count\\n\", __func__);\n\n\t\tv1 = bpf_prog_info_read_offset_u32(&info, desc->size_offset);\n\t\tv2 = bpf_prog_info_read_offset_u32(&info_linear->info,\n\t\t\t\t\t\t   desc->size_offset);\n\t\tif (v1 != v2)\n\t\t\tpr_warning(\"%s: mismatch in rec size\\n\", __func__);\n\t}\n\n\t \n\tinfo_linear->info_len = sizeof(struct bpf_prog_info);\n\tinfo_linear->data_len = data_len;\n\n\treturn info_linear;\n}\n\nvoid bpil_addr_to_offs(struct perf_bpil *info_linear)\n{\n\tint i;\n\n\tfor (i = PERF_BPIL_FIRST_ARRAY; i < PERF_BPIL_LAST_ARRAY; ++i) {\n\t\tstruct bpil_array_desc *desc;\n\t\t__u64 addr, offs;\n\n\t\tif ((info_linear->arrays & (1UL << i)) == 0)\n\t\t\tcontinue;\n\n\t\tdesc = bpil_array_desc + i;\n\t\taddr = bpf_prog_info_read_offset_u64(&info_linear->info,\n\t\t\t\t\t\t     desc->array_offset);\n\t\toffs = addr - ptr_to_u64(info_linear->data);\n\t\tbpf_prog_info_set_offset_u64(&info_linear->info,\n\t\t\t\t\t     desc->array_offset, offs);\n\t}\n}\n\nvoid bpil_offs_to_addr(struct perf_bpil *info_linear)\n{\n\tint i;\n\n\tfor (i = PERF_BPIL_FIRST_ARRAY; i < PERF_BPIL_LAST_ARRAY; ++i) {\n\t\tstruct bpil_array_desc *desc;\n\t\t__u64 addr, offs;\n\n\t\tif ((info_linear->arrays & (1UL << i)) == 0)\n\t\t\tcontinue;\n\n\t\tdesc = bpil_array_desc + i;\n\t\toffs = bpf_prog_info_read_offset_u64(&info_linear->info,\n\t\t\t\t\t\t     desc->array_offset);\n\t\taddr = offs + ptr_to_u64(info_linear->data);\n\t\tbpf_prog_info_set_offset_u64(&info_linear->info,\n\t\t\t\t\t     desc->array_offset, addr);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}