{
  "module_name": "header.c",
  "hash_id": "7eb4885fd05bd47acbb7e88c731119ea484780e082c58ef4a0a718cc3f7014be",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/arch/x86/util/header.c",
  "human_readable_source": "\n#include <sys/types.h>\n#include <errno.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <regex.h>\n\n#include \"../../../util/debug.h\"\n#include \"../../../util/header.h\"\n#include \"cpuid.h\"\n\nvoid get_cpuid_0(char *vendor, unsigned int *lvl)\n{\n\tunsigned int b, c, d;\n\n\tcpuid(0, 0, lvl, &b, &c, &d);\n\tstrncpy(&vendor[0], (char *)(&b), 4);\n\tstrncpy(&vendor[4], (char *)(&d), 4);\n\tstrncpy(&vendor[8], (char *)(&c), 4);\n\tvendor[12] = '\\0';\n}\n\nstatic int\n__get_cpuid(char *buffer, size_t sz, const char *fmt)\n{\n\tunsigned int a, b, c, d, lvl;\n\tint family = -1, model = -1, step = -1;\n\tint nb;\n\tchar vendor[16];\n\n\tget_cpuid_0(vendor, &lvl);\n\n\tif (lvl >= 1) {\n\t\tcpuid(1, 0, &a, &b, &c, &d);\n\n\t\tfamily = (a >> 8) & 0xf;   \n\t\tmodel  = (a >> 4) & 0xf;   \n\t\tstep   = a & 0xf;\n\n\t\t \n\t\tif (family == 0xf)\n\t\t\tfamily += (a >> 20) & 0xff;\n\n\t\t \n\t\tif (family >= 0x6)\n\t\t\tmodel += ((a >> 16) & 0xf) << 4;\n\t}\n\tnb = scnprintf(buffer, sz, fmt, vendor, family, model, step);\n\n\t \n\tif (strchr(buffer, '$')) {\n\t\tbuffer[nb-1] = '\\0';\n\t\treturn 0;\n\t}\n\treturn ENOBUFS;\n}\n\nint\nget_cpuid(char *buffer, size_t sz)\n{\n\treturn __get_cpuid(buffer, sz, \"%s,%u,%u,%u$\");\n}\n\nchar *\nget_cpuid_str(struct perf_pmu *pmu __maybe_unused)\n{\n\tchar *buf = malloc(128);\n\n\tif (buf && __get_cpuid(buf, 128, \"%s-%u-%X-%X$\") < 0) {\n\t\tfree(buf);\n\t\treturn NULL;\n\t}\n\treturn buf;\n}\n\n \nstatic bool is_full_cpuid(const char *id)\n{\n\tconst char *tmp = id;\n\tint count = 0;\n\n\twhile ((tmp = strchr(tmp, '-')) != NULL) {\n\t\tcount++;\n\t\ttmp++;\n\t}\n\n\tif (count == 3)\n\t\treturn true;\n\n\treturn false;\n}\n\nint strcmp_cpuid_str(const char *mapcpuid, const char *id)\n{\n\tregex_t re;\n\tregmatch_t pmatch[1];\n\tint match;\n\tbool full_mapcpuid = is_full_cpuid(mapcpuid);\n\tbool full_cpuid = is_full_cpuid(id);\n\n\t \n\tif (full_mapcpuid && !full_cpuid) {\n\t\tpr_info(\"Invalid CPUID %s. Full CPUID is required, \"\n\t\t\t\"vendor-family-model-stepping\\n\", id);\n\t\treturn 1;\n\t}\n\n\tif (regcomp(&re, mapcpuid, REG_EXTENDED) != 0) {\n\t\t \n\t\tpr_info(\"Invalid regular expression %s\\n\", mapcpuid);\n\t\treturn 1;\n\t}\n\n\tmatch = !regexec(&re, id, 1, pmatch, 0);\n\tregfree(&re);\n\tif (match) {\n\t\tsize_t match_len = (pmatch[0].rm_eo - pmatch[0].rm_so);\n\t\tsize_t cpuid_len;\n\n\t\t \n\t\tif (!full_mapcpuid && full_cpuid)\n\t\t\tcpuid_len = strrchr(id, '-') - id;\n\t\telse\n\t\t\tcpuid_len = strlen(id);\n\n\t\t \n\t\tif (match_len == cpuid_len)\n\t\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}