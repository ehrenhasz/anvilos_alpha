{
  "module_name": "evsel.c",
  "hash_id": "07a4f8d6ed4d681dded2f53fa0b32fdad2e1a0a8648e820a861fa9f6902599ce",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/arch/x86/util/evsel.c",
  "human_readable_source": "\n#include <stdio.h>\n#include <stdlib.h>\n#include \"util/evsel.h\"\n#include \"util/env.h\"\n#include \"util/pmu.h\"\n#include \"util/pmus.h\"\n#include \"linux/string.h\"\n#include \"evsel.h\"\n#include \"util/debug.h\"\n#include \"env.h\"\n\n#define IBS_FETCH_L3MISSONLY   (1ULL << 59)\n#define IBS_OP_L3MISSONLY      (1ULL << 16)\n\nvoid arch_evsel__set_sample_weight(struct evsel *evsel)\n{\n\tevsel__set_sample_bit(evsel, WEIGHT_STRUCT);\n}\n\n \nbool evsel__sys_has_perf_metrics(const struct evsel *evsel)\n{\n\tconst char *pmu_name = evsel->pmu_name ? evsel->pmu_name : \"cpu\";\n\n\t \n\tif ((evsel->core.attr.type == PERF_TYPE_RAW) &&\n\t    perf_pmus__have_event(pmu_name, \"slots\"))\n\t\treturn true;\n\n\treturn false;\n}\n\nbool arch_evsel__must_be_in_group(const struct evsel *evsel)\n{\n\tif (!evsel__sys_has_perf_metrics(evsel) || !evsel->name ||\n\t    strcasestr(evsel->name, \"uops_retired.slots\"))\n\t\treturn false;\n\n\treturn strcasestr(evsel->name, \"topdown\") || strcasestr(evsel->name, \"slots\");\n}\n\nint arch_evsel__hw_name(struct evsel *evsel, char *bf, size_t size)\n{\n\tu64 event = evsel->core.attr.config & PERF_HW_EVENT_MASK;\n\tu64 pmu = evsel->core.attr.config >> PERF_PMU_TYPE_SHIFT;\n\tconst char *event_name;\n\n\tif (event < PERF_COUNT_HW_MAX && evsel__hw_names[event])\n\t\tevent_name = evsel__hw_names[event];\n\telse\n\t\tevent_name = \"unknown-hardware\";\n\n\t \n\tif (!pmu)\n\t\treturn  scnprintf(bf, size, \"%s\", event_name);\n\n\treturn scnprintf(bf, size, \"%s/%s/\",\n\t\t\t evsel->pmu_name ? evsel->pmu_name : \"cpu\",\n\t\t\t event_name);\n}\n\nstatic void ibs_l3miss_warn(void)\n{\n\tpr_warning(\n\"WARNING: Hw internally resets sampling period when L3 Miss Filtering is enabled\\n\"\n\"and tagged operation does not cause L3 Miss. This causes sampling period skew.\\n\");\n}\n\nvoid arch__post_evsel_config(struct evsel *evsel, struct perf_event_attr *attr)\n{\n\tstruct perf_pmu *evsel_pmu, *ibs_fetch_pmu, *ibs_op_pmu;\n\tstatic int warned_once;\n\n\tif (warned_once || !x86__is_amd_cpu())\n\t\treturn;\n\n\tevsel_pmu = evsel__find_pmu(evsel);\n\tif (!evsel_pmu)\n\t\treturn;\n\n\tibs_fetch_pmu = perf_pmus__find(\"ibs_fetch\");\n\tibs_op_pmu = perf_pmus__find(\"ibs_op\");\n\n\tif (ibs_fetch_pmu && ibs_fetch_pmu->type == evsel_pmu->type) {\n\t\tif (attr->config & IBS_FETCH_L3MISSONLY) {\n\t\t\tibs_l3miss_warn();\n\t\t\twarned_once = 1;\n\t\t}\n\t} else if (ibs_op_pmu && ibs_op_pmu->type == evsel_pmu->type) {\n\t\tif (attr->config & IBS_OP_L3MISSONLY) {\n\t\t\tibs_l3miss_warn();\n\t\t\twarned_once = 1;\n\t\t}\n\t}\n}\n\nint arch_evsel__open_strerror(struct evsel *evsel, char *msg, size_t size)\n{\n\tif (!x86__is_amd_cpu())\n\t\treturn 0;\n\n\tif (!evsel->core.attr.precise_ip &&\n\t    !(evsel->pmu_name && !strncmp(evsel->pmu_name, \"ibs\", 3)))\n\t\treturn 0;\n\n\t \n\tif (evsel->core.attr.exclude_kernel || evsel->core.attr.exclude_user ||\n\t    evsel->core.attr.exclude_hv || evsel->core.attr.exclude_idle ||\n\t    evsel->core.attr.exclude_host || evsel->core.attr.exclude_guest) {\n\t\treturn scnprintf(msg, size, \"AMD IBS doesn't support privilege filtering. Try \"\n\t\t\t\t \"again without the privilege modifiers (like 'k') at the end.\");\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}