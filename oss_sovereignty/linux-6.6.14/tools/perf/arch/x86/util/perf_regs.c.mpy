{
  "module_name": "perf_regs.c",
  "hash_id": "08c81167998d4e3de4b3bb8385f0a4a5afe2f2b664de8cb7b057473696cb1fca",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/arch/x86/util/perf_regs.c",
  "human_readable_source": "\n#include <errno.h>\n#include <string.h>\n#include <regex.h>\n#include <linux/kernel.h>\n#include <linux/zalloc.h>\n\n#include \"perf_regs.h\"\n#include \"../../../perf-sys.h\"\n#include \"../../../util/perf_regs.h\"\n#include \"../../../util/debug.h\"\n#include \"../../../util/event.h\"\n#include \"../../../util/pmu.h\"\n#include \"../../../util/pmus.h\"\n\nconst struct sample_reg sample_reg_masks[] = {\n\tSMPL_REG(AX, PERF_REG_X86_AX),\n\tSMPL_REG(BX, PERF_REG_X86_BX),\n\tSMPL_REG(CX, PERF_REG_X86_CX),\n\tSMPL_REG(DX, PERF_REG_X86_DX),\n\tSMPL_REG(SI, PERF_REG_X86_SI),\n\tSMPL_REG(DI, PERF_REG_X86_DI),\n\tSMPL_REG(BP, PERF_REG_X86_BP),\n\tSMPL_REG(SP, PERF_REG_X86_SP),\n\tSMPL_REG(IP, PERF_REG_X86_IP),\n\tSMPL_REG(FLAGS, PERF_REG_X86_FLAGS),\n\tSMPL_REG(CS, PERF_REG_X86_CS),\n\tSMPL_REG(SS, PERF_REG_X86_SS),\n#ifdef HAVE_ARCH_X86_64_SUPPORT\n\tSMPL_REG(R8, PERF_REG_X86_R8),\n\tSMPL_REG(R9, PERF_REG_X86_R9),\n\tSMPL_REG(R10, PERF_REG_X86_R10),\n\tSMPL_REG(R11, PERF_REG_X86_R11),\n\tSMPL_REG(R12, PERF_REG_X86_R12),\n\tSMPL_REG(R13, PERF_REG_X86_R13),\n\tSMPL_REG(R14, PERF_REG_X86_R14),\n\tSMPL_REG(R15, PERF_REG_X86_R15),\n#endif\n\tSMPL_REG2(XMM0, PERF_REG_X86_XMM0),\n\tSMPL_REG2(XMM1, PERF_REG_X86_XMM1),\n\tSMPL_REG2(XMM2, PERF_REG_X86_XMM2),\n\tSMPL_REG2(XMM3, PERF_REG_X86_XMM3),\n\tSMPL_REG2(XMM4, PERF_REG_X86_XMM4),\n\tSMPL_REG2(XMM5, PERF_REG_X86_XMM5),\n\tSMPL_REG2(XMM6, PERF_REG_X86_XMM6),\n\tSMPL_REG2(XMM7, PERF_REG_X86_XMM7),\n\tSMPL_REG2(XMM8, PERF_REG_X86_XMM8),\n\tSMPL_REG2(XMM9, PERF_REG_X86_XMM9),\n\tSMPL_REG2(XMM10, PERF_REG_X86_XMM10),\n\tSMPL_REG2(XMM11, PERF_REG_X86_XMM11),\n\tSMPL_REG2(XMM12, PERF_REG_X86_XMM12),\n\tSMPL_REG2(XMM13, PERF_REG_X86_XMM13),\n\tSMPL_REG2(XMM14, PERF_REG_X86_XMM14),\n\tSMPL_REG2(XMM15, PERF_REG_X86_XMM15),\n\tSMPL_REG_END\n};\n\nstruct sdt_name_reg {\n\tconst char *sdt_name;\n\tconst char *uprobe_name;\n};\n#define SDT_NAME_REG(n, m) {.sdt_name = \"%\" #n, .uprobe_name = \"%\" #m}\n#define SDT_NAME_REG_END {.sdt_name = NULL, .uprobe_name = NULL}\n\nstatic const struct sdt_name_reg sdt_reg_tbl[] = {\n\tSDT_NAME_REG(eax, ax),\n\tSDT_NAME_REG(rax, ax),\n\tSDT_NAME_REG(al,  ax),\n\tSDT_NAME_REG(ah,  ax),\n\tSDT_NAME_REG(ebx, bx),\n\tSDT_NAME_REG(rbx, bx),\n\tSDT_NAME_REG(bl,  bx),\n\tSDT_NAME_REG(bh,  bx),\n\tSDT_NAME_REG(ecx, cx),\n\tSDT_NAME_REG(rcx, cx),\n\tSDT_NAME_REG(cl,  cx),\n\tSDT_NAME_REG(ch,  cx),\n\tSDT_NAME_REG(edx, dx),\n\tSDT_NAME_REG(rdx, dx),\n\tSDT_NAME_REG(dl,  dx),\n\tSDT_NAME_REG(dh,  dx),\n\tSDT_NAME_REG(esi, si),\n\tSDT_NAME_REG(rsi, si),\n\tSDT_NAME_REG(sil, si),\n\tSDT_NAME_REG(edi, di),\n\tSDT_NAME_REG(rdi, di),\n\tSDT_NAME_REG(dil, di),\n\tSDT_NAME_REG(ebp, bp),\n\tSDT_NAME_REG(rbp, bp),\n\tSDT_NAME_REG(bpl, bp),\n\tSDT_NAME_REG(rsp, sp),\n\tSDT_NAME_REG(esp, sp),\n\tSDT_NAME_REG(spl, sp),\n\n\t \n\tSDT_NAME_REG(r8b,  r8),\n\tSDT_NAME_REG(r8w,  r8),\n\tSDT_NAME_REG(r8d,  r8),\n\tSDT_NAME_REG(r9b,  r9),\n\tSDT_NAME_REG(r9w,  r9),\n\tSDT_NAME_REG(r9d,  r9),\n\tSDT_NAME_REG(r10b, r10),\n\tSDT_NAME_REG(r10w, r10),\n\tSDT_NAME_REG(r10d, r10),\n\tSDT_NAME_REG(r11b, r11),\n\tSDT_NAME_REG(r11w, r11),\n\tSDT_NAME_REG(r11d, r11),\n\tSDT_NAME_REG(r12b, r12),\n\tSDT_NAME_REG(r12w, r12),\n\tSDT_NAME_REG(r12d, r12),\n\tSDT_NAME_REG(r13b, r13),\n\tSDT_NAME_REG(r13w, r13),\n\tSDT_NAME_REG(r13d, r13),\n\tSDT_NAME_REG(r14b, r14),\n\tSDT_NAME_REG(r14w, r14),\n\tSDT_NAME_REG(r14d, r14),\n\tSDT_NAME_REG(r15b, r15),\n\tSDT_NAME_REG(r15w, r15),\n\tSDT_NAME_REG(r15d, r15),\n\tSDT_NAME_REG_END,\n};\n\n \n#define SDT_OP_REGEX  \"^([+\\\\-]?)([0-9]*)(\\\\(?)(%[a-z][a-z0-9]+)(\\\\)?)$\"\n\nstatic regex_t sdt_op_regex;\n\nstatic int sdt_init_op_regex(void)\n{\n\tstatic int initialized;\n\tint ret = 0;\n\n\tif (initialized)\n\t\treturn 0;\n\n\tret = regcomp(&sdt_op_regex, SDT_OP_REGEX, REG_EXTENDED);\n\tif (ret < 0) {\n\t\tpr_debug4(\"Regex compilation error.\\n\");\n\t\treturn ret;\n\t}\n\n\tinitialized = 1;\n\treturn 0;\n}\n\n \n#define SDT_REG_NAME_SIZE  6\n\n \nstatic void sdt_rename_register(char *sdt_reg, int sdt_len, char *uprobe_reg)\n{\n\tint i = 0;\n\n\tfor (i = 0; sdt_reg_tbl[i].sdt_name != NULL; i++) {\n\t\tif (!strncmp(sdt_reg_tbl[i].sdt_name, sdt_reg, sdt_len)) {\n\t\t\tstrcpy(uprobe_reg, sdt_reg_tbl[i].uprobe_name);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tstrncpy(uprobe_reg, sdt_reg, sdt_len);\n}\n\nint arch_sdt_arg_parse_op(char *old_op, char **new_op)\n{\n\tchar new_reg[SDT_REG_NAME_SIZE] = {0};\n\tint new_len = 0, ret;\n\t \n\tregmatch_t rm[6];\n\t \n\tchar prefix[3] = {0};\n\n\tret = sdt_init_op_regex();\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tif (strchr(old_op, ',') || strchr(old_op, '$') ||\n\t    regexec(&sdt_op_regex, old_op, 6, rm, 0)   ||\n\t    rm[4].rm_eo - rm[4].rm_so > SDT_REG_NAME_SIZE) {\n\t\tpr_debug4(\"Skipping unsupported SDT argument: %s\\n\", old_op);\n\t\treturn SDT_ARG_SKIP;\n\t}\n\n\t \n\tif (rm[3].rm_so != rm[3].rm_eo) {\n\t\tif (rm[1].rm_so != rm[1].rm_eo)\n\t\t\tprefix[0] = *(old_op + rm[1].rm_so);\n\t\telse if (rm[2].rm_so != rm[2].rm_eo)\n\t\t\tprefix[0] = '+';\n\t\telse\n\t\t\tscnprintf(prefix, sizeof(prefix), \"+0\");\n\t}\n\n\t \n\tsdt_rename_register(old_op + rm[4].rm_so, rm[4].rm_eo - rm[4].rm_so,\n\t\t\t    new_reg);\n\n\t \n\tnew_len = strlen(prefix)              +\n\t\t  (rm[2].rm_eo - rm[2].rm_so) +\n\t\t  (rm[3].rm_eo - rm[3].rm_so) +\n\t\t  strlen(new_reg)             +\n\t\t  (rm[5].rm_eo - rm[5].rm_so) +\n\t\t  1;\t\t\t\t\t \n\n\t*new_op = zalloc(new_len);\n\tif (!*new_op)\n\t\treturn -ENOMEM;\n\n\tscnprintf(*new_op, new_len, \"%.*s%.*s%.*s%.*s%.*s\",\n\t\t  strlen(prefix), prefix,\n\t\t  (int)(rm[2].rm_eo - rm[2].rm_so), old_op + rm[2].rm_so,\n\t\t  (int)(rm[3].rm_eo - rm[3].rm_so), old_op + rm[3].rm_so,\n\t\t  strlen(new_reg), new_reg,\n\t\t  (int)(rm[5].rm_eo - rm[5].rm_so), old_op + rm[5].rm_so);\n\n\treturn SDT_ARG_VALID;\n}\n\nuint64_t arch__intr_reg_mask(void)\n{\n\tstruct perf_event_attr attr = {\n\t\t.type\t\t\t= PERF_TYPE_HARDWARE,\n\t\t.config\t\t\t= PERF_COUNT_HW_CPU_CYCLES,\n\t\t.sample_type\t\t= PERF_SAMPLE_REGS_INTR,\n\t\t.sample_regs_intr\t= PERF_REG_EXTENDED_MASK,\n\t\t.precise_ip\t\t= 1,\n\t\t.disabled \t\t= 1,\n\t\t.exclude_kernel\t\t= 1,\n\t};\n\tint fd;\n\t \n\tattr.sample_period = 1;\n\n\tif (perf_pmus__num_core_pmus() > 1) {\n\t\tstruct perf_pmu *pmu = NULL;\n\t\t__u64 type = PERF_TYPE_RAW;\n\n\t\t \n\t\twhile ((pmu = perf_pmus__scan_core(pmu)) != NULL) {\n\t\t\ttype = pmu->type;\n\t\t\tbreak;\n\t\t}\n\t\tattr.config |= type << PERF_PMU_TYPE_SHIFT;\n\t}\n\n\tevent_attr_init(&attr);\n\n\tfd = sys_perf_event_open(&attr, 0, -1, -1, 0);\n\tif (fd != -1) {\n\t\tclose(fd);\n\t\treturn (PERF_REG_EXTENDED_MASK | PERF_REGS_MASK);\n\t}\n\n\treturn PERF_REGS_MASK;\n}\n\nuint64_t arch__user_reg_mask(void)\n{\n\treturn PERF_REGS_MASK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}