{
  "module_name": "perf_regs.c",
  "hash_id": "03ba40a34e187a98feddbe2b2d2b7f621484357d9ea19b9e34e9032672945947",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/arch/powerpc/util/perf_regs.c",
  "human_readable_source": "\n#include <errno.h>\n#include <string.h>\n#include <regex.h>\n#include <linux/zalloc.h>\n\n#include \"perf_regs.h\"\n#include \"../../../util/perf_regs.h\"\n#include \"../../../util/debug.h\"\n#include \"../../../util/event.h\"\n#include \"../../../util/header.h\"\n#include \"../../../perf-sys.h\"\n#include \"utils_header.h\"\n\n#include <linux/kernel.h>\n\n#define PVR_POWER9\t\t0x004E\n#define PVR_POWER10\t\t0x0080\n\nconst struct sample_reg sample_reg_masks[] = {\n\tSMPL_REG(r0, PERF_REG_POWERPC_R0),\n\tSMPL_REG(r1, PERF_REG_POWERPC_R1),\n\tSMPL_REG(r2, PERF_REG_POWERPC_R2),\n\tSMPL_REG(r3, PERF_REG_POWERPC_R3),\n\tSMPL_REG(r4, PERF_REG_POWERPC_R4),\n\tSMPL_REG(r5, PERF_REG_POWERPC_R5),\n\tSMPL_REG(r6, PERF_REG_POWERPC_R6),\n\tSMPL_REG(r7, PERF_REG_POWERPC_R7),\n\tSMPL_REG(r8, PERF_REG_POWERPC_R8),\n\tSMPL_REG(r9, PERF_REG_POWERPC_R9),\n\tSMPL_REG(r10, PERF_REG_POWERPC_R10),\n\tSMPL_REG(r11, PERF_REG_POWERPC_R11),\n\tSMPL_REG(r12, PERF_REG_POWERPC_R12),\n\tSMPL_REG(r13, PERF_REG_POWERPC_R13),\n\tSMPL_REG(r14, PERF_REG_POWERPC_R14),\n\tSMPL_REG(r15, PERF_REG_POWERPC_R15),\n\tSMPL_REG(r16, PERF_REG_POWERPC_R16),\n\tSMPL_REG(r17, PERF_REG_POWERPC_R17),\n\tSMPL_REG(r18, PERF_REG_POWERPC_R18),\n\tSMPL_REG(r19, PERF_REG_POWERPC_R19),\n\tSMPL_REG(r20, PERF_REG_POWERPC_R20),\n\tSMPL_REG(r21, PERF_REG_POWERPC_R21),\n\tSMPL_REG(r22, PERF_REG_POWERPC_R22),\n\tSMPL_REG(r23, PERF_REG_POWERPC_R23),\n\tSMPL_REG(r24, PERF_REG_POWERPC_R24),\n\tSMPL_REG(r25, PERF_REG_POWERPC_R25),\n\tSMPL_REG(r26, PERF_REG_POWERPC_R26),\n\tSMPL_REG(r27, PERF_REG_POWERPC_R27),\n\tSMPL_REG(r28, PERF_REG_POWERPC_R28),\n\tSMPL_REG(r29, PERF_REG_POWERPC_R29),\n\tSMPL_REG(r30, PERF_REG_POWERPC_R30),\n\tSMPL_REG(r31, PERF_REG_POWERPC_R31),\n\tSMPL_REG(nip, PERF_REG_POWERPC_NIP),\n\tSMPL_REG(msr, PERF_REG_POWERPC_MSR),\n\tSMPL_REG(orig_r3, PERF_REG_POWERPC_ORIG_R3),\n\tSMPL_REG(ctr, PERF_REG_POWERPC_CTR),\n\tSMPL_REG(link, PERF_REG_POWERPC_LINK),\n\tSMPL_REG(xer, PERF_REG_POWERPC_XER),\n\tSMPL_REG(ccr, PERF_REG_POWERPC_CCR),\n\tSMPL_REG(softe, PERF_REG_POWERPC_SOFTE),\n\tSMPL_REG(trap, PERF_REG_POWERPC_TRAP),\n\tSMPL_REG(dar, PERF_REG_POWERPC_DAR),\n\tSMPL_REG(dsisr, PERF_REG_POWERPC_DSISR),\n\tSMPL_REG(sier, PERF_REG_POWERPC_SIER),\n\tSMPL_REG(mmcra, PERF_REG_POWERPC_MMCRA),\n\tSMPL_REG(mmcr0, PERF_REG_POWERPC_MMCR0),\n\tSMPL_REG(mmcr1, PERF_REG_POWERPC_MMCR1),\n\tSMPL_REG(mmcr2, PERF_REG_POWERPC_MMCR2),\n\tSMPL_REG(mmcr3, PERF_REG_POWERPC_MMCR3),\n\tSMPL_REG(sier2, PERF_REG_POWERPC_SIER2),\n\tSMPL_REG(sier3, PERF_REG_POWERPC_SIER3),\n\tSMPL_REG(pmc1, PERF_REG_POWERPC_PMC1),\n\tSMPL_REG(pmc2, PERF_REG_POWERPC_PMC2),\n\tSMPL_REG(pmc3, PERF_REG_POWERPC_PMC3),\n\tSMPL_REG(pmc4, PERF_REG_POWERPC_PMC4),\n\tSMPL_REG(pmc5, PERF_REG_POWERPC_PMC5),\n\tSMPL_REG(pmc6, PERF_REG_POWERPC_PMC6),\n\tSMPL_REG(sdar, PERF_REG_POWERPC_SDAR),\n\tSMPL_REG(siar, PERF_REG_POWERPC_SIAR),\n\tSMPL_REG_END\n};\n\n \n#define SDT_OP_REGEX1  \"^(%r)?([1-2]?[0-9]|3[0-1])$\"\n\n \n#define SDT_OP_REGEX2  \"^(\\\\-)?([0-9]+)\\\\((%r)?([1-2]?[0-9]|3[0-1])\\\\)$\"\n\nstatic regex_t sdt_op_regex1, sdt_op_regex2;\n\nstatic int sdt_init_op_regex(void)\n{\n\tstatic int initialized;\n\tint ret = 0;\n\n\tif (initialized)\n\t\treturn 0;\n\n\tret = regcomp(&sdt_op_regex1, SDT_OP_REGEX1, REG_EXTENDED);\n\tif (ret)\n\t\tgoto error;\n\n\tret = regcomp(&sdt_op_regex2, SDT_OP_REGEX2, REG_EXTENDED);\n\tif (ret)\n\t\tgoto free_regex1;\n\n\tinitialized = 1;\n\treturn 0;\n\nfree_regex1:\n\tregfree(&sdt_op_regex1);\nerror:\n\tpr_debug4(\"Regex compilation error.\\n\");\n\treturn ret;\n}\n\n \nint arch_sdt_arg_parse_op(char *old_op, char **new_op)\n{\n\tint ret, new_len;\n\tregmatch_t rm[5];\n\tchar prefix;\n\n\t \n\tif (old_op[0] == 'i') {\n\t\tpr_debug4(\"Skipping unsupported SDT argument: %s\\n\", old_op);\n\t\treturn SDT_ARG_SKIP;\n\t}\n\n\tret = sdt_init_op_regex();\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (!regexec(&sdt_op_regex1, old_op, 3, rm, 0)) {\n\t\t \n\n\t\tnew_len = 5;\t \n\t\tnew_len += (int)(rm[2].rm_eo - rm[2].rm_so);\n\n\t\t*new_op = zalloc(new_len);\n\t\tif (!*new_op)\n\t\t\treturn -ENOMEM;\n\n\t\tscnprintf(*new_op, new_len, \"%%gpr%.*s\",\n\t\t\t(int)(rm[2].rm_eo - rm[2].rm_so), old_op + rm[2].rm_so);\n\t} else if (!regexec(&sdt_op_regex2, old_op, 5, rm, 0)) {\n\t\t \n\t\tprefix = (rm[1].rm_so == -1) ? '+' : '-';\n\n\t\tnew_len = 8;\t \n\t\tnew_len += (int)(rm[2].rm_eo - rm[2].rm_so);\n\t\tnew_len += (int)(rm[4].rm_eo - rm[4].rm_so);\n\n\t\t*new_op = zalloc(new_len);\n\t\tif (!*new_op)\n\t\t\treturn -ENOMEM;\n\n\t\tscnprintf(*new_op, new_len, \"%c%.*s(%%gpr%.*s)\", prefix,\n\t\t\t(int)(rm[2].rm_eo - rm[2].rm_so), old_op + rm[2].rm_so,\n\t\t\t(int)(rm[4].rm_eo - rm[4].rm_so), old_op + rm[4].rm_so);\n\t} else {\n\t\tpr_debug4(\"Skipping unsupported SDT argument: %s\\n\", old_op);\n\t\treturn SDT_ARG_SKIP;\n\t}\n\n\treturn SDT_ARG_VALID;\n}\n\nuint64_t arch__intr_reg_mask(void)\n{\n\tstruct perf_event_attr attr = {\n\t\t.type                   = PERF_TYPE_HARDWARE,\n\t\t.config                 = PERF_COUNT_HW_CPU_CYCLES,\n\t\t.sample_type            = PERF_SAMPLE_REGS_INTR,\n\t\t.precise_ip             = 1,\n\t\t.disabled               = 1,\n\t\t.exclude_kernel         = 1,\n\t};\n\tint fd;\n\tu32 version;\n\tu64 extended_mask = 0, mask = PERF_REGS_MASK;\n\n\t \n\tversion = (((mfspr(SPRN_PVR)) >>  16) & 0xFFFF);\n\tif (version == PVR_POWER9)\n\t\textended_mask = PERF_REG_PMU_MASK_300;\n\telse if (version == PVR_POWER10)\n\t\textended_mask = PERF_REG_PMU_MASK_31;\n\telse\n\t\treturn mask;\n\n\tattr.sample_regs_intr = extended_mask;\n\tattr.sample_period = 1;\n\tevent_attr_init(&attr);\n\n\t \n\tfd = sys_perf_event_open(&attr, 0, -1, -1, 0);\n\tif (fd != -1) {\n\t\tclose(fd);\n\t\tmask |= extended_mask;\n\t}\n\treturn mask;\n}\n\nuint64_t arch__user_reg_mask(void)\n{\n\treturn PERF_REGS_MASK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}