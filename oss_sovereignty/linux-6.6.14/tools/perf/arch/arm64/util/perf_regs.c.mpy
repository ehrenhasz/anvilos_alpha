{
  "module_name": "perf_regs.c",
  "hash_id": "13402f49cf2e66c7822fa0cd3ad59a2e463300ec93ac4a2e29f6f3378cf54a56",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/arch/arm64/util/perf_regs.c",
  "human_readable_source": "\n#include <errno.h>\n#include <regex.h>\n#include <string.h>\n#include <sys/auxv.h>\n#include <linux/kernel.h>\n#include <linux/zalloc.h>\n\n#include \"perf_regs.h\"\n#include \"../../../perf-sys.h\"\n#include \"../../../util/debug.h\"\n#include \"../../../util/event.h\"\n#include \"../../../util/perf_regs.h\"\n\n#ifndef HWCAP_SVE\n#define HWCAP_SVE\t(1 << 22)\n#endif\n\nconst struct sample_reg sample_reg_masks[] = {\n\tSMPL_REG(x0, PERF_REG_ARM64_X0),\n\tSMPL_REG(x1, PERF_REG_ARM64_X1),\n\tSMPL_REG(x2, PERF_REG_ARM64_X2),\n\tSMPL_REG(x3, PERF_REG_ARM64_X3),\n\tSMPL_REG(x4, PERF_REG_ARM64_X4),\n\tSMPL_REG(x5, PERF_REG_ARM64_X5),\n\tSMPL_REG(x6, PERF_REG_ARM64_X6),\n\tSMPL_REG(x7, PERF_REG_ARM64_X7),\n\tSMPL_REG(x8, PERF_REG_ARM64_X8),\n\tSMPL_REG(x9, PERF_REG_ARM64_X9),\n\tSMPL_REG(x10, PERF_REG_ARM64_X10),\n\tSMPL_REG(x11, PERF_REG_ARM64_X11),\n\tSMPL_REG(x12, PERF_REG_ARM64_X12),\n\tSMPL_REG(x13, PERF_REG_ARM64_X13),\n\tSMPL_REG(x14, PERF_REG_ARM64_X14),\n\tSMPL_REG(x15, PERF_REG_ARM64_X15),\n\tSMPL_REG(x16, PERF_REG_ARM64_X16),\n\tSMPL_REG(x17, PERF_REG_ARM64_X17),\n\tSMPL_REG(x18, PERF_REG_ARM64_X18),\n\tSMPL_REG(x19, PERF_REG_ARM64_X19),\n\tSMPL_REG(x20, PERF_REG_ARM64_X20),\n\tSMPL_REG(x21, PERF_REG_ARM64_X21),\n\tSMPL_REG(x22, PERF_REG_ARM64_X22),\n\tSMPL_REG(x23, PERF_REG_ARM64_X23),\n\tSMPL_REG(x24, PERF_REG_ARM64_X24),\n\tSMPL_REG(x25, PERF_REG_ARM64_X25),\n\tSMPL_REG(x26, PERF_REG_ARM64_X26),\n\tSMPL_REG(x27, PERF_REG_ARM64_X27),\n\tSMPL_REG(x28, PERF_REG_ARM64_X28),\n\tSMPL_REG(x29, PERF_REG_ARM64_X29),\n\tSMPL_REG(lr, PERF_REG_ARM64_LR),\n\tSMPL_REG(sp, PERF_REG_ARM64_SP),\n\tSMPL_REG(pc, PERF_REG_ARM64_PC),\n\tSMPL_REG(vg, PERF_REG_ARM64_VG),\n\tSMPL_REG_END\n};\n\n \n#define SDT_OP_REGEX1  \"^(x[1-2]?[0-9]|3[0-1])$\"\n\n \n#define SDT_OP_REGEX2  \"^\\\\[sp(, )?([0-9]+)?\\\\]$\"\n\nstatic regex_t sdt_op_regex1, sdt_op_regex2;\n\nstatic int sdt_init_op_regex(void)\n{\n\tstatic int initialized;\n\tint ret = 0;\n\n\tif (initialized)\n\t\treturn 0;\n\n\tret = regcomp(&sdt_op_regex1, SDT_OP_REGEX1, REG_EXTENDED);\n\tif (ret)\n\t\tgoto error;\n\n\tret = regcomp(&sdt_op_regex2, SDT_OP_REGEX2, REG_EXTENDED);\n\tif (ret)\n\t\tgoto free_regex1;\n\n\tinitialized = 1;\n\treturn 0;\n\nfree_regex1:\n\tregfree(&sdt_op_regex1);\nerror:\n\tpr_debug4(\"Regex compilation error.\\n\");\n\treturn ret;\n}\n\n \nint arch_sdt_arg_parse_op(char *old_op, char **new_op)\n{\n\tint ret, new_len;\n\tregmatch_t rm[5];\n\n\tret = sdt_init_op_regex();\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (!regexec(&sdt_op_regex1, old_op, 3, rm, 0)) {\n\t\t \n\t\tnew_len = 2;\t \n\t\tnew_len += (int)(rm[1].rm_eo - rm[1].rm_so);\n\n\t\t*new_op = zalloc(new_len);\n\t\tif (!*new_op)\n\t\t\treturn -ENOMEM;\n\n\t\tscnprintf(*new_op, new_len, \"%%%.*s\",\n\t\t\t(int)(rm[1].rm_eo - rm[1].rm_so), old_op + rm[1].rm_so);\n\t} else if (!regexec(&sdt_op_regex2, old_op, 5, rm, 0)) {\n\t\t \n\t\tnew_len = 7;\t \n\n\t\t \n\t\tif (rm[2].rm_so == -1)\n\t\t\tnew_len += 1;\n\t\telse\n\t\t\tnew_len += (int)(rm[2].rm_eo - rm[2].rm_so);\n\n\t\t*new_op = zalloc(new_len);\n\t\tif (!*new_op)\n\t\t\treturn -ENOMEM;\n\n\t\tif (rm[2].rm_so == -1)\n\t\t\tscnprintf(*new_op, new_len, \"+0(%%sp)\");\n\t\telse\n\t\t\tscnprintf(*new_op, new_len, \"+%.*s(%%sp)\",\n\t\t\t\t  (int)(rm[2].rm_eo - rm[2].rm_so),\n\t\t\t\t  old_op + rm[2].rm_so);\n\t} else {\n\t\tpr_debug4(\"Skipping unsupported SDT argument: %s\\n\", old_op);\n\t\treturn SDT_ARG_SKIP;\n\t}\n\n\treturn SDT_ARG_VALID;\n}\n\nuint64_t arch__intr_reg_mask(void)\n{\n\treturn PERF_REGS_MASK;\n}\n\nuint64_t arch__user_reg_mask(void)\n{\n\tstruct perf_event_attr attr = {\n\t\t.type                   = PERF_TYPE_HARDWARE,\n\t\t.config                 = PERF_COUNT_HW_CPU_CYCLES,\n\t\t.sample_type            = PERF_SAMPLE_REGS_USER,\n\t\t.disabled               = 1,\n\t\t.exclude_kernel         = 1,\n\t\t.sample_period\t\t= 1,\n\t\t.sample_regs_user\t= PERF_REGS_MASK\n\t};\n\tint fd;\n\n\tif (getauxval(AT_HWCAP) & HWCAP_SVE)\n\t\tattr.sample_regs_user |= SMPL_REG_MASK(PERF_REG_ARM64_VG);\n\n\t \n\tif (attr.sample_regs_user != PERF_REGS_MASK) {\n\t\tevent_attr_init(&attr);\n\t\tfd = sys_perf_event_open(&attr, 0, -1, -1, 0);\n\t\tif (fd != -1) {\n\t\t\tclose(fd);\n\t\t\treturn attr.sample_regs_user;\n\t\t}\n\t}\n\treturn PERF_REGS_MASK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}