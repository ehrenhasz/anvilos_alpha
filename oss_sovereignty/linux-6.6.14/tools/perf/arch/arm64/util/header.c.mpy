{
  "module_name": "header.c",
  "hash_id": "3e4637d84009828e4b76e7fcc25b631d24a4c9de8d91f7f914dfa7c8a0fe1a94",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/arch/arm64/util/header.c",
  "human_readable_source": "#include <linux/kernel.h>\n#include <linux/bits.h>\n#include <linux/bitfield.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <perf/cpumap.h>\n#include <util/cpumap.h>\n#include <internal/cpumap.h>\n#include <api/fs/fs.h>\n#include <errno.h>\n#include \"debug.h\"\n#include \"header.h\"\n\n#define MIDR \"/regs/identification/midr_el1\"\n#define MIDR_SIZE 19\n#define MIDR_REVISION_MASK      GENMASK(3, 0)\n#define MIDR_VARIANT_MASK\tGENMASK(23, 20)\n\nstatic int _get_cpuid(char *buf, size_t sz, struct perf_cpu_map *cpus)\n{\n\tconst char *sysfs = sysfs__mountpoint();\n\tint cpu;\n\tint ret = EINVAL;\n\n\tif (!sysfs || sz < MIDR_SIZE)\n\t\treturn EINVAL;\n\n\tcpus = perf_cpu_map__get(cpus);\n\n\tfor (cpu = 0; cpu < perf_cpu_map__nr(cpus); cpu++) {\n\t\tchar path[PATH_MAX];\n\t\tFILE *file;\n\n\t\tscnprintf(path, PATH_MAX, \"%s/devices/system/cpu/cpu%d\" MIDR,\n\t\t\t  sysfs, RC_CHK_ACCESS(cpus)->map[cpu].cpu);\n\n\t\tfile = fopen(path, \"r\");\n\t\tif (!file) {\n\t\t\tpr_debug(\"fopen failed for file %s\\n\", path);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!fgets(buf, MIDR_SIZE, file)) {\n\t\t\tfclose(file);\n\t\t\tcontinue;\n\t\t}\n\t\tfclose(file);\n\n\t\t \n\t\tret = 0;\n\t\tbreak;\n\t}\n\n\tperf_cpu_map__put(cpus);\n\treturn ret;\n}\n\nint get_cpuid(char *buf, size_t sz)\n{\n\tstruct perf_cpu_map *cpus = perf_cpu_map__new(NULL);\n\tint ret;\n\n\tif (!cpus)\n\t\treturn EINVAL;\n\n\tret = _get_cpuid(buf, sz, cpus);\n\n\tperf_cpu_map__put(cpus);\n\n\treturn ret;\n}\n\nchar *get_cpuid_str(struct perf_pmu *pmu)\n{\n\tchar *buf = NULL;\n\tint res;\n\n\tif (!pmu || !pmu->cpus)\n\t\treturn NULL;\n\n\tbuf = malloc(MIDR_SIZE);\n\tif (!buf)\n\t\treturn NULL;\n\n\t \n\tres = _get_cpuid(buf, MIDR_SIZE, pmu->cpus);\n\tif (res) {\n\t\tpr_err(\"failed to get cpuid string for PMU %s\\n\", pmu->name);\n\t\tfree(buf);\n\t\tbuf = NULL;\n\t}\n\n\treturn buf;\n}\n\n \nint strcmp_cpuid_str(const char *mapcpuid, const char *idstr)\n{\n\tu64 map_id = strtoull(mapcpuid, NULL, 16);\n\tchar map_id_variant = FIELD_GET(MIDR_VARIANT_MASK, map_id);\n\tchar map_id_revision = FIELD_GET(MIDR_REVISION_MASK, map_id);\n\tu64 id = strtoull(idstr, NULL, 16);\n\tchar id_variant = FIELD_GET(MIDR_VARIANT_MASK, id);\n\tchar id_revision = FIELD_GET(MIDR_REVISION_MASK, id);\n\tu64 id_fields = ~(MIDR_VARIANT_MASK | MIDR_REVISION_MASK);\n\n\t \n\tif ((map_id & id_fields) != (id & id_fields))\n\t\treturn 1;\n\n\t \n\tif (id_variant > map_id_variant)\n\t\treturn 0;\n\n\tif (id_variant == map_id_variant && id_revision >= map_id_revision)\n\t\treturn 0;\n\n\t \n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}