{
  "module_name": "metric_test.py",
  "hash_id": "2013783a9cccf2b1df21171b0309593f6f5dac55956d58f873290f28f602480a",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/pmu-events/metric_test.py",
  "human_readable_source": "#!/usr/bin/env python3\n# SPDX-License-Identifier: (LGPL-2.1 OR BSD-2-Clause)\nimport unittest\nfrom metric import Constant\nfrom metric import Event\nfrom metric import Expression\nfrom metric import ParsePerfJson\nfrom metric import RewriteMetricsInTermsOfOthers\n\n\nclass TestMetricExpressions(unittest.TestCase):\n\n  def test_Operators(self):\n    a = Event('a')\n    b = Event('b')\n    self.assertEqual((a | b).ToPerfJson(), 'a | b')\n    self.assertEqual((a ^ b).ToPerfJson(), 'a ^ b')\n    self.assertEqual((a & b).ToPerfJson(), 'a & b')\n    self.assertEqual((a < b).ToPerfJson(), 'a < b')\n    self.assertEqual((a > b).ToPerfJson(), 'a > b')\n    self.assertEqual((a + b).ToPerfJson(), 'a + b')\n    self.assertEqual((a - b).ToPerfJson(), 'a - b')\n    self.assertEqual((a * b).ToPerfJson(), 'a * b')\n    self.assertEqual((a / b).ToPerfJson(), 'a / b')\n    self.assertEqual((a % b).ToPerfJson(), 'a % b')\n    one = Constant(1)\n    self.assertEqual((a + one).ToPerfJson(), 'a + 1')\n\n  def test_Brackets(self):\n    a = Event('a')\n    b = Event('b')\n    c = Event('c')\n    self.assertEqual((a * b + c).ToPerfJson(), 'a * b + c')\n    self.assertEqual((a + b * c).ToPerfJson(), 'a + b * c')\n    self.assertEqual(((a + a) + a).ToPerfJson(), 'a + a + a')\n    self.assertEqual(((a + b) * c).ToPerfJson(), '(a + b) * c')\n    self.assertEqual((a + (b * c)).ToPerfJson(), 'a + b * c')\n    self.assertEqual(((a / b) * c).ToPerfJson(), 'a / b * c')\n    self.assertEqual((a / (b * c)).ToPerfJson(), 'a / (b * c)')\n\n  def test_ParsePerfJson(self):\n    # Based on an example of a real metric.\n    before = '(a + b + c + d) / (2 * e)'\n    after = before\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    # Parsing should handle events with '-' in their name. Note, in\n    # the json file the '\\' are doubled to '\\\\'.\n    before = r'topdown\\-fe\\-bound / topdown\\-slots - 1'\n    after = before\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    # Parsing should handle escaped modifiers. Note, in the json file\n    # the '\\' are doubled to '\\\\'.\n    before = r'arb@event\\=0x81\\,umask\\=0x1@ + arb@event\\=0x84\\,umask\\=0x1@'\n    after = before\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    # Parsing should handle exponents in numbers.\n    before = r'a + 1e12 + b'\n    after = before\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n  def test_IfElseTests(self):\n    # if-else needs rewriting to Select and back.\n    before = r'Event1 if #smt_on else Event2'\n    after = f'({before})'\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    before = r'Event1 if 0 else Event2'\n    after = f'({before})'\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    before = r'Event1 if 1 else Event2'\n    after = f'({before})'\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    # Ensure the select is evaluate last.\n    before = r'Event1 + 1 if Event2 < 2 else Event3 + 3'\n    after = (r'Select(Event(r\"Event1\") + Constant(1), Event(r\"Event2\") < '\n             r'Constant(2), Event(r\"Event3\") + Constant(3))')\n    self.assertEqual(ParsePerfJson(before).ToPython(), after)\n\n    before = r'Event1 > 1 if Event2 < 2 else Event3 > 3'\n    after = (r'Select(Event(r\"Event1\") > Constant(1), Event(r\"Event2\") < '\n             r'Constant(2), Event(r\"Event3\") > Constant(3))')\n    self.assertEqual(ParsePerfJson(before).ToPython(), after)\n\n    before = r'min(a + b if c > 1 else c + d, e + f)'\n    after = r'min((a + b if c > 1 else c + d), e + f)'\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n    before = r'a if b else c if d else e'\n    after = r'(a if b else (c if d else e))'\n    self.assertEqual(ParsePerfJson(before).ToPerfJson(), after)\n\n  def test_ToPython(self):\n    # pylint: disable=eval-used\n    # Based on an example of a real metric.\n    before = '(a + b + c + d) / (2 * e)'\n    py = ParsePerfJson(before).ToPython()\n    after = eval(py).ToPerfJson()\n    self.assertEqual(before, after)\n\n  def test_Simplify(self):\n    before = '1 + 2 + 3'\n    after = '6'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a + 0'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = '0 + a'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a | 0'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = '0 | a'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a * 0'\n    after = '0'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = '0 * a'\n    after = '0'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a * 1'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = '1 * a'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a if 0 else b'\n    after = 'b'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a if 1 else b'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    before = 'a if b else a'\n    after = 'a'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n    # Pattern used to add a slots event to metrics that require it.\n    before = '0 * SLOTS'\n    after = '0 * SLOTS'\n    self.assertEqual(ParsePerfJson(before).Simplify().ToPerfJson(), after)\n\n  def test_RewriteMetricsInTermsOfOthers(self):\n    Expression.__eq__ = lambda e1, e2: e1.Equals(e2)\n    before = [('cpu', 'm1', ParsePerfJson('a + b + c + d')),\n              ('cpu', 'm2', ParsePerfJson('a + b + c'))]\n    after = {('cpu', 'm1'): ParsePerfJson('m2 + d')}\n    self.assertEqual(RewriteMetricsInTermsOfOthers(before), after)\n    Expression.__eq__ = None\n\nif __name__ == '__main__':\n  unittest.main()\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}