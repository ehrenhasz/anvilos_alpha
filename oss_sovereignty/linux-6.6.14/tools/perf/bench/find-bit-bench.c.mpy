{
  "module_name": "find-bit-bench.c",
  "hash_id": "5b05d7631bbcf742255a45365a0bbaa96f5767c94ff86f11fc88c11904b711b1",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/bench/find-bit-bench.c",
  "human_readable_source": "\n \n#include <stdlib.h>\n#include \"bench.h\"\n#include \"../util/stat.h\"\n#include <linux/bitmap.h>\n#include <linux/bitops.h>\n#include <linux/time64.h>\n#include <subcmd/parse-options.h>\n\nstatic unsigned int outer_iterations = 5;\nstatic unsigned int inner_iterations = 100000;\n\nstatic const struct option options[] = {\n\tOPT_UINTEGER('i', \"outer-iterations\", &outer_iterations,\n\t\t\"Number of outer iterations used\"),\n\tOPT_UINTEGER('j', \"inner-iterations\", &inner_iterations,\n\t\t\"Number of inner iterations used\"),\n\tOPT_END()\n};\n\nstatic const char *const bench_usage[] = {\n\t\"perf bench mem find_bit <options>\",\n\tNULL\n};\n\nstatic unsigned int accumulator;\nstatic unsigned int use_of_val;\n\nstatic noinline void workload(int val)\n{\n\tuse_of_val += val;\n\taccumulator++;\n}\n\n#if (defined(__i386__) || defined(__x86_64__)) && defined(__GCC_ASM_FLAG_OUTPUTS__)\nstatic bool asm_test_bit(long nr, const unsigned long *addr)\n{\n\tbool oldbit;\n\n\tasm volatile(\"bt %2,%1\"\n\t\t     : \"=@ccc\" (oldbit)\n\t\t     : \"m\" (*(unsigned long *)addr), \"Ir\" (nr) : \"memory\");\n\n\treturn oldbit;\n}\n#else\n#define asm_test_bit test_bit\n#endif\n\nstatic int do_for_each_set_bit(unsigned int num_bits)\n{\n\tunsigned long *to_test = bitmap_zalloc(num_bits);\n\tstruct timeval start, end, diff;\n\tu64 runtime_us;\n\tstruct stats fb_time_stats, tb_time_stats;\n\tdouble time_average, time_stddev;\n\tunsigned int bit, i, j;\n\tunsigned int set_bits, skip;\n\n\tinit_stats(&fb_time_stats);\n\tinit_stats(&tb_time_stats);\n\n\tfor (set_bits = 1; set_bits <= num_bits; set_bits <<= 1) {\n\t\tbitmap_zero(to_test, num_bits);\n\t\tskip = num_bits / set_bits;\n\t\tfor (i = 0; i < num_bits; i += skip)\n\t\t\t__set_bit(i, to_test);\n\n\t\tfor (i = 0; i < outer_iterations; i++) {\n#ifndef NDEBUG\n\t\t\tunsigned int old = accumulator;\n#endif\n\n\t\t\tgettimeofday(&start, NULL);\n\t\t\tfor (j = 0; j < inner_iterations; j++) {\n\t\t\t\tfor_each_set_bit(bit, to_test, num_bits)\n\t\t\t\t\tworkload(bit);\n\t\t\t}\n\t\t\tgettimeofday(&end, NULL);\n\t\t\tassert(old + (inner_iterations * set_bits) == accumulator);\n\t\t\ttimersub(&end, &start, &diff);\n\t\t\truntime_us = diff.tv_sec * USEC_PER_SEC + diff.tv_usec;\n\t\t\tupdate_stats(&fb_time_stats, runtime_us);\n\n#ifndef NDEBUG\n\t\t\told = accumulator;\n#endif\n\t\t\tgettimeofday(&start, NULL);\n\t\t\tfor (j = 0; j < inner_iterations; j++) {\n\t\t\t\tfor (bit = 0; bit < num_bits; bit++) {\n\t\t\t\t\tif (asm_test_bit(bit, to_test))\n\t\t\t\t\t\tworkload(bit);\n\t\t\t\t}\n\t\t\t}\n\t\t\tgettimeofday(&end, NULL);\n\t\t\tassert(old + (inner_iterations * set_bits) == accumulator);\n\t\t\ttimersub(&end, &start, &diff);\n\t\t\truntime_us = diff.tv_sec * USEC_PER_SEC + diff.tv_usec;\n\t\t\tupdate_stats(&tb_time_stats, runtime_us);\n\t\t}\n\n\t\tprintf(\"%d operations %d bits set of %d bits\\n\",\n\t\t\tinner_iterations, set_bits, num_bits);\n\t\ttime_average = avg_stats(&fb_time_stats);\n\t\ttime_stddev = stddev_stats(&fb_time_stats);\n\t\tprintf(\"  Average for_each_set_bit took: %.3f usec (+- %.3f usec)\\n\",\n\t\t\ttime_average, time_stddev);\n\t\ttime_average = avg_stats(&tb_time_stats);\n\t\ttime_stddev = stddev_stats(&tb_time_stats);\n\t\tprintf(\"  Average test_bit loop took:    %.3f usec (+- %.3f usec)\\n\",\n\t\t\ttime_average, time_stddev);\n\n\t\tif (use_of_val == accumulator)   \n\t\t\tprintf(\"\\n\");\n\t}\n\tbitmap_free(to_test);\n\treturn 0;\n}\n\nint bench_mem_find_bit(int argc, const char **argv)\n{\n\tint err = 0, i;\n\n\targc = parse_options(argc, argv, options, bench_usage, 0);\n\tif (argc) {\n\t\tusage_with_options(bench_usage, options);\n\t\texit(EXIT_FAILURE);\n\t}\n\n\tfor (i = 1; i <= 2048; i <<= 1)\n\t\tdo_for_each_set_bit(i);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}