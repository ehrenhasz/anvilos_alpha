{
  "module_name": "annotate.c",
  "hash_id": "ef7782db2596748418bccf89a300ccf3e3be1dcc764ecddbbd9273adb1c38bc9",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/ui/browsers/annotate.c",
  "human_readable_source": "\n#include \"../browser.h\"\n#include \"../helpline.h\"\n#include \"../ui.h\"\n#include \"../../util/annotate.h\"\n#include \"../../util/debug.h\"\n#include \"../../util/dso.h\"\n#include \"../../util/hist.h\"\n#include \"../../util/sort.h\"\n#include \"../../util/map.h\"\n#include \"../../util/mutex.h\"\n#include \"../../util/symbol.h\"\n#include \"../../util/evsel.h\"\n#include \"../../util/evlist.h\"\n#include <inttypes.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/zalloc.h>\n#include <sys/ttydefaults.h>\n#include <asm/bug.h>\n\nstruct arch;\n\nstruct annotate_browser {\n\tstruct ui_browser\t    b;\n\tstruct rb_root\t\t    entries;\n\tstruct rb_node\t\t   *curr_hot;\n\tstruct annotation_line\t   *selection;\n\tstruct arch\t\t   *arch;\n\tstruct annotation_options  *opts;\n\tbool\t\t\t    searching_backwards;\n\tchar\t\t\t    search_bf[128];\n};\n\nstatic inline struct annotation *browser__annotation(struct ui_browser *browser)\n{\n\tstruct map_symbol *ms = browser->priv;\n\treturn symbol__annotation(ms->sym);\n}\n\nstatic bool disasm_line__filter(struct ui_browser *browser, void *entry)\n{\n\tstruct annotation *notes = browser__annotation(browser);\n\tstruct annotation_line *al = list_entry(entry, struct annotation_line, node);\n\treturn annotation_line__filter(al, notes);\n}\n\nstatic int ui_browser__jumps_percent_color(struct ui_browser *browser, int nr, bool current)\n{\n\tstruct annotation *notes = browser__annotation(browser);\n\n\tif (current && (!browser->use_navkeypressed || browser->navkeypressed))\n\t\treturn HE_COLORSET_SELECTED;\n\tif (nr == notes->max_jump_sources)\n\t\treturn HE_COLORSET_TOP;\n\tif (nr > 1)\n\t\treturn HE_COLORSET_MEDIUM;\n\treturn HE_COLORSET_NORMAL;\n}\n\nstatic int ui_browser__set_jumps_percent_color(void *browser, int nr, bool current)\n{\n\t int color = ui_browser__jumps_percent_color(browser, nr, current);\n\t return ui_browser__set_color(browser, color);\n}\n\nstatic int annotate_browser__set_color(void *browser, int color)\n{\n\treturn ui_browser__set_color(browser, color);\n}\n\nstatic void annotate_browser__write_graph(void *browser, int graph)\n{\n\tui_browser__write_graph(browser, graph);\n}\n\nstatic void annotate_browser__set_percent_color(void *browser, double percent, bool current)\n{\n\tui_browser__set_percent_color(browser, percent, current);\n}\n\nstatic void annotate_browser__printf(void *browser, const char *fmt, ...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tui_browser__vprintf(browser, fmt, args);\n\tva_end(args);\n}\n\nstatic void annotate_browser__write(struct ui_browser *browser, void *entry, int row)\n{\n\tstruct annotate_browser *ab = container_of(browser, struct annotate_browser, b);\n\tstruct annotation *notes = browser__annotation(browser);\n\tstruct annotation_line *al = list_entry(entry, struct annotation_line, node);\n\tconst bool is_current_entry = ui_browser__is_current_entry(browser, row);\n\tstruct annotation_write_ops ops = {\n\t\t.first_line\t\t = row == 0,\n\t\t.current_entry\t\t = is_current_entry,\n\t\t.change_color\t\t = (!notes->options->hide_src_code &&\n\t\t\t\t\t    (!is_current_entry ||\n\t\t\t\t\t     (browser->use_navkeypressed &&\n\t\t\t\t\t      !browser->navkeypressed))),\n\t\t.width\t\t\t = browser->width,\n\t\t.obj\t\t\t = browser,\n\t\t.set_color\t\t = annotate_browser__set_color,\n\t\t.set_percent_color\t = annotate_browser__set_percent_color,\n\t\t.set_jumps_percent_color = ui_browser__set_jumps_percent_color,\n\t\t.printf\t\t\t = annotate_browser__printf,\n\t\t.write_graph\t\t = annotate_browser__write_graph,\n\t};\n\n\t \n\tif (!browser->navkeypressed)\n\t\tops.width += 1;\n\n\tannotation_line__write(al, notes, &ops, ab->opts);\n\n\tif (ops.current_entry)\n\t\tab->selection = al;\n}\n\nstatic int is_fused(struct annotate_browser *ab, struct disasm_line *cursor)\n{\n\tstruct disasm_line *pos = list_prev_entry(cursor, al.node);\n\tconst char *name;\n\tint diff = 1;\n\n\twhile (pos && pos->al.offset == -1) {\n\t\tpos = list_prev_entry(pos, al.node);\n\t\tif (!ab->opts->hide_src_code)\n\t\t\tdiff++;\n\t}\n\n\tif (!pos)\n\t\treturn 0;\n\n\tif (ins__is_lock(&pos->ins))\n\t\tname = pos->ops.locked.ins.name;\n\telse\n\t\tname = pos->ins.name;\n\n\tif (!name || !cursor->ins.name)\n\t\treturn 0;\n\n\tif (ins__is_fused(ab->arch, name, cursor->ins.name))\n\t\treturn diff;\n\treturn 0;\n}\n\nstatic void annotate_browser__draw_current_jump(struct ui_browser *browser)\n{\n\tstruct annotate_browser *ab = container_of(browser, struct annotate_browser, b);\n\tstruct disasm_line *cursor = disasm_line(ab->selection);\n\tstruct annotation_line *target;\n\tunsigned int from, to;\n\tstruct map_symbol *ms = ab->b.priv;\n\tstruct symbol *sym = ms->sym;\n\tstruct annotation *notes = symbol__annotation(sym);\n\tu8 pcnt_width = annotation__pcnt_width(notes);\n\tint width;\n\tint diff = 0;\n\n\t \n\tif (strstr(sym->name, \"@plt\"))\n\t\treturn;\n\n\tif (!disasm_line__is_valid_local_jump(cursor, sym))\n\t\treturn;\n\n\t \n\ttarget = notes->offsets[cursor->ops.target.offset];\n\tif (target == NULL) {\n\t\tui_helpline__printf(\"WARN: jump target inconsistency, press 'o', notes->offsets[%#x] = NULL\\n\",\n\t\t\t\t    cursor->ops.target.offset);\n\t\treturn;\n\t}\n\n\tif (notes->options->hide_src_code) {\n\t\tfrom = cursor->al.idx_asm;\n\t\tto = target->idx_asm;\n\t} else {\n\t\tfrom = (u64)cursor->al.idx;\n\t\tto = (u64)target->idx;\n\t}\n\n\twidth = annotation__cycles_width(notes);\n\n\tui_browser__set_color(browser, HE_COLORSET_JUMP_ARROWS);\n\t__ui_browser__line_arrow(browser,\n\t\t\t\t pcnt_width + 2 + notes->widths.addr + width,\n\t\t\t\t from, to);\n\n\tdiff = is_fused(ab, cursor);\n\tif (diff > 0) {\n\t\tui_browser__mark_fused(browser,\n\t\t\t\t       pcnt_width + 3 + notes->widths.addr + width,\n\t\t\t\t       from - diff, diff, to > from);\n\t}\n}\n\nstatic unsigned int annotate_browser__refresh(struct ui_browser *browser)\n{\n\tstruct annotation *notes = browser__annotation(browser);\n\tint ret = ui_browser__list_head_refresh(browser);\n\tint pcnt_width = annotation__pcnt_width(notes);\n\n\tif (notes->options->jump_arrows)\n\t\tannotate_browser__draw_current_jump(browser);\n\n\tui_browser__set_color(browser, HE_COLORSET_NORMAL);\n\t__ui_browser__vline(browser, pcnt_width, 0, browser->rows - 1);\n\treturn ret;\n}\n\nstatic double disasm__cmp(struct annotation_line *a, struct annotation_line *b,\n\t\t\t\t\t\t  int percent_type)\n{\n\tint i;\n\n\tfor (i = 0; i < a->data_nr; i++) {\n\t\tif (a->data[i].percent[percent_type] == b->data[i].percent[percent_type])\n\t\t\tcontinue;\n\t\treturn a->data[i].percent[percent_type] -\n\t\t\t   b->data[i].percent[percent_type];\n\t}\n\treturn 0;\n}\n\nstatic void disasm_rb_tree__insert(struct annotate_browser *browser,\n\t\t\t\tstruct annotation_line *al)\n{\n\tstruct rb_root *root = &browser->entries;\n\tstruct rb_node **p = &root->rb_node;\n\tstruct rb_node *parent = NULL;\n\tstruct annotation_line *l;\n\n\twhile (*p != NULL) {\n\t\tparent = *p;\n\t\tl = rb_entry(parent, struct annotation_line, rb_node);\n\n\t\tif (disasm__cmp(al, l, browser->opts->percent_type) < 0)\n\t\t\tp = &(*p)->rb_left;\n\t\telse\n\t\t\tp = &(*p)->rb_right;\n\t}\n\trb_link_node(&al->rb_node, parent, p);\n\trb_insert_color(&al->rb_node, root);\n}\n\nstatic void annotate_browser__set_top(struct annotate_browser *browser,\n\t\t\t\t      struct annotation_line *pos, u32 idx)\n{\n\tstruct annotation *notes = browser__annotation(&browser->b);\n\tunsigned back;\n\n\tui_browser__refresh_dimensions(&browser->b);\n\tback = browser->b.height / 2;\n\tbrowser->b.top_idx = browser->b.index = idx;\n\n\twhile (browser->b.top_idx != 0 && back != 0) {\n\t\tpos = list_entry(pos->node.prev, struct annotation_line, node);\n\n\t\tif (annotation_line__filter(pos, notes))\n\t\t\tcontinue;\n\n\t\t--browser->b.top_idx;\n\t\t--back;\n\t}\n\n\tbrowser->b.top = pos;\n\tbrowser->b.navkeypressed = true;\n}\n\nstatic void annotate_browser__set_rb_top(struct annotate_browser *browser,\n\t\t\t\t\t struct rb_node *nd)\n{\n\tstruct annotation *notes = browser__annotation(&browser->b);\n\tstruct annotation_line * pos = rb_entry(nd, struct annotation_line, rb_node);\n\tu32 idx = pos->idx;\n\n\tif (notes->options->hide_src_code)\n\t\tidx = pos->idx_asm;\n\tannotate_browser__set_top(browser, pos, idx);\n\tbrowser->curr_hot = nd;\n}\n\nstatic void annotate_browser__calc_percent(struct annotate_browser *browser,\n\t\t\t\t\t   struct evsel *evsel)\n{\n\tstruct map_symbol *ms = browser->b.priv;\n\tstruct symbol *sym = ms->sym;\n\tstruct annotation *notes = symbol__annotation(sym);\n\tstruct disasm_line *pos;\n\n\tbrowser->entries = RB_ROOT;\n\n\tannotation__lock(notes);\n\n\tsymbol__calc_percent(sym, evsel);\n\n\tlist_for_each_entry(pos, &notes->src->source, al.node) {\n\t\tdouble max_percent = 0.0;\n\t\tint i;\n\n\t\tif (pos->al.offset == -1) {\n\t\t\tRB_CLEAR_NODE(&pos->al.rb_node);\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor (i = 0; i < pos->al.data_nr; i++) {\n\t\t\tdouble percent;\n\n\t\t\tpercent = annotation_data__percent(&pos->al.data[i],\n\t\t\t\t\t\t\t   browser->opts->percent_type);\n\n\t\t\tif (max_percent < percent)\n\t\t\t\tmax_percent = percent;\n\t\t}\n\n\t\tif (max_percent < 0.01 && pos->al.ipc == 0) {\n\t\t\tRB_CLEAR_NODE(&pos->al.rb_node);\n\t\t\tcontinue;\n\t\t}\n\t\tdisasm_rb_tree__insert(browser, &pos->al);\n\t}\n\tannotation__unlock(notes);\n\n\tbrowser->curr_hot = rb_last(&browser->entries);\n}\n\nstatic struct annotation_line *annotate_browser__find_next_asm_line(\n\t\t\t\t\tstruct annotate_browser *browser,\n\t\t\t\t\tstruct annotation_line *al)\n{\n\tstruct annotation_line *it = al;\n\n\t \n\tlist_for_each_entry_continue(it, browser->b.entries, node) {\n\t\tif (it->idx_asm >= 0)\n\t\t\treturn it;\n\t}\n\n\t \n\tit = al;\n\tlist_for_each_entry_continue_reverse(it, browser->b.entries, node) {\n\t\tif (it->idx_asm >= 0)\n\t\t\treturn it;\n\t}\n\n\t \n\treturn NULL;\n}\n\nstatic bool annotate_browser__toggle_source(struct annotate_browser *browser)\n{\n\tstruct annotation *notes = browser__annotation(&browser->b);\n\tstruct annotation_line *al;\n\toff_t offset = browser->b.index - browser->b.top_idx;\n\n\tbrowser->b.seek(&browser->b, offset, SEEK_CUR);\n\tal = list_entry(browser->b.top, struct annotation_line, node);\n\n\tif (notes->options->hide_src_code) {\n\t\tif (al->idx_asm < offset)\n\t\t\toffset = al->idx;\n\n\t\tbrowser->b.nr_entries = notes->nr_entries;\n\t\tnotes->options->hide_src_code = false;\n\t\tbrowser->b.seek(&browser->b, -offset, SEEK_CUR);\n\t\tbrowser->b.top_idx = al->idx - offset;\n\t\tbrowser->b.index = al->idx;\n\t} else {\n\t\tif (al->idx_asm < 0) {\n\t\t\t \n\t\t\tal = annotate_browser__find_next_asm_line(browser, al);\n\t\t\tif (!al) {\n\t\t\t\tbrowser->b.seek(&browser->b, -offset, SEEK_CUR);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tif (al->idx_asm < offset)\n\t\t\toffset = al->idx_asm;\n\n\t\tbrowser->b.nr_entries = notes->nr_asm_entries;\n\t\tnotes->options->hide_src_code = true;\n\t\tbrowser->b.seek(&browser->b, -offset, SEEK_CUR);\n\t\tbrowser->b.top_idx = al->idx_asm - offset;\n\t\tbrowser->b.index = al->idx_asm;\n\t}\n\n\treturn true;\n}\n\n#define SYM_TITLE_MAX_SIZE (PATH_MAX + 64)\n\nstatic void annotate_browser__show_full_location(struct ui_browser *browser)\n{\n\tstruct annotate_browser *ab = container_of(browser, struct annotate_browser, b);\n\tstruct disasm_line *cursor = disasm_line(ab->selection);\n\tstruct annotation_line *al = &cursor->al;\n\n\tif (al->offset != -1)\n\t\tui_helpline__puts(\"Only available for source code lines.\");\n\telse if (al->fileloc == NULL)\n\t\tui_helpline__puts(\"No source file location.\");\n\telse {\n\t\tchar help_line[SYM_TITLE_MAX_SIZE];\n\t\tsprintf (help_line, \"Source file location: %s\", al->fileloc);\n\t\tui_helpline__puts(help_line);\n\t}\n}\n\nstatic void ui_browser__init_asm_mode(struct ui_browser *browser)\n{\n\tstruct annotation *notes = browser__annotation(browser);\n\tui_browser__reset_index(browser);\n\tbrowser->nr_entries = notes->nr_asm_entries;\n}\n\nstatic int sym_title(struct symbol *sym, struct map *map, char *title,\n\t\t     size_t sz, int percent_type)\n{\n\treturn snprintf(title, sz, \"%s  %s [Percent: %s]\", sym->name,\n\t\t\tmap__dso(map)->long_name,\n\t\t\tpercent_type_str(percent_type));\n}\n\n \nstatic bool annotate_browser__callq(struct annotate_browser *browser,\n\t\t\t\t    struct evsel *evsel,\n\t\t\t\t    struct hist_browser_timer *hbt)\n{\n\tstruct map_symbol *ms = browser->b.priv, target_ms;\n\tstruct disasm_line *dl = disasm_line(browser->selection);\n\tstruct annotation *notes;\n\tchar title[SYM_TITLE_MAX_SIZE];\n\n\tif (!dl->ops.target.sym) {\n\t\tui_helpline__puts(\"The called function was not found.\");\n\t\treturn true;\n\t}\n\n\tnotes = symbol__annotation(dl->ops.target.sym);\n\tannotation__lock(notes);\n\n\tif (!symbol__hists(dl->ops.target.sym, evsel->evlist->core.nr_entries)) {\n\t\tannotation__unlock(notes);\n\t\tui__warning(\"Not enough memory for annotating '%s' symbol!\\n\",\n\t\t\t    dl->ops.target.sym->name);\n\t\treturn true;\n\t}\n\n\ttarget_ms.maps = ms->maps;\n\ttarget_ms.map = ms->map;\n\ttarget_ms.sym = dl->ops.target.sym;\n\tannotation__unlock(notes);\n\tsymbol__tui_annotate(&target_ms, evsel, hbt, browser->opts);\n\tsym_title(ms->sym, ms->map, title, sizeof(title), browser->opts->percent_type);\n\tui_browser__show_title(&browser->b, title);\n\treturn true;\n}\n\nstatic\nstruct disasm_line *annotate_browser__find_offset(struct annotate_browser *browser,\n\t\t\t\t\t  s64 offset, s64 *idx)\n{\n\tstruct annotation *notes = browser__annotation(&browser->b);\n\tstruct disasm_line *pos;\n\n\t*idx = 0;\n\tlist_for_each_entry(pos, &notes->src->source, al.node) {\n\t\tif (pos->al.offset == offset)\n\t\t\treturn pos;\n\t\tif (!annotation_line__filter(&pos->al, notes))\n\t\t\t++*idx;\n\t}\n\n\treturn NULL;\n}\n\nstatic bool annotate_browser__jump(struct annotate_browser *browser,\n\t\t\t\t   struct evsel *evsel,\n\t\t\t\t   struct hist_browser_timer *hbt)\n{\n\tstruct disasm_line *dl = disasm_line(browser->selection);\n\tu64 offset;\n\ts64 idx;\n\n\tif (!ins__is_jump(&dl->ins))\n\t\treturn false;\n\n\tif (dl->ops.target.outside) {\n\t\tannotate_browser__callq(browser, evsel, hbt);\n\t\treturn true;\n\t}\n\n\toffset = dl->ops.target.offset;\n\tdl = annotate_browser__find_offset(browser, offset, &idx);\n\tif (dl == NULL) {\n\t\tui_helpline__printf(\"Invalid jump offset: %\" PRIx64, offset);\n\t\treturn true;\n\t}\n\n\tannotate_browser__set_top(browser, &dl->al, idx);\n\n\treturn true;\n}\n\nstatic\nstruct annotation_line *annotate_browser__find_string(struct annotate_browser *browser,\n\t\t\t\t\t  char *s, s64 *idx)\n{\n\tstruct annotation *notes = browser__annotation(&browser->b);\n\tstruct annotation_line *al = browser->selection;\n\n\t*idx = browser->b.index;\n\tlist_for_each_entry_continue(al, &notes->src->source, node) {\n\t\tif (annotation_line__filter(al, notes))\n\t\t\tcontinue;\n\n\t\t++*idx;\n\n\t\tif (al->line && strstr(al->line, s) != NULL)\n\t\t\treturn al;\n\t}\n\n\treturn NULL;\n}\n\nstatic bool __annotate_browser__search(struct annotate_browser *browser)\n{\n\tstruct annotation_line *al;\n\ts64 idx;\n\n\tal = annotate_browser__find_string(browser, browser->search_bf, &idx);\n\tif (al == NULL) {\n\t\tui_helpline__puts(\"String not found!\");\n\t\treturn false;\n\t}\n\n\tannotate_browser__set_top(browser, al, idx);\n\tbrowser->searching_backwards = false;\n\treturn true;\n}\n\nstatic\nstruct annotation_line *annotate_browser__find_string_reverse(struct annotate_browser *browser,\n\t\t\t\t\t\t  char *s, s64 *idx)\n{\n\tstruct annotation *notes = browser__annotation(&browser->b);\n\tstruct annotation_line *al = browser->selection;\n\n\t*idx = browser->b.index;\n\tlist_for_each_entry_continue_reverse(al, &notes->src->source, node) {\n\t\tif (annotation_line__filter(al, notes))\n\t\t\tcontinue;\n\n\t\t--*idx;\n\n\t\tif (al->line && strstr(al->line, s) != NULL)\n\t\t\treturn al;\n\t}\n\n\treturn NULL;\n}\n\nstatic bool __annotate_browser__search_reverse(struct annotate_browser *browser)\n{\n\tstruct annotation_line *al;\n\ts64 idx;\n\n\tal = annotate_browser__find_string_reverse(browser, browser->search_bf, &idx);\n\tif (al == NULL) {\n\t\tui_helpline__puts(\"String not found!\");\n\t\treturn false;\n\t}\n\n\tannotate_browser__set_top(browser, al, idx);\n\tbrowser->searching_backwards = true;\n\treturn true;\n}\n\nstatic bool annotate_browser__search_window(struct annotate_browser *browser,\n\t\t\t\t\t    int delay_secs)\n{\n\tif (ui_browser__input_window(\"Search\", \"String: \", browser->search_bf,\n\t\t\t\t     \"ENTER: OK, ESC: Cancel\",\n\t\t\t\t     delay_secs * 2) != K_ENTER ||\n\t    !*browser->search_bf)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic bool annotate_browser__search(struct annotate_browser *browser, int delay_secs)\n{\n\tif (annotate_browser__search_window(browser, delay_secs))\n\t\treturn __annotate_browser__search(browser);\n\n\treturn false;\n}\n\nstatic bool annotate_browser__continue_search(struct annotate_browser *browser,\n\t\t\t\t\t      int delay_secs)\n{\n\tif (!*browser->search_bf)\n\t\treturn annotate_browser__search(browser, delay_secs);\n\n\treturn __annotate_browser__search(browser);\n}\n\nstatic bool annotate_browser__search_reverse(struct annotate_browser *browser,\n\t\t\t\t\t   int delay_secs)\n{\n\tif (annotate_browser__search_window(browser, delay_secs))\n\t\treturn __annotate_browser__search_reverse(browser);\n\n\treturn false;\n}\n\nstatic\nbool annotate_browser__continue_search_reverse(struct annotate_browser *browser,\n\t\t\t\t\t       int delay_secs)\n{\n\tif (!*browser->search_bf)\n\t\treturn annotate_browser__search_reverse(browser, delay_secs);\n\n\treturn __annotate_browser__search_reverse(browser);\n}\n\nstatic int annotate_browser__show(struct ui_browser *browser, char *title, const char *help)\n{\n\tstruct annotate_browser *ab = container_of(browser, struct annotate_browser, b);\n\tstruct map_symbol *ms = browser->priv;\n\tstruct symbol *sym = ms->sym;\n\tchar symbol_dso[SYM_TITLE_MAX_SIZE];\n\n\tif (ui_browser__show(browser, title, help) < 0)\n\t\treturn -1;\n\n\tsym_title(sym, ms->map, symbol_dso, sizeof(symbol_dso), ab->opts->percent_type);\n\n\tui_browser__gotorc_title(browser, 0, 0);\n\tui_browser__set_color(browser, HE_COLORSET_ROOT);\n\tui_browser__write_nstring(browser, symbol_dso, browser->width + 1);\n\treturn 0;\n}\n\nstatic void\nswitch_percent_type(struct annotation_options *opts, bool base)\n{\n\tswitch (opts->percent_type) {\n\tcase PERCENT_HITS_LOCAL:\n\t\tif (base)\n\t\t\topts->percent_type = PERCENT_PERIOD_LOCAL;\n\t\telse\n\t\t\topts->percent_type = PERCENT_HITS_GLOBAL;\n\t\tbreak;\n\tcase PERCENT_HITS_GLOBAL:\n\t\tif (base)\n\t\t\topts->percent_type = PERCENT_PERIOD_GLOBAL;\n\t\telse\n\t\t\topts->percent_type = PERCENT_HITS_LOCAL;\n\t\tbreak;\n\tcase PERCENT_PERIOD_LOCAL:\n\t\tif (base)\n\t\t\topts->percent_type = PERCENT_HITS_LOCAL;\n\t\telse\n\t\t\topts->percent_type = PERCENT_PERIOD_GLOBAL;\n\t\tbreak;\n\tcase PERCENT_PERIOD_GLOBAL:\n\t\tif (base)\n\t\t\topts->percent_type = PERCENT_HITS_GLOBAL;\n\t\telse\n\t\t\topts->percent_type = PERCENT_PERIOD_LOCAL;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n}\n\nstatic int annotate_browser__run(struct annotate_browser *browser,\n\t\t\t\t struct evsel *evsel,\n\t\t\t\t struct hist_browser_timer *hbt)\n{\n\tstruct rb_node *nd = NULL;\n\tstruct hists *hists = evsel__hists(evsel);\n\tstruct map_symbol *ms = browser->b.priv;\n\tstruct symbol *sym = ms->sym;\n\tstruct annotation *notes = symbol__annotation(ms->sym);\n\tconst char *help = \"Press 'h' for help on key bindings\";\n\tint delay_secs = hbt ? hbt->refresh : 0;\n\tchar title[256];\n\tint key;\n\n\thists__scnprintf_title(hists, title, sizeof(title));\n\tif (annotate_browser__show(&browser->b, title, help) < 0)\n\t\treturn -1;\n\n\tannotate_browser__calc_percent(browser, evsel);\n\n\tif (browser->curr_hot) {\n\t\tannotate_browser__set_rb_top(browser, browser->curr_hot);\n\t\tbrowser->b.navkeypressed = false;\n\t}\n\n\tnd = browser->curr_hot;\n\n\twhile (1) {\n\t\tkey = ui_browser__run(&browser->b, delay_secs);\n\n\t\tif (delay_secs != 0) {\n\t\t\tannotate_browser__calc_percent(browser, evsel);\n\t\t\t \n\t\t\tif (nd != NULL && RB_EMPTY_NODE(nd))\n\t\t\t\tnd = NULL;\n\t\t}\n\n\t\tswitch (key) {\n\t\tcase K_TIMER:\n\t\t\tif (hbt)\n\t\t\t\thbt->timer(hbt->arg);\n\n\t\t\tif (delay_secs != 0) {\n\t\t\t\tsymbol__annotate_decay_histogram(sym, evsel->core.idx);\n\t\t\t\thists__scnprintf_title(hists, title, sizeof(title));\n\t\t\t\tannotate_browser__show(&browser->b, title, help);\n\t\t\t}\n\t\t\tcontinue;\n\t\tcase K_TAB:\n\t\t\tif (nd != NULL) {\n\t\t\t\tnd = rb_prev(nd);\n\t\t\t\tif (nd == NULL)\n\t\t\t\t\tnd = rb_last(&browser->entries);\n\t\t\t} else\n\t\t\t\tnd = browser->curr_hot;\n\t\t\tbreak;\n\t\tcase K_UNTAB:\n\t\t\tif (nd != NULL) {\n\t\t\t\tnd = rb_next(nd);\n\t\t\t\tif (nd == NULL)\n\t\t\t\t\tnd = rb_first(&browser->entries);\n\t\t\t} else\n\t\t\t\tnd = browser->curr_hot;\n\t\t\tbreak;\n\t\tcase K_F1:\n\t\tcase 'h':\n\t\t\tui_browser__help_window(&browser->b,\n\t\t\"UP/DOWN/PGUP\\n\"\n\t\t\"PGDN/SPACE    Navigate\\n\"\n\t\t\"</>           Move to prev/next symbol\\n\"\n\t\t\"q/ESC/CTRL+C  Exit\\n\\n\"\n\t\t\"ENTER         Go to target\\n\"\n\t\t\"H             Go to hottest instruction\\n\"\n\t\t\"TAB/shift+TAB Cycle thru hottest instructions\\n\"\n\t\t\"j             Toggle showing jump to target arrows\\n\"\n\t\t\"J             Toggle showing number of jump sources on targets\\n\"\n\t\t\"n             Search next string\\n\"\n\t\t\"o             Toggle disassembler output/simplified view\\n\"\n\t\t\"O             Bump offset level (jump targets -> +call -> all -> cycle thru)\\n\"\n\t\t\"s             Toggle source code view\\n\"\n\t\t\"t             Circulate percent, total period, samples view\\n\"\n\t\t\"c             Show min/max cycle\\n\"\n\t\t\"/             Search string\\n\"\n\t\t\"k             Toggle line numbers\\n\"\n\t\t\"l             Show full source file location\\n\"\n\t\t\"P             Print to [symbol_name].annotation file.\\n\"\n\t\t\"r             Run available scripts\\n\"\n\t\t\"p             Toggle percent type [local/global]\\n\"\n\t\t\"b             Toggle percent base [period/hits]\\n\"\n\t\t\"?             Search string backwards\\n\"\n\t\t\"f             Toggle showing offsets to full address\\n\");\n\t\t\tcontinue;\n\t\tcase 'r':\n\t\t\tscript_browse(NULL, NULL);\n\t\t\tannotate_browser__show(&browser->b, title, help);\n\t\t\tcontinue;\n\t\tcase 'k':\n\t\t\tnotes->options->show_linenr = !notes->options->show_linenr;\n\t\t\tcontinue;\n\t\tcase 'l':\n\t\t\tannotate_browser__show_full_location (&browser->b);\n\t\t\tcontinue;\n\t\tcase 'H':\n\t\t\tnd = browser->curr_hot;\n\t\t\tbreak;\n\t\tcase 's':\n\t\t\tif (annotate_browser__toggle_source(browser))\n\t\t\t\tui_helpline__puts(help);\n\t\t\tcontinue;\n\t\tcase 'o':\n\t\t\tnotes->options->use_offset = !notes->options->use_offset;\n\t\t\tannotation__update_column_widths(notes);\n\t\t\tcontinue;\n\t\tcase 'O':\n\t\t\tif (++notes->options->offset_level > ANNOTATION__MAX_OFFSET_LEVEL)\n\t\t\t\tnotes->options->offset_level = ANNOTATION__MIN_OFFSET_LEVEL;\n\t\t\tcontinue;\n\t\tcase 'j':\n\t\t\tnotes->options->jump_arrows = !notes->options->jump_arrows;\n\t\t\tcontinue;\n\t\tcase 'J':\n\t\t\tnotes->options->show_nr_jumps = !notes->options->show_nr_jumps;\n\t\t\tannotation__update_column_widths(notes);\n\t\t\tcontinue;\n\t\tcase '/':\n\t\t\tif (annotate_browser__search(browser, delay_secs)) {\nshow_help:\n\t\t\t\tui_helpline__puts(help);\n\t\t\t}\n\t\t\tcontinue;\n\t\tcase 'n':\n\t\t\tif (browser->searching_backwards ?\n\t\t\t    annotate_browser__continue_search_reverse(browser, delay_secs) :\n\t\t\t    annotate_browser__continue_search(browser, delay_secs))\n\t\t\t\tgoto show_help;\n\t\t\tcontinue;\n\t\tcase '?':\n\t\t\tif (annotate_browser__search_reverse(browser, delay_secs))\n\t\t\t\tgoto show_help;\n\t\t\tcontinue;\n\t\tcase 'D': {\n\t\t\tstatic int seq;\n\t\t\tui_helpline__pop();\n\t\t\tui_helpline__fpush(\"%d: nr_ent=%d, height=%d, idx=%d, top_idx=%d, nr_asm_entries=%d\",\n\t\t\t\t\t   seq++, browser->b.nr_entries,\n\t\t\t\t\t   browser->b.height,\n\t\t\t\t\t   browser->b.index,\n\t\t\t\t\t   browser->b.top_idx,\n\t\t\t\t\t   notes->nr_asm_entries);\n\t\t}\n\t\t\tcontinue;\n\t\tcase K_ENTER:\n\t\tcase K_RIGHT:\n\t\t{\n\t\t\tstruct disasm_line *dl = disasm_line(browser->selection);\n\n\t\t\tif (browser->selection == NULL)\n\t\t\t\tui_helpline__puts(\"Huh? No selection. Report to linux-kernel@vger.kernel.org\");\n\t\t\telse if (browser->selection->offset == -1)\n\t\t\t\tui_helpline__puts(\"Actions are only available for assembly lines.\");\n\t\t\telse if (!dl->ins.ops)\n\t\t\t\tgoto show_sup_ins;\n\t\t\telse if (ins__is_ret(&dl->ins))\n\t\t\t\tgoto out;\n\t\t\telse if (!(annotate_browser__jump(browser, evsel, hbt) ||\n\t\t\t\t     annotate_browser__callq(browser, evsel, hbt))) {\nshow_sup_ins:\n\t\t\t\tui_helpline__puts(\"Actions are only available for function call/return & jump/branch instructions.\");\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\tcase 'P':\n\t\t\tmap_symbol__annotation_dump(ms, evsel, browser->opts);\n\t\t\tcontinue;\n\t\tcase 't':\n\t\t\tif (symbol_conf.show_total_period) {\n\t\t\t\tsymbol_conf.show_total_period = false;\n\t\t\t\tsymbol_conf.show_nr_samples = true;\n\t\t\t} else if (symbol_conf.show_nr_samples)\n\t\t\t\tsymbol_conf.show_nr_samples = false;\n\t\t\telse\n\t\t\t\tsymbol_conf.show_total_period = true;\n\t\t\tannotation__update_column_widths(notes);\n\t\t\tcontinue;\n\t\tcase 'c':\n\t\t\tif (notes->options->show_minmax_cycle)\n\t\t\t\tnotes->options->show_minmax_cycle = false;\n\t\t\telse\n\t\t\t\tnotes->options->show_minmax_cycle = true;\n\t\t\tannotation__update_column_widths(notes);\n\t\t\tcontinue;\n\t\tcase 'p':\n\t\tcase 'b':\n\t\t\tswitch_percent_type(browser->opts, key == 'b');\n\t\t\thists__scnprintf_title(hists, title, sizeof(title));\n\t\t\tannotate_browser__show(&browser->b, title, help);\n\t\t\tcontinue;\n\t\tcase 'f':\n\t\t\tannotation__toggle_full_addr(notes, ms);\n\t\t\tcontinue;\n\t\tcase K_LEFT:\n\t\tcase '<':\n\t\tcase '>':\n\t\tcase K_ESC:\n\t\tcase 'q':\n\t\tcase CTRL('c'):\n\t\t\tgoto out;\n\t\tdefault:\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (nd != NULL)\n\t\t\tannotate_browser__set_rb_top(browser, nd);\n\t}\nout:\n\tui_browser__hide(&browser->b);\n\treturn key;\n}\n\nint map_symbol__tui_annotate(struct map_symbol *ms, struct evsel *evsel,\n\t\t\t     struct hist_browser_timer *hbt,\n\t\t\t     struct annotation_options *opts)\n{\n\treturn symbol__tui_annotate(ms, evsel, hbt, opts);\n}\n\nint hist_entry__tui_annotate(struct hist_entry *he, struct evsel *evsel,\n\t\t\t     struct hist_browser_timer *hbt,\n\t\t\t     struct annotation_options *opts)\n{\n\t \n\tSLang_reset_tty();\n\tSLang_init_tty(0, 0, 0);\n\n\treturn map_symbol__tui_annotate(&he->ms, evsel, hbt, opts);\n}\n\nint symbol__tui_annotate(struct map_symbol *ms, struct evsel *evsel,\n\t\t\t struct hist_browser_timer *hbt,\n\t\t\t struct annotation_options *opts)\n{\n\tstruct symbol *sym = ms->sym;\n\tstruct annotation *notes = symbol__annotation(sym);\n\tstruct annotate_browser browser = {\n\t\t.b = {\n\t\t\t.refresh = annotate_browser__refresh,\n\t\t\t.seek\t = ui_browser__list_head_seek,\n\t\t\t.write\t = annotate_browser__write,\n\t\t\t.filter  = disasm_line__filter,\n\t\t\t.extra_title_lines = 1,  \n\t\t\t.priv\t = ms,\n\t\t\t.use_navkeypressed = true,\n\t\t},\n\t\t.opts = opts,\n\t};\n\tstruct dso *dso;\n\tint ret = -1, err;\n\tint not_annotated = list_empty(&notes->src->source);\n\n\tif (sym == NULL)\n\t\treturn -1;\n\n\tdso = map__dso(ms->map);\n\tif (dso->annotate_warned)\n\t\treturn -1;\n\n\tif (not_annotated) {\n\t\terr = symbol__annotate2(ms, evsel, opts, &browser.arch);\n\t\tif (err) {\n\t\t\tchar msg[BUFSIZ];\n\t\t\tdso->annotate_warned = true;\n\t\t\tsymbol__strerror_disassemble(ms, err, msg, sizeof(msg));\n\t\t\tui__error(\"Couldn't annotate %s:\\n%s\", sym->name, msg);\n\t\t\tgoto out_free_offsets;\n\t\t}\n\t}\n\n\tui_helpline__push(\"Press ESC to exit\");\n\n\tbrowser.b.width = notes->max_line_len;\n\tbrowser.b.nr_entries = notes->nr_entries;\n\tbrowser.b.entries = &notes->src->source,\n\tbrowser.b.width += 18;  \n\n\tif (notes->options->hide_src_code)\n\t\tui_browser__init_asm_mode(&browser.b);\n\n\tret = annotate_browser__run(&browser, evsel, hbt);\n\n\tif(not_annotated)\n\t\tannotated_source__purge(notes->src);\n\nout_free_offsets:\n\tif(not_annotated)\n\t\tzfree(&notes->offsets);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}