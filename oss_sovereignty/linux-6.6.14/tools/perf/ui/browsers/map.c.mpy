{
  "module_name": "map.c",
  "hash_id": "bb8025e03085d690d73066cea72abeda655b6940379c78706e35ff7c2b864856",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/ui/browsers/map.c",
  "human_readable_source": "\n#include <elf.h>\n#include <inttypes.h>\n#include <sys/ttydefaults.h>\n#include <stdlib.h>\n#include <string.h>\n#include <linux/bitops.h>\n#include \"../../util/debug.h\"\n#include \"../../util/map.h\"\n#include \"../../util/dso.h\"\n#include \"../../util/symbol.h\"\n#include \"../browser.h\"\n#include \"../helpline.h\"\n#include \"../keysyms.h\"\n#include \"map.h\"\n\n#include <linux/ctype.h>\n\nstruct map_browser {\n\tstruct ui_browser b;\n\tstruct map\t  *map;\n\tu8\t\t  addrlen;\n};\n\nstatic void map_browser__write(struct ui_browser *browser, void *nd, int row)\n{\n\tstruct symbol *sym = rb_entry(nd, struct symbol, rb_node);\n\tstruct map_browser *mb = container_of(browser, struct map_browser, b);\n\tbool current_entry = ui_browser__is_current_entry(browser, row);\n\tint width;\n\n\tui_browser__set_percent_color(browser, 0, current_entry);\n\tui_browser__printf(browser, \"%*\" PRIx64 \" %*\" PRIx64 \" %c \",\n\t\t\t   mb->addrlen, sym->start, mb->addrlen, sym->end,\n\t\t\t   sym->binding == STB_GLOBAL ? 'g' :\n\t\t\t\tsym->binding == STB_LOCAL  ? 'l' : 'w');\n\twidth = browser->width - ((mb->addrlen * 2) + 4);\n\tif (width > 0)\n\t\tui_browser__write_nstring(browser, sym->name, width);\n}\n\n \nstatic u32 *symbol__browser_index(struct symbol *browser)\n{\n\treturn ((void *)browser) - sizeof(struct rb_node) - sizeof(u32);\n}\n\nstatic int map_browser__search(struct map_browser *browser)\n{\n\tchar target[512];\n\tstruct symbol *sym;\n\tint err = ui_browser__input_window(\"Search by name/addr\",\n\t\t\t\t\t   \"Prefix with 0x to search by address\",\n\t\t\t\t\t   target, \"ENTER: OK, ESC: Cancel\", 0);\n\tif (err != K_ENTER)\n\t\treturn -1;\n\n\tif (target[0] == '0' && tolower(target[1]) == 'x') {\n\t\tu64 addr = strtoull(target, NULL, 16);\n\t\tsym = map__find_symbol(browser->map, addr);\n\t} else\n\t\tsym = map__find_symbol_by_name(browser->map, target);\n\n\tif (sym != NULL) {\n\t\tu32 *idx = symbol__browser_index(sym);\n\n\t\tbrowser->b.top = &sym->rb_node;\n\t\tbrowser->b.index = browser->b.top_idx = *idx;\n\t} else\n\t\tui_helpline__fpush(\"%s not found!\", target);\n\n\treturn 0;\n}\n\nstatic int map_browser__run(struct map_browser *browser)\n{\n\tint key;\n\n\tif (ui_browser__show(&browser->b, map__dso(browser->map)->long_name,\n\t\t\t     \"Press ESC to exit, %s / to search\",\n\t\t\t     verbose > 0 ? \"\" : \"restart with -v to use\") < 0)\n\t\treturn -1;\n\n\twhile (1) {\n\t\tkey = ui_browser__run(&browser->b, 0);\n\n\t\tswitch (key) {\n\t\tcase '/':\n\t\t\tif (verbose > 0)\n\t\t\t\tmap_browser__search(browser);\n\t\tdefault:\n\t\t\tbreak;\n                case K_LEFT:\n                case K_ESC:\n                case 'q':\n                case CTRL('c'):\n                        goto out;\n\t\t}\n\t}\nout:\n\tui_browser__hide(&browser->b);\n\treturn key;\n}\n\nint map__browse(struct map *map)\n{\n\tstruct map_browser mb = {\n\t\t.b = {\n\t\t\t.entries = &map__dso(map)->symbols,\n\t\t\t.refresh = ui_browser__rb_tree_refresh,\n\t\t\t.seek\t = ui_browser__rb_tree_seek,\n\t\t\t.write\t = map_browser__write,\n\t\t},\n\t\t.map = map,\n\t};\n\tstruct rb_node *nd;\n\tchar tmp[BITS_PER_LONG / 4];\n\tu64 maxaddr = 0;\n\n\tfor (nd = rb_first(mb.b.entries); nd; nd = rb_next(nd)) {\n\t\tstruct symbol *pos = rb_entry(nd, struct symbol, rb_node);\n\n\t\tif (maxaddr < pos->end)\n\t\t\tmaxaddr = pos->end;\n\t\tif (verbose > 0) {\n\t\t\tu32 *idx = symbol__browser_index(pos);\n\t\t\t*idx = mb.b.nr_entries;\n\t\t}\n\t\t++mb.b.nr_entries;\n\t}\n\n\tmb.addrlen = snprintf(tmp, sizeof(tmp), \"%\" PRIx64, maxaddr);\n\treturn map_browser__run(&mb);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}