{
  "module_name": "setup.c",
  "hash_id": "639b61d629fe675e482ce36487a86f509356fa57db56af5d329ee4cb13bcca8c",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/ui/setup.c",
  "human_readable_source": "\n#include <dlfcn.h>\n#include <signal.h>\n#include <unistd.h>\n\n#include <subcmd/pager.h>\n#include \"../util/debug.h\"\n#include \"../util/hist.h\"\n#include \"ui.h\"\n\nstruct mutex ui__lock;\nvoid *perf_gtk_handle;\nint use_browser = -1;\n\n#define PERF_GTK_DSO \"libperf-gtk.so\"\n\n#ifdef HAVE_GTK2_SUPPORT\n\nstatic int setup_gtk_browser(void)\n{\n\tint (*perf_ui_init)(void);\n\n\tif (perf_gtk_handle)\n\t\treturn 0;\n\n\tperf_gtk_handle = dlopen(PERF_GTK_DSO, RTLD_LAZY);\n\tif (perf_gtk_handle == NULL) {\n\t\tchar buf[PATH_MAX];\n\t\tscnprintf(buf, sizeof(buf), \"%s/%s\", LIBDIR, PERF_GTK_DSO);\n\t\tperf_gtk_handle = dlopen(buf, RTLD_LAZY);\n\t}\n\tif (perf_gtk_handle == NULL)\n\t\treturn -1;\n\n\tperf_ui_init = dlsym(perf_gtk_handle, \"perf_gtk__init\");\n\tif (perf_ui_init == NULL)\n\t\tgoto out_close;\n\n\tif (perf_ui_init() == 0)\n\t\treturn 0;\n\nout_close:\n\tdlclose(perf_gtk_handle);\n\treturn -1;\n}\n\nstatic void exit_gtk_browser(bool wait_for_ok)\n{\n\tvoid (*perf_ui_exit)(bool);\n\n\tif (perf_gtk_handle == NULL)\n\t\treturn;\n\n\tperf_ui_exit = dlsym(perf_gtk_handle, \"perf_gtk__exit\");\n\tif (perf_ui_exit == NULL)\n\t\tgoto out_close;\n\n\tperf_ui_exit(wait_for_ok);\n\nout_close:\n\tdlclose(perf_gtk_handle);\n\n\tperf_gtk_handle = NULL;\n}\n#else\nstatic inline int setup_gtk_browser(void) { return -1; }\nstatic inline void exit_gtk_browser(bool wait_for_ok __maybe_unused) {}\n#endif\n\nint stdio__config_color(const struct option *opt __maybe_unused,\n\t\t\tconst char *mode, int unset __maybe_unused)\n{\n\tperf_use_color_default = perf_config_colorbool(\"color.ui\", mode, -1);\n\treturn 0;\n}\n\nvoid setup_browser(bool fallback_to_pager)\n{\n\tmutex_init(&ui__lock);\n\tif (use_browser < 2 && (!isatty(1) || dump_trace))\n\t\tuse_browser = 0;\n\n\t \n\tif (use_browser < 0)\n\t\tuse_browser = 1;\n\n\tswitch (use_browser) {\n\tcase 2:\n\t\tif (setup_gtk_browser() == 0)\n\t\t\tbreak;\n\t\tprintf(\"GTK browser requested but could not find %s\\n\",\n\t\t       PERF_GTK_DSO);\n\t\tsleep(1);\n\t\tuse_browser = 1;\n\t\t \n\tcase 1:\n\t\tif (ui__init() == 0)\n\t\t\tbreak;\n\t\t \n\tdefault:\n\t\tuse_browser = 0;\n\t\tif (fallback_to_pager)\n\t\t\tsetup_pager();\n\t\tbreak;\n\t}\n}\n\nvoid exit_browser(bool wait_for_ok)\n{\n\tswitch (use_browser) {\n\tcase 2:\n\t\texit_gtk_browser(wait_for_ok);\n\t\tbreak;\n\n\tcase 1:\n\t\tui__exit(wait_for_ok);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\tmutex_destroy(&ui__lock);\n}\n\nvoid pthread__block_sigwinch(void)\n{\n\tsigset_t set;\n\n\tsigemptyset(&set);\n\tsigaddset(&set, SIGWINCH);\n\tpthread_sigmask(SIG_BLOCK, &set, NULL);\n}\n\nvoid pthread__unblock_sigwinch(void)\n{\n\tsigset_t set;\n\n\tsigemptyset(&set);\n\tsigaddset(&set, SIGWINCH);\n\tpthread_sigmask(SIG_UNBLOCK, &set, NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}