{
  "module_name": "builtin-buildid-list.c",
  "hash_id": "6001ca9247e7d74bb305a23b84eb78d49c9f4a38118b4ea6f73e35c419c4ab7d",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/builtin-buildid-list.c",
  "human_readable_source": " \n#include \"builtin.h\"\n#include \"util/build-id.h\"\n#include \"util/debug.h\"\n#include \"util/dso.h\"\n#include \"util/map.h\"\n#include <subcmd/pager.h>\n#include <subcmd/parse-options.h>\n#include \"util/session.h\"\n#include \"util/symbol.h\"\n#include \"util/data.h\"\n#include \"util/util.h\"\n#include <errno.h>\n#include <inttypes.h>\n#include <linux/err.h>\n\nstatic int buildid__map_cb(struct map *map, void *arg __maybe_unused)\n{\n\tconst struct dso *dso = map__dso(map);\n\tchar bid_buf[SBUILD_ID_SIZE];\n\n\tmemset(bid_buf, 0, sizeof(bid_buf));\n\tif (dso->has_build_id)\n\t\tbuild_id__sprintf(&dso->bid, bid_buf);\n\tprintf(\"%s %16\" PRIx64 \" %16\" PRIx64, bid_buf, map__start(map), map__end(map));\n\tif (dso->long_name != NULL) {\n\t\tprintf(\" %s\", dso->long_name);\n\t} else if (dso->short_name != NULL) {\n\t\tprintf(\" %s\", dso->short_name);\n\t}\n\tprintf(\"\\n\");\n\n\treturn 0;\n}\n\nstatic void buildid__show_kernel_maps(void)\n{\n\tstruct machine *machine;\n\n\tmachine = machine__new_host();\n\tmachine__for_each_kernel_map(machine, buildid__map_cb, NULL);\n\tmachine__delete(machine);\n}\n\nstatic int sysfs__fprintf_build_id(FILE *fp)\n{\n\tchar sbuild_id[SBUILD_ID_SIZE];\n\tint ret;\n\n\tret = sysfs__sprintf_build_id(\"/\", sbuild_id);\n\tif (ret != sizeof(sbuild_id))\n\t\treturn ret < 0 ? ret : -EINVAL;\n\n\treturn fprintf(fp, \"%s\\n\", sbuild_id);\n}\n\nstatic int filename__fprintf_build_id(const char *name, FILE *fp)\n{\n\tchar sbuild_id[SBUILD_ID_SIZE];\n\tint ret;\n\n\tret = filename__sprintf_build_id(name, sbuild_id);\n\tif (ret != sizeof(sbuild_id))\n\t\treturn ret < 0 ? ret : -EINVAL;\n\n\treturn fprintf(fp, \"%s\\n\", sbuild_id);\n}\n\nstatic bool dso__skip_buildid(struct dso *dso, int with_hits)\n{\n\treturn with_hits && !dso->hit;\n}\n\nstatic int perf_session__list_build_ids(bool force, bool with_hits)\n{\n\tstruct perf_session *session;\n\tstruct perf_data data = {\n\t\t.path  = input_name,\n\t\t.mode  = PERF_DATA_MODE_READ,\n\t\t.force = force,\n\t};\n\n\tsymbol__elf_init();\n\t \n\tif (filename__fprintf_build_id(input_name, stdout) > 0)\n\t\tgoto out;\n\n\tsession = perf_session__new(&data, &build_id__mark_dso_hit_ops);\n\tif (IS_ERR(session))\n\t\treturn PTR_ERR(session);\n\n\t \n\tif (!perf_data__is_pipe(&data) &&\n\t    perf_header__has_feat(&session->header, HEADER_AUXTRACE))\n\t\twith_hits = false;\n\n\tif (!perf_header__has_feat(&session->header, HEADER_BUILD_ID))\n\t\twith_hits = true;\n\n\tif (zstd_init(&(session->zstd_data), 0) < 0)\n\t\tpr_warning(\"Decompression initialization failed. Reported data may be incomplete.\\n\");\n\n\t \n\tif (with_hits || perf_data__is_pipe(&data))\n\t\tperf_session__process_events(session);\n\n\tperf_session__fprintf_dsos_buildid(session, stdout, dso__skip_buildid, with_hits);\n\tperf_session__delete(session);\nout:\n\treturn 0;\n}\n\nint cmd_buildid_list(int argc, const char **argv)\n{\n\tbool show_kernel = false;\n\tbool show_kernel_maps = false;\n\tbool with_hits = false;\n\tbool force = false;\n\tconst struct option options[] = {\n\tOPT_BOOLEAN('H', \"with-hits\", &with_hits, \"Show only DSOs with hits\"),\n\tOPT_STRING('i', \"input\", &input_name, \"file\", \"input file name\"),\n\tOPT_BOOLEAN('f', \"force\", &force, \"don't complain, do it\"),\n\tOPT_BOOLEAN('k', \"kernel\", &show_kernel, \"Show current kernel build id\"),\n\tOPT_BOOLEAN('m', \"kernel-maps\", &show_kernel_maps,\n\t    \"Show build id of current kernel + modules\"),\n\tOPT_INCR('v', \"verbose\", &verbose, \"be more verbose\"),\n\tOPT_END()\n\t};\n\tconst char * const buildid_list_usage[] = {\n\t\t\"perf buildid-list [<options>]\",\n\t\tNULL\n\t};\n\n\targc = parse_options(argc, argv, options, buildid_list_usage, 0);\n\tsetup_pager();\n\n\tif (show_kernel) {\n\t\treturn !(sysfs__fprintf_build_id(stdout) > 0);\n\t} else if (show_kernel_maps) {\n\t\tbuildid__show_kernel_maps();\n\t\treturn 0;\n\t}\n\n\treturn perf_session__list_build_ids(force, with_hits);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}