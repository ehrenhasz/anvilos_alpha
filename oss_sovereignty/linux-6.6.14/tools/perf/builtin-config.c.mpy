{
  "module_name": "builtin-config.c",
  "hash_id": "9669361fe8431db950b7179d13e4ae704b63b1aef86363d988e27479b140c829",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/builtin-config.c",
  "human_readable_source": "\n \n#include \"builtin.h\"\n\n#include \"util/cache.h\"\n#include <subcmd/parse-options.h>\n#include \"util/debug.h\"\n#include \"util/config.h\"\n#include <linux/string.h>\n#include <limits.h>\n#include <stdio.h>\n#include <stdlib.h>\n\nstatic bool use_system_config, use_user_config;\n\nstatic const char * const config_usage[] = {\n\t\"perf config [<file-option>] [options] [section.name[=value] ...]\",\n\tNULL\n};\n\nenum actions {\n\tACTION_LIST = 1\n} actions;\n\nstatic struct option config_options[] = {\n\tOPT_SET_UINT('l', \"list\", &actions,\n\t\t     \"show current config variables\", ACTION_LIST),\n\tOPT_BOOLEAN(0, \"system\", &use_system_config, \"use system config file\"),\n\tOPT_BOOLEAN(0, \"user\", &use_user_config, \"use user config file\"),\n\tOPT_END()\n};\n\nstatic int set_config(struct perf_config_set *set, const char *file_name)\n{\n\tstruct perf_config_section *section = NULL;\n\tstruct perf_config_item *item = NULL;\n\tconst char *first_line = \"# this file is auto-generated.\";\n\tFILE *fp;\n\n\tif (set == NULL)\n\t\treturn -1;\n\n\tfp = fopen(file_name, \"w\");\n\tif (!fp)\n\t\treturn -1;\n\n\tfprintf(fp, \"%s\\n\", first_line);\n\n\t \n\tperf_config_items__for_each_entry(&set->sections, section) {\n\t\tif (!use_system_config && section->from_system_config)\n\t\t\tcontinue;\n\t\tfprintf(fp, \"[%s]\\n\", section->name);\n\n\t\tperf_config_items__for_each_entry(&section->items, item) {\n\t\t\tif (!use_system_config && item->from_system_config)\n\t\t\t\tcontinue;\n\t\t\tif (item->value)\n\t\t\t\tfprintf(fp, \"\\t%s = %s\\n\",\n\t\t\t\t\titem->name, item->value);\n\t\t}\n\t}\n\tfclose(fp);\n\n\treturn 0;\n}\n\nstatic int show_spec_config(struct perf_config_set *set, const char *var)\n{\n\tstruct perf_config_section *section;\n\tstruct perf_config_item *item;\n\n\tif (set == NULL)\n\t\treturn -1;\n\n\tperf_config_items__for_each_entry(&set->sections, section) {\n\t\tif (!strstarts(var, section->name))\n\t\t\tcontinue;\n\n\t\tperf_config_items__for_each_entry(&section->items, item) {\n\t\t\tconst char *name = var + strlen(section->name) + 1;\n\n\t\t\tif (strcmp(name, item->name) == 0) {\n\t\t\t\tchar *value = item->value;\n\n\t\t\t\tif (value) {\n\t\t\t\t\tprintf(\"%s=%s\\n\", var, value);\n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int show_config(struct perf_config_set *set)\n{\n\tstruct perf_config_section *section;\n\tstruct perf_config_item *item;\n\n\tif (set == NULL)\n\t\treturn -1;\n\n\tperf_config_set__for_each_entry(set, section, item) {\n\t\tchar *value = item->value;\n\n\t\tif (value)\n\t\t\tprintf(\"%s.%s=%s\\n\", section->name,\n\t\t\t       item->name, value);\n\t}\n\n\treturn 0;\n}\n\nstatic int parse_config_arg(char *arg, char **var, char **value)\n{\n\tconst char *last_dot = strchr(arg, '.');\n\n\t \n\tif (last_dot == NULL || last_dot == arg) {\n\t\tpr_err(\"The config variable does not contain a section name: %s\\n\", arg);\n\t\treturn -1;\n\t}\n\tif (!last_dot[1]) {\n\t\tpr_err(\"The config variable does not contain a variable name: %s\\n\", arg);\n\t\treturn -1;\n\t}\n\n\t*value = strchr(arg, '=');\n\tif (*value == NULL)\n\t\t*var = arg;\n\telse if (!strcmp(*value, \"=\")) {\n\t\tpr_err(\"The config variable does not contain a value: %s\\n\", arg);\n\t\treturn -1;\n\t} else {\n\t\t*value = *value + 1;  \n\t\t*var = strsep(&arg, \"=\");\n\t\tif (*var[0] == '\\0') {\n\t\t\tpr_err(\"invalid config variable: %s\\n\", arg);\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint cmd_config(int argc, const char **argv)\n{\n\tint i, ret = -1;\n\tstruct perf_config_set *set;\n\tchar path[PATH_MAX];\n\tchar *user_config = mkpath(path, sizeof(path), \"%s/.perfconfig\", getenv(\"HOME\"));\n\tconst char *config_filename;\n\tbool changed = false;\n\n\targc = parse_options(argc, argv, config_options, config_usage,\n\t\t\t     PARSE_OPT_STOP_AT_NON_OPTION);\n\n\tif (use_system_config && use_user_config) {\n\t\tpr_err(\"Error: only one config file at a time\\n\");\n\t\tparse_options_usage(config_usage, config_options, \"user\", 0);\n\t\tparse_options_usage(NULL, config_options, \"system\", 0);\n\t\treturn -1;\n\t}\n\n\tif (use_system_config)\n\t\tconfig_exclusive_filename = perf_etc_perfconfig();\n\telse if (use_user_config)\n\t\tconfig_exclusive_filename = user_config;\n\n\tif (!config_exclusive_filename)\n\t\tconfig_filename = user_config;\n\telse\n\t\tconfig_filename = config_exclusive_filename;\n\n\t \n\tset = perf_config_set__new();\n\tif (!set)\n\t\tgoto out_err;\n\n\tswitch (actions) {\n\tcase ACTION_LIST:\n\t\tif (argc) {\n\t\t\tpr_err(\"Error: takes no arguments\\n\");\n\t\t\tparse_options_usage(config_usage, config_options, \"l\", 1);\n\t\t} else {\ndo_action_list:\n\t\t\tif (show_config(set) < 0) {\n\t\t\t\tpr_err(\"Nothing configured, \"\n\t\t\t\t       \"please check your %s \\n\", config_filename);\n\t\t\t\tgoto out_err;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tif (!argc)\n\t\t\tgoto do_action_list;\n\n\t\tfor (i = 0; argv[i]; i++) {\n\t\t\tchar *var, *value;\n\t\t\tchar *arg = strdup(argv[i]);\n\n\t\t\tif (!arg) {\n\t\t\t\tpr_err(\"%s: strdup failed\\n\", __func__);\n\t\t\t\tgoto out_err;\n\t\t\t}\n\n\t\t\tif (parse_config_arg(arg, &var, &value) < 0) {\n\t\t\t\tfree(arg);\n\t\t\t\tgoto out_err;\n\t\t\t}\n\n\t\t\tif (value == NULL) {\n\t\t\t\tif (show_spec_config(set, var) < 0) {\n\t\t\t\t\tpr_err(\"%s is not configured: %s\\n\",\n\t\t\t\t\t       var, config_filename);\n\t\t\t\t\tfree(arg);\n\t\t\t\t\tgoto out_err;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (perf_config_set__collect(set, config_filename,\n\t\t\t\t\t\t\t     var, value) < 0) {\n\t\t\t\t\tpr_err(\"Failed to add '%s=%s'\\n\",\n\t\t\t\t\t       var, value);\n\t\t\t\t\tfree(arg);\n\t\t\t\t\tgoto out_err;\n\t\t\t\t}\n\t\t\t\tchanged = true;\n\t\t\t}\n\t\t\tfree(arg);\n\t\t}\n\n\t\tif (!changed)\n\t\t\tbreak;\n\n\t\tif (set_config(set, config_filename) < 0) {\n\t\t\tpr_err(\"Failed to set the configs on %s\\n\",\n\t\t\t       config_filename);\n\t\t\tgoto out_err;\n\t\t}\n\t}\n\n\tret = 0;\nout_err:\n\tperf_config_set__delete(set);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}