{
  "module_name": "perf.c",
  "hash_id": "a4c54747cafab0584b5c12108fa2a0316018a2c20a975f84e8b7d8119b0de176",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/perf.c",
  "human_readable_source": " \n#include \"builtin.h\"\n#include \"perf.h\"\n\n#include \"util/build-id.h\"\n#include \"util/cache.h\"\n#include \"util/env.h\"\n#include <internal/lib.h> \n#include <subcmd/exec-cmd.h>\n#include \"util/config.h\"\n#include <subcmd/run-command.h>\n#include \"util/parse-events.h\"\n#include <subcmd/parse-options.h>\n#include \"util/debug.h\"\n#include \"util/event.h\"\n#include \"util/util.h\" \n#include \"ui/ui.h\"\n#include \"perf-sys.h\"\n#include <api/fs/fs.h>\n#include <api/fs/tracing_path.h>\n#include <perf/core.h>\n#include <errno.h>\n#include <pthread.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <time.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <unistd.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/zalloc.h>\n\nstatic int use_pager = -1;\n\nstruct cmd_struct {\n\tconst char *cmd;\n\tint (*fn)(int, const char **);\n\tint option;\n};\n\nstatic struct cmd_struct commands[] = {\n\t{ \"archive\",\tNULL,\t0 },\n\t{ \"buildid-cache\", cmd_buildid_cache, 0 },\n\t{ \"buildid-list\", cmd_buildid_list, 0 },\n\t{ \"config\",\tcmd_config,\t0 },\n\t{ \"c2c\",\tcmd_c2c,\t0 },\n\t{ \"diff\",\tcmd_diff,\t0 },\n\t{ \"evlist\",\tcmd_evlist,\t0 },\n\t{ \"help\",\tcmd_help,\t0 },\n\t{ \"iostat\",\tNULL,\t0 },\n\t{ \"kallsyms\",\tcmd_kallsyms,\t0 },\n\t{ \"list\",\tcmd_list,\t0 },\n\t{ \"record\",\tcmd_record,\t0 },\n\t{ \"report\",\tcmd_report,\t0 },\n\t{ \"bench\",\tcmd_bench,\t0 },\n\t{ \"stat\",\tcmd_stat,\t0 },\n#ifdef HAVE_LIBTRACEEVENT\n\t{ \"timechart\",\tcmd_timechart,\t0 },\n#endif\n\t{ \"top\",\tcmd_top,\t0 },\n\t{ \"annotate\",\tcmd_annotate,\t0 },\n\t{ \"version\",\tcmd_version,\t0 },\n\t{ \"script\",\tcmd_script,\t0 },\n#ifdef HAVE_LIBTRACEEVENT\n\t{ \"sched\",\tcmd_sched,\t0 },\n#endif\n#ifdef HAVE_LIBELF_SUPPORT\n\t{ \"probe\",\tcmd_probe,\t0 },\n#endif\n#ifdef HAVE_LIBTRACEEVENT\n\t{ \"kmem\",\tcmd_kmem,\t0 },\n\t{ \"lock\",\tcmd_lock,\t0 },\n#endif\n\t{ \"kvm\",\tcmd_kvm,\t0 },\n\t{ \"test\",\tcmd_test,\t0 },\n#if defined(HAVE_LIBTRACEEVENT) && (defined(HAVE_LIBAUDIT_SUPPORT) || defined(HAVE_SYSCALL_TABLE_SUPPORT))\n\t{ \"trace\",\tcmd_trace,\t0 },\n#endif\n\t{ \"inject\",\tcmd_inject,\t0 },\n\t{ \"mem\",\tcmd_mem,\t0 },\n\t{ \"data\",\tcmd_data,\t0 },\n\t{ \"ftrace\",\tcmd_ftrace,\t0 },\n\t{ \"daemon\",\tcmd_daemon,\t0 },\n#ifdef HAVE_LIBTRACEEVENT\n\t{ \"kwork\",\tcmd_kwork,\t0 },\n#endif\n};\n\nstruct pager_config {\n\tconst char *cmd;\n\tint val;\n};\n\nstatic bool same_cmd_with_prefix(const char *var, struct pager_config *c,\n\t\t\t\t  const char *header)\n{\n\treturn (strstarts(var, header) && !strcmp(var + strlen(header), c->cmd));\n}\n\nstatic int pager_command_config(const char *var, const char *value, void *data)\n{\n\tstruct pager_config *c = data;\n\tif (same_cmd_with_prefix(var, c, \"pager.\"))\n\t\tc->val = perf_config_bool(var, value);\n\treturn 0;\n}\n\n \nstatic int check_pager_config(const char *cmd)\n{\n\tint err;\n\tstruct pager_config c;\n\tc.cmd = cmd;\n\tc.val = -1;\n\terr = perf_config(pager_command_config, &c);\n\treturn err ?: c.val;\n}\n\nstatic int browser_command_config(const char *var, const char *value, void *data)\n{\n\tstruct pager_config *c = data;\n\tif (same_cmd_with_prefix(var, c, \"tui.\"))\n\t\tc->val = perf_config_bool(var, value);\n\tif (same_cmd_with_prefix(var, c, \"gtk.\"))\n\t\tc->val = perf_config_bool(var, value) ? 2 : 0;\n\treturn 0;\n}\n\n \nstatic int check_browser_config(const char *cmd)\n{\n\tint err;\n\tstruct pager_config c;\n\tc.cmd = cmd;\n\tc.val = -1;\n\terr = perf_config(browser_command_config, &c);\n\treturn err ?: c.val;\n}\n\nstatic void commit_pager_choice(void)\n{\n\tswitch (use_pager) {\n\tcase 0:\n\t\tsetenv(PERF_PAGER_ENVIRONMENT, \"cat\", 1);\n\t\tbreak;\n\tcase 1:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstruct option options[] = {\n\tOPT_ARGUMENT(\"help\", \"help\"),\n\tOPT_ARGUMENT(\"version\", \"version\"),\n\tOPT_ARGUMENT(\"exec-path\", \"exec-path\"),\n\tOPT_ARGUMENT(\"html-path\", \"html-path\"),\n\tOPT_ARGUMENT(\"paginate\", \"paginate\"),\n\tOPT_ARGUMENT(\"no-pager\", \"no-pager\"),\n\tOPT_ARGUMENT(\"debugfs-dir\", \"debugfs-dir\"),\n\tOPT_ARGUMENT(\"buildid-dir\", \"buildid-dir\"),\n\tOPT_ARGUMENT(\"list-cmds\", \"list-cmds\"),\n\tOPT_ARGUMENT(\"list-opts\", \"list-opts\"),\n\tOPT_ARGUMENT(\"debug\", \"debug\"),\n\tOPT_END()\n};\n\nstatic int handle_options(const char ***argv, int *argc, int *envchanged)\n{\n\tint handled = 0;\n\n\twhile (*argc > 0) {\n\t\tconst char *cmd = (*argv)[0];\n\t\tif (cmd[0] != '-')\n\t\t\tbreak;\n\n\t\t \n\t\tif (!strcmp(cmd, \"--help\") || !strcmp(cmd, \"--version\"))\n\t\t\tbreak;\n\n\t\t \n\t\tif (!strcmp(cmd, \"-h\")) {\n\t\t\t(*argv)[0] = \"--help\";\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!strcmp(cmd, \"-v\")) {\n\t\t\t(*argv)[0] = \"--version\";\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!strcmp(cmd, \"-vv\")) {\n\t\t\t(*argv)[0] = \"version\";\n\t\t\tverbose = 1;\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (strstarts(cmd, CMD_EXEC_PATH)) {\n\t\t\tcmd += strlen(CMD_EXEC_PATH);\n\t\t\tif (*cmd == '=')\n\t\t\t\tset_argv_exec_path(cmd + 1);\n\t\t\telse {\n\t\t\t\tputs(get_argv_exec_path());\n\t\t\t\texit(0);\n\t\t\t}\n\t\t} else if (!strcmp(cmd, \"--html-path\")) {\n\t\t\tputs(system_path(PERF_HTML_PATH));\n\t\t\texit(0);\n\t\t} else if (!strcmp(cmd, \"-p\") || !strcmp(cmd, \"--paginate\")) {\n\t\t\tuse_pager = 1;\n\t\t} else if (!strcmp(cmd, \"--no-pager\")) {\n\t\t\tuse_pager = 0;\n\t\t\tif (envchanged)\n\t\t\t\t*envchanged = 1;\n\t\t} else if (!strcmp(cmd, \"--debugfs-dir\")) {\n\t\t\tif (*argc < 2) {\n\t\t\t\tfprintf(stderr, \"No directory given for --debugfs-dir.\\n\");\n\t\t\t\tusage(perf_usage_string);\n\t\t\t}\n\t\t\ttracing_path_set((*argv)[1]);\n\t\t\tif (envchanged)\n\t\t\t\t*envchanged = 1;\n\t\t\t(*argv)++;\n\t\t\t(*argc)--;\n\t\t} else if (!strcmp(cmd, \"--buildid-dir\")) {\n\t\t\tif (*argc < 2) {\n\t\t\t\tfprintf(stderr, \"No directory given for --buildid-dir.\\n\");\n\t\t\t\tusage(perf_usage_string);\n\t\t\t}\n\t\t\tset_buildid_dir((*argv)[1]);\n\t\t\tif (envchanged)\n\t\t\t\t*envchanged = 1;\n\t\t\t(*argv)++;\n\t\t\t(*argc)--;\n\t\t} else if (strstarts(cmd, CMD_DEBUGFS_DIR)) {\n\t\t\ttracing_path_set(cmd + strlen(CMD_DEBUGFS_DIR));\n\t\t\tfprintf(stderr, \"dir: %s\\n\", tracing_path_mount());\n\t\t\tif (envchanged)\n\t\t\t\t*envchanged = 1;\n\t\t} else if (!strcmp(cmd, \"--list-cmds\")) {\n\t\t\tunsigned int i;\n\n\t\t\tfor (i = 0; i < ARRAY_SIZE(commands); i++) {\n\t\t\t\tstruct cmd_struct *p = commands+i;\n\t\t\t\tprintf(\"%s \", p->cmd);\n\t\t\t}\n\t\t\tputchar('\\n');\n\t\t\texit(0);\n\t\t} else if (!strcmp(cmd, \"--list-opts\")) {\n\t\t\tunsigned int i;\n\n\t\t\tfor (i = 0; i < ARRAY_SIZE(options)-1; i++) {\n\t\t\t\tstruct option *p = options+i;\n\t\t\t\tprintf(\"--%s \", p->long_name);\n\t\t\t}\n\t\t\tputchar('\\n');\n\t\t\texit(0);\n\t\t} else if (!strcmp(cmd, \"--debug\")) {\n\t\t\tif (*argc < 2) {\n\t\t\t\tfprintf(stderr, \"No variable specified for --debug.\\n\");\n\t\t\t\tusage(perf_usage_string);\n\t\t\t}\n\t\t\tif (perf_debug_option((*argv)[1]))\n\t\t\t\tusage(perf_usage_string);\n\n\t\t\t(*argv)++;\n\t\t\t(*argc)--;\n\t\t} else {\n\t\t\tfprintf(stderr, \"Unknown option: %s\\n\", cmd);\n\t\t\tusage(perf_usage_string);\n\t\t}\n\n\t\t(*argv)++;\n\t\t(*argc)--;\n\t\thandled++;\n\t}\n\treturn handled;\n}\n\n#define RUN_SETUP\t(1<<0)\n#define USE_PAGER\t(1<<1)\n\nstatic int run_builtin(struct cmd_struct *p, int argc, const char **argv)\n{\n\tint status;\n\tstruct stat st;\n\tchar sbuf[STRERR_BUFSIZE];\n\n\tif (use_browser == -1)\n\t\tuse_browser = check_browser_config(p->cmd);\n\n\tif (use_pager == -1 && p->option & RUN_SETUP)\n\t\tuse_pager = check_pager_config(p->cmd);\n\tif (use_pager == -1 && p->option & USE_PAGER)\n\t\tuse_pager = 1;\n\tcommit_pager_choice();\n\n\tperf_env__init(&perf_env);\n\tperf_env__set_cmdline(&perf_env, argc, argv);\n\tstatus = p->fn(argc, argv);\n\tperf_config__exit();\n\texit_browser(status);\n\tperf_env__exit(&perf_env);\n\n\tif (status)\n\t\treturn status & 0xff;\n\n\t \n\tif (fstat(fileno(stdout), &st))\n\t\treturn 0;\n\t \n\tif (S_ISFIFO(st.st_mode) || S_ISSOCK(st.st_mode))\n\t\treturn 0;\n\n\tstatus = 1;\n\t \n\tif (fflush(stdout)) {\n\t\tfprintf(stderr, \"write failure on standard output: %s\",\n\t\t\tstr_error_r(errno, sbuf, sizeof(sbuf)));\n\t\tgoto out;\n\t}\n\tif (ferror(stdout)) {\n\t\tfprintf(stderr, \"unknown write failure on standard output\");\n\t\tgoto out;\n\t}\n\tif (fclose(stdout)) {\n\t\tfprintf(stderr, \"close failed on standard output: %s\",\n\t\t\tstr_error_r(errno, sbuf, sizeof(sbuf)));\n\t\tgoto out;\n\t}\n\tstatus = 0;\nout:\n\treturn status;\n}\n\nstatic void handle_internal_command(int argc, const char **argv)\n{\n\tconst char *cmd = argv[0];\n\tunsigned int i;\n\n\t \n\tif (argc > 1 && !strcmp(argv[1], \"--help\")) {\n\t\targv[1] = argv[0];\n\t\targv[0] = cmd = \"help\";\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(commands); i++) {\n\t\tstruct cmd_struct *p = commands+i;\n\t\tif (p->fn == NULL)\n\t\t\tcontinue;\n\t\tif (strcmp(p->cmd, cmd))\n\t\t\tcontinue;\n\t\texit(run_builtin(p, argc, argv));\n\t}\n}\n\nstatic void execv_dashed_external(const char **argv)\n{\n\tchar *cmd;\n\tconst char *tmp;\n\tint status;\n\n\tif (asprintf(&cmd, \"perf-%s\", argv[0]) < 0)\n\t\tgoto do_die;\n\n\t \n\ttmp = argv[0];\n\targv[0] = cmd;\n\n\t \n\tstatus = run_command_v_opt(argv, 0);\n\tif (status != -ERR_RUN_COMMAND_EXEC) {\n\t\tif (IS_RUN_COMMAND_ERR(status)) {\ndo_die:\n\t\t\tpr_err(\"FATAL: unable to run '%s'\", argv[0]);\n\t\t\tstatus = -128;\n\t\t}\n\t\texit(-status);\n\t}\n\terrno = ENOENT;  \n\n\targv[0] = tmp;\n\tzfree(&cmd);\n}\n\nstatic int run_argv(int *argcp, const char ***argv)\n{\n\t \n\thandle_internal_command(*argcp, *argv);\n\n\t \n\texecv_dashed_external(*argv);\n\treturn 0;\n}\n\nstatic int libperf_print(enum libperf_print_level level,\n\t\t\t const char *fmt, va_list ap)\n{\n\treturn veprintf(level, verbose, fmt, ap);\n}\n\nint main(int argc, const char **argv)\n{\n\tint err;\n\tconst char *cmd;\n\tchar sbuf[STRERR_BUFSIZE];\n\n\tperf_debug_setup();\n\n\t \n\texec_cmd_init(\"perf\", PREFIX, PERF_EXEC_PATH, EXEC_PATH_ENVIRONMENT);\n\tpager_init(PERF_PAGER_ENVIRONMENT);\n\n\tlibperf_init(libperf_print);\n\n\tcmd = extract_argv0_path(argv[0]);\n\tif (!cmd)\n\t\tcmd = \"perf-help\";\n\n\tsrandom(time(NULL));\n\n\t \n\tconfig_exclusive_filename = getenv(\"PERF_CONFIG\");\n\n\terr = perf_config(perf_default_config, NULL);\n\tif (err)\n\t\treturn err;\n\tset_buildid_dir(NULL);\n\n\t \n\tif (strstarts(cmd, \"perf-\")) {\n\t\tcmd += 5;\n\t\targv[0] = cmd;\n\t\thandle_internal_command(argc, argv);\n\t\t \n\t\tcmd -= 5;\n\t\targv[0] = cmd;\n\t}\n\tif (strstarts(cmd, \"trace\")) {\n#ifndef HAVE_LIBTRACEEVENT\n\t\tfprintf(stderr,\n\t\t\t\"trace command not available: missing libtraceevent devel package at build time.\\n\");\n\t\tgoto out;\n#elif !defined(HAVE_LIBAUDIT_SUPPORT) && !defined(HAVE_SYSCALL_TABLE_SUPPORT)\n\t\tfprintf(stderr,\n\t\t\t\"trace command not available: missing audit-libs devel package at build time.\\n\");\n\t\tgoto out;\n#else\n\t\tsetup_path();\n\t\targv[0] = \"trace\";\n\t\treturn cmd_trace(argc, argv);\n#endif\n\t}\n\t \n\targv++;\n\targc--;\n\thandle_options(&argv, &argc, NULL);\n\tcommit_pager_choice();\n\n\tif (argc > 0) {\n\t\tif (strstarts(argv[0], \"--\"))\n\t\t\targv[0] += 2;\n\t} else {\n\t\t \n\t\tprintf(\"\\n usage: %s\\n\\n\", perf_usage_string);\n\t\tlist_common_cmds_help();\n\t\tprintf(\"\\n %s\\n\\n\", perf_more_info_string);\n\t\tgoto out;\n\t}\n\tcmd = argv[0];\n\n\ttest_attr__init();\n\n\t \n\tsetup_path();\n\t \n\tpthread__block_sigwinch();\n\n\twhile (1) {\n\t\tstatic int done_help;\n\n\t\trun_argv(&argc, &argv);\n\n\t\tif (errno != ENOENT)\n\t\t\tbreak;\n\n\t\tif (!done_help) {\n\t\t\tcmd = argv[0] = help_unknown_cmd(cmd);\n\t\t\tdone_help = 1;\n\t\t} else\n\t\t\tbreak;\n\t}\n\n\tfprintf(stderr, \"Failed to run command '%s': %s\\n\",\n\t\tcmd, str_error_r(errno, sbuf, sizeof(sbuf)));\nout:\n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}