{
  "module_name": "security.txt",
  "hash_id": "7d3547a5f18c351f101b7fab811d09872710b6354f2821052e0dd3b6319c9782",
  "original_prompt": "Ingested from linux-6.6.14/tools/perf/Documentation/security.txt",
  "human_readable_source": "Overview\n========\n\nFor general security related questions of perf_event_open() syscall usage,\nperformance monitoring and observability operations by Perf see here:\nhttps://www.kernel.org/doc/html/latest/admin-guide/perf-security.html\n\nEnabling LSM based mandatory access control (MAC) to perf_event_open() syscall\n==============================================================================\n\nLSM hooks for mandatory access control for perf_event_open() syscall can be\nused starting from Linux v5.3. Below are the steps to extend Fedora (v31) with\nTargeted policy with perf_event_open() access control capabilities:\n\n1. Download selinux-policy SRPM package (e.g. selinux-policy-3.14.4-48.fc31.src.rpm on FC31)\n   and install it so rpmbuild directory would exist in the current working directory:\n\n   # rpm -Uhv selinux-policy-3.14.4-48.fc31.src.rpm\n\n2. Get into rpmbuild/SPECS directory and unpack the source code:\n\n   # rpmbuild -bp selinux-policy.spec\n\n3. Place patch below at rpmbuild/BUILD/selinux-policy-b86eaaf4dbcf2d51dd4432df7185c0eaf3cbcc02\n   directory and apply it:\n\n   # patch -p1 < selinux-policy-perf-events-perfmon.patch\n   patching file policy/flask/access_vectors\n   patching file policy/flask/security_classes\n   # cat selinux-policy-perf-events-perfmon.patch\ndiff -Nura a/policy/flask/access_vectors b/policy/flask/access_vectors\n--- a/policy/flask/access_vectors\t2020-02-04 18:19:53.000000000 +0300\n+++ b/policy/flask/access_vectors\t2020-02-28 23:37:25.000000000 +0300\n@@ -174,6 +174,7 @@\n \twake_alarm\n \tblock_suspend\n \taudit_read\n+\tperfmon\n }\n \n #\n@@ -1099,3 +1100,15 @@\n \n class xdp_socket\n inherits socket\n+\n+class perf_event\n+{\n+\topen\n+\tcpu\n+\tkernel\n+\ttracepoint\n+\tread\n+\twrite\n+}\n+\n+\ndiff -Nura a/policy/flask/security_classes b/policy/flask/security_classes\n--- a/policy/flask/security_classes\t2020-02-04 18:19:53.000000000 +0300\n+++ b/policy/flask/security_classes\t2020-02-28 21:35:17.000000000 +0300\n@@ -200,4 +200,6 @@\n \n class xdp_socket\n \n+class perf_event\n+\n # FLASK\n\n4. Get into rpmbuild/SPECS directory and build policy packages from patched sources:\n\n   # rpmbuild --noclean --noprep -ba selinux-policy.spec\n\n   so you have this:\n\n   # ls -alh rpmbuild/RPMS/noarch/\n   total 33M\n   drwxr-xr-x. 2 root root 4.0K Mar 20 12:16 .\n   drwxr-xr-x. 3 root root 4.0K Mar 20 12:16 ..\n   -rw-r--r--. 1 root root 112K Mar 20 12:16 selinux-policy-3.14.4-48.fc31.noarch.rpm\n   -rw-r--r--. 1 root root 1.2M Mar 20 12:17 selinux-policy-devel-3.14.4-48.fc31.noarch.rpm\n   -rw-r--r--. 1 root root 2.3M Mar 20 12:17 selinux-policy-doc-3.14.4-48.fc31.noarch.rpm\n   -rw-r--r--. 1 root root  12M Mar 20 12:17 selinux-policy-minimum-3.14.4-48.fc31.noarch.rpm\n   -rw-r--r--. 1 root root 4.5M Mar 20 12:16 selinux-policy-mls-3.14.4-48.fc31.noarch.rpm\n   -rw-r--r--. 1 root root 111K Mar 20 12:16 selinux-policy-sandbox-3.14.4-48.fc31.noarch.rpm\n   -rw-r--r--. 1 root root  14M Mar 20 12:17 selinux-policy-targeted-3.14.4-48.fc31.noarch.rpm\n\n5. Install SELinux packages from Fedora repo, if not already done so, and\n   update with the patched rpms above:\n\n   # rpm -Uhv rpmbuild/RPMS/noarch/selinux-policy-*\n\n6. Enable SELinux Permissive mode for Targeted policy, if not already done so:\n\n   # cat /etc/selinux/config\n\n   # This file controls the state of SELinux on the system.\n   # SELINUX= can take one of these three values:\n   #     enforcing - SELinux security policy is enforced.\n   #     permissive - SELinux prints warnings instead of enforcing.\n   #     disabled - No SELinux policy is loaded.\n   SELINUX=permissive\n   # SELINUXTYPE= can take one of these three values:\n   #     targeted - Targeted processes are protected,\n   #     minimum - Modification of targeted policy. Only selected processes are protected.\n   #     mls - Multi Level Security protection.\n   SELINUXTYPE=targeted\n\n7. Enable filesystem SELinux labeling at the next reboot:\n\n   # touch /.autorelabel\n\n8. Reboot machine and it will label filesystems and load Targeted policy into the kernel;\n\n9. Login and check that dmesg output doesn't mention that perf_event class is unknown to SELinux subsystem;\n\n10. Check that SELinux is enabled and in Permissive mode\n\n    # getenforce\n    Permissive\n\n11. Turn SELinux into Enforcing mode:\n\n    # setenforce 1\n    # getenforce\n    Enforcing\n\nOpening access to perf_event_open() syscall on Fedora with SELinux\n==================================================================\n\nAccess to performance monitoring and observability operations by Perf\ncan be limited for superuser or CAP_PERFMON or CAP_SYS_ADMIN privileged\nprocesses. MAC policy settings (e.g. SELinux) can be loaded into the kernel\nand prevent unauthorized access to perf_event_open() syscall. In such case\nPerf tool provides a message similar to the one below:\n\n   # perf stat\n   Error:\n   Access to performance monitoring and observability operations is limited.\n   Enforced MAC policy settings (SELinux) can limit access to performance\n   monitoring and observability operations. Inspect system audit records for\n   more perf_event access control information and adjusting the policy.\n   Consider adjusting /proc/sys/kernel/perf_event_paranoid setting to open\n   access to performance monitoring and observability operations for users\n   without CAP_PERFMON or CAP_SYS_ADMIN Linux capability.\n   perf_event_paranoid setting is -1:\n     -1: Allow use of (almost) all events by all users\n         Ignore mlock limit after perf_event_mlock_kb without CAP_IPC_LOCK\n   >= 0: Disallow raw and ftrace function tracepoint access\n   >= 1: Disallow CPU event access\n   >= 2: Disallow kernel profiling\n   To make the adjusted perf_event_paranoid setting permanent preserve it\n   in /etc/sysctl.conf (e.g. kernel.perf_event_paranoid = <setting>)\n\nTo make sure that access is limited by MAC policy settings inspect system\naudit records using journalctl command or /var/log/audit/audit.log so the\noutput would contain AVC denied records related to perf_event:\n\n   # journalctl --reverse --no-pager | grep perf_event\n\n   python3[1318099]: SELinux is preventing perf from open access on the perf_event labeled unconfined_t.\n                                         If you believe that perf should be allowed open access on perf_event labeled unconfined_t by default.\n   setroubleshoot[1318099]: SELinux is preventing perf from open access on the perf_event labeled unconfined_t. For complete SELinux messages run: sealert -l 4595ce5b-e58f-462c-9d86-3bc2074935de\n   audit[1318098]: AVC avc:  denied  { open } for  pid=1318098 comm=\"perf\" scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tclass=perf_event permissive=0\n\nIn order to open access to perf_event_open() syscall MAC policy settings can\nrequire to be extended. On SELinux system this can be done by loading a special\npolicy module extending base policy settings. Perf related policy module can\nbe generated using the system audit records about blocking perf_event access.\nRun the command below to generate my-perf.te policy extension file with\nperf_event related rules:\n\n   # ausearch -c 'perf' --raw | audit2allow -M my-perf && cat my-perf.te\n\n   module my-perf 1.0;\n\n   require {\n        type unconfined_t;\n        class perf_event { cpu kernel open read tracepoint write };\n   }\n\n   #============= unconfined_t ==============\n   allow unconfined_t self:perf_event { cpu kernel open read tracepoint write };\n\nNow compile, pack and load my-perf.pp extension module into the kernel:\n\n   # checkmodule -M -m -o my-perf.mod my-perf.te\n   # semodule_package -o my-perf.pp -m my-perf.mod\n   # semodule -X 300 -i my-perf.pp\n\nAfter all those taken steps above access to perf_event_open() syscall should\nnow be allowed by the policy settings. Check access running Perf like this:\n\n   # perf stat\n   ^C\n   Performance counter stats for 'system wide':\n\n         36,387.41 msec cpu-clock                 #    7.999 CPUs utilized\n             2,629      context-switches          #    0.072 K/sec\n                57      cpu-migrations            #    0.002 K/sec\n                 1      page-faults               #    0.000 K/sec\n       263,721,559      cycles                    #    0.007 GHz\n       175,746,713      instructions              #    0.67  insn per cycle\n        19,628,798      branches                  #    0.539 M/sec\n         1,259,201      branch-misses             #    6.42% of all branches\n\n       4.549061439 seconds time elapsed\n\nThe generated perf-event.pp related policy extension module can be removed\nfrom the kernel using this command:\n\n   # semodule -X 300 -r my-perf\n\nAlternatively the module can be temporarily disabled and enabled back using\nthese two commands:\n\n   # semodule -d my-perf\n   # semodule -e my-perf\n\nIf something went wrong\n=======================\n\nTo turn SELinux into Permissive mode:\n   # setenforce 0\n\nTo fully disable SELinux during kernel boot [3] set kernel command line parameter selinux=0\n\nTo remove SELinux labeling from local filesystems:\n   # find / -mount -print0 | xargs -0 setfattr -h -x security.selinux\n\nTo fully turn SELinux off a machine set SELINUX=disabled at /etc/selinux/config file and reboot;\n\nLinks\n=====\n\n[1] https://download-ib01.fedoraproject.org/pub/fedora/linux/updates/31/Everything/SRPMS/Packages/s/selinux-policy-3.14.4-49.fc31.src.rpm\n[2] https://docs.fedoraproject.org/en-US/Fedora/11/html/Security-Enhanced_Linux/sect-Security-Enhanced_Linux-Working_with_SELinux-Enabling_and_Disabling_SELinux.html\n[3] https://danwalsh.livejournal.com/10972.html\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}