{
  "module_name": "main.h",
  "hash_id": "f18a2c3ceb766831944c24fe4139d79e1e334db74797580f89ed4123ede59ea7",
  "original_prompt": "Ingested from linux-6.6.14/tools/virtio/ringtest/main.h",
  "human_readable_source": " \n \n#ifndef MAIN_H\n#define MAIN_H\n\n#include <assert.h>\n#include <stdbool.h>\n\nextern int param;\n\nextern bool do_exit;\n\n#if defined(__x86_64__) || defined(__i386__)\n#include \"x86intrin.h\"\n\nstatic inline void wait_cycles(unsigned long long cycles)\n{\n\tunsigned long long t;\n\n\tt = __rdtsc();\n\twhile (__rdtsc() - t < cycles) {}\n}\n\n#define VMEXIT_CYCLES 500\n#define VMENTRY_CYCLES 500\n\n#elif defined(__s390x__)\nstatic inline void wait_cycles(unsigned long long cycles)\n{\n\tasm volatile(\"0: brctg %0,0b\" : : \"d\" (cycles));\n}\n\n \n#define VMEXIT_CYCLES 200\n#define VMENTRY_CYCLES 200\n\n#else\nstatic inline void wait_cycles(unsigned long long cycles)\n{\n\t_Exit(5);\n}\n#define VMEXIT_CYCLES 0\n#define VMENTRY_CYCLES 0\n#endif\n\nstatic inline void vmexit(void)\n{\n\tif (!do_exit)\n\t\treturn;\n\t\n\twait_cycles(VMEXIT_CYCLES);\n}\nstatic inline void vmentry(void)\n{\n\tif (!do_exit)\n\t\treturn;\n\t\n\twait_cycles(VMENTRY_CYCLES);\n}\n\n \nvoid alloc_ring(void);\n \nint add_inbuf(unsigned, void *, void *);\nvoid *get_buf(unsigned *, void **);\nvoid disable_call();\nbool used_empty();\nbool enable_call();\nvoid kick_available();\n \nvoid disable_kick();\nbool avail_empty();\nbool enable_kick();\nbool use_buf(unsigned *, void **);\nvoid call_used();\n\n \nextern bool do_sleep;\nvoid kick(void);\nvoid wait_for_kick(void);\nvoid call(void);\nvoid wait_for_call(void);\n\nextern unsigned ring_size;\n\n \n#define barrier() asm volatile(\"\" ::: \"memory\")\n\n \n#if defined(__x86_64__) || defined(__i386__)\n#define cpu_relax() asm (\"rep; nop\" ::: \"memory\")\n#elif defined(__s390x__)\n#define cpu_relax() barrier()\n#elif defined(__aarch64__)\n#define cpu_relax() asm (\"yield\" ::: \"memory\")\n#else\n#define cpu_relax() assert(0)\n#endif\n\nextern bool do_relax;\n\nstatic inline void busy_wait(void)\n{\n\tif (do_relax)\n\t\tcpu_relax();\n\telse\n\t\t \n\t\tbarrier();\n} \n\n#if defined(__x86_64__) || defined(__i386__)\n#define smp_mb()     asm volatile(\"lock; addl $0,-132(%%rsp)\" ::: \"memory\", \"cc\")\n#elif defined(__aarch64__)\n#define smp_mb()     asm volatile(\"dmb ish\" ::: \"memory\")\n#else\n \n#define smp_mb() __sync_synchronize()\n#endif\n\n \n#define smp_release() do { \\\n    barrier(); \\\n    __atomic_thread_fence(__ATOMIC_RELEASE); \\\n} while (0)\n\n#define smp_acquire() do { \\\n    __atomic_thread_fence(__ATOMIC_ACQUIRE); \\\n    barrier(); \\\n} while (0)\n\n#if defined(__i386__) || defined(__x86_64__) || defined(__s390x__)\n#define smp_wmb() barrier()\n#elif defined(__aarch64__)\n#define smp_wmb() asm volatile(\"dmb ishst\" ::: \"memory\")\n#else\n#define smp_wmb() smp_release()\n#endif\n\n#ifndef __always_inline\n#define __always_inline inline __attribute__((always_inline))\n#endif\n\nstatic __always_inline\nvoid __read_once_size(const volatile void *p, void *res, int size)\n{\n\tswitch (size) {\n\tcase 1: *(unsigned char *)res = *(volatile unsigned char *)p; break;\n\tcase 2: *(unsigned short *)res = *(volatile unsigned short *)p; break;\n\tcase 4: *(unsigned int *)res = *(volatile unsigned int *)p; break;\n\tcase 8: *(unsigned long long *)res = *(volatile unsigned long long *)p; break;\n\tdefault:\n\t\tbarrier();\n\t\t__builtin_memcpy((void *)res, (const void *)p, size);\n\t\tbarrier();\n\t}\n}\n\nstatic __always_inline void __write_once_size(volatile void *p, void *res, int size)\n{\n\tswitch (size) {\n\tcase 1: *(volatile unsigned char *)p = *(unsigned char *)res; break;\n\tcase 2: *(volatile unsigned short *)p = *(unsigned short *)res; break;\n\tcase 4: *(volatile unsigned int *)p = *(unsigned int *)res; break;\n\tcase 8: *(volatile unsigned long long *)p = *(unsigned long long *)res; break;\n\tdefault:\n\t\tbarrier();\n\t\t__builtin_memcpy((void *)p, (const void *)res, size);\n\t\tbarrier();\n\t}\n}\n\n#ifdef __alpha__\n#define READ_ONCE(x) \\\n({\t\t\t\t\t\t\t\t\t\\\n\tunion { typeof(x) __val; char __c[1]; } __u;\t\t\t\\\n\t__read_once_size(&(x), __u.__c, sizeof(x));\t\t\\\n\tsmp_mb();  \t\t\\\n\t__u.__val;\t\t\t\t\t\t\t\\\n})\n#else\n#define READ_ONCE(x)\t\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tunion { typeof(x) __val; char __c[1]; } __u;\t\t\t\\\n\t__read_once_size(&(x), __u.__c, sizeof(x));\t\t\t\\\n\t__u.__val;\t\t\t\t\t\t\t\\\n})\n#endif\n\n#define WRITE_ONCE(x, val) \\\n({\t\t\t\t\t\t\t\\\n\tunion { typeof(x) __val; char __c[1]; } __u =\t\\\n\t\t{ .__val = (typeof(x)) (val) }; \\\n\t__write_once_size(&(x), __u.__c, sizeof(x));\t\\\n\t__u.__val;\t\t\t\t\t\\\n})\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}