{
  "module_name": "usbip_device_driver.c",
  "hash_id": "4e076e5273c75f6dcbd186aec9bda4cabce62e3ce7de0e81fa230bde565f3826",
  "original_prompt": "Ingested from linux-6.6.14/tools/usb/usbip/libsrc/usbip_device_driver.c",
  "human_readable_source": "\n \n\n#include <fcntl.h>\n#include <string.h>\n#include <linux/usb/ch9.h>\n\n#include <unistd.h>\n\n#include \"usbip_host_common.h\"\n#include \"usbip_device_driver.h\"\n\n#undef  PROGNAME\n#define PROGNAME \"libusbip\"\n\n#define copy_descr_attr16(dev, descr, attr)\t\t\t\\\n\t\t((dev)->attr = le16toh((descr)->attr))\t\t\\\n\n#define copy_descr_attr(dev, descr, attr)\t\t\t\\\n\t\t((dev)->attr = (descr)->attr)\t\t\t\\\n\n#define ARRAY_SIZE(arr) (sizeof(arr) / sizeof((arr)[0]))\n\nstatic struct {\n\tenum usb_device_speed speed;\n\tconst char *name;\n} speed_names[] = {\n\t{\n\t\t.speed = USB_SPEED_UNKNOWN,\n\t\t.name = \"UNKNOWN\",\n\t},\n\t{\n\t\t.speed = USB_SPEED_LOW,\n\t\t.name = \"low-speed\",\n\t},\n\t{\n\t\t.speed = USB_SPEED_FULL,\n\t\t.name = \"full-speed\",\n\t},\n\t{\n\t\t.speed = USB_SPEED_HIGH,\n\t\t.name = \"high-speed\",\n\t},\n\t{\n\t\t.speed = USB_SPEED_WIRELESS,\n\t\t.name = \"wireless\",\n\t},\n\t{\n\t\t.speed = USB_SPEED_SUPER,\n\t\t.name = \"super-speed\",\n\t},\n};\n\nstatic\nint read_usb_vudc_device(struct udev_device *sdev, struct usbip_usb_device *dev)\n{\n\tconst char *path, *name;\n\tchar filepath[SYSFS_PATH_MAX];\n\tstruct usb_device_descriptor descr;\n\tunsigned int i;\n\tFILE *fd = NULL;\n\tstruct udev_device *plat;\n\tconst char *speed;\n\tsize_t ret;\n\n\tplat = udev_device_get_parent(sdev);\n\tpath = udev_device_get_syspath(plat);\n\tsnprintf(filepath, SYSFS_PATH_MAX, \"%s/%s\",\n\t\t path, VUDC_DEVICE_DESCR_FILE);\n\tfd = fopen(filepath, \"r\");\n\tif (!fd)\n\t\treturn -1;\n\tret = fread((char *) &descr, sizeof(descr), 1, fd);\n\tif (ret != 1) {\n\t\terr(\"Cannot read vudc device descr file: %s\", strerror(errno));\n\t\tgoto err;\n\t}\n\tfclose(fd);\n\n\tcopy_descr_attr(dev, &descr, bDeviceClass);\n\tcopy_descr_attr(dev, &descr, bDeviceSubClass);\n\tcopy_descr_attr(dev, &descr, bDeviceProtocol);\n\tcopy_descr_attr(dev, &descr, bNumConfigurations);\n\tcopy_descr_attr16(dev, &descr, idVendor);\n\tcopy_descr_attr16(dev, &descr, idProduct);\n\tcopy_descr_attr16(dev, &descr, bcdDevice);\n\n\tstrncpy(dev->path, path, SYSFS_PATH_MAX - 1);\n\tdev->path[SYSFS_PATH_MAX - 1] = '\\0';\n\n\tdev->speed = USB_SPEED_UNKNOWN;\n\tspeed = udev_device_get_sysattr_value(sdev, \"current_speed\");\n\tif (speed) {\n\t\tfor (i = 0; i < ARRAY_SIZE(speed_names); i++) {\n\t\t\tif (!strcmp(speed_names[i].name, speed)) {\n\t\t\t\tdev->speed = speed_names[i].speed;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tdev->bNumInterfaces = 0;\n\tdev->bConfigurationValue = 0;\n\tdev->busnum = 0;\n\n\tname = udev_device_get_sysname(plat);\n\tstrncpy(dev->busid, name, SYSFS_BUS_ID_SIZE - 1);\n\tdev->busid[SYSFS_BUS_ID_SIZE - 1] = '\\0';\n\treturn 0;\nerr:\n\tfclose(fd);\n\treturn -1;\n}\n\nstatic int is_my_device(struct udev_device *dev)\n{\n\tconst char *driver;\n\n\tdriver = udev_device_get_property_value(dev, \"USB_UDC_NAME\");\n\treturn driver != NULL && !strcmp(driver, USBIP_DEVICE_DRV_NAME);\n}\n\nstatic int usbip_device_driver_open(struct usbip_host_driver *hdriver)\n{\n\tint ret;\n\n\thdriver->ndevs = 0;\n\tINIT_LIST_HEAD(&hdriver->edev_list);\n\n\tret = usbip_generic_driver_open(hdriver);\n\tif (ret)\n\t\terr(\"please load \" USBIP_CORE_MOD_NAME \".ko and \"\n\t\t    USBIP_DEVICE_DRV_NAME \".ko!\");\n\n\treturn ret;\n}\n\nstruct usbip_host_driver device_driver = {\n\t.edev_list = LIST_HEAD_INIT(device_driver.edev_list),\n\t.udev_subsystem = \"udc\",\n\t.ops = {\n\t\t.open = usbip_device_driver_open,\n\t\t.close = usbip_generic_driver_close,\n\t\t.refresh_device_list = usbip_generic_refresh_device_list,\n\t\t.get_device = usbip_generic_get_device,\n\t\t.read_device = read_usb_vudc_device,\n\t\t.is_my_device = is_my_device,\n\t},\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}