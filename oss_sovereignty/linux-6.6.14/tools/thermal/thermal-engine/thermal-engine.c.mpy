{
  "module_name": "thermal-engine.c",
  "hash_id": "50764c432a3d7ad1c227883a18e1425c03707fb1d07c74416ad80923371ec242",
  "original_prompt": "Ingested from linux-6.6.14/tools/thermal/thermal-engine/thermal-engine.c",
  "human_readable_source": "\n \n#include <errno.h>\n#include <fcntl.h>\n#include <getopt.h>\n#include <libgen.h>\n#include <limits.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <signal.h>\n#include <unistd.h>\n\n#include <syslog.h>\n\n#include <sys/epoll.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n\n#include <thermal.h>\n#include \"thermal-tools.h\"\n\nstruct options {\n\tint loglevel;\n\tint logopt;\n\tint interactive;\n\tint daemonize;\n};\n\nstruct thermal_data {\n\tstruct thermal_zone *tz;\n\tstruct thermal_handler *th;\n};\n\nstatic int show_trip(struct thermal_trip *tt, __maybe_unused void *arg)\n{\n\tINFO(\"trip id=%d, type=%d, temp=%d, hyst=%d\\n\",\n\t     tt->id, tt->type, tt->temp, tt->hyst);\n\n\treturn 0;\n}\n\nstatic int show_temp(struct thermal_zone *tz, __maybe_unused void *arg)\n{\n\tthermal_cmd_get_temp(arg, tz);\n\n\tINFO(\"temperature: %d\\n\", tz->temp);\n\n\treturn 0;\n}\n\nstatic int show_governor(struct thermal_zone *tz, __maybe_unused void *arg)\n{\n\tthermal_cmd_get_governor(arg, tz);\n\n\tINFO(\"governor: '%s'\\n\", tz->governor);\n\n\treturn 0;\n}\n\nstatic int show_tz(struct thermal_zone *tz, __maybe_unused void *arg)\n{\n\tINFO(\"thermal zone '%s', id=%d\\n\", tz->name, tz->id);\n\n\tfor_each_thermal_trip(tz->trip, show_trip, NULL);\n\n\tshow_temp(tz, arg);\n\n\tshow_governor(tz, arg);\n\n\treturn 0;\n}\n\nstatic int tz_create(const char *name, int tz_id, __maybe_unused void *arg)\n{\n\tINFO(\"Thermal zone '%s'/%d created\\n\", name, tz_id);\n\n\treturn 0;\n}\n\nstatic int tz_delete(int tz_id, __maybe_unused void *arg)\n{\n\tINFO(\"Thermal zone %d deleted\\n\", tz_id);\n\n\treturn 0;\n}\n\nstatic int tz_disable(int tz_id, void *arg)\n{\n\tstruct thermal_data *td = arg;\n\tstruct thermal_zone *tz = thermal_zone_find_by_id(td->tz, tz_id);\n\n\tINFO(\"Thermal zone %d ('%s') disabled\\n\", tz_id, tz->name);\n\n\treturn 0;\n}\n\nstatic int tz_enable(int tz_id, void *arg)\n{\n\tstruct thermal_data *td = arg;\n\tstruct thermal_zone *tz = thermal_zone_find_by_id(td->tz, tz_id);\n\n\tINFO(\"Thermal zone %d ('%s') enabled\\n\", tz_id, tz->name);\n\n\treturn 0;\n}\n\nstatic int trip_high(int tz_id, int trip_id, int temp, void *arg)\n{\n\tstruct thermal_data *td = arg;\n\tstruct thermal_zone *tz = thermal_zone_find_by_id(td->tz, tz_id);\n\n\tINFO(\"Thermal zone %d ('%s'): trip point %d crossed way up with %d \u00b0C\\n\",\n\t     tz_id, tz->name, trip_id, temp);\n\n\treturn 0;\n}\n\nstatic int trip_low(int tz_id, int trip_id, int temp, void *arg)\n{\n\tstruct thermal_data *td = arg;\n\tstruct thermal_zone *tz = thermal_zone_find_by_id(td->tz, tz_id);\n\n\tINFO(\"Thermal zone %d ('%s'): trip point %d crossed way down with %d \u00b0C\\n\",\n\t     tz_id, tz->name, trip_id, temp);\n\n\treturn 0;\n}\n\nstatic int trip_add(int tz_id, int trip_id, int type, int temp, int hyst, __maybe_unused void *arg)\n{\n\tINFO(\"Trip point added %d: id=%d, type=%d, temp=%d, hyst=%d\\n\",\n\t     tz_id, trip_id, type, temp, hyst);\n\n\treturn 0;\n}\n\nstatic int trip_delete(int tz_id, int trip_id, __maybe_unused void *arg)\n{\n\tINFO(\"Trip point deleted %d: id=%d\\n\", tz_id, trip_id);\n\n\treturn 0;\n}\n\nstatic int trip_change(int tz_id, int trip_id, int type, int temp,\n\t\t       int hyst, __maybe_unused void *arg)\n{\n\tstruct thermal_data *td = arg;\n\tstruct thermal_zone *tz = thermal_zone_find_by_id(td->tz, tz_id);\n\n\tINFO(\"Trip point changed %d: id=%d, type=%d, temp=%d, hyst=%d\\n\",\n\t     tz_id, trip_id, type, temp, hyst);\n\n\ttz->trip[trip_id].type = type;\n\ttz->trip[trip_id].temp = temp;\n\ttz->trip[trip_id].hyst = hyst;\n\n\treturn 0;\n}\n\nstatic int cdev_add(const char *name, int cdev_id, int max_state, __maybe_unused void *arg)\n{\n\tINFO(\"Cooling device '%s'/%d (max state=%d) added\\n\", name, cdev_id, max_state);\n\n\treturn 0;\n}\n\nstatic int cdev_delete(int cdev_id, __maybe_unused void *arg)\n{\n\tINFO(\"Cooling device %d deleted\", cdev_id);\n\n\treturn 0;\n}\n\nstatic int cdev_update(int cdev_id, int cur_state, __maybe_unused void *arg)\n{\n\tINFO(\"cdev:%d state:%d\\n\", cdev_id, cur_state);\n\n\treturn 0;\n}\n\nstatic int gov_change(int tz_id, const char *name, __maybe_unused void *arg)\n{\n\tstruct thermal_data *td = arg;\n\tstruct thermal_zone *tz = thermal_zone_find_by_id(td->tz, tz_id);\n\n\tINFO(\"%s: governor changed %s -> %s\\n\", tz->name, tz->governor, name);\n\n\tstrcpy(tz->governor, name);\n\n\treturn 0;\n}\n\nstatic struct thermal_ops ops = {\n\t.events.tz_create\t= tz_create,\n\t.events.tz_delete\t= tz_delete,\n\t.events.tz_disable\t= tz_disable,\n\t.events.tz_enable\t= tz_enable,\n\t.events.trip_high\t= trip_high,\n\t.events.trip_low\t= trip_low,\n\t.events.trip_add\t= trip_add,\n\t.events.trip_delete\t= trip_delete,\n\t.events.trip_change\t= trip_change,\n\t.events.cdev_add\t= cdev_add,\n\t.events.cdev_delete\t= cdev_delete,\n\t.events.cdev_update\t= cdev_update,\n\t.events.gov_change\t= gov_change\n};\n\nstatic int thermal_event(__maybe_unused int fd, __maybe_unused void *arg)\n{\n\tstruct thermal_data *td = arg;\n\n\treturn thermal_events_handle(td->th, td);\n}\n\nstatic void usage(const char *cmd)\n{\n\tprintf(\"%s : A thermal monitoring engine based on notifications\\n\", cmd);\n\tprintf(\"Usage: %s [options]\\n\", cmd);\n\tprintf(\"\\t-h, --help\\t\\tthis help\\n\");\n\tprintf(\"\\t-d, --daemonize\\n\");\n\tprintf(\"\\t-l <level>, --loglevel <level>\\tlog level: \");\n\tprintf(\"DEBUG, INFO, NOTICE, WARN, ERROR\\n\");\n\tprintf(\"\\t-s, --syslog\\t\\toutput to syslog\\n\");\n\tprintf(\"\\n\");\n\texit(0);\n}\n\nstatic int options_init(int argc, char *argv[], struct options *options)\n{\n\tint opt;\n\n\tstruct option long_options[] = {\n\t\t{ \"help\",\tno_argument, NULL, 'h' },\n\t\t{ \"daemonize\",\tno_argument, NULL, 'd' },\n\t\t{ \"syslog\",\tno_argument, NULL, 's' },\n\t\t{ \"loglevel\",\trequired_argument, NULL, 'l' },\n\t\t{ 0, 0, 0, 0 }\n\t};\n\n\twhile (1) {\n\n\t\tint optindex = 0;\n\n\t\topt = getopt_long(argc, argv, \"l:dhs\", long_options, &optindex);\n\t\tif (opt == -1)\n\t\t\tbreak;\n\n\t\tswitch (opt) {\n\t\tcase 'l':\n\t\t\toptions->loglevel = log_str2level(optarg);\n\t\t\tbreak;\n\t\tcase 'd':\n\t\t\toptions->daemonize = 1;\n\t\t\tbreak;\n\t\tcase 's':\n\t\t\toptions->logopt = TO_SYSLOG;\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tusage(basename(argv[0]));\n\t\t\tbreak;\n\t\tdefault:  \n\t\t\treturn -1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nenum {\n\tTHERMAL_ENGINE_SUCCESS = 0,\n\tTHERMAL_ENGINE_OPTION_ERROR,\n\tTHERMAL_ENGINE_DAEMON_ERROR,\n\tTHERMAL_ENGINE_LOG_ERROR,\n\tTHERMAL_ENGINE_THERMAL_ERROR,\n\tTHERMAL_ENGINE_MAINLOOP_ERROR,\n};\n\nint main(int argc, char *argv[])\n{\n\tstruct thermal_data td;\n\tstruct options options = {\n\t\t.loglevel = LOG_INFO,\n\t\t.logopt = TO_STDOUT,\n\t};\n\n\tif (options_init(argc, argv, &options)) {\n\t\tERROR(\"Usage: %s --help\\n\", argv[0]);\n\t\treturn THERMAL_ENGINE_OPTION_ERROR;\n\t}\n\n\tif (options.daemonize && daemon(0, 0)) {\n\t\tERROR(\"Failed to daemonize: %p\\n\");\n\t\treturn THERMAL_ENGINE_DAEMON_ERROR;\n\t}\n\n\tif (log_init(options.loglevel, basename(argv[0]), options.logopt)) {\n\t\tERROR(\"Failed to initialize logging facility\\n\");\n\t\treturn THERMAL_ENGINE_LOG_ERROR;\n\t}\n\n\ttd.th = thermal_init(&ops);\n\tif (!td.th) {\n\t\tERROR(\"Failed to initialize the thermal library\\n\");\n\t\treturn THERMAL_ENGINE_THERMAL_ERROR;\n\t}\n\n\ttd.tz = thermal_zone_discover(td.th);\n\tif (!td.tz) {\n\t\tERROR(\"No thermal zone available\\n\");\n\t\treturn THERMAL_ENGINE_THERMAL_ERROR;\n\t}\n\n\tfor_each_thermal_zone(td.tz, show_tz, td.th);\n\n\tif (mainloop_init()) {\n\t\tERROR(\"Failed to initialize the mainloop\\n\");\n\t\treturn THERMAL_ENGINE_MAINLOOP_ERROR;\n\t}\n\n\tif (mainloop_add(thermal_events_fd(td.th), thermal_event, &td)) {\n\t\tERROR(\"Failed to setup the mainloop\\n\");\n\t\treturn THERMAL_ENGINE_MAINLOOP_ERROR;\n\t}\n\n\tINFO(\"Waiting for thermal events ...\\n\");\n\n\tif (mainloop(-1)) {\n\t\tERROR(\"Mainloop failed\\n\");\n\t\treturn THERMAL_ENGINE_MAINLOOP_ERROR;\n\t}\n\n\treturn THERMAL_ENGINE_SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}