{
  "module_name": "mainloop.c",
  "hash_id": "66d4e3d8fabebbb097c0766a9f44f5a37cff841ab840504a7ea0795745bd090c",
  "original_prompt": "Ingested from linux-6.6.14/tools/thermal/lib/mainloop.c",
  "human_readable_source": "\n\n#include <stdlib.h>\n#include <errno.h>\n#include <unistd.h>\n#include <signal.h>\n#include <sys/epoll.h>\n#include \"mainloop.h\"\n#include \"log.h\"\n\nstatic int epfd = -1;\nstatic unsigned short nrhandler;\nstatic sig_atomic_t exit_mainloop;\n\nstruct mainloop_data {\n\tmainloop_callback_t cb;\n\tvoid *data;\n\tint fd;\n};\n\nstatic struct mainloop_data **mds;\n\n#define MAX_EVENTS 10\n\nint mainloop(unsigned int timeout)\n{\n\tint i, nfds;\n\tstruct epoll_event events[MAX_EVENTS];\n\tstruct mainloop_data *md;\n\n\tif (epfd < 0)\n\t\treturn -1;\n\n\tfor (;;) {\n\n\t\tnfds = epoll_wait(epfd, events, MAX_EVENTS, timeout);\n\n\t\tif (exit_mainloop || !nfds)\n\t\t\treturn 0;\n\n\t\tif (nfds < 0) {\n\t\t\tif (errno == EINTR)\n\t\t\t\tcontinue;\n\t\t\treturn -1;\n\t\t}\n\n\t\tfor (i = 0; i < nfds; i++) {\n\t\t\tmd = events[i].data.ptr;\n\n\t\t\tif (md->cb(md->fd, md->data) > 0)\n\t\t\t\treturn 0;\n\t\t}\n\t}\n}\n\nint mainloop_add(int fd, mainloop_callback_t cb, void *data)\n{\n\tstruct epoll_event ev = {\n\t\t.events = EPOLLIN,\n\t};\n\n\tstruct mainloop_data *md;\n\n\tif (fd >= nrhandler) {\n\t\tmds = realloc(mds, sizeof(*mds) * (fd + 1));\n\t\tif (!mds)\n\t\t\treturn -1;\n\t\tnrhandler = fd + 1;\n\t}\n\n\tmd = malloc(sizeof(*md));\n\tif (!md)\n\t\treturn -1;\n\n\tmd->data = data;\n\tmd->cb = cb;\n\tmd->fd = fd;\n\n\tmds[fd] = md;\n\tev.data.ptr = md;\n\n\tif (epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &ev) < 0) {\n\t\tfree(md);\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nint mainloop_del(int fd)\n{\n\tif (fd >= nrhandler)\n\t\treturn -1;\n\n\tif (epoll_ctl(epfd, EPOLL_CTL_DEL, fd, NULL) < 0)\n\t\treturn -1;\n\n\tfree(mds[fd]);\n\n\treturn 0;\n}\n\nint mainloop_init(void)\n{\n\tepfd = epoll_create(2);\n\tif (epfd < 0)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nvoid mainloop_exit(void)\n{\n\texit_mainloop = 1;\n}\n\nvoid mainloop_fini(void)\n{\n\tclose(epfd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}