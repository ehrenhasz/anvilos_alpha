{
  "module_name": "pager.c",
  "hash_id": "55fb6d9ebf61b4bc4e5a2578c408e9cfb39aba908f0aee7b86a75a168b04da41",
  "original_prompt": "Ingested from linux-6.6.14/tools/lib/subcmd/pager.c",
  "human_readable_source": "\n#include <sys/select.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n#include <sys/ioctl.h>\n#include \"pager.h\"\n#include \"run-command.h\"\n#include \"sigchain.h\"\n#include \"subcmd-config.h\"\n\n \n\nstatic int spawned_pager;\nstatic int pager_columns;\n\nvoid pager_init(const char *pager_env)\n{\n\tsubcmd_config.pager_env = pager_env;\n}\n\nstatic const char *forced_pager;\n\nvoid force_pager(const char *pager)\n{\n\tforced_pager = pager;\n}\n\nstatic void pager_preexec(void)\n{\n\t \n\tfd_set in;\n\tfd_set exception;\n\n\tFD_ZERO(&in);\n\tFD_ZERO(&exception);\n\tFD_SET(0, &in);\n\tFD_SET(0, &exception);\n\tselect(1, &in, NULL, &exception, NULL);\n\n\tsetenv(\"LESS\", \"FRSX\", 0);\n}\n\nstatic const char *pager_argv[] = { \"sh\", \"-c\", NULL, NULL };\nstatic struct child_process pager_process;\n\nstatic void wait_for_pager(void)\n{\n\tfflush(stdout);\n\tfflush(stderr);\n\t \n\tclose(1);\n\tclose(2);\n\tfinish_command(&pager_process);\n}\n\nstatic void wait_for_pager_signal(int signo)\n{\n\twait_for_pager();\n\tsigchain_pop(signo);\n\traise(signo);\n}\n\nvoid setup_pager(void)\n{\n\tconst char *pager = getenv(subcmd_config.pager_env);\n\tstruct winsize sz;\n\n\tif (forced_pager)\n\t\tpager = forced_pager;\n\tif (!isatty(1) && !forced_pager)\n\t\treturn;\n\tif (ioctl(1, TIOCGWINSZ, &sz) == 0)\n\t\tpager_columns = sz.ws_col;\n\tif (!pager)\n\t\tpager = getenv(\"PAGER\");\n\tif (!(pager || access(\"/usr/bin/pager\", X_OK)))\n\t\tpager = \"/usr/bin/pager\";\n\tif (!(pager || access(\"/usr/bin/less\", X_OK)))\n\t\tpager = \"/usr/bin/less\";\n\tif (!pager)\n\t\tpager = \"cat\";\n\tif (!*pager || !strcmp(pager, \"cat\"))\n\t\treturn;\n\n\tspawned_pager = 1;  \n\n\t \n\tpager_argv[2] = pager;\n\tpager_process.argv = pager_argv;\n\tpager_process.in = -1;\n\tpager_process.preexec_cb = pager_preexec;\n\n\tif (start_command(&pager_process))\n\t\treturn;\n\n\t \n\tdup2(pager_process.in, 1);\n\tif (isatty(2))\n\t\tdup2(pager_process.in, 2);\n\tclose(pager_process.in);\n\n\t \n\tsigchain_push_common(wait_for_pager_signal);\n\tatexit(wait_for_pager);\n}\n\nint pager_in_use(void)\n{\n\treturn spawned_pager;\n}\n\nint pager_get_columns(void)\n{\n\tchar *s;\n\n\ts = getenv(\"COLUMNS\");\n\tif (s)\n\t\treturn atoi(s);\n\n\treturn (pager_columns ? pager_columns : 80) - 2;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}