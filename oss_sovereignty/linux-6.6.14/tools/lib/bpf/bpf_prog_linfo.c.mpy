{
  "module_name": "bpf_prog_linfo.c",
  "hash_id": "bde547cec0bc41e37df6e2f69951d94a20f6d7ab0ba658145ed49a8c1773de7f",
  "original_prompt": "Ingested from linux-6.6.14/tools/lib/bpf/bpf_prog_linfo.c",
  "human_readable_source": "\n \n\n#include <string.h>\n#include <stdlib.h>\n#include <linux/err.h>\n#include <linux/bpf.h>\n#include \"libbpf.h\"\n#include \"libbpf_internal.h\"\n\nstruct bpf_prog_linfo {\n\tvoid *raw_linfo;\n\tvoid *raw_jited_linfo;\n\t__u32 *nr_jited_linfo_per_func;\n\t__u32 *jited_linfo_func_idx;\n\t__u32 nr_linfo;\n\t__u32 nr_jited_func;\n\t__u32 rec_size;\n\t__u32 jited_rec_size;\n};\n\nstatic int dissect_jited_func(struct bpf_prog_linfo *prog_linfo,\n\t\t\t      const __u64 *ksym_func, const __u32 *ksym_len)\n{\n\t__u32 nr_jited_func, nr_linfo;\n\tconst void *raw_jited_linfo;\n\tconst __u64 *jited_linfo;\n\t__u64 last_jited_linfo;\n\t \n\t__u32 i, prev_i;\n\t__u32 f;  \n\n\traw_jited_linfo = prog_linfo->raw_jited_linfo;\n\tjited_linfo = raw_jited_linfo;\n\tif (ksym_func[0] != *jited_linfo)\n\t\tgoto errout;\n\n\tprog_linfo->jited_linfo_func_idx[0] = 0;\n\tnr_jited_func = prog_linfo->nr_jited_func;\n\tnr_linfo = prog_linfo->nr_linfo;\n\n\tfor (prev_i = 0, i = 1, f = 1;\n\t     i < nr_linfo && f < nr_jited_func;\n\t     i++) {\n\t\traw_jited_linfo += prog_linfo->jited_rec_size;\n\t\tlast_jited_linfo = *jited_linfo;\n\t\tjited_linfo = raw_jited_linfo;\n\n\t\tif (ksym_func[f] == *jited_linfo) {\n\t\t\tprog_linfo->jited_linfo_func_idx[f] = i;\n\n\t\t\t \n\t\t\tif (last_jited_linfo - ksym_func[f - 1] + 1 >\n\t\t\t    ksym_len[f - 1])\n\t\t\t\tgoto errout;\n\n\t\t\tprog_linfo->nr_jited_linfo_per_func[f - 1] =\n\t\t\t\ti - prev_i;\n\t\t\tprev_i = i;\n\n\t\t\t \n\t\t\tf++;\n\t\t} else if (*jited_linfo <= last_jited_linfo) {\n\t\t\t \n\t\t\tgoto errout;\n\t\t}\n\t}\n\n\tif (f != nr_jited_func)\n\t\tgoto errout;\n\n\tprog_linfo->nr_jited_linfo_per_func[nr_jited_func - 1] =\n\t\tnr_linfo - prev_i;\n\n\treturn 0;\n\nerrout:\n\treturn -EINVAL;\n}\n\nvoid bpf_prog_linfo__free(struct bpf_prog_linfo *prog_linfo)\n{\n\tif (!prog_linfo)\n\t\treturn;\n\n\tfree(prog_linfo->raw_linfo);\n\tfree(prog_linfo->raw_jited_linfo);\n\tfree(prog_linfo->nr_jited_linfo_per_func);\n\tfree(prog_linfo->jited_linfo_func_idx);\n\tfree(prog_linfo);\n}\n\nstruct bpf_prog_linfo *bpf_prog_linfo__new(const struct bpf_prog_info *info)\n{\n\tstruct bpf_prog_linfo *prog_linfo;\n\t__u32 nr_linfo, nr_jited_func;\n\t__u64 data_sz;\n\n\tnr_linfo = info->nr_line_info;\n\n\tif (!nr_linfo)\n\t\treturn errno = EINVAL, NULL;\n\n\t \n\tif (info->line_info_rec_size <\n\t    offsetof(struct bpf_line_info, file_name_off))\n\t\treturn errno = EINVAL, NULL;\n\n\tprog_linfo = calloc(1, sizeof(*prog_linfo));\n\tif (!prog_linfo)\n\t\treturn errno = ENOMEM, NULL;\n\n\t \n\tprog_linfo->nr_linfo = nr_linfo;\n\tprog_linfo->rec_size = info->line_info_rec_size;\n\tdata_sz = (__u64)nr_linfo * prog_linfo->rec_size;\n\tprog_linfo->raw_linfo = malloc(data_sz);\n\tif (!prog_linfo->raw_linfo)\n\t\tgoto err_free;\n\tmemcpy(prog_linfo->raw_linfo, (void *)(long)info->line_info, data_sz);\n\n\tnr_jited_func = info->nr_jited_ksyms;\n\tif (!nr_jited_func ||\n\t    !info->jited_line_info ||\n\t    info->nr_jited_line_info != nr_linfo ||\n\t    info->jited_line_info_rec_size < sizeof(__u64) ||\n\t    info->nr_jited_func_lens != nr_jited_func ||\n\t    !info->jited_ksyms ||\n\t    !info->jited_func_lens)\n\t\t \n\t\treturn prog_linfo;\n\n\t \n\tprog_linfo->nr_jited_func = nr_jited_func;\n\tprog_linfo->jited_rec_size = info->jited_line_info_rec_size;\n\tdata_sz = (__u64)nr_linfo * prog_linfo->jited_rec_size;\n\tprog_linfo->raw_jited_linfo = malloc(data_sz);\n\tif (!prog_linfo->raw_jited_linfo)\n\t\tgoto err_free;\n\tmemcpy(prog_linfo->raw_jited_linfo,\n\t       (void *)(long)info->jited_line_info, data_sz);\n\n\t \n\tprog_linfo->nr_jited_linfo_per_func = malloc(nr_jited_func *\n\t\t\t\t\t\t     sizeof(__u32));\n\tif (!prog_linfo->nr_jited_linfo_per_func)\n\t\tgoto err_free;\n\n\t \n\tprog_linfo->jited_linfo_func_idx = malloc(nr_jited_func *\n\t\t\t\t\t\t  sizeof(__u32));\n\tif (!prog_linfo->jited_linfo_func_idx)\n\t\tgoto err_free;\n\n\tif (dissect_jited_func(prog_linfo,\n\t\t\t       (__u64 *)(long)info->jited_ksyms,\n\t\t\t       (__u32 *)(long)info->jited_func_lens))\n\t\tgoto err_free;\n\n\treturn prog_linfo;\n\nerr_free:\n\tbpf_prog_linfo__free(prog_linfo);\n\treturn errno = EINVAL, NULL;\n}\n\nconst struct bpf_line_info *\nbpf_prog_linfo__lfind_addr_func(const struct bpf_prog_linfo *prog_linfo,\n\t\t\t\t__u64 addr, __u32 func_idx, __u32 nr_skip)\n{\n\t__u32 jited_rec_size, rec_size, nr_linfo, start, i;\n\tconst void *raw_jited_linfo, *raw_linfo;\n\tconst __u64 *jited_linfo;\n\n\tif (func_idx >= prog_linfo->nr_jited_func)\n\t\treturn errno = ENOENT, NULL;\n\n\tnr_linfo = prog_linfo->nr_jited_linfo_per_func[func_idx];\n\tif (nr_skip >= nr_linfo)\n\t\treturn errno = ENOENT, NULL;\n\n\tstart = prog_linfo->jited_linfo_func_idx[func_idx] + nr_skip;\n\tjited_rec_size = prog_linfo->jited_rec_size;\n\traw_jited_linfo = prog_linfo->raw_jited_linfo +\n\t\t(start * jited_rec_size);\n\tjited_linfo = raw_jited_linfo;\n\tif (addr < *jited_linfo)\n\t\treturn errno = ENOENT, NULL;\n\n\tnr_linfo -= nr_skip;\n\trec_size = prog_linfo->rec_size;\n\traw_linfo = prog_linfo->raw_linfo + (start * rec_size);\n\tfor (i = 0; i < nr_linfo; i++) {\n\t\tif (addr < *jited_linfo)\n\t\t\tbreak;\n\n\t\traw_linfo += rec_size;\n\t\traw_jited_linfo += jited_rec_size;\n\t\tjited_linfo = raw_jited_linfo;\n\t}\n\n\treturn raw_linfo - rec_size;\n}\n\nconst struct bpf_line_info *\nbpf_prog_linfo__lfind(const struct bpf_prog_linfo *prog_linfo,\n\t\t      __u32 insn_off, __u32 nr_skip)\n{\n\tconst struct bpf_line_info *linfo;\n\t__u32 rec_size, nr_linfo, i;\n\tconst void *raw_linfo;\n\n\tnr_linfo = prog_linfo->nr_linfo;\n\tif (nr_skip >= nr_linfo)\n\t\treturn errno = ENOENT, NULL;\n\n\trec_size = prog_linfo->rec_size;\n\traw_linfo = prog_linfo->raw_linfo + (nr_skip * rec_size);\n\tlinfo = raw_linfo;\n\tif (insn_off < linfo->insn_off)\n\t\treturn errno = ENOENT, NULL;\n\n\tnr_linfo -= nr_skip;\n\tfor (i = 0; i < nr_linfo; i++) {\n\t\tif (insn_off < linfo->insn_off)\n\t\t\tbreak;\n\n\t\traw_linfo += rec_size;\n\t\tlinfo = raw_linfo;\n\t}\n\n\treturn raw_linfo - rec_size;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}