{
  "module_name": "events.c",
  "hash_id": "0318a74c9903a8c8c8b28a5b0e70c99a16683334caf5c5e7481354e8787fc4d5",
  "original_prompt": "Ingested from linux-6.6.14/tools/lib/thermal/events.c",
  "human_readable_source": "\n\n#include <linux/netlink.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\n\n#include <thermal.h>\n#include \"thermal_nl.h\"\n\n \nstatic int enabled_ops[__THERMAL_GENL_EVENT_MAX];\n\nstatic int handle_thermal_event(struct nl_msg *n, void *arg)\n{\n\tstruct nlmsghdr *nlh = nlmsg_hdr(n);\n\tstruct genlmsghdr *genlhdr = genlmsg_hdr(nlh);\n\tstruct nlattr *attrs[THERMAL_GENL_ATTR_MAX + 1];\n\tstruct thermal_handler_param *thp = arg;\n\tstruct thermal_events_ops *ops = &thp->th->ops->events;\n\n\tgenlmsg_parse(nlh, 0, attrs, THERMAL_GENL_ATTR_MAX, NULL);\n\n\targ = thp->arg;\n\n\t \n\tif (!enabled_ops[genlhdr->cmd])\n\t\treturn THERMAL_SUCCESS;\n\n\tswitch (genlhdr->cmd) {\n\n\tcase THERMAL_GENL_EVENT_TZ_CREATE:\n\t\treturn ops->tz_create(nla_get_string(attrs[THERMAL_GENL_ATTR_TZ_NAME]),\n\t\t\t\t      nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_DELETE:\n\t\treturn ops->tz_delete(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_ENABLE:\n\t\treturn ops->tz_enable(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_DISABLE:\n\t\treturn ops->tz_disable(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_TRIP_CHANGE:\n\t\treturn ops->trip_change(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]),\n\t\t\t\t\tnla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_ID]),\n\t\t\t\t\tnla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_TYPE]),\n\t\t\t\t\tnla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_TEMP]),\n\t\t\t\t\tnla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_HYST]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_TRIP_ADD:\n\t\treturn ops->trip_add(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_ID]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_TYPE]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_TEMP]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_HYST]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_TRIP_DELETE:\n\t\treturn ops->trip_delete(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]),\n\t\t\t\t\tnla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_ID]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_TRIP_UP:\n\t\treturn ops->trip_high(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]),\n\t\t\t\t      nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_ID]),\n\t\t\t\t      nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TEMP]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_TRIP_DOWN:\n\t\treturn ops->trip_low(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TRIP_ID]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_TEMP]), arg);\n\n\tcase THERMAL_GENL_EVENT_CDEV_ADD:\n\t\treturn ops->cdev_add(nla_get_string(attrs[THERMAL_GENL_ATTR_CDEV_NAME]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_CDEV_ID]),\n\t\t\t\t     nla_get_u32(attrs[THERMAL_GENL_ATTR_CDEV_MAX_STATE]), arg);\n\n\tcase THERMAL_GENL_EVENT_CDEV_DELETE:\n\t\treturn ops->cdev_delete(nla_get_u32(attrs[THERMAL_GENL_ATTR_CDEV_ID]), arg);\n\n\tcase THERMAL_GENL_EVENT_CDEV_STATE_UPDATE:\n\t\treturn ops->cdev_update(nla_get_u32(attrs[THERMAL_GENL_ATTR_CDEV_ID]),\n\t\t\t\t\tnla_get_u32(attrs[THERMAL_GENL_ATTR_CDEV_CUR_STATE]), arg);\n\n\tcase THERMAL_GENL_EVENT_TZ_GOV_CHANGE:\n\t\treturn ops->gov_change(nla_get_u32(attrs[THERMAL_GENL_ATTR_TZ_ID]),\n\t\t\t\t       nla_get_string(attrs[THERMAL_GENL_ATTR_GOV_NAME]), arg);\n\tdefault:\n\t\treturn -1;\n\t}\n}\n\nstatic void thermal_events_ops_init(struct thermal_events_ops *ops)\n{\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_CREATE]\t= !!ops->tz_create;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_DELETE]\t= !!ops->tz_delete;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_DISABLE]\t= !!ops->tz_disable;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_ENABLE]\t= !!ops->tz_enable;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_TRIP_UP]\t= !!ops->trip_high;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_TRIP_DOWN]\t= !!ops->trip_low;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_TRIP_CHANGE]\t= !!ops->trip_change;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_TRIP_ADD]\t= !!ops->trip_add;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_TRIP_DELETE]\t= !!ops->trip_delete;\n\tenabled_ops[THERMAL_GENL_EVENT_CDEV_ADD]\t= !!ops->cdev_add;\n\tenabled_ops[THERMAL_GENL_EVENT_CDEV_DELETE]\t= !!ops->cdev_delete;\n\tenabled_ops[THERMAL_GENL_EVENT_CDEV_STATE_UPDATE] = !!ops->cdev_update;\n\tenabled_ops[THERMAL_GENL_EVENT_TZ_GOV_CHANGE]\t= !!ops->gov_change;\n}\n\nthermal_error_t thermal_events_handle(struct thermal_handler *th, void *arg)\n{\n\tstruct thermal_handler_param thp = { .th = th, .arg = arg };\n\n\tif (!th)\n\t\treturn THERMAL_ERROR;\n\n\tif (nl_cb_set(th->cb_event, NL_CB_VALID, NL_CB_CUSTOM,\n\t\t      handle_thermal_event, &thp))\n\t\treturn THERMAL_ERROR;\n\n\treturn nl_recvmsgs(th->sk_event, th->cb_event);\n}\n\nint thermal_events_fd(struct thermal_handler *th)\n{\n\tif (!th)\n\t\treturn -1;\n\n\treturn nl_socket_get_fd(th->sk_event);\n}\n\nthermal_error_t thermal_events_exit(struct thermal_handler *th)\n{\n\tif (nl_unsubscribe_thermal(th->sk_event, th->cb_event,\n\t\t\t\t   THERMAL_GENL_EVENT_GROUP_NAME))\n\t\treturn THERMAL_ERROR;\n\n\tnl_thermal_disconnect(th->sk_event, th->cb_event);\n\n\treturn THERMAL_SUCCESS;\n}\n\nthermal_error_t thermal_events_init(struct thermal_handler *th)\n{\n\tthermal_events_ops_init(&th->ops->events);\n\n\tif (nl_thermal_connect(&th->sk_event, &th->cb_event))\n\t\treturn THERMAL_ERROR;\n\n\tif (nl_subscribe_thermal(th->sk_event, th->cb_event,\n\t\t\t\t THERMAL_GENL_EVENT_GROUP_NAME))\n\t\treturn THERMAL_ERROR;\n\n\treturn THERMAL_SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}