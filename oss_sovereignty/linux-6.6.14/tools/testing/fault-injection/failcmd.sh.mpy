{
  "module_name": "failcmd.sh",
  "hash_id": "09ce52e1fb0d2de09c91d70feaa652f3b97ea263734a7304358fa6a7b5476b25",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/fault-injection/failcmd.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# NAME\n#\tfailcmd.sh - run a command with injecting slab/page allocation failures\n#\n# SYNOPSIS\n#\tfailcmd.sh --help\n#\tfailcmd.sh [<options>] command [arguments]\n#\n# DESCRIPTION\n#\tRun command with injecting slab/page allocation failures by fault\n#\tinjection.\n#\n#\tNOTE: you need to run this script as root.\n#\n\nusage()\n{\n\tcat >&2 <<EOF\nUsage: $0 [options] command [arguments]\n\nOPTIONS\n\t-p percent\n\t--probability=percent\n\t\tlikelihood of failure injection, in percent.\n\t\tDefault value is 1\n\n\t-t value\n\t--times=value\n\t\tspecifies how many times failures may happen at most.\n\t\tDefault value is 1\n\n\t--oom-kill-allocating-task=value\n\t\tset /proc/sys/vm/oom_kill_allocating_task to specified value\n\t\tbefore running the command.\n\t\tDefault value is 1\n\n\t-h, --help\n\t\tDisplay a usage message and exit\n\n\t--interval=value, --space=value, --verbose=value, --task-filter=value,\n\t--stacktrace-depth=value, --require-start=value, --require-end=value,\n\t--reject-start=value, --reject-end=value, --ignore-gfp-wait=value\n\t\tSee Documentation/fault-injection/fault-injection.rst for more\n\t\tinformation\n\n\tfailslab options:\n\t--cache-filter=value\n\n\tfail_page_alloc options:\n\t--ignore-gfp-highmem=value, --min-order=value\n\nENVIRONMENT\n\tFAILCMD_TYPE\n\t\tThe following values for FAILCMD_TYPE are recognized:\n\n\t\tfailslab\n\t\t\tinject slab allocation failures\n\t\tfail_page_alloc\n\t\t\tinject page allocation failures\n\n\t\tIf FAILCMD_TYPE is not defined, then failslab is used.\nEOF\n}\n\nif [ $UID != 0 ]; then\n\techo must be run as root >&2\n\texit 1\nfi\n\nDEBUGFS=`mount -t debugfs | head -1 | awk '{ print $3}'`\n\nif [ ! -d \"$DEBUGFS\" ]; then\n\techo debugfs is not mounted >&2\n\texit 1\nfi\n\nFAILCMD_TYPE=${FAILCMD_TYPE:-failslab}\nFAULTATTR=$DEBUGFS/$FAILCMD_TYPE\n\nif [ ! -d $FAULTATTR ]; then\n\techo $FAILCMD_TYPE is not available >&2\n\texit 1\nfi\n\nLONGOPTS=probability:,interval:,times:,space:,verbose:,task-filter:\nLONGOPTS=$LONGOPTS,stacktrace-depth:,require-start:,require-end:\nLONGOPTS=$LONGOPTS,reject-start:,reject-end:,oom-kill-allocating-task:,help\n\nif [ $FAILCMD_TYPE = failslab ]; then\n\tLONGOPTS=$LONGOPTS,ignore-gfp-wait:,cache-filter:\nelif [ $FAILCMD_TYPE = fail_page_alloc ]; then\n\tLONGOPTS=$LONGOPTS,ignore-gfp-wait:,ignore-gfp-highmem:,min-order:\nfi\n\nTEMP=`getopt -o p:i:t:s:v:h --long $LONGOPTS -n 'failcmd.sh' -- \"$@\"`\n\nif [ $? != 0 ]; then\n\tusage\n\texit 1\nfi\n\neval set -- \"$TEMP\"\n\nfault_attr_default()\n{\n\techo N > $FAULTATTR/task-filter\n\techo 0 > $FAULTATTR/probability\n\techo 1 > $FAULTATTR/times\n}\n\nfault_attr_default\n\noom_kill_allocating_task_saved=`cat /proc/sys/vm/oom_kill_allocating_task`\n\nrestore_values()\n{\n\tfault_attr_default\n\techo $oom_kill_allocating_task_saved \\\n\t\t> /proc/sys/vm/oom_kill_allocating_task\n}\n\n#\n# Default options\n#\ndeclare -i oom_kill_allocating_task=1\ndeclare task_filter=Y\ndeclare -i probability=1\ndeclare -i times=1\n\nwhile true; do\n\tcase \"$1\" in\n\t-p|--probability)\n\t\tprobability=$2\n\t\tshift 2\n\t\t;;\n\t-i|--interval)\n\t\techo $2 > $FAULTATTR/interval\n\t\tshift 2\n\t\t;;\n\t-t|--times)\n\t\ttimes=$2\n\t\tshift 2\n\t\t;;\n\t-s|--space)\n\t\techo $2 > $FAULTATTR/space\n\t\tshift 2\n\t\t;;\n\t-v|--verbose)\n\t\techo $2 > $FAULTATTR/verbose\n\t\tshift 2\n\t\t;;\n\t--task-filter)\n\t\ttask_filter=$2\n\t\tshift 2\n\t\t;;\n\t--stacktrace-depth)\n\t\techo $2 > $FAULTATTR/stacktrace-depth\n\t\tshift 2\n\t\t;;\n\t--require-start)\n\t\techo $2 > $FAULTATTR/require-start\n\t\tshift 2\n\t\t;;\n\t--require-end)\n\t\techo $2 > $FAULTATTR/require-end\n\t\tshift 2\n\t\t;;\n\t--reject-start)\n\t\techo $2 > $FAULTATTR/reject-start\n\t\tshift 2\n\t\t;;\n\t--reject-end)\n\t\techo $2 > $FAULTATTR/reject-end\n\t\tshift 2\n\t\t;;\n\t--oom-kill-allocating-task)\n\t\toom_kill_allocating_task=$2\n\t\tshift 2\n\t\t;;\n\t--ignore-gfp-wait)\n\t\techo $2 > $FAULTATTR/ignore-gfp-wait\n\t\tshift 2\n\t\t;;\n\t--cache-filter)\n\t\techo $2 > $FAULTATTR/cache_filter\n\t\tshift 2\n\t\t;;\n\t--ignore-gfp-highmem)\n\t\techo $2 > $FAULTATTR/ignore-gfp-highmem\n\t\tshift 2\n\t\t;;\n\t--min-order)\n\t\techo $2 > $FAULTATTR/min-order\n\t\tshift 2\n\t\t;;\n\t-h|--help)\n\t\tusage\n\t\texit 0\n\t\tshift\n\t\t;;\n\t--)\n\t\tshift\n\t\tbreak\n\t\t;;\n\tesac\ndone\n\n[ -z \"$1\" ] && exit 0\n\necho $oom_kill_allocating_task > /proc/sys/vm/oom_kill_allocating_task\necho $task_filter > $FAULTATTR/task-filter\necho $probability > $FAULTATTR/probability\necho $times > $FAULTATTR/times\n\ntrap \"restore_values\" SIGINT SIGTERM EXIT\n\ncmd=\"echo 1 > /proc/self/make-it-fail && exec $@\"\nbash -c \"$cmd\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}