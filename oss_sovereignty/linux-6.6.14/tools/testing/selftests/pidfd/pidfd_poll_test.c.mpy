{
  "module_name": "pidfd_poll_test.c",
  "hash_id": "af6ca410b5d9eac3cdf4721ff15439f8dfa94fcd898cca1d06233a0a29d7231e",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/pidfd/pidfd_poll_test.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <linux/types.h>\n#include <poll.h>\n#include <signal.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <syscall.h>\n#include <sys/wait.h>\n#include <unistd.h>\n\n#include \"pidfd.h\"\n#include \"../kselftest.h\"\n\nstatic bool timeout;\n\nstatic void handle_alarm(int sig)\n{\n\ttimeout = true;\n}\n\nint main(int argc, char **argv)\n{\n\tstruct pollfd fds;\n\tint iter, nevents;\n\tint nr_iterations = 10000;\n\n\tfds.events = POLLIN;\n\n\tif (argc > 2)\n\t\tksft_exit_fail_msg(\"Unexpected command line argument\\n\");\n\n\tif (argc == 2) {\n\t\tnr_iterations = atoi(argv[1]);\n\t\tif (nr_iterations <= 0)\n\t\t\tksft_exit_fail_msg(\"invalid input parameter %s\\n\",\n\t\t\t\t\targv[1]);\n\t}\n\n\tksft_print_msg(\"running pidfd poll test for %d iterations\\n\",\n\t\tnr_iterations);\n\n\tfor (iter = 0; iter < nr_iterations; iter++) {\n\t\tint pidfd;\n\t\tint child_pid = fork();\n\n\t\tif (child_pid < 0) {\n\t\t\tif (errno == EAGAIN) {\n\t\t\t\titer--;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tksft_exit_fail_msg(\n\t\t\t\t\"%s - failed to fork a child process\\n\",\n\t\t\t\tstrerror(errno));\n\t\t}\n\n\t\tif (child_pid == 0) {\n\t\t\t \n\t\t\tsleep(60);\n\t\t\texit(EXIT_SUCCESS);\n\t\t}\n\n\t\t \n\t\tpidfd = sys_pidfd_open(child_pid, 0);\n\t\tif (pidfd < 0)\n\t\t\tksft_exit_fail_msg(\"%s - pidfd_open failed\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\t\t \n\t\tif (signal(SIGALRM, handle_alarm) == SIG_ERR)\n\t\t\tksft_exit_fail_msg(\"%s - signal failed\\n\",\n\t\t\t\t\tstrerror(errno));\n\t\talarm(3);\n\n\t\t \n\t\tif (sys_pidfd_send_signal(pidfd, SIGKILL, NULL, 0))\n\t\t\tksft_exit_fail_msg(\"%s - pidfd_send_signal failed\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\t\t \n\t\tfds.fd = pidfd;\n\t\tnevents = poll(&fds, 1, -1);\n\n\t\t \n\t\tif (nevents < 0)\n\t\t\tksft_exit_fail_msg(\"%s - poll failed\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\t\tif (nevents != 1)\n\t\t\tksft_exit_fail_msg(\"unexpected poll result: %d\\n\",\n\t\t\t\t\tnevents);\n\n\t\tif (!(fds.revents & POLLIN))\n\t\t\tksft_exit_fail_msg(\n\t\t\t\t\"unexpected event type received: 0x%x\\n\",\n\t\t\t\tfds.revents);\n\n\t\tif (timeout)\n\t\t\tksft_exit_fail_msg(\n\t\t\t\t\"death notification wait timeout\\n\");\n\n\t\tclose(pidfd);\n\t\t \n\t\tif (waitpid(child_pid, NULL, 0) < 0)\n\t\t\tksft_exit_fail_msg(\"%s - waitpid failed\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\t}\n\n\tksft_test_result_pass(\"pidfd poll test: pass\\n\");\n\treturn ksft_exit_pass();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}