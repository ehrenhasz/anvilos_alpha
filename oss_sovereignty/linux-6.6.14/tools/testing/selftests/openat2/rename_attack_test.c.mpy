{
  "module_name": "rename_attack_test.c",
  "hash_id": "92212a88283e9d2a712108dd45bebcc1ac0e946d333d6f38361361e85781d3ce",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/openat2/rename_attack_test.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <sched.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <sys/mman.h>\n#include <sys/prctl.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdbool.h>\n#include <string.h>\n#include <syscall.h>\n#include <limits.h>\n#include <unistd.h>\n\n#include \"../kselftest.h\"\n#include \"helpers.h\"\n\n \nint setup_testdir(void)\n{\n\tint dfd;\n\tchar dirname[] = \"/tmp/ksft-openat2-rename-attack.XXXXXX\";\n\n\t \n\tif (!mkdtemp(dirname))\n\t\tksft_exit_fail_msg(\"setup_testdir: failed to create tmpdir\\n\");\n\tdfd = open(dirname, O_PATH | O_DIRECTORY);\n\tif (dfd < 0)\n\t\tksft_exit_fail_msg(\"setup_testdir: failed to open tmpdir\\n\");\n\n\tE_mkdirat(dfd, \"a\", 0755);\n\tE_mkdirat(dfd, \"b\", 0755);\n\tE_mkdirat(dfd, \"a/c\", 0755);\n\n\treturn dfd;\n}\n\n \npid_t spawn_attack(int dirfd, char *a, char *b)\n{\n\tpid_t child = fork();\n\tif (child != 0)\n\t\treturn child;\n\n\t \n\tE_prctl(PR_SET_PDEATHSIG, SIGKILL);\n\n\t \n\tfor (;;)\n\t\trenameat2(dirfd, a, dirfd, b, RENAME_EXCHANGE);\n\texit(1);\n}\n\n#define NUM_RENAME_TESTS 2\n#define ROUNDS 400000\n\nconst char *flagname(int resolve)\n{\n\tswitch (resolve) {\n\tcase RESOLVE_IN_ROOT:\n\t\treturn \"RESOLVE_IN_ROOT\";\n\tcase RESOLVE_BENEATH:\n\t\treturn \"RESOLVE_BENEATH\";\n\t}\n\treturn \"(unknown)\";\n}\n\nvoid test_rename_attack(int resolve)\n{\n\tint dfd, afd;\n\tpid_t child;\n\tvoid (*resultfn)(const char *msg, ...) = ksft_test_result_pass;\n\tint escapes = 0, other_errs = 0, exdevs = 0, eagains = 0, successes = 0;\n\n\tstruct open_how how = {\n\t\t.flags = O_PATH,\n\t\t.resolve = resolve,\n\t};\n\n\tif (!openat2_supported) {\n\t\thow.resolve = 0;\n\t\tksft_print_msg(\"openat2(2) unsupported -- using openat(2) instead\\n\");\n\t}\n\n\tdfd = setup_testdir();\n\tafd = openat(dfd, \"a\", O_PATH);\n\tif (afd < 0)\n\t\tksft_exit_fail_msg(\"test_rename_attack: failed to open 'a'\\n\");\n\n\tchild = spawn_attack(dfd, \"a/c\", \"b\");\n\n\tfor (int i = 0; i < ROUNDS; i++) {\n\t\tint fd;\n\t\tchar *victim_path = \"c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../../c/../..\";\n\n\t\tif (openat2_supported)\n\t\t\tfd = sys_openat2(afd, victim_path, &how);\n\t\telse\n\t\t\tfd = sys_openat(afd, victim_path, &how);\n\n\t\tif (fd < 0) {\n\t\t\tif (fd == -EAGAIN)\n\t\t\t\teagains++;\n\t\t\telse if (fd == -EXDEV)\n\t\t\t\texdevs++;\n\t\t\telse if (fd == -ENOENT)\n\t\t\t\tescapes++;  \n\t\t\telse\n\t\t\t\tother_errs++;  \n\t\t} else {\n\t\t\tif (fdequal(fd, afd, NULL))\n\t\t\t\tsuccesses++;\n\t\t\telse\n\t\t\t\tescapes++;  \n\t\t}\n\t\tclose(fd);\n\t}\n\n\tif (escapes > 0)\n\t\tresultfn = ksft_test_result_fail;\n\tksft_print_msg(\"non-escapes: EAGAIN=%d EXDEV=%d E<other>=%d success=%d\\n\",\n\t\t       eagains, exdevs, other_errs, successes);\n\tresultfn(\"rename attack with %s (%d runs, got %d escapes)\\n\",\n\t\t flagname(resolve), ROUNDS, escapes);\n\n\t \n\tE_kill(child, SIGKILL);\n}\n\n#define NUM_TESTS NUM_RENAME_TESTS\n\nint main(int argc, char **argv)\n{\n\tksft_print_header();\n\tksft_set_plan(NUM_TESTS);\n\n\ttest_rename_attack(RESOLVE_BENEATH);\n\ttest_rename_attack(RESOLVE_IN_ROOT);\n\n\tif (ksft_get_fail_cnt() + ksft_get_error_cnt() > 0)\n\t\tksft_exit_fail();\n\telse\n\t\tksft_exit_pass();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}