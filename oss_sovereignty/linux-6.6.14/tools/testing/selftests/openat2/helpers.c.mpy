{
  "module_name": "helpers.c",
  "hash_id": "549d077ba7c4d50e43b9ee316fb8435459f5c3d9eb76410b9a46ed294d6bfc67",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/openat2/helpers.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <stdbool.h>\n#include <string.h>\n#include <syscall.h>\n#include <limits.h>\n\n#include \"helpers.h\"\n\nbool needs_openat2(const struct open_how *how)\n{\n\treturn how->resolve != 0;\n}\n\nint raw_openat2(int dfd, const char *path, void *how, size_t size)\n{\n\tint ret = syscall(__NR_openat2, dfd, path, how, size);\n\treturn ret >= 0 ? ret : -errno;\n}\n\nint sys_openat2(int dfd, const char *path, struct open_how *how)\n{\n\treturn raw_openat2(dfd, path, how, sizeof(*how));\n}\n\nint sys_openat(int dfd, const char *path, struct open_how *how)\n{\n\tint ret = openat(dfd, path, how->flags, how->mode);\n\treturn ret >= 0 ? ret : -errno;\n}\n\nint sys_renameat2(int olddirfd, const char *oldpath,\n\t\t  int newdirfd, const char *newpath, unsigned int flags)\n{\n\tint ret = syscall(__NR_renameat2, olddirfd, oldpath,\n\t\t\t\t\t  newdirfd, newpath, flags);\n\treturn ret >= 0 ? ret : -errno;\n}\n\nint touchat(int dfd, const char *path)\n{\n\tint fd = openat(dfd, path, O_CREAT, 0700);\n\tif (fd >= 0)\n\t\tclose(fd);\n\treturn fd;\n}\n\nchar *fdreadlink(int fd)\n{\n\tchar *target, *tmp;\n\n\tE_asprintf(&tmp, \"/proc/self/fd/%d\", fd);\n\n\ttarget = malloc(PATH_MAX);\n\tif (!target)\n\t\tksft_exit_fail_msg(\"fdreadlink: malloc failed\\n\");\n\tmemset(target, 0, PATH_MAX);\n\n\tE_readlink(tmp, target, PATH_MAX);\n\tfree(tmp);\n\treturn target;\n}\n\nbool fdequal(int fd, int dfd, const char *path)\n{\n\tchar *fdpath, *dfdpath, *other;\n\tbool cmp;\n\n\tfdpath = fdreadlink(fd);\n\tdfdpath = fdreadlink(dfd);\n\n\tif (!path)\n\t\tE_asprintf(&other, \"%s\", dfdpath);\n\telse if (*path == '/')\n\t\tE_asprintf(&other, \"%s\", path);\n\telse\n\t\tE_asprintf(&other, \"%s/%s\", dfdpath, path);\n\n\tcmp = !strcmp(fdpath, other);\n\n\tfree(fdpath);\n\tfree(dfdpath);\n\tfree(other);\n\treturn cmp;\n}\n\nbool openat2_supported = false;\n\nvoid __attribute__((constructor)) init(void)\n{\n\tstruct open_how how = {};\n\tint fd;\n\n\tBUILD_BUG_ON(sizeof(struct open_how) != OPEN_HOW_SIZE_VER0);\n\n\t \n\tfd = sys_openat2(AT_FDCWD, \".\", &how);\n\topenat2_supported = (fd >= 0);\n\n\tif (fd >= 0)\n\t\tclose(fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}