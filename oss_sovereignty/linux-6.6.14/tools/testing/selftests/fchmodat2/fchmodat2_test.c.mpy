{
  "module_name": "fchmodat2_test.c",
  "hash_id": "45f31c8738240c71eddadc2d7612b1a9b6cc8e7817721162f7509dd7dd81e260",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/fchmodat2/fchmodat2_test.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <syscall.h>\n#include <unistd.h>\n\n#include \"../kselftest.h\"\n\nint sys_fchmodat2(int dfd, const char *filename, mode_t mode, int flags)\n{\n\tint ret = syscall(__NR_fchmodat2, dfd, filename, mode, flags);\n\n\treturn ret >= 0 ? ret : -errno;\n}\n\nint setup_testdir(void)\n{\n\tint dfd, ret;\n\tchar dirname[] = \"/tmp/ksft-fchmodat2.XXXXXX\";\n\n\t \n\tif (!mkdtemp(dirname))\n\t\tksft_exit_fail_msg(\"%s: failed to create tmpdir\\n\", __func__);\n\n\tdfd = open(dirname, O_PATH | O_DIRECTORY);\n\tif (dfd < 0)\n\t\tksft_exit_fail_msg(\"%s: failed to open tmpdir\\n\", __func__);\n\n\tret = openat(dfd, \"regfile\", O_CREAT | O_WRONLY | O_TRUNC, 0644);\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\"%s: failed to create file in tmpdir\\n\",\n\t\t\t\t__func__);\n\tclose(ret);\n\n\tret = symlinkat(\"regfile\", dfd, \"symlink\");\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\"%s: failed to create symlink in tmpdir\\n\",\n\t\t\t\t__func__);\n\n\treturn dfd;\n}\n\nint expect_mode(int dfd, const char *filename, mode_t expect_mode)\n{\n\tstruct stat st;\n\tint ret = fstatat(dfd, filename, &st, AT_SYMLINK_NOFOLLOW);\n\n\tif (ret)\n\t\tksft_exit_fail_msg(\"%s: %s: fstatat failed\\n\",\n\t\t\t\t__func__, filename);\n\n\treturn (st.st_mode == expect_mode);\n}\n\nvoid test_regfile(void)\n{\n\tint dfd, ret;\n\n\tdfd = setup_testdir();\n\n\tret = sys_fchmodat2(dfd, \"regfile\", 0640, 0);\n\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\"%s: fchmodat2(noflag) failed\\n\", __func__);\n\n\tif (!expect_mode(dfd, \"regfile\", 0100640))\n\t\tksft_exit_fail_msg(\"%s: wrong file mode bits after fchmodat2\\n\",\n\t\t\t\t__func__);\n\n\tret = sys_fchmodat2(dfd, \"regfile\", 0600, AT_SYMLINK_NOFOLLOW);\n\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\"%s: fchmodat2(AT_SYMLINK_NOFOLLOW) failed\\n\",\n\t\t\t\t__func__);\n\n\tif (!expect_mode(dfd, \"regfile\", 0100600))\n\t\tksft_exit_fail_msg(\"%s: wrong file mode bits after fchmodat2 with nofollow\\n\",\n\t\t\t\t__func__);\n\n\tksft_test_result_pass(\"fchmodat2(regfile)\\n\");\n}\n\nvoid test_symlink(void)\n{\n\tint dfd, ret;\n\n\tdfd = setup_testdir();\n\n\tret = sys_fchmodat2(dfd, \"symlink\", 0640, 0);\n\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\"%s: fchmodat2(noflag) failed\\n\", __func__);\n\n\tif (!expect_mode(dfd, \"regfile\", 0100640))\n\t\tksft_exit_fail_msg(\"%s: wrong file mode bits after fchmodat2\\n\",\n\t\t\t\t__func__);\n\n\tif (!expect_mode(dfd, \"symlink\", 0120777))\n\t\tksft_exit_fail_msg(\"%s: wrong symlink mode bits after fchmodat2\\n\",\n\t\t\t\t__func__);\n\n\tret = sys_fchmodat2(dfd, \"symlink\", 0600, AT_SYMLINK_NOFOLLOW);\n\n\t \n\tif (ret == 0 && !expect_mode(dfd, \"symlink\", 0120600))\n\t\tksft_exit_fail_msg(\"%s: wrong symlink mode bits after fchmodat2 with nofollow\\n\",\n\t\t\t\t__func__);\n\n\tif (!expect_mode(dfd, \"regfile\", 0100640))\n\t\tksft_exit_fail_msg(\"%s: wrong file mode bits after fchmodat2 with nofollow\\n\",\n\t\t\t\t__func__);\n\n\tif (ret != 0)\n\t\tksft_test_result_skip(\"fchmodat2(symlink)\\n\");\n\telse\n\t\tksft_test_result_pass(\"fchmodat2(symlink)\\n\");\n}\n\n#define NUM_TESTS 2\n\nint main(int argc, char **argv)\n{\n\tksft_print_header();\n\tksft_set_plan(NUM_TESTS);\n\n\ttest_regfile();\n\ttest_symlink();\n\n\tif (ksft_get_fail_cnt() + ksft_get_error_cnt() > 0)\n\t\tksft_exit_fail();\n\telse\n\t\tksft_exit_pass();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}