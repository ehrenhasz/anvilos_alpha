{
  "module_name": "init.c",
  "hash_id": "6690fc5708e5c11a6b8e6ac7a7fff4772af1dc5a0987760bed500740006f094a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/wireguard/qemu/init.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <unistd.h>\n#include <errno.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdbool.h>\n#include <fcntl.h>\n#include <time.h>\n#include <sys/wait.h>\n#include <sys/mount.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/io.h>\n#include <sys/ioctl.h>\n#include <sys/reboot.h>\n#include <sys/utsname.h>\n#include <sys/sendfile.h>\n#include <sys/sysmacros.h>\n#include <sys/random.h>\n#include <linux/random.h>\n#include <linux/version.h>\n\n__attribute__((noreturn)) static void poweroff(void)\n{\n\tfflush(stdout);\n\tfflush(stderr);\n\treboot(RB_AUTOBOOT);\n\tsleep(30);\n\tfprintf(stderr, \"\\x1b[37m\\x1b[41m\\x1b[1mFailed to power off!!!\\x1b[0m\\n\");\n\texit(1);\n}\n\nstatic void panic(const char *what)\n{\n\tfprintf(stderr, \"\\n\\n\\x1b[37m\\x1b[41m\\x1b[1mSOMETHING WENT HORRIBLY WRONG\\x1b[0m\\n\\n    \\x1b[31m\\x1b[1m%s: %s\\x1b[0m\\n\\n\\x1b[37m\\x1b[44m\\x1b[1mPower off...\\x1b[0m\\n\\n\", what, strerror(errno));\n\tpoweroff();\n}\n\n#define pretty_message(msg) puts(\"\\x1b[32m\\x1b[1m\" msg \"\\x1b[0m\")\n\nstatic void print_banner(void)\n{\n\tstruct utsname utsname;\n\tint len;\n\n\tif (uname(&utsname) < 0)\n\t\tpanic(\"uname\");\n\n\tlen = strlen(\"    WireGuard Test Suite on       \") + strlen(utsname.sysname) + strlen(utsname.release) + strlen(utsname.machine);\n\tprintf(\"\\x1b[45m\\x1b[33m\\x1b[1m%*.s\\x1b[0m\\n\\x1b[45m\\x1b[33m\\x1b[1m    WireGuard Test Suite on %s %s %s    \\x1b[0m\\n\\x1b[45m\\x1b[33m\\x1b[1m%*.s\\x1b[0m\\n\\n\", len, \"\", utsname.sysname, utsname.release, utsname.machine, len, \"\");\n}\n\nstatic void seed_rng(void)\n{\n\tint bits = 256, fd;\n\n\tif (!getrandom(NULL, 0, GRND_NONBLOCK))\n\t\treturn;\n\tpretty_message(\"[+] Fake seeding RNG...\");\n\tfd = open(\"/dev/random\", O_WRONLY);\n\tif (fd < 0)\n\t\tpanic(\"open(random)\");\n\tif (ioctl(fd, RNDADDTOENTCNT, &bits) < 0)\n\t\tpanic(\"ioctl(RNDADDTOENTCNT)\");\n\tclose(fd);\n}\n\nstatic void set_time(void)\n{\n\tif (time(NULL))\n\t\treturn;\n\tpretty_message(\"[+] Setting fake time...\");\n\tif (stime(&(time_t){1433512680}) < 0)\n\t\tpanic(\"settimeofday()\");\n}\n\nstatic void mount_filesystems(void)\n{\n\tpretty_message(\"[+] Mounting filesystems...\");\n\tmkdir(\"/dev\", 0755);\n\tmkdir(\"/proc\", 0755);\n\tmkdir(\"/sys\", 0755);\n\tmkdir(\"/tmp\", 0755);\n\tmkdir(\"/run\", 0755);\n\tmkdir(\"/var\", 0755);\n\tif (mount(\"none\", \"/dev\", \"devtmpfs\", 0, NULL))\n\t\tpanic(\"devtmpfs mount\");\n\tif (mount(\"none\", \"/proc\", \"proc\", 0, NULL))\n\t\tpanic(\"procfs mount\");\n\tif (mount(\"none\", \"/sys\", \"sysfs\", 0, NULL))\n\t\tpanic(\"sysfs mount\");\n\tif (mount(\"none\", \"/tmp\", \"tmpfs\", 0, NULL))\n\t\tpanic(\"tmpfs mount\");\n\tif (mount(\"none\", \"/run\", \"tmpfs\", 0, NULL))\n\t\tpanic(\"tmpfs mount\");\n\tif (mount(\"none\", \"/sys/kernel/debug\", \"debugfs\", 0, NULL))\n\t\t;  \n\tif (symlink(\"/run\", \"/var/run\"))\n\t\tpanic(\"run symlink\");\n\tif (symlink(\"/proc/self/fd\", \"/dev/fd\"))\n\t\tpanic(\"fd symlink\");\n}\n\nstatic void enable_logging(void)\n{\n\tint fd;\n\tpretty_message(\"[+] Enabling logging...\");\n\tfd = open(\"/proc/sys/kernel/printk\", O_WRONLY);\n\tif (fd >= 0) {\n\t\tif (write(fd, \"9\\n\", 2) != 2)\n\t\t\tpanic(\"write(printk)\");\n\t\tclose(fd);\n\t}\n\tfd = open(\"/proc/sys/debug/exception-trace\", O_WRONLY);\n\tif (fd >= 0) {\n\t\tif (write(fd, \"1\\n\", 2) != 2)\n\t\t\tpanic(\"write(exception-trace)\");\n\t\tclose(fd);\n\t}\n}\n\nstatic void kmod_selftests(void)\n{\n\tFILE *file;\n\tchar line[2048], *start, *pass;\n\tbool success = true;\n\tpretty_message(\"[+] Module self-tests:\");\n\tfile = fopen(\"/proc/kmsg\", \"r\");\n\tif (!file)\n\t\tpanic(\"fopen(kmsg)\");\n\tif (fcntl(fileno(file), F_SETFL, O_NONBLOCK) < 0)\n\t\tpanic(\"fcntl(kmsg, nonblock)\");\n\twhile (fgets(line, sizeof(line), file)) {\n\t\tstart = strstr(line, \"wireguard: \");\n\t\tif (!start)\n\t\t\tcontinue;\n\t\tstart += 11;\n\t\t*strchrnul(start, '\\n') = '\\0';\n\t\tif (strstr(start, \"www.wireguard.com\"))\n\t\t\tbreak;\n\t\tpass = strstr(start, \": pass\");\n\t\tif (!pass || pass[6] != '\\0') {\n\t\t\tsuccess = false;\n\t\t\tprintf(\" \\x1b[31m*  %s\\x1b[0m\\n\", start);\n\t\t} else\n\t\t\tprintf(\" \\x1b[32m*  %s\\x1b[0m\\n\", start);\n\t}\n\tfclose(file);\n\tif (!success) {\n\t\tputs(\"\\x1b[31m\\x1b[1m[-] Tests failed! \\u2639\\x1b[0m\");\n\t\tpoweroff();\n\t}\n}\n\nstatic void launch_tests(void)\n{\n\tchar cmdline[4096], *success_dev;\n\tint status, fd;\n\tpid_t pid;\n\n\tpretty_message(\"[+] Launching tests...\");\n\tpid = fork();\n\tif (pid == -1)\n\t\tpanic(\"fork\");\n\telse if (pid == 0) {\n\t\texecl(\"/init.sh\", \"init\", NULL);\n\t\tpanic(\"exec\");\n\t}\n\tif (waitpid(pid, &status, 0) < 0)\n\t\tpanic(\"waitpid\");\n\tif (WIFEXITED(status) && WEXITSTATUS(status) == 0) {\n\t\tpretty_message(\"[+] Tests successful! :-)\");\n\t\tfd = open(\"/proc/cmdline\", O_RDONLY);\n\t\tif (fd < 0)\n\t\t\tpanic(\"open(/proc/cmdline)\");\n\t\tif (read(fd, cmdline, sizeof(cmdline) - 1) <= 0)\n\t\t\tpanic(\"read(/proc/cmdline)\");\n\t\tcmdline[sizeof(cmdline) - 1] = '\\0';\n\t\tfor (success_dev = strtok(cmdline, \" \\n\"); success_dev; success_dev = strtok(NULL, \" \\n\")) {\n\t\t\tif (strncmp(success_dev, \"wg.success=\", 11))\n\t\t\t\tcontinue;\n\t\t\tmemcpy(success_dev + 11 - 5, \"/dev/\", 5);\n\t\t\tsuccess_dev += 11 - 5;\n\t\t\tbreak;\n\t\t}\n\t\tif (!success_dev || !strlen(success_dev))\n\t\t\tpanic(\"Unable to find success device\");\n\n\t\tfd = open(success_dev, O_WRONLY);\n\t\tif (fd < 0)\n\t\t\tpanic(\"open(success_dev)\");\n\t\tif (write(fd, \"success\\n\", 8) != 8)\n\t\t\tpanic(\"write(success_dev)\");\n\t\tclose(fd);\n\t} else {\n\t\tconst char *why = \"unknown cause\";\n\t\tint what = -1;\n\n\t\tif (WIFEXITED(status)) {\n\t\t\twhy = \"exit code\";\n\t\t\twhat = WEXITSTATUS(status);\n\t\t} else if (WIFSIGNALED(status)) {\n\t\t\twhy = \"signal\";\n\t\t\twhat = WTERMSIG(status);\n\t\t}\n\t\tprintf(\"\\x1b[31m\\x1b[1m[-] Tests failed with %s %d! \\u2639\\x1b[0m\\n\", why, what);\n\t}\n}\n\nstatic void ensure_console(void)\n{\n\tfor (unsigned int i = 0; i < 1000; ++i) {\n\t\tint fd = open(\"/dev/console\", O_RDWR);\n\t\tif (fd < 0) {\n\t\t\tusleep(50000);\n\t\t\tcontinue;\n\t\t}\n\t\tdup2(fd, 0);\n\t\tdup2(fd, 1);\n\t\tdup2(fd, 2);\n\t\tclose(fd);\n\t\tif (write(1, \"\\0\\0\\0\\0\\n\", 5) == 5)\n\t\t\treturn;\n\t}\n\tpanic(\"Unable to open console device\");\n}\n\nstatic void clear_leaks(void)\n{\n\tint fd;\n\n\tfd = open(\"/sys/kernel/debug/kmemleak\", O_WRONLY);\n\tif (fd < 0)\n\t\treturn;\n\tpretty_message(\"[+] Starting memory leak detection...\");\n\twrite(fd, \"clear\\n\", 5);\n\tclose(fd);\n}\n\nstatic void check_leaks(void)\n{\n\tint fd;\n\n\tfd = open(\"/sys/kernel/debug/kmemleak\", O_WRONLY);\n\tif (fd < 0)\n\t\treturn;\n\tpretty_message(\"[+] Scanning for memory leaks...\");\n\tsleep(2);  \n\twrite(fd, \"scan\\n\", 5);\n\tclose(fd);\n\n\tfd = open(\"/sys/kernel/debug/kmemleak\", O_RDONLY);\n\tif (fd < 0)\n\t\treturn;\n\tif (sendfile(1, fd, NULL, 0x7ffff000) > 0)\n\t\tpanic(\"Memory leaks encountered\");\n\tclose(fd);\n}\n\nint main(int argc, char *argv[])\n{\n\tensure_console();\n\tprint_banner();\n\tmount_filesystems();\n\tseed_rng();\n\tset_time();\n\tkmod_selftests();\n\tenable_logging();\n\tclear_leaks();\n\tlaunch_tests();\n\tcheck_leaks();\n\tpoweroff();\n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}