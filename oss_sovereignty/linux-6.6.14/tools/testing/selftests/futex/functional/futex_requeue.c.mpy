{
  "module_name": "futex_requeue.c",
  "hash_id": "de25374406a7a9d0c8b84d4f8d67a4bc66188e5ce6a089a1a9e16e0a7c89271c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/futex/functional/futex_requeue.c",
  "human_readable_source": "\n \n\n#include <pthread.h>\n#include <limits.h>\n#include \"logging.h\"\n#include \"futextest.h\"\n\n#define TEST_NAME \"futex-requeue\"\n#define timeout_ns  30000000\n#define WAKE_WAIT_US 10000\n\nvolatile futex_t *f1;\n\nvoid usage(char *prog)\n{\n\tprintf(\"Usage: %s\\n\", prog);\n\tprintf(\"  -c\tUse color\\n\");\n\tprintf(\"  -h\tDisplay this help message\\n\");\n\tprintf(\"  -v L\tVerbosity level: %d=QUIET %d=CRITICAL %d=INFO\\n\",\n\t       VQUIET, VCRITICAL, VINFO);\n}\n\nvoid *waiterfn(void *arg)\n{\n\tstruct timespec to;\n\n\tto.tv_sec = 0;\n\tto.tv_nsec = timeout_ns;\n\n\tif (futex_wait(f1, *f1, &to, 0))\n\t\tprintf(\"waiter failed errno %d\\n\", errno);\n\n\treturn NULL;\n}\n\nint main(int argc, char *argv[])\n{\n\tpthread_t waiter[10];\n\tint res, ret = RET_PASS;\n\tint c, i;\n\tvolatile futex_t _f1 = 0;\n\tvolatile futex_t f2 = 0;\n\n\tf1 = &_f1;\n\n\twhile ((c = getopt(argc, argv, \"cht:v:\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 'c':\n\t\t\tlog_color(1);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(0);\n\t\tcase 'v':\n\t\t\tlog_verbosity(atoi(optarg));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(1);\n\t\t}\n\t}\n\n\tksft_print_header();\n\tksft_set_plan(2);\n\tksft_print_msg(\"%s: Test futex_requeue\\n\",\n\t\t       basename(argv[0]));\n\n\t \n\tif (pthread_create(&waiter[0], NULL, waiterfn, NULL))\n\t\terror(\"pthread_create failed\\n\", errno);\n\n\tusleep(WAKE_WAIT_US);\n\n\tinfo(\"Requeuing 1 futex from f1 to f2\\n\");\n\tres = futex_cmp_requeue(f1, 0, &f2, 0, 1, 0);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_requeue simple returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t}\n\n\n\tinfo(\"Waking 1 futex at f2\\n\");\n\tres = futex_wake(&f2, 1, 0);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_requeue simple returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_requeue simple succeeds\\n\");\n\t}\n\n\n\t \n\tfor (i = 0; i < 10; i++) {\n\t\tif (pthread_create(&waiter[i], NULL, waiterfn, NULL))\n\t\t\terror(\"pthread_create failed\\n\", errno);\n\t}\n\n\tusleep(WAKE_WAIT_US);\n\n\tinfo(\"Waking 3 futexes at f1 and requeuing 7 futexes from f1 to f2\\n\");\n\tres = futex_cmp_requeue(f1, 0, &f2, 3, 7, 0);\n\tif (res != 10) {\n\t\tksft_test_result_fail(\"futex_requeue many returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t}\n\n\tinfo(\"Waking INT_MAX futexes at f2\\n\");\n\tres = futex_wake(&f2, INT_MAX, 0);\n\tif (res != 7) {\n\t\tksft_test_result_fail(\"futex_requeue many returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_requeue many succeeds\\n\");\n\t}\n\n\tksft_print_cnts();\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}