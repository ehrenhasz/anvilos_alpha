{
  "module_name": "futex_waitv.c",
  "hash_id": "9939ccbb884ff2be9fe606c4c47d0357973b0ff283577a2c76c42e8064b22846",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/futex/functional/futex_waitv.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <error.h>\n#include <getopt.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <time.h>\n#include <pthread.h>\n#include <stdint.h>\n#include <sys/shm.h>\n#include \"futextest.h\"\n#include \"futex2test.h\"\n#include \"logging.h\"\n\n#define TEST_NAME \"futex-wait\"\n#define WAKE_WAIT_US 10000\n#define NR_FUTEXES 30\nstatic struct futex_waitv waitv[NR_FUTEXES];\nu_int32_t futexes[NR_FUTEXES] = {0};\n\nvoid usage(char *prog)\n{\n\tprintf(\"Usage: %s\\n\", prog);\n\tprintf(\"  -c\tUse color\\n\");\n\tprintf(\"  -h\tDisplay this help message\\n\");\n\tprintf(\"  -v L\tVerbosity level: %d=QUIET %d=CRITICAL %d=INFO\\n\",\n\t       VQUIET, VCRITICAL, VINFO);\n}\n\nvoid *waiterfn(void *arg)\n{\n\tstruct timespec to;\n\tint res;\n\n\t \n\tif (clock_gettime(CLOCK_MONOTONIC, &to))\n\t\terror(\"gettime64 failed\\n\", errno);\n\n\tto.tv_sec++;\n\n\tres = futex_waitv(waitv, NR_FUTEXES, 0, &to, CLOCK_MONOTONIC);\n\tif (res < 0) {\n\t\tksft_test_result_fail(\"futex_waitv returned: %d %s\\n\",\n\t\t\t\t      errno, strerror(errno));\n\t} else if (res != NR_FUTEXES - 1) {\n\t\tksft_test_result_fail(\"futex_waitv returned: %d, expecting %d\\n\",\n\t\t\t\t      res, NR_FUTEXES - 1);\n\t}\n\n\treturn NULL;\n}\n\nint main(int argc, char *argv[])\n{\n\tpthread_t waiter;\n\tint res, ret = RET_PASS;\n\tstruct timespec to;\n\tint c, i;\n\n\twhile ((c = getopt(argc, argv, \"cht:v:\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 'c':\n\t\t\tlog_color(1);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(0);\n\t\tcase 'v':\n\t\t\tlog_verbosity(atoi(optarg));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(1);\n\t\t}\n\t}\n\n\tksft_print_header();\n\tksft_set_plan(7);\n\tksft_print_msg(\"%s: Test FUTEX_WAITV\\n\",\n\t\t       basename(argv[0]));\n\n\tfor (i = 0; i < NR_FUTEXES; i++) {\n\t\twaitv[i].uaddr = (uintptr_t)&futexes[i];\n\t\twaitv[i].flags = FUTEX_32 | FUTEX_PRIVATE_FLAG;\n\t\twaitv[i].val = 0;\n\t\twaitv[i].__reserved = 0;\n\t}\n\n\t \n\tif (pthread_create(&waiter, NULL, waiterfn, NULL))\n\t\terror(\"pthread_create failed\\n\", errno);\n\n\tusleep(WAKE_WAIT_US);\n\n\tres = futex_wake(u64_to_ptr(waitv[NR_FUTEXES - 1].uaddr), 1, FUTEX_PRIVATE_FLAG);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_wake private returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv private\\n\");\n\t}\n\n\t \n\tfor (i = 0; i < NR_FUTEXES; i++) {\n\t\tint shm_id = shmget(IPC_PRIVATE, 4096, IPC_CREAT | 0666);\n\n\t\tif (shm_id < 0) {\n\t\t\tperror(\"shmget\");\n\t\t\texit(1);\n\t\t}\n\n\t\tunsigned int *shared_data = shmat(shm_id, NULL, 0);\n\n\t\t*shared_data = 0;\n\t\twaitv[i].uaddr = (uintptr_t)shared_data;\n\t\twaitv[i].flags = FUTEX_32;\n\t\twaitv[i].val = 0;\n\t\twaitv[i].__reserved = 0;\n\t}\n\n\tif (pthread_create(&waiter, NULL, waiterfn, NULL))\n\t\terror(\"pthread_create failed\\n\", errno);\n\n\tusleep(WAKE_WAIT_US);\n\n\tres = futex_wake(u64_to_ptr(waitv[NR_FUTEXES - 1].uaddr), 1, 0);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_wake shared returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv shared\\n\");\n\t}\n\n\tfor (i = 0; i < NR_FUTEXES; i++)\n\t\tshmdt(u64_to_ptr(waitv[i].uaddr));\n\n\t \n\twaitv[0].flags = FUTEX_PRIVATE_FLAG;\n\n\tif (clock_gettime(CLOCK_MONOTONIC, &to))\n\t\terror(\"gettime64 failed\\n\", errno);\n\n\tto.tv_sec++;\n\n\tres = futex_waitv(waitv, NR_FUTEXES, 0, &to, CLOCK_MONOTONIC);\n\tif (res == EINVAL) {\n\t\tksft_test_result_fail(\"futex_waitv private returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv without FUTEX_32\\n\");\n\t}\n\n\t \n\twaitv[0].flags = FUTEX_PRIVATE_FLAG | FUTEX_32;\n\twaitv[0].uaddr = 1;\n\n\tif (clock_gettime(CLOCK_MONOTONIC, &to))\n\t\terror(\"gettime64 failed\\n\", errno);\n\n\tto.tv_sec++;\n\n\tres = futex_waitv(waitv, NR_FUTEXES, 0, &to, CLOCK_MONOTONIC);\n\tif (res == EINVAL) {\n\t\tksft_test_result_fail(\"futex_wake private returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv with an unaligned address\\n\");\n\t}\n\n\t \n\twaitv[0].uaddr = 0x00000000;\n\n\tif (clock_gettime(CLOCK_MONOTONIC, &to))\n\t\terror(\"gettime64 failed\\n\", errno);\n\n\tto.tv_sec++;\n\n\tres = futex_waitv(waitv, NR_FUTEXES, 0, &to, CLOCK_MONOTONIC);\n\tif (res == EINVAL) {\n\t\tksft_test_result_fail(\"futex_waitv private returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv NULL address in waitv.uaddr\\n\");\n\t}\n\n\t \n\tif (clock_gettime(CLOCK_MONOTONIC, &to))\n\t\terror(\"gettime64 failed\\n\", errno);\n\n\tto.tv_sec++;\n\n\tres = futex_waitv(NULL, NR_FUTEXES, 0, &to, CLOCK_MONOTONIC);\n\tif (res == EINVAL) {\n\t\tksft_test_result_fail(\"futex_waitv private returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv NULL address in *waiters\\n\");\n\t}\n\n\t \n\tif (clock_gettime(CLOCK_MONOTONIC, &to))\n\t\terror(\"gettime64 failed\\n\", errno);\n\n\tto.tv_sec++;\n\n\tres = futex_waitv(NULL, NR_FUTEXES, 0, &to, CLOCK_TAI);\n\tif (res == EINVAL) {\n\t\tksft_test_result_fail(\"futex_waitv private returned: %d %s\\n\",\n\t\t\t\t      res ? errno : res,\n\t\t\t\t      res ? strerror(errno) : \"\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_waitv invalid clockid\\n\");\n\t}\n\n\tksft_print_cnts();\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}