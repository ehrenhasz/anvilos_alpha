{
  "module_name": "futex_requeue_pi_mismatched_ops.c",
  "hash_id": "cf95a0c8395ea9713083dfed9e428663746f0a5400ba4f64a9c0bcf7c6f4c05e",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/futex/functional/futex_requeue_pi_mismatched_ops.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <getopt.h>\n#include <pthread.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <time.h>\n#include \"futextest.h\"\n#include \"logging.h\"\n\n#define TEST_NAME \"futex-requeue-pi-mismatched-ops\"\n\nfutex_t f1 = FUTEX_INITIALIZER;\nfutex_t f2 = FUTEX_INITIALIZER;\nint child_ret = 0;\n\nvoid usage(char *prog)\n{\n\tprintf(\"Usage: %s\\n\", prog);\n\tprintf(\"  -c\tUse color\\n\");\n\tprintf(\"  -h\tDisplay this help message\\n\");\n\tprintf(\"  -v L\tVerbosity level: %d=QUIET %d=CRITICAL %d=INFO\\n\",\n\t       VQUIET, VCRITICAL, VINFO);\n}\n\nvoid *blocking_child(void *arg)\n{\n\tchild_ret = futex_wait(&f1, f1, NULL, FUTEX_PRIVATE_FLAG);\n\tif (child_ret < 0) {\n\t\tchild_ret = -errno;\n\t\terror(\"futex_wait\\n\", errno);\n\t}\n\treturn (void *)&child_ret;\n}\n\nint main(int argc, char *argv[])\n{\n\tint ret = RET_PASS;\n\tpthread_t child;\n\tint c;\n\n\twhile ((c = getopt(argc, argv, \"chv:\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 'c':\n\t\t\tlog_color(1);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(0);\n\t\tcase 'v':\n\t\t\tlog_verbosity(atoi(optarg));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(1);\n\t\t}\n\t}\n\n\tksft_print_header();\n\tksft_set_plan(1);\n\tksft_print_msg(\"%s: Detect mismatched requeue_pi operations\\n\",\n\t       basename(argv[0]));\n\n\tif (pthread_create(&child, NULL, blocking_child, NULL)) {\n\t\terror(\"pthread_create\\n\", errno);\n\t\tret = RET_ERROR;\n\t\tgoto out;\n\t}\n\t \n\tsleep(1);\n\n\t \n\tret = futex_cmp_requeue_pi(&f1, f1, &f2, 1, 0, FUTEX_PRIVATE_FLAG);\n\tif (ret < 0) {\n\t\tif (errno == EINVAL) {\n\t\t\t \n\t\t\tret = futex_wake(&f1, 1, FUTEX_PRIVATE_FLAG);\n\t\t\tif (ret == 1) {\n\t\t\t\tret = RET_PASS;\n\t\t\t} else if (ret < 0) {\n\t\t\t\terror(\"futex_wake\\n\", errno);\n\t\t\t\tret = RET_ERROR;\n\t\t\t} else {\n\t\t\t\terror(\"futex_wake did not wake the child\\n\", 0);\n\t\t\t\tret = RET_ERROR;\n\t\t\t}\n\t\t} else {\n\t\t\terror(\"futex_cmp_requeue_pi\\n\", errno);\n\t\t\tret = RET_ERROR;\n\t\t}\n\t} else if (ret > 0) {\n\t\tfail(\"futex_cmp_requeue_pi failed to detect the mismatch\\n\");\n\t\tret = RET_FAIL;\n\t} else {\n\t\terror(\"futex_cmp_requeue_pi found no waiters\\n\", 0);\n\t\tret = RET_ERROR;\n\t}\n\n\tpthread_join(child, NULL);\n\n\tif (!ret)\n\t\tret = child_ret;\n\n out:\n\t \n\tprint_result(TEST_NAME, ret);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}