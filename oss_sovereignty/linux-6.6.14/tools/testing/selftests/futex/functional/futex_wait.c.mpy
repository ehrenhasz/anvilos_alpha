{
  "module_name": "futex_wait.c",
  "hash_id": "1b98bda36db60d63fe915aa9b07e7d61b6ffa1930487ea063b8f88b1ca00acdf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/futex/functional/futex_wait.c",
  "human_readable_source": "\n \n\n#include <pthread.h>\n#include <sys/shm.h>\n#include <sys/mman.h>\n#include <fcntl.h>\n#include \"logging.h\"\n#include \"futextest.h\"\n\n#define TEST_NAME \"futex-wait\"\n#define timeout_ns  30000000\n#define WAKE_WAIT_US 10000\n#define SHM_PATH \"futex_shm_file\"\n\nvoid *futex;\n\nvoid usage(char *prog)\n{\n\tprintf(\"Usage: %s\\n\", prog);\n\tprintf(\"  -c\tUse color\\n\");\n\tprintf(\"  -h\tDisplay this help message\\n\");\n\tprintf(\"  -v L\tVerbosity level: %d=QUIET %d=CRITICAL %d=INFO\\n\",\n\t       VQUIET, VCRITICAL, VINFO);\n}\n\nstatic void *waiterfn(void *arg)\n{\n\tstruct timespec to;\n\tunsigned int flags = 0;\n\n\tif (arg)\n\t\tflags = *((unsigned int *) arg);\n\n\tto.tv_sec = 0;\n\tto.tv_nsec = timeout_ns;\n\n\tif (futex_wait(futex, 0, &to, flags))\n\t\tprintf(\"waiter failed errno %d\\n\", errno);\n\n\treturn NULL;\n}\n\nint main(int argc, char *argv[])\n{\n\tint res, ret = RET_PASS, fd, c, shm_id;\n\tu_int32_t f_private = 0, *shared_data;\n\tunsigned int flags = FUTEX_PRIVATE_FLAG;\n\tpthread_t waiter;\n\tvoid *shm;\n\n\tfutex = &f_private;\n\n\twhile ((c = getopt(argc, argv, \"cht:v:\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 'c':\n\t\t\tlog_color(1);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(0);\n\t\tcase 'v':\n\t\t\tlog_verbosity(atoi(optarg));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage(basename(argv[0]));\n\t\t\texit(1);\n\t\t}\n\t}\n\n\tksft_print_header();\n\tksft_set_plan(3);\n\tksft_print_msg(\"%s: Test futex_wait\\n\", basename(argv[0]));\n\n\t \n\tinfo(\"Calling private futex_wait on futex: %p\\n\", futex);\n\tif (pthread_create(&waiter, NULL, waiterfn, (void *) &flags))\n\t\terror(\"pthread_create failed\\n\", errno);\n\n\tusleep(WAKE_WAIT_US);\n\n\tinfo(\"Calling private futex_wake on futex: %p\\n\", futex);\n\tres = futex_wake(futex, 1, FUTEX_PRIVATE_FLAG);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_wake private returned: %d %s\\n\",\n\t\t\t\t      errno, strerror(errno));\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_wake private succeeds\\n\");\n\t}\n\n\t \n\tshm_id = shmget(IPC_PRIVATE, 4096, IPC_CREAT | 0666);\n\tif (shm_id < 0) {\n\t\tperror(\"shmget\");\n\t\texit(1);\n\t}\n\n\tshared_data = shmat(shm_id, NULL, 0);\n\n\t*shared_data = 0;\n\tfutex = shared_data;\n\n\tinfo(\"Calling shared (page anon) futex_wait on futex: %p\\n\", futex);\n\tif (pthread_create(&waiter, NULL, waiterfn, NULL))\n\t\terror(\"pthread_create failed\\n\", errno);\n\n\tusleep(WAKE_WAIT_US);\n\n\tinfo(\"Calling shared (page anon) futex_wake on futex: %p\\n\", futex);\n\tres = futex_wake(futex, 1, 0);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_wake shared (page anon) returned: %d %s\\n\",\n\t\t\t\t      errno, strerror(errno));\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_wake shared (page anon) succeeds\\n\");\n\t}\n\n\n\t \n\tfd = open(SHM_PATH, O_RDWR | O_CREAT, S_IRUSR | S_IWUSR);\n\tif (fd < 0) {\n\t\tperror(\"open\");\n\t\texit(1);\n\t}\n\n\tif (ftruncate(fd, sizeof(f_private))) {\n\t\tperror(\"ftruncate\");\n\t\texit(1);\n\t}\n\n\tshm = mmap(NULL, sizeof(f_private), PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);\n\tif (shm == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\n\tmemcpy(shm, &f_private, sizeof(f_private));\n\n\tfutex = shm;\n\n\tinfo(\"Calling shared (file backed) futex_wait on futex: %p\\n\", futex);\n\tif (pthread_create(&waiter, NULL, waiterfn, NULL))\n\t\terror(\"pthread_create failed\\n\", errno);\n\n\tusleep(WAKE_WAIT_US);\n\n\tinfo(\"Calling shared (file backed) futex_wake on futex: %p\\n\", futex);\n\tres = futex_wake(shm, 1, 0);\n\tif (res != 1) {\n\t\tksft_test_result_fail(\"futex_wake shared (file backed) returned: %d %s\\n\",\n\t\t\t\t      errno, strerror(errno));\n\t\tret = RET_FAIL;\n\t} else {\n\t\tksft_test_result_pass(\"futex_wake shared (file backed) succeeds\\n\");\n\t}\n\n\t \n\tshmdt(shared_data);\n\tmunmap(shm, sizeof(f_private));\n\tremove(SHM_PATH);\n\tclose(fd);\n\n\tksft_print_cnts();\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}