{
  "module_name": "sysfs.sh",
  "hash_id": "c62b091310e6cf23d57084ad7bc9573b7b8e78125eed123e0a75eaa48e8048ed",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/damon/sysfs.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Kselftest frmework requirement - SKIP code is 4.\nksft_skip=4\n\nensure_write_succ()\n{\n\tfile=$1\n\tcontent=$2\n\treason=$3\n\n\tif ! echo \"$content\" > \"$file\"\n\tthen\n\t\techo \"writing $content to $file failed\"\n\t\techo \"expected success because $reason\"\n\t\texit 1\n\tfi\n}\n\nensure_write_fail()\n{\n\tfile=$1\n\tcontent=$2\n\treason=$3\n\n\tif (echo \"$content\" > \"$file\") 2> /dev/null\n\tthen\n\t\techo \"writing $content to $file succeed ($fail_reason)\"\n\t\techo \"expected failure because $reason\"\n\t\texit 1\n\tfi\n}\n\nensure_dir()\n{\n\tdir=$1\n\tto_ensure=$2\n\tif [ \"$to_ensure\" = \"exist\" ] && [ ! -d \"$dir\" ]\n\tthen\n\t\techo \"$dir dir is expected but not found\"\n\t\texit 1\n\telif [ \"$to_ensure\" = \"not_exist\" ] && [ -d \"$dir\" ]\n\tthen\n\t\techo \"$dir dir is not expected but found\"\n\t\texit 1\n\tfi\n}\n\nensure_file()\n{\n\tfile=$1\n\tto_ensure=$2\n\tpermission=$3\n\tif [ \"$to_ensure\" = \"exist\" ]\n\tthen\n\t\tif [ ! -f \"$file\" ]\n\t\tthen\n\t\t\techo \"$file is expected but not found\"\n\t\t\texit 1\n\t\tfi\n\t\tperm=$(stat -c \"%a\" \"$file\")\n\t\tif [ ! \"$perm\" = \"$permission\" ]\n\t\tthen\n\t\t\techo \"$file permission: expected $permission but $perm\"\n\t\t\texit 1\n\t\tfi\n\telif [ \"$to_ensure\" = \"not_exist\" ] && [ -f \"$dir\" ]\n\tthen\n\t\techo \"$file is not expected but found\"\n\t\texit 1\n\tfi\n}\n\ntest_range()\n{\n\trange_dir=$1\n\tensure_dir \"$range_dir\" \"exist\"\n\tensure_file \"$range_dir/min\" \"exist\" 600\n\tensure_file \"$range_dir/max\" \"exist\" 600\n}\n\ntest_tried_regions()\n{\n\ttried_regions_dir=$1\n\tensure_dir \"$tried_regions_dir\" \"exist\"\n\tensure_file \"$tried_regions_dir/total_bytes\" \"exist\" \"400\"\n}\n\ntest_stats()\n{\n\tstats_dir=$1\n\tensure_dir \"$stats_dir\" \"exist\"\n\tfor f in nr_tried sz_tried nr_applied sz_applied qt_exceeds\n\tdo\n\t\tensure_file \"$stats_dir/$f\" \"exist\" \"400\"\n\tdone\n}\n\ntest_filter()\n{\n\tfilter_dir=$1\n\tensure_file \"$filter_dir/type\" \"exist\" \"600\"\n\tensure_write_succ \"$filter_dir/type\" \"anon\" \"valid input\"\n\tensure_write_succ \"$filter_dir/type\" \"memcg\" \"valid input\"\n\tensure_write_succ \"$filter_dir/type\" \"addr\" \"valid input\"\n\tensure_write_succ \"$filter_dir/type\" \"target\" \"valid input\"\n\tensure_write_fail \"$filter_dir/type\" \"foo\" \"invalid input\"\n\tensure_file \"$filter_dir/matching\" \"exist\" \"600\"\n\tensure_file \"$filter_dir/memcg_path\" \"exist\" \"600\"\n\tensure_file \"$filter_dir/addr_start\" \"exist\" \"600\"\n\tensure_file \"$filter_dir/addr_end\" \"exist\" \"600\"\n\tensure_file \"$filter_dir/damon_target_idx\" \"exist\" \"600\"\n}\n\ntest_filters()\n{\n\tfilters_dir=$1\n\tensure_dir \"$filters_dir\" \"exist\"\n\tensure_file \"$filters_dir/nr_filters\" \"exist\" \"600\"\n\tensure_write_succ  \"$filters_dir/nr_filters\" \"1\" \"valid input\"\n\ttest_filter \"$filters_dir/0\"\n\n\tensure_write_succ  \"$filters_dir/nr_filters\" \"2\" \"valid input\"\n\ttest_filter \"$filters_dir/0\"\n\ttest_filter \"$filters_dir/1\"\n\n\tensure_write_succ \"$filters_dir/nr_filters\" \"0\" \"valid input\"\n\tensure_dir \"$filters_dir/0\" \"not_exist\"\n\tensure_dir \"$filters_dir/1\" \"not_exist\"\n}\n\ntest_watermarks()\n{\n\twatermarks_dir=$1\n\tensure_dir \"$watermarks_dir\" \"exist\"\n\tensure_file \"$watermarks_dir/metric\" \"exist\" \"600\"\n\tensure_file \"$watermarks_dir/interval_us\" \"exist\" \"600\"\n\tensure_file \"$watermarks_dir/high\" \"exist\" \"600\"\n\tensure_file \"$watermarks_dir/mid\" \"exist\" \"600\"\n\tensure_file \"$watermarks_dir/low\" \"exist\" \"600\"\n}\n\ntest_weights()\n{\n\tweights_dir=$1\n\tensure_dir \"$weights_dir\" \"exist\"\n\tensure_file \"$weights_dir/sz_permil\" \"exist\" \"600\"\n\tensure_file \"$weights_dir/nr_accesses_permil\" \"exist\" \"600\"\n\tensure_file \"$weights_dir/age_permil\" \"exist\" \"600\"\n}\n\ntest_quotas()\n{\n\tquotas_dir=$1\n\tensure_dir \"$quotas_dir\" \"exist\"\n\tensure_file \"$quotas_dir/ms\" \"exist\" 600\n\tensure_file \"$quotas_dir/bytes\" \"exist\" 600\n\tensure_file \"$quotas_dir/reset_interval_ms\" \"exist\" 600\n\ttest_weights \"$quotas_dir/weights\"\n}\n\ntest_access_pattern()\n{\n\taccess_pattern_dir=$1\n\tensure_dir \"$access_pattern_dir\" \"exist\"\n\ttest_range \"$access_pattern_dir/age\"\n\ttest_range \"$access_pattern_dir/nr_accesses\"\n\ttest_range \"$access_pattern_dir/sz\"\n}\n\ntest_scheme()\n{\n\tscheme_dir=$1\n\tensure_dir \"$scheme_dir\" \"exist\"\n\tensure_file \"$scheme_dir/action\" \"exist\" \"600\"\n\ttest_access_pattern \"$scheme_dir/access_pattern\"\n\ttest_quotas \"$scheme_dir/quotas\"\n\ttest_watermarks \"$scheme_dir/watermarks\"\n\ttest_filters \"$scheme_dir/filters\"\n\ttest_stats \"$scheme_dir/stats\"\n\ttest_tried_regions \"$scheme_dir/tried_regions\"\n}\n\ntest_schemes()\n{\n\tschemes_dir=$1\n\tensure_dir \"$schemes_dir\" \"exist\"\n\tensure_file \"$schemes_dir/nr_schemes\" \"exist\" 600\n\n\tensure_write_succ  \"$schemes_dir/nr_schemes\" \"1\" \"valid input\"\n\ttest_scheme \"$schemes_dir/0\"\n\n\tensure_write_succ  \"$schemes_dir/nr_schemes\" \"2\" \"valid input\"\n\ttest_scheme \"$schemes_dir/0\"\n\ttest_scheme \"$schemes_dir/1\"\n\n\tensure_write_succ \"$schemes_dir/nr_schemes\" \"0\" \"valid input\"\n\tensure_dir \"$schemes_dir/0\" \"not_exist\"\n\tensure_dir \"$schemes_dir/1\" \"not_exist\"\n}\n\ntest_region()\n{\n\tregion_dir=$1\n\tensure_dir \"$region_dir\" \"exist\"\n\tensure_file \"$region_dir/start\" \"exist\" 600\n\tensure_file \"$region_dir/end\" \"exist\" 600\n}\n\ntest_regions()\n{\n\tregions_dir=$1\n\tensure_dir \"$regions_dir\" \"exist\"\n\tensure_file \"$regions_dir/nr_regions\" \"exist\" 600\n\n\tensure_write_succ  \"$regions_dir/nr_regions\" \"1\" \"valid input\"\n\ttest_region \"$regions_dir/0\"\n\n\tensure_write_succ  \"$regions_dir/nr_regions\" \"2\" \"valid input\"\n\ttest_region \"$regions_dir/0\"\n\ttest_region \"$regions_dir/1\"\n\n\tensure_write_succ \"$regions_dir/nr_regions\" \"0\" \"valid input\"\n\tensure_dir \"$regions_dir/0\" \"not_exist\"\n\tensure_dir \"$regions_dir/1\" \"not_exist\"\n}\n\ntest_target()\n{\n\ttarget_dir=$1\n\tensure_dir \"$target_dir\" \"exist\"\n\tensure_file \"$target_dir/pid_target\" \"exist\" \"600\"\n\ttest_regions \"$target_dir/regions\"\n}\n\ntest_targets()\n{\n\ttargets_dir=$1\n\tensure_dir \"$targets_dir\" \"exist\"\n\tensure_file \"$targets_dir/nr_targets\" \"exist\" 600\n\n\tensure_write_succ  \"$targets_dir/nr_targets\" \"1\" \"valid input\"\n\ttest_target \"$targets_dir/0\"\n\n\tensure_write_succ  \"$targets_dir/nr_targets\" \"2\" \"valid input\"\n\ttest_target \"$targets_dir/0\"\n\ttest_target \"$targets_dir/1\"\n\n\tensure_write_succ \"$targets_dir/nr_targets\" \"0\" \"valid input\"\n\tensure_dir \"$targets_dir/0\" \"not_exist\"\n\tensure_dir \"$targets_dir/1\" \"not_exist\"\n}\n\ntest_intervals()\n{\n\tintervals_dir=$1\n\tensure_dir \"$intervals_dir\" \"exist\"\n\tensure_file \"$intervals_dir/aggr_us\" \"exist\" \"600\"\n\tensure_file \"$intervals_dir/sample_us\" \"exist\" \"600\"\n\tensure_file \"$intervals_dir/update_us\" \"exist\" \"600\"\n}\n\ntest_monitoring_attrs()\n{\n\tmonitoring_attrs_dir=$1\n\tensure_dir \"$monitoring_attrs_dir\" \"exist\"\n\ttest_intervals \"$monitoring_attrs_dir/intervals\"\n\ttest_range \"$monitoring_attrs_dir/nr_regions\"\n}\n\ntest_context()\n{\n\tcontext_dir=$1\n\tensure_dir \"$context_dir\" \"exist\"\n\tensure_file \"$context_dir/avail_operations\" \"exit\" 400\n\tensure_file \"$context_dir/operations\" \"exist\" 600\n\ttest_monitoring_attrs \"$context_dir/monitoring_attrs\"\n\ttest_targets \"$context_dir/targets\"\n\ttest_schemes \"$context_dir/schemes\"\n}\n\ntest_contexts()\n{\n\tcontexts_dir=$1\n\tensure_dir \"$contexts_dir\" \"exist\"\n\tensure_file \"$contexts_dir/nr_contexts\" \"exist\" 600\n\n\tensure_write_succ  \"$contexts_dir/nr_contexts\" \"1\" \"valid input\"\n\ttest_context \"$contexts_dir/0\"\n\n\tensure_write_fail \"$contexts_dir/nr_contexts\" \"2\" \"only 0/1 are supported\"\n\ttest_context \"$contexts_dir/0\"\n\n\tensure_write_succ \"$contexts_dir/nr_contexts\" \"0\" \"valid input\"\n\tensure_dir \"$contexts_dir/0\" \"not_exist\"\n}\n\ntest_kdamond()\n{\n\tkdamond_dir=$1\n\tensure_dir \"$kdamond_dir\" \"exist\"\n\tensure_file \"$kdamond_dir/state\" \"exist\" \"600\"\n\tensure_file \"$kdamond_dir/pid\" \"exist\" 400\n\ttest_contexts \"$kdamond_dir/contexts\"\n}\n\ntest_kdamonds()\n{\n\tkdamonds_dir=$1\n\tensure_dir \"$kdamonds_dir\" \"exist\"\n\n\tensure_file \"$kdamonds_dir/nr_kdamonds\" \"exist\" \"600\"\n\n\tensure_write_succ  \"$kdamonds_dir/nr_kdamonds\" \"1\" \"valid input\"\n\ttest_kdamond \"$kdamonds_dir/0\"\n\n\tensure_write_succ  \"$kdamonds_dir/nr_kdamonds\" \"2\" \"valid input\"\n\ttest_kdamond \"$kdamonds_dir/0\"\n\ttest_kdamond \"$kdamonds_dir/1\"\n\n\tensure_write_succ \"$kdamonds_dir/nr_kdamonds\" \"0\" \"valid input\"\n\tensure_dir \"$kdamonds_dir/0\" \"not_exist\"\n\tensure_dir \"$kdamonds_dir/1\" \"not_exist\"\n}\n\ntest_damon_sysfs()\n{\n\tdamon_sysfs=$1\n\tif [ ! -d \"$damon_sysfs\" ]\n\tthen\n\t\techo \"$damon_sysfs not found\"\n\t\texit $ksft_skip\n\tfi\n\n\ttest_kdamonds \"$damon_sysfs/kdamonds\"\n}\n\ncheck_dependencies()\n{\n\tif [ $EUID -ne 0 ]\n\tthen\n\t\techo \"Run as root\"\n\t\texit $ksft_skip\n\tfi\n}\n\ncheck_dependencies\ntest_damon_sysfs \"/sys/kernel/mm/damon/admin\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}