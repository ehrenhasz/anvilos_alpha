{
  "module_name": "set-anon-vma-name-test.c",
  "hash_id": "35e65a93b955e9d6226168020c505096176979721e65586062cbf04ba4483d87",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/prctl/set-anon-vma-name-test.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <sys/prctl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/mman.h>\n#include <string.h>\n\n#include \"../kselftest_harness.h\"\n\n#define AREA_SIZE 1024\n\n#define GOOD_NAME \"goodname\"\n#define BAD_NAME \"badname\\1\"\n\n#ifndef PR_SET_VMA\n#define PR_SET_VMA 0x53564d41\n#define PR_SET_VMA_ANON_NAME 0\n#endif\n\n\nint rename_vma(unsigned long addr, unsigned long size, char *name)\n{\n\tint res;\n\n\tres = prctl(PR_SET_VMA, PR_SET_VMA_ANON_NAME, addr, size, name);\n\tif (res < 0)\n\t\treturn -errno;\n\treturn res;\n}\n\nint was_renaming_successful(char *target_name, unsigned long ptr)\n{\n\tFILE *maps_file;\n\n\tchar line_buf[512], name[128], mode[8];\n\tunsigned long start_addr, end_addr, offset;\n\tunsigned int major_id, minor_id, node_id;\n\n\tchar target_buf[128];\n\tint res = 0, sscanf_res;\n\n\t\n\tsprintf(target_buf, \"[anon:%s]\", target_name);\n\tmaps_file = fopen(\"/proc/self/maps\", \"r\");\n\tif (!maps_file) {\n\t\tprintf(\"## /proc/self/maps file opening error\\n\");\n\t\treturn 0;\n\t}\n\n\t\n\twhile (fgets(line_buf, sizeof(line_buf), maps_file)) {\n\t\tsscanf_res = sscanf(line_buf, \"%lx-%lx %7s %lx %u:%u %u %s\", &start_addr,\n\t\t\t\t\t&end_addr, mode, &offset, &major_id,\n\t\t\t\t\t&minor_id, &node_id, name);\n\t\tif (sscanf_res == EOF) {\n\t\t\tres = 0;\n\t\t\tprintf(\"## EOF while parsing the maps file\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tif (!strcmp(name, target_buf) && start_addr == ptr) {\n\t\t\tres = 1;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfclose(maps_file);\n\treturn res;\n}\n\nFIXTURE(vma) {\n\tvoid *ptr_anon, *ptr_not_anon;\n};\n\nFIXTURE_SETUP(vma) {\n\tself->ptr_anon = mmap(NULL, AREA_SIZE, PROT_READ | PROT_WRITE,\n\t\t\t\t\tMAP_PRIVATE | MAP_ANONYMOUS, 0, 0);\n\tASSERT_NE(self->ptr_anon, NULL);\n\tself->ptr_not_anon = mmap(NULL, AREA_SIZE, PROT_READ | PROT_WRITE,\n\t\t\t\t\tMAP_PRIVATE, 0, 0);\n\tASSERT_NE(self->ptr_not_anon, NULL);\n}\n\nFIXTURE_TEARDOWN(vma) {\n\tmunmap(self->ptr_anon, AREA_SIZE);\n\tmunmap(self->ptr_not_anon, AREA_SIZE);\n}\n\nTEST_F(vma, renaming) {\n\tTH_LOG(\"Try to rename the VMA with correct parameters\");\n\tEXPECT_GE(rename_vma((unsigned long)self->ptr_anon, AREA_SIZE, GOOD_NAME), 0);\n\tEXPECT_TRUE(was_renaming_successful(GOOD_NAME, (unsigned long)self->ptr_anon));\n\n\tTH_LOG(\"Try to pass invalid name (with non-printable character \\\\1) to rename the VMA\");\n\tEXPECT_EQ(rename_vma((unsigned long)self->ptr_anon, AREA_SIZE, BAD_NAME), -EINVAL);\n\n\tTH_LOG(\"Try to rename non-anonymous VMA\");\n\tEXPECT_EQ(rename_vma((unsigned long) self->ptr_not_anon, AREA_SIZE, GOOD_NAME), -EINVAL);\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}