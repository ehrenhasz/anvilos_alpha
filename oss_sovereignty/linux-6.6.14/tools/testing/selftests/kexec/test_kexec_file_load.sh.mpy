{
  "module_name": "test_kexec_file_load.sh",
  "hash_id": "e514c559728aa6319d057f5e4bf06b0acb455723a23286c52d857cf68873cf4f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kexec/test_kexec_file_load.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n#\n# Loading a kernel image via the kexec_file_load syscall can verify either\n# the IMA signature stored in the security.ima xattr or the PE signature,\n# both signatures depending on the IMA policy, or none.\n#\n# To determine whether the kernel image is signed, this test depends\n# on pesign and getfattr.  This test also requires the kernel to be\n# built with CONFIG_IKCONFIG enabled and either CONFIG_IKCONFIG_PROC\n# enabled or access to the extract-ikconfig script.\n\nTEST=\"KEXEC_FILE_LOAD\"\n. ./kexec_common_lib.sh\n\ntrap \"{ rm -f $IKCONFIG ; }\" EXIT\n\n# Some of the IMA builtin policies may require the kexec kernel image to\n# be signed, but these policy rules may be replaced with a custom\n# policy.  Only CONFIG_IMA_APPRAISE_REQUIRE_KEXEC_SIGS persists after\n# loading a custom policy.  Check if it is enabled, before reading the\n# IMA runtime sysfs policy file.\n# Return 1 for IMA signature required and 0 for not required.\nis_ima_sig_required()\n{\n\tlocal ret=0\n\n\tkconfig_enabled \"CONFIG_IMA_APPRAISE_REQUIRE_KEXEC_SIGS=y\" \\\n\t\t\"IMA kernel image signature required\"\n\tif [ $? -eq 1 ]; then\n\t\tlog_info \"IMA signature required\"\n\t\treturn 1\n\tfi\n\n\t# The architecture specific or a custom policy may require the\n\t# kexec kernel image be signed.  Policy rules are walked\n\t# sequentially.  As a result, a policy rule may be defined, but\n\t# might not necessarily be used.  This test assumes if a policy\n\t# rule is specified, that is the intent.\n\n\t# First check for appended signature (modsig), then xattr\n\tif [ $ima_read_policy -eq 1 ]; then\n\t\tcheck_ima_policy \"appraise\" \"func=KEXEC_KERNEL_CHECK\" \\\n\t\t\t\"appraise_type=imasig|modsig\"\n\t\tret=$?\n\t\tif [ $ret -eq 1 ]; then\n\t\t\tlog_info \"IMA or appended(modsig) signature required\"\n\t\telse\n\t\t\tcheck_ima_policy \"appraise\" \"func=KEXEC_KERNEL_CHECK\" \\\n\t\t\t\t\"appraise_type=imasig\"\n\t\t\tret=$?\n\t\t\t[ $ret -eq 1 ] && log_info \"IMA signature required\";\n\t\tfi\n\tfi\n\treturn $ret\n}\n\n# The kexec_file_load_test() is complicated enough, require pesign.\n# Return 1 for PE signature found and 0 for not found.\ncheck_for_pesig()\n{\n\twhich pesign > /dev/null 2>&1 || log_skip \"pesign not found\"\n\n\tpesign -i $KERNEL_IMAGE --show-signature | grep -q \"No signatures\"\n\tlocal ret=$?\n\tif [ $ret -eq 1 ]; then\n\t\tlog_info \"kexec kernel image PE signed\"\n\telse\n\t\tlog_info \"kexec kernel image not PE signed\"\n\tfi\n\treturn $ret\n}\n\n# The kexec_file_load_test() is complicated enough, require getfattr.\n# Return 1 for IMA signature found and 0 for not found.\ncheck_for_imasig()\n{\n\tlocal ret=0\n\n\twhich getfattr > /dev/null 2>&1\n\tif [ $?\t-eq 1 ]; then\n\t\tlog_skip \"getfattr not found\"\n\tfi\n\n\tline=$(getfattr -n security.ima -e hex --absolute-names $KERNEL_IMAGE 2>&1)\n\techo $line | grep -q \"security.ima=0x03\"\n\tif [ $? -eq 0 ]; then\n\t\tret=1\n\t\tlog_info \"kexec kernel image IMA signed\"\n\telse\n\t\tlog_info \"kexec kernel image not IMA signed\"\n\tfi\n\treturn $ret\n}\n\n# Return 1 for appended signature (modsig) found and 0 for not found.\ncheck_for_modsig()\n{\n\tlocal module_sig_string=\"~Module signature appended~\"\n\tlocal ret=0\n\n\ttail --bytes $((${#module_sig_string} + 1)) $KERNEL_IMAGE | \\\n\t\tgrep -q \"$module_sig_string\"\n\tif [ $? -eq 0 ]; then\n\t\tret=1\n\t\tlog_info \"kexec kernel image modsig signed\"\n\telse\n\t\tlog_info \"kexec kernel image not modsig signed\"\n\tfi\n\treturn $ret\n}\n\nkexec_file_load_test()\n{\n\tlocal succeed_msg=\"kexec_file_load succeeded\"\n\tlocal failed_msg=\"kexec_file_load failed\"\n\tlocal key_msg=\"try enabling the CONFIG_INTEGRITY_PLATFORM_KEYRING\"\n\n\tline=$(kexec --load --kexec-file-syscall $KERNEL_IMAGE 2>&1)\n\n\tif [ $? -eq 0 ]; then\n\t\tkexec --unload --kexec-file-syscall\n\n\t\t# In secureboot mode with an architecture  specific\n\t\t# policy, make sure either an IMA or PE signature exists.\n\t\tif [ $secureboot -eq 1 ] && [ $arch_policy -eq 1 ] && \\\n\t\t\t[ $ima_signed -eq 0 ] && [ $pe_signed -eq 0 ] \\\n\t\t\t  && [ $ima_modsig -eq 0 ]; then\n\t\t\tlog_fail \"$succeed_msg (missing sig)\"\n\t\tfi\n\n\t\tif [ $kexec_sig_required -eq 1 -o $pe_sig_required -eq 1 ] \\\n\t\t     && [ $pe_signed -eq 0 ]; then\n\t\t\tlog_fail \"$succeed_msg (missing PE sig)\"\n\t\tfi\n\n\t\tif [ $ima_sig_required -eq 1 ] && [ $ima_signed -eq 0 ] \\\n\t\t     && [ $ima_modsig -eq 0 ]; then\n\t\t\tlog_fail \"$succeed_msg (missing IMA sig)\"\n\t\tfi\n\n\t\tif [ $pe_sig_required -eq 0 ] && [ $ima_appraise -eq 1 ] \\\n\t\t    && [ $ima_sig_required -eq 0 ] && [ $ima_signed -eq 0 ] \\\n\t            && [ $ima_read_policy -eq 0 ]; then\n\t\t\tlog_fail \"$succeed_msg (possibly missing IMA sig)\"\n\t\tfi\n\n\t\tif [ $pe_sig_required -eq 0 ] && [ $ima_appraise -eq 0 ]; then\n\t\t\tlog_info \"No signature verification required\"\n\t\telif [ $pe_sig_required -eq 0 ] && [ $ima_appraise -eq 1 ] \\\n\t\t    && [ $ima_sig_required -eq 0 ] && [ $ima_signed -eq 0 ] \\\n\t            && [ $ima_read_policy -eq 1 ]; then\n\t\t\tlog_info \"No signature verification required\"\n\t\tfi\n\n\t\tlog_pass \"$succeed_msg\"\n\tfi\n\n\t# Check the reason for the kexec_file_load failure\n\techo $line | grep -q \"Required key not available\"\n\tif [ $? -eq 0 ]; then\n\t\tif [ $platform_keyring -eq 0 ]; then\n\t\t\tlog_pass \"$failed_msg (-ENOKEY), $key_msg\"\n\t\telse\n\t\t\tlog_pass \"$failed_msg (-ENOKEY)\"\n\t\tfi\n\tfi\n\n\tif [ $kexec_sig_required -eq 1 -o $pe_sig_required -eq 1 ] \\\n\t     && [ $pe_signed -eq 0 ]; then\n\t\tlog_pass \"$failed_msg (missing PE sig)\"\n\tfi\n\n\tif [ $ima_sig_required -eq 1 ] && [ $ima_signed -eq 0 ]; then\n\t\tlog_pass \"$failed_msg (missing IMA sig)\"\n\tfi\n\n\tif [ $pe_sig_required -eq 0 ] && [ $ima_appraise -eq 1 ] \\\n\t    && [ $ima_sig_required -eq 0 ] && [ $ima_read_policy -eq 0 ] \\\n\t    && [ $ima_signed -eq 0 ]; then\n\t\tlog_pass \"$failed_msg (possibly missing IMA sig)\"\n\tfi\n\n\tlog_pass \"$failed_msg\"\n\treturn 0\n}\n\n# kexec requires root privileges\nrequire_root_privileges\n\n# get the kernel config\nget_kconfig\n\nkconfig_enabled \"CONFIG_KEXEC_FILE=y\" \"kexec_file_load is enabled\"\nif [ $? -eq 0 ]; then\n\tlog_skip \"kexec_file_load is not enabled\"\nfi\n\n# Determine which kernel config options are enabled\nkconfig_enabled \"CONFIG_IMA_APPRAISE=y\" \"IMA enabled\"\nima_appraise=$?\n\nkconfig_enabled \"CONFIG_IMA_ARCH_POLICY=y\" \\\n\t\"architecture specific policy enabled\"\narch_policy=$?\n\nkconfig_enabled \"CONFIG_INTEGRITY_PLATFORM_KEYRING=y\" \\\n\t\"platform keyring enabled\"\nplatform_keyring=$?\n\nkconfig_enabled \"CONFIG_IMA_READ_POLICY=y\" \"reading IMA policy permitted\"\nima_read_policy=$?\n\nkconfig_enabled \"CONFIG_KEXEC_SIG_FORCE=y\" \\\n\t\"kexec signed kernel image required\"\nkexec_sig_required=$?\n\nkconfig_enabled \"CONFIG_KEXEC_BZIMAGE_VERIFY_SIG=y\" \\\n\t\"PE signed kernel image required\"\npe_sig_required=$?\n\nis_ima_sig_required\nima_sig_required=$?\n\nget_secureboot_mode\nsecureboot=$?\n\n# Are there pe and ima signatures\nif [ \"$(get_arch)\" == 'ppc64le' ]; then\n\tpe_signed=0\nelse\n\tcheck_for_pesig\n\tpe_signed=$?\nfi\n\ncheck_for_imasig\nima_signed=$?\n\ncheck_for_modsig\nima_modsig=$?\n\n# Test loading the kernel image via kexec_file_load syscall\nkexec_file_load_test\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}