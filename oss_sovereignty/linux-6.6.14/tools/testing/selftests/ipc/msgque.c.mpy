{
  "module_name": "msgque.c",
  "hash_id": "cfa1d2f84c0d8ed8fbb59ceae1952e300790a09f6d5755dd1d98f08bd6c2adaf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/ipc/msgque.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n#include <errno.h>\n#include <sys/msg.h>\n#include <fcntl.h>\n\n#include \"../kselftest.h\"\n\n#define MAX_MSG_SIZE\t\t32\n\nstruct msg1 {\n\tint msize;\n\tlong mtype;\n\tchar mtext[MAX_MSG_SIZE];\n};\n\n#define TEST_STRING \"Test sysv5 msg\"\n#define MSG_TYPE 1\n\n#define ANOTHER_TEST_STRING \"Yet another test sysv5 msg\"\n#define ANOTHER_MSG_TYPE 26538\n\nstruct msgque_data {\n\tkey_t key;\n\tint msq_id;\n\tint qbytes;\n\tint qnum;\n\tint mode;\n\tstruct msg1 *messages;\n};\n\nint restore_queue(struct msgque_data *msgque)\n{\n\tint fd, ret, id, i;\n\tchar buf[32];\n\n\tfd = open(\"/proc/sys/kernel/msg_next_id\", O_WRONLY);\n\tif (fd == -1) {\n\t\tprintf(\"Failed to open /proc/sys/kernel/msg_next_id\\n\");\n\t\treturn -errno;\n\t}\n\tsprintf(buf, \"%d\", msgque->msq_id);\n\n\tret = write(fd, buf, strlen(buf));\n\tif (ret != strlen(buf)) {\n\t\tprintf(\"Failed to write to /proc/sys/kernel/msg_next_id\\n\");\n\t\treturn -errno;\n\t}\n\n\tid = msgget(msgque->key, msgque->mode | IPC_CREAT | IPC_EXCL);\n\tif (id == -1) {\n\t\tprintf(\"Failed to create queue\\n\");\n\t\treturn -errno;\n\t}\n\n\tif (id != msgque->msq_id) {\n\t\tprintf(\"Restored queue has wrong id (%d instead of %d)\\n\",\n\t\t\t\t\t\t\tid, msgque->msq_id);\n\t\tret = -EFAULT;\n\t\tgoto destroy;\n\t}\n\n\tfor (i = 0; i < msgque->qnum; i++) {\n\t\tif (msgsnd(msgque->msq_id, &msgque->messages[i].mtype,\n\t\t\t   msgque->messages[i].msize, IPC_NOWAIT) != 0) {\n\t\t\tprintf(\"msgsnd failed (%m)\\n\");\n\t\t\tret = -errno;\n\t\t\tgoto destroy;\n\t\t}\n\t}\n\treturn 0;\n\ndestroy:\n\tif (msgctl(id, IPC_RMID, NULL))\n\t\tprintf(\"Failed to destroy queue: %d\\n\", -errno);\n\treturn ret;\n}\n\nint check_and_destroy_queue(struct msgque_data *msgque)\n{\n\tstruct msg1 message;\n\tint cnt = 0, ret;\n\n\twhile (1) {\n\t\tret = msgrcv(msgque->msq_id, &message.mtype, MAX_MSG_SIZE,\n\t\t\t\t0, IPC_NOWAIT);\n\t\tif (ret < 0) {\n\t\t\tif (errno == ENOMSG)\n\t\t\t\tbreak;\n\t\t\tprintf(\"Failed to read IPC message: %m\\n\");\n\t\t\tret = -errno;\n\t\t\tgoto err;\n\t\t}\n\t\tif (ret != msgque->messages[cnt].msize) {\n\t\t\tprintf(\"Wrong message size: %d (expected %d)\\n\", ret,\n\t\t\t\t\t\tmsgque->messages[cnt].msize);\n\t\t\tret = -EINVAL;\n\t\t\tgoto err;\n\t\t}\n\t\tif (message.mtype != msgque->messages[cnt].mtype) {\n\t\t\tprintf(\"Wrong message type\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto err;\n\t\t}\n\t\tif (memcmp(message.mtext, msgque->messages[cnt].mtext, ret)) {\n\t\t\tprintf(\"Wrong message content\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto err;\n\t\t}\n\t\tcnt++;\n\t}\n\n\tif (cnt != msgque->qnum) {\n\t\tprintf(\"Wrong message number\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\n\tret = 0;\nerr:\n\tif (msgctl(msgque->msq_id, IPC_RMID, NULL)) {\n\t\tprintf(\"Failed to destroy queue: %d\\n\", -errno);\n\t\treturn -errno;\n\t}\n\treturn ret;\n}\n\nint dump_queue(struct msgque_data *msgque)\n{\n\tstruct msqid_ds ds;\n\tint kern_id;\n\tint i, ret;\n\n\tfor (kern_id = 0; kern_id < 256; kern_id++) {\n\t\tret = msgctl(kern_id, MSG_STAT, &ds);\n\t\tif (ret < 0) {\n\t\t\tif (errno == EINVAL)\n\t\t\t\tcontinue;\n\t\t\tprintf(\"Failed to get stats for IPC queue with id %d\\n\",\n\t\t\t\t\tkern_id);\n\t\t\treturn -errno;\n\t\t}\n\n\t\tif (ret == msgque->msq_id)\n\t\t\tbreak;\n\t}\n\n\tmsgque->messages = malloc(sizeof(struct msg1) * ds.msg_qnum);\n\tif (msgque->messages == NULL) {\n\t\tprintf(\"Failed to get stats for IPC queue\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tmsgque->qnum = ds.msg_qnum;\n\tmsgque->mode = ds.msg_perm.mode;\n\tmsgque->qbytes = ds.msg_qbytes;\n\n\tfor (i = 0; i < msgque->qnum; i++) {\n\t\tret = msgrcv(msgque->msq_id, &msgque->messages[i].mtype,\n\t\t\t\tMAX_MSG_SIZE, i, IPC_NOWAIT | MSG_COPY);\n\t\tif (ret < 0) {\n\t\t\tprintf(\"Failed to copy IPC message: %m (%d)\\n\", errno);\n\t\t\treturn -errno;\n\t\t}\n\t\tmsgque->messages[i].msize = ret;\n\t}\n\treturn 0;\n}\n\nint fill_msgque(struct msgque_data *msgque)\n{\n\tstruct msg1 msgbuf;\n\n\tmsgbuf.mtype = MSG_TYPE;\n\tmemcpy(msgbuf.mtext, TEST_STRING, sizeof(TEST_STRING));\n\tif (msgsnd(msgque->msq_id, &msgbuf.mtype, sizeof(TEST_STRING),\n\t\t\t\tIPC_NOWAIT) != 0) {\n\t\tprintf(\"First message send failed (%m)\\n\");\n\t\treturn -errno;\n\t}\n\n\tmsgbuf.mtype = ANOTHER_MSG_TYPE;\n\tmemcpy(msgbuf.mtext, ANOTHER_TEST_STRING, sizeof(ANOTHER_TEST_STRING));\n\tif (msgsnd(msgque->msq_id, &msgbuf.mtype, sizeof(ANOTHER_TEST_STRING),\n\t\t\t\tIPC_NOWAIT) != 0) {\n\t\tprintf(\"Second message send failed (%m)\\n\");\n\t\treturn -errno;\n\t}\n\treturn 0;\n}\n\nint main(int argc, char **argv)\n{\n\tint msg, pid, err;\n\tstruct msgque_data msgque;\n\n\tif (getuid() != 0)\n\t\treturn ksft_exit_skip(\n\t\t\t\t\"Please run the test as root - Exiting.\\n\");\n\n\tmsgque.key = ftok(argv[0], 822155650);\n\tif (msgque.key == -1) {\n\t\tprintf(\"Can't make key: %d\\n\", -errno);\n\t\treturn ksft_exit_fail();\n\t}\n\n\tmsgque.msq_id = msgget(msgque.key, IPC_CREAT | IPC_EXCL | 0666);\n\tif (msgque.msq_id == -1) {\n\t\terr = -errno;\n\t\tprintf(\"Can't create queue: %d\\n\", err);\n\t\tgoto err_out;\n\t}\n\n\terr = fill_msgque(&msgque);\n\tif (err) {\n\t\tprintf(\"Failed to fill queue: %d\\n\", err);\n\t\tgoto err_destroy;\n\t}\n\n\terr = dump_queue(&msgque);\n\tif (err) {\n\t\tprintf(\"Failed to dump queue: %d\\n\", err);\n\t\tgoto err_destroy;\n\t}\n\n\terr = check_and_destroy_queue(&msgque);\n\tif (err) {\n\t\tprintf(\"Failed to check and destroy queue: %d\\n\", err);\n\t\tgoto err_out;\n\t}\n\n\terr = restore_queue(&msgque);\n\tif (err) {\n\t\tprintf(\"Failed to restore queue: %d\\n\", err);\n\t\tgoto err_destroy;\n\t}\n\n\terr = check_and_destroy_queue(&msgque);\n\tif (err) {\n\t\tprintf(\"Failed to test queue: %d\\n\", err);\n\t\tgoto err_out;\n\t}\n\treturn ksft_exit_pass();\n\nerr_destroy:\n\tif (msgctl(msgque.msq_id, IPC_RMID, NULL)) {\n\t\tprintf(\"Failed to destroy queue: %d\\n\", -errno);\n\t\treturn ksft_exit_fail();\n\t}\nerr_out:\n\treturn ksft_exit_fail();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}