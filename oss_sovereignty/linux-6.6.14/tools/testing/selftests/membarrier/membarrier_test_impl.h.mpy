{
  "module_name": "membarrier_test_impl.h",
  "hash_id": "1337d2a11be34546691ede12cb2d858ea6ab3889f59819f9e76bdf5b077677b3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/membarrier/membarrier_test_impl.h",
  "human_readable_source": " \n#define _GNU_SOURCE\n#include <linux/membarrier.h>\n#include <syscall.h>\n#include <stdio.h>\n#include <errno.h>\n#include <string.h>\n#include <pthread.h>\n\n#include \"../kselftest.h\"\n\nstatic int registrations;\n\nstatic int sys_membarrier(int cmd, int flags)\n{\n\treturn syscall(__NR_membarrier, cmd, flags);\n}\n\nstatic int test_membarrier_get_registrations(int cmd)\n{\n\tint ret, flags = 0;\n\tconst char *test_name =\n\t\t\"sys membarrier MEMBARRIER_CMD_GET_REGISTRATIONS\";\n\n\tregistrations |= cmd;\n\n\tret = sys_membarrier(MEMBARRIER_CMD_GET_REGISTRATIONS, 0);\n\tif (ret < 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t} else if (ret != registrations) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, ret = %d, registrations = %d\\n\",\n\t\t\ttest_name, flags, ret, registrations);\n\t}\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d, ret = %d, registrations = %d\\n\",\n\t\ttest_name, flags, ret, registrations);\n\n\treturn 0;\n}\n\nstatic int test_membarrier_cmd_fail(void)\n{\n\tint cmd = -1, flags = 0;\n\tconst char *test_name = \"sys membarrier invalid command\";\n\n\tif (sys_membarrier(cmd, flags) != -1) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: command = %d, flags = %d. Should fail, but passed\\n\",\n\t\t\ttest_name, cmd, flags);\n\t}\n\tif (errno != EINVAL) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should return (%d: \\\"%s\\\"), but returned (%d: \\\"%s\\\").\\n\",\n\t\t\ttest_name, flags, EINVAL, strerror(EINVAL),\n\t\t\terrno, strerror(errno));\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: command = %d, flags = %d, errno = %d. Failed as expected\\n\",\n\t\ttest_name, cmd, flags, errno);\n\treturn 0;\n}\n\nstatic int test_membarrier_flags_fail(void)\n{\n\tint cmd = MEMBARRIER_CMD_QUERY, flags = 1;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_QUERY invalid flags\";\n\n\tif (sys_membarrier(cmd, flags) != -1) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should fail, but passed\\n\",\n\t\t\ttest_name, flags);\n\t}\n\tif (errno != EINVAL) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should return (%d: \\\"%s\\\"), but returned (%d: \\\"%s\\\").\\n\",\n\t\t\ttest_name, flags, EINVAL, strerror(EINVAL),\n\t\t\terrno, strerror(errno));\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d, errno = %d. Failed as expected\\n\",\n\t\ttest_name, flags, errno);\n\treturn 0;\n}\n\nstatic int test_membarrier_global_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_GLOBAL, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_GLOBAL\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\", test_name, flags);\n\treturn 0;\n}\n\nstatic int test_membarrier_private_expedited_fail(void)\n{\n\tint cmd = MEMBARRIER_CMD_PRIVATE_EXPEDITED, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_PRIVATE_EXPEDITED not registered failure\";\n\n\tif (sys_membarrier(cmd, flags) != -1) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should fail, but passed\\n\",\n\t\t\ttest_name, flags);\n\t}\n\tif (errno != EPERM) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should return (%d: \\\"%s\\\"), but returned (%d: \\\"%s\\\").\\n\",\n\t\t\ttest_name, flags, EPERM, strerror(EPERM),\n\t\t\terrno, strerror(errno));\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\ttest_name, flags, errno);\n\treturn 0;\n}\n\nstatic int test_membarrier_register_private_expedited_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_REGISTER_PRIVATE_EXPEDITED, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_REGISTER_PRIVATE_EXPEDITED\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\",\n\t\ttest_name, flags);\n\n\ttest_membarrier_get_registrations(cmd);\n\treturn 0;\n}\n\nstatic int test_membarrier_private_expedited_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_PRIVATE_EXPEDITED, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_PRIVATE_EXPEDITED\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\",\n\t\ttest_name, flags);\n\treturn 0;\n}\n\nstatic int test_membarrier_private_expedited_sync_core_fail(void)\n{\n\tint cmd = MEMBARRIER_CMD_PRIVATE_EXPEDITED_SYNC_CORE, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_PRIVATE_EXPEDITED_SYNC_CORE not registered failure\";\n\n\tif (sys_membarrier(cmd, flags) != -1) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should fail, but passed\\n\",\n\t\t\ttest_name, flags);\n\t}\n\tif (errno != EPERM) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d. Should return (%d: \\\"%s\\\"), but returned (%d: \\\"%s\\\").\\n\",\n\t\t\ttest_name, flags, EPERM, strerror(EPERM),\n\t\t\terrno, strerror(errno));\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\ttest_name, flags, errno);\n\treturn 0;\n}\n\nstatic int test_membarrier_register_private_expedited_sync_core_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_REGISTER_PRIVATE_EXPEDITED_SYNC_CORE, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_REGISTER_PRIVATE_EXPEDITED_SYNC_CORE\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\",\n\t\ttest_name, flags);\n\n\ttest_membarrier_get_registrations(cmd);\n\treturn 0;\n}\n\nstatic int test_membarrier_private_expedited_sync_core_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_PRIVATE_EXPEDITED, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_PRIVATE_EXPEDITED_SYNC_CORE\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\",\n\t\ttest_name, flags);\n\treturn 0;\n}\n\nstatic int test_membarrier_register_global_expedited_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_REGISTER_GLOBAL_EXPEDITED, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_REGISTER_GLOBAL_EXPEDITED\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\",\n\t\ttest_name, flags);\n\n\ttest_membarrier_get_registrations(cmd);\n\treturn 0;\n}\n\nstatic int test_membarrier_global_expedited_success(void)\n{\n\tint cmd = MEMBARRIER_CMD_GLOBAL_EXPEDITED, flags = 0;\n\tconst char *test_name = \"sys membarrier MEMBARRIER_CMD_GLOBAL_EXPEDITED\";\n\n\tif (sys_membarrier(cmd, flags) != 0) {\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s test: flags = %d, errno = %d\\n\",\n\t\t\ttest_name, flags, errno);\n\t}\n\n\tksft_test_result_pass(\n\t\t\"%s test: flags = %d\\n\",\n\t\ttest_name, flags);\n\treturn 0;\n}\n\nstatic int test_membarrier_fail(void)\n{\n\tint status;\n\n\tstatus = test_membarrier_cmd_fail();\n\tif (status)\n\t\treturn status;\n\tstatus = test_membarrier_flags_fail();\n\tif (status)\n\t\treturn status;\n\tstatus = test_membarrier_private_expedited_fail();\n\tif (status)\n\t\treturn status;\n\tstatus = sys_membarrier(MEMBARRIER_CMD_QUERY, 0);\n\tif (status < 0) {\n\t\tksft_test_result_fail(\"sys_membarrier() failed\\n\");\n\t\treturn status;\n\t}\n\tif (status & MEMBARRIER_CMD_PRIVATE_EXPEDITED_SYNC_CORE) {\n\t\tstatus = test_membarrier_private_expedited_sync_core_fail();\n\t\tif (status)\n\t\t\treturn status;\n\t}\n\treturn 0;\n}\n\nstatic int test_membarrier_success(void)\n{\n\tint status;\n\n\tstatus = test_membarrier_global_success();\n\tif (status)\n\t\treturn status;\n\tstatus = test_membarrier_register_private_expedited_success();\n\tif (status)\n\t\treturn status;\n\tstatus = test_membarrier_private_expedited_success();\n\tif (status)\n\t\treturn status;\n\tstatus = sys_membarrier(MEMBARRIER_CMD_QUERY, 0);\n\tif (status < 0) {\n\t\tksft_test_result_fail(\"sys_membarrier() failed\\n\");\n\t\treturn status;\n\t}\n\tif (status & MEMBARRIER_CMD_PRIVATE_EXPEDITED_SYNC_CORE) {\n\t\tstatus = test_membarrier_register_private_expedited_sync_core_success();\n\t\tif (status)\n\t\t\treturn status;\n\t\tstatus = test_membarrier_private_expedited_sync_core_success();\n\t\tif (status)\n\t\t\treturn status;\n\t}\n\t \n\tstatus = test_membarrier_global_expedited_success();\n\tif (status)\n\t\treturn status;\n\tstatus = test_membarrier_register_global_expedited_success();\n\tif (status)\n\t\treturn status;\n\tstatus = test_membarrier_global_expedited_success();\n\tif (status)\n\t\treturn status;\n\treturn 0;\n}\n\nstatic int test_membarrier_query(void)\n{\n\tint flags = 0, ret;\n\n\tret = sys_membarrier(MEMBARRIER_CMD_QUERY, flags);\n\tif (ret < 0) {\n\t\tif (errno == ENOSYS) {\n\t\t\t \n\t\t\tksft_exit_skip(\n\t\t\t\t\"sys membarrier (CONFIG_MEMBARRIER) is disabled.\\n\");\n\t\t}\n\t\tksft_exit_fail_msg(\"sys_membarrier() failed\\n\");\n\t}\n\tif (!(ret & MEMBARRIER_CMD_GLOBAL))\n\t\tksft_exit_skip(\n\t\t\t\"sys_membarrier unsupported: CMD_GLOBAL not found.\\n\");\n\n\tksft_test_result_pass(\"sys_membarrier available\\n\");\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}