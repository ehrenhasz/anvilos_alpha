{
  "module_name": "cpu-on-off-test.sh",
  "hash_id": "63bb299dc531f787125ccf8f33962d3a0b76143fc895755f169012352150c41b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/cpu-hotplug/cpu-on-off-test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nSYSFS=\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\nretval=0\n\nprerequisite()\n{\n\tmsg=\"skip all tests:\"\n\n\tif [ $UID != 0 ]; then\n\t\techo $msg must be run as root >&2\n\t\texit $ksft_skip\n\tfi\n\n\ttaskset -p 01 $$\n\n\tSYSFS=`mount -t sysfs | head -1 | awk '{ print $3 }'`\n\n\tif [ ! -d \"$SYSFS\" ]; then\n\t\techo $msg sysfs is not mounted >&2\n\t\texit $ksft_skip\n\tfi\n\n\tif ! ls $SYSFS/devices/system/cpu/cpu* > /dev/null 2>&1; then\n\t\techo $msg cpu hotplug is not supported >&2\n\t\texit $ksft_skip\n\tfi\n\n\techo \"CPU online/offline summary:\"\n\tonline_cpus=`cat $SYSFS/devices/system/cpu/online`\n\tonline_max=${online_cpus##*-}\n\n\tif [[ \"$online_cpus\" = \"$online_max\" ]]; then\n\t\techo \"$msg: since there is only one cpu: $online_cpus\"\n\t\texit $ksft_skip\n\tfi\n\n\tpresent_cpus=`cat $SYSFS/devices/system/cpu/present`\n\tpresent_max=${present_cpus##*-}\n\techo \"present_cpus = $present_cpus present_max = $present_max\"\n\n\techo -e \"\\t Cpus in online state: $online_cpus\"\n\n\toffline_cpus=`cat $SYSFS/devices/system/cpu/offline`\n\tif [[ \"a$offline_cpus\" = \"a\" ]]; then\n\t\toffline_cpus=0\n\telse\n\t\toffline_max=${offline_cpus##*-}\n\tfi\n\techo -e \"\\t Cpus in offline state: $offline_cpus\"\n}\n\n#\n# list all hot-pluggable CPUs\n#\nhotpluggable_cpus()\n{\n\tlocal state=${1:-.\\*}\n\n\tfor cpu in $SYSFS/devices/system/cpu/cpu*; do\n\t\tif [ -f $cpu/online ] && grep -q $state $cpu/online; then\n\t\t\techo ${cpu##/*/cpu}\n\t\tfi\n\tdone\n}\n\nhotplaggable_offline_cpus()\n{\n\thotpluggable_cpus 0\n}\n\nhotpluggable_online_cpus()\n{\n\thotpluggable_cpus 1\n}\n\ncpu_is_online()\n{\n\tgrep -q 1 $SYSFS/devices/system/cpu/cpu$1/online\n}\n\ncpu_is_offline()\n{\n\tgrep -q 0 $SYSFS/devices/system/cpu/cpu$1/online\n}\n\nonline_cpu()\n{\n\techo 1 > $SYSFS/devices/system/cpu/cpu$1/online\n}\n\noffline_cpu()\n{\n\techo 0 > $SYSFS/devices/system/cpu/cpu$1/online\n}\n\nonline_cpu_expect_success()\n{\n\tlocal cpu=$1\n\n\tif ! online_cpu $cpu; then\n\t\techo $FUNCNAME $cpu: unexpected fail >&2\n\t\tretval=1\n\telif ! cpu_is_online $cpu; then\n\t\techo $FUNCNAME $cpu: unexpected offline >&2\n\t\tretval=1\n\tfi\n}\n\nonline_cpu_expect_fail()\n{\n\tlocal cpu=$1\n\n\tif online_cpu $cpu 2> /dev/null; then\n\t\techo $FUNCNAME $cpu: unexpected success >&2\n\t\tretval=1\n\telif ! cpu_is_offline $cpu; then\n\t\techo $FUNCNAME $cpu: unexpected online >&2\n\t\tretval=1\n\tfi\n}\n\noffline_cpu_expect_success()\n{\n\tlocal cpu=$1\n\n\tif ! offline_cpu $cpu; then\n\t\techo $FUNCNAME $cpu: unexpected fail >&2\n\t\tretval=1\n\telif ! cpu_is_offline $cpu; then\n\t\techo $FUNCNAME $cpu: unexpected offline >&2\n\t\tretval=1\n\tfi\n}\n\noffline_cpu_expect_fail()\n{\n\tlocal cpu=$1\n\n\tif offline_cpu $cpu 2> /dev/null; then\n\t\techo $FUNCNAME $cpu: unexpected success >&2\n\t\tretval=1\n\telif ! cpu_is_online $cpu; then\n\t\techo $FUNCNAME $cpu: unexpected offline >&2\n\t\tretval=1\n\tfi\n}\n\nonline_all_hot_pluggable_cpus()\n{\n\tfor cpu in `hotplaggable_offline_cpus`; do\n\t\tonline_cpu_expect_success $cpu\n\tdone\n}\n\noffline_all_hot_pluggable_cpus()\n{\n\tlocal reserve_cpu=$online_max\n\tfor cpu in `hotpluggable_online_cpus`; do\n\t\t# Reserve one cpu oneline at least.\n\t\tif [ $cpu -eq $reserve_cpu ];then\n\t\t\tcontinue\n\t\tfi\n\t\toffline_cpu_expect_success $cpu\n\tdone\n}\n\nallcpus=0\nonline_cpus=0\nonline_max=0\noffline_cpus=0\noffline_max=0\npresent_cpus=0\npresent_max=0\n\nwhile getopts ah opt; do\n\tcase $opt in\n\ta)\n\t\tallcpus=1\n\t\t;;\n\th)\n\t\techo \"Usage $0 [ -a ]\"\n\t\techo -e \"\\t default offline one cpu\"\n\t\techo -e \"\\t run with -a option to offline all cpus\"\n\t\texit\n\t\t;;\n\tesac\ndone\n\nprerequisite\n\n#\n# Safe test (default) - offline and online one cpu\n#\nif [ $allcpus -eq 0 ]; then\n\techo \"Limited scope test: one hotplug cpu\"\n\techo -e \"\\t (leaves cpu in the original state):\"\n\techo -e \"\\t online to offline to online: cpu $online_max\"\n\toffline_cpu_expect_success $online_max\n\tonline_cpu_expect_success $online_max\n\n\tif [[ $offline_cpus -gt 0 ]]; then\n\t\techo -e \"\\t online to offline to online: cpu $present_max\"\n\t\tonline_cpu_expect_success $present_max\n\t\toffline_cpu_expect_success $present_max\n\t\tonline_cpu $present_max\n\tfi\n\texit $retval\nelse\n\techo \"Full scope test: all hotplug cpus\"\n\techo -e \"\\t online all offline cpus\"\n\techo -e \"\\t offline all online cpus\"\n\techo -e \"\\t online all offline cpus\"\nfi\n\nonline_all_hot_pluggable_cpus\n\noffline_all_hot_pluggable_cpus\n\nonline_all_hot_pluggable_cpus\n\nexit $retval\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}