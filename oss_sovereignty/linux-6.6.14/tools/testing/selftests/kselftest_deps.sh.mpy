{
  "module_name": "kselftest_deps.sh",
  "hash_id": "a95765e3734f3021a8dbc4012a91ea3ad0359c939b6952f1c5b23a99daa94882",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kselftest_deps.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n# kselftest_deps.sh\n#\n# Checks for kselftest build dependencies on the build system.\n# Copyright (c) 2020 Shuah Khan <skhan@linuxfoundation.org>\n#\n#\n\nusage()\n{\n\necho -e \"Usage: $0 -[p] <compiler> [test_name]\\n\"\necho -e \"\\tkselftest_deps.sh [-p] gcc\"\necho -e \"\\tkselftest_deps.sh [-p] gcc mm\"\necho -e \"\\tkselftest_deps.sh [-p] aarch64-linux-gnu-gcc\"\necho -e \"\\tkselftest_deps.sh [-p] aarch64-linux-gnu-gcc mm\\n\"\necho \"- Should be run in selftests directory in the kernel repo.\"\necho \"- Checks if Kselftests can be built/cross-built on a system.\"\necho \"- Parses all test/sub-test Makefile to find library dependencies.\"\necho \"- Runs compile test on a trivial C file with LDLIBS specified\"\necho \"  in the test Makefiles to identify missing library dependencies.\"\necho \"- Prints suggested target list for a system filtering out tests\"\necho \"  failed the build dependency check from the TARGETS in Selftests\"\necho \"  main Makefile when optional -p is specified.\"\necho \"- Prints pass/fail dependency check for each tests/sub-test.\"\necho \"- Prints pass/fail targets and libraries.\"\necho \"- Default: runs dependency checks on all tests.\"\necho \"- Optional: test name can be specified to check dependencies for it.\"\nexit 1\n\n}\n\n# Start main()\nmain()\n{\n\nbase_dir=`pwd`\n# Make sure we're in the selftests top-level directory.\nif [ $(basename \"$base_dir\") !=  \"selftests\" ]; then\n\techo -e \"\\tPlease run $0 in\"\n\techo -e \"\\ttools/testing/selftests directory ...\"\n\texit 1\nfi\n\nprint_targets=0\n\nwhile getopts \"p\" arg; do\n\tcase $arg in\n\t\tp)\n\t\tprint_targets=1\n\tshift;;\n\tesac\ndone\n\nif [ $# -eq 0 ]\nthen\n\tusage\nfi\n\n# Compiler\nCC=$1\n\ntmp_file=$(mktemp).c\ntrap \"rm -f $tmp_file.o $tmp_file $tmp_file.bin\" EXIT\n#echo $tmp_file\n\npass=$(mktemp).out\ntrap \"rm -f $pass\" EXIT\n#echo $pass\n\nfail=$(mktemp).out\ntrap \"rm -f $fail\" EXIT\n#echo $fail\n\n# Generate tmp source fire for compile test\ncat << \"EOF\" > $tmp_file\nint main()\n{\n}\nEOF\n\n# Save results\ntotal_cnt=0\nfail_trgts=()\nfail_libs=()\nfail_cnt=0\npass_trgts=()\npass_libs=()\npass_cnt=0\n\n# Get all TARGETS from selftests Makefile\ntargets=$(grep -E \"^TARGETS +|^TARGETS =\" Makefile | cut -d \"=\" -f2)\n\n# Initially, in LDLIBS related lines, the dep checker needs\n# to ignore lines containing the following strings:\nfilter=\"\\$(VAR_LDLIBS)\\|pkg-config\\|PKG_CONFIG\\|IOURING_EXTRA_LIBS\"\n\n# Single test case\nif [ $# -eq 2 ]\nthen\n\ttest=$2/Makefile\n\n\tl1_test $test\n\tl2_test $test\n\tl3_test $test\n\tl4_test $test\n\tl5_test $test\n\n\tprint_results $1 $2\n\texit $?\nfi\n\n# Level 1: LDLIBS set static.\n#\n# Find all LDLIBS set statically for all executables built by a Makefile\n# and filter out VAR_LDLIBS to discard the following:\n# \tgpio/Makefile:LDLIBS += $(VAR_LDLIBS)\n# Append space at the end of the list to append more tests.\n\nl1_tests=$(grep -r --include=Makefile \"^LDLIBS\" | \\\n\t\tgrep -v \"$filter\" | awk -F: '{print $1}' | uniq)\n\n# Level 2: LDLIBS set dynamically.\n#\n# Level 2\n# Some tests have multiple valid LDLIBS lines for individual sub-tests\n# that need dependency checks. Find them and append them to the tests\n# e.g: mm/Makefile:$(OUTPUT)/userfaultfd: LDLIBS += -lpthread\n# Filter out VAR_LDLIBS to discard the following:\n# \tmemfd/Makefile:$(OUTPUT)/fuse_mnt: LDLIBS += $(VAR_LDLIBS)\n# Append space at the end of the list to append more tests.\n\nl2_tests=$(grep -r --include=Makefile \": LDLIBS\" | \\\n\t\tgrep -v \"$filter\" | awk -F: '{print $1}' | uniq)\n\n# Level 3\n# memfd and others use pkg-config to find mount and fuse libs\n# respectively and save it in VAR_LDLIBS. If pkg-config doesn't find\n# any, VAR_LDLIBS set to default.\n# Use the default value and filter out pkg-config for dependency check.\n# e.g:\n# memfd/Makefile\n#\tVAR_LDLIBS := $(shell pkg-config fuse --libs 2>/dev/null)\n\nl3_tests=$(grep -r --include=Makefile \"^VAR_LDLIBS\" | \\\n\t\tgrep -v \"pkg-config\\|PKG_CONFIG\" | awk -F: '{print $1}' | uniq)\n\n# Level 4\n# some tests may fall back to default using `|| echo -l<libname>`\n# if pkg-config doesn't find the libs, instead of using VAR_LDLIBS\n# as per level 3 checks.\n# e.g:\n# netfilter/Makefile\n#\tLDLIBS += $(shell $(HOSTPKG_CONFIG) --libs libmnl 2>/dev/null || echo -lmnl)\nl4_tests=$(grep -r --include=Makefile \"^LDLIBS\" | \\\n\t\tgrep \"pkg-config\\|PKG_CONFIG\" | awk -F: '{print $1}' | uniq)\n\n# Level 5\n# some tests may use IOURING_EXTRA_LIBS to add extra libs to LDLIBS,\n# which in turn may be defined in a sub-Makefile\n# e.g.:\n# mm/Makefile\n#\t$(OUTPUT)/gup_longterm: LDLIBS += $(IOURING_EXTRA_LIBS)\nl5_tests=$(grep -r --include=Makefile \"LDLIBS +=.*\\$(IOURING_EXTRA_LIBS)\" | \\\n\tawk -F: '{print $1}' | uniq)\n\n#echo l1_tests $l1_tests\n#echo l2_tests $l2_tests\n#echo l3_tests $l3_tests\n#echo l4_tests $l4_tests\n#echo l5_tests $l5_tests\n\nall_tests\nprint_results $1 $2\n\nexit $?\n}\n# end main()\n\nall_tests()\n{\n\tfor test in $l1_tests; do\n\t\tl1_test $test\n\tdone\n\n\tfor test in $l2_tests; do\n\t\tl2_test $test\n\tdone\n\n\tfor test in $l3_tests; do\n\t\tl3_test $test\n\tdone\n\n\tfor test in $l4_tests; do\n\t\tl4_test $test\n\tdone\n\n\tfor test in $l5_tests; do\n\t\tl5_test $test\n\tdone\n}\n\n# Use same parsing used for l1_tests and pick libraries this time.\nl1_test()\n{\n\ttest_libs=$(grep --include=Makefile \"^LDLIBS\" $test | \\\n\t\t\tgrep -v \"$filter\" | \\\n\t\t\tsed -e 's/\\:/ /' | \\\n\t\t\tsed -e 's/+/ /' | cut -d \"=\" -f 2)\n\n\tcheck_libs $test $test_libs\n}\n\n# Use same parsing used for l2_tests and pick libraries this time.\nl2_test()\n{\n\ttest_libs=$(grep --include=Makefile \": LDLIBS\" $test | \\\n\t\t\tgrep -v \"$filter\" | \\\n\t\t\tsed -e 's/\\:/ /' | sed -e 's/+/ /' | \\\n\t\t\tcut -d \"=\" -f 2)\n\n\tcheck_libs $test $test_libs\n}\n\nl3_test()\n{\n\ttest_libs=$(grep --include=Makefile \"^VAR_LDLIBS\" $test | \\\n\t\t\tgrep -v \"pkg-config\" | sed -e 's/\\:/ /' |\n\t\t\tsed -e 's/+/ /' | cut -d \"=\" -f 2)\n\n\tcheck_libs $test $test_libs\n}\n\nl4_test()\n{\n\ttest_libs=$(grep --include=Makefile \"^VAR_LDLIBS\\|^LDLIBS\" $test | \\\n\t\t\tgrep \"\\(pkg-config\\|PKG_CONFIG\\).*|| echo \" | \\\n\t\t\tsed -e 's/.*|| echo //' | sed -e 's/)$//')\n\n\tcheck_libs $test $test_libs\n}\n\nl5_test()\n{\n\ttests=$(find $(dirname \"$test\") -type f -name \"*.mk\")\n\ttest_libs=$(grep \"^IOURING_EXTRA_LIBS +\\?=\" $tests | \\\n\t\t\tcut -d \"=\" -f 2)\n\n\tcheck_libs $test $test_libs\n}\n\ncheck_libs()\n{\n\nif [[ ! -z \"${test_libs// }\" ]]\nthen\n\n\t#echo $test_libs\n\n\tfor lib in $test_libs; do\n\n\tlet total_cnt+=1\n\t$CC -o $tmp_file.bin $lib $tmp_file > /dev/null 2>&1\n\tif [ $? -ne 0 ]; then\n\t\techo \"FAIL: $test dependency check: $lib\" >> $fail\n\t\tlet fail_cnt+=1\n\t\tfail_libs+=\"$lib \"\n\t\tfail_target=$(echo \"$test\" | cut -d \"/\" -f1)\n\t\tfail_trgts+=\"$fail_target \"\n\t\ttargets=$(echo \"$targets\" | grep -v \"$fail_target\")\n\telse\n\t\techo \"PASS: $test dependency check passed $lib\" >> $pass\n\t\tlet pass_cnt+=1\n\t\tpass_libs+=\"$lib \"\n\t\tpass_trgts+=\"$(echo \"$test\" | cut -d \"/\" -f1) \"\n\tfi\n\n\tdone\nfi\n}\n\nprint_results()\n{\n\techo -e \"========================================================\";\n\techo -e \"Kselftest Dependency Check for [$0 $1 $2] results...\"\n\n\tif [ $print_targets -ne 0 ]\n\tthen\n\techo -e \"Suggested Selftest Targets for your configuration:\"\n\techo -e \"$targets\";\n\tfi\n\n\techo -e \"========================================================\";\n\techo -e \"Checked tests defining LDLIBS dependencies\"\n\techo -e \"--------------------------------------------------------\";\n\techo -e \"Total tests with Dependencies:\"\n\techo -e \"$total_cnt Pass: $pass_cnt Fail: $fail_cnt\";\n\n\tif [ $pass_cnt -ne 0 ]; then\n\techo -e \"--------------------------------------------------------\";\n\tcat $pass\n\techo -e \"--------------------------------------------------------\";\n\techo -e \"Targets passed build dependency check on system:\"\n\techo -e \"$(echo \"$pass_trgts\" | xargs -n1 | sort -u | xargs)\"\n\tfi\n\n\tif [ $fail_cnt -ne 0 ]; then\n\techo -e \"--------------------------------------------------------\";\n\tcat $fail\n\techo -e \"--------------------------------------------------------\";\n\techo -e \"Targets failed build dependency check on system:\"\n\techo -e \"$(echo \"$fail_trgts\" | xargs -n1 | sort -u | xargs)\"\n\techo -e \"--------------------------------------------------------\";\n\techo -e \"Missing libraries system\"\n\techo -e \"$(echo \"$fail_libs\" | xargs -n1 | sort -u | xargs)\"\n\tfi\n\n\techo -e \"--------------------------------------------------------\";\n\techo -e \"========================================================\";\n}\n\nmain \"$@\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}