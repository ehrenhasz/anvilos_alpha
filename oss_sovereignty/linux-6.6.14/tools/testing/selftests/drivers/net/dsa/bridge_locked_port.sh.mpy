{
  "module_name": "bridge_locked_port.sh",
  "hash_id": "b7930ec5c6f408067797d244a46bd63b29c7afc69d3e8acc1355130253ec2e69",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/dsa/bridge_locked_port.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"\n\tlocked_port_ipv4\n\tlocked_port_ipv6\n\tlocked_port_vlan\n\tlocked_port_mab\n\tlocked_port_mab_roam\n\tlocked_port_mab_config\n\tlocked_port_mab_flush\n\tlocked_port_mab_redirect\n\"\n\nNUM_NETIFS=4\nCHECK_TC=\"no\"\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24 2001:db8:1::1/64\n\tvlan_create $h1 100 v$h1 198.51.100.1/24\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 100\n\tsimple_if_fini $h1 192.0.2.1/24 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/24 2001:db8:1::2/64\n\tvlan_create $h2 100 v$h2 198.51.100.2/24\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 100\n\tsimple_if_fini $h2 192.0.2.2/24 2001:db8:1::2/64\n}\n\nswitch_create()\n{\n\tip link add dev br0 type bridge vlan_filtering 1\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp2 master br0\n\n\tbridge link set dev $swp1 learning off\n\n\tip link set dev br0 up\n\tip link set dev $swp1 up\n\tip link set dev $swp2 up\n}\n\nswitch_destroy()\n{\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n\n\tip link del dev br0\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nlocked_port_ipv4()\n{\n\tRET=0\n\n\tcheck_locked_port_support || return 0\n\n\tping_do $h1 192.0.2.2\n\tcheck_err $? \"Ping did not work before locking port\"\n\n\tbridge link set dev $swp1 locked on\n\n\tping_do $h1 192.0.2.2\n\tcheck_fail $? \"Ping worked after locking port, but before adding FDB entry\"\n\n\tbridge fdb add `mac_get $h1` dev $swp1 master static\n\n\tping_do $h1 192.0.2.2\n\tcheck_err $? \"Ping did not work after locking port and adding FDB entry\"\n\n\tbridge link set dev $swp1 locked off\n\tbridge fdb del `mac_get $h1` dev $swp1 master static\n\n\tping_do $h1 192.0.2.2\n\tcheck_err $? \"Ping did not work after unlocking port and removing FDB entry.\"\n\n\tlog_test \"Locked port ipv4\"\n}\n\nlocked_port_vlan()\n{\n\tRET=0\n\n\tcheck_locked_port_support || return 0\n\n\tbridge vlan add vid 100 dev $swp1\n\tbridge vlan add vid 100 dev $swp2\n\n\tping_do $h1.100 198.51.100.2\n\tcheck_err $? \"Ping through vlan did not work before locking port\"\n\n\tbridge link set dev $swp1 locked on\n\tping_do $h1.100 198.51.100.2\n\tcheck_fail $? \"Ping through vlan worked after locking port, but before adding FDB entry\"\n\n\tbridge fdb add `mac_get $h1` dev $swp1 vlan 100 master static\n\n\tping_do $h1.100 198.51.100.2\n\tcheck_err $? \"Ping through vlan did not work after locking port and adding FDB entry\"\n\n\tbridge link set dev $swp1 locked off\n\tbridge fdb del `mac_get $h1` dev $swp1 vlan 100 master static\n\n\tping_do $h1.100 198.51.100.2\n\tcheck_err $? \"Ping through vlan did not work after unlocking port and removing FDB entry\"\n\n\tbridge vlan del vid 100 dev $swp1\n\tbridge vlan del vid 100 dev $swp2\n\tlog_test \"Locked port vlan\"\n}\n\nlocked_port_ipv6()\n{\n\tRET=0\n\tcheck_locked_port_support || return 0\n\n\tping6_do $h1 2001:db8:1::2\n\tcheck_err $? \"Ping6 did not work before locking port\"\n\n\tbridge link set dev $swp1 locked on\n\n\tping6_do $h1 2001:db8:1::2\n\tcheck_fail $? \"Ping6 worked after locking port, but before adding FDB entry\"\n\n\tbridge fdb add `mac_get $h1` dev $swp1 master static\n\tping6_do $h1 2001:db8:1::2\n\tcheck_err $? \"Ping6 did not work after locking port and adding FDB entry\"\n\n\tbridge link set dev $swp1 locked off\n\tbridge fdb del `mac_get $h1` dev $swp1 master static\n\n\tping6_do $h1 2001:db8:1::2\n\tcheck_err $? \"Ping6 did not work after unlocking port and removing FDB entry\"\n\n\tlog_test \"Locked port ipv6\"\n}\n\nlocked_port_mab()\n{\n\tRET=0\n\tcheck_port_mab_support || return 0\n\n\tping_do $h1 192.0.2.2\n\tcheck_err $? \"Ping did not work before locking port\"\n\n\tbridge link set dev $swp1 learning on locked on\n\n\tping_do $h1 192.0.2.2\n\tcheck_fail $? \"Ping worked on a locked port without an FDB entry\"\n\n\tbridge fdb get `mac_get $h1` br br0 vlan 1 &> /dev/null\n\tcheck_fail $? \"FDB entry created before enabling MAB\"\n\n\tbridge link set dev $swp1 learning on locked on mab on\n\n\tping_do $h1 192.0.2.2\n\tcheck_fail $? \"Ping worked on MAB enabled port without an FDB entry\"\n\n\tbridge fdb get `mac_get $h1` br br0 vlan 1 | grep \"dev $swp1\" | grep -q \"locked\"\n\tcheck_err $? \"Locked FDB entry not created\"\n\n\tbridge fdb replace `mac_get $h1` dev $swp1 master static\n\n\tping_do $h1 192.0.2.2\n\tcheck_err $? \"Ping did not work after replacing FDB entry\"\n\n\tbridge fdb get `mac_get $h1` br br0 vlan 1 | grep \"dev $swp1\" | grep -q \"locked\"\n\tcheck_fail $? \"FDB entry marked as locked after replacement\"\n\n\tbridge fdb del `mac_get $h1` dev $swp1 master\n\tbridge link set dev $swp1 learning off locked off mab off\n\n\tlog_test \"Locked port MAB\"\n}\n\n# Check that entries cannot roam to a locked port, but that entries can roam\n# to an unlocked port.\nlocked_port_mab_roam()\n{\n\tlocal mac=a0:b0:c0:c0:b0:a0\n\n\tRET=0\n\tcheck_port_mab_support || return 0\n\n\tbridge link set dev $swp1 learning on locked on mab on\n\n\t$MZ $h1 -q -c 5 -d 100msec -t udp -a $mac -b rand\n\tbridge fdb get $mac br br0 vlan 1 | grep \"dev $swp1\" | grep -q \"locked\"\n\tcheck_err $? \"No locked entry on first injection\"\n\n\t$MZ $h2 -q -c 5 -d 100msec -t udp -a $mac -b rand\n\tbridge fdb get $mac br br0 vlan 1 | grep -q \"dev $swp2\"\n\tcheck_err $? \"Entry did not roam to an unlocked port\"\n\n\tbridge fdb get $mac br br0 vlan 1 | grep -q \"locked\"\n\tcheck_fail $? \"Entry roamed with locked flag on\"\n\n\t$MZ $h1 -q -c 5 -d 100msec -t udp -a $mac -b rand\n\tbridge fdb get $mac br br0 vlan 1 | grep -q \"dev $swp1\"\n\tcheck_fail $? \"Entry roamed back to locked port\"\n\n\tbridge fdb del $mac vlan 1 dev $swp2 master\n\tbridge link set dev $swp1 learning off locked off mab off\n\n\tlog_test \"Locked port MAB roam\"\n}\n\n# Check that MAB can only be enabled on a port that is both locked and has\n# learning enabled.\nlocked_port_mab_config()\n{\n\tRET=0\n\tcheck_port_mab_support || return 0\n\n\tbridge link set dev $swp1 learning on locked off mab on &> /dev/null\n\tcheck_fail $? \"MAB enabled while port is unlocked\"\n\n\tbridge link set dev $swp1 learning off locked on mab on &> /dev/null\n\tcheck_fail $? \"MAB enabled while port has learning disabled\"\n\n\tbridge link set dev $swp1 learning on locked on mab on\n\tcheck_err $? \"Failed to enable MAB when port is locked and has learning enabled\"\n\n\tbridge link set dev $swp1 learning off locked off mab off\n\n\tlog_test \"Locked port MAB configuration\"\n}\n\n# Check that locked FDB entries are flushed from a port when MAB is disabled.\nlocked_port_mab_flush()\n{\n\tlocal locked_mac1=00:01:02:03:04:05\n\tlocal unlocked_mac1=00:01:02:03:04:06\n\tlocal locked_mac2=00:01:02:03:04:07\n\tlocal unlocked_mac2=00:01:02:03:04:08\n\n\tRET=0\n\tcheck_port_mab_support || return 0\n\n\tbridge link set dev $swp1 learning on locked on mab on\n\tbridge link set dev $swp2 learning on locked on mab on\n\n\t# Create regular and locked FDB entries on each port.\n\tbridge fdb add $unlocked_mac1 dev $swp1 vlan 1 master static\n\tbridge fdb add $unlocked_mac2 dev $swp2 vlan 1 master static\n\n\t$MZ $h1 -q -c 5 -d 100msec -t udp -a $locked_mac1 -b rand\n\tbridge fdb get $locked_mac1 br br0 vlan 1 | grep \"dev $swp1\" | \\\n\t\tgrep -q \"locked\"\n\tcheck_err $? \"Failed to create locked FDB entry on first port\"\n\n\t$MZ $h2 -q -c 5 -d 100msec -t udp -a $locked_mac2 -b rand\n\tbridge fdb get $locked_mac2 br br0 vlan 1 | grep \"dev $swp2\" | \\\n\t\tgrep -q \"locked\"\n\tcheck_err $? \"Failed to create locked FDB entry on second port\"\n\n\t# Disable MAB on the first port and check that only the first locked\n\t# FDB entry was flushed.\n\tbridge link set dev $swp1 mab off\n\n\tbridge fdb get $unlocked_mac1 br br0 vlan 1 &> /dev/null\n\tcheck_err $? \"Regular FDB entry on first port was flushed after disabling MAB\"\n\n\tbridge fdb get $unlocked_mac2 br br0 vlan 1 &> /dev/null\n\tcheck_err $? \"Regular FDB entry on second port was flushed after disabling MAB\"\n\n\tbridge fdb get $locked_mac1 br br0 vlan 1 &> /dev/null\n\tcheck_fail $? \"Locked FDB entry on first port was not flushed after disabling MAB\"\n\n\tbridge fdb get $locked_mac2 br br0 vlan 1 &> /dev/null\n\tcheck_err $? \"Locked FDB entry on second port was flushed after disabling MAB\"\n\n\tbridge fdb del $unlocked_mac2 dev $swp2 vlan 1 master static\n\tbridge fdb del $unlocked_mac1 dev $swp1 vlan 1 master static\n\n\tbridge link set dev $swp2 learning on locked off mab off\n\tbridge link set dev $swp1 learning off locked off mab off\n\n\tlog_test \"Locked port MAB FDB flush\"\n}\n\n# Check that traffic can be redirected from a locked bridge port and that it\n# does not create locked FDB entries.\nlocked_port_mab_redirect()\n{\n\tRET=0\n\tcheck_port_mab_support || return 0\n\n\tbridge link set dev $swp1 learning on locked on mab on\n\ttc qdisc add dev $swp1 clsact\n\ttc filter add dev $swp1 ingress protocol all pref 1 handle 101 flower \\\n\t\taction mirred egress redirect dev $swp2\n\n\tping_do $h1 192.0.2.2\n\tcheck_err $? \"Ping did not work with redirection\"\n\n\tbridge fdb get `mac_get $h1` br br0 vlan 1 2> /dev/null | \\\n\t\tgrep \"dev $swp1\" | grep -q \"locked\"\n\tcheck_fail $? \"Locked entry created for redirected traffic\"\n\n\ttc filter del dev $swp1 ingress protocol all pref 1 handle 101 flower\n\n\tping_do $h1 192.0.2.2\n\tcheck_fail $? \"Ping worked without redirection\"\n\n\tbridge fdb get `mac_get $h1` br br0 vlan 1 2> /dev/null | \\\n\t\tgrep \"dev $swp1\" | grep -q \"locked\"\n\tcheck_err $? \"Locked entry not created after deleting filter\"\n\n\tbridge fdb del `mac_get $h1` vlan 1 dev $swp1 master\n\ttc qdisc del dev $swp1 clsact\n\tbridge link set dev $swp1 learning off locked off mab off\n\n\tlog_test \"Locked port MAB redirect\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}