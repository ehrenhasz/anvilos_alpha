{
  "module_name": "tc_flower_chains.sh",
  "hash_id": "301b0543b89bf0a99db4fbb13d1d1ae089d3ace34b7bdb6f4a069c40cc2e59bf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/ocelot/tc_flower_chains.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n# Copyright 2020 NXP\n\nWAIT_TIME=1\nNUM_NETIFS=4\nSTABLE_MAC_ADDRS=yes\nlib_dir=$(dirname $0)/../../../net/forwarding\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\n\nrequire_command tcpdump\n\nh1=${NETIFS[p1]}\nswp1=${NETIFS[p2]}\nswp2=${NETIFS[p3]}\nh2=${NETIFS[p4]}\n\n# Helpers to map a VCAP IS1 and VCAP IS2 lookup and policy to a chain number\n# used by the kernel driver. The numbers are:\n# VCAP IS1 lookup 0:            10000\n# VCAP IS1 lookup 1:            11000\n# VCAP IS1 lookup 2:            12000\n# VCAP IS2 lookup 0 policy 0:   20000\n# VCAP IS2 lookup 0 policy 1:   20001\n# VCAP IS2 lookup 0 policy 255: 20255\n# VCAP IS2 lookup 1 policy 0:   21000\n# VCAP IS2 lookup 1 policy 1:   21001\n# VCAP IS2 lookup 1 policy 255: 21255\nIS1()\n{\n\tlocal lookup=$1\n\n\techo $((10000 + 1000 * lookup))\n}\n\nIS2()\n{\n\tlocal lookup=$1\n\tlocal pag=$2\n\n\techo $((20000 + 1000 * lookup + pag))\n}\n\nES0()\n{\n\techo 0\n}\n\n# The Ocelot switches have a fixed ingress pipeline composed of:\n#\n# +----------------------------------------------+      +-----------------------------------------+\n# |                   VCAP IS1                   |      |                  VCAP IS2               |\n# |                                              |      |                                         |\n# | +----------+    +----------+    +----------+ |      |            +----------+    +----------+ |\n# | | Lookup 0 |    | Lookup 1 |    | Lookup 2 | | --+------> PAG 0: | Lookup 0 | -> | Lookup 1 | |\n# | +----------+ -> +----------+ -> +----------+ |   |  |            +----------+    +----------+ |\n# | |key&action|    |key&action|    |key&action| |   |  |            |key&action|    |key&action| |\n# | |key&action|    |key&action|    |key&action| |   |  |            |    ..    |    |    ..    | |\n# | |    ..    |    |    ..    |    |    ..    | |   |  |            +----------+    +----------+ |\n# | +----------+    +----------+    +----------+ |   |  |                                         |\n# |                                 selects PAG  |   |  |            +----------+    +----------+ |\n# +----------------------------------------------+   +------> PAG 1: | Lookup 0 | -> | Lookup 1 | |\n#                                                    |  |            +----------+    +----------+ |\n#                                                    |  |            |key&action|    |key&action| |\n#                                                    |  |            |    ..    |    |    ..    | |\n#                                                    |  |            +----------+    +----------+ |\n#                                                    |  |      ...                                |\n#                                                    |  |                                         |\n#                                                    |  |            +----------+    +----------+ |\n#                                                    +----> PAG 254: | Lookup 0 | -> | Lookup 1 | |\n#                                                    |  |            +----------+    +----------+ |\n#                                                    |  |            |key&action|    |key&action| |\n#                                                    |  |            |    ..    |    |    ..    | |\n#                                                    |  |            +----------+    +----------+ |\n#                                                    |  |                                         |\n#                                                    |  |            +----------+    +----------+ |\n#                                                    +----> PAG 255: | Lookup 0 | -> | Lookup 1 | |\n#                                                       |            +----------+    +----------+ |\n#                                                       |            |key&action|    |key&action| |\n#                                                       |            |    ..    |    |    ..    | |\n#                                                       |            +----------+    +----------+ |\n#                                                       +-----------------------------------------+\n#\n# Both the VCAP IS1 (Ingress Stage 1) and IS2 (Ingress Stage 2) are indexed\n# (looked up) multiple times: IS1 3 times, and IS2 2 times. Each filter\n# (key and action pair) can be configured to only match during the first, or\n# second, etc, lookup.\n#\n# During one TCAM lookup, the filter processing stops at the first entry that\n# matches, then the pipeline jumps to the next lookup.\n# The driver maps each individual lookup of each individual ingress TCAM to a\n# separate chain number. For correct rule offloading, it is mandatory that each\n# filter installed in one TCAM is terminated by a non-optional GOTO action to\n# the next lookup from the fixed pipeline.\n#\n# A chain can only be used if there is a GOTO action correctly set up from the\n# prior lookup in the processing pipeline. Setting up all chains is not\n# mandatory.\n\n# NOTE: VCAP IS1 currently uses only S1_NORMAL half keys and VCAP IS2\n# dynamically chooses between MAC_ETYPE, ARP, IP4_TCP_UDP, IP4_OTHER, which are\n# all half keys as well.\n\ncreate_tcam_skeleton()\n{\n\tlocal eth=$1\n\n\ttc qdisc add dev $eth clsact\n\n\t# VCAP IS1 is the Ingress Classification TCAM and can offload the\n\t# following actions:\n\t# - skbedit priority\n\t# - vlan pop\n\t# - vlan modify\n\t# - goto (only in lookup 2, the last IS1 lookup)\n\ttc filter add dev $eth ingress chain 0 pref 49152 flower \\\n\t\tskip_sw action goto chain $(IS1 0)\n\ttc filter add dev $eth ingress chain $(IS1 0) pref 49152 \\\n\t\tflower skip_sw action goto chain $(IS1 1)\n\ttc filter add dev $eth ingress chain $(IS1 1) pref 49152 \\\n\t\tflower skip_sw action goto chain $(IS1 2)\n\ttc filter add dev $eth ingress chain $(IS1 2) pref 49152 \\\n\t\tflower skip_sw action goto chain $(IS2 0 0)\n\n\t# VCAP IS2 is the Security Enforcement ingress TCAM and can offload the\n\t# following actions:\n\t# - trap\n\t# - drop\n\t# - police\n\t# The two VCAP IS2 lookups can be segmented into up to 256 groups of\n\t# rules, called Policies. A Policy is selected through the Policy\n\t# Association Group (PAG) action of VCAP IS1 (which is the\n\t# GOTO offload).\n\ttc filter add dev $eth ingress chain $(IS2 0 0) pref 49152 \\\n\t\tflower skip_sw action goto chain $(IS2 1 0)\n}\n\nsetup_prepare()\n{\n\tip link set $swp1 up\n\tip link set $swp2 up\n\tip link set $h2 up\n\tip link set $h1 up\n\n\tcreate_tcam_skeleton $swp1\n\n\tip link add br0 type bridge\n\tip link set $swp1 master br0\n\tip link set $swp2 master br0\n\tip link set br0 up\n\n\tip link add link $h1 name $h1.100 type vlan id 100\n\tip link set $h1.100 up\n\n\tip link add link $h1 name $h1.200 type vlan id 200\n\tip link set $h1.200 up\n\n\ttc filter add dev $swp1 ingress chain $(IS1 1) pref 1 \\\n\t\tprotocol 802.1Q flower skip_sw vlan_id 100 \\\n\t\taction vlan pop \\\n\t\taction goto chain $(IS1 2)\n\n\ttc filter add dev $swp1 egress chain $(ES0) pref 1 \\\n\t\tflower skip_sw indev $swp2 \\\n\t\taction vlan push protocol 802.1Q id 100\n\n\ttc filter add dev $swp1 ingress chain $(IS1 0) pref 2 \\\n\t\tprotocol ipv4 flower skip_sw src_ip 10.1.1.2 \\\n\t\taction skbedit priority 7 \\\n\t\taction goto chain $(IS1 1)\n\n\ttc filter add dev $swp1 ingress chain $(IS2 0 0) pref 1 \\\n\t\tprotocol ipv4 flower skip_sw ip_proto udp dst_port 5201 \\\n\t\taction police rate 50mbit burst 64k conform-exceed drop/pipe \\\n\t\taction goto chain $(IS2 1 0)\n}\n\ncleanup()\n{\n\tip link del $h1.200\n\tip link del $h1.100\n\ttc qdisc del dev $swp1 clsact\n\tip link del br0\n}\n\ntest_vlan_pop()\n{\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\n\tRET=0\n\n\ttcpdump_start $h2\n\n\t# Work around Mausezahn VLAN builder bug\n\t# (https://github.com/netsniff-ng/netsniff-ng/issues/225) by using\n\t# an 8021q upper\n\t$MZ $h1.100 -q -c 1 -p 64 -a $h1_mac -b $h2_mac -t ip\n\n\tsleep 1\n\n\ttcpdump_stop $h2\n\n\ttcpdump_show $h2 | grep -q \"$h1_mac > $h2_mac, ethertype IPv4\"\n\tcheck_err \"$?\" \"untagged reception\"\n\n\ttcpdump_cleanup $h2\n\n\tlog_test \"VLAN pop\"\n}\n\ntest_vlan_push()\n{\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\n\tRET=0\n\n\ttcpdump_start $h1.100\n\n\t$MZ $h2 -q -c 1 -p 64 -a $h2_mac -b $h1_mac -t ip\n\n\tsleep 1\n\n\ttcpdump_stop $h1.100\n\n\ttcpdump_show $h1.100 | grep -q \"$h2_mac > $h1_mac\"\n\tcheck_err \"$?\" \"tagged reception\"\n\n\ttcpdump_cleanup $h1.100\n\n\tlog_test \"VLAN push\"\n}\n\ntest_vlan_ingress_modify()\n{\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\n\tRET=0\n\n\tip link set br0 type bridge vlan_filtering 1\n\tbridge vlan add dev $swp1 vid 200\n\tbridge vlan add dev $swp1 vid 300\n\tbridge vlan add dev $swp2 vid 300\n\n\ttc filter add dev $swp1 ingress chain $(IS1 2) pref 3 \\\n\t\tprotocol 802.1Q flower skip_sw vlan_id 200 src_mac $h1_mac \\\n\t\taction vlan modify id 300 \\\n\t\taction goto chain $(IS2 0 0)\n\n\ttcpdump_start $h2\n\n\t$MZ $h1.200 -q -c 1 -p 64 -a $h1_mac -b $h2_mac -t ip\n\n\tsleep 1\n\n\ttcpdump_stop $h2\n\n\ttcpdump_show $h2 | grep -q \"$h1_mac > $h2_mac, .* vlan 300\"\n\tcheck_err \"$?\" \"tagged reception\"\n\n\ttcpdump_cleanup $h2\n\n\ttc filter del dev $swp1 ingress chain $(IS1 2) pref 3\n\n\tbridge vlan del dev $swp1 vid 200\n\tbridge vlan del dev $swp1 vid 300\n\tbridge vlan del dev $swp2 vid 300\n\tip link set br0 type bridge vlan_filtering 0\n\n\tlog_test \"Ingress VLAN modification\"\n}\n\ntest_vlan_egress_modify()\n{\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\n\tRET=0\n\n\ttc qdisc add dev $swp2 clsact\n\n\tip link set br0 type bridge vlan_filtering 1\n\tbridge vlan add dev $swp1 vid 200\n\tbridge vlan add dev $swp2 vid 200\n\n\ttc filter add dev $swp2 egress chain $(ES0) pref 3 \\\n\t\tprotocol 802.1Q flower skip_sw vlan_id 200 vlan_prio 0 \\\n\t\taction vlan modify id 300 priority 7\n\n\ttcpdump_start $h2\n\n\t$MZ $h1.200 -q -c 1 -p 64 -a $h1_mac -b $h2_mac -t ip\n\n\tsleep 1\n\n\ttcpdump_stop $h2\n\n\ttcpdump_show $h2 | grep -q \"$h1_mac > $h2_mac, .* vlan 300\"\n\tcheck_err \"$?\" \"tagged reception\"\n\n\ttcpdump_cleanup $h2\n\n\ttc filter del dev $swp2 egress chain $(ES0) pref 3\n\ttc qdisc del dev $swp2 clsact\n\n\tbridge vlan del dev $swp1 vid 200\n\tbridge vlan del dev $swp2 vid 200\n\tip link set br0 type bridge vlan_filtering 0\n\n\tlog_test \"Egress VLAN modification\"\n}\n\ntest_skbedit_priority()\n{\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\tlocal num_pkts=100\n\n\tbefore=$(ethtool_stats_get $swp1 'rx_green_prio_7')\n\n\t$MZ $h1 -q -c $num_pkts -p 64 -a $h1_mac -b $h2_mac -t ip -A 10.1.1.2\n\n\tafter=$(ethtool_stats_get $swp1 'rx_green_prio_7')\n\n\tif [ $((after - before)) = $num_pkts ]; then\n\t\tRET=0\n\telse\n\t\tRET=1\n\tfi\n\n\tlog_test \"Frame prioritization\"\n}\n\ntrap cleanup EXIT\n\nALL_TESTS=\"\n\ttest_vlan_pop\n\ttest_vlan_push\n\ttest_vlan_ingress_modify\n\ttest_vlan_egress_modify\n\ttest_skbedit_priority\n\"\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}