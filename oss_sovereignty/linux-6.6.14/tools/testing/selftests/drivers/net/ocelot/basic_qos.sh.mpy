{
  "module_name": "basic_qos.sh",
  "hash_id": "2d5058a91c12bbb4c3409adc66113f2a2b1896dec6b8638bda35e7de3719f553",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/ocelot/basic_qos.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n# Copyright 2022 NXP\n\n# The script is mostly generic, with the exception of the\n# ethtool per-TC counter names (\"rx_green_prio_${tc}\")\n\nWAIT_TIME=1\nNUM_NETIFS=4\nSTABLE_MAC_ADDRS=yes\nNETIF_CREATE=no\nlib_dir=$(dirname $0)/../../../net/forwarding\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\n\nrequire_command dcb\n\nh1=${NETIFS[p1]}\nswp1=${NETIFS[p2]}\nswp2=${NETIFS[p3]}\nh2=${NETIFS[p4]}\n\nH1_IPV4=\"192.0.2.1\"\nH2_IPV4=\"192.0.2.2\"\nH1_IPV6=\"2001:db8:1::1\"\nH2_IPV6=\"2001:db8:1::2\"\n\nh1_create()\n{\n\tsimple_if_init $h1 $H1_IPV4/24 $H1_IPV6/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 $H1_IPV4/24 $H1_IPV6/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 $H2_IPV4/24 $H2_IPV6/64\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 $H2_IPV4/24 $H2_IPV6/64\n}\n\nh1_vlan_create()\n{\n\tlocal vid=$1\n\n\tvlan_create $h1 $vid\n\tsimple_if_init $h1.$vid $H1_IPV4/24 $H1_IPV6/64\n\tip link set $h1.$vid type vlan \\\n\t\tegress-qos-map 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7 \\\n\t\tingress-qos-map 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7\n}\n\nh1_vlan_destroy()\n{\n\tlocal vid=$1\n\n\tsimple_if_fini $h1.$vid $H1_IPV4/24 $H1_IPV6/64\n\tvlan_destroy $h1 $vid\n}\n\nh2_vlan_create()\n{\n\tlocal vid=$1\n\n\tvlan_create $h2 $vid\n\tsimple_if_init $h2.$vid $H2_IPV4/24 $H2_IPV6/64\n\tip link set $h2.$vid type vlan \\\n\t\tegress-qos-map 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7 \\\n\t\tingress-qos-map 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7\n}\n\nh2_vlan_destroy()\n{\n\tlocal vid=$1\n\n\tsimple_if_fini $h2.$vid $H2_IPV4/24 $H2_IPV6/64\n\tvlan_destroy $h2 $vid\n}\n\nvlans_prepare()\n{\n\th1_vlan_create 100\n\th2_vlan_create 100\n\n\ttc qdisc add dev ${h1}.100 clsact\n\ttc filter add dev ${h1}.100 egress protocol ipv4 \\\n\t\tflower ip_proto icmp action skbedit priority 3\n\ttc filter add dev ${h1}.100 egress protocol ipv6 \\\n\t\tflower ip_proto icmpv6 action skbedit priority 3\n}\n\nvlans_destroy()\n{\n\ttc qdisc del dev ${h1}.100 clsact\n\n\th1_vlan_destroy 100\n\th2_vlan_destroy 100\n}\n\nswitch_create()\n{\n\tip link set ${swp1} up\n\tip link set ${swp2} up\n\n\t# Ports should trust VLAN PCP even with vlan_filtering=0\n\tip link add br0 type bridge\n\tip link set ${swp1} master br0\n\tip link set ${swp2} master br0\n\tip link set br0 up\n}\n\nswitch_destroy()\n{\n\tip link del br0\n}\n\nsetup_prepare()\n{\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n\tswitch_destroy\n\n\tvrf_cleanup\n}\n\ndscp_cs_to_tos()\n{\n\tlocal dscp_cs=$1\n\n\t# https://datatracker.ietf.org/doc/html/rfc2474\n\t# 4.2.2.1  The Class Selector Codepoints\n\techo $((${dscp_cs} << 5))\n}\n\nrun_test()\n{\n\tlocal test_name=$1; shift\n\tlocal if_name=$1; shift\n\tlocal tc=$1; shift\n\tlocal tos=$1; shift\n\tlocal counter_name=\"rx_green_prio_${tc}\"\n\tlocal ipv4_before\n\tlocal ipv4_after\n\tlocal ipv6_before\n\tlocal ipv6_after\n\n\tipv4_before=$(ethtool_stats_get ${swp1} \"${counter_name}\")\n\tping_do ${if_name} $H2_IPV4 \"-Q ${tos}\"\n\tipv4_after=$(ethtool_stats_get ${swp1} \"${counter_name}\")\n\n\tif [ $((${ipv4_after} - ${ipv4_before})) -lt ${PING_COUNT} ]; then\n\t\tRET=1\n\telse\n\t\tRET=0\n\tfi\n\tlog_test \"IPv4 ${test_name}\"\n\n\tipv6_before=$(ethtool_stats_get ${swp1} \"${counter_name}\")\n\tping_do ${if_name} $H2_IPV6 \"-Q ${tos}\"\n\tipv6_after=$(ethtool_stats_get ${swp1} \"${counter_name}\")\n\n\tif [ $((${ipv6_after} - ${ipv6_before})) -lt ${PING_COUNT} ]; then\n\t\tRET=1\n\telse\n\t\tRET=0\n\tfi\n\tlog_test \"IPv6 ${test_name}\"\n}\n\nport_default_prio_get()\n{\n\tlocal if_name=$1\n\tlocal prio\n\n\tprio=\"$(dcb -j app show dev ${if_name} default-prio | \\\n\t\tjq '.default_prio[]')\"\n\tif [ -z \"${prio}\" ]; then\n\t\tprio=0\n\tfi\n\n\techo ${prio}\n}\n\ntest_port_default()\n{\n\tlocal orig=$(port_default_prio_get ${swp1})\n\tlocal dmac=$(mac_get ${h2})\n\n\tdcb app replace dev ${swp1} default-prio 5\n\n\trun_test \"Port-default QoS classification\" ${h1} 5 0\n\n\tdcb app replace dev ${swp1} default-prio ${orig}\n}\n\ntest_vlan_pcp()\n{\n\tvlans_prepare\n\n\trun_test \"Trusted VLAN PCP QoS classification\" ${h1}.100 3 0\n\n\tvlans_destroy\n}\n\ntest_ip_dscp()\n{\n\tlocal port_default=$(port_default_prio_get ${swp1})\n\tlocal tos=$(dscp_cs_to_tos 4)\n\n\tdcb app add dev ${swp1} dscp-prio CS4:4\n\trun_test \"Trusted DSCP QoS classification\" ${h1} 4 ${tos}\n\tdcb app del dev ${swp1} dscp-prio CS4:4\n\n\tvlans_prepare\n\trun_test \"Untrusted DSCP QoS classification follows VLAN PCP\" \\\n\t\t${h1}.100 3 ${tos}\n\tvlans_destroy\n\n\trun_test \"Untrusted DSCP QoS classification follows port default\" \\\n\t\t${h1} ${port_default} ${tos}\n}\n\ntrap cleanup EXIT\n\nALL_TESTS=\"\n\ttest_port_default\n\ttest_vlan_pcp\n\ttest_ip_dscp\n\"\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}