{
  "module_name": "lag_lib.sh",
  "hash_id": "1c4115f9ee49066a77fc47be479cd543e5dce6ea926fa06b768682c85aba0e51",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/bonding/lag_lib.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nNAMESPACES=\"\"\n\n# Test that a link aggregation device (bonding, team) removes the hardware\n# addresses that it adds on its underlying devices.\ntest_LAG_cleanup()\n{\n\tlocal driver=$1\n\tlocal mode=$2\n\tlocal ucaddr=\"02:00:00:12:34:56\"\n\tlocal addr6=\"fe80::78:9abc/64\"\n\tlocal mcaddr=\"33:33:ff:78:9a:bc\"\n\tlocal name\n\n\tip link add dummy1 type dummy\n\tip link add dummy2 type dummy\n\tif [ \"$driver\" = \"bonding\" ]; then\n\t\tname=\"bond1\"\n\t\tip link add \"$name\" up type bond mode \"$mode\"\n\t\tip link set dev dummy1 master \"$name\"\n\t\tip link set dev dummy2 master \"$name\"\n\telif [ \"$driver\" = \"team\" ]; then\n\t\tname=\"team0\"\n\t\tteamd -d -c '\n\t\t\t{\n\t\t\t\t\"device\": \"'\"$name\"'\",\n\t\t\t\t\"runner\": {\n\t\t\t\t\t\"name\": \"'\"$mode\"'\"\n\t\t\t\t},\n\t\t\t\t\"ports\": {\n\t\t\t\t\t\"dummy1\":\n\t\t\t\t\t\t{},\n\t\t\t\t\t\"dummy2\":\n\t\t\t\t\t\t{}\n\t\t\t\t}\n\t\t\t}\n\t\t'\n\t\tip link set dev \"$name\" up\n\telse\n\t\tcheck_err 1\n\t\tlog_test test_LAG_cleanup \": unknown driver \\\"$driver\\\"\"\n\t\treturn\n\tfi\n\n\t# Used to test dev->uc handling\n\tip link add mv0 link \"$name\" up address \"$ucaddr\" type macvlan\n\t# Used to test dev->mc handling\n\tip address add \"$addr6\" dev \"$name\"\n\tip link set dev \"$name\" down\n\tip link del \"$name\"\n\n\tnot grep_bridge_fdb \"$ucaddr\" bridge fdb show >/dev/null\n\tcheck_err $? \"macvlan unicast address still present on a slave\"\n\n\tnot grep_bridge_fdb \"$mcaddr\" bridge fdb show >/dev/null\n\tcheck_err $? \"IPv6 solicited-node multicast mac address still present on a slave\"\n\n\tcleanup\n\n\tlog_test \"$driver cleanup mode $mode\"\n}\n\n# Build a generic 2 node net namespace with 2 connections\n# between the namespaces\n#\n#  +-----------+       +-----------+\n#  | node1     |       | node2     |\n#  |           |       |           |\n#  |           |       |           |\n#  |      eth0 +-------+ eth0      |\n#  |           |       |           |\n#  |      eth1 +-------+ eth1      |\n#  |           |       |           |\n#  +-----------+       +-----------+\nlag_setup2x2()\n{\n\tlocal state=${1:-down}\n\tlocal namespaces=\"lag_node1 lag_node2\"\n\n\t# create namespaces\n\tfor n in ${namespaces}; do\n\t\tip netns add ${n}\n\tdone\n\n\t# wire up namespaces\n\tip link add name lag1 type veth peer name lag1-end\n\tip link set dev lag1 netns lag_node1 $state name eth0\n\tip link set dev lag1-end netns lag_node2 $state name eth0\n\n\tip link add name lag1 type veth peer name lag1-end\n\tip link set dev lag1 netns lag_node1 $state name eth1\n\tip link set dev lag1-end netns lag_node2 $state name eth1\n\n\tNAMESPACES=\"${namespaces}\"\n}\n\n# cleanup all lag related namespaces and remove the bonding module\nlag_cleanup()\n{\n\tfor n in ${NAMESPACES}; do\n\t\tip netns delete ${n} >/dev/null 2>&1 || true\n\tdone\n\tmodprobe -r bonding\n}\n\nSWITCH=\"lag_node1\"\nCLIENT=\"lag_node2\"\nCLIENTIP=\"172.20.2.1\"\nSWITCHIP=\"172.20.2.2\"\n\nlag_setup_network()\n{\n\tlag_setup2x2 \"down\"\n\n\t# create switch\n\tip netns exec ${SWITCH} ip link add br0 up type bridge\n\tip netns exec ${SWITCH} ip link set eth0 master br0 up\n\tip netns exec ${SWITCH} ip link set eth1 master br0 up\n\tip netns exec ${SWITCH} ip addr add ${SWITCHIP}/24 dev br0\n}\n\nlag_reset_network()\n{\n\tip netns exec ${CLIENT} ip link del bond0\n\tip netns exec ${SWITCH} ip link set eth0 up\n\tip netns exec ${SWITCH} ip link set eth1 up\n}\n\ncreate_bond()\n{\n\t# create client\n\tip netns exec ${CLIENT} ip link set eth0 down\n\tip netns exec ${CLIENT} ip link set eth1 down\n\n\tip netns exec ${CLIENT} ip link add bond0 type bond $@\n\tip netns exec ${CLIENT} ip link set eth0 master bond0\n\tip netns exec ${CLIENT} ip link set eth1 master bond0\n\tip netns exec ${CLIENT} ip link set bond0 up\n\tip netns exec ${CLIENT} ip addr add ${CLIENTIP}/24 dev bond0\n}\n\ntest_bond_recovery()\n{\n\tRET=0\n\n\tcreate_bond $@\n\n\t# verify connectivity\n\tip netns exec ${CLIENT} ping ${SWITCHIP} -c 2 >/dev/null 2>&1\n\tcheck_err $? \"No connectivity\"\n\n\t# force the links of the bond down\n\tip netns exec ${SWITCH} ip link set eth0 down\n\tsleep 2\n\tip netns exec ${SWITCH} ip link set eth0 up\n\tip netns exec ${SWITCH} ip link set eth1 down\n\n\t# re-verify connectivity\n\tip netns exec ${CLIENT} ping ${SWITCHIP} -c 2 >/dev/null 2>&1\n\n\tlocal rc=$?\n\tcheck_err $rc \"Bond failed to recover\"\n\tlog_test \"$1 ($2) bond recovery\"\n\tlag_reset_network\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}