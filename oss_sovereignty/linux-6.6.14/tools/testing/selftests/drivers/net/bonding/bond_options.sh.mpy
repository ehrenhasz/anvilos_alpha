{
  "module_name": "bond_options.sh",
  "hash_id": "89184b5ef27953f2cfd8d5f92247dc26b8f8223198a47f6cef050c351710f229",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/bonding/bond_options.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test bonding options with mode 1,5,6\n\nALL_TESTS=\"\n\tprio\n\tarp_validate\n\tnum_grat_arp\n\"\n\nlib_dir=$(dirname \"$0\")\nsource ${lib_dir}/bond_topo_3d1c.sh\n\nskip_prio()\n{\n\tlocal skip=1\n\n\t# check if iproute support prio option\n\tip -n ${s_ns} link set eth0 type bond_slave prio 10\n\t[[ $? -ne 0 ]] && skip=0\n\n\t# check if kernel support prio option\n\tip -n ${s_ns} -d link show eth0 | grep -q \"prio 10\"\n\t[[ $? -ne 0 ]] && skip=0\n\n\treturn $skip\n}\n\nskip_ns()\n{\n\tlocal skip=1\n\n\t# check if iproute support ns_ip6_target option\n\tip -n ${s_ns} link add bond1 type bond ns_ip6_target ${g_ip6}\n\t[[ $? -ne 0 ]] && skip=0\n\n\t# check if kernel support ns_ip6_target option\n\tip -n ${s_ns} -d link show bond1 | grep -q \"ns_ip6_target ${g_ip6}\"\n\t[[ $? -ne 0 ]] && skip=0\n\n\tip -n ${s_ns} link del bond1\n\n\treturn $skip\n}\n\nactive_slave=\"\"\ncheck_active_slave()\n{\n\tlocal target_active_slave=$1\n\tactive_slave=$(cmd_jq \"ip -n ${s_ns} -d -j link show bond0\" \".[].linkinfo.info_data.active_slave\")\n\ttest \"$active_slave\" = \"$target_active_slave\"\n\tcheck_err $? \"Current active slave is $active_slave but not $target_active_slave\"\n}\n\n\n# Test bonding prio option\nprio_test()\n{\n\tlocal param=\"$1\"\n\tRET=0\n\n\t# create bond\n\tbond_reset \"${param}\"\n\n\t# check bonding member prio value\n\tip -n ${s_ns} link set eth0 type bond_slave prio 0\n\tip -n ${s_ns} link set eth1 type bond_slave prio 10\n\tip -n ${s_ns} link set eth2 type bond_slave prio 11\n\tcmd_jq \"ip -n ${s_ns} -d -j link show eth0\" \\\n\t\t\".[].linkinfo.info_slave_data | select (.prio == 0)\" \"-e\" &> /dev/null\n\tcheck_err $? \"eth0 prio is not 0\"\n\tcmd_jq \"ip -n ${s_ns} -d -j link show eth1\" \\\n\t\t\".[].linkinfo.info_slave_data | select (.prio == 10)\" \"-e\" &> /dev/null\n\tcheck_err $? \"eth1 prio is not 10\"\n\tcmd_jq \"ip -n ${s_ns} -d -j link show eth2\" \\\n\t\t\".[].linkinfo.info_slave_data | select (.prio == 11)\" \"-e\" &> /dev/null\n\tcheck_err $? \"eth2 prio is not 11\"\n\n\tbond_check_connection \"setup\"\n\n\t# active slave should be the primary slave\n\tcheck_active_slave eth1\n\n\t# active slave should be the higher prio slave\n\tip -n ${s_ns} link set $active_slave down\n\tbond_check_connection \"fail over\"\n\tcheck_active_slave eth2\n\n\t# when only 1 slave is up\n\tip -n ${s_ns} link set $active_slave down\n\tbond_check_connection \"only 1 slave up\"\n\tcheck_active_slave eth0\n\n\t# when a higher prio slave change to up\n\tip -n ${s_ns} link set eth2 up\n\tbond_check_connection \"higher prio slave up\"\n\tcase $primary_reselect in\n\t\t\"0\")\n\t\t\tcheck_active_slave \"eth2\"\n\t\t\t;;\n\t\t\"1\")\n\t\t\tcheck_active_slave \"eth0\"\n\t\t\t;;\n\t\t\"2\")\n\t\t\tcheck_active_slave \"eth0\"\n\t\t\t;;\n\tesac\n\tlocal pre_active_slave=$active_slave\n\n\t# when the primary slave change to up\n\tip -n ${s_ns} link set eth1 up\n\tbond_check_connection \"primary slave up\"\n\tcase $primary_reselect in\n\t\t\"0\")\n\t\t\tcheck_active_slave \"eth1\"\n\t\t\t;;\n\t\t\"1\")\n\t\t\tcheck_active_slave \"$pre_active_slave\"\n\t\t\t;;\n\t\t\"2\")\n\t\t\tcheck_active_slave \"$pre_active_slave\"\n\t\t\tip -n ${s_ns} link set $active_slave down\n\t\t\tbond_check_connection \"pre_active slave down\"\n\t\t\tcheck_active_slave \"eth1\"\n\t\t\t;;\n\tesac\n\n\t# Test changing bond slave prio\n\tif [[ \"$primary_reselect\" == \"0\" ]];then\n\t\tip -n ${s_ns} link set eth0 type bond_slave prio 1000000\n\t\tip -n ${s_ns} link set eth1 type bond_slave prio 0\n\t\tip -n ${s_ns} link set eth2 type bond_slave prio -50\n\t\tip -n ${s_ns} -d link show eth0 | grep -q 'prio 1000000'\n\t\tcheck_err $? \"eth0 prio is not 1000000\"\n\t\tip -n ${s_ns} -d link show eth1 | grep -q 'prio 0'\n\t\tcheck_err $? \"eth1 prio is not 0\"\n\t\tip -n ${s_ns} -d link show eth2 | grep -q 'prio -50'\n\t\tcheck_err $? \"eth3 prio is not -50\"\n\t\tcheck_active_slave \"eth1\"\n\n\t\tip -n ${s_ns} link set $active_slave down\n\t\tbond_check_connection \"change slave prio\"\n\t\tcheck_active_slave \"eth0\"\n\tfi\n}\n\nprio_miimon()\n{\n\tlocal primary_reselect\n\tlocal mode=$1\n\n\tfor primary_reselect in 0 1 2; do\n\t\tprio_test \"mode $mode miimon 100 primary eth1 primary_reselect $primary_reselect\"\n\t\tlog_test \"prio\" \"$mode miimon primary_reselect $primary_reselect\"\n\tdone\n}\n\nprio_arp()\n{\n\tlocal primary_reselect\n\tlocal mode=$1\n\n\tfor primary_reselect in 0 1 2; do\n\t\tprio_test \"mode active-backup arp_interval 100 arp_ip_target ${g_ip4} primary eth1 primary_reselect $primary_reselect\"\n\t\tlog_test \"prio\" \"$mode arp_ip_target primary_reselect $primary_reselect\"\n\tdone\n}\n\nprio_ns()\n{\n\tlocal primary_reselect\n\tlocal mode=$1\n\n\tif skip_ns; then\n\t\tlog_test_skip \"prio ns\" \"Current iproute or kernel doesn't support bond option 'ns_ip6_target'.\"\n\t\treturn 0\n\tfi\n\n\tfor primary_reselect in 0 1 2; do\n\t\tprio_test \"mode active-backup arp_interval 100 ns_ip6_target ${g_ip6} primary eth1 primary_reselect $primary_reselect\"\n\t\tlog_test \"prio\" \"$mode ns_ip6_target primary_reselect $primary_reselect\"\n\tdone\n}\n\nprio()\n{\n\tlocal mode modes=\"active-backup balance-tlb balance-alb\"\n\n\tif skip_prio; then\n\t\tlog_test_skip \"prio\" \"Current iproute or kernel doesn't support bond option 'prio'.\"\n\t\treturn 0\n\tfi\n\n\tfor mode in $modes; do\n\t\tprio_miimon $mode\n\t\tprio_arp $mode\n\t\tprio_ns $mode\n\tdone\n}\n\narp_validate_test()\n{\n\tlocal param=\"$1\"\n\tRET=0\n\n\t# create bond\n\tbond_reset \"${param}\"\n\n\tbond_check_connection\n\t[ $RET -ne 0 ] && log_test \"arp_validate\" \"$retmsg\"\n\n\t# wait for a while to make sure the mii status stable\n\tsleep 5\n\tfor i in $(seq 0 2); do\n\t\tmii_status=$(cmd_jq \"ip -n ${s_ns} -j -d link show eth$i\" \".[].linkinfo.info_slave_data.mii_status\")\n\t\tif [ ${mii_status} != \"UP\" ]; then\n\t\t\tRET=1\n\t\t\tlog_test \"arp_validate\" \"interface eth$i mii_status $mii_status\"\n\t\tfi\n\tdone\n}\n\narp_validate_arp()\n{\n\tlocal mode=$1\n\tlocal val\n\tfor val in $(seq 0 6); do\n\t\tarp_validate_test \"mode $mode arp_interval 100 arp_ip_target ${g_ip4} arp_validate $val\"\n\t\tlog_test \"arp_validate\" \"$mode arp_ip_target arp_validate $val\"\n\tdone\n}\n\narp_validate_ns()\n{\n\tlocal mode=$1\n\tlocal val\n\n\tif skip_ns; then\n\t\tlog_test_skip \"arp_validate ns\" \"Current iproute or kernel doesn't support bond option 'ns_ip6_target'.\"\n\t\treturn 0\n\tfi\n\n\tfor val in $(seq 0 6); do\n\t\tarp_validate_test \"mode $mode arp_interval 100 ns_ip6_target ${g_ip6} arp_validate $val\"\n\t\tlog_test \"arp_validate\" \"$mode ns_ip6_target arp_validate $val\"\n\tdone\n}\n\narp_validate()\n{\n\tarp_validate_arp \"active-backup\"\n\tarp_validate_ns \"active-backup\"\n}\n\ngarp_test()\n{\n\tlocal param=\"$1\"\n\tlocal active_slave exp_num real_num i\n\tRET=0\n\n\t# create bond\n\tbond_reset \"${param}\"\n\n\tbond_check_connection\n\t[ $RET -ne 0 ] && log_test \"num_grat_arp\" \"$retmsg\"\n\n\n\t# Add tc rules to count GARP number\n\tfor i in $(seq 0 2); do\n\t\ttc -n ${g_ns} filter add dev s$i ingress protocol arp pref 1 handle 101 \\\n\t\t\tflower skip_hw arp_op request arp_sip ${s_ip4} arp_tip ${s_ip4} action pass\n\tdone\n\n\t# Do failover\n\tactive_slave=$(cmd_jq \"ip -n ${s_ns} -d -j link show bond0\" \".[].linkinfo.info_data.active_slave\")\n\tip -n ${s_ns} link set ${active_slave} down\n\n\texp_num=$(echo \"${param}\" | cut -f6 -d ' ')\n\tsleep $((exp_num + 2))\n\n\tactive_slave=$(cmd_jq \"ip -n ${s_ns} -d -j link show bond0\" \".[].linkinfo.info_data.active_slave\")\n\n\t# check result\n\treal_num=$(tc_rule_handle_stats_get \"dev s${active_slave#eth} ingress\" 101 \".packets\" \"-n ${g_ns}\")\n\tif [ \"${real_num}\" -ne \"${exp_num}\" ]; then\n\t\techo \"$real_num garp packets sent on active slave ${active_slave}\"\n\t\tRET=1\n\tfi\n\n\tfor i in $(seq 0 2); do\n\t\ttc -n ${g_ns} filter del dev s$i ingress\n\tdone\n}\n\nnum_grat_arp()\n{\n\tlocal val\n\tfor val in 10 20 30 50; do\n\t\tgarp_test \"mode active-backup miimon 100 num_grat_arp $val peer_notify_delay 1000\"\n\t\tlog_test \"num_grat_arp\" \"active-backup miimon num_grat_arp $val\"\n\tdone\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}