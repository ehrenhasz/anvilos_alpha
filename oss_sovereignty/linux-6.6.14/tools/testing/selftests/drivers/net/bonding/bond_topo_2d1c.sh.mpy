{
  "module_name": "bond_topo_2d1c.sh",
  "hash_id": "304caa03a79030c3b6ab18aaaa38605ea0be020261850d4f92542b4a6f452d1c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/bonding/bond_topo_2d1c.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Topology for Bond mode 1,5,6 testing\n#\n#  +-------------------------+\n#  |          bond0          |  Server\n#  |            +            |  192.0.2.1/24\n#  |      eth0  |  eth1      |  2001:db8::1/24\n#  |        +---+---+        |\n#  |        |       |        |\n#  +-------------------------+\n#           |       |\n#  +-------------------------+\n#  |        |       |        |\n#  |    +---+-------+---+    |  Gateway\n#  |    |      br0      |    |  192.0.2.254/24\n#  |    +-------+-------+    |  2001:db8::254/24\n#  |            |            |\n#  +-------------------------+\n#               |\n#  +-------------------------+\n#  |            |            |  Client\n#  |            +            |  192.0.2.10/24\n#  |          eth0           |  2001:db8::10/24\n#  +-------------------------+\n\nREQUIRE_MZ=no\nNUM_NETIFS=0\nlib_dir=$(dirname \"$0\")\nsource ${lib_dir}/net_forwarding_lib.sh\n\ns_ns=\"s-$(mktemp -u XXXXXX)\"\nc_ns=\"c-$(mktemp -u XXXXXX)\"\ng_ns=\"g-$(mktemp -u XXXXXX)\"\ns_ip4=\"192.0.2.1\"\nc_ip4=\"192.0.2.10\"\ng_ip4=\"192.0.2.254\"\ns_ip6=\"2001:db8::1\"\nc_ip6=\"2001:db8::10\"\ng_ip6=\"2001:db8::254\"\n\ngateway_create()\n{\n\tip netns add ${g_ns}\n\tip -n ${g_ns} link add br0 type bridge\n\tip -n ${g_ns} link set br0 up\n\tip -n ${g_ns} addr add ${g_ip4}/24 dev br0\n\tip -n ${g_ns} addr add ${g_ip6}/24 dev br0\n}\n\ngateway_destroy()\n{\n\tip -n ${g_ns} link del br0\n\tip netns del ${g_ns}\n}\n\nserver_create()\n{\n\tip netns add ${s_ns}\n\tip -n ${s_ns} link add bond0 type bond mode active-backup miimon 100\n\n\tfor i in $(seq 0 1); do\n\t\tip -n ${s_ns} link add eth${i} type veth peer name s${i} netns ${g_ns}\n\n\t\tip -n ${g_ns} link set s${i} up\n\t\tip -n ${g_ns} link set s${i} master br0\n\t\tip -n ${s_ns} link set eth${i} master bond0\n\n\t\ttc -n ${g_ns} qdisc add dev s${i} clsact\n\tdone\n\n\tip -n ${s_ns} link set bond0 up\n\tip -n ${s_ns} addr add ${s_ip4}/24 dev bond0\n\tip -n ${s_ns} addr add ${s_ip6}/24 dev bond0\n\tsleep 2\n}\n\n# Reset bond with new mode and options\nbond_reset()\n{\n\t# Count the eth link number in real-time as this function\n\t# maybe called from other topologies.\n\tlocal link_num=$(ip -n ${s_ns} -br link show | grep -c \"^eth\")\n\tlocal param=\"$1\"\n\tlink_num=$((link_num -1))\n\n\tip -n ${s_ns} link set bond0 down\n\tip -n ${s_ns} link del bond0\n\n\tip -n ${s_ns} link add bond0 type bond $param\n\tfor i in $(seq 0 ${link_num}); do\n\t\tip -n ${s_ns} link set eth$i master bond0\n\tdone\n\n\tip -n ${s_ns} link set bond0 up\n\tip -n ${s_ns} addr add ${s_ip4}/24 dev bond0\n\tip -n ${s_ns} addr add ${s_ip6}/24 dev bond0\n\tsleep 2\n}\n\nserver_destroy()\n{\n\t# Count the eth link number in real-time as this function\n\t# maybe called from other topologies.\n\tlocal link_num=$(ip -n ${s_ns} -br link show | grep -c \"^eth\")\n\tlink_num=$((link_num -1))\n\tfor i in $(seq 0 ${link_num}); do\n\t\tip -n ${s_ns} link del eth${i}\n\tdone\n\tip netns del ${s_ns}\n}\n\nclient_create()\n{\n\tip netns add ${c_ns}\n\tip -n ${c_ns} link add eth0 type veth peer name c0 netns ${g_ns}\n\n\tip -n ${g_ns} link set c0 up\n\tip -n ${g_ns} link set c0 master br0\n\n\tip -n ${c_ns} link set eth0 up\n\tip -n ${c_ns} addr add ${c_ip4}/24 dev eth0\n\tip -n ${c_ns} addr add ${c_ip6}/24 dev eth0\n}\n\nclient_destroy()\n{\n\tip -n ${c_ns} link del eth0\n\tip netns del ${c_ns}\n}\n\nsetup_prepare()\n{\n\tgateway_create\n\tserver_create\n\tclient_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tclient_destroy\n\tserver_destroy\n\tgateway_destroy\n}\n\nbond_check_connection()\n{\n\tlocal msg=${1:-\"check connection\"}\n\n\tsleep 2\n\tip netns exec ${s_ns} ping ${c_ip4} -c5 -i 0.1 &>/dev/null\n\tcheck_err $? \"${msg}: ping failed\"\n\tip netns exec ${s_ns} ping6 ${c_ip6} -c5 -i 0.1 &>/dev/null\n\tcheck_err $? \"${msg}: ping6 failed\"\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}