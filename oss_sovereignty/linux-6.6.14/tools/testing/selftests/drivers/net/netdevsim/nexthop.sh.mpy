{
  "module_name": "nexthop.sh",
  "hash_id": "bcac8d3f5dd2c2ff36b81f8542938e2751e2bb8da387ab1e3c381ab4b725a3ba",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/nexthop.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking the nexthop offload API. It makes use of netdevsim\n# which registers a listener to the nexthop notification chain.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tnexthop_single_add_test\n\tnexthop_single_add_err_test\n\tnexthop_group_add_test\n\tnexthop_group_add_err_test\n\tnexthop_res_group_add_test\n\tnexthop_res_group_add_err_test\n\tnexthop_group_replace_test\n\tnexthop_group_replace_err_test\n\tnexthop_res_group_replace_test\n\tnexthop_res_group_replace_err_test\n\tnexthop_res_group_idle_timer_test\n\tnexthop_res_group_idle_timer_del_test\n\tnexthop_res_group_increase_idle_timer_test\n\tnexthop_res_group_decrease_idle_timer_test\n\tnexthop_res_group_unbalanced_timer_test\n\tnexthop_res_group_unbalanced_timer_del_test\n\tnexthop_res_group_no_unbalanced_timer_test\n\tnexthop_res_group_short_unbalanced_timer_test\n\tnexthop_res_group_increase_unbalanced_timer_test\n\tnexthop_res_group_decrease_unbalanced_timer_test\n\tnexthop_res_group_force_migrate_busy_test\n\tnexthop_single_replace_test\n\tnexthop_single_replace_err_test\n\tnexthop_single_in_group_replace_test\n\tnexthop_single_in_group_replace_err_test\n\tnexthop_single_in_res_group_replace_test\n\tnexthop_single_in_res_group_replace_err_test\n\tnexthop_single_in_group_delete_test\n\tnexthop_single_in_group_delete_err_test\n\tnexthop_single_in_res_group_delete_test\n\tnexthop_single_in_res_group_delete_err_test\n\tnexthop_replay_test\n\tnexthop_replay_err_test\n\"\nNETDEVSIM_PATH=/sys/bus/netdevsim/\nDEV_ADDR=1337\nDEV=netdevsim${DEV_ADDR}\nSYSFS_NET_DIR=/sys/bus/netdevsim/devices/$DEV/net/\nDEBUGFS_NET_DIR=/sys/kernel/debug/netdevsim/$DEV/\nNUM_NETIFS=0\nsource $lib_dir/lib.sh\n\nDEVLINK_DEV=\nsource $lib_dir/devlink_lib.sh\nDEVLINK_DEV=netdevsim/${DEV}\n\nnexthop_check()\n{\n\tlocal nharg=\"$1\"; shift\n\tlocal expected=\"$1\"; shift\n\n\tout=$($IP nexthop show ${nharg} | sed -e 's/ *$//')\n\tif [[ \"$out\" != \"$expected\" ]]; then\n\t\treturn 1\n\tfi\n\n\treturn 0\n}\n\nnexthop_bucket_nhid_count_check()\n{\n\tlocal group_id=$1; shift\n\tlocal expected\n\tlocal count\n\tlocal nhid\n\tlocal ret\n\n\twhile (($# > 0)); do\n\t\tnhid=$1; shift\n\t\texpected=$1; shift\n\n\t\tcount=$($IP nexthop bucket show id $group_id nhid $nhid |\n\t\t\tgrep \"trap\" | wc -l)\n\t\tif ((expected != count)); then\n\t\t\treturn 1\n\t\tfi\n\tdone\n\n\treturn 0\n}\n\nnexthop_resource_check()\n{\n\tlocal expected_occ=$1; shift\n\n\tocc=$($DEVLINK -jp resource show $DEVLINK_DEV \\\n\t\t| jq '.[][][] | select(.name==\"nexthops\") | .[\"occ\"]')\n\n\tif [ $expected_occ -ne $occ ]; then\n\t\treturn 1\n\tfi\n\n\treturn 0\n}\n\nnexthop_resource_set()\n{\n\tlocal size=$1; shift\n\n\t$DEVLINK resource set $DEVLINK_DEV path nexthops size $size\n\t$DEVLINK dev reload $DEVLINK_DEV\n}\n\nnexthop_single_add_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\tnexthop_check \"id 1\" \"id 1 via 192.0.2.2 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry\"\n\n\tnexthop_resource_check 1\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\t$IP nexthop del id 1\n\tnexthop_resource_check 0\n\tcheck_err $? \"Wrong nexthop occupancy after delete\"\n\n\tlog_test \"Single nexthop add and delete\"\n}\n\nnexthop_single_add_err_test()\n{\n\tRET=0\n\n\tnexthop_resource_set 1\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1 &> /dev/null\n\tcheck_fail $? \"Nexthop addition succeeded when should fail\"\n\n\tnexthop_resource_check 1\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop add failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_group_add_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\t$IP nexthop add id 10 group 1/2\n\tnexthop_check \"id 10\" \"id 10 group 1/2 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_resource_check 4\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\t$IP nexthop del id 10\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy after delete\"\n\n\t$IP nexthop add id 10 group 1,20/2,39\n\tnexthop_check \"id 10\" \"id 10 group 1,20/2,39 trap\"\n\tcheck_err $? \"Unexpected weighted nexthop group entry\"\n\n\tnexthop_resource_check 61\n\tcheck_err $? \"Wrong weighted nexthop occupancy\"\n\n\t$IP nexthop del id 10\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy after delete\"\n\n\tlog_test \"Nexthop group add and delete\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_group_add_err_test()\n{\n\tRET=0\n\n\tnexthop_resource_set 2\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\t$IP nexthop add id 10 group 1/2 &> /dev/null\n\tcheck_fail $? \"Nexthop group addition succeeded when should fail\"\n\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Nexthop group add failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_res_group_add_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 4\n\tnexthop_check \"id 10\" \"id 10 group 1/2 type resilient buckets 4 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_bucket_nhid_count_check 10 1 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\tnexthop_bucket_nhid_count_check 10 2 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 6\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\t$IP nexthop del id 10\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy after delete\"\n\n\t$IP nexthop add id 10 group 1,3/2,2 type resilient buckets 5\n\tnexthop_check \"id 10\" \"id 10 group 1,3/2,2 type resilient buckets 5 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected weighted nexthop group entry\"\n\n\tnexthop_bucket_nhid_count_check 10 1 3\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\tnexthop_bucket_nhid_count_check 10 2 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 7\n\tcheck_err $? \"Wrong weighted nexthop occupancy\"\n\n\t$IP nexthop del id 10\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy after delete\"\n\n\tlog_test \"Resilient nexthop group add and delete\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_add_err_test()\n{\n\tRET=0\n\n\tnexthop_resource_set 2\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 4 &> /dev/null\n\tcheck_fail $? \"Nexthop group addition succeeded when should fail\"\n\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Resilient nexthop group add failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_group_replace_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.4 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t$IP nexthop replace id 10 group 1/2/3\n\tnexthop_check \"id 10\" \"id 10 group 1/2/3 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_resource_check 6\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Nexthop group replace\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_group_replace_err_test()\n{\n\tRET=0\n\n\tnexthop_resource_set 5\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.4 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t$IP nexthop replace id 10 group 1/2/3 &> /dev/null\n\tcheck_fail $? \"Nexthop group replacement succeeded when should fail\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry after failure\"\n\n\tnexthop_resource_check 5\n\tcheck_err $? \"Wrong nexthop occupancy after failure\"\n\n\tlog_test \"Nexthop group replace failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_res_group_replace_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.4 dev dummy1\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 6\n\n\t$IP nexthop replace id 10 group 1/2/3 type resilient\n\tnexthop_check \"id 10\" \"id 10 group 1/2/3 type resilient buckets 6 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_bucket_nhid_count_check 10 1 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\tnexthop_bucket_nhid_count_check 10 2 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\tnexthop_bucket_nhid_count_check 10 3 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 9\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Resilient nexthop group replace\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_replace_err_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.4 dev dummy1\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 6\n\n\tip netns exec testns1 \\\n\t\techo 1 > $DEBUGFS_NET_DIR/fib/fail_res_nexthop_group_replace\n\t$IP nexthop replace id 10 group 1/2/3 type resilient &> /dev/null\n\tcheck_fail $? \"Nexthop group replacement succeeded when should fail\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 type resilient buckets 6 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry after failure\"\n\n\tnexthop_bucket_nhid_count_check 10 1 3\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\tnexthop_bucket_nhid_count_check 10 2 3\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 9\n\tcheck_err $? \"Wrong nexthop occupancy after failure\"\n\n\tlog_test \"Resilient nexthop group replace failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tip netns exec testns1 \\\n\t\techo 0 > $DEBUGFS_NET_DIR/fib/fail_res_nexthop_group_replace\n}\n\nnexthop_res_mark_buckets_busy()\n{\n\tlocal group_id=$1; shift\n\tlocal nhid=$1; shift\n\tlocal count=$1; shift\n\tlocal index\n\n\tfor index in $($IP -j nexthop bucket show id $group_id nhid $nhid |\n\t\t       jq '.[].bucket.index' | head -n ${count:--0})\n\tdo\n\t\techo $group_id $index \\\n\t\t\t> $DEBUGFS_NET_DIR/fib/nexthop_bucket_activity\n\tdone\n}\n\nnexthop_res_num_nhid_buckets()\n{\n\tlocal group_id=$1; shift\n\tlocal nhid=$1; shift\n\n\t$IP -j nexthop bucket show id $group_id nhid $nhid | jq length\n}\n\nnexthop_res_group_idle_timer_test()\n{\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 8 idle_timer 4\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tnexthop_bucket_nhid_count_check 10  1 4  2 4\n\tcheck_err $? \"Group expected to be unbalanced\"\n\n\tsleep 6\n\n\tnexthop_bucket_nhid_count_check 10  1 2  2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after idle timer\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_idle_timer_del_test()\n{\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1,50/2,50/3,1 \\\n\t    type resilient buckets 8 idle_timer 6\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1,50/2,150/3,1 type resilient\n\n\tnexthop_bucket_nhid_count_check 10  1 4  2 4  3 0\n\tcheck_err $? \"Group expected to be unbalanced\"\n\n\tsleep 4\n\n\t# Deletion prompts group replacement. Check that the bucket timers\n\t# are kept.\n\t$IP nexthop delete id 3\n\n\tnexthop_bucket_nhid_count_check 10  1 4  2 4\n\tcheck_err $? \"Group expected to still be unbalanced\"\n\n\tsleep 4\n\n\tnexthop_bucket_nhid_count_check 10  1 2  2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after idle timer (with delete)\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\n__nexthop_res_group_increase_timer_test()\n{\n\tlocal timer=$1; shift\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 8 $timer 4\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group expected to be unbalanced\"\n\n\tsleep 2\n\t$IP nexthop replace id 10 group 1/2,3 type resilient $timer 8\n\tsleep 4\n\n\t# 6 seconds, past the original timer.\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group still expected to be unbalanced\"\n\n\tsleep 4\n\n\t# 10 seconds, past the new timer.\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after $timer increase\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\n__nexthop_res_group_decrease_timer_test()\n{\n\tlocal timer=$1; shift\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 8 $timer 8\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group expected to be unbalanced\"\n\n\tsleep 2\n\t$IP nexthop replace id 10 group 1/2,3 type resilient $timer 4\n\tsleep 4\n\n\t# 6 seconds, past the new timer, before the old timer.\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after $timer decrease\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\n__nexthop_res_group_increase_timer_del_test()\n{\n\tlocal timer=$1; shift\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1,100/2,100/3,1 \\\n\t    type resilient buckets 8 $timer 4\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1,100/2,300/3,1 type resilient\n\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group expected to be unbalanced\"\n\n\tsleep 2\n\t$IP nexthop replace id 10 group 1/2,3 type resilient $timer 8\n\tsleep 4\n\n\t# 6 seconds, past the original timer.\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group still expected to be unbalanced\"\n\n\tsleep 4\n\n\t# 10 seconds, past the new timer.\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after $timer increase\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_increase_idle_timer_test()\n{\n\t__nexthop_res_group_increase_timer_test idle_timer\n}\n\nnexthop_res_group_decrease_idle_timer_test()\n{\n\t__nexthop_res_group_decrease_timer_test idle_timer\n}\n\nnexthop_res_group_unbalanced_timer_test()\n{\n\tlocal i\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient \\\n\t    buckets 8 idle_timer 6 unbalanced_timer 10\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tfor i in 1 2; do\n\t\tsleep 4\n\t\tnexthop_bucket_nhid_count_check 10  1 4  2 4\n\t\tcheck_err $? \"$i: Group expected to be unbalanced\"\n\t\tnexthop_res_mark_buckets_busy 10 1\n\tdone\n\n\t# 3 x sleep 4 > unbalanced timer 10\n\tsleep 4\n\tnexthop_bucket_nhid_count_check 10  1 2  2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after unbalanced timer\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_unbalanced_timer_del_test()\n{\n\tlocal i\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1,50/2,50/3,1 type resilient \\\n\t    buckets 8 idle_timer 6 unbalanced_timer 10\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1,50/2,150/3,1 type resilient\n\n\t# Check that NH delete does not reset unbalanced time.\n\tsleep 4\n\t$IP nexthop delete id 3\n\tnexthop_bucket_nhid_count_check 10  1 4  2 4\n\tcheck_err $? \"1: Group expected to be unbalanced\"\n\tnexthop_res_mark_buckets_busy 10 1\n\n\tsleep 4\n\tnexthop_bucket_nhid_count_check 10  1 4  2 4\n\tcheck_err $? \"2: Group expected to be unbalanced\"\n\tnexthop_res_mark_buckets_busy 10 1\n\n\t# 3 x sleep 4 > unbalanced timer 10\n\tsleep 4\n\tnexthop_bucket_nhid_count_check 10  1 2  2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after unbalanced timer (with delete)\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_no_unbalanced_timer_test()\n{\n\tlocal i\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 8\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tfor i in $(seq 3); do\n\t\tsleep 60\n\t\tnexthop_bucket_nhid_count_check 10 2 6\n\t\tcheck_fail $? \"$i: Group expected to be unbalanced\"\n\t\tnexthop_res_mark_buckets_busy 10 1\n\tdone\n\n\tlog_test \"Buckets never force-migrated without unbalanced timer\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_short_unbalanced_timer_test()\n{\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient \\\n\t    buckets 8 idle_timer 120 unbalanced_timer 4\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group expected to be unbalanced\"\n\n\tsleep 5\n\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_err $? \"Group expected to be balanced\"\n\n\tlog_test \"Bucket migration after unbalanced < idle timer\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_res_group_increase_unbalanced_timer_test()\n{\n\t__nexthop_res_group_increase_timer_test unbalanced_timer\n}\n\nnexthop_res_group_decrease_unbalanced_timer_test()\n{\n\t__nexthop_res_group_decrease_timer_test unbalanced_timer\n}\n\nnexthop_res_group_force_migrate_busy_test()\n{\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\n\tRET=0\n\n\t$IP nexthop add id 10 group 1/2 type resilient \\\n\t    buckets 8 idle_timer 120\n\tnexthop_res_mark_buckets_busy 10 1\n\t$IP nexthop replace id 10 group 1/2,3 type resilient\n\n\tnexthop_bucket_nhid_count_check 10 2 6\n\tcheck_fail $? \"Group expected to be unbalanced\"\n\n\t$IP nexthop replace id 10 group 2 type resilient\n\tnexthop_bucket_nhid_count_check 10 2 8\n\tcheck_err $? \"All buckets expected to have migrated\"\n\n\tlog_test \"Busy buckets force-migrated when NH removed\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_single_replace_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\n\t$IP nexthop replace id 1 via 192.0.2.3 dev dummy1\n\tnexthop_check \"id 1\" \"id 1 via 192.0.2.3 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry\"\n\n\tnexthop_resource_check 1\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop replace\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_single_replace_err_test()\n{\n\tRET=0\n\n\t# This is supposed to cause the replace to fail because the new nexthop\n\t# is programmed before deleting the replaced one.\n\tnexthop_resource_set 1\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\n\t$IP nexthop replace id 1 via 192.0.2.3 dev dummy1 &> /dev/null\n\tcheck_fail $? \"Nexthop replace succeeded when should fail\"\n\n\tnexthop_check \"id 1\" \"id 1 via 192.0.2.2 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry after failure\"\n\n\tnexthop_resource_check 1\n\tcheck_err $? \"Wrong nexthop occupancy after failure\"\n\n\tlog_test \"Single nexthop replace failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_single_in_group_replace_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t$IP nexthop replace id 1 via 192.0.2.4 dev dummy1\n\tcheck_err $? \"Failed to replace nexthop when should not\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_resource_check 4\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop replace while in group\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_single_in_group_replace_err_test()\n{\n\tRET=0\n\n\tnexthop_resource_set 5\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t$IP nexthop replace id 1 via 192.0.2.4 dev dummy1 &> /dev/null\n\tcheck_fail $? \"Nexthop replacement succeeded when should fail\"\n\n\tnexthop_check \"id 1\" \"id 1 via 192.0.2.2 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry after failure\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry after failure\"\n\n\tnexthop_resource_check 4\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop replace while in group failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_single_in_res_group_replace_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 4\n\n\t$IP nexthop replace id 1 via 192.0.2.4 dev dummy1\n\tcheck_err $? \"Failed to replace nexthop when should not\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 type resilient buckets 4 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_bucket_nhid_count_check 10  1 2  2 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 6\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop replace while in resilient group\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_single_in_res_group_replace_err_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 4\n\n\tip netns exec testns1 \\\n\t\techo 1 > $DEBUGFS_NET_DIR/fib/fail_nexthop_bucket_replace\n\t$IP nexthop replace id 1 via 192.0.2.4 dev dummy1 &> /dev/null\n\tcheck_fail $? \"Nexthop replacement succeeded when should fail\"\n\n\tnexthop_check \"id 1\" \"id 1 via 192.0.2.2 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry after failure\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 type resilient buckets 4 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry after failure\"\n\n\tnexthop_bucket_nhid_count_check 10  1 2  2 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 6\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop replace while in resilient group failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tip netns exec testns1 \\\n\t\techo 0 > $DEBUGFS_NET_DIR/fib/fail_nexthop_bucket_replace\n}\n\nnexthop_single_in_group_delete_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t$IP nexthop del id 1\n\tnexthop_check \"id 10\" \"id 10 group 2 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_resource_check 2\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop delete while in group\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_single_in_group_delete_err_test()\n{\n\tRET=0\n\n\t# First, nexthop 1 will be deleted, which will reduce the occupancy to\n\t# 5. Afterwards, a replace notification will be sent for nexthop group\n\t# 10 with only two nexthops. Since the new group is allocated before\n\t# the old is deleted, the replacement will fail as it will result in an\n\t# occupancy of 7.\n\tnexthop_resource_set 6\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.4 dev dummy1\n\t$IP nexthop add id 10 group 1/2/3\n\n\t$IP nexthop del id 1\n\n\tnexthop_resource_check 5\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop delete while in group failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tnexthop_resource_set 9999\n}\n\nnexthop_single_in_res_group_delete_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2 type resilient buckets 4\n\n\t$IP nexthop del id 1\n\tnexthop_check \"id 10\" \"id 10 group 2 type resilient buckets 4 idle_timer 120 unbalanced_timer 0 unbalanced_time 0 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry\"\n\n\tnexthop_bucket_nhid_count_check 10 2 4\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 5\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop delete while in resilient group\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_single_in_res_group_delete_err_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 3 via 192.0.2.4 dev dummy1\n\t$IP nexthop add id 10 group 1/2/3 type resilient buckets 6\n\n\tip netns exec testns1 \\\n\t\techo 1 > $DEBUGFS_NET_DIR/fib/fail_nexthop_bucket_replace\n\t$IP nexthop del id 1\n\n\t# We failed to replace the two nexthop buckets that were originally\n\t# assigned to nhid 1.\n\tnexthop_bucket_nhid_count_check 10  2 2  3 2\n\tcheck_err $? \"Wrong nexthop buckets count\"\n\n\tnexthop_resource_check 8\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Single nexthop delete while in resilient group failure\"\n\n\t$IP nexthop flush &> /dev/null\n\tip netns exec testns1 \\\n\t\techo 0 > $DEBUGFS_NET_DIR/fib/fail_nexthop_bucket_replace\n}\n\nnexthop_replay_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t$DEVLINK dev reload $DEVLINK_DEV\n\tcheck_err $? \"Failed to reload when should not\"\n\n\tnexthop_check \"id 1\" \"id 1 via 192.0.2.2 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry after reload\"\n\n\tnexthop_check \"id 2\" \"id 2 via 192.0.2.3 dev dummy1 scope link trap\"\n\tcheck_err $? \"Unexpected nexthop entry after reload\"\n\n\tnexthop_check \"id 10\" \"id 10 group 1/2 trap\"\n\tcheck_err $? \"Unexpected nexthop group entry after reload\"\n\n\tnexthop_resource_check 4\n\tcheck_err $? \"Wrong nexthop occupancy\"\n\n\tlog_test \"Nexthop replay\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nnexthop_replay_err_test()\n{\n\tRET=0\n\n\t$IP nexthop add id 1 via 192.0.2.2 dev dummy1\n\t$IP nexthop add id 2 via 192.0.2.3 dev dummy1\n\t$IP nexthop add id 10 group 1/2\n\n\t# Reduce size of nexthop resource so that reload will fail.\n\t$DEVLINK resource set $DEVLINK_DEV path nexthops size 3\n\t$DEVLINK dev reload $DEVLINK_DEV &> /dev/null\n\tcheck_fail $? \"Reload succeeded when should fail\"\n\n\t$DEVLINK resource set $DEVLINK_DEV path nexthops size 9999\n\t$DEVLINK dev reload $DEVLINK_DEV\n\tcheck_err $? \"Failed to reload when should not\"\n\n\tlog_test \"Nexthop replay failure\"\n\n\t$IP nexthop flush &> /dev/null\n}\n\nsetup_prepare()\n{\n\tlocal netdev\n\n\tmodprobe netdevsim &> /dev/null\n\n\techo \"$DEV_ADDR 1\" > ${NETDEVSIM_PATH}/new_device\n\twhile [ ! -d $SYSFS_NET_DIR ] ; do :; done\n\n\tset -e\n\n\tip netns add testns1\n\tdevlink dev reload $DEVLINK_DEV netns testns1\n\n\tIP=\"ip -netns testns1\"\n\tDEVLINK=\"devlink -N testns1\"\n\n\t$IP link add name dummy1 up type dummy\n\t$IP address add 192.0.2.1/24 dev dummy1\n\n\tset +e\n}\n\ncleanup()\n{\n\tpre_cleanup\n\tip netns del testns1\n\techo \"$DEV_ADDR\" > ${NETDEVSIM_PATH}/del_device\n\tmodprobe -r netdevsim &> /dev/null\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}