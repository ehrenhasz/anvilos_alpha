{
  "module_name": "ethtool-coalesce.sh",
  "hash_id": "bb06d4e03bfbce9ef9f33856e63fb764e1faf5401f63a056256f2a91078aa1c2",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/ethtool-coalesce.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0-only\n\nsource ethtool-common.sh\n\nfunction get_value {\n    local query=\"${SETTINGS_MAP[$1]}\"\n\n    echo $(ethtool -c $NSIM_NETDEV | \\\n        awk -F':' -v pattern=\"$query:\" '$0 ~ pattern {gsub(/[ \\t]/, \"\", $2); print $2}')\n}\n\nfunction update_current_settings {\n    for key in ${!SETTINGS_MAP[@]}; do\n        CURRENT_SETTINGS[$key]=$(get_value $key)\n    done\n    echo ${CURRENT_SETTINGS[@]}\n}\n\nif ! ethtool -h | grep -q coalesce; then\n    echo \"SKIP: No --coalesce support in ethtool\"\n    exit 4\nfi\n\nNSIM_NETDEV=$(make_netdev)\n\nset -o pipefail\n\ndeclare -A SETTINGS_MAP=(\n    [\"rx-frames-low\"]=\"rx-frame-low\"\n    [\"tx-frames-low\"]=\"tx-frame-low\"\n    [\"rx-frames-high\"]=\"rx-frame-high\"\n    [\"tx-frames-high\"]=\"tx-frame-high\"\n    [\"rx-usecs\"]=\"rx-usecs\"\n    [\"rx-frames\"]=\"rx-frames\"\n    [\"rx-usecs-irq\"]=\"rx-usecs-irq\"\n    [\"rx-frames-irq\"]=\"rx-frames-irq\"\n    [\"tx-usecs\"]=\"tx-usecs\"\n    [\"tx-frames\"]=\"tx-frames\"\n    [\"tx-usecs-irq\"]=\"tx-usecs-irq\"\n    [\"tx-frames-irq\"]=\"tx-frames-irq\"\n    [\"stats-block-usecs\"]=\"stats-block-usecs\"\n    [\"pkt-rate-low\"]=\"pkt-rate-low\"\n    [\"rx-usecs-low\"]=\"rx-usecs-low\"\n    [\"tx-usecs-low\"]=\"tx-usecs-low\"\n    [\"pkt-rate-high\"]=\"pkt-rate-high\"\n    [\"rx-usecs-high\"]=\"rx-usecs-high\"\n    [\"tx-usecs-high\"]=\"tx-usecs-high\"\n    [\"sample-interval\"]=\"sample-interval\"\n)\n\ndeclare -A CURRENT_SETTINGS=(\n    [\"rx-frames-low\"]=\"\"\n    [\"tx-frames-low\"]=\"\"\n    [\"rx-frames-high\"]=\"\"\n    [\"tx-frames-high\"]=\"\"\n    [\"rx-usecs\"]=\"\"\n    [\"rx-frames\"]=\"\"\n    [\"rx-usecs-irq\"]=\"\"\n    [\"rx-frames-irq\"]=\"\"\n    [\"tx-usecs\"]=\"\"\n    [\"tx-frames\"]=\"\"\n    [\"tx-usecs-irq\"]=\"\"\n    [\"tx-frames-irq\"]=\"\"\n    [\"stats-block-usecs\"]=\"\"\n    [\"pkt-rate-low\"]=\"\"\n    [\"rx-usecs-low\"]=\"\"\n    [\"tx-usecs-low\"]=\"\"\n    [\"pkt-rate-high\"]=\"\"\n    [\"rx-usecs-high\"]=\"\"\n    [\"tx-usecs-high\"]=\"\"\n    [\"sample-interval\"]=\"\"\n)\n\ndeclare -A EXPECTED_SETTINGS=(\n    [\"rx-frames-low\"]=\"\"\n    [\"tx-frames-low\"]=\"\"\n    [\"rx-frames-high\"]=\"\"\n    [\"tx-frames-high\"]=\"\"\n    [\"rx-usecs\"]=\"\"\n    [\"rx-frames\"]=\"\"\n    [\"rx-usecs-irq\"]=\"\"\n    [\"rx-frames-irq\"]=\"\"\n    [\"tx-usecs\"]=\"\"\n    [\"tx-frames\"]=\"\"\n    [\"tx-usecs-irq\"]=\"\"\n    [\"tx-frames-irq\"]=\"\"\n    [\"stats-block-usecs\"]=\"\"\n    [\"pkt-rate-low\"]=\"\"\n    [\"rx-usecs-low\"]=\"\"\n    [\"tx-usecs-low\"]=\"\"\n    [\"pkt-rate-high\"]=\"\"\n    [\"rx-usecs-high\"]=\"\"\n    [\"tx-usecs-high\"]=\"\"\n    [\"sample-interval\"]=\"\"\n)\n\n# populate the expected settings map\nfor key in ${!SETTINGS_MAP[@]}; do\n    EXPECTED_SETTINGS[$key]=$(get_value $key)\ndone\n\n# test\nfor key in ${!SETTINGS_MAP[@]}; do\n    value=$((RANDOM % $((2**32-1))))\n\n    ethtool -C $NSIM_NETDEV \"$key\" \"$value\"\n\n    EXPECTED_SETTINGS[$key]=\"$value\"\n    expected=${EXPECTED_SETTINGS[@]}\n    current=$(update_current_settings)\n\n    check $? \"$current\" \"$expected\"\n    set +x\ndone\n\n# bool settings which ethtool displays on the same line\nethtool -C $NSIM_NETDEV adaptive-rx on\ns=$(ethtool -c $NSIM_NETDEV | grep -q \"Adaptive RX: on  TX: off\")\ncheck $? \"$s\" \"\"\n\nethtool -C $NSIM_NETDEV adaptive-tx on\ns=$(ethtool -c $NSIM_NETDEV | grep -q \"Adaptive RX: on  TX: on\")\ncheck $? \"$s\" \"\"\n\nif [ $num_errors -eq 0 ]; then\n    echo \"PASSED all $((num_passes)) checks\"\n    exit 0\nelse\n    echo \"FAILED $num_errors/$((num_errors+num_passes)) checks\"\n    exit 1\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}