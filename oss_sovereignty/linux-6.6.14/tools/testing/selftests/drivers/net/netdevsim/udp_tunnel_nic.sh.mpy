{
  "module_name": "udp_tunnel_nic.sh",
  "hash_id": "83bae7bc5ca2f9712b000ec82e032ad5f071459534ce2e72d365dbaecb596c9c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/udp_tunnel_nic.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0-only\n\nVNI_GEN=$RANDOM\nNSIM_ID=$((RANDOM % 1024))\nNSIM_DEV_SYS=/sys/bus/netdevsim/devices/netdevsim$NSIM_ID\nNSIM_DEV_DFS=/sys/kernel/debug/netdevsim/netdevsim$NSIM_ID\nNSIM_NETDEV=\nHAS_ETHTOOL=\nSTATIC_ENTRIES=\nEXIT_STATUS=0\nnum_cases=0\nnum_errors=0\n\nclean_up_devs=( )\n\nfunction err_cnt {\n    echo \"ERROR:\" $@\n    EXIT_STATUS=1\n    ((num_errors++))\n    ((num_cases++))\n}\n\nfunction pass_cnt {\n    ((num_cases++))\n}\n\nfunction cleanup_tuns {\n    for dev in \"${clean_up_devs[@]}\"; do\n\t[ -e /sys/class/net/$dev ] && ip link del dev $dev\n    done\n    clean_up_devs=( )\n}\n\nfunction cleanup_nsim {\n    if [ -e $NSIM_DEV_SYS ]; then\n\techo $NSIM_ID > /sys/bus/netdevsim/del_device\n    fi\n}\n\nfunction cleanup {\n    cleanup_tuns\n    cleanup_nsim\n}\n\ntrap cleanup EXIT\n\nfunction new_vxlan {\n    local dev=$1\n    local dstport=$2\n    local lower=$3\n    local ipver=$4\n    local flags=$5\n\n    local group ipfl\n\n    [ \"$ipver\" != '6' ] && group=239.1.1.1 || group=fff1::1\n    [ \"$ipver\" != '6' ] || ipfl=\"-6\"\n\n    [[ ! \"$flags\" =~ \"external\" ]] && flags=\"$flags id $((VNI_GEN++))\"\n\n    ip $ipfl link add $dev type vxlan \\\n       group $group \\\n       dev $lower \\\n       dstport $dstport \\\n       $flags\n\n    ip link set dev $dev up\n\n    clean_up_devs=(\"${clean_up_devs[@]}\" $dev)\n\n    check_tables\n}\n\nfunction new_geneve {\n    local dev=$1\n    local dstport=$2\n    local ipver=$3\n    local flags=$4\n\n    local group ipfl\n\n    [ \"$ipver\" != '6' ] && remote=1.1.1.2 || group=::2\n    [ \"$ipver\" != '6' ] || ipfl=\"-6\"\n\n    [[ ! \"$flags\" =~ \"external\" ]] && flags=\"$flags vni $((VNI_GEN++))\"\n\n    ip $ipfl link add $dev type geneve \\\n       remote $remote  \\\n       dstport $dstport \\\n       $flags\n\n    ip link set dev $dev up\n\n    clean_up_devs=(\"${clean_up_devs[@]}\" $dev)\n\n    check_tables\n}\n\nfunction del_dev {\n    local dev=$1\n\n    ip link del dev $dev\n    check_tables\n}\n\n# Helpers for netdevsim port/type encoding\nfunction mke {\n    local port=$1\n    local type=$2\n\n    echo $((port << 16 | type))\n}\n\nfunction pre {\n    local val=$1\n\n    echo -e \"port: $((val >> 16))\\ttype: $((val & 0xffff))\"\n}\n\nfunction pre_ethtool {\n    local val=$1\n    local port=$((val >> 16))\n    local type=$((val & 0xffff))\n\n    case $type in\n\t1)\n\t    type_name=\"vxlan\"\n\t    ;;\n\t2)\n\t    type_name=\"geneve\"\n\t    ;;\n\t4)\n\t    type_name=\"vxlan-gpe\"\n\t    ;;\n\t*)\n\t    type_name=\"bit X\"\n\t    ;;\n    esac\n\n    echo \"port $port, $type_name\"\n}\n\nfunction check_table {\n    local path=$NSIM_DEV_DFS/ports/$port/udp_ports_table$1\n    local -n expected=$2\n    local last=$3\n\n    read -a have < $path\n\n    if [ ${#expected[@]} -ne ${#have[@]} ]; then\n\techo \"check_table: BAD NUMBER OF ITEMS\"\n\treturn 0\n    fi\n\n    for i in \"${!expected[@]}\"; do\n\tif [ -n \"$HAS_ETHTOOL\" -a ${expected[i]} -ne 0 ]; then\n\t    pp_expected=`pre_ethtool ${expected[i]}`\n\t    ethtool --show-tunnels $NSIM_NETDEV | grep \"$pp_expected\" >/dev/null\n\t    if [ $? -ne 0 -a $last -ne 0 ]; then\n\t\terr_cnt \"ethtool table $1 on port $port: $pfx - $msg\"\n\t\techo \"       check_table: ethtool does not contain '$pp_expected'\"\n\t\tethtool --show-tunnels $NSIM_NETDEV\n\t\treturn 0\n\n\t    fi\n\tfi\n\n\tif [ ${expected[i]} != ${have[i]} ]; then\n\t    if [ $last -ne 0 ]; then\n\t\terr_cnt \"table $1 on port $port: $pfx - $msg\"\n\t\techo \"       check_table: wrong entry $i\"\n\t\techo \"       expected: `pre ${expected[i]}`\"\n\t\techo \"       have:     `pre ${have[i]}`\"\n\t\treturn 0\n\t    fi\n\t    return 1\n\tfi\n    done\n\n    pass_cnt\n    return 0\n}\n\nfunction check_tables {\n    # Need retries in case we have workqueue making the changes\n    local retries=10\n\n    while ! check_table 0 exp0 $((retries == 0)); do\n\tsleep 0.02\n\t((retries--))\n    done\n    while ! check_table 1 exp1 $((retries == 0)); do\n\tsleep 0.02\n\t((retries--))\n    done\n\n    if [ -n \"$HAS_ETHTOOL\" -a -n \"${STATIC_ENTRIES[0]}\" ]; then\n\tfail=0\n\tfor i in \"${!STATIC_ENTRIES[@]}\"; do\n\t    pp_expected=`pre_ethtool ${STATIC_ENTRIES[i]}`\n\t    cnt=$(ethtool --show-tunnels $NSIM_NETDEV | grep -c \"$pp_expected\")\n\t    if [ $cnt -ne 1 ]; then\n\t\terr_cnt \"ethtool static entry: $pfx - $msg\"\n\t\techo \"       check_table: ethtool does not contain '$pp_expected'\"\n\t\tethtool --show-tunnels $NSIM_NETDEV\n\t\tfail=1\n\t    fi\n\tdone\n\t[ $fail == 0 ] && pass_cnt\n    fi\n}\n\nfunction print_table {\n    local path=$NSIM_DEV_DFS/ports/$port/udp_ports_table$1\n    read -a have < $path\n\n    tree $NSIM_DEV_DFS/\n\n    echo \"Port $port table $1:\"\n\n    for i in \"${!have[@]}\"; do\n\techo \"    `pre ${have[i]}`\"\n    done\n\n}\n\nfunction print_tables {\n    print_table 0\n    print_table 1\n}\n\nfunction get_netdev_name {\n    local -n old=$1\n\n    new=$(ls /sys/class/net)\n\n    for netdev in $new; do\n\tfor check in $old; do\n            [ $netdev == $check ] && break\n\tdone\n\n\tif [ $netdev != $check ]; then\n\t    echo $netdev\n\t    break\n\tfi\n    done\n}\n\n###\n### Code start\n###\n\n# Probe ethtool support\nethtool -h | grep show-tunnels 2>&1 >/dev/null && HAS_ETHTOOL=y\n\nmodprobe netdevsim\n\n# Basic test\npfx=\"basic\"\n\nfor port in 0 1; do\n    old_netdevs=$(ls /sys/class/net)\n    if [ $port -eq 0 ]; then\n\techo $NSIM_ID > /sys/bus/netdevsim/new_device\n    else\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n\techo 1 > $NSIM_DEV_SYS/new_port\n    fi\n    NSIM_NETDEV=`get_netdev_name old_netdevs`\n\n    msg=\"new NIC device created\"\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\n    check_tables\n\n    msg=\"VxLAN v4 devices\"\n    exp0=( `mke 4789 1` 0 0 0 )\n    new_vxlan vxlan0 4789 $NSIM_NETDEV\n    new_vxlan vxlan1 4789 $NSIM_NETDEV\n\n    msg=\"VxLAN v4 devices go down\"\n    exp0=( 0 0 0 0 )\n    ifconfig vxlan1 down\n    ifconfig vxlan0 down\n    check_tables\n\n    msg=\"VxLAN v6 devices\"\n    exp0=( `mke 4789 1` 0 0 0 )\n    new_vxlan vxlanA 4789 $NSIM_NETDEV 6\n\n    for ifc in vxlan0 vxlan1; do\n\tifconfig $ifc up\n    done\n\n    new_vxlan vxlanB 4789 $NSIM_NETDEV 6\n\n    msg=\"another VxLAN v6 devices\"\n    exp0=( `mke 4789 1` `mke 4790 1` 0 0 )\n    new_vxlan vxlanC 4790 $NSIM_NETDEV 6\n\n    msg=\"Geneve device\"\n    exp1=( `mke 6081 2` 0 0 0 )\n    new_geneve gnv0 6081\n\n    msg=\"NIC device goes down\"\n    ifconfig $NSIM_NETDEV down\n    if [ $port -eq 1 ]; then\n\texp0=( 0 0 0 0 )\n\texp1=( 0 0 0 0 )\n    fi\n    check_tables\n    msg=\"NIC device goes up again\"\n    ifconfig $NSIM_NETDEV up\n    exp0=( `mke 4789 1` `mke 4790 1` 0 0 )\n    exp1=( `mke 6081 2` 0 0 0 )\n    check_tables\n\n    cleanup_tuns\n\n    msg=\"tunnels destroyed\"\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\n    check_tables\n\n    modprobe -r geneve\n    modprobe -r vxlan\n    modprobe -r udp_tunnel\n\n    check_tables\ndone\n\nmodprobe -r netdevsim\n\n# Module tests\npfx=\"module tests\"\n\nif modinfo netdevsim | grep udp_tunnel >/dev/null; then\n    err_cnt \"netdevsim depends on udp_tunnel\"\nelse\n    pass_cnt\nfi\n\nmodprobe netdevsim\n\nold_netdevs=$(ls /sys/class/net)\nport=0\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\necho 1000 > $NSIM_DEV_DFS/udp_ports_sleep\necho 0 > $NSIM_DEV_SYS/new_port\nNSIM_NETDEV=`get_netdev_name old_netdevs`\n\nmsg=\"create VxLANs\"\nexp0=( 0 0 0 0 ) # sleep is longer than out wait\nnew_vxlan vxlan0 10000 $NSIM_NETDEV\n\nmodprobe -r vxlan\nmodprobe -r udp_tunnel\n\nmsg=\"remove tunnels\"\nexp0=( 0 0 0 0 )\ncheck_tables\n\nmsg=\"create VxLANs\"\nexp0=( 0 0 0 0 ) # sleep is longer than out wait\nnew_vxlan vxlan0 10000 $NSIM_NETDEV\n\nexp0=( 0 0 0 0 )\n\nmodprobe -r netdevsim\nmodprobe netdevsim\n\n# Overflow the table\n\nfunction overflow_table0 {\n    local pfx=$1\n\n    msg=\"create VxLANs 1/5\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    msg=\"create VxLANs 2/5\"\n    exp0=( `mke 10000 1` `mke 10001 1` 0 0 )\n    new_vxlan vxlan1 10001 $NSIM_NETDEV\n\n    msg=\"create VxLANs 3/5\"\n    exp0=( `mke 10000 1` `mke 10001 1` `mke 10002 1` 0 )\n    new_vxlan vxlan2 10002 $NSIM_NETDEV\n\n    msg=\"create VxLANs 4/5\"\n    exp0=( `mke 10000 1` `mke 10001 1` `mke 10002 1` `mke 10003 1` )\n    new_vxlan vxlan3 10003 $NSIM_NETDEV\n\n    msg=\"create VxLANs 5/5\"\n    new_vxlan vxlan4 10004 $NSIM_NETDEV\n}\n\nfunction overflow_table1 {\n    local pfx=$1\n\n    msg=\"create GENEVE 1/5\"\n    exp1=( `mke 20000 2` 0 0 0 )\n    new_geneve gnv0 20000\n\n    msg=\"create GENEVE 2/5\"\n    exp1=( `mke 20000 2` `mke 20001 2` 0 0 )\n    new_geneve gnv1 20001\n\n    msg=\"create GENEVE 3/5\"\n    exp1=( `mke 20000 2` `mke 20001 2` `mke 20002 2` 0 )\n    new_geneve gnv2 20002\n\n    msg=\"create GENEVE 4/5\"\n    exp1=( `mke 20000 2` `mke 20001 2` `mke 20002 2` `mke 20003 2` )\n    new_geneve gnv3 20003\n\n    msg=\"create GENEVE 5/5\"\n    new_geneve gnv4 20004\n}\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    overflow_table0 \"overflow NIC table\"\n    overflow_table1 \"overflow NIC table\"\n\n    msg=\"replace VxLAN in overflow table\"\n    exp0=( `mke 10000 1` `mke 10004 1` `mke 10002 1` `mke 10003 1` )\n    del_dev vxlan1\n\n    msg=\"vacate VxLAN in overflow table\"\n    exp0=( `mke 10000 1` `mke 10004 1` 0 `mke 10003 1` )\n    del_dev vxlan2\n\n    msg=\"replace GENEVE in overflow table\"\n    exp1=( `mke 20000 2` `mke 20004 2` `mke 20002 2` `mke 20003 2` )\n    del_dev gnv1\n\n    msg=\"vacate GENEVE in overflow table\"\n    exp1=( `mke 20000 2` `mke 20004 2` 0 `mke 20003 2` )\n    del_dev gnv2\n\n    msg=\"table sharing - share\"\n    exp1=( `mke 20000 2` `mke 20004 2` `mke 30001 4` `mke 20003 2` )\n    new_vxlan vxlanG0 30001 $NSIM_NETDEV 4 \"gpe external\"\n\n    msg=\"table sharing - overflow\"\n    new_vxlan vxlanG1 30002 $NSIM_NETDEV 4 \"gpe external\"\n    msg=\"table sharing - overflow v6\"\n    new_vxlan vxlanG2 30002 $NSIM_NETDEV 6 \"gpe external\"\n\n    exp1=( `mke 20000 2` `mke 30002 4` `mke 30001 4` `mke 20003 2` )\n    del_dev gnv4\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# Sync all\npfx=\"sync all\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\necho 1 > $NSIM_DEV_DFS/udp_ports_sync_all\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    overflow_table0 \"overflow NIC table\"\n    overflow_table1 \"overflow NIC table\"\n\n    msg=\"replace VxLAN in overflow table\"\n    exp0=( `mke 10000 1` `mke 10004 1` `mke 10002 1` `mke 10003 1` )\n    del_dev vxlan1\n\n    msg=\"vacate VxLAN in overflow table\"\n    exp0=( `mke 10000 1` `mke 10004 1` 0 `mke 10003 1` )\n    del_dev vxlan2\n\n    msg=\"replace GENEVE in overflow table\"\n    exp1=( `mke 20000 2` `mke 20004 2` `mke 20002 2` `mke 20003 2` )\n    del_dev gnv1\n\n    msg=\"vacate GENEVE in overflow table\"\n    exp1=( `mke 20000 2` `mke 20004 2` 0 `mke 20003 2` )\n    del_dev gnv2\n\n    msg=\"table sharing - share\"\n    exp1=( `mke 20000 2` `mke 20004 2` `mke 30001 4` `mke 20003 2` )\n    new_vxlan vxlanG0 30001 $NSIM_NETDEV 4 \"gpe external\"\n\n    msg=\"table sharing - overflow\"\n    new_vxlan vxlanG1 30002 $NSIM_NETDEV 4 \"gpe external\"\n    msg=\"table sharing - overflow v6\"\n    new_vxlan vxlanG2 30002 $NSIM_NETDEV 6 \"gpe external\"\n\n    exp1=( `mke 20000 2` `mke 30002 4` `mke 30001 4` `mke 20003 2` )\n    del_dev gnv4\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# Destroy full NIC\npfx=\"destroy full\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    overflow_table0 \"destroy NIC\"\n    overflow_table1 \"destroy NIC\"\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# IPv4 only\npfx=\"IPv4 only\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\necho 1 > $NSIM_DEV_DFS/udp_ports_ipv4_only\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    msg=\"create VxLANs v6\"\n    new_vxlan vxlanA0 10000 $NSIM_NETDEV 6\n\n    msg=\"create VxLANs v6\"\n    new_vxlan vxlanA1 10000 $NSIM_NETDEV 6\n\n    ip link set dev vxlanA0 down\n    ip link set dev vxlanA0 up\n    check_tables\n\n    msg=\"create VxLANs v4\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    msg=\"down VxLANs v4\"\n    exp0=( 0 0 0 0 )\n    ip link set dev vxlan0 down\n    check_tables\n\n    msg=\"up VxLANs v4\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    ip link set dev vxlan0 up\n    check_tables\n\n    msg=\"destroy VxLANs v4\"\n    exp0=( 0 0 0 0 )\n    del_dev vxlan0\n\n    msg=\"recreate VxLANs v4\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    del_dev vxlanA0\n    del_dev vxlanA1\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# Failures\npfx=\"error injection\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    echo 110 > $NSIM_DEV_DFS/ports/$port/udp_ports_inject_error\n\n    msg=\"1 - create VxLANs v6\"\n    exp0=( 0 0 0 0 )\n    new_vxlan vxlanA0 10000 $NSIM_NETDEV 6\n\n    msg=\"1 - create VxLANs v4\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    msg=\"1 - remove VxLANs v4\"\n    del_dev vxlan0\n\n    msg=\"1 - remove VxLANs v6\"\n    exp0=( 0 0 0 0 )\n    del_dev vxlanA0\n\n    msg=\"2 - create GENEVE\"\n    exp1=( `mke 20000 2` 0 0 0 )\n    new_geneve gnv0 20000\n\n    msg=\"2 - destroy GENEVE\"\n    echo 2 > $NSIM_DEV_DFS/ports/$port/udp_ports_inject_error\n    exp1=( `mke 20000 2` 0 0 0 )\n    del_dev gnv0\n\n    msg=\"2 - create second GENEVE\"\n    exp1=( 0 `mke 20001 2` 0 0 )\n    new_geneve gnv0 20001\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# netdev flags\npfx=\"netdev flags\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    msg=\"create VxLANs v6\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    new_vxlan vxlanA0 10000 $NSIM_NETDEV 6\n\n    msg=\"create VxLANs v4\"\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    msg=\"turn off\"\n    exp0=( 0 0 0 0 )\n    ethtool -K $NSIM_NETDEV rx-udp_tunnel-port-offload off\n    check_tables\n\n    msg=\"turn on\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    ethtool -K $NSIM_NETDEV rx-udp_tunnel-port-offload on\n    check_tables\n\n    msg=\"remove both\"\n    del_dev vxlanA0\n    exp0=( 0 0 0 0 )\n    del_dev vxlan0\n    check_tables\n\n    ethtool -K $NSIM_NETDEV rx-udp_tunnel-port-offload off\n\n    msg=\"create VxLANs v4 - off\"\n    exp0=( 0 0 0 0 )\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    msg=\"created off - turn on\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    ethtool -K $NSIM_NETDEV rx-udp_tunnel-port-offload on\n    check_tables\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# device initiated reset\npfx=\"reset notification\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\nfor port in 0 1; do\n    if [ $port -ne 0 ]; then\n\techo 1 > $NSIM_DEV_DFS/udp_ports_open_only\n\techo 1 > $NSIM_DEV_DFS/udp_ports_sleep\n    fi\n\n    echo $port > $NSIM_DEV_SYS/new_port\n    ifconfig $NSIM_NETDEV up\n\n    msg=\"create VxLANs v6\"\n    exp0=( `mke 10000 1` 0 0 0 )\n    new_vxlan vxlanA0 10000 $NSIM_NETDEV 6\n\n    msg=\"create VxLANs v4\"\n    new_vxlan vxlan0 10000 $NSIM_NETDEV\n\n    echo 1 > $NSIM_DEV_DFS/ports/$port/udp_ports_reset\n    check_tables\n\n    msg=\"NIC device goes down\"\n    ifconfig $NSIM_NETDEV down\n    if [ $port -eq 1 ]; then\n\texp0=( 0 0 0 0 )\n\texp1=( 0 0 0 0 )\n    fi\n    check_tables\n\n    echo 1 > $NSIM_DEV_DFS/ports/$port/udp_ports_reset\n    check_tables\n\n    msg=\"NIC device goes up again\"\n    ifconfig $NSIM_NETDEV up\n    exp0=( `mke 10000 1` 0 0 0 )\n    check_tables\n\n    msg=\"remove both\"\n    del_dev vxlanA0\n    exp0=( 0 0 0 0 )\n    del_dev vxlan0\n    check_tables\n\n    echo 1 > $NSIM_DEV_DFS/ports/$port/udp_ports_reset\n    check_tables\n\n    msg=\"destroy NIC\"\n    echo $port > $NSIM_DEV_SYS/del_port\n\n    cleanup_tuns\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\ndone\n\ncleanup_nsim\n\n# shared port tables\npfx=\"table sharing\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\necho 0 > $NSIM_DEV_DFS/udp_ports_open_only\necho 1 > $NSIM_DEV_DFS/udp_ports_sleep\necho 1 > $NSIM_DEV_DFS/udp_ports_shared\n\nold_netdevs=$(ls /sys/class/net)\necho 1 > $NSIM_DEV_SYS/new_port\nNSIM_NETDEV=`get_netdev_name old_netdevs`\nold_netdevs=$(ls /sys/class/net)\necho 2 > $NSIM_DEV_SYS/new_port\nNSIM_NETDEV2=`get_netdev_name old_netdevs`\n\nmsg=\"VxLAN v4 devices\"\nexp0=( `mke 4789 1` 0 0 0 )\nexp1=( 0 0 0 0 )\nnew_vxlan vxlan0 4789 $NSIM_NETDEV\nnew_vxlan vxlan1 4789 $NSIM_NETDEV2\n\nmsg=\"VxLAN v4 devices go down\"\nexp0=( 0 0 0 0 )\nifconfig vxlan1 down\nifconfig vxlan0 down\ncheck_tables\n\nfor ifc in vxlan0 vxlan1; do\n    ifconfig $ifc up\ndone\n\nmsg=\"VxLAN v6 device\"\nexp0=( `mke 4789 1` `mke 4790 1` 0 0 )\nnew_vxlan vxlanC 4790 $NSIM_NETDEV 6\n\nmsg=\"Geneve device\"\nexp1=( `mke 6081 2` 0 0 0 )\nnew_geneve gnv0 6081\n\nmsg=\"NIC device goes down\"\nifconfig $NSIM_NETDEV down\ncheck_tables\n\nmsg=\"NIC device goes up again\"\nifconfig $NSIM_NETDEV up\ncheck_tables\n\nfor i in `seq 2`; do\n    msg=\"turn feature off - 1, rep $i\"\n    ethtool -K $NSIM_NETDEV rx-udp_tunnel-port-offload off\n    check_tables\n\n    msg=\"turn feature off - 2, rep $i\"\n    exp0=( 0 0 0 0 )\n    exp1=( 0 0 0 0 )\n    ethtool -K $NSIM_NETDEV2 rx-udp_tunnel-port-offload off\n    check_tables\n\n    msg=\"turn feature on - 1, rep $i\"\n    exp0=( `mke 4789 1` `mke 4790 1` 0 0 )\n    exp1=( `mke 6081 2` 0 0 0 )\n    ethtool -K $NSIM_NETDEV rx-udp_tunnel-port-offload on\n    check_tables\n\n    msg=\"turn feature on - 2, rep $i\"\n    ethtool -K $NSIM_NETDEV2 rx-udp_tunnel-port-offload on\n    check_tables\ndone\n\nmsg=\"tunnels destroyed 1\"\ncleanup_tuns\nexp0=( 0 0 0 0 )\nexp1=( 0 0 0 0 )\ncheck_tables\n\noverflow_table0 \"overflow NIC table\"\n\nmsg=\"re-add a port\"\n\necho 2 > $NSIM_DEV_SYS/del_port\necho 2 > $NSIM_DEV_SYS/new_port\ncheck_tables\n\nmsg=\"replace VxLAN in overflow table\"\nexp0=( `mke 10000 1` `mke 10004 1` `mke 10002 1` `mke 10003 1` )\ndel_dev vxlan1\n\nmsg=\"vacate VxLAN in overflow table\"\nexp0=( `mke 10000 1` `mke 10004 1` 0 `mke 10003 1` )\ndel_dev vxlan2\n\necho 1 > $NSIM_DEV_DFS/ports/$port/udp_ports_reset\ncheck_tables\n\nmsg=\"tunnels destroyed 2\"\ncleanup_tuns\nexp0=( 0 0 0 0 )\nexp1=( 0 0 0 0 )\ncheck_tables\n\necho 1 > $NSIM_DEV_SYS/del_port\necho 2 > $NSIM_DEV_SYS/del_port\n\ncleanup_nsim\n\n# Static IANA port\npfx=\"static IANA vxlan\"\n\necho $NSIM_ID > /sys/bus/netdevsim/new_device\necho 0 > $NSIM_DEV_SYS/del_port\n\necho 1 > $NSIM_DEV_DFS/udp_ports_static_iana_vxlan\nSTATIC_ENTRIES=( `mke 4789 1` )\n\nport=1\nold_netdevs=$(ls /sys/class/net)\necho $port > $NSIM_DEV_SYS/new_port\nNSIM_NETDEV=`get_netdev_name old_netdevs`\n\nmsg=\"check empty\"\nexp0=( 0 0 0 0 )\nexp1=( 0 0 0 0 )\ncheck_tables\n\nmsg=\"add on static port\"\nnew_vxlan vxlan0 4789 $NSIM_NETDEV\nnew_vxlan vxlan1 4789 $NSIM_NETDEV\n\nmsg=\"add on different port\"\nexp0=( `mke 4790 1` 0 0 0 )\nnew_vxlan vxlan2 4790 $NSIM_NETDEV\n\ncleanup_tuns\n\nmsg=\"tunnels destroyed\"\nexp0=( 0 0 0 0 )\nexp1=( 0 0 0 0 )\ncheck_tables\n\nmsg=\"different type\"\nnew_geneve gnv0\t4789\n\ncleanup_tuns\ncleanup_nsim\n\n# END\n\nmodprobe -r netdevsim\n\nif [ $num_errors -eq 0 ]; then\n    echo \"PASSED all $num_cases checks\"\nelse\n    echo \"FAILED $num_errors/$num_cases checks\"\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}