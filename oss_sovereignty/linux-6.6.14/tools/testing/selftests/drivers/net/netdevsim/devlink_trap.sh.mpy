{
  "module_name": "devlink_trap.sh",
  "hash_id": "f55b12727c09d3fca95c4b0dc3be2d6e7cc58b9db22c8e6bb6f9ecbd045e1758",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/devlink_trap.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking devlink-trap functionality. It makes use of\n# netdevsim which implements the required callbacks.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tinit_test\n\ttrap_action_test\n\ttrap_metadata_test\n\tbad_trap_test\n\tbad_trap_action_test\n\ttrap_stats_test\n\ttrap_group_action_test\n\tbad_trap_group_test\n\ttrap_group_stats_test\n\ttrap_policer_test\n\ttrap_policer_bind_test\n\tport_del_test\n\tdev_del_test\n\"\nNETDEVSIM_PATH=/sys/bus/netdevsim/\nDEV_ADDR=1337\nDEV=netdevsim${DEV_ADDR}\nDEBUGFS_DIR=/sys/kernel/debug/netdevsim/$DEV/\nSLEEP_TIME=1\nNETDEV=\"\"\nNUM_NETIFS=0\nsource $lib_dir/lib.sh\n\nDEVLINK_DEV=\nsource $lib_dir/devlink_lib.sh\nDEVLINK_DEV=netdevsim/${DEV}\n\nrequire_command udevadm\n\nmodprobe netdevsim &> /dev/null\nif [ ! -d \"$NETDEVSIM_PATH\" ]; then\n\techo \"SKIP: No netdevsim support\"\n\texit 1\nfi\n\nif [ -d \"${NETDEVSIM_PATH}/devices/netdevsim${DEV_ADDR}\" ]; then\n\techo \"SKIP: Device netdevsim${DEV_ADDR} already exists\"\n\texit 1\nfi\n\ncheck_netdev_down()\n{\n\tstate=$(cat /sys/class/net/${NETDEV}/flags)\n\n\tif [ $((state & 1)) -ne 0 ]; then\n\t\techo \"WARNING: unexpected interface UP, disable NetworkManager?\"\n\n\t\tip link set dev $NETDEV down\n\tfi\n}\n\ninit_test()\n{\n\tRET=0\n\n\ttest $(devlink_traps_num_get) -ne 0\n\tcheck_err $? \"No traps were registered\"\n\n\tlog_test \"Initialization\"\n}\n\ntrap_action_test()\n{\n\tlocal orig_action\n\tlocal trap_name\n\tlocal action\n\n\tRET=0\n\n\tfor trap_name in $(devlink_traps_get); do\n\t\t# The action of non-drop traps cannot be changed.\n\t\tif [ $(devlink_trap_type_get $trap_name) = \"drop\" ]; then\n\t\t\tdevlink_trap_action_set $trap_name \"trap\"\n\t\t\taction=$(devlink_trap_action_get $trap_name)\n\t\t\tif [ $action != \"trap\" ]; then\n\t\t\t\tcheck_err 1 \"Trap $trap_name did not change action to trap\"\n\t\t\tfi\n\n\t\t\tdevlink_trap_action_set $trap_name \"drop\"\n\t\t\taction=$(devlink_trap_action_get $trap_name)\n\t\t\tif [ $action != \"drop\" ]; then\n\t\t\t\tcheck_err 1 \"Trap $trap_name did not change action to drop\"\n\t\t\tfi\n\t\telse\n\t\t\torig_action=$(devlink_trap_action_get $trap_name)\n\n\t\t\tdevlink_trap_action_set $trap_name \"trap\"\n\t\t\taction=$(devlink_trap_action_get $trap_name)\n\t\t\tif [ $action != $orig_action ]; then\n\t\t\t\tcheck_err 1 \"Trap $trap_name changed action when should not\"\n\t\t\tfi\n\n\t\t\tdevlink_trap_action_set $trap_name \"drop\"\n\t\t\taction=$(devlink_trap_action_get $trap_name)\n\t\t\tif [ $action != $orig_action ]; then\n\t\t\t\tcheck_err 1 \"Trap $trap_name changed action when should not\"\n\t\t\tfi\n\t\tfi\n\tdone\n\n\tlog_test \"Trap action\"\n}\n\ntrap_metadata_test()\n{\n\tlocal trap_name\n\n\tRET=0\n\n\tfor trap_name in $(devlink_traps_get); do\n\t\tdevlink_trap_metadata_test $trap_name \"input_port\"\n\t\tcheck_err $? \"Input port not reported as metadata of trap $trap_name\"\n\t\tif [ $trap_name == \"ingress_flow_action_drop\" ] ||\n\t\t   [ $trap_name == \"egress_flow_action_drop\" ]; then\n\t\t\tdevlink_trap_metadata_test $trap_name \"flow_action_cookie\"\n\t\t\tcheck_err $? \"Flow action cookie not reported as metadata of trap $trap_name\"\n\t\tfi\n\tdone\n\n\tlog_test \"Trap metadata\"\n}\n\nbad_trap_test()\n{\n\tRET=0\n\n\tdevlink_trap_action_set \"made_up_trap\" \"drop\"\n\tcheck_fail $? \"Did not get an error for non-existing trap\"\n\n\tlog_test \"Non-existing trap\"\n}\n\nbad_trap_action_test()\n{\n\tlocal traps_arr\n\tlocal trap_name\n\n\tRET=0\n\n\t# Pick first trap.\n\ttraps_arr=($(devlink_traps_get))\n\ttrap_name=${traps_arr[0]}\n\n\tdevlink_trap_action_set $trap_name \"made_up_action\"\n\tcheck_fail $? \"Did not get an error for non-existing trap action\"\n\n\tlog_test \"Non-existing trap action\"\n}\n\ntrap_stats_test()\n{\n\tlocal trap_name\n\n\tRET=0\n\n\tcheck_netdev_down\n\tfor trap_name in $(devlink_traps_get); do\n\t\tdevlink_trap_stats_idle_test $trap_name\n\t\tcheck_err $? \"Stats of trap $trap_name not idle when netdev down\"\n\n\t\tip link set dev $NETDEV up\n\n\t\tif [ $(devlink_trap_type_get $trap_name) = \"drop\" ]; then\n\t\t\tdevlink_trap_action_set $trap_name \"trap\"\n\t\t\tdevlink_trap_stats_idle_test $trap_name\n\t\t\tcheck_fail $? \"Stats of trap $trap_name idle when action is trap\"\n\n\t\t\tdevlink_trap_action_set $trap_name \"drop\"\n\t\t\tdevlink_trap_stats_idle_test $trap_name\n\t\t\tcheck_err $? \"Stats of trap $trap_name not idle when action is drop\"\n\n\t\t\techo \"y\"> $DEBUGFS_DIR/fail_trap_drop_counter_get\n\t\t\tdevlink -s trap show $DEVLINK_DEV trap $trap_name &> /dev/null\n\t\t\tcheck_fail $? \"Managed to read trap (hard dropped) statistics when should not\"\n\t\t\techo \"n\"> $DEBUGFS_DIR/fail_trap_drop_counter_get\n\t\t\tdevlink -s trap show $DEVLINK_DEV trap $trap_name &> /dev/null\n\t\t\tcheck_err $? \"Did not manage to read trap (hard dropped) statistics when should\"\n\n\t\t\tdevlink_trap_drop_stats_idle_test $trap_name\n\t\t\tcheck_fail $? \"Drop stats of trap $trap_name idle when should not\"\n\t\telse\n\t\t\tdevlink_trap_stats_idle_test $trap_name\n\t\t\tcheck_fail $? \"Stats of non-drop trap $trap_name idle when should not\"\n\t\tfi\n\n\t\tip link set dev $NETDEV down\n\tdone\n\n\tlog_test \"Trap statistics\"\n}\n\ntrap_group_action_test()\n{\n\tlocal curr_group group_name\n\tlocal trap_name\n\tlocal trap_type\n\tlocal action\n\n\tRET=0\n\n\tfor group_name in $(devlink_trap_groups_get); do\n\t\tdevlink_trap_group_action_set $group_name \"trap\"\n\n\t\tfor trap_name in $(devlink_traps_get); do\n\t\t\tcurr_group=$(devlink_trap_group_get $trap_name)\n\t\t\tif [ $curr_group != $group_name ]; then\n\t\t\t\tcontinue\n\t\t\tfi\n\n\t\t\ttrap_type=$(devlink_trap_type_get $trap_name)\n\t\t\tif [ $trap_type != \"drop\" ]; then\n\t\t\t\tcontinue\n\t\t\tfi\n\n\t\t\taction=$(devlink_trap_action_get $trap_name)\n\t\t\tif [ $action != \"trap\" ]; then\n\t\t\t\tcheck_err 1 \"Trap $trap_name did not change action to trap\"\n\t\t\tfi\n\t\tdone\n\n\t\tdevlink_trap_group_action_set $group_name \"drop\"\n\n\t\tfor trap_name in $(devlink_traps_get); do\n\t\t\tcurr_group=$(devlink_trap_group_get $trap_name)\n\t\t\tif [ $curr_group != $group_name ]; then\n\t\t\t\tcontinue\n\t\t\tfi\n\n\t\t\ttrap_type=$(devlink_trap_type_get $trap_name)\n\t\t\tif [ $trap_type != \"drop\" ]; then\n\t\t\t\tcontinue\n\t\t\tfi\n\n\t\t\taction=$(devlink_trap_action_get $trap_name)\n\t\t\tif [ $action != \"drop\" ]; then\n\t\t\t\tcheck_err 1 \"Trap $trap_name did not change action to drop\"\n\t\t\tfi\n\t\tdone\n\tdone\n\n\tlog_test \"Trap group action\"\n}\n\nbad_trap_group_test()\n{\n\tRET=0\n\n\tdevlink_trap_group_action_set \"made_up_trap_group\" \"drop\"\n\tcheck_fail $? \"Did not get an error for non-existing trap group\"\n\n\tlog_test \"Non-existing trap group\"\n}\n\ntrap_group_stats_test()\n{\n\tlocal group_name\n\n\tRET=0\n\n\tcheck_netdev_down\n\tfor group_name in $(devlink_trap_groups_get); do\n\t\tdevlink_trap_group_stats_idle_test $group_name\n\t\tcheck_err $? \"Stats of trap group $group_name not idle when netdev down\"\n\n\t\tip link set dev $NETDEV up\n\n\t\tdevlink_trap_group_action_set $group_name \"trap\"\n\t\tdevlink_trap_group_stats_idle_test $group_name\n\t\tcheck_fail $? \"Stats of trap group $group_name idle when action is trap\"\n\n\t\tdevlink_trap_group_action_set $group_name \"drop\"\n\t\tip link set dev $NETDEV down\n\tdone\n\n\tlog_test \"Trap group statistics\"\n}\n\ntrap_policer_test()\n{\n\tlocal packets_t0\n\tlocal packets_t1\n\n\tRET=0\n\n\tif [ $(devlink_trap_policers_num_get) -eq 0 ]; then\n\t\tcheck_err 1 \"Failed to dump policers\"\n\tfi\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1337 &> /dev/null\n\tcheck_fail $? \"Did not get an error for setting a non-existing policer\"\n\tdevlink trap policer show $DEVLINK_DEV policer 1337 &> /dev/null\n\tcheck_fail $? \"Did not get an error for getting a non-existing policer\"\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 2000 burst 16\n\tcheck_err $? \"Failed to set valid parameters for a valid policer\"\n\tif [ $(devlink_trap_policer_rate_get 1) -ne 2000 ]; then\n\t\tcheck_err 1 \"Policer rate was not changed\"\n\tfi\n\tif [ $(devlink_trap_policer_burst_get 1) -ne 16 ]; then\n\t\tcheck_err 1 \"Policer burst size was not changed\"\n\tfi\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 0 &> /dev/null\n\tcheck_fail $? \"Policer rate was changed to rate lower than limit\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 9000 &> /dev/null\n\tcheck_fail $? \"Policer rate was changed to rate higher than limit\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 burst 2 &> /dev/null\n\tcheck_fail $? \"Policer burst size was changed to burst size lower than limit\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 65537 &> /dev/null\n\tcheck_fail $? \"Policer burst size was changed to burst size higher than limit\"\n\techo \"y\" > $DEBUGFS_DIR/fail_trap_policer_set\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 3000 &> /dev/null\n\tcheck_fail $? \"Managed to set policer rate when should not\"\n\techo \"n\" > $DEBUGFS_DIR/fail_trap_policer_set\n\tif [ $(devlink_trap_policer_rate_get 1) -ne 2000 ]; then\n\t\tcheck_err 1 \"Policer rate was changed to an invalid value\"\n\tfi\n\tif [ $(devlink_trap_policer_burst_get 1) -ne 16 ]; then\n\t\tcheck_err 1 \"Policer burst size was changed to an invalid value\"\n\tfi\n\n\tpackets_t0=$(devlink_trap_policer_rx_dropped_get 1)\n\tsleep .5\n\tpackets_t1=$(devlink_trap_policer_rx_dropped_get 1)\n\tif [ ! $packets_t1 -gt $packets_t0 ]; then\n\t\tcheck_err 1 \"Policer drop counter was not incremented\"\n\tfi\n\n\techo \"y\"> $DEBUGFS_DIR/fail_trap_policer_counter_get\n\tdevlink -s trap policer show $DEVLINK_DEV policer 1 &> /dev/null\n\tcheck_fail $? \"Managed to read policer drop counter when should not\"\n\techo \"n\"> $DEBUGFS_DIR/fail_trap_policer_counter_get\n\tdevlink -s trap policer show $DEVLINK_DEV policer 1 &> /dev/null\n\tcheck_err $? \"Did not manage to read policer drop counter when should\"\n\n\tlog_test \"Trap policer\"\n}\n\ntrap_group_check_policer()\n{\n\tlocal group_name=$1; shift\n\n\tdevlink -j -p trap group show $DEVLINK_DEV group $group_name \\\n\t\t| jq -e '.[][][][\"policer\"]' &> /dev/null\n}\n\ntrap_policer_bind_test()\n{\n\tRET=0\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 1\n\tcheck_err $? \"Failed to bind a valid policer\"\n\tif [ $(devlink_trap_group_policer_get \"l2_drops\") -ne 1 ]; then\n\t\tcheck_err 1 \"Bound policer was not changed\"\n\tfi\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 1337 \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Did not get an error for binding a non-existing policer\"\n\tif [ $(devlink_trap_group_policer_get \"l2_drops\") -ne 1 ]; then\n\t\tcheck_err 1 \"Bound policer was changed when should not\"\n\tfi\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 0\n\tcheck_err $? \"Failed to unbind a policer when using ID 0\"\n\ttrap_group_check_policer \"l2_drops\"\n\tcheck_fail $? \"Trap group has a policer after unbinding with ID 0\"\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 1\n\tcheck_err $? \"Failed to bind a valid policer\"\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops nopolicer\n\tcheck_err $? \"Failed to unbind a policer when using 'nopolicer' keyword\"\n\ttrap_group_check_policer \"l2_drops\"\n\tcheck_fail $? \"Trap group has a policer after unbinding with 'nopolicer' keyword\"\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 1\n\tcheck_err $? \"Failed to bind a valid policer\"\n\n\techo \"y\"> $DEBUGFS_DIR/fail_trap_group_set\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 2 \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to bind a policer when should not\"\n\techo \"n\"> $DEBUGFS_DIR/fail_trap_group_set\n\tdevlink trap group set $DEVLINK_DEV group l2_drops policer 2\n\tcheck_err $? \"Did not manage to bind a policer when should\"\n\n\tdevlink trap group set $DEVLINK_DEV group l2_drops action drop \\\n\t\tpolicer 1337 &> /dev/null\n\tcheck_fail $? \"Did not get an error for partially modified trap group\"\n\n\tlog_test \"Trap policer binding\"\n}\n\nport_del_test()\n{\n\tlocal group_name\n\tlocal i\n\n\t# The test never fails. It is meant to exercise different code paths\n\t# and make sure we properly dismantle a port while packets are\n\t# in-flight.\n\tRET=0\n\n\tdevlink_traps_enable_all\n\n\tfor i in $(seq 1 10); do\n\t\tip link set dev $NETDEV up\n\n\t\tsleep $SLEEP_TIME\n\n\t\tnetdevsim_port_destroy\n\t\tnetdevsim_port_create\n\t\tudevadm settle\n\tdone\n\n\tdevlink_traps_disable_all\n\n\tlog_test \"Port delete\"\n}\n\ndev_del_test()\n{\n\tlocal group_name\n\tlocal i\n\n\t# The test never fails. It is meant to exercise different code paths\n\t# and make sure we properly unregister traps while packets are\n\t# in-flight.\n\tRET=0\n\n\tdevlink_traps_enable_all\n\n\tfor i in $(seq 1 10); do\n\t\tip link set dev $NETDEV up\n\n\t\tsleep $SLEEP_TIME\n\n\t\tcleanup\n\t\tsetup_prepare\n\tdone\n\n\tdevlink_traps_disable_all\n\n\tlog_test \"Device delete\"\n}\n\nnetdevsim_dev_create()\n{\n\techo \"$DEV_ADDR 0\" > ${NETDEVSIM_PATH}/new_device\n}\n\nnetdevsim_dev_destroy()\n{\n\techo \"$DEV_ADDR\" > ${NETDEVSIM_PATH}/del_device\n}\n\nnetdevsim_port_create()\n{\n\techo 1 > ${NETDEVSIM_PATH}/devices/${DEV}/new_port\n}\n\nnetdevsim_port_destroy()\n{\n\techo 1 > ${NETDEVSIM_PATH}/devices/${DEV}/del_port\n}\n\nsetup_prepare()\n{\n\tlocal netdev\n\n\tnetdevsim_dev_create\n\n\tif [ ! -d \"${NETDEVSIM_PATH}/devices/${DEV}\" ]; then\n\t\techo \"Failed to create netdevsim device\"\n\t\texit 1\n\tfi\n\n\tnetdevsim_port_create\n\n\tif [ ! -d \"${NETDEVSIM_PATH}/devices/${DEV}/net/\" ]; then\n\t\techo \"Failed to create netdevsim port\"\n\t\texit 1\n\tfi\n\n\t# Wait for udev to rename newly created netdev.\n\tudevadm settle\n\n\tNETDEV=$(ls ${NETDEVSIM_PATH}/devices/${DEV}/net/)\n}\n\ncleanup()\n{\n\tpre_cleanup\n\tnetdevsim_port_destroy\n\tnetdevsim_dev_destroy\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}