{
  "module_name": "hw_stats_l3.sh",
  "hash_id": "40b894f87eb1f99cca7be3429522ea320ef5ec9c25a73d42dd000f6954639060",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/hw_stats_l3.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tl3_reporting_test\n\tl3_fail_next_test\n\tl3_counter_test\n\tl3_rollback_test\n\tl3_monitor_test\n\"\n\nNETDEVSIM_PATH=/sys/bus/netdevsim/\nDEV_ADDR_1=1337\nDEV_ADDR_2=1057\nDEV_ADDR_3=5417\nNUM_NETIFS=0\nsource $lib_dir/lib.sh\n\nDUMMY_IFINDEX=\n\nDEV_ADDR()\n{\n\tlocal n=$1; shift\n\tlocal var=DEV_ADDR_$n\n\n\techo ${!var}\n}\n\nDEV()\n{\n\techo netdevsim$(DEV_ADDR $1)\n}\n\nDEVLINK_DEV()\n{\n\techo netdevsim/$(DEV $1)\n}\n\nSYSFS_NET_DIR()\n{\n\techo /sys/bus/netdevsim/devices/$(DEV $1)/net/\n}\n\nDEBUGFS_DIR()\n{\n\techo /sys/kernel/debug/netdevsim/$(DEV $1)/\n}\n\nnsim_add()\n{\n\tlocal n=$1; shift\n\n\techo \"$(DEV_ADDR $n) 1\" > ${NETDEVSIM_PATH}/new_device\n\twhile [ ! -d $(SYSFS_NET_DIR $n) ] ; do :; done\n}\n\nnsim_reload()\n{\n\tlocal n=$1; shift\n\tlocal ns=$1; shift\n\n\tdevlink dev reload $(DEVLINK_DEV $n) netns $ns\n\n\tif [ $? -ne 0 ]; then\n\t\techo \"Failed to reload $(DEV $n) into netns \\\"testns1\\\"\"\n\t\texit 1\n\tfi\n\n}\n\nnsim_del()\n{\n\tlocal n=$1; shift\n\n\techo \"$(DEV_ADDR $n)\" > ${NETDEVSIM_PATH}/del_device\n}\n\nnsim_hwstats_toggle()\n{\n\tlocal action=$1; shift\n\tlocal instance=$1; shift\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\tlocal ifindex=$($IP -j link show dev $netdev | jq '.[].ifindex')\n\n\techo $ifindex > $(DEBUGFS_DIR $instance)/hwstats/$type/$action\n}\n\nnsim_hwstats_enable()\n{\n\tnsim_hwstats_toggle enable_ifindex \"$@\"\n}\n\nnsim_hwstats_disable()\n{\n\tnsim_hwstats_toggle disable_ifindex \"$@\"\n}\n\nnsim_hwstats_fail_next_enable()\n{\n\tnsim_hwstats_toggle fail_next_enable \"$@\"\n}\n\nsetup_prepare()\n{\n\tmodprobe netdevsim &> /dev/null\n\tnsim_add 1\n\tnsim_add 2\n\tnsim_add 3\n\n\tip netns add testns1\n\n\tif [ $? -ne 0 ]; then\n\t\techo \"Failed to add netns \\\"testns1\\\"\"\n\t\texit 1\n\tfi\n\n\tnsim_reload 1 testns1\n\tnsim_reload 2 testns1\n\tnsim_reload 3 testns1\n\n\tIP=\"ip -n testns1\"\n\n\t$IP link add name dummy1 type dummy\n\t$IP link set dev dummy1 up\n\tDUMMY_IFINDEX=$($IP -j link show dev dummy1 | jq '.[].ifindex')\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\t$IP link del name dummy1\n\tip netns del testns1\n\tnsim_del 3\n\tnsim_del 2\n\tnsim_del 1\n\tmodprobe -r netdevsim &> /dev/null\n}\n\nnetdev_hwstats_used()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\t$IP -j stats show dev \"$netdev\" group offload subgroup hw_stats_info |\n\t    jq '.[].info.l3_stats.used'\n}\n\nnetdev_check_used()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\t[[ $(netdev_hwstats_used $netdev $type) == \"true\" ]]\n}\n\nnetdev_check_unused()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\t[[ $(netdev_hwstats_used $netdev $type) == \"false\" ]]\n}\n\nnetdev_hwstats_request()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\t$IP -j stats show dev \"$netdev\" group offload subgroup hw_stats_info |\n\t    jq \".[].info.${type}_stats.request\"\n}\n\nnetdev_check_requested()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\t[[ $(netdev_hwstats_request $netdev $type) == \"true\" ]]\n}\n\nnetdev_check_unrequested()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\n\t[[ $(netdev_hwstats_request $netdev $type) == \"false\" ]]\n}\n\nreporting_test()\n{\n\tlocal type=$1; shift\n\tlocal instance=1\n\n\tRET=0\n\n\t[[ -n $(netdev_hwstats_used dummy1 $type) ]]\n\tcheck_err $? \"$type stats not reported\"\n\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used before either device or netdevsim request\"\n\n\tnsim_hwstats_enable $instance dummy1 $type\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used before device request\"\n\tnetdev_check_unrequested dummy1 $type\n\tcheck_err $? \"$type stats reported as requested before device request\"\n\n\t$IP stats set dev dummy1 ${type}_stats on\n\tnetdev_check_used dummy1 $type\n\tcheck_err $? \"$type stats reported as not used after both device and netdevsim request\"\n\tnetdev_check_requested dummy1 $type\n\tcheck_err $? \"$type stats reported as not requested after device request\"\n\n\tnsim_hwstats_disable $instance dummy1 $type\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used after netdevsim request withdrawn\"\n\n\tnsim_hwstats_enable $instance dummy1 $type\n\tnetdev_check_used dummy1 $type\n\tcheck_err $? \"$type stats reported as not used after netdevsim request reenabled\"\n\n\t$IP stats set dev dummy1 ${type}_stats off\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used after device request withdrawn\"\n\tnetdev_check_unrequested dummy1 $type\n\tcheck_err $? \"$type stats reported as requested after device request withdrawn\"\n\n\tnsim_hwstats_disable $instance dummy1 $type\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used after both requests withdrawn\"\n\n\tlog_test \"Reporting of $type stats usage\"\n}\n\nl3_reporting_test()\n{\n\treporting_test l3\n}\n\n__fail_next_test()\n{\n\tlocal instance=$1; shift\n\tlocal type=$1; shift\n\n\tRET=0\n\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used before either device or netdevsim request\"\n\n\tnsim_hwstats_enable $instance dummy1 $type\n\tnsim_hwstats_fail_next_enable $instance dummy1 $type\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used before device request\"\n\tnetdev_check_unrequested dummy1 $type\n\tcheck_err $? \"$type stats reported as requested before device request\"\n\n\t$IP stats set dev dummy1 ${type}_stats on 2>/dev/null\n\tcheck_fail $? \"$type stats request not bounced as it should have been\"\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used after bounce\"\n\tnetdev_check_unrequested dummy1 $type\n\tcheck_err $? \"$type stats reported as requested after bounce\"\n\n\t$IP stats set dev dummy1 ${type}_stats on\n\tcheck_err $? \"$type stats request failed when it shouldn't have\"\n\tnetdev_check_used dummy1 $type\n\tcheck_err $? \"$type stats reported as not used after both device and netdevsim request\"\n\tnetdev_check_requested dummy1 $type\n\tcheck_err $? \"$type stats reported as not requested after device request\"\n\n\t$IP stats set dev dummy1 ${type}_stats off\n\tnsim_hwstats_disable $instance dummy1 $type\n\n\tlog_test \"Injected failure of $type stats enablement (netdevsim #$instance)\"\n}\n\nfail_next_test()\n{\n\t__fail_next_test 1 \"$@\"\n\t__fail_next_test 2 \"$@\"\n\t__fail_next_test 3 \"$@\"\n}\n\nl3_fail_next_test()\n{\n\tfail_next_test l3\n}\n\nget_hwstat()\n{\n\tlocal netdev=$1; shift\n\tlocal type=$1; shift\n\tlocal selector=$1; shift\n\n\t$IP -j stats show dev $netdev group offload subgroup ${type}_stats |\n\t\t  jq \".[0].stats64.${selector}\"\n}\n\ncounter_test()\n{\n\tlocal type=$1; shift\n\tlocal instance=1\n\n\tRET=0\n\n\tnsim_hwstats_enable $instance dummy1 $type\n\t$IP stats set dev dummy1 ${type}_stats on\n\tnetdev_check_used dummy1 $type\n\tcheck_err $? \"$type stats reported as not used after both device and netdevsim request\"\n\n\t# Netdevsim counts 10pps on ingress. We should see maybe a couple\n\t# packets, unless things take a reeealy long time.\n\tlocal pkts=$(get_hwstat dummy1 l3 rx.packets)\n\t((pkts < 10))\n\tcheck_err $? \"$type stats show >= 10 packets after first enablement\"\n\n\tsleep 2.5\n\n\tlocal pkts=$(get_hwstat dummy1 l3 rx.packets)\n\t((pkts >= 20))\n\tcheck_err $? \"$type stats show < 20 packets after 2.5s passed\"\n\n\t$IP stats set dev dummy1 ${type}_stats off\n\n\tsleep 2\n\n\t$IP stats set dev dummy1 ${type}_stats on\n\tlocal pkts=$(get_hwstat dummy1 l3 rx.packets)\n\t((pkts < 10))\n\tcheck_err $? \"$type stats show >= 10 packets after second enablement\"\n\n\t$IP stats set dev dummy1 ${type}_stats off\n\tnsim_hwstats_fail_next_enable $instance dummy1 $type\n\t$IP stats set dev dummy1 ${type}_stats on 2>/dev/null\n\tcheck_fail $? \"$type stats request not bounced as it should have been\"\n\n\tsleep 2\n\n\t$IP stats set dev dummy1 ${type}_stats on\n\tlocal pkts=$(get_hwstat dummy1 l3 rx.packets)\n\t((pkts < 10))\n\tcheck_err $? \"$type stats show >= 10 packets after post-fail enablement\"\n\n\t$IP stats set dev dummy1 ${type}_stats off\n\n\tlog_test \"Counter values in $type stats\"\n}\n\nl3_counter_test()\n{\n\tcounter_test l3\n}\n\nrollback_test()\n{\n\tlocal type=$1; shift\n\n\tRET=0\n\n\tnsim_hwstats_enable 1 dummy1 l3\n\tnsim_hwstats_enable 2 dummy1 l3\n\tnsim_hwstats_enable 3 dummy1 l3\n\n\t# The three netdevsim instances are registered in order of their number\n\t# one after another. It is reasonable to expect that whatever\n\t# notifications take place hit no. 2 in between hitting nos. 1 and 3,\n\t# whatever the actual order. This allows us to test that a fail caused\n\t# by no. 2 does not leave the system in a partial state, and rolls\n\t# everything back.\n\n\tnsim_hwstats_fail_next_enable 2 dummy1 l3\n\t$IP stats set dev dummy1 ${type}_stats on 2>/dev/null\n\tcheck_fail $? \"$type stats request not bounced as it should have been\"\n\n\tnetdev_check_unused dummy1 $type\n\tcheck_err $? \"$type stats reported as used after bounce\"\n\tnetdev_check_unrequested dummy1 $type\n\tcheck_err $? \"$type stats reported as requested after bounce\"\n\n\tsleep 2\n\n\t$IP stats set dev dummy1 ${type}_stats on\n\tcheck_err $? \"$type stats request not upheld as it should have been\"\n\n\tlocal pkts=$(get_hwstat dummy1 l3 rx.packets)\n\t((pkts < 10))\n\tcheck_err $? \"$type stats show $pkts packets after post-fail enablement\"\n\n\t$IP stats set dev dummy1 ${type}_stats off\n\n\tnsim_hwstats_disable 3 dummy1 l3\n\tnsim_hwstats_disable 2 dummy1 l3\n\tnsim_hwstats_disable 1 dummy1 l3\n\n\tlog_test \"Failure in $type stats enablement rolled back\"\n}\n\nl3_rollback_test()\n{\n\trollback_test l3\n}\n\nl3_monitor_test()\n{\n\thw_stats_monitor_test dummy1 l3\t\t   \\\n\t\t\"nsim_hwstats_enable 1 dummy1 l3\"  \\\n\t\t\"nsim_hwstats_disable 1 dummy1 l3\" \\\n\t\t\"$IP\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}