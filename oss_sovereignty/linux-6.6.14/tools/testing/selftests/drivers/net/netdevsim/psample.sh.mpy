{
  "module_name": "psample.sh",
  "hash_id": "39c4ca4e4c6ae32b8450be06ef392c859c23f73dedff3d6699a99db529814f93",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/psample.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking the psample module. It makes use of netdevsim\n# which periodically generates \"sampled\" packets.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tpsample_enable_test\n\tpsample_group_num_test\n\tpsample_md_test\n\"\nNETDEVSIM_PATH=/sys/bus/netdevsim/\nDEV_ADDR=1337\nDEV=netdevsim${DEV_ADDR}\nSYSFS_NET_DIR=/sys/bus/netdevsim/devices/$DEV/net/\nPSAMPLE_DIR=/sys/kernel/debug/netdevsim/$DEV/psample/\nCAPTURE_FILE=$(mktemp)\nNUM_NETIFS=0\nsource $lib_dir/lib.sh\n\nDEVLINK_DEV=\nsource $lib_dir/devlink_lib.sh\nDEVLINK_DEV=netdevsim/${DEV}\n\n# Available at https://github.com/Mellanox/libpsample\nrequire_command psample\n\npsample_capture()\n{\n\trm -f $CAPTURE_FILE\n\n\ttimeout 2 ip netns exec testns1 psample &> $CAPTURE_FILE\n}\n\npsample_enable_test()\n{\n\tRET=0\n\n\techo 1 > $PSAMPLE_DIR/enable\n\tcheck_err $? \"Failed to enable sampling when should not\"\n\n\techo 1 > $PSAMPLE_DIR/enable 2>/dev/null\n\tcheck_fail $? \"Sampling enablement succeeded when should fail\"\n\n\tpsample_capture\n\tif [ $(cat $CAPTURE_FILE | wc -l) -eq 0 ]; then\n\t\tcheck_err 1 \"Failed to capture sampled packets\"\n\tfi\n\n\techo 0 > $PSAMPLE_DIR/enable\n\tcheck_err $? \"Failed to disable sampling when should not\"\n\n\techo 0 > $PSAMPLE_DIR/enable 2>/dev/null\n\tcheck_fail $? \"Sampling disablement succeeded when should fail\"\n\n\tpsample_capture\n\tif [ $(cat $CAPTURE_FILE | wc -l) -ne 0 ]; then\n\t\tcheck_err 1 \"Captured sampled packets when should not\"\n\tfi\n\n\tlog_test \"psample enable / disable\"\n}\n\npsample_group_num_test()\n{\n\tRET=0\n\n\techo 1234 > $PSAMPLE_DIR/group_num\n\techo 1 > $PSAMPLE_DIR/enable\n\n\tpsample_capture\n\tgrep -q -e \"group 1234\" $CAPTURE_FILE\n\tcheck_err $? \"Sampled packets reported with wrong group number\"\n\n\t# New group number should only be used after disable / enable.\n\techo 4321 > $PSAMPLE_DIR/group_num\n\n\tpsample_capture\n\tgrep -q -e \"group 4321\" $CAPTURE_FILE\n\tcheck_fail $? \"Group number changed while sampling is active\"\n\n\techo 0 > $PSAMPLE_DIR/enable && echo 1 > $PSAMPLE_DIR/enable\n\n\tpsample_capture\n\tgrep -q -e \"group 4321\" $CAPTURE_FILE\n\tcheck_err $? \"Group number did not change after restarting sampling\"\n\n\tlog_test \"psample group number\"\n\n\techo 0 > $PSAMPLE_DIR/enable\n}\n\npsample_md_test()\n{\n\tRET=0\n\n\techo 1 > $PSAMPLE_DIR/enable\n\n\techo 1234 > $PSAMPLE_DIR/in_ifindex\n\techo 4321 > $PSAMPLE_DIR/out_ifindex\n\tpsample_capture\n\n\tgrep -q -e \"in-ifindex 1234\" $CAPTURE_FILE\n\tcheck_err $? \"Sampled packets reported with wrong in-ifindex\"\n\n\tgrep -q -e \"out-ifindex 4321\" $CAPTURE_FILE\n\tcheck_err $? \"Sampled packets reported with wrong out-ifindex\"\n\n\techo 5 > $PSAMPLE_DIR/out_tc\n\tpsample_capture\n\n\tgrep -q -e \"out-tc 5\" $CAPTURE_FILE\n\tcheck_err $? \"Sampled packets reported with wrong out-tc\"\n\n\techo $((2**16 - 1)) > $PSAMPLE_DIR/out_tc\n\tpsample_capture\n\n\tgrep -q -e \"out-tc \" $CAPTURE_FILE\n\tcheck_fail $? \"Sampled packets reported with out-tc when should not\"\n\n\techo 1 > $PSAMPLE_DIR/out_tc\n\techo 10000 > $PSAMPLE_DIR/out_tc_occ_max\n\tpsample_capture\n\n\tgrep -q -e \"out-tc-occ \" $CAPTURE_FILE\n\tcheck_err $? \"Sampled packets not reported with out-tc-occ when should\"\n\n\techo 0 > $PSAMPLE_DIR/out_tc_occ_max\n\tpsample_capture\n\n\tgrep -q -e \"out-tc-occ \" $CAPTURE_FILE\n\tcheck_fail $? \"Sampled packets reported with out-tc-occ when should not\"\n\n\techo 10000 > $PSAMPLE_DIR/latency_max\n\tpsample_capture\n\n\tgrep -q -e \"latency \" $CAPTURE_FILE\n\tcheck_err $? \"Sampled packets not reported with latency when should\"\n\n\techo 0 > $PSAMPLE_DIR/latency_max\n\tpsample_capture\n\n\tgrep -q -e \"latency \" $CAPTURE_FILE\n\tcheck_fail $? \"Sampled packets reported with latency when should not\"\n\n\tlog_test \"psample metadata\"\n\n\techo 0 > $PSAMPLE_DIR/enable\n}\n\nsetup_prepare()\n{\n\tmodprobe netdevsim &> /dev/null\n\n\techo \"$DEV_ADDR 1\" > ${NETDEVSIM_PATH}/new_device\n\twhile [ ! -d $SYSFS_NET_DIR ] ; do :; done\n\n\tset -e\n\n\tip netns add testns1\n\tdevlink dev reload $DEVLINK_DEV netns testns1\n\n\tset +e\n}\n\ncleanup()\n{\n\tpre_cleanup\n\trm -f $CAPTURE_FILE\n\tip netns del testns1\n\techo \"$DEV_ADDR\" > ${NETDEVSIM_PATH}/del_device\n\tmodprobe -r netdevsim &> /dev/null\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}