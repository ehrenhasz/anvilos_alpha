{
  "module_name": "devlink.sh",
  "hash_id": "047364e83b6f870d598c2c25169da6b0161418cab0239ea61d499f4aa9d3925c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/devlink.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"fw_flash_test params_test regions_test reload_test \\\n\t   netns_reload_test resource_test dev_info_test \\\n\t   empty_reporter_test dummy_reporter_test rate_test\"\nNUM_NETIFS=0\nsource $lib_dir/lib.sh\n\nBUS_ADDR=10\nPORT_COUNT=4\nVF_COUNT=4\nDEV_NAME=netdevsim$BUS_ADDR\nSYSFS_NET_DIR=/sys/bus/netdevsim/devices/$DEV_NAME/net/\nDEBUGFS_DIR=/sys/kernel/debug/netdevsim/$DEV_NAME/\nDL_HANDLE=netdevsim/$DEV_NAME\n\nwait_for_devlink()\n{\n\t\"$@\" | grep -q $DL_HANDLE\n}\n\ndevlink_wait()\n{\n\tlocal timeout=$1\n\n\tbusywait \"$timeout\" wait_for_devlink devlink dev\n}\n\nfw_flash_test()\n{\n\tRET=0\n\n\tdevlink dev flash $DL_HANDLE file dummy\n\tcheck_err $? \"Failed to flash with status updates on\"\n\n\tdevlink dev flash $DL_HANDLE file dummy component fw.mgmt\n\tcheck_err $? \"Failed to flash with component attribute\"\n\n\tdevlink dev flash $DL_HANDLE file dummy overwrite settings\n\tcheck_fail $? \"Flash with overwrite settings should be rejected\"\n\n\techo \"1\"> $DEBUGFS_DIR/fw_update_overwrite_mask\n\tcheck_err $? \"Failed to change allowed overwrite mask\"\n\n\tdevlink dev flash $DL_HANDLE file dummy overwrite settings\n\tcheck_err $? \"Failed to flash with settings overwrite enabled\"\n\n\tdevlink dev flash $DL_HANDLE file dummy overwrite identifiers\n\tcheck_fail $? \"Flash with overwrite settings should be identifiers\"\n\n\techo \"3\"> $DEBUGFS_DIR/fw_update_overwrite_mask\n\tcheck_err $? \"Failed to change allowed overwrite mask\"\n\n\tdevlink dev flash $DL_HANDLE file dummy overwrite identifiers overwrite settings\n\tcheck_err $? \"Failed to flash with settings and identifiers overwrite enabled\"\n\n\techo \"n\"> $DEBUGFS_DIR/fw_update_status\n\tcheck_err $? \"Failed to disable status updates\"\n\n\tdevlink dev flash $DL_HANDLE file dummy\n\tcheck_err $? \"Failed to flash with status updates off\"\n\n\tlog_test \"fw flash test\"\n}\n\nparam_get()\n{\n\tlocal name=$1\n\n\tcmd_jq \"devlink dev param show $DL_HANDLE name $name -j\" \\\n\t       '.[][][].values[] | select(.cmode == \"driverinit\").value'\n}\n\nparam_set()\n{\n\tlocal name=$1\n\tlocal value=$2\n\n\tdevlink dev param set $DL_HANDLE name $name cmode driverinit value $value\n}\n\ncheck_value()\n{\n\tlocal name=$1\n\tlocal phase_name=$2\n\tlocal expected_param_value=$3\n\tlocal expected_debugfs_value=$4\n\tlocal value\n\n\tvalue=$(param_get $name)\n\tcheck_err $? \"Failed to get $name param value\"\n\t[ \"$value\" == \"$expected_param_value\" ]\n\tcheck_err $? \"Unexpected $phase_name $name param value\"\n\tvalue=$(<$DEBUGFS_DIR/$name)\n\tcheck_err $? \"Failed to get $name debugfs value\"\n\t[ \"$value\" == \"$expected_debugfs_value\" ]\n\tcheck_err $? \"Unexpected $phase_name $name debugfs value\"\n}\n\nparams_test()\n{\n\tRET=0\n\n\tlocal max_macs\n\tlocal test1\n\n\tcheck_value max_macs initial 32 32\n\tcheck_value test1 initial true Y\n\n\tparam_set max_macs 16\n\tcheck_err $? \"Failed to set max_macs param value\"\n\tparam_set test1 false\n\tcheck_err $? \"Failed to set test1 param value\"\n\n\tcheck_value max_macs post-set 16 32\n\tcheck_value test1 post-set false Y\n\n\tdevlink dev reload $DL_HANDLE\n\n\tcheck_value max_macs post-reload 16 16\n\tcheck_value test1 post-reload false N\n\n\tlog_test \"params test\"\n}\n\ncheck_region_size()\n{\n\tlocal name=$1\n\tlocal size\n\n\tsize=$(devlink region show $DL_HANDLE/$name -j | jq -e -r '.[][].size')\n\tcheck_err $? \"Failed to get $name region size\"\n\t[ $size -eq 32768 ]\n\tcheck_err $? \"Invalid $name region size\"\n}\n\ncheck_region_snapshot_count()\n{\n\tlocal name=$1\n\tlocal phase_name=$2\n\tlocal expected_count=$3\n\tlocal count\n\n\tcount=$(devlink region show $DL_HANDLE/$name -j | jq -e -r '.[][].snapshot | length')\n\t[ $count -eq $expected_count ]\n\tcheck_err $? \"Unexpected $phase_name snapshot count\"\n}\n\nregions_test()\n{\n\tRET=0\n\n\tlocal count\n\n\tcheck_region_size dummy\n\tcheck_region_snapshot_count dummy initial 0\n\n\techo \"\"> $DEBUGFS_DIR/take_snapshot\n\tcheck_err $? \"Failed to take first dummy region snapshot\"\n\tcheck_region_snapshot_count dummy post-first-snapshot 1\n\n\techo \"\"> $DEBUGFS_DIR/take_snapshot\n\tcheck_err $? \"Failed to take second dummy region snapshot\"\n\tcheck_region_snapshot_count dummy post-second-snapshot 2\n\n\techo \"\"> $DEBUGFS_DIR/take_snapshot\n\tcheck_err $? \"Failed to take third dummy region snapshot\"\n\tcheck_region_snapshot_count dummy post-third-snapshot 3\n\n\tdevlink region del $DL_HANDLE/dummy snapshot 1\n\tcheck_err $? \"Failed to delete first dummy region snapshot\"\n\n\tcheck_region_snapshot_count dummy post-first-delete 2\n\n\tdevlink region new $DL_HANDLE/dummy snapshot 25\n\tcheck_err $? \"Failed to create a new snapshot with id 25\"\n\n\tcheck_region_snapshot_count dummy post-first-request 3\n\n\tdevlink region dump $DL_HANDLE/dummy snapshot 25 >> /dev/null\n\tcheck_err $? \"Failed to dump snapshot with id 25\"\n\n\tdevlink region read $DL_HANDLE/dummy snapshot 25 addr 0 len 1 >> /dev/null\n\tcheck_err $? \"Failed to read snapshot with id 25 (1 byte)\"\n\n\tdevlink region read $DL_HANDLE/dummy snapshot 25 addr 128 len 128 >> /dev/null\n\tcheck_err $? \"Failed to read snapshot with id 25 (128 bytes)\"\n\n\tdevlink region read $DL_HANDLE/dummy snapshot 25 addr 128 len $((1<<32)) >> /dev/null\n\tcheck_err $? \"Failed to read snapshot with id 25 (oversized)\"\n\n\tdevlink region read $DL_HANDLE/dummy snapshot 25 addr $((1<<32)) len 128 >> /dev/null 2>&1\n\tcheck_fail $? \"Bad read of snapshot with id 25 did not fail\"\n\n\tdevlink region del $DL_HANDLE/dummy snapshot 25\n\tcheck_err $? \"Failed to delete snapshot with id 25\"\n\n\tcheck_region_snapshot_count dummy post-second-delete 2\n\n\tsid=$(devlink -j region new $DL_HANDLE/dummy | jq '.[][][][]')\n\tcheck_err $? \"Failed to create a new snapshot with id allocated by the kernel\"\n\n\tcheck_region_snapshot_count dummy post-first-request 3\n\n\tdevlink region dump $DL_HANDLE/dummy snapshot $sid >> /dev/null\n\tcheck_err $? \"Failed to dump a snapshot with id allocated by the kernel\"\n\n\tdevlink region del $DL_HANDLE/dummy snapshot $sid\n\tcheck_err $? \"Failed to delete snapshot with id allocated by the kernel\"\n\n\tcheck_region_snapshot_count dummy post-first-request 2\n\n\tlog_test \"regions test\"\n}\n\nreload_test()\n{\n\tRET=0\n\n\tdevlink dev reload $DL_HANDLE\n\tcheck_err $? \"Failed to reload\"\n\n\techo \"y\"> $DEBUGFS_DIR/fail_reload\n\tcheck_err $? \"Failed to setup devlink reload to fail\"\n\n\tdevlink dev reload $DL_HANDLE\n\tcheck_fail $? \"Unexpected success of devlink reload\"\n\n\techo \"n\"> $DEBUGFS_DIR/fail_reload\n\tcheck_err $? \"Failed to setup devlink reload not to fail\"\n\n\tdevlink dev reload $DL_HANDLE\n\tcheck_err $? \"Failed to reload after set not to fail\"\n\n\techo \"y\"> $DEBUGFS_DIR/dont_allow_reload\n\tcheck_err $? \"Failed to forbid devlink reload\"\n\n\tdevlink dev reload $DL_HANDLE\n\tcheck_fail $? \"Unexpected success of devlink reload\"\n\n\techo \"n\"> $DEBUGFS_DIR/dont_allow_reload\n\tcheck_err $? \"Failed to re-enable devlink reload\"\n\n\tdevlink dev reload $DL_HANDLE\n\tcheck_err $? \"Failed to reload after re-enable\"\n\n\tlog_test \"reload test\"\n}\n\nnetns_reload_test()\n{\n\tRET=0\n\n\tip netns add testns1\n\tcheck_err $? \"Failed add netns \\\"testns1\\\"\"\n\tip netns add testns2\n\tcheck_err $? \"Failed add netns \\\"testns2\\\"\"\n\n\tdevlink dev reload $DL_HANDLE netns testns1\n\tcheck_err $? \"Failed to reload into netns \\\"testns1\\\"\"\n\n\tdevlink -N testns1 dev reload $DL_HANDLE netns testns2\n\tcheck_err $? \"Failed to reload from netns \\\"testns1\\\" into netns \\\"testns2\\\"\"\n\n\tip netns del testns2\n\tip netns del testns1\n\n\t# Wait until netns async cleanup is done.\n\tdevlink_wait 2000\n\n\tlog_test \"netns reload test\"\n}\n\nDUMMYDEV=\"dummytest\"\n\nres_val_get()\n{\n\tlocal netns=$1\n\tlocal parentname=$2\n\tlocal name=$3\n\tlocal type=$4\n\n\tcmd_jq \"devlink -N $netns resource show $DL_HANDLE -j\" \\\n\t       \".[][][] | select(.name == \\\"$parentname\\\").resources[] \\\n\t        | select(.name == \\\"$name\\\").$type\"\n}\n\nresource_test()\n{\n\tRET=0\n\n\tip netns add testns1\n\tcheck_err $? \"Failed add netns \\\"testns1\\\"\"\n\tip netns add testns2\n\tcheck_err $? \"Failed add netns \\\"testns2\\\"\"\n\n\tdevlink dev reload $DL_HANDLE netns testns1\n\tcheck_err $? \"Failed to reload into netns \\\"testns1\\\"\"\n\n\t# Create dummy dev to add the address and routes on.\n\n\tip -n testns1 link add name $DUMMYDEV type dummy\n\tcheck_err $? \"Failed create dummy device\"\n\tip -n testns1 link set $DUMMYDEV up\n\tcheck_err $? \"Failed bring up dummy device\"\n\tip -n testns1 a a 192.0.1.1/24 dev $DUMMYDEV\n\tcheck_err $? \"Failed add an IP address to dummy device\"\n\n\tlocal occ=$(res_val_get testns1 IPv4 fib occ)\n\tlocal limit=$((occ+1))\n\n\t# Set fib size limit to handle one another route only.\n\n\tdevlink -N testns1 resource set $DL_HANDLE path IPv4/fib size $limit\n\tcheck_err $? \"Failed to set IPv4/fib resource size\"\n\tlocal size_new=$(res_val_get testns1 IPv4 fib size_new)\n\t[ \"$size_new\" -eq \"$limit\" ]\n\tcheck_err $? \"Unexpected \\\"size_new\\\" value (got $size_new, expected $limit)\"\n\n\tdevlink -N testns1 dev reload $DL_HANDLE\n\tcheck_err $? \"Failed to reload\"\n\tlocal size=$(res_val_get testns1 IPv4 fib size)\n\t[ \"$size\" -eq \"$limit\" ]\n\tcheck_err $? \"Unexpected \\\"size\\\" value (got $size, expected $limit)\"\n\n\t# Insert 2 routes, the first is going to be inserted,\n\t# the second is expected to fail to be inserted.\n\n\tip -n testns1 r a 192.0.2.0/24 via 192.0.1.2\n\tcheck_err $? \"Failed to add route\"\n\n\tip -n testns1 r a 192.0.3.0/24 via 192.0.1.2\n\tcheck_fail $? \"Unexpected successful route add over limit\"\n\n\t# Now create another dummy in second network namespace and\n\t# insert two routes. That is over the limit of the netdevsim\n\t# instance in the first namespace. Move the netdevsim instance\n\t# into the second namespace and expect it to fail.\n\n\tip -n testns2 link add name $DUMMYDEV type dummy\n\tcheck_err $? \"Failed create dummy device\"\n\tip -n testns2 link set $DUMMYDEV up\n\tcheck_err $? \"Failed bring up dummy device\"\n\tip -n testns2 a a 192.0.1.1/24 dev $DUMMYDEV\n\tcheck_err $? \"Failed add an IP address to dummy device\"\n\tip -n testns2 r a 192.0.2.0/24 via 192.0.1.2\n\tcheck_err $? \"Failed to add route\"\n\tip -n testns2 r a 192.0.3.0/24 via 192.0.1.2\n\tcheck_err $? \"Failed to add route\"\n\n\tdevlink -N testns1 dev reload $DL_HANDLE netns testns2\n\tcheck_fail $? \"Unexpected successful reload from netns \\\"testns1\\\" into netns \\\"testns2\\\"\"\n\n\tdevlink -N testns2 resource set $DL_HANDLE path IPv4/fib size ' -1'\n\tcheck_err $? \"Failed to reset IPv4/fib resource size\"\n\n\tdevlink -N testns2 dev reload $DL_HANDLE netns 1\n\tcheck_err $? \"Failed to reload devlink back\"\n\n\tip netns del testns2\n\tip netns del testns1\n\n\t# Wait until netns async cleanup is done.\n\tdevlink_wait 2000\n\n\tlog_test \"resource test\"\n}\n\ninfo_get()\n{\n\tlocal name=$1\n\n\tcmd_jq \"devlink dev info $DL_HANDLE -j\" \".[][][\\\"$name\\\"]\" \"-e\"\n}\n\ndev_info_test()\n{\n\tRET=0\n\n\tdriver=$(info_get \"driver\")\n\tcheck_err $? \"Failed to get driver name\"\n\t[ \"$driver\" == \"netdevsim\" ]\n\tcheck_err $? \"Unexpected driver name $driver\"\n\n\tlog_test \"dev_info test\"\n}\n\nempty_reporter_test()\n{\n\tRET=0\n\n\tdevlink health show $DL_HANDLE reporter empty >/dev/null\n\tcheck_err $? \"Failed show empty reporter\"\n\n\tdevlink health dump show $DL_HANDLE reporter empty >/dev/null\n\tcheck_err $? \"Failed show dump of empty reporter\"\n\n\tdevlink health diagnose $DL_HANDLE reporter empty >/dev/null\n\tcheck_err $? \"Failed diagnose empty reporter\"\n\n\tdevlink health recover $DL_HANDLE reporter empty\n\tcheck_err $? \"Failed recover empty reporter\"\n\n\tlog_test \"empty reporter test\"\n}\n\ncheck_reporter_info()\n{\n\tlocal name=$1\n\tlocal expected_state=$2\n\tlocal expected_error=$3\n\tlocal expected_recover=$4\n\tlocal expected_grace_period=$5\n\tlocal expected_auto_recover=$6\n\n\tlocal show=$(devlink health show $DL_HANDLE reporter $name -j | jq -e -r \".[][][]\")\n\tcheck_err $? \"Failed show $name reporter\"\n\n\tlocal state=$(echo $show | jq -r \".state\")\n\t[ \"$state\" == \"$expected_state\" ]\n\tcheck_err $? \"Unexpected \\\"state\\\" value (got $state, expected $expected_state)\"\n\n\tlocal error=$(echo $show | jq -r \".error\")\n\t[ \"$error\" == \"$expected_error\" ]\n\tcheck_err $? \"Unexpected \\\"error\\\" value (got $error, expected $expected_error)\"\n\n\tlocal recover=`echo $show | jq -r \".recover\"`\n\t[ \"$recover\" == \"$expected_recover\" ]\n\tcheck_err $? \"Unexpected \\\"recover\\\" value (got $recover, expected $expected_recover)\"\n\n\tlocal grace_period=$(echo $show | jq -r \".grace_period\")\n\tcheck_err $? \"Failed get $name reporter grace_period\"\n\t[ \"$grace_period\" == \"$expected_grace_period\" ]\n\tcheck_err $? \"Unexpected \\\"grace_period\\\" value (got $grace_period, expected $expected_grace_period)\"\n\n\tlocal auto_recover=$(echo $show | jq -r \".auto_recover\")\n\t[ \"$auto_recover\" == \"$expected_auto_recover\" ]\n\tcheck_err $? \"Unexpected \\\"auto_recover\\\" value (got $auto_recover, expected $expected_auto_recover)\"\n}\n\ndummy_reporter_test()\n{\n\tRET=0\n\n\tcheck_reporter_info dummy healthy 0 0 0 true\n\n\tdevlink health set $DL_HANDLE reporter dummy auto_recover false\n\tcheck_err $? \"Failed to dummy reporter auto_recover option\"\n\n\tcheck_reporter_info dummy healthy 0 0 0 false\n\n\tlocal BREAK_MSG=\"foo bar\"\n\techo \"$BREAK_MSG\"> $DEBUGFS_DIR/health/break_health\n\tcheck_err $? \"Failed to break dummy reporter\"\n\n\tcheck_reporter_info dummy error 1 0 0 false\n\n\tlocal dump=$(devlink health dump show $DL_HANDLE reporter dummy -j)\n\tcheck_err $? \"Failed show dump of dummy reporter\"\n\n\tlocal dump_break_msg=$(echo $dump | jq -r \".break_message\")\n\t[ \"$dump_break_msg\" == \"$BREAK_MSG\" ]\n\tcheck_err $? \"Unexpected dump break message value (got $dump_break_msg, expected $BREAK_MSG)\"\n\n\tdevlink health dump clear $DL_HANDLE reporter dummy\n\tcheck_err $? \"Failed clear dump of dummy reporter\"\n\n\tdevlink health recover $DL_HANDLE reporter dummy\n\tcheck_err $? \"Failed recover dummy reporter\"\n\n\tcheck_reporter_info dummy healthy 1 1 0 false\n\n\tdevlink health set $DL_HANDLE reporter dummy auto_recover true\n\tcheck_err $? \"Failed to dummy reporter auto_recover option\"\n\n\tcheck_reporter_info dummy healthy 1 1 0 true\n\n\techo \"$BREAK_MSG\"> $DEBUGFS_DIR/health/break_health\n\tcheck_err $? \"Failed to break dummy reporter\"\n\n\tcheck_reporter_info dummy healthy 2 2 0 true\n\n\tlocal diagnose=$(devlink health diagnose $DL_HANDLE reporter dummy -j -p)\n\tcheck_err $? \"Failed show diagnose of dummy reporter\"\n\n\tlocal rcvrd_break_msg=$(echo $diagnose | jq -r \".recovered_break_message\")\n\t[ \"$rcvrd_break_msg\" == \"$BREAK_MSG\" ]\n\tcheck_err $? \"Unexpected recovered break message value (got $rcvrd_break_msg, expected $BREAK_MSG)\"\n\n\tdevlink health set $DL_HANDLE reporter dummy grace_period 10\n\tcheck_err $? \"Failed to dummy reporter grace_period option\"\n\n\tcheck_reporter_info dummy healthy 2 2 10 true\n\n\techo \"Y\"> $DEBUGFS_DIR/health/fail_recover\n\tcheck_err $? \"Failed set dummy reporter recovery to fail\"\n\n\techo \"$BREAK_MSG\"> $DEBUGFS_DIR/health/break_health\n\tcheck_fail $? \"Unexpected success of dummy reporter break\"\n\n\tcheck_reporter_info dummy error 3 2 10 true\n\n\tdevlink health recover $DL_HANDLE reporter dummy\n\tcheck_fail $? \"Unexpected success of dummy reporter recover\"\n\n\techo \"N\"> $DEBUGFS_DIR/health/fail_recover\n\tcheck_err $? \"Failed set dummy reporter recovery to be successful\"\n\n\tdevlink health recover $DL_HANDLE reporter dummy\n\tcheck_err $? \"Failed recover dummy reporter\"\n\n\tcheck_reporter_info dummy healthy 3 3 10 true\n\n\techo 8192 > $DEBUGFS_DIR/health/binary_len\n\tcheck_err $? \"Failed set dummy reporter binary len to 8192\"\n\n\tlocal dump=$(devlink health dump show $DL_HANDLE reporter dummy -j)\n\tcheck_err $? \"Failed show dump of dummy reporter\"\n\n\tdevlink health dump clear $DL_HANDLE reporter dummy\n\tcheck_err $? \"Failed clear dump of dummy reporter\"\n\n\tlog_test \"dummy reporter test\"\n}\n\nrate_leafs_get()\n{\n\tlocal handle=$1\n\n\tcmd_jq \"devlink port function rate show -j\" \\\n\t       '.[] | to_entries | .[] | select(.value.type == \"leaf\") | .key | select(contains(\"'$handle'\"))'\n}\n\nrate_nodes_get()\n{\n\tlocal handle=$1\n\n\tcmd_jq \"devlink port function rate show -j\" \\\n\t\t'.[] | to_entries | .[] | select(.value.type == \"node\") | .key | select(contains(\"'$handle'\"))'\n}\n\nrate_attr_set()\n{\n\tlocal handle=$1\n\tlocal name=$2\n\tlocal value=$3\n\tlocal units=$4\n\n\tdevlink port function rate set $handle $name $value$units\n}\n\nrate_attr_get()\n{\n\tlocal handle=$1\n\tlocal name=$2\n\n\tcmd_jq \"devlink port function rate show $handle -j\" '.[][].'$name\n}\n\nrate_attr_tx_rate_check()\n{\n\tlocal handle=$1\n\tlocal name=$2\n\tlocal rate=$3\n\tlocal debug_file=$4\n\n\trate_attr_set $handle $name $rate mbit\n\tcheck_err $? \"Failed to set $name value\"\n\n\tlocal debug_value=$(cat $debug_file)\n\tcheck_err $? \"Failed to read $name value from debugfs\"\n\t[ \"$debug_value\" == \"$rate\" ]\n\tcheck_err $? \"Unexpected $name debug value $debug_value != $rate\"\n\n\tlocal api_value=$(( $(rate_attr_get $handle $name) * 8 / 1000000 ))\n\tcheck_err $? \"Failed to get $name attr value\"\n\t[ \"$api_value\" == \"$rate\" ]\n\tcheck_err $? \"Unexpected $name attr value $api_value != $rate\"\n}\n\nrate_attr_parent_check()\n{\n\tlocal handle=$1\n\tlocal parent=$2\n\tlocal debug_file=$3\n\n\trate_attr_set $handle parent $parent\n\tcheck_err $? \"Failed to set parent\"\n\n\tdebug_value=$(cat $debug_file)\n\tcheck_err $? \"Failed to get parent debugfs value\"\n\t[ \"$debug_value\" == \"$parent\" ]\n\tcheck_err $? \"Unexpected parent debug value $debug_value != $parent\"\n\n\tapi_value=$(rate_attr_get $r_obj parent)\n\tcheck_err $? \"Failed to get parent attr value\"\n\t[ \"$api_value\" == \"$parent\" ]\n\tcheck_err $? \"Unexpected parent attr value $api_value != $parent\"\n}\n\nrate_node_add()\n{\n\tlocal handle=$1\n\n\tdevlink port function rate add $handle\n}\n\nrate_node_del()\n{\n\tlocal handle=$1\n\n\tdevlink port function rate del $handle\n}\n\nrate_test()\n{\n\tRET=0\n\n\techo $VF_COUNT > /sys/bus/netdevsim/devices/$DEV_NAME/sriov_numvfs\n\tdevlink dev eswitch set $DL_HANDLE mode switchdev\n\tlocal leafs=`rate_leafs_get $DL_HANDLE`\n\tlocal num_leafs=`echo $leafs | wc -w`\n\t[ \"$num_leafs\" == \"$VF_COUNT\" ]\n\tcheck_err $? \"Expected $VF_COUNT rate leafs but got $num_leafs\"\n\n\trate=10\n\tfor r_obj in $leafs\n\tdo\n\t\trate_attr_tx_rate_check $r_obj tx_share $rate \\\n\t\t\t$DEBUGFS_DIR/ports/${r_obj##*/}/tx_share\n\t\trate=$(($rate+10))\n\tdone\n\n\trate=100\n\tfor r_obj in $leafs\n\tdo\n\t\trate_attr_tx_rate_check $r_obj tx_max $rate \\\n\t\t\t$DEBUGFS_DIR/ports/${r_obj##*/}/tx_max\n\t\trate=$(($rate+100))\n\tdone\n\n\tlocal node1_name='group1'\n\tlocal node1=\"$DL_HANDLE/$node1_name\"\n\trate_node_add \"$node1\"\n\tcheck_err $? \"Failed to add node $node1\"\n\n\tlocal num_nodes=`rate_nodes_get $DL_HANDLE | wc -w`\n\t[ $num_nodes == 1 ]\n\tcheck_err $? \"Expected 1 rate node in output but got $num_nodes\"\n\n\tlocal node_tx_share=10\n\trate_attr_tx_rate_check $node1 tx_share $node_tx_share \\\n\t\t$DEBUGFS_DIR/rate_nodes/${node1##*/}/tx_share\n\n\tlocal node_tx_max=100\n\trate_attr_tx_rate_check $node1 tx_max $node_tx_max \\\n\t\t$DEBUGFS_DIR/rate_nodes/${node1##*/}/tx_max\n\n\trate_node_del \"$node1\"\n\tcheck_err $? \"Failed to delete node $node1\"\n\tlocal num_nodes=`rate_nodes_get $DL_HANDLE | wc -w`\n\t[ $num_nodes == 0 ]\n\tcheck_err $? \"Expected 0 rate node but got $num_nodes\"\n\n\tlocal node1_name='group1'\n\tlocal node1=\"$DL_HANDLE/$node1_name\"\n\trate_node_add \"$node1\"\n\tcheck_err $? \"Failed to add node $node1\"\n\n\trate_attr_parent_check $r_obj $node1_name \\\n\t\t$DEBUGFS_DIR/ports/${r_obj##*/}/rate_parent\n\n\tlocal node2_name='group2'\n\tlocal node2=\"$DL_HANDLE/$node2_name\"\n\trate_node_add \"$node2\"\n\tcheck_err $? \"Failed to add node $node2\"\n\n\trate_attr_parent_check $node2 $node1_name \\\n\t\t$DEBUGFS_DIR/rate_nodes/$node2_name/rate_parent\n\trate_node_del \"$node2\"\n\tcheck_err $? \"Failed to delete node $node2\"\n\trate_attr_set \"$r_obj\" noparent\n\tcheck_err $? \"Failed to unset $r_obj parent node\"\n\trate_node_del \"$node1\"\n\tcheck_err $? \"Failed to delete node $node1\"\n\n\tlog_test \"rate test\"\n}\n\nsetup_prepare()\n{\n\tmodprobe netdevsim\n\techo \"$BUS_ADDR $PORT_COUNT\" > /sys/bus/netdevsim/new_device\n\twhile [ ! -d $SYSFS_NET_DIR ] ; do :; done\n}\n\ncleanup()\n{\n\tpre_cleanup\n\techo \"$BUS_ADDR\" > /sys/bus/netdevsim/del_device\n\tmodprobe -r netdevsim\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}