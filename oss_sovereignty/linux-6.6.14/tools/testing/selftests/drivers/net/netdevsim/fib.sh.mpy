{
  "module_name": "fib.sh",
  "hash_id": "5ecb01db13ca9ef06fb2243322ab0de348a53dca29d97ef5cba47cf90d96b59f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/netdevsim/fib.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking the FIB offload API. It makes use of netdevsim\n# which registers a listener to the FIB notification chain.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tipv4_identical_routes\n\tipv4_tos\n\tipv4_metric\n\tipv4_replace\n\tipv4_delete\n\tipv4_plen\n\tipv4_replay\n\tipv4_flush\n\tipv4_error_path\n\tipv4_delete_fail\n\tipv6_add\n\tipv6_metric\n\tipv6_append_single\n\tipv6_replace_single\n\tipv6_metric_multipath\n\tipv6_append_multipath\n\tipv6_replace_multipath\n\tipv6_append_multipath_to_single\n\tipv6_delete_single\n\tipv6_delete_multipath\n\tipv6_replay_single\n\tipv6_replay_multipath\n\tipv6_error_path\n\tipv6_delete_fail\n\"\nNETDEVSIM_PATH=/sys/bus/netdevsim/\nDEV_ADDR=1337\nDEV=netdevsim${DEV_ADDR}\nSYSFS_NET_DIR=/sys/bus/netdevsim/devices/$DEV/net/\nDEBUGFS_DIR=/sys/kernel/debug/netdevsim/$DEV/\nNUM_NETIFS=0\nsource $lib_dir/lib.sh\nsource $lib_dir/fib_offload_lib.sh\n\nDEVLINK_DEV=\nsource $lib_dir/devlink_lib.sh\nDEVLINK_DEV=netdevsim/${DEV}\n\nipv4_identical_routes()\n{\n\tfib_ipv4_identical_routes_test \"testns1\"\n}\n\nipv4_tos()\n{\n\tfib_ipv4_tos_test \"testns1\"\n}\n\nipv4_metric()\n{\n\tfib_ipv4_metric_test \"testns1\"\n}\n\nipv4_replace()\n{\n\tfib_ipv4_replace_test \"testns1\"\n}\n\nipv4_delete()\n{\n\tfib_ipv4_delete_test \"testns1\"\n}\n\nipv4_plen()\n{\n\tfib_ipv4_plen_test \"testns1\"\n}\n\nipv4_replay_metric()\n{\n\tfib_ipv4_replay_metric_test \"testns1\" \"$DEVLINK_DEV\"\n}\n\nipv4_replay_tos()\n{\n\tfib_ipv4_replay_tos_test \"testns1\" \"$DEVLINK_DEV\"\n}\n\nipv4_replay_plen()\n{\n\tfib_ipv4_replay_plen_test \"testns1\" \"$DEVLINK_DEV\"\n}\n\nipv4_replay()\n{\n\tipv4_replay_metric\n\tipv4_replay_tos\n\tipv4_replay_plen\n}\n\nipv4_flush()\n{\n\tfib_ipv4_flush_test \"testns1\"\n}\n\nipv4_error_path_add()\n{\n\tlocal lsb\n\n\tRET=0\n\n\tip -n testns1 link add name dummy1 type dummy\n\tip -n testns1 link set dev dummy1 up\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv4/fib size 10\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n\n\tfor lsb in $(seq 1 20); do\n\t\tip -n testns1 route add 192.0.2.${lsb}/32 dev dummy1 \\\n\t\t\t&> /dev/null\n\tdone\n\n\tlog_test \"IPv4 error path - add\"\n\n\tip -n testns1 link del dev dummy1\n}\n\nipv4_error_path_replay()\n{\n\tlocal lsb\n\n\tRET=0\n\n\tip -n testns1 link add name dummy1 type dummy\n\tip -n testns1 link set dev dummy1 up\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv4/fib size 100\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n\n\tfor lsb in $(seq 1 20); do\n\t\tip -n testns1 route add 192.0.2.${lsb}/32 dev dummy1\n\tdone\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv4/fib size 10\n\tdevlink -N testns1 dev reload $DEVLINK_DEV &> /dev/null\n\n\tlog_test \"IPv4 error path - replay\"\n\n\tip -n testns1 link del dev dummy1\n\n\t# Successfully reload after deleting all the routes.\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv4/fib size 100\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n}\n\nipv4_error_path()\n{\n\t# Test the different error paths of the notifiers by limiting the size\n\t# of the \"IPv4/fib\" resource.\n\tipv4_error_path_add\n\tipv4_error_path_replay\n}\n\nipv4_delete_fail()\n{\n\tRET=0\n\n\techo \"y\" > $DEBUGFS_DIR/fib/fail_route_delete\n\n\tip -n testns1 link add name dummy1 type dummy\n\tip -n testns1 link set dev dummy1 up\n\n\tip -n testns1 route add 192.0.2.0/24 dev dummy1\n\tip -n testns1 route del 192.0.2.0/24 dev dummy1 &> /dev/null\n\n\t# We should not be able to delete the netdev if we are leaking a\n\t# reference.\n\tip -n testns1 link del dev dummy1\n\n\tlog_test \"IPv4 route delete failure\"\n\n\techo \"n\" > $DEBUGFS_DIR/fib/fail_route_delete\n}\n\nipv6_add()\n{\n\tfib_ipv6_add_test \"testns1\"\n}\n\nipv6_metric()\n{\n\tfib_ipv6_metric_test \"testns1\"\n}\n\nipv6_append_single()\n{\n\tfib_ipv6_append_single_test \"testns1\"\n}\n\nipv6_replace_single()\n{\n\tfib_ipv6_replace_single_test \"testns1\"\n}\n\nipv6_metric_multipath()\n{\n\tfib_ipv6_metric_multipath_test \"testns1\"\n}\n\nipv6_append_multipath()\n{\n\tfib_ipv6_append_multipath_test \"testns1\"\n}\n\nipv6_replace_multipath()\n{\n\tfib_ipv6_replace_multipath_test \"testns1\"\n}\n\nipv6_append_multipath_to_single()\n{\n\tfib_ipv6_append_multipath_to_single_test \"testns1\"\n}\n\nipv6_delete_single()\n{\n\tfib_ipv6_delete_single_test \"testns1\"\n}\n\nipv6_delete_multipath()\n{\n\tfib_ipv6_delete_multipath_test \"testns1\"\n}\n\nipv6_replay_single()\n{\n\tfib_ipv6_replay_single_test \"testns1\" \"$DEVLINK_DEV\"\n}\n\nipv6_replay_multipath()\n{\n\tfib_ipv6_replay_multipath_test \"testns1\" \"$DEVLINK_DEV\"\n}\n\nipv6_error_path_add_single()\n{\n\tlocal lsb\n\n\tRET=0\n\n\tip -n testns1 link add name dummy1 type dummy\n\tip -n testns1 link set dev dummy1 up\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv6/fib size 10\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n\n\tfor lsb in $(seq 1 20); do\n\t\tip -n testns1 route add 2001:db8:1::${lsb}/128 dev dummy1 \\\n\t\t\t&> /dev/null\n\tdone\n\n\tlog_test \"IPv6 error path - add single\"\n\n\tip -n testns1 link del dev dummy1\n}\n\nipv6_error_path_add_multipath()\n{\n\tlocal lsb\n\n\tRET=0\n\n\tfor i in $(seq 1 2); do\n\t\tip -n testns1 link add name dummy$i type dummy\n\t\tip -n testns1 link set dev dummy$i up\n\t\tip -n testns1 address add 2001:db8:$i::1/64 dev dummy$i\n\tdone\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv6/fib size 10\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n\n\tfor lsb in $(seq 1 20); do\n\t\tip -n testns1 route add 2001:db8:10::${lsb}/128 \\\n\t\t\tnexthop via 2001:db8:1::2 dev dummy1 \\\n\t\t\tnexthop via 2001:db8:2::2 dev dummy2 &> /dev/null\n\tdone\n\n\tlog_test \"IPv6 error path - add multipath\"\n\n\tfor i in $(seq 1 2); do\n\t\tip -n testns1 link del dev dummy$i\n\tdone\n}\n\nipv6_error_path_replay()\n{\n\tlocal lsb\n\n\tRET=0\n\n\tip -n testns1 link add name dummy1 type dummy\n\tip -n testns1 link set dev dummy1 up\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv6/fib size 100\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n\n\tfor lsb in $(seq 1 20); do\n\t\tip -n testns1 route add 2001:db8:1::${lsb}/128 dev dummy1\n\tdone\n\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv6/fib size 10\n\tdevlink -N testns1 dev reload $DEVLINK_DEV &> /dev/null\n\n\tlog_test \"IPv6 error path - replay\"\n\n\tip -n testns1 link del dev dummy1\n\n\t# Successfully reload after deleting all the routes.\n\tdevlink -N testns1 resource set $DEVLINK_DEV path IPv6/fib size 100\n\tdevlink -N testns1 dev reload $DEVLINK_DEV\n}\n\nipv6_error_path()\n{\n\t# Test the different error paths of the notifiers by limiting the size\n\t# of the \"IPv6/fib\" resource.\n\tipv6_error_path_add_single\n\tipv6_error_path_add_multipath\n\tipv6_error_path_replay\n}\n\nipv6_delete_fail()\n{\n\tRET=0\n\n\techo \"y\" > $DEBUGFS_DIR/fib/fail_route_delete\n\n\tip -n testns1 link add name dummy1 type dummy\n\tip -n testns1 link set dev dummy1 up\n\n\tip -n testns1 route add 2001:db8:1::/64 dev dummy1\n\tip -n testns1 route del 2001:db8:1::/64 dev dummy1 &> /dev/null\n\n\t# We should not be able to delete the netdev if we are leaking a\n\t# reference.\n\tip -n testns1 link del dev dummy1\n\n\tlog_test \"IPv6 route delete failure\"\n\n\techo \"n\" > $DEBUGFS_DIR/fib/fail_route_delete\n}\n\nfib_notify_on_flag_change_set()\n{\n\tlocal notify=$1; shift\n\n\tip netns exec testns1 sysctl -qw net.ipv4.fib_notify_on_flag_change=$notify\n\tip netns exec testns1 sysctl -qw net.ipv6.fib_notify_on_flag_change=$notify\n\n\tlog_info \"Set fib_notify_on_flag_change to $notify\"\n}\n\nsetup_prepare()\n{\n\tlocal netdev\n\n\tmodprobe netdevsim &> /dev/null\n\n\techo \"$DEV_ADDR 1\" > ${NETDEVSIM_PATH}/new_device\n\twhile [ ! -d $SYSFS_NET_DIR ] ; do :; done\n\n\tip netns add testns1\n\tif [ $? -ne 0 ]; then\n\t\techo \"Failed to add netns \\\"testns1\\\"\"\n\t\texit 1\n\tfi\n\n\tdevlink dev reload $DEVLINK_DEV netns testns1\n\tif [ $? -ne 0 ]; then\n\t\techo \"Failed to reload into netns \\\"testns1\\\"\"\n\t\texit 1\n\tfi\n}\n\ncleanup()\n{\n\tpre_cleanup\n\tip netns del testns1\n\techo \"$DEV_ADDR\" > ${NETDEVSIM_PATH}/del_device\n\tmodprobe -r netdevsim &> /dev/null\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\nfib_notify_on_flag_change_set 1\ntests_run\n\nfib_notify_on_flag_change_set 0\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}