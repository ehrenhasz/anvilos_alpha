{
  "module_name": "ethtool_lanes.sh",
  "hash_id": "943aa0c828f9fbe58e96e94c47771ec0411728efa4d749e6e94b2008f03c982a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/ethtool_lanes.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tautoneg\n\tautoneg_force_mode\n\"\n\nNUM_NETIFS=2\n: ${TIMEOUT:=30000} # ms\nsource $lib_dir/lib.sh\nsource $lib_dir/ethtool_lib.sh\n\nsetup_prepare()\n{\n\tswp1=${NETIFS[p1]}\n\tswp2=${NETIFS[p2]}\n\n\tip link set dev $swp1 up\n\tip link set dev $swp2 up\n\n\tbusywait \"$TIMEOUT\" wait_for_port_up ethtool $swp2\n\tcheck_err $? \"ports did not come up\"\n\n\tlocal lanes_exist=$(ethtool $swp1 | grep 'Lanes:')\n\tif [[ -z $lanes_exist ]]; then\n\t\tlog_test \"SKIP: driver does not support lanes setting\"\n\t\texit 1\n\tfi\n\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n}\n\ncheck_lanes()\n{\n\tlocal dev=$1; shift\n\tlocal lanes=$1; shift\n\tlocal max_speed=$1; shift\n\tlocal chosen_lanes\n\n\tchosen_lanes=$(ethtool $dev | grep 'Lanes:')\n\tchosen_lanes=${chosen_lanes#*\"Lanes: \"}\n\n\t((chosen_lanes == lanes))\n\tcheck_err $? \"swp1 advertise $max_speed and $lanes, devs sync to $chosen_lanes\"\n}\n\ncheck_unsupported_lanes()\n{\n\tlocal dev=$1; shift\n\tlocal max_speed=$1; shift\n\tlocal max_lanes=$1; shift\n\tlocal autoneg=$1; shift\n\tlocal autoneg_str=\"\"\n\n\tlocal unsupported_lanes=$((max_lanes *= 2))\n\n\tif [[ $autoneg -eq 0 ]]; then\n\t\tautoneg_str=\"autoneg off\"\n\tfi\n\n\tethtool -s $swp1 speed $max_speed lanes $unsupported_lanes $autoneg_str &> /dev/null\n\tcheck_fail $? \"Unsuccessful $unsupported_lanes lanes setting was expected\"\n}\n\nmax_speed_and_lanes_get()\n{\n\tlocal dev=$1; shift\n\tlocal arr=(\"$@\")\n\tlocal max_lanes\n\tlocal max_speed\n\tlocal -a lanes_arr\n\tlocal -a speeds_arr\n\tlocal -a max_values\n\n\tfor ((i=0; i<${#arr[@]}; i+=2)); do\n\t\tspeeds_arr+=(\"${arr[$i]}\")\n\t\tlanes_arr+=(\"${arr[i+1]}\")\n\tdone\n\n\tmax_values+=($(get_max \"${speeds_arr[@]}\"))\n\tmax_values+=($(get_max \"${lanes_arr[@]}\"))\n\n\techo ${max_values[@]}\n}\n\nsearch_linkmode()\n{\n\tlocal speed=$1; shift\n\tlocal lanes=$1; shift\n\tlocal arr=(\"$@\")\n\n\tfor ((i=0; i<${#arr[@]}; i+=2)); do\n\t\tif [[ $speed -eq ${arr[$i]} && $lanes -eq ${arr[i+1]} ]]; then\n\t\t\treturn 1\n\t\tfi\n\tdone\n\treturn 0\n}\n\nautoneg()\n{\n\tRET=0\n\n\tlocal lanes\n\tlocal max_speed\n\tlocal max_lanes\n\n\tlocal -a linkmodes_params=($(dev_linkmodes_params_get $swp1 1))\n\tlocal -a max_values=($(max_speed_and_lanes_get $swp1 \"${linkmodes_params[@]}\"))\n\tmax_speed=${max_values[0]}\n\tmax_lanes=${max_values[1]}\n\n\tlanes=$max_lanes\n\n\twhile [[ $lanes -ge 1 ]]; do\n\t\tsearch_linkmode $max_speed $lanes \"${linkmodes_params[@]}\"\n\t\tif [[ $? -eq 1 ]]; then\n\t\t\tethtool_set $swp1 speed $max_speed lanes $lanes\n\t\t\tip link set dev $swp1 up\n\t\t\tip link set dev $swp2 up\n\t\t\tbusywait \"$TIMEOUT\" wait_for_port_up ethtool $swp2\n\t\t\tcheck_err $? \"ports did not come up\"\n\n\t\t\tcheck_lanes $swp1 $lanes $max_speed\n\t\t\tlog_test \"$lanes lanes is autonegotiated\"\n\t\tfi\n\t\tlet $((lanes /= 2))\n\tdone\n\n\tcheck_unsupported_lanes $swp1 $max_speed $max_lanes 1\n\tlog_test \"Lanes number larger than max width is not set\"\n\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n}\n\nautoneg_force_mode()\n{\n\tRET=0\n\n\tlocal lanes\n\tlocal max_speed\n\tlocal max_lanes\n\n\tlocal -a linkmodes_params=($(dev_linkmodes_params_get $swp1 1))\n\tlocal -a max_values=($(max_speed_and_lanes_get $swp1 \"${linkmodes_params[@]}\"))\n\tmax_speed=${max_values[0]}\n\tmax_lanes=${max_values[1]}\n\n\tlanes=$max_lanes\n\n\twhile [[ $lanes -ge 1 ]]; do\n\t\tsearch_linkmode $max_speed $lanes \"${linkmodes_params[@]}\"\n\t\tif [[ $? -eq 1 ]]; then\n\t\t\tethtool_set $swp1 speed $max_speed lanes $lanes autoneg off\n\t\t\tethtool_set $swp2 speed $max_speed lanes $lanes autoneg off\n\t\t\tip link set dev $swp1 up\n\t\t\tip link set dev $swp2 up\n\t\t\tbusywait \"$TIMEOUT\" wait_for_port_up ethtool $swp2\n\t\t\tcheck_err $? \"ports did not come up\"\n\n\t\t\tcheck_lanes $swp1 $lanes $max_speed\n\t\t\tlog_test \"Autoneg off, $lanes lanes detected during force mode\"\n\t\tfi\n\t\tlet $((lanes /= 2))\n\tdone\n\n\tcheck_unsupported_lanes $swp1 $max_speed $max_lanes 0\n\tlog_test \"Lanes number larger than max width is not set\"\n\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n\n\tethtool -s $swp2 autoneg on\n\tethtool -s $swp1 autoneg on\n}\n\ncheck_ethtool_lanes_support\nsetup_prepare\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}