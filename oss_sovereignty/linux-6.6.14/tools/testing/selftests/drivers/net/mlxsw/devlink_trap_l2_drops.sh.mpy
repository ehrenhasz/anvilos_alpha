{
  "module_name": "devlink_trap_l2_drops.sh",
  "hash_id": "570e99cbf980d32406bc22075783b38f59a77af981657cc66d9fb2a37d9983e3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/devlink_trap_l2_drops.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test devlink-trap L2 drops functionality over mlxsw. Each registered L2 drop\n# packet trap is tested to make sure it is triggered under the right\n# conditions.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tsource_mac_is_multicast_test\n\tvlan_tag_mismatch_test\n\tingress_vlan_filter_test\n\tingress_stp_filter_test\n\tport_list_is_empty_test\n\tport_loopback_filter_test\n\tlocked_port_test\n\"\nNUM_NETIFS=4\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2\n}\n\nswitch_create()\n{\n\tip link add dev br0 type bridge vlan_filtering 1 mcast_snooping 0\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp2 master br0\n\n\tip link set dev br0 up\n\tip link set dev $swp1 up\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n\n\tip link del dev br0\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nsource_mac_is_multicast_test()\n{\n\tlocal trap_name=\"source_mac_is_multicast\"\n\tlocal smac=01:02:03:04:05:06\n\tlocal mz_pid\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower src_mac $smac action drop\n\n\t$MZ $h1 -c 0 -p 100 -a $smac -b bcast -t ip -d 1msec -q &\n\tmz_pid=$!\n\n\tRET=0\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\tlog_test \"Source MAC is multicast\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n}\n\n__vlan_tag_mismatch_test()\n{\n\tlocal trap_name=\"vlan_tag_mismatch\"\n\tlocal dmac=de:ad:be:ef:13:37\n\tlocal opt=$1; shift\n\tlocal mz_pid\n\n\t# Remove PVID flag. This should prevent untagged and prio-tagged\n\t# packets from entering the bridge.\n\tbridge vlan add vid 1 dev $swp1 untagged master\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_mac $dmac action drop\n\n\t$MZ $h1 \"$opt\" -c 0 -p 100 -a own -b $dmac -t ip -d 1msec -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\t# Add PVID and make sure packets are no longer dropped.\n\tbridge vlan add vid 1 dev $swp1 pvid untagged master\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_idle_test $trap_name\n\tcheck_err $? \"Trap stats not idle when packets should not be dropped\"\n\tdevlink_trap_group_stats_idle_test $(devlink_trap_group_get $trap_name)\n\tcheck_err $? \"Trap group stats not idle with when packets should not be dropped\"\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_fail $? \"Packets not forwarded when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n}\n\nvlan_tag_mismatch_untagged_test()\n{\n\tRET=0\n\n\t__vlan_tag_mismatch_test\n\n\tlog_test \"VLAN tag mismatch - untagged packets\"\n}\n\nvlan_tag_mismatch_vid_0_test()\n{\n\tRET=0\n\n\t__vlan_tag_mismatch_test \"-Q 0\"\n\n\tlog_test \"VLAN tag mismatch - prio-tagged packets\"\n}\n\nvlan_tag_mismatch_test()\n{\n\tvlan_tag_mismatch_untagged_test\n\tvlan_tag_mismatch_vid_0_test\n}\n\ningress_vlan_filter_test()\n{\n\tlocal trap_name=\"ingress_vlan_filter\"\n\tlocal dmac=de:ad:be:ef:13:37\n\tlocal mz_pid\n\tlocal vid=10\n\n\tbridge vlan add vid $vid dev $swp2 master\n\n\tRET=0\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_mac $dmac action drop\n\n\t$MZ $h1 -Q $vid -c 0 -p 100 -a own -b $dmac -t ip -d 1msec -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\t# Add the VLAN on the bridge port and make sure packets are no longer\n\t# dropped.\n\tbridge vlan add vid $vid dev $swp1 master\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_idle_test $trap_name\n\tcheck_err $? \"Trap stats not idle when packets should not be dropped\"\n\tdevlink_trap_group_stats_idle_test $(devlink_trap_group_get $trap_name)\n\tcheck_err $? \"Trap group stats not idle with when packets should not be dropped\"\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_fail $? \"Packets not forwarded when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tlog_test \"Ingress VLAN filter\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n\n\tbridge vlan del vid $vid dev $swp1 master\n\tbridge vlan del vid $vid dev $swp2 master\n}\n\n__ingress_stp_filter_test()\n{\n\tlocal trap_name=\"ingress_spanning_tree_filter\"\n\tlocal dmac=de:ad:be:ef:13:37\n\tlocal state=$1; shift\n\tlocal mz_pid\n\tlocal vid=20\n\n\tbridge vlan add vid $vid dev $swp2 master\n\tbridge vlan add vid $vid dev $swp1 master\n\tip link set dev $swp1 type bridge_slave state $state\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_mac $dmac action drop\n\n\t$MZ $h1 -Q $vid -c 0 -p 100 -a own -b $dmac -t ip -d 1msec -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\t# Change STP state to forwarding and make sure packets are no longer\n\t# dropped.\n\tip link set dev $swp1 type bridge_slave state 3\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_idle_test $trap_name\n\tcheck_err $? \"Trap stats not idle when packets should not be dropped\"\n\tdevlink_trap_group_stats_idle_test $(devlink_trap_group_get $trap_name)\n\tcheck_err $? \"Trap group stats not idle with when packets should not be dropped\"\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_fail $? \"Packets not forwarded when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n\n\tbridge vlan del vid $vid dev $swp1 master\n\tbridge vlan del vid $vid dev $swp2 master\n}\n\ningress_stp_filter_listening_test()\n{\n\tlocal state=$1; shift\n\n\tRET=0\n\n\t__ingress_stp_filter_test $state\n\n\tlog_test \"Ingress STP filter - listening state\"\n}\n\ningress_stp_filter_learning_test()\n{\n\tlocal state=$1; shift\n\n\tRET=0\n\n\t__ingress_stp_filter_test $state\n\n\tlog_test \"Ingress STP filter - learning state\"\n}\n\ningress_stp_filter_test()\n{\n\tingress_stp_filter_listening_test 1\n\tingress_stp_filter_learning_test 2\n}\n\nport_list_is_empty_uc_test()\n{\n\tlocal trap_name=\"port_list_is_empty\"\n\tlocal dmac=de:ad:be:ef:13:37\n\tlocal mz_pid\n\n\t# Disable unicast flooding on both ports, so that packets cannot egress\n\t# any port.\n\tip link set dev $swp1 type bridge_slave flood off\n\tip link set dev $swp2 type bridge_slave flood off\n\n\tRET=0\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_mac $dmac action drop\n\n\t$MZ $h1 -c 0 -p 100 -a own -b $dmac -t ip -d 1msec -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\t# Allow packets to be flooded to one port.\n\tip link set dev $swp2 type bridge_slave flood on\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_idle_test $trap_name\n\tcheck_err $? \"Trap stats not idle when packets should not be dropped\"\n\tdevlink_trap_group_stats_idle_test $(devlink_trap_group_get $trap_name)\n\tcheck_err $? \"Trap group stats not idle with when packets should not be dropped\"\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_fail $? \"Packets not forwarded when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tlog_test \"Port list is empty - unicast\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n\n\tip link set dev $swp1 type bridge_slave flood on\n}\n\nport_list_is_empty_mc_test()\n{\n\tlocal trap_name=\"port_list_is_empty\"\n\tlocal dmac=01:00:5e:00:00:01\n\tlocal dip=239.0.0.1\n\tlocal mz_pid\n\n\t# Disable multicast flooding on both ports, so that packets cannot\n\t# egress any port. We also need to flush IP addresses from the bridge\n\t# in order to prevent packets from being flooded to the router port.\n\tip link set dev $swp1 type bridge_slave mcast_flood off\n\tip link set dev $swp2 type bridge_slave mcast_flood off\n\tip address flush dev br0\n\n\tRET=0\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_mac $dmac action drop\n\n\t$MZ $h1 -c 0 -p 100 -a own -b $dmac -t ip -B $dip -d 1msec -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\t# Allow packets to be flooded to one port.\n\tip link set dev $swp2 type bridge_slave mcast_flood on\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_idle_test $trap_name\n\tcheck_err $? \"Trap stats not idle when packets should not be dropped\"\n\tdevlink_trap_group_stats_idle_test $(devlink_trap_group_get $trap_name)\n\tcheck_err $? \"Trap group stats not idle with when packets should not be dropped\"\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_fail $? \"Packets not forwarded when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tlog_test \"Port list is empty - multicast\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n\n\tip link set dev $swp1 type bridge_slave mcast_flood on\n}\n\nport_list_is_empty_test()\n{\n\tport_list_is_empty_uc_test\n\tport_list_is_empty_mc_test\n}\n\nport_loopback_filter_uc_test()\n{\n\tlocal trap_name=\"port_loopback_filter\"\n\tlocal dmac=de:ad:be:ef:13:37\n\tlocal mz_pid\n\n\t# Make sure packets can only egress the input port.\n\tip link set dev $swp2 type bridge_slave flood off\n\n\tRET=0\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_mac $dmac action drop\n\n\t$MZ $h1 -c 0 -p 100 -a own -b $dmac -t ip -d 1msec -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp2 101\n\n\t# Allow packets to be flooded.\n\tip link set dev $swp2 type bridge_slave flood on\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_idle_test $trap_name\n\tcheck_err $? \"Trap stats not idle when packets should not be dropped\"\n\tdevlink_trap_group_stats_idle_test $(devlink_trap_group_get $trap_name)\n\tcheck_err $? \"Trap group stats not idle with when packets should not be dropped\"\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_fail $? \"Packets not forwarded when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tlog_test \"Port loopback filter - unicast\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp2 ip 1 101\n}\n\nport_loopback_filter_test()\n{\n\tport_loopback_filter_uc_test\n}\n\nlocked_port_miss_test()\n{\n\tlocal trap_name=\"locked_port\"\n\tlocal smac=00:11:22:33:44:55\n\n\tbridge link set dev $swp1 learning off\n\tbridge link set dev $swp1 locked on\n\n\tRET=0\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased before setting action to \\\"trap\\\"\"\n\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_err $? \"Trap stats did not increase when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased after setting action to \\\"drop\\\"\"\n\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tbridge fdb replace $smac dev $swp1 master static vlan 1\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased after adding an FDB entry\"\n\n\tbridge fdb del $smac dev $swp1 master static vlan 1\n\tbridge link set dev $swp1 locked off\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased after unlocking port\"\n\n\tlog_test \"Locked port - FDB miss\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\tbridge link set dev $swp1 learning on\n}\n\nlocked_port_mismatch_test()\n{\n\tlocal trap_name=\"locked_port\"\n\tlocal smac=00:11:22:33:44:55\n\n\tbridge link set dev $swp1 learning off\n\tbridge link set dev $swp1 locked on\n\n\tRET=0\n\n\tbridge fdb replace $smac dev $swp2 master static vlan 1\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased before setting action to \\\"trap\\\"\"\n\n\tdevlink_trap_action_set $trap_name \"trap\"\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_err $? \"Trap stats did not increase when should\"\n\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased after setting action to \\\"drop\\\"\"\n\n\tdevlink_trap_action_set $trap_name \"trap\"\n\tbridge link set dev $swp1 locked off\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased after unlocking port\"\n\n\tbridge link set dev $swp1 locked on\n\tbridge fdb replace $smac dev $swp1 master static vlan 1\n\n\tdevlink_trap_stats_check $trap_name $MZ $h1 -c 1 \\\n\t\t-a $smac -b $(mac_get $h2) -A 192.0.2.1 -B 192.0.2.2 -p 100 -q\n\tcheck_fail $? \"Trap stats increased after replacing an FDB entry\"\n\n\tbridge fdb del $smac dev $swp1 master static vlan 1\n\tdevlink_trap_action_set $trap_name \"drop\"\n\n\tlog_test \"Locked port - FDB mismatch\"\n\n\tbridge link set dev $swp1 locked off\n\tbridge link set dev $swp1 learning on\n}\n\nlocked_port_test()\n{\n\tlocked_port_miss_test\n\tlocked_port_mismatch_test\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}