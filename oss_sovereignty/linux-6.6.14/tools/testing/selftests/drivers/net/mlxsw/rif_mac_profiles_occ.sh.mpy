{
  "module_name": "rif_mac_profiles_occ.sh",
  "hash_id": "4f50a11bdb05bf2d2512e232cd013f8a7f3d46d07d544f18417ff87e7d0978c2",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/rif_mac_profiles_occ.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\trif_mac_profile_edit_test\n\"\nNUM_NETIFS=2\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\n\t# Disable IPv6 on the two interfaces to avoid IPv6 link-local addresses\n\t# being generated and RIFs being created\n\tsysctl_set net.ipv6.conf.$h1.disable_ipv6 1\n\tsysctl_set net.ipv6.conf.$h2.disable_ipv6 1\n\n\tip link set $h1 up\n\tip link set $h2 up\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip link set $h2 down\n\tip link set $h1 down\n\n\tsysctl_restore net.ipv6.conf.$h2.disable_ipv6\n\tsysctl_restore net.ipv6.conf.$h1.disable_ipv6\n\n\t# Reload in order to clean all the RIFs and RIF MAC profiles created\n\tdevlink_reload\n}\n\ncreate_max_rif_mac_profiles()\n{\n\tlocal count=$1; shift\n\tlocal batch_file=\"$(mktemp)\"\n\n\tfor ((i = 1; i <= count; i++)); do\n\t\tvlan=$(( i*10 ))\n\t\tm=$(( i*11 ))\n\n\t\tcat >> $batch_file <<-EOF\n\t\t\tlink add link $h1 name $h1.$vlan \\\n\t\t\t\taddress 00:$m:$m:$m:$m:$m type vlan id $vlan\n\t\t\taddress add 192.0.$m.1/24 dev $h1.$vlan\n\t\tEOF\n\tdone\n\n\tip -b $batch_file &> /dev/null\n\trm -f $batch_file\n}\n\nrif_mac_profile_replacement_test()\n{\n\tlocal h1_10_mac=$(mac_get $h1.10)\n\n\tRET=0\n\n\tip link set $h1.10 address 00:12:34:56:78:99\n\tcheck_err $?\n\n\tlog_test \"RIF MAC profile replacement\"\n\n\tip link set $h1.10 address $h1_10_mac\n}\n\nrif_mac_profile_consolidation_test()\n{\n\tlocal count=$1; shift\n\tlocal h1_20_mac\n\n\tRET=0\n\n\tif [[ $count -eq 1 ]]; then\n\t\treturn\n\tfi\n\n\th1_20_mac=$(mac_get $h1.20)\n\n\t# Set the MAC of $h1.20 to that of $h1.10 and confirm that they are\n\t# using the same MAC profile.\n\tip link set $h1.20 address 00:11:11:11:11:11\n\tcheck_err $?\n\n\tocc=$(devlink -j resource show $DEVLINK_DEV \\\n\t      | jq '.[][][] | select(.name==\"rif_mac_profiles\") |.[\"occ\"]')\n\n\t[[ $occ -eq $((count - 1)) ]]\n\tcheck_err $? \"MAC profile occupancy did not decrease\"\n\n\tlog_test \"RIF MAC profile consolidation\"\n\n\tip link set $h1.20 address $h1_20_mac\n}\n\nrif_mac_profile_shared_replacement_test()\n{\n\tlocal count=$1; shift\n\tlocal i=$((count + 1))\n\tlocal vlan=$(( i*10 ))\n\tlocal m=11\n\n\tRET=0\n\n\t# Create a VLAN netdevice that has the same MAC as the first one.\n\tip link add link $h1 name $h1.$vlan address 00:$m:$m:$m:$m:$m \\\n\t\ttype vlan id $vlan\n\tip address add 192.0.$m.1/24 dev $h1.$vlan\n\n\t# MAC replacement should fail because all the MAC profiles are in use\n\t# and the profile is shared between multiple RIFs\n\tm=$(( i*11 ))\n\tip link set $h1.$vlan address 00:$m:$m:$m:$m:$m &> /dev/null\n\tcheck_fail $?\n\n\tlog_test \"RIF MAC profile shared replacement\"\n\n\tip link del dev $h1.$vlan\n}\n\nrif_mac_profile_edit_test()\n{\n\tlocal count=$(devlink_resource_size_get rif_mac_profiles)\n\n\tcreate_max_rif_mac_profiles $count\n\n\trif_mac_profile_replacement_test\n\trif_mac_profile_consolidation_test $count\n\trif_mac_profile_shared_replacement_test $count\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}