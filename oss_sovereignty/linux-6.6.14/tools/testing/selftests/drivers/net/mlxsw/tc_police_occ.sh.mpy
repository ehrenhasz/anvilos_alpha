{
  "module_name": "tc_police_occ.sh",
  "hash_id": "40e1a2f2fca6733f70fc1fe7b328076cdc5ace1113bd0bd0c68ea8a2753487ad",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/tc_police_occ.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test that policers shared by different tc filters are correctly reference\n# counted by observing policers' occupancy via devlink-resource.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\ttc_police_occ_test\n\"\nNUM_NETIFS=2\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1\n}\n\nswitch_create()\n{\n\tsimple_if_init $swp1\n\ttc qdisc add dev $swp1 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp1 clsact\n\tsimple_if_fini $swp1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tvrf_prepare\n\n\th1_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntc_police_occ_get()\n{\n\tdevlink_resource_occ_get global_policers single_rate_policers\n}\n\ntc_police_occ_test()\n{\n\tRET=0\n\n\tlocal occ=$(tc_police_occ_get)\n\n\ttc filter add dev $swp1 ingress pref 1 handle 101 proto ip \\\n\t\tflower skip_sw \\\n\t\taction police rate 100mbit burst 100k conform-exceed drop/ok\n\t(( occ + 1 == $(tc_police_occ_get) ))\n\tcheck_err $? \"Got occupancy $(tc_police_occ_get), expected $((occ + 1))\"\n\n\ttc filter del dev $swp1 ingress pref 1 handle 101 flower\n\t(( occ == $(tc_police_occ_get) ))\n\tcheck_err $? \"Got occupancy $(tc_police_occ_get), expected $occ\"\n\n\ttc filter add dev $swp1 ingress pref 1 handle 101 proto ip \\\n\t\tflower skip_sw \\\n\t\taction police rate 100mbit burst 100k conform-exceed drop/ok \\\n\t\tindex 10\n\ttc filter add dev $swp1 ingress pref 2 handle 102 proto ip \\\n\t\tflower skip_sw action police index 10\n\n\t(( occ + 1 == $(tc_police_occ_get) ))\n\tcheck_err $? \"Got occupancy $(tc_police_occ_get), expected $((occ + 1))\"\n\n\ttc filter del dev $swp1 ingress pref 2 handle 102 flower\n\t(( occ + 1 == $(tc_police_occ_get) ))\n\tcheck_err $? \"Got occupancy $(tc_police_occ_get), expected $((occ + 1))\"\n\n\ttc filter del dev $swp1 ingress pref 1 handle 101 flower\n\t(( occ == $(tc_police_occ_get) ))\n\tcheck_err $? \"Got occupancy $(tc_police_occ_get), expected $occ\"\n\n\tlog_test \"tc police occupancy\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}