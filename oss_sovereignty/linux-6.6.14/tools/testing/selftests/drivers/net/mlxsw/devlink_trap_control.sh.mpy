{
  "module_name": "devlink_trap_control.sh",
  "hash_id": "3467514389f1844880bdadfaa3f213f3c5687a94cfe4db2e787f0c16d6dece76",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/devlink_trap_control.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test devlink-trap control trap functionality over mlxsw. Each registered\n# control packet trap is tested to make sure it is triggered under the right\n# conditions.\n#\n# +---------------------------------+\n# | H1 (vrf)                        |\n# |    + $h1                        |\n# |    | 192.0.2.1/24               |\n# |    | 2001:db8:1::1/64           |\n# |    |                            |\n# |    |  default via 192.0.2.2     |\n# |    |  default via 2001:db8:1::2 |\n# +----|----------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# |    + $rp1                                                                 |\n# |        192.0.2.2/24                                                       |\n# |        2001:db8:1::2/64                                                   |\n# |                                                                           |\n# |        2001:db8:2::2/64                                                   |\n# |        198.51.100.2/24                                                    |\n# |    + $rp2                                                                 |\n# |    |                                                                      |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|----------------------------+\n# |    |  default via 198.51.100.2  |\n# |    |  default via 2001:db8:2::2 |\n# |    |                            |\n# |    | 2001:db8:2::1/64           |\n# |    | 198.51.100.1/24            |\n# |    + $h2                        |\n# | H2 (vrf)                        |\n# +---------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tstp_test\n\tlacp_test\n\tlldp_test\n\tigmp_query_test\n\tigmp_v1_report_test\n\tigmp_v2_report_test\n\tigmp_v3_report_test\n\tigmp_v2_leave_test\n\tmld_query_test\n\tmld_v1_report_test\n\tmld_v2_report_test\n\tmld_v1_done_test\n\tipv4_dhcp_test\n\tipv6_dhcp_test\n\tarp_request_test\n\tarp_response_test\n\tipv6_neigh_solicit_test\n\tipv6_neigh_advert_test\n\tipv4_bfd_test\n\tipv6_bfd_test\n\tipv4_ospf_test\n\tipv6_ospf_test\n\tipv4_bgp_test\n\tipv6_bgp_test\n\tipv4_vrrp_test\n\tipv6_vrrp_test\n\tipv4_pim_test\n\tipv6_pim_test\n\tuc_loopback_test\n\tlocal_route_test\n\texternal_route_test\n\tipv6_uc_dip_link_local_scope_test\n\tipv4_router_alert_test\n\tipv6_router_alert_test\n\tipv6_dip_all_nodes_test\n\tipv6_dip_all_routers_test\n\tipv6_router_solicit_test\n\tipv6_router_advert_test\n\tipv6_redirect_test\n\tptp_event_test\n\tptp_general_test\n\tflow_action_sample_test\n\tflow_action_trap_test\n\teapol_test\n\"\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\nsource mlxsw_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24 2001:db8:1::1/64\n\n\tip -4 route add default vrf v$h1 nexthop via 192.0.2.2\n\tip -6 route add default vrf v$h1 nexthop via 2001:db8:1::2\n}\n\nh1_destroy()\n{\n\tip -6 route del default vrf v$h1 nexthop via 2001:db8:1::2\n\tip -4 route del default vrf v$h1 nexthop via 192.0.2.2\n\n\tsimple_if_fini $h1 192.0.2.1/24 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 198.51.100.1/24 2001:db8:2::1/64\n\n\tip -4 route add default vrf v$h2 nexthop via 198.51.100.2\n\tip -6 route add default vrf v$h2 nexthop via 2001:db8:2::2\n}\n\nh2_destroy()\n{\n\tip -6 route del default vrf v$h2 nexthop via 2001:db8:2::2\n\tip -4 route del default vrf v$h2 nexthop via 198.51.100.2\n\n\tsimple_if_fini $h2 198.51.100.1/24 2001:db8:2::1/64\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\n\t__addr_add_del $rp1 add 192.0.2.2/24 2001:db8:1::2/64\n\t__addr_add_del $rp2 add 198.51.100.2/24 2001:db8:2::2/64\n}\n\nrouter_destroy()\n{\n\t__addr_add_del $rp2 del 198.51.100.2/24 2001:db8:2::2/64\n\t__addr_add_del $rp1 del 192.0.2.2/24 2001:db8:1::2/64\n\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\trouter_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\trouter_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\nstp_test()\n{\n\tdevlink_trap_stats_test \"STP\" \"stp\" $MZ $h1 -c 1 -t bpdu -q\n}\n\nlacp_payload_get()\n{\n\tlocal source_mac=$1; shift\n\tlocal p\n\n\tp=$(:\n\t\t)\"01:80:C2:00:00:02:\"$(       : ETH daddr\n\t\t)\"$source_mac:\"$(             : ETH saddr\n\t\t)\"88:09:\"$(                   : ETH type\n\t\t)\n\techo $p\n}\n\nlacp_test()\n{\n\tlocal h1mac=$(mac_get $h1)\n\n\tdevlink_trap_stats_test \"LACP\" \"lacp\" $MZ $h1 -c 1 \\\n\t\t$(lacp_payload_get $h1mac) -p 100 -q\n}\n\nlldp_payload_get()\n{\n\tlocal source_mac=$1; shift\n\tlocal p\n\n\tp=$(:\n\t\t)\"01:80:C2:00:00:0E:\"$(       : ETH daddr\n\t\t)\"$source_mac:\"$(             : ETH saddr\n\t\t)\"88:CC:\"$(                   : ETH type\n\t\t)\n\techo $p\n}\n\nlldp_test()\n{\n\tlocal h1mac=$(mac_get $h1)\n\n\tdevlink_trap_stats_test \"LLDP\" \"lldp\" $MZ $h1 -c 1 \\\n\t\t$(lldp_payload_get $h1mac) -p 100 -q\n}\n\nigmp_query_test()\n{\n\t# IGMP (IP Protocol 2) Membership Query (Type 0x11)\n\tdevlink_trap_stats_test \"IGMP Membership Query\" \"igmp_query\" \\\n\t\t$MZ $h1 -c 1 -a own -b 01:00:5E:00:00:01 \\\n\t\t-A 192.0.2.1 -B 224.0.0.1 -t ip proto=2,p=11 -p 100 -q\n}\n\nigmp_v1_report_test()\n{\n\t# IGMP (IP Protocol 2) Version 1 Membership Report (Type 0x12)\n\tdevlink_trap_stats_test \"IGMP Version 1 Membership Report\" \\\n\t\t\"igmp_v1_report\" $MZ $h1 -c 1 -a own -b 01:00:5E:00:00:01 \\\n\t\t-A 192.0.2.1 -B 244.0.0.1 -t ip proto=2,p=12 -p 100 -q\n}\n\nigmp_v2_report_test()\n{\n\t# IGMP (IP Protocol 2) Version 2 Membership Report (Type 0x16)\n\tdevlink_trap_stats_test \"IGMP Version 2 Membership Report\" \\\n\t\t\"igmp_v2_report\" $MZ $h1 -c 1 -a own -b 01:00:5E:00:00:01 \\\n\t\t-A 192.0.2.1 -B 244.0.0.1 -t ip proto=2,p=16 -p 100 -q\n}\n\nigmp_v3_report_test()\n{\n\t# IGMP (IP Protocol 2) Version 3 Membership Report (Type 0x22)\n\tdevlink_trap_stats_test \"IGMP Version 3 Membership Report\" \\\n\t\t\"igmp_v3_report\" $MZ $h1 -c 1 -a own -b 01:00:5E:00:00:01 \\\n\t\t-A 192.0.2.1 -B 244.0.0.1 -t ip proto=2,p=22 -p 100 -q\n}\n\nigmp_v2_leave_test()\n{\n\t# IGMP (IP Protocol 2) Version 2 Leave Group (Type 0x17)\n\tdevlink_trap_stats_test \"IGMP Version 2 Leave Group\" \\\n\t\t\"igmp_v2_leave\" $MZ $h1 -c 1 -a own -b 01:00:5E:00:00:02 \\\n\t\t-A 192.0.2.1 -B 224.0.0.2 -t ip proto=2,p=17 -p 100 -q\n}\n\nmld_payload_get()\n{\n\tlocal type=$1; shift\n\tlocal p\n\n\ttype=$(printf \"%x\" $type)\n\tp=$(:\n\t\t)\"3A:\"$(\t\t\t: Next Header - ICMPv6\n\t\t)\"00:\"$(\t\t\t: Hdr Ext Len\n\t\t)\"00:00:00:00:00:00:\"$(\t\t: Options and Padding\n\t\t)\"$type:\"$(\t\t\t: ICMPv6.type\n\t\t)\"00:\"$(\t\t\t: ICMPv6.code\n\t\t)\"00:\"$(\t\t\t: ICMPv6.checksum\n\t\t)\n\techo $p\n}\n\nmld_query_test()\n{\n\t# MLD Multicast Listener Query (Type 130)\n\tdevlink_trap_stats_test \"MLD Multicast Listener Query\" \"mld_query\" \\\n\t\t$MZ $h1 -6 -c 1 -A fe80::1 -B ff02::1 \\\n\t\t-t ip hop=1,next=0,payload=$(mld_payload_get 130) -p 100 -q\n}\n\nmld_v1_report_test()\n{\n\t# MLD Version 1 Multicast Listener Report (Type 131)\n\tdevlink_trap_stats_test \"MLD Version 1 Multicast Listener Report\" \\\n\t\t\"mld_v1_report\" $MZ $h1 -6 -c 1 -A fe80::1 -B ff02::16 \\\n\t\t-t ip hop=1,next=0,payload=$(mld_payload_get 131) -p 100 -q\n}\n\nmld_v2_report_test()\n{\n\t# MLD Version 2 Multicast Listener Report (Type 143)\n\tdevlink_trap_stats_test \"MLD Version 2 Multicast Listener Report\" \\\n\t\t\"mld_v2_report\" $MZ $h1 -6 -c 1 -A fe80::1 -B ff02::16 \\\n\t\t-t ip hop=1,next=0,payload=$(mld_payload_get 143) -p 100 -q\n}\n\nmld_v1_done_test()\n{\n\t# MLD Version 1 Multicast Listener Done (Type 132)\n\tdevlink_trap_stats_test \"MLD Version 1 Multicast Listener Done\" \\\n\t\t\"mld_v1_done\" $MZ $h1 -6 -c 1 -A fe80::1 -B ff02::16 \\\n\t\t-t ip hop=1,next=0,payload=$(mld_payload_get 132) -p 100 -q\n}\n\nipv4_dhcp_test()\n{\n\tdevlink_trap_stats_test \"IPv4 DHCP Port 67\" \"ipv4_dhcp\" \\\n\t\t$MZ $h1 -c 1 -a own -b bcast -A 0.0.0.0 -B 255.255.255.255 \\\n\t\t-t udp sp=68,dp=67 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv4 DHCP Port 68\" \"ipv4_dhcp\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) -A 192.0.2.1 \\\n\t\t-B 255.255.255.255 -t udp sp=67,dp=68 -p 100 -q\n}\n\nipv6_dhcp_test()\n{\n\tdevlink_trap_stats_test \"IPv6 DHCP Port 547\" \"ipv6_dhcp\" \\\n\t\t$MZ $h1 -6 -c 1 -A fe80::1 -B ff02::1:2 -t udp sp=546,dp=547 \\\n\t\t-p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 DHCP Port 546\" \"ipv6_dhcp\" \\\n\t\t$MZ $h1 -6 -c 1 -A fe80::1 -B ff02::1:2 -t udp sp=547,dp=546 \\\n\t\t-p 100 -q\n}\n\narp_request_test()\n{\n\tdevlink_trap_stats_test \"ARP Request\" \"arp_request\" \\\n\t\t$MZ $h1 -c 1 -a own -b bcast -t arp request -p 100 -q\n}\n\narp_response_test()\n{\n\tdevlink_trap_stats_test \"ARP Response\" \"arp_response\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) -t arp reply -p 100 -q\n}\n\nicmpv6_header_get()\n{\n\tlocal type=$1; shift\n\tlocal p\n\n\ttype=$(printf \"%x\" $type)\n\tp=$(:\n\t\t)\"$type:\"$(\t\t\t: ICMPv6.type\n\t\t)\"00:\"$(\t\t\t: ICMPv6.code\n\t\t)\"00:\"$(\t\t\t: ICMPv6.checksum\n\t\t)\n\techo $p\n}\n\nipv6_neigh_solicit_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Neighbour Solicitation\" \\\n\t\t\"ipv6_neigh_solicit\" $MZ $h1 -6 -c 1 \\\n\t\t-A fe80::1 -B ff02::1:ff00:02 \\\n\t\t-t ip hop=1,next=58,payload=$(icmpv6_header_get 135) -p 100 -q\n}\n\nipv6_neigh_advert_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Neighbour Advertisement\" \\\n\t\t\"ipv6_neigh_advert\" $MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A fe80::1 -B 2001:db8:1::2 \\\n\t\t-t ip hop=1,next=58,payload=$(icmpv6_header_get 136) -p 100 -q\n}\n\nipv4_bfd_test()\n{\n\tdevlink_trap_stats_test \"IPv4 BFD Control - Port 3784\" \"ipv4_bfd\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 192.0.2.2 -t udp sp=49153,dp=3784 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv4 BFD Echo - Port 3785\" \"ipv4_bfd\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 192.0.2.2 -t udp sp=49153,dp=3785 -p 100 -q\n}\n\nipv6_bfd_test()\n{\n\tdevlink_trap_stats_test \"IPv6 BFD Control - Port 3784\" \"ipv6_bfd\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:1::2 \\\n\t\t-t udp sp=49153,dp=3784 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 BFD Echo - Port 3785\" \"ipv6_bfd\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:1::2 \\\n\t\t-t udp sp=49153,dp=3785 -p 100 -q\n}\n\nipv4_ospf_test()\n{\n\tdevlink_trap_stats_test \"IPv4 OSPF - Multicast\" \"ipv4_ospf\" \\\n\t\t$MZ $h1 -c 1 -a own -b 01:00:5e:00:00:05 \\\n\t\t-A 192.0.2.1 -B 224.0.0.5 -t ip proto=89 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv4 OSPF - Unicast\" \"ipv4_ospf\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 192.0.2.2 -t ip proto=89 -p 100 -q\n}\n\nipv6_ospf_test()\n{\n\tdevlink_trap_stats_test \"IPv6 OSPF - Multicast\" \"ipv6_ospf\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:05 \\\n\t\t-A fe80::1 -B ff02::5 -t ip next=89 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 OSPF - Unicast\" \"ipv6_ospf\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:1::2 -t ip next=89 -p 100 -q\n}\n\nipv4_bgp_test()\n{\n\tdevlink_trap_stats_test \"IPv4 BGP\" \"ipv4_bgp\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 192.0.2.2 -t tcp sp=54321,dp=179,flags=rst \\\n\t\t-p 100 -q\n}\n\nipv6_bgp_test()\n{\n\tdevlink_trap_stats_test \"IPv6 BGP\" \"ipv6_bgp\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:1::2 \\\n\t\t-t tcp sp=54321,dp=179,flags=rst -p 100 -q\n}\n\nipv4_vrrp_test()\n{\n\tdevlink_trap_stats_test \"IPv4 VRRP\" \"ipv4_vrrp\" \\\n\t\t$MZ $h1 -c 1 -a own -b 01:00:5e:00:00:12 \\\n\t\t-A 192.0.2.1 -B 224.0.0.18 -t ip proto=112 -p 100 -q\n}\n\nipv6_vrrp_test()\n{\n\tdevlink_trap_stats_test \"IPv6 VRRP\" \"ipv6_vrrp\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:12 \\\n\t\t-A fe80::1 -B ff02::12 -t ip next=112 -p 100 -q\n}\n\nipv4_pim_test()\n{\n\tdevlink_trap_stats_test \"IPv4 PIM - Multicast\" \"ipv4_pim\" \\\n\t\t$MZ $h1 -c 1 -a own -b 01:00:5e:00:00:0d \\\n\t\t-A 192.0.2.1 -B 224.0.0.13 -t ip proto=103 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv4 PIM - Unicast\" \"ipv4_pim\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 192.0.2.2 -t ip proto=103 -p 100 -q\n}\n\nipv6_pim_test()\n{\n\tdevlink_trap_stats_test \"IPv6 PIM - Multicast\" \"ipv6_pim\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:0d \\\n\t\t-A fe80::1 -B ff02::d -t ip next=103 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 PIM - Unicast\" \"ipv6_pim\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A fe80::1 -B 2001:db8:1::2 -t ip next=103 -p 100 -q\n}\n\nuc_loopback_test()\n{\n\t# Add neighbours to the fake destination IPs, so that the packets are\n\t# routed in the device and not trapped due to an unresolved neighbour\n\t# exception.\n\tip -4 neigh add 192.0.2.3 lladdr 00:11:22:33:44:55 nud permanent \\\n\t\tdev $rp1\n\tip -6 neigh add 2001:db8:1::3 lladdr 00:11:22:33:44:55 nud permanent \\\n\t\tdev $rp1\n\n\tdevlink_trap_stats_test \"IPv4 Unicast Loopback\" \"uc_loopback\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 192.0.2.3 -t udp sp=54321,dp=12345 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 Unicast Loopback\" \"uc_loopback\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:1::3 -t udp sp=54321,dp=12345 \\\n\t\t-p 100 -q\n\n\tip -6 neigh del 2001:db8:1::3 dev $rp1\n\tip -4 neigh del 192.0.2.3 dev $rp1\n}\n\nlocal_route_test()\n{\n\t# Use a fake source IP to prevent the trap from being triggered twice\n\t# when the router sends back a port unreachable message.\n\tdevlink_trap_stats_test \"IPv4 Local Route\" \"local_route\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.3 -B 192.0.2.2 -t udp sp=54321,dp=12345 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 Local Route\" \"local_route\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::3 -B 2001:db8:1::2 -t udp sp=54321,sp=12345 \\\n\t\t-p 100 -q\n}\n\nexternal_route_test()\n{\n\t# Add a dummy device through which the incoming packets should be\n\t# routed.\n\tip link add name dummy10 up type dummy\n\tip address add 203.0.113.1/24 dev dummy10\n\tip -6 address add 2001:db8:10::1/64 dev dummy10\n\n\tdevlink_trap_stats_test \"IPv4 External Route\" \"external_route\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 203.0.113.2 -t udp sp=54321,dp=12345 -p 100 -q\n\n\tdevlink_trap_stats_test \"IPv6 External Route\" \"external_route\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:10::2 -t udp sp=54321,sp=12345 \\\n\t\t-p 100 -q\n\n\tip -6 address del 2001:db8:10::1/64 dev dummy10\n\tip address del 203.0.113.1/24 dev dummy10\n\tip link del dev dummy10\n}\n\nipv6_uc_dip_link_local_scope_test()\n{\n\t# Add a dummy link-local prefix route to allow the packet to be routed.\n\tip -6 route add fe80:1::/64 dev $rp2\n\n\tdevlink_trap_stats_test \\\n\t\t\"IPv6 Unicast Destination IP With Link-Local Scope\" \\\n\t\t\"ipv6_uc_dip_link_local_scope\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A fe80::1 -B fe80:1::2 -t udp sp=54321,sp=12345 \\\n\t\t-p 100 -q\n\n\tip -6 route del fe80:1::/64 dev $rp2\n}\n\nipv4_router_alert_get()\n{\n\tlocal p\n\n\t# https://en.wikipedia.org/wiki/IPv4#Options\n\tp=$(:\n\t\t)\"94:\"$(\t\t\t: Option Number\n\t\t)\"04:\"$(\t\t\t: Option Length\n\t\t)\"00:00:\"$(\t\t\t: Option Data\n\t\t)\n\techo $p\n}\n\nipv4_router_alert_test()\n{\n\tdevlink_trap_stats_test \"IPv4 Router Alert\" \"ipv4_router_alert\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 198.51.100.3 \\\n\t\t-t ip option=$(ipv4_router_alert_get) -p 100 -q\n}\n\nipv6_router_alert_get()\n{\n\tlocal p\n\n\t# https://en.wikipedia.org/wiki/IPv6_packet#Hop-by-hop_options_and_destination_options\n\t# https://tools.ietf.org/html/rfc2711#section-2.1\n\tp=$(:\n\t\t)\"11:\"$(\t\t\t: Next Header - UDP\n\t\t)\"00:\"$(\t\t\t: Hdr Ext Len\n\t\t)\"05:02:00:00:00:00:\"$(\t\t: Option Data\n\t\t)\n\techo $p\n}\n\nipv6_router_alert_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Router Alert\" \"ipv6_router_alert\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 2001:db8:1::1 -B 2001:db8:1::3 \\\n\t\t-t ip next=0,payload=$(ipv6_router_alert_get) -p 100 -q\n}\n\nipv6_dip_all_nodes_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Destination IP \\\"All Nodes Address\\\"\" \\\n\t\t\"ipv6_dip_all_nodes\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:01 \\\n\t\t-A 2001:db8:1::1 -B ff02::1 -t udp sp=12345,dp=54321 -p 100 -q\n}\n\nipv6_dip_all_routers_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Destination IP \\\"All Routers Address\\\"\" \\\n\t\t\"ipv6_dip_all_routers\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:02 \\\n\t\t-A 2001:db8:1::1 -B ff02::2 -t udp sp=12345,dp=54321 -p 100 -q\n}\n\nipv6_router_solicit_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Router Solicitation\" \\\n\t\t\"ipv6_router_solicit\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:02 \\\n\t\t-A fe80::1 -B ff02::2 \\\n\t\t-t ip hop=1,next=58,payload=$(icmpv6_header_get 133) -p 100 -q\n}\n\nipv6_router_advert_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Router Advertisement\" \\\n\t\t\"ipv6_router_advert\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b 33:33:00:00:00:01 \\\n\t\t-A fe80::1 -B ff02::1 \\\n\t\t-t ip hop=1,next=58,payload=$(icmpv6_header_get 134) -p 100 -q\n}\n\nipv6_redirect_test()\n{\n\tdevlink_trap_stats_test \"IPv6 Redirect Message\" \\\n\t\t\"ipv6_redirect\" \\\n\t\t$MZ $h1 -6 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A fe80::1 -B 2001:db8:1::2 \\\n\t\t-t ip hop=1,next=58,payload=$(icmpv6_header_get 137) -p 100 -q\n}\n\nptp_event_test()\n{\n\tmlxsw_only_on_spectrum 1 || return\n\n\t# PTP Sync (0)\n\tdevlink_trap_stats_test \"PTP Time-Critical Event Message\" \"ptp_event\" \\\n\t\t$MZ $h1 -c 1 -a own -b 01:00:5e:00:01:81 \\\n\t\t-A 192.0.2.1 -B 224.0.1.129 \\\n\t\t-t udp sp=12345,dp=319,payload=10 -p 100 -q\n}\n\nptp_general_test()\n{\n\tmlxsw_only_on_spectrum 1 || return\n\n\t# PTP Announce (b)\n\tdevlink_trap_stats_test \"PTP General Message\" \"ptp_general\" \\\n\t\t$MZ $h1 -c 1 -a own -b 01:00:5e:00:01:81 \\\n\t\t-A 192.0.2.1 -B 224.0.1.129 \\\n\t\t-t udp sp=12345,dp=320,payload=1b -p 100 -q\n}\n\nflow_action_sample_test()\n{\n\t# Install a filter that samples every incoming packet.\n\ttc qdisc add dev $rp1 clsact\n\ttc filter add dev $rp1 ingress proto all pref 1 handle 101 matchall \\\n\t\tskip_sw action sample rate 1 group 1\n\n\tdevlink_trap_stats_test \"Flow Sampling\" \"flow_action_sample\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 198.51.100.1 -t udp sp=12345,dp=54321 -p 100 -q\n\n\ttc filter del dev $rp1 ingress proto all pref 1 handle 101 matchall\n\ttc qdisc del dev $rp1 clsact\n}\n\nflow_action_trap_test()\n{\n\t# Install a filter that traps a specific flow.\n\ttc qdisc add dev $rp1 clsact\n\ttc filter add dev $rp1 ingress proto ip pref 1 handle 101 flower \\\n\t\tskip_sw ip_proto udp src_port 12345 dst_port 54321 action trap\n\n\tdevlink_trap_stats_test \"Flow Trapping (Logging)\" \"flow_action_trap\" \\\n\t\t$MZ $h1 -c 1 -a own -b $(mac_get $rp1) \\\n\t\t-A 192.0.2.1 -B 198.51.100.1 -t udp sp=12345,dp=54321 -p 100 -q\n\n\ttc filter del dev $rp1 ingress proto ip pref 1 handle 101 flower\n\ttc qdisc del dev $rp1 clsact\n}\n\neapol_payload_get()\n{\n\tlocal source_mac=$1; shift\n\tlocal p\n\n\tp=$(:\n\t\t)\"01:80:C2:00:00:03:\"$(       : ETH daddr\n\t\t)\"$source_mac:\"$(             : ETH saddr\n\t\t)\"88:8E:\"$(                   : ETH type\n\t\t)\n\techo $p\n}\n\neapol_test()\n{\n\tlocal h1mac=$(mac_get $h1)\n\n\tdevlink_trap_stats_test \"EAPOL\" \"eapol\" $MZ $h1 -c 1 \\\n\t\t$(eapol_payload_get $h1mac) -p 100 -q\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}