{
  "module_name": "one_armed_router.sh",
  "hash_id": "86e6278b0875311d3e7520715feaecf000398fb2f2444d0586c7bfb707158547",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/one_armed_router.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test a \"one-armed router\" [1] scenario. Packets forwarded between H1 and H2\n# should be forwarded by the ASIC, but also trapped so that ICMP redirect\n# packets could be potentially generated.\n#\n# 1. https://en.wikipedia.org/wiki/One-armed_router\n#\n# +---------------------------------+\n# | H1 (vrf)                        |\n# |    + $h1                        |\n# |    | 192.0.2.1/24               |\n# |    | 2001:db8:1::1/64           |\n# |    |                            |\n# |    |  default via 192.0.2.2     |\n# |    |  default via 2001:db8:1::2 |\n# +----|----------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# | +--|--------------------------------------------------------------------+ |\n# | |  + $swp1                   BR0 (802.1d)                               | |\n# | |                                                                       | |\n# | |                            192.0.2.2/24                               | |\n# | |                          2001:db8:1::2/64                             | |\n# | |                           198.51.100.2/24                             | |\n# | |                          2001:db8:2::2/64                             | |\n# | |                                                                       | |\n# | |  + $swp2                                                              | |\n# | +--|--------------------------------------------------------------------+ |\n# |    |                                                                      |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|----------------------------+\n# |    |  default via 198.51.100.2  |\n# |    |  default via 2001:db8:2::2 |\n# |    |                            |\n# |    | 2001:db8:2::1/64           |\n# |    | 198.51.100.1/24            |\n# |    + $h2                        |\n# | H2 (vrf)                        |\n# +---------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"ping_ipv4 ping_ipv6 fwd_mark_ipv4 fwd_mark_ipv6\"\nNUM_NETIFS=4\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24 2001:db8:1::1/64\n\n\tip -4 route add default vrf v$h1 nexthop via 192.0.2.2\n\tip -6 route add default vrf v$h1 nexthop via 2001:db8:1::2\n}\n\nh1_destroy()\n{\n\tip -6 route del default vrf v$h1 nexthop via 2001:db8:1::2\n\tip -4 route del default vrf v$h1 nexthop via 192.0.2.2\n\n\tsimple_if_fini $h1 192.0.2.1/24 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 198.51.100.1/24 2001:db8:2::1/64\n\n\tip -4 route add default vrf v$h2 nexthop via 198.51.100.2\n\tip -6 route add default vrf v$h2 nexthop via 2001:db8:2::2\n}\n\nh2_destroy()\n{\n\tip -6 route del default vrf v$h2 nexthop via 2001:db8:2::2\n\tip -4 route del default vrf v$h2 nexthop via 198.51.100.2\n\n\tsimple_if_fini $h2 198.51.100.1/24 2001:db8:2::1/64\n}\n\nswitch_create()\n{\n\tip link add name br0 address $(mac_get $swp1) \\\n\t\ttype bridge mcast_snooping 0\n\tip link set dev br0 up\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br0\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp1 clsact\n\ttc qdisc add dev $swp2 clsact\n\n\t__addr_add_del br0 add 192.0.2.2/24 2001:db8:1::2/64\n\t__addr_add_del br0 add 198.51.100.2/24 2001:db8:2::2/64\n}\n\nswitch_destroy()\n{\n\t__addr_add_del br0 del 198.51.100.2/24 2001:db8:2::2/64\n\t__addr_add_del br0 del 192.0.2.2/24 2001:db8:1::2/64\n\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link set dev br0 down\n\tip link del dev br0\n}\n\nping_ipv4()\n{\n\tping_test $h1 198.51.100.1 \": h1->h2\"\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::1 \": h1->h2\"\n}\n\nfwd_mark_ipv4()\n{\n\t# Transmit packets from H1 to H2 and make sure they are trapped at\n\t# swp1 due to loopback error, but only forwarded by the ASIC through\n\t# swp2\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tskip_hw dst_ip 198.51.100.1 ip_proto udp dst_port 52768 \\\n\t\taction pass\n\n\ttc filter add dev $swp2 egress protocol ip pref 1 handle 101 flower \\\n\t\tskip_hw dst_ip 198.51.100.1 ip_proto udp dst_port 52768 \\\n\t\taction pass\n\n\ttc filter add dev $swp2 egress protocol ip pref 2 handle 102 flower \\\n\t\tskip_sw dst_ip 198.51.100.1 ip_proto udp dst_port 52768 \\\n\t\taction pass\n\n\tip vrf exec v$h1 $MZ $h1 -c 10 -d 100msec -p 64 -A 192.0.2.1 \\\n\t\t-B 198.51.100.1 -t udp dp=52768,sp=42768 -q\n\n\tRET=0\n\n\ttc_check_packets \"dev $swp1 ingress\" 101 10\n\tcheck_err $?\n\n\tlog_test \"fwd mark: trapping IPv4 packets due to LBERROR\"\n\n\tRET=0\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_err $?\n\n\tlog_test \"fwd mark: forwarding IPv4 packets in software\"\n\n\tRET=0\n\n\ttc_check_packets \"dev $swp2 egress\" 102 10\n\tcheck_err $?\n\n\tlog_test \"fwd mark: forwarding IPv4 packets in hardware\"\n\n\ttc filter del dev $swp2 egress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $swp2 egress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n}\n\nfwd_mark_ipv6()\n{\n\ttc filter add dev $swp1 ingress protocol ipv6 pref 1 handle 101 flower \\\n\t\tskip_hw dst_ip 2001:db8:2::1 ip_proto udp dst_port 52768 \\\n\t\taction pass\n\n\ttc filter add dev $swp2 egress protocol ipv6 pref 1 handle 101 flower \\\n\t\tskip_hw dst_ip 2001:db8:2::1 ip_proto udp dst_port 52768 \\\n\t\taction pass\n\n\ttc filter add dev $swp2 egress protocol ipv6 pref 2 handle 102 flower \\\n\t\tskip_sw dst_ip 2001:db8:2::1 ip_proto udp dst_port 52768 \\\n\t\taction pass\n\n\tip vrf exec v$h1 $MZ $h1 -6 -c 10 -d 100msec -p 64 -A 2001:db8:1::1 \\\n\t\t-B 2001:db8:2::1 -t udp dp=52768,sp=42768 -q\n\n\tRET=0\n\n\ttc_check_packets \"dev $swp1 ingress\" 101 10\n\tcheck_err $?\n\n\tlog_test \"fwd mark: trapping IPv6 packets due to LBERROR\"\n\n\tRET=0\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_err $?\n\n\tlog_test \"fwd mark: forwarding IPv6 packets in software\"\n\n\tRET=0\n\n\ttc_check_packets \"dev $swp2 egress\" 102 10\n\tcheck_err $?\n\n\tlog_test \"fwd mark: forwarding IPv6 packets in hardware\"\n\n\ttc filter del dev $swp2 egress protocol ipv6 pref 2 handle 102 flower\n\ttc filter del dev $swp2 egress protocol ipv6 pref 1 handle 101 flower\n\ttc filter del dev $swp1 ingress protocol ipv6 pref 1 handle 101 flower\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\tsysctl_set net.ipv4.conf.all.accept_redirects 0\n\tsysctl_set net.ipv6.conf.all.accept_redirects 0\n\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tsysctl_restore net.ipv6.conf.all.accept_redirects\n\tsysctl_restore net.ipv4.conf.all.accept_redirects\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}