{
  "module_name": "router_scale.sh",
  "hash_id": "13cd513b37dbf8e5aed69db85b00d160a2540fce769d4b9640103ad19fbcb309",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/router_scale.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nROUTER_NUM_NETIFS=4\n: ${TIMEOUT:=20000} # ms\n\nrouter_h1_create()\n{\n\tsimple_if_init $h1 192.0.1.1/24\n}\n\nrouter_h1_destroy()\n{\n\tsimple_if_fini $h1 192.0.1.1/24\n}\n\nrouter_h2_create()\n{\n\tsimple_if_init $h2 192.0.2.1/24\n\ttc qdisc add dev $h2 handle ffff: ingress\n}\n\nrouter_h2_destroy()\n{\n\ttc qdisc del dev $h2 handle ffff: ingress\n\tsimple_if_fini $h2 192.0.2.1/24\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\n\tip address add 192.0.1.2/24 dev $rp1\n\tip address add 192.0.2.2/24 dev $rp2\n}\n\nrouter_destroy()\n{\n\tip address del 192.0.2.2/24 dev $rp2\n\tip address del 192.0.1.2/24 dev $rp1\n\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nrouter_setup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th1mac=$(mac_get $h1)\n\trp1mac=$(mac_get $rp1)\n\n\tvrf_prepare\n\n\trouter_h1_create\n\trouter_h2_create\n\n\trouter_create\n}\n\nwait_for_routes()\n{\n\tlocal t0=$1; shift\n\tlocal route_count=$1; shift\n\n\tlocal t1=$(ip route | grep 'offload' | grep -v 'offload_failed' | wc -l)\n\tlocal delta=$((t1 - t0))\n\techo $delta\n\t[[ $delta -ge $route_count ]]\n}\n\nrouter_routes_create()\n{\n\tlocal route_count=$1\n\tlocal count=0\n\n\tROUTE_FILE=\"$(mktemp)\"\n\n\tfor i in {0..255}\n\tdo\n\t\tfor j in {0..255}\n\t\tdo\n\t\t\tfor k in {0..255}\n\t\t\tdo\n\t\t\t\tif [[ $count -eq $route_count ]]; then\n\t\t\t\t\tbreak 3\n\t\t\t\tfi\n\n\t\t\t\techo route add 193.${i}.${j}.${k}/32 dev $rp2 \\\n\t\t\t\t\t>> $ROUTE_FILE\n\t\t\t\t((count++))\n\t\t\tdone\n\t\tdone\n\tdone\n\n\tip -b $ROUTE_FILE &> /dev/null\n}\n\nrouter_routes_destroy()\n{\n\tif [[ -v ROUTE_FILE ]]; then\n\t\trm -f $ROUTE_FILE\n\tfi\n}\n\nrouter_test()\n{\n\tlocal route_count=$1\n\tlocal should_fail=$2\n\tlocal delta\n\n\tRET=0\n\n\tlocal t0=$(ip route | grep -o 'offload' | wc -l)\n\trouter_routes_create $route_count\n\tdelta=$(busywait \"$TIMEOUT\" wait_for_routes $t0 $route_count)\n\n\tcheck_err_fail $should_fail $? \"Offload routes: Expected $route_count, got $delta.\"\n\tif [[ $RET -ne 0 ]] || [[ $should_fail -eq 1 ]]; then\n\t\treturn\n\tfi\n\n\trouter_routes_destroy\n}\n\nrouter_cleanup()\n{\n\tpre_cleanup\n\n\trouter_routes_destroy\n\trouter_destroy\n\n\trouter_h2_destroy\n\trouter_h1_destroy\n\n\tvrf_cleanup\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}