{
  "module_name": "sharedbuffer.sh",
  "hash_id": "69ff7951f5c59450dc82843264332304c573a206a95879955b8e0279c10e1abb",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/sharedbuffer.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"\n\tport_pool_test\n\tport_tc_ip_test\n\tport_tc_arp_test\n\"\n\nNUM_NETIFS=2\nsource ../../../net/forwarding/lib.sh\nsource ../../../net/forwarding/devlink_lib.sh\nsource mlxsw_lib.sh\n\nSB_POOL_ING=0\nSB_POOL_EGR_CPU=10\n\nSB_ITC_CPU_IP=2\nSB_ITC_CPU_ARP=2\nSB_ITC=0\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.1.1/24\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.1.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.1.2/24\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.1.2/24\n}\n\nsb_occ_pool_check()\n{\n\tlocal dl_port=$1; shift\n\tlocal pool=$1; shift\n\tlocal exp_max_occ=$1\n\tlocal max_occ\n\tlocal err=0\n\n\tmax_occ=$(devlink sb -j occupancy show $dl_port \\\n\t\t  | jq -e \".[][][\\\"pool\\\"][\\\"$pool\\\"][\\\"max\\\"]\")\n\n\tif [[ \"$max_occ\" -ne \"$exp_max_occ\" ]]; then\n\t\terr=1\n\tfi\n\n\techo $max_occ\n\treturn $err\n}\n\nsb_occ_itc_check()\n{\n\tlocal dl_port=$1; shift\n\tlocal itc=$1; shift\n\tlocal exp_max_occ=$1\n\tlocal max_occ\n\tlocal err=0\n\n\tmax_occ=$(devlink sb -j occupancy show $dl_port \\\n\t\t  | jq -e \".[][][\\\"itc\\\"][\\\"$itc\\\"][\\\"max\\\"]\")\n\n\tif [[ \"$max_occ\" -ne \"$exp_max_occ\" ]]; then\n\t\terr=1\n\tfi\n\n\techo $max_occ\n\treturn $err\n}\n\nsb_occ_etc_check()\n{\n\tlocal dl_port=$1; shift\n\tlocal etc=$1; shift\n\tlocal exp_max_occ=$1; shift\n\tlocal max_occ\n\tlocal err=0\n\n\tmax_occ=$(devlink sb -j occupancy show $dl_port \\\n\t\t  | jq -e \".[][][\\\"etc\\\"][\\\"$etc\\\"][\\\"max\\\"]\")\n\n\tif [[ \"$max_occ\" -ne \"$exp_max_occ\" ]]; then\n\t\terr=1\n\tfi\n\n\techo $max_occ\n\treturn $err\n}\n\nport_pool_test()\n{\n\tlocal exp_max_occ=$(devlink_cell_size_get)\n\tlocal max_occ\n\n\tdevlink sb occupancy clearmax $DEVLINK_DEV\n\n\t$MZ $h1 -c 1 -p 10 -a $h1mac -b $h2mac -A 192.0.1.1 -B 192.0.1.2 \\\n\t\t-t ip -q\n\n\tdevlink sb occupancy snapshot $DEVLINK_DEV\n\n\tRET=0\n\tmax_occ=$(sb_occ_pool_check $dl_port1 $SB_POOL_ING $exp_max_occ)\n\tcheck_err $? \"Expected iPool($SB_POOL_ING) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"physical port's($h1) ingress pool\"\n\n\tRET=0\n\tmax_occ=$(sb_occ_pool_check $dl_port2 $SB_POOL_ING $exp_max_occ)\n\tcheck_err $? \"Expected iPool($SB_POOL_ING) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"physical port's($h2) ingress pool\"\n\n\tRET=0\n\tmax_occ=$(sb_occ_pool_check $cpu_dl_port $SB_POOL_EGR_CPU $exp_max_occ)\n\tcheck_err $? \"Expected ePool($SB_POOL_EGR_CPU) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"CPU port's egress pool\"\n}\n\nport_tc_ip_test()\n{\n\tlocal exp_max_occ=$(devlink_cell_size_get)\n\tlocal max_occ\n\n\tdevlink sb occupancy clearmax $DEVLINK_DEV\n\n\t$MZ $h1 -c 1 -p 10 -a $h1mac -b $h2mac -A 192.0.1.1 -B 192.0.1.2 \\\n\t\t-t ip -q\n\n\tdevlink sb occupancy snapshot $DEVLINK_DEV\n\n\tRET=0\n\tmax_occ=$(sb_occ_itc_check $dl_port2 $SB_ITC $exp_max_occ)\n\tcheck_err $? \"Expected ingress TC($SB_ITC) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"physical port's($h1) ingress TC - IP packet\"\n\n\tRET=0\n\tmax_occ=$(sb_occ_itc_check $dl_port2 $SB_ITC $exp_max_occ)\n\tcheck_err $? \"Expected ingress TC($SB_ITC) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"physical port's($h2) ingress TC - IP packet\"\n\n\tRET=0\n\tmax_occ=$(sb_occ_etc_check $cpu_dl_port $SB_ITC_CPU_IP $exp_max_occ)\n\tcheck_err $? \"Expected egress TC($SB_ITC_CPU_IP) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"CPU port's egress TC - IP packet\"\n}\n\nport_tc_arp_test()\n{\n\tlocal exp_max_occ=$(devlink_cell_size_get)\n\tlocal max_occ\n\n\tdevlink sb occupancy clearmax $DEVLINK_DEV\n\n\t$MZ $h1 -c 1 -p 10 -a $h1mac -A 192.0.1.1 -t arp -q\n\n\tdevlink sb occupancy snapshot $DEVLINK_DEV\n\n\tRET=0\n\tmax_occ=$(sb_occ_itc_check $dl_port2 $SB_ITC $exp_max_occ)\n\tcheck_err $? \"Expected ingress TC($SB_ITC) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"physical port's($h1) ingress TC - ARP packet\"\n\n\tRET=0\n\tmax_occ=$(sb_occ_itc_check $dl_port2 $SB_ITC $exp_max_occ)\n\tcheck_err $? \"Expected ingress TC($SB_ITC) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"physical port's($h2) ingress TC - ARP packet\"\n\n\tRET=0\n\tmax_occ=$(sb_occ_etc_check $cpu_dl_port $SB_ITC_CPU_ARP $exp_max_occ)\n\tcheck_err $? \"Expected egress TC($SB_ITC_IP2ME) max occupancy to be $exp_max_occ, but got $max_occ\"\n\tlog_test \"CPU port's egress TC - ARP packet\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\n\th1mac=$(mac_get $h1)\n\th2mac=$(mac_get $h2)\n\n\tdl_port1=$(devlink_port_by_netdev $h1)\n\tdl_port2=$(devlink_port_by_netdev $h2)\n\n\tcpu_dl_port=$(devlink_cpu_port_get)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}