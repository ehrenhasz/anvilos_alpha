{
  "module_name": "q_in_q_veto.sh",
  "hash_id": "2d9969d80b24122be7b4d980b38270e90f2f273e3750270338da839afea61e29",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/q_in_q_veto.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tcreate_8021ad_vlan_upper_on_top_front_panel_port\n\tcreate_8021ad_vlan_upper_on_top_bridge_port\n\tcreate_8021ad_vlan_upper_on_top_lag\n\tcreate_8021ad_vlan_upper_on_top_bridge\n\tcreate_8021ad_vlan_upper_on_top_8021ad_bridge\n\tcreate_vlan_upper_on_top_8021ad_bridge\n\tcreate_vlan_upper_on_top_front_panel_enslaved_to_8021ad_bridge\n\tcreate_vlan_upper_on_top_lag_enslaved_to_8021ad_bridge\n\tenslave_front_panel_with_vlan_upper_to_8021ad_bridge\n\tenslave_lag_with_vlan_upper_to_8021ad_bridge\n\tadd_ip_address_to_8021ad_bridge\n\tswitch_bridge_protocol_from_8021q_to_8021ad\n\"\nNUM_NETIFS=2\nsource $lib_dir/lib.sh\n\nsetup_prepare()\n{\n\tswp1=${NETIFS[p1]}\n\tswp2=${NETIFS[p2]}\n\n\tip link set dev $swp1 up\n\tip link set dev $swp2 up\n\n\tsleep 10\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n}\n\ncreate_vlan_upper_on_top_of_bridge()\n{\n\tRET=0\n\n\tlocal bridge_proto=$1; shift\n\tlocal netdev_proto=$1; shift\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol $bridge_proto vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\n\tip link set dev br0 up\n\tip link set dev $swp1 master br0\n\n\tip link add name br0.100 link br0 type vlan \\\n\t\tprotocol $netdev_proto id 100 2>/dev/null\n\tcheck_fail $? \"$netdev_proto vlan upper creation on top of an $bridge_proto bridge not rejected\"\n\n\tip link add name br0.100 link br0 type vlan \\\n\t\tprotocol $netdev_proto id 100 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"$netdev_proto vlan upper creation on top of an $bridge_proto bridge rejected without extack\"\n\n\tlog_test \"create $netdev_proto vlan upper on top $bridge_proto bridge\"\n\n\tip link del dev br0\n}\n\ncreate_8021ad_vlan_upper_on_top_front_panel_port()\n{\n\tRET=0\n\n\tip link add name $swp1.100 link $swp1 type vlan \\\n\t\tprotocol 802.1ad id 100 2>/dev/null\n\tcheck_fail $? \"802.1ad vlan upper creation on top of a front panel not rejected\"\n\n\tip link add name $swp1.100 link $swp1 type vlan \\\n\t\tprotocol 802.1ad id 100 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"802.1ad vlan upper creation on top of a front panel rejected without extack\"\n\n\tlog_test \"create 802.1ad vlan upper on top of a front panel\"\n}\n\ncreate_8021ad_vlan_upper_on_top_bridge_port()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\n\tip link set dev $swp1 master br0\n\tip link set dev br0 up\n\n\tip link add name $swp1.100 link $swp1 type vlan \\\n\t\tprotocol 802.1ad id 100 2>/dev/null\n\tcheck_fail $? \"802.1ad vlan upper creation on top of a bridge port not rejected\"\n\n\tip link add name $swp1.100 link $swp1 type vlan \\\n\t\tprotocol 802.1ad id 100 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"802.1ad vlan upper creation on top of a bridge port rejected without extack\"\n\n\tlog_test \"create 802.1ad vlan upper on top of a bridge port\"\n\n\tip link del dev br0\n}\n\ncreate_8021ad_vlan_upper_on_top_lag()\n{\n\tRET=0\n\n\tip link add name bond1 type bond mode 802.3ad\n\tip link set dev $swp1 down\n\tip link set dev $swp1 master bond1\n\n\tip link add name bond1.100 link bond1 type vlan \\\n\t\tprotocol 802.1ad id 100 2>/dev/null\n\tcheck_fail $? \"802.1ad vlan upper creation on top of a lag not rejected\"\n\n\tip link add name bond1.100 link bond1 type vlan \\\n\t\tprotocol 802.1ad id 100 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"802.1ad vlan upper creation on top of a lag rejected without extack\"\n\n\tlog_test \"create 802.1ad vlan upper on top of a lag\"\n\n\tip link del dev bond1\n}\n\ncreate_8021ad_vlan_upper_on_top_bridge()\n{\n\tRET=0\n\n\tcreate_vlan_upper_on_top_of_bridge \"802.1q\" \"802.1ad\"\n}\n\ncreate_8021ad_vlan_upper_on_top_8021ad_bridge()\n{\n\tRET=0\n\n\tcreate_vlan_upper_on_top_of_bridge \"802.1ad\" \"802.1ad\"\n}\n\ncreate_vlan_upper_on_top_8021ad_bridge()\n{\n\tRET=0\n\n\tcreate_vlan_upper_on_top_of_bridge \"802.1ad\" \"802.1q\"\n}\n\ncreate_vlan_upper_on_top_front_panel_enslaved_to_8021ad_bridge()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\n\tip link set dev $swp1 master br0\n\n\tip link add name $swp1.100 link $swp1 type vlan id 100 2>/dev/null\n\tcheck_fail $? \"vlan upper creation on top of front panel enslaved to 802.1ad bridge not rejected\"\n\n\tip link add name $swp1.100 link $swp1 type vlan id 100 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"vlan upper creation on top of front panel enslaved to 802.1ad bridge rejected without extack\"\n\n\tlog_test \"create vlan upper on top of front panel enslaved to 802.1ad bridge\"\n\n\tip link del dev br0\n}\n\ncreate_vlan_upper_on_top_lag_enslaved_to_8021ad_bridge()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\n\tip link add name bond1 type bond mode 802.3ad\n\tip link set dev $swp1 down\n\tip link set dev $swp1 master bond1\n\tip link set dev bond1 master br0\n\n\tip link add name bond1.100 link bond1 type vlan id 100 2>/dev/null\n\tcheck_fail $? \"vlan upper creation on top of lag enslaved to 802.1ad bridge not rejected\"\n\n\tip link add name bond1.100 link bond1 type vlan id 100 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"vlan upper creation on top of lag enslaved to 802.1ad bridge rejected without extack\"\n\n\tlog_test \"create vlan upper on top of lag enslaved to 802.1ad bridge\"\n\n\tip link del dev bond1\n\tip link del dev br0\n}\n\nenslave_front_panel_with_vlan_upper_to_8021ad_bridge()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\n\tip link add name $swp1.100 link $swp1 type vlan id 100\n\n\tip link set dev $swp1 master br0 2>/dev/null\n\tcheck_fail $? \"front panel with vlan upper enslavemnt to 802.1ad bridge not rejected\"\n\n\tip link set dev $swp1 master br0 2>&1 >/dev/null | grep -q mlxsw_spectrum\n\tcheck_err $? \"front panel with vlan upper enslavemnt to 802.1ad bridge rejected without extack\"\n\n\tlog_test \"enslave front panel with vlan upper to 802.1ad bridge\"\n\n\tip link del dev $swp1.100\n\tip link del dev br0\n}\n\nenslave_lag_with_vlan_upper_to_8021ad_bridge()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\n\tip link add name bond1 type bond mode 802.3ad\n\tip link set dev $swp1 down\n\tip link set dev $swp1 master bond1\n\tip link add name bond1.100 link bond1 type vlan id 100\n\n\tip link set dev bond1 master br0 2>/dev/null\n\tcheck_fail $? \"lag with vlan upper enslavemnt to 802.1ad bridge not rejected\"\n\n\tip link set dev bond1 master br0 2>&1 >/dev/null \\\n\t\t| grep -q mlxsw_spectrum\n\tcheck_err $? \"lag with vlan upper enslavemnt to 802.1ad bridge rejected without extack\"\n\n\tlog_test \"enslave lag with vlan upper to 802.1ad bridge\"\n\n\tip link del dev bond1\n\tip link del dev br0\n}\n\n\nadd_ip_address_to_8021ad_bridge()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\n\tip link set dev br0 up\n\tip link set dev $swp1 master br0\n\n\tip addr add dev br0 192.0.2.17/28 2>/dev/null\n\tcheck_fail $? \"IP address addition to 802.1ad bridge not rejected\"\n\n\tip addr add dev br0 192.0.2.17/28 2>&1 >/dev/null | grep -q mlxsw_spectrum\n\tcheck_err $? \"IP address addition to 802.1ad bridge rejected without extack\"\n\n\tlog_test \"IP address addition to 802.1ad bridge\"\n\n\tip link del dev br0\n}\n\nswitch_bridge_protocol_from_8021q_to_8021ad()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\n\tip link set dev br0 up\n\tip link set dev $swp1 master br0\n\n\tip link set dev br0 type bridge vlan_protocol 802.1q 2>/dev/null\n\tcheck_fail $? \"switching bridge protocol from 802.1q to 802.1ad not rejected\"\n\n\tlog_test \"switch bridge protocol\"\n\n\tip link del dev br0\n}\n\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}