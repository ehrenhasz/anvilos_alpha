{
  "module_name": "tc_police_scale.sh",
  "hash_id": "e8b725b35a67b3c158d4f1171f470243f7f540a85b5bcd8449810224a806c2a6",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/tc_police_scale.sh",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n\nTC_POLICE_NUM_NETIFS=2\n\ntc_police_h1_create()\n{\n\tsimple_if_init $h1\n}\n\ntc_police_h1_destroy()\n{\n\tsimple_if_fini $h1\n}\n\ntc_police_switch_create()\n{\n\tsimple_if_init $swp1\n\ttc qdisc add dev $swp1 clsact\n}\n\ntc_police_switch_destroy()\n{\n\ttc qdisc del dev $swp1 clsact\n\tsimple_if_fini $swp1\n}\n\ntc_police_addr()\n{\n       local num=$1; shift\n\n       printf \"2001:db8:1::%x\" $num\n}\n\ntc_police_rules_create()\n{\n\tlocal count=$1; shift\n\tlocal should_fail=$1; shift\n\n\tTC_POLICE_BATCH_FILE=\"$(mktemp)\"\n\n\tfor ((i = 0; i < count; ++i)); do\n\t\tcat >> $TC_POLICE_BATCH_FILE <<-EOF\n\t\t\tfilter add dev $swp1 ingress \\\n\t\t\t\tprot ipv6 \\\n\t\t\t\tpref 1000 \\\n\t\t\t\tflower skip_sw dst_ip $(tc_police_addr $i) \\\n\t\t\t\taction police rate 10mbit burst 100k \\\n\t\t\t\tconform-exceed drop/ok\n\t\tEOF\n\tdone\n\n\ttc -b $TC_POLICE_BATCH_FILE\n\tcheck_err_fail $should_fail $? \"Rule insertion\"\n}\n\n__tc_police_test()\n{\n\tlocal count=$1; shift\n\tlocal should_fail=$1; shift\n\n\ttc_police_rules_create $count $should_fail\n\n\toffload_count=$(tc -j filter show dev $swp1 ingress |\n\t\t\tjq \"[.[] | select(.options.in_hw == true)] | length\")\n\t((offload_count == count))\n\tcheck_err_fail $should_fail $? \"tc police offload count\"\n}\n\ntc_police_test()\n{\n\tlocal count=$1; shift\n\tlocal should_fail=$1; shift\n\n\tif ! tc_offload_check $TC_POLICE_NUM_NETIFS; then\n\t\tcheck_err 1 \"Could not test offloaded functionality\"\n\t\treturn\n\tfi\n\n\t__tc_police_test $count $should_fail\n}\n\ntc_police_setup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tvrf_prepare\n\n\ttc_police_h1_create\n\ttc_police_switch_create\n}\n\ntc_police_cleanup()\n{\n\tpre_cleanup\n\n\ttc_police_switch_destroy\n\ttc_police_h1_destroy\n\n\tvrf_cleanup\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}