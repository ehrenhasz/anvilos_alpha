{
  "module_name": "rif_mac_profiles.sh",
  "hash_id": "1a9b4a39730d7d5221ca015cc49d257a9452aa082530686383ece72e262ef6ca",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/rif_mac_profiles.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tmac_profile_test\n\"\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\nsource $lib_dir/tc_common.sh\nsource $lib_dir/devlink_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n\tip route add 198.51.100.0/24 vrf v$h1 nexthop via 192.0.2.2\n\n\ttc qdisc add dev $h1 ingress\n}\n\nh1_destroy()\n{\n\ttc qdisc del dev $h1 ingress\n\n\tip route del 198.51.100.0/24 vrf v$h1\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 198.51.100.1/24\n\tip route add 192.0.2.0/24 vrf v$h2 nexthop via 198.51.100.2\n\n\ttc qdisc add dev $h2 ingress\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 ingress\n\n\tip route del 192.0.2.0/24 vrf v$h2\n\tsimple_if_fini $h2 198.51.100.1/24\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\n\ttc qdisc add dev $rp1 clsact\n\ttc qdisc add dev $rp2 clsact\n\tip address add 192.0.2.2/24 dev $rp1\n\tip address add 198.51.100.2/24 dev $rp2\n}\n\nrouter_destroy()\n{\n\tip address del 198.51.100.2/24 dev $rp2\n\tip address del 192.0.2.2/24 dev $rp1\n\ttc qdisc del dev $rp2 clsact\n\ttc qdisc del dev $rp1 clsact\n\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nh1_to_h2()\n{\n\tlocal test_name=$@; shift\n\tlocal smac=$(mac_get $rp2)\n\n\tRET=0\n\n\t# Replace neighbour to avoid first packet being forwarded in software\n\tip neigh replace dev $rp2 198.51.100.1 lladdr $(mac_get $h2)\n\n\t# Add a filter to ensure that packets are forwarded in hardware. Cannot\n\t# match on source MAC because it is not set in eACL after routing\n\ttc filter add dev $rp2 egress proto ip pref 1 handle 101 \\\n\t\tflower skip_sw ip_proto udp src_port 12345 dst_port 54321 \\\n\t\taction pass\n\n\t# Add a filter to ensure that packets are received with the correct\n\t# source MAC\n\ttc filter add dev $h2 ingress proto ip pref 1 handle 101 \\\n\t\tflower skip_sw src_mac $smac ip_proto udp src_port 12345 \\\n\t\tdst_port 54321 action pass\n\n\t$MZ $h1 -a own -b $(mac_get $rp1) -t udp \"sp=12345,dp=54321\" \\\n\t\t-A 192.0.2.1 -B 198.51.100.1 -c 10 -p 100 -d 1msec -q\n\n\ttc_check_packets \"dev $rp2 egress\" 101 10\n\tcheck_err $? \"packets not forwarded in hardware\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 10\n\tcheck_err $? \"packets not forwarded with correct source mac\"\n\n\tlog_test \"h1->h2: $test_name\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n\tip neigh del dev $rp2 198.51.100.1 lladdr $(mac_get $h2)\n}\n\nh2_to_h1()\n{\n\tlocal test_name=$@; shift\n\tlocal rp1_mac=$(mac_get $rp1)\n\n\tRET=0\n\n\tip neigh replace dev $rp1 192.0.2.1 lladdr $(mac_get $h1)\n\n\ttc filter add dev $rp1 egress proto ip pref 1 handle 101 \\\n\t\tflower skip_sw ip_proto udp src_port 54321 dst_port 12345 \\\n\t\taction pass\n\n\ttc filter add dev $h1 ingress proto ip pref 1 handle 101 \\\n\t\tflower skip_sw src_mac $rp1_mac ip_proto udp src_port 54321 \\\n\t\tdst_port 12345 action pass\n\n\t$MZ $h2 -a own -b $(mac_get $rp2) -t udp \"sp=54321,dp=12345\" \\\n\t\t-A 198.51.100.1 -B 192.0.2.1 -c 10 -p 100 -d 1msec -q\n\n\ttc_check_packets \"dev $rp1 egress\" 101 10\n\tcheck_err $? \"packets not forwarded in hardware\"\n\n\ttc_check_packets \"dev $h1 ingress\" 101 10\n\tcheck_err $? \"packets not forwarded with correct source mac\"\n\n\tlog_test \"h2->h1: $test_name\"\n\n\ttc filter del dev $h1 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $rp1 egress protocol ip pref 1 handle 101 flower\n\tip neigh del dev $rp1 192.0.2.1 lladdr $(mac_get $h1)\n}\n\nsmac_test()\n{\n\tlocal test_name=$@; shift\n\n\t# Test that packets forwarded to $h2 via $rp2 are forwarded with the\n\t# current source MAC of $rp2\n\th1_to_h2 $test_name\n\n\t# Test that packets forwarded to $h1 via $rp1 are forwarded with the\n\t# current source MAC of $rp1. This MAC is never changed during the test,\n\t# but given the shared nature of MAC profile, the point is to see that\n\t# changes to the MAC of $rp2 do not affect that of $rp1\n\th2_to_h1 $test_name\n}\n\nmac_profile_test()\n{\n\tlocal rp2_mac=$(mac_get $rp2)\n\n\t# Test behavior when the RIF backing $rp2 is transitioned to use\n\t# a new MAC profile\n\tip link set dev $rp2 addr 00:11:22:33:44:55\n\tsmac_test \"new mac profile\"\n\n\t# Test behavior when the MAC profile used by the RIF is edited\n\tip link set dev $rp2 address 00:22:22:22:22:22\n\tsmac_test \"edit mac profile\"\n\n\t# Restore original MAC\n\tip link set dev $rp2 addr $rp2_mac\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\nmac_profiles=$(devlink_resource_size_get rif_mac_profiles)\nif [[ $mac_profiles -ne 1 ]]; then\n\ttests_run\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}