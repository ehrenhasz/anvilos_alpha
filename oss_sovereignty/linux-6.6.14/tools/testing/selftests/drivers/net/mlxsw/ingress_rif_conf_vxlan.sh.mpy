{
  "module_name": "ingress_rif_conf_vxlan.sh",
  "hash_id": "0d3f2bead6d2a9291cf4a1d35a3676ccff2bfff2816edeb03163054656777bea",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/ingress_rif_conf_vxlan.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test routing after VXLAN decapsulation and verify that the order of\n# configuration does not impact switch behavior. Verify that RIF is added\n# correctly for existing mapping and that new mapping uses the correct RIF.\n\n# +---------------------------+\n# |                        H1 |\n# |    + $h1                  |\n# |    | 192.0.2.1/28         |\n# +----|----------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# | +--|--------------------------------------------------------------------+ |\n# | |  + $swp1                         br1                                  | |\n# | |     vid 10 pvid untagged                                              | |\n# | |                                                                       | |\n# | |                                                                       | |\n# | |                                            + vx4001                   | |\n# | |                                              local 192.0.2.17         | |\n# | |                                              remote 192.0.2.18        | |\n# | |                                              id 104001                | |\n# | |                                              dstport $VXPORT          | |\n# | |                                              vid 4001 pvid untagged   | |\n# | |                                                                       | |\n# | +----------------------------------+------------------------------------+ |\n# |                                    |                                      |\n# | +----------------------------------|------------------------------------+ |\n# | |                                  |                                    | |\n# | |  +-------------------------------+---------------------------------+  | |\n# | |  |                                                                 |  | |\n# | |  + vlan10                                                 vlan4001 +  | |\n# | |    192.0.2.2/28                                                       | |\n# | |                                                                       | |\n# | |                               vrf-green                               | |\n# | +-----------------------------------------------------------------------+ |\n# |                                                                           |\n# |    + $rp1                                       +lo                       |\n# |    | 198.51.100.1/24                             192.0.2.17/32            |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                                             v$rp2      |\n# |    + $rp2                                                   |\n# |      198.51.100.2/24                                        |\n# |                                                             |\n# +-------------------------------------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tvni_fid_map_rif\n\trif_vni_fid_map\n\"\n\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\nsource $lib_dir/tc_common.sh\nsource $lib_dir/devlink_lib.sh\n\n: ${VXPORT:=4789}\nexport VXPORT\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 0\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\tip link set dev $rp1 up\n\tip address add dev $rp1 198.51.100.1/24\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tbridge vlan add vid 10 dev $swp1 pvid untagged\n\n\ttc qdisc add dev $swp1 clsact\n\n\tip link add name vx4001 type vxlan id 104001 \\\n\t\tlocal 192.0.2.17 dstport $VXPORT \\\n\t\tnolearning noudpcsum tos inherit ttl 100\n\tip link set dev vx4001 up\n\n\tip link set dev vx4001 master br1\n\n\tip address add 192.0.2.17/32 dev lo\n\n\t# Create SVIs.\n\tvrf_create \"vrf-green\"\n\tip link set dev vrf-green up\n\n\tip link add link br1 name vlan10 up master vrf-green type vlan id 10\n\n\t# Replace neighbor to avoid 1 packet which is forwarded in software due\n\t# to \"unresolved neigh\".\n\tip neigh replace dev vlan10 192.0.2.1 lladdr $(mac_get $h1)\n\n\tip address add 192.0.2.2/28 dev vlan10\n\n\tbridge vlan add vid 10 dev br1 self\n\tbridge vlan add vid 4001 dev br1 self\n\n\tsysctl_set net.ipv4.conf.all.rp_filter 0\n}\n\nswitch_destroy()\n{\n\tsysctl_restore net.ipv4.conf.all.rp_filter\n\n\tbridge vlan del vid 4001 dev br1 self\n\tbridge vlan del vid 10 dev br1 self\n\n\tip link del dev vlan10\n\n\tvrf_destroy \"vrf-green\"\n\n\tip address del 192.0.2.17/32 dev lo\n\n\ttc qdisc del dev $swp1 clsact\n\n\tbridge vlan del vid 10 dev $swp1\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link set dev vx4001 nomaster\n\n\tip link set dev vx4001 down\n\tip link del dev vx4001\n\n\tip address del dev $rp1 198.51.100.1/24\n\tip link set dev $rp1 down\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nvrp2_create()\n{\n\tsimple_if_init $rp2 198.51.100.2/24\n\n\tip route add 192.0.2.17/32 vrf v$rp2 nexthop via 198.51.100.1\n}\n\nvrp2_destroy()\n{\n\tip route del 192.0.2.17/32 vrf v$rp2 nexthop via 198.51.100.1\n\n\tsimple_if_fini $rp2 198.51.100.2/24\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\trp1=${NETIFS[p3]}\n\trp2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\tswitch_create\n\n\tvrp2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tvrp2_destroy\n\n\tswitch_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\npayload_get()\n{\n\tlocal dest_mac=$(mac_get vlan4001)\n\tlocal src_mac=$(mac_get $rp1)\n\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"01:96:41:\"$(                : VXLAN VNI : 104001\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"$src_mac:\"$(                : ETH saddr\n\t\t)\"08:00:\"$(                   : ETH type\n\t\t)\"45:\"$(                      : IP version + IHL\n\t\t)\"00:\"$(                      : IP TOS\n\t\t)\"00:54:\"$(                   : IP total length\n\t\t)\"3f:49:\"$(                   : IP identification\n\t\t)\"00:00:\"$(                   : IP flags + frag off\n\t\t)\"3f:\"$(                      : IP TTL\n\t\t)\"01:\"$(                      : IP proto\n\t\t)\"50:21:\"$(                   : IP header csum\n\t\t)\"c6:33:64:0a:\"$(             : IP saddr: 198.51.100.10\n\t\t)\"c0:00:02:01:\"$(             : IP daddr: 192.0.2.1\n\t)\n\techo $p\n}\n\nvlan_rif_add()\n{\n\trifs_occ_t0=$(devlink_resource_occ_get rifs)\n\n\tip link add link br1 name vlan4001 up master vrf-green \\\n\t\ttype vlan id 4001\n\n\trifs_occ_t1=$(devlink_resource_occ_get rifs)\n\texpected_rifs=$((rifs_occ_t0 + 1))\n\n\t[[ $expected_rifs -eq $rifs_occ_t1 ]]\n\tcheck_err $? \"Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n}\n\nvlan_rif_del()\n{\n\tip link del dev vlan4001\n}\n\nvni_fid_map_rif()\n{\n\tlocal rp1_mac=$(mac_get $rp1)\n\n\tRET=0\n\n\t# First add VNI->FID mapping to the FID of VLAN 4001\n\tbridge vlan add vid 4001 dev vx4001 pvid untagged\n\n\t# Add a RIF to the FID with VNI->FID mapping\n\tvlan_rif_add\n\n\ttc filter add dev $swp1 egress protocol ip pref 1 handle 101 \\\n\t\tflower skip_sw dst_ip 192.0.2.1 action pass\n\n\tpayload=$(payload_get)\n\tip vrf exec v$rp2 $MZ $rp2 -c 10 -d 1msec -b $rp1_mac \\\n\t\t-B 192.0.2.17 -A 192.0.2.18 \\\n\t\t-t udp sp=12345,dp=$VXPORT,p=$payload -q\n\n\ttc_check_at_least_x_packets \"dev $swp1 egress\" 101 10\n\tcheck_err $? \"Packets were not routed in hardware\"\n\n\tlog_test \"Add RIF for existing VNI->FID mapping\"\n\n\ttc filter del dev $swp1 egress\n\n\tbridge vlan del vid 4001 dev vx4001 pvid untagged\n\tvlan_rif_del\n}\n\nrif_vni_fid_map()\n{\n\tlocal rp1_mac=$(mac_get $rp1)\n\n\tRET=0\n\n\t# First add a RIF to the FID of VLAN 4001\n\tvlan_rif_add\n\n\t# Add VNI->FID mapping to FID with a RIF\n\tbridge vlan add vid 4001 dev vx4001 pvid untagged\n\n\ttc filter add dev $swp1 egress protocol ip pref 1 handle 101 \\\n\t\tflower skip_sw dst_ip 192.0.2.1 action pass\n\n\tpayload=$(payload_get)\n\tip vrf exec v$rp2 $MZ $rp2 -c 10 -d 1msec -b $rp1_mac \\\n\t\t-B 192.0.2.17 -A 192.0.2.18 \\\n\t\t-t udp sp=12345,dp=$VXPORT,p=$payload -q\n\n\ttc_check_at_least_x_packets \"dev $swp1 egress\" 101 10\n\tcheck_err $? \"Packets were not routed in hardware\"\n\n\tlog_test \"Add VNI->FID mapping for FID with a RIF\"\n\n\ttc filter del dev $swp1 egress\n\n\tbridge vlan del vid 4001 dev vx4001 pvid untagged\n\tvlan_rif_del\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}