{
  "module_name": "tc_action_hw_stats.sh",
  "hash_id": "156abfa602ebf5fb6e4d9572c0c07568dbc1173c120e13cd6fe519ed098bb3db",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/tc_action_hw_stats.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tdefault_hw_stats_test\n\timmediate_hw_stats_test\n\tdelayed_hw_stats_test\n\tdisabled_hw_stats_test\n\"\nNUM_NETIFS=2\n\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nswitch_create()\n{\n\tsimple_if_init $swp1 192.0.2.2/24\n\ttc qdisc add dev $swp1 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp1 clsact\n\tsimple_if_fini $swp1 192.0.2.2/24\n}\n\nhw_stats_test()\n{\n\tRET=0\n\n\tlocal name=$1\n\tlocal action_hw_stats=$2\n\tlocal occ_delta=$3\n\tlocal expected_packet_count=$4\n\n\tlocal orig_occ=$(devlink_resource_get \"counters\" \"flow\" | jq '.[\"occ\"]')\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop $action_hw_stats\n\tcheck_err $? \"Failed to add rule with $name hw_stats\"\n\n\tlocal new_occ=$(devlink_resource_get \"counters\" \"flow\" | jq '.[\"occ\"]')\n\tlocal expected_occ=$((orig_occ + occ_delta))\n\t[ \"$new_occ\" == \"$expected_occ\" ]\n\tcheck_err $? \"Expected occupancy of $expected_occ, got $new_occ\"\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $swp1mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $swp1 ingress\" 101 $expected_packet_count\n\tcheck_err $? \"Did not match incoming packet\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n\n\tlog_test \"$name hw_stats\"\n}\n\ndefault_hw_stats_test()\n{\n\thw_stats_test \"default\" \"\" 2 1\n}\n\nimmediate_hw_stats_test()\n{\n\thw_stats_test \"immediate\" \"hw_stats immediate\" 2 1\n}\n\ndelayed_hw_stats_test()\n{\n\tRET=0\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop hw_stats delayed\n\tcheck_fail $? \"Unexpected success in adding rule with delayed hw_stats\"\n\n\tlog_test \"delayed hw_stats\"\n}\n\ndisabled_hw_stats_test()\n{\n\thw_stats_test \"disabled\" \"hw_stats disabled\" 0 0\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\th1mac=$(mac_get $h1)\n\tswp1mac=$(mac_get $swp1)\n\n\tvrf_prepare\n\n\th1_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ncheck_tc_action_hw_stats_support\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}