{
  "module_name": "qos_dscp_bridge.sh",
  "hash_id": "88fff1ee1d8cc9a5b5644a3d1e9f656730dfbe7a33779fcfea3c2bcefc78f68a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/qos_dscp_bridge.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test for DSCP prioritization and rewrite. Packets ingress $swp1 with a DSCP\n# tag and are prioritized according to the map at $swp1. They egress $swp2 and\n# the DSCP value is updated to match the map at that interface. The updated DSCP\n# tag is verified at $h2.\n#\n# ICMP responses are produced with the same DSCP tag that arrived at $h2. They\n# go through prioritization at $swp2 and DSCP retagging at $swp1. The tag is\n# verified at $h1--it should match the original tag.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |    + $h1             |                             |            $h2 +     |\n# |    | 192.0.2.1/28    |                             |   192.0.2.2/28 |     |\n# +----|-----------------+                             +----------------|-----+\n#      |                                                                |\n# +----|----------------------------------------------------------------|-----+\n# | SW |                                                                |     |\n# |  +-|----------------------------------------------------------------|-+   |\n# |  | + $swp1                       BR                           $swp2 + |   |\n# |  |   dcb dscp-prio 10:0...17:7            dcb dscp-prio 20:0...27:7   |   |\n# |  +--------------------------------------------------------------------+   |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\ttest_dscp\n\"\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28\n\ttc qdisc add dev $h1 clsact\n\tdscp_capture_install $h1 10\n}\n\nh1_destroy()\n{\n\tdscp_capture_uninstall $h1 10\n\ttc qdisc del dev $h1 clsact\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28\n\ttc qdisc add dev $h2 clsact\n\tdscp_capture_install $h2 20\n}\n\nh2_destroy()\n{\n\tdscp_capture_uninstall $h2 20\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2 192.0.2.2/28\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\tdcb app add dev $swp1 dscp-prio 10:0 11:1 12:2 13:3 14:4 15:5 16:6 17:7\n\tdcb app add dev $swp2 dscp-prio 20:0 21:1 22:2 23:3 24:4 25:5 26:6 27:7\n}\n\nswitch_destroy()\n{\n\tdcb app del dev $swp2 dscp-prio 20:0 21:1 22:2 23:3 24:4 25:5 26:6 27:7\n\tdcb app del dev $swp1 dscp-prio 10:0 11:1 12:2 13:3 14:4 15:5 16:6 17:7\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2\n}\n\ndscp_ping_test()\n{\n\tlocal vrf_name=$1; shift\n\tlocal sip=$1; shift\n\tlocal dip=$1; shift\n\tlocal prio=$1; shift\n\tlocal dev_10=$1; shift\n\tlocal dev_20=$1; shift\n\tlocal key\n\n\tlocal dscp_10=$(((prio + 10) << 2))\n\tlocal dscp_20=$(((prio + 20) << 2))\n\n\tRET=0\n\n\tlocal -A t0s\n\teval \"t0s=($(dscp_fetch_stats $dev_10 10)\n\t\t   $(dscp_fetch_stats $dev_20 20))\"\n\n\tlocal ping_timeout=$((PING_TIMEOUT * 5))\n\tip vrf exec $vrf_name \\\n\t   ${PING} -Q $dscp_10 ${sip:+-I $sip} $dip \\\n\t\t   -c 10 -i 0.5 -w $ping_timeout &> /dev/null\n\n\tlocal -A t1s\n\teval \"t1s=($(dscp_fetch_stats $dev_10 10)\n\t\t   $(dscp_fetch_stats $dev_20 20))\"\n\n\tfor key in ${!t0s[@]}; do\n\t\tlocal expect\n\t\tif ((key == prio+10 || key == prio+20)); then\n\t\t\texpect=10\n\t\telse\n\t\t\texpect=0\n\t\tfi\n\n\t\tlocal delta=$((t1s[$key] - t0s[$key]))\n\t\t((expect == delta))\n\t\tcheck_err $? \"DSCP $key: Expected to capture $expect packets, got $delta.\"\n\tdone\n\n\tlog_test \"DSCP rewrite: $dscp_10-(prio $prio)-$dscp_20\"\n}\n\ntest_dscp()\n{\n\tlocal prio\n\n\tfor prio in {0..7}; do\n\t\tdscp_ping_test v$h1 192.0.2.1 192.0.2.2 $prio $h1 $h2\n\tdone\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}