{
  "module_name": "devlink_trap_policer.sh",
  "hash_id": "105dea35937b1b99f4be9f20cead9053198a5ad9829b8324f6960120592f40e4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/devlink_trap_policer.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test devlink-trap policer functionality over mlxsw.\n\n# +---------------------------------+\n# | H1 (vrf)                        |\n# |    + $h1                        |\n# |    | 192.0.2.1/24               |\n# |    |                            |\n# |    |  default via 192.0.2.2     |\n# +----|----------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# |    + $rp1                                                                 |\n# |        192.0.2.2/24                                                       |\n# |                                                                           |\n# |        198.51.100.2/24                                                    |\n# |    + $rp2                                                                 |\n# |    |                                                                      |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|----------------------------+\n# |    |  default via 198.51.100.2  |\n# |    |                            |\n# |    | 198.51.100.1/24            |\n# |    + $h2                        |\n# | H2 (vrf)                        |\n# +---------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\trate_limits_test\n\tburst_limits_test\n\trate_test\n\tburst_test\n\"\nNUM_NETIFS=4\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n\tmtu_set $h1 10000\n\n\tip -4 route add default vrf v$h1 nexthop via 192.0.2.2\n}\n\nh1_destroy()\n{\n\tip -4 route del default vrf v$h1 nexthop via 192.0.2.2\n\n\tmtu_restore $h1\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 198.51.100.1/24\n\tmtu_set $h2 10000\n\n\tip -4 route add default vrf v$h2 nexthop via 198.51.100.2\n}\n\nh2_destroy()\n{\n\tip -4 route del default vrf v$h2 nexthop via 198.51.100.2\n\n\tmtu_restore $h2\n\tsimple_if_fini $h2 198.51.100.1/24\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\n\t__addr_add_del $rp1 add 192.0.2.2/24\n\t__addr_add_del $rp2 add 198.51.100.2/24\n\tmtu_set $rp1 10000\n\tmtu_set $rp2 10000\n\n\tip -4 route add blackhole 198.51.100.100\n\n\tdevlink trap set $DEVLINK_DEV trap blackhole_route action trap\n}\n\nrouter_destroy()\n{\n\tdevlink trap set $DEVLINK_DEV trap blackhole_route action drop\n\n\tip -4 route del blackhole 198.51.100.100\n\n\tmtu_restore $rp2\n\tmtu_restore $rp1\n\t__addr_add_del $rp2 del 198.51.100.2/24\n\t__addr_add_del $rp1 del 192.0.2.2/24\n\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp1_mac=$(mac_get $rp1)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\trouter_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n\n\t# Reload to ensure devlink-trap settings are back to default.\n\tdevlink_reload\n}\n\nrate_limits_test()\n{\n\tRET=0\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 0 &> /dev/null\n\tcheck_fail $? \"Policer rate was changed to rate lower than limit\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 \\\n\t\trate 2000000001 &> /dev/null\n\tcheck_fail $? \"Policer rate was changed to rate higher than limit\"\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 1\n\tcheck_err $? \"Failed to set policer rate to minimum\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 rate 2000000000\n\tcheck_err $? \"Failed to set policer rate to maximum\"\n\n\tlog_test \"Trap policer rate limits\"\n}\n\nburst_limits_test()\n{\n\tRET=0\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1 burst 0 &> /dev/null\n\tcheck_fail $? \"Policer burst size was changed to 0\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 burst 17 &> /dev/null\n\tcheck_fail $? \"Policer burst size was changed to burst size that is not power of 2\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 burst 8 &> /dev/null\n\tcheck_fail $? \"Policer burst size was changed to burst size lower than limit\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 \\\n\t\tburst $((2**25)) &> /dev/null\n\tcheck_fail $? \"Policer burst size was changed to burst size higher than limit\"\n\n\tdevlink trap policer set $DEVLINK_DEV policer 1 burst 16\n\tcheck_err $? \"Failed to set policer burst size to minimum\"\n\tdevlink trap policer set $DEVLINK_DEV policer 1 burst $((2**24))\n\tcheck_err $? \"Failed to set policer burst size to maximum\"\n\n\tlog_test \"Trap policer burst size limits\"\n}\n\ntrap_rate_get()\n{\n\tlocal t0 t1\n\n\tt0=$(devlink_trap_rx_packets_get blackhole_route)\n\tsleep 10\n\tt1=$(devlink_trap_rx_packets_get blackhole_route)\n\n\techo $(((t1 - t0) / 10))\n}\n\npolicer_drop_rate_get()\n{\n\tlocal id=$1; shift\n\tlocal t0 t1\n\n\tt0=$(devlink_trap_policer_rx_dropped_get $id)\n\tsleep 10\n\tt1=$(devlink_trap_policer_rx_dropped_get $id)\n\n\techo $(((t1 - t0) / 10))\n}\n\n__rate_test()\n{\n\tlocal rate pct drop_rate\n\tlocal id=$1; shift\n\n\tRET=0\n\n\tdevlink trap policer set $DEVLINK_DEV policer $id rate 1000 burst 512\n\tdevlink trap group set $DEVLINK_DEV group l3_drops policer $id\n\n\t# Send packets at highest possible rate and make sure they are dropped\n\t# by the policer. Make sure measured received rate is about 1000 pps\n\tlog_info \"=== Tx rate: Highest, Policer rate: 1000 pps ===\"\n\n\tstart_traffic $h1 192.0.2.1 198.51.100.100 $rp1_mac\n\n\tsleep 5 # Take measurements when rate is stable\n\n\trate=$(trap_rate_get)\n\tpct=$((100 * (rate - 1000) / 1000))\n\t((-10 <= pct && pct <= 10))\n\tcheck_err $? \"Expected rate 1000 pps, got $rate pps, which is $pct% off. Required accuracy is +-10%\"\n\tlog_info \"Expected rate 1000 pps, measured rate $rate pps\"\n\n\tdrop_rate=$(policer_drop_rate_get $id)\n\t(( drop_rate > 0 ))\n\tcheck_err $? \"Expected non-zero policer drop rate, got 0\"\n\tlog_info \"Measured policer drop rate of $drop_rate pps\"\n\n\tstop_traffic\n\n\t# Send packets at a rate of 1000 pps and make sure they are not dropped\n\t# by the policer\n\tlog_info \"=== Tx rate: 1000 pps, Policer rate: 1000 pps ===\"\n\n\tstart_traffic $h1 192.0.2.1 198.51.100.100 $rp1_mac -d 1msec\n\n\tsleep 5 # Take measurements when rate is stable\n\n\tdrop_rate=$(policer_drop_rate_get $id)\n\t(( drop_rate == 0 ))\n\tcheck_err $? \"Expected zero policer drop rate, got a drop rate of $drop_rate pps\"\n\tlog_info \"Measured policer drop rate of $drop_rate pps\"\n\n\tstop_traffic\n\n\t# Unbind the policer and send packets at highest possible rate. Make\n\t# sure they are not dropped by the policer and that the measured\n\t# received rate is higher than 1000 pps\n\tlog_info \"=== Tx rate: Highest, Policer rate: No policer ===\"\n\n\tdevlink trap group set $DEVLINK_DEV group l3_drops nopolicer\n\n\tstart_traffic $h1 192.0.2.1 198.51.100.100 $rp1_mac\n\n\trate=$(trap_rate_get)\n\t(( rate > 1000 ))\n\tcheck_err $? \"Expected rate higher than 1000 pps, got $rate pps\"\n\tlog_info \"Measured rate $rate pps\"\n\n\tdrop_rate=$(policer_drop_rate_get $id)\n\t(( drop_rate == 0 ))\n\tcheck_err $? \"Expected zero policer drop rate, got a drop rate of $drop_rate pps\"\n\tlog_info \"Measured policer drop rate of $drop_rate pps\"\n\n\tstop_traffic\n\n\tlog_test \"Trap policer rate\"\n}\n\nrate_test()\n{\n\tlocal last_policer=$(devlink -j -p trap policer show |\n\t\t\t     jq '[.[][\"'$DEVLINK_DEV'\"][].policer] | max')\n\n\tlog_info \"Running rate test for policer 1\"\n\t__rate_test 1\n\n\tlog_info \"Running rate test for policer $((last_policer / 2))\"\n\t__rate_test $((last_policer / 2))\n\n\tlog_info \"Running rate test for policer $last_policer\"\n\t__rate_test $last_policer\n}\n\n__burst_test()\n{\n\tlocal t0_rx t0_drop t1_rx t1_drop rx drop\n\tlocal id=$1; shift\n\n\tRET=0\n\n\tdevlink trap policer set $DEVLINK_DEV policer $id rate 1000 burst 512\n\tdevlink trap group set $DEVLINK_DEV group l3_drops policer $id\n\n\t# Send a burst of 16 packets and make sure that 16 are received\n\t# and that none are dropped by the policer\n\tlog_info \"=== Tx burst size: 16, Policer burst size: 512 ===\"\n\n\tt0_rx=$(devlink_trap_rx_packets_get blackhole_route)\n\tt0_drop=$(devlink_trap_policer_rx_dropped_get $id)\n\n\tstart_traffic $h1 192.0.2.1 198.51.100.100 $rp1_mac -c 16\n\n\tt1_rx=$(devlink_trap_rx_packets_get blackhole_route)\n\tt1_drop=$(devlink_trap_policer_rx_dropped_get $id)\n\n\trx=$((t1_rx - t0_rx))\n\t(( rx == 16 ))\n\tcheck_err $? \"Expected burst size of 16 packets, got $rx packets\"\n\tlog_info \"Expected burst size of 16 packets, measured burst size of $rx packets\"\n\n\tdrop=$((t1_drop - t0_drop))\n\t(( drop == 0 ))\n\tcheck_err $? \"Expected zero policer drops, got $drop\"\n\tlog_info \"Measured policer drops of $drop packets\"\n\n\t# Unbind the policer and send a burst of 64 packets. Make sure that\n\t# 64 packets are received and that none are dropped by the policer\n\tlog_info \"=== Tx burst size: 64, Policer burst size: No policer ===\"\n\n\tdevlink trap group set $DEVLINK_DEV group l3_drops nopolicer\n\n\tt0_rx=$(devlink_trap_rx_packets_get blackhole_route)\n\tt0_drop=$(devlink_trap_policer_rx_dropped_get $id)\n\n\tstart_traffic $h1 192.0.2.1 198.51.100.100 $rp1_mac -c 64\n\n\tt1_rx=$(devlink_trap_rx_packets_get blackhole_route)\n\tt1_drop=$(devlink_trap_policer_rx_dropped_get $id)\n\n\trx=$((t1_rx - t0_rx))\n\t(( rx == 64 ))\n\tcheck_err $? \"Expected burst size of 64 packets, got $rx packets\"\n\tlog_info \"Expected burst size of 64 packets, measured burst size of $rx packets\"\n\n\tdrop=$((t1_drop - t0_drop))\n\t(( drop == 0 ))\n\tcheck_err $? \"Expected zero policer drops, got $drop\"\n\tlog_info \"Measured policer drops of $drop packets\"\n\n\tlog_test \"Trap policer burst size\"\n}\n\nburst_test()\n{\n\tlocal last_policer=$(devlink -j -p trap policer show |\n\t\t\t     jq '[.[][\"'$DEVLINK_DEV'\"][].policer] | max')\n\n\tlog_info \"Running burst test for policer 1\"\n\t__burst_test 1\n\n\tlog_info \"Running burst test for policer $((last_policer / 2))\"\n\t__burst_test $((last_policer / 2))\n\n\tlog_info \"Running burst test for policer $last_policer\"\n\t__burst_test $last_policer\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}