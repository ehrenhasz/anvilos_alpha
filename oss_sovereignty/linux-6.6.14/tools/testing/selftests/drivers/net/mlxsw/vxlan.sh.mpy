{
  "module_name": "vxlan.sh",
  "hash_id": "26d5163c7bd805209aa54d402abf23667b86d4d881848ccf4425b69415a2fb3a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/vxlan.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test various aspects of VxLAN offloading which are specific to mlxsw, such\n# as sanitization of invalid configurations and offload indication.\n\n: ${ADDR_FAMILY:=ipv4}\nexport ADDR_FAMILY\n\n: ${LOCAL_IP_1:=198.51.100.1}\nexport LOCAL_IP_1\n\n: ${LOCAL_IP_2:=198.51.100.2}\nexport LOCAL_IP_2\n\n: ${PREFIX_LEN:=32}\nexport PREFIX_LEN\n\n: ${UDPCSUM_FLAFS:=noudpcsum}\nexport UDPCSUM_FLAFS\n\n: ${MC_IP:=239.0.0.1}\nexport MC_IP\n\n: ${IP_FLAG:=\"\"}\nexport IP_FLAG\n\n: ${ALL_TESTS:=\"\n\tsanitization_test\n\toffload_indication_test\n\tsanitization_vlan_aware_test\n\toffload_indication_vlan_aware_test\n\"}\n\nlib_dir=$(dirname $0)/../../../net/forwarding\nNUM_NETIFS=2\n: ${TIMEOUT:=20000} # ms\nsource $lib_dir/lib.sh\n\nsetup_prepare()\n{\n\tswp1=${NETIFS[p1]}\n\tswp2=${NETIFS[p2]}\n\n\tip link set dev $swp1 up\n\tip link set dev $swp2 up\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip link set dev $swp2 down\n\tip link set dev $swp1 down\n}\n\nsanitization_single_dev_test_pass()\n{\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\tip link set dev vxlan0 master br0\n\tcheck_err $?\n\n\tip link set dev $swp1 nomaster\n\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n}\n\nsanitization_single_dev_test_fail()\n{\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\tip link set dev vxlan0 master br0 &> /dev/null\n\tcheck_fail $?\n\n\tip link set dev $swp1 nomaster\n\n\tip link set dev vxlan0 master br0\n\tcheck_err $?\n\tip link set dev $swp1 master br0 &> /dev/null\n\tcheck_fail $?\n}\n\nsanitization_single_dev_valid_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_pass\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device - valid configuration\"\n}\n\nsanitization_single_dev_vlan_aware_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0 vlan_filtering 1\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_pass\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with a vlan-aware bridge\"\n}\n\nsanitization_single_dev_mcast_enabled_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with a multicast enabled bridge\"\n}\n\nsanitization_single_dev_mcast_group_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link add name dummy1 up type dummy\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789 \\\n\t\tdev dummy1 group $MC_IP\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev dummy1\n\tip link del dev br0\n\n\tlog_test \"vxlan device with a multicast group\"\n}\n\nsanitization_single_dev_no_local_ip_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit dstport 4789\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with no local ip\"\n}\n\nsanitization_single_dev_learning_enabled_ipv4_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 learning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_pass\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with learning enabled\"\n}\n\nsanitization_single_dev_local_interface_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link add name dummy1 up type dummy\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789 dev dummy1\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev dummy1\n\tip link del dev br0\n\n\tlog_test \"vxlan device with local interface\"\n}\n\nsanitization_single_dev_port_range_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789 \\\n\t\tsrcport 4000 5000\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with udp source port range\"\n}\n\nsanitization_single_dev_tos_static_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos 20 local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with static tos\"\n}\n\nsanitization_single_dev_ttl_inherit_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl inherit tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with inherit ttl\"\n}\n\nsanitization_single_dev_udp_checksum_ipv4_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning udpcsum \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_single_dev_test_fail\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\n\tlog_test \"vxlan device with udp checksum\"\n}\n\nsanitization_single_dev_test()\n{\n\t# These tests make sure that we correctly sanitize VxLAN device\n\t# configurations we do not support\n\tsanitization_single_dev_valid_test\n\tsanitization_single_dev_vlan_aware_test\n\tsanitization_single_dev_mcast_enabled_test\n\tsanitization_single_dev_mcast_group_test\n\tsanitization_single_dev_no_local_ip_test\n\tsanitization_single_dev_learning_enabled_\"$ADDR_FAMILY\"_test\n\tsanitization_single_dev_local_interface_test\n\tsanitization_single_dev_port_range_test\n\tsanitization_single_dev_tos_static_test\n\tsanitization_single_dev_ttl_inherit_test\n\tsanitization_single_dev_udp_checksum_\"$ADDR_FAMILY\"_test\n}\n\nsanitization_multi_devs_test_pass()\n{\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\tip link set dev vxlan0 master br0\n\tcheck_err $?\n\tip link set dev $swp2 master br1\n\tcheck_err $?\n\tip link set dev vxlan1 master br1\n\tcheck_err $?\n\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 nomaster\n\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\tip link set dev $swp2 master br1\n\tcheck_err $?\n}\n\nsanitization_multi_devs_test_fail()\n{\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\tip link set dev vxlan0 master br0\n\tcheck_err $?\n\tip link set dev $swp2 master br1\n\tcheck_err $?\n\tip link set dev vxlan1 master br1 &> /dev/null\n\tcheck_fail $?\n\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 nomaster\n\n\tip link set dev vxlan1 master br1\n\tcheck_err $?\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\tip link set dev $swp2 master br1 &> /dev/null\n\tcheck_fail $?\n}\n\nsanitization_multi_devs_valid_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link add dev br1 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan1 up type vxlan id 20 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_multi_devs_test_pass\n\n\tip link del dev vxlan1\n\tip link del dev vxlan0\n\tip link del dev br1\n\tip link del dev br0\n\n\tlog_test \"multiple vxlan devices - valid configuration\"\n}\n\nsanitization_multi_devs_ttl_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link add dev br1 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan1 up type vxlan id 20 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 40 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tsanitization_multi_devs_test_fail\n\n\tip link del dev vxlan1\n\tip link del dev vxlan0\n\tip link del dev br1\n\tip link del dev br0\n\n\tlog_test \"multiple vxlan devices with different ttl\"\n}\n\nsanitization_multi_devs_udp_dstport_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link add dev br1 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan1 up type vxlan id 20 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 5789\n\n\tsanitization_multi_devs_test_fail\n\n\tip link del dev vxlan1\n\tip link del dev vxlan0\n\tip link del dev br1\n\tip link del dev br0\n\n\tlog_test \"multiple vxlan devices with different udp destination port\"\n}\n\nsanitization_multi_devs_local_ip_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link add dev br1 type bridge mcast_snooping 0\n\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan1 up type vxlan id 20 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_2 dstport 4789\n\n\tsanitization_multi_devs_test_fail\n\n\tip link del dev vxlan1\n\tip link del dev vxlan0\n\tip link del dev br1\n\tip link del dev br0\n\n\tlog_test \"multiple vxlan devices with different local ip\"\n}\n\nsanitization_multi_devs_test()\n{\n\t# The device has a single VTEP, which means all the VxLAN devices\n\t# we offload must share certain properties such as source IP and\n\t# UDP destination port. These tests make sure that we forbid\n\t# configurations that violate this limitation\n\tsanitization_multi_devs_valid_test\n\tsanitization_multi_devs_ttl_test\n\tsanitization_multi_devs_udp_dstport_test\n\tsanitization_multi_devs_local_ip_test\n}\n\nsanitization_test()\n{\n\tsanitization_single_dev_test\n\tsanitization_multi_devs_test\n}\n\noffload_indication_setup_create()\n{\n\t# Create a simple setup with two bridges, each with a VxLAN device\n\t# and one local port\n\tip link add name br0 type bridge mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name br1 type bridge mcast_snooping 0\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp2 master br1\n\n\tip address add $LOCAL_IP_1/$PREFIX_LEN dev lo\n\n\tip link add name vxlan0 up master br0 type vxlan id 10 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan1 up master br1 type vxlan id 20 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n}\n\noffload_indication_setup_destroy()\n{\n\tip link del dev vxlan1\n\tip link del dev vxlan0\n\n\tip address del $LOCAL_IP_1/$PREFIX_LEN dev lo\n\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 nomaster\n\n\tip link del dev br1\n\tip link del dev br0\n}\n\noffload_indication_fdb_flood_test()\n{\n\tRET=0\n\n\tbridge fdb append 00:00:00:00:00:00 dev vxlan0 self dst $LOCAL_IP_2\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb 00:00:00:00:00:00 \\\n\t\tbridge fdb show brport vxlan0\n\tcheck_err $?\n\n\tbridge fdb del 00:00:00:00:00:00 dev vxlan0 self\n\n\tlog_test \"vxlan flood entry offload indication\"\n}\n\noffload_indication_fdb_bridge_test()\n{\n\tRET=0\n\n\tbridge fdb add de:ad:be:ef:13:37 dev vxlan0 self master static \\\n\t\tdst $LOCAL_IP_2\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan0\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan0\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - initial state\"\n\n\t# Remove FDB entry from the bridge driver and check that corresponding\n\t# entry in the VxLAN driver is not marked as offloaded\n\tRET=0\n\n\tbridge fdb del de:ad:be:ef:13:37 dev vxlan0 master\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan0\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after removal from bridge\"\n\n\t# Add the FDB entry back to the bridge driver and make sure it is\n\t# marked as offloaded in both drivers\n\tRET=0\n\n\tbridge fdb add de:ad:be:ef:13:37 dev vxlan0 master static\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan0\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan0\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after re-add to bridge\"\n\n\t# Remove FDB entry from the VxLAN driver and check that corresponding\n\t# entry in the bridge driver is not marked as offloaded\n\tRET=0\n\n\tbridge fdb del de:ad:be:ef:13:37 dev vxlan0 self\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan0\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after removal from vxlan\"\n\n\t# Add the FDB entry back to the VxLAN driver and make sure it is\n\t# marked as offloaded in both drivers\n\tRET=0\n\n\tbridge fdb add de:ad:be:ef:13:37 dev vxlan0 self dst $LOCAL_IP_2\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan0\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan0\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after re-add to vxlan\"\n\n\tbridge fdb del de:ad:be:ef:13:37 dev vxlan0 self master\n}\n\noffload_indication_fdb_test()\n{\n\toffload_indication_fdb_flood_test\n\toffload_indication_fdb_bridge_test\n}\n\noffload_indication_decap_route_test()\n{\n\tRET=0\n\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link set dev vxlan0 down\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link set dev vxlan1 down\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - vxlan device down\"\n\n\tRET=0\n\n\tip link set dev vxlan1 up\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link set dev vxlan0 up\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - vxlan device up\"\n\n\tRET=0\n\n\tip address delete $LOCAL_IP_1/$PREFIX_LEN dev lo\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip address add $LOCAL_IP_1/$PREFIX_LEN dev lo\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - add local route\"\n\n\tRET=0\n\n\tip link set dev $swp1 nomaster\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link set dev $swp2 nomaster\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp2 master br1\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - local ports enslavement\"\n\n\tRET=0\n\n\tip link del dev br0\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link del dev br1\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - bridge device deletion\"\n\n\tRET=0\n\n\tip link add name br0 type bridge mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name br1 type bridge mcast_snooping 0\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\tip link set dev $swp1 master br0\n\tip link set dev $swp2 master br1\n\tip link set dev vxlan0 master br0\n\tip link set dev vxlan1 master br1\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link del dev vxlan0\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tip link del dev vxlan1\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - vxlan device deletion\"\n\n\tip link add name vxlan0 up master br0 type vxlan id 10 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan1 up master br1 type vxlan id 20 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n}\n\ncheck_fdb_offloaded()\n{\n\tlocal mac=00:11:22:33:44:55\n\tlocal zmac=00:00:00:00:00:00\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $mac self \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $mac master \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n}\n\ncheck_vxlan_fdb_not_offloaded()\n{\n\tlocal mac=00:11:22:33:44:55\n\tlocal zmac=00:00:00:00:00:00\n\n\tbridge fdb show dev vxlan0 | grep $mac | grep -q self\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb $mac self \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n\n\tbridge fdb show dev vxlan0 | grep $zmac | grep -q self\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n}\n\ncheck_bridge_fdb_not_offloaded()\n{\n\tlocal mac=00:11:22:33:44:55\n\tlocal zmac=00:00:00:00:00:00\n\n\tbridge fdb show dev vxlan0 | grep $mac | grep -q master\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb $mac master \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n}\n\n__offload_indication_join_vxlan_first()\n{\n\tlocal vid=$1; shift\n\n\tlocal mac=00:11:22:33:44:55\n\tlocal zmac=00:00:00:00:00:00\n\n\tbridge fdb append $zmac dev vxlan0 self dst $LOCAL_IP_2\n\n\tip link set dev vxlan0 master br0\n\tbridge fdb add dev vxlan0 $mac self master static dst $LOCAL_IP_2\n\n\tRET=0\n\tcheck_vxlan_fdb_not_offloaded\n\tip link set dev $swp1 master br0\n\tsleep .1\n\tcheck_fdb_offloaded\n\tlog_test \"offload indication - attach vxlan first\"\n\n\tRET=0\n\tip link set dev vxlan0 down\n\tcheck_vxlan_fdb_not_offloaded\n\tcheck_bridge_fdb_not_offloaded\n\tlog_test \"offload indication - set vxlan down\"\n\n\tRET=0\n\tip link set dev vxlan0 up\n\tsleep .1\n\tcheck_fdb_offloaded\n\tlog_test \"offload indication - set vxlan up\"\n\n\tif [[ ! -z $vid ]]; then\n\t\tRET=0\n\t\tbridge vlan del dev vxlan0 vid $vid\n\t\tcheck_vxlan_fdb_not_offloaded\n\t\tcheck_bridge_fdb_not_offloaded\n\t\tlog_test \"offload indication - delete VLAN\"\n\n\t\tRET=0\n\t\tbridge vlan add dev vxlan0 vid $vid\n\t\tcheck_vxlan_fdb_not_offloaded\n\t\tcheck_bridge_fdb_not_offloaded\n\t\tlog_test \"offload indication - add tagged VLAN\"\n\n\t\tRET=0\n\t\tbridge vlan add dev vxlan0 vid $vid pvid untagged\n\t\tsleep .1\n\t\tcheck_fdb_offloaded\n\t\tlog_test \"offload indication - add pvid/untagged VLAN\"\n\tfi\n\n\tRET=0\n\tip link set dev $swp1 nomaster\n\tcheck_vxlan_fdb_not_offloaded\n\tlog_test \"offload indication - detach port\"\n}\n\noffload_indication_join_vxlan_first()\n{\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\t__offload_indication_join_vxlan_first\n\n\tip link del dev vxlan0\n\tip link del dev br0\n}\n\n__offload_indication_join_vxlan_last()\n{\n\tlocal zmac=00:00:00:00:00:00\n\n\tRET=0\n\n\tbridge fdb append $zmac dev vxlan0 self dst $LOCAL_IP_2\n\n\tip link set dev $swp1 master br0\n\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n\n\tip link set dev vxlan0 master br0\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show dev vxlan0\n\tcheck_err $?\n\n\tlog_test \"offload indication - attach vxlan last\"\n}\n\noffload_indication_join_vxlan_last()\n{\n\tip link add dev br0 type bridge mcast_snooping 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\t__offload_indication_join_vxlan_last\n\n\tip link del dev vxlan0\n\tip link del dev br0\n}\n\noffload_indication_test()\n{\n\toffload_indication_setup_create\n\toffload_indication_fdb_test\n\toffload_indication_decap_route_test\n\toffload_indication_setup_destroy\n\n\tlog_info \"offload indication - replay & cleanup\"\n\toffload_indication_join_vxlan_first\n\toffload_indication_join_vxlan_last\n}\n\nsanitization_vlan_aware_test()\n{\n\tRET=0\n\n\tip link add dev br0 type bridge mcast_snooping 0 vlan_filtering 1\n\tip link set dev br0 addrgenmode none\n\n\tip link add name vxlan10 up master br0 type vxlan id 10 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tip link add name vxlan20 up master br0 type vxlan id 20 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\t# Test that when each VNI is mapped to a different VLAN we can enslave\n\t# a port to the bridge\n\tbridge vlan add vid 10 dev vxlan10 pvid untagged\n\tbridge vlan add vid 20 dev vxlan20 pvid untagged\n\n\tip link set dev $swp1 master br0\n\tcheck_err $?\n\n\tlog_test \"vlan-aware - enslavement to vlan-aware bridge\"\n\n\t# Try to map both VNIs to the same VLAN and make sure configuration\n\t# fails\n\tRET=0\n\n\tbridge vlan add vid 10 dev vxlan20 pvid untagged &> /dev/null\n\tcheck_fail $?\n\n\tlog_test \"vlan-aware - two vnis mapped to the same vlan\"\n\n\t# Test that enslavement of a port to a bridge fails when two VNIs\n\t# are mapped to the same VLAN\n\tRET=0\n\n\tip link set dev $swp1 nomaster\n\n\tbridge vlan del vid 20 dev vxlan20 pvid untagged\n\tbridge vlan add vid 10 dev vxlan20 pvid untagged\n\n\tip link set dev $swp1 master br0 &> /dev/null\n\tcheck_fail $?\n\n\tlog_test \"vlan-aware - failed enslavement to vlan-aware bridge\"\n\n\tbridge vlan del vid 10 dev vxlan20\n\tbridge vlan add vid 20 dev vxlan20 pvid untagged\n\n\t# Test that when two VXLAN tunnels with conflicting configurations\n\t# (i.e., different TTL) are enslaved to the same VLAN-aware bridge,\n\t# then the enslavement of a port to the bridge is denied.\n\n\t# Use the offload indication of the local route to ensure the VXLAN\n\t# configuration was correctly rollbacked.\n\tip address add $LOCAL_IP_1/$PREFIX_LEN dev lo\n\n\tip link set dev vxlan10 type vxlan ttl 10\n\tip link set dev $swp1 master br0 &> /dev/null\n\tcheck_fail $?\n\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vlan-aware - failed enslavement to bridge due to conflict\"\n\n\tip link set dev vxlan10 type vxlan ttl 20\n\tip address del $LOCAL_IP_1/$PREFIX_LEN dev lo\n\n\tip link del dev vxlan20\n\tip link del dev vxlan10\n\tip link del dev br0\n}\n\noffload_indication_vlan_aware_setup_create()\n{\n\t# Create a simple setup with two VxLAN devices and a single VLAN-aware\n\t# bridge\n\tip link add name br0 type bridge mcast_snooping 0 vlan_filtering 1 \\\n\t\tvlan_default_pvid 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\n\tip link set dev $swp1 master br0\n\n\tbridge vlan add vid 10 dev $swp1\n\tbridge vlan add vid 20 dev $swp1\n\n\tip address add $LOCAL_IP_1/$PREFIX_LEN dev lo\n\n\tip link add name vxlan10 up master br0 type vxlan id 10 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\tip link add name vxlan20 up master br0 type vxlan id 20 nolearning \\\n\t\t$UDPCSUM_FLAFS ttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tbridge vlan add vid 10 dev vxlan10 pvid untagged\n\tbridge vlan add vid 20 dev vxlan20 pvid untagged\n}\n\noffload_indication_vlan_aware_setup_destroy()\n{\n\tbridge vlan del vid 20 dev vxlan20\n\tbridge vlan del vid 10 dev vxlan10\n\n\tip link del dev vxlan20\n\tip link del dev vxlan10\n\n\tip address del $LOCAL_IP_1/$PREFIX_LEN dev lo\n\n\tbridge vlan del vid 20 dev $swp1\n\tbridge vlan del vid 10 dev $swp1\n\n\tip link set dev $swp1 nomaster\n\n\tip link del dev br0\n}\n\noffload_indication_vlan_aware_fdb_test()\n{\n\tRET=0\n\n\tlog_info \"vxlan entry offload indication - vlan-aware\"\n\n\tbridge fdb add de:ad:be:ef:13:37 dev vxlan10 self master static \\\n\t\tdst $LOCAL_IP_2 vlan 10\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan10\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan10\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - initial state\"\n\n\t# Remove FDB entry from the bridge driver and check that corresponding\n\t# entry in the VxLAN driver is not marked as offloaded\n\tRET=0\n\n\tbridge fdb del de:ad:be:ef:13:37 dev vxlan10 master vlan 10\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan10\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after removal from bridge\"\n\n\t# Add the FDB entry back to the bridge driver and make sure it is\n\t# marked as offloaded in both drivers\n\tRET=0\n\n\tbridge fdb add de:ad:be:ef:13:37 dev vxlan10 master static vlan 10\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan10\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan10\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after re-add to bridge\"\n\n\t# Remove FDB entry from the VxLAN driver and check that corresponding\n\t# entry in the bridge driver is not marked as offloaded\n\tRET=0\n\n\tbridge fdb del de:ad:be:ef:13:37 dev vxlan10 self\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan10\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after removal from vxlan\"\n\n\t# Add the FDB entry back to the VxLAN driver and make sure it is\n\t# marked as offloaded in both drivers\n\tRET=0\n\n\tbridge fdb add de:ad:be:ef:13:37 dev vxlan10 self dst $LOCAL_IP_2\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self bridge fdb show brport vxlan10\n\tcheck_err $?\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb \\\n\t\tde:ad:be:ef:13:37 self -v bridge fdb show brport vxlan10\n\tcheck_err $?\n\n\tlog_test \"vxlan entry offload indication - after re-add to vxlan\"\n\n\tbridge fdb del de:ad:be:ef:13:37 dev vxlan10 self master vlan 10\n}\n\noffload_indication_vlan_aware_decap_route_test()\n{\n\tRET=0\n\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\t# Toggle PVID flag on one VxLAN device and make sure route is still\n\t# marked as offloaded\n\tbridge vlan add vid 10 dev vxlan10 untagged\n\n\tbusywait \"$TIMEOUT\" wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\t# Toggle PVID flag on second VxLAN device and make sure route is no\n\t# longer marked as offloaded\n\tbridge vlan add vid 20 dev vxlan20 untagged\n\n\tbusywait \"$TIMEOUT\" not wait_for_offload \\\n\t\tip $IP_FLAG route show table local $LOCAL_IP_1\n\tcheck_err $?\n\n\t# Toggle PVID flag back and make sure route is marked as offloaded\n\tbridge vlan add vid 10 dev vxlan10 pvid untagged\n\tbridge vlan add vid 20 dev vxlan20 pvid untagged\n\n\tbusywait \"$TIMEOUT\" wait_for_offload ip $IP_FLAG route show table local \\\n\t\t$LOCAL_IP_1\n\tcheck_err $?\n\n\tlog_test \"vxlan decap route - vni map/unmap\"\n}\n\noffload_indication_vlan_aware_join_vxlan_first()\n{\n\tip link add dev br0 type bridge mcast_snooping 0 \\\n\t\tvlan_filtering 1 vlan_default_pvid 1\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\t__offload_indication_join_vxlan_first 1\n\n\tip link del dev vxlan0\n\tip link del dev br0\n}\n\noffload_indication_vlan_aware_join_vxlan_last()\n{\n\tip link add dev br0 type bridge mcast_snooping 0 \\\n\t\tvlan_filtering 1 vlan_default_pvid 1\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\t__offload_indication_join_vxlan_last\n\n\tip link del dev vxlan0\n\tip link del dev br0\n}\n\noffload_indication_vlan_aware_l3vni_test()\n{\n\tlocal zmac=00:00:00:00:00:00\n\n\tRET=0\n\n\tsysctl_set net.ipv6.conf.default.disable_ipv6 1\n\tip link add dev br0 type bridge mcast_snooping 0 \\\n\t\tvlan_filtering 1 vlan_default_pvid 0\n\tip link set dev br0 addrgenmode none\n\tip link set dev br0 up\n\tip link add name vxlan0 up type vxlan id 10 nolearning $UDPCSUM_FLAFS \\\n\t\tttl 20 tos inherit local $LOCAL_IP_1 dstport 4789\n\n\tip link set dev $swp1 master br0\n\n\t# The test will use the offload indication on the FDB entry to\n\t# understand if the tunnel is offloaded or not\n\tbridge fdb append $zmac dev vxlan0 self dst $LOCAL_IP_2\n\n\tip link set dev vxlan0 master br0\n\tbridge vlan add dev vxlan0 vid 10 pvid untagged\n\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show brport vxlan0\n\tcheck_err $? \"vxlan tunnel not offloaded when should\"\n\n\t# Configure a VLAN interface and make sure tunnel is offloaded\n\tip link add link br0 name br10 up type vlan id 10\n\tsysctl_set net.ipv6.conf.br10.disable_ipv6 0\n\tip -6 address add 2001:db8:1::1/64 dev br10\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show brport vxlan0\n\tcheck_err $? \"vxlan tunnel not offloaded when should\"\n\n\t# Unlink the VXLAN device, make sure tunnel is no longer offloaded,\n\t# then add it back to the bridge and make sure it is offloaded\n\tip link set dev vxlan0 nomaster\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show brport vxlan0\n\tcheck_err $? \"vxlan tunnel offloaded after unlinked from bridge\"\n\n\tip link set dev vxlan0 master br0\n\tbusywait \"$TIMEOUT\" not wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show brport vxlan0\n\tcheck_err $? \"vxlan tunnel offloaded despite no matching vid\"\n\n\tbridge vlan add dev vxlan0 vid 10 pvid untagged\n\tbusywait \"$TIMEOUT\" wait_for_offload grep_bridge_fdb $zmac self \\\n\t\tbridge fdb show brport vxlan0\n\tcheck_err $? \"vxlan tunnel not offloaded after adding vid\"\n\n\tlog_test \"vxlan - l3 vni\"\n\n\tip link del dev vxlan0\n\tip link del dev br0\n\tsysctl_restore net.ipv6.conf.default.disable_ipv6\n}\n\noffload_indication_vlan_aware_test()\n{\n\toffload_indication_vlan_aware_setup_create\n\toffload_indication_vlan_aware_fdb_test\n\toffload_indication_vlan_aware_decap_route_test\n\toffload_indication_vlan_aware_setup_destroy\n\n\tlog_info \"offload indication - replay & cleanup - vlan aware\"\n\toffload_indication_vlan_aware_join_vxlan_first\n\toffload_indication_vlan_aware_join_vxlan_last\n\toffload_indication_vlan_aware_l3vni_test\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}