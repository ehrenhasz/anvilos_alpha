{
  "module_name": "devlink_linecard.sh",
  "hash_id": "83070b534b7aa0d20cae94f53d3d52d3f1e05455f2f437dea03117d69e436cca",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/devlink_linecard.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# In addition to the common variables, user might use:\n# LC_SLOT - If not set, all probed line cards are going to be tested,\n#\t    with an exception of the \"activation_16x100G_test\".\n#\t    It set, only the selected line card is going to be used\n#\t    for tests, including \"activation_16x100G_test\".\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tunprovision_test\n\tprovision_test\n\tactivation_16x100G_test\n\"\n\nNUM_NETIFS=0\n\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nuntil_lc_state_is()\n{\n\tlocal state=$1; shift\n\tlocal current=$(\"$@\")\n\n\techo \"$current\"\n\t[ \"$current\" == \"$state\" ]\n}\n\nuntil_lc_state_is_not()\n{\n\t! until_lc_state_is \"$@\"\n}\n\nlc_state_get()\n{\n\tlocal lc=$1\n\n\tdevlink lc show $DEVLINK_DEV lc $lc -j | jq -e -r \".[][][].state\"\n}\n\nlc_wait_until_state_changes()\n{\n\tlocal lc=$1\n\tlocal state=$2\n\tlocal timeout=$3 # ms\n\n\tbusywait \"$timeout\" until_lc_state_is_not \"$state\" lc_state_get \"$lc\"\n}\n\nlc_wait_until_state_becomes()\n{\n\tlocal lc=$1\n\tlocal state=$2\n\tlocal timeout=$3 # ms\n\n\tbusywait \"$timeout\" until_lc_state_is \"$state\" lc_state_get \"$lc\"\n}\n\nuntil_lc_port_count_is()\n{\n\tlocal port_count=$1; shift\n\tlocal current=$(\"$@\")\n\n\techo \"$current\"\n\t[ $current == $port_count ]\n}\n\nlc_port_count_get()\n{\n\tlocal lc=$1\n\n\tdevlink port -j | jq -e -r \".[][] | select(.lc==$lc) | .port\" | wc -l\n}\n\nlc_wait_until_port_count_is()\n{\n\tlocal lc=$1\n\tlocal port_count=$2\n\tlocal timeout=$3 # ms\n\n\tbusywait \"$timeout\" until_lc_port_count_is \"$port_count\" lc_port_count_get \"$lc\"\n}\n\nlc_nested_devlink_dev_get()\n{\n\tlocal lc=$1\n\n\tdevlink lc show $DEVLINK_DEV lc $lc -j | jq -e -r \".[][][].nested_devlink\"\n}\n\nPROV_UNPROV_TIMEOUT=8000 # ms\nPOST_PROV_ACT_TIMEOUT=2000 # ms\nPROV_PORTS_INSTANTIATION_TIMEOUT=15000 # ms\n\nunprovision_one()\n{\n\tlocal lc=$1\n\tlocal state\n\n\tstate=$(lc_state_get $lc)\n\tcheck_err $? \"Failed to get state of linecard $lc\"\n\tif [[ \"$state\" == \"unprovisioned\" ]]; then\n\t\treturn\n\tfi\n\n\tlog_info \"Unprovisioning linecard $lc\"\n\n\tdevlink lc set $DEVLINK_DEV lc $lc notype\n\tcheck_err $? \"Failed to trigger linecard $lc unprovisioning\"\n\n\tstate=$(lc_wait_until_state_changes $lc \"unprovisioning\" \\\n\t\t$PROV_UNPROV_TIMEOUT)\n\tcheck_err $? \"Failed to unprovision linecard $lc (timeout)\"\n\n\t[ \"$state\" == \"unprovisioned\" ]\n\tcheck_err $? \"Failed to unprovision linecard $lc (state=$state)\"\n}\n\nprovision_one()\n{\n\tlocal lc=$1\n\tlocal type=$2\n\tlocal state\n\n\tlog_info \"Provisioning linecard $lc\"\n\n\tdevlink lc set $DEVLINK_DEV lc $lc type $type\n\tcheck_err $? \"Failed trigger linecard $lc provisioning\"\n\n\tstate=$(lc_wait_until_state_changes $lc \"provisioning\" \\\n\t\t$PROV_UNPROV_TIMEOUT)\n\tcheck_err $? \"Failed to provision linecard $lc (timeout)\"\n\n\t[ \"$state\" == \"provisioned\" ] || [ \"$state\" == \"active\" ]\n\tcheck_err $? \"Failed to provision linecard $lc (state=$state)\"\n\n\tprovisioned_type=$(devlink lc show $DEVLINK_DEV lc $lc -j | jq -e -r \".[][][].type\")\n\t[ \"$provisioned_type\" == \"$type\" ]\n\tcheck_err $? \"Wrong provision type returned for linecard $lc (got \\\"$provisioned_type\\\", expected \\\"$type\\\")\"\n\n\t# Wait for possible activation to make sure the state\n\t# won't change after return from this function.\n\tstate=$(lc_wait_until_state_becomes $lc \"active\" \\\n\t\t$POST_PROV_ACT_TIMEOUT)\n}\n\nunprovision_test()\n{\n\tRET=0\n\tlocal lc\n\n\tlc=$LC_SLOT\n\tunprovision_one $lc\n\tlog_test \"Unprovision\"\n}\n\nLC_16X100G_TYPE=\"16x100G\"\nLC_16X100G_PORT_COUNT=16\n\nsupported_types_check()\n{\n\tlocal lc=$1\n\tlocal supported_types_count\n\tlocal type_index\n\tlocal lc_16x100_found=false\n\n\tsupported_types_count=$(devlink lc show $DEVLINK_DEV lc $lc -j | \\\n\t\t\t\tjq -e -r \".[][][].supported_types | length\")\n\t[ $supported_types_count != 0 ]\n\tcheck_err $? \"No supported types found for linecard $lc\"\n\tfor (( type_index=0; type_index<$supported_types_count; type_index++ ))\n\tdo\n\t\ttype=$(devlink lc show $DEVLINK_DEV lc $lc -j | \\\n\t\t       jq -e -r \".[][][].supported_types[$type_index]\")\n\t\tif [[ \"$type\" == \"$LC_16X100G_TYPE\" ]]; then\n\t\t\tlc_16x100_found=true\n\t\t\tbreak\n\t\tfi\n\tdone\n\t[ $lc_16x100_found = true ]\n\tcheck_err $? \"16X100G not found between supported types of linecard $lc\"\n}\n\nports_check()\n{\n\tlocal lc=$1\n\tlocal expected_port_count=$2\n\tlocal port_count\n\n\tport_count=$(lc_wait_until_port_count_is $lc $expected_port_count \\\n\t\t$PROV_PORTS_INSTANTIATION_TIMEOUT)\n\t[ $port_count != 0 ]\n\tcheck_err $? \"No port associated with linecard $lc\"\n\t[ $port_count == $expected_port_count ]\n\tcheck_err $? \"Unexpected port count linecard $lc (got $port_count, expected $expected_port_count)\"\n}\n\nlc_dev_info_provisioned_check()\n{\n\tlocal lc=$1\n\tlocal nested_devlink_dev=$2\n\tlocal fixed_hw_revision\n\tlocal running_ini_version\n\n\tfixed_hw_revision=$(devlink dev info $nested_devlink_dev -j | \\\n\t\t\t    jq -e -r '.[][].versions.fixed.\"hw.revision\"')\n\tcheck_err $? \"Failed to get linecard $lc fixed.hw.revision\"\n\tlog_info \"Linecard $lc fixed.hw.revision: \\\"$fixed_hw_revision\\\"\"\n\trunning_ini_version=$(devlink dev info $nested_devlink_dev -j | \\\n\t\t\t      jq -e -r '.[][].versions.running.\"ini.version\"')\n\tcheck_err $? \"Failed to get linecard $lc running.ini.version\"\n\tlog_info \"Linecard $lc running.ini.version: \\\"$running_ini_version\\\"\"\n}\n\nprovision_test()\n{\n\tRET=0\n\tlocal lc\n\tlocal type\n\tlocal state\n\tlocal nested_devlink_dev\n\n\tlc=$LC_SLOT\n\tsupported_types_check $lc\n\tstate=$(lc_state_get $lc)\n\tcheck_err $? \"Failed to get state of linecard $lc\"\n\tif [[ \"$state\" != \"unprovisioned\" ]]; then\n\t\tunprovision_one $lc\n\tfi\n\tprovision_one $lc $LC_16X100G_TYPE\n\tports_check $lc $LC_16X100G_PORT_COUNT\n\n\tnested_devlink_dev=$(lc_nested_devlink_dev_get $lc)\n\tcheck_err $? \"Failed to get nested devlink handle of linecard $lc\"\n\tlc_dev_info_provisioned_check $lc $nested_devlink_dev\n\n\tlog_test \"Provision\"\n}\n\nACTIVATION_TIMEOUT=20000 # ms\n\ninterface_check()\n{\n\tip link set $h1 up\n\tip link set $h2 up\n\tifaces_upped=true\n\tsetup_wait\n}\n\nlc_dev_info_active_check()\n{\n\tlocal lc=$1\n\tlocal nested_devlink_dev=$2\n\tlocal fixed_device_fw_psid\n\tlocal running_device_fw\n\n\tfixed_device_fw_psid=$(devlink dev info $nested_devlink_dev -j | \\\n\t\t\t       jq -e -r \".[][].versions.fixed\" | \\\n\t\t\t       jq -e -r '.\"fw.psid\"')\n\tcheck_err $? \"Failed to get linecard $lc fixed fw PSID\"\n\tlog_info \"Linecard $lc fixed.fw.psid: \\\"$fixed_device_fw_psid\\\"\"\n\n\trunning_device_fw=$(devlink dev info $nested_devlink_dev -j | \\\n\t\t\t    jq -e -r \".[][].versions.running.fw\")\n\tcheck_err $? \"Failed to get linecard $lc running.fw.version\"\n\tlog_info \"Linecard $lc running.fw: \\\"$running_device_fw\\\"\"\n}\n\nactivation_16x100G_test()\n{\n\tRET=0\n\tlocal lc\n\tlocal type\n\tlocal state\n\tlocal nested_devlink_dev\n\n\tlc=$LC_SLOT\n\ttype=$LC_16X100G_TYPE\n\n\tunprovision_one $lc\n\tprovision_one $lc $type\n\tstate=$(lc_wait_until_state_becomes $lc \"active\" \\\n\t\t$ACTIVATION_TIMEOUT)\n\tcheck_err $? \"Failed to get linecard $lc activated (timeout)\"\n\n\tinterface_check\n\n\tnested_devlink_dev=$(lc_nested_devlink_dev_get $lc)\n\tcheck_err $? \"Failed to get nested devlink handle of linecard $lc\"\n\tlc_dev_info_active_check $lc $nested_devlink_dev\n\n\tlog_test \"Activation 16x100G\"\n}\n\nsetup_prepare()\n{\n\tlocal lc_num=$(devlink lc show -j | jq -e -r \".[][\\\"$DEVLINK_DEV\\\"] |length\")\n\tif [[ $? -ne 0 ]] || [[ $lc_num -eq 0 ]]; then\n\t\techo \"SKIP: No linecard support found\"\n\t\texit $ksft_skip\n\tfi\n\n\tif [ -z \"$LC_SLOT\" ]; then\n\t\techo \"SKIP: \\\"LC_SLOT\\\" variable not provided\"\n\t\texit $ksft_skip\n\tfi\n\n\t# Interfaces are not present during the script start,\n\t# that's why we define NUM_NETIFS here so dummy\n\t# implicit veth pairs are not created.\n\tNUM_NETIFS=2\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\tifaces_upped=false\n}\n\ncleanup()\n{\n\tif [ \"$ifaces_upped\" = true ] ; then\n\t\tip link set $h1 down\n\t\tip link set $h2 down\n\tfi\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}