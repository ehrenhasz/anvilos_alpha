{
  "module_name": "blackhole_routes.sh",
  "hash_id": "2b00bd1dead54a8e86b1f8e1c67f15b04d061ad72e3462efd616673499da1cc8",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/blackhole_routes.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test that blackhole routes are marked as offloaded and that packets hitting\n# them are dropped by the ASIC and not by the kernel.\n#\n# +---------------------------------+\n# | H1 (vrf)                        |\n# |    + $h1                        |\n# |    | 192.0.2.1/24               |\n# |    | 2001:db8:1::1/64           |\n# |    |                            |\n# |    |  default via 192.0.2.2     |\n# |    |  default via 2001:db8:1::2 |\n# +----|----------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# |    + $rp1                                                                 |\n# |        192.0.2.2/24                                                       |\n# |        2001:db8:1::2/64                                                   |\n# |                                                                           |\n# |        2001:db8:2::2/64                                                   |\n# |        198.51.100.2/24                                                    |\n# |    + $rp2                                                                 |\n# |    |                                                                      |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|----------------------------+\n# |    |  default via 198.51.100.2  |\n# |    |  default via 2001:db8:2::2 |\n# |    |                            |\n# |    | 2001:db8:2::1/64           |\n# |    | 198.51.100.1/24            |\n# |    + $h2                        |\n# | H2 (vrf)                        |\n# +---------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\tblackhole_ipv4\n\tblackhole_ipv6\n\"\nNUM_NETIFS=4\n: ${TIMEOUT:=20000} # ms\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24 2001:db8:1::1/64\n\n\tip -4 route add default vrf v$h1 nexthop via 192.0.2.2\n\tip -6 route add default vrf v$h1 nexthop via 2001:db8:1::2\n}\n\nh1_destroy()\n{\n\tip -6 route del default vrf v$h1 nexthop via 2001:db8:1::2\n\tip -4 route del default vrf v$h1 nexthop via 192.0.2.2\n\n\tsimple_if_fini $h1 192.0.2.1/24 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 198.51.100.1/24 2001:db8:2::1/64\n\n\tip -4 route add default vrf v$h2 nexthop via 198.51.100.2\n\tip -6 route add default vrf v$h2 nexthop via 2001:db8:2::2\n}\n\nh2_destroy()\n{\n\tip -6 route del default vrf v$h2 nexthop via 2001:db8:2::2\n\tip -4 route del default vrf v$h2 nexthop via 198.51.100.2\n\n\tsimple_if_fini $h2 198.51.100.1/24 2001:db8:2::1/64\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\n\ttc qdisc add dev $rp1 clsact\n\n\t__addr_add_del $rp1 add 192.0.2.2/24 2001:db8:1::2/64\n\t__addr_add_del $rp2 add 198.51.100.2/24 2001:db8:2::2/64\n}\n\nrouter_destroy()\n{\n\t__addr_add_del $rp2 del 198.51.100.2/24 2001:db8:2::2/64\n\t__addr_add_del $rp1 del 192.0.2.2/24 2001:db8:1::2/64\n\n\ttc qdisc del dev $rp1 clsact\n\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nping_ipv4()\n{\n\tping_test $h1 198.51.100.1 \": h1->h2\"\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::1 \": h1->h2\"\n}\n\nblackhole_ipv4()\n{\n\t# Transmit packets from H1 to H2 and make sure they are dropped by the\n\t# ASIC and not by the kernel\n\tRET=0\n\n\tip -4 route add blackhole 198.51.100.0/30\n\ttc filter add dev $rp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tskip_hw dst_ip 198.51.100.1 src_ip 192.0.2.1 ip_proto icmp \\\n\t\taction pass\n\n\tbusywait \"$TIMEOUT\" wait_for_offload ip -4 route show 198.51.100.0/30\n\tcheck_err $? \"route not marked as offloaded when should\"\n\n\tping_do $h1 198.51.100.1\n\tcheck_fail $? \"ping passed when should not\"\n\n\ttc_check_packets \"dev $rp1 ingress\" 101 0\n\tcheck_err $? \"packets trapped and not dropped by ASIC\"\n\n\tlog_test \"IPv4 blackhole route\"\n\n\ttc filter del dev $rp1 ingress protocol ip pref 1 handle 101 flower\n\tip -4 route del blackhole 198.51.100.0/30\n}\n\nblackhole_ipv6()\n{\n\tRET=0\n\n\tip -6 route add blackhole 2001:db8:2::/120\n\ttc filter add dev $rp1 ingress protocol ipv6 pref 1 handle 101 flower \\\n\t\tskip_hw dst_ip 2001:db8:2::1 src_ip 2001:db8:1::1 \\\n\t\tip_proto icmpv6 action pass\n\n\tbusywait \"$TIMEOUT\" wait_for_offload ip -6 route show 2001:db8:2::/120\n\tcheck_err $? \"route not marked as offloaded when should\"\n\n\tping6_do $h1 2001:db8:2::1\n\tcheck_fail $? \"ping passed when should not\"\n\n\ttc_check_packets \"dev $rp1 ingress\" 101 0\n\tcheck_err $? \"packets trapped and not dropped by ASIC\"\n\n\tlog_test \"IPv6 blackhole route\"\n\n\ttc filter del dev $rp1 ingress protocol ipv6 pref 1 handle 101 flower\n\tip -6 route del blackhole 2001:db8:2::/120\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\trouter_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\trouter_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}