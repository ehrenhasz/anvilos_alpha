{
  "module_name": "qos_ets_strict.sh",
  "hash_id": "dae7ba6aa80490c3f9719587d4d9306aebcba581b530d2c0a14497fc0f570f29",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/qos_ets_strict.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# A test for strict prioritization of traffic in the switch. Run two streams of\n# traffic, each through a different ingress port, one tagged with PCP of 1, the\n# other with PCP of 2. Both streams converge at one egress port, where they are\n# assigned TC of, respectively, 1 and 2, with strict priority configured between\n# them. In H3, we expect to see (almost) exclusively the high-priority traffic.\n#\n# Please see qos_mc_aware.sh for an explanation of why we use mausezahn and\n# counters instead of just running iperf3.\n#\n# +---------------------------+                 +-----------------------------+\n# | H1                        |                 |                          H2 |\n# |         $h1.111 +         |                 |         + $h2.222           |\n# |   192.0.2.33/28 |         |                 |         | 192.0.2.65/28     |\n# |   e-qos-map 0:1 |         |                 |         | e-qos-map 0:2     |\n# |                 |         |                 |         |                   |\n# |             $h1 +         |                 |         + $h2               |\n# +-----------------|---------+                 +---------|-------------------+\n#                   |                                     |\n# +-----------------|-------------------------------------|-------------------+\n# |           $swp1 +                                     + $swp2             |\n# |          >1Gbps |                                     | >1Gbps            |\n# | +---------------|-----------+              +----------|----------------+  |\n# | |     $swp1.111 +           |              |          + $swp2.222      |  |\n# | |                     BR111 |       SW     | BR222                     |  |\n# | |     $swp3.111 +           |              |          + $swp3.222      |  |\n# | +---------------|-----------+              +----------|----------------+  |\n# |                 \\_____________________________________/                   |\n# |                                    |                                      |\n# |                                    + $swp3                                |\n# |                                    | 1Gbps bottleneck                     |\n# |                                    | ETS: (up n->tc n for n in 0..7)      |\n# |                                    |      strict priority                 |\n# +------------------------------------|--------------------------------------+\n#                                      |\n#                 +--------------------|--------------------+\n#                 |                    + $h3             H3 |\n#                 |                   / \\                   |\n#                 |                  /   \\                  |\n#                 |         $h3.111 +     + $h3.222         |\n#                 |  192.0.2.34/28          192.0.2.66/28   |\n#                 +-----------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\ttest_ets_strict\n\"\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nNUM_NETIFS=6\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\nsource qos_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n\tmtu_set $h1 10000\n\n\tvlan_create $h1 111 v$h1 192.0.2.33/28\n\tip link set dev $h1.111 type vlan egress-qos-map 0:1\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 111\n\n\tmtu_restore $h1\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\tmtu_set $h2 10000\n\n\tvlan_create $h2 222 v$h2 192.0.2.65/28\n\tip link set dev $h2.222 type vlan egress-qos-map 0:2\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 222\n\n\tmtu_restore $h2\n\tsimple_if_fini $h2\n}\n\nh3_create()\n{\n\tsimple_if_init $h3\n\tmtu_set $h3 10000\n\n\tvlan_create $h3 111 v$h3 192.0.2.34/28\n\tvlan_create $h3 222 v$h3 192.0.2.66/28\n}\n\nh3_destroy()\n{\n\tvlan_destroy $h3 222\n\tvlan_destroy $h3 111\n\n\tmtu_restore $h3\n\tsimple_if_fini $h3\n}\n\nswitch_create()\n{\n\tip link set dev $swp1 up\n\tmtu_set $swp1 10000\n\n\tip link set dev $swp2 up\n\tmtu_set $swp2 10000\n\n\t# prio n -> TC n, strict scheduling\n\tlldptool -T -i $swp3 -V ETS-CFG up2tc=0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7\n\tlldptool -T -i $swp3 -V ETS-CFG tsa=$(\n\t\t\t)\"0:strict,\"$(\n\t\t\t)\"1:strict,\"$(\n\t\t\t)\"2:strict,\"$(\n\t\t\t)\"3:strict,\"$(\n\t\t\t)\"4:strict,\"$(\n\t\t\t)\"5:strict,\"$(\n\t\t\t)\"6:strict,\"$(\n\t\t\t)\"7:strict\"\n\tsleep 1\n\n\tip link set dev $swp3 up\n\tmtu_set $swp3 10000\n\ttc qdisc replace dev $swp3 root handle 101: tbf rate 1gbit \\\n\t\tburst 128K limit 1G\n\n\tvlan_create $swp1 111\n\tvlan_create $swp2 222\n\tvlan_create $swp3 111\n\tvlan_create $swp3 222\n\n\tip link add name br111 type bridge vlan_filtering 0\n\tip link set dev br111 addrgenmode none\n\tip link set dev br111 up\n\tip link set dev $swp1.111 master br111\n\tip link set dev $swp3.111 master br111\n\n\tip link add name br222 type bridge vlan_filtering 0\n\tip link set dev br222 addrgenmode none\n\tip link set dev br222 up\n\tip link set dev $swp2.222 master br222\n\tip link set dev $swp3.222 master br222\n\n\t# Make sure that ingress quotas are smaller than egress so that there is\n\t# room for both streams of traffic to be admitted to shared buffer.\n\tdevlink_pool_size_thtype_save 0\n\tdevlink_pool_size_thtype_set 0 dynamic 10000000\n\tdevlink_pool_size_thtype_save 4\n\tdevlink_pool_size_thtype_set 4 dynamic 10000000\n\n\tdevlink_port_pool_th_save $swp1 0\n\tdevlink_port_pool_th_set $swp1 0 6\n\tdevlink_tc_bind_pool_th_save $swp1 1 ingress\n\tdevlink_tc_bind_pool_th_set $swp1 1 ingress 0 6\n\n\tdevlink_port_pool_th_save $swp2 0\n\tdevlink_port_pool_th_set $swp2 0 6\n\tdevlink_tc_bind_pool_th_save $swp2 2 ingress\n\tdevlink_tc_bind_pool_th_set $swp2 2 ingress 0 6\n\n\tdevlink_tc_bind_pool_th_save $swp3 1 egress\n\tdevlink_tc_bind_pool_th_set $swp3 1 egress 4 7\n\tdevlink_tc_bind_pool_th_save $swp3 2 egress\n\tdevlink_tc_bind_pool_th_set $swp3 2 egress 4 7\n\tdevlink_port_pool_th_save $swp3 4\n\tdevlink_port_pool_th_set $swp3 4 7\n}\n\nswitch_destroy()\n{\n\tdevlink_port_pool_th_restore $swp3 4\n\tdevlink_tc_bind_pool_th_restore $swp3 2 egress\n\tdevlink_tc_bind_pool_th_restore $swp3 1 egress\n\n\tdevlink_tc_bind_pool_th_restore $swp2 2 ingress\n\tdevlink_port_pool_th_restore $swp2 0\n\n\tdevlink_tc_bind_pool_th_restore $swp1 1 ingress\n\tdevlink_port_pool_th_restore $swp1 0\n\n\tdevlink_pool_size_thtype_restore 4\n\tdevlink_pool_size_thtype_restore 0\n\n\tip link del dev br222\n\tip link del dev br111\n\n\tvlan_destroy $swp3 222\n\tvlan_destroy $swp3 111\n\tvlan_destroy $swp2 222\n\tvlan_destroy $swp1 111\n\n\ttc qdisc del dev $swp3 root handle 101:\n\tmtu_restore $swp3\n\tip link set dev $swp3 down\n\tlldptool -T -i $swp3 -V ETS-CFG up2tc=0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0\n\n\tmtu_restore $swp2\n\tip link set dev $swp2 down\n\n\tmtu_restore $swp1\n\tip link set dev $swp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\th3mac=$(mac_get $h3)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\th3_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th3_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.34 \" from H1\"\n\tping_test $h2 192.0.2.66 \" from H2\"\n}\n\nrel()\n{\n\tlocal old=$1; shift\n\tlocal new=$1; shift\n\n\tbc <<< \"\n\t    scale=2\n\t    ret = 100 * $new / $old\n\t    if (ret > 0) { ret } else { 0 }\n\t\"\n}\n\ntest_ets_strict()\n{\n\tRET=0\n\n\t# Run high-prio traffic on its own.\n\tstart_traffic $h2.222 192.0.2.65 192.0.2.66 $h3mac\n\tlocal -a rate_2\n\trate_2=($(measure_rate $swp2 $h3 rx_octets_prio_2 \"prio 2\"))\n\tcheck_err $? \"Could not get high enough prio-2 ingress rate\"\n\tlocal rate_2_in=${rate_2[0]}\n\tlocal rate_2_eg=${rate_2[1]}\n\tstop_traffic # $h2.222\n\n\t# Start low-prio stream.\n\tstart_traffic $h1.111 192.0.2.33 192.0.2.34 $h3mac\n\n\tlocal -a rate_1\n\trate_1=($(measure_rate $swp1 $h3 rx_octets_prio_1 \"prio 1\"))\n\tcheck_err $? \"Could not get high enough prio-1 ingress rate\"\n\tlocal rate_1_in=${rate_1[0]}\n\tlocal rate_1_eg=${rate_1[1]}\n\n\t# High-prio and low-prio on their own should have about the same\n\t# throughput.\n\tlocal rel21=$(rel $rate_1_eg $rate_2_eg)\n\tcheck_err $(bc <<< \"$rel21 < 95\")\n\tcheck_err $(bc <<< \"$rel21 > 105\")\n\n\t# Start the high-prio stream--now both streams run.\n\tstart_traffic $h2.222 192.0.2.65 192.0.2.66 $h3mac\n\trate_3=($(measure_rate $swp2 $h3 rx_octets_prio_2 \"prio 2 w/ 1\"))\n\tcheck_err $? \"Could not get high enough prio-2 ingress rate with prio-1\"\n\tlocal rate_3_in=${rate_3[0]}\n\tlocal rate_3_eg=${rate_3[1]}\n\tstop_traffic # $h2.222\n\n\tstop_traffic # $h1.111\n\n\t# High-prio should have about the same throughput whether or not\n\t# low-prio is in the system.\n\tlocal rel32=$(rel $rate_2_eg $rate_3_eg)\n\tcheck_err $(bc <<< \"$rel32 < 95\")\n\n\tlog_test \"strict priority\"\n\techo \"Ingress to switch:\"\n\techo \"  p1 in rate            $(humanize $rate_1_in)\"\n\techo \"  p2 in rate            $(humanize $rate_2_in)\"\n\techo \"  p2 in rate w/ p1      $(humanize $rate_3_in)\"\n\techo \"Egress from switch:\"\n\techo \"  p1 eg rate            $(humanize $rate_1_eg)\"\n\techo \"  p2 eg rate            $(humanize $rate_2_eg) ($rel21% of p1)\"\n\techo \"  p2 eg rate w/ p1      $(humanize $rate_3_eg) ($rel32% of p2)\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}