{
  "module_name": "qos_max_descriptors.sh",
  "hash_id": "d39e403894ef49bf4fbc0a50d4aee8241ed0375703d890dac1e06e48f90760de",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/qos_max_descriptors.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test sends many small packets (size is less than cell size) through the\n# switch. A shaper is used in $swp2, so the traffic is limited there. Packets\n# are queued till they will be sent.\n#\n# The idea is to verify that the switch can handle at least 85% of maximum\n# supported descrpitors by hardware. Then, we verify that the driver configures\n# firmware to allow infinite size of egress descriptor pool, and does not use a\n# lower limitation. Increase the size of the relevant pools such that the pool's\n# size does not limit the traffic.\n\n# +-----------------------+\n# | H1                    |\n# |   + $h1.111           |\n# |   | 192.0.2.33/28     |\n# |   |                   |\n# |   + $h1               |\n# +---|-------------------+\n#     |\n# +---|-----------------------------+\n# |   + $swp1                       |\n# |   | iPOOL1                      |\n# |   |                             |\n# | +-|------------------------+    |\n# | | + $swp1.111              |    |\n# | |                          |    |\n# | | BR1                      |    |\n# | |                          |    |\n# | | + $swp2.111              |    |\n# | +-|------------------------+    |\n# |   |                             |\n# |   + $swp2                       |\n# |   | ePOOL6                      |\n# |   | 1mbit                       |\n# +---+-----------------------------+\n#     |\n# +---|-------------------+\n# |   + $h2            H2 |\n# |   |                   |\n# |   + $h2.111           |\n# |     192.0.2.34/28     |\n# +-----------------------+\n#\n\nALL_TESTS=\"\n\tping_ipv4\n\tmax_descriptors\n\"\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\nsource mlxsw_lib.sh\n\nMAX_POOL_SIZE=$(devlink_pool_size_get)\nSHAPER_RATE=1mbit\n\n# The current TBF qdisc interface does not allow us to configure the shaper to\n# flat zero. The ASIC shaper is guaranteed to work with a granularity of\n# 200Mbps. On Spectrum-2, writing a value close to zero instead of zero works\n# well, but the performance on Spectrum-1 is unpredictable. Thus, do not run the\n# test on Spectrum-1.\nmlxsw_only_on_spectrum 2+ || exit\n\nh1_create()\n{\n\tsimple_if_init $h1\n\n\tvlan_create $h1 111 v$h1 192.0.2.33/28\n\tip link set dev $h1.111 type vlan egress-qos-map 0:1\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 111\n\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\n\tvlan_create $h2 111 v$h2 192.0.2.34/28\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 111\n\n\tsimple_if_fini $h2\n}\n\nswitch_create()\n{\n\t# pools\n\t# -----\n\n\tdevlink_pool_size_thtype_save 1\n\tdevlink_pool_size_thtype_save 6\n\n\tdevlink_port_pool_th_save $swp1 1\n\tdevlink_port_pool_th_save $swp2 6\n\n\tdevlink_tc_bind_pool_th_save $swp1 1 ingress\n\tdevlink_tc_bind_pool_th_save $swp2 1 egress\n\n\tdevlink_pool_size_thtype_set 1 dynamic $MAX_POOL_SIZE\n\tdevlink_pool_size_thtype_set 6 static $MAX_POOL_SIZE\n\n\t# $swp1\n\t# -----\n\n\tip link set dev $swp1 up\n\tvlan_create $swp1 111\n\tip link set dev $swp1.111 type vlan ingress-qos-map 0:0 1:1\n\n\tdevlink_port_pool_th_set $swp1 1 16\n\tdevlink_tc_bind_pool_th_set $swp1 1 ingress 1 16\n\n\ttc qdisc replace dev $swp1 root handle 1: \\\n\t   ets bands 8 strict 8 priomap 7 6\n\tdcb buffer set dev $swp1 prio-buffer all:0 1:1\n\n\t# $swp2\n\t# -----\n\n\tip link set dev $swp2 up\n\tvlan_create $swp2 111\n\tip link set dev $swp2.111 type vlan egress-qos-map 0:0 1:1\n\n\tdevlink_port_pool_th_set $swp2 6 $MAX_POOL_SIZE\n\tdevlink_tc_bind_pool_th_set $swp2 1 egress 6 $MAX_POOL_SIZE\n\n\ttc qdisc replace dev $swp2 root handle 1: tbf rate $SHAPER_RATE \\\n\t\tburst 128K limit 500M\n\ttc qdisc replace dev $swp2 parent 1:1 handle 11: \\\n\t\tets bands 8 strict 8 priomap 7 6\n\n\t# bridge\n\t# ------\n\n\tip link add name br1 type bridge vlan_filtering 0\n\tip link set dev $swp1.111 master br1\n\tip link set dev br1 up\n\n\tip link set dev $swp2.111 master br1\n}\n\nswitch_destroy()\n{\n\t# Do this first so that we can reset the limits to values that are only\n\t# valid for the original static / dynamic setting.\n\tdevlink_pool_size_thtype_restore 6\n\tdevlink_pool_size_thtype_restore 1\n\n\t# bridge\n\t# ------\n\n\tip link set dev $swp2.111 nomaster\n\n\tip link set dev br1 down\n\tip link set dev $swp1.111 nomaster\n\tip link del dev br1\n\n\t# $swp2\n\t# -----\n\n\ttc qdisc del dev $swp2 parent 1:1 handle 11:\n\ttc qdisc del dev $swp2 root\n\n\tdevlink_tc_bind_pool_th_restore $swp2 1 egress\n\tdevlink_port_pool_th_restore $swp2 6\n\n\tvlan_destroy $swp2 111\n\tip link set dev $swp2 down\n\n\t# $swp1\n\t# -----\n\n\tdcb buffer set dev $swp1 prio-buffer all:0\n\ttc qdisc del dev $swp1 root\n\n\tdevlink_tc_bind_pool_th_restore $swp1 1 ingress\n\tdevlink_port_pool_th_restore $swp1 1\n\n\tvlan_destroy $swp1 111\n\tip link set dev $swp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.34 \" h1->h2\"\n}\n\npercentage_used()\n{\n\tlocal num_packets=$1; shift\n\tlocal max_packets=$1; shift\n\n\tbc <<< \"\n\t    scale=2\n\t    100 * $num_packets / $max_packets\n\t\"\n}\n\nmax_descriptors()\n{\n\tlocal cell_size=$(devlink_cell_size_get)\n\tlocal exp_perc_used=85\n\tlocal max_descriptors\n\tlocal pktsize=30\n\n\tRET=0\n\n\tmax_descriptors=$(mlxsw_max_descriptors_get) || exit 1\n\n\tlocal d0=$(ethtool_stats_get $swp2 tc_no_buffer_discard_uc_tc_1)\n\n\tlog_info \"Send many small packets, packet size = $pktsize bytes\"\n\tstart_traffic_pktsize $pktsize $h1.111 192.0.2.33 192.0.2.34 $h2mac\n\n\t# Sleep to wait for congestion.\n\tsleep 5\n\n\tlocal d1=$(ethtool_stats_get $swp2 tc_no_buffer_discard_uc_tc_1)\n\t((d1 == d0))\n\tcheck_err $? \"Drops seen on egress port: $d0 -> $d1 ($((d1 - d0)))\"\n\n\t# Check how many packets the switch can handle, the limitation is\n\t# maximum descriptors.\n\tlocal pkts_bytes=$(ethtool_stats_get $swp2 tc_transmit_queue_tc_1)\n\tlocal pkts_num=$((pkts_bytes / cell_size))\n\tlocal perc_used=$(percentage_used $pkts_num $max_descriptors)\n\n\tcheck_err $(bc <<< \"$perc_used < $exp_perc_used\") \\\n\t\t\"Expected > $exp_perc_used% of descriptors, handle $perc_used%\"\n\n\tstop_traffic\n\tsleep 1\n\n\tlog_test \"Maximum descriptors usage. The percentage used is $perc_used%\"\n}\n\ntrap cleanup EXIT\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}