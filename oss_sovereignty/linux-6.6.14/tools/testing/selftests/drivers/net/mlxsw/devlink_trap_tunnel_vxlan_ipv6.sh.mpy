{
  "module_name": "devlink_trap_tunnel_vxlan_ipv6.sh",
  "hash_id": "34425072afed8f05502bc06d523cf956ae7352acdf75b46c6ee68639e91ae28d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/devlink_trap_tunnel_vxlan_ipv6.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test devlink-trap tunnel drops and exceptions functionality over mlxsw.\n# Check all traps to make sure they are triggered under the right\n# conditions.\n\n# +------------------------+\n# | H1 (vrf)               |\n# |    + $h1               |\n# |    | 2001:db8:1::1/64  |\n# +----|-------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# | +--|--------------------------------------------------------------------+ |\n# | |  + $swp1                   BR1 (802.1d)                               | |\n# | |                                                                       | |\n# | |  + vx1 (vxlan)                                                        | |\n# | |    local 2001:db8:3::1                                                | |\n# | |    id 1000 dstport $VXPORT                                            | |\n# | +-----------------------------------------------------------------------+ |\n# |                                                                           |\n# |    + $rp1                                                                 |\n# |    | 2001:db8:3::1/64                                                     |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                                             VRF2       |\n# |    + $rp2                                                   |\n# |      2001:db8:3::2/64                                       |\n# |                                                             |\n# +-------------------------------------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tdecap_error_test\n\toverlay_smac_is_mc_test\n\"\n\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\nsource $lib_dir/tc_common.sh\nsource $lib_dir/devlink_lib.sh\n\n: ${VXPORT:=4789}\nexport VXPORT\n\nh1_create()\n{\n\tsimple_if_init $h1 2001:db8:1::1/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 2001:db8:1::1/64\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 0 mcast_snooping 0\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\ttc qdisc add dev $swp1 clsact\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\n\tip link add name vx1 type vxlan id 1000 local 2001:db8:3::1 \\\n\t\tdstport \"$VXPORT\" nolearning udp6zerocsumrx udp6zerocsumtx \\\n\t\ttos inherit ttl 100\n\tip link set dev vx1 master br1\n\tip link set dev vx1 up\n\n\tip link set dev $rp1 up\n\tip address add dev $rp1 2001:db8:3::1/64\n}\n\nswitch_destroy()\n{\n\tip address del dev $rp1 2001:db8:3::1/64\n\tip link set dev $rp1 down\n\n\tip link set dev vx1 down\n\tip link set dev vx1 nomaster\n\tip link del dev vx1\n\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nvrf2_create()\n{\n\tsimple_if_init $rp2 2001:db8:3::2/64\n}\n\nvrf2_destroy()\n{\n\tsimple_if_fini $rp2 2001:db8:3::2/64\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\trp1=${NETIFS[p3]}\n\trp2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\th1_create\n\tswitch_create\n\tvrf2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tvrf2_destroy\n\tswitch_destroy\n\th1_destroy\n\tforwarding_restore\n\tvrf_cleanup\n}\n\necn_payload_get()\n{\n\tlocal dest_mac=$(mac_get $h1)\n\tlocal saddr=\"20:01:0d:b8:00:01:00:00:00:00:00:00:00:00:00:03\"\n\tlocal daddr=\"20:01:0d:b8:00:01:00:00:00:00:00:00:00:00:00:01\"\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"00:00:00:00:00:00:\"$(       : ETH saddr\n\t\t)\"86:dd:\"$(                   : ETH type\n\t\t)\"6\"$(                        : IP version\n\t\t)\"0:0\"$(\t\t      : Traffic class\n\t\t)\"0:00:00:\"$(                 : Flow label\n\t\t)\"00:08:\"$(                   : Payload length\n\t\t)\"3a:\"$(                      : Next header\n\t\t)\"04:\"$(                      : Hop limit\n\t\t)\"$saddr:\"$(                  : IP saddr\n\t\t)\"$daddr:\"$(\t\t      : IP daddr\n\t\t)\"80:\"$(                      : ICMPv6.type\n\t\t)\"00:\"$(                      : ICMPv6.code\n\t\t)\"00:\"$(                      : ICMPv6.checksum\n\t\t)\n\techo $p\n}\n\necn_decap_test()\n{\n\tlocal trap_name=\"decap_error\"\n\tlocal desc=$1; shift\n\tlocal ecn_desc=$1; shift\n\tlocal outer_tos=$1; shift\n\tlocal mz_pid\n\n\tRET=0\n\n\ttc filter add dev $swp1 egress protocol ipv6 pref 1 handle 101 \\\n\t\tflower src_ip 2001:db8:1::3 dst_ip 2001:db8:1::1 action pass\n\n\trp1_mac=$(mac_get $rp1)\n\tpayload=$(ecn_payload_get)\n\n\tip vrf exec v$rp2 $MZ -6 $rp2 -c 0 -d 1msec -b $rp1_mac \\\n\t\t-B 2001:db8:3::1 -t udp \\\n\t\tsp=12345,dp=$VXPORT,tos=$outer_tos,p=$payload -q &\n\tmz_pid=$!\n\n\tdevlink_trap_exception_test $trap_name\n\n\ttc_check_packets \"dev $swp1 egress\" 101 0\n\tcheck_err $? \"Packets were not dropped\"\n\n\tlog_test \"$desc: Inner ECN is not ECT and outer is $ecn_desc\"\n\n\tkill $mz_pid && wait $mz_pid &> /dev/null\n\ttc filter del dev $swp1 egress protocol ipv6 pref 1 handle 101 flower\n}\n\nreserved_bits_payload_get()\n{\n\tlocal dest_mac=$(mac_get $h1)\n\tlocal saddr=\"20:01:0d:b8:00:01:00:00:00:00:00:00:00:00:00:03\"\n\tlocal daddr=\"20:01:0d:b8:00:01:00:00:00:00:00:00:00:00:00:01\"\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"01:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"00:00:00:00:00:00:\"$(       : ETH saddr\n\t\t)\"86:dd:\"$(                   : ETH type\n\t\t)\"6\"$(                        : IP version\n\t\t)\"0:0\"$(\t\t      : Traffic class\n\t\t)\"0:00:00:\"$(                 : Flow label\n\t\t)\"00:08:\"$(                   : Payload length\n\t\t)\"3a:\"$(                      : Next header\n\t\t)\"04:\"$(                      : Hop limit\n\t\t)\"$saddr:\"$(                  : IP saddr\n\t\t)\"$daddr:\"$(\t\t      : IP daddr\n\t\t)\"80:\"$(                      : ICMPv6.type\n\t\t)\"00:\"$(                      : ICMPv6.code\n\t\t)\"00:\"$(                      : ICMPv6.checksum\n\t\t)\n\techo $p\n}\n\nshort_payload_get()\n{\n        dest_mac=$(mac_get $h1)\n        p=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"00:00:00:00:00:00:\"$(       : ETH saddr\n\t\t)\n        echo $p\n}\n\ncorrupted_packet_test()\n{\n\tlocal trap_name=\"decap_error\"\n\tlocal desc=$1; shift\n\tlocal payload_get=$1; shift\n\tlocal mz_pid\n\n\tRET=0\n\n\t# In case of too short packet, there is no any inner packet,\n\t# so the matching will always succeed\n\ttc filter add dev $swp1 egress protocol ipv6 pref 1 handle 101 \\\n\t\tflower skip_hw src_ip 2001:db8:3::1 dst_ip 2001:db8:1::1 \\\n\t\taction pass\n\n\trp1_mac=$(mac_get $rp1)\n\tpayload=$($payload_get)\n\tip vrf exec v$rp2 $MZ -6 $rp2 -c 0 -d 1msec -b $rp1_mac \\\n\t\t-B 2001:db8:3::1 -t udp sp=12345,dp=$VXPORT,p=$payload -q &\n\tmz_pid=$!\n\n\tdevlink_trap_exception_test $trap_name\n\n\ttc_check_packets \"dev $swp1 egress\" 101 0\n\tcheck_err $? \"Packets were not dropped\"\n\n\tlog_test \"$desc\"\n\n\tkill $mz_pid && wait $mz_pid &> /dev/null\n\ttc filter del dev $swp1 egress protocol ipv6 pref 1 handle 101 flower\n}\n\ndecap_error_test()\n{\n\tecn_decap_test \"Decap error\" \"ECT(1)\" 01\n\tecn_decap_test \"Decap error\" \"ECT(0)\" 02\n\tecn_decap_test \"Decap error\" \"CE\" 03\n\n\tcorrupted_packet_test \"Decap error: Reserved bits in use\" \\\n\t\t\"reserved_bits_payload_get\"\n\tcorrupted_packet_test \"Decap error: Too short inner packet\" \\\n\t\t\"short_payload_get\"\n}\n\nmc_smac_payload_get()\n{\n\tlocal dest_mac=$(mac_get $h1)\n\tlocal source_mac=\"01:02:03:04:05:06\"\n\tlocal saddr=\"20:01:0d:b8:00:01:00:00:00:00:00:00:00:00:00:03\"\n\tlocal daddr=\"20:01:0d:b8:00:01:00:00:00:00:00:00:00:00:00:01\"\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"$source_mac:\"$(\t      : ETH saddr\n\t\t)\"86:dd:\"$(                   : ETH type\n\t\t)\"6\"$(                        : IP version\n\t\t)\"0:0\"$(\t\t      : Traffic class\n\t\t)\"0:00:00:\"$(                 : Flow label\n\t\t)\"00:08:\"$(                   : Payload length\n\t\t)\"3a:\"$(                      : Next header\n\t\t)\"04:\"$(                      : Hop limit\n\t\t)\"$saddr:\"$(                  : IP saddr\n\t\t)\"$daddr:\"$(\t\t      : IP daddr\n\t\t)\"80:\"$(                      : ICMPv6.type\n\t\t)\"00:\"$(                      : ICMPv6.code\n\t\t)\"00:\"$(                      : ICMPv6.checksum\n\t\t)\n\techo $p\n}\n\noverlay_smac_is_mc_test()\n{\n\tlocal trap_name=\"overlay_smac_is_mc\"\n\tlocal mz_pid\n\n\tRET=0\n\n\t# The matching will be checked on devlink_trap_drop_test()\n\t# and the filter will be removed on devlink_trap_drop_cleanup()\n\ttc filter add dev $swp1 egress protocol ipv6 pref 1 handle 101 \\\n\t\tflower src_mac 01:02:03:04:05:06 action pass\n\n\trp1_mac=$(mac_get $rp1)\n\tpayload=$(mc_smac_payload_get)\n\n\tip vrf exec v$rp2 $MZ -6 $rp2 -c 0 -d 1msec -b $rp1_mac \\\n\t\t-B 2001:db8:3::1 -t udp sp=12345,dp=$VXPORT,p=$payload -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp1 101\n\n\tlog_test \"Overlay source MAC is multicast\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp1 \"ipv6\" 1 101\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}