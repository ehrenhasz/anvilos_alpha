{
  "module_name": "qos_defprio.sh",
  "hash_id": "26f38e03b73d4e091c2878787b79642140eb15d94c3150810cbd9cd44aef844f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/qos_defprio.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test for port-default priority. Non-IP packets ingress $swp1 and are\n# prioritized according to the default priority specified at the port.\n# rx_octets_prio_* counters are used to verify the prioritization.\n#\n# +----------------------------------+\n# | H1                               |\n# |    + $h1                         |\n# |    | 192.0.2.1/28                |\n# +----|-----------------------------+\n#      |\n# +----|-----------------------------+\n# | SW |                             |\n# |    + $swp1                       |\n# |      192.0.2.2/28                |\n# |      dcb app default-prio <prio> |\n# +----------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\ttest_defprio\n\"\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nNUM_NETIFS=2\n: ${HIT_TIMEOUT:=1000} # ms\nsource $lib_dir/lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nswitch_create()\n{\n\tip link set dev $swp1 up\n\tip addr add dev $swp1 192.0.2.2/28\n}\n\nswitch_destroy()\n{\n\tdcb app flush dev $swp1 default-prio\n\tip addr del dev $swp1 192.0.2.2/28\n\tip link set dev $swp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tvrf_prepare\n\n\th1_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2\n}\n\n__test_defprio()\n{\n\tlocal prio_install=$1; shift\n\tlocal prio_observe=$1; shift\n\tlocal key\n\tlocal t1\n\tlocal i\n\n\tRET=0\n\n\tdcb app add dev $swp1 default-prio $prio_install\n\n\tlocal t0=$(ethtool_stats_get $swp1 rx_frames_prio_$prio_observe)\n\tmausezahn -q $h1 -d 100m -c 10 -t arp reply\n\tt1=$(busywait \"$HIT_TIMEOUT\" until_counter_is \">= $((t0 + 10))\" \\\n\t\tethtool_stats_get $swp1 rx_frames_prio_$prio_observe)\n\n\tcheck_err $? \"Default priority $prio_install/$prio_observe: Expected to capture 10 packets, got $((t1 - t0)).\"\n\tlog_test \"Default priority $prio_install/$prio_observe\"\n\n\tdcb app del dev $swp1 default-prio $prio_install\n}\n\ntest_defprio()\n{\n\tlocal prio\n\n\tfor prio in {0..7}; do\n\t\t__test_defprio $prio $prio\n\tdone\n\n\tdcb app add dev $swp1 default-prio 3\n\t__test_defprio 0 3\n\t__test_defprio 1 3\n\t__test_defprio 2 3\n\t__test_defprio 4 4\n\t__test_defprio 5 5\n\t__test_defprio 6 6\n\t__test_defprio 7 7\n\tdcb app del dev $swp1 default-prio 3\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}