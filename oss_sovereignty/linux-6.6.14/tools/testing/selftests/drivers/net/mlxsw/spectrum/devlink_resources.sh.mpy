{
  "module_name": "devlink_resources.sh",
  "hash_id": "5bc9632f83cd76cc995af85ec5b0286e2e45e2bf2914c3e4162dae4e19ed5697",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/spectrum/devlink_resources.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../../net/forwarding\n\nNUM_NETIFS=1\nsource $lib_dir/lib.sh\nsource devlink_lib_spectrum.sh\n\nsetup_prepare()\n{\n\tdevlink_sp_read_kvd_defaults\n}\n\ncleanup()\n{\n\tpre_cleanup\n\tdevlink_sp_size_kvd_to_default\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\n\nprofiles_test()\n{\n\tlocal i\n\n\tlog_info \"Running profile tests\"\n\n\tfor i in $KVD_PROFILES; do\n\t\tRET=0\n\t\tdevlink_sp_resource_kvd_profile_set $i\n\t\tlog_test \"'$i' profile\"\n\tdone\n\n\t# Default is explicitly tested at end to ensure it's actually applied\n\tRET=0\n\tdevlink_sp_resource_kvd_profile_set \"default\"\n\tlog_test \"'default' profile\"\n}\n\nresources_min_test()\n{\n\tlocal size\n\tlocal i\n\tlocal j\n\n\tlog_info \"Running KVD-minimum tests\"\n\n\tfor i in $KVD_CHILDREN; do\n\t\tRET=0\n\t\tsize=$(devlink_resource_get kvd \"$i\" | jq '.[\"size_min\"]')\n\t\tdevlink_resource_size_set \"$size\" kvd \"$i\"\n\n\t\t# In case of linear, need to minimize sub-resources as well\n\t\tif [[ \"$i\" == \"linear\" ]]; then\n\t\t\tfor j in $KVDL_CHILDREN; do\n\t\t\t\tdevlink_resource_size_set 0 kvd linear \"$j\"\n\t\t\tdone\n\t\tfi\n\n\t\tdevlink_reload\n\t\tdevlink_sp_size_kvd_to_default\n\t\tlog_test \"'$i' minimize [$size]\"\n\tdone\n}\n\nresources_max_test()\n{\n\tlocal min_size\n\tlocal size\n\tlocal i\n\tlocal j\n\n\tlog_info \"Running KVD-maximum tests\"\n\tfor i in $KVD_CHILDREN; do\n\t\tRET=0\n\t\tdevlink_sp_resource_minimize\n\n\t\t# Calculate the maximum possible size for the given partition\n\t\tsize=$(devlink_resource_size_get kvd)\n\t\tfor j in $KVD_CHILDREN; do\n\t\t\tif [ \"$i\" != \"$j\" ]; then\n\t\t\t\tmin_size=$(devlink_resource_get kvd \"$j\" | \\\n\t\t\t\t\t   jq '.[\"size_min\"]')\n\t\t\t\tsize=$((size - min_size))\n\t\t\tfi\n\t\tdone\n\n\t\t# Test almost maximum size\n\t\tdevlink_resource_size_set \"$((size - 128))\" kvd \"$i\"\n\t\tdevlink_reload\n\t\tlog_test \"'$i' almost maximize [$((size - 128))]\"\n\n\t\t# Test above maximum size\n\t\tdevlink resource set \"$DEVLINK_DEV\" \\\n\t\t\tpath \"kvd/$i\" size $((size + 128)) &> /dev/null\n\t\tcheck_fail $? \"Set kvd/$i to size $((size + 128)) should fail\"\n\t\tlog_test \"'$i' Overflow rejection [$((size + 128))]\"\n\n\t\t# Test maximum size\n\t\tif [ \"$i\" == \"hash_single\" ] || [ \"$i\" == \"hash_double\" ]; then\n\t\t\techo \"SKIP: Observed problem with exact max $i\"\n\t\t\tcontinue\n\t\tfi\n\n\t\tdevlink_resource_size_set \"$size\" kvd \"$i\"\n\t\tdevlink_reload\n\t\tlog_test \"'$i' maximize [$size]\"\n\n\t\tdevlink_sp_size_kvd_to_default\n\tdone\n}\n\nprofiles_test\nresources_min_test\nresources_max_test\n\nexit \"$RET\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}