{
  "module_name": "port_range_occ.sh",
  "hash_id": "85e0b3255313e28e1e15ee1a131a85a78191493c211963517305bfdbb659e03f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/port_range_occ.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test that filters that match on the same port range, but with different\n# combination of IPv4/IPv6 and TCP/UDP all use the same port range register by\n# observing port range registers' occupancy via devlink-resource.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tport_range_occ_test\n\"\nNUM_NETIFS=2\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1\n}\n\nswitch_create()\n{\n\tsimple_if_init $swp1\n\ttc qdisc add dev $swp1 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp1 clsact\n\tsimple_if_fini $swp1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tvrf_prepare\n\n\th1_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nport_range_occ_get()\n{\n\tdevlink_resource_occ_get port_range_registers\n}\n\nport_range_occ_test()\n{\n\tRET=0\n\n\tlocal occ=$(port_range_occ_get)\n\n\t# Two port range registers are used, for source and destination port\n\t# ranges.\n\ttc filter add dev $swp1 ingress pref 1 handle 101 proto ip \\\n\t\tflower skip_sw ip_proto udp src_port 1-100 dst_port 1-100 \\\n\t\taction pass\n\t(( occ + 2 == $(port_range_occ_get) ))\n\tcheck_err $? \"Got occupancy $(port_range_occ_get), expected $((occ + 2))\"\n\n\ttc filter add dev $swp1 ingress pref 1 handle 102 proto ip \\\n\t\tflower skip_sw ip_proto tcp src_port 1-100 dst_port 1-100 \\\n\t\taction pass\n\ttc filter add dev $swp1 ingress pref 2 handle 103 proto ipv6 \\\n\t\tflower skip_sw ip_proto udp src_port 1-100 dst_port 1-100 \\\n\t\taction pass\n\ttc filter add dev $swp1 ingress pref 2 handle 104 proto ipv6 \\\n\t\tflower skip_sw ip_proto tcp src_port 1-100 dst_port 1-100 \\\n\t\taction pass\n\t(( occ + 2 == $(port_range_occ_get) ))\n\tcheck_err $? \"Got occupancy $(port_range_occ_get), expected $((occ + 2))\"\n\n\ttc filter del dev $swp1 ingress pref 2 handle 104 flower\n\ttc filter del dev $swp1 ingress pref 2 handle 103 flower\n\ttc filter del dev $swp1 ingress pref 1 handle 102 flower\n\t(( occ + 2 == $(port_range_occ_get) ))\n\tcheck_err $? \"Got occupancy $(port_range_occ_get), expected $((occ + 2))\"\n\n\ttc filter del dev $swp1 ingress pref 1 handle 101 flower\n\t(( occ == $(port_range_occ_get) ))\n\tcheck_err $? \"Got occupancy $(port_range_occ_get), expected $occ\"\n\n\tlog_test \"port range occupancy\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}