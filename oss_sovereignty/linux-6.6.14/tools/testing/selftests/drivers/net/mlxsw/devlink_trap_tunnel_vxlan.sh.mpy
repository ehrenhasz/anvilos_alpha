{
  "module_name": "devlink_trap_tunnel_vxlan.sh",
  "hash_id": "c175ba8932603214dbc344b16741aa4446f47cd2059275e76dd147c895859c90",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/devlink_trap_tunnel_vxlan.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test devlink-trap tunnel drops and exceptions functionality over mlxsw.\n# Check all traps to make sure they are triggered under the right\n# conditions.\n\n# +--------------------+\n# | H1 (vrf)           |\n# |    + $h1           |\n# |    | 192.0.2.1/28  |\n# +----|---------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# | +--|--------------------------------------------------------------------+ |\n# | |  + $swp1                   BR1 (802.1d)                               | |\n# | |                                                                       | |\n# | |  + vx1 (vxlan)                                                        | |\n# | |    local 192.0.2.17                                                   | |\n# | |    id 1000 dstport $VXPORT                                            | |\n# | +-----------------------------------------------------------------------+ |\n# |                                                                           |\n# |    + $rp1                                                                 |\n# |    | 192.0.2.17/28                                                        |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                                             VRF2       |\n# |    + $rp2                                                   |\n# |      192.0.2.18/28                                          |\n# |                                                             |\n# +-------------------------------------------------------------+\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tdecap_error_test\n\toverlay_smac_is_mc_test\n\"\n\nNUM_NETIFS=4\nsource $lib_dir/lib.sh\nsource $lib_dir/tc_common.sh\nsource $lib_dir/devlink_lib.sh\n\n: ${VXPORT:=4789}\nexport VXPORT\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 0 mcast_snooping 0\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\ttc qdisc add dev $swp1 clsact\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\n\tip link add name vx1 type vxlan id 1000 local 192.0.2.17 \\\n\t\tdstport \"$VXPORT\" nolearning noudpcsum tos inherit ttl 100\n\tip link set dev vx1 master br1\n\tip link set dev vx1 up\n\n\tip address add dev $rp1 192.0.2.17/28\n\tip link set dev $rp1 up\n}\n\nswitch_destroy()\n{\n\tip link set dev $rp1 down\n\tip address del dev $rp1 192.0.2.17/28\n\n\tip link set dev vx1 down\n\tip link set dev vx1 nomaster\n\tip link del dev vx1\n\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nvrf2_create()\n{\n\tsimple_if_init $rp2 192.0.2.18/28\n}\n\nvrf2_destroy()\n{\n\tsimple_if_fini $rp2 192.0.2.18/28\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\trp1=${NETIFS[p3]}\n\trp2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\th1_create\n\tswitch_create\n\tvrf2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tvrf2_destroy\n\tswitch_destroy\n\th1_destroy\n\tforwarding_restore\n\tvrf_cleanup\n}\n\necn_payload_get()\n{\n\tdest_mac=$(mac_get $h1)\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"00:00:00:00:00:00:\"$(       : ETH saddr\n\t\t)\"08:00:\"$(                   : ETH type\n\t\t)\"45:\"$(                      : IP version + IHL\n\t\t)\"00:\"$(                      : IP TOS\n\t\t)\"00:14:\"$(                   : IP total length\n\t\t)\"00:00:\"$(                   : IP identification\n\t\t)\"20:00:\"$(                   : IP flags + frag off\n\t\t)\"40:\"$(                      : IP TTL\n\t\t)\"00:\"$(                      : IP proto\n\t\t)\"D6:E5:\"$(                   : IP header csum\n\t\t)\"c0:00:02:03:\"$(             : IP saddr: 192.0.2.3\n\t\t)\"c0:00:02:01:\"$(             : IP daddr: 192.0.2.1\n\t\t)\n\techo $p\n}\n\necn_decap_test()\n{\n\tlocal trap_name=\"decap_error\"\n\tlocal desc=$1; shift\n\tlocal ecn_desc=$1; shift\n\tlocal outer_tos=$1; shift\n\tlocal mz_pid\n\n\tRET=0\n\n\ttc filter add dev $swp1 egress protocol ip pref 1 handle 101 \\\n\t\tflower src_ip 192.0.2.3 dst_ip 192.0.2.1 action pass\n\n\trp1_mac=$(mac_get $rp1)\n\tpayload=$(ecn_payload_get)\n\n\tip vrf exec v$rp2 $MZ $rp2 -c 0 -d 1msec -b $rp1_mac -B 192.0.2.17 \\\n\t\t-t udp sp=12345,dp=$VXPORT,tos=$outer_tos,p=$payload -q &\n\tmz_pid=$!\n\n\tdevlink_trap_exception_test $trap_name\n\n\ttc_check_packets \"dev $swp1 egress\" 101 0\n\tcheck_err $? \"Packets were not dropped\"\n\n\tlog_test \"$desc: Inner ECN is not ECT and outer is $ecn_desc\"\n\n\tkill $mz_pid && wait $mz_pid &> /dev/null\n\ttc filter del dev $swp1 egress protocol ip pref 1 handle 101 flower\n}\n\nreserved_bits_payload_get()\n{\n\tdest_mac=$(mac_get $h1)\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"01:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"00:00:00:00:00:00:\"$(       : ETH saddr\n\t\t)\"08:00:\"$(                   : ETH type\n\t\t)\"45:\"$(                      : IP version + IHL\n\t\t)\"00:\"$(                      : IP TOS\n\t\t)\"00:14:\"$(                   : IP total length\n\t\t)\"00:00:\"$(                   : IP identification\n\t\t)\"20:00:\"$(                   : IP flags + frag off\n\t\t)\"40:\"$(                      : IP TTL\n\t\t)\"00:\"$(                      : IP proto\n\t\t)\"00:00:\"$(                   : IP header csum\n\t\t)\"c0:00:02:03:\"$(             : IP saddr: 192.0.2.3\n\t\t)\"c0:00:02:01:\"$(             : IP daddr: 192.0.2.1\n\t\t)\n\techo $p\n}\n\nshort_payload_get()\n{\n        dest_mac=$(mac_get $h1)\n        p=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"00:00:00:00:00:00:\"$(       : ETH saddr\n\t\t)\n        echo $p\n}\n\ncorrupted_packet_test()\n{\n\tlocal trap_name=\"decap_error\"\n\tlocal desc=$1; shift\n\tlocal payload_get=$1; shift\n\tlocal mz_pid\n\n\tRET=0\n\n\t# In case of too short packet, there is no any inner packet,\n\t# so the matching will always succeed\n\ttc filter add dev $swp1 egress protocol ip pref 1 handle 101 \\\n\t\tflower skip_hw src_ip 192.0.2.3 dst_ip 192.0.2.1 action pass\n\n\trp1_mac=$(mac_get $rp1)\n\tpayload=$($payload_get)\n\tip vrf exec v$rp2 $MZ $rp2 -c 0 -d 1msec -b $rp1_mac \\\n\t\t-B 192.0.2.17 -t udp sp=12345,dp=$VXPORT,p=$payload -q &\n\tmz_pid=$!\n\n\tdevlink_trap_exception_test $trap_name\n\n\ttc_check_packets \"dev $swp1 egress\" 101 0\n\tcheck_err $? \"Packets were not dropped\"\n\n\tlog_test \"$desc\"\n\n\tkill $mz_pid && wait $mz_pid &> /dev/null\n\ttc filter del dev $swp1 egress protocol ip pref 1 handle 101 flower\n}\n\ndecap_error_test()\n{\n\tecn_decap_test \"Decap error\" \"ECT(1)\" 01\n\tecn_decap_test \"Decap error\" \"ECT(0)\" 02\n\tecn_decap_test \"Decap error\" \"CE\" 03\n\n\tcorrupted_packet_test \"Decap error: Reserved bits in use\" \\\n\t\t\"reserved_bits_payload_get\"\n\tcorrupted_packet_test \"Decap error: Too short inner packet\" \\\n\t\t\"short_payload_get\"\n}\n\nmc_smac_payload_get()\n{\n\tdest_mac=$(mac_get $h1)\n\tsource_mac=01:02:03:04:05:06\n\tp=$(:\n\t\t)\"08:\"$(                      : VXLAN flags\n\t\t)\"00:00:00:\"$(                : VXLAN reserved\n\t\t)\"00:03:e8:\"$(                : VXLAN VNI : 1000\n\t\t)\"00:\"$(                      : VXLAN reserved\n\t\t)\"$dest_mac:\"$(               : ETH daddr\n\t\t)\"$source_mac:\"$(             : ETH saddr\n\t\t)\"08:00:\"$(                   : ETH type\n\t\t)\"45:\"$(                      : IP version + IHL\n\t\t)\"00:\"$(                      : IP TOS\n\t\t)\"00:14:\"$(                   : IP total length\n\t\t)\"00:00:\"$(                   : IP identification\n\t\t)\"20:00:\"$(                   : IP flags + frag off\n\t\t)\"40:\"$(                      : IP TTL\n\t\t)\"00:\"$(                      : IP proto\n\t\t)\"00:00:\"$(                   : IP header csum\n\t\t)\"c0:00:02:03:\"$(             : IP saddr: 192.0.2.3\n\t\t)\"c0:00:02:01:\"$(             : IP daddr: 192.0.2.1\n\t\t)\n\techo $p\n}\n\noverlay_smac_is_mc_test()\n{\n\tlocal trap_name=\"overlay_smac_is_mc\"\n\tlocal mz_pid\n\n\tRET=0\n\n\t# The matching will be checked on devlink_trap_drop_test()\n\t# and the filter will be removed on devlink_trap_drop_cleanup()\n\ttc filter add dev $swp1 egress protocol ip pref 1 handle 101 \\\n\t\tflower src_mac 01:02:03:04:05:06 action pass\n\n\trp1_mac=$(mac_get $rp1)\n\tpayload=$(mc_smac_payload_get)\n\n\tip vrf exec v$rp2 $MZ $rp2 -c 0 -d 1msec -b $rp1_mac \\\n\t\t-B 192.0.2.17 -t udp sp=12345,dp=$VXPORT,p=$payload -q &\n\tmz_pid=$!\n\n\tdevlink_trap_drop_test $trap_name $swp1 101\n\n\tlog_test \"Overlay source MAC is multicast\"\n\n\tdevlink_trap_drop_cleanup $mz_pid $swp1 \"ip\" 1 101\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}