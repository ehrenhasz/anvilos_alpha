{
  "module_name": "mirror_gre_scale.sh",
  "hash_id": "8ff59da4589521166b8d6a91cb5233e865e5132200a44f73c62f235a60bf9123",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/mirror_gre_scale.sh",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n\n# Test offloading a number of mirrors-to-gretap. The test creates a number of\n# tunnels. Then it adds one flower mirror for each of the tunnels, matching a\n# given host IP. Then it generates traffic at each of the host IPs and checks\n# that the traffic has been mirrored at the appropriate tunnel.\n#\n#   +--------------------------+                   +--------------------------+\n#   | H1                       |                   |                       H2 |\n#   |     + $h1                |                   |                $h2 +     |\n#   |     | 2001:db8:1:X::1/64 |                   | 2001:db8:1:X::2/64 |     |\n#   +-----|--------------------+                   +--------------------|-----+\n#         |                                                             |\n#   +-----|-------------------------------------------------------------|-----+\n#   | SW  o--> mirrors                                                  |     |\n#   | +---|-------------------------------------------------------------|---+ |\n#   | |   + $swp1                    BR                           $swp2 +   | |\n#   | +---------------------------------------------------------------------+ |\n#   |                                                                         |\n#   |     + $swp3                          + gt6-<X> (ip6gretap)              |\n#   |     | 2001:db8:2:X::1/64             : loc=2001:db8:2:X::1              |\n#   |     |                                : rem=2001:db8:2:X::2              |\n#   |     |                                : ttl=100                          |\n#   |     |                                : tos=inherit                      |\n#   |     |                                :                                  |\n#   +-----|--------------------------------:----------------------------------+\n#         |                                :\n#   +-----|--------------------------------:----------------------------------+\n#   | H3  + $h3                            + h3-gt6-<X> (ip6gretap)           |\n#   |       2001:db8:2:X::2/64               loc=2001:db8:2:X::2              |\n#   |                                        rem=2001:db8:2:X::1              |\n#   |                                        ttl=100                          |\n#   |                                        tos=inherit                      |\n#   |                                                                         |\n#   +-------------------------------------------------------------------------+\n\nsource ../../../../net/forwarding/mirror_lib.sh\n\nMIRROR_NUM_NETIFS=6\n\nmirror_gre_ipv6_addr()\n{\n\tlocal net=$1; shift\n\tlocal num=$1; shift\n\n\tprintf \"2001:db8:%x:%x\" $net $num\n}\n\nmirror_gre_tunnels_create()\n{\n\tlocal count=$1; shift\n\tlocal should_fail=$1; shift\n\n\tMIRROR_GRE_BATCH_FILE=\"$(mktemp)\"\n\tfor ((i=0; i < count; ++i)); do\n\t\tlocal match_dip=$(mirror_gre_ipv6_addr 1 $i)::2\n\t\tlocal htun=h3-gt6-$i\n\t\tlocal tun=gt6-$i\n\n\t\t((mirror_gre_tunnels++))\n\n\t\tip address add dev $h1 $(mirror_gre_ipv6_addr 1 $i)::1/64\n\t\tip address add dev $h2 $(mirror_gre_ipv6_addr 1 $i)::2/64\n\n\t\tip address add dev $swp3 $(mirror_gre_ipv6_addr 2 $i)::1/64\n\t\tip address add dev $h3 $(mirror_gre_ipv6_addr 2 $i)::2/64\n\n\t\ttunnel_create $tun ip6gretap \\\n\t\t\t      $(mirror_gre_ipv6_addr 2 $i)::1 \\\n\t\t\t      $(mirror_gre_ipv6_addr 2 $i)::2 \\\n\t\t\t      ttl 100 tos inherit allow-localremote\n\n\t\ttunnel_create $htun ip6gretap \\\n\t\t\t      $(mirror_gre_ipv6_addr 2 $i)::2 \\\n\t\t\t      $(mirror_gre_ipv6_addr 2 $i)::1\n\t\tip link set $htun vrf v$h3\n\t\tmatchall_sink_create $htun\n\n\t\tcat >> $MIRROR_GRE_BATCH_FILE <<-EOF\n\t\t\tfilter add dev $swp1 ingress pref 1000 \\\n\t\t\t\tprotocol ipv6 \\\n\t\t\t\tflower $tcflags dst_ip $match_dip \\\n\t\t\t\taction mirred egress mirror dev $tun\n\t\tEOF\n\tdone\n\n\ttc -b $MIRROR_GRE_BATCH_FILE\n\tcheck_err_fail $should_fail $? \"Mirror rule insertion\"\n}\n\nmirror_gre_tunnels_destroy()\n{\n\tlocal count=$1; shift\n\n\tfor ((i=0; i < count; ++i)); do\n\t\tlocal htun=h3-gt6-$i\n\t\tlocal tun=gt6-$i\n\n\t\tip address del dev $h3 $(mirror_gre_ipv6_addr 2 $i)::2/64\n\t\tip address del dev $swp3 $(mirror_gre_ipv6_addr 2 $i)::1/64\n\n\t\tip address del dev $h2 $(mirror_gre_ipv6_addr 1 $i)::2/64\n\t\tip address del dev $h1 $(mirror_gre_ipv6_addr 1 $i)::1/64\n\n\t\ttunnel_destroy $htun\n\t\ttunnel_destroy $tun\n\tdone\n}\n\n__mirror_gre_test()\n{\n\tlocal count=$1; shift\n\tlocal should_fail=$1; shift\n\n\tmirror_gre_tunnels_create $count $should_fail\n\tif ((should_fail)); then\n\t    return\n\tfi\n\n\tsleep 5\n\n\tfor ((i = 0; i < count; ++i)); do\n\t\tlocal sip=$(mirror_gre_ipv6_addr 1 $i)::1\n\t\tlocal dip=$(mirror_gre_ipv6_addr 1 $i)::2\n\t\tlocal htun=h3-gt6-$i\n\t\tlocal message\n\n\t\ticmp6_capture_install $htun\n\t\tmirror_test v$h1 $sip $dip $htun 100 10\n\t\ticmp6_capture_uninstall $htun\n\tdone\n}\n\nmirror_gre_test()\n{\n\tlocal count=$1; shift\n\tlocal should_fail=$1; shift\n\n\tif ! tc_offload_check $TC_FLOWER_NUM_NETIFS; then\n\t\tcheck_err 1 \"Could not test offloaded functionality\"\n\t\treturn\n\tfi\n\n\ttcflags=\"skip_sw\"\n\t__mirror_gre_test $count $should_fail\n}\n\nmirror_gre_setup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tmirror_gre_tunnels=0\n\n\tvrf_prepare\n\n\tsimple_if_init $h1\n\tsimple_if_init $h2\n\tsimple_if_init $h3\n\n\tip link add name br1 type bridge vlan_filtering 1\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\ttc qdisc add dev $swp1 clsact\n\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\tip link set dev $swp3 up\n}\n\nmirror_gre_cleanup()\n{\n\tmirror_gre_tunnels_destroy $mirror_gre_tunnels\n\n\tip link set dev $swp3 down\n\n\tip link set dev $swp2 down\n\n\ttc qdisc del dev $swp1 clsact\n\tip link set dev $swp1 down\n\n\tip link del dev br1\n\n\tsimple_if_fini $h3\n\tsimple_if_fini $h2\n\tsimple_if_fini $h1\n\n\tvrf_cleanup\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}