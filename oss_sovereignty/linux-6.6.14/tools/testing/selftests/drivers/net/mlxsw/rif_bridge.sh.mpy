{
  "module_name": "rif_bridge.sh",
  "hash_id": "4fe0e628b83fd4ddd60d5e4dbcb96e1d4db93c5811dababcca2a6662e3868aec",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/rif_bridge.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tbridge_rif_add\n\tbridge_rif_nomaster\n\tbridge_rif_remaster\n\tbridge_rif_nomaster_addr\n\tbridge_rif_nomaster_port\n\tbridge_rif_remaster_port\n\"\n\nNUM_NETIFS=2\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\n\nsetup_prepare()\n{\n\tswp1=${NETIFS[p1]}\n\tswp2=${NETIFS[p2]}\n\n\tteam_create lag1 lacp\n\tip link set dev lag1 addrgenmode none\n\tip link set dev lag1 address $(mac_get $swp1)\n\n\tteam_create lag2 lacp\n\tip link set dev lag2 addrgenmode none\n\tip link set dev lag2 address $(mac_get $swp2)\n\n\tip link add name br1 type bridge vlan_filtering 1\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 address $(mac_get lag1)\n\tip link set dev br1 up\n\n\tip link set dev lag1 master br1\n\n\tip link set dev $swp1 master lag1\n\tip link set dev $swp1 up\n\n\tip link set dev $swp2 master lag2\n\tip link set dev $swp2 up\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp2 down\n\n\tip link set dev $swp1 nomaster\n\tip link set dev $swp1 down\n\n\tip link del dev lag2\n\tip link set dev lag1 nomaster\n\tip link del dev lag1\n\n\tip link del dev br1\n}\n\nbridge_rif_add()\n{\n\tRET=0\n\n\tlocal rifs_occ_t0=$(devlink_resource_occ_get rifs)\n\t__addr_add_del br1 add 192.0.2.2/28\n\tsleep 1\n\tlocal rifs_occ_t1=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0 + 1))\n\n\t((expected_rifs == rifs_occ_t1))\n\tcheck_err $? \"Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n\n\tlog_test \"Add RIF for bridge on address addition\"\n}\n\nbridge_rif_nomaster()\n{\n\tRET=0\n\n\tlocal rifs_occ_t0=$(devlink_resource_occ_get rifs)\n\tip link set dev lag1 nomaster\n\tsleep 1\n\tlocal rifs_occ_t1=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0 - 1))\n\n\t((expected_rifs == rifs_occ_t1))\n\tcheck_err $? \"Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n\n\tlog_test \"Drop RIF for bridge on LAG deslavement\"\n}\n\nbridge_rif_remaster()\n{\n\tRET=0\n\n\tlocal rifs_occ_t0=$(devlink_resource_occ_get rifs)\n\tip link set dev lag1 master br1\n\tsleep 1\n\tlocal rifs_occ_t1=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0 + 1))\n\n\t((expected_rifs == rifs_occ_t1))\n\tcheck_err $? \"Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n\n\tlog_test \"Add RIF for bridge on LAG reenslavement\"\n}\n\nbridge_rif_nomaster_addr()\n{\n\tlocal rifs_occ_t0=$(devlink_resource_occ_get rifs)\n\n\t# Adding an address while the LAG is enslaved shouldn't generate a RIF.\n\t__addr_add_del lag1 add 192.0.2.65/28\n\tsleep 1\n\tlocal rifs_occ_t1=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0))\n\n\t((expected_rifs == rifs_occ_t1))\n\tcheck_err $? \"After adding IP: Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n\n\t# Removing the LAG from the bridge should drop RIF for the bridge (as\n\t# tested in bridge_rif_lag_nomaster), but since the LAG now has an\n\t# address, it should gain a RIF.\n\tip link set dev lag1 nomaster\n\tsleep 1\n\tlocal rifs_occ_t2=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0))\n\n\t((expected_rifs == rifs_occ_t2))\n\tcheck_err $? \"After deslaving: Expected $expected_rifs RIFs, $rifs_occ_t2 are used\"\n\n\tlog_test \"Add RIF for LAG on deslavement from bridge\"\n\n\t__addr_add_del lag1 del 192.0.2.65/28\n\tip link set dev lag1 master br1\n\tsleep 1\n}\n\nbridge_rif_nomaster_port()\n{\n\tRET=0\n\n\tlocal rifs_occ_t0=$(devlink_resource_occ_get rifs)\n\tip link set dev $swp1 nomaster\n\tsleep 1\n\tlocal rifs_occ_t1=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0 - 1))\n\n\t((expected_rifs == rifs_occ_t1))\n\tcheck_err $? \"Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n\n\tlog_test \"Drop RIF for bridge on deslavement of port from LAG\"\n}\n\nbridge_rif_remaster_port()\n{\n\tRET=0\n\n\tlocal rifs_occ_t0=$(devlink_resource_occ_get rifs)\n\tip link set dev $swp1 down\n\tip link set dev $swp1 master lag1\n\tip link set dev $swp1 up\n\tsetup_wait_dev $swp1\n\tlocal rifs_occ_t1=$(devlink_resource_occ_get rifs)\n\tlocal expected_rifs=$((rifs_occ_t0 + 1))\n\n\t((expected_rifs == rifs_occ_t1))\n\tcheck_err $? \"Expected $expected_rifs RIFs, $rifs_occ_t1 are used\"\n\n\tlog_test \"Add RIF for bridge on reenslavement of port to LAG\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}