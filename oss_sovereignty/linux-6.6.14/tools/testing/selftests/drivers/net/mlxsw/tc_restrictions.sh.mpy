{
  "module_name": "tc_restrictions.sh",
  "hash_id": "491375a5a75d94a459134956237fc1089bf783239214f8f43e853c3bd6dc4c0d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/tc_restrictions.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nALL_TESTS=\"\n\tshared_block_drop_test\n\tegress_redirect_test\n\tmulti_mirror_test\n\tmatchall_sample_egress_test\n\tmatchall_mirror_behind_flower_ingress_test\n\tmatchall_sample_behind_flower_ingress_test\n\tmatchall_mirror_behind_flower_egress_test\n\tmatchall_proto_match_test\n\tpolice_limits_test\n\tmulti_police_test\n\"\nNUM_NETIFS=2\n\nsource $lib_dir/tc_common.sh\nsource $lib_dir/lib.sh\nsource $lib_dir/devlink_lib.sh\nsource mlxsw_lib.sh\n\nswitch_create()\n{\n\tsimple_if_init $swp1 192.0.2.1/24\n\tsimple_if_init $swp2 192.0.2.2/24\n}\n\nswitch_destroy()\n{\n\tsimple_if_fini $swp2 192.0.2.2/24\n\tsimple_if_fini $swp1 192.0.2.1/24\n}\n\nshared_block_drop_test()\n{\n\tRET=0\n\n\t# It is forbidden in mlxsw driver to have mixed-bound\n\t# shared block with a drop rule.\n\n\ttc qdisc add dev $swp1 ingress_block 22 clsact\n\tcheck_err $? \"Failed to create clsact with ingress block\"\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_err $? \"Failed to add drop rule to ingress bound block\"\n\n\ttc qdisc add dev $swp2 ingress_block 22 clsact\n\tcheck_err $? \"Failed to create another clsact with ingress shared block\"\n\n\ttc qdisc del dev $swp2 clsact\n\n\ttc qdisc add dev $swp2 egress_block 22 clsact\n\tcheck_fail $? \"Incorrect success to create another clsact with egress shared block\"\n\n\ttc filter del block 22 protocol ip pref 1 handle 101 flower\n\n\ttc qdisc add dev $swp2 egress_block 22 clsact\n\tcheck_err $? \"Failed to create another clsact with egress shared block after blocker drop rule removed\"\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_fail $? \"Incorrect success to add drop rule to mixed bound block\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\ttc qdisc add dev $swp1 egress_block 22 clsact\n\tcheck_err $? \"Failed to create another clsact with egress shared block\"\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_err $? \"Failed to add drop rule to egress bound shared block\"\n\n\ttc filter del block 22 protocol ip pref 1 handle 101 flower\n\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"shared block drop\"\n}\n\negress_redirect_test()\n{\n\tRET=0\n\n\t# It is forbidden in mlxsw driver to have mirred redirect on\n\t# egress-bound block.\n\n\ttc qdisc add dev $swp1 ingress_block 22 clsact\n\tcheck_err $? \"Failed to create clsact with ingress block\"\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 \\\n\t\taction mirred egress redirect dev $swp2\n\tcheck_err $? \"Failed to add redirect rule to ingress bound block\"\n\n\ttc qdisc add dev $swp2 ingress_block 22 clsact\n\tcheck_err $? \"Failed to create another clsact with ingress shared block\"\n\n\ttc qdisc del dev $swp2 clsact\n\n\ttc qdisc add dev $swp2 egress_block 22 clsact\n\tcheck_fail $? \"Incorrect success to create another clsact with egress shared block\"\n\n\ttc filter del block 22 protocol ip pref 1 handle 101 flower\n\n\ttc qdisc add dev $swp2 egress_block 22 clsact\n\tcheck_err $? \"Failed to create another clsact with egress shared block after blocker redirect rule removed\"\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 \\\n\t\taction mirred egress redirect dev $swp2\n\tcheck_fail $? \"Incorrect success to add redirect rule to mixed bound block\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\ttc qdisc add dev $swp1 egress_block 22 clsact\n\tcheck_err $? \"Failed to create another clsact with egress shared block\"\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 \\\n\t\taction mirred egress redirect dev $swp2\n\tcheck_fail $? \"Incorrect success to add redirect rule to egress bound shared block\"\n\n\ttc qdisc del dev $swp2 clsact\n\n\ttc filter add block 22 protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 \\\n\t\taction mirred egress redirect dev $swp2\n\tcheck_fail $? \"Incorrect success to add redirect rule to egress bound block\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"shared block drop\"\n}\n\nmulti_mirror_test()\n{\n\tRET=0\n\n\t# It is forbidden in mlxsw driver to have multiple mirror\n\t# actions in a single rule.\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 \\\n\t\taction mirred egress mirror dev $swp2\n\tcheck_err $? \"Failed to add rule with single mirror action\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 \\\n\t\taction mirred egress mirror dev $swp2 \\\n\t\taction mirred egress mirror dev $swp1\n\tcheck_fail $? \"Incorrect success to add rule with two mirror actions\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"multi mirror\"\n}\n\nmatchall_sample_egress_test()\n{\n\tRET=0\n\n\t# It is forbidden in mlxsw driver to have matchall with sample action\n\t# bound on egress. Spectrum-1 specific restriction\n\tmlxsw_only_on_spectrum 1 || return\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 ingress protocol all pref 1 handle 101 \\\n\t\tmatchall skip_sw action sample rate 100 group 1\n\tcheck_err $? \"Failed to add rule with sample action on ingress\"\n\n\ttc filter del dev $swp1 ingress protocol all pref 1 handle 101 matchall\n\n\ttc filter add dev $swp1 egress protocol all pref 1 handle 101 \\\n\t\tmatchall skip_sw action sample rate 100 group 1\n\tcheck_fail $? \"Incorrect success to add rule with sample action on egress\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"matchall sample egress\"\n}\n\nmatchall_behind_flower_ingress_test()\n{\n\tlocal action=$1\n\tlocal action_args=$2\n\n\tRET=0\n\n\t# On ingress, all matchall-mirror and matchall-sample\n\t# rules have to be in front of the flower rules\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 ingress protocol ip pref 10 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\n\ttc filter add dev $swp1 ingress protocol all pref 9 handle 102 \\\n\t\tmatchall skip_sw action $action_args\n\tcheck_err $? \"Failed to add matchall rule in front of a flower rule\"\n\n\ttc filter del dev $swp1 ingress protocol all pref 9 handle 102 matchall\n\n\ttc filter add dev $swp1 ingress protocol all pref 11 handle 102 \\\n\t\tmatchall skip_sw action $action_args\n\tcheck_fail $? \"Incorrect success to add matchall rule behind a flower rule\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 10 handle 101 flower\n\n\ttc filter add dev $swp1 ingress protocol all pref 9 handle 102 \\\n\t\tmatchall skip_sw action $action_args\n\n\ttc filter add dev $swp1 ingress protocol ip pref 10 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_err $? \"Failed to add flower rule behind a matchall rule\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 10 handle 101 flower\n\n\ttc filter add dev $swp1 ingress protocol ip pref 8 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_fail $? \"Incorrect success to add flower rule in front of a matchall rule\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"matchall $action flower ingress\"\n}\n\nmatchall_mirror_behind_flower_ingress_test()\n{\n\tmatchall_behind_flower_ingress_test \"mirror\" \"mirred egress mirror dev $swp2\"\n}\n\nmatchall_sample_behind_flower_ingress_test()\n{\n\tmatchall_behind_flower_ingress_test \"sample\" \"sample rate 100 group 1\"\n}\n\nmatchall_behind_flower_egress_test()\n{\n\tlocal action=$1\n\tlocal action_args=$2\n\n\tRET=0\n\n\t# On egress, all matchall-mirror rules have to be behind the flower rules\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 egress protocol ip pref 10 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\n\ttc filter add dev $swp1 egress protocol all pref 11 handle 102 \\\n\t\tmatchall skip_sw action $action_args\n\tcheck_err $? \"Failed to add matchall rule in front of a flower rule\"\n\n\ttc filter del dev $swp1 egress protocol all pref 11 handle 102 matchall\n\n\ttc filter add dev $swp1 egress protocol all pref 9 handle 102 \\\n\t\tmatchall skip_sw action $action_args\n\tcheck_fail $? \"Incorrect success to add matchall rule behind a flower rule\"\n\n\ttc filter del dev $swp1 egress protocol ip pref 10 handle 101 flower\n\n\ttc filter add dev $swp1 egress protocol all pref 11 handle 102 \\\n\t\tmatchall skip_sw action $action_args\n\n\ttc filter add dev $swp1 egress protocol ip pref 10 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_err $? \"Failed to add flower rule behind a matchall rule\"\n\n\ttc filter del dev $swp1 egress protocol ip pref 10 handle 101 flower\n\n\ttc filter add dev $swp1 egress protocol ip pref 12 handle 101 flower \\\n\t\tskip_sw dst_ip 192.0.2.2 action drop\n\tcheck_fail $? \"Incorrect success to add flower rule in front of a matchall rule\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"matchall $action flower egress\"\n}\n\nmatchall_mirror_behind_flower_egress_test()\n{\n\tmatchall_behind_flower_egress_test \"mirror\" \"mirred egress mirror dev $swp2\"\n}\n\nmatchall_proto_match_test()\n{\n\tRET=0\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tmatchall skip_sw \\\n\t\taction sample group 1 rate 100\n\tcheck_fail $? \"Incorrect success to add matchall rule with protocol match\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"matchall protocol match\"\n}\n\npolice_limits_test()\n{\n\tRET=0\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 0.5kbit burst 1m conform-exceed drop/ok\n\tcheck_fail $? \"Incorrect success to add police action with too low rate\"\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 2.5tbit burst 1g conform-exceed drop/ok\n\tcheck_fail $? \"Incorrect success to add police action with too high rate\"\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 1.5kbit burst 1m conform-exceed drop/ok\n\tcheck_err $? \"Failed to add police action with low rate\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 1.9tbit burst 1g conform-exceed drop/ok\n\tcheck_err $? \"Failed to add police action with high rate\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 1.5kbit burst 512b conform-exceed drop/ok\n\tcheck_fail $? \"Incorrect success to add police action with too low burst size\"\n\n\ttc filter add dev $swp1 ingress pref 1 proto ip handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 1.5kbit burst 2k conform-exceed drop/ok\n\tcheck_err $? \"Failed to add police action with low burst size\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"police rate and burst limits\"\n}\n\nmulti_police_test()\n{\n\tRET=0\n\n\t# It is forbidden in mlxsw driver to have multiple police\n\t# actions in a single rule.\n\n\ttc qdisc add dev $swp1 clsact\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 100mbit burst 100k conform-exceed drop/ok\n\tcheck_err $? \"Failed to add rule with single police action\"\n\n\ttc filter del dev $swp1 ingress protocol ip pref 1 handle 101 flower\n\n\ttc filter add dev $swp1 ingress protocol ip pref 1 handle 101 \\\n\t\tflower skip_sw \\\n\t\taction police rate 100mbit burst 100k conform-exceed drop/pipe \\\n\t\taction police rate 200mbit burst 200k conform-exceed drop/ok\n\tcheck_fail $? \"Incorrect success to add rule with two police actions\"\n\n\ttc qdisc del dev $swp1 clsact\n\n\tlog_test \"multi police\"\n}\n\nsetup_prepare()\n{\n\tswp1=${NETIFS[p1]}\n\tswp2=${NETIFS[p2]}\n\n\tvrf_prepare\n\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\n\tvrf_cleanup\n}\n\ncheck_tc_shblock_support\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}