{
  "module_name": "mirror_gre.sh",
  "hash_id": "264680b736d48b673f482f61dde0d345515a1d3f54fee19c662a63acd8dcad56",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/mirror_gre.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test uses standard topology for testing gretap. See\n# ../../../net/forwarding/mirror_gre_topo_lib.sh for more details.\n#\n# Test offloading various features of offloading gretap mirrors specific to\n# mlxsw.\n\nlib_dir=$(dirname $0)/../../../net/forwarding\n\nNUM_NETIFS=6\nsource $lib_dir/lib.sh\nsource $lib_dir/mirror_lib.sh\nsource $lib_dir/mirror_gre_lib.sh\nsource $lib_dir/mirror_gre_topo_lib.sh\n\nsetup_keyful()\n{\n\ttunnel_create gt6-key ip6gretap 2001:db8:3::1 2001:db8:3::2 \\\n\t\t      ttl 100 tos inherit allow-localremote \\\n\t\t      key 1234\n\n\ttunnel_create h3-gt6-key ip6gretap 2001:db8:3::2 2001:db8:3::1 \\\n\t\t      key 1234\n\tip link set h3-gt6-key vrf v$h3\n\tmatchall_sink_create h3-gt6-key\n\n\tip address add dev $swp3 2001:db8:3::1/64\n\tip address add dev $h3 2001:db8:3::2/64\n}\n\ncleanup_keyful()\n{\n\tip address del dev $h3 2001:db8:3::2/64\n\tip address del dev $swp3 2001:db8:3::1/64\n\n\ttunnel_destroy h3-gt6-key\n\ttunnel_destroy gt6-key\n}\n\nsetup_soft()\n{\n\t# Set up a topology for testing underlay routes that point at an\n\t# unsupported soft device.\n\n\ttunnel_create gt6-soft ip6gretap 2001:db8:4::1 2001:db8:4::2 \\\n\t\t      ttl 100 tos inherit allow-localremote\n\n\ttunnel_create h3-gt6-soft ip6gretap 2001:db8:4::2 2001:db8:4::1\n\tip link set h3-gt6-soft vrf v$h3\n\tmatchall_sink_create h3-gt6-soft\n\n\tip link add name v1 type veth peer name v2\n\tip link set dev v1 up\n\tip address add dev v1 2001:db8:4::1/64\n\n\tip link set dev v2 vrf v$h3\n\tip link set dev v2 up\n\tip address add dev v2 2001:db8:4::2/64\n}\n\ncleanup_soft()\n{\n\tip link del dev v1\n\n\ttunnel_destroy h3-gt6-soft\n\ttunnel_destroy gt6-soft\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tvrf_prepare\n\tmirror_gre_topo_create\n\n\tip address add dev $swp3 2001:db8:2::1/64\n\tip address add dev $h3 2001:db8:2::2/64\n\n\tip address add dev $swp3 192.0.2.129/28\n\tip address add dev $h3 192.0.2.130/28\n\n\tsetup_keyful\n\tsetup_soft\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tcleanup_soft\n\tcleanup_keyful\n\n\tip address del dev $h3 2001:db8:2::2/64\n\tip address del dev $swp3 2001:db8:2::1/64\n\n\tip address del dev $h3 192.0.2.130/28\n\tip address del dev $swp3 192.0.2.129/28\n\n\tmirror_gre_topo_destroy\n\tvrf_cleanup\n}\n\ntest_span_gre_ttl_inherit()\n{\n\tlocal tundev=$1; shift\n\tlocal type=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\tip link set dev $tundev type $type ttl inherit\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\tfail_test_span_gre_dir $tundev ingress\n\n\tip link set dev $tundev type $type ttl 100\n\n\tquick_test_span_gre_dir $tundev ingress\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: no offload on TTL of inherit ($tcflags)\"\n}\n\ntest_span_gre_tos_fixed()\n{\n\tlocal tundev=$1; shift\n\tlocal type=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\tip link set dev $tundev type $type tos 0x10\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\tfail_test_span_gre_dir $tundev ingress\n\n\tip link set dev $tundev type $type tos inherit\n\tquick_test_span_gre_dir $tundev ingress\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: no offload on a fixed TOS ($tcflags)\"\n}\n\ntest_span_failable()\n{\n\tlocal should_fail=$1; shift\n\tlocal tundev=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\tif ((should_fail)); then\n\t    fail_test_span_gre_dir  $tundev ingress\n\telse\n\t    quick_test_span_gre_dir $tundev ingress\n\tfi\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: should_fail=$should_fail ($tcflags)\"\n}\n\ntest_failable()\n{\n\tlocal should_fail=$1; shift\n\n\ttest_span_failable $should_fail gt6-key \"mirror to keyful gretap\"\n\ttest_span_failable $should_fail gt6-soft \"mirror to gretap w/ soft underlay\"\n}\n\ntest_sw()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttest_failable 0\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntest_hw()\n{\n\ttest_failable 1\n\n\ttest_span_gre_tos_fixed gt4 gretap \"mirror to gretap\"\n\ttest_span_gre_tos_fixed gt6 ip6gretap \"mirror to ip6gretap\"\n\n\ttest_span_gre_ttl_inherit gt4 gretap \"mirror to gretap\"\n\ttest_span_gre_ttl_inherit gt6 ip6gretap \"mirror to ip6gretap\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\nif ! tc_offload_check; then\n    check_err 1 \"Could not test offloaded functionality\"\n    log_test \"mlxsw-specific tests for mirror to gretap\"\n    exit\nfi\n\ntcflags=\"skip_hw\"\ntest_sw\n\ntcflags=\"skip_sw\"\ntest_hw\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}