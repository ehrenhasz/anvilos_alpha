{
  "module_name": "sch_offload.sh",
  "hash_id": "7d099110f369c70c043f9b8788c3c59361663ab550302c8d7467479e6f6ea757",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/drivers/net/mlxsw/sch_offload.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test qdisc offload indication\n\n\nALL_TESTS=\"\n\ttest_root\n\ttest_port_tbf\n\ttest_etsprio\n\ttest_etsprio_port_tbf\n\"\nNUM_NETIFS=1\nlib_dir=$(dirname $0)/../../../net/forwarding\nsource $lib_dir/lib.sh\n\ncheck_not_offloaded()\n{\n\tlocal handle=$1; shift\n\tlocal h\n\tlocal offloaded\n\n\th=$(qdisc_stats_get $h1 \"$handle\" .handle)\n\t[[ $h == '\"'$handle'\"' ]]\n\tcheck_err $? \"Qdisc with handle $handle does not exist\"\n\n\toffloaded=$(qdisc_stats_get $h1 \"$handle\" .offloaded)\n\t[[ $offloaded == true ]]\n\tcheck_fail $? \"Qdisc with handle $handle offloaded, but should not be\"\n}\n\ncheck_all_offloaded()\n{\n\tlocal handle=$1; shift\n\n\tif [[ ! -z $handle ]]; then\n\t\tlocal offloaded=$(qdisc_stats_get $h1 \"$handle\" .offloaded)\n\t\t[[ $offloaded == true ]]\n\t\tcheck_err $? \"Qdisc with handle $handle not offloaded\"\n\tfi\n\n\tlocal unoffloaded=$(tc q sh dev $h1 invisible |\n\t\t\t\tgrep -v offloaded |\n\t\t\t\tsed s/root/parent\\ root/ |\n\t\t\t\tcut -d' ' -f 5)\n\t[[ -z $unoffloaded ]]\n\tcheck_err $? \"Qdiscs with following parents not offloaded: $unoffloaded\"\n\n\tpre_cleanup\n}\n\nwith_ets()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle \\\n\t   ets bands 8 priomap 7 6 5 4 3 2 1 0\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_prio()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle \\\n\t   prio bands 8 priomap 7 6 5 4 3 2 1 0\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_red()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle \\\n\t   red limit 1000000 min 200000 max 300000 probability 0.5 avpkt 1500\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_tbf()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle \\\n\t   tbf rate 400Mbit burst 128K limit 1M\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_pfifo()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle pfifo limit 100K\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_bfifo()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle bfifo limit 100K\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_drr()\n{\n\tlocal handle=$1; shift\n\tlocal locus=$1; shift\n\n\ttc qdisc add dev $h1 $locus handle $handle drr\n\t\"$@\"\n\ttc qdisc del dev $h1 $locus\n}\n\nwith_qdiscs()\n{\n\tlocal handle=$1; shift\n\tlocal parent=$1; shift\n\tlocal kind=$1; shift\n\tlocal next_handle=$((handle * 2))\n\tlocal locus;\n\n\tif [[ $kind == \"--\" ]]; then\n\t\tlocal cmd=$1; shift\n\t\t$cmd $(printf %x: $parent) \"$@\"\n\telse\n\t\tif ((parent == 0)); then\n\t\t\tlocus=root\n\t\telse\n\t\t\tlocus=$(printf \"parent %x:1\" $parent)\n\t\tfi\n\n\t\twith_$kind $(printf %x: $handle) \"$locus\" \\\n\t\t\twith_qdiscs $next_handle $handle \"$@\"\n\tfi\n}\n\nget_name()\n{\n\tlocal parent=$1; shift\n\tlocal name=$(echo \"\" \"${@^^}\" | tr ' ' -)\n\n\tif ((parent != 0)); then\n\t\tkind=$(qdisc_stats_get $h1 $parent: .kind)\n\t\tkind=${kind%\\\"}\n\t\tkind=${kind#\\\"}\n\t\tname=\"-${kind^^}$name\"\n\tfi\n\n\techo root$name\n}\n\ndo_test_offloaded()\n{\n\tlocal handle=$1; shift\n\tlocal parent=$1; shift\n\n\tRET=0\n\twith_qdiscs $handle $parent \"$@\" -- check_all_offloaded\n\tlog_test $(get_name $parent \"$@\")\" offloaded\"\n}\n\ndo_test_nooffload()\n{\n\tlocal handle=$1; shift\n\tlocal parent=$1; shift\n\n\tlocal name=$(echo \"${@^^}\" | tr ' ' -)\n\tlocal kind\n\n\tRET=0\n\twith_qdiscs $handle $parent \"$@\" -- check_not_offloaded\n\tlog_test $(get_name $parent \"$@\")\" not offloaded\"\n}\n\ndo_test_combinations()\n{\n\tlocal handle=$1; shift\n\tlocal parent=$1; shift\n\n\tlocal cont\n\tlocal leaf\n\tlocal fifo\n\n\tfor cont in \"\" ets prio; do\n\t\tfor leaf in \"\" red tbf \"red tbf\" \"tbf red\"; do\n\t\t\tfor fifo in \"\" pfifo bfifo; do\n\t\t\t\tif [[ -z \"$cont$leaf$fifo\" ]]; then\n\t\t\t\t\tcontinue\n\t\t\t\tfi\n\t\t\t\tdo_test_offloaded $handle $parent \\\n\t\t\t\t\t\t  $cont $leaf $fifo\n\t\t\tdone\n\t\tdone\n\tdone\n\n\tfor cont in ets prio; do\n\t\tfor leaf in red tbf; do\n\t\t\tdo_test_nooffload $handle $parent $cont red tbf $leaf\n\t\t\tdo_test_nooffload $handle $parent $cont tbf red $leaf\n\t\tdone\n\t\tfor leaf in \"red red\" \"tbf tbf\"; do\n\t\t\tdo_test_nooffload $handle $parent $cont $leaf\n\t\tdone\n\tdone\n\n\tdo_test_nooffload $handle $parent drr\n}\n\ntest_root()\n{\n\tdo_test_combinations 1 0\n}\n\ntest_port_tbf()\n{\n\twith_tbf 1: root \\\n\t\tdo_test_combinations 8 1\n}\n\ndo_test_etsprio()\n{\n\tlocal parent=$1; shift\n\tlocal tbfpfx=$1; shift\n\tlocal cont\n\n\tfor cont in ets prio; do\n\t\tRET=0\n\t\twith_$cont 8: \"$parent\" \\\n\t\t\twith_red 11: \"parent 8:1\" \\\n\t\t\twith_red 12: \"parent 8:2\" \\\n\t\t\twith_tbf 13: \"parent 8:3\" \\\n\t\t\twith_tbf 14: \"parent 8:4\" \\\n\t\t\tcheck_all_offloaded\n\t\tlog_test \"root$tbfpfx-ETS-{RED,TBF} offloaded\"\n\n\t\tRET=0\n\t\twith_$cont 8: \"$parent\" \\\n\t\t\twith_red 81: \"parent 8:1\" \\\n\t\t\t\twith_tbf 811: \"parent 81:1\" \\\n\t\t\twith_tbf 84: \"parent 8:4\" \\\n\t\t\t\twith_red 841: \"parent 84:1\" \\\n\t\t\tcheck_all_offloaded\n\t\tlog_test \"root$tbfpfx-ETS-{RED-TBF,TBF-RED} offloaded\"\n\n\t\tRET=0\n\t\twith_$cont 8: \"$parent\" \\\n\t\t\twith_red 81: \"parent 8:1\" \\\n\t\t\t\twith_tbf 811: \"parent 81:1\" \\\n\t\t\t\t\twith_bfifo 8111: \"parent 811:1\" \\\n\t\t\twith_tbf 82: \"parent 8:2\" \\\n\t\t\t\twith_red 821: \"parent 82:1\" \\\n\t\t\t\t\twith_bfifo 8211: \"parent 821:1\" \\\n\t\t\tcheck_all_offloaded\n\t\tlog_test \"root$tbfpfx-ETS-{RED-TBF-bFIFO,TBF-RED-bFIFO} offloaded\"\n\tdone\n}\n\ntest_etsprio()\n{\n\tdo_test_etsprio root \"\"\n}\n\ntest_etsprio_port_tbf()\n{\n\twith_tbf 1: root \\\n\t\tdo_test_etsprio \"parent 1:1\" \"-TBF\"\n}\n\ncleanup()\n{\n\ttc qdisc del dev $h1 root &>/dev/null\n}\n\ntrap cleanup EXIT\nh1=${NETIFS[p1]}\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}