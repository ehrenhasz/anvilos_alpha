{
  "module_name": "ioperm.c",
  "hash_id": "fc54e841b323db2b79d013e0a40713988b3b3dd6825749dfdcf365c0c17efcc8",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/x86/ioperm.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <err.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <signal.h>\n#include <setjmp.h>\n#include <stdlib.h>\n#include <string.h>\n#include <errno.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <stdbool.h>\n#include <sched.h>\n#include <sys/io.h>\n\nstatic int nerrs = 0;\n\nstatic void sethandler(int sig, void (*handler)(int, siginfo_t *, void *),\n\t\t       int flags)\n{\n\tstruct sigaction sa;\n\tmemset(&sa, 0, sizeof(sa));\n\tsa.sa_sigaction = handler;\n\tsa.sa_flags = SA_SIGINFO | flags;\n\tsigemptyset(&sa.sa_mask);\n\tif (sigaction(sig, &sa, 0))\n\t\terr(1, \"sigaction\");\n\n}\n\nstatic void clearhandler(int sig)\n{\n\tstruct sigaction sa;\n\tmemset(&sa, 0, sizeof(sa));\n\tsa.sa_handler = SIG_DFL;\n\tsigemptyset(&sa.sa_mask);\n\tif (sigaction(sig, &sa, 0))\n\t\terr(1, \"sigaction\");\n}\n\nstatic jmp_buf jmpbuf;\n\nstatic void sigsegv(int sig, siginfo_t *si, void *ctx_void)\n{\n\tsiglongjmp(jmpbuf, 1);\n}\n\nstatic bool try_outb(unsigned short port)\n{\n\tsethandler(SIGSEGV, sigsegv, SA_RESETHAND);\n\tif (sigsetjmp(jmpbuf, 1) != 0) {\n\t\treturn false;\n\t} else {\n\t\tasm volatile (\"outb %%al, %w[port]\"\n\t\t\t      : : [port] \"Nd\" (port), \"a\" (0));\n\t\treturn true;\n\t}\n\tclearhandler(SIGSEGV);\n}\n\nstatic void expect_ok(unsigned short port)\n{\n\tif (!try_outb(port)) {\n\t\tprintf(\"[FAIL]\\toutb to 0x%02hx failed\\n\", port);\n\t\texit(1);\n\t}\n\n\tprintf(\"[OK]\\toutb to 0x%02hx worked\\n\", port);\n}\n\nstatic void expect_gp(unsigned short port)\n{\n\tif (try_outb(port)) {\n\t\tprintf(\"[FAIL]\\toutb to 0x%02hx worked\\n\", port);\n\t\texit(1);\n\t}\n\n\tprintf(\"[OK]\\toutb to 0x%02hx failed\\n\", port);\n}\n\nint main(void)\n{\n\tcpu_set_t cpuset;\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(0, &cpuset);\n\tif (sched_setaffinity(0, sizeof(cpuset), &cpuset) != 0)\n\t\terr(1, \"sched_setaffinity to CPU 0\");\n\n\texpect_gp(0x80);\n\texpect_gp(0xed);\n\n\t \n\tprintf(\"[RUN]\\tenable 0x80\\n\");\n\tif (ioperm(0x80, 1, 1) != 0) {\n\t\tprintf(\"[OK]\\tioperm(0x80, 1, 1) failed (%d) -- try running as root\\n\",\n\t\t       errno);\n\t\treturn 0;\n\t}\n\texpect_ok(0x80);\n\texpect_gp(0xed);\n\n\tprintf(\"[RUN]\\tdisable 0x80\\n\");\n\tif (ioperm(0x80, 1, 0) != 0) {\n\t\tprintf(\"[FAIL]\\tioperm(0x80, 1, 0) failed (%d)\", errno);\n\t\treturn 1;\n\t}\n\texpect_gp(0x80);\n\texpect_gp(0xed);\n\n\t \n\tif (ioperm(0x80, 1, 1) != 0) {\n\t\tprintf(\"[FAIL]\\tioperm(0x80, 1, 0) failed (%d)\", errno);\n\t\treturn 1;\n\t}\n\n\tpid_t child = fork();\n\tif (child == -1)\n\t\terr(1, \"fork\");\n\n\tif (child == 0) {\n\t\tprintf(\"[RUN]\\tchild: check that we inherited permissions\\n\");\n\t\texpect_ok(0x80);\n\t\texpect_gp(0xed);\n\t\tprintf(\"[RUN]\\tchild: Extend permissions to 0x81\\n\");\n\t\tif (ioperm(0x81, 1, 1) != 0) {\n\t\t\tprintf(\"[FAIL]\\tioperm(0x81, 1, 1) failed (%d)\", errno);\n\t\t\treturn 1;\n\t\t}\n\t\tprintf(\"[RUN]\\tchild: Drop permissions to 0x80\\n\");\n\t\tif (ioperm(0x80, 1, 0) != 0) {\n\t\t\tprintf(\"[FAIL]\\tioperm(0x80, 1, 0) failed (%d)\", errno);\n\t\t\treturn 1;\n\t\t}\n\t\texpect_gp(0x80);\n\t\treturn 0;\n\t} else {\n\t\tint status;\n\t\tif (waitpid(child, &status, 0) != child ||\n\t\t    !WIFEXITED(status)) {\n\t\t\tprintf(\"[FAIL]\\tChild died\\n\");\n\t\t\tnerrs++;\n\t\t} else if (WEXITSTATUS(status) != 0) {\n\t\t\tprintf(\"[FAIL]\\tChild failed\\n\");\n\t\t\tnerrs++;\n\t\t} else {\n\t\t\tprintf(\"[OK]\\tChild succeeded\\n\");\n\t\t}\n\t}\n\n\t \n\tprintf(\"\\tVerify that unsharing the bitmap worked\\n\");\n\texpect_ok(0x80);\n\n\t \n\tprintf(\"\\tDrop privileges\\n\");\n\tif (setresuid(1, 1, 1) != 0) {\n\t\tprintf(\"[WARN]\\tDropping privileges failed\\n\");\n\t\treturn 0;\n\t}\n\n\tprintf(\"[RUN]\\tdisable 0x80\\n\");\n\tif (ioperm(0x80, 1, 0) != 0) {\n\t\tprintf(\"[FAIL]\\tioperm(0x80, 1, 0) failed (%d)\", errno);\n\t\treturn 1;\n\t}\n\tprintf(\"[OK]\\tit worked\\n\");\n\n\tprintf(\"[RUN]\\tenable 0x80 again\\n\");\n\tif (ioperm(0x80, 1, 1) == 0) {\n\t\tprintf(\"[FAIL]\\tit succeeded but should have failed.\\n\");\n\t\treturn 1;\n\t}\n\tprintf(\"[OK]\\tit failed\\n\");\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}