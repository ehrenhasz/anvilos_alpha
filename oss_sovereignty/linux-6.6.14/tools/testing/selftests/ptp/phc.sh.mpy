{
  "module_name": "phc.sh",
  "hash_id": "09770bcf3064245d8c99f0d540930f0d3c54290856cb54540abbeb56a49607f7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/ptp/phc.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"\n\tsettime\n\tadjtime\n\tadjfreq\n\"\nDEV=$1\n\n##############################################################################\n# Sanity checks\n\nif [[ \"$(id -u)\" -ne 0 ]]; then\n\techo \"SKIP: need root privileges\"\n\texit 0\nfi\n\nif [[ \"$DEV\" == \"\" ]]; then\n\techo \"SKIP: PTP device not provided\"\n\texit 0\nfi\n\nrequire_command()\n{\n\tlocal cmd=$1; shift\n\n\tif [[ ! -x \"$(command -v \"$cmd\")\" ]]; then\n\t\techo \"SKIP: $cmd not installed\"\n\t\texit 1\n\tfi\n}\n\nphc_sanity()\n{\n\tphc_ctl $DEV get &> /dev/null\n\n\tif [ $? != 0 ]; then\n\t\techo \"SKIP: unknown clock $DEV: No such device\"\n\t\texit 1\n\tfi\n}\n\nrequire_command phc_ctl\nphc_sanity\n\n##############################################################################\n# Helpers\n\n# Exit status to return at the end. Set in case one of the tests fails.\nEXIT_STATUS=0\n# Per-test return value. Clear at the beginning of each test.\nRET=0\n\ncheck_err()\n{\n\tlocal err=$1\n\n\tif [[ $RET -eq 0 && $err -ne 0 ]]; then\n\t\tRET=$err\n\tfi\n}\n\nlog_test()\n{\n\tlocal test_name=$1\n\n\tif [[ $RET -ne 0 ]]; then\n\t\tEXIT_STATUS=1\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"$test_name\"\n\t\treturn 1\n\tfi\n\n\tprintf \"TEST: %-60s  [ OK ]\\n\" \"$test_name\"\n\treturn 0\n}\n\ntests_run()\n{\n\tlocal current_test\n\n\tfor current_test in ${TESTS:-$ALL_TESTS}; do\n\t\t$current_test\n\tdone\n}\n\n##############################################################################\n# Tests\n\nsettime_do()\n{\n\tlocal res\n\n\tres=$(phc_ctl $DEV set 0 wait 120.5 get 2> /dev/null \\\n\t\t| awk '/clock time is/{print $5}' \\\n\t\t| awk -F. '{print $1}')\n\n\t(( res == 120 ))\n}\n\nadjtime_do()\n{\n\tlocal res\n\n\tres=$(phc_ctl $DEV set 0 adj 10 get 2> /dev/null \\\n\t\t| awk '/clock time is/{print $5}' \\\n\t\t| awk -F. '{print $1}')\n\n\t(( res == 10 ))\n}\n\nadjfreq_do()\n{\n\tlocal res\n\n\t# Set the clock to be 1% faster\n\tres=$(phc_ctl $DEV freq 10000000 set 0 wait 100.5 get 2> /dev/null \\\n\t\t| awk '/clock time is/{print $5}' \\\n\t\t| awk -F. '{print $1}')\n\n\t(( res == 101 ))\n}\n\n##############################################################################\n\ncleanup()\n{\n\tphc_ctl $DEV freq 0.0 &> /dev/null\n\tphc_ctl $DEV set &> /dev/null\n}\n\nsettime()\n{\n\tRET=0\n\n\tsettime_do\n\tcheck_err $?\n\tlog_test \"settime\"\n\tcleanup\n}\n\nadjtime()\n{\n\tRET=0\n\n\tadjtime_do\n\tcheck_err $?\n\tlog_test \"adjtime\"\n\tcleanup\n}\n\nadjfreq()\n{\n\tRET=0\n\n\tadjfreq_do\n\tcheck_err $?\n\tlog_test \"adjfreq\"\n\tcleanup\n}\n\ntrap cleanup EXIT\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}