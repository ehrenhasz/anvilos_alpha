{
  "module_name": "rseq.c",
  "hash_id": "9dca520636de5967c04839b556a12e68370aa5b683d6a297cc4f311b32a8b8a1",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rseq/rseq.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <sched.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <syscall.h>\n#include <assert.h>\n#include <signal.h>\n#include <limits.h>\n#include <dlfcn.h>\n#include <stddef.h>\n#include <sys/auxv.h>\n#include <linux/auxvec.h>\n\n#include <linux/compiler.h>\n\n#include \"../kselftest.h\"\n#include \"rseq.h\"\n\n \n__weak ptrdiff_t __rseq_offset;\n__weak unsigned int __rseq_size;\n__weak unsigned int __rseq_flags;\n\nstatic const ptrdiff_t *libc_rseq_offset_p = &__rseq_offset;\nstatic const unsigned int *libc_rseq_size_p = &__rseq_size;\nstatic const unsigned int *libc_rseq_flags_p = &__rseq_flags;\n\n \nptrdiff_t rseq_offset;\n\n \nunsigned int rseq_size = -1U;\n\n \nunsigned int rseq_flags;\n\n \nunsigned int rseq_feature_size = -1U;\n\nstatic int rseq_ownership;\nstatic int rseq_reg_success;\t \n\n \n#define RSEQ_THREAD_AREA_ALLOC_SIZE\t1024\n\n \n#define ORIG_RSEQ_FEATURE_SIZE\t\t20\n\n \n#define ORIG_RSEQ_ALLOC_SIZE\t\t32\n\nstatic\n__thread struct rseq_abi __rseq_abi __attribute__((tls_model(\"initial-exec\"), aligned(RSEQ_THREAD_AREA_ALLOC_SIZE))) = {\n\t.cpu_id = RSEQ_ABI_CPU_ID_UNINITIALIZED,\n};\n\nstatic int sys_rseq(struct rseq_abi *rseq_abi, uint32_t rseq_len,\n\t\t    int flags, uint32_t sig)\n{\n\treturn syscall(__NR_rseq, rseq_abi, rseq_len, flags, sig);\n}\n\nstatic int sys_getcpu(unsigned *cpu, unsigned *node)\n{\n\treturn syscall(__NR_getcpu, cpu, node, NULL);\n}\n\nint rseq_available(void)\n{\n\tint rc;\n\n\trc = sys_rseq(NULL, 0, 0, 0);\n\tif (rc != -1)\n\t\tabort();\n\tswitch (errno) {\n\tcase ENOSYS:\n\t\treturn 0;\n\tcase EINVAL:\n\t\treturn 1;\n\tdefault:\n\t\tabort();\n\t}\n}\n\nint rseq_register_current_thread(void)\n{\n\tint rc;\n\n\tif (!rseq_ownership) {\n\t\t \n\t\treturn 0;\n\t}\n\trc = sys_rseq(&__rseq_abi, rseq_size, 0, RSEQ_SIG);\n\tif (rc) {\n\t\tif (RSEQ_READ_ONCE(rseq_reg_success)) {\n\t\t\t \n\t\t\tabort();\n\t\t}\n\t\treturn -1;\n\t}\n\tassert(rseq_current_cpu_raw() >= 0);\n\tRSEQ_WRITE_ONCE(rseq_reg_success, 1);\n\treturn 0;\n}\n\nint rseq_unregister_current_thread(void)\n{\n\tint rc;\n\n\tif (!rseq_ownership) {\n\t\t \n\t\treturn 0;\n\t}\n\trc = sys_rseq(&__rseq_abi, rseq_size, RSEQ_ABI_FLAG_UNREGISTER, RSEQ_SIG);\n\tif (rc)\n\t\treturn -1;\n\treturn 0;\n}\n\nstatic\nunsigned int get_rseq_feature_size(void)\n{\n\tunsigned long auxv_rseq_feature_size, auxv_rseq_align;\n\n\tauxv_rseq_align = getauxval(AT_RSEQ_ALIGN);\n\tassert(!auxv_rseq_align || auxv_rseq_align <= RSEQ_THREAD_AREA_ALLOC_SIZE);\n\n\tauxv_rseq_feature_size = getauxval(AT_RSEQ_FEATURE_SIZE);\n\tassert(!auxv_rseq_feature_size || auxv_rseq_feature_size <= RSEQ_THREAD_AREA_ALLOC_SIZE);\n\tif (auxv_rseq_feature_size)\n\t\treturn auxv_rseq_feature_size;\n\telse\n\t\treturn ORIG_RSEQ_FEATURE_SIZE;\n}\n\nstatic __attribute__((constructor))\nvoid rseq_init(void)\n{\n\t \n\tif (!*libc_rseq_size_p) {\n\t\tlibc_rseq_offset_p = dlsym(RTLD_NEXT, \"__rseq_offset\");\n\t\tlibc_rseq_size_p = dlsym(RTLD_NEXT, \"__rseq_size\");\n\t\tlibc_rseq_flags_p = dlsym(RTLD_NEXT, \"__rseq_flags\");\n\t}\n\tif (libc_rseq_size_p && libc_rseq_offset_p && libc_rseq_flags_p &&\n\t\t\t*libc_rseq_size_p != 0) {\n\t\t \n\t\trseq_offset = *libc_rseq_offset_p;\n\t\trseq_size = *libc_rseq_size_p;\n\t\trseq_flags = *libc_rseq_flags_p;\n\t\trseq_feature_size = get_rseq_feature_size();\n\t\tif (rseq_feature_size > rseq_size)\n\t\t\trseq_feature_size = rseq_size;\n\t\treturn;\n\t}\n\trseq_ownership = 1;\n\tif (!rseq_available()) {\n\t\trseq_size = 0;\n\t\trseq_feature_size = 0;\n\t\treturn;\n\t}\n\trseq_offset = (void *)&__rseq_abi - rseq_thread_pointer();\n\trseq_flags = 0;\n\trseq_feature_size = get_rseq_feature_size();\n\tif (rseq_feature_size == ORIG_RSEQ_FEATURE_SIZE)\n\t\trseq_size = ORIG_RSEQ_ALLOC_SIZE;\n\telse\n\t\trseq_size = RSEQ_THREAD_AREA_ALLOC_SIZE;\n}\n\nstatic __attribute__((destructor))\nvoid rseq_exit(void)\n{\n\tif (!rseq_ownership)\n\t\treturn;\n\trseq_offset = 0;\n\trseq_size = -1U;\n\trseq_feature_size = -1U;\n\trseq_ownership = 0;\n}\n\nint32_t rseq_fallback_current_cpu(void)\n{\n\tint32_t cpu;\n\n\tcpu = sched_getcpu();\n\tif (cpu < 0) {\n\t\tperror(\"sched_getcpu()\");\n\t\tabort();\n\t}\n\treturn cpu;\n}\n\nint32_t rseq_fallback_current_node(void)\n{\n\tuint32_t cpu_id, node_id;\n\tint ret;\n\n\tret = sys_getcpu(&cpu_id, &node_id);\n\tif (ret) {\n\t\tperror(\"sys_getcpu()\");\n\t\treturn ret;\n\t}\n\treturn (int32_t) node_id;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}