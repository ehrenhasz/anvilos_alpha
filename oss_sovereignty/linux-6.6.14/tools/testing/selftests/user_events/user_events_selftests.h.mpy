{
  "module_name": "user_events_selftests.h",
  "hash_id": "b476e2a14cf0f8f2a89cd1b82febadac989d92149e9c5397c5551cd5a0d51731",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/user_events/user_events_selftests.h",
  "human_readable_source": " \n\n#ifndef _USER_EVENTS_SELFTESTS_H\n#define _USER_EVENTS_SELFTESTS_H\n\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <errno.h>\n\n#include \"../kselftest.h\"\n\nstatic inline void tracefs_unmount(void)\n{\n\tumount(\"/sys/kernel/tracing\");\n}\n\nstatic inline bool tracefs_enabled(char **message, bool *fail, bool *umount)\n{\n\tstruct stat buf;\n\tint ret;\n\n\t*message = \"\";\n\t*fail = false;\n\t*umount = false;\n\n\t \n\tret = stat(\"/sys/kernel/tracing\", &buf);\n\n\tif (ret == -1) {\n\t\t*message = \"Tracefs is not installed\";\n\t\treturn false;\n\t}\n\n\t \n\tret = stat(\"/sys/kernel/tracing/README\", &buf);\n\n\tif (ret == -1 && errno == ENOENT) {\n\t\tif (mount(NULL, \"/sys/kernel/tracing\", \"tracefs\", 0, NULL) != 0) {\n\t\t\t*message = \"Cannot mount tracefs\";\n\t\t\t*fail = true;\n\t\t\treturn false;\n\t\t}\n\n\t\t*umount = true;\n\n\t\tret = stat(\"/sys/kernel/tracing/README\", &buf);\n\t}\n\n\tif (ret == -1) {\n\t\t*message = \"Cannot access tracefs\";\n\t\t*fail = true;\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic inline bool user_events_enabled(char **message, bool *fail, bool *umount)\n{\n\tstruct stat buf;\n\tint ret;\n\n\t*message = \"\";\n\t*fail = false;\n\t*umount = false;\n\n\tif (getuid() != 0) {\n\t\t*message = \"Must be run as root\";\n\t\t*fail = true;\n\t\treturn false;\n\t}\n\n\tif (!tracefs_enabled(message, fail, umount))\n\t\treturn false;\n\n\t \n\tret = stat(\"/sys/kernel/tracing/user_events_data\", &buf);\n\n\tif (ret == -1) {\n\t\tswitch (errno) {\n\t\tcase ENOENT:\n\t\t\t*message = \"user_events is not installed\";\n\t\t\treturn false;\n\n\t\tdefault:\n\t\t\t*message = \"Cannot access user_events_data\";\n\t\t\t*fail = true;\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\n#define USER_EVENT_FIXTURE_SETUP(statement, umount) do { \\\n\tchar *message; \\\n\tbool fail; \\\n\tif (!user_events_enabled(&message, &fail, &(umount))) { \\\n\t\tif (fail) { \\\n\t\t\tTH_LOG(\"Setup failed due to: %s\", message); \\\n\t\t\tASSERT_FALSE(fail); \\\n\t\t} \\\n\t\tSKIP(statement, \"Skipping due to: %s\", message); \\\n\t} \\\n} while (0)\n\n#define USER_EVENT_FIXTURE_TEARDOWN(umount) do { \\\n\tif ((umount))  \\\n\t\ttracefs_unmount(); \\\n} while (0)\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}