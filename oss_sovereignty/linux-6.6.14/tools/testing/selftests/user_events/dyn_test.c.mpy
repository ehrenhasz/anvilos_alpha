{
  "module_name": "dyn_test.c",
  "hash_id": "9a7b9d2d1f02e0a198563626ad80aa1f482e3ba8b2c7f432bec309ebb6677a74",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/user_events/dyn_test.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <linux/user_events.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <fcntl.h>\n#include <sys/ioctl.h>\n#include <sys/stat.h>\n#include <unistd.h>\n\n#include \"../kselftest_harness.h\"\n#include \"user_events_selftests.h\"\n\nconst char *abi_file = \"/sys/kernel/tracing/user_events_data\";\nconst char *enable_file = \"/sys/kernel/tracing/events/user_events/__test_event/enable\";\n\nstatic bool wait_for_delete(void)\n{\n\tint i;\n\n\tfor (i = 0; i < 1000; ++i) {\n\t\tint fd = open(enable_file, O_RDONLY);\n\n\t\tif (fd == -1)\n\t\t\treturn true;\n\n\t\tclose(fd);\n\t\tusleep(1000);\n\t}\n\n\treturn false;\n}\n\nstatic int reg_event(int fd, int *check, int bit, const char *value)\n{\n\tstruct user_reg reg = {0};\n\n\treg.size = sizeof(reg);\n\treg.name_args = (__u64)value;\n\treg.enable_bit = bit;\n\treg.enable_addr = (__u64)check;\n\treg.enable_size = sizeof(*check);\n\n\tif (ioctl(fd, DIAG_IOCSREG, &reg) == -1)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic int unreg_event(int fd, int *check, int bit)\n{\n\tstruct user_unreg unreg = {0};\n\n\tunreg.size = sizeof(unreg);\n\tunreg.disable_bit = bit;\n\tunreg.disable_addr = (__u64)check;\n\n\treturn ioctl(fd, DIAG_IOCSUNREG, &unreg);\n}\n\nstatic int parse(int *check, const char *value)\n{\n\tint fd = open(abi_file, O_RDWR);\n\tint ret;\n\n\tif (fd == -1)\n\t\treturn -1;\n\n\t \n\tif (value[0] != 'u' || value[1] != ':') {\n\t\tclose(fd);\n\t\treturn -1;\n\t}\n\n\tret = reg_event(fd, check, 31, value + 2);\n\n\tif (ret != -1) {\n\t\tif (unreg_event(fd, check, 31) == -1)\n\t\t\tprintf(\"WARN: Couldn't unreg event\\n\");\n\t}\n\n\tclose(fd);\n\n\treturn ret;\n}\n\nstatic int check_match(int *check, const char *first, const char *second, bool *match)\n{\n\tint fd = open(abi_file, O_RDWR);\n\tint ret = -1;\n\n\tif (fd == -1)\n\t\treturn -1;\n\n\tif (reg_event(fd, check, 31, first) == -1)\n\t\tgoto cleanup;\n\n\tif (reg_event(fd, check, 30, second) == -1) {\n\t\tif (errno == EADDRINUSE) {\n\t\t\t \n\t\t\t*match = false;\n\t\t\tret = 0;\n\t\t}\n\n\t\tgoto cleanup;\n\t}\n\n\t*match = true;\n\tret = 0;\ncleanup:\n\tunreg_event(fd, check, 31);\n\tunreg_event(fd, check, 30);\n\n\tclose(fd);\n\n\twait_for_delete();\n\n\treturn ret;\n}\n\n#define TEST_MATCH(x, y) \\\ndo { \\\n\tbool match; \\\n\tASSERT_NE(-1, check_match(&self->check, x, y, &match)); \\\n\tASSERT_EQ(true, match); \\\n} while (0)\n\n#define TEST_NMATCH(x, y) \\\ndo { \\\n\tbool match; \\\n\tASSERT_NE(-1, check_match(&self->check, x, y, &match)); \\\n\tASSERT_EQ(false, match); \\\n} while (0)\n\n#define TEST_PARSE(x) ASSERT_NE(-1, parse(&self->check, x))\n\n#define TEST_NPARSE(x) ASSERT_EQ(-1, parse(&self->check, x))\n\nFIXTURE(user) {\n\tint check;\n\tbool umount;\n};\n\nFIXTURE_SETUP(user) {\n\tUSER_EVENT_FIXTURE_SETUP(return, self->umount);\n}\n\nFIXTURE_TEARDOWN(user) {\n\tUSER_EVENT_FIXTURE_TEARDOWN(self->umount);\n\n\twait_for_delete();\n}\n\nTEST_F(user, basic_types) {\n\t \n\tTEST_PARSE(\"u:__test_event u64 a\");\n\tTEST_PARSE(\"u:__test_event u32 a\");\n\tTEST_PARSE(\"u:__test_event u16 a\");\n\tTEST_PARSE(\"u:__test_event u8 a\");\n\tTEST_PARSE(\"u:__test_event char a\");\n\tTEST_PARSE(\"u:__test_event unsigned char a\");\n\tTEST_PARSE(\"u:__test_event int a\");\n\tTEST_PARSE(\"u:__test_event unsigned int a\");\n\tTEST_PARSE(\"u:__test_event short a\");\n\tTEST_PARSE(\"u:__test_event unsigned short a\");\n\tTEST_PARSE(\"u:__test_event char[20] a\");\n\tTEST_PARSE(\"u:__test_event unsigned char[20] a\");\n\tTEST_PARSE(\"u:__test_event char[0x14] a\");\n\tTEST_PARSE(\"u:__test_event unsigned char[0x14] a\");\n\t \n\tTEST_NPARSE(\"u:__test_event char[aa] a\");\n\t \n\tTEST_NPARSE(\"u:__test_event char[9999] a\");\n\t \n\tTEST_NPARSE(\"u:__test_event char[0x0000000000001] a\");\n}\n\nTEST_F(user, loc_types) {\n\t \n\tTEST_PARSE(\"u:__test_event __data_loc char[] a\");\n\tTEST_PARSE(\"u:__test_event __data_loc unsigned char[] a\");\n\tTEST_PARSE(\"u:__test_event __rel_loc char[] a\");\n\tTEST_PARSE(\"u:__test_event __rel_loc unsigned char[] a\");\n}\n\nTEST_F(user, size_types) {\n\t \n\tTEST_PARSE(\"u:__test_event struct custom a 20\");\n\t \n\tTEST_NPARSE(\"u:__test_event struct custom a\");\n\t \n\tTEST_NPARSE(\"u:__test_event char a 20\");\n}\n\nTEST_F(user, matching) {\n\t \n\tTEST_MATCH(\"__test_event u32 a\",\n\t\t   \"__test_event u32 a\");\n\n\t \n\tTEST_MATCH(\"__test_event u32 a; u32 b\",\n\t\t   \"__test_event u32 a; u32 b\");\n\n\t \n\tTEST_MATCH(\"__test_event u32 a; u32 b\",\n\t\t   \"__test_event u32 a; u32 b;\");\n\n\t \n\tTEST_NMATCH(\"__test_event u32 a\",\n\t\t    \"__test_event u32 b\");\n\n\t \n\tTEST_NMATCH(\"__test_event u32 a; u32 b\",\n\t\t    \"__test_event u32 b; u32 a\");\n\n\t \n\tTEST_NMATCH(\"__test_event u64 a; u64 b\",\n\t\t    \"__test_event u32 a; u32 b\");\n\n\t \n\tTEST_MATCH(\"__test_event struct my_struct a 20\",\n\t\t   \"__test_event struct my_struct a 20\");\n\n\t \n\tTEST_NMATCH(\"__test_event struct my_struct a 20\",\n\t\t    \"__test_event struct my_struct b 20\");\n\n\t \n\tTEST_NMATCH(\"__test_event struct my_struct a 20\",\n\t\t    \"__test_event struct my_struct a 21\");\n}\n\nint main(int argc, char **argv)\n{\n\treturn test_harness_run(argc, argv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}