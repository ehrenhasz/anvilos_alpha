{
  "module_name": "fw_upload.sh",
  "hash_id": "66604e088c8276add601d918aa445aa4ff98b3ad9ed5033cc9216fc20e423897",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/firmware/fw_upload.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n# This validates the user-initiated fw upload mechanism of the firmware\n# loader. It verifies that one or more firmware devices can be created\n# for a device driver. It also verifies the data transfer, the\n# cancellation support, and the error flows.\nset -e\n\nTEST_REQS_FW_UPLOAD=\"yes\"\nTEST_DIR=$(dirname $0)\n\nprogress_states=\"preparing transferring  programming\"\nerrors=\"hw-error\n\ttimeout\n\tdevice-busy\n\tinvalid-file-size\n\tread-write-error\n\tflash-wearout\"\nerror_abort=\"user-abort\"\nfwname1=fw1\nfwname2=fw2\nfwname3=fw3\n\nsource $TEST_DIR/fw_lib.sh\n\ncheck_mods\ncheck_setup\nverify_reqs\n\ntrap \"upload_finish\" EXIT\n\nupload_finish() {\n\tlocal fwdevs=\"$fwname1 $fwname2 $fwname3\"\n\n\tfor name in $fwdevs; do\n\t\tif [ -e \"$DIR/$name\" ]; then\n\t\t\techo -n \"$name\" > \"$DIR\"/upload_unregister\n\t\tfi\n\tdone\n}\n\nupload_fw() {\n\tlocal name=\"$1\"\n\tlocal file=\"$2\"\n\n\techo 1 > \"$DIR\"/\"$name\"/loading\n\tcat \"$file\" > \"$DIR\"/\"$name\"/data\n\techo 0 > \"$DIR\"/\"$name\"/loading\n}\n\nverify_fw() {\n\tlocal name=\"$1\"\n\tlocal file=\"$2\"\n\n\techo -n \"$name\" > \"$DIR\"/config_upload_name\n\tif ! cmp \"$file\" \"$DIR\"/upload_read > /dev/null 2>&1; then\n\t\techo \"$0: firmware compare for $name did not match\" >&2\n\t\texit 1\n\tfi\n\n\techo \"$0: firmware upload for $name works\" >&2\n\treturn 0\n}\n\ninject_error() {\n\tlocal name=\"$1\"\n\tlocal status=\"$2\"\n\tlocal error=\"$3\"\n\n\techo 1 > \"$DIR\"/\"$name\"/loading\n\techo -n \"inject\":\"$status\":\"$error\" > \"$DIR\"/\"$name\"/data\n\techo 0 > \"$DIR\"/\"$name\"/loading\n}\n\nawait_status() {\n\tlocal name=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal status\n\tlocal i\n\n\tlet i=0\n\twhile [ $i -lt 50 ]; do\n\t\tstatus=$(cat \"$DIR\"/\"$name\"/status)\n\t\tif [ \"$status\" = \"$expected\" ]; then\n\t\t\treturn 0;\n\t\tfi\n\t\tsleep 1e-03\n\t\tlet i=$i+1\n\tdone\n\n\techo \"$0: Invalid status: Expected $expected, Actual $status\" >&2\n\treturn 1;\n}\n\nawait_idle() {\n\tlocal name=\"$1\"\n\n\tawait_status \"$name\" \"idle\"\n\treturn $?\n}\n\nexpect_error() {\n\tlocal name=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal error=$(cat \"$DIR\"/\"$name\"/error)\n\n\tif [ \"$error\" != \"$expected\" ]; then\n\t\techo \"Invalid error: Expected $expected, Actual $error\" >&2\n\t\treturn 1\n\tfi\n\n\treturn 0\n}\n\nrandom_firmware() {\n\tlocal bs=\"$1\"\n\tlocal count=\"$2\"\n\tlocal file=$(mktemp -p /tmp uploadfwXXX.bin)\n\n\tdd if=/dev/urandom of=\"$file\" bs=\"$bs\" count=\"$count\" > /dev/null 2>&1\n\techo \"$file\"\n}\n\ntest_upload_cancel() {\n\tlocal name=\"$1\"\n\tlocal status\n\n\tfor status in $progress_states; do\n\t\tinject_error $name $status $error_abort\n\t\tif ! await_status $name $status; then\n\t\t\texit 1\n\t\tfi\n\n\t\techo 1 > \"$DIR\"/\"$name\"/cancel\n\n\t\tif ! await_idle $name; then\n\t\t\texit 1\n\t\tfi\n\n\t\tif ! expect_error $name \"$status\":\"$error_abort\"; then\n\t\t\texit 1\n\t\tfi\n\tdone\n\n\techo \"$0: firmware upload cancellation works\"\n\treturn 0\n}\n\ntest_error_handling() {\n\tlocal name=$1\n\tlocal status\n\tlocal error\n\n\tfor status in $progress_states; do\n\t\tfor error in $errors; do\n\t\t\tinject_error $name $status $error\n\n\t\t\tif ! await_idle $name; then\n\t\t\t\texit 1\n\t\t\tfi\n\n\t\t\tif ! expect_error $name \"$status\":\"$error\"; then\n\t\t\t\texit 1\n\t\t\tfi\n\n\t\tdone\n\tdone\n\techo \"$0: firmware upload error handling works\"\n}\n\ntest_fw_too_big() {\n\tlocal name=$1\n\tlocal fw_too_big=`random_firmware 512 5`\n\tlocal expected=\"preparing:invalid-file-size\"\n\n\tupload_fw $name $fw_too_big\n\trm -f $fw_too_big\n\n\tif ! await_idle $name; then\n\t\texit 1\n\tfi\n\n\tif ! expect_error $name $expected; then\n\t\texit 1\n\tfi\n\n\techo \"$0: oversized firmware error handling works\"\n}\n\necho -n \"$fwname1\" > \"$DIR\"/upload_register\necho -n \"$fwname2\" > \"$DIR\"/upload_register\necho -n \"$fwname3\" > \"$DIR\"/upload_register\n\ntest_upload_cancel $fwname1\ntest_error_handling $fwname1\ntest_fw_too_big $fwname1\n\nfw_file1=`random_firmware 512 4`\nfw_file2=`random_firmware 512 3`\nfw_file3=`random_firmware 512 2`\n\nupload_fw $fwname1 $fw_file1\nupload_fw $fwname2 $fw_file2\nupload_fw $fwname3 $fw_file3\n\nverify_fw ${fwname1} ${fw_file1}\nverify_fw ${fwname2} ${fw_file2}\nverify_fw ${fwname3} ${fw_file3}\n\necho -n \"$fwname1\" > \"$DIR\"/upload_unregister\necho -n \"$fwname2\" > \"$DIR\"/upload_unregister\necho -n \"$fwname3\" > \"$DIR\"/upload_unregister\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}