{
  "module_name": "fw_namespace.c",
  "hash_id": "c46454b4e78b9fd57696f547a045f8fbebdca4445e0bb743142cf02b311ca5a6",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/firmware/fw_namespace.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <sched.h>\n#include <stdarg.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mount.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n\n#ifndef CLONE_NEWNS\n# define CLONE_NEWNS 0x00020000\n#endif\n\nstatic char *fw_path = NULL;\n\nstatic void die(char *fmt, ...)\n{\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tvfprintf(stderr, fmt, ap);\n\tva_end(ap);\n\tif (fw_path)\n\t\tunlink(fw_path);\n\tumount(\"/lib/firmware\");\n\texit(EXIT_FAILURE);\n}\n\nstatic void trigger_fw(const char *fw_name, const char *sys_path)\n{\n\tint fd;\n\n\tfd = open(sys_path, O_WRONLY);\n\tif (fd < 0)\n\t\tdie(\"open failed: %s\\n\",\n\t\t    strerror(errno));\n\tif (write(fd, fw_name, strlen(fw_name)) != strlen(fw_name))\n\t\texit(EXIT_FAILURE);\n\tclose(fd);\n}\n\nstatic void setup_fw(const char *fw_path)\n{\n\tint fd;\n\tconst char fw[] = \"ABCD0123\";\n\n\tfd = open(fw_path, O_WRONLY | O_CREAT, 0600);\n\tif (fd < 0)\n\t\tdie(\"open failed: %s\\n\",\n\t\t    strerror(errno));\n\tif (write(fd, fw, sizeof(fw) -1) != sizeof(fw) -1)\n\t\tdie(\"write failed: %s\\n\",\n\t\t    strerror(errno));\n\tclose(fd);\n}\n\nstatic bool test_fw_in_ns(const char *fw_name, const char *sys_path, bool block_fw_in_parent_ns)\n{\n\tpid_t child;\n\n\tif (block_fw_in_parent_ns)\n\t\tif (mount(\"test\", \"/lib/firmware\", \"tmpfs\", MS_RDONLY, NULL) == -1)\n\t\t\tdie(\"blocking firmware in parent ns failed\\n\");\n\n\tchild = fork();\n\tif (child == -1) {\n\t\tdie(\"fork failed: %s\\n\",\n\t\t\tstrerror(errno));\n\t}\n\tif (child != 0) {  \n\t\tpid_t pid;\n\t\tint status;\n\n\t\tpid = waitpid(child, &status, 0);\n\t\tif (pid == -1) {\n\t\t\tdie(\"waitpid failed: %s\\n\",\n\t\t\t\tstrerror(errno));\n\t\t}\n\t\tif (pid != child) {\n\t\t\tdie(\"waited for %d got %d\\n\",\n\t\t\t\tchild, pid);\n\t\t}\n\t\tif (!WIFEXITED(status)) {\n\t\t\tdie(\"child did not terminate cleanly\\n\");\n\t\t}\n\t\tif (block_fw_in_parent_ns)\n\t\t\tumount(\"/lib/firmware\");\n\t\treturn WEXITSTATUS(status) == EXIT_SUCCESS;\n\t}\n\n\tif (unshare(CLONE_NEWNS) != 0) {\n\t\tdie(\"unshare(CLONE_NEWNS) failed: %s\\n\",\n\t\t\tstrerror(errno));\n\t}\n\tif (mount(NULL, \"/\", NULL, MS_SLAVE|MS_REC, NULL) == -1)\n\t\tdie(\"remount root in child ns failed\\n\");\n\n\tif (!block_fw_in_parent_ns) {\n\t\tif (mount(\"test\", \"/lib/firmware\", \"tmpfs\", MS_RDONLY, NULL) == -1)\n\t\t\tdie(\"blocking firmware in child ns failed\\n\");\n\t} else\n\t\tumount(\"/lib/firmware\");\n\n\ttrigger_fw(fw_name, sys_path);\n\n\texit(EXIT_SUCCESS);\n}\n\nint main(int argc, char **argv)\n{\n\tconst char *fw_name = \"test-firmware.bin\";\n\tchar *sys_path;\n\tif (argc != 2)\n\t\tdie(\"usage: %s sys_path\\n\", argv[0]);\n\n\t \n\tif (mount(\"test\", \"/lib/firmware\", \"tmpfs\", 0, NULL) == -1)\n\t\tdie(\"mounting tmpfs to /lib/firmware failed\\n\");\n\n\tsys_path = argv[1];\n\tif (asprintf(&fw_path, \"/lib/firmware/%s\", fw_name) < 0)\n\t\tdie(\"error: failed to build full fw_path\\n\");\n\n\tsetup_fw(fw_path);\n\n\tsetvbuf(stdout, NULL, _IONBF, 0);\n\t \n\tprintf(\"Testing with firmware in parent namespace (assumed to be same file system as PID1)\\n\");\n\tif (!test_fw_in_ns(fw_name, sys_path, false))\n\t\tdie(\"error: failed to access firmware\\n\");\n\n\t \n\tprintf(\"Testing with firmware in child namespace\\n\");\n\tif (test_fw_in_ns(fw_name, sys_path, true))\n\t\tdie(\"error: firmware access did not fail\\n\");\n\n\tunlink(fw_path);\n\tfree(fw_path);\n\tumount(\"/lib/firmware\");\n\texit(EXIT_SUCCESS);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}