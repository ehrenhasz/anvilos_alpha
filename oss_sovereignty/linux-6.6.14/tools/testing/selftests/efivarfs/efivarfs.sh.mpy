{
  "module_name": "efivarfs.sh",
  "hash_id": "ea30de83a6cb548591e67958f46e0d894b48d71023d390ff134ab9722ea8220b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/efivarfs/efivarfs.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nefivarfs_mount=/sys/firmware/efi/efivars\ntest_guid=210be57c-9849-4fc7-a635-e6382d1aec27\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nfile_cleanup()\n{\n\tchattr -i $1\n\trm -f $1\n}\n\ncheck_prereqs()\n{\n\tlocal msg=\"skip all tests:\"\n\n\tif [ $UID != 0 ]; then\n\t\techo $msg must be run as root >&2\n\t\texit $ksft_skip\n\tfi\n\n\tif ! grep -q \"^\\S\\+ $efivarfs_mount efivarfs\" /proc/mounts; then\n\t\techo $msg efivarfs is not mounted on $efivarfs_mount >&2\n\t\texit $ksft_skip\n\tfi\n}\n\nrun_test()\n{\n\tlocal test=\"$1\"\n\n\techo \"--------------------\"\n\techo \"running $test\"\n\techo \"--------------------\"\n\n\tif [ \"$(type -t $test)\" = 'function' ]; then\n\t\t( $test )\n\telse\n\t\t( ./$test )\n\tfi\n\n\tif [ $? -ne 0 ]; then\n\t\techo \"  [FAIL]\"\n\t\trc=1\n\telse\n\t\techo \"  [PASS]\"\n\tfi\n}\n\ntest_create()\n{\n\tlocal attrs='\\x07\\x00\\x00\\x00'\n\tlocal file=$efivarfs_mount/$FUNCNAME-$test_guid\n\n\tprintf \"$attrs\\x00\" > $file\n\n\tif [ ! -e $file ]; then\n\t\techo \"$file couldn't be created\" >&2\n\t\texit 1\n\tfi\n\n\tif [ $(stat -c %s $file) -ne 5 ]; then\n\t\techo \"$file has invalid size\" >&2\n\t\tfile_cleanup $file\n\t\texit 1\n\tfi\n\tfile_cleanup $file\n}\n\ntest_create_empty()\n{\n\tlocal file=$efivarfs_mount/$FUNCNAME-$test_guid\n\n\t: > $file\n\n\tif [ ! -e $file ]; then\n\t\techo \"$file can not be created without writing\" >&2\n\t\texit 1\n\tfi\n\tfile_cleanup $file\n}\n\ntest_create_read()\n{\n\tlocal file=$efivarfs_mount/$FUNCNAME-$test_guid\n\t./create-read $file\n\tif [ $? -ne 0 ]; then\n\t\techo \"create and read $file failed\"\n\t\tfile_cleanup $file\n\t\texit 1\n\tfi\n\tfile_cleanup $file\n}\n\ntest_delete()\n{\n\tlocal attrs='\\x07\\x00\\x00\\x00'\n\tlocal file=$efivarfs_mount/$FUNCNAME-$test_guid\n\n\tprintf \"$attrs\\x00\" > $file\n\n\tif [ ! -e $file ]; then\n\t\techo \"$file couldn't be created\" >&2\n\t\texit 1\n\tfi\n\n\tfile_cleanup $file\n\n\tif [ -e $file ]; then\n\t\techo \"$file couldn't be deleted\" >&2\n\t\texit 1\n\tfi\n\n}\n\n# test that we can remove a variable by issuing a write with only\n# attributes specified\ntest_zero_size_delete()\n{\n\tlocal attrs='\\x07\\x00\\x00\\x00'\n\tlocal file=$efivarfs_mount/$FUNCNAME-$test_guid\n\n\tprintf \"$attrs\\x00\" > $file\n\n\tif [ ! -e $file ]; then\n\t\techo \"$file does not exist\" >&2\n\t\texit 1\n\tfi\n\n\tchattr -i $file\n\tprintf \"$attrs\" > $file\n\n\tif [ -e $file ]; then\n\t\techo \"$file should have been deleted\" >&2\n\t\texit 1\n\tfi\n}\n\ntest_open_unlink()\n{\n\tlocal file=$efivarfs_mount/$FUNCNAME-$test_guid\n\t./open-unlink $file\n}\n\n# test that we can create a range of filenames\ntest_valid_filenames()\n{\n\tlocal attrs='\\x07\\x00\\x00\\x00'\n\tlocal ret=0\n\n\tlocal file_list=\"abc dump-type0-11-1-1362436005 1234 -\"\n\tfor f in $file_list; do\n\t\tlocal file=$efivarfs_mount/$f-$test_guid\n\n\t\tprintf \"$attrs\\x00\" > $file\n\n\t\tif [ ! -e $file ]; then\n\t\t\techo \"$file could not be created\" >&2\n\t\t\tret=1\n\t\telse\n\t\t\tfile_cleanup $file\n\t\tfi\n\tdone\n\n\texit $ret\n}\n\ntest_invalid_filenames()\n{\n\tlocal attrs='\\x07\\x00\\x00\\x00'\n\tlocal ret=0\n\n\tlocal file_list=\"\n\t\t-1234-1234-1234-123456789abc\n\t\tfoo\n\t\tfoo-bar\n\t\t-foo-\n\t\tfoo-barbazba-foob-foob-foob-foobarbazfoo\n\t\tfoo-------------------------------------\n\t\t-12345678-1234-1234-1234-123456789abc\n\t\ta-12345678=1234-1234-1234-123456789abc\n\t\ta-12345678-1234=1234-1234-123456789abc\n\t\ta-12345678-1234-1234=1234-123456789abc\n\t\ta-12345678-1234-1234-1234=123456789abc\n\t\t1112345678-1234-1234-1234-123456789abc\"\n\n\tfor f in $file_list; do\n\t\tlocal file=$efivarfs_mount/$f\n\n\t\tprintf \"$attrs\\x00\" 2>/dev/null > $file\n\n\t\tif [ -e $file ]; then\n\t\t\techo \"Creating $file should have failed\" >&2\n\t\t\tfile_cleanup $file\n\t\t\tret=1\n\t\tfi\n\tdone\n\n\texit $ret\n}\n\ncheck_prereqs\n\nrc=0\n\nrun_test test_create\nrun_test test_create_empty\nrun_test test_create_read\nrun_test test_delete\nrun_test test_zero_size_delete\nrun_test test_open_unlink\nrun_test test_valid_filenames\nrun_test test_invalid_filenames\n\nexit $rc\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}