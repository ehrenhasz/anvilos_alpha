{
  "module_name": "open-unlink.c",
  "hash_id": "fe4413ec9b791dd6a7cb2a88ae79f34e75a758069216db0b4b663a80d263f8bf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/efivarfs/open-unlink.c",
  "human_readable_source": "\n#include <errno.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/ioctl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <linux/fs.h>\n\nstatic int set_immutable(const char *path, int immutable)\n{\n\tunsigned int flags;\n\tint fd;\n\tint rc;\n\tint error;\n\n\tfd = open(path, O_RDONLY);\n\tif (fd < 0)\n\t\treturn fd;\n\n\trc = ioctl(fd, FS_IOC_GETFLAGS, &flags);\n\tif (rc < 0) {\n\t\terror = errno;\n\t\tclose(fd);\n\t\terrno = error;\n\t\treturn rc;\n\t}\n\n\tif (immutable)\n\t\tflags |= FS_IMMUTABLE_FL;\n\telse\n\t\tflags &= ~FS_IMMUTABLE_FL;\n\n\trc = ioctl(fd, FS_IOC_SETFLAGS, &flags);\n\terror = errno;\n\tclose(fd);\n\terrno = error;\n\treturn rc;\n}\n\nstatic int get_immutable(const char *path)\n{\n\tunsigned int flags;\n\tint fd;\n\tint rc;\n\tint error;\n\n\tfd = open(path, O_RDONLY);\n\tif (fd < 0)\n\t\treturn fd;\n\n\trc = ioctl(fd, FS_IOC_GETFLAGS, &flags);\n\tif (rc < 0) {\n\t\terror = errno;\n\t\tclose(fd);\n\t\terrno = error;\n\t\treturn rc;\n\t}\n\tclose(fd);\n\tif (flags & FS_IMMUTABLE_FL)\n\t\treturn 1;\n\treturn 0;\n}\n\nint main(int argc, char **argv)\n{\n\tconst char *path;\n\tchar buf[5];\n\tint fd, rc;\n\n\tif (argc < 2) {\n\t\tfprintf(stderr, \"usage: %s <path>\\n\", argv[0]);\n\t\treturn EXIT_FAILURE;\n\t}\n\n\tpath = argv[1];\n\n\t \n\t*(uint32_t *)buf = 0x7;\n\tbuf[4] = 0;\n\n\t \n\tfd = open(path, O_WRONLY | O_CREAT, 0600);\n\tif (fd < 0) {\n\t\tperror(\"open(O_WRONLY)\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\trc = write(fd, buf, sizeof(buf));\n\tif (rc != sizeof(buf)) {\n\t\tperror(\"write\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\tclose(fd);\n\n\trc = get_immutable(path);\n\tif (rc < 0) {\n\t\tperror(\"ioctl(FS_IOC_GETFLAGS)\");\n\t\treturn EXIT_FAILURE;\n\t} else if (rc) {\n\t\trc = set_immutable(path, 0);\n\t\tif (rc < 0) {\n\t\t\tperror(\"ioctl(FS_IOC_SETFLAGS)\");\n\t\t\treturn EXIT_FAILURE;\n\t\t}\n\t}\n\n\tfd = open(path, O_RDONLY);\n\tif (fd < 0) {\n\t\tperror(\"open\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\tif (unlink(path) < 0) {\n\t\tperror(\"unlink\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\trc = read(fd, buf, sizeof(buf));\n\tif (rc > 0) {\n\t\tfprintf(stderr, \"reading from an unlinked variable \"\n\t\t\t\t\"shouldn't be possible\\n\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\treturn EXIT_SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}