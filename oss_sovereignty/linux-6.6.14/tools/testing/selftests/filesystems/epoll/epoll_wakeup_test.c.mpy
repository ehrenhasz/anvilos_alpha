{
  "module_name": "epoll_wakeup_test.c",
  "hash_id": "a8053570da0e130d88c7b8b5fd31beb8ce1c3fee91c26b829276a25abd7f5ba8",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/filesystems/epoll/epoll_wakeup_test.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <asm/unistd.h>\n#include <linux/time_types.h>\n#include <poll.h>\n#include <unistd.h>\n#include <assert.h>\n#include <signal.h>\n#include <pthread.h>\n#include <sys/epoll.h>\n#include <sys/socket.h>\n#include <sys/eventfd.h>\n#include \"../../kselftest_harness.h\"\n\nstruct epoll_mtcontext\n{\n\tint efd[3];\n\tint sfd[4];\n\tvolatile int count;\n\n\tpthread_t main;\n\tpthread_t waiter;\n};\n\n#ifndef __NR_epoll_pwait2\n#define __NR_epoll_pwait2 -1\n#endif\n\nstatic inline int sys_epoll_pwait2(int fd, struct epoll_event *events,\n\t\t\t\t   int maxevents,\n\t\t\t\t   const struct __kernel_timespec *timeout,\n\t\t\t\t   const sigset_t *sigset, size_t sigsetsize)\n{\n\treturn syscall(__NR_epoll_pwait2, fd, events, maxevents, timeout,\n\t\t       sigset, sigsetsize);\n}\n\nstatic void signal_handler(int signum)\n{\n}\n\nstatic void kill_timeout(struct epoll_mtcontext *ctx)\n{\n\tusleep(1000000);\n\tpthread_kill(ctx->main, SIGUSR1);\n\tpthread_kill(ctx->waiter, SIGUSR1);\n}\n\nstatic void *waiter_entry1a(void *data)\n{\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext *ctx = data;\n\n\tif (epoll_wait(ctx->efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx->count, 1);\n\n\treturn NULL;\n}\n\nstatic void *waiter_entry1ap(void *data)\n{\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext *ctx = data;\n\n\tpfd.fd = ctx->efd[0];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx->efd[0], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx->count, 1);\n\t}\n\n\treturn NULL;\n}\n\nstatic void *waiter_entry1o(void *data)\n{\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext *ctx = data;\n\n\tif (epoll_wait(ctx->efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx->count, 1);\n\n\treturn NULL;\n}\n\nstatic void *waiter_entry1op(void *data)\n{\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext *ctx = data;\n\n\tpfd.fd = ctx->efd[0];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx->efd[0], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_or(&ctx->count, 1);\n\t}\n\n\treturn NULL;\n}\n\nstatic void *waiter_entry2a(void *data)\n{\n\tstruct epoll_event events[2];\n\tstruct epoll_mtcontext *ctx = data;\n\n\tif (epoll_wait(ctx->efd[0], events, 2, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx->count, 1);\n\n\treturn NULL;\n}\n\nstatic void *waiter_entry2ap(void *data)\n{\n\tstruct pollfd pfd;\n\tstruct epoll_event events[2];\n\tstruct epoll_mtcontext *ctx = data;\n\n\tpfd.fd = ctx->efd[0];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx->efd[0], events, 2, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx->count, 1);\n\t}\n\n\treturn NULL;\n}\n\nstatic void *emitter_entry1(void *data)\n{\n\tstruct epoll_mtcontext *ctx = data;\n\n\tusleep(100000);\n\twrite(ctx->sfd[1], \"w\", 1);\n\n\tkill_timeout(ctx);\n\n\treturn NULL;\n}\n\nstatic void *emitter_entry2(void *data)\n{\n\tstruct epoll_mtcontext *ctx = data;\n\n\tusleep(100000);\n\twrite(ctx->sfd[1], \"w\", 1);\n\twrite(ctx->sfd[3], \"w\", 1);\n\n\tkill_timeout(ctx);\n\n\treturn NULL;\n}\n\n \nTEST(epoll1)\n{\n\tint efd;\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd, &e, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd, &e, 1, 0), 1);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll2)\n{\n\tint efd;\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd, &e, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd, &e, 1, 0), 0);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll3)\n{\n\tint efd;\n\tint sfd[4];\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 2);\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 2);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll4)\n{\n\tint efd;\n\tint sfd[4];\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 2);\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 0);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll5)\n{\n\tint efd;\n\tint sfd[2];\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tASSERT_EQ(poll(&pfd, 1, 0), 1);\n\tASSERT_EQ(epoll_wait(efd, &e, 1, 0), 1);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tASSERT_EQ(poll(&pfd, 1, 0), 1);\n\tASSERT_EQ(epoll_wait(efd, &e, 1, 0), 1);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll6)\n{\n\tint efd;\n\tint sfd[2];\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tASSERT_EQ(poll(&pfd, 1, 0), 1);\n\tASSERT_EQ(epoll_wait(efd, &e, 1, 0), 1);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tASSERT_EQ(poll(&pfd, 1, 0), 0);\n\tASSERT_EQ(epoll_wait(efd, &e, 1, 0), 0);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \n\nTEST(epoll7)\n{\n\tint efd;\n\tint sfd[4];\n\tstruct pollfd pfd;\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 2);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 2);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll8)\n{\n\tint efd;\n\tint sfd[4];\n\tstruct pollfd pfd;\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 2);\n\n\tpfd.fd = efd;\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 0);\n\tEXPECT_EQ(epoll_wait(efd, events, 2, 0), 0);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll9)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll10)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 1);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll11)\n{\n\tpthread_t emitter;\n\tstruct epoll_event events[2];\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[2], events), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry2a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], events, 2, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll12)\n{\n\tpthread_t emitter;\n\tstruct epoll_event events[2];\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[2], events), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], events, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll13)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll14)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 1);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll15)\n{\n\tpthread_t emitter;\n\tstruct epoll_event events[2];\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[2], events), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry2ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], events, 2, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll16)\n{\n\tpthread_t emitter;\n\tstruct epoll_event events[2];\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[2], events), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], events, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll17)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll18)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll19)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 0);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll20)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 0);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll21)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll22)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll23)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 0);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 0);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll24)\n{\n\tint efd[2];\n\tint sfd[2];\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 0);\n\tEXPECT_EQ(epoll_wait(efd[0], &e, 1, 0), 0);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll25)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll26)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll27)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 1);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll28)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 1);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll29)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll30)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll31)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 1);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll32)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 1);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll33)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll34)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1o, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx.count, 2);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll35)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll36)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1o, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx.count, 2);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll37)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tpfd.fd = ctx.efd[1];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[1], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx.count, 1);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll38)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1o, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tpfd.fd = ctx.efd[1];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[1], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_or(&ctx.count, 2);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll39)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tpfd.fd = ctx.efd[1];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[1], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx.count, 1);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll40)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1o, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tpfd.fd = ctx.efd[1];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[1], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_or(&ctx.count, 2);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll41)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll42)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1op, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx.count, 2);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll43)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll44)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1op, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx.count, 2);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll45)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tpfd.fd = ctx.efd[1];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[1], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx.count, 1);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll46)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1op, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx.count, 2);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll47)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tpfd.fd = ctx.efd[1];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[1], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx.count, 1);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll48)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1op, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry1, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[1], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_or(&ctx.count, 2);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_TRUE((ctx.count == 2) || (ctx.count == 3));\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\n \nTEST(epoll49)\n{\n\tint efd[3];\n\tint sfd[4];\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\tefd[2] = epoll_create(1);\n\tASSERT_GE(efd[2], 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[2], EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 2);\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 2);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(efd[2]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll50)\n{\n\tint efd[3];\n\tint sfd[4];\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\tefd[2] = epoll_create(1);\n\tASSERT_GE(efd[2], 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[2], EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 2);\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 0);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(efd[2]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll51)\n{\n\tint efd[3];\n\tint sfd[4];\n\tstruct pollfd pfd;\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\tefd[2] = epoll_create(1);\n\tASSERT_GE(efd[2], 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[2], EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 2);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 2);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(efd[2]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll52)\n{\n\tint efd[3];\n\tint sfd[4];\n\tstruct pollfd pfd;\n\tstruct epoll_event events[2];\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &sfd[2]), 0);\n\n\tefd[0] = epoll_create(1);\n\tASSERT_GE(efd[0], 0);\n\n\tefd[1] = epoll_create(1);\n\tASSERT_GE(efd[1], 0);\n\n\tefd[2] = epoll_create(1);\n\tASSERT_GE(efd[2], 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[1], EPOLL_CTL_ADD, sfd[0], events), 0);\n\n\tevents[0].events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd[2], EPOLL_CTL_ADD, sfd[2], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[1], events), 0);\n\n\tevents[0].events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(efd[0], EPOLL_CTL_ADD, efd[2], events), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\tASSERT_EQ(write(sfd[3], \"w\", 1), 1);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 1);\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 2);\n\n\tpfd.fd = efd[0];\n\tpfd.events = POLLIN;\n\tEXPECT_EQ(poll(&pfd, 1, 0), 0);\n\tEXPECT_EQ(epoll_wait(efd[0], events, 2, 0), 0);\n\n\tclose(efd[0]);\n\tclose(efd[1]);\n\tclose(efd[2]);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n\tclose(sfd[2]);\n\tclose(sfd[3]);\n}\n\n \nTEST(epoll53)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\tctx.efd[2] = epoll_create(1);\n\tASSERT_GE(ctx.efd[2], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[2], EPOLL_CTL_ADD, ctx.sfd[2], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[2], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.efd[2]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll54)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\tctx.efd[2] = epoll_create(1);\n\tASSERT_GE(ctx.efd[2], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[2], EPOLL_CTL_ADD, ctx.sfd[2], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[2], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.efd[2]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll55)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\tctx.efd[2] = epoll_create(1);\n\tASSERT_GE(ctx.efd[2], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[2], EPOLL_CTL_ADD, ctx.sfd[2], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[2], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.efd[2]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll56)\n{\n\tpthread_t emitter;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\tctx.efd[2] = epoll_create(1);\n\tASSERT_GE(ctx.efd[2], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[2], EPOLL_CTL_ADD, ctx.sfd[2], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[2], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tif (epoll_wait(ctx.efd[0], &e, 1, -1) > 0)\n\t\t__sync_fetch_and_add(&ctx.count, 1);\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.efd[2]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll57)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\tctx.efd[2] = epoll_create(1);\n\tASSERT_GE(ctx.efd[2], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[2], EPOLL_CTL_ADD, ctx.sfd[2], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[2], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tpfd.fd = ctx.efd[0];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[0], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx.count, 1);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.efd[2]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\n \nTEST(epoll58)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[0]), 0);\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, &ctx.sfd[2]), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.efd[1] = epoll_create(1);\n\tASSERT_GE(ctx.efd[1], 0);\n\n\tctx.efd[2] = epoll_create(1);\n\tASSERT_GE(ctx.efd[2], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[1], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[2], EPOLL_CTL_ADD, ctx.sfd[2], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[1], &e), 0);\n\n\te.events = EPOLLIN | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.efd[2], &e), 0);\n\n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&ctx.waiter, NULL, waiter_entry1ap, &ctx), 0);\n\tASSERT_EQ(pthread_create(&emitter, NULL, emitter_entry2, &ctx), 0);\n\n\tpfd.fd = ctx.efd[0];\n\tpfd.events = POLLIN;\n\tif (poll(&pfd, 1, -1) > 0) {\n\t\tif (epoll_wait(ctx.efd[0], &e, 1, 0) > 0)\n\t\t\t__sync_fetch_and_add(&ctx.count, 1);\n\t}\n\n\tASSERT_EQ(pthread_join(ctx.waiter, NULL), 0);\n\tEXPECT_EQ(ctx.count, 2);\n\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.efd[1]);\n\tclose(ctx.efd[2]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n\tclose(ctx.sfd[2]);\n\tclose(ctx.sfd[3]);\n}\n\nstatic void *epoll59_thread(void *ctx_)\n{\n\tstruct epoll_mtcontext *ctx = ctx_;\n\tstruct epoll_event e;\n\tint i;\n\n\tfor (i = 0; i < 100000; i++) {\n\t\twhile (ctx->count == 0)\n\t\t\t;\n\n\t\te.events = EPOLLIN | EPOLLERR | EPOLLET;\n\t\tepoll_ctl(ctx->efd[0], EPOLL_CTL_MOD, ctx->sfd[0], &e);\n\t\tctx->count = 0;\n\t}\n\n\treturn NULL;\n}\n\n \nTEST(epoll59)\n{\n\tpthread_t emitter;\n\tstruct pollfd pfd;\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\tint i, ret;\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tctx.efd[0] = epoll_create1(0);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\tctx.sfd[0] = eventfd(1, 0);\n\tASSERT_GE(ctx.sfd[0], 0);\n\n\te.events = EPOLLIN | EPOLLERR | EPOLLET;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\tASSERT_EQ(pthread_create(&emitter, NULL, epoll59_thread, &ctx), 0);\n\n\tfor (i = 0; i < 100000; i++) {\n\t\tret = epoll_wait(ctx.efd[0], &e, 1, 1000);\n\t\tASSERT_GT(ret, 0);\n\n\t\twhile (ctx.count != 0)\n\t\t\t;\n\t\tctx.count = 1;\n\t}\n\tif (pthread_tryjoin_np(emitter, NULL) < 0) {\n\t\tpthread_kill(emitter, SIGUSR1);\n\t\tpthread_join(emitter, NULL);\n\t}\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n}\n\nenum {\n\tEPOLL60_EVENTS_NR = 10,\n};\n\nstruct epoll60_ctx {\n\tvolatile int stopped;\n\tint ready;\n\tint waiters;\n\tint epfd;\n\tint evfd[EPOLL60_EVENTS_NR];\n};\n\nstatic void *epoll60_wait_thread(void *ctx_)\n{\n\tstruct epoll60_ctx *ctx = ctx_;\n\tstruct epoll_event e;\n\tsigset_t sigmask;\n\tuint64_t v;\n\tint ret;\n\n\t \n\tsigemptyset(&sigmask);\n\tsigaddset(&sigmask, SIGUSR1);\n\tsigprocmask(SIG_SETMASK, &sigmask, NULL);\n\n\t \n\tsigemptyset(&sigmask);\n\n\twhile (!ctx->stopped) {\n\t\t \n\t\t__atomic_fetch_add(&ctx->ready, 1, __ATOMIC_ACQUIRE);\n\n\t\t \n\t\twhile (__atomic_load_n(&ctx->ready, __ATOMIC_ACQUIRE) &&\n\t\t       !ctx->stopped);\n\n\t\t \n\t\t__atomic_fetch_add(&ctx->waiters, 1, __ATOMIC_ACQUIRE);\n\n\t\tret = epoll_pwait(ctx->epfd, &e, 1, 2000, &sigmask);\n\t\tif (ret != 1) {\n\t\t\t \n\t\t\tassert(ret < 0 && errno == EINTR && \"Lost wakeup!\\n\");\n\t\t\tassert(ctx->stopped);\n\t\t\tbreak;\n\t\t}\n\n\t\tret = read(e.data.fd, &v, sizeof(v));\n\t\t \n\t\tassert(ret == sizeof(v));\n\n\t\t__atomic_fetch_sub(&ctx->waiters, 1, __ATOMIC_RELEASE);\n\t}\n\n\treturn NULL;\n}\n\nstatic inline unsigned long long msecs(void)\n{\n\tstruct timespec ts;\n\tunsigned long long msecs;\n\n\tclock_gettime(CLOCK_REALTIME, &ts);\n\tmsecs = ts.tv_sec * 1000ull;\n\tmsecs += ts.tv_nsec / 1000000ull;\n\n\treturn msecs;\n}\n\nstatic inline int count_waiters(struct epoll60_ctx *ctx)\n{\n\treturn __atomic_load_n(&ctx->waiters, __ATOMIC_ACQUIRE);\n}\n\nTEST(epoll60)\n{\n\tstruct epoll60_ctx ctx = { 0 };\n\tpthread_t waiters[ARRAY_SIZE(ctx.evfd)];\n\tstruct epoll_event e;\n\tint i, n, ret;\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tctx.epfd = epoll_create1(0);\n\tASSERT_GE(ctx.epfd, 0);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(ctx.evfd); i++) {\n\t\tctx.evfd[i] = eventfd(0, EFD_NONBLOCK);\n\t\tASSERT_GE(ctx.evfd[i], 0);\n\n\t\te.events = EPOLLIN | EPOLLET;\n\t\te.data.fd = ctx.evfd[i];\n\t\tASSERT_EQ(epoll_ctl(ctx.epfd, EPOLL_CTL_ADD, ctx.evfd[i], &e), 0);\n\t}\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(waiters); i++)\n\t\tASSERT_EQ(pthread_create(&waiters[i], NULL,\n\t\t\t\t\t epoll60_wait_thread, &ctx), 0);\n\n\tfor (i = 0; i < 300; i++) {\n\t\tuint64_t v = 1, ms;\n\n\t\t \n\t\twhile (__atomic_load_n(&ctx.ready, __ATOMIC_ACQUIRE) !=\n\t\t       ARRAY_SIZE(ctx.evfd))\n\t\t\t;\n\n\t\t \n\t\t__atomic_fetch_sub(&ctx.ready, ARRAY_SIZE(ctx.evfd),\n\t\t\t\t   __ATOMIC_ACQUIRE);\n\n\t\t \n\t\twhile (count_waiters(&ctx) != ARRAY_SIZE(ctx.evfd))\n\t\t\t;\n\n\t\t \n\t\tusleep(1000);\n\n\t\t \n\t\tfor (n = 0; n < ARRAY_SIZE(ctx.evfd); n++) {\n\t\t\tret = write(ctx.evfd[n], &v, sizeof(v));\n\t\t\tASSERT_EQ(ret, sizeof(v));\n\t\t}\n\n\t\t \n\t\tms = msecs();\n\t\twhile (count_waiters(&ctx) && msecs() < ms + 1000)\n\t\t\t;\n\n\t\tASSERT_EQ(count_waiters(&ctx), 0);\n\t}\n\tctx.stopped = 1;\n\t \n\tfor (i = 0; i < ARRAY_SIZE(waiters); i++)\n\t\tret = pthread_kill(waiters[i], SIGUSR1);\n\tfor (i = 0; i < ARRAY_SIZE(waiters); i++)\n\t\tpthread_join(waiters[i], NULL);\n\n\tfor (i = 0; i < ARRAY_SIZE(waiters); i++)\n\t\tclose(ctx.evfd[i]);\n\tclose(ctx.epfd);\n}\n\nstruct epoll61_ctx {\n\tint epfd;\n\tint evfd;\n};\n\nstatic void *epoll61_write_eventfd(void *ctx_)\n{\n\tstruct epoll61_ctx *ctx = ctx_;\n\tint64_t l = 1;\n\n\tusleep(10950);\n\twrite(ctx->evfd, &l, sizeof(l));\n\treturn NULL;\n}\n\nstatic void *epoll61_epoll_with_timeout(void *ctx_)\n{\n\tstruct epoll61_ctx *ctx = ctx_;\n\tstruct epoll_event events[1];\n\tint n;\n\n\tn = epoll_wait(ctx->epfd, events, 1, 11);\n\t \n\tif (n == 1) {\n\t\tint64_t l = 1;\n\n\t\twrite(ctx->evfd, &l, sizeof(l));\n\t}\n\treturn NULL;\n}\n\nstatic void *epoll61_blocking_epoll(void *ctx_)\n{\n\tstruct epoll61_ctx *ctx = ctx_;\n\tstruct epoll_event events[1];\n\n\tepoll_wait(ctx->epfd, events, 1, -1);\n\treturn NULL;\n}\n\nTEST(epoll61)\n{\n\tstruct epoll61_ctx ctx;\n\tstruct epoll_event ev;\n\tint i, r;\n\n\tctx.epfd = epoll_create1(0);\n\tASSERT_GE(ctx.epfd, 0);\n\tctx.evfd = eventfd(0, EFD_NONBLOCK);\n\tASSERT_GE(ctx.evfd, 0);\n\n\tev.events = EPOLLIN | EPOLLET | EPOLLERR | EPOLLHUP;\n\tev.data.ptr = NULL;\n\tr = epoll_ctl(ctx.epfd, EPOLL_CTL_ADD, ctx.evfd, &ev);\n\tASSERT_EQ(r, 0);\n\n\t \n\tfor (i = 0; i < 1000; i++) {\n\t\tpthread_t threads[3];\n\t\tint n;\n\n\t\t \n\t\tASSERT_EQ(pthread_create(&threads[0], NULL,\n\t\t\t\t\t epoll61_write_eventfd, &ctx), 0);\n\t\tASSERT_EQ(pthread_create(&threads[1], NULL,\n\t\t\t\t\t epoll61_epoll_with_timeout, &ctx), 0);\n\t\tASSERT_EQ(pthread_create(&threads[2], NULL,\n\t\t\t\t\t epoll61_blocking_epoll, &ctx), 0);\n\n\t\tfor (n = 0; n < ARRAY_SIZE(threads); ++n)\n\t\t\tASSERT_EQ(pthread_join(threads[n], NULL), 0);\n\t}\n\n\tclose(ctx.epfd);\n\tclose(ctx.evfd);\n}\n\n \nTEST(epoll62)\n{\n\tint efd;\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\tASSERT_EQ(write(sfd[1], \"w\", 1), 1);\n\n\tEXPECT_EQ(sys_epoll_pwait2(efd, &e, 1, NULL, NULL, 0), 1);\n\tEXPECT_EQ(sys_epoll_pwait2(efd, &e, 1, NULL, NULL, 0), 1);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll63)\n{\n\tconst int cfg_delay_ms = 10;\n\tunsigned long long tdiff;\n\tstruct __kernel_timespec ts;\n\tint efd;\n\tint sfd[2];\n\tstruct epoll_event e;\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, sfd), 0);\n\n\tefd = epoll_create(1);\n\tASSERT_GE(efd, 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(efd, EPOLL_CTL_ADD, sfd[0], &e), 0);\n\n\tts.tv_sec = 0;\n\tts.tv_nsec = cfg_delay_ms * 1000 * 1000;\n\n\ttdiff = msecs();\n\tEXPECT_EQ(sys_epoll_pwait2(efd, &e, 1, &ts, NULL, 0), 0);\n\ttdiff = msecs() - tdiff;\n\n\tEXPECT_GE(tdiff, cfg_delay_ms);\n\n\tclose(efd);\n\tclose(sfd[0]);\n\tclose(sfd[1]);\n}\n\n \nTEST(epoll64)\n{\n\tpthread_t waiter[2];\n\tstruct epoll_event e;\n\tstruct epoll_mtcontext ctx = { 0 };\n\n\tsignal(SIGUSR1, signal_handler);\n\n\tASSERT_EQ(socketpair(AF_UNIX, SOCK_STREAM, 0, ctx.sfd), 0);\n\n\tctx.efd[0] = epoll_create(1);\n\tASSERT_GE(ctx.efd[0], 0);\n\n\te.events = EPOLLIN;\n\tASSERT_EQ(epoll_ctl(ctx.efd[0], EPOLL_CTL_ADD, ctx.sfd[0], &e), 0);\n\n\t \n\tctx.main = pthread_self();\n\tASSERT_EQ(pthread_create(&waiter[0], NULL, waiter_entry1a, &ctx), 0);\n\tASSERT_EQ(pthread_create(&waiter[1], NULL, waiter_entry1a, &ctx), 0);\n\n\tusleep(100000);\n\tASSERT_EQ(write(ctx.sfd[1], \"w\", 1), 1);\n\n\tASSERT_EQ(pthread_join(waiter[0], NULL), 0);\n\tASSERT_EQ(pthread_join(waiter[1], NULL), 0);\n\n\tEXPECT_EQ(ctx.count, 2);\n\n\tclose(ctx.efd[0]);\n\tclose(ctx.sfd[0]);\n\tclose(ctx.sfd[1]);\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}