{
  "module_name": "binderfs_test.c",
  "hash_id": "3c9d2bb863b9182a566c16333ddd3867e9bf590b13d937c148c4fffa84d1af30",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/filesystems/binderfs/binderfs_test.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <pthread.h>\n#include <sched.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/fsuid.h>\n#include <sys/ioctl.h>\n#include <sys/mount.h>\n#include <sys/socket.h>\n#include <sys/stat.h>\n#include <sys/sysinfo.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n#include <linux/android/binder.h>\n#include <linux/android/binderfs.h>\n\n#include \"../../kselftest_harness.h\"\n\n#define DEFAULT_THREADS 4\n\n#define PTR_TO_INT(p) ((int)((intptr_t)(p)))\n#define INT_TO_PTR(u) ((void *)((intptr_t)(u)))\n\n#define close_prot_errno_disarm(fd) \\\n\tif (fd >= 0) {              \\\n\t\tint _e_ = errno;    \\\n\t\tclose(fd);          \\\n\t\terrno = _e_;        \\\n\t\tfd = -EBADF;        \\\n\t}\n\nstatic void change_mountns(struct __test_metadata *_metadata)\n{\n\tint ret;\n\n\tret = unshare(CLONE_NEWNS);\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to unshare mount namespace\",\n\t\t\tstrerror(errno));\n\t}\n\n\tret = mount(NULL, \"/\", NULL, MS_REC | MS_PRIVATE, 0);\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to mount / as private\",\n\t\t\tstrerror(errno));\n\t}\n}\n\nstatic int __do_binderfs_test(struct __test_metadata *_metadata)\n{\n\tint fd, ret, saved_errno, result = 1;\n\tsize_t len;\n\tssize_t wret;\n\tstruct binderfs_device device = { 0 };\n\tstruct binder_version version = { 0 };\n\tchar binderfs_mntpt[] = P_tmpdir \"/binderfs_XXXXXX\",\n\t\tdevice_path[sizeof(P_tmpdir \"/binderfs_XXXXXX/\") + BINDERFS_MAX_NAME];\n\tstatic const char * const binder_features[] = {\n\t\t\"oneway_spam_detection\",\n\t\t\"extended_error\",\n\t};\n\n\tchange_mountns(_metadata);\n\n\tEXPECT_NE(mkdtemp(binderfs_mntpt), NULL) {\n\t\tTH_LOG(\"%s - Failed to create binderfs mountpoint\",\n\t\t\tstrerror(errno));\n\t\tgoto out;\n\t}\n\n\tret = mount(NULL, binderfs_mntpt, \"binder\", 0, 0);\n\tEXPECT_EQ(ret, 0) {\n\t\tif (errno == ENODEV)\n\t\t\tSKIP(goto out, \"binderfs missing\");\n\t\tTH_LOG(\"%s - Failed to mount binderfs\", strerror(errno));\n\t\tgoto rmdir;\n\t}\n\n\t \n\n\tmemcpy(device.name, \"my-binder\", strlen(\"my-binder\"));\n\n\tsnprintf(device_path, sizeof(device_path), \"%s/binder-control\", binderfs_mntpt);\n\tfd = open(device_path, O_RDONLY | O_CLOEXEC);\n\tEXPECT_GE(fd, 0) {\n\t\tTH_LOG(\"%s - Failed to open binder-control device\",\n\t\t\tstrerror(errno));\n\t\tgoto umount;\n\t}\n\n\tret = ioctl(fd, BINDER_CTL_ADD, &device);\n\tsaved_errno = errno;\n\tclose(fd);\n\terrno = saved_errno;\n\tEXPECT_GE(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to allocate new binder device\",\n\t\t\tstrerror(errno));\n\t\tgoto umount;\n\t}\n\n\tTH_LOG(\"Allocated new binder device with major %d, minor %d, and name %s\",\n\t\tdevice.major, device.minor, device.name);\n\n\t \n\n\tsnprintf(device_path, sizeof(device_path), \"%s/my-binder\", binderfs_mntpt);\n\tfd = open(device_path, O_CLOEXEC | O_RDONLY);\n\tEXPECT_GE(fd, 0) {\n\t\tTH_LOG(\"%s - Failed to open my-binder device\",\n\t\t\tstrerror(errno));\n\t\tgoto umount;\n\t}\n\n\tret = ioctl(fd, BINDER_VERSION, &version);\n\tsaved_errno = errno;\n\tclose(fd);\n\terrno = saved_errno;\n\tEXPECT_GE(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to open perform BINDER_VERSION request\",\n\t\t\tstrerror(errno));\n\t\tgoto umount;\n\t}\n\n\tTH_LOG(\"Detected binder version: %d\", version.protocol_version);\n\n\t \n\n\tret = unlink(device_path);\n\tEXPECT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to delete binder device\",\n\t\t\tstrerror(errno));\n\t\tgoto umount;\n\t}\n\n\t \n\n\tsnprintf(device_path, sizeof(device_path), \"%s/binder-control\", binderfs_mntpt);\n\tret = unlink(device_path);\n\tEXPECT_NE(ret, 0) {\n\t\tTH_LOG(\"Managed to delete binder-control device\");\n\t\tgoto umount;\n\t}\n\tEXPECT_EQ(errno, EPERM) {\n\t\tTH_LOG(\"%s - Failed to delete binder-control device but exited with unexpected error code\",\n\t\t\tstrerror(errno));\n\t\tgoto umount;\n\t}\n\n\t \n\n\tfor (int i = 0; i < ARRAY_SIZE(binder_features); i++) {\n\t\tsnprintf(device_path, sizeof(device_path), \"%s/features/%s\",\n\t\t\t binderfs_mntpt, binder_features[i]);\n\t\tfd = open(device_path, O_CLOEXEC | O_RDONLY);\n\t\tEXPECT_GE(fd, 0) {\n\t\t\tTH_LOG(\"%s - Failed to open binder feature: %s\",\n\t\t\t\tstrerror(errno), binder_features[i]);\n\t\t\tgoto umount;\n\t\t}\n\t\tclose(fd);\n\t}\n\n\t \n\tresult = 0;\n\numount:\n\tret = umount2(binderfs_mntpt, MNT_DETACH);\n\tEXPECT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to unmount binderfs\", strerror(errno));\n\t}\nrmdir:\n\tret = rmdir(binderfs_mntpt);\n\tEXPECT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to rmdir binderfs mount\", strerror(errno));\n\t}\nout:\n\treturn result;\n}\n\nstatic int wait_for_pid(pid_t pid)\n{\n\tint status, ret;\n\nagain:\n\tret = waitpid(pid, &status, 0);\n\tif (ret == -1) {\n\t\tif (errno == EINTR)\n\t\t\tgoto again;\n\n\t\treturn -1;\n\t}\n\n\tif (!WIFEXITED(status))\n\t\treturn -1;\n\n\treturn WEXITSTATUS(status);\n}\n\nstatic int setid_userns_root(void)\n{\n\tif (setuid(0))\n\t\treturn -1;\n\tif (setgid(0))\n\t\treturn -1;\n\n\tsetfsuid(0);\n\tsetfsgid(0);\n\n\treturn 0;\n}\n\nenum idmap_type {\n\tUID_MAP,\n\tGID_MAP,\n};\n\nstatic ssize_t read_nointr(int fd, void *buf, size_t count)\n{\n\tssize_t ret;\nagain:\n\tret = read(fd, buf, count);\n\tif (ret < 0 && errno == EINTR)\n\t\tgoto again;\n\n\treturn ret;\n}\n\nstatic ssize_t write_nointr(int fd, const void *buf, size_t count)\n{\n\tssize_t ret;\nagain:\n\tret = write(fd, buf, count);\n\tif (ret < 0 && errno == EINTR)\n\t\tgoto again;\n\n\treturn ret;\n}\n\nstatic int write_id_mapping(enum idmap_type type, pid_t pid, const char *buf,\n\t\t\t    size_t buf_size)\n{\n\tint fd;\n\tint ret;\n\tchar path[4096];\n\n\tif (type == GID_MAP) {\n\t\tint setgroups_fd;\n\n\t\tsnprintf(path, sizeof(path), \"/proc/%d/setgroups\", pid);\n\t\tsetgroups_fd = open(path, O_WRONLY | O_CLOEXEC | O_NOFOLLOW);\n\t\tif (setgroups_fd < 0 && errno != ENOENT)\n\t\t\treturn -1;\n\n\t\tif (setgroups_fd >= 0) {\n\t\t\tret = write_nointr(setgroups_fd, \"deny\", sizeof(\"deny\") - 1);\n\t\t\tclose_prot_errno_disarm(setgroups_fd);\n\t\t\tif (ret != sizeof(\"deny\") - 1)\n\t\t\t\treturn -1;\n\t\t}\n\t}\n\n\tswitch (type) {\n\tcase UID_MAP:\n\t\tret = snprintf(path, sizeof(path), \"/proc/%d/uid_map\", pid);\n\t\tbreak;\n\tcase GID_MAP:\n\t\tret = snprintf(path, sizeof(path), \"/proc/%d/gid_map\", pid);\n\t\tbreak;\n\tdefault:\n\t\treturn -1;\n\t}\n\tif (ret < 0 || ret >= sizeof(path))\n\t\treturn -E2BIG;\n\n\tfd = open(path, O_WRONLY | O_CLOEXEC | O_NOFOLLOW);\n\tif (fd < 0)\n\t\treturn -1;\n\n\tret = write_nointr(fd, buf, buf_size);\n\tclose_prot_errno_disarm(fd);\n\tif (ret != buf_size)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic void change_userns(struct __test_metadata *_metadata, int syncfds[2])\n{\n\tint ret;\n\tchar buf;\n\n\tclose_prot_errno_disarm(syncfds[1]);\n\n\tret = unshare(CLONE_NEWUSER);\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to unshare user namespace\",\n\t\t\tstrerror(errno));\n\t}\n\n\tret = write_nointr(syncfds[0], \"1\", 1);\n\tASSERT_EQ(ret, 1) {\n\t\tTH_LOG(\"write_nointr() failed\");\n\t}\n\n\tret = read_nointr(syncfds[0], &buf, 1);\n\tASSERT_EQ(ret, 1) {\n\t\tTH_LOG(\"read_nointr() failed\");\n\t}\n\n\tclose_prot_errno_disarm(syncfds[0]);\n\n\tASSERT_EQ(setid_userns_root(), 0) {\n\t\tTH_LOG(\"setid_userns_root() failed\");\n\t}\n}\n\nstatic void change_idmaps(struct __test_metadata *_metadata, int syncfds[2], pid_t pid)\n{\n\tint ret;\n\tchar buf;\n\tchar id_map[4096];\n\n\tclose_prot_errno_disarm(syncfds[0]);\n\n\tret = read_nointr(syncfds[1], &buf, 1);\n\tASSERT_EQ(ret, 1) {\n\t\tTH_LOG(\"read_nointr() failed\");\n\t}\n\n\tsnprintf(id_map, sizeof(id_map), \"0 %d 1\\n\", getuid());\n\tret = write_id_mapping(UID_MAP, pid, id_map, strlen(id_map));\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"write_id_mapping(UID_MAP) failed\");\n\t}\n\n\tsnprintf(id_map, sizeof(id_map), \"0 %d 1\\n\", getgid());\n\tret = write_id_mapping(GID_MAP, pid, id_map, strlen(id_map));\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"write_id_mapping(GID_MAP) failed\");\n\t}\n\n\tret = write_nointr(syncfds[1], \"1\", 1);\n\tASSERT_EQ(ret, 1) {\n\t\tTH_LOG(\"write_nointr() failed\");\n\t}\n\n\tclose_prot_errno_disarm(syncfds[1]);\n}\n\nstruct __test_metadata *_thread_metadata;\nstatic void *binder_version_thread(void *data)\n{\n\tstruct __test_metadata *_metadata = _thread_metadata;\n\tint fd = PTR_TO_INT(data);\n\tstruct binder_version version = { 0 };\n\tint ret;\n\n\tret = ioctl(fd, BINDER_VERSION, &version);\n\tif (ret < 0)\n\t\tTH_LOG(\"%s - Failed to open perform BINDER_VERSION request\\n\",\n\t\t\tstrerror(errno));\n\n\tpthread_exit(data);\n}\n\n \nTEST(binderfs_stress)\n{\n\tint fds[1000];\n\tint syncfds[2];\n\tpid_t pid;\n\tint fd, ret;\n\tsize_t len;\n\tstruct binderfs_device device = { 0 };\n\tchar binderfs_mntpt[] = P_tmpdir \"/binderfs_XXXXXX\",\n\t\tdevice_path[sizeof(P_tmpdir \"/binderfs_XXXXXX/\") + BINDERFS_MAX_NAME];\n\n\tret = socketpair(PF_LOCAL, SOCK_STREAM | SOCK_CLOEXEC, 0, syncfds);\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to create socket pair\", strerror(errno));\n\t}\n\n\tpid = fork();\n\tASSERT_GE(pid, 0) {\n\t\tTH_LOG(\"%s - Failed to fork\", strerror(errno));\n\t\tclose_prot_errno_disarm(syncfds[0]);\n\t\tclose_prot_errno_disarm(syncfds[1]);\n\t}\n\n\tif (pid == 0) {\n\t\tint i, j, k, nthreads;\n\t\tpthread_attr_t attr;\n\t\tpthread_t threads[DEFAULT_THREADS];\n\t\tchange_userns(_metadata, syncfds);\n\t\tchange_mountns(_metadata);\n\n\t\tASSERT_NE(mkdtemp(binderfs_mntpt), NULL) {\n\t\t\tTH_LOG(\"%s - Failed to create binderfs mountpoint\",\n\t\t\t\tstrerror(errno));\n\t\t}\n\n\t\tret = mount(NULL, binderfs_mntpt, \"binder\", 0, 0);\n\t\tASSERT_EQ(ret, 0) {\n\t\t\tTH_LOG(\"%s - Failed to mount binderfs, check if CONFIG_ANDROID_BINDERFS is enabled in the running kernel\",\n\t\t\t\tstrerror(errno));\n\t\t}\n\n\t\tfor (int i = 0; i < ARRAY_SIZE(fds); i++) {\n\n\t\t\tsnprintf(device_path, sizeof(device_path),\n\t\t\t\t \"%s/binder-control\", binderfs_mntpt);\n\t\t\tfd = open(device_path, O_RDONLY | O_CLOEXEC);\n\t\t\tASSERT_GE(fd, 0) {\n\t\t\t\tTH_LOG(\"%s - Failed to open binder-control device\",\n\t\t\t\t\tstrerror(errno));\n\t\t\t}\n\n\t\t\tmemset(&device, 0, sizeof(device));\n\t\t\tsnprintf(device.name, sizeof(device.name), \"%d\", i);\n\t\t\tret = ioctl(fd, BINDER_CTL_ADD, &device);\n\t\t\tclose_prot_errno_disarm(fd);\n\t\t\tASSERT_EQ(ret, 0) {\n\t\t\t\tTH_LOG(\"%s - Failed to allocate new binder device\",\n\t\t\t\t\tstrerror(errno));\n\t\t\t}\n\n\t\t\tsnprintf(device_path, sizeof(device_path), \"%s/%d\",\n\t\t\t\t binderfs_mntpt, i);\n\t\t\tfds[i] = open(device_path, O_RDONLY | O_CLOEXEC);\n\t\t\tASSERT_GE(fds[i], 0) {\n\t\t\t\tTH_LOG(\"%s - Failed to open binder device\", strerror(errno));\n\t\t\t}\n\t\t}\n\n\t\tret = umount2(binderfs_mntpt, MNT_DETACH);\n\t\tASSERT_EQ(ret, 0) {\n\t\t\tTH_LOG(\"%s - Failed to unmount binderfs\", strerror(errno));\n\t\t\trmdir(binderfs_mntpt);\n\t\t}\n\n\t\tnthreads = get_nprocs_conf();\n\t\tif (nthreads > DEFAULT_THREADS)\n\t\t\tnthreads = DEFAULT_THREADS;\n\n\t\t_thread_metadata = _metadata;\n\t\tpthread_attr_init(&attr);\n\t\tfor (k = 0; k < ARRAY_SIZE(fds); k++) {\n\t\t\tfor (i = 0; i < nthreads; i++) {\n\t\t\t\tret = pthread_create(&threads[i], &attr, binder_version_thread, INT_TO_PTR(fds[k]));\n\t\t\t\tif (ret) {\n\t\t\t\t\tTH_LOG(\"%s - Failed to create thread %d\",\n\t\t\t\t\t\tstrerror(errno), i);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (j = 0; j < i; j++) {\n\t\t\t\tvoid *fdptr = NULL;\n\n\t\t\t\tret = pthread_join(threads[j], &fdptr);\n\t\t\t\tif (ret)\n\t\t\t\t\tTH_LOG(\"%s - Failed to join thread %d for fd %d\",\n\t\t\t\t\t\tstrerror(errno), j, PTR_TO_INT(fdptr));\n\t\t\t}\n\t\t}\n\t\tpthread_attr_destroy(&attr);\n\n\t\tfor (k = 0; k < ARRAY_SIZE(fds); k++)\n\t\t\tclose(fds[k]);\n\n\t\texit(EXIT_SUCCESS);\n\t}\n\n\tchange_idmaps(_metadata, syncfds, pid);\n\n\tret = wait_for_pid(pid);\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"wait_for_pid() failed\");\n\t}\n}\n\nTEST(binderfs_test_privileged)\n{\n\tif (geteuid() != 0)\n\t\tSKIP(return, \"Tests are not run as root. Skipping privileged tests\");\n\n\tif (__do_binderfs_test(_metadata))\n\t\tSKIP(return, \"The Android binderfs filesystem is not available\");\n}\n\nTEST(binderfs_test_unprivileged)\n{\n\tint ret;\n\tint syncfds[2];\n\tpid_t pid;\n\n\tret = socketpair(PF_LOCAL, SOCK_STREAM | SOCK_CLOEXEC, 0, syncfds);\n\tASSERT_EQ(ret, 0) {\n\t\tTH_LOG(\"%s - Failed to create socket pair\", strerror(errno));\n\t}\n\n\tpid = fork();\n\tASSERT_GE(pid, 0) {\n\t\tclose_prot_errno_disarm(syncfds[0]);\n\t\tclose_prot_errno_disarm(syncfds[1]);\n\t\tTH_LOG(\"%s - Failed to fork\", strerror(errno));\n\t}\n\n\tif (pid == 0) {\n\t\tchange_userns(_metadata, syncfds);\n\t\tif (__do_binderfs_test(_metadata))\n\t\t\texit(2);\n\t\texit(EXIT_SUCCESS);\n\t}\n\n\tchange_idmaps(_metadata, syncfds, pid);\n\n\tret = wait_for_pid(pid);\n\tif (ret) {\n\t\tif (ret == 2)\n\t\t\tSKIP(return, \"The Android binderfs filesystem is not available\");\n\t\tASSERT_EQ(ret, 0) {\n\t\t\tTH_LOG(\"wait_for_pid() failed\");\n\t\t}\n\t}\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}