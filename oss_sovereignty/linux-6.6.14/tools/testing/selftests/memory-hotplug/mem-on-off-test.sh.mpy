{
  "module_name": "mem-on-off-test.sh",
  "hash_id": "589c28f3304308de4be25b3246f10ec332815024819253f267cbdf8038257ce5",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/memory-hotplug/mem-on-off-test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nSYSFS=\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nprerequisite()\n{\n\tmsg=\"skip all tests:\"\n\n\tif [ $UID != 0 ]; then\n\t\techo $msg must be run as root >&2\n\t\texit $ksft_skip\n\tfi\n\n\tSYSFS=`mount -t sysfs | head -1 | awk '{ print $3 }'`\n\n\tif [ ! -d \"$SYSFS\" ]; then\n\t\techo $msg sysfs is not mounted >&2\n\t\texit $ksft_skip\n\tfi\n\n\tif ! ls $SYSFS/devices/system/memory/memory* > /dev/null 2>&1; then\n\t\techo $msg memory hotplug is not supported >&2\n\t\texit $ksft_skip\n\tfi\n\n\tif ! grep -q 1 $SYSFS/devices/system/memory/memory*/removable; then\n\t\techo $msg no hot-pluggable memory >&2\n\t\texit $ksft_skip\n\tfi\n}\n\n#\n# list all hot-pluggable memory\n#\nhotpluggable_memory()\n{\n\tlocal state=${1:-.\\*}\n\n\tfor memory in $SYSFS/devices/system/memory/memory*; do\n\t\tif grep -q 1 $memory/removable &&\n\t\t   grep -q $state $memory/state; then\n\t\t\techo ${memory##/*/memory}\n\t\tfi\n\tdone\n}\n\nhotpluggable_offline_memory()\n{\n\thotpluggable_memory offline\n}\n\nhotpluggable_online_memory()\n{\n\thotpluggable_memory online\n}\n\nmemory_is_online()\n{\n\tgrep -q online $SYSFS/devices/system/memory/memory$1/state\n}\n\nmemory_is_offline()\n{\n\tgrep -q offline $SYSFS/devices/system/memory/memory$1/state\n}\n\nonline_memory()\n{\n\techo online > $SYSFS/devices/system/memory/memory$1/state\n}\n\noffline_memory()\n{\n\techo offline > $SYSFS/devices/system/memory/memory$1/state\n}\n\nonline_memory_expect_success()\n{\n\tlocal memory=$1\n\n\tif ! online_memory $memory; then\n\t\techo $FUNCNAME $memory: unexpected fail >&2\n\t\treturn 1\n\telif ! memory_is_online $memory; then\n\t\techo $FUNCNAME $memory: unexpected offline >&2\n\t\treturn 1\n\tfi\n\treturn 0\n}\n\nonline_memory_expect_fail()\n{\n\tlocal memory=$1\n\n\tif online_memory $memory 2> /dev/null; then\n\t\techo $FUNCNAME $memory: unexpected success >&2\n\t\treturn 1\n\telif ! memory_is_offline $memory; then\n\t\techo $FUNCNAME $memory: unexpected online >&2\n\t\treturn 1\n\tfi\n\treturn 0\n}\n\noffline_memory_expect_success()\n{\n\tlocal memory=$1\n\n\tif ! offline_memory $memory; then\n\t\techo $FUNCNAME $memory: unexpected fail >&2\n\t\treturn 1\n\telif ! memory_is_offline $memory; then\n\t\techo $FUNCNAME $memory: unexpected offline >&2\n\t\treturn 1\n\tfi\n\treturn 0\n}\n\noffline_memory_expect_fail()\n{\n\tlocal memory=$1\n\n\tif offline_memory $memory 2> /dev/null; then\n\t\techo $FUNCNAME $memory: unexpected success >&2\n\t\treturn 1\n\telif ! memory_is_online $memory; then\n\t\techo $FUNCNAME $memory: unexpected offline >&2\n\t\treturn 1\n\tfi\n\treturn 0\n}\n\nonline_all_offline_memory()\n{\n\tfor memory in `hotpluggable_offline_memory`; do\n\t\tif ! online_memory_expect_success $memory; then\n\t\t\tretval=1\n\t\tfi\n\tdone\n}\n\nerror=-12\npriority=0\n# Run with default of ratio=2 for Kselftest run\nratio=2\nretval=0\n\nwhile getopts e:hp:r: opt; do\n\tcase $opt in\n\te)\n\t\terror=$OPTARG\n\t\t;;\n\th)\n\t\techo \"Usage $0 [ -e errno ] [ -p notifier-priority ] [ -r percent-of-memory-to-offline ]\"\n\t\texit\n\t\t;;\n\tp)\n\t\tpriority=$OPTARG\n\t\t;;\n\tr)\n\t\tratio=$OPTARG\n\t\tif [ \"$ratio\" -gt 100 ] || [ \"$ratio\" -lt 0 ]; then\n\t\t\techo \"The percentage should be an integer within 0~100 range\"\n\t\t\texit 1\n\t\tfi\n\t\t;;\n\tesac\ndone\n\nif ! [ \"$error\" -ge -4095 -a \"$error\" -lt 0 ]; then\n\techo \"error code must be -4095 <= errno < 0\" >&2\n\texit 1\nfi\n\nprerequisite\n\necho \"Test scope: $ratio% hotplug memory\"\n\n#\n# Online all hot-pluggable memory\n#\nhotpluggable_num=`hotpluggable_offline_memory | wc -l`\necho -e \"\\t online all hot-pluggable memory in offline state:\"\nif [ \"$hotpluggable_num\" -gt 0 ]; then\n\tfor memory in `hotpluggable_offline_memory`; do\n\t\techo \"offline->online memory$memory\"\n\t\tif ! online_memory_expect_success $memory; then\n\t\t\tretval=1\n\t\tfi\n\tdone\nelse\n\techo -e \"\\t\\t SKIPPED - no hot-pluggable memory in offline state\"\nfi\n\n#\n# Offline $ratio percent of hot-pluggable memory\n#\nhotpluggable_num=`hotpluggable_online_memory | wc -l`\ntarget=`echo \"a=$hotpluggable_num*$ratio; if ( a%100 ) a/100+1 else a/100\" | bc`\necho -e \"\\t offline $ratio% hot-pluggable memory in online state\"\necho -e \"\\t trying to offline $target out of $hotpluggable_num memory block(s):\"\nfor memory in `hotpluggable_online_memory`; do\n\tif [ \"$target\" -gt 0 ]; then\n\t\techo \"online->offline memory$memory\"\n\t\tif offline_memory_expect_success $memory &>/dev/null; then\n\t\t\ttarget=$(($target - 1))\n\t\t\techo \"-> Success\"\n\t\telse\n\t\t\techo \"-> Failure\"\n\t\tfi\n\tfi\ndone\nif [ \"$target\" -gt 0 ]; then\n\tretval=1\n\techo -e \"\\t\\t FAILED - unable to offline some memory blocks, device busy?\"\nfi\n\n#\n# Online all hot-pluggable memory again\n#\nhotpluggable_num=`hotpluggable_offline_memory | wc -l`\necho -e \"\\t online all hot-pluggable memory in offline state:\"\nif [ \"$hotpluggable_num\" -gt 0 ]; then\n\tfor memory in `hotpluggable_offline_memory`; do\n\t\techo \"offline->online memory$memory\"\n\t\tif ! online_memory_expect_success $memory; then\n\t\t\tretval=1\n\t\tfi\n\tdone\nelse\n\techo -e \"\\t\\t SKIPPED - no hot-pluggable memory in offline state\"\nfi\n\n#\n# Test with memory notifier error injection\n#\n\nDEBUGFS=`mount -t debugfs | head -1 | awk '{ print $3 }'`\nNOTIFIER_ERR_INJECT_DIR=$DEBUGFS/notifier-error-inject/memory\n\nprerequisite_extra()\n{\n\tmsg=\"skip extra tests:\"\n\n\t/sbin/modprobe -q -r memory-notifier-error-inject\n\t/sbin/modprobe -q memory-notifier-error-inject priority=$priority\n\n\tif [ ! -d \"$DEBUGFS\" ]; then\n\t\techo $msg debugfs is not mounted >&2\n\t\texit $retval\n\tfi\n\n\tif [ ! -d $NOTIFIER_ERR_INJECT_DIR ]; then\n\t\techo $msg memory-notifier-error-inject module is not available >&2\n\t\texit $retval\n\tfi\n}\n\necho -e \"\\t Test with memory notifier error injection\"\nprerequisite_extra\n\n#\n# Offline $ratio percent of hot-pluggable memory\n#\necho 0 > $NOTIFIER_ERR_INJECT_DIR/actions/MEM_GOING_OFFLINE/error\nfor memory in `hotpluggable_online_memory`; do\n\tif [ $((RANDOM % 100)) -lt $ratio ]; then\n\t\toffline_memory_expect_success $memory &>/dev/null\n\tfi\ndone\n\n#\n# Test memory hot-add error handling (offline => online)\n#\necho $error > $NOTIFIER_ERR_INJECT_DIR/actions/MEM_GOING_ONLINE/error\nfor memory in `hotpluggable_offline_memory`; do\n\tif ! online_memory_expect_fail $memory; then\n\t\tretval=1\n\tfi\ndone\n\n#\n# Online all hot-pluggable memory\n#\necho 0 > $NOTIFIER_ERR_INJECT_DIR/actions/MEM_GOING_ONLINE/error\nonline_all_offline_memory\n\n#\n# Test memory hot-remove error handling (online => offline)\n#\necho $error > $NOTIFIER_ERR_INJECT_DIR/actions/MEM_GOING_OFFLINE/error\nfor memory in `hotpluggable_online_memory`; do\n\tif [ $((RANDOM % 100)) -lt $ratio ]; then\n\t\tif ! offline_memory_expect_fail $memory; then\n\t\t\tretval=1\n\t\tfi\n\tfi\ndone\n\necho 0 > $NOTIFIER_ERR_INJECT_DIR/actions/MEM_GOING_OFFLINE/error\n/sbin/modprobe -q -r memory-notifier-error-inject\n\n#\n# Restore memory before exit\n#\nonline_all_offline_memory\n\nexit $retval\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}