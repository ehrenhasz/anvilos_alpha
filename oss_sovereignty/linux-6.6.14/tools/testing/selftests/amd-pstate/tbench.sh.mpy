{
  "module_name": "tbench.sh",
  "hash_id": "39d8cd69e37bd50cb1822d0188abe5ea782705d346d355b402b7a6a020b68ff9",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/amd-pstate/tbench.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\n# Testing and monitor the cpu desire performance, frequency, load,\n# power consumption and throughput etc.when this script trigger tbench\n# test cases.\n# 1) Run tbench benchmark on specific governors, ondemand or schedutil.\n# 2) Run tbench benchmark comparative test on acpi-cpufreq kernel driver.\n# 3) Get desire performance, frequency, load by perf.\n# 4) Get power consumption and throughput by amd_pstate_trace.py.\n# 5) Analyse test results and save it in file selftest.tbench.csv.\n# 6) Plot png images about performance, energy and performance per watt for each test.\n\n# protect against multiple inclusion\nif [ $FILE_TBENCH ]; then\n\treturn 0\nelse\n\tFILE_TBENCH=DONE\nfi\n\ntbench_governors=(\"ondemand\" \"schedutil\")\n\n# $1: governor, $2: round, $3: des-perf, $4: freq, $5: load, $6: performance, $7: energy, $8: performance per watt\nstore_csv_tbench()\n{\n\techo \"$1, $2, $3, $4, $5, $6, $7, $8\" | tee -a $OUTFILE_TBENCH.csv > /dev/null 2>&1\n}\n\n# clear some special lines\nclear_csv_tbench()\n{\n\tif [ -f $OUTFILE_TBENCH.csv ]; then\n\t\tsed -i '/Comprison(%)/d' $OUTFILE_TBENCH.csv\n\t\tsed -i \"/$(scaling_name)/d\" $OUTFILE_TBENCH.csv\n\tfi\n}\n\n# find string $1 in file csv and get the number of lines\nget_lines_csv_tbench()\n{\n\tif [ -f $OUTFILE_TBENCH.csv ]; then\n\t\treturn `grep -c \"$1\" $OUTFILE_TBENCH.csv`\n\telse\n\t\treturn 0\n\tfi\n}\n\npre_clear_tbench()\n{\n\tpost_clear_tbench\n\trm -rf tbench_*.png\n\tclear_csv_tbench\n}\n\npost_clear_tbench()\n{\n\trm -rf results/tracer-tbench*\n\trm -rf $OUTFILE_TBENCH*.log\n\trm -rf $OUTFILE_TBENCH*.result\n\n}\n\n# $1: governor, $2: loop\nrun_tbench()\n{\n\techo \"Launching amd pstate tracer for $1 #$2 tracer_interval: $TRACER_INTERVAL\"\n\t./amd_pstate_trace.py -n tracer-tbench-$1-$2 -i $TRACER_INTERVAL > /dev/null 2>&1 &\n\n\tprintf \"Test tbench for $1 #$2 time_limit: $TIME_LIMIT procs_num: $PROCESS_NUM\\n\"\n\ttbench_srv > /dev/null 2>&1 &\n\tperf stat -a --per-socket -I 1000 -e power/energy-pkg/ tbench -t $TIME_LIMIT $PROCESS_NUM > $OUTFILE_TBENCH-perf-$1-$2.log 2>&1\n\n\tpid=`pidof tbench_srv`\n\tkill $pid\n\n\tfor job in `jobs -p`\n\tdo\n\t\techo \"Waiting for job id $job\"\n\t\twait $job\n\tdone\n}\n\n# $1: governor, $2: loop\nparse_tbench()\n{\n\tawk '{print $5}' results/tracer-tbench-$1-$2/cpu.csv | sed -e '1d' | sed s/,// > $OUTFILE_TBENCH-des-perf-$1-$2.log\n\tavg_des_perf=$(awk 'BEGIN {i=0; sum=0};{i++; sum += $1};END {print sum/i}' $OUTFILE_TBENCH-des-perf-$1-$2.log)\n\tprintf \"Tbench-$1-#$2 avg des perf: $avg_des_perf\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tawk '{print $7}' results/tracer-tbench-$1-$2/cpu.csv | sed -e '1d' | sed s/,// > $OUTFILE_TBENCH-freq-$1-$2.log\n\tavg_freq=$(awk 'BEGIN {i=0; sum=0};{i++; sum += $1};END {print sum/i}' $OUTFILE_TBENCH-freq-$1-$2.log)\n\tprintf \"Tbench-$1-#$2 avg freq: $avg_freq\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tawk '{print $11}' results/tracer-tbench-$1-$2/cpu.csv | sed -e '1d' | sed s/,// > $OUTFILE_TBENCH-load-$1-$2.log\n\tavg_load=$(awk 'BEGIN {i=0; sum=0};{i++; sum += $1};END {print sum/i}' $OUTFILE_TBENCH-load-$1-$2.log)\n\tprintf \"Tbench-$1-#$2 avg load: $avg_load\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep Throughput $OUTFILE_TBENCH-perf-$1-$2.log | awk '{print $2}' > $OUTFILE_TBENCH-throughput-$1-$2.log\n\ttp_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_TBENCH-throughput-$1-$2.log)\n\tprintf \"Tbench-$1-#$2 throughput(MB/s): $tp_sum\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep Joules $OUTFILE_TBENCH-perf-$1-$2.log | awk '{print $4}' > $OUTFILE_TBENCH-energy-$1-$2.log\n\ten_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_TBENCH-energy-$1-$2.log)\n\tprintf \"Tbench-$1-#$2 power consumption(J): $en_sum\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t# Permance is throughput per second, denoted T/t, where T is throught rendered in t seconds.\n\t# It is well known that P=E/t, where P is power measured in watts(W), E is energy measured in joules(J),\n\t# and t is time measured in seconds(s). This means that performance per watt becomes\n\t#       T/t   T/t    T\n\t#       --- = --- = ---\n\t#        P    E/t    E\n\t# with unit given by MB per joule.\n\tppw=`echo \"scale=4;($TIME_LIMIT-1)*$tp_sum/$en_sum\" | bc | awk '{printf \"%.4f\", $0}'`\n\tprintf \"Tbench-$1-#$2 performance per watt(MB/J): $ppw\\n\" | tee -a $OUTFILE_TBENCH.result\n\tprintf \"\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tdriver_name=`echo $(scaling_name)`\n\tstore_csv_tbench \"$driver_name-$1\" $2 $avg_des_perf $avg_freq $avg_load $tp_sum $en_sum $ppw\n}\n\n# $1: governor\nloop_tbench()\n{\n\tprintf \"\\nTbench total test times is $LOOP_TIMES for $1\\n\\n\"\n\tfor i in `seq 1 $LOOP_TIMES`\n\tdo\n\t\trun_tbench $1 $i\n\t\tparse_tbench $1 $i\n\tdone\n}\n\n# $1: governor\ngather_tbench()\n{\n\tprintf \"Tbench test result for $1 (loops:$LOOP_TIMES)\" | tee -a $OUTFILE_TBENCH.result\n\tprintf \"\\n--------------------------------------------------\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep \"Tbench-$1-#\" $OUTFILE_TBENCH.result | grep \"avg des perf:\" | awk '{print $NF}' > $OUTFILE_TBENCH-des-perf-$1.log\n\tavg_des_perf=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_TBENCH-des-perf-$1.log)\n\tprintf \"Tbench-$1 avg des perf: $avg_des_perf\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep \"Tbench-$1-#\" $OUTFILE_TBENCH.result | grep \"avg freq:\" | awk '{print $NF}' > $OUTFILE_TBENCH-freq-$1.log\n\tavg_freq=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_TBENCH-freq-$1.log)\n\tprintf \"Tbench-$1 avg freq: $avg_freq\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep \"Tbench-$1-#\" $OUTFILE_TBENCH.result | grep \"avg load:\" | awk '{print $NF}' > $OUTFILE_TBENCH-load-$1.log\n\tavg_load=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_TBENCH-load-$1.log)\n\tprintf \"Tbench-$1 avg load: $avg_load\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep \"Tbench-$1-#\" $OUTFILE_TBENCH.result | grep \"throughput(MB/s):\" | awk '{print $NF}' > $OUTFILE_TBENCH-throughput-$1.log\n\ttp_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_TBENCH-throughput-$1.log)\n\tprintf \"Tbench-$1 total throughput(MB/s): $tp_sum\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tavg_tp=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_TBENCH-throughput-$1.log)\n\tprintf \"Tbench-$1 avg throughput(MB/s): $avg_tp\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tgrep \"Tbench-$1-#\" $OUTFILE_TBENCH.result | grep \"power consumption(J):\" | awk '{print $NF}' > $OUTFILE_TBENCH-energy-$1.log\n\ten_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_TBENCH-energy-$1.log)\n\tprintf \"Tbench-$1 total power consumption(J): $en_sum\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tavg_en=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_TBENCH-energy-$1.log)\n\tprintf \"Tbench-$1 avg power consumption(J): $avg_en\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t# Permance is throughput per second, denoted T/t, where T is throught rendered in t seconds.\n\t# It is well known that P=E/t, where P is power measured in watts(W), E is energy measured in joules(J),\n\t# and t is time measured in seconds(s). This means that performance per watt becomes\n\t#       T/t   T/t    T\n\t#       --- = --- = ---\n\t#        P    E/t    E\n\t# with unit given by MB per joule.\n\tppw=`echo \"scale=4;($TIME_LIMIT-1)*$avg_tp/$avg_en\" | bc | awk '{printf \"%.4f\", $0}'`\n\tprintf \"Tbench-$1 performance per watt(MB/J): $ppw\\n\" | tee -a $OUTFILE_TBENCH.result\n\tprintf \"\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\tdriver_name=`echo $(scaling_name)`\n\tstore_csv_tbench \"$driver_name-$1\" \"Average\" $avg_des_perf $avg_freq $avg_load $avg_tp $avg_en $ppw\n}\n\n# $1: base scaling_driver $2: base governor $3: comparative scaling_driver $4: comparative governor\n__calc_comp_tbench()\n{\n\tbase=`grep \"$1-$2\" $OUTFILE_TBENCH.csv | grep \"Average\"`\n\tcomp=`grep \"$3-$4\" $OUTFILE_TBENCH.csv | grep \"Average\"`\n\n\tif [ -n \"$base\" -a -n \"$comp\" ]; then\n\t\tprintf \"\\n==================================================\\n\" | tee -a $OUTFILE_TBENCH.result\n\t\tprintf \"Tbench comparison $1-$2 VS $3-$4\" | tee -a $OUTFILE_TBENCH.result\n\t\tprintf \"\\n==================================================\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\t# get the base values\n\t\tdes_perf_base=`echo \"$base\" | awk '{print $3}' | sed s/,//`\n\t\tfreq_base=`echo \"$base\" | awk '{print $4}' | sed s/,//`\n\t\tload_base=`echo \"$base\" | awk '{print $5}' | sed s/,//`\n\t\tperf_base=`echo \"$base\" | awk '{print $6}' | sed s/,//`\n\t\tenergy_base=`echo \"$base\" | awk '{print $7}' | sed s/,//`\n\t\tppw_base=`echo \"$base\" | awk '{print $8}' | sed s/,//`\n\n\t\t# get the comparative values\n\t\tdes_perf_comp=`echo \"$comp\" | awk '{print $3}' | sed s/,//`\n\t\tfreq_comp=`echo \"$comp\" | awk '{print $4}' | sed s/,//`\n\t\tload_comp=`echo \"$comp\" | awk '{print $5}' | sed s/,//`\n\t\tperf_comp=`echo \"$comp\" | awk '{print $6}' | sed s/,//`\n\t\tenergy_comp=`echo \"$comp\" | awk '{print $7}' | sed s/,//`\n\t\tppw_comp=`echo \"$comp\" | awk '{print $8}' | sed s/,//`\n\n\t\t# compare the base and comp values\n\t\tdes_perf_drop=`echo \"scale=4;($des_perf_comp-$des_perf_base)*100/$des_perf_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Tbench-$1 des perf base: $des_perf_base comprison: $des_perf_comp percent: $des_perf_drop\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\tfreq_drop=`echo \"scale=4;($freq_comp-$freq_base)*100/$freq_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Tbench-$1 freq base: $freq_base comprison: $freq_comp percent: $freq_drop\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\tload_drop=`echo \"scale=4;($load_comp-$load_base)*100/$load_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Tbench-$1 load base: $load_base comprison: $load_comp percent: $load_drop\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\tperf_drop=`echo \"scale=4;($perf_comp-$perf_base)*100/$perf_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Tbench-$1 perf base: $perf_base comprison: $perf_comp percent: $perf_drop\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\tenergy_drop=`echo \"scale=4;($energy_comp-$energy_base)*100/$energy_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Tbench-$1 energy base: $energy_base comprison: $energy_comp percent: $energy_drop\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\tppw_drop=`echo \"scale=4;($ppw_comp-$ppw_base)*100/$ppw_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Tbench-$1 performance per watt base: $ppw_base comprison: $ppw_comp percent: $ppw_drop\\n\" | tee -a $OUTFILE_TBENCH.result\n\t\tprintf \"\\n\" | tee -a $OUTFILE_TBENCH.result\n\n\t\tstore_csv_tbench \"$1-$2 VS $3-$4\" \"Comprison(%)\" \"$des_perf_drop\" \"$freq_drop\" \"$load_drop\" \"$perf_drop\" \"$energy_drop\" \"$ppw_drop\"\n\tfi\n}\n\n# calculate the comparison(%)\ncalc_comp_tbench()\n{\n\t# acpi-cpufreq-ondemand VS acpi-cpufreq-schedutil\n\t__calc_comp_tbench ${all_scaling_names[0]} ${tbench_governors[0]} ${all_scaling_names[0]} ${tbench_governors[1]}\n\n\t# amd-pstate-ondemand VS amd-pstate-schedutil\n\t__calc_comp_tbench ${all_scaling_names[1]} ${tbench_governors[0]} ${all_scaling_names[1]} ${tbench_governors[1]}\n\n\t# acpi-cpufreq-ondemand VS amd-pstate-ondemand\n\t__calc_comp_tbench ${all_scaling_names[0]} ${tbench_governors[0]} ${all_scaling_names[1]} ${tbench_governors[0]}\n\n\t# acpi-cpufreq-schedutil VS amd-pstate-schedutil\n\t__calc_comp_tbench ${all_scaling_names[0]} ${tbench_governors[1]} ${all_scaling_names[1]} ${tbench_governors[1]}\n}\n\n# $1: file_name, $2: title, $3: ylable, $4: column\nplot_png_tbench()\n{\n\t# all_scaling_names[1] all_scaling_names[0] flag\n\t#    amd-pstate           acpi-cpufreq\n\t#         N                   N             0\n\t#         N                   Y             1\n\t#         Y                   N             2\n\t#         Y                   Y             3\n\tret=`grep -c \"${all_scaling_names[1]}\" $OUTFILE_TBENCH.csv`\n\tif [ $ret -eq 0 ]; then\n\t\tret=`grep -c \"${all_scaling_names[0]}\" $OUTFILE_TBENCH.csv`\n\t\tif [ $ret -eq 0 ]; then\n\t\t\tflag=0\n\t\telse\n\t\t\tflag=1\n\t\tfi\n\telse\n\t\tret=`grep -c \"${all_scaling_names[0]}\" $OUTFILE_TBENCH.csv`\n\t\tif [ $ret -eq 0 ]; then\n\t\t\tflag=2\n\t\telse\n\t\t\tflag=3\n\t\tfi\n\tfi\n\n\tgnuplot << EOF\n\t\tset term png\n\t\tset output \"$1\"\n\n\t\tset title \"$2\"\n\t\tset xlabel \"Test Cycles (round)\"\n\t\tset ylabel \"$3\"\n\n\t\tset grid\n\t\tset style data histogram\n\t\tset style fill solid 0.5 border\n\t\tset boxwidth 0.8\n\n\t\tif ($flag == 1) {\n\t\t\tplot \\\n\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${tbench_governors[0]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${tbench_governors[0]}\", \\\n\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${tbench_governors[1]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${tbench_governors[1]}\"\n\t\t} else {\n\t\t\tif ($flag == 2) {\n\t\t\t\tplot \\\n\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${tbench_governors[0]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${tbench_governors[0]}\", \\\n\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${tbench_governors[1]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${tbench_governors[1]}\"\n\t\t\t} else {\n\t\t\t\tif ($flag == 3 ) {\n\t\t\t\t\tplot \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${tbench_governors[0]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${tbench_governors[0]}\", \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${tbench_governors[1]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${tbench_governors[1]}\", \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${tbench_governors[0]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${tbench_governors[0]}\", \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${tbench_governors[1]}/p' $OUTFILE_TBENCH.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${tbench_governors[1]}\"\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tquit\nEOF\n}\n\namd_pstate_tbench()\n{\n\tprintf \"\\n---------------------------------------------\\n\"\n\tprintf \"*** Running tbench                        ***\"\n\tprintf \"\\n---------------------------------------------\\n\"\n\n\tpre_clear_tbench\n\n\tget_lines_csv_tbench \"Governor\"\n\tif [ $? -eq 0 ]; then\n\t\t# add titles and unit for csv file\n\t\tstore_csv_tbench \"Governor\" \"Round\" \"Des-perf\" \"Freq\" \"Load\" \"Performance\" \"Energy\" \"Performance Per Watt\"\n\t\tstore_csv_tbench \"Unit\" \"\" \"\" \"GHz\" \"\" \"MB/s\" \"J\" \"MB/J\"\n\tfi\n\n\tbackup_governor\n\tfor governor in ${tbench_governors[*]} ; do\n\t\tprintf \"\\nSpecified governor is $governor\\n\\n\"\n\t\tswitch_governor $governor\n\t\tloop_tbench $governor\n\t\tgather_tbench $governor\n\tdone\n\trestore_governor\n\n\tplot_png_tbench \"tbench_perfromance.png\" \"Tbench Benchmark Performance\" \"Performance\" 6\n\tplot_png_tbench \"tbench_energy.png\" \"Tbench Benchmark Energy\" \"Energy (J)\" 7\n\tplot_png_tbench \"tbench_ppw.png\" \"Tbench Benchmark Performance Per Watt\" \"Performance Per Watt (MB/J)\" 8\n\n\tcalc_comp_tbench\n\n\tpost_clear_tbench\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}