{
  "module_name": "gitsource.sh",
  "hash_id": "7b71b1dc29a994fa803aab6f3fc5c3e9131bd41586abb62fbf9c82ea9803d869",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/amd-pstate/gitsource.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\n# Testing and monitor the cpu desire performance, frequency, load,\n# power consumption and throughput etc. when this script trigger\n# gitsource test.\n# 1) Download and tar gitsource codes.\n# 2) Run gitsource benchmark on specific governors, ondemand or schedutil.\n# 3) Run tbench benchmark comparative test on acpi-cpufreq kernel driver.\n# 4) Get desire performance, frequency, load by perf.\n# 5) Get power consumption and throughput by amd_pstate_trace.py.\n# 6) Get run time by /usr/bin/time.\n# 7) Analyse test results and save it in file selftest.gitsource.csv.\n#8) Plot png images about time, energy and performance per watt for each test.\n\n# protect against multiple inclusion\nif [ $FILE_GITSOURCE ]; then\n\treturn 0\nelse\n\tFILE_GITSOURCE=DONE\nfi\n\ngit_name=\"git-2.15.1\"\ngit_tar=\"$git_name.tar.gz\"\ngitsource_url=\"https://github.com/git/git/archive/refs/tags/v2.15.1.tar.gz\"\ngitsource_governors=(\"ondemand\" \"schedutil\")\n\n# $1: governor, $2: round, $3: des-perf, $4: freq, $5: load, $6: time $7: energy, $8: PPW\nstore_csv_gitsource()\n{\n\techo \"$1, $2, $3, $4, $5, $6, $7, $8\" | tee -a $OUTFILE_GIT.csv > /dev/null 2>&1\n}\n\n# clear some special lines\nclear_csv_gitsource()\n{\n\tif [ -f $OUTFILE_GIT.csv ]; then\n\t\tsed -i '/Comprison(%)/d' $OUTFILE_GIT.csv\n\t\tsed -i \"/$(scaling_name)/d\" $OUTFILE_GIT.csv\n\tfi\n}\n\n# find string $1 in file csv and get the number of lines\nget_lines_csv_gitsource()\n{\n\tif [ -f $OUTFILE_GIT.csv ]; then\n\t\treturn `grep -c \"$1\" $OUTFILE_GIT.csv`\n\telse\n\t\treturn 0\n\tfi\n}\n\npre_clear_gitsource()\n{\n\tpost_clear_gitsource\n\trm -rf gitsource_*.png\n\tclear_csv_gitsource\n}\n\npost_clear_gitsource()\n{\n\trm -rf results/tracer-gitsource*\n\trm -rf $OUTFILE_GIT*.log\n\trm -rf $OUTFILE_GIT*.result\n}\n\ninstall_gitsource()\n{\n\tif [ ! -d $git_name ]; then\n\t\tprintf \"Download gitsource, please wait a moment ...\\n\\n\"\n\t\twget -O $git_tar $gitsource_url > /dev/null 2>&1\n\n\t\tprintf \"Tar gitsource ...\\n\\n\"\n\t\ttar -xzf $git_tar\n\tfi\n}\n\n# $1: governor, $2: loop\nrun_gitsource()\n{\n\techo \"Launching amd pstate tracer for $1 #$2 tracer_interval: $TRACER_INTERVAL\"\n\t./amd_pstate_trace.py -n tracer-gitsource-$1-$2 -i $TRACER_INTERVAL > /dev/null 2>&1 &\n\n\tprintf \"Make and test gitsource for $1 #$2 make_cpus: $MAKE_CPUS\\n\"\n\tcd $git_name\n\tperf stat -a --per-socket -I 1000 -e power/energy-pkg/ /usr/bin/time -o ../$OUTFILE_GIT.time-gitsource-$1-$2.log make test -j$MAKE_CPUS > ../$OUTFILE_GIT-perf-$1-$2.log 2>&1\n\tcd ..\n\n\tfor job in `jobs -p`\n\tdo\n\t\techo \"Waiting for job id $job\"\n\t\twait $job\n\tdone\n}\n\n# $1: governor, $2: loop\nparse_gitsource()\n{\n\tawk '{print $5}' results/tracer-gitsource-$1-$2/cpu.csv | sed -e '1d' | sed s/,// > $OUTFILE_GIT-des-perf-$1-$2.log\n\tavg_des_perf=$(awk 'BEGIN {i=0; sum=0};{i++; sum += $1};END {print sum/i}' $OUTFILE_GIT-des-perf-$1-$2.log)\n\tprintf \"Gitsource-$1-#$2 avg des perf: $avg_des_perf\\n\" | tee -a $OUTFILE_GIT.result\n\n\tawk '{print $7}' results/tracer-gitsource-$1-$2/cpu.csv | sed -e '1d' | sed s/,// > $OUTFILE_GIT-freq-$1-$2.log\n\tavg_freq=$(awk 'BEGIN {i=0; sum=0};{i++; sum += $1};END {print sum/i}' $OUTFILE_GIT-freq-$1-$2.log)\n\tprintf \"Gitsource-$1-#$2 avg freq: $avg_freq\\n\" | tee -a $OUTFILE_GIT.result\n\n\tawk '{print $11}' results/tracer-gitsource-$1-$2/cpu.csv | sed -e '1d' | sed s/,// > $OUTFILE_GIT-load-$1-$2.log\n\tavg_load=$(awk 'BEGIN {i=0; sum=0};{i++; sum += $1};END {print sum/i}' $OUTFILE_GIT-load-$1-$2.log)\n\tprintf \"Gitsource-$1-#$2 avg load: $avg_load\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep user $OUTFILE_GIT.time-gitsource-$1-$2.log | awk '{print $1}' | sed -e 's/user//' > $OUTFILE_GIT-time-$1-$2.log\n\ttime_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_GIT-time-$1-$2.log)\n\tprintf \"Gitsource-$1-#$2 user time(s): $time_sum\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep Joules $OUTFILE_GIT-perf-$1-$2.log | awk '{print $4}' > $OUTFILE_GIT-energy-$1-$2.log\n\ten_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_GIT-energy-$1-$2.log)\n\tprintf \"Gitsource-$1-#$2 power consumption(J): $en_sum\\n\" | tee -a $OUTFILE_GIT.result\n\n\t# Permance is the number of run gitsource per second, denoted 1/t, where 1 is the number of run gitsource in t\n\t# seconds. It is well known that P=E/t, where P is power measured in watts(W), E is energy measured in joules(J),\n\t# and t is time measured in seconds(s). This means that performance per watt becomes\n\t#        1/t     1/t     1\n\t#       ----- = ----- = ---\n\t#         P      E/t     E\n\t# with unit given by 1 per joule.\n\tppw=`echo \"scale=9;1/$en_sum\" | bc | awk '{printf \"%.9f\", $0}'`\n\tprintf \"Gitsource-$1-#$2 performance per watt(1/J): $ppw\\n\" | tee -a $OUTFILE_GIT.result\n\tprintf \"\\n\" | tee -a $OUTFILE_GIT.result\n\n\tdriver_name=`echo $(scaling_name)`\n\tstore_csv_gitsource \"$driver_name-$1\" $2 $avg_des_perf $avg_freq $avg_load $time_sum $en_sum $ppw\n}\n\n# $1: governor\nloop_gitsource()\n{\n\tprintf \"\\nGitsource total test times is $LOOP_TIMES for $1\\n\\n\"\n\tfor i in `seq 1 $LOOP_TIMES`\n\tdo\n\t\trun_gitsource $1 $i\n\t\tparse_gitsource $1 $i\n\tdone\n}\n\n# $1: governor\ngather_gitsource()\n{\n\tprintf \"Gitsource test result for $1 (loops:$LOOP_TIMES)\" | tee -a $OUTFILE_GIT.result\n\tprintf \"\\n--------------------------------------------------\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep \"Gitsource-$1-#\" $OUTFILE_GIT.result | grep \"avg des perf:\" | awk '{print $NF}' > $OUTFILE_GIT-des-perf-$1.log\n\tavg_des_perf=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_GIT-des-perf-$1.log)\n\tprintf \"Gitsource-$1 avg des perf: $avg_des_perf\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep \"Gitsource-$1-#\" $OUTFILE_GIT.result | grep \"avg freq:\" | awk '{print $NF}' > $OUTFILE_GIT-freq-$1.log\n\tavg_freq=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_GIT-freq-$1.log)\n\tprintf \"Gitsource-$1 avg freq: $avg_freq\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep \"Gitsource-$1-#\" $OUTFILE_GIT.result | grep \"avg load:\" | awk '{print $NF}' > $OUTFILE_GIT-load-$1.log\n\tavg_load=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_GIT-load-$1.log)\n\tprintf \"Gitsource-$1 avg load: $avg_load\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep \"Gitsource-$1-#\" $OUTFILE_GIT.result | grep \"user time(s):\" | awk '{print $NF}' > $OUTFILE_GIT-time-$1.log\n\ttime_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_GIT-time-$1.log)\n\tprintf \"Gitsource-$1 total user time(s): $time_sum\\n\" | tee -a $OUTFILE_GIT.result\n\n\tavg_time=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_GIT-time-$1.log)\n\tprintf \"Gitsource-$1 avg user times(s): $avg_time\\n\" | tee -a $OUTFILE_GIT.result\n\n\tgrep \"Gitsource-$1-#\" $OUTFILE_GIT.result | grep \"power consumption(J):\" | awk '{print $NF}' > $OUTFILE_GIT-energy-$1.log\n\ten_sum=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum}' $OUTFILE_GIT-energy-$1.log)\n\tprintf \"Gitsource-$1 total power consumption(J): $en_sum\\n\" | tee -a $OUTFILE_GIT.result\n\n\tavg_en=$(awk 'BEGIN {sum=0};{sum += $1};END {print sum/'$LOOP_TIMES'}' $OUTFILE_GIT-energy-$1.log)\n\tprintf \"Gitsource-$1 avg power consumption(J): $avg_en\\n\" | tee -a $OUTFILE_GIT.result\n\n\t# Permance is the number of run gitsource per second, denoted 1/t, where 1 is the number of run gitsource in t\n\t# seconds. It is well known that P=E/t, where P is power measured in watts(W), E is energy measured in joules(J),\n\t# and t is time measured in seconds(s). This means that performance per watt becomes\n\t#        1/t     1/t     1\n\t#       ----- = ----- = ---\n\t#         P      E/t     E\n\t# with unit given by 1 per joule.\n\tppw=`echo \"scale=9;1/$avg_en\" | bc | awk '{printf \"%.9f\", $0}'`\n\tprintf \"Gitsource-$1 performance per watt(1/J): $ppw\\n\" | tee -a $OUTFILE_GIT.result\n\tprintf \"\\n\" | tee -a $OUTFILE_GIT.result\n\n\tdriver_name=`echo $(scaling_name)`\n\tstore_csv_gitsource \"$driver_name-$1\" \"Average\" $avg_des_perf $avg_freq $avg_load $avg_time $avg_en $ppw\n}\n\n# $1: base scaling_driver $2: base governor $3: comparison scaling_driver $4: comparison governor\n__calc_comp_gitsource()\n{\n\tbase=`grep \"$1-$2\" $OUTFILE_GIT.csv | grep \"Average\"`\n\tcomp=`grep \"$3-$4\" $OUTFILE_GIT.csv | grep \"Average\"`\n\n\tif [ -n \"$base\" -a -n \"$comp\" ]; then\n\t\tprintf \"\\n==================================================\\n\" | tee -a $OUTFILE_GIT.result\n\t\tprintf \"Gitsource comparison $1-$2 VS $3-$4\" | tee -a $OUTFILE_GIT.result\n\t\tprintf \"\\n==================================================\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\t# get the base values\n\t\tdes_perf_base=`echo \"$base\" | awk '{print $3}' | sed s/,//`\n\t\tfreq_base=`echo \"$base\" | awk '{print $4}' | sed s/,//`\n\t\tload_base=`echo \"$base\" | awk '{print $5}' | sed s/,//`\n\t\ttime_base=`echo \"$base\" | awk '{print $6}' | sed s/,//`\n\t\tenergy_base=`echo \"$base\" | awk '{print $7}' | sed s/,//`\n\t\tppw_base=`echo \"$base\" | awk '{print $8}' | sed s/,//`\n\n\t\t# get the comparison values\n\t\tdes_perf_comp=`echo \"$comp\" | awk '{print $3}' | sed s/,//`\n\t\tfreq_comp=`echo \"$comp\" | awk '{print $4}' | sed s/,//`\n\t\tload_comp=`echo \"$comp\" | awk '{print $5}' | sed s/,//`\n\t\ttime_comp=`echo \"$comp\" | awk '{print $6}' | sed s/,//`\n\t\tenergy_comp=`echo \"$comp\" | awk '{print $7}' | sed s/,//`\n\t\tppw_comp=`echo \"$comp\" | awk '{print $8}' | sed s/,//`\n\n\t\t# compare the base and comp values\n\t\tdes_perf_drop=`echo \"scale=4;($des_perf_comp-$des_perf_base)*100/$des_perf_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Gitsource-$1 des perf base: $des_perf_base comprison: $des_perf_comp percent: $des_perf_drop\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\tfreq_drop=`echo \"scale=4;($freq_comp-$freq_base)*100/$freq_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Gitsource-$1 freq base: $freq_base comprison: $freq_comp percent: $freq_drop\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\tload_drop=`echo \"scale=4;($load_comp-$load_base)*100/$load_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Gitsource-$1 load base: $load_base comprison: $load_comp percent: $load_drop\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\ttime_drop=`echo \"scale=4;($time_comp-$time_base)*100/$time_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Gitsource-$1 time base: $time_base comprison: $time_comp percent: $time_drop\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\tenergy_drop=`echo \"scale=4;($energy_comp-$energy_base)*100/$energy_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Gitsource-$1 energy base: $energy_base comprison: $energy_comp percent: $energy_drop\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\tppw_drop=`echo \"scale=4;($ppw_comp-$ppw_base)*100/$ppw_base\" | bc | awk '{printf \"%.4f\", $0}'`\n\t\tprintf \"Gitsource-$1 performance per watt base: $ppw_base comprison: $ppw_comp percent: $ppw_drop\\n\" | tee -a $OUTFILE_GIT.result\n\t\tprintf \"\\n\" | tee -a $OUTFILE_GIT.result\n\n\t\tstore_csv_gitsource \"$1-$2 VS $3-$4\" \"Comprison(%)\" \"$des_perf_drop\" \"$freq_drop\" \"$load_drop\" \"$time_drop\" \"$energy_drop\" \"$ppw_drop\"\n\tfi\n}\n\n# calculate the comparison(%)\ncalc_comp_gitsource()\n{\n\t# acpi-cpufreq-ondemand VS acpi-cpufreq-schedutil\n\t__calc_comp_gitsource ${all_scaling_names[0]} ${gitsource_governors[0]} ${all_scaling_names[0]} ${gitsource_governors[1]}\n\n\t# amd-pstate-ondemand VS amd-pstate-schedutil\n\t__calc_comp_gitsource ${all_scaling_names[1]} ${gitsource_governors[0]} ${all_scaling_names[1]} ${gitsource_governors[1]}\n\n\t# acpi-cpufreq-ondemand VS amd-pstate-ondemand\n\t__calc_comp_gitsource ${all_scaling_names[0]} ${gitsource_governors[0]} ${all_scaling_names[1]} ${gitsource_governors[0]}\n\n\t# acpi-cpufreq-schedutil VS amd-pstate-schedutil\n\t__calc_comp_gitsource ${all_scaling_names[0]} ${gitsource_governors[1]} ${all_scaling_names[1]} ${gitsource_governors[1]}\n}\n\n# $1: file_name, $2: title, $3: ylable, $4: column\nplot_png_gitsource()\n{\n\t# all_scaling_names[1] all_scaling_names[0] flag\n\t#    amd-pstate           acpi-cpufreq\n\t#         N                   N             0\n\t#         N                   Y             1\n\t#         Y                   N             2\n\t#         Y                   Y             3\n\tret=`grep -c \"${all_scaling_names[1]}\" $OUTFILE_GIT.csv`\n\tif [ $ret -eq 0 ]; then\n\t\tret=`grep -c \"${all_scaling_names[0]}\" $OUTFILE_GIT.csv`\n\t\tif [ $ret -eq 0 ]; then\n\t\t\tflag=0\n\t\telse\n\t\t\tflag=1\n\t\tfi\n\telse\n\t\tret=`grep -c \"${all_scaling_names[0]}\" $OUTFILE_GIT.csv`\n\t\tif [ $ret -eq 0 ]; then\n\t\t\tflag=2\n\t\telse\n\t\t\tflag=3\n\t\tfi\n\tfi\n\n\tgnuplot << EOF\n\t\tset term png\n\t\tset output \"$1\"\n\n\t\tset title \"$2\"\n\t\tset xlabel \"Test Cycles (round)\"\n\t\tset ylabel \"$3\"\n\n\t\tset grid\n\t\tset style data histogram\n\t\tset style fill solid 0.5 border\n\t\tset boxwidth 0.8\n\n\t\tif ($flag == 1) {\n\t\t\tplot \\\n\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${gitsource_governors[0]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${gitsource_governors[0]}\", \\\n\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${gitsource_governors[1]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${gitsource_governors[1]}\"\n\t\t} else {\n\t\t\tif ($flag == 2) {\n\t\t\t\tplot \\\n\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${gitsource_governors[0]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${gitsource_governors[0]}\", \\\n\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${gitsource_governors[1]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${gitsource_governors[1]}\"\n\t\t\t} else {\n\t\t\t\tif ($flag == 3 ) {\n\t\t\t\t\tplot \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${gitsource_governors[0]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${gitsource_governors[0]}\", \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[0]}-${gitsource_governors[1]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[0]}-${gitsource_governors[1]}\", \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${gitsource_governors[0]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${gitsource_governors[0]}\", \\\n\t\t\t\t\t\"<(sed -n -e 's/,//g' -e '/${all_scaling_names[1]}-${gitsource_governors[1]}/p' $OUTFILE_GIT.csv)\" using $4:xtic(2) title \"${all_scaling_names[1]}-${gitsource_governors[1]}\"\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tquit\nEOF\n}\n\namd_pstate_gitsource()\n{\n\tprintf \"\\n---------------------------------------------\\n\"\n\tprintf \"*** Running gitsource                     ***\"\n\tprintf \"\\n---------------------------------------------\\n\"\n\n\tpre_clear_gitsource\n\n\tinstall_gitsource\n\n\tget_lines_csv_gitsource \"Governor\"\n\tif [ $? -eq 0 ]; then\n\t\t# add titles and unit for csv file\n\t\tstore_csv_gitsource \"Governor\" \"Round\" \"Des-perf\" \"Freq\" \"Load\" \"Time\" \"Energy\" \"Performance Per Watt\"\n\t\tstore_csv_gitsource \"Unit\" \"\" \"\" \"GHz\" \"\" \"s\" \"J\" \"1/J\"\n\tfi\n\n\tbackup_governor\n\tfor governor in ${gitsource_governors[*]} ; do\n\t\tprintf \"\\nSpecified governor is $governor\\n\\n\"\n\t\tswitch_governor $governor\n\t\tloop_gitsource $governor\n\t\tgather_gitsource $governor\n\tdone\n\trestore_governor\n\n\tplot_png_gitsource \"gitsource_time.png\" \"Gitsource Benchmark Time\" \"Time (s)\" 6\n\tplot_png_gitsource \"gitsource_energy.png\" \"Gitsource Benchmark Energy\" \"Energy (J)\" 7\n\tplot_png_gitsource \"gitsource_ppw.png\" \"Gitsource Benchmark Performance Per Watt\" \"Performance Per Watt (1/J)\" 8\n\n\tcalc_comp_gitsource\n\n\tpost_clear_gitsource\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}