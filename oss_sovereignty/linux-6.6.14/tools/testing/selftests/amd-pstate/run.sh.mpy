{
  "module_name": "run.sh",
  "hash_id": "d24a62ee64b77e51178a18370b7334b40118c750f56ef08255e4bcf6d851e0a0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/amd-pstate/run.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# protect against multiple inclusion\nif [ $FILE_MAIN ]; then\n\treturn 0\nelse\n\tFILE_MAIN=DONE\nfi\n\nsource basic.sh\nsource tbench.sh\nsource gitsource.sh\n\n# amd-pstate-ut only run on x86/x86_64 AMD systems.\nARCH=$(uname -m 2>/dev/null | sed -e 's/i.86/x86/' -e 's/x86_64/x86/')\nVENDOR=$(cat /proc/cpuinfo | grep -m 1 'vendor_id' | awk '{print $NF}')\n\nmsg=\"Skip all tests:\"\nFUNC=all\nOUTFILE=selftest\nOUTFILE_TBENCH=\"$OUTFILE.tbench\"\nOUTFILE_GIT=\"$OUTFILE.gitsource\"\n\nSYSFS=\nCPUROOT=\nCPUFREQROOT=\nMAKE_CPUS=\n\nTIME_LIMIT=100\nPROCESS_NUM=128\nLOOP_TIMES=3\nTRACER_INTERVAL=10\nCURRENT_TEST=amd-pstate\nCOMPARATIVE_TEST=\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\nall_scaling_names=(\"acpi-cpufreq\" \"amd-pstate\")\n\n# Get current cpufreq scaling driver name\nscaling_name()\n{\n\tif [ \"$COMPARATIVE_TEST\" = \"\" ]; then\n\t\techo \"$CURRENT_TEST\"\n\telse\n\t\techo \"$COMPARATIVE_TEST\"\n\tfi\n}\n\n# Counts CPUs with cpufreq directories\ncount_cpus()\n{\n\tcount=0;\n\n\tfor cpu in `ls $CPUROOT | grep \"cpu[0-9].*\"`; do\n\t\tif [ -d $CPUROOT/$cpu/cpufreq ]; then\n\t\t\tlet count=count+1;\n\t\tfi\n\tdone\n\n\techo $count;\n}\n\n# $1: policy\nfind_current_governor()\n{\n\tcat $CPUFREQROOT/$1/scaling_governor\n}\n\nbackup_governor()\n{\n\tpolicies=$(ls $CPUFREQROOT| grep \"policy[0-9].*\")\n\tfor policy in $policies; do\n\t\tcur_gov=$(find_current_governor $policy)\n\t\techo \"$policy $cur_gov\" >> $OUTFILE.backup_governor.log\n\tdone\n\n\tprintf \"Governor $cur_gov backup done.\\n\"\n}\n\nrestore_governor()\n{\n\ti=0;\n\n\tpolicies=$(awk '{print $1}' $OUTFILE.backup_governor.log)\n\tfor policy in $policies; do\n\t\tlet i++;\n\t\tgovernor=$(sed -n ''$i'p' $OUTFILE.backup_governor.log | awk '{print $2}')\n\n\t\t# switch governor\n\t\techo $governor > $CPUFREQROOT/$policy/scaling_governor\n\tdone\n\n\tprintf \"Governor restored to $governor.\\n\"\n}\n\n# $1: governor\nswitch_governor()\n{\n\tpolicies=$(ls $CPUFREQROOT| grep \"policy[0-9].*\")\n\tfor policy in $policies; do\n\t\tfilepath=$CPUFREQROOT/$policy/scaling_available_governors\n\n\t\t# Exit if cpu isn't managed by cpufreq core\n\t\tif [ ! -f $filepath ]; then\n\t\t\treturn;\n\t\tfi\n\n\t\techo $1 > $CPUFREQROOT/$policy/scaling_governor\n\tdone\n\n\tprintf \"Switched governor to $1.\\n\"\n}\n\n# All amd-pstate tests\namd_pstate_all()\n{\n\tprintf \"\\n=============================================\\n\"\n\tprintf \"***** Running AMD P-state Sanity Tests  *****\\n\"\n\tprintf \"=============================================\\n\\n\"\n\n\tcount=$(count_cpus)\n\tif [ $count = 0 ]; then\n\t\tprintf \"No cpu is managed by cpufreq core, exiting\\n\"\n\t\texit;\n\telse\n\t\tprintf \"AMD P-state manages: $count CPUs\\n\"\n\tfi\n\n\t# unit test for amd-pstate kernel driver\n\tamd_pstate_basic\n\n\t# tbench\n\tamd_pstate_tbench\n\n\t# gitsource\n\tamd_pstate_gitsource\n}\n\nhelp()\n{\n\tprintf \"Usage: $0 [OPTION...]\n\t[-h <help>]\n\t[-o <output-file-for-dump>]\n\t[-c <all: All testing,\n\t     basic: Basic testing,\n\t     tbench: Tbench testing,\n\t     gitsource: Gitsource testing.>]\n\t[-t <tbench time limit>]\n\t[-p <tbench process number>]\n\t[-l <loop times for tbench>]\n\t[-i <amd tracer interval>]\n\t[-m <comparative test: acpi-cpufreq>]\n\t\\n\"\n\texit 2\n}\n\nparse_arguments()\n{\n\twhile getopts ho:c:t:p:l:i:m: arg\n\tdo\n\t\tcase $arg in\n\t\t\th) # --help\n\t\t\t\thelp\n\t\t\t\t;;\n\n\t\t\tc) # --func_type (Function to perform: basic, tbench, gitsource (default: all))\n\t\t\t\tFUNC=$OPTARG\n\t\t\t\t;;\n\n\t\t\to) # --output-file (Output file to store dumps)\n\t\t\t\tOUTFILE=$OPTARG\n\t\t\t\t;;\n\n\t\t\tt) # --tbench-time-limit\n\t\t\t\tTIME_LIMIT=$OPTARG\n\t\t\t\t;;\n\n\t\t\tp) # --tbench-process-number\n\t\t\t\tPROCESS_NUM=$OPTARG\n\t\t\t\t;;\n\n\t\t\tl) # --tbench/gitsource-loop-times\n\t\t\t\tLOOP_TIMES=$OPTARG\n\t\t\t\t;;\n\n\t\t\ti) # --amd-tracer-interval\n\t\t\t\tTRACER_INTERVAL=$OPTARG\n\t\t\t\t;;\n\n\t\t\tm) # --comparative-test\n\t\t\t\tCOMPARATIVE_TEST=$OPTARG\n\t\t\t\t;;\n\n\t\t\t*)\n\t\t\t\thelp\n\t\t\t\t;;\n\t\tesac\n\tdone\n}\n\ncommand_perf()\n{\n\tif ! command -v perf > /dev/null; then\n\t\techo $msg please install perf. >&2\n\t\texit $ksft_skip\n\tfi\n}\n\ncommand_tbench()\n{\n\tif ! command -v tbench > /dev/null; then\n\t\tif apt policy dbench > /dev/null 2>&1; then\n\t\t\techo $msg apt install dbench >&2\n\t\t\texit $ksft_skip\n\t\telif yum list available | grep dbench > /dev/null 2>&1; then\n\t\t\techo $msg yum install dbench >&2\n\t\t\texit $ksft_skip\n\t\tfi\n\tfi\n\n\tif ! command -v tbench > /dev/null; then\n\t\techo $msg please install tbench. >&2\n\t\texit $ksft_skip\n\tfi\n}\n\nprerequisite()\n{\n\tif ! echo \"$ARCH\" | grep -q x86; then\n\t\techo \"$0 # Skipped: Test can only run on x86 architectures.\"\n\t\texit $ksft_skip\n\tfi\n\n\tif ! echo \"$VENDOR\" | grep -iq amd; then\n\t\techo \"$0 # Skipped: Test can only run on AMD CPU.\"\n\t\techo \"$0 # Current cpu vendor is $VENDOR.\"\n\t\texit $ksft_skip\n\tfi\n\n\tscaling_driver=$(cat /sys/devices/system/cpu/cpufreq/policy0/scaling_driver)\n\tif [ \"$COMPARATIVE_TEST\" = \"\" ]; then\n\t\tif [ \"$scaling_driver\" != \"$CURRENT_TEST\" ]; then\n\t\t\techo \"$0 # Skipped: Test can only run on $CURRENT_TEST driver or run comparative test.\"\n\t\t\techo \"$0 # Please set X86_AMD_PSTATE enabled or run comparative test.\"\n\t\t\techo \"$0 # Current cpufreq scaling driver is $scaling_driver.\"\n\t\t\texit $ksft_skip\n\t\tfi\n\telse\n\t\tcase \"$FUNC\" in\n\t\t\t\"tbench\" | \"gitsource\")\n\t\t\t\tif [ \"$scaling_driver\" != \"$COMPARATIVE_TEST\" ]; then\n\t\t\t\t\techo \"$0 # Skipped: Comparison test can only run on $COMPARISON_TEST driver.\"\n\t\t\t\t\techo \"$0 # Current cpufreq scaling driver is $scaling_driver.\"\n\t\t\t\t\texit $ksft_skip\n\t\t\t\tfi\n\t\t\t\t;;\n\n\t\t\t*)\n\t\t\t\techo \"$0 # Skipped: Comparison test are only for tbench or gitsource.\"\n\t\t\t\techo \"$0 # Current comparative test is for $FUNC.\"\n\t\t\t\texit $ksft_skip\n\t\t\t\t;;\n\t\tesac\n\tfi\n\n\tif [ ! -w /dev ]; then\n\t\techo $msg please run this as root >&2\n\t\texit $ksft_skip\n\tfi\n\n\tcase \"$FUNC\" in\n\t\t\"all\")\n\t\t\tcommand_perf\n\t\t\tcommand_tbench\n\t\t\t;;\n\n\t\t\"tbench\")\n\t\t\tcommand_perf\n\t\t\tcommand_tbench\n\t\t\t;;\n\n\t\t\"gitsource\")\n\t\t\tcommand_perf\n\t\t\t;;\n\tesac\n\n\tSYSFS=`mount -t sysfs | head -1 | awk '{ print $3 }'`\n\n\tif [ ! -d \"$SYSFS\" ]; then\n\t\techo $msg sysfs is not mounted >&2\n\t\texit 2\n\tfi\n\n\tCPUROOT=$SYSFS/devices/system/cpu\n\tCPUFREQROOT=\"$CPUROOT/cpufreq\"\n\n\tif ! ls $CPUROOT/cpu* > /dev/null 2>&1; then\n\t\techo $msg cpus not available in sysfs >&2\n\t\texit 2\n\tfi\n\n\tif ! ls $CPUROOT/cpufreq > /dev/null 2>&1; then\n\t\techo $msg cpufreq directory not available in sysfs >&2\n\t\texit 2\n\tfi\n}\n\ndo_test()\n{\n\t# Check if CPUs are managed by cpufreq or not\n\tcount=$(count_cpus)\n\tMAKE_CPUS=$((count*2))\n\n\tif [ $count = 0 ]; then\n\t\techo \"No cpu is managed by cpufreq core, exiting\"\n\t\texit 2;\n\tfi\n\n\tcase \"$FUNC\" in\n\t\t\"all\")\n\t\t\tamd_pstate_all\n\t\t\t;;\n\n\t\t\"basic\")\n\t\t\tamd_pstate_basic\n\t\t\t;;\n\n\t\t\"tbench\")\n\t\t\tamd_pstate_tbench\n\t\t\t;;\n\n\t\t\"gitsource\")\n\t\t\tamd_pstate_gitsource\n\t\t\t;;\n\n\t\t*)\n\t\t\techo \"Invalid [-f] function type\"\n\t\t\thelp\n\t\t\t;;\n\tesac\n}\n\n# clear dumps\npre_clear_dumps()\n{\n\tcase \"$FUNC\" in\n\t\t\"all\")\n\t\t\trm -rf $OUTFILE.log\n\t\t\trm -rf $OUTFILE.backup_governor.log\n\t\t\trm -rf *.png\n\t\t\t;;\n\n\t\t\"tbench\")\n\t\t\trm -rf $OUTFILE.log\n\t\t\trm -rf $OUTFILE.backup_governor.log\n\t\t\trm -rf tbench_*.png\n\t\t\t;;\n\n\t\t\"gitsource\")\n\t\t\trm -rf $OUTFILE.log\n\t\t\trm -rf $OUTFILE.backup_governor.log\n\t\t\trm -rf gitsource_*.png\n\t\t\t;;\n\n\t\t*)\n\t\t\t;;\n\tesac\n}\n\npost_clear_dumps()\n{\n\trm -rf $OUTFILE.log\n\trm -rf $OUTFILE.backup_governor.log\n}\n\n# Parse arguments\nparse_arguments $@\n\n# Make sure all requirements are met\nprerequisite\n\n# Run requested functions\npre_clear_dumps\ndo_test | tee -a $OUTFILE.log\npost_clear_dumps\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}