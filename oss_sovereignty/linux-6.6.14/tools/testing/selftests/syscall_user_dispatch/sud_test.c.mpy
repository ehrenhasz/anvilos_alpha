{
  "module_name": "sud_test.c",
  "hash_id": "913e99f2db2973195004de997c188baa974ea6d4884a4369d001734ad59c9b7b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/syscall_user_dispatch/sud_test.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <sys/prctl.h>\n#include <sys/sysinfo.h>\n#include <sys/syscall.h>\n#include <signal.h>\n\n#include <asm/unistd.h>\n#include \"../kselftest_harness.h\"\n\n#ifndef PR_SET_SYSCALL_USER_DISPATCH\n# define PR_SET_SYSCALL_USER_DISPATCH\t59\n# define PR_SYS_DISPATCH_OFF\t0\n# define PR_SYS_DISPATCH_ON\t1\n# define SYSCALL_DISPATCH_FILTER_ALLOW\t0\n# define SYSCALL_DISPATCH_FILTER_BLOCK\t1\n#endif\n\n#ifndef SYS_USER_DISPATCH\n# define SYS_USER_DISPATCH\t2\n#endif\n\n#ifdef __NR_syscalls\n# define MAGIC_SYSCALL_1 (__NR_syscalls + 1)  \n#else\n# define MAGIC_SYSCALL_1 (0xff00)   \n#endif\n\n#define SYSCALL_DISPATCH_ON(x) ((x) = SYSCALL_DISPATCH_FILTER_BLOCK)\n#define SYSCALL_DISPATCH_OFF(x) ((x) = SYSCALL_DISPATCH_FILTER_ALLOW)\n\n \n\nTEST_SIGNAL(dispatch_trigger_sigsys, SIGSYS)\n{\n\tchar sel = SYSCALL_DISPATCH_FILTER_ALLOW;\n\tstruct sysinfo info;\n\tint ret;\n\n\tret = sysinfo(&info);\n\tASSERT_EQ(0, ret);\n\n\tret = prctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, 0, 0, &sel);\n\tASSERT_EQ(0, ret) {\n\t\tTH_LOG(\"Kernel does not support CONFIG_SYSCALL_USER_DISPATCH\");\n\t}\n\n\tSYSCALL_DISPATCH_ON(sel);\n\n\tsysinfo(&info);\n\n\tEXPECT_FALSE(true) {\n\t\tTH_LOG(\"Unreachable!\");\n\t}\n}\n\nTEST(bad_prctl_param)\n{\n\tchar sel = SYSCALL_DISPATCH_FILTER_ALLOW;\n\tint op;\n\n\t \n\top = -1;\n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0, 0, &sel);\n\tASSERT_EQ(EINVAL, errno);\n\n\t \n\top = PR_SYS_DISPATCH_OFF;\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0x1, 0x0, 0);\n\tEXPECT_EQ(EINVAL, errno);\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0x0, 0xff, 0);\n\tEXPECT_EQ(EINVAL, errno);\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0x0, 0x0, &sel);\n\tEXPECT_EQ(EINVAL, errno);\n\n\t \n\terrno = 0;\n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0x0, 0x0, 0x0);\n\tEXPECT_EQ(0, errno);\n\n\t \n\top = PR_SYS_DISPATCH_ON;\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0x1, 0x0, &sel);\n\tEXPECT_EQ(EINVAL, errno);\n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, -1L, 0x0, &sel);\n\tEXPECT_EQ(EINVAL, errno);\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, op, 0x0, 0x1, (void *) -1);\n\tASSERT_EQ(EFAULT, errno);\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, 1, -1L, &sel);\n\tASSERT_EQ(EINVAL, errno) {\n\t\tTH_LOG(\"Should reject bad syscall range\");\n\t}\n\n\t \n\tprctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, -1L, 0x1, &sel);\n\tASSERT_EQ(EINVAL, errno) {\n\t\tTH_LOG(\"Should reject bad syscall range\");\n\t}\n}\n\n \nchar glob_sel;\nint nr_syscalls_emulated;\nint si_code;\nint si_errno;\n\nstatic void handle_sigsys(int sig, siginfo_t *info, void *ucontext)\n{\n\tsi_code = info->si_code;\n\tsi_errno = info->si_errno;\n\n\tif (info->si_syscall == MAGIC_SYSCALL_1)\n\t\tnr_syscalls_emulated++;\n\n\t \n\tSYSCALL_DISPATCH_OFF(glob_sel);\n}\n\nTEST(dispatch_and_return)\n{\n\tlong ret;\n\tstruct sigaction act;\n\tsigset_t mask;\n\n\tglob_sel = 0;\n\tnr_syscalls_emulated = 0;\n\tsi_code = 0;\n\tsi_errno = 0;\n\n\tmemset(&act, 0, sizeof(act));\n\tsigemptyset(&mask);\n\n\tact.sa_sigaction = handle_sigsys;\n\tact.sa_flags = SA_SIGINFO;\n\tact.sa_mask = mask;\n\n\tret = sigaction(SIGSYS, &act, NULL);\n\tASSERT_EQ(0, ret);\n\n\t \n\tSYSCALL_DISPATCH_OFF(glob_sel);\n\n\tret = prctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, 0, 0, &glob_sel);\n\tASSERT_EQ(0, ret) {\n\t\tTH_LOG(\"Kernel does not support CONFIG_SYSCALL_USER_DISPATCH\");\n\t}\n\n\t \n\tSYSCALL_DISPATCH_OFF(glob_sel);\n\tret = syscall(MAGIC_SYSCALL_1);\n\tEXPECT_EQ(-1, ret) {\n\t\tTH_LOG(\"Dispatch triggered unexpectedly\");\n\t}\n\n\t \n\tnr_syscalls_emulated = 0;\n\tSYSCALL_DISPATCH_ON(glob_sel);\n\n\tret = syscall(MAGIC_SYSCALL_1);\n\tEXPECT_EQ(MAGIC_SYSCALL_1, ret) {\n\t\tTH_LOG(\"Failed to intercept syscall\");\n\t}\n\tEXPECT_EQ(1, nr_syscalls_emulated) {\n\t\tTH_LOG(\"Failed to emulate syscall\");\n\t}\n\tASSERT_EQ(SYS_USER_DISPATCH, si_code) {\n\t\tTH_LOG(\"Bad si_code in SIGSYS\");\n\t}\n\tASSERT_EQ(0, si_errno) {\n\t\tTH_LOG(\"Bad si_errno in SIGSYS\");\n\t}\n}\n\nTEST_SIGNAL(bad_selector, SIGSYS)\n{\n\tlong ret;\n\tstruct sigaction act;\n\tsigset_t mask;\n\tstruct sysinfo info;\n\n\tglob_sel = SYSCALL_DISPATCH_FILTER_ALLOW;\n\tnr_syscalls_emulated = 0;\n\tsi_code = 0;\n\tsi_errno = 0;\n\n\tmemset(&act, 0, sizeof(act));\n\tsigemptyset(&mask);\n\n\tact.sa_sigaction = handle_sigsys;\n\tact.sa_flags = SA_SIGINFO;\n\tact.sa_mask = mask;\n\n\tret = sigaction(SIGSYS, &act, NULL);\n\tASSERT_EQ(0, ret);\n\n\t \n\tSYSCALL_DISPATCH_OFF(glob_sel);\n\n\tret = prctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, 0, 0, &glob_sel);\n\tASSERT_EQ(0, ret) {\n\t\tTH_LOG(\"Kernel does not support CONFIG_SYSCALL_USER_DISPATCH\");\n\t}\n\n\tglob_sel = -1;\n\n\tsysinfo(&info);\n\n\t \n\n\tEXPECT_FALSE(true) {\n\t\tTH_LOG(\"Unreachable!\");\n\t}\n}\n\nTEST(disable_dispatch)\n{\n\tint ret;\n\tstruct sysinfo info;\n\tchar sel = 0;\n\n\tret = prctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, 0, 0, &sel);\n\tASSERT_EQ(0, ret) {\n\t\tTH_LOG(\"Kernel does not support CONFIG_SYSCALL_USER_DISPATCH\");\n\t}\n\n\t \n\tSYSCALL_DISPATCH_OFF(glob_sel);\n\n\tret = prctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_OFF, 0, 0, 0);\n\tEXPECT_EQ(0, ret) {\n\t\tTH_LOG(\"Failed to unset syscall user dispatch\");\n\t}\n\n\t \n\tSYSCALL_DISPATCH_ON(glob_sel);\n\n\tret = syscall(__NR_sysinfo, &info);\n\tEXPECT_EQ(0, ret) {\n\t\tTH_LOG(\"Dispatch triggered unexpectedly\");\n\t}\n}\n\nTEST(direct_dispatch_range)\n{\n\tint ret = 0;\n\tstruct sysinfo info;\n\tchar sel = SYSCALL_DISPATCH_FILTER_ALLOW;\n\n\t \n\tret = prctl(PR_SET_SYSCALL_USER_DISPATCH, PR_SYS_DISPATCH_ON, 0, -1L, &sel);\n\tASSERT_EQ(0, ret) {\n\t\tTH_LOG(\"Kernel does not support CONFIG_SYSCALL_USER_DISPATCH\");\n\t}\n\n\tSYSCALL_DISPATCH_ON(sel);\n\n\tret = sysinfo(&info);\n\tASSERT_EQ(0, ret) {\n\t\tTH_LOG(\"Dispatch triggered unexpectedly\");\n\t}\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}