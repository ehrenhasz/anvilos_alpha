{
  "module_name": "aperf.c",
  "hash_id": "767a0ae2acb0fe93d0259f65bb04f4db1c2561e6e3f1594f0717f4fed6e78e74",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/intel_pstate/aperf.c",
  "human_readable_source": "\n#include <math.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <sys/timeb.h>\n#include <sched.h>\n#include <errno.h>\n#include <string.h>\n#include <time.h>\n#include \"../kselftest.h\"\n\n#define MSEC_PER_SEC\t1000L\n#define NSEC_PER_MSEC\t1000000L\n\nvoid usage(char *name) {\n\tprintf (\"Usage: %s cpunum\\n\", name);\n}\n\nint main(int argc, char **argv) {\n\tunsigned int i, cpu, fd;\n\tchar msr_file_name[64];\n\tlong long tsc, old_tsc, new_tsc;\n\tlong long aperf, old_aperf, new_aperf;\n\tlong long mperf, old_mperf, new_mperf;\n\tstruct timespec before, after;\n\tlong long int start, finish, total;\n\tcpu_set_t cpuset;\n\n\tif (argc != 2) {\n\t\tusage(argv[0]);\n\t\treturn 1;\n\t}\n\n\terrno = 0;\n\tcpu = strtol(argv[1], (char **) NULL, 10);\n\n\tif (errno) {\n\t\tusage(argv[0]);\n\t\treturn 1;\n\t}\n\n\tsprintf(msr_file_name, \"/dev/cpu/%d/msr\", cpu);\n\tfd = open(msr_file_name, O_RDONLY);\n\n\tif (fd == -1) {\n\t\tprintf(\"/dev/cpu/%d/msr: %s\\n\", cpu, strerror(errno));\n\t\treturn KSFT_SKIP;\n\t}\n\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(cpu, &cpuset);\n\n\tif (sched_setaffinity(0, sizeof(cpu_set_t), &cpuset)) {\n\t\tperror(\"Failed to set cpu affinity\");\n\t\treturn 1;\n\t}\n\n\tif (clock_gettime(CLOCK_MONOTONIC, &before) < 0) {\n\t\tperror(\"clock_gettime\");\n\t\treturn 1;\n\t}\n\tpread(fd, &old_tsc,  sizeof(old_tsc), 0x10);\n\tpread(fd, &old_aperf,  sizeof(old_mperf), 0xe7);\n\tpread(fd, &old_mperf,  sizeof(old_aperf), 0xe8);\n\n\tfor (i=0; i<0x8fffffff; i++) {\n\t\tsqrt(i);\n\t}\n\n\tif (clock_gettime(CLOCK_MONOTONIC, &after) < 0) {\n\t\tperror(\"clock_gettime\");\n\t\treturn 1;\n\t}\n\tpread(fd, &new_tsc,  sizeof(new_tsc), 0x10);\n\tpread(fd, &new_aperf,  sizeof(new_mperf), 0xe7);\n\tpread(fd, &new_mperf,  sizeof(new_aperf), 0xe8);\n\n\ttsc = new_tsc-old_tsc;\n\taperf = new_aperf-old_aperf;\n\tmperf = new_mperf-old_mperf;\n\n\tstart = before.tv_sec*MSEC_PER_SEC + before.tv_nsec/NSEC_PER_MSEC;\n\tfinish = after.tv_sec*MSEC_PER_SEC + after.tv_nsec/NSEC_PER_MSEC;\n\ttotal = finish - start;\n\n\tprintf(\"runTime: %4.2f\\n\", 1.0*total/MSEC_PER_SEC);\n\tprintf(\"freq: %7.0f\\n\", tsc / (1.0*aperf / (1.0 * mperf)) / total);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}