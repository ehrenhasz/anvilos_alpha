{
  "module_name": "step_after_suspend_test.c",
  "hash_id": "7af738ab887a528b9dce6cef1a441e41e9a0d5e5e7ba19c2a372fc24335b4a1d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/breakpoints/step_after_suspend_test.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n\n#include <errno.h>\n#include <fcntl.h>\n#include <sched.h>\n#include <signal.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <string.h>\n#include <unistd.h>\n#include <sys/ptrace.h>\n#include <sys/stat.h>\n#include <sys/timerfd.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n\n#include \"../kselftest.h\"\n\nvoid child(int cpu)\n{\n\tcpu_set_t set;\n\n\tCPU_ZERO(&set);\n\tCPU_SET(cpu, &set);\n\tif (sched_setaffinity(0, sizeof(set), &set) != 0) {\n\t\tksft_print_msg(\"sched_setaffinity() failed: %s\\n\",\n\t\t\tstrerror(errno));\n\t\t_exit(1);\n\t}\n\n\tif (ptrace(PTRACE_TRACEME, 0, NULL, NULL) != 0) {\n\t\tksft_print_msg(\"ptrace(PTRACE_TRACEME) failed: %s\\n\",\n\t\t\tstrerror(errno));\n\t\t_exit(1);\n\t}\n\n\tif (raise(SIGSTOP) != 0) {\n\t\tksft_print_msg(\"raise(SIGSTOP) failed: %s\\n\", strerror(errno));\n\t\t_exit(1);\n\t}\n\n\t_exit(0);\n}\n\nint run_test(int cpu)\n{\n\tint status;\n\tpid_t pid = fork();\n\tpid_t wpid;\n\n\tif (pid < 0) {\n\t\tksft_print_msg(\"fork() failed: %s\\n\", strerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (pid == 0)\n\t\tchild(cpu);\n\n\twpid = waitpid(pid, &status, __WALL);\n\tif (wpid != pid) {\n\t\tksft_print_msg(\"waitpid() failed: %s\\n\", strerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (!WIFSTOPPED(status)) {\n\t\tksft_print_msg(\"child did not stop: %s\\n\", strerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (WSTOPSIG(status) != SIGSTOP) {\n\t\tksft_print_msg(\"child did not stop with SIGSTOP: %s\\n\",\n\t\t\tstrerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\n\tif (ptrace(PTRACE_SINGLESTEP, pid, NULL, NULL) < 0) {\n\t\tif (errno == EIO) {\n\t\t\tksft_print_msg(\n\t\t\t\t\"ptrace(PTRACE_SINGLESTEP) not supported on this architecture: %s\\n\",\n\t\t\t\tstrerror(errno));\n\t\t\treturn KSFT_SKIP;\n\t\t}\n\t\tksft_print_msg(\"ptrace(PTRACE_SINGLESTEP) failed: %s\\n\",\n\t\t\tstrerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\n\twpid = waitpid(pid, &status, __WALL);\n\tif (wpid != pid) {\n\t\tksft_print_msg(\"waitpid() failed: $s\\n\", strerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (WIFEXITED(status)) {\n\t\tksft_print_msg(\"child did not single-step: %s\\n\",\n\t\t\tstrerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (!WIFSTOPPED(status)) {\n\t\tksft_print_msg(\"child did not stop: %s\\n\", strerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (WSTOPSIG(status) != SIGTRAP) {\n\t\tksft_print_msg(\"child did not stop with SIGTRAP: %s\\n\",\n\t\t\tstrerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\n\tif (ptrace(PTRACE_CONT, pid, NULL, NULL) < 0) {\n\t\tksft_print_msg(\"ptrace(PTRACE_CONT) failed: %s\\n\",\n\t\t\tstrerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\n\twpid = waitpid(pid, &status, __WALL);\n\tif (wpid != pid) {\n\t\tksft_print_msg(\"waitpid() failed: %s\\n\", strerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\tif (!WIFEXITED(status)) {\n\t\tksft_print_msg(\"child did not exit after PTRACE_CONT: %s\\n\",\n\t\t\tstrerror(errno));\n\t\treturn KSFT_FAIL;\n\t}\n\n\treturn KSFT_PASS;\n}\n\nvoid suspend(void)\n{\n\tint power_state_fd;\n\tstruct sigevent event = {};\n\tint timerfd;\n\tint err;\n\tstruct itimerspec spec = {};\n\n\tif (getuid() != 0)\n\t\tksft_exit_skip(\"Please run the test as root - Exiting.\\n\");\n\n\tpower_state_fd = open(\"/sys/power/state\", O_RDWR);\n\tif (power_state_fd < 0)\n\t\tksft_exit_fail_msg(\n\t\t\t\"open(\\\"/sys/power/state\\\") failed %s)\\n\",\n\t\t\tstrerror(errno));\n\n\ttimerfd = timerfd_create(CLOCK_BOOTTIME_ALARM, 0);\n\tif (timerfd < 0)\n\t\tksft_exit_fail_msg(\"timerfd_create() failed\\n\");\n\n\tspec.it_value.tv_sec = 5;\n\terr = timerfd_settime(timerfd, 0, &spec, NULL);\n\tif (err < 0)\n\t\tksft_exit_fail_msg(\"timerfd_settime() failed\\n\");\n\n\tif (write(power_state_fd, \"mem\", strlen(\"mem\")) != strlen(\"mem\"))\n\t\tksft_exit_fail_msg(\"Failed to enter Suspend state\\n\");\n\n\tclose(timerfd);\n\tclose(power_state_fd);\n}\n\nint main(int argc, char **argv)\n{\n\tint opt;\n\tbool do_suspend = true;\n\tbool succeeded = true;\n\tunsigned int tests = 0;\n\tcpu_set_t available_cpus;\n\tint err;\n\tint cpu;\n\n\tksft_print_header();\n\n\twhile ((opt = getopt(argc, argv, \"n\")) != -1) {\n\t\tswitch (opt) {\n\t\tcase 'n':\n\t\t\tdo_suspend = false;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tprintf(\"Usage: %s [-n]\\n\", argv[0]);\n\t\t\tprintf(\"        -n: do not trigger a suspend/resume cycle before the test\\n\");\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\terr = sched_getaffinity(0, sizeof(available_cpus), &available_cpus);\n\tif (err < 0)\n\t\tksft_exit_fail_msg(\"sched_getaffinity() failed\\n\");\n\n\tfor (cpu = 0; cpu < CPU_SETSIZE; cpu++) {\n\t\tif (!CPU_ISSET(cpu, &available_cpus))\n\t\t\tcontinue;\n\t\ttests++;\n\t}\n\n\tif (do_suspend)\n\t\tsuspend();\n\n\tksft_set_plan(tests);\n\tfor (cpu = 0; cpu < CPU_SETSIZE; cpu++) {\n\t\tint test_success;\n\n\t\tif (!CPU_ISSET(cpu, &available_cpus))\n\t\t\tcontinue;\n\n\t\ttest_success = run_test(cpu);\n\t\tswitch (test_success) {\n\t\tcase KSFT_PASS:\n\t\t\tksft_test_result_pass(\"CPU %d\\n\", cpu);\n\t\t\tbreak;\n\t\tcase KSFT_SKIP:\n\t\t\tksft_test_result_skip(\"CPU %d\\n\", cpu);\n\t\t\tbreak;\n\t\tcase KSFT_FAIL:\n\t\t\tksft_test_result_fail(\"CPU %d\\n\", cpu);\n\t\t\tsucceeded = false;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (succeeded)\n\t\tksft_exit_pass();\n\telse\n\t\tksft_exit_fail();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}