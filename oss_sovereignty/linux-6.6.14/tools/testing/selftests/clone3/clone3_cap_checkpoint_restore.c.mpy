{
  "module_name": "clone3_cap_checkpoint_restore.c",
  "hash_id": "3edeb68c282c6838ccb5670180ac5d564b1fa48aae88cc62670eb6e22b0cb6e9",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/clone3/clone3_cap_checkpoint_restore.c",
  "human_readable_source": "\n\n \n\n \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <linux/types.h>\n#include <linux/sched.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdbool.h>\n#include <sys/capability.h>\n#include <sys/prctl.h>\n#include <sys/syscall.h>\n#include <sys/types.h>\n#include <sys/un.h>\n#include <sys/wait.h>\n#include <unistd.h>\n#include <sched.h>\n\n#include \"../kselftest_harness.h\"\n#include \"clone3_selftests.h\"\n\n#ifndef MAX_PID_NS_LEVEL\n#define MAX_PID_NS_LEVEL 32\n#endif\n\nstatic void child_exit(int ret)\n{\n\tfflush(stdout);\n\tfflush(stderr);\n\t_exit(ret);\n}\n\nstatic int call_clone3_set_tid(struct __test_metadata *_metadata,\n\t\t\t       pid_t *set_tid, size_t set_tid_size)\n{\n\tint status;\n\tpid_t pid = -1;\n\n\tstruct __clone_args args = {\n\t\t.exit_signal = SIGCHLD,\n\t\t.set_tid = ptr_to_u64(set_tid),\n\t\t.set_tid_size = set_tid_size,\n\t};\n\n\tpid = sys_clone3(&args, sizeof(args));\n\tif (pid < 0) {\n\t\tTH_LOG(\"%s - Failed to create new process\", strerror(errno));\n\t\treturn -errno;\n\t}\n\n\tif (pid == 0) {\n\t\tint ret;\n\t\tchar tmp = 0;\n\n\t\tTH_LOG(\"I am the child, my PID is %d (expected %d)\", getpid(), set_tid[0]);\n\n\t\tif (set_tid[0] != getpid())\n\t\t\tchild_exit(EXIT_FAILURE);\n\t\tchild_exit(EXIT_SUCCESS);\n\t}\n\n\tTH_LOG(\"I am the parent (%d). My child's pid is %d\", getpid(), pid);\n\n\tif (waitpid(pid, &status, 0) < 0) {\n\t\tTH_LOG(\"Child returned %s\", strerror(errno));\n\t\treturn -errno;\n\t}\n\n\tif (!WIFEXITED(status))\n\t\treturn -1;\n\n\treturn WEXITSTATUS(status);\n}\n\nstatic int test_clone3_set_tid(struct __test_metadata *_metadata,\n\t\t\t       pid_t *set_tid, size_t set_tid_size)\n{\n\tint ret;\n\n\tTH_LOG(\"[%d] Trying clone3() with CLONE_SET_TID to %d\", getpid(), set_tid[0]);\n\tret = call_clone3_set_tid(_metadata, set_tid, set_tid_size);\n\tTH_LOG(\"[%d] clone3() with CLONE_SET_TID %d says:%d\", getpid(), set_tid[0], ret);\n\treturn ret;\n}\n\nstruct libcap {\n\tstruct __user_cap_header_struct hdr;\n\tstruct __user_cap_data_struct data[2];\n};\n\nstatic int set_capability(void)\n{\n\tcap_value_t cap_values[] = { CAP_SETUID, CAP_SETGID };\n\tstruct libcap *cap;\n\tint ret = -1;\n\tcap_t caps;\n\n\tcaps = cap_get_proc();\n\tif (!caps) {\n\t\tperror(\"cap_get_proc\");\n\t\treturn -1;\n\t}\n\n\t \n\tif (cap_clear(caps)) {\n\t\tperror(\"cap_clear\");\n\t\tgoto out;\n\t}\n\n\tcap_set_flag(caps, CAP_EFFECTIVE, 2, cap_values, CAP_SET);\n\tcap_set_flag(caps, CAP_PERMITTED, 2, cap_values, CAP_SET);\n\n\tcap = (struct libcap *) caps;\n\n\t \n\tcap->data[1].effective |= 1 << (40 - 32);\n\tcap->data[1].permitted |= 1 << (40 - 32);\n\n\tif (cap_set_proc(caps)) {\n\t\tperror(\"cap_set_proc\");\n\t\tgoto out;\n\t}\n\tret = 0;\nout:\n\tif (cap_free(caps))\n\t\tperror(\"cap_free\");\n\treturn ret;\n}\n\nTEST(clone3_cap_checkpoint_restore)\n{\n\tpid_t pid;\n\tint status;\n\tint ret = 0;\n\tpid_t set_tid[1];\n\n\ttest_clone3_supported();\n\n\tEXPECT_EQ(getuid(), 0)\n\t\tSKIP(return, \"Skipping all tests as non-root\");\n\n\tmemset(&set_tid, 0, sizeof(set_tid));\n\n\t \n\tpid = fork();\n\tif (pid == 0) {\n\t\tTH_LOG(\"Child has PID %d\", getpid());\n\t\tchild_exit(EXIT_SUCCESS);\n\t}\n\tASSERT_GT(waitpid(pid, &status, 0), 0)\n\t\tTH_LOG(\"Waiting for child %d failed\", pid);\n\n\t \n\tset_tid[0] = pid;\n\n\tASSERT_EQ(set_capability(), 0)\n\t\tTH_LOG(\"Could not set CAP_CHECKPOINT_RESTORE\");\n\n\tASSERT_EQ(prctl(PR_SET_KEEPCAPS, 1, 0, 0, 0), 0);\n\n\tEXPECT_EQ(setgid(65534), 0)\n\t\tTH_LOG(\"Failed to setgid(65534)\");\n\tASSERT_EQ(setuid(65534), 0);\n\n\tset_tid[0] = pid;\n\t \n\tASSERT_EQ(test_clone3_set_tid(_metadata, set_tid, 1), -EPERM);\n\tASSERT_EQ(set_capability(), 0)\n\t\tTH_LOG(\"Could not set CAP_CHECKPOINT_RESTORE\");\n\t \n\tASSERT_EQ(test_clone3_set_tid(_metadata, set_tid, 1), 0);\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}