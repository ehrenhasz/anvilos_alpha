{
  "module_name": "clone3_clear_sighand.c",
  "hash_id": "81a6ee1ae8249621f3a3d0d3ce5fdf3d9455b74dd0214e1ab18cb47cb00f6504",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/clone3/clone3_clear_sighand.c",
  "human_readable_source": " \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <sched.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <linux/sched.h>\n#include <linux/types.h>\n#include <sys/syscall.h>\n#include <sys/wait.h>\n\n#include \"../kselftest.h\"\n#include \"clone3_selftests.h\"\n\n#ifndef CLONE_CLEAR_SIGHAND\n#define CLONE_CLEAR_SIGHAND 0x100000000ULL\n#endif\n\nstatic void nop_handler(int signo)\n{\n}\n\nstatic int wait_for_pid(pid_t pid)\n{\n\tint status, ret;\n\nagain:\n\tret = waitpid(pid, &status, 0);\n\tif (ret == -1) {\n\t\tif (errno == EINTR)\n\t\t\tgoto again;\n\n\t\treturn -1;\n\t}\n\n\tif (!WIFEXITED(status))\n\t\treturn -1;\n\n\treturn WEXITSTATUS(status);\n}\n\nstatic void test_clone3_clear_sighand(void)\n{\n\tint ret;\n\tpid_t pid;\n\tstruct __clone_args args = {};\n\tstruct sigaction act;\n\n\t \n\targs.flags |= CLONE_CLEAR_SIGHAND | CLONE_SIGHAND;\n\targs.exit_signal = SIGCHLD;\n\tpid = sys_clone3(&args, sizeof(args));\n\tif (pid > 0)\n\t\tksft_exit_fail_msg(\n\t\t\t\"clone3(CLONE_CLEAR_SIGHAND | CLONE_SIGHAND) succeeded\\n\");\n\n\tact.sa_handler = nop_handler;\n\tret = sigemptyset(&act.sa_mask);\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\"%s - sigemptyset() failed\\n\",\n\t\t\t\t   strerror(errno));\n\n\tact.sa_flags = 0;\n\n\t \n\tret = sigaction(SIGUSR1, &act, NULL);\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s - sigaction(SIGUSR1, &act, NULL) failed\\n\",\n\t\t\tstrerror(errno));\n\n\t \n\tret = sigaction(SIGUSR2, &act, NULL);\n\tif (ret < 0)\n\t\tksft_exit_fail_msg(\n\t\t\t\"%s - sigaction(SIGUSR2, &act, NULL) failed\\n\",\n\t\t\tstrerror(errno));\n\n\t \n\targs.flags = CLONE_CLEAR_SIGHAND;\n\tpid = sys_clone3(&args, sizeof(args));\n\tif (pid < 0)\n\t\tksft_exit_fail_msg(\"%s - clone3(CLONE_CLEAR_SIGHAND) failed\\n\",\n\t\t\t\t   strerror(errno));\n\n\tif (pid == 0) {\n\t\tret = sigaction(SIGUSR1, NULL, &act);\n\t\tif (ret < 0)\n\t\t\texit(EXIT_FAILURE);\n\n\t\tif (act.sa_handler != SIG_DFL)\n\t\t\texit(EXIT_FAILURE);\n\n\t\tret = sigaction(SIGUSR2, NULL, &act);\n\t\tif (ret < 0)\n\t\t\texit(EXIT_FAILURE);\n\n\t\tif (act.sa_handler != SIG_DFL)\n\t\t\texit(EXIT_FAILURE);\n\n\t\texit(EXIT_SUCCESS);\n\t}\n\n\tret = wait_for_pid(pid);\n\tif (ret)\n\t\tksft_exit_fail_msg(\n\t\t\t\"Failed to clear signal handler for child process\\n\");\n\n\tksft_test_result_pass(\"Cleared signal handlers for child process\\n\");\n}\n\nint main(int argc, char **argv)\n{\n\tksft_print_header();\n\tksft_set_plan(1);\n\ttest_clone3_supported();\n\n\ttest_clone3_clear_sighand();\n\n\treturn ksft_exit_pass();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}