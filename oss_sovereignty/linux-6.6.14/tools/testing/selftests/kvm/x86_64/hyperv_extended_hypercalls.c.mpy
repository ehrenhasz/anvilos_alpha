{
  "module_name": "hyperv_extended_hypercalls.c",
  "hash_id": "29319deac101c72a9aef37a458acb60f46063b2759b2944f551d9197d0624a50",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/x86_64/hyperv_extended_hypercalls.c",
  "human_readable_source": "\n \n#include \"kvm_util.h\"\n#include \"processor.h\"\n#include \"hyperv.h\"\n\n \n#define EXT_CAPABILITIES 0xbull\n\nstatic void guest_code(vm_paddr_t in_pg_gpa, vm_paddr_t out_pg_gpa,\n\t\t       vm_vaddr_t out_pg_gva)\n{\n\tuint64_t *output_gva;\n\n\twrmsr(HV_X64_MSR_GUEST_OS_ID, HYPERV_LINUX_OS_ID);\n\twrmsr(HV_X64_MSR_HYPERCALL, in_pg_gpa);\n\n\toutput_gva = (uint64_t *)out_pg_gva;\n\n\thyperv_hypercall(HV_EXT_CALL_QUERY_CAPABILITIES, in_pg_gpa, out_pg_gpa);\n\n\t \n\tGUEST_ASSERT_EQ(*output_gva, EXT_CAPABILITIES);\n\n\tGUEST_DONE();\n}\n\nint main(void)\n{\n\tvm_vaddr_t hcall_out_page;\n\tvm_vaddr_t hcall_in_page;\n\tstruct kvm_vcpu *vcpu;\n\tstruct kvm_run *run;\n\tstruct kvm_vm *vm;\n\tuint64_t *outval;\n\tstruct ucall uc;\n\n\t \n\tif (!kvm_cpuid_has(kvm_get_supported_hv_cpuid(),\n\t\t\t   HV_ENABLE_EXTENDED_HYPERCALLS)) {\n\t\tprint_skip(\"Extended calls not supported by the kernel\");\n\t\texit(KSFT_SKIP);\n\t}\n\n\tvm = vm_create_with_one_vcpu(&vcpu, guest_code);\n\trun = vcpu->run;\n\tvcpu_set_hv_cpuid(vcpu);\n\n\t \n\thcall_in_page = vm_vaddr_alloc_pages(vm, 1);\n\tmemset(addr_gva2hva(vm, hcall_in_page), 0x0, vm->page_size);\n\n\t \n\thcall_out_page = vm_vaddr_alloc_pages(vm, 1);\n\tmemset(addr_gva2hva(vm, hcall_out_page), 0x0, vm->page_size);\n\n\tvcpu_args_set(vcpu, 3, addr_gva2gpa(vm, hcall_in_page),\n\t\t      addr_gva2gpa(vm, hcall_out_page), hcall_out_page);\n\n\tvcpu_run(vcpu);\n\n\tTEST_ASSERT(run->exit_reason == KVM_EXIT_HYPERV,\n\t\t    \"Unexpected exit reason: %u (%s)\",\n\t\t    run->exit_reason, exit_reason_str(run->exit_reason));\n\n\toutval = addr_gpa2hva(vm, run->hyperv.u.hcall.params[1]);\n\t*outval = EXT_CAPABILITIES;\n\trun->hyperv.u.hcall.result = HV_STATUS_SUCCESS;\n\n\tvcpu_run(vcpu);\n\n\tTEST_ASSERT(run->exit_reason == KVM_EXIT_IO,\n\t\t    \"Unexpected exit reason: %u (%s)\",\n\t\t    run->exit_reason, exit_reason_str(run->exit_reason));\n\n\tswitch (get_ucall(vcpu, &uc)) {\n\tcase UCALL_ABORT:\n\t\tREPORT_GUEST_ASSERT(uc);\n\t\tbreak;\n\tcase UCALL_DONE:\n\t\tbreak;\n\tdefault:\n\t\tTEST_FAIL(\"Unhandled ucall: %ld\", uc.cmd);\n\t}\n\n\tkvm_vm_free(vm);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}