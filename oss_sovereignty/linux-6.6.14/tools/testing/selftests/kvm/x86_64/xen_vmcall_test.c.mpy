{
  "module_name": "xen_vmcall_test.c",
  "hash_id": "9e1f6136721a957f8cf3b49f1fe8b943e069ae79911f44d9479d793e12324106",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c",
  "human_readable_source": "\n \n\n#include \"test_util.h\"\n#include \"kvm_util.h\"\n#include \"processor.h\"\n\n#define HCALL_REGION_GPA\t0xc0000000ULL\n#define HCALL_REGION_SLOT\t10\n\n#define INPUTVALUE 17\n#define ARGVALUE(x) (0xdeadbeef5a5a0000UL + x)\n#define RETVALUE 0xcafef00dfbfbffffUL\n\n#define XEN_HYPERCALL_MSR\t0x40000200\n#define HV_GUEST_OS_ID_MSR\t0x40000000\n#define HV_HYPERCALL_MSR\t0x40000001\n\n#define HVCALL_SIGNAL_EVENT\t\t0x005d\n#define HV_STATUS_INVALID_ALIGNMENT\t4\n\nstatic void guest_code(void)\n{\n\tunsigned long rax = INPUTVALUE;\n\tunsigned long rdi = ARGVALUE(1);\n\tunsigned long rsi = ARGVALUE(2);\n\tunsigned long rdx = ARGVALUE(3);\n\tunsigned long rcx;\n\tregister unsigned long r10 __asm__(\"r10\") = ARGVALUE(4);\n\tregister unsigned long r8 __asm__(\"r8\") = ARGVALUE(5);\n\tregister unsigned long r9 __asm__(\"r9\") = ARGVALUE(6);\n\n\t \n\t__asm__ __volatile__(\"vmcall\" :\n\t\t\t     \"=a\"(rax) :\n\t\t\t     \"a\"(rax), \"D\"(rdi), \"S\"(rsi), \"d\"(rdx),\n\t\t\t     \"r\"(r10), \"r\"(r8), \"r\"(r9));\n\tGUEST_ASSERT(rax == RETVALUE);\n\n\t \n\t__asm__ __volatile__(\"wrmsr\" : : \"c\" (XEN_HYPERCALL_MSR),\n\t\t\t     \"a\" (HCALL_REGION_GPA & 0xffffffff),\n\t\t\t     \"d\" (HCALL_REGION_GPA >> 32));\n\n\t \n\t__asm__ __volatile__(\"wrmsr\" : : \"c\" (HV_GUEST_OS_ID_MSR),\n\t\t\t     \"a\" (0x5a), \"d\" (0));\n\n\t \n\tu64 msrval = HCALL_REGION_GPA + PAGE_SIZE + 1;\n\t__asm__ __volatile__(\"wrmsr\" : : \"c\" (HV_HYPERCALL_MSR),\n\t\t\t     \"a\" (msrval & 0xffffffff),\n\t\t\t     \"d\" (msrval >> 32));\n\n\t \n\t__asm__ __volatile__(\"call *%1\" : \"=a\"(rax) :\n\t\t\t     \"r\"(HCALL_REGION_GPA + INPUTVALUE * 32),\n\t\t\t     \"a\"(rax), \"D\"(rdi), \"S\"(rsi), \"d\"(rdx),\n\t\t\t     \"r\"(r10), \"r\"(r8), \"r\"(r9));\n\tGUEST_ASSERT(rax == RETVALUE);\n\n\t \n\trax = 0;\n\trcx = HVCALL_SIGNAL_EVENT;\t \n\trdx = 0x5a5a5a5a;\t\t \n\t__asm__ __volatile__(\"call *%1\" : \"=a\"(rax) :\n\t\t\t     \"r\"(HCALL_REGION_GPA + PAGE_SIZE),\n\t\t\t     \"a\"(rax), \"c\"(rcx), \"d\"(rdx),\n\t\t\t     \"r\"(r8));\n\tGUEST_ASSERT(rax == HV_STATUS_INVALID_ALIGNMENT);\n\n\tGUEST_DONE();\n}\n\nint main(int argc, char *argv[])\n{\n\tunsigned int xen_caps;\n\tstruct kvm_vcpu *vcpu;\n\tstruct kvm_vm *vm;\n\n\txen_caps = kvm_check_cap(KVM_CAP_XEN_HVM);\n\tTEST_REQUIRE(xen_caps & KVM_XEN_HVM_CONFIG_INTERCEPT_HCALL);\n\n\tvm = vm_create_with_one_vcpu(&vcpu, guest_code);\n\tvcpu_set_hv_cpuid(vcpu);\n\n\tstruct kvm_xen_hvm_config hvmc = {\n\t\t.flags = KVM_XEN_HVM_CONFIG_INTERCEPT_HCALL,\n\t\t.msr = XEN_HYPERCALL_MSR,\n\t};\n\tvm_ioctl(vm, KVM_XEN_HVM_CONFIG, &hvmc);\n\n\t \n\tvm_userspace_mem_region_add(vm, VM_MEM_SRC_ANONYMOUS,\n\t\t\t\t    HCALL_REGION_GPA, HCALL_REGION_SLOT, 2, 0);\n\tvirt_map(vm, HCALL_REGION_GPA, HCALL_REGION_GPA, 2);\n\n\tfor (;;) {\n\t\tvolatile struct kvm_run *run = vcpu->run;\n\t\tstruct ucall uc;\n\n\t\tvcpu_run(vcpu);\n\n\t\tif (run->exit_reason == KVM_EXIT_XEN) {\n\t\t\tTEST_ASSERT_EQ(run->xen.type, KVM_EXIT_XEN_HCALL);\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.cpl, 0);\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.longmode, 1);\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.input, INPUTVALUE);\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.params[0], ARGVALUE(1));\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.params[1], ARGVALUE(2));\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.params[2], ARGVALUE(3));\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.params[3], ARGVALUE(4));\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.params[4], ARGVALUE(5));\n\t\t\tTEST_ASSERT_EQ(run->xen.u.hcall.params[5], ARGVALUE(6));\n\t\t\trun->xen.u.hcall.result = RETVALUE;\n\t\t\tcontinue;\n\t\t}\n\n\t\tTEST_ASSERT_KVM_EXIT_REASON(vcpu, KVM_EXIT_IO);\n\n\t\tswitch (get_ucall(vcpu, &uc)) {\n\t\tcase UCALL_ABORT:\n\t\t\tREPORT_GUEST_ASSERT(uc);\n\t\t\t \n\t\tcase UCALL_SYNC:\n\t\t\tbreak;\n\t\tcase UCALL_DONE:\n\t\t\tgoto done;\n\t\tdefault:\n\t\t\tTEST_FAIL(\"Unknown ucall 0x%lx.\", uc.cmd);\n\t\t}\n\t}\ndone:\n\tkvm_vm_free(vm);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}