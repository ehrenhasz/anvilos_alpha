{
  "module_name": "tsc_msrs_test.c",
  "hash_id": "d31fec67794e20a269bd6d9a08b545c4b34338aca50c161af712877fec9fd54c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/x86_64/tsc_msrs_test.c",
  "human_readable_source": "\n \n#include <stdio.h>\n#include <string.h>\n#include \"kvm_util.h\"\n#include \"processor.h\"\n\n#define UNITY                  (1ull << 30)\n#define HOST_ADJUST            (UNITY * 64)\n#define GUEST_STEP             (UNITY * 4)\n#define ROUND(x)               ((x + UNITY / 2) & -UNITY)\n#define rounded_rdmsr(x)       ROUND(rdmsr(x))\n#define rounded_host_rdmsr(x)  ROUND(vcpu_get_msr(vcpu, x))\n\nstatic void guest_code(void)\n{\n\tu64 val = 0;\n\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC), val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\tval = 1ull * GUEST_STEP;\n\twrmsr(MSR_IA32_TSC, val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC), val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\tGUEST_SYNC(2);\n\tval = 2ull * GUEST_STEP;\n\twrmsr(MSR_IA32_TSC_ADJUST, val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC), val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\tGUEST_SYNC(3);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC), HOST_ADJUST + val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\tGUEST_SYNC(4);\n\tval = 3ull * GUEST_STEP;\n\twrmsr(MSR_IA32_TSC_ADJUST, val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC), HOST_ADJUST + val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\tGUEST_SYNC(5);\n\tval = 4ull * GUEST_STEP;\n\twrmsr(MSR_IA32_TSC, val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC), val);\n\tGUEST_ASSERT_EQ(rounded_rdmsr(MSR_IA32_TSC_ADJUST), val - HOST_ADJUST);\n\n\tGUEST_DONE();\n}\n\nstatic void run_vcpu(struct kvm_vcpu *vcpu, int stage)\n{\n\tstruct ucall uc;\n\n\tvcpu_run(vcpu);\n\n\tswitch (get_ucall(vcpu, &uc)) {\n\tcase UCALL_SYNC:\n\t\tif (!strcmp((const char *)uc.args[0], \"hello\") &&\n\t\t    uc.args[1] == stage + 1)\n\t\t\tksft_test_result_pass(\"stage %d passed\\n\", stage + 1);\n\t\telse\n\t\t\tksft_test_result_fail(\n\t\t\t\t\"stage %d: Unexpected register values vmexit, got %lx\",\n\t\t\t\tstage + 1, (ulong)uc.args[1]);\n\t\treturn;\n\tcase UCALL_DONE:\n\t\tksft_test_result_pass(\"stage %d passed\\n\", stage + 1);\n\t\treturn;\n\tcase UCALL_ABORT:\n\t\tREPORT_GUEST_ASSERT(uc);\n\tdefault:\n\t\tTEST_ASSERT(false, \"Unexpected exit: %s\",\n\t\t\t    exit_reason_str(vcpu->run->exit_reason));\n\t}\n}\n\nint main(void)\n{\n\tstruct kvm_vcpu *vcpu;\n\tstruct kvm_vm *vm;\n\tuint64_t val;\n\n\tksft_print_header();\n\tksft_set_plan(5);\n\n\tvm = vm_create_with_one_vcpu(&vcpu, guest_code);\n\n\tval = 0;\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\trun_vcpu(vcpu, 1);\n\tval = 1ull * GUEST_STEP;\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\trun_vcpu(vcpu, 2);\n\tval = 2ull * GUEST_STEP;\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\tvcpu_set_msr(vcpu, MSR_IA32_TSC, HOST_ADJUST + val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), HOST_ADJUST + val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\trun_vcpu(vcpu, 3);\n\n\t \n\tvcpu_set_msr(vcpu, MSR_IA32_TSC_ADJUST, UNITY * 123456);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), HOST_ADJUST + val);\n\tTEST_ASSERT_EQ(vcpu_get_msr(vcpu, MSR_IA32_TSC_ADJUST), UNITY * 123456);\n\n\t \n\tvcpu_set_msr(vcpu, MSR_IA32_TSC_ADJUST, val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), HOST_ADJUST + val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\trun_vcpu(vcpu, 4);\n\tval = 3ull * GUEST_STEP;\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), HOST_ADJUST + val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val);\n\n\t \n\trun_vcpu(vcpu, 5);\n\tval = 4ull * GUEST_STEP;\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC), val);\n\tTEST_ASSERT_EQ(rounded_host_rdmsr(MSR_IA32_TSC_ADJUST), val - HOST_ADJUST);\n\n\tkvm_vm_free(vm);\n\n\tksft_finished();\t \n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}