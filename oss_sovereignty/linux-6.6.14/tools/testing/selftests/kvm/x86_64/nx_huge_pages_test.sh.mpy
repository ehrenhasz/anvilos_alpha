{
  "module_name": "nx_huge_pages_test.sh",
  "hash_id": "660570ce89bcd5b9f396da7652f14bfddfdecd6c9a4585b7d427120c657eb627",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/x86_64/nx_huge_pages_test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0-only */\n#\n# Wrapper script which performs setup and cleanup for nx_huge_pages_test.\n# Makes use of root privileges to set up huge pages and KVM module parameters.\n#\n# Copyright (C) 2022, Google LLC.\n\nset -e\n\nNX_HUGE_PAGES=$(cat /sys/module/kvm/parameters/nx_huge_pages)\nNX_HUGE_PAGES_RECOVERY_RATIO=$(cat /sys/module/kvm/parameters/nx_huge_pages_recovery_ratio)\nNX_HUGE_PAGES_RECOVERY_PERIOD=$(cat /sys/module/kvm/parameters/nx_huge_pages_recovery_period_ms)\nHUGE_PAGES=$(cat /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages)\n\nset +e\n\nfunction sudo_echo () {\n\techo \"$1\" | sudo tee -a \"$2\" > /dev/null\n}\n\nNXECUTABLE=\"$(dirname $0)/nx_huge_pages_test\"\n\nsudo_echo test /dev/null || exit 4 # KSFT_SKIP=4\n\n(\n\tset -e\n\n\tsudo_echo 1 /sys/module/kvm/parameters/nx_huge_pages\n\tsudo_echo 1 /sys/module/kvm/parameters/nx_huge_pages_recovery_ratio\n\tsudo_echo 100 /sys/module/kvm/parameters/nx_huge_pages_recovery_period_ms\n\tsudo_echo \"$(( $HUGE_PAGES + 3 ))\" /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages\n\n\t# Test with reboot permissions\n\tif [ $(whoami) == \"root\" ] || sudo setcap cap_sys_boot+ep $NXECUTABLE 2> /dev/null; then\n\t\techo Running test with CAP_SYS_BOOT enabled\n\t\t$NXECUTABLE -t 887563923 -p 100 -r\n\t\ttest $(whoami) == \"root\" || sudo setcap cap_sys_boot-ep $NXECUTABLE\n\telse\n\t\techo setcap failed, skipping nx_huge_pages_test with CAP_SYS_BOOT enabled\n\tfi\n\n\t# Test without reboot permissions\n\tif [ $(whoami) != \"root\" ] ; then\n\t\techo Running test with CAP_SYS_BOOT disabled\n\t\t$NXECUTABLE -t 887563923 -p 100\n\telse\n\t\techo Running as root, skipping nx_huge_pages_test with CAP_SYS_BOOT disabled\n\tfi\n)\nRET=$?\n\nsudo_echo \"$NX_HUGE_PAGES\" /sys/module/kvm/parameters/nx_huge_pages\nsudo_echo \"$NX_HUGE_PAGES_RECOVERY_RATIO\" /sys/module/kvm/parameters/nx_huge_pages_recovery_ratio\nsudo_echo \"$NX_HUGE_PAGES_RECOVERY_PERIOD\" /sys/module/kvm/parameters/nx_huge_pages_recovery_period_ms\nsudo_echo \"$HUGE_PAGES\" /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages\n\nexit $RET\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}