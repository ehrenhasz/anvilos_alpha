{
  "module_name": "smaller_maxphyaddr_emulation_test.c",
  "hash_id": "df199196bb2a3a82c89ee982af08f876da4322449e3039e70c7aa80de3e38d4b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/x86_64/smaller_maxphyaddr_emulation_test.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE  \n\n#include \"flds_emulation.h\"\n\n#include \"test_util.h\"\n#include \"kvm_util.h\"\n#include \"vmx.h\"\n\n#define MAXPHYADDR 36\n\n#define MEM_REGION_GVA\t0x0000123456789000\n#define MEM_REGION_GPA\t0x0000000700000000\n#define MEM_REGION_SLOT\t10\n#define MEM_REGION_SIZE PAGE_SIZE\n\nstatic void guest_code(bool tdp_enabled)\n{\n\tuint64_t error_code;\n\tuint64_t vector;\n\n\tvector = kvm_asm_safe_ec(FLDS_MEM_EAX, error_code, \"a\"(MEM_REGION_GVA));\n\n\t \n\tif (tdp_enabled) {\n\t\tGUEST_ASSERT(!vector);\n\t} else {\n\t\tGUEST_ASSERT_EQ(vector, PF_VECTOR);\n\t\tGUEST_ASSERT(error_code & PFERR_RSVD_MASK);\n\t}\n\n\tGUEST_DONE();\n}\n\nint main(int argc, char *argv[])\n{\n\tstruct kvm_vcpu *vcpu;\n\tstruct kvm_vm *vm;\n\tstruct ucall uc;\n\tuint64_t *pte;\n\tuint64_t *hva;\n\tuint64_t gpa;\n\tint rc;\n\n\tTEST_REQUIRE(kvm_has_cap(KVM_CAP_SMALLER_MAXPHYADDR));\n\n\tvm = vm_create_with_one_vcpu(&vcpu, guest_code);\n\tvcpu_args_set(vcpu, 1, kvm_is_tdp_enabled());\n\n\tvm_init_descriptor_tables(vm);\n\tvcpu_init_descriptor_tables(vcpu);\n\n\tvcpu_set_cpuid_maxphyaddr(vcpu, MAXPHYADDR);\n\n\trc = kvm_check_cap(KVM_CAP_EXIT_ON_EMULATION_FAILURE);\n\tTEST_ASSERT(rc, \"KVM_CAP_EXIT_ON_EMULATION_FAILURE is unavailable\");\n\tvm_enable_cap(vm, KVM_CAP_EXIT_ON_EMULATION_FAILURE, 1);\n\n\tvm_userspace_mem_region_add(vm, VM_MEM_SRC_ANONYMOUS,\n\t\t\t\t    MEM_REGION_GPA, MEM_REGION_SLOT,\n\t\t\t\t    MEM_REGION_SIZE / PAGE_SIZE, 0);\n\tgpa = vm_phy_pages_alloc(vm, MEM_REGION_SIZE / PAGE_SIZE,\n\t\t\t\t MEM_REGION_GPA, MEM_REGION_SLOT);\n\tTEST_ASSERT(gpa == MEM_REGION_GPA, \"Failed vm_phy_pages_alloc\\n\");\n\tvirt_map(vm, MEM_REGION_GVA, MEM_REGION_GPA, 1);\n\thva = addr_gpa2hva(vm, MEM_REGION_GPA);\n\tmemset(hva, 0, PAGE_SIZE);\n\n\tpte = vm_get_page_table_entry(vm, MEM_REGION_GVA);\n\t*pte |= BIT_ULL(MAXPHYADDR);\n\n\tvcpu_run(vcpu);\n\n\t \n\tif (kvm_is_tdp_enabled()) {\n\t\thandle_flds_emulation_failure_exit(vcpu);\n\t\tvcpu_run(vcpu);\n\t}\n\n\tswitch (get_ucall(vcpu, &uc)) {\n\tcase UCALL_ABORT:\n\t\tREPORT_GUEST_ASSERT(uc);\n\t\tbreak;\n\tcase UCALL_DONE:\n\t\tbreak;\n\tdefault:\n\t\tTEST_FAIL(\"Unrecognized ucall: %lu\\n\", uc.cmd);\n\t}\n\n\tkvm_vm_free(vm);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}