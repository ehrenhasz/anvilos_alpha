{
  "module_name": "platform_info_test.c",
  "hash_id": "b24a4a176b21d5d68e3b835e398a4ec95f542b1218f23ccc7bef67c350f76abd",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/x86_64/platform_info_test.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE  \n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/ioctl.h>\n\n#include \"test_util.h\"\n#include \"kvm_util.h\"\n#include \"processor.h\"\n\n#define MSR_PLATFORM_INFO_MAX_TURBO_RATIO 0xff00\n\nstatic void guest_code(void)\n{\n\tuint64_t msr_platform_info;\n\n\tfor (;;) {\n\t\tmsr_platform_info = rdmsr(MSR_PLATFORM_INFO);\n\t\tGUEST_SYNC(msr_platform_info);\n\t\tasm volatile (\"inc %r11\");\n\t}\n}\n\nstatic void test_msr_platform_info_enabled(struct kvm_vcpu *vcpu)\n{\n\tstruct ucall uc;\n\n\tvm_enable_cap(vcpu->vm, KVM_CAP_MSR_PLATFORM_INFO, true);\n\tvcpu_run(vcpu);\n\tTEST_ASSERT_KVM_EXIT_REASON(vcpu, KVM_EXIT_IO);\n\n\tget_ucall(vcpu, &uc);\n\tTEST_ASSERT(uc.cmd == UCALL_SYNC,\n\t\t\t\"Received ucall other than UCALL_SYNC: %lu\\n\", uc.cmd);\n\tTEST_ASSERT((uc.args[1] & MSR_PLATFORM_INFO_MAX_TURBO_RATIO) ==\n\t\tMSR_PLATFORM_INFO_MAX_TURBO_RATIO,\n\t\t\"Expected MSR_PLATFORM_INFO to have max turbo ratio mask: %i.\",\n\t\tMSR_PLATFORM_INFO_MAX_TURBO_RATIO);\n}\n\nstatic void test_msr_platform_info_disabled(struct kvm_vcpu *vcpu)\n{\n\tvm_enable_cap(vcpu->vm, KVM_CAP_MSR_PLATFORM_INFO, false);\n\tvcpu_run(vcpu);\n\tTEST_ASSERT_KVM_EXIT_REASON(vcpu, KVM_EXIT_SHUTDOWN);\n}\n\nint main(int argc, char *argv[])\n{\n\tstruct kvm_vcpu *vcpu;\n\tstruct kvm_vm *vm;\n\tuint64_t msr_platform_info;\n\n\tTEST_REQUIRE(kvm_has_cap(KVM_CAP_MSR_PLATFORM_INFO));\n\n\tvm = vm_create_with_one_vcpu(&vcpu, guest_code);\n\n\tmsr_platform_info = vcpu_get_msr(vcpu, MSR_PLATFORM_INFO);\n\tvcpu_set_msr(vcpu, MSR_PLATFORM_INFO,\n\t\t     msr_platform_info | MSR_PLATFORM_INFO_MAX_TURBO_RATIO);\n\ttest_msr_platform_info_enabled(vcpu);\n\ttest_msr_platform_info_disabled(vcpu);\n\tvcpu_set_msr(vcpu, MSR_PLATFORM_INFO, msr_platform_info);\n\n\tkvm_vm_free(vm);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}