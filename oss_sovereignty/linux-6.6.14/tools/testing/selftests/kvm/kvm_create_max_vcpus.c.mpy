{
  "module_name": "kvm_create_max_vcpus.c",
  "hash_id": "4669fb770cc789c89a4e0975bd0b9fd49e59552342aa918ba91136197d3c2a8c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/kvm/kvm_create_max_vcpus.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE  \n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/resource.h>\n\n#include \"test_util.h\"\n\n#include \"kvm_util.h\"\n#include \"asm/kvm.h\"\n#include \"linux/kvm.h\"\n\nvoid test_vcpu_creation(int first_vcpu_id, int num_vcpus)\n{\n\tstruct kvm_vm *vm;\n\tint i;\n\n\tpr_info(\"Testing creating %d vCPUs, with IDs %d...%d.\\n\",\n\t\tnum_vcpus, first_vcpu_id, first_vcpu_id + num_vcpus - 1);\n\n\tvm = vm_create_barebones();\n\n\tfor (i = first_vcpu_id; i < first_vcpu_id + num_vcpus; i++)\n\t\t \n\t\t__vm_vcpu_add(vm, i);\n\n\tkvm_vm_free(vm);\n}\n\nint main(int argc, char *argv[])\n{\n\tint kvm_max_vcpu_id = kvm_check_cap(KVM_CAP_MAX_VCPU_ID);\n\tint kvm_max_vcpus = kvm_check_cap(KVM_CAP_MAX_VCPUS);\n\t \n\tint nr_fds_wanted = kvm_max_vcpus + 100;\n\tstruct rlimit rl;\n\n\tpr_info(\"KVM_CAP_MAX_VCPU_ID: %d\\n\", kvm_max_vcpu_id);\n\tpr_info(\"KVM_CAP_MAX_VCPUS: %d\\n\", kvm_max_vcpus);\n\n\t \n\tTEST_ASSERT(!getrlimit(RLIMIT_NOFILE, &rl), \"getrlimit() failed!\");\n\n\tif (rl.rlim_cur < nr_fds_wanted) {\n\t\trl.rlim_cur = nr_fds_wanted;\n\t\tif (rl.rlim_max < nr_fds_wanted) {\n\t\t\tint old_rlim_max = rl.rlim_max;\n\t\t\trl.rlim_max = nr_fds_wanted;\n\n\t\t\tint r = setrlimit(RLIMIT_NOFILE, &rl);\n\t\t\t__TEST_REQUIRE(r >= 0,\n\t\t\t\t       \"RLIMIT_NOFILE hard limit is too low (%d, wanted %d)\\n\",\n\t\t\t\t       old_rlim_max, nr_fds_wanted);\n\t\t} else {\n\t\t\tTEST_ASSERT(!setrlimit(RLIMIT_NOFILE, &rl), \"setrlimit() failed!\");\n\t\t}\n\t}\n\n\t \n\tif (!kvm_max_vcpu_id)\n\t\tkvm_max_vcpu_id = kvm_max_vcpus;\n\n\tTEST_ASSERT(kvm_max_vcpu_id >= kvm_max_vcpus,\n\t\t    \"KVM_MAX_VCPU_IDS (%d) must be at least as large as KVM_MAX_VCPUS (%d).\",\n\t\t    kvm_max_vcpu_id, kvm_max_vcpus);\n\n\ttest_vcpu_creation(0, kvm_max_vcpus);\n\n\tif (kvm_max_vcpu_id > kvm_max_vcpus)\n\t\ttest_vcpu_creation(\n\t\t\tkvm_max_vcpu_id - kvm_max_vcpus, kvm_max_vcpus);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}