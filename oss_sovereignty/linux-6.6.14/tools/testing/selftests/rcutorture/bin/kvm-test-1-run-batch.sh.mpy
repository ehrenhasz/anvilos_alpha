{
  "module_name": "kvm-test-1-run-batch.sh",
  "hash_id": "aeb24af3679a05c3cb9965d012b2bf15c5d0105902781b5c4d02e6d26748aa97",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rcutorture/bin/kvm-test-1-run-batch.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Carry out a kvm-based run for the specified batch of scenarios, which\n# might have been built by --build-only kvm.sh run.\n#\n# Usage: kvm-test-1-run-batch.sh SCENARIO [ SCENARIO ... ]\n#\n# Each SCENARIO is the name of a directory in the current directory\n#\tcontaining a ready-to-run qemu-cmd file.\n#\n# Copyright (C) 2021 Facebook, Inc.\n#\n# Authors: Paul E. McKenney <paulmck@kernel.org>\n\nT=\"`mktemp -d ${TMPDIR-/tmp}/kvm-test-1-run-batch.sh.XXXXXX`\"\ntrap 'rm -rf $T' 0\n\necho ---- Running batch $*\n# Check arguments\nrunfiles=\nfor i in \"$@\"\ndo\n\tif ! echo $i | grep -q '^[^/.a-z]\\+\\(\\.[0-9]\\+\\)\\?$'\n\tthen\n\t\techo Bad scenario name: \\\"$i\\\" 1>&2\n\t\texit 1\n\tfi\n\tif ! test -d \"$i\"\n\tthen\n\t\techo Scenario name not a directory: \\\"$i\\\" 1>&2\n\t\texit 2\n\tfi\n\tif ! test -f \"$i/qemu-cmd\"\n\tthen\n\t\techo Scenario lacks a command file: \\\"$i/qemu-cmd\\\" 1>&2\n\t\texit 3\n\tfi\n\trm -f $i/build.*\n\ttouch $i/build.run\n\trunfiles=\"$runfiles $i/build.run\"\ndone\n\n# Extract settings from the qemu-cmd file.\ngrep '^#' $1/qemu-cmd | sed -e 's/^# //' > $T/qemu-cmd-settings\n. $T/qemu-cmd-settings\n\n# Start up jitter, start each scenario, wait, end jitter.\necho ---- System running test: `uname -a`\necho ---- Starting kernels. `date` | tee -a log\n$TORTURE_JITTER_START\nkvm-assign-cpus.sh /sys/devices/system/node > $T/cpuarray.awk\nfor i in \"$@\"\ndo\n\techo ---- System running test: `uname -a` > $i/kvm-test-1-run-qemu.sh.out\n\techo > $i/kvm-test-1-run-qemu.sh.out\n\texport TORTURE_AFFINITY=\n\tkvm-get-cpus-script.sh $T/cpuarray.awk $T/cpubatches.awk $T/cpustate\n\tcat << '\t___EOF___' >> $T/cpubatches.awk\n\tEND {\n\t\taffinitylist = \"\";\n\t\tif (!gotcpus()) {\n\t\t\tprint \"echo No CPU-affinity information, so no taskset command.\";\n\t\t} else if (cpu_count !~ /^[0-9][0-9]*$/) {\n\t\t\tprint \"echo \" scenario \": Bogus number of CPUs (old qemu-cmd?), so no taskset command.\";\n\t\t} else {\n\t\t\taffinitylist = nextcpus(cpu_count);\n\t\t\tif (!(affinitylist ~ /^[0-9,-][0-9,-]*$/))\n\t\t\t\tprint \"echo \" scenario \": Bogus CPU-affinity information, so no taskset command.\";\n\t\t\telse if (!dumpcpustate())\n\t\t\t\tprint \"echo \" scenario \": Could not dump state, so no taskset command.\";\n\t\t\telse\n\t\t\t\tprint \"export TORTURE_AFFINITY=\" affinitylist;\n\t\t}\n\t}\n\t___EOF___\n\tcpu_count=\"`grep '# TORTURE_CPU_COUNT=' $i/qemu-cmd | sed -e 's/^.*=//'`\"\n\taffinity_export=\"`awk -f $T/cpubatches.awk -v cpu_count=\"$cpu_count\" -v scenario=$i < /dev/null`\"\n\t$affinity_export\n\tkvm-test-1-run-qemu.sh $i >> $i/kvm-test-1-run-qemu.sh.out 2>&1 &\ndone\nfor i in $runfiles\ndo\n\twhile ls $i > /dev/null 2>&1\n\tdo\n\t\t:\n\tdone\ndone\necho ---- All kernel runs complete. `date` | tee -a log\n$TORTURE_JITTER_STOP\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}