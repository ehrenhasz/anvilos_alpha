{
  "module_name": "kvm-test-1-run-qemu.sh",
  "hash_id": "3fe0e012d25f067a9a1b8a39cdc815bc05ce65cffc449d76a22365a0ed209029",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rcutorture/bin/kvm-test-1-run-qemu.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Carry out a kvm-based run for the specified qemu-cmd file, which might\n# have been generated by --build-only kvm.sh run.\n#\n# Usage: kvm-test-1-run-qemu.sh qemu-cmd-dir\n#\n# qemu-cmd-dir provides the directory containing qemu-cmd file.\n#\tThis is assumed to be of the form prefix/ds/scenario, where\n#\t\"ds\" is the top-level date-stamped directory and \"scenario\"\n#\tis the scenario name.  Any required adjustments to this file\n#\tmust have been made by the caller.  The shell-command comments\n#\tat the end of the qemu-cmd file are not optional.\n#\n# Copyright (C) 2021 Facebook, Inc.\n#\n# Authors: Paul E. McKenney <paulmck@kernel.org>\n\nT=\"`mktemp -d ${TMPDIR-/tmp}/kvm-test-1-run-qemu.sh.XXXXXX`\"\ntrap 'rm -rf $T' 0\n\nresdir=\"$1\"\nif ! test -d \"$resdir\"\nthen\n\techo $0: Nonexistent directory: $resdir\n\texit 1\nfi\nif ! test -f \"$resdir/qemu-cmd\"\nthen\n\techo $0: Nonexistent qemu-cmd file: $resdir/qemu-cmd\n\texit 1\nfi\n\necho ' ---' `date`: Starting kernel, PID $$\n\n# Obtain settings from the qemu-cmd file.\ngrep '^#' $resdir/qemu-cmd | sed -e 's/^# //' > $T/qemu-cmd-settings\n. $T/qemu-cmd-settings\n\n# Decorate qemu-cmd with affinity, redirection, backgrounding, and PID capture\ntaskset_command=\nif test -n \"$TORTURE_AFFINITY\"\nthen\n\ttaskset_command=\"taskset -c $TORTURE_AFFINITY \"\nfi\nsed -e 's/^[^#].*$/'\"$taskset_command\"'& 2>\\&1 \\&/' < $resdir/qemu-cmd > $T/qemu-cmd\necho 'qemu_pid=$!' >> $T/qemu-cmd\necho 'echo $qemu_pid > $resdir/qemu-pid' >> $T/qemu-cmd\necho 'taskset -c -p $qemu_pid > $resdir/qemu-affinity' >> $T/qemu-cmd\n\n# In case qemu refuses to run...\necho \"NOTE: $QEMU either did not run or was interactive\" > $resdir/console.log\n\n# Attempt to run qemu\nkstarttime=`gawk 'BEGIN { print systime() }' < /dev/null`\n( . $T/qemu-cmd; wait `cat  $resdir/qemu-pid`; echo $? > $resdir/qemu-retval ) &\ncommandcompleted=0\nif test -z \"$TORTURE_KCONFIG_GDB_ARG\"\nthen\n\tsleep 10 # Give qemu's pid a chance to reach the file\n\tif test -s \"$resdir/qemu-pid\"\n\tthen\n\t\tqemu_pid=`cat \"$resdir/qemu-pid\"`\n\t\techo Monitoring qemu job at pid $qemu_pid `date`\n\telse\n\t\tqemu_pid=\"\"\n\t\techo Monitoring qemu job at yet-as-unknown pid `date`\n\tfi\nfi\nif test -n \"$TORTURE_KCONFIG_GDB_ARG\"\nthen\n\tbase_resdir=`echo $resdir | sed -e 's/\\.[0-9]\\+$//'`\n\tif ! test -f $base_resdir/vmlinux\n\tthen\n\t\tbase_resdir=\"`cat re-run`/$resdir\"\n\t\tif ! test -f $base_resdir/vmlinux\n\t\tthen\n\t\t\tbase_resdir=/path/to\n\t\tfi\n\tfi\n\techo Waiting for you to attach a debug session, for example: > /dev/tty\n\techo \"    gdb $base_resdir/vmlinux\" > /dev/tty\n\techo 'After symbols load and the \"(gdb)\" prompt appears:' > /dev/tty\n\techo \"    target remote :1234\" > /dev/tty\n\techo \"    continue\" > /dev/tty\n\tkstarttime=`gawk 'BEGIN { print systime() }' < /dev/null`\nfi\nwhile :\ndo\n\tif test -z \"$qemu_pid\" && test -s \"$resdir/qemu-pid\"\n\tthen\n\t\tqemu_pid=`cat \"$resdir/qemu-pid\"`\n\tfi\n\tkruntime=`gawk 'BEGIN { print systime() - '\"$kstarttime\"' }' < /dev/null`\n\tif test -z \"$qemu_pid\" || kill -0 \"$qemu_pid\" > /dev/null 2>&1\n\tthen\n\t\tif test -n \"$TORTURE_KCONFIG_GDB_ARG\"\n\t\tthen\n\t\t\t:\n\t\telif test $kruntime -ge $seconds || test -f \"$resdir/../STOP.1\"\n\t\tthen\n\t\t\tbreak;\n\t\tfi\n\t\tsleep 1\n\telse\n\t\tcommandcompleted=1\n\t\tif test $kruntime -lt $seconds\n\t\tthen\n\t\t\techo Completed in $kruntime vs. $seconds >> $resdir/Warnings 2>&1\n\t\t\tgrep \"^(qemu) qemu:\" $resdir/kvm-test-1-run*.sh.out >> $resdir/Warnings 2>&1\n\t\t\tkillpid=\"`sed -n \"s/^(qemu) qemu: terminating on signal [0-9]* from pid \\([0-9]*\\).*$/\\1/p\" $resdir/Warnings`\"\n\t\t\tif test -n \"$killpid\"\n\t\t\tthen\n\t\t\t\techo \"ps -fp $killpid\" >> $resdir/Warnings 2>&1\n\t\t\t\tps -fp $killpid >> $resdir/Warnings 2>&1\n\t\t\tfi\n\t\telse\n\t\t\techo ' ---' `date`: \"Kernel done\"\n\t\tfi\n\t\tbreak\n\tfi\ndone\nif test -z \"$qemu_pid\" && test -s \"$resdir/qemu-pid\"\nthen\n\tqemu_pid=`cat \"$resdir/qemu-pid\"`\nfi\nif test $commandcompleted -eq 0 && test -n \"$qemu_pid\"\nthen\n\tif ! test -f \"$resdir/../STOP.1\"\n\tthen\n\t\techo Grace period for qemu job at pid $qemu_pid `date`\n\tfi\n\toldline=\"`tail $resdir/console.log`\"\n\twhile :\n\tdo\n\t\tif test -f \"$resdir/../STOP.1\"\n\t\tthen\n\t\t\techo \"PID $qemu_pid killed due to run STOP.1 request `date`\" >> $resdir/Warnings 2>&1\n\t\t\tkill -KILL $qemu_pid\n\t\t\tbreak\n\t\tfi\n\t\tkruntime=`gawk 'BEGIN { print systime() - '\"$kstarttime\"' }' < /dev/null`\n\t\tif kill -0 $qemu_pid > /dev/null 2>&1\n\t\tthen\n\t\t\t:\n\t\telse\n\t\t\tbreak\n\t\tfi\n\t\tmust_continue=no\n\t\tnewline=\"`tail $resdir/console.log`\"\n\t\tif test \"$newline\" != \"$oldline\" && echo $newline | grep -q ' [0-9]\\+us : '\n\t\tthen\n\t\t\tmust_continue=yes\n\t\tfi\n\t\tlast_ts=\"`tail $resdir/console.log | grep '^\\[ *[0-9]\\+\\.[0-9]\\+]' | tail -1 | sed -e 's/^\\[ *//' -e 's/\\..*$//'`\"\n\t\tif test -z \"$last_ts\"\n\t\tthen\n\t\t\tlast_ts=0\n\t\tfi\n\t\tif test \"$newline\" != \"$oldline\" && test \"$last_ts\" -lt $((seconds + $TORTURE_SHUTDOWN_GRACE)) && test \"$last_ts\" -gt \"$TORTURE_SHUTDOWN_GRACE\"\n\t\tthen\n\t\t\tmust_continue=yes\n\t\t\tif test $kruntime -ge $((seconds + $TORTURE_SHUTDOWN_GRACE))\n\t\t\tthen\n\t\t\t\techo Continuing at console.log time $last_ts \\\"`tail -n 1 $resdir/console.log`\\\" `date`\n\t\t\tfi\n\t\tfi\n\t\tif test $must_continue = no && test $kruntime -ge $((seconds + $TORTURE_SHUTDOWN_GRACE))\n\t\tthen\n\t\t\techo \"!!! PID $qemu_pid hung at $kruntime vs. $seconds seconds `date`\" >> $resdir/Warnings 2>&1\n\t\t\tkill -KILL $qemu_pid\n\t\t\tbreak\n\t\tfi\n\t\toldline=$newline\n\t\tsleep 10\n\tdone\nelif test -z \"$qemu_pid\"\nthen\n\techo Unknown PID, cannot kill qemu command\nfi\n\n# Tell the script that this run is done.\nrm -f $resdir/build.run\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}