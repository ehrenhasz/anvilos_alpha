{
  "module_name": "kvm-again.sh",
  "hash_id": "a5a3b8b5bcfb3e6fc69eb88d3419b1bcb736d3ce40f99aaaf0a7ee897bbccc46",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rcutorture/bin/kvm-again.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Rerun a series of tests under KVM.\n#\n# Usage: kvm-again.sh /path/to/old/run [ options ]\n#\n# Copyright (C) 2021 Facebook, Inc.\n#\n# Authors: Paul E. McKenney <paulmck@kernel.org>\n\nscriptname=$0\nargs=\"$*\"\n\nT=\"`mktemp -d ${TMPDIR-/tmp}/kvm-again.sh.XXXXXX`\"\ntrap 'rm -rf $T' 0\n\nif ! test -d tools/testing/selftests/rcutorture/bin\nthen\n\techo $scriptname must be run from top-level directory of kernel source tree.\n\texit 1\nfi\n\noldrun=$1\nshift\nif ! test -d \"$oldrun\"\nthen\n\techo \"Usage: $scriptname /path/to/old/run [ options ]\"\n\texit 1\nfi\nif ! cp \"$oldrun/scenarios\" $T/scenarios.oldrun\nthen\n\t# Later on, can reconstitute this from console.log files.\n\techo Prior run batches file does not exist: $oldrun/batches\n\texit 1\nfi\n\nif test -f \"$oldrun/torture_suite\"\nthen\n\ttorture_suite=\"`cat $oldrun/torture_suite`\"\nelif test -f \"$oldrun/TORTURE_SUITE\"\nthen\n\ttorture_suite=\"`cat $oldrun/TORTURE_SUITE`\"\nelse\n\techo \"Prior run torture_suite file does not exist: $oldrun/{torture_suite,TORTURE_SUITE}\"\n\texit 1\nfi\n\nRCUTORTURE=\"`pwd`/tools/testing/selftests/rcutorture\"; export RCUTORTURE\nPATH=${RCUTORTURE}/bin:$PATH; export PATH\n. functions.sh\n\nbootargs=\ndryrun=\ndur=\ndefault_link=\"cp -R\"\nresdir=\"`pwd`/tools/testing/selftests/rcutorture/res\"\nrundir=\"$resdir/`date +%Y.%m.%d-%H.%M.%S-again`\"\ngot_datestamp=\ngot_rundir=\n\nstartdate=\"`date`\"\nstarttime=\"`get_starttime`\"\n\nusage () {\n\techo \"Usage: $scriptname $oldrun [ arguments ]:\"\n\techo \"       --bootargs kernel-boot-arguments\"\n\techo \"       --datestamp string\"\n\techo \"       --dryrun\"\n\techo \"       --duration minutes | <seconds>s | <hours>h | <days>d\"\n\techo \"       --link hard|soft|copy\"\n\techo \"       --remote\"\n\techo \"       --rundir /new/res/path\"\n\techo \"Command line: $scriptname $args\"\n\texit 1\n}\n\nwhile test $# -gt 0\ndo\n\tcase \"$1\" in\n\t--bootargs|--bootarg)\n\t\tcheckarg --bootargs \"(list of kernel boot arguments)\" \"$#\" \"$2\" '.*' '^--'\n\t\tbootargs=\"$bootargs $2\"\n\t\tshift\n\t\t;;\n\t--datestamp)\n\t\tcheckarg --datestamp \"(relative pathname)\" \"$#\" \"$2\" '^[a-zA-Z0-9._/-]*$' '^--'\n\t\tif test -n \"$got_rundir\" || test -n \"$got_datestamp\"\n\t\tthen\n\t\t\techo Only one of --datestamp or --rundir may be specified\n\t\t\tusage\n\t\tfi\n\t\tgot_datestamp=y\n\t\tds=$2\n\t\trundir=\"$resdir/$ds\"\n\t\tif test -e \"$rundir\"\n\t\tthen\n\t\t\techo \"--datestamp $2: Already exists.\"\n\t\t\tusage\n\t\tfi\n\t\tshift\n\t\t;;\n\t--dryrun)\n\t\tdryrun=1\n\t\t;;\n\t--duration)\n\t\tcheckarg --duration \"(minutes)\" $# \"$2\" '^[0-9][0-9]*\\(s\\|m\\|h\\|d\\|\\)$' '^error'\n\t\tmult=60\n\t\tif echo \"$2\" | grep -q 's$'\n\t\tthen\n\t\t\tmult=1\n\t\telif echo \"$2\" | grep -q 'h$'\n\t\tthen\n\t\t\tmult=3600\n\t\telif echo \"$2\" | grep -q 'd$'\n\t\tthen\n\t\t\tmult=86400\n\t\tfi\n\t\tts=`echo $2 | sed -e 's/[smhd]$//'`\n\t\tdur=$(($ts*mult))\n\t\tshift\n\t\t;;\n\t--link)\n\t\tcheckarg --link \"hard|soft|copy\" \"$#\" \"$2\" 'hard\\|soft\\|copy' '^--'\n\t\tcase \"$2\" in\n\t\tcopy)\n\t\t\targ_link=\"cp -R\"\n\t\t\t;;\n\t\thard)\n\t\t\targ_link=\"cp -Rl\"\n\t\t\t;;\n\t\tsoft)\n\t\t\targ_link=\"cp -Rs\"\n\t\t\t;;\n\t\tesac\n\t\tshift\n\t\t;;\n\t--remote)\n\t\targ_remote=1\n\t\tdefault_link=\"cp -as\"\n\t\t;;\n\t--rundir)\n\t\tcheckarg --rundir \"(absolute pathname)\" \"$#\" \"$2\" '^/' '^error'\n\t\tif test -n \"$got_rundir\" || test -n \"$got_datestamp\"\n\t\tthen\n\t\t\techo Only one of --datestamp or --rundir may be specified\n\t\t\tusage\n\t\tfi\n\t\tgot_rundir=y\n\t\trundir=$2\n\t\tif test -e \"$rundir\"\n\t\tthen\n\t\t\techo \"--rundir $2: Already exists.\"\n\t\t\tusage\n\t\tfi\n\t\tshift\n\t\t;;\n\t*)\n\t\tif test -n \"$1\"\n\t\tthen\n\t\t\techo Unknown argument $1\n\t\t\tusage\n\t\tfi\n\t\t;;\n\tesac\n\tshift\ndone\nif test -z \"$arg_link\"\nthen\n\targ_link=\"$default_link\"\nfi\n\necho ---- Re-run results directory: $rundir\n\n# Copy old run directory tree over and adjust.\nmkdir -p \"`dirname \"$rundir\"`\"\nif ! $arg_link \"$oldrun\" \"$rundir\"\nthen\n\techo \"Cannot copy from $oldrun to $rundir.\"\n\tusage\nfi\nrm -f \"$rundir\"/*/{console.log,console.log.diags,qemu_pid,qemu-pid,qemu-retval,Warnings,kvm-test-1-run.sh.out,kvm-test-1-run-qemu.sh.out,vmlinux} \"$rundir\"/log\ntouch \"$rundir/log\"\necho $scriptname $args | tee -a \"$rundir/log\"\necho $oldrun > \"$rundir/re-run\"\nif ! test -d \"$rundir/../../bin\"\nthen\n\t$arg_link \"$oldrun/../../bin\" \"$rundir/../..\"\nfi\nfor i in $rundir/*/qemu-cmd\ndo\n\tcp \"$i\" $T\n\tqemu_cmd_dir=\"`dirname \"$i\"`\"\n\tkernel_dir=\"`echo $qemu_cmd_dir | sed -e 's/\\.[0-9]\\+$//'`\"\n\tjitter_dir=\"`dirname \"$kernel_dir\"`\"\n\tkvm-transform.sh \"$kernel_dir/bzImage\" \"$qemu_cmd_dir/console.log\" \"$jitter_dir\" \"$dur\" \"$bootargs\" < $T/qemu-cmd > $i\n\tif test -n \"$arg_remote\"\n\tthen\n\t\techo \"# TORTURE_KCONFIG_GDB_ARG=''\" >> $i\n\tfi\ndone\n\n# Extract settings from the last qemu-cmd file transformed above.\ngrep '^#' $i | sed -e 's/^# //' > $T/qemu-cmd-settings\n. $T/qemu-cmd-settings\n\ngrep -v '^#' $T/scenarios.oldrun | awk '\n{\n\tcurbatch = \"\";\n\tfor (i = 2; i <= NF; i++)\n\t\tcurbatch = curbatch \" \" $i;\n\tprint \"kvm-test-1-run-batch.sh\" curbatch;\n}' > $T/runbatches.sh\n\nif test -n \"$dryrun\"\nthen\n\techo ---- Dryrun complete, directory: $rundir | tee -a \"$rundir/log\"\nelse\n\t( cd \"$rundir\"; sh $T/runbatches.sh ) | tee -a \"$rundir/log\"\n\tkvm-end-run-stats.sh \"$rundir\" \"$starttime\"\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}