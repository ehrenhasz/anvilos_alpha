{
  "module_name": "torture.sh",
  "hash_id": "9730333d25ed35231665d402f070178b7b2f0319487f0de20cfc800ee6efd607",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rcutorture/bin/torture.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Run a series of torture tests, intended for overnight or\n# longer timeframes, and also for large systems.\n#\n# Usage: torture.sh [ options ]\n#\n# Copyright (C) 2020 Facebook, Inc.\n#\n# Authors: Paul E. McKenney <paulmck@kernel.org>\n\nscriptname=$0\nargs=\"$*\"\n\nRCUTORTURE=\"`pwd`/tools/testing/selftests/rcutorture\"; export RCUTORTURE\nPATH=${RCUTORTURE}/bin:$PATH; export PATH\n. functions.sh\n\nTORTURE_ALLOTED_CPUS=\"`identify_qemu_vcpus`\"\nMAKE_ALLOTED_CPUS=$((TORTURE_ALLOTED_CPUS*2))\nHALF_ALLOTED_CPUS=$((TORTURE_ALLOTED_CPUS/2))\nif test \"$HALF_ALLOTED_CPUS\" -lt 1\nthen\n\tHALF_ALLOTED_CPUS=1\nfi\nVERBOSE_BATCH_CPUS=$((TORTURE_ALLOTED_CPUS/16))\nif test \"$VERBOSE_BATCH_CPUS\" -lt 2\nthen\n\tVERBOSE_BATCH_CPUS=0\nfi\n\n# Configurations/scenarios.\nconfigs_rcutorture=\nconfigs_locktorture=\nconfigs_scftorture=\nkcsan_kmake_args=\n\n# Default compression, duration, and apportionment.\ncompress_concurrency=\"`identify_qemu_vcpus`\"\nduration_base=10\nduration_rcutorture_frac=7\nduration_locktorture_frac=1\nduration_scftorture_frac=2\n\n# \"yes\" or \"no\" parameters\ndo_allmodconfig=yes\ndo_rcutorture=yes\ndo_locktorture=yes\ndo_scftorture=yes\ndo_rcuscale=yes\ndo_refscale=yes\ndo_kvfree=yes\ndo_kasan=yes\ndo_kcsan=no\ndo_clocksourcewd=yes\ndo_rt=yes\ndo_rcutasksflavors=yes\ndo_srcu_lockdep=yes\n\n# doyesno - Helper function for yes/no arguments\nfunction doyesno () {\n\tif test \"$1\" = \"$2\"\n\tthen\n\t\techo yes\n\telse\n\t\techo no\n\tfi\n}\n\nusage () {\n\techo \"Usage: $scriptname optional arguments:\"\n\techo \"       --compress-concurrency concurrency\"\n\techo \"       --configs-rcutorture \\\"config-file list w/ repeat factor (3*TINY01)\\\"\"\n\techo \"       --configs-locktorture \\\"config-file list w/ repeat factor (10*LOCK01)\\\"\"\n\techo \"       --configs-scftorture \\\"config-file list w/ repeat factor (2*CFLIST)\\\"\"\n\techo \"       --do-all\"\n\techo \"       --do-allmodconfig / --do-no-allmodconfig / --no-allmodconfig\"\n\techo \"       --do-clocksourcewd / --do-no-clocksourcewd / --no-clocksourcewd\"\n\techo \"       --do-kasan / --do-no-kasan / --no-kasan\"\n\techo \"       --do-kcsan / --do-no-kcsan / --no-kcsan\"\n\techo \"       --do-kvfree / --do-no-kvfree / --no-kvfree\"\n\techo \"       --do-locktorture / --do-no-locktorture / --no-locktorture\"\n\techo \"       --do-none\"\n\techo \"       --do-rcuscale / --do-no-rcuscale / --no-rcuscale\"\n\techo \"       --do-rcutasksflavors / --do-no-rcutasksflavors / --no-rcutasksflavors\"\n\techo \"       --do-rcutorture / --do-no-rcutorture / --no-rcutorture\"\n\techo \"       --do-refscale / --do-no-refscale / --no-refscale\"\n\techo \"       --do-rt / --do-no-rt / --no-rt\"\n\techo \"       --do-scftorture / --do-no-scftorture / --no-scftorture\"\n\techo \"       --do-srcu-lockdep / --do-no-srcu-lockdep / --no-srcu-lockdep\"\n\techo \"       --duration [ <minutes> | <hours>h | <days>d ]\"\n\techo \"       --kcsan-kmake-arg kernel-make-arguments\"\n\texit 1\n}\n\nwhile test $# -gt 0\ndo\n\tcase \"$1\" in\n\t--compress-concurrency)\n\t\tcheckarg --compress-concurrency \"(concurrency level)\" $# \"$2\" '^[0-9][0-9]*$' '^error'\n\t\tcompress_concurrency=$2\n\t\tshift\n\t\t;;\n\t--config-rcutorture|--configs-rcutorture)\n\t\tcheckarg --configs-rcutorture \"(list of config files)\" \"$#\" \"$2\" '^[^/]\\+$' '^--'\n\t\tconfigs_rcutorture=\"$configs_rcutorture $2\"\n\t\tshift\n\t\t;;\n\t--config-locktorture|--configs-locktorture)\n\t\tcheckarg --configs-locktorture \"(list of config files)\" \"$#\" \"$2\" '^[^/]\\+$' '^--'\n\t\tconfigs_locktorture=\"$configs_locktorture $2\"\n\t\tshift\n\t\t;;\n\t--config-scftorture|--configs-scftorture)\n\t\tcheckarg --configs-scftorture \"(list of config files)\" \"$#\" \"$2\" '^[^/]\\+$' '^--'\n\t\tconfigs_scftorture=\"$configs_scftorture $2\"\n\t\tshift\n\t\t;;\n\t--do-all|--doall)\n\t\tdo_allmodconfig=yes\n\t\tdo_rcutasksflavor=yes\n\t\tdo_rcutorture=yes\n\t\tdo_locktorture=yes\n\t\tdo_scftorture=yes\n\t\tdo_rcuscale=yes\n\t\tdo_refscale=yes\n\t\tdo_rt=yes\n\t\tdo_kvfree=yes\n\t\tdo_kasan=yes\n\t\tdo_kcsan=yes\n\t\tdo_clocksourcewd=yes\n\t\tdo_srcu_lockdep=yes\n\t\t;;\n\t--do-allmodconfig|--do-no-allmodconfig|--no-allmodconfig)\n\t\tdo_allmodconfig=`doyesno \"$1\" --do-allmodconfig`\n\t\t;;\n\t--do-clocksourcewd|--do-no-clocksourcewd|--no-clocksourcewd)\n\t\tdo_clocksourcewd=`doyesno \"$1\" --do-clocksourcewd`\n\t\t;;\n\t--do-kasan|--do-no-kasan|--no-kasan)\n\t\tdo_kasan=`doyesno \"$1\" --do-kasan`\n\t\t;;\n\t--do-kcsan|--do-no-kcsan|--no-kcsan)\n\t\tdo_kcsan=`doyesno \"$1\" --do-kcsan`\n\t\t;;\n\t--do-kvfree|--do-no-kvfree|--no-kvfree)\n\t\tdo_kvfree=`doyesno \"$1\" --do-kvfree`\n\t\t;;\n\t--do-locktorture|--do-no-locktorture|--no-locktorture)\n\t\tdo_locktorture=`doyesno \"$1\" --do-locktorture`\n\t\t;;\n\t--do-none|--donone)\n\t\tdo_allmodconfig=no\n\t\tdo_rcutasksflavors=no\n\t\tdo_rcutorture=no\n\t\tdo_locktorture=no\n\t\tdo_scftorture=no\n\t\tdo_rcuscale=no\n\t\tdo_refscale=no\n\t\tdo_rt=no\n\t\tdo_kvfree=no\n\t\tdo_kasan=no\n\t\tdo_kcsan=no\n\t\tdo_clocksourcewd=no\n\t\tdo_srcu_lockdep=no\n\t\t;;\n\t--do-rcuscale|--do-no-rcuscale|--no-rcuscale)\n\t\tdo_rcuscale=`doyesno \"$1\" --do-rcuscale`\n\t\t;;\n\t--do-rcutasksflavors|--do-no-rcutasksflavors|--no-rcutasksflavors)\n\t\tdo_rcutasksflavors=`doyesno \"$1\" --do-rcutasksflavors`\n\t\t;;\n\t--do-rcutorture|--do-no-rcutorture|--no-rcutorture)\n\t\tdo_rcutorture=`doyesno \"$1\" --do-rcutorture`\n\t\t;;\n\t--do-refscale|--do-no-refscale|--no-refscale)\n\t\tdo_refscale=`doyesno \"$1\" --do-refscale`\n\t\t;;\n\t--do-rt|--do-no-rt|--no-rt)\n\t\tdo_rt=`doyesno \"$1\" --do-rt`\n\t\t;;\n\t--do-scftorture|--do-no-scftorture|--no-scftorture)\n\t\tdo_scftorture=`doyesno \"$1\" --do-scftorture`\n\t\t;;\n\t--do-srcu-lockdep|--do-no-srcu-lockdep|--no-srcu-lockdep)\n\t\tdo_srcu_lockdep=`doyesno \"$1\" --do-srcu-lockdep`\n\t\t;;\n\t--duration)\n\t\tcheckarg --duration \"(minutes)\" $# \"$2\" '^[0-9][0-9]*\\(m\\|h\\|d\\|\\)$' '^error'\n\t\tmult=1\n\t\tif echo \"$2\" | grep -q 'm$'\n\t\tthen\n\t\t\tmult=1\n\t\telif echo \"$2\" | grep -q 'h$'\n\t\tthen\n\t\t\tmult=60\n\t\telif echo \"$2\" | grep -q 'd$'\n\t\tthen\n\t\t\tmult=1440\n\t\tfi\n\t\tts=`echo $2 | sed -e 's/[smhd]$//'`\n\t\tduration_base=$(($ts*mult))\n\t\tshift\n\t\t;;\n\t--kcsan-kmake-arg|--kcsan-kmake-args)\n\t\tcheckarg --kcsan-kmake-arg \"(kernel make arguments)\" $# \"$2\" '.*' '^error$'\n\t\tkcsan_kmake_args=\"`echo \"$kcsan_kmake_args $2\" | sed -e 's/^ *//' -e 's/ *$//'`\"\n\t\tshift\n\t\t;;\n\t*)\n\t\techo Unknown argument $1\n\t\tusage\n\t\t;;\n\tesac\n\tshift\ndone\n\nds=\"`date +%Y.%m.%d-%H.%M.%S`-torture\"\nstartdate=\"`date`\"\nstarttime=\"`get_starttime`\"\n\nT=\"`mktemp -d ${TMPDIR-/tmp}/torture.sh.XXXXXX`\"\ntrap 'rm -rf $T' 0 2\n\necho \" --- \" $scriptname $args | tee -a $T/log\necho \" --- Results directory: \" $ds | tee -a $T/log\n\n# Calculate rcutorture defaults and apportion time\nif test -z \"$configs_rcutorture\"\nthen\n\tconfigs_rcutorture=CFLIST\nfi\nduration_rcutorture=$((duration_base*duration_rcutorture_frac/10))\nif test \"$duration_rcutorture\" -eq 0\nthen\n\techo \" --- Zero time for rcutorture, disabling\" | tee -a $T/log\n\tdo_rcutorture=no\nfi\n\n# Calculate locktorture defaults and apportion time\nif test -z \"$configs_locktorture\"\nthen\n\tconfigs_locktorture=CFLIST\nfi\nduration_locktorture=$((duration_base*duration_locktorture_frac/10))\nif test \"$duration_locktorture\" -eq 0\nthen\n\techo \" --- Zero time for locktorture, disabling\" | tee -a $T/log\n\tdo_locktorture=no\nfi\n\n# Calculate scftorture defaults and apportion time\nif test -z \"$configs_scftorture\"\nthen\n\tconfigs_scftorture=CFLIST\nfi\nduration_scftorture=$((duration_base*duration_scftorture_frac/10))\nif test \"$duration_scftorture\" -eq 0\nthen\n\techo \" --- Zero time for scftorture, disabling\" | tee -a $T/log\n\tdo_scftorture=no\nfi\n\ntouch $T/failures\ntouch $T/successes\n\n# torture_one - Does a single kvm.sh run.\n#\n# Usage:\n#\ttorture_bootargs=\"[ kernel boot arguments ]\"\n#\ttorture_one flavor [ kvm.sh arguments ]\n#\n# Note that \"flavor\" is an arbitrary string.  Supply --torture if needed.\n# Note that quoting is problematic.  So on the command line, pass multiple\n# values with multiple kvm.sh argument instances.\nfunction torture_one {\n\tlocal cur_bootargs=\n\tlocal boottag=\n\n\techo \" --- $curflavor:\" Start `date` | tee -a $T/log\n\tif test -n \"$torture_bootargs\"\n\tthen\n\t\tboottag=\"--bootargs\"\n\t\tcur_bootargs=\"$torture_bootargs\"\n\tfi\n\t\"$@\" $boottag \"$cur_bootargs\" --datestamp \"$ds/results-$curflavor\" > $T/$curflavor.out 2>&1\n\tretcode=$?\n\tresdir=\"`grep '^Results directory: ' $T/$curflavor.out | tail -1 | sed -e 's/^Results directory: //'`\"\n\tif test -z \"$resdir\"\n\tthen\n\t\tcat $T/$curflavor.out | tee -a $T/log\n\t\techo retcode=$retcode | tee -a $T/log\n\telse\n\t\techo $resdir > $T/last-resdir\n\tfi\n\tif test \"$retcode\" == 0\n\tthen\n\t\techo \"$curflavor($retcode)\" $resdir >> $T/successes\n\telse\n\t\techo \"$curflavor($retcode)\" $resdir >> $T/failures\n\tfi\n}\n\n# torture_set - Does a set of tortures with and without KASAN and KCSAN.\n#\n# Usage:\n#\ttorture_bootargs=\"[ kernel boot arguments ]\"\n#\ttorture_set flavor [ kvm.sh arguments ]\n#\n# Note that \"flavor\" is an arbitrary string that does not affect kvm.sh\n# in any way.  So also supply --torture if you need something other than\n# the default.\nfunction torture_set {\n\tlocal cur_kcsan_kmake_args=\n\tlocal kcsan_kmake_tag=\n\tlocal flavor=$1\n\tshift\n\tcurflavor=$flavor\n\ttorture_one \"$@\"\n\tmv $T/last-resdir $T/last-resdir-nodebug || :\n\tif test \"$do_kasan\" = \"yes\"\n\tthen\n\t\tcurflavor=${flavor}-kasan\n\t\ttorture_one \"$@\" --kasan\n\t\tmv $T/last-resdir $T/last-resdir-kasan || :\n\tfi\n\tif test \"$do_kcsan\" = \"yes\"\n\tthen\n\t\tcurflavor=${flavor}-kcsan\n\t\tif test -n \"$kcsan_kmake_args\"\n\t\tthen\n\t\t\tkcsan_kmake_tag=\"--kmake-args\"\n\t\t\tcur_kcsan_kmake_args=\"$kcsan_kmake_args\"\n\t\tfi\n\t\ttorture_one \"$@\" --kconfig \"CONFIG_DEBUG_LOCK_ALLOC=y CONFIG_PROVE_LOCKING=y\" $kcsan_kmake_tag $cur_kcsan_kmake_args --kcsan\n\t\tmv $T/last-resdir $T/last-resdir-kcsan || :\n\tfi\n}\n\n# make allmodconfig\nif test \"$do_allmodconfig\" = \"yes\"\nthen\n\techo \" --- allmodconfig:\" Start `date` | tee -a $T/log\n\tamcdir=\"tools/testing/selftests/rcutorture/res/$ds/allmodconfig\"\n\tmkdir -p \"$amcdir\"\n\techo \" --- make clean\" | tee $amcdir/log > \"$amcdir/Make.out\" 2>&1\n\tmake -j$MAKE_ALLOTED_CPUS clean >> \"$amcdir/Make.out\" 2>&1\n\tretcode=$?\n\tbuildphase='\"make clean\"'\n\tif test \"$retcode\" -eq 0\n\tthen\n\t\techo \" --- make allmodconfig\" | tee -a $amcdir/log >> \"$amcdir/Make.out\" 2>&1\n\t\tcp .config $amcdir\n\t\tmake -j$MAKE_ALLOTED_CPUS allmodconfig >> \"$amcdir/Make.out\" 2>&1\n\t\tretcode=$?\n\t\tbuildphase='\"make allmodconfig\"'\n\tfi\n\tif test \"$retcode\" -eq 0\n\tthen\n\t\techo \" --- make \" | tee -a $amcdir/log >> \"$amcdir/Make.out\" 2>&1\n\t\tmake -j$MAKE_ALLOTED_CPUS >> \"$amcdir/Make.out\" 2>&1\n\t\tretcode=\"$?\"\n\t\techo $retcode > \"$amcdir/Make.exitcode\"\n\t\tbuildphase='\"make\"'\n\tfi\n\tif test \"$retcode\" -eq 0\n\tthen\n\t\techo \"allmodconfig($retcode)\" $amcdir >> $T/successes\n\t\techo Success >> $amcdir/log\n\telse\n\t\techo \"allmodconfig($retcode)\" $amcdir >> $T/failures\n\t\techo \" --- allmodconfig Test summary:\" >> $amcdir/log\n\t\techo \" --- Summary: Exit code $retcode from $buildphase, see Make.out\" >> $amcdir/log\n\tfi\nfi\n\n# Test building RCU Tasks flavors in isolation, both SMP and !SMP\nif test \"$do_rcutasksflavors\" = \"yes\"\nthen\n\techo \" --- rcutasksflavors:\" Start `date` | tee -a $T/log\n\trtfdir=\"tools/testing/selftests/rcutorture/res/$ds/results-rcutasksflavors\"\n\tmkdir -p \"$rtfdir\"\n\tcat > $T/rcutasksflavors << __EOF__\n#CHECK#CONFIG_TASKS_RCU=n\n#CHECK#CONFIG_TASKS_RUDE_RCU=n\n#CHECK#CONFIG_TASKS_TRACE_RCU=n\n__EOF__\n\tfor flavor in CONFIG_TASKS_RCU CONFIG_TASKS_RUDE_RCU CONFIG_TASKS_TRACE_RCU\n\tdo\n\t\tforceflavor=\"`echo $flavor | sed -e 's/^CONFIG/CONFIG_FORCE/'`\"\n\t\tdeselectedflavors=\"`grep -v $flavor $T/rcutasksflavors | tr '\\012' ' ' | tr -s ' ' | sed -e 's/ *$//'`\"\n\t\techo \" --- Running RCU Tasks Trace flavor $flavor `date`\" >> $rtfdir/log\n\t\ttools/testing/selftests/rcutorture/bin/kvm.sh --datestamp \"$ds/results-rcutasksflavors/$flavor\" --buildonly --configs \"TINY01 TREE04\" --kconfig \"CONFIG_RCU_EXPERT=y CONFIG_RCU_SCALE_TEST=y $forceflavor=y $deselectedflavors\" --trust-make > $T/$flavor.out 2>&1\n\t\tretcode=$?\n\t\tif test \"$retcode\" -ne 0\n\t\tthen\n\t\t\tbreak\n\t\tfi\n\tdone\n\tif test \"$retcode\" -eq 0\n\tthen\n\t\techo \"rcutasksflavors($retcode)\" $rtfdir >> $T/successes\n\t\techo Success >> $rtfdir/log\n\telse\n\t\techo \"rcutasksflavors($retcode)\" $rtfdir >> $T/failures\n\t\techo \" --- rcutasksflavors Test summary:\" >> $rtfdir/log\n\t\techo \" --- Summary: Exit code $retcode from $flavor, see Make.out\" >> $rtfdir/log\n\tfi\nfi\n\n# --torture rcu\nif test \"$do_rcutorture\" = \"yes\"\nthen\n\ttorture_bootargs=\"rcupdate.rcu_cpu_stall_suppress_at_boot=1 torture.disable_onoff_at_boot rcupdate.rcu_task_stall_timeout=30000\"\n\ttorture_set \"rcutorture\" tools/testing/selftests/rcutorture/bin/kvm.sh --allcpus --duration \"$duration_rcutorture\" --configs \"$configs_rcutorture\" --trust-make\nfi\n\nif test \"$do_locktorture\" = \"yes\"\nthen\n\ttorture_bootargs=\"torture.disable_onoff_at_boot\"\n\ttorture_set \"locktorture\" tools/testing/selftests/rcutorture/bin/kvm.sh --torture lock --allcpus --duration \"$duration_locktorture\" --configs \"$configs_locktorture\" --trust-make\nfi\n\nif test \"$do_scftorture\" = \"yes\"\nthen\n\t# Scale memory based on the number of CPUs.\n\tscfmem=$((2+HALF_ALLOTED_CPUS/16))\n\ttorture_bootargs=\"scftorture.nthreads=$HALF_ALLOTED_CPUS torture.disable_onoff_at_boot csdlock_debug=1\"\n\ttorture_set \"scftorture\" tools/testing/selftests/rcutorture/bin/kvm.sh --torture scf --allcpus --duration \"$duration_scftorture\" --configs \"$configs_scftorture\" --kconfig \"CONFIG_NR_CPUS=$HALF_ALLOTED_CPUS\" --memory ${scfmem}G --trust-make\nfi\n\nif test \"$do_rt\" = \"yes\"\nthen\n\t# With all post-boot grace periods forced to normal.\n\ttorture_bootargs=\"rcupdate.rcu_cpu_stall_suppress_at_boot=1 torture.disable_onoff_at_boot rcupdate.rcu_task_stall_timeout=30000 rcupdate.rcu_normal=1\"\n\ttorture_set \"rcurttorture\" tools/testing/selftests/rcutorture/bin/kvm.sh --allcpus --duration \"$duration_rcutorture\" --configs \"TREE03\" --trust-make\n\n\t# With all post-boot grace periods forced to expedited.\n\ttorture_bootargs=\"rcupdate.rcu_cpu_stall_suppress_at_boot=1 torture.disable_onoff_at_boot rcupdate.rcu_task_stall_timeout=30000 rcupdate.rcu_expedited=1\"\n\ttorture_set \"rcurttorture-exp\" tools/testing/selftests/rcutorture/bin/kvm.sh --allcpus --duration \"$duration_rcutorture\" --configs \"TREE03\" --trust-make\nfi\n\nif test \"$do_srcu_lockdep\" = \"yes\"\nthen\n\techo \" --- do-srcu-lockdep:\" Start `date` | tee -a $T/log\n\ttools/testing/selftests/rcutorture/bin/srcu_lockdep.sh --datestamp \"$ds/results-srcu-lockdep\" > $T/srcu_lockdep.sh.out 2>&1\n\tretcode=$?\n\tcp $T/srcu_lockdep.sh.out \"tools/testing/selftests/rcutorture/res/$ds/results-srcu-lockdep/log\"\n\tif test \"$retcode\" -eq 0\n\tthen\n\t\techo \"srcu_lockdep($retcode)\" \"tools/testing/selftests/rcutorture/res/$ds/results-srcu-lockdep\" >> $T/successes\n\t\techo Success >> \"tools/testing/selftests/rcutorture/res/$ds/results-srcu-lockdep/log\"\n\telse\n\t\techo \"srcu_lockdep($retcode)\" \"tools/testing/selftests/rcutorture/res/$ds/results-srcu-lockdep\" >> $T/failures\n\t\techo \" --- srcu_lockdep Test Summary:\" >> \"tools/testing/selftests/rcutorture/res/$ds/results-srcu-lockdep/log\"\n\t\techo \" --- Summary: Exit code $retcode from srcu_lockdep.sh, see ds/results-srcu-lockdep\" >> \"tools/testing/selftests/rcutorture/res/$ds/results-srcu-lockdep/log\"\n\tfi\nfi\n\nif test \"$do_refscale\" = yes\nthen\n\tprimlist=\"`grep '\\.name[ \t]*=' kernel/rcu/refscale.c | sed -e 's/^[^\"]*\"//' -e 's/\".*$//'`\"\nelse\n\tprimlist=\nfi\nfirsttime=1\ndo_kasan_save=\"$do_kasan\"\ndo_kcsan_save=\"$do_kcsan\"\nfor prim in $primlist\ndo\n\tif test -n \"$firsttime\"\n\tthen\n\t\ttorture_bootargs=\"refscale.scale_type=\"$prim\" refscale.nreaders=$HALF_ALLOTED_CPUS refscale.loops=10000 refscale.holdoff=20 torture.disable_onoff_at_boot\"\n\t\ttorture_set \"refscale-$prim\" tools/testing/selftests/rcutorture/bin/kvm.sh --torture refscale --allcpus --duration 5 --kconfig \"CONFIG_TASKS_TRACE_RCU=y CONFIG_NR_CPUS=$HALF_ALLOTED_CPUS\" --bootargs \"verbose_batched=$VERBOSE_BATCH_CPUS torture.verbose_sleep_frequency=8 torture.verbose_sleep_duration=$VERBOSE_BATCH_CPUS\" --trust-make\n\t\tmv $T/last-resdir-nodebug $T/first-resdir-nodebug || :\n\t\tif test -f \"$T/last-resdir-kasan\"\n\t\tthen\n\t\t\tmv $T/last-resdir-kasan $T/first-resdir-kasan || :\n\t\tfi\n\t\tif test -f \"$T/last-resdir-kcsan\"\n\t\tthen\n\t\t\tmv $T/last-resdir-kcsan $T/first-resdir-kcsan || :\n\t\tfi\n\t\tfirsttime=\n\t\tdo_kasan=\n\t\tdo_kcsan=\n\telse\n\t\ttorture_bootargs=\n\t\tfor i in $T/first-resdir-*\n\t\tdo\n\t\t\tcase \"$i\" in\n\t\t\t*-nodebug)\n\t\t\t\ttorture_suffix=\n\t\t\t\t;;\n\t\t\t*-kasan)\n\t\t\t\ttorture_suffix=\"-kasan\"\n\t\t\t\t;;\n\t\t\t*-kcsan)\n\t\t\t\ttorture_suffix=\"-kcsan\"\n\t\t\t\t;;\n\t\t\tesac\n\t\t\ttorture_set \"refscale-$prim$torture_suffix\" tools/testing/selftests/rcutorture/bin/kvm-again.sh \"`cat \"$i\"`\" --duration 5 --bootargs \"refscale.scale_type=$prim\"\n\t\tdone\n\tfi\ndone\ndo_kasan=\"$do_kasan_save\"\ndo_kcsan=\"$do_kcsan_save\"\n\nif test \"$do_rcuscale\" = yes\nthen\n\tprimlist=\"`grep '\\.name[ \t]*=' kernel/rcu/rcuscale.c | sed -e 's/^[^\"]*\"//' -e 's/\".*$//'`\"\nelse\n\tprimlist=\nfi\nfirsttime=1\ndo_kasan_save=\"$do_kasan\"\ndo_kcsan_save=\"$do_kcsan\"\nfor prim in $primlist\ndo\n\tif test -n \"$firsttime\"\n\tthen\n\t\ttorture_bootargs=\"rcuscale.scale_type=\"$prim\" rcuscale.nwriters=$HALF_ALLOTED_CPUS rcuscale.holdoff=20 torture.disable_onoff_at_boot\"\n\t\ttorture_set \"rcuscale-$prim\" tools/testing/selftests/rcutorture/bin/kvm.sh --torture rcuscale --allcpus --duration 5 --kconfig \"CONFIG_TASKS_TRACE_RCU=y CONFIG_NR_CPUS=$HALF_ALLOTED_CPUS\" --trust-make\n\t\tmv $T/last-resdir-nodebug $T/first-resdir-nodebug || :\n\t\tif test -f \"$T/last-resdir-kasan\"\n\t\tthen\n\t\t\tmv $T/last-resdir-kasan $T/first-resdir-kasan || :\n\t\tfi\n\t\tif test -f \"$T/last-resdir-kcsan\"\n\t\tthen\n\t\t\tmv $T/last-resdir-kcsan $T/first-resdir-kcsan || :\n\t\tfi\n\t\tfirsttime=\n\t\tdo_kasan=\n\t\tdo_kcsan=\n\telse\n\t\ttorture_bootargs=\n\t\tfor i in $T/first-resdir-*\n\t\tdo\n\t\t\tcase \"$i\" in\n\t\t\t*-nodebug)\n\t\t\t\ttorture_suffix=\n\t\t\t\t;;\n\t\t\t*-kasan)\n\t\t\t\ttorture_suffix=\"-kasan\"\n\t\t\t\t;;\n\t\t\t*-kcsan)\n\t\t\t\ttorture_suffix=\"-kcsan\"\n\t\t\t\t;;\n\t\t\tesac\n\t\t\ttorture_set \"rcuscale-$prim$torture_suffix\" tools/testing/selftests/rcutorture/bin/kvm-again.sh \"`cat \"$i\"`\" --duration 5 --bootargs \"rcuscale.scale_type=$prim\"\n\t\tdone\n\tfi\ndone\ndo_kasan=\"$do_kasan_save\"\ndo_kcsan=\"$do_kcsan_save\"\n\nif test \"$do_kvfree\" = \"yes\"\nthen\n\ttorture_bootargs=\"rcuscale.kfree_rcu_test=1 rcuscale.kfree_nthreads=16 rcuscale.holdoff=20 rcuscale.kfree_loops=10000 torture.disable_onoff_at_boot\"\n\ttorture_set \"rcuscale-kvfree\" tools/testing/selftests/rcutorture/bin/kvm.sh --torture rcuscale --allcpus --duration 10 --kconfig \"CONFIG_NR_CPUS=$HALF_ALLOTED_CPUS\" --memory 2G --trust-make\nfi\n\nif test \"$do_clocksourcewd\" = \"yes\"\nthen\n\ttorture_bootargs=\"rcupdate.rcu_cpu_stall_suppress_at_boot=1 torture.disable_onoff_at_boot rcupdate.rcu_task_stall_timeout=30000 tsc=watchdog\"\n\ttorture_set \"clocksourcewd-1\" tools/testing/selftests/rcutorture/bin/kvm.sh --allcpus --duration 45s --configs TREE03 --kconfig \"CONFIG_TEST_CLOCKSOURCE_WATCHDOG=y\" --trust-make\n\n\ttorture_bootargs=\"rcupdate.rcu_cpu_stall_suppress_at_boot=1 torture.disable_onoff_at_boot rcupdate.rcu_task_stall_timeout=30000 clocksource.max_cswd_read_retries=1 tsc=watchdog\"\n\ttorture_set \"clocksourcewd-2\" tools/testing/selftests/rcutorture/bin/kvm.sh --allcpus --duration 45s --configs TREE03 --kconfig \"CONFIG_TEST_CLOCKSOURCE_WATCHDOG=y\" --trust-make\n\n\t# In case our work is already done...\n\tif test \"$do_rcutorture\" != \"yes\"\n\tthen\n\t\ttorture_bootargs=\"rcupdate.rcu_cpu_stall_suppress_at_boot=1 torture.disable_onoff_at_boot rcupdate.rcu_task_stall_timeout=30000 tsc=watchdog\"\n\t\ttorture_set \"clocksourcewd-3\" tools/testing/selftests/rcutorture/bin/kvm.sh --allcpus --duration 45s --configs TREE03 --trust-make\n\tfi\nfi\n\necho \" --- \" $scriptname $args\necho \" --- \" Done `date` | tee -a $T/log\nret=0\nnsuccesses=0\necho SUCCESSES: | tee -a $T/log\nif test -s \"$T/successes\"\nthen\n\tcat \"$T/successes\" | tee -a $T/log\n\tnsuccesses=\"`wc -l \"$T/successes\" | awk '{ print $1 }'`\"\nfi\nnfailures=0\necho FAILURES: | tee -a $T/log\nif test -s \"$T/failures\"\nthen\n\tawk < \"$T/failures\" -v sq=\"'\" '{ print \"echo \" sq $0 sq; print \"sed -e \" sq \"1,/^ --- .* Test summary:$/d\" sq \" \" $2 \"/log | grep Summary: | sed -e \" sq \"s/^[^S]*/  /\" sq; }' | sh | tee -a $T/log | tee \"$T/failuresum\"\n\tnfailures=\"`wc -l \"$T/failures\" | awk '{ print $1 }'`\"\n\tgrep \"^  Summary: \" \"$T/failuresum\" |\n\t\tgrep -v '^  Summary: Bugs: [0-9]* (all bugs kcsan)$' > \"$T/nonkcsan\"\n\tif test -s \"$T/nonkcsan\"\n\tthen\n\t\tnonkcsanbug=\"yes\"\n\tfi\n\tret=2\nfi\nif test \"$do_kcsan\" = \"yes\"\nthen\n\tTORTURE_KCONFIG_KCSAN_ARG=1 tools/testing/selftests/rcutorture/bin/kcsan-collapse.sh tools/testing/selftests/rcutorture/res/$ds > tools/testing/selftests/rcutorture/res/$ds/kcsan.sum\nfi\necho Started at $startdate, ended at `date`, duration `get_starttime_duration $starttime`. | tee -a $T/log\necho Summary: Successes: $nsuccesses Failures: $nfailures. | tee -a $T/log\ntdir=\"`cat $T/successes $T/failures | head -1 | awk '{ print $NF }' | sed -e 's,/[^/]\\+/*$,,'`\"\nfind \"$tdir\" -name 'ConfigFragment.diags' -print > $T/configerrors\nfind \"$tdir\" -name 'Make.out.diags' -print > $T/builderrors\nif test -s \"$T/configerrors\"\nthen\n\techo \"  Scenarios with .config errors: `wc -l \"$T/configerrors\" | awk '{ print $1 }'`\"\n\tnonkcsanbug=\"yes\"\nfi\nif test -s \"$T/builderrors\"\nthen\n\techo \"  Scenarios with build errors: `wc -l \"$T/builderrors\" | awk '{ print $1 }'`\"\n\tnonkcsanbug=\"yes\"\nfi\nif test -z \"$nonkcsanbug\" && test -s \"$T/failuresum\"\nthen\n\techo \"  All bugs were KCSAN failures.\"\nfi\nif test -n \"$tdir\" && test $compress_concurrency -gt 0\nthen\n\t# KASAN vmlinux files can approach 1GB in size, so compress them.\n\techo Looking for K[AC]SAN files to compress: `date` > \"$tdir/log-xz\" 2>&1\n\tfind \"$tdir\" -type d -name '*-k[ac]san' -print > $T/xz-todo-all\n\tfind \"$tdir\" -type f -name 're-run' -print | sed -e 's,/re-run,,' |\n\t\tgrep -e '-k[ac]san$' > $T/xz-todo-copy\n\tsort $T/xz-todo-all $T/xz-todo-copy | uniq -u > $T/xz-todo\n\tncompresses=0\n\tbatchno=1\n\tif test -s $T/xz-todo\n\tthen\n\t\tfor i in `cat $T/xz-todo`\n\t\tdo\n\t\t\tfind $i -name 'vmlinux*' -print\n\t\tdone | wc -l | awk '{ print $1 }' > $T/xz-todo-count\n\t\tn2compress=\"`cat $T/xz-todo-count`\"\n\t\techo Size before compressing $n2compress files: `du -sh $tdir | awk '{ print $1 }'` `date` 2>&1 | tee -a \"$tdir/log-xz\" | tee -a $T/log\n\t\tfor i in `cat $T/xz-todo`\n\t\tdo\n\t\t\techo Compressing vmlinux files in ${i}: `date` >> \"$tdir/log-xz\" 2>&1\n\t\t\tfor j in $i/*/vmlinux\n\t\t\tdo\n\t\t\t\txz \"$j\" >> \"$tdir/log-xz\" 2>&1 &\n\t\t\t\tncompresses=$((ncompresses+1))\n\t\t\t\tif test $ncompresses -ge $compress_concurrency\n\t\t\t\tthen\n\t\t\t\t\techo Waiting for batch $batchno of $ncompresses compressions `date` | tee -a \"$tdir/log-xz\" | tee -a $T/log\n\t\t\t\t\twait\n\t\t\t\t\tncompresses=0\n\t\t\t\t\tbatchno=$((batchno+1))\n\t\t\t\tfi\n\t\t\tdone\n\t\tdone\n\t\tif test $ncompresses -gt 0\n\t\tthen\n\t\t\techo Waiting for final batch $batchno of $ncompresses compressions `date` | tee -a \"$tdir/log-xz\" | tee -a $T/log\n\t\tfi\n\t\twait\n\t\tif test -s $T/xz-todo-copy\n\t\tthen\n\t\t\t# The trick here is that we need corresponding\n\t\t\t# vmlinux files from corresponding scenarios.\n\t\t\techo Linking vmlinux.xz files to re-use scenarios `date` | tee -a \"$tdir/log-xz\" | tee -a $T/log\n\t\t\tdirstash=\"`pwd`\"\n\t\t\tfor i in `cat $T/xz-todo-copy`\n\t\t\tdo\n\t\t\t\tcd $i\n\t\t\t\tfind . -name vmlinux -print > $T/xz-todo-copy-vmlinux\n\t\t\t\tfor v in `cat $T/xz-todo-copy-vmlinux`\n\t\t\t\tdo\n\t\t\t\t\trm -f \"$v\"\n\t\t\t\t\tcp -l `cat $i/re-run`/\"$i/$v\".xz \"`dirname \"$v\"`\"\n\t\t\t\tdone\n\t\t\t\tcd \"$dirstash\"\n\t\t\tdone\n\t\tfi\n\t\techo Size after compressing $n2compress files: `du -sh $tdir | awk '{ print $1 }'` `date` 2>&1 | tee -a \"$tdir/log-xz\" | tee -a $T/log\n\t\techo Total duration `get_starttime_duration $starttime`. | tee -a $T/log\n\telse\n\t\techo No compression needed: `date` >> \"$tdir/log-xz\" 2>&1\n\tfi\nfi\nif test -n \"$tdir\"\nthen\n\tcp $T/log \"$tdir\"\nfi\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}