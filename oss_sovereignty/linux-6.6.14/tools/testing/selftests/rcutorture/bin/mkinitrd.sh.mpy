{
  "module_name": "mkinitrd.sh",
  "hash_id": "50d4a8524295fc1072fdd83aecd35a1de4d5fea4a555774e9d2ef9dfe4781b8f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rcutorture/bin/mkinitrd.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Create an initrd directory if one does not already exist.\n#\n# Copyright (C) IBM Corporation, 2013\n#\n# Author: Connor Shu <Connor.Shu@ibm.com>\n\nD=tools/testing/selftests/rcutorture\n\n# Prerequisite checks\nif [ ! -d \"$D\" ]; then\n    echo >&2 \"$D does not exist: Malformed kernel source tree?\"\n    exit 1\nfi\nif [ -s \"$D/initrd/init\" ]; then\n    echo \"$D/initrd/init already exists, no need to create it\"\n    exit 0\nfi\n\n# Create a C-language initrd/init infinite-loop program and statically\n# link it.  This results in a very small initrd.\necho \"Creating a statically linked C-language initrd\"\ncd $D\nmkdir -p initrd\ncd initrd\ncat > init.c << '___EOF___'\n#ifndef NOLIBC\n#include <unistd.h>\n#include <sys/time.h>\n#endif\n\nvolatile unsigned long delaycount;\n\nint main(int argc, char *argv[])\n{\n\tint i;\n\tstruct timeval tv;\n\tstruct timeval tvb;\n\n\tprintf(\"Torture-test rudimentary init program started, command line:\\n\");\n\tfor (i = 0; i < argc; i++)\n\t\tprintf(\" %s\", argv[i]);\n\tprintf(\"\\n\");\n\tfor (;;) {\n\t\tsleep(1);\n\t\t/* Need some userspace time. */\n\t\tif (gettimeofday(&tvb, NULL))\n\t\t\tcontinue;\n\t\tdo {\n\t\t\tfor (i = 0; i < 1000 * 100; i++)\n\t\t\t\tdelaycount = i * i;\n\t\t\tif (gettimeofday(&tv, NULL))\n\t\t\t\tbreak;\n\t\t\ttv.tv_sec -= tvb.tv_sec;\n\t\t\tif (tv.tv_sec > 1)\n\t\t\t\tbreak;\n\t\t\ttv.tv_usec += tv.tv_sec * 1000 * 1000;\n\t\t\ttv.tv_usec -= tvb.tv_usec;\n\t\t} while (tv.tv_usec < 1000);\n\t}\n\treturn 0;\n}\n___EOF___\n\n# build using nolibc on supported archs (smaller executable) and fall\n# back to regular glibc on other ones.\nif echo -e \"#if __x86_64__||__i386__||__i486__||__i586__||__i686__\" \\\n\t   \"||__ARM_EABI__||__aarch64__||__s390x__||__loongarch__\\nyes\\n#endif\" \\\n   | ${CROSS_COMPILE}gcc -E -nostdlib -xc - \\\n   | grep -q '^yes'; then\n\t# architecture supported by nolibc\n        ${CROSS_COMPILE}gcc -fno-asynchronous-unwind-tables -fno-ident \\\n\t\t-nostdlib -include ../../../../include/nolibc/nolibc.h \\\n\t\t-s -static -Os -o init init.c -lgcc\n\tret=$?\nelse\n\t${CROSS_COMPILE}gcc -s -static -Os -o init init.c\n\tret=$?\nfi\n\nif [ \"$ret\" -ne 0 ]\nthen\n\techo \"Failed to create a statically linked C-language initrd\"\n\texit \"$ret\"\nfi\n\nrm init.c\necho \"Done creating a statically linked C-language initrd\"\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}