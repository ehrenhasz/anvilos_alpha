{
  "module_name": "kvm-test-1-run.sh",
  "hash_id": "da24d180cfdc8d9e88d3b5c1c2995a8f65b67b3480ea6880e6188cddca1aa91a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/rcutorture/bin/kvm-test-1-run.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Run a kvm-based test of the specified tree on the specified configs.\n# Fully automated run and error checking, no graphics console.\n#\n# Execute this in the source tree.  Do not run it as a background task\n# because qemu does not seem to like that much.\n#\n# Usage: kvm-test-1-run.sh config resdir seconds qemu-args boot_args_in\n#\n# qemu-args defaults to \"-enable-kvm -display none -no-reboot\", along\n#\t\t\twith arguments specifying the number of CPUs\n#\t\t\tand other options generated from the underlying\n#\t\t\tCPU architecture.\n# boot_args_in defaults to value returned by the per_version_boot_params\n#\t\t\tshell function.\n#\n# Anything you specify for either qemu-args or boot_args_in is appended to\n# the default values.  The \"-smp\" value is deduced from the contents of\n# the config fragment.\n#\n# More sophisticated argument parsing is clearly needed.\n#\n# Copyright (C) IBM Corporation, 2011\n#\n# Authors: Paul E. McKenney <paulmck@linux.ibm.com>\n\nT=\"`mktemp -d ${TMPDIR-/tmp}/kvm-test-1-run.sh.XXXXXX`\"\ntrap 'rm -rf $T' 0\n\n. functions.sh\n. $CONFIGFRAG/ver_functions.sh\n\nconfig_template=${1}\nconfig_dir=`echo $config_template | sed -e 's,/[^/]*$,,'`\ntitle=`echo $config_template | sed -e 's/^.*\\///'`\nresdir=${2}\nif test -z \"$resdir\" -o ! -d \"$resdir\" -o ! -w \"$resdir\"\nthen\n\techo \"kvm-test-1-run.sh :$resdir: Not a writable directory, cannot store results into it\"\n\texit 1\nfi\necho ' ---' `date`: Starting build, PID $$\necho ' ---' Kconfig fragment at: $config_template >> $resdir/log\ntouch $resdir/ConfigFragment.input\n\n# Combine additional Kconfig options into an existing set such that\n# newer options win.  The first argument is the Kconfig source ID, the\n# second the to-be-updated file within $T, and the third and final the\n# list of additional Kconfig options.  Note that a $2.tmp file is\n# created when doing the update.\nconfig_override_param () {\n\tif test -n \"$3\"\n\tthen\n\t\techo $3 | sed -e 's/^ *//' -e 's/ *$//' | tr -s \" \" \"\\012\" > $T/Kconfig_args\n\t\techo \" --- $1\" >> $resdir/ConfigFragment.input\n\t\tcat $T/Kconfig_args >> $resdir/ConfigFragment.input\n\t\tconfig_override.sh $T/$2 $T/Kconfig_args > $T/$2.tmp\n\t\tmv $T/$2.tmp $T/$2\n\tfi\n}\n\necho > $T/KcList\nconfig_override_param \"$config_dir/CFcommon\" KcList \"`cat $config_dir/CFcommon 2> /dev/null`\"\nconfig_override_param \"$config_template\" KcList \"`cat $config_template 2> /dev/null`\"\nconfig_override_param \"--gdb options\" KcList \"$TORTURE_KCONFIG_GDB_ARG\"\nconfig_override_param \"--kasan options\" KcList \"$TORTURE_KCONFIG_KASAN_ARG\"\nconfig_override_param \"--kcsan options\" KcList \"$TORTURE_KCONFIG_KCSAN_ARG\"\nconfig_override_param \"--kconfig argument\" KcList \"$TORTURE_KCONFIG_ARG\"\ncp $T/KcList $resdir/ConfigFragment\n\nbase_resdir=`echo $resdir | sed -e 's/\\.[0-9]\\+$//'`\nif test \"$base_resdir\" != \"$resdir\" && test -f $base_resdir/bzImage && test -f $base_resdir/vmlinux\nthen\n\t# Rerunning previous test, so use that test's kernel.\n\tQEMU=\"`identify_qemu $base_resdir/vmlinux`\"\n\tBOOT_IMAGE=\"`identify_boot_image $QEMU`\"\n\tKERNEL=$base_resdir/${BOOT_IMAGE##*/} # use the last component of ${BOOT_IMAGE}\n\tln -s $base_resdir/Make*.out $resdir  # for kvm-recheck.sh\n\tln -s $base_resdir/.config $resdir  # for kvm-recheck.sh\n\t# Arch-independent indicator\n\ttouch $resdir/builtkernel\nelif test \"$base_resdir\" != \"$resdir\"\nthen\n\t# Rerunning previous test for which build failed\n\tln -s $base_resdir/Make*.out $resdir  # for kvm-recheck.sh\n\tln -s $base_resdir/.config $resdir  # for kvm-recheck.sh\n\techo Initial build failed, not running KVM, see $resdir.\n\tif test -f $resdir/build.wait\n\tthen\n\t\tmv $resdir/build.wait $resdir/build.ready\n\tfi\n\texit 1\nelif kvm-build.sh $T/KcList $resdir\nthen\n\t# Had to build a kernel for this test.\n\tQEMU=\"`identify_qemu vmlinux`\"\n\tBOOT_IMAGE=\"`identify_boot_image $QEMU`\"\n\tcp vmlinux $resdir\n\tcp .config $resdir\n\tcp Module.symvers $resdir > /dev/null || :\n\tcp System.map $resdir > /dev/null || :\n\tif test -n \"$BOOT_IMAGE\"\n\tthen\n\t\tcp $BOOT_IMAGE $resdir\n\t\tKERNEL=$resdir/${BOOT_IMAGE##*/}\n\t\t# Arch-independent indicator\n\t\ttouch $resdir/builtkernel\n\telse\n\t\techo No identifiable boot image, not running KVM, see $resdir.\n\t\techo Do the torture scripts know about your architecture?\n\tfi\n\tparse-build.sh $resdir/Make.out $title\nelse\n\t# Build failed.\n\tcp .config $resdir || :\n\techo Build failed, not running KVM, see $resdir.\n\tif test -f $resdir/build.wait\n\tthen\n\t\tmv $resdir/build.wait $resdir/build.ready\n\tfi\n\texit 1\nfi\nif test -f $resdir/build.wait\nthen\n\tmv $resdir/build.wait $resdir/build.ready\nfi\nwhile test -f $resdir/build.ready\ndo\n\tsleep 1\ndone\nseconds=$3\nqemu_args=$4\nboot_args_in=$5\n\nif test -z \"$TORTURE_BUILDONLY\"\nthen\n\techo ' ---' `date`: Starting kernel\nfi\n\n# Generate -smp qemu argument.\nqemu_args=\"-enable-kvm -display none -no-reboot $qemu_args\"\ncpu_count=`configNR_CPUS.sh $resdir/ConfigFragment`\ncpu_count=`configfrag_boot_cpus \"$boot_args_in\" \"$config_template\" \"$cpu_count\"`\nif test \"$cpu_count\" -gt \"$TORTURE_ALLOTED_CPUS\"\nthen\n\techo CPU count limited from $cpu_count to $TORTURE_ALLOTED_CPUS | tee -a $resdir/Warnings\n\tcpu_count=$TORTURE_ALLOTED_CPUS\nfi\nqemu_args=\"`specify_qemu_cpus \"$QEMU\" \"$qemu_args\" \"$cpu_count\"`\"\nqemu_args=\"`specify_qemu_net \"$qemu_args\"`\"\n\n# Generate architecture-specific and interaction-specific qemu arguments\nqemu_args=\"$qemu_args `identify_qemu_args \"$QEMU\" \"$resdir/console.log\"`\"\n\n# Generate qemu -append arguments\nqemu_append=\"`identify_qemu_append \"$QEMU\"`\"\n\n# Pull in Kconfig-fragment boot parameters\nboot_args=\"`configfrag_boot_params \"$boot_args_in\" \"$config_template\"`\"\n# Generate kernel-version-specific boot parameters\nboot_args=\"`per_version_boot_params \"$boot_args\" $resdir/.config $seconds`\"\nif test -n \"$TORTURE_BOOT_GDB_ARG\"\nthen\n\tboot_args=\"$TORTURE_BOOT_GDB_ARG $boot_args\"\nfi\n\n# Give bare-metal advice\nmodprobe_args=\"`echo $boot_args | tr -s ' ' '\\012' | grep \"^$TORTURE_MOD\\.\" | sed -e \"s/$TORTURE_MOD\\.//g\"`\"\nkboot_args=\"`echo $boot_args | tr -s ' ' '\\012' | grep -v \"^$TORTURE_MOD\\.\"`\"\ntestid_txt=\"`dirname $resdir`/testid.txt\"\ntouch $resdir/bare-metal\necho To run this scenario on bare metal: >> $resdir/bare-metal\necho >> $resdir/bare-metal\necho \" 1.\" Set your bare-metal build tree to the state shown in this file: >> $resdir/bare-metal\necho \"   \" $testid_txt >> $resdir/bare-metal\necho \" 2.\" Update your bare-metal build tree\"'\"s .config based on this file: >> $resdir/bare-metal\necho \"   \" $resdir/ConfigFragment >> $resdir/bare-metal\necho \" 3.\" Make the bare-metal kernel\"'\"s build system aware of your .config updates: >> $resdir/bare-metal\necho \"   \" $ 'yes \"\" | make oldconfig' >> $resdir/bare-metal\necho \" 4.\" Build your bare-metal kernel. >> $resdir/bare-metal\necho \" 5.\" Boot your bare-metal kernel with the following parameters: >> $resdir/bare-metal\necho \"   \" $kboot_args >> $resdir/bare-metal\necho \" 6.\" Start the test with the following command: >> $resdir/bare-metal\necho \"   \" $ modprobe $TORTURE_MOD $modprobe_args >> $resdir/bare-metal\necho \" 7.\" After some time, end the test with the following command: >> $resdir/bare-metal\necho \"   \" $ rmmod $TORTURE_MOD >> $resdir/bare-metal\necho \" 8.\" Copy your bare-metal kernel\"'\"s .config file, overwriting this file: >> $resdir/bare-metal\necho \"   \" $resdir/.config >> $resdir/bare-metal\necho \" 9.\" Copy the console output from just before the modprobe to just after >> $resdir/bare-metal\necho \"   \" the rmmod into this file: >> $resdir/bare-metal\necho \"   \" $resdir/console.log >> $resdir/bare-metal\necho \"10.\" Check for runtime errors using the following command: >> $resdir/bare-metal\necho \"   \" $ tools/testing/selftests/rcutorture/bin/kvm-recheck.sh `dirname $resdir` >> $resdir/bare-metal\necho >> $resdir/bare-metal\necho Some of the above steps may be skipped if you build your bare-metal >> $resdir/bare-metal\necho kernel here: `head -n 1 $testid_txt | sed -e 's/^Build directory: //'`  >> $resdir/bare-metal\n\necho $QEMU $qemu_args -m $TORTURE_QEMU_MEM -kernel $KERNEL -append \\\"$qemu_append $boot_args\\\" $TORTURE_QEMU_GDB_ARG > $resdir/qemu-cmd\necho \"# TORTURE_SHUTDOWN_GRACE=$TORTURE_SHUTDOWN_GRACE\" >> $resdir/qemu-cmd\necho \"# seconds=$seconds\" >> $resdir/qemu-cmd\necho \"# TORTURE_KCONFIG_GDB_ARG=\\\"$TORTURE_KCONFIG_GDB_ARG\\\"\" >> $resdir/qemu-cmd\necho \"# TORTURE_JITTER_START=\\\"$TORTURE_JITTER_START\\\"\" >> $resdir/qemu-cmd\necho \"# TORTURE_JITTER_STOP=\\\"$TORTURE_JITTER_STOP\\\"\" >> $resdir/qemu-cmd\necho \"# TORTURE_TRUST_MAKE=\\\"$TORTURE_TRUST_MAKE\\\"; export TORTURE_TRUST_MAKE\" >> $resdir/qemu-cmd\necho \"# TORTURE_CPU_COUNT=$cpu_count\" >> $resdir/qemu-cmd\n\nif test -n \"$TORTURE_BUILDONLY\"\nthen\n\techo Build-only run specified, boot/test omitted.\n\ttouch $resdir/buildonly\n\texit 0\nfi\n\nkvm-test-1-run-qemu.sh $resdir\nparse-console.sh $resdir/console.log $title\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}