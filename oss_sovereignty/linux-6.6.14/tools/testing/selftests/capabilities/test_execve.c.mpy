{
  "module_name": "test_execve.c",
  "hash_id": "fb9071ee11ae4e2405fb7fa0e7ca8422fceef79b0bf8b66e7eb46e26566119ff",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/capabilities/test_execve.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n\n#include <cap-ng.h>\n#include <linux/capability.h>\n#include <stdbool.h>\n#include <string.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <stdarg.h>\n#include <sched.h>\n#include <sys/mount.h>\n#include <limits.h>\n#include <libgen.h>\n#include <malloc.h>\n#include <sys/wait.h>\n#include <sys/prctl.h>\n#include <sys/stat.h>\n\n#include \"../kselftest.h\"\n\n#ifndef PR_CAP_AMBIENT\n#define PR_CAP_AMBIENT\t\t\t47\n# define PR_CAP_AMBIENT_IS_SET\t\t1\n# define PR_CAP_AMBIENT_RAISE\t\t2\n# define PR_CAP_AMBIENT_LOWER\t\t3\n# define PR_CAP_AMBIENT_CLEAR_ALL\t4\n#endif\n\nstatic int nerrs;\nstatic pid_t mpid;\t \n\nstatic void vmaybe_write_file(bool enoent_ok, char *filename, char *fmt, va_list ap)\n{\n\tchar buf[4096];\n\tint fd;\n\tssize_t written;\n\tint buf_len;\n\n\tbuf_len = vsnprintf(buf, sizeof(buf), fmt, ap);\n\tif (buf_len < 0)\n\t\tksft_exit_fail_msg(\"vsnprintf failed - %s\\n\", strerror(errno));\n\n\tif (buf_len >= sizeof(buf))\n\t\tksft_exit_fail_msg(\"vsnprintf output truncated\\n\");\n\n\n\tfd = open(filename, O_WRONLY);\n\tif (fd < 0) {\n\t\tif ((errno == ENOENT) && enoent_ok)\n\t\t\treturn;\n\t\tksft_exit_fail_msg(\"open of %s failed - %s\\n\",\n\t\t\t\t\tfilename, strerror(errno));\n\t}\n\twritten = write(fd, buf, buf_len);\n\tif (written != buf_len) {\n\t\tif (written >= 0) {\n\t\t\tksft_exit_fail_msg(\"short write to %s\\n\", filename);\n\t\t} else {\n\t\t\tksft_exit_fail_msg(\"write to %s failed - %s\\n\",\n\t\t\t\t\t\tfilename, strerror(errno));\n\t\t}\n\t}\n\tif (close(fd) != 0) {\n\t\tksft_exit_fail_msg(\"close of %s failed - %s\\n\",\n\t\t\t\t\tfilename, strerror(errno));\n\t}\n}\n\nstatic void maybe_write_file(char *filename, char *fmt, ...)\n{\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tvmaybe_write_file(true, filename, fmt, ap);\n\tva_end(ap);\n}\n\nstatic void write_file(char *filename, char *fmt, ...)\n{\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tvmaybe_write_file(false, filename, fmt, ap);\n\tva_end(ap);\n}\n\nstatic bool create_and_enter_ns(uid_t inner_uid)\n{\n\tuid_t outer_uid;\n\tgid_t outer_gid;\n\tint i;\n\tbool have_outer_privilege;\n\n\touter_uid = getuid();\n\touter_gid = getgid();\n\n\t \n\n\tif (unshare(CLONE_NEWNS) == 0) {\n\t\tksft_print_msg(\"[NOTE]\\tUsing global UIDs for tests\\n\");\n\t\tif (prctl(PR_SET_KEEPCAPS, 1, 0, 0, 0) != 0)\n\t\t\tksft_exit_fail_msg(\"PR_SET_KEEPCAPS - %s\\n\",\n\t\t\t\t\t\tstrerror(errno));\n\t\tif (setresuid(inner_uid, inner_uid, -1) != 0)\n\t\t\tksft_exit_fail_msg(\"setresuid - %s\\n\", strerror(errno));\n\n\t\t \n\t\tcapng_get_caps_process();\n\t\tfor (i = 0; i < CAP_LAST_CAP; i++)\n\t\t\tif (capng_have_capability(CAPNG_PERMITTED, i))\n\t\t\t\tcapng_update(CAPNG_ADD, CAPNG_EFFECTIVE, i);\n\t\tif (capng_apply(CAPNG_SELECT_CAPS) != 0)\n\t\t\tksft_exit_fail_msg(\n\t\t\t\t\t\"capng_apply - %s\\n\", strerror(errno));\n\n\t\thave_outer_privilege = true;\n\t} else if (unshare(CLONE_NEWUSER | CLONE_NEWNS) == 0) {\n\t\tksft_print_msg(\"[NOTE]\\tUsing a user namespace for tests\\n\");\n\t\tmaybe_write_file(\"/proc/self/setgroups\", \"deny\");\n\t\twrite_file(\"/proc/self/uid_map\", \"%d %d 1\", inner_uid, outer_uid);\n\t\twrite_file(\"/proc/self/gid_map\", \"0 %d 1\", outer_gid);\n\n\t\thave_outer_privilege = false;\n\t} else {\n\t\tksft_exit_skip(\"must be root or be able to create a userns\\n\");\n\t}\n\n\tif (mount(\"none\", \"/\", NULL, MS_REC | MS_PRIVATE, NULL) != 0)\n\t\tksft_exit_fail_msg(\"remount everything private - %s\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\treturn have_outer_privilege;\n}\n\nstatic void chdir_to_tmpfs(void)\n{\n\tchar cwd[PATH_MAX];\n\tif (getcwd(cwd, sizeof(cwd)) != cwd)\n\t\tksft_exit_fail_msg(\"getcwd - %s\\n\", strerror(errno));\n\n\tif (mount(\"private_tmp\", \".\", \"tmpfs\", 0, \"mode=0777\") != 0)\n\t\tksft_exit_fail_msg(\"mount private tmpfs - %s\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\tif (chdir(cwd) != 0)\n\t\tksft_exit_fail_msg(\"chdir to private tmpfs - %s\\n\",\n\t\t\t\t\tstrerror(errno));\n}\n\nstatic void copy_fromat_to(int fromfd, const char *fromname, const char *toname)\n{\n\tint from = openat(fromfd, fromname, O_RDONLY);\n\tif (from == -1)\n\t\tksft_exit_fail_msg(\"open copy source - %s\\n\", strerror(errno));\n\n\tint to = open(toname, O_CREAT | O_WRONLY | O_EXCL, 0700);\n\n\twhile (true) {\n\t\tchar buf[4096];\n\t\tssize_t sz = read(from, buf, sizeof(buf));\n\t\tif (sz == 0)\n\t\t\tbreak;\n\t\tif (sz < 0)\n\t\t\tksft_exit_fail_msg(\"read - %s\\n\", strerror(errno));\n\n\t\tif (write(to, buf, sz) != sz)\n\t\t\t \n\t\t\tksft_exit_fail_msg(\"write - %s\\n\", strerror(errno));\n\t}\n\n\tclose(from);\n\tclose(to);\n}\n\nstatic bool fork_wait(void)\n{\n\tpid_t child = fork();\n\tif (child == 0) {\n\t\tnerrs = 0;\n\t\treturn true;\n\t} else if (child > 0) {\n\t\tint status;\n\t\tif (waitpid(child, &status, 0) != child ||\n\t\t    !WIFEXITED(status)) {\n\t\t\tksft_print_msg(\"Child died\\n\");\n\t\t\tnerrs++;\n\t\t} else if (WEXITSTATUS(status) != 0) {\n\t\t\tksft_print_msg(\"Child failed\\n\");\n\t\t\tnerrs++;\n\t\t} else {\n\t\t\t \n\t\t\tif (getpid() != mpid)\n\t\t\t\tksft_test_result_pass(\"Passed\\n\");\n\t\t}\n\t\treturn false;\n\t} else {\n\t\tksft_exit_fail_msg(\"fork - %s\\n\", strerror(errno));\n\t\treturn false;\n\t}\n}\n\nstatic void exec_other_validate_cap(const char *name,\n\t\t\t\t    bool eff, bool perm, bool inh, bool ambient)\n{\n\texecl(name, name, (eff ? \"1\" : \"0\"),\n\t      (perm ? \"1\" : \"0\"), (inh ? \"1\" : \"0\"), (ambient ? \"1\" : \"0\"),\n\t      NULL);\n\tksft_exit_fail_msg(\"execl - %s\\n\", strerror(errno));\n}\n\nstatic void exec_validate_cap(bool eff, bool perm, bool inh, bool ambient)\n{\n\texec_other_validate_cap(\"./validate_cap\", eff, perm, inh, ambient);\n}\n\nstatic int do_tests(int uid, const char *our_path)\n{\n\tbool have_outer_privilege = create_and_enter_ns(uid);\n\n\tint ourpath_fd = open(our_path, O_RDONLY | O_DIRECTORY);\n\tif (ourpath_fd == -1)\n\t\tksft_exit_fail_msg(\"open '%s' - %s\\n\",\n\t\t\t\t\tour_path, strerror(errno));\n\n\tchdir_to_tmpfs();\n\n\tcopy_fromat_to(ourpath_fd, \"validate_cap\", \"validate_cap\");\n\n\tif (have_outer_privilege) {\n\t\tuid_t gid = getegid();\n\n\t\tcopy_fromat_to(ourpath_fd, \"validate_cap\",\n\t\t\t       \"validate_cap_suidroot\");\n\t\tif (chown(\"validate_cap_suidroot\", 0, -1) != 0)\n\t\t\tksft_exit_fail_msg(\"chown - %s\\n\", strerror(errno));\n\t\tif (chmod(\"validate_cap_suidroot\", S_ISUID | 0700) != 0)\n\t\t\tksft_exit_fail_msg(\"chmod - %s\\n\", strerror(errno));\n\n\t\tcopy_fromat_to(ourpath_fd, \"validate_cap\",\n\t\t\t       \"validate_cap_suidnonroot\");\n\t\tif (chown(\"validate_cap_suidnonroot\", uid + 1, -1) != 0)\n\t\t\tksft_exit_fail_msg(\"chown - %s\\n\", strerror(errno));\n\t\tif (chmod(\"validate_cap_suidnonroot\", S_ISUID | 0700) != 0)\n\t\t\tksft_exit_fail_msg(\"chmod - %s\\n\", strerror(errno));\n\n\t\tcopy_fromat_to(ourpath_fd, \"validate_cap\",\n\t\t\t       \"validate_cap_sgidroot\");\n\t\tif (chown(\"validate_cap_sgidroot\", -1, 0) != 0)\n\t\t\tksft_exit_fail_msg(\"chown - %s\\n\", strerror(errno));\n\t\tif (chmod(\"validate_cap_sgidroot\", S_ISGID | 0710) != 0)\n\t\t\tksft_exit_fail_msg(\"chmod - %s\\n\", strerror(errno));\n\n\t\tcopy_fromat_to(ourpath_fd, \"validate_cap\",\n\t\t\t       \"validate_cap_sgidnonroot\");\n\t\tif (chown(\"validate_cap_sgidnonroot\", -1, gid + 1) != 0)\n\t\t\tksft_exit_fail_msg(\"chown - %s\\n\", strerror(errno));\n\t\tif (chmod(\"validate_cap_sgidnonroot\", S_ISGID | 0710) != 0)\n\t\t\tksft_exit_fail_msg(\"chmod - %s\\n\", strerror(errno));\n\t}\n\n\tcapng_get_caps_process();\n\n\t \n\tcapng_update(CAPNG_DROP, CAPNG_INHERITABLE, CAP_NET_BIND_SERVICE);\n\tif (capng_apply(CAPNG_SELECT_CAPS) != 0)\n\t\tksft_exit_fail_msg(\"capng_apply - %s\\n\", strerror(errno));\n\n\tif (uid == 0) {\n\t\tksft_print_msg(\"[RUN]\\tRoot => ep\\n\");\n\t\tif (fork_wait())\n\t\t\texec_validate_cap(true, true, false, false);\n\t} else {\n\t\tksft_print_msg(\"[RUN]\\tNon-root => no caps\\n\");\n\t\tif (fork_wait())\n\t\t\texec_validate_cap(false, false, false, false);\n\t}\n\n\tksft_print_msg(\"Check cap_ambient manipulation rules\\n\");\n\n\t \n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_RAISE, CAP_NET_BIND_SERVICE, 0, 0, 0) != -1 || errno != EPERM) {\n\t\tif (errno == EINVAL)\n\t\t\tksft_test_result_fail(\n\t\t\t\t\"PR_CAP_AMBIENT_RAISE isn't supported\\n\");\n\t\telse\n\t\t\tksft_test_result_fail(\n\t\t\t\t\"PR_CAP_AMBIENT_RAISE should have failed eith EPERM on a non-inheritable cap\\n\");\n\t\treturn 1;\n\t}\n\tksft_test_result_pass(\n\t\t\"PR_CAP_AMBIENT_RAISE failed on non-inheritable cap\\n\");\n\n\tcapng_update(CAPNG_ADD, CAPNG_INHERITABLE, CAP_NET_RAW);\n\tcapng_update(CAPNG_DROP, CAPNG_PERMITTED, CAP_NET_RAW);\n\tcapng_update(CAPNG_DROP, CAPNG_EFFECTIVE, CAP_NET_RAW);\n\tif (capng_apply(CAPNG_SELECT_CAPS) != 0)\n\t\tksft_exit_fail_msg(\"capng_apply - %s\\n\", strerror(errno));\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_RAISE, CAP_NET_RAW, 0, 0, 0) != -1 || errno != EPERM) {\n\t\tksft_test_result_fail(\n\t\t\t\"PR_CAP_AMBIENT_RAISE should have failed on a non-permitted cap\\n\");\n\t\treturn 1;\n\t}\n\tksft_test_result_pass(\n\t\t\"PR_CAP_AMBIENT_RAISE failed on non-permitted cap\\n\");\n\n\tcapng_update(CAPNG_ADD, CAPNG_INHERITABLE, CAP_NET_BIND_SERVICE);\n\tif (capng_apply(CAPNG_SELECT_CAPS) != 0)\n\t\tksft_exit_fail_msg(\"capng_apply - %s\\n\", strerror(errno));\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_RAISE, CAP_NET_BIND_SERVICE, 0, 0, 0) != 0) {\n\t\tksft_test_result_fail(\n\t\t\t\"PR_CAP_AMBIENT_RAISE should have succeeded\\n\");\n\t\treturn 1;\n\t}\n\tksft_test_result_pass(\"PR_CAP_AMBIENT_RAISE worked\\n\");\n\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_IS_SET, CAP_NET_BIND_SERVICE, 0, 0, 0) != 1) {\n\t\tksft_test_result_fail(\"PR_CAP_AMBIENT_IS_SET is broken\\n\");\n\t\treturn 1;\n\t}\n\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_CLEAR_ALL, 0, 0, 0, 0) != 0)\n\t\tksft_exit_fail_msg(\"PR_CAP_AMBIENT_CLEAR_ALL - %s\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_IS_SET, CAP_NET_BIND_SERVICE, 0, 0, 0) != 0) {\n\t\tksft_test_result_fail(\n\t\t\t\"PR_CAP_AMBIENT_CLEAR_ALL didn't work\\n\");\n\t\treturn 1;\n\t}\n\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_RAISE, CAP_NET_BIND_SERVICE, 0, 0, 0) != 0)\n\t\tksft_exit_fail_msg(\"PR_CAP_AMBIENT_RAISE - %s\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\tcapng_update(CAPNG_DROP, CAPNG_INHERITABLE, CAP_NET_BIND_SERVICE);\n\tif (capng_apply(CAPNG_SELECT_CAPS) != 0)\n\t\tksft_exit_fail_msg(\"capng_apply - %s\\n\", strerror(errno));\n\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_IS_SET, CAP_NET_BIND_SERVICE, 0, 0, 0) != 0) {\n\t\tksft_test_result_fail(\"Dropping I should have dropped A\\n\");\n\t\treturn 1;\n\t}\n\n\tksft_test_result_pass(\"Basic manipulation appears to work\\n\");\n\n\tcapng_update(CAPNG_ADD, CAPNG_INHERITABLE, CAP_NET_BIND_SERVICE);\n\tif (capng_apply(CAPNG_SELECT_CAPS) != 0)\n\t\tksft_exit_fail_msg(\"capng_apply - %s\\n\", strerror(errno));\n\tif (uid == 0) {\n\t\tksft_print_msg(\"[RUN]\\tRoot +i => eip\\n\");\n\t\tif (fork_wait())\n\t\t\texec_validate_cap(true, true, true, false);\n\t} else {\n\t\tksft_print_msg(\"[RUN]\\tNon-root +i => i\\n\");\n\t\tif (fork_wait())\n\t\t\texec_validate_cap(false, false, true, false);\n\t}\n\n\tif (prctl(PR_CAP_AMBIENT, PR_CAP_AMBIENT_RAISE, CAP_NET_BIND_SERVICE, 0, 0, 0) != 0)\n\t\tksft_exit_fail_msg(\"PR_CAP_AMBIENT_RAISE - %s\\n\",\n\t\t\t\t\tstrerror(errno));\n\n\tksft_print_msg(\"[RUN]\\tUID %d +ia => eipa\\n\", uid);\n\tif (fork_wait())\n\t\texec_validate_cap(true, true, true, true);\n\n\t \n\n\tif (!have_outer_privilege) {\n\t\tksft_test_result_skip(\"SUID/SGID tests (needs privilege)\\n\");\n\t\tgoto done;\n\t}\n\n\tif (uid == 0) {\n\t\tksft_print_msg(\"[RUN]\\tRoot +ia, suidroot => eipa\\n\");\n\t\tif (fork_wait())\n\t\t\texec_other_validate_cap(\"./validate_cap_suidroot\",\n\t\t\t\t\t\ttrue, true, true, true);\n\n\t\tksft_print_msg(\"[RUN]\\tRoot +ia, suidnonroot => ip\\n\");\n\t\tif (fork_wait())\n\t\t\texec_other_validate_cap(\"./validate_cap_suidnonroot\",\n\t\t\t\t\t\tfalse, true, true, false);\n\n\t\tksft_print_msg(\"[RUN]\\tRoot +ia, sgidroot => eipa\\n\");\n\t\tif (fork_wait())\n\t\t\texec_other_validate_cap(\"./validate_cap_sgidroot\",\n\t\t\t\t\t\ttrue, true, true, true);\n\n\t\tif (fork_wait()) {\n\t\t\tksft_print_msg(\n\t\t\t\t\"[RUN]\\tRoot, gid != 0, +ia, sgidroot => eip\\n\");\n\t\t\tif (setresgid(1, 1, 1) != 0)\n\t\t\t\tksft_exit_fail_msg(\"setresgid - %s\\n\",\n\t\t\t\t\t\t\tstrerror(errno));\n\t\t\texec_other_validate_cap(\"./validate_cap_sgidroot\",\n\t\t\t\t\t\ttrue, true, true, false);\n\t\t}\n\n\t\tksft_print_msg(\"[RUN]\\tRoot +ia, sgidnonroot => eip\\n\");\n\t\tif (fork_wait())\n\t\t\texec_other_validate_cap(\"./validate_cap_sgidnonroot\",\n\t\t\t\t\t\ttrue, true, true, false);\n\t} else {\n\t\tksft_print_msg(\"[RUN]\\tNon-root +ia, sgidnonroot => i\\n\");\n\t\tif (fork_wait())\n\t\t\texec_other_validate_cap(\"./validate_cap_sgidnonroot\",\n\t\t\t\t\tfalse, false, true, false);\n\n\t\tif (fork_wait()) {\n\t\t\tksft_print_msg(\"[RUN]\\tNon-root +ia, sgidroot => i\\n\");\n\t\t\tif (setresgid(1, 1, 1) != 0)\n\t\t\t\tksft_exit_fail_msg(\"setresgid - %s\\n\",\n\t\t\t\t\t\t\tstrerror(errno));\n\t\t\texec_other_validate_cap(\"./validate_cap_sgidroot\",\n\t\t\t\t\t\tfalse, false, true, false);\n\t\t}\n\t}\n\ndone:\n\tksft_print_cnts();\n\treturn nerrs ? 1 : 0;\n}\n\nint main(int argc, char **argv)\n{\n\tchar *tmp1, *tmp2, *our_path;\n\n\t \n\ttmp1 = strdup(argv[0]);\n\tif (!tmp1)\n\t\tksft_exit_fail_msg(\"strdup - %s\\n\", strerror(errno));\n\ttmp2 = dirname(tmp1);\n\tour_path = strdup(tmp2);\n\tif (!our_path)\n\t\tksft_exit_fail_msg(\"strdup - %s\\n\", strerror(errno));\n\tfree(tmp1);\n\n\tmpid = getpid();\n\n\tif (fork_wait()) {\n\t\tksft_print_header();\n\t\tksft_set_plan(12);\n\t\tksft_print_msg(\"[RUN]\\t+++ Tests with uid == 0 +++\\n\");\n\t\treturn do_tests(0, our_path);\n\t}\n\n\tksft_print_msg(\"==================================================\\n\");\n\n\tif (fork_wait()) {\n\t\tksft_print_header();\n\t\tksft_set_plan(9);\n\t\tksft_print_msg(\"[RUN]\\t+++ Tests with uid != 0 +++\\n\");\n\t\treturn do_tests(1, our_path);\n\t}\n\n\treturn nerrs ? 1 : 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}