{
  "module_name": "bench_rename.c",
  "hash_id": "8a3c956b1f43b503ce798ab05bceca42a7af06eb5c5345dfac52e8472b11dee0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/benchs/bench_rename.c",
  "human_readable_source": "\n \n#include <fcntl.h>\n#include \"bench.h\"\n#include \"test_overhead.skel.h\"\n\n \nstatic struct ctx {\n\tstruct test_overhead *skel;\n\tstruct counter hits;\n\tint fd;\n} ctx;\n\nstatic void validate(void)\n{\n\tif (env.producer_cnt != 1) {\n\t\tfprintf(stderr, \"benchmark doesn't support multi-producer!\\n\");\n\t\texit(1);\n\t}\n\tif (env.consumer_cnt != 0) {\n\t\tfprintf(stderr, \"benchmark doesn't support consumer!\\n\");\n\t\texit(1);\n\t}\n}\n\nstatic void *producer(void *input)\n{\n\tchar buf[] = \"test_overhead\";\n\tint err;\n\n\twhile (true) {\n\t\terr = write(ctx.fd, buf, sizeof(buf));\n\t\tif (err < 0) {\n\t\t\tfprintf(stderr, \"write failed\\n\");\n\t\t\texit(1);\n\t\t}\n\t\tatomic_inc(&ctx.hits.value);\n\t}\n}\n\nstatic void measure(struct bench_res *res)\n{\n\tres->hits = atomic_swap(&ctx.hits.value, 0);\n}\n\nstatic void setup_ctx(void)\n{\n\tsetup_libbpf();\n\n\tctx.skel = test_overhead__open_and_load();\n\tif (!ctx.skel) {\n\t\tfprintf(stderr, \"failed to open skeleton\\n\");\n\t\texit(1);\n\t}\n\n\tctx.fd = open(\"/proc/self/comm\", O_WRONLY|O_TRUNC);\n\tif (ctx.fd < 0) {\n\t\tfprintf(stderr, \"failed to open /proc/self/comm: %d\\n\", -errno);\n\t\texit(1);\n\t}\n}\n\nstatic void attach_bpf(struct bpf_program *prog)\n{\n\tstruct bpf_link *link;\n\n\tlink = bpf_program__attach(prog);\n\tif (!link) {\n\t\tfprintf(stderr, \"failed to attach program!\\n\");\n\t\texit(1);\n\t}\n}\n\nstatic void setup_base(void)\n{\n\tsetup_ctx();\n}\n\nstatic void setup_kprobe(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.prog1);\n}\n\nstatic void setup_kretprobe(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.prog2);\n}\n\nstatic void setup_rawtp(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.prog3);\n}\n\nstatic void setup_fentry(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.prog4);\n}\n\nstatic void setup_fexit(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.prog5);\n}\n\nconst struct bench bench_rename_base = {\n\t.name = \"rename-base\",\n\t.validate = validate,\n\t.setup = setup_base,\n\t.producer_thread = producer,\n\t.measure = measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_rename_kprobe = {\n\t.name = \"rename-kprobe\",\n\t.validate = validate,\n\t.setup = setup_kprobe,\n\t.producer_thread = producer,\n\t.measure = measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_rename_kretprobe = {\n\t.name = \"rename-kretprobe\",\n\t.validate = validate,\n\t.setup = setup_kretprobe,\n\t.producer_thread = producer,\n\t.measure = measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_rename_rawtp = {\n\t.name = \"rename-rawtp\",\n\t.validate = validate,\n\t.setup = setup_rawtp,\n\t.producer_thread = producer,\n\t.measure = measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_rename_fentry = {\n\t.name = \"rename-fentry\",\n\t.validate = validate,\n\t.setup = setup_fentry,\n\t.producer_thread = producer,\n\t.measure = measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_rename_fexit = {\n\t.name = \"rename-fexit\",\n\t.validate = validate,\n\t.setup = setup_fexit,\n\t.producer_thread = producer,\n\t.measure = measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}