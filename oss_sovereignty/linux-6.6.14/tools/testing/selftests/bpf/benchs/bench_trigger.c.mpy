{
  "module_name": "bench_trigger.c",
  "hash_id": "d1e600c799e22b56e34dd98ae0782dd96a60c0d0380d08afb1df05ee5fe7d84e",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/benchs/bench_trigger.c",
  "human_readable_source": "\n \n#include \"bench.h\"\n#include \"trigger_bench.skel.h\"\n#include \"trace_helpers.h\"\n\n \nstatic struct trigger_ctx {\n\tstruct trigger_bench *skel;\n} ctx;\n\nstatic struct counter base_hits;\n\nstatic void trigger_validate(void)\n{\n\tif (env.consumer_cnt != 0) {\n\t\tfprintf(stderr, \"benchmark doesn't support consumer!\\n\");\n\t\texit(1);\n\t}\n}\n\nstatic void *trigger_base_producer(void *input)\n{\n\twhile (true) {\n\t\t(void)syscall(__NR_getpgid);\n\t\tatomic_inc(&base_hits.value);\n\t}\n\treturn NULL;\n}\n\nstatic void trigger_base_measure(struct bench_res *res)\n{\n\tres->hits = atomic_swap(&base_hits.value, 0);\n}\n\nstatic void *trigger_producer(void *input)\n{\n\twhile (true)\n\t\t(void)syscall(__NR_getpgid);\n\treturn NULL;\n}\n\nstatic void trigger_measure(struct bench_res *res)\n{\n\tres->hits = atomic_swap(&ctx.skel->bss->hits, 0);\n}\n\nstatic void setup_ctx(void)\n{\n\tsetup_libbpf();\n\n\tctx.skel = trigger_bench__open_and_load();\n\tif (!ctx.skel) {\n\t\tfprintf(stderr, \"failed to open skeleton\\n\");\n\t\texit(1);\n\t}\n}\n\nstatic void attach_bpf(struct bpf_program *prog)\n{\n\tstruct bpf_link *link;\n\n\tlink = bpf_program__attach(prog);\n\tif (!link) {\n\t\tfprintf(stderr, \"failed to attach program!\\n\");\n\t\texit(1);\n\t}\n}\n\nstatic void trigger_tp_setup(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.bench_trigger_tp);\n}\n\nstatic void trigger_rawtp_setup(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.bench_trigger_raw_tp);\n}\n\nstatic void trigger_kprobe_setup(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.bench_trigger_kprobe);\n}\n\nstatic void trigger_fentry_setup(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.bench_trigger_fentry);\n}\n\nstatic void trigger_fentry_sleep_setup(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.bench_trigger_fentry_sleep);\n}\n\nstatic void trigger_fmodret_setup(void)\n{\n\tsetup_ctx();\n\tattach_bpf(ctx.skel->progs.bench_trigger_fmodret);\n}\n\n \n__weak void uprobe_target_with_nop(void)\n{\n\tasm volatile (\"nop\");\n}\n\n__weak void uprobe_target_without_nop(void)\n{\n\tasm volatile (\"\");\n}\n\nstatic void *uprobe_base_producer(void *input)\n{\n\twhile (true) {\n\t\tuprobe_target_with_nop();\n\t\tatomic_inc(&base_hits.value);\n\t}\n\treturn NULL;\n}\n\nstatic void *uprobe_producer_with_nop(void *input)\n{\n\twhile (true)\n\t\tuprobe_target_with_nop();\n\treturn NULL;\n}\n\nstatic void *uprobe_producer_without_nop(void *input)\n{\n\twhile (true)\n\t\tuprobe_target_without_nop();\n\treturn NULL;\n}\n\nstatic void usetup(bool use_retprobe, bool use_nop)\n{\n\tsize_t uprobe_offset;\n\tstruct bpf_link *link;\n\n\tsetup_libbpf();\n\n\tctx.skel = trigger_bench__open_and_load();\n\tif (!ctx.skel) {\n\t\tfprintf(stderr, \"failed to open skeleton\\n\");\n\t\texit(1);\n\t}\n\n\tif (use_nop)\n\t\tuprobe_offset = get_uprobe_offset(&uprobe_target_with_nop);\n\telse\n\t\tuprobe_offset = get_uprobe_offset(&uprobe_target_without_nop);\n\n\tlink = bpf_program__attach_uprobe(ctx.skel->progs.bench_trigger_uprobe,\n\t\t\t\t\t  use_retprobe,\n\t\t\t\t\t  -1  ,\n\t\t\t\t\t  \"/proc/self/exe\",\n\t\t\t\t\t  uprobe_offset);\n\tif (!link) {\n\t\tfprintf(stderr, \"failed to attach uprobe!\\n\");\n\t\texit(1);\n\t}\n\tctx.skel->links.bench_trigger_uprobe = link;\n}\n\nstatic void uprobe_setup_with_nop(void)\n{\n\tusetup(false, true);\n}\n\nstatic void uretprobe_setup_with_nop(void)\n{\n\tusetup(true, true);\n}\n\nstatic void uprobe_setup_without_nop(void)\n{\n\tusetup(false, false);\n}\n\nstatic void uretprobe_setup_without_nop(void)\n{\n\tusetup(true, false);\n}\n\nconst struct bench bench_trig_base = {\n\t.name = \"trig-base\",\n\t.validate = trigger_validate,\n\t.producer_thread = trigger_base_producer,\n\t.measure = trigger_base_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_tp = {\n\t.name = \"trig-tp\",\n\t.validate = trigger_validate,\n\t.setup = trigger_tp_setup,\n\t.producer_thread = trigger_producer,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_rawtp = {\n\t.name = \"trig-rawtp\",\n\t.validate = trigger_validate,\n\t.setup = trigger_rawtp_setup,\n\t.producer_thread = trigger_producer,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_kprobe = {\n\t.name = \"trig-kprobe\",\n\t.validate = trigger_validate,\n\t.setup = trigger_kprobe_setup,\n\t.producer_thread = trigger_producer,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_fentry = {\n\t.name = \"trig-fentry\",\n\t.validate = trigger_validate,\n\t.setup = trigger_fentry_setup,\n\t.producer_thread = trigger_producer,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_fentry_sleep = {\n\t.name = \"trig-fentry-sleep\",\n\t.validate = trigger_validate,\n\t.setup = trigger_fentry_sleep_setup,\n\t.producer_thread = trigger_producer,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_fmodret = {\n\t.name = \"trig-fmodret\",\n\t.validate = trigger_validate,\n\t.setup = trigger_fmodret_setup,\n\t.producer_thread = trigger_producer,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_uprobe_base = {\n\t.name = \"trig-uprobe-base\",\n\t.setup = NULL,  \n\t.producer_thread = uprobe_base_producer,\n\t.measure = trigger_base_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_uprobe_with_nop = {\n\t.name = \"trig-uprobe-with-nop\",\n\t.setup = uprobe_setup_with_nop,\n\t.producer_thread = uprobe_producer_with_nop,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_uretprobe_with_nop = {\n\t.name = \"trig-uretprobe-with-nop\",\n\t.setup = uretprobe_setup_with_nop,\n\t.producer_thread = uprobe_producer_with_nop,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_uprobe_without_nop = {\n\t.name = \"trig-uprobe-without-nop\",\n\t.setup = uprobe_setup_without_nop,\n\t.producer_thread = uprobe_producer_without_nop,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n\nconst struct bench bench_trig_uretprobe_without_nop = {\n\t.name = \"trig-uretprobe-without-nop\",\n\t.setup = uretprobe_setup_without_nop,\n\t.producer_thread = uprobe_producer_without_nop,\n\t.measure = trigger_measure,\n\t.report_progress = hits_drops_report_progress,\n\t.report_final = hits_drops_report_final,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}