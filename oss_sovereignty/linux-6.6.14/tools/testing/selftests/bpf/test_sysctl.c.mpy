{
  "module_name": "test_sysctl.c",
  "hash_id": "af111062db0ca6deb64addc21652a0aacc41b96317362190dfb7a9811ac7be2a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_sysctl.c",
  "human_readable_source": "\n\n\n#include <fcntl.h>\n#include <stdint.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\n#include <linux/filter.h>\n\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n\n#include <bpf/bpf_endian.h>\n#include \"bpf_util.h\"\n#include \"cgroup_helpers.h\"\n#include \"testing_helpers.h\"\n\n#define CG_PATH\t\t\t\"/foo\"\n#define MAX_INSNS\t\t512\n#define FIXUP_SYSCTL_VALUE\t0\n\nchar bpf_log_buf[BPF_LOG_BUF_SIZE];\n\nstruct sysctl_test {\n\tconst char *descr;\n\tsize_t fixup_value_insn;\n\tstruct bpf_insn\tinsns[MAX_INSNS];\n\tconst char *prog_file;\n\tenum bpf_attach_type attach_type;\n\tconst char *sysctl;\n\tint open_flags;\n\tint seek;\n\tconst char *newval;\n\tconst char *oldval;\n\tenum {\n\t\tLOAD_REJECT,\n\t\tATTACH_REJECT,\n\t\tOP_EPERM,\n\t\tSUCCESS,\n\t} result;\n};\n\nstatic struct sysctl_test tests[] = {\n\t{\n\t\t.descr = \"sysctl wrong attach_type\",\n\t\t.insns = {\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = 0,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = ATTACH_REJECT,\n\t},\n\t{\n\t\t.descr = \"sysctl:read allow all\",\n\t\t.insns = {\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl:read deny all\",\n\t\t.insns = {\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"ctx:write sysctl:read read ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, write)),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, 1, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"ctx:write sysctl:write read ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, write)),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, 1, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/domainname\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"(none)\",  \n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"ctx:write sysctl:write read ok narrow\",\n\t\t.insns = {\n\t\t\t \n#if __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__\n\t\t\tBPF_LDX_MEM(BPF_H, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, write)),\n#else\n\t\t\tBPF_LDX_MEM(BPF_H, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, write) + 2),\n#endif\n\t\t\tBPF_ALU64_IMM(BPF_AND, BPF_REG_7, 1),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_ALU64_REG(BPF_SUB, BPF_REG_0, BPF_REG_7),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/domainname\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"(none)\",  \n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"ctx:write sysctl:read write reject\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sysctl, write)),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = LOAD_REJECT,\n\t},\n\t{\n\t\t.descr = \"ctx:file_pos sysctl:read read ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, file_pos)),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, 3, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.seek = 3,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"ctx:file_pos sysctl:read read ok narrow\",\n\t\t.insns = {\n\t\t\t \n#if __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__\n\t\t\tBPF_LDX_MEM(BPF_B, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, file_pos)),\n#else\n\t\t\tBPF_LDX_MEM(BPF_B, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sysctl, file_pos) + 3),\n#endif\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, 4, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.seek = 4,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"ctx:file_pos sysctl:read write ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 2),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sysctl, file_pos)),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.oldval = \"nux\\n\",\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_name sysctl_value:base ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 8),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_4, BPF_F_SYSCTL_BASE_NAME),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_name),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, sizeof(\"tcp_mem\") - 1, 6),\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x7463705f6d656d00ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_name sysctl_value:base E2BIG truncated\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_4, BPF_F_SYSCTL_BASE_NAME),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_name),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -E2BIG, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x7463705f6d650000ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_name sysctl:full ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -24),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 16),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 17),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_4, 0),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_name),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 16, 14),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x6e65742f69707634ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 10),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x2f7463705f6d656dULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 8),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8, 0x0ULL),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 16),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_name sysctl:full E2BIG truncated\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -16),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 8),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 16),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_4, 0),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_name),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -E2BIG, 10),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x6e65742f69707634ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x2f7463705f6d6500ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 8),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_name sysctl:full E2BIG truncated small\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_4, 0),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_name),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -E2BIG, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x6e65742f69700000ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_current_value sysctl:read ok, gt\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 8),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_current_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 6, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x4c696e75780a0000ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_current_value sysctl:read ok, eq\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_B, BPF_REG_7, BPF_REG_0, 7),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 7),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_current_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 6, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x4c696e75780a0000ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_current_value sysctl:read E2BIG truncated\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_H, BPF_REG_7, BPF_REG_0, 6),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 6),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_current_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -E2BIG, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x4c696e7578000000ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"kernel/ostype\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_current_value sysctl:read EINVAL\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 8),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_current_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -EINVAL, 4),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, 0, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv6/conf/lo/stable_secret\",  \n\t\t.open_flags = O_RDONLY,\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_current_value sysctl:write ok\",\n\t\t.fixup_value_insn = 6,\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 8),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_current_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 4, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8, FIXUP_SYSCTL_VALUE),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"600\",  \n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_new_value sysctl:read EINVAL\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 8),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_new_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -EINVAL, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_new_value sysctl:write ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 4),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_new_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 3, 4),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9,\n\t\t\t\t    bpf_ntohl(0x36303600), 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"606\",\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_new_value sysctl:write ok long\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -24),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 24),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_new_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 23, 14),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x3330303030303020ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 10),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x3430303030303020ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 8),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 6),\n\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8,\n\t\t\t\t     bpf_be64_to_cpu(0x3630303030303000ULL)),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 16),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"3000000 4000000 6000000\",\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"sysctl_get_new_value sysctl:write E2BIG\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_B, BPF_REG_7, BPF_REG_0, 3),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 3),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_get_new_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -E2BIG, 4),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9,\n\t\t\t\t    bpf_ntohl(0x36300000), 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"606\",\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t.descr = \"sysctl_set_new_value sysctl:read EINVAL\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x36303000)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 3),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_set_new_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -EINVAL, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t.descr = \"sysctl_set_new_value sysctl:write ok\",\n\t\t.fixup_value_insn = 2,\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_LD_IMM64(BPF_REG_0, FIXUP_SYSCTL_VALUE),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 3),\n\n\t\t\t \n\t\t\tBPF_EMIT_CALL(BPF_FUNC_sysctl_set_new_value),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"606\",\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtoul one number string\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x36303000)),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 3, 4),\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, 600, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtoul multi number string\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3630302036303200ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 8),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 3, 18),\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, 600, 16),\n\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_ALU64_REG(BPF_ADD, BPF_REG_7, BPF_REG_0),\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 8),\n\t\t\tBPF_ALU64_REG(BPF_SUB, BPF_REG_2, BPF_REG_0),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -16),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 4, 4),\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, 602, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtoul buf_len = 0, reject\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x36303000)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 0),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = LOAD_REJECT,\n\t},\n\t{\n\t\t\"bpf_strtoul supported base, ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x30373700)),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 8),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 3, 4),\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, 63, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtoul unsupported base, EINVAL\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x36303000)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 3),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -EINVAL, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtoul buf with spaces only, EINVAL\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x0d0c0a09)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -EINVAL, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtoul negative number, EINVAL\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x0a2d3600)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtoul),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -EINVAL, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtol negative number, ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x0a2d3600)),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 10),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtol),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 3, 4),\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, -6, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtol hex number, ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0,\n\t\t\t\t      bpf_ntohl(0x30786665)),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_0, 0),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 4),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtol),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 4, 4),\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_9, 254, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtol max long\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -24),\n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3932323333373230ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3336383534373735ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 8),\n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3830370000000000ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 16),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 19),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtol),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, 19, 6),\n\t\t\t \n\t\t\tBPF_LD_IMM64(BPF_REG_8, 0x7fffffffffffffffULL),\n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_7, 0),\n\t\t\tBPF_JMP_REG(BPF_JNE, BPF_REG_8, BPF_REG_9, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"bpf_strtol overflow, ERANGE\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_10),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -24),\n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3932323333373230ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3336383534373735ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 8),\n\t\t\tBPF_LD_IMM64(BPF_REG_0,\n\t\t\t\t     bpf_be64_to_cpu(0x3830380000000000ULL)),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 16),\n\n\t\t\tBPF_MOV64_REG(BPF_REG_1, BPF_REG_7),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_2, 19),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_3, 0),\n\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, -8),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_0, 0),\n\t\t\tBPF_MOV64_REG(BPF_REG_4, BPF_REG_7),\n\n\t\t\tBPF_EMIT_CALL(BPF_FUNC_strtol),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_0, -ERANGE, 2),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n\t{\n\t\t\"C prog: deny all writes\",\n\t\t.prog_file = \"./test_sysctl_prog.bpf.o\",\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_WRONLY,\n\t\t.newval = \"123 456 789\",\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t\"C prog: deny access by name\",\n\t\t.prog_file = \"./test_sysctl_prog.bpf.o\",\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/route/mtu_expires\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = OP_EPERM,\n\t},\n\t{\n\t\t\"C prog: read tcp_mem\",\n\t\t.prog_file = \"./test_sysctl_prog.bpf.o\",\n\t\t.attach_type = BPF_CGROUP_SYSCTL,\n\t\t.sysctl = \"net/ipv4/tcp_mem\",\n\t\t.open_flags = O_RDONLY,\n\t\t.result = SUCCESS,\n\t},\n};\n\nstatic size_t probe_prog_length(const struct bpf_insn *fp)\n{\n\tsize_t len;\n\n\tfor (len = MAX_INSNS - 1; len > 0; --len)\n\t\tif (fp[len].code != 0 || fp[len].imm != 0)\n\t\t\tbreak;\n\treturn len + 1;\n}\n\nstatic int fixup_sysctl_value(const char *buf, size_t buf_len,\n\t\t\t      struct bpf_insn *prog, size_t insn_num)\n{\n\tunion {\n\t\tuint8_t raw[sizeof(uint64_t)];\n\t\tuint64_t num;\n\t} value = {};\n\n\tif (buf_len > sizeof(value)) {\n\t\tlog_err(\"Value is too big (%zd) to use in fixup\", buf_len);\n\t\treturn -1;\n\t}\n\tif (prog[insn_num].code != (BPF_LD | BPF_DW | BPF_IMM)) {\n\t\tlog_err(\"Can fixup only BPF_LD_IMM64 insns\");\n\t\treturn -1;\n\t}\n\n\tmemcpy(value.raw, buf, buf_len);\n\tprog[insn_num].imm = (uint32_t)value.num;\n\tprog[insn_num + 1].imm = (uint32_t)(value.num >> 32);\n\n\treturn 0;\n}\n\nstatic int load_sysctl_prog_insns(struct sysctl_test *test,\n\t\t\t\t  const char *sysctl_path)\n{\n\tstruct bpf_insn *prog = test->insns;\n\tLIBBPF_OPTS(bpf_prog_load_opts, opts);\n\tint ret, insn_cnt;\n\n\tinsn_cnt = probe_prog_length(prog);\n\n\tif (test->fixup_value_insn) {\n\t\tchar buf[128];\n\t\tssize_t len;\n\t\tint fd;\n\n\t\tfd = open(sysctl_path, O_RDONLY | O_CLOEXEC);\n\t\tif (fd < 0) {\n\t\t\tlog_err(\"open(%s) failed\", sysctl_path);\n\t\t\treturn -1;\n\t\t}\n\t\tlen = read(fd, buf, sizeof(buf));\n\t\tif (len == -1) {\n\t\t\tlog_err(\"read(%s) failed\", sysctl_path);\n\t\t\tclose(fd);\n\t\t\treturn -1;\n\t\t}\n\t\tclose(fd);\n\t\tif (fixup_sysctl_value(buf, len, prog, test->fixup_value_insn))\n\t\t\treturn -1;\n\t}\n\n\topts.log_buf = bpf_log_buf;\n\topts.log_size = BPF_LOG_BUF_SIZE;\n\n\tret = bpf_prog_load(BPF_PROG_TYPE_CGROUP_SYSCTL, NULL, \"GPL\", prog, insn_cnt, &opts);\n\tif (ret < 0 && test->result != LOAD_REJECT) {\n\t\tlog_err(\">>> Loading program error.\\n\"\n\t\t\t\">>> Verifier output:\\n%s\\n-------\\n\", bpf_log_buf);\n\t}\n\n\treturn ret;\n}\n\nstatic int load_sysctl_prog_file(struct sysctl_test *test)\n{\n\tstruct bpf_object *obj;\n\tint prog_fd;\n\n\tif (bpf_prog_test_load(test->prog_file, BPF_PROG_TYPE_CGROUP_SYSCTL, &obj, &prog_fd)) {\n\t\tif (test->result != LOAD_REJECT)\n\t\t\tlog_err(\">>> Loading program (%s) error.\\n\",\n\t\t\t\ttest->prog_file);\n\t\treturn -1;\n\t}\n\n\treturn prog_fd;\n}\n\nstatic int load_sysctl_prog(struct sysctl_test *test, const char *sysctl_path)\n{\n\t\treturn test->prog_file\n\t\t\t? load_sysctl_prog_file(test)\n\t\t\t: load_sysctl_prog_insns(test, sysctl_path);\n}\n\nstatic int access_sysctl(const char *sysctl_path,\n\t\t\t const struct sysctl_test *test)\n{\n\tint err = 0;\n\tint fd;\n\n\tfd = open(sysctl_path, test->open_flags | O_CLOEXEC);\n\tif (fd < 0)\n\t\treturn fd;\n\n\tif (test->seek && lseek(fd, test->seek, SEEK_SET) == -1) {\n\t\tlog_err(\"lseek(%d) failed\", test->seek);\n\t\tgoto err;\n\t}\n\n\tif (test->open_flags == O_RDONLY) {\n\t\tchar buf[128];\n\n\t\tif (read(fd, buf, sizeof(buf)) == -1)\n\t\t\tgoto err;\n\t\tif (test->oldval &&\n\t\t    strncmp(buf, test->oldval, strlen(test->oldval))) {\n\t\t\tlog_err(\"Read value %s != %s\", buf, test->oldval);\n\t\t\tgoto err;\n\t\t}\n\t} else if (test->open_flags == O_WRONLY) {\n\t\tif (!test->newval) {\n\t\t\tlog_err(\"New value for sysctl is not set\");\n\t\t\tgoto err;\n\t\t}\n\t\tif (write(fd, test->newval, strlen(test->newval)) == -1)\n\t\t\tgoto err;\n\t} else {\n\t\tlog_err(\"Unexpected sysctl access: neither read nor write\");\n\t\tgoto err;\n\t}\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\tclose(fd);\n\treturn err;\n}\n\nstatic int run_test_case(int cgfd, struct sysctl_test *test)\n{\n\tenum bpf_attach_type atype = test->attach_type;\n\tchar sysctl_path[128];\n\tint progfd = -1;\n\tint err = 0;\n\n\tprintf(\"Test case: %s .. \", test->descr);\n\n\tsnprintf(sysctl_path, sizeof(sysctl_path), \"/proc/sys/%s\",\n\t\t test->sysctl);\n\n\tprogfd = load_sysctl_prog(test, sysctl_path);\n\tif (progfd < 0) {\n\t\tif (test->result == LOAD_REJECT)\n\t\t\tgoto out;\n\t\telse\n\t\t\tgoto err;\n\t}\n\n\tif (bpf_prog_attach(progfd, cgfd, atype, BPF_F_ALLOW_OVERRIDE) < 0) {\n\t\tif (test->result == ATTACH_REJECT)\n\t\t\tgoto out;\n\t\telse\n\t\t\tgoto err;\n\t}\n\n\terrno = 0;\n\tif (access_sysctl(sysctl_path, test) == -1) {\n\t\tif (test->result == OP_EPERM && errno == EPERM)\n\t\t\tgoto out;\n\t\telse\n\t\t\tgoto err;\n\t}\n\n\tif (test->result != SUCCESS) {\n\t\tlog_err(\"Unexpected success\");\n\t\tgoto err;\n\t}\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\t \n\tif (progfd != -1)\n\t\tbpf_prog_detach(cgfd, atype);\n\tclose(progfd);\n\tprintf(\"[%s]\\n\", err ? \"FAIL\" : \"PASS\");\n\treturn err;\n}\n\nstatic int run_tests(int cgfd)\n{\n\tint passes = 0;\n\tint fails = 0;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); ++i) {\n\t\tif (run_test_case(cgfd, &tests[i]))\n\t\t\t++fails;\n\t\telse\n\t\t\t++passes;\n\t}\n\tprintf(\"Summary: %d PASSED, %d FAILED\\n\", passes, fails);\n\treturn fails ? -1 : 0;\n}\n\nint main(int argc, char **argv)\n{\n\tint cgfd = -1;\n\tint err = 0;\n\n\tcgfd = cgroup_setup_and_join(CG_PATH);\n\tif (cgfd < 0)\n\t\tgoto err;\n\n\t \n\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);\n\n\tif (run_tests(cgfd))\n\t\tgoto err;\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\tclose(cgfd);\n\tcleanup_cgroup_environment();\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}