{
  "module_name": "verify_sig_setup.sh",
  "hash_id": "93195bfcf45bf49c075af124dcc1504386344fcdd1124099949f76aad885aaf9",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/verify_sig_setup.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nset -e\nset -u\nset -o pipefail\n\nVERBOSE=\"${SELFTESTS_VERBOSE:=0}\"\nLOG_FILE=\"$(mktemp /tmp/verify_sig_setup.log.XXXXXX)\"\n\nx509_genkey_content=\"\\\n[ req ]\ndefault_bits = 2048\ndistinguished_name = req_distinguished_name\nprompt = no\nstring_mask = utf8only\nx509_extensions = myexts\n\n[ req_distinguished_name ]\nCN = eBPF Signature Verification Testing Key\n\n[ myexts ]\nbasicConstraints=critical,CA:FALSE\nkeyUsage=digitalSignature\nsubjectKeyIdentifier=hash\nauthorityKeyIdentifier=keyid\n\"\n\nusage()\n{\n\techo \"Usage: $0 <setup|cleanup <existing_tmp_dir>\"\n\texit 1\n}\n\nsetup()\n{\n\tlocal tmp_dir=\"$1\"\n\n\techo \"${x509_genkey_content}\" > ${tmp_dir}/x509.genkey\n\n\topenssl req -new -nodes -utf8 -sha256 -days 36500 \\\n\t\t\t-batch -x509 -config ${tmp_dir}/x509.genkey \\\n\t\t\t-outform PEM -out ${tmp_dir}/signing_key.pem \\\n\t\t\t-keyout ${tmp_dir}/signing_key.pem 2>&1\n\n\topenssl x509 -in ${tmp_dir}/signing_key.pem -out \\\n\t\t${tmp_dir}/signing_key.der -outform der\n\n\tkey_id=$(cat ${tmp_dir}/signing_key.der | keyctl padd asymmetric ebpf_testing_key @s)\n\n\tkeyring_id=$(keyctl newring ebpf_testing_keyring @s)\n\tkeyctl link $key_id $keyring_id\n}\n\ncleanup() {\n\tlocal tmp_dir=\"$1\"\n\n\tkeyctl unlink $(keyctl search @s asymmetric ebpf_testing_key) @s\n\tkeyctl unlink $(keyctl search @s keyring ebpf_testing_keyring) @s\n\trm -rf ${tmp_dir}\n}\n\ncatch()\n{\n\tlocal exit_code=\"$1\"\n\tlocal log_file=\"$2\"\n\n\tif [[ \"${exit_code}\" -ne 0 ]]; then\n\t\tcat \"${log_file}\" >&3\n\tfi\n\n\trm -f \"${log_file}\"\n\texit ${exit_code}\n}\n\nmain()\n{\n\t[[ $# -ne 2 ]] && usage\n\n\tlocal action=\"$1\"\n\tlocal tmp_dir=\"$2\"\n\n\t[[ ! -d \"${tmp_dir}\" ]] && echo \"Directory ${tmp_dir} doesn't exist\" && exit 1\n\n\tif [[ \"${action}\" == \"setup\" ]]; then\n\t\tsetup \"${tmp_dir}\"\n\telif [[ \"${action}\" == \"cleanup\" ]]; then\n\t\tcleanup \"${tmp_dir}\"\n\telse\n\t\techo \"Unknown action: ${action}\"\n\t\texit 1\n\tfi\n}\n\ntrap 'catch \"$?\" \"${LOG_FILE}\"' EXIT\n\nif [[ \"${VERBOSE}\" -eq 0 ]]; then\n\t# Save the stderr to 3 so that we can output back to\n\t# it incase of an error.\n\texec 3>&2 1>\"${LOG_FILE}\" 2>&1\nfi\n\nmain \"$@\"\nrm -f \"${LOG_FILE}\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}