{
  "module_name": "ima_setup.sh",
  "hash_id": "ff98c002158a6053733bd9c339c47c55ce76d257a08d794b0529449a966c95a8",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/ima_setup.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nset -e\nset -u\nset -o pipefail\n\nIMA_POLICY_FILE=\"/sys/kernel/security/ima/policy\"\nTEST_BINARY=\"/bin/true\"\nVERBOSE=\"${SELFTESTS_VERBOSE:=0}\"\nLOG_FILE=\"$(mktemp /tmp/ima_setup.XXXX.log)\"\n\nusage()\n{\n\techo \"Usage: $0 <setup|cleanup|run|modify-bin|restore-bin|load-policy> <existing_tmp_dir>\"\n\texit 1\n}\n\nensure_mount_securityfs()\n{\n\tlocal securityfs_dir=$(grep \"securityfs\" /proc/mounts | awk '{print $2}')\n\n\tif [ -z \"${securityfs_dir}\" ]; then\n\t\tsecurityfs_dir=/sys/kernel/security\n\t\tmount -t securityfs security \"${securityfs_dir}\"\n\tfi\n\n\tif [ ! -d \"${securityfs_dir}\" ]; then\n\t\techo \"${securityfs_dir}: securityfs is not mounted\" && exit 1\n\tfi\n}\n\nsetup()\n{\n\tlocal tmp_dir=\"$1\"\n\tlocal mount_img=\"${tmp_dir}/test.img\"\n\tlocal mount_dir=\"${tmp_dir}/mnt\"\n\tlocal copied_bin_path=\"${mount_dir}/$(basename ${TEST_BINARY})\"\n\tmkdir -p ${mount_dir}\n\n\tdd if=/dev/zero of=\"${mount_img}\" bs=1M count=10\n\n\tlosetup -f \"${mount_img}\"\n\tlocal loop_device=$(losetup -a | grep ${mount_img:?} | cut -d \":\" -f1)\n\n\tmkfs.ext2 \"${loop_device:?}\"\n\tmount \"${loop_device}\" \"${mount_dir}\"\n\n\tcp \"${TEST_BINARY}\" \"${mount_dir}\"\n\tlocal mount_uuid=\"$(blkid ${loop_device} | sed 's/.*UUID=\"\\([^\"]*\\)\".*/\\1/')\"\n\n\tensure_mount_securityfs\n\techo \"measure func=BPRM_CHECK fsuuid=${mount_uuid}\" > ${IMA_POLICY_FILE}\n\techo \"measure func=BPRM_CHECK fsuuid=${mount_uuid}\" > ${mount_dir}/policy_test\n}\n\ncleanup() {\n\tlocal tmp_dir=\"$1\"\n\tlocal mount_img=\"${tmp_dir}/test.img\"\n\tlocal mount_dir=\"${tmp_dir}/mnt\"\n\n\tlocal loop_devices=$(losetup -a | grep ${mount_img:?} | cut -d \":\" -f1)\n\n\tfor loop_dev in \"${loop_devices}\"; do\n\t\tlosetup -d $loop_dev\n\tdone\n\n\tumount ${mount_dir}\n\trm -rf ${tmp_dir}\n}\n\nrun()\n{\n\tlocal tmp_dir=\"$1\"\n\tlocal mount_dir=\"${tmp_dir}/mnt\"\n\tlocal copied_bin_path=\"${mount_dir}/$(basename ${TEST_BINARY})\"\n\n\texec \"${copied_bin_path}\"\n}\n\nmodify_bin()\n{\n\tlocal tmp_dir=\"$1\"\n\tlocal mount_dir=\"${tmp_dir}/mnt\"\n\tlocal copied_bin_path=\"${mount_dir}/$(basename ${TEST_BINARY})\"\n\n\techo \"mod\" >> \"${copied_bin_path}\"\n}\n\nrestore_bin()\n{\n\tlocal tmp_dir=\"$1\"\n\tlocal mount_dir=\"${tmp_dir}/mnt\"\n\tlocal copied_bin_path=\"${mount_dir}/$(basename ${TEST_BINARY})\"\n\n\ttruncate -s -4 \"${copied_bin_path}\"\n}\n\nload_policy()\n{\n\tlocal tmp_dir=\"$1\"\n\tlocal mount_dir=\"${tmp_dir}/mnt\"\n\n\techo ${mount_dir}/policy_test > ${IMA_POLICY_FILE} 2> /dev/null\n}\n\ncatch()\n{\n\tlocal exit_code=\"$1\"\n\tlocal log_file=\"$2\"\n\n\tif [[ \"${exit_code}\" -ne 0 ]]; then\n\t\tcat \"${log_file}\" >&3\n\tfi\n\n\trm -f \"${log_file}\"\n\texit ${exit_code}\n}\n\nmain()\n{\n\t[[ $# -ne 2 ]] && usage\n\n\tlocal action=\"$1\"\n\tlocal tmp_dir=\"$2\"\n\n\t[[ ! -d \"${tmp_dir}\" ]] && echo \"Directory ${tmp_dir} doesn't exist\" && exit 1\n\n\tif [[ \"${action}\" == \"setup\" ]]; then\n\t\tsetup \"${tmp_dir}\"\n\telif [[ \"${action}\" == \"cleanup\" ]]; then\n\t\tcleanup \"${tmp_dir}\"\n\telif [[ \"${action}\" == \"run\" ]]; then\n\t\trun \"${tmp_dir}\"\n\telif [[ \"${action}\" == \"modify-bin\" ]]; then\n\t\tmodify_bin \"${tmp_dir}\"\n\telif [[ \"${action}\" == \"restore-bin\" ]]; then\n\t\trestore_bin \"${tmp_dir}\"\n\telif [[ \"${action}\" == \"load-policy\" ]]; then\n\t\tload_policy \"${tmp_dir}\"\n\telse\n\t\techo \"Unknown action: ${action}\"\n\t\texit 1\n\tfi\n}\n\ntrap 'catch \"$?\" \"${LOG_FILE}\"' EXIT\n\nif [[ \"${VERBOSE}\" -eq 0 ]]; then\n\t# Save the stderr to 3 so that we can output back to\n\t# it incase of an error.\n\texec 3>&2 1>\"${LOG_FILE}\" 2>&1\nfi\n\nmain \"$@\"\nrm -f \"${LOG_FILE}\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}