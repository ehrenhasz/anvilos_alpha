{
  "module_name": "test_flow_dissector.sh",
  "hash_id": "1572e9fc2fc397915419b232ced87034e94cc9601b777581637f3bf24fb4046b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_flow_dissector.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Load BPF flow dissector and verify it correctly dissects traffic\n\nBPF_FILE=\"bpf_flow.bpf.o\"\nexport TESTNAME=test_flow_dissector\nunmount=0\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nmsg=\"skip all tests:\"\nif [ $UID != 0 ]; then\n\techo $msg please run this as root >&2\n\texit $ksft_skip\nfi\n\n# This test needs to be run in a network namespace with in_netns.sh. Check if\n# this is the case and run it with in_netns.sh if it is being run in the root\n# namespace.\nif [[ -z $(ip netns identify $$) ]]; then\n\terr=0\n\tif bpftool=\"$(which bpftool)\"; then\n\t\techo \"Testing global flow dissector...\"\n\n\t\t$bpftool prog loadall $BPF_FILE /sys/fs/bpf/flow \\\n\t\t\ttype flow_dissector\n\n\t\tif ! unshare --net $bpftool prog attach pinned \\\n\t\t\t/sys/fs/bpf/flow/_dissect flow_dissector; then\n\t\t\techo \"Unexpected unsuccessful attach in namespace\" >&2\n\t\t\terr=1\n\t\tfi\n\n\t\t$bpftool prog attach pinned /sys/fs/bpf/flow/_dissect \\\n\t\t\tflow_dissector\n\n\t\tif unshare --net $bpftool prog attach pinned \\\n\t\t\t/sys/fs/bpf/flow/_dissect flow_dissector; then\n\t\t\techo \"Unexpected successful attach in namespace\" >&2\n\t\t\terr=1\n\t\tfi\n\n\t\tif ! $bpftool prog detach pinned \\\n\t\t\t/sys/fs/bpf/flow/_dissect flow_dissector; then\n\t\t\techo \"Failed to detach flow dissector\" >&2\n\t\t\terr=1\n\t\tfi\n\n\t\trm -rf /sys/fs/bpf/flow\n\telse\n\t\techo \"Skipping root flow dissector test, bpftool not found\" >&2\n\tfi\n\n\t# Run the rest of the tests in a net namespace.\n\t../net/in_netns.sh \"$0\" \"$@\"\n\terr=$(( $err + $? ))\n\n\tif (( $err == 0 )); then\n\t\techo \"selftests: $TESTNAME [PASS]\";\n\telse\n\t\techo \"selftests: $TESTNAME [FAILED]\";\n\tfi\n\n\texit $err\nfi\n\n# Determine selftest success via shell exit code\nexit_handler()\n{\n\tset +e\n\n\t# Cleanup\n\ttc filter del dev lo ingress pref 1337 2> /dev/null\n\ttc qdisc del dev lo ingress 2> /dev/null\n\t./flow_dissector_load -d 2> /dev/null\n\tif [ $unmount -ne 0 ]; then\n\t\tumount bpffs 2> /dev/null\n\tfi\n}\n\n# Exit script immediately (well catched by trap handler) if any\n# program/thing exits with a non-zero status.\nset -e\n\n# (Use 'trap -l' to list meaning of numbers)\ntrap exit_handler 0 2 3 6 9\n\n# Mount BPF file system\nif /bin/mount | grep /sys/fs/bpf > /dev/null; then\n\techo \"bpffs already mounted\"\nelse\n\techo \"bpffs not mounted. Mounting...\"\n\tunmount=1\n\t/bin/mount bpffs /sys/fs/bpf -t bpf\nfi\n\n# Attach BPF program\n./flow_dissector_load -p $BPF_FILE -s _dissect\n\n# Setup\ntc qdisc add dev lo ingress\necho 0 > /proc/sys/net/ipv4/conf/default/rp_filter\necho 0 > /proc/sys/net/ipv4/conf/all/rp_filter\necho 0 > /proc/sys/net/ipv4/conf/lo/rp_filter\n\necho \"Testing IPv4...\"\n# Drops all IP/UDP packets coming from port 9\ntc filter add dev lo parent ffff: protocol ip pref 1337 flower ip_proto \\\n\tudp src_port 9 action drop\n\n# Send 10 IPv4/UDP packets from port 8. Filter should not drop any.\n./test_flow_dissector -i 4 -f 8\n# Send 10 IPv4/UDP packets from port 9. Filter should drop all.\n./test_flow_dissector -i 4 -f 9 -F\n# Send 10 IPv4/UDP packets from port 10. Filter should not drop any.\n./test_flow_dissector -i 4 -f 10\n\necho \"Testing IPv4 from 127.0.0.127 (fallback to generic dissector)...\"\n# Send 10 IPv4/UDP packets from port 8. Filter should not drop any.\n./test_flow_dissector -i 4 -S 127.0.0.127 -f 8\n# Send 10 IPv4/UDP packets from port 9. Filter should drop all.\n./test_flow_dissector -i 4 -S 127.0.0.127 -f 9 -F\n# Send 10 IPv4/UDP packets from port 10. Filter should not drop any.\n./test_flow_dissector -i 4 -S 127.0.0.127 -f 10\n\necho \"Testing IPIP...\"\n# Send 10 IPv4/IPv4/UDP packets from port 8. Filter should not drop any.\n./with_addr.sh ./with_tunnels.sh ./test_flow_dissector -o 4 -e bare -i 4 \\\n\t-D 192.168.0.1 -S 1.1.1.1 -f 8\n# Send 10 IPv4/IPv4/UDP packets from port 9. Filter should drop all.\n./with_addr.sh ./with_tunnels.sh ./test_flow_dissector -o 4 -e bare -i 4 \\\n\t-D 192.168.0.1 -S 1.1.1.1 -f 9 -F\n# Send 10 IPv4/IPv4/UDP packets from port 10. Filter should not drop any.\n./with_addr.sh ./with_tunnels.sh ./test_flow_dissector -o 4 -e bare -i 4 \\\n\t-D 192.168.0.1 -S 1.1.1.1 -f 10\n\necho \"Testing IPv4 + GRE...\"\n# Send 10 IPv4/GRE/IPv4/UDP packets from port 8. Filter should not drop any.\n./with_addr.sh ./with_tunnels.sh ./test_flow_dissector -o 4 -e gre -i 4 \\\n\t-D 192.168.0.1 -S 1.1.1.1 -f 8\n# Send 10 IPv4/GRE/IPv4/UDP packets from port 9. Filter should drop all.\n./with_addr.sh ./with_tunnels.sh ./test_flow_dissector -o 4 -e gre -i 4 \\\n\t-D 192.168.0.1 -S 1.1.1.1 -f 9 -F\n# Send 10 IPv4/GRE/IPv4/UDP packets from port 10. Filter should not drop any.\n./with_addr.sh ./with_tunnels.sh ./test_flow_dissector -o 4 -e gre -i 4 \\\n\t-D 192.168.0.1 -S 1.1.1.1 -f 10\n\ntc filter del dev lo ingress pref 1337\n\necho \"Testing port range...\"\n# Drops all IP/UDP packets coming from port 8-10\ntc filter add dev lo parent ffff: protocol ip pref 1337 flower ip_proto \\\n\tudp src_port 8-10 action drop\n\n# Send 10 IPv4/UDP packets from port 7. Filter should not drop any.\n./test_flow_dissector -i 4 -f 7\n# Send 10 IPv4/UDP packets from port 9. Filter should drop all.\n./test_flow_dissector -i 4 -f 9 -F\n# Send 10 IPv4/UDP packets from port 11. Filter should not drop any.\n./test_flow_dissector -i 4 -f 11\n\ntc filter del dev lo ingress pref 1337\n\necho \"Testing IPv6...\"\n# Drops all IPv6/UDP packets coming from port 9\ntc filter add dev lo parent ffff: protocol ipv6 pref 1337 flower ip_proto \\\n\tudp src_port 9 action drop\n\n# Send 10 IPv6/UDP packets from port 8. Filter should not drop any.\n./test_flow_dissector -i 6 -f 8\n# Send 10 IPv6/UDP packets from port 9. Filter should drop all.\n./test_flow_dissector -i 6 -f 9 -F\n# Send 10 IPv6/UDP packets from port 10. Filter should not drop any.\n./test_flow_dissector -i 6 -f 10\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}