{
  "module_name": "test_xdp_veth.sh",
  "hash_id": "446a3b62d9c07fd34270fbe27190add346f4c89359b2b0ecb43a3e8bda8ca312",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_xdp_veth.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n#\n# Create 3 namespaces with 3 veth peers, and\n# forward packets in-between using native XDP\n#\n#                      XDP_TX\n# NS1(veth11)        NS2(veth22)        NS3(veth33)\n#      |                  |                  |\n#      |                  |                  |\n#   (veth1,            (veth2,            (veth3,\n#   id:111)            id:122)            id:133)\n#     ^ |                ^ |                ^ |\n#     | |  XDP_REDIRECT  | |  XDP_REDIRECT  | |\n#     | ------------------ ------------------ |\n#     -----------------------------------------\n#                    XDP_REDIRECT\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nTESTNAME=xdp_veth\nBPF_FS=$(awk '$3 == \"bpf\" {print $2; exit}' /proc/mounts)\nBPF_DIR=$BPF_FS/test_$TESTNAME\nreadonly NS1=\"ns1-$(mktemp -u XXXXXX)\"\nreadonly NS2=\"ns2-$(mktemp -u XXXXXX)\"\nreadonly NS3=\"ns3-$(mktemp -u XXXXXX)\"\n\n_cleanup()\n{\n\tset +e\n\tip link del veth1 2> /dev/null\n\tip link del veth2 2> /dev/null\n\tip link del veth3 2> /dev/null\n\tip netns del ${NS1} 2> /dev/null\n\tip netns del ${NS2} 2> /dev/null\n\tip netns del ${NS3} 2> /dev/null\n\trm -rf $BPF_DIR 2> /dev/null\n}\n\ncleanup_skip()\n{\n\techo \"selftests: $TESTNAME [SKIP]\"\n\t_cleanup\n\n\texit $ksft_skip\n}\n\ncleanup()\n{\n\tif [ \"$?\" = 0 ]; then\n\t\techo \"selftests: $TESTNAME [PASS]\"\n\telse\n\t\techo \"selftests: $TESTNAME [FAILED]\"\n\tfi\n\t_cleanup\n}\n\nif [ $(id -u) -ne 0 ]; then\n\techo \"selftests: $TESTNAME [SKIP] Need root privileges\"\n\texit $ksft_skip\nfi\n\nif ! ip link set dev lo xdp off > /dev/null 2>&1; then\n\techo \"selftests: $TESTNAME [SKIP] Could not run test without the ip xdp support\"\n\texit $ksft_skip\nfi\n\nif [ -z \"$BPF_FS\" ]; then\n\techo \"selftests: $TESTNAME [SKIP] Could not run test without bpffs mounted\"\n\texit $ksft_skip\nfi\n\nif ! bpftool version > /dev/null 2>&1; then\n\techo \"selftests: $TESTNAME [SKIP] Could not run test without bpftool\"\n\texit $ksft_skip\nfi\n\nset -e\n\ntrap cleanup_skip EXIT\n\nip netns add ${NS1}\nip netns add ${NS2}\nip netns add ${NS3}\n\nip link add veth1 index 111 type veth peer name veth11 netns ${NS1}\nip link add veth2 index 122 type veth peer name veth22 netns ${NS2}\nip link add veth3 index 133 type veth peer name veth33 netns ${NS3}\n\nip link set veth1 up\nip link set veth2 up\nip link set veth3 up\n\nip -n ${NS1} addr add 10.1.1.11/24 dev veth11\nip -n ${NS3} addr add 10.1.1.33/24 dev veth33\n\nip -n ${NS1} link set dev veth11 up\nip -n ${NS2} link set dev veth22 up\nip -n ${NS3} link set dev veth33 up\n\nmkdir $BPF_DIR\nbpftool prog loadall \\\n\txdp_redirect_map.bpf.o $BPF_DIR/progs type xdp \\\n\tpinmaps $BPF_DIR/maps\nbpftool map update pinned $BPF_DIR/maps/tx_port key 0 0 0 0 value 122 0 0 0\nbpftool map update pinned $BPF_DIR/maps/tx_port key 1 0 0 0 value 133 0 0 0\nbpftool map update pinned $BPF_DIR/maps/tx_port key 2 0 0 0 value 111 0 0 0\nip link set dev veth1 xdp pinned $BPF_DIR/progs/xdp_redirect_map_0\nip link set dev veth2 xdp pinned $BPF_DIR/progs/xdp_redirect_map_1\nip link set dev veth3 xdp pinned $BPF_DIR/progs/xdp_redirect_map_2\n\nip -n ${NS1} link set dev veth11 xdp obj xdp_dummy.bpf.o sec xdp\nip -n ${NS2} link set dev veth22 xdp obj xdp_tx.bpf.o sec xdp\nip -n ${NS3} link set dev veth33 xdp obj xdp_dummy.bpf.o sec xdp\n\ntrap cleanup EXIT\n\nip netns exec ${NS1} ping -c 1 -W 1 10.1.1.33\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}