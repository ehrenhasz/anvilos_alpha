{
  "module_name": "bind4_prog.c",
  "hash_id": "8f1e685eb06252134bbfec61a226cfb64f4041c2107e76a0c7e18930c79e0318",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/bind4_prog.c",
  "human_readable_source": "\n\n#include <string.h>\n\n#include <linux/stddef.h>\n#include <linux/bpf.h>\n#include <linux/in.h>\n#include <linux/in6.h>\n#include <linux/if.h>\n#include <errno.h>\n\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\n#define SERV4_IP\t\t0xc0a801feU  \n#define SERV4_PORT\t\t4040\n#define SERV4_REWRITE_IP\t0x7f000001U  \n#define SERV4_REWRITE_PORT\t4444\n\n#ifndef IFNAMSIZ\n#define IFNAMSIZ 16\n#endif\n\nstatic __inline int bind_to_device(struct bpf_sock_addr *ctx)\n{\n\tchar veth1[IFNAMSIZ] = \"test_sock_addr1\";\n\tchar veth2[IFNAMSIZ] = \"test_sock_addr2\";\n\tchar missing[IFNAMSIZ] = \"nonexistent_dev\";\n\tchar del_bind[IFNAMSIZ] = \"\";\n\tint veth1_idx, veth2_idx;\n\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_BINDTODEVICE,\n\t\t\t   &veth1, sizeof(veth1)))\n\t\treturn 1;\n\tif (bpf_getsockopt(ctx, SOL_SOCKET, SO_BINDTOIFINDEX,\n\t\t\t   &veth1_idx, sizeof(veth1_idx)) || !veth1_idx)\n\t\treturn 1;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_BINDTODEVICE,\n\t\t\t   &veth2, sizeof(veth2)))\n\t\treturn 1;\n\tif (bpf_getsockopt(ctx, SOL_SOCKET, SO_BINDTOIFINDEX,\n\t\t\t   &veth2_idx, sizeof(veth2_idx)) || !veth2_idx ||\n\t    veth1_idx == veth2_idx)\n\t\treturn 1;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_BINDTODEVICE,\n\t\t\t   &missing, sizeof(missing)) != -ENODEV)\n\t\treturn 1;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_BINDTOIFINDEX,\n\t\t\t   &veth1_idx, sizeof(veth1_idx)))\n\t\treturn 1;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_BINDTODEVICE,\n\t\t\t   &del_bind, sizeof(del_bind)))\n\t\treturn 1;\n\n\treturn 0;\n}\n\nstatic __inline int bind_reuseport(struct bpf_sock_addr *ctx)\n{\n\tint val = 1;\n\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_REUSEPORT,\n\t\t\t   &val, sizeof(val)))\n\t\treturn 1;\n\tif (bpf_getsockopt(ctx, SOL_SOCKET, SO_REUSEPORT,\n\t\t\t   &val, sizeof(val)) || !val)\n\t\treturn 1;\n\tval = 0;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, SO_REUSEPORT,\n\t\t\t   &val, sizeof(val)))\n\t\treturn 1;\n\tif (bpf_getsockopt(ctx, SOL_SOCKET, SO_REUSEPORT,\n\t\t\t   &val, sizeof(val)) || val)\n\t\treturn 1;\n\n\treturn 0;\n}\n\nstatic __inline int misc_opts(struct bpf_sock_addr *ctx, int opt)\n{\n\tint old, tmp, new = 0xeb9f;\n\n\t \n\tif (bpf_getsockopt(ctx, SOL_SOCKET, opt, &old, sizeof(old)) ||\n\t    old == new)\n\t\treturn 1;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, opt, &new, sizeof(new)))\n\t\treturn 1;\n\tif (bpf_getsockopt(ctx, SOL_SOCKET, opt, &tmp, sizeof(tmp)) ||\n\t    tmp != new)\n\t\treturn 1;\n\tif (bpf_setsockopt(ctx, SOL_SOCKET, opt, &old, sizeof(old)))\n\t\treturn 1;\n\n\treturn 0;\n}\n\nSEC(\"cgroup/bind4\")\nint bind_v4_prog(struct bpf_sock_addr *ctx)\n{\n\tstruct bpf_sock *sk;\n\t__u32 user_ip4;\n\t__u16 user_port;\n\n\tsk = ctx->sk;\n\tif (!sk)\n\t\treturn 0;\n\n\tif (sk->family != AF_INET)\n\t\treturn 0;\n\n\tif (ctx->type != SOCK_STREAM && ctx->type != SOCK_DGRAM)\n\t\treturn 0;\n\n\tif (ctx->user_ip4 != bpf_htonl(SERV4_IP) ||\n\t    ctx->user_port != bpf_htons(SERV4_PORT))\n\t\treturn 0;\n\n\t\n\tuser_ip4 = 0;\n\tuser_ip4 |= ((volatile __u8 *)&ctx->user_ip4)[0] << 0;\n\tuser_ip4 |= ((volatile __u8 *)&ctx->user_ip4)[1] << 8;\n\tuser_ip4 |= ((volatile __u8 *)&ctx->user_ip4)[2] << 16;\n\tuser_ip4 |= ((volatile __u8 *)&ctx->user_ip4)[3] << 24;\n\tif (ctx->user_ip4 != user_ip4)\n\t\treturn 0;\n\n\tuser_port = 0;\n\tuser_port |= ((volatile __u8 *)&ctx->user_port)[0] << 0;\n\tuser_port |= ((volatile __u8 *)&ctx->user_port)[1] << 8;\n\tif (ctx->user_port != user_port)\n\t\treturn 0;\n\n\t\n\tuser_ip4 = 0;\n\tuser_ip4 |= ((volatile __u16 *)&ctx->user_ip4)[0] << 0;\n\tuser_ip4 |= ((volatile __u16 *)&ctx->user_ip4)[1] << 16;\n\tif (ctx->user_ip4 != user_ip4)\n\t\treturn 0;\n\n\t \n\tif (bind_to_device(ctx))\n\t\treturn 0;\n\n\t \n\tif (misc_opts(ctx, SO_MARK) || misc_opts(ctx, SO_PRIORITY))\n\t\treturn 0;\n\n\t \n\tif (bind_reuseport(ctx))\n\t\treturn 0;\n\n\tctx->user_ip4 = bpf_htonl(SERV4_REWRITE_IP);\n\tctx->user_port = bpf_htons(SERV4_REWRITE_PORT);\n\n\treturn 1;\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}