{
  "module_name": "htab_mem_bench.c",
  "hash_id": "a84dbac5b75ff43b343deb002f37e5315f95e6934ac340654cf36a2425766242",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/htab_mem_bench.c",
  "human_readable_source": "\n \n#include <stdbool.h>\n#include <errno.h>\n#include <linux/types.h>\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\n#define OP_BATCH 64\n\nstruct update_ctx {\n\tunsigned int from;\n\tunsigned int step;\n};\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__uint(key_size, 4);\n\t__uint(map_flags, BPF_F_NO_PREALLOC);\n} htab SEC(\".maps\");\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nunsigned char zeroed_value[4096];\nunsigned int nr_thread = 0;\nlong op_cnt = 0;\n\nstatic int write_htab(unsigned int i, struct update_ctx *ctx, unsigned int flags)\n{\n\tbpf_map_update_elem(&htab, &ctx->from, zeroed_value, flags);\n\tctx->from += ctx->step;\n\n\treturn 0;\n}\n\nstatic int overwrite_htab(unsigned int i, struct update_ctx *ctx)\n{\n\treturn write_htab(i, ctx, 0);\n}\n\nstatic int newwrite_htab(unsigned int i, struct update_ctx *ctx)\n{\n\treturn write_htab(i, ctx, BPF_NOEXIST);\n}\n\nstatic int del_htab(unsigned int i, struct update_ctx *ctx)\n{\n\tbpf_map_delete_elem(&htab, &ctx->from);\n\tctx->from += ctx->step;\n\n\treturn 0;\n}\n\nSEC(\"?tp/syscalls/sys_enter_getpgid\")\nint overwrite(void *ctx)\n{\n\tstruct update_ctx update;\n\n\tupdate.from = bpf_get_smp_processor_id();\n\tupdate.step = nr_thread;\n\tbpf_loop(OP_BATCH, overwrite_htab, &update, 0);\n\t__sync_fetch_and_add(&op_cnt, 1);\n\treturn 0;\n}\n\nSEC(\"?tp/syscalls/sys_enter_getpgid\")\nint batch_add_batch_del(void *ctx)\n{\n\tstruct update_ctx update;\n\n\tupdate.from = bpf_get_smp_processor_id();\n\tupdate.step = nr_thread;\n\tbpf_loop(OP_BATCH, overwrite_htab, &update, 0);\n\n\tupdate.from = bpf_get_smp_processor_id();\n\tbpf_loop(OP_BATCH, del_htab, &update, 0);\n\n\t__sync_fetch_and_add(&op_cnt, 2);\n\treturn 0;\n}\n\nSEC(\"?tp/syscalls/sys_enter_getpgid\")\nint add_only(void *ctx)\n{\n\tstruct update_ctx update;\n\n\tupdate.from = bpf_get_smp_processor_id() / 2;\n\tupdate.step = nr_thread / 2;\n\tbpf_loop(OP_BATCH, newwrite_htab, &update, 0);\n\t__sync_fetch_and_add(&op_cnt, 1);\n\treturn 0;\n}\n\nSEC(\"?tp/syscalls/sys_enter_getppid\")\nint del_only(void *ctx)\n{\n\tstruct update_ctx update;\n\n\tupdate.from = bpf_get_smp_processor_id() / 2;\n\tupdate.step = nr_thread / 2;\n\tbpf_loop(OP_BATCH, del_htab, &update, 0);\n\t__sync_fetch_and_add(&op_cnt, 1);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}