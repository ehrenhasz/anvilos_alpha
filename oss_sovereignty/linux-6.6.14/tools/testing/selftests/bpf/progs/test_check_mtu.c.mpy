{
  "module_name": "test_check_mtu.c",
  "hash_id": "514114d12508a5dfe5642453fc4286519b298630c13b1d5a1fbbae25e131cab3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/test_check_mtu.c",
  "human_readable_source": "\n \n\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n#include <linux/if_ether.h>\n\n#include <stddef.h>\n#include <stdint.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\n \nvolatile const int GLOBAL_USER_MTU;\nvolatile const __u32 GLOBAL_USER_IFINDEX;\n\n \n__u32 global_bpf_mtu_xdp = 0;\n__u32 global_bpf_mtu_tc  = 0;\n\nSEC(\"xdp\")\nint xdp_use_helper_basic(struct xdp_md *ctx)\n{\n\t__u32 mtu_len = 0;\n\n\tif (bpf_check_mtu(ctx, 0, &mtu_len, 0, 0))\n\t\treturn XDP_ABORTED;\n\n\treturn XDP_PASS;\n}\n\nSEC(\"xdp\")\nint xdp_use_helper(struct xdp_md *ctx)\n{\n\tint retval = XDP_PASS;  \n\t__u32 mtu_len = 0;\n\t__u32 ifindex = 0;\n\tint delta = 0;\n\n\t \n\tif (GLOBAL_USER_IFINDEX > 0)\n\t\tifindex = GLOBAL_USER_IFINDEX;\n\n\tif (bpf_check_mtu(ctx, ifindex, &mtu_len, delta, 0)) {\n\t\t \n\t\tretval = XDP_ABORTED;\n\t\tgoto out;\n\t}\n\n\tif (mtu_len != GLOBAL_USER_MTU)\n\t\tretval = XDP_DROP;\n\nout:\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"xdp\")\nint xdp_exceed_mtu(struct xdp_md *ctx)\n{\n\tvoid *data_end = (void *)(long)ctx->data_end;\n\tvoid *data = (void *)(long)ctx->data;\n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\t__u32 data_len = data_end - data;\n\tint retval = XDP_ABORTED;  \n\t__u32 mtu_len = 0;\n\tint delta;\n\tint err;\n\n\t \n\tdelta = GLOBAL_USER_MTU - (data_len - ETH_HLEN) + 1;\n\n\terr = bpf_check_mtu(ctx, ifindex, &mtu_len, delta, 0);\n\tif (err) {\n\t\tretval = XDP_PASS;  \n\t\tif (err != BPF_MTU_CHK_RET_FRAG_NEEDED)\n\t\t\tretval = XDP_DROP;\n\t}\n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"xdp\")\nint xdp_minus_delta(struct xdp_md *ctx)\n{\n\tint retval = XDP_PASS;  \n\tvoid *data_end = (void *)(long)ctx->data_end;\n\tvoid *data = (void *)(long)ctx->data;\n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\t__u32 data_len = data_end - data;\n\t__u32 mtu_len = 0;\n\tint delta;\n\n\t \n\tdelta = -((data_len - ETH_HLEN) + 1);\n\n\t \n\tif (bpf_check_mtu(ctx, ifindex, &mtu_len, delta, 0))\n\t\tretval = XDP_ABORTED;\n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"xdp\")\nint xdp_input_len(struct xdp_md *ctx)\n{\n\tint retval = XDP_PASS;  \n\tvoid *data_end = (void *)(long)ctx->data_end;\n\tvoid *data = (void *)(long)ctx->data;\n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\t__u32 data_len = data_end - data;\n\n\t \n\t__u32 mtu_len = data_len - ETH_HLEN;\n\n\tif (bpf_check_mtu(ctx, ifindex, &mtu_len, 0, 0))\n\t\tretval = XDP_ABORTED;\n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"xdp\")\nint xdp_input_len_exceed(struct xdp_md *ctx)\n{\n\tint retval = XDP_ABORTED;  \n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\tint err;\n\n\t \n\t__u32 mtu_len = GLOBAL_USER_MTU;\n\n\tmtu_len += 1;  \n\n\terr = bpf_check_mtu(ctx, ifindex, &mtu_len, 0, 0);\n\tif (err == BPF_MTU_CHK_RET_FRAG_NEEDED)\n\t\tretval = XDP_PASS ;  \n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"tc\")\nint tc_use_helper(struct __sk_buff *ctx)\n{\n\tint retval = BPF_OK;  \n\t__u32 mtu_len = 0;\n\tint delta = 0;\n\n\tif (bpf_check_mtu(ctx, 0, &mtu_len, delta, 0)) {\n\t\tretval = BPF_DROP;\n\t\tgoto out;\n\t}\n\n\tif (mtu_len != GLOBAL_USER_MTU)\n\t\tretval = BPF_REDIRECT;\nout:\n\tglobal_bpf_mtu_tc = mtu_len;\n\treturn retval;\n}\n\nSEC(\"tc\")\nint tc_exceed_mtu(struct __sk_buff *ctx)\n{\n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\tint retval = BPF_DROP;  \n\t__u32 skb_len = ctx->len;\n\t__u32 mtu_len = 0;\n\tint delta;\n\tint err;\n\n\t \n\tdelta = GLOBAL_USER_MTU - (skb_len - ETH_HLEN) + 1;\n\n\terr = bpf_check_mtu(ctx, ifindex, &mtu_len, delta, 0);\n\tif (err) {\n\t\tretval = BPF_OK;  \n\t\tif (err != BPF_MTU_CHK_RET_FRAG_NEEDED)\n\t\t\tretval = BPF_DROP;\n\t}\n\n\tglobal_bpf_mtu_tc = mtu_len;\n\treturn retval;\n}\n\nSEC(\"tc\")\nint tc_exceed_mtu_da(struct __sk_buff *ctx)\n{\n\t \n\tvoid *data_end = (void *)(long)ctx->data_end;\n\tvoid *data = (void *)(long)ctx->data;\n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\t__u32 data_len = data_end - data;\n\tint retval = BPF_DROP;  \n\t__u32 mtu_len = 0;\n\tint delta;\n\tint err;\n\n\t \n\tdelta = GLOBAL_USER_MTU - (data_len - ETH_HLEN) + 1;\n\n\terr = bpf_check_mtu(ctx, ifindex, &mtu_len, delta, 0);\n\tif (err) {\n\t\tretval = BPF_OK;  \n\t\tif (err != BPF_MTU_CHK_RET_FRAG_NEEDED)\n\t\t\tretval = BPF_DROP;\n\t}\n\n\tglobal_bpf_mtu_tc = mtu_len;\n\treturn retval;\n}\n\nSEC(\"tc\")\nint tc_minus_delta(struct __sk_buff *ctx)\n{\n\tint retval = BPF_OK;  \n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\t__u32 skb_len = ctx->len;\n\t__u32 mtu_len = 0;\n\tint delta;\n\n\t \n\tdelta = -((skb_len - ETH_HLEN) + 1);\n\n\t \n\tif (bpf_check_mtu(ctx, ifindex, &mtu_len, delta, 0))\n\t\tretval = BPF_DROP;\n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"tc\")\nint tc_input_len(struct __sk_buff *ctx)\n{\n\tint retval = BPF_OK;  \n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\n\t \n\t__u32 mtu_len = GLOBAL_USER_MTU;\n\n\tif (bpf_check_mtu(ctx, ifindex, &mtu_len, 0, 0))\n\t\tretval = BPF_DROP;\n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n\nSEC(\"tc\")\nint tc_input_len_exceed(struct __sk_buff *ctx)\n{\n\tint retval = BPF_DROP;  \n\t__u32 ifindex = GLOBAL_USER_IFINDEX;\n\tint err;\n\n\t \n\t__u32 mtu_len = GLOBAL_USER_MTU;\n\n\tmtu_len += 1;  \n\n\terr = bpf_check_mtu(ctx, ifindex, &mtu_len, 0, 0);\n\tif (err == BPF_MTU_CHK_RET_FRAG_NEEDED)\n\t\tretval = BPF_OK;  \n\n\tglobal_bpf_mtu_xdp = mtu_len;\n\treturn retval;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}