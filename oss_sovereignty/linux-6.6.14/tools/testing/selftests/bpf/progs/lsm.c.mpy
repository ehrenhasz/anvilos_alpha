{
  "module_name": "lsm.c",
  "hash_id": "cc33a4645354df8114b16f54a2913a471d913d90e51569fa06b3c1e87a0166d9",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/lsm.c",
  "human_readable_source": "\n\n \n\n#include \"vmlinux.h\"\n#include <errno.h>\n#include <bpf/bpf_core_read.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n#include \"bpf_misc.h\"\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_ARRAY);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} array SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} hash SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_LRU_HASH);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} lru_hash SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} percpu_array SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_PERCPU_HASH);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} percpu_hash SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_LRU_PERCPU_HASH);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} lru_percpu_hash SEC(\".maps\");\n\nstruct inner_map {\n\t__uint(type, BPF_MAP_TYPE_ARRAY);\n\t__uint(max_entries, 1);\n\t__type(key, int);\n\t__type(value, __u64);\n} inner_map SEC(\".maps\");\n\nstruct outer_arr {\n\t__uint(type, BPF_MAP_TYPE_ARRAY_OF_MAPS);\n\t__uint(max_entries, 1);\n\t__uint(key_size, sizeof(int));\n\t__uint(value_size, sizeof(int));\n\t__array(values, struct inner_map);\n} outer_arr SEC(\".maps\") = {\n\t.values = { [0] = &inner_map },\n};\n\nstruct outer_hash {\n\t__uint(type, BPF_MAP_TYPE_HASH_OF_MAPS);\n\t__uint(max_entries, 1);\n\t__uint(key_size, sizeof(int));\n\t__array(values, struct inner_map);\n} outer_hash SEC(\".maps\") = {\n\t.values = { [0] = &inner_map },\n};\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nint monitored_pid = 0;\nint mprotect_count = 0;\nint bprm_count = 0;\n\nSEC(\"lsm/file_mprotect\")\nint BPF_PROG(test_int_hook, struct vm_area_struct *vma,\n\t     unsigned long reqprot, unsigned long prot, int ret)\n{\n\tif (ret != 0)\n\t\treturn ret;\n\n\t__u32 pid = bpf_get_current_pid_tgid() >> 32;\n\tint is_stack = 0;\n\n\tis_stack = (vma->vm_start <= vma->vm_mm->start_stack &&\n\t\t    vma->vm_end >= vma->vm_mm->start_stack);\n\n\tif (is_stack && monitored_pid == pid) {\n\t\tmprotect_count++;\n\t\tret = -EPERM;\n\t}\n\n\treturn ret;\n}\n\nSEC(\"lsm.s/bprm_committed_creds\")\nint BPF_PROG(test_void_hook, struct linux_binprm *bprm)\n{\n\t__u32 pid = bpf_get_current_pid_tgid() >> 32;\n\tstruct inner_map *inner_map;\n\tchar args[64];\n\t__u32 key = 0;\n\t__u64 *value;\n\n\tif (monitored_pid == pid)\n\t\tbprm_count++;\n\n\tbpf_copy_from_user(args, sizeof(args), (void *)bprm->vma->vm_mm->arg_start);\n\tbpf_copy_from_user(args, sizeof(args), (void *)bprm->mm->arg_start);\n\n\tvalue = bpf_map_lookup_elem(&array, &key);\n\tif (value)\n\t\t*value = 0;\n\tvalue = bpf_map_lookup_elem(&hash, &key);\n\tif (value)\n\t\t*value = 0;\n\tvalue = bpf_map_lookup_elem(&lru_hash, &key);\n\tif (value)\n\t\t*value = 0;\n\tvalue = bpf_map_lookup_elem(&percpu_array, &key);\n\tif (value)\n\t\t*value = 0;\n\tvalue = bpf_map_lookup_elem(&percpu_hash, &key);\n\tif (value)\n\t\t*value = 0;\n\tvalue = bpf_map_lookup_elem(&lru_percpu_hash, &key);\n\tif (value)\n\t\t*value = 0;\n\tinner_map = bpf_map_lookup_elem(&outer_arr, &key);\n\tif (inner_map) {\n\t\tvalue = bpf_map_lookup_elem(inner_map, &key);\n\t\tif (value)\n\t\t\t*value = 0;\n\t}\n\tinner_map = bpf_map_lookup_elem(&outer_hash, &key);\n\tif (inner_map) {\n\t\tvalue = bpf_map_lookup_elem(inner_map, &key);\n\t\tif (value)\n\t\t\t*value = 0;\n\t}\n\n\treturn 0;\n}\nSEC(\"lsm/task_free\")  \nint BPF_PROG(test_task_free, struct task_struct *task)\n{\n\treturn 0;\n}\n\nint copy_test = 0;\n\nSEC(\"fentry.s/\" SYS_PREFIX \"sys_setdomainname\")\nint BPF_PROG(test_sys_setdomainname, struct pt_regs *regs)\n{\n\tvoid *ptr = (void *)PT_REGS_PARM1_SYSCALL(regs);\n\tint len = PT_REGS_PARM2_SYSCALL(regs);\n\tint buf = 0;\n\tlong ret;\n\n\tret = bpf_copy_from_user(&buf, sizeof(buf), ptr);\n\tif (len == -2 && ret == 0 && buf == 1234)\n\t\tcopy_test++;\n\tif (len == -3 && ret == -EFAULT)\n\t\tcopy_test++;\n\tif (len == -4 && ret == -EFAULT)\n\t\tcopy_test++;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}