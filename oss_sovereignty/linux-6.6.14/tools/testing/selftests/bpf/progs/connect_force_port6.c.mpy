{
  "module_name": "connect_force_port6.c",
  "hash_id": "08007516a5bc08e2fcdc917cf8f862aa9d1fdca724912b52a8b1f83f405780bc",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/connect_force_port6.c",
  "human_readable_source": "\n#include <string.h>\n\n#include <linux/bpf.h>\n#include <linux/in.h>\n#include <linux/in6.h>\n#include <sys/socket.h>\n\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\n#include <bpf_sockopt_helpers.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nstruct svc_addr {\n\t__be32 addr[4];\n\t__be16 port;\n};\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_SK_STORAGE);\n\t__uint(map_flags, BPF_F_NO_PREALLOC);\n\t__type(key, int);\n\t__type(value, struct svc_addr);\n} service_mapping SEC(\".maps\");\n\nSEC(\"cgroup/connect6\")\nint connect6(struct bpf_sock_addr *ctx)\n{\n\tstruct sockaddr_in6 sa = {};\n\tstruct svc_addr *orig;\n\n\t \n\tsa.sin6_family = AF_INET6;\n\tsa.sin6_port = bpf_htons(22223);\n\tsa.sin6_addr.s6_addr32[3] = bpf_htonl(1);\n\n\tif (bpf_bind(ctx, (struct sockaddr *)&sa, sizeof(sa)) != 0)\n\t\treturn 0;\n\n\t \n\tif (ctx->user_port == bpf_htons(60000)) {\n\t\torig = bpf_sk_storage_get(&service_mapping, ctx->sk, 0,\n\t\t\t\t\t  BPF_SK_STORAGE_GET_F_CREATE);\n\t\tif (!orig)\n\t\t\treturn 0;\n\n\t\torig->addr[0] = ctx->user_ip6[0];\n\t\torig->addr[1] = ctx->user_ip6[1];\n\t\torig->addr[2] = ctx->user_ip6[2];\n\t\torig->addr[3] = ctx->user_ip6[3];\n\t\torig->port = ctx->user_port;\n\n\t\tctx->user_ip6[0] = 0;\n\t\tctx->user_ip6[1] = 0;\n\t\tctx->user_ip6[2] = 0;\n\t\tctx->user_ip6[3] = bpf_htonl(1);\n\t\tctx->user_port = bpf_htons(60124);\n\t}\n\treturn 1;\n}\n\nSEC(\"cgroup/getsockname6\")\nint getsockname6(struct bpf_sock_addr *ctx)\n{\n\tif (!get_set_sk_priority(ctx))\n\t\treturn 1;\n\n\t \n\tif (ctx->user_port == bpf_htons(60124)) {\n\t\tctx->user_ip6[0] = bpf_htonl(0xfc000000);\n\t\tctx->user_ip6[1] = 0;\n\t\tctx->user_ip6[2] = 0;\n\t\tctx->user_ip6[3] = bpf_htonl(1);\n\t\tctx->user_port = bpf_htons(60000);\n\t}\n\treturn 1;\n}\n\nSEC(\"cgroup/getpeername6\")\nint getpeername6(struct bpf_sock_addr *ctx)\n{\n\tstruct svc_addr *orig;\n\n\tif (!get_set_sk_priority(ctx))\n\t\treturn 1;\n\n\t \n\tif (ctx->user_port == bpf_htons(60124)) {\n\t\torig = bpf_sk_storage_get(&service_mapping, ctx->sk, 0, 0);\n\t\tif (orig) {\n\t\t\tctx->user_ip6[0] = orig->addr[0];\n\t\t\tctx->user_ip6[1] = orig->addr[1];\n\t\t\tctx->user_ip6[2] = orig->addr[2];\n\t\t\tctx->user_ip6[3] = orig->addr[3];\n\t\t\tctx->user_port = orig->port;\n\t\t}\n\t}\n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}