{
  "module_name": "decap_sanity.c",
  "hash_id": "a6705d9837fc3fbc334580802514bde8827cfe575738495dd1c3ffdf85bb66ca",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/decap_sanity.c",
  "human_readable_source": "\n \n\n#include \"vmlinux.h\"\n#include \"bpf_tracing_net.h\"\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\n#define UDP_TEST_PORT 7777\n\nvoid *bpf_cast_to_kern_ctx(void *) __ksym;\nbool init_csum_partial = false;\nbool final_csum_none = false;\nbool broken_csum_start = false;\n\nstatic unsigned int skb_headlen(const struct sk_buff *skb)\n{\n\treturn skb->len - skb->data_len;\n}\n\nstatic unsigned int skb_headroom(const struct sk_buff *skb)\n{\n\treturn skb->data - skb->head;\n}\n\nstatic int skb_checksum_start_offset(const struct sk_buff *skb)\n{\n\treturn skb->csum_start - skb_headroom(skb);\n}\n\nSEC(\"tc\")\nint decap_sanity(struct __sk_buff *skb)\n{\n\tstruct sk_buff *kskb;\n\tstruct ipv6hdr ip6h;\n\tstruct udphdr udph;\n\tint err;\n\n\tif (skb->protocol != __bpf_constant_htons(ETH_P_IPV6))\n\t\treturn TC_ACT_SHOT;\n\n\tif (bpf_skb_load_bytes(skb, ETH_HLEN, &ip6h, sizeof(ip6h)))\n\t\treturn TC_ACT_SHOT;\n\n\tif (ip6h.nexthdr != IPPROTO_UDP)\n\t\treturn TC_ACT_SHOT;\n\n\tif (bpf_skb_load_bytes(skb, ETH_HLEN + sizeof(ip6h), &udph, sizeof(udph)))\n\t\treturn TC_ACT_SHOT;\n\n\tif (udph.dest != __bpf_constant_htons(UDP_TEST_PORT))\n\t\treturn TC_ACT_SHOT;\n\n\tkskb = bpf_cast_to_kern_ctx(skb);\n\tinit_csum_partial = (kskb->ip_summed == CHECKSUM_PARTIAL);\n\terr = bpf_skb_adjust_room(skb, -(s32)(ETH_HLEN + sizeof(ip6h) + sizeof(udph)),\n\t\t\t\t  1, BPF_F_ADJ_ROOM_FIXED_GSO);\n\tif (err)\n\t\treturn TC_ACT_SHOT;\n\tfinal_csum_none = (kskb->ip_summed == CHECKSUM_NONE);\n\tif (kskb->ip_summed == CHECKSUM_PARTIAL &&\n\t    (unsigned int)skb_checksum_start_offset(kskb) >= skb_headlen(kskb))\n\t\tbroken_csum_start = true;\n\n\treturn TC_ACT_SHOT;\n}\n\nchar __license[] SEC(\"license\") = \"GPL\";\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}