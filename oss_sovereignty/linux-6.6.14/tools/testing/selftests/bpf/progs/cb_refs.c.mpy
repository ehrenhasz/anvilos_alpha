{
  "module_name": "cb_refs.c",
  "hash_id": "f77d55dd836befaa95725b5facf09ca24f0e482c40b96119737c00b407cf0b87",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/cb_refs.c",
  "human_readable_source": "\n#include <vmlinux.h>\n#include <bpf/bpf_tracing.h>\n#include <bpf/bpf_helpers.h>\n#include \"../bpf_testmod/bpf_testmod_kfunc.h\"\n\nstruct map_value {\n\tstruct prog_test_ref_kfunc __kptr *ptr;\n};\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_ARRAY);\n\t__type(key, int);\n\t__type(value, struct map_value);\n\t__uint(max_entries, 16);\n} array_map SEC(\".maps\");\n\nstatic __noinline int cb1(void *map, void *key, void *value, void *ctx)\n{\n\tvoid *p = *(void **)ctx;\n\tbpf_kfunc_call_test_release(p);\n\t \n\treturn 0;\n}\n\nSEC(\"?tc\")\nint underflow_prog(void *ctx)\n{\n\tstruct prog_test_ref_kfunc *p;\n\tunsigned long sl = 0;\n\n\tp = bpf_kfunc_call_test_acquire(&sl);\n\tif (!p)\n\t\treturn 0;\n\tbpf_for_each_map_elem(&array_map, cb1, &p, 0);\n\treturn 0;\n}\n\nstatic __always_inline int cb2(void *map, void *key, void *value, void *ctx)\n{\n\tunsigned long sl = 0;\n\n\t*(void **)ctx = bpf_kfunc_call_test_acquire(&sl);\n\t \n\treturn 0;\n}\n\nSEC(\"?tc\")\nint leak_prog(void *ctx)\n{\n\tstruct prog_test_ref_kfunc *p;\n\tstruct map_value *v;\n\n\tv = bpf_map_lookup_elem(&array_map, &(int){0});\n\tif (!v)\n\t\treturn 0;\n\n\tp = NULL;\n\tbpf_for_each_map_elem(&array_map, cb2, &p, 0);\n\tp = bpf_kptr_xchg(&v->ptr, p);\n\tif (p)\n\t\tbpf_kfunc_call_test_release(p);\n\treturn 0;\n}\n\nstatic __always_inline int cb(void *map, void *key, void *value, void *ctx)\n{\n\treturn 0;\n}\n\nstatic __always_inline int cb3(void *map, void *key, void *value, void *ctx)\n{\n\tunsigned long sl = 0;\n\tvoid *p;\n\n\tbpf_kfunc_call_test_acquire(&sl);\n\tbpf_for_each_map_elem(&array_map, cb, &p, 0);\n\t \n\treturn 0;\n}\n\nSEC(\"?tc\")\nint nested_cb(void *ctx)\n{\n\tstruct prog_test_ref_kfunc *p;\n\tunsigned long sl = 0;\n\tint sp = 0;\n\n\tp = bpf_kfunc_call_test_acquire(&sl);\n\tif (!p)\n\t\treturn 0;\n\tbpf_for_each_map_elem(&array_map, cb3, &sp, 0);\n\tbpf_kfunc_call_test_release(p);\n\treturn 0;\n}\n\nSEC(\"?tc\")\nint non_cb_transfer_ref(void *ctx)\n{\n\tstruct prog_test_ref_kfunc *p;\n\tunsigned long sl = 0;\n\n\tp = bpf_kfunc_call_test_acquire(&sl);\n\tif (!p)\n\t\treturn 0;\n\tcb1(NULL, NULL, NULL, &p);\n\tbpf_kfunc_call_test_acquire(&sl);\n\treturn 0;\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}