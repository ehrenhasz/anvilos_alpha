{
  "module_name": "bpf_iter_tcp6.c",
  "hash_id": "204f1f39509505e74eccd90fd58a786f339832ba05968793118b89a9eaf401ce",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/bpf_iter_tcp6.c",
  "human_readable_source": "\n \n#include \"bpf_iter.h\"\n#include \"bpf_tracing_net.h\"\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nstatic int hlist_unhashed_lockless(const struct hlist_node *h)\n{\n        return !(h->pprev);\n}\n\nstatic int timer_pending(const struct timer_list * timer)\n{\n\treturn !hlist_unhashed_lockless(&timer->entry);\n}\n\nextern unsigned CONFIG_HZ __kconfig;\n\n#define USER_HZ\t\t100\n#define NSEC_PER_SEC\t1000000000ULL\nstatic clock_t jiffies_to_clock_t(unsigned long x)\n{\n\t \n\tu64 tick_nsec = (NSEC_PER_SEC + CONFIG_HZ/2) / CONFIG_HZ;\n\tu64 user_hz_nsec = NSEC_PER_SEC / USER_HZ;\n\n\tif ((tick_nsec % user_hz_nsec) == 0) {\n\t\tif (CONFIG_HZ < USER_HZ)\n\t\t\treturn x * (USER_HZ / CONFIG_HZ);\n\t\telse\n\t\t\treturn x / (CONFIG_HZ / USER_HZ);\n\t}\n\treturn x * tick_nsec/user_hz_nsec;\n}\n\nstatic clock_t jiffies_delta_to_clock_t(long delta)\n{\n\tif (delta <= 0)\n\t\treturn 0;\n\n\treturn jiffies_to_clock_t(delta);\n}\n\nstatic long sock_i_ino(const struct sock *sk)\n{\n\tconst struct socket *sk_socket = sk->sk_socket;\n\tconst struct inode *inode;\n\tunsigned long ino;\n\n\tif (!sk_socket)\n\t\treturn 0;\n\n\tinode = &container_of(sk_socket, struct socket_alloc, socket)->vfs_inode;\n\tbpf_probe_read_kernel(&ino, sizeof(ino), &inode->i_ino);\n\treturn ino;\n}\n\nstatic bool\ninet_csk_in_pingpong_mode(const struct inet_connection_sock *icsk)\n{\n\treturn icsk->icsk_ack.pingpong >= TCP_PINGPONG_THRESH;\n}\n\nstatic bool tcp_in_initial_slowstart(const struct tcp_sock *tcp)\n{\n\treturn tcp->snd_ssthresh >= TCP_INFINITE_SSTHRESH;\n}\n\nstatic int dump_tcp6_sock(struct seq_file *seq, struct tcp6_sock *tp,\n\t\t\t uid_t uid, __u32 seq_num)\n{\n\tconst struct inet_connection_sock *icsk;\n\tconst struct fastopen_queue *fastopenq;\n\tconst struct in6_addr *dest, *src;\n\tconst struct inet_sock *inet;\n\tunsigned long timer_expires;\n\tconst struct sock *sp;\n\t__u16 destp, srcp;\n\tint timer_active;\n\tint rx_queue;\n\tint state;\n\n\ticsk = &tp->tcp.inet_conn;\n\tinet = &icsk->icsk_inet;\n\tsp = &inet->sk;\n\tfastopenq = &icsk->icsk_accept_queue.fastopenq;\n\n\tdest = &sp->sk_v6_daddr;\n\tsrc = &sp->sk_v6_rcv_saddr;\n\tdestp = bpf_ntohs(inet->inet_dport);\n\tsrcp = bpf_ntohs(inet->inet_sport);\n\n\tif (icsk->icsk_pending == ICSK_TIME_RETRANS ||\n\t    icsk->icsk_pending == ICSK_TIME_REO_TIMEOUT ||\n\t    icsk->icsk_pending == ICSK_TIME_LOSS_PROBE) {\n\t\ttimer_active = 1;\n\t\ttimer_expires = icsk->icsk_timeout;\n\t} else if (icsk->icsk_pending == ICSK_TIME_PROBE0) {\n\t\ttimer_active = 4;\n\t\ttimer_expires = icsk->icsk_timeout;\n\t} else if (timer_pending(&sp->sk_timer)) {\n\t\ttimer_active = 2;\n\t\ttimer_expires = sp->sk_timer.expires;\n\t} else {\n\t\ttimer_active = 0;\n\t\ttimer_expires = bpf_jiffies64();\n\t}\n\n\tstate = sp->sk_state;\n\tif (state == TCP_LISTEN) {\n\t\trx_queue = sp->sk_ack_backlog;\n\t} else {\n\t\trx_queue = tp->tcp.rcv_nxt - tp->tcp.copied_seq;\n\t\tif (rx_queue < 0)\n\t\t\trx_queue = 0;\n\t}\n\n\tBPF_SEQ_PRINTF(seq, \"%4d: %08X%08X%08X%08X:%04X %08X%08X%08X%08X:%04X \",\n\t\t       seq_num,\n\t\t       src->s6_addr32[0], src->s6_addr32[1],\n\t\t       src->s6_addr32[2], src->s6_addr32[3], srcp,\n\t\t       dest->s6_addr32[0], dest->s6_addr32[1],\n\t\t       dest->s6_addr32[2], dest->s6_addr32[3], destp);\n\tBPF_SEQ_PRINTF(seq, \"%02X %08X:%08X %02X:%08lX %08X %5u %8d %lu %d \",\n\t\t       state,\n\t\t       tp->tcp.write_seq - tp->tcp.snd_una, rx_queue,\n\t\t       timer_active,\n\t\t       jiffies_delta_to_clock_t(timer_expires - bpf_jiffies64()),\n\t\t       icsk->icsk_retransmits, uid,\n\t\t       icsk->icsk_probes_out,\n\t\t       sock_i_ino(sp),\n\t\t       sp->sk_refcnt.refs.counter);\n\tBPF_SEQ_PRINTF(seq, \"%pK %lu %lu %u %u %d\\n\",\n\t\t       tp,\n\t\t       jiffies_to_clock_t(icsk->icsk_rto),\n\t\t       jiffies_to_clock_t(icsk->icsk_ack.ato),\n\t\t       (icsk->icsk_ack.quick << 1) | inet_csk_in_pingpong_mode(icsk),\n\t\t       tp->tcp.snd_cwnd,\n\t\t       state == TCP_LISTEN ? fastopenq->max_qlen\n\t\t\t\t: (tcp_in_initial_slowstart(&tp->tcp) ? -1\n\t\t\t\t\t\t\t\t      : tp->tcp.snd_ssthresh)\n\t\t      );\n\n\treturn 0;\n}\n\nstatic int dump_tw_sock(struct seq_file *seq, struct tcp_timewait_sock *ttw,\n\t\t\tuid_t uid, __u32 seq_num)\n{\n\tstruct inet_timewait_sock *tw = &ttw->tw_sk;\n\tconst struct in6_addr *dest, *src;\n\t__u16 destp, srcp;\n\tlong delta;\n\n\tdelta = tw->tw_timer.expires - bpf_jiffies64();\n\tdest = &tw->tw_v6_daddr;\n\tsrc  = &tw->tw_v6_rcv_saddr;\n\tdestp = bpf_ntohs(tw->tw_dport);\n\tsrcp  = bpf_ntohs(tw->tw_sport);\n\n\tBPF_SEQ_PRINTF(seq, \"%4d: %08X%08X%08X%08X:%04X %08X%08X%08X%08X:%04X \",\n\t\t       seq_num,\n\t\t       src->s6_addr32[0], src->s6_addr32[1],\n\t\t       src->s6_addr32[2], src->s6_addr32[3], srcp,\n\t\t       dest->s6_addr32[0], dest->s6_addr32[1],\n\t\t       dest->s6_addr32[2], dest->s6_addr32[3], destp);\n\n\tBPF_SEQ_PRINTF(seq, \"%02X %08X:%08X %02X:%08lX %08X %5d %8d %d %d %pK\\n\",\n\t\t       tw->tw_substate, 0, 0,\n\t\t       3, jiffies_delta_to_clock_t(delta), 0, 0, 0, 0,\n\t\t       tw->tw_refcnt.refs.counter, tw);\n\n\treturn 0;\n}\n\nstatic int dump_req_sock(struct seq_file *seq, struct tcp_request_sock *treq,\n\t\t\t uid_t uid, __u32 seq_num)\n{\n\tstruct inet_request_sock *irsk = &treq->req;\n\tstruct request_sock *req = &irsk->req;\n\tstruct in6_addr *src, *dest;\n\tlong ttd;\n\n\tttd = req->rsk_timer.expires - bpf_jiffies64();\n\tsrc = &irsk->ir_v6_loc_addr;\n\tdest = &irsk->ir_v6_rmt_addr;\n\n\tif (ttd < 0)\n\t\tttd = 0;\n\n\tBPF_SEQ_PRINTF(seq, \"%4d: %08X%08X%08X%08X:%04X %08X%08X%08X%08X:%04X \",\n\t\t       seq_num,\n\t\t       src->s6_addr32[0], src->s6_addr32[1],\n\t\t       src->s6_addr32[2], src->s6_addr32[3],\n\t\t       irsk->ir_num,\n\t\t       dest->s6_addr32[0], dest->s6_addr32[1],\n\t\t       dest->s6_addr32[2], dest->s6_addr32[3],\n\t\t       bpf_ntohs(irsk->ir_rmt_port));\n\tBPF_SEQ_PRINTF(seq, \"%02X %08X:%08X %02X:%08lX %08X %5d %8d %d %d %pK\\n\",\n\t\t       TCP_SYN_RECV, 0, 0, 1, jiffies_to_clock_t(ttd),\n\t\t       req->num_timeout, uid, 0, 0, 0, req);\n\n\treturn 0;\n}\n\nSEC(\"iter/tcp\")\nint dump_tcp6(struct bpf_iter__tcp *ctx)\n{\n\tstruct sock_common *sk_common = ctx->sk_common;\n\tstruct seq_file *seq = ctx->meta->seq;\n\tstruct tcp_timewait_sock *tw;\n\tstruct tcp_request_sock *req;\n\tstruct tcp6_sock *tp;\n\tuid_t uid = ctx->uid;\n\t__u32 seq_num;\n\n\tif (sk_common == (void *)0)\n\t\treturn 0;\n\n\tseq_num = ctx->meta->seq_num;\n\tif (seq_num == 0)\n\t\tBPF_SEQ_PRINTF(seq, \"  sl  \"\n\t\t\t\t    \"local_address                         \"\n\t\t\t\t    \"remote_address                        \"\n\t\t\t\t    \"st tx_queue rx_queue tr tm->when retrnsmt\"\n\t\t\t\t    \"   uid  timeout inode\\n\");\n\n\tif (sk_common->skc_family != AF_INET6)\n\t\treturn 0;\n\n\ttp = bpf_skc_to_tcp6_sock(sk_common);\n\tif (tp)\n\t\treturn dump_tcp6_sock(seq, tp, uid, seq_num);\n\n\ttw = bpf_skc_to_tcp_timewait_sock(sk_common);\n\tif (tw)\n\t\treturn dump_tw_sock(seq, tw, uid, seq_num);\n\n\treq = bpf_skc_to_tcp_request_sock(sk_common);\n\tif (req)\n\t\treturn dump_req_sock(seq, req, uid, seq_num);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}