{
  "module_name": "ima.c",
  "hash_id": "84fc353535b5d13cbdfb5a539cb1a166742fc635d15f598a43392d9f4aecb1cd",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/ima.c",
  "human_readable_source": "\n\n \n\n#include \"vmlinux.h\"\n#include <errno.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\nu32 monitored_pid = 0;\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_RINGBUF);\n\t__uint(max_entries, 1 << 12);\n} ringbuf SEC(\".maps\");\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nbool use_ima_file_hash;\nbool enable_bprm_creds_for_exec;\nbool enable_kernel_read_file;\nbool test_deny;\n\nstatic void ima_test_common(struct file *file)\n{\n\tu64 ima_hash = 0;\n\tu64 *sample;\n\tint ret;\n\tu32 pid;\n\n\tpid = bpf_get_current_pid_tgid() >> 32;\n\tif (pid == monitored_pid) {\n\t\tif (!use_ima_file_hash)\n\t\t\tret = bpf_ima_inode_hash(file->f_inode, &ima_hash,\n\t\t\t\t\t\t sizeof(ima_hash));\n\t\telse\n\t\t\tret = bpf_ima_file_hash(file, &ima_hash,\n\t\t\t\t\t\tsizeof(ima_hash));\n\t\tif (ret < 0 || ima_hash == 0)\n\t\t\treturn;\n\n\t\tsample = bpf_ringbuf_reserve(&ringbuf, sizeof(u64), 0);\n\t\tif (!sample)\n\t\t\treturn;\n\n\t\t*sample = ima_hash;\n\t\tbpf_ringbuf_submit(sample, 0);\n\t}\n\n\treturn;\n}\n\nstatic int ima_test_deny(void)\n{\n\tu32 pid;\n\n\tpid = bpf_get_current_pid_tgid() >> 32;\n\tif (pid == monitored_pid && test_deny)\n\t\treturn -EPERM;\n\n\treturn 0;\n}\n\nSEC(\"lsm.s/bprm_committed_creds\")\nvoid BPF_PROG(bprm_committed_creds, struct linux_binprm *bprm)\n{\n\tima_test_common(bprm->file);\n}\n\nSEC(\"lsm.s/bprm_creds_for_exec\")\nint BPF_PROG(bprm_creds_for_exec, struct linux_binprm *bprm)\n{\n\tif (!enable_bprm_creds_for_exec)\n\t\treturn 0;\n\n\tima_test_common(bprm->file);\n\treturn 0;\n}\n\nSEC(\"lsm.s/kernel_read_file\")\nint BPF_PROG(kernel_read_file, struct file *file, enum kernel_read_file_id id,\n\t     bool contents)\n{\n\tint ret;\n\n\tif (!enable_kernel_read_file)\n\t\treturn 0;\n\n\tif (!contents)\n\t\treturn 0;\n\n\tif (id != READING_POLICY)\n\t\treturn 0;\n\n\tret = ima_test_deny();\n\tif (ret < 0)\n\t\treturn ret;\n\n\tima_test_common(file);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}