{
  "module_name": "lsm_cgroup.c",
  "hash_id": "582a1ded669e4481916b8cc98567f6b663d2b1b58f3c8766d9048c4b0c061ded",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/lsm_cgroup.c",
  "human_readable_source": "\n\n#include \"vmlinux.h\"\n#include \"bpf_tracing_net.h\"\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nextern bool CONFIG_SECURITY_SELINUX __kconfig __weak;\nextern bool CONFIG_SECURITY_SMACK __kconfig __weak;\nextern bool CONFIG_SECURITY_APPARMOR __kconfig __weak;\n\n#ifndef AF_PACKET\n#define AF_PACKET 17\n#endif\n\n#ifndef AF_UNIX\n#define AF_UNIX 1\n#endif\n\n#ifndef EPERM\n#define EPERM 1\n#endif\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_CGROUP_STORAGE);\n\t__type(key, __u64);\n\t__type(value, __u64);\n} cgroup_storage SEC(\".maps\");\n\nint called_socket_post_create;\nint called_socket_post_create2;\nint called_socket_bind;\nint called_socket_bind2;\nint called_socket_alloc;\nint called_socket_clone;\n\nstatic __always_inline int test_local_storage(void)\n{\n\t__u64 *val;\n\n\tval = bpf_get_local_storage(&cgroup_storage, 0);\n\tif (!val)\n\t\treturn 0;\n\t*val += 1;\n\n\treturn 1;\n}\n\nstatic __always_inline int real_create(struct socket *sock, int family,\n\t\t\t\t       int protocol)\n{\n\tstruct sock *sk;\n\tint prio = 123;\n\n\t \n\tif (family == AF_PACKET && protocol != 0)\n\t\treturn 0;  \n\n\tsk = sock->sk;\n\tif (!sk)\n\t\treturn 1;\n\n\t \n\tif (bpf_setsockopt(sk, SOL_SOCKET, SO_PRIORITY, &prio, sizeof(prio)))\n\t\treturn 0;  \n\n\t \n\tprio = 0;\n\tif (bpf_getsockopt(sk, SOL_SOCKET, SO_PRIORITY, &prio, sizeof(prio)))\n\t\treturn 0;  \n\tif (prio != 123)\n\t\treturn 0;  \n\n\t \n\tif (!test_local_storage())\n\t\treturn 0;  \n\n\treturn 1;\n}\n\n \nSEC(\"lsm_cgroup/socket_post_create\")\nint BPF_PROG(socket_post_create, struct socket *sock, int family,\n\t     int type, int protocol, int kern)\n{\n\tcalled_socket_post_create++;\n\treturn real_create(sock, family, protocol);\n}\n\n \nSEC(\"lsm_cgroup/socket_post_create\")\nint BPF_PROG(socket_post_create2, struct socket *sock, int family,\n\t     int type, int protocol, int kern)\n{\n\tcalled_socket_post_create2++;\n\treturn real_create(sock, family, protocol);\n}\n\nstatic __always_inline int real_bind(struct socket *sock,\n\t\t\t\t     struct sockaddr *address,\n\t\t\t\t     int addrlen)\n{\n\tstruct sockaddr_ll sa = {};\n\n\tif (sock->sk->__sk_common.skc_family != AF_PACKET)\n\t\treturn 1;\n\n\tif (sock->sk->sk_kern_sock)\n\t\treturn 1;\n\n\tbpf_probe_read_kernel(&sa, sizeof(sa), address);\n\tif (sa.sll_protocol)\n\t\treturn 0;  \n\n\t \n\tif (!test_local_storage())\n\t\treturn 0;  \n\n\treturn 1;\n}\n\n \nSEC(\"lsm_cgroup/socket_bind\")\nint BPF_PROG(socket_bind, struct socket *sock, struct sockaddr *address,\n\t     int addrlen)\n{\n\tcalled_socket_bind++;\n\treturn real_bind(sock, address, addrlen);\n}\n\n \nSEC(\"lsm_cgroup/socket_bind\")\nint BPF_PROG(socket_bind2, struct socket *sock, struct sockaddr *address,\n\t     int addrlen)\n{\n\tcalled_socket_bind2++;\n\treturn real_bind(sock, address, addrlen);\n}\n\n \nSEC(\"lsm_cgroup/sk_alloc_security\")\nint BPF_PROG(socket_alloc, struct sock *sk, int family, gfp_t priority)\n{\n\tcalled_socket_alloc++;\n\t \n\tif (CONFIG_SECURITY_SELINUX || CONFIG_SECURITY_SMACK || CONFIG_SECURITY_APPARMOR)\n\t\treturn 1;\n\n\tif (family == AF_UNIX)\n\t\treturn 0;  \n\n\t \n\tif (!test_local_storage())\n\t\treturn 0;  \n\n\treturn 1;\n}\n\n \nSEC(\"lsm_cgroup/inet_csk_clone\")\nint BPF_PROG(socket_clone, struct sock *newsk, const struct request_sock *req)\n{\n\tint prio = 234;\n\n\tif (!newsk)\n\t\treturn 1;\n\n\t \n\tif (bpf_setsockopt(newsk, SOL_SOCKET, SO_PRIORITY, &prio, sizeof(prio)))\n\t\treturn 1;\n\n\t \n\tprio = 0;\n\tif (bpf_getsockopt(newsk, SOL_SOCKET, SO_PRIORITY, &prio, sizeof(prio)))\n\t\treturn 1;\n\tif (prio != 234)\n\t\treturn 1;\n\n\t \n\tif (!test_local_storage())\n\t\treturn 1;\n\n\tcalled_socket_clone++;\n\n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}