{
  "module_name": "connect_force_port4.c",
  "hash_id": "01b1716d8fe8997ce641cc26897aa9a5e7377b16c691ce74a410f5d3117b6576",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/connect_force_port4.c",
  "human_readable_source": "\n#include <string.h>\n#include <stdbool.h>\n\n#include <linux/bpf.h>\n#include <linux/in.h>\n#include <linux/in6.h>\n#include <sys/socket.h>\n\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\n#include <bpf_sockopt_helpers.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nstruct svc_addr {\n\t__be32 addr;\n\t__be16 port;\n};\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_SK_STORAGE);\n\t__uint(map_flags, BPF_F_NO_PREALLOC);\n\t__type(key, int);\n\t__type(value, struct svc_addr);\n} service_mapping SEC(\".maps\");\n\nSEC(\"cgroup/connect4\")\nint connect4(struct bpf_sock_addr *ctx)\n{\n\tstruct sockaddr_in sa = {};\n\tstruct svc_addr *orig;\n\n\t \n\tsa.sin_family = AF_INET;\n\tsa.sin_port = bpf_htons(22222);\n\tsa.sin_addr.s_addr = bpf_htonl(0x7f000001);\n\n\tif (bpf_bind(ctx, (struct sockaddr *)&sa, sizeof(sa)) != 0)\n\t\treturn 0;\n\n\t \n\tif (ctx->user_port == bpf_htons(60000)) {\n\t\torig = bpf_sk_storage_get(&service_mapping, ctx->sk, 0,\n\t\t\t\t\t  BPF_SK_STORAGE_GET_F_CREATE);\n\t\tif (!orig)\n\t\t\treturn 0;\n\n\t\torig->addr = ctx->user_ip4;\n\t\torig->port = ctx->user_port;\n\n\t\tctx->user_ip4 = bpf_htonl(0x7f000001);\n\t\tctx->user_port = bpf_htons(60123);\n\t}\n\treturn 1;\n}\n\nSEC(\"cgroup/getsockname4\")\nint getsockname4(struct bpf_sock_addr *ctx)\n{\n\tif (!get_set_sk_priority(ctx))\n\t\treturn 1;\n\n\t \n\tif (ctx->user_port == bpf_htons(60123)) {\n\t\tctx->user_ip4 = bpf_htonl(0x01020304);\n\t\tctx->user_port = bpf_htons(60000);\n\t}\n\treturn 1;\n}\n\nSEC(\"cgroup/getpeername4\")\nint getpeername4(struct bpf_sock_addr *ctx)\n{\n\tstruct svc_addr *orig;\n\n\tif (!get_set_sk_priority(ctx))\n\t\treturn 1;\n\n\t \n\tif (ctx->user_port == bpf_htons(60123)) {\n\t\torig = bpf_sk_storage_get(&service_mapping, ctx->sk, 0, 0);\n\t\tif (orig) {\n\t\t\tctx->user_ip4 = orig->addr;\n\t\t\tctx->user_port = orig->port;\n\t\t}\n\t}\n\treturn 1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}