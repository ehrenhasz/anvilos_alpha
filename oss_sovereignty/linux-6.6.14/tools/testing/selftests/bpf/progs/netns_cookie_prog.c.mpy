{
  "module_name": "netns_cookie_prog.c",
  "hash_id": "24e18ac93b95fbc835472ee4369fb95d03cb6633b3d1ef24685b8ab07518dabf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/netns_cookie_prog.c",
  "human_readable_source": "\n\n#include \"vmlinux.h\"\n\n#include <bpf/bpf_helpers.h>\n\n#define AF_INET6 10\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_SK_STORAGE);\n\t__uint(map_flags, BPF_F_NO_PREALLOC);\n\t__type(key, int);\n\t__type(value, int);\n} sockops_netns_cookies SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_SK_STORAGE);\n\t__uint(map_flags, BPF_F_NO_PREALLOC);\n\t__type(key, int);\n\t__type(value, int);\n} sk_msg_netns_cookies SEC(\".maps\");\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_SOCKMAP);\n\t__uint(max_entries, 2);\n\t__type(key, __u32);\n\t__type(value, __u64);\n} sock_map SEC(\".maps\");\n\nSEC(\"sockops\")\nint get_netns_cookie_sockops(struct bpf_sock_ops *ctx)\n{\n\tstruct bpf_sock *sk = ctx->sk;\n\tint *cookie;\n\t__u32 key = 0;\n\n\tif (ctx->family != AF_INET6)\n\t\treturn 1;\n\n\tif (!sk)\n\t\treturn 1;\n\n\tswitch (ctx->op) {\n\tcase BPF_SOCK_OPS_TCP_CONNECT_CB:\n\t\tcookie = bpf_sk_storage_get(&sockops_netns_cookies, sk, 0,\n\t\t\t\t\t    BPF_SK_STORAGE_GET_F_CREATE);\n\t\tif (!cookie)\n\t\t\treturn 1;\n\n\t\t*cookie = bpf_get_netns_cookie(ctx);\n\t\tbreak;\n\tcase BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB:\n\t\tbpf_sock_map_update(ctx, &sock_map, &key, BPF_NOEXIST);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 1;\n}\n\nSEC(\"sk_msg\")\nint get_netns_cookie_sk_msg(struct sk_msg_md *msg)\n{\n\tstruct bpf_sock *sk = msg->sk;\n\tint *cookie;\n\n\tif (msg->family != AF_INET6)\n\t\treturn 1;\n\n\tif (!sk)\n\t\treturn 1;\n\n\tcookie = bpf_sk_storage_get(&sk_msg_netns_cookies, sk, 0,\n\t\t\t\t    BPF_SK_STORAGE_GET_F_CREATE);\n\tif (!cookie)\n\t\treturn 1;\n\n\t*cookie = bpf_get_netns_cookie(msg);\n\n\treturn 1;\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}