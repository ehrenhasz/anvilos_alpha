{
  "module_name": "task_kfunc_common.h",
  "hash_id": "4aa6bb48924c759e3777aeacc4d59c73b5b6e1ecceff5a300dc3edda333fba96",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/task_kfunc_common.h",
  "human_readable_source": " \n \n\n#ifndef _TASK_KFUNC_COMMON_H\n#define _TASK_KFUNC_COMMON_H\n\n#include <errno.h>\n#include <vmlinux.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\nstruct __tasks_kfunc_map_value {\n\tstruct task_struct __kptr * task;\n};\n\nstruct hash_map {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__type(key, int);\n\t__type(value, struct __tasks_kfunc_map_value);\n\t__uint(max_entries, 1);\n} __tasks_kfunc_map SEC(\".maps\");\n\nstruct task_struct *bpf_task_acquire(struct task_struct *p) __ksym;\nvoid bpf_task_release(struct task_struct *p) __ksym;\nstruct task_struct *bpf_task_from_pid(s32 pid) __ksym;\nvoid bpf_rcu_read_lock(void) __ksym;\nvoid bpf_rcu_read_unlock(void) __ksym;\n\nstatic inline struct __tasks_kfunc_map_value *tasks_kfunc_map_value_lookup(struct task_struct *p)\n{\n\ts32 pid;\n\tlong status;\n\n\tstatus = bpf_probe_read_kernel(&pid, sizeof(pid), &p->pid);\n\tif (status)\n\t\treturn NULL;\n\n\treturn bpf_map_lookup_elem(&__tasks_kfunc_map, &pid);\n}\n\nstatic inline int tasks_kfunc_map_insert(struct task_struct *p)\n{\n\tstruct __tasks_kfunc_map_value local, *v;\n\tlong status;\n\tstruct task_struct *acquired, *old;\n\ts32 pid;\n\n\tstatus = bpf_probe_read_kernel(&pid, sizeof(pid), &p->pid);\n\tif (status)\n\t\treturn status;\n\n\tlocal.task = NULL;\n\tstatus = bpf_map_update_elem(&__tasks_kfunc_map, &pid, &local, BPF_NOEXIST);\n\tif (status)\n\t\treturn status;\n\n\tv = bpf_map_lookup_elem(&__tasks_kfunc_map, &pid);\n\tif (!v) {\n\t\tbpf_map_delete_elem(&__tasks_kfunc_map, &pid);\n\t\treturn -ENOENT;\n\t}\n\n\tacquired = bpf_task_acquire(p);\n\tif (!acquired)\n\t\treturn -ENOENT;\n\n\told = bpf_kptr_xchg(&v->task, acquired);\n\tif (old) {\n\t\tbpf_task_release(old);\n\t\treturn -EEXIST;\n\t}\n\n\treturn 0;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}