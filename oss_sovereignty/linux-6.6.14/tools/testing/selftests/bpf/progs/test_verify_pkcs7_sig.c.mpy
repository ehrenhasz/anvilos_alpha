{
  "module_name": "test_verify_pkcs7_sig.c",
  "hash_id": "ec7b8801e5948986997752d69ee0a322fbe7070b8c479249fe05434beae40dcb",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/test_verify_pkcs7_sig.c",
  "human_readable_source": "\n\n \n\n#include \"vmlinux.h\"\n#include <errno.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\n#define MAX_DATA_SIZE (1024 * 1024)\n#define MAX_SIG_SIZE 1024\n\nextern struct bpf_key *bpf_lookup_user_key(__u32 serial, __u64 flags) __ksym;\nextern struct bpf_key *bpf_lookup_system_key(__u64 id) __ksym;\nextern void bpf_key_put(struct bpf_key *key) __ksym;\nextern int bpf_verify_pkcs7_signature(struct bpf_dynptr *data_ptr,\n\t\t\t\t      struct bpf_dynptr *sig_ptr,\n\t\t\t\t      struct bpf_key *trusted_keyring) __ksym;\n\n__u32 monitored_pid;\n__u32 user_keyring_serial;\n__u64 system_keyring_id;\n\nstruct data {\n\t__u8 data[MAX_DATA_SIZE];\n\t__u32 data_len;\n\t__u8 sig[MAX_SIG_SIZE];\n\t__u32 sig_len;\n};\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_ARRAY);\n\t__uint(max_entries, 1);\n\t__type(key, __u32);\n\t__type(value, struct data);\n} data_input SEC(\".maps\");\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\nSEC(\"lsm.s/bpf\")\nint BPF_PROG(bpf, int cmd, union bpf_attr *attr, unsigned int size)\n{\n\tstruct bpf_dynptr data_ptr, sig_ptr;\n\tstruct data *data_val;\n\tstruct bpf_key *trusted_keyring;\n\t__u32 pid;\n\t__u64 value;\n\tint ret, zero = 0;\n\n\tpid = bpf_get_current_pid_tgid() >> 32;\n\tif (pid != monitored_pid)\n\t\treturn 0;\n\n\tdata_val = bpf_map_lookup_elem(&data_input, &zero);\n\tif (!data_val)\n\t\treturn 0;\n\n\tret = bpf_probe_read_kernel(&value, sizeof(value), &attr->value);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bpf_copy_from_user(data_val, sizeof(struct data),\n\t\t\t\t (void *)(unsigned long)value);\n\tif (ret)\n\t\treturn ret;\n\n\tif (data_val->data_len > sizeof(data_val->data))\n\t\treturn -EINVAL;\n\n\tbpf_dynptr_from_mem(data_val->data, data_val->data_len, 0, &data_ptr);\n\n\tif (data_val->sig_len > sizeof(data_val->sig))\n\t\treturn -EINVAL;\n\n\tbpf_dynptr_from_mem(data_val->sig, data_val->sig_len, 0, &sig_ptr);\n\n\tif (user_keyring_serial)\n\t\ttrusted_keyring = bpf_lookup_user_key(user_keyring_serial, 0);\n\telse\n\t\ttrusted_keyring = bpf_lookup_system_key(system_keyring_id);\n\n\tif (!trusted_keyring)\n\t\treturn -ENOENT;\n\n\tret = bpf_verify_pkcs7_signature(&data_ptr, &sig_ptr, trusted_keyring);\n\n\tbpf_key_put(trusted_keyring);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}