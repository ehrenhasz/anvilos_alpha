{
  "module_name": "cgroup_skb_sk_lookup_kern.c",
  "hash_id": "cbde92e3e5a6dbea19926b4b0a5aa007b55d67e0fcad7d2b916937f6d252e3d4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/cgroup_skb_sk_lookup_kern.c",
  "human_readable_source": "\n\n\n#include <linux/bpf.h>\n#include <bpf/bpf_endian.h>\n#include <bpf/bpf_helpers.h>\n\n#include <linux/if_ether.h>\n#include <linux/in.h>\n#include <linux/in6.h>\n#include <linux/ipv6.h>\n#include <linux/tcp.h>\n\n#include <sys/types.h>\n#include <sys/socket.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\n__u16 g_serv_port = 0;\n\nstatic inline void set_ip(__u32 *dst, const struct in6_addr *src)\n{\n\tdst[0] = src->in6_u.u6_addr32[0];\n\tdst[1] = src->in6_u.u6_addr32[1];\n\tdst[2] = src->in6_u.u6_addr32[2];\n\tdst[3] = src->in6_u.u6_addr32[3];\n}\n\nstatic inline void set_tuple(struct bpf_sock_tuple *tuple,\n\t\t\t     const struct ipv6hdr *ip6h,\n\t\t\t     const struct tcphdr *tcph)\n{\n\tset_ip(tuple->ipv6.saddr, &ip6h->daddr);\n\tset_ip(tuple->ipv6.daddr, &ip6h->saddr);\n\ttuple->ipv6.sport = tcph->dest;\n\ttuple->ipv6.dport = tcph->source;\n}\n\nstatic inline int is_allowed_peer_cg(struct __sk_buff *skb,\n\t\t\t\t     const struct ipv6hdr *ip6h,\n\t\t\t\t     const struct tcphdr *tcph)\n{\n\t__u64 cgid, acgid, peer_cgid, peer_acgid;\n\tstruct bpf_sock_tuple tuple;\n\tsize_t tuple_len = sizeof(tuple.ipv6);\n\tstruct bpf_sock *peer_sk;\n\n\tset_tuple(&tuple, ip6h, tcph);\n\n\tpeer_sk = bpf_sk_lookup_tcp(skb, &tuple, tuple_len,\n\t\t\t\t    BPF_F_CURRENT_NETNS, 0);\n\tif (!peer_sk)\n\t\treturn 0;\n\n\tcgid = bpf_skb_cgroup_id(skb);\n\tpeer_cgid = bpf_sk_cgroup_id(peer_sk);\n\n\tacgid = bpf_skb_ancestor_cgroup_id(skb, 2);\n\tpeer_acgid = bpf_sk_ancestor_cgroup_id(peer_sk, 2);\n\n\tbpf_sk_release(peer_sk);\n\n\treturn cgid && cgid == peer_cgid && acgid && acgid == peer_acgid;\n}\n\nSEC(\"cgroup_skb/ingress\")\nint ingress_lookup(struct __sk_buff *skb)\n{\n\tstruct ipv6hdr ip6h;\n\tstruct tcphdr tcph;\n\n\tif (skb->protocol != bpf_htons(ETH_P_IPV6))\n\t\treturn 1;\n\n\t \n\tif (bpf_skb_load_bytes(skb, 0, &ip6h, sizeof(ip6h)))\n\t\treturn 1;\n\n\tif (ip6h.nexthdr != IPPROTO_TCP)\n\t\treturn 1;\n\n\tif (bpf_skb_load_bytes(skb, sizeof(ip6h), &tcph, sizeof(tcph)))\n\t\treturn 1;\n\n\tif (!g_serv_port)\n\t\treturn 0;\n\n\tif (tcph.dest != g_serv_port)\n\t\treturn 1;\n\n\treturn is_allowed_peer_cg(skb, &ip6h, &tcph);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}