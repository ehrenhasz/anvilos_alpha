{
  "module_name": "tcp_ca_write_sk_pacing.c",
  "hash_id": "a481acb732bc96dff2f874ad63096d8736da074cc19542f1a93da4b3bc65d383",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/tcp_ca_write_sk_pacing.c",
  "human_readable_source": "\n\n#include \"vmlinux.h\"\n\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\n#define USEC_PER_SEC 1000000UL\n\n#define min(a, b) ((a) < (b) ? (a) : (b))\n\nstatic inline struct tcp_sock *tcp_sk(const struct sock *sk)\n{\n\treturn (struct tcp_sock *)sk;\n}\n\nstatic inline unsigned int tcp_left_out(const struct tcp_sock *tp)\n{\n\treturn tp->sacked_out + tp->lost_out;\n}\n\nstatic inline unsigned int tcp_packets_in_flight(const struct tcp_sock *tp)\n{\n\treturn tp->packets_out - tcp_left_out(tp) + tp->retrans_out;\n}\n\nSEC(\"struct_ops/write_sk_pacing_init\")\nvoid BPF_PROG(write_sk_pacing_init, struct sock *sk)\n{\n#ifdef ENABLE_ATOMICS_TESTS\n\t__sync_bool_compare_and_swap(&sk->sk_pacing_status, SK_PACING_NONE,\n\t\t\t\t     SK_PACING_NEEDED);\n#else\n\tsk->sk_pacing_status = SK_PACING_NEEDED;\n#endif\n}\n\nSEC(\"struct_ops/write_sk_pacing_cong_control\")\nvoid BPF_PROG(write_sk_pacing_cong_control, struct sock *sk,\n\t      const struct rate_sample *rs)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tunsigned long rate =\n\t\t((tp->snd_cwnd * tp->mss_cache * USEC_PER_SEC) << 3) /\n\t\t(tp->srtt_us ?: 1U << 3);\n\tsk->sk_pacing_rate = min(rate, sk->sk_max_pacing_rate);\n\ttp->app_limited = (tp->delivered + tcp_packets_in_flight(tp)) ?: 1;\n}\n\nSEC(\"struct_ops/write_sk_pacing_ssthresh\")\n__u32 BPF_PROG(write_sk_pacing_ssthresh, struct sock *sk)\n{\n\treturn tcp_sk(sk)->snd_ssthresh;\n}\n\nSEC(\"struct_ops/write_sk_pacing_undo_cwnd\")\n__u32 BPF_PROG(write_sk_pacing_undo_cwnd, struct sock *sk)\n{\n\treturn tcp_sk(sk)->snd_cwnd;\n}\n\nSEC(\".struct_ops\")\nstruct tcp_congestion_ops write_sk_pacing = {\n\t.init = (void *)write_sk_pacing_init,\n\t.cong_control = (void *)write_sk_pacing_cong_control,\n\t.ssthresh = (void *)write_sk_pacing_ssthresh,\n\t.undo_cwnd = (void *)write_sk_pacing_undo_cwnd,\n\t.name = \"bpf_w_sk_pacing\",\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}