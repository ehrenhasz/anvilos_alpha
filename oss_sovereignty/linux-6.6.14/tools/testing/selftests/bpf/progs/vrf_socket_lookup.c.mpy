{
  "module_name": "vrf_socket_lookup.c",
  "hash_id": "289870c7d3ff8237f5be5fd03b2318c2878c8913b5758e690f38b30b046546b3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/progs/vrf_socket_lookup.c",
  "human_readable_source": "\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\n#include <linux/ip.h>\n#include <linux/in.h>\n#include <linux/if_ether.h>\n#include <linux/pkt_cls.h>\n#include <stdbool.h>\n\nint lookup_status;\nbool test_xdp;\nbool tcp_skc;\n\n#define CUR_NS BPF_F_CURRENT_NETNS\n\nstatic void socket_lookup(void *ctx, void *data_end, void *data)\n{\n\tstruct ethhdr *eth = data;\n\tstruct bpf_sock_tuple *tp;\n\tstruct bpf_sock *sk;\n\tstruct iphdr *iph;\n\tint tplen;\n\n\tif (eth + 1 > data_end)\n\t\treturn;\n\n\tif (eth->h_proto != bpf_htons(ETH_P_IP))\n\t\treturn;\n\n\tiph = (struct iphdr *)(eth + 1);\n\tif (iph + 1 > data_end)\n\t\treturn;\n\n\ttp = (struct bpf_sock_tuple *)&iph->saddr;\n\ttplen = sizeof(tp->ipv4);\n\tif ((void *)tp + tplen > data_end)\n\t\treturn;\n\n\tswitch (iph->protocol) {\n\tcase IPPROTO_TCP:\n\t\tif (tcp_skc)\n\t\t\tsk = bpf_skc_lookup_tcp(ctx, tp, tplen, CUR_NS, 0);\n\t\telse\n\t\t\tsk = bpf_sk_lookup_tcp(ctx, tp, tplen, CUR_NS, 0);\n\t\tbreak;\n\tcase IPPROTO_UDP:\n\t\tsk = bpf_sk_lookup_udp(ctx, tp, tplen, CUR_NS, 0);\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tlookup_status = 0;\n\n\tif (sk) {\n\t\tbpf_sk_release(sk);\n\t\tlookup_status = 1;\n\t}\n}\n\nSEC(\"tc\")\nint tc_socket_lookup(struct __sk_buff *skb)\n{\n\tvoid *data_end = (void *)(long)skb->data_end;\n\tvoid *data = (void *)(long)skb->data;\n\n\tif (test_xdp)\n\t\treturn TC_ACT_UNSPEC;\n\n\tsocket_lookup(skb, data_end, data);\n\treturn TC_ACT_UNSPEC;\n}\n\nSEC(\"xdp\")\nint xdp_socket_lookup(struct xdp_md *xdp)\n{\n\tvoid *data_end = (void *)(long)xdp->data_end;\n\tvoid *data = (void *)(long)xdp->data;\n\n\tif (!test_xdp)\n\t\treturn XDP_PASS;\n\n\tsocket_lookup(xdp, data_end, data);\n\treturn XDP_PASS;\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}