{
  "module_name": "test_cgroup_storage.c",
  "hash_id": "71f66d99e1a8ebbe234bce404b05856aebac10d33c887bb6990b4e28de7ae7a0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_cgroup_storage.c",
  "human_readable_source": "\n#include <assert.h>\n#include <bpf/bpf.h>\n#include <linux/filter.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/sysinfo.h>\n\n#include \"bpf_util.h\"\n#include \"cgroup_helpers.h\"\n#include \"testing_helpers.h\"\n\nchar bpf_log_buf[BPF_LOG_BUF_SIZE];\n\n#define TEST_CGROUP \"/test-bpf-cgroup-storage-buf/\"\n\nint main(int argc, char **argv)\n{\n\tstruct bpf_insn prog[] = {\n\t\tBPF_LD_MAP_FD(BPF_REG_1, 0),  \n\t\tBPF_MOV64_IMM(BPF_REG_2, 0),  \n\t\tBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0,\n\t\t\t     BPF_FUNC_get_local_storage),\n\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_0, 0),\n\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x1),\n\t\tBPF_STX_MEM(BPF_DW, BPF_REG_0, BPF_REG_3, 0),\n\n\t\tBPF_LD_MAP_FD(BPF_REG_1, 0),  \n\t\tBPF_MOV64_IMM(BPF_REG_2, 0),  \n\t\tBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0,\n\t\t\t     BPF_FUNC_get_local_storage),\n\t\tBPF_MOV64_IMM(BPF_REG_1, 1),\n\t\tBPF_ATOMIC_OP(BPF_DW, BPF_ADD, BPF_REG_0, BPF_REG_1, 0),\n\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_0, 0),\n\t\tBPF_ALU64_IMM(BPF_AND, BPF_REG_1, 0x1),\n\t\tBPF_MOV64_REG(BPF_REG_0, BPF_REG_1),\n\t\tBPF_EXIT_INSN(),\n\t};\n\tsize_t insns_cnt = ARRAY_SIZE(prog);\n\tint error = EXIT_FAILURE;\n\tint map_fd, percpu_map_fd, prog_fd, cgroup_fd;\n\tstruct bpf_cgroup_storage_key key;\n\tunsigned long long value;\n\tunsigned long long *percpu_value;\n\tint cpu, nproc;\n\n\tnproc = bpf_num_possible_cpus();\n\tpercpu_value = malloc(sizeof(*percpu_value) * nproc);\n\tif (!percpu_value) {\n\t\tprintf(\"Not enough memory for per-cpu area (%d cpus)\\n\", nproc);\n\t\tgoto err;\n\t}\n\n\t \n\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);\n\n\tmap_fd = bpf_map_create(BPF_MAP_TYPE_CGROUP_STORAGE, NULL, sizeof(key),\n\t\t\t\tsizeof(value), 0, NULL);\n\tif (map_fd < 0) {\n\t\tprintf(\"Failed to create map: %s\\n\", strerror(errno));\n\t\tgoto out;\n\t}\n\n\tpercpu_map_fd = bpf_map_create(BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE, NULL,\n\t\t\t\t       sizeof(key), sizeof(value), 0, NULL);\n\tif (percpu_map_fd < 0) {\n\t\tprintf(\"Failed to create map: %s\\n\", strerror(errno));\n\t\tgoto out;\n\t}\n\n\tprog[0].imm = percpu_map_fd;\n\tprog[7].imm = map_fd;\n\tprog_fd = bpf_test_load_program(BPF_PROG_TYPE_CGROUP_SKB,\n\t\t\t\t   prog, insns_cnt, \"GPL\", 0,\n\t\t\t\t   bpf_log_buf, BPF_LOG_BUF_SIZE);\n\tif (prog_fd < 0) {\n\t\tprintf(\"Failed to load bpf program: %s\\n\", bpf_log_buf);\n\t\tgoto out;\n\t}\n\n\tcgroup_fd = cgroup_setup_and_join(TEST_CGROUP);\n\n\t \n\tif (bpf_prog_attach(prog_fd, cgroup_fd, BPF_CGROUP_INET_EGRESS, 0)) {\n\t\tprintf(\"Failed to attach bpf program\\n\");\n\t\tgoto err;\n\t}\n\n\tif (bpf_map_get_next_key(map_fd, NULL, &key)) {\n\t\tprintf(\"Failed to get the first key in cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\tif (bpf_map_lookup_elem(map_fd, &key, &value)) {\n\t\tprintf(\"Failed to lookup cgroup storage 0\\n\");\n\t\tgoto err;\n\t}\n\n\tfor (cpu = 0; cpu < nproc; cpu++)\n\t\tpercpu_value[cpu] = 1000;\n\n\tif (bpf_map_update_elem(percpu_map_fd, &key, percpu_value, 0)) {\n\t\tprintf(\"Failed to update the data in the cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\t \n\tassert(system(\"ping localhost -c 1 -W 1 -q > /dev/null\") == 0);\n\tassert(system(\"ping localhost -c 1 -W 1 -q > /dev/null\"));\n\tassert(system(\"ping localhost -c 1 -W 1 -q > /dev/null\") == 0);\n\n\t \n\tif (bpf_map_lookup_elem(map_fd, &key, &value)) {\n\t\tprintf(\"Failed to lookup cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\tif (value != 3) {\n\t\tprintf(\"Unexpected data in the cgroup storage: %llu\\n\", value);\n\t\tgoto err;\n\t}\n\n\t \n\tvalue++;\n\tif (bpf_map_update_elem(map_fd, &key, &value, 0)) {\n\t\tprintf(\"Failed to update the data in the cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\t \n\tassert(system(\"ping localhost -c 1 -W 1 -q > /dev/null\") == 0);\n\tassert(system(\"ping localhost -c 1 -W 1 -q > /dev/null\"));\n\tassert(system(\"ping localhost -c 1 -W 1 -q > /dev/null\") == 0);\n\n\t \n\tif (bpf_map_lookup_elem(map_fd, &key, &value)) {\n\t\tprintf(\"Failed to lookup the cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\tif (value != 7) {\n\t\tprintf(\"Unexpected data in the cgroup storage: %llu\\n\", value);\n\t\tgoto err;\n\t}\n\n\t \n\n\tfor (cpu = 0; cpu < nproc; cpu++)\n\t\tpercpu_value[cpu] = 0;\n\n\tif (bpf_map_lookup_elem(percpu_map_fd, &key, percpu_value)) {\n\t\tprintf(\"Failed to lookup the per-cpu cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\tvalue = 0;\n\tfor (cpu = 0; cpu < nproc; cpu++)\n\t\tvalue += percpu_value[cpu];\n\n\tif (value != nproc * 1000 + 6) {\n\t\tprintf(\"Unexpected data in the per-cpu cgroup storage\\n\");\n\t\tgoto err;\n\t}\n\n\terror = 0;\n\tprintf(\"test_cgroup_storage:PASS\\n\");\n\nerr:\n\tcleanup_cgroup_environment();\n\tfree(percpu_value);\n\nout:\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}