{
  "module_name": "test_bprm_opts.c",
  "hash_id": "efa818938cde518618bd136b176352cc05d9bd2e8aae08f1aa72c0898e7dc714",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/test_bprm_opts.c",
  "human_readable_source": "\n\n \n\n#include <test_progs.h>\n#include <linux/limits.h>\n\n#include \"bprm_opts.skel.h\"\n#include \"network_helpers.h\"\n#include \"task_local_storage_helpers.h\"\n\nstatic const char * const bash_envp[] = { \"TMPDIR=shouldnotbeset\", NULL };\n\nstatic int update_storage(int map_fd, int secureexec)\n{\n\tint task_fd, ret = 0;\n\n\ttask_fd = sys_pidfd_open(getpid(), 0);\n\tif (task_fd < 0)\n\t\treturn errno;\n\n\tret = bpf_map_update_elem(map_fd, &task_fd, &secureexec, BPF_NOEXIST);\n\tif (ret)\n\t\tret = errno;\n\n\tclose(task_fd);\n\treturn ret;\n}\n\nstatic int run_set_secureexec(int map_fd, int secureexec)\n{\n\tint child_pid, child_status, ret, null_fd;\n\n\tchild_pid = fork();\n\tif (child_pid == 0) {\n\t\tnull_fd = open(\"/dev/null\", O_WRONLY);\n\t\tif (null_fd == -1)\n\t\t\texit(errno);\n\t\tdup2(null_fd, STDOUT_FILENO);\n\t\tdup2(null_fd, STDERR_FILENO);\n\t\tclose(null_fd);\n\n\t\t \n\t\tret = update_storage(map_fd, secureexec);\n\t\tif (ret)\n\t\t\texit(ret);\n\n\t\t \n\t\texecle(\"/bin/bash\", \"bash\", \"-c\",\n\t\t       \"[[ -z \\\"${TMPDIR}\\\" ]] || exit 10 && exit 20\", NULL,\n\t\t       bash_envp);\n\t\texit(errno);\n\t} else if (child_pid > 0) {\n\t\twaitpid(child_pid, &child_status, 0);\n\t\tret = WEXITSTATUS(child_status);\n\n\t\t \n\t\tif (secureexec && ret == 20)\n\t\t\treturn 0;\n\n\t\t \n\t\tif (!secureexec && ret == 10)\n\t\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\nvoid test_test_bprm_opts(void)\n{\n\tint err, duration = 0;\n\tstruct bprm_opts *skel = NULL;\n\n\tskel = bprm_opts__open_and_load();\n\tif (CHECK(!skel, \"skel_load\", \"skeleton failed\\n\"))\n\t\tgoto close_prog;\n\n\terr = bprm_opts__attach(skel);\n\tif (CHECK(err, \"attach\", \"attach failed: %d\\n\", err))\n\t\tgoto close_prog;\n\n\t \n\terr = run_set_secureexec(bpf_map__fd(skel->maps.secure_exec_task_map),\n\t\t\t\t 0  );\n\tif (CHECK(err, \"run_set_secureexec:0\", \"err = %d\\n\", err))\n\t\tgoto close_prog;\n\n\t \n\terr = run_set_secureexec(bpf_map__fd(skel->maps.secure_exec_task_map),\n\t\t\t\t 1  );\n\tif (CHECK(err, \"run_set_secureexec:1\", \"err = %d\\n\", err))\n\t\tgoto close_prog;\n\nclose_prog:\n\tbprm_opts__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}