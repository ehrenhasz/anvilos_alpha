{
  "module_name": "ringbuf_multi.c",
  "hash_id": "0446c3b7a603d88ac528075175f23b081e842e94b5f686dcd2142387bbe507ca",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/ringbuf_multi.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <test_progs.h>\n#include <sys/epoll.h>\n#include \"test_ringbuf_multi.skel.h\"\n\nstatic int duration = 0;\n\nstruct sample {\n\tint pid;\n\tint seq;\n\tlong value;\n\tchar comm[16];\n};\n\nstatic int process_sample(void *ctx, void *data, size_t len)\n{\n\tint ring = (unsigned long)ctx;\n\tstruct sample *s = data;\n\n\tswitch (s->seq) {\n\tcase 0:\n\t\tCHECK(ring != 1, \"sample1_ring\", \"exp %d, got %d\\n\", 1, ring);\n\t\tCHECK(s->value != 333, \"sample1_value\", \"exp %ld, got %ld\\n\",\n\t\t      333L, s->value);\n\t\tbreak;\n\tcase 1:\n\t\tCHECK(ring != 2, \"sample2_ring\", \"exp %d, got %d\\n\", 2, ring);\n\t\tCHECK(s->value != 777, \"sample2_value\", \"exp %ld, got %ld\\n\",\n\t\t      777L, s->value);\n\t\tbreak;\n\tdefault:\n\t\tCHECK(true, \"extra_sample\", \"unexpected sample seq %d, val %ld\\n\",\n\t\t      s->seq, s->value);\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nvoid test_ringbuf_multi(void)\n{\n\tstruct test_ringbuf_multi *skel;\n\tstruct ring_buffer *ringbuf = NULL;\n\tint err;\n\tint page_size = getpagesize();\n\tint proto_fd = -1;\n\n\tskel = test_ringbuf_multi__open();\n\tif (CHECK(!skel, \"skel_open\", \"skeleton open failed\\n\"))\n\t\treturn;\n\n\t \n\tASSERT_EQ(bpf_map__max_entries(skel->maps.ringbuf1), page_size, \"rb1_size_before\");\n\tASSERT_OK(bpf_map__set_max_entries(skel->maps.ringbuf1, page_size + 1), \"rb1_resize\");\n\tASSERT_EQ(bpf_map__max_entries(skel->maps.ringbuf1), 2 * page_size, \"rb1_size_after\");\n\tASSERT_OK(bpf_map__set_max_entries(skel->maps.ringbuf1, page_size), \"rb1_reset\");\n\tASSERT_EQ(bpf_map__max_entries(skel->maps.ringbuf1), page_size, \"rb1_size_final\");\n\n\tproto_fd = bpf_map_create(BPF_MAP_TYPE_RINGBUF, NULL, 0, 0, page_size, NULL);\n\tif (CHECK(proto_fd < 0, \"bpf_map_create\", \"bpf_map_create failed\\n\"))\n\t\tgoto cleanup;\n\n\terr = bpf_map__set_inner_map_fd(skel->maps.ringbuf_hash, proto_fd);\n\tif (CHECK(err != 0, \"bpf_map__set_inner_map_fd\", \"bpf_map__set_inner_map_fd failed\\n\"))\n\t\tgoto cleanup;\n\n\terr = test_ringbuf_multi__load(skel);\n\tif (CHECK(err != 0, \"skel_load\", \"skeleton load failed\\n\"))\n\t\tgoto cleanup;\n\n\tclose(proto_fd);\n\tproto_fd = -1;\n\n\t \n\tif (!ASSERT_ERR(bpf_map__set_max_entries(skel->maps.ringbuf1, 3 * page_size), \"rb1_resize_after_load\"))\n\t\tgoto cleanup;\n\n\t \n\tskel->bss->pid = getpid();\n\n\tringbuf = ring_buffer__new(bpf_map__fd(skel->maps.ringbuf1),\n\t\t\t\t   process_sample, (void *)(long)1, NULL);\n\tif (CHECK(!ringbuf, \"ringbuf_create\", \"failed to create ringbuf\\n\"))\n\t\tgoto cleanup;\n\n\terr = ring_buffer__add(ringbuf, bpf_map__fd(skel->maps.ringbuf2),\n\t\t\t      process_sample, (void *)(long)2);\n\tif (CHECK(err, \"ringbuf_add\", \"failed to add another ring\\n\"))\n\t\tgoto cleanup;\n\n\terr = test_ringbuf_multi__attach(skel);\n\tif (CHECK(err, \"skel_attach\", \"skeleton attachment failed: %d\\n\", err))\n\t\tgoto cleanup;\n\n\t \n\tskel->bss->target_ring = 0;\n\tskel->bss->value = 333;\n\tsyscall(__NR_getpgid);\n\n\t \n\tskel->bss->target_ring = 1;\n\tskel->bss->value = 555;\n\tsyscall(__NR_getpgid);\n\n\tskel->bss->target_ring = 2;\n\tskel->bss->value = 777;\n\tsyscall(__NR_getpgid);\n\n\t \n\terr = ring_buffer__poll(ringbuf, -1);\n\tif (CHECK(err != 2, \"poll_res\", \"expected 2 records, got %d\\n\", err))\n\t\tgoto cleanup;\n\n\t \n\terr = ring_buffer__poll(ringbuf, 0);\n\tif (CHECK(err < 0, \"extra_samples\", \"poll result: %d\\n\", err))\n\t\tgoto cleanup;\n\n\tCHECK(skel->bss->dropped != 0, \"err_dropped\", \"exp %ld, got %ld\\n\",\n\t      0L, skel->bss->dropped);\n\tCHECK(skel->bss->skipped != 1, \"err_skipped\", \"exp %ld, got %ld\\n\",\n\t      1L, skel->bss->skipped);\n\tCHECK(skel->bss->total != 2, \"err_total\", \"exp %ld, got %ld\\n\",\n\t      2L, skel->bss->total);\n\ncleanup:\n\tif (proto_fd >= 0)\n\t\tclose(proto_fd);\n\tring_buffer__free(ringbuf);\n\ttest_ringbuf_multi__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}