{
  "module_name": "bpf_obj_id.c",
  "hash_id": "ae35f519934d0cb03aa84b646836b40111503fa07c6af9e890f6742f6e2d561b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/bpf_obj_id.c",
  "human_readable_source": "\n#include <test_progs.h>\n\n#define nr_iters 2\n\nvoid serial_test_bpf_obj_id(void)\n{\n\tconst __u64 array_magic_value = 0xfaceb00c;\n\tconst __u32 array_key = 0;\n\tconst char *file = \"./test_obj_id.bpf.o\";\n\tconst char *expected_prog_name = \"test_obj_id\";\n\tconst char *expected_map_name = \"test_map_id\";\n\tconst __u64 nsec_per_sec = 1000000000;\n\n\tstruct bpf_object *objs[nr_iters] = {};\n\tstruct bpf_link *links[nr_iters] = {};\n\tstruct bpf_program *prog;\n\tint prog_fds[nr_iters], map_fds[nr_iters];\n\t \n\tstruct bpf_prog_info prog_infos[nr_iters + 1];\n\tstruct bpf_map_info map_infos[nr_iters + 1];\n\tstruct bpf_link_info link_infos[nr_iters + 1];\n\t \n\t__u32 map_ids[nr_iters + 1];\n\tchar jited_insns[128], xlated_insns[128], zeros[128], tp_name[128];\n\t__u32 i, next_id, info_len, nr_id_found, duration = 0;\n\tstruct timespec real_time_ts, boot_time_ts;\n\tint err = 0;\n\t__u64 array_value;\n\tuid_t my_uid = getuid();\n\ttime_t now, load_time;\n\n\terr = bpf_prog_get_fd_by_id(0);\n\tCHECK(err >= 0 || errno != ENOENT,\n\t      \"get-fd-by-notexist-prog-id\", \"err %d errno %d\\n\", err, errno);\n\n\terr = bpf_map_get_fd_by_id(0);\n\tCHECK(err >= 0 || errno != ENOENT,\n\t      \"get-fd-by-notexist-map-id\", \"err %d errno %d\\n\", err, errno);\n\n\terr = bpf_link_get_fd_by_id(0);\n\tCHECK(err >= 0 || errno != ENOENT,\n\t      \"get-fd-by-notexist-link-id\", \"err %d errno %d\\n\", err, errno);\n\n\t \n\tbzero(zeros, sizeof(zeros));\n\tfor (i = 0; i < nr_iters; i++) {\n\t\tnow = time(NULL);\n\t\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_RAW_TRACEPOINT,\n\t\t\t\t    &objs[i], &prog_fds[i]);\n\t\t \n\t\tif (CHECK_FAIL(err))\n\t\t\tcontinue;\n\n\t\t \n\t\tmap_fds[i] = bpf_find_map(__func__, objs[i], \"test_map_id\");\n\t\tif (CHECK_FAIL(map_fds[i] < 0))\n\t\t\tgoto done;\n\t\terr = bpf_map_update_elem(map_fds[i], &array_key,\n\t\t\t\t\t  &array_magic_value, 0);\n\t\tif (CHECK_FAIL(err))\n\t\t\tgoto done;\n\n\t\tprog = bpf_object__find_program_by_name(objs[i],\n\t\t\t\t\t\t\t\"test_obj_id\");\n\t\tif (CHECK_FAIL(!prog))\n\t\t\tgoto done;\n\t\tlinks[i] = bpf_program__attach(prog);\n\t\terr = libbpf_get_error(links[i]);\n\t\tif (CHECK(err, \"prog_attach\", \"prog #%d, err %d\\n\", i, err)) {\n\t\t\tlinks[i] = NULL;\n\t\t\tgoto done;\n\t\t}\n\n\t\t \n\t\tinfo_len = sizeof(struct bpf_map_info) * 2;\n\t\tbzero(&map_infos[i], info_len);\n\t\terr = bpf_map_get_info_by_fd(map_fds[i], &map_infos[i],\n\t\t\t\t\t     &info_len);\n\t\tif (CHECK(err ||\n\t\t\t  map_infos[i].type != BPF_MAP_TYPE_ARRAY ||\n\t\t\t  map_infos[i].key_size != sizeof(__u32) ||\n\t\t\t  map_infos[i].value_size != sizeof(__u64) ||\n\t\t\t  map_infos[i].max_entries != 1 ||\n\t\t\t  map_infos[i].map_flags != 0 ||\n\t\t\t  info_len != sizeof(struct bpf_map_info) ||\n\t\t\t  strcmp((char *)map_infos[i].name, expected_map_name),\n\t\t\t  \"get-map-info(fd)\",\n\t\t\t  \"err %d errno %d type %d(%d) info_len %u(%zu) key_size %u value_size %u max_entries %u map_flags %X name %s(%s)\\n\",\n\t\t\t  err, errno,\n\t\t\t  map_infos[i].type, BPF_MAP_TYPE_ARRAY,\n\t\t\t  info_len, sizeof(struct bpf_map_info),\n\t\t\t  map_infos[i].key_size,\n\t\t\t  map_infos[i].value_size,\n\t\t\t  map_infos[i].max_entries,\n\t\t\t  map_infos[i].map_flags,\n\t\t\t  map_infos[i].name, expected_map_name))\n\t\t\tgoto done;\n\n\t\t \n\t\tinfo_len = sizeof(struct bpf_prog_info) * 2;\n\t\tbzero(&prog_infos[i], info_len);\n\t\tbzero(jited_insns, sizeof(jited_insns));\n\t\tbzero(xlated_insns, sizeof(xlated_insns));\n\t\tprog_infos[i].jited_prog_insns = ptr_to_u64(jited_insns);\n\t\tprog_infos[i].jited_prog_len = sizeof(jited_insns);\n\t\tprog_infos[i].xlated_prog_insns = ptr_to_u64(xlated_insns);\n\t\tprog_infos[i].xlated_prog_len = sizeof(xlated_insns);\n\t\tprog_infos[i].map_ids = ptr_to_u64(map_ids + i);\n\t\tprog_infos[i].nr_map_ids = 2;\n\t\terr = clock_gettime(CLOCK_REALTIME, &real_time_ts);\n\t\tif (CHECK_FAIL(err))\n\t\t\tgoto done;\n\t\terr = clock_gettime(CLOCK_BOOTTIME, &boot_time_ts);\n\t\tif (CHECK_FAIL(err))\n\t\t\tgoto done;\n\t\terr = bpf_prog_get_info_by_fd(prog_fds[i], &prog_infos[i],\n\t\t\t\t\t      &info_len);\n\t\tload_time = (real_time_ts.tv_sec - boot_time_ts.tv_sec)\n\t\t\t+ (prog_infos[i].load_time / nsec_per_sec);\n\t\tif (CHECK(err ||\n\t\t\t  prog_infos[i].type != BPF_PROG_TYPE_RAW_TRACEPOINT ||\n\t\t\t  info_len != sizeof(struct bpf_prog_info) ||\n\t\t\t  (env.jit_enabled && !prog_infos[i].jited_prog_len) ||\n\t\t\t  (env.jit_enabled &&\n\t\t\t   !memcmp(jited_insns, zeros, sizeof(zeros))) ||\n\t\t\t  !prog_infos[i].xlated_prog_len ||\n\t\t\t  !memcmp(xlated_insns, zeros, sizeof(zeros)) ||\n\t\t\t  load_time < now - 60 || load_time > now + 60 ||\n\t\t\t  prog_infos[i].created_by_uid != my_uid ||\n\t\t\t  prog_infos[i].nr_map_ids != 1 ||\n\t\t\t  *(int *)(long)prog_infos[i].map_ids != map_infos[i].id ||\n\t\t\t  strcmp((char *)prog_infos[i].name, expected_prog_name),\n\t\t\t  \"get-prog-info(fd)\",\n\t\t\t  \"err %d errno %d i %d type %d(%d) info_len %u(%zu) \"\n\t\t\t  \"jit_enabled %d jited_prog_len %u xlated_prog_len %u \"\n\t\t\t  \"jited_prog %d xlated_prog %d load_time %lu(%lu) \"\n\t\t\t  \"uid %u(%u) nr_map_ids %u(%u) map_id %u(%u) \"\n\t\t\t  \"name %s(%s)\\n\",\n\t\t\t  err, errno, i,\n\t\t\t  prog_infos[i].type, BPF_PROG_TYPE_SOCKET_FILTER,\n\t\t\t  info_len, sizeof(struct bpf_prog_info),\n\t\t\t  env.jit_enabled,\n\t\t\t  prog_infos[i].jited_prog_len,\n\t\t\t  prog_infos[i].xlated_prog_len,\n\t\t\t  !!memcmp(jited_insns, zeros, sizeof(zeros)),\n\t\t\t  !!memcmp(xlated_insns, zeros, sizeof(zeros)),\n\t\t\t  load_time, now,\n\t\t\t  prog_infos[i].created_by_uid, my_uid,\n\t\t\t  prog_infos[i].nr_map_ids, 1,\n\t\t\t  *(int *)(long)prog_infos[i].map_ids, map_infos[i].id,\n\t\t\t  prog_infos[i].name, expected_prog_name))\n\t\t\tgoto done;\n\n\t\t \n\t\tinfo_len = sizeof(struct bpf_link_info) * 2;\n\t\tbzero(&link_infos[i], info_len);\n\t\tlink_infos[i].raw_tracepoint.tp_name = ptr_to_u64(&tp_name);\n\t\tlink_infos[i].raw_tracepoint.tp_name_len = sizeof(tp_name);\n\t\terr = bpf_link_get_info_by_fd(bpf_link__fd(links[i]),\n\t\t\t\t\t      &link_infos[i], &info_len);\n\t\tif (CHECK(err ||\n\t\t\t  link_infos[i].type != BPF_LINK_TYPE_RAW_TRACEPOINT ||\n\t\t\t  link_infos[i].prog_id != prog_infos[i].id ||\n\t\t\t  link_infos[i].raw_tracepoint.tp_name != ptr_to_u64(&tp_name) ||\n\t\t\t  strcmp(u64_to_ptr(link_infos[i].raw_tracepoint.tp_name),\n\t\t\t\t \"sys_enter\") ||\n\t\t\t  info_len != sizeof(struct bpf_link_info),\n\t\t\t  \"get-link-info(fd)\",\n\t\t\t  \"err %d errno %d info_len %u(%zu) type %d(%d) id %d \"\n\t\t\t  \"prog_id %d (%d) tp_name %s(%s)\\n\",\n\t\t\t  err, errno,\n\t\t\t  info_len, sizeof(struct bpf_link_info),\n\t\t\t  link_infos[i].type, BPF_LINK_TYPE_RAW_TRACEPOINT,\n\t\t\t  link_infos[i].id,\n\t\t\t  link_infos[i].prog_id, prog_infos[i].id,\n\t\t\t  (const char *)u64_to_ptr(link_infos[i].raw_tracepoint.tp_name),\n\t\t\t  \"sys_enter\"))\n\t\t\tgoto done;\n\n\t}\n\n\t \n\tnr_id_found = 0;\n\tnext_id = 0;\n\twhile (!bpf_prog_get_next_id(next_id, &next_id)) {\n\t\tstruct bpf_prog_info prog_info = {};\n\t\t__u32 saved_map_id;\n\t\tint prog_fd;\n\n\t\tinfo_len = sizeof(prog_info);\n\n\t\tprog_fd = bpf_prog_get_fd_by_id(next_id);\n\t\tif (prog_fd < 0 && errno == ENOENT)\n\t\t\t \n\t\t\tcontinue;\n\t\tif (CHECK(prog_fd < 0, \"get-prog-fd(next_id)\",\n\t\t\t  \"prog_fd %d next_id %d errno %d\\n\",\n\t\t\t  prog_fd, next_id, errno))\n\t\t\tbreak;\n\n\t\tfor (i = 0; i < nr_iters; i++)\n\t\t\tif (prog_infos[i].id == next_id)\n\t\t\t\tbreak;\n\n\t\tif (i == nr_iters)\n\t\t\tcontinue;\n\n\t\tnr_id_found++;\n\n\t\t \n\t\tprog_info.nr_map_ids = 1;\n\t\terr = bpf_prog_get_info_by_fd(prog_fd, &prog_info, &info_len);\n\t\tif (CHECK(!err || errno != EFAULT,\n\t\t\t  \"get-prog-fd-bad-nr-map-ids\", \"err %d errno %d(%d)\",\n\t\t\t  err, errno, EFAULT))\n\t\t\tbreak;\n\t\tbzero(&prog_info, sizeof(prog_info));\n\t\tinfo_len = sizeof(prog_info);\n\n\t\tsaved_map_id = *(int *)((long)prog_infos[i].map_ids);\n\t\tprog_info.map_ids = prog_infos[i].map_ids;\n\t\tprog_info.nr_map_ids = 2;\n\t\terr = bpf_prog_get_info_by_fd(prog_fd, &prog_info, &info_len);\n\t\tprog_infos[i].jited_prog_insns = 0;\n\t\tprog_infos[i].xlated_prog_insns = 0;\n\t\tCHECK(err || info_len != sizeof(struct bpf_prog_info) ||\n\t\t      memcmp(&prog_info, &prog_infos[i], info_len) ||\n\t\t      *(int *)(long)prog_info.map_ids != saved_map_id,\n\t\t      \"get-prog-info(next_id->fd)\",\n\t\t      \"err %d errno %d info_len %u(%zu) memcmp %d map_id %u(%u)\\n\",\n\t\t      err, errno, info_len, sizeof(struct bpf_prog_info),\n\t\t      memcmp(&prog_info, &prog_infos[i], info_len),\n\t\t      *(int *)(long)prog_info.map_ids, saved_map_id);\n\t\tclose(prog_fd);\n\t}\n\tCHECK(nr_id_found != nr_iters,\n\t      \"check total prog id found by get_next_id\",\n\t      \"nr_id_found %u(%u)\\n\",\n\t      nr_id_found, nr_iters);\n\n\t \n\tnr_id_found = 0;\n\tnext_id = 0;\n\twhile (!bpf_map_get_next_id(next_id, &next_id)) {\n\t\tstruct bpf_map_info map_info = {};\n\t\tint map_fd;\n\n\t\tinfo_len = sizeof(map_info);\n\n\t\tmap_fd = bpf_map_get_fd_by_id(next_id);\n\t\tif (map_fd < 0 && errno == ENOENT)\n\t\t\t \n\t\t\tcontinue;\n\t\tif (CHECK(map_fd < 0, \"get-map-fd(next_id)\",\n\t\t\t  \"map_fd %d next_id %u errno %d\\n\",\n\t\t\t  map_fd, next_id, errno))\n\t\t\tbreak;\n\n\t\tfor (i = 0; i < nr_iters; i++)\n\t\t\tif (map_infos[i].id == next_id)\n\t\t\t\tbreak;\n\n\t\tif (i == nr_iters)\n\t\t\tcontinue;\n\n\t\tnr_id_found++;\n\n\t\terr = bpf_map_lookup_elem(map_fd, &array_key, &array_value);\n\t\tif (CHECK_FAIL(err))\n\t\t\tgoto done;\n\n\t\terr = bpf_map_get_info_by_fd(map_fd, &map_info, &info_len);\n\t\tCHECK(err || info_len != sizeof(struct bpf_map_info) ||\n\t\t      memcmp(&map_info, &map_infos[i], info_len) ||\n\t\t      array_value != array_magic_value,\n\t\t      \"check get-map-info(next_id->fd)\",\n\t\t      \"err %d errno %d info_len %u(%zu) memcmp %d array_value %llu(%llu)\\n\",\n\t\t      err, errno, info_len, sizeof(struct bpf_map_info),\n\t\t      memcmp(&map_info, &map_infos[i], info_len),\n\t\t      array_value, array_magic_value);\n\n\t\tclose(map_fd);\n\t}\n\tCHECK(nr_id_found != nr_iters,\n\t      \"check total map id found by get_next_id\",\n\t      \"nr_id_found %u(%u)\\n\",\n\t      nr_id_found, nr_iters);\n\n\t \n\tnr_id_found = 0;\n\tnext_id = 0;\n\twhile (!bpf_link_get_next_id(next_id, &next_id)) {\n\t\tstruct bpf_link_info link_info;\n\t\tint link_fd, cmp_res;\n\n\t\tinfo_len = sizeof(link_info);\n\t\tmemset(&link_info, 0, info_len);\n\n\t\tlink_fd = bpf_link_get_fd_by_id(next_id);\n\t\tif (link_fd < 0 && errno == ENOENT)\n\t\t\t \n\t\t\tcontinue;\n\t\tif (CHECK(link_fd < 0, \"get-link-fd(next_id)\",\n\t\t\t  \"link_fd %d next_id %u errno %d\\n\",\n\t\t\t  link_fd, next_id, errno))\n\t\t\tbreak;\n\n\t\tfor (i = 0; i < nr_iters; i++)\n\t\t\tif (link_infos[i].id == next_id)\n\t\t\t\tbreak;\n\n\t\tif (i == nr_iters)\n\t\t\tcontinue;\n\n\t\tnr_id_found++;\n\n\t\terr = bpf_link_get_info_by_fd(link_fd, &link_info, &info_len);\n\t\tcmp_res = memcmp(&link_info, &link_infos[i],\n\t\t\t\toffsetof(struct bpf_link_info, raw_tracepoint));\n\t\tCHECK(err || info_len != sizeof(link_info) || cmp_res,\n\t\t      \"check get-link-info(next_id->fd)\",\n\t\t      \"err %d errno %d info_len %u(%zu) memcmp %d\\n\",\n\t\t      err, errno, info_len, sizeof(struct bpf_link_info),\n\t\t      cmp_res);\n\n\t\tclose(link_fd);\n\t}\n\tCHECK(nr_id_found != nr_iters,\n\t      \"check total link id found by get_next_id\",\n\t      \"nr_id_found %u(%u)\\n\", nr_id_found, nr_iters);\n\ndone:\n\tfor (i = 0; i < nr_iters; i++) {\n\t\tbpf_link__destroy(links[i]);\n\t\tbpf_object__close(objs[i]);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}