{
  "module_name": "sockopt_sk.c",
  "hash_id": "b2dfe4f7dd3dd761e152300f2a9b8fd79394109b54f73f3f12380317c3bd9805",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/sockopt_sk.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"cgroup_helpers.h\"\n\n#include <linux/tcp.h>\n#include <linux/netlink.h>\n#include \"sockopt_sk.skel.h\"\n\n#ifndef SOL_TCP\n#define SOL_TCP IPPROTO_TCP\n#endif\n\n#define SOL_CUSTOM\t\t\t0xdeadbeef\n\nstatic int getsetsockopt(void)\n{\n\tint fd, err;\n\tunion {\n\t\tchar u8[4];\n\t\t__u32 u32;\n\t\tchar cc[16];  \n\t\tstruct tcp_zerocopy_receive zc;\n\t} buf = {};\n\tsocklen_t optlen;\n\tchar *big_buf = NULL;\n\n\tfd = socket(AF_INET, SOCK_STREAM, 0);\n\tif (fd < 0) {\n\t\tlog_err(\"Failed to create socket\");\n\t\treturn -1;\n\t}\n\n\t \n\n\toptlen = getpagesize() * 2;\n\tbig_buf = calloc(1, optlen);\n\tif (!big_buf) {\n\t\tlog_err(\"Couldn't allocate two pages\");\n\t\tgoto err;\n\t}\n\n\t*(int *)big_buf = 0x08;\n\terr = setsockopt(fd, SOL_IP, IP_TOS, big_buf, optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto err;\n\t}\n\n\tmemset(big_buf, 0, optlen);\n\toptlen = 1;\n\terr = getsockopt(fd, SOL_IP, IP_TOS, big_buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto err;\n\t}\n\n\tif (*big_buf != 0x08) {\n\t\tlog_err(\"Unexpected getsockopt(IP_TOS) optval 0x%x != 0x08\",\n\t\t\t(int)*big_buf);\n\t\tgoto err;\n\t}\n\n\t \n\n\tbuf.u8[0] = 1;\n\terr = setsockopt(fd, SOL_IP, IP_TTL, &buf, 1);\n\tif (!err || errno != EPERM) {\n\t\tlog_err(\"Unexpected success from setsockopt(IP_TTL)\");\n\t\tgoto err;\n\t}\n\n\t \n\n\tbuf.u8[0] = 0x01;\n\terr = setsockopt(fd, SOL_CUSTOM, 0, &buf, 1);\n\tif (err) {\n\t\tlog_err(\"Failed to call setsockopt\");\n\t\tgoto err;\n\t}\n\n\tbuf.u32 = 0x00;\n\toptlen = 4;\n\terr = getsockopt(fd, SOL_CUSTOM, 0, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt\");\n\t\tgoto err;\n\t}\n\n\tif (optlen != 1) {\n\t\tlog_err(\"Unexpected optlen %d != 1\", optlen);\n\t\tgoto err;\n\t}\n\tif (buf.u8[0] != 0x01) {\n\t\tlog_err(\"Unexpected buf[0] 0x%02x != 0x01\", buf.u8[0]);\n\t\tgoto err;\n\t}\n\n\t \n\n\toptlen = getpagesize() * 2;\n\tmemset(big_buf, 0, optlen);\n\n\terr = setsockopt(fd, SOL_IP, IP_FREEBIND, big_buf, optlen);\n\tif (err != 0) {\n\t\tlog_err(\"Failed to call setsockopt, ret=%d\", err);\n\t\tgoto err;\n\t}\n\n\terr = getsockopt(fd, SOL_IP, IP_FREEBIND, big_buf, &optlen);\n\tif (err != 0) {\n\t\tlog_err(\"Failed to call getsockopt, ret=%d\", err);\n\t\tgoto err;\n\t}\n\n\tif (optlen != 1 || *(__u8 *)big_buf != 0x55) {\n\t\tlog_err(\"Unexpected IP_FREEBIND getsockopt, optlen=%d, optval=0x%x\",\n\t\t\toptlen, *(__u8 *)big_buf);\n\t}\n\n\t \n\n\tbuf.u32 = 0x01010101;\n\terr = setsockopt(fd, SOL_SOCKET, SO_SNDBUF, &buf, 4);\n\tif (err) {\n\t\tlog_err(\"Failed to call setsockopt(SO_SNDBUF)\");\n\t\tgoto err;\n\t}\n\n\tbuf.u32 = 0x00;\n\toptlen = 4;\n\terr = getsockopt(fd, SOL_SOCKET, SO_SNDBUF, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(SO_SNDBUF)\");\n\t\tgoto err;\n\t}\n\n\tif (buf.u32 != 0x55AA*2) {\n\t\tlog_err(\"Unexpected getsockopt(SO_SNDBUF) 0x%x != 0x55AA*2\",\n\t\t\tbuf.u32);\n\t\tgoto err;\n\t}\n\n\t \n\n\tstrcpy(buf.cc, \"nv\");\n\terr = setsockopt(fd, SOL_TCP, TCP_CONGESTION, &buf, strlen(\"nv\"));\n\tif (err) {\n\t\tlog_err(\"Failed to call setsockopt(TCP_CONGESTION)\");\n\t\tgoto err;\n\t}\n\n\n\toptlen = sizeof(buf.cc);\n\terr = getsockopt(fd, SOL_TCP, TCP_CONGESTION, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(TCP_CONGESTION)\");\n\t\tgoto err;\n\t}\n\n\tif (strcmp(buf.cc, \"cubic\") != 0) {\n\t\tlog_err(\"Unexpected getsockopt(TCP_CONGESTION) %s != %s\",\n\t\t\tbuf.cc, \"cubic\");\n\t\tgoto err;\n\t}\n\n\t \n\tmemset(&buf, 0, sizeof(buf));\n\toptlen = sizeof(buf.zc);\n\terr = getsockopt(fd, SOL_TCP, TCP_ZEROCOPY_RECEIVE, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Unexpected getsockopt(TCP_ZEROCOPY_RECEIVE) err=%d errno=%d\",\n\t\t\terr, errno);\n\t\tgoto err;\n\t}\n\n\tmemset(&buf, 0, sizeof(buf));\n\tbuf.zc.address = 12345;  \n\toptlen = sizeof(buf.zc);\n\terrno = 0;\n\terr = getsockopt(fd, SOL_TCP, TCP_ZEROCOPY_RECEIVE, &buf, &optlen);\n\tif (errno != EINVAL) {\n\t\tlog_err(\"Unexpected getsockopt(TCP_ZEROCOPY_RECEIVE) err=%d errno=%d\",\n\t\t\terr, errno);\n\t\tgoto err;\n\t}\n\n\t \n\n\tclose(fd);\n\tfd = socket(AF_NETLINK, SOCK_RAW, 0);\n\tif (fd < 0) {\n\t\tlog_err(\"Failed to create AF_NETLINK socket\");\n\t\treturn -1;\n\t}\n\n\tbuf.u32 = 1;\n\toptlen = sizeof(__u32);\n\terr = setsockopt(fd, SOL_NETLINK, NETLINK_ADD_MEMBERSHIP, &buf, optlen);\n\tif (err) {\n\t\tlog_err(\"Unexpected getsockopt(NETLINK_ADD_MEMBERSHIP) err=%d errno=%d\",\n\t\t\terr, errno);\n\t\tgoto err;\n\t}\n\n\toptlen = 0;\n\terr = getsockopt(fd, SOL_NETLINK, NETLINK_LIST_MEMBERSHIPS, NULL, &optlen);\n\tif (err) {\n\t\tlog_err(\"Unexpected getsockopt(NETLINK_LIST_MEMBERSHIPS) err=%d errno=%d\",\n\t\t\terr, errno);\n\t\tgoto err;\n\t}\n\tASSERT_EQ(optlen, 8, \"Unexpected NETLINK_LIST_MEMBERSHIPS value\");\n\n\tfree(big_buf);\n\tclose(fd);\n\treturn 0;\nerr:\n\tfree(big_buf);\n\tclose(fd);\n\treturn -1;\n}\n\nstatic void run_test(int cgroup_fd)\n{\n\tstruct sockopt_sk *skel;\n\n\tskel = sockopt_sk__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_load\"))\n\t\tgoto cleanup;\n\n\tskel->bss->page_size = getpagesize();\n\n\tskel->links._setsockopt =\n\t\tbpf_program__attach_cgroup(skel->progs._setsockopt, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links._setsockopt, \"setsockopt_link\"))\n\t\tgoto cleanup;\n\n\tskel->links._getsockopt =\n\t\tbpf_program__attach_cgroup(skel->progs._getsockopt, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links._getsockopt, \"getsockopt_link\"))\n\t\tgoto cleanup;\n\n\tASSERT_OK(getsetsockopt(), \"getsetsockopt\");\n\ncleanup:\n\tsockopt_sk__destroy(skel);\n}\n\nvoid test_sockopt_sk(void)\n{\n\tint cgroup_fd;\n\n\tcgroup_fd = test__join_cgroup(\"/sockopt_sk\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup /sockopt_sk\"))\n\t\treturn;\n\n\trun_test(cgroup_fd);\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}