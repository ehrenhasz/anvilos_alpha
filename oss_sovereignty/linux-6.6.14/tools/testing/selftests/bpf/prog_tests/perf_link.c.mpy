{
  "module_name": "perf_link.c",
  "hash_id": "41cfd945b07bd16b4229a8df5e155eb1dc4ca2ce248853e7aad3b4640e662d56",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/perf_link.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n#include <pthread.h>\n#include <sched.h>\n#include <test_progs.h>\n#include \"test_perf_link.skel.h\"\n\nstatic void burn_cpu(void)\n{\n\tvolatile int j = 0;\n\tcpu_set_t cpu_set;\n\tint i, err;\n\n\t \n\tCPU_ZERO(&cpu_set);\n\tCPU_SET(0, &cpu_set);\n\terr = pthread_setaffinity_np(pthread_self(), sizeof(cpu_set), &cpu_set);\n\tASSERT_OK(err, \"set_thread_affinity\");\n\n\t \n\tfor (i = 0; i < 1000000; ++i)\n\t\t++j;\n}\n\n \nvoid serial_test_perf_link(void)\n{\n\tstruct test_perf_link *skel = NULL;\n\tstruct perf_event_attr attr;\n\tint pfd = -1, link_fd = -1, err;\n\tint run_cnt_before, run_cnt_after;\n\tstruct bpf_link_info info;\n\t__u32 info_len = sizeof(info);\n\n\t \n\tmemset(&attr, 0, sizeof(attr));\n\tattr.size = sizeof(attr);\n\tattr.type = PERF_TYPE_SOFTWARE;\n\tattr.config = PERF_COUNT_SW_CPU_CLOCK;\n\tattr.freq = 1;\n\tattr.sample_freq = 1000;\n\tpfd = syscall(__NR_perf_event_open, &attr, -1, 0, -1, PERF_FLAG_FD_CLOEXEC);\n\tif (!ASSERT_GE(pfd, 0, \"perf_fd\"))\n\t\tgoto cleanup;\n\n\tskel = test_perf_link__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_load\"))\n\t\tgoto cleanup;\n\n\tlink_fd = bpf_link_create(bpf_program__fd(skel->progs.handler), pfd,\n\t\t\t\t  BPF_PERF_EVENT, NULL);\n\tif (!ASSERT_GE(link_fd, 0, \"link_fd\"))\n\t\tgoto cleanup;\n\n\tmemset(&info, 0, sizeof(info));\n\terr = bpf_link_get_info_by_fd(link_fd, &info, &info_len);\n\tif (!ASSERT_OK(err, \"link_get_info\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(info.type, BPF_LINK_TYPE_PERF_EVENT, \"link_type\");\n\tASSERT_GT(info.id, 0, \"link_id\");\n\tASSERT_GT(info.prog_id, 0, \"link_prog_id\");\n\n\t \n\tburn_cpu();\n\tASSERT_GT(skel->bss->run_cnt, 0, \"run_cnt\");\n\n\t \n\tclose(link_fd);\n\tlink_fd = -1;\n\n\t \n\tkern_sync_rcu();\n\n\trun_cnt_before = skel->bss->run_cnt;\n\tburn_cpu();\n\trun_cnt_after = skel->bss->run_cnt;\n\n\tASSERT_EQ(run_cnt_before, run_cnt_after, \"run_cnt_before_after\");\n\ncleanup:\n\tif (link_fd >= 0)\n\t\tclose(link_fd);\n\tif (pfd >= 0)\n\t\tclose(pfd);\n\ttest_perf_link__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}