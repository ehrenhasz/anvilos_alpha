{
  "module_name": "xdp_link.c",
  "hash_id": "4711924ddc2671c2ec9fa2e01cd7c33bf8be6a9fef1b3e9d527833a0711bf77d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/xdp_link.c",
  "human_readable_source": "\n \n#include <uapi/linux/if_link.h>\n#include <test_progs.h>\n#include \"test_xdp_link.skel.h\"\n\n#define IFINDEX_LO 1\n\nvoid serial_test_xdp_link(void)\n{\n\tstruct test_xdp_link *skel1 = NULL, *skel2 = NULL;\n\t__u32 id1, id2, id0 = 0, prog_fd1, prog_fd2;\n\tLIBBPF_OPTS(bpf_xdp_attach_opts, opts);\n\tstruct bpf_link_info link_info;\n\tstruct bpf_prog_info prog_info;\n\tstruct bpf_link *link;\n\tint err;\n\t__u32 link_info_len = sizeof(link_info);\n\t__u32 prog_info_len = sizeof(prog_info);\n\n\tskel1 = test_xdp_link__open_and_load();\n\tif (!ASSERT_OK_PTR(skel1, \"skel_load\"))\n\t\tgoto cleanup;\n\tprog_fd1 = bpf_program__fd(skel1->progs.xdp_handler);\n\n\tskel2 = test_xdp_link__open_and_load();\n\tif (!ASSERT_OK_PTR(skel2, \"skel_load\"))\n\t\tgoto cleanup;\n\tprog_fd2 = bpf_program__fd(skel2->progs.xdp_handler);\n\n\tmemset(&prog_info, 0, sizeof(prog_info));\n\terr = bpf_prog_get_info_by_fd(prog_fd1, &prog_info, &prog_info_len);\n\tif (!ASSERT_OK(err, \"fd_info1\"))\n\t\tgoto cleanup;\n\tid1 = prog_info.id;\n\n\tmemset(&prog_info, 0, sizeof(prog_info));\n\terr = bpf_prog_get_info_by_fd(prog_fd2, &prog_info, &prog_info_len);\n\tif (!ASSERT_OK(err, \"fd_info2\"))\n\t\tgoto cleanup;\n\tid2 = prog_info.id;\n\n\t \n\terr = bpf_xdp_attach(IFINDEX_LO, prog_fd1, XDP_FLAGS_REPLACE, &opts);\n\tif (!ASSERT_OK(err, \"fd_attach\"))\n\t\tgoto cleanup;\n\n\t \n\terr = bpf_xdp_query_id(IFINDEX_LO, 0, &id0);\n\tif (!ASSERT_OK(err, \"id1_check_err\") || !ASSERT_EQ(id0, id1, \"id1_check_val\"))\n\t\tgoto cleanup;\n\n\t \n\tlink = bpf_program__attach_xdp(skel1->progs.xdp_handler, IFINDEX_LO);\n\tif (!ASSERT_ERR_PTR(link, \"link_attach_should_fail\")) {\n\t\tbpf_link__destroy(link);\n\t\t \n\t\topts.old_prog_fd = prog_fd1;\n\t\tbpf_xdp_detach(IFINDEX_LO, XDP_FLAGS_REPLACE, &opts);\n\t\tgoto cleanup;\n\t}\n\n\t \n\topts.old_prog_fd = prog_fd1;\n\terr = bpf_xdp_detach(IFINDEX_LO, XDP_FLAGS_REPLACE, &opts);\n\tif (!ASSERT_OK(err, \"prog_detach\"))\n\t\tgoto cleanup;\n\n\t \n\tlink = bpf_program__attach_xdp(skel1->progs.xdp_handler, IFINDEX_LO);\n\tif (!ASSERT_OK_PTR(link, \"link_attach\"))\n\t\tgoto cleanup;\n\tskel1->links.xdp_handler = link;\n\n\t \n\terr = bpf_xdp_query_id(IFINDEX_LO, 0, &id0);\n\tif (!ASSERT_OK(err, \"id1_check_err\") || !ASSERT_EQ(id0, id1, \"id1_check_val\"))\n\t\tgoto cleanup;\n\n\t \n\topts.old_prog_fd = prog_fd1;\n\terr = bpf_xdp_attach(IFINDEX_LO, prog_fd2, XDP_FLAGS_REPLACE, &opts);\n\tif (!ASSERT_ERR(err, \"prog_attach_fail\"))\n\t\tgoto cleanup;\n\n\t \n\terr = bpf_xdp_attach(IFINDEX_LO, prog_fd2, 0, NULL);\n\tif (!ASSERT_ERR(err, \"prog_update_fail\"))\n\t\tgoto cleanup;\n\n\t \n\terr = bpf_xdp_detach(IFINDEX_LO, 0, NULL);\n\tif (!ASSERT_ERR(err, \"prog_detach_fail\"))\n\t\tgoto cleanup;\n\n\t \n\tlink = bpf_program__attach_xdp(skel2->progs.xdp_handler, IFINDEX_LO);\n\tif (!ASSERT_ERR_PTR(link, \"link_attach_should_fail\")) {\n\t\tbpf_link__destroy(link);\n\t\tgoto cleanup;\n\t}\n\n\tbpf_link__destroy(skel1->links.xdp_handler);\n\tskel1->links.xdp_handler = NULL;\n\n\t \n\tlink = bpf_program__attach_xdp(skel2->progs.xdp_handler, IFINDEX_LO);\n\tif (!ASSERT_OK_PTR(link, \"link_attach\"))\n\t\tgoto cleanup;\n\tskel2->links.xdp_handler = link;\n\n\terr = bpf_xdp_query_id(IFINDEX_LO, 0, &id0);\n\tif (!ASSERT_OK(err, \"id2_check_err\") || !ASSERT_EQ(id0, id2, \"id2_check_val\"))\n\t\tgoto cleanup;\n\n\t \n\terr = bpf_link__update_program(link, skel1->progs.xdp_handler);\n\tif (!ASSERT_OK(err, \"link_upd\"))\n\t\tgoto cleanup;\n\n\tmemset(&link_info, 0, sizeof(link_info));\n\terr = bpf_link_get_info_by_fd(bpf_link__fd(link),\n\t\t\t\t      &link_info, &link_info_len);\n\tif (!ASSERT_OK(err, \"link_info\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(link_info.type, BPF_LINK_TYPE_XDP, \"link_type\");\n\tASSERT_EQ(link_info.prog_id, id1, \"link_prog_id\");\n\tASSERT_EQ(link_info.xdp.ifindex, IFINDEX_LO, \"link_ifindex\");\n\n\t \n\terr = bpf_link__update_program(link, skel1->progs.tc_handler);\n\tif (!ASSERT_ERR(err, \"link_upd_invalid\"))\n\t\tgoto cleanup;\n\n\terr = bpf_link__detach(link);\n\tif (!ASSERT_OK(err, \"link_detach\"))\n\t\tgoto cleanup;\n\n\tmemset(&link_info, 0, sizeof(link_info));\n\terr = bpf_link_get_info_by_fd(bpf_link__fd(link),\n\t\t\t\t      &link_info, &link_info_len);\n\n\tASSERT_OK(err, \"link_info\");\n\tASSERT_EQ(link_info.prog_id, id1, \"link_prog_id\");\n\t \n\tASSERT_EQ(link_info.xdp.ifindex, 0, \"link_ifindex\");\n\ncleanup:\n\ttest_xdp_link__destroy(skel1);\n\ttest_xdp_link__destroy(skel2);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}