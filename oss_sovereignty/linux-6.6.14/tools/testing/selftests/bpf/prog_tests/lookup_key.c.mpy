{
  "module_name": "lookup_key.c",
  "hash_id": "025af16eaf1ed7a9c7ceb3ee1faa3c4d6a5867fbd82d39e23877053cb4230309",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/lookup_key.c",
  "human_readable_source": "\n\n \n\n#include <linux/keyctl.h>\n#include <test_progs.h>\n\n#include \"test_lookup_key.skel.h\"\n\n#define KEY_LOOKUP_CREATE\t0x01\n#define KEY_LOOKUP_PARTIAL\t0x02\n\nstatic bool kfunc_not_supported;\n\nstatic int libbpf_print_cb(enum libbpf_print_level level, const char *fmt,\n\t\t\t   va_list args)\n{\n\tchar *func;\n\n\tif (strcmp(fmt, \"libbpf: extern (func ksym) '%s': not found in kernel or module BTFs\\n\"))\n\t\treturn 0;\n\n\tfunc = va_arg(args, char *);\n\n\tif (strcmp(func, \"bpf_lookup_user_key\") && strcmp(func, \"bpf_key_put\") &&\n\t    strcmp(func, \"bpf_lookup_system_key\"))\n\t\treturn 0;\n\n\tkfunc_not_supported = true;\n\treturn 0;\n}\n\nvoid test_lookup_key(void)\n{\n\tlibbpf_print_fn_t old_print_cb;\n\tstruct test_lookup_key *skel;\n\t__u32 next_id;\n\tint ret;\n\n\tskel = test_lookup_key__open();\n\tif (!ASSERT_OK_PTR(skel, \"test_lookup_key__open\"))\n\t\treturn;\n\n\told_print_cb = libbpf_set_print(libbpf_print_cb);\n\tret = test_lookup_key__load(skel);\n\tlibbpf_set_print(old_print_cb);\n\n\tif (ret < 0 && kfunc_not_supported) {\n\t\tprintf(\"%s:SKIP:bpf_lookup_*_key(), bpf_key_put() kfuncs not supported\\n\",\n\t\t       __func__);\n\t\ttest__skip();\n\t\tgoto close_prog;\n\t}\n\n\tif (!ASSERT_OK(ret, \"test_lookup_key__load\"))\n\t\tgoto close_prog;\n\n\tret = test_lookup_key__attach(skel);\n\tif (!ASSERT_OK(ret, \"test_lookup_key__attach\"))\n\t\tgoto close_prog;\n\n\tskel->bss->monitored_pid = getpid();\n\tskel->bss->key_serial = KEY_SPEC_THREAD_KEYRING;\n\n\t \n\tskel->bss->flags = 0;\n\n\tret = bpf_prog_get_next_id(0, &next_id);\n\tif (!ASSERT_LT(ret, 0, \"bpf_prog_get_next_id\"))\n\t\tgoto close_prog;\n\n\t \n\tskel->bss->flags = KEY_LOOKUP_CREATE;\n\n\tret = bpf_prog_get_next_id(0, &next_id);\n\tif (!ASSERT_OK(ret, \"bpf_prog_get_next_id\"))\n\t\tgoto close_prog;\n\n\t \n\tskel->bss->flags = KEY_LOOKUP_CREATE | KEY_LOOKUP_PARTIAL;\n\n\tret = bpf_prog_get_next_id(0, &next_id);\n\tif (!ASSERT_OK(ret, \"bpf_prog_get_next_id\"))\n\t\tgoto close_prog;\n\n\t \n\tskel->bss->flags = UINT64_MAX;\n\n\tret = bpf_prog_get_next_id(0, &next_id);\n\tif (!ASSERT_LT(ret, 0, \"bpf_prog_get_next_id\"))\n\t\tgoto close_prog;\n\n\tskel->bss->key_serial = 0;\n\tskel->bss->key_id = 1;\n\n\tret = bpf_prog_get_next_id(0, &next_id);\n\tif (!ASSERT_OK(ret, \"bpf_prog_get_next_id\"))\n\t\tgoto close_prog;\n\n\tskel->bss->key_id = UINT32_MAX;\n\n\tret = bpf_prog_get_next_id(0, &next_id);\n\tASSERT_LT(ret, 0, \"bpf_prog_get_next_id\");\n\nclose_prog:\n\tskel->bss->monitored_pid = 0;\n\ttest_lookup_key__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}