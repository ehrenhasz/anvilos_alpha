{
  "module_name": "xdp_context_test_run.c",
  "hash_id": "19d6cc2a38c43378631859d675a43ec7ac8c6c4868f15bf87f5a722cad77e914",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/xdp_context_test_run.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include <network_helpers.h>\n#include \"test_xdp_context_test_run.skel.h\"\n\nvoid test_xdp_context_error(int prog_fd, struct bpf_test_run_opts opts,\n\t\t\t    __u32 data_meta, __u32 data, __u32 data_end,\n\t\t\t    __u32 ingress_ifindex, __u32 rx_queue_index,\n\t\t\t    __u32 egress_ifindex)\n{\n\tstruct xdp_md ctx = {\n\t\t.data = data,\n\t\t.data_end = data_end,\n\t\t.data_meta = data_meta,\n\t\t.ingress_ifindex = ingress_ifindex,\n\t\t.rx_queue_index = rx_queue_index,\n\t\t.egress_ifindex = egress_ifindex,\n\t};\n\tint err;\n\n\topts.ctx_in = &ctx;\n\topts.ctx_size_in = sizeof(ctx);\n\terr = bpf_prog_test_run_opts(prog_fd, &opts);\n\tASSERT_EQ(errno, EINVAL, \"errno-EINVAL\");\n\tASSERT_ERR(err, \"bpf_prog_test_run\");\n}\n\nvoid test_xdp_context_test_run(void)\n{\n\tstruct test_xdp_context_test_run *skel = NULL;\n\tchar data[sizeof(pkt_v4) + sizeof(__u32)];\n\tchar bad_ctx[sizeof(struct xdp_md) + 1];\n\tstruct xdp_md ctx_in, ctx_out;\n\tDECLARE_LIBBPF_OPTS(bpf_test_run_opts, opts,\n\t\t\t    .data_in = &data,\n\t\t\t    .data_size_in = sizeof(data),\n\t\t\t    .ctx_out = &ctx_out,\n\t\t\t    .ctx_size_out = sizeof(ctx_out),\n\t\t\t    .repeat = 1,\n\t\t);\n\tint err, prog_fd;\n\n\tskel = test_xdp_context_test_run__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel\"))\n\t\treturn;\n\tprog_fd = bpf_program__fd(skel->progs.xdp_context);\n\n\t \n\tbad_ctx[sizeof(bad_ctx) - 1] = 1;\n\topts.ctx_in = bad_ctx;\n\topts.ctx_size_in = sizeof(bad_ctx);\n\terr = bpf_prog_test_run_opts(prog_fd, &opts);\n\tASSERT_EQ(errno, E2BIG, \"extradata-errno\");\n\tASSERT_ERR(err, \"bpf_prog_test_run(extradata)\");\n\n\t*(__u32 *)data = XDP_PASS;\n\t*(struct ipv4_packet *)(data + sizeof(__u32)) = pkt_v4;\n\topts.ctx_in = &ctx_in;\n\topts.ctx_size_in = sizeof(ctx_in);\n\tmemset(&ctx_in, 0, sizeof(ctx_in));\n\tctx_in.data_meta = 0;\n\tctx_in.data = sizeof(__u32);\n\tctx_in.data_end = ctx_in.data + sizeof(pkt_v4);\n\terr = bpf_prog_test_run_opts(prog_fd, &opts);\n\tASSERT_OK(err, \"bpf_prog_test_run(valid)\");\n\tASSERT_EQ(opts.retval, XDP_PASS, \"valid-retval\");\n\tASSERT_EQ(opts.data_size_out, sizeof(pkt_v4), \"valid-datasize\");\n\tASSERT_EQ(opts.ctx_size_out, opts.ctx_size_in, \"valid-ctxsize\");\n\tASSERT_EQ(ctx_out.data_meta, 0, \"valid-datameta\");\n\tASSERT_EQ(ctx_out.data, 0, \"valid-data\");\n\tASSERT_EQ(ctx_out.data_end, sizeof(pkt_v4), \"valid-dataend\");\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 0, 1, sizeof(data), 0, 0, 0);\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 4, sizeof(__u32), sizeof(data),\n\t\t\t       0, 0, 0);\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 0, 36, sizeof(data), 0, 0, 0);\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 0, sizeof(__u32),\n\t\t\t       sizeof(data) - 1, 0, 0, 0);\n\ttest_xdp_context_error(prog_fd, opts, 0, sizeof(__u32),\n\t\t\t       sizeof(data) + 1, 0, 0, 0);\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 0, sizeof(__u32), sizeof(data),\n\t\t\t       0, 1, 0);\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 0, sizeof(__u32), sizeof(data),\n\t\t\t       1, 1, 0);\n\n\t \n\ttest_xdp_context_error(prog_fd, opts, 0, sizeof(__u32), sizeof(data),\n\t\t\t       0, 0, 1);\n\n\ttest_xdp_context_test_run__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}