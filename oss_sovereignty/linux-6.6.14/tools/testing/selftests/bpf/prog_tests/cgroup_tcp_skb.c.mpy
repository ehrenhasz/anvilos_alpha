{
  "module_name": "cgroup_tcp_skb.c",
  "hash_id": "ba99ed66b58a5d916f0b909fdf38a189831040dc55c9e4616f417c861bbf5106",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgroup_tcp_skb.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include <linux/in6.h>\n#include <sys/socket.h>\n#include <sched.h>\n#include <unistd.h>\n#include \"cgroup_helpers.h\"\n#include \"testing_helpers.h\"\n#include \"cgroup_tcp_skb.skel.h\"\n#include \"cgroup_tcp_skb.h\"\n#include \"network_helpers.h\"\n\n#define CGROUP_TCP_SKB_PATH \"/test_cgroup_tcp_skb\"\n\nstatic int install_filters(int cgroup_fd,\n\t\t\t   struct bpf_link **egress_link,\n\t\t\t   struct bpf_link **ingress_link,\n\t\t\t   struct bpf_program *egress_prog,\n\t\t\t   struct bpf_program *ingress_prog,\n\t\t\t   struct cgroup_tcp_skb *skel)\n{\n\t \n\tskel->bss->g_sock_state = 0;\n\tskel->bss->g_unexpected = 0;\n\t*egress_link =\n\t\tbpf_program__attach_cgroup(egress_prog,\n\t\t\t\t\t   cgroup_fd);\n\tif (!ASSERT_OK_PTR(egress_link, \"egress_link\"))\n\t\treturn -1;\n\t*ingress_link =\n\t\tbpf_program__attach_cgroup(ingress_prog,\n\t\t\t\t\t   cgroup_fd);\n\tif (!ASSERT_OK_PTR(ingress_link, \"ingress_link\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic void uninstall_filters(struct bpf_link **egress_link,\n\t\t\t      struct bpf_link **ingress_link)\n{\n\tbpf_link__destroy(*egress_link);\n\t*egress_link = NULL;\n\tbpf_link__destroy(*ingress_link);\n\t*ingress_link = NULL;\n}\n\nstatic int create_client_sock_v6(void)\n{\n\tint fd;\n\n\tfd = socket(AF_INET6, SOCK_STREAM, 0);\n\tif (fd < 0) {\n\t\tperror(\"socket\");\n\t\treturn -1;\n\t}\n\n\treturn fd;\n}\n\n \nstatic int talk_to_cgroup(int *client_fd, int *listen_fd, int *service_fd,\n\t\t\t  struct cgroup_tcp_skb *skel)\n{\n\tint err, cp;\n\tchar buf[5];\n\tint port;\n\n\t \n\terr = join_root_cgroup();\n\tif (!ASSERT_OK(err, \"join_root_cgroup\"))\n\t\treturn -1;\n\t*client_fd = create_client_sock_v6();\n\tif (!ASSERT_GE(*client_fd, 0, \"client_fd\"))\n\t\treturn -1;\n\terr = join_cgroup(CGROUP_TCP_SKB_PATH);\n\tif (!ASSERT_OK(err, \"join_cgroup\"))\n\t\treturn -1;\n\t*listen_fd = start_server(AF_INET6, SOCK_STREAM, NULL, 0, 0);\n\tif (!ASSERT_GE(*listen_fd, 0, \"listen_fd\"))\n\t\treturn -1;\n\tport = get_socket_local_port(*listen_fd);\n\tif (!ASSERT_GE(port, 0, \"get_socket_local_port\"))\n\t\treturn -1;\n\tskel->bss->g_sock_port = ntohs(port);\n\n\t \n\terr = connect_fd_to_fd(*client_fd, *listen_fd, 0);\n\tif (!ASSERT_OK(err, \"connect_fd_to_fd\"))\n\t\treturn -1;\n\t*service_fd = accept(*listen_fd, NULL, NULL);\n\tif (!ASSERT_GE(*service_fd, 0, \"service_fd\"))\n\t\treturn -1;\n\terr = join_root_cgroup();\n\tif (!ASSERT_OK(err, \"join_root_cgroup\"))\n\t\treturn -1;\n\tcp = write(*client_fd, \"hello\", 5);\n\tif (!ASSERT_EQ(cp, 5, \"write\"))\n\t\treturn -1;\n\tcp = read(*service_fd, buf, 5);\n\tif (!ASSERT_EQ(cp, 5, \"read\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\n \nstatic int talk_to_outside(int *client_fd, int *listen_fd, int *service_fd,\n\t\t\t   struct cgroup_tcp_skb *skel)\n\n{\n\tint err, cp;\n\tchar buf[5];\n\tint port;\n\n\t \n\terr = join_root_cgroup();\n\tif (!ASSERT_OK(err, \"join_root_cgroup\"))\n\t\treturn -1;\n\t*listen_fd = start_server(AF_INET6, SOCK_STREAM, NULL, 0, 0);\n\tif (!ASSERT_GE(*listen_fd, 0, \"listen_fd\"))\n\t\treturn -1;\n\terr = join_cgroup(CGROUP_TCP_SKB_PATH);\n\tif (!ASSERT_OK(err, \"join_cgroup\"))\n\t\treturn -1;\n\t*client_fd = create_client_sock_v6();\n\tif (!ASSERT_GE(*client_fd, 0, \"client_fd\"))\n\t\treturn -1;\n\terr = join_root_cgroup();\n\tif (!ASSERT_OK(err, \"join_root_cgroup\"))\n\t\treturn -1;\n\tport = get_socket_local_port(*listen_fd);\n\tif (!ASSERT_GE(port, 0, \"get_socket_local_port\"))\n\t\treturn -1;\n\tskel->bss->g_sock_port = ntohs(port);\n\n\t \n\terr = connect_fd_to_fd(*client_fd, *listen_fd, 0);\n\tif (!ASSERT_OK(err, \"connect_fd_to_fd\"))\n\t\treturn -1;\n\t*service_fd = accept(*listen_fd, NULL, NULL);\n\tif (!ASSERT_GE(*service_fd, 0, \"service_fd\"))\n\t\treturn -1;\n\tcp = write(*client_fd, \"hello\", 5);\n\tif (!ASSERT_EQ(cp, 5, \"write\"))\n\t\treturn -1;\n\tcp = read(*service_fd, buf, 5);\n\tif (!ASSERT_EQ(cp, 5, \"read\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic int close_connection(int *closing_fd, int *peer_fd, int *listen_fd,\n\t\t\t    struct cgroup_tcp_skb *skel)\n{\n\t__u32 saved_packet_count = 0;\n\tint err;\n\tint i;\n\n\t \n\tsaved_packet_count = skel->bss->g_packet_count;\n\tusleep(100000);\t\t \n\tfor (i = 0;\n\t     skel->bss->g_packet_count != saved_packet_count && i < 10;\n\t     i++) {\n\t\tsaved_packet_count = skel->bss->g_packet_count;\n\t\tusleep(100000);\t \n\t}\n\tif (!ASSERT_EQ(skel->bss->g_packet_count, saved_packet_count,\n\t\t       \"packet_count\"))\n\t\treturn -1;\n\n\tskel->bss->g_packet_count = 0;\n\tsaved_packet_count = 0;\n\n\t \n\terr = shutdown(*closing_fd, SHUT_WR);\n\tif (!ASSERT_OK(err, \"shutdown closing_fd\"))\n\t\treturn -1;\n\n\t \n\tfor (i = 0;\n\t     skel->bss->g_packet_count < saved_packet_count + 2 && i < 10;\n\t     i++)\n\t\tusleep(100000);\t \n\tif (!ASSERT_GE(skel->bss->g_packet_count, saved_packet_count + 2,\n\t\t       \"packet_count\"))\n\t\treturn -1;\n\n\tsaved_packet_count = skel->bss->g_packet_count;\n\n\t \n\terr = close(*peer_fd);\n\tif (!ASSERT_OK(err, \"close peer_fd\"))\n\t\treturn -1;\n\t*peer_fd = -1;\n\n\t \n\tfor (i = 0;\n\t     skel->bss->g_packet_count < saved_packet_count + 2 && i < 10;\n\t     i++)\n\t\tusleep(100000);\t \n\tif (!ASSERT_GE(skel->bss->g_packet_count, saved_packet_count + 2,\n\t\t       \"packet_count\"))\n\t\treturn -1;\n\n\terr = close(*closing_fd);\n\tif (!ASSERT_OK(err, \"close closing_fd\"))\n\t\treturn -1;\n\t*closing_fd = -1;\n\n\tclose(*listen_fd);\n\t*listen_fd = -1;\n\n\treturn 0;\n}\n\n \nvoid test_cgroup_tcp_skb(void)\n{\n\tstruct bpf_link *ingress_link = NULL;\n\tstruct bpf_link *egress_link = NULL;\n\tint client_fd = -1, listen_fd = -1;\n\tstruct cgroup_tcp_skb *skel;\n\tint service_fd = -1;\n\tint cgroup_fd = -1;\n\tint err;\n\n\tskel = cgroup_tcp_skb__open_and_load();\n\tif (!ASSERT_OK(!skel, \"skel_open_load\"))\n\t\treturn;\n\n\terr = setup_cgroup_environment();\n\tif (!ASSERT_OK(err, \"setup_cgroup_environment\"))\n\t\tgoto cleanup;\n\n\tcgroup_fd = create_and_get_cgroup(CGROUP_TCP_SKB_PATH);\n\tif (!ASSERT_GE(cgroup_fd, 0, \"cgroup_fd\"))\n\t\tgoto cleanup;\n\n\t \n\terr = install_filters(cgroup_fd, &egress_link, &ingress_link,\n\t\t\t      skel->progs.server_egress,\n\t\t\t      skel->progs.server_ingress,\n\t\t\t      skel);\n\tif (!ASSERT_OK(err, \"install_filters\"))\n\t\tgoto cleanup;\n\n\terr = talk_to_cgroup(&client_fd, &listen_fd, &service_fd, skel);\n\tif (!ASSERT_OK(err, \"talk_to_cgroup\"))\n\t\tgoto cleanup;\n\n\terr = close_connection(&client_fd, &service_fd, &listen_fd, skel);\n\tif (!ASSERT_OK(err, \"close_connection\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(skel->bss->g_unexpected, 0, \"g_unexpected\");\n\tASSERT_EQ(skel->bss->g_sock_state, CLOSED, \"g_sock_state\");\n\n\tuninstall_filters(&egress_link, &ingress_link);\n\n\t \n\terr = install_filters(cgroup_fd, &egress_link, &ingress_link,\n\t\t\t      skel->progs.server_egress_srv,\n\t\t\t      skel->progs.server_ingress_srv,\n\t\t\t      skel);\n\n\terr = talk_to_cgroup(&client_fd, &listen_fd, &service_fd, skel);\n\tif (!ASSERT_OK(err, \"talk_to_cgroup\"))\n\t\tgoto cleanup;\n\n\terr = close_connection(&service_fd, &client_fd, &listen_fd, skel);\n\tif (!ASSERT_OK(err, \"close_connection\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(skel->bss->g_unexpected, 0, \"g_unexpected\");\n\tASSERT_EQ(skel->bss->g_sock_state, TIME_WAIT, \"g_sock_state\");\n\n\tuninstall_filters(&egress_link, &ingress_link);\n\n\t \n\terr = install_filters(cgroup_fd, &egress_link, &ingress_link,\n\t\t\t      skel->progs.client_egress_srv,\n\t\t\t      skel->progs.client_ingress_srv,\n\t\t\t      skel);\n\n\terr = talk_to_outside(&client_fd, &listen_fd, &service_fd, skel);\n\tif (!ASSERT_OK(err, \"talk_to_outside\"))\n\t\tgoto cleanup;\n\n\terr = close_connection(&service_fd, &client_fd, &listen_fd, skel);\n\tif (!ASSERT_OK(err, \"close_connection\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(skel->bss->g_unexpected, 0, \"g_unexpected\");\n\tASSERT_EQ(skel->bss->g_sock_state, CLOSED, \"g_sock_state\");\n\n\tuninstall_filters(&egress_link, &ingress_link);\n\n\t \n\terr = install_filters(cgroup_fd, &egress_link, &ingress_link,\n\t\t\t      skel->progs.client_egress,\n\t\t\t      skel->progs.client_ingress,\n\t\t\t      skel);\n\n\terr = talk_to_outside(&client_fd, &listen_fd, &service_fd, skel);\n\tif (!ASSERT_OK(err, \"talk_to_outside\"))\n\t\tgoto cleanup;\n\n\terr = close_connection(&client_fd, &service_fd, &listen_fd, skel);\n\tif (!ASSERT_OK(err, \"close_connection\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(skel->bss->g_unexpected, 0, \"g_unexpected\");\n\tASSERT_EQ(skel->bss->g_sock_state, TIME_WAIT, \"g_sock_state\");\n\n\tuninstall_filters(&egress_link, &ingress_link);\n\ncleanup:\n\tclose(client_fd);\n\tclose(listen_fd);\n\tclose(service_fd);\n\tclose(cgroup_fd);\n\tbpf_link__destroy(egress_link);\n\tbpf_link__destroy(ingress_link);\n\tcleanup_cgroup_environment();\n\tcgroup_tcp_skb__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}