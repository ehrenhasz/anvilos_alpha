{
  "module_name": "deny_namespace.c",
  "hash_id": "c9253ef09395753a8213fb77a0c37a6a65fce68906f34fc308835ca5c3530bd9",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/deny_namespace.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <test_progs.h>\n#include \"test_deny_namespace.skel.h\"\n#include <sched.h>\n#include \"cap_helpers.h\"\n#include <stdio.h>\n\nstatic int wait_for_pid(pid_t pid)\n{\n\tint status, ret;\n\nagain:\n\tret = waitpid(pid, &status, 0);\n\tif (ret == -1) {\n\t\tif (errno == EINTR)\n\t\t\tgoto again;\n\n\t\treturn -1;\n\t}\n\n\tif (!WIFEXITED(status))\n\t\treturn -1;\n\n\treturn WEXITSTATUS(status);\n}\n\n \nstatic int create_user_ns(void)\n{\n\tpid_t pid;\n\n\tpid = fork();\n\tif (pid < 0)\n\t\treturn -1;\n\n\tif (pid == 0) {\n\t\tif (unshare(CLONE_NEWUSER))\n\t\t\t_exit(EXIT_FAILURE);\n\t\t_exit(EXIT_SUCCESS);\n\t}\n\n\treturn wait_for_pid(pid);\n}\n\nstatic void test_userns_create_bpf(void)\n{\n\t__u32 cap_mask = 1ULL << CAP_SYS_ADMIN;\n\t__u64 old_caps = 0;\n\n\tcap_enable_effective(cap_mask, &old_caps);\n\n\tASSERT_OK(create_user_ns(), \"priv new user ns\");\n\n\tcap_disable_effective(cap_mask, &old_caps);\n\n\tASSERT_EQ(create_user_ns(), EPERM, \"unpriv new user ns\");\n\n\tif (cap_mask & old_caps)\n\t\tcap_enable_effective(cap_mask, NULL);\n}\n\nstatic void test_unpriv_userns_create_no_bpf(void)\n{\n\t__u32 cap_mask = 1ULL << CAP_SYS_ADMIN;\n\t__u64 old_caps = 0;\n\n\tcap_disable_effective(cap_mask, &old_caps);\n\n\tASSERT_OK(create_user_ns(), \"no-bpf unpriv new user ns\");\n\n\tif (cap_mask & old_caps)\n\t\tcap_enable_effective(cap_mask, NULL);\n}\n\nvoid test_deny_namespace(void)\n{\n\tstruct test_deny_namespace *skel = NULL;\n\tint err;\n\n\tif (test__start_subtest(\"unpriv_userns_create_no_bpf\"))\n\t\ttest_unpriv_userns_create_no_bpf();\n\n\tskel = test_deny_namespace__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel load\"))\n\t\tgoto close_prog;\n\n\terr = test_deny_namespace__attach(skel);\n\tif (!ASSERT_OK(err, \"attach\"))\n\t\tgoto close_prog;\n\n\tif (test__start_subtest(\"userns_create_bpf\"))\n\t\ttest_userns_create_bpf();\n\n\ttest_deny_namespace__detach(skel);\n\nclose_prog:\n\ttest_deny_namespace__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}