{
  "module_name": "cgrp_kfunc.c",
  "hash_id": "1a80ffd7e190665807d892e91d53ed8573b124006ad4c722c7ba13d6e130292d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgrp_kfunc.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <cgroup_helpers.h>\n#include <test_progs.h>\n\n#include \"cgrp_kfunc_failure.skel.h\"\n#include \"cgrp_kfunc_success.skel.h\"\n\nstatic struct cgrp_kfunc_success *open_load_cgrp_kfunc_skel(void)\n{\n\tstruct cgrp_kfunc_success *skel;\n\tint err;\n\n\tskel = cgrp_kfunc_success__open();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn NULL;\n\n\tskel->bss->pid = getpid();\n\n\terr = cgrp_kfunc_success__load(skel);\n\tif (!ASSERT_OK(err, \"skel_load\"))\n\t\tgoto cleanup;\n\n\treturn skel;\n\ncleanup:\n\tcgrp_kfunc_success__destroy(skel);\n\treturn NULL;\n}\n\nstatic int mkdir_rm_test_dir(void)\n{\n\tint fd;\n\tconst char *cgrp_path = \"cgrp_kfunc\";\n\n\tfd = create_and_get_cgroup(cgrp_path);\n\tif (!ASSERT_GT(fd, 0, \"mkdir_cgrp_fd\"))\n\t\treturn -1;\n\n\tclose(fd);\n\tremove_cgroup(cgrp_path);\n\n\treturn 0;\n}\n\nstatic void run_success_test(const char *prog_name)\n{\n\tstruct cgrp_kfunc_success *skel;\n\tstruct bpf_program *prog;\n\tstruct bpf_link *link = NULL;\n\n\tskel = open_load_cgrp_kfunc_skel();\n\tif (!ASSERT_OK_PTR(skel, \"open_load_skel\"))\n\t\treturn;\n\n\tif (!ASSERT_OK(skel->bss->err, \"pre_mkdir_err\"))\n\t\tgoto cleanup;\n\n\tprog = bpf_object__find_program_by_name(skel->obj, prog_name);\n\tif (!ASSERT_OK_PTR(prog, \"bpf_object__find_program_by_name\"))\n\t\tgoto cleanup;\n\n\tlink = bpf_program__attach(prog);\n\tif (!ASSERT_OK_PTR(link, \"attached_link\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(skel->bss->invocations, 0, \"pre_rmdir_count\");\n\tif (!ASSERT_OK(mkdir_rm_test_dir(), \"cgrp_mkdir\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(skel->bss->invocations, 1, \"post_rmdir_count\");\n\tASSERT_OK(skel->bss->err, \"post_rmdir_err\");\n\ncleanup:\n\tbpf_link__destroy(link);\n\tcgrp_kfunc_success__destroy(skel);\n}\n\nstatic const char * const success_tests[] = {\n\t\"test_cgrp_acquire_release_argument\",\n\t\"test_cgrp_acquire_leave_in_map\",\n\t\"test_cgrp_xchg_release\",\n\t\"test_cgrp_get_release\",\n\t\"test_cgrp_get_ancestors\",\n\t\"test_cgrp_from_id\",\n};\n\nvoid test_cgrp_kfunc(void)\n{\n\tint i, err;\n\n\terr = setup_cgroup_environment();\n\tif (!ASSERT_OK(err, \"cgrp_env_setup\"))\n\t\tgoto cleanup;\n\n\tfor (i = 0; i < ARRAY_SIZE(success_tests); i++) {\n\t\tif (!test__start_subtest(success_tests[i]))\n\t\t\tcontinue;\n\n\t\trun_success_test(success_tests[i]);\n\t}\n\n\tRUN_TESTS(cgrp_kfunc_failure);\n\ncleanup:\n\tcleanup_cgroup_environment();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}