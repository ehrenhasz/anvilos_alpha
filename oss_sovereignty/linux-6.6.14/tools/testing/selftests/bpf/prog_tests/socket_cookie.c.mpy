{
  "module_name": "socket_cookie.c",
  "hash_id": "fe805a621107ea60fb760e17e14585282567da99a018c8caca000715698466f3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/socket_cookie.c",
  "human_readable_source": "\n\n\n\n#include <test_progs.h>\n#include \"socket_cookie_prog.skel.h\"\n#include \"network_helpers.h\"\n\nstatic int duration;\n\nstruct socket_cookie {\n\t__u64 cookie_key;\n\t__u32 cookie_value;\n};\n\nvoid test_socket_cookie(void)\n{\n\tint server_fd = 0, client_fd = 0, cgroup_fd = 0, err = 0;\n\tsocklen_t addr_len = sizeof(struct sockaddr_in6);\n\tstruct socket_cookie_prog *skel;\n\t__u32 cookie_expected_value;\n\tstruct sockaddr_in6 addr;\n\tstruct socket_cookie val;\n\n\tskel = socket_cookie_prog__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\tcgroup_fd = test__join_cgroup(\"/socket_cookie\");\n\tif (CHECK(cgroup_fd < 0, \"join_cgroup\", \"cgroup creation failed\\n\"))\n\t\tgoto out;\n\n\tskel->links.set_cookie = bpf_program__attach_cgroup(\n\t\tskel->progs.set_cookie, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links.set_cookie, \"prog_attach\"))\n\t\tgoto close_cgroup_fd;\n\n\tskel->links.update_cookie_sockops = bpf_program__attach_cgroup(\n\t\tskel->progs.update_cookie_sockops, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links.update_cookie_sockops, \"prog_attach\"))\n\t\tgoto close_cgroup_fd;\n\n\tskel->links.update_cookie_tracing = bpf_program__attach(\n\t\tskel->progs.update_cookie_tracing);\n\tif (!ASSERT_OK_PTR(skel->links.update_cookie_tracing, \"prog_attach\"))\n\t\tgoto close_cgroup_fd;\n\n\tserver_fd = start_server(AF_INET6, SOCK_STREAM, \"::1\", 0, 0);\n\tif (CHECK(server_fd < 0, \"start_server\", \"errno %d\\n\", errno))\n\t\tgoto close_cgroup_fd;\n\n\tclient_fd = connect_to_fd(server_fd, 0);\n\tif (CHECK(client_fd < 0, \"connect_to_fd\", \"errno %d\\n\", errno))\n\t\tgoto close_server_fd;\n\n\terr = bpf_map_lookup_elem(bpf_map__fd(skel->maps.socket_cookies),\n\t\t\t\t  &client_fd, &val);\n\tif (!ASSERT_OK(err, \"map_lookup(socket_cookies)\"))\n\t\tgoto close_client_fd;\n\n\terr = getsockname(client_fd, (struct sockaddr *)&addr, &addr_len);\n\tif (!ASSERT_OK(err, \"getsockname\"))\n\t\tgoto close_client_fd;\n\n\tcookie_expected_value = (ntohs(addr.sin6_port) << 8) | 0xFF;\n\tASSERT_EQ(val.cookie_value, cookie_expected_value, \"cookie_value\");\n\nclose_client_fd:\n\tclose(client_fd);\nclose_server_fd:\n\tclose(server_fd);\nclose_cgroup_fd:\n\tclose(cgroup_fd);\nout:\n\tsocket_cookie_prog__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}