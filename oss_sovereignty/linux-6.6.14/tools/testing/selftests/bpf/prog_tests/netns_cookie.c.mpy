{
  "module_name": "netns_cookie.c",
  "hash_id": "1b6a89d5798fa2766a9a960efb63cb7e085ddbe0bb806d8da049b7cc6d451f3e",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/netns_cookie.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n#include \"netns_cookie_prog.skel.h\"\n#include \"network_helpers.h\"\n\n#ifndef SO_NETNS_COOKIE\n#define SO_NETNS_COOKIE 71\n#endif\n\nstatic int duration;\n\nvoid test_netns_cookie(void)\n{\n\tint server_fd = -1, client_fd = -1, cgroup_fd = -1;\n\tint err, val, ret, map, verdict;\n\tstruct netns_cookie_prog *skel;\n\tuint64_t cookie_expected_value;\n\tsocklen_t vallen = sizeof(cookie_expected_value);\n\tstatic const char send_msg[] = \"message\";\n\n\tskel = netns_cookie_prog__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\tcgroup_fd = test__join_cgroup(\"/netns_cookie\");\n\tif (CHECK(cgroup_fd < 0, \"join_cgroup\", \"cgroup creation failed\\n\"))\n\t\tgoto done;\n\n\tskel->links.get_netns_cookie_sockops = bpf_program__attach_cgroup(\n\t\tskel->progs.get_netns_cookie_sockops, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links.get_netns_cookie_sockops, \"prog_attach\"))\n\t\tgoto done;\n\n\tverdict = bpf_program__fd(skel->progs.get_netns_cookie_sk_msg);\n\tmap = bpf_map__fd(skel->maps.sock_map);\n\terr = bpf_prog_attach(verdict, map, BPF_SK_MSG_VERDICT, 0);\n\tif (!ASSERT_OK(err, \"prog_attach\"))\n\t\tgoto done;\n\n\tserver_fd = start_server(AF_INET6, SOCK_STREAM, \"::1\", 0, 0);\n\tif (CHECK(server_fd < 0, \"start_server\", \"errno %d\\n\", errno))\n\t\tgoto done;\n\n\tclient_fd = connect_to_fd(server_fd, 0);\n\tif (CHECK(client_fd < 0, \"connect_to_fd\", \"errno %d\\n\", errno))\n\t\tgoto done;\n\n\tret = send(client_fd, send_msg, sizeof(send_msg), 0);\n\tif (CHECK(ret != sizeof(send_msg), \"send(msg)\", \"ret:%d\\n\", ret))\n\t\tgoto done;\n\n\terr = bpf_map_lookup_elem(bpf_map__fd(skel->maps.sockops_netns_cookies),\n\t\t\t\t  &client_fd, &val);\n\tif (!ASSERT_OK(err, \"map_lookup(sockops_netns_cookies)\"))\n\t\tgoto done;\n\n\terr = getsockopt(client_fd, SOL_SOCKET, SO_NETNS_COOKIE,\n\t\t\t &cookie_expected_value, &vallen);\n\tif (!ASSERT_OK(err, \"getsockopt\"))\n\t\tgoto done;\n\n\tASSERT_EQ(val, cookie_expected_value, \"cookie_value\");\n\n\terr = bpf_map_lookup_elem(bpf_map__fd(skel->maps.sk_msg_netns_cookies),\n\t\t\t\t  &client_fd, &val);\n\tif (!ASSERT_OK(err, \"map_lookup(sk_msg_netns_cookies)\"))\n\t\tgoto done;\n\n\tASSERT_EQ(val, cookie_expected_value, \"cookie_value\");\n\ndone:\n\tif (server_fd != -1)\n\t\tclose(server_fd);\n\tif (client_fd != -1)\n\t\tclose(client_fd);\n\tif (cgroup_fd != -1)\n\t\tclose(cgroup_fd);\n\tnetns_cookie_prog__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}