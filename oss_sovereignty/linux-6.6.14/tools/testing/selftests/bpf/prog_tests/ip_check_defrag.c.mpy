{
  "module_name": "ip_check_defrag.c",
  "hash_id": "b6a3893efe370bfaf32276718280d3db0fb257bd71d3176de39c5e38ac63477b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/ip_check_defrag.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include <net/if.h>\n#include <linux/netfilter.h>\n#include <network_helpers.h>\n#include \"ip_check_defrag.skel.h\"\n#include \"ip_check_defrag_frags.h\"\n\n \n\n#define NS0\t\t\"defrag_ns0\"\n#define NS1\t\t\"defrag_ns1\"\n#define VETH0\t\t\"veth0\"\n#define VETH1\t\t\"veth1\"\n#define VETH0_ADDR\t\"172.16.1.100\"\n#define VETH0_ADDR6\t\"fc00::100\"\n \n#define VETH1_ADDR\t\"172.16.1.200\"\n#define VETH1_ADDR6\t\"fc00::200\"\n#define CLIENT_PORT\t48878\n#define SERVER_PORT\t48879\n#define MAGIC_MESSAGE\t\"THIS IS THE ORIGINAL MESSAGE, PLEASE REASSEMBLE ME\"\n\nstatic int setup_topology(bool ipv6)\n{\n\tbool up;\n\tint i;\n\n\tSYS(fail, \"ip netns add \" NS0);\n\tSYS(fail, \"ip netns add \" NS1);\n\tSYS(fail, \"ip link add \" VETH0 \" netns \" NS0 \" type veth peer name \" VETH1 \" netns \" NS1);\n\tif (ipv6) {\n\t\tSYS(fail, \"ip -6 -net \" NS0 \" addr add \" VETH0_ADDR6 \"/64 dev \" VETH0 \" nodad\");\n\t\tSYS(fail, \"ip -6 -net \" NS1 \" addr add \" VETH1_ADDR6 \"/64 dev \" VETH1 \" nodad\");\n\t} else {\n\t\tSYS(fail, \"ip -net \" NS0 \" addr add \" VETH0_ADDR \"/24 dev \" VETH0);\n\t\tSYS(fail, \"ip -net \" NS1 \" addr add \" VETH1_ADDR \"/24 dev \" VETH1);\n\t}\n\tSYS(fail, \"ip -net \" NS0 \" link set dev \" VETH0 \" up\");\n\tSYS(fail, \"ip -net \" NS1 \" link set dev \" VETH1 \" up\");\n\n\t \n\tfor (i = 0; i < 5; ++i) {\n\t\tif (ipv6)\n\t\t\tup = !system(\"ip netns exec \" NS0 \" ping -6 -c 1 -W 1 \" VETH1_ADDR6 \" &>/dev/null\");\n\t\telse\n\t\t\tup = !system(\"ip netns exec \" NS0 \" ping -c 1 -W 1 \" VETH1_ADDR \" &>/dev/null\");\n\n\t\tif (up)\n\t\t\tbreak;\n\t}\n\n\treturn 0;\nfail:\n\treturn -1;\n}\n\nstatic void cleanup_topology(void)\n{\n\tSYS_NOFAIL(\"test -f /var/run/netns/\" NS0 \" && ip netns delete \" NS0);\n\tSYS_NOFAIL(\"test -f /var/run/netns/\" NS1 \" && ip netns delete \" NS1);\n}\n\nstatic int attach(struct ip_check_defrag *skel, bool ipv6)\n{\n\tLIBBPF_OPTS(bpf_netfilter_opts, opts,\n\t\t    .pf = ipv6 ? NFPROTO_IPV6 : NFPROTO_IPV4,\n\t\t    .priority = 42,\n\t\t    .flags = BPF_F_NETFILTER_IP_DEFRAG);\n\tstruct nstoken *nstoken;\n\tint err = -1;\n\n\tnstoken = open_netns(NS1);\n\n\tskel->links.defrag = bpf_program__attach_netfilter(skel->progs.defrag, &opts);\n\tif (!ASSERT_OK_PTR(skel->links.defrag, \"program attach\"))\n\t\tgoto out;\n\n\terr = 0;\nout:\n\tclose_netns(nstoken);\n\treturn err;\n}\n\nstatic int send_frags(int client)\n{\n\tstruct sockaddr_storage saddr;\n\tstruct sockaddr *saddr_p;\n\tsocklen_t saddr_len;\n\tint err;\n\n\tsaddr_p = (struct sockaddr *)&saddr;\n\terr = make_sockaddr(AF_INET, VETH1_ADDR, SERVER_PORT, &saddr, &saddr_len);\n\tif (!ASSERT_OK(err, \"make_sockaddr\"))\n\t\treturn -1;\n\n\terr = sendto(client, frag_0, sizeof(frag_0), 0, saddr_p, saddr_len);\n\tif (!ASSERT_GE(err, 0, \"sendto frag_0\"))\n\t\treturn -1;\n\n\terr = sendto(client, frag_1, sizeof(frag_1), 0, saddr_p, saddr_len);\n\tif (!ASSERT_GE(err, 0, \"sendto frag_1\"))\n\t\treturn -1;\n\n\terr = sendto(client, frag_2, sizeof(frag_2), 0, saddr_p, saddr_len);\n\tif (!ASSERT_GE(err, 0, \"sendto frag_2\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic int send_frags6(int client)\n{\n\tstruct sockaddr_storage saddr;\n\tstruct sockaddr *saddr_p;\n\tsocklen_t saddr_len;\n\tint err;\n\n\tsaddr_p = (struct sockaddr *)&saddr;\n\t \n\terr = make_sockaddr(AF_INET6, VETH1_ADDR6, 0, &saddr, &saddr_len);\n\tif (!ASSERT_OK(err, \"make_sockaddr\"))\n\t\treturn -1;\n\n\terr = sendto(client, frag6_0, sizeof(frag6_0), 0, saddr_p, saddr_len);\n\tif (!ASSERT_GE(err, 0, \"sendto frag6_0\"))\n\t\treturn -1;\n\n\terr = sendto(client, frag6_1, sizeof(frag6_1), 0, saddr_p, saddr_len);\n\tif (!ASSERT_GE(err, 0, \"sendto frag6_1\"))\n\t\treturn -1;\n\n\terr = sendto(client, frag6_2, sizeof(frag6_2), 0, saddr_p, saddr_len);\n\tif (!ASSERT_GE(err, 0, \"sendto frag6_2\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nvoid test_bpf_ip_check_defrag_ok(bool ipv6)\n{\n\tstruct network_helper_opts rx_opts = {\n\t\t.timeout_ms = 1000,\n\t\t.noconnect = true,\n\t};\n\tstruct network_helper_opts tx_ops = {\n\t\t.timeout_ms = 1000,\n\t\t.type = SOCK_RAW,\n\t\t.proto = IPPROTO_RAW,\n\t\t.noconnect = true,\n\t};\n\tstruct sockaddr_storage caddr;\n\tstruct ip_check_defrag *skel;\n\tstruct nstoken *nstoken;\n\tint client_tx_fd = -1;\n\tint client_rx_fd = -1;\n\tsocklen_t caddr_len;\n\tint srv_fd = -1;\n\tchar buf[1024];\n\tint len, err;\n\n\tskel = ip_check_defrag__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\tif (!ASSERT_OK(setup_topology(ipv6), \"setup_topology\"))\n\t\tgoto out;\n\n\tif (!ASSERT_OK(attach(skel, ipv6), \"attach\"))\n\t\tgoto out;\n\n\t \n\tnstoken = open_netns(NS1);\n\tif (!ASSERT_OK_PTR(nstoken, \"setns ns1\"))\n\t\tgoto out;\n\tsrv_fd = start_server(ipv6 ? AF_INET6 : AF_INET, SOCK_DGRAM, NULL, SERVER_PORT, 0);\n\tclose_netns(nstoken);\n\tif (!ASSERT_GE(srv_fd, 0, \"start_server\"))\n\t\tgoto out;\n\n\t \n\tnstoken = open_netns(NS0);\n\tif (!ASSERT_OK_PTR(nstoken, \"setns ns0\"))\n\t\tgoto out;\n\tclient_tx_fd = connect_to_fd_opts(srv_fd, &tx_ops);\n\tclose_netns(nstoken);\n\tif (!ASSERT_GE(client_tx_fd, 0, \"connect_to_fd_opts\"))\n\t\tgoto out;\n\n\t \n\tnstoken = open_netns(NS0);\n\tif (!ASSERT_OK_PTR(nstoken, \"setns ns0\"))\n\t\tgoto out;\n\tclient_rx_fd = connect_to_fd_opts(srv_fd, &rx_opts);\n\tclose_netns(nstoken);\n\tif (!ASSERT_GE(client_rx_fd, 0, \"connect_to_fd_opts\"))\n\t\tgoto out;\n\n\t \n\tmemset(&caddr, 0, sizeof(caddr));\n\tnstoken = open_netns(NS0);\n\tif (!ASSERT_OK_PTR(nstoken, \"setns ns0\"))\n\t\tgoto out;\n\tif (ipv6) {\n\t\tstruct sockaddr_in6 *c = (struct sockaddr_in6 *)&caddr;\n\n\t\tc->sin6_family = AF_INET6;\n\t\tinet_pton(AF_INET6, VETH0_ADDR6, &c->sin6_addr);\n\t\tc->sin6_port = htons(CLIENT_PORT);\n\t\terr = bind(client_rx_fd, (struct sockaddr *)c, sizeof(*c));\n\t} else {\n\t\tstruct sockaddr_in *c = (struct sockaddr_in *)&caddr;\n\n\t\tc->sin_family = AF_INET;\n\t\tinet_pton(AF_INET, VETH0_ADDR, &c->sin_addr);\n\t\tc->sin_port = htons(CLIENT_PORT);\n\t\terr = bind(client_rx_fd, (struct sockaddr *)c, sizeof(*c));\n\t}\n\tclose_netns(nstoken);\n\tif (!ASSERT_OK(err, \"bind\"))\n\t\tgoto out;\n\n\t \n\tif (ipv6) {\n\t\tif (!ASSERT_OK(send_frags6(client_tx_fd), \"send_frags6\"))\n\t\t\tgoto out;\n\t} else {\n\t\tif (!ASSERT_OK(send_frags(client_tx_fd), \"send_frags\"))\n\t\t\tgoto out;\n\t}\n\n\tif (!ASSERT_EQ(skel->bss->shootdowns, 0, \"shootdowns\"))\n\t\tgoto out;\n\n\t \n\tcaddr_len = sizeof(caddr);\n\tlen = recvfrom(srv_fd, buf, sizeof(buf), 0, (struct sockaddr *)&caddr, &caddr_len);\n\tif (!ASSERT_GE(len, 0, \"server recvfrom\"))\n\t\tgoto out;\n\tlen = sendto(srv_fd, buf, len, 0, (struct sockaddr *)&caddr, caddr_len);\n\tif (!ASSERT_GE(len, 0, \"server sendto\"))\n\t\tgoto out;\n\n\t \n\tlen = recvfrom(client_rx_fd, buf, sizeof(buf), 0, NULL, NULL);\n\tif (!ASSERT_EQ(len, sizeof(MAGIC_MESSAGE) - 1, \"client short read\"))\n\t\tgoto out;\n\nout:\n\tif (client_rx_fd != -1)\n\t\tclose(client_rx_fd);\n\tif (client_tx_fd != -1)\n\t\tclose(client_tx_fd);\n\tif (srv_fd != -1)\n\t\tclose(srv_fd);\n\tcleanup_topology();\n\tip_check_defrag__destroy(skel);\n}\n\nvoid test_bpf_ip_check_defrag(void)\n{\n\tif (test__start_subtest(\"v4\"))\n\t\ttest_bpf_ip_check_defrag_ok(false);\n\tif (test__start_subtest(\"v6\"))\n\t\ttest_bpf_ip_check_defrag_ok(true);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}