{
  "module_name": "raw_tp_writable_test_run.c",
  "hash_id": "9299285163c9b58fe8bb157d1811a1ebcf31be31002d010e7601ab097ab80a26",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/raw_tp_writable_test_run.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n#include <linux/nbd.h>\n\n \nvoid serial_test_raw_tp_writable_test_run(void)\n{\n\t__u32 duration = 0;\n\tchar error[4096];\n\n\tconst struct bpf_insn trace_program[] = {\n\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1, 0),\n\t\tBPF_LDX_MEM(BPF_W, BPF_REG_0, BPF_REG_6, 0),\n\t\tBPF_MOV64_IMM(BPF_REG_0, 42),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_0, 0),\n\t\tBPF_EXIT_INSN(),\n\t};\n\n\tLIBBPF_OPTS(bpf_prog_load_opts, trace_opts,\n\t\t.log_level = 2,\n\t\t.log_buf = error,\n\t\t.log_size = sizeof(error),\n\t);\n\n\tint bpf_fd = bpf_prog_load(BPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE, NULL, \"GPL v2\",\n\t\t\t\t   trace_program, sizeof(trace_program) / sizeof(struct bpf_insn),\n\t\t\t\t   &trace_opts);\n\tif (CHECK(bpf_fd < 0, \"bpf_raw_tracepoint_writable loaded\",\n\t\t  \"failed: %d errno %d\\n\", bpf_fd, errno))\n\t\treturn;\n\n\tconst struct bpf_insn skb_program[] = {\n\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\tBPF_EXIT_INSN(),\n\t};\n\n\tLIBBPF_OPTS(bpf_prog_load_opts, skb_opts,\n\t\t.log_buf = error,\n\t\t.log_size = sizeof(error),\n\t);\n\n\tint filter_fd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER, NULL, \"GPL v2\",\n\t\t\t\t      skb_program, sizeof(skb_program) / sizeof(struct bpf_insn),\n\t\t\t\t      &skb_opts);\n\tif (CHECK(filter_fd < 0, \"test_program_loaded\", \"failed: %d errno %d\\n\",\n\t\t  filter_fd, errno))\n\t\tgoto out_bpffd;\n\n\tint tp_fd = bpf_raw_tracepoint_open(\"bpf_test_finish\", bpf_fd);\n\tif (CHECK(tp_fd < 0, \"bpf_raw_tracepoint_writable opened\",\n\t\t  \"failed: %d errno %d\\n\", tp_fd, errno))\n\t\tgoto out_filterfd;\n\n\tchar test_skb[128] = {\n\t\t0,\n\t};\n\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t.data_in = test_skb,\n\t\t.data_size_in = sizeof(test_skb),\n\t\t.repeat = 1,\n\t);\n\tint err = bpf_prog_test_run_opts(filter_fd, &topts);\n\tCHECK(err != 42, \"test_run\",\n\t      \"tracepoint did not modify return value\\n\");\n\tCHECK(topts.retval != 0, \"test_run_ret\",\n\t      \"socket_filter did not return 0\\n\");\n\n\tclose(tp_fd);\n\n\terr = bpf_prog_test_run_opts(filter_fd, &topts);\n\tCHECK(err != 0, \"test_run_notrace\",\n\t      \"test_run failed with %d errno %d\\n\", err, errno);\n\tCHECK(topts.retval != 0, \"test_run_ret_notrace\",\n\t      \"socket_filter did not return 0\\n\");\n\nout_filterfd:\n\tclose(filter_fd);\nout_bpffd:\n\tclose(bpf_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}