{
  "module_name": "prog_run_opts.c",
  "hash_id": "9f08a6d456ad3d7a1e1890d0fb44ccbd554e2aec0f38d45e55f3af5d220f9a09",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/prog_run_opts.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include <network_helpers.h>\n\n#include \"test_pkt_access.skel.h\"\n\nstatic const __u32 duration;\n\nstatic void check_run_cnt(int prog_fd, __u64 run_cnt)\n{\n\tstruct bpf_prog_info info = {};\n\t__u32 info_len = sizeof(info);\n\tint err;\n\n\terr = bpf_prog_get_info_by_fd(prog_fd, &info, &info_len);\n\tif (CHECK(err, \"get_prog_info\", \"failed to get bpf_prog_info for fd %d\\n\", prog_fd))\n\t\treturn;\n\n\tCHECK(run_cnt != info.run_cnt, \"run_cnt\",\n\t      \"incorrect number of repetitions, want %llu have %llu\\n\", run_cnt, info.run_cnt);\n}\n\nvoid test_prog_run_opts(void)\n{\n\tstruct test_pkt_access *skel;\n\tint err, stats_fd = -1, prog_fd;\n\tchar buf[10] = {};\n\t__u64 run_cnt = 0;\n\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t.repeat = 1,\n\t\t.data_in = &pkt_v4,\n\t\t.data_size_in = sizeof(pkt_v4),\n\t\t.data_out = buf,\n\t\t.data_size_out = 5,\n\t);\n\n\tstats_fd = bpf_enable_stats(BPF_STATS_RUN_TIME);\n\tif (!ASSERT_GE(stats_fd, 0, \"enable_stats good fd\"))\n\t\treturn;\n\n\tskel = test_pkt_access__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"open_and_load\"))\n\t\tgoto cleanup;\n\n\tprog_fd = bpf_program__fd(skel->progs.test_pkt_access);\n\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_EQ(errno, ENOSPC, \"test_run errno\");\n\tASSERT_ERR(err, \"test_run\");\n\tASSERT_OK(topts.retval, \"test_run retval\");\n\n\tASSERT_EQ(topts.data_size_out, sizeof(pkt_v4), \"test_run data_size_out\");\n\tASSERT_EQ(buf[5], 0, \"overflow, BPF_PROG_TEST_RUN ignored size hint\");\n\n\trun_cnt += topts.repeat;\n\tcheck_run_cnt(prog_fd, run_cnt);\n\n\ttopts.data_out = NULL;\n\ttopts.data_size_out = 0;\n\ttopts.repeat = 2;\n\terrno = 0;\n\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(errno, \"run_no_output errno\");\n\tASSERT_OK(err, \"run_no_output err\");\n\tASSERT_OK(topts.retval, \"run_no_output retval\");\n\n\trun_cnt += topts.repeat;\n\tcheck_run_cnt(prog_fd, run_cnt);\n\ncleanup:\n\tif (skel)\n\t\ttest_pkt_access__destroy(skel);\n\tif (stats_fd >= 0)\n\t\tclose(stats_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}