{
  "module_name": "subprogs.c",
  "hash_id": "a52e00f6418f99a9625c1ea3ca15d7025efbb6ed472e7531ca0143d04a336044",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/subprogs.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include \"test_subprogs.skel.h\"\n#include \"test_subprogs_unused.skel.h\"\n\nstruct toggler_ctx {\n\tint fd;\n\tbool stop;\n};\n\nstatic void *toggle_jit_harden(void *arg)\n{\n\tstruct toggler_ctx *ctx = arg;\n\tchar two = '2';\n\tchar zero = '0';\n\n\twhile (!ctx->stop) {\n\t\tlseek(ctx->fd, SEEK_SET, 0);\n\t\twrite(ctx->fd, &two, sizeof(two));\n\t\tlseek(ctx->fd, SEEK_SET, 0);\n\t\twrite(ctx->fd, &zero, sizeof(zero));\n\t}\n\n\treturn NULL;\n}\n\nstatic void test_subprogs_with_jit_harden_toggling(void)\n{\n\tstruct toggler_ctx ctx;\n\tpthread_t toggler;\n\tint err;\n\tunsigned int i, loop = 10;\n\n\tctx.fd = open(\"/proc/sys/net/core/bpf_jit_harden\", O_RDWR);\n\tif (!ASSERT_GE(ctx.fd, 0, \"open bpf_jit_harden\"))\n\t\treturn;\n\n\tctx.stop = false;\n\terr = pthread_create(&toggler, NULL, toggle_jit_harden, &ctx);\n\tif (!ASSERT_OK(err, \"new toggler\"))\n\t\tgoto out;\n\n\t \n\tusleep(1);\n\n\tfor (i = 0; i < loop; i++) {\n\t\tstruct test_subprogs *skel = test_subprogs__open_and_load();\n\n\t\tif (!ASSERT_OK_PTR(skel, \"skel open\"))\n\t\t\tbreak;\n\t\ttest_subprogs__destroy(skel);\n\t}\n\n\tctx.stop = true;\n\tpthread_join(toggler, NULL);\nout:\n\tclose(ctx.fd);\n}\n\nstatic void test_subprogs_alone(void)\n{\n\tstruct test_subprogs *skel;\n\tstruct test_subprogs_unused *skel2;\n\tint err;\n\n\tskel = test_subprogs__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\terr = test_subprogs__attach(skel);\n\tif (!ASSERT_OK(err, \"skel attach\"))\n\t\tgoto cleanup;\n\n\tusleep(1);\n\n\tASSERT_EQ(skel->bss->res1, 12, \"res1\");\n\tASSERT_EQ(skel->bss->res2, 17, \"res2\");\n\tASSERT_EQ(skel->bss->res3, 19, \"res3\");\n\tASSERT_EQ(skel->bss->res4, 36, \"res4\");\n\n\tskel2 = test_subprogs_unused__open_and_load();\n\tASSERT_OK_PTR(skel2, \"unused_progs_skel\");\n\ttest_subprogs_unused__destroy(skel2);\n\ncleanup:\n\ttest_subprogs__destroy(skel);\n}\n\nvoid test_subprogs(void)\n{\n\tif (test__start_subtest(\"subprogs_alone\"))\n\t\ttest_subprogs_alone();\n\tif (test__start_subtest(\"subprogs_and_jit_harden\"))\n\t\ttest_subprogs_with_jit_harden_toggling();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}