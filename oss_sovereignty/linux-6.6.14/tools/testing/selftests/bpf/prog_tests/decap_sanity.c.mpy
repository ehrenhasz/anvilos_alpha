{
  "module_name": "decap_sanity.c",
  "hash_id": "f06c6fa6231bdfdc636781cd57191315ed745409b36d6918c92c21b3a6d4fcd7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/decap_sanity.c",
  "human_readable_source": "\n \n\n#include <sys/types.h>\n#include <sys/socket.h>\n#include <net/if.h>\n#include <linux/in6.h>\n\n#include \"test_progs.h\"\n#include \"network_helpers.h\"\n#include \"decap_sanity.skel.h\"\n\n#define NS_TEST \"decap_sanity_ns\"\n#define IPV6_IFACE_ADDR \"face::1\"\n#define UDP_TEST_PORT 7777\n\nvoid test_decap_sanity(void)\n{\n\tLIBBPF_OPTS(bpf_tc_hook, qdisc_hook, .attach_point = BPF_TC_EGRESS);\n\tLIBBPF_OPTS(bpf_tc_opts, tc_attach);\n\tstruct nstoken *nstoken = NULL;\n\tstruct decap_sanity *skel;\n\tstruct sockaddr_in6 addr;\n\tsocklen_t addrlen;\n\tchar buf[128] = {};\n\tint sockfd, err;\n\n\tskel = decap_sanity__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel open_and_load\"))\n\t\treturn;\n\n\tSYS(fail, \"ip netns add %s\", NS_TEST);\n\tSYS(fail, \"ip -net %s -6 addr add %s/128 dev lo nodad\", NS_TEST, IPV6_IFACE_ADDR);\n\tSYS(fail, \"ip -net %s link set dev lo up\", NS_TEST);\n\n\tnstoken = open_netns(NS_TEST);\n\tif (!ASSERT_OK_PTR(nstoken, \"open_netns\"))\n\t\tgoto fail;\n\n\tqdisc_hook.ifindex = if_nametoindex(\"lo\");\n\tif (!ASSERT_GT(qdisc_hook.ifindex, 0, \"if_nametoindex lo\"))\n\t\tgoto fail;\n\n\terr = bpf_tc_hook_create(&qdisc_hook);\n\tif (!ASSERT_OK(err, \"create qdisc hook\"))\n\t\tgoto fail;\n\n\ttc_attach.prog_fd = bpf_program__fd(skel->progs.decap_sanity);\n\terr = bpf_tc_attach(&qdisc_hook, &tc_attach);\n\tif (!ASSERT_OK(err, \"attach filter\"))\n\t\tgoto fail;\n\n\taddrlen = sizeof(addr);\n\terr = make_sockaddr(AF_INET6, IPV6_IFACE_ADDR, UDP_TEST_PORT,\n\t\t\t    (void *)&addr, &addrlen);\n\tif (!ASSERT_OK(err, \"make_sockaddr\"))\n\t\tgoto fail;\n\tsockfd = socket(AF_INET6, SOCK_DGRAM, 0);\n\tif (!ASSERT_NEQ(sockfd, -1, \"socket\"))\n\t\tgoto fail;\n\terr = sendto(sockfd, buf, sizeof(buf), 0, (void *)&addr, addrlen);\n\tclose(sockfd);\n\tif (!ASSERT_EQ(err, sizeof(buf), \"send\"))\n\t\tgoto fail;\n\n\tASSERT_TRUE(skel->bss->init_csum_partial, \"init_csum_partial\");\n\tASSERT_TRUE(skel->bss->final_csum_none, \"final_csum_none\");\n\tASSERT_FALSE(skel->bss->broken_csum_start, \"broken_csum_start\");\n\nfail:\n\tif (nstoken) {\n\t\tbpf_tc_hook_destroy(&qdisc_hook);\n\t\tclose_netns(nstoken);\n\t}\n\tSYS_NOFAIL(\"ip netns del \" NS_TEST \" &> /dev/null\");\n\tdecap_sanity__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}