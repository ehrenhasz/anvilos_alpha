{
  "module_name": "connect_ping.c",
  "hash_id": "da3fce0eace26d236c9f082a93af9516c833c3a1b8b3534c19df312f074cd1c2",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/connect_ping.c",
  "human_readable_source": "\n\n \n\n#define _GNU_SOURCE\n#include <sys/mount.h>\n\n#include \"test_progs.h\"\n#include \"cgroup_helpers.h\"\n#include \"network_helpers.h\"\n\n#include \"connect_ping.skel.h\"\n\n \n#define BINDADDR_V6 { { { 0x20,0x01,0x0d,0xb8,0,0,0,0,0,0,0,0,0,0,0,1 } } }\nstatic const struct in6_addr bindaddr_v6 = BINDADDR_V6;\n\nstatic void subtest(int cgroup_fd, struct connect_ping *skel,\n\t\t    int family, int do_bind)\n{\n\tstruct sockaddr_in sa4 = {\n\t\t.sin_family = AF_INET,\n\t\t.sin_addr.s_addr = htonl(INADDR_LOOPBACK),\n\t};\n\tstruct sockaddr_in6 sa6 = {\n\t\t.sin6_family = AF_INET6,\n\t\t.sin6_addr = IN6ADDR_LOOPBACK_INIT,\n\t};\n\tstruct sockaddr *sa;\n\tsocklen_t sa_len;\n\tint protocol;\n\tint sock_fd;\n\n\tswitch (family) {\n\tcase AF_INET:\n\t\tsa = (struct sockaddr *)&sa4;\n\t\tsa_len = sizeof(sa4);\n\t\tprotocol = IPPROTO_ICMP;\n\t\tbreak;\n\tcase AF_INET6:\n\t\tsa = (struct sockaddr *)&sa6;\n\t\tsa_len = sizeof(sa6);\n\t\tprotocol = IPPROTO_ICMPV6;\n\t\tbreak;\n\t}\n\n\tmemset(skel->bss, 0, sizeof(*skel->bss));\n\tskel->bss->do_bind = do_bind;\n\n\tsock_fd = socket(family, SOCK_DGRAM, protocol);\n\tif (!ASSERT_GE(sock_fd, 0, \"sock-create\"))\n\t\treturn;\n\n\tif (!ASSERT_OK(connect(sock_fd, sa, sa_len), \"connect\"))\n\t\tgoto close_sock;\n\n\tif (!ASSERT_EQ(skel->bss->invocations_v4, family == AF_INET ? 1 : 0,\n\t\t       \"invocations_v4\"))\n\t\tgoto close_sock;\n\tif (!ASSERT_EQ(skel->bss->invocations_v6, family == AF_INET6 ? 1 : 0,\n\t\t       \"invocations_v6\"))\n\t\tgoto close_sock;\n\tif (!ASSERT_EQ(skel->bss->has_error, 0, \"has_error\"))\n\t\tgoto close_sock;\n\n\tif (!ASSERT_OK(getsockname(sock_fd, sa, &sa_len),\n\t\t       \"getsockname\"))\n\t\tgoto close_sock;\n\n\tswitch (family) {\n\tcase AF_INET:\n\t\tif (!ASSERT_EQ(sa4.sin_family, family, \"sin_family\"))\n\t\t\tgoto close_sock;\n\t\tif (!ASSERT_EQ(sa4.sin_addr.s_addr,\n\t\t\t       htonl(do_bind ? 0x01010101 : INADDR_LOOPBACK),\n\t\t\t       \"sin_addr\"))\n\t\t\tgoto close_sock;\n\t\tbreak;\n\tcase AF_INET6:\n\t\tif (!ASSERT_EQ(sa6.sin6_family, AF_INET6, \"sin6_family\"))\n\t\t\tgoto close_sock;\n\t\tif (!ASSERT_EQ(memcmp(&sa6.sin6_addr,\n\t\t\t\t      do_bind ? &bindaddr_v6 : &in6addr_loopback,\n\t\t\t\t      sizeof(sa6.sin6_addr)),\n\t\t\t       0, \"sin6_addr\"))\n\t\t\tgoto close_sock;\n\t\tbreak;\n\t}\n\nclose_sock:\n\tclose(sock_fd);\n}\n\nvoid test_connect_ping(void)\n{\n\tstruct connect_ping *skel;\n\tint cgroup_fd;\n\n\tif (!ASSERT_OK(unshare(CLONE_NEWNET | CLONE_NEWNS), \"unshare\"))\n\t\treturn;\n\n\t \n\tif (!ASSERT_OK(mount(\"none\", \"/sys\", NULL, MS_PRIVATE, NULL),\n\t\t       \"remount-private-sys\"))\n\t\treturn;\n\tif (!ASSERT_OK(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL),\n\t\t       \"mount-sys\"))\n\t\treturn;\n\tif (!ASSERT_OK(mount(\"bpffs\", \"/sys/fs/bpf\", \"bpf\", 0, NULL),\n\t\t       \"mount-bpf\"))\n\t\tgoto clean_mount;\n\n\tif (!ASSERT_OK(system(\"ip link set dev lo up\"), \"lo-up\"))\n\t\tgoto clean_mount;\n\tif (!ASSERT_OK(system(\"ip addr add 1.1.1.1 dev lo\"), \"lo-addr-v4\"))\n\t\tgoto clean_mount;\n\tif (!ASSERT_OK(system(\"ip -6 addr add 2001:db8::1 dev lo\"), \"lo-addr-v6\"))\n\t\tgoto clean_mount;\n\tif (write_sysctl(\"/proc/sys/net/ipv4/ping_group_range\", \"0 0\"))\n\t\tgoto clean_mount;\n\n\tcgroup_fd = test__join_cgroup(\"/connect_ping\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"cg-create\"))\n\t\tgoto clean_mount;\n\n\tskel = connect_ping__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel-load\"))\n\t\tgoto close_cgroup;\n\tskel->links.connect_v4_prog =\n\t\tbpf_program__attach_cgroup(skel->progs.connect_v4_prog, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links.connect_v4_prog, \"cg-attach-v4\"))\n\t\tgoto skel_destroy;\n\tskel->links.connect_v6_prog =\n\t\tbpf_program__attach_cgroup(skel->progs.connect_v6_prog, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links.connect_v6_prog, \"cg-attach-v6\"))\n\t\tgoto skel_destroy;\n\n\t \n\tif (test__start_subtest(\"ipv4\"))\n\t\tsubtest(cgroup_fd, skel, AF_INET, 0);\n\n\t \n\tif (test__start_subtest(\"ipv4-bind\"))\n\t\tsubtest(cgroup_fd, skel, AF_INET, 1);\n\n\t \n\tif (test__start_subtest(\"ipv6\"))\n\t\tsubtest(cgroup_fd, skel, AF_INET6, 0);\n\n\t \n\tif (test__start_subtest(\"ipv6-bind\"))\n\t\tsubtest(cgroup_fd, skel, AF_INET6, 1);\n\nskel_destroy:\n\tconnect_ping__destroy(skel);\n\nclose_cgroup:\n\tclose(cgroup_fd);\n\nclean_mount:\n\tumount2(\"/sys\", MNT_DETACH);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}