{
  "module_name": "test_bpffs.c",
  "hash_id": "481a7aa97472e279f78fd16dd47145924a96145565c31167a7d880dda3f67df3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/test_bpffs.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n#include <stdio.h>\n#include <sched.h>\n#include <sys/mount.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <test_progs.h>\n\n#define TDIR \"/sys/kernel/debug\"\n\nstatic int read_iter(char *file)\n{\n\t \n\tchar buf[1024];\n\tint fd, len;\n\n\tfd = open(file, 0);\n\tif (fd < 0)\n\t\treturn -1;\n\twhile ((len = read(fd, buf, sizeof(buf))) > 0) {\n\t\tbuf[sizeof(buf) - 1] = '\\0';\n\t\tif (strstr(buf, \"iter\")) {\n\t\t\tclose(fd);\n\t\t\treturn 0;\n\t\t}\n\t}\n\tclose(fd);\n\treturn -1;\n}\n\nstatic int fn(void)\n{\n\tstruct stat a, b, c;\n\tint err, map;\n\n\terr = unshare(CLONE_NEWNS);\n\tif (!ASSERT_OK(err, \"unshare\"))\n\t\tgoto out;\n\n\terr = mount(\"\", \"/\", \"\", MS_REC | MS_PRIVATE, NULL);\n\tif (!ASSERT_OK(err, \"mount /\"))\n\t\tgoto out;\n\n\terr = umount(TDIR);\n\tif (!ASSERT_OK(err, \"umount \" TDIR))\n\t\tgoto out;\n\n\terr = mount(\"none\", TDIR, \"tmpfs\", 0, NULL);\n\tif (!ASSERT_OK(err, \"mount tmpfs\"))\n\t\tgoto out;\n\n\terr = mkdir(TDIR \"/fs1\", 0777);\n\tif (!ASSERT_OK(err, \"mkdir \" TDIR \"/fs1\"))\n\t\tgoto out;\n\terr = mkdir(TDIR \"/fs2\", 0777);\n\tif (!ASSERT_OK(err, \"mkdir \" TDIR \"/fs2\"))\n\t\tgoto out;\n\n\terr = mount(\"bpf\", TDIR \"/fs1\", \"bpf\", 0, NULL);\n\tif (!ASSERT_OK(err, \"mount bpffs \" TDIR \"/fs1\"))\n\t\tgoto out;\n\terr = mount(\"bpf\", TDIR \"/fs2\", \"bpf\", 0, NULL);\n\tif (!ASSERT_OK(err, \"mount bpffs \" TDIR \"/fs2\"))\n\t\tgoto out;\n\n\terr = read_iter(TDIR \"/fs1/maps.debug\");\n\tif (!ASSERT_OK(err, \"reading \" TDIR \"/fs1/maps.debug\"))\n\t\tgoto out;\n\terr = read_iter(TDIR \"/fs2/progs.debug\");\n\tif (!ASSERT_OK(err, \"reading \" TDIR \"/fs2/progs.debug\"))\n\t\tgoto out;\n\n\terr = mkdir(TDIR \"/fs1/a\", 0777);\n\tif (!ASSERT_OK(err, \"creating \" TDIR \"/fs1/a\"))\n\t\tgoto out;\n\terr = mkdir(TDIR \"/fs1/a/1\", 0777);\n\tif (!ASSERT_OK(err, \"creating \" TDIR \"/fs1/a/1\"))\n\t\tgoto out;\n\terr = mkdir(TDIR \"/fs1/b\", 0777);\n\tif (!ASSERT_OK(err, \"creating \" TDIR \"/fs1/b\"))\n\t\tgoto out;\n\n\tmap = bpf_map_create(BPF_MAP_TYPE_ARRAY, NULL, 4, 4, 1, NULL);\n\tif (!ASSERT_GT(map, 0, \"create_map(ARRAY)\"))\n\t\tgoto out;\n\terr = bpf_obj_pin(map, TDIR \"/fs1/c\");\n\tif (!ASSERT_OK(err, \"pin map\"))\n\t\tgoto out;\n\tclose(map);\n\n\t \n\terr = stat(TDIR \"/fs1/a\", &a);\n\tif (!ASSERT_OK(err, \"stat(\" TDIR \"/fs1/a)\"))\n\t\tgoto out;\n\terr = renameat2(0, TDIR \"/fs1/a\", 0, TDIR \"/fs1/b\", RENAME_EXCHANGE);\n\tif (!ASSERT_OK(err, \"renameat2(/fs1/a, /fs1/b, RENAME_EXCHANGE)\"))\n\t\tgoto out;\n\terr = stat(TDIR \"/fs1/b\", &b);\n\tif (!ASSERT_OK(err, \"stat(\" TDIR \"/fs1/b)\"))\n\t\tgoto out;\n\tif (!ASSERT_EQ(a.st_ino, b.st_ino, \"b should have a's inode\"))\n\t\tgoto out;\n\terr = access(TDIR \"/fs1/b/1\", F_OK);\n\tif (!ASSERT_OK(err, \"access(\" TDIR \"/fs1/b/1)\"))\n\t\tgoto out;\n\n\t \n\terr = stat(TDIR \"/fs1/c\", &c);\n\tif (!ASSERT_OK(err, \"stat(\" TDIR \"/fs1/map)\"))\n\t\tgoto out;\n\terr = renameat2(0, TDIR \"/fs1/c\", 0, TDIR \"/fs1/b\", RENAME_EXCHANGE);\n\tif (!ASSERT_OK(err, \"renameat2(/fs1/c, /fs1/b, RENAME_EXCHANGE)\"))\n\t\tgoto out;\n\terr = stat(TDIR \"/fs1/b\", &b);\n\tif (!ASSERT_OK(err, \"stat(\" TDIR \"/fs1/b)\"))\n\t\tgoto out;\n\tif (!ASSERT_EQ(c.st_ino, b.st_ino, \"b should have c's inode\"))\n\t\tgoto out;\n\terr = access(TDIR \"/fs1/c/1\", F_OK);\n\tif (!ASSERT_OK(err, \"access(\" TDIR \"/fs1/c/1)\"))\n\t\tgoto out;\n\n\t \n\terr = renameat2(0, TDIR \"/fs1/b\", 0, TDIR \"/fs1/a\", RENAME_NOREPLACE);\n\tif (!ASSERT_ERR(err, \"renameat2(RENAME_NOREPLACE)\")) {\n\t\terr = -EINVAL;\n\t\tgoto out;\n\t}\n\terr = access(TDIR \"/fs1/b\", F_OK);\n\tif (!ASSERT_OK(err, \"access(\" TDIR \"/fs1/b)\"))\n\t\tgoto out;\n\nout:\n\tumount(TDIR \"/fs1\");\n\tumount(TDIR \"/fs2\");\n\trmdir(TDIR \"/fs1\");\n\trmdir(TDIR \"/fs2\");\n\tumount(TDIR);\n\texit(err);\n}\n\nvoid test_test_bpffs(void)\n{\n\tint err, duration = 0, status = 0;\n\tpid_t pid;\n\n\tpid = fork();\n\tif (CHECK(pid == -1, \"clone\", \"clone failed %d\", errno))\n\t\treturn;\n\tif (pid == 0)\n\t\tfn();\n\terr = waitpid(pid, &status, 0);\n\tif (CHECK(err == -1 && errno != ECHILD, \"waitpid\", \"failed %d\", errno))\n\t\treturn;\n\tif (CHECK(WEXITSTATUS(status), \"bpffs test \", \"failed %d\", WEXITSTATUS(status)))\n\t\treturn;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}