{
  "module_name": "netcnt.c",
  "hash_id": "ec827381e91d7c7eb74b27f3e72bc1e003d32e51af6fa601c5a99381085221c7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/netcnt.c",
  "human_readable_source": "\n\n#include <sys/sysinfo.h>\n#include <test_progs.h>\n#include \"network_helpers.h\"\n#include \"netcnt_prog.skel.h\"\n#include \"netcnt_common.h\"\n\n#define CG_NAME \"/netcnt\"\n\nvoid serial_test_netcnt(void)\n{\n\tunion percpu_net_cnt *percpu_netcnt = NULL;\n\tstruct bpf_cgroup_storage_key key;\n\tint map_fd, percpu_map_fd;\n\tstruct netcnt_prog *skel;\n\tunsigned long packets;\n\tunion net_cnt netcnt;\n\tunsigned long bytes;\n\tint cpu, nproc;\n\tint cg_fd = -1;\n\tchar cmd[128];\n\n\tskel = netcnt_prog__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"netcnt_prog__open_and_load\"))\n\t\treturn;\n\n\tnproc = bpf_num_possible_cpus();\n\tpercpu_netcnt = malloc(sizeof(*percpu_netcnt) * nproc);\n\tif (!ASSERT_OK_PTR(percpu_netcnt, \"malloc(percpu_netcnt)\"))\n\t\tgoto err;\n\n\tcg_fd = test__join_cgroup(CG_NAME);\n\tif (!ASSERT_GE(cg_fd, 0, \"test__join_cgroup\"))\n\t\tgoto err;\n\n\tskel->links.bpf_nextcnt = bpf_program__attach_cgroup(skel->progs.bpf_nextcnt, cg_fd);\n\tif (!ASSERT_OK_PTR(skel->links.bpf_nextcnt,\n\t\t\t   \"attach_cgroup(bpf_nextcnt)\"))\n\t\tgoto err;\n\n\tsnprintf(cmd, sizeof(cmd), \"%s ::1 -A -c 10000 -q > /dev/null\", ping_command(AF_INET6));\n\tASSERT_OK(system(cmd), cmd);\n\n\tmap_fd = bpf_map__fd(skel->maps.netcnt);\n\tif (!ASSERT_OK(bpf_map_get_next_key(map_fd, NULL, &key), \"bpf_map_get_next_key\"))\n\t\tgoto err;\n\n\tif (!ASSERT_OK(bpf_map_lookup_elem(map_fd, &key, &netcnt), \"bpf_map_lookup_elem(netcnt)\"))\n\t\tgoto err;\n\n\tpercpu_map_fd = bpf_map__fd(skel->maps.percpu_netcnt);\n\tif (!ASSERT_OK(bpf_map_lookup_elem(percpu_map_fd, &key, &percpu_netcnt[0]),\n\t\t       \"bpf_map_lookup_elem(percpu_netcnt)\"))\n\t\tgoto err;\n\n\t \n\tpackets = netcnt.packets;\n\tbytes = netcnt.bytes;\n\tfor (cpu = 0; cpu < nproc; cpu++) {\n\t\tASSERT_LE(percpu_netcnt[cpu].packets, MAX_PERCPU_PACKETS, \"MAX_PERCPU_PACKETS\");\n\n\t\tpackets += percpu_netcnt[cpu].packets;\n\t\tbytes += percpu_netcnt[cpu].bytes;\n\t}\n\n\t \n\tASSERT_GE(packets, 10000, \"packets\");\n\n\t \n\tASSERT_GE(bytes, packets * 104, \"bytes\");\n\nerr:\n\tif (cg_fd != -1)\n\t\tclose(cg_fd);\n\tfree(percpu_netcnt);\n\tnetcnt_prog__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}