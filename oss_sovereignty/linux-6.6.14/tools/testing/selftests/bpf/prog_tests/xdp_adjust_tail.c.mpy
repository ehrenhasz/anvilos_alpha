{
  "module_name": "xdp_adjust_tail.c",
  "hash_id": "e5f9e576668c3096a11887f7cf754e07f7a648dea14885cdc985516c8387980c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/xdp_adjust_tail.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include <network_helpers.h>\n\nstatic void test_xdp_adjust_tail_shrink(void)\n{\n\tconst char *file = \"./test_xdp_adjust_tail_shrink.bpf.o\";\n\t__u32 expect_sz;\n\tstruct bpf_object *obj;\n\tint err, prog_fd;\n\tchar buf[128];\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t.data_in = &pkt_v4,\n\t\t.data_size_in = sizeof(pkt_v4),\n\t\t.data_out = buf,\n\t\t.data_size_out = sizeof(buf),\n\t\t.repeat = 1,\n\t);\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj, &prog_fd);\n\tif (!ASSERT_OK(err, \"test_xdp_adjust_tail_shrink\"))\n\t\treturn;\n\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(err, \"ipv4\");\n\tASSERT_EQ(topts.retval, XDP_DROP, \"ipv4 retval\");\n\n\texpect_sz = sizeof(pkt_v6) - 20;   \n\ttopts.data_in = &pkt_v6;\n\ttopts.data_size_in = sizeof(pkt_v6);\n\ttopts.data_size_out = sizeof(buf);\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(err, \"ipv6\");\n\tASSERT_EQ(topts.retval, XDP_TX, \"ipv6 retval\");\n\tASSERT_EQ(topts.data_size_out, expect_sz, \"ipv6 size\");\n\n\tbpf_object__close(obj);\n}\n\nstatic void test_xdp_adjust_tail_grow(void)\n{\n\tconst char *file = \"./test_xdp_adjust_tail_grow.bpf.o\";\n\tstruct bpf_object *obj;\n\tchar buf[4096];  \n\t__u32 expect_sz;\n\tint err, prog_fd;\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t.data_in = &pkt_v4,\n\t\t.data_size_in = sizeof(pkt_v4),\n\t\t.data_out = buf,\n\t\t.data_size_out = sizeof(buf),\n\t\t.repeat = 1,\n\t);\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj, &prog_fd);\n\tif (!ASSERT_OK(err, \"test_xdp_adjust_tail_grow\"))\n\t\treturn;\n\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(err, \"ipv4\");\n\tASSERT_EQ(topts.retval, XDP_DROP, \"ipv4 retval\");\n\n\texpect_sz = sizeof(pkt_v6) + 40;  \n\ttopts.data_in = &pkt_v6;\n\ttopts.data_size_in = sizeof(pkt_v6);\n\ttopts.data_size_out = sizeof(buf);\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(err, \"ipv6\");\n\tASSERT_EQ(topts.retval, XDP_TX, \"ipv6 retval\");\n\tASSERT_EQ(topts.data_size_out, expect_sz, \"ipv6 size\");\n\n\tbpf_object__close(obj);\n}\n\nstatic void test_xdp_adjust_tail_grow2(void)\n{\n\tconst char *file = \"./test_xdp_adjust_tail_grow.bpf.o\";\n\tchar buf[4096];  \n\tstruct bpf_object *obj;\n\tint err, cnt, i;\n\tint max_grow, prog_fd;\n\t \n#if defined(__s390x__)\n\tint tailroom = 512;\n#else\n\tint tailroom = 320;\n#endif\n\n\tLIBBPF_OPTS(bpf_test_run_opts, tattr,\n\t\t.repeat\t\t= 1,\n\t\t.data_in\t= &buf,\n\t\t.data_out\t= &buf,\n\t\t.data_size_in\t= 0,  \n\t\t.data_size_out\t= 0,  \n\t);\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj, &prog_fd);\n\tif (!ASSERT_OK(err, \"test_xdp_adjust_tail_grow\"))\n\t\treturn;\n\n\t \n\tmemset(buf, 1, sizeof(buf));\n\ttattr.data_size_in  =  64;  \n\ttattr.data_size_out = 128;  \n\t \n\terr = bpf_prog_test_run_opts(prog_fd, &tattr);\n\n\tASSERT_EQ(errno, ENOSPC, \"case-64 errno\");  \n\tASSERT_EQ(tattr.retval, XDP_TX, \"case-64 retval\");\n\tASSERT_EQ(tattr.data_size_out, 192, \"case-64 data_size_out\");  \n\n\t \n\tASSERT_EQ(buf[0], 1, \"case-64-data buf[0]\");  \n\tASSERT_EQ(buf[63], 1, \"case-64-data buf[63]\");\n\tASSERT_EQ(buf[64], 0, \"case-64-data buf[64]\");  \n\tASSERT_EQ(buf[127], 0, \"case-64-data buf[127]\");\n\tASSERT_EQ(buf[128], 1, \"case-64-data buf[128]\");  \n\tASSERT_EQ(buf[191], 1, \"case-64-data buf[191]\");\n\n\t \n\tmemset(buf, 2, sizeof(buf));\n\ttattr.data_size_in  = 128;  \n\ttattr.data_size_out = sizeof(buf);    \n\terr = bpf_prog_test_run_opts(prog_fd, &tattr);\n\n\tmax_grow = 4096 - XDP_PACKET_HEADROOM -\ttailroom;  \n\tASSERT_OK(err, \"case-128\");\n\tASSERT_EQ(tattr.retval, XDP_TX, \"case-128 retval\");\n\tASSERT_EQ(tattr.data_size_out, max_grow, \"case-128 data_size_out\");  \n\n\t \n\tfor (i = 0, cnt = 0; i < sizeof(buf); i++) {\n\t\tif (buf[i] == 0)\n\t\t\tcnt++;\n\t}\n\tASSERT_EQ(cnt, max_grow - tattr.data_size_in, \"case-128-data cnt\");  \n\tASSERT_EQ(tattr.data_size_out, max_grow, \"case-128-data data_size_out\");  \n\n\tbpf_object__close(obj);\n}\n\nstatic void test_xdp_adjust_frags_tail_shrink(void)\n{\n\tconst char *file = \"./test_xdp_adjust_tail_shrink.bpf.o\";\n\t__u32 exp_size;\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\tint err, prog_fd;\n\t__u8 *buf;\n\tLIBBPF_OPTS(bpf_test_run_opts, topts);\n\n\t \n\tobj = bpf_object__open(file);\n\tif (libbpf_get_error(obj))\n\t\treturn;\n\n\tprog = bpf_object__next_program(obj, NULL);\n\tif (bpf_object__load(obj))\n\t\treturn;\n\n\tprog_fd = bpf_program__fd(prog);\n\n\tbuf = malloc(9000);\n\tif (!ASSERT_OK_PTR(buf, \"alloc buf 9Kb\"))\n\t\tgoto out;\n\n\tmemset(buf, 0, 9000);\n\n\t \n\texp_size = 8990;  \n\ttopts.data_in = buf;\n\ttopts.data_out = buf;\n\ttopts.data_size_in = 9000;\n\ttopts.data_size_out = 9000;\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\n\tASSERT_OK(err, \"9Kb-10b\");\n\tASSERT_EQ(topts.retval, XDP_TX, \"9Kb-10b retval\");\n\tASSERT_EQ(topts.data_size_out, exp_size, \"9Kb-10b size\");\n\n\t \n\tbuf[0] = 1;\n\texp_size = 4900;  \n\n\ttopts.data_size_out = 9000;  \n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\n\tASSERT_OK(err, \"9Kb-4Kb\");\n\tASSERT_EQ(topts.retval, XDP_TX, \"9Kb-4Kb retval\");\n\tASSERT_EQ(topts.data_size_out, exp_size, \"9Kb-4Kb size\");\n\n\t \n\tbuf[0] = 2;\n\texp_size = 800;  \n\ttopts.data_size_out = 9000;  \n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\n\tASSERT_OK(err, \"9Kb-9Kb\");\n\tASSERT_EQ(topts.retval, XDP_TX, \"9Kb-9Kb retval\");\n\tASSERT_EQ(topts.data_size_out, exp_size, \"9Kb-9Kb size\");\n\n\tfree(buf);\nout:\n\tbpf_object__close(obj);\n}\n\nstatic void test_xdp_adjust_frags_tail_grow(void)\n{\n\tconst char *file = \"./test_xdp_adjust_tail_grow.bpf.o\";\n\t__u32 exp_size;\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\tint err, i, prog_fd;\n\t__u8 *buf;\n\tLIBBPF_OPTS(bpf_test_run_opts, topts);\n\n\tobj = bpf_object__open(file);\n\tif (libbpf_get_error(obj))\n\t\treturn;\n\n\tprog = bpf_object__next_program(obj, NULL);\n\tif (bpf_object__load(obj))\n\t\treturn;\n\n\tprog_fd = bpf_program__fd(prog);\n\n\tbuf = malloc(16384);\n\tif (!ASSERT_OK_PTR(buf, \"alloc buf 16Kb\"))\n\t\tgoto out;\n\n\t \n\tmemset(buf, 1, 16384);\n\texp_size = 9000 + 10;\n\n\ttopts.data_in = buf;\n\ttopts.data_out = buf;\n\ttopts.data_size_in = 9000;\n\ttopts.data_size_out = 16384;\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\n\tASSERT_OK(err, \"9Kb+10b\");\n\tASSERT_EQ(topts.retval, XDP_TX, \"9Kb+10b retval\");\n\tASSERT_EQ(topts.data_size_out, exp_size, \"9Kb+10b size\");\n\n\tfor (i = 0; i < 9000; i++)\n\t\tASSERT_EQ(buf[i], 1, \"9Kb+10b-old\");\n\n\tfor (i = 9000; i < 9010; i++)\n\t\tASSERT_EQ(buf[i], 0, \"9Kb+10b-new\");\n\n\tfor (i = 9010; i < 16384; i++)\n\t\tASSERT_EQ(buf[i], 1, \"9Kb+10b-untouched\");\n\n\t \n\tmemset(buf, 1, 16384);\n\texp_size = 9001;\n\n\ttopts.data_in = topts.data_out = buf;\n\ttopts.data_size_in = 9001;\n\ttopts.data_size_out = 16384;\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\n\tASSERT_OK(err, \"9Kb+10b\");\n\tASSERT_EQ(topts.retval, XDP_DROP, \"9Kb+10b retval\");\n\tASSERT_EQ(topts.data_size_out, exp_size, \"9Kb+10b size\");\n\n\tfree(buf);\nout:\n\tbpf_object__close(obj);\n}\n\nvoid test_xdp_adjust_tail(void)\n{\n\tif (test__start_subtest(\"xdp_adjust_tail_shrink\"))\n\t\ttest_xdp_adjust_tail_shrink();\n\tif (test__start_subtest(\"xdp_adjust_tail_grow\"))\n\t\ttest_xdp_adjust_tail_grow();\n\tif (test__start_subtest(\"xdp_adjust_tail_grow2\"))\n\t\ttest_xdp_adjust_tail_grow2();\n\tif (test__start_subtest(\"xdp_adjust_frags_tail_shrink\"))\n\t\ttest_xdp_adjust_frags_tail_shrink();\n\tif (test__start_subtest(\"xdp_adjust_frags_tail_grow\"))\n\t\ttest_xdp_adjust_frags_tail_grow();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}