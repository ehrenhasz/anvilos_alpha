{
  "module_name": "cgroup_attach_multi.c",
  "hash_id": "12a47558b81c1fa3a55391b7f4fed26730bb1133773e6d2e8e0cb1773384b6cc",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgroup_attach_multi.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n\n#include \"cgroup_helpers.h\"\n\n#define PING_CMD\t\"ping -q -c1 -w1 127.0.0.1 > /dev/null\"\n\nstatic char bpf_log_buf[BPF_LOG_BUF_SIZE];\n\nstatic int map_fd = -1;\n\nstatic int prog_load_cnt(int verdict, int val)\n{\n\tint cgroup_storage_fd, percpu_cgroup_storage_fd;\n\n\tif (map_fd < 0)\n\t\tmap_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, NULL, 4, 8, 1, NULL);\n\tif (map_fd < 0) {\n\t\tprintf(\"failed to create map '%s'\\n\", strerror(errno));\n\t\treturn -1;\n\t}\n\n\tcgroup_storage_fd = bpf_map_create(BPF_MAP_TYPE_CGROUP_STORAGE, NULL,\n\t\t\t\tsizeof(struct bpf_cgroup_storage_key), 8, 0, NULL);\n\tif (cgroup_storage_fd < 0) {\n\t\tprintf(\"failed to create map '%s'\\n\", strerror(errno));\n\t\treturn -1;\n\t}\n\n\tpercpu_cgroup_storage_fd = bpf_map_create(\n\t\tBPF_MAP_TYPE_PERCPU_CGROUP_STORAGE, NULL,\n\t\tsizeof(struct bpf_cgroup_storage_key), 8, 0, NULL);\n\tif (percpu_cgroup_storage_fd < 0) {\n\t\tprintf(\"failed to create map '%s'\\n\", strerror(errno));\n\t\treturn -1;\n\t}\n\n\tstruct bpf_insn prog[] = {\n\t\tBPF_MOV32_IMM(BPF_REG_0, 0),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, -4),  \n\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_10),\n\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),  \n\t\tBPF_LD_MAP_FD(BPF_REG_1, map_fd),\n\t\tBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),\n\t\tBPF_JMP_IMM(BPF_JEQ, BPF_REG_0, 0, 2),\n\t\tBPF_MOV64_IMM(BPF_REG_1, val),  \n\t\tBPF_ATOMIC_OP(BPF_DW, BPF_ADD, BPF_REG_0, BPF_REG_1, 0),\n\n\t\tBPF_LD_MAP_FD(BPF_REG_1, cgroup_storage_fd),\n\t\tBPF_MOV64_IMM(BPF_REG_2, 0),\n\t\tBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_get_local_storage),\n\t\tBPF_MOV64_IMM(BPF_REG_1, val),\n\t\tBPF_ATOMIC_OP(BPF_W, BPF_ADD, BPF_REG_0, BPF_REG_1, 0),\n\n\t\tBPF_LD_MAP_FD(BPF_REG_1, percpu_cgroup_storage_fd),\n\t\tBPF_MOV64_IMM(BPF_REG_2, 0),\n\t\tBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_get_local_storage),\n\t\tBPF_LDX_MEM(BPF_W, BPF_REG_3, BPF_REG_0, 0),\n\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x1),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_0, BPF_REG_3, 0),\n\n\t\tBPF_MOV64_IMM(BPF_REG_0, verdict),  \n\t\tBPF_EXIT_INSN(),\n\t};\n\tsize_t insns_cnt = ARRAY_SIZE(prog);\n\tint ret;\n\n\tret = bpf_test_load_program(BPF_PROG_TYPE_CGROUP_SKB,\n\t\t\t       prog, insns_cnt, \"GPL\", 0,\n\t\t\t       bpf_log_buf, BPF_LOG_BUF_SIZE);\n\n\tclose(cgroup_storage_fd);\n\treturn ret;\n}\n\nvoid serial_test_cgroup_attach_multi(void)\n{\n\t__u32 prog_ids[4], prog_cnt = 0, attach_flags, saved_prog_id;\n\tint cg1 = 0, cg2 = 0, cg3 = 0, cg4 = 0, cg5 = 0, key = 0;\n\tDECLARE_LIBBPF_OPTS(bpf_prog_attach_opts, attach_opts);\n\tint allow_prog[7] = {-1};\n\tunsigned long long value;\n\t__u32 duration = 0;\n\tint i = 0;\n\n\tfor (i = 0; i < ARRAY_SIZE(allow_prog); i++) {\n\t\tallow_prog[i] = prog_load_cnt(1, 1 << i);\n\t\tif (CHECK(allow_prog[i] < 0, \"prog_load\",\n\t\t\t  \"verifier output:\\n%s\\n-------\\n\", bpf_log_buf))\n\t\t\tgoto err;\n\t}\n\n\tif (CHECK_FAIL(setup_cgroup_environment()))\n\t\tgoto err;\n\n\tcg1 = create_and_get_cgroup(\"/cg1\");\n\tif (CHECK_FAIL(cg1 < 0))\n\t\tgoto err;\n\tcg2 = create_and_get_cgroup(\"/cg1/cg2\");\n\tif (CHECK_FAIL(cg2 < 0))\n\t\tgoto err;\n\tcg3 = create_and_get_cgroup(\"/cg1/cg2/cg3\");\n\tif (CHECK_FAIL(cg3 < 0))\n\t\tgoto err;\n\tcg4 = create_and_get_cgroup(\"/cg1/cg2/cg3/cg4\");\n\tif (CHECK_FAIL(cg4 < 0))\n\t\tgoto err;\n\tcg5 = create_and_get_cgroup(\"/cg1/cg2/cg3/cg4/cg5\");\n\tif (CHECK_FAIL(cg5 < 0))\n\t\tgoto err;\n\n\tif (CHECK_FAIL(join_cgroup(\"/cg1/cg2/cg3/cg4/cg5\")))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog[0], cg1, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_MULTI),\n\t\t  \"prog0_attach_to_cg1_multi\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tif (CHECK(!bpf_prog_attach(allow_prog[0], cg1, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t   BPF_F_ALLOW_MULTI),\n\t\t  \"fail_same_prog_attach_to_cg1\", \"unexpected success\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog[1], cg1, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_MULTI),\n\t\t  \"prog1_attach_to_cg1_multi\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog[2], cg2, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_OVERRIDE),\n\t\t  \"prog2_attach_to_cg2_override\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog[3], cg3, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_MULTI),\n\t\t  \"prog3_attach_to_cg3_multi\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog[4], cg4, BPF_CGROUP_INET_EGRESS,\n\t\t\t    BPF_F_ALLOW_OVERRIDE),\n\t\t  \"prog4_attach_to_cg4_override\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog[5], cg5, BPF_CGROUP_INET_EGRESS, 0),\n\t\t  \"prog5_attach_to_cg5_none\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tCHECK_FAIL(system(PING_CMD));\n\tCHECK_FAIL(bpf_map_lookup_elem(map_fd, &key, &value));\n\tCHECK_FAIL(value != 1 + 2 + 8 + 32);\n\n\t \n\tCHECK_FAIL(bpf_prog_query(cg5, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_QUERY_EFFECTIVE, NULL, NULL, &prog_cnt));\n\tCHECK_FAIL(prog_cnt != 4);\n\t \n\tCHECK_FAIL(bpf_prog_query(cg5, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_QUERY_EFFECTIVE, &attach_flags,\n\t\t\t\t  prog_ids, &prog_cnt));\n\tCHECK_FAIL(prog_cnt != 4);\n\tCHECK_FAIL(attach_flags != 0);\n\tsaved_prog_id = prog_ids[0];\n\t \n\tprog_ids[0] = 0;\n\tprog_cnt = 2;\n\tCHECK_FAIL(bpf_prog_query(cg5, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_QUERY_EFFECTIVE, &attach_flags,\n\t\t\t\t  prog_ids, &prog_cnt) >= 0);\n\tCHECK_FAIL(errno != ENOSPC);\n\tCHECK_FAIL(prog_cnt != 4);\n\t \n\tCHECK_FAIL(prog_ids[0] != saved_prog_id);\n\t \n\tprog_ids[0] = 0;\n\tCHECK_FAIL(bpf_prog_query(cg5, BPF_CGROUP_INET_EGRESS, 0, NULL,\n\t\t\t\t  prog_ids, &prog_cnt));\n\tCHECK_FAIL(prog_cnt != 1);\n\tCHECK_FAIL(prog_ids[0] != saved_prog_id);\n\n\t \n\tif (CHECK(bpf_prog_detach2(-1, cg5, BPF_CGROUP_INET_EGRESS),\n\t\t  \"prog_detach_from_cg5\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tvalue = 0;\n\tCHECK_FAIL(bpf_map_update_elem(map_fd, &key, &value, 0));\n\tCHECK_FAIL(system(PING_CMD));\n\tCHECK_FAIL(bpf_map_lookup_elem(map_fd, &key, &value));\n\tCHECK_FAIL(value != 1 + 2 + 8 + 16);\n\n\t \n\n\tattach_opts.flags = BPF_F_ALLOW_OVERRIDE | BPF_F_REPLACE;\n\tattach_opts.replace_prog_fd = allow_prog[0];\n\tif (CHECK(!bpf_prog_attach_opts(allow_prog[6], cg1,\n\t\t\t\t\t BPF_CGROUP_INET_EGRESS, &attach_opts),\n\t\t  \"fail_prog_replace_override\", \"unexpected success\\n\"))\n\t\tgoto err;\n\tCHECK_FAIL(errno != EINVAL);\n\n\tattach_opts.flags = BPF_F_REPLACE;\n\tif (CHECK(!bpf_prog_attach_opts(allow_prog[6], cg1,\n\t\t\t\t\t BPF_CGROUP_INET_EGRESS, &attach_opts),\n\t\t  \"fail_prog_replace_no_multi\", \"unexpected success\\n\"))\n\t\tgoto err;\n\tCHECK_FAIL(errno != EINVAL);\n\n\tattach_opts.flags = BPF_F_ALLOW_MULTI | BPF_F_REPLACE;\n\tattach_opts.replace_prog_fd = -1;\n\tif (CHECK(!bpf_prog_attach_opts(allow_prog[6], cg1,\n\t\t\t\t\t BPF_CGROUP_INET_EGRESS, &attach_opts),\n\t\t  \"fail_prog_replace_bad_fd\", \"unexpected success\\n\"))\n\t\tgoto err;\n\tCHECK_FAIL(errno != EBADF);\n\n\t \n\tattach_opts.replace_prog_fd = allow_prog[3];\n\tif (CHECK(!bpf_prog_attach_opts(allow_prog[6], cg1,\n\t\t\t\t\t BPF_CGROUP_INET_EGRESS, &attach_opts),\n\t\t  \"fail_prog_replace_no_ent\", \"unexpected success\\n\"))\n\t\tgoto err;\n\tCHECK_FAIL(errno != ENOENT);\n\n\t \n\tattach_opts.replace_prog_fd = allow_prog[0];\n\tif (CHECK(bpf_prog_attach_opts(allow_prog[6], cg1,\n\t\t\t\t\tBPF_CGROUP_INET_EGRESS, &attach_opts),\n\t\t  \"prog_replace\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\t \n\tattach_opts.replace_prog_fd = allow_prog[6];\n\tif (CHECK(bpf_prog_attach_opts(allow_prog[6], cg1,\n\t\t\t\t\tBPF_CGROUP_INET_EGRESS, &attach_opts),\n\t\t  \"prog_replace\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tvalue = 0;\n\tCHECK_FAIL(bpf_map_update_elem(map_fd, &key, &value, 0));\n\tCHECK_FAIL(system(PING_CMD));\n\tCHECK_FAIL(bpf_map_lookup_elem(map_fd, &key, &value));\n\tCHECK_FAIL(value != 64 + 2 + 8 + 16);\n\n\t \n\tif (CHECK(!bpf_prog_detach2(0, cg3, BPF_CGROUP_INET_EGRESS),\n\t\t  \"fail_prog_detach_from_cg3\", \"unexpected success\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_detach2(allow_prog[3], cg3, BPF_CGROUP_INET_EGRESS),\n\t\t  \"prog3_detach_from_cg3\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tvalue = 0;\n\tCHECK_FAIL(bpf_map_update_elem(map_fd, &key, &value, 0));\n\tCHECK_FAIL(system(PING_CMD));\n\tCHECK_FAIL(bpf_map_lookup_elem(map_fd, &key, &value));\n\tCHECK_FAIL(value != 64 + 2 + 16);\n\n\t \n\tif (CHECK(bpf_prog_detach2(-1, cg4, BPF_CGROUP_INET_EGRESS),\n\t\t  \"prog_detach_from_cg4\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\n\tvalue = 0;\n\tCHECK_FAIL(bpf_map_update_elem(map_fd, &key, &value, 0));\n\tCHECK_FAIL(system(PING_CMD));\n\tCHECK_FAIL(bpf_map_lookup_elem(map_fd, &key, &value));\n\tCHECK_FAIL(value != 64 + 2 + 4);\n\n\tprog_cnt = 4;\n\tCHECK_FAIL(bpf_prog_query(cg5, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_QUERY_EFFECTIVE, &attach_flags,\n\t\t\t\t  prog_ids, &prog_cnt));\n\tCHECK_FAIL(prog_cnt != 3);\n\tCHECK_FAIL(attach_flags != 0);\n\tCHECK_FAIL(bpf_prog_query(cg5, BPF_CGROUP_INET_EGRESS, 0, NULL,\n\t\t\t\t  prog_ids, &prog_cnt));\n\tCHECK_FAIL(prog_cnt != 0);\n\nerr:\n\tfor (i = 0; i < ARRAY_SIZE(allow_prog); i++)\n\t\tif (allow_prog[i] >= 0)\n\t\t\tclose(allow_prog[i]);\n\tclose(cg1);\n\tclose(cg2);\n\tclose(cg3);\n\tclose(cg4);\n\tclose(cg5);\n\tcleanup_cgroup_environment();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}