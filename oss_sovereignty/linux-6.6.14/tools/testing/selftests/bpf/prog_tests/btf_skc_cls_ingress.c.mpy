{
  "module_name": "btf_skc_cls_ingress.c",
  "hash_id": "61d1d54bd2959ea0fb35739f6bb479cc04e4b009f0c7e055bdad9645ed4c293c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/btf_skc_cls_ingress.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <string.h>\n#include <errno.h>\n#include <sched.h>\n#include <net/if.h>\n#include <linux/compiler.h>\n#include <bpf/libbpf.h>\n\n#include \"network_helpers.h\"\n#include \"test_progs.h\"\n#include \"test_btf_skc_cls_ingress.skel.h\"\n\nstatic struct test_btf_skc_cls_ingress *skel;\nstatic struct sockaddr_in6 srv_sa6;\nstatic __u32 duration;\n\nstatic int prepare_netns(void)\n{\n\tLIBBPF_OPTS(bpf_tc_hook, qdisc_lo, .attach_point = BPF_TC_INGRESS);\n\tLIBBPF_OPTS(bpf_tc_opts, tc_attach,\n\t\t    .prog_fd = bpf_program__fd(skel->progs.cls_ingress));\n\n\tif (CHECK(unshare(CLONE_NEWNET), \"create netns\",\n\t\t  \"unshare(CLONE_NEWNET): %s (%d)\",\n\t\t  strerror(errno), errno))\n\t\treturn -1;\n\n\tif (CHECK(system(\"ip link set dev lo up\"),\n\t\t  \"ip link set dev lo up\", \"failed\\n\"))\n\t\treturn -1;\n\n\tqdisc_lo.ifindex = if_nametoindex(\"lo\");\n\tif (!ASSERT_OK(bpf_tc_hook_create(&qdisc_lo), \"qdisc add dev lo clsact\"))\n\t\treturn -1;\n\n\tif (!ASSERT_OK(bpf_tc_attach(&qdisc_lo, &tc_attach),\n\t\t       \"filter add dev lo ingress\"))\n\t\treturn -1;\n\n\t \n\tif (write_sysctl(\"/proc/sys/net/ipv4/tcp_window_scaling\", \"1\") ||\n\t    write_sysctl(\"/proc/sys/net/ipv4/tcp_timestamps\", \"1\") ||\n\t    write_sysctl(\"/proc/sys/net/ipv4/tcp_sack\", \"1\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic void reset_test(void)\n{\n\tmemset(&skel->bss->srv_sa6, 0, sizeof(skel->bss->srv_sa6));\n\tskel->bss->listen_tp_sport = 0;\n\tskel->bss->req_sk_sport = 0;\n\tskel->bss->recv_cookie = 0;\n\tskel->bss->gen_cookie = 0;\n\tskel->bss->linum = 0;\n}\n\nstatic void print_err_line(void)\n{\n\tif (skel->bss->linum)\n\t\tprintf(\"bpf prog error at line %u\\n\", skel->bss->linum);\n}\n\nstatic void test_conn(void)\n{\n\tint listen_fd = -1, cli_fd = -1, srv_fd = -1, err;\n\tsocklen_t addrlen = sizeof(srv_sa6);\n\tint srv_port;\n\n\tif (write_sysctl(\"/proc/sys/net/ipv4/tcp_syncookies\", \"1\"))\n\t\treturn;\n\n\tlisten_fd = start_server(AF_INET6, SOCK_STREAM, \"::1\", 0, 0);\n\tif (CHECK_FAIL(listen_fd == -1))\n\t\treturn;\n\n\terr = getsockname(listen_fd, (struct sockaddr *)&srv_sa6, &addrlen);\n\tif (CHECK(err, \"getsockname(listen_fd)\", \"err:%d errno:%d\\n\", err,\n\t\t  errno))\n\t\tgoto done;\n\tmemcpy(&skel->bss->srv_sa6, &srv_sa6, sizeof(srv_sa6));\n\tsrv_port = ntohs(srv_sa6.sin6_port);\n\n\tcli_fd = connect_to_fd(listen_fd, 0);\n\tif (CHECK_FAIL(cli_fd == -1))\n\t\tgoto done;\n\n\tsrv_fd = accept(listen_fd, NULL, NULL);\n\tif (CHECK_FAIL(srv_fd == -1))\n\t\tgoto done;\n\n\tif (CHECK(skel->bss->listen_tp_sport != srv_port ||\n\t\t  skel->bss->req_sk_sport != srv_port,\n\t\t  \"Unexpected sk src port\",\n\t\t  \"listen_tp_sport:%u req_sk_sport:%u expected:%u\\n\",\n\t\t  skel->bss->listen_tp_sport, skel->bss->req_sk_sport,\n\t\t  srv_port))\n\t\tgoto done;\n\n\tif (CHECK(skel->bss->gen_cookie || skel->bss->recv_cookie,\n\t\t  \"Unexpected syncookie states\",\n\t\t  \"gen_cookie:%u recv_cookie:%u\\n\",\n\t\t  skel->bss->gen_cookie, skel->bss->recv_cookie))\n\t\tgoto done;\n\n\tCHECK(skel->bss->linum, \"bpf prog detected error\", \"at line %u\\n\",\n\t      skel->bss->linum);\n\ndone:\n\tif (listen_fd != -1)\n\t\tclose(listen_fd);\n\tif (cli_fd != -1)\n\t\tclose(cli_fd);\n\tif (srv_fd != -1)\n\t\tclose(srv_fd);\n}\n\nstatic void test_syncookie(void)\n{\n\tint listen_fd = -1, cli_fd = -1, srv_fd = -1, err;\n\tsocklen_t addrlen = sizeof(srv_sa6);\n\tint srv_port;\n\n\t \n\tif (write_sysctl(\"/proc/sys/net/ipv4/tcp_syncookies\", \"2\"))\n\t\treturn;\n\n\tlisten_fd = start_server(AF_INET6, SOCK_STREAM, \"::1\", 0, 0);\n\tif (CHECK_FAIL(listen_fd == -1))\n\t\treturn;\n\n\terr = getsockname(listen_fd, (struct sockaddr *)&srv_sa6, &addrlen);\n\tif (CHECK(err, \"getsockname(listen_fd)\", \"err:%d errno:%d\\n\", err,\n\t\t  errno))\n\t\tgoto done;\n\tmemcpy(&skel->bss->srv_sa6, &srv_sa6, sizeof(srv_sa6));\n\tsrv_port = ntohs(srv_sa6.sin6_port);\n\n\tcli_fd = connect_to_fd(listen_fd, 0);\n\tif (CHECK_FAIL(cli_fd == -1))\n\t\tgoto done;\n\n\tsrv_fd = accept(listen_fd, NULL, NULL);\n\tif (CHECK_FAIL(srv_fd == -1))\n\t\tgoto done;\n\n\tif (CHECK(skel->bss->listen_tp_sport != srv_port,\n\t\t  \"Unexpected tp src port\",\n\t\t  \"listen_tp_sport:%u expected:%u\\n\",\n\t\t  skel->bss->listen_tp_sport, srv_port))\n\t\tgoto done;\n\n\tif (CHECK(skel->bss->req_sk_sport,\n\t\t  \"Unexpected req_sk src port\",\n\t\t  \"req_sk_sport:%u expected:0\\n\",\n\t\t   skel->bss->req_sk_sport))\n\t\tgoto done;\n\n\tif (CHECK(!skel->bss->gen_cookie ||\n\t\t  skel->bss->gen_cookie != skel->bss->recv_cookie,\n\t\t  \"Unexpected syncookie states\",\n\t\t  \"gen_cookie:%u recv_cookie:%u\\n\",\n\t\t  skel->bss->gen_cookie, skel->bss->recv_cookie))\n\t\tgoto done;\n\n\tCHECK(skel->bss->linum, \"bpf prog detected error\", \"at line %u\\n\",\n\t      skel->bss->linum);\n\ndone:\n\tif (listen_fd != -1)\n\t\tclose(listen_fd);\n\tif (cli_fd != -1)\n\t\tclose(cli_fd);\n\tif (srv_fd != -1)\n\t\tclose(srv_fd);\n}\n\nstruct test {\n\tconst char *desc;\n\tvoid (*run)(void);\n};\n\n#define DEF_TEST(name) { #name, test_##name }\nstatic struct test tests[] = {\n\tDEF_TEST(conn),\n\tDEF_TEST(syncookie),\n};\n\nvoid test_btf_skc_cls_ingress(void)\n{\n\tint i;\n\n\tskel = test_btf_skc_cls_ingress__open_and_load();\n\tif (CHECK(!skel, \"test_btf_skc_cls_ingress__open_and_load\", \"failed\\n\"))\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); i++) {\n\t\tif (!test__start_subtest(tests[i].desc))\n\t\t\tcontinue;\n\n\t\tif (prepare_netns())\n\t\t\tbreak;\n\n\t\ttests[i].run();\n\n\t\tprint_err_line();\n\t\treset_test();\n\t}\n\n\ttest_btf_skc_cls_ingress__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}