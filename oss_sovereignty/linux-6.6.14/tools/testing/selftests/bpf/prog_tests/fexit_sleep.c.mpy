{
  "module_name": "fexit_sleep.c",
  "hash_id": "cc8d92cd50b502724c9d57303f969587d380f96c9fb1dbb13246306a8597ce19",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/fexit_sleep.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n#include <sched.h>\n#include <test_progs.h>\n#include <time.h>\n#include <sys/mman.h>\n#include <sys/syscall.h>\n#include \"fexit_sleep.lskel.h\"\n\nstatic int do_sleep(void *skel)\n{\n\tstruct fexit_sleep_lskel *fexit_skel = skel;\n\tstruct timespec ts1 = { .tv_nsec = 1 };\n\tstruct timespec ts2 = { .tv_sec = 10 };\n\n\tfexit_skel->bss->pid = getpid();\n\t(void)syscall(__NR_nanosleep, &ts1, NULL);\n\t(void)syscall(__NR_nanosleep, &ts2, NULL);\n\treturn 0;\n}\n\n#define STACK_SIZE (1024 * 1024)\nstatic char child_stack[STACK_SIZE];\n\nvoid test_fexit_sleep(void)\n{\n\tstruct fexit_sleep_lskel *fexit_skel = NULL;\n\tint wstatus, duration = 0;\n\tpid_t cpid;\n\tint err, fexit_cnt;\n\n\tfexit_skel = fexit_sleep_lskel__open_and_load();\n\tif (CHECK(!fexit_skel, \"fexit_skel_load\", \"fexit skeleton failed\\n\"))\n\t\tgoto cleanup;\n\n\terr = fexit_sleep_lskel__attach(fexit_skel);\n\tif (CHECK(err, \"fexit_attach\", \"fexit attach failed: %d\\n\", err))\n\t\tgoto cleanup;\n\n\tcpid = clone(do_sleep, child_stack + STACK_SIZE, CLONE_FILES | SIGCHLD, fexit_skel);\n\tif (CHECK(cpid == -1, \"clone\", \"%s\\n\", strerror(errno)))\n\t\tgoto cleanup;\n\n\t \n\twhile (READ_ONCE(fexit_skel->bss->fentry_cnt) != 2);\n\tfexit_cnt = READ_ONCE(fexit_skel->bss->fexit_cnt);\n\tif (CHECK(fexit_cnt != 1, \"fexit_cnt\", \"%d\", fexit_cnt))\n\t\tgoto cleanup;\n\n\t \n\tclose(fexit_skel->progs.nanosleep_fentry.prog_fd);\n\tclose(fexit_skel->progs.nanosleep_fexit.prog_fd);\n\tfexit_sleep_lskel__detach(fexit_skel);\n\n\t \n\tkill(cpid, 9);\n\n\tif (CHECK(waitpid(cpid, &wstatus, 0) == -1, \"waitpid\", \"%s\\n\", strerror(errno)))\n\t\tgoto cleanup;\n\tif (CHECK(WEXITSTATUS(wstatus) != 0, \"exitstatus\", \"failed\"))\n\t\tgoto cleanup;\n\n\t \n\tfexit_cnt = READ_ONCE(fexit_skel->bss->fexit_cnt);\n\tif (CHECK(fexit_cnt != 1, \"fexit_cnt\", \"%d\", fexit_cnt))\n\t\tgoto cleanup;\n\ncleanup:\n\tfexit_sleep_lskel__destroy(fexit_skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}