{
  "module_name": "cgroup_attach_autodetach.c",
  "hash_id": "f28a1118442c697b8ced4a2d574a23f1617d0bbfb948bfa0709145c045a68ef5",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgroup_attach_autodetach.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n\n#include \"cgroup_helpers.h\"\n\n#define PING_CMD\t\"ping -q -c1 -w1 127.0.0.1 > /dev/null\"\n\nstatic char bpf_log_buf[BPF_LOG_BUF_SIZE];\n\nstatic int prog_load(void)\n{\n\tstruct bpf_insn prog[] = {\n\t\tBPF_MOV64_IMM(BPF_REG_0, 1),  \n\t\tBPF_EXIT_INSN(),\n\t};\n\tsize_t insns_cnt = ARRAY_SIZE(prog);\n\n\treturn bpf_test_load_program(BPF_PROG_TYPE_CGROUP_SKB,\n\t\t\t       prog, insns_cnt, \"GPL\", 0,\n\t\t\t       bpf_log_buf, BPF_LOG_BUF_SIZE);\n}\n\nvoid serial_test_cgroup_attach_autodetach(void)\n{\n\t__u32 duration = 0, prog_cnt = 4, attach_flags;\n\tint allow_prog[2] = {-1};\n\t__u32 prog_ids[2] = {0};\n\tvoid *ptr = NULL;\n\tint cg = 0, i;\n\tint attempts;\n\n\tfor (i = 0; i < ARRAY_SIZE(allow_prog); i++) {\n\t\tallow_prog[i] = prog_load();\n\t\tif (CHECK(allow_prog[i] < 0, \"prog_load\",\n\t\t\t  \"verifier output:\\n%s\\n-------\\n\", bpf_log_buf))\n\t\t\tgoto err;\n\t}\n\n\tif (CHECK_FAIL(setup_cgroup_environment()))\n\t\tgoto err;\n\n\t \n\tcg = create_and_get_cgroup(\"/cg_autodetach\");\n\tif (CHECK_FAIL(cg < 0))\n\t\tgoto err;\n\n\tif (CHECK_FAIL(join_cgroup(\"/cg_autodetach\")))\n\t\tgoto err;\n\n\tfor (i = 0; i < ARRAY_SIZE(allow_prog); i++)\n\t\tif (CHECK(bpf_prog_attach(allow_prog[i], cg,\n\t\t\t\t\t  BPF_CGROUP_INET_EGRESS,\n\t\t\t\t\t  BPF_F_ALLOW_MULTI),\n\t\t\t  \"prog_attach\", \"prog[%d], errno=%d\\n\", i, errno))\n\t\t\tgoto err;\n\n\t \n\tif (CHECK(bpf_prog_query(cg, BPF_CGROUP_INET_EGRESS, 0, &attach_flags,\n\t\t\t\t prog_ids, &prog_cnt),\n\t\t  \"prog_query\", \"errno=%d\\n\", errno))\n\t\tgoto err;\n\tif (CHECK_FAIL(system(PING_CMD)))\n\t\tgoto err;\n\n\t \n\tptr = malloc(4 * (1 << 20));\n\tif (CHECK_FAIL(!ptr))\n\t\tgoto err;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(allow_prog); i++) {\n\t\tclose(allow_prog[i]);\n\t\tallow_prog[i] = -1;\n\t}\n\n\tclose(cg);\n\tcg = 0;\n\n\t \n\tcleanup_cgroup_environment();\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(prog_ids); i++) {\n\t\tfor (attempts = 5; attempts >= 0; attempts--) {\n\t\t\tint fd = bpf_prog_get_fd_by_id(prog_ids[i]);\n\n\t\t\tif (fd < 0)\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\tclose(fd);\n\n\t\t\tif (CHECK_FAIL(!attempts))\n\t\t\t\tgoto err;\n\n\t\t\tsleep(1);\n\t\t}\n\t}\n\nerr:\n\tfor (i = 0; i < ARRAY_SIZE(allow_prog); i++)\n\t\tif (allow_prog[i] >= 0)\n\t\t\tclose(allow_prog[i]);\n\tif (cg)\n\t\tclose(cg);\n\tfree(ptr);\n\tcleanup_cgroup_environment();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}