{
  "module_name": "get_branch_snapshot.c",
  "hash_id": "069465bfe52f9c0f7ef9796ea5622ca8fad9c7e992d3cca6182882a418388d97",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/get_branch_snapshot.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include \"get_branch_snapshot.skel.h\"\n\nstatic int *pfd_array;\nstatic int cpu_cnt;\n\nstatic bool is_hypervisor(void)\n{\n\tchar *line = NULL;\n\tbool ret = false;\n\tsize_t len;\n\tFILE *fp;\n\n\tfp = fopen(\"/proc/cpuinfo\", \"r\");\n\tif (!fp)\n\t\treturn false;\n\n\twhile (getline(&line, &len, fp) != -1) {\n\t\tif (!strncmp(line, \"flags\", 5)) {\n\t\t\tif (strstr(line, \"hypervisor\") != NULL)\n\t\t\t\tret = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfree(line);\n\tfclose(fp);\n\treturn ret;\n}\n\nstatic int create_perf_events(void)\n{\n\tstruct perf_event_attr attr = {0};\n\tint cpu;\n\n\t \n\tattr.size = sizeof(attr);\n\tattr.type = PERF_TYPE_HARDWARE;\n\tattr.config = PERF_COUNT_HW_CPU_CYCLES;\n\tattr.sample_type = PERF_SAMPLE_BRANCH_STACK;\n\tattr.branch_sample_type = PERF_SAMPLE_BRANCH_KERNEL |\n\t\tPERF_SAMPLE_BRANCH_USER | PERF_SAMPLE_BRANCH_ANY;\n\n\tcpu_cnt = libbpf_num_possible_cpus();\n\tpfd_array = malloc(sizeof(int) * cpu_cnt);\n\tif (!pfd_array) {\n\t\tcpu_cnt = 0;\n\t\treturn 1;\n\t}\n\n\tfor (cpu = 0; cpu < cpu_cnt; cpu++) {\n\t\tpfd_array[cpu] = syscall(__NR_perf_event_open, &attr,\n\t\t\t\t\t -1, cpu, -1, PERF_FLAG_FD_CLOEXEC);\n\t\tif (pfd_array[cpu] < 0)\n\t\t\tbreak;\n\t}\n\n\treturn cpu == 0;\n}\n\nstatic void close_perf_events(void)\n{\n\tint cpu, fd;\n\n\tfor (cpu = 0; cpu < cpu_cnt; cpu++) {\n\t\tfd = pfd_array[cpu];\n\t\tif (fd < 0)\n\t\t\tbreak;\n\t\tclose(fd);\n\t}\n\tfree(pfd_array);\n}\n\nvoid serial_test_get_branch_snapshot(void)\n{\n\tstruct get_branch_snapshot *skel = NULL;\n\tint err;\n\n\t \n\tif (is_hypervisor()) {\n\t\ttest__skip();\n\t\treturn;\n\t}\n\n\tif (create_perf_events()) {\n\t\ttest__skip();   \n\t\tgoto cleanup;\n\t}\n\n\tskel = get_branch_snapshot__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"get_branch_snapshot__open_and_load\"))\n\t\tgoto cleanup;\n\n\terr = kallsyms_find(\"bpf_testmod_loop_test\", &skel->bss->address_low);\n\tif (!ASSERT_OK(err, \"kallsyms_find\"))\n\t\tgoto cleanup;\n\n\t \n\tskel->bss->address_high = skel->bss->address_low + 128;\n\n\terr = get_branch_snapshot__attach(skel);\n\tif (!ASSERT_OK(err, \"get_branch_snapshot__attach\"))\n\t\tgoto cleanup;\n\n\ttrigger_module_test_read(100);\n\n\tif (skel->bss->total_entries < 16) {\n\t\t \n\t\ttest__skip();\n\t\tgoto cleanup;\n\t}\n\n\tASSERT_GT(skel->bss->test1_hits, 6, \"find_looptest_in_lbr\");\n\n\t \n\tASSERT_LT(skel->bss->wasted_entries, 10, \"check_wasted_entries\");\n\ncleanup:\n\tget_branch_snapshot__destroy(skel);\n\tclose_perf_events();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}