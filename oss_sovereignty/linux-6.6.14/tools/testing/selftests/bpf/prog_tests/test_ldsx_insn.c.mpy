{
  "module_name": "test_ldsx_insn.c",
  "hash_id": "44d27da80b585ed4e5a5ea784982395c7b00013eed7c602c8539c03c05dfd265",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/test_ldsx_insn.c",
  "human_readable_source": "\n \n\n#include <test_progs.h>\n#include <network_helpers.h>\n#include \"test_ldsx_insn.skel.h\"\n\nstatic void test_map_val_and_probed_memory(void)\n{\n\tstruct test_ldsx_insn *skel;\n\tint err;\n\n\tskel = test_ldsx_insn__open();\n\tif (!ASSERT_OK_PTR(skel, \"test_ldsx_insn__open\"))\n\t\treturn;\n\n\tif (skel->rodata->skip) {\n\t\ttest__skip();\n\t\tgoto out;\n\t}\n\n\tbpf_program__set_autoload(skel->progs.rdonly_map_prog, true);\n\tbpf_program__set_autoload(skel->progs.map_val_prog, true);\n\tbpf_program__set_autoload(skel->progs.test_ptr_struct_arg, true);\n\n\terr = test_ldsx_insn__load(skel);\n\tif (!ASSERT_OK(err, \"test_ldsx_insn__load\"))\n\t\tgoto out;\n\n\terr = test_ldsx_insn__attach(skel);\n\tif (!ASSERT_OK(err, \"test_ldsx_insn__attach\"))\n\t\tgoto out;\n\n\tASSERT_OK(trigger_module_test_read(256), \"trigger_read\");\n\n\tASSERT_EQ(skel->bss->done1, 1, \"done1\");\n\tASSERT_EQ(skel->bss->ret1, 1, \"ret1\");\n\tASSERT_EQ(skel->bss->done2, 1, \"done2\");\n\tASSERT_EQ(skel->bss->ret2, 1, \"ret2\");\n\tASSERT_EQ(skel->bss->int_member, -1, \"int_member\");\n\nout:\n\ttest_ldsx_insn__destroy(skel);\n}\n\nstatic void test_ctx_member_sign_ext(void)\n{\n\tstruct test_ldsx_insn *skel;\n\tint err, fd, cgroup_fd;\n\tchar buf[16] = {0};\n\tsocklen_t optlen;\n\n\tcgroup_fd = test__join_cgroup(\"/ldsx_test\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup /ldsx_test\"))\n\t\treturn;\n\n\tskel = test_ldsx_insn__open();\n\tif (!ASSERT_OK_PTR(skel, \"test_ldsx_insn__open\"))\n\t\tgoto close_cgroup_fd;\n\n\tif (skel->rodata->skip) {\n\t\ttest__skip();\n\t\tgoto destroy_skel;\n\t}\n\n\tbpf_program__set_autoload(skel->progs._getsockopt, true);\n\n\terr = test_ldsx_insn__load(skel);\n\tif (!ASSERT_OK(err, \"test_ldsx_insn__load\"))\n\t\tgoto destroy_skel;\n\n\tskel->links._getsockopt =\n\t\tbpf_program__attach_cgroup(skel->progs._getsockopt, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links._getsockopt, \"getsockopt_link\"))\n\t\tgoto destroy_skel;\n\n\tfd = socket(AF_INET, SOCK_STREAM, 0);\n\tif (!ASSERT_GE(fd, 0, \"socket\"))\n\t\tgoto destroy_skel;\n\n\toptlen = sizeof(buf);\n\t(void)getsockopt(fd, SOL_IP, IP_TTL, buf, &optlen);\n\n\tASSERT_EQ(skel->bss->set_optlen, -1, \"optlen\");\n\tASSERT_EQ(skel->bss->set_retval, -1, \"retval\");\n\n\tclose(fd);\ndestroy_skel:\n\ttest_ldsx_insn__destroy(skel);\nclose_cgroup_fd:\n\tclose(cgroup_fd);\n}\n\nstatic void test_ctx_member_narrow_sign_ext(void)\n{\n\tstruct test_ldsx_insn *skel;\n\tstruct __sk_buff skb = {};\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t    .data_in = &pkt_v4,\n\t\t    .data_size_in = sizeof(pkt_v4),\n\t\t    .ctx_in = &skb,\n\t\t    .ctx_size_in = sizeof(skb),\n\t);\n\tint err, prog_fd;\n\n\tskel = test_ldsx_insn__open();\n\tif (!ASSERT_OK_PTR(skel, \"test_ldsx_insn__open\"))\n\t\treturn;\n\n\tif (skel->rodata->skip) {\n\t\ttest__skip();\n\t\tgoto out;\n\t}\n\n\tbpf_program__set_autoload(skel->progs._tc, true);\n\n\terr = test_ldsx_insn__load(skel);\n\tif (!ASSERT_OK(err, \"test_ldsx_insn__load\"))\n\t\tgoto out;\n\n\tprog_fd = bpf_program__fd(skel->progs._tc);\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(err, \"test_run\");\n\n\tASSERT_EQ(skel->bss->set_mark, -2, \"set_mark\");\n\nout:\n\ttest_ldsx_insn__destroy(skel);\n}\n\nvoid test_ldsx_insn(void)\n{\n\tif (test__start_subtest(\"map_val and probed_memory\"))\n\t\ttest_map_val_and_probed_memory();\n\tif (test__start_subtest(\"ctx_member_sign_ext\"))\n\t\ttest_ctx_member_sign_ext();\n\tif (test__start_subtest(\"ctx_member_narrow_sign_ext\"))\n\t\ttest_ctx_member_narrow_sign_ext();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}