{
  "module_name": "cgroup_v1v2.c",
  "hash_id": "1124448ace107599ebeb70944cad32279237009254ff30334c384af7e616cb7f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgroup_v1v2.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n\n#include \"connect4_dropper.skel.h\"\n\n#include \"cgroup_helpers.h\"\n#include \"network_helpers.h\"\n\nstatic int run_test(int cgroup_fd, int server_fd, bool classid)\n{\n\tstruct network_helper_opts opts = {\n\t\t.must_fail = true,\n\t};\n\tstruct connect4_dropper *skel;\n\tint fd, err = 0;\n\n\tskel = connect4_dropper__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn -1;\n\n\tskel->links.connect_v4_dropper =\n\t\tbpf_program__attach_cgroup(skel->progs.connect_v4_dropper,\n\t\t\t\t\t   cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel->links.connect_v4_dropper, \"prog_attach\")) {\n\t\terr = -1;\n\t\tgoto out;\n\t}\n\n\tif (classid && !ASSERT_OK(join_classid(), \"join_classid\")) {\n\t\terr = -1;\n\t\tgoto out;\n\t}\n\n\tfd = connect_to_fd_opts(server_fd, &opts);\n\tif (fd < 0)\n\t\terr = -1;\n\telse\n\t\tclose(fd);\nout:\n\tconnect4_dropper__destroy(skel);\n\treturn err;\n}\n\nvoid test_cgroup_v1v2(void)\n{\n\tstruct network_helper_opts opts = {};\n\tint server_fd, client_fd, cgroup_fd;\n\tstatic const int port = 60120;\n\n\t \n\tserver_fd = start_server(AF_INET, SOCK_STREAM, NULL, port, 0);\n\tif (!ASSERT_GE(server_fd, 0, \"server_fd\"))\n\t\treturn;\n\tclient_fd = connect_to_fd_opts(server_fd, &opts);\n\tif (!ASSERT_GE(client_fd, 0, \"client_fd\")) {\n\t\tclose(server_fd);\n\t\treturn;\n\t}\n\tclose(client_fd);\n\tclose(server_fd);\n\n\t \n\tcgroup_fd = test__join_cgroup(\"/connect_dropper\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"cgroup_fd\"))\n\t\treturn;\n\tserver_fd = start_server(AF_INET, SOCK_STREAM, NULL, port, 0);\n\tif (!ASSERT_GE(server_fd, 0, \"server_fd\")) {\n\t\tclose(cgroup_fd);\n\t\treturn;\n\t}\n\tASSERT_OK(run_test(cgroup_fd, server_fd, false), \"cgroup-v2-only\");\n\tsetup_classid_environment();\n\tset_classid(42);\n\tASSERT_OK(run_test(cgroup_fd, server_fd, true), \"cgroup-v1v2\");\n\tcleanup_classid_environment();\n\tclose(server_fd);\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}