{
  "module_name": "trampoline_count.c",
  "hash_id": "3178bb9b88c8697bd85c0f950a631fa1745e0012bd91f9f23d992990e73982bf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/trampoline_count.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <test_progs.h>\n\nstruct inst {\n\tstruct bpf_object *obj;\n\tstruct bpf_link   *link;\n};\n\nstatic struct bpf_program *load_prog(char *file, char *name, struct inst *inst)\n{\n\tstruct bpf_object *obj;\n\tstruct bpf_program *prog;\n\tint err;\n\n\tobj = bpf_object__open_file(file, NULL);\n\tif (!ASSERT_OK_PTR(obj, \"obj_open_file\"))\n\t\treturn NULL;\n\n\tinst->obj = obj;\n\n\terr = bpf_object__load(obj);\n\tif (!ASSERT_OK(err, \"obj_load\"))\n\t\treturn NULL;\n\n\tprog = bpf_object__find_program_by_name(obj, name);\n\tif (!ASSERT_OK_PTR(prog, \"obj_find_prog\"))\n\t\treturn NULL;\n\n\treturn prog;\n}\n\n \nvoid serial_test_trampoline_count(void)\n{\n\tchar *file = \"test_trampoline_count.bpf.o\";\n\tchar *const progs[] = { \"fentry_test\", \"fmod_ret_test\", \"fexit_test\" };\n\tint bpf_max_tramp_links, err, i, prog_fd;\n\tstruct bpf_program *prog;\n\tstruct bpf_link *link;\n\tstruct inst *inst;\n\tLIBBPF_OPTS(bpf_test_run_opts, opts);\n\n\tbpf_max_tramp_links = get_bpf_max_tramp_links();\n\tif (!ASSERT_GE(bpf_max_tramp_links, 1, \"bpf_max_tramp_links\"))\n\t\treturn;\n\tinst = calloc(bpf_max_tramp_links + 1, sizeof(*inst));\n\tif (!ASSERT_OK_PTR(inst, \"inst\"))\n\t\treturn;\n\n\t \n\tfor (i = 0; i < bpf_max_tramp_links; i++) {\n\t\tprog = load_prog(file, progs[i % ARRAY_SIZE(progs)], &inst[i]);\n\t\tif (!prog)\n\t\t\tgoto cleanup;\n\n\t\tlink = bpf_program__attach(prog);\n\t\tif (!ASSERT_OK_PTR(link, \"attach_prog\"))\n\t\t\tgoto cleanup;\n\n\t\tinst[i].link = link;\n\t}\n\n\t \n\tprog = load_prog(file, \"fmod_ret_test\", &inst[i]);\n\tif (!prog)\n\t\tgoto cleanup;\n\n\t \n\tlink = bpf_program__attach(prog);\n\tif (!ASSERT_ERR_PTR(link, \"attach_prog\")) {\n\t\tinst[i].link = link;\n\t\tgoto cleanup;\n\t}\n\n\t \n\tif (!ASSERT_EQ(libbpf_get_error(link), -E2BIG, \"E2BIG\"))\n\t\tgoto cleanup;\n\tif (!ASSERT_EQ(link, NULL, \"ptr_is_null\"))\n\t\tgoto cleanup;\n\n\t \n\tprog_fd = bpf_program__fd(prog);\n\tif (!ASSERT_GE(prog_fd, 0, \"bpf_program__fd\"))\n\t\tgoto cleanup;\n\n\terr = bpf_prog_test_run_opts(prog_fd, &opts);\n\tif (!ASSERT_OK(err, \"bpf_prog_test_run_opts\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(opts.retval & 0xffff, 33, \"bpf_modify_return_test.result\");\n\tASSERT_EQ(opts.retval >> 16, 2, \"bpf_modify_return_test.side_effect\");\n\ncleanup:\n\tfor (; i >= 0; i--) {\n\t\tbpf_link__destroy(inst[i].link);\n\t\tbpf_object__close(inst[i].obj);\n\t}\n\tfree(inst);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}