{
  "module_name": "module_fentry_shadow.c",
  "hash_id": "24cc6061b2e4cb4b1c865559f04ebd9b1d50c593c1a0cbcc48ba69e7c945ac93",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/module_fentry_shadow.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include <bpf/btf.h>\n#include \"bpf/libbpf_internal.h\"\n#include \"cgroup_helpers.h\"\n\nstatic const char *module_name = \"bpf_testmod\";\nstatic const char *symbol_name = \"bpf_fentry_shadow_test\";\n\nstatic int get_bpf_testmod_btf_fd(void)\n{\n\tstruct bpf_btf_info info;\n\tchar name[64];\n\t__u32 id = 0, len;\n\tint err, fd;\n\n\twhile (true) {\n\t\terr = bpf_btf_get_next_id(id, &id);\n\t\tif (err) {\n\t\t\tlog_err(\"failed to iterate BTF objects\");\n\t\t\treturn err;\n\t\t}\n\n\t\tfd = bpf_btf_get_fd_by_id(id);\n\t\tif (fd < 0) {\n\t\t\tif (errno == ENOENT)\n\t\t\t\tcontinue;  \n\t\t\terr = -errno;\n\t\t\tlog_err(\"failed to get FD for BTF object #%d\", id);\n\t\t\treturn err;\n\t\t}\n\n\t\tlen = sizeof(info);\n\t\tmemset(&info, 0, sizeof(info));\n\t\tinfo.name = ptr_to_u64(name);\n\t\tinfo.name_len = sizeof(name);\n\n\t\terr = bpf_obj_get_info_by_fd(fd, &info, &len);\n\t\tif (err) {\n\t\t\terr = -errno;\n\t\t\tlog_err(\"failed to get info for BTF object #%d\", id);\n\t\t\tclose(fd);\n\t\t\treturn err;\n\t\t}\n\n\t\tif (strcmp(name, module_name) == 0)\n\t\t\treturn fd;\n\n\t\tclose(fd);\n\t}\n\treturn -ENOENT;\n}\n\nvoid test_module_fentry_shadow(void)\n{\n\tstruct btf *vmlinux_btf = NULL, *mod_btf = NULL;\n\tint err, i;\n\tint btf_fd[2] = {};\n\tint prog_fd[2] = {};\n\tint link_fd[2] = {};\n\t__s32 btf_id[2] = {};\n\n\tif (!env.has_testmod) {\n\t\ttest__skip();\n\t\treturn;\n\t}\n\n\tLIBBPF_OPTS(bpf_prog_load_opts, load_opts,\n\t\t.expected_attach_type = BPF_TRACE_FENTRY,\n\t);\n\n\tconst struct bpf_insn trace_program[] = {\n\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\tBPF_EXIT_INSN(),\n\t};\n\n\tvmlinux_btf = btf__load_vmlinux_btf();\n\tif (!ASSERT_OK_PTR(vmlinux_btf, \"load_vmlinux_btf\"))\n\t\treturn;\n\n\tbtf_fd[1] = get_bpf_testmod_btf_fd();\n\tif (!ASSERT_GE(btf_fd[1], 0, \"get_bpf_testmod_btf_fd\"))\n\t\tgoto out;\n\n\tmod_btf = btf_get_from_fd(btf_fd[1], vmlinux_btf);\n\tif (!ASSERT_OK_PTR(mod_btf, \"btf_get_from_fd\"))\n\t\tgoto out;\n\n\tbtf_id[0] = btf__find_by_name_kind(vmlinux_btf, symbol_name, BTF_KIND_FUNC);\n\tif (!ASSERT_GT(btf_id[0], 0, \"btf_find_by_name\"))\n\t\tgoto out;\n\n\tbtf_id[1] = btf__find_by_name_kind(mod_btf, symbol_name, BTF_KIND_FUNC);\n\tif (!ASSERT_GT(btf_id[1], 0, \"btf_find_by_name\"))\n\t\tgoto out;\n\n\tfor (i = 0; i < 2; i++) {\n\t\tload_opts.attach_btf_id = btf_id[i];\n\t\tload_opts.attach_btf_obj_fd = btf_fd[i];\n\t\tprog_fd[i] = bpf_prog_load(BPF_PROG_TYPE_TRACING, NULL, \"GPL\",\n\t\t\t\t\t   trace_program,\n\t\t\t\t\t   sizeof(trace_program) / sizeof(struct bpf_insn),\n\t\t\t\t\t   &load_opts);\n\t\tif (!ASSERT_GE(prog_fd[i], 0, \"bpf_prog_load\"))\n\t\t\tgoto out;\n\n\t\t \n\t\tlink_fd[i] = bpf_link_create(prog_fd[i], 0, BPF_TRACE_FENTRY, NULL);\n\t\tif (!ASSERT_GE(link_fd[i], 0, \"bpf_link_create\"))\n\t\t\tgoto out;\n\t}\n\n\terr = bpf_prog_test_run_opts(prog_fd[0], NULL);\n\tASSERT_OK(err, \"running test\");\n\nout:\n\tbtf__free(vmlinux_btf);\n\tbtf__free(mod_btf);\n\tfor (i = 0; i < 2; i++) {\n\t\tif (btf_fd[i])\n\t\t\tclose(btf_fd[i]);\n\t\tif (prog_fd[i] > 0)\n\t\t\tclose(prog_fd[i]);\n\t\tif (link_fd[i] > 0)\n\t\t\tclose(link_fd[i]);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}