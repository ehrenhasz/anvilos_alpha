{
  "module_name": "cgroup_skb_sk_lookup.c",
  "hash_id": "b36b0d26aaed6682ce44a15ae57fa20c997df8ee105c74fdfa027f1d94025b65",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgroup_skb_sk_lookup.c",
  "human_readable_source": "\n\n\n#include <test_progs.h>\n\n#include \"network_helpers.h\"\n#include \"cgroup_skb_sk_lookup_kern.skel.h\"\n\nstatic void run_lookup_test(__u16 *g_serv_port, int out_sk)\n{\n\tint serv_sk = -1, in_sk = -1, serv_in_sk = -1, err;\n\tstruct sockaddr_in6 addr = {};\n\tsocklen_t addr_len = sizeof(addr);\n\t__u32 duration = 0;\n\n\tserv_sk = start_server(AF_INET6, SOCK_STREAM, NULL, 0, 0);\n\tif (CHECK(serv_sk < 0, \"start_server\", \"failed to start server\\n\"))\n\t\treturn;\n\n\terr = getsockname(serv_sk, (struct sockaddr *)&addr, &addr_len);\n\tif (CHECK(err, \"getsockname\", \"errno %d\\n\", errno))\n\t\tgoto cleanup;\n\n\t*g_serv_port = addr.sin6_port;\n\n\t \n\terr = connect_fd_to_fd(out_sk, serv_sk, 1000);\n\tif (CHECK(!err || errno != EINPROGRESS, \"connect_fd_to_fd\",\n\t\t  \"unexpected result err %d errno %d\\n\", err, errno))\n\t\tgoto cleanup;\n\n\t \n\tin_sk = connect_to_fd(serv_sk, 0);\n\tif (CHECK(in_sk < 0, \"connect_to_fd\", \"errno %d\\n\", errno))\n\t\tgoto cleanup;\n\n\tserv_in_sk = accept(serv_sk, NULL, NULL);\n\tif (CHECK(serv_in_sk < 0, \"accept\", \"errno %d\\n\", errno))\n\t\tgoto cleanup;\n\ncleanup:\n\tclose(serv_in_sk);\n\tclose(in_sk);\n\tclose(serv_sk);\n}\n\nstatic void run_cgroup_bpf_test(const char *cg_path, int out_sk)\n{\n\tstruct cgroup_skb_sk_lookup_kern *skel;\n\tstruct bpf_link *link;\n\t__u32 duration = 0;\n\tint cgfd = -1;\n\n\tskel = cgroup_skb_sk_lookup_kern__open_and_load();\n\tif (CHECK(!skel, \"skel_open_load\", \"open_load failed\\n\"))\n\t\treturn;\n\n\tcgfd = test__join_cgroup(cg_path);\n\tif (CHECK(cgfd < 0, \"cgroup_join\", \"cgroup setup failed\\n\"))\n\t\tgoto cleanup;\n\n\tlink = bpf_program__attach_cgroup(skel->progs.ingress_lookup, cgfd);\n\tif (!ASSERT_OK_PTR(link, \"cgroup_attach\"))\n\t\tgoto cleanup;\n\n\trun_lookup_test(&skel->bss->g_serv_port, out_sk);\n\n\tbpf_link__destroy(link);\n\ncleanup:\n\tclose(cgfd);\n\tcgroup_skb_sk_lookup_kern__destroy(skel);\n}\n\nvoid test_cgroup_skb_sk_lookup(void)\n{\n\tconst char *cg_path = \"/foo\";\n\tint out_sk;\n\n\t \n\tout_sk = socket(AF_INET6, SOCK_STREAM, 0);\n\tif (CHECK_FAIL(out_sk < 0))\n\t\treturn;\n\n\trun_cgroup_bpf_test(cg_path, out_sk);\n\n\tclose(out_sk);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}