{
  "module_name": "sockopt_multi.c",
  "hash_id": "b8f1a69f7f9895a588086565ff6fac1e53c355940db94fbad01aa2d0d6b8b2fd",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/sockopt_multi.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"cgroup_helpers.h\"\n\n#include \"sockopt_multi.skel.h\"\n\nstatic int run_getsockopt_test(struct sockopt_multi *obj, int cg_parent,\n\t\t\t       int cg_child, int sock_fd)\n{\n\tstruct bpf_link *link_parent = NULL;\n\tstruct bpf_link *link_child = NULL;\n\tsocklen_t optlen;\n\t__u8 buf;\n\tint err;\n\n\t \n\n\tbuf = 0x80;\n\terr = setsockopt(sock_fd, SOL_IP, IP_TOS, &buf, 1);\n\tif (err < 0) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0x80) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0x80 without BPF\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\n\t \n\n\tlink_child = bpf_program__attach_cgroup(obj->progs._getsockopt_child,\n\t\t\t\t\t\tcg_child);\n\tif (!ASSERT_OK_PTR(link_child, \"cg-attach-getsockopt_child\"))\n\t\tgoto detach;\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0x90) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0x90\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\n\t \n\n\tlink_parent = bpf_program__attach_cgroup(obj->progs._getsockopt_parent,\n\t\t\t\t\t\t cg_parent);\n\tif (!ASSERT_OK_PTR(link_parent, \"cg-attach-getsockopt_parent\"))\n\t\tgoto detach;\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0xA0) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0xA0\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\n\t \n\n\tbuf = 0x40;\n\terr = setsockopt(sock_fd, SOL_IP, IP_TOS, &buf, 1);\n\tif (err < 0) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (!err) {\n\t\tlog_err(\"Unexpected success from getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\t \n\n\tbpf_link__destroy(link_child);\n\tlink_child = NULL;\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (!err) {\n\t\tlog_err(\"Unexpected success from getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\t \n\n\tbuf = 0x90;\n\terr = setsockopt(sock_fd, SOL_IP, IP_TOS, &buf, 1);\n\tif (err < 0) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0xA0) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0xA0\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\ndetach:\n\tbpf_link__destroy(link_child);\n\tbpf_link__destroy(link_parent);\n\n\treturn err;\n}\n\nstatic int run_setsockopt_test(struct sockopt_multi *obj, int cg_parent,\n\t\t\t       int cg_child, int sock_fd)\n{\n\tstruct bpf_link *link_parent = NULL;\n\tstruct bpf_link *link_child = NULL;\n\tsocklen_t optlen;\n\t__u8 buf;\n\tint err;\n\n\t \n\n\tbuf = 0x80;\n\terr = setsockopt(sock_fd, SOL_IP, IP_TOS, &buf, 1);\n\tif (err < 0) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0x80) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0x80 without BPF\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\n\t \n\n\tlink_child = bpf_program__attach_cgroup(obj->progs._setsockopt,\n\t\t\t\t\t\tcg_child);\n\tif (!ASSERT_OK_PTR(link_child, \"cg-attach-setsockopt_child\"))\n\t\tgoto detach;\n\n\tbuf = 0x80;\n\terr = setsockopt(sock_fd, SOL_IP, IP_TOS, &buf, 1);\n\tif (err < 0) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0x80 + 0x10) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0x80 + 0x10\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\n\t \n\n\tlink_parent = bpf_program__attach_cgroup(obj->progs._setsockopt,\n\t\t\t\t\t\t cg_parent);\n\tif (!ASSERT_OK_PTR(link_parent, \"cg-attach-setsockopt_parent\"))\n\t\tgoto detach;\n\n\tbuf = 0x80;\n\terr = setsockopt(sock_fd, SOL_IP, IP_TOS, &buf, 1);\n\tif (err < 0) {\n\t\tlog_err(\"Failed to call setsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tbuf = 0x00;\n\toptlen = 1;\n\terr = getsockopt(sock_fd, SOL_IP, IP_TOS, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"Failed to call getsockopt(IP_TOS)\");\n\t\tgoto detach;\n\t}\n\n\tif (buf != 0x80 + 2 * 0x10) {\n\t\tlog_err(\"Unexpected getsockopt 0x%x != 0x80 + 2 * 0x10\", buf);\n\t\terr = -1;\n\t\tgoto detach;\n\t}\n\ndetach:\n\tbpf_link__destroy(link_child);\n\tbpf_link__destroy(link_parent);\n\n\treturn err;\n}\n\nvoid test_sockopt_multi(void)\n{\n\tint cg_parent = -1, cg_child = -1;\n\tstruct sockopt_multi *obj = NULL;\n\tint sock_fd = -1;\n\n\tcg_parent = test__join_cgroup(\"/parent\");\n\tif (!ASSERT_GE(cg_parent, 0, \"join_cgroup /parent\"))\n\t\tgoto out;\n\n\tcg_child = test__join_cgroup(\"/parent/child\");\n\tif (!ASSERT_GE(cg_child, 0, \"join_cgroup /parent/child\"))\n\t\tgoto out;\n\n\tobj = sockopt_multi__open_and_load();\n\tif (!ASSERT_OK_PTR(obj, \"skel-load\"))\n\t\tgoto out;\n\n\tobj->bss->page_size = sysconf(_SC_PAGESIZE);\n\n\tsock_fd = socket(AF_INET, SOCK_STREAM, 0);\n\tif (!ASSERT_GE(sock_fd, 0, \"socket\"))\n\t\tgoto out;\n\n\tASSERT_OK(run_getsockopt_test(obj, cg_parent, cg_child, sock_fd), \"getsockopt_test\");\n\tASSERT_OK(run_setsockopt_test(obj, cg_parent, cg_child, sock_fd), \"setsockopt_test\");\n\nout:\n\tclose(sock_fd);\n\tsockopt_multi__destroy(obj);\n\tclose(cg_child);\n\tclose(cg_parent);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}