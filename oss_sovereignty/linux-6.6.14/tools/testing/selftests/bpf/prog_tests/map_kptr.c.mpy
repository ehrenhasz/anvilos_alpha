{
  "module_name": "map_kptr.c",
  "hash_id": "1d2b0f6d5762e953efccef3fbc74b944f0171346def95596213d3496d398fb5d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/map_kptr.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include <network_helpers.h>\n\n#include \"map_kptr.skel.h\"\n#include \"map_kptr_fail.skel.h\"\n#include \"rcu_tasks_trace_gp.skel.h\"\n\nstatic void test_map_kptr_success(bool test_run)\n{\n\tLIBBPF_OPTS(bpf_test_run_opts, lopts);\n\tLIBBPF_OPTS(bpf_test_run_opts, opts,\n\t\t.data_in = &pkt_v4,\n\t\t.data_size_in = sizeof(pkt_v4),\n\t\t.repeat = 1,\n\t);\n\tint key = 0, ret, cpu;\n\tstruct map_kptr *skel;\n\tchar buf[16], *pbuf;\n\n\tskel = map_kptr__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"map_kptr__open_and_load\"))\n\t\treturn;\n\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref1), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref1 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref1 retval\");\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref2), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref2 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref2 retval\");\n\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_ls_map_kptr_ref1), &lopts);\n\tASSERT_OK(ret, \"test_ls_map_kptr_ref1 refcount\");\n\tASSERT_OK(lopts.retval, \"test_ls_map_kptr_ref1 retval\");\n\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_ls_map_kptr_ref2), &lopts);\n\tASSERT_OK(ret, \"test_ls_map_kptr_ref2 refcount\");\n\tASSERT_OK(lopts.retval, \"test_ls_map_kptr_ref2 retval\");\n\n\tif (test_run)\n\t\tgoto exit;\n\n\tcpu = libbpf_num_possible_cpus();\n\tif (!ASSERT_GT(cpu, 0, \"libbpf_num_possible_cpus\"))\n\t\tgoto exit;\n\n\tpbuf = calloc(cpu, sizeof(buf));\n\tif (!ASSERT_OK_PTR(pbuf, \"calloc(pbuf)\"))\n\t\tgoto exit;\n\n\tret = bpf_map__update_elem(skel->maps.array_map,\n\t\t\t\t   &key, sizeof(key), buf, sizeof(buf), 0);\n\tASSERT_OK(ret, \"array_map update\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__update_elem(skel->maps.pcpu_array_map,\n\t\t\t\t   &key, sizeof(key), pbuf, cpu * sizeof(buf), 0);\n\tASSERT_OK(ret, \"pcpu_array_map update\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__delete_elem(skel->maps.hash_map, &key, sizeof(key), 0);\n\tASSERT_OK(ret, \"hash_map delete\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__delete_elem(skel->maps.pcpu_hash_map, &key, sizeof(key), 0);\n\tASSERT_OK(ret, \"pcpu_hash_map delete\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__delete_elem(skel->maps.hash_malloc_map, &key, sizeof(key), 0);\n\tASSERT_OK(ret, \"hash_malloc_map delete\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__delete_elem(skel->maps.pcpu_hash_malloc_map, &key, sizeof(key), 0);\n\tASSERT_OK(ret, \"pcpu_hash_malloc_map delete\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__delete_elem(skel->maps.lru_hash_map, &key, sizeof(key), 0);\n\tASSERT_OK(ret, \"lru_hash_map delete\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_map__delete_elem(skel->maps.lru_pcpu_hash_map, &key, sizeof(key), 0);\n\tASSERT_OK(ret, \"lru_pcpu_hash_map delete\");\n\tskel->data->ref--;\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_map_kptr_ref3), &opts);\n\tASSERT_OK(ret, \"test_map_kptr_ref3 refcount\");\n\tASSERT_OK(opts.retval, \"test_map_kptr_ref3 retval\");\n\n\tret = bpf_prog_test_run_opts(bpf_program__fd(skel->progs.test_ls_map_kptr_ref_del), &lopts);\n\tASSERT_OK(ret, \"test_ls_map_kptr_ref_del delete\");\n\tskel->data->ref--;\n\tASSERT_OK(lopts.retval, \"test_ls_map_kptr_ref_del retval\");\n\n\tfree(pbuf);\nexit:\n\tmap_kptr__destroy(skel);\n}\n\nstatic int kern_sync_rcu_tasks_trace(struct rcu_tasks_trace_gp *rcu)\n{\n\tlong gp_seq = READ_ONCE(rcu->bss->gp_seq);\n\tLIBBPF_OPTS(bpf_test_run_opts, opts);\n\n\tif (!ASSERT_OK(bpf_prog_test_run_opts(bpf_program__fd(rcu->progs.do_call_rcu_tasks_trace),\n\t\t\t\t\t      &opts), \"do_call_rcu_tasks_trace\"))\n\t\treturn -EFAULT;\n\tif (!ASSERT_OK(opts.retval, \"opts.retval == 0\"))\n\t\treturn -EFAULT;\n\twhile (gp_seq == READ_ONCE(rcu->bss->gp_seq))\n\t\tsched_yield();\n\treturn 0;\n}\n\nvoid serial_test_map_kptr(void)\n{\n\tstruct rcu_tasks_trace_gp *skel;\n\n\tRUN_TESTS(map_kptr_fail);\n\n\tskel = rcu_tasks_trace_gp__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"rcu_tasks_trace_gp__open_and_load\"))\n\t\treturn;\n\tif (!ASSERT_OK(rcu_tasks_trace_gp__attach(skel), \"rcu_tasks_trace_gp__attach\"))\n\t\tgoto end;\n\n\tif (test__start_subtest(\"success-map\")) {\n\t\ttest_map_kptr_success(true);\n\n\t\tASSERT_OK(kern_sync_rcu_tasks_trace(skel), \"sync rcu_tasks_trace\");\n\t\tASSERT_OK(kern_sync_rcu(), \"sync rcu\");\n\t\t \n\t\ttest_map_kptr_success(false);\n\n\t\tASSERT_OK(kern_sync_rcu_tasks_trace(skel), \"sync rcu_tasks_trace\");\n\t\tASSERT_OK(kern_sync_rcu(), \"sync rcu\");\n\t\t \n\t\ttest_map_kptr_success(true);\n\t}\n\nend:\n\trcu_tasks_trace_gp__destroy(skel);\n\treturn;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}