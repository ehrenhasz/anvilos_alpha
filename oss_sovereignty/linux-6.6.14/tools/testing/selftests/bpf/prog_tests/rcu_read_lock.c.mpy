{
  "module_name": "rcu_read_lock.c",
  "hash_id": "79205028053f78c397573a862edb364e2f01aa73c78d726df81b63ed4fd36d2c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/rcu_read_lock.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <unistd.h>\n#include <sys/syscall.h>\n#include <sys/types.h>\n#include <test_progs.h>\n#include <bpf/btf.h>\n#include \"rcu_read_lock.skel.h\"\n#include \"cgroup_helpers.h\"\n\nstatic unsigned long long cgroup_id;\n\nstatic void test_success(void)\n{\n\tstruct rcu_read_lock *skel;\n\tint err;\n\n\tskel = rcu_read_lock__open();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\tskel->bss->target_pid = syscall(SYS_gettid);\n\n\tbpf_program__set_autoload(skel->progs.get_cgroup_id, true);\n\tbpf_program__set_autoload(skel->progs.task_succ, true);\n\tbpf_program__set_autoload(skel->progs.two_regions, true);\n\tbpf_program__set_autoload(skel->progs.non_sleepable_1, true);\n\tbpf_program__set_autoload(skel->progs.non_sleepable_2, true);\n\tbpf_program__set_autoload(skel->progs.task_trusted_non_rcuptr, true);\n\terr = rcu_read_lock__load(skel);\n\tif (!ASSERT_OK(err, \"skel_load\"))\n\t\tgoto out;\n\n\terr = rcu_read_lock__attach(skel);\n\tif (!ASSERT_OK(err, \"skel_attach\"))\n\t\tgoto out;\n\n\tsyscall(SYS_getpgid);\n\n\tASSERT_EQ(skel->bss->task_storage_val, 2, \"task_storage_val\");\n\tASSERT_EQ(skel->bss->cgroup_id, cgroup_id, \"cgroup_id\");\nout:\n\trcu_read_lock__destroy(skel);\n}\n\nstatic void test_rcuptr_acquire(void)\n{\n\tstruct rcu_read_lock *skel;\n\tint err;\n\n\tskel = rcu_read_lock__open();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\tskel->bss->target_pid = syscall(SYS_gettid);\n\n\tbpf_program__set_autoload(skel->progs.task_acquire, true);\n\terr = rcu_read_lock__load(skel);\n\tif (!ASSERT_OK(err, \"skel_load\"))\n\t\tgoto out;\n\n\terr = rcu_read_lock__attach(skel);\n\tASSERT_OK(err, \"skel_attach\");\nout:\n\trcu_read_lock__destroy(skel);\n}\n\nstatic const char * const inproper_region_tests[] = {\n\t\"miss_lock\",\n\t\"no_lock\",\n\t\"miss_unlock\",\n\t\"non_sleepable_rcu_mismatch\",\n\t\"inproper_sleepable_helper\",\n\t\"inproper_sleepable_kfunc\",\n\t\"nested_rcu_region\",\n};\n\nstatic void test_inproper_region(void)\n{\n\tstruct rcu_read_lock *skel;\n\tstruct bpf_program *prog;\n\tint i, err;\n\n\tfor (i = 0; i < ARRAY_SIZE(inproper_region_tests); i++) {\n\t\tskel = rcu_read_lock__open();\n\t\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\t\treturn;\n\n\t\tprog = bpf_object__find_program_by_name(skel->obj, inproper_region_tests[i]);\n\t\tif (!ASSERT_OK_PTR(prog, \"bpf_object__find_program_by_name\"))\n\t\t\tgoto out;\n\t\tbpf_program__set_autoload(prog, true);\n\t\terr = rcu_read_lock__load(skel);\n\t\tASSERT_ERR(err, \"skel_load\");\nout:\n\t\trcu_read_lock__destroy(skel);\n\t}\n}\n\nstatic const char * const rcuptr_misuse_tests[] = {\n\t\"task_untrusted_rcuptr\",\n\t\"cross_rcu_region\",\n};\n\nstatic void test_rcuptr_misuse(void)\n{\n\tstruct rcu_read_lock *skel;\n\tstruct bpf_program *prog;\n\tint i, err;\n\n\tfor (i = 0; i < ARRAY_SIZE(rcuptr_misuse_tests); i++) {\n\t\tskel = rcu_read_lock__open();\n\t\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\t\treturn;\n\n\t\tprog = bpf_object__find_program_by_name(skel->obj, rcuptr_misuse_tests[i]);\n\t\tif (!ASSERT_OK_PTR(prog, \"bpf_object__find_program_by_name\"))\n\t\t\tgoto out;\n\t\tbpf_program__set_autoload(prog, true);\n\t\terr = rcu_read_lock__load(skel);\n\t\tASSERT_ERR(err, \"skel_load\");\nout:\n\t\trcu_read_lock__destroy(skel);\n\t}\n}\n\nvoid test_rcu_read_lock(void)\n{\n\tint cgroup_fd;\n\n\tcgroup_fd = test__join_cgroup(\"/rcu_read_lock\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup /rcu_read_lock\"))\n\t\tgoto out;\n\n\tcgroup_id = get_cgroup_id(\"/rcu_read_lock\");\n\tif (test__start_subtest(\"success\"))\n\t\ttest_success();\n\tif (test__start_subtest(\"rcuptr_acquire\"))\n\t\ttest_rcuptr_acquire();\n\tif (test__start_subtest(\"negative_tests_inproper_region\"))\n\t\ttest_inproper_region();\n\tif (test__start_subtest(\"negative_tests_rcuptr_misuse\"))\n\t\ttest_rcuptr_misuse();\n\tclose(cgroup_fd);\nout:;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}