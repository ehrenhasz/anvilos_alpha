{
  "module_name": "global_data.c",
  "hash_id": "4f0c90a5b59647c6ed7d5babea6dbae575089fd65efff27c84e6d84ef8082618",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/global_data.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include <network_helpers.h>\n\nstatic void test_global_data_number(struct bpf_object *obj, __u32 duration)\n{\n\tint i, err, map_fd;\n\t__u64 num;\n\n\tmap_fd = bpf_find_map(__func__, obj, \"result_number\");\n\tif (CHECK_FAIL(map_fd < 0))\n\t\treturn;\n\n\tstruct {\n\t\tchar *name;\n\t\tuint32_t key;\n\t\t__u64 num;\n\t} tests[] = {\n\t\t{ \"relocate .bss reference\",     0, 0 },\n\t\t{ \"relocate .data reference\",    1, 42 },\n\t\t{ \"relocate .rodata reference\",  2, 24 },\n\t\t{ \"relocate .bss reference\",     3, 0 },\n\t\t{ \"relocate .data reference\",    4, 0xffeeff },\n\t\t{ \"relocate .rodata reference\",  5, 0xabab },\n\t\t{ \"relocate .bss reference\",     6, 1234 },\n\t\t{ \"relocate .bss reference\",     7, 0 },\n\t\t{ \"relocate .rodata reference\",  8, 0xab },\n\t\t{ \"relocate .rodata reference\",  9, 0x1111111111111111 },\n\t\t{ \"relocate .rodata reference\", 10, ~0 },\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); i++) {\n\t\terr = bpf_map_lookup_elem(map_fd, &tests[i].key, &num);\n\t\tCHECK(err || num != tests[i].num, tests[i].name,\n\t\t      \"err %d result %llx expected %llx\\n\",\n\t\t      err, num, tests[i].num);\n\t}\n}\n\nstatic void test_global_data_string(struct bpf_object *obj, __u32 duration)\n{\n\tint i, err, map_fd;\n\tchar str[32];\n\n\tmap_fd = bpf_find_map(__func__, obj, \"result_string\");\n\tif (CHECK_FAIL(map_fd < 0))\n\t\treturn;\n\n\tstruct {\n\t\tchar *name;\n\t\tuint32_t key;\n\t\tchar str[32];\n\t} tests[] = {\n\t\t{ \"relocate .rodata reference\", 0, \"abcdefghijklmnopqrstuvwxyz\" },\n\t\t{ \"relocate .data reference\",   1, \"abcdefghijklmnopqrstuvwxyz\" },\n\t\t{ \"relocate .bss reference\",    2, \"\" },\n\t\t{ \"relocate .data reference\",   3, \"abcdexghijklmnopqrstuvwxyz\" },\n\t\t{ \"relocate .bss reference\",    4, \"\\0\\0hello\" },\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); i++) {\n\t\terr = bpf_map_lookup_elem(map_fd, &tests[i].key, str);\n\t\tCHECK(err || memcmp(str, tests[i].str, sizeof(str)),\n\t\t      tests[i].name, \"err %d result \\'%s\\' expected \\'%s\\'\\n\",\n\t\t      err, str, tests[i].str);\n\t}\n}\n\nstruct foo {\n\t__u8  a;\n\t__u32 b;\n\t__u64 c;\n};\n\nstatic void test_global_data_struct(struct bpf_object *obj, __u32 duration)\n{\n\tint i, err, map_fd;\n\tstruct foo val;\n\n\tmap_fd = bpf_find_map(__func__, obj, \"result_struct\");\n\tif (CHECK_FAIL(map_fd < 0))\n\t\treturn;\n\n\tstruct {\n\t\tchar *name;\n\t\tuint32_t key;\n\t\tstruct foo val;\n\t} tests[] = {\n\t\t{ \"relocate .rodata reference\", 0, { 42, 0xfefeefef, 0x1111111111111111ULL, } },\n\t\t{ \"relocate .bss reference\",    1, { } },\n\t\t{ \"relocate .rodata reference\", 2, { } },\n\t\t{ \"relocate .data reference\",   3, { 41, 0xeeeeefef, 0x2111111111111111ULL, } },\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); i++) {\n\t\terr = bpf_map_lookup_elem(map_fd, &tests[i].key, &val);\n\t\tCHECK(err || memcmp(&val, &tests[i].val, sizeof(val)),\n\t\t      tests[i].name, \"err %d result { %u, %u, %llu } expected { %u, %u, %llu }\\n\",\n\t\t      err, val.a, val.b, val.c, tests[i].val.a, tests[i].val.b, tests[i].val.c);\n\t}\n}\n\nstatic void test_global_data_rdonly(struct bpf_object *obj, __u32 duration)\n{\n\tint err = -ENOMEM, map_fd, zero = 0;\n\tstruct bpf_map *map, *map2;\n\t__u8 *buff;\n\n\tmap = bpf_object__find_map_by_name(obj, \"test_glo.rodata\");\n\tif (!ASSERT_OK_PTR(map, \"map\"))\n\t\treturn;\n\tif (!ASSERT_TRUE(bpf_map__is_internal(map), \"is_internal\"))\n\t\treturn;\n\n\t \n\tmap2 = bpf_object__find_map_by_name(obj, \".rodata\");\n\tif (!ASSERT_EQ(map, map2, \"same_maps\"))\n\t\treturn;\n\n\tmap_fd = bpf_map__fd(map);\n\tif (CHECK_FAIL(map_fd < 0))\n\t\treturn;\n\n\tbuff = malloc(bpf_map__value_size(map));\n\tif (buff)\n\t\terr = bpf_map_update_elem(map_fd, &zero, buff, 0);\n\tfree(buff);\n\tCHECK(!err || errno != EPERM, \"test .rodata read-only map\",\n\t      \"err %d errno %d\\n\", err, errno);\n}\n\nvoid test_global_data(void)\n{\n\tconst char *file = \"./test_global_data.bpf.o\";\n\tstruct bpf_object *obj;\n\tint err, prog_fd;\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t.data_in = &pkt_v4,\n\t\t.data_size_in = sizeof(pkt_v4),\n\t\t.repeat = 1,\n\t);\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_SCHED_CLS, &obj, &prog_fd);\n\tif (!ASSERT_OK(err, \"load program\"))\n\t\treturn;\n\n\terr = bpf_prog_test_run_opts(prog_fd, &topts);\n\tASSERT_OK(err, \"pass global data run err\");\n\tASSERT_OK(topts.retval, \"pass global data run retval\");\n\n\ttest_global_data_number(obj, topts.duration);\n\ttest_global_data_string(obj, topts.duration);\n\ttest_global_data_struct(obj, topts.duration);\n\ttest_global_data_rdonly(obj, topts.duration);\n\n\tbpf_object__close(obj);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}