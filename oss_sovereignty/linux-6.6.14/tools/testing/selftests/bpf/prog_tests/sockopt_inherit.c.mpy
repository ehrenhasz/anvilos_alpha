{
  "module_name": "sockopt_inherit.c",
  "hash_id": "37e01f710fa3abd56d13cd67e59e9631ec0d08786c7fa72e7ecdb17a2e44a235",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/sockopt_inherit.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"cgroup_helpers.h\"\n\n#include \"sockopt_inherit.skel.h\"\n\n#define SOL_CUSTOM\t\t\t0xdeadbeef\n#define CUSTOM_INHERIT1\t\t\t0\n#define CUSTOM_INHERIT2\t\t\t1\n#define CUSTOM_LISTENER\t\t\t2\n\nstatic int connect_to_server(int server_fd)\n{\n\tstruct sockaddr_storage addr;\n\tsocklen_t len = sizeof(addr);\n\tint fd;\n\n\tfd = socket(AF_INET, SOCK_STREAM, 0);\n\tif (fd < 0) {\n\t\tlog_err(\"Failed to create client socket\");\n\t\treturn -1;\n\t}\n\n\tif (getsockname(server_fd, (struct sockaddr *)&addr, &len)) {\n\t\tlog_err(\"Failed to get server addr\");\n\t\tgoto out;\n\t}\n\n\tif (connect(fd, (const struct sockaddr *)&addr, len) < 0) {\n\t\tlog_err(\"Fail to connect to server\");\n\t\tgoto out;\n\t}\n\n\treturn fd;\n\nout:\n\tclose(fd);\n\treturn -1;\n}\n\nstatic int verify_sockopt(int fd, int optname, const char *msg, char expected)\n{\n\tsocklen_t optlen = 1;\n\tchar buf = 0;\n\tint err;\n\n\terr = getsockopt(fd, SOL_CUSTOM, optname, &buf, &optlen);\n\tif (err) {\n\t\tlog_err(\"%s: failed to call getsockopt\", msg);\n\t\treturn 1;\n\t}\n\n\tprintf(\"%s %d: got=0x%x ? expected=0x%x\\n\", msg, optname, buf, expected);\n\n\tif (buf != expected) {\n\t\tlog_err(\"%s: unexpected getsockopt value %d != %d\", msg,\n\t\t\tbuf, expected);\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic pthread_mutex_t server_started_mtx = PTHREAD_MUTEX_INITIALIZER;\nstatic pthread_cond_t server_started = PTHREAD_COND_INITIALIZER;\n\nstatic void *server_thread(void *arg)\n{\n\tstruct sockaddr_storage addr;\n\tsocklen_t len = sizeof(addr);\n\tint fd = *(int *)arg;\n\tint client_fd;\n\tint err = 0;\n\n\terr = listen(fd, 1);\n\n\tpthread_mutex_lock(&server_started_mtx);\n\tpthread_cond_signal(&server_started);\n\tpthread_mutex_unlock(&server_started_mtx);\n\n\tif (!ASSERT_GE(err, 0, \"listed on socket\"))\n\t\treturn NULL;\n\n\terr += verify_sockopt(fd, CUSTOM_INHERIT1, \"listen\", 1);\n\terr += verify_sockopt(fd, CUSTOM_INHERIT2, \"listen\", 1);\n\terr += verify_sockopt(fd, CUSTOM_LISTENER, \"listen\", 1);\n\n\tclient_fd = accept(fd, (struct sockaddr *)&addr, &len);\n\tif (!ASSERT_GE(client_fd, 0, \"accept client\"))\n\t\treturn NULL;\n\n\terr += verify_sockopt(client_fd, CUSTOM_INHERIT1, \"accept\", 1);\n\terr += verify_sockopt(client_fd, CUSTOM_INHERIT2, \"accept\", 1);\n\terr += verify_sockopt(client_fd, CUSTOM_LISTENER, \"accept\", 0);\n\n\tclose(client_fd);\n\n\treturn (void *)(long)err;\n}\n\nstatic int start_server(void)\n{\n\tstruct sockaddr_in addr = {\n\t\t.sin_family = AF_INET,\n\t\t.sin_addr.s_addr = htonl(INADDR_LOOPBACK),\n\t};\n\tchar buf;\n\tint err;\n\tint fd;\n\tint i;\n\n\tfd = socket(AF_INET, SOCK_STREAM, 0);\n\tif (fd < 0) {\n\t\tlog_err(\"Failed to create server socket\");\n\t\treturn -1;\n\t}\n\n\tfor (i = CUSTOM_INHERIT1; i <= CUSTOM_LISTENER; i++) {\n\t\tbuf = 0x01;\n\t\terr = setsockopt(fd, SOL_CUSTOM, i, &buf, 1);\n\t\tif (err) {\n\t\t\tlog_err(\"Failed to call setsockopt(%d)\", i);\n\t\t\tclose(fd);\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\tif (bind(fd, (const struct sockaddr *)&addr, sizeof(addr)) < 0) {\n\t\tlog_err(\"Failed to bind socket\");\n\t\tclose(fd);\n\t\treturn -1;\n\t}\n\n\treturn fd;\n}\n\nstatic void run_test(int cgroup_fd)\n{\n\tstruct bpf_link *link_getsockopt = NULL;\n\tstruct bpf_link *link_setsockopt = NULL;\n\tint server_fd = -1, client_fd;\n\tstruct sockopt_inherit *obj;\n\tvoid *server_err;\n\tpthread_t tid;\n\tint err;\n\n\tobj = sockopt_inherit__open_and_load();\n\tif (!ASSERT_OK_PTR(obj, \"skel-load\"))\n\t\treturn;\n\n\tobj->bss->page_size = sysconf(_SC_PAGESIZE);\n\n\tlink_getsockopt = bpf_program__attach_cgroup(obj->progs._getsockopt,\n\t\t\t\t\t\t     cgroup_fd);\n\tif (!ASSERT_OK_PTR(link_getsockopt, \"cg-attach-getsockopt\"))\n\t\tgoto close_bpf_object;\n\n\tlink_setsockopt = bpf_program__attach_cgroup(obj->progs._setsockopt,\n\t\t\t\t\t\t     cgroup_fd);\n\tif (!ASSERT_OK_PTR(link_setsockopt, \"cg-attach-setsockopt\"))\n\t\tgoto close_bpf_object;\n\n\tserver_fd = start_server();\n\tif (!ASSERT_GE(server_fd, 0, \"start_server\"))\n\t\tgoto close_bpf_object;\n\n\tpthread_mutex_lock(&server_started_mtx);\n\tif (!ASSERT_OK(pthread_create(&tid, NULL, server_thread,\n\t\t\t\t      (void *)&server_fd), \"pthread_create\")) {\n\t\tpthread_mutex_unlock(&server_started_mtx);\n\t\tgoto close_server_fd;\n\t}\n\tpthread_cond_wait(&server_started, &server_started_mtx);\n\tpthread_mutex_unlock(&server_started_mtx);\n\n\tclient_fd = connect_to_server(server_fd);\n\tif (!ASSERT_GE(client_fd, 0, \"connect_to_server\"))\n\t\tgoto close_server_fd;\n\n\tASSERT_OK(verify_sockopt(client_fd, CUSTOM_INHERIT1, \"connect\", 0), \"verify_sockopt1\");\n\tASSERT_OK(verify_sockopt(client_fd, CUSTOM_INHERIT2, \"connect\", 0), \"verify_sockopt2\");\n\tASSERT_OK(verify_sockopt(client_fd, CUSTOM_LISTENER, \"connect\", 0), \"verify_sockopt ener\");\n\n\tpthread_join(tid, &server_err);\n\n\terr = (int)(long)server_err;\n\tASSERT_OK(err, \"pthread_join retval\");\n\n\tclose(client_fd);\n\nclose_server_fd:\n\tclose(server_fd);\nclose_bpf_object:\n\tbpf_link__destroy(link_getsockopt);\n\tbpf_link__destroy(link_setsockopt);\n\n\tsockopt_inherit__destroy(obj);\n}\n\nvoid test_sockopt_inherit(void)\n{\n\tint cgroup_fd;\n\n\tcgroup_fd = test__join_cgroup(\"/sockopt_inherit\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup\"))\n\t\treturn;\n\n\trun_test(cgroup_fd);\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}