{
  "module_name": "xdp_attach.c",
  "hash_id": "3686e6e66b33a8dda4714e3a3816a8484f0d161d21e9239446027340798f655b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/xdp_attach.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"test_xdp_attach_fail.skel.h\"\n\n#define IFINDEX_LO 1\n#define XDP_FLAGS_REPLACE\t\t(1U << 4)\n\nstatic void test_xdp_attach(const char *file)\n{\n\t__u32 duration = 0, id1, id2, id0 = 0, len;\n\tstruct bpf_object *obj1, *obj2, *obj3;\n\tstruct bpf_prog_info info = {};\n\tint err, fd1, fd2, fd3;\n\tLIBBPF_OPTS(bpf_xdp_attach_opts, opts);\n\n\tlen = sizeof(info);\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj1, &fd1);\n\tif (CHECK_FAIL(err))\n\t\treturn;\n\terr = bpf_prog_get_info_by_fd(fd1, &info, &len);\n\tif (CHECK_FAIL(err))\n\t\tgoto out_1;\n\tid1 = info.id;\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj2, &fd2);\n\tif (CHECK_FAIL(err))\n\t\tgoto out_1;\n\n\tmemset(&info, 0, sizeof(info));\n\terr = bpf_prog_get_info_by_fd(fd2, &info, &len);\n\tif (CHECK_FAIL(err))\n\t\tgoto out_2;\n\tid2 = info.id;\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj3, &fd3);\n\tif (CHECK_FAIL(err))\n\t\tgoto out_2;\n\n\terr = bpf_xdp_attach(IFINDEX_LO, fd1, XDP_FLAGS_REPLACE, &opts);\n\tif (CHECK(err, \"load_ok\", \"initial load failed\"))\n\t\tgoto out_close;\n\n\terr = bpf_xdp_query_id(IFINDEX_LO, 0, &id0);\n\tif (CHECK(err || id0 != id1, \"id1_check\",\n\t\t  \"loaded prog id %u != id1 %u, err %d\", id0, id1, err))\n\t\tgoto out_close;\n\n\terr = bpf_xdp_attach(IFINDEX_LO, fd2, XDP_FLAGS_REPLACE, &opts);\n\tif (CHECK(!err, \"load_fail\", \"load with expected id didn't fail\"))\n\t\tgoto out;\n\n\topts.old_prog_fd = fd1;\n\terr = bpf_xdp_attach(IFINDEX_LO, fd2, 0, &opts);\n\tif (CHECK(err, \"replace_ok\", \"replace valid old_fd failed\"))\n\t\tgoto out;\n\terr = bpf_xdp_query_id(IFINDEX_LO, 0, &id0);\n\tif (CHECK(err || id0 != id2, \"id2_check\",\n\t\t  \"loaded prog id %u != id2 %u, err %d\", id0, id2, err))\n\t\tgoto out_close;\n\n\terr = bpf_xdp_attach(IFINDEX_LO, fd3, 0, &opts);\n\tif (CHECK(!err, \"replace_fail\", \"replace invalid old_fd didn't fail\"))\n\t\tgoto out;\n\n\terr = bpf_xdp_detach(IFINDEX_LO, 0, &opts);\n\tif (CHECK(!err, \"remove_fail\", \"remove invalid old_fd didn't fail\"))\n\t\tgoto out;\n\n\topts.old_prog_fd = fd2;\n\terr = bpf_xdp_detach(IFINDEX_LO, 0, &opts);\n\tif (CHECK(err, \"remove_ok\", \"remove valid old_fd failed\"))\n\t\tgoto out;\n\n\terr = bpf_xdp_query_id(IFINDEX_LO, 0, &id0);\n\tif (CHECK(err || id0 != 0, \"unload_check\",\n\t\t  \"loaded prog id %u != 0, err %d\", id0, err))\n\t\tgoto out_close;\nout:\n\tbpf_xdp_detach(IFINDEX_LO, 0, NULL);\nout_close:\n\tbpf_object__close(obj3);\nout_2:\n\tbpf_object__close(obj2);\nout_1:\n\tbpf_object__close(obj1);\n}\n\n#define ERRMSG_LEN 64\n\nstruct xdp_errmsg {\n\tchar msg[ERRMSG_LEN];\n};\n\nstatic void on_xdp_errmsg(void *ctx, int cpu, void *data, __u32 size)\n{\n\tstruct xdp_errmsg *ctx_errmg = ctx, *tp_errmsg = data;\n\n\tmemcpy(&ctx_errmg->msg, &tp_errmsg->msg, ERRMSG_LEN);\n}\n\nstatic const char tgt_errmsg[] = \"Invalid XDP flags for BPF link attachment\";\n\nstatic void test_xdp_attach_fail(const char *file)\n{\n\tstruct test_xdp_attach_fail *skel = NULL;\n\tstruct xdp_errmsg errmsg = {};\n\tstruct perf_buffer *pb = NULL;\n\tstruct bpf_object *obj = NULL;\n\tint err, fd_xdp;\n\n\tLIBBPF_OPTS(bpf_link_create_opts, opts);\n\n\tskel = test_xdp_attach_fail__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"test_xdp_attach_fail__open_and_load\"))\n\t\tgoto out_close;\n\n\terr = test_xdp_attach_fail__attach(skel);\n\tif (!ASSERT_EQ(err, 0, \"test_xdp_attach_fail__attach\"))\n\t\tgoto out_close;\n\n\t \n\tpb = perf_buffer__new(bpf_map__fd(skel->maps.xdp_errmsg_pb), 1,\n\t\t\t      on_xdp_errmsg, NULL, &errmsg, NULL);\n\tif (!ASSERT_OK_PTR(pb, \"perf_buffer__new\"))\n\t\tgoto out_close;\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_XDP, &obj, &fd_xdp);\n\tif (!ASSERT_EQ(err, 0, \"bpf_prog_test_load\"))\n\t\tgoto out_close;\n\n\topts.flags = 0xFF; \n\terr = bpf_link_create(fd_xdp, IFINDEX_LO, BPF_XDP, &opts);\n\tif (!ASSERT_EQ(err, -EINVAL, \"bpf_link_create\"))\n\t\tgoto out_close;\n\n\t \n\terr = perf_buffer__poll(pb, 100);\n\tif (!ASSERT_GT(err, -1, \"perf_buffer__poll\"))\n\t\tgoto out_close;\n\n\tASSERT_STRNEQ((const char *) errmsg.msg, tgt_errmsg,\n\t\t      42  , \"check error message\");\n\nout_close:\n\tperf_buffer__free(pb);\n\tbpf_object__close(obj);\n\ttest_xdp_attach_fail__destroy(skel);\n}\n\nvoid serial_test_xdp_attach(void)\n{\n\tif (test__start_subtest(\"xdp_attach\"))\n\t\ttest_xdp_attach(\"./test_xdp.bpf.o\");\n\tif (test__start_subtest(\"xdp_attach_dynptr\"))\n\t\ttest_xdp_attach(\"./test_xdp_dynptr.bpf.o\");\n\tif (test__start_subtest(\"xdp_attach_failed\"))\n\t\ttest_xdp_attach_fail(\"./xdp_dummy.bpf.o\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}