{
  "module_name": "test_local_storage.c",
  "hash_id": "83e5db3b938a1c451650d28b1a296f99b067c413c380c756055b1618838e1fec",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/test_local_storage.c",
  "human_readable_source": "\n\n \n\n#include <asm-generic/errno-base.h>\n#include <sys/stat.h>\n#include <test_progs.h>\n#include <linux/limits.h>\n\n#include \"local_storage.skel.h\"\n#include \"network_helpers.h\"\n#include \"task_local_storage_helpers.h\"\n\n#define TEST_STORAGE_VALUE 0xbeefdead\n\nstruct storage {\n\tvoid *inode;\n\tunsigned int value;\n};\n\n \nstatic int run_self_unlink(struct local_storage *skel, const char *rm_path)\n{\n\tint child_pid, child_status, ret;\n\tint null_fd;\n\n\tchild_pid = fork();\n\tif (child_pid == 0) {\n\t\tnull_fd = open(\"/dev/null\", O_WRONLY);\n\t\tdup2(null_fd, STDOUT_FILENO);\n\t\tdup2(null_fd, STDERR_FILENO);\n\t\tclose(null_fd);\n\n\t\tskel->bss->monitored_pid = getpid();\n\t\t \n\t\tret = execlp(rm_path, rm_path, rm_path, NULL);\n\t\tif (ret)\n\t\t\texit(errno);\n\t} else if (child_pid > 0) {\n\t\twaitpid(child_pid, &child_status, 0);\n\t\tASSERT_EQ(skel->data->task_storage_result, 0, \"task_storage_result\");\n\t\treturn WEXITSTATUS(child_status);\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic bool check_syscall_operations(int map_fd, int obj_fd)\n{\n\tstruct storage val = { .value = TEST_STORAGE_VALUE },\n\t\t       lookup_val = { .value = 0 };\n\tint err;\n\n\t \n\terr = bpf_map_lookup_elem_flags(map_fd, &obj_fd, &lookup_val, 0);\n\tif (!ASSERT_EQ(err, -ENOENT, \"bpf_map_lookup_elem\"))\n\t\treturn false;\n\n\t \n\terr = bpf_map_update_elem(map_fd, &obj_fd, &val, BPF_NOEXIST);\n\tif (!ASSERT_OK(err, \"bpf_map_update_elem\"))\n\t\treturn false;\n\n\t \n\terr = bpf_map_lookup_elem_flags(map_fd, &obj_fd, &lookup_val, 0);\n\tif (!ASSERT_OK(err, \"bpf_map_lookup_elem\"))\n\t\treturn false;\n\n\t \n\tif (!ASSERT_EQ(lookup_val.value, val.value, \"bpf_map_lookup_elem\"))\n\t\treturn false;\n\n\terr = bpf_map_delete_elem(map_fd, &obj_fd);\n\tif (!ASSERT_OK(err, \"bpf_map_delete_elem()\"))\n\t\treturn false;\n\n\t \n\terr = bpf_map_lookup_elem_flags(map_fd, &obj_fd, &lookup_val, 0);\n\tif (!ASSERT_EQ(err, -ENOENT, \"bpf_map_lookup_elem\"))\n\t\treturn false;\n\n\treturn true;\n}\n\nvoid test_test_local_storage(void)\n{\n\tchar tmp_dir_path[] = \"/tmp/local_storageXXXXXX\";\n\tint err, serv_sk = -1, task_fd = -1, rm_fd = -1;\n\tstruct local_storage *skel = NULL;\n\tchar tmp_exec_path[64];\n\tchar cmd[256];\n\n\tskel = local_storage__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_load\"))\n\t\tgoto close_prog;\n\n\terr = local_storage__attach(skel);\n\tif (!ASSERT_OK(err, \"attach\"))\n\t\tgoto close_prog;\n\n\ttask_fd = sys_pidfd_open(getpid(), 0);\n\tif (!ASSERT_GE(task_fd, 0, \"pidfd_open\"))\n\t\tgoto close_prog;\n\n\tif (!check_syscall_operations(bpf_map__fd(skel->maps.task_storage_map),\n\t\t\t\t      task_fd))\n\t\tgoto close_prog;\n\n\tif (!ASSERT_OK_PTR(mkdtemp(tmp_dir_path), \"mkdtemp\"))\n\t\tgoto close_prog;\n\n\tsnprintf(tmp_exec_path, sizeof(tmp_exec_path), \"%s/copy_of_rm\",\n\t\t tmp_dir_path);\n\tsnprintf(cmd, sizeof(cmd), \"cp /bin/rm %s\", tmp_exec_path);\n\tif (!ASSERT_OK(system(cmd), \"system(cp)\"))\n\t\tgoto close_prog_rmdir;\n\n\trm_fd = open(tmp_exec_path, O_RDONLY);\n\tif (!ASSERT_GE(rm_fd, 0, \"open(tmp_exec_path)\"))\n\t\tgoto close_prog_rmdir;\n\n\tif (!check_syscall_operations(bpf_map__fd(skel->maps.inode_storage_map),\n\t\t\t\t      rm_fd))\n\t\tgoto close_prog_rmdir;\n\n\t \n\terr = run_self_unlink(skel, tmp_exec_path);\n\tif (!ASSERT_EQ(err, EPERM, \"run_self_unlink\"))\n\t\tgoto close_prog_rmdir;\n\n\t \n\tskel->bss->monitored_pid = getpid();\n\n\t \n\tsnprintf(cmd, sizeof(cmd), \"mv %s/copy_of_rm %s/check_null_ptr\",\n\t\t tmp_dir_path, tmp_dir_path);\n\tif (!ASSERT_OK(system(cmd), \"system(mv)\"))\n\t\tgoto close_prog_rmdir;\n\n\tASSERT_EQ(skel->data->inode_storage_result, 0, \"inode_storage_result\");\n\n\tserv_sk = start_server(AF_INET6, SOCK_STREAM, NULL, 0, 0);\n\tif (!ASSERT_GE(serv_sk, 0, \"start_server\"))\n\t\tgoto close_prog_rmdir;\n\n\tASSERT_EQ(skel->data->sk_storage_result, 0, \"sk_storage_result\");\n\n\tif (!check_syscall_operations(bpf_map__fd(skel->maps.sk_storage_map),\n\t\t\t\t      serv_sk))\n\t\tgoto close_prog_rmdir;\n\nclose_prog_rmdir:\n\tsnprintf(cmd, sizeof(cmd), \"rm -rf %s\", tmp_dir_path);\n\tsystem(cmd);\nclose_prog:\n\tclose(serv_sk);\n\tclose(rm_fd);\n\tclose(task_fd);\n\tlocal_storage__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}