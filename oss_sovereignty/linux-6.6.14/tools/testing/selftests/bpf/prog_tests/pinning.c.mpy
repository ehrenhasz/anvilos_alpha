{
  "module_name": "pinning.c",
  "hash_id": "d3fd6944057cc493560fe215672d31909dbeeafb101bba4010ec4ac4c737bb96",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/pinning.c",
  "human_readable_source": "\n\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <unistd.h>\n#include <test_progs.h>\n\n__u32 get_map_id(struct bpf_object *obj, const char *name)\n{\n\tstruct bpf_map_info map_info = {};\n\t__u32 map_info_len, duration = 0;\n\tstruct bpf_map *map;\n\tint err;\n\n\tmap_info_len = sizeof(map_info);\n\n\tmap = bpf_object__find_map_by_name(obj, name);\n\tif (CHECK(!map, \"find map\", \"NULL map\"))\n\t\treturn 0;\n\n\terr = bpf_map_get_info_by_fd(bpf_map__fd(map),\n\t\t\t\t     &map_info, &map_info_len);\n\tCHECK(err, \"get map info\", \"err %d errno %d\", err, errno);\n\treturn map_info.id;\n}\n\nvoid test_pinning(void)\n{\n\tconst char *file_invalid = \"./test_pinning_invalid.bpf.o\";\n\tconst char *custpinpath = \"/sys/fs/bpf/custom/pinmap\";\n\tconst char *nopinpath = \"/sys/fs/bpf/nopinmap\";\n\tconst char *nopinpath2 = \"/sys/fs/bpf/nopinmap2\";\n\tconst char *custpath = \"/sys/fs/bpf/custom\";\n\tconst char *pinpath = \"/sys/fs/bpf/pinmap\";\n\tconst char *file = \"./test_pinning.bpf.o\";\n\t__u32 map_id, map_id2, duration = 0;\n\tstruct stat statbuf = {};\n\tstruct bpf_object *obj;\n\tstruct bpf_map *map;\n\tint err, map_fd;\n\tDECLARE_LIBBPF_OPTS(bpf_object_open_opts, opts,\n\t\t.pin_root_path = custpath,\n\t);\n\n\t \n\tobj = bpf_object__open_file(file_invalid, NULL);\n\terr = libbpf_get_error(obj);\n\tif (CHECK(err != -EINVAL, \"invalid open\", \"err %d errno %d\\n\", err, errno)) {\n\t\tobj = NULL;\n\t\tgoto out;\n\t}\n\n\t \n\tobj = bpf_object__open_file(file, NULL);\n\terr = libbpf_get_error(obj);\n\tif (CHECK(err, \"default open\", \"err %d errno %d\\n\", err, errno)) {\n\t\tobj = NULL;\n\t\tgoto out;\n\t}\n\n\terr = bpf_object__load(obj);\n\tif (CHECK(err, \"default load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(pinpath, &statbuf);\n\tif (CHECK(err, \"stat pinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(nopinpath, &statbuf);\n\tif (CHECK(!err || errno != ENOENT, \"stat nopinpath\",\n\t\t  \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(nopinpath2, &statbuf);\n\tif (CHECK(!err || errno != ENOENT, \"stat nopinpath2\",\n\t\t  \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\tmap_id = get_map_id(obj, \"pinmap\");\n\tif (!map_id)\n\t\tgoto out;\n\n\tbpf_object__close(obj);\n\n\tobj = bpf_object__open_file(file, NULL);\n\tif (CHECK_FAIL(libbpf_get_error(obj))) {\n\t\tobj = NULL;\n\t\tgoto out;\n\t}\n\n\terr = bpf_object__load(obj);\n\tif (CHECK(err, \"default load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\tmap_id2 = get_map_id(obj, \"pinmap\");\n\tif (CHECK(map_id != map_id2, \"check reuse\",\n\t\t  \"err %d errno %d id %d id2 %d\\n\", err, errno, map_id, map_id2))\n\t\tgoto out;\n\n\t \n\tmap = bpf_object__find_map_by_name(obj, \"pinmap\");\n\tif (CHECK(!map, \"find map\", \"NULL map\"))\n\t\tgoto out;\n\n\terr = bpf_map__pin(map, NULL);\n\tif (CHECK(err, \"re-pin map\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = bpf_map__pin(map, \"/sys/fs/bpf/other\");\n\tif (CHECK(!err, \"pin map different\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = bpf_object__unpin_maps(obj, NULL);\n\tif (CHECK(err, \"unpin maps\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = bpf_object__pin_maps(obj, NULL);\n\tif (CHECK(err, \"pin maps\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\tif (!ASSERT_STREQ(bpf_map__pin_path(map), pinpath, \"get pin path\"))\n\t\tgoto out;\n\n\t \n\tmap = bpf_object__find_map_by_name(obj, \"nopinmap\");\n\tif (CHECK(!map, \"find map\", \"NULL map\"))\n\t\tgoto out;\n\n\terr = bpf_map__set_pin_path(map, custpinpath);\n\tif (CHECK(err, \"set pin path\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\tif (!ASSERT_STREQ(bpf_map__pin_path(map), custpinpath,\n\t\t\t  \"get pin path after set\"))\n\t\tgoto out;\n\n\t \n\terr = bpf_object__pin_maps(obj, NULL);\n\tif (CHECK(err, \"pin maps\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(custpinpath, &statbuf);\n\tif (CHECK(err, \"stat custpinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = unlink(custpinpath);\n\tif (CHECK(err, \"unlink custpinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\terr = rmdir(custpath);\n\tif (CHECK(err, \"rmdir custpindir\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\tbpf_object__close(obj);\n\n\t \n\tobj = bpf_object__open_file(file, NULL);\n\terr = libbpf_get_error(obj);\n\tif (CHECK(err, \"default open\", \"err %d errno %d\\n\", err, errno)) {\n\t\tobj = NULL;\n\t\tgoto out;\n\t}\n\n\t \n\tbpf_object__for_each_map(map, obj) {\n\t\tif (!strcmp(bpf_map__name(map), \"nopinmap\"))\n\t\t\terr = bpf_map__set_pin_path(map, nopinpath2);\n\t\telse if (!strcmp(bpf_map__name(map), \"nopinmap2\"))\n\t\t\terr = bpf_map__set_pin_path(map, pinpath);\n\t\telse\n\t\t\tcontinue;\n\n\t\tif (CHECK(err, \"set pin path\", \"err %d errno %d\\n\", err, errno))\n\t\t\tgoto out;\n\t}\n\n\t \n\terr = bpf_object__load(obj);\n\tif (CHECK(err != -EINVAL, \"param mismatch load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(nopinpath2, &statbuf);\n\tif (CHECK(!err || errno != ENOENT, \"stat nopinpath2\",\n\t\t  \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(pinpath, &statbuf);\n\tif (CHECK(err, \"stat pinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\tbpf_object__close(obj);\n\n\t \n\tobj = bpf_object__open_file(file, &opts);\n\tif (CHECK_FAIL(libbpf_get_error(obj))) {\n\t\tobj = NULL;\n\t\tgoto out;\n\t}\n\n\terr = bpf_object__load(obj);\n\tif (CHECK(err, \"custom load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = stat(custpinpath, &statbuf);\n\tif (CHECK(err, \"stat custpinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\t \n\terr = unlink(custpinpath);\n\tif (CHECK(err, \"unlink custpinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\terr = rmdir(custpath);\n\tif (CHECK(err, \"rmdir custpindir\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto out;\n\n\tbpf_object__close(obj);\n\n\t \n\tobj = bpf_object__open_file(file, NULL);\n\terr = libbpf_get_error(obj);\n\tif (CHECK(err, \"default open\", \"err %d errno %d\\n\", err, errno)) {\n\t\tobj = NULL;\n\t\tgoto out;\n\t}\n\n\tmap_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, NULL, sizeof(__u32),\n\t\t\t\tsizeof(__u64), 1, NULL);\n\tif (CHECK(map_fd < 0, \"create pinmap manually\", \"fd %d\\n\", map_fd))\n\t\tgoto out;\n\n\tmap = bpf_object__find_map_by_name(obj, \"pinmap\");\n\tif (CHECK(!map, \"find map\", \"NULL map\"))\n\t\tgoto close_map_fd;\n\n\terr = bpf_map__reuse_fd(map, map_fd);\n\tif (CHECK(err, \"reuse pinmap fd\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto close_map_fd;\n\n\terr = bpf_map__set_pin_path(map, custpinpath);\n\tif (CHECK(err, \"set pin path\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto close_map_fd;\n\n\terr = bpf_object__load(obj);\n\tif (CHECK(err, \"custom load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto close_map_fd;\n\n\t \n\terr = stat(custpinpath, &statbuf);\n\tif (CHECK(err, \"stat custpinpath\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto close_map_fd;\n\nclose_map_fd:\n\tclose(map_fd);\nout:\n\tunlink(pinpath);\n\tunlink(nopinpath);\n\tunlink(nopinpath2);\n\tunlink(custpinpath);\n\trmdir(custpath);\n\tif (obj)\n\t\tbpf_object__close(obj);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}