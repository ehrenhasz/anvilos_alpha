{
  "module_name": "core_autosize.c",
  "hash_id": "017cdb48efa942abf5f378a386cd8552b4b75aea829408764db495b45de65a52",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/core_autosize.c",
  "human_readable_source": "\n \n\n#include <test_progs.h>\n#include <bpf/btf.h>\n\n \nstruct test_struct___real {\n\tunsigned int ptr;  \n\tunsigned int val2;\n\tunsigned long long val1;\n\tunsigned short val3;\n\tunsigned char val4;\n\tunsigned char _pad;\n};\n\n#include \"test_core_autosize.skel.h\"\n\nstatic int duration = 0;\n\nstatic struct {\n\tunsigned long long ptr_samesized;\n\tunsigned long long val1_samesized;\n\tunsigned long long val2_samesized;\n\tunsigned long long val3_samesized;\n\tunsigned long long val4_samesized;\n\tstruct test_struct___real output_samesized;\n\n\tunsigned long long ptr_downsized;\n\tunsigned long long val1_downsized;\n\tunsigned long long val2_downsized;\n\tunsigned long long val3_downsized;\n\tunsigned long long val4_downsized;\n\tstruct test_struct___real output_downsized;\n\n\tunsigned long long ptr_probed;\n\tunsigned long long val1_probed;\n\tunsigned long long val2_probed;\n\tunsigned long long val3_probed;\n\tunsigned long long val4_probed;\n\n\tunsigned long long ptr_signed;\n\tunsigned long long val1_signed;\n\tunsigned long long val2_signed;\n\tunsigned long long val3_signed;\n\tunsigned long long val4_signed;\n\tstruct test_struct___real output_signed;\n} out;\n\nvoid test_core_autosize(void)\n{\n\tchar btf_file[] = \"/tmp/core_autosize.btf.XXXXXX\";\n\tint err, fd = -1, zero = 0;\n\tint char_id, short_id, int_id, long_long_id, void_ptr_id, id;\n\tDECLARE_LIBBPF_OPTS(bpf_object_open_opts, open_opts);\n\tstruct test_core_autosize* skel = NULL;\n\tstruct bpf_program *prog;\n\tstruct bpf_map *bss_map;\n\tstruct btf *btf = NULL;\n\tsize_t written;\n\tconst void *raw_data;\n\t__u32 raw_sz;\n\tFILE *f = NULL;\n\n\tbtf = btf__new_empty();\n\tif (!ASSERT_OK_PTR(btf, \"empty_btf\"))\n\t\treturn;\n\t \n\n\t \n\tbtf__set_pointer_size(btf, 4);\n\n\tchar_id = btf__add_int(btf, \"unsigned char\", 1, 0);\n\tASSERT_EQ(char_id, 1, \"char_id\");\n\tshort_id = btf__add_int(btf, \"unsigned short\", 2, 0);\n\tASSERT_EQ(short_id, 2, \"short_id\");\n\t \n\tint_id = btf__add_int(btf, \"long unsigned int\", 4, 0);\n\tASSERT_EQ(int_id, 3, \"int_id\");\n\tlong_long_id = btf__add_int(btf, \"unsigned long long\", 8, 0);\n\tASSERT_EQ(long_long_id, 4, \"long_long_id\");\n\tvoid_ptr_id = btf__add_ptr(btf, 0);\n\tASSERT_EQ(void_ptr_id, 5, \"void_ptr_id\");\n\n\tid = btf__add_struct(btf, \"test_struct\", 20  );\n\tASSERT_EQ(id, 6, \"struct_id\");\n\terr = btf__add_field(btf, \"ptr\", void_ptr_id, 0, 0);\n\terr = err ?: btf__add_field(btf, \"val2\", int_id, 32, 0);\n\terr = err ?: btf__add_field(btf, \"val1\", long_long_id, 64, 0);\n\terr = err ?: btf__add_field(btf, \"val3\", short_id, 128, 0);\n\terr = err ?: btf__add_field(btf, \"val4\", char_id, 144, 0);\n\tASSERT_OK(err, \"struct_fields\");\n\n\tfd = mkstemp(btf_file);\n\tif (CHECK(fd < 0, \"btf_tmp\", \"failed to create file: %d\\n\", fd))\n\t\tgoto cleanup;\n\tf = fdopen(fd, \"w\");\n\tif (!ASSERT_OK_PTR(f, \"btf_fdopen\"))\n\t\tgoto cleanup;\n\n\traw_data = btf__raw_data(btf, &raw_sz);\n\tif (!ASSERT_OK_PTR(raw_data, \"raw_data\"))\n\t\tgoto cleanup;\n\twritten = fwrite(raw_data, 1, raw_sz, f);\n\tif (CHECK(written != raw_sz, \"btf_write\", \"written: %zu, errno: %d\\n\", written, errno))\n\t\tgoto cleanup;\n\tfflush(f);\n\tfclose(f);\n\tf = NULL;\n\tclose(fd);\n\tfd = -1;\n\n\t \n\topen_opts.btf_custom_path = btf_file;\n\tskel = test_core_autosize__open_opts(&open_opts);\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\tgoto cleanup;\n\n\t \n\tprog = bpf_object__find_program_by_name(skel->obj, \"handle_signed\");\n\tif (!ASSERT_OK_PTR(prog, \"prog_find\"))\n\t\tgoto cleanup;\n\tbpf_program__set_autoload(prog, false);\n\n\terr = bpf_object__load(skel->obj);\n\tif (!ASSERT_OK(err, \"prog_load\"))\n\t\tgoto cleanup;\n\n\tprog = bpf_object__find_program_by_name(skel->obj, \"handle_samesize\");\n\tif (!ASSERT_OK_PTR(prog, \"prog_find\"))\n\t\tgoto cleanup;\n\tskel->links.handle_samesize = bpf_program__attach(prog);\n\tif (!ASSERT_OK_PTR(skel->links.handle_samesize, \"prog_attach\"))\n\t\tgoto cleanup;\n\n\tprog = bpf_object__find_program_by_name(skel->obj, \"handle_downsize\");\n\tif (!ASSERT_OK_PTR(prog, \"prog_find\"))\n\t\tgoto cleanup;\n\tskel->links.handle_downsize = bpf_program__attach(prog);\n\tif (!ASSERT_OK_PTR(skel->links.handle_downsize, \"prog_attach\"))\n\t\tgoto cleanup;\n\n\tprog = bpf_object__find_program_by_name(skel->obj, \"handle_probed\");\n\tif (!ASSERT_OK_PTR(prog, \"prog_find\"))\n\t\tgoto cleanup;\n\tskel->links.handle_probed = bpf_program__attach(prog);\n\tif (!ASSERT_OK_PTR(skel->links.handle_probed, \"prog_attach\"))\n\t\tgoto cleanup;\n\n\tusleep(1);\n\n\tbss_map = bpf_object__find_map_by_name(skel->obj, \".bss\");\n\tif (!ASSERT_OK_PTR(bss_map, \"bss_map_find\"))\n\t\tgoto cleanup;\n\n\terr = bpf_map__lookup_elem(bss_map, &zero, sizeof(zero), &out, sizeof(out), 0);\n\tif (!ASSERT_OK(err, \"bss_lookup\"))\n\t\tgoto cleanup;\n\n\tASSERT_EQ(out.ptr_samesized, 0x01020304, \"ptr_samesized\");\n\tASSERT_EQ(out.val1_samesized, 0x1020304050607080, \"val1_samesized\");\n\tASSERT_EQ(out.val2_samesized, 0x0a0b0c0d, \"val2_samesized\");\n\tASSERT_EQ(out.val3_samesized, 0xfeed, \"val3_samesized\");\n\tASSERT_EQ(out.val4_samesized, 0xb9, \"val4_samesized\");\n\tASSERT_EQ(out.output_samesized.ptr, 0x01020304, \"ptr_samesized\");\n\tASSERT_EQ(out.output_samesized.val1, 0x1020304050607080, \"val1_samesized\");\n\tASSERT_EQ(out.output_samesized.val2, 0x0a0b0c0d, \"val2_samesized\");\n\tASSERT_EQ(out.output_samesized.val3, 0xfeed, \"val3_samesized\");\n\tASSERT_EQ(out.output_samesized.val4, 0xb9, \"val4_samesized\");\n\n\tASSERT_EQ(out.ptr_downsized, 0x01020304, \"ptr_downsized\");\n\tASSERT_EQ(out.val1_downsized, 0x1020304050607080, \"val1_downsized\");\n\tASSERT_EQ(out.val2_downsized, 0x0a0b0c0d, \"val2_downsized\");\n\tASSERT_EQ(out.val3_downsized, 0xfeed, \"val3_downsized\");\n\tASSERT_EQ(out.val4_downsized, 0xb9, \"val4_downsized\");\n\tASSERT_EQ(out.output_downsized.ptr, 0x01020304, \"ptr_downsized\");\n\tASSERT_EQ(out.output_downsized.val1, 0x1020304050607080, \"val1_downsized\");\n\tASSERT_EQ(out.output_downsized.val2, 0x0a0b0c0d, \"val2_downsized\");\n\tASSERT_EQ(out.output_downsized.val3, 0xfeed, \"val3_downsized\");\n\tASSERT_EQ(out.output_downsized.val4, 0xb9, \"val4_downsized\");\n\n\tASSERT_EQ(out.ptr_probed, 0x01020304, \"ptr_probed\");\n\tASSERT_EQ(out.val1_probed, 0x1020304050607080, \"val1_probed\");\n\tASSERT_EQ(out.val2_probed, 0x0a0b0c0d, \"val2_probed\");\n\tASSERT_EQ(out.val3_probed, 0xfeed, \"val3_probed\");\n\tASSERT_EQ(out.val4_probed, 0xb9, \"val4_probed\");\n\n\ttest_core_autosize__destroy(skel);\n\tskel = NULL;\n\n\t \n\topen_opts.btf_custom_path = btf_file;\n\tskel = test_core_autosize__open_opts(&open_opts);\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\tgoto cleanup;\n\n\terr = test_core_autosize__load(skel);\n\tif (!ASSERT_ERR(err, \"skel_load\"))\n\t\tgoto cleanup;\n\ncleanup:\n\tif (f)\n\t\tfclose(f);\n\tif (fd >= 0)\n\t\tclose(fd);\n\tremove(btf_file);\n\tbtf__free(btf);\n\ttest_core_autosize__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}