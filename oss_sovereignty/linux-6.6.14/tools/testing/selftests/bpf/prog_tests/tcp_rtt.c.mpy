{
  "module_name": "tcp_rtt.c",
  "hash_id": "886b26806318f95ae6f277566abd9ef10b65f7d9773ef668299ee482ce9be0e5",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/tcp_rtt.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"cgroup_helpers.h\"\n#include \"network_helpers.h\"\n#include \"tcp_rtt.skel.h\"\n\nstruct tcp_rtt_storage {\n\t__u32 invoked;\n\t__u32 dsack_dups;\n\t__u32 delivered;\n\t__u32 delivered_ce;\n\t__u32 icsk_retransmits;\n};\n\nstatic void send_byte(int fd)\n{\n\tchar b = 0x55;\n\n\tASSERT_EQ(write(fd, &b, sizeof(b)), 1, \"send single byte\");\n}\n\nstatic int wait_for_ack(int fd, int retries)\n{\n\tstruct tcp_info info;\n\tsocklen_t optlen;\n\tint i, err;\n\n\tfor (i = 0; i < retries; i++) {\n\t\toptlen = sizeof(info);\n\t\terr = getsockopt(fd, SOL_TCP, TCP_INFO, &info, &optlen);\n\t\tif (err < 0) {\n\t\t\tlog_err(\"Failed to lookup TCP stats\");\n\t\t\treturn err;\n\t\t}\n\n\t\tif (info.tcpi_unacked == 0)\n\t\t\treturn 0;\n\n\t\tusleep(10);\n\t}\n\n\tlog_err(\"Did not receive ACK\");\n\treturn -1;\n}\n\nstatic int verify_sk(int map_fd, int client_fd, const char *msg, __u32 invoked,\n\t\t     __u32 dsack_dups, __u32 delivered, __u32 delivered_ce,\n\t\t     __u32 icsk_retransmits)\n{\n\tint err = 0;\n\tstruct tcp_rtt_storage val;\n\n\tif (!ASSERT_GE(bpf_map_lookup_elem(map_fd, &client_fd, &val), 0, \"read socket storage\"))\n\t\treturn -1;\n\n\tif (val.invoked != invoked) {\n\t\tlog_err(\"%s: unexpected bpf_tcp_sock.invoked %d != %d\",\n\t\t\tmsg, val.invoked, invoked);\n\t\terr++;\n\t}\n\n\tif (val.dsack_dups != dsack_dups) {\n\t\tlog_err(\"%s: unexpected bpf_tcp_sock.dsack_dups %d != %d\",\n\t\t\tmsg, val.dsack_dups, dsack_dups);\n\t\terr++;\n\t}\n\n\tif (val.delivered != delivered) {\n\t\tlog_err(\"%s: unexpected bpf_tcp_sock.delivered %d != %d\",\n\t\t\tmsg, val.delivered, delivered);\n\t\terr++;\n\t}\n\n\tif (val.delivered_ce != delivered_ce) {\n\t\tlog_err(\"%s: unexpected bpf_tcp_sock.delivered_ce %d != %d\",\n\t\t\tmsg, val.delivered_ce, delivered_ce);\n\t\terr++;\n\t}\n\n\tif (val.icsk_retransmits != icsk_retransmits) {\n\t\tlog_err(\"%s: unexpected bpf_tcp_sock.icsk_retransmits %d != %d\",\n\t\t\tmsg, val.icsk_retransmits, icsk_retransmits);\n\t\terr++;\n\t}\n\n\treturn err;\n}\n\n\nstatic int run_test(int cgroup_fd, int server_fd)\n{\n\tstruct tcp_rtt *skel;\n\tint client_fd;\n\tint prog_fd;\n\tint map_fd;\n\tint err;\n\n\tskel = tcp_rtt__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open_load\"))\n\t\treturn -1;\n\n\tmap_fd = bpf_map__fd(skel->maps.socket_storage_map);\n\tprog_fd = bpf_program__fd(skel->progs._sockops);\n\n\terr = bpf_prog_attach(prog_fd, cgroup_fd, BPF_CGROUP_SOCK_OPS, 0);\n\tif (err) {\n\t\tlog_err(\"Failed to attach BPF program\");\n\t\tgoto close_bpf_object;\n\t}\n\n\tclient_fd = connect_to_fd(server_fd, 0);\n\tif (client_fd < 0) {\n\t\terr = -1;\n\t\tgoto close_bpf_object;\n\t}\n\n\terr += verify_sk(map_fd, client_fd, \"syn-ack\",\n\t\t\t  1,\n\t\t\t  0,\n\t\t\t  1,\n\t\t\t  0,\n\t\t\t  0);\n\n\tsend_byte(client_fd);\n\tif (wait_for_ack(client_fd, 100) < 0) {\n\t\terr = -1;\n\t\tgoto close_client_fd;\n\t}\n\n\n\terr += verify_sk(map_fd, client_fd, \"first payload byte\",\n\t\t\t  2,\n\t\t\t  0,\n\t\t\t  2,\n\t\t\t  0,\n\t\t\t  0);\n\nclose_client_fd:\n\tclose(client_fd);\n\nclose_bpf_object:\n\ttcp_rtt__destroy(skel);\n\treturn err;\n}\n\nvoid test_tcp_rtt(void)\n{\n\tint server_fd, cgroup_fd;\n\n\tcgroup_fd = test__join_cgroup(\"/tcp_rtt\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup /tcp_rtt\"))\n\t\treturn;\n\n\tserver_fd = start_server(AF_INET, SOCK_STREAM, NULL, 0, 0);\n\tif (!ASSERT_GE(server_fd, 0, \"start_server\"))\n\t\tgoto close_cgroup_fd;\n\n\tASSERT_OK(run_test(cgroup_fd, server_fd), \"run_test\");\n\n\tclose(server_fd);\n\nclose_cgroup_fd:\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}