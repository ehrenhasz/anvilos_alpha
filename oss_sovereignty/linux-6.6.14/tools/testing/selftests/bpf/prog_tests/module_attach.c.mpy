{
  "module_name": "module_attach.c",
  "hash_id": "922f6014632041cc5b9d90a94f400751b87350ef6954b54f0f46879993b9fdde",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/module_attach.c",
  "human_readable_source": "\n \n\n#include <test_progs.h>\n#include <stdbool.h>\n#include \"test_module_attach.skel.h\"\n#include \"testing_helpers.h\"\n\nstatic int duration;\n\nstatic int trigger_module_test_writable(int *val)\n{\n\tint fd, err;\n\tchar buf[65];\n\tssize_t rd;\n\n\tfd = open(BPF_TESTMOD_TEST_FILE, O_RDONLY);\n\terr = -errno;\n\tif (!ASSERT_GE(fd, 0, \"testmode_file_open\"))\n\t\treturn err;\n\n\trd = read(fd, buf, sizeof(buf) - 1);\n\terr = -errno;\n\tif (!ASSERT_GT(rd, 0, \"testmod_file_rd_val\")) {\n\t\tclose(fd);\n\t\treturn err;\n\t}\n\n\tbuf[rd] = '\\0';\n\t*val = strtol(buf, NULL, 0);\n\tclose(fd);\n\n\treturn 0;\n}\n\nvoid test_module_attach(void)\n{\n\tconst int READ_SZ = 456;\n\tconst int WRITE_SZ = 457;\n\tstruct test_module_attach* skel;\n\tstruct test_module_attach__bss *bss;\n\tstruct bpf_link *link;\n\tint err;\n\tint writable_val = 0;\n\n\tskel = test_module_attach__open();\n\tif (CHECK(!skel, \"skel_open\", \"failed to open skeleton\\n\"))\n\t\treturn;\n\n\terr = bpf_program__set_attach_target(skel->progs.handle_fentry_manual,\n\t\t\t\t\t     0, \"bpf_testmod_test_read\");\n\tASSERT_OK(err, \"set_attach_target\");\n\n\terr = test_module_attach__load(skel);\n\tif (CHECK(err, \"skel_load\", \"failed to load skeleton\\n\"))\n\t\treturn;\n\n\tbss = skel->bss;\n\n\terr = test_module_attach__attach(skel);\n\tif (CHECK(err, \"skel_attach\", \"skeleton attach failed: %d\\n\", err))\n\t\tgoto cleanup;\n\n\t \n\tASSERT_OK(trigger_module_test_read(READ_SZ), \"trigger_read\");\n\tASSERT_OK(trigger_module_test_write(WRITE_SZ), \"trigger_write\");\n\n\tASSERT_EQ(bss->raw_tp_read_sz, READ_SZ, \"raw_tp\");\n\tASSERT_EQ(bss->raw_tp_bare_write_sz, WRITE_SZ, \"raw_tp_bare\");\n\tASSERT_EQ(bss->tp_btf_read_sz, READ_SZ, \"tp_btf\");\n\tASSERT_EQ(bss->fentry_read_sz, READ_SZ, \"fentry\");\n\tASSERT_EQ(bss->fentry_manual_read_sz, READ_SZ, \"fentry_manual\");\n\tASSERT_EQ(bss->fexit_read_sz, READ_SZ, \"fexit\");\n\tASSERT_EQ(bss->fexit_ret, -EIO, \"fexit_tet\");\n\tASSERT_EQ(bss->fmod_ret_read_sz, READ_SZ, \"fmod_ret\");\n\n\tbss->raw_tp_writable_bare_early_ret = true;\n\tbss->raw_tp_writable_bare_out_val = 0xf1f2f3f4;\n\tASSERT_OK(trigger_module_test_writable(&writable_val),\n\t\t  \"trigger_writable\");\n\tASSERT_EQ(bss->raw_tp_writable_bare_in_val, 1024, \"writable_test_in\");\n\tASSERT_EQ(bss->raw_tp_writable_bare_out_val, writable_val,\n\t\t  \"writable_test_out\");\n\n\ttest_module_attach__detach(skel);\n\n\t \n\tlink = bpf_program__attach(skel->progs.handle_fentry);\n\tif (!ASSERT_OK_PTR(link, \"attach_fentry\"))\n\t\tgoto cleanup;\n\n\tASSERT_ERR(unload_bpf_testmod(false), \"unload_bpf_testmod\");\n\tbpf_link__destroy(link);\n\n\tlink = bpf_program__attach(skel->progs.handle_fexit);\n\tif (!ASSERT_OK_PTR(link, \"attach_fexit\"))\n\t\tgoto cleanup;\n\n\tASSERT_ERR(unload_bpf_testmod(false), \"unload_bpf_testmod\");\n\tbpf_link__destroy(link);\n\n\tlink = bpf_program__attach(skel->progs.kprobe_multi);\n\tif (!ASSERT_OK_PTR(link, \"attach_kprobe_multi\"))\n\t\tgoto cleanup;\n\n\tASSERT_ERR(unload_bpf_testmod(false), \"unload_bpf_testmod\");\n\tbpf_link__destroy(link);\n\ncleanup:\n\ttest_module_attach__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}