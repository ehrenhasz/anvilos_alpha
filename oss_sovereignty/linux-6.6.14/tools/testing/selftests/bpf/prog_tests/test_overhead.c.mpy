{
  "module_name": "test_overhead.c",
  "hash_id": "becb6ec67a2147d3e476a992284ea3c962a68bb5240d5b8c4304243156368d92",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/test_overhead.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n#include <sched.h>\n#include <sys/prctl.h>\n#include <test_progs.h>\n\n#define MAX_CNT 100000\n\nstatic __u64 time_get_ns(void)\n{\n\tstruct timespec ts;\n\n\tclock_gettime(CLOCK_MONOTONIC, &ts);\n\treturn ts.tv_sec * 1000000000ull + ts.tv_nsec;\n}\n\nstatic int test_task_rename(const char *prog)\n{\n\tint i, fd, duration = 0, err;\n\tchar buf[] = \"test_overhead\";\n\t__u64 start_time;\n\n\tfd = open(\"/proc/self/comm\", O_WRONLY|O_TRUNC);\n\tif (CHECK(fd < 0, \"open /proc\", \"err %d\", errno))\n\t\treturn -1;\n\tstart_time = time_get_ns();\n\tfor (i = 0; i < MAX_CNT; i++) {\n\t\terr = write(fd, buf, sizeof(buf));\n\t\tif (err < 0) {\n\t\t\tCHECK(err < 0, \"task rename\", \"err %d\", errno);\n\t\t\tclose(fd);\n\t\t\treturn -1;\n\t\t}\n\t}\n\tprintf(\"task_rename %s\\t%lluK events per sec\\n\", prog,\n\t       MAX_CNT * 1000000ll / (time_get_ns() - start_time));\n\tclose(fd);\n\treturn 0;\n}\n\nstatic void test_run(const char *prog)\n{\n\ttest_task_rename(prog);\n}\n\nstatic void setaffinity(void)\n{\n\tcpu_set_t cpuset;\n\tint cpu = 0;\n\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(cpu, &cpuset);\n\tsched_setaffinity(0, sizeof(cpuset), &cpuset);\n}\n\nvoid test_test_overhead(void)\n{\n\tconst char *kprobe_name = \"prog1\";\n\tconst char *kretprobe_name = \"prog2\";\n\tconst char *raw_tp_name = \"prog3\";\n\tconst char *fentry_name = \"prog4\";\n\tconst char *fexit_name = \"prog5\";\n\tconst char *kprobe_func = \"__set_task_comm\";\n\tstruct bpf_program *kprobe_prog, *kretprobe_prog, *raw_tp_prog;\n\tstruct bpf_program *fentry_prog, *fexit_prog;\n\tstruct bpf_object *obj;\n\tstruct bpf_link *link;\n\tint err, duration = 0;\n\tchar comm[16] = {};\n\n\tif (CHECK_FAIL(prctl(PR_GET_NAME, comm, 0L, 0L, 0L)))\n\t\treturn;\n\n\tobj = bpf_object__open_file(\"./test_overhead.bpf.o\", NULL);\n\tif (!ASSERT_OK_PTR(obj, \"obj_open_file\"))\n\t\treturn;\n\n\tkprobe_prog = bpf_object__find_program_by_name(obj, kprobe_name);\n\tif (CHECK(!kprobe_prog, \"find_probe\",\n\t\t  \"prog '%s' not found\\n\", kprobe_name))\n\t\tgoto cleanup;\n\tkretprobe_prog = bpf_object__find_program_by_name(obj, kretprobe_name);\n\tif (CHECK(!kretprobe_prog, \"find_probe\",\n\t\t  \"prog '%s' not found\\n\", kretprobe_name))\n\t\tgoto cleanup;\n\traw_tp_prog = bpf_object__find_program_by_name(obj, raw_tp_name);\n\tif (CHECK(!raw_tp_prog, \"find_probe\",\n\t\t  \"prog '%s' not found\\n\", raw_tp_name))\n\t\tgoto cleanup;\n\tfentry_prog = bpf_object__find_program_by_name(obj, fentry_name);\n\tif (CHECK(!fentry_prog, \"find_probe\",\n\t\t  \"prog '%s' not found\\n\", fentry_name))\n\t\tgoto cleanup;\n\tfexit_prog = bpf_object__find_program_by_name(obj, fexit_name);\n\tif (CHECK(!fexit_prog, \"find_probe\",\n\t\t  \"prog '%s' not found\\n\", fexit_name))\n\t\tgoto cleanup;\n\terr = bpf_object__load(obj);\n\tif (CHECK(err, \"obj_load\", \"err %d\\n\", err))\n\t\tgoto cleanup;\n\n\tsetaffinity();\n\n\t \n\ttest_run(\"base\");\n\n\t \n\tlink = bpf_program__attach_kprobe(kprobe_prog, false  ,\n\t\t\t\t\t  kprobe_func);\n\tif (!ASSERT_OK_PTR(link, \"attach_kprobe\"))\n\t\tgoto cleanup;\n\ttest_run(\"kprobe\");\n\tbpf_link__destroy(link);\n\n\t \n\tlink = bpf_program__attach_kprobe(kretprobe_prog, true  ,\n\t\t\t\t\t  kprobe_func);\n\tif (!ASSERT_OK_PTR(link, \"attach_kretprobe\"))\n\t\tgoto cleanup;\n\ttest_run(\"kretprobe\");\n\tbpf_link__destroy(link);\n\n\t \n\tlink = bpf_program__attach_raw_tracepoint(raw_tp_prog, \"task_rename\");\n\tif (!ASSERT_OK_PTR(link, \"attach_raw_tp\"))\n\t\tgoto cleanup;\n\ttest_run(\"raw_tp\");\n\tbpf_link__destroy(link);\n\n\t \n\tlink = bpf_program__attach_trace(fentry_prog);\n\tif (!ASSERT_OK_PTR(link, \"attach_fentry\"))\n\t\tgoto cleanup;\n\ttest_run(\"fentry\");\n\tbpf_link__destroy(link);\n\n\t \n\tlink = bpf_program__attach_trace(fexit_prog);\n\tif (!ASSERT_OK_PTR(link, \"attach_fexit\"))\n\t\tgoto cleanup;\n\ttest_run(\"fexit\");\n\tbpf_link__destroy(link);\n\ncleanup:\n\tprctl(PR_SET_NAME, comm, 0L, 0L, 0L);\n\tbpf_object__close(obj);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}