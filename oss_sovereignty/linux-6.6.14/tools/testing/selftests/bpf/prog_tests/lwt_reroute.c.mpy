{
  "module_name": "lwt_reroute.c",
  "hash_id": "08638f43939cf1037be4b8c7824a53c71221d199210818a70b444bc285469e37",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/lwt_reroute.c",
  "human_readable_source": "\n\n \n#include \"lwt_helpers.h\"\n#include \"network_helpers.h\"\n#include <linux/net_tstamp.h>\n\n#define BPF_OBJECT            \"test_lwt_reroute.bpf.o\"\n#define LOCAL_SRC             \"10.0.0.1\"\n#define TEST_CIDR             \"10.0.0.0/24\"\n#define XMIT_HOOK             \"xmit\"\n#define XMIT_SECTION          \"lwt_xmit\"\n#define NSEC_PER_SEC          1000000000ULL\n\n \nstatic void ping_once(const char *ip)\n{\n\t \n\tSYS_NOFAIL(\"ping %s -c1 -W1 -s %d >/dev/null 2>&1\",\n\t\t   ip, ICMP_PAYLOAD_SIZE);\n}\n\n \nstatic int overflow_fq(int snd_target, const char *target_ip)\n{\n\tstruct sockaddr_in addr = {\n\t\t.sin_family = AF_INET,\n\t\t.sin_port = htons(1234),\n\t};\n\n\tchar data_buf[8];  \n\tchar control_buf[CMSG_SPACE(sizeof(uint64_t))];\n\tstruct iovec iov = {\n\t\t.iov_base = data_buf,\n\t\t.iov_len = sizeof(data_buf),\n\t};\n\tint err = -1;\n\tint s = -1;\n\tstruct sock_txtime txtime_on = {\n\t\t.clockid = CLOCK_MONOTONIC,\n\t\t.flags = 0,\n\t};\n\tstruct msghdr msg = {\n\t\t.msg_name = &addr,\n\t\t.msg_namelen = sizeof(addr),\n\t\t.msg_control = control_buf,\n\t\t.msg_controllen = sizeof(control_buf),\n\t\t.msg_iovlen = 1,\n\t\t.msg_iov = &iov,\n\t};\n\tstruct cmsghdr *cmsg = CMSG_FIRSTHDR(&msg);\n\n\tmemset(data_buf, 0, sizeof(data_buf));\n\n\ts = socket(AF_INET, SOCK_DGRAM, 0);\n\tif (!ASSERT_GE(s, 0, \"socket\"))\n\t\tgoto out;\n\n\terr = setsockopt(s, SOL_SOCKET, SO_TXTIME, &txtime_on, sizeof(txtime_on));\n\tif (!ASSERT_OK(err, \"setsockopt(SO_TXTIME)\"))\n\t\tgoto out;\n\n\terr = inet_pton(AF_INET, target_ip, &addr.sin_addr);\n\tif (!ASSERT_EQ(err, 1, \"inet_pton\"))\n\t\tgoto out;\n\n\twhile (snd_target > 0) {\n\t\tstruct timespec now;\n\n\t\tmemset(control_buf, 0, sizeof(control_buf));\n\t\tcmsg->cmsg_type = SCM_TXTIME;\n\t\tcmsg->cmsg_level = SOL_SOCKET;\n\t\tcmsg->cmsg_len = CMSG_LEN(sizeof(uint64_t));\n\n\t\terr = clock_gettime(CLOCK_MONOTONIC, &now);\n\t\tif (!ASSERT_OK(err, \"clock_gettime(CLOCK_MONOTONIC)\")) {\n\t\t\terr = -1;\n\t\t\tgoto out;\n\t\t}\n\n\t\t*(uint64_t *)CMSG_DATA(cmsg) = (now.tv_nsec + 1) * NSEC_PER_SEC +\n\t\t\t\t\t       now.tv_nsec;\n\n\t\t \n\t\tsendmsg(s, &msg, MSG_NOSIGNAL);\n\t\tsnd_target--;\n\t}\n\n\t \n\terr = 0;\n\nout:\n\tif (s >= 0)\n\t\tclose(s);\n\n\treturn err;\n}\n\nstatic int setup(const char *tun_dev)\n{\n\tint target_index = -1;\n\tint tap_fd = -1;\n\n\ttap_fd = open_tuntap(tun_dev, false);\n\tif (!ASSERT_GE(tap_fd, 0, \"open_tun\"))\n\t\treturn -1;\n\n\ttarget_index = if_nametoindex(tun_dev);\n\tif (!ASSERT_GE(target_index, 0, \"if_nametoindex\"))\n\t\treturn -1;\n\n\tSYS(fail, \"ip link add link_err type dummy\");\n\tSYS(fail, \"ip link set lo up\");\n\tSYS(fail, \"ip addr add dev lo \" LOCAL_SRC \"/32\");\n\tSYS(fail, \"ip link set link_err up\");\n\tSYS(fail, \"ip link set %s up\", tun_dev);\n\n\tSYS(fail, \"ip route add %s dev link_err encap bpf xmit obj %s sec lwt_xmit\",\n\t    TEST_CIDR, BPF_OBJECT);\n\n\tSYS(fail, \"ip rule add pref 100 from all fwmark %d lookup 100\",\n\t    target_index);\n\tSYS(fail, \"ip route add t 100 default dev %s\", tun_dev);\n\n\treturn tap_fd;\n\nfail:\n\tif (tap_fd >= 0)\n\t\tclose(tap_fd);\n\treturn -1;\n}\n\nstatic void test_lwt_reroute_normal_xmit(void)\n{\n\tconst char *tun_dev = \"tun0\";\n\tint tun_fd = -1;\n\tint ifindex = -1;\n\tchar ip[256];\n\tstruct timeval timeo = {\n\t\t.tv_sec = 0,\n\t\t.tv_usec = 250000,\n\t};\n\n\ttun_fd = setup(tun_dev);\n\tif (!ASSERT_GE(tun_fd, 0, \"setup_reroute\"))\n\t\treturn;\n\n\tifindex = if_nametoindex(tun_dev);\n\tif (!ASSERT_GE(ifindex, 0, \"if_nametoindex\"))\n\t\treturn;\n\n\tsnprintf(ip, 256, \"10.0.0.%d\", ifindex);\n\n\t \n\tping_once(ip);\n\n\tif (!ASSERT_EQ(wait_for_packet(tun_fd, __expect_icmp_ipv4, &timeo), 1,\n\t\t       \"wait_for_packet\"))\n\t\tlog_err(\"%s xmit\", __func__);\n}\n\n \nstatic void test_lwt_reroute_qdisc_dropped(void)\n{\n\tconst char *tun_dev = \"tun0\";\n\tint tun_fd = -1;\n\tint ifindex = -1;\n\tchar ip[256];\n\n\ttun_fd = setup(tun_dev);\n\tif (!ASSERT_GE(tun_fd, 0, \"setup_reroute\"))\n\t\tgoto fail;\n\n\tSYS(fail, \"tc qdisc replace dev %s root fq limit 5 flow_limit 5\", tun_dev);\n\n\tifindex = if_nametoindex(tun_dev);\n\tif (!ASSERT_GE(ifindex, 0, \"if_nametoindex\"))\n\t\treturn;\n\n\tsnprintf(ip, 256, \"10.0.0.%d\", ifindex);\n\tASSERT_EQ(overflow_fq(10, ip), 0, \"overflow_fq\");\n\nfail:\n\tif (tun_fd >= 0)\n\t\tclose(tun_fd);\n}\n\nstatic void *test_lwt_reroute_run(void *arg)\n{\n\tnetns_delete();\n\tRUN_TEST(lwt_reroute_normal_xmit);\n\tRUN_TEST(lwt_reroute_qdisc_dropped);\n\treturn NULL;\n}\n\nvoid test_lwt_reroute(void)\n{\n\tpthread_t test_thread;\n\tint err;\n\n\t \n\terr = pthread_create(&test_thread, NULL, &test_lwt_reroute_run, NULL);\n\tif (ASSERT_OK(err, \"pthread_create\"))\n\t\tASSERT_OK(pthread_join(test_thread, NULL), \"pthread_join\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}