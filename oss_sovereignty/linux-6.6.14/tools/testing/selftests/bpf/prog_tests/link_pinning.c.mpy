{
  "module_name": "link_pinning.c",
  "hash_id": "83a7e8fb57a5dbadef7e3c41d8c725d572d1bf13402e9d2c7bac7083f8678d76",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/link_pinning.c",
  "human_readable_source": "\n \n\n#include <test_progs.h>\n#include <sys/stat.h>\n\n#include \"test_link_pinning.skel.h\"\n\nstatic int duration = 0;\n\nvoid test_link_pinning_subtest(struct bpf_program *prog,\n\t\t\t       struct test_link_pinning__bss *bss)\n{\n\tconst char *link_pin_path = \"/sys/fs/bpf/pinned_link_test\";\n\tstruct stat statbuf = {};\n\tstruct bpf_link *link;\n\tint err, i;\n\n\tlink = bpf_program__attach(prog);\n\tif (!ASSERT_OK_PTR(link, \"link_attach\"))\n\t\tgoto cleanup;\n\n\tbss->in = 1;\n\tusleep(1);\n\tCHECK(bss->out != 1, \"res_check1\", \"exp %d, got %d\\n\", 1, bss->out);\n\n\t \n\terr = bpf_link__pin(link, link_pin_path);\n\tif (CHECK(err, \"link_pin\", \"err: %d\\n\", err))\n\t\tgoto cleanup;\n\n\tCHECK(strcmp(link_pin_path, bpf_link__pin_path(link)), \"pin_path1\",\n\t      \"exp %s, got %s\\n\", link_pin_path, bpf_link__pin_path(link));\n\n\t \n\terr = stat(link_pin_path, &statbuf);\n\tif (CHECK(err, \"stat_link\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto cleanup;\n\n\tbss->in = 2;\n\tusleep(1);\n\tCHECK(bss->out != 2, \"res_check2\", \"exp %d, got %d\\n\", 2, bss->out);\n\n\t \n\tbpf_link__destroy(link);\n\tlink = NULL;\n\n\tbss->in = 3;\n\tusleep(1);\n\tCHECK(bss->out != 3, \"res_check3\", \"exp %d, got %d\\n\", 3, bss->out);\n\n\t \n\tlink = bpf_link__open(link_pin_path);\n\tif (!ASSERT_OK_PTR(link, \"link_open\"))\n\t\tgoto cleanup;\n\n\tCHECK(strcmp(link_pin_path, bpf_link__pin_path(link)), \"pin_path2\",\n\t      \"exp %s, got %s\\n\", link_pin_path, bpf_link__pin_path(link));\n\n\t \n\terr = bpf_link__unpin(link);\n\tif (CHECK(err, \"link_unpin\", \"err: %d\\n\", err))\n\t\tgoto cleanup;\n\n\t \n\tbss->in = 4;\n\tusleep(1);\n\tCHECK(bss->out != 4, \"res_check4\", \"exp %d, got %d\\n\", 4, bss->out);\n\n\tbpf_link__destroy(link);\n\tlink = NULL;\n\n\t \n\tfor (i = 5; i < 10000; i++) {\n\t\tbss->in = i;\n\t\tusleep(1);\n\t\tif (bss->out == i - 1)\n\t\t\tbreak;\n\t}\n\tCHECK(i == 10000, \"link_attached\", \"got to iteration #%d\\n\", i);\n\ncleanup:\n\tbpf_link__destroy(link);\n}\n\nvoid test_link_pinning(void)\n{\n\tstruct test_link_pinning* skel;\n\n\tskel = test_link_pinning__open_and_load();\n\tif (CHECK(!skel, \"skel_open\", \"failed to open skeleton\\n\"))\n\t\treturn;\n\n\tif (test__start_subtest(\"pin_raw_tp\"))\n\t\ttest_link_pinning_subtest(skel->progs.raw_tp_prog, skel->bss);\n\tif (test__start_subtest(\"pin_tp_btf\"))\n\t\ttest_link_pinning_subtest(skel->progs.tp_btf_prog, skel->bss);\n\n\ttest_link_pinning__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}