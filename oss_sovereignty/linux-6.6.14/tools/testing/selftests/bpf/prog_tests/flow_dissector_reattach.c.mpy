{
  "module_name": "flow_dissector_reattach.c",
  "hash_id": "f821dc36f2d84070e51f57e410e08d9ad12911c88392140f03a57a20d1d706fa",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/flow_dissector_reattach.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <sched.h>\n#include <stdbool.h>\n#include <sys/stat.h>\n#include <unistd.h>\n\n#include <linux/bpf.h>\n#include <bpf/bpf.h>\n\n#include \"test_progs.h\"\n\nstatic int init_net = -1;\n\nstatic __u32 query_attached_prog_id(int netns)\n{\n\t__u32 prog_ids[1] = {};\n\t__u32 prog_cnt = ARRAY_SIZE(prog_ids);\n\tint err;\n\n\terr = bpf_prog_query(netns, BPF_FLOW_DISSECTOR, 0, NULL,\n\t\t\t     prog_ids, &prog_cnt);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_prog_query\");\n\t\treturn 0;\n\t}\n\n\treturn prog_cnt == 1 ? prog_ids[0] : 0;\n}\n\nstatic bool prog_is_attached(int netns)\n{\n\treturn query_attached_prog_id(netns) > 0;\n}\n\nstatic int load_prog(enum bpf_prog_type type)\n{\n\tstruct bpf_insn prog[] = {\n\t\tBPF_MOV64_IMM(BPF_REG_0, BPF_OK),\n\t\tBPF_EXIT_INSN(),\n\t};\n\tint fd;\n\n\tfd = bpf_test_load_program(type, prog, ARRAY_SIZE(prog), \"GPL\", 0, NULL, 0);\n\tif (CHECK_FAIL(fd < 0))\n\t\tperror(\"bpf_test_load_program\");\n\n\treturn fd;\n}\n\nstatic __u32 query_prog_id(int prog)\n{\n\tstruct bpf_prog_info info = {};\n\t__u32 info_len = sizeof(info);\n\tint err;\n\n\terr = bpf_prog_get_info_by_fd(prog, &info, &info_len);\n\tif (CHECK_FAIL(err || info_len != sizeof(info))) {\n\t\tperror(\"bpf_prog_get_info_by_fd\");\n\t\treturn 0;\n\t}\n\n\treturn info.id;\n}\n\nstatic int unshare_net(int old_net)\n{\n\tint err, new_net;\n\n\terr = unshare(CLONE_NEWNET);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"unshare(CLONE_NEWNET)\");\n\t\treturn -1;\n\t}\n\tnew_net = open(\"/proc/self/ns/net\", O_RDONLY);\n\tif (CHECK_FAIL(new_net < 0)) {\n\t\tperror(\"open(/proc/self/ns/net)\");\n\t\tsetns(old_net, CLONE_NEWNET);\n\t\treturn -1;\n\t}\n\treturn new_net;\n}\n\nstatic void test_prog_attach_prog_attach(int netns, int prog1, int prog2)\n{\n\tint err;\n\n\terr = bpf_prog_attach(prog1, 0, BPF_FLOW_DISSECTOR, 0);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_prog_attach(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terr = bpf_prog_attach(prog2, 0, BPF_FLOW_DISSECTOR, 0);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_prog_attach(prog2) #1\");\n\t\tgoto out_detach;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog2));\n\n\t \n\terr = bpf_prog_attach(prog2, 0, BPF_FLOW_DISSECTOR, 0);\n\tif (CHECK_FAIL(!err || errno != EINVAL))\n\t\tperror(\"bpf_prog_attach(prog2) #2\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog2));\n\nout_detach:\n\terr = bpf_prog_detach2(prog2, 0, BPF_FLOW_DISSECTOR);\n\tif (CHECK_FAIL(err))\n\t\tperror(\"bpf_prog_detach\");\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_create_link_create(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, opts);\n\tint link1, link2;\n\n\tlink1 = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tlink2 = bpf_link_create(prog2, netns, BPF_FLOW_DISSECTOR, &opts);\n\tif (CHECK_FAIL(link2 >= 0 || errno != E2BIG))\n\t\tperror(\"bpf_prog_attach(prog2) expected E2BIG\");\n\tif (link2 >= 0)\n\t\tclose(link2);\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(link1);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_prog_attach_link_create(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, opts);\n\tint err, link;\n\n\terr = bpf_prog_attach(prog1, 0, BPF_FLOW_DISSECTOR, 0);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_prog_attach(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tlink = bpf_link_create(prog2, netns, BPF_FLOW_DISSECTOR, &opts);\n\tif (CHECK_FAIL(link >= 0 || errno != EEXIST))\n\t\tperror(\"bpf_link_create(prog2) expected EEXIST\");\n\tif (link >= 0)\n\t\tclose(link);\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\terr = bpf_prog_detach2(prog1, 0, BPF_FLOW_DISSECTOR);\n\tif (CHECK_FAIL(err))\n\t\tperror(\"bpf_prog_detach\");\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_create_prog_attach(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, opts);\n\tint err, link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\terr = bpf_prog_attach(prog2, 0, BPF_FLOW_DISSECTOR, 0);\n\tif (CHECK_FAIL(!err || errno != EEXIST))\n\t\tperror(\"bpf_prog_attach(prog2) expected EEXIST\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_create_prog_detach(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, opts);\n\tint err, link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\terr = bpf_prog_detach2(prog1, 0, BPF_FLOW_DISSECTOR);\n\tif (CHECK_FAIL(!err || errno != EINVAL))\n\t\tperror(\"bpf_prog_detach expected EINVAL\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_prog_attach_detach_query(int netns, int prog1, int prog2)\n{\n\tint err;\n\n\terr = bpf_prog_attach(prog1, 0, BPF_FLOW_DISSECTOR, 0);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_prog_attach(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\terr = bpf_prog_detach2(prog1, 0, BPF_FLOW_DISSECTOR);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_prog_detach\");\n\t\treturn;\n\t}\n\n\t \n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_create_close_query(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, opts);\n\tint link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(link);\n\t \n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_update_no_old_prog(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint err, link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(err))\n\t\tperror(\"bpf_link_update\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog2));\n\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_update_replace_old_prog(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint err, link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\tupdate_opts.flags = BPF_F_REPLACE;\n\tupdate_opts.old_prog_fd = prog1;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(err))\n\t\tperror(\"bpf_link_update\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog2));\n\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_update_same_prog(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint err, link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, prog1, &update_opts);\n\tif (CHECK_FAIL(err))\n\t\tperror(\"bpf_link_update\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_update_invalid_opts(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint err, link;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = prog1;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(!err || errno != EINVAL)) {\n\t\tperror(\"bpf_link_update expected EINVAL\");\n\t\tgoto out_close;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = BPF_F_REPLACE;\n\tupdate_opts.old_prog_fd = prog2;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(!err || errno != EPERM)) {\n\t\tperror(\"bpf_link_update expected EPERM\");\n\t\tgoto out_close;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = BPF_F_REPLACE;\n\tupdate_opts.old_prog_fd = -1;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(!err || errno != EBADF)) {\n\t\tperror(\"bpf_link_update expected EBADF\");\n\t\tgoto out_close;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = BPF_F_ALLOW_MULTI;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(!err || errno != EINVAL))\n\t\tperror(\"bpf_link_update expected EINVAL\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\nout_close:\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_update_invalid_prog(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint err, link, prog3;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, -1, &update_opts);\n\tif (CHECK_FAIL(!err || errno != EBADF)) {\n\t\tperror(\"bpf_link_update expected EINVAL\");\n\t\tgoto out_close_link;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tprog3 = load_prog(BPF_PROG_TYPE_SOCKET_FILTER);\n\tif (prog3 < 0)\n\t\tgoto out_close_link;\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, prog3, &update_opts);\n\tif (CHECK_FAIL(!err || errno != EINVAL))\n\t\tperror(\"bpf_link_update expected EINVAL\");\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(prog3);\nout_close_link:\n\tclose(link);\n\tCHECK_FAIL(prog_is_attached(netns));\n}\n\nstatic void test_link_update_netns_gone(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint err, link, old_net;\n\n\told_net = netns;\n\tnetns = unshare_net(old_net);\n\tif (netns < 0)\n\t\treturn;\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\treturn;\n\t}\n\tCHECK_FAIL(query_attached_prog_id(netns) != query_prog_id(prog1));\n\n\tclose(netns);\n\terr = setns(old_net, CLONE_NEWNET);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"setns(CLONE_NEWNET)\");\n\t\tclose(link);\n\t\treturn;\n\t}\n\n\t \n\terrno = 0;\n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(!err || errno != ENOLINK))\n\t\tperror(\"bpf_link_update\");\n\n\tclose(link);\n}\n\nstatic void test_link_get_info(int netns, int prog1, int prog2)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_link_create_opts, create_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tstruct bpf_link_info info = {};\n\tstruct stat netns_stat = {};\n\t__u32 info_len, link_id;\n\tint err, link, old_net;\n\n\told_net = netns;\n\tnetns = unshare_net(old_net);\n\tif (netns < 0)\n\t\treturn;\n\n\terr = fstat(netns, &netns_stat);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"stat(netns)\");\n\t\tgoto out_resetns;\n\t}\n\n\tlink = bpf_link_create(prog1, netns, BPF_FLOW_DISSECTOR, &create_opts);\n\tif (CHECK_FAIL(link < 0)) {\n\t\tperror(\"bpf_link_create(prog1)\");\n\t\tgoto out_resetns;\n\t}\n\n\tinfo_len = sizeof(info);\n\terr = bpf_link_get_info_by_fd(link, &info, &info_len);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_obj_get_info\");\n\t\tgoto out_unlink;\n\t}\n\tCHECK_FAIL(info_len != sizeof(info));\n\n\t \n\tCHECK_FAIL(info.type != BPF_LINK_TYPE_NETNS);\n\tCHECK_FAIL(info.id == 0);\n\tCHECK_FAIL(info.prog_id != query_prog_id(prog1));\n\tCHECK_FAIL(info.netns.netns_ino != netns_stat.st_ino);\n\tCHECK_FAIL(info.netns.attach_type != BPF_FLOW_DISSECTOR);\n\n\tupdate_opts.flags = 0;\n\tupdate_opts.old_prog_fd = 0;\n\terr = bpf_link_update(link, prog2, &update_opts);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_link_update(prog2)\");\n\t\tgoto out_unlink;\n\t}\n\n\tlink_id = info.id;\n\tinfo_len = sizeof(info);\n\terr = bpf_link_get_info_by_fd(link, &info, &info_len);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_obj_get_info\");\n\t\tgoto out_unlink;\n\t}\n\tCHECK_FAIL(info_len != sizeof(info));\n\n\t \n\tCHECK_FAIL(info.type != BPF_LINK_TYPE_NETNS);\n\tCHECK_FAIL(info.id != link_id);\n\tCHECK_FAIL(info.prog_id != query_prog_id(prog2));\n\tCHECK_FAIL(info.netns.netns_ino != netns_stat.st_ino);\n\tCHECK_FAIL(info.netns.attach_type != BPF_FLOW_DISSECTOR);\n\n\t \n\terr = setns(old_net, CLONE_NEWNET);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"setns(NEWNET)\");\n\t\tgoto out_unlink;\n\t}\n\tclose(netns);\n\told_net = -1;\n\tnetns = -1;\n\n\tinfo_len = sizeof(info);\n\terr = bpf_link_get_info_by_fd(link, &info, &info_len);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"bpf_obj_get_info\");\n\t\tgoto out_unlink;\n\t}\n\tCHECK_FAIL(info_len != sizeof(info));\n\n\t \n\tCHECK_FAIL(info.type != BPF_LINK_TYPE_NETNS);\n\tCHECK_FAIL(info.id != link_id);\n\tCHECK_FAIL(info.prog_id != query_prog_id(prog2));\n\tCHECK_FAIL(info.netns.netns_ino != 0);\n\tCHECK_FAIL(info.netns.attach_type != BPF_FLOW_DISSECTOR);\n\nout_unlink:\n\tclose(link);\nout_resetns:\n\tif (old_net != -1)\n\t\tsetns(old_net, CLONE_NEWNET);\n\tif (netns != -1)\n\t\tclose(netns);\n}\n\nstatic void run_tests(int netns)\n{\n\tstruct test {\n\t\tconst char *test_name;\n\t\tvoid (*test_func)(int netns, int prog1, int prog2);\n\t} tests[] = {\n\t\t{ \"prog attach, prog attach\",\n\t\t  test_prog_attach_prog_attach },\n\t\t{ \"link create, link create\",\n\t\t  test_link_create_link_create },\n\t\t{ \"prog attach, link create\",\n\t\t  test_prog_attach_link_create },\n\t\t{ \"link create, prog attach\",\n\t\t  test_link_create_prog_attach },\n\t\t{ \"link create, prog detach\",\n\t\t  test_link_create_prog_detach },\n\t\t{ \"prog attach, detach, query\",\n\t\t  test_prog_attach_detach_query },\n\t\t{ \"link create, close, query\",\n\t\t  test_link_create_close_query },\n\t\t{ \"link update no old prog\",\n\t\t  test_link_update_no_old_prog },\n\t\t{ \"link update with replace old prog\",\n\t\t  test_link_update_replace_old_prog },\n\t\t{ \"link update with same prog\",\n\t\t  test_link_update_same_prog },\n\t\t{ \"link update invalid opts\",\n\t\t  test_link_update_invalid_opts },\n\t\t{ \"link update invalid prog\",\n\t\t  test_link_update_invalid_prog },\n\t\t{ \"link update netns gone\",\n\t\t  test_link_update_netns_gone },\n\t\t{ \"link get info\",\n\t\t  test_link_get_info },\n\t};\n\tint i, progs[2] = { -1, -1 };\n\tchar test_name[80];\n\n\tfor (i = 0; i < ARRAY_SIZE(progs); i++) {\n\t\tprogs[i] = load_prog(BPF_PROG_TYPE_FLOW_DISSECTOR);\n\t\tif (progs[i] < 0)\n\t\t\tgoto out_close;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); i++) {\n\t\tsnprintf(test_name, sizeof(test_name),\n\t\t\t \"flow dissector %s%s\",\n\t\t\t tests[i].test_name,\n\t\t\t netns == init_net ? \" (init_net)\" : \"\");\n\t\tif (test__start_subtest(test_name))\n\t\t\ttests[i].test_func(netns, progs[0], progs[1]);\n\t}\nout_close:\n\tfor (i = 0; i < ARRAY_SIZE(progs); i++) {\n\t\tif (progs[i] >= 0)\n\t\t\tCHECK_FAIL(close(progs[i]));\n\t}\n}\n\nvoid serial_test_flow_dissector_reattach(void)\n{\n\tint err, new_net, saved_net;\n\n\tsaved_net = open(\"/proc/self/ns/net\", O_RDONLY);\n\tif (CHECK_FAIL(saved_net < 0)) {\n\t\tperror(\"open(/proc/self/ns/net\");\n\t\treturn;\n\t}\n\n\tinit_net = open(\"/proc/1/ns/net\", O_RDONLY);\n\tif (CHECK_FAIL(init_net < 0)) {\n\t\tperror(\"open(/proc/1/ns/net)\");\n\t\tgoto out_close;\n\t}\n\n\terr = setns(init_net, CLONE_NEWNET);\n\tif (CHECK_FAIL(err)) {\n\t\tperror(\"setns(/proc/1/ns/net)\");\n\t\tgoto out_close;\n\t}\n\n\tif (prog_is_attached(init_net)) {\n\t\ttest__skip();\n\t\tprintf(\"Can't test with flow dissector attached to init_net\\n\");\n\t\tgoto out_setns;\n\t}\n\n\t \n\trun_tests(init_net);\n\n\t \n\tnew_net = unshare_net(init_net);\n\tif (new_net < 0)\n\t\tgoto out_setns;\n\trun_tests(new_net);\n\tclose(new_net);\n\nout_setns:\n\t \n\terr = setns(saved_net, CLONE_NEWNET);\n\tif (CHECK_FAIL(err))\n\t\tperror(\"setns(/proc/self/ns/net)\");\n\nout_close:\n\tclose(init_net);\n\tclose(saved_net);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}