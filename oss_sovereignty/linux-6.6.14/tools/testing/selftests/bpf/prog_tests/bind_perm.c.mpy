{
  "module_name": "bind_perm.c",
  "hash_id": "b026c6c842786fcc9904057745306db37d6349ff61dc485c73ab7e55280fe718",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/bind_perm.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <sched.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include <sys/socket.h>\n\n#include \"test_progs.h\"\n#include \"cap_helpers.h\"\n#include \"bind_perm.skel.h\"\n\nstatic int duration;\n\nstatic int create_netns(void)\n{\n\tif (!ASSERT_OK(unshare(CLONE_NEWNET), \"create netns\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nvoid try_bind(int family, int port, int expected_errno)\n{\n\tstruct sockaddr_storage addr = {};\n\tstruct sockaddr_in6 *sin6;\n\tstruct sockaddr_in *sin;\n\tint fd = -1;\n\n\tfd = socket(family, SOCK_STREAM, 0);\n\tif (CHECK(fd < 0, \"fd\", \"errno %d\", errno))\n\t\tgoto close_socket;\n\n\tif (family == AF_INET) {\n\t\tsin = (struct sockaddr_in *)&addr;\n\t\tsin->sin_family = family;\n\t\tsin->sin_port = htons(port);\n\t} else {\n\t\tsin6 = (struct sockaddr_in6 *)&addr;\n\t\tsin6->sin6_family = family;\n\t\tsin6->sin6_port = htons(port);\n\t}\n\n\terrno = 0;\n\tbind(fd, (struct sockaddr *)&addr, sizeof(addr));\n\tASSERT_EQ(errno, expected_errno, \"bind\");\n\nclose_socket:\n\tif (fd >= 0)\n\t\tclose(fd);\n}\n\nvoid test_bind_perm(void)\n{\n\tconst __u64 net_bind_svc_cap = 1ULL << CAP_NET_BIND_SERVICE;\n\tstruct bind_perm *skel;\n\t__u64 old_caps = 0;\n\tint cgroup_fd;\n\n\tif (create_netns())\n\t\treturn;\n\n\tcgroup_fd = test__join_cgroup(\"/bind_perm\");\n\tif (CHECK(cgroup_fd < 0, \"cg-join\", \"errno %d\", errno))\n\t\treturn;\n\n\tskel = bind_perm__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel\"))\n\t\tgoto close_cgroup_fd;\n\n\tskel->links.bind_v4_prog = bpf_program__attach_cgroup(skel->progs.bind_v4_prog, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel, \"bind_v4_prog\"))\n\t\tgoto close_skeleton;\n\n\tskel->links.bind_v6_prog = bpf_program__attach_cgroup(skel->progs.bind_v6_prog, cgroup_fd);\n\tif (!ASSERT_OK_PTR(skel, \"bind_v6_prog\"))\n\t\tgoto close_skeleton;\n\n\tASSERT_OK(cap_disable_effective(net_bind_svc_cap, &old_caps),\n\t\t  \"cap_disable_effective\");\n\n\ttry_bind(AF_INET, 110, EACCES);\n\ttry_bind(AF_INET6, 110, EACCES);\n\n\ttry_bind(AF_INET, 111, 0);\n\ttry_bind(AF_INET6, 111, 0);\n\n\tif (old_caps & net_bind_svc_cap)\n\t\tASSERT_OK(cap_enable_effective(net_bind_svc_cap, NULL),\n\t\t\t  \"cap_enable_effective\");\n\nclose_skeleton:\n\tbind_perm__destroy(skel);\nclose_cgroup_fd:\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}