{
  "module_name": "stacktrace_map.c",
  "hash_id": "45ab1a9513c52dbaf815bb7557db997025da176884969dcbcce91ec05225ada7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/stacktrace_map.c",
  "human_readable_source": "\n#include <test_progs.h>\n\nvoid test_stacktrace_map(void)\n{\n\tint control_map_fd, stackid_hmap_fd, stackmap_fd, stack_amap_fd;\n\tconst char *prog_name = \"oncpu\";\n\tint err, prog_fd, stack_trace_len;\n\tconst char *file = \"./test_stacktrace_map.bpf.o\";\n\t__u32 key, val, duration = 0;\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\tstruct bpf_link *link;\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_TRACEPOINT, &obj, &prog_fd);\n\tif (CHECK(err, \"prog_load\", \"err %d errno %d\\n\", err, errno))\n\t\treturn;\n\n\tprog = bpf_object__find_program_by_name(obj, prog_name);\n\tif (CHECK(!prog, \"find_prog\", \"prog '%s' not found\\n\", prog_name))\n\t\tgoto close_prog;\n\n\tlink = bpf_program__attach_tracepoint(prog, \"sched\", \"sched_switch\");\n\tif (!ASSERT_OK_PTR(link, \"attach_tp\"))\n\t\tgoto close_prog;\n\n\t \n\tcontrol_map_fd = bpf_find_map(__func__, obj, \"control_map\");\n\tif (CHECK_FAIL(control_map_fd < 0))\n\t\tgoto disable_pmu;\n\n\tstackid_hmap_fd = bpf_find_map(__func__, obj, \"stackid_hmap\");\n\tif (CHECK_FAIL(stackid_hmap_fd < 0))\n\t\tgoto disable_pmu;\n\n\tstackmap_fd = bpf_find_map(__func__, obj, \"stackmap\");\n\tif (CHECK_FAIL(stackmap_fd < 0))\n\t\tgoto disable_pmu;\n\n\tstack_amap_fd = bpf_find_map(__func__, obj, \"stack_amap\");\n\tif (CHECK_FAIL(stack_amap_fd < 0))\n\t\tgoto disable_pmu;\n\n\t \n\tsleep(1);\n\n\t \n\tkey = 0;\n\tval = 1;\n\tbpf_map_update_elem(control_map_fd, &key, &val, 0);\n\n\t \n\terr = compare_map_keys(stackid_hmap_fd, stackmap_fd);\n\tif (CHECK(err, \"compare_map_keys stackid_hmap vs. stackmap\",\n\t\t  \"err %d errno %d\\n\", err, errno))\n\t\tgoto disable_pmu;\n\n\terr = compare_map_keys(stackmap_fd, stackid_hmap_fd);\n\tif (CHECK(err, \"compare_map_keys stackmap vs. stackid_hmap\",\n\t\t  \"err %d errno %d\\n\", err, errno))\n\t\tgoto disable_pmu;\n\n\tstack_trace_len = PERF_MAX_STACK_DEPTH * sizeof(__u64);\n\terr = compare_stack_ips(stackmap_fd, stack_amap_fd, stack_trace_len);\n\tif (CHECK(err, \"compare_stack_ips stackmap vs. stack_amap\",\n\t\t  \"err %d errno %d\\n\", err, errno))\n\t\tgoto disable_pmu;\n\ndisable_pmu:\n\tbpf_link__destroy(link);\nclose_prog:\n\tbpf_object__close(obj);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}