{
  "module_name": "cgroup_attach_override.c",
  "hash_id": "1930f43e4ae55f1aeca3383238f75e2a24949687ce366e07f06bffd36c07b816",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/cgroup_attach_override.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n\n#include \"cgroup_helpers.h\"\n\n#define FOO\t\t\"/foo\"\n#define BAR\t\t\"/foo/bar/\"\n#define PING_CMD\t\"ping -q -c1 -w1 127.0.0.1 > /dev/null\"\n\nstatic char bpf_log_buf[BPF_LOG_BUF_SIZE];\n\nstatic int prog_load(int verdict)\n{\n\tstruct bpf_insn prog[] = {\n\t\tBPF_MOV64_IMM(BPF_REG_0, verdict),  \n\t\tBPF_EXIT_INSN(),\n\t};\n\tsize_t insns_cnt = ARRAY_SIZE(prog);\n\n\treturn bpf_test_load_program(BPF_PROG_TYPE_CGROUP_SKB,\n\t\t\t       prog, insns_cnt, \"GPL\", 0,\n\t\t\t       bpf_log_buf, BPF_LOG_BUF_SIZE);\n}\n\nvoid serial_test_cgroup_attach_override(void)\n{\n\tint drop_prog = -1, allow_prog = -1, foo = -1, bar = -1;\n\t__u32 duration = 0;\n\n\tallow_prog = prog_load(1);\n\tif (CHECK(allow_prog < 0, \"prog_load_allow\",\n\t\t  \"verifier output:\\n%s\\n-------\\n\", bpf_log_buf))\n\t\tgoto err;\n\n\tdrop_prog = prog_load(0);\n\tif (CHECK(drop_prog < 0, \"prog_load_drop\",\n\t\t  \"verifier output:\\n%s\\n-------\\n\", bpf_log_buf))\n\t\tgoto err;\n\n\tfoo = test__join_cgroup(FOO);\n\tif (CHECK(foo < 0, \"cgroup_join_foo\", \"cgroup setup failed\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(drop_prog, foo, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_OVERRIDE),\n\t\t  \"prog_attach_drop_foo_override\",\n\t\t  \"attach prog to %s failed, errno=%d\\n\", FOO, errno))\n\t\tgoto err;\n\n\tif (CHECK(!system(PING_CMD), \"ping_fail\",\n\t\t  \"ping unexpectedly succeeded\\n\"))\n\t\tgoto err;\n\n\tbar = test__join_cgroup(BAR);\n\tif (CHECK(bar < 0, \"cgroup_join_bar\", \"cgroup setup failed\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(!system(PING_CMD), \"ping_fail\",\n\t\t  \"ping unexpectedly succeeded\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog, bar, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_OVERRIDE),\n\t\t  \"prog_attach_allow_bar_override\",\n\t\t  \"attach prog to %s failed, errno=%d\\n\", BAR, errno))\n\t\tgoto err;\n\n\tif (CHECK(system(PING_CMD), \"ping_ok\", \"ping failed\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_detach(bar, BPF_CGROUP_INET_EGRESS),\n\t\t  \"prog_detach_bar\",\n\t\t  \"detach prog from %s failed, errno=%d\\n\", BAR, errno))\n\t\tgoto err;\n\n\tif (CHECK(!system(PING_CMD), \"ping_fail\",\n\t\t  \"ping unexpectedly succeeded\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog, bar, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_OVERRIDE),\n\t\t  \"prog_attach_allow_bar_override\",\n\t\t  \"attach prog to %s failed, errno=%d\\n\", BAR, errno))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_detach(foo, BPF_CGROUP_INET_EGRESS),\n\t\t  \"prog_detach_foo\",\n\t\t  \"detach prog from %s failed, errno=%d\\n\", FOO, errno))\n\t\tgoto err;\n\n\tif (CHECK(system(PING_CMD), \"ping_ok\", \"ping failed\\n\"))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog, bar, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t  BPF_F_ALLOW_OVERRIDE),\n\t\t  \"prog_attach_allow_bar_override\",\n\t\t  \"attach prog to %s failed, errno=%d\\n\", BAR, errno))\n\t\tgoto err;\n\n\tif (CHECK(!bpf_prog_attach(allow_prog, bar, BPF_CGROUP_INET_EGRESS, 0),\n\t\t  \"fail_prog_attach_allow_bar_none\",\n\t\t  \"attach prog to %s unexpectedly succeeded\\n\", BAR))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_detach(bar, BPF_CGROUP_INET_EGRESS),\n\t\t  \"prog_detach_bar\",\n\t\t  \"detach prog from %s failed, errno=%d\\n\", BAR, errno))\n\t\tgoto err;\n\n\tif (CHECK(!bpf_prog_detach(foo, BPF_CGROUP_INET_EGRESS),\n\t\t  \"fail_prog_detach_foo\",\n\t\t  \"double detach from %s unexpectedly succeeded\\n\", FOO))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(allow_prog, foo, BPF_CGROUP_INET_EGRESS, 0),\n\t\t  \"prog_attach_allow_foo_none\",\n\t\t  \"attach prog to %s failed, errno=%d\\n\", FOO, errno))\n\t\tgoto err;\n\n\tif (CHECK(!bpf_prog_attach(allow_prog, bar, BPF_CGROUP_INET_EGRESS, 0),\n\t\t  \"fail_prog_attach_allow_bar_none\",\n\t\t  \"attach prog to %s unexpectedly succeeded\\n\", BAR))\n\t\tgoto err;\n\n\tif (CHECK(!bpf_prog_attach(allow_prog, bar, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t   BPF_F_ALLOW_OVERRIDE),\n\t\t  \"fail_prog_attach_allow_bar_override\",\n\t\t  \"attach prog to %s unexpectedly succeeded\\n\", BAR))\n\t\tgoto err;\n\n\tif (CHECK(!bpf_prog_attach(allow_prog, foo, BPF_CGROUP_INET_EGRESS,\n\t\t\t\t   BPF_F_ALLOW_OVERRIDE),\n\t\t  \"fail_prog_attach_allow_foo_override\",\n\t\t  \"attach prog to %s unexpectedly succeeded\\n\", FOO))\n\t\tgoto err;\n\n\tif (CHECK(bpf_prog_attach(drop_prog, foo, BPF_CGROUP_INET_EGRESS, 0),\n\t\t  \"prog_attach_drop_foo_none\",\n\t\t  \"attach prog to %s failed, errno=%d\\n\", FOO, errno))\n\t\tgoto err;\n\nerr:\n\tclose(foo);\n\tclose(bar);\n\tclose(allow_prog);\n\tclose(drop_prog);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}