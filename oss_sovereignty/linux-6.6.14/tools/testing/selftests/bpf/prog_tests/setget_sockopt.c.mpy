{
  "module_name": "setget_sockopt.c",
  "hash_id": "c43841a07ce80b05cf1299606472d3e5bcb986755c41ccdc6fbc646623888e6c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/setget_sockopt.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <sched.h>\n#include <linux/socket.h>\n#include <linux/tls.h>\n#include <net/if.h>\n\n#include \"test_progs.h\"\n#include \"cgroup_helpers.h\"\n#include \"network_helpers.h\"\n\n#include \"setget_sockopt.skel.h\"\n\n#define CG_NAME \"/setget-sockopt-test\"\n\nstatic const char addr4_str[] = \"127.0.0.1\";\nstatic const char addr6_str[] = \"::1\";\nstatic struct setget_sockopt *skel;\nstatic int cg_fd;\n\nstatic int create_netns(void)\n{\n\tif (!ASSERT_OK(unshare(CLONE_NEWNET), \"create netns\"))\n\t\treturn -1;\n\n\tif (!ASSERT_OK(system(\"ip link set dev lo up\"), \"set lo up\"))\n\t\treturn -1;\n\n\tif (!ASSERT_OK(system(\"ip link add dev binddevtest1 type veth peer name binddevtest2\"),\n\t\t       \"add veth\"))\n\t\treturn -1;\n\n\tif (!ASSERT_OK(system(\"ip link set dev binddevtest1 up\"),\n\t\t       \"bring veth up\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic void test_tcp(int family)\n{\n\tstruct setget_sockopt__bss *bss = skel->bss;\n\tint sfd, cfd;\n\n\tmemset(bss, 0, sizeof(*bss));\n\n\tsfd = start_server(family, SOCK_STREAM,\n\t\t\t   family == AF_INET6 ? addr6_str : addr4_str, 0, 0);\n\tif (!ASSERT_GE(sfd, 0, \"start_server\"))\n\t\treturn;\n\n\tcfd = connect_to_fd(sfd, 0);\n\tif (!ASSERT_GE(cfd, 0, \"connect_to_fd_server\")) {\n\t\tclose(sfd);\n\t\treturn;\n\t}\n\tclose(sfd);\n\tclose(cfd);\n\n\tASSERT_EQ(bss->nr_listen, 1, \"nr_listen\");\n\tASSERT_EQ(bss->nr_connect, 1, \"nr_connect\");\n\tASSERT_EQ(bss->nr_active, 1, \"nr_active\");\n\tASSERT_EQ(bss->nr_passive, 1, \"nr_passive\");\n\tASSERT_EQ(bss->nr_socket_post_create, 2, \"nr_socket_post_create\");\n\tASSERT_EQ(bss->nr_binddev, 2, \"nr_bind\");\n}\n\nstatic void test_udp(int family)\n{\n\tstruct setget_sockopt__bss *bss = skel->bss;\n\tint sfd;\n\n\tmemset(bss, 0, sizeof(*bss));\n\n\tsfd = start_server(family, SOCK_DGRAM,\n\t\t\t   family == AF_INET6 ? addr6_str : addr4_str, 0, 0);\n\tif (!ASSERT_GE(sfd, 0, \"start_server\"))\n\t\treturn;\n\tclose(sfd);\n\n\tASSERT_GE(bss->nr_socket_post_create, 1, \"nr_socket_post_create\");\n\tASSERT_EQ(bss->nr_binddev, 1, \"nr_bind\");\n}\n\nstatic void test_ktls(int family)\n{\n\tstruct tls12_crypto_info_aes_gcm_128 aes128;\n\tstruct setget_sockopt__bss *bss = skel->bss;\n\tint cfd = -1, sfd = -1, fd = -1, ret;\n\tchar buf;\n\n\tmemset(bss, 0, sizeof(*bss));\n\n\tsfd = start_server(family, SOCK_STREAM,\n\t\t\t   family == AF_INET6 ? addr6_str : addr4_str, 0, 0);\n\tif (!ASSERT_GE(sfd, 0, \"start_server\"))\n\t\treturn;\n\tfd = connect_to_fd(sfd, 0);\n\tif (!ASSERT_GE(fd, 0, \"connect_to_fd\"))\n\t\tgoto err_out;\n\n\tcfd = accept(sfd, NULL, 0);\n\tif (!ASSERT_GE(cfd, 0, \"accept\"))\n\t\tgoto err_out;\n\n\tclose(sfd);\n\tsfd = -1;\n\n\t \n\tret = setsockopt(fd, IPPROTO_TCP, TCP_ULP, \"tls\", sizeof(\"tls\"));\n\tif (!ASSERT_OK(ret, \"setsockopt\"))\n\t\tgoto err_out;\n\tret = setsockopt(cfd, IPPROTO_TCP, TCP_ULP, \"tls\", sizeof(\"tls\"));\n\tif (!ASSERT_OK(ret, \"setsockopt\"))\n\t\tgoto err_out;\n\n\tmemset(&aes128, 0, sizeof(aes128));\n\taes128.info.version = TLS_1_2_VERSION;\n\taes128.info.cipher_type = TLS_CIPHER_AES_GCM_128;\n\n\tret = setsockopt(fd, SOL_TLS, TLS_TX, &aes128, sizeof(aes128));\n\tif (!ASSERT_OK(ret, \"setsockopt\"))\n\t\tgoto err_out;\n\n\tret = setsockopt(cfd, SOL_TLS, TLS_RX, &aes128, sizeof(aes128));\n\tif (!ASSERT_OK(ret, \"setsockopt\"))\n\t\tgoto err_out;\n\n\t \n\n\tclose(fd);\n\t \n\tret = read(cfd, &buf, sizeof(buf));\n\tASSERT_EQ(ret, 0, \"read\");\n\tclose(cfd);\n\n\tASSERT_EQ(bss->nr_listen, 1, \"nr_listen\");\n\tASSERT_EQ(bss->nr_connect, 1, \"nr_connect\");\n\tASSERT_EQ(bss->nr_active, 1, \"nr_active\");\n\tASSERT_EQ(bss->nr_passive, 1, \"nr_passive\");\n\tASSERT_EQ(bss->nr_socket_post_create, 2, \"nr_socket_post_create\");\n\tASSERT_EQ(bss->nr_binddev, 2, \"nr_bind\");\n\tASSERT_EQ(bss->nr_fin_wait1, 1, \"nr_fin_wait1\");\n\treturn;\n\nerr_out:\n\tclose(fd);\n\tclose(cfd);\n\tclose(sfd);\n}\n\nvoid test_setget_sockopt(void)\n{\n\tcg_fd = test__join_cgroup(CG_NAME);\n\tif (cg_fd < 0)\n\t\treturn;\n\n\tif (create_netns())\n\t\tgoto done;\n\n\tskel = setget_sockopt__open();\n\tif (!ASSERT_OK_PTR(skel, \"open skel\"))\n\t\tgoto done;\n\n\tstrcpy(skel->rodata->veth, \"binddevtest1\");\n\tskel->rodata->veth_ifindex = if_nametoindex(\"binddevtest1\");\n\tif (!ASSERT_GT(skel->rodata->veth_ifindex, 0, \"if_nametoindex\"))\n\t\tgoto done;\n\n\tif (!ASSERT_OK(setget_sockopt__load(skel), \"load skel\"))\n\t\tgoto done;\n\n\tskel->links.skops_sockopt =\n\t\tbpf_program__attach_cgroup(skel->progs.skops_sockopt, cg_fd);\n\tif (!ASSERT_OK_PTR(skel->links.skops_sockopt, \"attach cgroup\"))\n\t\tgoto done;\n\n\tskel->links.socket_post_create =\n\t\tbpf_program__attach_cgroup(skel->progs.socket_post_create, cg_fd);\n\tif (!ASSERT_OK_PTR(skel->links.socket_post_create, \"attach_cgroup\"))\n\t\tgoto done;\n\n\ttest_tcp(AF_INET6);\n\ttest_tcp(AF_INET);\n\ttest_udp(AF_INET6);\n\ttest_udp(AF_INET);\n\ttest_ktls(AF_INET6);\n\ttest_ktls(AF_INET);\n\ndone:\n\tsetget_sockopt__destroy(skel);\n\tclose(cg_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}