{
  "module_name": "test_ima.c",
  "hash_id": "25d7acf23fe21307db30d083487c94466feba67d6652f9af0ebc0f658e9f9b42",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/test_ima.c",
  "human_readable_source": "\n\n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/wait.h>\n#include <test_progs.h>\n#include <linux/ring_buffer.h>\n\n#include \"ima.skel.h\"\n\n#define MAX_SAMPLES 4\n\nstatic int _run_measured_process(const char *measured_dir, u32 *monitored_pid,\n\t\t\t\t const char *cmd)\n{\n\tint child_pid, child_status;\n\n\tchild_pid = fork();\n\tif (child_pid == 0) {\n\t\t*monitored_pid = getpid();\n\t\texeclp(\"./ima_setup.sh\", \"./ima_setup.sh\", cmd, measured_dir,\n\t\t       NULL);\n\t\texit(errno);\n\n\t} else if (child_pid > 0) {\n\t\twaitpid(child_pid, &child_status, 0);\n\t\treturn WEXITSTATUS(child_status);\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int run_measured_process(const char *measured_dir, u32 *monitored_pid)\n{\n\treturn _run_measured_process(measured_dir, monitored_pid, \"run\");\n}\n\nstatic u64 ima_hash_from_bpf[MAX_SAMPLES];\nstatic int ima_hash_from_bpf_idx;\n\nstatic int process_sample(void *ctx, void *data, size_t len)\n{\n\tif (ima_hash_from_bpf_idx >= MAX_SAMPLES)\n\t\treturn -ENOSPC;\n\n\tima_hash_from_bpf[ima_hash_from_bpf_idx++] = *((u64 *)data);\n\treturn 0;\n}\n\nstatic void test_init(struct ima__bss *bss)\n{\n\tima_hash_from_bpf_idx = 0;\n\n\tbss->use_ima_file_hash = false;\n\tbss->enable_bprm_creds_for_exec = false;\n\tbss->enable_kernel_read_file = false;\n\tbss->test_deny = false;\n}\n\nvoid test_test_ima(void)\n{\n\tchar measured_dir_template[] = \"/tmp/ima_measuredXXXXXX\";\n\tstruct ring_buffer *ringbuf = NULL;\n\tconst char *measured_dir;\n\tu64 bin_true_sample;\n\tchar cmd[256];\n\n\tint err, duration = 0, fresh_digest_idx = 0;\n\tstruct ima *skel = NULL;\n\n\tskel = ima__open_and_load();\n\tif (CHECK(!skel, \"skel_load\", \"skeleton failed\\n\"))\n\t\tgoto close_prog;\n\n\tringbuf = ring_buffer__new(bpf_map__fd(skel->maps.ringbuf),\n\t\t\t\t   process_sample, NULL, NULL);\n\tif (!ASSERT_OK_PTR(ringbuf, \"ringbuf\"))\n\t\tgoto close_prog;\n\n\terr = ima__attach(skel);\n\tif (CHECK(err, \"attach\", \"attach failed: %d\\n\", err))\n\t\tgoto close_prog;\n\n\tmeasured_dir = mkdtemp(measured_dir_template);\n\tif (CHECK(measured_dir == NULL, \"mkdtemp\", \"err %d\\n\", errno))\n\t\tgoto close_prog;\n\n\tsnprintf(cmd, sizeof(cmd), \"./ima_setup.sh setup %s\", measured_dir);\n\terr = system(cmd);\n\tif (CHECK(err, \"failed to run command\", \"%s, errno = %d\\n\", cmd, errno))\n\t\tgoto close_clean;\n\n\t \n\ttest_init(skel->bss);\n\terr = run_measured_process(measured_dir, &skel->bss->monitored_pid);\n\tif (CHECK(err, \"run_measured_process #1\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\terr = ring_buffer__consume(ringbuf);\n\tASSERT_EQ(err, 1, \"num_samples_or_err\");\n\tASSERT_NEQ(ima_hash_from_bpf[0], 0, \"ima_hash\");\n\n\t \n\ttest_init(skel->bss);\n\tskel->bss->use_ima_file_hash = true;\n\terr = run_measured_process(measured_dir, &skel->bss->monitored_pid);\n\tif (CHECK(err, \"run_measured_process #2\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\terr = ring_buffer__consume(ringbuf);\n\tASSERT_EQ(err, 2, \"num_samples_or_err\");\n\tASSERT_NEQ(ima_hash_from_bpf[0], 0, \"ima_hash\");\n\tASSERT_NEQ(ima_hash_from_bpf[1], 0, \"ima_hash\");\n\tbin_true_sample = ima_hash_from_bpf[1];\n\n\t \n\ttest_init(skel->bss);\n\n\terr = _run_measured_process(measured_dir, &skel->bss->monitored_pid,\n\t\t\t\t    \"modify-bin\");\n\tif (CHECK(err, \"modify-bin #3\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\tskel->bss->enable_bprm_creds_for_exec = true;\n\terr = run_measured_process(measured_dir, &skel->bss->monitored_pid);\n\tif (CHECK(err, \"run_measured_process #3\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\terr = ring_buffer__consume(ringbuf);\n\tASSERT_GE(err, 1, \"num_samples_or_err\");\n\tif (err == 2) {\n\t\tASSERT_NEQ(ima_hash_from_bpf[0], 0, \"ima_hash\");\n\t\tASSERT_EQ(ima_hash_from_bpf[0], bin_true_sample,\n\t\t\t  \"sample_equal_or_err\");\n\t\tfresh_digest_idx = 1;\n\t}\n\n\tASSERT_NEQ(ima_hash_from_bpf[fresh_digest_idx], 0, \"ima_hash\");\n\t \n\tASSERT_NEQ(ima_hash_from_bpf[fresh_digest_idx], bin_true_sample,\n\t\t   \"sample_equal_or_err\");\n\n\t \n\ttest_init(skel->bss);\n\tskel->bss->use_ima_file_hash = true;\n\tskel->bss->enable_bprm_creds_for_exec = true;\n\terr = run_measured_process(measured_dir, &skel->bss->monitored_pid);\n\tif (CHECK(err, \"run_measured_process #4\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\terr = ring_buffer__consume(ringbuf);\n\tASSERT_EQ(err, 4, \"num_samples_or_err\");\n\tASSERT_NEQ(ima_hash_from_bpf[0], 0, \"ima_hash\");\n\tASSERT_NEQ(ima_hash_from_bpf[1], 0, \"ima_hash\");\n\tASSERT_NEQ(ima_hash_from_bpf[2], 0, \"ima_hash\");\n\tASSERT_NEQ(ima_hash_from_bpf[3], 0, \"ima_hash\");\n\tASSERT_NEQ(ima_hash_from_bpf[2], bin_true_sample,\n\t\t   \"sample_different_or_err\");\n\tASSERT_EQ(ima_hash_from_bpf[3], ima_hash_from_bpf[2],\n\t\t  \"sample_equal_or_err\");\n\n\tskel->bss->use_ima_file_hash = false;\n\tskel->bss->enable_bprm_creds_for_exec = false;\n\terr = _run_measured_process(measured_dir, &skel->bss->monitored_pid,\n\t\t\t\t    \"restore-bin\");\n\tif (CHECK(err, \"restore-bin #3\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\t \n\ttest_init(skel->bss);\n\tskel->bss->use_ima_file_hash = true;\n\tskel->bss->enable_kernel_read_file = true;\n\terr = _run_measured_process(measured_dir, &skel->bss->monitored_pid,\n\t\t\t\t    \"load-policy\");\n\tif (CHECK(err, \"run_measured_process #5\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\terr = ring_buffer__consume(ringbuf);\n\tASSERT_EQ(err, 2, \"num_samples_or_err\");\n\tASSERT_NEQ(ima_hash_from_bpf[0], 0, \"ima_hash\");\n\tASSERT_NEQ(ima_hash_from_bpf[1], 0, \"ima_hash\");\n\n\t \n\ttest_init(skel->bss);\n\tskel->bss->enable_kernel_read_file = true;\n\tskel->bss->test_deny = true;\n\terr = _run_measured_process(measured_dir, &skel->bss->monitored_pid,\n\t\t\t\t    \"load-policy\");\n\tif (CHECK(!err, \"run_measured_process #6\", \"err = %d\\n\", err))\n\t\tgoto close_clean;\n\n\terr = ring_buffer__consume(ringbuf);\n\tASSERT_EQ(err, 0, \"num_samples_or_err\");\n\nclose_clean:\n\tsnprintf(cmd, sizeof(cmd), \"./ima_setup.sh cleanup %s\", measured_dir);\n\terr = system(cmd);\n\tCHECK(err, \"failed to run command\", \"%s, errno = %d\\n\", cmd, errno);\nclose_prog:\n\tring_buffer__free(ringbuf);\n\tima__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}