{
  "module_name": "xdp_cpumap_attach.c",
  "hash_id": "654d4a275a258e2fc0a08243307cb5468390f543602a13db9cae122a1f6bf5ed",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/xdp_cpumap_attach.c",
  "human_readable_source": "\n#include <uapi/linux/bpf.h>\n#include <linux/if_link.h>\n#include <test_progs.h>\n\n#include \"test_xdp_with_cpumap_frags_helpers.skel.h\"\n#include \"test_xdp_with_cpumap_helpers.skel.h\"\n\n#define IFINDEX_LO\t1\n\nstatic void test_xdp_with_cpumap_helpers(void)\n{\n\tstruct test_xdp_with_cpumap_helpers *skel;\n\tstruct bpf_prog_info info = {};\n\t__u32 len = sizeof(info);\n\tstruct bpf_cpumap_val val = {\n\t\t.qsize = 192,\n\t};\n\tint err, prog_fd, map_fd;\n\t__u32 idx = 0;\n\n\tskel = test_xdp_with_cpumap_helpers__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"test_xdp_with_cpumap_helpers__open_and_load\"))\n\t\treturn;\n\n\tprog_fd = bpf_program__fd(skel->progs.xdp_redir_prog);\n\terr = bpf_xdp_attach(IFINDEX_LO, prog_fd, XDP_FLAGS_SKB_MODE, NULL);\n\tif (!ASSERT_OK(err, \"Generic attach of program with 8-byte CPUMAP\"))\n\t\tgoto out_close;\n\n\terr = bpf_xdp_detach(IFINDEX_LO, XDP_FLAGS_SKB_MODE, NULL);\n\tASSERT_OK(err, \"XDP program detach\");\n\n\tprog_fd = bpf_program__fd(skel->progs.xdp_dummy_cm);\n\tmap_fd = bpf_map__fd(skel->maps.cpu_map);\n\terr = bpf_prog_get_info_by_fd(prog_fd, &info, &len);\n\tif (!ASSERT_OK(err, \"bpf_prog_get_info_by_fd\"))\n\t\tgoto out_close;\n\n\tval.bpf_prog.fd = prog_fd;\n\terr = bpf_map_update_elem(map_fd, &idx, &val, 0);\n\tASSERT_OK(err, \"Add program to cpumap entry\");\n\n\terr = bpf_map_lookup_elem(map_fd, &idx, &val);\n\tASSERT_OK(err, \"Read cpumap entry\");\n\tASSERT_EQ(info.id, val.bpf_prog.id, \"Match program id to cpumap entry prog_id\");\n\n\t \n\terr = bpf_xdp_attach(IFINDEX_LO, prog_fd, XDP_FLAGS_SKB_MODE, NULL);\n\tif (!ASSERT_NEQ(err, 0, \"Attach of BPF_XDP_CPUMAP program\"))\n\t\tbpf_xdp_detach(IFINDEX_LO, XDP_FLAGS_SKB_MODE, NULL);\n\n\tval.qsize = 192;\n\tval.bpf_prog.fd = bpf_program__fd(skel->progs.xdp_dummy_prog);\n\terr = bpf_map_update_elem(map_fd, &idx, &val, 0);\n\tASSERT_NEQ(err, 0, \"Add non-BPF_XDP_CPUMAP program to cpumap entry\");\n\n\t \n\tidx = 1;\n\tval.qsize = 192;\n\tval.bpf_prog.fd = bpf_program__fd(skel->progs.xdp_dummy_cm_frags);\n\terr = bpf_map_update_elem(map_fd, &idx, &val, 0);\n\tASSERT_NEQ(err, 0, \"Add BPF_XDP program with frags to cpumap entry\");\n\nout_close:\n\ttest_xdp_with_cpumap_helpers__destroy(skel);\n}\n\nstatic void test_xdp_with_cpumap_frags_helpers(void)\n{\n\tstruct test_xdp_with_cpumap_frags_helpers *skel;\n\tstruct bpf_prog_info info = {};\n\t__u32 len = sizeof(info);\n\tstruct bpf_cpumap_val val = {\n\t\t.qsize = 192,\n\t};\n\tint err, frags_prog_fd, map_fd;\n\t__u32 idx = 0;\n\n\tskel = test_xdp_with_cpumap_frags_helpers__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"test_xdp_with_cpumap_helpers__open_and_load\"))\n\t\treturn;\n\n\tfrags_prog_fd = bpf_program__fd(skel->progs.xdp_dummy_cm_frags);\n\tmap_fd = bpf_map__fd(skel->maps.cpu_map);\n\terr = bpf_prog_get_info_by_fd(frags_prog_fd, &info, &len);\n\tif (!ASSERT_OK(err, \"bpf_prog_get_info_by_fd\"))\n\t\tgoto out_close;\n\n\tval.bpf_prog.fd = frags_prog_fd;\n\terr = bpf_map_update_elem(map_fd, &idx, &val, 0);\n\tASSERT_OK(err, \"Add program to cpumap entry\");\n\n\terr = bpf_map_lookup_elem(map_fd, &idx, &val);\n\tASSERT_OK(err, \"Read cpumap entry\");\n\tASSERT_EQ(info.id, val.bpf_prog.id,\n\t\t  \"Match program id to cpumap entry prog_id\");\n\n\t \n\tidx = 1;\n\tval.qsize = 192;\n\tval.bpf_prog.fd = bpf_program__fd(skel->progs.xdp_dummy_cm);\n\terr = bpf_map_update_elem(map_fd, &idx, &val, 0);\n\tASSERT_NEQ(err, 0, \"Add BPF_XDP program to cpumap entry\");\n\nout_close:\n\ttest_xdp_with_cpumap_frags_helpers__destroy(skel);\n}\n\nvoid serial_test_xdp_cpumap_attach(void)\n{\n\tif (test__start_subtest(\"CPUMAP with programs in entries\"))\n\t\ttest_xdp_with_cpumap_helpers();\n\n\tif (test__start_subtest(\"CPUMAP with frags programs in entries\"))\n\t\ttest_xdp_with_cpumap_frags_helpers();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}