{
  "module_name": "netfilter_link_attach.c",
  "hash_id": "f336bda47304a6aeb1437fc97c47069262238eba8e8629a929f57222023b9815",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/netfilter_link_attach.c",
  "human_readable_source": "\n\n#include <netinet/in.h>\n#include <linux/netfilter.h>\n\n#include \"test_progs.h\"\n#include \"test_netfilter_link_attach.skel.h\"\n\nstruct nf_link_test {\n\t__u32 pf;\n\t__u32 hooknum;\n\t__s32 priority;\n\t__u32 flags;\n\n\tbool expect_success;\n\tconst char * const name;\n};\n\nstatic const struct nf_link_test nf_hook_link_tests[] = {\n\t{ .name = \"allzero\", },\n\t{ .pf = NFPROTO_NUMPROTO, .name = \"invalid-pf\", },\n\t{ .pf = NFPROTO_IPV4, .hooknum = 42, .name = \"invalid-hooknum\", },\n\t{ .pf = NFPROTO_IPV4, .priority = INT_MIN, .name = \"invalid-priority-min\", },\n\t{ .pf = NFPROTO_IPV4, .priority = INT_MAX, .name = \"invalid-priority-max\", },\n\t{ .pf = NFPROTO_IPV4, .flags = UINT_MAX, .name = \"invalid-flags\", },\n\n\t{ .pf = NFPROTO_INET, .priority = 1, .name = \"invalid-inet-not-supported\", },\n\n\t{ .pf = NFPROTO_IPV4, .priority = -10000, .expect_success = true, .name = \"attach ipv4\", },\n\t{ .pf = NFPROTO_IPV6, .priority =  10001, .expect_success = true, .name = \"attach ipv6\", },\n};\n\nvoid test_netfilter_link_attach(void)\n{\n\tstruct test_netfilter_link_attach *skel;\n\tstruct bpf_program *prog;\n\tLIBBPF_OPTS(bpf_netfilter_opts, opts);\n\tint i;\n\n\tskel = test_netfilter_link_attach__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"test_netfilter_link_attach__open_and_load\"))\n\t\tgoto out;\n\n\tprog = skel->progs.nf_link_attach_test;\n\tif (!ASSERT_OK_PTR(prog, \"attach program\"))\n\t\tgoto out;\n\n\tfor (i = 0; i < ARRAY_SIZE(nf_hook_link_tests); i++) {\n\t\tstruct bpf_link *link;\n\n\t\tif (!test__start_subtest(nf_hook_link_tests[i].name))\n\t\t\tcontinue;\n\n#define X(opts, m, i)\topts.m = nf_hook_link_tests[(i)].m\n\t\tX(opts, pf, i);\n\t\tX(opts, hooknum, i);\n\t\tX(opts, priority, i);\n\t\tX(opts, flags, i);\n#undef X\n\t\tlink = bpf_program__attach_netfilter(prog, &opts);\n\t\tif (nf_hook_link_tests[i].expect_success) {\n\t\t\tstruct bpf_link *link2;\n\n\t\t\tif (!ASSERT_OK_PTR(link, \"program attach successful\"))\n\t\t\t\tcontinue;\n\n\t\t\tlink2 = bpf_program__attach_netfilter(prog, &opts);\n\t\t\tASSERT_ERR_PTR(link2, \"attach program with same pf/hook/priority\");\n\n\t\t\tif (!ASSERT_OK(bpf_link__destroy(link), \"link destroy\"))\n\t\t\t\tbreak;\n\n\t\t\tlink2 = bpf_program__attach_netfilter(prog, &opts);\n\t\t\tif (!ASSERT_OK_PTR(link2, \"program reattach successful\"))\n\t\t\t\tcontinue;\n\t\t\tif (!ASSERT_OK(bpf_link__destroy(link2), \"link destroy\"))\n\t\t\t\tbreak;\n\t\t} else {\n\t\t\tASSERT_ERR_PTR(link, \"program load failure\");\n\t\t}\n\t}\n\nout:\n\ttest_netfilter_link_attach__destroy(skel);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}