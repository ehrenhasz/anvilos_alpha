{
  "module_name": "dummy_st_ops.c",
  "hash_id": "23fe369293c71ed356cce44a0a0bbf93a34177ed5816c82c2351b7992e1635a0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/dummy_st_ops.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include \"dummy_st_ops_success.skel.h\"\n#include \"dummy_st_ops_fail.skel.h\"\n#include \"trace_dummy_st_ops.skel.h\"\n\n \nstruct bpf_dummy_ops_state {\n\tint val;\n};\n\nstatic void test_dummy_st_ops_attach(void)\n{\n\tstruct dummy_st_ops_success *skel;\n\tstruct bpf_link *link;\n\n\tskel = dummy_st_ops_success__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"dummy_st_ops_load\"))\n\t\treturn;\n\n\tlink = bpf_map__attach_struct_ops(skel->maps.dummy_1);\n\tASSERT_EQ(libbpf_get_error(link), -EOPNOTSUPP, \"dummy_st_ops_attach\");\n\n\tdummy_st_ops_success__destroy(skel);\n}\n\nstatic void test_dummy_init_ret_value(void)\n{\n\t__u64 args[1] = {0};\n\tLIBBPF_OPTS(bpf_test_run_opts, attr,\n\t\t.ctx_in = args,\n\t\t.ctx_size_in = sizeof(args),\n\t);\n\tstruct dummy_st_ops_success *skel;\n\tint fd, err;\n\n\tskel = dummy_st_ops_success__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"dummy_st_ops_load\"))\n\t\treturn;\n\n\tfd = bpf_program__fd(skel->progs.test_1);\n\terr = bpf_prog_test_run_opts(fd, &attr);\n\tASSERT_OK(err, \"test_run\");\n\tASSERT_EQ(attr.retval, 0xf2f3f4f5, \"test_ret\");\n\n\tdummy_st_ops_success__destroy(skel);\n}\n\nstatic void test_dummy_init_ptr_arg(void)\n{\n\tint exp_retval = 0xbeef;\n\tstruct bpf_dummy_ops_state in_state = {\n\t\t.val = exp_retval,\n\t};\n\t__u64 args[1] = {(unsigned long)&in_state};\n\tLIBBPF_OPTS(bpf_test_run_opts, attr,\n\t\t.ctx_in = args,\n\t\t.ctx_size_in = sizeof(args),\n\t);\n\tstruct trace_dummy_st_ops *trace_skel;\n\tstruct dummy_st_ops_success *skel;\n\tint fd, err;\n\n\tskel = dummy_st_ops_success__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"dummy_st_ops_load\"))\n\t\treturn;\n\n\tfd = bpf_program__fd(skel->progs.test_1);\n\n\ttrace_skel = trace_dummy_st_ops__open();\n\tif (!ASSERT_OK_PTR(trace_skel, \"trace_dummy_st_ops__open\"))\n\t\tgoto done;\n\n\terr = bpf_program__set_attach_target(trace_skel->progs.fentry_test_1,\n\t\t\t\t\t     fd, \"test_1\");\n\tif (!ASSERT_OK(err, \"set_attach_target(fentry_test_1)\"))\n\t\tgoto done;\n\n\terr = trace_dummy_st_ops__load(trace_skel);\n\tif (!ASSERT_OK(err, \"load(trace_skel)\"))\n\t\tgoto done;\n\n\terr = trace_dummy_st_ops__attach(trace_skel);\n\tif (!ASSERT_OK(err, \"attach(trace_skel)\"))\n\t\tgoto done;\n\n\terr = bpf_prog_test_run_opts(fd, &attr);\n\tASSERT_OK(err, \"test_run\");\n\tASSERT_EQ(in_state.val, 0x5a, \"test_ptr_ret\");\n\tASSERT_EQ(attr.retval, exp_retval, \"test_ret\");\n\tASSERT_EQ(trace_skel->bss->val, exp_retval, \"fentry_val\");\n\ndone:\n\tdummy_st_ops_success__destroy(skel);\n\ttrace_dummy_st_ops__destroy(trace_skel);\n}\n\nstatic void test_dummy_multiple_args(void)\n{\n\t__u64 args[5] = {0, -100, 0x8a5f, 'c', 0x1234567887654321ULL};\n\tLIBBPF_OPTS(bpf_test_run_opts, attr,\n\t\t.ctx_in = args,\n\t\t.ctx_size_in = sizeof(args),\n\t);\n\tstruct dummy_st_ops_success *skel;\n\tint fd, err;\n\tsize_t i;\n\tchar name[8];\n\n\tskel = dummy_st_ops_success__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"dummy_st_ops_load\"))\n\t\treturn;\n\n\tfd = bpf_program__fd(skel->progs.test_2);\n\terr = bpf_prog_test_run_opts(fd, &attr);\n\tASSERT_OK(err, \"test_run\");\n\tfor (i = 0; i < ARRAY_SIZE(args); i++) {\n\t\tsnprintf(name, sizeof(name), \"arg %zu\", i);\n\t\tASSERT_EQ(skel->bss->test_2_args[i], args[i], name);\n\t}\n\n\tdummy_st_ops_success__destroy(skel);\n}\n\nstatic void test_dummy_sleepable(void)\n{\n\t__u64 args[1] = {0};\n\tLIBBPF_OPTS(bpf_test_run_opts, attr,\n\t\t.ctx_in = args,\n\t\t.ctx_size_in = sizeof(args),\n\t);\n\tstruct dummy_st_ops_success *skel;\n\tint fd, err;\n\n\tskel = dummy_st_ops_success__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"dummy_st_ops_load\"))\n\t\treturn;\n\n\tfd = bpf_program__fd(skel->progs.test_sleepable);\n\terr = bpf_prog_test_run_opts(fd, &attr);\n\tASSERT_OK(err, \"test_run\");\n\n\tdummy_st_ops_success__destroy(skel);\n}\n\nvoid test_dummy_st_ops(void)\n{\n\tif (test__start_subtest(\"dummy_st_ops_attach\"))\n\t\ttest_dummy_st_ops_attach();\n\tif (test__start_subtest(\"dummy_init_ret_value\"))\n\t\ttest_dummy_init_ret_value();\n\tif (test__start_subtest(\"dummy_init_ptr_arg\"))\n\t\ttest_dummy_init_ptr_arg();\n\tif (test__start_subtest(\"dummy_multiple_args\"))\n\t\ttest_dummy_multiple_args();\n\tif (test__start_subtest(\"dummy_sleepable\"))\n\t\ttest_dummy_sleepable();\n\n\tRUN_TESTS(dummy_st_ops_fail);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}