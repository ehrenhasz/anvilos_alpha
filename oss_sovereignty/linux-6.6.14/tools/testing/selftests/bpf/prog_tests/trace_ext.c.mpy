{
  "module_name": "trace_ext.c",
  "hash_id": "5283c4b9646525037b7424df55aa23335bd36f92c0fc202169c8be09f7c08517",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/trace_ext.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <test_progs.h>\n#include <network_helpers.h>\n#include <sys/stat.h>\n#include <linux/sched.h>\n#include <sys/syscall.h>\n\n#include \"test_pkt_md_access.skel.h\"\n#include \"test_trace_ext.skel.h\"\n#include \"test_trace_ext_tracing.skel.h\"\n\nstatic __u32 duration;\n\nvoid test_trace_ext(void)\n{\n\tstruct test_pkt_md_access *skel_pkt = NULL;\n\tstruct test_trace_ext_tracing *skel_trace = NULL;\n\tstruct test_trace_ext_tracing__bss *bss_trace;\n\tstruct test_trace_ext *skel_ext = NULL;\n\tstruct test_trace_ext__bss *bss_ext;\n\tint err, pkt_fd, ext_fd;\n\tstruct bpf_program *prog;\n\tchar buf[100];\n\t__u64 len;\n\tLIBBPF_OPTS(bpf_test_run_opts, topts,\n\t\t.data_in = &pkt_v4,\n\t\t.data_size_in = sizeof(pkt_v4),\n\t\t.repeat = 1,\n\t);\n\n\t \n\tskel_pkt = test_pkt_md_access__open_and_load();\n\tif (CHECK(!skel_pkt, \"setup\", \"classifier/test_pkt_md_access open failed\\n\"))\n\t\tgoto cleanup;\n\n\terr = test_pkt_md_access__attach(skel_pkt);\n\tif (CHECK(err, \"setup\", \"classifier/test_pkt_md_access attach failed: %d\\n\", err))\n\t\tgoto cleanup;\n\n\tprog = skel_pkt->progs.test_pkt_md_access;\n\tpkt_fd = bpf_program__fd(prog);\n\n\t \n\tskel_ext = test_trace_ext__open();\n\tif (CHECK(!skel_ext, \"setup\", \"freplace/test_pkt_md_access open failed\\n\"))\n\t\tgoto cleanup;\n\n\t \n\tprog = skel_ext->progs.test_pkt_md_access_new;\n\tbpf_program__set_attach_target(prog, pkt_fd, \"test_pkt_md_access\");\n\n\t \n\terr = test_trace_ext__load(skel_ext);\n\tif (CHECK(err, \"setup\", \"freplace/test_pkt_md_access load failed\\n\")) {\n\t\tlibbpf_strerror(err, buf, sizeof(buf));\n\t\tfprintf(stderr, \"%s\\n\", buf);\n\t\tgoto cleanup;\n\t}\n\n\terr = test_trace_ext__attach(skel_ext);\n\tif (CHECK(err, \"setup\", \"freplace/test_pkt_md_access attach failed: %d\\n\", err))\n\t\tgoto cleanup;\n\n\tprog = skel_ext->progs.test_pkt_md_access_new;\n\text_fd = bpf_program__fd(prog);\n\n\t \n\tskel_trace = test_trace_ext_tracing__open();\n\tif (CHECK(!skel_trace, \"setup\", \"tracing/test_pkt_md_access_new open failed\\n\"))\n\t\tgoto cleanup;\n\n\t \n\tprog = skel_trace->progs.fentry;\n\tbpf_program__set_attach_target(prog, ext_fd, \"test_pkt_md_access_new\");\n\n\t \n\tprog = skel_trace->progs.fexit;\n\tbpf_program__set_attach_target(prog, ext_fd, \"test_pkt_md_access_new\");\n\n\t \n\terr = test_trace_ext_tracing__load(skel_trace);\n\tif (!ASSERT_OK(err, \"tracing/test_pkt_md_access_new load\")) {\n\t\tlibbpf_strerror(err, buf, sizeof(buf));\n\t\tfprintf(stderr, \"%s\\n\", buf);\n\t\tgoto cleanup;\n\t}\n\n\terr = test_trace_ext_tracing__attach(skel_trace);\n\tif (!ASSERT_OK(err, \"tracing/test_pkt_md_access_new attach\"))\n\t\tgoto cleanup;\n\n\t \n\terr = bpf_prog_test_run_opts(pkt_fd, &topts);\n\tASSERT_OK(err, \"test_run_opts err\");\n\tASSERT_OK(topts.retval, \"test_run_opts retval\");\n\n\tbss_ext = skel_ext->bss;\n\tbss_trace = skel_trace->bss;\n\n\tlen = bss_ext->ext_called;\n\n\tASSERT_NEQ(bss_ext->ext_called, 0,\n\t\t  \"failed to trigger freplace/test_pkt_md_access\");\n\tASSERT_EQ(bss_trace->fentry_called, len,\n\t\t  \"failed to trigger fentry/test_pkt_md_access_new\");\n\tASSERT_EQ(bss_trace->fexit_called, len,\n\t\t   \"failed to trigger fexit/test_pkt_md_access_new\");\n\ncleanup:\n\ttest_trace_ext_tracing__destroy(skel_trace);\n\ttest_trace_ext__destroy(skel_ext);\n\ttest_pkt_md_access__destroy(skel_pkt);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}