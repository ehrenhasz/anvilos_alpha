{
  "module_name": "connect_force_port.c",
  "hash_id": "80735afc9c5df0c146ae9aa9d9396671fdbcb34fd62c1bd951942f7ea430e44e",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/connect_force_port.c",
  "human_readable_source": "\n\n#include <test_progs.h>\n#include \"cgroup_helpers.h\"\n#include \"network_helpers.h\"\n\nstatic int verify_ports(int family, int fd,\n\t\t\t__u16 expected_local, __u16 expected_peer)\n{\n\tstruct sockaddr_storage addr;\n\tsocklen_t len = sizeof(addr);\n\t__u16 port;\n\n\tif (getsockname(fd, (struct sockaddr *)&addr, &len)) {\n\t\tlog_err(\"Failed to get server addr\");\n\t\treturn -1;\n\t}\n\n\tif (family == AF_INET)\n\t\tport = ((struct sockaddr_in *)&addr)->sin_port;\n\telse\n\t\tport = ((struct sockaddr_in6 *)&addr)->sin6_port;\n\n\tif (ntohs(port) != expected_local) {\n\t\tlog_err(\"Unexpected local port %d, expected %d\", ntohs(port),\n\t\t\texpected_local);\n\t\treturn -1;\n\t}\n\n\tif (getpeername(fd, (struct sockaddr *)&addr, &len)) {\n\t\tlog_err(\"Failed to get peer addr\");\n\t\treturn -1;\n\t}\n\n\tif (family == AF_INET)\n\t\tport = ((struct sockaddr_in *)&addr)->sin_port;\n\telse\n\t\tport = ((struct sockaddr_in6 *)&addr)->sin6_port;\n\n\tif (ntohs(port) != expected_peer) {\n\t\tlog_err(\"Unexpected peer port %d, expected %d\", ntohs(port),\n\t\t\texpected_peer);\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nstatic int run_test(int cgroup_fd, int server_fd, int family, int type)\n{\n\tbool v4 = family == AF_INET;\n\t__u16 expected_local_port = v4 ? 22222 : 22223;\n\t__u16 expected_peer_port = 60000;\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\tconst char *obj_file = v4 ? \"connect_force_port4.bpf.o\" : \"connect_force_port6.bpf.o\";\n\tint fd, err;\n\t__u32 duration = 0;\n\n\tobj = bpf_object__open_file(obj_file, NULL);\n\tif (!ASSERT_OK_PTR(obj, \"bpf_obj_open\"))\n\t\treturn -1;\n\n\terr = bpf_object__load(obj);\n\tif (!ASSERT_OK(err, \"bpf_obj_load\")) {\n\t\terr = -EIO;\n\t\tgoto close_bpf_object;\n\t}\n\n\tprog = bpf_object__find_program_by_name(obj, v4 ?\n\t\t\t\t\t\t\"connect4\" :\n\t\t\t\t\t\t\"connect6\");\n\tif (CHECK(!prog, \"find_prog\", \"connect prog not found\\n\")) {\n\t\terr = -EIO;\n\t\tgoto close_bpf_object;\n\t}\n\n\terr = bpf_prog_attach(bpf_program__fd(prog), cgroup_fd, v4 ?\n\t\t\t      BPF_CGROUP_INET4_CONNECT :\n\t\t\t      BPF_CGROUP_INET6_CONNECT, 0);\n\tif (err) {\n\t\tlog_err(\"Failed to attach BPF program\");\n\t\tgoto close_bpf_object;\n\t}\n\n\tprog = bpf_object__find_program_by_name(obj, v4 ?\n\t\t\t\t\t\t\"getpeername4\" :\n\t\t\t\t\t\t\"getpeername6\");\n\tif (CHECK(!prog, \"find_prog\", \"getpeername prog not found\\n\")) {\n\t\terr = -EIO;\n\t\tgoto close_bpf_object;\n\t}\n\n\terr = bpf_prog_attach(bpf_program__fd(prog), cgroup_fd, v4 ?\n\t\t\t      BPF_CGROUP_INET4_GETPEERNAME :\n\t\t\t      BPF_CGROUP_INET6_GETPEERNAME, 0);\n\tif (err) {\n\t\tlog_err(\"Failed to attach BPF program\");\n\t\tgoto close_bpf_object;\n\t}\n\n\tprog = bpf_object__find_program_by_name(obj, v4 ?\n\t\t\t\t\t\t\"getsockname4\" :\n\t\t\t\t\t\t\"getsockname6\");\n\tif (CHECK(!prog, \"find_prog\", \"getsockname prog not found\\n\")) {\n\t\terr = -EIO;\n\t\tgoto close_bpf_object;\n\t}\n\n\terr = bpf_prog_attach(bpf_program__fd(prog), cgroup_fd, v4 ?\n\t\t\t      BPF_CGROUP_INET4_GETSOCKNAME :\n\t\t\t      BPF_CGROUP_INET6_GETSOCKNAME, 0);\n\tif (err) {\n\t\tlog_err(\"Failed to attach BPF program\");\n\t\tgoto close_bpf_object;\n\t}\n\n\tfd = connect_to_fd(server_fd, 0);\n\tif (fd < 0) {\n\t\terr = -1;\n\t\tgoto close_bpf_object;\n\t}\n\n\terr = verify_ports(family, fd, expected_local_port,\n\t\t\t   expected_peer_port);\n\tclose(fd);\n\nclose_bpf_object:\n\tbpf_object__close(obj);\n\treturn err;\n}\n\nvoid test_connect_force_port(void)\n{\n\tint server_fd, cgroup_fd;\n\n\tcgroup_fd = test__join_cgroup(\"/connect_force_port\");\n\tif (CHECK_FAIL(cgroup_fd < 0))\n\t\treturn;\n\n\tserver_fd = start_server(AF_INET, SOCK_STREAM, NULL, 60123, 0);\n\tif (CHECK_FAIL(server_fd < 0))\n\t\tgoto close_cgroup_fd;\n\tCHECK_FAIL(run_test(cgroup_fd, server_fd, AF_INET, SOCK_STREAM));\n\tclose(server_fd);\n\n\tserver_fd = start_server(AF_INET6, SOCK_STREAM, NULL, 60124, 0);\n\tif (CHECK_FAIL(server_fd < 0))\n\t\tgoto close_cgroup_fd;\n\tCHECK_FAIL(run_test(cgroup_fd, server_fd, AF_INET6, SOCK_STREAM));\n\tclose(server_fd);\n\n\tserver_fd = start_server(AF_INET, SOCK_DGRAM, NULL, 60123, 0);\n\tif (CHECK_FAIL(server_fd < 0))\n\t\tgoto close_cgroup_fd;\n\tCHECK_FAIL(run_test(cgroup_fd, server_fd, AF_INET, SOCK_DGRAM));\n\tclose(server_fd);\n\n\tserver_fd = start_server(AF_INET6, SOCK_DGRAM, NULL, 60124, 0);\n\tif (CHECK_FAIL(server_fd < 0))\n\t\tgoto close_cgroup_fd;\n\tCHECK_FAIL(run_test(cgroup_fd, server_fd, AF_INET6, SOCK_DGRAM));\n\tclose(server_fd);\n\nclose_cgroup_fd:\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}