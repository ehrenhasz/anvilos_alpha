{
  "module_name": "trace_printk.c",
  "hash_id": "58759bd1b72e08537f62203739998959961c812b1c3f0c240a9882e46367732f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/trace_printk.c",
  "human_readable_source": "\n \n\n#include <test_progs.h>\n\n#include \"trace_printk.lskel.h\"\n\n#define TRACEFS_PIPE\t\"/sys/kernel/tracing/trace_pipe\"\n#define DEBUGFS_PIPE\t\"/sys/kernel/debug/tracing/trace_pipe\"\n#define SEARCHMSG\t\"testing,testing\"\n\nvoid serial_test_trace_printk(void)\n{\n\tstruct trace_printk_lskel__bss *bss;\n\tint err = 0, iter = 0, found = 0;\n\tstruct trace_printk_lskel *skel;\n\tchar *buf = NULL;\n\tFILE *fp = NULL;\n\tsize_t buflen;\n\n\tskel = trace_printk_lskel__open();\n\tif (!ASSERT_OK_PTR(skel, \"trace_printk__open\"))\n\t\treturn;\n\n\tASSERT_EQ(skel->rodata->fmt[0], 'T', \"skel->rodata->fmt[0]\");\n\tskel->rodata->fmt[0] = 't';\n\n\terr = trace_printk_lskel__load(skel);\n\tif (!ASSERT_OK(err, \"trace_printk__load\"))\n\t\tgoto cleanup;\n\n\tbss = skel->bss;\n\n\terr = trace_printk_lskel__attach(skel);\n\tif (!ASSERT_OK(err, \"trace_printk__attach\"))\n\t\tgoto cleanup;\n\n\tif (access(TRACEFS_PIPE, F_OK) == 0)\n\t\tfp = fopen(TRACEFS_PIPE, \"r\");\n\telse\n\t\tfp = fopen(DEBUGFS_PIPE, \"r\");\n\tif (!ASSERT_OK_PTR(fp, \"fopen(TRACE_PIPE)\"))\n\t\tgoto cleanup;\n\n\t \n\tfcntl(fileno(fp), F_SETFL, O_NONBLOCK);\n\n\t \n\tusleep(1);\n\ttrace_printk_lskel__detach(skel);\n\n\tif (!ASSERT_GT(bss->trace_printk_ran, 0, \"bss->trace_printk_ran\"))\n\t\tgoto cleanup;\n\n\tif (!ASSERT_GT(bss->trace_printk_ret, 0, \"bss->trace_printk_ret\"))\n\t\tgoto cleanup;\n\n\t \n\twhile (getline(&buf, &buflen, fp) >= 0 || errno == EAGAIN) {\n\t\tif (strstr(buf, SEARCHMSG) != NULL)\n\t\t\tfound++;\n\t\tif (found == bss->trace_printk_ran)\n\t\t\tbreak;\n\t\tif (++iter > 1000)\n\t\t\tbreak;\n\t}\n\n\tif (!ASSERT_EQ(found, bss->trace_printk_ran, \"found\"))\n\t\tgoto cleanup;\n\ncleanup:\n\ttrace_printk_lskel__destroy(skel);\n\tfree(buf);\n\tif (fp)\n\t\tfclose(fp);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}