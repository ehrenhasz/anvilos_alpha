{
  "module_name": "sk_storage_tracing.c",
  "hash_id": "5e82aa9e51c77d58c79b3b19d58a51129956fc5caf3a6f7ac591fbb0201c2057",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/sk_storage_tracing.c",
  "human_readable_source": "\n \n\n#include <sys/types.h>\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n#include \"test_progs.h\"\n#include \"network_helpers.h\"\n#include \"test_sk_storage_trace_itself.skel.h\"\n#include \"test_sk_storage_tracing.skel.h\"\n\n#define LO_ADDR6 \"::1\"\n#define TEST_COMM \"test_progs\"\n\nstruct sk_stg {\n\t__u32 pid;\n\t__u32 last_notclose_state;\n\tchar comm[16];\n};\n\nstatic struct test_sk_storage_tracing *skel;\nstatic __u32 duration;\nstatic pid_t my_pid;\n\nstatic int check_sk_stg(int sk_fd, __u32 expected_state)\n{\n\tstruct sk_stg sk_stg;\n\tint err;\n\n\terr = bpf_map_lookup_elem(bpf_map__fd(skel->maps.sk_stg_map), &sk_fd,\n\t\t\t\t  &sk_stg);\n\tif (!ASSERT_OK(err, \"map_lookup(sk_stg_map)\"))\n\t\treturn -1;\n\n\tif (!ASSERT_EQ(sk_stg.last_notclose_state, expected_state,\n\t\t       \"last_notclose_state\"))\n\t\treturn -1;\n\n\tif (!ASSERT_EQ(sk_stg.pid, my_pid, \"pid\"))\n\t\treturn -1;\n\n\tif (!ASSERT_STREQ(sk_stg.comm, skel->bss->task_comm, \"task_comm\"))\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic void do_test(void)\n{\n\tint listen_fd = -1, passive_fd = -1, active_fd = -1, value = 1, err;\n\tchar abyte;\n\n\tlisten_fd = start_server(AF_INET6, SOCK_STREAM, LO_ADDR6, 0, 0);\n\tif (CHECK(listen_fd == -1, \"start_server\",\n\t\t  \"listen_fd:%d errno:%d\\n\", listen_fd, errno))\n\t\treturn;\n\n\tactive_fd = connect_to_fd(listen_fd, 0);\n\tif (CHECK(active_fd == -1, \"connect_to_fd\", \"active_fd:%d errno:%d\\n\",\n\t\t  active_fd, errno))\n\t\tgoto out;\n\n\terr = bpf_map_update_elem(bpf_map__fd(skel->maps.del_sk_stg_map),\n\t\t\t\t  &active_fd, &value, 0);\n\tif (!ASSERT_OK(err, \"map_update(del_sk_stg_map)\"))\n\t\tgoto out;\n\n\tpassive_fd = accept(listen_fd, NULL, 0);\n\tif (CHECK(passive_fd == -1, \"accept\", \"passive_fd:%d errno:%d\\n\",\n\t\t  passive_fd, errno))\n\t\tgoto out;\n\n\tshutdown(active_fd, SHUT_WR);\n\terr = read(passive_fd, &abyte, 1);\n\tif (!ASSERT_OK(err, \"read(passive_fd)\"))\n\t\tgoto out;\n\n\tshutdown(passive_fd, SHUT_WR);\n\terr = read(active_fd, &abyte, 1);\n\tif (!ASSERT_OK(err, \"read(active_fd)\"))\n\t\tgoto out;\n\n\terr = bpf_map_lookup_elem(bpf_map__fd(skel->maps.del_sk_stg_map),\n\t\t\t\t  &active_fd, &value);\n\tif (!ASSERT_ERR(err, \"map_lookup(del_sk_stg_map)\"))\n\t\tgoto out;\n\n\terr = check_sk_stg(listen_fd, BPF_TCP_LISTEN);\n\tif (!ASSERT_OK(err, \"listen_fd sk_stg\"))\n\t\tgoto out;\n\n\terr = check_sk_stg(active_fd, BPF_TCP_FIN_WAIT2);\n\tif (!ASSERT_OK(err, \"active_fd sk_stg\"))\n\t\tgoto out;\n\n\terr = check_sk_stg(passive_fd, BPF_TCP_LAST_ACK);\n\tASSERT_OK(err, \"passive_fd sk_stg\");\n\nout:\n\tif (active_fd != -1)\n\t\tclose(active_fd);\n\tif (passive_fd != -1)\n\t\tclose(passive_fd);\n\tif (listen_fd != -1)\n\t\tclose(listen_fd);\n}\n\nvoid serial_test_sk_storage_tracing(void)\n{\n\tstruct test_sk_storage_trace_itself *skel_itself;\n\tint err;\n\n\tmy_pid = getpid();\n\n\tskel_itself = test_sk_storage_trace_itself__open_and_load();\n\n\tif (!ASSERT_NULL(skel_itself, \"test_sk_storage_trace_itself\")) {\n\t\ttest_sk_storage_trace_itself__destroy(skel_itself);\n\t\treturn;\n\t}\n\n\tskel = test_sk_storage_tracing__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"test_sk_storage_tracing\"))\n\t\treturn;\n\n\terr = test_sk_storage_tracing__attach(skel);\n\tif (!ASSERT_OK(err, \"test_sk_storage_tracing__attach\")) {\n\t\ttest_sk_storage_tracing__destroy(skel);\n\t\treturn;\n\t}\n\n\tdo_test();\n\n\ttest_sk_storage_tracing__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}