{
  "module_name": "attach_probe.c",
  "hash_id": "c3935970bd0241dbe2490d45b8ffb1242db2540ba179162c91b50853f3f0f762",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/attach_probe.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"test_attach_kprobe_sleepable.skel.h\"\n#include \"test_attach_probe_manual.skel.h\"\n#include \"test_attach_probe.skel.h\"\n\n \nvolatile unsigned short uprobe_ref_ctr __attribute__((unused)) __attribute((section(\".probes\")));\n\n \nstatic noinline void trigger_func(void)\n{\n\tasm volatile (\"\");\n}\n\n \nstatic noinline void trigger_func2(void)\n{\n\tasm volatile (\"\");\n}\n\n \nstatic noinline void trigger_func3(void)\n{\n\tasm volatile (\"\");\n}\n\n \nstatic noinline void trigger_func4(void)\n{\n\tasm volatile (\"\");\n}\n\nstatic char test_data[] = \"test_data\";\n\n \nstatic void test_attach_probe_manual(enum probe_attach_mode attach_mode)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_uprobe_opts, uprobe_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_kprobe_opts, kprobe_opts);\n\tstruct bpf_link *kprobe_link, *kretprobe_link;\n\tstruct bpf_link *uprobe_link, *uretprobe_link;\n\tstruct test_attach_probe_manual *skel;\n\tssize_t uprobe_offset;\n\n\tskel = test_attach_probe_manual__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"skel_kprobe_manual_open_and_load\"))\n\t\treturn;\n\n\tuprobe_offset = get_uprobe_offset(&trigger_func);\n\tif (!ASSERT_GE(uprobe_offset, 0, \"uprobe_offset\"))\n\t\tgoto cleanup;\n\n\t \n\tkprobe_opts.attach_mode = attach_mode;\n\tkprobe_opts.retprobe = false;\n\tkprobe_link = bpf_program__attach_kprobe_opts(skel->progs.handle_kprobe,\n\t\t\t\t\t\t      SYS_NANOSLEEP_KPROBE_NAME,\n\t\t\t\t\t\t      &kprobe_opts);\n\tif (!ASSERT_OK_PTR(kprobe_link, \"attach_kprobe\"))\n\t\tgoto cleanup;\n\tskel->links.handle_kprobe = kprobe_link;\n\n\tkprobe_opts.retprobe = true;\n\tkretprobe_link = bpf_program__attach_kprobe_opts(skel->progs.handle_kretprobe,\n\t\t\t\t\t\t\t SYS_NANOSLEEP_KPROBE_NAME,\n\t\t\t\t\t\t\t &kprobe_opts);\n\tif (!ASSERT_OK_PTR(kretprobe_link, \"attach_kretprobe\"))\n\t\tgoto cleanup;\n\tskel->links.handle_kretprobe = kretprobe_link;\n\n\t \n\tuprobe_opts.attach_mode = attach_mode;\n\tuprobe_opts.ref_ctr_offset = 0;\n\tuprobe_opts.retprobe = false;\n\tuprobe_link = bpf_program__attach_uprobe_opts(skel->progs.handle_uprobe,\n\t\t\t\t\t\t      0  ,\n\t\t\t\t\t\t      \"/proc/self/exe\",\n\t\t\t\t\t\t      uprobe_offset,\n\t\t\t\t\t\t      &uprobe_opts);\n\tif (!ASSERT_OK_PTR(uprobe_link, \"attach_uprobe\"))\n\t\tgoto cleanup;\n\tskel->links.handle_uprobe = uprobe_link;\n\n\tuprobe_opts.retprobe = true;\n\turetprobe_link = bpf_program__attach_uprobe_opts(skel->progs.handle_uretprobe,\n\t\t\t\t\t\t\t -1  ,\n\t\t\t\t\t\t\t \"/proc/self/exe\",\n\t\t\t\t\t\t\t uprobe_offset, &uprobe_opts);\n\tif (!ASSERT_OK_PTR(uretprobe_link, \"attach_uretprobe\"))\n\t\tgoto cleanup;\n\tskel->links.handle_uretprobe = uretprobe_link;\n\n\t \n\tuprobe_opts.func_name = \"trigger_func2\";\n\tuprobe_opts.retprobe = false;\n\tuprobe_opts.ref_ctr_offset = 0;\n\tskel->links.handle_uprobe_byname =\n\t\t\tbpf_program__attach_uprobe_opts(skel->progs.handle_uprobe_byname,\n\t\t\t\t\t\t\t0  ,\n\t\t\t\t\t\t\t\"/proc/self/exe\",\n\t\t\t\t\t\t\t0, &uprobe_opts);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uprobe_byname, \"attach_uprobe_byname\"))\n\t\tgoto cleanup;\n\n\t \n\tusleep(1);\n\n\t \n\ttrigger_func();\n\n\t \n\ttrigger_func2();\n\n\tASSERT_EQ(skel->bss->kprobe_res, 1, \"check_kprobe_res\");\n\tASSERT_EQ(skel->bss->kretprobe_res, 2, \"check_kretprobe_res\");\n\tASSERT_EQ(skel->bss->uprobe_res, 3, \"check_uprobe_res\");\n\tASSERT_EQ(skel->bss->uretprobe_res, 4, \"check_uretprobe_res\");\n\tASSERT_EQ(skel->bss->uprobe_byname_res, 5, \"check_uprobe_byname_res\");\n\ncleanup:\n\ttest_attach_probe_manual__destroy(skel);\n}\n\nstatic void test_attach_probe_auto(struct test_attach_probe *skel)\n{\n\tstruct bpf_link *uprobe_err_link;\n\n\t \n\tskel->links.handle_kprobe_auto = bpf_program__attach(skel->progs.handle_kprobe_auto);\n\tASSERT_OK_PTR(skel->links.handle_kprobe_auto, \"attach_kprobe_auto\");\n\n\tskel->links.handle_kretprobe_auto = bpf_program__attach(skel->progs.handle_kretprobe_auto);\n\tASSERT_OK_PTR(skel->links.handle_kretprobe_auto, \"attach_kretprobe_auto\");\n\n\t \n\tuprobe_err_link = bpf_program__attach(skel->progs.handle_uprobe_byname);\n\tif (!ASSERT_EQ(libbpf_get_error(uprobe_err_link), -EOPNOTSUPP,\n\t\t       \"auto-attach should fail for old-style name\"))\n\t\treturn;\n\n\t \n\tskel->links.handle_uretprobe_byname =\n\t\t\tbpf_program__attach(skel->progs.handle_uretprobe_byname);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uretprobe_byname, \"attach_uretprobe_byname\"))\n\t\treturn;\n\n\t \n\tusleep(1);\n\n\t \n\ttrigger_func2();\n\n\tASSERT_EQ(skel->bss->kprobe2_res, 11, \"check_kprobe_auto_res\");\n\tASSERT_EQ(skel->bss->kretprobe2_res, 22, \"check_kretprobe_auto_res\");\n\tASSERT_EQ(skel->bss->uretprobe_byname_res, 6, \"check_uretprobe_byname_res\");\n}\n\nstatic void test_uprobe_lib(struct test_attach_probe *skel)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_uprobe_opts, uprobe_opts);\n\tFILE *devnull;\n\n\t \n\tuprobe_opts.func_name = \"fopen\";\n\tuprobe_opts.retprobe = false;\n\tskel->links.handle_uprobe_byname2 =\n\t\t\tbpf_program__attach_uprobe_opts(skel->progs.handle_uprobe_byname2,\n\t\t\t\t\t\t\t0  ,\n\t\t\t\t\t\t\t\"libc.so.6\",\n\t\t\t\t\t\t\t0, &uprobe_opts);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uprobe_byname2, \"attach_uprobe_byname2\"))\n\t\treturn;\n\n\tuprobe_opts.func_name = \"fclose\";\n\tuprobe_opts.retprobe = true;\n\tskel->links.handle_uretprobe_byname2 =\n\t\t\tbpf_program__attach_uprobe_opts(skel->progs.handle_uretprobe_byname2,\n\t\t\t\t\t\t\t-1  ,\n\t\t\t\t\t\t\t\"libc.so.6\",\n\t\t\t\t\t\t\t0, &uprobe_opts);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uretprobe_byname2, \"attach_uretprobe_byname2\"))\n\t\treturn;\n\n\t \n\tdevnull = fopen(\"/dev/null\", \"r\");\n\tfclose(devnull);\n\n\tASSERT_EQ(skel->bss->uprobe_byname2_res, 7, \"check_uprobe_byname2_res\");\n\tASSERT_EQ(skel->bss->uretprobe_byname2_res, 8, \"check_uretprobe_byname2_res\");\n}\n\nstatic void test_uprobe_ref_ctr(struct test_attach_probe *skel)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_uprobe_opts, uprobe_opts);\n\tstruct bpf_link *uprobe_link, *uretprobe_link;\n\tssize_t uprobe_offset, ref_ctr_offset;\n\n\tuprobe_offset = get_uprobe_offset(&trigger_func4);\n\tif (!ASSERT_GE(uprobe_offset, 0, \"uprobe_offset_ref_ctr\"))\n\t\treturn;\n\n\tref_ctr_offset = get_rel_offset((uintptr_t)&uprobe_ref_ctr);\n\tif (!ASSERT_GE(ref_ctr_offset, 0, \"ref_ctr_offset\"))\n\t\treturn;\n\n\tASSERT_EQ(uprobe_ref_ctr, 0, \"uprobe_ref_ctr_before\");\n\n\tuprobe_opts.retprobe = false;\n\tuprobe_opts.ref_ctr_offset = ref_ctr_offset;\n\tuprobe_link = bpf_program__attach_uprobe_opts(skel->progs.handle_uprobe_ref_ctr,\n\t\t\t\t\t\t      0  ,\n\t\t\t\t\t\t      \"/proc/self/exe\",\n\t\t\t\t\t\t      uprobe_offset,\n\t\t\t\t\t\t      &uprobe_opts);\n\tif (!ASSERT_OK_PTR(uprobe_link, \"attach_uprobe_ref_ctr\"))\n\t\treturn;\n\tskel->links.handle_uprobe_ref_ctr = uprobe_link;\n\n\tASSERT_GT(uprobe_ref_ctr, 0, \"uprobe_ref_ctr_after\");\n\n\t \n\tuprobe_opts.retprobe = true;\n\tuprobe_opts.ref_ctr_offset = ref_ctr_offset;\n\turetprobe_link = bpf_program__attach_uprobe_opts(skel->progs.handle_uretprobe_ref_ctr,\n\t\t\t\t\t\t\t -1  ,\n\t\t\t\t\t\t\t \"/proc/self/exe\",\n\t\t\t\t\t\t\t uprobe_offset, &uprobe_opts);\n\tif (!ASSERT_OK_PTR(uretprobe_link, \"attach_uretprobe_ref_ctr\"))\n\t\treturn;\n\tskel->links.handle_uretprobe_ref_ctr = uretprobe_link;\n}\n\nstatic void test_kprobe_sleepable(void)\n{\n\tstruct test_attach_kprobe_sleepable *skel;\n\n\tskel = test_attach_kprobe_sleepable__open();\n\tif (!ASSERT_OK_PTR(skel, \"skel_kprobe_sleepable_open\"))\n\t\treturn;\n\n\t \n\tif (!ASSERT_OK(bpf_program__set_flags(skel->progs.handle_kprobe_sleepable,\n\t\tBPF_F_SLEEPABLE), \"kprobe_sleepable_flags\"))\n\t\tgoto cleanup;\n\n\tif (!ASSERT_OK(test_attach_kprobe_sleepable__load(skel),\n\t\t       \"skel_kprobe_sleepable_load\"))\n\t\tgoto cleanup;\n\n\t \n\tskel->links.handle_kprobe_sleepable = bpf_program__attach(skel->progs.handle_kprobe_sleepable);\n\tASSERT_ERR_PTR(skel->links.handle_kprobe_sleepable, \"attach_kprobe_sleepable\");\n\ncleanup:\n\ttest_attach_kprobe_sleepable__destroy(skel);\n}\n\nstatic void test_uprobe_sleepable(struct test_attach_probe *skel)\n{\n\t \n\tskel->links.handle_uprobe_byname3_sleepable = bpf_program__attach(skel->progs.handle_uprobe_byname3_sleepable);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uprobe_byname3_sleepable, \"attach_uprobe_byname3_sleepable\"))\n\t\treturn;\n\n\tskel->links.handle_uprobe_byname3 = bpf_program__attach(skel->progs.handle_uprobe_byname3);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uprobe_byname3, \"attach_uprobe_byname3\"))\n\t\treturn;\n\n\tskel->links.handle_uretprobe_byname3_sleepable = bpf_program__attach(skel->progs.handle_uretprobe_byname3_sleepable);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uretprobe_byname3_sleepable, \"attach_uretprobe_byname3_sleepable\"))\n\t\treturn;\n\n\tskel->links.handle_uretprobe_byname3 = bpf_program__attach(skel->progs.handle_uretprobe_byname3);\n\tif (!ASSERT_OK_PTR(skel->links.handle_uretprobe_byname3, \"attach_uretprobe_byname3\"))\n\t\treturn;\n\n\tskel->bss->user_ptr = test_data;\n\n\t \n\ttrigger_func3();\n\n\tASSERT_EQ(skel->bss->uprobe_byname3_sleepable_res, 9, \"check_uprobe_byname3_sleepable_res\");\n\tASSERT_EQ(skel->bss->uprobe_byname3_res, 10, \"check_uprobe_byname3_res\");\n\tASSERT_EQ(skel->bss->uretprobe_byname3_sleepable_res, 11, \"check_uretprobe_byname3_sleepable_res\");\n\tASSERT_EQ(skel->bss->uretprobe_byname3_res, 12, \"check_uretprobe_byname3_res\");\n}\n\nvoid test_attach_probe(void)\n{\n\tstruct test_attach_probe *skel;\n\n\tskel = test_attach_probe__open();\n\tif (!ASSERT_OK_PTR(skel, \"skel_open\"))\n\t\treturn;\n\n\tif (!ASSERT_OK(test_attach_probe__load(skel), \"skel_load\"))\n\t\tgoto cleanup;\n\tif (!ASSERT_OK_PTR(skel->bss, \"check_bss\"))\n\t\tgoto cleanup;\n\n\tif (test__start_subtest(\"manual-default\"))\n\t\ttest_attach_probe_manual(PROBE_ATTACH_MODE_DEFAULT);\n\tif (test__start_subtest(\"manual-legacy\"))\n\t\ttest_attach_probe_manual(PROBE_ATTACH_MODE_LEGACY);\n\tif (test__start_subtest(\"manual-perf\"))\n\t\ttest_attach_probe_manual(PROBE_ATTACH_MODE_PERF);\n\tif (test__start_subtest(\"manual-link\"))\n\t\ttest_attach_probe_manual(PROBE_ATTACH_MODE_LINK);\n\n\tif (test__start_subtest(\"auto\"))\n\t\ttest_attach_probe_auto(skel);\n\tif (test__start_subtest(\"kprobe-sleepable\"))\n\t\ttest_kprobe_sleepable();\n\tif (test__start_subtest(\"uprobe-lib\"))\n\t\ttest_uprobe_lib(skel);\n\tif (test__start_subtest(\"uprobe-sleepable\"))\n\t\ttest_uprobe_sleepable(skel);\n\tif (test__start_subtest(\"uprobe-ref_ctr\"))\n\t\ttest_uprobe_ref_ctr(skel);\n\ncleanup:\n\ttest_attach_probe__destroy(skel);\n\tASSERT_EQ(uprobe_ref_ctr, 0, \"uprobe_ref_ctr_cleanup\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}