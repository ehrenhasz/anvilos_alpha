{
  "module_name": "pe_preserve_elems.c",
  "hash_id": "d5fb18ae6aebd2d5c5a47046e39b16c4c86bb85d5f7dc100b0f499f77f8f43a4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/pe_preserve_elems.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include <linux/bpf.h>\n#include \"test_pe_preserve_elems.skel.h\"\n\nstatic int duration;\n\nstatic void test_one_map(struct bpf_map *map, struct bpf_program *prog,\n\t\t\t bool has_share_pe)\n{\n\tint err, key = 0, pfd = -1, mfd = bpf_map__fd(map);\n\tDECLARE_LIBBPF_OPTS(bpf_test_run_opts, opts);\n\tstruct perf_event_attr attr = {\n\t\t.size = sizeof(struct perf_event_attr),\n\t\t.type = PERF_TYPE_SOFTWARE,\n\t\t.config = PERF_COUNT_SW_CPU_CLOCK,\n\t};\n\n\tpfd = syscall(__NR_perf_event_open, &attr, 0  ,\n\t\t      -1  , -1  , 0  );\n\tif (CHECK(pfd < 0, \"perf_event_open\", \"failed\\n\"))\n\t\treturn;\n\n\terr = bpf_map_update_elem(mfd, &key, &pfd, BPF_ANY);\n\tclose(pfd);\n\tif (CHECK(err < 0, \"bpf_map_update_elem\", \"failed\\n\"))\n\t\treturn;\n\n\terr = bpf_prog_test_run_opts(bpf_program__fd(prog), &opts);\n\tif (CHECK(err < 0, \"bpf_prog_test_run_opts\", \"failed\\n\"))\n\t\treturn;\n\tif (CHECK(opts.retval != 0, \"bpf_perf_event_read_value\",\n\t\t  \"failed with %d\\n\", opts.retval))\n\t\treturn;\n\n\t \n\tclose(mfd);\n\n\terr = bpf_prog_test_run_opts(bpf_program__fd(prog), &opts);\n\tif (CHECK(err < 0, \"bpf_prog_test_run_opts\", \"failed\\n\"))\n\t\treturn;\n\n\tif (has_share_pe) {\n\t\tCHECK(opts.retval != 0, \"bpf_perf_event_read_value\",\n\t\t      \"failed with %d\\n\", opts.retval);\n\t} else {\n\t\tCHECK(opts.retval != -ENOENT, \"bpf_perf_event_read_value\",\n\t\t      \"should have failed with %d, but got %d\\n\", -ENOENT,\n\t\t      opts.retval);\n\t}\n}\n\nvoid test_pe_preserve_elems(void)\n{\n\tstruct test_pe_preserve_elems *skel;\n\n\tskel = test_pe_preserve_elems__open_and_load();\n\tif (CHECK(!skel, \"skel_open\", \"failed to open skeleton\\n\"))\n\t\treturn;\n\n\ttest_one_map(skel->maps.array_1, skel->progs.read_array_1, false);\n\ttest_one_map(skel->maps.array_2, skel->progs.read_array_2, true);\n\n\ttest_pe_preserve_elems__destroy(skel);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}