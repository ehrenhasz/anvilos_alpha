{
  "module_name": "sockopt.c",
  "hash_id": "502c1c2406710b807595ac4697295c8ac058d4fa0f2becd335c61203ebfe1eb4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/sockopt.c",
  "human_readable_source": "\n#include <test_progs.h>\n#include \"cgroup_helpers.h\"\n\nstatic char bpf_log_buf[4096];\nstatic bool verbose;\n\n#ifndef PAGE_SIZE\n#define PAGE_SIZE 4096\n#endif\n\nenum sockopt_test_error {\n\tOK = 0,\n\tDENY_LOAD,\n\tDENY_ATTACH,\n\tEOPNOTSUPP_GETSOCKOPT,\n\tEPERM_GETSOCKOPT,\n\tEFAULT_GETSOCKOPT,\n\tEPERM_SETSOCKOPT,\n\tEFAULT_SETSOCKOPT,\n};\n\nstatic struct sockopt_test {\n\tconst char\t\t\t*descr;\n\tconst struct bpf_insn\t\tinsns[64];\n\tenum bpf_attach_type\t\tattach_type;\n\tenum bpf_attach_type\t\texpected_attach_type;\n\n\tint\t\t\t\tset_optname;\n\tint\t\t\t\tset_level;\n\tconst char\t\t\tset_optval[64];\n\tsocklen_t\t\t\tset_optlen;\n\n\tint\t\t\t\tget_optname;\n\tint\t\t\t\tget_level;\n\tconst char\t\t\tget_optval[64];\n\tsocklen_t\t\t\tget_optlen;\n\tsocklen_t\t\t\tget_optlen_ret;\n\n\tenum sockopt_test_error\t\terror;\n} tests[] = {\n\n\t \n\n\t{\n\t\t.descr = \"getsockopt: no expected_attach_type\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = 0,\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"getsockopt: wrong expected_attach_type\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.error = DENY_ATTACH,\n\t},\n\t{\n\t\t.descr = \"getsockopt: bypass bpf hook\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = SOL_IP,\n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optval = { 1 << 3 },\n\t\t.set_optlen = 1,\n\n\t\t.get_optval = { 1 << 3 },\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"getsockopt: return EPERM from bpf hook\",\n\t\t.insns = {\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.get_optname = IP_TOS,\n\n\t\t.get_optlen = 1,\n\t\t.error = EPERM_GETSOCKOPT,\n\t},\n\t{\n\t\t.descr = \"getsockopt: no optval bounds check, deny loading\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0x80),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_0, 0),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"getsockopt: read ctx->level\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, level)),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_6, 123, 4),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_level = 123,\n\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"getsockopt: deny writing to ctx->level\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, level)),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"getsockopt: read ctx->optname\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optname)),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_6, 123, 4),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_optname = 123,\n\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"getsockopt: read ctx->retval\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.get_optname = IP_TOS,\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"getsockopt: deny writing to ctx->optname\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optname)),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"getsockopt: read ctx->optlen\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_6, 64, 4),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_optlen = 64,\n\t},\n\t{\n\t\t.descr = \"getsockopt: deny bigger ctx->optlen\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 65),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_optlen = 64,\n\n\t\t.error = EFAULT_GETSOCKOPT,\n\t},\n\t{\n\t\t.descr = \"getsockopt: ignore >PAGE_SIZE optlen\",\n\t\t.insns = {\n\t\t\t \n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_6),\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 1),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\n\t\t\t \n\t\t\tBPF_JMP_REG(BPF_JGT, BPF_REG_6, BPF_REG_7, 1),\n\t\t\t \n\t\t\tBPF_ST_MEM(BPF_B, BPF_REG_2, 0, 0xFF),\n\t\t\t \n\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 5),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_level = 1234,\n\t\t.get_optname = 5678,\n\t\t.get_optval = {},  \n\t\t.get_optlen = PAGE_SIZE + 1,\n\t\t.error = EOPNOTSUPP_GETSOCKOPT,\n\t},\n\t{\n\t\t.descr = \"getsockopt: support smaller ctx->optlen\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 32),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_optlen = 64,\n\t\t.get_optlen_ret = 32,\n\t},\n\t{\n\t\t.descr = \"getsockopt: deny writing to ctx->optval\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"getsockopt: deny writing to ctx->optval_end\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"getsockopt: rewrite value\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_6),\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 1),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\n\t\t\t \n\t\t\tBPF_JMP_REG(BPF_JGT, BPF_REG_6, BPF_REG_7, 1),\n\t\t\t \n\t\t\tBPF_ST_MEM(BPF_B, BPF_REG_2, 0, 0xF0),\n\t\t\t \n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.get_optname = IP_TOS,\n\n\t\t.get_optval = { 0xF0 },\n\t\t.get_optlen = 1,\n\t},\n\n\t \n\n\t{\n\t\t.descr = \"setsockopt: no expected_attach_type\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = 0,\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"setsockopt: wrong expected_attach_type\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_GETSOCKOPT,\n\t\t.error = DENY_ATTACH,\n\t},\n\t{\n\t\t.descr = \"setsockopt: bypass bpf hook\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = SOL_IP,\n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optval = { 1 << 3 },\n\t\t.set_optlen = 1,\n\n\t\t.get_optval = { 1 << 3 },\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: return EPERM from bpf hook\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_level = SOL_IP,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optlen = 1,\n\t\t.error = EPERM_SETSOCKOPT,\n\t},\n\t{\n\t\t.descr = \"setsockopt: no optval bounds check, deny loading\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_0, BPF_REG_6, 0),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"setsockopt: read ctx->level\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, level)),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_6, 123, 4),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, -1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_level = 123,\n\n\t\t.set_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: allow changing ctx->level\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, SOL_IP),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, level)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = 234,  \n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optval = { 1 << 3 },\n\t\t.set_optlen = 1,\n\t\t.get_optval = { 1 << 3 },\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: read ctx->optname\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optname)),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_6, 123, 4),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, -1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_optname = 123,\n\n\t\t.set_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: allow changing ctx->optname\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, IP_TOS),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optname)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = SOL_IP,\n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = 456,  \n\n\t\t.set_optval = { 1 << 3 },\n\t\t.set_optlen = 1,\n\t\t.get_optval = { 1 << 3 },\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: read ctx->optlen\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_6, 64, 4),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, -1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_optlen = 64,\n\t},\n\t{\n\t\t.descr = \"setsockopt: ctx->optlen == -1 is ok\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, -1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_optlen = 64,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny ctx->optlen < 0 (except -1)\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, -2),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_optlen = 4,\n\n\t\t.error = EFAULT_SETSOCKOPT,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny ctx->optlen > input optlen\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 65),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_optlen = 64,\n\n\t\t.error = EFAULT_SETSOCKOPT,\n\t},\n\t{\n\t\t.descr = \"setsockopt: ignore >PAGE_SIZE optlen\",\n\t\t.insns = {\n\t\t\t \n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_6),\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 1),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\n\t\t\t \n\t\t\tBPF_JMP_REG(BPF_JGT, BPF_REG_6, BPF_REG_7, 1),\n\t\t\t \n\t\t\tBPF_ST_MEM(BPF_B, BPF_REG_2, 0, 0xF0),\n\t\t\t \n\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.set_level = SOL_IP,\n\t\t.set_optname = IP_TOS,\n\t\t.set_optval = {},\n\t\t.set_optlen = PAGE_SIZE + 1,\n\n\t\t.get_level = SOL_IP,\n\t\t.get_optname = IP_TOS,\n\t\t.get_optval = {},  \n\t\t.get_optlen = 4,\n\t},\n\t{\n\t\t.descr = \"setsockopt: allow changing ctx->optlen within bounds\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_6),\n\t\t\t \n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 1),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\n\t\t\t \n\t\t\tBPF_JMP_REG(BPF_JGT, BPF_REG_6, BPF_REG_7, 1),\n\t\t\t \n\t\t\tBPF_ST_MEM(BPF_B, BPF_REG_2, 0, 1 << 3),\n\t\t\t \n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optlen)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = SOL_IP,\n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optval = { 1, 1, 1, 1 },\n\t\t.set_optlen = 4,\n\t\t.get_optval = { 1 << 3 },\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny write ctx->retval\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\tBPF_STX_MEM(BPF_W, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny read ctx->retval\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_W, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, retval)),\n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny writing to ctx->optval\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny writing to ctx->optval_end\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_STX_MEM(BPF_DW, BPF_REG_1, BPF_REG_0,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.error = DENY_LOAD,\n\t},\n\t{\n\t\t.descr = \"setsockopt: allow IP_TOS <= 128\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_6),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 1),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\n\t\t\t \n\t\t\tBPF_JMP_REG(BPF_JGT, BPF_REG_7, BPF_REG_8, 4),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_B, BPF_REG_9, BPF_REG_6, 0),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JGT, BPF_REG_9, 128, 2),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = SOL_IP,\n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optval = { 0x80 },\n\t\t.set_optlen = 1,\n\t\t.get_optval = { 0x80 },\n\t\t.get_optlen = 1,\n\t},\n\t{\n\t\t.descr = \"setsockopt: deny IP_TOS > 128\",\n\t\t.insns = {\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval)),\n\t\t\t \n\t\t\tBPF_MOV64_REG(BPF_REG_7, BPF_REG_6),\n\t\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 1),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_1,\n\t\t\t\t    offsetof(struct bpf_sockopt, optval_end)),\n\n\t\t\t \n\t\t\tBPF_JMP_REG(BPF_JGT, BPF_REG_7, BPF_REG_8, 4),\n\n\t\t\t \n\t\t\tBPF_LDX_MEM(BPF_B, BPF_REG_9, BPF_REG_6, 0),\n\n\t\t\t \n\t\t\tBPF_JMP_IMM(BPF_JGT, BPF_REG_9, 128, 2),\n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\t\tBPF_JMP_A(1),\n\t\t\t \n\n\t\t\t \n\t\t\tBPF_MOV64_IMM(BPF_REG_0, 0),\n\t\t\t \n\n\t\t\tBPF_EXIT_INSN(),\n\t\t},\n\t\t.attach_type = BPF_CGROUP_SETSOCKOPT,\n\t\t.expected_attach_type = BPF_CGROUP_SETSOCKOPT,\n\n\t\t.get_level = SOL_IP,\n\t\t.set_level = SOL_IP,\n\n\t\t.get_optname = IP_TOS,\n\t\t.set_optname = IP_TOS,\n\n\t\t.set_optval = { 0x81 },\n\t\t.set_optlen = 1,\n\t\t.get_optval = { 0x00 },\n\t\t.get_optlen = 1,\n\n\t\t.error = EPERM_SETSOCKOPT,\n\t},\n};\n\nstatic int load_prog(const struct bpf_insn *insns,\n\t\t     enum bpf_attach_type expected_attach_type)\n{\n\tLIBBPF_OPTS(bpf_prog_load_opts, opts,\n\t\t.expected_attach_type = expected_attach_type,\n\t\t.log_level = 2,\n\t\t.log_buf = bpf_log_buf,\n\t\t.log_size = sizeof(bpf_log_buf),\n\t);\n\tint fd, insns_cnt = 0;\n\n\tfor (;\n\t     insns[insns_cnt].code != (BPF_JMP | BPF_EXIT);\n\t     insns_cnt++) {\n\t}\n\tinsns_cnt++;\n\n\tfd = bpf_prog_load(BPF_PROG_TYPE_CGROUP_SOCKOPT, NULL, \"GPL\", insns, insns_cnt, &opts);\n\tif (verbose && fd < 0)\n\t\tfprintf(stderr, \"%s\\n\", bpf_log_buf);\n\n\treturn fd;\n}\n\nstatic int run_test(int cgroup_fd, struct sockopt_test *test)\n{\n\tint sock_fd, err, prog_fd;\n\tvoid *optval = NULL;\n\tint ret = 0;\n\n\tprog_fd = load_prog(test->insns, test->expected_attach_type);\n\tif (prog_fd < 0) {\n\t\tif (test->error == DENY_LOAD)\n\t\t\treturn 0;\n\n\t\tlog_err(\"Failed to load BPF program\");\n\t\treturn -1;\n\t}\n\n\terr = bpf_prog_attach(prog_fd, cgroup_fd, test->attach_type, 0);\n\tif (err < 0) {\n\t\tif (test->error == DENY_ATTACH)\n\t\t\tgoto close_prog_fd;\n\n\t\tlog_err(\"Failed to attach BPF program\");\n\t\tret = -1;\n\t\tgoto close_prog_fd;\n\t}\n\n\tsock_fd = socket(AF_INET, SOCK_STREAM, 0);\n\tif (sock_fd < 0) {\n\t\tlog_err(\"Failed to create AF_INET socket\");\n\t\tret = -1;\n\t\tgoto detach_prog;\n\t}\n\n\tif (test->set_optlen) {\n\t\tif (test->set_optlen >= PAGE_SIZE) {\n\t\t\tint num_pages = test->set_optlen / PAGE_SIZE;\n\t\t\tint remainder = test->set_optlen % PAGE_SIZE;\n\n\t\t\ttest->set_optlen = num_pages * sysconf(_SC_PAGESIZE) + remainder;\n\t\t}\n\n\t\terr = setsockopt(sock_fd, test->set_level, test->set_optname,\n\t\t\t\t test->set_optval, test->set_optlen);\n\t\tif (err) {\n\t\t\tif (errno == EPERM && test->error == EPERM_SETSOCKOPT)\n\t\t\t\tgoto close_sock_fd;\n\t\t\tif (errno == EFAULT && test->error == EFAULT_SETSOCKOPT)\n\t\t\t\tgoto free_optval;\n\n\t\t\tlog_err(\"Failed to call setsockopt\");\n\t\t\tret = -1;\n\t\t\tgoto close_sock_fd;\n\t\t}\n\t}\n\n\tif (test->get_optlen) {\n\t\tif (test->get_optlen >= PAGE_SIZE) {\n\t\t\tint num_pages = test->get_optlen / PAGE_SIZE;\n\t\t\tint remainder = test->get_optlen % PAGE_SIZE;\n\n\t\t\ttest->get_optlen = num_pages * sysconf(_SC_PAGESIZE) + remainder;\n\t\t}\n\n\t\toptval = malloc(test->get_optlen);\n\t\tmemset(optval, 0, test->get_optlen);\n\t\tsocklen_t optlen = test->get_optlen;\n\t\tsocklen_t expected_get_optlen = test->get_optlen_ret ?:\n\t\t\ttest->get_optlen;\n\n\t\terr = getsockopt(sock_fd, test->get_level, test->get_optname,\n\t\t\t\t optval, &optlen);\n\t\tif (err) {\n\t\t\tif (errno == EOPNOTSUPP && test->error == EOPNOTSUPP_GETSOCKOPT)\n\t\t\t\tgoto free_optval;\n\t\t\tif (errno == EPERM && test->error == EPERM_GETSOCKOPT)\n\t\t\t\tgoto free_optval;\n\t\t\tif (errno == EFAULT && test->error == EFAULT_GETSOCKOPT)\n\t\t\t\tgoto free_optval;\n\n\t\t\tlog_err(\"Failed to call getsockopt\");\n\t\t\tret = -1;\n\t\t\tgoto free_optval;\n\t\t}\n\n\t\tif (optlen != expected_get_optlen) {\n\t\t\terrno = 0;\n\t\t\tlog_err(\"getsockopt returned unexpected optlen\");\n\t\t\tret = -1;\n\t\t\tgoto free_optval;\n\t\t}\n\n\t\tif (memcmp(optval, test->get_optval, optlen) != 0) {\n\t\t\terrno = 0;\n\t\t\tlog_err(\"getsockopt returned unexpected optval\");\n\t\t\tret = -1;\n\t\t\tgoto free_optval;\n\t\t}\n\t}\n\n\tret = test->error != OK;\n\nfree_optval:\n\tfree(optval);\nclose_sock_fd:\n\tclose(sock_fd);\ndetach_prog:\n\tbpf_prog_detach2(prog_fd, cgroup_fd, test->attach_type);\nclose_prog_fd:\n\tclose(prog_fd);\n\treturn ret;\n}\n\nvoid test_sockopt(void)\n{\n\tint cgroup_fd, i;\n\n\tcgroup_fd = test__join_cgroup(\"/sockopt\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup\"))\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); i++) {\n\t\tif (!test__start_subtest(tests[i].descr))\n\t\t\tcontinue;\n\n\t\tASSERT_OK(run_test(cgroup_fd, &tests[i]), tests[i].descr);\n\t}\n\n\tclose(cgroup_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}