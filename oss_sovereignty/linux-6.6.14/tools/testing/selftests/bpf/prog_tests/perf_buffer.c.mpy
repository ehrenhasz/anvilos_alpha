{
  "module_name": "perf_buffer.c",
  "hash_id": "87612736e4efbeab5b8e29e1764c030d8b0be1d73456dd3e8274783844dcb7ee",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/perf_buffer.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <pthread.h>\n#include <sched.h>\n#include <sys/socket.h>\n#include <test_progs.h>\n#include \"test_perf_buffer.skel.h\"\n#include \"bpf/libbpf_internal.h\"\n\nstatic int duration;\n\n \n__attribute__((no_sanitize_address))\nstatic void on_sample(void *ctx, int cpu, void *data, __u32 size)\n{\n\tint cpu_data = *(int *)data, duration = 0;\n\tcpu_set_t *cpu_seen = ctx;\n\n\tif (cpu_data != cpu)\n\t\tCHECK(cpu_data != cpu, \"check_cpu_data\",\n\t\t      \"cpu_data %d != cpu %d\\n\", cpu_data, cpu);\n\n\tCPU_SET(cpu, cpu_seen);\n}\n\nint trigger_on_cpu(int cpu)\n{\n\tcpu_set_t cpu_set;\n\tint err;\n\n\tCPU_ZERO(&cpu_set);\n\tCPU_SET(cpu, &cpu_set);\n\n\terr = pthread_setaffinity_np(pthread_self(), sizeof(cpu_set), &cpu_set);\n\tif (err && CHECK(err, \"set_affinity\", \"cpu #%d, err %d\\n\", cpu, err))\n\t\treturn err;\n\n\tusleep(1);\n\n\treturn 0;\n}\n\nvoid serial_test_perf_buffer(void)\n{\n\tint err, on_len, nr_on_cpus = 0, nr_cpus, i, j;\n\tint zero = 0, my_pid = getpid();\n\tstruct test_perf_buffer *skel;\n\tcpu_set_t cpu_seen;\n\tstruct perf_buffer *pb;\n\tint last_fd = -1, fd;\n\tbool *online;\n\n\tnr_cpus = libbpf_num_possible_cpus();\n\tif (CHECK(nr_cpus < 0, \"nr_cpus\", \"err %d\\n\", nr_cpus))\n\t\treturn;\n\n\terr = parse_cpu_mask_file(\"/sys/devices/system/cpu/online\",\n\t\t\t\t  &online, &on_len);\n\tif (CHECK(err, \"nr_on_cpus\", \"err %d\\n\", err))\n\t\treturn;\n\n\tfor (i = 0; i < on_len; i++)\n\t\tif (online[i])\n\t\t\tnr_on_cpus++;\n\n\t \n\tskel = test_perf_buffer__open_and_load();\n\tif (CHECK(!skel, \"skel_load\", \"skeleton open/load failed\\n\"))\n\t\tgoto out_close;\n\n\terr = bpf_map_update_elem(bpf_map__fd(skel->maps.my_pid_map), &zero, &my_pid, 0);\n\tif (!ASSERT_OK(err, \"my_pid_update\"))\n\t\tgoto out_close;\n\n\t \n\terr = test_perf_buffer__attach(skel);\n\tif (CHECK(err, \"attach_kprobe\", \"err %d\\n\", err))\n\t\tgoto out_close;\n\n\t \n\tpb = perf_buffer__new(bpf_map__fd(skel->maps.perf_buf_map), 1,\n\t\t\t      on_sample, NULL, &cpu_seen, NULL);\n\tif (!ASSERT_OK_PTR(pb, \"perf_buf__new\"))\n\t\tgoto out_close;\n\n\tCHECK(perf_buffer__epoll_fd(pb) < 0, \"epoll_fd\",\n\t      \"bad fd: %d\\n\", perf_buffer__epoll_fd(pb));\n\n\t \n\tCPU_ZERO(&cpu_seen);\n\tfor (i = 0; i < nr_cpus; i++) {\n\t\tif (i >= on_len || !online[i]) {\n\t\t\tprintf(\"skipping offline CPU #%d\\n\", i);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (trigger_on_cpu(i))\n\t\t\tgoto out_close;\n\t}\n\n\t \n\terr = perf_buffer__poll(pb, 100);\n\tif (CHECK(err < 0, \"perf_buffer__poll\", \"err %d\\n\", err))\n\t\tgoto out_free_pb;\n\n\tif (CHECK(CPU_COUNT(&cpu_seen) != nr_on_cpus, \"seen_cpu_cnt\",\n\t\t  \"expect %d, seen %d\\n\", nr_on_cpus, CPU_COUNT(&cpu_seen)))\n\t\tgoto out_free_pb;\n\n\tif (CHECK(perf_buffer__buffer_cnt(pb) != nr_on_cpus, \"buf_cnt\",\n\t\t  \"got %zu, expected %d\\n\", perf_buffer__buffer_cnt(pb), nr_on_cpus))\n\t\tgoto out_close;\n\n\tfor (i = 0, j = 0; i < nr_cpus; i++) {\n\t\tif (i >= on_len || !online[i])\n\t\t\tcontinue;\n\n\t\tfd = perf_buffer__buffer_fd(pb, j);\n\t\tCHECK(fd < 0 || last_fd == fd, \"fd_check\", \"last fd %d == fd %d\\n\", last_fd, fd);\n\t\tlast_fd = fd;\n\n\t\terr = perf_buffer__consume_buffer(pb, j);\n\t\tif (CHECK(err, \"drain_buf\", \"cpu %d, err %d\\n\", i, err))\n\t\t\tgoto out_close;\n\n\t\tCPU_CLR(i, &cpu_seen);\n\t\tif (trigger_on_cpu(i))\n\t\t\tgoto out_close;\n\n\t\terr = perf_buffer__consume_buffer(pb, j);\n\t\tif (CHECK(err, \"consume_buf\", \"cpu %d, err %d\\n\", j, err))\n\t\t\tgoto out_close;\n\n\t\tif (CHECK(!CPU_ISSET(i, &cpu_seen), \"cpu_seen\", \"cpu %d not seen\\n\", i))\n\t\t\tgoto out_close;\n\t\tj++;\n\t}\n\nout_free_pb:\n\tperf_buffer__free(pb);\nout_close:\n\ttest_perf_buffer__destroy(skel);\n\tfree(online);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}