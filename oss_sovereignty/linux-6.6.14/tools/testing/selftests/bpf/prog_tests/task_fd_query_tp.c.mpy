{
  "module_name": "task_fd_query_tp.c",
  "hash_id": "87b2e30a0422f43c3091d453c072924ab1dc833f73338a866075d5ec44228b63",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/task_fd_query_tp.c",
  "human_readable_source": "\n#include <test_progs.h>\n\nstatic void test_task_fd_query_tp_core(const char *probe_name,\n\t\t\t\t       const char *tp_name)\n{\n\tconst char *file = \"./test_tracepoint.bpf.o\";\n\tint err, bytes, efd, prog_fd, pmu_fd;\n\tstruct perf_event_attr attr = {};\n\t__u64 probe_offset, probe_addr;\n\t__u32 len, prog_id, fd_type;\n\tstruct bpf_object *obj = NULL;\n\t__u32 duration = 0;\n\tchar buf[256];\n\n\terr = bpf_prog_test_load(file, BPF_PROG_TYPE_TRACEPOINT, &obj, &prog_fd);\n\tif (CHECK(err, \"bpf_prog_test_load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto close_prog;\n\n\tif (access(\"/sys/kernel/tracing/trace\", F_OK) == 0) {\n\t\tsnprintf(buf, sizeof(buf),\n\t\t\t \"/sys/kernel/tracing/events/%s/id\", probe_name);\n\t} else {\n\t\tsnprintf(buf, sizeof(buf),\n\t\t\t \"/sys/kernel/debug/tracing/events/%s/id\", probe_name);\n\t}\n\tefd = open(buf, O_RDONLY, 0);\n\tif (CHECK(efd < 0, \"open\", \"err %d errno %d\\n\", efd, errno))\n\t\tgoto close_prog;\n\tbytes = read(efd, buf, sizeof(buf));\n\tclose(efd);\n\tif (CHECK(bytes <= 0 || bytes >= sizeof(buf), \"read\",\n\t\t  \"bytes %d errno %d\\n\", bytes, errno))\n\t\tgoto close_prog;\n\n\tattr.config = strtol(buf, NULL, 0);\n\tattr.type = PERF_TYPE_TRACEPOINT;\n\tattr.sample_type = PERF_SAMPLE_RAW;\n\tattr.sample_period = 1;\n\tattr.wakeup_events = 1;\n\tpmu_fd = syscall(__NR_perf_event_open, &attr, -1  ,\n\t\t\t 0  , -1  ,\n\t\t\t 0  );\n\tif (CHECK(err, \"perf_event_open\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto close_pmu;\n\n\terr = ioctl(pmu_fd, PERF_EVENT_IOC_ENABLE, 0);\n\tif (CHECK(err, \"perf_event_ioc_enable\", \"err %d errno %d\\n\", err,\n\t\t  errno))\n\t\tgoto close_pmu;\n\n\terr = ioctl(pmu_fd, PERF_EVENT_IOC_SET_BPF, prog_fd);\n\tif (CHECK(err, \"perf_event_ioc_set_bpf\", \"err %d errno %d\\n\", err,\n\t\t  errno))\n\t\tgoto close_pmu;\n\n\t \n\tlen = sizeof(buf);\n\terr = bpf_task_fd_query(getpid(), pmu_fd, 0, buf, &len, &prog_id,\n\t\t\t\t&fd_type, &probe_offset, &probe_addr);\n\tif (CHECK(err < 0, \"bpf_task_fd_query\", \"err %d errno %d\\n\", err,\n\t\t  errno))\n\t\tgoto close_pmu;\n\n\terr = (fd_type == BPF_FD_TYPE_TRACEPOINT) && !strcmp(buf, tp_name);\n\tif (CHECK(!err, \"check_results\", \"fd_type %d tp_name %s\\n\",\n\t\t  fd_type, buf))\n\t\tgoto close_pmu;\n\nclose_pmu:\n\tclose(pmu_fd);\nclose_prog:\n\tbpf_object__close(obj);\n}\n\nvoid test_task_fd_query_tp(void)\n{\n\ttest_task_fd_query_tp_core(\"sched/sched_switch\",\n\t\t\t\t   \"sched_switch\");\n\ttest_task_fd_query_tp_core(\"syscalls/sys_enter_read\",\n\t\t\t\t   \"sys_enter_read\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}