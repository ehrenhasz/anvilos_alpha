{
  "module_name": "sock_fields.c",
  "hash_id": "79de1a4a6e192b700c79daa82d2e3e4da47b913bdb7b10a79ebe906b5c410489",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/sock_fields.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include <unistd.h>\n#include <sched.h>\n#include <stdlib.h>\n#include <string.h>\n#include <errno.h>\n\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n#include <linux/compiler.h>\n\n#include \"network_helpers.h\"\n#include \"cgroup_helpers.h\"\n#include \"test_progs.h\"\n#include \"test_sock_fields.skel.h\"\n\nenum bpf_linum_array_idx {\n\tEGRESS_LINUM_IDX,\n\tINGRESS_LINUM_IDX,\n\tREAD_SK_DST_PORT_LINUM_IDX,\n\t__NR_BPF_LINUM_ARRAY_IDX,\n};\n\nstruct bpf_spinlock_cnt {\n\tstruct bpf_spin_lock lock;\n\t__u32 cnt;\n};\n\n#define PARENT_CGROUP\t\"/test-bpf-sock-fields\"\n#define CHILD_CGROUP\t\"/test-bpf-sock-fields/child\"\n#define DATA \"Hello BPF!\"\n#define DATA_LEN sizeof(DATA)\n\nstatic struct sockaddr_in6 srv_sa6, cli_sa6;\nstatic int sk_pkt_out_cnt10_fd;\nstatic struct test_sock_fields *skel;\nstatic int sk_pkt_out_cnt_fd;\nstatic __u64 parent_cg_id;\nstatic __u64 child_cg_id;\nstatic int linum_map_fd;\nstatic __u32 duration;\n\nstatic bool create_netns(void)\n{\n\tif (!ASSERT_OK(unshare(CLONE_NEWNET), \"create netns\"))\n\t\treturn false;\n\n\tif (!ASSERT_OK(system(\"ip link set dev lo up\"), \"bring up lo\"))\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic void print_sk(const struct bpf_sock *sk, const char *prefix)\n{\n\tchar src_ip4[24], dst_ip4[24];\n\tchar src_ip6[64], dst_ip6[64];\n\n\tinet_ntop(AF_INET, &sk->src_ip4, src_ip4, sizeof(src_ip4));\n\tinet_ntop(AF_INET6, &sk->src_ip6, src_ip6, sizeof(src_ip6));\n\tinet_ntop(AF_INET, &sk->dst_ip4, dst_ip4, sizeof(dst_ip4));\n\tinet_ntop(AF_INET6, &sk->dst_ip6, dst_ip6, sizeof(dst_ip6));\n\n\tprintf(\"%s: state:%u bound_dev_if:%u family:%u type:%u protocol:%u mark:%u priority:%u \"\n\t       \"src_ip4:%x(%s) src_ip6:%x:%x:%x:%x(%s) src_port:%u \"\n\t       \"dst_ip4:%x(%s) dst_ip6:%x:%x:%x:%x(%s) dst_port:%u\\n\",\n\t       prefix,\n\t       sk->state, sk->bound_dev_if, sk->family, sk->type, sk->protocol,\n\t       sk->mark, sk->priority,\n\t       sk->src_ip4, src_ip4,\n\t       sk->src_ip6[0], sk->src_ip6[1], sk->src_ip6[2], sk->src_ip6[3],\n\t       src_ip6, sk->src_port,\n\t       sk->dst_ip4, dst_ip4,\n\t       sk->dst_ip6[0], sk->dst_ip6[1], sk->dst_ip6[2], sk->dst_ip6[3],\n\t       dst_ip6, ntohs(sk->dst_port));\n}\n\nstatic void print_tp(const struct bpf_tcp_sock *tp, const char *prefix)\n{\n\tprintf(\"%s: snd_cwnd:%u srtt_us:%u rtt_min:%u snd_ssthresh:%u rcv_nxt:%u \"\n\t       \"snd_nxt:%u snd:una:%u mss_cache:%u ecn_flags:%u \"\n\t       \"rate_delivered:%u rate_interval_us:%u packets_out:%u \"\n\t       \"retrans_out:%u total_retrans:%u segs_in:%u data_segs_in:%u \"\n\t       \"segs_out:%u data_segs_out:%u lost_out:%u sacked_out:%u \"\n\t       \"bytes_received:%llu bytes_acked:%llu\\n\",\n\t       prefix,\n\t       tp->snd_cwnd, tp->srtt_us, tp->rtt_min, tp->snd_ssthresh,\n\t       tp->rcv_nxt, tp->snd_nxt, tp->snd_una, tp->mss_cache,\n\t       tp->ecn_flags, tp->rate_delivered, tp->rate_interval_us,\n\t       tp->packets_out, tp->retrans_out, tp->total_retrans,\n\t       tp->segs_in, tp->data_segs_in, tp->segs_out,\n\t       tp->data_segs_out, tp->lost_out, tp->sacked_out,\n\t       tp->bytes_received, tp->bytes_acked);\n}\n\nstatic void check_result(void)\n{\n\tstruct bpf_tcp_sock srv_tp, cli_tp, listen_tp;\n\tstruct bpf_sock srv_sk, cli_sk, listen_sk;\n\t__u32 idx, ingress_linum, egress_linum, linum;\n\tint err;\n\n\tidx = EGRESS_LINUM_IDX;\n\terr = bpf_map_lookup_elem(linum_map_fd, &idx, &egress_linum);\n\tCHECK(err < 0, \"bpf_map_lookup_elem(linum_map_fd)\",\n\t      \"err:%d errno:%d\\n\", err, errno);\n\n\tidx = INGRESS_LINUM_IDX;\n\terr = bpf_map_lookup_elem(linum_map_fd, &idx, &ingress_linum);\n\tCHECK(err < 0, \"bpf_map_lookup_elem(linum_map_fd)\",\n\t      \"err:%d errno:%d\\n\", err, errno);\n\n\tidx = READ_SK_DST_PORT_LINUM_IDX;\n\terr = bpf_map_lookup_elem(linum_map_fd, &idx, &linum);\n\tASSERT_OK(err, \"bpf_map_lookup_elem(linum_map_fd, READ_SK_DST_PORT_IDX)\");\n\tASSERT_EQ(linum, 0, \"failure in read_sk_dst_port on line\");\n\n\tmemcpy(&srv_sk, &skel->bss->srv_sk, sizeof(srv_sk));\n\tmemcpy(&srv_tp, &skel->bss->srv_tp, sizeof(srv_tp));\n\tmemcpy(&cli_sk, &skel->bss->cli_sk, sizeof(cli_sk));\n\tmemcpy(&cli_tp, &skel->bss->cli_tp, sizeof(cli_tp));\n\tmemcpy(&listen_sk, &skel->bss->listen_sk, sizeof(listen_sk));\n\tmemcpy(&listen_tp, &skel->bss->listen_tp, sizeof(listen_tp));\n\n\tprint_sk(&listen_sk, \"listen_sk\");\n\tprint_sk(&srv_sk, \"srv_sk\");\n\tprint_sk(&cli_sk, \"cli_sk\");\n\tprint_tp(&listen_tp, \"listen_tp\");\n\tprint_tp(&srv_tp, \"srv_tp\");\n\tprint_tp(&cli_tp, \"cli_tp\");\n\n\tCHECK(listen_sk.state != 10 ||\n\t      listen_sk.family != AF_INET6 ||\n\t      listen_sk.protocol != IPPROTO_TCP ||\n\t      memcmp(listen_sk.src_ip6, &in6addr_loopback,\n\t\t     sizeof(listen_sk.src_ip6)) ||\n\t      listen_sk.dst_ip6[0] || listen_sk.dst_ip6[1] ||\n\t      listen_sk.dst_ip6[2] || listen_sk.dst_ip6[3] ||\n\t      listen_sk.src_port != ntohs(srv_sa6.sin6_port) ||\n\t      listen_sk.dst_port,\n\t      \"listen_sk\",\n\t      \"Unexpected. Check listen_sk output. ingress_linum:%u\\n\",\n\t      ingress_linum);\n\n\tCHECK(srv_sk.state == 10 ||\n\t      !srv_sk.state ||\n\t      srv_sk.family != AF_INET6 ||\n\t      srv_sk.protocol != IPPROTO_TCP ||\n\t      memcmp(srv_sk.src_ip6, &in6addr_loopback,\n\t\t     sizeof(srv_sk.src_ip6)) ||\n\t      memcmp(srv_sk.dst_ip6, &in6addr_loopback,\n\t\t     sizeof(srv_sk.dst_ip6)) ||\n\t      srv_sk.src_port != ntohs(srv_sa6.sin6_port) ||\n\t      srv_sk.dst_port != cli_sa6.sin6_port,\n\t      \"srv_sk\", \"Unexpected. Check srv_sk output. egress_linum:%u\\n\",\n\t      egress_linum);\n\n\tCHECK(!skel->bss->lsndtime, \"srv_tp\", \"Unexpected lsndtime:0\\n\");\n\n\tCHECK(cli_sk.state == 10 ||\n\t      !cli_sk.state ||\n\t      cli_sk.family != AF_INET6 ||\n\t      cli_sk.protocol != IPPROTO_TCP ||\n\t      memcmp(cli_sk.src_ip6, &in6addr_loopback,\n\t\t     sizeof(cli_sk.src_ip6)) ||\n\t      memcmp(cli_sk.dst_ip6, &in6addr_loopback,\n\t\t     sizeof(cli_sk.dst_ip6)) ||\n\t      cli_sk.src_port != ntohs(cli_sa6.sin6_port) ||\n\t      cli_sk.dst_port != srv_sa6.sin6_port,\n\t      \"cli_sk\", \"Unexpected. Check cli_sk output. egress_linum:%u\\n\",\n\t      egress_linum);\n\n\tCHECK(listen_tp.data_segs_out ||\n\t      listen_tp.data_segs_in ||\n\t      listen_tp.total_retrans ||\n\t      listen_tp.bytes_acked,\n\t      \"listen_tp\",\n\t      \"Unexpected. Check listen_tp output. ingress_linum:%u\\n\",\n\t      ingress_linum);\n\n\tCHECK(srv_tp.data_segs_out != 2 ||\n\t      srv_tp.data_segs_in ||\n\t      srv_tp.snd_cwnd != 10 ||\n\t      srv_tp.total_retrans ||\n\t      srv_tp.bytes_acked < 2 * DATA_LEN,\n\t      \"srv_tp\", \"Unexpected. Check srv_tp output. egress_linum:%u\\n\",\n\t      egress_linum);\n\n\tCHECK(cli_tp.data_segs_out ||\n\t      cli_tp.data_segs_in != 2 ||\n\t      cli_tp.snd_cwnd != 10 ||\n\t      cli_tp.total_retrans ||\n\t      cli_tp.bytes_received < 2 * DATA_LEN,\n\t      \"cli_tp\", \"Unexpected. Check cli_tp output. egress_linum:%u\\n\",\n\t      egress_linum);\n\n\tCHECK(skel->bss->parent_cg_id != parent_cg_id,\n\t      \"parent_cg_id\", \"%zu != %zu\\n\",\n\t      (size_t)skel->bss->parent_cg_id, (size_t)parent_cg_id);\n\n\tCHECK(skel->bss->child_cg_id != child_cg_id,\n\t      \"child_cg_id\", \"%zu != %zu\\n\",\n\t       (size_t)skel->bss->child_cg_id, (size_t)child_cg_id);\n}\n\nstatic void check_sk_pkt_out_cnt(int accept_fd, int cli_fd)\n{\n\tstruct bpf_spinlock_cnt pkt_out_cnt = {}, pkt_out_cnt10 = {};\n\tint err;\n\n\tpkt_out_cnt.cnt = ~0;\n\tpkt_out_cnt10.cnt = ~0;\n\terr = bpf_map_lookup_elem(sk_pkt_out_cnt_fd, &accept_fd, &pkt_out_cnt);\n\tif (!err)\n\t\terr = bpf_map_lookup_elem(sk_pkt_out_cnt10_fd, &accept_fd,\n\t\t\t\t\t  &pkt_out_cnt10);\n\n\t \n\tCHECK(err || pkt_out_cnt.cnt < 0xeB9F + 2 ||\n\t      pkt_out_cnt10.cnt < 0xeB9F + 20,\n\t      \"bpf_map_lookup_elem(sk_pkt_out_cnt, &accept_fd)\",\n\t      \"err:%d errno:%d pkt_out_cnt:%u pkt_out_cnt10:%u\\n\",\n\t      err, errno, pkt_out_cnt.cnt, pkt_out_cnt10.cnt);\n\n\tpkt_out_cnt.cnt = ~0;\n\tpkt_out_cnt10.cnt = ~0;\n\terr = bpf_map_lookup_elem(sk_pkt_out_cnt_fd, &cli_fd, &pkt_out_cnt);\n\tif (!err)\n\t\terr = bpf_map_lookup_elem(sk_pkt_out_cnt10_fd, &cli_fd,\n\t\t\t\t\t  &pkt_out_cnt10);\n\t \n\tCHECK(err || pkt_out_cnt.cnt < 0xeB9F + 4 ||\n\t      pkt_out_cnt10.cnt < 0xeB9F + 40,\n\t      \"bpf_map_lookup_elem(sk_pkt_out_cnt, &cli_fd)\",\n\t      \"err:%d errno:%d pkt_out_cnt:%u pkt_out_cnt10:%u\\n\",\n\t      err, errno, pkt_out_cnt.cnt, pkt_out_cnt10.cnt);\n}\n\nstatic int init_sk_storage(int sk_fd, __u32 pkt_out_cnt)\n{\n\tstruct bpf_spinlock_cnt scnt = {};\n\tint err;\n\n\tscnt.cnt = pkt_out_cnt;\n\terr = bpf_map_update_elem(sk_pkt_out_cnt_fd, &sk_fd, &scnt,\n\t\t\t\t  BPF_NOEXIST);\n\tif (CHECK(err, \"bpf_map_update_elem(sk_pkt_out_cnt_fd)\",\n\t\t  \"err:%d errno:%d\\n\", err, errno))\n\t\treturn err;\n\n\terr = bpf_map_update_elem(sk_pkt_out_cnt10_fd, &sk_fd, &scnt,\n\t\t\t\t  BPF_NOEXIST);\n\tif (CHECK(err, \"bpf_map_update_elem(sk_pkt_out_cnt10_fd)\",\n\t\t  \"err:%d errno:%d\\n\", err, errno))\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic void test(void)\n{\n\tint listen_fd = -1, cli_fd = -1, accept_fd = -1, err, i;\n\tsocklen_t addrlen = sizeof(struct sockaddr_in6);\n\tchar buf[DATA_LEN];\n\n\t \n\tlisten_fd = start_server(AF_INET6, SOCK_STREAM, \"::1\", 0xcafe, 0);\n\t \n\tif (CHECK_FAIL(listen_fd == -1))\n\t\tgoto done;\n\n\terr = getsockname(listen_fd, (struct sockaddr *)&srv_sa6, &addrlen);\n\tif (CHECK(err, \"getsockname(listen_fd)\", \"err:%d errno:%d\\n\", err,\n\t\t  errno))\n\t\tgoto done;\n\tmemcpy(&skel->bss->srv_sa6, &srv_sa6, sizeof(srv_sa6));\n\n\tcli_fd = connect_to_fd(listen_fd, 0);\n\tif (CHECK_FAIL(cli_fd == -1))\n\t\tgoto done;\n\n\terr = getsockname(cli_fd, (struct sockaddr *)&cli_sa6, &addrlen);\n\tif (CHECK(err, \"getsockname(cli_fd)\", \"err:%d errno:%d\\n\",\n\t\t  err, errno))\n\t\tgoto done;\n\n\taccept_fd = accept(listen_fd, NULL, NULL);\n\tif (CHECK(accept_fd == -1, \"accept(listen_fd)\",\n\t\t  \"accept_fd:%d errno:%d\\n\",\n\t\t  accept_fd, errno))\n\t\tgoto done;\n\n\tif (init_sk_storage(accept_fd, 0xeB9F))\n\t\tgoto done;\n\n\tfor (i = 0; i < 2; i++) {\n\t\t \n\t\terr = send(accept_fd, DATA, DATA_LEN, MSG_EOR);\n\t\tif (CHECK(err != DATA_LEN, \"send(accept_fd)\",\n\t\t\t  \"err:%d errno:%d\\n\", err, errno))\n\t\t\tgoto done;\n\n\t\terr = recv(cli_fd, buf, DATA_LEN, 0);\n\t\tif (CHECK(err != DATA_LEN, \"recv(cli_fd)\", \"err:%d errno:%d\\n\",\n\t\t\t  err, errno))\n\t\t\tgoto done;\n\t}\n\n\tshutdown(cli_fd, SHUT_WR);\n\terr = recv(accept_fd, buf, 1, 0);\n\tif (CHECK(err, \"recv(accept_fd) for fin\", \"err:%d errno:%d\\n\",\n\t\t  err, errno))\n\t\tgoto done;\n\tshutdown(accept_fd, SHUT_WR);\n\terr = recv(cli_fd, buf, 1, 0);\n\tif (CHECK(err, \"recv(cli_fd) for fin\", \"err:%d errno:%d\\n\",\n\t\t  err, errno))\n\t\tgoto done;\n\tcheck_sk_pkt_out_cnt(accept_fd, cli_fd);\n\tcheck_result();\n\ndone:\n\tif (accept_fd != -1)\n\t\tclose(accept_fd);\n\tif (cli_fd != -1)\n\t\tclose(cli_fd);\n\tif (listen_fd != -1)\n\t\tclose(listen_fd);\n}\n\nvoid serial_test_sock_fields(void)\n{\n\tint parent_cg_fd = -1, child_cg_fd = -1;\n\tstruct bpf_link *link;\n\n\t \n\tif (!create_netns())\n\t\treturn;\n\n\t \n\tparent_cg_fd = test__join_cgroup(PARENT_CGROUP);\n\tif (CHECK_FAIL(parent_cg_fd < 0))\n\t\treturn;\n\tparent_cg_id = get_cgroup_id(PARENT_CGROUP);\n\tif (CHECK_FAIL(!parent_cg_id))\n\t\tgoto done;\n\n\tchild_cg_fd = test__join_cgroup(CHILD_CGROUP);\n\tif (CHECK_FAIL(child_cg_fd < 0))\n\t\tgoto done;\n\tchild_cg_id = get_cgroup_id(CHILD_CGROUP);\n\tif (CHECK_FAIL(!child_cg_id))\n\t\tgoto done;\n\n\tskel = test_sock_fields__open_and_load();\n\tif (CHECK(!skel, \"test_sock_fields__open_and_load\", \"failed\\n\"))\n\t\tgoto done;\n\n\tlink = bpf_program__attach_cgroup(skel->progs.egress_read_sock_fields, child_cg_fd);\n\tif (!ASSERT_OK_PTR(link, \"attach_cgroup(egress_read_sock_fields)\"))\n\t\tgoto done;\n\tskel->links.egress_read_sock_fields = link;\n\n\tlink = bpf_program__attach_cgroup(skel->progs.ingress_read_sock_fields, child_cg_fd);\n\tif (!ASSERT_OK_PTR(link, \"attach_cgroup(ingress_read_sock_fields)\"))\n\t\tgoto done;\n\tskel->links.ingress_read_sock_fields = link;\n\n\tlink = bpf_program__attach_cgroup(skel->progs.read_sk_dst_port, child_cg_fd);\n\tif (!ASSERT_OK_PTR(link, \"attach_cgroup(read_sk_dst_port\"))\n\t\tgoto done;\n\tskel->links.read_sk_dst_port = link;\n\n\tlinum_map_fd = bpf_map__fd(skel->maps.linum_map);\n\tsk_pkt_out_cnt_fd = bpf_map__fd(skel->maps.sk_pkt_out_cnt);\n\tsk_pkt_out_cnt10_fd = bpf_map__fd(skel->maps.sk_pkt_out_cnt10);\n\n\ttest();\n\ndone:\n\ttest_sock_fields__destroy(skel);\n\tif (child_cg_fd >= 0)\n\t\tclose(child_cg_fd);\n\tif (parent_cg_fd >= 0)\n\t\tclose(parent_cg_fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}