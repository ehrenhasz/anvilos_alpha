{
  "module_name": "lsm_cgroup.c",
  "hash_id": "48e43095048696e5eabfe13e38df943a8b035033b6da2997514fda2ce9883762",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/lsm_cgroup.c",
  "human_readable_source": "\n\n#include <sys/types.h>\n#include <sys/socket.h>\n#include <test_progs.h>\n#include <bpf/btf.h>\n\n#include \"lsm_cgroup.skel.h\"\n#include \"lsm_cgroup_nonvoid.skel.h\"\n#include \"cgroup_helpers.h\"\n#include \"network_helpers.h\"\n\n#ifndef ENOTSUPP\n#define ENOTSUPP 524\n#endif\n\nstatic struct btf *btf;\n\nstatic __u32 query_prog_cnt(int cgroup_fd, const char *attach_func)\n{\n\tLIBBPF_OPTS(bpf_prog_query_opts, p);\n\tint cnt = 0;\n\tint i;\n\n\tASSERT_OK(bpf_prog_query_opts(cgroup_fd, BPF_LSM_CGROUP, &p), \"prog_query\");\n\n\tif (!attach_func)\n\t\treturn p.prog_cnt;\n\n\t \n\n\tif (!btf)\n\t\tbtf = btf__load_vmlinux_btf();\n\tif (!ASSERT_OK(libbpf_get_error(btf), \"btf_vmlinux\"))\n\t\treturn -1;\n\n\tp.prog_ids = malloc(sizeof(u32) * p.prog_cnt);\n\tp.prog_attach_flags = malloc(sizeof(u32) * p.prog_cnt);\n\tASSERT_OK(bpf_prog_query_opts(cgroup_fd, BPF_LSM_CGROUP, &p), \"prog_query\");\n\n\tfor (i = 0; i < p.prog_cnt; i++) {\n\t\tstruct bpf_prog_info info = {};\n\t\t__u32 info_len = sizeof(info);\n\t\tint fd;\n\n\t\tfd = bpf_prog_get_fd_by_id(p.prog_ids[i]);\n\t\tASSERT_GE(fd, 0, \"prog_get_fd_by_id\");\n\t\tASSERT_OK(bpf_prog_get_info_by_fd(fd, &info, &info_len),\n\t\t\t  \"prog_info_by_fd\");\n\t\tclose(fd);\n\n\t\tif (info.attach_btf_id ==\n\t\t    btf__find_by_name_kind(btf, attach_func, BTF_KIND_FUNC))\n\t\t\tcnt++;\n\t}\n\n\tfree(p.prog_ids);\n\tfree(p.prog_attach_flags);\n\n\treturn cnt;\n}\n\nstatic void test_lsm_cgroup_functional(void)\n{\n\tDECLARE_LIBBPF_OPTS(bpf_prog_attach_opts, attach_opts);\n\tDECLARE_LIBBPF_OPTS(bpf_link_update_opts, update_opts);\n\tint cgroup_fd = -1, cgroup_fd2 = -1, cgroup_fd3 = -1;\n\tint listen_fd, client_fd, accepted_fd;\n\tstruct lsm_cgroup *skel = NULL;\n\tint post_create_prog_fd2 = -1;\n\tint post_create_prog_fd = -1;\n\tint bind_link_fd2 = -1;\n\tint bind_prog_fd2 = -1;\n\tint alloc_prog_fd = -1;\n\tint bind_prog_fd = -1;\n\tint bind_link_fd = -1;\n\tint clone_prog_fd = -1;\n\tint err, fd, prio;\n\tsocklen_t socklen;\n\n\tcgroup_fd3 = test__join_cgroup(\"/sock_policy_empty\");\n\tif (!ASSERT_GE(cgroup_fd3, 0, \"create empty cgroup\"))\n\t\tgoto close_cgroup;\n\n\tcgroup_fd2 = test__join_cgroup(\"/sock_policy_reuse\");\n\tif (!ASSERT_GE(cgroup_fd2, 0, \"create cgroup for reuse\"))\n\t\tgoto close_cgroup;\n\n\tcgroup_fd = test__join_cgroup(\"/sock_policy\");\n\tif (!ASSERT_GE(cgroup_fd, 0, \"join_cgroup\"))\n\t\tgoto close_cgroup;\n\n\tskel = lsm_cgroup__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"open_and_load\"))\n\t\tgoto close_cgroup;\n\n\tpost_create_prog_fd = bpf_program__fd(skel->progs.socket_post_create);\n\tpost_create_prog_fd2 = bpf_program__fd(skel->progs.socket_post_create2);\n\tbind_prog_fd = bpf_program__fd(skel->progs.socket_bind);\n\tbind_prog_fd2 = bpf_program__fd(skel->progs.socket_bind2);\n\talloc_prog_fd = bpf_program__fd(skel->progs.socket_alloc);\n\tclone_prog_fd = bpf_program__fd(skel->progs.socket_clone);\n\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_sk_alloc_security\"), 0, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 0, \"total prog count\");\n\terr = bpf_prog_attach(alloc_prog_fd, cgroup_fd, BPF_LSM_CGROUP, 0);\n\tif (err == -ENOTSUPP) {\n\t\ttest__skip();\n\t\tgoto close_cgroup;\n\t}\n\tif (!ASSERT_OK(err, \"attach alloc_prog_fd\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_sk_alloc_security\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 1, \"total prog count\");\n\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_inet_csk_clone\"), 0, \"prog count\");\n\terr = bpf_prog_attach(clone_prog_fd, cgroup_fd, BPF_LSM_CGROUP, 0);\n\tif (!ASSERT_OK(err, \"attach clone_prog_fd\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_inet_csk_clone\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 2, \"total prog count\");\n\n\t \n\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_post_create\"), 0, \"prog count\");\n\terr = bpf_prog_attach(post_create_prog_fd, cgroup_fd,\n\t\t\t      BPF_LSM_CGROUP, 0);\n\tif (!ASSERT_OK(err, \"attach post_create_prog_fd\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_post_create\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 3, \"total prog count\");\n\n\tattach_opts.replace_prog_fd = post_create_prog_fd;\n\terr = bpf_prog_attach_opts(post_create_prog_fd2, cgroup_fd,\n\t\t\t\t   BPF_LSM_CGROUP, &attach_opts);\n\tif (!ASSERT_OK(err, \"prog replace post_create_prog_fd\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_post_create\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 3, \"total prog count\");\n\n\t \n\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_bind\"), 0, \"prog count\");\n\tbind_link_fd = bpf_link_create(bind_prog_fd, cgroup_fd,\n\t\t\t\t       BPF_LSM_CGROUP, NULL);\n\tif (!ASSERT_GE(bind_link_fd, 0, \"link create bind_prog_fd\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_bind\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 4, \"total prog count\");\n\n\tupdate_opts.old_prog_fd = bind_prog_fd;\n\tupdate_opts.flags = BPF_F_REPLACE;\n\n\terr = bpf_link_update(bind_link_fd, bind_prog_fd2, &update_opts);\n\tif (!ASSERT_OK(err, \"link update bind_prog_fd\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_bind\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 4, \"total prog count\");\n\n\t \n\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, \"bpf_lsm_socket_bind\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd2, \"bpf_lsm_socket_bind\"), 0, \"prog count\");\n\tbind_link_fd2 = bpf_link_create(bind_prog_fd2, cgroup_fd2,\n\t\t\t\t\tBPF_LSM_CGROUP, NULL);\n\tif (!ASSERT_GE(bind_link_fd2, 0, \"link create bind_prog_fd2\"))\n\t\tgoto detach_cgroup;\n\tASSERT_EQ(query_prog_cnt(cgroup_fd2, \"bpf_lsm_socket_bind\"), 1, \"prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd, NULL), 4, \"total prog count\");\n\tASSERT_EQ(query_prog_cnt(cgroup_fd2, NULL), 1, \"total prog count\");\n\n\tfd = socket(AF_UNIX, SOCK_STREAM, 0);\n\tif (!(skel->kconfig->CONFIG_SECURITY_APPARMOR\n\t    || skel->kconfig->CONFIG_SECURITY_SELINUX\n\t    || skel->kconfig->CONFIG_SECURITY_SMACK))\n\t\t \n\t\tASSERT_LT(fd, 0, \"socket(AF_UNIX)\");\n\tclose(fd);\n\n\t \n\n\tfd = socket(AF_INET6, SOCK_STREAM, 0);\n\tif (!ASSERT_GE(fd, 0, \"socket(SOCK_STREAM)\"))\n\t\tgoto detach_cgroup;\n\n\tprio = 0;\n\tsocklen = sizeof(prio);\n\tASSERT_GE(getsockopt(fd, SOL_SOCKET, SO_PRIORITY, &prio, &socklen), 0,\n\t\t  \"getsockopt\");\n\tASSERT_EQ(prio, 123, \"sk_priority\");\n\n\tclose(fd);\n\n\t \n\n\tASSERT_LT(socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL)), 0,\n\t\t  \"socket(AF_PACKET, ..., ETH_P_ALL)\");\n\n\tfd = socket(AF_PACKET, SOCK_RAW, 0);\n\tASSERT_GE(fd, 0, \"socket(AF_PACKET, ..., 0)\");\n\n\t \n\n\tstruct sockaddr_ll sa = {\n\t\t.sll_family = AF_PACKET,\n\t\t.sll_protocol = htons(ETH_P_ALL),\n\t};\n\tASSERT_LT(bind(fd, (struct sockaddr *)&sa, sizeof(sa)), 0,\n\t\t  \"bind(ETH_P_ALL)\");\n\n\tclose(fd);\n\n\t \n\n\tlisten_fd = start_server(AF_INET6, SOCK_STREAM, \"::1\", 0, 0);\n\tASSERT_GE(listen_fd, 0, \"start_server\");\n\tclient_fd = connect_to_fd(listen_fd, 0);\n\tASSERT_GE(client_fd, 0, \"connect_to_fd\");\n\taccepted_fd = accept(listen_fd, NULL, NULL);\n\tASSERT_GE(accepted_fd, 0, \"accept\");\n\n\tprio = 0;\n\tsocklen = sizeof(prio);\n\tASSERT_GE(getsockopt(accepted_fd, SOL_SOCKET, SO_PRIORITY, &prio, &socklen), 0,\n\t\t  \"getsockopt\");\n\tASSERT_EQ(prio, 234, \"sk_priority\");\n\n\t \n\tASSERT_EQ(skel->bss->called_socket_post_create, 0, \"called_create\");\n\tASSERT_EQ(skel->bss->called_socket_bind, 0, \"called_bind\");\n\n\t \n\tif (skel->kconfig->CONFIG_SECURITY_APPARMOR\n\t    || skel->kconfig->CONFIG_SECURITY_SELINUX\n\t    || skel->kconfig->CONFIG_SECURITY_SMACK)\n\t\t \n\t\tASSERT_EQ(skel->bss->called_socket_post_create2, 6, \"called_create2\");\n\telse\n\t\tASSERT_EQ(skel->bss->called_socket_post_create2, 5, \"called_create2\");\n\n\t \n\tASSERT_EQ(skel->bss->called_socket_bind2, 2, \"called_bind2\");\n\t \n\tASSERT_EQ(skel->bss->called_socket_clone, 1, \"called_clone\");\n\n\t \n\tASSERT_EQ(skel->bss->called_socket_alloc, 7, \"called_alloc\");\n\n\tclose(listen_fd);\n\tclose(client_fd);\n\tclose(accepted_fd);\n\n\t \n\n\tif (!ASSERT_OK(join_cgroup(\"/sock_policy_empty\"), \"join root cgroup\"))\n\t\tgoto detach_cgroup;\n\n\tfd = socket(AF_INET6, SOCK_STREAM, 0);\n\tif (!ASSERT_GE(fd, 0, \"socket(SOCK_STREAM)\"))\n\t\tgoto detach_cgroup;\n\n\tprio = 0;\n\tsocklen = sizeof(prio);\n\tASSERT_GE(getsockopt(fd, SOL_SOCKET, SO_PRIORITY, &prio, &socklen), 0,\n\t\t  \"getsockopt\");\n\tASSERT_EQ(prio, 0, \"sk_priority\");\n\n\tclose(fd);\n\ndetach_cgroup:\n\tASSERT_GE(bpf_prog_detach2(post_create_prog_fd2, cgroup_fd,\n\t\t\t\t   BPF_LSM_CGROUP), 0, \"detach_create\");\n\tclose(bind_link_fd);\n\t \n\tASSERT_GE(bpf_prog_detach2(alloc_prog_fd, cgroup_fd,\n\t\t\t\t   BPF_LSM_CGROUP), 0, \"detach_alloc\");\n\tASSERT_GE(bpf_prog_detach2(clone_prog_fd, cgroup_fd,\n\t\t\t\t   BPF_LSM_CGROUP), 0, \"detach_clone\");\n\nclose_cgroup:\n\tclose(cgroup_fd);\n\tclose(cgroup_fd2);\n\tclose(cgroup_fd3);\n\tlsm_cgroup__destroy(skel);\n}\n\nstatic void test_lsm_cgroup_nonvoid(void)\n{\n\tstruct lsm_cgroup_nonvoid *skel = NULL;\n\n\tskel = lsm_cgroup_nonvoid__open_and_load();\n\tASSERT_NULL(skel, \"open succeeds\");\n\tlsm_cgroup_nonvoid__destroy(skel);\n}\n\nvoid test_lsm_cgroup(void)\n{\n\tif (test__start_subtest(\"functional\"))\n\t\ttest_lsm_cgroup_functional();\n\tif (test__start_subtest(\"nonvoid\"))\n\t\ttest_lsm_cgroup_nonvoid();\n\tbtf__free(btf);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}