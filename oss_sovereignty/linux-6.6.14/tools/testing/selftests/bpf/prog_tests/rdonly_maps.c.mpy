{
  "module_name": "rdonly_maps.c",
  "hash_id": "1da987fcf1f529b55ea1009a2c0d0fbd20176a46eb16d5d01f26059205222b85",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/rdonly_maps.c",
  "human_readable_source": "\n#include <test_progs.h>\n\nstruct bss {\n\tunsigned did_run;\n\tunsigned iters;\n\tunsigned sum;\n};\n\nstruct rdonly_map_subtest {\n\tconst char *subtest_name;\n\tconst char *prog_name;\n\tunsigned exp_iters;\n\tunsigned exp_sum;\n};\n\nvoid test_rdonly_maps(void)\n{\n\tconst char *file = \"test_rdonly_maps.bpf.o\";\n\tstruct rdonly_map_subtest subtests[] = {\n\t\t{ \"skip loop\", \"skip_loop\", 0, 0 },\n\t\t{ \"part loop\", \"part_loop\", 3, 2 + 3 + 4 },\n\t\t{ \"full loop\", \"full_loop\", 4, 2 + 3 + 4 + 5 },\n\t};\n\tint i, err, zero = 0, duration = 0;\n\tstruct bpf_link *link = NULL;\n\tstruct bpf_program *prog;\n\tstruct bpf_map *bss_map;\n\tstruct bpf_object *obj;\n\tstruct bss bss;\n\n\tobj = bpf_object__open_file(file, NULL);\n\tif (!ASSERT_OK_PTR(obj, \"obj_open\"))\n\t\treturn;\n\n\terr = bpf_object__load(obj);\n\tif (CHECK(err, \"obj_load\", \"err %d errno %d\\n\", err, errno))\n\t\tgoto cleanup;\n\n\tbss_map = bpf_object__find_map_by_name(obj, \".bss\");\n\tif (CHECK(!bss_map, \"find_bss_map\", \"failed\\n\"))\n\t\tgoto cleanup;\n\n\tfor (i = 0; i < ARRAY_SIZE(subtests); i++) {\n\t\tconst struct rdonly_map_subtest *t = &subtests[i];\n\n\t\tif (!test__start_subtest(t->subtest_name))\n\t\t\tcontinue;\n\n\t\tprog = bpf_object__find_program_by_name(obj, t->prog_name);\n\t\tif (CHECK(!prog, \"find_prog\", \"prog '%s' not found\\n\",\n\t\t\t  t->prog_name))\n\t\t\tgoto cleanup;\n\n\t\tmemset(&bss, 0, sizeof(bss));\n\t\terr = bpf_map_update_elem(bpf_map__fd(bss_map), &zero, &bss, 0);\n\t\tif (CHECK(err, \"set_bss\", \"failed to set bss data: %d\\n\", err))\n\t\t\tgoto cleanup;\n\n\t\tlink = bpf_program__attach_raw_tracepoint(prog, \"sys_enter\");\n\t\tif (!ASSERT_OK_PTR(link, \"attach_prog\"))\n\t\t\tgoto cleanup;\n\n\t\t \n\t\tusleep(1);\n\n\t\tbpf_link__destroy(link);\n\t\tlink = NULL;\n\n\t\terr = bpf_map_lookup_elem(bpf_map__fd(bss_map), &zero, &bss);\n\t\tif (CHECK(err, \"get_bss\", \"failed to get bss data: %d\\n\", err))\n\t\t\tgoto cleanup;\n\t\tif (CHECK(bss.did_run == 0, \"check_run\",\n\t\t\t  \"prog '%s' didn't run?\\n\", t->prog_name))\n\t\t\tgoto cleanup;\n\t\tif (CHECK(bss.iters != t->exp_iters, \"check_iters\",\n\t\t\t  \"prog '%s' iters: %d, expected: %d\\n\",\n\t\t\t  t->prog_name, bss.iters, t->exp_iters))\n\t\t\tgoto cleanup;\n\t\tif (CHECK(bss.sum != t->exp_sum, \"check_sum\",\n\t\t\t  \"prog '%s' sum: %d, expected: %d\\n\",\n\t\t\t  t->prog_name, bss.sum, t->exp_sum))\n\t\t\tgoto cleanup;\n\t}\n\ncleanup:\n\tbpf_link__destroy(link);\n\tbpf_object__close(obj);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}