{
  "module_name": "btf_tag.c",
  "hash_id": "1bf06dd3c58be70ac5b00b563da913af3544b3a26cf76fcd3e92c0f27c4fc08d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/prog_tests/btf_tag.c",
  "human_readable_source": "\n \n#include <test_progs.h>\n#include <bpf/btf.h>\n#include \"test_btf_decl_tag.skel.h\"\n\n \nstruct btf_type_tag_test {\n        int **p;\n};\n#include \"btf_type_tag.skel.h\"\n#include \"btf_type_tag_user.skel.h\"\n#include \"btf_type_tag_percpu.skel.h\"\n\nstatic void test_btf_decl_tag(void)\n{\n\tstruct test_btf_decl_tag *skel;\n\n\tskel = test_btf_decl_tag__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"btf_decl_tag\"))\n\t\treturn;\n\n\tif (skel->rodata->skip_tests) {\n\t\tprintf(\"%s:SKIP: btf_decl_tag attribute not supported\", __func__);\n\t\ttest__skip();\n\t}\n\n\ttest_btf_decl_tag__destroy(skel);\n}\n\nstatic void test_btf_type_tag(void)\n{\n\tstruct btf_type_tag *skel;\n\n\tskel = btf_type_tag__open_and_load();\n\tif (!ASSERT_OK_PTR(skel, \"btf_type_tag\"))\n\t\treturn;\n\n\tif (skel->rodata->skip_tests) {\n\t\tprintf(\"%s:SKIP: btf_type_tag attribute not supported\", __func__);\n\t\ttest__skip();\n\t}\n\n\tbtf_type_tag__destroy(skel);\n}\n\n \nstatic int load_btfs(struct btf **vmlinux_btf, struct btf **module_btf,\n\t\t     bool needs_vmlinux_tag)\n{\n\tconst char *module_name = \"bpf_testmod\";\n\t__s32 type_id;\n\n\tif (!env.has_testmod) {\n\t\ttest__skip();\n\t\treturn -1;\n\t}\n\n\t*vmlinux_btf = btf__load_vmlinux_btf();\n\tif (!ASSERT_OK_PTR(*vmlinux_btf, \"could not load vmlinux BTF\"))\n\t\treturn -1;\n\n\tif (!needs_vmlinux_tag)\n\t\tgoto load_module_btf;\n\n\t \n\ttype_id = btf__find_by_name_kind(*vmlinux_btf, \"user\", BTF_KIND_TYPE_TAG);\n\tif (type_id <= 0) {\n\t\tprintf(\"%s:SKIP: btf_type_tag attribute not in vmlinux btf\", __func__);\n\t\ttest__skip();\n\t\tgoto free_vmlinux_btf;\n\t}\n\nload_module_btf:\n\t \n\tif (!module_btf)\n\t\treturn 0;\n\n\t*module_btf = btf__load_module_btf(module_name, *vmlinux_btf);\n\tif (!ASSERT_OK_PTR(*module_btf, \"could not load module BTF\"))\n\t\tgoto free_vmlinux_btf;\n\n\t \n\ttype_id = btf__find_by_name_kind(*module_btf, \"user\", BTF_KIND_TYPE_TAG);\n\tif (type_id <= 0) {\n\t\tprintf(\"%s:SKIP: btf_type_tag attribute not in %s\", __func__, module_name);\n\t\ttest__skip();\n\t\tgoto free_module_btf;\n\t}\n\n\treturn 0;\n\nfree_module_btf:\n\tbtf__free(*module_btf);\nfree_vmlinux_btf:\n\tbtf__free(*vmlinux_btf);\n\n\t*vmlinux_btf = NULL;\n\tif (module_btf)\n\t\t*module_btf = NULL;\n\treturn -1;\n}\n\nstatic void test_btf_type_tag_mod_user(bool load_test_user1)\n{\n\tstruct btf *vmlinux_btf = NULL, *module_btf = NULL;\n\tstruct btf_type_tag_user *skel;\n\tint err;\n\n\tif (load_btfs(&vmlinux_btf, &module_btf,  false))\n\t\treturn;\n\n\tskel = btf_type_tag_user__open();\n\tif (!ASSERT_OK_PTR(skel, \"btf_type_tag_user\"))\n\t\tgoto cleanup;\n\n\tbpf_program__set_autoload(skel->progs.test_sys_getsockname, false);\n\tif (load_test_user1)\n\t\tbpf_program__set_autoload(skel->progs.test_user2, false);\n\telse\n\t\tbpf_program__set_autoload(skel->progs.test_user1, false);\n\n\terr = btf_type_tag_user__load(skel);\n\tASSERT_ERR(err, \"btf_type_tag_user\");\n\n\tbtf_type_tag_user__destroy(skel);\n\ncleanup:\n\tbtf__free(module_btf);\n\tbtf__free(vmlinux_btf);\n}\n\nstatic void test_btf_type_tag_vmlinux_user(void)\n{\n\tstruct btf_type_tag_user *skel;\n\tstruct btf *vmlinux_btf = NULL;\n\tint err;\n\n\tif (load_btfs(&vmlinux_btf, NULL,  true))\n\t\treturn;\n\n\tskel = btf_type_tag_user__open();\n\tif (!ASSERT_OK_PTR(skel, \"btf_type_tag_user\"))\n\t\tgoto cleanup;\n\n\tbpf_program__set_autoload(skel->progs.test_user2, false);\n\tbpf_program__set_autoload(skel->progs.test_user1, false);\n\n\terr = btf_type_tag_user__load(skel);\n\tASSERT_ERR(err, \"btf_type_tag_user\");\n\n\tbtf_type_tag_user__destroy(skel);\n\ncleanup:\n\tbtf__free(vmlinux_btf);\n}\n\nstatic void test_btf_type_tag_mod_percpu(bool load_test_percpu1)\n{\n\tstruct btf *vmlinux_btf, *module_btf;\n\tstruct btf_type_tag_percpu *skel;\n\tint err;\n\n\tif (load_btfs(&vmlinux_btf, &module_btf,  false))\n\t\treturn;\n\n\tskel = btf_type_tag_percpu__open();\n\tif (!ASSERT_OK_PTR(skel, \"btf_type_tag_percpu\"))\n\t\tgoto cleanup;\n\n\tbpf_program__set_autoload(skel->progs.test_percpu_load, false);\n\tbpf_program__set_autoload(skel->progs.test_percpu_helper, false);\n\tif (load_test_percpu1)\n\t\tbpf_program__set_autoload(skel->progs.test_percpu2, false);\n\telse\n\t\tbpf_program__set_autoload(skel->progs.test_percpu1, false);\n\n\terr = btf_type_tag_percpu__load(skel);\n\tASSERT_ERR(err, \"btf_type_tag_percpu\");\n\n\tbtf_type_tag_percpu__destroy(skel);\n\ncleanup:\n\tbtf__free(module_btf);\n\tbtf__free(vmlinux_btf);\n}\n\nstatic void test_btf_type_tag_vmlinux_percpu(bool load_test)\n{\n\tstruct btf_type_tag_percpu *skel;\n\tstruct btf *vmlinux_btf = NULL;\n\tint err;\n\n\tif (load_btfs(&vmlinux_btf, NULL,  true))\n\t\treturn;\n\n\tskel = btf_type_tag_percpu__open();\n\tif (!ASSERT_OK_PTR(skel, \"btf_type_tag_percpu\"))\n\t\tgoto cleanup;\n\n\tbpf_program__set_autoload(skel->progs.test_percpu2, false);\n\tbpf_program__set_autoload(skel->progs.test_percpu1, false);\n\tif (load_test) {\n\t\tbpf_program__set_autoload(skel->progs.test_percpu_helper, false);\n\n\t\terr = btf_type_tag_percpu__load(skel);\n\t\tASSERT_ERR(err, \"btf_type_tag_percpu_load\");\n\t} else {\n\t\tbpf_program__set_autoload(skel->progs.test_percpu_load, false);\n\n\t\terr = btf_type_tag_percpu__load(skel);\n\t\tASSERT_OK(err, \"btf_type_tag_percpu_helper\");\n\t}\n\n\tbtf_type_tag_percpu__destroy(skel);\n\ncleanup:\n\tbtf__free(vmlinux_btf);\n}\n\nvoid test_btf_tag(void)\n{\n\tif (test__start_subtest(\"btf_decl_tag\"))\n\t\ttest_btf_decl_tag();\n\tif (test__start_subtest(\"btf_type_tag\"))\n\t\ttest_btf_type_tag();\n\n\tif (test__start_subtest(\"btf_type_tag_user_mod1\"))\n\t\ttest_btf_type_tag_mod_user(true);\n\tif (test__start_subtest(\"btf_type_tag_user_mod2\"))\n\t\ttest_btf_type_tag_mod_user(false);\n\tif (test__start_subtest(\"btf_type_tag_sys_user_vmlinux\"))\n\t\ttest_btf_type_tag_vmlinux_user();\n\n\tif (test__start_subtest(\"btf_type_tag_percpu_mod1\"))\n\t\ttest_btf_type_tag_mod_percpu(true);\n\tif (test__start_subtest(\"btf_type_tag_percpu_mod2\"))\n\t\ttest_btf_type_tag_mod_percpu(false);\n\tif (test__start_subtest(\"btf_type_tag_percpu_vmlinux_load\"))\n\t\ttest_btf_type_tag_vmlinux_percpu(true);\n\tif (test__start_subtest(\"btf_type_tag_percpu_vmlinux_helper\"))\n\t\ttest_btf_type_tag_vmlinux_percpu(false);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}