{
  "module_name": "test_lirc_mode2_user.c",
  "hash_id": "1c5eeb8ef6422ed4d215c23df52feac3e7c4a946c02b1146a7ed18b36bf9950b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_lirc_mode2_user.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n#include <linux/bpf.h>\n#include <linux/input.h>\n#include <errno.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <poll.h>\n#include <sys/types.h>\n#include <sys/ioctl.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n\n#include \"bpf_util.h\"\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n\n#include \"testing_helpers.h\"\n\nint main(int argc, char **argv)\n{\n\tstruct bpf_object *obj;\n\tint ret, lircfd, progfd, inputfd;\n\tint testir1 = 0x1dead;\n\tint testir2 = 0x20101;\n\tu32 prog_ids[10], prog_flags[10], prog_cnt;\n\n\tif (argc != 3) {\n\t\tprintf(\"Usage: %s /dev/lircN /dev/input/eventM\\n\", argv[0]);\n\t\treturn 2;\n\t}\n\n\tret = bpf_prog_test_load(\"test_lirc_mode2_kern.bpf.o\",\n\t\t\t\t BPF_PROG_TYPE_LIRC_MODE2, &obj, &progfd);\n\tif (ret) {\n\t\tprintf(\"Failed to load bpf program\\n\");\n\t\treturn 1;\n\t}\n\n\tlircfd = open(argv[1], O_RDWR | O_NONBLOCK);\n\tif (lircfd == -1) {\n\t\tprintf(\"failed to open lirc device %s: %m\\n\", argv[1]);\n\t\treturn 1;\n\t}\n\n\t \n\tret = bpf_prog_detach2(progfd, lircfd, BPF_LIRC_MODE2);\n\tif (ret != -1 || errno != ENOENT) {\n\t\tprintf(\"bpf_prog_detach2 not attached should fail: %m\\n\");\n\t\treturn 1;\n\t}\n\n\tinputfd = open(argv[2], O_RDONLY | O_NONBLOCK);\n\tif (inputfd == -1) {\n\t\tprintf(\"failed to open input device %s: %m\\n\", argv[1]);\n\t\treturn 1;\n\t}\n\n\tprog_cnt = 10;\n\tret = bpf_prog_query(lircfd, BPF_LIRC_MODE2, 0, prog_flags, prog_ids,\n\t\t\t     &prog_cnt);\n\tif (ret) {\n\t\tprintf(\"Failed to query bpf programs on lirc device: %m\\n\");\n\t\treturn 1;\n\t}\n\n\tif (prog_cnt != 0) {\n\t\tprintf(\"Expected nothing to be attached\\n\");\n\t\treturn 1;\n\t}\n\n\tret = bpf_prog_attach(progfd, lircfd, BPF_LIRC_MODE2, 0);\n\tif (ret) {\n\t\tprintf(\"Failed to attach bpf to lirc device: %m\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\tret = write(lircfd, &testir1, sizeof(testir1));\n\tif (ret != sizeof(testir1)) {\n\t\tprintf(\"Failed to send test IR message: %m\\n\");\n\t\treturn 1;\n\t}\n\n\tstruct pollfd pfd = { .fd = inputfd, .events = POLLIN };\n\tstruct input_event event;\n\n\tfor (;;) {\n\t\tpoll(&pfd, 1, 100);\n\n\t\t \n\t\tret = read(inputfd, &event, sizeof(event));\n\t\tif (ret != sizeof(event)) {\n\t\t\tprintf(\"Failed to read decoded IR: %m\\n\");\n\t\t\treturn 1;\n\t\t}\n\n\t\tif (event.type == EV_MSC && event.code == MSC_SCAN &&\n\t\t    event.value == 0xdead) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tret = write(lircfd, &testir2, sizeof(testir2));\n\tif (ret != sizeof(testir2)) {\n\t\tprintf(\"Failed to send test IR message: %m\\n\");\n\t\treturn 1;\n\t}\n\n\tfor (;;) {\n\t\tpoll(&pfd, 1, 100);\n\n\t\t \n\t\tret = read(inputfd, &event, sizeof(event));\n\t\tif (ret != sizeof(event)) {\n\t\t\tprintf(\"Failed to read decoded IR: %m\\n\");\n\t\t\treturn 1;\n\t\t}\n\n\t\tif (event.type == EV_REL && event.code == REL_Y &&\n\t\t    event.value == 1 ) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tprog_cnt = 10;\n\tret = bpf_prog_query(lircfd, BPF_LIRC_MODE2, 0, prog_flags, prog_ids,\n\t\t\t     &prog_cnt);\n\tif (ret) {\n\t\tprintf(\"Failed to query bpf programs on lirc device: %m\\n\");\n\t\treturn 1;\n\t}\n\n\tif (prog_cnt != 1) {\n\t\tprintf(\"Expected one program to be attached\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\tret = bpf_prog_detach2(progfd, lircfd, BPF_LIRC_MODE2);\n\tif (ret) {\n\t\tprintf(\"bpf_prog_detach2: returned %m\\n\");\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}