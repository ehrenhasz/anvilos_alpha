{
  "module_name": "test_tcpnotify_user.c",
  "hash_id": "6e5151d51f840207139c1062b2777e34b148a6b28537d541fde7f1a59e688d8b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_tcpnotify_user.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <pthread.h>\n#include <inttypes.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <asm/types.h>\n#include <sys/syscall.h>\n#include <errno.h>\n#include <string.h>\n#include <linux/bpf.h>\n#include <sys/socket.h>\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n#include <sys/ioctl.h>\n#include <linux/rtnetlink.h>\n#include <signal.h>\n#include <linux/perf_event.h>\n#include <linux/err.h>\n\n#include \"bpf_util.h\"\n#include \"cgroup_helpers.h\"\n\n#include \"test_tcpnotify.h\"\n#include \"trace_helpers.h\"\n#include \"testing_helpers.h\"\n\n#define SOCKET_BUFFER_SIZE (getpagesize() < 8192L ? getpagesize() : 8192L)\n\npthread_t tid;\nint rx_callbacks;\n\nstatic void dummyfn(void *ctx, int cpu, void *data, __u32 size)\n{\n\tstruct tcp_notifier *t = data;\n\n\tif (t->type != 0xde || t->subtype != 0xad ||\n\t    t->source != 0xbe || t->hash != 0xef)\n\t\treturn;\n\trx_callbacks++;\n}\n\nvoid tcp_notifier_poller(struct perf_buffer *pb)\n{\n\tint err;\n\n\twhile (1) {\n\t\terr = perf_buffer__poll(pb, 100);\n\t\tif (err < 0 && err != -EINTR) {\n\t\t\tprintf(\"failed perf_buffer__poll: %d\\n\", err);\n\t\t\treturn;\n\t\t}\n\t}\n}\n\nstatic void *poller_thread(void *arg)\n{\n\tstruct perf_buffer *pb = arg;\n\n\ttcp_notifier_poller(pb);\n\treturn arg;\n}\n\nint verify_result(const struct tcpnotify_globals *result)\n{\n\treturn (result->ncalls > 0 && result->ncalls == rx_callbacks ? 0 : 1);\n}\n\nint main(int argc, char **argv)\n{\n\tconst char *file = \"test_tcpnotify_kern.bpf.o\";\n\tstruct bpf_map *perf_map, *global_map;\n\tstruct tcpnotify_globals g = {0};\n\tstruct perf_buffer *pb = NULL;\n\tconst char *cg_path = \"/foo\";\n\tint prog_fd, rv, cg_fd = -1;\n\tint error = EXIT_FAILURE;\n\tstruct bpf_object *obj;\n\tchar test_script[80];\n\tcpu_set_t cpuset;\n\t__u32 key = 0;\n\n\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);\n\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(0, &cpuset);\n\tpthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &cpuset);\n\n\tcg_fd = cgroup_setup_and_join(cg_path);\n\tif (cg_fd < 0)\n\t\tgoto err;\n\n\tif (bpf_prog_test_load(file, BPF_PROG_TYPE_SOCK_OPS, &obj, &prog_fd)) {\n\t\tprintf(\"FAILED: load_bpf_file failed for: %s\\n\", file);\n\t\tgoto err;\n\t}\n\n\trv = bpf_prog_attach(prog_fd, cg_fd, BPF_CGROUP_SOCK_OPS, 0);\n\tif (rv) {\n\t\tprintf(\"FAILED: bpf_prog_attach: %d (%s)\\n\",\n\t\t       error, strerror(errno));\n\t\tgoto err;\n\t}\n\n\tperf_map = bpf_object__find_map_by_name(obj, \"perf_event_map\");\n\tif (!perf_map) {\n\t\tprintf(\"FAIL:map '%s' not found\\n\", \"perf_event_map\");\n\t\tgoto err;\n\t}\n\n\tglobal_map = bpf_object__find_map_by_name(obj, \"global_map\");\n\tif (!global_map) {\n\t\tprintf(\"FAIL:map '%s' not found\\n\", \"global_map\");\n\t\treturn -1;\n\t}\n\n\tpb = perf_buffer__new(bpf_map__fd(perf_map), 8, dummyfn, NULL, NULL, NULL);\n\tif (!pb)\n\t\tgoto err;\n\n\tpthread_create(&tid, NULL, poller_thread, pb);\n\n\tsprintf(test_script,\n\t\t\"iptables -A INPUT -p tcp --dport %d -j DROP\",\n\t\tTESTPORT);\n\tif (system(test_script)) {\n\t\tprintf(\"FAILED: execute command: %s, err %d\\n\", test_script, -errno);\n\t\tgoto err;\n\t}\n\n\tsprintf(test_script,\n\t\t\"nc 127.0.0.1 %d < /etc/passwd > /dev/null 2>&1 \",\n\t\tTESTPORT);\n\tif (system(test_script))\n\t\tprintf(\"execute command: %s, err %d\\n\", test_script, -errno);\n\n\tsprintf(test_script,\n\t\t\"iptables -D INPUT -p tcp --dport %d -j DROP\",\n\t\tTESTPORT);\n\tif (system(test_script)) {\n\t\tprintf(\"FAILED: execute command: %s, err %d\\n\", test_script, -errno);\n\t\tgoto err;\n\t}\n\n\trv = bpf_map_lookup_elem(bpf_map__fd(global_map), &key, &g);\n\tif (rv != 0) {\n\t\tprintf(\"FAILED: bpf_map_lookup_elem returns %d\\n\", rv);\n\t\tgoto err;\n\t}\n\n\tsleep(10);\n\n\tif (verify_result(&g)) {\n\t\tprintf(\"FAILED: Wrong stats Expected %d calls, got %d\\n\",\n\t\t\tg.ncalls, rx_callbacks);\n\t\tgoto err;\n\t}\n\n\tprintf(\"PASSED!\\n\");\n\terror = 0;\nerr:\n\tbpf_prog_detach(cg_fd, BPF_CGROUP_SOCK_OPS);\n\tclose(cg_fd);\n\tcleanup_cgroup_environment();\n\tperf_buffer__free(pb);\n\treturn error;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}