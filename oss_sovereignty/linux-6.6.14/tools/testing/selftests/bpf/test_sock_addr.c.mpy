{
  "module_name": "test_sock_addr.c",
  "hash_id": "29263434047491614c5aa31fa105ec2686345846062dd3f51bfc6a4c07ebcccf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_sock_addr.c",
  "human_readable_source": "\n\n\n#define _GNU_SOURCE\n\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\n#include <arpa/inet.h>\n#include <netinet/in.h>\n#include <sys/types.h>\n#include <sys/select.h>\n#include <sys/socket.h>\n\n#include <linux/filter.h>\n\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n\n#include \"cgroup_helpers.h\"\n#include \"bpf_util.h\"\n\n#ifndef ENOTSUPP\n# define ENOTSUPP 524\n#endif\n\n#define CG_PATH\t\"/foo\"\n#define CONNECT4_PROG_PATH\t\"./connect4_prog.bpf.o\"\n#define CONNECT6_PROG_PATH\t\"./connect6_prog.bpf.o\"\n#define SENDMSG4_PROG_PATH\t\"./sendmsg4_prog.bpf.o\"\n#define SENDMSG6_PROG_PATH\t\"./sendmsg6_prog.bpf.o\"\n#define RECVMSG4_PROG_PATH\t\"./recvmsg4_prog.bpf.o\"\n#define RECVMSG6_PROG_PATH\t\"./recvmsg6_prog.bpf.o\"\n#define BIND4_PROG_PATH\t\t\"./bind4_prog.bpf.o\"\n#define BIND6_PROG_PATH\t\t\"./bind6_prog.bpf.o\"\n\n#define SERV4_IP\t\t\"192.168.1.254\"\n#define SERV4_REWRITE_IP\t\"127.0.0.1\"\n#define SRC4_IP\t\t\t\"172.16.0.1\"\n#define SRC4_REWRITE_IP\t\t\"127.0.0.4\"\n#define SERV4_PORT\t\t4040\n#define SERV4_REWRITE_PORT\t4444\n\n#define SERV6_IP\t\t\"face:b00c:1234:5678::abcd\"\n#define SERV6_REWRITE_IP\t\"::1\"\n#define SERV6_V4MAPPED_IP\t\"::ffff:192.168.0.4\"\n#define SRC6_IP\t\t\t\"::1\"\n#define SRC6_REWRITE_IP\t\t\"::6\"\n#define WILDCARD6_IP\t\t\"::\"\n#define SERV6_PORT\t\t6060\n#define SERV6_REWRITE_PORT\t6666\n\n#define INET_NTOP_BUF\t40\n\nstruct sock_addr_test;\n\ntypedef int (*load_fn)(const struct sock_addr_test *test);\ntypedef int (*info_fn)(int, struct sockaddr *, socklen_t *);\n\nchar bpf_log_buf[BPF_LOG_BUF_SIZE];\n\nstruct sock_addr_test {\n\tconst char *descr;\n\t \n\tload_fn loadfn;\n\tenum bpf_attach_type expected_attach_type;\n\tenum bpf_attach_type attach_type;\n\t \n\tint domain;\n\tint type;\n\t \n\tconst char *requested_ip;\n\tunsigned short requested_port;\n\tconst char *expected_ip;\n\tunsigned short expected_port;\n\tconst char *expected_src_ip;\n\t \n\tenum {\n\t\tLOAD_REJECT,\n\t\tATTACH_REJECT,\n\t\tATTACH_OKAY,\n\t\tSYSCALL_EPERM,\n\t\tSYSCALL_ENOTSUPP,\n\t\tSUCCESS,\n\t} expected_result;\n};\n\nstatic int bind4_prog_load(const struct sock_addr_test *test);\nstatic int bind6_prog_load(const struct sock_addr_test *test);\nstatic int connect4_prog_load(const struct sock_addr_test *test);\nstatic int connect6_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg_allow_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg_deny_prog_load(const struct sock_addr_test *test);\nstatic int recvmsg_allow_prog_load(const struct sock_addr_test *test);\nstatic int recvmsg_deny_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg4_rw_asm_prog_load(const struct sock_addr_test *test);\nstatic int recvmsg4_rw_c_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg4_rw_c_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg6_rw_asm_prog_load(const struct sock_addr_test *test);\nstatic int recvmsg6_rw_c_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg6_rw_c_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg6_rw_v4mapped_prog_load(const struct sock_addr_test *test);\nstatic int sendmsg6_rw_wildcard_prog_load(const struct sock_addr_test *test);\n\nstatic struct sock_addr_test tests[] = {\n\t \n\t{\n\t\t\"bind4: load prog with wrong expected attach type\",\n\t\tbind4_prog_load,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"bind4: attach prog with wrong attach type\",\n\t\tbind4_prog_load,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_REJECT,\n\t},\n\t{\n\t\t\"bind4: rewrite IP & TCP port in\",\n\t\tbind4_prog_load,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tNULL,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"bind4: rewrite IP & UDP port in\",\n\t\tbind4_prog_load,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tNULL,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"bind6: load prog with wrong expected attach type\",\n\t\tbind6_prog_load,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tAF_INET6,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"bind6: attach prog with wrong attach type\",\n\t\tbind6_prog_load,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tBPF_CGROUP_INET4_BIND,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_REJECT,\n\t},\n\t{\n\t\t\"bind6: rewrite IP & TCP port in\",\n\t\tbind6_prog_load,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tAF_INET6,\n\t\tSOCK_STREAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tNULL,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"bind6: rewrite IP & UDP port in\",\n\t\tbind6_prog_load,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tBPF_CGROUP_INET6_BIND,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tNULL,\n\t\tSUCCESS,\n\t},\n\n\t \n\t{\n\t\t\"connect4: load prog with wrong expected attach type\",\n\t\tconnect4_prog_load,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"connect4: attach prog with wrong attach type\",\n\t\tconnect4_prog_load,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_REJECT,\n\t},\n\t{\n\t\t\"connect4: rewrite IP & TCP port\",\n\t\tconnect4_prog_load,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSRC4_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"connect4: rewrite IP & UDP port\",\n\t\tconnect4_prog_load,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSRC4_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"connect6: load prog with wrong expected attach type\",\n\t\tconnect6_prog_load,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tAF_INET6,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"connect6: attach prog with wrong attach type\",\n\t\tconnect6_prog_load,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tBPF_CGROUP_INET4_CONNECT,\n\t\tAF_INET,\n\t\tSOCK_STREAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_REJECT,\n\t},\n\t{\n\t\t\"connect6: rewrite IP & TCP port\",\n\t\tconnect6_prog_load,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tAF_INET6,\n\t\tSOCK_STREAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"connect6: rewrite IP & UDP port\",\n\t\tconnect6_prog_load,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tBPF_CGROUP_INET6_CONNECT,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\n\t \n\t{\n\t\t\"sendmsg4: load prog with wrong expected attach type\",\n\t\tsendmsg4_rw_asm_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"sendmsg4: attach prog with wrong attach type\",\n\t\tsendmsg4_rw_asm_prog_load,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_REJECT,\n\t},\n\t{\n\t\t\"sendmsg4: rewrite IP & port (asm)\",\n\t\tsendmsg4_rw_asm_prog_load,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSRC4_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"sendmsg4: rewrite IP & port (C)\",\n\t\tsendmsg4_rw_c_prog_load,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSRC4_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"sendmsg4: deny call\",\n\t\tsendmsg_deny_prog_load,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tSERV4_IP,\n\t\tSERV4_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSRC4_REWRITE_IP,\n\t\tSYSCALL_EPERM,\n\t},\n\t{\n\t\t\"sendmsg6: load prog with wrong expected attach type\",\n\t\tsendmsg6_rw_asm_prog_load,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"sendmsg6: attach prog with wrong attach type\",\n\t\tsendmsg6_rw_asm_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP4_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_REJECT,\n\t},\n\t{\n\t\t\"sendmsg6: rewrite IP & port (asm)\",\n\t\tsendmsg6_rw_asm_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"sendmsg6: rewrite IP & port (C)\",\n\t\tsendmsg6_rw_c_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"sendmsg6: IPv4-mapped IPv6\",\n\t\tsendmsg6_rw_v4mapped_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSYSCALL_ENOTSUPP,\n\t},\n\t{\n\t\t\"sendmsg6: set dst IP = [::] (BSD'ism)\",\n\t\tsendmsg6_rw_wildcard_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"sendmsg6: preserve dst IP = [::] (BSD'ism)\",\n\t\tsendmsg_allow_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tWILDCARD6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_PORT,\n\t\tSRC6_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"sendmsg6: deny call\",\n\t\tsendmsg_deny_prog_load,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tBPF_CGROUP_UDP6_SENDMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_IP,\n\t\tSERV6_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSRC6_REWRITE_IP,\n\t\tSYSCALL_EPERM,\n\t},\n\n\t \n\t{\n\t\t\"recvmsg4: return code ok\",\n\t\trecvmsg_allow_prog_load,\n\t\tBPF_CGROUP_UDP4_RECVMSG,\n\t\tBPF_CGROUP_UDP4_RECVMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_OKAY,\n\t},\n\t{\n\t\t\"recvmsg4: return code !ok\",\n\t\trecvmsg_deny_prog_load,\n\t\tBPF_CGROUP_UDP4_RECVMSG,\n\t\tBPF_CGROUP_UDP4_RECVMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"recvmsg6: return code ok\",\n\t\trecvmsg_allow_prog_load,\n\t\tBPF_CGROUP_UDP6_RECVMSG,\n\t\tBPF_CGROUP_UDP6_RECVMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tATTACH_OKAY,\n\t},\n\t{\n\t\t\"recvmsg6: return code !ok\",\n\t\trecvmsg_deny_prog_load,\n\t\tBPF_CGROUP_UDP6_RECVMSG,\n\t\tBPF_CGROUP_UDP6_RECVMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\t0,\n\t\tNULL,\n\t\tLOAD_REJECT,\n\t},\n\t{\n\t\t\"recvmsg4: rewrite IP & port (C)\",\n\t\trecvmsg4_rw_c_prog_load,\n\t\tBPF_CGROUP_UDP4_RECVMSG,\n\t\tBPF_CGROUP_UDP4_RECVMSG,\n\t\tAF_INET,\n\t\tSOCK_DGRAM,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSERV4_REWRITE_IP,\n\t\tSERV4_REWRITE_PORT,\n\t\tSERV4_IP,\n\t\tSUCCESS,\n\t},\n\t{\n\t\t\"recvmsg6: rewrite IP & port (C)\",\n\t\trecvmsg6_rw_c_prog_load,\n\t\tBPF_CGROUP_UDP6_RECVMSG,\n\t\tBPF_CGROUP_UDP6_RECVMSG,\n\t\tAF_INET6,\n\t\tSOCK_DGRAM,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSERV6_REWRITE_IP,\n\t\tSERV6_REWRITE_PORT,\n\t\tSERV6_IP,\n\t\tSUCCESS,\n\t},\n};\n\nstatic int mk_sockaddr(int domain, const char *ip, unsigned short port,\n\t\t       struct sockaddr *addr, socklen_t addr_len)\n{\n\tstruct sockaddr_in6 *addr6;\n\tstruct sockaddr_in *addr4;\n\n\tif (domain != AF_INET && domain != AF_INET6) {\n\t\tlog_err(\"Unsupported address family\");\n\t\treturn -1;\n\t}\n\n\tmemset(addr, 0, addr_len);\n\n\tif (domain == AF_INET) {\n\t\tif (addr_len < sizeof(struct sockaddr_in))\n\t\t\treturn -1;\n\t\taddr4 = (struct sockaddr_in *)addr;\n\t\taddr4->sin_family = domain;\n\t\taddr4->sin_port = htons(port);\n\t\tif (inet_pton(domain, ip, (void *)&addr4->sin_addr) != 1) {\n\t\t\tlog_err(\"Invalid IPv4: %s\", ip);\n\t\t\treturn -1;\n\t\t}\n\t} else if (domain == AF_INET6) {\n\t\tif (addr_len < sizeof(struct sockaddr_in6))\n\t\t\treturn -1;\n\t\taddr6 = (struct sockaddr_in6 *)addr;\n\t\taddr6->sin6_family = domain;\n\t\taddr6->sin6_port = htons(port);\n\t\tif (inet_pton(domain, ip, (void *)&addr6->sin6_addr) != 1) {\n\t\t\tlog_err(\"Invalid IPv6: %s\", ip);\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int load_insns(const struct sock_addr_test *test,\n\t\t      const struct bpf_insn *insns, size_t insns_cnt)\n{\n\tLIBBPF_OPTS(bpf_prog_load_opts, opts);\n\tint ret;\n\n\topts.expected_attach_type = test->expected_attach_type;\n\topts.log_buf = bpf_log_buf;\n\topts.log_size = BPF_LOG_BUF_SIZE;\n\n\tret = bpf_prog_load(BPF_PROG_TYPE_CGROUP_SOCK_ADDR, NULL, \"GPL\", insns, insns_cnt, &opts);\n\tif (ret < 0 && test->expected_result != LOAD_REJECT) {\n\t\tlog_err(\">>> Loading program error.\\n\"\n\t\t\t\">>> Verifier output:\\n%s\\n-------\\n\", bpf_log_buf);\n\t}\n\n\treturn ret;\n}\n\nstatic int load_path(const struct sock_addr_test *test, const char *path)\n{\n\tstruct bpf_object *obj;\n\tstruct bpf_program *prog;\n\tint err;\n\n\tobj = bpf_object__open_file(path, NULL);\n\terr = libbpf_get_error(obj);\n\tif (err) {\n\t\tlog_err(\">>> Opening BPF object (%s) error.\\n\", path);\n\t\treturn -1;\n\t}\n\n\tprog = bpf_object__next_program(obj, NULL);\n\tif (!prog)\n\t\tgoto err_out;\n\n\tbpf_program__set_type(prog, BPF_PROG_TYPE_CGROUP_SOCK_ADDR);\n\tbpf_program__set_expected_attach_type(prog, test->expected_attach_type);\n\tbpf_program__set_flags(prog, BPF_F_TEST_RND_HI32);\n\n\terr = bpf_object__load(obj);\n\tif (err) {\n\t\tif (test->expected_result != LOAD_REJECT)\n\t\t\tlog_err(\">>> Loading program (%s) error.\\n\", path);\n\t\tgoto err_out;\n\t}\n\n\treturn bpf_program__fd(prog);\nerr_out:\n\tbpf_object__close(obj);\n\treturn -1;\n}\n\nstatic int bind4_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, BIND4_PROG_PATH);\n}\n\nstatic int bind6_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, BIND6_PROG_PATH);\n}\n\nstatic int connect4_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, CONNECT4_PROG_PATH);\n}\n\nstatic int connect6_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, CONNECT6_PROG_PATH);\n}\n\nstatic int xmsg_ret_only_prog_load(const struct sock_addr_test *test,\n\t\t\t\t   int32_t rc)\n{\n\tstruct bpf_insn insns[] = {\n\t\t \n\t\tBPF_MOV64_IMM(BPF_REG_0, rc),\n\t\tBPF_EXIT_INSN(),\n\t};\n\treturn load_insns(test, insns, ARRAY_SIZE(insns));\n}\n\nstatic int sendmsg_allow_prog_load(const struct sock_addr_test *test)\n{\n\treturn xmsg_ret_only_prog_load(test,   1);\n}\n\nstatic int sendmsg_deny_prog_load(const struct sock_addr_test *test)\n{\n\treturn xmsg_ret_only_prog_load(test,   0);\n}\n\nstatic int recvmsg_allow_prog_load(const struct sock_addr_test *test)\n{\n\treturn xmsg_ret_only_prog_load(test,   1);\n}\n\nstatic int recvmsg_deny_prog_load(const struct sock_addr_test *test)\n{\n\treturn xmsg_ret_only_prog_load(test,   0);\n}\n\nstatic int sendmsg4_rw_asm_prog_load(const struct sock_addr_test *test)\n{\n\tstruct sockaddr_in dst4_rw_addr;\n\tstruct in_addr src4_rw_ip;\n\n\tif (inet_pton(AF_INET, SRC4_REWRITE_IP, (void *)&src4_rw_ip) != 1) {\n\t\tlog_err(\"Invalid IPv4: %s\", SRC4_REWRITE_IP);\n\t\treturn -1;\n\t}\n\n\tif (mk_sockaddr(AF_INET, SERV4_REWRITE_IP, SERV4_REWRITE_PORT,\n\t\t\t(struct sockaddr *)&dst4_rw_addr,\n\t\t\tsizeof(dst4_rw_addr)) == -1)\n\t\treturn -1;\n\n\tstruct bpf_insn insns[] = {\n\t\tBPF_MOV64_REG(BPF_REG_6, BPF_REG_1),\n\n\t\t \n\t\tBPF_LDX_MEM(BPF_W, BPF_REG_7, BPF_REG_6,\n\t\t\t    offsetof(struct bpf_sock_addr, family)),\n\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, AF_INET, 8),\n\n\t\t \n\t\tBPF_LDX_MEM(BPF_W, BPF_REG_7, BPF_REG_6,\n\t\t\t    offsetof(struct bpf_sock_addr, type)),\n\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, SOCK_DGRAM, 6),\n\n\t\t \n\t\tBPF_MOV32_IMM(BPF_REG_7, src4_rw_ip.s_addr),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_7,\n\t\t\t    offsetof(struct bpf_sock_addr, msg_src_ip4)),\n\n\t\t \n\t\tBPF_MOV32_IMM(BPF_REG_7, dst4_rw_addr.sin_addr.s_addr),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_7,\n\t\t\t    offsetof(struct bpf_sock_addr, user_ip4)),\n\n\t\t \n\t\tBPF_MOV32_IMM(BPF_REG_7, dst4_rw_addr.sin_port),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_7,\n\t\t\t    offsetof(struct bpf_sock_addr, user_port)),\n\t\t \n\n\t\t \n\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\tBPF_EXIT_INSN(),\n\t};\n\n\treturn load_insns(test, insns, ARRAY_SIZE(insns));\n}\n\nstatic int recvmsg4_rw_c_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, RECVMSG4_PROG_PATH);\n}\n\nstatic int sendmsg4_rw_c_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, SENDMSG4_PROG_PATH);\n}\n\nstatic int sendmsg6_rw_dst_asm_prog_load(const struct sock_addr_test *test,\n\t\t\t\t\t const char *rw_dst_ip)\n{\n\tstruct sockaddr_in6 dst6_rw_addr;\n\tstruct in6_addr src6_rw_ip;\n\n\tif (inet_pton(AF_INET6, SRC6_REWRITE_IP, (void *)&src6_rw_ip) != 1) {\n\t\tlog_err(\"Invalid IPv6: %s\", SRC6_REWRITE_IP);\n\t\treturn -1;\n\t}\n\n\tif (mk_sockaddr(AF_INET6, rw_dst_ip, SERV6_REWRITE_PORT,\n\t\t\t(struct sockaddr *)&dst6_rw_addr,\n\t\t\tsizeof(dst6_rw_addr)) == -1)\n\t\treturn -1;\n\n\tstruct bpf_insn insns[] = {\n\t\tBPF_MOV64_REG(BPF_REG_6, BPF_REG_1),\n\n\t\t \n\t\tBPF_LDX_MEM(BPF_W, BPF_REG_7, BPF_REG_6,\n\t\t\t    offsetof(struct bpf_sock_addr, family)),\n\t\tBPF_JMP_IMM(BPF_JNE, BPF_REG_7, AF_INET6, 18),\n\n#define STORE_IPV6_WORD_N(DST, SRC, N)\t\t\t\t\t       \\\n\t\tBPF_MOV32_IMM(BPF_REG_7, SRC[N]),\t\t\t       \\\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_7,\t\t       \\\n\t\t\t    offsetof(struct bpf_sock_addr, DST[N]))\n\n#define STORE_IPV6(DST, SRC)\t\t\t\t\t\t       \\\n\t\tSTORE_IPV6_WORD_N(DST, SRC, 0),\t\t\t\t       \\\n\t\tSTORE_IPV6_WORD_N(DST, SRC, 1),\t\t\t\t       \\\n\t\tSTORE_IPV6_WORD_N(DST, SRC, 2),\t\t\t\t       \\\n\t\tSTORE_IPV6_WORD_N(DST, SRC, 3)\n\n\t\tSTORE_IPV6(msg_src_ip6, src6_rw_ip.s6_addr32),\n\t\tSTORE_IPV6(user_ip6, dst6_rw_addr.sin6_addr.s6_addr32),\n\n\t\t \n\t\tBPF_MOV32_IMM(BPF_REG_7, dst6_rw_addr.sin6_port),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_6, BPF_REG_7,\n\t\t\t    offsetof(struct bpf_sock_addr, user_port)),\n\n\t\t \n\n\t\t \n\t\tBPF_MOV64_IMM(BPF_REG_0, 1),\n\t\tBPF_EXIT_INSN(),\n\t};\n\n\treturn load_insns(test, insns, ARRAY_SIZE(insns));\n}\n\nstatic int sendmsg6_rw_asm_prog_load(const struct sock_addr_test *test)\n{\n\treturn sendmsg6_rw_dst_asm_prog_load(test, SERV6_REWRITE_IP);\n}\n\nstatic int recvmsg6_rw_c_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, RECVMSG6_PROG_PATH);\n}\n\nstatic int sendmsg6_rw_v4mapped_prog_load(const struct sock_addr_test *test)\n{\n\treturn sendmsg6_rw_dst_asm_prog_load(test, SERV6_V4MAPPED_IP);\n}\n\nstatic int sendmsg6_rw_wildcard_prog_load(const struct sock_addr_test *test)\n{\n\treturn sendmsg6_rw_dst_asm_prog_load(test, WILDCARD6_IP);\n}\n\nstatic int sendmsg6_rw_c_prog_load(const struct sock_addr_test *test)\n{\n\treturn load_path(test, SENDMSG6_PROG_PATH);\n}\n\nstatic int cmp_addr(const struct sockaddr_storage *addr1,\n\t\t    const struct sockaddr_storage *addr2, int cmp_port)\n{\n\tconst struct sockaddr_in *four1, *four2;\n\tconst struct sockaddr_in6 *six1, *six2;\n\n\tif (addr1->ss_family != addr2->ss_family)\n\t\treturn -1;\n\n\tif (addr1->ss_family == AF_INET) {\n\t\tfour1 = (const struct sockaddr_in *)addr1;\n\t\tfour2 = (const struct sockaddr_in *)addr2;\n\t\treturn !((four1->sin_port == four2->sin_port || !cmp_port) &&\n\t\t\t four1->sin_addr.s_addr == four2->sin_addr.s_addr);\n\t} else if (addr1->ss_family == AF_INET6) {\n\t\tsix1 = (const struct sockaddr_in6 *)addr1;\n\t\tsix2 = (const struct sockaddr_in6 *)addr2;\n\t\treturn !((six1->sin6_port == six2->sin6_port || !cmp_port) &&\n\t\t\t !memcmp(&six1->sin6_addr, &six2->sin6_addr,\n\t\t\t\t sizeof(struct in6_addr)));\n\t}\n\n\treturn -1;\n}\n\nstatic int cmp_sock_addr(info_fn fn, int sock1,\n\t\t\t const struct sockaddr_storage *addr2, int cmp_port)\n{\n\tstruct sockaddr_storage addr1;\n\tsocklen_t len1 = sizeof(addr1);\n\n\tmemset(&addr1, 0, len1);\n\tif (fn(sock1, (struct sockaddr *)&addr1, (socklen_t *)&len1) != 0)\n\t\treturn -1;\n\n\treturn cmp_addr(&addr1, addr2, cmp_port);\n}\n\nstatic int cmp_local_ip(int sock1, const struct sockaddr_storage *addr2)\n{\n\treturn cmp_sock_addr(getsockname, sock1, addr2,   0);\n}\n\nstatic int cmp_local_addr(int sock1, const struct sockaddr_storage *addr2)\n{\n\treturn cmp_sock_addr(getsockname, sock1, addr2,   1);\n}\n\nstatic int cmp_peer_addr(int sock1, const struct sockaddr_storage *addr2)\n{\n\treturn cmp_sock_addr(getpeername, sock1, addr2,   1);\n}\n\nstatic int start_server(int type, const struct sockaddr_storage *addr,\n\t\t\tsocklen_t addr_len)\n{\n\tint fd;\n\n\tfd = socket(addr->ss_family, type, 0);\n\tif (fd == -1) {\n\t\tlog_err(\"Failed to create server socket\");\n\t\tgoto out;\n\t}\n\n\tif (bind(fd, (const struct sockaddr *)addr, addr_len) == -1) {\n\t\tlog_err(\"Failed to bind server socket\");\n\t\tgoto close_out;\n\t}\n\n\tif (type == SOCK_STREAM) {\n\t\tif (listen(fd, 128) == -1) {\n\t\t\tlog_err(\"Failed to listen on server socket\");\n\t\t\tgoto close_out;\n\t\t}\n\t}\n\n\tgoto out;\nclose_out:\n\tclose(fd);\n\tfd = -1;\nout:\n\treturn fd;\n}\n\nstatic int connect_to_server(int type, const struct sockaddr_storage *addr,\n\t\t\t     socklen_t addr_len)\n{\n\tint domain;\n\tint fd = -1;\n\n\tdomain = addr->ss_family;\n\n\tif (domain != AF_INET && domain != AF_INET6) {\n\t\tlog_err(\"Unsupported address family\");\n\t\tgoto err;\n\t}\n\n\tfd = socket(domain, type, 0);\n\tif (fd == -1) {\n\t\tlog_err(\"Failed to create client socket\");\n\t\tgoto err;\n\t}\n\n\tif (connect(fd, (const struct sockaddr *)addr, addr_len) == -1) {\n\t\tlog_err(\"Fail to connect to server\");\n\t\tgoto err;\n\t}\n\n\tgoto out;\nerr:\n\tclose(fd);\n\tfd = -1;\nout:\n\treturn fd;\n}\n\nint init_pktinfo(int domain, struct cmsghdr *cmsg)\n{\n\tstruct in6_pktinfo *pktinfo6;\n\tstruct in_pktinfo *pktinfo4;\n\n\tif (domain == AF_INET) {\n\t\tcmsg->cmsg_level = SOL_IP;\n\t\tcmsg->cmsg_type = IP_PKTINFO;\n\t\tcmsg->cmsg_len = CMSG_LEN(sizeof(struct in_pktinfo));\n\t\tpktinfo4 = (struct in_pktinfo *)CMSG_DATA(cmsg);\n\t\tmemset(pktinfo4, 0, sizeof(struct in_pktinfo));\n\t\tif (inet_pton(domain, SRC4_IP,\n\t\t\t      (void *)&pktinfo4->ipi_spec_dst) != 1)\n\t\t\treturn -1;\n\t} else if (domain == AF_INET6) {\n\t\tcmsg->cmsg_level = SOL_IPV6;\n\t\tcmsg->cmsg_type = IPV6_PKTINFO;\n\t\tcmsg->cmsg_len = CMSG_LEN(sizeof(struct in6_pktinfo));\n\t\tpktinfo6 = (struct in6_pktinfo *)CMSG_DATA(cmsg);\n\t\tmemset(pktinfo6, 0, sizeof(struct in6_pktinfo));\n\t\tif (inet_pton(domain, SRC6_IP,\n\t\t\t      (void *)&pktinfo6->ipi6_addr) != 1)\n\t\t\treturn -1;\n\t} else {\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nstatic int sendmsg_to_server(int type, const struct sockaddr_storage *addr,\n\t\t\t     socklen_t addr_len, int set_cmsg, int flags,\n\t\t\t     int *syscall_err)\n{\n\tunion {\n\t\tchar buf[CMSG_SPACE(sizeof(struct in6_pktinfo))];\n\t\tstruct cmsghdr align;\n\t} control6;\n\tunion {\n\t\tchar buf[CMSG_SPACE(sizeof(struct in_pktinfo))];\n\t\tstruct cmsghdr align;\n\t} control4;\n\tstruct msghdr hdr;\n\tstruct iovec iov;\n\tchar data = 'a';\n\tint domain;\n\tint fd = -1;\n\n\tdomain = addr->ss_family;\n\n\tif (domain != AF_INET && domain != AF_INET6) {\n\t\tlog_err(\"Unsupported address family\");\n\t\tgoto err;\n\t}\n\n\tfd = socket(domain, type, 0);\n\tif (fd == -1) {\n\t\tlog_err(\"Failed to create client socket\");\n\t\tgoto err;\n\t}\n\n\tmemset(&iov, 0, sizeof(iov));\n\tiov.iov_base = &data;\n\tiov.iov_len = sizeof(data);\n\n\tmemset(&hdr, 0, sizeof(hdr));\n\thdr.msg_name = (void *)addr;\n\thdr.msg_namelen = addr_len;\n\thdr.msg_iov = &iov;\n\thdr.msg_iovlen = 1;\n\n\tif (set_cmsg) {\n\t\tif (domain == AF_INET) {\n\t\t\thdr.msg_control = &control4;\n\t\t\thdr.msg_controllen = sizeof(control4.buf);\n\t\t} else if (domain == AF_INET6) {\n\t\t\thdr.msg_control = &control6;\n\t\t\thdr.msg_controllen = sizeof(control6.buf);\n\t\t}\n\t\tif (init_pktinfo(domain, CMSG_FIRSTHDR(&hdr))) {\n\t\t\tlog_err(\"Fail to init pktinfo\");\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tif (sendmsg(fd, &hdr, flags) != sizeof(data)) {\n\t\tlog_err(\"Fail to send message to server\");\n\t\t*syscall_err = errno;\n\t\tgoto err;\n\t}\n\n\tgoto out;\nerr:\n\tclose(fd);\n\tfd = -1;\nout:\n\treturn fd;\n}\n\nstatic int fastconnect_to_server(const struct sockaddr_storage *addr,\n\t\t\t\t socklen_t addr_len)\n{\n\tint sendmsg_err;\n\n\treturn sendmsg_to_server(SOCK_STREAM, addr, addr_len,  0,\n\t\t\t\t MSG_FASTOPEN, &sendmsg_err);\n}\n\nstatic int recvmsg_from_client(int sockfd, struct sockaddr_storage *src_addr)\n{\n\tstruct timeval tv;\n\tstruct msghdr hdr;\n\tstruct iovec iov;\n\tchar data[64];\n\tfd_set rfds;\n\n\tFD_ZERO(&rfds);\n\tFD_SET(sockfd, &rfds);\n\n\ttv.tv_sec = 2;\n\ttv.tv_usec = 0;\n\n\tif (select(sockfd + 1, &rfds, NULL, NULL, &tv) <= 0 ||\n\t    !FD_ISSET(sockfd, &rfds))\n\t\treturn -1;\n\n\tmemset(&iov, 0, sizeof(iov));\n\tiov.iov_base = data;\n\tiov.iov_len = sizeof(data);\n\n\tmemset(&hdr, 0, sizeof(hdr));\n\thdr.msg_name = src_addr;\n\thdr.msg_namelen = sizeof(struct sockaddr_storage);\n\thdr.msg_iov = &iov;\n\thdr.msg_iovlen = 1;\n\n\treturn recvmsg(sockfd, &hdr, 0);\n}\n\nstatic int init_addrs(const struct sock_addr_test *test,\n\t\t      struct sockaddr_storage *requested_addr,\n\t\t      struct sockaddr_storage *expected_addr,\n\t\t      struct sockaddr_storage *expected_src_addr)\n{\n\tsocklen_t addr_len = sizeof(struct sockaddr_storage);\n\n\tif (mk_sockaddr(test->domain, test->expected_ip, test->expected_port,\n\t\t\t(struct sockaddr *)expected_addr, addr_len) == -1)\n\t\tgoto err;\n\n\tif (mk_sockaddr(test->domain, test->requested_ip, test->requested_port,\n\t\t\t(struct sockaddr *)requested_addr, addr_len) == -1)\n\t\tgoto err;\n\n\tif (test->expected_src_ip &&\n\t    mk_sockaddr(test->domain, test->expected_src_ip, 0,\n\t\t\t(struct sockaddr *)expected_src_addr, addr_len) == -1)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\treturn -1;\n}\n\nstatic int run_bind_test_case(const struct sock_addr_test *test)\n{\n\tsocklen_t addr_len = sizeof(struct sockaddr_storage);\n\tstruct sockaddr_storage requested_addr;\n\tstruct sockaddr_storage expected_addr;\n\tint clientfd = -1;\n\tint servfd = -1;\n\tint err = 0;\n\n\tif (init_addrs(test, &requested_addr, &expected_addr, NULL))\n\t\tgoto err;\n\n\tservfd = start_server(test->type, &requested_addr, addr_len);\n\tif (servfd == -1)\n\t\tgoto err;\n\n\tif (cmp_local_addr(servfd, &expected_addr))\n\t\tgoto err;\n\n\t \n\tclientfd = connect_to_server(test->type, &expected_addr, addr_len);\n\tif (clientfd == -1)\n\t\tgoto err;\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\tclose(clientfd);\n\tclose(servfd);\n\treturn err;\n}\n\nstatic int run_connect_test_case(const struct sock_addr_test *test)\n{\n\tsocklen_t addr_len = sizeof(struct sockaddr_storage);\n\tstruct sockaddr_storage expected_src_addr;\n\tstruct sockaddr_storage requested_addr;\n\tstruct sockaddr_storage expected_addr;\n\tint clientfd = -1;\n\tint servfd = -1;\n\tint err = 0;\n\n\tif (init_addrs(test, &requested_addr, &expected_addr,\n\t\t       &expected_src_addr))\n\t\tgoto err;\n\n\t \n\tservfd = start_server(test->type, &expected_addr, addr_len);\n\tif (servfd == -1)\n\t\tgoto err;\n\n\tclientfd = connect_to_server(test->type, &requested_addr, addr_len);\n\tif (clientfd == -1)\n\t\tgoto err;\n\n\t \n\tif (cmp_peer_addr(clientfd, &expected_addr))\n\t\tgoto err;\n\n\tif (cmp_local_ip(clientfd, &expected_src_addr))\n\t\tgoto err;\n\n\tif (test->type == SOCK_STREAM) {\n\t\t \n\t\tclientfd = fastconnect_to_server(&requested_addr, addr_len);\n\t\tif (clientfd == -1)\n\t\t\tgoto err;\n\n\t\t \n\t\tif (cmp_peer_addr(clientfd, &expected_addr))\n\t\t\tgoto err;\n\n\t\tif (cmp_local_ip(clientfd, &expected_src_addr))\n\t\t\tgoto err;\n\t}\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\tclose(clientfd);\n\tclose(servfd);\n\treturn err;\n}\n\nstatic int run_xmsg_test_case(const struct sock_addr_test *test, int max_cmsg)\n{\n\tsocklen_t addr_len = sizeof(struct sockaddr_storage);\n\tstruct sockaddr_storage expected_addr;\n\tstruct sockaddr_storage server_addr;\n\tstruct sockaddr_storage sendmsg_addr;\n\tstruct sockaddr_storage recvmsg_addr;\n\tint clientfd = -1;\n\tint servfd = -1;\n\tint set_cmsg;\n\tint err = 0;\n\n\tif (test->type != SOCK_DGRAM)\n\t\tgoto err;\n\n\tif (init_addrs(test, &sendmsg_addr, &server_addr, &expected_addr))\n\t\tgoto err;\n\n\t \n\tservfd = start_server(test->type, &server_addr, addr_len);\n\tif (servfd == -1)\n\t\tgoto err;\n\n\tfor (set_cmsg = 0; set_cmsg <= max_cmsg; ++set_cmsg) {\n\t\tif (clientfd >= 0)\n\t\t\tclose(clientfd);\n\n\t\tclientfd = sendmsg_to_server(test->type, &sendmsg_addr,\n\t\t\t\t\t     addr_len, set_cmsg,  0,\n\t\t\t\t\t     &err);\n\t\tif (err)\n\t\t\tgoto out;\n\t\telse if (clientfd == -1)\n\t\t\tgoto err;\n\n\t\t \n\t\tif (recvmsg_from_client(servfd, &recvmsg_addr) == -1)\n\t\t\tgoto err;\n\n\t\tif (cmp_addr(&recvmsg_addr, &expected_addr,  0))\n\t\t\tgoto err;\n\t}\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\tclose(clientfd);\n\tclose(servfd);\n\treturn err;\n}\n\nstatic int run_test_case(int cgfd, const struct sock_addr_test *test)\n{\n\tint progfd = -1;\n\tint err = 0;\n\n\tprintf(\"Test case: %s .. \", test->descr);\n\n\tprogfd = test->loadfn(test);\n\tif (test->expected_result == LOAD_REJECT && progfd < 0)\n\t\tgoto out;\n\telse if (test->expected_result == LOAD_REJECT || progfd < 0)\n\t\tgoto err;\n\n\terr = bpf_prog_attach(progfd, cgfd, test->attach_type,\n\t\t\t      BPF_F_ALLOW_OVERRIDE);\n\tif (test->expected_result == ATTACH_REJECT && err) {\n\t\terr = 0;  \n\t\tgoto out;\n\t} else if (test->expected_result == ATTACH_REJECT || err) {\n\t\tgoto err;\n\t} else if (test->expected_result == ATTACH_OKAY) {\n\t\terr = 0;\n\t\tgoto out;\n\t}\n\n\tswitch (test->attach_type) {\n\tcase BPF_CGROUP_INET4_BIND:\n\tcase BPF_CGROUP_INET6_BIND:\n\t\terr = run_bind_test_case(test);\n\t\tbreak;\n\tcase BPF_CGROUP_INET4_CONNECT:\n\tcase BPF_CGROUP_INET6_CONNECT:\n\t\terr = run_connect_test_case(test);\n\t\tbreak;\n\tcase BPF_CGROUP_UDP4_SENDMSG:\n\tcase BPF_CGROUP_UDP6_SENDMSG:\n\t\terr = run_xmsg_test_case(test, 1);\n\t\tbreak;\n\tcase BPF_CGROUP_UDP4_RECVMSG:\n\tcase BPF_CGROUP_UDP6_RECVMSG:\n\t\terr = run_xmsg_test_case(test, 0);\n\t\tbreak;\n\tdefault:\n\t\tgoto err;\n\t}\n\n\tif (test->expected_result == SYSCALL_EPERM && err == EPERM) {\n\t\terr = 0;  \n\t\tgoto out;\n\t}\n\n\tif (test->expected_result == SYSCALL_ENOTSUPP && err == ENOTSUPP) {\n\t\terr = 0;  \n\t\tgoto out;\n\t}\n\n\tif (err || test->expected_result != SUCCESS)\n\t\tgoto err;\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\t \n\tif (progfd != -1)\n\t\tbpf_prog_detach(cgfd, test->attach_type);\n\tclose(progfd);\n\tprintf(\"[%s]\\n\", err ? \"FAIL\" : \"PASS\");\n\treturn err;\n}\n\nstatic int run_tests(int cgfd)\n{\n\tint passes = 0;\n\tint fails = 0;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(tests); ++i) {\n\t\tif (run_test_case(cgfd, &tests[i]))\n\t\t\t++fails;\n\t\telse\n\t\t\t++passes;\n\t}\n\tprintf(\"Summary: %d PASSED, %d FAILED\\n\", passes, fails);\n\treturn fails ? -1 : 0;\n}\n\nint main(int argc, char **argv)\n{\n\tint cgfd = -1;\n\tint err = 0;\n\n\tif (argc < 2) {\n\t\tfprintf(stderr,\n\t\t\t\"%s has to be run via %s.sh. Skip direct run.\\n\",\n\t\t\targv[0], argv[0]);\n\t\texit(err);\n\t}\n\n\tcgfd = cgroup_setup_and_join(CG_PATH);\n\tif (cgfd < 0)\n\t\tgoto err;\n\n\t \n\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);\n\n\tif (run_tests(cgfd))\n\t\tgoto err;\n\n\tgoto out;\nerr:\n\terr = -1;\nout:\n\tclose(cgfd);\n\tcleanup_cgroup_environment();\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}