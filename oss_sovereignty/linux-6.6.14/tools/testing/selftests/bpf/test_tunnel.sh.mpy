{
  "module_name": "test_tunnel.sh",
  "hash_id": "9355730cbbc56eb9ba86157030b29a416332c73f69eb51c2a6fed9044cbbb600",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_tunnel.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# End-to-end eBPF tunnel test suite\n#   The script tests BPF network tunnel implementation.\n#\n# Topology:\n# ---------\n#     root namespace   |     at_ns0 namespace\n#                      |\n#      -----------     |     -----------\n#      | tnl dev |     |     | tnl dev |  (overlay network)\n#      -----------     |     -----------\n#      metadata-mode   |     native-mode\n#       with bpf       |\n#                      |\n#      ----------      |     ----------\n#      |  veth1  | --------- |  veth0  |  (underlay network)\n#      ----------    peer    ----------\n#\n#\n# Device Configuration\n# --------------------\n# Root namespace with metadata-mode tunnel + BPF\n# Device names and addresses:\n# \tveth1 IP: 172.16.1.200, IPv6: 00::22 (underlay)\n# \ttunnel dev <type>11, ex: gre11, IPv4: 10.1.1.200, IPv6: 1::22 (overlay)\n#\n# Namespace at_ns0 with native tunnel\n# Device names and addresses:\n# \tveth0 IPv4: 172.16.1.100, IPv6: 00::11 (underlay)\n# \ttunnel dev <type>00, ex: gre00, IPv4: 10.1.1.100, IPv6: 1::11 (overlay)\n#\n#\n# End-to-end ping packet flow\n# ---------------------------\n# Most of the tests start by namespace creation, device configuration,\n# then ping the underlay and overlay network.  When doing 'ping 10.1.1.100'\n# from root namespace, the following operations happen:\n# 1) Route lookup shows 10.1.1.100/24 belongs to tnl dev, fwd to tnl dev.\n# 2) Tnl device's egress BPF program is triggered and set the tunnel metadata,\n#    with remote_ip=172.16.1.100 and others.\n# 3) Outer tunnel header is prepended and route the packet to veth1's egress\n# 4) veth0's ingress queue receive the tunneled packet at namespace at_ns0\n# 5) Tunnel protocol handler, ex: vxlan_rcv, decap the packet\n# 6) Forward the packet to the overlay tnl dev\n\nBPF_FILE=\"test_tunnel_kern.bpf.o\"\nBPF_PIN_TUNNEL_DIR=\"/sys/fs/bpf/tc/tunnel\"\nPING_ARG=\"-c 3 -w 10 -q\"\nret=0\nGREEN='\\033[0;92m'\nRED='\\033[0;31m'\nNC='\\033[0m' # No Color\n\nconfig_device()\n{\n\tip netns add at_ns0\n\tip link add veth0 type veth peer name veth1\n\tip link set veth0 netns at_ns0\n\tip netns exec at_ns0 ip addr add 172.16.1.100/24 dev veth0\n\tip netns exec at_ns0 ip link set dev veth0 up\n\tip link set dev veth1 up mtu 1500\n\tip addr add dev veth1 172.16.1.200/24\n}\n\nadd_gre_tunnel()\n{\n\ttun_key=\n\tif [ -n \"$1\" ]; then\n\t\ttun_key=\"key $1\"\n\tfi\n\n\t# at_ns0 namespace\n\tip netns exec at_ns0 \\\n        ip link add dev $DEV_NS type $TYPE seq $tun_key \\\n\t\tlocal 172.16.1.100 remote 172.16.1.200\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE $tun_key external\n\tip link set dev $DEV up\n\tip addr add dev $DEV 10.1.1.200/24\n}\n\nadd_ip6gretap_tunnel()\n{\n\n\t# assign ipv6 address\n\tip netns exec at_ns0 ip addr add ::11/96 dev veth0\n\tip netns exec at_ns0 ip link set dev veth0 up\n\tip addr add dev veth1 ::22/96\n\tip link set dev veth1 up\n\n\t# at_ns0 namespace\n\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE seq flowlabel 0xbcdef key 2 \\\n\t\tlocal ::11 remote ::22\n\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\tip netns exec at_ns0 ip addr add dev $DEV_NS fc80::100/96\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE external\n\tip addr add dev $DEV 10.1.1.200/24\n\tip addr add dev $DEV fc80::200/24\n\tip link set dev $DEV up\n}\n\nadd_erspan_tunnel()\n{\n\t# at_ns0 namespace\n\tif [ \"$1\" == \"v1\" ]; then\n\t\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE seq key 2 \\\n\t\tlocal 172.16.1.100 remote 172.16.1.200 \\\n\t\terspan_ver 1 erspan 123\n\telse\n\t\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE seq key 2 \\\n\t\tlocal 172.16.1.100 remote 172.16.1.200 \\\n\t\terspan_ver 2 erspan_dir egress erspan_hwid 3\n\tfi\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE external\n\tip link set dev $DEV up\n\tip addr add dev $DEV 10.1.1.200/24\n}\n\nadd_ip6erspan_tunnel()\n{\n\n\t# assign ipv6 address\n\tip netns exec at_ns0 ip addr add ::11/96 dev veth0\n\tip netns exec at_ns0 ip link set dev veth0 up\n\tip addr add dev veth1 ::22/96\n\tip link set dev veth1 up\n\n\t# at_ns0 namespace\n\tif [ \"$1\" == \"v1\" ]; then\n\t\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE seq key 2 \\\n\t\tlocal ::11 remote ::22 \\\n\t\terspan_ver 1 erspan 123\n\telse\n\t\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE seq key 2 \\\n\t\tlocal ::11 remote ::22 \\\n\t\terspan_ver 2 erspan_dir egress erspan_hwid 7\n\tfi\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE external\n\tip addr add dev $DEV 10.1.1.200/24\n\tip link set dev $DEV up\n}\n\nadd_geneve_tunnel()\n{\n\t# at_ns0 namespace\n\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE \\\n\t\tid 2 dstport 6081 remote 172.16.1.200\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE dstport 6081 external\n\tip link set dev $DEV up\n\tip addr add dev $DEV 10.1.1.200/24\n}\n\nadd_ip6geneve_tunnel()\n{\n\tip netns exec at_ns0 ip addr add ::11/96 dev veth0\n\tip netns exec at_ns0 ip link set dev veth0 up\n\tip addr add dev veth1 ::22/96\n\tip link set dev veth1 up\n\n\t# at_ns0 namespace\n\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE id 22 \\\n\t\tremote ::22     # geneve has no local option\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE external\n\tip addr add dev $DEV 10.1.1.200/24\n\tip link set dev $DEV up\n}\n\nadd_ipip_tunnel()\n{\n\t# at_ns0 namespace\n\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE \\\n\t\tlocal 172.16.1.100 remote 172.16.1.200\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE external\n\tip link set dev $DEV up\n\tip addr add dev $DEV 10.1.1.200/24\n}\n\nadd_ip6tnl_tunnel()\n{\n\tip netns exec at_ns0 ip addr add ::11/96 dev veth0\n\tip netns exec at_ns0 ip link set dev veth0 up\n\tip addr add dev veth1 ::22/96\n\tip link set dev veth1 up\n\n\t# at_ns0 namespace\n\tip netns exec at_ns0 \\\n\t\tip link add dev $DEV_NS type $TYPE \\\n\t\tlocal ::11 remote ::22\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 10.1.1.100/24\n\tip netns exec at_ns0 ip addr add dev $DEV_NS 1::11/96\n\tip netns exec at_ns0 ip link set dev $DEV_NS up\n\n\t# root namespace\n\tip link add dev $DEV type $TYPE external\n\tip addr add dev $DEV 10.1.1.200/24\n\tip addr add dev $DEV 1::22/96\n\tip link set dev $DEV up\n}\n\ntest_gre()\n{\n\tTYPE=gretap\n\tDEV_NS=gretap00\n\tDEV=gretap11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_gre_tunnel 2\n\tattach_bpf $DEV gre_set_tunnel gre_get_tunnel\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n        if [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_gre_no_tunnel_key()\n{\n\tTYPE=gre\n\tDEV_NS=gre00\n\tDEV=gre11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_gre_tunnel\n\tattach_bpf $DEV gre_set_tunnel_no_key gre_get_tunnel\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n        if [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_ip6gre()\n{\n\tTYPE=ip6gre\n\tDEV_NS=ip6gre00\n\tDEV=ip6gre11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\t# reuse the ip6gretap function\n\tadd_ip6gretap_tunnel\n\tattach_bpf $DEV ip6gretap_set_tunnel ip6gretap_get_tunnel\n\t# underlay\n\tping6 $PING_ARG ::11\n\t# overlay: ipv4 over ipv6\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\t# overlay: ipv6 over ipv6\n\tip netns exec at_ns0 ping6 $PING_ARG fc80::200\n\tcheck_err $?\n\tcleanup\n\n        if [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_ip6gretap()\n{\n\tTYPE=ip6gretap\n\tDEV_NS=ip6gretap00\n\tDEV=ip6gretap11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_ip6gretap_tunnel\n\tattach_bpf $DEV ip6gretap_set_tunnel ip6gretap_get_tunnel\n\t# underlay\n\tping6 $PING_ARG ::11\n\t# overlay: ipv4 over ipv6\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\t# overlay: ipv6 over ipv6\n\tip netns exec at_ns0 ping6 $PING_ARG fc80::200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_erspan()\n{\n\tTYPE=erspan\n\tDEV_NS=erspan00\n\tDEV=erspan11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_erspan_tunnel $1\n\tattach_bpf $DEV erspan_set_tunnel erspan_get_tunnel\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_ip6erspan()\n{\n\tTYPE=ip6erspan\n\tDEV_NS=ip6erspan00\n\tDEV=ip6erspan11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_ip6erspan_tunnel $1\n\tattach_bpf $DEV ip4ip6erspan_set_tunnel ip4ip6erspan_get_tunnel\n\tping6 $PING_ARG ::11\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_geneve()\n{\n\tTYPE=geneve\n\tDEV_NS=geneve00\n\tDEV=geneve11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_geneve_tunnel\n\tattach_bpf $DEV geneve_set_tunnel geneve_get_tunnel\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_ip6geneve()\n{\n\tTYPE=geneve\n\tDEV_NS=ip6geneve00\n\tDEV=ip6geneve11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_ip6geneve_tunnel\n\tattach_bpf $DEV ip6geneve_set_tunnel ip6geneve_get_tunnel\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: ip6$TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: ip6$TYPE\"${NC}\n}\n\ntest_ipip()\n{\n\tTYPE=ipip\n\tDEV_NS=ipip00\n\tDEV=ipip11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_ipip_tunnel\n\tip link set dev veth1 mtu 1500\n\tattach_bpf $DEV ipip_set_tunnel ipip_get_tunnel\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_ipip6()\n{\n\tTYPE=ip6tnl\n\tDEV_NS=ipip6tnl00\n\tDEV=ipip6tnl11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_ip6tnl_tunnel\n\tip link set dev veth1 mtu 1500\n\tattach_bpf $DEV ipip6_set_tunnel ipip6_get_tunnel\n\t# underlay\n\tping6 $PING_ARG ::11\n\t# ip4 over ip6\n\tping $PING_ARG 10.1.1.100\n\tcheck_err $?\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: $TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: $TYPE\"${NC}\n}\n\ntest_ip6ip6()\n{\n\tTYPE=ip6tnl\n\tDEV_NS=ip6ip6tnl00\n\tDEV=ip6ip6tnl11\n\tret=0\n\n\tcheck $TYPE\n\tconfig_device\n\tadd_ip6tnl_tunnel\n\tip link set dev veth1 mtu 1500\n\tattach_bpf $DEV ip6ip6_set_tunnel ip6ip6_get_tunnel\n\t# underlay\n\tping6 $PING_ARG ::11\n\t# ip6 over ip6\n\tping6 $PING_ARG 1::11\n\tcheck_err $?\n\tip netns exec at_ns0 ping6 $PING_ARG 1::22\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n                echo -e ${RED}\"FAIL: ip6$TYPE\"${NC}\n                return 1\n        fi\n        echo -e ${GREEN}\"PASS: ip6$TYPE\"${NC}\n}\n\nsetup_xfrm_tunnel()\n{\n\tauth=0x$(printf '1%.0s' {1..40})\n\tenc=0x$(printf '2%.0s' {1..32})\n\tspi_in_to_out=0x1\n\tspi_out_to_in=0x2\n\t# at_ns0 namespace\n\t# at_ns0 -> root\n\tip netns exec at_ns0 \\\n\t\tip xfrm state add src 172.16.1.100 dst 172.16.1.200 proto esp \\\n\t\t\tspi $spi_in_to_out reqid 1 mode tunnel \\\n\t\t\tauth-trunc 'hmac(sha1)' $auth 96 enc 'cbc(aes)' $enc\n\tip netns exec at_ns0 \\\n\t\tip xfrm policy add src 10.1.1.100/32 dst 10.1.1.200/32 dir out \\\n\t\ttmpl src 172.16.1.100 dst 172.16.1.200 proto esp reqid 1 \\\n\t\tmode tunnel\n\t# root -> at_ns0\n\tip netns exec at_ns0 \\\n\t\tip xfrm state add src 172.16.1.200 dst 172.16.1.100 proto esp \\\n\t\t\tspi $spi_out_to_in reqid 2 mode tunnel \\\n\t\t\tauth-trunc 'hmac(sha1)' $auth 96 enc 'cbc(aes)' $enc\n\tip netns exec at_ns0 \\\n\t\tip xfrm policy add src 10.1.1.200/32 dst 10.1.1.100/32 dir in \\\n\t\ttmpl src 172.16.1.200 dst 172.16.1.100 proto esp reqid 2 \\\n\t\tmode tunnel\n\t# address & route\n\tip netns exec at_ns0 \\\n\t\tip addr add dev veth0 10.1.1.100/32\n\tip netns exec at_ns0 \\\n\t\tip route add 10.1.1.200 dev veth0 via 172.16.1.200 \\\n\t\t\tsrc 10.1.1.100\n\n\t# root namespace\n\t# at_ns0 -> root\n\tip xfrm state add src 172.16.1.100 dst 172.16.1.200 proto esp \\\n\t\tspi $spi_in_to_out reqid 1 mode tunnel \\\n\t\tauth-trunc 'hmac(sha1)' $auth 96  enc 'cbc(aes)' $enc\n\tip xfrm policy add src 10.1.1.100/32 dst 10.1.1.200/32 dir in \\\n\t\ttmpl src 172.16.1.100 dst 172.16.1.200 proto esp reqid 1 \\\n\t\tmode tunnel\n\t# root -> at_ns0\n\tip xfrm state add src 172.16.1.200 dst 172.16.1.100 proto esp \\\n\t\tspi $spi_out_to_in reqid 2 mode tunnel \\\n\t\tauth-trunc 'hmac(sha1)' $auth 96  enc 'cbc(aes)' $enc\n\tip xfrm policy add src 10.1.1.200/32 dst 10.1.1.100/32 dir out \\\n\t\ttmpl src 172.16.1.200 dst 172.16.1.100 proto esp reqid 2 \\\n\t\tmode tunnel\n\t# address & route\n\tip addr add dev veth1 10.1.1.200/32\n\tip route add 10.1.1.100 dev veth1 via 172.16.1.100 src 10.1.1.200\n}\n\ntest_xfrm_tunnel()\n{\n\tif [[ -e /sys/kernel/tracing/trace ]]; then\n\t\tTRACE=/sys/kernel/tracing/trace\n\telse\n\t\tTRACE=/sys/kernel/debug/tracing/trace\n\tfi\n\tconfig_device\n\t> ${TRACE}\n\tsetup_xfrm_tunnel\n\tmkdir -p ${BPF_PIN_TUNNEL_DIR}\n\tbpftool prog loadall ${BPF_FILE} ${BPF_PIN_TUNNEL_DIR}\n\ttc qdisc add dev veth1 clsact\n\ttc filter add dev veth1 proto ip ingress bpf da object-pinned \\\n\t\t${BPF_PIN_TUNNEL_DIR}/xfrm_get_state\n\tip netns exec at_ns0 ping $PING_ARG 10.1.1.200\n\tsleep 1\n\tgrep \"reqid 1\" ${TRACE}\n\tcheck_err $?\n\tgrep \"spi 0x1\" ${TRACE}\n\tcheck_err $?\n\tgrep \"remote ip 0xac100164\" ${TRACE}\n\tcheck_err $?\n\tcleanup\n\n\tif [ $ret -ne 0 ]; then\n\t\techo -e ${RED}\"FAIL: xfrm tunnel\"${NC}\n\t\treturn 1\n\tfi\n\techo -e ${GREEN}\"PASS: xfrm tunnel\"${NC}\n}\n\nattach_bpf()\n{\n\tDEV=$1\n\tSET=$2\n\tGET=$3\n\tmkdir -p ${BPF_PIN_TUNNEL_DIR}\n\tbpftool prog loadall ${BPF_FILE} ${BPF_PIN_TUNNEL_DIR}/\n\ttc qdisc add dev $DEV clsact\n\ttc filter add dev $DEV egress bpf da object-pinned ${BPF_PIN_TUNNEL_DIR}/$SET\n\ttc filter add dev $DEV ingress bpf da object-pinned ${BPF_PIN_TUNNEL_DIR}/$GET\n}\n\ncleanup()\n{\n        rm -rf ${BPF_PIN_TUNNEL_DIR}\n\n\tip netns delete at_ns0 2> /dev/null\n\tip link del veth1 2> /dev/null\n\tip link del ipip11 2> /dev/null\n\tip link del ipip6tnl11 2> /dev/null\n\tip link del ip6ip6tnl11 2> /dev/null\n\tip link del gretap11 2> /dev/null\n\tip link del gre11 2> /dev/null\n\tip link del ip6gre11 2> /dev/null\n\tip link del ip6gretap11 2> /dev/null\n\tip link del geneve11 2> /dev/null\n\tip link del ip6geneve11 2> /dev/null\n\tip link del erspan11 2> /dev/null\n\tip link del ip6erspan11 2> /dev/null\n\tip xfrm policy delete dir out src 10.1.1.200/32 dst 10.1.1.100/32 2> /dev/null\n\tip xfrm policy delete dir in src 10.1.1.100/32 dst 10.1.1.200/32 2> /dev/null\n\tip xfrm state delete src 172.16.1.100 dst 172.16.1.200 proto esp spi 0x1 2> /dev/null\n\tip xfrm state delete src 172.16.1.200 dst 172.16.1.100 proto esp spi 0x2 2> /dev/null\n}\n\ncleanup_exit()\n{\n\techo \"CATCH SIGKILL or SIGINT, cleanup and exit\"\n\tcleanup\n\texit 0\n}\n\ncheck()\n{\n\tip link help 2>&1 | grep -q \"\\s$1\\s\"\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP $1: iproute2 not support\"\n\tcleanup\n\treturn 1\n\tfi\n}\n\nenable_debug()\n{\n\techo 'file ip_gre.c +p' > /sys/kernel/debug/dynamic_debug/control\n\techo 'file ip6_gre.c +p' > /sys/kernel/debug/dynamic_debug/control\n\techo 'file geneve.c +p' > /sys/kernel/debug/dynamic_debug/control\n\techo 'file ipip.c +p' > /sys/kernel/debug/dynamic_debug/control\n}\n\ncheck_err()\n{\n\tif [ $ret -eq 0 ]; then\n\t\tret=$1\n\tfi\n}\n\nbpf_tunnel_test()\n{\n\tlocal errors=0\n\n\techo \"Testing GRE tunnel...\"\n\ttest_gre\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing GRE tunnel (without tunnel keys)...\"\n\ttest_gre_no_tunnel_key\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IP6GRE tunnel...\"\n\ttest_ip6gre\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IP6GRETAP tunnel...\"\n\ttest_ip6gretap\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing ERSPAN tunnel...\"\n\ttest_erspan v2\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IP6ERSPAN tunnel...\"\n\ttest_ip6erspan v2\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing GENEVE tunnel...\"\n\ttest_geneve\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IP6GENEVE tunnel...\"\n\ttest_ip6geneve\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IPIP tunnel...\"\n\ttest_ipip\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IPIP6 tunnel...\"\n\ttest_ipip6\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IP6IP6 tunnel...\"\n\ttest_ip6ip6\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing IPSec tunnel...\"\n\ttest_xfrm_tunnel\n\terrors=$(( $errors + $? ))\n\n\treturn $errors\n}\n\ntrap cleanup 0 3 6\ntrap cleanup_exit 2 9\n\ncleanup\nbpf_tunnel_test\n\nif [ $? -ne 0 ]; then\n\techo -e \"$(basename $0): ${RED}FAIL${NC}\"\n\texit 1\nfi\necho -e \"$(basename $0): ${GREEN}PASS${NC}\"\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}