{
  "module_name": "test_bpftool_build.sh",
  "hash_id": "3fb9fb4ef9a3c0e679e123b6573c67e87eccd71214a3ec30f21fdb0c08ea0e98",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_bpftool_build.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)\n\ncase $1 in\n\t-h|--help)\n\t\techo -e \"$0 [-j <n>]\"\n\t\techo -e \"\\tTest the different ways of building bpftool.\"\n\t\techo -e \"\"\n\t\techo -e \"\\tOptions:\"\n\t\techo -e \"\\t\\t-j <n>:\\tPass -j flag to 'make'.\"\n\t\texit 0\n\t\t;;\nesac\n\nJ=$*\n\n# Assume script is located under tools/testing/selftests/bpf/. We want to start\n# build attempts from the top of kernel repository.\nSCRIPT_REL_PATH=$(realpath --relative-to=$PWD $0)\nSCRIPT_REL_DIR=$(dirname $SCRIPT_REL_PATH)\nKDIR_ROOT_DIR=$(realpath $PWD/$SCRIPT_REL_DIR/../../../../)\ncd $KDIR_ROOT_DIR\nif [ ! -e tools/bpf/bpftool/Makefile ]; then\n\techo -e \"skip:    bpftool files not found!\\n\"\n\texit 4 # KSFT_SKIP=4\nfi\n\nERROR=0\nTMPDIR=\n\n# If one build fails, continue but return non-0 on exit.\nreturn_value() {\n\tif [ -d \"$TMPDIR\" ] ; then\n\t\trm -rf -- $TMPDIR\n\tfi\n\texit $ERROR\n}\ntrap return_value EXIT\n\ncheck() {\n\tlocal dir=$(realpath $1)\n\n\techo -n \"binary:  \"\n\t# Returns non-null if file is found (and \"false\" is run)\n\tfind $dir -type f -executable -name bpftool -print -exec false {} + && \\\n\t\tERROR=1 && printf \"FAILURE: Did not find bpftool\\n\"\n}\n\nmake_and_clean() {\n\techo -e \"\\$PWD:    $PWD\"\n\techo -e \"command: make -s $* >/dev/null\"\n\tmake $J -s $* >/dev/null\n\tif [ $? -ne 0 ] ; then\n\t\tERROR=1\n\tfi\n\tif [ $# -ge 1 ] ; then\n\t\tcheck ${@: -1}\n\telse\n\t\tcheck .\n\tfi\n\t(\n\t\tif [ $# -ge 1 ] ; then\n\t\t\tcd ${@: -1}\n\t\tfi\n\t\tmake -s clean\n\t)\n\techo\n}\n\nmake_with_tmpdir() {\n\tlocal ARGS\n\n\tTMPDIR=$(mktemp -d)\n\tif [ $# -ge 2 ] ; then\n\t\tARGS=${@:1:(($# - 1))}\n\tfi\n\techo -e \"\\$PWD:    $PWD\"\n\techo -e \"command: make -s $ARGS ${@: -1}=$TMPDIR/ >/dev/null\"\n\tmake $J -s $ARGS ${@: -1}=$TMPDIR/ >/dev/null\n\tif [ $? -ne 0 ] ; then\n\t\tERROR=1\n\tfi\n\tcheck $TMPDIR\n\trm -rf -- $TMPDIR\n\techo\n}\n\necho \"Trying to build bpftool\"\necho -e \"... through kbuild\\n\"\n\nif [ -f \".config\" ] ; then\n\tmake_and_clean tools/bpf\n\t## \"make tools/bpf\" sets $(OUTPUT) to ...tools/bpf/runqslower for\n\t## runqslower, but the default (used for the \"clean\" target) is .output.\n\t## Let's make sure we clean runqslower's directory properly.\n\tmake -C tools/bpf/runqslower OUTPUT=${KDIR_ROOT_DIR}/tools/bpf/runqslower/ clean\n\n\t## $OUTPUT is overwritten in kbuild Makefile, and thus cannot be passed\n\t## down from toplevel Makefile to bpftool's Makefile.\n\n\t# make_with_tmpdir tools/bpf OUTPUT\n\techo -e \"skip:    make tools/bpf OUTPUT=<dir> (not supported)\\n\"\n\n\tmake_with_tmpdir tools/bpf O\nelse\n\techo -e \"skip:    make tools/bpf (no .config found)\\n\"\n\techo -e \"skip:    make tools/bpf OUTPUT=<dir> (not supported)\\n\"\n\techo -e \"skip:    make tools/bpf O=<dir> (no .config found)\\n\"\nfi\n\necho -e \"... from kernel source tree\\n\"\n\nmake_and_clean -C tools/bpf/bpftool\n\nmake_with_tmpdir -C tools/bpf/bpftool OUTPUT\n\nmake_with_tmpdir -C tools/bpf/bpftool O\n\necho -e \"... from tools/\\n\"\ncd tools/\n\nmake_and_clean bpf\n\n## In tools/bpf/Makefile, function \"descend\" is called and passes $(O) and\n## $(OUTPUT). We would like $(OUTPUT) to have \"bpf/bpftool/\" appended before\n## calling bpftool's Makefile, but this is not the case as the \"descend\"\n## function focuses on $(O)/$(subdir). However, in the present case, updating\n## $(O) to have $(OUTPUT) recomputed from it in bpftool's Makefile does not\n## work, because $(O) is not defined from command line and $(OUTPUT) is not\n## updated in tools/scripts/Makefile.include.\n##\n## Workarounds would require to a) edit \"descend\" or use an alternative way to\n## call bpftool's Makefile, b) modify the conditions to update $(OUTPUT) and\n## other variables in tools/scripts/Makefile.include (at the risk of breaking\n## the build of other tools), or c) append manually the \"bpf/bpftool\" suffix to\n## $(OUTPUT) in bpf's Makefile, which may break if targets for other directories\n## use \"descend\" in the future.\n\n# make_with_tmpdir bpf OUTPUT\necho -e \"skip:    make bpf OUTPUT=<dir> (not supported)\\n\"\n\nmake_with_tmpdir bpf O\n\necho -e \"... from bpftool's dir\\n\"\ncd bpf/bpftool\n\nmake_and_clean\n\nmake_with_tmpdir OUTPUT\n\nmake_with_tmpdir O\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}