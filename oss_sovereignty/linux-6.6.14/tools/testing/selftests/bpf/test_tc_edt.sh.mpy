{
  "module_name": "test_tc_edt.sh",
  "hash_id": "010d0d23690644e92a7e0b9b03f68e70f64faa2c7f4d825ef7e7c53b7c4b8790",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_tc_edt.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test installs a TC bpf program that throttles a TCP flow\n# with dst port = 9000 down to 5MBps. Then it measures actual\n# throughput of the flow.\n\nBPF_FILE=\"test_tc_edt.bpf.o\"\nif [[ $EUID -ne 0 ]]; then\n\techo \"This script must be run as root\"\n\techo \"FAIL\"\n\texit 1\nfi\n\n# check that nc, dd, and timeout are present\ncommand -v nc >/dev/null 2>&1 || \\\n\t{ echo >&2 \"nc is not available\"; exit 1; }\ncommand -v dd >/dev/null 2>&1 || \\\n\t{ echo >&2 \"nc is not available\"; exit 1; }\ncommand -v timeout >/dev/null 2>&1 || \\\n\t{ echo >&2 \"timeout is not available\"; exit 1; }\n\nreadonly NS_SRC=\"ns-src-$(mktemp -u XXXXXX)\"\nreadonly NS_DST=\"ns-dst-$(mktemp -u XXXXXX)\"\n\nreadonly IP_SRC=\"172.16.1.100\"\nreadonly IP_DST=\"172.16.2.100\"\n\ncleanup()\n{\n\tip netns del ${NS_SRC}\n\tip netns del ${NS_DST}\n}\n\ntrap cleanup EXIT\n\nset -e  # exit on error\n\nip netns add \"${NS_SRC}\"\nip netns add \"${NS_DST}\"\nip link add veth_src type veth peer name veth_dst\nip link set veth_src netns ${NS_SRC}\nip link set veth_dst netns ${NS_DST}\n\nip -netns ${NS_SRC} addr add ${IP_SRC}/24  dev veth_src\nip -netns ${NS_DST} addr add ${IP_DST}/24  dev veth_dst\n\nip -netns ${NS_SRC} link set dev veth_src up\nip -netns ${NS_DST} link set dev veth_dst up\n\nip -netns ${NS_SRC} route add ${IP_DST}/32  dev veth_src\nip -netns ${NS_DST} route add ${IP_SRC}/32  dev veth_dst\n\n# set up TC on TX\nip netns exec ${NS_SRC} tc qdisc add dev veth_src root fq\nip netns exec ${NS_SRC} tc qdisc add dev veth_src clsact\nip netns exec ${NS_SRC} tc filter add dev veth_src egress \\\n\tbpf da obj ${BPF_FILE} sec cls_test\n\n\n# start the listener\nip netns exec ${NS_DST} bash -c \\\n\t\"nc -4 -l -p 9000 >/dev/null &\"\ndeclare -i NC_PID=$!\nsleep 1\n\ndeclare -ir TIMEOUT=20\ndeclare -ir EXPECTED_BPS=5000000\n\n# run the load, capture RX bytes on DST\ndeclare -ir RX_BYTES_START=$( ip netns exec ${NS_DST} \\\n\tcat /sys/class/net/veth_dst/statistics/rx_bytes )\n\nset +e\nip netns exec ${NS_SRC} bash -c \"timeout ${TIMEOUT} dd if=/dev/zero \\\n\tbs=1000 count=1000000 > /dev/tcp/${IP_DST}/9000 2>/dev/null\"\nset -e\n\ndeclare -ir RX_BYTES_END=$( ip netns exec ${NS_DST} \\\n\tcat /sys/class/net/veth_dst/statistics/rx_bytes )\n\ndeclare -ir ACTUAL_BPS=$(( ($RX_BYTES_END - $RX_BYTES_START) / $TIMEOUT ))\n\necho $TIMEOUT $ACTUAL_BPS $EXPECTED_BPS | \\\n\tawk '{printf \"elapsed: %d sec; bps difference: %.2f%%\\n\",\n\t\t$1, ($2-$3)*100.0/$3}'\n\n# Pass the test if the actual bps is within 1% of the expected bps.\n# The difference is usually about 0.1% on a 20-sec test, and ==> zero\n# the longer the test runs.\ndeclare -ir RES=$( echo $ACTUAL_BPS $EXPECTED_BPS | \\\n\t awk 'function abs(x){return ((x < 0.0) ? -x : x)}\n\t      {if (abs(($1-$2)*100.0/$2) > 1.0) { print \"1\" }\n\t\telse { print \"0\"} }' )\nif [ \"${RES}\" == \"0\" ] ; then\n\techo \"PASS\"\nelse\n\techo \"FAIL\"\n\texit 1\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}