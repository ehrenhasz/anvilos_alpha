{
  "module_name": "test_xdp_redirect_multi.sh",
  "hash_id": "9b34311c1286f0a7e79d90cc77abd3c4d84e44acdd4a1c68ed053a9a0b2d27c1",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/bpf/test_xdp_redirect_multi.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test topology:\n#    - - - - - - - - - - - - - - - - - - -\n#    | veth1         veth2         veth3 |  ns0\n#     - -| - - - - - - | - - - - - - | - -\n#    ---------     ---------     ---------\n#    | veth0 |     | veth0 |     | veth0 |\n#    ---------     ---------     ---------\n#       ns1           ns2           ns3\n#\n# Test modules:\n# XDP modes: generic, native, native + egress_prog\n#\n# Test cases:\n#   ARP: Testing BPF_F_BROADCAST, the ingress interface also should receive\n#   the redirects.\n#      ns1 -> gw: ns1, ns2, ns3, should receive the arp request\n#   IPv4: Testing BPF_F_BROADCAST | BPF_F_EXCLUDE_INGRESS, the ingress\n#   interface should not receive the redirects.\n#      ns1 -> gw: ns1 should not receive, ns2, ns3 should receive redirects.\n#   IPv6: Testing none flag, all the pkts should be redirected back\n#      ping test: ns1 -> ns2 (block), echo requests will be redirect back\n#   egress_prog:\n#      all src mac should be egress interface's mac\n\n# netns numbers\nNUM=3\nIFACES=\"\"\nDRV_MODE=\"xdpgeneric xdpdrv xdpegress\"\nPASS=0\nFAIL=0\nLOG_DIR=$(mktemp -d)\ndeclare -a NS\nNS[0]=\"ns0-$(mktemp -u XXXXXX)\"\nNS[1]=\"ns1-$(mktemp -u XXXXXX)\"\nNS[2]=\"ns2-$(mktemp -u XXXXXX)\"\nNS[3]=\"ns3-$(mktemp -u XXXXXX)\"\n\ntest_pass()\n{\n\techo \"Pass: $@\"\n\tPASS=$((PASS + 1))\n}\n\ntest_fail()\n{\n\techo \"fail: $@\"\n\tFAIL=$((FAIL + 1))\n}\n\nclean_up()\n{\n\tfor i in $(seq 0 $NUM); do\n\t\tip netns del ${NS[$i]} 2> /dev/null\n\tdone\n}\n\n# Kselftest framework requirement - SKIP code is 4.\ncheck_env()\n{\n\tip link set dev lo xdpgeneric off &>/dev/null\n\tif [ $? -ne 0 ];then\n\t\techo \"selftests: [SKIP] Could not run test without the ip xdpgeneric support\"\n\t\texit 4\n\tfi\n\n\twhich tcpdump &>/dev/null\n\tif [ $? -ne 0 ];then\n\t\techo \"selftests: [SKIP] Could not run test without tcpdump\"\n\t\texit 4\n\tfi\n}\n\nsetup_ns()\n{\n\tlocal mode=$1\n\tIFACES=\"\"\n\n\tif [ \"$mode\" = \"xdpegress\" ]; then\n\t\tmode=\"xdpdrv\"\n\tfi\n\n\tip netns add ${NS[0]}\n\tfor i in $(seq $NUM); do\n\t        ip netns add ${NS[$i]}\n\t\tip -n ${NS[$i]} link add veth0 type veth peer name veth$i netns ${NS[0]}\n\t\tip -n ${NS[$i]} link set veth0 up\n\t\tip -n ${NS[0]} link set veth$i up\n\n\t\tip -n ${NS[$i]} addr add 192.0.2.$i/24 dev veth0\n\t\tip -n ${NS[$i]} addr add 2001:db8::$i/64 dev veth0\n\t\t# Add a neigh entry for IPv4 ping test\n\t\tip -n ${NS[$i]} neigh add 192.0.2.253 lladdr 00:00:00:00:00:01 dev veth0\n\t\tip -n ${NS[$i]} link set veth0 $mode obj \\\n\t\t\txdp_dummy.bpf.o sec xdp &> /dev/null || \\\n\t\t\t{ test_fail \"Unable to load dummy xdp\" && exit 1; }\n\t\tIFACES=\"$IFACES veth$i\"\n\t\tveth_mac[$i]=$(ip -n ${NS[0]} link show veth$i | awk '/link\\/ether/ {print $2}')\n\tdone\n}\n\ndo_egress_tests()\n{\n\tlocal mode=$1\n\n\t# mac test\n\tip netns exec ${NS[2]} tcpdump -e -i veth0 -nn -l -e &> ${LOG_DIR}/mac_ns1-2_${mode}.log &\n\tip netns exec ${NS[3]} tcpdump -e -i veth0 -nn -l -e &> ${LOG_DIR}/mac_ns1-3_${mode}.log &\n\tsleep 0.5\n\tip netns exec ${NS[1]} ping 192.0.2.254 -i 0.1 -c 4 &> /dev/null\n\tsleep 0.5\n\tpkill tcpdump\n\n\t# mac check\n\tgrep -q \"${veth_mac[2]} > ff:ff:ff:ff:ff:ff\" ${LOG_DIR}/mac_ns1-2_${mode}.log && \\\n\t       test_pass \"$mode mac ns1-2\" || test_fail \"$mode mac ns1-2\"\n\tgrep -q \"${veth_mac[3]} > ff:ff:ff:ff:ff:ff\" ${LOG_DIR}/mac_ns1-3_${mode}.log && \\\n\t\ttest_pass \"$mode mac ns1-3\" || test_fail \"$mode mac ns1-3\"\n}\n\ndo_ping_tests()\n{\n\tlocal mode=$1\n\n\t# ping6 test: echo request should be redirect back to itself, not others\n\tip netns exec ${NS[1]} ip neigh add 2001:db8::2 dev veth0 lladdr 00:00:00:00:00:02\n\n\tip netns exec ${NS[1]} tcpdump -i veth0 -nn -l -e &> ${LOG_DIR}/ns1-1_${mode}.log &\n\tip netns exec ${NS[2]} tcpdump -i veth0 -nn -l -e &> ${LOG_DIR}/ns1-2_${mode}.log &\n\tip netns exec ${NS[3]} tcpdump -i veth0 -nn -l -e &> ${LOG_DIR}/ns1-3_${mode}.log &\n\tsleep 0.5\n\t# ARP test\n\tip netns exec ${NS[1]} arping -q -c 2 -I veth0 192.0.2.254\n\t# IPv4 test\n\tip netns exec ${NS[1]} ping 192.0.2.253 -i 0.1 -c 4 &> /dev/null\n\t# IPv6 test\n\tip netns exec ${NS[1]} ping6 2001:db8::2 -i 0.1 -c 2 &> /dev/null\n\tsleep 0.5\n\tpkill tcpdump\n\n\t# All netns should receive the redirect arp requests\n\t[ $(grep -cF \"who-has 192.0.2.254\" ${LOG_DIR}/ns1-1_${mode}.log) -eq 4 ] && \\\n\t\ttest_pass \"$mode arp(F_BROADCAST) ns1-1\" || \\\n\t\ttest_fail \"$mode arp(F_BROADCAST) ns1-1\"\n\t[ $(grep -cF \"who-has 192.0.2.254\" ${LOG_DIR}/ns1-2_${mode}.log) -eq 2 ] && \\\n\t\ttest_pass \"$mode arp(F_BROADCAST) ns1-2\" || \\\n\t\ttest_fail \"$mode arp(F_BROADCAST) ns1-2\"\n\t[ $(grep -cF \"who-has 192.0.2.254\" ${LOG_DIR}/ns1-3_${mode}.log) -eq 2 ] && \\\n\t\ttest_pass \"$mode arp(F_BROADCAST) ns1-3\" || \\\n\t\ttest_fail \"$mode arp(F_BROADCAST) ns1-3\"\n\n\t# ns1 should not receive the redirect echo request, others should\n\t[ $(grep -c \"ICMP echo request\" ${LOG_DIR}/ns1-1_${mode}.log) -eq 4 ] && \\\n\t\ttest_pass \"$mode IPv4 (F_BROADCAST|F_EXCLUDE_INGRESS) ns1-1\" || \\\n\t\ttest_fail \"$mode IPv4 (F_BROADCAST|F_EXCLUDE_INGRESS) ns1-1\"\n\t[ $(grep -c \"ICMP echo request\" ${LOG_DIR}/ns1-2_${mode}.log) -eq 4 ] && \\\n\t\ttest_pass \"$mode IPv4 (F_BROADCAST|F_EXCLUDE_INGRESS) ns1-2\" || \\\n\t\ttest_fail \"$mode IPv4 (F_BROADCAST|F_EXCLUDE_INGRESS) ns1-2\"\n\t[ $(grep -c \"ICMP echo request\" ${LOG_DIR}/ns1-3_${mode}.log) -eq 4 ] && \\\n\t\ttest_pass \"$mode IPv4 (F_BROADCAST|F_EXCLUDE_INGRESS) ns1-3\" || \\\n\t\ttest_fail \"$mode IPv4 (F_BROADCAST|F_EXCLUDE_INGRESS) ns1-3\"\n\n\t# ns1 should receive the echo request, ns2 should not\n\t[ $(grep -c \"ICMP6, echo request\" ${LOG_DIR}/ns1-1_${mode}.log) -eq 4 ] && \\\n\t\ttest_pass \"$mode IPv6 (no flags) ns1-1\" || \\\n\t\ttest_fail \"$mode IPv6 (no flags) ns1-1\"\n\t[ $(grep -c \"ICMP6, echo request\" ${LOG_DIR}/ns1-2_${mode}.log) -eq 0 ] && \\\n\t\ttest_pass \"$mode IPv6 (no flags) ns1-2\" || \\\n\t\ttest_fail \"$mode IPv6 (no flags) ns1-2\"\n}\n\ndo_tests()\n{\n\tlocal mode=$1\n\tlocal drv_p\n\n\tcase ${mode} in\n\t\txdpdrv)  drv_p=\"-N\";;\n\t\txdpegress) drv_p=\"-X\";;\n\t\txdpgeneric) drv_p=\"-S\";;\n\tesac\n\n\tip netns exec ${NS[0]} ./xdp_redirect_multi $drv_p $IFACES &> ${LOG_DIR}/xdp_redirect_${mode}.log &\n\txdp_pid=$!\n\tsleep 1\n\tif ! ps -p $xdp_pid > /dev/null; then\n\t\ttest_fail \"$mode xdp_redirect_multi start failed\"\n\t\treturn 1\n\tfi\n\n\tif [ \"$mode\" = \"xdpegress\" ]; then\n\t\tdo_egress_tests $mode\n\telse\n\t\tdo_ping_tests $mode\n\tfi\n\n\tkill $xdp_pid\n}\n\ncheck_env\n\ntrap clean_up EXIT\n\nfor mode in ${DRV_MODE}; do\n\tsetup_ns $mode\n\tdo_tests $mode\n\tclean_up\ndone\nrm -rf ${LOG_DIR}\n\necho \"Summary: PASS $PASS, FAIL $FAIL\"\n[ $FAIL -eq 0 ] && exit 0 || exit 1\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}