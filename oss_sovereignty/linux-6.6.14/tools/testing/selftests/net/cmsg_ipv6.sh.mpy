{
  "module_name": "cmsg_ipv6.sh",
  "hash_id": "4140933f58d04eb05a6223e5295ebdbc44697755c45095ced3eb636cd5b58ee0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/cmsg_ipv6.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nksft_skip=4\n\nNS=ns\nIP6=2001:db8:1::1/64\nTGT6=2001:db8:1::2\nTMPF=$(mktemp --suffix \".pcap\")\n\ncleanup()\n{\n    rm -f $TMPF\n    ip netns del $NS\n}\n\ntrap cleanup EXIT\n\nNSEXE=\"ip netns exec $NS\"\n\ntcpdump -h | grep immediate-mode >> /dev/null\nif [ $? -ne 0 ]; then\n    echo \"SKIP - tcpdump with --immediate-mode option required\"\n    exit $ksft_skip\nfi\n\n# Namespaces\nip netns add $NS\n\n$NSEXE sysctl -w net.ipv4.ping_group_range='0 2147483647' > /dev/null\n\n# Connectivity\nip -netns $NS link add type dummy\nip -netns $NS link set dev dummy0 up\nip -netns $NS addr add $IP6 dev dummy0\n\n# Test\nBAD=0\nTOTAL=0\n\ncheck_result() {\n    ((TOTAL++))\n    if [ $1 -ne $2 ]; then\n\techo \"  Case $3 returned $1, expected $2\"\n\t((BAD++))\n    fi\n}\n\n# IPV6_DONTFRAG\nfor ovr in setsock cmsg both diff; do\n    for df in 0 1; do\n\tfor p in u i r; do\n\t    [ $p == \"u\" ] && prot=UDP\n\t    [ $p == \"i\" ] && prot=ICMP\n\t    [ $p == \"r\" ] && prot=RAW\n\n\t    [ $ovr == \"setsock\" ] && m=\"-F $df\"\n\t    [ $ovr == \"cmsg\" ]    && m=\"-f $df\"\n\t    [ $ovr == \"both\" ]    && m=\"-F $df -f $df\"\n\t    [ $ovr == \"diff\" ]    && m=\"-F $((1 - df)) -f $df\"\n\n\t    $NSEXE ./cmsg_sender -s -S 2000 -6 -p $p $m $TGT6 1234\n\t    check_result $? $df \"DONTFRAG $prot $ovr\"\n\tdone\n    done\ndone\n\n# IPV6_TCLASS\nTOS=0x10\nTOS2=0x20\n\nip -6 -netns $NS rule add tos $TOS lookup 300\nip -6 -netns $NS route add table 300 prohibit any\n\nfor ovr in setsock cmsg both diff; do\n    for p in u i r; do\n\t[ $p == \"u\" ] && prot=UDP\n\t[ $p == \"i\" ] && prot=ICMP\n\t[ $p == \"r\" ] && prot=RAW\n\n\t[ $ovr == \"setsock\" ] && m=\"-C\"\n\t[ $ovr == \"cmsg\" ]    && m=\"-c\"\n\t[ $ovr == \"both\" ]    && m=\"-C $((TOS2)) -c\"\n\t[ $ovr == \"diff\" ]    && m=\"-C $((TOS )) -c\"\n\n\t$NSEXE nohup tcpdump --immediate-mode -p -ni dummy0 -w $TMPF -c 4 2> /dev/null &\n\tBG=$!\n\tsleep 0.05\n\n\t$NSEXE ./cmsg_sender -6 -p $p $m $((TOS2)) $TGT6 1234\n\tcheck_result $? 0 \"TCLASS $prot $ovr - pass\"\n\n\twhile [ -d /proc/$BG ]; do\n\t    $NSEXE ./cmsg_sender -6 -p u $TGT6 1234\n\tdone\n\n\ttcpdump -r $TMPF -v 2>&1 | grep \"class $TOS2\" >> /dev/null\n\tcheck_result $? 0 \"TCLASS $prot $ovr - packet data\"\n\trm $TMPF\n\n\t[ $ovr == \"both\" ]    && m=\"-C $((TOS )) -c\"\n\t[ $ovr == \"diff\" ]    && m=\"-C $((TOS2)) -c\"\n\n\t$NSEXE ./cmsg_sender -6 -p $p $m $((TOS)) -s $TGT6 1234\n\tcheck_result $? 1 \"TCLASS $prot $ovr - rejection\"\n    done\ndone\n\n# IPV6_HOPLIMIT\nLIM=4\n\nfor ovr in setsock cmsg both diff; do\n    for p in u i r; do\n\t[ $p == \"u\" ] && prot=UDP\n\t[ $p == \"i\" ] && prot=ICMP\n\t[ $p == \"r\" ] && prot=RAW\n\n\t[ $ovr == \"setsock\" ] && m=\"-L\"\n\t[ $ovr == \"cmsg\" ]    && m=\"-l\"\n\t[ $ovr == \"both\" ]    && m=\"-L $LIM -l\"\n\t[ $ovr == \"diff\" ]    && m=\"-L $((LIM + 1)) -l\"\n\n\t$NSEXE nohup tcpdump --immediate-mode -p -ni dummy0 -w $TMPF -c 4 2> /dev/null &\n\tBG=$!\n\tsleep 0.05\n\n\t$NSEXE ./cmsg_sender -6 -p $p $m $LIM $TGT6 1234\n\tcheck_result $? 0 \"HOPLIMIT $prot $ovr - pass\"\n\n\twhile [ -d /proc/$BG ]; do\n\t    $NSEXE ./cmsg_sender -6 -p u $TGT6 1234\n\tdone\n\n\ttcpdump -r $TMPF -v 2>&1 | grep \"hlim $LIM[^0-9]\" >> /dev/null\n\tcheck_result $? 0 \"HOPLIMIT $prot $ovr - packet data\"\n\trm $TMPF\n    done\ndone\n\n# IPV6 exthdr\nfor p in u i r; do\n    # Very basic \"does it crash\" test\n    for h in h d r; do\n\t$NSEXE ./cmsg_sender -p $p -6 -H $h $TGT6 1234\n\tcheck_result $? 0 \"ExtHdr $prot $ovr - pass\"\n    done\ndone\n\n# Summary\nif [ $BAD -ne 0 ]; then\n    echo \"FAIL - $BAD/$TOTAL cases failed\"\n    exit 1\nelse\n    echo \"OK\"\n    exit 0\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}