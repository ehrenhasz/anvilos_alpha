{
  "module_name": "veth.sh",
  "hash_id": "9571e62ba570dda13b6ebb0c3b45b446b4c4ec462f5b701319c72be337b4514a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/veth.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\nBPF_FILE=\"../bpf/xdp_dummy.bpf.o\"\nreadonly STATS=\"$(mktemp -p /tmp ns-XXXXXX)\"\nreadonly BASE=`basename $STATS`\nreadonly SRC=2\nreadonly DST=1\nreadonly DST_NAT=100\nreadonly NS_SRC=$BASE$SRC\nreadonly NS_DST=$BASE$DST\n\n# \"baremetal\" network used for raw UDP traffic\nreadonly BM_NET_V4=192.168.1.\nreadonly BM_NET_V6=2001:db8::\n\nreadonly CPUS=`nproc`\nret=0\n\ncleanup() {\n\tlocal ns\n\tlocal jobs\n\treadonly jobs=\"$(jobs -p)\"\n\t[ -n \"${jobs}\" ] && kill -1 ${jobs} 2>/dev/null\n\trm -f $STATS\n\n\tfor ns in $NS_SRC $NS_DST; do\n\t\tip netns del $ns 2>/dev/null\n\tdone\n}\n\ntrap cleanup EXIT\n\ncreate_ns() {\n\tlocal ns\n\n\tfor ns in $NS_SRC $NS_DST; do\n\t\tip netns add $ns\n\t\tip -n $ns link set dev lo up\n\tdone\n\n\tip link add name veth$SRC type veth peer name veth$DST\n\n\tfor ns in $SRC $DST; do\n\t\tip link set dev veth$ns netns $BASE$ns up\n\t\tip -n $BASE$ns addr add dev veth$ns $BM_NET_V4$ns/24\n\t\tip -n $BASE$ns addr add dev veth$ns $BM_NET_V6$ns/64 nodad\n\tdone\n\techo \"#kernel\" > $BASE\n\tchmod go-rw $BASE\n}\n\n__chk_flag() {\n\tlocal msg=\"$1\"\n\tlocal target=$2\n\tlocal expected=$3\n\tlocal flagname=$4\n\n\tlocal flag=`ip netns exec $BASE$target ethtool -k veth$target |\\\n\t\t    grep $flagname | awk '{print $2}'`\n\n\tprintf \"%-60s\" \"$msg\"\n\tif [ \"$flag\" = \"$expected\" ]; then\n\t\techo \" ok \"\n\telse\n\t\techo \" fail - expected $expected found $flag\"\n\t\tret=1\n\tfi\n}\n\nchk_gro_flag() {\n\t__chk_flag \"$1\" $2 $3 generic-receive-offload\n}\n\nchk_tso_flag() {\n\t__chk_flag \"$1\" $2 $3 tcp-segmentation-offload\n}\n\nchk_channels() {\n\tlocal msg=\"$1\"\n\tlocal target=$2\n\tlocal rx=$3\n\tlocal tx=$4\n\n\tlocal dev=veth$target\n\n\tlocal cur_rx=`ip netns exec $BASE$target ethtool -l $dev |\\\n\t\tgrep RX: | tail -n 1 | awk '{print $2}' `\n\t\tlocal cur_tx=`ip netns exec $BASE$target ethtool -l $dev |\\\n\t\tgrep TX: | tail -n 1 | awk '{print $2}'`\n\tlocal cur_combined=`ip netns exec $BASE$target ethtool -l $dev |\\\n\t\tgrep Combined: | tail -n 1 | awk '{print $2}'`\n\n\tprintf \"%-60s\" \"$msg\"\n\tif [ \"$cur_rx\" = \"$rx\" -a \"$cur_tx\" = \"$tx\" -a \"$cur_combined\" = \"n/a\" ]; then\n\t\techo \" ok \"\n\telse\n\t\techo \" fail rx:$rx:$cur_rx tx:$tx:$cur_tx combined:n/a:$cur_combined\"\n\tfi\n}\n\nchk_gro() {\n\tlocal msg=\"$1\"\n\tlocal expected=$2\n\n\tip netns exec $BASE$SRC ping -qc 1 $BM_NET_V4$DST >/dev/null\n\tNSTAT_HISTORY=$STATS ip netns exec $NS_DST nstat -n\n\n\tprintf \"%-60s\" \"$msg\"\n\tip netns exec $BASE$DST ./udpgso_bench_rx -C 1000 -R 10 &\n\tlocal spid=$!\n\tsleep 0.1\n\n\tip netns exec $NS_SRC ./udpgso_bench_tx -4 -s 13000 -S 1300 -M 1 -D $BM_NET_V4$DST\n\tlocal retc=$?\n\twait $spid\n\tlocal rets=$?\n\tif [ ${rets} -ne 0 ] || [ ${retc} -ne 0 ]; then\n\t\techo \" fail client exit code $retc, server $rets\"\n\t\tret=1\n\t\treturn\n\tfi\n\n\tlocal pkts=`NSTAT_HISTORY=$STATS ip netns exec $NS_DST nstat IpInReceives | \\\n\t\t    awk '{print $2}' | tail -n 1`\n\tif [ \"$pkts\" = \"$expected\" ]; then\n\t\techo \" ok \"\n\telse\n\t\techo \" fail - got $pkts packets, expected $expected \"\n\t\tret=1\n\tfi\n}\n\n__change_channels()\n{\n\tlocal cur_cpu\n\tlocal end=$1\n\tlocal cur\n\tlocal i\n\n\twhile true; do\n\t\tprintf -v cur '%(%s)T'\n\t\t[ $cur -le $end ] || break\n\n\t\tfor i in `seq 1 $CPUS`; do\n\t\t\tip netns exec $NS_SRC ethtool -L veth$SRC rx $i tx $i\n\t\t\tip netns exec $NS_DST ethtool -L veth$DST rx $i tx $i\n\t\tdone\n\n\t\tfor i in `seq 1 $((CPUS - 1))`; do\n\t\t\tcur_cpu=$((CPUS - $i))\n\t\t\tip netns exec $NS_SRC ethtool -L veth$SRC rx $cur_cpu tx $cur_cpu\n\t\t\tip netns exec $NS_DST ethtool -L veth$DST rx $cur_cpu tx $cur_cpu\n\t\tdone\n\tdone\n}\n\n__send_data() {\n\tlocal end=$1\n\n\twhile true; do\n\t\tprintf -v cur '%(%s)T'\n\t\t[ $cur -le $end ] || break\n\n\t\tip netns exec $NS_SRC ./udpgso_bench_tx -4 -s 1000 -M 300 -D $BM_NET_V4$DST\n\tdone\n}\n\ndo_stress() {\n\tlocal end\n\tprintf -v end '%(%s)T'\n\tend=$((end + $STRESS))\n\n\tip netns exec $NS_SRC ethtool -L veth$SRC rx 3 tx 3\n\tip netns exec $NS_DST ethtool -L veth$DST rx 3 tx 3\n\n\tip netns exec $NS_DST ./udpgso_bench_rx &\n\tlocal rx_pid=$!\n\n\techo \"Running stress test for $STRESS seconds...\"\n\t__change_channels $end &\n\tlocal ch_pid=$!\n\t__send_data $end &\n\tlocal data_pid_1=$!\n\t__send_data $end &\n\tlocal data_pid_2=$!\n\t__send_data $end &\n\tlocal data_pid_3=$!\n\t__send_data $end &\n\tlocal data_pid_4=$!\n\n\twait $ch_pid $data_pid_1 $data_pid_2 $data_pid_3 $data_pid_4\n\tkill -9 $rx_pid\n\techo \"done\"\n\n\t# restore previous setting\n\tip netns exec $NS_SRC ethtool -L veth$SRC rx 2 tx 2\n\tip netns exec $NS_DST ethtool -L veth$DST rx 2 tx 1\n}\n\nusage() {\n\techo \"Usage: $0 [-h] [-s <seconds>]\"\n\techo -e \"\\t-h: show this help\"\n\techo -e \"\\t-s: run optional stress tests for the given amount of seconds\"\n}\n\nSTRESS=0\nwhile getopts \"hs:\" option; do\n\tcase \"$option\" in\n\t\"h\")\n\t\tusage $0\n\t\texit 0\n\t\t;;\n\t\"s\")\n\t\tSTRESS=$OPTARG\n\t\t;;\n\tesac\ndone\n\nif [ ! -f ${BPF_FILE} ]; then\n\techo \"Missing ${BPF_FILE}. Build bpf selftest first\"\n\texit 1\nfi\n\n[ $CPUS -lt 2 ] && echo \"Only one CPU available, some tests will be skipped\"\n[ $STRESS -gt 0 -a $CPUS -lt 3 ] && echo \" stress test will be skipped, too\"\n\ncreate_ns\nchk_gro_flag \"default - gro flag\" $SRC off\nchk_gro_flag \"        - peer gro flag\" $DST off\nchk_tso_flag \"        - tso flag\" $SRC on\nchk_tso_flag \"        - peer tso flag\" $DST on\nchk_gro \"        - aggregation\" 1\nip netns exec $NS_SRC ethtool -K veth$SRC tx-udp-segmentation off\nchk_gro \"        - aggregation with TSO off\" 10\ncleanup\n\ncreate_ns\nip netns exec $NS_DST ethtool -K veth$DST gro on\nchk_gro_flag \"with gro on - gro flag\" $DST on\nchk_gro_flag \"        - peer gro flag\" $SRC off\nchk_tso_flag \"        - tso flag\" $SRC on\nchk_tso_flag \"        - peer tso flag\" $DST on\nip netns exec $NS_SRC ethtool -K veth$SRC tx-udp-segmentation off\nip netns exec $NS_DST ethtool -K veth$DST rx-udp-gro-forwarding on\nchk_gro \"        - aggregation with TSO off\" 1\ncleanup\n\ncreate_ns\nchk_channels \"default channels\" $DST 1 1\n\nip -n $NS_DST link set dev veth$DST down\nip netns exec $NS_DST ethtool -K veth$DST gro on\nchk_gro_flag \"with gro enabled on link down - gro flag\" $DST on\nchk_gro_flag \"        - peer gro flag\" $SRC off\nchk_tso_flag \"        - tso flag\" $SRC on\nchk_tso_flag \"        - peer tso flag\" $DST on\nip -n $NS_DST link set dev veth$DST up\nip netns exec $NS_SRC ethtool -K veth$SRC tx-udp-segmentation off\nip netns exec $NS_DST ethtool -K veth$DST rx-udp-gro-forwarding on\nchk_gro \"        - aggregation with TSO off\" 1\ncleanup\n\ncreate_ns\n\nCUR_TX=1\nCUR_RX=1\nif [ $CPUS -gt 1 ]; then\n\tip netns exec $NS_DST ethtool -L veth$DST tx 2\n\tchk_channels \"setting tx channels\" $DST 1 2\n\tCUR_TX=2\nfi\n\nif [ $CPUS -gt 2 ]; then\n\tip netns exec $NS_DST ethtool -L veth$DST rx 3 tx 3\n\tchk_channels \"setting both rx and tx channels\" $DST 3 3\n\tCUR_RX=3\n\tCUR_TX=3\nfi\n\nip netns exec $NS_DST ethtool -L veth$DST combined 2 2>/dev/null\nchk_channels \"bad setting: combined channels\" $DST $CUR_RX $CUR_TX\n\nip netns exec $NS_DST ethtool -L veth$DST tx $((CPUS + 1)) 2>/dev/null\nchk_channels \"setting invalid channels nr\" $DST $CUR_RX $CUR_TX\n\nif [ $CPUS -gt 1 ]; then\n\t# this also tests queues nr reduction\n\tip netns exec $NS_DST ethtool -L veth$DST rx 1 tx 2 2>/dev/null\n\tip netns exec $NS_SRC ethtool -L veth$SRC rx 1 tx 2 2>/dev/null\n\tprintf \"%-60s\" \"bad setting: XDP with RX nr less than TX\"\n\tip -n $NS_DST link set dev veth$DST xdp object ${BPF_FILE} \\\n\t\tsection xdp 2>/dev/null &&\\\n\t\techo \"fail - set operation successful ?!?\" || echo \" ok \"\n\n\t# the following tests will run with multiple channels active\n\tip netns exec $NS_SRC ethtool -L veth$SRC rx 2\n\tip netns exec $NS_DST ethtool -L veth$DST rx 2\n\tip -n $NS_DST link set dev veth$DST xdp object ${BPF_FILE} \\\n\t\tsection xdp 2>/dev/null\n\tprintf \"%-60s\" \"bad setting: reducing RX nr below peer TX with XDP set\"\n\tip netns exec $NS_DST ethtool -L veth$DST rx 1 2>/dev/null &&\\\n\t\techo \"fail - set operation successful ?!?\" || echo \" ok \"\n\tCUR_RX=2\n\tCUR_TX=2\nfi\n\nif [ $CPUS -gt 2 ]; then\n\tprintf \"%-60s\" \"bad setting: increasing peer TX nr above RX with XDP set\"\n\tip netns exec $NS_SRC ethtool -L veth$SRC tx 3 2>/dev/null &&\\\n\t\techo \"fail - set operation successful ?!?\" || echo \" ok \"\n\tchk_channels \"setting invalid channels nr\" $DST 2 2\nfi\n\nip -n $NS_DST link set dev veth$DST xdp object ${BPF_FILE} section xdp 2>/dev/null\nchk_gro_flag \"with xdp attached - gro flag\" $DST on\nchk_gro_flag \"        - peer gro flag\" $SRC off\nchk_tso_flag \"        - tso flag\" $SRC off\nchk_tso_flag \"        - peer tso flag\" $DST on\nip netns exec $NS_DST ethtool -K veth$DST rx-udp-gro-forwarding on\nchk_gro \"        - aggregation\" 1\n\n\nip -n $NS_DST link set dev veth$DST down\nip -n $NS_SRC link set dev veth$SRC down\nchk_gro_flag \"        - after dev off, flag\" $DST on\nchk_gro_flag \"        - peer flag\" $SRC off\n\nip netns exec $NS_DST ethtool -K veth$DST gro on\nip -n $NS_DST link set dev veth$DST xdp off\nchk_gro_flag \"        - after gro on xdp off, gro flag\" $DST on\nchk_gro_flag \"        - peer gro flag\" $SRC off\nchk_tso_flag \"        - tso flag\" $SRC on\nchk_tso_flag \"        - peer tso flag\" $DST on\n\nif [ $CPUS -gt 1 ]; then\n\tip netns exec $NS_DST ethtool -L veth$DST tx 1\n\tchk_channels \"decreasing tx channels with device down\" $DST 2 1\nfi\n\nip -n $NS_DST link set dev veth$DST up\nip -n $NS_SRC link set dev veth$SRC up\nchk_gro \"        - aggregation\" 1\n\nif [ $CPUS -gt 1 ]; then\n\t[ $STRESS -gt 0 -a $CPUS -gt 2 ] && do_stress\n\n\tip -n $NS_DST link set dev veth$DST down\n\tip -n $NS_SRC link set dev veth$SRC down\n\tip netns exec $NS_DST ethtool -L veth$DST tx 2\n\tchk_channels \"increasing tx channels with device down\" $DST 2 2\n\tip -n $NS_DST link set dev veth$DST up\n\tip -n $NS_SRC link set dev veth$SRC up\nfi\n\nip netns exec $NS_DST ethtool -K veth$DST gro off\nip netns exec $NS_SRC ethtool -K veth$SRC tx-udp-segmentation off\nchk_gro \"aggregation again with default and TSO off\" 10\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}