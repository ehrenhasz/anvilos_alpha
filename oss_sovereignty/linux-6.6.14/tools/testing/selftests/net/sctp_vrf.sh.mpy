{
  "module_name": "sctp_vrf.sh",
  "hash_id": "3f6b6f8e3d30bbb3169cbb8d32d175b58fd4ce398726735c5322ba1e50206b1a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/sctp_vrf.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Testing For SCTP VRF.\n# TOPO: CLIENT_NS1 (veth1) <---> (veth1) -> vrf_s1\n#                                                  SERVER_NS\n#       CLIENT_NS2 (veth1) <---> (veth2) -> vrf_s2\n\nCLIENT_NS1=\"client-ns1\"\nCLIENT_NS2=\"client-ns2\"\nCLIENT_IP4=\"10.0.0.1\"\nCLIENT_IP6=\"2000::1\"\nCLIENT_PORT=1234\n\nSERVER_NS=\"server-ns\"\nSERVER_IP4=\"10.0.0.2\"\nSERVER_IP6=\"2000::2\"\nSERVER_PORT=1234\n\nsetup() {\n\tmodprobe sctp\n\tmodprobe sctp_diag\n\tip netns add $CLIENT_NS1\n\tip netns add $CLIENT_NS2\n\tip netns add $SERVER_NS\n\n\tip net exec $CLIENT_NS1 sysctl -w net.ipv6.conf.default.accept_dad=0 2>&1 >/dev/null\n\tip net exec $CLIENT_NS2 sysctl -w net.ipv6.conf.default.accept_dad=0 2>&1 >/dev/null\n\tip net exec $SERVER_NS sysctl -w net.ipv6.conf.default.accept_dad=0 2>&1 >/dev/null\n\n\tip -n $SERVER_NS link add veth1 type veth peer name veth1 netns $CLIENT_NS1\n\tip -n $SERVER_NS link add veth2 type veth peer name veth1 netns $CLIENT_NS2\n\n\tip -n $CLIENT_NS1 link set veth1 up\n\tip -n $CLIENT_NS1 addr add $CLIENT_IP4/24 dev veth1\n\tip -n $CLIENT_NS1 addr add $CLIENT_IP6/24 dev veth1\n\n\tip -n $CLIENT_NS2 link set veth1 up\n\tip -n $CLIENT_NS2 addr add $CLIENT_IP4/24 dev veth1\n\tip -n $CLIENT_NS2 addr add $CLIENT_IP6/24 dev veth1\n\n\tip -n $SERVER_NS link add dummy1 type dummy\n\tip -n $SERVER_NS link set dummy1 up\n\tip -n $SERVER_NS link add vrf-1 type vrf table 10\n\tip -n $SERVER_NS link add vrf-2 type vrf table 20\n\tip -n $SERVER_NS link set vrf-1 up\n\tip -n $SERVER_NS link set vrf-2 up\n\tip -n $SERVER_NS link set veth1 master vrf-1\n\tip -n $SERVER_NS link set veth2 master vrf-2\n\n\tip -n $SERVER_NS addr add $SERVER_IP4/24 dev dummy1\n\tip -n $SERVER_NS addr add $SERVER_IP4/24 dev veth1\n\tip -n $SERVER_NS addr add $SERVER_IP4/24 dev veth2\n\tip -n $SERVER_NS addr add $SERVER_IP6/24 dev dummy1\n\tip -n $SERVER_NS addr add $SERVER_IP6/24 dev veth1\n\tip -n $SERVER_NS addr add $SERVER_IP6/24 dev veth2\n\n\tip -n $SERVER_NS link set veth1 up\n\tip -n $SERVER_NS link set veth2 up\n\tip -n $SERVER_NS route add table 10 $CLIENT_IP4 dev veth1 src $SERVER_IP4\n\tip -n $SERVER_NS route add table 20 $CLIENT_IP4 dev veth2 src $SERVER_IP4\n\tip -n $SERVER_NS route add $CLIENT_IP4 dev veth1 src $SERVER_IP4\n\tip -n $SERVER_NS route add table 10 $CLIENT_IP6 dev veth1 src $SERVER_IP6\n\tip -n $SERVER_NS route add table 20 $CLIENT_IP6 dev veth2 src $SERVER_IP6\n\tip -n $SERVER_NS route add $CLIENT_IP6 dev veth1 src $SERVER_IP6\n}\n\ncleanup() {\n\tip netns exec $SERVER_NS pkill sctp_hello 2>&1 >/dev/null\n\tip netns del \"$CLIENT_NS1\"\n\tip netns del \"$CLIENT_NS2\"\n\tip netns del \"$SERVER_NS\"\n}\n\nwait_server() {\n\tlocal IFACE=$1\n\tlocal CNT=0\n\n\tuntil ip netns exec $SERVER_NS ss -lS src $SERVER_IP:$SERVER_PORT | \\\n\t\tgrep LISTEN | grep \"$IFACE\" 2>&1 >/dev/null; do\n\t\t[ $((CNT++)) = \"20\" ] && { RET=3; return $RET; }\n\t\tsleep 0.1\n\tdone\n}\n\ndo_test() {\n\tlocal CLIENT_NS=$1\n\tlocal IFACE=$2\n\n\tip netns exec $SERVER_NS pkill sctp_hello 2>&1 >/dev/null\n\tip netns exec $SERVER_NS ./sctp_hello server $AF $SERVER_IP \\\n\t\t$SERVER_PORT $IFACE 2>&1 >/dev/null &\n\tdisown\n\twait_server $IFACE || return $RET\n\ttimeout 3 ip netns exec $CLIENT_NS ./sctp_hello client $AF \\\n\t\t$SERVER_IP $SERVER_PORT $CLIENT_IP $CLIENT_PORT 2>&1 >/dev/null\n\tRET=$?\n\treturn $RET\n}\n\ndo_testx() {\n\tlocal IFACE1=$1\n\tlocal IFACE2=$2\n\n\tip netns exec $SERVER_NS pkill sctp_hello 2>&1 >/dev/null\n\tip netns exec $SERVER_NS ./sctp_hello server $AF $SERVER_IP \\\n\t\t$SERVER_PORT $IFACE1 2>&1 >/dev/null &\n\tdisown\n\twait_server $IFACE1 || return $RET\n\tip netns exec $SERVER_NS ./sctp_hello server $AF $SERVER_IP \\\n\t\t$SERVER_PORT $IFACE2 2>&1 >/dev/null &\n\tdisown\n\twait_server $IFACE2 || return $RET\n\ttimeout 3 ip netns exec $CLIENT_NS1 ./sctp_hello client $AF \\\n\t\t$SERVER_IP $SERVER_PORT $CLIENT_IP $CLIENT_PORT 2>&1 >/dev/null && \\\n\ttimeout 3 ip netns exec $CLIENT_NS2 ./sctp_hello client $AF \\\n\t\t$SERVER_IP $SERVER_PORT $CLIENT_IP $CLIENT_PORT 2>&1 >/dev/null\n\tRET=$?\n\treturn $RET\n}\n\ntestup() {\n\tip netns exec $SERVER_NS sysctl -w net.sctp.l3mdev_accept=1 2>&1 >/dev/null\n\techo -n \"TEST 01: nobind, connect from client 1, l3mdev_accept=1, Y \"\n\tdo_test $CLIENT_NS1 || { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 02: nobind, connect from client 2, l3mdev_accept=1, N \"\n\tdo_test $CLIENT_NS2 && { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\tip netns exec $SERVER_NS sysctl -w net.sctp.l3mdev_accept=0 2>&1 >/dev/null\n\techo -n \"TEST 03: nobind, connect from client 1, l3mdev_accept=0, N \"\n\tdo_test $CLIENT_NS1 && { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 04: nobind, connect from client 2, l3mdev_accept=0, N \"\n\tdo_test $CLIENT_NS2 && { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 05: bind veth2 in server, connect from client 1, N \"\n\tdo_test $CLIENT_NS1 veth2 && { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 06: bind veth1 in server, connect from client 1, Y \"\n\tdo_test $CLIENT_NS1 veth1 || { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 07: bind vrf-1 in server, connect from client 1, Y \"\n\tdo_test $CLIENT_NS1 vrf-1 || { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 08: bind vrf-2 in server, connect from client 1, N \"\n\tdo_test $CLIENT_NS1 vrf-2 && { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 09: bind vrf-2 in server, connect from client 2, Y \"\n\tdo_test $CLIENT_NS2 vrf-2 || { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 10: bind vrf-1 in server, connect from client 2, N \"\n\tdo_test $CLIENT_NS2 vrf-1 && { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 11: bind vrf-1 & 2 in server, connect from client 1 & 2, Y \"\n\tdo_testx vrf-1 vrf-2 || { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n\n\techo -n \"TEST 12: bind vrf-2 & 1 in server, connect from client 1 & 2, N \"\n\tdo_testx vrf-2 vrf-1 || { echo \"[FAIL]\"; return $RET; }\n\techo \"[PASS]\"\n}\n\ntrap cleanup EXIT\nsetup && echo \"Testing For SCTP VRF:\" && \\\nCLIENT_IP=$CLIENT_IP4 SERVER_IP=$SERVER_IP4 AF=\"-4\" testup && echo \"***v4 Tests Done***\" &&\nCLIENT_IP=$CLIENT_IP6 SERVER_IP=$SERVER_IP6 AF=\"-6\" testup && echo \"***v6 Tests Done***\"\nexit $?\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}