{
  "module_name": "mptcp_lib.sh",
  "hash_id": "35c3ec29a281b4b0549885222ba678769ec32a12346be3c97ac2fabf1a8d98e1",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/mptcp/mptcp_lib.sh",
  "human_readable_source": "#! /bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nreadonly KSFT_PASS=0\nreadonly KSFT_FAIL=1\nreadonly KSFT_SKIP=4\n\n# shellcheck disable=SC2155 # declare and assign separately\nreadonly KSFT_TEST=$(basename \"${0}\" | sed 's/\\.sh$//g')\n\nMPTCP_LIB_SUBTESTS=()\n\n# only if supported (or forced) and not disabled, see no-color.org\nif { [ -t 1 ] || [ \"${SELFTESTS_MPTCP_LIB_COLOR_FORCE:-}\" = \"1\" ]; } &&\n   [ \"${NO_COLOR:-}\" != \"1\" ]; then\n\treadonly MPTCP_LIB_COLOR_RED=\"\\E[1;31m\"\n\treadonly MPTCP_LIB_COLOR_GREEN=\"\\E[1;32m\"\n\treadonly MPTCP_LIB_COLOR_YELLOW=\"\\E[1;33m\"\n\treadonly MPTCP_LIB_COLOR_BLUE=\"\\E[1;34m\"\n\treadonly MPTCP_LIB_COLOR_RESET=\"\\E[0m\"\nelse\n\treadonly MPTCP_LIB_COLOR_RED=\n\treadonly MPTCP_LIB_COLOR_GREEN=\n\treadonly MPTCP_LIB_COLOR_YELLOW=\n\treadonly MPTCP_LIB_COLOR_BLUE=\n\treadonly MPTCP_LIB_COLOR_RESET=\nfi\n\n# $1: color, $2: text\nmptcp_lib_print_color() {\n\techo -e \"${MPTCP_LIB_START_PRINT:-}${*}${MPTCP_LIB_COLOR_RESET}\"\n}\n\nmptcp_lib_print_ok() {\n\tmptcp_lib_print_color \"${MPTCP_LIB_COLOR_GREEN}${*}\"\n}\n\nmptcp_lib_print_warn() {\n\tmptcp_lib_print_color \"${MPTCP_LIB_COLOR_YELLOW}${*}\"\n}\n\nmptcp_lib_print_info() {\n\tmptcp_lib_print_color \"${MPTCP_LIB_COLOR_BLUE}${*}\"\n}\n\nmptcp_lib_print_err() {\n\tmptcp_lib_print_color \"${MPTCP_LIB_COLOR_RED}${*}\"\n}\n\n# SELFTESTS_MPTCP_LIB_EXPECT_ALL_FEATURES env var can be set when validating all\n# features using the last version of the kernel and the selftests to make sure\n# a test is not being skipped by mistake.\nmptcp_lib_expect_all_features() {\n\t[ \"${SELFTESTS_MPTCP_LIB_EXPECT_ALL_FEATURES:-}\" = \"1\" ]\n}\n\n# $1: msg\nmptcp_lib_fail_if_expected_feature() {\n\tif mptcp_lib_expect_all_features; then\n\t\techo \"ERROR: missing feature: ${*}\"\n\t\texit ${KSFT_FAIL}\n\tfi\n\n\treturn 1\n}\n\n# $1: file\nmptcp_lib_has_file() {\n\tlocal f=\"${1}\"\n\n\tif [ -f \"${f}\" ]; then\n\t\treturn 0\n\tfi\n\n\tmptcp_lib_fail_if_expected_feature \"${f} file not found\"\n}\n\nmptcp_lib_check_mptcp() {\n\tif ! mptcp_lib_has_file \"/proc/sys/net/mptcp/enabled\"; then\n\t\techo \"SKIP: MPTCP support is not available\"\n\t\texit ${KSFT_SKIP}\n\tfi\n}\n\nmptcp_lib_check_kallsyms() {\n\tif ! mptcp_lib_has_file \"/proc/kallsyms\"; then\n\t\techo \"SKIP: CONFIG_KALLSYMS is missing\"\n\t\texit ${KSFT_SKIP}\n\tfi\n}\n\n# Internal: use mptcp_lib_kallsyms_has() instead\n__mptcp_lib_kallsyms_has() {\n\tlocal sym=\"${1}\"\n\n\tmptcp_lib_check_kallsyms\n\n\tgrep -q \" ${sym}\" /proc/kallsyms\n}\n\n# $1: part of a symbol to look at, add '$' at the end for full name\nmptcp_lib_kallsyms_has() {\n\tlocal sym=\"${1}\"\n\n\tif __mptcp_lib_kallsyms_has \"${sym}\"; then\n\t\treturn 0\n\tfi\n\n\tmptcp_lib_fail_if_expected_feature \"${sym} symbol not found\"\n}\n\n# $1: part of a symbol to look at, add '$' at the end for full name\nmptcp_lib_kallsyms_doesnt_have() {\n\tlocal sym=\"${1}\"\n\n\tif ! __mptcp_lib_kallsyms_has \"${sym}\"; then\n\t\treturn 0\n\tfi\n\n\tmptcp_lib_fail_if_expected_feature \"${sym} symbol has been found\"\n}\n\n# !!!AVOID USING THIS!!!\n# Features might not land in the expected version and features can be backported\n#\n# $1: kernel version, e.g. 6.3\nmptcp_lib_kversion_ge() {\n\tlocal exp_maj=\"${1%.*}\"\n\tlocal exp_min=\"${1#*.}\"\n\tlocal v maj min\n\n\t# If the kernel has backported features, set this env var to 1:\n\tif [ \"${SELFTESTS_MPTCP_LIB_NO_KVERSION_CHECK:-}\" = \"1\" ]; then\n\t\treturn 0\n\tfi\n\n\tv=$(uname -r | cut -d'.' -f1,2)\n\tmaj=${v%.*}\n\tmin=${v#*.}\n\n\tif   [ \"${maj}\" -gt \"${exp_maj}\" ] ||\n\t   { [ \"${maj}\" -eq \"${exp_maj}\" ] && [ \"${min}\" -ge \"${exp_min}\" ]; }; then\n\t\treturn 0\n\tfi\n\n\tmptcp_lib_fail_if_expected_feature \"kernel version ${1} lower than ${v}\"\n}\n\n__mptcp_lib_result_add() {\n\tlocal result=\"${1}\"\n\tshift\n\n\tlocal id=$((${#MPTCP_LIB_SUBTESTS[@]} + 1))\n\n\tMPTCP_LIB_SUBTESTS+=(\"${result} ${id} - ${KSFT_TEST}: ${*}\")\n}\n\n# $1: test name\nmptcp_lib_result_pass() {\n\t__mptcp_lib_result_add \"ok\" \"${1}\"\n}\n\n# $1: test name\nmptcp_lib_result_fail() {\n\t__mptcp_lib_result_add \"not ok\" \"${1}\"\n}\n\n# $1: test name\nmptcp_lib_result_skip() {\n\t__mptcp_lib_result_add \"ok\" \"${1} # SKIP\"\n}\n\n# $1: result code ; $2: test name\nmptcp_lib_result_code() {\n\tlocal ret=\"${1}\"\n\tlocal name=\"${2}\"\n\n\tcase \"${ret}\" in\n\t\t\"${KSFT_PASS}\")\n\t\t\tmptcp_lib_result_pass \"${name}\"\n\t\t\t;;\n\t\t\"${KSFT_FAIL}\")\n\t\t\tmptcp_lib_result_fail \"${name}\"\n\t\t\t;;\n\t\t\"${KSFT_SKIP}\")\n\t\t\tmptcp_lib_result_skip \"${name}\"\n\t\t\t;;\n\t\t*)\n\t\t\techo \"ERROR: wrong result code: ${ret}\"\n\t\t\texit ${KSFT_FAIL}\n\t\t\t;;\n\tesac\n}\n\nmptcp_lib_result_print_all_tap() {\n\tlocal subtest\n\n\tif [ ${#MPTCP_LIB_SUBTESTS[@]} -eq 0 ] ||\n\t   [ \"${SELFTESTS_MPTCP_LIB_NO_TAP:-}\" = \"1\" ]; then\n\t\treturn\n\tfi\n\n\tprintf \"\\nTAP version 13\\n\"\n\tprintf \"1..%d\\n\" \"${#MPTCP_LIB_SUBTESTS[@]}\"\n\n\tfor subtest in \"${MPTCP_LIB_SUBTESTS[@]}\"; do\n\t\tprintf \"%s\\n\" \"${subtest}\"\n\tdone\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}