{
  "module_name": "userspace_pm.sh",
  "hash_id": "2b7875aeedf6adf1b86c779385a2e74bb81df407836fe758e8cb5a88d061915c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/mptcp/userspace_pm.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Double quotes to prevent globbing and word splitting is recommended in new\n# code but we accept it.\n#shellcheck disable=SC2086\n\n# Some variables are used below but indirectly, see check_expected_one()\n#shellcheck disable=SC2034\n\n. \"$(dirname \"${0}\")/mptcp_lib.sh\"\n\nmptcp_lib_check_mptcp\nmptcp_lib_check_kallsyms\n\nif ! mptcp_lib_has_file '/proc/sys/net/mptcp/pm_type'; then\n\techo \"userspace pm tests are not supported by the kernel: SKIP\"\n\texit ${KSFT_SKIP}\nfi\n\nif ! ip -Version &> /dev/null; then\n\techo \"SKIP: Cannot not run test without ip tool\"\n\texit ${KSFT_SKIP}\nfi\n\nANNOUNCED=6        # MPTCP_EVENT_ANNOUNCED\nREMOVED=7          # MPTCP_EVENT_REMOVED\nSUB_ESTABLISHED=10 # MPTCP_EVENT_SUB_ESTABLISHED\nSUB_CLOSED=11      # MPTCP_EVENT_SUB_CLOSED\nLISTENER_CREATED=15 #MPTCP_EVENT_LISTENER_CREATED\nLISTENER_CLOSED=16  #MPTCP_EVENT_LISTENER_CLOSED\n\nAF_INET=2\nAF_INET6=10\n\nfile=\"\"\nserver_evts=\"\"\nclient_evts=\"\"\nserver_evts_pid=0\nclient_evts_pid=0\nclient4_pid=0\nserver4_pid=0\nclient6_pid=0\nserver6_pid=0\nclient4_token=\"\"\nserver4_token=\"\"\nclient6_token=\"\"\nserver6_token=\"\"\nclient4_port=0;\nclient6_port=0;\napp4_port=50002\nnew4_port=50003\napp6_port=50004\nclient_addr_id=${RANDOM:0:2}\nserver_addr_id=${RANDOM:0:2}\n\nsec=$(date +%s)\nrndh=$(printf %x \"$sec\")-$(mktemp -u XXXXXX)\nns1=\"ns1-$rndh\"\nns2=\"ns2-$rndh\"\nret=0\ntest_name=\"\"\n\n_printf() {\n\tstdbuf -o0 -e0 printf \"${@}\"\n}\n\nprint_title()\n{\n\t_printf \"INFO: %s\\n\" \"${1}\"\n}\n\n# $1: test name\nprint_test()\n{\n\ttest_name=\"${1}\"\n\n\t_printf \"%-63s\" \"${test_name}\"\n}\n\nprint_results()\n{\n\t_printf \"[%s]\\n\" \"${1}\"\n}\n\ntest_pass()\n{\n\tprint_results \" OK \"\n\tmptcp_lib_result_pass \"${test_name}\"\n}\n\ntest_skip()\n{\n\tprint_results \"SKIP\"\n\tmptcp_lib_result_skip \"${test_name}\"\n}\n\n# $1: msg\ntest_fail()\n{\n\tprint_results \"FAIL\"\n\tret=1\n\n\tif [ -n \"${1}\" ]; then\n\t\t_printf \"\\t%s\\n\" \"${1}\"\n\tfi\n\n\tmptcp_lib_result_fail \"${test_name}\"\n}\n\nkill_wait()\n{\n\t[ $1 -eq 0 ] && return 0\n\n\tkill -SIGUSR1 $1 > /dev/null 2>&1\n\tkill $1 > /dev/null 2>&1\n\twait $1 2>/dev/null\n}\n\n# This function is used in the cleanup trap\n#shellcheck disable=SC2317\ncleanup()\n{\n\tprint_title \"Cleanup\"\n\n\t# Terminate the MPTCP connection and related processes\n\tlocal pid\n\tfor pid in $client4_pid $server4_pid $client6_pid $server6_pid\\\n\t\t   $server_evts_pid $client_evts_pid\n\tdo\n\t\tkill_wait $pid\n\tdone\n\n\tlocal netns\n\tfor netns in \"$ns1\" \"$ns2\" ;do\n\t\tip netns del \"$netns\"\n\tdone\n\n\trm -rf $file $client_evts $server_evts\n\n\t_printf \"Done\\n\"\n}\n\ntrap cleanup EXIT\n\n# Create and configure network namespaces for testing\nfor i in \"$ns1\" \"$ns2\" ;do\n\tip netns add \"$i\" || exit 1\n\tip -net \"$i\" link set lo up\n\tip netns exec \"$i\" sysctl -q net.mptcp.enabled=1\n\tip netns exec \"$i\" sysctl -q net.mptcp.pm_type=1\ndone\n\n#  \"$ns1\"              ns2\n#     ns1eth2    ns2eth1\n\nip link add ns1eth2 netns \"$ns1\" type veth peer name ns2eth1 netns \"$ns2\"\n\n# Add IPv4/v6 addresses to the namespaces\nip -net \"$ns1\" addr add 10.0.1.1/24 dev ns1eth2\nip -net \"$ns1\" addr add 10.0.2.1/24 dev ns1eth2\nip -net \"$ns1\" addr add dead:beef:1::1/64 dev ns1eth2 nodad\nip -net \"$ns1\" addr add dead:beef:2::1/64 dev ns1eth2 nodad\nip -net \"$ns1\" link set ns1eth2 up\n\nip -net \"$ns2\" addr add 10.0.1.2/24 dev ns2eth1\nip -net \"$ns2\" addr add 10.0.2.2/24 dev ns2eth1\nip -net \"$ns2\" addr add dead:beef:1::2/64 dev ns2eth1 nodad\nip -net \"$ns2\" addr add dead:beef:2::2/64 dev ns2eth1 nodad\nip -net \"$ns2\" link set ns2eth1 up\n\nprint_title \"Init\"\nprint_test \"Created network namespaces ns1, ns2\"\ntest_pass\n\nmake_file()\n{\n\t# Store a chunk of data in a file to transmit over an MPTCP connection\n\tlocal name=$1\n\tlocal ksize=1\n\n\tdd if=/dev/urandom of=\"$name\" bs=2 count=$ksize 2> /dev/null\n\techo -e \"\\nMPTCP_TEST_FILE_END_MARKER\" >> \"$name\"\n}\n\nmake_connection()\n{\n\tif [ -z \"$file\" ]; then\n\t\tfile=$(mktemp)\n\tfi\n\tmake_file \"$file\" \"client\"\n\n\tlocal is_v6=$1\n\tlocal app_port=$app4_port\n\tlocal connect_addr=\"10.0.1.1\"\n\tlocal listen_addr=\"0.0.0.0\"\n\tif [ \"$is_v6\" = \"v6\" ]\n\tthen\n\t\tconnect_addr=\"dead:beef:1::1\"\n\t\tlisten_addr=\"::\"\n\t\tapp_port=$app6_port\n\telse\n\t\tis_v6=\"v4\"\n\tfi\n\n\t# Capture netlink events over the two network namespaces running\n\t# the MPTCP client and server\n\tif [ -z \"$client_evts\" ]; then\n\t\tclient_evts=$(mktemp)\n\tfi\n\t:>\"$client_evts\"\n\tif [ $client_evts_pid -ne 0 ]; then\n\t\tkill_wait $client_evts_pid\n\tfi\n\tip netns exec \"$ns2\" ./pm_nl_ctl events >> \"$client_evts\" 2>&1 &\n\tclient_evts_pid=$!\n\tif [ -z \"$server_evts\" ]; then\n\t\tserver_evts=$(mktemp)\n\tfi\n\t:>\"$server_evts\"\n\tif [ $server_evts_pid -ne 0 ]; then\n\t\tkill_wait $server_evts_pid\n\tfi\n\tip netns exec \"$ns1\" ./pm_nl_ctl events >> \"$server_evts\" 2>&1 &\n\tserver_evts_pid=$!\n\tsleep 0.5\n\n\t# Run the server\n\tip netns exec \"$ns1\" \\\n\t   ./mptcp_connect -s MPTCP -w 300 -p $app_port -l $listen_addr > /dev/null 2>&1 &\n\tlocal server_pid=$!\n\tsleep 0.5\n\n\t# Run the client, transfer $file and stay connected to the server\n\t# to conduct tests\n\tip netns exec \"$ns2\" \\\n\t   ./mptcp_connect -s MPTCP -w 300 -m sendfile -p $app_port $connect_addr\\\n\t   2>&1 > /dev/null < \"$file\" &\n\tlocal client_pid=$!\n\tsleep 1\n\n\t# Capture client/server attributes from MPTCP connection netlink events\n\n\tlocal client_token\n\tlocal client_port\n\tlocal client_serverside\n\tlocal server_token\n\tlocal server_serverside\n\n\tclient_token=$(sed --unbuffered -n 's/.*\\(token:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$client_evts\")\n\tclient_port=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$client_evts\")\n\tclient_serverside=$(sed --unbuffered -n 's/.*\\(server_side:\\)\\([[:digit:]]*\\).*$/\\2/p;q'\\\n\t\t\t\t      \"$client_evts\")\n\tserver_token=$(grep \"type:1,\" \"$server_evts\" |\n\t\t       sed --unbuffered -n 's/.*\\(token:\\)\\([[:digit:]]*\\).*$/\\2/p;q')\n\tserver_serverside=$(grep \"type:1,\" \"$server_evts\" |\n\t\t\t    sed --unbuffered -n 's/.*\\(server_side:\\)\\([[:digit:]]*\\).*$/\\2/p;q')\n\n\tprint_test \"Established IP${is_v6} MPTCP Connection ns2 => ns1\"\n\tif [ \"$client_token\" != \"\" ] && [ \"$server_token\" != \"\" ] && [ \"$client_serverside\" = 0 ] &&\n\t\t   [ \"$server_serverside\" = 1 ]\n\tthen\n\t\ttest_pass\n\telse\n\t\ttest_fail \"Expected tokens (c:${client_token} - s:${server_token}) and server (c:${client_serverside} - s:${server_serverside})\"\n\t\tmptcp_lib_result_print_all_tap\n\t\texit 1\n\tfi\n\n\tif [ \"$is_v6\" = \"v6\" ]\n\tthen\n\t\tclient6_token=$client_token\n\t\tserver6_token=$server_token\n\t\tclient6_port=$client_port\n\t\tclient6_pid=$client_pid\n\t\tserver6_pid=$server_pid\n\telse\n\t\tclient4_token=$client_token\n\t\tserver4_token=$server_token\n\t\tclient4_port=$client_port\n\t\tclient4_pid=$client_pid\n\t\tserver4_pid=$server_pid\n\tfi\n}\n\n# $1: var name ; $2: prev ret\ncheck_expected_one()\n{\n\tlocal var=\"${1}\"\n\tlocal exp=\"e_${var}\"\n\tlocal prev_ret=\"${2}\"\n\n\tif [ \"${!var}\" = \"${!exp}\" ]\n\tthen\n\t\treturn 0\n\tfi\n\n\tif [ \"${prev_ret}\" = \"0\" ]\n\tthen\n\t\ttest_fail\n\tfi\n\n\t_printf \"\\tExpected value for '%s': '%s', got '%s'.\\n\" \\\n\t\t\"${var}\" \"${!exp}\" \"${!var}\"\n\treturn 1\n}\n\n# $@: all var names to check\ncheck_expected()\n{\n\tlocal rc=0\n\tlocal var\n\n\tfor var in \"${@}\"\n\tdo\n\t\tcheck_expected_one \"${var}\" \"${rc}\" || rc=1\n\tdone\n\n\tif [ ${rc} -eq 0 ]\n\tthen\n\t\ttest_pass\n\t\treturn 0\n\tfi\n\n\treturn 1\n}\n\nverify_announce_event()\n{\n\tlocal evt=$1\n\tlocal e_type=$2\n\tlocal e_token=$3\n\tlocal e_addr=$4\n\tlocal e_id=$5\n\tlocal e_dport=$6\n\tlocal e_af=$7\n\tlocal type\n\tlocal token\n\tlocal addr\n\tlocal dport\n\tlocal id\n\n\ttype=$(sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\ttoken=$(sed --unbuffered -n 's/.*\\(token:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tif [ \"$e_af\" = \"v6\" ]\n\tthen\n\t\taddr=$(sed --unbuffered -n 's/.*\\(daddr6:\\)\\([0-9a-f:.]*\\).*$/\\2/p;q' \"$evt\")\n\telse\n\t\taddr=$(sed --unbuffered -n 's/.*\\(daddr4:\\)\\([0-9.]*\\).*$/\\2/p;q' \"$evt\")\n\tfi\n\tdport=$(sed --unbuffered -n 's/.*\\(dport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tid=$(sed --unbuffered -n 's/.*\\(rem_id:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\n\tcheck_expected \"type\" \"token\" \"addr\" \"dport\" \"id\"\n}\n\ntest_announce()\n{\n\tprint_title \"Announce tests\"\n\n\t# Capture events on the network namespace running the server\n\t:>\"$server_evts\"\n\n\t# ADD_ADDR using an invalid token should result in no action\n\tlocal invalid_token=$(( client4_token - 1))\n\tip netns exec \"$ns2\" ./pm_nl_ctl ann 10.0.2.2 token $invalid_token id\\\n\t   $client_addr_id dev ns2eth1 > /dev/null 2>&1\n\n\tlocal type\n\ttype=$(sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$server_evts\")\n\tprint_test \"ADD_ADDR 10.0.2.2 (ns2) => ns1, invalid token\"\n\tif [ \"$type\" = \"\" ]\n\tthen\n\t\ttest_pass\n\telse\n\t\ttest_fail \"type defined: ${type}\"\n\tfi\n\n\t# ADD_ADDR from the client to server machine reusing the subflow port\n\t:>\"$server_evts\"\n\tip netns exec \"$ns2\"\\\n\t   ./pm_nl_ctl ann 10.0.2.2 token \"$client4_token\" id $client_addr_id dev\\\n\t   ns2eth1\n\tprint_test \"ADD_ADDR id:${client_addr_id} 10.0.2.2 (ns2) => ns1, reuse port\"\n\tsleep 0.5\n\tverify_announce_event $server_evts $ANNOUNCED $server4_token \"10.0.2.2\" $client_addr_id \\\n\t\t\t      \"$client4_port\"\n\n\t# ADD_ADDR6 from the client to server machine reusing the subflow port\n\t:>\"$server_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl ann\\\n\t   dead:beef:2::2 token \"$client6_token\" id $client_addr_id dev ns2eth1\n\tprint_test \"ADD_ADDR6 id:${client_addr_id} dead:beef:2::2 (ns2) => ns1, reuse port\"\n\tsleep 0.5\n\tverify_announce_event \"$server_evts\" \"$ANNOUNCED\" \"$server6_token\" \"dead:beef:2::2\"\\\n\t\t\t      \"$client_addr_id\" \"$client6_port\" \"v6\"\n\n\t# ADD_ADDR from the client to server machine using a new port\n\t:>\"$server_evts\"\n\tclient_addr_id=$((client_addr_id+1))\n\tip netns exec \"$ns2\" ./pm_nl_ctl ann 10.0.2.2 token \"$client4_token\" id\\\n\t   $client_addr_id dev ns2eth1 port $new4_port\n\tprint_test \"ADD_ADDR id:${client_addr_id} 10.0.2.2 (ns2) => ns1, new port\"\n\tsleep 0.5\n\tverify_announce_event \"$server_evts\" \"$ANNOUNCED\" \"$server4_token\" \"10.0.2.2\"\\\n\t\t\t      \"$client_addr_id\" \"$new4_port\"\n\n\t# Capture events on the network namespace running the client\n\t:>\"$client_evts\"\n\n\t# ADD_ADDR from the server to client machine reusing the subflow port\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann 10.0.2.1 token \"$server4_token\" id\\\n\t   $server_addr_id dev ns1eth2\n\tprint_test \"ADD_ADDR id:${server_addr_id} 10.0.2.1 (ns1) => ns2, reuse port\"\n\tsleep 0.5\n\tverify_announce_event \"$client_evts\" \"$ANNOUNCED\" \"$client4_token\" \"10.0.2.1\"\\\n\t\t\t      \"$server_addr_id\" \"$app4_port\"\n\n\t# ADD_ADDR6 from the server to client machine reusing the subflow port\n\t:>\"$client_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann dead:beef:2::1 token \"$server6_token\" id\\\n\t   $server_addr_id dev ns1eth2\n\tprint_test \"ADD_ADDR6 id:${server_addr_id} dead:beef:2::1 (ns1) => ns2, reuse port\"\n\tsleep 0.5\n\tverify_announce_event \"$client_evts\" \"$ANNOUNCED\" \"$client6_token\" \"dead:beef:2::1\"\\\n\t\t\t      \"$server_addr_id\" \"$app6_port\" \"v6\"\n\n\t# ADD_ADDR from the server to client machine using a new port\n\t:>\"$client_evts\"\n\tserver_addr_id=$((server_addr_id+1))\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann 10.0.2.1 token \"$server4_token\" id\\\n\t   $server_addr_id dev ns1eth2 port $new4_port\n\tprint_test \"ADD_ADDR id:${server_addr_id} 10.0.2.1 (ns1) => ns2, new port\"\n\tsleep 0.5\n\tverify_announce_event \"$client_evts\" \"$ANNOUNCED\" \"$client4_token\" \"10.0.2.1\"\\\n\t\t\t      \"$server_addr_id\" \"$new4_port\"\n}\n\nverify_remove_event()\n{\n\tlocal evt=$1\n\tlocal e_type=$2\n\tlocal e_token=$3\n\tlocal e_id=$4\n\tlocal type\n\tlocal token\n\tlocal id\n\n\ttype=$(sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\ttoken=$(sed --unbuffered -n 's/.*\\(token:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tid=$(sed --unbuffered -n 's/.*\\(rem_id:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\n\tcheck_expected \"type\" \"token\" \"id\"\n}\n\ntest_remove()\n{\n\tprint_title \"Remove tests\"\n\n\t# Capture events on the network namespace running the server\n\t:>\"$server_evts\"\n\n\t# RM_ADDR using an invalid token should result in no action\n\tlocal invalid_token=$(( client4_token - 1 ))\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem token $invalid_token id\\\n\t   $client_addr_id > /dev/null 2>&1\n\tprint_test \"RM_ADDR id:${client_addr_id} ns2 => ns1, invalid token\"\n\tlocal type\n\ttype=$(sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$server_evts\")\n\tif [ \"$type\" = \"\" ]\n\tthen\n\t\ttest_pass\n\telse\n\t\ttest_fail\n\tfi\n\n\t# RM_ADDR using an invalid addr id should result in no action\n\tlocal invalid_id=$(( client_addr_id + 1 ))\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem token \"$client4_token\" id\\\n\t   $invalid_id > /dev/null 2>&1\n\tprint_test \"RM_ADDR id:${invalid_id} ns2 => ns1, invalid id\"\n\ttype=$(sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$server_evts\")\n\tif [ \"$type\" = \"\" ]\n\tthen\n\t\ttest_pass\n\telse\n\t\ttest_fail\n\tfi\n\n\t# RM_ADDR from the client to server machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem token \"$client4_token\" id\\\n\t   $client_addr_id\n\tprint_test \"RM_ADDR id:${client_addr_id} ns2 => ns1\"\n\tsleep 0.5\n\tverify_remove_event \"$server_evts\" \"$REMOVED\" \"$server4_token\" \"$client_addr_id\"\n\n\t# RM_ADDR from the client to server machine\n\t:>\"$server_evts\"\n\tclient_addr_id=$(( client_addr_id - 1 ))\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem token \"$client4_token\" id\\\n\t   $client_addr_id\n\tprint_test \"RM_ADDR id:${client_addr_id} ns2 => ns1\"\n\tsleep 0.5\n\tverify_remove_event \"$server_evts\" \"$REMOVED\" \"$server4_token\" \"$client_addr_id\"\n\n\t# RM_ADDR6 from the client to server machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem token \"$client6_token\" id\\\n\t   $client_addr_id\n\tprint_test \"RM_ADDR6 id:${client_addr_id} ns2 => ns1\"\n\tsleep 0.5\n\tverify_remove_event \"$server_evts\" \"$REMOVED\" \"$server6_token\" \"$client_addr_id\"\n\n\t# Capture events on the network namespace running the client\n\t:>\"$client_evts\"\n\n\t# RM_ADDR from the server to client machine\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem token \"$server4_token\" id\\\n\t   $server_addr_id\n\tprint_test \"RM_ADDR id:${server_addr_id} ns1 => ns2\"\n\tsleep 0.5\n\tverify_remove_event \"$client_evts\" \"$REMOVED\" \"$client4_token\" \"$server_addr_id\"\n\n\t# RM_ADDR from the server to client machine\n\t:>\"$client_evts\"\n\tserver_addr_id=$(( server_addr_id - 1 ))\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem token \"$server4_token\" id\\\n\t   $server_addr_id\n\tprint_test \"RM_ADDR id:${server_addr_id} ns1 => ns2\"\n\tsleep 0.5\n\tverify_remove_event \"$client_evts\" \"$REMOVED\" \"$client4_token\" \"$server_addr_id\"\n\n\t# RM_ADDR6 from the server to client machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem token \"$server6_token\" id\\\n\t   $server_addr_id\n\tprint_test \"RM_ADDR6 id:${server_addr_id} ns1 => ns2\"\n\tsleep 0.5\n\tverify_remove_event \"$client_evts\" \"$REMOVED\" \"$client6_token\" \"$server_addr_id\"\n}\n\nverify_subflow_events()\n{\n\tlocal evt=$1\n\tlocal e_type=$2\n\tlocal e_token=$3\n\tlocal e_family=$4\n\tlocal e_saddr=$5\n\tlocal e_daddr=$6\n\tlocal e_dport=$7\n\tlocal e_locid=$8\n\tlocal e_remid=$9\n\tshift 2\n\tlocal e_from=$8\n\tlocal e_to=$9\n\tlocal type\n\tlocal token\n\tlocal family\n\tlocal saddr\n\tlocal daddr\n\tlocal dport\n\tlocal locid\n\tlocal remid\n\tlocal info\n\n\tinfo=\"${e_saddr} (${e_from}) => ${e_daddr} (${e_to})\"\n\n\tif [ \"$e_type\" = \"$SUB_ESTABLISHED\" ]\n\tthen\n\t\tif [ \"$e_family\" = \"$AF_INET6\" ]\n\t\tthen\n\t\t\tprint_test \"CREATE_SUBFLOW6 ${info}\"\n\t\telse\n\t\t\tprint_test \"CREATE_SUBFLOW ${info}\"\n\t\tfi\n\telse\n\t\tif [ \"$e_family\" = \"$AF_INET6\" ]\n\t\tthen\n\t\t\tprint_test \"DESTROY_SUBFLOW6 ${info}\"\n\t\telse\n\t\t\tprint_test \"DESTROY_SUBFLOW ${info}\"\n\t\tfi\n\tfi\n\n\ttype=$(sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\ttoken=$(sed --unbuffered -n 's/.*\\(token:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tfamily=$(sed --unbuffered -n 's/.*\\(family:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tdport=$(sed --unbuffered -n 's/.*\\(dport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tlocid=$(sed --unbuffered -n 's/.*\\(loc_id:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tremid=$(sed --unbuffered -n 's/.*\\(rem_id:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$evt\")\n\tif [ \"$family\" = \"$AF_INET6\" ]\n\tthen\n\t\tsaddr=$(sed --unbuffered -n 's/.*\\(saddr6:\\)\\([0-9a-f:.]*\\).*$/\\2/p;q' \"$evt\")\n\t\tdaddr=$(sed --unbuffered -n 's/.*\\(daddr6:\\)\\([0-9a-f:.]*\\).*$/\\2/p;q' \"$evt\")\n\telse\n\t\tsaddr=$(sed --unbuffered -n 's/.*\\(saddr4:\\)\\([0-9.]*\\).*$/\\2/p;q' \"$evt\")\n\t\tdaddr=$(sed --unbuffered -n 's/.*\\(daddr4:\\)\\([0-9.]*\\).*$/\\2/p;q' \"$evt\")\n\tfi\n\n\tcheck_expected \"type\" \"token\" \"daddr\" \"dport\" \"family\" \"saddr\" \"locid\" \"remid\"\n}\n\ntest_subflows()\n{\n\tprint_title \"Subflows v4 or v6 only tests\"\n\n\t# Capture events on the network namespace running the server\n\t:>\"$server_evts\"\n\n\t# Attempt to add a listener at 10.0.2.2:<subflow-port>\n\tip netns exec \"$ns2\" ./pm_nl_ctl listen 10.0.2.2\\\n\t   \"$client4_port\" &\n\tlocal listener_pid=$!\n\n\t# ADD_ADDR from client to server machine reusing the subflow port\n\tip netns exec \"$ns2\" ./pm_nl_ctl ann 10.0.2.2 token \"$client4_token\" id\\\n\t   $client_addr_id\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW from server to client machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl csf lip 10.0.2.1 lid 23 rip 10.0.2.2\\\n\t   rport \"$client4_port\" token \"$server4_token\"\n\tsleep 0.5\n\tverify_subflow_events $server_evts $SUB_ESTABLISHED $server4_token $AF_INET \"10.0.2.1\" \\\n\t\t\t      \"10.0.2.2\" \"$client4_port\" \"23\" \"$client_addr_id\" \"ns1\" \"ns2\"\n\n\t# Delete the listener from the client ns, if one was created\n\tkill_wait $listener_pid\n\n\tlocal sport\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$server_evts\")\n\n\t# DESTROY_SUBFLOW from server to client machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl dsf lip 10.0.2.1 lport \"$sport\" rip 10.0.2.2 rport\\\n\t   \"$client4_port\" token \"$server4_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$server_evts\" \"$SUB_CLOSED\" \"$server4_token\" \"$AF_INET\" \"10.0.2.1\"\\\n\t\t\t      \"10.0.2.2\" \"$client4_port\" \"23\" \"$client_addr_id\" \"ns1\" \"ns2\"\n\n\t# RM_ADDR from client to server machine\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem id $client_addr_id token\\\n\t   \"$client4_token\"\n\tsleep 0.5\n\n\t# Attempt to add a listener at dead:beef:2::2:<subflow-port>\n\tip netns exec \"$ns2\" ./pm_nl_ctl listen dead:beef:2::2\\\n\t   \"$client6_port\" &\n\tlistener_pid=$!\n\n\t# ADD_ADDR6 from client to server machine reusing the subflow port\n\t:>\"$server_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl ann dead:beef:2::2 token \"$client6_token\" id\\\n\t   $client_addr_id\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW6 from server to client machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl csf lip dead:beef:2::1 lid 23 rip\\\n\t   dead:beef:2::2 rport \"$client6_port\" token \"$server6_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$server_evts\" \"$SUB_ESTABLISHED\" \"$server6_token\" \"$AF_INET6\"\\\n\t\t\t      \"dead:beef:2::1\" \"dead:beef:2::2\" \"$client6_port\" \"23\"\\\n\t\t\t      \"$client_addr_id\" \"ns1\" \"ns2\"\n\n\t# Delete the listener from the client ns, if one was created\n\tkill_wait $listener_pid\n\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$server_evts\")\n\n\t# DESTROY_SUBFLOW6 from server to client machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl dsf lip dead:beef:2::1 lport \"$sport\" rip\\\n\t   dead:beef:2::2 rport \"$client6_port\" token \"$server6_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$server_evts\" \"$SUB_CLOSED\" \"$server6_token\" \"$AF_INET6\"\\\n\t\t\t      \"dead:beef:2::1\" \"dead:beef:2::2\" \"$client6_port\" \"23\"\\\n\t\t\t      \"$client_addr_id\" \"ns1\" \"ns2\"\n\n\t# RM_ADDR from client to server machine\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem id $client_addr_id token\\\n\t   \"$client6_token\"\n\tsleep 0.5\n\n\t# Attempt to add a listener at 10.0.2.2:<new-port>\n\tip netns exec \"$ns2\" ./pm_nl_ctl listen 10.0.2.2\\\n\t   $new4_port &\n\tlistener_pid=$!\n\n\t# ADD_ADDR from client to server machine using a new port\n\t:>\"$server_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl ann 10.0.2.2 token \"$client4_token\" id\\\n\t   $client_addr_id port $new4_port\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW from server to client machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl csf lip 10.0.2.1 lid 23 rip 10.0.2.2 rport\\\n\t   $new4_port token \"$server4_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$server_evts\" \"$SUB_ESTABLISHED\" \"$server4_token\" \"$AF_INET\"\\\n\t\t\t      \"10.0.2.1\" \"10.0.2.2\" \"$new4_port\" \"23\"\\\n\t\t\t      \"$client_addr_id\" \"ns1\" \"ns2\"\n\n\t# Delete the listener from the client ns, if one was created\n\tkill_wait $listener_pid\n\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$server_evts\")\n\n\t# DESTROY_SUBFLOW from server to client machine\n\t:>\"$server_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl dsf lip 10.0.2.1 lport \"$sport\" rip 10.0.2.2 rport\\\n\t   $new4_port token \"$server4_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$server_evts\" \"$SUB_CLOSED\" \"$server4_token\" \"$AF_INET\" \"10.0.2.1\"\\\n\t\t\t      \"10.0.2.2\" \"$new4_port\" \"23\" \"$client_addr_id\" \"ns1\" \"ns2\"\n\n\t# RM_ADDR from client to server machine\n\tip netns exec \"$ns2\" ./pm_nl_ctl rem id $client_addr_id token\\\n\t   \"$client4_token\"\n\n\t# Capture events on the network namespace running the client\n\t:>\"$client_evts\"\n\n\t# Attempt to add a listener at 10.0.2.1:<subflow-port>\n\tip netns exec \"$ns1\" ./pm_nl_ctl listen 10.0.2.1\\\n\t   $app4_port &\n\tlistener_pid=$!\n\n\t# ADD_ADDR from server to client machine reusing the subflow port\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann 10.0.2.1 token \"$server4_token\" id\\\n\t   $server_addr_id\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl csf lip 10.0.2.2 lid 23 rip 10.0.2.1 rport\\\n\t   $app4_port token \"$client4_token\"\n\tsleep 0.5\n\tverify_subflow_events $client_evts $SUB_ESTABLISHED $client4_token $AF_INET \"10.0.2.2\"\\\n\t\t\t      \"10.0.2.1\" \"$app4_port\" \"23\" \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# Delete the listener from the server ns, if one was created\n\tkill_wait $listener_pid\n\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$client_evts\")\n\n\t# DESTROY_SUBFLOW from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl dsf lip 10.0.2.2 lport \"$sport\" rip 10.0.2.1 rport\\\n\t   $app4_port token \"$client4_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$client_evts\" \"$SUB_CLOSED\" \"$client4_token\" \"$AF_INET\" \"10.0.2.2\"\\\n\t\t\t      \"10.0.2.1\" \"$app4_port\" \"23\" \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# RM_ADDR from server to client machine\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem id $server_addr_id token\\\n\t   \"$server4_token\"\n\tsleep 0.5\n\n\t# Attempt to add a listener at dead:beef:2::1:<subflow-port>\n\tip netns exec \"$ns1\" ./pm_nl_ctl listen dead:beef:2::1\\\n\t   $app6_port &\n\tlistener_pid=$!\n\n\t# ADD_ADDR6 from server to client machine reusing the subflow port\n\t:>\"$client_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann dead:beef:2::1 token \"$server6_token\" id\\\n\t   $server_addr_id\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW6 from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl csf lip dead:beef:2::2 lid 23 rip\\\n\t   dead:beef:2::1 rport $app6_port token \"$client6_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$client_evts\" \"$SUB_ESTABLISHED\" \"$client6_token\"\\\n\t\t\t      \"$AF_INET6\" \"dead:beef:2::2\"\\\n\t\t\t      \"dead:beef:2::1\" \"$app6_port\" \"23\"\\\n\t\t\t      \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# Delete the listener from the server ns, if one was created\n\tkill_wait $listener_pid\n\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$client_evts\")\n\n\t# DESTROY_SUBFLOW6 from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl dsf lip dead:beef:2::2 lport \"$sport\" rip\\\n\t   dead:beef:2::1 rport $app6_port token \"$client6_token\"\n\tsleep 0.5\n\tverify_subflow_events $client_evts $SUB_CLOSED $client6_token $AF_INET6 \"dead:beef:2::2\"\\\n\t\t\t      \"dead:beef:2::1\" \"$app6_port\" \"23\" \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# RM_ADDR6 from server to client machine\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem id $server_addr_id token\\\n\t   \"$server6_token\"\n\tsleep 0.5\n\n\t# Attempt to add a listener at 10.0.2.1:<new-port>\n\tip netns exec \"$ns1\" ./pm_nl_ctl listen 10.0.2.1\\\n\t   $new4_port &\n\tlistener_pid=$!\n\n\t# ADD_ADDR from server to client machine using a new port\n\t:>\"$client_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann 10.0.2.1 token \"$server4_token\" id\\\n\t   $server_addr_id port $new4_port\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl csf lip 10.0.2.2 lid 23 rip 10.0.2.1 rport\\\n\t   $new4_port token \"$client4_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$client_evts\" \"$SUB_ESTABLISHED\" \"$client4_token\" \"$AF_INET\"\\\n\t\t\t      \"10.0.2.2\" \"10.0.2.1\" \"$new4_port\" \"23\" \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# Delete the listener from the server ns, if one was created\n\tkill_wait $listener_pid\n\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$client_evts\")\n\n\t# DESTROY_SUBFLOW from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl dsf lip 10.0.2.2 lport \"$sport\" rip 10.0.2.1 rport\\\n\t   $new4_port token \"$client4_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$client_evts\" \"$SUB_CLOSED\" \"$client4_token\" \"$AF_INET\" \"10.0.2.2\"\\\n\t\t\t      \"10.0.2.1\" \"$new4_port\" \"23\" \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# RM_ADDR from server to client machine\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem id $server_addr_id token\\\n\t   \"$server4_token\"\n}\n\ntest_subflows_v4_v6_mix()\n{\n\tprint_title \"Subflows v4 and v6 mix tests\"\n\n\t# Attempt to add a listener at 10.0.2.1:<subflow-port>\n\tip netns exec \"$ns1\" ./pm_nl_ctl listen 10.0.2.1\\\n\t   $app6_port &\n\tlocal listener_pid=$!\n\n\t# ADD_ADDR4 from server to client machine reusing the subflow port on\n\t# the established v6 connection\n\t:>\"$client_evts\"\n\tip netns exec \"$ns1\" ./pm_nl_ctl ann 10.0.2.1 token \"$server6_token\" id\\\n\t   $server_addr_id dev ns1eth2\n\tprint_test \"ADD_ADDR4 id:${server_addr_id} 10.0.2.1 (ns1) => ns2, reuse port\"\n\tsleep 0.5\n\tverify_announce_event \"$client_evts\" \"$ANNOUNCED\" \"$client6_token\" \"10.0.2.1\"\\\n\t\t\t      \"$server_addr_id\" \"$app6_port\"\n\n\t# CREATE_SUBFLOW from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl csf lip 10.0.2.2 lid 23 rip 10.0.2.1 rport\\\n\t   $app6_port token \"$client6_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$client_evts\" \"$SUB_ESTABLISHED\" \"$client6_token\"\\\n\t\t\t      \"$AF_INET\" \"10.0.2.2\" \"10.0.2.1\" \"$app6_port\" \"23\"\\\n\t\t\t      \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# Delete the listener from the server ns, if one was created\n\tkill_wait $listener_pid\n\n\tsport=$(sed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q' \"$client_evts\")\n\n\t# DESTROY_SUBFLOW from client to server machine\n\t:>\"$client_evts\"\n\tip netns exec \"$ns2\" ./pm_nl_ctl dsf lip 10.0.2.2 lport \"$sport\" rip 10.0.2.1 rport\\\n\t   $app6_port token \"$client6_token\"\n\tsleep 0.5\n\tverify_subflow_events \"$client_evts\" \"$SUB_CLOSED\" \"$client6_token\" \\\n\t\t\t      \"$AF_INET\" \"10.0.2.2\" \"10.0.2.1\" \"$app6_port\" \"23\"\\\n\t\t\t      \"$server_addr_id\" \"ns2\" \"ns1\"\n\n\t# RM_ADDR from server to client machine\n\tip netns exec \"$ns1\" ./pm_nl_ctl rem id $server_addr_id token\\\n\t   \"$server6_token\"\n\tsleep 0.5\n}\n\ntest_prio()\n{\n\tprint_title \"Prio tests\"\n\n\tlocal count\n\n\t# Send MP_PRIO signal from client to server machine\n\tip netns exec \"$ns2\" ./pm_nl_ctl set 10.0.1.2 port \"$client4_port\" flags backup token \"$client4_token\" rip 10.0.1.1 rport \"$app4_port\"\n\tsleep 0.5\n\n\t# Check TX\n\tprint_test \"MP_PRIO TX\"\n\tcount=$(ip netns exec \"$ns2\" nstat -as | grep MPTcpExtMPPrioTx | awk '{print $2}')\n\t[ -z \"$count\" ] && count=0\n\tif [ $count != 1 ]; then\n\t\ttest_fail \"Count != 1: ${count}\"\n\telse\n\t\ttest_pass\n\tfi\n\n\t# Check RX\n\tprint_test \"MP_PRIO RX\"\n\tcount=$(ip netns exec \"$ns1\" nstat -as | grep MPTcpExtMPPrioRx | awk '{print $2}')\n\t[ -z \"$count\" ] && count=0\n\tif [ $count != 1 ]; then\n\t\ttest_fail \"Count != 1: ${count}\"\n\telse\n\t\ttest_pass\n\tfi\n}\n\nverify_listener_events()\n{\n\tlocal evt=$1\n\tlocal e_type=$2\n\tlocal e_family=$3\n\tlocal e_saddr=$4\n\tlocal e_sport=$5\n\tlocal type\n\tlocal family\n\tlocal saddr\n\tlocal sport\n\n\tif [ $e_type = $LISTENER_CREATED ]; then\n\t\tprint_test \"CREATE_LISTENER $e_saddr:$e_sport\"\n\telif [ $e_type = $LISTENER_CLOSED ]; then\n\t\tprint_test \"CLOSE_LISTENER $e_saddr:$e_sport\"\n\tfi\n\n\ttype=$(grep \"type:$e_type,\" $evt |\n\t       sed --unbuffered -n 's/.*\\(type:\\)\\([[:digit:]]*\\).*$/\\2/p;q')\n\tfamily=$(grep \"type:$e_type,\" $evt |\n\t\t sed --unbuffered -n 's/.*\\(family:\\)\\([[:digit:]]*\\).*$/\\2/p;q')\n\tsport=$(grep \"type:$e_type,\" $evt |\n\t\tsed --unbuffered -n 's/.*\\(sport:\\)\\([[:digit:]]*\\).*$/\\2/p;q')\n\tif [ $family ] && [ $family = $AF_INET6 ]; then\n\t\tsaddr=$(grep \"type:$e_type,\" $evt |\n\t\t\tsed --unbuffered -n 's/.*\\(saddr6:\\)\\([0-9a-f:.]*\\).*$/\\2/p;q')\n\telse\n\t\tsaddr=$(grep \"type:$e_type,\" $evt |\n\t\t\tsed --unbuffered -n 's/.*\\(saddr4:\\)\\([0-9.]*\\).*$/\\2/p;q')\n\tfi\n\n\tcheck_expected \"type\" \"family\" \"saddr\" \"sport\"\n}\n\ntest_listener()\n{\n\tprint_title \"Listener tests\"\n\n\tif ! mptcp_lib_kallsyms_has \"mptcp_event_pm_listener$\"; then\n\t\tprint_test \"LISTENER events\"\n\t\ttest_skip\n\t\treturn\n\tfi\n\n\t# Capture events on the network namespace running the client\n\t:>$client_evts\n\n\t# Attempt to add a listener at 10.0.2.2:<subflow-port>\n\tip netns exec $ns2 ./pm_nl_ctl listen 10.0.2.2\\\n\t\t$client4_port &\n\tlocal listener_pid=$!\n\n\tsleep 0.5\n\tverify_listener_events $client_evts $LISTENER_CREATED $AF_INET 10.0.2.2 $client4_port\n\n\t# ADD_ADDR from client to server machine reusing the subflow port\n\tip netns exec $ns2 ./pm_nl_ctl ann 10.0.2.2 token $client4_token id\\\n\t\t$client_addr_id\n\tsleep 0.5\n\n\t# CREATE_SUBFLOW from server to client machine\n\tip netns exec $ns1 ./pm_nl_ctl csf lip 10.0.2.1 lid 23 rip 10.0.2.2\\\n\t\trport $client4_port token $server4_token\n\tsleep 0.5\n\n\t# Delete the listener from the client ns, if one was created\n\tkill_wait $listener_pid\n\n\tsleep 0.5\n\tverify_listener_events $client_evts $LISTENER_CLOSED $AF_INET 10.0.2.2 $client4_port\n}\n\nprint_title \"Make connections\"\nmake_connection\nmake_connection \"v6\"\n\ntest_announce\ntest_remove\ntest_subflows\ntest_subflows_v4_v6_mix\ntest_prio\ntest_listener\n\nmptcp_lib_result_print_all_tap\nexit ${ret}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}