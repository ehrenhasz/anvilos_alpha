{
  "module_name": "fcnal-test.sh",
  "hash_id": "de9c0766261a7f830191ff452cb8e78f5c300582992e7de43300fdfdfe3e33ec",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/fcnal-test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Copyright (c) 2019 David Ahern <dsahern@gmail.com>. All rights reserved.\n#\n# IPv4 and IPv6 functional tests focusing on VRF and routing lookups\n# for various permutations:\n#   1. icmp, tcp, udp and netfilter\n#   2. client, server, no-server\n#   3. global address on interface\n#   4. global address on 'lo'\n#   5. remote and local traffic\n#   6. VRF and non-VRF permutations\n#\n# Setup:\n#                     ns-A     |     ns-B\n# No VRF case:\n#    [ lo ]         [ eth1 ]---|---[ eth1 ]      [ lo ]\n#                                                remote address\n# VRF case:\n#         [ red ]---[ eth1 ]---|---[ eth1 ]      [ lo ]\n#\n# ns-A:\n#     eth1: 172.16.1.1/24, 2001:db8:1::1/64\n#       lo: 127.0.0.1/8, ::1/128\n#           172.16.2.1/32, 2001:db8:2::1/128\n#      red: 127.0.0.1/8, ::1/128\n#           172.16.3.1/32, 2001:db8:3::1/128\n#\n# ns-B:\n#     eth1: 172.16.1.2/24, 2001:db8:1::2/64\n#      lo2: 127.0.0.1/8, ::1/128\n#           172.16.2.2/32, 2001:db8:2::2/128\n#\n# ns-A to ns-C connection - only for VRF and same config\n# as ns-A to ns-B\n#\n# server / client nomenclature relative to ns-A\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nVERBOSE=0\n\nNSA_DEV=eth1\nNSA_DEV2=eth2\nNSB_DEV=eth1\nNSC_DEV=eth2\nVRF=red\nVRF_TABLE=1101\n\n# IPv4 config\nNSA_IP=172.16.1.1\nNSB_IP=172.16.1.2\nVRF_IP=172.16.3.1\nNS_NET=172.16.1.0/24\n\n# IPv6 config\nNSA_IP6=2001:db8:1::1\nNSB_IP6=2001:db8:1::2\nVRF_IP6=2001:db8:3::1\nNS_NET6=2001:db8:1::/120\n\nNSA_LO_IP=172.16.2.1\nNSB_LO_IP=172.16.2.2\nNSA_LO_IP6=2001:db8:2::1\nNSB_LO_IP6=2001:db8:2::2\n\n# non-local addresses for freebind tests\nNL_IP=172.17.1.1\nNL_IP6=2001:db8:4::1\n\n# multicast and broadcast addresses\nMCAST_IP=224.0.0.1\nBCAST_IP=255.255.255.255\n\nMD5_PW=abc123\nMD5_WRONG_PW=abc1234\n\nMCAST=ff02::1\n# set after namespace create\nNSA_LINKIP6=\nNSB_LINKIP6=\n\nNSA=ns-A\nNSB=ns-B\nNSC=ns-C\n\nNSA_CMD=\"ip netns exec ${NSA}\"\nNSB_CMD=\"ip netns exec ${NSB}\"\nNSC_CMD=\"ip netns exec ${NSC}\"\n\nwhich ping6 > /dev/null 2>&1 && ping6=$(which ping6) || ping6=$(which ping)\n\n# Check if FIPS mode is enabled\nif [ -f /proc/sys/crypto/fips_enabled ]; then\n\tfips_enabled=`cat /proc/sys/crypto/fips_enabled`\nelse\n\tfips_enabled=0\nfi\n\n################################################################################\n# utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\t[ \"${VERBOSE}\" = \"1\" ] && echo\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tnsuccess=$((nsuccess+1))\n\t\tprintf \"TEST: %-70s  [ OK ]\\n\" \"${msg}\"\n\telse\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-70s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n\n\tkill_procs\n}\n\nlog_test_addr()\n{\n\tlocal addr=$1\n\tlocal rc=$2\n\tlocal expected=$3\n\tlocal msg=\"$4\"\n\tlocal astr\n\n\tastr=$(addr2str ${addr})\n\tlog_test $rc $expected \"$msg - ${astr}\"\n}\n\nlog_section()\n{\n\techo\n\techo \"###########################################################################\"\n\techo \"$*\"\n\techo \"###########################################################################\"\n\techo\n}\n\nlog_subsection()\n{\n\techo\n\techo \"#################################################################\"\n\techo \"$*\"\n\techo\n}\n\nlog_start()\n{\n\t# make sure we have no test instances running\n\tkill_procs\n\n\tif [ \"${VERBOSE}\" = \"1\" ]; then\n\t\techo\n\t\techo \"#######################################################\"\n\tfi\n}\n\nlog_debug()\n{\n\tif [ \"${VERBOSE}\" = \"1\" ]; then\n\t\techo\n\t\techo \"$*\"\n\t\techo\n\tfi\n}\n\nshow_hint()\n{\n\tif [ \"${VERBOSE}\" = \"1\" ]; then\n\t\techo \"HINT: $*\"\n\t\techo\n\tfi\n}\n\nkill_procs()\n{\n\tkillall nettest ping ping6 >/dev/null 2>&1\n\tsleep 1\n}\n\ndo_run_cmd()\n{\n\tlocal cmd=\"$*\"\n\tlocal out\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\techo \"COMMAND: ${cmd}\"\n\tfi\n\n\tout=$($cmd 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"$out\"\n\tfi\n\n\treturn $rc\n}\n\nrun_cmd()\n{\n\tdo_run_cmd ${NSA_CMD} $*\n}\n\nrun_cmd_nsb()\n{\n\tdo_run_cmd ${NSB_CMD} $*\n}\n\nrun_cmd_nsc()\n{\n\tdo_run_cmd ${NSC_CMD} $*\n}\n\nsetup_cmd()\n{\n\tlocal cmd=\"$*\"\n\tlocal rc\n\n\trun_cmd ${cmd}\n\trc=$?\n\tif [ $rc -ne 0 ]; then\n\t\t# show user the command if not done so already\n\t\tif [ \"$VERBOSE\" = \"0\" ]; then\n\t\t\techo \"setup command: $cmd\"\n\t\tfi\n\t\techo \"failed. stopping tests\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue\"\n\t\t\tread a\n\t\tfi\n\t\texit $rc\n\tfi\n}\n\nsetup_cmd_nsb()\n{\n\tlocal cmd=\"$*\"\n\tlocal rc\n\n\trun_cmd_nsb ${cmd}\n\trc=$?\n\tif [ $rc -ne 0 ]; then\n\t\t# show user the command if not done so already\n\t\tif [ \"$VERBOSE\" = \"0\" ]; then\n\t\t\techo \"setup command: $cmd\"\n\t\tfi\n\t\techo \"failed. stopping tests\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue\"\n\t\t\tread a\n\t\tfi\n\t\texit $rc\n\tfi\n}\n\nsetup_cmd_nsc()\n{\n\tlocal cmd=\"$*\"\n\tlocal rc\n\n\trun_cmd_nsc ${cmd}\n\trc=$?\n\tif [ $rc -ne 0 ]; then\n\t\t# show user the command if not done so already\n\t\tif [ \"$VERBOSE\" = \"0\" ]; then\n\t\t\techo \"setup command: $cmd\"\n\t\tfi\n\t\techo \"failed. stopping tests\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue\"\n\t\t\tread a\n\t\tfi\n\t\texit $rc\n\tfi\n}\n\n# set sysctl values in NS-A\nset_sysctl()\n{\n\techo \"SYSCTL: $*\"\n\techo\n\trun_cmd sysctl -q -w $*\n}\n\n# get sysctl values in NS-A\nget_sysctl()\n{\n\t${NSA_CMD} sysctl -n $*\n}\n\n################################################################################\n# Setup for tests\n\naddr2str()\n{\n\tcase \"$1\" in\n\t127.0.0.1) echo \"loopback\";;\n\t::1) echo \"IPv6 loopback\";;\n\n\t${BCAST_IP}) echo \"broadcast\";;\n\t${MCAST_IP}) echo \"multicast\";;\n\n\t${NSA_IP})\techo \"ns-A IP\";;\n\t${NSA_IP6})\techo \"ns-A IPv6\";;\n\t${NSA_LO_IP})\techo \"ns-A loopback IP\";;\n\t${NSA_LO_IP6})\techo \"ns-A loopback IPv6\";;\n\t${NSA_LINKIP6}|${NSA_LINKIP6}%*) echo \"ns-A IPv6 LLA\";;\n\n\t${NSB_IP})\techo \"ns-B IP\";;\n\t${NSB_IP6})\techo \"ns-B IPv6\";;\n\t${NSB_LO_IP})\techo \"ns-B loopback IP\";;\n\t${NSB_LO_IP6})\techo \"ns-B loopback IPv6\";;\n\t${NSB_LINKIP6}|${NSB_LINKIP6}%*) echo \"ns-B IPv6 LLA\";;\n\n\t${NL_IP})       echo \"nonlocal IP\";;\n\t${NL_IP6})      echo \"nonlocal IPv6\";;\n\n\t${VRF_IP})\techo \"VRF IP\";;\n\t${VRF_IP6})\techo \"VRF IPv6\";;\n\n\t${MCAST}%*)\techo \"multicast IP\";;\n\n\t*) echo \"unknown\";;\n\tesac\n}\n\nget_linklocal()\n{\n\tlocal ns=$1\n\tlocal dev=$2\n\tlocal addr\n\n\taddr=$(ip -netns ${ns} -6 -br addr show dev ${dev} | \\\n\tawk '{\n\t\tfor (i = 3; i <= NF; ++i) {\n\t\t\tif ($i ~ /^fe80/)\n\t\t\t\tprint $i\n\t\t}\n\t}'\n\t)\n\taddr=${addr/\\/*}\n\n\t[ -z \"$addr\" ] && return 1\n\n\techo $addr\n\n\treturn 0\n}\n\n################################################################################\n# create namespaces and vrf\n\ncreate_vrf()\n{\n\tlocal ns=$1\n\tlocal vrf=$2\n\tlocal table=$3\n\tlocal addr=$4\n\tlocal addr6=$5\n\n\tip -netns ${ns} link add ${vrf} type vrf table ${table}\n\tip -netns ${ns} link set ${vrf} up\n\tip -netns ${ns} route add vrf ${vrf} unreachable default metric 8192\n\tip -netns ${ns} -6 route add vrf ${vrf} unreachable default metric 8192\n\n\tip -netns ${ns} addr add 127.0.0.1/8 dev ${vrf}\n\tip -netns ${ns} -6 addr add ::1 dev ${vrf} nodad\n\tif [ \"${addr}\" != \"-\" ]; then\n\t\tip -netns ${ns} addr add dev ${vrf} ${addr}\n\tfi\n\tif [ \"${addr6}\" != \"-\" ]; then\n\t\tip -netns ${ns} -6 addr add dev ${vrf} ${addr6}\n\tfi\n\n\tip -netns ${ns} ru del pref 0\n\tip -netns ${ns} ru add pref 32765 from all lookup local\n\tip -netns ${ns} -6 ru del pref 0\n\tip -netns ${ns} -6 ru add pref 32765 from all lookup local\n}\n\ncreate_ns()\n{\n\tlocal ns=$1\n\tlocal addr=$2\n\tlocal addr6=$3\n\n\tip netns add ${ns}\n\n\tip -netns ${ns} link set lo up\n\tif [ \"${addr}\" != \"-\" ]; then\n\t\tip -netns ${ns} addr add dev lo ${addr}\n\tfi\n\tif [ \"${addr6}\" != \"-\" ]; then\n\t\tip -netns ${ns} -6 addr add dev lo ${addr6}\n\tfi\n\n\tip -netns ${ns} ro add unreachable default metric 8192\n\tip -netns ${ns} -6 ro add unreachable default metric 8192\n\n\tip netns exec ${ns} sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.forwarding=1\n}\n\n# create veth pair to connect namespaces and apply addresses.\nconnect_ns()\n{\n\tlocal ns1=$1\n\tlocal ns1_dev=$2\n\tlocal ns1_addr=$3\n\tlocal ns1_addr6=$4\n\tlocal ns2=$5\n\tlocal ns2_dev=$6\n\tlocal ns2_addr=$7\n\tlocal ns2_addr6=$8\n\n\tip -netns ${ns1} li add ${ns1_dev} type veth peer name tmp\n\tip -netns ${ns1} li set ${ns1_dev} up\n\tip -netns ${ns1} li set tmp netns ${ns2} name ${ns2_dev}\n\tip -netns ${ns2} li set ${ns2_dev} up\n\n\tif [ \"${ns1_addr}\" != \"-\" ]; then\n\t\tip -netns ${ns1} addr add dev ${ns1_dev} ${ns1_addr}\n\t\tip -netns ${ns2} addr add dev ${ns2_dev} ${ns2_addr}\n\tfi\n\n\tif [ \"${ns1_addr6}\" != \"-\" ]; then\n\t\tip -netns ${ns1} addr add dev ${ns1_dev} ${ns1_addr6}\n\t\tip -netns ${ns2} addr add dev ${ns2_dev} ${ns2_addr6}\n\tfi\n}\n\ncleanup()\n{\n\t# explicit cleanups to check those code paths\n\tip netns | grep -q ${NSA}\n\tif [ $? -eq 0 ]; then\n\t\tip -netns ${NSA} link delete ${VRF}\n\t\tip -netns ${NSA} ro flush table ${VRF_TABLE}\n\n\t\tip -netns ${NSA} addr flush dev ${NSA_DEV}\n\t\tip -netns ${NSA} -6 addr flush dev ${NSA_DEV}\n\t\tip -netns ${NSA} link set dev ${NSA_DEV} down\n\t\tip -netns ${NSA} link del dev ${NSA_DEV}\n\n\t\tip netns pids ${NSA} | xargs kill 2>/dev/null\n\t\tip netns del ${NSA}\n\tfi\n\n\tip netns pids ${NSB} | xargs kill 2>/dev/null\n\tip netns del ${NSB}\n\tip netns pids ${NSC} | xargs kill 2>/dev/null\n\tip netns del ${NSC} >/dev/null 2>&1\n}\n\ncleanup_vrf_dup()\n{\n\tip link del ${NSA_DEV2} >/dev/null 2>&1\n\tip netns pids ${NSC} | xargs kill 2>/dev/null\n\tip netns del ${NSC} >/dev/null 2>&1\n}\n\nsetup_vrf_dup()\n{\n\t# some VRF tests use ns-C which has the same config as\n\t# ns-B but for a device NOT in the VRF\n\tcreate_ns ${NSC} \"-\" \"-\"\n\tconnect_ns ${NSA} ${NSA_DEV2} ${NSA_IP}/24 ${NSA_IP6}/64 \\\n\t\t   ${NSC} ${NSC_DEV} ${NSB_IP}/24 ${NSB_IP6}/64\n}\n\nsetup()\n{\n\tlocal with_vrf=${1}\n\n\t# make sure we are starting with a clean slate\n\tkill_procs\n\tcleanup 2>/dev/null\n\n\tlog_debug \"Configuring network namespaces\"\n\tset -e\n\n\tcreate_ns ${NSA} ${NSA_LO_IP}/32 ${NSA_LO_IP6}/128\n\tcreate_ns ${NSB} ${NSB_LO_IP}/32 ${NSB_LO_IP6}/128\n\tconnect_ns ${NSA} ${NSA_DEV} ${NSA_IP}/24 ${NSA_IP6}/64 \\\n\t\t   ${NSB} ${NSB_DEV} ${NSB_IP}/24 ${NSB_IP6}/64\n\n\tNSA_LINKIP6=$(get_linklocal ${NSA} ${NSA_DEV})\n\tNSB_LINKIP6=$(get_linklocal ${NSB} ${NSB_DEV})\n\n\t# tell ns-A how to get to remote addresses of ns-B\n\tif [ \"${with_vrf}\" = \"yes\" ]; then\n\t\tcreate_vrf ${NSA} ${VRF} ${VRF_TABLE} ${VRF_IP} ${VRF_IP6}\n\n\t\tip -netns ${NSA} link set dev ${NSA_DEV} vrf ${VRF}\n\t\tip -netns ${NSA} ro add vrf ${VRF} ${NSB_LO_IP}/32 via ${NSB_IP} dev ${NSA_DEV}\n\t\tip -netns ${NSA} -6 ro add vrf ${VRF} ${NSB_LO_IP6}/128 via ${NSB_IP6} dev ${NSA_DEV}\n\n\t\tip -netns ${NSB} ro add ${VRF_IP}/32 via ${NSA_IP} dev ${NSB_DEV}\n\t\tip -netns ${NSB} -6 ro add ${VRF_IP6}/128 via ${NSA_IP6} dev ${NSB_DEV}\n\telse\n\t\tip -netns ${NSA} ro add ${NSB_LO_IP}/32 via ${NSB_IP} dev ${NSA_DEV}\n\t\tip -netns ${NSA} ro add ${NSB_LO_IP6}/128 via ${NSB_IP6} dev ${NSA_DEV}\n\tfi\n\n\n\t# tell ns-B how to get to remote addresses of ns-A\n\tip -netns ${NSB} ro add ${NSA_LO_IP}/32 via ${NSA_IP} dev ${NSB_DEV}\n\tip -netns ${NSB} ro add ${NSA_LO_IP6}/128 via ${NSA_IP6} dev ${NSB_DEV}\n\n\tset +e\n\n\tsleep 1\n}\n\nsetup_lla_only()\n{\n\t# make sure we are starting with a clean slate\n\tkill_procs\n\tcleanup 2>/dev/null\n\n\tlog_debug \"Configuring network namespaces\"\n\tset -e\n\n\tcreate_ns ${NSA} \"-\" \"-\"\n\tcreate_ns ${NSB} \"-\" \"-\"\n\tcreate_ns ${NSC} \"-\" \"-\"\n\tconnect_ns ${NSA} ${NSA_DEV} \"-\" \"-\" \\\n\t\t   ${NSB} ${NSB_DEV} \"-\" \"-\"\n\tconnect_ns ${NSA} ${NSA_DEV2} \"-\" \"-\" \\\n\t\t   ${NSC} ${NSC_DEV}  \"-\" \"-\"\n\n\tNSA_LINKIP6=$(get_linklocal ${NSA} ${NSA_DEV})\n\tNSB_LINKIP6=$(get_linklocal ${NSB} ${NSB_DEV})\n\tNSC_LINKIP6=$(get_linklocal ${NSC} ${NSC_DEV})\n\n\tcreate_vrf ${NSA} ${VRF} ${VRF_TABLE} \"-\" \"-\"\n\tip -netns ${NSA} link set dev ${NSA_DEV} vrf ${VRF}\n\tip -netns ${NSA} link set dev ${NSA_DEV2} vrf ${VRF}\n\n\tset +e\n\n\tsleep 1\n}\n\n################################################################################\n# IPv4\n\nipv4_ping_novrf()\n{\n\tlocal a\n\n\t#\n\t# out\n\t#\n\tfor a in ${NSB_IP} ${NSB_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd ping -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out\"\n\n\t\tlog_start\n\t\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, device bind\"\n\n\t\tlog_start\n\t\trun_cmd ping -c1 -w1 -I ${NSA_LO_IP} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, address bind\"\n\tdone\n\n\t#\n\t# out, but don't use gateway if peer is not on link\n\t#\n\ta=${NSB_IP}\n\tlog_start\n\trun_cmd ping -c 1 -w 1 -r ${a}\n\tlog_test_addr ${a} $? 0 \"ping out (don't route), peer on link\"\n\n\ta=${NSB_LO_IP}\n\tlog_start\n\tshow_hint \"Fails since peer is not on link\"\n\trun_cmd ping -c 1 -w 1 -r ${a}\n\tlog_test_addr ${a} $? 1 \"ping out (don't route), peer not on link\"\n\n\t#\n\t# in\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb ping -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping in\"\n\tdone\n\n\t#\n\t# local traffic\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\trun_cmd ping -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping local\"\n\tdone\n\n\t#\n\t# local traffic, socket bound to device\n\t#\n\t# address on device\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 0 \"ping local, device bind\"\n\n\t# loopback addresses not reachable from device bind\n\t# fails in a really weird way though because ipv4 special cases\n\t# route lookups with oif set.\n\tfor a in ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Fails since address on loopback device is out of device scope\"\n\t\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 1 \"ping local, device bind\"\n\tdone\n\n\t#\n\t# ip rule blocks reachability to remote address\n\t#\n\tlog_start\n\tsetup_cmd ip rule add pref 32765 from all lookup local\n\tsetup_cmd ip rule del pref 0 from all lookup local\n\tsetup_cmd ip rule add pref 50 to ${NSB_LO_IP} prohibit\n\tsetup_cmd ip rule add pref 51 from ${NSB_IP} prohibit\n\n\ta=${NSB_LO_IP}\n\trun_cmd ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, blocked by rule\"\n\n\t# NOTE: ipv4 actually allows the lookup to fail and yet still create\n\t# a viable rtable if the oif (e.g., bind to device) is set, so this\n\t# case succeeds despite the rule\n\t# run_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\n\ta=${NSA_LO_IP}\n\tlog_start\n\tshow_hint \"Response generates ICMP (or arp request is ignored) due to ip rule\"\n\trun_cmd_nsb ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, blocked by rule\"\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\tsetup_cmd ip rule del pref 32765 from all lookup local\n\tsetup_cmd ip rule add pref 0 from all lookup local\n\tsetup_cmd ip rule del pref 50 to ${NSB_LO_IP} prohibit\n\tsetup_cmd ip rule del pref 51 from ${NSB_IP} prohibit\n\n\t#\n\t# route blocks reachability to remote address\n\t#\n\tlog_start\n\tsetup_cmd ip route replace unreachable ${NSB_LO_IP}\n\tsetup_cmd ip route replace unreachable ${NSB_IP}\n\n\ta=${NSB_LO_IP}\n\trun_cmd ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, blocked by route\"\n\n\t# NOTE: ipv4 actually allows the lookup to fail and yet still create\n\t# a viable rtable if the oif (e.g., bind to device) is set, so this\n\t# case succeeds despite not having a route for the address\n\t# run_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\n\ta=${NSA_LO_IP}\n\tlog_start\n\tshow_hint \"Response is dropped (or arp request is ignored) due to ip route\"\n\trun_cmd_nsb ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, blocked by route\"\n\n\t#\n\t# remove 'remote' routes; fallback to default\n\t#\n\tlog_start\n\tsetup_cmd ip ro del ${NSB_LO_IP}\n\n\ta=${NSB_LO_IP}\n\trun_cmd ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, unreachable default route\"\n\n\t# NOTE: ipv4 actually allows the lookup to fail and yet still create\n\t# a viable rtable if the oif (e.g., bind to device) is set, so this\n\t# case succeeds despite not having a route for the address\n\t# run_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n}\n\nipv4_ping_vrf()\n{\n\tlocal a\n\n\t# should default on; does not exist on older kernels\n\tset_sysctl net.ipv4.raw_l3mdev_accept=1 2>/dev/null\n\n\t#\n\t# out\n\t#\n\tfor a in ${NSB_IP} ${NSB_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd ping -c1 -w1 -I ${VRF} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, VRF bind\"\n\n\t\tlog_start\n\t\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, device bind\"\n\n\t\tlog_start\n\t\trun_cmd ip vrf exec ${VRF} ping -c1 -w1 -I ${NSA_IP} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, vrf device + dev address bind\"\n\n\t\tlog_start\n\t\trun_cmd ip vrf exec ${VRF} ping -c1 -w1 -I ${VRF_IP} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, vrf device + vrf address bind\"\n\tdone\n\n\t#\n\t# in\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb ping -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping in\"\n\tdone\n\n\t#\n\t# local traffic, local address\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Source address should be ${a}\"\n\t\trun_cmd ping -c1 -w1 -I ${VRF} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping local, VRF bind\"\n\tdone\n\n\t#\n\t# local traffic, socket bound to device\n\t#\n\t# address on device\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 0 \"ping local, device bind\"\n\n\t# vrf device is out of scope\n\tfor a in ${VRF_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Fails since address on vrf device is out of device scope\"\n\t\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 2 \"ping local, device bind\"\n\tdone\n\n\t#\n\t# ip rule blocks address\n\t#\n\tlog_start\n\tsetup_cmd ip rule add pref 50 to ${NSB_LO_IP} prohibit\n\tsetup_cmd ip rule add pref 51 from ${NSB_IP} prohibit\n\n\ta=${NSB_LO_IP}\n\trun_cmd ping -c1 -w1 -I ${VRF} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, vrf bind, blocked by rule\"\n\n\tlog_start\n\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, blocked by rule\"\n\n\ta=${NSA_LO_IP}\n\tlog_start\n\tshow_hint \"Response lost due to ip rule\"\n\trun_cmd_nsb ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, blocked by rule\"\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\tsetup_cmd ip rule del pref 50 to ${NSB_LO_IP} prohibit\n\tsetup_cmd ip rule del pref 51 from ${NSB_IP} prohibit\n\n\t#\n\t# remove 'remote' routes; fallback to default\n\t#\n\tlog_start\n\tsetup_cmd ip ro del vrf ${VRF} ${NSB_LO_IP}\n\n\ta=${NSB_LO_IP}\n\trun_cmd ping -c1 -w1 -I ${VRF} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, vrf bind, unreachable route\"\n\n\tlog_start\n\trun_cmd ping -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, unreachable route\"\n\n\ta=${NSA_LO_IP}\n\tlog_start\n\tshow_hint \"Response lost by unreachable route\"\n\trun_cmd_nsb ping -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, unreachable route\"\n}\n\nipv4_ping()\n{\n\tlog_section \"IPv4 ping\"\n\n\tlog_subsection \"No VRF\"\n\tsetup\n\tset_sysctl net.ipv4.raw_l3mdev_accept=0 2>/dev/null\n\tipv4_ping_novrf\n\tsetup\n\tset_sysctl net.ipv4.raw_l3mdev_accept=1 2>/dev/null\n\tipv4_ping_novrf\n\tsetup\n\tset_sysctl net.ipv4.ping_group_range='0 2147483647' 2>/dev/null\n\tipv4_ping_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tipv4_ping_vrf\n\tsetup \"yes\"\n\tset_sysctl net.ipv4.ping_group_range='0 2147483647' 2>/dev/null\n\tipv4_ping_vrf\n}\n\n################################################################################\n# IPv4 TCP\n\n#\n# MD5 tests without VRF\n#\nipv4_tcp_md5_novrf()\n{\n\t#\n\t# single address\n\t#\n\n\t# basic use case\n\tlog_start\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: Single address config\"\n\n\t# client sends MD5, server not configured\n\tlog_start\n\tshow_hint \"Should timeout due to MD5 mismatch\"\n\trun_cmd nettest -s &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: Server no config, client uses password\"\n\n\t# wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: Client uses wrong password\"\n\n\t# client from different address\n\tlog_start\n\tshow_hint \"Should timeout due to MD5 mismatch\"\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NSB_LO_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: Client address does not match address configured with password\"\n\n\t#\n\t# MD5 extension - prefix length\n\t#\n\n\t# client in prefix\n\tlog_start\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest  -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: Prefix config\"\n\n\t# client in prefix, wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: Prefix config, client uses wrong password\"\n\n\t# client outside of prefix\n\tlog_start\n\tshow_hint \"Should timeout due to MD5 mismatch\"\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest -c ${NSB_LO_IP} -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: Prefix config, client address not in configured prefix\"\n}\n\n#\n# MD5 tests with VRF\n#\nipv4_tcp_md5()\n{\n\t#\n\t# single address\n\t#\n\n\t# basic use case\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Single address config\"\n\n\t# client sends MD5, server not configured\n\tlog_start\n\tshow_hint \"Should timeout since server does not have MD5 auth\"\n\trun_cmd nettest -s -I ${VRF} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Server no config, client uses password\"\n\n\t# wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Client uses wrong password\"\n\n\t# client from different address\n\tlog_start\n\tshow_hint \"Should timeout since server config differs from client\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_LO_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Client address does not match address configured with password\"\n\n\t#\n\t# MD5 extension - prefix length\n\t#\n\n\t# client in prefix\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest  -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Prefix config\"\n\n\t# client in prefix, wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config, client uses wrong password\"\n\n\t# client outside of prefix\n\tlog_start\n\tshow_hint \"Should timeout since client address is outside of prefix\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest -c ${NSB_LO_IP} -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config, client address not in configured prefix\"\n\n\t#\n\t# duplicate config between default VRF and a VRF\n\t#\n\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest  -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Single address config in default VRF and VRF, conn in VRF\"\n\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsc nettest  -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 0 \"MD5: VRF: Single address config in default VRF and VRF, conn in default VRF\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in default VRF uses VRF password\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsc nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Single address config in default VRF and VRF, conn in default VRF with VRF pw\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in VRF uses default VRF password\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NSB_IP} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Single address config in default VRF and VRF, conn in VRF with default VRF pw\"\n\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest  -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Prefix config in default VRF and VRF, conn in VRF\"\n\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsc nettest  -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 0 \"MD5: VRF: Prefix config in default VRF and VRF, conn in default VRF\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in default VRF uses VRF password\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsc nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config in default VRF and VRF, conn in default VRF with VRF pw\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in VRF uses default VRF password\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} &\n\trun_cmd nettest -s -M ${MD5_WRONG_PW} -m ${NS_NET} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config in default VRF and VRF, conn in VRF with default VRF pw\"\n\n\t#\n\t# negative tests\n\t#\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} -M ${MD5_PW} -m ${NSB_IP}\n\tlog_test $? 1 \"MD5: VRF: Device must be a VRF - single address\"\n\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} -M ${MD5_PW} -m ${NS_NET}\n\tlog_test $? 1 \"MD5: VRF: Device must be a VRF - prefix\"\n\n\ttest_ipv4_md5_vrf__vrf_server__no_bind_ifindex\n\ttest_ipv4_md5_vrf__global_server__bind_ifindex0\n}\n\ntest_ipv4_md5_vrf__vrf_server__no_bind_ifindex()\n{\n\tlog_start\n\tshow_hint \"Simulates applications using VRF without TCP_MD5SIG_FLAG_IFINDEX\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} --no-bind-key-ifindex &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: VRF-bound server, unbound key accepts connection\"\n\n\tlog_start\n\tshow_hint \"Binding both the socket and the key is not required but it works\"\n\trun_cmd nettest -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET} --force-bind-key-ifindex &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: VRF-bound server, bound key accepts connection\"\n}\n\ntest_ipv4_md5_vrf__global_server__bind_ifindex0()\n{\n\t# This particular test needs tcp_l3mdev_accept=1 for Global server to accept VRF connections\n\tlocal old_tcp_l3mdev_accept\n\told_tcp_l3mdev_accept=$(get_sysctl net.ipv4.tcp_l3mdev_accept)\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=1\n\n\tlog_start\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} --force-bind-key-ifindex &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Global server, Key bound to ifindex=0 rejects VRF connection\"\n\n\tlog_start\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} --force-bind-key-ifindex &\n\tsleep 1\n\trun_cmd_nsc nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Global server, key bound to ifindex=0 accepts non-VRF connection\"\n\tlog_start\n\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} --no-bind-key-ifindex &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Global server, key not bound to ifindex accepts VRF connection\"\n\n\tlog_start\n\trun_cmd nettest -s -M ${MD5_PW} -m ${NS_NET} --no-bind-key-ifindex &\n\tsleep 1\n\trun_cmd_nsc nettest -r ${NSA_IP} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Global server, key not bound to ifindex accepts non-VRF connection\"\n\n\t# restore value\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=\"$old_tcp_l3mdev_accept\"\n}\n\nipv4_tcp_dontroute()\n{\n\tlocal syncookies=$1\n\tlocal nsa_syncookies\n\tlocal nsb_syncookies\n\tlocal a\n\n\t#\n\t# Link local connection tests (SO_DONTROUTE).\n\t# Connections should succeed only when the remote IP address is\n\t# on link (doesn't need to be routed through a gateway).\n\t#\n\n\tnsa_syncookies=$(ip netns exec \"${NSA}\" sysctl -n net.ipv4.tcp_syncookies)\n\tnsb_syncookies=$(ip netns exec \"${NSB}\" sysctl -n net.ipv4.tcp_syncookies)\n\tip netns exec \"${NSA}\" sysctl -wq net.ipv4.tcp_syncookies=${syncookies}\n\tip netns exec \"${NSB}\" sysctl -wq net.ipv4.tcp_syncookies=${syncookies}\n\n\t# Test with eth1 address (on link).\n\n\ta=${NSB_IP}\n\tlog_start\n\tdo_run_cmd nettest -B -N \"${NSA}\" -O \"${NSB}\" -r ${a} --client-dontroute\n\tlog_test_addr ${a} $? 0 \"SO_DONTROUTE client, syncookies=${syncookies}\"\n\n\ta=${NSB_IP}\n\tlog_start\n\tdo_run_cmd nettest -B -N \"${NSA}\" -O \"${NSB}\" -r ${a} --server-dontroute\n\tlog_test_addr ${a} $? 0 \"SO_DONTROUTE server, syncookies=${syncookies}\"\n\n\t# Test with loopback address (routed).\n\t#\n\t# The client would use the eth1 address as source IP by default.\n\t# Therefore, we need to use the -c option here, to force the use of the\n\t# routed (loopback) address as source IP (so that the server will try\n\t# to respond to a routed address and not a link local one).\n\n\ta=${NSB_LO_IP}\n\tlog_start\n\tshow_hint \"Should fail 'Network is unreachable' since server is not on link\"\n\tdo_run_cmd nettest -B -N \"${NSA}\" -O \"${NSB}\" -c \"${NSA_LO_IP}\" -r ${a} --client-dontroute\n\tlog_test_addr ${a} $? 1 \"SO_DONTROUTE client, syncookies=${syncookies}\"\n\n\ta=${NSB_LO_IP}\n\tlog_start\n\tshow_hint \"Should timeout since server cannot respond (client is not on link)\"\n\tdo_run_cmd nettest -B -N \"${NSA}\" -O \"${NSB}\" -c \"${NSA_LO_IP}\" -r ${a} --server-dontroute\n\tlog_test_addr ${a} $? 2 \"SO_DONTROUTE server, syncookies=${syncookies}\"\n\n\tip netns exec \"${NSB}\" sysctl -wq net.ipv4.tcp_syncookies=${nsb_syncookies}\n\tip netns exec \"${NSA}\" sysctl -wq net.ipv4.tcp_syncookies=${nsa_syncookies}\n}\n\nipv4_tcp_novrf()\n{\n\tlocal a\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server\"\n\n\t# verify TCP reset sent and received\n\tfor a in ${NSA_IP} ${NSA_LO_IP}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since there is no server\"\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t#\n\t# client\n\t#\n\tfor a in ${NSB_IP} ${NSB_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -s &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -0 ${NSA_IP}\n\t\tlog_test_addr ${a} $? 0 \"Client\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -s &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server, unbound client\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client\"\n\tdone\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -0 ${a} -1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -r ${a} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, unbound client, local connection\"\n\n\tfor a in ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -s -I ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Device server, unbound client, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s &\n\tsleep 1\n\trun_cmd nettest -r ${a} -0 ${a} -d ${NSA_DEV}\n\tlog_test_addr ${a} $? 0 \"Global server, device client, local connection\"\n\n\tfor a in ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'No route to host' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -s &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest  -d ${NSA_DEV} -r ${a} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, device client, local connection\"\n\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused'\"\n\trun_cmd nettest -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 1 \"No server, device client, local conn\"\n\n\t[ \"$fips_enabled\" = \"1\" ] || ipv4_tcp_md5_novrf\n\n\tipv4_tcp_dontroute 0\n\tipv4_tcp_dontroute 2\n}\n\nipv4_tcp_vrf()\n{\n\tlocal a\n\n\t# disable global server\n\tlog_subsection \"Global server disabled\"\n\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=0\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since global server with VRF is disabled\"\n\t\trun_cmd nettest -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -s -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Device server\"\n\n\t\t# verify TCP reset received\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since there is no server\"\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t# local address tests\n\t# (${VRF_IP} and 127.0.0.1 both timeout)\n\ta=${NSA_IP}\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused' since global server with VRF is disabled\"\n\trun_cmd nettest -s &\n\tsleep 1\n\trun_cmd nettest -r ${a} -d ${NSA_DEV}\n\tlog_test_addr ${a} $? 1 \"Global server, local connection\"\n\n\t# run MD5 tests\n\tif [ \"$fips_enabled\" = \"0\" ]; then\n\t\tsetup_vrf_dup\n\t\tipv4_tcp_md5\n\t\tcleanup_vrf_dup\n\tfi\n\n\t#\n\t# enable VRF global server\n\t#\n\tlog_subsection \"VRF Global server enabled\"\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=1\n\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"client socket should be bound to VRF\"\n\t\trun_cmd nettest -s -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\n\t\tlog_start\n\t\tshow_hint \"client socket should be bound to VRF\"\n\t\trun_cmd nettest -s -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\n\t\t# verify TCP reset received\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\tshow_hint \"client socket should be bound to device\"\n\trun_cmd nettest -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server\"\n\n\t# local address tests\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since client is not bound to VRF\"\n\t\trun_cmd nettest -s -I ${VRF} &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server, local connection\"\n\tdone\n\n\t#\n\t# client\n\t#\n\tfor a in ${NSB_IP} ${NSB_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -s &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -d ${VRF}\n\t\tlog_test_addr ${a} $? 0 \"Client, VRF bind\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -s &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -r ${a} -d ${VRF}\n\t\tlog_test_addr ${a} $? 1 \"No server, VRF client\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client\"\n\tdone\n\n\tfor a in ${NSA_IP} ${VRF_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd nettest -r ${a} -d ${VRF} -0 ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -I ${VRF} -3 ${VRF} &\n\tsleep 1\n\trun_cmd nettest -r ${a} -d ${NSA_DEV} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, device client, local connection\"\n\n\tlog_start\n\tshow_hint \"Should fail 'No route to host' since client is out of VRF scope\"\n\trun_cmd nettest -s -I ${VRF} &\n\tsleep 1\n\trun_cmd nettest -r ${a}\n\tlog_test_addr ${a} $? 1 \"VRF server, unbound client, local connection\"\n\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -r ${a} -d ${VRF} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, VRF client, local connection\"\n\n\tlog_start\n\trun_cmd nettest -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -r ${a} -d ${NSA_DEV} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, device client, local connection\"\n}\n\nipv4_tcp()\n{\n\tlog_section \"IPv4/TCP\"\n\tlog_subsection \"No VRF\"\n\tsetup\n\n\t# tcp_l3mdev_accept should have no affect without VRF;\n\t# run tests with it enabled and disabled to verify\n\tlog_subsection \"tcp_l3mdev_accept disabled\"\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=0\n\tipv4_tcp_novrf\n\tlog_subsection \"tcp_l3mdev_accept enabled\"\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=1\n\tipv4_tcp_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tipv4_tcp_vrf\n}\n\n################################################################################\n# IPv4 UDP\n\nipv4_udp_novrf()\n{\n\tlocal a\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -D -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since there is no server\"\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -D -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server\"\n\n\t#\n\t# client\n\t#\n\tfor a in ${NSB_IP} ${NSB_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -0 ${NSA_IP}\n\t\tlog_test_addr ${a} $? 0 \"Client\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -0 ${NSA_IP}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -C -0 ${NSA_IP}\n\t\tlog_test_addr ${a} $? 0 \"Client, device send via cmsg\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -S -0 ${NSA_IP}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind via IP_UNICAST_IF\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -S -0 ${NSA_IP} -U\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind via IP_UNICAST_IF, with connect()\"\n\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server, unbound client\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client\"\n\tdone\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -0 ${a} -1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -D -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, unbound client, local connection\"\n\n\tfor a in ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since address is out of device scope\"\n\t\trun_cmd nettest -s -D -I ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Device server, unbound client, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -D &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device client, local connection\"\n\n\tlog_start\n\trun_cmd nettest -s -D &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -C -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device send via cmsg, local connection\"\n\n\tlog_start\n\trun_cmd nettest -s -D &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -S -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device client via IP_UNICAST_IF, local connection\"\n\n\tlog_start\n\trun_cmd nettest -s -D &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -S -r ${a} -U\n\tlog_test_addr ${a} $? 0 \"Global server, device client via IP_UNICAST_IF, local connection, with connect()\"\n\n\n\t# IPv4 with device bind has really weird behavior - it overrides the\n\t# fib lookup, generates an rtable and tries to send the packet. This\n\t# causes failures for local traffic at different places\n\tfor a in ${NSA_LO_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 2 \"Global server, device client, local connection\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -C\n\t\tlog_test_addr ${a} $? 1 \"Global server, device send via cmsg, local connection\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -S\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client via IP_UNICAST_IF, local connection\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -r ${a} -d ${NSA_DEV} -S -U\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client via IP_UNICAST_IF, local connection, with connect()\"\n\n\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -D -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 2 \"No server, device client, local conn\"\n\n\t#\n\t# Link local connection tests (SO_DONTROUTE).\n\t# Connections should succeed only when the remote IP address is\n\t# on link (doesn't need to be routed through a gateway).\n\t#\n\n\ta=${NSB_IP}\n\tlog_start\n\tdo_run_cmd nettest -B -D -N \"${NSA}\" -O \"${NSB}\" -r ${a} --client-dontroute\n\tlog_test_addr ${a} $? 0 \"SO_DONTROUTE client\"\n\n\ta=${NSB_LO_IP}\n\tlog_start\n\tshow_hint \"Should fail 'Network is unreachable' since server is not on link\"\n\tdo_run_cmd nettest -B -D -N \"${NSA}\" -O \"${NSB}\" -r ${a} --client-dontroute\n\tlog_test_addr ${a} $? 1 \"SO_DONTROUTE client\"\n}\n\nipv4_udp_vrf()\n{\n\tlocal a\n\n\t# disable global server\n\tlog_subsection \"Global server disabled\"\n\tset_sysctl net.ipv4.udp_l3mdev_accept=0\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Fails because ingress is in a VRF and global server is disabled\"\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -D -I ${VRF} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Enslaved device server\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since there is no server\"\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since global server is out of scope\"\n\t\trun_cmd nettest -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server, VRF client, local connection\"\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -D -I ${VRF} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -s -D -I ${VRF} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, enslaved device client, local connection\"\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -s -D -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Enslaved device server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -s -D -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Enslaved device server, device client, local conn\"\n\n\t# enable global server\n\tlog_subsection \"Global server enabled\"\n\tset_sysctl net.ipv4.udp_l3mdev_accept=1\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -D -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -D -I ${VRF} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Enslaved device server\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd_nsb nettest -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t#\n\t# client tests\n\t#\n\tlog_start\n\trun_cmd_nsb nettest -D -s &\n\tsleep 1\n\trun_cmd nettest -d ${VRF} -D -r ${NSB_IP} -1 ${NSA_IP}\n\tlog_test $? 0 \"VRF client\"\n\n\tlog_start\n\trun_cmd_nsb nettest -D -s &\n\tsleep 1\n\trun_cmd nettest -d ${NSA_DEV} -D -r ${NSB_IP} -1 ${NSA_IP}\n\tlog_test $? 0 \"Enslaved device client\"\n\n\t# negative test - should fail\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused'\"\n\trun_cmd nettest -D -d ${VRF} -r ${NSB_IP}\n\tlog_test $? 1 \"No server, VRF client\"\n\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused'\"\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${NSB_IP}\n\tlog_test $? 1 \"No server, enslaved device client\"\n\n\t#\n\t# local address tests\n\t#\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -D -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -s -D -I ${VRF} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -s -D -I ${VRF} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -s -D -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Enslaved device server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -s -D -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Enslaved device server, device client, local conn\"\n\n\tfor a in ${VRF_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -D -s -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd nettest -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server, VRF client, local conn\"\n\tdone\n\n\tfor a in ${VRF_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s -D -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd nettest -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local conn\"\n\tdone\n\n\t# negative test - should fail\n\t# verifies ECONNREFUSED\n\tfor a in ${NSA_IP} ${VRF_IP} 127.0.0.1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server, VRF client, local conn\"\n\tdone\n}\n\nipv4_udp()\n{\n\tlog_section \"IPv4/UDP\"\n\tlog_subsection \"No VRF\"\n\n\tsetup\n\n\t# udp_l3mdev_accept should have no affect without VRF;\n\t# run tests with it enabled and disabled to verify\n\tlog_subsection \"udp_l3mdev_accept disabled\"\n\tset_sysctl net.ipv4.udp_l3mdev_accept=0\n\tipv4_udp_novrf\n\tlog_subsection \"udp_l3mdev_accept enabled\"\n\tset_sysctl net.ipv4.udp_l3mdev_accept=1\n\tipv4_udp_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tipv4_udp_vrf\n}\n\n################################################################################\n# IPv4 address bind\n#\n# verifies ability or inability to bind to an address / device\n\nipv4_addr_bind_novrf()\n{\n\t#\n\t# raw socket\n\t#\n\tfor a in ${NSA_IP} ${NSA_LO_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s -R -P icmp -l ${a} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address\"\n\n\t\tlog_start\n\t\trun_cmd nettest -s -R -P icmp -l ${a} -I ${NSA_DEV} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address after device bind\"\n\tdone\n\n\t#\n\t# tests for nonlocal bind\n\t#\n\ta=${NL_IP}\n\tlog_start\n\trun_cmd nettest -s -R -f -l ${a} -b\n\tlog_test_addr ${a} $? 0 \"Raw socket bind to nonlocal address\"\n\n\tlog_start\n\trun_cmd nettest -s -f -l ${a} -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to nonlocal address\"\n\n\tlog_start\n\trun_cmd nettest -s -D -P icmp -f -l ${a} -b\n\tlog_test_addr ${a} $? 0 \"ICMP socket bind to nonlocal address\"\n\n\t#\n\t# check that ICMP sockets cannot bind to broadcast and multicast addresses\n\t#\n\ta=${BCAST_IP}\n\tlog_start\n\trun_cmd nettest -s -D -P icmp -l ${a} -b\n\tlog_test_addr ${a} $? 1 \"ICMP socket bind to broadcast address\"\n\n\ta=${MCAST_IP}\n\tlog_start\n\trun_cmd nettest -s -D -P icmp -l ${a} -b\n\tlog_test_addr ${a} $? 1 \"ICMP socket bind to multicast address\"\n\n\t#\n\t# tcp sockets\n\t#\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest -c ${a} -r ${NSB_IP} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address\"\n\n\tlog_start\n\trun_cmd nettest -c ${a} -r ${NSB_IP} -d ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address after device bind\"\n\n\t# Sadly, the kernel allows binding a socket to a device and then\n\t# binding to an address not on the device. The only restriction\n\t# is that the address is valid in the L3 domain. So this test\n\t# passes when it really should not\n\t#a=${NSA_LO_IP}\n\t#log_start\n\t#show_hint \"Should fail with 'Cannot assign requested address'\"\n\t#run_cmd nettest -s -l ${a} -I ${NSA_DEV} -t1 -b\n\t#log_test_addr ${a} $? 1 \"TCP socket bind to out of scope local address\"\n}\n\nipv4_addr_bind_vrf()\n{\n\t#\n\t# raw socket\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Socket not bound to VRF, but address is in VRF\"\n\t\trun_cmd nettest -s -R -P icmp -l ${a} -b\n\t\tlog_test_addr ${a} $? 1 \"Raw socket bind to local address\"\n\n\t\tlog_start\n\t\trun_cmd nettest -s -R -P icmp -l ${a} -I ${NSA_DEV} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address after device bind\"\n\t\tlog_start\n\t\trun_cmd nettest -s -R -P icmp -l ${a} -I ${VRF} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address after VRF bind\"\n\tdone\n\n\ta=${NSA_LO_IP}\n\tlog_start\n\tshow_hint \"Address on loopback is out of VRF scope\"\n\trun_cmd nettest -s -R -P icmp -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 1 \"Raw socket bind to out of scope address after VRF bind\"\n\n\t#\n\t# tests for nonlocal bind\n\t#\n\ta=${NL_IP}\n\tlog_start\n\trun_cmd nettest -s -R -f -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 0 \"Raw socket bind to nonlocal address after VRF bind\"\n\n\tlog_start\n\trun_cmd nettest -s -f -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to nonlocal address after VRF bind\"\n\n\tlog_start\n\trun_cmd nettest -s -D -P icmp -f -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 0 \"ICMP socket bind to nonlocal address after VRF bind\"\n\n\t#\n\t# check that ICMP sockets cannot bind to broadcast and multicast addresses\n\t#\n\ta=${BCAST_IP}\n\tlog_start\n\trun_cmd nettest -s -D -P icmp -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 1 \"ICMP socket bind to broadcast address after VRF bind\"\n\n\ta=${MCAST_IP}\n\tlog_start\n\trun_cmd nettest -s -D -P icmp -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 1 \"ICMP socket bind to multicast address after VRF bind\"\n\n\t#\n\t# tcp sockets\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s -l ${a} -I ${VRF} -t1 -b\n\t\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address\"\n\n\t\tlog_start\n\t\trun_cmd nettest -s -l ${a} -I ${NSA_DEV} -t1 -b\n\t\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address after device bind\"\n\tdone\n\n\ta=${NSA_LO_IP}\n\tlog_start\n\tshow_hint \"Address on loopback out of scope for VRF\"\n\trun_cmd nettest -s -l ${a} -I ${VRF} -t1 -b\n\tlog_test_addr ${a} $? 1 \"TCP socket bind to invalid local address for VRF\"\n\n\tlog_start\n\tshow_hint \"Address on loopback out of scope for device in VRF\"\n\trun_cmd nettest -s -l ${a} -I ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 1 \"TCP socket bind to invalid local address for device bind\"\n}\n\nipv4_addr_bind()\n{\n\tlog_section \"IPv4 address binds\"\n\n\tlog_subsection \"No VRF\"\n\tsetup\n\tset_sysctl net.ipv4.ping_group_range='0 2147483647' 2>/dev/null\n\tipv4_addr_bind_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tset_sysctl net.ipv4.ping_group_range='0 2147483647' 2>/dev/null\n\tipv4_addr_bind_vrf\n}\n\n################################################################################\n# IPv4 runtime tests\n\nipv4_rt()\n{\n\tlocal desc=\"$1\"\n\tlocal varg=\"$2\"\n\tlocal with_vrf=\"yes\"\n\tlocal a\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest ${varg} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, global server\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -s -I ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest ${varg} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, VRF server\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\trun_cmd nettest ${varg} -s -I ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest ${varg} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, enslaved device server\"\n\n\tsetup ${with_vrf}\n\n\t#\n\t# client test\n\t#\n\tlog_start\n\trun_cmd_nsb nettest ${varg} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${VRF} -r ${NSB_IP} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, VRF client\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd_nsb nettest ${varg} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${NSB_IP} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, enslaved device client\"\n\n\tsetup ${with_vrf}\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -s &\n\t\tsleep 1\n\t\trun_cmd nettest ${varg} -d ${VRF} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, global server, VRF client, local\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -I ${VRF} -s &\n\t\tsleep 1\n\t\trun_cmd nettest ${varg} -d ${VRF} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, VRF server and client, local\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\ta=${NSA_IP}\n\tlog_start\n\n\trun_cmd nettest ${varg} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, global server, enslaved device client, local\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd nettest ${varg} -I ${VRF} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, VRF server, enslaved device client, local\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd nettest ${varg} -I ${NSA_DEV} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, enslaved device server and client, local\"\n}\n\nipv4_ping_rt()\n{\n\tlocal with_vrf=\"yes\"\n\tlocal a\n\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb ping -f ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"Device delete with active traffic - ping in\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\ta=${NSB_IP}\n\tlog_start\n\trun_cmd ping -f -I ${VRF} ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"Device delete with active traffic - ping out\"\n}\n\nipv4_runtime()\n{\n\tlog_section \"Run time tests - ipv4\"\n\n\tsetup \"yes\"\n\tipv4_ping_rt\n\n\tsetup \"yes\"\n\tipv4_rt \"TCP active socket\"  \"-n -1\"\n\n\tsetup \"yes\"\n\tipv4_rt \"TCP passive socket\" \"-i\"\n}\n\n################################################################################\n# IPv6\n\nipv6_ping_novrf()\n{\n\tlocal a\n\n\t# should not have an impact, but make a known state\n\tset_sysctl net.ipv4.raw_l3mdev_accept=0 2>/dev/null\n\n\t#\n\t# out\n\t#\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV} ${MCAST}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, device bind\"\n\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 -I ${NSA_LO_IP6} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, loopback address bind\"\n\tdone\n\n\t#\n\t# in\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ${NSA_LINKIP6}%${NSB_DEV} ${MCAST}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping in\"\n\tdone\n\n\t#\n\t# local traffic, local address\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ::1 ${NSA_LINKIP6}%${NSA_DEV} ${MCAST}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping local, no bind\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}%${NSA_DEV} ${MCAST}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping local, device bind\"\n\tdone\n\n\tfor a in ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Fails since address on loopback is out of device scope\"\n\t\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 2 \"ping local, device bind\"\n\tdone\n\n\t#\n\t# ip rule blocks address\n\t#\n\tlog_start\n\tsetup_cmd ip -6 rule add pref 32765 from all lookup local\n\tsetup_cmd ip -6 rule del pref 0 from all lookup local\n\tsetup_cmd ip -6 rule add pref 50 to ${NSB_LO_IP6} prohibit\n\tsetup_cmd ip -6 rule add pref 51 from ${NSB_IP6} prohibit\n\n\ta=${NSB_LO_IP6}\n\trun_cmd ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, blocked by rule\"\n\n\tlog_start\n\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, blocked by rule\"\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Response lost due to ip rule\"\n\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, blocked by rule\"\n\n\tsetup_cmd ip -6 rule add pref 0 from all lookup local\n\tsetup_cmd ip -6 rule del pref 32765 from all lookup local\n\tsetup_cmd ip -6 rule del pref 50 to ${NSB_LO_IP6} prohibit\n\tsetup_cmd ip -6 rule del pref 51 from ${NSB_IP6} prohibit\n\n\t#\n\t# route blocks reachability to remote address\n\t#\n\tlog_start\n\tsetup_cmd ip -6 route del ${NSB_LO_IP6}\n\tsetup_cmd ip -6 route add unreachable ${NSB_LO_IP6} metric 10\n\tsetup_cmd ip -6 route add unreachable ${NSB_IP6} metric 10\n\n\ta=${NSB_LO_IP6}\n\trun_cmd ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, blocked by route\"\n\n\tlog_start\n\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, blocked by route\"\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Response lost due to ip route\"\n\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, blocked by route\"\n\n\n\t#\n\t# remove 'remote' routes; fallback to default\n\t#\n\tlog_start\n\tsetup_cmd ip -6 ro del unreachable ${NSB_LO_IP6}\n\tsetup_cmd ip -6 ro del unreachable ${NSB_IP6}\n\n\ta=${NSB_LO_IP6}\n\trun_cmd ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, unreachable route\"\n\n\tlog_start\n\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, unreachable route\"\n}\n\nipv6_ping_vrf()\n{\n\tlocal a\n\n\t# should default on; does not exist on older kernels\n\tset_sysctl net.ipv4.raw_l3mdev_accept=1 2>/dev/null\n\n\t#\n\t# out\n\t#\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 -I ${VRF} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, VRF bind\"\n\tdone\n\n\tfor a in ${NSB_LINKIP6}%${VRF} ${MCAST}%${VRF}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Fails since VRF device does not support linklocal or multicast\"\n\t\trun_cmd ${ping6} -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 1 \"ping out, VRF bind\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV} ${MCAST}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, device bind\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd ip vrf exec ${VRF} ${ping6} -c1 -w1 -I ${VRF_IP6} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping out, vrf device+address bind\"\n\tdone\n\n\t#\n\t# in\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6} ${NSA_LINKIP6}%${NSB_DEV} ${MCAST}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping in\"\n\tdone\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Fails since loopback address is out of VRF scope\"\n\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in\"\n\n\t#\n\t# local traffic, local address\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6} ::1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Source address should be ${a}\"\n\t\trun_cmd ${ping6} -c1 -w1 -I ${VRF} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping local, VRF bind\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}%${NSA_DEV} ${MCAST}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\t\tlog_test_addr ${a} $? 0 \"ping local, device bind\"\n\tdone\n\n\t# LLA to GUA - remove ipv6 global addresses from ns-B\n\tsetup_cmd_nsb ip -6 addr del ${NSB_IP6}/64 dev ${NSB_DEV}\n\tsetup_cmd_nsb ip -6 addr del ${NSB_LO_IP6}/128 dev lo\n\tsetup_cmd_nsb ip -6 ro add ${NSA_IP6}/128 via ${NSA_LINKIP6} dev ${NSB_DEV}\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb ${ping6} -c1 -w1 ${NSA_IP6}\n\t\tlog_test_addr ${a} $? 0 \"ping in, LLA to GUA\"\n\tdone\n\n\tsetup_cmd_nsb ip -6 ro del ${NSA_IP6}/128 via ${NSA_LINKIP6} dev ${NSB_DEV}\n\tsetup_cmd_nsb ip -6 addr add ${NSB_IP6}/64 dev ${NSB_DEV}\n\tsetup_cmd_nsb ip -6 addr add ${NSB_LO_IP6}/128 dev lo\n\n\t#\n\t# ip rule blocks address\n\t#\n\tlog_start\n\tsetup_cmd ip -6 rule add pref 50 to ${NSB_LO_IP6} prohibit\n\tsetup_cmd ip -6 rule add pref 51 from ${NSB_IP6} prohibit\n\n\ta=${NSB_LO_IP6}\n\trun_cmd ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, blocked by rule\"\n\n\tlog_start\n\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, blocked by rule\"\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Response lost due to ip rule\"\n\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 1 \"ping in, blocked by rule\"\n\n\tlog_start\n\tsetup_cmd ip -6 rule del pref 50 to ${NSB_LO_IP6} prohibit\n\tsetup_cmd ip -6 rule del pref 51 from ${NSB_IP6} prohibit\n\n\t#\n\t# remove 'remote' routes; fallback to default\n\t#\n\tlog_start\n\tsetup_cmd ip -6 ro del ${NSB_LO_IP6} vrf ${VRF}\n\n\ta=${NSB_LO_IP6}\n\trun_cmd ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, unreachable route\"\n\n\tlog_start\n\trun_cmd ${ping6} -c1 -w1 -I ${NSA_DEV} ${a}\n\tlog_test_addr ${a} $? 2 \"ping out, device bind, unreachable route\"\n\n\tip -netns ${NSB} -6 ro del ${NSA_LO_IP6}\n\ta=${NSA_LO_IP6}\n\tlog_start\n\trun_cmd_nsb ${ping6} -c1 -w1 ${a}\n\tlog_test_addr ${a} $? 2 \"ping in, unreachable route\"\n}\n\nipv6_ping()\n{\n\tlog_section \"IPv6 ping\"\n\n\tlog_subsection \"No VRF\"\n\tsetup\n\tipv6_ping_novrf\n\tsetup\n\tset_sysctl net.ipv4.ping_group_range='0 2147483647' 2>/dev/null\n\tipv6_ping_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tipv6_ping_vrf\n\tsetup \"yes\"\n\tset_sysctl net.ipv4.ping_group_range='0 2147483647' 2>/dev/null\n\tipv6_ping_vrf\n}\n\n################################################################################\n# IPv6 TCP\n\n#\n# MD5 tests without VRF\n#\nipv6_tcp_md5_novrf()\n{\n\t#\n\t# single address\n\t#\n\n\t# basic use case\n\tlog_start\n\trun_cmd nettest -6 -s -M ${MD5_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: Single address config\"\n\n\t# client sends MD5, server not configured\n\tlog_start\n\tshow_hint \"Should timeout due to MD5 mismatch\"\n\trun_cmd nettest -6 -s &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: Server no config, client uses password\"\n\n\t# wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -6 -s -M ${MD5_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: Client uses wrong password\"\n\n\t# client from different address\n\tlog_start\n\tshow_hint \"Should timeout due to MD5 mismatch\"\n\trun_cmd nettest -6 -s -M ${MD5_PW} -m ${NSB_LO_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: Client address does not match address configured with password\"\n\n\t#\n\t# MD5 extension - prefix length\n\t#\n\n\t# client in prefix\n\tlog_start\n\trun_cmd nettest -6 -s -M ${MD5_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: Prefix config\"\n\n\t# client in prefix, wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -6 -s -M ${MD5_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: Prefix config, client uses wrong password\"\n\n\t# client outside of prefix\n\tlog_start\n\tshow_hint \"Should timeout due to MD5 mismatch\"\n\trun_cmd nettest -6 -s -M ${MD5_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -c ${NSB_LO_IP6} -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: Prefix config, client address not in configured prefix\"\n}\n\n#\n# MD5 tests with VRF\n#\nipv6_tcp_md5()\n{\n\t#\n\t# single address\n\t#\n\n\t# basic use case\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Single address config\"\n\n\t# client sends MD5, server not configured\n\tlog_start\n\tshow_hint \"Should timeout since server does not have MD5 auth\"\n\trun_cmd nettest -6 -s -I ${VRF} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Server no config, client uses password\"\n\n\t# wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Client uses wrong password\"\n\n\t# client from different address\n\tlog_start\n\tshow_hint \"Should timeout since server config differs from client\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_LO_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Client address does not match address configured with password\"\n\n\t#\n\t# MD5 extension - prefix length\n\t#\n\n\t# client in prefix\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Prefix config\"\n\n\t# client in prefix, wrong password\n\tlog_start\n\tshow_hint \"Should timeout since client uses wrong password\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config, client uses wrong password\"\n\n\t# client outside of prefix\n\tlog_start\n\tshow_hint \"Should timeout since client address is outside of prefix\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -c ${NSB_LO_IP6} -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config, client address not in configured prefix\"\n\n\t#\n\t# duplicate config between default VRF and a VRF\n\t#\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Single address config in default VRF and VRF, conn in VRF\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsc nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 0 \"MD5: VRF: Single address config in default VRF and VRF, conn in default VRF\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in default VRF uses VRF password\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsc nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Single address config in default VRF and VRF, conn in default VRF with VRF pw\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in VRF uses default VRF password\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NSB_IP6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NSB_IP6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Single address config in default VRF and VRF, conn in VRF with default VRF pw\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 0 \"MD5: VRF: Prefix config in default VRF and VRF, conn in VRF\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsc nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 0 \"MD5: VRF: Prefix config in default VRF and VRF, conn in default VRF\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in default VRF uses VRF password\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsc nettest -6 -r ${NSA_IP6} -X ${MD5_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config in default VRF and VRF, conn in default VRF with VRF pw\"\n\n\tlog_start\n\tshow_hint \"Should timeout since client in VRF uses default VRF password\"\n\trun_cmd nettest -6 -s -I ${VRF} -M ${MD5_PW} -m ${NS_NET6} &\n\trun_cmd nettest -6 -s -M ${MD5_WRONG_PW} -m ${NS_NET6} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${NSA_IP6} -X ${MD5_WRONG_PW}\n\tlog_test $? 2 \"MD5: VRF: Prefix config in default VRF and VRF, conn in VRF with default VRF pw\"\n\n\t#\n\t# negative tests\n\t#\n\tlog_start\n\trun_cmd nettest -6 -s -I ${NSA_DEV} -M ${MD5_PW} -m ${NSB_IP6}\n\tlog_test $? 1 \"MD5: VRF: Device must be a VRF - single address\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${NSA_DEV} -M ${MD5_PW} -m ${NS_NET6}\n\tlog_test $? 1 \"MD5: VRF: Device must be a VRF - prefix\"\n\n}\n\nipv6_tcp_novrf()\n{\n\tlocal a\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\tdone\n\n\t# verify TCP reset received\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t#\n\t# client\n\t#\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Client\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client\"\n\tdone\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server, local connection\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, unbound client, local connection\"\n\n\tfor a in ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -6 -s -I ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Device server, unbound client, local connection\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device client, local connection\"\n\n\tfor a in ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client, local connection\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd nettest -6  -d ${NSA_DEV} -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Device server, device client, local conn\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -6 -d ${NSA_DEV} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client, local conn\"\n\tdone\n\n\t[ \"$fips_enabled\" = \"1\" ] || ipv6_tcp_md5_novrf\n}\n\nipv6_tcp_vrf()\n{\n\tlocal a\n\n\t# disable global server\n\tlog_subsection \"Global server disabled\"\n\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=0\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since global server with VRF is disabled\"\n\t\trun_cmd nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\tdone\n\n\t# link local is always bound to ingress device\n\ta=${NSA_LINKIP6}%${NSB_DEV}\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server\"\n\n\tfor a in ${NSA_IP6} ${VRF_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Device server\"\n\tdone\n\n\t# verify TCP reset received\n\tfor a in ${NSA_IP6} ${VRF_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t# local address tests\n\ta=${NSA_IP6}\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused' since global server with VRF is disabled\"\n\trun_cmd nettest -6 -s &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV}\n\tlog_test_addr ${a} $? 1 \"Global server, local connection\"\n\n\t# run MD5 tests\n\tif [ \"$fips_enabled\" = \"0\" ]; then\n\t\tsetup_vrf_dup\n\t\tipv6_tcp_md5\n\t\tcleanup_vrf_dup\n\tfi\n\n\t#\n\t# enable VRF global server\n\t#\n\tlog_subsection \"VRF Global server enabled\"\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=1\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\tdone\n\n\t# For LLA, child socket is bound to device\n\ta=${NSA_LINKIP6}%${NSB_DEV}\n\tlog_start\n\trun_cmd nettest -6 -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server\"\n\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Device server\"\n\tdone\n\n\t# verify TCP reset received\n\tfor a in ${NSA_IP6} ${VRF_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t# local address tests\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Fails 'Connection refused' since client is not in VRF\"\n\t\trun_cmd nettest -6 -s -I ${VRF} &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server, local connection\"\n\tdone\n\n\n\t#\n\t# client\n\t#\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a} -d ${VRF}\n\t\tlog_test_addr ${a} $? 0 \"Client, VRF bind\"\n\tdone\n\n\ta=${NSB_LINKIP6}\n\tlog_start\n\tshow_hint \"Fails since VRF device does not allow linklocal addresses\"\n\trun_cmd_nsb nettest -6 -s &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a} -d ${VRF}\n\tlog_test_addr ${a} $? 1 \"Client, VRF bind\"\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -6 -r ${a} -d ${VRF}\n\t\tlog_test_addr ${a} $? 1 \"No server, VRF client\"\n\tdone\n\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6} ::1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${VRF} -3 ${VRF} &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a} -d ${VRF} -0 ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local connection\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -I ${VRF} -3 ${VRF} &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, device client, local connection\"\n\n\ta=${NSA_IP6}\n\tlog_start\n\tshow_hint \"Should fail since unbound client is out of VRF scope\"\n\trun_cmd nettest -6 -s -I ${VRF} &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a}\n\tlog_test_addr ${a} $? 1 \"VRF server, unbound client, local connection\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -r ${a} -d ${VRF} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, VRF client, local connection\"\n\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -r ${a} -d ${NSA_DEV} -0 ${a}\n\t\tlog_test_addr ${a} $? 0 \"Device server, device client, local connection\"\n\tdone\n}\n\nipv6_tcp()\n{\n\tlog_section \"IPv6/TCP\"\n\tlog_subsection \"No VRF\"\n\tsetup\n\n\t# tcp_l3mdev_accept should have no affect without VRF;\n\t# run tests with it enabled and disabled to verify\n\tlog_subsection \"tcp_l3mdev_accept disabled\"\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=0\n\tipv6_tcp_novrf\n\tlog_subsection \"tcp_l3mdev_accept enabled\"\n\tset_sysctl net.ipv4.tcp_l3mdev_accept=1\n\tipv6_tcp_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tipv6_tcp_vrf\n}\n\n################################################################################\n# IPv6 UDP\n\nipv6_udp_novrf()\n{\n\tlocal a\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Device server\"\n\tdone\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\trun_cmd nettest -6 -D -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -D -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server\"\n\n\t# should fail since loopback address is out of scope for a device\n\t# bound server, but it does not - hence this is more documenting\n\t# behavior.\n\t#log_start\n\t#show_hint \"Should fail since loopback address is out of scope\"\n\t#run_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\t#sleep 1\n\t#run_cmd_nsb nettest -6 -D -r ${a}\n\t#log_test_addr ${a} $? 1 \"Device server\"\n\n\t# negative test - should fail\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ${NSA_LINKIP6}%${NSB_DEV}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since there is no server\"\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t#\n\t# client\n\t#\n\tfor a in ${NSB_IP6} ${NSB_LO_IP6} ${NSB_LINKIP6}%${NSA_DEV}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -0 ${NSA_IP6}\n\t\tlog_test_addr ${a} $? 0 \"Client\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV} -0 ${NSA_IP6}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV} -C -0 ${NSA_IP6}\n\t\tlog_test_addr ${a} $? 0 \"Client, device send via cmsg\"\n\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV} -S -0 ${NSA_IP6}\n\t\tlog_test_addr ${a} $? 0 \"Client, device bind via IPV6_UNICAST_IF\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server, unbound client\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused'\"\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"No server, device client\"\n\tdone\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -0 ${a} -1 ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server, local connection\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -D -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, unbound client, local connection\"\n\n\tfor a in ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since address is out of device scope\"\n\t\trun_cmd nettest -6 -s -D -I ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Device server, local connection\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -D &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device client, local connection\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -D &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -C -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device send via cmsg, local connection\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -D &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -S -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device client via IPV6_UNICAST_IF, local connection\"\n\n\tfor a in ${NSA_LO_IP6} ::1\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'No route to host' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV}\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client, local connection\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'No route to host' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV} -C\n\t\tlog_test_addr ${a} $? 1 \"Global server, device send via cmsg, local connection\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'No route to host' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV} -S\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client via IP_UNICAST_IF, local connection\"\n\n\t\tlog_start\n\t\tshow_hint \"Should fail 'No route to host' since addresses on loopback are out of device scope\"\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -r ${a} -d ${NSA_DEV} -S -U\n\t\tlog_test_addr ${a} $? 1 \"Global server, device client via IP_UNICAST_IF, local connection, with connect()\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -D -s -I ${NSA_DEV} -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a} -0 ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, device client, local conn\"\n\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused'\"\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 1 \"No server, device client, local conn\"\n\n\t# LLA to GUA\n\trun_cmd_nsb ip -6 addr del ${NSB_IP6}/64 dev ${NSB_DEV}\n\trun_cmd_nsb ip -6 ro add ${NSA_IP6}/128 dev ${NSB_DEV}\n\tlog_start\n\trun_cmd nettest -6 -s -D &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -D -r ${NSA_IP6}\n\tlog_test $? 0 \"UDP in - LLA to GUA\"\n\n\trun_cmd_nsb ip -6 ro del ${NSA_IP6}/128 dev ${NSB_DEV}\n\trun_cmd_nsb ip -6 addr add ${NSB_IP6}/64 dev ${NSB_DEV} nodad\n}\n\nipv6_udp_vrf()\n{\n\tlocal a\n\n\t# disable global server\n\tlog_subsection \"Global server disabled\"\n\tset_sysctl net.ipv4.udp_l3mdev_accept=0\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since global server is disabled\"\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -I ${VRF} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Enslaved device server\"\n\tdone\n\n\t# negative test - should fail\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since there is no server\"\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\tshow_hint \"Should fail 'Connection refused' since global server is disabled\"\n\t\trun_cmd nettest -6 -D -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server, VRF client, local conn\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -I ${VRF} -s &\n\t\tsleep 1\n\t\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local conn\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\tshow_hint \"Should fail 'Connection refused' since global server is disabled\"\n\trun_cmd nettest -6 -D -s &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 1 \"Global server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${VRF} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Enslaved device server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Enslaved device server, device client, local conn\"\n\n\t# disable global server\n\tlog_subsection \"Global server enabled\"\n\tset_sysctl net.ipv4.udp_l3mdev_accept=1\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Global server\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -I ${VRF} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"VRF server\"\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 0 \"Enslaved device server\"\n\tdone\n\n\t# negative test - should fail\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd_nsb nettest -6 -D -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server\"\n\tdone\n\n\t#\n\t# client tests\n\t#\n\tlog_start\n\trun_cmd_nsb nettest -6 -D -s &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${NSB_IP6}\n\tlog_test $? 0 \"VRF client\"\n\n\t# negative test - should fail\n\tlog_start\n\trun_cmd nettest -6 -D -d ${VRF} -r ${NSB_IP6}\n\tlog_test $? 1 \"No server, VRF client\"\n\n\tlog_start\n\trun_cmd_nsb nettest -6 -D -s &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${NSB_IP6}\n\tlog_test $? 0 \"Enslaved device client\"\n\n\t# negative test - should fail\n\tlog_start\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${NSB_IP6}\n\tlog_test $? 1 \"No server, enslaved device client\"\n\n\t#\n\t# local address tests\n\t#\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -D -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, VRF client, local conn\"\n\n\t#log_start\n\trun_cmd nettest -6 -D -I ${VRF} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local conn\"\n\n\n\ta=${VRF_IP6}\n\tlog_start\n\trun_cmd nettest -6 -D -s -3 ${VRF} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${VRF} -s -3 ${VRF} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, VRF client, local conn\"\n\n\t# negative test - should fail\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"No server, VRF client, local conn\"\n\tdone\n\n\t# device to global IP\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -D -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Global server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${VRF} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"VRF server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${VRF} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, VRF client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -I ${NSA_DEV} -s -3 ${NSA_DEV} &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 0 \"Device server, device client, local conn\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${a}\n\tlog_test_addr ${a} $? 1 \"No server, device client, local conn\"\n\n\n\t# link local addresses\n\tlog_start\n\trun_cmd nettest -6 -D -s &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -D -d ${NSB_DEV} -r ${NSA_LINKIP6}\n\tlog_test $? 0 \"Global server, linklocal IP\"\n\n\tlog_start\n\trun_cmd_nsb nettest -6 -D -d ${NSB_DEV} -r ${NSA_LINKIP6}\n\tlog_test $? 1 \"No server, linklocal IP\"\n\n\n\tlog_start\n\trun_cmd_nsb nettest -6 -D -s &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${NSB_LINKIP6}\n\tlog_test $? 0 \"Enslaved device client, linklocal IP\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${NSB_LINKIP6}\n\tlog_test $? 1 \"No server, device client, peer linklocal IP\"\n\n\n\tlog_start\n\trun_cmd nettest -6 -D -s &\n\tsleep 1\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${NSA_LINKIP6}\n\tlog_test $? 0 \"Enslaved device client, local conn - linklocal IP\"\n\n\tlog_start\n\trun_cmd nettest -6 -D -d ${NSA_DEV} -r ${NSA_LINKIP6}\n\tlog_test $? 1 \"No server, device client, local conn  - linklocal IP\"\n\n\t# LLA to GUA\n\trun_cmd_nsb ip -6 addr del ${NSB_IP6}/64 dev ${NSB_DEV}\n\trun_cmd_nsb ip -6 ro add ${NSA_IP6}/128 dev ${NSB_DEV}\n\tlog_start\n\trun_cmd nettest -6 -s -D &\n\tsleep 1\n\trun_cmd_nsb nettest -6 -D -r ${NSA_IP6}\n\tlog_test $? 0 \"UDP in - LLA to GUA\"\n\n\trun_cmd_nsb ip -6 ro del ${NSA_IP6}/128 dev ${NSB_DEV}\n\trun_cmd_nsb ip -6 addr add ${NSB_IP6}/64 dev ${NSB_DEV} nodad\n}\n\nipv6_udp()\n{\n        # should not matter, but set to known state\n        set_sysctl net.ipv4.udp_early_demux=1\n\n        log_section \"IPv6/UDP\"\n        log_subsection \"No VRF\"\n        setup\n\n        # udp_l3mdev_accept should have no affect without VRF;\n        # run tests with it enabled and disabled to verify\n        log_subsection \"udp_l3mdev_accept disabled\"\n        set_sysctl net.ipv4.udp_l3mdev_accept=0\n        ipv6_udp_novrf\n        log_subsection \"udp_l3mdev_accept enabled\"\n        set_sysctl net.ipv4.udp_l3mdev_accept=1\n        ipv6_udp_novrf\n\n        log_subsection \"With VRF\"\n        setup \"yes\"\n        ipv6_udp_vrf\n}\n\n################################################################################\n# IPv6 address bind\n\nipv6_addr_bind_novrf()\n{\n\t#\n\t# raw socket\n\t#\n\tfor a in ${NSA_IP6} ${NSA_LO_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -R -P ipv6-icmp -l ${a} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address\"\n\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -R -P ipv6-icmp -l ${a} -I ${NSA_DEV} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address after device bind\"\n\tdone\n\n\t#\n\t# raw socket with nonlocal bind\n\t#\n\ta=${NL_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -R -P icmp -f -l ${a} -I ${NSA_DEV} -b\n\tlog_test_addr ${a} $? 0 \"Raw socket bind to nonlocal address\"\n\n\t#\n\t# tcp sockets\n\t#\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -l ${a} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address\"\n\n\tlog_start\n\trun_cmd nettest -6 -s -l ${a} -I ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address after device bind\"\n\n\t# Sadly, the kernel allows binding a socket to a device and then\n\t# binding to an address not on the device. So this test passes\n\t# when it really should not\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Tecnically should fail since address is not on device but kernel allows\"\n\trun_cmd nettest -6 -s -l ${a} -I ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to out of scope local address\"\n}\n\nipv6_addr_bind_vrf()\n{\n\t#\n\t# raw socket\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -R -P ipv6-icmp -l ${a} -I ${VRF} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address after vrf bind\"\n\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -R -P ipv6-icmp -l ${a} -I ${NSA_DEV} -b\n\t\tlog_test_addr ${a} $? 0 \"Raw socket bind to local address after device bind\"\n\tdone\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Address on loopback is out of VRF scope\"\n\trun_cmd nettest -6 -s -R -P ipv6-icmp -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 1 \"Raw socket bind to invalid local address after vrf bind\"\n\n\t#\n\t# raw socket with nonlocal bind\n\t#\n\ta=${NL_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -R -P icmp -f -l ${a} -I ${VRF} -b\n\tlog_test_addr ${a} $? 0 \"Raw socket bind to nonlocal address after VRF bind\"\n\n\t#\n\t# tcp sockets\n\t#\n\t# address on enslaved device is valid for the VRF or device in a VRF\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s -l ${a} -I ${VRF} -t1 -b\n\t\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address with VRF bind\"\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest -6 -s -l ${a} -I ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to local address with device bind\"\n\n\t# Sadly, the kernel allows binding a socket to a device and then\n\t# binding to an address not on the device. The only restriction\n\t# is that the address is valid in the L3 domain. So this test\n\t# passes when it really should not\n\ta=${VRF_IP6}\n\tlog_start\n\tshow_hint \"Tecnically should fail since address is not on device but kernel allows\"\n\trun_cmd nettest -6 -s -l ${a} -I ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 0 \"TCP socket bind to VRF address with device bind\"\n\n\ta=${NSA_LO_IP6}\n\tlog_start\n\tshow_hint \"Address on loopback out of scope for VRF\"\n\trun_cmd nettest -6 -s -l ${a} -I ${VRF} -t1 -b\n\tlog_test_addr ${a} $? 1 \"TCP socket bind to invalid local address for VRF\"\n\n\tlog_start\n\tshow_hint \"Address on loopback out of scope for device in VRF\"\n\trun_cmd nettest -6 -s -l ${a} -I ${NSA_DEV} -t1 -b\n\tlog_test_addr ${a} $? 1 \"TCP socket bind to invalid local address for device bind\"\n\n}\n\nipv6_addr_bind()\n{\n\tlog_section \"IPv6 address binds\"\n\n\tlog_subsection \"No VRF\"\n\tsetup\n\tipv6_addr_bind_novrf\n\n\tlog_subsection \"With VRF\"\n\tsetup \"yes\"\n\tipv6_addr_bind_vrf\n}\n\n################################################################################\n# IPv6 runtime tests\n\nipv6_rt()\n{\n\tlocal desc=\"$1\"\n\tlocal varg=\"-6 $2\"\n\tlocal with_vrf=\"yes\"\n\tlocal a\n\n\t#\n\t# server tests\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest ${varg} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, global server\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -I ${VRF} -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest ${varg} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, VRF server\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -I ${NSA_DEV} -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest ${varg} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, enslaved device server\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\t#\n\t# client test\n\t#\n\tlog_start\n\trun_cmd_nsb nettest ${varg} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${VRF} -r ${NSB_IP6} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test  0 0 \"${desc}, VRF client\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd_nsb nettest ${varg} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${NSB_IP6} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test  0 0 \"${desc}, enslaved device client\"\n\n\tsetup ${with_vrf}\n\n\n\t#\n\t# local address tests\n\t#\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -s &\n\t\tsleep 1\n\t\trun_cmd nettest ${varg} -d ${VRF} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, global server, VRF client\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${varg} -I ${VRF} -s &\n\t\tsleep 1\n\t\trun_cmd nettest ${varg} -d ${VRF} -r ${a} &\n\t\tsleep 3\n\t\trun_cmd ip link del ${VRF}\n\t\tsleep 1\n\t\tlog_test_addr ${a} 0 0 \"${desc}, VRF server and client\"\n\n\t\tsetup ${with_vrf}\n\tdone\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd nettest ${varg} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, global server, device client\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd nettest ${varg} -I ${VRF} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, VRF server, device client\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd nettest ${varg} -I ${NSA_DEV} -s &\n\tsleep 1\n\trun_cmd nettest ${varg} -d ${NSA_DEV} -r ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"${desc}, device server, device client\"\n}\n\nipv6_ping_rt()\n{\n\tlocal with_vrf=\"yes\"\n\tlocal a\n\n\ta=${NSA_IP6}\n\tlog_start\n\trun_cmd_nsb ${ping6} -f ${a} &\n\tsleep 3\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"Device delete with active traffic - ping in\"\n\n\tsetup ${with_vrf}\n\n\tlog_start\n\trun_cmd ${ping6} -f ${NSB_IP6} -I ${VRF} &\n\tsleep 1\n\trun_cmd ip link del ${VRF}\n\tsleep 1\n\tlog_test_addr ${a} 0 0 \"Device delete with active traffic - ping out\"\n}\n\nipv6_runtime()\n{\n\tlog_section \"Run time tests - ipv6\"\n\n\tsetup \"yes\"\n\tipv6_ping_rt\n\n\tsetup \"yes\"\n\tipv6_rt \"TCP active socket\"  \"-n -1\"\n\n\tsetup \"yes\"\n\tipv6_rt \"TCP passive socket\" \"-i\"\n\n\tsetup \"yes\"\n\tipv6_rt \"UDP active socket\"  \"-D -n -1\"\n}\n\n################################################################################\n# netfilter blocking connections\n\nnetfilter_tcp_reset()\n{\n\tlocal a\n\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server, reject with TCP-reset on Rx\"\n\tdone\n}\n\nnetfilter_icmp()\n{\n\tlocal stype=\"$1\"\n\tlocal arg\n\tlocal a\n\n\t[ \"${stype}\" = \"UDP\" ] && arg=\"-D\"\n\n\tfor a in ${NSA_IP} ${VRF_IP}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest ${arg} -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest ${arg} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global ${stype} server, Rx reject icmp-port-unreach\"\n\tdone\n}\n\nipv4_netfilter()\n{\n\tlog_section \"IPv4 Netfilter\"\n\tlog_subsection \"TCP reset\"\n\n\tsetup \"yes\"\n\trun_cmd iptables -A INPUT -p tcp --dport 12345 -j REJECT --reject-with tcp-reset\n\n\tnetfilter_tcp_reset\n\n\tlog_start\n\tlog_subsection \"ICMP unreachable\"\n\n\tlog_start\n\trun_cmd iptables -F\n\trun_cmd iptables -A INPUT -p tcp --dport 12345 -j REJECT --reject-with icmp-port-unreachable\n\trun_cmd iptables -A INPUT -p udp --dport 12345 -j REJECT --reject-with icmp-port-unreachable\n\n\tnetfilter_icmp \"TCP\"\n\tnetfilter_icmp \"UDP\"\n\n\tlog_start\n\tiptables -F\n}\n\nnetfilter_tcp6_reset()\n{\n\tlocal a\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global server, reject with TCP-reset on Rx\"\n\tdone\n}\n\nnetfilter_icmp6()\n{\n\tlocal stype=\"$1\"\n\tlocal arg\n\tlocal a\n\n\t[ \"${stype}\" = \"UDP\" ] && arg=\"$arg -D\"\n\n\tfor a in ${NSA_IP6} ${VRF_IP6}\n\tdo\n\t\tlog_start\n\t\trun_cmd nettest -6 -s ${arg} &\n\t\tsleep 1\n\t\trun_cmd_nsb nettest -6 ${arg} -r ${a}\n\t\tlog_test_addr ${a} $? 1 \"Global ${stype} server, Rx reject icmp-port-unreach\"\n\tdone\n}\n\nipv6_netfilter()\n{\n\tlog_section \"IPv6 Netfilter\"\n\tlog_subsection \"TCP reset\"\n\n\tsetup \"yes\"\n\trun_cmd ip6tables -A INPUT -p tcp --dport 12345 -j REJECT --reject-with tcp-reset\n\n\tnetfilter_tcp6_reset\n\n\tlog_subsection \"ICMP unreachable\"\n\n\tlog_start\n\trun_cmd ip6tables -F\n\trun_cmd ip6tables -A INPUT -p tcp --dport 12345 -j REJECT --reject-with icmp6-port-unreachable\n\trun_cmd ip6tables -A INPUT -p udp --dport 12345 -j REJECT --reject-with icmp6-port-unreachable\n\n\tnetfilter_icmp6 \"TCP\"\n\tnetfilter_icmp6 \"UDP\"\n\n\tlog_start\n\tip6tables -F\n}\n\n################################################################################\n# specific use cases\n\n# VRF only.\n# ns-A device enslaved to bridge. Verify traffic with and without\n# br_netfilter module loaded. Repeat with SVI on bridge.\nuse_case_br()\n{\n\tsetup \"yes\"\n\n\tsetup_cmd ip link set ${NSA_DEV} down\n\tsetup_cmd ip addr del dev ${NSA_DEV} ${NSA_IP}/24\n\tsetup_cmd ip -6 addr del dev ${NSA_DEV} ${NSA_IP6}/64\n\n\tsetup_cmd ip link add br0 type bridge\n\tsetup_cmd ip addr add dev br0 ${NSA_IP}/24\n\tsetup_cmd ip -6 addr add dev br0 ${NSA_IP6}/64 nodad\n\n\tsetup_cmd ip li set ${NSA_DEV} master br0\n\tsetup_cmd ip li set ${NSA_DEV} up\n\tsetup_cmd ip li set br0 up\n\tsetup_cmd ip li set br0 vrf ${VRF}\n\n\trmmod br_netfilter 2>/dev/null\n\tsleep 5 # DAD\n\n\trun_cmd ip neigh flush all\n\trun_cmd ping -c1 -w1 -I br0 ${NSB_IP}\n\tlog_test $? 0 \"Bridge into VRF - IPv4 ping out\"\n\n\trun_cmd ip neigh flush all\n\trun_cmd ${ping6} -c1 -w1 -I br0 ${NSB_IP6}\n\tlog_test $? 0 \"Bridge into VRF - IPv6 ping out\"\n\n\trun_cmd ip neigh flush all\n\trun_cmd_nsb ping -c1 -w1 ${NSA_IP}\n\tlog_test $? 0 \"Bridge into VRF - IPv4 ping in\"\n\n\trun_cmd ip neigh flush all\n\trun_cmd_nsb ${ping6} -c1 -w1 ${NSA_IP6}\n\tlog_test $? 0 \"Bridge into VRF - IPv6 ping in\"\n\n\tmodprobe br_netfilter\n\tif [ $? -eq 0 ]; then\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd ping -c1 -w1 -I br0 ${NSB_IP}\n\t\tlog_test $? 0 \"Bridge into VRF with br_netfilter - IPv4 ping out\"\n\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd ${ping6} -c1 -w1 -I br0 ${NSB_IP6}\n\t\tlog_test $? 0 \"Bridge into VRF with br_netfilter - IPv6 ping out\"\n\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd_nsb ping -c1 -w1 ${NSA_IP}\n\t\tlog_test $? 0 \"Bridge into VRF with br_netfilter - IPv4 ping in\"\n\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd_nsb ${ping6} -c1 -w1 ${NSA_IP6}\n\t\tlog_test $? 0 \"Bridge into VRF with br_netfilter - IPv6 ping in\"\n\tfi\n\n\tsetup_cmd ip li set br0 nomaster\n\tsetup_cmd ip li add br0.100 link br0 type vlan id 100\n\tsetup_cmd ip li set br0.100 vrf ${VRF} up\n\tsetup_cmd ip    addr add dev br0.100 172.16.101.1/24\n\tsetup_cmd ip -6 addr add dev br0.100 2001:db8:101::1/64 nodad\n\n\tsetup_cmd_nsb ip li add vlan100 link ${NSB_DEV} type vlan id 100\n\tsetup_cmd_nsb ip addr add dev vlan100 172.16.101.2/24\n\tsetup_cmd_nsb ip -6 addr add dev vlan100 2001:db8:101::2/64 nodad\n\tsetup_cmd_nsb ip li set vlan100 up\n\tsleep 1\n\n\trmmod br_netfilter 2>/dev/null\n\n\trun_cmd ip neigh flush all\n\trun_cmd ping -c1 -w1 -I br0.100 172.16.101.2\n\tlog_test $? 0 \"Bridge vlan into VRF - IPv4 ping out\"\n\n\trun_cmd ip neigh flush all\n\trun_cmd ${ping6} -c1 -w1 -I br0.100 2001:db8:101::2\n\tlog_test $? 0 \"Bridge vlan into VRF - IPv6 ping out\"\n\n\trun_cmd ip neigh flush all\n\trun_cmd_nsb ping -c1 -w1 172.16.101.1\n\tlog_test $? 0 \"Bridge vlan into VRF - IPv4 ping in\"\n\n\trun_cmd ip neigh flush all\n\trun_cmd_nsb ${ping6} -c1 -w1 2001:db8:101::1\n\tlog_test $? 0 \"Bridge vlan into VRF - IPv6 ping in\"\n\n\tmodprobe br_netfilter\n\tif [ $? -eq 0 ]; then\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd ping -c1 -w1 -I br0.100 172.16.101.2\n\t\tlog_test $? 0 \"Bridge vlan into VRF with br_netfilter - IPv4 ping out\"\n\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd ${ping6} -c1 -w1 -I br0.100 2001:db8:101::2\n\t\tlog_test $? 0 \"Bridge vlan into VRF with br_netfilter - IPv6 ping out\"\n\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd_nsb ping -c1 -w1 172.16.101.1\n\t\tlog_test $? 0 \"Bridge vlan into VRF - IPv4 ping in\"\n\n\t\trun_cmd ip neigh flush all\n\t\trun_cmd_nsb ${ping6} -c1 -w1 2001:db8:101::1\n\t\tlog_test $? 0 \"Bridge vlan into VRF - IPv6 ping in\"\n\tfi\n\n\tsetup_cmd ip li del br0 2>/dev/null\n\tsetup_cmd_nsb ip li del vlan100 2>/dev/null\n}\n\n# VRF only.\n# ns-A device is connected to both ns-B and ns-C on a single VRF but only has\n# LLA on the interfaces\nuse_case_ping_lla_multi()\n{\n\tsetup_lla_only\n\t# only want reply from ns-A\n\tsetup_cmd_nsb sysctl -qw net.ipv6.icmp.echo_ignore_multicast=1\n\tsetup_cmd_nsc sysctl -qw net.ipv6.icmp.echo_ignore_multicast=1\n\n\tlog_start\n\trun_cmd_nsb ping -c1 -w1 ${MCAST}%${NSB_DEV}\n\tlog_test_addr ${MCAST}%${NSB_DEV} $? 0 \"Pre cycle, ping out ns-B\"\n\n\trun_cmd_nsc ping -c1 -w1 ${MCAST}%${NSC_DEV}\n\tlog_test_addr ${MCAST}%${NSC_DEV} $? 0 \"Pre cycle, ping out ns-C\"\n\n\t# cycle/flap the first ns-A interface\n\tsetup_cmd ip link set ${NSA_DEV} down\n\tsetup_cmd ip link set ${NSA_DEV} up\n\tsleep 1\n\n\tlog_start\n\trun_cmd_nsb ping -c1 -w1 ${MCAST}%${NSB_DEV}\n\tlog_test_addr ${MCAST}%${NSB_DEV} $? 0 \"Post cycle ${NSA} ${NSA_DEV}, ping out ns-B\"\n\trun_cmd_nsc ping -c1 -w1 ${MCAST}%${NSC_DEV}\n\tlog_test_addr ${MCAST}%${NSC_DEV} $? 0 \"Post cycle ${NSA} ${NSA_DEV}, ping out ns-C\"\n\n\t# cycle/flap the second ns-A interface\n\tsetup_cmd ip link set ${NSA_DEV2} down\n\tsetup_cmd ip link set ${NSA_DEV2} up\n\tsleep 1\n\n\tlog_start\n\trun_cmd_nsb ping -c1 -w1 ${MCAST}%${NSB_DEV}\n\tlog_test_addr ${MCAST}%${NSB_DEV} $? 0 \"Post cycle ${NSA} ${NSA_DEV2}, ping out ns-B\"\n\trun_cmd_nsc ping -c1 -w1 ${MCAST}%${NSC_DEV}\n\tlog_test_addr ${MCAST}%${NSC_DEV} $? 0 \"Post cycle ${NSA} ${NSA_DEV2}, ping out ns-C\"\n}\n\n# Perform IPv{4,6} SNAT on ns-A, and verify TCP connection is successfully\n# established with ns-B.\nuse_case_snat_on_vrf()\n{\n\tsetup \"yes\"\n\n\tlocal port=\"12345\"\n\n\trun_cmd iptables -t nat -A POSTROUTING -p tcp -m tcp --dport ${port} -j SNAT --to-source ${NSA_LO_IP} -o ${VRF}\n\trun_cmd ip6tables -t nat -A POSTROUTING -p tcp -m tcp --dport ${port} -j SNAT --to-source ${NSA_LO_IP6} -o ${VRF}\n\n\trun_cmd_nsb nettest -s -l ${NSB_IP} -p ${port} &\n\tsleep 1\n\trun_cmd nettest -d ${VRF} -r ${NSB_IP} -p ${port}\n\tlog_test $? 0 \"IPv4 TCP connection over VRF with SNAT\"\n\n\trun_cmd_nsb nettest -6 -s -l ${NSB_IP6} -p ${port} &\n\tsleep 1\n\trun_cmd nettest -6 -d ${VRF} -r ${NSB_IP6} -p ${port}\n\tlog_test $? 0 \"IPv6 TCP connection over VRF with SNAT\"\n\n\t# Cleanup\n\trun_cmd iptables -t nat -D POSTROUTING -p tcp -m tcp --dport ${port} -j SNAT --to-source ${NSA_LO_IP} -o ${VRF}\n\trun_cmd ip6tables -t nat -D POSTROUTING -p tcp -m tcp --dport ${port} -j SNAT --to-source ${NSA_LO_IP6} -o ${VRF}\n}\n\nuse_cases()\n{\n\tlog_section \"Use cases\"\n\tlog_subsection \"Device enslaved to bridge\"\n\tuse_case_br\n\tlog_subsection \"Ping LLA with multiple interfaces\"\n\tuse_case_ping_lla_multi\n\tlog_subsection \"SNAT on VRF\"\n\tuse_case_snat_on_vrf\n}\n\n################################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n\t-4          IPv4 tests only\n\t-6          IPv6 tests only\n\t-t <test>   Test name/set to run\n\t-p          Pause on fail\n\t-P          Pause after each test\n\t-v          Be verbose\n\nTests:\n\t$TESTS_IPV4 $TESTS_IPV6 $TESTS_OTHER\nEOF\n}\n\n################################################################################\n# main\n\nTESTS_IPV4=\"ipv4_ping ipv4_tcp ipv4_udp ipv4_bind ipv4_runtime ipv4_netfilter\"\nTESTS_IPV6=\"ipv6_ping ipv6_tcp ipv6_udp ipv6_bind ipv6_runtime ipv6_netfilter\"\nTESTS_OTHER=\"use_cases\"\n\nPAUSE_ON_FAIL=no\nPAUSE=no\n\nwhile getopts :46t:pPvh o\ndo\n\tcase $o in\n\t\t4) TESTS=ipv4;;\n\t\t6) TESTS=ipv6;;\n\t\tt) TESTS=$OPTARG;;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=1;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# make sure we don't pause twice\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\n#\n# show user test config\n#\nif [ -z \"$TESTS\" ]; then\n\tTESTS=\"$TESTS_IPV4 $TESTS_IPV6 $TESTS_OTHER\"\nelif [ \"$TESTS\" = \"ipv4\" ]; then\n\tTESTS=\"$TESTS_IPV4\"\nelif [ \"$TESTS\" = \"ipv6\" ]; then\n\tTESTS=\"$TESTS_IPV6\"\nfi\n\n# nettest can be run from PATH or from same directory as this selftest\nif ! which nettest >/dev/null; then\n\tPATH=$PWD:$PATH\n\tif ! which nettest >/dev/null; then\n\t\techo \"'nettest' command not found; skipping tests\"\n\t\texit $ksft_skip\n\tfi\nfi\n\ndeclare -i nfail=0\ndeclare -i nsuccess=0\n\nfor t in $TESTS\ndo\n\tcase $t in\n\tipv4_ping|ping)  ipv4_ping;;\n\tipv4_tcp|tcp)    ipv4_tcp;;\n\tipv4_udp|udp)    ipv4_udp;;\n\tipv4_bind|bind)  ipv4_addr_bind;;\n\tipv4_runtime)    ipv4_runtime;;\n\tipv4_netfilter)  ipv4_netfilter;;\n\n\tipv6_ping|ping6) ipv6_ping;;\n\tipv6_tcp|tcp6)   ipv6_tcp;;\n\tipv6_udp|udp6)   ipv6_udp;;\n\tipv6_bind|bind6) ipv6_addr_bind;;\n\tipv6_runtime)    ipv6_runtime;;\n\tipv6_netfilter)  ipv6_netfilter;;\n\n\tuse_cases)       use_cases;;\n\n\t# setup namespaces and config, but do not run any tests\n\tsetup)\t\t setup; exit 0;;\n\tvrf_setup)\t setup \"yes\"; exit 0;;\n\tesac\ndone\n\ncleanup 2>/dev/null\n\nprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\nprintf \"Tests failed: %3d\\n\"   ${nfail}\n\nif [ $nfail -ne 0 ]; then\n\texit 1 # KSFT_FAIL\nelif [ $nsuccess -eq 0 ]; then\n\texit $ksft_skip\nfi\n\nexit 0 # KSFT_PASS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}