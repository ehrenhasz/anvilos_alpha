{
  "module_name": "test_vxlan_vnifiltering.sh",
  "hash_id": "92f7c67a221593dfd932cbb2736c4bf658afc9cbe1cc1ef80129050ea1b60943",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/test_vxlan_vnifiltering.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test is for checking the VXLAN vni filtering api and\n# datapath.\n# It simulates two hypervisors running two VMs each using four network\n# six namespaces: two for the HVs, four for the VMs. Each VM is\n# connected to a separate bridge. The VM's use overlapping vlans and\n# hence the separate bridge domain. Each vxlan device is a collect\n# metadata device with vni filtering and hence has the ability to\n# terminate configured vni's only.\n\n#  +--------------------------------+     +------------------------------------+\n#  |  vm-11 netns                   |     |  vm-21 netns                       |\n#  |                                |     |                                    |\n#  |+------------+  +-------------+ |     |+-------------+ +----------------+  |\n#  ||veth-11.10  |  |veth-11.20   | |     ||veth-21.10   | | veth-21.20     |  |\n#  ||10.0.10.11/24  |10.0.20.11/24| |     ||10.0.10.21/24| | 10.0.20.21/24  |  |\n#  |+------|-----+  +|------------+ |     |+-----------|-+ +---|------------+  |\n#  |       |         |              |     |            |       |               |\n#  |       |         |              |     |         +------------+             |\n#  |      +------------+            |     |         | veth-21    |             |\n#  |      | veth-11    |            |     |         |            |             |\n#  |      |            |            |     |         +-----|------+             |\n#  |      +-----|------+            |     |               |                    |\n#  |            |                   |     |               |                    |\n#  +------------|-------------------+     +---------------|--------------------+\n#  +------------|-----------------------------------------|-------------------+\n#  |      +-----|------+                            +-----|------+            |\n#  |      |vethhv-11   |                            |vethhv-21   |            |\n#  |      +----|-------+                            +-----|------+            |\n#  |       +---|---+                                  +---|--+                |\n#  |       |  br1  |                                  | br2  |                |\n#  |       +---|---+                                  +---|--+                |\n#  |       +---|----+                                 +---|--+                |\n#  |       |  vxlan1|                                 |vxlan2|                |\n#  |       +--|-----+                                 +--|---+                |\n#  |          |                                          |                    |\n#  |          |         +---------------------+          |                    |\n#  |          |         |veth0                |          |                    |\n#  |          +---------|172.16.0.1/24        -----------+                    |\n#  |                    |2002:fee1::1/64      |                               |\n#  | hv-1 netns         +--------|------------+                               |\n#  +-----------------------------|--------------------------------------------+\n#                                |\n#  +-----------------------------|--------------------------------------------+\n#  | hv-2 netns         +--------|-------------+                              |\n#  |                    | veth0                |                              |\n#  |             +------| 172.16.0.2/24        |---+                          |\n#  |             |      | 2002:fee1::2/64      |   |                          |\n#  |             |      |                      |   |                          |\n#  |             |      +----------------------+   |         -                |\n#  |             |                                 |                          |\n#  |           +-|-------+                +--------|-+                        |\n#  |           | vxlan1  |                |  vxlan2  |                        |\n#  |           +----|----+                +---|------+                        |\n#  |             +--|--+                    +-|---+                           |\n#  |             | br1 |                    | br2 |                           |\n#  |             +--|--+                    +--|--+                           |\n#  |          +-----|-------+             +----|-------+                      |\n#  |          | vethhv-12   |             |vethhv-22   |                      |\n#  |          +------|------+             +-------|----+                      |\n#  +-----------------|----------------------------|---------------------------+\n#                    |                            |\n#  +-----------------|-----------------+ +--------|---------------------------+\n#  |         +-------|---+             | |     +--|---------+                 |\n#  |         | veth-12   |             | |     |veth-22     |                 |\n#  |         +-|--------|+             | |     +--|--------|+                 |\n#  |           |        |              | |        |        |                  |\n#  |+----------|--+ +---|-----------+  | |+-------|-----+ +|---------------+  |\n#  ||veth-12.10   | |veth-12.20     |  | ||veth-22.10   | |veth-22.20      |  |\n#  ||10.0.10.12/24| |10.0.20.12/24  |  | ||10.0.10.22/24| |10.0.20.22/24   |  |\n#  |+-------------+ +---------------+  | |+-------------+ +----------------+  |\n#  |                                   | |                                    |\n#  |                                   | |                                    |\n#  | vm-12 netns                       | |vm-22 netns                         |\n#  +-----------------------------------+ +------------------------------------+\n#\n#\n# This test tests the new vxlan vnifiltering api\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# all tests in this script. Can be overridden with -t option\nTESTS=\"\n\tvxlan_vnifilter_api\n\tvxlan_vnifilter_datapath\n\tvxlan_vnifilter_datapath_pervni\n\tvxlan_vnifilter_datapath_mgroup\n\tvxlan_vnifilter_datapath_mgroup_pervni\n\tvxlan_vnifilter_metadata_and_traditional_mix\n\"\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\n\nwhich ping6 > /dev/null 2>&1 && ping6=$(which ping6) || ping6=$(which ping)\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"    TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"    TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$1\"\n\tlocal out\n\tlocal stderr=\"2>/dev/null\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"COMMAND: $cmd\\n\"\n\t\tstderr=\n\tfi\n\n\tout=$(eval $cmd $stderr)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\treturn $rc\n}\n\ncheck_hv_connectivity() {\n\tip netns exec hv-1 ping -c 1 -W 1 $1 &>/dev/null\n\tsleep 1\n\tip netns exec hv-1 ping -c 1 -W 1 $2 &>/dev/null\n\n\treturn $?\n}\n\ncheck_vm_connectivity() {\n\trun_cmd \"ip netns exec vm-11 ping -c 1 -W 1 10.0.10.12\"\n\tlog_test $? 0 \"VM connectivity over $1 (ipv4 default rdst)\"\n\n\trun_cmd \"ip netns exec vm-21 ping -c 1 -W 1 10.0.10.22\"\n\tlog_test $? 0 \"VM connectivity over $1 (ipv6 default rdst)\"\n}\n\ncleanup() {\n\tip link del veth-hv-1 2>/dev/null || true\n\tip link del vethhv-11 vethhv-12 vethhv-21 vethhv-22 2>/dev/null || true\n\n\tfor ns in hv-1 hv-2 vm-11 vm-21 vm-12 vm-22 vm-31 vm-32; do\n\t\tip netns del $ns 2>/dev/null || true\n\tdone\n}\n\ntrap cleanup EXIT\n\nsetup-hv-networking() {\n\thv=$1\n\tlocal1=$2\n\tmask1=$3\n\tlocal2=$4\n\tmask2=$5\n\n\tip netns add hv-$hv\n\tip link set veth-hv-$hv netns hv-$hv\n\tip -netns hv-$hv link set veth-hv-$hv name veth0\n\tip -netns hv-$hv addr add $local1/$mask1 dev veth0\n\tip -netns hv-$hv addr add $local2/$mask2 dev veth0\n\tip -netns hv-$hv link set veth0 up\n}\n\n# Setups a \"VM\" simulated by a netns an a veth pair\n# example: setup-vm <hvid> <vmid> <brid> <VATTRS> <mcast_for_bum>\n# VATTRS = comma separated \"<vlan>-<v[46]>-<localip>-<remoteip>-<VTYPE>-<vxlandstport>\"\n# VTYPE = vxlan device type. \"default = traditional device, metadata = metadata device\n#         vnifilter = vnifiltering device,\n#         vnifilterg = vnifiltering device with per vni group/remote\"\n# example:\n#     setup-vm 1 11 1 \\\n#         10-v4-172.16.0.1-239.1.1.100-vnifilterg,20-v4-172.16.0.1-239.1.1.100-vnifilterg 1\n#\nsetup-vm() {\n\thvid=$1\n\tvmid=$2\n\tbrid=$3\n\tvattrs=$4\n\tmcast=$5\n\tlastvxlandev=\"\"\n\n\t# create bridge\n\tip -netns hv-$hvid link add br$brid type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 0\n\tip -netns hv-$hvid link set br$brid up\n\n\t# create vm namespace and interfaces and connect to hypervisor\n\t# namespace\n\tip netns add vm-$vmid\n\thvvethif=\"vethhv-$vmid\"\n\tvmvethif=\"veth-$vmid\"\n\tip link add $hvvethif type veth peer name $vmvethif\n\tip link set $hvvethif netns hv-$hvid\n\tip link set $vmvethif netns vm-$vmid\n\tip -netns hv-$hvid link set $hvvethif up\n\tip -netns vm-$vmid link set $vmvethif up\n\tip -netns hv-$hvid link set $hvvethif master br$brid\n\n\t# configure VM vlan/vni filtering on hypervisor\n\tfor vmap in $(echo $vattrs | cut -d \",\" -f1- --output-delimiter=' ')\n\tdo\n\tlocal vid=$(echo $vmap | awk -F'-' '{print ($1)}')\n\tlocal family=$(echo $vmap | awk -F'-' '{print ($2)}')\n\tlocal localip=$(echo $vmap | awk -F'-' '{print ($3)}')\n\tlocal group=$(echo $vmap | awk -F'-' '{print ($4)}')\n\tlocal vtype=$(echo $vmap | awk -F'-' '{print ($5)}')\n\tlocal port=$(echo $vmap | awk -F'-' '{print ($6)}')\n\n\tip -netns vm-$vmid link add name $vmvethif.$vid link $vmvethif type vlan id $vid\n\tip -netns vm-$vmid addr add 10.0.$vid.$vmid/24 dev $vmvethif.$vid\n\tip -netns vm-$vmid link set $vmvethif.$vid up\n\n\ttid=$vid\n\tvxlandev=\"vxlan$brid\"\n\tvxlandevflags=\"\"\n\n\tif [[ -n $vtype && $vtype == \"metadata\" ]]; then\n\t   vxlandevflags=\"$vxlandevflags external\"\n\telif [[ -n $vtype && $vtype == \"vnifilter\" || $vtype == \"vnifilterg\" ]]; then\n\t   vxlandevflags=\"$vxlandevflags external vnifilter\"\n\t   tid=$((vid+brid))\n\telse\n\t   vxlandevflags=\"$vxlandevflags id $tid\"\n\t   vxlandev=\"vxlan$tid\"\n\tfi\n\n\tif [[ -n $vtype && $vtype != \"vnifilterg\" ]]; then\n\t   if [[ -n \"$group\" && \"$group\" != \"null\" ]]; then\n\t      if [ $mcast -eq 1 ]; then\n\t\t vxlandevflags=\"$vxlandevflags group $group\"\n\t      else\n\t\t vxlandevflags=\"$vxlandevflags remote $group\"\n\t      fi\n\t   fi\n\tfi\n\n\tif [[ -n \"$port\" && \"$port\" != \"default\" ]]; then\n\t      vxlandevflags=\"$vxlandevflags dstport $port\"\n\tfi\n\n\t# create vxlan device\n\tif [ \"$vxlandev\" != \"$lastvxlandev\" ]; then\n\t     ip -netns hv-$hvid link add $vxlandev type vxlan local $localip $vxlandevflags dev veth0 2>/dev/null\n\t     ip -netns hv-$hvid link set $vxlandev master br$brid\n\t     ip -netns hv-$hvid link set $vxlandev up\n\t     lastvxlandev=$vxlandev\n\tfi\n\n\t# add vlan\n\tbridge -netns hv-$hvid vlan add vid $vid dev $hvvethif\n\tbridge -netns hv-$hvid vlan add vid $vid pvid dev $vxlandev\n\n\t# Add bridge vni filter for tx\n\tif [[ -n $vtype && $vtype == \"metadata\" || $vtype == \"vnifilter\" || $vtype == \"vnifilterg\" ]]; then\n\t   bridge -netns hv-$hvid link set dev $vxlandev vlan_tunnel on\n\t   bridge -netns hv-$hvid vlan add dev $vxlandev vid $vid tunnel_info id $tid\n\tfi\n\n\tif [[ -n $vtype && $vtype == \"metadata\" ]]; then\n\t   bridge -netns hv-$hvid fdb add 00:00:00:00:00:00 dev $vxlandev \\\n\t\t\t\t\t\t\t\tsrc_vni $tid vni $tid dst $group self\n\telif [[ -n $vtype && $vtype == \"vnifilter\" ]]; then\n\t   # Add per vni rx filter with 'bridge vni' api\n\t   bridge -netns hv-$hvid vni add dev $vxlandev vni $tid\n\telif [[ -n $vtype && $vtype == \"vnifilterg\" ]]; then\n\t   # Add per vni group config with 'bridge vni' api\n\t   if [ -n \"$group\" ]; then\n\t\tif [ $mcast -eq 1 ]; then\n\t\t\tbridge -netns hv-$hvid vni add dev $vxlandev vni $tid group $group\n\t\telse\n\t\t\tbridge -netns hv-$hvid vni add dev $vxlandev vni $tid remote $group\n\t\tfi\n\t   fi\n\tfi\n\tdone\n}\n\nsetup_vnifilter_api()\n{\n\tip link add veth-host type veth peer name veth-testns\n\tip netns add testns\n\tip link set veth-testns netns testns\n}\n\ncleanup_vnifilter_api()\n{\n\tip link del veth-host 2>/dev/null || true\n\tip netns del testns 2>/dev/null || true\n}\n\n# tests vxlan filtering api\nvxlan_vnifilter_api()\n{\n\thv1addr1=\"172.16.0.1\"\n\thv2addr1=\"172.16.0.2\"\n\thv1addr2=\"2002:fee1::1\"\n\thv2addr2=\"2002:fee1::2\"\n\tlocalip=\"172.16.0.1\"\n\tgroup=\"239.1.1.101\"\n\n\tcleanup_vnifilter_api &>/dev/null\n\tsetup_vnifilter_api\n\n\t# Duplicate vni test\n\t# create non-vnifiltering traditional vni device\n\trun_cmd \"ip -netns testns link add vxlan100 type vxlan id 100 local $localip dev veth-testns dstport 4789\"\n\tlog_test $? 0 \"Create traditional vxlan device\"\n\n\t# create vni filtering device\n\trun_cmd \"ip -netns testns link add vxlan-ext1 type vxlan vnifilter local $localip dev veth-testns dstport 4789\"\n\tlog_test $? 1 \"Cannot create vnifilter device without external flag\"\n\n\trun_cmd \"ip -netns testns link add vxlan-ext1 type vxlan external vnifilter local $localip dev veth-testns dstport 4789\"\n\tlog_test $? 0 \"Creating external vxlan device with vnifilter flag\"\n\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext1 vni 100\"\n\tlog_test $? 0 \"Cannot set in-use vni id on vnifiltering device\"\n\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext1 vni 200\"\n\tlog_test $? 0 \"Set new vni id on vnifiltering device\"\n\n\trun_cmd \"ip -netns testns link add vxlan-ext2 type vxlan external vnifilter local $localip dev veth-testns dstport 4789\"\n\tlog_test $? 0 \"Create second external vxlan device with vnifilter flag\"\n\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext2 vni 200\"\n\tlog_test $? 255 \"Cannot set in-use vni id on vnifiltering device\"\n\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext2 vni 300\"\n\tlog_test $? 0 \"Set new vni id on vnifiltering device\"\n\n\t# check in bridge vni show\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext2 vni 300\"\n\tlog_test $? 0 \"Update vni id on vnifiltering device\"\n\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext2 vni 400\"\n\tlog_test $? 0 \"Add new vni id on vnifiltering device\"\n\n\t# add multicast group per vni\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext1 vni 200 group $group\"\n\tlog_test $? 0 \"Set multicast group on existing vni\"\n\n\t# add multicast group per vni\n\trun_cmd \"bridge -netns testns vni add dev vxlan-ext2 vni 300 group $group\"\n\tlog_test $? 0 \"Set multicast group on existing vni\"\n\n\t# set vnifilter on an existing external vxlan device\n\trun_cmd \"ip -netns testns link set dev vxlan-ext1 type vxlan external vnifilter\"\n\tlog_test $? 2 \"Cannot set vnifilter flag on a device\"\n\n\t# change vxlan vnifilter flag\n\trun_cmd \"ip -netns testns link set dev vxlan-ext1 type vxlan external novnifilter\"\n\tlog_test $? 2 \"Cannot unset vnifilter flag on a device\"\n}\n\n# Sanity test vnifilter datapath\n# vnifilter vnis inherit BUM group from\n# vxlan device\nvxlan_vnifilter_datapath()\n{\n\thv1addr1=\"172.16.0.1\"\n\thv2addr1=\"172.16.0.2\"\n\thv1addr2=\"2002:fee1::1\"\n\thv2addr2=\"2002:fee1::2\"\n\n\tip link add veth-hv-1 type veth peer name veth-hv-2\n\tsetup-hv-networking 1 $hv1addr1 24 $hv1addr2 64 $hv2addr1 $hv2addr2\n\tsetup-hv-networking 2 $hv2addr1 24 $hv2addr2 64 $hv1addr1 $hv1addr2\n\n        check_hv_connectivity hv2addr1 hv2addr2\n\n\tsetup-vm 1 11 1 10-v4-$hv1addr1-$hv2addr1-vnifilter,20-v4-$hv1addr1-$hv2addr1-vnifilter 0\n\tsetup-vm 1 21 2 10-v6-$hv1addr2-$hv2addr2-vnifilter,20-v6-$hv1addr2-$hv2addr2-vnifilter 0\n\n\tsetup-vm 2 12 1 10-v4-$hv2addr1-$hv1addr1-vnifilter,20-v4-$hv2addr1-$hv1addr1-vnifilter 0\n\tsetup-vm 2 22 2 10-v6-$hv2addr2-$hv1addr2-vnifilter,20-v6-$hv2addr2-$hv1addr2-vnifilter 0\n\n        check_vm_connectivity \"vnifiltering vxlan\"\n}\n\n# Sanity test vnifilter datapath\n# with vnifilter per vni configured BUM\n# group/remote\nvxlan_vnifilter_datapath_pervni()\n{\n\thv1addr1=\"172.16.0.1\"\n\thv2addr1=\"172.16.0.2\"\n\thv1addr2=\"2002:fee1::1\"\n\thv2addr2=\"2002:fee1::2\"\n\n\tip link add veth-hv-1 type veth peer name veth-hv-2\n\tsetup-hv-networking 1 $hv1addr1 24 $hv1addr2 64\n\tsetup-hv-networking 2 $hv2addr1 24 $hv2addr2 64\n\n        check_hv_connectivity hv2addr1 hv2addr2\n\n\tsetup-vm 1 11 1 10-v4-$hv1addr1-$hv2addr1-vnifilterg,20-v4-$hv1addr1-$hv2addr1-vnifilterg 0\n\tsetup-vm 1 21 2 10-v6-$hv1addr2-$hv2addr2-vnifilterg,20-v6-$hv1addr2-$hv2addr2-vnifilterg 0\n\n\tsetup-vm 2 12 1 10-v4-$hv2addr1-$hv1addr1-vnifilterg,20-v4-$hv2addr1-$hv1addr1-vnifilterg 0\n\tsetup-vm 2 22 2 10-v6-$hv2addr2-$hv1addr2-vnifilterg,20-v6-$hv2addr2-$hv1addr2-vnifilterg 0\n\n        check_vm_connectivity \"vnifiltering vxlan pervni remote\"\n}\n\n\nvxlan_vnifilter_datapath_mgroup()\n{\n\thv1addr1=\"172.16.0.1\"\n\thv2addr1=\"172.16.0.2\"\n\thv1addr2=\"2002:fee1::1\"\n\thv2addr2=\"2002:fee1::2\"\n        group=\"239.1.1.100\"\n        group6=\"ff07::1\"\n\n\tip link add veth-hv-1 type veth peer name veth-hv-2\n\tsetup-hv-networking 1 $hv1addr1 24 $hv1addr2 64\n\tsetup-hv-networking 2 $hv2addr1 24 $hv2addr2 64\n\n        check_hv_connectivity hv2addr1 hv2addr2\n\n\tsetup-vm 1 11 1 10-v4-$hv1addr1-$group-vnifilter,20-v4-$hv1addr1-$group-vnifilter 1\n\tsetup-vm 1 21 2 \"10-v6-$hv1addr2-$group6-vnifilter,20-v6-$hv1addr2-$group6-vnifilter\" 1\n\n        setup-vm 2 12 1 10-v4-$hv2addr1-$group-vnifilter,20-v4-$hv2addr1-$group-vnifilter 1\n        setup-vm 2 22 2 10-v6-$hv2addr2-$group6-vnifilter,20-v6-$hv2addr2-$group6-vnifilter 1\n\n        check_vm_connectivity \"vnifiltering vxlan mgroup\"\n}\n\nvxlan_vnifilter_datapath_mgroup_pervni()\n{\n\thv1addr1=\"172.16.0.1\"\n\thv2addr1=\"172.16.0.2\"\n\thv1addr2=\"2002:fee1::1\"\n\thv2addr2=\"2002:fee1::2\"\n        group=\"239.1.1.100\"\n        group6=\"ff07::1\"\n\n\tip link add veth-hv-1 type veth peer name veth-hv-2\n\tsetup-hv-networking 1 $hv1addr1 24 $hv1addr2 64\n\tsetup-hv-networking 2 $hv2addr1 24 $hv2addr2 64\n\n        check_hv_connectivity hv2addr1 hv2addr2\n\n\tsetup-vm 1 11 1 10-v4-$hv1addr1-$group-vnifilterg,20-v4-$hv1addr1-$group-vnifilterg 1\n\tsetup-vm 1 21 2 10-v6-$hv1addr2-$group6-vnifilterg,20-v6-$hv1addr2-$group6-vnifilterg 1\n\n        setup-vm 2 12 1 10-v4-$hv2addr1-$group-vnifilterg,20-v4-$hv2addr1-$group-vnifilterg 1\n        setup-vm 2 22 2 10-v6-$hv2addr2-$group6-vnifilterg,20-v6-$hv2addr2-$group6-vnifilterg 1\n\n        check_vm_connectivity \"vnifiltering vxlan pervni mgroup\"\n}\n\nvxlan_vnifilter_metadata_and_traditional_mix()\n{\n\thv1addr1=\"172.16.0.1\"\n\thv2addr1=\"172.16.0.2\"\n\thv1addr2=\"2002:fee1::1\"\n\thv2addr2=\"2002:fee1::2\"\n\n\tip link add veth-hv-1 type veth peer name veth-hv-2\n\tsetup-hv-networking 1 $hv1addr1 24 $hv1addr2 64\n\tsetup-hv-networking 2 $hv2addr1 24 $hv2addr2 64\n\n        check_hv_connectivity hv2addr1 hv2addr2\n\n\tsetup-vm 1 11 1 10-v4-$hv1addr1-$hv2addr1-vnifilter,20-v4-$hv1addr1-$hv2addr1-vnifilter 0\n\tsetup-vm 1 21 2 10-v6-$hv1addr2-$hv2addr2-vnifilter,20-v6-$hv1addr2-$hv2addr2-vnifilter 0\n\tsetup-vm 1 31 3 30-v4-$hv1addr1-$hv2addr1-default-4790,40-v6-$hv1addr2-$hv2addr2-default-4790,50-v4-$hv1addr1-$hv2addr1-metadata-4791 0\n\n\n\tsetup-vm 2 12 1 10-v4-$hv2addr1-$hv1addr1-vnifilter,20-v4-$hv2addr1-$hv1addr1-vnifilter 0\n\tsetup-vm 2 22 2 10-v6-$hv2addr2-$hv1addr2-vnifilter,20-v6-$hv2addr2-$hv1addr2-vnifilter 0\n\tsetup-vm 2 32 3 30-v4-$hv2addr1-$hv1addr1-default-4790,40-v6-$hv2addr2-$hv1addr2-default-4790,50-v4-$hv2addr1-$hv1addr1-metadata-4791 0\n\n        check_vm_connectivity \"vnifiltering vxlan pervni remote mix\"\n\n\t# check VM connectivity over traditional/non-vxlan filtering vxlan devices\n\trun_cmd \"ip netns exec vm-31 ping -c 1 -W 1 10.0.30.32\"\n        log_test $? 0 \"VM connectivity over traditional vxlan (ipv4 default rdst)\"\n\n\trun_cmd \"ip netns exec vm-31 ping -c 1 -W 1 10.0.40.32\"\n        log_test $? 0 \"VM connectivity over traditional vxlan (ipv6 default rdst)\"\n\n\trun_cmd \"ip netns exec vm-31 ping -c 1 -W 1 10.0.50.32\"\n        log_test $? 0 \"VM connectivity over metadata nonfiltering vxlan (ipv4 default rdst)\"\n}\n\nwhile getopts :t:pP46hv o\ndo\n\tcase $o in\n\t\tt) TESTS=$OPTARG;;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# make sure we don't pause twice\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nip link help vxlan 2>&1 | grep -q \"vnifilter\"\nif [ $? -ne 0 ]; then\n   echo \"SKIP: iproute2 too old, missing vxlan dev vnifilter setting\"\n   sync\n   exit $ksft_skip\nfi\n\nbridge vni help 2>&1 | grep -q \"Usage: bridge vni\"\nif [ $? -ne 0 ]; then\n   echo \"SKIP: iproute2 bridge lacks vxlan vnifiltering support\"\n   exit $ksft_skip\nfi\n\n# start clean\ncleanup &> /dev/null\n\nfor t in $TESTS\ndo\n\tcase $t in\n\tnone) setup; exit 0;;\n\t*) $t; cleanup;;\n\tesac\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}