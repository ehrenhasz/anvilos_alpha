{
  "module_name": "drop_monitor_tests.sh",
  "hash_id": "74cee82d30281c81eecb4fec2439a8af38b2eda187833d5159ae0ee905a9e3e3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/drop_monitor_tests.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test is for checking drop monitor functionality.\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# all tests in this script. Can be overridden with -t option\nTESTS=\"\n\tsw_drops\n\thw_drops\n\"\n\nIP=\"ip -netns ns1\"\nTC=\"tc -netns ns1\"\nDEVLINK=\"devlink -N ns1\"\nNS_EXEC=\"ip netns exec ns1\"\nNETDEVSIM_PATH=/sys/bus/netdevsim/\nDEV_ADDR=1337\nDEV=netdevsim${DEV_ADDR}\nDEVLINK_DEV=netdevsim/${DEV}\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"    TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"    TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\tfi\n}\n\nsetup()\n{\n\tmodprobe netdevsim &> /dev/null\n\n\tset -e\n\tip netns add ns1\n\t$IP link add dummy10 up type dummy\n\n\t$NS_EXEC echo \"$DEV_ADDR 1\" > ${NETDEVSIM_PATH}/new_device\n\tudevadm settle\n\tlocal netdev=$($NS_EXEC ls ${NETDEVSIM_PATH}/devices/${DEV}/net/)\n\t$IP link set dev $netdev up\n\n\tset +e\n}\n\ncleanup()\n{\n\t$NS_EXEC echo \"$DEV_ADDR\" > ${NETDEVSIM_PATH}/del_device\n\tip netns del ns1\n}\n\nsw_drops_test()\n{\n\techo\n\techo \"Software drops test\"\n\n\tsetup\n\n\tlocal dir=$(mktemp -d)\n\n\t$TC qdisc add dev dummy10 clsact\n\t$TC filter add dev dummy10 egress pref 1 handle 101 proto ip \\\n\t\tflower dst_ip 192.0.2.10 action drop\n\n\t$NS_EXEC mausezahn dummy10 -a 00:11:22:33:44:55 -b 00:aa:bb:cc:dd:ee \\\n\t\t-A 192.0.2.1 -B 192.0.2.10 -t udp sp=12345,dp=54321 -c 0 -q \\\n\t\t-d 100msec &\n\ttimeout 5 dwdump -o sw -w ${dir}/packets.pcap\n\t(( $(tshark -r ${dir}/packets.pcap \\\n\t\t-Y 'ip.dst == 192.0.2.10' 2> /dev/null | wc -l) != 0))\n\tlog_test $? 0 \"Capturing active software drops\"\n\n\trm ${dir}/packets.pcap\n\n\t{ kill %% && wait %%; } 2>/dev/null\n\ttimeout 5 dwdump -o sw -w ${dir}/packets.pcap\n\t(( $(tshark -r ${dir}/packets.pcap \\\n\t\t-Y 'ip.dst == 192.0.2.10' 2> /dev/null | wc -l) == 0))\n\tlog_test $? 0 \"Capturing inactive software drops\"\n\n\trm -r $dir\n\n\tcleanup\n}\n\nhw_drops_test()\n{\n\techo\n\techo \"Hardware drops test\"\n\n\tsetup\n\n\tlocal dir=$(mktemp -d)\n\n\t$DEVLINK trap set $DEVLINK_DEV trap blackhole_route action trap\n\ttimeout 5 dwdump -o hw -w ${dir}/packets.pcap\n\t(( $(tshark -r ${dir}/packets.pcap \\\n\t\t-Y 'net_dm.hw_trap_name== blackhole_route' 2> /dev/null \\\n\t\t| wc -l) != 0))\n\tlog_test $? 0 \"Capturing active hardware drops\"\n\n\trm ${dir}/packets.pcap\n\n\t$DEVLINK trap set $DEVLINK_DEV trap blackhole_route action drop\n\ttimeout 5 dwdump -o hw -w ${dir}/packets.pcap\n\t(( $(tshark -r ${dir}/packets.pcap \\\n\t\t-Y 'net_dm.hw_trap_name== blackhole_route' 2> /dev/null \\\n\t\t| wc -l) == 0))\n\tlog_test $? 0 \"Capturing inactive hardware drops\"\n\n\trm -r $dir\n\n\tcleanup\n}\n\n################################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $TESTS)\nEOF\n}\n\n################################################################################\n# main\n\nwhile getopts \":t:h\" opt; do\n\tcase $opt in\n\t\tt) TESTS=$OPTARG;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v devlink)\" ]; then\n\techo \"SKIP: Could not run test without devlink tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v tshark)\" ]; then\n\techo \"SKIP: Could not run test without tshark tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v dwdump)\" ]; then\n\techo \"SKIP: Could not run test without dwdump tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v udevadm)\" ]; then\n\techo \"SKIP: Could not run test without udevadm tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v timeout)\" ]; then\n\techo \"SKIP: Could not run test without timeout tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v mausezahn)\" ]; then\n\techo \"SKIP: Could not run test without mausezahn tool\"\n\texit $ksft_skip\nfi\n\ntshark -G fields 2> /dev/null | grep -q net_dm\nif [ $? -ne 0 ]; then\n\techo \"SKIP: tshark too old, missing net_dm dissector\"\n\texit $ksft_skip\nfi\n\n# start clean\ncleanup &> /dev/null\n\nfor t in $TESTS\ndo\n\tcase $t in\n\tsw_drops|sw)\t\t\tsw_drops_test;;\n\thw_drops|hw)\t\t\thw_drops_test;;\n\n\thelp) echo \"Test names: $TESTS\"; exit 0;;\n\tesac\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}