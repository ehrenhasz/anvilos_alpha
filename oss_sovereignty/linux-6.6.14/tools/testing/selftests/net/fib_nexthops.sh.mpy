{
  "module_name": "fib_nexthops.sh",
  "hash_id": "4674dd904a313551faa6cd4409c2ad6a37b940d5315ce1f1f2a6f1be9a0a1332",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/fib_nexthops.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# ns: me               | ns: peer              | ns: remote\n#   2001:db8:91::1     |       2001:db8:91::2  |\n#   172.16.1.1         |       172.16.1.2      |\n#            veth1 <---|---> veth2             |\n#                      |              veth5 <--|--> veth6  172.16.101.1\n#            veth3 <---|---> veth4             |           2001:db8:101::1\n#   172.16.2.1         |       172.16.2.2      |\n#   2001:db8:92::1     |       2001:db8:92::2  |\n#\n# This test is for checking IPv4 and IPv6 FIB behavior with nexthop\n# objects. Device reference counts and network namespace cleanup tested\n# by use of network namespace for peer.\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# all tests in this script. Can be overridden with -t option\nIPV4_TESTS=\"\n\tipv4_fcnal\n\tipv4_grp_fcnal\n\tipv4_res_grp_fcnal\n\tipv4_withv6_fcnal\n\tipv4_fcnal_runtime\n\tipv4_large_grp\n\tipv4_large_res_grp\n\tipv4_compat_mode\n\tipv4_fdb_grp_fcnal\n\tipv4_mpath_select\n\tipv4_torture\n\tipv4_res_torture\n\"\n\nIPV6_TESTS=\"\n\tipv6_fcnal\n\tipv6_grp_fcnal\n\tipv6_res_grp_fcnal\n\tipv6_fcnal_runtime\n\tipv6_large_grp\n\tipv6_large_res_grp\n\tipv6_compat_mode\n\tipv6_fdb_grp_fcnal\n\tipv6_mpath_select\n\tipv6_torture\n\tipv6_res_torture\n\"\n\nALL_TESTS=\"\n\tbasic\n\tbasic_res\n\t${IPV4_TESTS}\n\t${IPV6_TESTS}\n\"\nTESTS=\"${ALL_TESTS}\"\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\nPING_TIMEOUT=5\n\nnsid=100\n\n################################################################################\n# utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\t\techo \"    rc=$rc, expected $expected\"\n\t\tfi\n\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$1\"\n\tlocal out\n\tlocal stderr=\"2>/dev/null\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"COMMAND: $cmd\\n\"\n\t\tstderr=\n\tfi\n\n\tout=$(eval $cmd $stderr)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\treturn $rc\n}\n\nget_linklocal()\n{\n\tlocal dev=$1\n\tlocal ns\n\tlocal addr\n\n\t[ -n \"$2\" ] && ns=\"-netns $2\"\n\taddr=$(ip $ns -6 -br addr show dev ${dev} | \\\n\tawk '{\n\t\tfor (i = 3; i <= NF; ++i) {\n\t\t\tif ($i ~ /^fe80/)\n\t\t\t\tprint $i\n\t\t}\n\t}'\n\t)\n\taddr=${addr/\\/*}\n\n\t[ -z \"$addr\" ] && return 1\n\n\techo $addr\n\n\treturn 0\n}\n\ncreate_ns()\n{\n\tlocal n=${1}\n\n\tip netns del ${n} 2>/dev/null\n\n\tset -e\n\tip netns add ${n}\n\tip netns set ${n} $((nsid++))\n\tip -netns ${n} addr add 127.0.0.1/8 dev lo\n\tip -netns ${n} link set lo up\n\n\tip netns exec ${n} sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ${n} sysctl -qw net.ipv4.fib_multipath_use_neigh=1\n\tip netns exec ${n} sysctl -qw net.ipv4.conf.default.ignore_routes_with_linkdown=1\n\tip netns exec ${n} sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec ${n} sysctl -qw net.ipv6.conf.all.forwarding=1\n\tip netns exec ${n} sysctl -qw net.ipv6.conf.default.forwarding=1\n\tip netns exec ${n} sysctl -qw net.ipv6.conf.default.ignore_routes_with_linkdown=1\n\tip netns exec ${n} sysctl -qw net.ipv6.conf.all.accept_dad=0\n\tip netns exec ${n} sysctl -qw net.ipv6.conf.default.accept_dad=0\n\n\tset +e\n}\n\nsetup()\n{\n\tcleanup\n\n\tcreate_ns me\n\tcreate_ns peer\n\tcreate_ns remote\n\n\tIP=\"ip -netns me\"\n\tBRIDGE=\"bridge -netns me\"\n\tset -e\n\t$IP li add veth1 type veth peer name veth2\n\t$IP li set veth1 up\n\t$IP addr add 172.16.1.1/24 dev veth1\n\t$IP -6 addr add 2001:db8:91::1/64 dev veth1 nodad\n\n\t$IP li add veth3 type veth peer name veth4\n\t$IP li set veth3 up\n\t$IP addr add 172.16.2.1/24 dev veth3\n\t$IP -6 addr add 2001:db8:92::1/64 dev veth3 nodad\n\n\t$IP li set veth2 netns peer up\n\tip -netns peer addr add 172.16.1.2/24 dev veth2\n\tip -netns peer -6 addr add 2001:db8:91::2/64 dev veth2 nodad\n\n\t$IP li set veth4 netns peer up\n\tip -netns peer addr add 172.16.2.2/24 dev veth4\n\tip -netns peer -6 addr add 2001:db8:92::2/64 dev veth4 nodad\n\n\tip -netns remote li add veth5 type veth peer name veth6\n\tip -netns remote li set veth5 up\n\tip -netns remote addr add dev veth5 172.16.101.1/24\n\tip -netns remote -6 addr add dev veth5 2001:db8:101::1/64 nodad\n\tip -netns remote ro add 172.16.0.0/22 via 172.16.101.2\n\tip -netns remote -6 ro add 2001:db8:90::/40 via 2001:db8:101::2\n\n\tip -netns remote li set veth6 netns peer up\n\tip -netns peer addr add dev veth6 172.16.101.2/24\n\tip -netns peer -6 addr add dev veth6 2001:db8:101::2/64 nodad\n\tset +e\n}\n\ncleanup()\n{\n\tlocal ns\n\n\tfor ns in me peer remote; do\n\t\tip netns del ${ns} 2>/dev/null\n\tdone\n}\n\ncheck_output()\n{\n\tlocal out=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal rc=0\n\n\t[ \"${out}\" = \"${expected}\" ] && return 0\n\n\tif [ -z \"${out}\" ]; then\n\t\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\t\tprintf \"\\nNo entry found\\n\"\n\t\t\tprintf \"Expected:\\n\"\n\t\t\tprintf \"    ${expected}\\n\"\n\t\tfi\n\t\treturn 1\n\tfi\n\n\tout=$(echo ${out})\n\tif [ \"${out}\" != \"${expected}\" ]; then\n\t\trc=1\n\t\tif [ \"${VERBOSE}\" = \"1\" ]; then\n\t\t\tprintf \"    Unexpected entry. Have:\\n\"\n\t\t\tprintf \"        ${out}\\n\"\n\t\t\tprintf \"    Expected:\\n\"\n\t\t\tprintf \"        ${expected}\\n\\n\"\n\t\telse\n\t\t\techo \"      WARNING: Unexpected route entry\"\n\t\tfi\n\tfi\n\n\treturn $rc\n}\n\ncheck_nexthop()\n{\n\tlocal nharg=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal out\n\n\tout=$($IP nexthop ls ${nharg} 2>/dev/null)\n\n\tcheck_output \"${out}\" \"${expected}\"\n}\n\ncheck_nexthop_bucket()\n{\n\tlocal nharg=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal out\n\n\t# remove the idle time since we cannot match it\n\tout=$($IP nexthop bucket ${nharg} \\\n\t\t| sed s/idle_time\\ [0-9.]*\\ // 2>/dev/null)\n\n\tcheck_output \"${out}\" \"${expected}\"\n}\n\ncheck_route()\n{\n\tlocal pfx=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal out\n\n\tout=$($IP route ls match ${pfx} 2>/dev/null)\n\n\tcheck_output \"${out}\" \"${expected}\"\n}\n\ncheck_route6()\n{\n\tlocal pfx=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal out\n\n\tout=$($IP -6 route ls match ${pfx} 2>/dev/null | sed -e 's/pref medium//')\n\n\tcheck_output \"${out}\" \"${expected}\"\n}\n\ncheck_large_grp()\n{\n\tlocal ipv=$1\n\tlocal ecmp=$2\n\tlocal grpnum=100\n\tlocal nhidstart=100\n\tlocal grpidstart=1000\n\tlocal iter=0\n\tlocal nhidstr=\"\"\n\tlocal grpidstr=\"\"\n\tlocal grpstr=\"\"\n\tlocal ipstr=\"\"\n\n\tif [ $ipv -eq 4 ]; then\n\t\tipstr=\"172.16.1.\"\n\telse\n\t\tipstr=\"2001:db8:91::\"\n\tfi\n\n\t#\n\t# Create $grpnum groups with specified $ecmp and dump them\n\t#\n\n\t# create nexthops with different gateways\n\titer=2\n\twhile [ $iter -le $(($ecmp + 1)) ]\n\tdo\n\t\tnhidstr=\"$(($nhidstart + $iter))\"\n\t\trun_cmd \"$IP nexthop add id $nhidstr via $ipstr$iter dev veth1\"\n\t\tcheck_nexthop \"id $nhidstr\" \"id $nhidstr via $ipstr$iter dev veth1 scope link\"\n\n\t\tif [ $iter -le $ecmp ]; then\n\t\t\tgrpstr+=\"$nhidstr/\"\n\t\telse\n\t\t\tgrpstr+=\"$nhidstr\"\n\t\tfi\n\t\t((iter++))\n\tdone\n\n\t# create duplicate large ecmp groups\n\titer=0\n\twhile [ $iter -le $grpnum ]\n\tdo\n\t\tgrpidstr=\"$(($grpidstart + $iter))\"\n\t\trun_cmd \"$IP nexthop add id $grpidstr group $grpstr\"\n\t\tcheck_nexthop \"id $grpidstr\" \"id $grpidstr group $grpstr\"\n\t\t((iter++))\n\tdone\n\n\t# dump large groups\n\trun_cmd \"$IP nexthop list\"\n\tlog_test $? 0 \"Dump large (x$ecmp) ecmp groups\"\n}\n\ncheck_large_res_grp()\n{\n\tlocal ipv=$1\n\tlocal buckets=$2\n\tlocal ipstr=\"\"\n\n\tif [ $ipv -eq 4 ]; then\n\t\tipstr=\"172.16.1.2\"\n\telse\n\t\tipstr=\"2001:db8:91::2\"\n\tfi\n\n\t# create a resilient group with $buckets buckets and dump them\n\trun_cmd \"$IP nexthop add id 100 via $ipstr dev veth1\"\n\trun_cmd \"$IP nexthop add id 1000 group 100 type resilient buckets $buckets\"\n\trun_cmd \"$IP nexthop bucket list\"\n\tlog_test $? 0 \"Dump large (x$buckets) nexthop buckets\"\n}\n\nget_route_dev()\n{\n\tlocal pfx=\"$1\"\n\tlocal out\n\n\tif out=$($IP -j route get \"$pfx\" | jq -re \".[0].dev\"); then\n\t\techo \"$out\"\n\tfi\n}\n\ncheck_route_dev()\n{\n\tlocal pfx=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal out\n\n\tout=$(get_route_dev \"$pfx\")\n\n\tcheck_output \"$out\" \"$expected\"\n}\n\nstart_ip_monitor()\n{\n\tlocal mtype=$1\n\n\t# start the monitor in the background\n\ttmpfile=`mktemp /var/run/nexthoptestXXX`\n\tmpid=`($IP monitor $mtype > $tmpfile & echo $!) 2>/dev/null`\n\tsleep 0.2\n\techo \"$mpid $tmpfile\"\n}\n\nstop_ip_monitor()\n{\n\tlocal mpid=$1\n\tlocal tmpfile=$2\n\tlocal el=$3\n\n\t# check the monitor results\n\tkill $mpid\n\tlines=`wc -l $tmpfile | cut \"-d \" -f1`\n\ttest $lines -eq $el\n\trc=$?\n\trm -rf $tmpfile\n\n\treturn $rc\n}\n\ncheck_nexthop_fdb_support()\n{\n\t$IP nexthop help 2>&1 | grep -q fdb\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP: iproute2 too old, missing fdb nexthop support\"\n\t\treturn $ksft_skip\n\tfi\n}\n\ncheck_nexthop_res_support()\n{\n\t$IP nexthop help 2>&1 | grep -q resilient\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP: iproute2 too old, missing resilient nexthop group support\"\n\t\treturn $ksft_skip\n\tfi\n}\n\nipv6_fdb_grp_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv6 fdb groups functional\"\n\techo \"--------------------------\"\n\n\tcheck_nexthop_fdb_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\t# create group with multiple nexthops\n\trun_cmd \"$IP nexthop add id 61 via 2001:db8:91::2 fdb\"\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::3 fdb\"\n\trun_cmd \"$IP nexthop add id 102 group 61/62 fdb\"\n\tcheck_nexthop \"id 102\" \"id 102 group 61/62 fdb\"\n\tlog_test $? 0 \"Fdb Nexthop group with multiple nexthops\"\n\n\t## get nexthop group\n\trun_cmd \"$IP nexthop get id 102\"\n\tcheck_nexthop \"id 102\" \"id 102 group 61/62 fdb\"\n\tlog_test $? 0 \"Get Fdb nexthop group by id\"\n\n\t# fdb nexthop group can only contain fdb nexthops\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::4\"\n\trun_cmd \"$IP nexthop add id 64 via 2001:db8:91::5\"\n\trun_cmd \"$IP nexthop add id 103 group 63/64 fdb\"\n\tlog_test $? 2 \"Fdb Nexthop group with non-fdb nexthops\"\n\n\t# Non fdb nexthop group can not contain fdb nexthops\n\trun_cmd \"$IP nexthop add id 65 via 2001:db8:91::5 fdb\"\n\trun_cmd \"$IP nexthop add id 66 via 2001:db8:91::6 fdb\"\n\trun_cmd \"$IP nexthop add id 104 group 65/66\"\n\tlog_test $? 2 \"Non-Fdb Nexthop group with fdb nexthops\"\n\n\t# fdb nexthop cannot have blackhole\n\trun_cmd \"$IP nexthop add id 67 blackhole fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with blackhole\"\n\n\t# fdb nexthop with oif\n\trun_cmd \"$IP nexthop add id 68 via 2001:db8:91::7 dev veth1 fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with oif\"\n\n\t# fdb nexthop with onlink\n\trun_cmd \"$IP nexthop add id 68 via 2001:db8:91::7 onlink fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with onlink\"\n\n\t# fdb nexthop with encap\n\trun_cmd \"$IP nexthop add id 69 encap mpls 101 via 2001:db8:91::8 dev veth1 fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with encap\"\n\n\trun_cmd \"$IP link add name vx10 type vxlan id 1010 local 2001:db8:91::9 remote 2001:db8:91::10 dstport 4789 nolearning noudpcsum tos inherit ttl 100\"\n\trun_cmd \"$BRIDGE fdb add 02:02:00:00:00:13 dev vx10 nhid 102 self\"\n\tlog_test $? 0 \"Fdb mac add with nexthop group\"\n\n\t## fdb nexthops can only reference nexthop groups and not nexthops\n\trun_cmd \"$BRIDGE fdb add 02:02:00:00:00:14 dev vx10 nhid 61 self\"\n\tlog_test $? 255 \"Fdb mac add with nexthop\"\n\n\trun_cmd \"$IP -6 ro add 2001:db8:101::1/128 nhid 66\"\n\tlog_test $? 2 \"Route add with fdb nexthop\"\n\n\trun_cmd \"$IP -6 ro add 2001:db8:101::1/128 nhid 103\"\n\tlog_test $? 2 \"Route add with fdb nexthop group\"\n\n\trun_cmd \"$IP nexthop del id 61\"\n\trun_cmd \"$BRIDGE fdb get to 02:02:00:00:00:13 dev vx10 self\"\n\tlog_test $? 0 \"Fdb entry after deleting a single nexthop\"\n\n\trun_cmd \"$IP nexthop del id 102\"\n\tlog_test $? 0 \"Fdb nexthop delete\"\n\n\trun_cmd \"$BRIDGE fdb get to 02:02:00:00:00:13 dev vx10 self\"\n\tlog_test $? 254 \"Fdb entry after deleting a nexthop group\"\n\n\t$IP link del dev vx10\n}\n\nipv4_fdb_grp_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv4 fdb groups functional\"\n\techo \"--------------------------\"\n\n\tcheck_nexthop_fdb_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\t# create group with multiple nexthops\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 fdb\"\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 fdb\"\n\trun_cmd \"$IP nexthop add id 102 group 12/13 fdb\"\n\tcheck_nexthop \"id 102\" \"id 102 group 12/13 fdb\"\n\tlog_test $? 0 \"Fdb Nexthop group with multiple nexthops\"\n\n\t# get nexthop group\n\trun_cmd \"$IP nexthop get id 102\"\n\tcheck_nexthop \"id 102\" \"id 102 group 12/13 fdb\"\n\tlog_test $? 0 \"Get Fdb nexthop group by id\"\n\n\t# fdb nexthop group can only contain fdb nexthops\n\trun_cmd \"$IP nexthop add id 14 via 172.16.1.2\"\n\trun_cmd \"$IP nexthop add id 15 via 172.16.1.3\"\n\trun_cmd \"$IP nexthop add id 103 group 14/15 fdb\"\n\tlog_test $? 2 \"Fdb Nexthop group with non-fdb nexthops\"\n\n\t# Non fdb nexthop group can not contain fdb nexthops\n\trun_cmd \"$IP nexthop add id 16 via 172.16.1.2 fdb\"\n\trun_cmd \"$IP nexthop add id 17 via 172.16.1.3 fdb\"\n\trun_cmd \"$IP nexthop add id 104 group 14/15\"\n\tlog_test $? 2 \"Non-Fdb Nexthop group with fdb nexthops\"\n\n\t# fdb nexthop cannot have blackhole\n\trun_cmd \"$IP nexthop add id 18 blackhole fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with blackhole\"\n\n\t# fdb nexthop with oif\n\trun_cmd \"$IP nexthop add id 16 via 172.16.1.2 dev veth1 fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with oif\"\n\n\t# fdb nexthop with onlink\n\trun_cmd \"$IP nexthop add id 16 via 172.16.1.2 onlink fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with onlink\"\n\n\t# fdb nexthop with encap\n\trun_cmd \"$IP nexthop add id 17 encap mpls 101 via 172.16.1.2 dev veth1 fdb\"\n\tlog_test $? 2 \"Fdb Nexthop with encap\"\n\n\trun_cmd \"$IP link add name vx10 type vxlan id 1010 local 10.0.0.1 remote 10.0.0.2 dstport 4789 nolearning noudpcsum tos inherit ttl 100\"\n\trun_cmd \"$BRIDGE fdb add 02:02:00:00:00:13 dev vx10 nhid 102 self\"\n\tlog_test $? 0 \"Fdb mac add with nexthop group\"\n\n\t# fdb nexthops can only reference nexthop groups and not nexthops\n\trun_cmd \"$BRIDGE fdb add 02:02:00:00:00:14 dev vx10 nhid 12 self\"\n\tlog_test $? 255 \"Fdb mac add with nexthop\"\n\n\trun_cmd \"$IP ro add 172.16.0.0/22 nhid 15\"\n\tlog_test $? 2 \"Route add with fdb nexthop\"\n\n\trun_cmd \"$IP ro add 172.16.0.0/22 nhid 103\"\n\tlog_test $? 2 \"Route add with fdb nexthop group\"\n\n\trun_cmd \"$IP nexthop del id 12\"\n\trun_cmd \"$BRIDGE fdb get to 02:02:00:00:00:13 dev vx10 self\"\n\tlog_test $? 0 \"Fdb entry after deleting a single nexthop\"\n\n\trun_cmd \"$IP nexthop del id 102\"\n\tlog_test $? 0 \"Fdb nexthop delete\"\n\n\trun_cmd \"$BRIDGE fdb get to 02:02:00:00:00:13 dev vx10 self\"\n\tlog_test $? 254 \"Fdb entry after deleting a nexthop group\"\n\n\t$IP link del dev vx10\n}\n\nipv4_mpath_select()\n{\n\tlocal rc dev match h addr\n\n\techo\n\techo \"IPv4 multipath selection\"\n\techo \"------------------------\"\n\tif [ ! -x \"$(command -v jq)\" ]; then\n\t\techo \"SKIP: Could not run test; need jq tool\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# Use status of existing neighbor entry when determining nexthop for\n\t# multipath routes.\n\tlocal -A gws\n\tgws=([veth1]=172.16.1.2 [veth3]=172.16.2.2)\n\tlocal -A other_dev\n\tother_dev=([veth1]=veth3 [veth3]=veth1)\n\n\trun_cmd \"$IP nexthop add id 1 via ${gws[\"veth1\"]} dev veth1\"\n\trun_cmd \"$IP nexthop add id 2 via ${gws[\"veth3\"]} dev veth3\"\n\trun_cmd \"$IP nexthop add id 1001 group 1/2\"\n\trun_cmd \"$IP ro add 172.16.101.0/24 nhid 1001\"\n\trc=0\n\tfor dev in veth1 veth3; do\n\t\tmatch=0\n\t\tfor h in {1..254}; do\n\t\t\taddr=\"172.16.101.$h\"\n\t\t\tif [ \"$(get_route_dev \"$addr\")\" = \"$dev\" ]; then\n\t\t\t\tmatch=1\n\t\t\t\tbreak\n\t\t\tfi\n\t\tdone\n\t\tif (( match == 0 )); then\n\t\t\techo \"SKIP: Did not find a route using device $dev\"\n\t\t\treturn $ksft_skip\n\t\tfi\n\t\trun_cmd \"$IP neigh add ${gws[$dev]} dev $dev nud failed\"\n\t\tif ! check_route_dev \"$addr\" \"${other_dev[$dev]}\"; then\n\t\t\trc=1\n\t\t\tbreak\n\t\tfi\n\t\trun_cmd \"$IP neigh del ${gws[$dev]} dev $dev\"\n\tdone\n\tlog_test $rc 0 \"Use valid neighbor during multipath selection\"\n\n\trun_cmd \"$IP neigh add 172.16.1.2 dev veth1 nud incomplete\"\n\trun_cmd \"$IP neigh add 172.16.2.2 dev veth3 nud incomplete\"\n\trun_cmd \"$IP route get 172.16.101.1\"\n\t# if we did not crash, success\n\tlog_test $rc 0 \"Multipath selection with no valid neighbor\"\n}\n\nipv6_mpath_select()\n{\n\tlocal rc dev match h addr\n\n\techo\n\techo \"IPv6 multipath selection\"\n\techo \"------------------------\"\n\tif [ ! -x \"$(command -v jq)\" ]; then\n\t\techo \"SKIP: Could not run test; need jq tool\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# Use status of existing neighbor entry when determining nexthop for\n\t# multipath routes.\n\tlocal -A gws\n\tgws=([veth1]=2001:db8:91::2 [veth3]=2001:db8:92::2)\n\tlocal -A other_dev\n\tother_dev=([veth1]=veth3 [veth3]=veth1)\n\n\trun_cmd \"$IP nexthop add id 1 via ${gws[\"veth1\"]} dev veth1\"\n\trun_cmd \"$IP nexthop add id 2 via ${gws[\"veth3\"]} dev veth3\"\n\trun_cmd \"$IP nexthop add id 1001 group 1/2\"\n\trun_cmd \"$IP ro add 2001:db8:101::/64 nhid 1001\"\n\trc=0\n\tfor dev in veth1 veth3; do\n\t\tmatch=0\n\t\tfor h in {1..65535}; do\n\t\t\taddr=$(printf \"2001:db8:101::%x\" $h)\n\t\t\tif [ \"$(get_route_dev \"$addr\")\" = \"$dev\" ]; then\n\t\t\t\tmatch=1\n\t\t\t\tbreak\n\t\t\tfi\n\t\tdone\n\t\tif (( match == 0 )); then\n\t\t\techo \"SKIP: Did not find a route using device $dev\"\n\t\t\treturn $ksft_skip\n\t\tfi\n\t\trun_cmd \"$IP neigh add ${gws[$dev]} dev $dev nud failed\"\n\t\tif ! check_route_dev \"$addr\" \"${other_dev[$dev]}\"; then\n\t\t\trc=1\n\t\t\tbreak\n\t\tfi\n\t\trun_cmd \"$IP neigh del ${gws[$dev]} dev $dev\"\n\tdone\n\tlog_test $rc 0 \"Use valid neighbor during multipath selection\"\n\n\trun_cmd \"$IP neigh add 2001:db8:91::2 dev veth1 nud incomplete\"\n\trun_cmd \"$IP neigh add 2001:db8:92::2 dev veth3 nud incomplete\"\n\trun_cmd \"$IP route get 2001:db8:101::1\"\n\t# if we did not crash, success\n\tlog_test $rc 0 \"Multipath selection with no valid neighbor\"\n}\n\n################################################################################\n# basic operations (add, delete, replace) on nexthops and nexthop groups\n#\n# IPv6\n\nipv6_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv6\"\n\techo \"----------------------\"\n\n\trun_cmd \"$IP nexthop add id 52 via 2001:db8:91::2 dev veth1\"\n\trc=$?\n\tlog_test $rc 0 \"Create nexthop with id, gw, dev\"\n\tif [ $rc -ne 0 ]; then\n\t\techo \"Basic IPv6 create fails; can not continue\"\n\t\treturn 1\n\tfi\n\n\trun_cmd \"$IP nexthop get id 52\"\n\tlog_test $? 0 \"Get nexthop by id\"\n\tcheck_nexthop \"id 52\" \"id 52 via 2001:db8:91::2 dev veth1 scope link\"\n\n\trun_cmd \"$IP nexthop del id 52\"\n\tlog_test $? 0 \"Delete nexthop by id\"\n\tcheck_nexthop \"id 52\" \"\"\n\n\t#\n\t# gw, device spec\n\t#\n\t# gw validation, no device - fails since dev required\n\trun_cmd \"$IP nexthop add id 52 via 2001:db8:92::3\"\n\tlog_test $? 2 \"Create nexthop - gw only\"\n\n\t# gw is not reachable throught given dev\n\trun_cmd \"$IP nexthop add id 53 via 2001:db8:3::3 dev veth1\"\n\tlog_test $? 2 \"Create nexthop - invalid gw+dev combination\"\n\n\t# onlink arg overrides gw+dev lookup\n\trun_cmd \"$IP nexthop add id 53 via 2001:db8:3::3 dev veth1 onlink\"\n\tlog_test $? 0 \"Create nexthop - gw+dev and onlink\"\n\n\t# admin down should delete nexthops\n\tset -e\n\trun_cmd \"$IP -6 nexthop add id 55 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 56 via 2001:db8:91::4 dev veth1\"\n\trun_cmd \"$IP nexthop add id 57 via 2001:db8:91::5 dev veth1\"\n\trun_cmd \"$IP li set dev veth1 down\"\n\tset +e\n\tcheck_nexthop \"dev veth1\" \"\"\n\tlog_test $? 0 \"Nexthops removed on admin down\"\n}\n\nipv6_grp_refs()\n{\n\tif [ ! -x \"$(command -v mausezahn)\" ]; then\n\t\techo \"SKIP: Could not run test; need mausezahn tool\"\n\t\treturn\n\tfi\n\n\trun_cmd \"$IP link set dev veth1 up\"\n\trun_cmd \"$IP link add veth1.10 link veth1 up type vlan id 10\"\n\trun_cmd \"$IP link add veth1.20 link veth1 up type vlan id 20\"\n\trun_cmd \"$IP -6 addr add 2001:db8:91::1/64 dev veth1.10\"\n\trun_cmd \"$IP -6 addr add 2001:db8:92::1/64 dev veth1.20\"\n\trun_cmd \"$IP -6 neigh add 2001:db8:91::2 lladdr 00:11:22:33:44:55 dev veth1.10\"\n\trun_cmd \"$IP -6 neigh add 2001:db8:92::2 lladdr 00:11:22:33:44:55 dev veth1.20\"\n\trun_cmd \"$IP nexthop add id 100 via 2001:db8:91::2 dev veth1.10\"\n\trun_cmd \"$IP nexthop add id 101 via 2001:db8:92::2 dev veth1.20\"\n\trun_cmd \"$IP nexthop add id 102 group 100\"\n\trun_cmd \"$IP route add 2001:db8:101::1/128 nhid 102\"\n\n\t# create per-cpu dsts through nh 100\n\trun_cmd \"ip netns exec me mausezahn -6 veth1.10 -B 2001:db8:101::1 -A 2001:db8:91::1 -c 5 -t tcp \"dp=1-1023, flags=syn\" >/dev/null 2>&1\"\n\n\t# remove nh 100 from the group to delete the route potentially leaving\n\t# a stale per-cpu dst which holds a reference to the nexthop's net\n\t# device and to the IPv6 route\n\trun_cmd \"$IP nexthop replace id 102 group 101\"\n\trun_cmd \"$IP route del 2001:db8:101::1/128\"\n\n\t# add both nexthops to the group so a reference is taken on them\n\trun_cmd \"$IP nexthop replace id 102 group 100/101\"\n\n\t# if the bug described in commit \"net: nexthop: release IPv6 per-cpu\n\t# dsts when replacing a nexthop group\" exists at this point we have\n\t# an unlinked IPv6 route (but not freed due to stale dst) with a\n\t# reference over the group so we delete the group which will again\n\t# only unlink it due to the route reference\n\trun_cmd \"$IP nexthop del id 102\"\n\n\t# delete the nexthop with stale dst, since we have an unlinked\n\t# group with a ref to it and an unlinked IPv6 route with ref to the\n\t# group, the nh will only be unlinked and not freed so the stale dst\n\t# remains forever and we get a net device refcount imbalance\n\trun_cmd \"$IP nexthop del id 100\"\n\n\t# if a reference was lost this command will hang because the net device\n\t# cannot be removed\n\ttimeout -s KILL 5 ip netns exec me ip link del veth1.10 >/dev/null 2>&1\n\n\t# we can't cleanup if the command is hung trying to delete the netdev\n\tif [ $? -eq 137 ]; then\n\t\treturn 1\n\tfi\n\n\t# cleanup\n\trun_cmd \"$IP link del veth1.20\"\n\trun_cmd \"$IP nexthop flush\"\n\n\treturn 0\n}\n\nipv6_grp_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv6 groups functional\"\n\techo \"----------------------\"\n\n\t# basic functionality: create a nexthop group, default weight\n\trun_cmd \"$IP nexthop add id 61 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 group 61\"\n\tlog_test $? 0 \"Create nexthop group with single nexthop\"\n\n\t# get nexthop group\n\trun_cmd \"$IP nexthop get id 101\"\n\tlog_test $? 0 \"Get nexthop group by id\"\n\tcheck_nexthop \"id 101\" \"id 101 group 61\"\n\n\t# delete nexthop group\n\trun_cmd \"$IP nexthop del id 101\"\n\tlog_test $? 0 \"Delete nexthop group by id\"\n\tcheck_nexthop \"id 101\" \"\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\tcheck_nexthop \"id 101\" \"\"\n\n\t#\n\t# create group with multiple nexthops - mix of gw and dev only\n\t#\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 64 via 2001:db8:91::4 dev veth1\"\n\trun_cmd \"$IP nexthop add id 65 dev veth1\"\n\trun_cmd \"$IP nexthop add id 102 group 62/63/64/65\"\n\tlog_test $? 0 \"Nexthop group with multiple nexthops\"\n\tcheck_nexthop \"id 102\" \"id 102 group 62/63/64/65\"\n\n\t# Delete nexthop in a group and group is updated\n\trun_cmd \"$IP nexthop del id 63\"\n\tcheck_nexthop \"id 102\" \"id 102 group 62/64/65\"\n\tlog_test $? 0 \"Nexthop group updated when entry is deleted\"\n\n\t# create group with multiple weighted nexthops\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 103 group 62/63,2/64,3/65,4\"\n\tlog_test $? 0 \"Nexthop group with weighted nexthops\"\n\tcheck_nexthop \"id 103\" \"id 103 group 62/63,2/64,3/65,4\"\n\n\t# Delete nexthop in a weighted group and group is updated\n\trun_cmd \"$IP nexthop del id 63\"\n\tcheck_nexthop \"id 103\" \"id 103 group 62/64,3/65,4\"\n\tlog_test $? 0 \"Weighted nexthop group updated when entry is deleted\"\n\n\t# admin down - nexthop is removed from group\n\trun_cmd \"$IP li set dev veth1 down\"\n\tcheck_nexthop \"dev veth1\" \"\"\n\tlog_test $? 0 \"Nexthops in groups removed on admin down\"\n\n\t# expect groups to have been deleted as well\n\tcheck_nexthop \"\" \"\"\n\n\trun_cmd \"$IP li set dev veth1 up\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t# group with nexthops using different devices\n\tset -e\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 64 via 2001:db8:91::4 dev veth1\"\n\trun_cmd \"$IP nexthop add id 65 via 2001:db8:91::5 dev veth1\"\n\n\trun_cmd \"$IP nexthop add id 72 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 73 via 2001:db8:92::3 dev veth3\"\n\trun_cmd \"$IP nexthop add id 74 via 2001:db8:92::4 dev veth3\"\n\trun_cmd \"$IP nexthop add id 75 via 2001:db8:92::5 dev veth3\"\n\tset +e\n\n\t# multiple groups with same nexthop\n\trun_cmd \"$IP nexthop add id 104 group 62\"\n\trun_cmd \"$IP nexthop add id 105 group 62\"\n\tcheck_nexthop \"group\" \"id 104 group 62 id 105 group 62\"\n\tlog_test $? 0 \"Multiple groups with same nexthop\"\n\n\trun_cmd \"$IP nexthop flush groups\"\n\t[ $? -ne 0 ] && return 1\n\n\t# on admin down of veth1, it should be removed from the group\n\trun_cmd \"$IP nexthop add id 105 group 62/63/72/73/64\"\n\trun_cmd \"$IP li set veth1 down\"\n\tcheck_nexthop \"id 105\" \"id 105 group 72/73\"\n\tlog_test $? 0 \"Nexthops in group removed on admin down - mixed group\"\n\n\trun_cmd \"$IP nexthop add id 106 group 105/74\"\n\tlog_test $? 2 \"Nexthop group can not have a group as an entry\"\n\n\t# a group can have a blackhole entry only if it is the only\n\t# nexthop in the group. Needed for atomic replace with an\n\t# actual nexthop group\n\trun_cmd \"$IP -6 nexthop add id 31 blackhole\"\n\trun_cmd \"$IP nexthop add id 107 group 31\"\n\tlog_test $? 0 \"Nexthop group with a blackhole entry\"\n\n\trun_cmd \"$IP nexthop add id 108 group 31/24\"\n\tlog_test $? 2 \"Nexthop group can not have a blackhole and another nexthop\"\n\n\tipv6_grp_refs\n\tlog_test $? 0 \"Nexthop group replace refcounts\"\n}\n\nipv6_res_grp_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv6 resilient groups functional\"\n\techo \"--------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\t#\n\t# migration of nexthop buckets - equal weights\n\t#\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 102 group 62/63 type resilient buckets 2 idle_timer 0\"\n\n\trun_cmd \"$IP nexthop del id 63\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 62 type resilient buckets 2 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated when entry is deleted\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 62 id 102 index 1 nhid 62\"\n\tlog_test $? 0 \"Nexthop buckets updated when entry is deleted\"\n\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop replace id 102 group 62/63 type resilient buckets 2 idle_timer 0\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 62/63 type resilient buckets 2 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated after replace\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 63 id 102 index 1 nhid 62\"\n\tlog_test $? 0 \"Nexthop buckets updated after replace\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t#\n\t# migration of nexthop buckets - unequal weights\n\t#\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 102 group 62,3/63,1 type resilient buckets 4 idle_timer 0\"\n\n\trun_cmd \"$IP nexthop del id 63\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 62,3 type resilient buckets 4 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated when entry is deleted - nECMP\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 62 id 102 index 1 nhid 62 id 102 index 2 nhid 62 id 102 index 3 nhid 62\"\n\tlog_test $? 0 \"Nexthop buckets updated when entry is deleted - nECMP\"\n\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop replace id 102 group 62,3/63,1 type resilient buckets 4 idle_timer 0\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 62,3/63 type resilient buckets 4 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated after replace - nECMP\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 63 id 102 index 1 nhid 62 id 102 index 2 nhid 62 id 102 index 3 nhid 62\"\n\tlog_test $? 0 \"Nexthop buckets updated after replace - nECMP\"\n}\n\nipv6_fcnal_runtime()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv6 functional runtime\"\n\techo \"-----------------------\"\n\n\t#\n\t# IPv6 - the basics\n\t#\n\trun_cmd \"$IP nexthop add id 81 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP ro add 2001:db8:101::1/128 nhid 81\"\n\tlog_test $? 0 \"Route add\"\n\n\trun_cmd \"$IP ro delete 2001:db8:101::1/128 nhid 81\"\n\tlog_test $? 0 \"Route delete\"\n\n\trun_cmd \"$IP ro add 2001:db8:101::1/128 nhid 81\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 0 \"Ping with nexthop\"\n\n\trun_cmd \"$IP nexthop add id 82 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 122 group 81/82\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 122\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 0 \"Ping - multipath\"\n\n\t#\n\t# IPv6 with blackhole nexthops\n\t#\n\trun_cmd \"$IP -6 nexthop add id 83 blackhole\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 83\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 2 \"Ping - blackhole\"\n\n\trun_cmd \"$IP nexthop replace id 83 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 0 \"Ping - blackhole replaced with gateway\"\n\n\trun_cmd \"$IP -6 nexthop replace id 83 blackhole\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 2 \"Ping - gateway replaced by blackhole\"\n\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 122\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tif [ $? -eq 0 ]; then\n\t\trun_cmd \"$IP nexthop replace id 122 group 83\"\n\t\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\t\tlog_test $? 2 \"Ping - group with blackhole\"\n\n\t\trun_cmd \"$IP nexthop replace id 122 group 81/82\"\n\t\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\t\tlog_test $? 0 \"Ping - group blackhole replaced with gateways\"\n\telse\n\t\tlog_test 2 0 \"Ping - multipath failed\"\n\tfi\n\n\t#\n\t# device only and gw + dev only mix\n\t#\n\trun_cmd \"$IP -6 nexthop add id 85 dev veth1\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 85\"\n\tlog_test $? 0 \"IPv6 route with device only nexthop\"\n\tcheck_route6 \"2001:db8:101::1\" \"2001:db8:101::1 nhid 85 dev veth1 metric 1024\"\n\n\trun_cmd \"$IP nexthop add id 123 group 81/85\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 123\"\n\tlog_test $? 0 \"IPv6 multipath route with nexthop mix - dev only + gw\"\n\tcheck_route6 \"2001:db8:101::1\" \"2001:db8:101::1 nhid 123 metric 1024 nexthop via 2001:db8:91::2 dev veth1 weight 1 nexthop dev veth1 weight 1\"\n\n\t#\n\t# IPv6 route with v4 nexthop - not allowed\n\t#\n\trun_cmd \"$IP ro delete 2001:db8:101::1/128\"\n\trun_cmd \"$IP nexthop add id 84 via 172.16.1.1 dev veth1\"\n\trun_cmd \"$IP ro add 2001:db8:101::1/128 nhid 84\"\n\tlog_test $? 2 \"IPv6 route can not have a v4 gateway\"\n\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 81\"\n\trun_cmd \"$IP nexthop replace id 81 via 172.16.1.1 dev veth1\"\n\tlog_test $? 2 \"Nexthop replace - v6 route, v4 nexthop\"\n\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 122\"\n\trun_cmd \"$IP nexthop replace id 81 via 172.16.1.1 dev veth1\"\n\tlog_test $? 2 \"Nexthop replace of group entry - v6 route, v4 nexthop\"\n\n\trun_cmd \"$IP nexthop add id 86 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 87 via 172.16.1.1 dev veth1\"\n\trun_cmd \"$IP nexthop add id 88 via 172.16.1.1 dev veth1\"\n\trun_cmd \"$IP nexthop add id 124 group 86/87/88\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 124\"\n\tlog_test $? 2 \"IPv6 route can not have a group with v4 and v6 gateways\"\n\n\trun_cmd \"$IP nexthop del id 88\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 124\"\n\tlog_test $? 2 \"IPv6 route can not have a group with v4 and v6 gateways\"\n\n\trun_cmd \"$IP nexthop del id 87\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 124\"\n\tlog_test $? 0 \"IPv6 route using a group after removing v4 gateways\"\n\n\trun_cmd \"$IP ro delete 2001:db8:101::1/128\"\n\trun_cmd \"$IP nexthop add id 87 via 172.16.1.1 dev veth1\"\n\trun_cmd \"$IP nexthop add id 88 via 172.16.1.1 dev veth1\"\n\trun_cmd \"$IP nexthop replace id 124 group 86/87/88\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 124\"\n\tlog_test $? 2 \"IPv6 route can not have a group with v4 and v6 gateways\"\n\n\trun_cmd \"$IP nexthop replace id 88 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 124\"\n\tlog_test $? 2 \"IPv6 route can not have a group with v4 and v6 gateways\"\n\n\trun_cmd \"$IP nexthop replace id 87 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP ro replace 2001:db8:101::1/128 nhid 124\"\n\tlog_test $? 0 \"IPv6 route using a group after replacing v4 gateways\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t#\n\t# weird IPv6 cases\n\t#\n\trun_cmd \"$IP nexthop add id 86 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP ro add 2001:db8:101::1/128 nhid 81\"\n\n\t# route can not use prefsrc with nexthops\n\trun_cmd \"$IP ro add 2001:db8:101::2/128 nhid 86 from 2001:db8:91::1\"\n\tlog_test $? 2 \"IPv6 route can not use src routing with external nexthop\"\n\n\t# check cleanup path on invalid metric\n\trun_cmd \"$IP ro add 2001:db8:101::2/128 nhid 86 congctl lock foo\"\n\tlog_test $? 2 \"IPv6 route with invalid metric\"\n\n\t# rpfilter and default route\n\t$IP nexthop flush >/dev/null 2>&1\n\trun_cmd \"ip netns exec me ip6tables -t mangle -I PREROUTING 1 -m rpfilter --invert -j DROP\"\n\trun_cmd \"$IP nexthop add id 91 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 92 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 93 group 91/92\"\n\trun_cmd \"$IP -6 ro add default nhid 91\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 0 \"Nexthop with default route and rpfilter\"\n\trun_cmd \"$IP -6 ro replace default nhid 93\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 2001:db8:101::1\"\n\tlog_test $? 0 \"Nexthop with multipath default route and rpfilter\"\n\n\t# TO-DO:\n\t# existing route with old nexthop; append route with new nexthop\n\t# existing route with old nexthop; replace route with new\n\t# existing route with new nexthop; replace route with old\n\t# route with src address and using nexthop - not allowed\n}\n\nipv6_large_grp()\n{\n\tlocal ecmp=32\n\n\techo\n\techo \"IPv6 large groups (x$ecmp)\"\n\techo \"---------------------\"\n\n\tcheck_large_grp 6 $ecmp\n\n\t$IP nexthop flush >/dev/null 2>&1\n}\n\nipv6_large_res_grp()\n{\n\techo\n\techo \"IPv6 large resilient group (128k buckets)\"\n\techo \"-----------------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\tcheck_large_res_grp 6 $((128 * 1024))\n\n\t$IP nexthop flush >/dev/null 2>&1\n}\n\nipv6_del_add_loop1()\n{\n\twhile :; do\n\t\t$IP nexthop del id 100\n\t\t$IP nexthop add id 100 via 2001:db8:91::2 dev veth1\n\tdone >/dev/null 2>&1\n}\n\nipv6_grp_replace_loop()\n{\n\twhile :; do\n\t\t$IP nexthop replace id 102 group 100/101\n\tdone >/dev/null 2>&1\n}\n\nipv6_torture()\n{\n\tlocal pid1\n\tlocal pid2\n\tlocal pid3\n\tlocal pid4\n\tlocal pid5\n\n\techo\n\techo \"IPv6 runtime torture\"\n\techo \"--------------------\"\n\tif [ ! -x \"$(command -v mausezahn)\" ]; then\n\t\techo \"SKIP: Could not run test; need mausezahn tool\"\n\t\treturn\n\tfi\n\n\trun_cmd \"$IP nexthop add id 100 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 102 group 100/101\"\n\trun_cmd \"$IP route add 2001:db8:101::1 nhid 102\"\n\trun_cmd \"$IP route add 2001:db8:101::2 nhid 102\"\n\n\tipv6_del_add_loop1 &\n\tpid1=$!\n\tipv6_grp_replace_loop &\n\tpid2=$!\n\tip netns exec me ping -f 2001:db8:101::1 >/dev/null 2>&1 &\n\tpid3=$!\n\tip netns exec me ping -f 2001:db8:101::2 >/dev/null 2>&1 &\n\tpid4=$!\n\tip netns exec me mausezahn -6 veth1 -B 2001:db8:101::2 -A 2001:db8:91::1 -c 0 -t tcp \"dp=1-1023, flags=syn\" >/dev/null 2>&1 &\n\tpid5=$!\n\n\tsleep 300\n\tkill -9 $pid1 $pid2 $pid3 $pid4 $pid5\n\twait $pid1 $pid2 $pid3 $pid4 $pid5 2>/dev/null\n\n\t# if we did not crash, success\n\tlog_test 0 0 \"IPv6 torture test\"\n}\n\nipv6_res_grp_replace_loop()\n{\n\twhile :; do\n\t\t$IP nexthop replace id 102 group 100/101 type resilient\n\tdone >/dev/null 2>&1\n}\n\nipv6_res_torture()\n{\n\tlocal pid1\n\tlocal pid2\n\tlocal pid3\n\tlocal pid4\n\tlocal pid5\n\n\techo\n\techo \"IPv6 runtime resilient nexthop group torture\"\n\techo \"--------------------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\tif [ ! -x \"$(command -v mausezahn)\" ]; then\n\t\techo \"SKIP: Could not run test; need mausezahn tool\"\n\t\treturn\n\tfi\n\n\trun_cmd \"$IP nexthop add id 100 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 via 2001:db8:92::2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 102 group 100/101 type resilient buckets 512 idle_timer 0\"\n\trun_cmd \"$IP route add 2001:db8:101::1 nhid 102\"\n\trun_cmd \"$IP route add 2001:db8:101::2 nhid 102\"\n\n\tipv6_del_add_loop1 &\n\tpid1=$!\n\tipv6_res_grp_replace_loop &\n\tpid2=$!\n\tip netns exec me ping -f 2001:db8:101::1 >/dev/null 2>&1 &\n\tpid3=$!\n\tip netns exec me ping -f 2001:db8:101::2 >/dev/null 2>&1 &\n\tpid4=$!\n\tip netns exec me mausezahn -6 veth1 \\\n\t\t\t    -B 2001:db8:101::2 -A 2001:db8:91::1 -c 0 \\\n\t\t\t    -t tcp \"dp=1-1023, flags=syn\" >/dev/null 2>&1 &\n\tpid5=$!\n\n\tsleep 300\n\tkill -9 $pid1 $pid2 $pid3 $pid4 $pid5\n\twait $pid1 $pid2 $pid3 $pid4 $pid5 2>/dev/null\n\n\t# if we did not crash, success\n\tlog_test 0 0 \"IPv6 resilient nexthop group torture test\"\n}\n\nipv4_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv4 functional\"\n\techo \"----------------------\"\n\n\t#\n\t# basic IPv4 ops - add, get, delete\n\t#\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 dev veth1\"\n\trc=$?\n\tlog_test $rc 0 \"Create nexthop with id, gw, dev\"\n\tif [ $rc -ne 0 ]; then\n\t\techo \"Basic IPv4 create fails; can not continue\"\n\t\treturn 1\n\tfi\n\n\trun_cmd \"$IP nexthop get id 12\"\n\tlog_test $? 0 \"Get nexthop by id\"\n\tcheck_nexthop \"id 12\" \"id 12 via 172.16.1.2 dev veth1 scope link\"\n\n\trun_cmd \"$IP nexthop del id 12\"\n\tlog_test $? 0 \"Delete nexthop by id\"\n\tcheck_nexthop \"id 52\" \"\"\n\n\t#\n\t# gw, device spec\n\t#\n\t# gw validation, no device - fails since dev is required\n\trun_cmd \"$IP nexthop add id 12 via 172.16.2.3\"\n\tlog_test $? 2 \"Create nexthop - gw only\"\n\n\t# gw not reachable through given dev\n\trun_cmd \"$IP nexthop add id 13 via 172.16.3.2 dev veth1\"\n\tlog_test $? 2 \"Create nexthop - invalid gw+dev combination\"\n\n\t# onlink flag overrides gw+dev lookup\n\trun_cmd \"$IP nexthop add id 13 via 172.16.3.2 dev veth1 onlink\"\n\tlog_test $? 0 \"Create nexthop - gw+dev and onlink\"\n\n\t# admin down should delete nexthops\n\tset -e\n\trun_cmd \"$IP nexthop add id 15 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 16 via 172.16.1.4 dev veth1\"\n\trun_cmd \"$IP nexthop add id 17 via 172.16.1.5 dev veth1\"\n\trun_cmd \"$IP li set dev veth1 down\"\n\tset +e\n\tcheck_nexthop \"dev veth1\" \"\"\n\tlog_test $? 0 \"Nexthops removed on admin down\"\n\n\t# nexthop route delete warning: route add with nhid and delete\n\t# using device\n\trun_cmd \"$IP li set dev veth1 up\"\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.3 dev veth1\"\n\tout1=`dmesg | grep \"WARNING:.*fib_nh_match.*\" | wc -l`\n\trun_cmd \"$IP route add 172.16.101.1/32 nhid 12\"\n\trun_cmd \"$IP route delete 172.16.101.1/32 dev veth1\"\n\tout2=`dmesg | grep \"WARNING:.*fib_nh_match.*\" | wc -l`\n\t[ $out1 -eq $out2 ]\n\trc=$?\n\tlog_test $rc 0 \"Delete nexthop route warning\"\n\trun_cmd \"$IP route delete 172.16.101.1/32 nhid 12\"\n\trun_cmd \"$IP nexthop del id 12\"\n\n\trun_cmd \"$IP nexthop add id 21 via 172.16.1.6 dev veth1\"\n\trun_cmd \"$IP ro add 172.16.101.0/24 nhid 21\"\n\trun_cmd \"$IP ro del 172.16.101.0/24 nexthop via 172.16.1.7 dev veth1 nexthop via 172.16.1.8 dev veth1\"\n\tlog_test $? 2 \"Delete multipath route with only nh id based entry\"\n\n\trun_cmd \"$IP nexthop add id 22 via 172.16.1.6 dev veth1\"\n\trun_cmd \"$IP ro add 172.16.102.0/24 nhid 22\"\n\trun_cmd \"$IP ro del 172.16.102.0/24 dev veth1\"\n\tlog_test $? 2 \"Delete route when specifying only nexthop device\"\n\n\trun_cmd \"$IP ro del 172.16.102.0/24 via 172.16.1.6\"\n\tlog_test $? 2 \"Delete route when specifying only gateway\"\n\n\trun_cmd \"$IP ro del 172.16.102.0/24\"\n\tlog_test $? 0 \"Delete route when not specifying nexthop attributes\"\n}\n\nipv4_grp_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv4 groups functional\"\n\techo \"----------------------\"\n\n\t# basic functionality: create a nexthop group, default weight\n\trun_cmd \"$IP nexthop add id 11 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 group 11\"\n\tlog_test $? 0 \"Create nexthop group with single nexthop\"\n\n\t# get nexthop group\n\trun_cmd \"$IP nexthop get id 101\"\n\tlog_test $? 0 \"Get nexthop group by id\"\n\tcheck_nexthop \"id 101\" \"id 101 group 11\"\n\n\t# delete nexthop group\n\trun_cmd \"$IP nexthop del id 101\"\n\tlog_test $? 0 \"Delete nexthop group by id\"\n\tcheck_nexthop \"id 101\" \"\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t#\n\t# create group with multiple nexthops\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 14 via 172.16.1.4 dev veth1\"\n\trun_cmd \"$IP nexthop add id 15 via 172.16.1.5 dev veth1\"\n\trun_cmd \"$IP nexthop add id 102 group 12/13/14/15\"\n\tlog_test $? 0 \"Nexthop group with multiple nexthops\"\n\tcheck_nexthop \"id 102\" \"id 102 group 12/13/14/15\"\n\n\t# Delete nexthop in a group and group is updated\n\trun_cmd \"$IP nexthop del id 13\"\n\tcheck_nexthop \"id 102\" \"id 102 group 12/14/15\"\n\tlog_test $? 0 \"Nexthop group updated when entry is deleted\"\n\n\t# create group with multiple weighted nexthops\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 103 group 12/13,2/14,3/15,4\"\n\tlog_test $? 0 \"Nexthop group with weighted nexthops\"\n\tcheck_nexthop \"id 103\" \"id 103 group 12/13,2/14,3/15,4\"\n\n\t# Delete nexthop in a weighted group and group is updated\n\trun_cmd \"$IP nexthop del id 13\"\n\tcheck_nexthop \"id 103\" \"id 103 group 12/14,3/15,4\"\n\tlog_test $? 0 \"Weighted nexthop group updated when entry is deleted\"\n\n\t# admin down - nexthop is removed from group\n\trun_cmd \"$IP li set dev veth1 down\"\n\tcheck_nexthop \"dev veth1\" \"\"\n\tlog_test $? 0 \"Nexthops in groups removed on admin down\"\n\n\t# expect groups to have been deleted as well\n\tcheck_nexthop \"\" \"\"\n\n\trun_cmd \"$IP li set dev veth1 up\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t# group with nexthops using different devices\n\tset -e\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 14 via 172.16.1.4 dev veth1\"\n\trun_cmd \"$IP nexthop add id 15 via 172.16.1.5 dev veth1\"\n\n\trun_cmd \"$IP nexthop add id 22 via 172.16.2.2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 23 via 172.16.2.3 dev veth3\"\n\trun_cmd \"$IP nexthop add id 24 via 172.16.2.4 dev veth3\"\n\trun_cmd \"$IP nexthop add id 25 via 172.16.2.5 dev veth3\"\n\tset +e\n\n\t# multiple groups with same nexthop\n\trun_cmd \"$IP nexthop add id 104 group 12\"\n\trun_cmd \"$IP nexthop add id 105 group 12\"\n\tcheck_nexthop \"group\" \"id 104 group 12 id 105 group 12\"\n\tlog_test $? 0 \"Multiple groups with same nexthop\"\n\n\trun_cmd \"$IP nexthop flush groups\"\n\t[ $? -ne 0 ] && return 1\n\n\t# on admin down of veth1, it should be removed from the group\n\trun_cmd \"$IP nexthop add id 105 group 12/13/22/23/14\"\n\trun_cmd \"$IP li set veth1 down\"\n\tcheck_nexthop \"id 105\" \"id 105 group 22/23\"\n\tlog_test $? 0 \"Nexthops in group removed on admin down - mixed group\"\n\n\trun_cmd \"$IP nexthop add id 106 group 105/24\"\n\tlog_test $? 2 \"Nexthop group can not have a group as an entry\"\n\n\t# a group can have a blackhole entry only if it is the only\n\t# nexthop in the group. Needed for atomic replace with an\n\t# actual nexthop group\n\trun_cmd \"$IP nexthop add id 31 blackhole\"\n\trun_cmd \"$IP nexthop add id 107 group 31\"\n\tlog_test $? 0 \"Nexthop group with a blackhole entry\"\n\n\trun_cmd \"$IP nexthop add id 108 group 31/24\"\n\tlog_test $? 2 \"Nexthop group can not have a blackhole and another nexthop\"\n}\n\nipv4_res_grp_fcnal()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv4 resilient groups functional\"\n\techo \"--------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\t#\n\t# migration of nexthop buckets - equal weights\n\t#\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 102 group 12/13 type resilient buckets 2 idle_timer 0\"\n\n\trun_cmd \"$IP nexthop del id 13\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 12 type resilient buckets 2 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated when entry is deleted\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 12 id 102 index 1 nhid 12\"\n\tlog_test $? 0 \"Nexthop buckets updated when entry is deleted\"\n\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop replace id 102 group 12/13 type resilient buckets 2 idle_timer 0\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 12/13 type resilient buckets 2 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated after replace\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 13 id 102 index 1 nhid 12\"\n\tlog_test $? 0 \"Nexthop buckets updated after replace\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t#\n\t# migration of nexthop buckets - unequal weights\n\t#\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 102 group 12,3/13,1 type resilient buckets 4 idle_timer 0\"\n\n\trun_cmd \"$IP nexthop del id 13\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 12,3 type resilient buckets 4 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated when entry is deleted - nECMP\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 12 id 102 index 1 nhid 12 id 102 index 2 nhid 12 id 102 index 3 nhid 12\"\n\tlog_test $? 0 \"Nexthop buckets updated when entry is deleted - nECMP\"\n\n\trun_cmd \"$IP nexthop add id 13 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP nexthop replace id 102 group 12,3/13,1 type resilient buckets 4 idle_timer 0\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 12,3/13 type resilient buckets 4 idle_timer 0 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Nexthop group updated after replace - nECMP\"\n\tcheck_nexthop_bucket \"list id 102\" \\\n\t\t\"id 102 index 0 nhid 13 id 102 index 1 nhid 12 id 102 index 2 nhid 12 id 102 index 3 nhid 12\"\n\tlog_test $? 0 \"Nexthop buckets updated after replace - nECMP\"\n}\n\nipv4_withv6_fcnal()\n{\n\tlocal lladdr\n\n\tset -e\n\tlladdr=$(get_linklocal veth2 peer)\n\trun_cmd \"$IP nexthop add id 11 via ${lladdr} dev veth1\"\n\tset +e\n\trun_cmd \"$IP ro add 172.16.101.1/32 nhid 11\"\n\tlog_test $? 0 \"IPv6 nexthop with IPv4 route\"\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 11 via inet6 ${lladdr} dev veth1\"\n\n\tset -e\n\trun_cmd \"$IP nexthop add id 12 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 group 11/12\"\n\tset +e\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 101\"\n\tlog_test $? 0 \"IPv6 nexthop with IPv4 route\"\n\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 101 nexthop via inet6 ${lladdr} dev veth1 weight 1 nexthop via 172.16.1.2 dev veth1 weight 1\"\n\n\trun_cmd \"$IP ro replace 172.16.101.1/32 via inet6 ${lladdr} dev veth1\"\n\tlog_test $? 0 \"IPv4 route with IPv6 gateway\"\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 via inet6 ${lladdr} dev veth1\"\n\n\trun_cmd \"$IP ro replace 172.16.101.1/32 via inet6 2001:db8:50::1 dev veth1\"\n\tlog_test $? 2 \"IPv4 route with invalid IPv6 gateway\"\n}\n\nipv4_fcnal_runtime()\n{\n\tlocal lladdr\n\tlocal rc\n\n\techo\n\techo \"IPv4 functional runtime\"\n\techo \"-----------------------\"\n\n\trun_cmd \"$IP nexthop add id 21 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP ro add 172.16.101.1/32 nhid 21\"\n\tlog_test $? 0 \"Route add\"\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 21 via 172.16.1.2 dev veth1\"\n\n\trun_cmd \"$IP ro delete 172.16.101.1/32 nhid 21\"\n\tlog_test $? 0 \"Route delete\"\n\n\t#\n\t# scope mismatch\n\t#\n\trun_cmd \"$IP nexthop add id 22 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP ro add 172.16.101.1/32 nhid 22 scope host\"\n\tlog_test $? 2 \"Route add - scope conflict with nexthop\"\n\n\trun_cmd \"$IP nexthop replace id 22 dev veth3\"\n\trun_cmd \"$IP ro add 172.16.101.1/32 nhid 22 scope host\"\n\trun_cmd \"$IP nexthop replace id 22 via 172.16.2.2 dev veth3\"\n\tlog_test $? 2 \"Nexthop replace with invalid scope for existing route\"\n\n\t# check cleanup path on invalid metric\n\trun_cmd \"$IP ro add 172.16.101.2/32 nhid 22 congctl lock foo\"\n\tlog_test $? 2 \"IPv4 route with invalid metric\"\n\n\t#\n\t# add route with nexthop and check traffic\n\t#\n\trun_cmd \"$IP nexthop replace id 21 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 21\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"Basic ping\"\n\n\trun_cmd \"$IP nexthop replace id 22 via 172.16.2.2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 122 group 21/22\"\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 122\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"Ping - multipath\"\n\n\trun_cmd \"$IP ro delete 172.16.101.1/32 nhid 122\"\n\n\t#\n\t# multiple default routes\n\t# - tests fib_select_default\n\trun_cmd \"$IP nexthop add id 501 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP ro add default nhid 501\"\n\trun_cmd \"$IP ro add default via 172.16.1.3 dev veth1 metric 20\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"Ping - multiple default routes, nh first\"\n\n\t# flip the order\n\trun_cmd \"$IP ro del default nhid 501\"\n\trun_cmd \"$IP ro del default via 172.16.1.3 dev veth1 metric 20\"\n\trun_cmd \"$IP ro add default via 172.16.1.2 dev veth1 metric 20\"\n\trun_cmd \"$IP nexthop replace id 501 via 172.16.1.3 dev veth1\"\n\trun_cmd \"$IP ro add default nhid 501 metric 20\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"Ping - multiple default routes, nh second\"\n\n\trun_cmd \"$IP nexthop delete nhid 501\"\n\trun_cmd \"$IP ro del default\"\n\n\t#\n\t# IPv4 with blackhole nexthops\n\t#\n\trun_cmd \"$IP nexthop add id 23 blackhole\"\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 23\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 2 \"Ping - blackhole\"\n\n\trun_cmd \"$IP nexthop replace id 23 via 172.16.1.2 dev veth1\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"Ping - blackhole replaced with gateway\"\n\n\trun_cmd \"$IP nexthop replace id 23 blackhole\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 2 \"Ping - gateway replaced by blackhole\"\n\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 122\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tif [ $? -eq 0 ]; then\n\t\trun_cmd \"$IP nexthop replace id 122 group 23\"\n\t\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\t\tlog_test $? 2 \"Ping - group with blackhole\"\n\n\t\trun_cmd \"$IP nexthop replace id 122 group 21/22\"\n\t\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\t\tlog_test $? 0 \"Ping - group blackhole replaced with gateways\"\n\telse\n\t\tlog_test 2 0 \"Ping - multipath failed\"\n\tfi\n\n\t#\n\t# device only and gw + dev only mix\n\t#\n\trun_cmd \"$IP nexthop add id 85 dev veth1\"\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 85\"\n\tlog_test $? 0 \"IPv4 route with device only nexthop\"\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 85 dev veth1\"\n\n\trun_cmd \"$IP nexthop add id 123 group 21/85\"\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 123\"\n\tlog_test $? 0 \"IPv4 multipath route with nexthop mix - dev only + gw\"\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 123 nexthop via 172.16.1.2 dev veth1 weight 1 nexthop dev veth1 weight 1\"\n\n\t#\n\t# IPv4 with IPv6\n\t#\n\tset -e\n\tlladdr=$(get_linklocal veth2 peer)\n\trun_cmd \"$IP nexthop add id 24 via ${lladdr} dev veth1\"\n\tset +e\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 24\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"IPv6 nexthop with IPv4 route\"\n\n\t$IP neigh sh | grep -q \"${lladdr} dev veth1\"\n\tif [ $? -eq 1 ]; then\n\t\techo \"    WARNING: Neigh entry missing for ${lladdr}\"\n\t\t$IP neigh sh | grep 'dev veth1'\n\tfi\n\n\t$IP neigh sh | grep -q \"172.16.101.1 dev eth1\"\n\tif [ $? -eq 0 ]; then\n\t\techo \"    WARNING: Neigh entry exists for 172.16.101.1\"\n\t\t$IP neigh sh | grep 'dev veth1'\n\tfi\n\n\tset -e\n\trun_cmd \"$IP nexthop add id 25 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 group 24/25\"\n\tset +e\n\trun_cmd \"$IP ro replace 172.16.101.1/32 nhid 101\"\n\tlog_test $? 0 \"IPv4 route with mixed v4-v6 multipath route\"\n\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 101 nexthop via inet6 ${lladdr} dev veth1 weight 1 nexthop via 172.16.1.2 dev veth1 weight 1\"\n\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"IPv6 nexthop with IPv4 route\"\n\n\trun_cmd \"$IP ro replace 172.16.101.1/32 via inet6 ${lladdr} dev veth1\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"IPv4 route with IPv6 gateway\"\n\n\t$IP neigh sh | grep -q \"${lladdr} dev veth1\"\n\tif [ $? -eq 1 ]; then\n\t\techo \"    WARNING: Neigh entry missing for ${lladdr}\"\n\t\t$IP neigh sh | grep 'dev veth1'\n\tfi\n\n\t$IP neigh sh | grep -q \"172.16.101.1 dev eth1\"\n\tif [ $? -eq 0 ]; then\n\t\techo \"    WARNING: Neigh entry exists for 172.16.101.1\"\n\t\t$IP neigh sh | grep 'dev veth1'\n\tfi\n\n\trun_cmd \"$IP ro del 172.16.101.1/32 via inet6 ${lladdr} dev veth1\"\n\trun_cmd \"$IP -4 ro add default via inet6 ${lladdr} dev veth1\"\n\trun_cmd \"ip netns exec me ping -c1 -w$PING_TIMEOUT 172.16.101.1\"\n\tlog_test $? 0 \"IPv4 default route with IPv6 gateway\"\n\n\t#\n\t# MPLS as an example of LWT encap\n\t#\n\trun_cmd \"$IP nexthop add id 51 encap mpls 101 via 172.16.1.2 dev veth1\"\n\tlog_test $? 0 \"IPv4 route with MPLS encap\"\n\tcheck_nexthop \"id 51\" \"id 51 encap mpls 101 via 172.16.1.2 dev veth1 scope link\"\n\tlog_test $? 0 \"IPv4 route with MPLS encap - check\"\n\n\trun_cmd \"$IP nexthop add id 52 encap mpls 102 via inet6 2001:db8:91::2 dev veth1\"\n\tlog_test $? 0 \"IPv4 route with MPLS encap and v6 gateway\"\n\tcheck_nexthop \"id 52\" \"id 52 encap mpls 102 via 2001:db8:91::2 dev veth1 scope link\"\n\tlog_test $? 0 \"IPv4 route with MPLS encap, v6 gw - check\"\n}\n\nipv4_large_grp()\n{\n\tlocal ecmp=32\n\n\techo\n\techo \"IPv4 large groups (x$ecmp)\"\n\techo \"---------------------\"\n\n\tcheck_large_grp 4 $ecmp\n\n\t$IP nexthop flush >/dev/null 2>&1\n}\n\nipv4_large_res_grp()\n{\n\techo\n\techo \"IPv4 large resilient group (128k buckets)\"\n\techo \"-----------------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\tcheck_large_res_grp 4 $((128 * 1024))\n\n\t$IP nexthop flush >/dev/null 2>&1\n}\n\nsysctl_nexthop_compat_mode_check()\n{\n\tlocal sysctlname=\"net.ipv4.nexthop_compat_mode\"\n\tlocal lprefix=$1\n\n\tIPE=\"ip netns exec me\"\n\n\t$IPE sysctl -q $sysctlname 2>&1 >/dev/null\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP: kernel lacks nexthop compat mode sysctl control\"\n\t\treturn $ksft_skip\n\tfi\n\n\tout=$($IPE sysctl $sysctlname 2>/dev/null)\n\tlog_test $? 0 \"$lprefix default nexthop compat mode check\"\n\tcheck_output \"${out}\" \"$sysctlname = 1\"\n}\n\nsysctl_nexthop_compat_mode_set()\n{\n\tlocal sysctlname=\"net.ipv4.nexthop_compat_mode\"\n\tlocal mode=$1\n\tlocal lprefix=$2\n\n\tIPE=\"ip netns exec me\"\n\n\tout=$($IPE sysctl -w $sysctlname=$mode)\n\tlog_test $? 0 \"$lprefix set compat mode - $mode\"\n\tcheck_output \"${out}\" \"net.ipv4.nexthop_compat_mode = $mode\"\n}\n\nipv6_compat_mode()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv6 nexthop api compat mode test\"\n\techo \"--------------------------------\"\n\n\tsysctl_nexthop_compat_mode_check \"IPv6\"\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 122 group 62/63\"\n\tipmout=$(start_ip_monitor route)\n\n\trun_cmd \"$IP -6 ro add 2001:db8:101::1/128 nhid 122\"\n\t# route add notification should contain expanded nexthops\n\tstop_ip_monitor $ipmout 3\n\tlog_test $? 0 \"IPv6 compat mode on - route add notification\"\n\n\t# route dump should contain expanded nexthops\n\tcheck_route6 \"2001:db8:101::1\" \"2001:db8:101::1 nhid 122 metric 1024 nexthop via 2001:db8:91::2 dev veth1 weight 1 nexthop via 2001:db8:91::3 dev veth1 weight 1\"\n\tlog_test $? 0 \"IPv6 compat mode on - route dump\"\n\n\t# change in nexthop group should generate route notification\n\trun_cmd \"$IP nexthop add id 64 via 2001:db8:91::4 dev veth1\"\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP nexthop replace id 122 group 62/64\"\n\tstop_ip_monitor $ipmout 3\n\n\tlog_test $? 0 \"IPv6 compat mode on - nexthop change\"\n\n\t# set compat mode off\n\tsysctl_nexthop_compat_mode_set 0 \"IPv6\"\n\n\trun_cmd \"$IP -6 ro del 2001:db8:101::1/128 nhid 122\"\n\n\trun_cmd \"$IP nexthop add id 62 via 2001:db8:91::2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 63 via 2001:db8:91::3 dev veth1\"\n\trun_cmd \"$IP nexthop add id 122 group 62/63\"\n\tipmout=$(start_ip_monitor route)\n\n\trun_cmd \"$IP -6 ro add 2001:db8:101::1/128 nhid 122\"\n\t# route add notification should not contain expanded nexthops\n\tstop_ip_monitor $ipmout 1\n\tlog_test $? 0 \"IPv6 compat mode off - route add notification\"\n\n\t# route dump should not contain expanded nexthops\n\tcheck_route6 \"2001:db8:101::1\" \"2001:db8:101::1 nhid 122 metric 1024\"\n\tlog_test $? 0 \"IPv6 compat mode off - route dump\"\n\n\t# change in nexthop group should not generate route notification\n\trun_cmd \"$IP nexthop add id 64 via 2001:db8:91::4 dev veth1\"\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP nexthop replace id 122 group 62/64\"\n\tstop_ip_monitor $ipmout 0\n\tlog_test $? 0 \"IPv6 compat mode off - nexthop change\"\n\n\t# nexthop delete should not generate route notification\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP nexthop del id 122\"\n\tstop_ip_monitor $ipmout 0\n\tlog_test $? 0 \"IPv6 compat mode off - nexthop delete\"\n\n\t# set compat mode back on\n\tsysctl_nexthop_compat_mode_set 1 \"IPv6\"\n}\n\nipv4_compat_mode()\n{\n\tlocal rc\n\n\techo\n\techo \"IPv4 nexthop api compat mode\"\n\techo \"----------------------------\"\n\n\tsysctl_nexthop_compat_mode_check \"IPv4\"\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\trun_cmd \"$IP nexthop add id 21 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 22 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 122 group 21/22\"\n\tipmout=$(start_ip_monitor route)\n\n\trun_cmd \"$IP ro add 172.16.101.1/32 nhid 122\"\n\tstop_ip_monitor $ipmout 3\n\n\t# route add notification should contain expanded nexthops\n\tlog_test $? 0 \"IPv4 compat mode on - route add notification\"\n\n\t# route dump should contain expanded nexthops\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 122 nexthop via 172.16.1.2 dev veth1 weight 1 nexthop via 172.16.1.2 dev veth1 weight 1\"\n\tlog_test $? 0 \"IPv4 compat mode on - route dump\"\n\n\t# change in nexthop group should generate route notification\n\trun_cmd \"$IP nexthop add id 23 via 172.16.1.3 dev veth1\"\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP nexthop replace id 122 group 21/23\"\n\tstop_ip_monitor $ipmout 3\n\tlog_test $? 0 \"IPv4 compat mode on - nexthop change\"\n\n\tsysctl_nexthop_compat_mode_set 0 \"IPv4\"\n\n\t# cleanup\n\trun_cmd \"$IP ro del 172.16.101.1/32 nhid 122\"\n\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP ro add 172.16.101.1/32 nhid 122\"\n\tstop_ip_monitor $ipmout 1\n\t# route add notification should not contain expanded nexthops\n\tlog_test $? 0 \"IPv4 compat mode off - route add notification\"\n\n\t# route dump should not contain expanded nexthops\n\tcheck_route \"172.16.101.1\" \"172.16.101.1 nhid 122\"\n\tlog_test $? 0 \"IPv4 compat mode off - route dump\"\n\n\t# change in nexthop group should not generate route notification\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP nexthop replace id 122 group 21/22\"\n\tstop_ip_monitor $ipmout 0\n\tlog_test $? 0 \"IPv4 compat mode off - nexthop change\"\n\n\t# nexthop delete should not generate route notification\n\tipmout=$(start_ip_monitor route)\n\trun_cmd \"$IP nexthop del id 122\"\n\tstop_ip_monitor $ipmout 0\n\tlog_test $? 0 \"IPv4 compat mode off - nexthop delete\"\n\n\tsysctl_nexthop_compat_mode_set 1 \"IPv4\"\n}\n\nipv4_del_add_loop1()\n{\n\twhile :; do\n\t\t$IP nexthop del id 100\n\t\t$IP nexthop add id 100 via 172.16.1.2 dev veth1\n\tdone >/dev/null 2>&1\n}\n\nipv4_grp_replace_loop()\n{\n\twhile :; do\n\t\t$IP nexthop replace id 102 group 100/101\n\tdone >/dev/null 2>&1\n}\n\nipv4_torture()\n{\n\tlocal pid1\n\tlocal pid2\n\tlocal pid3\n\tlocal pid4\n\tlocal pid5\n\n\techo\n\techo \"IPv4 runtime torture\"\n\techo \"--------------------\"\n\tif [ ! -x \"$(command -v mausezahn)\" ]; then\n\t\techo \"SKIP: Could not run test; need mausezahn tool\"\n\t\treturn\n\tfi\n\n\trun_cmd \"$IP nexthop add id 100 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 via 172.16.2.2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 102 group 100/101\"\n\trun_cmd \"$IP route add 172.16.101.1 nhid 102\"\n\trun_cmd \"$IP route add 172.16.101.2 nhid 102\"\n\n\tipv4_del_add_loop1 &\n\tpid1=$!\n\tipv4_grp_replace_loop &\n\tpid2=$!\n\tip netns exec me ping -f 172.16.101.1 >/dev/null 2>&1 &\n\tpid3=$!\n\tip netns exec me ping -f 172.16.101.2 >/dev/null 2>&1 &\n\tpid4=$!\n\tip netns exec me mausezahn veth1 -B 172.16.101.2 -A 172.16.1.1 -c 0 -t tcp \"dp=1-1023, flags=syn\" >/dev/null 2>&1 &\n\tpid5=$!\n\n\tsleep 300\n\tkill -9 $pid1 $pid2 $pid3 $pid4 $pid5\n\twait $pid1 $pid2 $pid3 $pid4 $pid5 2>/dev/null\n\n\t# if we did not crash, success\n\tlog_test 0 0 \"IPv4 torture test\"\n}\n\nipv4_res_grp_replace_loop()\n{\n\twhile :; do\n\t\t$IP nexthop replace id 102 group 100/101 type resilient\n\tdone >/dev/null 2>&1\n}\n\nipv4_res_torture()\n{\n\tlocal pid1\n\tlocal pid2\n\tlocal pid3\n\tlocal pid4\n\tlocal pid5\n\n\techo\n\techo \"IPv4 runtime resilient nexthop group torture\"\n\techo \"--------------------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\tif [ ! -x \"$(command -v mausezahn)\" ]; then\n\t\techo \"SKIP: Could not run test; need mausezahn tool\"\n\t\treturn\n\tfi\n\n\trun_cmd \"$IP nexthop add id 100 via 172.16.1.2 dev veth1\"\n\trun_cmd \"$IP nexthop add id 101 via 172.16.2.2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 102 group 100/101 type resilient buckets 512 idle_timer 0\"\n\trun_cmd \"$IP route add 172.16.101.1 nhid 102\"\n\trun_cmd \"$IP route add 172.16.101.2 nhid 102\"\n\n\tipv4_del_add_loop1 &\n\tpid1=$!\n\tipv4_res_grp_replace_loop &\n\tpid2=$!\n\tip netns exec me ping -f 172.16.101.1 >/dev/null 2>&1 &\n\tpid3=$!\n\tip netns exec me ping -f 172.16.101.2 >/dev/null 2>&1 &\n\tpid4=$!\n\tip netns exec me mausezahn veth1 \\\n\t\t\t\t-B 172.16.101.2 -A 172.16.1.1 -c 0 \\\n\t\t\t\t-t tcp \"dp=1-1023, flags=syn\" >/dev/null 2>&1 &\n\tpid5=$!\n\n\tsleep 300\n\tkill -9 $pid1 $pid2 $pid3 $pid4 $pid5\n\twait $pid1 $pid2 $pid3 $pid4 $pid5 2>/dev/null\n\n\t# if we did not crash, success\n\tlog_test 0 0 \"IPv4 resilient nexthop group torture test\"\n}\n\nbasic()\n{\n\techo\n\techo \"Basic functional tests\"\n\techo \"----------------------\"\n\trun_cmd \"$IP nexthop ls\"\n\tlog_test $? 0 \"List with nothing defined\"\n\n\trun_cmd \"$IP nexthop get id 1\"\n\tlog_test $? 2 \"Nexthop get on non-existent id\"\n\n\t# attempt to create nh without a device or gw - fails\n\trun_cmd \"$IP nexthop add id 1\"\n\tlog_test $? 2 \"Nexthop with no device or gateway\"\n\n\t# attempt to create nh with down device - fails\n\t$IP li set veth1 down\n\trun_cmd \"$IP nexthop add id 1 dev veth1\"\n\tlog_test $? 2 \"Nexthop with down device\"\n\n\t# create nh with linkdown device - fails\n\t$IP li set veth1 up\n\tip -netns peer li set veth2 down\n\trun_cmd \"$IP nexthop add id 1 dev veth1\"\n\tlog_test $? 2 \"Nexthop with device that is linkdown\"\n\tip -netns peer li set veth2 up\n\n\t# device only\n\trun_cmd \"$IP nexthop add id 1 dev veth1\"\n\tlog_test $? 0 \"Nexthop with device only\"\n\n\t# create nh with duplicate id\n\trun_cmd \"$IP nexthop add id 1 dev veth3\"\n\tlog_test $? 2 \"Nexthop with duplicate id\"\n\n\t# blackhole nexthop\n\trun_cmd \"$IP nexthop add id 2 blackhole\"\n\tlog_test $? 0 \"Blackhole nexthop\"\n\n\t# blackhole nexthop can not have other specs\n\trun_cmd \"$IP nexthop replace id 2 blackhole dev veth1\"\n\tlog_test $? 2 \"Blackhole nexthop with other attributes\"\n\n\t# blackhole nexthop should not be affected by the state of the loopback\n\t# device\n\trun_cmd \"$IP link set dev lo down\"\n\tcheck_nexthop \"id 2\" \"id 2 blackhole\"\n\tlog_test $? 0 \"Blackhole nexthop with loopback device down\"\n\n\trun_cmd \"$IP link set dev lo up\"\n\n\t# Dump should not loop endlessly when maximum nexthop ID is configured.\n\trun_cmd \"$IP nexthop add id $((2**32-1)) blackhole\"\n\trun_cmd \"timeout 5 $IP nexthop\"\n\tlog_test $? 0 \"Maximum nexthop ID dump\"\n\n\t#\n\t# groups\n\t#\n\n\trun_cmd \"$IP nexthop add id 101 group 1\"\n\tlog_test $? 0 \"Create group\"\n\n\trun_cmd \"$IP nexthop add id 102 group 2\"\n\tlog_test $? 0 \"Create group with blackhole nexthop\"\n\n\t# multipath group can not have a blackhole as 1 path\n\trun_cmd \"$IP nexthop add id 103 group 1/2\"\n\tlog_test $? 2 \"Create multipath group where 1 path is a blackhole\"\n\n\t# multipath group can not have a member replaced by a blackhole\n\trun_cmd \"$IP nexthop replace id 2 dev veth3\"\n\trun_cmd \"$IP nexthop replace id 102 group 1/2\"\n\trun_cmd \"$IP nexthop replace id 2 blackhole\"\n\tlog_test $? 2 \"Multipath group can not have a member replaced by blackhole\"\n\n\t# attempt to create group with non-existent nexthop\n\trun_cmd \"$IP nexthop add id 103 group 12\"\n\tlog_test $? 2 \"Create group with non-existent nexthop\"\n\n\t# attempt to create group with same nexthop\n\trun_cmd \"$IP nexthop add id 103 group 1/1\"\n\tlog_test $? 2 \"Create group with same nexthop multiple times\"\n\n\t# replace nexthop with a group - fails\n\trun_cmd \"$IP nexthop replace id 2 group 1\"\n\tlog_test $? 2 \"Replace nexthop with nexthop group\"\n\n\t# replace nexthop group with a nexthop - fails\n\trun_cmd \"$IP nexthop replace id 101 dev veth1\"\n\tlog_test $? 2 \"Replace nexthop group with nexthop\"\n\n\t# nexthop group with other attributes fail\n\trun_cmd \"$IP nexthop add id 104 group 1 dev veth1\"\n\tlog_test $? 2 \"Nexthop group and device\"\n\n\t# Tests to ensure that flushing works as expected.\n\trun_cmd \"$IP nexthop add id 105 blackhole proto 99\"\n\trun_cmd \"$IP nexthop add id 106 blackhole proto 100\"\n\trun_cmd \"$IP nexthop add id 107 blackhole proto 99\"\n\trun_cmd \"$IP nexthop flush proto 99\"\n\tcheck_nexthop \"id 105\" \"\"\n\tcheck_nexthop \"id 106\" \"id 106 blackhole proto 100\"\n\tcheck_nexthop \"id 107\" \"\"\n\trun_cmd \"$IP nexthop flush proto 100\"\n\tcheck_nexthop \"id 106\" \"\"\n\n\trun_cmd \"$IP nexthop flush proto 100\"\n\tlog_test $? 0 \"Test proto flush\"\n\n\trun_cmd \"$IP nexthop add id 104 group 1 blackhole\"\n\tlog_test $? 2 \"Nexthop group and blackhole\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\t# Test to ensure that flushing with a multi-part nexthop dump works as\n\t# expected.\n\tlocal batch_file=$(mktemp)\n\n\tfor i in $(seq 1 $((64 * 1024))); do\n\t\techo \"nexthop add id $i blackhole\" >> $batch_file\n\tdone\n\n\t$IP -b $batch_file\n\t$IP nexthop flush >/dev/null 2>&1\n\t[[ $($IP nexthop | wc -l) -eq 0 ]]\n\tlog_test $? 0 \"Large scale nexthop flushing\"\n\n\trm $batch_file\n}\n\ncheck_nexthop_buckets_balance()\n{\n\tlocal nharg=$1; shift\n\tlocal ret\n\n\twhile (($# > 0)); do\n\t\tlocal selector=$1; shift\n\t\tlocal condition=$1; shift\n\t\tlocal count\n\n\t\tcount=$($IP -j nexthop bucket ${nharg} ${selector} | jq length)\n\t\t(( $count $condition ))\n\t\tret=$?\n\t\tif ((ret != 0)); then\n\t\t\treturn $ret\n\t\tfi\n\tdone\n\n\treturn 0\n}\n\nbasic_res()\n{\n\techo\n\techo \"Basic resilient nexthop group functional tests\"\n\techo \"----------------------------------------------\"\n\n\tcheck_nexthop_res_support\n\tif [ $? -eq $ksft_skip ]; then\n\t\treturn $ksft_skip\n\tfi\n\n\trun_cmd \"$IP nexthop add id 1 dev veth1\"\n\n\t#\n\t# resilient nexthop group addition\n\t#\n\n\trun_cmd \"$IP nexthop add id 101 group 1 type resilient buckets 8\"\n\tlog_test $? 0 \"Add a nexthop group with default parameters\"\n\n\trun_cmd \"$IP nexthop get id 101\"\n\tcheck_nexthop \"id 101\" \\\n\t\t\"id 101 group 1 type resilient buckets 8 idle_timer 120 unbalanced_timer 0 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group with default parameters\"\n\n\trun_cmd \"$IP nexthop add id 102 group 1 type resilient\n\t\t\tbuckets 4 idle_timer 100 unbalanced_timer 5\"\n\trun_cmd \"$IP nexthop get id 102\"\n\tcheck_nexthop \"id 102\" \\\n\t\t\"id 102 group 1 type resilient buckets 4 idle_timer 100 unbalanced_timer 5 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group with non-default parameters\"\n\n\trun_cmd \"$IP nexthop add id 103 group 1 type resilient buckets 0\"\n\tlog_test $? 2 \"Add a nexthop group with 0 buckets\"\n\n\t#\n\t# resilient nexthop group replacement\n\t#\n\n\trun_cmd \"$IP nexthop replace id 101 group 1 type resilient\n\t\t\tbuckets 8 idle_timer 240 unbalanced_timer 80\"\n\tlog_test $? 0 \"Replace nexthop group parameters\"\n\tcheck_nexthop \"id 101\" \\\n\t\t\"id 101 group 1 type resilient buckets 8 idle_timer 240 unbalanced_timer 80 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group after replacing parameters\"\n\n\trun_cmd \"$IP nexthop replace id 101 group 1 type resilient idle_timer 512\"\n\tlog_test $? 0 \"Replace idle timer\"\n\tcheck_nexthop \"id 101\" \\\n\t\t\"id 101 group 1 type resilient buckets 8 idle_timer 512 unbalanced_timer 80 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group after replacing idle timer\"\n\n\trun_cmd \"$IP nexthop replace id 101 group 1 type resilient unbalanced_timer 256\"\n\tlog_test $? 0 \"Replace unbalanced timer\"\n\tcheck_nexthop \"id 101\" \\\n\t\t\"id 101 group 1 type resilient buckets 8 idle_timer 512 unbalanced_timer 256 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group after replacing unbalanced timer\"\n\n\trun_cmd \"$IP nexthop replace id 101 group 1 type resilient\"\n\tlog_test $? 0 \"Replace with no parameters\"\n\tcheck_nexthop \"id 101\" \\\n\t\t\"id 101 group 1 type resilient buckets 8 idle_timer 512 unbalanced_timer 256 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group after replacing no parameters\"\n\n\trun_cmd \"$IP nexthop replace id 101 group 1\"\n\tlog_test $? 2 \"Replace nexthop group type - implicit\"\n\n\trun_cmd \"$IP nexthop replace id 101 group 1 type mpath\"\n\tlog_test $? 2 \"Replace nexthop group type - explicit\"\n\n\trun_cmd \"$IP nexthop replace id 101 group 1 type resilient buckets 1024\"\n\tlog_test $? 2 \"Replace number of nexthop buckets\"\n\n\tcheck_nexthop \"id 101\" \\\n\t\t\"id 101 group 1 type resilient buckets 8 idle_timer 512 unbalanced_timer 256 unbalanced_time 0\"\n\tlog_test $? 0 \"Get a nexthop group after replacing with invalid parameters\"\n\n\t#\n\t# resilient nexthop buckets dump\n\t#\n\n\t$IP nexthop flush >/dev/null 2>&1\n\trun_cmd \"$IP nexthop add id 1 dev veth1\"\n\trun_cmd \"$IP nexthop add id 2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 101 group 1/2 type resilient buckets 4\"\n\trun_cmd \"$IP nexthop add id 201 group 1/2\"\n\n\tcheck_nexthop_bucket \"\" \\\n\t\t\"id 101 index 0 nhid 2 id 101 index 1 nhid 2 id 101 index 2 nhid 1 id 101 index 3 nhid 1\"\n\tlog_test $? 0 \"Dump all nexthop buckets\"\n\n\tcheck_nexthop_bucket \"list id 101\" \\\n\t\t\"id 101 index 0 nhid 2 id 101 index 1 nhid 2 id 101 index 2 nhid 1 id 101 index 3 nhid 1\"\n\tlog_test $? 0 \"Dump all nexthop buckets in a group\"\n\n\tsleep 0.1\n\t(( $($IP -j nexthop bucket list id 101 |\n\t     jq '[.[] | select(.bucket.idle_time > 0 and\n\t                       .bucket.idle_time < 2)] | length') == 4 ))\n\tlog_test $? 0 \"All nexthop buckets report a positive near-zero idle time\"\n\n\tcheck_nexthop_bucket \"list dev veth1\" \\\n\t\t\"id 101 index 2 nhid 1 id 101 index 3 nhid 1\"\n\tlog_test $? 0 \"Dump all nexthop buckets with a specific nexthop device\"\n\n\tcheck_nexthop_bucket \"list nhid 2\" \\\n\t\t\"id 101 index 0 nhid 2 id 101 index 1 nhid 2\"\n\tlog_test $? 0 \"Dump all nexthop buckets with a specific nexthop identifier\"\n\n\trun_cmd \"$IP nexthop bucket list id 111\"\n\tlog_test $? 2 \"Dump all nexthop buckets in a non-existent group\"\n\n\trun_cmd \"$IP nexthop bucket list id 201\"\n\tlog_test $? 2 \"Dump all nexthop buckets in a non-resilient group\"\n\n\trun_cmd \"$IP nexthop bucket list dev bla\"\n\tlog_test $? 255 \"Dump all nexthop buckets using a non-existent device\"\n\n\trun_cmd \"$IP nexthop bucket list groups\"\n\tlog_test $? 255 \"Dump all nexthop buckets with invalid 'groups' keyword\"\n\n\trun_cmd \"$IP nexthop bucket list fdb\"\n\tlog_test $? 255 \"Dump all nexthop buckets with invalid 'fdb' keyword\"\n\n\t# Dump should not loop endlessly when maximum nexthop ID is configured.\n\trun_cmd \"$IP nexthop add id $((2**32-1)) group 1/2 type resilient buckets 4\"\n\trun_cmd \"timeout 5 $IP nexthop bucket\"\n\tlog_test $? 0 \"Maximum nexthop ID dump\"\n\n\t#\n\t# resilient nexthop buckets get requests\n\t#\n\n\tcheck_nexthop_bucket \"get id 101 index 0\" \"id 101 index 0 nhid 2\"\n\tlog_test $? 0 \"Get a valid nexthop bucket\"\n\n\trun_cmd \"$IP nexthop bucket get id 101 index 999\"\n\tlog_test $? 2 \"Get a nexthop bucket with valid group, but invalid index\"\n\n\trun_cmd \"$IP nexthop bucket get id 201 index 0\"\n\tlog_test $? 2 \"Get a nexthop bucket from a non-resilient group\"\n\n\trun_cmd \"$IP nexthop bucket get id 999 index 0\"\n\tlog_test $? 2 \"Get a nexthop bucket from a non-existent group\"\n\n\t#\n\t# tests for bucket migration\n\t#\n\n\t$IP nexthop flush >/dev/null 2>&1\n\n\trun_cmd \"$IP nexthop add id 1 dev veth1\"\n\trun_cmd \"$IP nexthop add id 2 dev veth3\"\n\trun_cmd \"$IP nexthop add id 101\n\t\t\tgroup 1/2 type resilient buckets 10\n\t\t\tidle_timer 1 unbalanced_timer 20\"\n\n\tcheck_nexthop_buckets_balance \"list id 101\" \\\n\t\t\t\t      \"nhid 1\" \"== 5\" \\\n\t\t\t\t      \"nhid 2\" \"== 5\"\n\tlog_test $? 0 \"Initial bucket allocation\"\n\n\trun_cmd \"$IP nexthop replace id 101\n\t\t\tgroup 1,2/2,3 type resilient\"\n\tcheck_nexthop_buckets_balance \"list id 101\" \\\n\t\t\t\t      \"nhid 1\" \"== 4\" \\\n\t\t\t\t      \"nhid 2\" \"== 6\"\n\tlog_test $? 0 \"Bucket allocation after replace\"\n\n\t# Check that increase in idle timer does not make buckets appear busy.\n\trun_cmd \"$IP nexthop replace id 101\n\t\t\tgroup 1,2/2,3 type resilient\n\t\t\tidle_timer 10\"\n\trun_cmd \"$IP nexthop replace id 101\n\t\t\tgroup 1/2 type resilient\"\n\tcheck_nexthop_buckets_balance \"list id 101\" \\\n\t\t\t\t      \"nhid 1\" \"== 5\" \\\n\t\t\t\t      \"nhid 2\" \"== 5\"\n\tlog_test $? 0 \"Buckets migrated after idle timer change\"\n\n\t$IP nexthop flush >/dev/null 2>&1\n}\n\n################################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $ALL_TESTS)\n        -4          IPv4 tests only\n        -6          IPv6 tests only\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\n        -v          verbose mode (show commands and output)\n\t-w\t    Timeout for ping\n\n    Runtime test\n\t-n num\t    Number of nexthops to target\n\t-N    \t    Use new style to install routes in DUT\n\ndone\nEOF\n}\n\n################################################################################\n# main\n\nwhile getopts :t:pP46hvw: o\ndo\n\tcase $o in\n\t\tt) TESTS=$OPTARG;;\n\t\t4) TESTS=${IPV4_TESTS};;\n\t\t6) TESTS=${IPV6_TESTS};;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\tw) PING_TIMEOUT=$OPTARG;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# make sure we don't pause twice\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nip help 2>&1 | grep -q nexthop\nif [ $? -ne 0 ]; then\n\techo \"SKIP: iproute2 too old, missing nexthop command\"\n\texit $ksft_skip\nfi\n\nout=$(ip nexthop ls 2>&1 | grep -q \"Operation not supported\")\nif [ $? -eq 0 ]; then\n\techo \"SKIP: kernel lacks nexthop support\"\n\texit $ksft_skip\nfi\n\nfor t in $TESTS\ndo\n\tcase $t in\n\tnone) IP=\"ip -netns peer\"; setup; exit 0;;\n\t*) setup; $t; cleanup;;\n\tesac\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}