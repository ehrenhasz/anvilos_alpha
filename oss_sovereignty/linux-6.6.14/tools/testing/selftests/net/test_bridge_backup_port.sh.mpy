{
  "module_name": "test_bridge_backup_port.sh",
  "hash_id": "bc21fc58ffe2b37f35bfe8e48e30abb2daf86db74f3e658d06597b05101d9344",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/test_bridge_backup_port.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking bridge backup port and backup nexthop ID\n# functionality. The topology consists of two bridge (VTEPs) connected using\n# VXLAN. The test checks that when the switch port (swp1) is down, traffic is\n# redirected to the VXLAN port (vx0). When a backup nexthop ID is configured,\n# the test checks that traffic is redirected with the correct nexthop\n# information.\n#\n# +------------------------------------+ +------------------------------------+\n# |    + swp1                   + vx0  | |    + swp1                   + vx0  |\n# |    |                        |      | |    |                        |      |\n# |    |           br0          |      | |    |                        |      |\n# |    +------------+-----------+      | |    +------------+-----------+      |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |                 +                  | |                 +                  |\n# |                br0                 | |                br0                 |\n# |                 +                  | |                 +                  |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |                 +                  | |                 +                  |\n# |              br0.10                | |              br0.10                |\n# |           192.0.2.65/28            | |            192.0.2.66/28           |\n# |                                    | |                                    |\n# |                                    | |                                    |\n# |                 192.0.2.33         | |                 192.0.2.34         |\n# |                 + lo               | |                 + lo               |\n# |                                    | |                                    |\n# |                                    | |                                    |\n# |                   192.0.2.49/28    | |    192.0.2.50/28                   |\n# |                           veth0 +-------+ veth0                           |\n# |                                    | |                                    |\n# | sw1                                | | sw2                                |\n# +------------------------------------+ +------------------------------------+\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# All tests in this script. Can be overridden with -t option.\nTESTS=\"\n\tbackup_port\n\tbackup_nhid\n\tbackup_nhid_invalid\n\tbackup_nhid_ping\n\tbackup_nhid_torture\n\"\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\nPING_TIMEOUT=5\n\n################################################################################\n# Utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\t\techo \"    rc=$rc, expected $expected\"\n\t\tfi\n\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$1\"\n\tlocal out\n\tlocal stderr=\"2>/dev/null\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"COMMAND: $cmd\\n\"\n\t\tstderr=\n\tfi\n\n\tout=$(eval $cmd $stderr)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\treturn $rc\n}\n\ntc_check_packets()\n{\n\tlocal ns=$1; shift\n\tlocal id=$1; shift\n\tlocal handle=$1; shift\n\tlocal count=$1; shift\n\tlocal pkts\n\n\tsleep 0.1\n\tpkts=$(tc -n $ns -j -s filter show $id \\\n\t\t| jq \".[] | select(.options.handle == $handle) | \\\n\t\t.options.actions[0].stats.packets\")\n\t[[ $pkts == $count ]]\n}\n\n################################################################################\n# Setup\n\nsetup_topo_ns()\n{\n\tlocal ns=$1; shift\n\n\tip netns add $ns\n\tip -n $ns link set dev lo up\n\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.ignore_routes_with_linkdown=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.accept_dad=0\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.accept_dad=0\n}\n\nsetup_topo()\n{\n\tlocal ns\n\n\tfor ns in sw1 sw2; do\n\t\tsetup_topo_ns $ns\n\tdone\n\n\tip link add name veth0 type veth peer name veth1\n\tip link set dev veth0 netns sw1 name veth0\n\tip link set dev veth1 netns sw2 name veth0\n}\n\nsetup_sw_common()\n{\n\tlocal ns=$1; shift\n\tlocal local_addr=$1; shift\n\tlocal remote_addr=$1; shift\n\tlocal veth_addr=$1; shift\n\tlocal gw_addr=$1; shift\n\tlocal br_addr=$1; shift\n\n\tip -n $ns address add $local_addr/32 dev lo\n\n\tip -n $ns link set dev veth0 up\n\tip -n $ns address add $veth_addr/28 dev veth0\n\tip -n $ns route add default via $gw_addr\n\n\tip -n $ns link add name br0 up type bridge vlan_filtering 1 \\\n\t\tvlan_default_pvid 0 mcast_snooping 0\n\n\tip -n $ns link add link br0 name br0.10 up type vlan id 10\n\tbridge -n $ns vlan add vid 10 dev br0 self\n\tip -n $ns address add $br_addr/28 dev br0.10\n\n\tip -n $ns link add name swp1 up type dummy\n\tip -n $ns link set dev swp1 master br0\n\tbridge -n $ns vlan add vid 10 dev swp1 untagged\n\n\tip -n $ns link add name vx0 up master br0 type vxlan \\\n\t\tlocal $local_addr dstport 4789 nolearning external\n\tbridge -n $ns link set dev vx0 vlan_tunnel on learning off\n\n\tbridge -n $ns vlan add vid 10 dev vx0\n\tbridge -n $ns vlan add vid 10 dev vx0 tunnel_info id 10010\n}\n\nsetup_sw1()\n{\n\tlocal ns=sw1\n\tlocal local_addr=192.0.2.33\n\tlocal remote_addr=192.0.2.34\n\tlocal veth_addr=192.0.2.49\n\tlocal gw_addr=192.0.2.50\n\tlocal br_addr=192.0.2.65\n\n\tsetup_sw_common $ns $local_addr $remote_addr $veth_addr $gw_addr \\\n\t\t$br_addr\n}\n\nsetup_sw2()\n{\n\tlocal ns=sw2\n\tlocal local_addr=192.0.2.34\n\tlocal remote_addr=192.0.2.33\n\tlocal veth_addr=192.0.2.50\n\tlocal gw_addr=192.0.2.49\n\tlocal br_addr=192.0.2.66\n\n\tsetup_sw_common $ns $local_addr $remote_addr $veth_addr $gw_addr \\\n\t\t$br_addr\n}\n\nsetup()\n{\n\tset -e\n\n\tsetup_topo\n\tsetup_sw1\n\tsetup_sw2\n\n\tsleep 5\n\n\tset +e\n}\n\ncleanup()\n{\n\tlocal ns\n\n\tfor ns in h1 h2 sw1 sw2; do\n\t\tip netns del $ns &> /dev/null\n\tdone\n}\n\n################################################################################\n# Tests\n\nbackup_port()\n{\n\tlocal dmac=00:11:22:33:44:55\n\tlocal smac=00:aa:bb:cc:dd:ee\n\n\techo\n\techo \"Backup port\"\n\techo \"-----------\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev swp1 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev swp1 egress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac action pass\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac action pass\"\n\n\trun_cmd \"bridge -n sw1 fdb replace $dmac dev swp1 master static vlan 10\"\n\n\t# Initial state - check that packets are forwarded out of swp1 when it\n\t# has a carrier and not forwarded out of any port when it does not have\n\t# a carrier.\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 1\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 1\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier on\"\n\tlog_test $? 0 \"swp1 carrier on\"\n\n\t# Configure vx0 as the backup port of swp1 and check that packets are\n\t# forwarded out of swp1 when it has a carrier and out of vx0 when swp1\n\t# does not have a carrier.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_port vx0\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_port vx0\\\"\"\n\tlog_test $? 0 \"vx0 configured as backup port of swp1\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 2\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 2\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier on\"\n\tlog_test $? 0 \"swp1 carrier on\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 3\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\t# Remove vx0 as the backup port of swp1 and check that packets are no\n\t# longer forwarded out of vx0 when swp1 does not have a carrier.\n\trun_cmd \"bridge -n sw1 link set dev swp1 nobackup_port\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_port vx0\\\"\"\n\tlog_test $? 1 \"vx0 not configured as backup port of swp1\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 4\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 4\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"No forwarding out of vx0\"\n}\n\nbackup_nhid()\n{\n\tlocal dmac=00:11:22:33:44:55\n\tlocal smac=00:aa:bb:cc:dd:ee\n\n\techo\n\techo \"Backup nexthop ID\"\n\techo \"-----------------\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev swp1 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev swp1 egress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac action pass\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac action pass\"\n\n\trun_cmd \"ip -n sw1 nexthop replace id 1 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 2 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 10 group 1/2 fdb\"\n\n\trun_cmd \"bridge -n sw1 fdb replace $dmac dev swp1 master static vlan 10\"\n\trun_cmd \"bridge -n sw1 fdb replace $dmac dev vx0 self static dst 192.0.2.36 src_vni 10010\"\n\n\trun_cmd \"ip -n sw2 address replace 192.0.2.36/32 dev lo\"\n\n\t# The first filter matches on packets forwarded using the backup\n\t# nexthop ID and the second filter matches on packets forwarded using a\n\t# regular VXLAN FDB entry.\n\trun_cmd \"tc -n sw2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw2 filter replace dev vx0 ingress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac enc_key_id 10010 enc_dst_ip 192.0.2.34 action pass\"\n\trun_cmd \"tc -n sw2 filter replace dev vx0 ingress pref 1 handle 102 proto ip flower src_mac $smac dst_mac $dmac enc_key_id 10010 enc_dst_ip 192.0.2.36 action pass\"\n\n\t# Configure vx0 as the backup port of swp1 and check that packets are\n\t# forwarded out of swp1 when it has a carrier and out of vx0 when swp1\n\t# does not have a carrier. When packets are forwarded out of vx0, check\n\t# that they are forwarded by the VXLAN FDB entry.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_port vx0\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_port vx0\\\"\"\n\tlog_test $? 0 \"vx0 configured as backup port of swp1\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 1\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 1\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 0\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Forwarding using VXLAN FDB entry\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier on\"\n\tlog_test $? 0 \"swp1 carrier on\"\n\n\t# Configure nexthop ID 10 as the backup nexthop ID of swp1 and check\n\t# that when packets are forwarded out of vx0, they are forwarded using\n\t# the backup nexthop ID.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 10\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid 10\\\"\"\n\tlog_test $? 0 \"nexthop ID 10 configured as backup nexthop ID of swp1\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 2\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 2\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Forwarding using backup nexthop ID\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"No forwarding using VXLAN FDB entry\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier on\"\n\tlog_test $? 0 \"swp1 carrier on\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 3\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"No forwarding using VXLAN FDB entry\"\n\n\t# Reset the backup nexthop ID to 0 and check that packets are no longer\n\t# forwarded using the backup nexthop ID when swp1 does not have a\n\t# carrier and are instead forwarded by the VXLAN FDB.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 0\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid\\\"\"\n\tlog_test $? 1 \"No backup nexthop ID configured for swp1\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 4\n\tlog_test $? 0 \"Forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"No forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"No forwarding using VXLAN FDB entry\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 4\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 102 2\n\tlog_test $? 0 \"Forwarding using VXLAN FDB entry\"\n}\n\nbackup_nhid_invalid()\n{\n\tlocal dmac=00:11:22:33:44:55\n\tlocal smac=00:aa:bb:cc:dd:ee\n\tlocal tx_drop\n\n\techo\n\techo \"Backup nexthop ID - invalid IDs\"\n\techo \"-------------------------------\"\n\n\t# Check that when traffic is redirected with an invalid nexthop ID, it\n\t# is forwarded out of the VXLAN port, but dropped by the VXLAN driver\n\t# and does not crash the host.\n\n\trun_cmd \"tc -n sw1 qdisc replace dev swp1 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev swp1 egress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac action pass\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac action pass\"\n\t# Drop all other Tx traffic to avoid changes to Tx drop counter.\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 2 handle 102 proto all matchall action drop\"\n\n\ttx_drop=$(ip -n sw1 -s -j link show dev vx0 | jq '.[][\"stats64\"][\"tx\"][\"dropped\"]')\n\n\trun_cmd \"ip -n sw1 nexthop replace id 1 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 2 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 10 group 1/2 fdb\"\n\n\trun_cmd \"bridge -n sw1 fdb replace $dmac dev swp1 master static vlan 10\"\n\n\trun_cmd \"tc -n sw2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw2 filter replace dev vx0 ingress pref 1 handle 101 proto ip flower src_mac $smac dst_mac $dmac enc_key_id 10010 enc_dst_ip 192.0.2.34 action pass\"\n\n\t# First, check that redirection works.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_port vx0\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_port vx0\\\"\"\n\tlog_test $? 0 \"vx0 configured as backup port of swp1\"\n\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 10\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid 10\\\"\"\n\tlog_test $? 0 \"Valid nexthop as backup nexthop\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\tlog_test $? 0 \"swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Forwarding using backup nexthop ID\"\n\trun_cmd \"ip -n sw1 -s -j link show dev vx0 | jq -e '.[][\\\"stats64\\\"][\\\"tx\\\"][\\\"dropped\\\"] == $tx_drop'\"\n\tlog_test $? 0 \"No Tx drop increase\"\n\n\t# Use a non-existent nexthop ID.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 20\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid 20\\\"\"\n\tlog_test $? 0 \"Non-existent nexthop as backup nexthop\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\trun_cmd \"ip -n sw1 -s -j link show dev vx0 | jq -e '.[][\\\"stats64\\\"][\\\"tx\\\"][\\\"dropped\\\"] == $((tx_drop + 1))'\"\n\tlog_test $? 0 \"Tx drop increased\"\n\n\t# Use a blckhole nexthop.\n\trun_cmd \"ip -n sw1 nexthop replace id 30 blackhole\"\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 30\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid 30\\\"\"\n\tlog_test $? 0 \"Blackhole nexthop as backup nexthop\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\trun_cmd \"ip -n sw1 -s -j link show dev vx0 | jq -e '.[][\\\"stats64\\\"][\\\"tx\\\"][\\\"dropped\\\"] == $((tx_drop + 2))'\"\n\tlog_test $? 0 \"Tx drop increased\"\n\n\t# Non-group FDB nexthop.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 1\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid 1\\\"\"\n\tlog_test $? 0 \"Non-group FDB nexthop as backup nexthop\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 4\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\trun_cmd \"ip -n sw1 -s -j link show dev vx0 | jq -e '.[][\\\"stats64\\\"][\\\"tx\\\"][\\\"dropped\\\"] == $((tx_drop + 3))'\"\n\tlog_test $? 0 \"Tx drop increased\"\n\n\t# IPv6 address family nexthop.\n\trun_cmd \"ip -n sw1 nexthop replace id 100 via 2001:db8:100::1 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 200 via 2001:db8:100::1 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 300 group 100/200 fdb\"\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 300\"\n\trun_cmd \"bridge -n sw1 -d link show dev swp1 | grep \\\"backup_nhid 300\\\"\"\n\tlog_test $? 0 \"IPv6 address family nexthop as backup nexthop\"\n\n\trun_cmd \"ip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 1\"\n\ttc_check_packets sw1 \"dev swp1 egress\" 101 0\n\tlog_test $? 0 \"No forwarding out of swp1\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 5\n\tlog_test $? 0 \"Forwarding out of vx0\"\n\ttc_check_packets sw2 \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"No forwarding using backup nexthop ID\"\n\trun_cmd \"ip -n sw1 -s -j link show dev vx0 | jq -e '.[][\\\"stats64\\\"][\\\"tx\\\"][\\\"dropped\\\"] == $((tx_drop + 4))'\"\n\tlog_test $? 0 \"Tx drop increased\"\n}\n\nbackup_nhid_ping()\n{\n\tlocal sw1_mac\n\tlocal sw2_mac\n\n\techo\n\techo \"Backup nexthop ID - ping\"\n\techo \"------------------------\"\n\n\t# Test bidirectional traffic when traffic is redirected in both VTEPs.\n\tsw1_mac=$(ip -n sw1 -j -p link show br0.10 | jq -r '.[][\"address\"]')\n\tsw2_mac=$(ip -n sw2 -j -p link show br0.10 | jq -r '.[][\"address\"]')\n\n\trun_cmd \"bridge -n sw1 fdb replace $sw2_mac dev swp1 master static vlan 10\"\n\trun_cmd \"bridge -n sw2 fdb replace $sw1_mac dev swp1 master static vlan 10\"\n\n\trun_cmd \"ip -n sw1 neigh replace 192.0.2.66 lladdr $sw2_mac nud perm dev br0.10\"\n\trun_cmd \"ip -n sw2 neigh replace 192.0.2.65 lladdr $sw1_mac nud perm dev br0.10\"\n\n\trun_cmd \"ip -n sw1 nexthop replace id 1 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw2 nexthop replace id 1 via 192.0.2.33 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 10 group 1 fdb\"\n\trun_cmd \"ip -n sw2 nexthop replace id 10 group 1 fdb\"\n\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_port vx0\"\n\trun_cmd \"bridge -n sw2 link set dev swp1 backup_port vx0\"\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 10\"\n\trun_cmd \"bridge -n sw2 link set dev swp1 backup_nhid 10\"\n\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\trun_cmd \"ip -n sw2 link set dev swp1 carrier off\"\n\n\trun_cmd \"ip netns exec sw1 ping -i 0.1 -c 10 -w $PING_TIMEOUT 192.0.2.66\"\n\tlog_test $? 0 \"Ping with backup nexthop ID\"\n\n\t# Reset the backup nexthop ID to 0 and check that ping fails.\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 0\"\n\trun_cmd \"bridge -n sw2 link set dev swp1 backup_nhid 0\"\n\n\trun_cmd \"ip netns exec sw1 ping -i 0.1 -c 10 -w $PING_TIMEOUT 192.0.2.66\"\n\tlog_test $? 1 \"Ping after disabling backup nexthop ID\"\n}\n\nbackup_nhid_add_del_loop()\n{\n\twhile true; do\n\t\tip -n sw1 nexthop del id 10\n\t\tip -n sw1 nexthop replace id 10 group 1/2 fdb\n\tdone >/dev/null 2>&1\n}\n\nbackup_nhid_torture()\n{\n\tlocal dmac=00:11:22:33:44:55\n\tlocal smac=00:aa:bb:cc:dd:ee\n\tlocal pid1\n\tlocal pid2\n\tlocal pid3\n\n\techo\n\techo \"Backup nexthop ID - torture test\"\n\techo \"--------------------------------\"\n\n\t# Continuously send traffic through the backup nexthop while adding and\n\t# deleting the group. The test is considered successful if nothing\n\t# crashed.\n\n\trun_cmd \"ip -n sw1 nexthop replace id 1 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 2 via 192.0.2.34 fdb\"\n\trun_cmd \"ip -n sw1 nexthop replace id 10 group 1/2 fdb\"\n\n\trun_cmd \"bridge -n sw1 fdb replace $dmac dev swp1 master static vlan 10\"\n\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_port vx0\"\n\trun_cmd \"bridge -n sw1 link set dev swp1 backup_nhid 10\"\n\trun_cmd \"ip -n sw1 link set dev swp1 carrier off\"\n\n\tbackup_nhid_add_del_loop &\n\tpid1=$!\n\tip netns exec sw1 mausezahn br0.10 -a $smac -b $dmac -A 198.51.100.1 -B 198.51.100.2 -t ip -p 100 -q -c 0 &\n\tpid2=$!\n\n\tsleep 30\n\tkill -9 $pid1 $pid2\n\twait $pid1 $pid2 2>/dev/null\n\n\tlog_test 0 0 \"Torture test\"\n}\n\n################################################################################\n# Usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $TESTS)\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\n        -v          Verbose mode (show commands and output)\n        -w          Timeout for ping\nEOF\n}\n\n################################################################################\n# Main\n\ntrap cleanup EXIT\n\nwhile getopts \":t:pPvhw:\" opt; do\n\tcase $opt in\n\t\tt) TESTS=$OPTARG;;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\tw) PING_TIMEOUT=$OPTARG;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# Make sure we don't pause twice.\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v bridge)\" ]; then\n\techo \"SKIP: Could not run test without bridge tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v tc)\" ]; then\n\techo \"SKIP: Could not run test without tc tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v mausezahn)\" ]; then\n\techo \"SKIP: Could not run test without mausezahn tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v jq)\" ]; then\n\techo \"SKIP: Could not run test without jq tool\"\n\texit $ksft_skip\nfi\n\nbridge link help 2>&1 | grep -q \"backup_nhid\"\nif [ $? -ne 0 ]; then\n   echo \"SKIP: iproute2 bridge too old, missing backup nexthop ID support\"\n   exit $ksft_skip\nfi\n\n# Start clean.\ncleanup\n\nfor t in $TESTS\ndo\n\tsetup; $t; cleanup;\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}