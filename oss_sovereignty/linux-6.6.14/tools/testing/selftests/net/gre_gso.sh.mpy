{
  "module_name": "gre_gso.sh",
  "hash_id": "d41c727e8ebc1fefd9c5d1e96fe9baa6d4dbaf800114ea7c5f601bdfce3b15cf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/gre_gso.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test is for checking GRE GSO.\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# all tests in this script. Can be overridden with -t option\nTESTS=\"gre_gso\"\n\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\nIP=\"ip -netns ns1\"\nNS_EXEC=\"ip netns exec ns1\"\nTMPFILE=`mktemp`\nPID=\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"    TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"    TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n}\n\nsetup()\n{\n\tset -e\n\tip netns add ns1\n\tip netns set ns1 auto\n\t$IP link set dev lo up\n\n\tip link add veth0 type veth peer name veth1\n\tip link set veth0 up\n\tip link set veth1 netns ns1\n\t$IP link set veth1 name veth0\n\t$IP link set veth0 up\n\n\tdd if=/dev/urandom of=$TMPFILE bs=1024 count=2048 &>/dev/null\n\tset +e\n}\n\ncleanup()\n{\n\trm -rf $TMPFILE\n\t[ -n \"$PID\" ] && kill $PID\n\tip link del dev gre1 &> /dev/null\n\tip link del dev veth0 &> /dev/null\n\tip netns del ns1\n}\n\nget_linklocal()\n{\n\tlocal dev=$1\n\tlocal ns=$2\n\tlocal addr\n\n\t[ -n \"$ns\" ] && ns=\"-netns $ns\"\n\n\taddr=$(ip -6 -br $ns addr show dev ${dev} | \\\n\tawk '{\n\t\tfor (i = 3; i <= NF; ++i) {\n\t\t\tif ($i ~ /^fe80/)\n\t\t\t\tprint $i\n\t\t}\n\t}'\n\t)\n\taddr=${addr/\\/*}\n\n\t[ -z \"$addr\" ] && return 1\n\n\techo $addr\n\n\treturn 0\n}\n\ngre_create_tun()\n{\n\tlocal a1=$1\n\tlocal a2=$2\n\tlocal mode\n\n\t[[ $a1 =~ ^[0-9.]*$ ]] && mode=gre || mode=ip6gre\n\n\tip tunnel add gre1 mode $mode local $a1 remote $a2 dev veth0\n\tip link set gre1 up\n\t$IP tunnel add gre1 mode $mode local $a2 remote $a1 dev veth0\n\t$IP link set gre1 up\n}\n\ngre_gst_test_checks()\n{\n\tlocal name=$1\n\tlocal addr=$2\n\tlocal proto=$3\n\n\t[ \"$proto\" == 6 ] && addr=\"[$addr]\"\n\n\t$NS_EXEC socat - tcp${proto}-listen:$port,reuseaddr,fork >/dev/null &\n\tPID=$!\n\twhile ! $NS_EXEC ss -ltn | grep -q $port; do ((i++)); sleep 0.01; done\n\n\tcat $TMPFILE | timeout 1 socat -u STDIN TCP:$addr:$port\n\tlog_test $? 0 \"$name - copy file w/ TSO\"\n\n\tethtool -K veth0 tso off\n\n\tcat $TMPFILE | timeout 1 socat -u STDIN TCP:$addr:$port\n\tlog_test $? 0 \"$name - copy file w/ GSO\"\n\n\tethtool -K veth0 tso on\n\n\tkill $PID\n\tPID=\n}\n\ngre6_gso_test()\n{\n\tlocal port=7777\n\n\tsetup\n\n\ta1=$(get_linklocal veth0)\n\ta2=$(get_linklocal veth0 ns1)\n\n\tgre_create_tun $a1 $a2\n\n\tip  addr add 172.16.2.1/24 dev gre1\n\t$IP addr add 172.16.2.2/24 dev gre1\n\n\tip  -6 addr add 2001:db8:1::1/64 dev gre1 nodad\n\t$IP -6 addr add 2001:db8:1::2/64 dev gre1 nodad\n\n\tsleep 2\n\n\tgre_gst_test_checks GREv6/v4 172.16.2.2 4\n\tgre_gst_test_checks GREv6/v6 2001:db8:1::2 6\n\n\tcleanup\n}\n\ngre_gso_test()\n{\n\tgre6_gso_test\n}\n\n################################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $TESTS)\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\n        -v          verbose mode (show commands and output)\nEOF\n}\n\n################################################################################\n# main\n\nwhile getopts :t:pPhv o\ndo\n\tcase $o in\n\t\tt) TESTS=$OPTARG;;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\nPEER_CMD=\"ip netns exec ${PEER_NS}\"\n\n# make sure we don't pause twice\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v socat)\" ]; then\n\techo \"SKIP: Could not run test without socat tool\"\n\texit $ksft_skip\nfi\n\n# start clean\ncleanup &> /dev/null\n\nfor t in $TESTS\ndo\n\tcase $t in\n\tgre_gso)\t\tgre_gso_test;;\n\n\thelp) echo \"Test names: $TESTS\"; exit 0;;\n\tesac\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}