{
  "module_name": "test_vxlan_under_vrf.sh",
  "hash_id": "edf9be30cd3d40599d63845eb6a81be85f5ebed7f64834e47024a80ba0e10ac9",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/test_vxlan_under_vrf.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test is for checking VXLAN underlay in a non-default VRF.\n#\n# It simulates two hypervisors running a VM each using four network namespaces:\n# two for the HVs, two for the VMs.\n# A small VXLAN tunnel is made between the two hypervisors to have the two vms\n# in the same virtual L2:\n#\n# +-------------------+                                    +-------------------+\n# |                   |                                    |                   |\n# |    vm-1 netns     |                                    |    vm-2 netns     |\n# |                   |                                    |                   |\n# |  +-------------+  |                                    |  +-------------+  |\n# |  |   veth-hv   |  |                                    |  |   veth-hv   |  |\n# |  | 10.0.0.1/24 |  |                                    |  | 10.0.0.2/24 |  |\n# |  +-------------+  |                                    |  +-------------+  |\n# |        .          |                                    |         .         |\n# +-------------------+                                    +-------------------+\n#          .                                                         .\n#          .                                                         .\n#          .                                                         .\n# +-----------------------------------+   +------------------------------------+\n# |        .                          |   |                          .         |\n# |  +----------+                     |   |                     +----------+   |\n# |  | veth-tap |                     |   |                     | veth-tap |   |\n# |  +----+-----+                     |   |                     +----+-----+   |\n# |       |                           |   |                          |         |\n# |    +--+--+      +--------------+  |   |  +--------------+     +--+--+      |\n# |    | br0 |      | vrf-underlay |  |   |  | vrf-underlay |     | br0 |      |\n# |    +--+--+      +-------+------+  |   |  +------+-------+     +--+--+      |\n# |       |                 |         |   |         |                |         |\n# |   +---+----+    +-------+-------+ |   | +-------+-------+    +---+----+    |\n# |   | vxlan0 |....|     veth0     |.|...|.|     veth0     |....| vxlan0 |    |\n# |   +--------+    | 172.16.0.1/24 | |   | | 172.16.0.2/24 |    +--------+    |\n# |                 +---------------+ |   | +---------------+                  |\n# |                                   |   |                                    |\n# |             hv-1 netns            |   |           hv-2 netns               |\n# |                                   |   |                                    |\n# +-----------------------------------+   +------------------------------------+\n#\n# This tests both the connectivity between vm-1 and vm-2, and that the underlay\n# can be moved in and out of the vrf by unsetting and setting veth0's master.\n\nset -e\n\ncleanup() {\n    ip link del veth-hv-1 2>/dev/null || true\n    ip link del veth-tap 2>/dev/null || true\n\n    for ns in hv-1 hv-2 vm-1 vm-2; do\n        ip netns del $ns 2>/dev/null || true\n    done\n}\n\n# Clean start\ncleanup &> /dev/null\n\n[[ $1 == \"clean\" ]] && exit 0\n\ntrap cleanup EXIT\n\n# Setup \"Hypervisors\" simulated with netns\nip link add veth-hv-1 type veth peer name veth-hv-2\nsetup-hv-networking() {\n    hv=$1\n\n    ip netns add hv-$hv\n    ip link set veth-hv-$hv netns hv-$hv\n    ip -netns hv-$hv link set veth-hv-$hv name veth0\n\n    ip -netns hv-$hv link add vrf-underlay type vrf table 1\n    ip -netns hv-$hv link set vrf-underlay up\n    ip -netns hv-$hv addr add 172.16.0.$hv/24 dev veth0\n    ip -netns hv-$hv link set veth0 up\n\n    ip -netns hv-$hv link add br0 type bridge\n    ip -netns hv-$hv link set br0 up\n\n    ip -netns hv-$hv link add vxlan0 type vxlan id 10 local 172.16.0.$hv dev veth0 dstport 4789\n    ip -netns hv-$hv link set vxlan0 master br0\n    ip -netns hv-$hv link set vxlan0 up\n}\nsetup-hv-networking 1\nsetup-hv-networking 2\n\n# Check connectivity between HVs by pinging hv-2 from hv-1\necho -n \"Checking HV connectivity                                           \"\nip netns exec hv-1 ping -c 1 -W 1 172.16.0.2 &> /dev/null || (echo \"[FAIL]\"; false)\necho \"[ OK ]\"\n\n# Setups a \"VM\" simulated by a netns an a veth pair\nsetup-vm() {\n    id=$1\n\n    ip netns add vm-$id\n    ip link add veth-tap type veth peer name veth-hv\n\n    ip link set veth-tap netns hv-$id\n    ip -netns hv-$id link set veth-tap master br0\n    ip -netns hv-$id link set veth-tap up\n\n    ip link set veth-hv address 02:1d:8d:dd:0c:6$id\n\n    ip link set veth-hv netns vm-$id\n    ip -netns vm-$id addr add 10.0.0.$id/24 dev veth-hv\n    ip -netns vm-$id link set veth-hv up\n}\nsetup-vm 1\nsetup-vm 2\n\n# Setup VTEP routes to make ARP work\nbridge -netns hv-1 fdb add 00:00:00:00:00:00 dev vxlan0 dst 172.16.0.2 self permanent\nbridge -netns hv-2 fdb add 00:00:00:00:00:00 dev vxlan0 dst 172.16.0.1 self permanent\n\necho -n \"Check VM connectivity through VXLAN (underlay in the default VRF)  \"\nip netns exec vm-1 ping -c 1 -W 1 10.0.0.2 &> /dev/null || (echo \"[FAIL]\"; false)\necho \"[ OK ]\"\n\n# Move the underlay to a non-default VRF\nip -netns hv-1 link set veth0 vrf vrf-underlay\nip -netns hv-1 link set vxlan0 down\nip -netns hv-1 link set vxlan0 up\nip -netns hv-2 link set veth0 vrf vrf-underlay\nip -netns hv-2 link set vxlan0 down\nip -netns hv-2 link set vxlan0 up\n\necho -n \"Check VM connectivity through VXLAN (underlay in a VRF)            \"\nip netns exec vm-1 ping -c 1 -W 1 10.0.0.2 &> /dev/null || (echo \"[FAIL]\"; false)\necho \"[ OK ]\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}