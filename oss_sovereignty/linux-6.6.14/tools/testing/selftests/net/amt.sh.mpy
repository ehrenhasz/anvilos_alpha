{
  "module_name": "amt.sh",
  "hash_id": "947eff37294354abe364c98320f29334507507fae661dc505a5203d5f233217a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/amt.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\n# Author: Taehee Yoo <ap420073@gmail.com>\n#\n# This script evaluates the AMT driver.\n# There are four network-namespaces, LISTENER, SOURCE, GATEWAY, RELAY.\n# The role of LISTENER is to listen multicast traffic.\n# In order to do that, it send IGMP group join message.\n# The role of SOURCE is to send multicast traffic to listener.\n# The role of GATEWAY is to work Gateway role of AMT interface.\n# The role of RELAY is to work Relay role of AMT interface.\n#\n#\n#       +------------------------+\n#       |    LISTENER netns      |\n#       |                        |\n#       |  +------------------+  |\n#       |  |       l_gw       |  |\n#       |  |  192.168.0.2/24  |  |\n#       |  |  2001:db8::2/64  |  |\n#       |  +------------------+  |\n#       |            .           |\n#       +------------------------+\n#                    .\n#                    .\n#       +-----------------------------------------------------+\n#       |            .         GATEWAY netns                  |\n#       |            .                                        |\n#       |+---------------------------------------------------+|\n#       ||           .          br0                          ||\n#       || +------------------+       +------------------+   ||\n#       || |       gw_l       |       |       amtg       |   ||\n#       || |  192.168.0.1/24  |       +--------+---------+   ||\n#       || |  2001:db8::1/64  |                |             ||\n#       || +------------------+                |             ||\n#       |+-------------------------------------|-------------+|\n#       |                                      |              |\n#       |                             +--------+---------+    |\n#       |                             |     gw_relay     |    |\n#       |                             |    10.0.0.1/24   |    |\n#       |                             +------------------+    |\n#       |                                      .              |\n#       +-----------------------------------------------------+\n#                                              .\n#                                              .\n#       +-----------------------------------------------------+\n#       |                       RELAY netns    .              |\n#       |                             +------------------+    |\n#       |                             |     relay_gw     |    |\n#       |                             |    10.0.0.2/24   |    |\n#       |                             +--------+---------+    |\n#       |                                      |              |\n#       |                                      |              |\n#       |  +------------------+       +--------+---------+    |\n#       |  |     relay_src    |       |       amtr       |    |\n#       |  |   172.17.0.1/24  |       +------------------+    |\n#       |  | 2001:db8:3::1/64 |                               |\n#       |  +------------------+                               |\n#       |            .                                        |\n#       |            .                                        |\n#       +-----------------------------------------------------+\n#                    .\n#                    .\n#       +------------------------+\n#       |            .           |\n#       |  +------------------+  |\n#       |  |     src_relay    |  |\n#       |  |   172.17.0.2/24  |  |\n#       |  | 2001:db8:3::2/64 |  |\n#       |  +------------------+  |\n#       |      SOURCE netns      |\n#       +------------------------+\n#==============================================================================\n\nreadonly LISTENER=$(mktemp -u listener-XXXXXXXX)\nreadonly GATEWAY=$(mktemp -u gateway-XXXXXXXX)\nreadonly RELAY=$(mktemp -u relay-XXXXXXXX)\nreadonly SOURCE=$(mktemp -u source-XXXXXXXX)\nERR=4\nerr=0\n\nexit_cleanup()\n{\n\tfor ns in \"$@\"; do\n\t\tip netns delete \"${ns}\" 2>/dev/null || true\n\tdone\n\n\texit $ERR\n}\n\ncreate_namespaces()\n{\n\tip netns add \"${LISTENER}\" || exit_cleanup\n\tip netns add \"${GATEWAY}\" || exit_cleanup \"${LISTENER}\"\n\tip netns add \"${RELAY}\" || exit_cleanup \"${LISTENER}\" \"${GATEWAY}\"\n\tip netns add \"${SOURCE}\" || exit_cleanup \"${LISTENER}\" \"${GATEWAY}\" \\\n\t\t\"${RELAY}\"\n}\n\n# The trap function handler\n#\nexit_cleanup_all()\n{\n\texit_cleanup \"${LISTENER}\" \"${GATEWAY}\" \"${RELAY}\" \"${SOURCE}\"\n}\n\nsetup_interface()\n{\n\tfor ns in \"${LISTENER}\" \"${GATEWAY}\" \"${RELAY}\" \"${SOURCE}\"; do\n\t\tip -netns \"${ns}\" link set dev lo up\n\tdone;\n\n\tip link add l_gw type veth peer name gw_l\n\tip link add gw_relay type veth peer name relay_gw\n\tip link add relay_src type veth peer name src_relay\n\n\tip link set l_gw netns \"${LISTENER}\" up\n\tip link set gw_l netns \"${GATEWAY}\" up\n\tip link set gw_relay netns \"${GATEWAY}\" up\n\tip link set relay_gw netns \"${RELAY}\" up\n\tip link set relay_src netns \"${RELAY}\" up\n\tip link set src_relay netns \"${SOURCE}\" up mtu 1400\n\n\tip netns exec \"${LISTENER}\" ip a a 192.168.0.2/24 dev l_gw\n\tip netns exec \"${LISTENER}\" ip r a default via 192.168.0.1 dev l_gw\n\tip netns exec \"${LISTENER}\" ip a a 2001:db8::2/64 dev l_gw\n\tip netns exec \"${LISTENER}\" ip r a default via 2001:db8::1 dev l_gw\n\tip netns exec \"${LISTENER}\" ip a a 239.0.0.1/32 dev l_gw autojoin\n\tip netns exec \"${LISTENER}\" ip a a ff0e::5:6/128 dev l_gw autojoin\n\n\tip netns exec \"${GATEWAY}\" ip a a 192.168.0.1/24 dev gw_l\n\tip netns exec \"${GATEWAY}\" ip a a 2001:db8::1/64 dev gw_l\n\tip netns exec \"${GATEWAY}\" ip a a 10.0.0.1/24 dev gw_relay\n\tip netns exec \"${GATEWAY}\" ip link add br0 type bridge\n\tip netns exec \"${GATEWAY}\" ip link set br0 up\n\tip netns exec \"${GATEWAY}\" ip link set gw_l master br0\n\tip netns exec \"${GATEWAY}\" ip link set gw_l up\n\tip netns exec \"${GATEWAY}\" ip link add amtg master br0 type amt \\\n\t\tmode gateway local 10.0.0.1 discovery 10.0.0.2 dev gw_relay \\\n\t\tgateway_port 2268 relay_port 2268\n\tip netns exec \"${RELAY}\" ip a a 10.0.0.2/24 dev relay_gw\n\tip netns exec \"${RELAY}\" ip link add amtr type amt mode relay \\\n\t\tlocal 10.0.0.2 dev relay_gw relay_port 2268 max_tunnels 4\n\tip netns exec \"${RELAY}\" ip a a 172.17.0.1/24 dev relay_src\n\tip netns exec \"${RELAY}\" ip a a 2001:db8:3::1/64 dev relay_src\n\tip netns exec \"${SOURCE}\" ip a a 172.17.0.2/24 dev src_relay\n\tip netns exec \"${SOURCE}\" ip a a 2001:db8:3::2/64 dev src_relay\n\tip netns exec \"${SOURCE}\" ip r a default via 172.17.0.1 dev src_relay\n\tip netns exec \"${SOURCE}\" ip r a default via 2001:db8:3::1 dev src_relay\n\tip netns exec \"${RELAY}\" ip link set amtr up\n\tip netns exec \"${GATEWAY}\" ip link set amtg up\n}\n\nsetup_sysctl()\n{\n\tip netns exec \"${RELAY}\" sysctl net.ipv4.ip_forward=1 -w -q\n}\n\nsetup_iptables()\n{\n\tip netns exec \"${RELAY}\" iptables -t mangle -I PREROUTING \\\n\t\t-d 239.0.0.1 -j TTL --ttl-set 2\n\tip netns exec \"${RELAY}\" ip6tables -t mangle -I PREROUTING \\\n\t\t-j HL --hl-set 2\n}\n\nsetup_mcast_routing()\n{\n\tip netns exec \"${RELAY}\" smcrouted\n\tip netns exec \"${RELAY}\" smcroutectl a relay_src \\\n\t\t172.17.0.2 239.0.0.1 amtr\n\tip netns exec \"${RELAY}\" smcroutectl a relay_src \\\n\t\t2001:db8:3::2 ff0e::5:6 amtr\n}\n\ntest_remote_ip()\n{\n\tREMOTE=$(ip netns exec \"${GATEWAY}\" \\\n\t\tip -d -j link show amtg | jq .[0].linkinfo.info_data.remote)\n\tif [ $REMOTE == \"\\\"10.0.0.2\\\"\" ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"amt discovery\"\n\telse\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"amt discovery\"\n\t\tERR=1\n\tfi\n}\n\nsend_mcast_torture4()\n{\n\tip netns exec \"${SOURCE}\" bash -c \\\n\t\t'cat /dev/urandom | head -c 1G | nc -w 1 -u 239.0.0.1 4001'\n}\n\n\nsend_mcast_torture6()\n{\n\tip netns exec \"${SOURCE}\" bash -c \\\n\t\t'cat /dev/urandom | head -c 1G | nc -w 1 -u ff0e::5:6 6001'\n}\n\ncheck_features()\n{\n        ip link help 2>&1 | grep -q amt\n        if [ $? -ne 0 ]; then\n                echo \"Missing amt support in iproute2\" >&2\n                exit_cleanup\n        fi\n}\n\ntest_ipv4_forward()\n{\n\tRESULT4=$(ip netns exec \"${LISTENER}\" nc -w 1 -l -u 239.0.0.1 4000)\n\tif [ \"$RESULT4\" == \"172.17.0.2\" ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"IPv4 amt multicast forwarding\"\n\t\texit 0\n\telse\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"IPv4 amt multicast forwarding\"\n\t\texit 1\n\tfi\n}\n\ntest_ipv6_forward()\n{\n\tRESULT6=$(ip netns exec \"${LISTENER}\" nc -w 1 -l -u ff0e::5:6 6000)\n\tif [ \"$RESULT6\" == \"2001:db8:3::2\" ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"IPv6 amt multicast forwarding\"\n\t\texit 0\n\telse\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"IPv6 amt multicast forwarding\"\n\t\texit 1\n\tfi\n}\n\nsend_mcast4()\n{\n\tsleep 2\n\tip netns exec \"${SOURCE}\" bash -c \\\n\t\t'echo 172.17.0.2 | nc -w 1 -u 239.0.0.1 4000' &\n}\n\nsend_mcast6()\n{\n\tsleep 2\n\tip netns exec \"${SOURCE}\" bash -c \\\n\t\t'echo 2001:db8:3::2 | nc -w 1 -u ff0e::5:6 6000' &\n}\n\ncheck_features\n\ncreate_namespaces\n\nset -e\ntrap exit_cleanup_all EXIT\n\nsetup_interface\nsetup_sysctl\nsetup_iptables\nsetup_mcast_routing\ntest_remote_ip\ntest_ipv4_forward &\npid=$!\nsend_mcast4\nwait $pid || err=$?\nif [ $err -eq 1 ]; then\n\tERR=1\nfi\ntest_ipv6_forward &\npid=$!\nsend_mcast6\nwait $pid || err=$?\nif [ $err -eq 1 ]; then\n\tERR=1\nfi\nsend_mcast_torture4\nprintf \"TEST: %-60s  [ OK ]\\n\" \"IPv4 amt traffic forwarding torture\"\nsend_mcast_torture6\nprintf \"TEST: %-60s  [ OK ]\\n\" \"IPv6 amt traffic forwarding torture\"\nsleep 5\nif [ \"${ERR}\" -eq 1 ]; then\n        echo \"Some tests failed.\" >&2\nelse\n        ERR=0\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}