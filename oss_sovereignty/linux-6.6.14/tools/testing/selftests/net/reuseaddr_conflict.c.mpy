{
  "module_name": "reuseaddr_conflict.c",
  "hash_id": "c9df87cf27639abe507565b60428d50f7ecaca014d562ec889fb7b1a2ba9e3fc",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/reuseaddr_conflict.c",
  "human_readable_source": " \n#include <errno.h>\n#include <error.h>\n#include <arpa/inet.h>\n#include <netinet/in.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <unistd.h>\n\n#define PORT 9999\n\nint open_port(int ipv6, int any)\n{\n\tint fd = -1;\n\tint reuseaddr = 1;\n\tint v6only = 1;\n\tint addrlen;\n\tint ret = -1;\n\tstruct sockaddr *addr;\n\tint family = ipv6 ? AF_INET6 : AF_INET;\n\n\tstruct sockaddr_in6 addr6 = {\n\t\t.sin6_family = AF_INET6,\n\t\t.sin6_port = htons(PORT),\n\t\t.sin6_addr = in6addr_any\n\t};\n\tstruct sockaddr_in addr4 = {\n\t\t.sin_family = AF_INET,\n\t\t.sin_port = htons(PORT),\n\t\t.sin_addr.s_addr = any ? htonl(INADDR_ANY) : inet_addr(\"127.0.0.1\"),\n\t};\n\n\n\tif (ipv6) {\n\t\taddr = (struct sockaddr*)&addr6;\n\t\taddrlen = sizeof(addr6);\n\t} else {\n\t\taddr = (struct sockaddr*)&addr4;\n\t\taddrlen = sizeof(addr4);\n\t}\n\n\tif ((fd = socket(family, SOCK_STREAM, IPPROTO_TCP)) < 0) {\n\t\tperror(\"socket\");\n\t\tgoto out;\n\t}\n\n\tif (ipv6 && setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (void*)&v6only,\n\t\t\t       sizeof(v6only)) < 0) {\n\t\tperror(\"setsockopt IPV6_V6ONLY\");\n\t\tgoto out;\n\t}\n\n\tif (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &reuseaddr,\n\t\t       sizeof(reuseaddr)) < 0) {\n\t\tperror(\"setsockopt SO_REUSEADDR\");\n\t\tgoto out;\n\t}\n\n\tif (bind(fd, addr, addrlen) < 0) {\n\t\tperror(\"bind\");\n\t\tgoto out;\n\t}\n\n\tif (any)\n\t\treturn fd;\n\n\tif (listen(fd, 1) < 0) {\n\t\tperror(\"listen\");\n\t\tgoto out;\n\t}\n\treturn fd;\nout:\n\tclose(fd);\n\treturn ret;\n}\n\nint main(void)\n{\n\tint listenfd;\n\tint fd1, fd2;\n\n\tfprintf(stderr, \"Opening 127.0.0.1:%d\\n\", PORT);\n\tlistenfd = open_port(0, 0);\n\tif (listenfd < 0)\n\t\terror(1, errno, \"Couldn't open listen socket\");\n\tfprintf(stderr, \"Opening INADDR_ANY:%d\\n\", PORT);\n\tfd1 = open_port(0, 1);\n\tif (fd1 >= 0)\n\t\terror(1, 0, \"Was allowed to create an ipv4 reuseport on a already bound non-reuseport socket\");\n\tfprintf(stderr, \"Opening in6addr_any:%d\\n\", PORT);\n\tfd1 = open_port(1, 1);\n\tif (fd1 < 0)\n\t\terror(1, errno, \"Couldn't open ipv6 reuseport\");\n\tfprintf(stderr, \"Opening INADDR_ANY:%d\\n\", PORT);\n\tfd2 = open_port(0, 1);\n\tif (fd2 >= 0)\n\t\terror(1, 0, \"Was allowed to create an ipv4 reuseport on a already bound non-reuseport socket\");\n\tclose(fd1);\n\tfprintf(stderr, \"Opening INADDR_ANY:%d after closing ipv6 socket\\n\", PORT);\n\tfd1 = open_port(0, 1);\n\tif (fd1 >= 0)\n\t\terror(1, 0, \"Was allowed to create an ipv4 reuseport on an already bound non-reuseport socket with no ipv6\");\n\tfprintf(stderr, \"Success\");\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}