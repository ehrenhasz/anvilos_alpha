{
  "module_name": "fib_nexthop_multiprefix.sh",
  "hash_id": "60869ae839fa20bc78011aeba1a881d26b032d6097e79c348023292a31f4ad8c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/fib_nexthop_multiprefix.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Validate cached routes in fib{6}_nh that is used by multiple prefixes.\n# Validate a different # exception is generated in h0 for each remote host.\n#\n#               h1\n#            /\n#    h0 - r1 -  h2\n#            \\\n#               h3\n#\n# routing in h0 to hN is done with nexthop objects.\n\nPAUSE_ON_FAIL=no\nVERBOSE=0\n\nwhich ping6 > /dev/null 2>&1 && ping6=$(which ping6) || ping6=$(which ping)\n\n################################################################################\n# helpers\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$*\"\n\tlocal out\n\tlocal rc\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\techo \"COMMAND: $cmd\"\n\tfi\n\n\tout=$(eval $cmd 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"$out\"\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\n\treturn $rc\n}\n\n################################################################################\n# config\n\ncreate_ns()\n{\n\tlocal ns=${1}\n\n\tip netns del ${ns} 2>/dev/null\n\n\tip netns add ${ns}\n\tip -netns ${ns} addr add 127.0.0.1/8 dev lo\n\tip -netns ${ns} link set lo up\n\n\tip netns exec ${ns} sysctl -q -w net.ipv6.conf.all.keep_addr_on_down=1\n\tcase ${ns} in\n\th*)\n\t\tip netns exec $ns sysctl -q -w net.ipv6.conf.all.forwarding=0\n\t\t;;\n\tr*)\n\t\tip netns exec $ns sysctl -q -w net.ipv4.ip_forward=1\n\t\tip netns exec $ns sysctl -q -w net.ipv6.conf.all.forwarding=1\n\t\t;;\n\tesac\n}\n\nsetup()\n{\n\tlocal ns\n\tlocal i\n\n\t#set -e\n\n\tfor ns in h0 r1 h1 h2 h3\n\tdo\n\t\tcreate_ns ${ns}\n\tdone\n\n\t#\n\t# create interconnects\n\t#\n\n\tfor i in 0 1 2 3\n\tdo\n\t\tip -netns h${i} li add eth0 type veth peer name r1h${i}\n\t\tip -netns h${i} li set eth0 up\n\t\tip -netns h${i} li set r1h${i} netns r1 name eth${i} up\n\n\t\tip -netns h${i}    addr add dev eth0 172.16.10${i}.1/24\n\t\tip -netns h${i} -6 addr add dev eth0 2001:db8:10${i}::1/64\n\t\tip -netns r1    addr add dev eth${i} 172.16.10${i}.254/24\n\t\tip -netns r1 -6 addr add dev eth${i} 2001:db8:10${i}::64/64\n\tdone\n\n\tip -netns h0 nexthop add id 4 via 172.16.100.254 dev eth0\n\tip -netns h0 nexthop add id 6 via 2001:db8:100::64 dev eth0\n\n\t# routing from h0 to h1-h3 and back\n\tfor i in 1 2 3\n\tdo\n\t\tip -netns h0    ro add 172.16.10${i}.0/24 nhid 4\n\t\tip -netns h${i} ro add 172.16.100.0/24 via 172.16.10${i}.254\n\n\t\tip -netns h0    -6 ro add 2001:db8:10${i}::/64 nhid 6\n\t\tip -netns h${i} -6 ro add 2001:db8:100::/64 via 2001:db8:10${i}::64\n\tdone\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\techo\n\t\techo \"host 1 config\"\n\t\tip -netns h0 li sh\n\t\tip -netns h0 ro sh\n\t\tip -netns h0 -6 ro sh\n\tfi\n\n\t#set +e\n}\n\ncleanup()\n{\n\tfor n in h0 r1 h1 h2 h3\n\tdo\n\t\tip netns del ${n} 2>/dev/null\n\tdone\n}\n\nchange_mtu()\n{\n\tlocal hostid=$1\n\tlocal mtu=$2\n\n\trun_cmd ip -netns h${hostid} li set eth0 mtu ${mtu}\n\trun_cmd ip -netns r1 li set eth${hostid} mtu ${mtu}\n}\n\n################################################################################\n# validate exceptions\n\nvalidate_v4_exception()\n{\n\tlocal i=$1\n\tlocal mtu=$2\n\tlocal ping_sz=$3\n\tlocal dst=\"172.16.10${i}.1\"\n\tlocal h0=172.16.100.1\n\tlocal r1=172.16.100.254\n\tlocal rc\n\n\tif [ ${ping_sz} != \"0\" ]; then\n\t\trun_cmd ip netns exec h0 ping -s ${ping_sz} -c5 -w5 ${dst}\n\tfi\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\techo \"Route get\"\n\t\tip -netns h0 ro get ${dst}\n\t\techo \"Searching for:\"\n\t\techo \"    cache .* mtu ${mtu}\"\n\t\techo\n\tfi\n\n\tip -netns h0 ro get ${dst} | \\\n\tgrep -q \"cache .* mtu ${mtu}\"\n\trc=$?\n\n\tlog_test $rc 0 \"IPv4: host 0 to host ${i}, mtu ${mtu}\"\n}\n\nvalidate_v6_exception()\n{\n\tlocal i=$1\n\tlocal mtu=$2\n\tlocal ping_sz=$3\n\tlocal dst=\"2001:db8:10${i}::1\"\n\tlocal h0=2001:db8:100::1\n\tlocal r1=2001:db8:100::64\n\tlocal rc\n\n\tif [ ${ping_sz} != \"0\" ]; then\n\t\trun_cmd ip netns exec h0 ${ping6} -s ${ping_sz} -c5 -w5 ${dst}\n\tfi\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\techo \"Route get\"\n\t\tip -netns h0 -6 ro get ${dst}\n\t\techo \"Searching for:\"\n\t\techo \"    ${dst}.* via ${r1} dev eth0 src ${h0} .* mtu ${mtu}\"\n\t\techo\n\tfi\n\n\tip -netns h0 -6 ro get ${dst} | \\\n\tgrep -q \"${dst}.* via ${r1} dev eth0 src ${h0} .* mtu ${mtu}\"\n\trc=$?\n\n\tlog_test $rc 0 \"IPv6: host 0 to host ${i}, mtu ${mtu}\"\n}\n\n################################################################################\n# main\n\nwhile getopts :pv o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tv) VERBOSE=1;;\n\tesac\ndone\n\ncleanup\nsetup\nsleep 2\n\ncpus=$(cat  /sys/devices/system/cpu/online)\ncpus=\"$(seq ${cpus/-/ })\"\nret=0\nfor i in 1 2 3\ndo\n\t# generate a cached route per-cpu\n\tfor c in ${cpus}; do\n\t\trun_cmd taskset -c ${c} ip netns exec h0 ping -c1 -w1 172.16.10${i}.1\n\t\t[ $? -ne 0 ] && printf \"\\nERROR: ping to h${i} failed\\n\" && ret=1\n\n\t\trun_cmd taskset -c ${c} ip netns exec h0 ${ping6} -c1 -w1 2001:db8:10${i}::1\n\t\t[ $? -ne 0 ] && printf \"\\nERROR: ping6 to h${i} failed\\n\" && ret=1\n\n\t\t[ $ret -ne 0 ] && break\n\tdone\n\t[ $ret -ne 0 ] && break\ndone\n\nif [ $ret -eq 0 ]; then\n\t# generate different exceptions in h0 for h1, h2 and h3\n\tchange_mtu 1 1300\n\tvalidate_v4_exception 1 1300 1350\n\tvalidate_v6_exception 1 1300 1350\n\techo\n\n\tchange_mtu 2 1350\n\tvalidate_v4_exception 2 1350 1400\n\tvalidate_v6_exception 2 1350 1400\n\techo\n\n\tchange_mtu 3 1400\n\tvalidate_v4_exception 3 1400 1450\n\tvalidate_v6_exception 3 1400 1450\n\techo\n\n\tvalidate_v4_exception 1 1300 0\n\tvalidate_v6_exception 1 1300 0\n\techo\n\n\tvalidate_v4_exception 2 1350 0\n\tvalidate_v6_exception 2 1350 0\n\techo\n\n\tvalidate_v4_exception 3 1400 0\n\tvalidate_v6_exception 3 1400 0\n\n\t# targeted deletes to trigger cleanup paths in kernel\n\tip -netns h0 ro del 172.16.102.0/24 nhid 4\n\tip -netns h0 -6 ro del 2001:db8:102::/64 nhid 6\n\n\tip -netns h0 nexthop del id 4\n\tip -netns h0 nexthop del id 6\nfi\n\ncleanup\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}