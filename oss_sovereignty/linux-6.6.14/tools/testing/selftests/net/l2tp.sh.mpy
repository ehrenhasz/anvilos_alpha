{
  "module_name": "l2tp.sh",
  "hash_id": "e47d407808ec1550ffe00dcbbb89a98d5bf2db91d914372e70a34d704ee55e1a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/l2tp.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# L2TPv3 tunnel between 2 hosts\n#\n#            host-1          |   router   |     host-2\n#                            |            |\n#      lo          l2tp      |            |      l2tp           lo\n# 172.16.101.1  172.16.1.1   |            | 172.16.1.2    172.16.101.2\n#  fc00:101::1   fc00:1::1   |            |   fc00:1::2    fc00:101::2\n#                            |            |\n#                  eth0      |            |     eth0\n#                10.1.1.1    |            |   10.1.2.1\n#              2001:db8:1::1 |            | 2001:db8:2::1\n\nVERBOSE=0\nPAUSE_ON_FAIL=no\n\nwhich ping6 > /dev/null 2>&1 && ping6=$(which ping6) || ping6=$(which ping)\n\n################################################################################\n#\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n}\n\nrun_cmd()\n{\n\tlocal ns\n\tlocal cmd\n\tlocal out\n\tlocal rc\n\n\tns=\"$1\"\n\tshift\n\tcmd=\"$*\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"    COMMAND: $cmd\\n\"\n\tfi\n\n\tout=$(eval ip netns exec ${ns} ${cmd} 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\n\treturn $rc\n}\n\n################################################################################\n# create namespaces and interconnects\n\ncreate_ns()\n{\n\tlocal ns=$1\n\tlocal addr=$2\n\tlocal addr6=$3\n\n\t[ -z \"${addr}\" ] && addr=\"-\"\n\t[ -z \"${addr6}\" ] && addr6=\"-\"\n\n\tip netns add ${ns}\n\n\tip -netns ${ns} link set lo up\n\tif [ \"${addr}\" != \"-\" ]; then\n\t\tip -netns ${ns} addr add dev lo ${addr}\n\tfi\n\tif [ \"${addr6}\" != \"-\" ]; then\n\t\tip -netns ${ns} -6 addr add dev lo ${addr6}\n\tfi\n\n\tip -netns ${ns} ro add unreachable default metric 8192\n\tip -netns ${ns} -6 ro add unreachable default metric 8192\n\n\tip netns exec ${ns} sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.accept_dad=0\n}\n\n# create veth pair to connect namespaces and apply addresses.\nconnect_ns()\n{\n\tlocal ns1=$1\n\tlocal ns1_dev=$2\n\tlocal ns1_addr=$3\n\tlocal ns1_addr6=$4\n\tlocal ns2=$5\n\tlocal ns2_dev=$6\n\tlocal ns2_addr=$7\n\tlocal ns2_addr6=$8\n\n\tip -netns ${ns1} li add ${ns1_dev} type veth peer name tmp\n\tip -netns ${ns1} li set ${ns1_dev} up\n\tip -netns ${ns1} li set tmp netns ${ns2} name ${ns2_dev}\n\tip -netns ${ns2} li set ${ns2_dev} up\n\n\tif [ \"${ns1_addr}\" != \"-\" ]; then\n\t\tip -netns ${ns1} addr add dev ${ns1_dev} ${ns1_addr}\n\t\tip -netns ${ns2} addr add dev ${ns2_dev} ${ns2_addr}\n\tfi\n\n\tif [ \"${ns1_addr6}\" != \"-\" ]; then\n\t\tip -netns ${ns1} addr add dev ${ns1_dev} ${ns1_addr6}\n\t\tip -netns ${ns2} addr add dev ${ns2_dev} ${ns2_addr6}\n\tfi\n}\n\n################################################################################\n# test setup\n\ncleanup()\n{\n\tlocal ns\n\n\tfor ns in host-1 host-2 router\n\tdo\n\t\tip netns del ${ns} 2>/dev/null\n\tdone\n}\n\nsetup_l2tp_ipv4()\n{\n\t#\n\t# configure l2tpv3 tunnel on host-1\n\t#\n\tip -netns host-1 l2tp add tunnel tunnel_id 1041 peer_tunnel_id 1042 \\\n\t\t\t encap ip local 10.1.1.1 remote 10.1.2.1\n\tip -netns host-1 l2tp add session name l2tp4 tunnel_id 1041 \\\n\t\t\t session_id 1041 peer_session_id 1042\n\tip -netns host-1 link set dev l2tp4 up\n\tip -netns host-1 addr add dev l2tp4 172.16.1.1 peer 172.16.1.2\n\n\t#\n\t# configure l2tpv3 tunnel on host-2\n\t#\n\tip -netns host-2 l2tp add tunnel tunnel_id 1042 peer_tunnel_id 1041 \\\n\t\t\t encap ip local 10.1.2.1 remote 10.1.1.1\n\tip -netns host-2 l2tp add session name l2tp4 tunnel_id 1042 \\\n\t\t\t session_id 1042 peer_session_id 1041\n\tip -netns host-2 link set dev l2tp4 up\n\tip -netns host-2 addr add dev l2tp4 172.16.1.2 peer 172.16.1.1\n\n\t#\n\t# add routes to loopback addresses\n\t#\n\tip -netns host-1 ro add 172.16.101.2/32 via 172.16.1.2\n\tip -netns host-2 ro add 172.16.101.1/32 via 172.16.1.1\n}\n\nsetup_l2tp_ipv6()\n{\n\t#\n\t# configure l2tpv3 tunnel on host-1\n\t#\n\tip -netns host-1 l2tp add tunnel tunnel_id 1061 peer_tunnel_id 1062 \\\n\t\t\t encap ip local 2001:db8:1::1 remote 2001:db8:2::1\n\tip -netns host-1 l2tp add session name l2tp6 tunnel_id 1061 \\\n\t\t\t session_id 1061 peer_session_id 1062\n\tip -netns host-1 link set dev l2tp6 up\n\tip -netns host-1 addr add dev l2tp6 fc00:1::1 peer fc00:1::2\n\n\t#\n\t# configure l2tpv3 tunnel on host-2\n\t#\n\tip -netns host-2 l2tp add tunnel tunnel_id 1062 peer_tunnel_id 1061 \\\n\t\t\t encap ip local 2001:db8:2::1 remote 2001:db8:1::1\n\tip -netns host-2 l2tp add session name l2tp6 tunnel_id 1062 \\\n\t\t\t session_id 1062 peer_session_id 1061\n\tip -netns host-2 link set dev l2tp6 up\n\tip -netns host-2 addr add dev l2tp6 fc00:1::2 peer fc00:1::1\n\n\t#\n\t# add routes to loopback addresses\n\t#\n\tip -netns host-1 -6 ro add fc00:101::2/128 via fc00:1::2\n\tip -netns host-2 -6 ro add fc00:101::1/128 via fc00:1::1\n}\n\nsetup()\n{\n\t# start clean\n\tcleanup\n\n\tset -e\n\tcreate_ns host-1 172.16.101.1/32 fc00:101::1/128\n\tcreate_ns host-2 172.16.101.2/32 fc00:101::2/128\n\tcreate_ns router\n\n\tconnect_ns host-1 eth0 10.1.1.1/24 2001:db8:1::1/64 \\\n\t           router eth1 10.1.1.2/24 2001:db8:1::2/64\n\n\tconnect_ns host-2 eth0 10.1.2.1/24 2001:db8:2::1/64 \\\n\t           router eth2 10.1.2.2/24 2001:db8:2::2/64\n\n\tip -netns host-1 ro add 10.1.2.0/24 via 10.1.1.2\n\tip -netns host-1 -6 ro add 2001:db8:2::/64 via 2001:db8:1::2\n\n\tip -netns host-2 ro add 10.1.1.0/24 via 10.1.2.2\n\tip -netns host-2 -6 ro add 2001:db8:1::/64 via 2001:db8:2::2\n\n\tsetup_l2tp_ipv4\n\tsetup_l2tp_ipv6\n\tset +e\n}\n\nsetup_ipsec()\n{\n\t#\n\t# IPv4\n\t#\n\trun_cmd host-1 ip xfrm policy add \\\n\t\tsrc 10.1.1.1 dst 10.1.2.1 dir out \\\n\t\ttmpl proto esp mode transport\n\n\trun_cmd host-1 ip xfrm policy add \\\n\t\tsrc 10.1.2.1 dst 10.1.1.1 dir in \\\n\t\ttmpl proto esp mode transport\n\n\trun_cmd host-2 ip xfrm policy add \\\n\t\tsrc 10.1.1.1 dst 10.1.2.1 dir in \\\n\t\ttmpl proto esp mode transport\n\n\trun_cmd host-2 ip xfrm policy add \\\n\t\tsrc 10.1.2.1 dst 10.1.1.1 dir out \\\n\t\ttmpl proto esp mode transport\n\n\tip -netns host-1 xfrm state add \\\n\t\tsrc 10.1.1.1 dst 10.1.2.1 \\\n\t\tspi 0x1000 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\tip -netns host-1 xfrm state add \\\n\t\tsrc 10.1.2.1 dst 10.1.1.1 \\\n\t\tspi 0x1001 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\tip -netns host-2 xfrm state add \\\n\t\tsrc 10.1.1.1 dst 10.1.2.1 \\\n\t\tspi 0x1000 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\tip -netns host-2 xfrm state add \\\n\t\tsrc 10.1.2.1 dst 10.1.1.1 \\\n\t\tspi 0x1001 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\t#\n\t# IPV6\n\t#\n\trun_cmd host-1 ip -6 xfrm policy add \\\n\t\tsrc 2001:db8:1::1 dst 2001:db8:2::1 dir out \\\n\t\ttmpl proto esp mode transport\n\n\trun_cmd host-1 ip -6 xfrm policy add \\\n\t\tsrc 2001:db8:2::1 dst 2001:db8:1::1 dir in \\\n\t\ttmpl proto esp mode transport\n\n\trun_cmd host-2 ip -6 xfrm policy add \\\n\t\tsrc 2001:db8:1::1 dst 2001:db8:2::1 dir in \\\n\t\ttmpl proto esp mode transport\n\n\trun_cmd host-2 ip -6 xfrm policy add \\\n\t\tsrc 2001:db8:2::1 dst 2001:db8:1::1 dir out \\\n\t\ttmpl proto esp mode transport\n\n\tip -netns host-1 -6 xfrm state add \\\n\t\tsrc 2001:db8:1::1 dst 2001:db8:2::1 \\\n\t\tspi 0x1000 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\tip -netns host-1 -6 xfrm state add \\\n\t\tsrc 2001:db8:2::1 dst 2001:db8:1::1 \\\n\t\tspi 0x1001 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\tip -netns host-2 -6 xfrm state add \\\n\t\tsrc 2001:db8:1::1 dst 2001:db8:2::1 \\\n\t\tspi 0x1000 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n\n\tip -netns host-2 -6 xfrm state add \\\n\t\tsrc 2001:db8:2::1 dst 2001:db8:1::1 \\\n\t\tspi 0x1001 proto esp aead 'rfc4106(gcm(aes))' \\\n\t\t0x0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f 128 mode transport\n}\n\nteardown_ipsec()\n{\n\trun_cmd host-1 ip xfrm state flush\n\trun_cmd host-1 ip xfrm policy flush\n\trun_cmd host-2 ip xfrm state flush\n\trun_cmd host-2 ip xfrm policy flush\n}\n\n################################################################################\n# generate traffic through tunnel for various cases\n\nrun_ping()\n{\n\tlocal desc=\"$1\"\n\n\trun_cmd host-1 ping -c1 -w1 172.16.1.2\n\tlog_test $? 0 \"IPv4 basic L2TP tunnel ${desc}\"\n\n\trun_cmd host-1 ping -c1 -w1 -I 172.16.101.1 172.16.101.2\n\tlog_test $? 0 \"IPv4 route through L2TP tunnel ${desc}\"\n\n\trun_cmd host-1 ${ping6} -c1 -w1 fc00:1::2\n\tlog_test $? 0 \"IPv6 basic L2TP tunnel ${desc}\"\n\n\trun_cmd host-1 ${ping6} -c1 -w1 -I fc00:101::1 fc00:101::2\n\tlog_test $? 0 \"IPv6 route through L2TP tunnel ${desc}\"\n}\n\nrun_tests()\n{\n\tlocal desc\n\n\tsetup\n\trun_ping\n\n\tsetup_ipsec\n\trun_ping \"- with IPsec\"\n\trun_cmd host-1 ping -c1 -w1 172.16.1.2\n\tlog_test $? 0 \"IPv4 basic L2TP tunnel ${desc}\"\n\n\trun_cmd host-1 ping -c1 -w1 -I 172.16.101.1 172.16.101.2\n\tlog_test $? 0 \"IPv4 route through L2TP tunnel ${desc}\"\n\n\trun_cmd host-1 ${ping6} -c1 -w1 fc00:1::2\n\tlog_test $? 0 \"IPv6 basic L2TP tunnel - with IPsec\"\n\n\trun_cmd host-1 ${ping6} -c1 -w1 -I fc00:101::1 fc00:101::2\n\tlog_test $? 0 \"IPv6 route through L2TP tunnel - with IPsec\"\n\n\tteardown_ipsec\n\trun_ping \"- after IPsec teardown\"\n}\n\n################################################################################\n# main\n\ndeclare -i nfail=0\ndeclare -i nsuccess=0\n\nwhile getopts :pv o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\t*) exit 1;;\n\tesac\ndone\n\nrun_tests\ncleanup\n\nprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\nprintf \"Tests failed: %3d\\n\"   ${nfail}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}