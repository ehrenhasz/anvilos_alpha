{
  "module_name": "arp_ndisc_untracked_subnets.sh",
  "hash_id": "964c35c78c6648ebbb34919f4768a14e48f27b07da4cb2b866ffd2b712816215",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/arp_ndisc_untracked_subnets.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# 2 namespaces: one host and one router. Use arping from the host to send a\n# garp to the router. Router accepts or ignores based on its arp_accept\n# or accept_untracked_na configuration.\n\nTESTS=\"arp ndisc\"\n\nROUTER_NS=\"ns-router\"\nROUTER_NS_V6=\"ns-router-v6\"\nROUTER_INTF=\"veth-router\"\nROUTER_ADDR=\"10.0.10.1\"\nROUTER_ADDR_V6=\"2001:db8:abcd:0012::1\"\n\nHOST_NS=\"ns-host\"\nHOST_NS_V6=\"ns-host-v6\"\nHOST_INTF=\"veth-host\"\nHOST_ADDR=\"10.0.10.2\"\nHOST_ADDR_V6=\"2001:db8:abcd:0012::2\"\n\nSUBNET_WIDTH=24\nPREFIX_WIDTH_V6=64\n\ncleanup() {\n\tip netns del ${HOST_NS}\n\tip netns del ${ROUTER_NS}\n}\n\ncleanup_v6() {\n\tip netns del ${HOST_NS_V6}\n\tip netns del ${ROUTER_NS_V6}\n}\n\nsetup() {\n\tset -e\n\tlocal arp_accept=$1\n\n\t# Set up two namespaces\n\tip netns add ${ROUTER_NS}\n\tip netns add ${HOST_NS}\n\n\t# Set up interfaces veth0 and veth1, which are pairs in separate\n\t# namespaces. veth0 is veth-router, veth1 is veth-host.\n\t# first, set up the inteface's link to the namespace\n\t# then, set the interface \"up\"\n\tip netns exec ${ROUTER_NS} ip link add name ${ROUTER_INTF} \\\n\t\ttype veth peer name ${HOST_INTF}\n\n\tip netns exec ${ROUTER_NS} ip link set dev ${ROUTER_INTF} up\n\tip netns exec ${ROUTER_NS} ip link set dev ${HOST_INTF} netns ${HOST_NS}\n\n\tip netns exec ${HOST_NS} ip link set dev ${HOST_INTF} up\n\tip netns exec ${ROUTER_NS} ip addr add ${ROUTER_ADDR}/${SUBNET_WIDTH} \\\n\t\tdev ${ROUTER_INTF}\n\n\tip netns exec ${HOST_NS} ip addr add ${HOST_ADDR}/${SUBNET_WIDTH} \\\n\t\tdev ${HOST_INTF}\n\tip netns exec ${HOST_NS} ip route add default via ${HOST_ADDR} \\\n\t\tdev ${HOST_INTF}\n\tip netns exec ${ROUTER_NS} ip route add default via ${ROUTER_ADDR} \\\n\t\tdev ${ROUTER_INTF}\n\n\tROUTER_CONF=net.ipv4.conf.${ROUTER_INTF}\n\tip netns exec ${ROUTER_NS} sysctl -w \\\n\t\t${ROUTER_CONF}.arp_accept=${arp_accept} >/dev/null 2>&1\n\tset +e\n}\n\nsetup_v6() {\n\tset -e\n\tlocal accept_untracked_na=$1\n\n\t# Set up two namespaces\n\tip netns add ${ROUTER_NS_V6}\n\tip netns add ${HOST_NS_V6}\n\n\t# Set up interfaces veth0 and veth1, which are pairs in separate\n\t# namespaces. veth0 is veth-router, veth1 is veth-host.\n\t# first, set up the inteface's link to the namespace\n\t# then, set the interface \"up\"\n\tip -6 -netns ${ROUTER_NS_V6} link add name ${ROUTER_INTF} \\\n\t\ttype veth peer name ${HOST_INTF}\n\n\tip -6 -netns ${ROUTER_NS_V6} link set dev ${ROUTER_INTF} up\n\tip -6 -netns ${ROUTER_NS_V6} link set dev ${HOST_INTF} netns \\\n\t\t${HOST_NS_V6}\n\n\tip -6 -netns ${HOST_NS_V6} link set dev ${HOST_INTF} up\n\tip -6 -netns ${ROUTER_NS_V6} addr add \\\n\t\t${ROUTER_ADDR_V6}/${PREFIX_WIDTH_V6} dev ${ROUTER_INTF} nodad\n\n\tHOST_CONF=net.ipv6.conf.${HOST_INTF}\n\tip netns exec ${HOST_NS_V6} sysctl -qw ${HOST_CONF}.ndisc_notify=1\n\tip netns exec ${HOST_NS_V6} sysctl -qw ${HOST_CONF}.disable_ipv6=0\n\tip -6 -netns ${HOST_NS_V6} addr add ${HOST_ADDR_V6}/${PREFIX_WIDTH_V6} \\\n\t\tdev ${HOST_INTF}\n\n\tROUTER_CONF=net.ipv6.conf.${ROUTER_INTF}\n\n\tip netns exec ${ROUTER_NS_V6} sysctl -w \\\n\t\t${ROUTER_CONF}.forwarding=1 >/dev/null 2>&1\n\tip netns exec ${ROUTER_NS_V6} sysctl -w \\\n\t\t${ROUTER_CONF}.drop_unsolicited_na=0 >/dev/null 2>&1\n\tip netns exec ${ROUTER_NS_V6} sysctl -w \\\n\t\t${ROUTER_CONF}.accept_untracked_na=${accept_untracked_na} \\\n\t\t>/dev/null 2>&1\n\tset +e\n}\n\nverify_arp() {\n\tlocal arp_accept=$1\n\tlocal same_subnet=$2\n\n\tneigh_show_output=$(ip netns exec ${ROUTER_NS} ip neigh get \\\n\t\t${HOST_ADDR} dev ${ROUTER_INTF} 2>/dev/null)\n\n\tif [ ${arp_accept} -eq 1 ]; then\n\t\t# Neighbor entries expected\n\t\t[[ ${neigh_show_output} ]]\n\telif [ ${arp_accept} -eq 2 ]; then\n\t\tif [ ${same_subnet} -eq 1 ]; then\n\t\t\t# Neighbor entries expected\n\t\t\t[[ ${neigh_show_output} ]]\n\t\telse\n\t\t\t[[ -z \"${neigh_show_output}\" ]]\n\t\tfi\n\telse\n\t\t[[ -z \"${neigh_show_output}\" ]]\n\tfi\n }\n\narp_test_gratuitous() {\n\tset -e\n\tlocal arp_accept=$1\n\tlocal same_subnet=$2\n\n\tif [ ${arp_accept} -eq 2 ]; then\n\t\ttest_msg=(\"test_arp: \"\n\t\t\t  \"accept_arp=$1 \"\n\t\t\t  \"same_subnet=$2\")\n\t\tif [ ${same_subnet} -eq 0 ]; then\n\t\t\tHOST_ADDR=10.0.11.3\n\t\telse\n\t\t\tHOST_ADDR=10.0.10.3\n\t\tfi\n\telse\n\t\ttest_msg=(\"test_arp: \"\n\t\t\t  \"accept_arp=$1\")\n\tfi\n\t# Supply arp_accept option to set up which sets it in sysctl\n\tsetup ${arp_accept}\n\tip netns exec ${HOST_NS} arping -A -I ${HOST_INTF} -U ${HOST_ADDR} -c1 2>&1 >/dev/null\n\n\tif verify_arp $1 $2; then\n\t\tprintf \"    TEST: %-60s  [ OK ]\\n\" \"${test_msg[*]}\"\n\telse\n\t\tprintf \"    TEST: %-60s  [FAIL]\\n\" \"${test_msg[*]}\"\n\tfi\n\tcleanup\n\tset +e\n}\n\narp_test_gratuitous_combinations() {\n\tarp_test_gratuitous 0\n\tarp_test_gratuitous 1\n\tarp_test_gratuitous 2 0 # Second entry indicates subnet or not\n\tarp_test_gratuitous 2 1\n}\n\ncleanup_tcpdump() {\n\tset -e\n\t[[ ! -z  ${tcpdump_stdout} ]] && rm -f ${tcpdump_stdout}\n\t[[ ! -z  ${tcpdump_stderr} ]] && rm -f ${tcpdump_stderr}\n\ttcpdump_stdout=\n\ttcpdump_stderr=\n\tset +e\n}\n\nstart_tcpdump() {\n\tset -e\n\ttcpdump_stdout=`mktemp`\n\ttcpdump_stderr=`mktemp`\n\tip netns exec ${ROUTER_NS_V6} timeout 15s \\\n\t\ttcpdump --immediate-mode -tpni ${ROUTER_INTF} -c 1 \\\n\t\t\"icmp6 && icmp6[0] == 136 && src ${HOST_ADDR_V6}\" \\\n\t\t> ${tcpdump_stdout} 2> /dev/null\n\tset +e\n}\n\nverify_ndisc() {\n\tlocal accept_untracked_na=$1\n\tlocal same_subnet=$2\n\n\tneigh_show_output=$(ip -6 -netns ${ROUTER_NS_V6} neigh show \\\n\t\tto ${HOST_ADDR_V6} dev ${ROUTER_INTF} nud stale)\n\n\tif [ ${accept_untracked_na} -eq 1 ]; then\n\t\t# Neighbour entry expected to be present\n\t\t[[ ${neigh_show_output} ]]\n\telif [ ${accept_untracked_na} -eq 2 ]; then\n\t\tif [ ${same_subnet} -eq 1 ]; then\n\t\t\t[[ ${neigh_show_output} ]]\n\t\telse\n\t\t\t[[ -z \"${neigh_show_output}\" ]]\n\t\tfi\n\telse\n\t\t# Neighbour entry expected to be absent for all other cases\n\t\t[[ -z \"${neigh_show_output}\" ]]\n\tfi\n}\n\nndisc_test_untracked_advertisements() {\n\tset -e\n\ttest_msg=(\"test_ndisc: \"\n\t\t  \"accept_untracked_na=$1\")\n\n\tlocal accept_untracked_na=$1\n\tlocal same_subnet=$2\n\tif [ ${accept_untracked_na} -eq 2 ]; then\n\t\ttest_msg=(\"test_ndisc: \"\n\t\t\t  \"accept_untracked_na=$1 \"\n\t\t\t  \"same_subnet=$2\")\n\t\tif [ ${same_subnet} -eq 0 ]; then\n\t\t\t# Not same subnet\n\t\t\tHOST_ADDR_V6=2000:db8:abcd:0013::4\n\t\telse\n\t\t\tHOST_ADDR_V6=2001:db8:abcd:0012::3\n\t\tfi\n\tfi\n\tsetup_v6 $1 $2\n\tstart_tcpdump\n\n\tif verify_ndisc $1 $2; then\n\t\tprintf \"    TEST: %-60s  [ OK ]\\n\" \"${test_msg[*]}\"\n\telse\n\t\tprintf \"    TEST: %-60s  [FAIL]\\n\" \"${test_msg[*]}\"\n\tfi\n\n\tcleanup_tcpdump\n\tcleanup_v6\n\tset +e\n}\n\nndisc_test_untracked_combinations() {\n\tndisc_test_untracked_advertisements 0\n\tndisc_test_untracked_advertisements 1\n\tndisc_test_untracked_advertisements 2 0\n\tndisc_test_untracked_advertisements 2 1\n}\n\n################################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n\t-t <test>       Test(s) to run (default: all)\n\t\t\t(options: $TESTS)\nEOF\n}\n\n################################################################################\n# main\n\nwhile getopts \":t:h\" opt; do\n\tcase $opt in\n\t\tt) TESTS=$OPTARG;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v tcpdump)\" ]; then\n\techo \"SKIP: Could not run test without tcpdump tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v arping)\" ]; then\n\techo \"SKIP: Could not run test without arping tool\"\n\texit $ksft_skip\nfi\n\n# start clean\ncleanup &> /dev/null\ncleanup_v6 &> /dev/null\n\nfor t in $TESTS\ndo\n\tcase $t in\n\tarp_test_gratuitous_combinations|arp) arp_test_gratuitous_combinations;;\n\tndisc_test_untracked_combinations|ndisc) \\\n\t\tndisc_test_untracked_combinations;;\n\thelp) echo \"Test names: $TESTS\"; exit 0;;\nesac\ndone\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}