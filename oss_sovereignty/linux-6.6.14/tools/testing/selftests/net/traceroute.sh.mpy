{
  "module_name": "traceroute.sh",
  "hash_id": "14efb5c2784564ee3a18f8d8797d85ac2e346a75c1546cba691c0d995daaefd2",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/traceroute.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Run traceroute/traceroute6 tests\n#\n\nVERBOSE=0\nPAUSE_ON_FAIL=no\n\n################################################################################\n#\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n}\n\nrun_cmd()\n{\n\tlocal ns\n\tlocal cmd\n\tlocal out\n\tlocal rc\n\n\tns=\"$1\"\n\tshift\n\tcmd=\"$*\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"    COMMAND: $cmd\\n\"\n\tfi\n\n\tout=$(eval ip netns exec ${ns} ${cmd} 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\n\treturn $rc\n}\n\n################################################################################\n# create namespaces and interconnects\n\ncreate_ns()\n{\n\tlocal ns=$1\n\tlocal addr=$2\n\tlocal addr6=$3\n\n\t[ -z \"${addr}\" ] && addr=\"-\"\n\t[ -z \"${addr6}\" ] && addr6=\"-\"\n\n\tip netns add ${ns}\n\n\tip netns exec ${ns} ip link set lo up\n\tif [ \"${addr}\" != \"-\" ]; then\n\t\tip netns exec ${ns} ip addr add dev lo ${addr}\n\tfi\n\tif [ \"${addr6}\" != \"-\" ]; then\n\t\tip netns exec ${ns} ip -6 addr add dev lo ${addr6}\n\tfi\n\n\tip netns exec ${ns} ip ro add unreachable default metric 8192\n\tip netns exec ${ns} ip -6 ro add unreachable default metric 8192\n\n\tip netns exec ${ns} sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.accept_dad=0\n}\n\n# create veth pair to connect namespaces and apply addresses.\nconnect_ns()\n{\n\tlocal ns1=$1\n\tlocal ns1_dev=$2\n\tlocal ns1_addr=$3\n\tlocal ns1_addr6=$4\n\tlocal ns2=$5\n\tlocal ns2_dev=$6\n\tlocal ns2_addr=$7\n\tlocal ns2_addr6=$8\n\n\tip netns exec ${ns1} ip li add ${ns1_dev} type veth peer name tmp\n\tip netns exec ${ns1} ip li set ${ns1_dev} up\n\tip netns exec ${ns1} ip li set tmp netns ${ns2} name ${ns2_dev}\n\tip netns exec ${ns2} ip li set ${ns2_dev} up\n\n\tif [ \"${ns1_addr}\" != \"-\" ]; then\n\t\tip netns exec ${ns1} ip addr add dev ${ns1_dev} ${ns1_addr}\n\tfi\n\n\tif [ \"${ns2_addr}\" != \"-\" ]; then\n\t\tip netns exec ${ns2} ip addr add dev ${ns2_dev} ${ns2_addr}\n\tfi\n\n\tif [ \"${ns1_addr6}\" != \"-\" ]; then\n\t\tip netns exec ${ns1} ip addr add dev ${ns1_dev} ${ns1_addr6}\n\tfi\n\n\tif [ \"${ns2_addr6}\" != \"-\" ]; then\n\t\tip netns exec ${ns2} ip addr add dev ${ns2_dev} ${ns2_addr6}\n\tfi\n}\n\n################################################################################\n# traceroute6 test\n#\n# Verify that in this scenario\n#\n#        ------------------------ N2\n#         |                    |\n#       ------              ------  N3  ----\n#       | R1 |              | R2 |------|H2|\n#       ------              ------      ----\n#         |                    |\n#        ------------------------ N1\n#                  |\n#                 ----\n#                 |H1|\n#                 ----\n#\n# where H1's default route goes through R1 and R1's default route goes\n# through R2 over N2, traceroute6 from H1 to H2 reports R2's address\n# on N2 and not N1.\n#\n# Addresses are assigned as follows:\n#\n# N1: 2000:101::/64\n# N2: 2000:102::/64\n# N3: 2000:103::/64\n#\n# R1's host part of address: 1\n# R2's host part of address: 2\n# H1's host part of address: 3\n# H2's host part of address: 4\n#\n# For example:\n# the IPv6 address of R1's interface on N2 is 2000:102::1/64\n\ncleanup_traceroute6()\n{\n\tlocal ns\n\n\tfor ns in host-1 host-2 router-1 router-2\n\tdo\n\t\tip netns del ${ns} 2>/dev/null\n\tdone\n}\n\nsetup_traceroute6()\n{\n\tbrdev=br0\n\n\t# start clean\n\tcleanup_traceroute6\n\n\tset -e\n\tcreate_ns host-1\n\tcreate_ns host-2\n\tcreate_ns router-1\n\tcreate_ns router-2\n\n\t# Setup N3\n\tconnect_ns router-2 eth3 - 2000:103::2/64 host-2 eth3 - 2000:103::4/64\n\tip netns exec host-2 ip route add default via 2000:103::2\n\n\t# Setup N2\n\tconnect_ns router-1 eth2 - 2000:102::1/64 router-2 eth2 - 2000:102::2/64\n\tip netns exec router-1 ip route add default via 2000:102::2\n\n\t# Setup N1. host-1 and router-2 connect to a bridge in router-1.\n\tip netns exec router-1 ip link add name ${brdev} type bridge\n\tip netns exec router-1 ip link set ${brdev} up\n\tip netns exec router-1 ip addr add 2000:101::1/64 dev ${brdev}\n\n\tconnect_ns host-1 eth0 - 2000:101::3/64 router-1 eth0 - -\n\tip netns exec router-1 ip link set dev eth0 master ${brdev}\n\tip netns exec host-1 ip route add default via 2000:101::1\n\n\tconnect_ns router-2 eth1 - 2000:101::2/64 router-1 eth1 - -\n\tip netns exec router-1 ip link set dev eth1 master ${brdev}\n\n\t# Prime the network\n\tip netns exec host-1 ping6 -c5 2000:103::4 >/dev/null 2>&1\n\n\tset +e\n}\n\nrun_traceroute6()\n{\n\tif [ ! -x \"$(command -v traceroute6)\" ]; then\n\t\techo \"SKIP: Could not run IPV6 test without traceroute6\"\n\t\treturn\n\tfi\n\n\tsetup_traceroute6\n\n\t# traceroute6 host-2 from host-1 (expects 2000:102::2)\n\trun_cmd host-1 \"traceroute6 2000:103::4 | grep -q 2000:102::2\"\n\tlog_test $? 0 \"IPV6 traceroute\"\n\n\tcleanup_traceroute6\n}\n\n################################################################################\n# traceroute test\n#\n# Verify that traceroute from H1 to H2 shows 1.0.1.1 in this scenario\n#\n#                    1.0.3.1/24\n# ---- 1.0.1.3/24    1.0.1.1/24 ---- 1.0.2.1/24    1.0.2.4/24 ----\n# |H1|--------------------------|R1|--------------------------|H2|\n# ----            N1            ----            N2            ----\n#\n# where net.ipv4.icmp_errors_use_inbound_ifaddr is set on R1 and\n# 1.0.3.1/24 and 1.0.1.1/24 are respectively R1's primary and secondary\n# address on N1.\n#\n\ncleanup_traceroute()\n{\n\tlocal ns\n\n\tfor ns in host-1 host-2 router\n\tdo\n\t\tip netns del ${ns} 2>/dev/null\n\tdone\n}\n\nsetup_traceroute()\n{\n\t# start clean\n\tcleanup_traceroute\n\n\tset -e\n\tcreate_ns host-1\n\tcreate_ns host-2\n\tcreate_ns router\n\n\tconnect_ns host-1 eth0 1.0.1.3/24 - \\\n\t           router eth1 1.0.3.1/24 -\n\tip netns exec host-1 ip route add default via 1.0.1.1\n\n\tip netns exec router ip addr add 1.0.1.1/24 dev eth1\n\tip netns exec router sysctl -qw \\\n\t\t\t\tnet.ipv4.icmp_errors_use_inbound_ifaddr=1\n\n\tconnect_ns host-2 eth0 1.0.2.4/24 - \\\n\t           router eth2 1.0.2.1/24 -\n\tip netns exec host-2 ip route add default via 1.0.2.1\n\n\t# Prime the network\n\tip netns exec host-1 ping -c5 1.0.2.4 >/dev/null 2>&1\n\n\tset +e\n}\n\nrun_traceroute()\n{\n\tif [ ! -x \"$(command -v traceroute)\" ]; then\n\t\techo \"SKIP: Could not run IPV4 test without traceroute\"\n\t\treturn\n\tfi\n\n\tsetup_traceroute\n\n\t# traceroute host-2 from host-1 (expects 1.0.1.1). Takes a while.\n\trun_cmd host-1 \"traceroute 1.0.2.4 | grep -q 1.0.1.1\"\n\tlog_test $? 0 \"IPV4 traceroute\"\n\n\tcleanup_traceroute\n}\n\n################################################################################\n# Run tests\n\nrun_tests()\n{\n\trun_traceroute6\n\trun_traceroute\n}\n\n################################################################################\n# main\n\ndeclare -i nfail=0\ndeclare -i nsuccess=0\n\nwhile getopts :pv o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\t*) exit 1;;\n\tesac\ndone\n\nrun_tests\n\nprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\nprintf \"Tests failed: %3d\\n\"   ${nfail}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}