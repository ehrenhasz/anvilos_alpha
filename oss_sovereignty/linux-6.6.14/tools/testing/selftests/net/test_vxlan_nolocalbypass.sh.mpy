{
  "module_name": "test_vxlan_nolocalbypass.sh",
  "hash_id": "ac4b84309d02a225f6c63c2aa8fb0f7f0222ec0b701fa752709b8a9573a13994",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/test_vxlan_nolocalbypass.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test is for checking the [no]localbypass VXLAN device option. The test\n# configures two VXLAN devices in the same network namespace and a tc filter on\n# the loopback device that drops encapsulated packets. The test sends packets\n# from the first VXLAN device and verifies that by default these packets are\n# received by the second VXLAN device. The test then enables the nolocalbypass\n# option and verifies that packets are no longer received by the second VXLAN\n# device.\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nTESTS=\"\n\tnolocalbypass\n\"\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\n\n################################################################################\n# Utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\t\techo \"    rc=$rc, expected $expected\"\n\t\tfi\n\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$1\"\n\tlocal out\n\tlocal stderr=\"2>/dev/null\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"COMMAND: $cmd\\n\"\n\t\tstderr=\n\tfi\n\n\tout=$(eval $cmd $stderr)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\treturn $rc\n}\n\ntc_check_packets()\n{\n\tlocal ns=$1; shift\n\tlocal id=$1; shift\n\tlocal handle=$1; shift\n\tlocal count=$1; shift\n\tlocal pkts\n\n\tsleep 0.1\n\tpkts=$(tc -n $ns -j -s filter show $id \\\n\t\t| jq \".[] | select(.options.handle == $handle) | \\\n\t\t.options.actions[0].stats.packets\")\n\t[[ $pkts == $count ]]\n}\n\n################################################################################\n# Setup\n\nsetup()\n{\n\tip netns add ns1\n\n\tip -n ns1 link set dev lo up\n\tip -n ns1 address add 192.0.2.1/32 dev lo\n\tip -n ns1 address add 198.51.100.1/32 dev lo\n\n\tip -n ns1 link add name vx0 up type vxlan id 100 local 198.51.100.1 \\\n\t\tdstport 4789 nolearning\n\tip -n ns1 link add name vx1 up type vxlan id 100 dstport 4790\n}\n\ncleanup()\n{\n\tip netns del ns1 &> /dev/null\n}\n\n################################################################################\n# Tests\n\nnolocalbypass()\n{\n\tlocal smac=00:01:02:03:04:05\n\tlocal dmac=00:0a:0b:0c:0d:0e\n\n\trun_cmd \"bridge -n ns1 fdb add $dmac dev vx0 self static dst 192.0.2.1 port 4790\"\n\n\trun_cmd \"tc -n ns1 qdisc add dev vx1 clsact\"\n\trun_cmd \"tc -n ns1 filter add dev vx1 ingress pref 1 handle 101 proto all flower src_mac $smac dst_mac $dmac action pass\"\n\n\trun_cmd \"tc -n ns1 qdisc add dev lo clsact\"\n\trun_cmd \"tc -n ns1 filter add dev lo ingress pref 1 handle 101 proto ip flower ip_proto udp dst_port 4790 action drop\"\n\n\trun_cmd \"ip -n ns1 -d -j link show dev vx0 | jq -e '.[][\\\"linkinfo\\\"][\\\"info_data\\\"][\\\"localbypass\\\"] == true'\"\n\tlog_test $? 0 \"localbypass enabled\"\n\n\trun_cmd \"ip netns exec ns1 mausezahn vx0 -a $smac -b $dmac -c 1 -p 100 -q\"\n\n\ttc_check_packets \"ns1\" \"dev vx1 ingress\" 101 1\n\tlog_test $? 0 \"Packet received by local VXLAN device - localbypass\"\n\n\trun_cmd \"ip -n ns1 link set dev vx0 type vxlan nolocalbypass\"\n\n\trun_cmd \"ip -n ns1 -d -j link show dev vx0 | jq -e '.[][\\\"linkinfo\\\"][\\\"info_data\\\"][\\\"localbypass\\\"] == false'\"\n\tlog_test $? 0 \"localbypass disabled\"\n\n\trun_cmd \"ip netns exec ns1 mausezahn vx0 -a $smac -b $dmac -c 1 -p 100 -q\"\n\n\ttc_check_packets \"ns1\" \"dev vx1 ingress\" 101 1\n\tlog_test $? 0 \"Packet not received by local VXLAN device - nolocalbypass\"\n\n\trun_cmd \"ip -n ns1 link set dev vx0 type vxlan localbypass\"\n\n\trun_cmd \"ip -n ns1 -d -j link show dev vx0 | jq -e '.[][\\\"linkinfo\\\"][\\\"info_data\\\"][\\\"localbypass\\\"] == true'\"\n\tlog_test $? 0 \"localbypass enabled\"\n\n\trun_cmd \"ip netns exec ns1 mausezahn vx0 -a $smac -b $dmac -c 1 -p 100 -q\"\n\n\ttc_check_packets \"ns1\" \"dev vx1 ingress\" 101 2\n\tlog_test $? 0 \"Packet received by local VXLAN device - localbypass\"\n}\n\n################################################################################\n# Usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $TESTS)\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\n        -v          Verbose mode (show commands and output)\nEOF\n}\n\n################################################################################\n# Main\n\ntrap cleanup EXIT\n\nwhile getopts \":t:pPvh\" opt; do\n\tcase $opt in\n\t\tt) TESTS=$OPTARG ;;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# Make sure we don't pause twice.\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v bridge)\" ]; then\n\techo \"SKIP: Could not run test without bridge tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v mausezahn)\" ]; then\n\techo \"SKIP: Could not run test without mausezahn tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v jq)\" ]; then\n\techo \"SKIP: Could not run test without jq tool\"\n\texit $ksft_skip\nfi\n\nip link help vxlan 2>&1 | grep -q \"localbypass\"\nif [ $? -ne 0 ]; then\n\techo \"SKIP: iproute2 ip too old, missing VXLAN nolocalbypass support\"\n\texit $ksft_skip\nfi\n\ncleanup\n\nfor t in $TESTS\ndo\n\tsetup; $t; cleanup;\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}