{
  "module_name": "fin_ack_lat.c",
  "hash_id": "b1d55f526d137c83e6d914b79b5b2b35a56a30d24b400a60cd1b77af0578195c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/fin_ack_lat.c",
  "human_readable_source": "\n\n#include <arpa/inet.h>\n#include <errno.h>\n#include <error.h>\n#include <netinet/in.h>\n#include <netinet/tcp.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/socket.h>\n#include <sys/time.h>\n#include <unistd.h>\n\nstatic int child_pid;\n\nstatic unsigned long timediff(struct timeval s, struct timeval e)\n{\n\tunsigned long s_us, e_us;\n\n\ts_us = s.tv_sec * 1000000 + s.tv_usec;\n\te_us = e.tv_sec * 1000000 + e.tv_usec;\n\tif (s_us > e_us)\n\t\treturn 0;\n\treturn e_us - s_us;\n}\n\nstatic void client(int port)\n{\n\tint sock = 0;\n\tstruct sockaddr_in addr, laddr;\n\tsocklen_t len = sizeof(laddr);\n\tstruct linger sl;\n\tint flag = 1;\n\tint buffer;\n\tstruct timeval start, end;\n\tunsigned long lat, sum_lat = 0, nr_lat = 0;\n\n\twhile (1) {\n\t\tgettimeofday(&start, NULL);\n\n\t\tsock = socket(AF_INET, SOCK_STREAM, 0);\n\t\tif (sock < 0)\n\t\t\terror(-1, errno, \"socket creation\");\n\n\t\tsl.l_onoff = 1;\n\t\tsl.l_linger = 0;\n\t\tif (setsockopt(sock, SOL_SOCKET, SO_LINGER, &sl, sizeof(sl)))\n\t\t\terror(-1, errno, \"setsockopt(linger)\");\n\n\t\tif (setsockopt(sock, IPPROTO_TCP, TCP_NODELAY,\n\t\t\t\t\t&flag, sizeof(flag)))\n\t\t\terror(-1, errno, \"setsockopt(nodelay)\");\n\n\t\taddr.sin_family = AF_INET;\n\t\taddr.sin_port = htons(port);\n\n\t\tif (inet_pton(AF_INET, \"127.0.0.1\", &addr.sin_addr) <= 0)\n\t\t\terror(-1, errno, \"inet_pton\");\n\n\t\tif (connect(sock, (struct sockaddr *)&addr, sizeof(addr)) < 0)\n\t\t\terror(-1, errno, \"connect\");\n\n\t\tsend(sock, &buffer, sizeof(buffer), 0);\n\t\tif (read(sock, &buffer, sizeof(buffer)) == -1)\n\t\t\terror(-1, errno, \"waiting read\");\n\n\t\tgettimeofday(&end, NULL);\n\t\tlat = timediff(start, end);\n\t\tsum_lat += lat;\n\t\tnr_lat++;\n\t\tif (lat < 100000)\n\t\t\tgoto close;\n\n\t\tif (getsockname(sock, (struct sockaddr *)&laddr, &len) == -1)\n\t\t\terror(-1, errno, \"getsockname\");\n\t\tprintf(\"port: %d, lat: %lu, avg: %lu, nr: %lu\\n\",\n\t\t\t\tntohs(laddr.sin_port), lat,\n\t\t\t\tsum_lat / nr_lat, nr_lat);\nclose:\n\t\tfflush(stdout);\n\t\tclose(sock);\n\t}\n}\n\nstatic void server(int sock, struct sockaddr_in address)\n{\n\tint accepted;\n\tint addrlen = sizeof(address);\n\tint buffer;\n\n\twhile (1) {\n\t\taccepted = accept(sock, (struct sockaddr *)&address,\n\t\t\t\t(socklen_t *)&addrlen);\n\t\tif (accepted < 0)\n\t\t\terror(-1, errno, \"accept\");\n\n\t\tif (read(accepted, &buffer, sizeof(buffer)) == -1)\n\t\t\terror(-1, errno, \"read\");\n\t\tclose(accepted);\n\t}\n}\n\nstatic void sig_handler(int signum)\n{\n\tkill(SIGTERM, child_pid);\n\texit(0);\n}\n\nint main(int argc, char const *argv[])\n{\n\tint sock;\n\tint opt = 1;\n\tstruct sockaddr_in address;\n\tstruct sockaddr_in laddr;\n\tsocklen_t len = sizeof(laddr);\n\n\tif (signal(SIGTERM, sig_handler) == SIG_ERR)\n\t\terror(-1, errno, \"signal\");\n\n\tsock = socket(AF_INET, SOCK_STREAM, 0);\n\tif (sock < 0)\n\t\terror(-1, errno, \"socket\");\n\n\tif (setsockopt(sock, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT,\n\t\t\t\t&opt, sizeof(opt)) == -1)\n\t\terror(-1, errno, \"setsockopt\");\n\n\taddress.sin_family = AF_INET;\n\taddress.sin_addr.s_addr = INADDR_ANY;\n\t \n\taddress.sin_port = 0;\n\n\tif (bind(sock, (struct sockaddr *)&address, sizeof(address)) < 0)\n\t\terror(-1, errno, \"bind\");\n\n\tif (listen(sock, 3) < 0)\n\t\terror(-1, errno, \"listen\");\n\n\tif (getsockname(sock, (struct sockaddr *)&laddr, &len) == -1)\n\t\terror(-1, errno, \"getsockname\");\n\n\tfprintf(stderr, \"server port: %d\\n\", ntohs(laddr.sin_port));\n\tchild_pid = fork();\n\tif (!child_pid)\n\t\tclient(ntohs(laddr.sin_port));\n\telse\n\t\tserver(sock, laddr);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}