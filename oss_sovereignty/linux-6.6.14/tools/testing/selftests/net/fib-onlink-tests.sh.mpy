{
  "module_name": "fib-onlink-tests.sh",
  "hash_id": "e690ac475c30e0d58a987497ec0bfe0d2220eb47cb83473bf6f9702cb4a93a28",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/fib-onlink-tests.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# IPv4 and IPv6 onlink tests\n\nPAUSE_ON_FAIL=${PAUSE_ON_FAIL:=no}\nVERBOSE=0\n\n# Network interfaces\n# - odd in current namespace; even in peer ns\ndeclare -A NETIFS\n# default VRF\nNETIFS[p1]=veth1\nNETIFS[p2]=veth2\nNETIFS[p3]=veth3\nNETIFS[p4]=veth4\n# VRF\nNETIFS[p5]=veth5\nNETIFS[p6]=veth6\nNETIFS[p7]=veth7\nNETIFS[p8]=veth8\n\n# /24 network\ndeclare -A V4ADDRS\nV4ADDRS[p1]=169.254.1.1\nV4ADDRS[p2]=169.254.1.2\nV4ADDRS[p3]=169.254.3.1\nV4ADDRS[p4]=169.254.3.2\nV4ADDRS[p5]=169.254.5.1\nV4ADDRS[p6]=169.254.5.2\nV4ADDRS[p7]=169.254.7.1\nV4ADDRS[p8]=169.254.7.2\n\n# /64 network\ndeclare -A V6ADDRS\nV6ADDRS[p1]=2001:db8:101::1\nV6ADDRS[p2]=2001:db8:101::2\nV6ADDRS[p3]=2001:db8:301::1\nV6ADDRS[p4]=2001:db8:301::2\nV6ADDRS[p5]=2001:db8:501::1\nV6ADDRS[p6]=2001:db8:501::2\nV6ADDRS[p7]=2001:db8:701::1\nV6ADDRS[p8]=2001:db8:701::2\n\n# Test networks:\n# [1] = default table\n# [2] = VRF\n#\n# /32 host routes\ndeclare -A TEST_NET4\nTEST_NET4[1]=169.254.101\nTEST_NET4[2]=169.254.102\n# /128 host routes\ndeclare -A TEST_NET6\nTEST_NET6[1]=2001:db8:101\nTEST_NET6[2]=2001:db8:102\n\n# connected gateway\nCONGW[1]=169.254.1.254\nCONGW[2]=169.254.3.254\nCONGW[3]=169.254.5.254\n\n# recursive gateway\nRECGW4[1]=169.254.11.254\nRECGW4[2]=169.254.12.254\nRECGW6[1]=2001:db8:11::64\nRECGW6[2]=2001:db8:12::64\n\n# for v4 mapped to v6\ndeclare -A TEST_NET4IN6IN6\nTEST_NET4IN6[1]=10.1.1.254\nTEST_NET4IN6[2]=10.2.1.254\n\n# mcast address\nMCAST6=ff02::1\n\n\nPEER_NS=bart\nPEER_CMD=\"ip netns exec ${PEER_NS}\"\nVRF=lisa\nVRF_TABLE=1101\nPBR_TABLE=101\n\n################################################################################\n# utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tnsuccess=$((nsuccess+1))\n\t\tprintf \"    TEST: %-50s  [ OK ]\\n\" \"${msg}\"\n\telse\n\t\tnfail=$((nfail+1))\n\t\tprintf \"    TEST: %-50s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n}\n\nlog_section()\n{\n\techo\n\techo \"######################################################################\"\n\techo \"TEST SECTION: $*\"\n\techo \"######################################################################\"\n}\n\nlog_subsection()\n{\n\techo\n\techo \"#########################################\"\n\techo \"TEST SUBSECTION: $*\"\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$*\"\n\tlocal out\n\tlocal rc\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"    COMMAND: $cmd\\n\"\n\tfi\n\n\tout=$(eval $cmd 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\n\treturn $rc\n}\n\nget_linklocal()\n{\n\tlocal dev=$1\n\tlocal pfx\n\tlocal addr\n\n\taddr=$(${pfx} ip -6 -br addr show dev ${dev} | \\\n\tawk '{\n\t\tfor (i = 3; i <= NF; ++i) {\n\t\t\tif ($i ~ /^fe80/)\n\t\t\t\tprint $i\n\t\t}\n\t}'\n\t)\n\taddr=${addr/\\/*}\n\n\t[ -z \"$addr\" ] && return 1\n\n\techo $addr\n\n\treturn 0\n}\n\n################################################################################\n#\n\nsetup()\n{\n\techo\n\techo \"########################################\"\n\techo \"Configuring interfaces\"\n\n\tset -e\n\n\t# create namespace\n\tip netns add ${PEER_NS}\n\tip -netns ${PEER_NS} li set lo up\n\n\t# add vrf table\n\tip li add ${VRF} type vrf table ${VRF_TABLE}\n\tip li set ${VRF} up\n\tip ro add table ${VRF_TABLE} unreachable default metric 8192\n\tip -6 ro add table ${VRF_TABLE} unreachable default metric 8192\n\n\t# create test interfaces\n\tip li add ${NETIFS[p1]} type veth peer name ${NETIFS[p2]}\n\tip li add ${NETIFS[p3]} type veth peer name ${NETIFS[p4]}\n\tip li add ${NETIFS[p5]} type veth peer name ${NETIFS[p6]}\n\tip li add ${NETIFS[p7]} type veth peer name ${NETIFS[p8]}\n\n\t# enslave vrf interfaces\n\tfor n in 5 7; do\n\t\tip li set ${NETIFS[p${n}]} vrf ${VRF}\n\tdone\n\n\t# add addresses\n\tfor n in 1 3 5 7; do\n\t\tip li set ${NETIFS[p${n}]} up\n\t\tip addr add ${V4ADDRS[p${n}]}/24 dev ${NETIFS[p${n}]}\n\t\tip addr add ${V6ADDRS[p${n}]}/64 dev ${NETIFS[p${n}]} nodad\n\tdone\n\n\t# move peer interfaces to namespace and add addresses\n\tfor n in 2 4 6 8; do\n\t\tip li set ${NETIFS[p${n}]} netns ${PEER_NS} up\n\t\tip -netns ${PEER_NS} addr add ${V4ADDRS[p${n}]}/24 dev ${NETIFS[p${n}]}\n\t\tip -netns ${PEER_NS} addr add ${V6ADDRS[p${n}]}/64 dev ${NETIFS[p${n}]} nodad\n\tdone\n\n\tip -6 ro add default via ${V6ADDRS[p3]/::[0-9]/::64}\n\tip -6 ro add table ${VRF_TABLE} default via ${V6ADDRS[p7]/::[0-9]/::64}\n\n\tset +e\n}\n\ncleanup()\n{\n\t# make sure we start from a clean slate\n\tip netns del ${PEER_NS} 2>/dev/null\n\tfor n in 1 3 5 7; do\n\t\tip link del ${NETIFS[p${n}]} 2>/dev/null\n\tdone\n\tip link del ${VRF} 2>/dev/null\n\tip ro flush table ${VRF_TABLE}\n\tip -6 ro flush table ${VRF_TABLE}\n}\n\n################################################################################\n# IPv4 tests\n#\n\nrun_ip()\n{\n\tlocal table=\"$1\"\n\tlocal prefix=\"$2\"\n\tlocal gw=\"$3\"\n\tlocal dev=\"$4\"\n\tlocal exp_rc=\"$5\"\n\tlocal desc=\"$6\"\n\n\t# dev arg may be empty\n\t[ -n \"${dev}\" ] && dev=\"dev ${dev}\"\n\n\trun_cmd ip ro add table \"${table}\" \"${prefix}\"/32 via \"${gw}\" \"${dev}\" onlink\n\tlog_test $? ${exp_rc} \"${desc}\"\n}\n\nrun_ip_mpath()\n{\n\tlocal table=\"$1\"\n\tlocal prefix=\"$2\"\n\tlocal nh1=\"$3\"\n\tlocal nh2=\"$4\"\n\tlocal exp_rc=\"$5\"\n\tlocal desc=\"$6\"\n\n\t# dev arg may be empty\n\t[ -n \"${dev}\" ] && dev=\"dev ${dev}\"\n\n\trun_cmd ip ro add table \"${table}\" \"${prefix}\"/32 \\\n\t\tnexthop via ${nh1} nexthop via ${nh2}\n\tlog_test $? ${exp_rc} \"${desc}\"\n}\n\nvalid_onlink_ipv4()\n{\n\t# - unicast connected, unicast recursive\n\t#\n\tlog_subsection \"default VRF - main table\"\n\n\trun_ip 254 ${TEST_NET4[1]}.1 ${CONGW[1]} ${NETIFS[p1]} 0 \"unicast connected\"\n\trun_ip 254 ${TEST_NET4[1]}.2 ${RECGW4[1]} ${NETIFS[p1]} 0 \"unicast recursive\"\n\n\tlog_subsection \"VRF ${VRF}\"\n\n\trun_ip ${VRF_TABLE} ${TEST_NET4[2]}.1 ${CONGW[3]} ${NETIFS[p5]} 0 \"unicast connected\"\n\trun_ip ${VRF_TABLE} ${TEST_NET4[2]}.2 ${RECGW4[2]} ${NETIFS[p5]} 0 \"unicast recursive\"\n\n\tlog_subsection \"VRF device, PBR table\"\n\n\trun_ip ${PBR_TABLE} ${TEST_NET4[2]}.3 ${CONGW[3]} ${NETIFS[p5]} 0 \"unicast connected\"\n\trun_ip ${PBR_TABLE} ${TEST_NET4[2]}.4 ${RECGW4[2]} ${NETIFS[p5]} 0 \"unicast recursive\"\n\n\t# multipath version\n\t#\n\tlog_subsection \"default VRF - main table - multipath\"\n\n\trun_ip_mpath 254 ${TEST_NET4[1]}.5 \\\n\t\t\"${CONGW[1]} dev ${NETIFS[p1]} onlink\" \\\n\t\t\"${CONGW[2]} dev ${NETIFS[p3]} onlink\" \\\n\t\t0 \"unicast connected - multipath\"\n\n\trun_ip_mpath 254 ${TEST_NET4[1]}.6 \\\n\t\t\"${RECGW4[1]} dev ${NETIFS[p1]} onlink\" \\\n\t\t\"${RECGW4[2]} dev ${NETIFS[p3]} onlink\" \\\n\t\t0 \"unicast recursive - multipath\"\n\n\trun_ip_mpath 254 ${TEST_NET4[1]}.7 \\\n\t\t\"${CONGW[1]} dev ${NETIFS[p1]}\"        \\\n\t\t\"${CONGW[2]} dev ${NETIFS[p3]} onlink\" \\\n\t\t0 \"unicast connected - multipath onlink first only\"\n\n\trun_ip_mpath 254 ${TEST_NET4[1]}.8 \\\n\t\t\"${CONGW[1]} dev ${NETIFS[p1]} onlink\" \\\n\t\t\"${CONGW[2]} dev ${NETIFS[p3]}\"        \\\n\t\t0 \"unicast connected - multipath onlink second only\"\n}\n\ninvalid_onlink_ipv4()\n{\n\trun_ip 254 ${TEST_NET4[1]}.11 ${V4ADDRS[p1]} ${NETIFS[p1]} 2 \\\n\t\t\"Invalid gw - local unicast address\"\n\n\trun_ip ${VRF_TABLE} ${TEST_NET4[2]}.11 ${V4ADDRS[p5]} ${NETIFS[p5]} 2 \\\n\t\t\"Invalid gw - local unicast address, VRF\"\n\n\trun_ip 254 ${TEST_NET4[1]}.101 ${V4ADDRS[p1]} \"\" 2 \"No nexthop device given\"\n\n\trun_ip 254 ${TEST_NET4[1]}.102 ${V4ADDRS[p3]} ${NETIFS[p1]} 2 \\\n\t\t\"Gateway resolves to wrong nexthop device\"\n\n\trun_ip ${VRF_TABLE} ${TEST_NET4[2]}.103 ${V4ADDRS[p7]} ${NETIFS[p5]} 2 \\\n\t\t\"Gateway resolves to wrong nexthop device - VRF\"\n}\n\n################################################################################\n# IPv6 tests\n#\n\nrun_ip6()\n{\n\tlocal table=\"$1\"\n\tlocal prefix=\"$2\"\n\tlocal gw=\"$3\"\n\tlocal dev=\"$4\"\n\tlocal exp_rc=\"$5\"\n\tlocal desc=\"$6\"\n\n\t# dev arg may be empty\n\t[ -n \"${dev}\" ] && dev=\"dev ${dev}\"\n\n\trun_cmd ip -6 ro add table \"${table}\" \"${prefix}\"/128 via \"${gw}\" \"${dev}\" onlink\n\tlog_test $? ${exp_rc} \"${desc}\"\n}\n\nrun_ip6_mpath()\n{\n\tlocal table=\"$1\"\n\tlocal prefix=\"$2\"\n\tlocal opts=\"$3\"\n\tlocal nh1=\"$4\"\n\tlocal nh2=\"$5\"\n\tlocal exp_rc=\"$6\"\n\tlocal desc=\"$7\"\n\n\trun_cmd ip -6 ro add table \"${table}\" \"${prefix}\"/128 \"${opts}\" \\\n\t\tnexthop via ${nh1} nexthop via ${nh2}\n\tlog_test $? ${exp_rc} \"${desc}\"\n}\n\nvalid_onlink_ipv6()\n{\n\t# - unicast connected, unicast recursive, v4-mapped\n\t#\n\tlog_subsection \"default VRF - main table\"\n\n\trun_ip6 254 ${TEST_NET6[1]}::1 ${V6ADDRS[p1]/::*}::64 ${NETIFS[p1]} 0 \"unicast connected\"\n\trun_ip6 254 ${TEST_NET6[1]}::2 ${RECGW6[1]} ${NETIFS[p1]} 0 \"unicast recursive\"\n\trun_ip6 254 ${TEST_NET6[1]}::3 ::ffff:${TEST_NET4IN6[1]} ${NETIFS[p1]} 0 \"v4-mapped\"\n\n\tlog_subsection \"VRF ${VRF}\"\n\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::1 ${V6ADDRS[p5]/::*}::64 ${NETIFS[p5]} 0 \"unicast connected\"\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::2 ${RECGW6[2]} ${NETIFS[p5]} 0 \"unicast recursive\"\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::3 ::ffff:${TEST_NET4IN6[2]} ${NETIFS[p5]} 0 \"v4-mapped\"\n\n\tlog_subsection \"VRF device, PBR table\"\n\n\trun_ip6 ${PBR_TABLE} ${TEST_NET6[2]}::4 ${V6ADDRS[p5]/::*}::64 ${NETIFS[p5]} 0 \"unicast connected\"\n\trun_ip6 ${PBR_TABLE} ${TEST_NET6[2]}::5 ${RECGW6[2]} ${NETIFS[p5]} 0 \"unicast recursive\"\n\trun_ip6 ${PBR_TABLE} ${TEST_NET6[2]}::6 ::ffff:${TEST_NET4IN6[2]} ${NETIFS[p5]} 0 \"v4-mapped\"\n\n\t# multipath version\n\t#\n\tlog_subsection \"default VRF - main table - multipath\"\n\n\trun_ip6_mpath 254 ${TEST_NET6[1]}::4 \"onlink\" \\\n\t\t\"${V6ADDRS[p1]/::*}::64 dev ${NETIFS[p1]}\" \\\n\t\t\"${V6ADDRS[p3]/::*}::64 dev ${NETIFS[p3]}\" \\\n\t\t0 \"unicast connected - multipath onlink\"\n\n\trun_ip6_mpath 254 ${TEST_NET6[1]}::5 \"onlink\" \\\n\t\t\"${RECGW6[1]} dev ${NETIFS[p1]}\" \\\n\t\t\"${RECGW6[2]} dev ${NETIFS[p3]}\" \\\n\t\t0 \"unicast recursive - multipath onlink\"\n\n\trun_ip6_mpath 254 ${TEST_NET6[1]}::6 \"onlink\" \\\n\t\t\"::ffff:${TEST_NET4IN6[1]} dev ${NETIFS[p1]}\" \\\n\t\t\"::ffff:${TEST_NET4IN6[2]} dev ${NETIFS[p3]}\" \\\n\t\t0 \"v4-mapped - multipath onlink\"\n\n\trun_ip6_mpath 254 ${TEST_NET6[1]}::7 \"\" \\\n\t\t\"${V6ADDRS[p1]/::*}::64 dev ${NETIFS[p1]} onlink\" \\\n\t\t\"${V6ADDRS[p3]/::*}::64 dev ${NETIFS[p3]} onlink\" \\\n\t\t0 \"unicast connected - multipath onlink both nexthops\"\n\n\trun_ip6_mpath 254 ${TEST_NET6[1]}::8 \"\" \\\n\t\t\"${V6ADDRS[p1]/::*}::64 dev ${NETIFS[p1]} onlink\" \\\n\t\t\"${V6ADDRS[p3]/::*}::64 dev ${NETIFS[p3]}\" \\\n\t\t0 \"unicast connected - multipath onlink first only\"\n\n\trun_ip6_mpath 254 ${TEST_NET6[1]}::9 \"\" \\\n\t\t\"${V6ADDRS[p1]/::*}::64 dev ${NETIFS[p1]}\"        \\\n\t\t\"${V6ADDRS[p3]/::*}::64 dev ${NETIFS[p3]} onlink\" \\\n\t\t0 \"unicast connected - multipath onlink second only\"\n}\n\ninvalid_onlink_ipv6()\n{\n\tlocal lladdr\n\n\tlladdr=$(get_linklocal ${NETIFS[p1]}) || return 1\n\n\trun_ip6 254 ${TEST_NET6[1]}::11 ${V6ADDRS[p1]} ${NETIFS[p1]} 2 \\\n\t\t\"Invalid gw - local unicast address\"\n\trun_ip6 254 ${TEST_NET6[1]}::12 ${lladdr} ${NETIFS[p1]} 2 \\\n\t\t\"Invalid gw - local linklocal address\"\n\trun_ip6 254 ${TEST_NET6[1]}::12 ${MCAST6} ${NETIFS[p1]} 2 \\\n\t\t\"Invalid gw - multicast address\"\n\n\tlladdr=$(get_linklocal ${NETIFS[p5]}) || return 1\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::11 ${V6ADDRS[p5]} ${NETIFS[p5]} 2 \\\n\t\t\"Invalid gw - local unicast address, VRF\"\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::12 ${lladdr} ${NETIFS[p5]} 2 \\\n\t\t\"Invalid gw - local linklocal address, VRF\"\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::12 ${MCAST6} ${NETIFS[p5]} 2 \\\n\t\t\"Invalid gw - multicast address, VRF\"\n\n\trun_ip6 254 ${TEST_NET6[1]}::101 ${V6ADDRS[p1]} \"\" 2 \\\n\t\t\"No nexthop device given\"\n\n\t# default VRF validation is done against LOCAL table\n\t# run_ip6 254 ${TEST_NET6[1]}::102 ${V6ADDRS[p3]/::[0-9]/::64} ${NETIFS[p1]} 2 \\\n\t#\t\"Gateway resolves to wrong nexthop device\"\n\n\trun_ip6 ${VRF_TABLE} ${TEST_NET6[2]}::103 ${V6ADDRS[p7]/::[0-9]/::64} ${NETIFS[p5]} 2 \\\n\t\t\"Gateway resolves to wrong nexthop device - VRF\"\n}\n\nrun_onlink_tests()\n{\n\tlog_section \"IPv4 onlink\"\n\tlog_subsection \"Valid onlink commands\"\n\tvalid_onlink_ipv4\n\tlog_subsection \"Invalid onlink commands\"\n\tinvalid_onlink_ipv4\n\n\tlog_section \"IPv6 onlink\"\n\tlog_subsection \"Valid onlink commands\"\n\tvalid_onlink_ipv6\n\tlog_subsection \"Invalid onlink commands\"\n\tinvalid_onlink_ipv6\n}\n\n################################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -p          Pause on fail\n        -v          verbose mode (show commands and output)\nEOF\n}\n\n################################################################################\n# main\n\nnsuccess=0\nnfail=0\n\nwhile getopts :t:pPhv o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\ncleanup\nsetup\nrun_onlink_tests\ncleanup\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}