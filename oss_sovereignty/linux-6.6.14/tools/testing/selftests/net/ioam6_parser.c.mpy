{
  "module_name": "ioam6_parser.c",
  "hash_id": "a385d2b63df25a8e569078701c0bd1c5f16915053fe5d4e5434147d29eb355a3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/ioam6_parser.c",
  "human_readable_source": "\n \n#include <arpa/inet.h>\n#include <errno.h>\n#include <limits.h>\n#include <linux/const.h>\n#include <linux/if_ether.h>\n#include <linux/ioam6.h>\n#include <linux/ipv6.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\nstruct ioam_config {\n\t__u32 id;\n\t__u64 wide;\n\t__u16 ingr_id;\n\t__u16 egr_id;\n\t__u32 ingr_wide;\n\t__u32 egr_wide;\n\t__u32 ns_data;\n\t__u64 ns_wide;\n\t__u32 sc_id;\n\t__u8 hlim;\n\tchar *sc_data;\n};\n\n \n\nstatic struct ioam_config node1 = {\n\t.id = 1,\n\t.wide = 11111111,\n\t.ingr_id = 0xffff,  \n\t.egr_id = 101,\n\t.ingr_wide = 0xffffffff,  \n\t.egr_wide = 101101,\n\t.ns_data = 0xdeadbee0,\n\t.ns_wide = 0xcafec0caf00dc0de,\n\t.sc_id = 777,\n\t.sc_data = \"something that will be 4n-aligned\",\n\t.hlim = 64,\n};\n\nstatic struct ioam_config node2 = {\n\t.id = 2,\n\t.wide = 22222222,\n\t.ingr_id = 201,\n\t.egr_id = 202,\n\t.ingr_wide = 201201,\n\t.egr_wide = 202202,\n\t.ns_data = 0xdeadbee1,\n\t.ns_wide = 0xcafec0caf11dc0de,\n\t.sc_id = 666,\n\t.sc_data = \"Hello there -Obi\",\n\t.hlim = 63,\n};\n\nstatic struct ioam_config node3 = {\n\t.id = 3,\n\t.wide = 33333333,\n\t.ingr_id = 301,\n\t.egr_id = 0xffff,  \n\t.ingr_wide = 301301,\n\t.egr_wide = 0xffffffff,  \n\t.ns_data = 0xdeadbee2,\n\t.ns_wide = 0xcafec0caf22dc0de,\n\t.sc_id = 0xffffff,  \n\t.sc_data = NULL,\n\t.hlim = 62,\n};\n\nenum {\n\t \n\tTEST_OUT_UNDEF_NS,\n\tTEST_OUT_NO_ROOM,\n\tTEST_OUT_BIT0,\n\tTEST_OUT_BIT1,\n\tTEST_OUT_BIT2,\n\tTEST_OUT_BIT3,\n\tTEST_OUT_BIT4,\n\tTEST_OUT_BIT5,\n\tTEST_OUT_BIT6,\n\tTEST_OUT_BIT7,\n\tTEST_OUT_BIT8,\n\tTEST_OUT_BIT9,\n\tTEST_OUT_BIT10,\n\tTEST_OUT_BIT11,\n\tTEST_OUT_BIT22,\n\tTEST_OUT_FULL_SUPP_TRACE,\n\n\t \n\tTEST_IN_UNDEF_NS,\n\tTEST_IN_NO_ROOM,\n\tTEST_IN_OFLAG,\n\tTEST_IN_BIT0,\n\tTEST_IN_BIT1,\n\tTEST_IN_BIT2,\n\tTEST_IN_BIT3,\n\tTEST_IN_BIT4,\n\tTEST_IN_BIT5,\n\tTEST_IN_BIT6,\n\tTEST_IN_BIT7,\n\tTEST_IN_BIT8,\n\tTEST_IN_BIT9,\n\tTEST_IN_BIT10,\n\tTEST_IN_BIT11,\n\tTEST_IN_BIT22,\n\tTEST_IN_FULL_SUPP_TRACE,\n\n\t \n\tTEST_FWD_FULL_SUPP_TRACE,\n\n\t__TEST_MAX,\n};\n\nstatic int check_ioam_header(int tid, struct ioam6_trace_hdr *ioam6h,\n\t\t\t     __u32 trace_type, __u16 ioam_ns)\n{\n\tif (__be16_to_cpu(ioam6h->namespace_id) != ioam_ns ||\n\t    __be32_to_cpu(ioam6h->type_be32) != (trace_type << 8))\n\t\treturn 1;\n\n\tswitch (tid) {\n\tcase TEST_OUT_UNDEF_NS:\n\tcase TEST_IN_UNDEF_NS:\n\t\treturn ioam6h->overflow ||\n\t\t       ioam6h->nodelen != 1 ||\n\t\t       ioam6h->remlen != 1;\n\n\tcase TEST_OUT_NO_ROOM:\n\tcase TEST_IN_NO_ROOM:\n\tcase TEST_IN_OFLAG:\n\t\treturn !ioam6h->overflow ||\n\t\t       ioam6h->nodelen != 2 ||\n\t\t       ioam6h->remlen != 1;\n\n\tcase TEST_OUT_BIT0:\n\tcase TEST_IN_BIT0:\n\tcase TEST_OUT_BIT1:\n\tcase TEST_IN_BIT1:\n\tcase TEST_OUT_BIT2:\n\tcase TEST_IN_BIT2:\n\tcase TEST_OUT_BIT3:\n\tcase TEST_IN_BIT3:\n\tcase TEST_OUT_BIT4:\n\tcase TEST_IN_BIT4:\n\tcase TEST_OUT_BIT5:\n\tcase TEST_IN_BIT5:\n\tcase TEST_OUT_BIT6:\n\tcase TEST_IN_BIT6:\n\tcase TEST_OUT_BIT7:\n\tcase TEST_IN_BIT7:\n\tcase TEST_OUT_BIT11:\n\tcase TEST_IN_BIT11:\n\t\treturn ioam6h->overflow ||\n\t\t       ioam6h->nodelen != 1 ||\n\t\t       ioam6h->remlen;\n\n\tcase TEST_OUT_BIT8:\n\tcase TEST_IN_BIT8:\n\tcase TEST_OUT_BIT9:\n\tcase TEST_IN_BIT9:\n\tcase TEST_OUT_BIT10:\n\tcase TEST_IN_BIT10:\n\t\treturn ioam6h->overflow ||\n\t\t       ioam6h->nodelen != 2 ||\n\t\t       ioam6h->remlen;\n\n\tcase TEST_OUT_BIT22:\n\tcase TEST_IN_BIT22:\n\t\treturn ioam6h->overflow ||\n\t\t       ioam6h->nodelen ||\n\t\t       ioam6h->remlen;\n\n\tcase TEST_OUT_FULL_SUPP_TRACE:\n\tcase TEST_IN_FULL_SUPP_TRACE:\n\tcase TEST_FWD_FULL_SUPP_TRACE:\n\t\treturn ioam6h->overflow ||\n\t\t       ioam6h->nodelen != 15 ||\n\t\t       ioam6h->remlen;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 1;\n}\n\nstatic int check_ioam6_data(__u8 **p, struct ioam6_trace_hdr *ioam6h,\n\t\t\t    const struct ioam_config cnf)\n{\n\tunsigned int len;\n\t__u8 aligned;\n\t__u64 raw64;\n\t__u32 raw32;\n\n\tif (ioam6h->type.bit0) {\n\t\traw32 = __be32_to_cpu(*((__u32 *)*p));\n\t\tif (cnf.hlim != (raw32 >> 24) || cnf.id != (raw32 & 0xffffff))\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit1) {\n\t\traw32 = __be32_to_cpu(*((__u32 *)*p));\n\t\tif (cnf.ingr_id != (raw32 >> 16) ||\n\t\t    cnf.egr_id != (raw32 & 0xffff))\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit2)\n\t\t*p += sizeof(__u32);\n\n\tif (ioam6h->type.bit3)\n\t\t*p += sizeof(__u32);\n\n\tif (ioam6h->type.bit4) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit5) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != cnf.ns_data)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit6)\n\t\t*p += sizeof(__u32);\n\n\tif (ioam6h->type.bit7) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit8) {\n\t\traw64 = __be64_to_cpu(*((__u64 *)*p));\n\t\tif (cnf.hlim != (raw64 >> 56) ||\n\t\t    cnf.wide != (raw64 & 0xffffffffffffff))\n\t\t\treturn 1;\n\t\t*p += sizeof(__u64);\n\t}\n\n\tif (ioam6h->type.bit9) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != cnf.ingr_wide)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != cnf.egr_wide)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit10) {\n\t\tif (__be64_to_cpu(*((__u64 *)*p)) != cnf.ns_wide)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u64);\n\t}\n\n\tif (ioam6h->type.bit11) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit12) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit13) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit14) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit15) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit16) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit17) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit18) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit19) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit20) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit21) {\n\t\tif (__be32_to_cpu(*((__u32 *)*p)) != 0xffffffff)\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\t}\n\n\tif (ioam6h->type.bit22) {\n\t\tlen = cnf.sc_data ? strlen(cnf.sc_data) : 0;\n\t\taligned = cnf.sc_data ? __ALIGN_KERNEL(len, 4) : 0;\n\n\t\traw32 = __be32_to_cpu(*((__u32 *)*p));\n\t\tif (aligned != (raw32 >> 24) * 4 ||\n\t\t    cnf.sc_id != (raw32 & 0xffffff))\n\t\t\treturn 1;\n\t\t*p += sizeof(__u32);\n\n\t\tif (cnf.sc_data) {\n\t\t\tif (strncmp((char *)*p, cnf.sc_data, len))\n\t\t\t\treturn 1;\n\n\t\t\t*p += len;\n\t\t\taligned -= len;\n\n\t\t\twhile (aligned--) {\n\t\t\t\tif (**p != '\\0')\n\t\t\t\t\treturn 1;\n\t\t\t\t*p += sizeof(__u8);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int check_ioam_header_and_data(int tid, struct ioam6_trace_hdr *ioam6h,\n\t\t\t\t      __u32 trace_type, __u16 ioam_ns)\n{\n\t__u8 *p;\n\n\tif (check_ioam_header(tid, ioam6h, trace_type, ioam_ns))\n\t\treturn 1;\n\n\tp = ioam6h->data + ioam6h->remlen * 4;\n\n\tswitch (tid) {\n\tcase TEST_OUT_BIT0:\n\tcase TEST_OUT_BIT1:\n\tcase TEST_OUT_BIT2:\n\tcase TEST_OUT_BIT3:\n\tcase TEST_OUT_BIT4:\n\tcase TEST_OUT_BIT5:\n\tcase TEST_OUT_BIT6:\n\tcase TEST_OUT_BIT7:\n\tcase TEST_OUT_BIT8:\n\tcase TEST_OUT_BIT9:\n\tcase TEST_OUT_BIT10:\n\tcase TEST_OUT_BIT11:\n\tcase TEST_OUT_BIT22:\n\tcase TEST_OUT_FULL_SUPP_TRACE:\n\t\treturn check_ioam6_data(&p, ioam6h, node1);\n\n\tcase TEST_IN_BIT0:\n\tcase TEST_IN_BIT1:\n\tcase TEST_IN_BIT2:\n\tcase TEST_IN_BIT3:\n\tcase TEST_IN_BIT4:\n\tcase TEST_IN_BIT5:\n\tcase TEST_IN_BIT6:\n\tcase TEST_IN_BIT7:\n\tcase TEST_IN_BIT8:\n\tcase TEST_IN_BIT9:\n\tcase TEST_IN_BIT10:\n\tcase TEST_IN_BIT11:\n\tcase TEST_IN_BIT22:\n\tcase TEST_IN_FULL_SUPP_TRACE:\n\t{\n\t\t__u32 tmp32 = node2.egr_wide;\n\t\t__u16 tmp16 = node2.egr_id;\n\t\tint res;\n\n\t\tnode2.egr_id = 0xffff;\n\t\tnode2.egr_wide = 0xffffffff;\n\n\t\tres = check_ioam6_data(&p, ioam6h, node2);\n\n\t\tnode2.egr_id = tmp16;\n\t\tnode2.egr_wide = tmp32;\n\n\t\treturn res;\n\t}\n\n\tcase TEST_FWD_FULL_SUPP_TRACE:\n\t\tif (check_ioam6_data(&p, ioam6h, node3))\n\t\t\treturn 1;\n\t\tif (check_ioam6_data(&p, ioam6h, node2))\n\t\t\treturn 1;\n\t\treturn check_ioam6_data(&p, ioam6h, node1);\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 1;\n}\n\nstatic int str2id(const char *tname)\n{\n\tif (!strcmp(\"out_undef_ns\", tname))\n\t\treturn TEST_OUT_UNDEF_NS;\n\tif (!strcmp(\"out_no_room\", tname))\n\t\treturn TEST_OUT_NO_ROOM;\n\tif (!strcmp(\"out_bit0\", tname))\n\t\treturn TEST_OUT_BIT0;\n\tif (!strcmp(\"out_bit1\", tname))\n\t\treturn TEST_OUT_BIT1;\n\tif (!strcmp(\"out_bit2\", tname))\n\t\treturn TEST_OUT_BIT2;\n\tif (!strcmp(\"out_bit3\", tname))\n\t\treturn TEST_OUT_BIT3;\n\tif (!strcmp(\"out_bit4\", tname))\n\t\treturn TEST_OUT_BIT4;\n\tif (!strcmp(\"out_bit5\", tname))\n\t\treturn TEST_OUT_BIT5;\n\tif (!strcmp(\"out_bit6\", tname))\n\t\treturn TEST_OUT_BIT6;\n\tif (!strcmp(\"out_bit7\", tname))\n\t\treturn TEST_OUT_BIT7;\n\tif (!strcmp(\"out_bit8\", tname))\n\t\treturn TEST_OUT_BIT8;\n\tif (!strcmp(\"out_bit9\", tname))\n\t\treturn TEST_OUT_BIT9;\n\tif (!strcmp(\"out_bit10\", tname))\n\t\treturn TEST_OUT_BIT10;\n\tif (!strcmp(\"out_bit11\", tname))\n\t\treturn TEST_OUT_BIT11;\n\tif (!strcmp(\"out_bit22\", tname))\n\t\treturn TEST_OUT_BIT22;\n\tif (!strcmp(\"out_full_supp_trace\", tname))\n\t\treturn TEST_OUT_FULL_SUPP_TRACE;\n\tif (!strcmp(\"in_undef_ns\", tname))\n\t\treturn TEST_IN_UNDEF_NS;\n\tif (!strcmp(\"in_no_room\", tname))\n\t\treturn TEST_IN_NO_ROOM;\n\tif (!strcmp(\"in_oflag\", tname))\n\t\treturn TEST_IN_OFLAG;\n\tif (!strcmp(\"in_bit0\", tname))\n\t\treturn TEST_IN_BIT0;\n\tif (!strcmp(\"in_bit1\", tname))\n\t\treturn TEST_IN_BIT1;\n\tif (!strcmp(\"in_bit2\", tname))\n\t\treturn TEST_IN_BIT2;\n\tif (!strcmp(\"in_bit3\", tname))\n\t\treturn TEST_IN_BIT3;\n\tif (!strcmp(\"in_bit4\", tname))\n\t\treturn TEST_IN_BIT4;\n\tif (!strcmp(\"in_bit5\", tname))\n\t\treturn TEST_IN_BIT5;\n\tif (!strcmp(\"in_bit6\", tname))\n\t\treturn TEST_IN_BIT6;\n\tif (!strcmp(\"in_bit7\", tname))\n\t\treturn TEST_IN_BIT7;\n\tif (!strcmp(\"in_bit8\", tname))\n\t\treturn TEST_IN_BIT8;\n\tif (!strcmp(\"in_bit9\", tname))\n\t\treturn TEST_IN_BIT9;\n\tif (!strcmp(\"in_bit10\", tname))\n\t\treturn TEST_IN_BIT10;\n\tif (!strcmp(\"in_bit11\", tname))\n\t\treturn TEST_IN_BIT11;\n\tif (!strcmp(\"in_bit22\", tname))\n\t\treturn TEST_IN_BIT22;\n\tif (!strcmp(\"in_full_supp_trace\", tname))\n\t\treturn TEST_IN_FULL_SUPP_TRACE;\n\tif (!strcmp(\"fwd_full_supp_trace\", tname))\n\t\treturn TEST_FWD_FULL_SUPP_TRACE;\n\n\treturn -1;\n}\n\nstatic int ipv6_addr_equal(const struct in6_addr *a1, const struct in6_addr *a2)\n{\n\treturn ((a1->s6_addr32[0] ^ a2->s6_addr32[0]) |\n\t\t(a1->s6_addr32[1] ^ a2->s6_addr32[1]) |\n\t\t(a1->s6_addr32[2] ^ a2->s6_addr32[2]) |\n\t\t(a1->s6_addr32[3] ^ a2->s6_addr32[3])) == 0;\n}\n\nstatic int get_u32(__u32 *val, const char *arg, int base)\n{\n\tunsigned long res;\n\tchar *ptr;\n\n\tif (!arg || !*arg)\n\t\treturn -1;\n\tres = strtoul(arg, &ptr, base);\n\n\tif (!ptr || ptr == arg || *ptr)\n\t\treturn -1;\n\n\tif (res == ULONG_MAX && errno == ERANGE)\n\t\treturn -1;\n\n\tif (res > 0xFFFFFFFFUL)\n\t\treturn -1;\n\n\t*val = res;\n\treturn 0;\n}\n\nstatic int get_u16(__u16 *val, const char *arg, int base)\n{\n\tunsigned long res;\n\tchar *ptr;\n\n\tif (!arg || !*arg)\n\t\treturn -1;\n\tres = strtoul(arg, &ptr, base);\n\n\tif (!ptr || ptr == arg || *ptr)\n\t\treturn -1;\n\n\tif (res == ULONG_MAX && errno == ERANGE)\n\t\treturn -1;\n\n\tif (res > 0xFFFFUL)\n\t\treturn -1;\n\n\t*val = res;\n\treturn 0;\n}\n\nstatic int (*func[__TEST_MAX])(int, struct ioam6_trace_hdr *, __u32, __u16) = {\n\t[TEST_OUT_UNDEF_NS]\t\t= check_ioam_header,\n\t[TEST_OUT_NO_ROOM]\t\t= check_ioam_header,\n\t[TEST_OUT_BIT0]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT1]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT2]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT3]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT4]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT5]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT6]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT7]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT8]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT9]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT10]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT11]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_BIT22]\t\t= check_ioam_header_and_data,\n\t[TEST_OUT_FULL_SUPP_TRACE]\t= check_ioam_header_and_data,\n\t[TEST_IN_UNDEF_NS]\t\t= check_ioam_header,\n\t[TEST_IN_NO_ROOM]\t\t= check_ioam_header,\n\t[TEST_IN_OFLAG]\t\t= check_ioam_header,\n\t[TEST_IN_BIT0]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT1]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT2]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT3]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT4]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT5]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT6]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT7]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT8]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT9]\t\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT10]\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT11]\t\t= check_ioam_header_and_data,\n\t[TEST_IN_BIT22]\t\t= check_ioam_header_and_data,\n\t[TEST_IN_FULL_SUPP_TRACE]\t= check_ioam_header_and_data,\n\t[TEST_FWD_FULL_SUPP_TRACE]\t= check_ioam_header_and_data,\n};\n\nint main(int argc, char **argv)\n{\n\tint fd, size, hoplen, tid, ret = 1;\n\tstruct in6_addr src, dst;\n\tstruct ioam6_hdr *opt;\n\tstruct ipv6hdr *ip6h;\n\t__u8 buffer[400], *p;\n\t__u16 ioam_ns;\n\t__u32 tr_type;\n\n\tif (argc != 7)\n\t\tgoto out;\n\n\ttid = str2id(argv[2]);\n\tif (tid < 0 || !func[tid])\n\t\tgoto out;\n\n\tif (inet_pton(AF_INET6, argv[3], &src) != 1 ||\n\t    inet_pton(AF_INET6, argv[4], &dst) != 1)\n\t\tgoto out;\n\n\tif (get_u32(&tr_type, argv[5], 16) ||\n\t    get_u16(&ioam_ns, argv[6], 0))\n\t\tgoto out;\n\n\tfd = socket(AF_PACKET, SOCK_DGRAM, __cpu_to_be16(ETH_P_IPV6));\n\tif (!fd)\n\t\tgoto out;\n\n\tif (setsockopt(fd, SOL_SOCKET, SO_BINDTODEVICE,\n\t\t       argv[1], strlen(argv[1])))\n\t\tgoto close;\n\nrecv:\n\tsize = recv(fd, buffer, sizeof(buffer), 0);\n\tif (size <= 0)\n\t\tgoto close;\n\n\tip6h = (struct ipv6hdr *)buffer;\n\n\tif (!ipv6_addr_equal(&ip6h->saddr, &src) ||\n\t    !ipv6_addr_equal(&ip6h->daddr, &dst))\n\t\tgoto recv;\n\n\tif (ip6h->nexthdr != IPPROTO_HOPOPTS)\n\t\tgoto close;\n\n\tp = buffer + sizeof(*ip6h);\n\thoplen = (p[1] + 1) << 3;\n\tp += sizeof(struct ipv6_hopopt_hdr);\n\n\twhile (hoplen > 0) {\n\t\topt = (struct ioam6_hdr *)p;\n\n\t\tif (opt->opt_type == IPV6_TLV_IOAM &&\n\t\t    opt->type == IOAM6_TYPE_PREALLOC) {\n\t\t\tp += sizeof(*opt);\n\t\t\tret = func[tid](tid, (struct ioam6_trace_hdr *)p,\n\t\t\t\t\t   tr_type, ioam_ns);\n\t\t\tbreak;\n\t\t}\n\n\t\tp += opt->opt_len + 2;\n\t\thoplen -= opt->opt_len + 2;\n\t}\nclose:\n\tclose(fd);\nout:\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}