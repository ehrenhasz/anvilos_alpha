{
  "module_name": "fib_nexthop_nongw.sh",
  "hash_id": "76113f934a021dd6611ef2124c265a237baaac4a408150cfc3a8158cadc4e724",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/fib_nexthop_nongw.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# ns: h1               | ns: h2\n#   192.168.0.1/24     |\n#            eth0      |\n#                      |       192.168.1.1/32\n#            veth0 <---|---> veth1\n# Validate source address selection for route without gateway\n\nPAUSE_ON_FAIL=no\nVERBOSE=0\nret=0\n\n################################################################################\n# helpers\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$*\"\n\tlocal out\n\tlocal rc\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\techo \"COMMAND: $cmd\"\n\tfi\n\n\tout=$(eval $cmd 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"$out\"\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n\n\treturn $rc\n}\n\n################################################################################\n# config\nsetup()\n{\n\tip netns add h1\n\tip -n h1 link set lo up\n\tip netns add h2\n\tip -n h2 link set lo up\n\n\t# Add a fake eth0 to support an ip address\n\tip -n h1 link add name eth0 type dummy\n\tip -n h1 link set eth0 up\n\tip -n h1 address add 192.168.0.1/24 dev eth0\n\n\t# Configure veths (same @mac, arp off)\n\tip -n h1 link add name veth0 type veth peer name veth1 netns h2\n\tip -n h1 link set veth0 up\n\n\tip -n h2 link set veth1 up\n\n\t# Configure @IP in the peer netns\n\tip -n h2 address add 192.168.1.1/32 dev veth1\n\tip -n h2 route add default dev veth1\n\n\t# Add a nexthop without @gw and use it in a route\n\tip -n h1 nexthop add id 1 dev veth0\n\tip -n h1 route add 192.168.1.1 nhid 1\n}\n\ncleanup()\n{\n\tip netns del h1 2>/dev/null\n\tip netns del h2 2>/dev/null\n}\n\ntrap cleanup EXIT\n\n################################################################################\n# main\n\nwhile getopts :pv o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tv) VERBOSE=1;;\n\tesac\ndone\n\ncleanup\nsetup\n\nrun_cmd ip -netns h1 route get 192.168.1.1\nlog_test $? 0 \"nexthop: get route with nexthop without gw\"\nrun_cmd ip netns exec h1 ping -c1 192.168.1.1\nlog_test $? 0 \"nexthop: ping through nexthop without gw\"\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}