{
  "module_name": "srv6_end_dt4_l3vpn_test.sh",
  "hash_id": "a66b2e4efd497f630ea094821b8c27bab83a027a464fd9c08e71f43cd6480a64",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/srv6_end_dt4_l3vpn_test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# author: Andrea Mayer <andrea.mayer@uniroma2.it>\n\n# This test is designed for evaluating the new SRv6 End.DT4 behavior used for\n# implementing IPv4 L3 VPN use cases.\n#\n# Hereafter a network diagram is shown, where two different tenants (named 100\n# and 200) offer IPv4 L3 VPN services allowing hosts to communicate with each\n# other across an IPv6 network.\n#\n# Only hosts belonging to the same tenant (and to the same VPN) can communicate\n# with each other. Instead, the communication among hosts of different tenants\n# is forbidden.\n# In other words, hosts hs-t100-1 and hs-t100-2 are connected through the IPv4\n# L3 VPN of tenant 100 while hs-t200-3 and hs-t200-4 are connected using the\n# IPv4 L3 VPN of tenant 200. Cross connection between tenant 100 and tenant 200\n# is forbidden and thus, for example, hs-t100-1 cannot reach hs-t200-3 and vice\n# versa.\n#\n# Routers rt-1 and rt-2 implement IPv4 L3 VPN services leveraging the SRv6\n# architecture. The key components for such VPNs are: a) SRv6 Encap behavior,\n# b) SRv6 End.DT4 behavior and c) VRF.\n#\n# To explain how an IPv4 L3 VPN based on SRv6 works, let us briefly consider an\n# example where, within the same domain of tenant 100, the host hs-t100-1 pings\n# the host hs-t100-2.\n#\n# First of all, L2 reachability of the host hs-t100-2 is taken into account by\n# the router rt-1 which acts as an arp proxy.\n#\n# When the host hs-t100-1 sends an IPv4 packet destined to hs-t100-2, the\n# router rt-1 receives the packet on the internal veth-t100 interface. Such\n# interface is enslaved to the VRF vrf-100 whose associated table contains the\n# SRv6 Encap route for encapsulating any IPv4 packet in a IPv6 plus the Segment\n# Routing Header (SRH) packet. This packet is sent through the (IPv6) core\n# network up to the router rt-2 that receives it on veth0 interface.\n#\n# The rt-2 router uses the 'localsid' routing table to process incoming\n# IPv6+SRH packets which belong to the VPN of the tenant 100. For each of these\n# packets, the SRv6 End.DT4 behavior removes the outer IPv6+SRH headers and\n# performs the lookup on the vrf-100 table using the destination address of\n# the decapsulated IPv4 packet. Afterwards, the packet is sent to the host\n# hs-t100-2 through the veth-t100 interface.\n#\n# The ping response follows the same processing but this time the role of rt-1\n# and rt-2 are swapped.\n#\n# Of course, the IPv4 L3 VPN for tenant 200 works exactly as the IPv4 L3 VPN\n# for tenant 100. In this case, only hosts hs-t200-3 and hs-t200-4 are able to\n# connect with each other.\n#\n#\n# +-------------------+                                   +-------------------+\n# |                   |                                   |                   |\n# |  hs-t100-1 netns  |                                   |  hs-t100-2 netns  |\n# |                   |                                   |                   |\n# |  +-------------+  |                                   |  +-------------+  |\n# |  |    veth0    |  |                                   |  |    veth0    |  |\n# |  | 10.0.0.1/24 |  |                                   |  | 10.0.0.2/24 |  |\n# |  +-------------+  |                                   |  +-------------+  |\n# |        .          |                                   |         .         |\n# +-------------------+                                   +-------------------+\n#          .                                                        .\n#          .                                                        .\n#          .                                                        .\n# +-----------------------------------+   +-----------------------------------+\n# |        .                          |   |                         .         |\n# | +---------------+                 |   |                 +---------------- |\n# | |   veth-t100   |                 |   |                 |   veth-t100   | |\n# | | 10.0.0.254/24 |    +----------+ |   | +----------+    | 10.0.0.254/24 | |\n# | +-------+-------+    | localsid | |   | | localsid |    +-------+-------- |\n# |         |            |   table  | |   | |   table  |            |         |\n# |    +----+----+       +----------+ |   | +----------+       +----+----+    |\n# |    | vrf-100 |                    |   |                    | vrf-100 |    |\n# |    +---------+     +------------+ |   | +------------+     +---------+    |\n# |                    |   veth0    | |   | |   veth0    |                    |\n# |                    | fd00::1/64 |.|...|.| fd00::2/64 |                    |\n# |    +---------+     +------------+ |   | +------------+     +---------+    |\n# |    | vrf-200 |                    |   |                    | vrf-200 |    |\n# |    +----+----+                    |   |                    +----+----+    |\n# |         |                         |   |                         |         |\n# | +-------+-------+                 |   |                 +-------+-------- |\n# | |   veth-t200   |                 |   |                 |   veth-t200   | |\n# | | 10.0.0.254/24 |                 |   |                 | 10.0.0.254/24 | |\n# | +---------------+      rt-1 netns |   | rt-2 netns      +---------------- |\n# |        .                          |   |                          .        |\n# +-----------------------------------+   +-----------------------------------+\n#          .                                                         .\n#          .                                                         .\n#          .                                                         .\n#          .                                                         .\n# +-------------------+                                   +-------------------+\n# |        .          |                                   |          .        |\n# |  +-------------+  |                                   |  +-------------+  |\n# |  |    veth0    |  |                                   |  |    veth0    |  |\n# |  | 10.0.0.3/24 |  |                                   |  | 10.0.0.4/24 |  |\n# |  +-------------+  |                                   |  +-------------+  |\n# |                   |                                   |                   |\n# |  hs-t200-3 netns  |                                   |  hs-t200-4 netns  |\n# |                   |                                   |                   |\n# +-------------------+                                   +-------------------+\n#\n#\n# ~~~~~~~~~~~~~~~~~~~~~~~~~\n# | Network configuration |\n# ~~~~~~~~~~~~~~~~~~~~~~~~~\n#\n# rt-1: localsid table (table 90)\n# +-------------------------------------------------+\n# |SID              |Action                         |\n# +-------------------------------------------------+\n# |fc00:21:100::6004|apply SRv6 End.DT4 vrftable 100|\n# +-------------------------------------------------+\n# |fc00:21:200::6004|apply SRv6 End.DT4 vrftable 200|\n# +-------------------------------------------------+\n#\n# rt-1: VRF tenant 100 (table 100)\n# +---------------------------------------------------+\n# |host       |Action                                 |\n# +---------------------------------------------------+\n# |10.0.0.2   |apply seg6 encap segs fc00:12:100::6004|\n# +---------------------------------------------------+\n# |10.0.0.0/24|forward to dev veth_t100               |\n# +---------------------------------------------------+\n#\n# rt-1: VRF tenant 200 (table 200)\n# +---------------------------------------------------+\n# |host       |Action                                 |\n# +---------------------------------------------------+\n# |10.0.0.4   |apply seg6 encap segs fc00:12:200::6004|\n# +---------------------------------------------------+\n# |10.0.0.0/24|forward to dev veth_t200               |\n# +---------------------------------------------------+\n#\n#\n# rt-2: localsid table (table 90)\n# +-------------------------------------------------+\n# |SID              |Action                         |\n# +-------------------------------------------------+\n# |fc00:12:100::6004|apply SRv6 End.DT4 vrftable 100|\n# +-------------------------------------------------+\n# |fc00:12:200::6004|apply SRv6 End.DT4 vrftable 200|\n# +-------------------------------------------------+\n#\n# rt-2: VRF tenant 100 (table 100)\n# +---------------------------------------------------+\n# |host       |Action                                 |\n# +---------------------------------------------------+\n# |10.0.0.1   |apply seg6 encap segs fc00:21:100::6004|\n# +---------------------------------------------------+\n# |10.0.0.0/24|forward to dev veth_t100               |\n# +---------------------------------------------------+\n#\n# rt-2: VRF tenant 200 (table 200)\n# +---------------------------------------------------+\n# |host       |Action                                 |\n# +---------------------------------------------------+\n# |10.0.0.3   |apply seg6 encap segs fc00:21:200::6004|\n# +---------------------------------------------------+\n# |10.0.0.0/24|forward to dev veth_t200               |\n# +---------------------------------------------------+\n#\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nreadonly LOCALSID_TABLE_ID=90\nreadonly IPv6_RT_NETWORK=fd00\nreadonly IPv4_HS_NETWORK=10.0.0\nreadonly VPN_LOCATOR_SERVICE=fc00\nPING_TIMEOUT_SEC=4\n\nret=0\n\nPAUSE_ON_FAIL=${PAUSE_ON_FAIL:=no}\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tnsuccess=$((nsuccess+1))\n\t\tprintf \"\\n    TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"\\n    TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n}\n\nprint_log_test_results()\n{\n\tif [ \"$TESTS\" != \"none\" ]; then\n\t\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\t\tprintf \"Tests failed: %3d\\n\"   ${nfail}\n\tfi\n}\n\nlog_section()\n{\n\techo\n\techo \"################################################################################\"\n\techo \"TEST SECTION: $*\"\n\techo \"################################################################################\"\n}\n\ncleanup()\n{\n\tip link del veth-rt-1 2>/dev/null || true\n\tip link del veth-rt-2 2>/dev/null || true\n\n\t# destroy routers rt-* and hosts hs-*\n\tfor ns in $(ip netns show | grep -E 'rt-*|hs-*'); do\n\t\tip netns del ${ns} || true\n\tdone\n}\n\n# Setup the basic networking for the routers\nsetup_rt_networking()\n{\n\tlocal rt=$1\n\tlocal nsname=rt-${rt}\n\n\tip netns add ${nsname}\n\n\tip netns exec ${nsname} sysctl -wq net.ipv6.conf.all.accept_dad=0\n\tip netns exec ${nsname} sysctl -wq net.ipv6.conf.default.accept_dad=0\n\n\tip link set veth-rt-${rt} netns ${nsname}\n\tip -netns ${nsname} link set veth-rt-${rt} name veth0\n\n\tip -netns ${nsname} addr add ${IPv6_RT_NETWORK}::${rt}/64 dev veth0 nodad\n\tip -netns ${nsname} link set veth0 up\n\tip -netns ${nsname} link set lo up\n\n\tip netns exec ${nsname} sysctl -wq net.ipv4.ip_forward=1\n\tip netns exec ${nsname} sysctl -wq net.ipv6.conf.all.forwarding=1\n}\n\nsetup_hs()\n{\n\tlocal hs=$1\n\tlocal rt=$2\n\tlocal tid=$3\n\tlocal hsname=hs-t${tid}-${hs}\n\tlocal rtname=rt-${rt}\n\tlocal rtveth=veth-t${tid}\n\n\t# set the networking for the host\n\tip netns add ${hsname}\n\n\t# disable the rp_filter otherwise the kernel gets confused about how\n\t# to route decap ipv4 packets.\n\tip netns exec ${rtname} sysctl -wq net.ipv4.conf.all.rp_filter=0\n\tip netns exec ${rtname} sysctl -wq net.ipv4.conf.default.rp_filter=0\n\n\tip -netns ${hsname} link add veth0 type veth peer name ${rtveth}\n\tip -netns ${hsname} link set ${rtveth} netns ${rtname}\n\tip -netns ${hsname} addr add ${IPv4_HS_NETWORK}.${hs}/24 dev veth0\n\tip -netns ${hsname} link set veth0 up\n\tip -netns ${hsname} link set lo up\n\n\t# configure the VRF for the tenant X on the router which is directly\n\t# connected to the source host.\n\tip -netns ${rtname} link add vrf-${tid} type vrf table ${tid}\n\tip -netns ${rtname} link set vrf-${tid} up\n\n\t# enslave the veth-tX interface to the vrf-X in the access router\n\tip -netns ${rtname} link set ${rtveth} master vrf-${tid}\n\tip -netns ${rtname} addr add ${IPv4_HS_NETWORK}.254/24 dev ${rtveth}\n\tip -netns ${rtname} link set ${rtveth} up\n\n\tip netns exec ${rtname} sysctl -wq net.ipv4.conf.${rtveth}.proxy_arp=1\n\n\tip netns exec ${rtname} sh -c \"echo 1 > /proc/sys/net/vrf/strict_mode\"\n}\n\nsetup_vpn_config()\n{\n\tlocal hssrc=$1\n\tlocal rtsrc=$2\n\tlocal hsdst=$3\n\tlocal rtdst=$4\n\tlocal tid=$5\n\n\tlocal hssrc_name=hs-t${tid}-${hssrc}\n\tlocal hsdst_name=hs-t${tid}-${hsdst}\n\tlocal rtsrc_name=rt-${rtsrc}\n\tlocal rtdst_name=rt-${rtdst}\n\tlocal vpn_sid=${VPN_LOCATOR_SERVICE}:${hssrc}${hsdst}:${tid}::6004\n\n\t# set the encap route for encapsulating packets which arrive from the\n\t# host hssrc and destined to the access router rtsrc.\n\tip -netns ${rtsrc_name} -4 route add ${IPv4_HS_NETWORK}.${hsdst}/32 vrf vrf-${tid} \\\n\t\tencap seg6 mode encap segs ${vpn_sid} dev veth0\n\tip -netns ${rtsrc_name} -6 route add ${vpn_sid}/128 vrf vrf-${tid} \\\n\t\tvia fd00::${rtdst} dev veth0\n\n\t# set the decap route for decapsulating packets which arrive from\n\t# the rtdst router and destined to the hsdst host.\n\tip -netns ${rtdst_name} -6 route add ${vpn_sid}/128 table ${LOCALSID_TABLE_ID} \\\n\t\tencap seg6local action End.DT4 vrftable ${tid} dev vrf-${tid}\n\n\t# all sids for VPNs start with a common locator which is fc00::/16.\n\t# Routes for handling the SRv6 End.DT4 behavior instances are grouped\n\t# together in the 'localsid' table.\n\t#\n\t# NOTE: added only once\n\tif [ -z \"$(ip -netns ${rtdst_name} -6 rule show | \\\n\t    grep \"to ${VPN_LOCATOR_SERVICE}::/16 lookup ${LOCALSID_TABLE_ID}\")\" ]; then\n\t\tip -netns ${rtdst_name} -6 rule add \\\n\t\t\tto ${VPN_LOCATOR_SERVICE}::/16 \\\n\t\t\tlookup ${LOCALSID_TABLE_ID} prio 999\n\tfi\n}\n\nsetup()\n{\n\tip link add veth-rt-1 type veth peer name veth-rt-2\n\t# setup the networking for router rt-1 and router rt-2\n\tsetup_rt_networking 1\n\tsetup_rt_networking 2\n\n\t# setup two hosts for the tenant 100.\n\t#  - host hs-1 is directly connected to the router rt-1;\n\t#  - host hs-2 is directly connected to the router rt-2.\n\tsetup_hs 1 1 100  #args: host router tenant\n\tsetup_hs 2 2 100\n\n\t# setup two hosts for the tenant 200\n\t#  - host hs-3 is directly connected to the router rt-1;\n\t#  - host hs-4 is directly connected to the router rt-2.\n\tsetup_hs 3 1 200\n\tsetup_hs 4 2 200\n\n\t# setup the IPv4 L3 VPN which connects the host hs-t100-1 and host\n\t# hs-t100-2 within the same tenant 100.\n\tsetup_vpn_config 1 1 2 2 100  #args: src_host src_router dst_host dst_router tenant\n\tsetup_vpn_config 2 2 1 1 100\n\n\t# setup the IPv4 L3 VPN which connects the host hs-t200-3 and host\n\t# hs-t200-4 within the same tenant 200.\n\tsetup_vpn_config 3 1 4 2 200\n\tsetup_vpn_config 4 2 3 1 200\n}\n\ncheck_rt_connectivity()\n{\n\tlocal rtsrc=$1\n\tlocal rtdst=$2\n\n\tip netns exec rt-${rtsrc} ping -c 1 -W 1 ${IPv6_RT_NETWORK}::${rtdst} \\\n\t\t>/dev/null 2>&1\n}\n\ncheck_and_log_rt_connectivity()\n{\n\tlocal rtsrc=$1\n\tlocal rtdst=$2\n\n\tcheck_rt_connectivity ${rtsrc} ${rtdst}\n\tlog_test $? 0 \"Routers connectivity: rt-${rtsrc} -> rt-${rtdst}\"\n}\n\ncheck_hs_connectivity()\n{\n\tlocal hssrc=$1\n\tlocal hsdst=$2\n\tlocal tid=$3\n\n\tip netns exec hs-t${tid}-${hssrc} ping -c 1 -W ${PING_TIMEOUT_SEC} \\\n\t\t${IPv4_HS_NETWORK}.${hsdst} >/dev/null 2>&1\n}\n\ncheck_and_log_hs_connectivity()\n{\n\tlocal hssrc=$1\n\tlocal hsdst=$2\n\tlocal tid=$3\n\n\tcheck_hs_connectivity ${hssrc} ${hsdst} ${tid}\n\tlog_test $? 0 \"Hosts connectivity: hs-t${tid}-${hssrc} -> hs-t${tid}-${hsdst} (tenant ${tid})\"\n}\n\ncheck_and_log_hs_isolation()\n{\n\tlocal hssrc=$1\n\tlocal tidsrc=$2\n\tlocal hsdst=$3\n\tlocal tiddst=$4\n\n\tcheck_hs_connectivity ${hssrc} ${hsdst} ${tidsrc}\n\t# NOTE: ping should fail\n\tlog_test $? 1 \"Hosts isolation: hs-t${tidsrc}-${hssrc} -X-> hs-t${tiddst}-${hsdst}\"\n}\n\n\ncheck_and_log_hs2gw_connectivity()\n{\n\tlocal hssrc=$1\n\tlocal tid=$2\n\n\tcheck_hs_connectivity ${hssrc} 254 ${tid}\n\tlog_test $? 0 \"Hosts connectivity: hs-t${tid}-${hssrc} -> gw (tenant ${tid})\"\n}\n\nrouter_tests()\n{\n\tlog_section \"IPv6 routers connectivity test\"\n\n\tcheck_and_log_rt_connectivity 1 2\n\tcheck_and_log_rt_connectivity 2 1\n}\n\nhost2gateway_tests()\n{\n\tlog_section \"IPv4 connectivity test among hosts and gateway\"\n\n\tcheck_and_log_hs2gw_connectivity 1 100\n\tcheck_and_log_hs2gw_connectivity 2 100\n\n\tcheck_and_log_hs2gw_connectivity 3 200\n\tcheck_and_log_hs2gw_connectivity 4 200\n}\n\nhost_vpn_tests()\n{\n\tlog_section \"SRv6 VPN connectivity test among hosts in the same tenant\"\n\n\tcheck_and_log_hs_connectivity 1 2 100\n\tcheck_and_log_hs_connectivity 2 1 100\n\n\tcheck_and_log_hs_connectivity 3 4 200\n\tcheck_and_log_hs_connectivity 4 3 200\n}\n\nhost_vpn_isolation_tests()\n{\n\tlocal i\n\tlocal j\n\tlocal k\n\tlocal tmp\n\tlocal l1=\"1 2\"\n\tlocal l2=\"3 4\"\n\tlocal t1=100\n\tlocal t2=200\n\n\tlog_section \"SRv6 VPN isolation test among hosts in different tentants\"\n\n\tfor k in 0 1; do\n\t\tfor i in ${l1}; do\n\t\t\tfor j in ${l2}; do\n\t\t\t\tcheck_and_log_hs_isolation ${i} ${t1} ${j} ${t2}\n\t\t\tdone\n\t\tdone\n\n\t\t# let us test the reverse path\n\t\ttmp=\"${l1}\"; l1=\"${l2}\"; l2=\"${tmp}\"\n\t\ttmp=${t1}; t1=${t2}; t2=${tmp}\n\tdone\n}\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nmodprobe vrf &>/dev/null\nif [ ! -e /proc/sys/net/vrf/strict_mode ]; then\n        echo \"SKIP: vrf sysctl does not exist\"\n        exit $ksft_skip\nfi\n\ncleanup &>/dev/null\n\nsetup\n\nrouter_tests\nhost2gateway_tests\nhost_vpn_tests\nhost_vpn_isolation_tests\n\nprint_log_test_results\n\ncleanup &>/dev/null\n\nexit ${ret}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}