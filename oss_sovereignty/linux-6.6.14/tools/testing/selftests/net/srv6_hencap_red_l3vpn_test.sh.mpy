{
  "module_name": "srv6_hencap_red_l3vpn_test.sh",
  "hash_id": "7be7f7f3784ea9d7e6563e3a314646e320a374e7e137058cc03ac7a767fcea63",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/srv6_hencap_red_l3vpn_test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# author: Andrea Mayer <andrea.mayer@uniroma2.it>\n#\n# This script is designed for testing the SRv6 H.Encaps.Red behavior.\n#\n# Below is depicted the IPv6 network of an operator which offers advanced\n# IPv4/IPv6 VPN services to hosts, enabling them to communicate with each\n# other.\n# In this example, hosts hs-1 and hs-2 are connected through an IPv4/IPv6 VPN\n# service, while hs-3 and hs-4 are connected using an IPv6 only VPN.\n#\n# Routers rt-1,rt-2,rt-3 and rt-4 implement IPv4/IPv6 L3 VPN services\n# leveraging the SRv6 architecture. The key components for such VPNs are:\n#\n#   i) The SRv6 H.Encaps.Red behavior applies SRv6 Policies on traffic received\n#      by connected hosts, initiating the VPN tunnel. Such a behavior is an\n#      optimization of the SRv6 H.Encap aiming to reduce the length of the SID\n#      List carried in the pushed SRH. Specifically, the H.Encaps.Red removes\n#      the first SID contained in the SID List (i.e. SRv6 Policy) by storing it\n#      into the IPv6 Destination Address. When a SRv6 Policy is made of only one\n#      SID, the SRv6 H.Encaps.Red behavior omits the SRH at all and pushes that\n#      SID directly into the IPv6 DA;\n#\n#  ii) The SRv6 End behavior advances the active SID in the SID List carried by\n#      the SRH;\n#\n# iii) The SRv6 End.DT46 behavior is used for removing the SRv6 Policy and,\n#      thus, it terminates the VPN tunnel. Such a behavior is capable of\n#      handling, at the same time, both tunneled IPv4 and IPv6 traffic.\n#\n#\n#               cafe::1                      cafe::2\n#              10.0.0.1                     10.0.0.2\n#             +--------+                   +--------+\n#             |        |                   |        |\n#             |  hs-1  |                   |  hs-2  |\n#             |        |                   |        |\n#             +---+----+                   +--- +---+\n#    cafe::/64    |                             |      cafe::/64\n#  10.0.0.0/24    |                             |    10.0.0.0/24\n#             +---+----+                   +----+---+\n#             |        |  fcf0:0:1:2::/64  |        |\n#             |  rt-1  +-------------------+  rt-2  |\n#             |        |                   |        |\n#             +---+----+                   +----+---+\n#                 |      .               .      |\n#                 |  fcf0:0:1:3::/64   .        |\n#                 |          .       .          |\n#                 |            .   .            |\n# fcf0:0:1:4::/64 |              .              | fcf0:0:2:3::/64\n#                 |            .   .            |\n#                 |          .       .          |\n#                 |  fcf0:0:2:4::/64   .        |\n#                 |      .               .      |\n#             +---+----+                   +----+---+\n#             |        |                   |        |\n#             |  rt-4  +-------------------+  rt-3  |\n#             |        |  fcf0:0:3:4::/64  |        |\n#             +---+----+                   +----+---+\n#    cafe::/64    |                             |      cafe::/64\n#  10.0.0.0/24    |                             |    10.0.0.0/24\n#             +---+----+                   +--- +---+\n#             |        |                   |        |\n#             |  hs-4  |                   |  hs-3  |\n#             |        |                   |        |\n#             +--------+                   +--------+\n#               cafe::4                      cafe::3\n#              10.0.0.4                     10.0.0.3\n#\n#\n# Every fcf0:0:x:y::/64 network interconnects the SRv6 routers rt-x with rt-y\n# in the IPv6 operator network.\n#\n# Local SID table\n# ===============\n#\n# Each SRv6 router is configured with a Local SID table in which SIDs are\n# stored. Considering the given SRv6 router rt-x, at least two SIDs are\n# configured in the Local SID table:\n#\n#   Local SID table for SRv6 router rt-x\n#   +----------------------------------------------------------+\n#   |fcff:x::e is associated with the SRv6 End behavior        |\n#   |fcff:x::d46 is associated with the SRv6 End.DT46 behavior |\n#   +----------------------------------------------------------+\n#\n# The fcff::/16 prefix is reserved by the operator for implementing SRv6 VPN\n# services. Reachability of SIDs is ensured by proper configuration of the IPv6\n# operator's network and SRv6 routers.\n#\n# # SRv6 Policies\n# ===============\n#\n# An SRv6 ingress router applies SRv6 policies to the traffic received from a\n# connected host. SRv6 policy enforcement consists of encapsulating the\n# received traffic into a new IPv6 packet with a given SID List contained in\n# the SRH.\n#\n# IPv4/IPv6 VPN between hs-1 and hs-2\n# -----------------------------------\n#\n# Hosts hs-1 and hs-2 are connected using dedicated IPv4/IPv6 VPNs.\n# Specifically, packets generated from hs-1 and directed towards hs-2 are\n# handled by rt-1 which applies the following SRv6 Policies:\n#\n#   i.a) IPv6 traffic, SID List=fcff:3::e,fcff:4::e,fcff:2::d46\n#  ii.a) IPv4 traffic, SID List=fcff:2::d46\n#\n# Policy (i.a) steers tunneled IPv6 traffic through SRv6 routers\n# rt-3,rt-4,rt-2. Instead, Policy (ii.a) steers tunneled IPv4 traffic through\n# rt-2.\n# The H.Encaps.Red reduces the SID List (i.a) carried in SRH by removing the\n# first SID (fcff:3::e) and pushing it into the IPv6 DA. In case of IPv4\n# traffic, the H.Encaps.Red omits the presence of SRH at all, since the SID\n# List (ii.a) consists of only one SID that can be stored directly in the IPv6\n# DA.\n#\n# On the reverse path (i.e. from hs-2 to hs-1), rt-2 applies the following\n# policies:\n#\n#   i.b) IPv6 traffic, SID List=fcff:1::d46\n#  ii.b) IPv4 traffic, SID List=fcff:4::e,fcff:3::e,fcff:1::d46\n#\n# Policy (i.b) steers tunneled IPv6 traffic through the SRv6 router rt-1.\n# Conversely, Policy (ii.b) steers tunneled IPv4 traffic through SRv6 routers\n# rt-4,rt-3,rt-1.\n# The H.Encaps.Red omits the SRH at all in case of (i.b) by pushing the single\n# SID (fcff::1::d46) inside the IPv6 DA.\n# The H.Encaps.Red reduces the SID List (ii.b) in the SRH by removing the first\n# SID (fcff:4::e) and pushing it into the IPv6 DA.\n#\n# In summary:\n#  hs-1->hs-2 |IPv6 DA=fcff:3::e|SRH SIDs=fcff:4::e,fcff:2::d46|IPv6|...| (i.a)\n#  hs-1->hs-2 |IPv6 DA=fcff:2::d46|IPv4|...|                              (ii.a)\n#\n#  hs-2->hs-1 |IPv6 DA=fcff:1::d46|IPv6|...|                              (i.b)\n#  hs-2->hs-1 |IPv6 DA=fcff:4::e|SRH SIDs=fcff:3::e,fcff:1::d46|IPv4|...| (ii.b)\n#\n#\n# IPv6 VPN between hs-3 and hs-4\n# ------------------------------\n#\n# Hosts hs-3 and hs-4 are connected using a dedicated IPv6 only VPN.\n# Specifically, packets generated from hs-3 and directed towards hs-4 are\n# handled by rt-3 which applies the following SRv6 Policy:\n#\n#  i.c) IPv6 traffic, SID List=fcff:2::e,fcff:4::d46\n#\n# Policy (i.c) steers tunneled IPv6 traffic through SRv6 routers rt-2,rt-4.\n# The H.Encaps.Red reduces the SID List (i.c) carried in SRH by pushing the\n# first SID (fcff:2::e) in the IPv6 DA.\n#\n# On the reverse path (i.e. from hs-4 to hs-3) the router rt-4 applies the\n# following SRv6 Policy:\n#\n#  i.d) IPv6 traffic, SID List=fcff:1::e,fcff:3::d46.\n#\n# Policy (i.d) steers tunneled IPv6 traffic through SRv6 routers rt-1,rt-3.\n# The H.Encaps.Red reduces the SID List (i.d) carried in SRH by pushing the\n# first SID (fcff:1::e) in the IPv6 DA.\n#\n# In summary:\n#  hs-3->hs-4 |IPv6 DA=fcff:2::e|SRH SIDs=fcff:4::d46|IPv6|...| (i.c)\n#  hs-4->hs-3 |IPv6 DA=fcff:1::e|SRH SIDs=fcff:3::d46|IPv6|...| (i.d)\n#\n\n# Kselftest framework requirement - SKIP code is 4.\nreadonly ksft_skip=4\n\nreadonly RDMSUFF=\"$(mktemp -u XXXXXXXX)\"\nreadonly VRF_TID=100\nreadonly VRF_DEVNAME=\"vrf-${VRF_TID}\"\nreadonly RT2HS_DEVNAME=\"veth-t${VRF_TID}\"\nreadonly LOCALSID_TABLE_ID=90\nreadonly IPv6_RT_NETWORK=fcf0:0\nreadonly IPv6_HS_NETWORK=cafe\nreadonly IPv4_HS_NETWORK=10.0.0\nreadonly VPN_LOCATOR_SERVICE=fcff\nreadonly END_FUNC=000e\nreadonly DT46_FUNC=0d46\n\nPING_TIMEOUT_SEC=4\nPAUSE_ON_FAIL=${PAUSE_ON_FAIL:=no}\n\n# IDs of routers and hosts are initialized during the setup of the testing\n# network\nROUTERS=''\nHOSTS=''\n\nSETUP_ERR=1\n\nret=${ksft_skip}\nnsuccess=0\nnfail=0\n\nlog_test()\n{\n\tlocal rc=\"$1\"\n\tlocal expected=\"$2\"\n\tlocal msg=\"$3\"\n\n\tif [ \"${rc}\" -eq \"${expected}\" ]; then\n\t\tnsuccess=$((nsuccess+1))\n\t\tprintf \"\\n    TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"\\n    TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n}\n\nprint_log_test_results()\n{\n\tprintf \"\\nTests passed: %3d\\n\" \"${nsuccess}\"\n\tprintf \"Tests failed: %3d\\n\"   \"${nfail}\"\n\n\t# when a test fails, the value of 'ret' is set to 1 (error code).\n\t# Conversely, when all tests are passed successfully, the 'ret' value\n\t# is set to 0 (success code).\n\tif [ \"${ret}\" -ne 1 ]; then\n\t\tret=0\n\tfi\n}\n\nlog_section()\n{\n\techo\n\techo \"################################################################################\"\n\techo \"TEST SECTION: $*\"\n\techo \"################################################################################\"\n}\n\ntest_command_or_ksft_skip()\n{\n\tlocal cmd=\"$1\"\n\n\tif [ ! -x \"$(command -v \"${cmd}\")\" ]; then\n\t\techo \"SKIP: Could not run test without \\\"${cmd}\\\" tool\";\n\t\texit \"${ksft_skip}\"\n\tfi\n}\n\nget_nodename()\n{\n\tlocal name=\"$1\"\n\n\techo \"${name}-${RDMSUFF}\"\n}\n\nget_rtname()\n{\n\tlocal rtid=\"$1\"\n\n\tget_nodename \"rt-${rtid}\"\n}\n\nget_hsname()\n{\n\tlocal hsid=\"$1\"\n\n\tget_nodename \"hs-${hsid}\"\n}\n\n__create_namespace()\n{\n\tlocal name=\"$1\"\n\n\tip netns add \"${name}\"\n}\n\ncreate_router()\n{\n\tlocal rtid=\"$1\"\n\tlocal nsname\n\n\tnsname=\"$(get_rtname \"${rtid}\")\"\n\n\t__create_namespace \"${nsname}\"\n}\n\ncreate_host()\n{\n\tlocal hsid=\"$1\"\n\tlocal nsname\n\n\tnsname=\"$(get_hsname \"${hsid}\")\"\n\n\t__create_namespace \"${nsname}\"\n}\n\ncleanup()\n{\n\tlocal nsname\n\tlocal i\n\n\t# destroy routers\n\tfor i in ${ROUTERS}; do\n\t\tnsname=\"$(get_rtname \"${i}\")\"\n\n\t\tip netns del \"${nsname}\" &>/dev/null || true\n\tdone\n\n\t# destroy hosts\n\tfor i in ${HOSTS}; do\n\t\tnsname=\"$(get_hsname \"${i}\")\"\n\n\t\tip netns del \"${nsname}\" &>/dev/null || true\n\tdone\n\n\t# check whether the setup phase was completed successfully or not. In\n\t# case of an error during the setup phase of the testing environment,\n\t# the selftest is considered as \"skipped\".\n\tif [ \"${SETUP_ERR}\" -ne 0 ]; then\n\t\techo \"SKIP: Setting up the testing environment failed\"\n\t\texit \"${ksft_skip}\"\n\tfi\n\n\texit \"${ret}\"\n}\n\nadd_link_rt_pairs()\n{\n\tlocal rt=\"$1\"\n\tlocal rt_neighs=\"$2\"\n\tlocal neigh\n\tlocal nsname\n\tlocal neigh_nsname\n\n\tnsname=\"$(get_rtname \"${rt}\")\"\n\n\tfor neigh in ${rt_neighs}; do\n\t\tneigh_nsname=\"$(get_rtname \"${neigh}\")\"\n\n\t\tip link add \"veth-rt-${rt}-${neigh}\" netns \"${nsname}\" \\\n\t\t\ttype veth peer name \"veth-rt-${neigh}-${rt}\" \\\n\t\t\tnetns \"${neigh_nsname}\"\n\tdone\n}\n\nget_network_prefix()\n{\n\tlocal rt=\"$1\"\n\tlocal neigh=\"$2\"\n\tlocal p=\"${rt}\"\n\tlocal q=\"${neigh}\"\n\n\tif [ \"${p}\" -gt \"${q}\" ]; then\n\t\tp=\"${q}\"; q=\"${rt}\"\n\tfi\n\n\techo \"${IPv6_RT_NETWORK}:${p}:${q}\"\n}\n\n# Setup the basic networking for the routers\nsetup_rt_networking()\n{\n\tlocal rt=\"$1\"\n\tlocal rt_neighs=\"$2\"\n\tlocal nsname\n\tlocal net_prefix\n\tlocal devname\n\tlocal neigh\n\n\tnsname=\"$(get_rtname \"${rt}\")\"\n\n\tfor neigh in ${rt_neighs}; do\n\t\tdevname=\"veth-rt-${rt}-${neigh}\"\n\n\t\tnet_prefix=\"$(get_network_prefix \"${rt}\" \"${neigh}\")\"\n\n\t\tip -netns \"${nsname}\" addr \\\n\t\t\tadd \"${net_prefix}::${rt}/64\" dev \"${devname}\" nodad\n\n\t\tip -netns \"${nsname}\" link set \"${devname}\" up\n\tdone\n\n\tip -netns \"${nsname}\" link set lo up\n\n\tip netns exec \"${nsname}\" sysctl -wq net.ipv6.conf.all.accept_dad=0\n\tip netns exec \"${nsname}\" sysctl -wq net.ipv6.conf.default.accept_dad=0\n\tip netns exec \"${nsname}\" sysctl -wq net.ipv6.conf.all.forwarding=1\n\n\tip netns exec \"${nsname}\" sysctl -wq net.ipv4.conf.all.rp_filter=0\n\tip netns exec \"${nsname}\" sysctl -wq net.ipv4.conf.default.rp_filter=0\n\tip netns exec \"${nsname}\" sysctl -wq net.ipv4.ip_forward=1\n}\n\n# Setup local SIDs for an SRv6 router\nsetup_rt_local_sids()\n{\n\tlocal rt=\"$1\"\n\tlocal rt_neighs=\"$2\"\n\tlocal net_prefix\n\tlocal devname\n\tlocal nsname\n\tlocal neigh\n\n\tnsname=\"$(get_rtname \"${rt}\")\"\n\n\tfor neigh in ${rt_neighs}; do\n\t\tdevname=\"veth-rt-${rt}-${neigh}\"\n\n\t\tnet_prefix=\"$(get_network_prefix \"${rt}\" \"${neigh}\")\"\n\n\t\t# set underlay network routes for SIDs reachability\n\t\tip -netns \"${nsname}\" -6 route \\\n\t\t\tadd \"${VPN_LOCATOR_SERVICE}:${neigh}::/32\" \\\n\t\t\ttable \"${LOCALSID_TABLE_ID}\" \\\n\t\t\tvia \"${net_prefix}::${neigh}\" dev \"${devname}\"\n\tdone\n\n\t# Local End behavior (note that \"dev\" is dummy and the VRF is chosen\n\t# for the sake of simplicity).\n\tip -netns \"${nsname}\" -6 route \\\n\t\tadd \"${VPN_LOCATOR_SERVICE}:${rt}::${END_FUNC}\" \\\n\t\ttable \"${LOCALSID_TABLE_ID}\" \\\n\t\tencap seg6local action End dev \"${VRF_DEVNAME}\"\n\n\t# Local End.DT46 behavior\n\tip -netns \"${nsname}\" -6 route \\\n\t\tadd \"${VPN_LOCATOR_SERVICE}:${rt}::${DT46_FUNC}\" \\\n\t\ttable \"${LOCALSID_TABLE_ID}\" \\\n\t\tencap seg6local action End.DT46 vrftable \"${VRF_TID}\" \\\n\t\tdev \"${VRF_DEVNAME}\"\n\n\t# all SIDs for VPNs start with a common locator. Routes and SRv6\n\t# Endpoint behavior instaces are grouped together in the 'localsid'\n\t# table.\n\tip -netns \"${nsname}\" -6 rule \\\n\t\tadd to \"${VPN_LOCATOR_SERVICE}::/16\" \\\n\t\tlookup \"${LOCALSID_TABLE_ID}\" prio 999\n\n\t# set default routes to unreachable for both ipv4 and ipv6\n\tip -netns \"${nsname}\" -6 route \\\n\t\tadd unreachable default metric 4278198272 \\\n\t\tvrf \"${VRF_DEVNAME}\"\n\n\tip -netns \"${nsname}\" -4 route \\\n\t\tadd unreachable default metric 4278198272 \\\n\t\tvrf \"${VRF_DEVNAME}\"\n}\n\n# build and install the SRv6 policy into the ingress SRv6 router.\n# args:\n#  $1 - destination host (i.e. cafe::x host)\n#  $2 - SRv6 router configured for enforcing the SRv6 Policy\n#  $3 - SRv6 routers configured for steering traffic (End behaviors)\n#  $4 - SRv6 router configured for removing the SRv6 Policy (router connected\n#       to the destination host)\n#  $5 - encap mode (full or red)\n#  $6 - traffic type (IPv6 or IPv4)\n__setup_rt_policy()\n{\n\tlocal dst=\"$1\"\n\tlocal encap_rt=\"$2\"\n\tlocal end_rts=\"$3\"\n\tlocal dec_rt=\"$4\"\n\tlocal mode=\"$5\"\n\tlocal traffic=\"$6\"\n\tlocal nsname\n\tlocal policy=''\n\tlocal n\n\n\tnsname=\"$(get_rtname \"${encap_rt}\")\"\n\n\tfor n in ${end_rts}; do\n\t\tpolicy=\"${policy}${VPN_LOCATOR_SERVICE}:${n}::${END_FUNC},\"\n\tdone\n\n\tpolicy=\"${policy}${VPN_LOCATOR_SERVICE}:${dec_rt}::${DT46_FUNC}\"\n\n\t# add SRv6 policy to incoming traffic sent by connected hosts\n\tif [ \"${traffic}\" -eq 6 ]; then\n\t\tip -netns \"${nsname}\" -6 route \\\n\t\t\tadd \"${IPv6_HS_NETWORK}::${dst}\" vrf \"${VRF_DEVNAME}\" \\\n\t\t\tencap seg6 mode \"${mode}\" segs \"${policy}\" \\\n\t\t\tdev \"${VRF_DEVNAME}\"\n\n\t\tip -netns \"${nsname}\" -6 neigh \\\n\t\t\tadd proxy \"${IPv6_HS_NETWORK}::${dst}\" \\\n\t\t\tdev \"${RT2HS_DEVNAME}\"\n\telse\n\t\t# \"dev\" must be different from the one where the packet is\n\t\t# received, otherwise the proxy arp does not work.\n\t\tip -netns \"${nsname}\" -4 route \\\n\t\t\tadd \"${IPv4_HS_NETWORK}.${dst}\" vrf \"${VRF_DEVNAME}\" \\\n\t\t\tencap seg6 mode \"${mode}\" segs \"${policy}\" \\\n\t\t\tdev \"${VRF_DEVNAME}\"\n\tfi\n}\n\n# see __setup_rt_policy\nsetup_rt_policy_ipv6()\n{\n\t__setup_rt_policy \"$1\" \"$2\" \"$3\" \"$4\" \"$5\" 6\n}\n\n#see __setup_rt_policy\nsetup_rt_policy_ipv4()\n{\n\t__setup_rt_policy \"$1\" \"$2\" \"$3\" \"$4\" \"$5\" 4\n}\n\nsetup_hs()\n{\n\tlocal hs=\"$1\"\n\tlocal rt=\"$2\"\n\tlocal hsname\n\tlocal rtname\n\n\thsname=\"$(get_hsname \"${hs}\")\"\n\trtname=\"$(get_rtname \"${rt}\")\"\n\n\tip netns exec \"${hsname}\" sysctl -wq net.ipv6.conf.all.accept_dad=0\n\tip netns exec \"${hsname}\" sysctl -wq net.ipv6.conf.default.accept_dad=0\n\n\tip -netns \"${hsname}\" link add veth0 type veth \\\n\t\tpeer name \"${RT2HS_DEVNAME}\" netns \"${rtname}\"\n\n\tip -netns \"${hsname}\" addr \\\n\t\tadd \"${IPv6_HS_NETWORK}::${hs}/64\" dev veth0 nodad\n\tip -netns \"${hsname}\" addr add \"${IPv4_HS_NETWORK}.${hs}/24\" dev veth0\n\n\tip -netns \"${hsname}\" link set veth0 up\n\tip -netns \"${hsname}\" link set lo up\n\n\t# configure the VRF on the router which is directly connected to the\n\t# source host.\n\tip -netns \"${rtname}\" link \\\n\t\tadd \"${VRF_DEVNAME}\" type vrf table \"${VRF_TID}\"\n\tip -netns \"${rtname}\" link set \"${VRF_DEVNAME}\" up\n\n\t# enslave the veth interface connecting the router with the host to the\n\t# VRF in the access router\n\tip -netns \"${rtname}\" link \\\n\t\tset \"${RT2HS_DEVNAME}\" master \"${VRF_DEVNAME}\"\n\n\tip -netns \"${rtname}\" addr \\\n\t\tadd \"${IPv6_HS_NETWORK}::254/64\" dev \"${RT2HS_DEVNAME}\" nodad\n\tip -netns \"${rtname}\" addr \\\n\t\tadd \"${IPv4_HS_NETWORK}.254/24\" dev \"${RT2HS_DEVNAME}\"\n\n\tip -netns \"${rtname}\" link set \"${RT2HS_DEVNAME}\" up\n\n\tip netns exec \"${rtname}\" \\\n\t\tsysctl -wq net.ipv6.conf.\"${RT2HS_DEVNAME}\".proxy_ndp=1\n\tip netns exec \"${rtname}\" \\\n\t\tsysctl -wq net.ipv4.conf.\"${RT2HS_DEVNAME}\".proxy_arp=1\n\n\t# disable the rp_filter otherwise the kernel gets confused about how\n\t# to route decap ipv4 packets.\n\tip netns exec \"${rtname}\" \\\n\t\tsysctl -wq net.ipv4.conf.\"${RT2HS_DEVNAME}\".rp_filter=0\n\n\tip netns exec \"${rtname}\" sh -c \"echo 1 > /proc/sys/net/vrf/strict_mode\"\n}\n\nsetup()\n{\n\tlocal i\n\n\t# create routers\n\tROUTERS=\"1 2 3 4\"; readonly ROUTERS\n\tfor i in ${ROUTERS}; do\n\t\tcreate_router \"${i}\"\n\tdone\n\n\t# create hosts\n\tHOSTS=\"1 2 3 4\"; readonly HOSTS\n\tfor i in ${HOSTS}; do\n\t\tcreate_host \"${i}\"\n\tdone\n\n\t# set up the links for connecting routers\n\tadd_link_rt_pairs 1 \"2 3 4\"\n\tadd_link_rt_pairs 2 \"3 4\"\n\tadd_link_rt_pairs 3 \"4\"\n\n\t# set up the basic connectivity of routers and routes required for\n\t# reachability of SIDs.\n\tsetup_rt_networking 1 \"2 3 4\"\n\tsetup_rt_networking 2 \"1 3 4\"\n\tsetup_rt_networking 3 \"1 2 4\"\n\tsetup_rt_networking 4 \"1 2 3\"\n\n\t# set up the hosts connected to routers\n\tsetup_hs 1 1\n\tsetup_hs 2 2\n\tsetup_hs 3 3\n\tsetup_hs 4 4\n\n\t# set up default SRv6 Endpoints (i.e. SRv6 End and SRv6 End.DT46)\n\tsetup_rt_local_sids 1 \"2 3 4\"\n\tsetup_rt_local_sids 2 \"1 3 4\"\n\tsetup_rt_local_sids 3 \"1 2 4\"\n\tsetup_rt_local_sids 4 \"1 2 3\"\n\n\t# set up SRv6 policies\n\n\t# create an IPv6 VPN between hosts hs-1 and hs-2.\n\t# the network path between hs-1 and hs-2 traverses several routers\n\t# depending on the direction of traffic.\n\t#\n\t# Direction hs-1 -> hs-2 (H.Encaps.Red)\n\t#  - rt-3,rt-4 (SRv6 End behaviors)\n\t#  - rt-2 (SRv6 End.DT46 behavior)\n\t#\n\t# Direction hs-2 -> hs-1 (H.Encaps.Red)\n\t#  - rt-1 (SRv6 End.DT46 behavior)\n\tsetup_rt_policy_ipv6 2 1 \"3 4\" 2 encap.red\n\tsetup_rt_policy_ipv6 1 2 \"\" 1 encap.red\n\n\t# create an IPv4 VPN between hosts hs-1 and hs-2\n\t# the network path between hs-1 and hs-2 traverses several routers\n\t# depending on the direction of traffic.\n\t#\n\t# Direction hs-1 -> hs-2 (H.Encaps.Red)\n\t# - rt-2 (SRv6 End.DT46 behavior)\n\t#\n\t# Direction hs-2 -> hs-1 (H.Encaps.Red)\n\t#  - rt-4,rt-3 (SRv6 End behaviors)\n\t#  - rt-1 (SRv6 End.DT46 behavior)\n\tsetup_rt_policy_ipv4 2 1 \"\" 2 encap.red\n\tsetup_rt_policy_ipv4 1 2 \"4 3\" 1 encap.red\n\n\t# create an IPv6 VPN between hosts hs-3 and hs-4\n\t# the network path between hs-3 and hs-4 traverses several routers\n\t# depending on the direction of traffic.\n\t#\n\t# Direction hs-3 -> hs-4 (H.Encaps.Red)\n\t# - rt-2 (SRv6 End Behavior)\n\t# - rt-4 (SRv6 End.DT46 behavior)\n\t#\n\t# Direction hs-4 -> hs-3 (H.Encaps.Red)\n\t#  - rt-1 (SRv6 End behavior)\n\t#  - rt-3 (SRv6 End.DT46 behavior)\n\tsetup_rt_policy_ipv6 4 3 \"2\" 4 encap.red\n\tsetup_rt_policy_ipv6 3 4 \"1\" 3 encap.red\n\n\t# testing environment was set up successfully\n\tSETUP_ERR=0\n}\n\ncheck_rt_connectivity()\n{\n\tlocal rtsrc=\"$1\"\n\tlocal rtdst=\"$2\"\n\tlocal prefix\n\tlocal rtsrc_nsname\n\n\trtsrc_nsname=\"$(get_rtname \"${rtsrc}\")\"\n\n\tprefix=\"$(get_network_prefix \"${rtsrc}\" \"${rtdst}\")\"\n\n\tip netns exec \"${rtsrc_nsname}\" ping -c 1 -W \"${PING_TIMEOUT_SEC}\" \\\n\t\t\"${prefix}::${rtdst}\" >/dev/null 2>&1\n}\n\ncheck_and_log_rt_connectivity()\n{\n\tlocal rtsrc=\"$1\"\n\tlocal rtdst=\"$2\"\n\n\tcheck_rt_connectivity \"${rtsrc}\" \"${rtdst}\"\n\tlog_test $? 0 \"Routers connectivity: rt-${rtsrc} -> rt-${rtdst}\"\n}\n\ncheck_hs_ipv6_connectivity()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\tlocal hssrc_nsname\n\n\thssrc_nsname=\"$(get_hsname \"${hssrc}\")\"\n\n\tip netns exec \"${hssrc_nsname}\" ping -c 1 -W \"${PING_TIMEOUT_SEC}\" \\\n\t\t\"${IPv6_HS_NETWORK}::${hsdst}\" >/dev/null 2>&1\n}\n\ncheck_hs_ipv4_connectivity()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\tlocal hssrc_nsname\n\n\thssrc_nsname=\"$(get_hsname \"${hssrc}\")\"\n\n\tip netns exec \"${hssrc_nsname}\" ping -c 1 -W \"${PING_TIMEOUT_SEC}\" \\\n\t\t\"${IPv4_HS_NETWORK}.${hsdst}\" >/dev/null 2>&1\n}\n\ncheck_and_log_hs2gw_connectivity()\n{\n\tlocal hssrc=\"$1\"\n\n\tcheck_hs_ipv6_connectivity \"${hssrc}\" 254\n\tlog_test $? 0 \"IPv6 Hosts connectivity: hs-${hssrc} -> gw\"\n\n\tcheck_hs_ipv4_connectivity \"${hssrc}\" 254\n\tlog_test $? 0 \"IPv4 Hosts connectivity: hs-${hssrc} -> gw\"\n}\n\ncheck_and_log_hs_ipv6_connectivity()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\n\tcheck_hs_ipv6_connectivity \"${hssrc}\" \"${hsdst}\"\n\tlog_test $? 0 \"IPv6 Hosts connectivity: hs-${hssrc} -> hs-${hsdst}\"\n}\n\ncheck_and_log_hs_ipv4_connectivity()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\n\tcheck_hs_ipv4_connectivity \"${hssrc}\" \"${hsdst}\"\n\tlog_test $? 0 \"IPv4 Hosts connectivity: hs-${hssrc} -> hs-${hsdst}\"\n}\n\ncheck_and_log_hs_connectivity()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\n\tcheck_and_log_hs_ipv4_connectivity \"${hssrc}\" \"${hsdst}\"\n\tcheck_and_log_hs_ipv6_connectivity \"${hssrc}\" \"${hsdst}\"\n}\n\ncheck_and_log_hs_ipv6_isolation()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\n\t# in this case, the connectivity test must fail\n\tcheck_hs_ipv6_connectivity \"${hssrc}\" \"${hsdst}\"\n\tlog_test $? 1 \"IPv6 Hosts isolation: hs-${hssrc} -X-> hs-${hsdst}\"\n}\n\ncheck_and_log_hs_ipv4_isolation()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\n\t# in this case, the connectivity test must fail\n\tcheck_hs_ipv4_connectivity \"${hssrc}\" \"${hsdst}\"\n\tlog_test $? 1 \"IPv4 Hosts isolation: hs-${hssrc} -X-> hs-${hsdst}\"\n}\n\ncheck_and_log_hs_isolation()\n{\n\tlocal hssrc=\"$1\"\n\tlocal hsdst=\"$2\"\n\n\tcheck_and_log_hs_ipv6_isolation \"${hssrc}\" \"${hsdst}\"\n\tcheck_and_log_hs_ipv4_isolation \"${hssrc}\" \"${hsdst}\"\n}\n\nrouter_tests()\n{\n\tlocal i\n\tlocal j\n\n\tlog_section \"IPv6 routers connectivity test\"\n\n\tfor i in ${ROUTERS}; do\n\t\tfor j in ${ROUTERS}; do\n\t\t\tif [ \"${i}\" -eq \"${j}\" ]; then\n\t\t\t\tcontinue\n\t\t\tfi\n\n\t\t\tcheck_and_log_rt_connectivity \"${i}\" \"${j}\"\n\t\tdone\n\tdone\n}\n\nhost2gateway_tests()\n{\n\tlocal hs\n\n\tlog_section \"IPv4/IPv6 connectivity test among hosts and gateways\"\n\n\tfor hs in ${HOSTS}; do\n\t\tcheck_and_log_hs2gw_connectivity \"${hs}\"\n\tdone\n}\n\nhost_vpn_tests()\n{\n\tlog_section \"SRv6 VPN connectivity test hosts (h1 <-> h2, IPv4/IPv6)\"\n\n\tcheck_and_log_hs_connectivity 1 2\n\tcheck_and_log_hs_connectivity 2 1\n\n\tlog_section \"SRv6 VPN connectivity test hosts (h3 <-> h4, IPv6 only)\"\n\n\tcheck_and_log_hs_ipv6_connectivity 3 4\n\tcheck_and_log_hs_ipv6_connectivity 4 3\n}\n\nhost_vpn_isolation_tests()\n{\n\tlocal l1=\"1 2\"\n\tlocal l2=\"3 4\"\n\tlocal tmp\n\tlocal i\n\tlocal j\n\tlocal k\n\n\tlog_section \"SRv6 VPN isolation test among hosts\"\n\n\tfor k in 0 1; do\n\t\tfor i in ${l1}; do\n\t\t\tfor j in ${l2}; do\n\t\t\t\tcheck_and_log_hs_isolation \"${i}\" \"${j}\"\n\t\t\tdone\n\t\tdone\n\n\t\t# let us test the reverse path\n\t\ttmp=\"${l1}\"; l1=\"${l2}\"; l2=\"${tmp}\"\n\tdone\n\n\tlog_section \"SRv6 VPN isolation test among hosts (h2 <-> h4, IPv4 only)\"\n\n\tcheck_and_log_hs_ipv4_isolation 2 4\n\tcheck_and_log_hs_ipv4_isolation 4 2\n}\n\ntest_iproute2_supp_or_ksft_skip()\n{\n\tif ! ip route help 2>&1 | grep -qo \"encap.red\"; then\n\t\techo \"SKIP: Missing SRv6 encap.red support in iproute2\"\n\t\texit \"${ksft_skip}\"\n\tfi\n}\n\ntest_vrf_or_ksft_skip()\n{\n\tmodprobe vrf &>/dev/null || true\n\tif [ ! -e /proc/sys/net/vrf/strict_mode ]; then\n\t\techo \"SKIP: vrf sysctl does not exist\"\n\t\texit \"${ksft_skip}\"\n\tfi\n}\n\nif [ \"$(id -u)\" -ne 0 ]; then\n\techo \"SKIP: Need root privileges\"\n\texit \"${ksft_skip}\"\nfi\n\n# required programs to carry out this selftest\ntest_command_or_ksft_skip ip\ntest_command_or_ksft_skip ping\ntest_command_or_ksft_skip sysctl\ntest_command_or_ksft_skip grep\n\ntest_iproute2_supp_or_ksft_skip\ntest_vrf_or_ksft_skip\n\nset -e\ntrap cleanup EXIT\n\nsetup\nset +e\n\nrouter_tests\nhost2gateway_tests\nhost_vpn_tests\nhost_vpn_isolation_tests\n\nprint_log_test_results\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}