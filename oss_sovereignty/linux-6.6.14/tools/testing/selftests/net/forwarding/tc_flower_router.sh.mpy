{
  "module_name": "tc_flower_router.sh",
  "hash_id": "1669fe65d58dc13b28a49f73b07fd9e53fb995d444f8b5d09ff1730e321bc2ad",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_flower_router.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"match_indev_egress_test\"\nNUM_NETIFS=6\nsource tc_common.sh\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.1.1/24\n\n\tip route add 192.0.2.0/24 vrf v$h1 nexthop via 192.0.1.2\n\tip route add 192.0.3.0/24 vrf v$h1 nexthop via 192.0.1.2\n}\n\nh1_destroy()\n{\n\tip route del 192.0.3.0/24 vrf v$h1\n\tip route del 192.0.2.0/24 vrf v$h1\n\n\tsimple_if_fini $h1 192.0.1.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.1/24\n\n\tip route add 192.0.1.0/24 vrf v$h2 nexthop via 192.0.2.2\n\tip route add 192.0.3.0/24 vrf v$h2 nexthop via 192.0.2.2\n}\n\nh2_destroy()\n{\n\tip route del 192.0.3.0/24 vrf v$h2\n\tip route del 192.0.1.0/24 vrf v$h2\n\n\tsimple_if_fini $h2 192.0.2.1/24\n}\n\nh3_create()\n{\n\tsimple_if_init $h3 192.0.3.1/24\n\n\tip route add 192.0.1.0/24 vrf v$h3 nexthop via 192.0.3.2\n\tip route add 192.0.2.0/24 vrf v$h3 nexthop via 192.0.3.2\n}\n\nh3_destroy()\n{\n\tip route del 192.0.2.0/24 vrf v$h3\n\tip route del 192.0.1.0/24 vrf v$h3\n\n\tsimple_if_fini $h3 192.0.3.1/24\n}\n\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\tip link set dev $rp3 up\n\n\ttc qdisc add dev $rp3 clsact\n\n\tip address add 192.0.1.2/24 dev $rp1\n\tip address add 192.0.2.2/24 dev $rp2\n\tip address add 192.0.3.2/24 dev $rp3\n}\n\nrouter_destroy()\n{\n\tip address del 192.0.3.2/24 dev $rp3\n\tip address del 192.0.2.2/24 dev $rp2\n\tip address del 192.0.1.2/24 dev $rp1\n\n\ttc qdisc del dev $rp3 clsact\n\n\tip link set dev $rp3 down\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nmatch_indev_egress_test()\n{\n\tRET=0\n\n\ttc filter add dev $rp3 egress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags indev $rp1 dst_ip 192.0.3.1 action drop\n\ttc filter add dev $rp3 egress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags indev $rp2 dst_ip 192.0.3.1 action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $rp1mac -A 192.0.1.1 -B 192.0.3.1 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $rp3 egress\" 102 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $rp3 egress\" 101 1\n\tcheck_err $? \"Did not match on correct filter\"\n\n\t$MZ $h2 -c 1 -p 64 -a $h2mac -b $rp2mac -A 192.0.2.1 -B 192.0.3.1 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $rp3 egress\" 101 2\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $rp3 egress\" 102 1\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc filter del dev $rp3 egress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $rp3 egress protocol ip pref 1 handle 101 flower\n\n\tlog_test \"indev egress match ($tcflags)\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\th2=${NETIFS[p3]}\n\trp2=${NETIFS[p4]}\n\n\th3=${NETIFS[p5]}\n\trp3=${NETIFS[p6]}\n\n\th1mac=$(mac_get $h1)\n\trp1mac=$(mac_get $rp1)\n\th2mac=$(mac_get $h2)\n\trp2mac=$(mac_get $rp2)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\th3_create\n\n\trouter_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter_destroy\n\n\th3_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntc_offload_check\nif [[ $? -ne 0 ]]; then\n\tlog_info \"Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttests_run\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}