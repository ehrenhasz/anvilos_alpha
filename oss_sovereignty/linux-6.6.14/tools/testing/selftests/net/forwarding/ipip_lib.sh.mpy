{
  "module_name": "ipip_lib.sh",
  "hash_id": "bbdfcb371553d4dc2a7702a941c47a0e1c7edd90da6b5cc84c473a5180ea3837",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/ipip_lib.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Handles creation and destruction of IP-in-IP or GRE tunnels over the given\n# topology. Supports both flat and hierarchical models.\n#\n# Flat Model:\n# Overlay and underlay share the same VRF.\n# SW1 uses default VRF so tunnel has no bound dev.\n# SW2 uses non-default VRF tunnel has a bound dev.\n# +-------------------------+\n# | H1                      |\n# |               $h1 +     |\n# |      192.0.2.1/28 |     |\n# +-------------------|-----+\n#                     |\n# +-------------------|-----+\n# | SW1               |     |\n# |              $ol1 +     |\n# |      192.0.2.2/28       |\n# |                         |\n# |  + g1a (gre)            |\n# |    loc=192.0.2.65       |\n# |    rem=192.0.2.66 --.   |\n# |    tos=inherit      |   |\n# |  .------------------'   |\n# |  |                      |\n# |  v                      |\n# |  + $ul1.111 (vlan)      |\n# |  | 192.0.2.129/28       |\n# |   \\                     |\n# |    \\_______             |\n# |            |            |\n# |VRF default + $ul1       |\n# +------------|------------+\n#              |\n# +------------|------------+\n# | SW2        + $ul2       |\n# |     _______|            |\n# |    /                    |\n# |   /                     |\n# |  + $ul2.111 (vlan)      |\n# |  ^ 192.0.2.130/28       |\n# |  |                      |\n# |  |                      |\n# |  '------------------.   |\n# |  + g2a (gre)        |   |\n# |    loc=192.0.2.66   |   |\n# |    rem=192.0.2.65 --'   |\n# |    tos=inherit          |\n# |                         |\n# |              $ol2 +     |\n# |     192.0.2.17/28 |     |\n# | VRF v$ol2         |     |\n# +-------------------|-----+\n#                     |\n# +-------------------|-----+\n# | H2                |     |\n# |               $h2 +     |\n# |     192.0.2.18/28       |\n# +-------------------------+\n#\n# Hierarchical model:\n# The tunnel is bound to a device in a different VRF\n#\n# +---------------------------+\n# | H1                        |\n# |               $h1 +       |\n# |      192.0.2.1/28 |       |\n# +-------------------|-------+\n#                     |\n# +-------------------|-------+\n# | SW1               |       |\n# | +-----------------|-----+ |\n# | |            $ol1 +     | |\n# | |     192.0.2.2/28      | |\n# | |                       | |\n# | |    + g1a (gre)        | |\n# | |    rem=192.0.2.66     | |\n# | |    tos=inherit        | |\n# | |    loc=192.0.2.65     | |\n# | |           ^           | |\n# | | VRF v$ol1 |           | |\n# | +-----------|-----------+ |\n# |             |             |\n# | +-----------|-----------+ |\n# | | VRF v$ul1 |           | |\n# | |           |           | |\n# | |           |           | |\n# | |           v           | |\n# | |    dummy1 +           | |\n# | |   192.0.2.65          | |\n# | |   .-------'           | |\n# | |   |                   | |\n# | |   v                   | |\n# | |   + $ul1.111 (vlan)   | |\n# | |   | 192.0.2.129/28    | |\n# | |   \\                   | |\n# | |    \\_____             | |\n# | |          |            | |\n# | |          + $ul1       | |\n# | +----------|------------+ |\n# +------------|--------------+\n#              |\n# +------------|--------------+\n# | SW2        |              |\n# | +----------|------------+ |\n# | |          + $ul2       | |\n# | |     _____|            | |\n# | |    /                  | |\n# | |   /                   | |\n# | |   | $ul2.111 (vlan)   | |\n# | |   + 192.0.2.130/28    | |\n# | |   ^                   | |\n# | |   |                   | |\n# | |   '-------.           | |\n# | |    dummy2 +           | |\n# | |    192.0.2.66         | |\n# | |           ^           | |\n# | |           |           | |\n# | |           |           | |\n# | | VRF v$ul2 |           | |\n# | +-----------|-----------+ |\n# |             |             |\n# | +-----------|-----------+ |\n# | | VRF v$ol2 |           | |\n# | |           |           | |\n# | |           v           | |\n# | |  g2a (gre)+           | |\n# | |  loc=192.0.2.66       | |\n# | |  rem=192.0.2.65       | |\n# | |  tos=inherit          | |\n# | |                       | |\n# | |            $ol2 +     | |\n# | |   192.0.2.17/28 |     | |\n# | +-----------------|-----+ |\n# +-------------------|-------+\n#                     |\n# +-------------------|-------+\n# | H2                |       |\n# |               $h2 +       |\n# |     192.0.2.18/28         |\n# +---------------------------+\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n\tip route add vrf v$h1 192.0.2.16/28 via 192.0.2.2\n}\n\nh1_destroy()\n{\n\tip route del vrf v$h1 192.0.2.16/28 via 192.0.2.2\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.18/28\n\tip route add vrf v$h2 192.0.2.0/28 via 192.0.2.17\n}\n\nh2_destroy()\n{\n\tip route del vrf v$h2 192.0.2.0/28 via 192.0.2.17\n\tsimple_if_fini $h2 192.0.2.18/28\n}\n\nsw1_flat_create()\n{\n\tlocal type=$1; shift\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tip link set dev $ol1 up\n        __addr_add_del $ol1 add \"192.0.2.2/28\"\n\n\tip link set dev $ul1 up\n\tvlan_create $ul1 111 \"\" 192.0.2.129/28\n\n\ttunnel_create g1a $type 192.0.2.65 192.0.2.66 tos inherit \"$@\"\n\tip link set dev g1a up\n        __addr_add_del g1a add \"192.0.2.65/32\"\n\n\tip route add 192.0.2.66/32 via 192.0.2.130\n\n\tip route add 192.0.2.16/28 nexthop dev g1a\n}\n\nsw1_flat_destroy()\n{\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tip route del 192.0.2.16/28\n\n\tip route del 192.0.2.66/32 via 192.0.2.130\n\t__simple_if_fini g1a 192.0.2.65/32\n\ttunnel_destroy g1a\n\n\tvlan_destroy $ul1 111\n\t__simple_if_fini $ul1\n\t__simple_if_fini $ol1 192.0.2.2/28\n}\n\nsw2_flat_create()\n{\n\tlocal type=$1; shift\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tsimple_if_init $ol2 192.0.2.17/28\n\t__simple_if_init $ul2 v$ol2\n\tvlan_create $ul2 111 v$ol2 192.0.2.130/28\n\n\ttunnel_create g2a $type 192.0.2.66 192.0.2.65 tos inherit dev v$ol2 \\\n\t\t\"$@\"\n\t__simple_if_init g2a v$ol2 192.0.2.66/32\n\n\tip route add vrf v$ol2 192.0.2.65/32 via 192.0.2.129\n\tip route add vrf v$ol2 192.0.2.0/28 nexthop dev g2a\n}\n\nsw2_flat_destroy()\n{\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tip route del vrf v$ol2 192.0.2.0/28\n\n\tip route del vrf v$ol2 192.0.2.65/32 via 192.0.2.129\n\t__simple_if_fini g2a 192.0.2.66/32\n\ttunnel_destroy g2a\n\n\tvlan_destroy $ul2 111\n\t__simple_if_fini $ul2\n\tsimple_if_fini $ol2 192.0.2.17/28\n}\n\nsw1_hierarchical_create()\n{\n\tlocal type=$1; shift\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tsimple_if_init $ol1 192.0.2.2/28\n\tsimple_if_init $ul1\n\tip link add name dummy1 type dummy\n\t__simple_if_init dummy1 v$ul1 192.0.2.65/32\n\n\tvlan_create $ul1 111 v$ul1 192.0.2.129/28\n\ttunnel_create g1a $type 192.0.2.65 192.0.2.66 tos inherit dev dummy1 \\\n\t\t\"$@\"\n\tip link set dev g1a master v$ol1\n\n\tip route add vrf v$ul1 192.0.2.66/32 via 192.0.2.130\n\tip route add vrf v$ol1 192.0.2.16/28 nexthop dev g1a\n}\n\nsw1_hierarchical_destroy()\n{\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tip route del vrf v$ol1 192.0.2.16/28\n\tip route del vrf v$ul1 192.0.2.66/32\n\n\ttunnel_destroy g1a\n\tvlan_destroy $ul1 111\n\n\t__simple_if_fini dummy1 192.0.2.65/32\n\tip link del dev dummy1\n\n\tsimple_if_fini $ul1\n\tsimple_if_fini $ol1 192.0.2.2/28\n}\n\nsw2_hierarchical_create()\n{\n\tlocal type=$1; shift\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tsimple_if_init $ol2 192.0.2.17/28\n\tsimple_if_init $ul2\n\n\tip link add name dummy2 type dummy\n\t__simple_if_init dummy2 v$ul2 192.0.2.66/32\n\n\tvlan_create $ul2 111 v$ul2 192.0.2.130/28\n\ttunnel_create g2a $type 192.0.2.66 192.0.2.65 tos inherit dev dummy2 \\\n\t\t\"$@\"\n\tip link set dev g2a master v$ol2\n\n\tip route add vrf v$ul2 192.0.2.65/32 via 192.0.2.129\n\tip route add vrf v$ol2 192.0.2.0/28 nexthop dev g2a\n}\n\nsw2_hierarchical_destroy()\n{\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tip route del vrf v$ol2 192.0.2.0/28\n\tip route del vrf v$ul2 192.0.2.65/32\n\n\ttunnel_destroy g2a\n\tvlan_destroy $ul2 111\n\n\t__simple_if_fini dummy2 192.0.2.66/32\n\tip link del dev dummy2\n\n\tsimple_if_fini $ul2\n\tsimple_if_fini $ol2 192.0.2.17/28\n}\n\ntopo_mtu_change()\n{\n\tlocal mtu=$1\n\n\tip link set mtu $mtu dev $h1\n\tip link set mtu $mtu dev $ol1\n\tip link set mtu $mtu dev g1a\n\tip link set mtu $mtu dev $ul1\n\tip link set mtu $mtu dev $ul1.111\n\tip link set mtu $mtu dev $h2\n\tip link set mtu $mtu dev $ol2\n\tip link set mtu $mtu dev g2a\n\tip link set mtu $mtu dev $ul2\n\tip link set mtu $mtu dev $ul2.111\n}\n\ntest_mtu_change()\n{\n\tlocal encap=$1; shift\n\n\tRET=0\n\n\tping_do $h1 192.0.2.18 \"-s 1800\t-w 3\"\n\tcheck_fail $? \"ping $encap should not pass with size 1800\"\n\n\tRET=0\n\n\ttopo_mtu_change\t2000\n\tping_do\t$h1 192.0.2.18 \"-s 1800\t-w 3\"\n\tcheck_err $?\n\tlog_test \"ping $encap packet size 1800 after MTU change\"\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}