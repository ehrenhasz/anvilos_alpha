{
  "module_name": "mirror_gre_lag_lacp.sh",
  "hash_id": "2c26fe2e69c1b0462fba90cea2d3744e1135e670e8b2b3be711b6c9193dfa1fd",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_lag_lacp.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test for \"tc action mirred egress mirror\" when the underlay route points at a\n# team device.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |    + $h1.333         |                             |        $h1.555 +     |\n# |    | 192.0.2.1/28    |                             |  192.0.2.18/28 |     |\n# +----|-----------------+                             +----------------|-----+\n#      |                                $h1                             |\n#      +---------------------------------+------------------------------+\n#                                        |\n# +--------------------------------------|------------------------------------+\n# | SW                                   o---> mirror                         |\n# |                                      |                                    |\n# |   +----------------------------------+------------------------------+     |\n# |   |                                $swp1                            |     |\n# |   + $swp1.333                                             $swp1.555 +     |\n# |     192.0.2.2/28                                      192.0.2.17/28       |\n# |                                                                           |\n# |                                                                           |\n# |   + gt4 (gretap)      ,-> + lag1 (team)                                   |\n# |     loc=192.0.2.129   |   | 192.0.2.129/28                                |\n# |     rem=192.0.2.130 --'   |                                               |\n# |     ttl=100               |                                               |\n# |     tos=inherit           |                                               |\n# |      _____________________|______________________                         |\n# |     /                                            \\                        |\n# |    /                                              \\                       |\n# |   + $swp3                                          + $swp4                |\n# +---|------------------------------------------------|----------------------+\n#     |                                                |\n# +---|------------------------------------------------|----------------------+\n# |   + $h3                                            + $h4               H3 |\n# |    \\                                              /                       |\n# |     \\____________________________________________/                        |\n# |                           |                                               |\n# |                           + lag2 (team)                                   |\n# |                             192.0.2.130/28                                |\n# |                                                                           |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\ttest_mirror_gretap_first\n\ttest_mirror_gretap_second\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\n\nrequire_command $ARPING\n\nvlan_host_create()\n{\n\tlocal if_name=$1; shift\n\tlocal vid=$1; shift\n\tlocal vrf_name=$1; shift\n\tlocal ips=(\"${@}\")\n\n\tvrf_create $vrf_name\n\tip link set dev $vrf_name up\n\tvlan_create $if_name $vid $vrf_name \"${ips[@]}\"\n}\n\nvlan_host_destroy()\n{\n\tlocal if_name=$1; shift\n\tlocal vid=$1; shift\n\tlocal vrf_name=$1; shift\n\n\tvlan_destroy $if_name $vid\n\tip link set dev $vrf_name down\n\tvrf_destroy $vrf_name\n}\n\nh1_create()\n{\n\tvlan_host_create $h1 333 vrf-h1 192.0.2.1/28\n\tip -4 route add 192.0.2.16/28 vrf vrf-h1 nexthop via 192.0.2.2\n}\n\nh1_destroy()\n{\n\tip -4 route del 192.0.2.16/28 vrf vrf-h1\n\tvlan_host_destroy $h1 333 vrf-h1\n}\n\nh2_create()\n{\n\tvlan_host_create $h1 555 vrf-h2 192.0.2.18/28\n\tip -4 route add 192.0.2.0/28 vrf vrf-h2 nexthop via 192.0.2.17\n}\n\nh2_destroy()\n{\n\tip -4 route del 192.0.2.0/28 vrf vrf-h2\n\tvlan_host_destroy $h1 555 vrf-h2\n}\n\nh3_create_team()\n{\n\tteam_create lag2 lacp $h3 $h4\n\t__simple_if_init lag2 vrf-h3 192.0.2.130/32\n\tip -4 route add vrf vrf-h3 192.0.2.129/32 dev lag2\n}\n\nh3_destroy_team()\n{\n\tip -4 route del vrf vrf-h3 192.0.2.129/32 dev lag2\n\t__simple_if_fini lag2 192.0.2.130/32\n\tteam_destroy lag2\n\n\tip link set dev $h3 down\n\tip link set dev $h4 down\n}\n\nh3_create()\n{\n\tvrf_create vrf-h3\n\tip link set dev vrf-h3 up\n\ttc qdisc add dev $h3 clsact\n\ttc qdisc add dev $h4 clsact\n\th3_create_team\n}\n\nh3_destroy()\n{\n\th3_destroy_team\n\ttc qdisc del dev $h4 clsact\n\ttc qdisc del dev $h3 clsact\n\tip link set dev vrf-h3 down\n\tvrf_destroy vrf-h3\n}\n\nswitch_create()\n{\n\tip link set dev $swp1 up\n\ttc qdisc add dev $swp1 clsact\n\tvlan_create $swp1 333 \"\" 192.0.2.2/28\n\tvlan_create $swp1 555 \"\" 192.0.2.17/28\n\n\ttunnel_create gt4 gretap 192.0.2.129 192.0.2.130 \\\n\t\t      ttl 100 tos inherit\n\n\tip link set dev $swp3 up\n\tip link set dev $swp4 up\n\tteam_create lag1 lacp $swp3 $swp4\n\t__addr_add_del lag1 add 192.0.2.129/32\n\tip -4 route add 192.0.2.130/32 dev lag1\n}\n\nswitch_destroy()\n{\n\tip -4 route del 192.0.2.130/32 dev lag1\n\t__addr_add_del lag1 del 192.0.2.129/32\n\tteam_destroy lag1\n\n\tip link set dev $swp4 down\n\tip link set dev $swp3 down\n\n\ttunnel_destroy gt4\n\n\tvlan_destroy $swp1 555\n\tvlan_destroy $swp1 333\n\ttc qdisc del dev $swp1 clsact\n\tip link set dev $swp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp3=${NETIFS[p3]}\n\th3=${NETIFS[p4]}\n\n\tswp4=${NETIFS[p5]}\n\th4=${NETIFS[p6]}\n\n\tvrf_prepare\n\n\tip link set dev $h1 up\n\th1_create\n\th2_create\n\th3_create\n\tswitch_create\n\n\ttrap_install $h3 ingress\n\ttrap_install $h4 ingress\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\ttrap_uninstall $h4 ingress\n\ttrap_uninstall $h3 ingress\n\n\tswitch_destroy\n\th3_destroy\n\th2_destroy\n\th1_destroy\n\tip link set dev $h1 down\n\n\tvrf_cleanup\n}\n\ntest_lag_slave()\n{\n\tlocal up_dev=$1; shift\n\tlocal down_dev=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\tmirror_install $swp1 ingress gt4 \\\n\t\t       \"proto 802.1q flower vlan_id 333 $tcflags\"\n\n\t# Move $down_dev away from the team. That will prompt change in\n\t# txability of the connected device, without changing its upness. The\n\t# driver should notice the txability change and move the traffic to the\n\t# other slave.\n\tip link set dev $down_dev nomaster\n\tsleep 2\n\tmirror_test vrf-h1 192.0.2.1 192.0.2.18 $up_dev 1 10\n\n\t# Test lack of connectivity when neither slave is txable.\n\tip link set dev $up_dev nomaster\n\tsleep 2\n\tmirror_test vrf-h1 192.0.2.1 192.0.2.18 $h3 1 0\n\tmirror_test vrf-h1 192.0.2.1 192.0.2.18 $h4 1 0\n\tmirror_uninstall $swp1 ingress\n\n\t# Recreate H3's team device, because mlxsw, which this test is\n\t# predominantly mean to test, requires a bottom-up construction and\n\t# doesn't allow enslavement to a device that already has an upper.\n\th3_destroy_team\n\th3_create_team\n\t# Wait for ${h,swp}{3,4}.\n\tsetup_wait\n\n\tlog_test \"$what ($tcflags)\"\n}\n\ntest_mirror_gretap_first()\n{\n\ttest_lag_slave $h3 $h4 \"mirror to gretap: LAG first slave\"\n}\n\ntest_mirror_gretap_second()\n{\n\ttest_lag_slave $h4 $h3 \"mirror to gretap: LAG second slave\"\n}\n\ntest_all()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntest_all\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttest_all\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}