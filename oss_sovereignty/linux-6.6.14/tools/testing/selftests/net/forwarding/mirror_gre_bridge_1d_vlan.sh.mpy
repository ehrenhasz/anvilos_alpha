{
  "module_name": "mirror_gre_bridge_1d_vlan.sh",
  "hash_id": "b49c0d1fbe96460ccaeeffd2331c4b821c7784d5b70c08a8b02914f755d1ffe4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_bridge_1d_vlan.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test uses standard topology for testing gretap. See\n# mirror_gre_topo_lib.sh for more details.\n#\n# Test for \"tc action mirred egress mirror\" when the underlay route points at a\n# bridge device without vlan filtering (802.1d). The device attached to that\n# bridge is a VLAN.\n\nALL_TESTS=\"\n\ttest_gretap\n\ttest_ip6gretap\n\ttest_gretap_stp\n\ttest_ip6gretap_stp\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\nsource mirror_gre_topo_lib.sh\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tvrf_prepare\n\tmirror_gre_topo_create\n\n\tip link add name br2 address $(mac_get $swp3) \\\n\t\ttype bridge vlan_filtering 0\n\tip link set dev br2 up\n\n\tvlan_create $swp3 555\n\n\tip link set dev $swp3.555 master br2\n\tip route add 192.0.2.130/32 dev br2\n\tip -6 route add 2001:db8:2::2/128 dev br2\n\n\tip address add dev br2 192.0.2.129/32\n\tip address add dev br2 2001:db8:2::1/128\n\n\tvlan_create $h3 555 v$h3 192.0.2.130/28 2001:db8:2::2/64\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tvlan_destroy $h3 555\n\tip link del dev br2\n\tvlan_destroy $swp3 555\n\n\tmirror_gre_topo_destroy\n\tvrf_cleanup\n}\n\ntest_vlan_match()\n{\n\tlocal tundev=$1; shift\n\tlocal vlan_match=$1; shift\n\tlocal what=$1; shift\n\n\tfull_test_span_gre_dir_vlan $tundev ingress \"$vlan_match\" 8 0 \"$what\"\n\tfull_test_span_gre_dir_vlan $tundev egress \"$vlan_match\" 0 8 \"$what\"\n}\n\ntest_gretap()\n{\n\ttest_vlan_match gt4 'skip_hw vlan_id 555 vlan_ethtype ip' \\\n\t\t\t\"mirror to gretap\"\n}\n\ntest_ip6gretap()\n{\n\ttest_vlan_match gt6 'skip_hw vlan_id 555 vlan_ethtype ipv6' \\\n\t\t\t\"mirror to ip6gretap\"\n}\n\ntest_gretap_stp()\n{\n\t# Sometimes after mirror installation, the neighbor's state is not valid.\n\t# The reason is that there is no SW datapath activity related to the\n\t# neighbor for the remote GRE address. Therefore whether the corresponding\n\t# neighbor will be valid is a matter of luck, and the test is thus racy.\n\t# Set the neighbor's state to permanent, so it would be always valid.\n\tip neigh replace 192.0.2.130 lladdr $(mac_get $h3) \\\n\t\tnud permanent dev br2\n\tfull_test_span_gre_stp gt4 $swp3.555 \"mirror to gretap\"\n}\n\ntest_ip6gretap_stp()\n{\n\tip neigh replace 2001:db8:2::2 lladdr $(mac_get $h3) \\\n\t\tnud permanent dev br2\n\tfull_test_span_gre_stp gt6 $swp3.555 \"mirror to ip6gretap\"\n}\n\ntest_all()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntest_all\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttest_all\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}