{
  "module_name": "tc_chains.sh",
  "hash_id": "05789537a7a8b64f68f4bc454223ea4fa7e729ab5e72642ebfeeaa0f182e10ab",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_chains.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"unreachable_chain_test gact_goto_chain_test create_destroy_chain \\\n\t   template_filter_fits\"\nNUM_NETIFS=2\nsource tc_common.sh\nsource lib.sh\n\ntcflags=\"skip_hw\"\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/24\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2 192.0.2.2/24\n}\n\nunreachable_chain_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress chain 1 protocol ip pref 1 handle 1101 \\\n\t\tflower $tcflags dst_mac $h2mac action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 1101 1\n\tcheck_fail $? \"matched on filter in unreachable chain\"\n\n\ttc filter del dev $h2 ingress chain 1 protocol ip pref 1 handle 1101 \\\n\t\tflower\n\n\tlog_test \"unreachable chain ($tcflags)\"\n}\n\ngact_goto_chain_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress chain 1 protocol ip pref 1 handle 1101 \\\n\t\tflower $tcflags dst_mac $h2mac action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags dst_mac $h2mac action drop\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags dst_mac $h2mac action goto chain 1\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct filter with goto chain action\"\n\n\ttc_check_packets \"dev $h2 ingress\" 1101 1\n\tcheck_err $? \"Did not match on correct filter in chain 1\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress chain 1 protocol ip pref 1 handle 1101 \\\n\t\tflower\n\n\tlog_test \"gact goto chain ($tcflags)\"\n}\n\ncreate_destroy_chain()\n{\n\tRET=0\n\n\ttc chain add dev $h2 ingress\n\tcheck_err $? \"Failed to create default chain\"\n\n\toutput=\"$(tc -j chain get dev $h2 ingress)\"\n\tcheck_err $? \"Failed to get default chain\"\n\n\techo $output | jq -e \".[] | select(.chain == 0)\" &> /dev/null\n\tcheck_err $? \"Unexpected output for default chain\"\n\n\ttc chain add dev $h2 ingress chain 1\n\tcheck_err $? \"Failed to create chain 1\"\n\n\toutput=\"$(tc -j chain get dev $h2 ingress chain 1)\"\n\tcheck_err $? \"Failed to get chain 1\"\n\n\techo $output | jq -e \".[] | select(.chain == 1)\" &> /dev/null\n\tcheck_err $? \"Unexpected output for chain 1\"\n\n\toutput=\"$(tc -j chain show dev $h2 ingress)\"\n\tcheck_err $? \"Failed to dump chains\"\n\n\techo $output | jq -e \".[] | select(.chain == 0)\" &> /dev/null\n\tcheck_err $? \"Can't find default chain in dump\"\n\n\techo $output | jq -e \".[] | select(.chain == 1)\" &> /dev/null\n\tcheck_err $? \"Can't find chain 1 in dump\"\n\n\ttc chain del dev $h2 ingress\n\tcheck_err $? \"Failed to destroy default chain\"\n\n\ttc chain del dev $h2 ingress chain 1\n\tcheck_err $? \"Failed to destroy chain 1\"\n\n\tlog_test \"create destroy chain\"\n}\n\ntemplate_filter_fits()\n{\n\tRET=0\n\n\ttc chain add dev $h2 ingress protocol ip \\\n\t\tflower dst_mac 00:00:00:00:00:00/FF:FF:FF:FF:FF:FF &> /dev/null\n\ttc chain add dev $h2 ingress chain 1 protocol ip \\\n\t\tflower src_mac 00:00:00:00:00:00/FF:FF:FF:FF:FF:FF &> /dev/null\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 1101 \\\n\t\tflower dst_mac $h2mac action drop\n\tcheck_err $? \"Failed to insert filter which fits template\"\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 1102 \\\n\t\tflower src_mac $h2mac action drop &> /dev/null\n\tcheck_fail $? \"Incorrectly succeeded to insert filter which does not template\"\n\n\ttc filter add dev $h2 ingress chain 1 protocol ip pref 1 handle 1101 \\\n\t\tflower src_mac $h2mac action drop\n\tcheck_err $? \"Failed to insert filter which fits template\"\n\n\ttc filter add dev $h2 ingress chain 1 protocol ip pref 1 handle 1102 \\\n\t\tflower dst_mac $h2mac action drop &> /dev/null\n\tcheck_fail $? \"Incorrectly succeeded to insert filter which does not template\"\n\n\ttc filter del dev $h2 ingress chain 1 protocol ip pref 1 handle 1102 \\\n\t\tflower &> /dev/null\n\ttc filter del dev $h2 ingress chain 1 protocol ip pref 1 handle 1101 \\\n\t\tflower &> /dev/null\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 1102 \\\n\t\tflower &> /dev/null\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 1101 \\\n\t\tflower &> /dev/null\n\n\ttc chain del dev $h2 ingress chain 1\n\ttc chain del dev $h2 ingress\n\n\tlog_test \"template filter fits\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\th1mac=$(mac_get $h1)\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ncheck_tc_chain_support\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\ntc_offload_check\nif [[ $? -ne 0 ]]; then\n\tlog_info \"Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttests_run\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}