{
  "module_name": "mirror_gre_vlan_bridge_1q.sh",
  "hash_id": "5f86728e1a59a28fda8f5f518f0528904c06be43dbe5874b024b11e34a35a5c3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_vlan_bridge_1q.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test for \"tc action mirred egress mirror\" when the underlay route points at a\n# vlan device on top of a bridge device with vlan filtering (802.1q).\n#\n#   +---------------------+                             +---------------------+\n#   | H1                  |                             |                  H2 |\n#   |     + $h1           |                             |           $h2 +     |\n#   |     | 192.0.2.1/28  |                             |  192.0.2.2/28 |     |\n#   +-----|---------------+                             +---------------|-----+\n#         |                                                             |\n#   +-----|-------------------------------------------------------------|-----+\n#   | SW  o--> mirred egress mirror dev {gt4,gt6}                       |     |\n#   |     |                                                             |     |\n#   | +---|-------------------------------------------------------------|---+ |\n#   | |   + $swp1                    br1                          $swp2 +   | |\n#   | |                                                                     | |\n#   | |   + $swp3                                                           | |\n#   | +---|-----------------------------------------------------------------+ |\n#   |     |                        |                                          |\n#   |     |                        + br1.555                                  |\n#   |     |                          192.0.2.130/28                           |\n#   |     |                          2001:db8:2::2/64                         |\n#   |     |                                                                   |\n#   |     |                     + gt6 (ip6gretap)      + gt4 (gretap)         |\n#   |     |                     : loc=2001:db8:2::1    : loc=192.0.2.129      |\n#   |     |                     : rem=2001:db8:2::2    : rem=192.0.2.130      |\n#   |     |                     : ttl=100              : ttl=100              |\n#   |     |                     : tos=inherit          : tos=inherit          |\n#   |     |                     :                      :                      |\n#   +-----|---------------------:----------------------:----------------------+\n#         |                     :                      :\n#   +-----|---------------------:----------------------:----------------------+\n#   | H3  + $h3                 + h3-gt6 (ip6gretap)   + h3-gt4 (gretap)      |\n#   |     |                       loc=2001:db8:2::2      loc=192.0.2.130      |\n#   |     + $h3.555               rem=2001:db8:2::1      rem=192.0.2.129      |\n#   |       192.0.2.130/28        ttl=100                ttl=100              |\n#   |       2001:db8:2::2/64      tos=inherit            tos=inherit          |\n#   |                                                                         |\n#   +-------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\ttest_gretap\n\ttest_ip6gretap\n\ttest_gretap_forbidden_cpu\n\ttest_ip6gretap_forbidden_cpu\n\ttest_gretap_forbidden_egress\n\ttest_ip6gretap_forbidden_egress\n\ttest_gretap_untagged_egress\n\ttest_ip6gretap_untagged_egress\n\ttest_gretap_fdb_roaming\n\ttest_ip6gretap_fdb_roaming\n\ttest_gretap_stp\n\ttest_ip6gretap_stp\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\nsource mirror_gre_topo_lib.sh\n\nrequire_command $ARPING\n\nh3_addr_add_del()\n{\n\tlocal add_del=$1; shift\n\tlocal dev=$1; shift\n\n\tip addr $add_del dev $dev 192.0.2.130/28\n\tip addr $add_del dev $dev 2001:db8:2::2/64\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\t# gt4's remote address is at $h3.555, not $h3. Thus the packets arriving\n\t# directly to $h3 for test_gretap_untagged_egress() are rejected by\n\t# rp_filter and the test spuriously fails.\n\tsysctl_set net.ipv4.conf.all.rp_filter 0\n\tsysctl_set net.ipv4.conf.$h3.rp_filter 0\n\n\tvrf_prepare\n\tmirror_gre_topo_create\n\n\tvlan_create br1 555 \"\" 192.0.2.129/32 2001:db8:2::1/128\n\tbridge vlan add dev br1 vid 555 self\n\tip route rep 192.0.2.130/32 dev br1.555\n\tip -6 route rep 2001:db8:2::2/128 dev br1.555\n\n\tvlan_create $h3 555 v$h3\n\th3_addr_add_del add $h3.555\n\n\tip link set dev $swp3 master br1\n\tbridge vlan add dev $swp3 vid 555\n\tbridge vlan add dev $swp2 vid 555\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp3 nomaster\n\n\th3_addr_add_del del $h3.555\n\tvlan_destroy $h3 555\n\tvlan_destroy br1 555\n\n\tmirror_gre_topo_destroy\n\tvrf_cleanup\n\n\tsysctl_restore net.ipv4.conf.$h3.rp_filter\n\tsysctl_restore net.ipv4.conf.all.rp_filter\n}\n\ntest_vlan_match()\n{\n\tlocal tundev=$1; shift\n\tlocal vlan_match=$1; shift\n\tlocal what=$1; shift\n\n\tfull_test_span_gre_dir_vlan $tundev ingress \"$vlan_match\" 8 0 \"$what\"\n\tfull_test_span_gre_dir_vlan $tundev egress \"$vlan_match\" 0 8 \"$what\"\n}\n\ntest_gretap()\n{\n\ttest_vlan_match gt4 'skip_hw vlan_id 555 vlan_ethtype ip' \\\n\t\t\t\"mirror to gretap\"\n}\n\ntest_ip6gretap()\n{\n\ttest_vlan_match gt6 'skip_hw vlan_id 555 vlan_ethtype ipv6' \\\n\t\t\t\"mirror to ip6gretap\"\n}\n\ntest_span_gre_forbidden_cpu()\n{\n\tlocal tundev=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\t# Run the pass-test first, to prime neighbor table.\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\tquick_test_span_gre_dir $tundev ingress\n\n\t# Now forbid the VLAN at the bridge and see it fail.\n\tbridge vlan del dev br1 vid 555 self\n\tsleep 1\n\tfail_test_span_gre_dir $tundev ingress\n\n\tbridge vlan add dev br1 vid 555 self\n\tsleep 1\n\tquick_test_span_gre_dir $tundev ingress\n\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: vlan forbidden at a bridge ($tcflags)\"\n}\n\ntest_gretap_forbidden_cpu()\n{\n\ttest_span_gre_forbidden_cpu gt4 \"mirror to gretap\"\n}\n\ntest_ip6gretap_forbidden_cpu()\n{\n\ttest_span_gre_forbidden_cpu gt6 \"mirror to ip6gretap\"\n}\n\ntest_span_gre_forbidden_egress()\n{\n\tlocal tundev=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\tquick_test_span_gre_dir $tundev ingress\n\n\tbridge vlan del dev $swp3 vid 555\n\tsleep 1\n\tfail_test_span_gre_dir $tundev ingress\n\n\tbridge vlan add dev $swp3 vid 555\n\t# Re-prime FDB\n\t$ARPING -I br1.555 192.0.2.130 -fqc 1\n\tsleep 1\n\tquick_test_span_gre_dir $tundev ingress\n\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: vlan forbidden at a bridge egress ($tcflags)\"\n}\n\ntest_gretap_forbidden_egress()\n{\n\ttest_span_gre_forbidden_egress gt4 \"mirror to gretap\"\n}\n\ntest_ip6gretap_forbidden_egress()\n{\n\ttest_span_gre_forbidden_egress gt6 \"mirror to ip6gretap\"\n}\n\ntest_span_gre_untagged_egress()\n{\n\tlocal tundev=$1; shift\n\tlocal ul_proto=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\n\tquick_test_span_gre_dir $tundev ingress\n\tquick_test_span_vlan_dir $h3 555 ingress \"$ul_proto\"\n\n\th3_addr_add_del del $h3.555\n\tbridge vlan add dev $swp3 vid 555 pvid untagged\n\th3_addr_add_del add $h3\n\tsleep 5\n\n\tquick_test_span_gre_dir $tundev ingress\n\tfail_test_span_vlan_dir $h3 555 ingress \"$ul_proto\"\n\n\th3_addr_add_del del $h3\n\tbridge vlan add dev $swp3 vid 555\n\th3_addr_add_del add $h3.555\n\tsleep 5\n\n\tquick_test_span_gre_dir $tundev ingress\n\tquick_test_span_vlan_dir $h3 555 ingress \"$ul_proto\"\n\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: vlan untagged at a bridge egress ($tcflags)\"\n}\n\ntest_gretap_untagged_egress()\n{\n\ttest_span_gre_untagged_egress gt4 ip \"mirror to gretap\"\n}\n\ntest_ip6gretap_untagged_egress()\n{\n\ttest_span_gre_untagged_egress gt6 ipv6 \"mirror to ip6gretap\"\n}\n\ntest_span_gre_fdb_roaming()\n{\n\tlocal tundev=$1; shift\n\tlocal what=$1; shift\n\tlocal h3mac=$(mac_get $h3)\n\n\tRET=0\n\n\tmirror_install $swp1 ingress $tundev \"matchall $tcflags\"\n\tquick_test_span_gre_dir $tundev ingress\n\n\twhile ((RET == 0)); do\n\t\tbridge fdb del dev $swp3 $h3mac vlan 555 master 2>/dev/null\n\t\tbridge fdb add dev $swp2 $h3mac vlan 555 master static\n\t\tsleep 1\n\t\tfail_test_span_gre_dir $tundev ingress\n\n\t\tif ! bridge fdb sh dev $swp2 vlan 555 master \\\n\t\t    | grep -q $h3mac; then\n\t\t\tprintf \"TEST: %-60s  [RETRY]\\n\" \\\n\t\t\t\t\"$what: MAC roaming ($tcflags)\"\n\t\t\t# ARP or ND probably reprimed the FDB while the test\n\t\t\t# was running. We would get a spurious failure.\n\t\t\tRET=0\n\t\t\tcontinue\n\t\tfi\n\t\tbreak\n\tdone\n\n\tbridge fdb del dev $swp2 $h3mac vlan 555 master 2>/dev/null\n\t# Re-prime FDB\n\t$ARPING -I br1.555 192.0.2.130 -fqc 1\n\tsleep 1\n\tquick_test_span_gre_dir $tundev ingress\n\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"$what: MAC roaming ($tcflags)\"\n}\n\ntest_gretap_fdb_roaming()\n{\n\ttest_span_gre_fdb_roaming gt4 \"mirror to gretap\"\n}\n\ntest_ip6gretap_fdb_roaming()\n{\n\ttest_span_gre_fdb_roaming gt6 \"mirror to ip6gretap\"\n}\n\ntest_gretap_stp()\n{\n\tfull_test_span_gre_stp gt4 $swp3 \"mirror to gretap\"\n}\n\ntest_ip6gretap_stp()\n{\n\tfull_test_span_gre_stp gt6 $swp3 \"mirror to ip6gretap\"\n}\n\ntest_all()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntest_all\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttest_all\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}