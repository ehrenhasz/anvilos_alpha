{
  "module_name": "sch_ets_core.sh",
  "hash_id": "1855e1893523845633c495ee708dcbf4684e228378bdd54f5f7639048f753281",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/sch_ets_core.sh",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n\n# This is a template for ETS Qdisc test.\n#\n# This test sends from H1 several traffic streams with 802.1p-tagged packets.\n# The tags are used at $swp1 to prioritize the traffic. Each stream is then\n# queued at a different ETS band according to the assigned priority. After\n# runnig for a while, counters at H2 are consulted to determine whether the\n# traffic scheduling was according to the ETS configuration.\n#\n# This template is supposed to be embedded by a test driver, which implements\n# statistics collection, any HW-specific stuff, and prominently configures the\n# system to assure that there is overcommitment at $swp2. That is necessary so\n# that the ETS traffic selection algorithm kicks in and has to schedule some\n# traffic at the expense of other.\n#\n# A driver for veth-based testing is in sch_ets.sh, an example of a driver for\n# an offloaded data path is in selftests/drivers/net/mlxsw/sch_ets.sh.\n#\n# +---------------------------------------------------------------------+\n# | H1                                                                  |\n# |     + $h1.10              + $h1.11              + $h1.12            |\n# |     | 192.0.2.1/28        | 192.0.2.17/28       | 192.0.2.33/28     |\n# |     | egress-qos-map      | egress-qos-map      | egress-qos-map    |\n# |     |  0:0                |  0:1                |  0:2              |\n# |     \\____________________ | ____________________/                   |\n# |                          \\|/                                        |\n# |                           + $h1                                     |\n# +---------------------------|-----------------------------------------+\n#                             |\n# +---------------------------|-----------------------------------------+\n# | SW                        + $swp1                                   |\n# |                           | >1Gbps                                  |\n# |      ____________________/|\\____________________                    |\n# |     /                     |                     \\                   |\n# |  +--|----------------+ +--|----------------+ +--|----------------+  |\n# |  |  + $swp1.10       | |  + $swp1.11       | |  + $swp1.12       |  |\n# |  |    ingress-qos-map| |    ingress-qos-map| |    ingress-qos-map|  |\n# |  |     0:0 1:1 2:2   | |     0:0 1:1 2:2   | |     0:0 1:1 2:2   |  |\n# |  |                   | |                   | |                   |  |\n# |  |    BR10           | |    BR11           | |    BR12           |  |\n# |  |                   | |                   | |                   |  |\n# |  |  + $swp2.10       | |  + $swp2.11       | |  + $swp2.12       |  |\n# |  +--|----------------+ +--|----------------+ +--|----------------+  |\n# |     \\____________________ | ____________________/                   |\n# |                          \\|/                                        |\n# |                           + $swp2                                   |\n# |                           | 1Gbps (ethtool or HTB qdisc)            |\n# |                           | qdisc ets quanta $W0 $W1 $W2            |\n# |                           |           priomap 0 1 2                 |\n# +---------------------------|-----------------------------------------+\n#                             |\n# +---------------------------|-----------------------------------------+\n# | H2                        + $h2                                     |\n# |      ____________________/|\\____________________                    |\n# |     /                     |                     \\                   |\n# |     + $h2.10              + $h2.11              + $h2.12            |\n# |       192.0.2.2/28          192.0.2.18/28         192.0.2.34/28     |\n# +---------------------------------------------------------------------+\n\nNUM_NETIFS=4\nCHECK_TC=yes\nsource $lib_dir/lib.sh\nsource $lib_dir/sch_ets_tests.sh\n\nPARENT=root\nQDISC_DEV=\n\nsip()\n{\n\techo 192.0.2.$((16 * $1 + 1))\n}\n\ndip()\n{\n\techo 192.0.2.$((16 * $1 + 2))\n}\n\n# Callback from sch_ets_tests.sh\nets_start_traffic()\n{\n\tlocal dst_mac=$(mac_get $h2)\n\tlocal i=$1; shift\n\n\tstart_traffic $h1.1$i $(sip $i) $(dip $i) $dst_mac\n}\n\nETS_CHANGE_QDISC=\n\npriomap_mode()\n{\n\techo \"Running in priomap mode\"\n\tets_delete_qdisc\n\tETS_CHANGE_QDISC=ets_change_qdisc_priomap\n}\n\nclassifier_mode()\n{\n\techo \"Running in classifier mode\"\n\tets_delete_qdisc\n\tETS_CHANGE_QDISC=ets_change_qdisc_classifier\n}\n\nets_change_qdisc_priomap()\n{\n\tlocal dev=$1; shift\n\tlocal nstrict=$1; shift\n\tlocal priomap=$1; shift\n\tlocal quanta=(\"${@}\")\n\n\tlocal op=$(if [[ -n $QDISC_DEV ]]; then echo change; else echo add; fi)\n\n\ttc qdisc $op dev $dev $PARENT handle 10: ets\t\t\t       \\\n\t\t$(if ((nstrict)); then echo strict $nstrict; fi)\t       \\\n\t\t$(if ((${#quanta[@]})); then echo quanta ${quanta[@]}; fi)     \\\n\t\tpriomap $priomap\n\tQDISC_DEV=$dev\n}\n\nets_change_qdisc_classifier()\n{\n\tlocal dev=$1; shift\n\tlocal nstrict=$1; shift\n\tlocal priomap=$1; shift\n\tlocal quanta=(\"${@}\")\n\n\tlocal op=$(if [[ -n $QDISC_DEV ]]; then echo change; else echo add; fi)\n\n\ttc qdisc $op dev $dev $PARENT handle 10: ets\t\t\t       \\\n\t\t$(if ((nstrict)); then echo strict $nstrict; fi)\t       \\\n\t\t$(if ((${#quanta[@]})); then echo quanta ${quanta[@]}; fi)\n\n\tif [[ $op == add ]]; then\n\t\tlocal prio=0\n\t\tlocal band\n\n\t\tfor band in $priomap; do\n\t\t\ttc filter add dev $dev parent 10: basic \\\n\t\t\t\tmatch \"meta(priority eq $prio)\" \\\n\t\t\t\tflowid 10:$((band + 1))\n\t\t\t((prio++))\n\t\tdone\n\tfi\n\tQDISC_DEV=$dev\n}\n\n# Callback from sch_ets_tests.sh\nets_change_qdisc()\n{\n\tif [[ -z \"$ETS_CHANGE_QDISC\" ]]; then\n\t\texit 1\n\tfi\n\t$ETS_CHANGE_QDISC \"$@\"\n}\n\nets_delete_qdisc()\n{\n\tif [[ -n $QDISC_DEV ]]; then\n\t\ttc qdisc del dev $QDISC_DEV $PARENT\n\t\tQDISC_DEV=\n\tfi\n}\n\nh1_create()\n{\n\tlocal i;\n\n\tsimple_if_init $h1\n\tmtu_set $h1 9900\n\tfor i in {0..2}; do\n\t\tvlan_create $h1 1$i v$h1 $(sip $i)/28\n\t\tip link set dev $h1.1$i type vlan egress 0:$i\n\tdone\n}\n\nh1_destroy()\n{\n\tlocal i\n\n\tfor i in {0..2}; do\n\t\tvlan_destroy $h1 1$i\n\tdone\n\tmtu_restore $h1\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tlocal i\n\n\tsimple_if_init $h2\n\tmtu_set $h2 9900\n\tfor i in {0..2}; do\n\t\tvlan_create $h2 1$i v$h2 $(dip $i)/28\n\tdone\n}\n\nh2_destroy()\n{\n\tlocal i\n\n\tfor i in {0..2}; do\n\t\tvlan_destroy $h2 1$i\n\tdone\n\tmtu_restore $h2\n\tsimple_if_fini $h2\n}\n\nets_switch_create()\n{\n\tlocal i\n\n\tip link set dev $swp1 up\n\tmtu_set $swp1 9900\n\n\tip link set dev $swp2 up\n\tmtu_set $swp2 9900\n\n\tfor i in {0..2}; do\n\t\tvlan_create $swp1 1$i\n\t\tip link set dev $swp1.1$i type vlan ingress 0:0 1:1 2:2\n\n\t\tvlan_create $swp2 1$i\n\n\t\tip link add dev br1$i type bridge\n\t\tip link set dev $swp1.1$i master br1$i\n\t\tip link set dev $swp2.1$i master br1$i\n\n\t\tip link set dev br1$i up\n\t\tip link set dev $swp1.1$i up\n\t\tip link set dev $swp2.1$i up\n\tdone\n}\n\nets_switch_destroy()\n{\n\tlocal i\n\n\tets_delete_qdisc\n\n\tfor i in {0..2}; do\n\t\tip link del dev br1$i\n\t\tvlan_destroy $swp2 1$i\n\t\tvlan_destroy $swp1 1$i\n\tdone\n\n\tmtu_restore $swp2\n\tip link set dev $swp2 down\n\n\tmtu_restore $swp1\n\tip link set dev $swp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tput=$swp2\n\thut=$h2\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1.10 $(dip 0) \" vlan 10\"\n\tping_test $h1.11 $(dip 1) \" vlan 11\"\n\tping_test $h1.12 $(dip 2) \" vlan 12\"\n}\n\nets_run()\n{\n\ttrap cleanup EXIT\n\n\tsetup_prepare\n\tsetup_wait\n\n\ttests_run\n\n\texit $EXIT_STATUS\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}