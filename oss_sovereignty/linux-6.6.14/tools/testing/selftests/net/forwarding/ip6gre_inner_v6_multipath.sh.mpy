{
  "module_name": "ip6gre_inner_v6_multipath.sh",
  "hash_id": "7e4c599e6b7afc60d8e2a5cb96681cc451daf5f5438dccb23a3bf76db12594b7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/ip6gre_inner_v6_multipath.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test traffic distribution when there are multiple routes between an IPv6\n# GRE tunnel. The tunnel carries IPv6 traffic between multiple hosts.\n# Multiple routes are in the underlay network. With the default multipath\n# policy, SW2 will only look at the outer IP addresses, hence only a single\n# route would be used.\n#\n# +-------------------------+\n# | H1                      |\n# |               $h1 +     |\n# |  2001:db8:1::2/64 |     |\n# +-------------------|-----+\n#                     |\n# +-------------------|-------------------------+\n# | SW1               |                         |\n# |              $ol1 +                         |\n# |  2001:db8:1::1/64                           |\n# |                                             |\n# |  + g1 (gre)                                 |\n# |    loc=2001:db8:40::1                       |\n# |    rem=2001:db8:40::2 --.                   |\n# |    tos=inherit          |                   |\n# |                         v                   |\n# |                         + $ul1              |\n# |                         | 2001:db8:80::1/64 |\n# +-------------------------|-------------------+\n#                           |\n# +-------------------------|-------------------+\n# | SW2                     |                   |\n# |                   $ul21 +                   |\n# |       2001:db8:80::2/64                     |\n# |                   |                         |\n# !   ________________|_____                    |\n# |  /                      \\                   |\n# |  |                      |                   |\n# |  + $ul22.111 (vlan)     + $ul22.222 (vlan)  |\n# |  | 2001:db8:81::1/64    | 2001:db8:82::1/64 |\n# |  |                      |                   |\n# +--|----------------------|-------------------+\n#    |                      |\n# +--|----------------------|-------------------+\n# |  |                      |                   |\n# |  + $ul32.111 (vlan)     + $ul32.222 (vlan)  |\n# |  | 2001:db8:81::2/64    | 2001:db8:82::2/64 |\n# |  |                      |                   |\n# |  \\______________________/                   |\n# |                   |                         |\n# |                   |                         |\n# |                   $ul31 +                   |\n# |       2001:db8:83::2/64 |               SW3 |\n# +-------------------------|-------------------+\n#                           |\n# +-------------------------|-------------------+\n# |                         + $ul4              |\n# |                         ^ 2001:db8:83::1/64 |\n# |  + g2 (gre)             |                   |\n# |    loc=2001:db8:40::2   |                   |\n# |    rem=2001:db8:40::1 --'                   |\n# |    tos=inherit                              |\n# |                                             |\n# |               $ol4 +                        |\n# |   2001:db8:2::1/64 |                    SW4 |\n# +--------------------|------------------------+\n#                      |\n# +--------------------|---------+\n# |                    |         |\n# |                $h2 +         |\n# |   2001:db8:2::2/64        H2 |\n# +------------------------------+\n\nALL_TESTS=\"\n\tping_ipv6\n\tmultipath_ipv6\n\"\n\nNUM_NETIFS=10\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 2001:db8:1::2/64\n\tip -6 route add vrf v$h1 2001:db8:2::/64 via 2001:db8:1::1\n}\n\nh1_destroy()\n{\n\tip -6 route del vrf v$h1 2001:db8:2::/64 via 2001:db8:1::1\n\tsimple_if_fini $h1 2001:db8:1::2/64\n}\n\nsw1_create()\n{\n\tsimple_if_init $ol1 2001:db8:1::1/64\n\t__simple_if_init $ul1 v$ol1 2001:db8:80::1/64\n\n\ttunnel_create g1 ip6gre 2001:db8:40::1 2001:db8:40::2 tos inherit dev v$ol1\n\t__simple_if_init g1 v$ol1 2001:db8:40::1/128\n\tip -6 route add vrf v$ol1 2001:db8:40::2/128 via 2001:db8:80::2\n\n\tip -6 route add vrf v$ol1 2001:db8:2::/64 dev g1\n}\n\nsw1_destroy()\n{\n\tip -6 route del vrf v$ol1 2001:db8:2::/64\n\n\tip -6 route del vrf v$ol1 2001:db8:40::2/128\n\t__simple_if_fini g1 2001:db8:40::1/128\n\ttunnel_destroy g1\n\n\t__simple_if_fini $ul1 2001:db8:80::1/64\n\tsimple_if_fini $ol1 2001:db8:1::1/64\n}\n\nsw2_create()\n{\n\tsimple_if_init $ul21 2001:db8:80::2/64\n\t__simple_if_init $ul22 v$ul21\n\tvlan_create $ul22 111 v$ul21 2001:db8:81::1/64\n\tvlan_create $ul22 222 v$ul21 2001:db8:82::1/64\n\n\tip -6 route add vrf v$ul21 2001:db8:40::1/128 via 2001:db8:80::1\n\tip -6 route add vrf v$ul21 2001:db8:40::2/128 \\\n\t   nexthop via 2001:db8:81::2 \\\n\t   nexthop via 2001:db8:82::2\n}\n\nsw2_destroy()\n{\n\tip -6 route del vrf v$ul21 2001:db8:40::2/128\n\tip -6 route del vrf v$ul21 2001:db8:40::1/128\n\n\tvlan_destroy $ul22 222\n\tvlan_destroy $ul22 111\n\t__simple_if_fini $ul22\n\tsimple_if_fini $ul21 2001:db8:80::2/64\n}\n\nsw3_create()\n{\n\tsimple_if_init $ul31 2001:db8:83::2/64\n\t__simple_if_init $ul32 v$ul31\n\tvlan_create $ul32 111 v$ul31 2001:db8:81::2/64\n\tvlan_create $ul32 222 v$ul31 2001:db8:82::2/64\n\n\tip -6 route add vrf v$ul31 2001:db8:40::2/128 via 2001:db8:83::1\n\tip -6 route add vrf v$ul31 2001:db8:40::1/128 \\\n\t   nexthop via 2001:db8:81::1 \\\n\t   nexthop via 2001:db8:82::1\n\n\ttc qdisc add dev $ul32 clsact\n\ttc filter add dev $ul32 ingress pref 111 prot 802.1Q \\\n\t   flower vlan_id 111 action pass\n\ttc filter add dev $ul32 ingress pref 222 prot 802.1Q \\\n\t   flower vlan_id 222 action pass\n}\n\nsw3_destroy()\n{\n\ttc qdisc del dev $ul32 clsact\n\n\tip -6 route del vrf v$ul31 2001:db8:40::1/128\n\tip -6 route del vrf v$ul31 2001:db8:40::2/128\n\n\tvlan_destroy $ul32 222\n\tvlan_destroy $ul32 111\n\t__simple_if_fini $ul32\n\tsimple_if_fini $ul31 2001:Db8:83::2/64\n}\n\nsw4_create()\n{\n\tsimple_if_init $ol4 2001:db8:2::1/64\n\t__simple_if_init $ul4 v$ol4 2001:db8:83::1/64\n\n\ttunnel_create g2 ip6gre 2001:db8:40::2 2001:db8:40::1 tos inherit dev v$ol4\n\t__simple_if_init g2 v$ol4 2001:db8:40::2/128\n\tip -6 route add vrf v$ol4 2001:db8:40::1/128 via 2001:db8:83::2\n\n\tip -6 route add vrf v$ol4 2001:db8:1::/64 dev g2\n}\n\nsw4_destroy()\n{\n\tip -6 route del vrf v$ol4 2001:db8:1::/64\n\n\tip -6 route del vrf v$ol4 2001:db8:40::1/128\n\t__simple_if_fini g2 2001:db8:40::2/128\n\ttunnel_destroy g2\n\n\t__simple_if_fini $ul4 2001:db8:83::1/64\n\tsimple_if_fini $ol4 2001:db8:2::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 2001:db8:2::2/64\n\tip -6 route add vrf v$h2 2001:db8:1::/64 via 2001:db8:2::1\n}\n\nh2_destroy()\n{\n\tip -6 route del vrf v$h2 2001:db8:1::/64 via 2001:db8:2::1\n\tsimple_if_fini $h2 2001:db8:2::2/64\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\n\tol1=${NETIFS[p2]}\n\tul1=${NETIFS[p3]}\n\n\tul21=${NETIFS[p4]}\n\tul22=${NETIFS[p5]}\n\n\tul32=${NETIFS[p6]}\n\tul31=${NETIFS[p7]}\n\n\tul4=${NETIFS[p8]}\n\tol4=${NETIFS[p9]}\n\n\th2=${NETIFS[p10]}\n\n\tvrf_prepare\n\th1_create\n\tsw1_create\n\tsw2_create\n\tsw3_create\n\tsw4_create\n\th2_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\th2_destroy\n\tsw4_destroy\n\tsw3_destroy\n\tsw2_destroy\n\tsw1_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nmultipath6_test()\n{\n\tlocal what=$1; shift\n\tlocal weight1=$1; shift\n\tlocal weight2=$1; shift\n\n\tsysctl_set net.ipv6.fib_multipath_hash_policy 2\n\tip route replace vrf v$ul21 2001:db8:40::2/128 \\\n\t   nexthop via 2001:db8:81::2 weight $weight1 \\\n\t   nexthop via 2001:db8:82::2 weight $weight2\n\n\tlocal t0_111=$(tc_rule_stats_get $ul32 111 ingress)\n\tlocal t0_222=$(tc_rule_stats_get $ul32 222 ingress)\n\n\tip vrf exec v$h1 \\\n\t   $MZ $h1 -6 -q -p 64 -A \"2001:db8:1::2-2001:db8:1::1e\" \\\n\t       -B \"2001:db8:2::2-2001:db8:2::1e\" \\\n\t       -d 1msec -c 50 -t udp \"sp=1024,dp=1024\"\n\tsleep 1\n\n\tlocal t1_111=$(tc_rule_stats_get $ul32 111 ingress)\n\tlocal t1_222=$(tc_rule_stats_get $ul32 222 ingress)\n\n\tlocal d111=$((t1_111 - t0_111))\n\tlocal d222=$((t1_222 - t0_222))\n\tmultipath_eval \"$what\" $weight1 $weight2 $d111 $d222\n\n\tip route replace vrf v$ul21 2001:db8:40::2/128 \\\n\t   nexthop via 2001:db8:81::2 \\\n\t   nexthop via 2001:db8:82::2\n\tsysctl_restore net.ipv6.fib_multipath_hash_policy\n}\n\nping_ipv6()\n{\n\tping_test $h1 2001:db8:2::2\n}\n\nmultipath_ipv6()\n{\n\tlog_info \"Running IPv6 over GRE over IPv6 multipath tests\"\n\tmultipath6_test \"ECMP\" 1 1\n\tmultipath6_test \"Weighted MP 2:1\" 2 1\n\tmultipath6_test \"Weighted MP 11:45\" 11 45\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}