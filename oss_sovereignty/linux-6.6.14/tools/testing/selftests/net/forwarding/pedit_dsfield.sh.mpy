{
  "module_name": "pedit_dsfield.sh",
  "hash_id": "41e6e723e6eeb1d798792013b254d30e235a5b2bd9f4ab602c67272849a86c3f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/pedit_dsfield.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test sends traffic from H1 to H2. Either on ingress of $swp1, or on\n# egress of $swp2, the traffic is acted upon by a pedit action. An ingress\n# filter installed on $h2 verifies that the packet looks like expected.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |    + $h1             |                             |            $h2 +     |\n# |    | 192.0.2.1/28    |                             |   192.0.2.2/28 |     |\n# +----|-----------------+                             +----------------|-----+\n#      |                                                                |\n# +----|----------------------------------------------------------------|-----+\n# | SW |                                                                |     |\n# |  +-|----------------------------------------------------------------|-+   |\n# |  | + $swp1                       BR                           $swp2 + |   |\n# |  +--------------------------------------------------------------------+   |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\ttest_ip_dsfield\n\ttest_ip_dscp\n\ttest_ip_ecn\n\ttest_ip_dscp_ecn\n\ttest_ip6_dsfield\n\ttest_ip6_dscp\n\ttest_ip6_ecn\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\n: ${HIT_TIMEOUT:=2000} # ms\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28 2001:db8:1::2/64\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp1 clsact\n\ttc qdisc add dev $swp2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:1::2\n}\n\ndo_test_pedit_dsfield_common()\n{\n\tlocal pedit_locus=$1; shift\n\tlocal pedit_action=$1; shift\n\tlocal mz_flags=$1; shift\n\n\tRET=0\n\n\t# TOS 125: DSCP 31, ECN 1. Used for testing that the relevant part is\n\t# overwritten when zero is selected.\n\t$MZ $mz_flags $h1 -c 10 -d 20msec -p 100 \\\n\t    -a own -b $h2mac -q -t tcp tos=0x7d,sp=54321,dp=12345\n\n\tlocal pkts\n\tpkts=$(busywait \"$TC_HIT_TIMEOUT\" until_counter_is \">= 10\" \\\n\t\t\ttc_rule_handle_stats_get \"dev $h2 ingress\" 101)\n\tcheck_err $? \"Expected to get 10 packets on test probe, but got $pkts.\"\n\n\tpkts=$(tc_rule_handle_stats_get \"$pedit_locus\" 101)\n\t((pkts >= 10))\n\tcheck_err $? \"Expected to get 10 packets on pedit rule, but got $pkts.\"\n\n\tlog_test \"$pedit_locus pedit $pedit_action\"\n}\n\ndo_test_pedit_dsfield()\n{\n\tlocal pedit_locus=$1; shift\n\tlocal pedit_action=$1; shift\n\tlocal match_prot=$1; shift\n\tlocal match_flower=$1; shift\n\tlocal mz_flags=$1; shift\n\tlocal saddr=$1; shift\n\tlocal daddr=$1; shift\n\n\ttc filter add $pedit_locus handle 101 pref 1 \\\n\t   flower action pedit ex munge $pedit_action\n\ttc filter add dev $h2 ingress handle 101 pref 1 prot $match_prot \\\n\t   flower skip_hw $match_flower action pass\n\n\tdo_test_pedit_dsfield_common \"$pedit_locus\" \"$pedit_action\" \"$mz_flags\"\n\n\ttc filter del dev $h2 ingress pref 1\n\ttc filter del $pedit_locus pref 1\n}\n\ndo_test_ip_dsfield()\n{\n\tlocal locus=$1; shift\n\tlocal dsfield\n\n\tfor dsfield in 0 1 2 3 128 252 253 254 255; do\n\t\tdo_test_pedit_dsfield \"$locus\"\t\t\t\t\\\n\t\t\t\t      \"ip dsfield set $dsfield\"\t\t\\\n\t\t\t\t      ip \"ip_tos $dsfield\"\t\t\\\n\t\t\t\t      \"-A 192.0.2.1 -B 192.0.2.2\"\n\tdone\n}\n\ntest_ip_dsfield()\n{\n\tdo_test_ip_dsfield \"dev $swp1 ingress\"\n\tdo_test_ip_dsfield \"dev $swp2 egress\"\n}\n\ndo_test_ip_dscp()\n{\n\tlocal locus=$1; shift\n\tlocal dscp\n\n\tfor dscp in 0 1 2 3 32 61 62 63; do\n\t\tdo_test_pedit_dsfield \"$locus\"\t\t\t\t       \\\n\t\t\t\t  \"ip dsfield set $((dscp << 2)) retain 0xfc\"  \\\n\t\t\t\t  ip \"ip_tos $(((dscp << 2) | 1))\"\t       \\\n\t\t\t\t  \"-A 192.0.2.1 -B 192.0.2.2\"\n\tdone\n}\n\ntest_ip_dscp()\n{\n\tdo_test_ip_dscp \"dev $swp1 ingress\"\n\tdo_test_ip_dscp \"dev $swp2 egress\"\n}\n\ndo_test_ip_ecn()\n{\n\tlocal locus=$1; shift\n\tlocal ecn\n\n\tfor ecn in 0 1 2 3; do\n\t\tdo_test_pedit_dsfield \"$locus\"\t\t\t\t\\\n\t\t\t\t      \"ip dsfield set $ecn retain 0x03\"\t\\\n\t\t\t\t      ip \"ip_tos $((124 | $ecn))\"\t\\\n\t\t\t\t      \"-A 192.0.2.1 -B 192.0.2.2\"\n\tdone\n}\n\ntest_ip_ecn()\n{\n\tdo_test_ip_ecn \"dev $swp1 ingress\"\n\tdo_test_ip_ecn \"dev $swp2 egress\"\n}\n\ndo_test_ip_dscp_ecn()\n{\n\tlocal locus=$1; shift\n\n\ttc filter add $locus handle 101 pref 1\t\t\t\t\\\n\t   flower action pedit ex munge ip dsfield set 124 retain 0xfc\t\\\n\t\t  action pedit ex munge ip dsfield set 1 retain 0x03\n\ttc filter add dev $h2 ingress handle 101 pref 1 prot ip\t\t\\\n\t   flower skip_hw ip_tos 125 action pass\n\n\tdo_test_pedit_dsfield_common \"$locus\" \"set DSCP + set ECN\"\t\\\n\t\t\t\t      \"-A 192.0.2.1 -B 192.0.2.2\"\n\n\ttc filter del dev $h2 ingress pref 1\n\ttc filter del $locus pref 1\n}\n\ntest_ip_dscp_ecn()\n{\n\tdo_test_ip_dscp_ecn \"dev $swp1 ingress\"\n\tdo_test_ip_dscp_ecn \"dev $swp2 egress\"\n}\n\ndo_test_ip6_dsfield()\n{\n\tlocal locus=$1; shift\n\tlocal dsfield\n\n\tfor dsfield in 0 1 2 3 128 252 253 254 255; do\n\t\tdo_test_pedit_dsfield \"$locus\"\t\t\t\t\\\n\t\t\t\t  \"ip6 traffic_class set $dsfield\"\t\\\n\t\t\t\t  ipv6 \"ip_tos $dsfield\"\t\t\\\n\t\t\t\t  \"-6 -A 2001:db8:1::1 -B 2001:db8:1::2\"\n\tdone\n}\n\ntest_ip6_dsfield()\n{\n\tdo_test_ip6_dsfield \"dev $swp1 ingress\"\n\tdo_test_ip6_dsfield \"dev $swp2 egress\"\n}\n\ndo_test_ip6_dscp()\n{\n\tlocal locus=$1; shift\n\tlocal dscp\n\n\tfor dscp in 0 1 2 3 32 61 62 63; do\n\t\tdo_test_pedit_dsfield \"$locus\"\t\t\t\t       \\\n\t\t\t    \"ip6 traffic_class set $((dscp << 2)) retain 0xfc\" \\\n\t\t\t    ipv6 \"ip_tos $(((dscp << 2) | 1))\"\t\t       \\\n\t\t\t    \"-6 -A 2001:db8:1::1 -B 2001:db8:1::2\"\n\tdone\n}\n\ntest_ip6_dscp()\n{\n\tdo_test_ip6_dscp \"dev $swp1 ingress\"\n\tdo_test_ip6_dscp \"dev $swp2 egress\"\n}\n\ndo_test_ip6_ecn()\n{\n\tlocal locus=$1; shift\n\tlocal ecn\n\n\tfor ecn in 0 1 2 3; do\n\t\tdo_test_pedit_dsfield \"$locus\"\t\t\t\t\\\n\t\t\t\t\"ip6 traffic_class set $ecn retain 0x3\"\t\\\n\t\t\t\tipv6 \"ip_tos $((124 | $ecn))\"\t\t\\\n\t\t\t\t\"-6 -A 2001:db8:1::1 -B 2001:db8:1::2\"\n\tdone\n}\n\ntest_ip6_ecn()\n{\n\tdo_test_ip6_ecn \"dev $swp1 ingress\"\n\tdo_test_ip6_ecn \"dev $swp2 egress\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}