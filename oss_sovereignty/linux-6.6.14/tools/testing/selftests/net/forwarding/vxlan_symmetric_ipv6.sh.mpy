{
  "module_name": "vxlan_symmetric_ipv6.sh",
  "hash_id": "3947014e802366abb0e99101f70c2e0dd40e678c416244af7aa5012144f46c12",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/vxlan_symmetric_ipv6.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n\n# +--------------------------------+            +-----------------------------+\n# |                         vrf-h1 |            |                      vrf-h2 |\n# |    + $h1                       |            | + $h2                       |\n# |    | 2001:db8:1::1/64          |            | | 2001:db8:2::1/64          |\n# |    | default via 2001:db8:1::3 |            | | default via 2001:db8:2::3 |\n# +----|---------------------------+            +-|---------------------------+\n#      |                                          |\n# +----|------------------------------------------|---------------------------+\n# | SW |                                          |                           |\n# | +--|------------------------------------------|-------------------------+ |\n# | |  + $swp1                         br1          + $swp2                 | |\n# | |     vid 10 pvid untagged                         vid 20 pvid untagged | |\n# | |                                                                       | |\n# | |  + vx10                                       + vx20                  | |\n# | |    local 2001:db8:3::1                          local 2001:db8:3::1   | |\n# | |    remote 2001:db8:3::2                         remote 2001:db8:3::2  | |\n# | |    id 1010                                      id 1020               | |\n# | |    dstport 4789                                 dstport 4789          | |\n# | |    vid 10 pvid untagged                         vid 20 pvid untagged  | |\n# | |                                                                       | |\n# | |                             + vx4001                                  | |\n# | |                               local 2001:db8:3::1                     | |\n# | |                               remote 2001:db8:3::2                    | |\n# | |                               id 104001                               | |\n# | |                               dstport 4789                            | |\n# | |                               vid 4001 pvid untagged                  | |\n# | |                                                                       | |\n# | +-----------------------------------+-----------------------------------+ |\n# |                                     |                                     |\n# | +-----------------------------------|-----------------------------------+ |\n# | |                                   |                                   | |\n# | |  +--------------------------------+--------------------------------+  | |\n# | |  |                                |                                |  | |\n# | |  + vlan10                         |                         vlan20 +  | |\n# | |  | 2001:db8:1::2/64               |               2001:db8:2::2/64 |  | |\n# | |  |                                |                                |  | |\n# | |  + vlan10-v (macvlan)             +             vlan20-v (macvlan) +  | |\n# | |    2001:db8:1::3/64           vlan4001            2001:db8:2::3/64    | |\n# | |    00:00:5e:00:01:01                             00:00:5e:00:01:01    | |\n# | |                               vrf-green                               | |\n# | +-----------------------------------------------------------------------+ |\n# |                                                                           |\n# |    + $rp1                                       +lo                       |\n# |    | 2001:db8:4::1/64                           2001:db8:3::1             |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                            vrf-spine                   |\n# |    + $rp2                                                   |\n# |      2001:db8:4::2/64                                       |\n# |                                                             |   (maybe) HW\n# =============================================================================\n# |                                                             |  (likely) SW\n# |                                                             |\n# |    + v1 (veth)                                              |\n# |    | 2001:db8:5::2/64                                       |\n# +----|--------------------------------------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# |    + v2 (veth)                                  +lo           NS1 (netns) |\n# |      2001:db8:5::1/64                            2001:db8:3::2/128        |\n# |                                                                           |\n# | +-----------------------------------------------------------------------+ |\n# | |                               vrf-green                               | |\n# | |  + vlan10-v (macvlan)                           vlan20-v (macvlan) +  | |\n# | |  | 2001:db8:1::3/64                               2001:db8:2::3/64 |  | |\n# | |  | 00:00:5e:00:01:01                             00:00:5e:00:01:01 |  | |\n# | |  |                            vlan4001                             |  | |\n# | |  + vlan10                         +                         vlan20 +  | |\n# | |  | 2001:db8:1::3/64               |               2001:db8:2::3/64 |  | |\n# | |  |                                |                                |  | |\n# | |  +--------------------------------+--------------------------------+  | |\n# | |                                   |                                   | |\n# | +-----------------------------------|-----------------------------------+ |\n# |                                     |                                     |\n# | +-----------------------------------+-----------------------------------+ |\n# | |                                                                       | |\n# | |  + vx10                                     + vx20                    | |\n# | |    local 2001:db8:3::2                        local 2001:db8:3::2     | |\n# | |    remote 2001:db8:3::1                       remote 2001:db8:3::1    | |\n# | |    id 1010                                    id 1020                 | |\n# | |    dstport 4789                               dstport 4789            | |\n# | |    vid 10 pvid untagged                       vid 20 pvid untagged    | |\n# | |                                                                       | |\n# | |                             + vx4001                                  | |\n# | |                               local 2001:db8:3::2                     | |\n# | |                               remote 2001:db8:3::1                    | |\n# | |                               id 104001                               | |\n# | |                               dstport 4789                            | |\n# | |                               vid 4001 pvid untagged                  | |\n# | |                                                                       | |\n# | |  + w1 (veth)                                + w3 (veth)               | |\n# | |  | vid 10 pvid untagged          br1        | vid 20 pvid untagged    | |\n# | +--|------------------------------------------|-------------------------+ |\n# |    |                                          |                           |\n# |    |                                          |                           |\n# | +--|----------------------+                +--|-------------------------+ |\n# | |  |               vrf-h1 |                |  |                  vrf-h2 | |\n# | |  + w2 (veth)            |                |  + w4 (veth)               | |\n# | |    2001:db8:1::4/64     |                |    2001:db8:2::4/64        | |\n# | |    default via          |                |    default via             | |\n# | |    2001:db8:1::3/64     |                |    2001:db8:2::3/64        | |\n# | +-------------------------+                +----------------------------+ |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv6\n\"\nNUM_NETIFS=6\nsource lib.sh\n\nhx_create()\n{\n\tlocal vrf_name=$1; shift\n\tlocal if_name=$1; shift\n\tlocal ip_addr=$1; shift\n\tlocal gw_ip=$1; shift\n\n\tvrf_create $vrf_name\n\tip link set dev $if_name master $vrf_name\n\tip link set dev $vrf_name up\n\tip link set dev $if_name up\n\n\tip address add $ip_addr/64 dev $if_name\n\tip neigh replace $gw_ip lladdr 00:00:5e:00:01:01 nud permanent \\\n\t\tdev $if_name\n\tip route add default vrf $vrf_name nexthop via $gw_ip\n}\nexport -f hx_create\n\nhx_destroy()\n{\n\tlocal vrf_name=$1; shift\n\tlocal if_name=$1; shift\n\tlocal ip_addr=$1; shift\n\tlocal gw_ip=$1; shift\n\n\tip route del default vrf $vrf_name nexthop via $gw_ip\n\tip neigh del $gw_ip dev $if_name\n\tip address del $ip_addr/64 dev $if_name\n\n\tip link set dev $if_name down\n\tvrf_destroy $vrf_name\n}\n\nh1_create()\n{\n\thx_create \"vrf-h1\" $h1 2001:db8:1::1 2001:db8:1::3\n}\n\nh1_destroy()\n{\n\thx_destroy \"vrf-h1\" $h1 2001:db8:1::1 2001:db8:1::3\n}\n\nh2_create()\n{\n\thx_create \"vrf-h2\" $h2 2001:db8:2::1 2001:db8:2::3\n}\n\nh2_destroy()\n{\n\thx_destroy \"vrf-h2\" $h2 2001:db8:2::1 2001:db8:2::3\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 0\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\tip link set dev $rp1 up\n\tip address add dev $rp1 2001:db8:4::1/64\n\tip route add 2001:db8:3::2/128 nexthop via 2001:db8:4::2\n\n\tip link add name vx10 type vxlan id 1010\t\t\\\n\t\tlocal 2001:db8:3::1 remote 2001:db8:3::2 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx10 up\n\n\tip link set dev vx10 master br1\n\tbridge vlan add vid 10 dev vx10 pvid untagged\n\n\tip link add name vx20 type vxlan id 1020\t\t\\\n\t\tlocal 2001:db8:3::1 remote 2001:db8:3::2 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx20 up\n\n\tip link set dev vx20 master br1\n\tbridge vlan add vid 20 dev vx20 pvid untagged\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\tip link add name vx4001 type vxlan id 104001\t\t\\\n\t\tlocal 2001:db8:3::1 dstport 4789\t\t\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx4001 up\n\n\tip link set dev vx4001 master br1\n\tbridge vlan add vid 4001 dev vx4001 pvid untagged\n\n\tip address add 2001:db8:3::1/128 dev lo\n\n\t# Create SVIs\n\tvrf_create \"vrf-green\"\n\tip link set dev vrf-green up\n\n\tip link add link br1 name vlan10 up master vrf-green type vlan id 10\n\tip address add 2001:db8:1::2/64 dev vlan10\n\tip link add link vlan10 name vlan10-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:1::3/64 dev vlan10-v\n\n\tip link add link br1 name vlan20 up master vrf-green type vlan id 20\n\tip address add 2001:db8:2::2/64 dev vlan20\n\tip link add link vlan20 name vlan20-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:2::3/64 dev vlan20-v\n\n\tip link add link br1 name vlan4001 up master vrf-green \\\n\t\ttype vlan id 4001\n\n\tbridge vlan add vid 10 dev br1 self\n\tbridge vlan add vid 20 dev br1 self\n\tbridge vlan add vid 4001 dev br1 self\n\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 10\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 20\n\n\tbridge vlan add vid 10 dev $swp1 pvid untagged\n\tbridge vlan add vid 20 dev $swp2 pvid untagged\n}\n\nswitch_destroy()\n{\n\tbridge vlan del vid 20 dev br1 self\n\tbridge vlan del vid 10 dev br1 self\n\n\tbridge fdb del 00:00:5e:00:01:01 dev br1 self local vlan 20\n\tbridge fdb del 00:00:5e:00:01:01 dev br1 self local vlan 10\n\n\tbridge vlan del vid 4001 dev br1 self\n\tip link del dev vlan4001\n\n\tip link del dev vlan20\n\n\tip link del dev vlan10\n\n\tvrf_destroy \"vrf-green\"\n\n\tip address del 2001:db8:3::1/128 dev lo\n\n\tbridge vlan del vid 20 dev $swp2\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\n\tbridge vlan del vid 10 dev $swp1\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tbridge vlan del vid 4001 dev vx4001\n\tip link set dev vx4001 nomaster\n\n\tip link set dev vx4001 down\n\tip link del dev vx4001\n\n\tbridge vlan del vid 20 dev vx20\n\tip link set dev vx20 nomaster\n\n\tip link set dev vx20 down\n\tip link del dev vx20\n\n\tbridge vlan del vid 10 dev vx10\n\tip link set dev vx10 nomaster\n\n\tip link set dev vx10 down\n\tip link del dev vx10\n\n\tip route del 2001:db8:3::2 nexthop via 2001:db8:4::2\n\tip address del dev $rp1 2001:db8:4::1/64\n\tip link set dev $rp1 down\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nspine_create()\n{\n\tvrf_create \"vrf-spine\"\n\tip link set dev $rp2 master vrf-spine\n\tip link set dev v1 master vrf-spine\n\tip link set dev vrf-spine up\n\tip link set dev $rp2 up\n\tip link set dev v1 up\n\n\tip address add 2001:db8:4::2/64 dev $rp2\n\tip address add 2001:db8:5::2/64 dev v1\n\n\tip route add 2001:db8:3::1/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:4::1\n\tip route add 2001:db8:3::2/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:5::1\n}\n\nspine_destroy()\n{\n\tip route del 2001:db8:3::2/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:5::1\n\tip route del 2001:db8:3::1/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:4::1\n\n\tip address del 2001:db8:5::2/64 dev v1\n\tip address del 2001:db8:4::2/64 dev $rp2\n\n\tip link set dev v1 down\n\tip link set dev $rp2 down\n\tvrf_destroy \"vrf-spine\"\n}\n\nns_h1_create()\n{\n\thx_create \"vrf-h1\" w2 2001:db8:1::4 2001:db8:1::3\n}\nexport -f ns_h1_create\n\nns_h2_create()\n{\n\thx_create \"vrf-h2\" w4 2001:db8:2::4 2001:db8:2::3\n}\nexport -f ns_h2_create\n\nns_switch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 0\n\tip link set dev br1 up\n\n\tip link set dev v2 up\n\tip address add dev v2 2001:db8:5::1/64\n\tip route add 2001:db8:3::1 nexthop via 2001:db8:5::2\n\n\tip link add name vx10 type vxlan id 1010\t\t\\\n\t\tlocal 2001:db8:3::2 remote 2001:db8:3::1 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx10 up\n\n\tip link set dev vx10 master br1\n\tbridge vlan add vid 10 dev vx10 pvid untagged\n\n\tip link add name vx20 type vxlan id 1020\t\t\\\n\t\tlocal 2001:db8:3::2 remote 2001:db8:3::1 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx20 up\n\n\tip link set dev vx20 master br1\n\tbridge vlan add vid 20 dev vx20 pvid untagged\n\n\tip link add name vx4001 type vxlan id 104001\t\t\\\n\t\tlocal 2001:db8:3::2 dstport 4789\t\t\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx4001 up\n\n\tip link set dev vx4001 master br1\n\tbridge vlan add vid 4001 dev vx4001 pvid untagged\n\n\tip link set dev w1 master br1\n\tip link set dev w1 up\n\tbridge vlan add vid 10 dev w1 pvid untagged\n\n\tip link set dev w3 master br1\n\tip link set dev w3 up\n\tbridge vlan add vid 20 dev w3 pvid untagged\n\n\tip address add 2001:db8:3::2/128 dev lo\n\n\t# Create SVIs\n\tvrf_create \"vrf-green\"\n\tip link set dev vrf-green up\n\n\tip link add link br1 name vlan10 up master vrf-green type vlan id 10\n\tip address add 2001:db8:1::3/64 dev vlan10\n\tip link add link vlan10 name vlan10-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:1::3/64 dev vlan10-v\n\n\tip link add link br1 name vlan20 up master vrf-green type vlan id 20\n\tip address add 2001:db8:2::3/64 dev vlan20\n\tip link add link vlan20 name vlan20-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:2::3/64 dev vlan20-v\n\n\tip link add link br1 name vlan4001 up master vrf-green \\\n\t\ttype vlan id 4001\n\n\tbridge vlan add vid 10 dev br1 self\n\tbridge vlan add vid 20 dev br1 self\n\tbridge vlan add vid 4001 dev br1 self\n\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 10\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 20\n}\nexport -f ns_switch_create\n\nns_init()\n{\n\tip link add name w1 type veth peer name w2\n\tip link add name w3 type veth peer name w4\n\n\tip link set dev lo up\n\n\tns_h1_create\n\tns_h2_create\n\tns_switch_create\n}\nexport -f ns_init\n\nns1_create()\n{\n\tip netns add ns1\n\tip link set dev v2 netns ns1\n\tin_ns ns1 ns_init\n}\n\nns1_destroy()\n{\n\tip netns exec ns1 ip link set dev v2 netns 1\n\tip netns del ns1\n}\n\n__l2_vni_init()\n{\n\tlocal mac1=$1; shift\n\tlocal mac2=$1; shift\n\tlocal ip1=$1; shift\n\tlocal ip2=$1; shift\n\tlocal dst=$1; shift\n\n\tbridge fdb add $mac1 dev vx10 self master extern_learn static \\\n\t\tdst $dst vlan 10\n\tbridge fdb add $mac2 dev vx20 self master extern_learn static \\\n\t\tdst $dst vlan 20\n\n\tip neigh add $ip1 lladdr $mac1 nud noarp dev vlan10 \\\n\t\textern_learn\n\tip neigh add $ip2 lladdr $mac2 nud noarp dev vlan20 \\\n\t\textern_learn\n}\nexport -f __l2_vni_init\n\nl2_vni_init()\n{\n\tlocal h1_ns_mac=$(in_ns ns1 mac_get w2)\n\tlocal h2_ns_mac=$(in_ns ns1 mac_get w4)\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\n\t__l2_vni_init $h1_ns_mac $h2_ns_mac 2001:db8:1::4 2001:db8:2::4 \\\n\t       2001:db8:3::2\n\tin_ns ns1 __l2_vni_init $h1_mac $h2_mac 2001:db8:1::1 2001:db8:2::1 \\\n\t       2001:db8:3::1\n}\n\n__l3_vni_init()\n{\n\tlocal mac=$1; shift\n\tlocal vtep_ip=$1; shift\n\tlocal host1_ip=$1; shift\n\tlocal host2_ip=$1; shift\n\n\tbridge fdb add $mac dev vx4001 self master extern_learn static \\\n\t\tdst $vtep_ip vlan 4001\n\n\tip neigh add $vtep_ip lladdr $mac nud noarp dev vlan4001 extern_learn\n\n\tip route add $host1_ip/128 vrf vrf-green nexthop via $vtep_ip \\\n\t\tdev vlan4001 onlink\n\tip route add $host2_ip/128 vrf vrf-green nexthop via $vtep_ip \\\n\t\tdev vlan4001 onlink\n}\nexport -f __l3_vni_init\n\nl3_vni_init()\n{\n\tlocal vlan4001_ns_mac=$(in_ns ns1 mac_get vlan4001)\n\tlocal vlan4001_mac=$(mac_get vlan4001)\n\n\t__l3_vni_init $vlan4001_ns_mac 2001:db8:3::2 2001:db8:1::4 \\\n\t\t2001:db8:2::4\n\tin_ns ns1 __l3_vni_init $vlan4001_mac 2001:db8:3::1 2001:db8:1::1 \\\n\t\t2001:db8:2::1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp1=${NETIFS[p5]}\n\trp2=${NETIFS[p6]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\tswitch_create\n\n\tip link add name v1 type veth peer name v2\n\tspine_create\n\tns1_create\n\tin_ns ns1 forwarding_enable\n\n\tl2_vni_init\n\tl3_vni_init\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tns1_destroy\n\tspine_destroy\n\tip link del dev v1\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::1 \": local->local vid 10->vid 20\"\n\tping6_test $h1 2001:db8:1::4 \": local->remote vid 10->vid 10\"\n\tping6_test $h2 2001:db8:2::4 \": local->remote vid 20->vid 20\"\n\tping6_test $h1 2001:db8:2::4 \": local->remote vid 10->vid 20\"\n\tping6_test $h2 2001:db8:1::4 \": local->remote vid 20->vid 10\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}