{
  "module_name": "tc_flower_port_range.sh",
  "hash_id": "719918a685ab91e34d15a107fd9908a5cf6583937977bf9aed4ee99d352c1637",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_flower_port_range.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +-----------------------+                             +----------------------+\n# | H1 (vrf)              |                             | H2 (vrf)             |\n# |    + $h1              |                             |              $h2 +   |\n# |    | 192.0.2.1/28     |                             |     192.0.2.2/28 |   |\n# |    | 2001:db8:1::1/64 |                             | 2001:db8:1::2/64 |   |\n# +----|------------------+                             +------------------|---+\n#      |                                                                   |\n# +----|-------------------------------------------------------------------|---+\n# | SW |                                                                   |   |\n# |  +-|-------------------------------------------------------------------|-+ |\n# |  | + $swp1                       BR                              $swp2 + | |\n# |  +-----------------------------------------------------------------------+ |\n# +----------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\ttest_port_range_ipv4_udp\n\ttest_port_range_ipv4_tcp\n\ttest_port_range_ipv6_udp\n\ttest_port_range_ipv6_tcp\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\tip link set dev br1 up\n\n\ttc qdisc add dev $swp1 clsact\n\ttc qdisc add dev $swp2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev br1 down\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\n__test_port_range()\n{\n\tlocal proto=$1; shift\n\tlocal ip_proto=$1; shift\n\tlocal sip=$1; shift\n\tlocal dip=$1; shift\n\tlocal mode=$1; shift\n\tlocal name=$1; shift\n\tlocal dmac=$(mac_get $h2)\n\tlocal smac=$(mac_get $h1)\n\tlocal sport_min=100\n\tlocal sport_max=200\n\tlocal sport_mid=$((sport_min + (sport_max - sport_min) / 2))\n\tlocal dport_min=300\n\tlocal dport_max=400\n\tlocal dport_mid=$((dport_min + (dport_max - dport_min) / 2))\n\n\tRET=0\n\n\ttc filter add dev $swp1 ingress protocol $proto handle 101 pref 1 \\\n\t\tflower src_ip $sip dst_ip $dip ip_proto $ip_proto \\\n\t\tsrc_port $sport_min-$sport_max \\\n\t\tdst_port $dport_min-$dport_max \\\n\t\taction pass\n\ttc filter add dev $swp2 egress protocol $proto handle 101 pref 1 \\\n\t\tflower src_ip $sip dst_ip $dip ip_proto $ip_proto \\\n\t\tsrc_port $sport_min-$sport_max \\\n\t\tdst_port $dport_min-$dport_max \\\n\t\taction drop\n\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$sport_min,dp=$dport_min\"\n\ttc_check_packets \"dev $swp1 ingress\" 101 1\n\tcheck_err $? \"Ingress filter not hit with minimum ports\"\n\ttc_check_packets \"dev $swp2 egress\" 101 1\n\tcheck_err $? \"Egress filter not hit with minimum ports\"\n\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$sport_mid,dp=$dport_mid\"\n\ttc_check_packets \"dev $swp1 ingress\" 101 2\n\tcheck_err $? \"Ingress filter not hit with middle ports\"\n\ttc_check_packets \"dev $swp2 egress\" 101 2\n\tcheck_err $? \"Egress filter not hit with middle ports\"\n\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$sport_max,dp=$dport_max\"\n\ttc_check_packets \"dev $swp1 ingress\" 101 3\n\tcheck_err $? \"Ingress filter not hit with maximum ports\"\n\ttc_check_packets \"dev $swp2 egress\" 101 3\n\tcheck_err $? \"Egress filter not hit with maximum ports\"\n\n\t# Send traffic when both ports are out of range and when only one port\n\t# is out of range.\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$((sport_min - 1)),dp=$dport_min\"\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$((sport_max + 1)),dp=$dport_min\"\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$sport_min,dp=$((dport_min - 1))\"\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$sport_min,dp=$((dport_max + 1))\"\n\t$MZ $mode $h1 -c 1 -q -p 100 -a $smac -b $dmac -A $sip -B $dip \\\n\t\t-t $ip_proto \"sp=$((sport_max + 1)),dp=$((dport_max + 1))\"\n\ttc_check_packets \"dev $swp1 ingress\" 101 3\n\tcheck_err $? \"Ingress filter was hit when should not\"\n\ttc_check_packets \"dev $swp2 egress\" 101 3\n\tcheck_err $? \"Egress filter was hit when should not\"\n\n\ttc filter del dev $swp2 egress protocol $proto pref 1 handle 101 flower\n\ttc filter del dev $swp1 ingress protocol $proto pref 1 handle 101 flower\n\n\tlog_test \"Port range matching - $name\"\n}\n\ntest_port_range_ipv4_udp()\n{\n\tlocal proto=ipv4\n\tlocal ip_proto=udp\n\tlocal sip=192.0.2.1\n\tlocal dip=192.0.2.2\n\tlocal mode=\"-4\"\n\tlocal name=\"IPv4 UDP\"\n\n\t__test_port_range $proto $ip_proto $sip $dip $mode \"$name\"\n}\n\ntest_port_range_ipv4_tcp()\n{\n\tlocal proto=ipv4\n\tlocal ip_proto=tcp\n\tlocal sip=192.0.2.1\n\tlocal dip=192.0.2.2\n\tlocal mode=\"-4\"\n\tlocal name=\"IPv4 TCP\"\n\n\t__test_port_range $proto $ip_proto $sip $dip $mode \"$name\"\n}\n\ntest_port_range_ipv6_udp()\n{\n\tlocal proto=ipv6\n\tlocal ip_proto=udp\n\tlocal sip=2001:db8:1::1\n\tlocal dip=2001:db8:1::2\n\tlocal mode=\"-6\"\n\tlocal name=\"IPv6 UDP\"\n\n\t__test_port_range $proto $ip_proto $sip $dip $mode \"$name\"\n}\n\ntest_port_range_ipv6_tcp()\n{\n\tlocal proto=ipv6\n\tlocal ip_proto=tcp\n\tlocal sip=2001:db8:1::1\n\tlocal dip=2001:db8:1::2\n\tlocal mode=\"-6\"\n\tlocal name=\"IPv6 TCP\"\n\n\t__test_port_range $proto $ip_proto $sip $dip $mode \"$name\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}