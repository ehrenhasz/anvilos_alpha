{
  "module_name": "skbedit_priority.sh",
  "hash_id": "ffc87ca88c1a11827fbd4c5becc79210cfb2ece265adc4b87bb825a993effc4b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/skbedit_priority.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test sends traffic from H1 to H2. Either on ingress of $swp1, or on\n# egress of $swp2, the traffic is acted upon by an action skbedit priority. The\n# new priority should be taken into account when classifying traffic on the PRIO\n# qdisc at $swp2. The test verifies that for different priority values, the\n# traffic ends up in expected PRIO band.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |    + $h1             |                             |            $h2 +     |\n# |    | 192.0.2.1/28    |                             |   192.0.2.2/28 |     |\n# +----|-----------------+                             +----------------|-----+\n#      |                                                                |\n# +----|----------------------------------------------------------------|-----+\n# | SW |                                                                |     |\n# |  +-|----------------------------------------------------------------|-+   |\n# |  | + $swp1                       BR                           $swp2 + |   |\n# |  |                                                             PRIO   |   |\n# |  +--------------------------------------------------------------------+   |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\ttest_ingress\n\ttest_egress\n\"\n\nNUM_NETIFS=4\nsource lib.sh\n\n: ${HIT_TIMEOUT:=2000} # ms\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/28\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp1 clsact\n\ttc qdisc add dev $swp2 clsact\n\ttc qdisc add dev $swp2 root handle 10: \\\n\t   prio bands 8 priomap 7 6 5 4 3 2 1 0\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 root\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2\n}\n\ntest_skbedit_priority_one()\n{\n\tlocal locus=$1; shift\n\tlocal prio=$1; shift\n\tlocal classid=$1; shift\n\n\tRET=0\n\n\ttc filter add $locus handle 101 pref 1 \\\n\t   flower action skbedit priority $prio\n\n\tlocal pkt0=$(qdisc_parent_stats_get $swp2 $classid .packets)\n\tlocal pkt2=$(tc_rule_handle_stats_get \"$locus\" 101)\n\t$MZ $h1 -t udp \"sp=54321,dp=12345\" -c 10 -d 20msec -p 100 \\\n\t    -a own -b $h2mac -A 192.0.2.1 -B 192.0.2.2 -q\n\n\tlocal pkt1\n\tpkt1=$(busywait \"$HIT_TIMEOUT\" until_counter_is \">= $((pkt0 + 10))\" \\\n\t\t\tqdisc_parent_stats_get $swp2 $classid .packets)\n\tcheck_err $? \"Expected to get 10 packets on class $classid, but got $((pkt1 - pkt0)).\"\n\n\tlocal pkt3=$(tc_rule_handle_stats_get \"$locus\" 101)\n\t((pkt3 >= pkt2 + 10))\n\tcheck_err $? \"Expected to get 10 packets on skbedit rule but got $((pkt3 - pkt2)).\"\n\n\tlog_test \"$locus skbedit priority $prio -> classid $classid\"\n\n\ttc filter del $locus pref 1\n}\n\ntest_ingress()\n{\n\tlocal prio\n\n\tfor prio in {0..7}; do\n\t\ttest_skbedit_priority_one \"dev $swp1 ingress\" \\\n\t\t\t\t\t  $prio 10:$((8 - prio))\n\tdone\n}\n\ntest_egress()\n{\n\tlocal prio\n\n\tfor prio in {0..7}; do\n\t\ttest_skbedit_priority_one \"dev $swp2 egress\" \\\n\t\t\t\t\t  $prio 10:$((8 - prio))\n\tdone\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}