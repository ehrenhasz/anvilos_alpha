{
  "module_name": "router.sh",
  "hash_id": "86f62377b04495690212e7eefe0ec83db89aae379b79b544803a98e2996f5a2c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/router.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +--------------------+                     +----------------------+\n# | H1                 |                     |                   H2 |\n# |                    |                     |                      |\n# |              $h1 + |                     | + $h2                |\n# |     192.0.2.2/24 | |                     | | 198.51.100.2/24    |\n# | 2001:db8:1::2/64 | |                     | | 2001:db8:2::2/64   |\n# |                  | |                     | |                    |\n# +------------------|-+                     +-|--------------------+\n#                    |                         |\n# +------------------|-------------------------|--------------------+\n# | SW               |                         |                    |\n# |                  |                         |                    |\n# |             $rp1 +                         + $rp2               |\n# |     192.0.2.1/24                             198.51.100.1/24    |\n# | 2001:db8:1::1/64                             2001:db8:2::1/64   |\n# |                                                                 |\n# +-----------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\tsip_in_class_e\n\tmc_mac_mismatch\n\tipv4_sip_equal_dip\n\tipv6_sip_equal_dip\n\tipv4_dip_link_local\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\nrequire_command $MCD\nrequire_command $MC_CLI\ntable_name=selftests\n\nh1_create()\n{\n\tvrf_create \"vrf-h1\"\n\tip link set dev $h1 master vrf-h1\n\n\tip link set dev vrf-h1 up\n\tip link set dev $h1 up\n\n\tip address add 192.0.2.2/24 dev $h1\n\tip address add 2001:db8:1::2/64 dev $h1\n\n\tip route add 198.51.100.0/24 vrf vrf-h1 nexthop via 192.0.2.1\n\tip route add 2001:db8:2::/64 vrf vrf-h1 nexthop via 2001:db8:1::1\n}\n\nh1_destroy()\n{\n\tip route del 2001:db8:2::/64 vrf vrf-h1\n\tip route del 198.51.100.0/24 vrf vrf-h1\n\n\tip address del 2001:db8:1::2/64 dev $h1\n\tip address del 192.0.2.2/24 dev $h1\n\n\tip link set dev $h1 down\n\tvrf_destroy \"vrf-h1\"\n}\n\nh2_create()\n{\n\tvrf_create \"vrf-h2\"\n\tip link set dev $h2 master vrf-h2\n\n\tip link set dev vrf-h2 up\n\tip link set dev $h2 up\n\n\tip address add 198.51.100.2/24 dev $h2\n\tip address add 2001:db8:2::2/64 dev $h2\n\n\tip route add 192.0.2.0/24 vrf vrf-h2 nexthop via 198.51.100.1\n\tip route add 2001:db8:1::/64 vrf vrf-h2 nexthop via 2001:db8:2::1\n}\n\nh2_destroy()\n{\n\tip route del 2001:db8:1::/64 vrf vrf-h2\n\tip route del 192.0.2.0/24 vrf vrf-h2\n\n\tip address del 2001:db8:2::2/64 dev $h2\n\tip address del 198.51.100.2/24 dev $h2\n\n\tip link set dev $h2 down\n\tvrf_destroy \"vrf-h2\"\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\n\ttc qdisc add dev $rp2 clsact\n\n\tip address add 192.0.2.1/24 dev $rp1\n\tip address add 2001:db8:1::1/64 dev $rp1\n\n\tip address add 198.51.100.1/24 dev $rp2\n\tip address add 2001:db8:2::1/64 dev $rp2\n}\n\nrouter_destroy()\n{\n\tip address del 2001:db8:2::1/64 dev $rp2\n\tip address del 198.51.100.1/24 dev $rp2\n\n\tip address del 2001:db8:1::1/64 dev $rp1\n\tip address del 192.0.2.1/24 dev $rp1\n\n\ttc qdisc del dev $rp2 clsact\n\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\nstart_mcd()\n{\n\tSMCROUTEDIR=\"$(mktemp -d)\"\n\n\tfor ((i = 1; i <= $NUM_NETIFS; ++i)); do\n\t\techo \"phyint ${NETIFS[p$i]} enable\" >> \\\n\t\t\t$SMCROUTEDIR/$table_name.conf\n\tdone\n\n\t$MCD -N -I $table_name -f $SMCROUTEDIR/$table_name.conf \\\n\t\t-P $SMCROUTEDIR/$table_name.pid\n}\n\nkill_mcd()\n{\n\tpkill $MCD\n\trm -rf $SMCROUTEDIR\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp1mac=$(mac_get $rp1)\n\n\tstart_mcd\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n\n\tkill_mcd\n}\n\nping_ipv4()\n{\n\tping_test $h1 198.51.100.2\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::2\n}\n\nsip_in_class_e()\n{\n\tRET=0\n\n\t# Disable rpfilter to prevent packets to be dropped because of it.\n\tsysctl_set net.ipv4.conf.all.rp_filter 0\n\tsysctl_set net.ipv4.conf.$rp1.rp_filter 0\n\n\ttc filter add dev $rp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower src_ip 240.0.0.1 ip_proto udp action pass\n\n\t$MZ $h1 -t udp \"sp=54321,dp=12345\" -c 5 -d 1msec \\\n\t\t-A 240.0.0.1 -b $rp1mac -B 198.51.100.2 -q\n\n\ttc_check_packets \"dev $rp2 egress\" 101 5\n\tcheck_err $? \"Packets were dropped\"\n\n\tlog_test \"Source IP in class E\"\n\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n\tsysctl_restore net.ipv4.conf.$rp1.rp_filter\n\tsysctl_restore net.ipv4.conf.all.rp_filter\n}\n\ncreate_mcast_sg()\n{\n\tlocal if_name=$1; shift\n\tlocal s_addr=$1; shift\n\tlocal mcast=$1; shift\n\tlocal dest_ifs=${@}\n\n\t$MC_CLI -I $table_name add $if_name $s_addr $mcast $dest_ifs\n}\n\ndelete_mcast_sg()\n{\n\tlocal if_name=$1; shift\n\tlocal s_addr=$1; shift\n\tlocal mcast=$1; shift\n\tlocal dest_ifs=${@}\n\n\t$MC_CLI -I $table_name remove $if_name $s_addr $mcast $dest_ifs\n}\n\n__mc_mac_mismatch()\n{\n\tlocal desc=$1; shift\n\tlocal proto=$1; shift\n\tlocal sip=$1; shift\n\tlocal dip=$1; shift\n\tlocal flags=${1:-\"\"}; shift\n\tlocal dmac=01:02:03:04:05:06\n\n\tRET=0\n\n\ttc filter add dev $rp2 egress protocol $proto pref 1 handle 101 \\\n\t\tflower dst_ip $dip action pass\n\n\tcreate_mcast_sg $rp1 $sip $dip $rp2\n\n\t$MZ $flags $h1 -t udp \"sp=54321,dp=12345\" -c 5 -d 1msec -b $dmac \\\n\t\t-B $dip -q\n\n\ttc_check_packets \"dev $rp2 egress\" 101 5\n\tcheck_err $? \"Packets were dropped\"\n\n\tlog_test \"Multicast MAC mismatch: $desc\"\n\n\tdelete_mcast_sg $rp1 $sip $dip $rp2\n\ttc filter del dev $rp2 egress protocol $proto pref 1 handle 101 flower\n}\n\nmc_mac_mismatch()\n{\n\t__mc_mac_mismatch \"IPv4\" \"ip\" 192.0.2.2 225.1.2.3\n\t__mc_mac_mismatch \"IPv6\" \"ipv6\" 2001:db8:1::2 ff0e::3 \"-6\"\n}\n\nipv4_sip_equal_dip()\n{\n\tRET=0\n\n\t# Disable rpfilter to prevent packets to be dropped because of it.\n\tsysctl_set net.ipv4.conf.all.rp_filter 0\n\tsysctl_set net.ipv4.conf.$rp1.rp_filter 0\n\n\ttc filter add dev $rp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower src_ip 198.51.100.2  action pass\n\n\t$MZ $h1 -t udp \"sp=54321,dp=12345\" -c 5 -d 1msec \\\n\t\t-A 198.51.100.2 -b $rp1mac -B 198.51.100.2 -q\n\n\ttc_check_packets \"dev $rp2 egress\" 101 5\n\tcheck_err $? \"Packets were dropped\"\n\n\tlog_test \"Source IP is equal to destination IP: IPv4\"\n\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n\tsysctl_restore net.ipv4.conf.$rp1.rp_filter\n\tsysctl_restore net.ipv4.conf.all.rp_filter\n}\n\nipv6_sip_equal_dip()\n{\n\tRET=0\n\n\ttc filter add dev $rp2 egress protocol ipv6 pref 1 handle 101 \\\n\t\tflower src_ip 2001:db8:2::2 action pass\n\n\t$MZ -6 $h1 -t udp \"sp=54321,dp=12345\" -c 5 -d 1msec \\\n\t\t-A 2001:db8:2::2 -b $rp1mac -B 2001:db8:2::2 -q\n\n\ttc_check_packets \"dev $rp2 egress\" 101 5\n\tcheck_err $? \"Packets were dropped\"\n\n\tlog_test \"Source IP is equal to destination IP: IPv6\"\n\n\ttc filter del dev $rp2 egress protocol ipv6 pref 1 handle 101 flower\n}\n\nipv4_dip_link_local()\n{\n\tlocal dip=169.254.1.1\n\n\tRET=0\n\n\ttc filter add dev $rp2 egress protocol ip pref 1 handle 101 \\\n\t\tflower dst_ip $dip action pass\n\n\tip neigh add 169.254.1.1 lladdr 00:11:22:33:44:55 dev $rp2\n\tip route add 169.254.1.0/24 dev $rp2\n\n\t$MZ $h1 -t udp \"sp=54321,dp=12345\" -c 5 -d 1msec -b $rp1mac -B $dip -q\n\n\ttc_check_packets \"dev $rp2 egress\" 101 5\n\tcheck_err $? \"Packets were dropped\"\n\n\tlog_test \"IPv4 destination IP is link-local\"\n\n\tip route del 169.254.1.0/24 dev $rp2\n\tip neigh del 169.254.1.1 lladdr 00:11:22:33:44:55 dev $rp2\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}