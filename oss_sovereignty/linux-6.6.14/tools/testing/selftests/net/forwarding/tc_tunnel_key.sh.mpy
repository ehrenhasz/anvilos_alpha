{
  "module_name": "tc_tunnel_key.sh",
  "hash_id": "2d8e2743a378b310ed87ef9aaa1f2b78b54609d4c7e3b0889739e3b06deb1144",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_tunnel_key.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nALL_TESTS=\"tunnel_key_nofrag_test\"\n\nNUM_NETIFS=4\nsource tc_common.sh\nsource lib.sh\n\ntcflags=\"skip_hw\"\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n\tforwarding_enable\n\tmtu_set $h1 1500\n\ttunnel_create h1-et vxlan 192.0.2.1 192.0.2.2 dev $h1 dstport 0 external\n\ttc qdisc add dev h1-et clsact\n\tmtu_set h1-et 1230\n\tmtu_restore $h1\n\tmtu_set $h1 1000\n}\n\nh1_destroy()\n{\n\ttc qdisc del dev h1-et clsact\n\ttunnel_destroy h1-et\n\tforwarding_restore\n\tmtu_restore $h1\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/24\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/24\n}\n\nswitch_create()\n{\n\tsimple_if_init $swp1 192.0.2.2/24\n\ttc qdisc add dev $swp1 clsact\n\tsimple_if_init $swp2 192.0.2.1/24\n}\n\nswitch_destroy()\n{\n\tsimple_if_fini $swp2 192.0.2.1/24\n\ttc qdisc del dev $swp1 clsact\n\tsimple_if_fini $swp1 192.0.2.2/24\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th1mac=$(mac_get $h1)\n\th2mac=$(mac_get $h2)\n\n\tswp1origmac=$(mac_get $swp1)\n\tswp2origmac=$(mac_get $swp2)\n\tip link set $swp1 address $h2mac\n\tip link set $swp2 address $h1mac\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\tswitch_create\n\n\tif ! tc action add action tunnel_key help 2>&1 | grep -q nofrag; then\n\t\tlog_test \"SKIP: iproute doesn't support nofrag\"\n\t\texit $ksft_skip\n\tfi\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n\n\tip link set $swp2 address $swp2origmac\n\tip link set $swp1 address $swp1origmac\n}\n\ntunnel_key_nofrag_test()\n{\n\tRET=0\n\tlocal i\n\n\ttc filter add dev $swp1 ingress protocol ip pref 100 handle 100 \\\n\t\tflower src_ip 192.0.2.1 dst_ip 192.0.2.2 ip_proto udp \\\n\t\tip_flags nofrag action drop\n\ttc filter add dev $swp1 ingress protocol ip pref 101 handle 101 \\\n\t\tflower src_ip 192.0.2.1 dst_ip 192.0.2.2 ip_proto udp \\\n\t\tip_flags firstfrag action drop\n\ttc filter add dev $swp1 ingress protocol ip pref 102 handle 102 \\\n\t\tflower src_ip 192.0.2.1 dst_ip 192.0.2.2 ip_proto udp \\\n\t\tip_flags nofirstfrag action drop\n\n\t# test 'nofrag' set\n\ttc filter add dev h1-et egress protocol all pref 1 handle 1 matchall $tcflags \\\n\t\taction tunnel_key set src_ip 192.0.2.1 dst_ip 192.0.2.2 id 42 nofrag index 10\n\t$MZ h1-et -c 1 -p 930 -a 00:aa:bb:cc:dd:ee -b 00:ee:dd:cc:bb:aa -t ip -q\n\ttc_check_packets \"dev $swp1 ingress\" 100 1\n\tcheck_err $? \"packet smaller than MTU was not tunneled\"\n\n\t$MZ h1-et -c 1 -p 931 -a 00:aa:bb:cc:dd:ee -b 00:ee:dd:cc:bb:aa -t ip -q\n\ttc_check_packets \"dev $swp1 ingress\" 100 1\n\tcheck_err $? \"packet bigger than MTU matched nofrag (nofrag was set)\"\n\ttc_check_packets \"dev $swp1 ingress\" 101 0\n\tcheck_err $? \"packet bigger than MTU matched firstfrag (nofrag was set)\"\n\ttc_check_packets \"dev $swp1 ingress\" 102 0\n\tcheck_err $? \"packet bigger than MTU matched nofirstfrag (nofrag was set)\"\n\n\t# test 'nofrag' cleared\n\ttc actions change action tunnel_key set src_ip 192.0.2.1 dst_ip 192.0.2.2 id 42 index 10\n\t$MZ h1-et -c 1 -p 931 -a 00:aa:bb:cc:dd:ee -b 00:ee:dd:cc:bb:aa -t ip -q\n\ttc_check_packets \"dev $swp1  ingress\" 100 1\n\tcheck_err $? \"packet bigger than MTU matched nofrag (nofrag was unset)\"\n\ttc_check_packets \"dev $swp1  ingress\" 101 1\n\tcheck_err $? \"packet bigger than MTU didn't match firstfrag (nofrag was unset) \"\n\ttc_check_packets \"dev $swp1 ingress\" 102 1\n\tcheck_err $? \"packet bigger than MTU didn't match nofirstfrag (nofrag was unset) \"\n\n\tfor i in 100 101 102; do\n\t\ttc filter del dev $swp1 ingress protocol ip pref $i handle $i flower\n\tdone\n\ttc filter del dev h1-et egress pref 1 handle 1 matchall\n\n\tlog_test \"tunnel_key nofrag ($tcflags)\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\ntc_offload_check\nif [[ $? -ne 0 ]]; then\n\tlog_info \"Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttests_run\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}