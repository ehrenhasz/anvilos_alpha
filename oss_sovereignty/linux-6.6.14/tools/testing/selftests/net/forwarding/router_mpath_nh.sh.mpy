{
  "module_name": "router_mpath_nh.sh",
  "hash_id": "cb47fb3c6357e5ceb87467f238cd2f7b5b6930a453ca6b13b91e917f5260b964",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/router_mpath_nh.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\tmultipath_test\n\tping_ipv4_blackhole\n\tping_ipv6_blackhole\n\"\nNUM_NETIFS=8\nsource lib.sh\n\nh1_create()\n{\n\tvrf_create \"vrf-h1\"\n\tip link set dev $h1 master vrf-h1\n\n\tip link set dev vrf-h1 up\n\tip link set dev $h1 up\n\n\tip address add 192.0.2.2/24 dev $h1\n\tip address add 2001:db8:1::2/64 dev $h1\n\n\tip route add 198.51.100.0/24 vrf vrf-h1 nexthop via 192.0.2.1\n\tip route add 2001:db8:2::/64 vrf vrf-h1 nexthop via 2001:db8:1::1\n}\n\nh1_destroy()\n{\n\tip route del 2001:db8:2::/64 vrf vrf-h1\n\tip route del 198.51.100.0/24 vrf vrf-h1\n\n\tip address del 2001:db8:1::2/64 dev $h1\n\tip address del 192.0.2.2/24 dev $h1\n\n\tip link set dev $h1 down\n\tvrf_destroy \"vrf-h1\"\n}\n\nh2_create()\n{\n\tvrf_create \"vrf-h2\"\n\tip link set dev $h2 master vrf-h2\n\n\tip link set dev vrf-h2 up\n\tip link set dev $h2 up\n\n\tip address add 198.51.100.2/24 dev $h2\n\tip address add 2001:db8:2::2/64 dev $h2\n\n\tip route add 192.0.2.0/24 vrf vrf-h2 nexthop via 198.51.100.1\n\tip route add 2001:db8:1::/64 vrf vrf-h2 nexthop via 2001:db8:2::1\n}\n\nh2_destroy()\n{\n\tip route del 2001:db8:1::/64 vrf vrf-h2\n\tip route del 192.0.2.0/24 vrf vrf-h2\n\n\tip address del 2001:db8:2::2/64 dev $h2\n\tip address del 198.51.100.2/24 dev $h2\n\n\tip link set dev $h2 down\n\tvrf_destroy \"vrf-h2\"\n}\n\nrouter1_create()\n{\n\tvrf_create \"vrf-r1\"\n\tip link set dev $rp11 master vrf-r1\n\tip link set dev $rp12 master vrf-r1\n\tip link set dev $rp13 master vrf-r1\n\n\tip link set dev vrf-r1 up\n\tip link set dev $rp11 up\n\tip link set dev $rp12 up\n\tip link set dev $rp13 up\n\n\tip address add 192.0.2.1/24 dev $rp11\n\tip address add 2001:db8:1::1/64 dev $rp11\n\n\tip address add 169.254.2.12/24 dev $rp12\n\tip address add fe80:2::12/64 dev $rp12\n\n\tip address add 169.254.3.13/24 dev $rp13\n\tip address add fe80:3::13/64 dev $rp13\n}\n\nrouter1_destroy()\n{\n\tip route del 2001:db8:2::/64 vrf vrf-r1\n\tip route del 198.51.100.0/24 vrf vrf-r1\n\n\tip address del fe80:3::13/64 dev $rp13\n\tip address del 169.254.3.13/24 dev $rp13\n\n\tip address del fe80:2::12/64 dev $rp12\n\tip address del 169.254.2.12/24 dev $rp12\n\n\tip address del 2001:db8:1::1/64 dev $rp11\n\tip address del 192.0.2.1/24 dev $rp11\n\n\tip nexthop del id 103\n\tip nexthop del id 101\n\tip nexthop del id 102\n\tip nexthop del id 106\n\tip nexthop del id 104\n\tip nexthop del id 105\n\n\tip link set dev $rp13 down\n\tip link set dev $rp12 down\n\tip link set dev $rp11 down\n\n\tvrf_destroy \"vrf-r1\"\n}\n\nrouter2_create()\n{\n\tvrf_create \"vrf-r2\"\n\tip link set dev $rp21 master vrf-r2\n\tip link set dev $rp22 master vrf-r2\n\tip link set dev $rp23 master vrf-r2\n\n\tip link set dev vrf-r2 up\n\tip link set dev $rp21 up\n\tip link set dev $rp22 up\n\tip link set dev $rp23 up\n\n\tip address add 198.51.100.1/24 dev $rp21\n\tip address add 2001:db8:2::1/64 dev $rp21\n\n\tip address add 169.254.2.22/24 dev $rp22\n\tip address add fe80:2::22/64 dev $rp22\n\n\tip address add 169.254.3.23/24 dev $rp23\n\tip address add fe80:3::23/64 dev $rp23\n}\n\nrouter2_destroy()\n{\n\tip route del 2001:db8:1::/64 vrf vrf-r2\n\tip route del 192.0.2.0/24 vrf vrf-r2\n\n\tip address del fe80:3::23/64 dev $rp23\n\tip address del 169.254.3.23/24 dev $rp23\n\n\tip address del fe80:2::22/64 dev $rp22\n\tip address del 169.254.2.22/24 dev $rp22\n\n\tip address del 2001:db8:2::1/64 dev $rp21\n\tip address del 198.51.100.1/24 dev $rp21\n\n\tip nexthop del id 201\n\tip nexthop del id 202\n\tip nexthop del id 204\n\tip nexthop del id 205\n\n\tip link set dev $rp23 down\n\tip link set dev $rp22 down\n\tip link set dev $rp21 down\n\n\tvrf_destroy \"vrf-r2\"\n}\n\nrouting_nh_obj()\n{\n\tip nexthop add id 101 via 169.254.2.22 dev $rp12\n\tip nexthop add id 102 via 169.254.3.23 dev $rp13\n\tip nexthop add id 103 group 101/102\n\tip route add 198.51.100.0/24 vrf vrf-r1 nhid 103\n\n\tip nexthop add id 104 via fe80:2::22 dev $rp12\n\tip nexthop add id 105 via fe80:3::23 dev $rp13\n\tip nexthop add id 106 group 104/105\n\tip route add 2001:db8:2::/64 vrf vrf-r1 nhid 106\n\n\tip nexthop add id 201 via 169.254.2.12 dev $rp22\n\tip nexthop add id 202 via 169.254.3.13 dev $rp23\n\tip nexthop add id 203 group 201/202\n\tip route add 192.0.2.0/24 vrf vrf-r2 nhid 203\n\n\tip nexthop add id 204 via fe80:2::12 dev $rp22\n\tip nexthop add id 205 via fe80:3::13 dev $rp23\n\tip nexthop add id 206 group 204/205\n\tip route add 2001:db8:1::/64 vrf vrf-r2 nhid 206\n}\n\nmultipath4_test()\n{\n\tlocal desc=\"$1\"\n\tlocal weight_rp12=$2\n\tlocal weight_rp13=$3\n\tlocal t0_rp12 t0_rp13 t1_rp12 t1_rp13\n\tlocal packets_rp12 packets_rp13\n\n\t# Transmit multiple flows from h1 to h2 and make sure they are\n\t# distributed between both multipath links (rp12 and rp13)\n\t# according to the configured weights.\n\tsysctl_set net.ipv4.fib_multipath_hash_policy 1\n\tip nexthop replace id 103 group 101,$weight_rp12/102,$weight_rp13\n\n\tt0_rp12=$(link_stats_tx_packets_get $rp12)\n\tt0_rp13=$(link_stats_tx_packets_get $rp13)\n\n\tip vrf exec vrf-h1 $MZ $h1 -q -p 64 -A 192.0.2.2 -B 198.51.100.2 \\\n\t\t-d 1msec -t udp \"sp=1024,dp=0-32768\"\n\n\tt1_rp12=$(link_stats_tx_packets_get $rp12)\n\tt1_rp13=$(link_stats_tx_packets_get $rp13)\n\n\tlet \"packets_rp12 = $t1_rp12 - $t0_rp12\"\n\tlet \"packets_rp13 = $t1_rp13 - $t0_rp13\"\n\tmultipath_eval \"$desc\" $weight_rp12 $weight_rp13 $packets_rp12 $packets_rp13\n\n\t# Restore settings.\n\tip nexthop replace id 103 group 101/102\n\tsysctl_restore net.ipv4.fib_multipath_hash_policy\n}\n\nmultipath6_l4_test()\n{\n\tlocal desc=\"$1\"\n\tlocal weight_rp12=$2\n\tlocal weight_rp13=$3\n\tlocal t0_rp12 t0_rp13 t1_rp12 t1_rp13\n\tlocal packets_rp12 packets_rp13\n\n\t# Transmit multiple flows from h1 to h2 and make sure they are\n\t# distributed between both multipath links (rp12 and rp13)\n\t# according to the configured weights.\n\tsysctl_set net.ipv6.fib_multipath_hash_policy 1\n\n\tip nexthop replace id 106 group 104,$weight_rp12/105,$weight_rp13\n\n\tt0_rp12=$(link_stats_tx_packets_get $rp12)\n\tt0_rp13=$(link_stats_tx_packets_get $rp13)\n\n\t$MZ $h1 -6 -q -p 64 -A 2001:db8:1::2 -B 2001:db8:2::2 \\\n\t\t-d 1msec -t udp \"sp=1024,dp=0-32768\"\n\n\tt1_rp12=$(link_stats_tx_packets_get $rp12)\n\tt1_rp13=$(link_stats_tx_packets_get $rp13)\n\n\tlet \"packets_rp12 = $t1_rp12 - $t0_rp12\"\n\tlet \"packets_rp13 = $t1_rp13 - $t0_rp13\"\n\tmultipath_eval \"$desc\" $weight_rp12 $weight_rp13 $packets_rp12 $packets_rp13\n\n\tip nexthop replace id 106 group 104/105\n\n\tsysctl_restore net.ipv6.fib_multipath_hash_policy\n}\n\nmultipath6_test()\n{\n\tlocal desc=\"$1\"\n\tlocal weight_rp12=$2\n\tlocal weight_rp13=$3\n\tlocal t0_rp12 t0_rp13 t1_rp12 t1_rp13\n\tlocal packets_rp12 packets_rp13\n\n\tip nexthop replace id 106 group 104,$weight_rp12/105,$weight_rp13\n\n\tt0_rp12=$(link_stats_tx_packets_get $rp12)\n\tt0_rp13=$(link_stats_tx_packets_get $rp13)\n\n\t# Generate 16384 echo requests, each with a random flow label.\n\tfor _ in $(seq 1 16384); do\n\t\tip vrf exec vrf-h1 $PING6 2001:db8:2::2 -F 0 -c 1 -q >/dev/null 2>&1\n\tdone\n\n\tt1_rp12=$(link_stats_tx_packets_get $rp12)\n\tt1_rp13=$(link_stats_tx_packets_get $rp13)\n\n\tlet \"packets_rp12 = $t1_rp12 - $t0_rp12\"\n\tlet \"packets_rp13 = $t1_rp13 - $t0_rp13\"\n\tmultipath_eval \"$desc\" $weight_rp12 $weight_rp13 $packets_rp12 $packets_rp13\n\n\tip nexthop replace id 106 group 104/105\n}\n\nmultipath_test()\n{\n\tlog_info \"Running IPv4 multipath tests\"\n\tmultipath4_test \"ECMP\" 1 1\n\tmultipath4_test \"Weighted MP 2:1\" 2 1\n\tmultipath4_test \"Weighted MP 11:45\" 11 45\n\n\tlog_info \"Running IPv4 multipath tests with IPv6 link-local nexthops\"\n\tip nexthop replace id 101 via fe80:2::22 dev $rp12\n\tip nexthop replace id 102 via fe80:3::23 dev $rp13\n\n\tmultipath4_test \"ECMP\" 1 1\n\tmultipath4_test \"Weighted MP 2:1\" 2 1\n\tmultipath4_test \"Weighted MP 11:45\" 11 45\n\n\tip nexthop replace id 102 via 169.254.3.23 dev $rp13\n\tip nexthop replace id 101 via 169.254.2.22 dev $rp12\n\n\tlog_info \"Running IPv6 multipath tests\"\n\tmultipath6_test \"ECMP\" 1 1\n\tmultipath6_test \"Weighted MP 2:1\" 2 1\n\tmultipath6_test \"Weighted MP 11:45\" 11 45\n\n\tlog_info \"Running IPv6 L4 hash multipath tests\"\n\tmultipath6_l4_test \"ECMP\" 1 1\n\tmultipath6_l4_test \"Weighted MP 2:1\" 2 1\n\tmultipath6_l4_test \"Weighted MP 11:45\" 11 45\n}\n\nping_ipv4_blackhole()\n{\n\tRET=0\n\n\tip nexthop add id 1001 blackhole\n\tip nexthop add id 1002 group 1001\n\n\tip route replace 198.51.100.0/24 vrf vrf-r1 nhid 1001\n\tping_do $h1 198.51.100.2\n\tcheck_fail $? \"ping did not fail when using a blackhole nexthop\"\n\n\tip route replace 198.51.100.0/24 vrf vrf-r1 nhid 1002\n\tping_do $h1 198.51.100.2\n\tcheck_fail $? \"ping did not fail when using a blackhole nexthop group\"\n\n\tip route replace 198.51.100.0/24 vrf vrf-r1 nhid 103\n\tping_do $h1 198.51.100.2\n\tcheck_err $? \"ping failed with a valid nexthop\"\n\n\tlog_test \"IPv4 blackhole ping\"\n\n\tip nexthop del id 1002\n\tip nexthop del id 1001\n}\n\nping_ipv6_blackhole()\n{\n\tRET=0\n\n\tip -6 nexthop add id 1001 blackhole\n\tip nexthop add id 1002 group 1001\n\n\tip route replace 2001:db8:2::/64 vrf vrf-r1 nhid 1001\n\tping6_do $h1 2001:db8:2::2\n\tcheck_fail $? \"ping did not fail when using a blackhole nexthop\"\n\n\tip route replace 2001:db8:2::/64 vrf vrf-r1 nhid 1002\n\tping6_do $h1 2001:db8:2::2\n\tcheck_fail $? \"ping did not fail when using a blackhole nexthop group\"\n\n\tip route replace 2001:db8:2::/64 vrf vrf-r1 nhid 106\n\tping6_do $h1 2001:db8:2::2\n\tcheck_err $? \"ping failed with a valid nexthop\"\n\n\tlog_test \"IPv6 blackhole ping\"\n\n\tip nexthop del id 1002\n\tip -6 nexthop del id 1001\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp11=${NETIFS[p2]}\n\n\trp12=${NETIFS[p3]}\n\trp22=${NETIFS[p4]}\n\n\trp13=${NETIFS[p5]}\n\trp23=${NETIFS[p6]}\n\n\trp21=${NETIFS[p7]}\n\th2=${NETIFS[p8]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter1_create\n\trouter2_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter2_destroy\n\trouter1_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 198.51.100.2\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::2\n}\n\nip nexthop ls >/dev/null 2>&1\nif [ $? -ne 0 ]; then\n\techo \"Nexthop objects not supported; skipping tests\"\n\texit $ksft_skip\nfi\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\nrouting_nh_obj\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}