{
  "module_name": "router_bridge_vlan.sh",
  "hash_id": "f664bec63bbc27de7fc75e447d5bf76ea11c57a8e7652726469c8cecd13f06d6",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/router_bridge_vlan.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +------------------------------------------------+   +----------------------+\n# | H1 (vrf)                                       |   |             H2 (vrf) |\n# |    + $h1.555           + $h1.777               |   |  + $h2               |\n# |    | 192.0.2.1/28      | 192.0.2.17/28         |   |  | 192.0.2.130/28    |\n# |    | 2001:db8:1::1/64  | 2001:db8:3::1/64      |   |  | 192.0.2.146/28    |\n# |    | .-----------------'                       |   |  | 2001:db8:2::2/64  |\n# |    |/                                          |   |  | 2001:db8:4::2/64  |\n# |    + $h1                                       |   |  |                   |\n# +----|-------------------------------------------+   +--|-------------------+\n#      |                                                  |\n# +----|--------------------------------------------------|-------------------+\n# | SW |                                                  |                   |\n# | +--|-------------------------------+                  + $swp2             |\n# | |  + $swp1                         |                    192.0.2.129/28    |\n# | |    vid 555 777                   |                    192.0.2.145/28    |\n# | |                                  |                    2001:db8:2::1/64  |\n# | |  + BR1 (802.1q)                  |                    2001:db8:4::1/64  |\n# | |    vid 555 pvid untagged         |                                      |\n# | |    192.0.2.2/28                  |                                      |\n# | |    192.0.2.18/28                 |                                      |\n# | |    2001:db8:1::2/64              |                                      |\n# | |    2001:db8:3::2/64              |                                      |\n# | +----------------------------------+                                      |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\tvlan\n\tconfig_777\n\tping_ipv4_fails\n\tping_ipv6_fails\n\tping_ipv4_777\n\tping_ipv6_777\n\tconfig_555\n\tping_ipv4\n\tping_ipv6\n\"\nNUM_NETIFS=4\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n\n\tvlan_create $h1 555 v$h1 192.0.2.1/28 2001:db8:1::1/64\n\tip -4 route add 192.0.2.128/28 vrf v$h1 nexthop via 192.0.2.2\n\tip -6 route add 2001:db8:2::/64 vrf v$h1 nexthop via 2001:db8:1::2\n\n\tvlan_create $h1 777 v$h1 192.0.2.17/28 2001:db8:3::1/64\n\tip -4 route add 192.0.2.144/28 vrf v$h1 nexthop via 192.0.2.18\n\tip -6 route add 2001:db8:4::/64 vrf v$h1 nexthop via 2001:db8:3::2\n}\n\nh1_destroy()\n{\n\tip -6 route del 2001:db8:4::/64 vrf v$h1\n\tip -4 route del 192.0.2.144/28 vrf v$h1\n\tvlan_destroy $h1 777\n\n\tip -6 route del 2001:db8:2::/64 vrf v$h1\n\tip -4 route del 192.0.2.128/28 vrf v$h1\n\tvlan_destroy $h1 555\n\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.130/28 2001:db8:2::2/64 \\\n\t\t\t   192.0.2.146/28 2001:db8:4::2/64\n\tip -4 route add 192.0.2.0/28 vrf v$h2 nexthop via 192.0.2.129\n\tip -4 route add 192.0.2.16/28 vrf v$h2 nexthop via 192.0.2.145\n\tip -6 route add 2001:db8:1::/64 vrf v$h2 nexthop via 2001:db8:2::1\n\tip -6 route add 2001:db8:3::/64 vrf v$h2 nexthop via 2001:db8:4::1\n}\n\nh2_destroy()\n{\n\tip -6 route del 2001:db8:3::/64 vrf v$h2\n\tip -6 route del 2001:db8:1::/64 vrf v$h2\n\tip -4 route del 192.0.2.16/28 vrf v$h2\n\tip -4 route del 192.0.2.0/28 vrf v$h2\n\tsimple_if_fini $h2 192.0.2.146/28 2001:db8:4::2/64 \\\n\t\t\t   192.0.2.130/28 2001:db8:2::2/64\n}\n\nrouter_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_default_pvid 0\n\tip link set dev br1 up\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\n\tbridge vlan add dev br1 vid 555 self pvid untagged\n\tbridge vlan add dev $swp1 vid 555\n\tbridge vlan add dev $swp1 vid 777\n\n\t__addr_add_del br1 add 192.0.2.2/28 2001:db8:1::2/64\n\t__addr_add_del br1 add 192.0.2.18/28 2001:db8:3::2/64\n\n\tip link set dev $swp2 up\n\t__addr_add_del $swp2 add 192.0.2.129/28 2001:db8:2::1/64\n\t__addr_add_del $swp2 add 192.0.2.145/28 2001:db8:4::1/64\n}\n\nrouter_destroy()\n{\n\t__addr_add_del $swp2 del 192.0.2.145/28 2001:db8:4::1/64\n\t__addr_add_del $swp2 del 192.0.2.129/28 2001:db8:2::1/64\n\tip link set dev $swp2 down\n\n\t__addr_add_del br1 del 192.0.2.18/28 2001:db8:3::2/64\n\t__addr_add_del br1 del 192.0.2.2/28 2001:db8:1::2/64\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter_create\n\n\tforwarding_enable\n}\n\nconfig_555()\n{\n\tlog_info \"Configure VLAN 555 as PVID\"\n\n\tbridge vlan add dev br1 vid 555 self pvid untagged\n\tbridge vlan del dev br1 vid 777 self\n\tsleep 2\n}\n\nconfig_777()\n{\n\tlog_info \"Configure VLAN 777 as PVID\"\n\n\tbridge vlan add dev br1 vid 777 self pvid untagged\n\tbridge vlan del dev br1 vid 555 self\n\tsleep 2\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nvlan()\n{\n\tRET=0\n\n\tbridge vlan add dev br1 vid 333 self\n\tcheck_err $? \"Can't add a non-PVID VLAN\"\n\tbridge vlan del dev br1 vid 333 self\n\tcheck_err $? \"Can't remove a non-PVID VLAN\"\n\n\tlog_test \"vlan\"\n}\n\nping_ipv4()\n{\n\tping_test $h1.555 192.0.2.130\n}\n\nping_ipv6()\n{\n\tping6_test $h1.555 2001:db8:2::2\n}\n\nping_ipv4_fails()\n{\n\tping_test_fails $h1.555 192.0.2.130 \": via 555\"\n}\n\nping_ipv6_fails()\n{\n\tping6_test_fails $h1.555 2001:db8:2::2 \": via 555\"\n}\n\nping_ipv4_777()\n{\n\tping_test $h1.777 192.0.2.146 \": via 777\"\n}\n\nping_ipv6_777()\n{\n\tping6_test $h1.777 2001:db8:4::2 \": via 777\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}