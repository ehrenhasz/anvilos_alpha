{
  "module_name": "tc_mpls_l2vpn.sh",
  "hash_id": "dddbb5776f98a93ad37708d950a8ef6babbcc74e8355a0f15b37e18c0a6d8327",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_mpls_l2vpn.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +-----------------------+\n# | H1 (v$h1)             |\n# | 192.0.2.1/24          |\n# | 2001:db8::1/124       |\n# |                 + $h1 |\n# +-----------------|-----+\n#                   |\n#                   | (Plain Ethernet traffic)\n#                   |\n# +-----------------|-----------------------------------------+\n# | LER1            + $edge1                                  |\n# |                     -ingress:                             |\n# |                       -encapsulate Ethernet into MPLS     |\n# |                       -add outer Ethernet header          |\n# |                       -redirect to $mpls1 (egress)        |\n# |                                                           |\n# |                 + $mpls1                                  |\n# |                 |   -ingress:                             |\n# |                 |     -remove outer Ethernet header       |\n# |                 |     -remove MPLS header                 |\n# |                 |     -redirect to $edge1 (egress)        |\n# +-----------------|-----------------------------------------+\n#                   |\n#                   | (Ethernet over MPLS traffic)\n#                   |\n# +-----------------|-----------------------------------------+\n# | LER2            + $mpls2                                  |\n# |                     -ingress:                             |\n# |                       -remove outer Ethernet header       |\n# |                       -remove MPLS header                 |\n# |                       -redirect to $edge2 (egress)        |\n# |                                                           |\n# |                 + $edge2                                  |\n# |                 |   -ingress:                             |\n# |                 |     -encapsulate Ethernet into MPLS     |\n# |                 |     -add outer Ethernet header          |\n# |                 |     -redirect to $mpls2 (egress)        |\n# +-----------------|-----------------------------------------|\n#                   |\n#                   | (Plain Ethernet traffic)\n#                   |\n# +-----------------|-----+\n# | H2 (v$h2)       |     |\n# |                 + $h2 |\n# | 192.0.2.2/24          |\n# | 2001:db8::2/124       |\n# +-----------------------+\n#\n# LER1 and LER2 logically represent two different routers. However, no VRF is\n# created for them, as they don't do any IP routing.\n\nALL_TESTS=\"mpls_forward_eth\"\nNUM_NETIFS=6\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24 2001:db8::1/124\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/24 2001:db8::1/124\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/24 2001:db8::2/124\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/24 2001:db8::2/124\n}\n\nler1_create()\n{\n\ttc qdisc add dev $edge1 ingress\n\ttc filter add dev $edge1 ingress                            \\\n\t   matchall                                                 \\\n\t   action mpls mac_push label 102                           \\\n\t   action vlan push_eth dst_mac $mpls2mac src_mac $mpls1mac \\\n\t   action mirred egress redirect dev $mpls1\n\tip link set dev $edge1 up\n\n\ttc qdisc add dev $mpls1 ingress\n\ttc filter add dev $mpls1 ingress            \\\n\t   protocol mpls_uc                         \\\n\t   flower mpls_label 101                    \\\n\t   action vlan pop_eth                      \\\n\t   action mpls pop protocol teb             \\\n\t   action mirred egress redirect dev $edge1\n\tip link set dev $mpls1 up\n}\n\nler1_destroy()\n{\n\tip link set dev $mpls1 down\n\ttc qdisc del dev $mpls1 ingress\n\n\tip link set dev $edge1 down\n\ttc qdisc del dev $edge1 ingress\n}\n\nler2_create()\n{\n\ttc qdisc add dev $edge2 ingress\n\ttc filter add dev $edge2 ingress                            \\\n\t   matchall                                                 \\\n\t   action mpls mac_push label 101                           \\\n\t   action vlan push_eth dst_mac $mpls1mac src_mac $mpls2mac \\\n\t   action mirred egress redirect dev $mpls2\n\tip link set dev $edge2 up\n\n\ttc qdisc add dev $mpls2 ingress\n\ttc filter add dev $mpls2 ingress            \\\n\t   protocol mpls_uc                         \\\n\t   flower mpls_label 102                    \\\n\t   action vlan pop_eth                      \\\n\t   action mpls pop protocol teb             \\\n\t   action mirred egress redirect dev $edge2\n\tip link set dev $mpls2 up\n}\n\nler2_destroy()\n{\n\tip link set dev $mpls2 down\n\ttc qdisc del dev $mpls2 ingress\n\n\tip link set dev $edge2 down\n\ttc qdisc del dev $edge2 ingress\n}\n\nmpls_forward_eth()\n{\n\tping_test $h1 192.0.2.2\n\tping6_test $h1 2001:db8::2\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tedge1=${NETIFS[p2]}\n\n\tmpls1=${NETIFS[p3]}\n\tmpls2=${NETIFS[p4]}\n\n\tedge2=${NETIFS[p5]}\n\th2=${NETIFS[p6]}\n\n\tmpls1mac=$(mac_get $mpls1)\n\tmpls2mac=$(mac_get $mpls2)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\tler1_create\n\tler2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tler2_destroy\n\tler1_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\ntc_offload_check\nif [[ $? -ne 0 ]]; then\n\tlog_info \"Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttests_run\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}