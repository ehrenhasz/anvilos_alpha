{
  "module_name": "ip6gre_lib.sh",
  "hash_id": "00ae3bdcd3dceab30169928ca7562bbec179a627068336f2d4479472388d30d4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/ip6gre_lib.sh",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n#!/bin/bash\n\n# Handles creation and destruction of IP-in-IP or GRE tunnels over the given\n# topology. Supports both flat and hierarchical models.\n#\n# Flat Model:\n# Overlay and underlay share the same VRF.\n# SW1 uses default VRF so tunnel has no bound dev.\n# SW2 uses non-default VRF tunnel has a bound dev.\n# +--------------------------------+\n# | H1                             |\n# |                     $h1 +      |\n# |        198.51.100.1/24  |      |\n# |        2001:db8:1::1/64 |      |\n# +-------------------------|------+\n#                           |\n# +-------------------------|-------------------+\n# | SW1                     |                   |\n# |                    $ol1 +                   |\n# |        198.51.100.2/24                      |\n# |        2001:db8:1::2/64                     |\n# |                                             |\n# |      + g1a (ip6gre)                         |\n# |        loc=2001:db8:3::1                    |\n# |        rem=2001:db8:3::2 --.                |\n# |        tos=inherit         |                |\n# |                            .                |\n# |      .---------------------                 |\n# |      |                                      |\n# |      v                                      |\n# |      + $ul1.111 (vlan)                      |\n# |      | 2001:db8:10::1/64                    |\n# |       \\                                     |\n# |        \\____________                        |\n# |                     |                       |\n# | VRF default         + $ul1                  |\n# +---------------------|-----------------------+\n#                       |\n# +---------------------|-----------------------+\n# | SW2                 |                       |\n# |                $ul2 +                       |\n# |          ___________|                       |\n# |         /                                   |\n# |        /                                    |\n# |       + $ul2.111 (vlan)                     |\n# |       ^ 2001:db8:10::2/64                   |\n# |       |                                     |\n# |       |                                     |\n# |       '----------------------.              |\n# |       + g2a (ip6gre)         |              |\n# |         loc=2001:db8:3::2    |              |\n# |         rem=2001:db8:3::1  --'              |\n# |         tos=inherit                         |\n# |                                             |\n# |                     + $ol2                  |\n# |                     | 203.0.113.2/24        |\n# | VRF v$ol2           | 2001:db8:2::2/64      |\n# +---------------------|-----------------------+\n# +---------------------|----------+\n# | H2                  |          |\n# |                 $h2 +          |\n# |    203.0.113.1/24              |\n# |    2001:db8:2::1/64            |\n# +--------------------------------+\n#\n# Hierarchical model:\n# The tunnel is bound to a device in a different VRF\n#\n# +--------------------------------+\n# | H1                             |\n# |                     $h1 +      |\n# |        198.51.100.1/24  |      |\n# |        2001:db8:1::1/64 |      |\n# +-------------------------|------+\n#                           |\n# +-------------------------|-------------------+\n# | SW1                     |                   |\n# | +-----------------------|-----------------+ |\n# | |                  $ol1 +                 | |\n# | |      198.51.100.2/24                    | |\n# | |      2001:db8:1::2/64                   | |\n# | |                                         | |\n# | |              + g1a (ip6gre)             | |\n# | |                loc=2001:db8:3::1        | |\n# | |                rem=2001:db8:3::2        | |\n# | |                tos=inherit              | |\n# | |                    ^                    | |\n# | |   VRF v$ol1        |                    | |\n# | +--------------------|--------------------+ |\n# |                      |                      |\n# | +--------------------|--------------------+ |\n# | |   VRF v$ul1        |                    | |\n# | |                    |                    | |\n# | |                    v                    | |\n# | |             dummy1 +                    | |\n# | |       2001:db8:3::1/64                  | |\n# | |         .-----------'                   | |\n# | |         |                               | |\n# | |         v                               | |\n# | |         + $ul1.111 (vlan)               | |\n# | |         | 2001:db8:10::1/64             | |\n# | |         \\                               | |\n# | |          \\__________                    | |\n# | |                     |                   | |\n# | |                     + $ul1              | |\n# | +---------------------|-------------------+ |\n# +-----------------------|---------------------+\n#                         |\n# +-----------------------|---------------------+\n# | SW2                   |                     |\n# | +---------------------|-------------------+ |\n# | |                     + $ul2              | |\n# | |                _____|                   | |\n# | |               /                         | |\n# | |              /                          | |\n# | |              | $ul2.111 (vlan)          | |\n# | |              + 2001:db8:10::2/64        | |\n# | |              ^                          | |\n# | |              |                          | |\n# | |              '------.                   | |\n# | |              dummy2 +                   | |\n# | |              2001:db8:3::2/64           | |\n# | |                     ^                   | |\n# | |                     |                   | |\n# | |                     |                   | |\n# | | VRF v$ul2           |                   | |\n# | +---------------------|-------------------+ |\n# |                       |                     |\n# | +---------------------|-------------------+ |\n# | | VRF v$ol2           |                   | |\n# | |                     |                   | |\n# | |                     v                   | |\n# | |        g2a (ip6gre) +                   | |\n# | |        loc=2001:db8:3::2                | |\n# | |        rem=2001:db8:3::1                | |\n# | |        tos=inherit                      | |\n# | |                                         | |\n# | |                $ol2 +                   | |\n# | |    203.0.113.2/24   |                   | |\n# | |    2001:db8:2::2/64 |                   | |\n# | +---------------------|-------------------+ |\n# +-----------------------|---------------------+\n#                         |\n# +-----------------------|--------+\n# | H2                    |        |\n# |                   $h2 +        |\n# |      203.0.113.1/24            |\n# |      2001:db8:2::1/64          |\n# +--------------------------------+\n\nsource lib.sh\nsource tc_common.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 198.51.100.1/24 2001:db8:1::1/64\n\tip route add vrf v$h1 203.0.113.0/24 via 198.51.100.2\n\tip -6 route add vrf v$h1 2001:db8:2::/64 via 2001:db8:1::2\n}\n\nh1_destroy()\n{\n\tip -6 route del vrf v$h1 2001:db8:2::/64 via 2001:db8:1::2\n\tip route del vrf v$h1 203.0.113.0/24 via 198.51.100.2\n\tsimple_if_fini $h1 198.51.100.1/24 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 203.0.113.1/24 2001:db8:2::1/64\n\tip route add vrf v$h2 198.51.100.0/24 via 203.0.113.2\n\tip -6 route add vrf v$h2 2001:db8:1::/64 via 2001:db8:2::2\n}\n\nh2_destroy()\n{\n\tip -6 route del vrf v$h2 2001:db8:1::/64 via 2001:db8:2::2\n\tip route del vrf v$h2 198.51.100.0/24 via 203.0.113.2\n\tsimple_if_fini $h2 203.0.113.1/24 2001:db8:2::1/64\n}\n\nsw1_flat_create()\n{\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tip link set dev $ol1 up\n        __addr_add_del $ol1 add 198.51.100.2/24 2001:db8:1::2/64\n\n\tip link set dev $ul1 up\n\tvlan_create $ul1 111 \"\" 2001:db8:10::1/64\n\n\ttunnel_create g1a ip6gre 2001:db8:3::1 2001:db8:3::2 tos inherit \\\n\t\tttl inherit \"$@\"\n\tip link set dev g1a up\n        __addr_add_del g1a add \"2001:db8:3::1/128\"\n\n\tip -6 route add 2001:db8:3::2/128 via 2001:db8:10::2\n\tip route add 203.0.113.0/24 dev g1a\n\tip -6 route add 2001:db8:2::/64 dev g1a\n}\n\nsw1_flat_destroy()\n{\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tip -6 route del 2001:db8:2::/64\n\tip route del 203.0.113.0/24\n\tip -6 route del 2001:db8:3::2/128 via 2001:db8:10::2\n\n\t__simple_if_fini g1a 2001:db8:3::1/128\n\ttunnel_destroy g1a\n\n\tvlan_destroy $ul1 111\n\t__simple_if_fini $ul1\n\t__simple_if_fini $ol1 198.51.100.2/24 2001:db8:1::2/64\n}\n\nsw2_flat_create()\n{\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tsimple_if_init $ol2 203.0.113.2/24 2001:db8:2::2/64\n\t__simple_if_init $ul2 v$ol2\n\tvlan_create $ul2 111 v$ol2 2001:db8:10::2/64\n\n\ttunnel_create g2a ip6gre 2001:db8:3::2 2001:db8:3::1 tos inherit \\\n\t\tttl inherit dev v$ol2 \"$@\"\n\t__simple_if_init g2a v$ol2 2001:db8:3::2/128\n\n\t# Replace neighbor to avoid 1 dropped packet due to \"unresolved neigh\"\n\tip neigh replace dev $ol2 203.0.113.1 lladdr $(mac_get $h2)\n\tip -6 neigh replace dev $ol2 2001:db8:2::1 lladdr $(mac_get $h2)\n\n\tip -6 route add vrf v$ol2 2001:db8:3::1/128 via 2001:db8:10::1\n\tip route add vrf v$ol2 198.51.100.0/24 dev g2a\n\tip -6 route add vrf v$ol2 2001:db8:1::/64 dev g2a\n}\n\nsw2_flat_destroy()\n{\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tip -6 route del vrf v$ol2 2001:db8:2::/64\n\tip route del vrf v$ol2 198.51.100.0/24\n\tip -6 route del vrf v$ol2 2001:db8:3::1/128 via 2001:db8:10::1\n\n\t__simple_if_fini g2a 2001:db8:3::2/128\n\ttunnel_destroy g2a\n\n\tvlan_destroy $ul2 111\n\t__simple_if_fini $ul2\n\tsimple_if_fini $ol2 203.0.113.2/24 2001:db8:2::2/64\n}\n\nsw1_hierarchical_create()\n{\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tsimple_if_init $ol1 198.51.100.2/24 2001:db8:1::2/64\n\tsimple_if_init $ul1\n\tip link add name dummy1 type dummy\n\t__simple_if_init dummy1 v$ul1 2001:db8:3::1/64\n\n\tvlan_create $ul1 111 v$ul1 2001:db8:10::1/64\n\ttunnel_create g1a ip6gre 2001:db8:3::1 2001:db8:3::2 tos inherit \\\n\t\tttl inherit dev dummy1 \"$@\"\n\tip link set dev g1a master v$ol1\n\n\tip -6 route add vrf v$ul1 2001:db8:3::2/128 via 2001:db8:10::2\n\tip route add vrf v$ol1 203.0.113.0/24 dev g1a\n\tip -6 route add vrf v$ol1 2001:db8:2::/64 dev g1a\n}\n\nsw1_hierarchical_destroy()\n{\n\tlocal ol1=$1; shift\n\tlocal ul1=$1; shift\n\n\tip -6 route del vrf v$ol1 2001:db8:2::/64\n\tip route del vrf v$ol1 203.0.113.0/24\n\tip -6 route del vrf v$ul1 2001:db8:3::2/128\n\n\ttunnel_destroy g1a\n\tvlan_destroy $ul1 111\n\n\t__simple_if_fini dummy1 2001:db8:3::1/64\n\tip link del dev dummy1\n\n\tsimple_if_fini $ul1\n\tsimple_if_fini $ol1 198.51.100.2/24 2001:db8:1::2/64\n}\n\nsw2_hierarchical_create()\n{\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tsimple_if_init $ol2 203.0.113.2/24 2001:db8:2::2/64\n\tsimple_if_init $ul2\n\n\tip link add name dummy2 type dummy\n\t__simple_if_init dummy2 v$ul2 2001:db8:3::2/64\n\n\tvlan_create $ul2 111 v$ul2 2001:db8:10::2/64\n\ttunnel_create g2a ip6gre 2001:db8:3::2 2001:db8:3::1 tos inherit \\\n\t\tttl inherit dev dummy2 \"$@\"\n\tip link set dev g2a master v$ol2\n\n\t# Replace neighbor to avoid 1 dropped packet due to \"unresolved neigh\"\n\tip neigh replace dev $ol2 203.0.113.1 lladdr $(mac_get $h2)\n\tip -6 neigh replace dev $ol2 2001:db8:2::1 lladdr $(mac_get $h2)\n\n\tip -6 route add vrf v$ul2 2001:db8:3::1/128 via 2001:db8:10::1\n\tip route add vrf v$ol2 198.51.100.0/24 dev g2a\n\tip -6 route add vrf v$ol2 2001:db8:1::/64 dev g2a\n}\n\nsw2_hierarchical_destroy()\n{\n\tlocal ol2=$1; shift\n\tlocal ul2=$1; shift\n\n\tip -6 route del vrf v$ol2 2001:db8:2::/64\n\tip route del vrf v$ol2 198.51.100.0/24\n\tip -6 route del vrf v$ul2 2001:db8:3::1/128\n\n\ttunnel_destroy g2a\n\tvlan_destroy $ul2 111\n\n\t__simple_if_fini dummy2 2001:db8:3::2/64\n\tip link del dev dummy2\n\n\tsimple_if_fini $ul2\n\tsimple_if_fini $ol2 203.0.113.2/24 2001:db8:2::2/64\n}\n\ntest_traffic_ip4ip6()\n{\n\tRET=0\n\n\th1mac=$(mac_get $h1)\n\tol1mac=$(mac_get $ol1)\n\n\ttc qdisc add dev $ul1 clsact\n\ttc filter add dev $ul1 egress proto all pref 1 handle 101 \\\n\t\tflower $TC_FLAG action pass\n\n\ttc qdisc add dev $ol2 clsact\n\ttc filter add dev $ol2 egress protocol ipv4 pref 1 handle 101 \\\n\t\tflower $TC_FLAG dst_ip 203.0.113.1 action pass\n\n\t$MZ $h1 -c 1000 -p 64 -a $h1mac -b $ol1mac -A 198.51.100.1 \\\n\t\t-B 203.0.113.1 -t ip -q -d 1msec\n\n\t# Check ports after encap and after decap.\n\ttc_check_at_least_x_packets \"dev $ul1 egress\" 101 1000\n\tcheck_err $? \"Packets did not go through $ul1, tc_flag = $TC_FLAG\"\n\n\ttc_check_at_least_x_packets \"dev $ol2 egress\" 101 1000\n\tcheck_err $? \"Packets did not go through $ol2, tc_flag = $TC_FLAG\"\n\n\tlog_test \"$@\"\n\n\ttc filter del dev $ol2 egress protocol ipv4 pref 1 handle 101 flower\n\ttc qdisc del dev $ol2 clsact\n\ttc filter del dev $ul1 egress proto all pref 1 handle 101 flower\n\ttc qdisc del dev $ul1 clsact\n}\n\ntest_traffic_ip6ip6()\n{\n\tRET=0\n\n\th1mac=$(mac_get $h1)\n\tol1mac=$(mac_get $ol1)\n\n\ttc qdisc add dev $ul1 clsact\n\ttc filter add dev $ul1 egress proto all pref 1 handle 101 \\\n\t\tflower $TC_FLAG action pass\n\n\ttc qdisc add dev $ol2 clsact\n\ttc filter add dev $ol2 egress protocol ipv6 pref 1 handle 101 \\\n\t\tflower $TC_FLAG dst_ip 2001:db8:2::1 action pass\n\n\t$MZ -6 $h1 -c 1000 -p 64 -a $h1mac -b $ol1mac -A 2001:db8:1::1 \\\n\t\t-B 2001:db8:2::1 -t ip -q -d 1msec\n\n\t# Check ports after encap and after decap.\n\ttc_check_at_least_x_packets \"dev $ul1 egress\" 101 1000\n\tcheck_err $? \"Packets did not go through $ul1, tc_flag = $TC_FLAG\"\n\n\ttc_check_at_least_x_packets \"dev $ol2 egress\" 101 1000\n\tcheck_err $? \"Packets did not go through $ol2, tc_flag = $TC_FLAG\"\n\n\tlog_test \"$@\"\n\n\ttc filter del dev $ol2 egress protocol ipv6 pref 1 handle 101 flower\n\ttc qdisc del dev $ol2 clsact\n\ttc filter del dev $ul1 egress proto all pref 1 handle 101 flower\n\ttc qdisc del dev $ul1 clsact\n}\n\ntopo_mtu_change()\n{\n\tlocal mtu=$1\n\n\tip link set mtu $mtu dev $h1\n\tip link set mtu $mtu dev $ol1\n\tip link set mtu $mtu dev g1a\n\tip link set mtu $mtu dev $ul1\n\tip link set mtu $mtu dev $ul1.111\n\tip link set mtu $mtu dev $h2\n\tip link set mtu $mtu dev $ol2\n\tip link set mtu $mtu dev g2a\n\tip link set mtu $mtu dev $ul2\n\tip link set mtu $mtu dev $ul2.111\n}\n\ntest_mtu_change()\n{\n\tRET=0\n\n\tping6_do $h1 2001:db8:2::1 \"-s 1800 -w 3\"\n\tcheck_fail $? \"ping GRE IPv6 should not pass with packet size 1800\"\n\n\tRET=0\n\n\ttopo_mtu_change\t2000\n\tping6_do $h1 2001:db8:2::1 \"-s 1800 -w 3\"\n\tcheck_err $?\n\tlog_test \"ping GRE IPv6, packet size 1800 after MTU change\"\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}