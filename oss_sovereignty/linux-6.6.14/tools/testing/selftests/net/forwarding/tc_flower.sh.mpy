{
  "module_name": "tc_flower.sh",
  "hash_id": "fa98043fdee4e2aace930a76a497963454a0e97c9a7d62f674b2dc91eb4fc9d0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_flower.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"match_dst_mac_test match_src_mac_test match_dst_ip_test \\\n\tmatch_src_ip_test match_ip_flags_test match_pcp_test match_vlan_test \\\n\tmatch_ip_tos_test match_indev_test match_ip_ttl_test\n\tmatch_mpls_label_test \\\n\tmatch_mpls_tc_test match_mpls_bos_test match_mpls_ttl_test \\\n\tmatch_mpls_lse_test\"\nNUM_NETIFS=2\nsource tc_common.sh\nsource lib.sh\n\ntcflags=\"skip_hw\"\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24 198.51.100.1/24\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/24 198.51.100.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/24 198.51.100.2/24\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2 192.0.2.2/24 198.51.100.2/24\n}\n\nmatch_dst_mac_test()\n{\n\tlocal dummy_mac=de:ad:be:ef:aa:aa\n\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags dst_mac $dummy_mac action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags dst_mac $h2mac action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 0\n\tcheck_fail $? \"Did not match on correct filter\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\n\tlog_test \"dst_mac match ($tcflags)\"\n}\n\nmatch_src_mac_test()\n{\n\tlocal dummy_mac=de:ad:be:ef:aa:aa\n\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags src_mac $dummy_mac action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags src_mac $h1mac action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 0\n\tcheck_fail $? \"Did not match on correct filter\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\n\tlog_test \"src_mac match ($tcflags)\"\n}\n\nmatch_dst_ip_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags dst_ip 198.51.100.2 action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags dst_ip 192.0.2.2 action drop\n\ttc filter add dev $h2 ingress protocol ip pref 3 handle 103 flower \\\n\t\t$tcflags dst_ip 192.0.2.0/24 action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 103 1\n\tcheck_err $? \"Did not match on correct filter with mask\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 3 handle 103 flower\n\n\tlog_test \"dst_ip match ($tcflags)\"\n}\n\nmatch_src_ip_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags src_ip 198.51.100.1 action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags src_ip 192.0.2.1 action drop\n\ttc filter add dev $h2 ingress protocol ip pref 3 handle 103 flower \\\n\t\t$tcflags src_ip 192.0.2.0/24 action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 103 1\n\tcheck_err $? \"Did not match on correct filter with mask\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 3 handle 103 flower\n\n\tlog_test \"src_ip match ($tcflags)\"\n}\n\nmatch_ip_flags_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags ip_flags frag action continue\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags ip_flags firstfrag action continue\n\ttc filter add dev $h2 ingress protocol ip pref 3 handle 103 flower \\\n\t\t$tcflags ip_flags nofirstfrag action continue\n\ttc filter add dev $h2 ingress protocol ip pref 4 handle 104 flower \\\n\t\t$tcflags ip_flags nofrag action drop\n\n\t$MZ $h1 -c 1 -p 1000 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"frag=0\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on wrong frag filter (nofrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_fail $? \"Matched on wrong firstfrag filter (nofrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 103 1\n\tcheck_err $? \"Did not match on nofirstfrag filter (nofrag) \"\n\n\ttc_check_packets \"dev $h2 ingress\" 104 1\n\tcheck_err $? \"Did not match on nofrag filter (nofrag)\"\n\n\t$MZ $h1 -c 1 -p 1000 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"frag=0,mf\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on frag filter (1stfrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match fistfrag filter (1stfrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 103 1\n\tcheck_err $? \"Matched on wrong nofirstfrag filter (1stfrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 104 1\n\tcheck_err $? \"Match on wrong nofrag filter (1stfrag)\"\n\n\t$MZ $h1 -c 1 -p 1000 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"frag=256,mf\" -q\n\t$MZ $h1 -c 1 -p 1000 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"frag=256\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 3\n\tcheck_err $? \"Did not match on frag filter (no1stfrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Matched on wrong firstfrag filter (no1stfrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 103 3\n\tcheck_err $? \"Did not match on nofirstfrag filter (no1stfrag)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 104 1\n\tcheck_err $? \"Matched on nofrag filter (no1stfrag)\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol ip pref 3 handle 103 flower\n\ttc filter del dev $h2 ingress protocol ip pref 4 handle 104 flower\n\n\tlog_test \"ip_flags match ($tcflags)\"\n}\n\nmatch_pcp_test()\n{\n\tRET=0\n\n\tvlan_create $h2 85 v$h2 192.0.2.11/24\n\n\ttc filter add dev $h2 ingress protocol 802.1q pref 1 handle 101 \\\n\t\tflower vlan_prio 6 $tcflags dst_mac $h2mac action drop\n\ttc filter add dev $h2 ingress protocol 802.1q pref 2 handle 102 \\\n\t\tflower vlan_prio 7 $tcflags dst_mac $h2mac action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -B 192.0.2.11 -Q 7:85 -t ip -q\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -B 192.0.2.11 -Q 0:85 -t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 0\n\tcheck_err $? \"Matched on specified PCP when should not\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on specified PCP\"\n\n\ttc filter del dev $h2 ingress protocol 802.1q pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol 802.1q pref 1 handle 101 flower\n\n\tvlan_destroy $h2 85\n\n\tlog_test \"PCP match ($tcflags)\"\n}\n\nmatch_vlan_test()\n{\n\tRET=0\n\n\tvlan_create $h2 85 v$h2 192.0.2.11/24\n\tvlan_create $h2 75 v$h2 192.0.2.10/24\n\n\ttc filter add dev $h2 ingress protocol 802.1q pref 1 handle 101 \\\n\t\tflower vlan_id 75 $tcflags action drop\n\ttc filter add dev $h2 ingress protocol 802.1q pref 2 handle 102 \\\n\t\tflower vlan_id 85 $tcflags action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -B 192.0.2.11 -Q 0:85 -t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 0\n\tcheck_err $? \"Matched on specified VLAN when should not\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on specified VLAN\"\n\n\ttc filter del dev $h2 ingress protocol 802.1q pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol 802.1q pref 1 handle 101 flower\n\n\tvlan_destroy $h2 75\n\tvlan_destroy $h2 85\n\n\tlog_test \"VLAN match ($tcflags)\"\n}\n\nmatch_ip_tos_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags dst_ip 192.0.2.2 ip_tos 0x20 action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags dst_ip 192.0.2.2 ip_tos 0x18 action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip tos=18 -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter (0x18)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter (0x18)\"\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip tos=20 -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 2\n\tcheck_fail $? \"Matched on a wrong filter (0x20)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct filter (0x20)\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\n\tlog_test \"ip_tos match ($tcflags)\"\n}\n\nmatch_ip_ttl_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags dst_ip 192.0.2.2 ip_ttl 63 action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags dst_ip 192.0.2.2 action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"ttl=63\" -q\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"ttl=63,mf,frag=256\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_fail $? \"Matched on the wrong filter (no check on ttl)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 2\n\tcheck_err $? \"Did not match on correct filter (ttl=63)\"\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip \"ttl=255\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 3\n\tcheck_fail $? \"Matched on a wrong filter (ttl=63)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter (no check on ttl)\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\n\tlog_test \"ip_ttl match ($tcflags)\"\n}\n\nmatch_indev_test()\n{\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\t$tcflags indev $h1 dst_mac $h2mac action drop\n\ttc filter add dev $h2 ingress protocol ip pref 2 handle 102 flower \\\n\t\t$tcflags indev $h2 dst_mac $h2mac action drop\n\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac -A 192.0.2.1 -B 192.0.2.2 \\\n\t\t-t ip -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\n\tlog_test \"indev match ($tcflags)\"\n}\n\n# Unfortunately, mausezahn can't build MPLS headers when used in L2\n# mode, so we have this function to build Label Stack Entries.\nmpls_lse()\n{\n\tlocal label=$1\n\tlocal tc=$2\n\tlocal bos=$3\n\tlocal ttl=$4\n\n\tprintf \"%02x %02x %02x %02x\"                        \\\n\t\t$((label >> 12))                            \\\n\t\t$((label >> 4 & 0xff))                      \\\n\t\t$((((label & 0xf) << 4) + (tc << 1) + bos)) \\\n\t\t$ttl\n}\n\nmatch_mpls_label_test()\n{\n\tlocal ethtype=\"88 47\"; readonly ethtype\n\tlocal pkt\n\n\tRET=0\n\n\tcheck_tc_mpls_support $h2 || return 0\n\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 1 handle 101 \\\n\t\tflower $tcflags mpls_label 0 action drop\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 2 handle 102 \\\n\t\tflower $tcflags mpls_label 1048575 action drop\n\n\tpkt=\"$ethtype $(mpls_lse 1048575 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter (1048575)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter (1048575)\"\n\n\tpkt=\"$ethtype $(mpls_lse 0 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 2\n\tcheck_fail $? \"Matched on a wrong filter (0)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct filter (0)\"\n\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 1 handle 101 flower\n\n\tlog_test \"mpls_label match ($tcflags)\"\n}\n\nmatch_mpls_tc_test()\n{\n\tlocal ethtype=\"88 47\"; readonly ethtype\n\tlocal pkt\n\n\tRET=0\n\n\tcheck_tc_mpls_support $h2 || return 0\n\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 1 handle 101 \\\n\t\tflower $tcflags mpls_tc 0 action drop\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 2 handle 102 \\\n\t\tflower $tcflags mpls_tc 7 action drop\n\n\tpkt=\"$ethtype $(mpls_lse 0 7 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter (7)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter (7)\"\n\n\tpkt=\"$ethtype $(mpls_lse 0 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 2\n\tcheck_fail $? \"Matched on a wrong filter (0)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct filter (0)\"\n\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 1 handle 101 flower\n\n\tlog_test \"mpls_tc match ($tcflags)\"\n}\n\nmatch_mpls_bos_test()\n{\n\tlocal ethtype=\"88 47\"; readonly ethtype\n\tlocal pkt\n\n\tRET=0\n\n\tcheck_tc_mpls_support $h2 || return 0\n\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 1 handle 101 \\\n\t\tflower $tcflags mpls_bos 0 action drop\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 2 handle 102 \\\n\t\tflower $tcflags mpls_bos 1 action drop\n\n\tpkt=\"$ethtype $(mpls_lse 0 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter (1)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter (1)\"\n\n\t# Need to add a second label to properly mark the Bottom of Stack\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 255) $(mpls_lse 0 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 2\n\tcheck_fail $? \"Matched on a wrong filter (0)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct filter (0)\"\n\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 1 handle 101 flower\n\n\tlog_test \"mpls_bos match ($tcflags)\"\n}\n\nmatch_mpls_ttl_test()\n{\n\tlocal ethtype=\"88 47\"; readonly ethtype\n\tlocal pkt\n\n\tRET=0\n\n\tcheck_tc_mpls_support $h2 || return 0\n\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 1 handle 101 \\\n\t\tflower $tcflags mpls_ttl 0 action drop\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 2 handle 102 \\\n\t\tflower $tcflags mpls_ttl 255 action drop\n\n\tpkt=\"$ethtype $(mpls_lse 0 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_fail $? \"Matched on a wrong filter (255)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct filter (255)\"\n\n\tpkt=\"$ethtype $(mpls_lse 0 0 1 0)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 102 2\n\tcheck_fail $? \"Matched on a wrong filter (0)\"\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct filter (0)\"\n\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 1 handle 101 flower\n\n\tlog_test \"mpls_ttl match ($tcflags)\"\n}\n\nmatch_mpls_lse_test()\n{\n\tlocal ethtype=\"88 47\"; readonly ethtype\n\tlocal pkt\n\n\tRET=0\n\n\tcheck_tc_mpls_lse_stats $h2 || return 0\n\n\t# Match on first LSE (minimal values for each field)\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 1 handle 101 \\\n\t\tflower $tcflags mpls lse depth 1 label 0 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 2 handle 102 \\\n\t\tflower $tcflags mpls lse depth 1 tc 0 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 3 handle 103 \\\n\t\tflower $tcflags mpls lse depth 1 bos 0 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 4 handle 104 \\\n\t\tflower $tcflags mpls lse depth 1 ttl 0 action continue\n\n\t# Match on second LSE (maximal values for each field)\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 5 handle 105 \\\n\t\tflower $tcflags mpls lse depth 2 label 1048575 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 6 handle 106 \\\n\t\tflower $tcflags mpls lse depth 2 tc 7 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 7 handle 107 \\\n\t\tflower $tcflags mpls lse depth 2 bos 1 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 8 handle 108 \\\n\t\tflower $tcflags mpls lse depth 2 ttl 255 action continue\n\n\t# Match on LSE depth\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 9 handle 109 \\\n\t\tflower $tcflags mpls lse depth 1 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 10 handle 110 \\\n\t\tflower $tcflags mpls lse depth 2 action continue\n\ttc filter add dev $h2 ingress protocol mpls_uc pref 11 handle 111 \\\n\t\tflower $tcflags mpls lse depth 3 action continue\n\n\t# Base packet, matched by all filters (except for stack depth 3)\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 0) $(mpls_lse 1048575 7 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Make a variant of the above packet, with a non-matching value\n\t# for each LSE field\n\n\t# Wrong label at depth 1\n\tpkt=\"$ethtype $(mpls_lse 1 0 0 0) $(mpls_lse 1048575 7 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong TC at depth 1\n\tpkt=\"$ethtype $(mpls_lse 0 1 0 0) $(mpls_lse 1048575 7 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong BOS at depth 1 (not adding a second LSE here since BOS is set\n\t# in the first label, so anything that'd follow wouldn't be considered)\n\tpkt=\"$ethtype $(mpls_lse 0 0 1 0)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong TTL at depth 1\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 1) $(mpls_lse 1048575 7 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong label at depth 2\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 0) $(mpls_lse 1048574 7 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong TC at depth 2\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 0) $(mpls_lse 1048575 6 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong BOS at depth 2 (adding a third LSE here since BOS isn't set in\n\t# the second label)\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 0) $(mpls_lse 1048575 7 0 255)\"\n\tpkt=\"$pkt $(mpls_lse 0 0 1 255)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Wrong TTL at depth 2\n\tpkt=\"$ethtype $(mpls_lse 0 0 0 0) $(mpls_lse 1048575 7 1 254)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\t# Filters working at depth 1 should match all packets but one\n\n\ttc_check_packets \"dev $h2 ingress\" 101 8\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 8\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 103 8\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 104 8\n\tcheck_err $? \"Did not match on correct filter\"\n\n\t# Filters working at depth 2 should match all packets but two (because\n\t# of the test packet where the label stack depth is just one)\n\n\ttc_check_packets \"dev $h2 ingress\" 105 7\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 106 7\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 107 7\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 108 7\n\tcheck_err $? \"Did not match on correct filter\"\n\n\t# Finally, verify the filters that only match on LSE depth\n\n\ttc_check_packets \"dev $h2 ingress\" 109 9\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 110 8\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc_check_packets \"dev $h2 ingress\" 111 1\n\tcheck_err $? \"Did not match on correct filter\"\n\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 11 handle 111 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 10 handle 110 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 9 handle 109 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 8 handle 108 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 7 handle 107 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 6 handle 106 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 5 handle 105 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 4 handle 104 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 3 handle 103 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 2 handle 102 flower\n\ttc filter del dev $h2 ingress protocol mpls_uc pref 1 handle 101 flower\n\n\tlog_test \"mpls lse match ($tcflags)\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\th1mac=$(mac_get $h1)\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\ntc_offload_check\nif [[ $? -ne 0 ]]; then\n\tlog_info \"Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttests_run\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}