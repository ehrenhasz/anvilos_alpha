{
  "module_name": "pedit_l4port.sh",
  "hash_id": "46828353b5e5e9b24ece37ad105060bc78f95ad4a4c64efe2ddd90d7746f8f2d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/pedit_l4port.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test sends traffic from H1 to H2. Either on ingress of $swp1, or on egress of $swp2, the\n# traffic is acted upon by a pedit action. An ingress filter installed on $h2 verifies that the\n# packet looks like expected.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |    + $h1             |                             |            $h2 +     |\n# |    | 192.0.2.1/28    |                             |   192.0.2.2/28 |     |\n# +----|-----------------+                             +----------------|-----+\n#      |                                                                |\n# +----|----------------------------------------------------------------|-----+\n# | SW |                                                                |     |\n# |  +-|----------------------------------------------------------------|-+   |\n# |  | + $swp1                       BR                           $swp2 + |   |\n# |  +--------------------------------------------------------------------+   |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\ttest_udp_sport\n\ttest_udp_dport\n\ttest_tcp_sport\n\ttest_tcp_dport\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\n: ${HIT_TIMEOUT:=2000} # ms\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28 2001:db8:1::2/64\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nswitch_create()\n{\n\tip link add name br1 up type bridge vlan_filtering 1\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp1 clsact\n\ttc qdisc add dev $swp2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:1::2\n}\n\ndo_test_pedit_l4port_one()\n{\n\tlocal pedit_locus=$1; shift\n\tlocal pedit_prot=$1; shift\n\tlocal pedit_action=$1; shift\n\tlocal match_prot=$1; shift\n\tlocal match_flower=$1; shift\n\tlocal mz_flags=$1; shift\n\tlocal saddr=$1; shift\n\tlocal daddr=$1; shift\n\n\ttc filter add $pedit_locus handle 101 pref 1 \\\n\t   flower action pedit ex munge $pedit_action\n\ttc filter add dev $h2 ingress handle 101 pref 1 prot $match_prot \\\n\t   flower skip_hw $match_flower action pass\n\n\tRET=0\n\n\t$MZ $mz_flags $h1 -c 10 -d 20msec -p 100 \\\n\t    -a own -b $h2mac -q -t $pedit_prot sp=54321,dp=12345\n\n\tlocal pkts\n\tpkts=$(busywait \"$TC_HIT_TIMEOUT\" until_counter_is \">= 10\" \\\n\t\t\ttc_rule_handle_stats_get \"dev $h2 ingress\" 101)\n\tcheck_err $? \"Expected to get 10 packets, but got $pkts.\"\n\n\tpkts=$(tc_rule_handle_stats_get \"$pedit_locus\" 101)\n\t((pkts >= 10))\n\tcheck_err $? \"Expected to get 10 packets on pedit rule, but got $pkts.\"\n\n\tlog_test \"$pedit_locus pedit $pedit_action\"\n\n\ttc filter del dev $h2 ingress pref 1\n\ttc filter del $pedit_locus pref 1\n}\n\ndo_test_pedit_l4port()\n{\n\tlocal locus=$1; shift\n\tlocal prot=$1; shift\n\tlocal pedit_port=$1; shift\n\tlocal flower_port=$1; shift\n\tlocal port\n\n\tfor port in 1 11111 65535; do\n\t\tdo_test_pedit_l4port_one \"$locus\" \"$prot\"\t\t\t\\\n\t\t\t\t\t \"$prot $pedit_port set $port\"\t\t\\\n\t\t\t\t\t ip \"ip_proto $prot $flower_port $port\"\t\\\n\t\t\t\t\t \"-A 192.0.2.1 -B 192.0.2.2\"\n\tdone\n}\n\ntest_udp_sport()\n{\n\tdo_test_pedit_l4port \"dev $swp1 ingress\" udp sport src_port\n\tdo_test_pedit_l4port \"dev $swp2 egress\"  udp sport src_port\n}\n\ntest_udp_dport()\n{\n\tdo_test_pedit_l4port \"dev $swp1 ingress\" udp dport dst_port\n\tdo_test_pedit_l4port \"dev $swp2 egress\"  udp dport dst_port\n}\n\ntest_tcp_sport()\n{\n\tdo_test_pedit_l4port \"dev $swp1 ingress\" tcp sport src_port\n\tdo_test_pedit_l4port \"dev $swp2 egress\"  tcp sport src_port\n}\n\ntest_tcp_dport()\n{\n\tdo_test_pedit_l4port \"dev $swp1 ingress\" tcp dport dst_port\n\tdo_test_pedit_l4port \"dev $swp2 egress\"  tcp dport dst_port\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}