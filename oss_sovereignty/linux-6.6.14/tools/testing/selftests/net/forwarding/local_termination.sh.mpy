{
  "module_name": "local_termination.sh",
  "hash_id": "dac716e3a2864d6878e3335d8038984147093632f4a9a428ef19eb719e351646",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/local_termination.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"standalone bridge\"\nNUM_NETIFS=2\nPING_COUNT=1\nREQUIRE_MTOOLS=yes\nREQUIRE_MZ=no\n\nsource lib.sh\n\nH1_IPV4=\"192.0.2.1\"\nH2_IPV4=\"192.0.2.2\"\nH1_IPV6=\"2001:db8:1::1\"\nH2_IPV6=\"2001:db8:1::2\"\n\nBRIDGE_ADDR=\"00:00:de:ad:be:ee\"\nMACVLAN_ADDR=\"00:00:de:ad:be:ef\"\nUNKNOWN_UC_ADDR1=\"de:ad:be:ef:ee:03\"\nUNKNOWN_UC_ADDR2=\"de:ad:be:ef:ee:04\"\nUNKNOWN_UC_ADDR3=\"de:ad:be:ef:ee:05\"\nJOINED_IPV4_MC_ADDR=\"225.1.2.3\"\nUNKNOWN_IPV4_MC_ADDR1=\"225.1.2.4\"\nUNKNOWN_IPV4_MC_ADDR2=\"225.1.2.5\"\nUNKNOWN_IPV4_MC_ADDR3=\"225.1.2.6\"\nJOINED_IPV6_MC_ADDR=\"ff2e::0102:0304\"\nUNKNOWN_IPV6_MC_ADDR1=\"ff2e::0102:0305\"\nUNKNOWN_IPV6_MC_ADDR2=\"ff2e::0102:0306\"\nUNKNOWN_IPV6_MC_ADDR3=\"ff2e::0102:0307\"\n\nJOINED_MACV4_MC_ADDR=\"01:00:5e:01:02:03\"\nUNKNOWN_MACV4_MC_ADDR1=\"01:00:5e:01:02:04\"\nUNKNOWN_MACV4_MC_ADDR2=\"01:00:5e:01:02:05\"\nUNKNOWN_MACV4_MC_ADDR3=\"01:00:5e:01:02:06\"\nJOINED_MACV6_MC_ADDR=\"33:33:01:02:03:04\"\nUNKNOWN_MACV6_MC_ADDR1=\"33:33:01:02:03:05\"\nUNKNOWN_MACV6_MC_ADDR2=\"33:33:01:02:03:06\"\nUNKNOWN_MACV6_MC_ADDR3=\"33:33:01:02:03:07\"\n\nNON_IP_MC=\"01:02:03:04:05:06\"\nNON_IP_PKT=\"00:04 48:45:4c:4f\"\nBC=\"ff:ff:ff:ff:ff:ff\"\n\n# Disable promisc to ensure we don't receive unknown MAC DA packets\nexport TCPDUMP_EXTRA_FLAGS=\"-pl\"\n\nh1=${NETIFS[p1]}\nh2=${NETIFS[p2]}\n\nsend_non_ip()\n{\n\tlocal if_name=$1\n\tlocal smac=$2\n\tlocal dmac=$3\n\n\t$MZ -q $if_name \"$dmac $smac $NON_IP_PKT\"\n}\n\nsend_uc_ipv4()\n{\n\tlocal if_name=$1\n\tlocal dmac=$2\n\n\tip neigh add $H2_IPV4 lladdr $dmac dev $if_name\n\tping_do $if_name $H2_IPV4\n\tip neigh del $H2_IPV4 dev $if_name\n}\n\ncheck_rcv()\n{\n\tlocal if_name=$1\n\tlocal type=$2\n\tlocal pattern=$3\n\tlocal should_receive=$4\n\tlocal should_fail=\n\n\t[ $should_receive = true ] && should_fail=0 || should_fail=1\n\tRET=0\n\n\ttcpdump_show $if_name | grep -q \"$pattern\"\n\n\tcheck_err_fail \"$should_fail\" \"$?\" \"reception\"\n\n\tlog_test \"$if_name: $type\"\n}\n\nmc_route_prepare()\n{\n\tlocal if_name=$1\n\tlocal vrf_name=$(master_name_get $if_name)\n\n\tip route add 225.100.1.0/24 dev $if_name vrf $vrf_name\n\tip -6 route add ff2e::/64 dev $if_name vrf $vrf_name\n}\n\nmc_route_destroy()\n{\n\tlocal if_name=$1\n\tlocal vrf_name=$(master_name_get $if_name)\n\n\tip route del 225.100.1.0/24 dev $if_name vrf $vrf_name\n\tip -6 route del ff2e::/64 dev $if_name vrf $vrf_name\n}\n\nrun_test()\n{\n\tlocal rcv_if_name=$1\n\tlocal smac=$(mac_get $h1)\n\tlocal rcv_dmac=$(mac_get $rcv_if_name)\n\n\ttcpdump_start $rcv_if_name\n\n\tmc_route_prepare $h1\n\tmc_route_prepare $rcv_if_name\n\n\tsend_uc_ipv4 $h1 $rcv_dmac\n\tsend_uc_ipv4 $h1 $MACVLAN_ADDR\n\tsend_uc_ipv4 $h1 $UNKNOWN_UC_ADDR1\n\n\tip link set dev $rcv_if_name promisc on\n\tsend_uc_ipv4 $h1 $UNKNOWN_UC_ADDR2\n\tmc_send $h1 $UNKNOWN_IPV4_MC_ADDR2\n\tmc_send $h1 $UNKNOWN_IPV6_MC_ADDR2\n\tip link set dev $rcv_if_name promisc off\n\n\tmc_join $rcv_if_name $JOINED_IPV4_MC_ADDR\n\tmc_send $h1 $JOINED_IPV4_MC_ADDR\n\tmc_leave\n\n\tmc_join $rcv_if_name $JOINED_IPV6_MC_ADDR\n\tmc_send $h1 $JOINED_IPV6_MC_ADDR\n\tmc_leave\n\n\tmc_send $h1 $UNKNOWN_IPV4_MC_ADDR1\n\tmc_send $h1 $UNKNOWN_IPV6_MC_ADDR1\n\n\tip link set dev $rcv_if_name allmulticast on\n\tsend_uc_ipv4 $h1 $UNKNOWN_UC_ADDR3\n\tmc_send $h1 $UNKNOWN_IPV4_MC_ADDR3\n\tmc_send $h1 $UNKNOWN_IPV6_MC_ADDR3\n\tip link set dev $rcv_if_name allmulticast off\n\n\tmc_route_destroy $rcv_if_name\n\tmc_route_destroy $h1\n\n\tsleep 1\n\n\ttcpdump_stop $rcv_if_name\n\n\tcheck_rcv $rcv_if_name \"Unicast IPv4 to primary MAC address\" \\\n\t\t\"$smac > $rcv_dmac, ethertype IPv4 (0x0800)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Unicast IPv4 to macvlan MAC address\" \\\n\t\t\"$smac > $MACVLAN_ADDR, ethertype IPv4 (0x0800)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Unicast IPv4 to unknown MAC address\" \\\n\t\t\"$smac > $UNKNOWN_UC_ADDR1, ethertype IPv4 (0x0800)\" \\\n\t\tfalse\n\n\tcheck_rcv $rcv_if_name \"Unicast IPv4 to unknown MAC address, promisc\" \\\n\t\t\"$smac > $UNKNOWN_UC_ADDR2, ethertype IPv4 (0x0800)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Unicast IPv4 to unknown MAC address, allmulti\" \\\n\t\t\"$smac > $UNKNOWN_UC_ADDR3, ethertype IPv4 (0x0800)\" \\\n\t\tfalse\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv4 to joined group\" \\\n\t\t\"$smac > $JOINED_MACV4_MC_ADDR, ethertype IPv4 (0x0800)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv4 to unknown group\" \\\n\t\t\"$smac > $UNKNOWN_MACV4_MC_ADDR1, ethertype IPv4 (0x0800)\" \\\n\t\tfalse\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv4 to unknown group, promisc\" \\\n\t\t\"$smac > $UNKNOWN_MACV4_MC_ADDR2, ethertype IPv4 (0x0800)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv4 to unknown group, allmulti\" \\\n\t\t\"$smac > $UNKNOWN_MACV4_MC_ADDR3, ethertype IPv4 (0x0800)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv6 to joined group\" \\\n\t\t\"$smac > $JOINED_MACV6_MC_ADDR, ethertype IPv6 (0x86dd)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv6 to unknown group\" \\\n\t\t\"$smac > $UNKNOWN_MACV6_MC_ADDR1, ethertype IPv6 (0x86dd)\" \\\n\t\tfalse\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv6 to unknown group, promisc\" \\\n\t\t\"$smac > $UNKNOWN_MACV6_MC_ADDR2, ethertype IPv6 (0x86dd)\" \\\n\t\ttrue\n\n\tcheck_rcv $rcv_if_name \"Multicast IPv6 to unknown group, allmulti\" \\\n\t\t\"$smac > $UNKNOWN_MACV6_MC_ADDR3, ethertype IPv6 (0x86dd)\" \\\n\t\ttrue\n\n\ttcpdump_cleanup $rcv_if_name\n}\n\nh1_create()\n{\n\tsimple_if_init $h1 $H1_IPV4/24 $H1_IPV6/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 $H1_IPV4/24 $H1_IPV6/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 $H2_IPV4/24 $H2_IPV6/64\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 $H2_IPV4/24 $H2_IPV6/64\n}\n\nbridge_create()\n{\n\tip link add br0 type bridge\n\tip link set br0 address $BRIDGE_ADDR\n\tip link set br0 up\n\n\tip link set $h2 master br0\n\tip link set $h2 up\n\n\tsimple_if_init br0 $H2_IPV4/24 $H2_IPV6/64\n}\n\nbridge_destroy()\n{\n\tsimple_if_fini br0 $H2_IPV4/24 $H2_IPV6/64\n\n\tip link del br0\n}\n\nstandalone()\n{\n\th1_create\n\th2_create\n\n\tip link add link $h2 name macvlan0 type macvlan mode private\n\tip link set macvlan0 address $MACVLAN_ADDR\n\tip link set macvlan0 up\n\n\trun_test $h2\n\n\tip link del macvlan0\n\n\th2_destroy\n\th1_destroy\n}\n\nbridge()\n{\n\th1_create\n\tbridge_create\n\n\tip link add link br0 name macvlan0 type macvlan mode private\n\tip link set macvlan0 address $MACVLAN_ADDR\n\tip link set macvlan0 up\n\n\trun_test br0\n\n\tip link del macvlan0\n\n\tbridge_destroy\n\th1_destroy\n}\n\ncleanup()\n{\n\tpre_cleanup\n\tvrf_cleanup\n}\n\nsetup_prepare()\n{\n\tvrf_prepare\n\t# setup_wait() needs this\n\tip link set $h1 up\n\tip link set $h2 up\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}