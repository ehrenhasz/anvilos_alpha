{
  "module_name": "tc_flower_l2_miss.sh",
  "hash_id": "10c4f7b706acce862ab8b09d719fb22edc20345186da29fe42f7cde8e600f054",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_flower_l2_miss.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +-----------------------+                             +----------------------+\n# | H1 (vrf)              |                             | H2 (vrf)             |\n# |    + $h1              |                             |              $h2 +   |\n# |    | 192.0.2.1/28     |                             |     192.0.2.2/28 |   |\n# |    | 2001:db8:1::1/64 |                             | 2001:db8:1::2/64 |   |\n# +----|------------------+                             +------------------|---+\n#      |                                                                   |\n# +----|-------------------------------------------------------------------|---+\n# | SW |                                                                   |   |\n# |  +-|-------------------------------------------------------------------|-+ |\n# |  | + $swp1                       BR                              $swp2 + | |\n# |  +-----------------------------------------------------------------------+ |\n# +----------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\ttest_l2_miss_unicast\n\ttest_l2_miss_multicast\n\ttest_l2_miss_ll_multicast\n\ttest_l2_miss_broadcast\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nswitch_create()\n{\n\tip link add name br1 up type bridge\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\ntest_l2_miss_unicast()\n{\n\tlocal dmac=00:01:02:03:04:05\n\tlocal dip=192.0.2.2\n\tlocal sip=192.0.2.1\n\n\tRET=0\n\n\t# Unknown unicast.\n\ttc filter add dev $swp2 egress protocol ipv4 handle 101 pref 1 \\\n\t   flower indev $swp1 l2_miss 1 dst_mac $dmac src_ip $sip \\\n\t   dst_ip $dip action pass\n\t# Known unicast.\n\ttc filter add dev $swp2 egress protocol ipv4 handle 102 pref 1 \\\n\t   flower indev $swp1 l2_miss 0 dst_mac $dmac src_ip $sip \\\n\t   dst_ip $dip action pass\n\n\t# Before adding FDB entry.\n\t$MZ $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 1\n\tcheck_err $? \"Unknown unicast filter was not hit before adding FDB entry\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 0\n\tcheck_err $? \"Known unicast filter was hit before adding FDB entry\"\n\n\t# Adding FDB entry.\n\tbridge fdb replace $dmac dev $swp2 master static\n\n\t$MZ $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 1\n\tcheck_err $? \"Unknown unicast filter was hit after adding FDB entry\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 1\n\tcheck_err $? \"Known unicast filter was not hit after adding FDB entry\"\n\n\t# Deleting FDB entry.\n\tbridge fdb del $dmac dev $swp2 master static\n\n\t$MZ $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 2\n\tcheck_err $? \"Unknown unicast filter was not hit after deleting FDB entry\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 1\n\tcheck_err $? \"Known unicast filter was hit after deleting FDB entry\"\n\n\ttc filter del dev $swp2 egress protocol ipv4 pref 1 handle 102 flower\n\ttc filter del dev $swp2 egress protocol ipv4 pref 1 handle 101 flower\n\n\tlog_test \"L2 miss - Unicast\"\n}\n\ntest_l2_miss_multicast_common()\n{\n\tlocal proto=$1; shift\n\tlocal sip=$1; shift\n\tlocal dip=$1; shift\n\tlocal dmac=$1; shift\n\tlocal mode=$1; shift\n\tlocal name=$1; shift\n\n\tRET=0\n\n\t# Unregistered multicast.\n\ttc filter add dev $swp2 egress protocol $proto handle 101 pref 1 \\\n\t   flower indev $swp1 l2_miss 1 src_ip $sip dst_ip $dip \\\n\t   action pass\n\t# Registered multicast.\n\ttc filter add dev $swp2 egress protocol $proto handle 102 pref 1 \\\n\t   flower indev $swp1 l2_miss 0 src_ip $sip dst_ip $dip \\\n\t   action pass\n\n\t# Before adding MDB entry.\n\t$MZ $mode $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 1\n\tcheck_err $? \"Unregistered multicast filter was not hit before adding MDB entry\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 0\n\tcheck_err $? \"Registered multicast filter was hit before adding MDB entry\"\n\n\t# Adding MDB entry.\n\tbridge mdb replace dev br1 port $swp2 grp $dip permanent\n\n\t$MZ $mode $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 1\n\tcheck_err $? \"Unregistered multicast filter was hit after adding MDB entry\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 1\n\tcheck_err $? \"Registered multicast filter was not hit after adding MDB entry\"\n\n\t# Deleting MDB entry.\n\tbridge mdb del dev br1 port $swp2 grp $dip\n\n\t$MZ $mode $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 2\n\tcheck_err $? \"Unregistered multicast filter was not hit after deleting MDB entry\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 1\n\tcheck_err $? \"Registered multicast filter was hit after deleting MDB entry\"\n\n\ttc filter del dev $swp2 egress protocol $proto pref 1 handle 102 flower\n\ttc filter del dev $swp2 egress protocol $proto pref 1 handle 101 flower\n\n\tlog_test \"L2 miss - Multicast ($name)\"\n}\n\ntest_l2_miss_multicast_ipv4()\n{\n\tlocal proto=\"ipv4\"\n\tlocal sip=192.0.2.1\n\tlocal dip=239.1.1.1\n\tlocal dmac=01:00:5e:01:01:01\n\tlocal mode=\"-4\"\n\tlocal name=\"IPv4\"\n\n\ttest_l2_miss_multicast_common $proto $sip $dip $dmac $mode $name\n}\n\ntest_l2_miss_multicast_ipv6()\n{\n\tlocal proto=\"ipv6\"\n\tlocal sip=2001:db8:1::1\n\tlocal dip=ff0e::1\n\tlocal dmac=33:33:00:00:00:01\n\tlocal mode=\"-6\"\n\tlocal name=\"IPv6\"\n\n\ttest_l2_miss_multicast_common $proto $sip $dip $dmac $mode $name\n}\n\ntest_l2_miss_multicast()\n{\n\t# Configure $swp2 as a multicast router port so that it will forward\n\t# both registered and unregistered multicast traffic.\n\tbridge link set dev $swp2 mcast_router 2\n\n\t# Forwarding according to MDB entries only takes place when the bridge\n\t# detects that there is a valid querier in the network. Set the bridge\n\t# as the querier and assign it a valid IPv6 link-local address to be\n\t# used as the source address for MLD queries.\n\tip link set dev br1 type bridge mcast_querier 1\n\tip -6 address add fe80::1/64 nodad dev br1\n\t# Wait the default Query Response Interval (10 seconds) for the bridge\n\t# to determine that there are no other queriers in the network.\n\tsleep 10\n\n\ttest_l2_miss_multicast_ipv4\n\ttest_l2_miss_multicast_ipv6\n\n\tip -6 address del fe80::1/64 dev br1\n\tip link set dev br1 type bridge mcast_querier 0\n\tbridge link set dev $swp2 mcast_router 1\n}\n\ntest_l2_miss_multicast_common2()\n{\n\tlocal name=$1; shift\n\tlocal dmac=$1; shift\n\tlocal dip=224.0.0.1\n\tlocal sip=192.0.2.1\n\n}\n\ntest_l2_miss_ll_multicast_common()\n{\n\tlocal proto=$1; shift\n\tlocal dmac=$1; shift\n\tlocal sip=$1; shift\n\tlocal dip=$1; shift\n\tlocal mode=$1; shift\n\tlocal name=$1; shift\n\n\tRET=0\n\n\ttc filter add dev $swp2 egress protocol $proto handle 101 pref 1 \\\n\t   flower indev $swp1 l2_miss 1 dst_mac $dmac src_ip $sip \\\n\t   dst_ip $dip action pass\n\n\t$MZ $mode $h1 -a own -b $dmac -t ip -A $sip -B $dip -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 1\n\tcheck_err $? \"Filter was not hit\"\n\n\ttc filter del dev $swp2 egress protocol $proto pref 1 handle 101 flower\n\n\tlog_test \"L2 miss - Link-local multicast ($name)\"\n}\n\ntest_l2_miss_ll_multicast_ipv4()\n{\n\tlocal proto=ipv4\n\tlocal dmac=01:00:5e:00:00:01\n\tlocal sip=192.0.2.1\n\tlocal dip=224.0.0.1\n\tlocal mode=\"-4\"\n\tlocal name=\"IPv4\"\n\n\ttest_l2_miss_ll_multicast_common $proto $dmac $sip $dip $mode $name\n}\n\ntest_l2_miss_ll_multicast_ipv6()\n{\n\tlocal proto=ipv6\n\tlocal dmac=33:33:00:00:00:01\n\tlocal sip=2001:db8:1::1\n\tlocal dip=ff02::1\n\tlocal mode=\"-6\"\n\tlocal name=\"IPv6\"\n\n\ttest_l2_miss_ll_multicast_common $proto $dmac $sip $dip $mode $name\n}\n\ntest_l2_miss_ll_multicast()\n{\n\ttest_l2_miss_ll_multicast_ipv4\n\ttest_l2_miss_ll_multicast_ipv6\n}\n\ntest_l2_miss_broadcast()\n{\n\tlocal dmac=ff:ff:ff:ff:ff:ff\n\tlocal smac=00:01:02:03:04:05\n\n\tRET=0\n\n\ttc filter add dev $swp2 egress protocol all handle 101 pref 1 \\\n\t   flower l2_miss 1 dst_mac $dmac src_mac $smac \\\n\t   action pass\n\ttc filter add dev $swp2 egress protocol all handle 102 pref 1 \\\n\t   flower l2_miss 0 dst_mac $dmac src_mac $smac \\\n\t   action pass\n\n\t$MZ $h1 -a $smac -b $dmac -c 1 -p 100 -q\n\n\ttc_check_packets \"dev $swp2 egress\" 101 0\n\tcheck_err $? \"L2 miss filter was hit when should not\"\n\n\ttc_check_packets \"dev $swp2 egress\" 102 1\n\tcheck_err $? \"L2 no miss filter was not hit when should\"\n\n\ttc filter del dev $swp2 egress protocol all pref 1 handle 102 flower\n\ttc filter del dev $swp2 egress protocol all pref 1 handle 101 flower\n\n\tlog_test \"L2 miss - Broadcast\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}