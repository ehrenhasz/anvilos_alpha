{
  "module_name": "mirror_gre_bound.sh",
  "hash_id": "f1be602512b5d537270a09ec557aeb25fa9a9f6e817869ff9c0fdc4c816fe998",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_bound.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n#   +---------------------+                             +---------------------+\n#   | H1                  |                             |                  H2 |\n#   |     + $h1           |                             |           $h2 +     |\n#   |     | 192.0.2.1/28  |                             |  192.0.2.2/28 |     |\n#   +-----|---------------+                             +---------------|-----+\n#         |                                                             |\n#   +-----|-------------------------------------------------------------|-----+\n#   | SW  o--> mirror                                                   |     |\n#   | +---|-------------------------------------------------------------|---+ |\n#   | |   + $swp1                    BR                           $swp2 +   | |\n#   | +---------------------------------------------------------------------+ |\n#   |                                                                         |\n#   | +---------------------------------------------------------------------+ |\n#   | | OL                      + gt6 (ip6gretap)      + gt4 (gretap)       | |\n#   | |                         : loc=2001:db8:2::1    : loc=192.0.2.129    | |\n#   | |                         : rem=2001:db8:2::2    : rem=192.0.2.130    | |\n#   | |                         : ttl=100              : ttl=100            | |\n#   | |                         : tos=inherit          : tos=inherit        | |\n#   | +-------------------------:--|-------------------:--|-----------------+ |\n#   |                           :  |                   :  |                   |\n#   | +-------------------------:--|-------------------:--|-----------------+ |\n#   | | UL                      :  |,---------------------'                 | |\n#   | |   + $swp3               :  ||                  :                    | |\n#   | |   | 192.0.2.129/28      :  vv                  :                    | |\n#   | |   | 2001:db8:2::1/64    :  + ul (dummy)        :                    | |\n#   | +---|---------------------:----------------------:--------------------+ |\n#   +-----|---------------------:----------------------:----------------------+\n#         |                     :                      :\n#   +-----|---------------------:----------------------:----------------------+\n#   | H3  + $h3                 + h3-gt6 (ip6gretap)   + h3-gt4 (gretap)      |\n#   |       192.0.2.130/28        loc=2001:db8:2::2      loc=192.0.2.130      |\n#   |       2001:db8:2::2/64      rem=2001:db8:2::1      rem=192.0.2.129      |\n#   |                             ttl=100                ttl=100              |\n#   |                             tos=inherit            tos=inherit          |\n#   |                                                                         |\n#   +-------------------------------------------------------------------------+\n#\n# This tests mirroring to gretap and ip6gretap configured in an overlay /\n# underlay manner, i.e. with a bound dummy device that marks underlay VRF where\n# the encapsulated packed should be routed.\n\nALL_TESTS=\"\n\ttest_gretap\n\ttest_ip6gretap\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/28\n}\n\nh3_create()\n{\n\tsimple_if_init $h3 192.0.2.130/28 2001:db8:2::2/64\n\n\ttunnel_create h3-gt4 gretap 192.0.2.130 192.0.2.129\n\tip link set h3-gt4 vrf v$h3\n\tmatchall_sink_create h3-gt4\n\n\ttunnel_create h3-gt6 ip6gretap 2001:db8:2::2 2001:db8:2::1\n\tip link set h3-gt6 vrf v$h3\n\tmatchall_sink_create h3-gt6\n}\n\nh3_destroy()\n{\n\ttunnel_destroy h3-gt6\n\ttunnel_destroy h3-gt4\n\n\tsimple_if_fini $h3 192.0.2.130/28 2001:db8:2::2/64\n}\n\nswitch_create()\n{\n\t# Bridge between H1 and H2.\n\n\tip link add name br1 type bridge vlan_filtering 1\n\tip link set dev br1 addrgenmode none\n\tip link set dev br1 up\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp1 clsact\n\n\t# Underlay.\n\n\tsimple_if_init $swp3 192.0.2.129/28 2001:db8:2::1/64\n\n\tip link add name ul type dummy\n\tip link set dev ul master v$swp3\n\tip link set dev ul up\n\n\t# Overlay.\n\n\tvrf_create vrf-ol\n\tip link set dev vrf-ol up\n\n\ttunnel_create gt4 gretap 192.0.2.129 192.0.2.130 \\\n\t\t      ttl 100 tos inherit dev ul\n\tip link set dev gt4 master vrf-ol\n\tip link set dev gt4 up\n\n\ttunnel_create gt6 ip6gretap 2001:db8:2::1 2001:db8:2::2 \\\n\t\t      ttl 100 tos inherit dev ul allow-localremote\n\tip link set dev gt6 master vrf-ol\n\tip link set dev gt6 up\n}\n\nswitch_destroy()\n{\n\tvrf_destroy vrf-ol\n\n\ttunnel_destroy gt6\n\ttunnel_destroy gt4\n\n\tsimple_if_fini $swp3 192.0.2.129/28 2001:db8:2::1/64\n\n\tip link del dev ul\n\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev $swp1 down\n\tip link set dev $swp2 down\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\th3_create\n\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\n\th3_destroy\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntest_gretap()\n{\n\tfull_test_span_gre_dir gt4 ingress 8 0 \"mirror to gretap w/ UL\"\n\tfull_test_span_gre_dir gt4 egress  0 8 \"mirror to gretap w/ UL\"\n}\n\ntest_ip6gretap()\n{\n\tfull_test_span_gre_dir gt6 ingress 8 0 \"mirror to ip6gretap w/ UL\"\n\tfull_test_span_gre_dir gt6 egress  0 8 \"mirror to ip6gretap w/ UL\"\n}\n\ntest_all()\n{\n\tRET=0\n\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntest_all\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttest_all\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}