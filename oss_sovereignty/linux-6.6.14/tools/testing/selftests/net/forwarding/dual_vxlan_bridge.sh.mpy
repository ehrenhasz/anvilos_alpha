{
  "module_name": "dual_vxlan_bridge.sh",
  "hash_id": "c953b1d56666b000cc74fba272a506d9c4cd0576ac4854020a0294285e0a47a3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/dual_vxlan_bridge.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +--------------------+                               +----------------------+\n# | H1 (vrf)           |                               |             H2 (vrf) |\n# |    + h1.10         |                               |  + h2.20             |\n# |    | 192.0.2.1/28  |                               |  | 192.0.2.2/28      |\n# |    |               |                               |  |                   |\n# |    + $h1           |                               |  + $h2               |\n# |    |               |                               |  |                   |\n# +----|---------------+                               +--|-------------------+\n#      |                                                  |\n# +----|--------------------------------------------------|--------------------+\n# | SW |                                                  |                    |\n# | +--|-------------------------------+ +----------------|------------------+ |\n# | |  + $swp1         BR1 (802.1ad)   | | BR2 (802.1d)   + $swp2            | |\n# | |    vid 100 pvid untagged         | |                |                  | |\n# | |                                  | |                + $swp2.20         | |\n# | |                                  | |                                   | |\n# | |  + vx100 (vxlan)                 | |  + vx200 (vxlan)                  | |\n# | |    local 192.0.2.17              | |    local 192.0.2.17               | |\n# | |    remote 192.0.2.34             | |    remote 192.0.2.50              | |\n# | |    id 1000 dstport $VXPORT       | |    id 2000 dstport $VXPORT        | |\n# | |    vid 100 pvid untagged         | |                                   | |\n# | +--------------------------------- + +-----------------------------------+ |\n# |                                                                            |\n# |  192.0.2.32/28 via 192.0.2.18                                              |\n# |  192.0.2.48/28 via 192.0.2.18                                              |\n# |                                                                            |\n# |    + $rp1                                                                  |\n# |    | 192.0.2.17/28                                                         |\n# +----|-----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                                             VRP2 (vrf) |\n# |    + $rp2                                                   |\n# |      192.0.2.18/28                                          |\n# |                                                             |   (maybe) HW\n# =============================================================================\n# |                                                             |  (likely) SW\n# |    + v1 (veth)                             + v3 (veth)      |\n# |    | 192.0.2.33/28                         | 192.0.2.49/28  |\n# +----|---------------------------------------|----------------+\n#      |                                       |\n# +----|------------------------------+   +----|------------------------------+\n# |    + v2 (veth)        NS1 (netns) |   |    + v4 (veth)        NS2 (netns) |\n# |      192.0.2.34/28                |   |      192.0.2.50/28                |\n# |                                   |   |                                   |\n# |   192.0.2.16/28 via 192.0.2.33    |   |   192.0.2.16/28 via 192.0.2.49    |\n# |   192.0.2.50/32 via 192.0.2.33    |   |   192.0.2.34/32 via 192.0.2.49    |\n# |                                   |   |                                   |\n# | +-------------------------------+ |   | +-------------------------------+ |\n# | |                 BR3 (802.1ad) | |   | |                  BR3 (802.1d) | |\n# | |  + vx100 (vxlan)              | |   | |  + vx200 (vxlan)              | |\n# | |    local 192.0.2.34           | |   | |    local 192.0.2.50           | |\n# | |    remote 192.0.2.17          | |   | |    remote 192.0.2.17          | |\n# | |    remote 192.0.2.50          | |   | |    remote 192.0.2.34          | |\n# | |    id 1000 dstport $VXPORT    | |   | |    id 2000 dstport $VXPORT    | |\n# | |    vid 100 pvid untagged      | |   | |                               | |\n# | |                               | |   | |  + w1.20                      | |\n# | |                               | |   | |  |                            | |\n# | |  + w1 (veth)                  | |   | |  + w1 (veth)                  | |\n# | |  | vid 100 pvid untagged      | |   | |  |                            | |\n# | +--|----------------------------+ |   | +--|----------------------------+ |\n# |    |                              |   |    |                              |\n# | +--|----------------------------+ |   | +--|----------------------------+ |\n# | |  |                  VW2 (vrf) | |   | |  |                  VW2 (vrf) | |\n# | |  + w2 (veth)                  | |   | |  + w2 (veth)                  | |\n# | |  |                            | |   | |  |                            | |\n# | |  |                            | |   | |  |                            | |\n# | |  + w2.10                      | |   | |  + w2.20                      | |\n# | |    192.0.2.3/28               | |   | |    192.0.2.4/28               | |\n# | +-------------------------------+ |   | +-------------------------------+ |\n# +-----------------------------------+   +-----------------------------------+\n\n: ${VXPORT:=4789}\nexport VXPORT\n\n: ${ALL_TESTS:=\"\n\tping_ipv4\n    \"}\n\nNUM_NETIFS=6\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n\ttc qdisc add dev $h1 clsact\n\tvlan_create $h1 10 v$h1 192.0.2.1/28\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 10\n\ttc qdisc del dev $h1 clsact\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\ttc qdisc add dev $h2 clsact\n\tvlan_create $h2 20 v$h2 192.0.2.2/28\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 20\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2\n}\n\nrp1_set_addr()\n{\n\tip address add dev $rp1 192.0.2.17/28\n\n\tip route add 192.0.2.32/28 nexthop via 192.0.2.18\n\tip route add 192.0.2.48/28 nexthop via 192.0.2.18\n}\n\nrp1_unset_addr()\n{\n\tip route del 192.0.2.48/28 nexthop via 192.0.2.18\n\tip route del 192.0.2.32/28 nexthop via 192.0.2.18\n\n\tip address del dev $rp1 192.0.2.17/28\n}\n\nswitch_create()\n{\n\t#### BR1 ####\n\tip link add name br1 type bridge vlan_filtering 1 \\\n\t\tvlan_protocol 802.1ad vlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br1 addrgenmode none\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\t#### BR2 ####\n\tip link add name br2 type bridge vlan_filtering 0 mcast_snooping 0\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br2 address $(mac_get $swp2)\n\tip link set dev br2 up\n\n\tip link set dev $rp1 up\n\trp1_set_addr\n\n\t#### VX100 ####\n\tip link add name vx100 type vxlan id 1000 local 192.0.2.17 \\\n\t\tdstport \"$VXPORT\" nolearning noudpcsum tos inherit ttl 100\n\tip link set dev vx100 up\n\n\tip link set dev vx100 master br1\n\tbridge vlan add vid 100 dev vx100 pvid untagged\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tbridge vlan add vid 100 dev $swp1 pvid untagged\n\n\t#### VX200 ####\n\tip link add name vx200 type vxlan id 2000 local 192.0.2.17 \\\n\t\tdstport \"$VXPORT\" nolearning noudpcsum tos inherit ttl 100\n\tip link set dev vx200 up\n\n\tip link set dev vx200 master br2\n\n\tip link set dev $swp2 up\n\tip link add name $swp2.20 link $swp2 type vlan id 20\n\tip link set dev $swp2.20 master br2\n\tip link set dev $swp2.20 up\n\n\tbridge fdb append dev vx100 00:00:00:00:00:00 dst 192.0.2.34 self\n\tbridge fdb append dev vx200 00:00:00:00:00:00 dst 192.0.2.50 self\n}\n\nswitch_destroy()\n{\n\tbridge fdb del dev vx200 00:00:00:00:00:00 dst 192.0.2.50 self\n\tbridge fdb del dev vx100 00:00:00:00:00:00 dst 192.0.2.34 self\n\n\tip link set dev vx200 nomaster\n\tip link set dev vx200 down\n\tip link del dev vx200\n\n\tip link del dev $swp2.20\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\n\tbridge vlan del vid 100 dev $swp1\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link set dev vx100 nomaster\n\tip link set dev vx100 down\n\tip link del dev vx100\n\n\trp1_unset_addr\n\tip link set dev $rp1 down\n\n\tip link set dev br2 down\n\tip link del dev br2\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nvrp2_create()\n{\n\tsimple_if_init $rp2 192.0.2.18/28\n\t__simple_if_init v1 v$rp2 192.0.2.33/28\n\t__simple_if_init v3 v$rp2 192.0.2.49/28\n\ttc qdisc add dev v1 clsact\n}\n\nvrp2_destroy()\n{\n\ttc qdisc del dev v1 clsact\n\t__simple_if_fini v3 192.0.2.49/28\n\t__simple_if_fini v1 192.0.2.33/28\n\tsimple_if_fini $rp2 192.0.2.18/28\n}\n\nns_init_common()\n{\n\tlocal in_if=$1; shift\n\tlocal in_addr=$1; shift\n\tlocal other_in_addr=$1; shift\n\tlocal vxlan_name=$1; shift\n\tlocal vxlan_id=$1; shift\n\tlocal vlan_id=$1; shift\n\tlocal host_addr=$1; shift\n\tlocal nh_addr=$1; shift\n\n\tip link set dev $in_if up\n\tip address add dev $in_if $in_addr/28\n\ttc qdisc add dev $in_if clsact\n\n\tip link add name br3 type bridge vlan_filtering 0\n\tip link set dev br3 up\n\n\tip link add name w1 type veth peer name w2\n\n\tip link set dev w1 master br3\n\tip link set dev w1 up\n\n\tip link add name $vxlan_name type vxlan id $vxlan_id local $in_addr \\\n\t\tdstport \"$VXPORT\"\n\tip link set dev $vxlan_name up\n\tbridge fdb append dev $vxlan_name 00:00:00:00:00:00 dst 192.0.2.17 self\n\tbridge fdb append dev $vxlan_name 00:00:00:00:00:00 dst $other_in_addr self\n\n\tip link set dev $vxlan_name master br3\n\ttc qdisc add dev $vxlan_name clsact\n\n\tsimple_if_init w2\n\tvlan_create w2 $vlan_id vw2 $host_addr/28\n\n\tip route add 192.0.2.16/28 nexthop via $nh_addr\n\tip route add $other_in_addr/32 nexthop via $nh_addr\n}\nexport -f ns_init_common\n\nns1_create()\n{\n\tip netns add ns1\n\tip link set dev v2 netns ns1\n\tin_ns ns1 \\\n\t      ns_init_common v2 192.0.2.34 192.0.2.50 vx100 1000 10 192.0.2.3 \\\n\t      192.0.2.33\n\n\tin_ns ns1 bridge vlan add vid 100 dev vx100 pvid untagged\n}\n\nns1_destroy()\n{\n\tip netns exec ns1 ip link set dev v2 netns 1\n\tip netns del ns1\n}\n\nns2_create()\n{\n\tip netns add ns2\n\tip link set dev v4 netns ns2\n\tin_ns ns2 \\\n\t      ns_init_common v4 192.0.2.50 192.0.2.34 vx200 2000 20 192.0.2.4 \\\n\t      192.0.2.49\n\n\tin_ns ns2 ip link add name w1.20 link w1 type vlan id 20\n\tin_ns ns2 ip link set dev w1.20 master br3\n\tin_ns ns2 ip link set dev w1.20 up\n}\n\nns2_destroy()\n{\n\tip netns exec ns2 ip link set dev v4 netns 1\n\tip netns del ns2\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp1=${NETIFS[p5]}\n\trp2=${NETIFS[p6]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\tswitch_create\n\n\tip link add name v1 type veth peer name v2\n\tip link add name v3 type veth peer name v4\n\tvrp2_create\n\tns1_create\n\tns2_create\n\n\tr1_mac=$(in_ns ns1 mac_get w2)\n\tr2_mac=$(in_ns ns2 mac_get w2)\n\th2_mac=$(mac_get $h2)\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tns2_destroy\n\tns1_destroy\n\tvrp2_destroy\n\tip link del dev v3\n\tip link del dev v1\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.3 \": local->remote 1 through VxLAN with an 802.1ad bridge\"\n\tping_test $h2 192.0.2.4 \": local->remote 2 through VxLAN with an 802.1d bridge\"\n}\n\ntest_all()\n{\n\techo \"Running tests with UDP port $VXPORT\"\n\ttests_run\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntest_all\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}