{
  "module_name": "tc_flower_cfm.sh",
  "hash_id": "d70b939937717c3e5db85963596a4c5bf373c35fa9da07ff9068dc59b6424299",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_flower_cfm.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"match_cfm_opcode match_cfm_level match_cfm_level_and_opcode\"\nNUM_NETIFS=2\nsource tc_common.sh\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2\n}\n\nu8_to_hex()\n{\n\tlocal u8=$1; shift\n\n\tprintf \"%02x\" $u8\n}\n\ngenerate_cfm_hdr()\n{\n\tlocal mdl=$1; shift\n\tlocal op=$1; shift\n\tlocal flags=$1; shift\n\tlocal tlv_offset=$1; shift\n\n\tlocal cfm_hdr=$(:\n\t               )\"$(u8_to_hex $((mdl << 5))):\"$( \t: MD level and Version\n\t               )\"$(u8_to_hex $op):\"$(\t\t\t: OpCode\n\t               )\"$(u8_to_hex $flags):\"$(\t\t: Flags\n\t               )\"$(u8_to_hex $tlv_offset)\"$(\t\t: TLV offset\n\t               )\n\n\techo $cfm_hdr\n}\n\nmatch_cfm_opcode()\n{\n\tlocal ethtype=\"89 02\"; readonly ethtype\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 101 \\\n\t   flower cfm op 47 action drop\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 102 \\\n\t   flower cfm op 43 action drop\n\n\tpkt=\"$ethtype $(generate_cfm_hdr 7 47 0 32)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\tpkt=\"$ethtype $(generate_cfm_hdr 6 5 0 4)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct opcode\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 0\n\tcheck_err $? \"Matched on the wrong opcode\"\n\n\tpkt=\"$ethtype $(generate_cfm_hdr 0 43 0 12)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Matched on the wrong opcode\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct opcode\"\n\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 102 flower\n\n\tlog_test \"CFM opcode match test\"\n}\n\nmatch_cfm_level()\n{\n\tlocal ethtype=\"89 02\"; readonly ethtype\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 101 \\\n\t   flower cfm mdl 5 action drop\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 102 \\\n\t   flower cfm mdl 3 action drop\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 103 \\\n\t   flower cfm mdl 0 action drop\n\n\tpkt=\"$ethtype $(generate_cfm_hdr 5 42 0 12)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\tpkt=\"$ethtype $(generate_cfm_hdr 6 1 0 70)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\tpkt=\"$ethtype $(generate_cfm_hdr 0 1 0 70)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct level\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 0\n\tcheck_err $? \"Matched on the wrong level\"\n\n\ttc_check_packets \"dev $h2 ingress\" 103 1\n\tcheck_err $? \"Did not match on correct level\"\n\n\tpkt=\"$ethtype $(generate_cfm_hdr 3 0 0 4)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Matched on the wrong level\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct level\"\n\n\ttc_check_packets \"dev $h2 ingress\" 103 1\n\tcheck_err $? \"Matched on the wrong level\"\n\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 102 flower\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 103 flower\n\n\tlog_test \"CFM level match test\"\n}\n\nmatch_cfm_level_and_opcode()\n{\n\tlocal ethtype=\"89 02\"; readonly ethtype\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 101 \\\n\t   flower cfm mdl 5 op 41 action drop\n\ttc filter add dev $h2 ingress protocol cfm pref 1 handle 102 \\\n\t   flower cfm mdl 7 op 42 action drop\n\n\tpkt=\"$ethtype $(generate_cfm_hdr 5 41 0 4)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\tpkt=\"$ethtype $(generate_cfm_hdr 7 3 0 4)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\tpkt=\"$ethtype $(generate_cfm_hdr 3 42 0 12)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Did not match on correct level and opcode\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 0\n\tcheck_err $? \"Matched on the wrong level and opcode\"\n\n\tpkt=\"$ethtype $(generate_cfm_hdr 7 42 0 12)\"\n\t$MZ $h1 -c 1 -p 64 -a $h1mac -b $h2mac \"$pkt\" -q\n\n\ttc_check_packets \"dev $h2 ingress\" 101 1\n\tcheck_err $? \"Matched on the wrong level and opcode\"\n\n\ttc_check_packets \"dev $h2 ingress\" 102 1\n\tcheck_err $? \"Did not match on correct level and opcode\"\n\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol cfm pref 1 handle 102 flower\n\n\tlog_test \"CFM opcode and level match test\"\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\th1mac=$(mac_get $h1)\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}