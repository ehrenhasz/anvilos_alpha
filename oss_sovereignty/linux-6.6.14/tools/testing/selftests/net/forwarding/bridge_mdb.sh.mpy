{
  "module_name": "bridge_mdb.sh",
  "hash_id": "9351a9c6a7c8c083d67cd7bdf1ebd474fc32edb715ac5da0bef65b986154ca03",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/bridge_mdb.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +-----------------------+                          +------------------------+\n# | H1 (vrf)              |                          | H2 (vrf)               |\n# | + $h1.10              |                          | + $h2.10               |\n# | | 192.0.2.1/28        |                          | | 192.0.2.2/28         |\n# | | 2001:db8:1::1/64    |                          | | 2001:db8:1::2/64     |\n# | |                     |                          | |                      |\n# | |  + $h1.20           |                          | |  + $h2.20            |\n# | \\  | 198.51.100.1/24  |                          | \\  | 198.51.100.2/24   |\n# |  \\ | 2001:db8:2::1/64 |                          |  \\ | 2001:db8:2::2/64  |\n# |   \\|                  |                          |   \\|                   |\n# |    + $h1              |                          |    + $h2               |\n# +----|------------------+                          +----|-------------------+\n#      |                                                  |\n# +----|--------------------------------------------------|-------------------+\n# | SW |                                                  |                   |\n# | +--|--------------------------------------------------|-----------------+ |\n# | |  + $swp1                   BR0 (802.1q)             + $swp2           | |\n# | |     vid 10                                             vid 10         | |\n# | |     vid 20                                             vid 20         | |\n# | |                                                                       | |\n# | +-----------------------------------------------------------------------+ |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tcfg_test\n\tfwd_test\n\tctrl_test\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n\tvlan_create $h1 10 v$h1 192.0.2.1/28 2001:db8:1::1/64\n\tvlan_create $h1 20 v$h1 198.51.100.1/24 2001:db8:2::1/64\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 20\n\tvlan_destroy $h1 10\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\tvlan_create $h2 10 v$h2 192.0.2.2/28\n\tvlan_create $h2 20 v$h2 198.51.100.2/24\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 20\n\tvlan_destroy $h2 10\n\tsimple_if_fini $h2\n}\n\nswitch_create()\n{\n\tip link add name br0 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 1 mcast_igmp_version 3 mcast_mld_version 2\n\tbridge vlan add vid 10 dev br0 self\n\tbridge vlan add vid 20 dev br0 self\n\tip link set dev br0 up\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp1 up\n\tbridge vlan add vid 10 dev $swp1\n\tbridge vlan add vid 20 dev $swp1\n\n\tip link set dev $swp2 master br0\n\tip link set dev $swp2 up\n\tbridge vlan add vid 10 dev $swp2\n\tbridge vlan add vid 20 dev $swp2\n\n\ttc qdisc add dev br0 clsact\n\ttc qdisc add dev $h2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\ttc qdisc del dev br0 clsact\n\n\tbridge vlan del vid 20 dev $swp2\n\tbridge vlan del vid 10 dev $swp2\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\n\tbridge vlan del vid 20 dev $swp1\n\tbridge vlan del vid 10 dev $swp1\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link set dev br0 down\n\tbridge vlan del vid 20 dev br0 self\n\tbridge vlan del vid 10 dev br0 self\n\tip link del dev br0\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\ncfg_test_host_common()\n{\n\tlocal name=$1; shift\n\tlocal grp=$1; shift\n\tlocal src=$1; shift\n\tlocal state=$1; shift\n\tlocal invalid_state=$1; shift\n\n\tRET=0\n\n\t# Check basic add, replace and delete behavior.\n\tbridge mdb add dev br0 port br0 grp $grp $state vid 10\n\tbridge mdb show dev br0 vid 10 | grep -q \"$grp\"\n\tcheck_err $? \"Failed to add $name host entry\"\n\n\tbridge mdb replace dev br0 port br0 grp $grp $state vid 10 &> /dev/null\n\tcheck_fail $? \"Managed to replace $name host entry\"\n\n\tbridge mdb del dev br0 port br0 grp $grp $state vid 10\n\tbridge mdb show dev br0 vid 10 | grep -q \"$grp\"\n\tcheck_fail $? \"Failed to delete $name host entry\"\n\n\t# Check error cases.\n\tbridge mdb add dev br0 port br0 grp $grp $invalid_state vid 10 \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to add $name host entry with a $invalid_state state\"\n\n\tbridge mdb add dev br0 port br0 grp $grp src $src $state vid 10 \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to add $name host entry with a source\"\n\n\tbridge mdb add dev br0 port br0 grp $grp $state vid 10 \\\n\t\tfilter_mode exclude &> /dev/null\n\tcheck_fail $? \"Managed to add $name host entry with a filter mode\"\n\n\tbridge mdb add dev br0 port br0 grp $grp $state vid 10 \\\n\t\tsource_list $src &> /dev/null\n\tcheck_fail $? \"Managed to add $name host entry with a source list\"\n\n\tbridge mdb add dev br0 port br0 grp $grp $state vid 10 \\\n\t\tproto 123 &> /dev/null\n\tcheck_fail $? \"Managed to add $name host entry with a protocol\"\n\n\tlog_test \"Common host entries configuration tests ($name)\"\n}\n\n# Check configuration of host entries from all types.\ncfg_test_host()\n{\n\techo\n\tlog_info \"# Host entries configuration tests\"\n\n\tcfg_test_host_common \"IPv4\" \"239.1.1.1\" \"192.0.2.1\" \"temp\" \"permanent\"\n\tcfg_test_host_common \"IPv6\" \"ff0e::1\" \"2001:db8:1::1\" \"temp\" \"permanent\"\n\tcfg_test_host_common \"L2\" \"01:02:03:04:05:06\" \"00:00:00:00:00:01\" \\\n\t\t\"permanent\" \"temp\"\n}\n\ncfg_test_port_common()\n{\n\tlocal name=$1;shift\n\tlocal grp_key=$1; shift\n\n\tRET=0\n\n\t# Check basic add, replace and delete behavior.\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid 10\n\tbridge mdb show dev br0 vid 10 | grep -q \"$grp_key\"\n\tcheck_err $? \"Failed to add $name entry\"\n\n\tbridge mdb replace dev br0 port $swp1 $grp_key permanent vid 10 \\\n\t\t&> /dev/null\n\tcheck_err $? \"Failed to replace $name entry\"\n\n\tbridge mdb del dev br0 port $swp1 $grp_key permanent vid 10\n\tbridge mdb show dev br0 vid 10 | grep -q \"$grp_key\"\n\tcheck_fail $? \"Failed to delete $name entry\"\n\n\t# Check default protocol and replacement.\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | grep -q \"static\"\n\tcheck_err $? \"$name entry not added with default \\\"static\\\" protocol\"\n\n\tbridge mdb replace dev br0 port $swp1 $grp_key permanent vid 10 \\\n\t\tproto 123\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | grep -q \"123\"\n\tcheck_err $? \"Failed to replace protocol of $name entry\"\n\tbridge mdb del dev br0 port $swp1 $grp_key permanent vid 10\n\n\t# Check behavior when VLAN is not specified.\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent\n\tbridge mdb show dev br0 vid 10 | grep -q \"$grp_key\"\n\tcheck_err $? \"$name entry with VLAN 10 not added when VLAN was not specified\"\n\tbridge mdb show dev br0 vid 20 | grep -q \"$grp_key\"\n\tcheck_err $? \"$name entry with VLAN 20 not added when VLAN was not specified\"\n\n\tbridge mdb del dev br0 port $swp1 $grp_key permanent\n\tbridge mdb show dev br0 vid 10 | grep -q \"$grp_key\"\n\tcheck_fail $? \"$name entry with VLAN 10 not deleted when VLAN was not specified\"\n\tbridge mdb show dev br0 vid 20 | grep -q \"$grp_key\"\n\tcheck_fail $? \"$name entry with VLAN 20 not deleted when VLAN was not specified\"\n\n\t# Check behavior when bridge port is down.\n\tip link set dev $swp1 down\n\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid 10\n\tcheck_err $? \"Failed to add $name permanent entry when bridge port is down\"\n\n\tbridge mdb del dev br0 port $swp1 $grp_key permanent vid 10\n\n\tbridge mdb add dev br0 port $swp1 $grp_key temp vid 10 &> /dev/null\n\tcheck_fail $? \"Managed to add $name temporary entry when bridge port is down\"\n\n\tip link set dev $swp1 up\n\tsetup_wait_dev $swp1\n\n\t# Check error cases.\n\tip link set dev br0 down\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid 10 \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to add $name entry when bridge is down\"\n\tip link set dev br0 up\n\n\tip link set dev br0 type bridge mcast_snooping 0\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid \\\n\t\t10 &> /dev/null\n\tcheck_fail $? \"Managed to add $name entry when multicast snooping is disabled\"\n\tip link set dev br0 type bridge mcast_snooping 1\n\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid 5000 \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to add $name entry with an invalid VLAN\"\n\n\tlog_test \"Common port group entries configuration tests ($name)\"\n}\n\nsrc_list_create()\n{\n\tlocal src_prefix=$1; shift\n\tlocal num_srcs=$1; shift\n\tlocal src_list\n\tlocal i\n\n\tfor i in $(seq 1 $num_srcs); do\n\t\tsrc_list=${src_list},${src_prefix}${i}\n\tdone\n\n\techo $src_list | cut -c 2-\n}\n\n__cfg_test_port_ip_star_g()\n{\n\tlocal name=$1; shift\n\tlocal grp=$1; shift\n\tlocal invalid_grp=$1; shift\n\tlocal src_prefix=$1; shift\n\tlocal src1=${src_prefix}1\n\tlocal src2=${src_prefix}2\n\tlocal src3=${src_prefix}3\n\tlocal max_srcs=31\n\tlocal num_srcs\n\n\tRET=0\n\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"exclude\"\n\tcheck_err $? \"Default filter mode is not \\\"exclude\\\"\"\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check basic add and delete behavior.\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode exclude \\\n\t\tsource_list $src1\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q -v \"src\"\n\tcheck_err $? \"(*, G) entry not created\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src1\"\n\tcheck_err $? \"(S, G) entry not created\"\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q -v \"src\"\n\tcheck_fail $? \"(*, G) entry not deleted\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src1\"\n\tcheck_fail $? \"(S, G) entry not deleted\"\n\n\t## State (permanent / temp) tests.\n\n\t# Check that group and source timer are not set for permanent entries.\n\tbridge mdb add dev br0 port $swp1 grp $grp permanent vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"permanent\"\n\tcheck_err $? \"(*, G) entry not added as \\\"permanent\\\" when should\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"permanent\"\n\tcheck_err $? \"(S, G) entry not added as \\\"permanent\\\" when should\"\n\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_err $? \"(*, G) \\\"permanent\\\" entry has a pending group timer\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"\\/0.00\"\n\tcheck_err $? \"\\\"permanent\\\" source entry has a pending source timer\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that group timer is set for temporary (*, G) EXCLUDE, but not\n\t# the source timer.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"(*, G) EXCLUDE entry not added as \\\"temp\\\" when should\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"(S, G) \\\"blocked\\\" entry not added as \\\"temp\\\" when should\"\n\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_fail $? \"(*, G) EXCLUDE entry does not have a pending group timer\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"\\/0.00\"\n\tcheck_err $? \"\\\"blocked\\\" source entry has a pending source timer\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that group timer is not set for temporary (*, G) INCLUDE, but\n\t# that the source timer is set.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode include source_list $src1\n\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"(*, G) INCLUDE entry not added as \\\"temp\\\" when should\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"(S, G) entry not added as \\\"temp\\\" when should\"\n\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_err $? \"(*, G) INCLUDE entry has a pending group timer\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"\\/0.00\"\n\tcheck_fail $? \"Source entry does not have a pending source timer\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that group timer is never set for (S, G) entries.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode include source_list $src1\n\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_err $? \"(S, G) entry has a pending group timer\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t## Filter mode (include / exclude) tests.\n\n\t# Check that (*, G) INCLUDE entries are added with correct filter mode\n\t# and that (S, G) entries are not marked as \"blocked\".\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 \\\n\t\tfilter_mode include source_list $src1\n\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"include\"\n\tcheck_err $? \"(*, G) INCLUDE not added with \\\"include\\\" filter mode\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"blocked\"\n\tcheck_fail $? \"(S, G) entry marked as \\\"blocked\\\" when should not\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that (*, G) EXCLUDE entries are added with correct filter mode\n\t# and that (S, G) entries are marked as \"blocked\".\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"exclude\"\n\tcheck_err $? \"(*, G) EXCLUDE not added with \\\"exclude\\\" filter mode\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"blocked\"\n\tcheck_err $? \"(S, G) entry not marked as \\\"blocked\\\" when should\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t## Protocol tests.\n\n\t# Check that (*, G) and (S, G) entries are added with the specified\n\t# protocol.\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 \\\n\t\tfilter_mode exclude source_list $src1 proto zebra\n\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"zebra\"\n\tcheck_err $? \"(*, G) entry not added with \\\"zebra\\\" protocol\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"zebra\"\n\tcheck_err $? \"(S, G) entry not marked added with \\\"zebra\\\" protocol\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t## Replace tests.\n\n\t# Check that state can be modified.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp permanent vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"permanent\"\n\tcheck_err $? \"(*, G) entry not marked as \\\"permanent\\\" after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"permanent\"\n\tcheck_err $? \"(S, G) entry not marked as \\\"permanent\\\" after replace\"\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"(*, G) entry not marked as \\\"temp\\\" after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"(S, G) entry not marked as \\\"temp\\\" after replace\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that filter mode can be modified.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode include source_list $src1\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"include\"\n\tcheck_err $? \"(*, G) not marked with \\\"include\\\" filter mode after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"blocked\"\n\tcheck_fail $? \"(S, G) marked as \\\"blocked\\\" after replace\"\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"exclude\"\n\tcheck_err $? \"(*, G) not marked with \\\"exclude\\\" filter mode after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"blocked\"\n\tcheck_err $? \"(S, G) not marked as \\\"blocked\\\" after replace\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that sources can be added to and removed from the source list.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1,$src2,$src3\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src1\"\n\tcheck_err $? \"(S, G) entry for source $src1 not created after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src2\"\n\tcheck_err $? \"(S, G) entry for source $src2 not created after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src3\"\n\tcheck_err $? \"(S, G) entry for source $src3 not created after replace\"\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1,$src3\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src1\"\n\tcheck_err $? \"(S, G) entry for source $src1 not created after second replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src2\"\n\tcheck_fail $? \"(S, G) entry for source $src2 created after second replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -q \"src $src3\"\n\tcheck_err $? \"(S, G) entry for source $src3 not created after second replace\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t# Check that protocol can be modified.\n\tbridge mdb add dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1 proto zebra\n\n\tbridge mdb replace dev br0 port $swp1 grp $grp temp vid 10 \\\n\t\tfilter_mode exclude source_list $src1 proto bgp\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep -v \"src\" | \\\n\t\tgrep -q \"bgp\"\n\tcheck_err $? \"(*, G) protocol not changed to \\\"bgp\\\" after replace\"\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp\" | grep \"src\" | \\\n\t\tgrep -q \"bgp\"\n\tcheck_err $? \"(S, G) protocol not changed to \\\"bgp\\\" after replace\"\n\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\t## Star exclude tests.\n\n\t# Check star exclude functionality. When adding a new EXCLUDE (*, G),\n\t# it needs to be also added to all (S, G) entries for proper\n\t# replication.\n\tbridge mdb add dev br0 port $swp2 grp $grp vid 10 \\\n\t\tfilter_mode include source_list $src1\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$swp1\" | grep \"$grp\" | \\\n\t\tgrep \"$src1\" | grep -q \"added_by_star_ex\"\n\tcheck_err $? \"\\\"added_by_star_ex\\\" entry not created after adding (*, G) entry\"\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\tbridge mdb del dev br0 port $swp2 grp $grp src $src1 vid 10\n\n\t## Error cases tests.\n\n\tbridge mdb add dev br0 port $swp1 grp $invalid_grp vid 10 &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with an invalid group\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode include \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to add an INCLUDE entry with an empty source list\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode include \\\n\t\tsource_list $grp &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with an invalid source in source list\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 \\\n\t\tsource_list $src &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with a source list and no filter mode\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode include \\\n\t\tsource_list $src1\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode exclude \\\n\t\tsource_list $src1 &> /dev/null\n\tcheck_fail $? \"Managed to replace an entry without using replace\"\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\tbridge mdb add dev br0 port $swp1 grp $grp src $src2 vid 10\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode include \\\n\t\tsource_list $src1,$src2,$src3 &> /dev/null\n\tcheck_fail $? \"Managed to add a source that already has a forwarding entry\"\n\tbridge mdb del dev br0 port $swp1 grp $grp src $src2 vid 10\n\n\t# Check maximum number of sources.\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode exclude \\\n\t\tsource_list $(src_list_create $src_prefix $max_srcs)\n\tnum_srcs=$(bridge -d mdb show dev br0 vid 10 | grep \"$grp\" | \\\n\t\tgrep \"src\" | wc -l)\n\t[[ $num_srcs -eq $max_srcs ]]\n\tcheck_err $? \"Failed to configure maximum number of sources ($max_srcs)\"\n\tbridge mdb del dev br0 port $swp1 grp $grp vid 10\n\n\tbridge mdb add dev br0 port $swp1 grp $grp vid 10 filter_mode exclude \\\n\t\tsource_list $(src_list_create $src_prefix $((max_srcs + 1))) \\\n\t\t&> /dev/null\n\tcheck_fail $? \"Managed to exceed maximum number of sources ($max_srcs)\"\n\n\tlog_test \"$name (*, G) port group entries configuration tests\"\n}\n\ncfg_test_port_ip_star_g()\n{\n\techo\n\tlog_info \"# Port group entries configuration tests - (*, G)\"\n\n\tcfg_test_port_common \"IPv4 (*, G)\" \"grp 239.1.1.1\"\n\tcfg_test_port_common \"IPv6 (*, G)\" \"grp ff0e::1\"\n\t__cfg_test_port_ip_star_g \"IPv4\" \"239.1.1.1\" \"224.0.0.1\" \"192.0.2.\"\n\t__cfg_test_port_ip_star_g \"IPv6\" \"ff0e::1\" \"ff02::1\" \"2001:db8:1::\"\n}\n\n__cfg_test_port_ip_sg()\n{\n\tlocal name=$1; shift\n\tlocal grp=$1; shift\n\tlocal src=$1; shift\n\tlocal grp_key=\"grp $grp src $src\"\n\n\tRET=0\n\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | grep -q \"include\"\n\tcheck_err $? \"Default filter mode is not \\\"include\\\"\"\n\tbridge mdb del dev br0 port $swp1 $grp_key vid 10\n\n\t# Check that entries can be added as both permanent and temp and that\n\t# group timer is set correctly.\n\tbridge mdb add dev br0 port $swp1 $grp_key permanent vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \"permanent\"\n\tcheck_err $? \"Entry not added as \\\"permanent\\\" when should\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_err $? \"\\\"permanent\\\" entry has a pending group timer\"\n\tbridge mdb del dev br0 port $swp1 $grp_key vid 10\n\n\tbridge mdb add dev br0 port $swp1 $grp_key temp vid 10\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"Entry not added as \\\"temp\\\" when should\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_fail $? \"\\\"temp\\\" entry has an unpending group timer\"\n\tbridge mdb del dev br0 port $swp1 $grp_key vid 10\n\n\t# Check error cases.\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10 \\\n\t\tfilter_mode include &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with a filter mode\"\n\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10 \\\n\t\tfilter_mode include source_list $src &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with a source list\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp src $grp vid 10 &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with an invalid source\"\n\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10 temp\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10 permanent &> /dev/null\n\tcheck_fail $? \"Managed to replace an entry without using replace\"\n\tbridge mdb del dev br0 port $swp1 $grp_key vid 10\n\n\t# Check that we can replace available attributes.\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10 proto 123\n\tbridge mdb replace dev br0 port $swp1 $grp_key vid 10 proto 111\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \"111\"\n\tcheck_err $? \"Failed to replace protocol\"\n\n\tbridge mdb replace dev br0 port $swp1 $grp_key vid 10 permanent\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \"permanent\"\n\tcheck_err $? \"Entry not marked as \\\"permanent\\\" after replace\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_err $? \"Entry has a pending group timer after replace\"\n\n\tbridge mdb replace dev br0 port $swp1 $grp_key vid 10 temp\n\tbridge -d mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \"temp\"\n\tcheck_err $? \"Entry not marked as \\\"temp\\\" after replace\"\n\tbridge -d -s mdb show dev br0 vid 10 | grep \"$grp_key\" | \\\n\t\tgrep -q \" 0.00\"\n\tcheck_fail $? \"Entry has an unpending group timer after replace\"\n\tbridge mdb del dev br0 port $swp1 $grp_key vid 10\n\n\t# Check star exclude functionality. When adding a (S, G), all matching\n\t# (*, G) ports need to be added to it.\n\tbridge mdb add dev br0 port $swp2 grp $grp vid 10\n\tbridge mdb add dev br0 port $swp1 $grp_key vid 10\n\tbridge mdb show dev br0 vid 10 | grep \"$grp_key\" | grep $swp2 | \\\n\t\tgrep -q \"added_by_star_ex\"\n\tcheck_err $? \"\\\"added_by_star_ex\\\" entry not created after adding (S, G) entry\"\n\tbridge mdb del dev br0 port $swp1 $grp_key vid 10\n\tbridge mdb del dev br0 port $swp2 grp $grp vid 10\n\n\tlog_test \"$name (S, G) port group entries configuration tests\"\n}\n\ncfg_test_port_ip_sg()\n{\n\techo\n\tlog_info \"# Port group entries configuration tests - (S, G)\"\n\n\tcfg_test_port_common \"IPv4 (S, G)\" \"grp 239.1.1.1 src 192.0.2.1\"\n\tcfg_test_port_common \"IPv6 (S, G)\" \"grp ff0e::1 src 2001:db8:1::1\"\n\t__cfg_test_port_ip_sg \"IPv4\" \"239.1.1.1\" \"192.0.2.1\"\n\t__cfg_test_port_ip_sg \"IPv6\" \"ff0e::1\" \"2001:db8:1::1\"\n}\n\ncfg_test_port_ip()\n{\n\tcfg_test_port_ip_star_g\n\tcfg_test_port_ip_sg\n}\n\n__cfg_test_port_l2()\n{\n\tlocal grp=\"01:02:03:04:05:06\"\n\n\tRET=0\n\n\tbridge meb add dev br0 port $swp grp 00:01:02:03:04:05 \\\n\t\tpermanent vid 10 &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with unicast MAC\"\n\n\tbridge mdb add dev br0 port $swp grp $grp src 00:01:02:03:04:05 \\\n\t\tpermanent vid 10 &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with a source\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp permanent vid 10 \\\n\t\tfilter_mode include &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with a filter mode\"\n\n\tbridge mdb add dev br0 port $swp1 grp $grp permanent vid 10 \\\n\t\tsource_list 00:01:02:03:04:05 &> /dev/null\n\tcheck_fail $? \"Managed to add an entry with a source list\"\n\n\tlog_test \"L2 (*, G) port group entries configuration tests\"\n}\n\ncfg_test_port_l2()\n{\n\techo\n\tlog_info \"# Port group entries configuration tests - L2\"\n\n\tcfg_test_port_common \"L2 (*, G)\" \"grp 01:02:03:04:05:06\"\n\t__cfg_test_port_l2\n}\n\n# Check configuration of regular (port) entries of all types.\ncfg_test_port()\n{\n\tcfg_test_port_ip\n\tcfg_test_port_l2\n}\n\nipv4_grps_get()\n{\n\tlocal max_grps=$1; shift\n\tlocal i\n\n\tfor i in $(seq 0 $((max_grps - 1))); do\n\t\techo \"239.1.1.$i\"\n\tdone\n}\n\nipv6_grps_get()\n{\n\tlocal max_grps=$1; shift\n\tlocal i\n\n\tfor i in $(seq 0 $((max_grps - 1))); do\n\t\techo \"ff0e::$(printf %x $i)\"\n\tdone\n}\n\nl2_grps_get()\n{\n\tlocal max_grps=$1; shift\n\tlocal i\n\n\tfor i in $(seq 0 $((max_grps - 1))); do\n\t\techo \"01:00:00:00:00:$(printf %02x $i)\"\n\tdone\n}\n\ncfg_test_dump_common()\n{\n\tlocal name=$1; shift\n\tlocal fn=$1; shift\n\tlocal max_bridges=2\n\tlocal max_grps=256\n\tlocal max_ports=32\n\tlocal num_entries\n\tlocal batch_file\n\tlocal grp\n\tlocal i j\n\n\tRET=0\n\n\t# Create net devices.\n\tfor i in $(seq 1 $max_bridges); do\n\t\tip link add name br-test${i} up type bridge vlan_filtering 1 \\\n\t\t\tmcast_snooping 1\n\t\tfor j in $(seq 1 $max_ports); do\n\t\t\tip link add name br-test${i}-du${j} up \\\n\t\t\t\tmaster br-test${i} type dummy\n\t\tdone\n\tdone\n\n\t# Create batch file with MDB entries.\n\tbatch_file=$(mktemp)\n\tfor i in $(seq 1 $max_bridges); do\n\t\tfor j in $(seq 1 $max_ports); do\n\t\t\tfor grp in $($fn $max_grps); do\n\t\t\t\techo \"mdb add dev br-test${i} \\\n\t\t\t\t\tport br-test${i}-du${j} grp $grp \\\n\t\t\t\t\tpermanent vid 1\" >> $batch_file\n\t\t\tdone\n\t\tdone\n\tdone\n\n\t# Program the batch file and check for expected number of entries.\n\tbridge -b $batch_file\n\tfor i in $(seq 1 $max_bridges); do\n\t\tnum_entries=$(bridge mdb show dev br-test${i} | \\\n\t\t\tgrep \"permanent\" | wc -l)\n\t\t[[ $num_entries -eq $((max_grps * max_ports)) ]]\n\t\tcheck_err $? \"Wrong number of entries in br-test${i}\"\n\tdone\n\n\t# Cleanup.\n\trm $batch_file\n\tfor i in $(seq 1 $max_bridges); do\n\t\tip link del dev br-test${i}\n\t\tfor j in $(seq $max_ports); do\n\t\t\tip link del dev br-test${i}-du${j}\n\t\tdone\n\tdone\n\n\tlog_test \"$name large scale dump tests\"\n}\n\n# Check large scale dump.\ncfg_test_dump()\n{\n\techo\n\tlog_info \"# Large scale dump tests\"\n\n\tcfg_test_dump_common \"IPv4\" ipv4_grps_get\n\tcfg_test_dump_common \"IPv6\" ipv6_grps_get\n\tcfg_test_dump_common \"L2\" l2_grps_get\n}\n\ncfg_test()\n{\n\tcfg_test_host\n\tcfg_test_port\n\tcfg_test_dump\n}\n\n__fwd_test_host_ip()\n{\n\tlocal grp=$1; shift\n\tlocal dmac=$1; shift\n\tlocal src=$1; shift\n\tlocal mode=$1; shift\n\tlocal name\n\tlocal eth_type\n\n\tRET=0\n\n\tif [[ $mode == \"-4\" ]]; then\n\t\tname=\"IPv4\"\n\t\teth_type=\"ipv4\"\n\telse\n\t\tname=\"IPv6\"\n\t\teth_type=\"ipv6\"\n\tfi\n\n\ttc filter add dev br0 ingress protocol 802.1q pref 1 handle 1 flower \\\n\t\tvlan_ethtype $eth_type vlan_id 10 dst_ip $grp src_ip $src \\\n\t\taction drop\n\n\t# Packet should only be flooded to multicast router ports when there is\n\t# no matching MDB entry. The bridge is not configured as a multicast\n\t# router port.\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $src -B $grp -t udp -q\n\ttc_check_packets \"dev br0 ingress\" 1 0\n\tcheck_err $? \"Packet locally received after flood\"\n\n\t# Install a regular port group entry and expect the packet to not be\n\t# locally received.\n\tbridge mdb add dev br0 port $swp2 grp $grp temp vid 10\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $src -B $grp -t udp -q\n\ttc_check_packets \"dev br0 ingress\" 1 0\n\tcheck_err $? \"Packet locally received after installing a regular entry\"\n\n\t# Add a host entry and expect the packet to be locally received.\n\tbridge mdb add dev br0 port br0 grp $grp temp vid 10\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $src -B $grp -t udp -q\n\ttc_check_packets \"dev br0 ingress\" 1 1\n\tcheck_err $? \"Packet not locally received after adding a host entry\"\n\n\t# Remove the host entry and expect the packet to not be locally\n\t# received.\n\tbridge mdb del dev br0 port br0 grp $grp vid 10\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $src -B $grp -t udp -q\n\ttc_check_packets \"dev br0 ingress\" 1 1\n\tcheck_err $? \"Packet locally received after removing a host entry\"\n\n\tbridge mdb del dev br0 port $swp2 grp $grp vid 10\n\n\ttc filter del dev br0 ingress protocol 802.1q pref 1 handle 1 flower\n\n\tlog_test \"$name host entries forwarding tests\"\n}\n\nfwd_test_host_ip()\n{\n\t__fwd_test_host_ip \"239.1.1.1\" \"01:00:5e:01:01:01\" \"192.0.2.1\" \"-4\"\n\t__fwd_test_host_ip \"ff0e::1\" \"33:33:00:00:00:01\" \"2001:db8:1::1\" \"-6\"\n}\n\nfwd_test_host_l2()\n{\n\tlocal dmac=01:02:03:04:05:06\n\n\tRET=0\n\n\ttc filter add dev br0 ingress protocol all pref 1 handle 1 flower \\\n\t\tdst_mac $dmac action drop\n\n\t# Packet should be flooded and locally received when there is no\n\t# matching MDB entry.\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev br0 ingress\" 1 1\n\tcheck_err $? \"Packet not locally received after flood\"\n\n\t# Install a regular port group entry and expect the packet to not be\n\t# locally received.\n\tbridge mdb add dev br0 port $swp2 grp $dmac permanent vid 10\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev br0 ingress\" 1 1\n\tcheck_err $? \"Packet locally received after installing a regular entry\"\n\n\t# Add a host entry and expect the packet to be locally received.\n\tbridge mdb add dev br0 port br0 grp $dmac permanent vid 10\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev br0 ingress\" 1 2\n\tcheck_err $? \"Packet not locally received after adding a host entry\"\n\n\t# Remove the host entry and expect the packet to not be locally\n\t# received.\n\tbridge mdb del dev br0 port br0 grp $dmac permanent vid 10\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev br0 ingress\" 1 2\n\tcheck_err $? \"Packet locally received after removing a host entry\"\n\n\tbridge mdb del dev br0 port $swp2 grp $dmac permanent vid 10\n\n\ttc filter del dev br0 ingress protocol all pref 1 handle 1 flower\n\n\tlog_test \"L2 host entries forwarding tests\"\n}\n\nfwd_test_host()\n{\n\t# Disable multicast router on the bridge to ensure that packets are\n\t# only locally received when a matching host entry is present.\n\tip link set dev br0 type bridge mcast_router 0\n\n\tfwd_test_host_ip\n\tfwd_test_host_l2\n\n\tip link set dev br0 type bridge mcast_router 1\n}\n\n__fwd_test_port_ip()\n{\n\tlocal grp=$1; shift\n\tlocal dmac=$1; shift\n\tlocal valid_src=$1; shift\n\tlocal invalid_src=$1; shift\n\tlocal mode=$1; shift\n\tlocal filter_mode=$1; shift\n\tlocal name\n\tlocal eth_type\n\tlocal src_list\n\n\tRET=0\n\n\tif [[ $mode == \"-4\" ]]; then\n\t\tname=\"IPv4\"\n\t\teth_type=\"ipv4\"\n\telse\n\t\tname=\"IPv6\"\n\t\teth_type=\"ipv6\"\n\tfi\n\n\t# The valid source is the one we expect to get packets from after\n\t# adding the entry.\n\tif [[ $filter_mode == \"include\" ]]; then\n\t\tsrc_list=$valid_src\n\telse\n\t\tsrc_list=$invalid_src\n\tfi\n\n\ttc filter add dev $h2 ingress protocol 802.1q pref 1 handle 1 flower \\\n\t\tvlan_ethtype $eth_type vlan_id 10 dst_ip $grp \\\n\t\tsrc_ip $valid_src action drop\n\ttc filter add dev $h2 ingress protocol 802.1q pref 1 handle 2 flower \\\n\t\tvlan_ethtype $eth_type vlan_id 10 dst_ip $grp \\\n\t\tsrc_ip $invalid_src action drop\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $valid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 1 0\n\tcheck_err $? \"Packet from valid source received on H2 before adding entry\"\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $invalid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 2 0\n\tcheck_err $? \"Packet from invalid source received on H2 before adding entry\"\n\n\tbridge mdb add dev br0 port $swp2 grp $grp vid 10 \\\n\t\tfilter_mode $filter_mode source_list $src_list\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $valid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 1 1\n\tcheck_err $? \"Packet from valid source not received on H2 after adding entry\"\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $invalid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 2 0\n\tcheck_err $? \"Packet from invalid source received on H2 after adding entry\"\n\n\tbridge mdb replace dev br0 port $swp2 grp $grp vid 10 \\\n\t\tfilter_mode exclude\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $valid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 1 2\n\tcheck_err $? \"Packet from valid source not received on H2 after allowing all sources\"\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $invalid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 2 1\n\tcheck_err $? \"Packet from invalid source not received on H2 after allowing all sources\"\n\n\tbridge mdb del dev br0 port $swp2 grp $grp vid 10\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $valid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 1 2\n\tcheck_err $? \"Packet from valid source received on H2 after deleting entry\"\n\n\t$MZ $mode $h1.10 -a own -b $dmac -c 1 -p 128 -A $invalid_src -B $grp -t udp -q\n\ttc_check_packets \"dev $h2 ingress\" 2 1\n\tcheck_err $? \"Packet from invalid source received on H2 after deleting entry\"\n\n\ttc filter del dev $h2 ingress protocol 802.1q pref 1 handle 2 flower\n\ttc filter del dev $h2 ingress protocol 802.1q pref 1 handle 1 flower\n\n\tlog_test \"$name port group \\\"$filter_mode\\\" entries forwarding tests\"\n}\n\nfwd_test_port_ip()\n{\n\t__fwd_test_port_ip \"239.1.1.1\" \"01:00:5e:01:01:01\" \"192.0.2.1\" \"192.0.2.2\" \"-4\" \"exclude\"\n\t__fwd_test_port_ip \"ff0e::1\" \"33:33:00:00:00:01\" \"2001:db8:1::1\" \"2001:db8:1::2\" \"-6\" \\\n\t\t\"exclude\"\n\t__fwd_test_port_ip \"239.1.1.1\" \"01:00:5e:01:01:01\" \"192.0.2.1\" \"192.0.2.2\" \"-4\" \"include\"\n\t__fwd_test_port_ip \"ff0e::1\" \"33:33:00:00:00:01\" \"2001:db8:1::1\" \"2001:db8:1::2\" \"-6\" \\\n\t\t\"include\"\n}\n\nfwd_test_port_l2()\n{\n\tlocal dmac=01:02:03:04:05:06\n\n\tRET=0\n\n\ttc filter add dev $h2 ingress protocol all pref 1 handle 1 flower \\\n\t\tdst_mac $dmac action drop\n\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev $h2 ingress\" 1 0\n\tcheck_err $? \"Packet received on H2 before adding entry\"\n\n\tbridge mdb add dev br0 port $swp2 grp $dmac permanent vid 10\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev $h2 ingress\" 1 1\n\tcheck_err $? \"Packet not received on H2 after adding entry\"\n\n\tbridge mdb del dev br0 port $swp2 grp $dmac permanent vid 10\n\t$MZ $h1.10 -c 1 -p 128 -a own -b $dmac -q\n\ttc_check_packets \"dev $h2 ingress\" 1 1\n\tcheck_err $? \"Packet received on H2 after deleting entry\"\n\n\ttc filter del dev $h2 ingress protocol all pref 1 handle 1 flower\n\n\tlog_test \"L2 port entries forwarding tests\"\n}\n\nfwd_test_port()\n{\n\t# Disable multicast flooding to ensure that packets are only forwarded\n\t# out of a port when a matching port group entry is present.\n\tbridge link set dev $swp2 mcast_flood off\n\n\tfwd_test_port_ip\n\tfwd_test_port_l2\n\n\tbridge link set dev $swp2 mcast_flood on\n}\n\nfwd_test()\n{\n\techo\n\tlog_info \"# Forwarding tests\"\n\n\t# Forwarding according to MDB entries only takes place when the bridge\n\t# detects that there is a valid querier in the network. Set the bridge\n\t# as the querier and assign it a valid IPv6 link-local address to be\n\t# used as the source address for MLD queries.\n\tip -6 address add fe80::1/64 nodad dev br0\n\tip link set dev br0 type bridge mcast_querier 1\n\t# Wait the default Query Response Interval (10 seconds) for the bridge\n\t# to determine that there are no other queriers in the network.\n\tsleep 10\n\n\tfwd_test_host\n\tfwd_test_port\n\n\tip link set dev br0 type bridge mcast_querier 0\n\tip -6 address del fe80::1/64 dev br0\n}\n\nctrl_igmpv3_is_in_test()\n{\n\tRET=0\n\n\t# Add a permanent entry and check that it is not affected by the\n\t# received IGMP packet.\n\tbridge mdb add dev br0 port $swp1 grp 239.1.1.1 permanent vid 10 \\\n\t\tfilter_mode include source_list 192.0.2.1\n\n\t# IS_IN ( 192.0.2.2 )\n\t$MZ $h1.10 -c 1 -a own -b 01:00:5e:01:01:01 -A 192.0.2.1 -B 239.1.1.1 \\\n\t\t-t ip proto=2,p=$(igmpv3_is_in_get 239.1.1.1 192.0.2.2) -q\n\n\tbridge -d mdb show dev br0 vid 10 | grep 239.1.1.1 | grep -q 192.0.2.2\n\tcheck_fail $? \"Permanent entry affected by IGMP packet\"\n\n\t# Replace the permanent entry with a temporary one and check that after\n\t# processing the IGMP packet, a new source is added to the list along\n\t# with a new forwarding entry.\n\tbridge mdb replace dev br0 port $swp1 grp 239.1.1.1 temp vid 10 \\\n\t\tfilter_mode include source_list 192.0.2.1\n\n\t# IS_IN ( 192.0.2.2 )\n\t$MZ $h1.10 -a own -b 01:00:5e:01:01:01 -c 1 -A 192.0.2.1 -B 239.1.1.1 \\\n\t\t-t ip proto=2,p=$(igmpv3_is_in_get 239.1.1.1 192.0.2.2) -q\n\n\tbridge -d mdb show dev br0 vid 10 | grep 239.1.1.1 | grep -v \"src\" | \\\n\t\tgrep -q 192.0.2.2\n\tcheck_err $? \"Source not add to source list\"\n\n\tbridge -d mdb show dev br0 vid 10 | grep 239.1.1.1 | \\\n\t\tgrep -q \"src 192.0.2.2\"\n\tcheck_err $? \"(S, G) entry not created for new source\"\n\n\tbridge mdb del dev br0 port $swp1 grp 239.1.1.1 vid 10\n\n\tlog_test \"IGMPv3 MODE_IS_INCLUDE tests\"\n}\n\nctrl_mldv2_is_in_test()\n{\n\tRET=0\n\n\t# Add a permanent entry and check that it is not affected by the\n\t# received MLD packet.\n\tbridge mdb add dev br0 port $swp1 grp ff0e::1 permanent vid 10 \\\n\t\tfilter_mode include source_list 2001:db8:1::1\n\n\t# IS_IN ( 2001:db8:1::2 )\n\tlocal p=$(mldv2_is_in_get fe80::1 ff0e::1 2001:db8:1::2)\n\t$MZ -6 $h1.10 -a own -b 33:33:00:00:00:01 -c 1 -A fe80::1 -B ff0e::1 \\\n\t\t-t ip hop=1,next=0,p=\"$p\" -q\n\n\tbridge -d mdb show dev br0 vid 10 | grep ff0e::1 | \\\n\t\tgrep -q 2001:db8:1::2\n\tcheck_fail $? \"Permanent entry affected by MLD packet\"\n\n\t# Replace the permanent entry with a temporary one and check that after\n\t# processing the MLD packet, a new source is added to the list along\n\t# with a new forwarding entry.\n\tbridge mdb replace dev br0 port $swp1 grp ff0e::1 temp vid 10 \\\n\t\tfilter_mode include source_list 2001:db8:1::1\n\n\t# IS_IN ( 2001:db8:1::2 )\n\t$MZ -6 $h1.10 -a own -b 33:33:00:00:00:01 -c 1 -A fe80::1 -B ff0e::1 \\\n\t\t-t ip hop=1,next=0,p=\"$p\" -q\n\n\tbridge -d mdb show dev br0 vid 10 | grep ff0e::1 | grep -v \"src\" | \\\n\t\tgrep -q 2001:db8:1::2\n\tcheck_err $? \"Source not add to source list\"\n\n\tbridge -d mdb show dev br0 vid 10 | grep ff0e::1 | \\\n\t\tgrep -q \"src 2001:db8:1::2\"\n\tcheck_err $? \"(S, G) entry not created for new source\"\n\n\tbridge mdb del dev br0 port $swp1 grp ff0e::1 vid 10\n\n\tlog_test \"MLDv2 MODE_IS_INCLUDE tests\"\n}\n\nctrl_test()\n{\n\techo\n\tlog_info \"# Control packets tests\"\n\n\tctrl_igmpv3_is_in_test\n\tctrl_mldv2_is_in_test\n}\n\nif ! bridge mdb help 2>&1 | grep -q \"replace\"; then\n\techo \"SKIP: iproute2 too old, missing bridge mdb replace support\"\n\texit $ksft_skip\nfi\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}