{
  "module_name": "gre_multipath_nh.sh",
  "hash_id": "b34f2467e5d128558be27dc2bfb18d53c19a7af576096aa1afba02bdc437e4b4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/gre_multipath_nh.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test traffic distribution when a wECMP route forwards traffic to two GRE\n# tunnels.\n#\n# +-------------------------+\n# | H1                      |\n# |               $h1 +     |\n# |      192.0.2.1/28 |     |\n# |  2001:db8:1::1/64 |     |\n# +-------------------|-----+\n#                     |\n# +-------------------|------------------------+\n# | SW1               |                        |\n# |              $ol1 +                        |\n# |      192.0.2.2/28                          |\n# |  2001:db8:1::2/64                          |\n# |                                            |\n# |  + g1a (gre)          + g1b (gre)          |\n# |    loc=192.0.2.65       loc=192.0.2.81     |\n# |    rem=192.0.2.66 --.   rem=192.0.2.82 --. |\n# |    tos=inherit      |   tos=inherit      | |\n# |  .------------------'                    | |\n# |  |                    .------------------' |\n# |  v                    v                    |\n# |  + $ul1.111 (vlan)    + $ul1.222 (vlan)    |\n# |  | 192.0.2.129/28     | 192.0.2.145/28     |\n# |   \\                  /                     |\n# |    \\________________/                      |\n# |            |                               |\n# |            + $ul1                          |\n# +------------|-------------------------------+\n#              |\n# +------------|-------------------------------+\n# | SW2        + $ul2                          |\n# |     _______|________                       |\n# |    /                \\                      |\n# |   /                  \\                     |\n# |  + $ul2.111 (vlan)    + $ul2.222 (vlan)    |\n# |  ^ 192.0.2.130/28     ^ 192.0.2.146/28     |\n# |  |                    |                    |\n# |  |                    '------------------. |\n# |  '------------------.                    | |\n# |  + g2a (gre)        | + g2b (gre)        | |\n# |    loc=192.0.2.66   |   loc=192.0.2.82   | |\n# |    rem=192.0.2.65 --'   rem=192.0.2.81 --' |\n# |    tos=inherit          tos=inherit        |\n# |                                            |\n# |              $ol2 +                        |\n# |     192.0.2.17/28 |                        |\n# |  2001:db8:2::1/64 |                        |\n# +-------------------|------------------------+\n#                     |\n# +-------------------|-----+\n# | H2                |     |\n# |               $h2 +     |\n# |     192.0.2.18/28       |\n# |  2001:db8:2::2/64       |\n# +-------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\tmultipath_ipv4\n\tmultipath_ipv6\n\tmultipath_ipv6_l4\n\"\n\nNUM_NETIFS=6\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n\tip route add vrf v$h1 192.0.2.16/28 via 192.0.2.2\n\tip route add vrf v$h1 2001:db8:2::/64 via 2001:db8:1::2\n}\n\nh1_destroy()\n{\n\tip route del vrf v$h1 2001:db8:2::/64 via 2001:db8:1::2\n\tip route del vrf v$h1 192.0.2.16/28 via 192.0.2.2\n\tsimple_if_fini $h1 192.0.2.1/28\n}\n\nsw1_create()\n{\n\tsimple_if_init $ol1 192.0.2.2/28 2001:db8:1::2/64\n\t__simple_if_init $ul1 v$ol1\n\tvlan_create $ul1 111 v$ol1 192.0.2.129/28\n\tvlan_create $ul1 222 v$ol1 192.0.2.145/28\n\n\ttunnel_create g1a gre 192.0.2.65 192.0.2.66 tos inherit dev v$ol1\n\t__simple_if_init g1a v$ol1 192.0.2.65/32\n\tip route add vrf v$ol1 192.0.2.66/32 via 192.0.2.130\n\n\ttunnel_create g1b gre 192.0.2.81 192.0.2.82 tos inherit dev v$ol1\n\t__simple_if_init g1b v$ol1 192.0.2.81/32\n\tip route add vrf v$ol1 192.0.2.82/32 via 192.0.2.146\n\n\tip -6 nexthop add id 101 dev g1a\n\tip -6 nexthop add id 102 dev g1b\n\tip nexthop add id 103 group 101/102\n\n\tip route add vrf v$ol1 192.0.2.16/28 nhid 103\n\tip route add vrf v$ol1 2001:db8:2::/64 nhid 103\n}\n\nsw1_destroy()\n{\n\tip route del vrf v$ol1 2001:db8:2::/64\n\tip route del vrf v$ol1 192.0.2.16/28\n\n\tip nexthop del id 103\n\tip -6 nexthop del id 102\n\tip -6 nexthop del id 101\n\n\tip route del vrf v$ol1 192.0.2.82/32 via 192.0.2.146\n\t__simple_if_fini g1b 192.0.2.81/32\n\ttunnel_destroy g1b\n\n\tip route del vrf v$ol1 192.0.2.66/32 via 192.0.2.130\n\t__simple_if_fini g1a 192.0.2.65/32\n\ttunnel_destroy g1a\n\n\tvlan_destroy $ul1 222\n\tvlan_destroy $ul1 111\n\t__simple_if_fini $ul1\n\tsimple_if_fini $ol1 192.0.2.2/28 2001:db8:1::2/64\n}\n\nsw2_create()\n{\n\tsimple_if_init $ol2 192.0.2.17/28 2001:db8:2::1/64\n\t__simple_if_init $ul2 v$ol2\n\tvlan_create $ul2 111 v$ol2 192.0.2.130/28\n\tvlan_create $ul2 222 v$ol2 192.0.2.146/28\n\n\ttunnel_create g2a gre 192.0.2.66 192.0.2.65 tos inherit dev v$ol2\n\t__simple_if_init g2a v$ol2 192.0.2.66/32\n\tip route add vrf v$ol2 192.0.2.65/32 via 192.0.2.129\n\n\ttunnel_create g2b gre 192.0.2.82 192.0.2.81 tos inherit dev v$ol2\n\t__simple_if_init g2b v$ol2 192.0.2.82/32\n\tip route add vrf v$ol2 192.0.2.81/32 via 192.0.2.145\n\n\tip -6 nexthop add id 201 dev g2a\n\tip -6 nexthop add id 202 dev g2b\n\tip nexthop add id 203 group 201/202\n\n\tip route add vrf v$ol2 192.0.2.0/28 nhid 203\n\tip route add vrf v$ol2 2001:db8:1::/64 nhid 203\n\n\ttc qdisc add dev $ul2 clsact\n\ttc filter add dev $ul2 ingress pref 111 prot 802.1Q \\\n\t   flower vlan_id 111 action pass\n\ttc filter add dev $ul2 ingress pref 222 prot 802.1Q \\\n\t   flower vlan_id 222 action pass\n}\n\nsw2_destroy()\n{\n\ttc qdisc del dev $ul2 clsact\n\n\tip route del vrf v$ol2 2001:db8:1::/64\n\tip route del vrf v$ol2 192.0.2.0/28\n\n\tip nexthop del id 203\n\tip -6 nexthop del id 202\n\tip -6 nexthop del id 201\n\n\tip route del vrf v$ol2 192.0.2.81/32 via 192.0.2.145\n\t__simple_if_fini g2b 192.0.2.82/32\n\ttunnel_destroy g2b\n\n\tip route del vrf v$ol2 192.0.2.65/32 via 192.0.2.129\n\t__simple_if_fini g2a 192.0.2.66/32\n\ttunnel_destroy g2a\n\n\tvlan_destroy $ul2 222\n\tvlan_destroy $ul2 111\n\t__simple_if_fini $ul2\n\tsimple_if_fini $ol2 192.0.2.17/28 2001:db8:2::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.18/28 2001:db8:2::2/64\n\tip route add vrf v$h2 192.0.2.0/28 via 192.0.2.17\n\tip route add vrf v$h2 2001:db8:1::/64 via 2001:db8:2::1\n}\n\nh2_destroy()\n{\n\tip route del vrf v$h2 2001:db8:1::/64 via 2001:db8:2::1\n\tip route del vrf v$h2 192.0.2.0/28 via 192.0.2.17\n\tsimple_if_fini $h2 192.0.2.18/28 2001:db8:2::2/64\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tol1=${NETIFS[p2]}\n\n\tul1=${NETIFS[p3]}\n\tul2=${NETIFS[p4]}\n\n\tol2=${NETIFS[p5]}\n\th2=${NETIFS[p6]}\n\n\tvrf_prepare\n\th1_create\n\tsw1_create\n\tsw2_create\n\th2_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\th2_destroy\n\tsw2_destroy\n\tsw1_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nmultipath4_test()\n{\n\tlocal what=$1; shift\n\tlocal weight1=$1; shift\n\tlocal weight2=$1; shift\n\n\tsysctl_set net.ipv4.fib_multipath_hash_policy 1\n\tip nexthop replace id 103 group 101,$weight1/102,$weight2\n\n\tlocal t0_111=$(tc_rule_stats_get $ul2 111 ingress)\n\tlocal t0_222=$(tc_rule_stats_get $ul2 222 ingress)\n\n\tip vrf exec v$h1 \\\n\t   $MZ $h1 -q -p 64 -A 192.0.2.1 -B 192.0.2.18 \\\n\t       -d 1msec -t udp \"sp=1024,dp=0-32768\"\n\n\tlocal t1_111=$(tc_rule_stats_get $ul2 111 ingress)\n\tlocal t1_222=$(tc_rule_stats_get $ul2 222 ingress)\n\n\tlocal d111=$((t1_111 - t0_111))\n\tlocal d222=$((t1_222 - t0_222))\n\tmultipath_eval \"$what\" $weight1 $weight2 $d111 $d222\n\n\tip nexthop replace id 103 group 101/102\n\tsysctl_restore net.ipv4.fib_multipath_hash_policy\n}\n\nmultipath6_test()\n{\n\tlocal what=$1; shift\n\tlocal weight1=$1; shift\n\tlocal weight2=$1; shift\n\n\tsysctl_set net.ipv6.fib_multipath_hash_policy 0\n\tip nexthop replace id 103 group 101,$weight1/102,$weight2\n\n\tlocal t0_111=$(tc_rule_stats_get $ul2 111 ingress)\n\tlocal t0_222=$(tc_rule_stats_get $ul2 222 ingress)\n\n\t# Generate 16384 echo requests, each with a random flow label.\n\tfor ((i=0; i < 16384; ++i)); do\n\t\tip vrf exec v$h1 $PING6 2001:db8:2::2 -F 0 -c 1 -q &> /dev/null\n\tdone\n\n\tlocal t1_111=$(tc_rule_stats_get $ul2 111 ingress)\n\tlocal t1_222=$(tc_rule_stats_get $ul2 222 ingress)\n\n\tlocal d111=$((t1_111 - t0_111))\n\tlocal d222=$((t1_222 - t0_222))\n\tmultipath_eval \"$what\" $weight1 $weight2 $d111 $d222\n\n\tip nexthop replace id 103 group 101/102\n\tsysctl_restore net.ipv6.fib_multipath_hash_policy\n}\n\nmultipath6_l4_test()\n{\n\tlocal what=$1; shift\n\tlocal weight1=$1; shift\n\tlocal weight2=$1; shift\n\n\tsysctl_set net.ipv6.fib_multipath_hash_policy 1\n\tip nexthop replace id 103 group 101,$weight1/102,$weight2\n\n\tlocal t0_111=$(tc_rule_stats_get $ul2 111 ingress)\n\tlocal t0_222=$(tc_rule_stats_get $ul2 222 ingress)\n\n\tip vrf exec v$h1 \\\n\t\t$MZ $h1 -6 -q -p 64 -A 2001:db8:1::1 -B 2001:db8:2::2 \\\n\t\t-d 1msec -t udp \"sp=1024,dp=0-32768\"\n\n\tlocal t1_111=$(tc_rule_stats_get $ul2 111 ingress)\n\tlocal t1_222=$(tc_rule_stats_get $ul2 222 ingress)\n\n\tlocal d111=$((t1_111 - t0_111))\n\tlocal d222=$((t1_222 - t0_222))\n\tmultipath_eval \"$what\" $weight1 $weight2 $d111 $d222\n\n\tip nexthop replace id 103 group 101/102\n\tsysctl_restore net.ipv6.fib_multipath_hash_policy\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.18\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::2\n}\n\nmultipath_ipv4()\n{\n\tlog_info \"Running IPv4 multipath tests\"\n\tmultipath4_test \"ECMP\" 1 1\n\tmultipath4_test \"Weighted MP 2:1\" 2 1\n\tmultipath4_test \"Weighted MP 11:45\" 11 45\n}\n\nmultipath_ipv6()\n{\n\tlog_info \"Running IPv6 multipath tests\"\n\tmultipath6_test \"ECMP\" 1 1\n\tmultipath6_test \"Weighted MP 2:1\" 2 1\n\tmultipath6_test \"Weighted MP 11:45\" 11 45\n}\n\nmultipath_ipv6_l4()\n{\n\tlog_info \"Running IPv6 L4 hash multipath tests\"\n\tmultipath6_l4_test \"ECMP\" 1 1\n\tmultipath6_l4_test \"Weighted MP 2:1\" 2 1\n\tmultipath6_l4_test \"Weighted MP 11:45\" 11 45\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}