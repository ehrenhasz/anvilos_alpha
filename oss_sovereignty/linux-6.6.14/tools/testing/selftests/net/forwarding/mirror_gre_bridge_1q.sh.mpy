{
  "module_name": "mirror_gre_bridge_1q.sh",
  "hash_id": "cd12fe2b23cc6f0ad9dfd33ec82f5c711aa0bcbe422727fb21c71469485db918",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_bridge_1q.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test for \"tc action mirred egress mirror\" when the underlay route points at a\n# bridge device with vlan filtering (802.1q).\n#\n# This test uses standard topology for testing mirror-to-gretap. See\n# mirror_gre_topo_lib.sh for more details. The full topology is as follows:\n#\n#  +---------------------+                               +---------------------+\n#  | H1                  |                               |                  H2 |\n#  |     + $h1           |                               |           $h2 +     |\n#  |     | 192.0.2.1/28  |                               |  192.0.2.2/28 |     |\n#  +-----|---------------+                               +---------------|-----+\n#        |                                                               |\n#  +-----|---------------------------------------------------------------|-----+\n#  | SW  o---> mirror                                                    |     |\n#  | +---|---------------------------------------------------------------|---+ |\n#  | |   + $swp1                  + br1 (802.1q bridge)            $swp2 +   | |\n#  | |                              192.0.2.129/28                           | |\n#  | |   + $swp3                    2001:db8:2::1/64                         | |\n#  | |   | vid555                   vid555[pvid,untagged]                    | |\n#  | +---|-------------------------------------------------------------------+ |\n#  |     |                                          ^                      ^   |\n#  |     |                     + gt6 (ip6gretap)    |   + gt4 (gretap)     |   |\n#  |     |                     : loc=2001:db8:2::1  |   : loc=192.0.2.129  |   |\n#  |     |                     : rem=2001:db8:2::2 -+   : rem=192.0.2.130 -+   |\n#  |     |                     : ttl=100                : ttl=100              |\n#  |     |                     : tos=inherit            : tos=inherit          |\n#  +-----|---------------------:------------------------:----------------------+\n#        |                     :                        :\n#  +-----|---------------------:------------------------:----------------------+\n#  | H3  + $h3                 + h3-gt6(ip6gretap)      + h3-gt4 (gretap)      |\n#  |     |                       loc=2001:db8:2::2        loc=192.0.2.130      |\n#  |     + $h3.555               rem=2001:db8:2::1        rem=192.0.2.129      |\n#  |       192.0.2.130/28        ttl=100                  ttl=100              |\n#  |       2001:db8:2::2/64      tos=inherit              tos=inherit          |\n#  +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\ttest_gretap\n\ttest_ip6gretap\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\nsource mirror_gre_topo_lib.sh\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tvrf_prepare\n\tmirror_gre_topo_create\n\t# Avoid changing br1's PVID while it is operational as a L3 interface.\n\tip link set dev br1 down\n\n\tip link set dev $swp3 master br1\n\tbridge vlan add dev br1 vid 555 pvid untagged self\n\tip link set dev br1 up\n\tip address add dev br1 192.0.2.129/28\n\tip address add dev br1 2001:db8:2::1/64\n\n\tip -4 route add 192.0.2.130/32 dev br1\n\tip -6 route add 2001:db8:2::2/128 dev br1\n\n\tvlan_create $h3 555 v$h3 192.0.2.130/28 2001:db8:2::2/64\n\tbridge vlan add dev $swp3 vid 555\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip link set dev $swp3 nomaster\n\tvlan_destroy $h3 555\n\n\tmirror_gre_topo_destroy\n\tvrf_cleanup\n}\n\ntest_gretap()\n{\n\tip neigh replace 192.0.2.130 lladdr $(mac_get $h3) \\\n\t\t nud permanent dev br1\n\tfull_test_span_gre_dir gt4 ingress 8 0 \"mirror to gretap\"\n\tfull_test_span_gre_dir gt4 egress 0 8 \"mirror to gretap\"\n}\n\ntest_ip6gretap()\n{\n\tip neigh replace 2001:db8:2::2 lladdr $(mac_get $h3) \\\n\t\tnud permanent dev br1\n\tfull_test_span_gre_dir gt6 ingress 8 0 \"mirror to ip6gretap\"\n\tfull_test_span_gre_dir gt6 egress 0 8 \"mirror to ip6gretap\"\n}\n\ntests()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntests\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttests\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}