{
  "module_name": "ip6_forward_instats_vrf.sh",
  "hash_id": "ddddaf4bd3ae820d676571f1c3fa95caab040e202d61f4e261c9613fde6bd356",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/ip6_forward_instats_vrf.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test ipv6 stats on the incoming if when forwarding with VRF\n\nALL_TESTS=\"\n\tipv6_ping\n\tipv6_in_too_big_err\n\tipv6_in_hdr_err\n\tipv6_in_addr_err\n\tipv6_in_discard\n\"\n\nNUM_NETIFS=4\nsource lib.sh\n\nrequire_command $TROUTE6\n\nh1_create()\n{\n\tsimple_if_init $h1 2001:1:1::2/64\n\tip -6 route add vrf v$h1 2001:1:2::/64 via 2001:1:1::1\n}\n\nh1_destroy()\n{\n\tip -6 route del vrf v$h1 2001:1:2::/64 via 2001:1:1::1\n\tsimple_if_fini $h1 2001:1:1::2/64\n}\n\nrouter_create()\n{\n\tvrf_create router\n\t__simple_if_init $rtr1 router 2001:1:1::1/64\n\t__simple_if_init $rtr2 router 2001:1:2::1/64\n\tmtu_set $rtr2 1280\n}\n\nrouter_destroy()\n{\n\tmtu_restore $rtr2\n\t__simple_if_fini $rtr2 2001:1:2::1/64\n\t__simple_if_fini $rtr1 2001:1:1::1/64\n\tvrf_destroy router\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 2001:1:2::2/64\n\tip -6 route add vrf v$h2 2001:1:1::/64 via 2001:1:2::1\n\tmtu_set $h2 1280\n}\n\nh2_destroy()\n{\n\tmtu_restore $h2\n\tip -6 route del vrf v$h2 2001:1:1::/64 via 2001:1:2::1\n\tsimple_if_fini $h2 2001:1:2::2/64\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trtr1=${NETIFS[p2]}\n\n\trtr2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\th1_create\n\trouter_create\n\th2_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\th2_destroy\n\trouter_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nipv6_in_too_big_err()\n{\n\tRET=0\n\n\tlocal t0=$(ipv6_stats_get $rtr1 Ip6InTooBigErrors)\n\tlocal vrf_name=$(master_name_get $h1)\n\n\t# Send too big packets\n\tip vrf exec $vrf_name \\\n\t\t$PING6 -s 1300 2001:1:2::2 -c 1 -w $PING_TIMEOUT &> /dev/null\n\n\tlocal t1=$(ipv6_stats_get $rtr1 Ip6InTooBigErrors)\n\ttest \"$((t1 - t0))\" -ne 0\n\tcheck_err $?\n\tlog_test \"Ip6InTooBigErrors\"\n}\n\nipv6_in_hdr_err()\n{\n\tRET=0\n\n\tlocal t0=$(ipv6_stats_get $rtr1 Ip6InHdrErrors)\n\tlocal vrf_name=$(master_name_get $h1)\n\n\t# Send packets with hop limit 1, easiest with traceroute6 as some ping6\n\t# doesn't allow hop limit to be specified\n\tip vrf exec $vrf_name \\\n\t\t$TROUTE6 2001:1:2::2 &> /dev/null\n\n\tlocal t1=$(ipv6_stats_get $rtr1 Ip6InHdrErrors)\n\ttest \"$((t1 - t0))\" -ne 0\n\tcheck_err $?\n\tlog_test \"Ip6InHdrErrors\"\n}\n\nipv6_in_addr_err()\n{\n\tRET=0\n\n\tlocal t0=$(ipv6_stats_get $rtr1 Ip6InAddrErrors)\n\tlocal vrf_name=$(master_name_get $h1)\n\n\t# Disable forwarding temporary while sending the packet\n\tsysctl -qw net.ipv6.conf.all.forwarding=0\n\tip vrf exec $vrf_name \\\n\t\t$PING6 2001:1:2::2 -c 1 -w $PING_TIMEOUT &> /dev/null\n\tsysctl -qw net.ipv6.conf.all.forwarding=1\n\n\tlocal t1=$(ipv6_stats_get $rtr1 Ip6InAddrErrors)\n\ttest \"$((t1 - t0))\" -ne 0\n\tcheck_err $?\n\tlog_test \"Ip6InAddrErrors\"\n}\n\nipv6_in_discard()\n{\n\tRET=0\n\n\tlocal t0=$(ipv6_stats_get $rtr1 Ip6InDiscards)\n\tlocal vrf_name=$(master_name_get $h1)\n\n\t# Add a policy to discard\n\tip xfrm policy add dst 2001:1:2::2/128 dir fwd action block\n\tip vrf exec $vrf_name \\\n\t\t$PING6 2001:1:2::2 -c 1 -w $PING_TIMEOUT &> /dev/null\n\tip xfrm policy del dst 2001:1:2::2/128 dir fwd\n\n\tlocal t1=$(ipv6_stats_get $rtr1 Ip6InDiscards)\n\ttest \"$((t1 - t0))\" -ne 0\n\tcheck_err $?\n\tlog_test \"Ip6InDiscards\"\n}\nipv6_ping()\n{\n\tRET=0\n\n\tping6_test $h1 2001:1:2::2\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}