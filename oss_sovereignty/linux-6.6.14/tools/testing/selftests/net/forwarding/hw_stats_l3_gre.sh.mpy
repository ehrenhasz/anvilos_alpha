{
  "module_name": "hw_stats_l3_gre.sh",
  "hash_id": "50525dc06f35061476ce42c2abe3fa8585f9dfab0fb1d6d007b9c3c986591fe4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/hw_stats_l3_gre.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test L3 stats on IP-in-IP GRE tunnel without key.\n\n# This test uses flat topology for IP tunneling tests. See ipip_lib.sh for more\n# details.\n\nALL_TESTS=\"\n\tping_ipv4\n\ttest_stats_rx\n\ttest_stats_tx\n\"\nNUM_NETIFS=6\nsource lib.sh\nsource ipip_lib.sh\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tol1=${NETIFS[p2]}\n\n\tul1=${NETIFS[p3]}\n\tul2=${NETIFS[p4]}\n\n\tol2=${NETIFS[p5]}\n\th2=${NETIFS[p6]}\n\n\tol1mac=$(mac_get $ol1)\n\n\tforwarding_enable\n\tvrf_prepare\n\th1_create\n\th2_create\n\tsw1_flat_create gre $ol1 $ul1\n\tsw2_flat_create gre $ol2 $ul2\n\tip stats set dev g1a l3_stats on\n\tip stats set dev g2a l3_stats on\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip stats set dev g1a l3_stats off\n\tip stats set dev g2a l3_stats off\n\n\tsw2_flat_destroy $ol2 $ul2\n\tsw1_flat_destroy $ol1 $ul1\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n\tforwarding_restore\n}\n\nping_ipv4()\n{\n\tRET=0\n\n\tping_test $h1 192.0.2.18 \" gre flat\"\n}\n\nsend_packets_ipv4()\n{\n\t# Send 21 packets instead of 20, because the first one might trap and go\n\t# through the SW datapath, which might not bump the HW counter.\n\t$MZ $h1 -c 21 -d 20msec -p 100 \\\n\t    -a own -b $ol1mac -A 192.0.2.1 -B 192.0.2.18 \\\n\t    -q -t udp sp=54321,dp=12345\n}\n\ntest_stats()\n{\n\tlocal dev=$1; shift\n\tlocal dir=$1; shift\n\n\tlocal a\n\tlocal b\n\n\tRET=0\n\n\ta=$(hw_stats_get l3_stats $dev $dir packets)\n\tsend_packets_ipv4\n\tb=$(busywait \"$TC_HIT_TIMEOUT\" until_counter_is \">= $a + 20\" \\\n\t\t     hw_stats_get l3_stats $dev $dir packets)\n\tcheck_err $? \"Traffic not reflected in the counter: $a -> $b\"\n\n\tlog_test \"Test $dir packets: $prot\"\n}\n\ntest_stats_tx()\n{\n\ttest_stats g1a tx\n}\n\ntest_stats_rx()\n{\n\ttest_stats g2a rx\n}\n\nskip_on_veth\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}