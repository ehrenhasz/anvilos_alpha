{
  "module_name": "router_bridge_lag.sh",
  "hash_id": "1e33c06d1d9d4fb127d3aeeeb5a2008dd9009adcb310ba5c4ec2f2a5db66795d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/router_bridge_lag.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +----------------------------+                   +--------------------------+\n# | H1 (vrf)                   |                   |                 H2 (vrf) |\n# |                            |                   |                          |\n# |        + LAG1 (team)       |                   |     + LAG4 (team)        |\n# |        | 192.0.2.1/28      |                   |     | 192.0.2.130/28     |\n# |        | 2001:db8:1::1/64  |                   |     | 2001:db8:2::2/64   |\n# |      __^___                |                   |   __^_____               |\n# |     /      \\               |                   |  /        \\              |\n# |    + $h1    + $h4          |                   | + $h2      + $h3         |\n# |    |        |              |                   | |          |             |\n# +----|--------|--------------+                   +-|----------|-------------+\n#      |        |                                    |          |\n# +----|--------|------------------------------------|----------|-------------+\n# | SW |        |                                    |          |             |\n# |    + $swp1  + $swp4                              + $swp2    + $swp3       |\n# |     \\__ ___/                                      \\__ _____/              |\n# |        v                                             v                    |\n# | +------|-------------------------------+             |                    |\n# | |      + LAG2       BR1 (802.1q)       |             + LAG3 (team)        |\n# | |        (team)       192.0.2.2/28     |               192.0.2.129/28     |\n# | |                     2001:db8:1::2/64 |               2001:db8:2::1/64   |\n# | |                                      |                                  |\n# | +--------------------------------------+                                  |\n# +---------------------------------------------------------------------------+\n\n: ${ALL_TESTS:=\"\n\tping_ipv4\n\tping_ipv6\n\n\t$(: exercise remastering of LAG2 slaves )\n\tconfig_deslave_swp4\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_enslave_swp4\n\tconfig_deslave_swp1\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_deslave_swp4\n\tconfig_enslave_swp1\n\tconfig_enslave_swp4\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\n\t$(: exercise remastering of LAG2 itself )\n\tconfig_remaster_lag2\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\n\t$(: exercise remastering of LAG3 slaves )\n\tconfig_deslave_swp2\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_enslave_swp2\n\tconfig_deslave_swp3\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_deslave_swp2\n\tconfig_enslave_swp3\n\tconfig_enslave_swp2\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\n\t$(: move LAG3 to a bridge and then out )\n\tconfig_remaster_lag3\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n    \"}\nNUM_NETIFS=8\n: ${lib_dir:=.}\nsource $lib_dir/lib.sh\n$EXTRA_SOURCE\n\nh1_create()\n{\n\tteam_create lag1 lacp\n\tip link set dev lag1 address $(mac_get $h1)\n\tip link set dev $h1 master lag1\n\tip link set dev $h4 master lag1\n\tsimple_if_init lag1 192.0.2.1/28 2001:db8:1::1/64\n\tip link set dev $h1 up\n\tip link set dev $h4 up\n\tip -4 route add 192.0.2.128/28 vrf vlag1 nexthop via 192.0.2.2\n\tip -6 route add 2001:db8:2::/64 vrf vlag1 nexthop via 2001:db8:1::2\n}\n\nh1_destroy()\n{\n\tip -6 route del 2001:db8:2::/64 vrf vlag1\n\tip -4 route del 192.0.2.128/28 vrf vlag1\n\tip link set dev $h4 down\n\tip link set dev $h1 down\n\tsimple_if_fini lag1 192.0.2.1/28 2001:db8:1::1/64\n\tip link set dev $h4 nomaster\n\tip link set dev $h1 nomaster\n\tteam_destroy lag1\n}\n\nh2_create()\n{\n\tteam_create lag4 lacp\n\tip link set dev lag4 address $(mac_get $h2)\n\tip link set dev $h2 master lag4\n\tip link set dev $h3 master lag4\n\tsimple_if_init lag4 192.0.2.130/28 2001:db8:2::2/64\n\tip link set dev $h2 up\n\tip link set dev $h3 up\n\tip -4 route add 192.0.2.0/28 vrf vlag4 nexthop via 192.0.2.129\n\tip -6 route add 2001:db8:1::/64 vrf vlag4 nexthop via 2001:db8:2::1\n}\n\nh2_destroy()\n{\n\tip -6 route del 2001:db8:1::/64 vrf vlag4\n\tip -4 route del 192.0.2.0/28 vrf vlag4\n\tip link set dev $h3 down\n\tip link set dev $h2 down\n\tsimple_if_fini lag4 192.0.2.130/28 2001:db8:2::2/64\n\tip link set dev $h3 nomaster\n\tip link set dev $h2 nomaster\n\tteam_destroy lag4\n}\n\nrouter_create()\n{\n\tteam_create lag2 lacp\n\tip link set dev lag2 address $(mac_get $swp1)\n\tip link set dev $swp1 master lag2\n\tip link set dev $swp4 master lag2\n\n\tip link add name br1 address $(mac_get lag2) \\\n\t\ttype bridge vlan_filtering 1\n\tip link set dev lag2 master br1\n\n\tip link set dev $swp1 up\n\tip link set dev $swp4 up\n\tip link set dev br1 up\n\n\t__addr_add_del br1 add 192.0.2.2/28 2001:db8:1::2/64\n\n\tteam_create lag3 lacp\n\tip link set dev lag3 address $(mac_get $swp2)\n\tip link set dev $swp2 master lag3\n\tip link set dev $swp3 master lag3\n\tip link set dev $swp2 up\n\tip link set dev $swp3 up\n\t__addr_add_del lag3 add 192.0.2.129/28 2001:db8:2::1/64\n}\n\nrouter_destroy()\n{\n\t__addr_add_del lag3 del 192.0.2.129/28 2001:db8:2::1/64\n\tip link set dev $swp3 down\n\tip link set dev $swp2 down\n\tip link set dev $swp3 nomaster\n\tip link set dev $swp2 nomaster\n\tteam_destroy lag3\n\n\t__addr_add_del br1 del 192.0.2.2/28 2001:db8:1::2/64\n\n\tip link set dev $swp4 down\n\tip link set dev $swp1 down\n\tip link set dev br1 down\n\n\tip link set dev lag2 nomaster\n\tip link del dev br1\n\n\tip link set dev $swp4 nomaster\n\tip link set dev $swp1 nomaster\n\tteam_destroy lag2\n}\n\nconfig_remaster_lag2()\n{\n\tlog_info \"Remaster bridge slave\"\n\n\tip link set dev lag2 nomaster\n\tsleep 2\n\tip link set dev lag2 master br1\n}\n\nconfig_remaster_lag3()\n{\n\tlog_info \"Move lag3 to the bridge, then out again\"\n\n\tip link set dev lag3 master br1\n\tsleep 2\n\tip link set dev lag3 nomaster\n}\n\nconfig_deslave()\n{\n\tlocal netdev=$1; shift\n\n\tlog_info \"Deslave $netdev\"\n\tip link set dev $netdev down\n\tip link set dev $netdev nomaster\n\tip link set dev $netdev up\n}\n\nconfig_deslave_swp1()\n{\n\tconfig_deslave $swp1\n}\n\nconfig_deslave_swp2()\n{\n\tconfig_deslave $swp2\n}\n\nconfig_deslave_swp3()\n{\n\tconfig_deslave $swp3\n}\n\nconfig_deslave_swp4()\n{\n\tconfig_deslave $swp4\n}\n\nconfig_enslave()\n{\n\tlocal netdev=$1; shift\n\tlocal master=$1; shift\n\n\tlog_info \"Enslave $netdev to $master\"\n\tip link set dev $netdev down\n\tip link set dev $netdev master $master\n\tip link set dev $netdev up\n}\n\nconfig_enslave_swp1()\n{\n\tconfig_enslave $swp1 lag2\n}\n\nconfig_enslave_swp2()\n{\n\tconfig_enslave $swp2 lag3\n}\n\nconfig_enslave_swp3()\n{\n\tconfig_enslave $swp3 lag3\n}\n\nconfig_enslave_swp4()\n{\n\tconfig_enslave $swp4 lag2\n}\n\nconfig_wait()\n{\n\tsetup_wait_dev lag2\n\tsetup_wait_dev lag3\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\th4=${NETIFS[p7]}\n\tswp4=${NETIFS[p8]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test lag1 192.0.2.130\n}\n\nping_ipv6()\n{\n\tping6_test lag1 2001:db8:2::2\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}