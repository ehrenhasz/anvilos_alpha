{
  "module_name": "pedit_ip.sh",
  "hash_id": "d2f6de9a45e9b878993069f3ebe4dbac85036bb1ee3873618773ef586eb8a183",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/pedit_ip.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test sends traffic from H1 to H2. Either on ingress of $swp1, or on\n# egress of $swp2, the traffic is acted upon by a pedit action. An ingress\n# filter installed on $h2 verifies that the packet looks like expected.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |    + $h1             |                             |            $h2 +     |\n# |    | 192.0.2.1/28    |                             |   192.0.2.2/28 |     |\n# +----|-----------------+                             +----------------|-----+\n#      |                                                                |\n# +----|----------------------------------------------------------------|-----+\n# | SW |                                                                |     |\n# |  +-|----------------------------------------------------------------|-+   |\n# |  | + $swp1                       BR                           $swp2 + |   |\n# |  +--------------------------------------------------------------------+   |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\ttest_ip4_src\n\ttest_ip4_dst\n\ttest_ip6_src\n\ttest_ip6_dst\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/28 2001:db8:1::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/28 2001:db8:1::2/64\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2 192.0.2.2/28 2001:db8:1::2/64\n}\n\nswitch_create()\n{\n\tip link add name br1 up type bridge vlan_filtering 1\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\n\ttc qdisc add dev $swp1 clsact\n\ttc qdisc add dev $swp2 clsact\n}\n\nswitch_destroy()\n{\n\ttc qdisc del dev $swp2 clsact\n\ttc qdisc del dev $swp1 clsact\n\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\tip link del dev br1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\th2mac=$(mac_get $h2)\n\n\tvrf_prepare\n\th1_create\n\th2_create\n\tswitch_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:1::2\n}\n\ndo_test_pedit_ip()\n{\n\tlocal pedit_locus=$1; shift\n\tlocal pedit_action=$1; shift\n\tlocal match_prot=$1; shift\n\tlocal match_flower=$1; shift\n\tlocal mz_flags=$1; shift\n\n\ttc filter add $pedit_locus handle 101 pref 1 \\\n\t   flower action pedit ex munge $pedit_action\n\ttc filter add dev $h2 ingress handle 101 pref 1 prot $match_prot \\\n\t   flower skip_hw $match_flower action pass\n\n\tRET=0\n\n\t$MZ $mz_flags $h1 -c 10 -d 20msec -p 100 -a own -b $h2mac -q -t ip\n\n\tlocal pkts\n\tpkts=$(busywait \"$TC_HIT_TIMEOUT\" until_counter_is \">= 10\" \\\n\t\t\ttc_rule_handle_stats_get \"dev $h2 ingress\" 101)\n\tcheck_err $? \"Expected to get 10 packets, but got $pkts.\"\n\n\tpkts=$(tc_rule_handle_stats_get \"$pedit_locus\" 101)\n\t((pkts >= 10))\n\tcheck_err $? \"Expected to get 10 packets on pedit rule, but got $pkts.\"\n\n\tlog_test \"$pedit_locus pedit $pedit_action\"\n\n\ttc filter del dev $h2 ingress pref 1\n\ttc filter del $pedit_locus pref 1\n}\n\ndo_test_pedit_ip6()\n{\n\tlocal locus=$1; shift\n\tlocal pedit_addr=$1; shift\n\tlocal flower_addr=$1; shift\n\n\tdo_test_pedit_ip \"$locus\" \"$pedit_addr set 2001:db8:2::1\" ipv6\t\\\n\t\t\t \"$flower_addr 2001:db8:2::1\"\t\t\t\\\n\t\t\t \"-6 -A 2001:db8:1::1 -B 2001:db8:1::2\"\n}\n\ndo_test_pedit_ip4()\n{\n\tlocal locus=$1; shift\n\tlocal pedit_addr=$1; shift\n\tlocal flower_addr=$1; shift\n\n\tdo_test_pedit_ip \"$locus\" \"$pedit_addr set 198.51.100.1\" ip\t\\\n\t\t\t \"$flower_addr 198.51.100.1\"\t\t\t\\\n\t\t\t \"-A 192.0.2.1 -B 192.0.2.2\"\n}\n\ntest_ip4_src()\n{\n\tdo_test_pedit_ip4 \"dev $swp1 ingress\" \"ip src\" src_ip\n\tdo_test_pedit_ip4 \"dev $swp2 egress\"  \"ip src\" src_ip\n}\n\ntest_ip4_dst()\n{\n\tdo_test_pedit_ip4 \"dev $swp1 ingress\" \"ip dst\" dst_ip\n\tdo_test_pedit_ip4 \"dev $swp2 egress\"  \"ip dst\" dst_ip\n}\n\ntest_ip6_src()\n{\n\tdo_test_pedit_ip6 \"dev $swp1 ingress\" \"ip6 src\" src_ip\n\tdo_test_pedit_ip6 \"dev $swp2 egress\"  \"ip6 src\" src_ip\n}\n\ntest_ip6_dst()\n{\n\tdo_test_pedit_ip6 \"dev $swp1 ingress\" \"ip6 dst\" dst_ip\n\tdo_test_pedit_ip6 \"dev $swp2 egress\"  \"ip6 dst\" dst_ip\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}