{
  "module_name": "bridge_mdb_max.sh",
  "hash_id": "dbab12ad2f64e73ac19d0c1e7dcd335caec3044af9701af84886b7650c32414a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/bridge_mdb_max.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +-----------------------+                          +------------------------+\n# | H1 (vrf)              |                          | H2 (vrf)               |\n# | + $h1.10              |                          | + $h2.10               |\n# | | 192.0.2.1/28        |                          | | 192.0.2.2/28         |\n# | | 2001:db8:1::1/64    |                          | | 2001:db8:1::2/64     |\n# | |                     |                          | |                      |\n# | |  + $h1.20           |                          | |  + $h2.20            |\n# | \\  | 198.51.100.1/24  |                          | \\  | 198.51.100.2/24   |\n# |  \\ | 2001:db8:2::1/64 |                          |  \\ | 2001:db8:2::2/64  |\n# |   \\|                  |                          |   \\|                   |\n# |    + $h1              |                          |    + $h2               |\n# +----|------------------+                          +----|-------------------+\n#      |                                                  |\n# +----|--------------------------------------------------|-------------------+\n# | SW |                                                  |                   |\n# | +--|--------------------------------------------------|-----------------+ |\n# | |  + $swp1                   BR0 (802.1q)             + $swp2           | |\n# | |     vid 10                                             vid 10         | |\n# | |     vid 20                                             vid 20         | |\n# | |                                                                       | |\n# | +-----------------------------------------------------------------------+ |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\ttest_8021d\n\ttest_8021q\n\ttest_8021qvs\n\"\n\nNUM_NETIFS=4\nsource lib.sh\nsource tc_common.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n\tvlan_create $h1 10 v$h1 192.0.2.1/28 2001:db8:1::1/64\n\tvlan_create $h1 20 v$h1 198.51.100.1/24 2001:db8:2::1/64\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 20\n\tvlan_destroy $h1 10\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\tvlan_create $h2 10 v$h2 192.0.2.2/28\n\tvlan_create $h2 20 v$h2 198.51.100.2/24\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 20\n\tvlan_destroy $h2 10\n\tsimple_if_fini $h2\n}\n\nswitch_create_8021d()\n{\n\tlog_info \"802.1d tests\"\n\n\tip link add name br0 type bridge vlan_filtering 0 \\\n\t\tmcast_snooping 1 \\\n\t\tmcast_igmp_version 3 mcast_mld_version 2\n\tip link set dev br0 up\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp1 up\n\tbridge link set dev $swp1 fastleave on\n\n\tip link set dev $swp2 master br0\n\tip link set dev $swp2 up\n}\n\nswitch_create_8021q()\n{\n\tlocal br_flags=$1; shift\n\n\tlog_info \"802.1q $br_flags${br_flags:+ }tests\"\n\n\tip link add name br0 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 1 $br_flags \\\n\t\tmcast_igmp_version 3 mcast_mld_version 2\n\tbridge vlan add vid 10 dev br0 self\n\tbridge vlan add vid 20 dev br0 self\n\tip link set dev br0 up\n\n\tip link set dev $swp1 master br0\n\tip link set dev $swp1 up\n\tbridge link set dev $swp1 fastleave on\n\tbridge vlan add vid 10 dev $swp1\n\tbridge vlan add vid 20 dev $swp1\n\n\tip link set dev $swp2 master br0\n\tip link set dev $swp2 up\n\tbridge vlan add vid 10 dev $swp2\n\tbridge vlan add vid 20 dev $swp2\n}\n\nswitch_create_8021qvs()\n{\n\tswitch_create_8021q \"mcast_vlan_snooping 1\"\n\tbridge vlan global set dev br0 vid 10 mcast_igmp_version 3\n\tbridge vlan global set dev br0 vid 10 mcast_mld_version 2\n\tbridge vlan global set dev br0 vid 20 mcast_igmp_version 3\n\tbridge vlan global set dev br0 vid 20 mcast_mld_version 2\n}\n\nswitch_destroy()\n{\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link set dev br0 down\n\tip link del dev br0\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tswitch_destroy 2>/dev/null\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\ncfg_src_list()\n{\n\tlocal IPs=(\"$@\")\n\tlocal IPstr=$(echo ${IPs[@]} | tr '[:space:]' , | sed 's/,$//')\n\n\techo ${IPstr:+source_list }${IPstr}\n}\n\ncfg_group_op()\n{\n\tlocal op=$1; shift\n\tlocal locus=$1; shift\n\tlocal GRP=$1; shift\n\tlocal state=$1; shift\n\tlocal IPs=(\"$@\")\n\n\tlocal source_list=$(cfg_src_list ${IPs[@]})\n\n\t# Everything besides `bridge mdb' uses the \"dev X vid Y\" syntax,\n\t# so we use it here as well and convert.\n\tlocal br_locus=$(echo \"$locus\" | sed 's/^dev /port /')\n\n\tbridge mdb $op dev br0 $br_locus grp $GRP $state \\\n\t       filter_mode include $source_list\n}\n\ncfg4_entries_op()\n{\n\tlocal op=$1; shift\n\tlocal locus=$1; shift\n\tlocal state=$1; shift\n\tlocal n=$1; shift\n\tlocal grp=${1:-1}; shift\n\n\tlocal GRP=239.1.1.${grp}\n\tlocal IPs=$(seq -f 192.0.2.%g 1 $((n - 1)))\n\tcfg_group_op \"$op\" \"$locus\" \"$GRP\" \"$state\" ${IPs[@]}\n}\n\ncfg4_entries_add()\n{\n\tcfg4_entries_op add \"$@\"\n}\n\ncfg4_entries_del()\n{\n\tcfg4_entries_op del \"$@\"\n}\n\ncfg6_entries_op()\n{\n\tlocal op=$1; shift\n\tlocal locus=$1; shift\n\tlocal state=$1; shift\n\tlocal n=$1; shift\n\tlocal grp=${1:-1}; shift\n\n\tlocal GRP=ff0e::${grp}\n\tlocal IPs=$(printf \"2001:db8:1::%x\\n\" $(seq 1 $((n - 1))))\n\tcfg_group_op \"$op\" \"$locus\" \"$GRP\" \"$state\" ${IPs[@]}\n}\n\ncfg6_entries_add()\n{\n\tcfg6_entries_op add \"$@\"\n}\n\ncfg6_entries_del()\n{\n\tcfg6_entries_op del \"$@\"\n}\n\nlocus_dev_peer()\n{\n\tlocal dev_kw=$1; shift\n\tlocal dev=$1; shift\n\tlocal vid_kw=$1; shift\n\tlocal vid=$1; shift\n\n\techo \"$h1.${vid:-10}\"\n}\n\nlocus_dev()\n{\n\tlocal dev_kw=$1; shift\n\tlocal dev=$1; shift\n\n\techo $dev\n}\n\nctl4_entries_add()\n{\n\tlocal locus=$1; shift\n\tlocal state=$1; shift\n\tlocal n=$1; shift\n\tlocal grp=${1:-1}; shift\n\n\tlocal IPs=$(seq -f 192.0.2.%g 1 $((n - 1)))\n\tlocal peer=$(locus_dev_peer $locus)\n\tlocal GRP=239.1.1.${grp}\n\tlocal dmac=01:00:5e:01:01:$(printf \"%02x\" $grp)\n\t$MZ $peer -a own -b $dmac -c 1 -A 192.0.2.1 -B $GRP \\\n\t\t-t ip proto=2,p=$(igmpv3_is_in_get $GRP $IPs) -q\n\tsleep 1\n\n\tlocal nn=$(bridge mdb show dev br0 | grep $GRP | wc -l)\n\tif ((nn != n)); then\n\t\techo mcast_max_groups > /dev/stderr\n\t\tfalse\n\tfi\n}\n\nctl4_entries_del()\n{\n\tlocal locus=$1; shift\n\tlocal state=$1; shift\n\tlocal n=$1; shift\n\tlocal grp=${1:-1}; shift\n\n\tlocal peer=$(locus_dev_peer $locus)\n\tlocal GRP=239.1.1.${grp}\n\tlocal dmac=01:00:5e:00:00:02\n\t$MZ $peer -a own -b $dmac -c 1 -A 192.0.2.1 -B 224.0.0.2 \\\n\t\t-t ip proto=2,p=$(igmpv2_leave_get $GRP) -q\n\tsleep 1\n\t! bridge mdb show dev br0 | grep -q $GRP\n}\n\nctl6_entries_add()\n{\n\tlocal locus=$1; shift\n\tlocal state=$1; shift\n\tlocal n=$1; shift\n\tlocal grp=${1:-1}; shift\n\n\tlocal IPs=$(printf \"2001:db8:1::%x\\n\" $(seq 1 $((n - 1))))\n\tlocal peer=$(locus_dev_peer $locus)\n\tlocal SIP=fe80::1\n\tlocal GRP=ff0e::${grp}\n\tlocal dmac=33:33:00:00:00:$(printf \"%02x\" $grp)\n\tlocal p=$(mldv2_is_in_get $SIP $GRP $IPs)\n\t$MZ -6 $peer -a own -b $dmac -c 1 -A $SIP -B $GRP \\\n\t\t-t ip hop=1,next=0,p=\"$p\" -q\n\tsleep 1\n\n\tlocal nn=$(bridge mdb show dev br0 | grep $GRP | wc -l)\n\tif ((nn != n)); then\n\t\techo mcast_max_groups > /dev/stderr\n\t\tfalse\n\tfi\n}\n\nctl6_entries_del()\n{\n\tlocal locus=$1; shift\n\tlocal state=$1; shift\n\tlocal n=$1; shift\n\tlocal grp=${1:-1}; shift\n\n\tlocal peer=$(locus_dev_peer $locus)\n\tlocal SIP=fe80::1\n\tlocal GRP=ff0e::${grp}\n\tlocal dmac=33:33:00:00:00:$(printf \"%02x\" $grp)\n\tlocal p=$(mldv1_done_get $SIP $GRP)\n\t$MZ -6 $peer -a own -b $dmac -c 1 -A $SIP -B $GRP \\\n\t\t-t ip hop=1,next=0,p=\"$p\" -q\n\tsleep 1\n\t! bridge mdb show dev br0 | grep -q $GRP\n}\n\nbridge_maxgroups_errmsg_check_cfg()\n{\n\tlocal msg=$1; shift\n\tlocal needle=$1; shift\n\n\techo \"$msg\" | grep -q mcast_max_groups\n\tcheck_err $? \"Adding MDB entries failed for the wrong reason: $msg\"\n}\n\nbridge_maxgroups_errmsg_check_cfg4()\n{\n\tbridge_maxgroups_errmsg_check_cfg \"$@\"\n}\n\nbridge_maxgroups_errmsg_check_cfg6()\n{\n\tbridge_maxgroups_errmsg_check_cfg \"$@\"\n}\n\nbridge_maxgroups_errmsg_check_ctl4()\n{\n\t:\n}\n\nbridge_maxgroups_errmsg_check_ctl6()\n{\n\t:\n}\n\nbridge_port_ngroups_get()\n{\n\tlocal locus=$1; shift\n\n\tbridge -j -d link show $locus |\n\t    jq '.[].mcast_n_groups'\n}\n\nbridge_port_maxgroups_get()\n{\n\tlocal locus=$1; shift\n\n\tbridge -j -d link show $locus |\n\t    jq '.[].mcast_max_groups'\n}\n\nbridge_port_maxgroups_set()\n{\n\tlocal locus=$1; shift\n\tlocal max=$1; shift\n\n\tbridge link set dev $(locus_dev $locus) mcast_max_groups $max\n}\n\nbridge_port_vlan_ngroups_get()\n{\n\tlocal locus=$1; shift\n\n\tbridge -j -d vlan show $locus |\n\t    jq '.[].vlans[].mcast_n_groups'\n}\n\nbridge_port_vlan_maxgroups_get()\n{\n\tlocal locus=$1; shift\n\n\tbridge -j -d vlan show $locus |\n\t    jq '.[].vlans[].mcast_max_groups'\n}\n\nbridge_port_vlan_maxgroups_set()\n{\n\tlocal locus=$1; shift\n\tlocal max=$1; shift\n\n\tbridge vlan set $locus mcast_max_groups $max\n}\n\ntest_ngroups_reporting()\n{\n\tlocal CFG=$1; shift\n\tlocal context=$1; shift\n\tlocal locus=$1; shift\n\n\tRET=0\n\n\tlocal n0=$(bridge_${context}_ngroups_get \"$locus\")\n\t${CFG}_entries_add \"$locus\" temp 5\n\tcheck_err $? \"Couldn't add MDB entries\"\n\tlocal n1=$(bridge_${context}_ngroups_get \"$locus\")\n\n\t((n1 == n0 + 5))\n\tcheck_err $? \"Number of groups was $n0, now is $n1, but $((n0 + 5)) expected\"\n\n\t${CFG}_entries_del \"$locus\" temp 5\n\tcheck_err $? \"Couldn't delete MDB entries\"\n\tlocal n2=$(bridge_${context}_ngroups_get \"$locus\")\n\n\t((n2 == n0))\n\tcheck_err $? \"Number of groups was $n0, now is $n2, but should be back to $n0\"\n\n\tlog_test \"$CFG: $context: ngroups reporting\"\n}\n\ntest_8021d_ngroups_reporting_cfg4()\n{\n\ttest_ngroups_reporting cfg4 port \"dev $swp1\"\n}\n\ntest_8021d_ngroups_reporting_ctl4()\n{\n\ttest_ngroups_reporting ctl4 port \"dev $swp1\"\n}\n\ntest_8021d_ngroups_reporting_cfg6()\n{\n\ttest_ngroups_reporting cfg6 port \"dev $swp1\"\n}\n\ntest_8021d_ngroups_reporting_ctl6()\n{\n\ttest_ngroups_reporting ctl6 port \"dev $swp1\"\n}\n\ntest_8021q_ngroups_reporting_cfg4()\n{\n\ttest_ngroups_reporting cfg4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_ngroups_reporting_ctl4()\n{\n\ttest_ngroups_reporting ctl4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_ngroups_reporting_cfg6()\n{\n\ttest_ngroups_reporting cfg6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_ngroups_reporting_ctl6()\n{\n\ttest_ngroups_reporting ctl6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_ngroups_reporting_cfg4()\n{\n\ttest_ngroups_reporting cfg4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_ngroups_reporting_ctl4()\n{\n\ttest_ngroups_reporting ctl4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_ngroups_reporting_cfg6()\n{\n\ttest_ngroups_reporting cfg6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_ngroups_reporting_ctl6()\n{\n\ttest_ngroups_reporting ctl6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_ngroups_cross_vlan()\n{\n\tlocal CFG=$1; shift\n\n\tlocal locus1=\"dev $swp1 vid 10\"\n\tlocal locus2=\"dev $swp1 vid 20\"\n\n\tRET=0\n\n\tlocal n10=$(bridge_port_vlan_ngroups_get \"$locus1\")\n\tlocal n20=$(bridge_port_vlan_ngroups_get \"$locus2\")\n\t${CFG}_entries_add \"$locus1\" temp 5 111\n\tcheck_err $? \"Couldn't add MDB entries to VLAN 10\"\n\tlocal n11=$(bridge_port_vlan_ngroups_get \"$locus1\")\n\tlocal n21=$(bridge_port_vlan_ngroups_get \"$locus2\")\n\n\t((n11 == n10 + 5))\n\tcheck_err $? \"Number of groups at VLAN 10 was $n10, now is $n11, but 5 entries added on VLAN 10, $((n10 + 5)) expected\"\n\n\t((n21 == n20))\n\tcheck_err $? \"Number of groups at VLAN 20 was $n20, now is $n21, but no change expected on VLAN 20\"\n\n\t${CFG}_entries_add \"$locus2\" temp 5 112\n\tcheck_err $? \"Couldn't add MDB entries to VLAN 20\"\n\tlocal n12=$(bridge_port_vlan_ngroups_get \"$locus1\")\n\tlocal n22=$(bridge_port_vlan_ngroups_get \"$locus2\")\n\n\t((n12 == n11))\n\tcheck_err $? \"Number of groups at VLAN 10 was $n11, now is $n12, but no change expected on VLAN 10\"\n\n\t((n22 == n21 + 5))\n\tcheck_err $? \"Number of groups at VLAN 20 was $n21, now is $n22, but 5 entries added on VLAN 20, $((n21 + 5)) expected\"\n\n\t${CFG}_entries_del \"$locus1\" temp 5 111\n\tcheck_err $? \"Couldn't delete MDB entries from VLAN 10\"\n\t${CFG}_entries_del \"$locus2\" temp 5 112\n\tcheck_err $? \"Couldn't delete MDB entries from VLAN 20\"\n\tlocal n13=$(bridge_port_vlan_ngroups_get \"$locus1\")\n\tlocal n23=$(bridge_port_vlan_ngroups_get \"$locus2\")\n\n\t((n13 == n10))\n\tcheck_err $? \"Number of groups at VLAN 10 was $n10, now is $n13, but should be back to $n10\"\n\n\t((n23 == n20))\n\tcheck_err $? \"Number of groups at VLAN 20 was $n20, now is $n23, but should be back to $n20\"\n\n\tlog_test \"$CFG: port_vlan: isolation of port and per-VLAN ngroups\"\n}\n\ntest_8021qvs_ngroups_cross_vlan_cfg4()\n{\n\ttest_ngroups_cross_vlan cfg4\n}\n\ntest_8021qvs_ngroups_cross_vlan_ctl4()\n{\n\ttest_ngroups_cross_vlan ctl4\n}\n\ntest_8021qvs_ngroups_cross_vlan_cfg6()\n{\n\ttest_ngroups_cross_vlan cfg6\n}\n\ntest_8021qvs_ngroups_cross_vlan_ctl6()\n{\n\ttest_ngroups_cross_vlan ctl6\n}\n\ntest_maxgroups_zero()\n{\n\tlocal CFG=$1; shift\n\tlocal context=$1; shift\n\tlocal locus=$1; shift\n\n\tRET=0\n\tlocal max\n\n\tmax=$(bridge_${context}_maxgroups_get \"$locus\")\n\t((max == 0))\n\tcheck_err $? \"Max groups on $locus should be 0, but $max reported\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" 100\n\tcheck_err $? \"Failed to set max to 100\"\n\tmax=$(bridge_${context}_maxgroups_get \"$locus\")\n\t((max == 100))\n\tcheck_err $? \"Max groups expected to be 100, but $max reported\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" 0\n\tcheck_err $? \"Couldn't set maximum to 0\"\n\n\t# Test that setting 0 explicitly still serves as infinity.\n\t${CFG}_entries_add \"$locus\" temp 5\n\tcheck_err $? \"Adding 5 MDB entries failed but should have passed\"\n\t${CFG}_entries_del \"$locus\" temp 5\n\tcheck_err $? \"Couldn't delete MDB entries\"\n\n\tlog_test \"$CFG: $context maxgroups: reporting and treatment of 0\"\n}\n\ntest_8021d_maxgroups_zero_cfg4()\n{\n\ttest_maxgroups_zero cfg4 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_zero_ctl4()\n{\n\ttest_maxgroups_zero ctl4 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_zero_cfg6()\n{\n\ttest_maxgroups_zero cfg6 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_zero_ctl6()\n{\n\ttest_maxgroups_zero ctl6 port \"dev $swp1\"\n}\n\ntest_8021q_maxgroups_zero_cfg4()\n{\n\ttest_maxgroups_zero cfg4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_zero_ctl4()\n{\n\ttest_maxgroups_zero ctl4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_zero_cfg6()\n{\n\ttest_maxgroups_zero cfg6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_zero_ctl6()\n{\n\ttest_maxgroups_zero ctl6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_zero_cfg4()\n{\n\ttest_maxgroups_zero cfg4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_zero_ctl4()\n{\n\ttest_maxgroups_zero ctl4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_zero_cfg6()\n{\n\ttest_maxgroups_zero cfg6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_zero_ctl6()\n{\n\ttest_maxgroups_zero ctl6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_maxgroups_zero_cross_vlan()\n{\n\tlocal CFG=$1; shift\n\n\tlocal locus0=\"dev $swp1\"\n\tlocal locus1=\"dev $swp1 vid 10\"\n\tlocal locus2=\"dev $swp1 vid 20\"\n\tlocal max\n\n\tRET=0\n\n\tbridge_port_vlan_maxgroups_set \"$locus1\" 100\n\tcheck_err $? \"$locus1: Failed to set max to 100\"\n\n\tmax=$(bridge_port_maxgroups_get \"$locus0\")\n\t((max == 0))\n\tcheck_err $? \"$locus0: Max groups expected to be 0, but $max reported\"\n\n\tmax=$(bridge_port_vlan_maxgroups_get \"$locus2\")\n\t((max == 0))\n\tcheck_err $? \"$locus2: Max groups expected to be 0, but $max reported\"\n\n\tbridge_port_vlan_maxgroups_set \"$locus2\" 100\n\tcheck_err $? \"$locus2: Failed to set max to 100\"\n\n\tmax=$(bridge_port_maxgroups_get \"$locus0\")\n\t((max == 0))\n\tcheck_err $? \"$locus0: Max groups expected to be 0, but $max reported\"\n\n\tmax=$(bridge_port_vlan_maxgroups_get \"$locus2\")\n\t((max == 100))\n\tcheck_err $? \"$locus2: Max groups expected to be 100, but $max reported\"\n\n\tbridge_port_maxgroups_set \"$locus0\" 100\n\tcheck_err $? \"$locus0: Failed to set max to 100\"\n\n\tmax=$(bridge_port_maxgroups_get \"$locus0\")\n\t((max == 100))\n\tcheck_err $? \"$locus0: Max groups expected to be 100, but $max reported\"\n\n\tmax=$(bridge_port_vlan_maxgroups_get \"$locus2\")\n\t((max == 100))\n\tcheck_err $? \"$locus2: Max groups expected to be 100, but $max reported\"\n\n\tbridge_port_vlan_maxgroups_set \"$locus1\" 0\n\tcheck_err $? \"$locus1: Failed to set max to 0\"\n\n\tmax=$(bridge_port_maxgroups_get \"$locus0\")\n\t((max == 100))\n\tcheck_err $? \"$locus0: Max groups expected to be 100, but $max reported\"\n\n\tmax=$(bridge_port_vlan_maxgroups_get \"$locus2\")\n\t((max == 100))\n\tcheck_err $? \"$locus2: Max groups expected to be 100, but $max reported\"\n\n\tbridge_port_vlan_maxgroups_set \"$locus2\" 0\n\tcheck_err $? \"$locus2: Failed to set max to 0\"\n\n\tmax=$(bridge_port_maxgroups_get \"$locus0\")\n\t((max == 100))\n\tcheck_err $? \"$locus0: Max groups expected to be 100, but $max reported\"\n\n\tmax=$(bridge_port_vlan_maxgroups_get \"$locus2\")\n\t((max == 0))\n\tcheck_err $? \"$locus2: Max groups expected to be 0 but $max reported\"\n\n\tbridge_port_maxgroups_set \"$locus0\" 0\n\tcheck_err $? \"$locus0: Failed to set max to 0\"\n\n\tmax=$(bridge_port_maxgroups_get \"$locus0\")\n\t((max == 0))\n\tcheck_err $? \"$locus0: Max groups expected to be 0, but $max reported\"\n\n\tmax=$(bridge_port_vlan_maxgroups_get \"$locus2\")\n\t((max == 0))\n\tcheck_err $? \"$locus2: Max groups expected to be 0, but $max reported\"\n\n\tlog_test \"$CFG: port_vlan maxgroups: isolation of port and per-VLAN maximums\"\n}\n\ntest_8021qvs_maxgroups_zero_cross_vlan_cfg4()\n{\n\ttest_maxgroups_zero_cross_vlan cfg4\n}\n\ntest_8021qvs_maxgroups_zero_cross_vlan_ctl4()\n{\n\ttest_maxgroups_zero_cross_vlan ctl4\n}\n\ntest_8021qvs_maxgroups_zero_cross_vlan_cfg6()\n{\n\ttest_maxgroups_zero_cross_vlan cfg6\n}\n\ntest_8021qvs_maxgroups_zero_cross_vlan_ctl6()\n{\n\ttest_maxgroups_zero_cross_vlan ctl6\n}\n\ntest_maxgroups_too_low()\n{\n\tlocal CFG=$1; shift\n\tlocal context=$1; shift\n\tlocal locus=$1; shift\n\n\tRET=0\n\n\tlocal n=$(bridge_${context}_ngroups_get \"$locus\")\n\tlocal msg\n\n\t${CFG}_entries_add \"$locus\" temp 5 111\n\tcheck_err $? \"$locus: Couldn't add MDB entries\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" $((n+2))\n\tcheck_err $? \"$locus: Setting maxgroups to $((n+2)) failed\"\n\n\tmsg=$(${CFG}_entries_add \"$locus\" temp 2 112 2>&1)\n\tcheck_fail $? \"$locus: Adding more entries passed when max<n\"\n\tbridge_maxgroups_errmsg_check_cfg \"$msg\"\n\n\t${CFG}_entries_del \"$locus\" temp 5 111\n\tcheck_err $? \"$locus: Couldn't delete MDB entries\"\n\n\t${CFG}_entries_add \"$locus\" temp 2 112\n\tcheck_err $? \"$locus: Adding more entries failed\"\n\n\t${CFG}_entries_del \"$locus\" temp 2 112\n\tcheck_err $? \"$locus: Deleting more entries failed\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" 0\n\tcheck_err $? \"$locus: Couldn't set maximum to 0\"\n\n\tlog_test \"$CFG: $context maxgroups: configure below ngroups\"\n}\n\ntest_8021d_maxgroups_too_low_cfg4()\n{\n\ttest_maxgroups_too_low cfg4 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_too_low_ctl4()\n{\n\ttest_maxgroups_too_low ctl4 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_too_low_cfg6()\n{\n\ttest_maxgroups_too_low cfg6 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_too_low_ctl6()\n{\n\ttest_maxgroups_too_low ctl6 port \"dev $swp1\"\n}\n\ntest_8021q_maxgroups_too_low_cfg4()\n{\n\ttest_maxgroups_too_low cfg4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_too_low_ctl4()\n{\n\ttest_maxgroups_too_low ctl4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_too_low_cfg6()\n{\n\ttest_maxgroups_too_low cfg6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_too_low_ctl6()\n{\n\ttest_maxgroups_too_low ctl6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_low_cfg4()\n{\n\ttest_maxgroups_too_low cfg4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_low_ctl4()\n{\n\ttest_maxgroups_too_low ctl4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_low_cfg6()\n{\n\ttest_maxgroups_too_low cfg6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_low_ctl6()\n{\n\ttest_maxgroups_too_low ctl6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_maxgroups_too_many_entries()\n{\n\tlocal CFG=$1; shift\n\tlocal context=$1; shift\n\tlocal locus=$1; shift\n\n\tRET=0\n\n\tlocal n=$(bridge_${context}_ngroups_get \"$locus\")\n\tlocal msg\n\n\t# Configure a low maximum\n\tbridge_${context}_maxgroups_set \"$locus\" $((n+1))\n\tcheck_err $? \"$locus: Couldn't set maximum\"\n\n\t# Try to add more entries than the configured maximum\n\tmsg=$(${CFG}_entries_add \"$locus\" temp 5 2>&1)\n\tcheck_fail $? \"Adding 5 MDB entries passed, but should have failed\"\n\tbridge_maxgroups_errmsg_check_${CFG} \"$msg\"\n\n\t# When adding entries through the control path, as many as possible\n\t# get created. That's consistent with the mcast_hash_max behavior.\n\t# So there, drop the entries explicitly.\n\tif [[ ${CFG%[46]} == ctl ]]; then\n\t\t${CFG}_entries_del \"$locus\" temp 17 2>&1\n\tfi\n\n\tlocal n2=$(bridge_${context}_ngroups_get \"$locus\")\n\t((n2 == n))\n\tcheck_err $? \"Number of groups was $n, but after a failed attempt to add MDB entries it changed to $n2\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" 0\n\tcheck_err $? \"$locus: Couldn't set maximum to 0\"\n\n\tlog_test \"$CFG: $context maxgroups: add too many MDB entries\"\n}\n\ntest_8021d_maxgroups_too_many_entries_cfg4()\n{\n\ttest_maxgroups_too_many_entries cfg4 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_too_many_entries_ctl4()\n{\n\ttest_maxgroups_too_many_entries ctl4 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_too_many_entries_cfg6()\n{\n\ttest_maxgroups_too_many_entries cfg6 port \"dev $swp1\"\n}\n\ntest_8021d_maxgroups_too_many_entries_ctl6()\n{\n\ttest_maxgroups_too_many_entries ctl6 port \"dev $swp1\"\n}\n\ntest_8021q_maxgroups_too_many_entries_cfg4()\n{\n\ttest_maxgroups_too_many_entries cfg4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_too_many_entries_ctl4()\n{\n\ttest_maxgroups_too_many_entries ctl4 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_too_many_entries_cfg6()\n{\n\ttest_maxgroups_too_many_entries cfg6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021q_maxgroups_too_many_entries_ctl6()\n{\n\ttest_maxgroups_too_many_entries ctl6 port \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_many_entries_cfg4()\n{\n\ttest_maxgroups_too_many_entries cfg4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_many_entries_ctl4()\n{\n\ttest_maxgroups_too_many_entries ctl4 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_many_entries_cfg6()\n{\n\ttest_maxgroups_too_many_entries cfg6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_8021qvs_maxgroups_too_many_entries_ctl6()\n{\n\ttest_maxgroups_too_many_entries ctl6 port_vlan \"dev $swp1 vid 10\"\n}\n\ntest_maxgroups_too_many_cross_vlan()\n{\n\tlocal CFG=$1; shift\n\n\tRET=0\n\n\tlocal locus0=\"dev $swp1\"\n\tlocal locus1=\"dev $swp1 vid 10\"\n\tlocal locus2=\"dev $swp1 vid 20\"\n\tlocal n1=$(bridge_port_vlan_ngroups_get \"$locus1\")\n\tlocal n2=$(bridge_port_vlan_ngroups_get \"$locus2\")\n\tlocal msg\n\n\tif ((n1 > n2)); then\n\t\tlocal tmp=$n1\n\t\tn1=$n2\n\t\tn2=$tmp\n\n\t\ttmp=\"$locus1\"\n\t\tlocus1=\"$locus2\"\n\t\tlocus2=\"$tmp\"\n\tfi\n\n\t# Now 0 <= n1 <= n2.\n\t${CFG}_entries_add \"$locus2\" temp 5 112\n\tcheck_err $? \"Couldn't add 5 entries\"\n\n\tn2=$(bridge_port_vlan_ngroups_get \"$locus2\")\n\t# Now 0 <= n1 < n2-1.\n\n\t# Setting locus1'maxgroups to n2-1 should pass. The number is\n\t# smaller than both the absolute number of MDB entries, and in\n\t# particular than number of locus2's number of entries, but it is\n\t# large enough to cover locus1's entries. Thus we check that\n\t# individual VLAN's ngroups are independent.\n\tbridge_port_vlan_maxgroups_set \"$locus1\" $((n2-1))\n\tcheck_err $? \"Setting ${locus1}'s maxgroups to $((n2-1)) failed\"\n\n\tmsg=$(${CFG}_entries_add \"$locus1\" temp $n2 111 2>&1)\n\tcheck_fail $? \"$locus1: Adding $n2 MDB entries passed, but should have failed\"\n\tbridge_maxgroups_errmsg_check_${CFG} \"$msg\"\n\n\tbridge_port_maxgroups_set \"$locus0\" $((n1 + n2 + 2))\n\tcheck_err $? \"$locus0: Couldn't set maximum\"\n\n\tmsg=$(${CFG}_entries_add \"$locus1\" temp 5 111 2>&1)\n\tcheck_fail $? \"$locus1: Adding 5 MDB entries passed, but should have failed\"\n\tbridge_maxgroups_errmsg_check_${CFG} \"$msg\"\n\n\t# IGMP/MLD packets can cause several entries to be added, before\n\t# the maximum is hit and the rest is then bounced. Remove what was\n\t# committed, if anything.\n\t${CFG}_entries_del \"$locus1\" temp 5 111 2>/dev/null\n\n\t${CFG}_entries_add \"$locus1\" temp 2 111\n\tcheck_err $? \"$locus1: Adding 2 MDB entries failed, but should have passed\"\n\n\t${CFG}_entries_del \"$locus1\" temp 2 111\n\tcheck_err $? \"Couldn't delete MDB entries\"\n\n\t${CFG}_entries_del \"$locus2\" temp 5 112\n\tcheck_err $? \"Couldn't delete MDB entries\"\n\n\tbridge_port_vlan_maxgroups_set \"$locus1\" 0\n\tcheck_err $? \"$locus1: Couldn't set maximum to 0\"\n\n\tbridge_port_maxgroups_set \"$locus0\" 0\n\tcheck_err $? \"$locus0: Couldn't set maximum to 0\"\n\n\tlog_test \"$CFG: port_vlan maxgroups: isolation of port and per-VLAN ngroups\"\n}\n\ntest_8021qvs_maxgroups_too_many_cross_vlan_cfg4()\n{\n\ttest_maxgroups_too_many_cross_vlan cfg4\n}\n\ntest_8021qvs_maxgroups_too_many_cross_vlan_ctl4()\n{\n\ttest_maxgroups_too_many_cross_vlan ctl4\n}\n\ntest_8021qvs_maxgroups_too_many_cross_vlan_cfg6()\n{\n\ttest_maxgroups_too_many_cross_vlan cfg6\n}\n\ntest_8021qvs_maxgroups_too_many_cross_vlan_ctl6()\n{\n\ttest_maxgroups_too_many_cross_vlan ctl6\n}\n\ntest_vlan_attributes()\n{\n\tlocal locus=$1; shift\n\tlocal expect=$1; shift\n\n\tRET=0\n\n\tlocal max=$(bridge_port_vlan_maxgroups_get \"$locus\")\n\tlocal n=$(bridge_port_vlan_ngroups_get \"$locus\")\n\n\teval \"[[ $max $expect ]]\"\n\tcheck_err $? \"$locus: maxgroups attribute expected to be $expect, but was $max\"\n\n\teval \"[[ $n $expect ]]\"\n\tcheck_err $? \"$locus: ngroups attribute expected to be $expect, but was $n\"\n\n\tlog_test \"port_vlan: presence of ngroups and maxgroups attributes\"\n}\n\ntest_8021q_vlan_attributes()\n{\n\ttest_vlan_attributes \"dev $swp1 vid 10\" \"== null\"\n}\n\ntest_8021qvs_vlan_attributes()\n{\n\ttest_vlan_attributes \"dev $swp1 vid 10\" \"-ge 0\"\n}\n\ntest_toggle_vlan_snooping()\n{\n\tlocal mode=$1; shift\n\n\tRET=0\n\n\tlocal CFG=cfg4\n\tlocal context=port_vlan\n\tlocal locus=\"dev $swp1 vid 10\"\n\n\t${CFG}_entries_add \"$locus\" $mode 5\n\tcheck_err $? \"Couldn't add MDB entries\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" 100\n\tcheck_err $? \"Failed to set max to 100\"\n\n\tip link set dev br0 type bridge mcast_vlan_snooping 0\n\tsleep 1\n\tip link set dev br0 type bridge mcast_vlan_snooping 1\n\n\tlocal n=$(bridge_${context}_ngroups_get \"$locus\")\n\tlocal nn=$(bridge mdb show dev br0 | grep $swp1 | wc -l)\n\t((nn == n))\n\tcheck_err $? \"mcast_n_groups expected to be $nn, but $n reported\"\n\n\tlocal max=$(bridge_${context}_maxgroups_get \"$locus\")\n\t((max == 100))\n\tcheck_err $? \"Max groups expected to be 100 but $max reported\"\n\n\tbridge_${context}_maxgroups_set \"$locus\" 0\n\tcheck_err $? \"Failed to set max to 0\"\n\n\tlog_test \"$CFG: $context: $mode: mcast_vlan_snooping toggle\"\n}\n\ntest_toggle_vlan_snooping_temp()\n{\n\ttest_toggle_vlan_snooping temp\n}\n\ntest_toggle_vlan_snooping_permanent()\n{\n\ttest_toggle_vlan_snooping permanent\n}\n\n# ngroup test suites\n\ntest_8021d_ngroups_cfg4()\n{\n\ttest_8021d_ngroups_reporting_cfg4\n}\n\ntest_8021d_ngroups_ctl4()\n{\n\ttest_8021d_ngroups_reporting_ctl4\n}\n\ntest_8021d_ngroups_cfg6()\n{\n\ttest_8021d_ngroups_reporting_cfg6\n}\n\ntest_8021d_ngroups_ctl6()\n{\n\ttest_8021d_ngroups_reporting_ctl6\n}\n\ntest_8021q_ngroups_cfg4()\n{\n\ttest_8021q_ngroups_reporting_cfg4\n}\n\ntest_8021q_ngroups_ctl4()\n{\n\ttest_8021q_ngroups_reporting_ctl4\n}\n\ntest_8021q_ngroups_cfg6()\n{\n\ttest_8021q_ngroups_reporting_cfg6\n}\n\ntest_8021q_ngroups_ctl6()\n{\n\ttest_8021q_ngroups_reporting_ctl6\n}\n\ntest_8021qvs_ngroups_cfg4()\n{\n\ttest_8021qvs_ngroups_reporting_cfg4\n\ttest_8021qvs_ngroups_cross_vlan_cfg4\n}\n\ntest_8021qvs_ngroups_ctl4()\n{\n\ttest_8021qvs_ngroups_reporting_ctl4\n\ttest_8021qvs_ngroups_cross_vlan_ctl4\n}\n\ntest_8021qvs_ngroups_cfg6()\n{\n\ttest_8021qvs_ngroups_reporting_cfg6\n\ttest_8021qvs_ngroups_cross_vlan_cfg6\n}\n\ntest_8021qvs_ngroups_ctl6()\n{\n\ttest_8021qvs_ngroups_reporting_ctl6\n\ttest_8021qvs_ngroups_cross_vlan_ctl6\n}\n\n# maxgroups test suites\n\ntest_8021d_maxgroups_cfg4()\n{\n\ttest_8021d_maxgroups_zero_cfg4\n\ttest_8021d_maxgroups_too_low_cfg4\n\ttest_8021d_maxgroups_too_many_entries_cfg4\n}\n\ntest_8021d_maxgroups_ctl4()\n{\n\ttest_8021d_maxgroups_zero_ctl4\n\ttest_8021d_maxgroups_too_low_ctl4\n\ttest_8021d_maxgroups_too_many_entries_ctl4\n}\n\ntest_8021d_maxgroups_cfg6()\n{\n\ttest_8021d_maxgroups_zero_cfg6\n\ttest_8021d_maxgroups_too_low_cfg6\n\ttest_8021d_maxgroups_too_many_entries_cfg6\n}\n\ntest_8021d_maxgroups_ctl6()\n{\n\ttest_8021d_maxgroups_zero_ctl6\n\ttest_8021d_maxgroups_too_low_ctl6\n\ttest_8021d_maxgroups_too_many_entries_ctl6\n}\n\ntest_8021q_maxgroups_cfg4()\n{\n\ttest_8021q_maxgroups_zero_cfg4\n\ttest_8021q_maxgroups_too_low_cfg4\n\ttest_8021q_maxgroups_too_many_entries_cfg4\n}\n\ntest_8021q_maxgroups_ctl4()\n{\n\ttest_8021q_maxgroups_zero_ctl4\n\ttest_8021q_maxgroups_too_low_ctl4\n\ttest_8021q_maxgroups_too_many_entries_ctl4\n}\n\ntest_8021q_maxgroups_cfg6()\n{\n\ttest_8021q_maxgroups_zero_cfg6\n\ttest_8021q_maxgroups_too_low_cfg6\n\ttest_8021q_maxgroups_too_many_entries_cfg6\n}\n\ntest_8021q_maxgroups_ctl6()\n{\n\ttest_8021q_maxgroups_zero_ctl6\n\ttest_8021q_maxgroups_too_low_ctl6\n\ttest_8021q_maxgroups_too_many_entries_ctl6\n}\n\ntest_8021qvs_maxgroups_cfg4()\n{\n\ttest_8021qvs_maxgroups_zero_cfg4\n\ttest_8021qvs_maxgroups_zero_cross_vlan_cfg4\n\ttest_8021qvs_maxgroups_too_low_cfg4\n\ttest_8021qvs_maxgroups_too_many_entries_cfg4\n\ttest_8021qvs_maxgroups_too_many_cross_vlan_cfg4\n}\n\ntest_8021qvs_maxgroups_ctl4()\n{\n\ttest_8021qvs_maxgroups_zero_ctl4\n\ttest_8021qvs_maxgroups_zero_cross_vlan_ctl4\n\ttest_8021qvs_maxgroups_too_low_ctl4\n\ttest_8021qvs_maxgroups_too_many_entries_ctl4\n\ttest_8021qvs_maxgroups_too_many_cross_vlan_ctl4\n}\n\ntest_8021qvs_maxgroups_cfg6()\n{\n\ttest_8021qvs_maxgroups_zero_cfg6\n\ttest_8021qvs_maxgroups_zero_cross_vlan_cfg6\n\ttest_8021qvs_maxgroups_too_low_cfg6\n\ttest_8021qvs_maxgroups_too_many_entries_cfg6\n\ttest_8021qvs_maxgroups_too_many_cross_vlan_cfg6\n}\n\ntest_8021qvs_maxgroups_ctl6()\n{\n\ttest_8021qvs_maxgroups_zero_ctl6\n\ttest_8021qvs_maxgroups_zero_cross_vlan_ctl6\n\ttest_8021qvs_maxgroups_too_low_ctl6\n\ttest_8021qvs_maxgroups_too_many_entries_ctl6\n\ttest_8021qvs_maxgroups_too_many_cross_vlan_ctl6\n}\n\n# other test suites\n\ntest_8021qvs_toggle_vlan_snooping()\n{\n\ttest_toggle_vlan_snooping_temp\n\ttest_toggle_vlan_snooping_permanent\n}\n\n# test groups\n\ntest_8021d()\n{\n\t# Tests for vlan_filtering 0 mcast_vlan_snooping 0.\n\n\tswitch_create_8021d\n\tsetup_wait\n\n\ttest_8021d_ngroups_cfg4\n\ttest_8021d_ngroups_ctl4\n\ttest_8021d_ngroups_cfg6\n\ttest_8021d_ngroups_ctl6\n\ttest_8021d_maxgroups_cfg4\n\ttest_8021d_maxgroups_ctl4\n\ttest_8021d_maxgroups_cfg6\n\ttest_8021d_maxgroups_ctl6\n\n\tswitch_destroy\n}\n\ntest_8021q()\n{\n\t# Tests for vlan_filtering 1 mcast_vlan_snooping 0.\n\n\tswitch_create_8021q\n\tsetup_wait\n\n\ttest_8021q_vlan_attributes\n\ttest_8021q_ngroups_cfg4\n\ttest_8021q_ngroups_ctl4\n\ttest_8021q_ngroups_cfg6\n\ttest_8021q_ngroups_ctl6\n\ttest_8021q_maxgroups_cfg4\n\ttest_8021q_maxgroups_ctl4\n\ttest_8021q_maxgroups_cfg6\n\ttest_8021q_maxgroups_ctl6\n\n\tswitch_destroy\n}\n\ntest_8021qvs()\n{\n\t# Tests for vlan_filtering 1 mcast_vlan_snooping 1.\n\n\tswitch_create_8021qvs\n\tsetup_wait\n\n\ttest_8021qvs_vlan_attributes\n\ttest_8021qvs_ngroups_cfg4\n\ttest_8021qvs_ngroups_ctl4\n\ttest_8021qvs_ngroups_cfg6\n\ttest_8021qvs_ngroups_ctl6\n\ttest_8021qvs_maxgroups_cfg4\n\ttest_8021qvs_maxgroups_ctl4\n\ttest_8021qvs_maxgroups_cfg6\n\ttest_8021qvs_maxgroups_ctl6\n\ttest_8021qvs_toggle_vlan_snooping\n\n\tswitch_destroy\n}\n\nif ! bridge link help 2>&1 | grep -q \"mcast_max_groups\"; then\n\techo \"SKIP: iproute2 too old, missing bridge \\\"mcast_max_groups\\\" support\"\n\texit $ksft_skip\nfi\n\ntrap cleanup EXIT\n\nsetup_prepare\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}