{
  "module_name": "q_in_vni.sh",
  "hash_id": "6ebbef6e03fab0fb4479d17fdddda66b680cb3bc3553c4707cd2d0fc9e0b4dd1",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/q_in_vni.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +-----------------------+                          +------------------------+\n# | H1 (vrf)              |                          | H2 (vrf)               |\n# |  + $h1.10             |                          |  + $h2.10              |\n# |  | 192.0.2.1/28       |                          |  | 192.0.2.2/28        |\n# |  |                    |                          |  |                     |\n# |  | + $h1.20           |                          |  | + $h2.20            |\n# |  \\ | 198.51.100.1/24  |                          |  \\ | 198.51.100.2/24   |\n# |   \\|                  |                          |   \\|                   |\n# |    + $h1              |                          |    + $h2               |\n# +----|------------------+                          +----|-------------------+\n#      |                                                  |\n# +----|--------------------------------------------------|-------------------+\n# | SW |                                                  |                   |\n# | +--|--------------------------------------------------|-----------------+ |\n# | |  + $swp1                   BR1 (802.1ad)            + $swp2           | |\n# | |    vid 100 pvid untagged                              vid 100 pvid    | |\n# | |                                                           untagged    | |\n# | |  + vx100 (vxlan)                                                      | |\n# | |    local 192.0.2.17                                                   | |\n# | |    remote 192.0.2.34 192.0.2.50                                       | |\n# | |    id 1000 dstport $VXPORT                                            | |\n# | |    vid 100 pvid untagged                                              | |\n# | +-----------------------------------------------------------------------+ |\n# |                                                                           |\n# |  192.0.2.32/28 via 192.0.2.18                                             |\n# |  192.0.2.48/28 via 192.0.2.18                                             |\n# |                                                                           |\n# |    + $rp1                                                                 |\n# |    | 192.0.2.17/28                                                        |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                                             VRP2 (vrf) |\n# |    + $rp2                                                   |\n# |      192.0.2.18/28                                          |\n# |                                                             |   (maybe) HW\n# =============================================================================\n# |                                                             |  (likely) SW\n# |    + v1 (veth)                             + v3 (veth)      |\n# |    | 192.0.2.33/28                         | 192.0.2.49/28  |\n# +----|---------------------------------------|----------------+\n#      |                                       |\n# +----|------------------------------+   +----|------------------------------+\n# |    + v2 (veth)        NS1 (netns) |   |    + v4 (veth)        NS2 (netns) |\n# |      192.0.2.34/28                |   |      192.0.2.50/28                |\n# |                                   |   |                                   |\n# |   192.0.2.16/28 via 192.0.2.33    |   |   192.0.2.16/28 via 192.0.2.49    |\n# |   192.0.2.50/32 via 192.0.2.33    |   |   192.0.2.34/32 via 192.0.2.49    |\n# |                                   |   |                                   |\n# | +-------------------------------+ |   | +-------------------------------+ |\n# | |                 BR2 (802.1ad) | |   | |                 BR2 (802.1ad) | |\n# | |  + vx100 (vxlan)              | |   | |  + vx100 (vxlan)              | |\n# | |    local 192.0.2.34           | |   | |    local 192.0.2.50           | |\n# | |    remote 192.0.2.17          | |   | |    remote 192.0.2.17          | |\n# | |    remote 192.0.2.50          | |   | |    remote 192.0.2.34          | |\n# | |    id 1000 dstport $VXPORT    | |   | |    id 1000 dstport $VXPORT    | |\n# | |    vid 100 pvid untagged      | |   | |    vid 100 pvid untagged      | |\n# | |                               | |   | |                               | |\n# | |  + w1 (veth)                  | |   | |  + w1 (veth)                  | |\n# | |  | vid 100 pvid untagged      | |   | |  | vid 100 pvid untagged      | |\n# | +--|----------------------------+ |   | +--|----------------------------+ |\n# |    |                              |   |    |                              |\n# | +--|----------------------------+ |   | +--|----------------------------+ |\n# | |  |                  VW2 (vrf) | |   | |  |                  VW2 (vrf) | |\n# | |  + w2 (veth)                  | |   | |  + w2 (veth)                  | |\n# | |  |\\                           | |   | |  |\\                           | |\n# | |  | + w2.10                    | |   | |  | + w2.10                    | |\n# | |  |   192.0.2.3/28             | |   | |  |   192.0.2.4/28             | |\n# | |  |                            | |   | |  |                            | |\n# | |  + w2.20                      | |   | |  + w2.20                      | |\n# | |    198.51.100.3/24            | |   | |    198.51.100.4/24            | |\n# | +-------------------------------+ |   | +-------------------------------+ |\n# +-----------------------------------+   +-----------------------------------+\n\n: ${VXPORT:=4789}\nexport VXPORT\n\n: ${ALL_TESTS:=\"\n\tping_ipv4\n    \"}\n\nNUM_NETIFS=6\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1\n\ttc qdisc add dev $h1 clsact\n\tvlan_create $h1 10 v$h1 192.0.2.1/28\n\tvlan_create $h1 20 v$h1 198.51.100.1/24\n}\n\nh1_destroy()\n{\n\tvlan_destroy $h1 20\n\tvlan_destroy $h1 10\n\ttc qdisc del dev $h1 clsact\n\tsimple_if_fini $h1\n}\n\nh2_create()\n{\n\tsimple_if_init $h2\n\ttc qdisc add dev $h2 clsact\n\tvlan_create $h2 10 v$h2 192.0.2.2/28\n\tvlan_create $h2 20 v$h2 198.51.100.2/24\n}\n\nh2_destroy()\n{\n\tvlan_destroy $h2 20\n\tvlan_destroy $h2 10\n\ttc qdisc del dev $h2 clsact\n\tsimple_if_fini $h2\n}\n\nrp1_set_addr()\n{\n\tip address add dev $rp1 192.0.2.17/28\n\n\tip route add 192.0.2.32/28 nexthop via 192.0.2.18\n\tip route add 192.0.2.48/28 nexthop via 192.0.2.18\n}\n\nrp1_unset_addr()\n{\n\tip route del 192.0.2.48/28 nexthop via 192.0.2.18\n\tip route del 192.0.2.32/28 nexthop via 192.0.2.18\n\n\tip address del dev $rp1 192.0.2.17/28\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_protocol 802.1ad \\\n\t\tvlan_default_pvid 0 mcast_snooping 0\n\tip link set dev br1 addrgenmode none\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\tip link set dev $rp1 up\n\trp1_set_addr\n\n\tip link add name vx100 type vxlan id 1000\t\t\\\n\t\tlocal 192.0.2.17 dstport \"$VXPORT\"\t\\\n\t\tnolearning noudpcsum tos inherit ttl 100\n\tip link set dev vx100 up\n\n\tip link set dev vx100 master br1\n\tbridge vlan add vid 100 dev vx100 pvid untagged\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tbridge vlan add vid 100 dev $swp1 pvid untagged\n\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\tbridge vlan add vid 100 dev $swp2 pvid untagged\n\n\tbridge fdb append dev vx100 00:00:00:00:00:00 dst 192.0.2.34 self\n\tbridge fdb append dev vx100 00:00:00:00:00:00 dst 192.0.2.50 self\n}\n\nswitch_destroy()\n{\n\tbridge fdb del dev vx100 00:00:00:00:00:00 dst 192.0.2.50 self\n\tbridge fdb del dev vx100 00:00:00:00:00:00 dst 192.0.2.34 self\n\n\tbridge vlan del vid 100 dev $swp2\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\n\tbridge vlan del vid 100 dev $swp1\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tip link set dev vx100 nomaster\n\tip link set dev vx100 down\n\tip link del dev vx100\n\n\trp1_unset_addr\n\tip link set dev $rp1 down\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nvrp2_create()\n{\n\tsimple_if_init $rp2 192.0.2.18/28\n\t__simple_if_init v1 v$rp2 192.0.2.33/28\n\t__simple_if_init v3 v$rp2 192.0.2.49/28\n\ttc qdisc add dev v1 clsact\n}\n\nvrp2_destroy()\n{\n\ttc qdisc del dev v1 clsact\n\t__simple_if_fini v3 192.0.2.49/28\n\t__simple_if_fini v1 192.0.2.33/28\n\tsimple_if_fini $rp2 192.0.2.18/28\n}\n\nns_init_common()\n{\n\tlocal in_if=$1; shift\n\tlocal in_addr=$1; shift\n\tlocal other_in_addr=$1; shift\n\tlocal nh_addr=$1; shift\n\tlocal host_addr1=$1; shift\n\tlocal host_addr2=$1; shift\n\n\tip link set dev $in_if up\n\tip address add dev $in_if $in_addr/28\n\ttc qdisc add dev $in_if clsact\n\n\tip link add name br2 type bridge vlan_filtering 1 vlan_protocol 802.1ad \\\n\t\tvlan_default_pvid 0\n\tip link set dev br2 up\n\n\tip link add name w1 type veth peer name w2\n\n\tip link set dev w1 master br2\n\tip link set dev w1 up\n\tbridge vlan add vid 100 dev w1 pvid untagged\n\n\tip link add name vx100 type vxlan id 1000 local $in_addr \\\n\t\tdstport \"$VXPORT\"\n\tip link set dev vx100 up\n\tbridge fdb append dev vx100 00:00:00:00:00:00 dst 192.0.2.17 self\n\tbridge fdb append dev vx100 00:00:00:00:00:00 dst $other_in_addr self\n\n\tip link set dev vx100 master br2\n\ttc qdisc add dev vx100 clsact\n\n\tbridge vlan add vid 100 dev vx100 pvid untagged\n\n\tsimple_if_init w2\n        vlan_create w2 10 vw2 $host_addr1/28\n        vlan_create w2 20 vw2 $host_addr2/24\n\n\tip route add 192.0.2.16/28 nexthop via $nh_addr\n\tip route add $other_in_addr/32 nexthop via $nh_addr\n}\nexport -f ns_init_common\n\nns1_create()\n{\n\tip netns add ns1\n\tip link set dev v2 netns ns1\n\tin_ns ns1 \\\n\t      ns_init_common v2 192.0.2.34 192.0.2.50 192.0.2.33 \\\n\t\t\t     192.0.2.3 198.51.100.3\n}\n\nns1_destroy()\n{\n\tip netns exec ns1 ip link set dev v2 netns 1\n\tip netns del ns1\n}\n\nns2_create()\n{\n\tip netns add ns2\n\tip link set dev v4 netns ns2\n\tin_ns ns2 \\\n\t      ns_init_common v4 192.0.2.50 192.0.2.34 192.0.2.49 \\\n\t\t\t     192.0.2.4 198.51.100.4\n}\n\nns2_destroy()\n{\n\tip netns exec ns2 ip link set dev v4 netns 1\n\tip netns del ns2\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp1=${NETIFS[p5]}\n\trp2=${NETIFS[p6]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\tswitch_create\n\n\tip link add name v1 type veth peer name v2\n\tip link add name v3 type veth peer name v4\n\tvrp2_create\n\tns1_create\n\tns2_create\n\n\tr1_mac=$(in_ns ns1 mac_get w2)\n\tr2_mac=$(in_ns ns2 mac_get w2)\n\th2_mac=$(mac_get $h2)\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tns2_destroy\n\tns1_destroy\n\tvrp2_destroy\n\tip link del dev v3\n\tip link del dev v1\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 192.0.2.2 \": local->local\"\n\tping_test $h1 192.0.2.3 \": local->remote 1\"\n\tping_test $h1 192.0.2.4 \": local->remote 2\"\n}\n\ntest_all()\n{\n\techo \"Running tests with UDP port $VXPORT\"\n\ttests_run\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntest_all\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}