{
  "module_name": "vxlan_asymmetric_ipv6.sh",
  "hash_id": "b81f52f169189ab216e6e478fad2730a487b199ce09eae71a9df926ea3a52f2b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/vxlan_asymmetric_ipv6.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +--------------------------------+            +-----------------------------+\n# |                         vrf-h1 |            |                      vrf-h2 |\n# |    + $h1                       |            | + $h2                       |\n# |    | 2001:db8:1::1/64          |            | | 2001:db8:2::1/64          |\n# |    | default via 2001:db8:1::3 |            | | default via 2001:db8:2::3 |\n# +----|---------------------------+            +-|---------------------------+\n#      |                                          |\n# +----|------------------------------------------|---------------------------+\n# | SW |                                          |                           |\n# | +--|------------------------------------------|-------------------------+ |\n# | |  + $swp1                         br1        + $swp2                   | |\n# | |     vid 10 pvid untagged                       vid 20 pvid untagged   | |\n# | |                                                                       | |\n# | |  + vx10                                     + vx20                    | |\n# | |    local 2001:db8:3::1                        local 2001:db8:3::1     | |\n# | |    remote 2001:db8:3::2                       remote 2001:db8:3::2    | |\n# | |    id 1000                                    id 2000                 | |\n# | |    dstport 4789                               dstport 4789            | |\n# | |    vid 10 pvid untagged                       vid 20 pvid untagged    | |\n# | |                                                                       | |\n# | +-----------------------------------+-----------------------------------+ |\n# |                                     |                                     |\n# | +-----------------------------------|-----------------------------------+ |\n# | |                                   |                                   | |\n# | |  +--------------------------------+--------------------------------+  | |\n# | |  |                                                                 |  | |\n# | |  + vlan10                                                   vlan20 +  | |\n# | |  | 2001:db8:1::2/64                               2001:db8:2::2/64 |  | |\n# | |  |                                                                 |  | |\n# | |  + vlan10-v (macvlan)                           vlan20-v (macvlan) +  | |\n# | |    2001:db8:1::3/64                               2001:db8:2::3/64    | |\n# | |    00:00:5e:00:01:01                             00:00:5e:00:01:01    | |\n# | |                               vrf-green                               | |\n# | +-----------------------------------------------------------------------+ |\n# |                                                                           |\n# |    + $rp1                                       +lo                       |\n# |    | 2001:db8:4::1/64                            2001:db8:3::1/128        |\n# +----|----------------------------------------------------------------------+\n#      |\n# +----|--------------------------------------------------------+\n# |    |                            vrf-spine                   |\n# |    + $rp2                                                   |\n# |      2001:db8:4::2/64                                       |\n# |                                                             |   (maybe) HW\n# =============================================================================\n# |                                                             |  (likely) SW\n# |                                                             |\n# |    + v1 (veth)                                              |\n# |    | 2001:db8:5::2/64                                       |\n# +----|--------------------------------------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# |    + v2 (veth)                                  +lo           NS1 (netns) |\n# |      2001:db8:5::1/64                            2001:db8:3::2/128        |\n# |                                                                           |\n# | +-----------------------------------------------------------------------+ |\n# | |                               vrf-green                               | |\n# | |  + vlan10-v (macvlan)                           vlan20-v (macvlan) +  | |\n# | |  | 2001:db8:1::3/64                               2001:db8:2::3/64 |  | |\n# | |  | 00:00:5e:00:01:01                             00:00:5e:00:01:01 |  | |\n# | |  |                                                                 |  | |\n# | |  + vlan10                                                   vlan20 +  | |\n# | |  | 2001:db8:1::3/64                               2001:db8:2::3/64 |  | |\n# | |  |                                                                 |  | |\n# | |  +--------------------------------+--------------------------------+  | |\n# | |                                   |                                   | |\n# | +-----------------------------------|-----------------------------------+ |\n# |                                     |                                     |\n# | +-----------------------------------+-----------------------------------+ |\n# | |                                                                       | |\n# | |  + vx10                                     + vx20                    | |\n# | |    local 2001:db8:3::2                        local 2001:db8:3::2     | |\n# | |    remote 2001:db8:3::1                       remote 2001:db8:3::1    | |\n# | |    id 1000                                    id 2000                 | |\n# | |    dstport 4789                               dstport 4789            | |\n# | |    vid 10 pvid untagged                       vid 20 pvid untagged    | |\n# | |                                                                       | |\n# | |  + w1 (veth)                                + w3 (veth)               | |\n# | |  | vid 10 pvid untagged          br1        | vid 20 pvid untagged    | |\n# | +--|------------------------------------------|-------------------------+ |\n# |    |                                          |                           |\n# |    |                                          |                           |\n# | +--|----------------------+                +--|-------------------------+ |\n# | |  |               vrf-h1 |                |  |                  vrf-h2 | |\n# | |  + w2 (veth)            |                |  + w4 (veth)               | |\n# | |    2001:db8:1::4/64     |                |    2001:db8:2::4/64        | |\n# | |    default via          |                |    default via             | |\n# | |    2001:db8:1::3/64     |                |    2001:db8:2::3/64        | |\n# | +-------------------------+                +----------------------------+ |\n# +---------------------------------------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv6\n\tarp_decap\n\"\nNUM_NETIFS=6\nsource lib.sh\n\nrequire_command $ARPING\n\nhx_create()\n{\n\tlocal vrf_name=$1; shift\n\tlocal if_name=$1; shift\n\tlocal ip_addr=$1; shift\n\tlocal gw_ip=$1; shift\n\n\tvrf_create $vrf_name\n\tip link set dev $if_name master $vrf_name\n\tip link set dev $vrf_name up\n\tip link set dev $if_name up\n\n\tip address add $ip_addr/64 dev $if_name\n\tip neigh replace $gw_ip lladdr 00:00:5e:00:01:01 nud permanent \\\n\t\tdev $if_name\n\tip route add default vrf $vrf_name nexthop via $gw_ip\n}\nexport -f hx_create\n\nhx_destroy()\n{\n\tlocal vrf_name=$1; shift\n\tlocal if_name=$1; shift\n\tlocal ip_addr=$1; shift\n\tlocal gw_ip=$1; shift\n\n\tip route del default vrf $vrf_name nexthop via $gw_ip\n\tip neigh del $gw_ip dev $if_name\n\tip address del $ip_addr/64 dev $if_name\n\n\tip link set dev $if_name down\n\tvrf_destroy $vrf_name\n}\n\nh1_create()\n{\n\thx_create \"vrf-h1\" $h1 2001:db8:1::1 2001:db8:1::3\n}\n\nh1_destroy()\n{\n\thx_destroy \"vrf-h1\" $h1 2001:db8:1::1 2001:db8:1::3\n}\n\nh2_create()\n{\n\thx_create \"vrf-h2\" $h2 2001:db8:2::1 2001:db8:2::3\n}\n\nh2_destroy()\n{\n\thx_destroy \"vrf-h2\" $h2 2001:db8:2::1 2001:db8:2::3\n}\n\nswitch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 0\n\t# Make sure the bridge uses the MAC address of the local port and not\n\t# that of the VxLAN's device.\n\tip link set dev br1 address $(mac_get $swp1)\n\tip link set dev br1 up\n\n\tip link set dev $rp1 up\n\tip address add dev $rp1 2001:db8:4::1/64\n\tip route add 2001:db8:3::2/128 nexthop via 2001:db8:4::2\n\n\tip link add name vx10 type vxlan id 1000\t\t\\\n\t\tlocal 2001:db8:3::1 remote 2001:db8:3::2 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx10 up\n\n\tip link set dev vx10 master br1\n\tbridge vlan add vid 10 dev vx10 pvid untagged\n\n\tip link add name vx20 type vxlan id 2000\t\t\\\n\t\tlocal 2001:db8:3::1 remote 2001:db8:3::2 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx20 up\n\n\tip link set dev vx20 master br1\n\tbridge vlan add vid 20 dev vx20 pvid untagged\n\n\tip link set dev $swp1 master br1\n\tip link set dev $swp1 up\n\tbridge vlan add vid 10 dev $swp1 pvid untagged\n\n\tip link set dev $swp2 master br1\n\tip link set dev $swp2 up\n\tbridge vlan add vid 20 dev $swp2 pvid untagged\n\n\tip address add 2001:db8:3::1/128 dev lo\n\n\t# Create SVIs\n\tvrf_create \"vrf-green\"\n\tip link set dev vrf-green up\n\n\tip link add link br1 name vlan10 up master vrf-green type vlan id 10\n\tip address add 2001:db8:1::2/64 dev vlan10\n\tip link add link vlan10 name vlan10-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:1::3/64 dev vlan10-v\n\n\tip link add link br1 name vlan20 up master vrf-green type vlan id 20\n\tip address add 2001:db8:2::2/64 dev vlan20\n\tip link add link vlan20 name vlan20-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:2::3/64 dev vlan20-v\n\n\tbridge vlan add vid 10 dev br1 self\n\tbridge vlan add vid 20 dev br1 self\n\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 10\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 20\n\n}\n\nswitch_destroy()\n{\n\tbridge fdb del 00:00:5e:00:01:01 dev br1 self local vlan 20\n\tbridge fdb del 00:00:5e:00:01:01 dev br1 self local vlan 10\n\n\tbridge vlan del vid 20 dev br1 self\n\tbridge vlan del vid 10 dev br1 self\n\n\tip link del dev vlan20\n\n\tip link del dev vlan10\n\n\tvrf_destroy \"vrf-green\"\n\n\tip address del 2001:db8:3::1/128 dev lo\n\n\tbridge vlan del vid 20 dev $swp2\n\tip link set dev $swp2 down\n\tip link set dev $swp2 nomaster\n\n\tbridge vlan del vid 10 dev $swp1\n\tip link set dev $swp1 down\n\tip link set dev $swp1 nomaster\n\n\tbridge vlan del vid 20 dev vx20\n\tip link set dev vx20 nomaster\n\n\tip link set dev vx20 down\n\tip link del dev vx20\n\n\tbridge vlan del vid 10 dev vx10\n\tip link set dev vx10 nomaster\n\n\tip link set dev vx10 down\n\tip link del dev vx10\n\n\tip route del 2001:db8:3::2 nexthop via 2001:db8:4::2\n\tip address del dev $rp1 2001:db8:4::1/64\n\tip link set dev $rp1 down\n\n\tip link set dev br1 down\n\tip link del dev br1\n}\n\nspine_create()\n{\n\tvrf_create \"vrf-spine\"\n\tip link set dev $rp2 master vrf-spine\n\tip link set dev v1 master vrf-spine\n\tip link set dev vrf-spine up\n\tip link set dev $rp2 up\n\tip link set dev v1 up\n\n\tip address add 2001:db8:4::2/64 dev $rp2\n\tip address add 2001:db8:5::2/64 dev v1\n\n\tip route add 2001:db8:3::1/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:4::1\n\tip route add 2001:db8:3::2/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:5::1\n}\n\nspine_destroy()\n{\n\tip route del 2001:db8:3::2/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:5::1\n\tip route del 2001:db8:3::1/128 vrf vrf-spine nexthop via \\\n\t\t2001:db8:4::1\n\n\tip address del 2001:db8:5::2/64 dev v1\n\tip address del 2001:db8:4::2/64 dev $rp2\n\n\tip link set dev v1 down\n\tip link set dev $rp2 down\n\tvrf_destroy \"vrf-spine\"\n}\n\nns_h1_create()\n{\n\thx_create \"vrf-h1\" w2 2001:db8:1::4 2001:db8:1::3\n}\nexport -f ns_h1_create\n\nns_h2_create()\n{\n\thx_create \"vrf-h2\" w4 2001:db8:2::4 2001:db8:2::3\n}\nexport -f ns_h2_create\n\nns_switch_create()\n{\n\tip link add name br1 type bridge vlan_filtering 1 vlan_default_pvid 0 \\\n\t\tmcast_snooping 0\n\tip link set dev br1 up\n\n\tip link set dev v2 up\n\tip address add dev v2 2001:db8:5::1/64\n\tip route add 2001:db8:3::1 nexthop via 2001:db8:5::2\n\n\tip link add name vx10 type vxlan id 1000\t\t\\\n\t\tlocal 2001:db8:3::2 remote 2001:db8:3::1 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx10 up\n\n\tip link set dev vx10 master br1\n\tbridge vlan add vid 10 dev vx10 pvid untagged\n\n\tip link add name vx20 type vxlan id 2000\t\t\\\n\t\tlocal 2001:db8:3::2 remote 2001:db8:3::1 dstport 4789\t\\\n\t\tnolearning udp6zerocsumrx udp6zerocsumtx tos inherit ttl 100\n\tip link set dev vx20 up\n\n\tip link set dev vx20 master br1\n\tbridge vlan add vid 20 dev vx20 pvid untagged\n\n\tip link set dev w1 master br1\n\tip link set dev w1 up\n\tbridge vlan add vid 10 dev w1 pvid untagged\n\n\tip link set dev w3 master br1\n\tip link set dev w3 up\n\tbridge vlan add vid 20 dev w3 pvid untagged\n\n\tip address add 2001:db8:3::2/128 dev lo\n\n\t# Create SVIs\n\tvrf_create \"vrf-green\"\n\tip link set dev vrf-green up\n\n\tip link add link br1 name vlan10 up master vrf-green type vlan id 10\n\tip address add 2001:db8:1::3/64 dev vlan10\n\tip link add link vlan10 name vlan10-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:1::3/64 dev vlan10-v\n\n\tip link add link br1 name vlan20 up master vrf-green type vlan id 20\n\tip address add 2001:db8:2::3/64 dev vlan20\n\tip link add link vlan20 name vlan20-v up master vrf-green \\\n\t\taddress 00:00:5e:00:01:01 type macvlan mode private\n\tip address add 2001:db8:2::3/64 dev vlan20-v\n\n\tbridge vlan add vid 10 dev br1 self\n\tbridge vlan add vid 20 dev br1 self\n\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 10\n\tbridge fdb add 00:00:5e:00:01:01 dev br1 self local vlan 20\n}\nexport -f ns_switch_create\n\nns_init()\n{\n\tip link add name w1 type veth peer name w2\n\tip link add name w3 type veth peer name w4\n\n\tip link set dev lo up\n\n\tns_h1_create\n\tns_h2_create\n\tns_switch_create\n}\nexport -f ns_init\n\nns1_create()\n{\n\tip netns add ns1\n\tip link set dev v2 netns ns1\n\tin_ns ns1 ns_init\n}\n\nns1_destroy()\n{\n\tip netns exec ns1 ip link set dev v2 netns 1\n\tip netns del ns1\n}\n\nmacs_populate()\n{\n\tlocal mac1=$1; shift\n\tlocal mac2=$1; shift\n\tlocal ip1=$1; shift\n\tlocal ip2=$1; shift\n\tlocal dst=$1; shift\n\n\tbridge fdb add $mac1 dev vx10 self master extern_learn static \\\n\t\tdst $dst vlan 10\n\tbridge fdb add $mac2 dev vx20 self master extern_learn static \\\n\t\tdst $dst vlan 20\n\n\tip neigh add $ip1 lladdr $mac1 nud noarp dev vlan10 \\\n\t\textern_learn\n\tip neigh add $ip2 lladdr $mac2 nud noarp dev vlan20 \\\n\t\textern_learn\n}\nexport -f macs_populate\n\nmacs_initialize()\n{\n\tlocal h1_ns_mac=$(in_ns ns1 mac_get w2)\n\tlocal h2_ns_mac=$(in_ns ns1 mac_get w4)\n\tlocal h1_mac=$(mac_get $h1)\n\tlocal h2_mac=$(mac_get $h2)\n\n\tmacs_populate $h1_ns_mac $h2_ns_mac 2001:db8:1::4 2001:db8:2::4 \\\n\t\t2001:db8:3::2\n\tin_ns ns1 macs_populate $h1_mac $h2_mac 2001:db8:1::1 2001:db8:2::1 \\\n\t\t2001:db8:3::1\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp1=${NETIFS[p5]}\n\trp2=${NETIFS[p6]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\tswitch_create\n\n\tip link add name v1 type veth peer name v2\n\tspine_create\n\tns1_create\n\tin_ns ns1 forwarding_enable\n\n\tmacs_initialize\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tns1_destroy\n\tspine_destroy\n\tip link del dev v1\n\n\tswitch_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:2::1 \": local->local vid 10->vid 20\"\n\tping6_test $h1 2001:db8:1::4 \": local->remote vid 10->vid 10\"\n\tping6_test $h2 2001:db8:2::4 \": local->remote vid 20->vid 20\"\n\tping6_test $h1 2001:db8:2::4 \": local->remote vid 10->vid 20\"\n\tping6_test $h2 2001:db8:1::4 \": local->remote vid 20->vid 10\"\n}\n\narp_decap()\n{\n\t# Repeat the ping tests, but without populating the neighbours. This\n\t# makes sure we correctly decapsulate ARP packets\n\tlog_info \"deleting neighbours from vlan interfaces\"\n\n\tip neigh del 2001:db8:1::4 dev vlan10\n\tip neigh del 2001:db8:2::4 dev vlan20\n\n\tping_ipv6\n\n\tip neigh replace 2001:db8:1::4 lladdr $(in_ns ns1 mac_get w2) \\\n\t\tnud noarp dev vlan10 extern_learn\n\tip neigh replace 2001:db8:2::4 lladdr $(in_ns ns1 mac_get w4) \\\n\t\tnud noarp dev vlan20 extern_learn\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}