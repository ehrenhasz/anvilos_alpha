{
  "module_name": "sch_ets_tests.sh",
  "hash_id": "12e3d9e5af71f311241b0ff3d9cc9e05aab39ca5a4ab8fc4428be0cbd7e1aa67",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/sch_ets_tests.sh",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n\n# Global interface:\n#  $put -- port under test (e.g. $swp2)\n#  collect_stats($streams...) -- A function to get stats for individual streams\n#  ets_start_traffic($band) -- Start traffic for this band\n#  ets_change_qdisc($op, $dev, $nstrict, $quanta...) -- Add or change qdisc\n\n# WS describes the Qdisc configuration. It has one value per band (so the\n# number of array elements indicates the number of bands). If the value is\n# 0, it is a strict band, otherwise the it's a DRR band and the value is\n# that band's quantum.\ndeclare -a WS\n\nqdisc_describe()\n{\n\tlocal nbands=${#WS[@]}\n\tlocal nstrict=0\n\tlocal i\n\n\tfor ((i = 0; i < nbands; i++)); do\n\t\tif ((!${WS[$i]})); then\n\t\t\t: $((nstrict++))\n\t\tfi\n\tdone\n\n\techo -n \"ets bands $nbands\"\n\tif ((nstrict)); then\n\t\techo -n \" strict $nstrict\"\n\tfi\n\tif ((nstrict < nbands)); then\n\t\techo -n \" quanta\"\n\t\tfor ((i = nstrict; i < nbands; i++)); do\n\t\t\techo -n \" ${WS[$i]}\"\n\t\tdone\n\tfi\n}\n\n__strict_eval()\n{\n\tlocal desc=$1; shift\n\tlocal d=$1; shift\n\tlocal total=$1; shift\n\tlocal above=$1; shift\n\n\tRET=0\n\n\tif ((! total)); then\n\t\tcheck_err 1 \"No traffic observed\"\n\t\tlog_test \"$desc\"\n\t\treturn\n\tfi\n\n\tlocal ratio=$(echo \"scale=2; 100 * $d / $total\" | bc -l)\n\tif ((above)); then\n\t\ttest $(echo \"$ratio > 95.0\" | bc -l) -eq 1\n\t\tcheck_err $? \"Not enough traffic\"\n\t\tlog_test \"$desc\"\n\t\tlog_info \"Expected ratio >95% Measured ratio $ratio\"\n\telse\n\t\ttest $(echo \"$ratio < 5\" | bc -l) -eq 1\n\t\tcheck_err $? \"Too much traffic\"\n\t\tlog_test \"$desc\"\n\t\tlog_info \"Expected ratio <5% Measured ratio $ratio\"\n\tfi\n}\n\nstrict_eval()\n{\n\t__strict_eval \"$@\" 1\n}\n\nnotraf_eval()\n{\n\t__strict_eval \"$@\" 0\n}\n\n__ets_dwrr_test()\n{\n\tlocal -a streams=(\"$@\")\n\n\tlocal low_stream=${streams[0]}\n\tlocal seen_strict=0\n\tlocal -a t0 t1 d\n\tlocal stream\n\tlocal total\n\tlocal i\n\n\techo \"Testing $(qdisc_describe), streams ${streams[@]}\"\n\n\tfor stream in ${streams[@]}; do\n\t\tets_start_traffic $stream\n\tdone\n\n\tsleep 10\n\n\tt0=($(collect_stats \"${streams[@]}\"))\n\n\tsleep 10\n\n\tt1=($(collect_stats \"${streams[@]}\"))\n\td=($(for ((i = 0; i < ${#streams[@]}; i++)); do\n\t\t echo $((${t1[$i]} - ${t0[$i]}))\n\t     done))\n\ttotal=$(echo ${d[@]} | sed 's/ /+/g' | bc)\n\n\tfor ((i = 0; i < ${#streams[@]}; i++)); do\n\t\tlocal stream=${streams[$i]}\n\t\tif ((seen_strict)); then\n\t\t\tnotraf_eval \"band $stream\" ${d[$i]} $total\n\t\telif ((${WS[$stream]} == 0)); then\n\t\t\tstrict_eval \"band $stream\" ${d[$i]} $total\n\t\t\tseen_strict=1\n\t\telif ((stream == low_stream)); then\n\t\t\t# Low stream is used as DWRR evaluation reference.\n\t\t\tcontinue\n\t\telse\n\t\t\tmultipath_eval \"bands $low_stream:$stream\" \\\n\t\t\t\t       ${WS[$low_stream]} ${WS[$stream]} \\\n\t\t\t\t       ${d[0]} ${d[$i]}\n\t\tfi\n\tdone\n\n\tfor stream in ${streams[@]}; do\n\t\tstop_traffic\n\tdone\n}\n\nets_dwrr_test_012()\n{\n\t__ets_dwrr_test 0 1 2\n}\n\nets_dwrr_test_01()\n{\n\t__ets_dwrr_test 0 1\n}\n\nets_dwrr_test_12()\n{\n\t__ets_dwrr_test 1 2\n}\n\nets_qdisc_setup()\n{\n\tlocal dev=$1; shift\n\tlocal nstrict=$1; shift\n\tlocal -a quanta=(\"$@\")\n\n\tlocal ndwrr=${#quanta[@]}\n\tlocal nbands=$((nstrict + ndwrr))\n\tlocal nstreams=$(if ((nbands > 3)); then echo 3; else echo $nbands; fi)\n\tlocal priomap=$(seq 0 $((nstreams - 1)))\n\tlocal i\n\n\tWS=($(\n\t\tfor ((i = 0; i < nstrict; i++)); do\n\t\t\techo 0\n\t\tdone\n\t\tfor ((i = 0; i < ndwrr; i++)); do\n\t\t\techo ${quanta[$i]}\n\t\tdone\n\t))\n\n\tets_change_qdisc $dev $nstrict \"$priomap\" ${quanta[@]}\n}\n\nets_set_dwrr_uniform()\n{\n\tets_qdisc_setup $put 0 3300 3300 3300\n}\n\nets_set_dwrr_varying()\n{\n\tets_qdisc_setup $put 0 5000 3500 1500\n}\n\nets_set_strict()\n{\n\tets_qdisc_setup $put 3\n}\n\nets_set_mixed()\n{\n\tets_qdisc_setup $put 1 5000 2500 1500\n}\n\nets_change_quantum()\n{\n\ttc class change dev $put classid 10:2 ets quantum 8000\n\tWS[1]=8000\n}\n\nets_set_dwrr_two_bands()\n{\n\tets_qdisc_setup $put 0 5000 2500\n}\n\nets_test_strict()\n{\n\tets_set_strict\n\tets_dwrr_test_01\n\tets_dwrr_test_12\n}\n\nets_test_mixed()\n{\n\tets_set_mixed\n\tets_dwrr_test_01\n\tets_dwrr_test_12\n}\n\nets_test_dwrr()\n{\n\tets_set_dwrr_uniform\n\tets_dwrr_test_012\n\tets_set_dwrr_varying\n\tets_dwrr_test_012\n\tets_change_quantum\n\tets_dwrr_test_012\n\tets_set_dwrr_two_bands\n\tets_dwrr_test_01\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}