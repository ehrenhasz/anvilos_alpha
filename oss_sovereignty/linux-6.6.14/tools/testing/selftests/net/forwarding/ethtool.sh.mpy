{
  "module_name": "ethtool.sh",
  "hash_id": "17a86aa88e0cd14e1fbeb5b34cf20ee084d1dabaca3d14ad8383146fabd2307d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/ethtool.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"\n\tsame_speeds_autoneg_off\n\tdifferent_speeds_autoneg_off\n\tcombination_of_neg_on_and_off\n\tadvertise_subset_of_speeds\n\tcheck_highest_speed_is_chosen\n\tdifferent_speeds_autoneg_on\n\"\nNUM_NETIFS=2\nsource lib.sh\nsource ethtool_lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n}\n\nh1_destroy()\n{\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 192.0.2.2/24\n}\n\nh2_destroy()\n{\n\tsimple_if_fini $h2 192.0.2.2/24\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n}\n\nsame_speeds_autoneg_off()\n{\n\t# Check that when each of the reported speeds is forced, the links come\n\t# up and are operational.\n\tlocal -a speeds_arr=($(common_speeds_get $h1 $h2 0 0))\n\n\tfor speed in \"${speeds_arr[@]}\"; do\n\t\tRET=0\n\t\tethtool_set $h1 speed $speed autoneg off\n\t\tethtool_set $h2 speed $speed autoneg off\n\n\t\tsetup_wait_dev_with_timeout $h1\n\t\tsetup_wait_dev_with_timeout $h2\n\t\tping_do $h1 192.0.2.2\n\t\tcheck_err $? \"speed $speed autoneg off\"\n\t\tlog_test \"force of same speed autoneg off\"\n\t\tlog_info \"speed = $speed\"\n\tdone\n\n\tethtool -s $h2 autoneg on\n\tethtool -s $h1 autoneg on\n}\n\ndifferent_speeds_autoneg_off()\n{\n\t# Test that when we force different speeds, links are not up and ping\n\t# fails.\n\tRET=0\n\n\tlocal -a speeds_arr=($(different_speeds_get $h1 $h2 0 0))\n\tlocal speed1=${speeds_arr[0]}\n\tlocal speed2=${speeds_arr[1]}\n\n\tethtool_set $h1 speed $speed1 autoneg off\n\tethtool_set $h2 speed $speed2 autoneg off\n\n\tsetup_wait_dev_with_timeout $h1\n\tsetup_wait_dev_with_timeout $h2\n\tping_do $h1 192.0.2.2\n\tcheck_fail $? \"ping with different speeds\"\n\n\tlog_test \"force of different speeds autoneg off\"\n\n\tethtool -s $h2 autoneg on\n\tethtool -s $h1 autoneg on\n}\n\ncombination_of_neg_on_and_off()\n{\n\t# Test that when one device is forced to a speed supported by both\n\t# endpoints and the other device is configured to autoneg on, the links\n\t# are up and ping passes.\n\tlocal -a speeds_arr=($(common_speeds_get $h1 $h2 0 1))\n\n\tfor speed in \"${speeds_arr[@]}\"; do\n\t\tRET=0\n\t\tethtool_set $h1 speed $speed autoneg off\n\n\t\tsetup_wait_dev_with_timeout $h1\n\t\tsetup_wait_dev_with_timeout $h2\n\t\tping_do $h1 192.0.2.2\n\t\tcheck_err $? \"h1-speed=$speed autoneg off, h2 autoneg on\"\n\t\tlog_test \"one side with autoneg off and another with autoneg on\"\n\t\tlog_info \"force speed = $speed\"\n\tdone\n\n\tethtool -s $h1 autoneg on\n}\n\nhex_speed_value_get()\n{\n\tlocal speed=$1; shift\n\n\tlocal shift_size=${speed_values[$speed]}\n\tspeed=$((0x1 << $\"shift_size\"))\n\tprintf \"%#x\" \"$speed\"\n}\n\nsubset_of_common_speeds_get()\n{\n\tlocal dev1=$1; shift\n\tlocal dev2=$1; shift\n\tlocal adver=$1; shift\n\n\tlocal -a speeds_arr=($(common_speeds_get $dev1 $dev2 0 $adver))\n\tlocal speed_to_advertise=0\n\tlocal speed_to_remove=${speeds_arr[0]}\n\tspeed_to_remove+='base'\n\n\tlocal -a speeds_mode_arr=($(common_speeds_get $dev1 $dev2 1 $adver))\n\n\tfor speed in ${speeds_mode_arr[@]}; do\n\t\tif [[ $speed != $speed_to_remove* ]]; then\n\t\t\tspeed=$(hex_speed_value_get $speed)\n\t\t\tspeed_to_advertise=$(($speed_to_advertise | \\\n\t\t\t\t\t\t$speed))\n\t\tfi\n\n\tdone\n\n\t# Convert to hex.\n\tprintf \"%#x\" \"$speed_to_advertise\"\n}\n\nspeed_to_advertise_get()\n{\n\t# The function returns the hex number that is composed by OR-ing all\n\t# the modes corresponding to the provided speed.\n\tlocal speed_without_mode=$1; shift\n\tlocal supported_speeds=(\"$@\"); shift\n\tlocal speed_to_advertise=0\n\n\tspeed_without_mode+='base'\n\n\tfor speed in ${supported_speeds[@]}; do\n\t\tif [[ $speed == $speed_without_mode* ]]; then\n\t\t\tspeed=$(hex_speed_value_get $speed)\n\t\t\tspeed_to_advertise=$(($speed_to_advertise | \\\n\t\t\t\t\t\t$speed))\n\t\tfi\n\n\tdone\n\n\t# Convert to hex.\n\tprintf \"%#x\" \"$speed_to_advertise\"\n}\n\nadvertise_subset_of_speeds()\n{\n\t# Test that when one device advertises a subset of speeds and another\n\t# advertises a specific speed (but all modes of this speed), the links\n\t# are up and ping passes.\n\tRET=0\n\n\tlocal speed_1_to_advertise=$(subset_of_common_speeds_get $h1 $h2 1)\n\tethtool_set $h1 advertise $speed_1_to_advertise\n\n\tif [ $RET != 0 ]; then\n\t\tlog_test \"advertise subset of speeds\"\n\t\treturn\n\tfi\n\n\tlocal -a speeds_arr_without_mode=($(common_speeds_get $h1 $h2 0 1))\n\t# Check only speeds that h1 advertised. Remove the first speed.\n\tunset speeds_arr_without_mode[0]\n\tlocal -a speeds_arr_with_mode=($(common_speeds_get $h1 $h2 1 1))\n\n\tfor speed_value in ${speeds_arr_without_mode[@]}; do\n\t\tRET=0\n\t\tlocal speed_2_to_advertise=$(speed_to_advertise_get $speed_value \\\n\t\t\t\"${speeds_arr_with_mode[@]}\")\n\t\tethtool_set $h2 advertise $speed_2_to_advertise\n\n\t\tsetup_wait_dev_with_timeout $h1\n\t\tsetup_wait_dev_with_timeout $h2\n\t\tping_do $h1 192.0.2.2\n\t\tcheck_err $? \"h1=$speed_1_to_advertise, h2=$speed_2_to_advertise ($speed_value)\"\n\n\t\tlog_test \"advertise subset of speeds\"\n\t\tlog_info \"h1=$speed_1_to_advertise, h2=$speed_2_to_advertise\"\n\tdone\n\n\tethtool -s $h2 autoneg on\n\tethtool -s $h1 autoneg on\n}\n\ncheck_highest_speed_is_chosen()\n{\n\t# Test that when one device advertises a subset of speeds, the other\n\t# chooses the highest speed. This test checks configuration without\n\t# traffic.\n\tRET=0\n\n\tlocal max_speed\n\tlocal chosen_speed\n\tlocal speed_to_advertise=$(subset_of_common_speeds_get $h1 $h2 1)\n\n\tethtool_set $h1 advertise $speed_to_advertise\n\n\tif [ $RET != 0 ]; then\n\t\tlog_test \"check highest speed\"\n\t\treturn\n\tfi\n\n\tlocal -a speeds_arr=($(common_speeds_get $h1 $h2 0 1))\n\n\tmax_speed=${speeds_arr[0]}\n\tfor current in ${speeds_arr[@]}; do\n\t\tif [[ $current -gt $max_speed ]]; then\n\t\t\tmax_speed=$current\n\t\tfi\n\tdone\n\n\tsetup_wait_dev_with_timeout $h1\n\tsetup_wait_dev_with_timeout $h2\n\tchosen_speed=$(ethtool $h1 | grep 'Speed:')\n\tchosen_speed=${chosen_speed%\"Mb/s\"*}\n\tchosen_speed=${chosen_speed#*\"Speed: \"}\n\t((chosen_speed == max_speed))\n\tcheck_err $? \"h1 advertise $speed_to_advertise, h2 sync to speed $chosen_speed\"\n\n\tlog_test \"check highest speed\"\n\n\tethtool -s $h2 autoneg on\n\tethtool -s $h1 autoneg on\n}\n\ndifferent_speeds_autoneg_on()\n{\n\t# Test that when we configure links to advertise different speeds,\n\t# links are not up and ping fails.\n\tRET=0\n\n\tlocal -a speeds=($(different_speeds_get $h1 $h2 1 1))\n\tlocal speed1=${speeds[0]}\n\tlocal speed2=${speeds[1]}\n\n\tspeed1=$(hex_speed_value_get $speed1)\n\tspeed2=$(hex_speed_value_get $speed2)\n\n\tethtool_set $h1 advertise $speed1\n\tethtool_set $h2 advertise $speed2\n\n\tif (($RET)); then\n\t\tsetup_wait_dev_with_timeout $h1\n\t\tsetup_wait_dev_with_timeout $h2\n\t\tping_do $h1 192.0.2.2\n\t\tcheck_fail $? \"ping with different speeds autoneg on\"\n\tfi\n\n\tlog_test \"advertise different speeds autoneg on\"\n\n\tethtool -s $h2 autoneg on\n\tethtool -s $h1 autoneg on\n}\n\nskip_on_veth\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ndeclare -gA speed_values\neval \"speed_values=($(speeds_arr_get))\"\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}