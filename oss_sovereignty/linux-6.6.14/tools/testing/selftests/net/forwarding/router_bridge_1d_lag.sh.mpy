{
  "module_name": "router_bridge_1d_lag.sh",
  "hash_id": "f69c4ce7ec31b6cfe9c2fe99c334d3262aea598fcfa5278002733998e1cc9d02",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/router_bridge_1d_lag.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# +--------------------------------------------+\n# | H1 (vrf)                                   |\n# |                                            |\n# |    + LAG1.100          + LAG1.200          |\n# |    | 192.0.2.1/28      | 192.0.2.17/28     |\n# |    | 2001:db8:1::1/64  | 2001:db8:3:1/64   |\n# |    \\___________ _______/                   |\n# |                v                           |\n# |                + LAG1 (team)               |\n# |                |                           |\n# |            ____^____                       |\n# |           /         \\                      |\n# |          + $h1       + $h4                 |\n# |          |           |                     |\n# +----------|-----------|---------------------+\n#            |           |\n# +----------|-----------|---------------------+\n# | SW       |           |                     |\n# |          + $swp1     + $swp4               |\n# |           \\____ ____/                      |\n# |                v                           |\n# |    LAG2 (team) +                           |\n# |                |                           |\n# |         _______^______________             |\n# |        /                      \\            |\n# | +------|------------+ +-------|----------+ |\n# | |      + LAG2.100   | |       + LAG2.200 | |\n# | |                   | |                  | |\n# | |  BR1 (802.1d)     | | BR2 (802.1d)     | |\n# | |  192.0.2.2/28     | | 192.0.2.18/28    | |\n# | |  2001:db8:1::2/64 | | 2001:db8:3:2/64  | |\n# | |                   | |                  | |\n# | +-------------------+ +------------------+ |\n# |                                            |\n# |  + LAG3.100             + LAG3.200         |\n# |  | 192.0.2.129/28       | 192.0.2.145/28   |\n# |  | 2001:db8:2::1/64     | 2001:db8:4::1/64 |\n# |  |                      |                  |\n# |  \\_________ ___________/                   |\n# |            v                               |\n# |            + LAG3 (team)                   |\n# |        ____|____                           |\n# |       /         \\                          |\n# |       + $swp2   + $swp3                    |\n# |       |         |                          |\n# +-------|---------|--------------------------+\n#         |         |\n# +-------|---------|--------------------------+\n# |       |         |                          |\n# |       + $h2     + $h3                      |\n# |       \\____ ___/                           |\n# |            |                               |\n# |            + LAG4 (team)                   |\n# |            |                               |\n# |  __________^__________                     |\n# | /                     \\                    |\n# | |                     |                    |\n# | + LAG4.100            + LAG4.200           |\n# |   192.0.2.130/28        192.0.2.146/28     |\n# |   2001:db8:2::2/64      2001:db8:4::2/64   |\n# |                                            |\n# | H2 (vrf)                                   |\n# +--------------------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\n\t$(: exercise remastering of LAG2 slaves )\n\tconfig_deslave_swp4\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_enslave_swp4\n\tconfig_deslave_swp1\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_deslave_swp4\n\tconfig_enslave_swp1\n\tconfig_enslave_swp4\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\n\t$(: exercise remastering of LAG2 itself )\n\tconfig_remaster_lag2\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\n\t$(: exercise remastering of LAG3 slaves )\n\tconfig_deslave_swp2\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_enslave_swp2\n\tconfig_deslave_swp3\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\tconfig_deslave_swp2\n\tconfig_enslave_swp3\n\tconfig_enslave_swp2\n\tconfig_wait\n\tping_ipv4\n\tping_ipv6\n\"\nNUM_NETIFS=8\nsource lib.sh\n\nh1_create()\n{\n\tteam_create lag1 lacp\n\tip link set dev lag1 addrgenmode none\n\tip link set dev lag1 address $(mac_get $h1)\n\tip link set dev $h1 master lag1\n\tip link set dev $h4 master lag1\n\tsimple_if_init lag1\n\tip link set dev $h1 up\n\tip link set dev $h4 up\n\n\tvlan_create lag1 100 vlag1 192.0.2.1/28 2001:db8:1::1/64\n\tvlan_create lag1 200 vlag1 192.0.2.17/28 2001:db8:3::1/64\n\n\tip -4 route add 192.0.2.128/28 vrf vlag1 nexthop via 192.0.2.2\n\tip -6 route add 2001:db8:2::/64 vrf vlag1 nexthop via 2001:db8:1::2\n\n\tip -4 route add 192.0.2.144/28 vrf vlag1 nexthop via 192.0.2.18\n\tip -6 route add 2001:db8:4::/64 vrf vlag1 nexthop via 2001:db8:3::2\n}\n\nh1_destroy()\n{\n\tip -6 route del 2001:db8:4::/64 vrf vlag1\n\tip -4 route del 192.0.2.144/28 vrf vlag1\n\n\tip -6 route del 2001:db8:2::/64 vrf vlag1\n\tip -4 route del 192.0.2.128/28 vrf vlag1\n\n\tvlan_destroy lag1 200\n\tvlan_destroy lag1 100\n\n\tip link set dev $h4 down\n\tip link set dev $h1 down\n\tsimple_if_fini lag1\n\tip link set dev $h4 nomaster\n\tip link set dev $h1 nomaster\n\tteam_destroy lag1\n}\n\nh2_create()\n{\n\tteam_create lag4 lacp\n\tip link set dev lag4 addrgenmode none\n\tip link set dev lag4 address $(mac_get $h2)\n\tip link set dev $h2 master lag4\n\tip link set dev $h3 master lag4\n\tsimple_if_init lag4\n\tip link set dev $h2 up\n\tip link set dev $h3 up\n\n\tvlan_create lag4 100 vlag4 192.0.2.130/28 2001:db8:2::2/64\n\tvlan_create lag4 200 vlag4 192.0.2.146/28 2001:db8:4::2/64\n\n\tip -4 route add 192.0.2.0/28 vrf vlag4 nexthop via 192.0.2.129\n\tip -6 route add 2001:db8:1::/64 vrf vlag4 nexthop via 2001:db8:2::1\n\n\tip -4 route add 192.0.2.16/28 vrf vlag4 nexthop via 192.0.2.145\n\tip -6 route add 2001:db8:3::/64 vrf vlag4 nexthop via 2001:db8:4::1\n}\n\nh2_destroy()\n{\n\tip -6 route del 2001:db8:3::/64 vrf vlag4\n\tip -4 route del 192.0.2.16/28 vrf vlag4\n\n\tip -6 route del 2001:db8:1::/64 vrf vlag4\n\tip -4 route del 192.0.2.0/28 vrf vlag4\n\n\tvlan_destroy lag4 200\n\tvlan_destroy lag4 100\n\n\tip link set dev $h3 down\n\tip link set dev $h2 down\n\tsimple_if_fini lag4\n\tip link set dev $h3 nomaster\n\tip link set dev $h2 nomaster\n\tteam_destroy lag4\n}\n\nrouter_create()\n{\n\tteam_create lag2 lacp\n\tip link set dev lag2 addrgenmode none\n\tip link set dev lag2 address $(mac_get $swp1)\n\tip link set dev $swp1 master lag2\n\tip link set dev $swp4 master lag2\n\n\tvlan_create lag2 100\n\tvlan_create lag2 200\n\n\tip link add name br1 type bridge vlan_filtering 0\n\tip link set dev br1 address $(mac_get lag2.100)\n\tip link set dev lag2.100 master br1\n\n\tip link add name br2 type bridge vlan_filtering 0\n\tip link set dev br2 address $(mac_get lag2.200)\n\tip link set dev lag2.200 master br2\n\n\tip link set dev $swp1 up\n\tip link set dev $swp4 up\n\tip link set dev br1 up\n\tip link set dev br2 up\n\n\t__addr_add_del br1 add 192.0.2.2/28 2001:db8:1::2/64\n\t__addr_add_del br2 add 192.0.2.18/28 2001:db8:3::2/64\n\n\tteam_create lag3 lacp\n\tip link set dev lag3 addrgenmode none\n\tip link set dev lag3 address $(mac_get $swp2)\n\tip link set dev $swp2 master lag3\n\tip link set dev $swp3 master lag3\n\tip link set dev $swp2 up\n\tip link set dev $swp3 up\n\n\tvlan_create lag3 100\n\tvlan_create lag3 200\n\n\t__addr_add_del lag3.100 add 192.0.2.129/28 2001:db8:2::1/64\n\t__addr_add_del lag3.200 add 192.0.2.145/28 2001:db8:4::1/64\n}\n\nrouter_destroy()\n{\n\t__addr_add_del lag3.200 del 192.0.2.145/28 2001:db8:4::1/64\n\t__addr_add_del lag3.100 del 192.0.2.129/28 2001:db8:2::1/64\n\n\tvlan_destroy lag3 200\n\tvlan_destroy lag3 100\n\n\tip link set dev $swp3 down\n\tip link set dev $swp2 down\n\tip link set dev $swp3 nomaster\n\tip link set dev $swp2 nomaster\n\tteam_destroy lag3\n\n\t__addr_add_del br2 del 192.0.2.18/28 2001:db8:3::2/64\n\t__addr_add_del br1 del 192.0.2.2/28 2001:db8:1::2/64\n\n\tip link set dev br2 down\n\tip link set dev br1 down\n\tip link set dev $swp4 down\n\tip link set dev $swp1 down\n\n\tip link set dev lag2.200 nomaster\n\tip link del dev br2\n\n\tip link set dev lag2.100 nomaster\n\tip link del dev br1\n\n\tvlan_destroy lag2 200\n\tvlan_destroy lag2 100\n\n\tip link set dev $swp4 nomaster\n\tip link set dev $swp1 nomaster\n\tteam_destroy lag2\n}\n\nconfig_remaster_lag2()\n{\n\tlog_info \"Remaster bridge slaves\"\n\n\tip link set dev lag2.200 nomaster\n\tip link set dev lag2.100 nomaster\n\tsleep 2\n\tip link set dev lag2.100 master br1\n\tip link set dev lag2.200 master br2\n}\n\nconfig_deslave()\n{\n\tlocal netdev=$1; shift\n\n\tlog_info \"Deslave $netdev\"\n\tip link set dev $netdev down\n\tip link set dev $netdev nomaster\n\tip link set dev $netdev up\n}\n\nconfig_deslave_swp1()\n{\n\tconfig_deslave $swp1\n}\n\nconfig_deslave_swp2()\n{\n\tconfig_deslave $swp2\n}\n\nconfig_deslave_swp3()\n{\n\tconfig_deslave $swp3\n}\n\nconfig_deslave_swp4()\n{\n\tconfig_deslave $swp4\n}\n\nconfig_enslave()\n{\n\tlocal netdev=$1; shift\n\tlocal master=$1; shift\n\n\tlog_info \"Enslave $netdev to $master\"\n\tip link set dev $netdev down\n\tip link set dev $netdev master $master\n\tip link set dev $netdev up\n}\n\nconfig_enslave_swp1()\n{\n\tconfig_enslave $swp1 lag2\n}\n\nconfig_enslave_swp2()\n{\n\tconfig_enslave $swp2 lag3\n}\n\nconfig_enslave_swp3()\n{\n\tconfig_enslave $swp3 lag3\n}\n\nconfig_enslave_swp4()\n{\n\tconfig_enslave $swp4 lag2\n}\n\nconfig_wait()\n{\n\tsetup_wait_dev lag2\n\tsetup_wait_dev lag3\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\th4=${NETIFS[p7]}\n\tswp4=${NETIFS[p8]}\n\n\tvrf_prepare\n\n\th1_create\n\th2_create\n\n\trouter_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\trouter_destroy\n\n\th2_destroy\n\th1_destroy\n\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test lag1.100 192.0.2.130 \": via 100\"\n\tping_test lag1.200 192.0.2.146 \": via 200\"\n}\n\nping_ipv6()\n{\n\tping6_test lag1.100 2001:db8:2::2 \": via 100\"\n\tping6_test lag1.200 2001:db8:4::2 \": via 200\"\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}