{
  "module_name": "custom_multipath_hash.sh",
  "hash_id": "861be0c409c87f20a1311c13843bd1e1088005a9a6c610e74e479553f15ce47a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/custom_multipath_hash.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test traffic distribution between two paths when using custom hash policy.\n#\n# +--------------------------------+\n# | H1                             |\n# |                     $h1 +      |\n# |   198.51.100.{2-253}/24 |      |\n# |   2001:db8:1::{2-fd}/64 |      |\n# +-------------------------|------+\n#                           |\n# +-------------------------|-------------------------+\n# | SW1                     |                         |\n# |                    $rp1 +                         |\n# |         198.51.100.1/24                           |\n# |        2001:db8:1::1/64                           |\n# |                                                   |\n# |                                                   |\n# |            $rp11 +             + $rp12            |\n# |     192.0.2.1/28 |             | 192.0.2.17/28    |\n# | 2001:db8:2::1/64 |             | 2001:db8:3::1/64 |\n# +------------------|-------------|------------------+\n#                    |             |\n# +------------------|-------------|------------------+\n# | SW2              |             |                  |\n# |                  |             |                  |\n# |            $rp21 +             + $rp22            |\n# |     192.0.2.2/28                 192.0.2.18/28    |\n# | 2001:db8:2::2/64                 2001:db8:3::2/64 |\n# |                                                   |\n# |                                                   |\n# |                    $rp2 +                         |\n# |          203.0.113.1/24 |                         |\n# |        2001:db8:4::1/64 |                         |\n# +-------------------------|-------------------------+\n#                           |\n# +-------------------------|------+\n# | H2                      |      |\n# |                     $h2 +      |\n# |    203.0.113.{2-253}/24        |\n# |   2001:db8:4::{2-fd}/64        |\n# +--------------------------------+\n\nALL_TESTS=\"\n\tping_ipv4\n\tping_ipv6\n\tcustom_hash\n\"\n\nNUM_NETIFS=8\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 198.51.100.2/24 2001:db8:1::2/64\n\tip route add vrf v$h1 default via 198.51.100.1 dev $h1\n\tip -6 route add vrf v$h1 default via 2001:db8:1::1 dev $h1\n}\n\nh1_destroy()\n{\n\tip -6 route del vrf v$h1 default\n\tip route del vrf v$h1 default\n\tsimple_if_fini $h1 198.51.100.2/24 2001:db8:1::2/64\n}\n\nsw1_create()\n{\n\tsimple_if_init $rp1 198.51.100.1/24 2001:db8:1::1/64\n\t__simple_if_init $rp11 v$rp1 192.0.2.1/28 2001:db8:2::1/64\n\t__simple_if_init $rp12 v$rp1 192.0.2.17/28 2001:db8:3::1/64\n\n\tip route add vrf v$rp1 203.0.113.0/24 \\\n\t\tnexthop via 192.0.2.2 dev $rp11 \\\n\t\tnexthop via 192.0.2.18 dev $rp12\n\n\tip -6 route add vrf v$rp1 2001:db8:4::/64 \\\n\t\tnexthop via 2001:db8:2::2 dev $rp11 \\\n\t\tnexthop via 2001:db8:3::2 dev $rp12\n}\n\nsw1_destroy()\n{\n\tip -6 route del vrf v$rp1 2001:db8:4::/64\n\n\tip route del vrf v$rp1 203.0.113.0/24\n\n\t__simple_if_fini $rp12 192.0.2.17/28 2001:db8:3::1/64\n\t__simple_if_fini $rp11 192.0.2.1/28 2001:db8:2::1/64\n\tsimple_if_fini $rp1 198.51.100.1/24 2001:db8:1::1/64\n}\n\nsw2_create()\n{\n\tsimple_if_init $rp2 203.0.113.1/24 2001:db8:4::1/64\n\t__simple_if_init $rp21 v$rp2 192.0.2.2/28 2001:db8:2::2/64\n\t__simple_if_init $rp22 v$rp2 192.0.2.18/28 2001:db8:3::2/64\n\n\tip route add vrf v$rp2 198.51.100.0/24 \\\n\t\tnexthop via 192.0.2.1 dev $rp21 \\\n\t\tnexthop via 192.0.2.17 dev $rp22\n\n\tip -6 route add vrf v$rp2 2001:db8:1::/64 \\\n\t\tnexthop via 2001:db8:2::1 dev $rp21 \\\n\t\tnexthop via 2001:db8:3::1 dev $rp22\n}\n\nsw2_destroy()\n{\n\tip -6 route del vrf v$rp2 2001:db8:1::/64\n\n\tip route del vrf v$rp2 198.51.100.0/24\n\n\t__simple_if_fini $rp22 192.0.2.18/28 2001:db8:3::2/64\n\t__simple_if_fini $rp21 192.0.2.2/28 2001:db8:2::2/64\n\tsimple_if_fini $rp2 203.0.113.1/24 2001:db8:4::1/64\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 203.0.113.2/24 2001:db8:4::2/64\n\tip route add vrf v$h2 default via 203.0.113.1 dev $h2\n\tip -6 route add vrf v$h2 default via 2001:db8:4::1 dev $h2\n}\n\nh2_destroy()\n{\n\tip -6 route del vrf v$h2 default\n\tip route del vrf v$h2 default\n\tsimple_if_fini $h2 203.0.113.2/24 2001:db8:4::2/64\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\n\trp1=${NETIFS[p2]}\n\n\trp11=${NETIFS[p3]}\n\trp21=${NETIFS[p4]}\n\n\trp12=${NETIFS[p5]}\n\trp22=${NETIFS[p6]}\n\n\trp2=${NETIFS[p7]}\n\n\th2=${NETIFS[p8]}\n\n\tvrf_prepare\n\th1_create\n\tsw1_create\n\tsw2_create\n\th2_create\n\n\tforwarding_enable\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tforwarding_restore\n\n\th2_destroy\n\tsw2_destroy\n\tsw1_destroy\n\th1_destroy\n\tvrf_cleanup\n}\n\nping_ipv4()\n{\n\tping_test $h1 203.0.113.2\n}\n\nping_ipv6()\n{\n\tping6_test $h1 2001:db8:4::2\n}\n\nsend_src_ipv4()\n{\n\tip vrf exec v$h1 $MZ $h1 -q -p 64 \\\n\t\t-A \"198.51.100.2-198.51.100.253\" -B 203.0.113.2 \\\n\t\t-d 1msec -c 50 -t udp \"sp=20000,dp=30000\"\n}\n\nsend_dst_ipv4()\n{\n\tip vrf exec v$h1 $MZ $h1 -q -p 64 \\\n\t\t-A 198.51.100.2 -B \"203.0.113.2-203.0.113.253\" \\\n\t\t-d 1msec -c 50 -t udp \"sp=20000,dp=30000\"\n}\n\nsend_src_udp4()\n{\n\tip vrf exec v$h1 $MZ $h1 -q -p 64 \\\n\t\t-A 198.51.100.2 -B 203.0.113.2 \\\n\t\t-d 1msec -t udp \"sp=0-32768,dp=30000\"\n}\n\nsend_dst_udp4()\n{\n\tip vrf exec v$h1 $MZ $h1 -q -p 64 \\\n\t\t-A 198.51.100.2 -B 203.0.113.2 \\\n\t\t-d 1msec -t udp \"sp=20000,dp=0-32768\"\n}\n\nsend_src_ipv6()\n{\n\tip vrf exec v$h1 $MZ -6 $h1 -q -p 64 \\\n\t\t-A \"2001:db8:1::2-2001:db8:1::fd\" -B 2001:db8:4::2 \\\n\t\t-d 1msec -c 50 -t udp \"sp=20000,dp=30000\"\n}\n\nsend_dst_ipv6()\n{\n\tip vrf exec v$h1 $MZ -6 $h1 -q -p 64 \\\n\t\t-A 2001:db8:1::2 -B \"2001:db8:4::2-2001:db8:4::fd\" \\\n\t\t-d 1msec -c 50 -t udp \"sp=20000,dp=30000\"\n}\n\nsend_flowlabel()\n{\n\t# Generate 16384 echo requests, each with a random flow label.\n\tfor _ in $(seq 1 16384); do\n\t\tip vrf exec v$h1 \\\n\t\t\t$PING6 2001:db8:4::2 -F 0 -c 1 -q >/dev/null 2>&1\n\tdone\n}\n\nsend_src_udp6()\n{\n\tip vrf exec v$h1 $MZ -6 $h1 -q -p 64 \\\n\t\t-A 2001:db8:1::2 -B 2001:db8:4::2 \\\n\t\t-d 1msec -t udp \"sp=0-32768,dp=30000\"\n}\n\nsend_dst_udp6()\n{\n\tip vrf exec v$h1 $MZ -6 $h1 -q -p 64 \\\n\t\t-A 2001:db8:1::2 -B 2001:db8:4::2 \\\n\t\t-d 1msec -t udp \"sp=20000,dp=0-32768\"\n}\n\ncustom_hash_test()\n{\n\tlocal field=\"$1\"; shift\n\tlocal balanced=\"$1\"; shift\n\tlocal send_flows=\"$@\"\n\n\tRET=0\n\n\tlocal t0_rp11=$(link_stats_tx_packets_get $rp11)\n\tlocal t0_rp12=$(link_stats_tx_packets_get $rp12)\n\n\t$send_flows\n\n\tlocal t1_rp11=$(link_stats_tx_packets_get $rp11)\n\tlocal t1_rp12=$(link_stats_tx_packets_get $rp12)\n\n\tlocal d_rp11=$((t1_rp11 - t0_rp11))\n\tlocal d_rp12=$((t1_rp12 - t0_rp12))\n\n\tlocal diff=$((d_rp12 - d_rp11))\n\tlocal sum=$((d_rp11 + d_rp12))\n\n\tlocal pct=$(echo \"$diff / $sum * 100\" | bc -l)\n\tlocal is_balanced=$(echo \"-20 <= $pct && $pct <= 20\" | bc)\n\n\t[[ ( $is_balanced -eq 1 && $balanced == \"balanced\" ) ||\n\t   ( $is_balanced -eq 0 && $balanced == \"unbalanced\" ) ]]\n\tcheck_err $? \"Expected traffic to be $balanced, but it is not\"\n\n\tlog_test \"Multipath hash field: $field ($balanced)\"\n\tlog_info \"Packets sent on path1 / path2: $d_rp11 / $d_rp12\"\n}\n\ncustom_hash_v4()\n{\n\tlog_info \"Running IPv4 custom multipath hash tests\"\n\n\tsysctl_set net.ipv4.fib_multipath_hash_policy 3\n\n\t# Prevent the neighbour table from overflowing, as different neighbour\n\t# entries will be created on $ol4 when using different destination IPs.\n\tsysctl_set net.ipv4.neigh.default.gc_thresh1 1024\n\tsysctl_set net.ipv4.neigh.default.gc_thresh2 1024\n\tsysctl_set net.ipv4.neigh.default.gc_thresh3 1024\n\n\tsysctl_set net.ipv4.fib_multipath_hash_fields 0x0001\n\tcustom_hash_test \"Source IP\" \"balanced\" send_src_ipv4\n\tcustom_hash_test \"Source IP\" \"unbalanced\" send_dst_ipv4\n\n\tsysctl_set net.ipv4.fib_multipath_hash_fields 0x0002\n\tcustom_hash_test \"Destination IP\" \"balanced\" send_dst_ipv4\n\tcustom_hash_test \"Destination IP\" \"unbalanced\" send_src_ipv4\n\n\tsysctl_set net.ipv4.fib_multipath_hash_fields 0x0010\n\tcustom_hash_test \"Source port\" \"balanced\" send_src_udp4\n\tcustom_hash_test \"Source port\" \"unbalanced\" send_dst_udp4\n\n\tsysctl_set net.ipv4.fib_multipath_hash_fields 0x0020\n\tcustom_hash_test \"Destination port\" \"balanced\" send_dst_udp4\n\tcustom_hash_test \"Destination port\" \"unbalanced\" send_src_udp4\n\n\tsysctl_restore net.ipv4.neigh.default.gc_thresh3\n\tsysctl_restore net.ipv4.neigh.default.gc_thresh2\n\tsysctl_restore net.ipv4.neigh.default.gc_thresh1\n\n\tsysctl_restore net.ipv4.fib_multipath_hash_policy\n}\n\ncustom_hash_v6()\n{\n\tlog_info \"Running IPv6 custom multipath hash tests\"\n\n\tsysctl_set net.ipv6.fib_multipath_hash_policy 3\n\n\t# Prevent the neighbour table from overflowing, as different neighbour\n\t# entries will be created on $ol4 when using different destination IPs.\n\tsysctl_set net.ipv6.neigh.default.gc_thresh1 1024\n\tsysctl_set net.ipv6.neigh.default.gc_thresh2 1024\n\tsysctl_set net.ipv6.neigh.default.gc_thresh3 1024\n\n\tsysctl_set net.ipv6.fib_multipath_hash_fields 0x0001\n\tcustom_hash_test \"Source IP\" \"balanced\" send_src_ipv6\n\tcustom_hash_test \"Source IP\" \"unbalanced\" send_dst_ipv6\n\n\tsysctl_set net.ipv6.fib_multipath_hash_fields 0x0002\n\tcustom_hash_test \"Destination IP\" \"balanced\" send_dst_ipv6\n\tcustom_hash_test \"Destination IP\" \"unbalanced\" send_src_ipv6\n\n\tsysctl_set net.ipv6.fib_multipath_hash_fields 0x0008\n\tcustom_hash_test \"Flowlabel\" \"balanced\" send_flowlabel\n\tcustom_hash_test \"Flowlabel\" \"unbalanced\" send_src_ipv6\n\n\tsysctl_set net.ipv6.fib_multipath_hash_fields 0x0010\n\tcustom_hash_test \"Source port\" \"balanced\" send_src_udp6\n\tcustom_hash_test \"Source port\" \"unbalanced\" send_dst_udp6\n\n\tsysctl_set net.ipv6.fib_multipath_hash_fields 0x0020\n\tcustom_hash_test \"Destination port\" \"balanced\" send_dst_udp6\n\tcustom_hash_test \"Destination port\" \"unbalanced\" send_src_udp6\n\n\tsysctl_restore net.ipv6.neigh.default.gc_thresh3\n\tsysctl_restore net.ipv6.neigh.default.gc_thresh2\n\tsysctl_restore net.ipv6.neigh.default.gc_thresh1\n\n\tsysctl_restore net.ipv6.fib_multipath_hash_policy\n}\n\ncustom_hash()\n{\n\t# Test that when the hash policy is set to custom, traffic is\n\t# distributed only according to the fields set in the\n\t# fib_multipath_hash_fields sysctl.\n\t#\n\t# Each time set a different field and make sure traffic is only\n\t# distributed when the field is changed in the packet stream.\n\tcustom_hash_v4\n\tcustom_hash_v6\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}