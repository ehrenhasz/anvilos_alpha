{
  "module_name": "mirror_gre_bridge_1q_lag.sh",
  "hash_id": "b86257ede009fbf5a1027c680ef889acca2def885d65b39d51b9219ca7eeeb32",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_bridge_1q_lag.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Test for \"tc action mirred egress mirror\" when the underlay route points at a\n# bridge device with vlan filtering (802.1q), and the egress device is a team\n# device.\n#\n# +----------------------+                             +----------------------+\n# | H1                   |                             |                   H2 |\n# |     + $h1.333        |                             |        $h1.555 +     |\n# |     | 192.0.2.1/28   |                             |  192.0.2.18/28 |     |\n# +-----|----------------+                             +----------------|-----+\n#       |                               $h1                             |\n#       +--------------------------------+------------------------------+\n#                                        |\n# +--------------------------------------|------------------------------------+\n# | SW                                   o---> mirror                         |\n# |                                      |                                    |\n# |     +--------------------------------+------------------------------+     |\n# |     |                              $swp1                            |     |\n# |     + $swp1.333                                           $swp1.555 +     |\n# |       192.0.2.2/28                                    192.0.2.17/28       |\n# |                                                                           |\n# | +-----------------------------------------------------------------------+ |\n# | |                        BR1 (802.1q)                                   | |\n# | |     + lag (team)       192.0.2.129/28                                 | |\n# | |    / \\                 2001:db8:2::1/64                               | |\n# | +---/---\\---------------------------------------------------------------+ |\n# |    /     \\                                                            ^   |\n# |   |       \\                                        + gt4 (gretap)     |   |\n# |   |        \\                                         loc=192.0.2.129  |   |\n# |   |         \\                                        rem=192.0.2.130 -+   |\n# |   |          \\                                       ttl=100              |\n# |   |           \\                                      tos=inherit          |\n# |   |            \\                                                          |\n# |   |             \\_________________________________                        |\n# |   |                                               \\                       |\n# |   + $swp3                                          + $swp4                |\n# +---|------------------------------------------------|----------------------+\n#     |                                                |\n# +---|----------------------+                     +---|----------------------+\n# |   + $h3               H3 |                     |   + $h4               H4 |\n# |     192.0.2.130/28       |                     |     192.0.2.130/28       |\n# |     2001:db8:2::2/64     |                     |     2001:db8:2::2/64     |\n# +--------------------------+                     +--------------------------+\n\nALL_TESTS=\"\n\ttest_mirror_gretap_first\n\ttest_mirror_gretap_second\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\n\nrequire_command $ARPING\n\nvlan_host_create()\n{\n\tlocal if_name=$1; shift\n\tlocal vid=$1; shift\n\tlocal vrf_name=$1; shift\n\tlocal ips=(\"${@}\")\n\n\tvrf_create $vrf_name\n\tip link set dev $vrf_name up\n\tvlan_create $if_name $vid $vrf_name \"${ips[@]}\"\n}\n\nvlan_host_destroy()\n{\n\tlocal if_name=$1; shift\n\tlocal vid=$1; shift\n\tlocal vrf_name=$1; shift\n\n\tvlan_destroy $if_name $vid\n\tip link set dev $vrf_name down\n\tvrf_destroy $vrf_name\n}\n\nh1_create()\n{\n\tvlan_host_create $h1 333 vrf-h1 192.0.2.1/28\n\tip -4 route add 192.0.2.16/28 vrf vrf-h1 nexthop via 192.0.2.2\n}\n\nh1_destroy()\n{\n\tip -4 route del 192.0.2.16/28 vrf vrf-h1\n\tvlan_host_destroy $h1 333 vrf-h1\n}\n\nh2_create()\n{\n\tvlan_host_create $h1 555 vrf-h2 192.0.2.18/28\n\tip -4 route add 192.0.2.0/28 vrf vrf-h2 nexthop via 192.0.2.17\n}\n\nh2_destroy()\n{\n\tip -4 route del 192.0.2.0/28 vrf vrf-h2\n\tvlan_host_destroy $h1 555 vrf-h2\n}\n\nh3_create()\n{\n\tsimple_if_init $h3 192.0.2.130/28\n\ttc qdisc add dev $h3 clsact\n}\n\nh3_destroy()\n{\n\ttc qdisc del dev $h3 clsact\n\tsimple_if_fini $h3 192.0.2.130/28\n}\n\nh4_create()\n{\n\tsimple_if_init $h4 192.0.2.130/28\n\ttc qdisc add dev $h4 clsact\n}\n\nh4_destroy()\n{\n\ttc qdisc del dev $h4 clsact\n\tsimple_if_fini $h4 192.0.2.130/28\n}\n\nswitch_create()\n{\n\tip link set dev $swp1 up\n\ttc qdisc add dev $swp1 clsact\n\tvlan_create $swp1 333 \"\" 192.0.2.2/28\n\tvlan_create $swp1 555 \"\" 192.0.2.17/28\n\n\ttunnel_create gt4 gretap 192.0.2.129 192.0.2.130 \\\n\t\t      ttl 100 tos inherit\n\n\tip link set dev $swp3 up\n\tip link set dev $swp4 up\n\n\tip link add name br1 address $(mac_get $swp3) \\\n\t\ttype bridge vlan_filtering 1\n\n\tteam_create lag loadbalance $swp3 $swp4\n\tip link set dev lag master br1\n\n\tip link set dev br1 up\n\t__addr_add_del br1 add 192.0.2.129/32\n\tip -4 route add 192.0.2.130/32 dev br1\n}\n\nswitch_destroy()\n{\n\tip link set dev lag nomaster\n\tteam_destroy lag\n\n\tip -4 route del 192.0.2.130/32 dev br1\n\t__addr_add_del br1 del 192.0.2.129/32\n\tip link set dev br1 down\n\tip link del dev br1\n\n\tip link set dev $swp4 down\n\tip link set dev $swp3 down\n\n\ttunnel_destroy gt4\n\n\tvlan_destroy $swp1 555\n\tvlan_destroy $swp1 333\n\ttc qdisc del dev $swp1 clsact\n\tip link set dev $swp1 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp3=${NETIFS[p3]}\n\th3=${NETIFS[p4]}\n\n\tswp4=${NETIFS[p5]}\n\th4=${NETIFS[p6]}\n\n\tvrf_prepare\n\n\tip link set dev $h1 up\n\th1_create\n\th2_create\n\th3_create\n\th4_create\n\tswitch_create\n\n\tforwarding_enable\n\n\ttrap_install $h3 ingress\n\ttrap_install $h4 ingress\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\ttrap_uninstall $h4 ingress\n\ttrap_uninstall $h3 ingress\n\n\tforwarding_restore\n\n\tswitch_destroy\n\th4_destroy\n\th3_destroy\n\th2_destroy\n\th1_destroy\n\tip link set dev $h1 down\n\n\tvrf_cleanup\n}\n\ntest_lag_slave()\n{\n\tlocal host_dev=$1; shift\n\tlocal up_dev=$1; shift\n\tlocal down_dev=$1; shift\n\tlocal what=$1; shift\n\n\tRET=0\n\n\ttc filter add dev $swp1 ingress pref 999 \\\n\t\tproto 802.1q flower vlan_ethtype arp $tcflags \\\n\t\taction pass\n\tmirror_install $swp1 ingress gt4 \\\n\t\t\"proto 802.1q flower vlan_id 333 $tcflags\"\n\n\t# Test connectivity through $up_dev when $down_dev is set down.\n\tip link set dev $down_dev down\n\tip neigh flush dev br1\n\tsetup_wait_dev $up_dev\n\tsetup_wait_dev $host_dev\n\t$ARPING -I br1 192.0.2.130 -qfc 1\n\tsleep 2\n\tmirror_test vrf-h1 192.0.2.1 192.0.2.18 $host_dev 1 10\n\n\t# Test lack of connectivity when both slaves are down.\n\tip link set dev $up_dev down\n\tsleep 2\n\tmirror_test vrf-h1 192.0.2.1 192.0.2.18 $h3 1 0\n\tmirror_test vrf-h1 192.0.2.1 192.0.2.18 $h4 1 0\n\n\tip link set dev $up_dev up\n\tip link set dev $down_dev up\n\tmirror_uninstall $swp1 ingress\n\ttc filter del dev $swp1 ingress pref 999\n\n\tlog_test \"$what ($tcflags)\"\n}\n\ntest_mirror_gretap_first()\n{\n\ttest_lag_slave $h3 $swp3 $swp4 \"mirror to gretap: LAG first slave\"\n}\n\ntest_mirror_gretap_second()\n{\n\ttest_lag_slave $h4 $swp4 $swp3 \"mirror to gretap: LAG second slave\"\n}\n\ntest_all()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntest_all\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttest_all\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}