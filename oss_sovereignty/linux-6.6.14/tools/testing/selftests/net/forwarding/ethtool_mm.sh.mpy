{
  "module_name": "ethtool_mm.sh",
  "hash_id": "45e50463ac1c191649b0f11fbf4494009510422523974d462d9621f36af5201a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/ethtool_mm.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nALL_TESTS=\"\n\tmanual_with_verification_h1_to_h2\n\tmanual_with_verification_h2_to_h1\n\tmanual_without_verification_h1_to_h2\n\tmanual_without_verification_h2_to_h1\n\tmanual_failed_verification_h1_to_h2\n\tmanual_failed_verification_h2_to_h1\n\tlldp\n\"\n\nNUM_NETIFS=2\nREQUIRE_MZ=no\nPREEMPTIBLE_PRIO=0\nsource lib.sh\n\ntraffic_test()\n{\n\tlocal if=$1; shift\n\tlocal src=$1; shift\n\tlocal num_pkts=10000\n\tlocal before=\n\tlocal after=\n\tlocal delta=\n\n\tbefore=$(ethtool_std_stats_get $if \"eth-mac\" \"FramesTransmittedOK\" $src)\n\n\t$MZ $if -q -c $num_pkts -p 64 -b bcast -t ip -R $PREEMPTIBLE_PRIO\n\n\tafter=$(ethtool_std_stats_get $if \"eth-mac\" \"FramesTransmittedOK\" $src)\n\n\tdelta=$((after - before))\n\n\t# Allow an extra 1% tolerance for random packets sent by the stack\n\t[ $delta -ge $num_pkts ] && [ $delta -le $((num_pkts + 100)) ]\n}\n\nmanual_with_verification()\n{\n\tlocal tx=$1; shift\n\tlocal rx=$1; shift\n\n\tRET=0\n\n\t# It isn't completely clear from IEEE 802.3-2018 Figure 99-5: Transmit\n\t# Processing state diagram whether the \"send_r\" variable (send response\n\t# to verification frame) should be taken into consideration while the\n\t# MAC Merge TX direction is disabled. That being said, at least the\n\t# NXP ENETC does not, and requires tx-enabled on in order to respond to\n\t# the link partner's verification frames.\n\tethtool --set-mm $rx tx-enabled on\n\tethtool --set-mm $tx verify-enabled on tx-enabled on\n\n\t# Wait for verification to finish\n\tsleep 1\n\n\tethtool --json --show-mm $tx | jq -r '.[].\"verify-status\"' | \\\n\t\tgrep -q 'SUCCEEDED'\n\tcheck_err \"$?\" \"Verification did not succeed\"\n\n\tethtool --json --show-mm $tx | jq -r '.[].\"tx-active\"' | grep -q 'true'\n\tcheck_err \"$?\" \"pMAC TX is not active\"\n\n\ttraffic_test $tx \"pmac\"\n\tcheck_err \"$?\" \"Traffic did not get sent through $tx's pMAC\"\n\n\tethtool --set-mm $tx verify-enabled off tx-enabled off\n\tethtool --set-mm $rx tx-enabled off\n\n\tlog_test \"Manual configuration with verification: $tx to $rx\"\n}\n\nmanual_with_verification_h1_to_h2()\n{\n\tmanual_with_verification $h1 $h2\n}\n\nmanual_with_verification_h2_to_h1()\n{\n\tmanual_with_verification $h2 $h1\n}\n\nmanual_without_verification()\n{\n\tlocal tx=$1; shift\n\tlocal rx=$1; shift\n\n\tRET=0\n\n\tethtool --set-mm $tx verify-enabled off tx-enabled on\n\n\tethtool --json --show-mm $tx | jq -r '.[].\"verify-status\"' | \\\n\t\tgrep -q 'DISABLED'\n\tcheck_err \"$?\" \"Verification is not disabled\"\n\n\tethtool --json --show-mm $tx | jq -r '.[].\"tx-active\"' | grep -q 'true'\n\tcheck_err \"$?\" \"pMAC TX is not active\"\n\n\ttraffic_test $tx \"pmac\"\n\tcheck_err \"$?\" \"Traffic did not get sent through $tx's pMAC\"\n\n\tethtool --set-mm $tx verify-enabled off tx-enabled off\n\n\tlog_test \"Manual configuration without verification: $tx to $rx\"\n}\n\nmanual_without_verification_h1_to_h2()\n{\n\tmanual_without_verification $h1 $h2\n}\n\nmanual_without_verification_h2_to_h1()\n{\n\tmanual_without_verification $h2 $h1\n}\n\nmanual_failed_verification()\n{\n\tlocal tx=$1; shift\n\tlocal rx=$1; shift\n\n\tRET=0\n\n\tethtool --set-mm $rx pmac-enabled off\n\tethtool --set-mm $tx verify-enabled on tx-enabled on\n\n\t# Wait for verification to time out\n\tsleep 1\n\n\tethtool --json --show-mm $tx | jq -r '.[].\"verify-status\"' | \\\n\t\tgrep -q 'SUCCEEDED'\n\tcheck_fail \"$?\" \"Verification succeeded when it shouldn't have\"\n\n\tethtool --json --show-mm $tx | jq -r '.[].\"tx-active\"' | grep -q 'true'\n\tcheck_fail \"$?\" \"pMAC TX is active when it shouldn't have\"\n\n\ttraffic_test $tx \"emac\"\n\tcheck_err \"$?\" \"Traffic did not get sent through $tx's eMAC\"\n\n\tethtool --set-mm $tx verify-enabled off tx-enabled off\n\tethtool --set-mm $rx pmac-enabled on\n\n\tlog_test \"Manual configuration with failed verification: $tx to $rx\"\n}\n\nmanual_failed_verification_h1_to_h2()\n{\n\tmanual_failed_verification $h1 $h2\n}\n\nmanual_failed_verification_h2_to_h1()\n{\n\tmanual_failed_verification $h2 $h1\n}\n\nlldp_change_add_frag_size()\n{\n\tlocal add_frag_size=$1\n\n\tlldptool -T -i $h1 -V addEthCaps addFragSize=$add_frag_size >/dev/null\n\t# Wait for TLVs to be received\n\tsleep 2\n\tlldptool -i $h2 -t -n -V addEthCaps | \\\n\t\tgrep -q \"Additional fragment size: $add_frag_size\"\n}\n\nlldp()\n{\n\tRET=0\n\n\tsystemctl start lldpad\n\n\t# Configure the interfaces to receive and transmit LLDPDUs\n\tlldptool -L -i $h1 adminStatus=rxtx >/dev/null\n\tlldptool -L -i $h2 adminStatus=rxtx >/dev/null\n\n\t# Enable the transmission of Additional Ethernet Capabilities TLV\n\tlldptool -T -i $h1 -V addEthCaps enableTx=yes >/dev/null\n\tlldptool -T -i $h2 -V addEthCaps enableTx=yes >/dev/null\n\n\t# Wait for TLVs to be received\n\tsleep 2\n\n\tlldptool -i $h1 -t -n -V addEthCaps | \\\n\t\tgrep -q \"Preemption capability active\"\n\tcheck_err \"$?\" \"$h1 pMAC TX is not active\"\n\n\tlldptool -i $h2 -t -n -V addEthCaps | \\\n\t\tgrep -q \"Preemption capability active\"\n\tcheck_err \"$?\" \"$h2 pMAC TX is not active\"\n\n\tlldp_change_add_frag_size 3\n\tcheck_err \"$?\" \"addFragSize 3\"\n\n\tlldp_change_add_frag_size 2\n\tcheck_err \"$?\" \"addFragSize 2\"\n\n\tlldp_change_add_frag_size 1\n\tcheck_err \"$?\" \"addFragSize 1\"\n\n\tlldp_change_add_frag_size 0\n\tcheck_err \"$?\" \"addFragSize 0\"\n\n\ttraffic_test $h1 \"pmac\"\n\tcheck_err \"$?\" \"Traffic did not get sent through $h1's pMAC\"\n\n\ttraffic_test $h2 \"pmac\"\n\tcheck_err \"$?\" \"Traffic did not get sent through $h2's pMAC\"\n\n\tsystemctl stop lldpad\n\n\tlog_test \"LLDP\"\n}\n\nh1_create()\n{\n\tip link set dev $h1 up\n\n\ttc qdisc add dev $h1 root mqprio num_tc 4 map 0 1 2 3 \\\n\t\tqueues 1@0 1@1 1@2 1@3 \\\n\t\tfp P E E E \\\n\t\thw 1\n\n\tethtool --set-mm $h1 pmac-enabled on tx-enabled off verify-enabled off\n}\n\nh2_create()\n{\n\tip link set dev $h2 up\n\n\tethtool --set-mm $h2 pmac-enabled on tx-enabled off verify-enabled off\n\n\ttc qdisc add dev $h2 root mqprio num_tc 4 map 0 1 2 3 \\\n\t\tqueues 1@0 1@1 1@2 1@3 \\\n\t\tfp P E E E \\\n\t\thw 1\n}\n\nh1_destroy()\n{\n\tethtool --set-mm $h1 pmac-enabled off tx-enabled off verify-enabled off\n\n\ttc qdisc del dev $h1 root\n\n\tip link set dev $h1 down\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 root\n\n\tethtool --set-mm $h2 pmac-enabled off tx-enabled off verify-enabled off\n\n\tip link set dev $h2 down\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\th2=${NETIFS[p2]}\n\n\th1_create\n\th2_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\th2_destroy\n\th1_destroy\n}\n\ncheck_ethtool_mm_support\ncheck_tc_fp_support\nrequire_command lldptool\nbail_on_lldpad \"autoconfigure the MAC Merge layer\" \"configure it manually\"\n\nfor netif in ${NETIFS[@]}; do\n\tethtool --show-mm $netif 2>&1 &> /dev/null\n\tif [[ $? -ne 0 ]]; then\n\t\techo \"SKIP: $netif does not support MAC Merge\"\n\t\texit $ksft_skip\n\tfi\ndone\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}