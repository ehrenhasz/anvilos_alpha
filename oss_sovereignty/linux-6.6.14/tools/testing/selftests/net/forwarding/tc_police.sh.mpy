{
  "module_name": "tc_police.sh",
  "hash_id": "40a29e3201feafa67fd9084b5df01de21e85ee4076c6e5c4bfbc26e982b9afbe",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/tc_police.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test tc-police action.\n#\n# +---------------------------------+\n# | H1 (vrf)                        |\n# |    + $h1                        |\n# |    | 192.0.2.1/24               |\n# |    |                            |\n# |    |  default via 192.0.2.2     |\n# +----|----------------------------+\n#      |\n# +----|----------------------------------------------------------------------+\n# | SW |                                                                      |\n# |    + $rp1                                                                 |\n# |        192.0.2.2/24                                                       |\n# |                                                                           |\n# |        198.51.100.2/24                           203.0.113.2/24           |\n# |    + $rp2                                    + $rp3                       |\n# |    |                                         |                            |\n# +----|-----------------------------------------|----------------------------+\n#      |                                         |\n# +----|----------------------------+       +----|----------------------------+\n# |    |  default via 198.51.100.2  |       |    |  default via 203.0.113.2   |\n# |    |                            |       |    |                            |\n# |    | 198.51.100.1/24            |       |    | 203.0.113.1/24             |\n# |    + $h2                        |       |    + $h3                        |\n# | H2 (vrf)                        |       | H3 (vrf)                        |\n# +---------------------------------+       +---------------------------------+\n\nALL_TESTS=\"\n\tpolice_rx_test\n\tpolice_tx_test\n\tpolice_shared_test\n\tpolice_rx_mirror_test\n\tpolice_tx_mirror_test\n\tpolice_pps_rx_test\n\tpolice_pps_tx_test\n\tpolice_mtu_rx_test\n\tpolice_mtu_tx_test\n\"\nNUM_NETIFS=6\nsource tc_common.sh\nsource lib.sh\n\nh1_create()\n{\n\tsimple_if_init $h1 192.0.2.1/24\n\n\tip -4 route add default vrf v$h1 nexthop via 192.0.2.2\n}\n\nh1_destroy()\n{\n\tip -4 route del default vrf v$h1 nexthop via 192.0.2.2\n\n\tsimple_if_fini $h1 192.0.2.1/24\n}\n\nh2_create()\n{\n\tsimple_if_init $h2 198.51.100.1/24\n\n\tip -4 route add default vrf v$h2 nexthop via 198.51.100.2\n\n\ttc qdisc add dev $h2 clsact\n}\n\nh2_destroy()\n{\n\ttc qdisc del dev $h2 clsact\n\n\tip -4 route del default vrf v$h2 nexthop via 198.51.100.2\n\n\tsimple_if_fini $h2 198.51.100.1/24\n}\n\nh3_create()\n{\n\tsimple_if_init $h3 203.0.113.1/24\n\n\tip -4 route add default vrf v$h3 nexthop via 203.0.113.2\n\n\ttc qdisc add dev $h3 clsact\n}\n\nh3_destroy()\n{\n\ttc qdisc del dev $h3 clsact\n\n\tip -4 route del default vrf v$h3 nexthop via 203.0.113.2\n\n\tsimple_if_fini $h3 203.0.113.1/24\n}\n\nrouter_create()\n{\n\tip link set dev $rp1 up\n\tip link set dev $rp2 up\n\tip link set dev $rp3 up\n\n\t__addr_add_del $rp1 add 192.0.2.2/24\n\t__addr_add_del $rp2 add 198.51.100.2/24\n\t__addr_add_del $rp3 add 203.0.113.2/24\n\n\ttc qdisc add dev $rp1 clsact\n\ttc qdisc add dev $rp2 clsact\n}\n\nrouter_destroy()\n{\n\ttc qdisc del dev $rp2 clsact\n\ttc qdisc del dev $rp1 clsact\n\n\t__addr_add_del $rp3 del 203.0.113.2/24\n\t__addr_add_del $rp2 del 198.51.100.2/24\n\t__addr_add_del $rp1 del 192.0.2.2/24\n\n\tip link set dev $rp3 down\n\tip link set dev $rp2 down\n\tip link set dev $rp1 down\n}\n\npolice_common_test()\n{\n\tlocal test_name=$1; shift\n\n\tRET=0\n\n\t# Rule to measure bandwidth on ingress of $h2\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction drop\n\n\tmausezahn $h1 -a own -b $(mac_get $rp1) -A 192.0.2.1 -B 198.51.100.1 \\\n\t\t-t udp sp=12345,dp=54321 -p 1000 -c 0 -q &\n\n\tlocal t0=$(tc_rule_stats_get $h2 1 ingress .bytes)\n\tsleep 10\n\tlocal t1=$(tc_rule_stats_get $h2 1 ingress .bytes)\n\n\tlocal er=$((80 * 1000 * 1000))\n\tlocal nr=$(rate $t0 $t1 10)\n\tlocal nr_pct=$((100 * (nr - er) / er))\n\t((-10 <= nr_pct && nr_pct <= 10))\n\tcheck_err $? \"Expected rate $(humanize $er), got $(humanize $nr), which is $nr_pct% off. Required accuracy is +-10%.\"\n\n\tlog_test \"$test_name\"\n\n\t{ kill %% && wait %%; } 2>/dev/null\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n}\n\npolice_rx_test()\n{\n\t# Rule to police traffic destined to $h2 on ingress of $rp1\n\ttc filter add dev $rp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police rate 80mbit burst 16k conform-exceed drop/ok\n\n\tpolice_common_test \"police on rx\"\n\n\ttc filter del dev $rp1 ingress protocol ip pref 1 handle 101 flower\n}\n\npolice_tx_test()\n{\n\t# Rule to police traffic destined to $h2 on egress of $rp2\n\ttc filter add dev $rp2 egress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police rate 80mbit burst 16k conform-exceed drop/ok\n\n\tpolice_common_test \"police on tx\"\n\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n}\n\npolice_shared_common_test()\n{\n\tlocal dport=$1; shift\n\tlocal test_name=$1; shift\n\n\tRET=0\n\n\tmausezahn $h1 -a own -b $(mac_get $rp1) -A 192.0.2.1 -B 198.51.100.1 \\\n\t\t-t udp sp=12345,dp=$dport -p 1000 -c 0 -q &\n\n\tlocal t0=$(tc_rule_stats_get $h2 1 ingress .bytes)\n\tsleep 10\n\tlocal t1=$(tc_rule_stats_get $h2 1 ingress .bytes)\n\n\tlocal er=$((80 * 1000 * 1000))\n\tlocal nr=$(rate $t0 $t1 10)\n\tlocal nr_pct=$((100 * (nr - er) / er))\n\t((-10 <= nr_pct && nr_pct <= 10))\n\tcheck_err $? \"Expected rate $(humanize $er), got $(humanize $nr), which is $nr_pct% off. Required accuracy is +-10%.\"\n\n\tlog_test \"$test_name\"\n\n\t{ kill %% && wait %%; } 2>/dev/null\n}\n\npolice_shared_test()\n{\n\t# Rule to measure bandwidth on ingress of $h2\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp src_port 12345 \\\n\t\taction drop\n\n\t# Rule to police traffic destined to $h2 on ingress of $rp1\n\ttc filter add dev $rp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police rate 80mbit burst 16k conform-exceed drop/ok \\\n\t\tindex 10\n\n\t# Rule to police a different flow destined to $h2 on egress of $rp2\n\t# using same policer\n\ttc filter add dev $rp2 egress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 22222 \\\n\t\taction police index 10\n\n\tpolice_shared_common_test 54321 \"police with shared policer - rx\"\n\n\tpolice_shared_common_test 22222 \"police with shared policer - tx\"\n\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $rp1 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n}\n\npolice_mirror_common_test()\n{\n\tlocal pol_if=$1; shift\n\tlocal dir=$1; shift\n\tlocal test_name=$1; shift\n\n\tRET=0\n\n\t# Rule to measure bandwidth on ingress of $h2\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction drop\n\n\t# Rule to measure bandwidth of mirrored traffic on ingress of $h3\n\ttc filter add dev $h3 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction drop\n\n\t# Rule to police traffic destined to $h2 and mirror to $h3\n\ttc filter add dev $pol_if $dir protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police rate 80mbit burst 16k conform-exceed drop/pipe \\\n\t\taction mirred egress mirror dev $rp3\n\n\tmausezahn $h1 -a own -b $(mac_get $rp1) -A 192.0.2.1 -B 198.51.100.1 \\\n\t\t-t udp sp=12345,dp=54321 -p 1000 -c 0 -q &\n\n\tlocal t0=$(tc_rule_stats_get $h2 1 ingress .bytes)\n\tsleep 10\n\tlocal t1=$(tc_rule_stats_get $h2 1 ingress .bytes)\n\n\tlocal er=$((80 * 1000 * 1000))\n\tlocal nr=$(rate $t0 $t1 10)\n\tlocal nr_pct=$((100 * (nr - er) / er))\n\t((-10 <= nr_pct && nr_pct <= 10))\n\tcheck_err $? \"Expected rate $(humanize $er), got $(humanize $nr), which is $nr_pct% off. Required accuracy is +-10%.\"\n\n\tlocal t0=$(tc_rule_stats_get $h3 1 ingress .bytes)\n\tsleep 10\n\tlocal t1=$(tc_rule_stats_get $h3 1 ingress .bytes)\n\n\tlocal er=$((80 * 1000 * 1000))\n\tlocal nr=$(rate $t0 $t1 10)\n\tlocal nr_pct=$((100 * (nr - er) / er))\n\t((-10 <= nr_pct && nr_pct <= 10))\n\tcheck_err $? \"Expected rate $(humanize $er), got $(humanize $nr), which is $nr_pct% off. Required accuracy is +-10%.\"\n\n\tlog_test \"$test_name\"\n\n\t{ kill %% && wait %%; } 2>/dev/null\n\ttc filter del dev $pol_if $dir protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h3 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n}\n\npolice_rx_mirror_test()\n{\n\tpolice_mirror_common_test $rp1 ingress \"police rx and mirror\"\n}\n\npolice_tx_mirror_test()\n{\n\tpolice_mirror_common_test $rp2 egress \"police tx and mirror\"\n}\n\npolice_pps_common_test()\n{\n\tlocal test_name=$1; shift\n\n\tRET=0\n\n\t# Rule to measure bandwidth on ingress of $h2\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction drop\n\n\tmausezahn $h1 -a own -b $(mac_get $rp1) -A 192.0.2.1 -B 198.51.100.1 \\\n\t\t-t udp sp=12345,dp=54321 -p 1000 -c 0 -q &\n\n\tlocal t0=$(tc_rule_stats_get $h2 1 ingress .packets)\n\tsleep 10\n\tlocal t1=$(tc_rule_stats_get $h2 1 ingress .packets)\n\n\tlocal er=$((2000))\n\tlocal nr=$(packets_rate $t0 $t1 10)\n\tlocal nr_pct=$((100 * (nr - er) / er))\n\t((-10 <= nr_pct && nr_pct <= 10))\n\tcheck_err $? \"Expected rate $(humanize $er), got $(humanize $nr), which is $nr_pct% off. Required accuracy is +-10%.\"\n\n\tlog_test \"$test_name\"\n\n\t{ kill %% && wait %%; } 2>/dev/null\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n}\n\npolice_pps_rx_test()\n{\n\t# Rule to police traffic destined to $h2 on ingress of $rp1\n\ttc filter add dev $rp1 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police pkts_rate 2000 pkts_burst 400 conform-exceed drop/ok\n\n\tpolice_pps_common_test \"police pps on rx\"\n\n\ttc filter del dev $rp1 ingress protocol ip pref 1 handle 101 flower\n}\n\npolice_pps_tx_test()\n{\n\t# Rule to police traffic destined to $h2 on egress of $rp2\n\ttc filter add dev $rp2 egress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police pkts_rate 2000 pkts_burst 400 conform-exceed drop/ok\n\n\tpolice_pps_common_test \"police pps on tx\"\n\n\ttc filter del dev $rp2 egress protocol ip pref 1 handle 101 flower\n}\n\npolice_mtu_common_test() {\n\tRET=0\n\n\tlocal test_name=$1; shift\n\tlocal dev=$1; shift\n\tlocal direction=$1; shift\n\n\ttc filter add dev $dev $direction protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction police mtu 1042 conform-exceed drop/ok\n\n\t# to count \"conform\" packets\n\ttc filter add dev $h2 ingress protocol ip pref 1 handle 101 flower \\\n\t\tdst_ip 198.51.100.1 ip_proto udp dst_port 54321 \\\n\t\taction drop\n\n\tmausezahn $h1 -a own -b $(mac_get $rp1) -A 192.0.2.1 -B 198.51.100.1 \\\n\t\t-t udp sp=12345,dp=54321 -p 1001 -c 10 -q\n\n\tmausezahn $h1 -a own -b $(mac_get $rp1) -A 192.0.2.1 -B 198.51.100.1 \\\n\t\t-t udp sp=12345,dp=54321 -p 1000 -c 3 -q\n\n\ttc_check_packets \"dev $dev $direction\" 101 13\n\tcheck_err $? \"wrong packet counter\"\n\n\t# \"exceed\" packets\n\tlocal overlimits_t0=$(tc_rule_stats_get ${dev} 1 ${direction} .overlimits)\n\ttest ${overlimits_t0} = 10\n\tcheck_err $? \"wrong overlimits, expected 10 got ${overlimits_t0}\"\n\n\t# \"conform\" packets\n\ttc_check_packets \"dev $h2 ingress\" 101 3\n\tcheck_err $? \"forwarding error\"\n\n\ttc filter del dev $h2 ingress protocol ip pref 1 handle 101 flower\n\ttc filter del dev $dev $direction protocol ip pref 1 handle 101 flower\n\n\tlog_test \"$test_name\"\n}\n\npolice_mtu_rx_test()\n{\n\tpolice_mtu_common_test \"police mtu (rx)\" $rp1 ingress\n}\n\npolice_mtu_tx_test()\n{\n\tpolice_mtu_common_test \"police mtu (tx)\" $rp2 egress\n}\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\trp1=${NETIFS[p2]}\n\n\trp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\trp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tvrf_prepare\n\tforwarding_enable\n\n\th1_create\n\th2_create\n\th3_create\n\trouter_create\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\trouter_destroy\n\th3_destroy\n\th2_destroy\n\th1_destroy\n\n\tforwarding_restore\n\tvrf_cleanup\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntests_run\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}