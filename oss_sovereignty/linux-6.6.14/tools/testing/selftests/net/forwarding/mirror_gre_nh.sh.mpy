{
  "module_name": "mirror_gre_nh.sh",
  "hash_id": "33c088724d4615556279d4195893b0f872b5c3a865d0451b2de8e07c6b3800b5",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/forwarding/mirror_gre_nh.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test uses standard topology for testing gretap. See\n# mirror_gre_topo_lib.sh for more details.\n#\n# Test that gretap and ip6gretap mirroring works when the other tunnel endpoint\n# is reachable through a next-hop route (as opposed to directly-attached route).\n\nALL_TESTS=\"\n\ttest_gretap\n\ttest_ip6gretap\n\"\n\nNUM_NETIFS=6\nsource lib.sh\nsource mirror_lib.sh\nsource mirror_gre_lib.sh\nsource mirror_gre_topo_lib.sh\n\nsetup_prepare()\n{\n\th1=${NETIFS[p1]}\n\tswp1=${NETIFS[p2]}\n\n\tswp2=${NETIFS[p3]}\n\th2=${NETIFS[p4]}\n\n\tswp3=${NETIFS[p5]}\n\th3=${NETIFS[p6]}\n\n\tsysctl_set net.ipv4.conf.all.rp_filter 0\n\tsysctl_set net.ipv4.conf.$h3.rp_filter 0\n\n\tvrf_prepare\n\tmirror_gre_topo_create\n\n\tsysctl_set net.ipv4.conf.v$h3.rp_filter 0\n\n\tip address add dev $swp3 192.0.2.161/28\n\tip address add dev $h3 192.0.2.162/28\n\tip address add dev gt4 192.0.2.129/32\n\tip address add dev h3-gt4 192.0.2.130/32\n\n\t# IPv6 route can't be added after address. Such routes are rejected due\n\t# to the gateway address having been configured on the local system. It\n\t# works the other way around though.\n\tip address add dev $swp3 2001:db8:4::1/64\n\tip -6 route add 2001:db8:2::2/128 via 2001:db8:4::2\n\tip address add dev $h3 2001:db8:4::2/64\n\tip address add dev gt6 2001:db8:2::1\n\tip address add dev h3-gt6 2001:db8:2::2\n}\n\ncleanup()\n{\n\tpre_cleanup\n\n\tip -6 route del 2001:db8:2::2/128 via 2001:db8:4::2\n\tip address del dev $h3 2001:db8:4::2/64\n\tip address del dev $swp3 2001:db8:4::1/64\n\n\tip address del dev $h3 192.0.2.162/28\n\tip address del dev $swp3 192.0.2.161/28\n\n\tsysctl_restore net.ipv4.conf.v$h3.rp_filter 0\n\n\tmirror_gre_topo_destroy\n\tvrf_cleanup\n\n\tsysctl_restore net.ipv4.conf.$h3.rp_filter\n\tsysctl_restore net.ipv4.conf.all.rp_filter\n}\n\ntest_gretap()\n{\n\tRET=0\n\tmirror_install $swp1 ingress gt4 \"matchall $tcflags\"\n\n\t# For IPv4, test that there's no mirroring without the route directing\n\t# the traffic to tunnel remote address. Then add it and test that\n\t# mirroring starts. For IPv6 we can't test this due to the limitation\n\t# that routes for locally-specified IPv6 addresses can't be added.\n\tfail_test_span_gre_dir gt4 ingress\n\n\tip route add 192.0.2.130/32 via 192.0.2.162\n\tquick_test_span_gre_dir gt4 ingress\n\tip route del 192.0.2.130/32 via 192.0.2.162\n\n\tmirror_uninstall $swp1 ingress\n\tlog_test \"mirror to gre with next-hop remote ($tcflags)\"\n}\n\ntest_ip6gretap()\n{\n\tRET=0\n\n\tmirror_install $swp1 ingress gt6 \"matchall $tcflags\"\n\tquick_test_span_gre_dir gt6 ingress\n\tmirror_uninstall $swp1 ingress\n\n\tlog_test \"mirror to ip6gre with next-hop remote ($tcflags)\"\n}\n\ntest_all()\n{\n\tslow_path_trap_install $swp1 ingress\n\tslow_path_trap_install $swp1 egress\n\n\ttests_run\n\n\tslow_path_trap_uninstall $swp1 egress\n\tslow_path_trap_uninstall $swp1 ingress\n}\n\ntrap cleanup EXIT\n\nsetup_prepare\nsetup_wait\n\ntcflags=\"skip_hw\"\ntest_all\n\nif ! tc_offload_check; then\n\techo \"WARN: Could not test offloaded functionality\"\nelse\n\ttcflags=\"skip_sw\"\n\ttest_all\nfi\n\nexit $EXIT_STATUS\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}