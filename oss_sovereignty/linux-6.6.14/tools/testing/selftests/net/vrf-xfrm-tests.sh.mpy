{
  "module_name": "vrf-xfrm-tests.sh",
  "hash_id": "40b4b8cf013c303d6acc33b6ffad8e03387bb886aa861434b1fcaf24485ed285",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/vrf-xfrm-tests.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Various combinations of VRF with xfrms and qdisc.\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nPAUSE_ON_FAIL=no\nVERBOSE=0\nret=0\n\nHOST1_4=192.168.1.1\nHOST2_4=192.168.1.2\nHOST1_6=2001:db8:1::1\nHOST2_6=2001:db8:1::2\n\nXFRM1_4=10.0.1.1\nXFRM2_4=10.0.1.2\nXFRM1_6=fc00:1000::1\nXFRM2_6=fc00:1000::2\nIF_ID=123\n\nVRF=red\nTABLE=300\n\nAUTH_1=0xd94fcfea65fddf21dc6e0d24a0253508\nAUTH_2=0xdc6e0d24a0253508d94fcfea65fddf21\nENC_1=0xfc46c20f8048be9725930ff3fb07ac2a91f0347dffeacf62\nENC_2=0x3fb07ac2a91f0347dffeacf62fc46c20f8048be9725930ff\nSPI_1=0x02122b77\nSPI_2=0x2b770212\n\nwhich ping6 > /dev/null 2>&1 && ping6=$(which ping6) || ping6=$(which ping)\n\n################################################################################\n#\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n}\n\nrun_cmd_host1()\n{\n\tlocal cmd=\"$*\"\n\tlocal out\n\tlocal rc\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"    COMMAND: $cmd\\n\"\n\tfi\n\n\tout=$(eval ip netns exec host1 $cmd 2>&1)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tif [ -n \"$out\" ]; then\n\t\t\techo\n\t\t\techo \"    $out\"\n\t\tfi\n\t\techo\n\tfi\n\n\treturn $rc\n}\n\n################################################################################\n# create namespaces for hosts and sws\n\ncreate_vrf()\n{\n\tlocal ns=$1\n\tlocal vrf=$2\n\tlocal table=$3\n\n\tif [ -n \"${ns}\" ]; then\n\t\tns=\"-netns ${ns}\"\n\tfi\n\n\tip ${ns} link add ${vrf} type vrf table ${table}\n\tip ${ns} link set ${vrf} up\n\tip ${ns} route add vrf ${vrf} unreachable default metric 8192\n\tip ${ns} -6 route add vrf ${vrf} unreachable default metric 8192\n\n\tip ${ns} addr add 127.0.0.1/8 dev ${vrf}\n\tip ${ns} -6 addr add ::1 dev ${vrf} nodad\n\n\tip ${ns} ru del pref 0\n\tip ${ns} ru add pref 32765 from all lookup local\n\tip ${ns} -6 ru del pref 0\n\tip ${ns} -6 ru add pref 32765 from all lookup local\n}\n\ncreate_ns()\n{\n\tlocal ns=$1\n\tlocal addr=$2\n\tlocal addr6=$3\n\n\t[ -z \"${addr}\" ] && addr=\"-\"\n\t[ -z \"${addr6}\" ] && addr6=\"-\"\n\n\tip netns add ${ns}\n\n\tip -netns ${ns} link set lo up\n\tif [ \"${addr}\" != \"-\" ]; then\n\t\tip -netns ${ns} addr add dev lo ${addr}\n\tfi\n\tif [ \"${addr6}\" != \"-\" ]; then\n\t\tip -netns ${ns} -6 addr add dev lo ${addr6}\n\tfi\n\n\tip -netns ${ns} ro add unreachable default metric 8192\n\tip -netns ${ns} -6 ro add unreachable default metric 8192\n\n\tip netns exec ${ns} sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.all.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.forwarding=1\n\tip netns exec ${ns} sysctl -qw net.ipv6.conf.default.accept_dad=0\n}\n\n# create veth pair to connect namespaces and apply addresses.\nconnect_ns()\n{\n\tlocal ns1=$1\n\tlocal ns1_dev=$2\n\tlocal ns1_addr=$3\n\tlocal ns1_addr6=$4\n\tlocal ns2=$5\n\tlocal ns2_dev=$6\n\tlocal ns2_addr=$7\n\tlocal ns2_addr6=$8\n\tlocal ns1arg\n\tlocal ns2arg\n\n\tif [ -n \"${ns1}\" ]; then\n\t\tns1arg=\"-netns ${ns1}\"\n\tfi\n\tif [ -n \"${ns2}\" ]; then\n\t\tns2arg=\"-netns ${ns2}\"\n\tfi\n\n\tip ${ns1arg} li add ${ns1_dev} type veth peer name tmp\n\tip ${ns1arg} li set ${ns1_dev} up\n\tip ${ns1arg} li set tmp netns ${ns2} name ${ns2_dev}\n\tip ${ns2arg} li set ${ns2_dev} up\n\n\tif [ \"${ns1_addr}\" != \"-\" ]; then\n\t\tip ${ns1arg} addr add dev ${ns1_dev} ${ns1_addr}\n\t\tip ${ns2arg} addr add dev ${ns2_dev} ${ns2_addr}\n\tfi\n\n\tif [ \"${ns1_addr6}\" != \"-\" ]; then\n\t\tip ${ns1arg} addr add dev ${ns1_dev} ${ns1_addr6} nodad\n\t\tip ${ns2arg} addr add dev ${ns2_dev} ${ns2_addr6} nodad\n\tfi\n}\n\n################################################################################\n\ncleanup()\n{\n\tip netns del host1\n\tip netns del host2\n}\n\nsetup()\n{\n\tcreate_ns \"host1\"\n\tcreate_ns \"host2\"\n\n\tconnect_ns \"host1\" eth0 ${HOST1_4}/24 ${HOST1_6}/64 \\\n\t           \"host2\" eth0 ${HOST2_4}/24 ${HOST2_6}/64\n\n\tcreate_vrf \"host1\" ${VRF} ${TABLE}\n\tip -netns host1 link set dev eth0 master ${VRF}\n}\n\ncleanup_xfrm()\n{\n\tfor ns in host1 host2\n\tdo\n\t\tfor x in state policy\n\t\tdo\n\t\t\tip -netns ${ns} xfrm ${x} flush\n\t\t\tip -6 -netns ${ns} xfrm ${x} flush\n\t\tdone\n\tdone\n}\n\nsetup_xfrm()\n{\n\tlocal h1_4=$1\n\tlocal h2_4=$2\n\tlocal h1_6=$3\n\tlocal h2_6=$4\n\tlocal devarg=\"$5\"\n\n\t#\n\t# policy\n\t#\n\n\t# host1 - IPv4 out\n\tip -netns host1 xfrm policy add \\\n\t  src ${h1_4} dst ${h2_4} ${devarg} dir out \\\n\t  tmpl src ${HOST1_4} dst ${HOST2_4} proto esp mode tunnel\n\n\t# host2 - IPv4 in\n\tip -netns host2 xfrm policy add \\\n\t  src ${h1_4} dst ${h2_4} dir in \\\n\t  tmpl src ${HOST1_4} dst ${HOST2_4} proto esp mode tunnel\n\n\t# host1 - IPv4 in\n\tip -netns host1 xfrm policy add \\\n\t  src ${h2_4} dst ${h1_4} ${devarg} dir in \\\n\t  tmpl src ${HOST2_4} dst ${HOST1_4} proto esp mode tunnel\n\n\t# host2 - IPv4 out\n\tip -netns host2 xfrm policy add \\\n\t  src ${h2_4} dst ${h1_4} dir out \\\n\t  tmpl src ${HOST2_4} dst ${HOST1_4} proto esp mode tunnel\n\n\n\t# host1 - IPv6 out\n\tip -6 -netns host1 xfrm policy add \\\n\t  src ${h1_6} dst ${h2_6} ${devarg} dir out \\\n\t  tmpl src ${HOST1_6} dst ${HOST2_6} proto esp mode tunnel\n\n\t# host2 - IPv6 in\n\tip -6 -netns host2 xfrm policy add \\\n\t  src ${h1_6} dst ${h2_6} dir in \\\n\t  tmpl src ${HOST1_6} dst ${HOST2_6} proto esp mode tunnel\n\n\t# host1 - IPv6 in\n\tip -6 -netns host1 xfrm policy add \\\n\t  src ${h2_6} dst ${h1_6} ${devarg} dir in \\\n\t  tmpl src ${HOST2_6} dst ${HOST1_6} proto esp mode tunnel\n\n\t# host2 - IPv6 out\n\tip -6 -netns host2 xfrm policy add \\\n\t  src ${h2_6} dst ${h1_6} dir out \\\n\t  tmpl src ${HOST2_6} dst ${HOST1_6} proto esp mode tunnel\n\n\t#\n\t# state\n\t#\n\tip -netns host1 xfrm state add src ${HOST1_4} dst ${HOST2_4} \\\n\t    proto esp spi ${SPI_1} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_1} 96 \\\n\t    enc 'cbc(aes)' ${ENC_1} \\\n\t    sel src ${h1_4} dst ${h2_4} ${devarg}\n\n\tip -netns host2 xfrm state add src ${HOST1_4} dst ${HOST2_4} \\\n\t    proto esp spi ${SPI_1} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_1} 96 \\\n\t    enc 'cbc(aes)' ${ENC_1} \\\n\t    sel src ${h1_4} dst ${h2_4}\n\n\n\tip -netns host1 xfrm state add src ${HOST2_4} dst ${HOST1_4} \\\n\t    proto esp spi ${SPI_2} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_2} 96 \\\n\t    enc 'cbc(aes)' ${ENC_2} \\\n\t    sel src ${h2_4} dst ${h1_4} ${devarg}\n\n\tip -netns host2 xfrm state add src ${HOST2_4} dst ${HOST1_4} \\\n\t    proto esp spi ${SPI_2} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_2} 96 \\\n\t    enc 'cbc(aes)' ${ENC_2} \\\n\t    sel src ${h2_4} dst ${h1_4}\n\n\n\tip -6 -netns host1 xfrm state add src ${HOST1_6} dst ${HOST2_6} \\\n\t    proto esp spi ${SPI_1} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_1} 96 \\\n\t    enc 'cbc(aes)' ${ENC_1} \\\n\t    sel src ${h1_6} dst ${h2_6} ${devarg}\n\n\tip -6 -netns host2 xfrm state add src ${HOST1_6} dst ${HOST2_6} \\\n\t    proto esp spi ${SPI_1} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_1} 96 \\\n\t    enc 'cbc(aes)' ${ENC_1} \\\n\t    sel src ${h1_6} dst ${h2_6}\n\n\n\tip -6 -netns host1 xfrm state add src ${HOST2_6} dst ${HOST1_6} \\\n\t    proto esp spi ${SPI_2} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_2} 96 \\\n\t    enc 'cbc(aes)' ${ENC_2} \\\n\t    sel src ${h2_6} dst ${h1_6} ${devarg}\n\n\tip -6 -netns host2 xfrm state add src ${HOST2_6} dst ${HOST1_6} \\\n\t    proto esp spi ${SPI_2} reqid 0 mode tunnel \\\n\t    replay-window 4 replay-oseq 0x4 \\\n\t    auth-trunc 'hmac(sha1)' ${AUTH_2} 96 \\\n\t    enc 'cbc(aes)' ${ENC_2} \\\n\t    sel src ${h2_6} dst ${h1_6}\n}\n\ncleanup_xfrm_dev()\n{\n\tip -netns host1 li del xfrm0\n\tip -netns host2 addr del ${XFRM2_4}/24 dev eth0\n\tip -netns host2 addr del ${XFRM2_6}/64 dev eth0\n}\n\nsetup_xfrm_dev()\n{\n\tlocal vrfarg=\"vrf ${VRF}\"\n\n\tip -netns host1 li add type xfrm dev eth0 if_id ${IF_ID}\n\tip -netns host1 li set xfrm0 ${vrfarg} up\n\tip -netns host1 addr add ${XFRM1_4}/24 dev xfrm0\n\tip -netns host1 addr add ${XFRM1_6}/64 dev xfrm0\n\n\tip -netns host2 addr add ${XFRM2_4}/24 dev eth0\n\tip -netns host2 addr add ${XFRM2_6}/64 dev eth0\n\n\tsetup_xfrm ${XFRM1_4} ${XFRM2_4} ${XFRM1_6} ${XFRM2_6} \"if_id ${IF_ID}\"\n}\n\nrun_tests()\n{\n\tcleanup_xfrm\n\n\t# no IPsec\n\trun_cmd_host1 ip vrf exec ${VRF} ping -c1 -w1 ${HOST2_4}\n\tlog_test $? 0 \"IPv4 no xfrm policy\"\n\trun_cmd_host1 ip vrf exec ${VRF} ${ping6} -c1 -w1 ${HOST2_6}\n\tlog_test $? 0 \"IPv6 no xfrm policy\"\n\n\t# xfrm without VRF in sel\n\tsetup_xfrm ${HOST1_4} ${HOST2_4} ${HOST1_6} ${HOST2_6}\n\trun_cmd_host1 ip vrf exec ${VRF} ping -c1 -w1 ${HOST2_4}\n\tlog_test $? 0 \"IPv4 xfrm policy based on address\"\n\trun_cmd_host1 ip vrf exec ${VRF} ${ping6} -c1 -w1 ${HOST2_6}\n\tlog_test $? 0 \"IPv6 xfrm policy based on address\"\n\tcleanup_xfrm\n\n\t# xfrm with VRF in sel\n\t# Known failure: ipv4 resets the flow oif after the lookup. Fix is\n\t# not straightforward.\n\t# setup_xfrm ${HOST1_4} ${HOST2_4} ${HOST1_6} ${HOST2_6} \"dev ${VRF}\"\n\t# run_cmd_host1 ip vrf exec ${VRF} ping -c1 -w1 ${HOST2_4}\n\t# log_test $? 0 \"IPv4 xfrm policy with VRF in selector\"\n\trun_cmd_host1 ip vrf exec ${VRF} ${ping6} -c1 -w1 ${HOST2_6}\n\tlog_test $? 0 \"IPv6 xfrm policy with VRF in selector\"\n\tcleanup_xfrm\n\n\t# xfrm with enslaved device in sel\n\t# Known failures: combined with the above, __xfrm{4,6}_selector_match\n\t# needs to consider both l3mdev and enslaved device index.\n\t# setup_xfrm ${HOST1_4} ${HOST2_4} ${HOST1_6} ${HOST2_6} \"dev eth0\"\n\t# run_cmd_host1 ip vrf exec ${VRF} ping -c1 -w1 ${HOST2_4}\n\t# log_test $? 0 \"IPv4 xfrm policy with enslaved device in selector\"\n\t# run_cmd_host1 ip vrf exec ${VRF} ${ping6} -c1 -w1 ${HOST2_6}\n\t# log_test $? 0 \"IPv6 xfrm policy with enslaved device in selector\"\n\t# cleanup_xfrm\n\n\t# xfrm device\n\tsetup_xfrm_dev\n\trun_cmd_host1 ip vrf exec ${VRF} ping -c1 -w1 ${XFRM2_4}\n\tlog_test $? 0 \"IPv4 xfrm policy with xfrm device\"\n\trun_cmd_host1 ip vrf exec ${VRF} ${ping6} -c1 -w1 ${XFRM2_6}\n\tlog_test $? 0 \"IPv6 xfrm policy with xfrm device\"\n\tcleanup_xfrm_dev\n}\n\n################################################################################\n# usage\n\nusage()\n{\n        cat <<EOF\nusage: ${0##*/} OPTS\n\n        -p          Pause on fail\n        -v          verbose mode (show commands and output)\n\ndone\nEOF\n}\n\n################################################################################\n# main\n\nwhile getopts :pv o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\ncleanup 2>/dev/null\nsetup\n\necho\necho \"No qdisc on VRF device\"\nrun_tests\n\nrun_cmd_host1 tc qdisc add dev ${VRF} root netem delay 100ms\necho\necho \"netem qdisc on VRF device\"\nrun_tests\n\nprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\nprintf \"Tests failed: %3d\\n\"   ${nfail}\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}