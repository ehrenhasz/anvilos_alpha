{
  "module_name": "ip_local_port_range.c",
  "hash_id": "5ce4860368a6131d0c1224b1dc113eb0d50cedbece5d61a0298993bc6586270b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/ip_local_port_range.c",
  "human_readable_source": "\n\n\n \n\n#include <fcntl.h>\n#include <netinet/ip.h>\n\n#include \"../kselftest_harness.h\"\n\n#ifndef IP_LOCAL_PORT_RANGE\n#define IP_LOCAL_PORT_RANGE 51\n#endif\n\nstatic __u32 pack_port_range(__u16 lo, __u16 hi)\n{\n\treturn (hi << 16) | (lo << 0);\n}\n\nstatic void unpack_port_range(__u32 range, __u16 *lo, __u16 *hi)\n{\n\t*lo = range & 0xffff;\n\t*hi = range >> 16;\n}\n\nstatic int get_so_domain(int fd)\n{\n\tint domain, err;\n\tsocklen_t len;\n\n\tlen = sizeof(domain);\n\terr = getsockopt(fd, SOL_SOCKET, SO_DOMAIN, &domain, &len);\n\tif (err)\n\t\treturn -1;\n\n\treturn domain;\n}\n\nstatic int bind_to_loopback_any_port(int fd)\n{\n\tunion {\n\t\tstruct sockaddr sa;\n\t\tstruct sockaddr_in v4;\n\t\tstruct sockaddr_in6 v6;\n\t} addr;\n\tsocklen_t addr_len;\n\n\tmemset(&addr, 0, sizeof(addr));\n\tswitch (get_so_domain(fd)) {\n\tcase AF_INET:\n\t\taddr.v4.sin_family = AF_INET;\n\t\taddr.v4.sin_port = htons(0);\n\t\taddr.v4.sin_addr.s_addr = htonl(INADDR_LOOPBACK);\n\t\taddr_len = sizeof(addr.v4);\n\t\tbreak;\n\tcase AF_INET6:\n\t\taddr.v6.sin6_family = AF_INET6;\n\t\taddr.v6.sin6_port = htons(0);\n\t\taddr.v6.sin6_addr = in6addr_loopback;\n\t\taddr_len = sizeof(addr.v6);\n\t\tbreak;\n\tdefault:\n\t\treturn -1;\n\t}\n\n\treturn bind(fd, &addr.sa, addr_len);\n}\n\nstatic int get_sock_port(int fd)\n{\n\tunion {\n\t\tstruct sockaddr sa;\n\t\tstruct sockaddr_in v4;\n\t\tstruct sockaddr_in6 v6;\n\t} addr;\n\tsocklen_t addr_len;\n\tint err;\n\n\taddr_len = sizeof(addr);\n\tmemset(&addr, 0, sizeof(addr));\n\terr = getsockname(fd, &addr.sa, &addr_len);\n\tif (err)\n\t\treturn -1;\n\n\tswitch (addr.sa.sa_family) {\n\tcase AF_INET:\n\t\treturn ntohs(addr.v4.sin_port);\n\tcase AF_INET6:\n\t\treturn ntohs(addr.v6.sin6_port);\n\tdefault:\n\t\terrno = EAFNOSUPPORT;\n\t\treturn -1;\n\t}\n}\n\nstatic int get_ip_local_port_range(int fd, __u32 *range)\n{\n\tsocklen_t len;\n\t__u32 val;\n\tint err;\n\n\tlen = sizeof(val);\n\terr = getsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &val, &len);\n\tif (err)\n\t\treturn -1;\n\n\t*range = val;\n\treturn 0;\n}\n\nFIXTURE(ip_local_port_range) {};\n\nFIXTURE_SETUP(ip_local_port_range)\n{\n}\n\nFIXTURE_TEARDOWN(ip_local_port_range)\n{\n}\n\nFIXTURE_VARIANT(ip_local_port_range) {\n\tint so_domain;\n\tint so_type;\n\tint so_protocol;\n};\n\nFIXTURE_VARIANT_ADD(ip_local_port_range, ip4_tcp) {\n\t.so_domain\t= AF_INET,\n\t.so_type\t= SOCK_STREAM,\n\t.so_protocol\t= 0,\n};\n\nFIXTURE_VARIANT_ADD(ip_local_port_range, ip4_udp) {\n\t.so_domain\t= AF_INET,\n\t.so_type\t= SOCK_DGRAM,\n\t.so_protocol\t= 0,\n};\n\nFIXTURE_VARIANT_ADD(ip_local_port_range, ip4_stcp) {\n\t.so_domain\t= AF_INET,\n\t.so_type\t= SOCK_STREAM,\n\t.so_protocol\t= IPPROTO_SCTP,\n};\n\nFIXTURE_VARIANT_ADD(ip_local_port_range, ip6_tcp) {\n\t.so_domain\t= AF_INET6,\n\t.so_type\t= SOCK_STREAM,\n\t.so_protocol\t= 0,\n};\n\nFIXTURE_VARIANT_ADD(ip_local_port_range, ip6_udp) {\n\t.so_domain\t= AF_INET6,\n\t.so_type\t= SOCK_DGRAM,\n\t.so_protocol\t= 0,\n};\n\nFIXTURE_VARIANT_ADD(ip_local_port_range, ip6_stcp) {\n\t.so_domain\t= AF_INET6,\n\t.so_type\t= SOCK_STREAM,\n\t.so_protocol\t= IPPROTO_SCTP,\n};\n\nTEST_F(ip_local_port_range, invalid_option_value)\n{\n\t__u16 val16;\n\t__u32 val32;\n\t__u64 val64;\n\tint fd, err;\n\n\tfd = socket(variant->so_domain, variant->so_type, variant->so_protocol);\n\tASSERT_GE(fd, 0) TH_LOG(\"socket failed\");\n\n\t \n\tval16 = 40000;\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &val16, sizeof(val16));\n\tEXPECT_TRUE(err) TH_LOG(\"expected setsockopt(IP_LOCAL_PORT_RANGE) to fail\");\n\tEXPECT_EQ(errno, EINVAL);\n\n\t \n\tval32 = pack_port_range(40222, 40111);\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &val32, sizeof(val32));\n\tEXPECT_TRUE(err) TH_LOG(\"expected setsockopt(IP_LOCAL_PORT_RANGE) to fail\");\n\tEXPECT_EQ(errno, EINVAL);\n\n\t \n\tval64 = pack_port_range(40333, 40444);\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &val64, sizeof(val64));\n\tEXPECT_TRUE(err) TH_LOG(\"expected setsockopt(IP_LOCAL_PORT_RANGE) to fail\");\n\tEXPECT_EQ(errno, EINVAL);\n\n\terr = close(fd);\n\tASSERT_TRUE(!err) TH_LOG(\"close failed\");\n}\n\nTEST_F(ip_local_port_range, port_range_out_of_netns_range)\n{\n\tconst struct test {\n\t\t__u16 range_lo;\n\t\t__u16 range_hi;\n\t} tests[] = {\n\t\t{ 30000, 39999 },  \n\t\t{ 50000, 59999 },  \n\t};\n\tconst struct test *t;\n\n\tfor (t = tests; t < tests + ARRAY_SIZE(tests); t++) {\n\t\t \n\t\tint fds[2], i;\n\n\t\tTH_LOG(\"lo %5hu, hi %5hu\", t->range_lo, t->range_hi);\n\n\t\tfor (i = 0; i < ARRAY_SIZE(fds); i++) {\n\t\t\tint fd, err, port;\n\t\t\t__u32 range;\n\n\t\t\tfd = socket(variant->so_domain, variant->so_type, variant->so_protocol);\n\t\t\tASSERT_GE(fd, 0) TH_LOG(\"#%d: socket failed\", i);\n\n\t\t\trange = pack_port_range(t->range_lo, t->range_hi);\n\t\t\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\t\t\tASSERT_TRUE(!err) TH_LOG(\"#%d: setsockopt(IP_LOCAL_PORT_RANGE) failed\", i);\n\n\t\t\terr = bind_to_loopback_any_port(fd);\n\t\t\tASSERT_TRUE(!err) TH_LOG(\"#%d: bind failed\", i);\n\n\t\t\t \n\t\t\tport = get_sock_port(fd);\n\t\t\tASSERT_GE(port, 40000) TH_LOG(\"#%d: expected port within netns range\", i);\n\t\t\tASSERT_LE(port, 49999) TH_LOG(\"#%d: expected port within netns range\", i);\n\n\t\t\tfds[i] = fd;\n\t\t}\n\n\t\tfor (i = 0; i < ARRAY_SIZE(fds); i++)\n\t\t\tASSERT_TRUE(close(fds[i]) == 0) TH_LOG(\"#%d: close failed\", i);\n\t}\n}\n\nTEST_F(ip_local_port_range, single_port_range)\n{\n\tconst struct test {\n\t\t__u16 range_lo;\n\t\t__u16 range_hi;\n\t\t__u16 expected;\n\t} tests[] = {\n\t\t \n\t\t{ 45000, 45000, 45000 },\n\t\t \n\t\t{ 0, 40000, 40000 },\n\t\t \n\t\t{ 49999, 0, 49999 },\n\t};\n\tconst struct test *t;\n\n\tfor (t = tests; t < tests + ARRAY_SIZE(tests); t++) {\n\t\tint fd, err, port;\n\t\t__u32 range;\n\n\t\tTH_LOG(\"lo %5hu, hi %5hu, expected %5hu\",\n\t\t       t->range_lo, t->range_hi, t->expected);\n\n\t\tfd = socket(variant->so_domain, variant->so_type, variant->so_protocol);\n\t\tASSERT_GE(fd, 0) TH_LOG(\"socket failed\");\n\n\t\trange = pack_port_range(t->range_lo, t->range_hi);\n\t\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\t\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\t\terr = bind_to_loopback_any_port(fd);\n\t\tASSERT_TRUE(!err) TH_LOG(\"bind failed\");\n\n\t\tport = get_sock_port(fd);\n\t\tASSERT_EQ(port, t->expected) TH_LOG(\"unexpected local port\");\n\n\t\terr = close(fd);\n\t\tASSERT_TRUE(!err) TH_LOG(\"close failed\");\n\t}\n}\n\nTEST_F(ip_local_port_range, exhaust_8_port_range)\n{\n\t__u8 port_set = 0;\n\tint i, fd, err;\n\t__u32 range;\n\t__u16 port;\n\tint fds[8];\n\n\tfor (i = 0; i < ARRAY_SIZE(fds); i++) {\n\t\tfd = socket(variant->so_domain, variant->so_type, variant->so_protocol);\n\t\tASSERT_GE(fd, 0) TH_LOG(\"socket failed\");\n\n\t\trange = pack_port_range(40000, 40007);\n\t\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\t\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\t\terr = bind_to_loopback_any_port(fd);\n\t\tASSERT_TRUE(!err) TH_LOG(\"bind failed\");\n\n\t\tport = get_sock_port(fd);\n\t\tASSERT_GE(port, 40000) TH_LOG(\"expected port within sockopt range\");\n\t\tASSERT_LE(port, 40007) TH_LOG(\"expected port within sockopt range\");\n\n\t\tport_set |= 1 << (port - 40000);\n\t\tfds[i] = fd;\n\t}\n\n\t \n\tASSERT_EQ(port_set, 0xff) TH_LOG(\"expected all ports to be busy\");\n\n\t \n\tfd = socket(variant->so_domain, variant->so_type, variant->so_protocol);\n\tASSERT_GE(fd, 0) TH_LOG(\"socket failed\");\n\n\trange = pack_port_range(40000, 40007);\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\terr = bind_to_loopback_any_port(fd);\n\tASSERT_TRUE(err) TH_LOG(\"expected bind to fail\");\n\tASSERT_EQ(errno, EADDRINUSE);\n\n\terr = close(fd);\n\tASSERT_TRUE(!err) TH_LOG(\"close failed\");\n\n\tfor (i = 0; i < ARRAY_SIZE(fds); i++) {\n\t\terr = close(fds[i]);\n\t\tASSERT_TRUE(!err) TH_LOG(\"close failed\");\n\t}\n}\n\nTEST_F(ip_local_port_range, late_bind)\n{\n\tunion {\n\t\tstruct sockaddr sa;\n\t\tstruct sockaddr_in v4;\n\t\tstruct sockaddr_in6 v6;\n\t} addr;\n\tsocklen_t addr_len;\n\tconst int one = 1;\n\tint fd, err;\n\t__u32 range;\n\t__u16 port;\n\n\tif (variant->so_protocol == IPPROTO_SCTP)\n\t\tSKIP(return, \"SCTP doesn't support IP_BIND_ADDRESS_NO_PORT\");\n\n\tfd = socket(variant->so_domain, variant->so_type, 0);\n\tASSERT_GE(fd, 0) TH_LOG(\"socket failed\");\n\n\trange = pack_port_range(40100, 40199);\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\terr = setsockopt(fd, SOL_IP, IP_BIND_ADDRESS_NO_PORT, &one, sizeof(one));\n\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_BIND_ADDRESS_NO_PORT) failed\");\n\n\terr = bind_to_loopback_any_port(fd);\n\tASSERT_TRUE(!err) TH_LOG(\"bind failed\");\n\n\tport = get_sock_port(fd);\n\tASSERT_EQ(port, 0) TH_LOG(\"getsockname failed\");\n\n\t \n\tmemset(&addr, 0, sizeof(addr));\n\tswitch (variant->so_domain) {\n\tcase AF_INET:\n\t\taddr.v4.sin_family = AF_INET;\n\t\taddr.v4.sin_port = htons(0);\n\t\taddr.v4.sin_addr.s_addr = htonl(INADDR_ANY);\n\t\taddr_len = sizeof(addr.v4);\n\t\tbreak;\n\tcase AF_INET6:\n\t\taddr.v6.sin6_family = AF_INET6;\n\t\taddr.v6.sin6_port = htons(0);\n\t\taddr.v6.sin6_addr = in6addr_any;\n\t\taddr_len = sizeof(addr.v6);\n\t\tbreak;\n\tdefault:\n\t\tASSERT_TRUE(false) TH_LOG(\"unsupported socket domain\");\n\t}\n\n\t \n\tconnect(fd, &addr.sa, addr_len);\n\n\tport = get_sock_port(fd);\n\tASSERT_GE(port, 40100);\n\tASSERT_LE(port, 40199);\n\n\terr = close(fd);\n\tASSERT_TRUE(!err) TH_LOG(\"close failed\");\n}\n\nTEST_F(ip_local_port_range, get_port_range)\n{\n\t__u16 lo, hi;\n\t__u32 range;\n\tint fd, err;\n\n\tfd = socket(variant->so_domain, variant->so_type, variant->so_protocol);\n\tASSERT_GE(fd, 0) TH_LOG(\"socket failed\");\n\n\t \n\terr = get_ip_local_port_range(fd, &range);\n\tASSERT_TRUE(!err) TH_LOG(\"getsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\tunpack_port_range(range, &lo, &hi);\n\tASSERT_EQ(lo, 0) TH_LOG(\"unexpected low port\");\n\tASSERT_EQ(hi, 0) TH_LOG(\"unexpected high port\");\n\n\trange = pack_port_range(12345, 54321);\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\t \n\terr = get_ip_local_port_range(fd, &range);\n\tASSERT_TRUE(!err) TH_LOG(\"getsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\tunpack_port_range(range, &lo, &hi);\n\tASSERT_EQ(lo, 12345) TH_LOG(\"unexpected low port\");\n\tASSERT_EQ(hi, 54321) TH_LOG(\"unexpected high port\");\n\n\t \n\trange = pack_port_range(0, 0);\n\terr = setsockopt(fd, SOL_IP, IP_LOCAL_PORT_RANGE, &range, sizeof(range));\n\tASSERT_TRUE(!err) TH_LOG(\"setsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\t \n\terr = get_ip_local_port_range(fd, &range);\n\tASSERT_TRUE(!err) TH_LOG(\"getsockopt(IP_LOCAL_PORT_RANGE) failed\");\n\n\tunpack_port_range(range, &lo, &hi);\n\tASSERT_EQ(lo, 0) TH_LOG(\"unexpected low port\");\n\tASSERT_EQ(hi, 0) TH_LOG(\"unexpected high port\");\n\n\terr = close(fd);\n\tASSERT_TRUE(!err) TH_LOG(\"close failed\");\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}