{
  "module_name": "test_vxlan_mdb.sh",
  "hash_id": "c5757e9f91b95c61874d8a6a21c29a5379028a917e3c11b37a7b6120288d88b1",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/test_vxlan_mdb.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking VXLAN MDB functionality. The topology consists of\n# two sets of namespaces: One for the testing of IPv4 underlay and another for\n# IPv6. In both cases, both IPv4 and IPv6 overlay traffic are tested.\n#\n# Data path functionality is tested by sending traffic from one of the upper\n# namespaces and checking using ingress tc filters that the expected traffic\n# was received by one of the lower namespaces.\n#\n# +------------------------------------+ +------------------------------------+\n# | ns1_v4                             | | ns1_v6                             |\n# |                                    | |                                    |\n# |    br0.10    br0.4000  br0.20      | |    br0.10    br0.4000  br0.20      |\n# |       +         +         +        | |       +         +         +        |\n# |       |         |         |        | |       |         |         |        |\n# |       |         |         |        | |       |         |         |        |\n# |       +---------+---------+        | |       +---------+---------+        |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |                 +                  | |                 +                  |\n# |                br0                 | |                br0                 |\n# |                 +                  | |                 +                  |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |                 +                  | |                 +                  |\n# |                vx0                 | |                vx0                 |\n# |                                    | |                                    |\n# |                                    | |                                    |\n# |               veth0                | |               veth0                |\n# |                 +                  | |                 +                  |\n# +-----------------|------------------+ +-----------------|------------------+\n#                   |                                      |\n# +-----------------|------------------+ +-----------------|------------------+\n# |                 +                  | |                 +                  |\n# |               veth0                | |               veth0                |\n# |                                    | |                                    |\n# |                                    | |                                    |\n# |                vx0                 | |                vx0                 |\n# |                 +                  | |                 +                  |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |                 +                  | |                 +                  |\n# |                br0                 | |                br0                 |\n# |                 +                  | |                 +                  |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |       +---------+---------+        | |       +---------+---------+        |\n# |       |         |         |        | |       |         |         |        |\n# |       |         |         |        | |       |         |         |        |\n# |       +         +         +        | |       +         +         +        |\n# |    br0.10    br0.4000  br0.10      | |    br0.10    br0.4000  br0.20      |\n# |                                    | |                                    |\n# | ns2_v4                             | | ns2_v6                             |\n# +------------------------------------+ +------------------------------------+\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nCONTROL_PATH_TESTS=\"\n\tbasic_star_g_ipv4_ipv4\n\tbasic_star_g_ipv6_ipv4\n\tbasic_star_g_ipv4_ipv6\n\tbasic_star_g_ipv6_ipv6\n\tbasic_sg_ipv4_ipv4\n\tbasic_sg_ipv6_ipv4\n\tbasic_sg_ipv4_ipv6\n\tbasic_sg_ipv6_ipv6\n\tstar_g_ipv4_ipv4\n\tstar_g_ipv6_ipv4\n\tstar_g_ipv4_ipv6\n\tstar_g_ipv6_ipv6\n\tsg_ipv4_ipv4\n\tsg_ipv6_ipv4\n\tsg_ipv4_ipv6\n\tsg_ipv6_ipv6\n\tdump_ipv4_ipv4\n\tdump_ipv6_ipv4\n\tdump_ipv4_ipv6\n\tdump_ipv6_ipv6\n\"\n\nDATA_PATH_TESTS=\"\n\tencap_params_ipv4_ipv4\n\tencap_params_ipv6_ipv4\n\tencap_params_ipv4_ipv6\n\tencap_params_ipv6_ipv6\n\tstarg_exclude_ir_ipv4_ipv4\n\tstarg_exclude_ir_ipv6_ipv4\n\tstarg_exclude_ir_ipv4_ipv6\n\tstarg_exclude_ir_ipv6_ipv6\n\tstarg_include_ir_ipv4_ipv4\n\tstarg_include_ir_ipv6_ipv4\n\tstarg_include_ir_ipv4_ipv6\n\tstarg_include_ir_ipv6_ipv6\n\tstarg_exclude_p2mp_ipv4_ipv4\n\tstarg_exclude_p2mp_ipv6_ipv4\n\tstarg_exclude_p2mp_ipv4_ipv6\n\tstarg_exclude_p2mp_ipv6_ipv6\n\tstarg_include_p2mp_ipv4_ipv4\n\tstarg_include_p2mp_ipv6_ipv4\n\tstarg_include_p2mp_ipv4_ipv6\n\tstarg_include_p2mp_ipv6_ipv6\n\tegress_vni_translation_ipv4_ipv4\n\tegress_vni_translation_ipv6_ipv4\n\tegress_vni_translation_ipv4_ipv6\n\tegress_vni_translation_ipv6_ipv6\n\tall_zeros_mdb_ipv4\n\tall_zeros_mdb_ipv6\n\tmdb_fdb_ipv4_ipv4\n\tmdb_fdb_ipv6_ipv4\n\tmdb_fdb_ipv4_ipv6\n\tmdb_fdb_ipv6_ipv6\n\tmdb_torture_ipv4_ipv4\n\tmdb_torture_ipv6_ipv4\n\tmdb_torture_ipv4_ipv6\n\tmdb_torture_ipv6_ipv6\n\"\n\n# All tests in this script. Can be overridden with -t option.\nTESTS=\"\n\t$CONTROL_PATH_TESTS\n\t$DATA_PATH_TESTS\n\"\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\n\n################################################################################\n# Utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\t\techo \"    rc=$rc, expected $expected\"\n\t\tfi\n\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$1\"\n\tlocal out\n\tlocal stderr=\"2>/dev/null\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"COMMAND: $cmd\\n\"\n\t\tstderr=\n\tfi\n\n\tout=$(eval $cmd $stderr)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\treturn $rc\n}\n\ntc_check_packets()\n{\n\tlocal ns=$1; shift\n\tlocal id=$1; shift\n\tlocal handle=$1; shift\n\tlocal count=$1; shift\n\tlocal pkts\n\n\tsleep 0.1\n\tpkts=$(tc -n $ns -j -s filter show $id \\\n\t\t| jq \".[] | select(.options.handle == $handle) | \\\n\t\t.options.actions[0].stats.packets\")\n\t[[ $pkts == $count ]]\n}\n\n################################################################################\n# Setup\n\nsetup_common_ns()\n{\n\tlocal ns=$1; shift\n\tlocal local_addr=$1; shift\n\n\tip netns exec $ns sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec $ns sysctl -qw net.ipv4.fib_multipath_use_neigh=1\n\tip netns exec $ns sysctl -qw net.ipv4.conf.default.ignore_routes_with_linkdown=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.forwarding=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.forwarding=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.ignore_routes_with_linkdown=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.accept_dad=0\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.accept_dad=0\n\n\tip -n $ns link set dev lo up\n\tip -n $ns address add $local_addr dev lo\n\n\tip -n $ns link set dev veth0 up\n\n\tip -n $ns link add name br0 up type bridge vlan_filtering 1 \\\n\t\tvlan_default_pvid 0 mcast_snooping 0\n\n\tip -n $ns link add link br0 name br0.10 up type vlan id 10\n\tbridge -n $ns vlan add vid 10 dev br0 self\n\n\tip -n $ns link add link br0 name br0.20 up type vlan id 20\n\tbridge -n $ns vlan add vid 20 dev br0 self\n\n\tip -n $ns link add link br0 name br0.4000 up type vlan id 4000\n\tbridge -n $ns vlan add vid 4000 dev br0 self\n\n\tip -n $ns link add name vx0 up master br0 type vxlan \\\n\t\tlocal $local_addr dstport 4789 external vnifilter\n\tbridge -n $ns link set dev vx0 vlan_tunnel on\n\n\tbridge -n $ns vlan add vid 10 dev vx0\n\tbridge -n $ns vlan add vid 10 dev vx0 tunnel_info id 10010\n\tbridge -n $ns vni add vni 10010 dev vx0\n\n\tbridge -n $ns vlan add vid 20 dev vx0\n\tbridge -n $ns vlan add vid 20 dev vx0 tunnel_info id 10020\n\tbridge -n $ns vni add vni 10020 dev vx0\n\n\tbridge -n $ns vlan add vid 4000 dev vx0 pvid\n\tbridge -n $ns vlan add vid 4000 dev vx0 tunnel_info id 14000\n\tbridge -n $ns vni add vni 14000 dev vx0\n}\n\nsetup_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal local_addr1=$1; shift\n\tlocal local_addr2=$1; shift\n\n\tip netns add $ns1\n\tip netns add $ns2\n\n\tip link add name veth0 type veth peer name veth1\n\tip link set dev veth0 netns $ns1 name veth0\n\tip link set dev veth1 netns $ns2 name veth0\n\n\tsetup_common_ns $ns1 $local_addr1\n\tsetup_common_ns $ns2 $local_addr2\n}\n\nsetup_v4()\n{\n\tsetup_common ns1_v4 ns2_v4 192.0.2.1 192.0.2.2\n\n\tip -n ns1_v4 address add 192.0.2.17/28 dev veth0\n\tip -n ns2_v4 address add 192.0.2.18/28 dev veth0\n\n\tip -n ns1_v4 route add default via 192.0.2.18\n\tip -n ns2_v4 route add default via 192.0.2.17\n}\n\ncleanup_v4()\n{\n\tip netns del ns2_v4\n\tip netns del ns1_v4\n}\n\nsetup_v6()\n{\n\tsetup_common ns1_v6 ns2_v6 2001:db8:1::1 2001:db8:1::2\n\n\tip -n ns1_v6 address add 2001:db8:2::1/64 dev veth0 nodad\n\tip -n ns2_v6 address add 2001:db8:2::2/64 dev veth0 nodad\n\n\tip -n ns1_v6 route add default via 2001:db8:2::2\n\tip -n ns2_v6 route add default via 2001:db8:2::1\n}\n\ncleanup_v6()\n{\n\tip netns del ns2_v6\n\tip netns del ns1_v6\n}\n\nsetup()\n{\n\tset -e\n\n\tsetup_v4\n\tsetup_v6\n\n\tsleep 5\n\n\tset +e\n}\n\ncleanup()\n{\n\tcleanup_v6 &> /dev/null\n\tcleanup_v4 &> /dev/null\n}\n\n################################################################################\n# Tests - Control path\n\nbasic_common()\n{\n\tlocal ns1=$1; shift\n\tlocal grp_key=$1; shift\n\tlocal vtep_ip=$1; shift\n\n\t# Test basic control path operations common to all MDB entry types.\n\n\t# Basic add, replace and delete behavior.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 0 \"MDB entry addition\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\"\"\n\tlog_test $? 0 \"MDB entry presence after addition\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 0 \"MDB entry replacement\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\"\"\n\tlog_test $? 0 \"MDB entry presence after replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n\tlog_test $? 0 \"MDB entry deletion\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\"\"\n\tlog_test $? 1 \"MDB entry presence after deletion\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"Non-existent MDB entry deletion\"\n\n\t# Default protocol and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\"proto static\\\"\"\n\tlog_test $? 0 \"MDB entry default protocol\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 $grp_key permanent proto 123 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\"proto 123\\\"\"\n\tlog_test $? 0 \"MDB entry protocol replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n\n\t# Default destination port and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\" dst_port \\\"\"\n\tlog_test $? 1 \"MDB entry default destination port\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 $grp_key permanent dst $vtep_ip dst_port 1234 src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\"dst_port 1234\\\"\"\n\tlog_test $? 0 \"MDB entry destination port replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n\n\t# Default destination VNI and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\" vni \\\"\"\n\tlog_test $? 1 \"MDB entry default destination VNI\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 $grp_key permanent dst $vtep_ip vni 1234 src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\"vni 1234\\\"\"\n\tlog_test $? 0 \"MDB entry destination VNI replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n\n\t# Default outgoing interface and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\" via \\\"\"\n\tlog_test $? 1 \"MDB entry default outgoing interface\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010 via veth0\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep \\\"$grp_key\\\" | grep \\\"via veth0\\\"\"\n\tlog_test $? 0 \"MDB entry outgoing interface replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n\n\t# Common error cases.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port veth0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"MDB entry with mismatch between device and port\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key temp dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"MDB entry with temp state\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent vid 10 dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"MDB entry with VLAN\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp 01:02:03:04:05:06 permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"MDB entry MAC address\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent\"\n\tlog_test $? 255 \"MDB entry without extended parameters\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent proto 3 dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"MDB entry with an invalid protocol\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip vni $((2 ** 24)) src_vni 10010\"\n\tlog_test $? 255 \"MDB entry with an invalid destination VNI\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni $((2 ** 24))\"\n\tlog_test $? 255 \"MDB entry with an invalid source VNI\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent src_vni 10010\"\n\tlog_test $? 255 \"MDB entry without a remote destination IP\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 $grp_key permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"Duplicate MDB entries\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 $grp_key dst $vtep_ip src_vni 10010\"\n}\n\nbasic_star_g_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp_key=\"grp 239.1.1.1\"\n\tlocal vtep_ip=198.51.100.100\n\n\techo\n\techo \"Control path: Basic (*, G) operations - IPv4 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_star_g_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp_key=\"grp ff0e::1\"\n\tlocal vtep_ip=198.51.100.100\n\n\techo\n\techo \"Control path: Basic (*, G) operations - IPv6 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_star_g_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp_key=\"grp 239.1.1.1\"\n\tlocal vtep_ip=2001:db8:1000::1\n\n\techo\n\techo \"Control path: Basic (*, G) operations - IPv4 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_star_g_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp_key=\"grp ff0e::1\"\n\tlocal vtep_ip=2001:db8:1000::1\n\n\techo\n\techo \"Control path: Basic (*, G) operations - IPv6 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_sg_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp_key=\"grp 239.1.1.1 src 192.0.2.129\"\n\tlocal vtep_ip=198.51.100.100\n\n\techo\n\techo \"Control path: Basic (S, G) operations - IPv4 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_sg_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp_key=\"grp ff0e::1 src 2001:db8:100::1\"\n\tlocal vtep_ip=198.51.100.100\n\n\techo\n\techo \"Control path: Basic (S, G) operations - IPv6 overlay / IPv4 underlay\"\n\techo \"---------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_sg_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp_key=\"grp 239.1.1.1 src 192.0.2.129\"\n\tlocal vtep_ip=2001:db8:1000::1\n\n\techo\n\techo \"Control path: Basic (S, G) operations - IPv4 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nbasic_sg_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp_key=\"grp ff0e::1 src 2001:db8:100::1\"\n\tlocal vtep_ip=2001:db8:1000::1\n\n\techo\n\techo \"Control path: Basic (S, G) operations - IPv6 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------------\"\n\n\tbasic_common $ns1 \"$grp_key\" $vtep_ip\n}\n\nstar_g_common()\n{\n\tlocal ns1=$1; shift\n\tlocal grp=$1; shift\n\tlocal src1=$1; shift\n\tlocal src2=$1; shift\n\tlocal src3=$1; shift\n\tlocal vtep_ip=$1; shift\n\tlocal all_zeros_grp=$1; shift\n\n\t# Test control path operations specific to (*, G) entries.\n\n\t# Basic add, replace and delete behavior.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\tlog_test $? 0 \"(*, G) MDB entry addition with source list\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry presence after addition\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry presence after addition\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\tlog_test $? 0 \"(*, G) MDB entry replacement with source list\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry presence after replacement\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry presence after replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\tlog_test $? 0 \"(*, G) MDB entry deletion\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\"\"\n\tlog_test $? 1 \"(*, G) MDB entry presence after deletion\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 1 \"(S, G) MDB entry presence after deletion\"\n\n\t# Default filter mode and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep exclude\"\n\tlog_test $? 0 \"(*, G) MDB entry default filter mode\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode include source_list $src1 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep include\"\n\tlog_test $? 0 \"(*, G) MDB entry after replacing filter mode to \\\"include\\\"\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry after replacing filter mode to \\\"include\\\"\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\" | grep blocked\"\n\tlog_test $? 1 \"\\\"blocked\\\" flag after replacing filter mode to \\\"include\\\"\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep exclude\"\n\tlog_test $? 0 \"(*, G) MDB entry after replacing filter mode to \\\"exclude\\\"\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry after replacing filter mode to \\\"exclude\\\"\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\" | grep blocked\"\n\tlog_test $? 0 \"\\\"blocked\\\" flag after replacing filter mode to \\\"exclude\\\"\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\n\t# Default source list and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep source_list\"\n\tlog_test $? 1 \"(*, G) MDB entry default source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1,$src2,$src3 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry of 1st source after replacing source list\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src2\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry of 2nd source after replacing source list\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src3\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry of 3rd source after replacing source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1,$src3 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src1\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry of 1st source after removing source\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src2\\\"\"\n\tlog_test $? 1 \"(S, G) MDB entry of 2nd source after removing source\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\"src $src3\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry of 3rd source after removing source\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\n\t# Default protocol and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\"proto static\\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry default protocol\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\"proto static\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry default protocol\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 proto bgp dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\"proto bgp\\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry protocol after replacement\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\"proto bgp\\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry protocol after replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\n\t# Default destination port and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\" dst_port \\\"\"\n\tlog_test $? 1 \"(*, G) MDB entry default destination port\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\" dst_port \\\"\"\n\tlog_test $? 1 \"(S, G) MDB entry default destination port\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip dst_port 1234 src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\" dst_port 1234 \\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry destination port after replacement\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\" dst_port 1234 \\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry destination port after replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\n\t# Default destination VNI and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\" vni \\\"\"\n\tlog_test $? 1 \"(*, G) MDB entry default destination VNI\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\" vni \\\"\"\n\tlog_test $? 1 \"(S, G) MDB entry default destination VNI\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip vni 1234 src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\" vni 1234 \\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry destination VNI after replacement\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\" vni 1234 \\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry destination VNI after replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\n\t# Default outgoing interface and replacement.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\" via \\\"\"\n\tlog_test $? 1 \"(*, G) MDB entry default outgoing interface\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\" via \\\"\"\n\tlog_test $? 1 \"(S, G) MDB entry default outgoing interface\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $src1 dst $vtep_ip src_vni 10010 via veth0\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep -v \\\" src \\\" | grep \\\" via veth0 \\\"\"\n\tlog_test $? 0 \"(*, G) MDB entry outgoing interface after replacement\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep \\\" src \\\" | grep \\\" via veth0 \\\"\"\n\tlog_test $? 0 \"(S, G) MDB entry outgoing interface after replacement\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep_ip src_vni 10010\"\n\n\t# Error cases.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $all_zeros_grp permanent filter_mode exclude dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"All-zeros group with filter mode\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $all_zeros_grp permanent source_list $src1 dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"All-zeros group with source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode include dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"(*, G) INCLUDE with an empty source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $grp dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"Invalid source in source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp permanent source_list $src1 dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"Source list without filter mode\"\n}\n\nstar_g_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp=239.1.1.1\n\tlocal src1=192.0.2.129\n\tlocal src2=192.0.2.130\n\tlocal src3=192.0.2.131\n\tlocal vtep_ip=198.51.100.100\n\tlocal all_zeros_grp=0.0.0.0\n\n\techo\n\techo \"Control path: (*, G) operations - IPv4 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tstar_g_common $ns1 $grp $src1 $src2 $src3 $vtep_ip $all_zeros_grp\n}\n\nstar_g_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp=ff0e::1\n\tlocal src1=2001:db8:100::1\n\tlocal src2=2001:db8:100::2\n\tlocal src3=2001:db8:100::3\n\tlocal vtep_ip=198.51.100.100\n\tlocal all_zeros_grp=::\n\n\techo\n\techo \"Control path: (*, G) operations - IPv6 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tstar_g_common $ns1 $grp $src1 $src2 $src3 $vtep_ip $all_zeros_grp\n}\n\nstar_g_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp=239.1.1.1\n\tlocal src1=192.0.2.129\n\tlocal src2=192.0.2.130\n\tlocal src3=192.0.2.131\n\tlocal vtep_ip=2001:db8:1000::1\n\tlocal all_zeros_grp=0.0.0.0\n\n\techo\n\techo \"Control path: (*, G) operations - IPv4 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tstar_g_common $ns1 $grp $src1 $src2 $src3 $vtep_ip $all_zeros_grp\n}\n\nstar_g_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp=ff0e::1\n\tlocal src1=2001:db8:100::1\n\tlocal src2=2001:db8:100::2\n\tlocal src3=2001:db8:100::3\n\tlocal vtep_ip=2001:db8:1000::1\n\tlocal all_zeros_grp=::\n\n\techo\n\techo \"Control path: (*, G) operations - IPv6 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tstar_g_common $ns1 $grp $src1 $src2 $src3 $vtep_ip $all_zeros_grp\n}\n\nsg_common()\n{\n\tlocal ns1=$1; shift\n\tlocal grp=$1; shift\n\tlocal src=$1; shift\n\tlocal vtep_ip=$1; shift\n\tlocal all_zeros_grp=$1; shift\n\n\t# Test control path operations specific to (S, G) entries.\n\n\t# Default filter mode.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp src $src permanent dst $vtep_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 -d -s mdb show dev vx0 | grep $grp | grep include\"\n\tlog_test $? 0 \"(S, G) MDB entry default filter mode\"\n\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp src $src permanent dst $vtep_ip src_vni 10010\"\n\n\t# Error cases.\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp src $src permanent filter_mode include dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"(S, G) with filter mode\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp src $src permanent source_list $src dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"(S, G) with source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $grp src $grp permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"(S, G) with an invalid source list\"\n\n\trun_cmd \"bridge -n $ns1 mdb add dev vx0 port vx0 grp $all_zeros_grp src $src permanent dst $vtep_ip src_vni 10010\"\n\tlog_test $? 255 \"All-zeros group with source\"\n}\n\nsg_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\tlocal vtep_ip=198.51.100.100\n\tlocal all_zeros_grp=0.0.0.0\n\n\techo\n\techo \"Control path: (S, G) operations - IPv4 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tsg_common $ns1 $grp $src $vtep_ip $all_zeros_grp\n}\n\nsg_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\tlocal vtep_ip=198.51.100.100\n\tlocal all_zeros_grp=::\n\n\techo\n\techo \"Control path: (S, G) operations - IPv6 overlay / IPv4 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tsg_common $ns1 $grp $src $vtep_ip $all_zeros_grp\n}\n\nsg_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\tlocal vtep_ip=2001:db8:1000::1\n\tlocal all_zeros_grp=0.0.0.0\n\n\techo\n\techo \"Control path: (S, G) operations - IPv4 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tsg_common $ns1 $grp $src $vtep_ip $all_zeros_grp\n}\n\nsg_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\tlocal vtep_ip=2001:db8:1000::1\n\tlocal all_zeros_grp=::\n\n\techo\n\techo \"Control path: (S, G) operations - IPv6 overlay / IPv6 underlay\"\n\techo \"--------------------------------------------------------------\"\n\n\tsg_common $ns1 $grp $src $vtep_ip $all_zeros_grp\n}\n\nipv4_grps_get()\n{\n\tlocal max_grps=$1; shift\n\tlocal i\n\n\tfor i in $(seq 0 $((max_grps - 1))); do\n\t\techo \"239.1.1.$i\"\n\tdone\n}\n\nipv6_grps_get()\n{\n\tlocal max_grps=$1; shift\n\tlocal i\n\n\tfor i in $(seq 0 $((max_grps - 1))); do\n\t\techo \"ff0e::$(printf %x $i)\"\n\tdone\n}\n\ndump_common()\n{\n\tlocal ns1=$1; shift\n\tlocal local_addr=$1; shift\n\tlocal remote_prefix=$1; shift\n\tlocal fn=$1; shift\n\tlocal max_vxlan_devs=2\n\tlocal max_remotes=64\n\tlocal max_grps=256\n\tlocal num_entries\n\tlocal batch_file\n\tlocal grp\n\tlocal i j\n\n\t# The kernel maintains various markers for the MDB dump. Add a test for\n\t# large scale MDB dump to make sure that all the configured entries are\n\t# dumped and that the markers are used correctly.\n\n\t# Create net devices.\n\tfor i in $(seq 1 $max_vxlan_devs); do\n\t\tip -n $ns1 link add name vx-test${i} up type vxlan \\\n\t\t\tlocal $local_addr dstport 4789 external vnifilter\n\tdone\n\n\t# Create batch file with MDB entries.\n\tbatch_file=$(mktemp)\n\tfor i in $(seq 1 $max_vxlan_devs); do\n\t\tfor j in $(seq 1 $max_remotes); do\n\t\t\tfor grp in $($fn $max_grps); do\n\t\t\t\techo \"mdb add dev vx-test${i} port vx-test${i} grp $grp permanent dst ${remote_prefix}${j}\" >> $batch_file\n\t\t\tdone\n\t\tdone\n\tdone\n\n\t# Program the batch file and check for expected number of entries.\n\tbridge -n $ns1 -b $batch_file\n\tfor i in $(seq 1 $max_vxlan_devs); do\n\t\tnum_entries=$(bridge -n $ns1 mdb show dev vx-test${i} | grep \"permanent\" | wc -l)\n\t\t[[ $num_entries -eq $((max_grps * max_remotes)) ]]\n\t\tlog_test $? 0 \"Large scale dump - VXLAN device #$i\"\n\tdone\n\n\trm -rf $batch_file\n}\n\ndump_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal local_addr=192.0.2.1\n\tlocal remote_prefix=198.51.100.\n\tlocal fn=ipv4_grps_get\n\n\techo\n\techo \"Control path: Large scale MDB dump - IPv4 overlay / IPv4 underlay\"\n\techo \"-----------------------------------------------------------------\"\n\n\tdump_common $ns1 $local_addr $remote_prefix $fn\n}\n\ndump_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal local_addr=192.0.2.1\n\tlocal remote_prefix=198.51.100.\n\tlocal fn=ipv6_grps_get\n\n\techo\n\techo \"Control path: Large scale MDB dump - IPv6 overlay / IPv4 underlay\"\n\techo \"-----------------------------------------------------------------\"\n\n\tdump_common $ns1 $local_addr $remote_prefix $fn\n}\n\ndump_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal local_addr=2001:db8:1::1\n\tlocal remote_prefix=2001:db8:1000::\n\tlocal fn=ipv4_grps_get\n\n\techo\n\techo \"Control path: Large scale MDB dump - IPv4 overlay / IPv6 underlay\"\n\techo \"-----------------------------------------------------------------\"\n\n\tdump_common $ns1 $local_addr $remote_prefix $fn\n}\n\ndump_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal local_addr=2001:db8:1::1\n\tlocal remote_prefix=2001:db8:1000::\n\tlocal fn=ipv6_grps_get\n\n\techo\n\techo \"Control path: Large scale MDB dump - IPv6 overlay / IPv6 underlay\"\n\techo \"-----------------------------------------------------------------\"\n\n\tdump_common $ns1 $local_addr $remote_prefix $fn\n}\n\n################################################################################\n# Tests - Data path\n\nencap_params_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal plen=$1; shift\n\tlocal enc_ethtype=$1; shift\n\tlocal grp=$1; shift\n\tlocal src=$1; shift\n\tlocal mz=$1; shift\n\n\t# Test that packets forwarded by the VXLAN MDB are encapsulated with\n\t# the correct parameters. Transmit packets from the first namespace and\n\t# check that they hit the corresponding filters on the ingress of the\n\t# second namespace.\n\n\trun_cmd \"tc -n $ns2 qdisc replace dev veth0 clsact\"\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"ip -n $ns2 address replace $vtep1_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep2_ip/$plen dev lo\"\n\n\t# Check destination IP.\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep2_ip src_vni 10020\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $vtep1_ip action pass\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Destination IP - match\"\n\n\trun_cmd \"ip netns exec $ns1 $mz br0.20 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Destination IP - no match\"\n\n\trun_cmd \"tc -n $ns2 filter del dev vx0 ingress pref 1 handle 101 flower\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep2_ip src_vni 10020\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep1_ip src_vni 10010\"\n\n\t# Check destination port.\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip dst_port 1111 src_vni 10020\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev veth0 ingress pref 1 handle 101 proto $enc_ethtype flower ip_proto udp dst_port 4789 action pass\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev veth0 ingress\" 101 1\n\tlog_test $? 0 \"Default destination port - match\"\n\n\trun_cmd \"ip netns exec $ns1 $mz br0.20 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev veth0 ingress\" 101 1\n\tlog_test $? 0 \"Default destination port - no match\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev veth0 ingress pref 1 handle 101 proto $enc_ethtype flower ip_proto udp dst_port 1111 action pass\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.20 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev veth0 ingress\" 101 1\n\tlog_test $? 0 \"Non-default destination port - match\"\n\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev veth0 ingress\" 101 1\n\tlog_test $? 0 \"Non-default destination port - no match\"\n\n\trun_cmd \"tc -n $ns2 filter del dev veth0 ingress pref 1 handle 101 flower\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep1_ip src_vni 10020\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep1_ip src_vni 10010\"\n\n\t# Check default VNI.\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip src_vni 10020\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_key_id 10010 action pass\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Default destination VNI - match\"\n\n\trun_cmd \"ip netns exec $ns1 $mz br0.20 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Default destination VNI - no match\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip vni 10020 src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip vni 10010 src_vni 10020\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_key_id 10020 action pass\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Non-default destination VNI - match\"\n\n\trun_cmd \"ip netns exec $ns1 $mz br0.20 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Non-default destination VNI - no match\"\n\n\trun_cmd \"tc -n $ns2 filter del dev vx0 ingress pref 1 handle 101 flower\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep1_ip src_vni 10020\"\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep1_ip src_vni 10010\"\n}\n\nencap_params_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal enc_ethtype=\"ip\"\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: Encapsulation parameters - IPv4 overlay / IPv4 underlay\"\n\techo \"------------------------------------------------------------------\"\n\n\tencap_params_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $enc_ethtype \\\n\t\t$grp $src \"mausezahn\"\n}\n\nencap_params_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal enc_ethtype=\"ip\"\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: Encapsulation parameters - IPv6 overlay / IPv4 underlay\"\n\techo \"------------------------------------------------------------------\"\n\n\tencap_params_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $enc_ethtype \\\n\t\t$grp $src \"mausezahn -6\"\n}\n\nencap_params_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal enc_ethtype=\"ipv6\"\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: Encapsulation parameters - IPv4 overlay / IPv6 underlay\"\n\techo \"------------------------------------------------------------------\"\n\n\tencap_params_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $enc_ethtype \\\n\t\t$grp $src \"mausezahn\"\n}\n\nencap_params_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal enc_ethtype=\"ipv6\"\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: Encapsulation parameters - IPv6 overlay / IPv6 underlay\"\n\techo \"------------------------------------------------------------------\"\n\n\tencap_params_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $enc_ethtype \\\n\t\t$grp $src \"mausezahn -6\"\n}\n\nstarg_exclude_ir_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal plen=$1; shift\n\tlocal grp=$1; shift\n\tlocal valid_src=$1; shift\n\tlocal invalid_src=$1; shift\n\tlocal mz=$1; shift\n\n\t# Install a (*, G) EXCLUDE MDB entry with one source and two remote\n\t# VTEPs. Make sure that the source in the source list is not forwarded\n\t# and that a source not in the list is forwarded. Remove one of the\n\t# VTEPs from the entry and make sure that packets are only forwarded to\n\t# the remaining VTEP.\n\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"ip -n $ns2 address replace $vtep1_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep2_ip/$plen dev lo\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $vtep1_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 102 proto all flower enc_dst_ip $vtep2_ip action pass\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $invalid_src dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $invalid_src dst $vtep2_ip src_vni 10010\"\n\n\t# Check that invalid source is not forwarded to any VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $invalid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 0\n\tlog_test $? 0 \"Block excluded source - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 0\n\tlog_test $? 0 \"Block excluded source - second VTEP\"\n\n\t# Check that valid source is forwarded to both VTEPs.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Forward valid source - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Forward valid source - second VTEP\"\n\n\t# Remove second VTEP.\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep2_ip src_vni 10010\"\n\n\t# Check that invalid source is not forwarded to any VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $invalid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Block excluded source after removal - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Block excluded source after removal - second VTEP\"\n\n\t# Check that valid source is forwarded to the remaining VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 2\n\tlog_test $? 0 \"Forward valid source after removal - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Forward valid source after removal - second VTEP\"\n}\n\nstarg_exclude_ir_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - IR - IPv4 overlay / IPv4 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_exclude_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_exclude_ir_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - IR - IPv6 overlay / IPv4 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_exclude_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_exclude_ir_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - IR - IPv4 overlay / IPv6 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_exclude_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_exclude_ir_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - IR - IPv6 overlay / IPv6 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_exclude_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_include_ir_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal plen=$1; shift\n\tlocal grp=$1; shift\n\tlocal valid_src=$1; shift\n\tlocal invalid_src=$1; shift\n\tlocal mz=$1; shift\n\n\t# Install a (*, G) INCLUDE MDB entry with one source and two remote\n\t# VTEPs. Make sure that the source in the source list is forwarded and\n\t# that a source not in the list is not forwarded. Remove one of the\n\t# VTEPs from the entry and make sure that packets are only forwarded to\n\t# the remaining VTEP.\n\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"ip -n $ns2 address replace $vtep1_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep2_ip/$plen dev lo\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $vtep1_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 102 proto all flower enc_dst_ip $vtep2_ip action pass\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode include source_list $valid_src dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode include source_list $valid_src dst $vtep2_ip src_vni 10010\"\n\n\t# Check that invalid source is not forwarded to any VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $invalid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 0\n\tlog_test $? 0 \"Block excluded source - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 0\n\tlog_test $? 0 \"Block excluded source - second VTEP\"\n\n\t# Check that valid source is forwarded to both VTEPs.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Forward valid source - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Forward valid source - second VTEP\"\n\n\t# Remove second VTEP.\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep2_ip src_vni 10010\"\n\n\t# Check that invalid source is not forwarded to any VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $invalid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Block excluded source after removal - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Block excluded source after removal - second VTEP\"\n\n\t# Check that valid source is forwarded to the remaining VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 2\n\tlog_test $? 0 \"Forward valid source after removal - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Forward valid source after removal - second VTEP\"\n}\n\nstarg_include_ir_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - IR - IPv4 overlay / IPv4 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_include_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_include_ir_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - IR - IPv6 overlay / IPv4 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_include_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_include_ir_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - IR - IPv4 overlay / IPv6 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_include_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_include_ir_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - IR - IPv6 overlay / IPv6 underlay\"\n\techo \"-------------------------------------------------------------\"\n\n\tstarg_include_ir_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_exclude_p2mp_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal mcast_grp=$1; shift\n\tlocal plen=$1; shift\n\tlocal grp=$1; shift\n\tlocal valid_src=$1; shift\n\tlocal invalid_src=$1; shift\n\tlocal mz=$1; shift\n\n\t# Install a (*, G) EXCLUDE MDB entry with one source and one multicast\n\t# group to which packets are sent. Make sure that the source in the\n\t# source list is not forwarded and that a source not in the list is\n\t# forwarded.\n\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"ip -n $ns2 address replace $mcast_grp/$plen dev veth0 autojoin\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $mcast_grp action pass\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode exclude source_list $invalid_src dst $mcast_grp src_vni 10010 via veth0\"\n\n\t# Check that invalid source is not forwarded.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $invalid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 0\n\tlog_test $? 0 \"Block excluded source\"\n\n\t# Check that valid source is forwarded.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Forward valid source\"\n\n\t# Remove the VTEP from the multicast group.\n\trun_cmd \"ip -n $ns2 address del $mcast_grp/$plen dev veth0\"\n\n\t# Check that valid source is not received anymore.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Receive of valid source after removal from group\"\n}\n\nstarg_exclude_p2mp_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal mcast_grp=238.1.1.1\n\tlocal plen=32\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - P2MP - IPv4 overlay / IPv4 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_exclude_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_exclude_p2mp_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal mcast_grp=238.1.1.1\n\tlocal plen=32\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - P2MP - IPv6 overlay / IPv4 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_exclude_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_exclude_p2mp_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal mcast_grp=ff0e::2\n\tlocal plen=128\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - P2MP - IPv4 overlay / IPv6 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_exclude_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_exclude_p2mp_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal mcast_grp=ff0e::2\n\tlocal plen=128\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) EXCLUDE - P2MP - IPv6 overlay / IPv6 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_exclude_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_include_p2mp_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal mcast_grp=$1; shift\n\tlocal plen=$1; shift\n\tlocal grp=$1; shift\n\tlocal valid_src=$1; shift\n\tlocal invalid_src=$1; shift\n\tlocal mz=$1; shift\n\n\t# Install a (*, G) INCLUDE MDB entry with one source and one multicast\n\t# group to which packets are sent. Make sure that the source in the\n\t# source list is forwarded and that a source not in the list is not\n\t# forwarded.\n\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"ip -n $ns2 address replace $mcast_grp/$plen dev veth0 autojoin\"\n\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $mcast_grp action pass\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent filter_mode include source_list $valid_src dst $mcast_grp src_vni 10010 via veth0\"\n\n\t# Check that invalid source is not forwarded.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $invalid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 0\n\tlog_test $? 0 \"Block excluded source\"\n\n\t# Check that valid source is forwarded.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Forward valid source\"\n\n\t# Remove the VTEP from the multicast group.\n\trun_cmd \"ip -n $ns2 address del $mcast_grp/$plen dev veth0\"\n\n\t# Check that valid source is not received anymore.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $valid_src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Receive of valid source after removal from group\"\n}\n\nstarg_include_p2mp_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal mcast_grp=238.1.1.1\n\tlocal plen=32\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - P2MP - IPv4 overlay / IPv4 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_include_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_include_p2mp_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal mcast_grp=238.1.1.1\n\tlocal plen=32\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - P2MP - IPv6 overlay / IPv4 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_include_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\nstarg_include_p2mp_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal mcast_grp=ff0e::2\n\tlocal plen=128\n\tlocal grp=239.1.1.1\n\tlocal valid_src=192.0.2.129\n\tlocal invalid_src=192.0.2.145\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - P2MP - IPv4 overlay / IPv6 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_include_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn\"\n}\n\nstarg_include_p2mp_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal mcast_grp=ff0e::2\n\tlocal plen=128\n\tlocal grp=ff0e::1\n\tlocal valid_src=2001:db8:100::1\n\tlocal invalid_src=2001:db8:200::1\n\n\techo\n\techo \"Data path: (*, G) INCLUDE - P2MP - IPv6 overlay / IPv6 underlay\"\n\techo \"---------------------------------------------------------------\"\n\n\tstarg_include_p2mp_common $ns1 $ns2 $mcast_grp $plen $grp \\\n\t\t$valid_src $invalid_src \"mausezahn -6\"\n}\n\negress_vni_translation_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal mcast_grp=$1; shift\n\tlocal plen=$1; shift\n\tlocal proto=$1; shift\n\tlocal grp=$1; shift\n\tlocal src=$1; shift\n\tlocal mz=$1; shift\n\n\t# When P2MP tunnels are used with optimized inter-subnet multicast\n\t# (OISM) [1], the ingress VTEP does not perform VNI translation and\n\t# uses the VNI of the source broadcast domain (BD). If the egress VTEP\n\t# is a member in the source BD, then no VNI translation is needed.\n\t# Otherwise, the egress VTEP needs to translate the VNI to the\n\t# supplementary broadcast domain (SBD) VNI, which is usually the L3VNI.\n\t#\n\t# In this test, remove the VTEP in the second namespace from VLAN 10\n\t# (VNI 10010) and make sure that a packet sent from this VLAN on the\n\t# first VTEP is received by the SVI corresponding to the L3VNI (14000 /\n\t# VLAN 4000) on the second VTEP.\n\t#\n\t# The second VTEP will be able to decapsulate the packet with VNI 10010\n\t# because this VNI is configured on its shared VXLAN device. Later,\n\t# when ingressing the bridge, the VNI to VLAN lookup will fail because\n\t# the VTEP is not a member in VLAN 10, which will cause the packet to\n\t# be tagged with VLAN 4000 since it is configured as PVID.\n\t#\n\t# [1] https://datatracker.ietf.org/doc/html/draft-ietf-bess-evpn-irb-mcast\n\n\trun_cmd \"tc -n $ns2 qdisc replace dev br0.4000 clsact\"\n\trun_cmd \"ip -n $ns2 address replace $mcast_grp/$plen dev veth0 autojoin\"\n\trun_cmd \"tc -n $ns2 filter replace dev br0.4000 ingress pref 1 handle 101 proto $proto flower src_ip $src dst_ip $grp action pass\"\n\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp src $src permanent dst $mcast_grp src_vni 10010 via veth0\"\n\n\t# Remove the second VTEP from VLAN 10.\n\trun_cmd \"bridge -n $ns2 vlan del vid 10 dev vx0\"\n\n\t# Make sure that packets sent from the first VTEP over VLAN 10 are\n\t# received by the SVI corresponding to the L3VNI (14000 / VLAN 4000) on\n\t# the second VTEP, since it is configured as PVID.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev br0.4000 ingress\" 101 1\n\tlog_test $? 0 \"Egress VNI translation - PVID configured\"\n\n\t# Remove PVID flag from VLAN 4000 on the second VTEP and make sure\n\t# packets are no longer received by the SVI interface.\n\trun_cmd \"bridge -n $ns2 vlan add vid 4000 dev vx0\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev br0.4000 ingress\" 101 1\n\tlog_test $? 0 \"Egress VNI translation - no PVID configured\"\n\n\t# Reconfigure the PVID and make sure packets are received again.\n\trun_cmd \"bridge -n $ns2 vlan add vid 4000 dev vx0 pvid\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev br0.4000 ingress\" 101 2\n\tlog_test $? 0 \"Egress VNI translation - PVID reconfigured\"\n}\n\negress_vni_translation_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal mcast_grp=238.1.1.1\n\tlocal plen=32\n\tlocal proto=\"ipv4\"\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: Egress VNI translation - IPv4 overlay / IPv4 underlay\"\n\techo \"----------------------------------------------------------------\"\n\n\tegress_vni_translation_common $ns1 $ns2 $mcast_grp $plen $proto $grp \\\n\t\t$src \"mausezahn\"\n}\n\negress_vni_translation_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal mcast_grp=238.1.1.1\n\tlocal plen=32\n\tlocal proto=\"ipv6\"\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: Egress VNI translation - IPv6 overlay / IPv4 underlay\"\n\techo \"----------------------------------------------------------------\"\n\n\tegress_vni_translation_common $ns1 $ns2 $mcast_grp $plen $proto $grp \\\n\t\t$src \"mausezahn -6\"\n}\n\negress_vni_translation_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal mcast_grp=ff0e::2\n\tlocal plen=128\n\tlocal proto=\"ipv4\"\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: Egress VNI translation - IPv4 overlay / IPv6 underlay\"\n\techo \"----------------------------------------------------------------\"\n\n\tegress_vni_translation_common $ns1 $ns2 $mcast_grp $plen $proto $grp \\\n\t\t$src \"mausezahn\"\n}\n\negress_vni_translation_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal mcast_grp=ff0e::2\n\tlocal plen=128\n\tlocal proto=\"ipv6\"\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: Egress VNI translation - IPv6 overlay / IPv6 underlay\"\n\techo \"----------------------------------------------------------------\"\n\n\tegress_vni_translation_common $ns1 $ns2 $mcast_grp $plen $proto $grp \\\n\t\t$src \"mausezahn -6\"\n}\n\nall_zeros_mdb_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal vtep3_ip=$1; shift\n\tlocal vtep4_ip=$1; shift\n\tlocal plen=$1; shift\n\tlocal ipv4_grp=239.1.1.1\n\tlocal ipv4_unreg_grp=239.2.2.2\n\tlocal ipv4_ll_grp=224.0.0.100\n\tlocal ipv4_src=192.0.2.129\n\tlocal ipv6_grp=ff0e::1\n\tlocal ipv6_unreg_grp=ff0e::2\n\tlocal ipv6_ll_grp=ff02::1\n\tlocal ipv6_src=2001:db8:100::1\n\n\t# Install all-zeros (catchall) MDB entries for IPv4 and IPv6 traffic\n\t# and make sure they only forward unregistered IP multicast traffic\n\t# which is not link-local. Also make sure that each entry only forwards\n\t# traffic from the matching address family.\n\n\t# Associate two different VTEPs with one all-zeros MDB entry: Two with\n\t# the IPv4 entry (0.0.0.0) and another two with the IPv6 one (::).\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp 0.0.0.0 permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp 0.0.0.0 permanent dst $vtep2_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp :: permanent dst $vtep3_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp :: permanent dst $vtep4_ip src_vni 10010\"\n\n\t# Associate one VTEP from each set with a regular MDB entry: One with\n\t# an IPv4 entry and another with an IPv6 one.\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $ipv4_grp permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $ipv6_grp permanent dst $vtep3_ip src_vni 10010\"\n\n\t# Add filters to match on decapsulated traffic in the second namespace.\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $vtep1_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 102 proto all flower enc_dst_ip $vtep2_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 103 proto all flower enc_dst_ip $vtep3_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 104 proto all flower enc_dst_ip $vtep4_ip action pass\"\n\n\t# Configure the VTEP addresses in the second namespace to enable\n\t# decapsulation.\n\trun_cmd \"ip -n $ns2 address replace $vtep1_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep2_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep3_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep4_ip/$plen dev lo\"\n\n\t# Send registered IPv4 multicast and make sure it only arrives to the\n\t# first VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn br0.10 -A $ipv4_src -B $ipv4_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Registered IPv4 multicast - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 0\n\tlog_test $? 0 \"Registered IPv4 multicast - second VTEP\"\n\n\t# Send unregistered IPv4 multicast that is not link-local and make sure\n\t# it arrives to the first and second VTEPs.\n\trun_cmd \"ip netns exec $ns1 mausezahn br0.10 -A $ipv4_src -B $ipv4_unreg_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 2\n\tlog_test $? 0 \"Unregistered IPv4 multicast - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Unregistered IPv4 multicast - second VTEP\"\n\n\t# Send IPv4 link-local multicast traffic and make sure it does not\n\t# arrive to any VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn br0.10 -A $ipv4_src -B $ipv4_ll_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 2\n\tlog_test $? 0 \"Link-local IPv4 multicast - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Link-local IPv4 multicast - second VTEP\"\n\n\t# Send registered IPv4 multicast using a unicast MAC address and make\n\t# sure it does not arrive to any VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn br0.10 -a own -b 00:11:22:33:44:55 -A $ipv4_src -B $ipv4_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 2\n\tlog_test $? 0 \"Registered IPv4 multicast with a unicast MAC - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Registered IPv4 multicast with a unicast MAC - second VTEP\"\n\n\t# Send registered IPv4 multicast using a broadcast MAC address and make\n\t# sure it does not arrive to any VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn br0.10 -a own -b bcast -A $ipv4_src -B $ipv4_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 2\n\tlog_test $? 0 \"Registered IPv4 multicast with a broadcast MAC - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Registered IPv4 multicast with a broadcast MAC - second VTEP\"\n\n\t# Make sure IPv4 traffic did not reach the VTEPs associated with\n\t# IPv6 entries.\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 103 0\n\tlog_test $? 0 \"IPv4 traffic - third VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 104 0\n\tlog_test $? 0 \"IPv4 traffic - fourth VTEP\"\n\n\t# Reset IPv4 filters before testing IPv6 traffic.\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto all flower enc_dst_ip $vtep1_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 102 proto all flower enc_dst_ip $vtep2_ip action pass\"\n\n\t# Send registered IPv6 multicast and make sure it only arrives to the\n\t# third VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn -6 br0.10 -A $ipv6_src -B $ipv6_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 103 1\n\tlog_test $? 0 \"Registered IPv6 multicast - third VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 104 0\n\tlog_test $? 0 \"Registered IPv6 multicast - fourth VTEP\"\n\n\t# Send unregistered IPv6 multicast that is not link-local and make sure\n\t# it arrives to the third and fourth VTEPs.\n\trun_cmd \"ip netns exec $ns1 mausezahn -6 br0.10 -A $ipv6_src -B $ipv6_unreg_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 103 2\n\tlog_test $? 0 \"Unregistered IPv6 multicast - third VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 104 1\n\tlog_test $? 0 \"Unregistered IPv6 multicast - fourth VTEP\"\n\n\t# Send IPv6 link-local multicast traffic and make sure it does not\n\t# arrive to any VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn -6 br0.10 -A $ipv6_src -B $ipv6_ll_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 103 2\n\tlog_test $? 0 \"Link-local IPv6 multicast - third VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 104 1\n\tlog_test $? 0 \"Link-local IPv6 multicast - fourth VTEP\"\n\n\t# Send registered IPv6 multicast using a unicast MAC address and make\n\t# sure it does not arrive to any VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn -6 br0.10 -a own -b 00:11:22:33:44:55 -A $ipv6_src -B $ipv6_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 103 2\n\tlog_test $? 0 \"Registered IPv6 multicast with a unicast MAC - third VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 104 1\n\tlog_test $? 0 \"Registered IPv6 multicast with a unicast MAC - fourth VTEP\"\n\n\t# Send registered IPv6 multicast using a broadcast MAC address and make\n\t# sure it does not arrive to any VTEP.\n\trun_cmd \"ip netns exec $ns1 mausezahn -6 br0.10 -a own -b bcast -A $ipv6_src -B $ipv6_grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 103 2\n\tlog_test $? 0 \"Registered IPv6 multicast with a broadcast MAC - third VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 104 1\n\tlog_test $? 0 \"Registered IPv6 multicast with a broadcast MAC - fourth VTEP\"\n\n\t# Make sure IPv6 traffic did not reach the VTEPs associated with\n\t# IPv4 entries.\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 0\n\tlog_test $? 0 \"IPv6 traffic - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 0\n\tlog_test $? 0 \"IPv6 traffic - second VTEP\"\n}\n\nall_zeros_mdb_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.101\n\tlocal vtep2_ip=198.51.100.102\n\tlocal vtep3_ip=198.51.100.103\n\tlocal vtep4_ip=198.51.100.104\n\tlocal plen=32\n\n\techo\n\techo \"Data path: All-zeros MDB entry - IPv4 underlay\"\n\techo \"----------------------------------------------\"\n\n\tall_zeros_mdb_common $ns1 $ns2 $vtep1_ip $vtep2_ip $vtep3_ip \\\n\t\t$vtep4_ip $plen\n}\n\nall_zeros_mdb_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal vtep3_ip=2001:db8:3000::1\n\tlocal vtep4_ip=2001:db8:4000::1\n\tlocal plen=128\n\n\techo\n\techo \"Data path: All-zeros MDB entry - IPv6 underlay\"\n\techo \"----------------------------------------------\"\n\n\tall_zeros_mdb_common $ns1 $ns2 $vtep1_ip $vtep2_ip $vtep3_ip \\\n\t\t$vtep4_ip $plen\n}\n\nmdb_fdb_common()\n{\n\tlocal ns1=$1; shift\n\tlocal ns2=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal plen=$1; shift\n\tlocal proto=$1; shift\n\tlocal grp=$1; shift\n\tlocal src=$1; shift\n\tlocal mz=$1; shift\n\n\t# Install an MDB entry and an FDB entry and make sure that the FDB\n\t# entry only forwards traffic that was not forwarded by the MDB.\n\n\t# Associate the MDB entry with one VTEP and the FDB entry with another\n\t# VTEP.\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 fdb add 00:00:00:00:00:00 dev vx0 self static dst $vtep2_ip src_vni 10010\"\n\n\t# Add filters to match on decapsulated traffic in the second namespace.\n\trun_cmd \"tc -n $ns2 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 101 proto $proto flower ip_proto udp dst_port 54321 enc_dst_ip $vtep1_ip action pass\"\n\trun_cmd \"tc -n $ns2 filter replace dev vx0 ingress pref 1 handle 102 proto $proto flower ip_proto udp dst_port 54321 enc_dst_ip $vtep2_ip action pass\"\n\n\t# Configure the VTEP addresses in the second namespace to enable\n\t# decapsulation.\n\trun_cmd \"ip -n $ns2 address replace $vtep1_ip/$plen dev lo\"\n\trun_cmd \"ip -n $ns2 address replace $vtep2_ip/$plen dev lo\"\n\n\t# Send IP multicast traffic and make sure it is forwarded by the MDB\n\t# and only arrives to the first VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"IP multicast - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 0\n\tlog_test $? 0 \"IP multicast - second VTEP\"\n\n\t# Send broadcast traffic and make sure it is forwarded by the FDB and\n\t# only arrives to the second VTEP.\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -a own -b bcast -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"Broadcast - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 1\n\tlog_test $? 0 \"Broadcast - second VTEP\"\n\n\t# Remove the MDB entry and make sure that IP multicast is now forwarded\n\t# by the FDB to the second VTEP.\n\trun_cmd \"bridge -n $ns1 mdb del dev vx0 port vx0 grp $grp dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"ip netns exec $ns1 $mz br0.10 -A $src -B $grp -t udp sp=12345,dp=54321 -p 100 -c 1 -q\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 101 1\n\tlog_test $? 0 \"IP multicast after removal - first VTEP\"\n\ttc_check_packets \"$ns2\" \"dev vx0 ingress\" 102 2\n\tlog_test $? 0 \"IP multicast after removal - second VTEP\"\n}\n\nmdb_fdb_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal proto=\"ipv4\"\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: MDB with FDB - IPv4 overlay / IPv4 underlay\"\n\techo \"------------------------------------------------------\"\n\n\tmdb_fdb_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $proto $grp $src \\\n\t\t\"mausezahn\"\n}\n\nmdb_fdb_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal ns2=ns2_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal plen=32\n\tlocal proto=\"ipv6\"\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: MDB with FDB - IPv6 overlay / IPv4 underlay\"\n\techo \"------------------------------------------------------\"\n\n\tmdb_fdb_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $proto $grp $src \\\n\t\t\"mausezahn -6\"\n}\n\nmdb_fdb_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal proto=\"ipv4\"\n\tlocal grp=239.1.1.1\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: MDB with FDB - IPv4 overlay / IPv6 underlay\"\n\techo \"------------------------------------------------------\"\n\n\tmdb_fdb_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $proto $grp $src \\\n\t\t\"mausezahn\"\n}\n\nmdb_fdb_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal ns2=ns2_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal plen=128\n\tlocal proto=\"ipv6\"\n\tlocal grp=ff0e::1\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: MDB with FDB - IPv6 overlay / IPv6 underlay\"\n\techo \"------------------------------------------------------\"\n\n\tmdb_fdb_common $ns1 $ns2 $vtep1_ip $vtep2_ip $plen $proto $grp $src \\\n\t\t\"mausezahn -6\"\n}\n\nmdb_grp1_loop()\n{\n\tlocal ns1=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal grp1=$1; shift\n\n\twhile true; do\n\t\tbridge -n $ns1 mdb del dev vx0 port vx0 grp $grp1 dst $vtep1_ip src_vni 10010\n\t\tbridge -n $ns1 mdb add dev vx0 port vx0 grp $grp1 permanent dst $vtep1_ip src_vni 10010\n\tdone >/dev/null 2>&1\n}\n\nmdb_grp2_loop()\n{\n\tlocal ns1=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal grp2=$1; shift\n\n\twhile true; do\n\t\tbridge -n $ns1 mdb del dev vx0 port vx0 grp $grp2 dst $vtep1_ip src_vni 10010\n\t\tbridge -n $ns1 mdb add dev vx0 port vx0 grp $grp2 permanent dst $vtep1_ip src_vni 10010\n\t\tbridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp2 permanent dst $vtep2_ip src_vni 10010\n\tdone >/dev/null 2>&1\n}\n\nmdb_torture_common()\n{\n\tlocal ns1=$1; shift\n\tlocal vtep1_ip=$1; shift\n\tlocal vtep2_ip=$1; shift\n\tlocal grp1=$1; shift\n\tlocal grp2=$1; shift\n\tlocal src=$1; shift\n\tlocal mz=$1; shift\n\tlocal pid1\n\tlocal pid2\n\tlocal pid3\n\tlocal pid4\n\n\t# Continuously send two streams that are forwarded by two different MDB\n\t# entries. The first entry will be added and deleted in a loop. This\n\t# allows us to test that the data path does not use freed MDB entry\n\t# memory. The second entry will have two remotes, one that is added and\n\t# deleted in a loop and another that is replaced in a loop. This allows\n\t# us to test that the data path does not use freed remote entry memory.\n\t# The test is considered successful if nothing crashed.\n\n\t# Create the MDB entries that will be continuously deleted / replaced.\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp1 permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp2 permanent dst $vtep1_ip src_vni 10010\"\n\trun_cmd \"bridge -n $ns1 mdb replace dev vx0 port vx0 grp $grp2 permanent dst $vtep2_ip src_vni 10010\"\n\n\tmdb_grp1_loop $ns1 $vtep1_ip $grp1 &\n\tpid1=$!\n\tmdb_grp2_loop $ns1 $vtep1_ip $vtep2_ip $grp2 &\n\tpid2=$!\n\tip netns exec $ns1 $mz br0.10 -A $src -B $grp1 -t udp sp=12345,dp=54321 -p 100 -c 0 -q &\n\tpid3=$!\n\tip netns exec $ns1 $mz br0.10 -A $src -B $grp2 -t udp sp=12345,dp=54321 -p 100 -c 0 -q &\n\tpid4=$!\n\n\tsleep 30\n\tkill -9 $pid1 $pid2 $pid3 $pid4\n\twait $pid1 $pid2 $pid3 $pid4 2>/dev/null\n\n\tlog_test 0 0 \"Torture test\"\n}\n\nmdb_torture_ipv4_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal grp1=239.1.1.1\n\tlocal grp2=239.2.2.2\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: MDB torture test - IPv4 overlay / IPv4 underlay\"\n\techo \"----------------------------------------------------------\"\n\n\tmdb_torture_common $ns1 $vtep1_ip $vtep2_ip $grp1 $grp2 $src \\\n\t\t\"mausezahn\"\n}\n\nmdb_torture_ipv6_ipv4()\n{\n\tlocal ns1=ns1_v4\n\tlocal vtep1_ip=198.51.100.100\n\tlocal vtep2_ip=198.51.100.200\n\tlocal grp1=ff0e::1\n\tlocal grp2=ff0e::2\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: MDB torture test - IPv6 overlay / IPv4 underlay\"\n\techo \"----------------------------------------------------------\"\n\n\tmdb_torture_common $ns1 $vtep1_ip $vtep2_ip $grp1 $grp2 $src \\\n\t\t\"mausezahn -6\"\n}\n\nmdb_torture_ipv4_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal grp1=239.1.1.1\n\tlocal grp2=239.2.2.2\n\tlocal src=192.0.2.129\n\n\techo\n\techo \"Data path: MDB torture test - IPv4 overlay / IPv6 underlay\"\n\techo \"----------------------------------------------------------\"\n\n\tmdb_torture_common $ns1 $vtep1_ip $vtep2_ip $grp1 $grp2 $src \\\n\t\t\"mausezahn\"\n}\n\nmdb_torture_ipv6_ipv6()\n{\n\tlocal ns1=ns1_v6\n\tlocal vtep1_ip=2001:db8:1000::1\n\tlocal vtep2_ip=2001:db8:2000::1\n\tlocal grp1=ff0e::1\n\tlocal grp2=ff0e::2\n\tlocal src=2001:db8:100::1\n\n\techo\n\techo \"Data path: MDB torture test - IPv6 overlay / IPv6 underlay\"\n\techo \"----------------------------------------------------------\"\n\n\tmdb_torture_common $ns1 $vtep1_ip $vtep2_ip $grp1 $grp2 $src \\\n\t\t\"mausezahn -6\"\n}\n\n################################################################################\n# Usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $TESTS)\n        -c          Control path tests only\n        -d          Data path tests only\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\n        -v          Verbose mode (show commands and output)\nEOF\n}\n\n################################################################################\n# Main\n\ntrap cleanup EXIT\n\nwhile getopts \":t:cdpPvh\" opt; do\n\tcase $opt in\n\t\tt) TESTS=$OPTARG;;\n\t\tc) TESTS=${CONTROL_PATH_TESTS};;\n\t\td) TESTS=${DATA_PATH_TESTS};;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# Make sure we don't pause twice.\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v bridge)\" ]; then\n\techo \"SKIP: Could not run test without bridge tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v mausezahn)\" ]; then\n\techo \"SKIP: Could not run test without mausezahn tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v jq)\" ]; then\n\techo \"SKIP: Could not run test without jq tool\"\n\texit $ksft_skip\nfi\n\nbridge mdb help 2>&1 | grep -q \"src_vni\"\nif [ $? -ne 0 ]; then\n   echo \"SKIP: iproute2 bridge too old, missing VXLAN MDB support\"\n   exit $ksft_skip\nfi\n\n# Start clean.\ncleanup\n\nfor t in $TESTS\ndo\n\tsetup; $t; cleanup;\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}