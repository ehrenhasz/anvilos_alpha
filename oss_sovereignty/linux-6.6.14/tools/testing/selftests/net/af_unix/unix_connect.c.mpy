{
  "module_name": "unix_connect.c",
  "hash_id": "71894b209ba79ccc1cff71e078e2410d73ff153ba758ee402edd5c854ac7c1fa",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/af_unix/unix_connect.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <sched.h>\n\n#include <stddef.h>\n#include <stdio.h>\n#include <unistd.h>\n\n#include <sys/socket.h>\n#include <sys/un.h>\n\n#include \"../../kselftest_harness.h\"\n\nFIXTURE(unix_connect)\n{\n\tint server, client;\n\tint family;\n};\n\nFIXTURE_VARIANT(unix_connect)\n{\n\tint type;\n\tchar sun_path[8];\n\tint len;\n\tint flags;\n\tint err;\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, stream_pathname)\n{\n\t.type = SOCK_STREAM,\n\t.sun_path = \"test\",\n\t.len = 4 + 1,\n\t.flags = 0,\n\t.err = 0,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, stream_abstract)\n{\n\t.type = SOCK_STREAM,\n\t.sun_path = \"\\0test\",\n\t.len = 5,\n\t.flags = 0,\n\t.err = 0,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, stream_pathname_netns)\n{\n\t.type = SOCK_STREAM,\n\t.sun_path = \"test\",\n\t.len = 4 + 1,\n\t.flags = CLONE_NEWNET,\n\t.err = 0,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, stream_abstract_netns)\n{\n\t.type = SOCK_STREAM,\n\t.sun_path = \"\\0test\",\n\t.len = 5,\n\t.flags = CLONE_NEWNET,\n\t.err = ECONNREFUSED,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, dgram_pathname)\n{\n\t.type = SOCK_DGRAM,\n\t.sun_path = \"test\",\n\t.len = 4 + 1,\n\t.flags = 0,\n\t.err = 0,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, dgram_abstract)\n{\n\t.type = SOCK_DGRAM,\n\t.sun_path = \"\\0test\",\n\t.len = 5,\n\t.flags = 0,\n\t.err = 0,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, dgram_pathname_netns)\n{\n\t.type = SOCK_DGRAM,\n\t.sun_path = \"test\",\n\t.len = 4 + 1,\n\t.flags = CLONE_NEWNET,\n\t.err = 0,\n};\n\nFIXTURE_VARIANT_ADD(unix_connect, dgram_abstract_netns)\n{\n\t.type = SOCK_DGRAM,\n\t.sun_path = \"\\0test\",\n\t.len = 5,\n\t.flags = CLONE_NEWNET,\n\t.err = ECONNREFUSED,\n};\n\nFIXTURE_SETUP(unix_connect)\n{\n\tself->family = AF_UNIX;\n}\n\nFIXTURE_TEARDOWN(unix_connect)\n{\n\tclose(self->server);\n\tclose(self->client);\n\n\tif (variant->sun_path[0])\n\t\tremove(\"test\");\n}\n\nTEST_F(unix_connect, test)\n{\n\tsocklen_t addrlen;\n\tstruct sockaddr_un addr = {\n\t\t.sun_family = self->family,\n\t};\n\tint err;\n\n\tself->server = socket(self->family, variant->type, 0);\n\tASSERT_NE(-1, self->server);\n\n\taddrlen = offsetof(struct sockaddr_un, sun_path) + variant->len;\n\tmemcpy(&addr.sun_path, variant->sun_path, variant->len);\n\n\terr = bind(self->server, (struct sockaddr *)&addr, addrlen);\n\tASSERT_EQ(0, err);\n\n\tif (variant->type == SOCK_STREAM) {\n\t\terr = listen(self->server, 32);\n\t\tASSERT_EQ(0, err);\n\t}\n\n\terr = unshare(variant->flags);\n\tASSERT_EQ(0, err);\n\n\tself->client = socket(self->family, variant->type, 0);\n\tASSERT_LT(0, self->client);\n\n\terr = connect(self->client, (struct sockaddr *)&addr, addrlen);\n\tASSERT_EQ(variant->err, err == -1 ? errno : 0);\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}