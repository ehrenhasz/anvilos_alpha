{
  "module_name": "test_unix_oob.c",
  "hash_id": "64ad2966ead007cbdf604aea22bf5fce1395d11097270f483879a4b7c8c910a7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/af_unix/test_unix_oob.c",
  "human_readable_source": "\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/socket.h>\n#include <arpa/inet.h>\n#include <unistd.h>\n#include <string.h>\n#include <fcntl.h>\n#include <sys/ioctl.h>\n#include <errno.h>\n#include <netinet/tcp.h>\n#include <sys/un.h>\n#include <sys/signal.h>\n#include <sys/poll.h>\n\nstatic int pipefd[2];\nstatic int signal_recvd;\nstatic pid_t producer_id;\nstatic char sock_name[32];\n\nstatic void sig_hand(int sn, siginfo_t *si, void *p)\n{\n\tsignal_recvd = sn;\n}\n\nstatic int set_sig_handler(int signal)\n{\n\tstruct sigaction sa;\n\n\tsa.sa_sigaction = sig_hand;\n\tsigemptyset(&sa.sa_mask);\n\tsa.sa_flags = SA_SIGINFO | SA_RESTART;\n\n\treturn sigaction(signal, &sa, NULL);\n}\n\nstatic void set_filemode(int fd, int set)\n{\n\tint flags = fcntl(fd, F_GETFL, 0);\n\n\tif (set)\n\t\tflags &= ~O_NONBLOCK;\n\telse\n\t\tflags |= O_NONBLOCK;\n\tfcntl(fd, F_SETFL, flags);\n}\n\nstatic void signal_producer(int fd)\n{\n\tchar cmd;\n\n\tcmd = 'S';\n\twrite(fd, &cmd, sizeof(cmd));\n}\n\nstatic void wait_for_signal(int fd)\n{\n\tchar buf[5];\n\n\tread(fd, buf, 5);\n}\n\nstatic void die(int status)\n{\n\tfflush(NULL);\n\tunlink(sock_name);\n\tkill(producer_id, SIGTERM);\n\texit(status);\n}\n\nint is_sioctatmark(int fd)\n{\n\tint ans = -1;\n\n\tif (ioctl(fd, SIOCATMARK, &ans, sizeof(ans)) < 0) {\n#ifdef DEBUG\n\t\tperror(\"SIOCATMARK Failed\");\n#endif\n\t}\n\treturn ans;\n}\n\nvoid read_oob(int fd, char *c)\n{\n\n\t*c = ' ';\n\tif (recv(fd, c, sizeof(*c), MSG_OOB) < 0) {\n#ifdef DEBUG\n\t\tperror(\"Reading MSG_OOB Failed\");\n#endif\n\t}\n}\n\nint read_data(int pfd, char *buf, int size)\n{\n\tint len = 0;\n\n\tmemset(buf, size, '0');\n\tlen = read(pfd, buf, size);\n#ifdef DEBUG\n\tif (len < 0)\n\t\tperror(\"read failed\");\n#endif\n\treturn len;\n}\n\nstatic void wait_for_data(int pfd, int event)\n{\n\tstruct pollfd pfds[1];\n\n\tpfds[0].fd = pfd;\n\tpfds[0].events = event;\n\tpoll(pfds, 1, -1);\n}\n\nvoid producer(struct sockaddr_un *consumer_addr)\n{\n\tint cfd;\n\tchar buf[64];\n\tint i;\n\n\tmemset(buf, 'x', sizeof(buf));\n\tcfd = socket(AF_UNIX, SOCK_STREAM, 0);\n\n\twait_for_signal(pipefd[0]);\n\tif (connect(cfd, (struct sockaddr *)consumer_addr,\n\t\t     sizeof(*consumer_addr)) != 0) {\n\t\tperror(\"Connect failed\");\n\t\tkill(0, SIGTERM);\n\t\texit(1);\n\t}\n\n\tfor (i = 0; i < 2; i++) {\n\t\t \n\t\twait_for_signal(pipefd[0]);\n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tbuf[63] = '@';\n\t\tsend(cfd, buf, sizeof(buf), MSG_OOB);\n\n\t\twait_for_signal(pipefd[0]);\n\n\t\t \n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tbuf[63] = '%';\n\t\tsend(cfd, buf, sizeof(buf), MSG_OOB);\n\n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tbuf[63] = '#';\n\t\tsend(cfd, buf, sizeof(buf), MSG_OOB);\n\n\t\twait_for_signal(pipefd[0]);\n\n\t\t \n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tbuf[63] = '@';\n\t\tsend(cfd, buf, sizeof(buf), MSG_OOB);\n\n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tbuf[63] = '%';\n\t\tsend(cfd, buf, sizeof(buf), MSG_OOB);\n\n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tsend(cfd, buf, sizeof(buf), 0);\n\n\t\twait_for_signal(pipefd[0]);\n\n\t\t \n\t\tmemset(buf, 'x', sizeof(buf));\n\t\tbuf[0] = '@';\n\t\tsend(cfd, buf, 1, MSG_OOB);\n\t}\n}\n\nint\nmain(int argc, char **argv)\n{\n\tint lfd, pfd;\n\tstruct sockaddr_un consumer_addr, paddr;\n\tsocklen_t len = sizeof(consumer_addr);\n\tchar buf[1024];\n\tint on = 0;\n\tchar oob;\n\tint flags;\n\tint atmark;\n\tchar *tmp_file;\n\n\tlfd = socket(AF_UNIX, SOCK_STREAM, 0);\n\tmemset(&consumer_addr, 0, sizeof(consumer_addr));\n\tconsumer_addr.sun_family = AF_UNIX;\n\tsprintf(sock_name, \"unix_oob_%d\", getpid());\n\tunlink(sock_name);\n\tstrcpy(consumer_addr.sun_path, sock_name);\n\n\tif ((bind(lfd, (struct sockaddr *)&consumer_addr,\n\t\t  sizeof(consumer_addr))) != 0) {\n\t\tperror(\"socket bind failed\");\n\t\texit(1);\n\t}\n\n\tpipe(pipefd);\n\n\tlisten(lfd, 1);\n\n\tproducer_id = fork();\n\tif (producer_id == 0) {\n\t\tproducer(&consumer_addr);\n\t\texit(0);\n\t}\n\n\tset_sig_handler(SIGURG);\n\tsignal_producer(pipefd[1]);\n\n\tpfd = accept(lfd, (struct sockaddr *) &paddr, &len);\n\tfcntl(pfd, F_SETOWN, getpid());\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\twait_for_data(pfd, POLLPRI);\n\tread_oob(pfd, &oob);\n\tlen = read_data(pfd, buf, 1024);\n\tif (!signal_recvd || len != 63 || oob != '@') {\n\t\tfprintf(stderr, \"Test 1 failed sigurg %d len %d %c\\n\",\n\t\t\t signal_recvd, len, oob);\n\t\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\twait_for_data(pfd, POLLIN | POLLPRI);\n\tlen = 0;\n\twhile (len < 70)\n\t\tlen = recv(pfd, buf, 1024, MSG_PEEK);\n\tlen = read_data(pfd, buf, 1024);\n\tread_oob(pfd, &oob);\n\tif (!signal_recvd || len != 127 || oob != '#') {\n\t\tfprintf(stderr, \"Test 2 failed, sigurg %d len %d OOB %c\\n\",\n\t\tsignal_recvd, len, oob);\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\tlen = 0;\n\twait_for_data(pfd, POLLIN | POLLPRI);\n\twhile (len < 150)\n\t\tlen = recv(pfd, buf, 1024, MSG_PEEK);\n\tlen = read_data(pfd, buf, 1024);\n\tatmark = is_sioctatmark(pfd);\n\tread_oob(pfd, &oob);\n\n\tif (!signal_recvd || len != 127 || oob != '%' || atmark != 1) {\n\t\tfprintf(stderr,\n\t\t\t\"Test 3 failed, sigurg %d len %d OOB %c atmark %d\\n\",\n\t\t\tsignal_recvd, len, oob, atmark);\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\n\tlen = read_data(pfd, buf, 1024);\n\tif (len != 64) {\n\t\tfprintf(stderr, \"Test 3.1 failed, sigurg %d len %d OOB %c\\n\",\n\t\t\tsignal_recvd, len, oob);\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\n\tset_filemode(pfd, 0);\n\n\twait_for_data(pfd, POLLIN | POLLPRI);\n\tlen = read_data(pfd, buf, 1024);\n\tif ((len == -1) && (errno == 11))\n\t\tlen = 0;\n\n\tread_oob(pfd, &oob);\n\n\tif (!signal_recvd || len != 0 || oob != '@') {\n\t\tfprintf(stderr, \"Test 4 failed, sigurg %d len %d OOB %c\\n\",\n\t\t\t signal_recvd, len, oob);\n\t\tdie(1);\n\t}\n\n\tset_filemode(pfd, 1);\n\n\t \n\n\ton = 1;\n\tif (setsockopt(pfd, SOL_SOCKET, SO_OOBINLINE, &on, sizeof(on))) {\n\t\tperror(\"SO_OOBINLINE\");\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\n\twait_for_data(pfd, POLLIN | POLLPRI);\n\tlen = read_data(pfd, buf, 1024);\n\n\tif (!signal_recvd || len != 63) {\n\t\tfprintf(stderr, \"Test 1 Inline failed, sigurg %d len %d\\n\",\n\t\t\tsignal_recvd, len);\n\t\tdie(1);\n\t}\n\n\tlen = read_data(pfd, buf, 1024);\n\n\tif (len != 1) {\n\t\tfprintf(stderr,\n\t\t\t \"Test 1.1 Inline failed, sigurg %d len %d oob %c\\n\",\n\t\t\t signal_recvd, len, oob);\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\tlen = 0;\n\twait_for_data(pfd, POLLIN | POLLPRI);\n\twhile (len < 70)\n\t\tlen = recv(pfd, buf, 1024, MSG_PEEK);\n\tlen = read_data(pfd, buf, 1024);\n\tatmark = is_sioctatmark(pfd);\n\tif (len != 127 || atmark != 1 || !signal_recvd) {\n\t\tfprintf(stderr, \"Test 2 Inline failed, len %d atmark %d\\n\",\n\t\t\t len, atmark);\n\t\tdie(1);\n\t}\n\n\tlen = read_data(pfd, buf, 1024);\n\tatmark = is_sioctatmark(pfd);\n\tif (len != 1 || buf[0] != '#' || atmark == 1) {\n\t\tfprintf(stderr, \"Test 2.1 Inline failed, len %d data %c atmark %d\\n\",\n\t\t\tlen, buf[0], atmark);\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\tlen = 0;\n\twait_for_data(pfd, POLLIN | POLLPRI);\n\twhile (len < 126)\n\t\tlen = recv(pfd, buf, 1024, MSG_PEEK);\n\tlen = read_data(pfd, buf, 1024);\n\tatmark = is_sioctatmark(pfd);\n\tif (!signal_recvd || len != 127 || !atmark) {\n\t\tfprintf(stderr,\n\t\t\t \"Test 3 Inline failed, sigurg %d len %d data %c\\n\",\n\t\t\t signal_recvd, len, buf[0]);\n\t\tdie(1);\n\t}\n\n\tlen = read_data(pfd, buf, 1024);\n\tatmark = is_sioctatmark(pfd);\n\tif (len != 65 || buf[0] != '%' || atmark != 0) {\n\t\tfprintf(stderr,\n\t\t\t \"Test 3.1 Inline failed, len %d oob %c atmark %d\\n\",\n\t\t\t len, buf[0], atmark);\n\t\tdie(1);\n\t}\n\n\tsignal_recvd = 0;\n\tsignal_producer(pipefd[1]);\n\n\t \n\twait_for_data(pfd, POLLIN | POLLPRI);\n\tlen = read_data(pfd, buf, 1024);\n\tif (!signal_recvd || len != 1 || buf[0] != '@') {\n\t\tfprintf(stderr,\n\t\t\t\"Test 4 Inline failed, signal %d len %d data %c\\n\",\n\t\tsignal_recvd, len, buf[0]);\n\t\tdie(1);\n\t}\n\tdie(0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}