{
  "module_name": "diag_uid.c",
  "hash_id": "41e12748c40d9ac539155ce365b91404707bb5136433144747ddc0c5ae9845f5",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/af_unix/diag_uid.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <sched.h>\n\n#include <unistd.h>\n#include <linux/netlink.h>\n#include <linux/rtnetlink.h>\n#include <linux/sock_diag.h>\n#include <linux/unix_diag.h>\n#include <sys/socket.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/un.h>\n\n#include \"../../kselftest_harness.h\"\n\nFIXTURE(diag_uid)\n{\n\tint netlink_fd;\n\tint unix_fd;\n\t__u32 inode;\n\t__u64 cookie;\n};\n\nFIXTURE_VARIANT(diag_uid)\n{\n\tint unshare;\n\tint udiag_show;\n};\n\nFIXTURE_VARIANT_ADD(diag_uid, uid)\n{\n\t.unshare = 0,\n\t.udiag_show = UDIAG_SHOW_UID\n};\n\nFIXTURE_VARIANT_ADD(diag_uid, uid_unshare)\n{\n\t.unshare = CLONE_NEWUSER,\n\t.udiag_show = UDIAG_SHOW_UID\n};\n\nFIXTURE_SETUP(diag_uid)\n{\n\tstruct stat file_stat;\n\tsocklen_t optlen;\n\tint ret;\n\n\tif (variant->unshare)\n\t\tASSERT_EQ(unshare(variant->unshare), 0);\n\n\tself->netlink_fd = socket(AF_NETLINK, SOCK_RAW, NETLINK_SOCK_DIAG);\n\tASSERT_NE(self->netlink_fd, -1);\n\n\tself->unix_fd = socket(AF_UNIX, SOCK_STREAM, 0);\n\tASSERT_NE(self->unix_fd, -1);\n\n\tret = fstat(self->unix_fd, &file_stat);\n\tASSERT_EQ(ret, 0);\n\n\tself->inode = file_stat.st_ino;\n\n\toptlen = sizeof(self->cookie);\n\tret = getsockopt(self->unix_fd, SOL_SOCKET, SO_COOKIE, &self->cookie, &optlen);\n\tASSERT_EQ(ret, 0);\n}\n\nFIXTURE_TEARDOWN(diag_uid)\n{\n\tclose(self->netlink_fd);\n\tclose(self->unix_fd);\n}\n\nint send_request(struct __test_metadata *_metadata,\n\t\t FIXTURE_DATA(diag_uid) *self,\n\t\t const FIXTURE_VARIANT(diag_uid) *variant)\n{\n\tstruct {\n\t\tstruct nlmsghdr nlh;\n\t\tstruct unix_diag_req udr;\n\t} req = {\n\t\t.nlh = {\n\t\t\t.nlmsg_len = sizeof(req),\n\t\t\t.nlmsg_type = SOCK_DIAG_BY_FAMILY,\n\t\t\t.nlmsg_flags = NLM_F_REQUEST\n\t\t},\n\t\t.udr = {\n\t\t\t.sdiag_family = AF_UNIX,\n\t\t\t.udiag_ino = self->inode,\n\t\t\t.udiag_cookie = {\n\t\t\t\t(__u32)self->cookie,\n\t\t\t\t(__u32)(self->cookie >> 32)\n\t\t\t},\n\t\t\t.udiag_show = variant->udiag_show\n\t\t}\n\t};\n\tstruct sockaddr_nl nladdr = {\n\t\t.nl_family = AF_NETLINK\n\t};\n\tstruct iovec iov = {\n\t\t.iov_base = &req,\n\t\t.iov_len = sizeof(req)\n\t};\n\tstruct msghdr msg = {\n\t\t.msg_name = &nladdr,\n\t\t.msg_namelen = sizeof(nladdr),\n\t\t.msg_iov = &iov,\n\t\t.msg_iovlen = 1\n\t};\n\n\treturn sendmsg(self->netlink_fd, &msg, 0);\n}\n\nvoid render_response(struct __test_metadata *_metadata,\n\t\t     struct unix_diag_req *udr, __u32 len)\n{\n\tunsigned int rta_len = len - NLMSG_LENGTH(sizeof(*udr));\n\tstruct rtattr *attr;\n\tuid_t uid;\n\n\tASSERT_GT(len, sizeof(*udr));\n\tASSERT_EQ(udr->sdiag_family, AF_UNIX);\n\n\tattr = (struct rtattr *)(udr + 1);\n\tASSERT_NE(RTA_OK(attr, rta_len), 0);\n\tASSERT_EQ(attr->rta_type, UNIX_DIAG_UID);\n\n\tuid = *(uid_t *)RTA_DATA(attr);\n\tASSERT_EQ(uid, getuid());\n}\n\nvoid receive_response(struct __test_metadata *_metadata,\n\t\t      FIXTURE_DATA(diag_uid) *self)\n{\n\tlong buf[8192 / sizeof(long)];\n\tstruct sockaddr_nl nladdr = {\n\t\t.nl_family = AF_NETLINK\n\t};\n\tstruct iovec iov = {\n\t\t.iov_base = buf,\n\t\t.iov_len = sizeof(buf)\n\t};\n\tstruct msghdr msg = {\n\t\t.msg_name = &nladdr,\n\t\t.msg_namelen = sizeof(nladdr),\n\t\t.msg_iov = &iov,\n\t\t.msg_iovlen = 1\n\t};\n\tstruct nlmsghdr *nlh;\n\tint ret;\n\n\tret = recvmsg(self->netlink_fd, &msg, 0);\n\tASSERT_GT(ret, 0);\n\n\tnlh = (struct nlmsghdr *)buf;\n\tASSERT_NE(NLMSG_OK(nlh, ret), 0);\n\tASSERT_EQ(nlh->nlmsg_type, SOCK_DIAG_BY_FAMILY);\n\n\trender_response(_metadata, NLMSG_DATA(nlh), nlh->nlmsg_len);\n\n\tnlh = NLMSG_NEXT(nlh, ret);\n\tASSERT_EQ(NLMSG_OK(nlh, ret), 0);\n}\n\nTEST_F(diag_uid, 1)\n{\n\tint ret;\n\n\tret = send_request(_metadata, self, variant);\n\tASSERT_GT(ret, 0);\n\n\treceive_response(_metadata, self);\n}\n\nTEST_HARNESS_MAIN\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}