{
  "module_name": "hsr_ping.sh",
  "hash_id": "d3eddc9ae6f7691ddc8491a25c344052d38c8348fffe2e229f15cfed46559093",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/hsr/hsr_ping.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nret=0\nksft_skip=4\nipv6=true\n\noptstring=\"h4\"\nusage() {\n\techo \"Usage: $0 [OPTION]\"\n\techo -e \"\\t-4: IPv4 only: disable IPv6 tests (default: test both IPv4 and IPv6)\"\n}\n\nwhile getopts \"$optstring\" option;do\n\tcase \"$option\" in\n\t\"h\")\n\t\tusage $0\n\t\texit 0\n\t\t;;\n\t\"4\")\n\t\tipv6=false\n\t\t;;\n\t\"?\")\n\t\tusage $0\n\t\texit 1\n\t\t;;\nesac\ndone\n\nsec=$(date +%s)\nrndh=$(printf %x $sec)-$(mktemp -u XXXXXX)\nns1=\"ns1-$rndh\"\nns2=\"ns2-$rndh\"\nns3=\"ns3-$rndh\"\n\ncleanup()\n{\n\tlocal netns\n\tfor netns in \"$ns1\" \"$ns2\" \"$ns3\" ;do\n\t\tip netns del $netns\n\tdone\n}\n\n# $1: IP address\nis_v6()\n{\n\t[ -z \"${1##*:*}\" ]\n}\n\ndo_ping()\n{\n\tlocal netns=\"$1\"\n\tlocal connect_addr=\"$2\"\n\tlocal ping_args=\"-q -c 2\"\n\n\tif is_v6 \"${connect_addr}\"; then\n\t\t$ipv6 || return 0\n\t\tping_args=\"${ping_args} -6\"\n\tfi\n\n\tip netns exec ${netns} ping ${ping_args} $connect_addr >/dev/null\n\tif [ $? -ne 0 ] ; then\n\t\techo \"$netns -> $connect_addr connectivity [ FAIL ]\" 1>&2\n\t\tret=1\n\t\treturn 1\n\tfi\n\n\treturn 0\n}\n\ndo_ping_long()\n{\n\tlocal netns=\"$1\"\n\tlocal connect_addr=\"$2\"\n\tlocal ping_args=\"-q -c 10\"\n\n\tif is_v6 \"${connect_addr}\"; then\n\t\t$ipv6 || return 0\n\t\tping_args=\"${ping_args} -6\"\n\tfi\n\n\tOUT=\"$(LANG=C ip netns exec ${netns} ping ${ping_args} $connect_addr | grep received)\"\n\tif [ $? -ne 0 ] ; then\n\t\techo \"$netns -> $connect_addr ping [ FAIL ]\" 1>&2\n\t\tret=1\n\t\treturn 1\n\tfi\n\n\tVAL=\"$(echo $OUT | cut -d' ' -f1-8)\"\n\tif [ \"$VAL\" != \"10 packets transmitted, 10 received, 0% packet loss,\" ]\n\tthen\n\t\techo \"$netns -> $connect_addr ping TEST [ FAIL ]\"\n\t\techo \"Expect to send and receive 10 packets and no duplicates.\"\n\t\techo \"Full message: ${OUT}.\"\n\t\tret=1\n\t\treturn 1\n\tfi\n\n\treturn 0\n}\n\nstop_if_error()\n{\n\tlocal msg=\"$1\"\n\n\tif [ ${ret} -ne 0 ]; then\n\t\techo \"FAIL: ${msg}\" 1>&2\n\t\texit ${ret}\n\tfi\n}\n\ndo_complete_ping_test()\n{\n\techo \"INFO: Initial validation ping.\"\n\t# Each node has to be able each one.\n\tdo_ping \"$ns1\" 100.64.0.2\n\tdo_ping \"$ns2\" 100.64.0.1\n\tdo_ping \"$ns3\" 100.64.0.1\n\tstop_if_error \"Initial validation failed.\"\n\n\tdo_ping \"$ns1\" 100.64.0.3\n\tdo_ping \"$ns2\" 100.64.0.3\n\tdo_ping \"$ns3\" 100.64.0.2\n\n\tdo_ping \"$ns1\" dead:beef:1::2\n\tdo_ping \"$ns1\" dead:beef:1::3\n\tdo_ping \"$ns2\" dead:beef:1::1\n\tdo_ping \"$ns2\" dead:beef:1::2\n\tdo_ping \"$ns3\" dead:beef:1::1\n\tdo_ping \"$ns3\" dead:beef:1::2\n\n\tstop_if_error \"Initial validation failed.\"\n\n# Wait until supervisor all supervision frames have been processed and the node\n# entries have been merged. Otherwise duplicate frames will be observed which is\n# valid at this stage.\n\tWAIT=5\n\twhile [ ${WAIT} -gt 0 ]\n\tdo\n\t\tgrep 00:00:00:00:00:00 /sys/kernel/debug/hsr/hsr*/node_table\n\t\tif [ $? -ne 0 ]\n\t\tthen\n\t\t\tbreak\n\t\tfi\n\t\tsleep 1\n\t\tlet \"WAIT = WAIT - 1\"\n\tdone\n\n# Just a safety delay in case the above check didn't handle it.\n\tsleep 1\n\n\techo \"INFO: Longer ping test.\"\n\tdo_ping_long \"$ns1\" 100.64.0.2\n\tdo_ping_long \"$ns1\" dead:beef:1::2\n\tdo_ping_long \"$ns1\" 100.64.0.3\n\tdo_ping_long \"$ns1\" dead:beef:1::3\n\n\tstop_if_error \"Longer ping test failed.\"\n\n\tdo_ping_long \"$ns2\" 100.64.0.1\n\tdo_ping_long \"$ns2\" dead:beef:1::1\n\tdo_ping_long \"$ns2\" 100.64.0.3\n\tdo_ping_long \"$ns2\" dead:beef:1::2\n\tstop_if_error \"Longer ping test failed.\"\n\n\tdo_ping_long \"$ns3\" 100.64.0.1\n\tdo_ping_long \"$ns3\" dead:beef:1::1\n\tdo_ping_long \"$ns3\" 100.64.0.2\n\tdo_ping_long \"$ns3\" dead:beef:1::2\n\tstop_if_error \"Longer ping test failed.\"\n\n\techo \"INFO: Cutting one link.\"\n\tdo_ping_long \"$ns1\" 100.64.0.3 &\n\n\tsleep 3\n\tip -net \"$ns3\" link set ns3eth1 down\n\twait\n\n\tip -net \"$ns3\" link set ns3eth1 up\n\n\tstop_if_error \"Failed with one link down.\"\n\n\techo \"INFO: Delay the link and drop a few packages.\"\n\ttc -net \"$ns3\" qdisc add dev ns3eth1 root netem delay 50ms\n\ttc -net \"$ns2\" qdisc add dev ns2eth1 root netem delay 5ms loss 25%\n\n\tdo_ping_long \"$ns1\" 100.64.0.2\n\tdo_ping_long \"$ns1\" 100.64.0.3\n\n\tstop_if_error \"Failed with delay and packetloss.\"\n\n\tdo_ping_long \"$ns2\" 100.64.0.1\n\tdo_ping_long \"$ns2\" 100.64.0.3\n\n\tstop_if_error \"Failed with delay and packetloss.\"\n\n\tdo_ping_long \"$ns3\" 100.64.0.1\n\tdo_ping_long \"$ns3\" 100.64.0.2\n\tstop_if_error \"Failed with delay and packetloss.\"\n\n\techo \"INFO: All good.\"\n}\n\nsetup_hsr_interfaces()\n{\n\tlocal HSRv=\"$1\"\n\n\techo \"INFO: preparing interfaces for HSRv${HSRv}.\"\n# Three HSR nodes. Each node has one link to each of its neighbour, two links in total.\n#\n#    ns1eth1 ----- ns2eth1\n#      hsr1         hsr2\n#    ns1eth2       ns2eth2\n#       |            |\n#    ns3eth1      ns3eth2\n#           \\    /\n#            hsr3\n#\n\t# Interfaces\n\tip link add ns1eth1 netns \"$ns1\" type veth peer name ns2eth1 netns \"$ns2\"\n\tip link add ns1eth2 netns \"$ns1\" type veth peer name ns3eth1 netns \"$ns3\"\n\tip link add ns3eth2 netns \"$ns3\" type veth peer name ns2eth2 netns \"$ns2\"\n\n\t# HSRv0/1\n\tip -net \"$ns1\" link add name hsr1 type hsr slave1 ns1eth1 slave2 ns1eth2 supervision 45 version $HSRv proto 0\n\tip -net \"$ns2\" link add name hsr2 type hsr slave1 ns2eth1 slave2 ns2eth2 supervision 45 version $HSRv proto 0\n\tip -net \"$ns3\" link add name hsr3 type hsr slave1 ns3eth1 slave2 ns3eth2 supervision 45 version $HSRv proto 0\n\n\t# IP for HSR\n\tip -net \"$ns1\" addr add 100.64.0.1/24 dev hsr1\n\tip -net \"$ns1\" addr add dead:beef:1::1/64 dev hsr1 nodad\n\tip -net \"$ns2\" addr add 100.64.0.2/24 dev hsr2\n\tip -net \"$ns2\" addr add dead:beef:1::2/64 dev hsr2 nodad\n\tip -net \"$ns3\" addr add 100.64.0.3/24 dev hsr3\n\tip -net \"$ns3\" addr add dead:beef:1::3/64 dev hsr3 nodad\n\n\t# All Links up\n\tip -net \"$ns1\" link set ns1eth1 up\n\tip -net \"$ns1\" link set ns1eth2 up\n\tip -net \"$ns1\" link set hsr1 up\n\n\tip -net \"$ns2\" link set ns2eth1 up\n\tip -net \"$ns2\" link set ns2eth2 up\n\tip -net \"$ns2\" link set hsr2 up\n\n\tip -net \"$ns3\" link set ns3eth1 up\n\tip -net \"$ns3\" link set ns3eth2 up\n\tip -net \"$ns3\" link set hsr3 up\n}\n\nip -Version > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\ntrap cleanup EXIT\n\nfor i in \"$ns1\" \"$ns2\" \"$ns3\" ;do\n\tip netns add $i || exit $ksft_skip\n\tip -net $i link set lo up\ndone\n\nsetup_hsr_interfaces 0\ndo_complete_ping_test\ncleanup\n\nfor i in \"$ns1\" \"$ns2\" \"$ns3\" ;do\n\tip netns add $i || exit $ksft_skip\n\tip -net $i link set lo up\ndone\n\nsetup_hsr_interfaces 1\ndo_complete_ping_test\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}