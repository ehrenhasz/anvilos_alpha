{
  "module_name": "test_bridge_neigh_suppress.sh",
  "hash_id": "20b18c36f883ce3dc763526a52da99d4c8c32449657eb244cd1f4a4f82e2f493",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/test_bridge_neigh_suppress.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking bridge neighbor suppression functionality. The\n# topology consists of two bridges (VTEPs) connected using VXLAN. A single\n# host is connected to each bridge over multiple VLANs. The test checks that\n# ARP/NS messages from the first host are suppressed on the VXLAN port when\n# should.\n#\n# +-----------------------+              +------------------------+\n# | h1                    |              | h2                     |\n# |                       |              |                        |\n# | + eth0.10             |              | + eth0.10              |\n# | | 192.0.2.1/28        |              | | 192.0.2.2/28         |\n# | | 2001:db8:1::1/64    |              | | 2001:db8:1::2/64     |\n# | |                     |              | |                      |\n# | |  + eth0.20          |              | |  + eth0.20           |\n# | \\  | 192.0.2.17/28    |              | \\  | 192.0.2.18/28     |\n# |  \\ | 2001:db8:2::1/64 |              |  \\ | 2001:db8:2::2/64  |\n# |   \\|                  |              |   \\|                   |\n# |    + eth0             |              |    + eth0              |\n# +----|------------------+              +----|-------------------+\n#      |                                      |\n#      |                                      |\n# +----|-------------------------------+ +----|-------------------------------+\n# |    + swp1                   + vx0  | |    + swp1                   + vx0  |\n# |    |                        |      | |    |                        |      |\n# |    |           br0          |      | |    |                        |      |\n# |    +------------+-----------+      | |    +------------+-----------+      |\n# |                 |                  | |                 |                  |\n# |                 |                  | |                 |                  |\n# |             +---+---+              | |             +---+---+              |\n# |             |       |              | |             |       |              |\n# |             |       |              | |             |       |              |\n# |             +       +              | |             +       +              |\n# |          br0.10  br0.20            | |          br0.10  br0.20            |\n# |                                    | |                                    |\n# |                 192.0.2.33         | |                 192.0.2.34         |\n# |                 + lo               | |                 + lo               |\n# |                                    | |                                    |\n# |                                    | |                                    |\n# |                   192.0.2.49/28    | |    192.0.2.50/28                   |\n# |                           veth0 +-------+ veth0                           |\n# |                                    | |                                    |\n# | sw1                                | | sw2                                |\n# +------------------------------------+ +------------------------------------+\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# All tests in this script. Can be overridden with -t option.\nTESTS=\"\n\tneigh_suppress_arp\n\tneigh_suppress_ns\n\tneigh_vlan_suppress_arp\n\tneigh_vlan_suppress_ns\n\"\nVERBOSE=0\nPAUSE_ON_FAIL=no\nPAUSE=no\n\n################################################################################\n# Utilities\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\t\techo \"    rc=$rc, expected $expected\"\n\t\tfi\n\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n\n\t[ \"$VERBOSE\" = \"1\" ] && echo\n}\n\nrun_cmd()\n{\n\tlocal cmd=\"$1\"\n\tlocal out\n\tlocal stderr=\"2>/dev/null\"\n\n\tif [ \"$VERBOSE\" = \"1\" ]; then\n\t\tprintf \"COMMAND: $cmd\\n\"\n\t\tstderr=\n\tfi\n\n\tout=$(eval $cmd $stderr)\n\trc=$?\n\tif [ \"$VERBOSE\" = \"1\" -a -n \"$out\" ]; then\n\t\techo \"    $out\"\n\tfi\n\n\treturn $rc\n}\n\ntc_check_packets()\n{\n\tlocal ns=$1; shift\n\tlocal id=$1; shift\n\tlocal handle=$1; shift\n\tlocal count=$1; shift\n\tlocal pkts\n\n\tsleep 0.1\n\tpkts=$(tc -n $ns -j -s filter show $id \\\n\t\t| jq \".[] | select(.options.handle == $handle) | \\\n\t\t.options.actions[0].stats.packets\")\n\t[[ $pkts == $count ]]\n}\n\n################################################################################\n# Setup\n\nsetup_topo_ns()\n{\n\tlocal ns=$1; shift\n\n\tip netns add $ns\n\tip -n $ns link set dev lo up\n\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.ignore_routes_with_linkdown=1\n\tip netns exec $ns sysctl -qw net.ipv6.conf.all.accept_dad=0\n\tip netns exec $ns sysctl -qw net.ipv6.conf.default.accept_dad=0\n}\n\nsetup_topo()\n{\n\tlocal ns\n\n\tfor ns in h1 h2 sw1 sw2; do\n\t\tsetup_topo_ns $ns\n\tdone\n\n\tip link add name veth0 type veth peer name veth1\n\tip link set dev veth0 netns h1 name eth0\n\tip link set dev veth1 netns sw1 name swp1\n\n\tip link add name veth0 type veth peer name veth1\n\tip link set dev veth0 netns sw1 name veth0\n\tip link set dev veth1 netns sw2 name veth0\n\n\tip link add name veth0 type veth peer name veth1\n\tip link set dev veth0 netns h2 name eth0\n\tip link set dev veth1 netns sw2 name swp1\n}\n\nsetup_host_common()\n{\n\tlocal ns=$1; shift\n\tlocal v4addr1=$1; shift\n\tlocal v4addr2=$1; shift\n\tlocal v6addr1=$1; shift\n\tlocal v6addr2=$1; shift\n\n\tip -n $ns link set dev eth0 up\n\tip -n $ns link add link eth0 name eth0.10 up type vlan id 10\n\tip -n $ns link add link eth0 name eth0.20 up type vlan id 20\n\n\tip -n $ns address add $v4addr1 dev eth0.10\n\tip -n $ns address add $v4addr2 dev eth0.20\n\tip -n $ns address add $v6addr1 dev eth0.10\n\tip -n $ns address add $v6addr2 dev eth0.20\n}\n\nsetup_h1()\n{\n\tlocal ns=h1\n\tlocal v4addr1=192.0.2.1/28\n\tlocal v4addr2=192.0.2.17/28\n\tlocal v6addr1=2001:db8:1::1/64\n\tlocal v6addr2=2001:db8:2::1/64\n\n\tsetup_host_common $ns $v4addr1 $v4addr2 $v6addr1 $v6addr2\n}\n\nsetup_h2()\n{\n\tlocal ns=h2\n\tlocal v4addr1=192.0.2.2/28\n\tlocal v4addr2=192.0.2.18/28\n\tlocal v6addr1=2001:db8:1::2/64\n\tlocal v6addr2=2001:db8:2::2/64\n\n\tsetup_host_common $ns $v4addr1 $v4addr2 $v6addr1 $v6addr2\n}\n\nsetup_sw_common()\n{\n\tlocal ns=$1; shift\n\tlocal local_addr=$1; shift\n\tlocal remote_addr=$1; shift\n\tlocal veth_addr=$1; shift\n\tlocal gw_addr=$1; shift\n\n\tip -n $ns address add $local_addr/32 dev lo\n\n\tip -n $ns link set dev veth0 up\n\tip -n $ns address add $veth_addr/28 dev veth0\n\tip -n $ns route add default via $gw_addr\n\n\tip -n $ns link add name br0 up type bridge vlan_filtering 1 \\\n\t\tvlan_default_pvid 0 mcast_snooping 0\n\n\tip -n $ns link add link br0 name br0.10 up type vlan id 10\n\tbridge -n $ns vlan add vid 10 dev br0 self\n\n\tip -n $ns link add link br0 name br0.20 up type vlan id 20\n\tbridge -n $ns vlan add vid 20 dev br0 self\n\n\tip -n $ns link set dev swp1 up master br0\n\tbridge -n $ns vlan add vid 10 dev swp1\n\tbridge -n $ns vlan add vid 20 dev swp1\n\n\tip -n $ns link add name vx0 up master br0 type vxlan \\\n\t\tlocal $local_addr dstport 4789 nolearning external\n\tbridge -n $ns fdb add 00:00:00:00:00:00 dev vx0 self static \\\n\t\tdst $remote_addr src_vni 10010\n\tbridge -n $ns fdb add 00:00:00:00:00:00 dev vx0 self static \\\n\t\tdst $remote_addr src_vni 10020\n\tbridge -n $ns link set dev vx0 vlan_tunnel on learning off\n\n\tbridge -n $ns vlan add vid 10 dev vx0\n\tbridge -n $ns vlan add vid 10 dev vx0 tunnel_info id 10010\n\n\tbridge -n $ns vlan add vid 20 dev vx0\n\tbridge -n $ns vlan add vid 20 dev vx0 tunnel_info id 10020\n}\n\nsetup_sw1()\n{\n\tlocal ns=sw1\n\tlocal local_addr=192.0.2.33\n\tlocal remote_addr=192.0.2.34\n\tlocal veth_addr=192.0.2.49\n\tlocal gw_addr=192.0.2.50\n\n\tsetup_sw_common $ns $local_addr $remote_addr $veth_addr $gw_addr\n}\n\nsetup_sw2()\n{\n\tlocal ns=sw2\n\tlocal local_addr=192.0.2.34\n\tlocal remote_addr=192.0.2.33\n\tlocal veth_addr=192.0.2.50\n\tlocal gw_addr=192.0.2.49\n\n\tsetup_sw_common $ns $local_addr $remote_addr $veth_addr $gw_addr\n}\n\nsetup()\n{\n\tset -e\n\n\tsetup_topo\n\tsetup_h1\n\tsetup_h2\n\tsetup_sw1\n\tsetup_sw2\n\n\tsleep 5\n\n\tset +e\n}\n\ncleanup()\n{\n\tlocal ns\n\n\tfor ns in h1 h2 sw1 sw2; do\n\t\tip netns del $ns &> /dev/null\n\tdone\n}\n\n################################################################################\n# Tests\n\nneigh_suppress_arp_common()\n{\n\tlocal vid=$1; shift\n\tlocal sip=$1; shift\n\tlocal tip=$1; shift\n\tlocal h2_mac\n\n\techo\n\techo \"Per-port ARP suppression - VLAN $vid\"\n\techo \"----------------------------------\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto 0x0806 flower indev swp1 arp_tip $tip arp_sip $sip arp_op request action pass\"\n\n\t# Initial state - check that ARP requests are not suppressed and that\n\t# ARP replies are received.\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 0 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"ARP suppression\"\n\n\t# Enable neighbor suppression and check that nothing changes compared\n\t# to the initial state.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 0 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"ARP suppression\"\n\n\t# Install an FDB entry for the remote host and check that nothing\n\t# changes compared to the initial state.\n\th2_mac=$(ip -n h2 -j -p link show eth0.$vid | jq -r '.[][\"address\"]')\n\trun_cmd \"bridge -n sw1 fdb replace $h2_mac dev vx0 master static vlan $vid\"\n\tlog_test $? 0 \"FDB entry installation\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 0 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"ARP suppression\"\n\n\t# Install a neighbor on the matching SVI interface and check that ARP\n\t# requests are suppressed.\n\trun_cmd \"ip -n sw1 neigh replace $tip lladdr $h2_mac nud permanent dev br0.$vid\"\n\tlog_test $? 0 \"Neighbor entry installation\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 0 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"ARP suppression\"\n\n\t# Take the second host down and check that ARP requests are suppressed\n\t# and that ARP replies are received.\n\trun_cmd \"ip -n h2 link set dev eth0.$vid down\"\n\tlog_test $? 0 \"H2 down\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 0 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"ARP suppression\"\n\n\trun_cmd \"ip -n h2 link set dev eth0.$vid up\"\n\tlog_test $? 0 \"H2 up\"\n\n\t# Disable neighbor suppression and check that ARP requests are no\n\t# longer suppressed.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress off\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 0 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 4\n\tlog_test $? 0 \"ARP suppression\"\n\n\t# Take the second host down and check that ARP requests are not\n\t# suppressed and that ARP replies are not received.\n\trun_cmd \"ip -n h2 link set dev eth0.$vid down\"\n\tlog_test $? 0 \"H2 down\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip -I eth0.$vid $tip\"\n\tlog_test $? 1 \"arping\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 5\n\tlog_test $? 0 \"ARP suppression\"\n}\n\nneigh_suppress_arp()\n{\n\tlocal vid=10\n\tlocal sip=192.0.2.1\n\tlocal tip=192.0.2.2\n\n\tneigh_suppress_arp_common $vid $sip $tip\n\n\tvid=20\n\tsip=192.0.2.17\n\ttip=192.0.2.18\n\tneigh_suppress_arp_common $vid $sip $tip\n}\n\nneigh_suppress_ns_common()\n{\n\tlocal vid=$1; shift\n\tlocal saddr=$1; shift\n\tlocal daddr=$1; shift\n\tlocal maddr=$1; shift\n\tlocal h2_mac\n\n\techo\n\techo \"Per-port NS suppression - VLAN $vid\"\n\techo \"---------------------------------\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto ipv6 flower indev swp1 ip_proto icmpv6 dst_ip $maddr src_ip $saddr type 135 code 0 action pass\"\n\n\t# Initial state - check that NS messages are not suppressed and that ND\n\t# messages are received.\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 0 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"NS suppression\"\n\n\t# Enable neighbor suppression and check that nothing changes compared\n\t# to the initial state.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 0 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"NS suppression\"\n\n\t# Install an FDB entry for the remote host and check that nothing\n\t# changes compared to the initial state.\n\th2_mac=$(ip -n h2 -j -p link show eth0.$vid | jq -r '.[][\"address\"]')\n\trun_cmd \"bridge -n sw1 fdb replace $h2_mac dev vx0 master static vlan $vid\"\n\tlog_test $? 0 \"FDB entry installation\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 0 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"NS suppression\"\n\n\t# Install a neighbor on the matching SVI interface and check that NS\n\t# messages are suppressed.\n\trun_cmd \"ip -n sw1 neigh replace $daddr lladdr $h2_mac nud permanent dev br0.$vid\"\n\tlog_test $? 0 \"Neighbor entry installation\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 0 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"NS suppression\"\n\n\t# Take the second host down and check that NS messages are suppressed\n\t# and that ND messages are received.\n\trun_cmd \"ip -n h2 link set dev eth0.$vid down\"\n\tlog_test $? 0 \"H2 down\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 0 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 3\n\tlog_test $? 0 \"NS suppression\"\n\n\trun_cmd \"ip -n h2 link set dev eth0.$vid up\"\n\tlog_test $? 0 \"H2 up\"\n\n\t# Disable neighbor suppression and check that NS messages are no longer\n\t# suppressed.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress off\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 0 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 4\n\tlog_test $? 0 \"NS suppression\"\n\n\t# Take the second host down and check that NS messages are not\n\t# suppressed and that ND messages are not received.\n\trun_cmd \"ip -n h2 link set dev eth0.$vid down\"\n\tlog_test $? 0 \"H2 down\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr -w 5000 $daddr eth0.$vid\"\n\tlog_test $? 2 \"ndisc6\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 5\n\tlog_test $? 0 \"NS suppression\"\n}\n\nneigh_suppress_ns()\n{\n\tlocal vid=10\n\tlocal saddr=2001:db8:1::1\n\tlocal daddr=2001:db8:1::2\n\tlocal maddr=ff02::1:ff00:2\n\n\tneigh_suppress_ns_common $vid $saddr $daddr $maddr\n\n\tvid=20\n\tsaddr=2001:db8:2::1\n\tdaddr=2001:db8:2::2\n\tmaddr=ff02::1:ff00:2\n\n\tneigh_suppress_ns_common $vid $saddr $daddr $maddr\n}\n\nneigh_vlan_suppress_arp()\n{\n\tlocal vid1=10\n\tlocal vid2=20\n\tlocal sip1=192.0.2.1\n\tlocal sip2=192.0.2.17\n\tlocal tip1=192.0.2.2\n\tlocal tip2=192.0.2.18\n\tlocal h2_mac1\n\tlocal h2_mac2\n\n\techo\n\techo \"Per-{Port, VLAN} ARP suppression\"\n\techo \"--------------------------------\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto 0x0806 flower indev swp1 arp_tip $tip1 arp_sip $sip1 arp_op request action pass\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 102 proto 0x0806 flower indev swp1 arp_tip $tip2 arp_sip $sip2 arp_op request action pass\"\n\n\th2_mac1=$(ip -n h2 -j -p link show eth0.$vid1 | jq -r '.[][\"address\"]')\n\th2_mac2=$(ip -n h2 -j -p link show eth0.$vid2 | jq -r '.[][\"address\"]')\n\trun_cmd \"bridge -n sw1 fdb replace $h2_mac1 dev vx0 master static vlan $vid1\"\n\trun_cmd \"bridge -n sw1 fdb replace $h2_mac2 dev vx0 master static vlan $vid2\"\n\trun_cmd \"ip -n sw1 neigh replace $tip1 lladdr $h2_mac1 nud permanent dev br0.$vid1\"\n\trun_cmd \"ip -n sw1 neigh replace $tip2 lladdr $h2_mac2 nud permanent dev br0.$vid2\"\n\n\t# Enable per-{Port, VLAN} neighbor suppression and check that ARP\n\t# requests are not suppressed and that ARP replies are received.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_vlan_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_vlan_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_vlan_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip1 -I eth0.$vid1 $tip1\"\n\tlog_test $? 0 \"arping (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip2 -I eth0.$vid2 $tip2\"\n\tlog_test $? 0 \"arping (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"ARP suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 1\n\tlog_test $? 0 \"ARP suppression (VLAN $vid2)\"\n\n\t# Enable neighbor suppression on VLAN 10 and check that only on this\n\t# VLAN ARP requests are suppressed.\n\trun_cmd \"bridge -n sw1 vlan set vid $vid1 dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d vlan show dev vx0 vid $vid1 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on (VLAN $vid1)\"\n\trun_cmd \"bridge -n sw1 -d vlan show dev vx0 vid $vid2 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off (VLAN $vid2)\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip1 -I eth0.$vid1 $tip1\"\n\tlog_test $? 0 \"arping (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip2 -I eth0.$vid2 $tip2\"\n\tlog_test $? 0 \"arping (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"ARP suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 2\n\tlog_test $? 0 \"ARP suppression (VLAN $vid2)\"\n\n\t# Enable neighbor suppression on the port and check that it has no\n\t# effect compared to previous state.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip1 -I eth0.$vid1 $tip1\"\n\tlog_test $? 0 \"arping (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip2 -I eth0.$vid2 $tip2\"\n\tlog_test $? 0 \"arping (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"ARP suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 3\n\tlog_test $? 0 \"ARP suppression (VLAN $vid2)\"\n\n\t# Disable neighbor suppression on the port and check that it has no\n\t# effect compared to previous state.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress off\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip1 -I eth0.$vid1 $tip1\"\n\tlog_test $? 0 \"arping (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip2 -I eth0.$vid2 $tip2\"\n\tlog_test $? 0 \"arping (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"ARP suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 4\n\tlog_test $? 0 \"ARP suppression (VLAN $vid2)\"\n\n\t# Disable neighbor suppression on VLAN 10 and check that ARP requests\n\t# are no longer suppressed on this VLAN.\n\trun_cmd \"bridge -n sw1 vlan set vid $vid1 dev vx0 neigh_suppress off\"\n\trun_cmd \"bridge -n sw1 -d vlan show dev vx0 vid $vid1 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off (VLAN $vid1)\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip1 -I eth0.$vid1 $tip1\"\n\tlog_test $? 0 \"arping (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip2 -I eth0.$vid2 $tip2\"\n\tlog_test $? 0 \"arping (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"ARP suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 5\n\tlog_test $? 0 \"ARP suppression (VLAN $vid2)\"\n\n\t# Disable per-{Port, VLAN} neighbor suppression, enable neighbor\n\t# suppression on the port and check that on both VLANs ARP requests are\n\t# suppressed.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_vlan_suppress off\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_vlan_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_vlan_suppress\\\" is off\"\n\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip1 -I eth0.$vid1 $tip1\"\n\tlog_test $? 0 \"arping (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 arping -q -b -c 1 -w 5 -s $sip2 -I eth0.$vid2 $tip2\"\n\tlog_test $? 0 \"arping (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"ARP suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 5\n\tlog_test $? 0 \"ARP suppression (VLAN $vid2)\"\n}\n\nneigh_vlan_suppress_ns()\n{\n\tlocal vid1=10\n\tlocal vid2=20\n\tlocal saddr1=2001:db8:1::1\n\tlocal saddr2=2001:db8:2::1\n\tlocal daddr1=2001:db8:1::2\n\tlocal daddr2=2001:db8:2::2\n\tlocal maddr=ff02::1:ff00:2\n\tlocal h2_mac1\n\tlocal h2_mac2\n\n\techo\n\techo \"Per-{Port, VLAN} NS suppression\"\n\techo \"-------------------------------\"\n\n\trun_cmd \"tc -n sw1 qdisc replace dev vx0 clsact\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 101 proto ipv6 flower indev swp1 ip_proto icmpv6 dst_ip $maddr src_ip $saddr1 type 135 code 0 action pass\"\n\trun_cmd \"tc -n sw1 filter replace dev vx0 egress pref 1 handle 102 proto ipv6 flower indev swp1 ip_proto icmpv6 dst_ip $maddr src_ip $saddr2 type 135 code 0 action pass\"\n\n\th2_mac1=$(ip -n h2 -j -p link show eth0.$vid1 | jq -r '.[][\"address\"]')\n\th2_mac2=$(ip -n h2 -j -p link show eth0.$vid2 | jq -r '.[][\"address\"]')\n\trun_cmd \"bridge -n sw1 fdb replace $h2_mac1 dev vx0 master static vlan $vid1\"\n\trun_cmd \"bridge -n sw1 fdb replace $h2_mac2 dev vx0 master static vlan $vid2\"\n\trun_cmd \"ip -n sw1 neigh replace $daddr1 lladdr $h2_mac1 nud permanent dev br0.$vid1\"\n\trun_cmd \"ip -n sw1 neigh replace $daddr2 lladdr $h2_mac2 nud permanent dev br0.$vid2\"\n\n\t# Enable per-{Port, VLAN} neighbor suppression and check that NS\n\t# messages are not suppressed and that ND messages are received.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_vlan_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_vlan_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_vlan_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr1 -w 5000 $daddr1 eth0.$vid1\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr2 -w 5000 $daddr2 eth0.$vid2\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"NS suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 1\n\tlog_test $? 0 \"NS suppression (VLAN $vid2)\"\n\n\t# Enable neighbor suppression on VLAN 10 and check that only on this\n\t# VLAN NS messages are suppressed.\n\trun_cmd \"bridge -n sw1 vlan set vid $vid1 dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d vlan show dev vx0 vid $vid1 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on (VLAN $vid1)\"\n\trun_cmd \"bridge -n sw1 -d vlan show dev vx0 vid $vid2 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off (VLAN $vid2)\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr1 -w 5000 $daddr1 eth0.$vid1\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr2 -w 5000 $daddr2 eth0.$vid2\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"NS suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 2\n\tlog_test $? 0 \"NS suppression (VLAN $vid2)\"\n\n\t# Enable neighbor suppression on the port and check that it has no\n\t# effect compared to previous state.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr1 -w 5000 $daddr1 eth0.$vid1\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr2 -w 5000 $daddr2 eth0.$vid2\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"NS suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 3\n\tlog_test $? 0 \"NS suppression (VLAN $vid2)\"\n\n\t# Disable neighbor suppression on the port and check that it has no\n\t# effect compared to previous state.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress off\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr1 -w 5000 $daddr1 eth0.$vid1\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr2 -w 5000 $daddr2 eth0.$vid2\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 1\n\tlog_test $? 0 \"NS suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 4\n\tlog_test $? 0 \"NS suppression (VLAN $vid2)\"\n\n\t# Disable neighbor suppression on VLAN 10 and check that NS messages\n\t# are no longer suppressed on this VLAN.\n\trun_cmd \"bridge -n sw1 vlan set vid $vid1 dev vx0 neigh_suppress off\"\n\trun_cmd \"bridge -n sw1 -d vlan show dev vx0 vid $vid1 | grep \\\"neigh_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is off (VLAN $vid1)\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr1 -w 5000 $daddr1 eth0.$vid1\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr2 -w 5000 $daddr2 eth0.$vid2\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"NS suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 5\n\tlog_test $? 0 \"NS suppression (VLAN $vid2)\"\n\n\t# Disable per-{Port, VLAN} neighbor suppression, enable neighbor\n\t# suppression on the port and check that on both VLANs NS messages are\n\t# suppressed.\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_vlan_suppress off\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_vlan_suppress off\\\"\"\n\tlog_test $? 0 \"\\\"neigh_vlan_suppress\\\" is off\"\n\n\trun_cmd \"bridge -n sw1 link set dev vx0 neigh_suppress on\"\n\trun_cmd \"bridge -n sw1 -d link show dev vx0 | grep \\\"neigh_suppress on\\\"\"\n\tlog_test $? 0 \"\\\"neigh_suppress\\\" is on\"\n\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr1 -w 5000 $daddr1 eth0.$vid1\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid1)\"\n\trun_cmd \"ip netns exec h1 ndisc6 -q -r 1 -s $saddr2 -w 5000 $daddr2 eth0.$vid2\"\n\tlog_test $? 0 \"ndisc6 (VLAN $vid2)\"\n\n\ttc_check_packets sw1 \"dev vx0 egress\" 101 2\n\tlog_test $? 0 \"NS suppression (VLAN $vid1)\"\n\ttc_check_packets sw1 \"dev vx0 egress\" 102 5\n\tlog_test $? 0 \"NS suppression (VLAN $vid2)\"\n}\n\n################################################################################\n# Usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $TESTS)\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\n        -v          Verbose mode (show commands and output)\nEOF\n}\n\n################################################################################\n# Main\n\ntrap cleanup EXIT\n\nwhile getopts \":t:pPvh\" opt; do\n\tcase $opt in\n\t\tt) TESTS=$OPTARG;;\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\tv) VERBOSE=$(($VERBOSE + 1));;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# Make sure we don't pause twice.\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v bridge)\" ]; then\n\techo \"SKIP: Could not run test without bridge tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v tc)\" ]; then\n\techo \"SKIP: Could not run test without tc tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v arping)\" ]; then\n\techo \"SKIP: Could not run test without arping tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v ndisc6)\" ]; then\n\techo \"SKIP: Could not run test without ndisc6 tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v jq)\" ]; then\n\techo \"SKIP: Could not run test without jq tool\"\n\texit $ksft_skip\nfi\n\nbridge link help 2>&1 | grep -q \"neigh_vlan_suppress\"\nif [ $? -ne 0 ]; then\n   echo \"SKIP: iproute2 bridge too old, missing per-VLAN neighbor suppression support\"\n   exit $ksft_skip\nfi\n\n# Start clean.\ncleanup\n\nfor t in $TESTS\ndo\n\tsetup; $t; cleanup;\ndone\n\nif [ \"$TESTS\" != \"none\" ]; then\n\tprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\n\tprintf \"Tests failed: %3d\\n\"   ${nfail}\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}