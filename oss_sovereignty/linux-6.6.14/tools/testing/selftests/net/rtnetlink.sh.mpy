{
  "module_name": "rtnetlink.sh",
  "hash_id": "3c7e060ef76ab39c40852dfd5be3085e05772e24b67cc6537200f7cb4f61e32d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/rtnetlink.sh",
  "human_readable_source": "#!/bin/bash\n#\n# This test is for checking rtnetlink callpaths, and get as much coverage as possible.\n#\n# set -e\n\nALL_TESTS=\"\n\tkci_test_polrouting\n\tkci_test_route_get\n\tkci_test_addrlft\n\tkci_test_promote_secondaries\n\tkci_test_tc\n\tkci_test_gre\n\tkci_test_gretap\n\tkci_test_ip6gretap\n\tkci_test_erspan\n\tkci_test_ip6erspan\n\tkci_test_bridge\n\tkci_test_addrlabel\n\tkci_test_ifalias\n\tkci_test_vrf\n\tkci_test_encap\n\tkci_test_macsec\n\tkci_test_macsec_offload\n\tkci_test_ipsec\n\tkci_test_ipsec_offload\n\tkci_test_fdb_get\n\tkci_test_neigh_get\n\tkci_test_bridge_parent_id\n\tkci_test_address_proto\n\"\n\ndevdummy=\"test-dummy0\"\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# set global exit status, but never reset nonzero one.\ncheck_err()\n{\n\tif [ $ret -eq 0 ]; then\n\t\tret=$1\n\tfi\n}\n\n# same but inverted -- used when command must fail for test to pass\ncheck_fail()\n{\n\tif [ $1 -eq 0 ]; then\n\t\tret=1\n\tfi\n}\n\nkci_add_dummy()\n{\n\tip link add name \"$devdummy\" type dummy\n\tcheck_err $?\n\tip link set \"$devdummy\" up\n\tcheck_err $?\n}\n\nkci_del_dummy()\n{\n\tip link del dev \"$devdummy\"\n\tcheck_err $?\n}\n\nkci_test_netconf()\n{\n\tdev=\"$1\"\n\tr=$ret\n\n\tip netconf show dev \"$dev\" > /dev/null\n\tcheck_err $?\n\n\tfor f in 4 6; do\n\t\tip -$f netconf show dev \"$dev\" > /dev/null\n\t\tcheck_err $?\n\tdone\n\n\tif [ $ret -ne 0 ] ;then\n\t\techo \"FAIL: ip netconf show $dev\"\n\t\ttest $r -eq 0 && ret=0\n\t\treturn 1\n\tfi\n}\n\n# add a bridge with vlans on top\nkci_test_bridge()\n{\n\tdevbr=\"test-br0\"\n\tvlandev=\"testbr-vlan1\"\n\n\tlocal ret=0\n\tip link add name \"$devbr\" type bridge\n\tcheck_err $?\n\n\tip link set dev \"$devdummy\" master \"$devbr\"\n\tcheck_err $?\n\n\tip link set \"$devbr\" up\n\tcheck_err $?\n\n\tip link add link \"$devbr\" name \"$vlandev\" type vlan id 1\n\tcheck_err $?\n\tip addr add dev \"$vlandev\" 10.200.7.23/30\n\tcheck_err $?\n\tip -6 addr add dev \"$vlandev\" dead:42::1234/64\n\tcheck_err $?\n\tip -d link > /dev/null\n\tcheck_err $?\n\tip r s t all > /dev/null\n\tcheck_err $?\n\n\tfor name in \"$devbr\" \"$vlandev\" \"$devdummy\" ; do\n\t\tkci_test_netconf \"$name\"\n\tdone\n\n\tip -6 addr del dev \"$vlandev\" dead:42::1234/64\n\tcheck_err $?\n\n\tip link del dev \"$vlandev\"\n\tcheck_err $?\n\tip link del dev \"$devbr\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: bridge setup\"\n\t\treturn 1\n\tfi\n\techo \"PASS: bridge setup\"\n\n}\n\nkci_test_gre()\n{\n\tgredev=neta\n\trem=10.42.42.1\n\tloc=10.0.0.1\n\n\tlocal ret=0\n\tip tunnel add $gredev mode gre remote $rem local $loc ttl 1\n\tcheck_err $?\n\tip link set $gredev up\n\tcheck_err $?\n\tip addr add 10.23.7.10 dev $gredev\n\tcheck_err $?\n\tip route add 10.23.8.0/30 dev $gredev\n\tcheck_err $?\n\tip addr add dev \"$devdummy\" 10.23.7.11/24\n\tcheck_err $?\n\tip link > /dev/null\n\tcheck_err $?\n\tip addr > /dev/null\n\tcheck_err $?\n\n\tkci_test_netconf \"$gredev\"\n\n\tip addr del dev \"$devdummy\" 10.23.7.11/24\n\tcheck_err $?\n\n\tip link del $gredev\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: gre tunnel endpoint\"\n\t\treturn 1\n\tfi\n\techo \"PASS: gre tunnel endpoint\"\n}\n\n# tc uses rtnetlink too, for full tc testing\n# please see tools/testing/selftests/tc-testing.\nkci_test_tc()\n{\n\tdev=lo\n\tlocal ret=0\n\n\ttc qdisc add dev \"$dev\" root handle 1: htb\n\tcheck_err $?\n\ttc class add dev \"$dev\" parent 1: classid 1:10 htb rate 1mbit\n\tcheck_err $?\n\ttc filter add dev \"$dev\" parent 1:0 prio 5 handle ffe: protocol ip u32 divisor 256\n\tcheck_err $?\n\ttc filter add dev \"$dev\" parent 1:0 prio 5 handle ffd: protocol ip u32 divisor 256\n\tcheck_err $?\n\ttc filter add dev \"$dev\" parent 1:0 prio 5 handle ffc: protocol ip u32 divisor 256\n\tcheck_err $?\n\ttc filter add dev \"$dev\" protocol ip parent 1: prio 5 handle ffe:2:3 u32 ht ffe:2: match ip src 10.0.0.3 flowid 1:10\n\tcheck_err $?\n\ttc filter add dev \"$dev\" protocol ip parent 1: prio 5 handle ffe:2:2 u32 ht ffe:2: match ip src 10.0.0.2 flowid 1:10\n\tcheck_err $?\n\ttc filter show dev \"$dev\" parent  1:0 > /dev/null\n\tcheck_err $?\n\ttc filter del dev \"$dev\" protocol ip parent 1: prio 5 handle ffe:2:3 u32\n\tcheck_err $?\n\ttc filter show dev \"$dev\" parent  1:0 > /dev/null\n\tcheck_err $?\n\ttc qdisc del dev \"$dev\" root handle 1: htb\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: tc htb hierarchy\"\n\t\treturn 1\n\tfi\n\techo \"PASS: tc htb hierarchy\"\n\n}\n\nkci_test_polrouting()\n{\n\tlocal ret=0\n\tip rule add fwmark 1 lookup 100\n\tcheck_err $?\n\tip route add local 0.0.0.0/0 dev lo table 100\n\tcheck_err $?\n\tip r s t all > /dev/null\n\tcheck_err $?\n\tip rule del fwmark 1 lookup 100\n\tcheck_err $?\n\tip route del local 0.0.0.0/0 dev lo table 100\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: policy route test\"\n\t\treturn 1\n\tfi\n\techo \"PASS: policy routing\"\n}\n\nkci_test_route_get()\n{\n\tlocal hash_policy=$(sysctl -n net.ipv4.fib_multipath_hash_policy)\n\n\tlocal ret=0\n\n\tip route get 127.0.0.1 > /dev/null\n\tcheck_err $?\n\tip route get 127.0.0.1 dev \"$devdummy\" > /dev/null\n\tcheck_err $?\n\tip route get ::1 > /dev/null\n\tcheck_err $?\n\tip route get fe80::1 dev \"$devdummy\" > /dev/null\n\tcheck_err $?\n\tip route get 127.0.0.1 from 127.0.0.1 oif lo tos 0x10 mark 0x1 > /dev/null\n\tcheck_err $?\n\tip route get ::1 from ::1 iif lo oif lo tos 0x10 mark 0x1 > /dev/null\n\tcheck_err $?\n\tip addr add dev \"$devdummy\" 10.23.7.11/24\n\tcheck_err $?\n\tip route get 10.23.7.11 from 10.23.7.12 iif \"$devdummy\" > /dev/null\n\tcheck_err $?\n\tip route add 10.23.8.0/24 \\\n\t\tnexthop via 10.23.7.13 dev \"$devdummy\" \\\n\t\tnexthop via 10.23.7.14 dev \"$devdummy\"\n\tcheck_err $?\n\tsysctl -wq net.ipv4.fib_multipath_hash_policy=0\n\tip route get 10.23.8.11 > /dev/null\n\tcheck_err $?\n\tsysctl -wq net.ipv4.fib_multipath_hash_policy=1\n\tip route get 10.23.8.11 > /dev/null\n\tcheck_err $?\n\tsysctl -wq net.ipv4.fib_multipath_hash_policy=\"$hash_policy\"\n\tip route del 10.23.8.0/24\n\tcheck_err $?\n\tip addr del dev \"$devdummy\" 10.23.7.11/24\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: route get\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: route get\"\n}\n\nkci_test_addrlft()\n{\n\tfor i in $(seq 10 100) ;do\n\t\tlft=$(((RANDOM%3) + 1))\n\t\tip addr add 10.23.11.$i/32 dev \"$devdummy\" preferred_lft $lft valid_lft $((lft+1))\n\t\tcheck_err $?\n\tdone\n\n\tsleep 5\n\n\tip addr show dev \"$devdummy\" | grep \"10.23.11.\"\n\tif [ $? -eq 0 ]; then\n\t\techo \"FAIL: preferred_lft addresses remaining\"\n\t\tcheck_err 1\n\t\treturn\n\tfi\n\n\techo \"PASS: preferred_lft addresses have expired\"\n}\n\nkci_test_promote_secondaries()\n{\n\tpromote=$(sysctl -n net.ipv4.conf.$devdummy.promote_secondaries)\n\n\tsysctl -q net.ipv4.conf.$devdummy.promote_secondaries=1\n\n\tfor i in $(seq 2 254);do\n\t\tIP=\"10.23.11.$i\"\n\t\tip -f inet addr add $IP/16 brd + dev \"$devdummy\"\n\t\tifconfig \"$devdummy\" $IP netmask 255.255.0.0\n\tdone\n\n\tip addr flush dev \"$devdummy\"\n\n\t[ $promote -eq 0 ] && sysctl -q net.ipv4.conf.$devdummy.promote_secondaries=0\n\n\techo \"PASS: promote_secondaries complete\"\n}\n\nkci_test_addrlabel()\n{\n\tlocal ret=0\n\n\tip addrlabel add prefix dead::/64 dev lo label 1\n\tcheck_err $?\n\n\tip addrlabel list |grep -q \"prefix dead::/64 dev lo label 1\"\n\tcheck_err $?\n\n\tip addrlabel del prefix dead::/64 dev lo label 1 2> /dev/null\n\tcheck_err $?\n\n\tip addrlabel add prefix dead::/64 label 1 2> /dev/null\n\tcheck_err $?\n\n\tip addrlabel del prefix dead::/64 label 1 2> /dev/null\n\tcheck_err $?\n\n\t# concurrent add/delete\n\tfor i in $(seq 1 1000); do\n\t\tip addrlabel add prefix 1c3::/64 label 12345 2>/dev/null\n\tdone &\n\n\tfor i in $(seq 1 1000); do\n\t\tip addrlabel del prefix 1c3::/64 label 12345 2>/dev/null\n\tdone\n\n\twait\n\n\tip addrlabel del prefix 1c3::/64 label 12345 2>/dev/null\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: ipv6 addrlabel\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: ipv6 addrlabel\"\n}\n\nkci_test_ifalias()\n{\n\tlocal ret=0\n\tnamewant=$(uuidgen)\n\tsyspathname=\"/sys/class/net/$devdummy/ifalias\"\n\n\tip link set dev \"$devdummy\" alias \"$namewant\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: cannot set interface alias of $devdummy to $namewant\"\n\t\treturn 1\n\tfi\n\n\tip link show \"$devdummy\" | grep -q \"alias $namewant\"\n\tcheck_err $?\n\n\tif [ -r \"$syspathname\" ] ; then\n\t\tread namehave < \"$syspathname\"\n\t\tif [ \"$namewant\" != \"$namehave\" ]; then\n\t\t\techo \"FAIL: did set ifalias $namewant but got $namehave\"\n\t\t\treturn 1\n\t\tfi\n\n\t\tnamewant=$(uuidgen)\n\t\techo \"$namewant\" > \"$syspathname\"\n\t        ip link show \"$devdummy\" | grep -q \"alias $namewant\"\n\t\tcheck_err $?\n\n\t\t# sysfs interface allows to delete alias again\n\t\techo \"\" > \"$syspathname\"\n\n\t        ip link show \"$devdummy\" | grep -q \"alias $namewant\"\n\t\tcheck_fail $?\n\n\t\tfor i in $(seq 1 100); do\n\t\t\tuuidgen > \"$syspathname\" &\n\t\tdone\n\n\t\twait\n\n\t\t# re-add the alias -- kernel should free mem when dummy dev is removed\n\t\tip link set dev \"$devdummy\" alias \"$namewant\"\n\t\tcheck_err $?\n\tfi\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: set interface alias $devdummy to $namewant\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: set ifalias $namewant for $devdummy\"\n}\n\nkci_test_vrf()\n{\n\tvrfname=\"test-vrf\"\n\tlocal ret=0\n\n\tip link show type vrf 2>/dev/null\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP: vrf: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip link add \"$vrfname\" type vrf table 10\n\tcheck_err $?\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: can't add vrf interface, skipping test\"\n\t\treturn 0\n\tfi\n\n\tip -br link show type vrf | grep -q \"$vrfname\"\n\tcheck_err $?\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: created vrf device not found\"\n\t\treturn 1\n\tfi\n\n\tip link set dev \"$vrfname\" up\n\tcheck_err $?\n\n\tip link set dev \"$devdummy\" master \"$vrfname\"\n\tcheck_err $?\n\tip link del dev \"$vrfname\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: vrf\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: vrf\"\n}\n\nkci_test_encap_vxlan()\n{\n\tlocal ret=0\n\tvxlan=\"test-vxlan0\"\n\tvlan=\"test-vlan0\"\n\ttestns=\"$1\"\n\n\tip -netns \"$testns\" link add \"$vxlan\" type vxlan id 42 group 239.1.1.1 \\\n\t\tdev \"$devdummy\" dstport 4789 2>/dev/null\n\tif [ $? -ne 0 ]; then\n\t\techo \"FAIL: can't add vxlan interface, skipping test\"\n\t\treturn 0\n\tfi\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add 10.2.11.49/24 dev \"$vxlan\"\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set up dev \"$vxlan\"\n\tcheck_err $?\n\n\tip -netns \"$testns\" link add link \"$vxlan\" name \"$vlan\" type vlan id 1\n\tcheck_err $?\n\n\t# changelink testcases\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan vni 43 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan group ffe5::5 dev \"$devdummy\" 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan ttl inherit 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan ttl 64\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan nolearning\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan proxy 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan norsc 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan l2miss 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan l3miss 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan external 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan udpcsum 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan udp6zerocsumtx 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan udp6zerocsumrx 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan remcsumtx 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan remcsumrx 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan gbp 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link set dev \"$vxlan\" type vxlan gpe 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" link del \"$vxlan\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: vxlan\"\n\t\treturn 1\n\tfi\n\techo \"PASS: vxlan\"\n}\n\nkci_test_encap_fou()\n{\n\tlocal ret=0\n\tname=\"test-fou\"\n\ttestns=\"$1\"\n\n\tip fou help 2>&1 |grep -q 'Usage: ip fou'\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: fou: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\tif ! /sbin/modprobe -q -n fou; then\n\t\techo \"SKIP: module fou is not found\"\n\t\treturn $ksft_skip\n\tfi\n\t/sbin/modprobe -q fou\n\tip -netns \"$testns\" fou add port 7777 ipproto 47 2>/dev/null\n\tif [ $? -ne 0 ];then\n\t\techo \"FAIL: can't add fou port 7777, skipping test\"\n\t\treturn 1\n\tfi\n\n\tip -netns \"$testns\" fou add port 8888 ipproto 4\n\tcheck_err $?\n\n\tip -netns \"$testns\" fou del port 9999 2>/dev/null\n\tcheck_fail $?\n\n\tip -netns \"$testns\" fou del port 7777\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: fou\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: fou\"\n}\n\n# test various encap methods, use netns to avoid unwanted interference\nkci_test_encap()\n{\n\ttestns=\"testns\"\n\tlocal ret=0\n\n\tip netns add \"$testns\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP encap tests: cannot add net namespace $testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip -netns \"$testns\" link set lo up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link add name \"$devdummy\" type dummy\n\tcheck_err $?\n\tip -netns \"$testns\" link set \"$devdummy\" up\n\tcheck_err $?\n\n\tkci_test_encap_vxlan \"$testns\"\n\tcheck_err $?\n\tkci_test_encap_fou \"$testns\"\n\tcheck_err $?\n\n\tip netns del \"$testns\"\n\treturn $ret\n}\n\nkci_test_macsec()\n{\n\tmsname=\"test_macsec0\"\n\tlocal ret=0\n\n\tip macsec help 2>&1 | grep -q \"^Usage: ip macsec\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP: macsec: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip link add link \"$devdummy\" \"$msname\" type macsec port 42 encrypt on\n\tcheck_err $?\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: can't add macsec interface, skipping test\"\n\t\treturn 1\n\tfi\n\n\tip macsec add \"$msname\" tx sa 0 pn 1024 on key 01 12345678901234567890123456789012\n\tcheck_err $?\n\n\tip macsec add \"$msname\" rx port 1234 address \"1c:ed:de:ad:be:ef\"\n\tcheck_err $?\n\n\tip macsec add \"$msname\" rx port 1234 address \"1c:ed:de:ad:be:ef\" sa 0 pn 1 on key 00 0123456789abcdef0123456789abcdef\n\tcheck_err $?\n\n\tip macsec show > /dev/null\n\tcheck_err $?\n\n\tip link del dev \"$msname\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: macsec\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: macsec\"\n}\n\nkci_test_macsec_offload()\n{\n\tsysfsd=/sys/kernel/debug/netdevsim/netdevsim0/ports/0/\n\tsysfsnet=/sys/bus/netdevsim/devices/netdevsim0/net/\n\tprobed=false\n\tlocal ret=0\n\n\tip macsec help 2>&1 | grep -q \"^Usage: ip macsec\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP: macsec: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# setup netdevsim since dummydev doesn't have offload support\n\tif [ ! -w /sys/bus/netdevsim/new_device ] ; then\n\t\tmodprobe -q netdevsim\n\t\tcheck_err $?\n\t\tif [ $ret -ne 0 ]; then\n\t\t\techo \"SKIP: macsec_offload can't load netdevsim\"\n\t\t\treturn $ksft_skip\n\t\tfi\n\t\tprobed=true\n\tfi\n\n\techo \"0\" > /sys/bus/netdevsim/new_device\n\twhile [ ! -d $sysfsnet ] ; do :; done\n\tudevadm settle\n\tdev=`ls $sysfsnet`\n\n\tip link set $dev up\n\tif [ ! -d $sysfsd ] ; then\n\t\techo \"FAIL: macsec_offload can't create device $dev\"\n\t\treturn 1\n\tfi\n\n\tethtool -k $dev | grep -q 'macsec-hw-offload: on'\n\tif [ $? -eq 1 ] ; then\n\t\techo \"FAIL: macsec_offload netdevsim doesn't support MACsec offload\"\n\t\treturn 1\n\tfi\n\n\tip link add link $dev kci_macsec1 type macsec port 4 offload mac\n\tcheck_err $?\n\n\tip link add link $dev kci_macsec2 type macsec address \"aa:bb:cc:dd:ee:ff\" port 5 offload mac\n\tcheck_err $?\n\n\tip link add link $dev kci_macsec3 type macsec sci abbacdde01020304 offload mac\n\tcheck_err $?\n\n\tip link add link $dev kci_macsec4 type macsec port 8 offload mac 2> /dev/null\n\tcheck_fail $?\n\n\tmsname=kci_macsec1\n\n\tip macsec add \"$msname\" tx sa 0 pn 1024 on key 01 12345678901234567890123456789012\n\tcheck_err $?\n\n\tip macsec add \"$msname\" rx port 1234 address \"1c:ed:de:ad:be:ef\"\n\tcheck_err $?\n\n\tip macsec add \"$msname\" rx port 1234 address \"1c:ed:de:ad:be:ef\" sa 0 pn 1 on \\\n\t\tkey 00 0123456789abcdef0123456789abcdef\n\tcheck_err $?\n\n\tip macsec add \"$msname\" rx port 1235 address \"1c:ed:de:ad:be:ef\" 2> /dev/null\n\tcheck_fail $?\n\n\t# clean up any leftovers\n\tfor msdev in kci_macsec{1,2,3,4} ; do\n\t    ip link del $msdev 2> /dev/null\n\tdone\n\techo 0 > /sys/bus/netdevsim/del_device\n\t$probed && rmmod netdevsim\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: macsec_offload\"\n\t\treturn 1\n\tfi\n\techo \"PASS: macsec_offload\"\n}\n\n#-------------------------------------------------------------------\n# Example commands\n#   ip x s add proto esp src 14.0.0.52 dst 14.0.0.70 \\\n#            spi 0x07 mode transport reqid 0x07 replay-window 32 \\\n#            aead 'rfc4106(gcm(aes))' 1234567890123456dcba 128 \\\n#            sel src 14.0.0.52/24 dst 14.0.0.70/24\n#   ip x p add dir out src 14.0.0.52/24 dst 14.0.0.70/24 \\\n#            tmpl proto esp src 14.0.0.52 dst 14.0.0.70 \\\n#            spi 0x07 mode transport reqid 0x07\n#\n# Subcommands not tested\n#    ip x s update\n#    ip x s allocspi\n#    ip x s deleteall\n#    ip x p update\n#    ip x p deleteall\n#    ip x p set\n#-------------------------------------------------------------------\nkci_test_ipsec()\n{\n\tlocal ret=0\n\talgo=\"aead rfc4106(gcm(aes)) 0x3132333435363738393031323334353664636261 128\"\n\tsrcip=192.168.123.1\n\tdstip=192.168.123.2\n\tspi=7\n\n\tip addr add $srcip dev $devdummy\n\n\t# flush to be sure there's nothing configured\n\tip x s flush ; ip x p flush\n\tcheck_err $?\n\n\t# start the monitor in the background\n\ttmpfile=`mktemp /var/run/ipsectestXXX`\n\tmpid=`(ip x m > $tmpfile & echo $!) 2>/dev/null`\n\tsleep 0.2\n\n\tipsecid=\"proto esp src $srcip dst $dstip spi 0x07\"\n\tip x s add $ipsecid \\\n            mode transport reqid 0x07 replay-window 32 \\\n            $algo sel src $srcip/24 dst $dstip/24\n\tcheck_err $?\n\n\tlines=`ip x s list | grep $srcip | grep $dstip | wc -l`\n\ttest $lines -eq 2\n\tcheck_err $?\n\n\tip x s count | grep -q \"SAD count 1\"\n\tcheck_err $?\n\n\tlines=`ip x s get $ipsecid | grep $srcip | grep $dstip | wc -l`\n\ttest $lines -eq 2\n\tcheck_err $?\n\n\tip x s delete $ipsecid\n\tcheck_err $?\n\n\tlines=`ip x s list | wc -l`\n\ttest $lines -eq 0\n\tcheck_err $?\n\n\tipsecsel=\"dir out src $srcip/24 dst $dstip/24\"\n\tip x p add $ipsecsel \\\n\t\t    tmpl proto esp src $srcip dst $dstip \\\n\t\t    spi 0x07 mode transport reqid 0x07\n\tcheck_err $?\n\n\tlines=`ip x p list | grep $srcip | grep $dstip | wc -l`\n\ttest $lines -eq 2\n\tcheck_err $?\n\n\tip x p count | grep -q \"SPD IN  0 OUT 1 FWD 0\"\n\tcheck_err $?\n\n\tlines=`ip x p get $ipsecsel | grep $srcip | grep $dstip | wc -l`\n\ttest $lines -eq 2\n\tcheck_err $?\n\n\tip x p delete $ipsecsel\n\tcheck_err $?\n\n\tlines=`ip x p list | wc -l`\n\ttest $lines -eq 0\n\tcheck_err $?\n\n\t# check the monitor results\n\tkill $mpid\n\tlines=`wc -l $tmpfile | cut \"-d \" -f1`\n\ttest $lines -eq 20\n\tcheck_err $?\n\trm -rf $tmpfile\n\n\t# clean up any leftovers\n\tip x s flush\n\tcheck_err $?\n\tip x p flush\n\tcheck_err $?\n\tip addr del $srcip/32 dev $devdummy\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: ipsec\"\n\t\treturn 1\n\tfi\n\techo \"PASS: ipsec\"\n}\n\n#-------------------------------------------------------------------\n# Example commands\n#   ip x s add proto esp src 14.0.0.52 dst 14.0.0.70 \\\n#            spi 0x07 mode transport reqid 0x07 replay-window 32 \\\n#            aead 'rfc4106(gcm(aes))' 1234567890123456dcba 128 \\\n#            sel src 14.0.0.52/24 dst 14.0.0.70/24\n#            offload dev sim1 dir out\n#   ip x p add dir out src 14.0.0.52/24 dst 14.0.0.70/24 \\\n#            tmpl proto esp src 14.0.0.52 dst 14.0.0.70 \\\n#            spi 0x07 mode transport reqid 0x07\n#\n#-------------------------------------------------------------------\nkci_test_ipsec_offload()\n{\n\tlocal ret=0\n\talgo=\"aead rfc4106(gcm(aes)) 0x3132333435363738393031323334353664636261 128\"\n\tsrcip=192.168.123.3\n\tdstip=192.168.123.4\n\tsysfsd=/sys/kernel/debug/netdevsim/netdevsim0/ports/0/\n\tsysfsf=$sysfsd/ipsec\n\tsysfsnet=/sys/bus/netdevsim/devices/netdevsim0/net/\n\tprobed=false\n\n\t# setup netdevsim since dummydev doesn't have offload support\n\tif [ ! -w /sys/bus/netdevsim/new_device ] ; then\n\t\tmodprobe -q netdevsim\n\t\tcheck_err $?\n\t\tif [ $ret -ne 0 ]; then\n\t\t\techo \"SKIP: ipsec_offload can't load netdevsim\"\n\t\t\treturn $ksft_skip\n\t\tfi\n\t\tprobed=true\n\tfi\n\n\techo \"0\" > /sys/bus/netdevsim/new_device\n\twhile [ ! -d $sysfsnet ] ; do :; done\n\tudevadm settle\n\tdev=`ls $sysfsnet`\n\n\tip addr add $srcip dev $dev\n\tip link set $dev up\n\tif [ ! -d $sysfsd ] ; then\n\t\techo \"FAIL: ipsec_offload can't create device $dev\"\n\t\treturn 1\n\tfi\n\tif [ ! -f $sysfsf ] ; then\n\t\techo \"FAIL: ipsec_offload netdevsim doesn't support IPsec offload\"\n\t\treturn 1\n\tfi\n\n\t# flush to be sure there's nothing configured\n\tip x s flush ; ip x p flush\n\n\t# create offloaded SAs, both in and out\n\tip x p add dir out src $srcip/24 dst $dstip/24 \\\n\t    tmpl proto esp src $srcip dst $dstip spi 9 \\\n\t    mode transport reqid 42\n\tcheck_err $?\n\tip x p add dir in src $dstip/24 dst $srcip/24 \\\n\t    tmpl proto esp src $dstip dst $srcip spi 9 \\\n\t    mode transport reqid 42\n\tcheck_err $?\n\n\tip x s add proto esp src $srcip dst $dstip spi 9 \\\n\t    mode transport reqid 42 $algo sel src $srcip/24 dst $dstip/24 \\\n\t    offload dev $dev dir out\n\tcheck_err $?\n\tip x s add proto esp src $dstip dst $srcip spi 9 \\\n\t    mode transport reqid 42 $algo sel src $dstip/24 dst $srcip/24 \\\n\t    offload dev $dev dir in\n\tcheck_err $?\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: ipsec_offload can't create SA\"\n\t\treturn 1\n\tfi\n\n\t# does offload show up in ip output\n\tlines=`ip x s list | grep -c \"crypto offload parameters: dev $dev dir\"`\n\tif [ $lines -ne 2 ] ; then\n\t\techo \"FAIL: ipsec_offload SA offload missing from list output\"\n\t\tcheck_err 1\n\tfi\n\n\t# use ping to exercise the Tx path\n\tping -I $dev -c 3 -W 1 -i 0 $dstip >/dev/null\n\n\t# does driver have correct offload info\n\tdiff $sysfsf - << EOF\nSA count=2 tx=3\nsa[0] tx ipaddr=0x00000000 00000000 00000000 00000000\nsa[0]    spi=0x00000009 proto=0x32 salt=0x61626364 crypt=1\nsa[0]    key=0x34333231 38373635 32313039 36353433\nsa[1] rx ipaddr=0x00000000 00000000 00000000 037ba8c0\nsa[1]    spi=0x00000009 proto=0x32 salt=0x61626364 crypt=1\nsa[1]    key=0x34333231 38373635 32313039 36353433\nEOF\n\tif [ $? -ne 0 ] ; then\n\t\techo \"FAIL: ipsec_offload incorrect driver data\"\n\t\tcheck_err 1\n\tfi\n\n\t# does offload get removed from driver\n\tip x s flush\n\tip x p flush\n\tlines=`grep -c \"SA count=0\" $sysfsf`\n\tif [ $lines -ne 1 ] ; then\n\t\techo \"FAIL: ipsec_offload SA not removed from driver\"\n\t\tcheck_err 1\n\tfi\n\n\t# clean up any leftovers\n\techo 0 > /sys/bus/netdevsim/del_device\n\t$probed && rmmod netdevsim\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: ipsec_offload\"\n\t\treturn 1\n\tfi\n\techo \"PASS: ipsec_offload\"\n}\n\nkci_test_gretap()\n{\n\ttestns=\"testns\"\n\tDEV_NS=gretap00\n\tlocal ret=0\n\n\tip netns add \"$testns\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP gretap tests: cannot add net namespace $testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip link help gretap 2>&1 | grep -q \"^Usage:\"\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: gretap: iproute2 too old\"\n\t\tip netns del \"$testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# test native tunnel\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type gretap seq \\\n\t\tkey 102 local 172.16.1.100 remote 172.16.1.200\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add dev \"$DEV_NS\" 10.1.1.100/24\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev $DEV_NS up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\t# test external mode\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type gretap external\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: gretap\"\n\t\tip netns del \"$testns\"\n\t\treturn 1\n\tfi\n\techo \"PASS: gretap\"\n\n\tip netns del \"$testns\"\n}\n\nkci_test_ip6gretap()\n{\n\ttestns=\"testns\"\n\tDEV_NS=ip6gretap00\n\tlocal ret=0\n\n\tip netns add \"$testns\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP ip6gretap tests: cannot add net namespace $testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip link help ip6gretap 2>&1 | grep -q \"^Usage:\"\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: ip6gretap: iproute2 too old\"\n\t\tip netns del \"$testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# test native tunnel\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type ip6gretap seq \\\n\t\tkey 102 local fc00:100::1 remote fc00:100::2\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add dev \"$DEV_NS\" fc00:200::1/96\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev $DEV_NS up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\t# test external mode\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type ip6gretap external\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: ip6gretap\"\n\t\tip netns del \"$testns\"\n\t\treturn 1\n\tfi\n\techo \"PASS: ip6gretap\"\n\n\tip netns del \"$testns\"\n}\n\nkci_test_erspan()\n{\n\ttestns=\"testns\"\n\tDEV_NS=erspan00\n\tlocal ret=0\n\n\tip link help erspan 2>&1 | grep -q \"^Usage:\"\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: erspan: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip netns add \"$testns\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP erspan tests: cannot add net namespace $testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# test native tunnel erspan v1\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type erspan seq \\\n\t\tkey 102 local 172.16.1.100 remote 172.16.1.200 \\\n\t\terspan_ver 1 erspan 488\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add dev \"$DEV_NS\" 10.1.1.100/24\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev $DEV_NS up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\t# test native tunnel erspan v2\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type erspan seq \\\n\t\tkey 102 local 172.16.1.100 remote 172.16.1.200 \\\n\t\terspan_ver 2 erspan_dir ingress erspan_hwid 7\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add dev \"$DEV_NS\" 10.1.1.100/24\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev $DEV_NS up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\t# test external mode\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type erspan external\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: erspan\"\n\t\tip netns del \"$testns\"\n\t\treturn 1\n\tfi\n\techo \"PASS: erspan\"\n\n\tip netns del \"$testns\"\n}\n\nkci_test_ip6erspan()\n{\n\ttestns=\"testns\"\n\tDEV_NS=ip6erspan00\n\tlocal ret=0\n\n\tip link help ip6erspan 2>&1 | grep -q \"^Usage:\"\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: ip6erspan: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip netns add \"$testns\"\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP ip6erspan tests: cannot add net namespace $testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# test native tunnel ip6erspan v1\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type ip6erspan seq \\\n\t\tkey 102 local fc00:100::1 remote fc00:100::2 \\\n\t\terspan_ver 1 erspan 488\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add dev \"$DEV_NS\" 10.1.1.100/24\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev $DEV_NS up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\t# test native tunnel ip6erspan v2\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" type ip6erspan seq \\\n\t\tkey 102 local fc00:100::1 remote fc00:100::2 \\\n\t\terspan_ver 2 erspan_dir ingress erspan_hwid 7\n\tcheck_err $?\n\n\tip -netns \"$testns\" addr add dev \"$DEV_NS\" 10.1.1.100/24\n\tcheck_err $?\n\n\tip -netns \"$testns\" link set dev $DEV_NS up\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\t# test external mode\n\tip -netns \"$testns\" link add dev \"$DEV_NS\" \\\n\t\ttype ip6erspan external\n\tcheck_err $?\n\n\tip -netns \"$testns\" link del \"$DEV_NS\"\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: ip6erspan\"\n\t\tip netns del \"$testns\"\n\t\treturn 1\n\tfi\n\techo \"PASS: ip6erspan\"\n\n\tip netns del \"$testns\"\n}\n\nkci_test_fdb_get()\n{\n\tIP=\"ip -netns testns\"\n\tBRIDGE=\"bridge -netns testns\"\n\tbrdev=\"test-br0\"\n\tvxlandev=\"vxlan10\"\n\ttest_mac=de:ad:be:ef:13:37\n\tlocalip=\"10.0.2.2\"\n\tdstip=\"10.0.2.3\"\n\tlocal ret=0\n\n\tbridge fdb help 2>&1 |grep -q 'bridge fdb get'\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: fdb get tests: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip netns add testns\n\tif [ $? -ne 0 ]; then\n\t\techo \"SKIP fdb get tests: cannot add net namespace $testns\"\n\t\treturn $ksft_skip\n\tfi\n\n\t$IP link add \"$vxlandev\" type vxlan id 10 local $localip \\\n                dstport 4789 2>/dev/null\n\tcheck_err $?\n\t$IP link add name \"$brdev\" type bridge &>/dev/null\n\tcheck_err $?\n\t$IP link set dev \"$vxlandev\" master \"$brdev\" &>/dev/null\n\tcheck_err $?\n\t$BRIDGE fdb add $test_mac dev \"$vxlandev\" master &>/dev/null\n\tcheck_err $?\n\t$BRIDGE fdb add $test_mac dev \"$vxlandev\" dst $dstip self &>/dev/null\n\tcheck_err $?\n\n\t$BRIDGE fdb get $test_mac brport \"$vxlandev\" 2>/dev/null | grep -q \"dev $vxlandev master $brdev\"\n\tcheck_err $?\n\t$BRIDGE fdb get $test_mac br \"$brdev\" 2>/dev/null | grep -q \"dev $vxlandev master $brdev\"\n\tcheck_err $?\n\t$BRIDGE fdb get $test_mac dev \"$vxlandev\" self 2>/dev/null | grep -q \"dev $vxlandev dst $dstip\"\n\tcheck_err $?\n\n\tip netns del testns &>/dev/null\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: bridge fdb get\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: bridge fdb get\"\n}\n\nkci_test_neigh_get()\n{\n\tdstmac=de:ad:be:ef:13:37\n\tdstip=10.0.2.4\n\tdstip6=dead::2\n\tlocal ret=0\n\n\tip neigh help 2>&1 |grep -q 'ip neigh get'\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: fdb get tests: iproute2 too old\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# ipv4\n\tip neigh add $dstip lladdr $dstmac dev \"$devdummy\"  > /dev/null\n\tcheck_err $?\n\tip neigh get $dstip dev \"$devdummy\" 2> /dev/null | grep -q \"$dstmac\"\n\tcheck_err $?\n\tip neigh del $dstip lladdr $dstmac dev \"$devdummy\"  > /dev/null\n\tcheck_err $?\n\n\t# ipv4 proxy\n\tip neigh add proxy $dstip dev \"$devdummy\" > /dev/null\n\tcheck_err $?\n\tip neigh get proxy $dstip dev \"$devdummy\" 2>/dev/null | grep -q \"$dstip\"\n\tcheck_err $?\n\tip neigh del proxy $dstip dev \"$devdummy\" > /dev/null\n\tcheck_err $?\n\n\t# ipv6\n\tip neigh add $dstip6 lladdr $dstmac dev \"$devdummy\"  > /dev/null\n\tcheck_err $?\n\tip neigh get $dstip6 dev \"$devdummy\" 2> /dev/null | grep -q \"$dstmac\"\n\tcheck_err $?\n\tip neigh del $dstip6 lladdr $dstmac dev \"$devdummy\"  > /dev/null\n\tcheck_err $?\n\n\t# ipv6 proxy\n\tip neigh add proxy $dstip6 dev \"$devdummy\" > /dev/null\n\tcheck_err $?\n\tip neigh get proxy $dstip6 dev \"$devdummy\" 2>/dev/null | grep -q \"$dstip6\"\n\tcheck_err $?\n\tip neigh del proxy $dstip6 dev \"$devdummy\" > /dev/null\n\tcheck_err $?\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: neigh get\"\n\t\treturn 1\n\tfi\n\n\techo \"PASS: neigh get\"\n}\n\nkci_test_bridge_parent_id()\n{\n\tlocal ret=0\n\tsysfsnet=/sys/bus/netdevsim/devices/netdevsim\n\tprobed=false\n\n\tif [ ! -w /sys/bus/netdevsim/new_device ] ; then\n\t\tmodprobe -q netdevsim\n\t\tcheck_err $?\n\t\tif [ $ret -ne 0 ]; then\n\t\t\techo \"SKIP: bridge_parent_id can't load netdevsim\"\n\t\t\treturn $ksft_skip\n\t\tfi\n\t\tprobed=true\n\tfi\n\n\techo \"10 1\" > /sys/bus/netdevsim/new_device\n\twhile [ ! -d ${sysfsnet}10 ] ; do :; done\n\techo \"20 1\" > /sys/bus/netdevsim/new_device\n\twhile [ ! -d ${sysfsnet}20 ] ; do :; done\n\tudevadm settle\n\tdev10=`ls ${sysfsnet}10/net/`\n\tdev20=`ls ${sysfsnet}20/net/`\n\n\tip link add name test-bond0 type bond mode 802.3ad\n\tip link set dev $dev10 master test-bond0\n\tip link set dev $dev20 master test-bond0\n\tip link add name test-br0 type bridge\n\tip link set dev test-bond0 master test-br0\n\tcheck_err $?\n\n\t# clean up any leftovers\n\tip link del dev test-br0\n\tip link del dev test-bond0\n\techo 20 > /sys/bus/netdevsim/del_device\n\techo 10 > /sys/bus/netdevsim/del_device\n\t$probed && rmmod netdevsim\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: bridge_parent_id\"\n\t\treturn 1\n\tfi\n\techo \"PASS: bridge_parent_id\"\n}\n\naddress_get_proto()\n{\n\tlocal addr=$1; shift\n\n\tip -N -j address show dev \"$devdummy\" |\n\t    jq -e -r --arg addr \"${addr%/*}\" \\\n\t       '.[].addr_info[] | select(.local == $addr) | .protocol'\n}\n\naddress_count()\n{\n\tip -N -j address show dev \"$devdummy\" \"$@\" |\n\t    jq -e -r '[.[].addr_info[] | .local | select(. != null)] | length'\n}\n\ndo_test_address_proto()\n{\n\tlocal what=$1; shift\n\tlocal addr=$1; shift\n\tlocal addr2=${addr%/*}2/${addr#*/}\n\tlocal addr3=${addr%/*}3/${addr#*/}\n\tlocal proto\n\tlocal count\n\tlocal ret=0\n\tlocal err\n\n\tip address add dev \"$devdummy\" \"$addr3\"\n\tcheck_err $?\n\tproto=$(address_get_proto \"$addr3\")\n\t[[ \"$proto\" == null ]]\n\tcheck_err $?\n\n\tip address add dev \"$devdummy\" \"$addr2\" proto 0x99\n\tcheck_err $?\n\tproto=$(address_get_proto \"$addr2\")\n\t[[ \"$proto\" == 0x99 ]]\n\tcheck_err $?\n\n\tip address add dev \"$devdummy\" \"$addr\" proto 0xab\n\tcheck_err $?\n\tproto=$(address_get_proto \"$addr\")\n\t[[ \"$proto\" == 0xab ]]\n\tcheck_err $?\n\n\tip address replace dev \"$devdummy\" \"$addr\" proto 0x11\n\tproto=$(address_get_proto \"$addr\")\n\tcheck_err $?\n\t[[ \"$proto\" == 0x11 ]]\n\tcheck_err $?\n\n\tcount=$(address_count)\n\tcheck_err $?\n\t(( count >= 3 )) # $addr, $addr2 and $addr3 plus any kernel addresses\n\tcheck_err $?\n\n\tcount=$(address_count proto 0)\n\tcheck_err $?\n\t(( count == 1 )) # just $addr3\n\tcheck_err $?\n\n\tcount=$(address_count proto 0x11)\n\tcheck_err $?\n\t(( count == 2 )) # $addr and $addr3\n\tcheck_err $?\n\n\tcount=$(address_count proto 0xab)\n\tcheck_err $?\n\t(( count == 1 )) # just $addr3\n\tcheck_err $?\n\n\tip address del dev \"$devdummy\" \"$addr\"\n\tip address del dev \"$devdummy\" \"$addr2\"\n\tip address del dev \"$devdummy\" \"$addr3\"\n\n\tif [ $ret -ne 0 ]; then\n\t\techo \"FAIL: address proto $what\"\n\t\treturn 1\n\tfi\n\techo \"PASS: address proto $what\"\n}\n\nkci_test_address_proto()\n{\n\tlocal ret=0\n\n\tdo_test_address_proto IPv4 192.0.2.1/28\n\tcheck_err $?\n\n\tdo_test_address_proto IPv6 2001:db8:1::1/64\n\tcheck_err $?\n\n\treturn $ret\n}\n\nkci_test_rtnl()\n{\n\tlocal current_test\n\tlocal ret=0\n\n\tkci_add_dummy\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: cannot add dummy interface\"\n\t\treturn 1\n\tfi\n\n\tfor current_test in ${TESTS:-$ALL_TESTS}; do\n\t\t$current_test\n\t\tcheck_err $?\n\tdone\n\n\tkci_del_dummy\n\treturn $ret\n}\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n\n        -t <test>   Test(s) to run (default: all)\n                    (options: $(echo $ALL_TESTS))\nEOF\n}\n\n#check for needed privileges\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip\nfi\n\nfor x in ip tc;do\n\t$x -Version 2>/dev/null >/dev/null\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: Could not run test without the $x tool\"\n\t\texit $ksft_skip\n\tfi\ndone\n\nwhile getopts t:h o; do\n\tcase $o in\n\t\tt) TESTS=$OPTARG;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\nkci_test_rtnl\n\nexit $?\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}