{
  "module_name": "netdevice.sh",
  "hash_id": "5647d371a260b1dff2c2d0a7e8e798f014fde930bf70e0a282eb9161d9fee43d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/netdevice.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n#\n# This test is for checking network interface\n# For the moment it tests only ethernet interface (but wifi could be easily added)\n#\n# We assume that all network driver are loaded\n# if not they probably have failed earlier in the boot process and their logged error will be catched by another test\n#\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n# this function will try to up the interface\n# if already up, nothing done\n# arg1: network interface name\nkci_net_start()\n{\n\tnetdev=$1\n\n\tip link show \"$netdev\" |grep -q UP\n\tif [ $? -eq 0 ];then\n\t\techo \"SKIP: $netdev: interface already up\"\n\t\treturn $ksft_skip\n\tfi\n\n\tip link set \"$netdev\" up\n\tif [ $? -ne 0 ];then\n\t\techo \"FAIL: $netdev: Fail to up interface\"\n\t\treturn 1\n\telse\n\t\techo \"PASS: $netdev: set interface up\"\n\t\tNETDEV_STARTED=1\n\tfi\n\treturn 0\n}\n\n# this function will try to setup an IP and MAC address on a network interface\n# Doing nothing if the interface was already up\n# arg1: network interface name\nkci_net_setup()\n{\n\tnetdev=$1\n\n\t# do nothing if the interface was already up\n\tif [ $NETDEV_STARTED -eq 0 ];then\n\t\treturn 0\n\tfi\n\n\tMACADDR='02:03:04:05:06:07'\n\tip link set dev $netdev address \"$MACADDR\"\n\tif [ $? -ne 0 ];then\n\t\techo \"FAIL: $netdev: Cannot set MAC address\"\n\telse\n\t\tip link show $netdev |grep -q \"$MACADDR\"\n\t\tif [ $? -eq 0 ];then\n\t\t\techo \"PASS: $netdev: set MAC address\"\n\t\telse\n\t\t\techo \"FAIL: $netdev: Cannot set MAC address\"\n\t\tfi\n\tfi\n\n\t#check that the interface did not already have an IP\n\tip address show \"$netdev\" |grep '^[[:space:]]*inet'\n\tif [ $? -eq 0 ];then\n\t\techo \"SKIP: $netdev: already have an IP\"\n\t\treturn $ksft_skip\n\tfi\n\n\t# TODO what ipaddr to set ? DHCP ?\n\techo \"SKIP: $netdev: set IP address\"\n\treturn $ksft_skip\n}\n\n# test an ethtool command\n# arg1: return code for not supported (see ethtool code source)\n# arg2: summary of the command\n# arg3: command to execute\nkci_netdev_ethtool_test()\n{\n\tif [ $# -le 2 ];then\n\t\techo \"SKIP: $netdev: ethtool: invalid number of arguments\"\n\t\treturn 1\n\tfi\n\t$3 >/dev/null\n\tret=$?\n\tif [ $ret -ne 0 ];then\n\t\tif [ $ret -eq \"$1\" ];then\n\t\t\techo \"SKIP: $netdev: ethtool $2 not supported\"\n\t\t\treturn $ksft_skip\n\t\telse\n\t\t\techo \"FAIL: $netdev: ethtool $2\"\n\t\t\treturn 1\n\t\tfi\n\telse\n\t\techo \"PASS: $netdev: ethtool $2\"\n\tfi\n\treturn 0\n}\n\n# test ethtool commands\n# arg1: network interface name\nkci_netdev_ethtool()\n{\n\tnetdev=$1\n\n\t#check presence of ethtool\n\tethtool --version 2>/dev/null >/dev/null\n\tif [ $? -ne 0 ];then\n\t\techo \"SKIP: ethtool not present\"\n\t\treturn $ksft_skip\n\tfi\n\n\tTMP_ETHTOOL_FEATURES=\"$(mktemp)\"\n\tif [ ! -e \"$TMP_ETHTOOL_FEATURES\" ];then\n\t\techo \"SKIP: Cannot create a tmp file\"\n\t\treturn 1\n\tfi\n\n\tethtool -k \"$netdev\" > \"$TMP_ETHTOOL_FEATURES\"\n\tif [ $? -ne 0 ];then\n\t\techo \"FAIL: $netdev: ethtool list features\"\n\t\trm \"$TMP_ETHTOOL_FEATURES\"\n\t\treturn 1\n\tfi\n\techo \"PASS: $netdev: ethtool list features\"\n\t#TODO for each non fixed features, try to turn them on/off\n\trm \"$TMP_ETHTOOL_FEATURES\"\n\n\tkci_netdev_ethtool_test 74 'dump' \"ethtool -d $netdev\"\n\tkci_netdev_ethtool_test 94 'stats' \"ethtool -S $netdev\"\n\treturn 0\n}\n\n# stop a netdev\n# arg1: network interface name\nkci_netdev_stop()\n{\n\tnetdev=$1\n\n\tif [ $NETDEV_STARTED -eq 0 ];then\n\t\techo \"SKIP: $netdev: interface kept up\"\n\t\treturn 0\n\tfi\n\n\tip link set \"$netdev\" down\n\tif [ $? -ne 0 ];then\n\t\techo \"FAIL: $netdev: stop interface\"\n\t\treturn 1\n\tfi\n\techo \"PASS: $netdev: stop interface\"\n\treturn 0\n}\n\n# run all test on a netdev\n# arg1: network interface name\nkci_test_netdev()\n{\n\tNETDEV_STARTED=0\n\tIFACE_TO_UPDOWN=\"$1\"\n\tIFACE_TO_TEST=\"$1\"\n\t#check for VLAN interface\n\tMASTER_IFACE=\"$(echo $1 | cut -d@ -f2)\"\n\tif [ ! -z \"$MASTER_IFACE\" ];then\n\t\tIFACE_TO_UPDOWN=\"$MASTER_IFACE\"\n\t\tIFACE_TO_TEST=\"$(echo $1 | cut -d@ -f1)\"\n\tfi\n\n\tNETDEV_STARTED=0\n\tkci_net_start \"$IFACE_TO_UPDOWN\"\n\n\tkci_net_setup \"$IFACE_TO_TEST\"\n\n\tkci_netdev_ethtool \"$IFACE_TO_TEST\"\n\n\tkci_netdev_stop \"$IFACE_TO_UPDOWN\"\n\treturn 0\n}\n\n#check for needed privileges\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip\nfi\n\nip link show 2>/dev/null >/dev/null\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without the ip tool\"\n\texit $ksft_skip\nfi\n\nTMP_LIST_NETDEV=\"$(mktemp)\"\nif [ ! -e \"$TMP_LIST_NETDEV\" ];then\n\techo \"FAIL: Cannot create a tmp file\"\n\texit 1\nfi\n\nip link show |grep '^[0-9]' | grep -oE '[[:space:]].*eth[0-9]*:|[[:space:]].*enp[0-9]s[0-9]:' | cut -d\\  -f2 | cut -d: -f1> \"$TMP_LIST_NETDEV\"\nwhile read netdev\ndo\n\tkci_test_netdev \"$netdev\"\ndone < \"$TMP_LIST_NETDEV\"\n\nrm \"$TMP_LIST_NETDEV\"\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}