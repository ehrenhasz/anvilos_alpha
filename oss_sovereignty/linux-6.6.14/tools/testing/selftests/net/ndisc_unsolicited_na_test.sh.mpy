{
  "module_name": "ndisc_unsolicited_na_test.sh",
  "hash_id": "1a9124a7092c993ec8ef3f7062970c7b6c30d67227027fc3291bb8498d78d21b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/ndisc_unsolicited_na_test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# This test is for the accept_untracked_na feature to\n# enable RFC9131 behaviour. The following is the test-matrix.\n# drop   accept  fwding                   behaviour\n# ----   ------  ------  ----------------------------------------------\n#    1        X       X  Don't update NC\n#    0        0       X  Don't update NC\n#    0        1       0  Don't update NC\n#    0        1       1  Add a STALE NC entry\n\nret=0\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nPAUSE_ON_FAIL=no\nPAUSE=no\n\nHOST_NS=\"ns-host\"\nROUTER_NS=\"ns-router\"\n\nHOST_INTF=\"veth-host\"\nROUTER_INTF=\"veth-router\"\n\nROUTER_ADDR=\"2000:20::1\"\nHOST_ADDR=\"2000:20::2\"\nSUBNET_WIDTH=64\nROUTER_ADDR_WITH_MASK=\"${ROUTER_ADDR}/${SUBNET_WIDTH}\"\nHOST_ADDR_WITH_MASK=\"${HOST_ADDR}/${SUBNET_WIDTH}\"\n\nIP_HOST=\"ip -6 -netns ${HOST_NS}\"\nIP_HOST_EXEC=\"ip netns exec ${HOST_NS}\"\nIP_ROUTER=\"ip -6 -netns ${ROUTER_NS}\"\nIP_ROUTER_EXEC=\"ip netns exec ${ROUTER_NS}\"\n\ntcpdump_stdout=\ntcpdump_stderr=\n\nlog_test()\n{\n\tlocal rc=$1\n\tlocal expected=$2\n\tlocal msg=\"$3\"\n\n\tif [ ${rc} -eq ${expected} ]; then\n\t\tprintf \"    TEST: %-60s  [ OK ]\\n\" \"${msg}\"\n\t\tnsuccess=$((nsuccess+1))\n\telse\n\t\tret=1\n\t\tnfail=$((nfail+1))\n\t\tprintf \"    TEST: %-60s  [FAIL]\\n\" \"${msg}\"\n\t\tif [ \"${PAUSE_ON_FAIL}\" = \"yes\" ]; then\n\t\techo\n\t\t\techo \"hit enter to continue, 'q' to quit\"\n\t\t\tread a\n\t\t\t[ \"$a\" = \"q\" ] && exit 1\n\t\tfi\n\tfi\n\n\tif [ \"${PAUSE}\" = \"yes\" ]; then\n\t\techo\n\t\techo \"hit enter to continue, 'q' to quit\"\n\t\tread a\n\t\t[ \"$a\" = \"q\" ] && exit 1\n\tfi\n}\n\nsetup()\n{\n\tset -e\n\n\tlocal drop_unsolicited_na=$1\n\tlocal accept_untracked_na=$2\n\tlocal forwarding=$3\n\n\t# Setup two namespaces and a veth tunnel across them.\n\t# On end of the tunnel is a router and the other end is a host.\n\tip netns add ${HOST_NS}\n\tip netns add ${ROUTER_NS}\n\t${IP_ROUTER} link add ${ROUTER_INTF} type veth \\\n                peer name ${HOST_INTF} netns ${HOST_NS}\n\n\t# Enable IPv6 on both router and host, and configure static addresses.\n\t# The router here is the DUT\n\t# Setup router configuration as specified by the arguments.\n\t# forwarding=0 case is to check that a non-router\n\t# doesn't add neighbour entries.\n        ROUTER_CONF=net.ipv6.conf.${ROUTER_INTF}\n\t${IP_ROUTER_EXEC} sysctl -qw \\\n                ${ROUTER_CONF}.forwarding=${forwarding}\n\t${IP_ROUTER_EXEC} sysctl -qw \\\n                ${ROUTER_CONF}.drop_unsolicited_na=${drop_unsolicited_na}\n\t${IP_ROUTER_EXEC} sysctl -qw \\\n                ${ROUTER_CONF}.accept_untracked_na=${accept_untracked_na}\n\t${IP_ROUTER_EXEC} sysctl -qw ${ROUTER_CONF}.disable_ipv6=0\n\t${IP_ROUTER} addr add ${ROUTER_ADDR_WITH_MASK} dev ${ROUTER_INTF}\n\n\t# Turn on ndisc_notify on host interface so that\n\t# the host sends unsolicited NAs.\n\tHOST_CONF=net.ipv6.conf.${HOST_INTF}\n\t${IP_HOST_EXEC} sysctl -qw ${HOST_CONF}.ndisc_notify=1\n\t${IP_HOST_EXEC} sysctl -qw ${HOST_CONF}.disable_ipv6=0\n\t${IP_HOST} addr add ${HOST_ADDR_WITH_MASK} dev ${HOST_INTF}\n\n\tset +e\n}\n\nstart_tcpdump() {\n\tset -e\n\ttcpdump_stdout=`mktemp`\n\ttcpdump_stderr=`mktemp`\n\t${IP_ROUTER_EXEC} timeout 15s \\\n                tcpdump --immediate-mode -tpni ${ROUTER_INTF} -c 1 \\\n                \"icmp6 && icmp6[0] == 136 && src ${HOST_ADDR}\" \\\n                > ${tcpdump_stdout} 2> /dev/null\n\tset +e\n}\n\ncleanup_tcpdump()\n{\n\tset -e\n\t[[ ! -z  ${tcpdump_stdout} ]] && rm -f ${tcpdump_stdout}\n\t[[ ! -z  ${tcpdump_stderr} ]] && rm -f ${tcpdump_stderr}\n\ttcpdump_stdout=\n\ttcpdump_stderr=\n\tset +e\n}\n\ncleanup()\n{\n\tcleanup_tcpdump\n\tip netns del ${HOST_NS}\n\tip netns del ${ROUTER_NS}\n}\n\nlink_up() {\n\tset -e\n\t${IP_ROUTER} link set dev ${ROUTER_INTF} up\n\t${IP_HOST} link set dev ${HOST_INTF} up\n\tset +e\n}\n\nverify_ndisc() {\n\tlocal drop_unsolicited_na=$1\n\tlocal accept_untracked_na=$2\n\tlocal forwarding=$3\n\n\tneigh_show_output=$(${IP_ROUTER} neigh show \\\n                to ${HOST_ADDR} dev ${ROUTER_INTF} nud stale)\n\tif [ ${drop_unsolicited_na} -eq 0 ] && \\\n\t\t\t[ ${accept_untracked_na} -eq 1 ] && \\\n\t\t\t[ ${forwarding} -eq 1 ]; then\n\t\t# Neighbour entry expected to be present for 011 case\n\t\t[[ ${neigh_show_output} ]]\n\telse\n\t\t# Neighbour entry expected to be absent for all other cases\n\t\t[[ -z ${neigh_show_output} ]]\n\tfi\n}\n\ntest_unsolicited_na_common()\n{\n\t# Setup the test bed, but keep links down\n\tsetup $1 $2 $3\n\n\t# Bring the link up, wait for the NA,\n\t# and add a delay to ensure neighbour processing is done.\n\tlink_up\n\tstart_tcpdump\n\n\t# Verify the neighbour table\n\tverify_ndisc $1 $2 $3\n\n}\n\ntest_unsolicited_na_combination() {\n\ttest_unsolicited_na_common $1 $2 $3\n\ttest_msg=(\"test_unsolicited_na: \"\n\t\t\"drop_unsolicited_na=$1 \"\n\t\t\"accept_untracked_na=$2 \"\n\t\t\"forwarding=$3\")\n\tlog_test $? 0 \"${test_msg[*]}\"\n\tcleanup\n}\n\ntest_unsolicited_na_combinations() {\n\t# Args: drop_unsolicited_na accept_untracked_na forwarding\n\n\t# Expect entry\n\ttest_unsolicited_na_combination 0 1 1\n\n\t# Expect no entry\n\ttest_unsolicited_na_combination 0 0 0\n\ttest_unsolicited_na_combination 0 0 1\n\ttest_unsolicited_na_combination 0 1 0\n\ttest_unsolicited_na_combination 1 0 0\n\ttest_unsolicited_na_combination 1 0 1\n\ttest_unsolicited_na_combination 1 1 0\n\ttest_unsolicited_na_combination 1 1 1\n}\n\n###############################################################################\n# usage\n\nusage()\n{\n\tcat <<EOF\nusage: ${0##*/} OPTS\n        -p          Pause on fail\n        -P          Pause after each test before cleanup\nEOF\n}\n\n###############################################################################\n# main\n\nwhile getopts :pPh o\ndo\n\tcase $o in\n\t\tp) PAUSE_ON_FAIL=yes;;\n\t\tP) PAUSE=yes;;\n\t\th) usage; exit 0;;\n\t\t*) usage; exit 1;;\n\tesac\ndone\n\n# make sure we don't pause twice\n[ \"${PAUSE}\" = \"yes\" ] && PAUSE_ON_FAIL=no\n\nif [ \"$(id -u)\" -ne 0 ];then\n\techo \"SKIP: Need root privileges\"\n\texit $ksft_skip;\nfi\n\nif [ ! -x \"$(command -v ip)\" ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v tcpdump)\" ]; then\n\techo \"SKIP: Could not run test without tcpdump tool\"\n\texit $ksft_skip\nfi\n\n# start clean\ncleanup &> /dev/null\n\ntest_unsolicited_na_combinations\n\nprintf \"\\nTests passed: %3d\\n\" ${nsuccess}\nprintf \"Tests failed: %3d\\n\"   ${nfail}\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}