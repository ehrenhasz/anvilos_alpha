{
  "module_name": "ioam6.sh",
  "hash_id": "9a57daefaf934eccfab500afe9965d2ed4747a980fadecc1bca5a35b9cd9520c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/ioam6.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0+\n#\n# Author: Justin Iurman <justin.iurman@uliege.be>\n#\n# This script evaluates the IOAM insertion for IPv6 by checking the IOAM data\n# consistency directly inside packets on the receiver side. Tests are divided\n# into three categories: OUTPUT (evaluates the IOAM processing by the sender),\n# INPUT (evaluates the IOAM processing by a receiver) and GLOBAL (evaluates\n# wider use cases that do not fall into the other two categories). Both OUTPUT\n# and INPUT tests only use a two-node topology (alpha and beta), while GLOBAL\n# tests use the entire three-node topology (alpha, beta, gamma). Each test is\n# documented inside its own handler in the code below.\n#\n# An IOAM domain is configured from Alpha to Gamma but not on the reverse path.\n# When either Beta or Gamma is the destination (depending on the test category),\n# Alpha adds an IOAM option (Pre-allocated Trace) inside a Hop-by-hop.\n#\n#\n#            +-------------------+            +-------------------+\n#            |                   |            |                   |\n#            |    Alpha netns    |            |    Gamma netns    |\n#            |                   |            |                   |\n#            |  +-------------+  |            |  +-------------+  |\n#            |  |    veth0    |  |            |  |    veth0    |  |\n#            |  |  db01::2/64 |  |            |  |  db02::2/64 |  |\n#            |  +-------------+  |            |  +-------------+  |\n#            |         .         |            |         .         |\n#            +-------------------+            +-------------------+\n#                      .                                .\n#                      .                                .\n#                      .                                .\n#            +----------------------------------------------------+\n#            |         .                                .         |\n#            |  +-------------+                  +-------------+  |\n#            |  |    veth0    |                  |    veth1    |  |\n#            |  |  db01::1/64 | ................ |  db02::1/64 |  |\n#            |  +-------------+                  +-------------+  |\n#            |                                                    |\n#            |                      Beta netns                    |\n#            |                                                    |\n#            +----------------------------------------------------+\n#\n#\n#\n#        =============================================================\n#        |                Alpha - IOAM configuration                 |\n#        +===========================================================+\n#        | Node ID             | 1                                   |\n#        +-----------------------------------------------------------+\n#        | Node Wide ID        | 11111111                            |\n#        +-----------------------------------------------------------+\n#        | Ingress ID          | 0xffff (default value)              |\n#        +-----------------------------------------------------------+\n#        | Ingress Wide ID     | 0xffffffff (default value)          |\n#        +-----------------------------------------------------------+\n#        | Egress ID           | 101                                 |\n#        +-----------------------------------------------------------+\n#        | Egress Wide ID      | 101101                              |\n#        +-----------------------------------------------------------+\n#        | Namespace Data      | 0xdeadbee0                          |\n#        +-----------------------------------------------------------+\n#        | Namespace Wide Data | 0xcafec0caf00dc0de                  |\n#        +-----------------------------------------------------------+\n#        | Schema ID           | 777                                 |\n#        +-----------------------------------------------------------+\n#        | Schema Data         | something that will be 4n-aligned   |\n#        +-----------------------------------------------------------+\n#\n#\n#        =============================================================\n#        |                 Beta - IOAM configuration                 |\n#        +===========================================================+\n#        | Node ID             | 2                                   |\n#        +-----------------------------------------------------------+\n#        | Node Wide ID        | 22222222                            |\n#        +-----------------------------------------------------------+\n#        | Ingress ID          | 201                                 |\n#        +-----------------------------------------------------------+\n#        | Ingress Wide ID     | 201201                              |\n#        +-----------------------------------------------------------+\n#        | Egress ID           | 202                                 |\n#        +-----------------------------------------------------------+\n#        | Egress Wide ID      | 202202                              |\n#        +-----------------------------------------------------------+\n#        | Namespace Data      | 0xdeadbee1                          |\n#        +-----------------------------------------------------------+\n#        | Namespace Wide Data | 0xcafec0caf11dc0de                  |\n#        +-----------------------------------------------------------+\n#        | Schema ID           | 666                                 |\n#        +-----------------------------------------------------------+\n#        | Schema Data         | Hello there -Obi                    |\n#        +-----------------------------------------------------------+\n#\n#\n#        =============================================================\n#        |                Gamma - IOAM configuration                 |\n#        +===========================================================+\n#        | Node ID             | 3                                   |\n#        +-----------------------------------------------------------+\n#        | Node Wide ID        | 33333333                            |\n#        +-----------------------------------------------------------+\n#        | Ingress ID          | 301                                 |\n#        +-----------------------------------------------------------+\n#        | Ingress Wide ID     | 301301                              |\n#        +-----------------------------------------------------------+\n#        | Egress ID           | 0xffff (default value)              |\n#        +-----------------------------------------------------------+\n#        | Egress Wide ID      | 0xffffffff (default value)          |\n#        +-----------------------------------------------------------+\n#        | Namespace Data      | 0xdeadbee2                          |\n#        +-----------------------------------------------------------+\n#        | Namespace Wide Data | 0xcafec0caf22dc0de                  |\n#        +-----------------------------------------------------------+\n#        | Schema ID           | 0xffffff (= None)                   |\n#        +-----------------------------------------------------------+\n#        | Schema Data         |                                     |\n#        +-----------------------------------------------------------+\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\n################################################################################\n#                                                                              #\n# WARNING: Be careful if you modify the block below - it MUST be kept          #\n#          synchronized with configurations inside ioam6_parser.c and always   #\n#          reflect the same.                                                   #\n#                                                                              #\n################################################################################\n\nALPHA=(\n\t1\t\t\t\t\t# ID\n\t11111111\t\t\t\t# Wide ID\n\t0xffff\t\t\t\t\t# Ingress ID\n\t0xffffffff\t\t\t\t# Ingress Wide ID\n\t101\t\t\t\t\t# Egress ID\n\t101101\t\t\t\t\t# Egress Wide ID\n\t0xdeadbee0\t\t\t\t# Namespace Data\n\t0xcafec0caf00dc0de\t\t\t# Namespace Wide Data\n\t777\t\t\t\t\t# Schema ID (0xffffff = None)\n\t\"something that will be 4n-aligned\"\t# Schema Data\n)\n\nBETA=(\n\t2\n\t22222222\n\t201\n\t201201\n\t202\n\t202202\n\t0xdeadbee1\n\t0xcafec0caf11dc0de\n\t666\n\t\"Hello there -Obi\"\n)\n\nGAMMA=(\n\t3\n\t33333333\n\t301\n\t301301\n\t0xffff\n\t0xffffffff\n\t0xdeadbee2\n\t0xcafec0caf22dc0de\n\t0xffffff\n\t\"\"\n)\n\nTESTS_OUTPUT=\"\n\tout_undef_ns\n\tout_no_room\n\tout_bits\n\tout_full_supp_trace\n\"\n\nTESTS_INPUT=\"\n\tin_undef_ns\n\tin_no_room\n\tin_oflag\n\tin_bits\n\tin_full_supp_trace\n\"\n\nTESTS_GLOBAL=\"\n\tfwd_full_supp_trace\n\"\n\n\n################################################################################\n#                                                                              #\n#                                   LIBRARY                                    #\n#                                                                              #\n################################################################################\n\ncheck_kernel_compatibility()\n{\n  ip netns add ioam-tmp-node\n  ip link add name veth0 netns ioam-tmp-node type veth \\\n         peer name veth1 netns ioam-tmp-node\n\n  ip -netns ioam-tmp-node link set veth0 up\n  ip -netns ioam-tmp-node link set veth1 up\n\n  ip -netns ioam-tmp-node ioam namespace add 0\n  ns_ad=$?\n\n  ip -netns ioam-tmp-node ioam namespace show | grep -q \"namespace 0\"\n  ns_sh=$?\n\n  if [[ $ns_ad != 0 || $ns_sh != 0 ]]\n  then\n    echo \"SKIP: kernel version probably too old, missing ioam support\"\n    ip link del veth0 2>/dev/null || true\n    ip netns del ioam-tmp-node || true\n    exit $ksft_skip\n  fi\n\n  ip -netns ioam-tmp-node route add db02::/64 encap ioam6 mode inline \\\n         trace prealloc type 0x800000 ns 0 size 4 dev veth0\n  tr_ad=$?\n\n  ip -netns ioam-tmp-node -6 route | grep -q \"encap ioam6\"\n  tr_sh=$?\n\n  if [[ $tr_ad != 0 || $tr_sh != 0 ]]\n  then\n    echo \"SKIP: cannot attach an ioam trace to a route, did you compile\" \\\n         \"without CONFIG_IPV6_IOAM6_LWTUNNEL?\"\n    ip link del veth0 2>/dev/null || true\n    ip netns del ioam-tmp-node || true\n    exit $ksft_skip\n  fi\n\n  ip link del veth0 2>/dev/null || true\n  ip netns del ioam-tmp-node || true\n\n  lsmod | grep -q \"ip6_tunnel\"\n  ip6tnl_loaded=$?\n\n  if [ $ip6tnl_loaded = 0 ]\n  then\n    encap_tests=0\n  else\n    modprobe ip6_tunnel &>/dev/null\n    lsmod | grep -q \"ip6_tunnel\"\n    encap_tests=$?\n\n    if [ $encap_tests != 0 ]\n    then\n      ip a | grep -q \"ip6tnl0\"\n      encap_tests=$?\n\n      if [ $encap_tests != 0 ]\n      then\n        echo \"Note: ip6_tunnel not found neither as a module nor inside the\" \\\n             \"kernel, tests that require it (encap mode) will be omitted\"\n      fi\n    fi\n  fi\n}\n\ncleanup()\n{\n  ip link del ioam-veth-alpha 2>/dev/null || true\n  ip link del ioam-veth-gamma 2>/dev/null || true\n\n  ip netns del ioam-node-alpha || true\n  ip netns del ioam-node-beta || true\n  ip netns del ioam-node-gamma || true\n\n  if [ $ip6tnl_loaded != 0 ]\n  then\n    modprobe -r ip6_tunnel 2>/dev/null || true\n  fi\n}\n\nsetup()\n{\n  ip netns add ioam-node-alpha\n  ip netns add ioam-node-beta\n  ip netns add ioam-node-gamma\n\n  ip link add name ioam-veth-alpha netns ioam-node-alpha type veth \\\n         peer name ioam-veth-betaL netns ioam-node-beta\n  ip link add name ioam-veth-betaR netns ioam-node-beta type veth \\\n         peer name ioam-veth-gamma netns ioam-node-gamma\n\n  ip -netns ioam-node-alpha link set ioam-veth-alpha name veth0\n  ip -netns ioam-node-beta link set ioam-veth-betaL name veth0\n  ip -netns ioam-node-beta link set ioam-veth-betaR name veth1\n  ip -netns ioam-node-gamma link set ioam-veth-gamma name veth0\n\n  ip -netns ioam-node-alpha addr add db01::2/64 dev veth0\n  ip -netns ioam-node-alpha link set veth0 up\n  ip -netns ioam-node-alpha link set lo up\n  ip -netns ioam-node-alpha route add db02::/64 via db01::1 dev veth0\n  ip -netns ioam-node-alpha route del db01::/64\n  ip -netns ioam-node-alpha route add db01::/64 dev veth0\n\n  ip -netns ioam-node-beta addr add db01::1/64 dev veth0\n  ip -netns ioam-node-beta addr add db02::1/64 dev veth1\n  ip -netns ioam-node-beta link set veth0 up\n  ip -netns ioam-node-beta link set veth1 up\n  ip -netns ioam-node-beta link set lo up\n\n  ip -netns ioam-node-gamma addr add db02::2/64 dev veth0\n  ip -netns ioam-node-gamma link set veth0 up\n  ip -netns ioam-node-gamma link set lo up\n  ip -netns ioam-node-gamma route add db01::/64 via db02::1 dev veth0\n\n  # - IOAM config -\n  ip netns exec ioam-node-alpha sysctl -wq net.ipv6.ioam6_id=${ALPHA[0]}\n  ip netns exec ioam-node-alpha sysctl -wq net.ipv6.ioam6_id_wide=${ALPHA[1]}\n  ip netns exec ioam-node-alpha sysctl -wq net.ipv6.conf.veth0.ioam6_id=${ALPHA[4]}\n  ip netns exec ioam-node-alpha sysctl -wq net.ipv6.conf.veth0.ioam6_id_wide=${ALPHA[5]}\n  ip -netns ioam-node-alpha ioam namespace add 123 data ${ALPHA[6]} wide ${ALPHA[7]}\n  ip -netns ioam-node-alpha ioam schema add ${ALPHA[8]} \"${ALPHA[9]}\"\n  ip -netns ioam-node-alpha ioam namespace set 123 schema ${ALPHA[8]}\n\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.all.forwarding=1\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.ioam6_id=${BETA[0]}\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.ioam6_id_wide=${BETA[1]}\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth0.ioam6_enabled=1\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth0.ioam6_id=${BETA[2]}\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth0.ioam6_id_wide=${BETA[3]}\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth1.ioam6_id=${BETA[4]}\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth1.ioam6_id_wide=${BETA[5]}\n  ip -netns ioam-node-beta ioam namespace add 123 data ${BETA[6]} wide ${BETA[7]}\n  ip -netns ioam-node-beta ioam schema add ${BETA[8]} \"${BETA[9]}\"\n  ip -netns ioam-node-beta ioam namespace set 123 schema ${BETA[8]}\n\n  ip netns exec ioam-node-gamma sysctl -wq net.ipv6.ioam6_id=${GAMMA[0]}\n  ip netns exec ioam-node-gamma sysctl -wq net.ipv6.ioam6_id_wide=${GAMMA[1]}\n  ip netns exec ioam-node-gamma sysctl -wq net.ipv6.conf.veth0.ioam6_enabled=1\n  ip netns exec ioam-node-gamma sysctl -wq net.ipv6.conf.veth0.ioam6_id=${GAMMA[2]}\n  ip netns exec ioam-node-gamma sysctl -wq net.ipv6.conf.veth0.ioam6_id_wide=${GAMMA[3]}\n  ip -netns ioam-node-gamma ioam namespace add 123 data ${GAMMA[6]} wide ${GAMMA[7]}\n\n  sleep 1\n\n  ip netns exec ioam-node-alpha ping6 -c 5 -W 1 db02::2 &>/dev/null\n  if [ $? != 0 ]\n  then\n    echo \"Setup FAILED\"\n    cleanup &>/dev/null\n    exit 0\n  fi\n}\n\nlog_test_passed()\n{\n  local desc=$1\n  printf \"TEST: %-60s  [ OK ]\\n\" \"${desc}\"\n}\n\nlog_test_failed()\n{\n  local desc=$1\n  printf \"TEST: %-60s  [FAIL]\\n\" \"${desc}\"\n}\n\nlog_results()\n{\n  echo \"- Tests passed: ${npassed}\"\n  echo \"- Tests failed: ${nfailed}\"\n}\n\nrun_test()\n{\n  local name=$1\n  local desc=$2\n  local node_src=$3\n  local node_dst=$4\n  local ip6_src=$5\n  local ip6_dst=$6\n  local if_dst=$7\n  local trace_type=$8\n  local ioam_ns=$9\n\n  ip netns exec $node_dst ./ioam6_parser $if_dst $name $ip6_src $ip6_dst \\\n         $trace_type $ioam_ns &\n  local spid=$!\n  sleep 0.1\n\n  ip netns exec $node_src ping6 -t 64 -c 1 -W 1 $ip6_dst &>/dev/null\n  if [ $? != 0 ]\n  then\n    nfailed=$((nfailed+1))\n    log_test_failed \"${desc}\"\n    kill -2 $spid &>/dev/null\n  else\n    wait $spid\n    if [ $? = 0 ]\n    then\n      npassed=$((npassed+1))\n      log_test_passed \"${desc}\"\n    else\n      nfailed=$((nfailed+1))\n      log_test_failed \"${desc}\"\n    fi\n  fi\n}\n\nrun()\n{\n  echo\n  printf \"%0.s-\" {1..74}\n  echo\n  echo \"OUTPUT tests\"\n  printf \"%0.s-\" {1..74}\n  echo\n\n  # set OUTPUT settings\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth0.ioam6_enabled=0\n\n  for t in $TESTS_OUTPUT\n  do\n    $t \"inline\"\n    [ $encap_tests = 0 ] && $t \"encap\"\n  done\n\n  # clean OUTPUT settings\n  ip netns exec ioam-node-beta sysctl -wq net.ipv6.conf.veth0.ioam6_enabled=1\n  ip -netns ioam-node-alpha route change db01::/64 dev veth0\n\n\n  echo\n  printf \"%0.s-\" {1..74}\n  echo\n  echo \"INPUT tests\"\n  printf \"%0.s-\" {1..74}\n  echo\n\n  # set INPUT settings\n  ip -netns ioam-node-alpha ioam namespace del 123\n\n  for t in $TESTS_INPUT\n  do\n    $t \"inline\"\n    [ $encap_tests = 0 ] && $t \"encap\"\n  done\n\n  # clean INPUT settings\n  ip -netns ioam-node-alpha ioam namespace add 123 \\\n         data ${ALPHA[6]} wide ${ALPHA[7]}\n  ip -netns ioam-node-alpha ioam namespace set 123 schema ${ALPHA[8]}\n  ip -netns ioam-node-alpha route change db01::/64 dev veth0\n\n  echo\n  printf \"%0.s-\" {1..74}\n  echo\n  echo \"GLOBAL tests\"\n  printf \"%0.s-\" {1..74}\n  echo\n\n  for t in $TESTS_GLOBAL\n  do\n    $t \"inline\"\n    [ $encap_tests = 0 ] && $t \"encap\"\n  done\n\n  echo\n  log_results\n}\n\nbit2type=(\n  0x800000 0x400000 0x200000 0x100000 0x080000 0x040000 0x020000 0x010000\n  0x008000 0x004000 0x002000 0x001000 0x000800 0x000400 0x000200 0x000100\n  0x000080 0x000040 0x000020 0x000010 0x000008 0x000004 0x000002\n)\nbit2size=( 4 4 4 4 4 4 4 4 8 8 8 4 4 4 4 4 4 4 4 4 4 4 4 )\n\n\n################################################################################\n#                                                                              #\n#                              OUTPUT tests                                    #\n#                                                                              #\n#   Two nodes (sender/receiver), IOAM disabled on ingress for the receiver.    #\n################################################################################\n\nout_undef_ns()\n{\n  ##############################################################################\n  # Make sure that the encap node won't fill the trace if the chosen IOAM      #\n  # namespace is not configured locally.                                       #\n  ##############################################################################\n  local desc=\"Unknown IOAM namespace\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0x800000 ns 0 size 4 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0x800000 0\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n}\n\nout_no_room()\n{\n  ##############################################################################\n  # Make sure that the encap node won't fill the trace and will set the        #\n  # Overflow flag since there is no room enough for its data.                  #\n  ##############################################################################\n  local desc=\"Missing trace room\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0xc00000 ns 123 size 4 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0xc00000 123\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n}\n\nout_bits()\n{\n  ##############################################################################\n  # Make sure that, for each trace type bit, the encap node will either:       #\n  #  (i)  fill the trace with its data when it is a supported bit              #\n  #  (ii) not fill the trace with its data when it is an unsupported bit       #\n  ##############################################################################\n  local desc=\"Trace type with bit <n> only\"\n\n  local tmp=${bit2size[22]}\n  bit2size[22]=$(( $tmp + ${#ALPHA[9]} + ((4 - (${#ALPHA[9]} % 4)) % 4) ))\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  for i in {0..22}\n  do\n    ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n           trace prealloc type ${bit2type[$i]} ns 123 size ${bit2size[$i]} \\\n           dev veth0 &>/dev/null\n\n    local cmd_res=$?\n    local descr=\"${desc/<n>/$i}\"\n\n    if [[ $i -ge 12 && $i -le 21 ]]\n    then\n      if [ $cmd_res != 0 ]\n      then\n        npassed=$((npassed+1))\n        log_test_passed \"$descr\"\n      else\n        nfailed=$((nfailed+1))\n        log_test_failed \"$descr\"\n      fi\n    else\n\trun_test \"out_bit$i\" \"$descr ($1 mode)\" ioam-node-alpha \\\n           ioam-node-beta db01::2 db01::1 veth0 ${bit2type[$i]} 123\n    fi\n  done\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n\n  bit2size[22]=$tmp\n}\n\nout_full_supp_trace()\n{\n  ##############################################################################\n  # Make sure that the encap node will correctly fill a full trace. Be careful,#\n  # \"full trace\" here does NOT mean all bits (only supported ones).            #\n  ##############################################################################\n  local desc=\"Full supported trace\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0xfff002 ns 123 size 100 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0xfff002 123\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n}\n\n\n################################################################################\n#                                                                              #\n#                               INPUT tests                                    #\n#                                                                              #\n#     Two nodes (sender/receiver), the sender MUST NOT fill the trace upon     #\n#     insertion -> the IOAM namespace configured on the sender is removed      #\n#     and is used in the inserted trace to force the sender not to fill it.    #\n################################################################################\n\nin_undef_ns()\n{\n  ##############################################################################\n  # Make sure that the receiving node won't fill the trace if the related IOAM #\n  # namespace is not configured locally.                                       #\n  ##############################################################################\n  local desc=\"Unknown IOAM namespace\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0x800000 ns 0 size 4 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0x800000 0\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n}\n\nin_no_room()\n{\n  ##############################################################################\n  # Make sure that the receiving node won't fill the trace and will set the    #\n  # Overflow flag if there is no room enough for its data.                     #\n  ##############################################################################\n  local desc=\"Missing trace room\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0xc00000 ns 123 size 4 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0xc00000 123\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n}\n\nin_bits()\n{\n  ##############################################################################\n  # Make sure that, for each trace type bit, the receiving node will either:   #\n  #  (i)  fill the trace with its data when it is a supported bit              #\n  #  (ii) not fill the trace with its data when it is an unsupported bit       #\n  ##############################################################################\n  local desc=\"Trace type with bit <n> only\"\n\n  local tmp=${bit2size[22]}\n  bit2size[22]=$(( $tmp + ${#BETA[9]} + ((4 - (${#BETA[9]} % 4)) % 4) ))\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  for i in {0..11} {22..22}\n  do\n    ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n           trace prealloc type ${bit2type[$i]} ns 123 size ${bit2size[$i]} \\\n           dev veth0\n\n    run_test \"in_bit$i\" \"${desc/<n>/$i} ($1 mode)\" ioam-node-alpha \\\n           ioam-node-beta db01::2 db01::1 veth0 ${bit2type[$i]} 123\n  done\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n\n  bit2size[22]=$tmp\n}\n\nin_oflag()\n{\n  ##############################################################################\n  # Make sure that the receiving node won't fill the trace since the Overflow  #\n  # flag is set.                                                               #\n  ##############################################################################\n  local desc=\"Overflow flag is set\"\n\n  # Exception:\n  #   Here, we need the sender to set the Overflow flag. For that, we will add\n  #   back the IOAM namespace that was previously configured on the sender.\n  ip -netns ioam-node-alpha ioam namespace add 123\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0xc00000 ns 123 size 4 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0xc00000 123\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n\n  # And we clean the exception for this test to get things back to normal for\n  # other INPUT tests\n  ip -netns ioam-node-alpha ioam namespace del 123\n}\n\nin_full_supp_trace()\n{\n  ##############################################################################\n  # Make sure that the receiving node will correctly fill a full trace. Be     #\n  # careful, \"full trace\" here does NOT mean all bits (only supported ones).   #\n  ##############################################################################\n  local desc=\"Full supported trace\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db01::1\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db01::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0xfff002 ns 123 size 80 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-beta \\\n         db01::2 db01::1 veth0 0xfff002 123\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-beta link set ip6tnl0 down\n}\n\n\n################################################################################\n#                                                                              #\n#                              GLOBAL tests                                    #\n#                                                                              #\n#   Three nodes (sender/router/receiver), IOAM fully enabled on every node.    #\n################################################################################\n\nfwd_full_supp_trace()\n{\n  ##############################################################################\n  # Make sure that all three nodes correctly filled the full supported trace   #\n  # by checking that the trace data is consistent with the predefined config.  #\n  ##############################################################################\n  local desc=\"Forward - Full supported trace\"\n\n  [ \"$1\" = \"encap\" ] && mode=\"$1 tundst db02::2\" || mode=\"$1\"\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-gamma link set ip6tnl0 up\n\n  ip -netns ioam-node-alpha route change db02::/64 encap ioam6 mode $mode \\\n         trace prealloc type 0xfff002 ns 123 size 244 via db01::1 dev veth0\n\n  run_test ${FUNCNAME[0]} \"${desc} ($1 mode)\" ioam-node-alpha ioam-node-gamma \\\n         db01::2 db02::2 veth0 0xfff002 123\n\n  [ \"$1\" = \"encap\" ] && ip -netns ioam-node-gamma link set ip6tnl0 down\n}\n\n\n################################################################################\n#                                                                              #\n#                                     MAIN                                     #\n#                                                                              #\n################################################################################\n\nnpassed=0\nnfailed=0\n\nif [ \"$(id -u)\" -ne 0 ]\nthen\n  echo \"SKIP: Need root privileges\"\n  exit $ksft_skip\nfi\n\nif [ ! -x \"$(command -v ip)\" ]\nthen\n  echo \"SKIP: Could not run test without ip tool\"\n  exit $ksft_skip\nfi\n\nip ioam &>/dev/null\nif [ $? = 1 ]\nthen\n  echo \"SKIP: iproute2 too old, missing ioam command\"\n  exit $ksft_skip\nfi\n\ncheck_kernel_compatibility\n\ncleanup &>/dev/null\nsetup\nrun\ncleanup &>/dev/null\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}