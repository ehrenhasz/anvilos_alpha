{
  "module_name": "stress_reuseport_listen.c",
  "hash_id": "6c5bed5d062892cbcc21b668cdd8d0430aab9d02d999b2fff324816ffc2af0c0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/net/stress_reuseport_listen.c",
  "human_readable_source": "\n\n \n\n \n\n#include <unistd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <error.h>\n#include <errno.h>\n#include <time.h>\n#include <arpa/inet.h>\n\n#define IP6_LADDR_START \"2401:dead::1\"\n#define IP6_LPORT 443\n#define NSEC_PER_SEC 1000000000L\n#define NSEC_PER_USEC 1000L\n\nstatic unsigned int nr_socks_per_vip;\nstatic unsigned int nr_vips;\n\nstatic int *bind_reuseport_sock6(void)\n{\n\tint *lfds, *cur_fd, err, optvalue = 1;\n\tstruct sockaddr_in6 sa6 = {};\n\tunsigned int i, j;\n\n\tsa6.sin6_family = AF_INET6;\n\tsa6.sin6_port = htons(IP6_LPORT);\n\terr = inet_pton(AF_INET6, IP6_LADDR_START, &sa6.sin6_addr);\n\tif (err != 1)\n\t\terror(1, err, \"inet_pton(%s)\", IP6_LADDR_START);\n\n\tlfds = malloc(nr_vips * nr_socks_per_vip * sizeof(lfds[0]));\n\tif (!lfds)\n\t\terror(1, errno, \"cannot alloc array of lfds\");\n\n\tcur_fd = lfds;\n\tfor (i = 0; i < nr_vips; i++) {\n\t\tfor (j = 0; j < nr_socks_per_vip; j++) {\n\t\t\t*cur_fd = socket(AF_INET6, SOCK_STREAM, 0);\n\t\t\tif (*cur_fd == -1)\n\t\t\t\terror(1, errno,\n\t\t\t\t      \"lfds[%u,%u] = socket(AF_INET6)\", i, j);\n\n\t\t\terr = setsockopt(*cur_fd, SOL_SOCKET, SO_REUSEPORT,\n\t\t\t\t\t &optvalue, sizeof(optvalue));\n\t\t\tif (err)\n\t\t\t\terror(1, errno,\n\t\t\t\t      \"setsockopt(lfds[%u,%u], SO_REUSEPORT)\",\n\t\t\t\t      i, j);\n\n\t\t\terr = bind(*cur_fd, (struct sockaddr *)&sa6,\n\t\t\t\t   sizeof(sa6));\n\t\t\tif (err)\n\t\t\t\terror(1, errno, \"bind(lfds[%u,%u])\", i, j);\n\t\t\tcur_fd++;\n\t\t}\n\t\tsa6.sin6_addr.s6_addr32[3]++;\n\t}\n\n\treturn lfds;\n}\n\nint main(int argc, const char *argv[])\n{\n\tstruct timespec start_ts, end_ts;\n\tunsigned long start_ns, end_ns;\n\tunsigned int nr_lsocks;\n\tint *lfds, i, err;\n\n\tif (argc != 3 || atoi(argv[1]) <= 0 || atoi(argv[2]) <= 0)\n\t\terror(1, 0, \"Usage: %s <nr_vips> <nr_socks_per_vip>\\n\",\n\t\t      argv[0]);\n\n\tnr_vips = atoi(argv[1]);\n\tnr_socks_per_vip = atoi(argv[2]);\n\tnr_lsocks = nr_vips * nr_socks_per_vip;\n\tlfds = bind_reuseport_sock6();\n\n\tclock_gettime(CLOCK_MONOTONIC, &start_ts);\n\tfor (i = 0; i < nr_lsocks; i++) {\n\t\terr = listen(lfds[i], 0);\n\t\tif (err)\n\t\t\terror(1, errno, \"listen(lfds[%d])\", i);\n\t}\n\tclock_gettime(CLOCK_MONOTONIC, &end_ts);\n\n\tstart_ns = start_ts.tv_sec * NSEC_PER_SEC + start_ts.tv_nsec;\n\tend_ns = end_ts.tv_sec * NSEC_PER_SEC + end_ts.tv_nsec;\n\n\tprintf(\"listen %d socks took %lu.%lu\\n\", nr_lsocks,\n\t       (end_ns - start_ns) / NSEC_PER_SEC,\n\t       (end_ns - start_ns) / NSEC_PER_USEC);\n\n\tfor (i = 0; i < nr_lsocks; i++)\n\t\tclose(lfds[i]);\n\n\tfree(lfds);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}