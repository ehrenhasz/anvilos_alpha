{
  "module_name": "nosymfollow-test.c",
  "hash_id": "af38fbd840c208ddb155eb17686a60237468222089254eec3775b6def187eb36",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mount/nosymfollow-test.c",
  "human_readable_source": "\n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <limits.h>\n#include <sched.h>\n#include <stdarg.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mount.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/vfs.h>\n#include <unistd.h>\n\n#ifndef MS_NOSYMFOLLOW\n# define MS_NOSYMFOLLOW 256      \n#endif\n\n#ifndef ST_NOSYMFOLLOW\n# define ST_NOSYMFOLLOW 0x2000   \n#endif\n\n#define DATA \"/tmp/data\"\n#define LINK \"/tmp/symlink\"\n#define TMP  \"/tmp\"\n\nstatic void die(char *fmt, ...)\n{\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tvfprintf(stderr, fmt, ap);\n\tva_end(ap);\n\texit(EXIT_FAILURE);\n}\n\nstatic void vmaybe_write_file(bool enoent_ok, char *filename, char *fmt,\n\t\tva_list ap)\n{\n\tssize_t written;\n\tchar buf[4096];\n\tint buf_len;\n\tint fd;\n\n\tbuf_len = vsnprintf(buf, sizeof(buf), fmt, ap);\n\tif (buf_len < 0)\n\t\tdie(\"vsnprintf failed: %s\\n\", strerror(errno));\n\n\tif (buf_len >= sizeof(buf))\n\t\tdie(\"vsnprintf output truncated\\n\");\n\n\tfd = open(filename, O_WRONLY);\n\tif (fd < 0) {\n\t\tif ((errno == ENOENT) && enoent_ok)\n\t\t\treturn;\n\t\tdie(\"open of %s failed: %s\\n\", filename, strerror(errno));\n\t}\n\n\twritten = write(fd, buf, buf_len);\n\tif (written != buf_len) {\n\t\tif (written >= 0) {\n\t\t\tdie(\"short write to %s\\n\", filename);\n\t\t} else {\n\t\t\tdie(\"write to %s failed: %s\\n\",\n\t\t\t\tfilename, strerror(errno));\n\t\t}\n\t}\n\n\tif (close(fd) != 0)\n\t\tdie(\"close of %s failed: %s\\n\", filename, strerror(errno));\n}\n\nstatic void maybe_write_file(char *filename, char *fmt, ...)\n{\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tvmaybe_write_file(true, filename, fmt, ap);\n\tva_end(ap);\n}\n\nstatic void write_file(char *filename, char *fmt, ...)\n{\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tvmaybe_write_file(false, filename, fmt, ap);\n\tva_end(ap);\n}\n\nstatic void create_and_enter_ns(void)\n{\n\tuid_t uid = getuid();\n\tgid_t gid = getgid();\n\n\tif (unshare(CLONE_NEWUSER) != 0)\n\t\tdie(\"unshare(CLONE_NEWUSER) failed: %s\\n\", strerror(errno));\n\n\tmaybe_write_file(\"/proc/self/setgroups\", \"deny\");\n\twrite_file(\"/proc/self/uid_map\", \"0 %d 1\", uid);\n\twrite_file(\"/proc/self/gid_map\", \"0 %d 1\", gid);\n\n\tif (setgid(0) != 0)\n\t\tdie(\"setgid(0) failed %s\\n\", strerror(errno));\n\tif (setuid(0) != 0)\n\t\tdie(\"setuid(0) failed %s\\n\", strerror(errno));\n\n\tif (unshare(CLONE_NEWNS) != 0)\n\t\tdie(\"unshare(CLONE_NEWNS) failed: %s\\n\", strerror(errno));\n}\n\nstatic void setup_symlink(void)\n{\n\tint data, err;\n\n\tdata = creat(DATA, O_RDWR);\n\tif (data < 0)\n\t\tdie(\"creat failed: %s\\n\", strerror(errno));\n\n\terr = symlink(DATA, LINK);\n\tif (err < 0)\n\t\tdie(\"symlink failed: %s\\n\", strerror(errno));\n\n\tif (close(data) != 0)\n\t\tdie(\"close of %s failed: %s\\n\", DATA, strerror(errno));\n}\n\nstatic void test_link_traversal(bool nosymfollow)\n{\n\tint link;\n\n\tlink = open(LINK, 0, O_RDWR);\n\tif (nosymfollow) {\n\t\tif ((link != -1 || errno != ELOOP)) {\n\t\t\tdie(\"link traversal unexpected result: %d, %s\\n\",\n\t\t\t\t\tlink, strerror(errno));\n\t\t}\n\t} else {\n\t\tif (link < 0)\n\t\t\tdie(\"link traversal failed: %s\\n\", strerror(errno));\n\n\t\tif (close(link) != 0)\n\t\t\tdie(\"close of link failed: %s\\n\", strerror(errno));\n\t}\n}\n\nstatic void test_readlink(void)\n{\n\tchar buf[4096];\n\tssize_t ret;\n\n\tbzero(buf, sizeof(buf));\n\n\tret = readlink(LINK, buf, sizeof(buf));\n\tif (ret < 0)\n\t\tdie(\"readlink failed: %s\\n\", strerror(errno));\n\tif (strcmp(buf, DATA) != 0)\n\t\tdie(\"readlink strcmp failed: '%s' '%s'\\n\", buf, DATA);\n}\n\nstatic void test_realpath(void)\n{\n\tchar *path = realpath(LINK, NULL);\n\n\tif (!path)\n\t\tdie(\"realpath failed: %s\\n\", strerror(errno));\n\tif (strcmp(path, DATA) != 0)\n\t\tdie(\"realpath strcmp failed\\n\");\n\n\tfree(path);\n}\n\nstatic void test_statfs(bool nosymfollow)\n{\n\tstruct statfs buf;\n\tint ret;\n\n\tret = statfs(TMP, &buf);\n\tif (ret)\n\t\tdie(\"statfs failed: %s\\n\", strerror(errno));\n\n\tif (nosymfollow) {\n\t\tif ((buf.f_flags & ST_NOSYMFOLLOW) == 0)\n\t\t\tdie(\"ST_NOSYMFOLLOW not set on %s\\n\", TMP);\n\t} else {\n\t\tif ((buf.f_flags & ST_NOSYMFOLLOW) != 0)\n\t\t\tdie(\"ST_NOSYMFOLLOW set on %s\\n\", TMP);\n\t}\n}\n\nstatic void run_tests(bool nosymfollow)\n{\n\ttest_link_traversal(nosymfollow);\n\ttest_readlink();\n\ttest_realpath();\n\ttest_statfs(nosymfollow);\n}\n\nint main(int argc, char **argv)\n{\n\tcreate_and_enter_ns();\n\n\tif (mount(\"testing\", TMP, \"ramfs\", 0, NULL) != 0)\n\t\tdie(\"mount failed: %s\\n\", strerror(errno));\n\n\tsetup_symlink();\n\trun_tests(false);\n\n\tif (mount(\"testing\", TMP, \"ramfs\", MS_REMOUNT|MS_NOSYMFOLLOW, NULL) != 0)\n\t\tdie(\"remount failed: %s\\n\", strerror(errno));\n\n\trun_tests(true);\n\n\treturn EXIT_SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}