{
  "module_name": "video_device_test.c",
  "hash_id": "4b274d982c863fbb728b3aa6c4177868ac5edd7004062ebfb29836162a183aaf",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/media_tests/video_device_test.c",
  "human_readable_source": "\n\n \n\n \n\n#include <stdio.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <string.h>\n#include <fcntl.h>\n#include <sys/ioctl.h>\n#include <sys/stat.h>\n#include <time.h>\n#include <linux/videodev2.h>\n\n#define PRIORITY_MAX 4\n\nint priority_test(int fd)\n{\n\t \n\n\tenum v4l2_priority old_priority, new_priority, priority_to_compare;\n\tint ret;\n\tint result = 0;\n\n\tret = ioctl(fd, VIDIOC_G_PRIORITY, &old_priority);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to get priority: %s\\n\", strerror(errno));\n\t\treturn -1;\n\t}\n\tnew_priority = (old_priority + 1) % PRIORITY_MAX;\n\tret = ioctl(fd, VIDIOC_S_PRIORITY, &new_priority);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to set priority: %s\\n\", strerror(errno));\n\t\treturn -1;\n\t}\n\tret = ioctl(fd, VIDIOC_G_PRIORITY, &priority_to_compare);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to get new priority: %s\\n\", strerror(errno));\n\t\tresult = -1;\n\t\tgoto cleanup;\n\t}\n\tif (priority_to_compare != new_priority) {\n\t\tprintf(\"Priority wasn't set - test failed\\n\");\n\t\tresult = -1;\n\t}\n\ncleanup:\n\tret = ioctl(fd, VIDIOC_S_PRIORITY, &old_priority);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to restore priority: %s\\n\", strerror(errno));\n\t\treturn -1;\n\t}\n\treturn result;\n}\n\nint loop_test(int fd)\n{\n\tint count;\n\tstruct v4l2_tuner vtuner;\n\tstruct v4l2_capability vcap;\n\tint ret;\n\n\t \n\tsrand((unsigned int) time(NULL));\n\tcount = rand();\n\n\tprintf(\"\\nNote:\\n\"\n\t       \"While test is running, remove the device or unbind\\n\"\n\t       \"driver and ensure there are no use after free errors\\n\"\n\t       \"and other Oops in the dmesg. When possible, enable KaSan\\n\"\n\t       \"kernel config option for use-after-free error detection.\\n\\n\");\n\n\twhile (count > 0) {\n\t\tret = ioctl(fd, VIDIOC_QUERYCAP, &vcap);\n\t\tif (ret < 0)\n\t\t\tprintf(\"VIDIOC_QUERYCAP errno %s\\n\", strerror(errno));\n\t\telse\n\t\t\tprintf(\"Video device driver %s\\n\", vcap.driver);\n\n\t\tret = ioctl(fd, VIDIOC_G_TUNER, &vtuner);\n\t\tif (ret < 0)\n\t\t\tprintf(\"VIDIOC_G_TUNER, errno %s\\n\", strerror(errno));\n\t\telse\n\t\t\tprintf(\"type %d rangelow %d rangehigh %d\\n\",\n\t\t\t\tvtuner.type, vtuner.rangelow, vtuner.rangehigh);\n\t\tsleep(10);\n\t\tcount--;\n\t}\n\treturn 0;\n}\n\nint main(int argc, char **argv)\n{\n\tint opt;\n\tchar video_dev[256];\n\tint fd;\n\tint test_result;\n\n\tif (argc < 2) {\n\t\tprintf(\"Usage: %s [-d </dev/videoX>]\\n\", argv[0]);\n\t\texit(-1);\n\t}\n\n\t \n\twhile ((opt = getopt(argc, argv, \"d:\")) != -1) {\n\t\tswitch (opt) {\n\t\tcase 'd':\n\t\t\tstrncpy(video_dev, optarg, sizeof(video_dev) - 1);\n\t\t\tvideo_dev[sizeof(video_dev)-1] = '\\0';\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tprintf(\"Usage: %s [-d </dev/videoX>]\\n\", argv[0]);\n\t\t\texit(-1);\n\t\t}\n\t}\n\n\t \n\tfd = open(video_dev, O_RDWR);\n\tif (fd == -1) {\n\t\tprintf(\"Video Device open errno %s\\n\", strerror(errno));\n\t\texit(-1);\n\t}\n\n\ttest_result = priority_test(fd);\n\tif (!test_result)\n\t\tprintf(\"Priority test - PASSED\\n\");\n\telse\n\t\tprintf(\"Priority test - FAILED\\n\");\n\n\tloop_test(fd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}