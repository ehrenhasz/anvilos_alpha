{
  "module_name": "hugetlb-madvise.c",
  "hash_id": "d3e2f33ca1f1df98c5bd6af2062d58b405b238cee3e00685f2f2bf60be07cbfb",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/hugetlb-madvise.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/mman.h>\n#include <fcntl.h>\n#include \"vm_util.h\"\n\n#define MIN_FREE_PAGES\t20\n#define NR_HUGE_PAGES\t10\t \n\n#define validate_free_pages(exp_free)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tint fhp = get_free_hugepages();\t\t\t\t\\\n\t\tif (fhp != (exp_free)) {\t\t\t\t\\\n\t\t\tprintf(\"Unexpected number of free huge \"\t\\\n\t\t\t\t\"pages line %d\\n\", __LINE__);\t\t\\\n\t\t\texit(1);\t\t\t\t\t\\\n\t\t}\t\t\t\t\t\t\t\\\n\t} while (0)\n\nunsigned long huge_page_size;\nunsigned long base_page_size;\n\nunsigned long get_free_hugepages(void)\n{\n\tunsigned long fhp = 0;\n\tchar *line = NULL;\n\tsize_t linelen = 0;\n\tFILE *f = fopen(\"/proc/meminfo\", \"r\");\n\n\tif (!f)\n\t\treturn fhp;\n\twhile (getline(&line, &linelen, f) > 0) {\n\t\tif (sscanf(line, \"HugePages_Free:      %lu\", &fhp) == 1)\n\t\t\tbreak;\n\t}\n\n\tfree(line);\n\tfclose(f);\n\treturn fhp;\n}\n\nvoid write_fault_pages(void *addr, unsigned long nr_pages)\n{\n\tunsigned long i;\n\n\tfor (i = 0; i < nr_pages; i++)\n\t\t*((unsigned long *)(addr + (i * huge_page_size))) = i;\n}\n\nvoid read_fault_pages(void *addr, unsigned long nr_pages)\n{\n\tvolatile unsigned long dummy = 0;\n\tunsigned long i;\n\n\tfor (i = 0; i < nr_pages; i++) {\n\t\tdummy += *((unsigned long *)(addr + (i * huge_page_size)));\n\n\t\t \n\t\tasm volatile(\"\" : \"+r\" (dummy));\n\t}\n}\n\nint main(int argc, char **argv)\n{\n\tunsigned long free_hugepages;\n\tvoid *addr, *addr2;\n\tint fd;\n\tint ret;\n\n\thuge_page_size = default_huge_page_size();\n\tif (!huge_page_size) {\n\t\tprintf(\"Unable to determine huge page size, exiting!\\n\");\n\t\texit(1);\n\t}\n\tbase_page_size = sysconf(_SC_PAGE_SIZE);\n\tif (!huge_page_size) {\n\t\tprintf(\"Unable to determine base page size, exiting!\\n\");\n\t\texit(1);\n\t}\n\n\tfree_hugepages = get_free_hugepages();\n\tif (free_hugepages < MIN_FREE_PAGES) {\n\t\tprintf(\"Not enough free huge pages to test, exiting!\\n\");\n\t\texit(1);\n\t}\n\n\tfd = memfd_create(argv[0], MFD_HUGETLB);\n\tif (fd < 0) {\n\t\tperror(\"memfd_create() failed\");\n\t\texit(1);\n\t}\n\n\t \n\taddr = mmap(NULL, (NR_HUGE_PAGES + 2) * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB,\n\t\t\t-1, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\tif (munmap(addr, huge_page_size) ||\n\t\t\tmunmap(addr + (NR_HUGE_PAGES + 1) * huge_page_size,\n\t\t\t\thuge_page_size)) {\n\t\tperror(\"munmap\");\n\t\texit(1);\n\t}\n\taddr = addr + huge_page_size;\n\n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\tret = madvise(addr - base_page_size, NR_HUGE_PAGES * huge_page_size,\n\t\tMADV_DONTNEED);\n\tif (!ret) {\n\t\tprintf(\"Unexpected success of madvise call with invalid addr line %d\\n\",\n\t\t\t\t__LINE__);\n\t\t\texit(1);\n\t}\n\n\t \n\tret = madvise(addr, (NR_HUGE_PAGES * huge_page_size) + base_page_size,\n\t\tMADV_DONTNEED);\n\tif (!ret) {\n\t\tprintf(\"Unexpected success of madvise call with invalid length line %d\\n\",\n\t\t\t\t__LINE__);\n\t\t\texit(1);\n\t}\n\n\t(void)munmap(addr, NR_HUGE_PAGES * huge_page_size);\n\n\t \n\taddr = mmap(NULL, NR_HUGE_PAGES * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB,\n\t\t\t-1, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\tret = madvise(addr + base_page_size,\n\t\t\tNR_HUGE_PAGES * huge_page_size - base_page_size,\n\t\t\tMADV_DONTNEED);\n\tif (!ret) {\n\t\tprintf(\"Unexpected success of madvise call with unaligned start address %d\\n\",\n\t\t\t\t__LINE__);\n\t\t\texit(1);\n\t}\n\n\t \n\tif (madvise(addr,\n\t\t\t((NR_HUGE_PAGES - 1) * huge_page_size) + base_page_size,\n\t\t\tMADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\n\t \n\tvalidate_free_pages(free_hugepages - 1);\n\n\t(void)munmap(addr, NR_HUGE_PAGES * huge_page_size);\n\tvalidate_free_pages(free_hugepages);\n\n\t \n\taddr = mmap(NULL, NR_HUGE_PAGES * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB,\n\t\t\t-1, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\n\t \n\tvalidate_free_pages(free_hugepages);\n\n\t(void)munmap(addr, NR_HUGE_PAGES * huge_page_size);\n\n\t \n\tif (fallocate(fd, 0, 0, NR_HUGE_PAGES * huge_page_size)) {\n\t\tperror(\"fallocate\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\taddr = mmap(NULL, NR_HUGE_PAGES * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_PRIVATE, fd, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\n\t \n\tread_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - (2 * NR_HUGE_PAGES));\n\n\t \n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - (2 * NR_HUGE_PAGES));\n\n\t \n\tif (fallocate(fd, FALLOC_FL_PUNCH_HOLE | FALLOC_FL_KEEP_SIZE,\n\t\t\t\t\t0, NR_HUGE_PAGES * huge_page_size)) {\n\t\tperror(\"fallocate\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages);\n\n\t(void)munmap(addr, NR_HUGE_PAGES * huge_page_size);\n\n\t \n\tif (fallocate(fd, 0, 0, NR_HUGE_PAGES * huge_page_size)) {\n\t\tperror(\"fallocate\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\taddr = mmap(NULL, NR_HUGE_PAGES * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_SHARED, fd, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\n\t \n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_REMOVE)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages);\n\t(void)munmap(addr, NR_HUGE_PAGES * huge_page_size);\n\n\t \n\tif (fallocate(fd, 0, 0, NR_HUGE_PAGES * huge_page_size)) {\n\t\tperror(\"fallocate\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\taddr = mmap(NULL, NR_HUGE_PAGES * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_SHARED, fd, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\n\t \n\twrite_fault_pages(addr, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\taddr2 = mmap(NULL, NR_HUGE_PAGES * huge_page_size,\n\t\t\tPROT_READ | PROT_WRITE,\n\t\t\tMAP_PRIVATE, fd, 0);\n\tif (addr2 == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\n\t \n\tread_fault_pages(addr2, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\twrite_fault_pages(addr2, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - (2 * NR_HUGE_PAGES));\n\n\t \n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - (2 * NR_HUGE_PAGES));\n\n\t \n\tif (madvise(addr2, NR_HUGE_PAGES * huge_page_size, MADV_DONTNEED)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages - NR_HUGE_PAGES);\n\n\t \n\twrite_fault_pages(addr2, NR_HUGE_PAGES);\n\tvalidate_free_pages(free_hugepages - (2 * NR_HUGE_PAGES));\n\n\t \n\tif (madvise(addr, NR_HUGE_PAGES * huge_page_size, MADV_REMOVE)) {\n\t\tperror(\"madvise\");\n\t\texit(1);\n\t}\n\tvalidate_free_pages(free_hugepages);\n\n\t(void)munmap(addr, NR_HUGE_PAGES * huge_page_size);\n\t(void)munmap(addr2, NR_HUGE_PAGES * huge_page_size);\n\n\tclose(fd);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}