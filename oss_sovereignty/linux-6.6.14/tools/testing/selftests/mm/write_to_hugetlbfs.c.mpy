{
  "module_name": "write_to_hugetlbfs.c",
  "hash_id": "564332444d1e711c9718ca8918411fcbd8f0d5016973c2404105e7a41f390866",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/write_to_hugetlbfs.c",
  "human_readable_source": "\n \n\n#include <err.h>\n#include <errno.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/shm.h>\n#include <sys/stat.h>\n#include <sys/mman.h>\n\n \nenum method {\n\tHUGETLBFS,\n\tMMAP_MAP_HUGETLB,\n\tSHM,\n\tMAX_METHOD\n};\n\n\n \nstatic const char *self;\nstatic char *shmaddr;\nstatic int shmid;\n\n \nstatic void exit_usage(void)\n{\n\tprintf(\"Usage: %s -p <path to hugetlbfs file> -s <size to map> \"\n\t       \"[-m <0=hugetlbfs | 1=mmap(MAP_HUGETLB)>] [-l] [-r] \"\n\t       \"[-o] [-w] [-n]\\n\",\n\t       self);\n\texit(EXIT_FAILURE);\n}\n\nvoid sig_handler(int signo)\n{\n\tprintf(\"Received %d.\\n\", signo);\n\tif (signo == SIGINT) {\n\t\tprintf(\"Deleting the memory\\n\");\n\t\tif (shmdt((const void *)shmaddr) != 0) {\n\t\t\tperror(\"Detach failure\");\n\t\t\tshmctl(shmid, IPC_RMID, NULL);\n\t\t\texit(4);\n\t\t}\n\n\t\tshmctl(shmid, IPC_RMID, NULL);\n\t\tprintf(\"Done deleting the memory\\n\");\n\t}\n\texit(2);\n}\n\nint main(int argc, char **argv)\n{\n\tint fd = 0;\n\tint key = 0;\n\tint *ptr = NULL;\n\tint c = 0;\n\tint size = 0;\n\tchar path[256] = \"\";\n\tenum method method = MAX_METHOD;\n\tint want_sleep = 0, private = 0;\n\tint populate = 0;\n\tint write = 0;\n\tint reserve = 1;\n\n\tif (signal(SIGINT, sig_handler) == SIG_ERR)\n\t\terr(1, \"\\ncan't catch SIGINT\\n\");\n\n\t \n\tsetvbuf(stdout, NULL, _IONBF, 0);\n\tself = argv[0];\n\n\twhile ((c = getopt(argc, argv, \"s:p:m:owlrn\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 's':\n\t\t\tsize = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\tstrncpy(path, optarg, sizeof(path));\n\t\t\tbreak;\n\t\tcase 'm':\n\t\t\tif (atoi(optarg) >= MAX_METHOD) {\n\t\t\t\terrno = EINVAL;\n\t\t\t\tperror(\"Invalid -m.\");\n\t\t\t\texit_usage();\n\t\t\t}\n\t\t\tmethod = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'o':\n\t\t\tpopulate = 1;\n\t\t\tbreak;\n\t\tcase 'w':\n\t\t\twrite = 1;\n\t\t\tbreak;\n\t\tcase 'l':\n\t\t\twant_sleep = 1;\n\t\t\tbreak;\n\t\tcase 'r':\n\t\t    private\n\t\t\t= 1;\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\treserve = 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\terrno = EINVAL;\n\t\t\tperror(\"Invalid arg\");\n\t\t\texit_usage();\n\t\t}\n\t}\n\n\tif (strncmp(path, \"\", sizeof(path)) != 0) {\n\t\tprintf(\"Writing to this path: %s\\n\", path);\n\t} else {\n\t\terrno = EINVAL;\n\t\tperror(\"path not found\");\n\t\texit_usage();\n\t}\n\n\tif (size != 0) {\n\t\tprintf(\"Writing this size: %d\\n\", size);\n\t} else {\n\t\terrno = EINVAL;\n\t\tperror(\"size not found\");\n\t\texit_usage();\n\t}\n\n\tif (!populate)\n\t\tprintf(\"Not populating.\\n\");\n\telse\n\t\tprintf(\"Populating.\\n\");\n\n\tif (!write)\n\t\tprintf(\"Not writing to memory.\\n\");\n\n\tif (method == MAX_METHOD) {\n\t\terrno = EINVAL;\n\t\tperror(\"-m Invalid\");\n\t\texit_usage();\n\t} else\n\t\tprintf(\"Using method=%d\\n\", method);\n\n\tif (!private)\n\t\tprintf(\"Shared mapping.\\n\");\n\telse\n\t\tprintf(\"Private mapping.\\n\");\n\n\tif (!reserve)\n\t\tprintf(\"NO_RESERVE mapping.\\n\");\n\telse\n\t\tprintf(\"RESERVE mapping.\\n\");\n\n\tswitch (method) {\n\tcase HUGETLBFS:\n\t\tprintf(\"Allocating using HUGETLBFS.\\n\");\n\t\tfd = open(path, O_CREAT | O_RDWR, 0777);\n\t\tif (fd == -1)\n\t\t\terr(1, \"Failed to open file.\");\n\n\t\tptr = mmap(NULL, size, PROT_READ | PROT_WRITE,\n\t\t\t   (private ? MAP_PRIVATE : MAP_SHARED) |\n\t\t\t\t   (populate ? MAP_POPULATE : 0) |\n\t\t\t\t   (reserve ? 0 : MAP_NORESERVE),\n\t\t\t   fd, 0);\n\n\t\tif (ptr == MAP_FAILED) {\n\t\t\tclose(fd);\n\t\t\terr(1, \"Error mapping the file\");\n\t\t}\n\t\tbreak;\n\tcase MMAP_MAP_HUGETLB:\n\t\tprintf(\"Allocating using MAP_HUGETLB.\\n\");\n\t\tptr = mmap(NULL, size, PROT_READ | PROT_WRITE,\n\t\t\t   (private ? (MAP_PRIVATE | MAP_ANONYMOUS) :\n\t\t\t\t      MAP_SHARED) |\n\t\t\t\t   MAP_HUGETLB | (populate ? MAP_POPULATE : 0) |\n\t\t\t\t   (reserve ? 0 : MAP_NORESERVE),\n\t\t\t   -1, 0);\n\n\t\tif (ptr == MAP_FAILED)\n\t\t\terr(1, \"mmap\");\n\n\t\tprintf(\"Returned address is %p\\n\", ptr);\n\t\tbreak;\n\tcase SHM:\n\t\tprintf(\"Allocating using SHM.\\n\");\n\t\tshmid = shmget(key, size,\n\t\t\t       SHM_HUGETLB | IPC_CREAT | SHM_R | SHM_W);\n\t\tif (shmid < 0) {\n\t\t\tshmid = shmget(++key, size,\n\t\t\t\t       SHM_HUGETLB | IPC_CREAT | SHM_R | SHM_W);\n\t\t\tif (shmid < 0)\n\t\t\t\terr(1, \"shmget\");\n\t\t}\n\t\tprintf(\"shmid: 0x%x, shmget key:%d\\n\", shmid, key);\n\n\t\tptr = shmat(shmid, NULL, 0);\n\t\tif (ptr == (int *)-1) {\n\t\t\tperror(\"Shared memory attach failure\");\n\t\t\tshmctl(shmid, IPC_RMID, NULL);\n\t\t\texit(2);\n\t\t}\n\t\tprintf(\"shmaddr: %p\\n\", ptr);\n\n\t\tbreak;\n\tdefault:\n\t\terrno = EINVAL;\n\t\terr(1, \"Invalid method.\");\n\t}\n\n\tif (write) {\n\t\tprintf(\"Writing to memory.\\n\");\n\t\tmemset(ptr, 1, size);\n\t}\n\n\tif (want_sleep) {\n\t\t \n\t\tprintf(\"DONE\\n\");\n\n\t\t \n\t\twhile (1)\n\t\t\tsleep(100);\n\t}\n\n\tif (method == HUGETLBFS)\n\t\tclose(fd);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}