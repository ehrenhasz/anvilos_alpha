{
  "module_name": "hugepage-mremap.c",
  "hash_id": "d177208846961634a0b08bac27bcbfc31d794827475caa3d448c07fec4491c3b",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/hugepage-mremap.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/mman.h>\n#include <errno.h>\n#include <fcntl.h>  \n#include <sys/syscall.h>  \n#include <linux/userfaultfd.h>\n#include <sys/ioctl.h>\n#include <string.h>\n#include <stdbool.h>\n#include \"vm_util.h\"\n\n#define DEFAULT_LENGTH_MB 10UL\n#define MB_TO_BYTES(x) (x * 1024 * 1024)\n\n#define PROTECTION (PROT_READ | PROT_WRITE | PROT_EXEC)\n#define FLAGS (MAP_SHARED | MAP_ANONYMOUS)\n\nstatic void check_bytes(char *addr)\n{\n\tprintf(\"First hex is %x\\n\", *((unsigned int *)addr));\n}\n\nstatic void write_bytes(char *addr, size_t len)\n{\n\tunsigned long i;\n\n\tfor (i = 0; i < len; i++)\n\t\t*(addr + i) = (char)i;\n}\n\nstatic int read_bytes(char *addr, size_t len)\n{\n\tunsigned long i;\n\n\tcheck_bytes(addr);\n\tfor (i = 0; i < len; i++)\n\t\tif (*(addr + i) != (char)i) {\n\t\t\tprintf(\"Mismatch at %lu\\n\", i);\n\t\t\treturn 1;\n\t\t}\n\treturn 0;\n}\n\nstatic void register_region_with_uffd(char *addr, size_t len)\n{\n\tlong uffd;  \n\tstruct uffdio_api uffdio_api;\n\n\t \n\n\tuffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);\n\tif (uffd == -1) {\n\t\tperror(\"userfaultfd\");\n\t\texit(1);\n\t}\n\n\tuffdio_api.api = UFFD_API;\n\tuffdio_api.features = 0;\n\tif (ioctl(uffd, UFFDIO_API, &uffdio_api) == -1) {\n\t\tperror(\"ioctl-UFFDIO_API\");\n\t\texit(1);\n\t}\n\n\t \n\n\taddr = mmap(NULL, len, PROT_READ | PROT_WRITE,\n\t\t    MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\n\tprintf(\"Address returned by mmap() = %p\\n\", addr);\n\n\t \n\tif (uffd_register(uffd, addr, len, true, false, false)) {\n\t\tperror(\"ioctl-UFFDIO_REGISTER\");\n\t\texit(1);\n\t}\n}\n\nint main(int argc, char *argv[])\n{\n\tsize_t length = 0;\n\tint ret = 0, fd;\n\n\tif (argc >= 2 && !strcmp(argv[1], \"-h\")) {\n\t\tprintf(\"Usage: %s [length_in_MB]\\n\", argv[0]);\n\t\texit(1);\n\t}\n\n\t \n\tif (argc >= 2)\n\t\tlength = (size_t)atoi(argv[1]);\n\telse\n\t\tlength = DEFAULT_LENGTH_MB;\n\n\tlength = MB_TO_BYTES(length);\n\tfd = memfd_create(argv[0], MFD_HUGETLB);\n\tif (fd < 0) {\n\t\tperror(\"Open failed\");\n\t\texit(1);\n\t}\n\n\t \n\tunsigned long suggested_addr = 0x7eaa40000000;\n\tvoid *haddr = mmap((void *)suggested_addr, length, PROTECTION,\n\t\t\t   MAP_HUGETLB | MAP_SHARED | MAP_POPULATE, fd, 0);\n\tprintf(\"Map haddr: Returned address is %p\\n\", haddr);\n\tif (haddr == MAP_FAILED) {\n\t\tperror(\"mmap1\");\n\t\texit(1);\n\t}\n\n\t \n\tsuggested_addr = 0x7daa40000000;\n\tvoid *daddr = mmap((void *)suggested_addr, length, PROTECTION,\n\t\t\t   MAP_HUGETLB | MAP_SHARED | MAP_POPULATE, fd, 0);\n\tprintf(\"Map daddr: Returned address is %p\\n\", daddr);\n\tif (daddr == MAP_FAILED) {\n\t\tperror(\"mmap3\");\n\t\texit(1);\n\t}\n\n\tsuggested_addr = 0x7faa40000000;\n\tvoid *vaddr =\n\t\tmmap((void *)suggested_addr, length, PROTECTION, FLAGS, -1, 0);\n\tprintf(\"Map vaddr: Returned address is %p\\n\", vaddr);\n\tif (vaddr == MAP_FAILED) {\n\t\tperror(\"mmap2\");\n\t\texit(1);\n\t}\n\n\tregister_region_with_uffd(haddr, length);\n\n\tvoid *addr = mremap(haddr, length, length,\n\t\t\t    MREMAP_MAYMOVE | MREMAP_FIXED, vaddr);\n\tif (addr == MAP_FAILED) {\n\t\tperror(\"mremap\");\n\t\texit(1);\n\t}\n\n\tprintf(\"Mremap: Returned address is %p\\n\", addr);\n\tcheck_bytes(addr);\n\twrite_bytes(addr, length);\n\tret = read_bytes(addr, length);\n\n\tmunmap(addr, length);\n\n\taddr = mremap(addr, length, length, 0);\n\tif (addr != MAP_FAILED) {\n\t\tprintf(\"mremap: Expected failure, but call succeeded\\n\");\n\t\texit(1);\n\t}\n\n\tclose(fd);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}