{
  "module_name": "map_fixed_noreplace.c",
  "hash_id": "a3900b6cd5213a89aab9ca8801cc00faebefc37cdcc629261a660193b204e110",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/map_fixed_noreplace.c",
  "human_readable_source": "\n\n \n\n#include <sys/mman.h>\n#include <errno.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nstatic void dump_maps(void)\n{\n\tchar cmd[32];\n\n\tsnprintf(cmd, sizeof(cmd), \"cat /proc/%d/maps\", getpid());\n\tsystem(cmd);\n}\n\nstatic unsigned long find_base_addr(unsigned long size)\n{\n\tvoid *addr;\n\tunsigned long flags;\n\n\tflags = MAP_PRIVATE | MAP_ANONYMOUS;\n\taddr = mmap(NULL, size, PROT_NONE, flags, -1, 0);\n\tif (addr == MAP_FAILED) {\n\t\tprintf(\"Error: couldn't map the space we need for the test\\n\");\n\t\treturn 0;\n\t}\n\n\tif (munmap(addr, size) != 0) {\n\t\tprintf(\"Error: couldn't map the space we need for the test\\n\");\n\t\treturn 0;\n\t}\n\treturn (unsigned long)addr;\n}\n\nint main(void)\n{\n\tunsigned long base_addr;\n\tunsigned long flags, addr, size, page_size;\n\tchar *p;\n\n\tpage_size = sysconf(_SC_PAGE_SIZE);\n\n\t\n\tsize = 5 * page_size;\n\tbase_addr = find_base_addr(size);\n\tif (!base_addr) {\n\t\tprintf(\"Error: couldn't map the space we need for the test\\n\");\n\t\treturn 1;\n\t}\n\n\tflags = MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED_NOREPLACE;\n\n\t\n\terrno = 0;\n\taddr = base_addr;\n\tsize = 5 * page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p == MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error: couldn't map the space we need for the test\\n\");\n\t\treturn 1;\n\t}\n\n\terrno = 0;\n\tif (munmap((void *)addr, 5 * page_size) != 0) {\n\t\tdump_maps();\n\t\tprintf(\"Error: munmap failed!?\\n\");\n\t\treturn 1;\n\t}\n\tprintf(\"unmap() successful\\n\");\n\n\terrno = 0;\n\taddr = base_addr + page_size;\n\tsize = 3 * page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p == MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error: first mmap() failed unexpectedly\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terrno = 0;\n\taddr = base_addr;\n\tsize = 5 * page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p != MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error:1: mmap() succeeded when it shouldn't have\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terrno = 0;\n\taddr = base_addr + (2 * page_size);\n\tsize = page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p != MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error:2: mmap() succeeded when it shouldn't have\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terrno = 0;\n\taddr = base_addr + (3 * page_size);\n\tsize = 2 * page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p != MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error:3: mmap() succeeded when it shouldn't have\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terrno = 0;\n\taddr = base_addr;\n\tsize = 2 * page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p != MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error:4: mmap() succeeded when it shouldn't have\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terrno = 0;\n\taddr = base_addr;\n\tsize = page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p == MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error:5: mmap() failed when it shouldn't have\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terrno = 0;\n\taddr = base_addr + (4 * page_size);\n\tsize = page_size;\n\tp = mmap((void *)addr, size, PROT_NONE, flags, -1, 0);\n\tprintf(\"mmap() @ 0x%lx-0x%lx p=%p result=%m\\n\", addr, addr + size, p);\n\n\tif (p == MAP_FAILED) {\n\t\tdump_maps();\n\t\tprintf(\"Error:6: mmap() failed when it shouldn't have\\n\");\n\t\treturn 1;\n\t}\n\n\taddr = base_addr;\n\tsize = 5 * page_size;\n\tif (munmap((void *)addr, size) != 0) {\n\t\tdump_maps();\n\t\tprintf(\"Error: munmap failed!?\\n\");\n\t\treturn 1;\n\t}\n\tprintf(\"unmap() successful\\n\");\n\n\tprintf(\"OK\\n\");\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}