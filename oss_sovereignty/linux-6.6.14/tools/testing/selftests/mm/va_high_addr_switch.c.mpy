{
  "module_name": "va_high_addr_switch.c",
  "hash_id": "4d6f1234be3bc61b1e5f370d2258ac7982f827bca00942960e456adfe028a150",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/va_high_addr_switch.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <sys/mman.h>\n#include <string.h>\n\n#include \"../kselftest.h\"\n\n#ifdef __powerpc64__\n#define PAGE_SIZE\t(64 << 10)\n \n#define HUGETLB_SIZE\t(16 << 20)\n#elif __aarch64__\n \n#define PAGE_SIZE\t(64 << 10)\n#define HUGETLB_SIZE\t(512 << 20)\n#else\n#define PAGE_SIZE\t(4 << 10)\n#define HUGETLB_SIZE\t(2 << 20)\n#endif\n\n \n\n#define ADDR_MARK_128TB\t(1UL << 47)\n#define ADDR_MARK_256TB\t(1UL << 48)\n\n#define HIGH_ADDR_128TB\t((void *) (1UL << 48))\n#define HIGH_ADDR_256TB\t((void *) (1UL << 49))\n\n#define LOW_ADDR\t((void *) (1UL << 30))\n\n#ifdef __aarch64__\n#define ADDR_SWITCH_HINT ADDR_MARK_256TB\n#define HIGH_ADDR\t HIGH_ADDR_256TB\n#else\n#define ADDR_SWITCH_HINT ADDR_MARK_128TB\n#define HIGH_ADDR\t HIGH_ADDR_128TB\n#endif\n\nstruct testcase {\n\tvoid *addr;\n\tunsigned long size;\n\tunsigned long flags;\n\tconst char *msg;\n\tunsigned int low_addr_required:1;\n\tunsigned int keep_mapped:1;\n};\n\nstatic struct testcase testcases[] = {\n\t{\n\t\t \n\t\t.addr = ((void *)(ADDR_SWITCH_HINT - PAGE_SIZE)),\n\t\t.size = PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT - PAGE_SIZE, PAGE_SIZE)\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t \n\t\t.addr = ((void *)(ADDR_SWITCH_HINT - PAGE_SIZE)),\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT - PAGE_SIZE, (2 * PAGE_SIZE))\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t \n\t\t.addr = ((void *)(ADDR_SWITCH_HINT)),\n\t\t.size = PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT, PAGE_SIZE)\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = (void *)(ADDR_SWITCH_HINT),\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT, 2 * PAGE_SIZE, MAP_FIXED)\",\n\t},\n\t{\n\t\t.addr = NULL,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(NULL)\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t.addr = LOW_ADDR,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(LOW_ADDR)\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t.addr = HIGH_ADDR,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(HIGH_ADDR)\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = HIGH_ADDR,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(HIGH_ADDR) again\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = HIGH_ADDR,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,\n\t\t.msg = \"mmap(HIGH_ADDR, MAP_FIXED)\",\n\t},\n\t{\n\t\t.addr = (void *) -1,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(-1)\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = (void *) -1,\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(-1) again\",\n\t},\n\t{\n\t\t.addr = ((void *)(ADDR_SWITCH_HINT - PAGE_SIZE)),\n\t\t.size = PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT - PAGE_SIZE, PAGE_SIZE)\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t.addr = (void *)(ADDR_SWITCH_HINT - PAGE_SIZE),\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT - PAGE_SIZE, 2 * PAGE_SIZE)\",\n\t\t.low_addr_required = 1,\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = (void *)(ADDR_SWITCH_HINT - PAGE_SIZE / 2),\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT - PAGE_SIZE/2 , 2 * PAGE_SIZE)\",\n\t\t.low_addr_required = 1,\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = ((void *)(ADDR_SWITCH_HINT)),\n\t\t.size = PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT, PAGE_SIZE)\",\n\t},\n\t{\n\t\t.addr = (void *)(ADDR_SWITCH_HINT),\n\t\t.size = 2 * PAGE_SIZE,\n\t\t.flags = MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT, 2 * PAGE_SIZE, MAP_FIXED)\",\n\t},\n};\n\nstatic struct testcase hugetlb_testcases[] = {\n\t{\n\t\t.addr = NULL,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(NULL, MAP_HUGETLB)\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t.addr = LOW_ADDR,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(LOW_ADDR, MAP_HUGETLB)\",\n\t\t.low_addr_required = 1,\n\t},\n\t{\n\t\t.addr = HIGH_ADDR,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(HIGH_ADDR, MAP_HUGETLB)\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = HIGH_ADDR,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(HIGH_ADDR, MAP_HUGETLB) again\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = HIGH_ADDR,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,\n\t\t.msg = \"mmap(HIGH_ADDR, MAP_FIXED | MAP_HUGETLB)\",\n\t},\n\t{\n\t\t.addr = (void *) -1,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(-1, MAP_HUGETLB)\",\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = (void *) -1,\n\t\t.size = HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(-1, MAP_HUGETLB) again\",\n\t},\n\t{\n\t\t.addr = (void *)(ADDR_SWITCH_HINT - PAGE_SIZE),\n\t\t.size = 2 * HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT - PAGE_SIZE, 2*HUGETLB_SIZE, MAP_HUGETLB)\",\n\t\t.low_addr_required = 1,\n\t\t.keep_mapped = 1,\n\t},\n\t{\n\t\t.addr = (void *)(ADDR_SWITCH_HINT),\n\t\t.size = 2 * HUGETLB_SIZE,\n\t\t.flags = MAP_HUGETLB | MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,\n\t\t.msg = \"mmap(ADDR_SWITCH_HINT , 2*HUGETLB_SIZE, MAP_FIXED | MAP_HUGETLB)\",\n\t},\n};\n\nstatic int run_test(struct testcase *test, int count)\n{\n\tvoid *p;\n\tint i, ret = KSFT_PASS;\n\n\tfor (i = 0; i < count; i++) {\n\t\tstruct testcase *t = test + i;\n\n\t\tp = mmap(t->addr, t->size, PROT_READ | PROT_WRITE, t->flags, -1, 0);\n\n\t\tprintf(\"%s: %p - \", t->msg, p);\n\n\t\tif (p == MAP_FAILED) {\n\t\t\tprintf(\"FAILED\\n\");\n\t\t\tret = KSFT_FAIL;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (t->low_addr_required && p >= (void *)(ADDR_SWITCH_HINT)) {\n\t\t\tprintf(\"FAILED\\n\");\n\t\t\tret = KSFT_FAIL;\n\t\t} else {\n\t\t\t \n\t\t\tmemset(p, 0, t->size);\n\t\t\tprintf(\"OK\\n\");\n\t\t}\n\t\tif (!t->keep_mapped)\n\t\t\tmunmap(p, t->size);\n\t}\n\n\treturn ret;\n}\n\nstatic int supported_arch(void)\n{\n#if defined(__powerpc64__)\n\treturn 1;\n#elif defined(__x86_64__)\n\treturn 1;\n#elif defined(__aarch64__)\n\treturn getpagesize() == PAGE_SIZE;\n#else\n\treturn 0;\n#endif\n}\n\nint main(int argc, char **argv)\n{\n\tint ret;\n\n\tif (!supported_arch())\n\t\treturn KSFT_SKIP;\n\n\tret = run_test(testcases, ARRAY_SIZE(testcases));\n\tif (argc == 2 && !strcmp(argv[1], \"--run-hugetlb\"))\n\t\tret = run_test(hugetlb_testcases, ARRAY_SIZE(hugetlb_testcases));\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}