{
  "module_name": "pkey-powerpc.h",
  "hash_id": "1909929018b77f37d7172e13a639edcd69e19f6c0df8292f8c3c46189b1543de",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/pkey-powerpc.h",
  "human_readable_source": " \n\n#ifndef _PKEYS_POWERPC_H\n#define _PKEYS_POWERPC_H\n\n#ifndef SYS_pkey_alloc\n# define SYS_pkey_alloc\t\t384\n# define SYS_pkey_free\t\t385\n#endif\n#define REG_IP_IDX\t\tPT_NIP\n#define REG_TRAPNO\t\tPT_TRAP\n#define gregs\t\t\tgp_regs\n#define fpregs\t\t\tfp_regs\n#define si_pkey_offset\t\t0x20\n\n#undef PKEY_DISABLE_ACCESS\n#define PKEY_DISABLE_ACCESS\t0x3   \n\n#undef PKEY_DISABLE_WRITE\n#define PKEY_DISABLE_WRITE\t0x2\n\n#define NR_PKEYS\t\t32\n#define NR_RESERVED_PKEYS_4K\t27  \n#define NR_RESERVED_PKEYS_64K_3KEYS\t3  \n#define NR_RESERVED_PKEYS_64K_4KEYS\t4  \n#define PKEY_BITS_PER_PKEY\t2\n#define HPAGE_SIZE\t\t(1UL << 24)\n#define PAGE_SIZE\t\tsysconf(_SC_PAGESIZE)\n\nstatic inline u32 pkey_bit_position(int pkey)\n{\n\treturn (NR_PKEYS - pkey - 1) * PKEY_BITS_PER_PKEY;\n}\n\nstatic inline u64 __read_pkey_reg(void)\n{\n\tu64 pkey_reg;\n\n\tasm volatile(\"mfspr %0, 0xd\" : \"=r\" (pkey_reg));\n\n\treturn pkey_reg;\n}\n\nstatic inline void __write_pkey_reg(u64 pkey_reg)\n{\n\tu64 amr = pkey_reg;\n\n\tdprintf4(\"%s() changing %016llx to %016llx\\n\",\n\t\t\t __func__, __read_pkey_reg(), pkey_reg);\n\n\tasm volatile(\"isync; mtspr 0xd, %0; isync\"\n\t\t     : : \"r\" ((unsigned long)(amr)) : \"memory\");\n\n\tdprintf4(\"%s() pkey register after changing %016llx to %016llx\\n\",\n\t\t\t__func__, __read_pkey_reg(), pkey_reg);\n}\n\nstatic inline int cpu_has_pkeys(void)\n{\n\t \n\treturn 1;\n}\n\nstatic inline bool arch_is_powervm()\n{\n\tstruct stat buf;\n\n\tif ((stat(\"/sys/firmware/devicetree/base/ibm,partition-name\", &buf) == 0) &&\n\t    (stat(\"/sys/firmware/devicetree/base/hmc-managed?\", &buf) == 0) &&\n\t    (stat(\"/sys/firmware/devicetree/base/chosen/qemu,graphic-width\", &buf) == -1) )\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic inline int get_arch_reserved_keys(void)\n{\n\tif (sysconf(_SC_PAGESIZE) == 4096)\n\t\treturn NR_RESERVED_PKEYS_4K;\n\telse\n\t\tif (arch_is_powervm())\n\t\t\treturn NR_RESERVED_PKEYS_64K_4KEYS;\n\t\telse\n\t\t\treturn NR_RESERVED_PKEYS_64K_3KEYS;\n}\n\nvoid expect_fault_on_read_execonly_key(void *p1, int pkey)\n{\n\t \n\treturn;\n}\n\n \n#define __page_o_noops() asm(\".rept 16384 ; nop; .endr\")\n\nvoid *malloc_pkey_with_mprotect_subpage(long size, int prot, u16 pkey)\n{\n\tvoid *ptr;\n\tint ret;\n\n\tdprintf1(\"doing %s(size=%ld, prot=0x%x, pkey=%d)\\n\", __func__,\n\t\t\tsize, prot, pkey);\n\tpkey_assert(pkey < NR_PKEYS);\n\tptr = mmap(NULL, size, prot, MAP_ANONYMOUS|MAP_PRIVATE, -1, 0);\n\tpkey_assert(ptr != (void *)-1);\n\n\tret = syscall(__NR_subpage_prot, ptr, size, NULL);\n\tif (ret) {\n\t\tperror(\"subpage_perm\");\n\t\treturn PTR_ERR_ENOTSUP;\n\t}\n\n\tret = mprotect_pkey((void *)ptr, PAGE_SIZE, prot, pkey);\n\tpkey_assert(!ret);\n\trecord_pkey_malloc(ptr, size, prot);\n\n\tdprintf1(\"%s() for pkey %d @ %p\\n\", __func__, pkey, ptr);\n\treturn ptr;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}