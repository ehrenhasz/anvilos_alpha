{
  "module_name": "hugetlb_reparenting_test.sh",
  "hash_id": "a387eef30f79b12cdfb6b1e065a3cb1b376d397ab5cbf273ab35900854bea752",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/hugetlb_reparenting_test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nset -e\n\nif [[ $(id -u) -ne 0 ]]; then\n  echo \"This test must be run as root. Skipping...\"\n  exit $ksft_skip\nfi\n\nusage_file=usage_in_bytes\n\nif [[ \"$1\" == \"-cgroup-v2\" ]]; then\n  cgroup2=1\n  usage_file=current\nfi\n\n\nif [[ $cgroup2 ]]; then\n  CGROUP_ROOT=$(mount -t cgroup2 | head -1 | awk '{print $3}')\n  if [[ -z \"$CGROUP_ROOT\" ]]; then\n    CGROUP_ROOT=/dev/cgroup/memory\n    mount -t cgroup2 none $CGROUP_ROOT\n    do_umount=1\n  fi\n  echo \"+hugetlb +memory\" >$CGROUP_ROOT/cgroup.subtree_control\nelse\n  CGROUP_ROOT=$(mount -t cgroup | grep \",hugetlb\" | awk '{print $3}')\n  if [[ -z \"$CGROUP_ROOT\" ]]; then\n    CGROUP_ROOT=/dev/cgroup/memory\n    mount -t cgroup memory,hugetlb $CGROUP_ROOT\n    do_umount=1\n  fi\nfi\nMNT='/mnt/huge/'\n\nfunction get_machine_hugepage_size() {\n  hpz=$(grep -i hugepagesize /proc/meminfo)\n  kb=${hpz:14:-3}\n  mb=$(($kb / 1024))\n  echo $mb\n}\n\nMB=$(get_machine_hugepage_size)\n\nfunction cleanup() {\n  echo cleanup\n  set +e\n  rm -rf \"$MNT\"/* 2>/dev/null\n  umount \"$MNT\" 2>/dev/null\n  rmdir \"$MNT\" 2>/dev/null\n  rmdir \"$CGROUP_ROOT\"/a/b 2>/dev/null\n  rmdir \"$CGROUP_ROOT\"/a 2>/dev/null\n  rmdir \"$CGROUP_ROOT\"/test1 2>/dev/null\n  echo 0 >/proc/sys/vm/nr_hugepages\n  set -e\n}\n\nfunction assert_state() {\n  local expected_a=\"$1\"\n  local expected_a_hugetlb=\"$2\"\n  local expected_b=\"\"\n  local expected_b_hugetlb=\"\"\n\n  if [ ! -z ${3:-} ] && [ ! -z ${4:-} ]; then\n    expected_b=\"$3\"\n    expected_b_hugetlb=\"$4\"\n  fi\n  local tolerance=$((5 * 1024 * 1024))\n\n  local actual_a\n  actual_a=\"$(cat \"$CGROUP_ROOT\"/a/memory.$usage_file)\"\n  if [[ $actual_a -lt $(($expected_a - $tolerance)) ]] ||\n    [[ $actual_a -gt $(($expected_a + $tolerance)) ]]; then\n    echo actual a = $((${actual_a%% *} / 1024 / 1024)) MB\n    echo expected a = $((${expected_a%% *} / 1024 / 1024)) MB\n    echo fail\n\n    cleanup\n    exit 1\n  fi\n\n  local actual_a_hugetlb\n  actual_a_hugetlb=\"$(cat \"$CGROUP_ROOT\"/a/hugetlb.${MB}MB.$usage_file)\"\n  if [[ $actual_a_hugetlb -lt $(($expected_a_hugetlb - $tolerance)) ]] ||\n    [[ $actual_a_hugetlb -gt $(($expected_a_hugetlb + $tolerance)) ]]; then\n    echo actual a hugetlb = $((${actual_a_hugetlb%% *} / 1024 / 1024)) MB\n    echo expected a hugetlb = $((${expected_a_hugetlb%% *} / 1024 / 1024)) MB\n    echo fail\n\n    cleanup\n    exit 1\n  fi\n\n  if [[ -z \"$expected_b\" || -z \"$expected_b_hugetlb\" ]]; then\n    return\n  fi\n\n  local actual_b\n  actual_b=\"$(cat \"$CGROUP_ROOT\"/a/b/memory.$usage_file)\"\n  if [[ $actual_b -lt $(($expected_b - $tolerance)) ]] ||\n    [[ $actual_b -gt $(($expected_b + $tolerance)) ]]; then\n    echo actual b = $((${actual_b%% *} / 1024 / 1024)) MB\n    echo expected b = $((${expected_b%% *} / 1024 / 1024)) MB\n    echo fail\n\n    cleanup\n    exit 1\n  fi\n\n  local actual_b_hugetlb\n  actual_b_hugetlb=\"$(cat \"$CGROUP_ROOT\"/a/b/hugetlb.${MB}MB.$usage_file)\"\n  if [[ $actual_b_hugetlb -lt $(($expected_b_hugetlb - $tolerance)) ]] ||\n    [[ $actual_b_hugetlb -gt $(($expected_b_hugetlb + $tolerance)) ]]; then\n    echo actual b hugetlb = $((${actual_b_hugetlb%% *} / 1024 / 1024)) MB\n    echo expected b hugetlb = $((${expected_b_hugetlb%% *} / 1024 / 1024)) MB\n    echo fail\n\n    cleanup\n    exit 1\n  fi\n}\n\nfunction setup() {\n  echo 100 >/proc/sys/vm/nr_hugepages\n  mkdir \"$CGROUP_ROOT\"/a\n  sleep 1\n  if [[ $cgroup2 ]]; then\n    echo \"+hugetlb +memory\" >$CGROUP_ROOT/a/cgroup.subtree_control\n  else\n    echo 0 >$CGROUP_ROOT/a/cpuset.mems\n    echo 0 >$CGROUP_ROOT/a/cpuset.cpus\n  fi\n\n  mkdir \"$CGROUP_ROOT\"/a/b\n\n  if [[ ! $cgroup2 ]]; then\n    echo 0 >$CGROUP_ROOT/a/b/cpuset.mems\n    echo 0 >$CGROUP_ROOT/a/b/cpuset.cpus\n  fi\n\n  mkdir -p \"$MNT\"\n  mount -t hugetlbfs none \"$MNT\"\n}\n\nwrite_hugetlbfs() {\n  local cgroup=\"$1\"\n  local path=\"$2\"\n  local size=\"$3\"\n\n  if [[ $cgroup2 ]]; then\n    echo $$ >$CGROUP_ROOT/$cgroup/cgroup.procs\n  else\n    echo 0 >$CGROUP_ROOT/$cgroup/cpuset.mems\n    echo 0 >$CGROUP_ROOT/$cgroup/cpuset.cpus\n    echo $$ >\"$CGROUP_ROOT/$cgroup/tasks\"\n  fi\n  ./write_to_hugetlbfs -p \"$path\" -s \"$size\" -m 0 -o\n  if [[ $cgroup2 ]]; then\n    echo $$ >$CGROUP_ROOT/cgroup.procs\n  else\n    echo $$ >\"$CGROUP_ROOT/tasks\"\n  fi\n  echo\n}\n\nset -e\n\nsize=$((${MB} * 1024 * 1024 * 25)) # 50MB = 25 * 2MB hugepages.\n\ncleanup\n\necho\necho\necho Test charge, rmdir, uncharge\nsetup\necho mkdir\nmkdir $CGROUP_ROOT/test1\n\necho write\nwrite_hugetlbfs test1 \"$MNT\"/test $size\n\necho rmdir\nrmdir $CGROUP_ROOT/test1\nmkdir $CGROUP_ROOT/test1\n\necho uncharge\nrm -rf /mnt/huge/*\n\ncleanup\n\necho done\necho\necho\nif [[ ! $cgroup2 ]]; then\n  echo \"Test parent and child hugetlb usage\"\n  setup\n\n  echo write\n  write_hugetlbfs a \"$MNT\"/test $size\n\n  echo Assert memory charged correctly for parent use.\n  assert_state 0 $size 0 0\n\n  write_hugetlbfs a/b \"$MNT\"/test2 $size\n\n  echo Assert memory charged correctly for child use.\n  assert_state 0 $(($size * 2)) 0 $size\n\n  rmdir \"$CGROUP_ROOT\"/a/b\n  sleep 5\n  echo Assert memory reparent correctly.\n  assert_state 0 $(($size * 2))\n\n  rm -rf \"$MNT\"/*\n  umount \"$MNT\"\n  echo Assert memory uncharged correctly.\n  assert_state 0 0\n\n  cleanup\nfi\n\necho\necho\necho \"Test child only hugetlb usage\"\necho setup\nsetup\n\necho write\nwrite_hugetlbfs a/b \"$MNT\"/test2 $size\n\necho Assert memory charged correctly for child only use.\nassert_state 0 $(($size)) 0 $size\n\nrmdir \"$CGROUP_ROOT\"/a/b\necho Assert memory reparent correctly.\nassert_state 0 $size\n\nrm -rf \"$MNT\"/*\numount \"$MNT\"\necho Assert memory uncharged correctly.\nassert_state 0 0\n\ncleanup\n\necho ALL PASS\n\numount $CGROUP_ROOT\nrm -rf $CGROUP_ROOT\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}