{
  "module_name": "charge_reserved_hugetlb.sh",
  "hash_id": "e04ec2a45a7928ed43219eb896d658f9331b2ac91e16bb5e100e616cc9a3231d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/charge_reserved_hugetlb.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nset -e\n\nif [[ $(id -u) -ne 0 ]]; then\n  echo \"This test must be run as root. Skipping...\"\n  exit $ksft_skip\nfi\n\nfault_limit_file=limit_in_bytes\nreservation_limit_file=rsvd.limit_in_bytes\nfault_usage_file=usage_in_bytes\nreservation_usage_file=rsvd.usage_in_bytes\n\nif [[ \"$1\" == \"-cgroup-v2\" ]]; then\n  cgroup2=1\n  fault_limit_file=max\n  reservation_limit_file=rsvd.max\n  fault_usage_file=current\n  reservation_usage_file=rsvd.current\nfi\n\nif [[ $cgroup2 ]]; then\n  cgroup_path=$(mount -t cgroup2 | head -1 | awk '{print $3}')\n  if [[ -z \"$cgroup_path\" ]]; then\n    cgroup_path=/dev/cgroup/memory\n    mount -t cgroup2 none $cgroup_path\n    do_umount=1\n  fi\n  echo \"+hugetlb\" >$cgroup_path/cgroup.subtree_control\nelse\n  cgroup_path=$(mount -t cgroup | grep \",hugetlb\" | awk '{print $3}')\n  if [[ -z \"$cgroup_path\" ]]; then\n    cgroup_path=/dev/cgroup/memory\n    mount -t cgroup memory,hugetlb $cgroup_path\n    do_umount=1\n  fi\nfi\nexport cgroup_path\n\nfunction cleanup() {\n  if [[ $cgroup2 ]]; then\n    echo $$ >$cgroup_path/cgroup.procs\n  else\n    echo $$ >$cgroup_path/tasks\n  fi\n\n  if [[ -e /mnt/huge ]]; then\n    rm -rf /mnt/huge/*\n    umount /mnt/huge || echo error\n    rmdir /mnt/huge\n  fi\n  if [[ -e $cgroup_path/hugetlb_cgroup_test ]]; then\n    rmdir $cgroup_path/hugetlb_cgroup_test\n  fi\n  if [[ -e $cgroup_path/hugetlb_cgroup_test1 ]]; then\n    rmdir $cgroup_path/hugetlb_cgroup_test1\n  fi\n  if [[ -e $cgroup_path/hugetlb_cgroup_test2 ]]; then\n    rmdir $cgroup_path/hugetlb_cgroup_test2\n  fi\n  echo 0 >/proc/sys/vm/nr_hugepages\n  echo CLEANUP DONE\n}\n\nfunction expect_equal() {\n  local expected=\"$1\"\n  local actual=\"$2\"\n  local error=\"$3\"\n\n  if [[ \"$expected\" != \"$actual\" ]]; then\n    echo \"expected ($expected) != actual ($actual): $3\"\n    cleanup\n    exit 1\n  fi\n}\n\nfunction get_machine_hugepage_size() {\n  hpz=$(grep -i hugepagesize /proc/meminfo)\n  kb=${hpz:14:-3}\n  mb=$(($kb / 1024))\n  echo $mb\n}\n\nMB=$(get_machine_hugepage_size)\n\nfunction setup_cgroup() {\n  local name=\"$1\"\n  local cgroup_limit=\"$2\"\n  local reservation_limit=\"$3\"\n\n  mkdir $cgroup_path/$name\n\n  echo writing cgroup limit: \"$cgroup_limit\"\n  echo \"$cgroup_limit\" >$cgroup_path/$name/hugetlb.${MB}MB.$fault_limit_file\n\n  echo writing reseravation limit: \"$reservation_limit\"\n  echo \"$reservation_limit\" > \\\n    $cgroup_path/$name/hugetlb.${MB}MB.$reservation_limit_file\n\n  if [ -e \"$cgroup_path/$name/cpuset.cpus\" ]; then\n    echo 0 >$cgroup_path/$name/cpuset.cpus\n  fi\n  if [ -e \"$cgroup_path/$name/cpuset.mems\" ]; then\n    echo 0 >$cgroup_path/$name/cpuset.mems\n  fi\n}\n\nfunction wait_for_hugetlb_memory_to_get_depleted() {\n  local cgroup=\"$1\"\n  local path=\"$cgroup_path/$cgroup/hugetlb.${MB}MB.$reservation_usage_file\"\n  # Wait for hugetlbfs memory to get depleted.\n  while [ $(cat $path) != 0 ]; do\n    echo Waiting for hugetlb memory to get depleted.\n    cat $path\n    sleep 0.5\n  done\n}\n\nfunction wait_for_hugetlb_memory_to_get_reserved() {\n  local cgroup=\"$1\"\n  local size=\"$2\"\n\n  local path=\"$cgroup_path/$cgroup/hugetlb.${MB}MB.$reservation_usage_file\"\n  # Wait for hugetlbfs memory to get written.\n  while [ $(cat $path) != $size ]; do\n    echo Waiting for hugetlb memory reservation to reach size $size.\n    cat $path\n    sleep 0.5\n  done\n}\n\nfunction wait_for_hugetlb_memory_to_get_written() {\n  local cgroup=\"$1\"\n  local size=\"$2\"\n\n  local path=\"$cgroup_path/$cgroup/hugetlb.${MB}MB.$fault_usage_file\"\n  # Wait for hugetlbfs memory to get written.\n  while [ $(cat $path) != $size ]; do\n    echo Waiting for hugetlb memory to reach size $size.\n    cat $path\n    sleep 0.5\n  done\n}\n\nfunction write_hugetlbfs_and_get_usage() {\n  local cgroup=\"$1\"\n  local size=\"$2\"\n  local populate=\"$3\"\n  local write=\"$4\"\n  local path=\"$5\"\n  local method=\"$6\"\n  local private=\"$7\"\n  local expect_failure=\"$8\"\n  local reserve=\"$9\"\n\n  # Function return values.\n  reservation_failed=0\n  oom_killed=0\n  hugetlb_difference=0\n  reserved_difference=0\n\n  local hugetlb_usage=$cgroup_path/$cgroup/hugetlb.${MB}MB.$fault_usage_file\n  local reserved_usage=$cgroup_path/$cgroup/hugetlb.${MB}MB.$reservation_usage_file\n\n  local hugetlb_before=$(cat $hugetlb_usage)\n  local reserved_before=$(cat $reserved_usage)\n\n  echo\n  echo Starting:\n  echo hugetlb_usage=\"$hugetlb_before\"\n  echo reserved_usage=\"$reserved_before\"\n  echo expect_failure is \"$expect_failure\"\n\n  output=$(mktemp)\n  set +e\n  if [[ \"$method\" == \"1\" ]] || [[ \"$method\" == 2 ]] ||\n    [[ \"$private\" == \"-r\" ]] && [[ \"$expect_failure\" != 1 ]]; then\n\n    bash write_hugetlb_memory.sh \"$size\" \"$populate\" \"$write\" \\\n      \"$cgroup\" \"$path\" \"$method\" \"$private\" \"-l\" \"$reserve\" 2>&1 | tee $output &\n\n    local write_result=$?\n    local write_pid=$!\n\n    until grep -q -i \"DONE\" $output; do\n      echo waiting for DONE signal.\n      if ! ps $write_pid > /dev/null\n      then\n        echo \"FAIL: The write died\"\n        cleanup\n        exit 1\n      fi\n      sleep 0.5\n    done\n\n    echo ================= write_hugetlb_memory.sh output is:\n    cat $output\n    echo ================= end output.\n\n    if [[ \"$populate\" == \"-o\" ]] || [[ \"$write\" == \"-w\" ]]; then\n      wait_for_hugetlb_memory_to_get_written \"$cgroup\" \"$size\"\n    elif [[ \"$reserve\" != \"-n\" ]]; then\n      wait_for_hugetlb_memory_to_get_reserved \"$cgroup\" \"$size\"\n    else\n      # This case doesn't produce visible effects, but we still have\n      # to wait for the async process to start and execute...\n      sleep 0.5\n    fi\n\n    echo write_result is $write_result\n  else\n    bash write_hugetlb_memory.sh \"$size\" \"$populate\" \"$write\" \\\n      \"$cgroup\" \"$path\" \"$method\" \"$private\" \"$reserve\"\n    local write_result=$?\n\n    if [[ \"$reserve\" != \"-n\" ]]; then\n      wait_for_hugetlb_memory_to_get_reserved \"$cgroup\" \"$size\"\n    fi\n  fi\n  set -e\n\n  if [[ \"$write_result\" == 1 ]]; then\n    reservation_failed=1\n  fi\n\n  # On linus/master, the above process gets SIGBUS'd on oomkill, with\n  # return code 135. On earlier kernels, it gets actual oomkill, with return\n  # code 137, so just check for both conditions in case we're testing\n  # against an earlier kernel.\n  if [[ \"$write_result\" == 135 ]] || [[ \"$write_result\" == 137 ]]; then\n    oom_killed=1\n  fi\n\n  local hugetlb_after=$(cat $hugetlb_usage)\n  local reserved_after=$(cat $reserved_usage)\n\n  echo After write:\n  echo hugetlb_usage=\"$hugetlb_after\"\n  echo reserved_usage=\"$reserved_after\"\n\n  hugetlb_difference=$(($hugetlb_after - $hugetlb_before))\n  reserved_difference=$(($reserved_after - $reserved_before))\n}\n\nfunction cleanup_hugetlb_memory() {\n  set +e\n  local cgroup=\"$1\"\n  if [[ \"$(pgrep -f write_to_hugetlbfs)\" != \"\" ]]; then\n    echo killing write_to_hugetlbfs\n    killall -2 write_to_hugetlbfs\n    wait_for_hugetlb_memory_to_get_depleted $cgroup\n  fi\n  set -e\n\n  if [[ -e /mnt/huge ]]; then\n    rm -rf /mnt/huge/*\n    umount /mnt/huge\n    rmdir /mnt/huge\n  fi\n}\n\nfunction run_test() {\n  local size=$(($1 * ${MB} * 1024 * 1024))\n  local populate=\"$2\"\n  local write=\"$3\"\n  local cgroup_limit=$(($4 * ${MB} * 1024 * 1024))\n  local reservation_limit=$(($5 * ${MB} * 1024 * 1024))\n  local nr_hugepages=\"$6\"\n  local method=\"$7\"\n  local private=\"$8\"\n  local expect_failure=\"$9\"\n  local reserve=\"${10}\"\n\n  # Function return values.\n  hugetlb_difference=0\n  reserved_difference=0\n  reservation_failed=0\n  oom_killed=0\n\n  echo nr hugepages = \"$nr_hugepages\"\n  echo \"$nr_hugepages\" >/proc/sys/vm/nr_hugepages\n\n  setup_cgroup \"hugetlb_cgroup_test\" \"$cgroup_limit\" \"$reservation_limit\"\n\n  mkdir -p /mnt/huge\n  mount -t hugetlbfs -o pagesize=${MB}M,size=256M none /mnt/huge\n\n  write_hugetlbfs_and_get_usage \"hugetlb_cgroup_test\" \"$size\" \"$populate\" \\\n    \"$write\" \"/mnt/huge/test\" \"$method\" \"$private\" \"$expect_failure\" \\\n    \"$reserve\"\n\n  cleanup_hugetlb_memory \"hugetlb_cgroup_test\"\n\n  local final_hugetlb=$(cat $cgroup_path/hugetlb_cgroup_test/hugetlb.${MB}MB.$fault_usage_file)\n  local final_reservation=$(cat $cgroup_path/hugetlb_cgroup_test/hugetlb.${MB}MB.$reservation_usage_file)\n\n  echo $hugetlb_difference\n  echo $reserved_difference\n  expect_equal \"0\" \"$final_hugetlb\" \"final hugetlb is not zero\"\n  expect_equal \"0\" \"$final_reservation\" \"final reservation is not zero\"\n}\n\nfunction run_multiple_cgroup_test() {\n  local size1=\"$1\"\n  local populate1=\"$2\"\n  local write1=\"$3\"\n  local cgroup_limit1=\"$4\"\n  local reservation_limit1=\"$5\"\n\n  local size2=\"$6\"\n  local populate2=\"$7\"\n  local write2=\"$8\"\n  local cgroup_limit2=\"$9\"\n  local reservation_limit2=\"${10}\"\n\n  local nr_hugepages=\"${11}\"\n  local method=\"${12}\"\n  local private=\"${13}\"\n  local expect_failure=\"${14}\"\n  local reserve=\"${15}\"\n\n  # Function return values.\n  hugetlb_difference1=0\n  reserved_difference1=0\n  reservation_failed1=0\n  oom_killed1=0\n\n  hugetlb_difference2=0\n  reserved_difference2=0\n  reservation_failed2=0\n  oom_killed2=0\n\n  echo nr hugepages = \"$nr_hugepages\"\n  echo \"$nr_hugepages\" >/proc/sys/vm/nr_hugepages\n\n  setup_cgroup \"hugetlb_cgroup_test1\" \"$cgroup_limit1\" \"$reservation_limit1\"\n  setup_cgroup \"hugetlb_cgroup_test2\" \"$cgroup_limit2\" \"$reservation_limit2\"\n\n  mkdir -p /mnt/huge\n  mount -t hugetlbfs -o pagesize=${MB}M,size=256M none /mnt/huge\n\n  write_hugetlbfs_and_get_usage \"hugetlb_cgroup_test1\" \"$size1\" \\\n    \"$populate1\" \"$write1\" \"/mnt/huge/test1\" \"$method\" \"$private\" \\\n    \"$expect_failure\" \"$reserve\"\n\n  hugetlb_difference1=$hugetlb_difference\n  reserved_difference1=$reserved_difference\n  reservation_failed1=$reservation_failed\n  oom_killed1=$oom_killed\n\n  local cgroup1_hugetlb_usage=$cgroup_path/hugetlb_cgroup_test1/hugetlb.${MB}MB.$fault_usage_file\n  local cgroup1_reservation_usage=$cgroup_path/hugetlb_cgroup_test1/hugetlb.${MB}MB.$reservation_usage_file\n  local cgroup2_hugetlb_usage=$cgroup_path/hugetlb_cgroup_test2/hugetlb.${MB}MB.$fault_usage_file\n  local cgroup2_reservation_usage=$cgroup_path/hugetlb_cgroup_test2/hugetlb.${MB}MB.$reservation_usage_file\n\n  local usage_before_second_write=$(cat $cgroup1_hugetlb_usage)\n  local reservation_usage_before_second_write=$(cat $cgroup1_reservation_usage)\n\n  write_hugetlbfs_and_get_usage \"hugetlb_cgroup_test2\" \"$size2\" \\\n    \"$populate2\" \"$write2\" \"/mnt/huge/test2\" \"$method\" \"$private\" \\\n    \"$expect_failure\" \"$reserve\"\n\n  hugetlb_difference2=$hugetlb_difference\n  reserved_difference2=$reserved_difference\n  reservation_failed2=$reservation_failed\n  oom_killed2=$oom_killed\n\n  expect_equal \"$usage_before_second_write\" \\\n    \"$(cat $cgroup1_hugetlb_usage)\" \"Usage changed.\"\n  expect_equal \"$reservation_usage_before_second_write\" \\\n    \"$(cat $cgroup1_reservation_usage)\" \"Reservation usage changed.\"\n\n  cleanup_hugetlb_memory\n\n  local final_hugetlb=$(cat $cgroup1_hugetlb_usage)\n  local final_reservation=$(cat $cgroup1_reservation_usage)\n\n  expect_equal \"0\" \"$final_hugetlb\" \\\n    \"hugetlbt_cgroup_test1 final hugetlb is not zero\"\n  expect_equal \"0\" \"$final_reservation\" \\\n    \"hugetlbt_cgroup_test1 final reservation is not zero\"\n\n  local final_hugetlb=$(cat $cgroup2_hugetlb_usage)\n  local final_reservation=$(cat $cgroup2_reservation_usage)\n\n  expect_equal \"0\" \"$final_hugetlb\" \\\n    \"hugetlb_cgroup_test2 final hugetlb is not zero\"\n  expect_equal \"0\" \"$final_reservation\" \\\n    \"hugetlb_cgroup_test2 final reservation is not zero\"\n}\n\ncleanup\n\nfor populate in \"\" \"-o\"; do\n  for method in 0 1 2; do\n    for private in \"\" \"-r\"; do\n      for reserve in \"\" \"-n\"; do\n\n        # Skip mmap(MAP_HUGETLB | MAP_SHARED). Doesn't seem to be supported.\n        if [[ \"$method\" == 1 ]] && [[ \"$private\" == \"\" ]]; then\n          continue\n        fi\n\n        # Skip populated shmem tests. Doesn't seem to be supported.\n        if [[ \"$method\" == 2\"\" ]] && [[ \"$populate\" == \"-o\" ]]; then\n          continue\n        fi\n\n        if [[ \"$method\" == 2\"\" ]] && [[ \"$reserve\" == \"-n\" ]]; then\n          continue\n        fi\n\n        cleanup\n        echo\n        echo\n        echo\n        echo Test normal case.\n        echo private=$private, populate=$populate, method=$method, reserve=$reserve\n        run_test 5 \"$populate\" \"\" 10 10 10 \"$method\" \"$private\" \"0\" \"$reserve\"\n\n        echo Memory charged to hugtlb=$hugetlb_difference\n        echo Memory charged to reservation=$reserved_difference\n\n        if [[ \"$populate\" == \"-o\" ]]; then\n          expect_equal \"$((5 * $MB * 1024 * 1024))\" \"$hugetlb_difference\" \\\n            \"Reserved memory charged to hugetlb cgroup.\"\n        else\n          expect_equal \"0\" \"$hugetlb_difference\" \\\n            \"Reserved memory charged to hugetlb cgroup.\"\n        fi\n\n        if [[ \"$reserve\" != \"-n\" ]] || [[ \"$populate\" == \"-o\" ]]; then\n          expect_equal \"$((5 * $MB * 1024 * 1024))\" \"$reserved_difference\" \\\n            \"Reserved memory not charged to reservation usage.\"\n        else\n          expect_equal \"0\" \"$reserved_difference\" \\\n            \"Reserved memory not charged to reservation usage.\"\n        fi\n\n        echo 'PASS'\n\n        cleanup\n        echo\n        echo\n        echo\n        echo Test normal case with write.\n        echo private=$private, populate=$populate, method=$method, reserve=$reserve\n        run_test 5 \"$populate\" '-w' 5 5 10 \"$method\" \"$private\" \"0\" \"$reserve\"\n\n        echo Memory charged to hugtlb=$hugetlb_difference\n        echo Memory charged to reservation=$reserved_difference\n\n        expect_equal \"$((5 * $MB * 1024 * 1024))\" \"$hugetlb_difference\" \\\n          \"Reserved memory charged to hugetlb cgroup.\"\n\n        expect_equal \"$((5 * $MB * 1024 * 1024))\" \"$reserved_difference\" \\\n          \"Reserved memory not charged to reservation usage.\"\n\n        echo 'PASS'\n\n        cleanup\n        continue\n        echo\n        echo\n        echo\n        echo Test more than reservation case.\n        echo private=$private, populate=$populate, method=$method, reserve=$reserve\n\n        if [ \"$reserve\" != \"-n\" ]; then\n          run_test \"5\" \"$populate\" '' \"10\" \"2\" \"10\" \"$method\" \"$private\" \"1\" \\\n            \"$reserve\"\n\n          expect_equal \"1\" \"$reservation_failed\" \"Reservation succeeded.\"\n        fi\n\n        echo 'PASS'\n\n        cleanup\n\n        echo\n        echo\n        echo\n        echo Test more than cgroup limit case.\n        echo private=$private, populate=$populate, method=$method, reserve=$reserve\n\n        # Not sure if shm memory can be cleaned up when the process gets sigbus'd.\n        if [[ \"$method\" != 2 ]]; then\n          run_test 5 \"$populate\" \"-w\" 2 10 10 \"$method\" \"$private\" \"1\" \"$reserve\"\n\n          expect_equal \"1\" \"$oom_killed\" \"Not oom killed.\"\n        fi\n        echo 'PASS'\n\n        cleanup\n\n        echo\n        echo\n        echo\n        echo Test normal case, multiple cgroups.\n        echo private=$private, populate=$populate, method=$method, reserve=$reserve\n        run_multiple_cgroup_test \"3\" \"$populate\" \"\" \"10\" \"10\" \"5\" \\\n          \"$populate\" \"\" \"10\" \"10\" \"10\" \\\n          \"$method\" \"$private\" \"0\" \"$reserve\"\n\n        echo Memory charged to hugtlb1=$hugetlb_difference1\n        echo Memory charged to reservation1=$reserved_difference1\n        echo Memory charged to hugtlb2=$hugetlb_difference2\n        echo Memory charged to reservation2=$reserved_difference2\n\n        if [[ \"$reserve\" != \"-n\" ]] || [[ \"$populate\" == \"-o\" ]]; then\n          expect_equal \"3\" \"$reserved_difference1\" \\\n            \"Incorrect reservations charged to cgroup 1.\"\n\n          expect_equal \"5\" \"$reserved_difference2\" \\\n            \"Incorrect reservation charged to cgroup 2.\"\n\n        else\n          expect_equal \"0\" \"$reserved_difference1\" \\\n            \"Incorrect reservations charged to cgroup 1.\"\n\n          expect_equal \"0\" \"$reserved_difference2\" \\\n            \"Incorrect reservation charged to cgroup 2.\"\n        fi\n\n        if [[ \"$populate\" == \"-o\" ]]; then\n          expect_equal \"3\" \"$hugetlb_difference1\" \\\n            \"Incorrect hugetlb charged to cgroup 1.\"\n\n          expect_equal \"5\" \"$hugetlb_difference2\" \\\n            \"Incorrect hugetlb charged to cgroup 2.\"\n\n        else\n          expect_equal \"0\" \"$hugetlb_difference1\" \\\n            \"Incorrect hugetlb charged to cgroup 1.\"\n\n          expect_equal \"0\" \"$hugetlb_difference2\" \\\n            \"Incorrect hugetlb charged to cgroup 2.\"\n        fi\n        echo 'PASS'\n\n        cleanup\n        echo\n        echo\n        echo\n        echo Test normal case with write, multiple cgroups.\n        echo private=$private, populate=$populate, method=$method, reserve=$reserve\n        run_multiple_cgroup_test \"3\" \"$populate\" \"-w\" \"10\" \"10\" \"5\" \\\n          \"$populate\" \"-w\" \"10\" \"10\" \"10\" \\\n          \"$method\" \"$private\" \"0\" \"$reserve\"\n\n        echo Memory charged to hugtlb1=$hugetlb_difference1\n        echo Memory charged to reservation1=$reserved_difference1\n        echo Memory charged to hugtlb2=$hugetlb_difference2\n        echo Memory charged to reservation2=$reserved_difference2\n\n        expect_equal \"3\" \"$hugetlb_difference1\" \\\n          \"Incorrect hugetlb charged to cgroup 1.\"\n\n        expect_equal \"3\" \"$reserved_difference1\" \\\n          \"Incorrect reservation charged to cgroup 1.\"\n\n        expect_equal \"5\" \"$hugetlb_difference2\" \\\n          \"Incorrect hugetlb charged to cgroup 2.\"\n\n        expect_equal \"5\" \"$reserved_difference2\" \\\n          \"Incorrected reservation charged to cgroup 2.\"\n        echo 'PASS'\n\n        cleanup\n\n      done # reserve\n    done   # private\n  done     # populate\ndone       # method\n\nif [[ $do_umount ]]; then\n  umount $cgroup_path\n  rmdir $cgroup_path\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}