{
  "module_name": "map_populate.c",
  "hash_id": "bd90e5249e4da8f562a59186f1717d466eb68a80abc3ce684d9a0f61c1777752",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/map_populate.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <errno.h>\n#include <fcntl.h>\n#include <sys/mman.h>\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\n#define MMAP_SZ\t\t4096\n\n#define BUG_ON(condition, description)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tif (condition) {\t\t\t\t\t\\\n\t\t\tfprintf(stderr, \"[FAIL]\\t%s:%d\\t%s:%s\\n\", __func__, \\\n\t\t\t\t__LINE__, (description), strerror(errno)); \\\n\t\t\texit(1);\t\t\t\t\t\\\n\t\t}\t\t\t\t\t\t\t\\\n\t} while (0)\n\nstatic int parent_f(int sock, unsigned long *smap, int child)\n{\n\tint status, ret;\n\n\tret = read(sock, &status, sizeof(int));\n\tBUG_ON(ret <= 0, \"read(sock)\");\n\n\t*smap = 0x22222BAD;\n\tret = msync(smap, MMAP_SZ, MS_SYNC);\n\tBUG_ON(ret, \"msync()\");\n\n\tret = write(sock, &status, sizeof(int));\n\tBUG_ON(ret <= 0, \"write(sock)\");\n\n\twaitpid(child, &status, 0);\n\tBUG_ON(!WIFEXITED(status), \"child in unexpected state\");\n\n\treturn WEXITSTATUS(status);\n}\n\nstatic int child_f(int sock, unsigned long *smap, int fd)\n{\n\tint ret, buf = 0;\n\n\tsmap = mmap(0, MMAP_SZ, PROT_READ | PROT_WRITE,\n\t\t\tMAP_PRIVATE | MAP_POPULATE, fd, 0);\n\tBUG_ON(smap == MAP_FAILED, \"mmap()\");\n\n\tBUG_ON(*smap != 0xdeadbabe, \"MAP_PRIVATE | MAP_POPULATE changed file\");\n\n\tret = write(sock, &buf, sizeof(int));\n\tBUG_ON(ret <= 0, \"write(sock)\");\n\n\tret = read(sock, &buf, sizeof(int));\n\tBUG_ON(ret <= 0, \"read(sock)\");\n\n\tBUG_ON(*smap == 0x22222BAD, \"MAP_POPULATE didn't COW private page\");\n\tBUG_ON(*smap != 0xdeadbabe, \"mapping was corrupted\");\n\n\treturn 0;\n}\n\nint main(int argc, char **argv)\n{\n\tint sock[2], child, ret;\n\tFILE *ftmp;\n\tunsigned long *smap;\n\n\tftmp = tmpfile();\n\tBUG_ON(!ftmp, \"tmpfile()\");\n\n\tret = ftruncate(fileno(ftmp), MMAP_SZ);\n\tBUG_ON(ret, \"ftruncate()\");\n\n\tsmap = mmap(0, MMAP_SZ, PROT_READ | PROT_WRITE,\n\t\t\tMAP_SHARED, fileno(ftmp), 0);\n\tBUG_ON(smap == MAP_FAILED, \"mmap()\");\n\n\t*smap = 0xdeadbabe;\n\t \n\tret = msync(smap, MMAP_SZ, MS_SYNC);\n\tBUG_ON(ret, \"msync()\");\n\n\tret = socketpair(PF_LOCAL, SOCK_SEQPACKET, 0, sock);\n\tBUG_ON(ret, \"socketpair()\");\n\n\tchild = fork();\n\tBUG_ON(child == -1, \"fork()\");\n\n\tif (child) {\n\t\tret = close(sock[0]);\n\t\tBUG_ON(ret, \"close()\");\n\n\t\treturn parent_f(sock[1], smap, child);\n\t}\n\n\tret = close(sock[1]);\n\tBUG_ON(ret, \"close()\");\n\n\treturn child_f(sock[0], smap, fileno(ftmp));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}