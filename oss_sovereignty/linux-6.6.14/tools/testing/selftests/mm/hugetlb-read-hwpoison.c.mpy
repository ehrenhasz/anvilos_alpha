{
  "module_name": "hugetlb-read-hwpoison.c",
  "hash_id": "7dd8bc8e96fd1864b4d8d7ee6efe590e7c8f0158b4e9521dcecf61c8b7cb771d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/hugetlb-read-hwpoison.c",
  "human_readable_source": "\n\n#define _GNU_SOURCE\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n\n#include <linux/magic.h>\n#include <sys/mman.h>\n#include <sys/statfs.h>\n#include <errno.h>\n#include <stdbool.h>\n\n#include \"../kselftest.h\"\n\n#define PREFIX \" ... \"\n#define ERROR_PREFIX \" !!! \"\n\n#define MAX_WRITE_READ_CHUNK_SIZE (getpagesize() * 16)\n#define MAX(a, b) (((a) > (b)) ? (a) : (b))\n\nenum test_status {\n\tTEST_PASSED = 0,\n\tTEST_FAILED = 1,\n\tTEST_SKIPPED = 2,\n};\n\nstatic char *status_to_str(enum test_status status)\n{\n\tswitch (status) {\n\tcase TEST_PASSED:\n\t\treturn \"TEST_PASSED\";\n\tcase TEST_FAILED:\n\t\treturn \"TEST_FAILED\";\n\tcase TEST_SKIPPED:\n\t\treturn \"TEST_SKIPPED\";\n\tdefault:\n\t\treturn \"TEST_???\";\n\t}\n}\n\nstatic int setup_filemap(char *filemap, size_t len, size_t wr_chunk_size)\n{\n\tchar iter = 0;\n\n\tfor (size_t offset = 0; offset < len;\n\t     offset += wr_chunk_size) {\n\t\titer++;\n\t\tmemset(filemap + offset, iter, wr_chunk_size);\n\t}\n\n\treturn 0;\n}\n\nstatic bool verify_chunk(char *buf, size_t len, char val)\n{\n\tsize_t i;\n\n\tfor (i = 0; i < len; ++i) {\n\t\tif (buf[i] != val) {\n\t\t\tprintf(PREFIX ERROR_PREFIX \"check fail: buf[%lu] = %u != %u\\n\",\n\t\t\t\ti, buf[i], val);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\nstatic bool seek_read_hugepage_filemap(int fd, size_t len, size_t wr_chunk_size,\n\t\t\t\t       off_t offset, size_t expected)\n{\n\tchar buf[MAX_WRITE_READ_CHUNK_SIZE];\n\tssize_t ret_count = 0;\n\tssize_t total_ret_count = 0;\n\tchar val = offset / wr_chunk_size + offset % wr_chunk_size;\n\n\tprintf(PREFIX PREFIX \"init val=%u with offset=0x%lx\\n\", val, offset);\n\tprintf(PREFIX PREFIX \"expect to read 0x%lx bytes of data in total\\n\",\n\t       expected);\n\tif (lseek(fd, offset, SEEK_SET) < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"seek failed\");\n\t\treturn false;\n\t}\n\n\twhile (offset + total_ret_count < len) {\n\t\tret_count = read(fd, buf, wr_chunk_size);\n\t\tif (ret_count == 0) {\n\t\t\tprintf(PREFIX PREFIX \"read reach end of the file\\n\");\n\t\t\tbreak;\n\t\t} else if (ret_count < 0) {\n\t\t\tperror(PREFIX ERROR_PREFIX \"read failed\");\n\t\t\tbreak;\n\t\t}\n\t\t++val;\n\t\tif (!verify_chunk(buf, ret_count, val))\n\t\t\treturn false;\n\n\t\ttotal_ret_count += ret_count;\n\t}\n\tprintf(PREFIX PREFIX \"actually read 0x%lx bytes of data in total\\n\",\n\t       total_ret_count);\n\n\treturn total_ret_count == expected;\n}\n\nstatic bool read_hugepage_filemap(int fd, size_t len,\n\t\t\t\t  size_t wr_chunk_size, size_t expected)\n{\n\tchar buf[MAX_WRITE_READ_CHUNK_SIZE];\n\tssize_t ret_count = 0;\n\tssize_t total_ret_count = 0;\n\tchar val = 0;\n\n\tprintf(PREFIX PREFIX \"expect to read 0x%lx bytes of data in total\\n\",\n\t       expected);\n\twhile (total_ret_count < len) {\n\t\tret_count = read(fd, buf, wr_chunk_size);\n\t\tif (ret_count == 0) {\n\t\t\tprintf(PREFIX PREFIX \"read reach end of the file\\n\");\n\t\t\tbreak;\n\t\t} else if (ret_count < 0) {\n\t\t\tperror(PREFIX ERROR_PREFIX \"read failed\");\n\t\t\tbreak;\n\t\t}\n\t\t++val;\n\t\tif (!verify_chunk(buf, ret_count, val))\n\t\t\treturn false;\n\n\t\ttotal_ret_count += ret_count;\n\t}\n\tprintf(PREFIX PREFIX \"actually read 0x%lx bytes of data in total\\n\",\n\t       total_ret_count);\n\n\treturn total_ret_count == expected;\n}\n\nstatic enum test_status\ntest_hugetlb_read(int fd, size_t len, size_t wr_chunk_size)\n{\n\tenum test_status status = TEST_SKIPPED;\n\tchar *filemap = NULL;\n\n\tif (ftruncate(fd, len) < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"ftruncate failed\");\n\t\treturn status;\n\t}\n\n\tfilemap = mmap(NULL, len, PROT_READ | PROT_WRITE,\n\t\t       MAP_SHARED | MAP_POPULATE, fd, 0);\n\tif (filemap == MAP_FAILED) {\n\t\tperror(PREFIX ERROR_PREFIX \"mmap for primary mapping failed\");\n\t\tgoto done;\n\t}\n\n\tsetup_filemap(filemap, len, wr_chunk_size);\n\tstatus = TEST_FAILED;\n\n\tif (read_hugepage_filemap(fd, len, wr_chunk_size, len))\n\t\tstatus = TEST_PASSED;\n\n\tmunmap(filemap, len);\ndone:\n\tif (ftruncate(fd, 0) < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"ftruncate back to 0 failed\");\n\t\tstatus = TEST_FAILED;\n\t}\n\n\treturn status;\n}\n\nstatic enum test_status\ntest_hugetlb_read_hwpoison(int fd, size_t len, size_t wr_chunk_size,\n\t\t\t   bool skip_hwpoison_page)\n{\n\tenum test_status status = TEST_SKIPPED;\n\tchar *filemap = NULL;\n\tchar *hwp_addr = NULL;\n\tconst unsigned long pagesize = getpagesize();\n\n\tif (ftruncate(fd, len) < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"ftruncate failed\");\n\t\treturn status;\n\t}\n\n\tfilemap = mmap(NULL, len, PROT_READ | PROT_WRITE,\n\t\t       MAP_SHARED | MAP_POPULATE, fd, 0);\n\tif (filemap == MAP_FAILED) {\n\t\tperror(PREFIX ERROR_PREFIX \"mmap for primary mapping failed\");\n\t\tgoto done;\n\t}\n\n\tsetup_filemap(filemap, len, wr_chunk_size);\n\tstatus = TEST_FAILED;\n\n\t \n\thwp_addr = filemap + len / 2 + pagesize;\n\tif (madvise(hwp_addr, pagesize, MADV_HWPOISON) < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"MADV_HWPOISON failed\");\n\t\tgoto unmap;\n\t}\n\n\tif (!skip_hwpoison_page) {\n\t\t \n\t\tif (read_hugepage_filemap(fd, len, wr_chunk_size,\n\t\t\t\t\t  len / 2 + pagesize))\n\t\t\tstatus = TEST_PASSED;\n\t} else {\n\t\t \n\t\tif (seek_read_hugepage_filemap(fd, len, wr_chunk_size,\n\t\t\t\t\t       len / 2 + MAX(2 * pagesize, wr_chunk_size),\n\t\t\t\t\t       len / 2 - MAX(2 * pagesize, wr_chunk_size)))\n\t\t\tstatus = TEST_PASSED;\n\t}\n\nunmap:\n\tmunmap(filemap, len);\ndone:\n\tif (ftruncate(fd, 0) < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"ftruncate back to 0 failed\");\n\t\tstatus = TEST_FAILED;\n\t}\n\n\treturn status;\n}\n\nstatic int create_hugetlbfs_file(struct statfs *file_stat)\n{\n\tint fd;\n\n\tfd = memfd_create(\"hugetlb_tmp\", MFD_HUGETLB);\n\tif (fd < 0) {\n\t\tperror(PREFIX ERROR_PREFIX \"could not open hugetlbfs file\");\n\t\treturn -1;\n\t}\n\n\tmemset(file_stat, 0, sizeof(*file_stat));\n\tif (fstatfs(fd, file_stat)) {\n\t\tperror(PREFIX ERROR_PREFIX \"fstatfs failed\");\n\t\tgoto close;\n\t}\n\tif (file_stat->f_type != HUGETLBFS_MAGIC) {\n\t\tprintf(PREFIX ERROR_PREFIX \"not hugetlbfs file\\n\");\n\t\tgoto close;\n\t}\n\n\treturn fd;\nclose:\n\tclose(fd);\n\treturn -1;\n}\n\nint main(void)\n{\n\tint fd;\n\tstruct statfs file_stat;\n\tenum test_status status;\n\t \n\tsize_t wr_chunk_sizes[] = {\n\t\tgetpagesize() / 2, getpagesize(),\n\t\tgetpagesize() * 2, getpagesize() * 4\n\t};\n\tsize_t i;\n\n\tfor (i = 0; i < ARRAY_SIZE(wr_chunk_sizes); ++i) {\n\t\tprintf(\"Write/read chunk size=0x%lx\\n\",\n\t\t       wr_chunk_sizes[i]);\n\n\t\tfd = create_hugetlbfs_file(&file_stat);\n\t\tif (fd < 0)\n\t\t\tgoto create_failure;\n\t\tprintf(PREFIX \"HugeTLB read regression test...\\n\");\n\t\tstatus = test_hugetlb_read(fd, file_stat.f_bsize,\n\t\t\t\t\t   wr_chunk_sizes[i]);\n\t\tprintf(PREFIX \"HugeTLB read regression test...%s\\n\",\n\t\t       status_to_str(status));\n\t\tclose(fd);\n\t\tif (status == TEST_FAILED)\n\t\t\treturn -1;\n\n\t\tfd = create_hugetlbfs_file(&file_stat);\n\t\tif (fd < 0)\n\t\t\tgoto create_failure;\n\t\tprintf(PREFIX \"HugeTLB read HWPOISON test...\\n\");\n\t\tstatus = test_hugetlb_read_hwpoison(fd, file_stat.f_bsize,\n\t\t\t\t\t\t    wr_chunk_sizes[i], false);\n\t\tprintf(PREFIX \"HugeTLB read HWPOISON test...%s\\n\",\n\t\t       status_to_str(status));\n\t\tclose(fd);\n\t\tif (status == TEST_FAILED)\n\t\t\treturn -1;\n\n\t\tfd = create_hugetlbfs_file(&file_stat);\n\t\tif (fd < 0)\n\t\t\tgoto create_failure;\n\t\tprintf(PREFIX \"HugeTLB seek then read HWPOISON test...\\n\");\n\t\tstatus = test_hugetlb_read_hwpoison(fd, file_stat.f_bsize,\n\t\t\t\t\t\t    wr_chunk_sizes[i], true);\n\t\tprintf(PREFIX \"HugeTLB seek then read HWPOISON test...%s\\n\",\n\t\t       status_to_str(status));\n\t\tclose(fd);\n\t\tif (status == TEST_FAILED)\n\t\t\treturn -1;\n\t}\n\n\treturn 0;\n\ncreate_failure:\n\tprintf(ERROR_PREFIX \"Abort test: failed to create hugetlbfs file\\n\");\n\treturn -1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}