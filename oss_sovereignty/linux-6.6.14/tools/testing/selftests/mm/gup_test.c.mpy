{
  "module_name": "gup_test.c",
  "hash_id": "ba69e4b222c64360ef2967b0c1412a20c56b5f38793e277ddb23709cee9ec24d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/mm/gup_test.c",
  "human_readable_source": "#include <fcntl.h>\n#include <errno.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <dirent.h>\n#include <sys/ioctl.h>\n#include <sys/mman.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <pthread.h>\n#include <assert.h>\n#include <mm/gup_test.h>\n#include \"../kselftest.h\"\n#include \"vm_util.h\"\n\n#define MB (1UL << 20)\n\n \n#define FOLL_WRITE\t0x01\t \n#define FOLL_TOUCH\t0x02\t \n\n#define GUP_TEST_FILE \"/sys/kernel/debug/gup_test\"\n\nstatic unsigned long cmd = GUP_FAST_BENCHMARK;\nstatic int gup_fd, repeats = 1;\nstatic unsigned long size = 128 * MB;\n \nstatic pthread_mutex_t print_mutex = PTHREAD_MUTEX_INITIALIZER;\n\nstatic char *cmd_to_str(unsigned long cmd)\n{\n\tswitch (cmd) {\n\tcase GUP_FAST_BENCHMARK:\n\t\treturn \"GUP_FAST_BENCHMARK\";\n\tcase PIN_FAST_BENCHMARK:\n\t\treturn \"PIN_FAST_BENCHMARK\";\n\tcase PIN_LONGTERM_BENCHMARK:\n\t\treturn \"PIN_LONGTERM_BENCHMARK\";\n\tcase GUP_BASIC_TEST:\n\t\treturn \"GUP_BASIC_TEST\";\n\tcase PIN_BASIC_TEST:\n\t\treturn \"PIN_BASIC_TEST\";\n\tcase DUMP_USER_PAGES_TEST:\n\t\treturn \"DUMP_USER_PAGES_TEST\";\n\t}\n\treturn \"Unknown command\";\n}\n\nvoid *gup_thread(void *data)\n{\n\tstruct gup_test gup = *(struct gup_test *)data;\n\tint i;\n\n\t \n\tif ((cmd == PIN_FAST_BENCHMARK) || (cmd == GUP_FAST_BENCHMARK) ||\n\t     (cmd == PIN_LONGTERM_BENCHMARK)) {\n\t\tfor (i = 0; i < repeats; i++) {\n\t\t\tgup.size = size;\n\t\t\tif (ioctl(gup_fd, cmd, &gup))\n\t\t\t\tperror(\"ioctl\"), exit(1);\n\n\t\t\tpthread_mutex_lock(&print_mutex);\n\t\t\tprintf(\"%s: Time: get:%lld put:%lld us\",\n\t\t\t       cmd_to_str(cmd), gup.get_delta_usec,\n\t\t\t       gup.put_delta_usec);\n\t\t\tif (gup.size != size)\n\t\t\t\tprintf(\", truncated (size: %lld)\", gup.size);\n\t\t\tprintf(\"\\n\");\n\t\t\tpthread_mutex_unlock(&print_mutex);\n\t\t}\n\t} else {\n\t\tgup.size = size;\n\t\tif (ioctl(gup_fd, cmd, &gup)) {\n\t\t\tperror(\"ioctl\");\n\t\t\texit(1);\n\t\t}\n\n\t\tpthread_mutex_lock(&print_mutex);\n\t\tprintf(\"%s: done\\n\", cmd_to_str(cmd));\n\t\tif (gup.size != size)\n\t\t\tprintf(\"Truncated (size: %lld)\\n\", gup.size);\n\t\tpthread_mutex_unlock(&print_mutex);\n\t}\n\n\treturn NULL;\n}\n\nint main(int argc, char **argv)\n{\n\tstruct gup_test gup = { 0 };\n\tint filed, i, opt, nr_pages = 1, thp = -1, write = 1, nthreads = 1, ret;\n\tint flags = MAP_PRIVATE, touch = 0;\n\tchar *file = \"/dev/zero\";\n\tpthread_t *tid;\n\tchar *p;\n\n\twhile ((opt = getopt(argc, argv, \"m:r:n:F:f:abcj:tTLUuwWSHpz\")) != -1) {\n\t\tswitch (opt) {\n\t\tcase 'a':\n\t\t\tcmd = PIN_FAST_BENCHMARK;\n\t\t\tbreak;\n\t\tcase 'b':\n\t\t\tcmd = PIN_BASIC_TEST;\n\t\t\tbreak;\n\t\tcase 'L':\n\t\t\tcmd = PIN_LONGTERM_BENCHMARK;\n\t\t\tbreak;\n\t\tcase 'c':\n\t\t\tcmd = DUMP_USER_PAGES_TEST;\n\t\t\t \n\t\t\tgup.which_pages[0] = 1;\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\t \n\t\t\tgup.test_flags |= GUP_TEST_FLAG_DUMP_PAGES_USE_PIN;\n\t\t\tbreak;\n\t\tcase 'F':\n\t\t\t \n\t\t\tgup.gup_flags = strtol(optarg, 0, 0);\n\t\t\tbreak;\n\t\tcase 'j':\n\t\t\tnthreads = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'm':\n\t\t\tsize = atoi(optarg) * MB;\n\t\t\tbreak;\n\t\tcase 'r':\n\t\t\trepeats = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\tnr_pages = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 't':\n\t\t\tthp = 1;\n\t\t\tbreak;\n\t\tcase 'T':\n\t\t\tthp = 0;\n\t\t\tbreak;\n\t\tcase 'U':\n\t\t\tcmd = GUP_BASIC_TEST;\n\t\t\tbreak;\n\t\tcase 'u':\n\t\t\tcmd = GUP_FAST_BENCHMARK;\n\t\t\tbreak;\n\t\tcase 'w':\n\t\t\twrite = 1;\n\t\t\tbreak;\n\t\tcase 'W':\n\t\t\twrite = 0;\n\t\t\tbreak;\n\t\tcase 'f':\n\t\t\tfile = optarg;\n\t\t\tbreak;\n\t\tcase 'S':\n\t\t\tflags &= ~MAP_PRIVATE;\n\t\t\tflags |= MAP_SHARED;\n\t\t\tbreak;\n\t\tcase 'H':\n\t\t\tflags |= (MAP_HUGETLB | MAP_ANONYMOUS);\n\t\t\tbreak;\n\t\tcase 'z':\n\t\t\t \n\t\t\ttouch = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\tif (optind < argc) {\n\t\tint extra_arg_count = 0;\n\t\t \n\n\t\twhile ((optind < argc) &&\n\t\t       (extra_arg_count < GUP_TEST_MAX_PAGES_TO_DUMP)) {\n\t\t\t \n\t\t\tlong page_index = strtol(argv[optind], 0, 0) + 1;\n\n\t\t\tgup.which_pages[extra_arg_count] = page_index;\n\t\t\textra_arg_count++;\n\t\t\toptind++;\n\t\t}\n\t}\n\n\tfiled = open(file, O_RDWR|O_CREAT);\n\tif (filed < 0) {\n\t\tperror(\"open\");\n\t\texit(filed);\n\t}\n\n\tgup.nr_pages_per_call = nr_pages;\n\tif (write)\n\t\tgup.gup_flags |= FOLL_WRITE;\n\n\tgup_fd = open(GUP_TEST_FILE, O_RDWR);\n\tif (gup_fd == -1) {\n\t\tswitch (errno) {\n\t\tcase EACCES:\n\t\t\tif (getuid())\n\t\t\t\tprintf(\"Please run this test as root\\n\");\n\t\t\tbreak;\n\t\tcase ENOENT:\n\t\t\tif (opendir(\"/sys/kernel/debug\") == NULL) {\n\t\t\t\tprintf(\"mount debugfs at /sys/kernel/debug\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tprintf(\"check if CONFIG_GUP_TEST is enabled in kernel config\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tperror(\"failed to open \" GUP_TEST_FILE);\n\t\t\tbreak;\n\t\t}\n\t\texit(KSFT_SKIP);\n\t}\n\n\tp = mmap(NULL, size, PROT_READ | PROT_WRITE, flags, filed, 0);\n\tif (p == MAP_FAILED) {\n\t\tperror(\"mmap\");\n\t\texit(1);\n\t}\n\tgup.addr = (unsigned long)p;\n\n\tif (thp == 1)\n\t\tmadvise(p, size, MADV_HUGEPAGE);\n\telse if (thp == 0)\n\t\tmadvise(p, size, MADV_NOHUGEPAGE);\n\n\t \n\tif (touch) {\n\t\tgup.gup_flags |= FOLL_TOUCH;\n\t} else {\n\t\tfor (; (unsigned long)p < gup.addr + size; p += psize())\n\t\t\tp[0] = 0;\n\t}\n\n\ttid = malloc(sizeof(pthread_t) * nthreads);\n\tassert(tid);\n\tfor (i = 0; i < nthreads; i++) {\n\t\tret = pthread_create(&tid[i], NULL, gup_thread, &gup);\n\t\tassert(ret == 0);\n\t}\n\tfor (i = 0; i < nthreads; i++) {\n\t\tret = pthread_join(tid[i], NULL);\n\t\tassert(ret == 0);\n\t}\n\tfree(tid);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}