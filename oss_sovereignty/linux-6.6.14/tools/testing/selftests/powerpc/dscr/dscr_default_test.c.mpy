{
  "module_name": "dscr_default_test.c",
  "hash_id": "f5b9e618c643827e983fb939fe0e6891e21b09896ba6c0d34ad48eccc77a3d40",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/dscr/dscr_default_test.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n\n#include \"dscr.h\"\n\n#include <pthread.h>\n#include <semaphore.h>\n#include <unistd.h>\n\nstatic void *dscr_default_lockstep_writer(void *arg)\n{\n\tsem_t *reader_sem = (sem_t *)arg;\n\tsem_t *writer_sem = (sem_t *)arg + 1;\n\tunsigned long expected_dscr = 0;\n\n\tfor (int i = 0; i < COUNT; i++) {\n\t\tFAIL_IF_EXIT(sem_wait(writer_sem));\n\n\t\tset_default_dscr(expected_dscr);\n\t\texpected_dscr = (expected_dscr + 1) % DSCR_MAX;\n\n\t\tFAIL_IF_EXIT(sem_post(reader_sem));\n\t}\n\n\treturn NULL;\n}\n\nint dscr_default_lockstep_test(void)\n{\n\tpthread_t writer;\n\tsem_t rw_semaphores[2];\n\tsem_t *reader_sem = &rw_semaphores[0];\n\tsem_t *writer_sem = &rw_semaphores[1];\n\tunsigned long expected_dscr = 0;\n\n\tSKIP_IF(!have_hwcap2(PPC_FEATURE2_DSCR));\n\n\tFAIL_IF(sem_init(reader_sem, 0, 0));\n\tFAIL_IF(sem_init(writer_sem, 0, 1));   \n\tFAIL_IF(bind_to_cpu(BIND_CPU_ANY) < 0);\n\tFAIL_IF(pthread_create(&writer, NULL, dscr_default_lockstep_writer, (void *)rw_semaphores));\n\n\tfor (int i = 0; i < COUNT ; i++) {\n\t\tFAIL_IF(sem_wait(reader_sem));\n\n\t\tFAIL_IF(get_dscr() != expected_dscr);\n\t\tFAIL_IF(get_dscr_usr() != expected_dscr);\n\n\t\texpected_dscr = (expected_dscr + 1) % DSCR_MAX;\n\n\t\tFAIL_IF(sem_post(writer_sem));\n\t}\n\n\tFAIL_IF(pthread_join(writer, NULL));\n\tFAIL_IF(sem_destroy(reader_sem));\n\tFAIL_IF(sem_destroy(writer_sem));\n\n\treturn 0;\n}\n\nstruct random_thread_args {\n\tpthread_t thread_id;\n\tunsigned long *expected_system_dscr;\n\tpthread_rwlock_t *rw_lock;\n\tpthread_barrier_t *barrier;\n};\n\nstatic void *dscr_default_random_thread(void *in)\n{\n\tstruct random_thread_args *args = (struct random_thread_args *)in;\n\tunsigned long *expected_dscr_p = args->expected_system_dscr;\n\tpthread_rwlock_t *rw_lock = args->rw_lock;\n\tint err;\n\n\tsrand(gettid());\n\n\terr = pthread_barrier_wait(args->barrier);\n\tFAIL_IF_EXIT(err != 0 && err != PTHREAD_BARRIER_SERIAL_THREAD);\n\n\tfor (int i = 0; i < COUNT; i++) {\n\t\tunsigned long expected_dscr;\n\t\tunsigned long current_dscr;\n\t\tunsigned long current_dscr_usr;\n\n\t\tFAIL_IF_EXIT(pthread_rwlock_rdlock(rw_lock));\n\t\texpected_dscr = *expected_dscr_p;\n\t\tcurrent_dscr = get_dscr();\n\t\tcurrent_dscr_usr = get_dscr_usr();\n\t\tFAIL_IF_EXIT(pthread_rwlock_unlock(rw_lock));\n\n\t\tFAIL_IF_EXIT(current_dscr != expected_dscr);\n\t\tFAIL_IF_EXIT(current_dscr_usr != expected_dscr);\n\n\t\tif (rand() % 10 == 0) {\n\t\t\tunsigned long next_dscr;\n\n\t\t\tFAIL_IF_EXIT(pthread_rwlock_wrlock(rw_lock));\n\t\t\tnext_dscr = (*expected_dscr_p + 1) % DSCR_MAX;\n\t\t\tset_default_dscr(next_dscr);\n\t\t\t*expected_dscr_p = next_dscr;\n\t\t\tFAIL_IF_EXIT(pthread_rwlock_unlock(rw_lock));\n\t\t}\n\t}\n\n\tpthread_exit((void *)0);\n}\n\nint dscr_default_random_test(void)\n{\n\tstruct random_thread_args threads[THREADS];\n\tunsigned long expected_system_dscr = 0;\n\tpthread_rwlockattr_t rwlock_attr;\n\tpthread_rwlock_t rw_lock;\n\tpthread_barrier_t barrier;\n\n\tSKIP_IF(!have_hwcap2(PPC_FEATURE2_DSCR));\n\n\tFAIL_IF(pthread_rwlockattr_setkind_np(&rwlock_attr,\n\t\t\t\t\t      PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP));\n\tFAIL_IF(pthread_rwlock_init(&rw_lock, &rwlock_attr));\n\tFAIL_IF(pthread_barrier_init(&barrier, NULL, THREADS));\n\n\tset_default_dscr(expected_system_dscr);\n\n\tfor (int i = 0; i < THREADS; i++) {\n\t\tthreads[i].expected_system_dscr = &expected_system_dscr;\n\t\tthreads[i].rw_lock = &rw_lock;\n\t\tthreads[i].barrier = &barrier;\n\n\t\tFAIL_IF(pthread_create(&threads[i].thread_id, NULL,\n\t\t\t\t       dscr_default_random_thread, (void *)&threads[i]));\n\t}\n\n\tfor (int i = 0; i < THREADS; i++)\n\t\tFAIL_IF(pthread_join(threads[i].thread_id, NULL));\n\n\tFAIL_IF(pthread_barrier_destroy(&barrier));\n\tFAIL_IF(pthread_rwlock_destroy(&rw_lock));\n\n\treturn 0;\n}\n\nint main(int argc, char *argv[])\n{\n\tunsigned long orig_dscr_default = 0;\n\tint err = 0;\n\n\tif (have_hwcap2(PPC_FEATURE2_DSCR))\n\t\torig_dscr_default = get_default_dscr();\n\n\terr |= test_harness(dscr_default_lockstep_test, \"dscr_default_lockstep_test\");\n\terr |= test_harness(dscr_default_random_test, \"dscr_default_random_test\");\n\n\tif (have_hwcap2(PPC_FEATURE2_DSCR))\n\t\tset_default_dscr(orig_dscr_default);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}