{
  "module_name": "ptrace-vsx.c",
  "hash_id": "09d0792a00c033a6fbc3e25a4750e31a1f23116615e45539d7d8399cf25bca66",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/ptrace/ptrace-vsx.c",
  "human_readable_source": "\n \n#include \"ptrace.h\"\n#include \"ptrace-vsx.h\"\n\n \nint shm_id;\nint *cptr, *pptr;\n\nunsigned long fp_load[VEC_MAX];\nunsigned long fp_load_new[VEC_MAX];\nunsigned long fp_store[VEC_MAX];\n\nvoid vsx(void)\n{\n\tint ret;\n\n\tcptr = (int *)shmat(shm_id, NULL, 0);\n\tloadvsx(fp_load, 0);\n\tcptr[1] = 1;\n\n\twhile (!cptr[0])\n\t\tasm volatile(\"\" : : : \"memory\");\n\tshmdt((void *) cptr);\n\n\tstorevsx(fp_store, 0);\n\tret = compare_vsx_vmx(fp_store, fp_load_new);\n\tif (ret)\n\t\texit(1);\n\texit(0);\n}\n\nint trace_vsx(pid_t child)\n{\n\tunsigned long vsx[VSX_MAX];\n\tunsigned long vmx[VMX_MAX + 2][2];\n\n\tFAIL_IF(start_trace(child));\n\tFAIL_IF(show_vsx(child, vsx));\n\tFAIL_IF(validate_vsx(vsx, fp_load));\n\tFAIL_IF(show_vmx(child, vmx));\n\tFAIL_IF(validate_vmx(vmx, fp_load));\n\n\tmemset(vsx, 0, sizeof(vsx));\n\tmemset(vmx, 0, sizeof(vmx));\n\tload_vsx_vmx(fp_load_new, vsx, vmx);\n\n\tFAIL_IF(write_vsx(child, vsx));\n\tFAIL_IF(write_vmx(child, vmx));\n\tFAIL_IF(stop_trace(child));\n\n\treturn TEST_PASS;\n}\n\nint ptrace_vsx(void)\n{\n\tpid_t pid;\n\tint ret, status, i;\n\n\tSKIP_IF_MSG(!have_hwcap(PPC_FEATURE_HAS_VSX), \"Don't have VSX\");\n\n\tshm_id = shmget(IPC_PRIVATE, sizeof(int) * 2, 0777|IPC_CREAT);\n\n\tfor (i = 0; i < VEC_MAX; i++)\n\t\tfp_load[i] = i + rand();\n\n\tfor (i = 0; i < VEC_MAX; i++)\n\t\tfp_load_new[i] = i + 2 * rand();\n\n\tpid = fork();\n\tif (pid < 0) {\n\t\tperror(\"fork() failed\");\n\t\treturn TEST_FAIL;\n\t}\n\n\tif (pid == 0)\n\t\tvsx();\n\n\tif (pid) {\n\t\tpptr = (int *)shmat(shm_id, NULL, 0);\n\t\twhile (!pptr[1])\n\t\t\tasm volatile(\"\" : : : \"memory\");\n\n\t\tret = trace_vsx(pid);\n\t\tif (ret) {\n\t\t\tkill(pid, SIGTERM);\n\t\t\tshmdt((void *)pptr);\n\t\t\tshmctl(shm_id, IPC_RMID, NULL);\n\t\t\treturn TEST_FAIL;\n\t\t}\n\n\t\tpptr[0] = 1;\n\t\tshmdt((void *)pptr);\n\n\t\tret = wait(&status);\n\t\tshmctl(shm_id, IPC_RMID, NULL);\n\t\tif (ret != pid) {\n\t\t\tprintf(\"Child's exit status not captured\\n\");\n\t\t\treturn TEST_FAIL;\n\t\t}\n\n\t\treturn (WIFEXITED(status) && WEXITSTATUS(status)) ? TEST_FAIL :\n\t\t\tTEST_PASS;\n\t}\n\treturn TEST_PASS;\n}\n\nint main(int argc, char *argv[])\n{\n\treturn test_harness(ptrace_vsx, \"ptrace_vsx\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}