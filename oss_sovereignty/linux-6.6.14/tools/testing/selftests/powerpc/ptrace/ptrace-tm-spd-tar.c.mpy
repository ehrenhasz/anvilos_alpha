{
  "module_name": "ptrace-tm-spd-tar.c",
  "hash_id": "1bb3eb36c6cff9b2fc3b0cccd7e1eff90bdacdf7536d92bd62c0c591f882c7c4",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/ptrace/ptrace-tm-spd-tar.c",
  "human_readable_source": "\n \n#include \"ptrace.h\"\n#include \"tm.h\"\n#include \"ptrace-tar.h\"\n\nint shm_id;\nint *cptr, *pptr;\n\n__attribute__((used)) void wait_parent(void)\n{\n\tcptr[2] = 1;\n\twhile (!cptr[1])\n\t\tasm volatile(\"\" : : : \"memory\");\n}\n\nvoid tm_spd_tar(void)\n{\n\tunsigned long result, texasr;\n\tunsigned long regs[3];\n\tint ret;\n\n\tcptr = (int *)shmat(shm_id, NULL, 0);\n\ntrans:\n\tcptr[2] = 0;\n\tasm __volatile__(\n\t\t\"li\t4, %[tar_1];\"\n\t\t\"mtspr %[sprn_tar],  4;\"\t \n\t\t\"li\t4, %[dscr_1];\"\n\t\t\"mtspr %[sprn_dscr], 4;\"\t \n\t\t\"or     31,31,31;\"\t\t \n\n\t\t\"1: ;\"\n\t\t\"tbegin.;\"\n\t\t\"beq 2f;\"\n\n\t\t\"li\t4, %[tar_2];\"\n\t\t\"mtspr %[sprn_tar],  4;\"\t \n\t\t\"li\t4, %[dscr_2];\"\n\t\t\"mtspr %[sprn_dscr], 4;\"\t \n\t\t\"or     1,1,1;\"\t\t\t \n\n\t\t\"tsuspend.;\"\n\t\t\"li\t4, %[tar_3];\"\n\t\t\"mtspr %[sprn_tar],  4;\"\t \n\t\t\"li\t4, %[dscr_3];\"\n\t\t\"mtspr %[sprn_dscr], 4;\"\t \n\t\t\"or     6,6,6;\"\t\t\t \n\t\t\"bl wait_parent;\"\n\t\t\"tresume.;\"\n\n\t\t\"tend.;\"\n\t\t\"li 0, 0;\"\n\t\t\"ori %[res], 0, 0;\"\n\t\t\"b 3f;\"\n\n\t\t \n\t\t\"2: ;\"\n\t\t\"li 0, 1;\"\n\t\t\"ori %[res], 0, 0;\"\n\t\t\"mfspr %[texasr], %[sprn_texasr];\"\n\n\t\t\"3: ;\"\n\n\t\t: [res] \"=r\" (result), [texasr] \"=r\" (texasr)\n\t\t: [sprn_dscr]\"i\"(SPRN_DSCR),\n\t\t[sprn_tar]\"i\"(SPRN_TAR), [sprn_ppr]\"i\"(SPRN_PPR),\n\t\t[sprn_texasr]\"i\"(SPRN_TEXASR), [tar_1]\"i\"(TAR_1),\n\t\t[dscr_1]\"i\"(DSCR_1), [tar_2]\"i\"(TAR_2), [dscr_2]\"i\"(DSCR_2),\n\t\t[tar_3]\"i\"(TAR_3), [dscr_3]\"i\"(DSCR_3)\n\t\t: \"memory\", \"r0\", \"r3\", \"r4\", \"r5\", \"r6\", \"lr\"\n\t\t);\n\n\t \n\tif (result) {\n\t\tif (!cptr[0])\n\t\t\tgoto trans;\n\n\t\tregs[0] = mfspr(SPRN_TAR);\n\t\tregs[1] = mfspr(SPRN_PPR);\n\t\tregs[2] = mfspr(SPRN_DSCR);\n\n\t\tshmdt(&cptr);\n\t\tprintf(\"%-30s TAR: %lu PPR: %lx DSCR: %lu\\n\",\n\t\t\t\tuser_read, regs[0], regs[1], regs[2]);\n\n\t\tret = validate_tar_registers(regs, TAR_4, PPR_4, DSCR_4);\n\t\tif (ret)\n\t\t\texit(1);\n\t\texit(0);\n\t}\n\tshmdt(&cptr);\n\texit(1);\n}\n\nint trace_tm_spd_tar(pid_t child)\n{\n\tunsigned long regs[3];\n\n\tFAIL_IF(start_trace(child));\n\tFAIL_IF(show_tar_registers(child, regs));\n\tprintf(\"%-30s TAR: %lu PPR: %lx DSCR: %lu\\n\",\n\t\t\tptrace_read_running, regs[0], regs[1], regs[2]);\n\n\tFAIL_IF(validate_tar_registers(regs, TAR_3, PPR_3, DSCR_3));\n\tFAIL_IF(show_tm_checkpointed_state(child, regs));\n\tprintf(\"%-30s TAR: %lu PPR: %lx DSCR: %lu\\n\",\n\t\t\tptrace_read_ckpt, regs[0], regs[1], regs[2]);\n\n\tFAIL_IF(validate_tar_registers(regs, TAR_1, PPR_1, DSCR_1));\n\tFAIL_IF(write_ckpt_tar_registers(child, TAR_4, PPR_4, DSCR_4));\n\tprintf(\"%-30s TAR: %u PPR: %lx DSCR: %u\\n\",\n\t\t\tptrace_write_ckpt, TAR_4, PPR_4, DSCR_4);\n\n\tpptr[0] = 1;\n\tpptr[1] = 1;\n\tFAIL_IF(stop_trace(child));\n\treturn TEST_PASS;\n}\n\nint ptrace_tm_spd_tar(void)\n{\n\tpid_t pid;\n\tint ret, status;\n\n\tSKIP_IF_MSG(!have_htm(), \"Don't have transactional memory\");\n\tSKIP_IF_MSG(htm_is_synthetic(), \"Transactional memory is synthetic\");\n\tshm_id = shmget(IPC_PRIVATE, sizeof(int) * 3, 0777|IPC_CREAT);\n\tpid = fork();\n\tif (pid == 0)\n\t\ttm_spd_tar();\n\n\tpptr = (int *)shmat(shm_id, NULL, 0);\n\tpptr[0] = 0;\n\tpptr[1] = 0;\n\n\tif (pid) {\n\t\twhile (!pptr[2])\n\t\t\tasm volatile(\"\" : : : \"memory\");\n\t\tret = trace_tm_spd_tar(pid);\n\t\tif (ret) {\n\t\t\tkill(pid, SIGTERM);\n\t\t\tshmdt(&pptr);\n\t\t\tshmctl(shm_id, IPC_RMID, NULL);\n\t\t\treturn TEST_FAIL;\n\t\t}\n\n\t\tshmdt(&pptr);\n\n\t\tret = wait(&status);\n\t\tshmctl(shm_id, IPC_RMID, NULL);\n\t\tif (ret != pid) {\n\t\t\tprintf(\"Child's exit status not captured\\n\");\n\t\t\treturn TEST_FAIL;\n\t\t}\n\n\t\treturn (WIFEXITED(status) && WEXITSTATUS(status)) ? TEST_FAIL :\n\t\t\tTEST_PASS;\n\t}\n\treturn TEST_PASS;\n}\n\nint main(int argc, char *argv[])\n{\n\treturn test_harness(ptrace_tm_spd_tar, \"ptrace_tm_spd_tar\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}