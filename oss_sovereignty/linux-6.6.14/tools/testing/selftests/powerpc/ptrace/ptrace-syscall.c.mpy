{
  "module_name": "ptrace-syscall.c",
  "hash_id": "620e583ace249b68be3fbf2b433f3cbc4a6fc2aa3cf7e51cc3fa4b240cca37ab",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/ptrace/ptrace-syscall.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n\n#include <sys/ptrace.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <sys/syscall.h>\n#include <sys/user.h>\n#include <unistd.h>\n#include <errno.h>\n#include <stddef.h>\n#include <stdio.h>\n#include <err.h>\n#include <string.h>\n#include <sys/auxv.h>\n#include \"utils.h\"\n\n \n#define user_syscall_nr\tgpr[0]\n#define user_arg0\t\tgpr[3]\n#define user_arg1\t\tgpr[4]\n#define user_arg2\t\tgpr[5]\n#define user_arg3\t\tgpr[6]\n#define user_arg4\t\tgpr[7]\n#define user_arg5\t\tgpr[8]\n#define user_ip\t\tnip\n\n#define PTRACE_SYSEMU\t\t0x1d\n\nstatic int nerrs;\n\nstatic void wait_trap(pid_t chld)\n{\n\tsiginfo_t si;\n\n\tif (waitid(P_PID, chld, &si, WEXITED|WSTOPPED) != 0)\n\t\terr(1, \"waitid\");\n\tif (si.si_pid != chld)\n\t\terrx(1, \"got unexpected pid in event\\n\");\n\tif (si.si_code != CLD_TRAPPED)\n\t\terrx(1, \"got unexpected event type %d\\n\", si.si_code);\n}\n\nstatic void test_ptrace_syscall_restart(void)\n{\n\tint status;\n\tstruct pt_regs regs;\n\tpid_t chld;\n\n\tprintf(\"[RUN]\\tptrace-induced syscall restart\\n\");\n\n\tchld = fork();\n\tif (chld < 0)\n\t\terr(1, \"fork\");\n\n\t \n\tif (chld == 0) {\n\t\tif (ptrace(PTRACE_TRACEME, 0, 0, 0) != 0)\n\t\t\terr(1, \"PTRACE_TRACEME\");\n\n\t\tpid_t pid = getpid(), tid = syscall(SYS_gettid);\n\n\t\tprintf(\"\\tChild will make one syscall\\n\");\n\t\tsyscall(SYS_tgkill, pid, tid, SIGSTOP);\n\n\t\tsyscall(SYS_gettid, 10, 11, 12, 13, 14, 15);\n\t\t_exit(0);\n\t}\n\t \n\n\t \n\tif (waitpid(chld, &status, 0) != chld || !WIFSTOPPED(status))\n\t\terr(1, \"waitpid\");\n\n\tprintf(\"[RUN]\\tSYSEMU\\n\");\n\tif (ptrace(PTRACE_SYSEMU, chld, 0, 0) != 0)\n\t\terr(1, \"PTRACE_SYSEMU\");\n\twait_trap(chld);\n\n\tif (ptrace(PTRACE_GETREGS, chld, 0, &regs) != 0)\n\t\terr(1, \"PTRACE_GETREGS\");\n\n\t \n\tif (regs.user_syscall_nr != SYS_gettid ||\n\t    regs.user_arg0 != 10 || regs.user_arg1 != 11 ||\n\t    regs.user_arg2 != 12 || regs.user_arg3 != 13 ||\n\t    regs.user_arg4 != 14 || regs.user_arg5 != 15) {\n\t\tprintf(\"[FAIL]\\tInitial args are wrong (nr=%lu, args=%lu %lu %lu %lu %lu %lu)\\n\",\n\t\t\t(unsigned long)regs.user_syscall_nr,\n\t\t\t(unsigned long)regs.user_arg0,\n\t\t\t(unsigned long)regs.user_arg1,\n\t\t\t(unsigned long)regs.user_arg2,\n\t\t\t(unsigned long)regs.user_arg3,\n\t\t\t(unsigned long)regs.user_arg4,\n\t\t\t(unsigned long)regs.user_arg5);\n\t\t nerrs++;\n\t} else {\n\t\tprintf(\"[OK]\\tInitial nr and args are correct\\n\"); }\n\n\tprintf(\"[RUN]\\tRestart the syscall (ip = 0x%lx)\\n\",\n\t       (unsigned long)regs.user_ip);\n\n\t \n\tregs.user_ip -= 4;\n\tif (ptrace(PTRACE_SETREGS, chld, 0, &regs) != 0)\n\t\terr(1, \"PTRACE_SETREGS\");\n\n\tif (ptrace(PTRACE_SYSEMU, chld, 0, 0) != 0)\n\t\terr(1, \"PTRACE_SYSEMU\");\n\twait_trap(chld);\n\n\tif (ptrace(PTRACE_GETREGS, chld, 0, &regs) != 0)\n\t\terr(1, \"PTRACE_GETREGS\");\n\n\tif (regs.user_syscall_nr != SYS_gettid ||\n\t    regs.user_arg0 != 10 || regs.user_arg1 != 11 ||\n\t    regs.user_arg2 != 12 || regs.user_arg3 != 13 ||\n\t    regs.user_arg4 != 14 || regs.user_arg5 != 15) {\n\t\tprintf(\"[FAIL]\\tRestart nr or args are wrong (nr=%lu, args=%lu %lu %lu %lu %lu %lu)\\n\",\n\t\t\t(unsigned long)regs.user_syscall_nr,\n\t\t\t(unsigned long)regs.user_arg0,\n\t\t\t(unsigned long)regs.user_arg1,\n\t\t\t(unsigned long)regs.user_arg2,\n\t\t\t(unsigned long)regs.user_arg3,\n\t\t\t(unsigned long)regs.user_arg4,\n\t\t\t(unsigned long)regs.user_arg5);\n\t\tnerrs++;\n\t} else {\n\t\tprintf(\"[OK]\\tRestarted nr and args are correct\\n\");\n\t}\n\n\tprintf(\"[RUN]\\tChange nr and args and restart the syscall (ip = 0x%lx)\\n\",\n\t       (unsigned long)regs.user_ip);\n\n\t \n\tregs.user_syscall_nr = SYS_getpid;\n\tregs.user_arg0 = 20;\n\tregs.user_arg1 = 21;\n\tregs.user_arg2 = 22;\n\tregs.user_arg3 = 23;\n\tregs.user_arg4 = 24;\n\tregs.user_arg5 = 25;\n\tregs.user_ip -= 4;\n\n\tif (ptrace(PTRACE_SETREGS, chld, 0, &regs) != 0)\n\t\terr(1, \"PTRACE_SETREGS\");\n\n\tif (ptrace(PTRACE_SYSEMU, chld, 0, 0) != 0)\n\t\terr(1, \"PTRACE_SYSEMU\");\n\twait_trap(chld);\n\n\tif (ptrace(PTRACE_GETREGS, chld, 0, &regs) != 0)\n\t\terr(1, \"PTRACE_GETREGS\");\n\n\t \n\tif (regs.user_syscall_nr != SYS_getpid\n\t\t|| regs.user_arg0 != 20 || regs.user_arg1 != 21\n\t\t|| regs.user_arg2 != 22 || regs.user_arg3 != 23\n\t\t|| regs.user_arg4 != 24 || regs.user_arg5 != 25) {\n\n\t\tprintf(\"[FAIL]\\tRestart nr or args are wrong (nr=%lu, args=%lu %lu %lu %lu %lu %lu)\\n\",\n\t\t\t(unsigned long)regs.user_syscall_nr,\n\t\t\t(unsigned long)regs.user_arg0,\n\t\t\t(unsigned long)regs.user_arg1,\n\t\t\t(unsigned long)regs.user_arg2,\n\t\t\t(unsigned long)regs.user_arg3,\n\t\t\t(unsigned long)regs.user_arg4,\n\t\t\t(unsigned long)regs.user_arg5);\n\t\tnerrs++;\n\t} else {\n\t\tprintf(\"[OK]\\tReplacement nr and args are correct\\n\");\n\t}\n\n\tif (ptrace(PTRACE_CONT, chld, 0, 0) != 0)\n\t\terr(1, \"PTRACE_CONT\");\n\n\tif (waitpid(chld, &status, 0) != chld)\n\t\terr(1, \"waitpid\");\n\n\t \n\tif (!WIFEXITED(status) || WEXITSTATUS(status) != 0) {\n\t\tprintf(\"[FAIL]\\tChild failed\\n\");\n\t\tnerrs++;\n\t} else {\n\t\tprintf(\"[OK]\\tChild exited cleanly\\n\");\n\t}\n}\n\nint ptrace_syscall(void)\n{\n\ttest_ptrace_syscall_restart();\n\n\treturn nerrs;\n}\n\nint main(void)\n{\n\treturn test_harness(ptrace_syscall, \"ptrace_syscall\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}