{
  "module_name": "signal_tm.c",
  "hash_id": "05330b3718a93b24899edf1c23905a6dacba5d22d4af566bafd0b37ff368f793",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/signal/signal_tm.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n#include <unistd.h>\n\n#include <altivec.h>\n\n#include \"utils.h\"\n#include \"../tm/tm.h\"\n\n#define MAX_ATTEMPT 500000\n#define TIMEOUT 10\n\nextern long tm_signal_self(pid_t pid, int sig, long *ret);\n\nstatic sig_atomic_t signaled;\nstatic sig_atomic_t fail;\n\nstatic void signal_handler(int sig)\n{\n\tif (tcheck_active()) {\n\t\tfail = 2;\n\t\treturn;\n\t}\n\n\tif (sig == SIGUSR1)\n\t\tsignaled = 1;\n\telse\n\t\tfail = 1;\n}\n\nstatic int test_signal_tm()\n{\n\tint i;\n\tstruct sigaction act;\n\n\tact.sa_handler = signal_handler;\n\tact.sa_flags = 0;\n\tsigemptyset(&act.sa_mask);\n\tif (sigaction(SIGUSR1, &act, NULL) < 0) {\n\t\tperror(\"sigaction SIGUSR1\");\n\t\texit(1);\n\t}\n\tif (sigaction(SIGALRM, &act, NULL) < 0) {\n\t\tperror(\"sigaction SIGALRM\");\n\t\texit(1);\n\t}\n\n\tSKIP_IF(!have_htm());\n\tSKIP_IF(htm_is_synthetic());\n\n\tfor (i = 0; i < MAX_ATTEMPT; i++) {\n\t\t \n\t\tlong ret = 0xdead;\n\t\tlong rc = 0xbeef;\n\n\t\talarm(0);  \n\t\tsignaled = 0;\n\t\talarm(TIMEOUT);\n\t\tFAIL_IF(tcheck_transactional());\n\t\trc = tm_signal_self(getpid(), SIGUSR1, &ret);\n\t\tif (ret == 0xdead)\n\t\t\t \n\t\t\tcontinue;\n\n\t\tif (rc || ret) {\n\t\t\t \n\t\t\tprintf(\"TEXASR 0x%016lx, TFIAR 0x%016lx\\n\",\n\t\t\t\t\t__builtin_get_texasr(), __builtin_get_tfiar());\n\t\t\tfprintf(stderr, \"(%d) Fail reason: %d rc=0x%lx ret=0x%lx\\n\",\n\t\t\t\t\ti, fail, rc, ret);\n\t\t\tFAIL_IF(ret);\n\t\t}\n\t\twhile(!signaled && !fail)\n\t\t\tasm volatile(\"\": : :\"memory\");\n\t\tif (!signaled) {\n\t\t\tfprintf(stderr, \"(%d) Fail reason: %d rc=0x%lx ret=0x%lx\\n\",\n\t\t\t\t\ti, fail, rc, ret);\n\t\t\tFAIL_IF(fail);  \n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint main(void)\n{\n\treturn test_harness(test_signal_tm, \"signal_tm\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}