{
  "module_name": "sigreturn_kernel.c",
  "hash_id": "97cfa64a0f176264a13b825771bacc0738b197902952c81f378ae4754fbf45f3",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/signal/sigreturn_kernel.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n\n#include <stdio.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n\n#include \"utils.h\"\n\n#define MSR_PR (1ul << 14)\n\nstatic volatile unsigned long long sigreturn_addr;\nstatic volatile unsigned long long sigreturn_msr_mask;\n\nstatic void sigusr1_handler(int signo, siginfo_t *si, void *uc_ptr)\n{\n\tucontext_t *uc = (ucontext_t *)uc_ptr;\n\n\tif (sigreturn_addr)\n\t\tUCONTEXT_NIA(uc) = sigreturn_addr;\n\n\tif (sigreturn_msr_mask)\n\t\tUCONTEXT_MSR(uc) &= sigreturn_msr_mask;\n}\n\nstatic pid_t fork_child(void)\n{\n\tpid_t pid;\n\n\tpid = fork();\n\tif (pid == 0) {\n\t\traise(SIGUSR1);\n\t\texit(0);\n\t}\n\n\treturn pid;\n}\n\nstatic int expect_segv(pid_t pid)\n{\n\tint child_ret;\n\n\twaitpid(pid, &child_ret, 0);\n\tFAIL_IF(WIFEXITED(child_ret));\n\tFAIL_IF(!WIFSIGNALED(child_ret));\n\tFAIL_IF(WTERMSIG(child_ret) != 11);\n\n\treturn 0;\n}\n\nint test_sigreturn_kernel(void)\n{\n\tstruct sigaction act;\n\tint child_ret, i;\n\tpid_t pid;\n\n\tact.sa_sigaction = sigusr1_handler;\n\tact.sa_flags = SA_SIGINFO;\n\tsigemptyset(&act.sa_mask);\n\n\tFAIL_IF(sigaction(SIGUSR1, &act, NULL));\n\n\tfor (i = 0; i < 2; i++) {\n\t\t \n\t\tsigreturn_addr = 0xcull << 60;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t \n\t\tsigreturn_addr = 0xc008ull << 48;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t \n\t\tsigreturn_addr = 0xc010ull << 48;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t \n\t\tsigreturn_addr = (0xcull << 60) - (64 * 1024);\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t\n\t\tsigreturn_addr = 0x1ull << 52;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t\n\t\tsigreturn_addr = 0xdull << 60;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t\n\t\tsigreturn_addr = 0xeull << 60;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t\n\t\tsigreturn_addr = 0xfull << 60;\n\t\tpid = fork_child();\n\t\texpect_segv(pid);\n\n\t\t\n\t\tsigreturn_msr_mask = ~MSR_PR;\n\t}\n\n\tprintf(\"All children killed as expected\\n\");\n\n\t\n\tsigreturn_addr = 0;\n\tsigreturn_msr_mask = ~MSR_PR;\n\tpid = fork_child();\n\twaitpid(pid, &child_ret, 0);\n\tFAIL_IF(!WIFEXITED(child_ret));\n\tFAIL_IF(WIFSIGNALED(child_ret));\n\tFAIL_IF(WEXITSTATUS(child_ret) != 0);\n\n\treturn 0;\n}\n\nint main(void)\n{\n\treturn test_harness(test_sigreturn_kernel, \"sigreturn_kernel\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}