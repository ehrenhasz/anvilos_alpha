{
  "module_name": "sig_sc_double_restart.c",
  "hash_id": "cf0c0b6d8672f6cb2f8b5caed05d2efd3611df149af7fca29956fa383d8b37df",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/signal/sig_sc_double_restart.c",
  "human_readable_source": "\n \n#define _GNU_SOURCE\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <sys/syscall.h>\n#include <unistd.h>\n#include <signal.h>\n#include <errno.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n\n#include \"utils.h\"\n\nstatic void SIGUSR1_handler(int sig)\n{\n\tkill(getpid(), SIGUSR2);\n\t \n}\n\nstatic void SIGUSR2_handler(int sig)\n{\n}\n\nstatic ssize_t raw_read(int fd, void *buf, size_t count)\n{\n\tregister long nr asm(\"r0\") = __NR_read;\n\tregister long _fd asm(\"r3\") = fd;\n\tregister void *_buf asm(\"r4\") = buf;\n\tregister size_t _count asm(\"r5\") = count;\n\n\tasm volatile(\n\"\t\tb\t0f\t\t\\n\"\n\"\t\tb\t1f\t\t\\n\"\n\"\t0:\tsc\t0\t\t\\n\"\n\"\t\tbns\t2f\t\t\\n\"\n\"\t\tneg\t%0,%0\t\t\\n\"\n\"\t\tb\t2f\t\t\\n\"\n\"\t1:\t\t\t\t\\n\"\n\"\t\tli\t%0,%4\t\t\\n\"\n\"\t2:\t\t\t\t\\n\"\n\t\t: \"+r\"(_fd), \"+r\"(nr), \"+r\"(_buf), \"+r\"(_count)\n\t\t: \"i\"(-ENOANO)\n\t\t: \"memory\", \"r6\", \"r7\", \"r8\", \"r9\", \"r10\", \"r11\", \"r12\", \"ctr\", \"cr0\");\n\n\tif (_fd < 0) {\n\t\terrno = -_fd;\n\t\t_fd = -1;\n\t}\n\n\treturn _fd;\n}\n\n#define DATA \"test 123\"\n#define DLEN (strlen(DATA)+1)\n\nint test_restart(void)\n{\n\tint pipefd[2];\n\tpid_t pid;\n\tchar buf[512];\n\n\tif (pipe(pipefd) == -1) {\n\t\tperror(\"pipe\");\n\t\texit(EXIT_FAILURE);\n\t}\n\n\tpid = fork();\n\tif (pid == -1) {\n\t\tperror(\"fork\");\n\t\texit(EXIT_FAILURE);\n\t}\n\n\tif (pid == 0) {  \n\t\tstruct sigaction act;\n\t\tint fd;\n\n\t\tmemset(&act, 0, sizeof(act));\n\t\tsigaddset(&act.sa_mask, SIGUSR2);\n\t\tact.sa_handler = SIGUSR1_handler;\n\t\tact.sa_flags = SA_RESTART;\n\t\tif (sigaction(SIGUSR1, &act, NULL) == -1) {\n\t\t\tperror(\"sigaction\");\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\n\t\tmemset(&act, 0, sizeof(act));\n\t\tact.sa_handler = SIGUSR2_handler;\n\t\tact.sa_flags = SA_RESTART;\n\t\tif (sigaction(SIGUSR2, &act, NULL) == -1) {\n\t\t\tperror(\"sigaction\");\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\n\t\t \n\t\twhile ((fd = dup(pipefd[0])) != 512) {\n\t\t\tif (fd == -1) {\n\t\t\t\tperror(\"dup\");\n\t\t\t\texit(EXIT_FAILURE);\n\t\t\t}\n\t\t}\n\n\t\tif (raw_read(fd, buf, 512) == -1) {\n\t\t\tif (errno == ENOANO) {\n\t\t\t\tfprintf(stderr, \"Double restart moved restart before sc instruction.\\n\");\n\t\t\t\t_exit(EXIT_FAILURE);\n\t\t\t}\n\t\t\tperror(\"read\");\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\n\t\tif (strncmp(buf, DATA, DLEN)) {\n\t\t\tfprintf(stderr, \"bad test string %s\\n\", buf);\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\n\t\treturn 0;\n\n\t} else {\n\t\tint wstatus;\n\n\t\tusleep(100000);\t\t \n\t\tkill(pid, SIGUSR1);\n\t\tusleep(100000);\n\t\tif (write(pipefd[1], DATA, DLEN) != DLEN) {\n\t\t\tperror(\"write\");\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\t\tclose(pipefd[0]);\n\t\tclose(pipefd[1]);\n\t\tif (wait(&wstatus) == -1) {\n\t\t\tperror(\"wait\");\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\t\tif (!WIFEXITED(wstatus)) {\n\t\t\tfprintf(stderr, \"child exited abnormally\\n\");\n\t\t\texit(EXIT_FAILURE);\n\t\t}\n\n\t\tFAIL_IF(WEXITSTATUS(wstatus) != EXIT_SUCCESS);\n\n\t\treturn 0;\n\t}\n}\n\nint main(void)\n{\n\ttest_harness_set_timeout(10);\n\treturn test_harness(test_restart, \"sig sys restart\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}