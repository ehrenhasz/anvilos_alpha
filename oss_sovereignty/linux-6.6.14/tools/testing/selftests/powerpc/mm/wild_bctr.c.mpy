{
  "module_name": "wild_bctr.c",
  "hash_id": "ebfd173c08ad743e0e0ed6144f5570128d2e4da9135079280138d882bad06a2d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/mm/wild_bctr.c",
  "human_readable_source": "\n \n\n#include <setjmp.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mman.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <ucontext.h>\n#include <unistd.h>\n\n#include \"utils.h\"\n\n\n#define BAD_NIP\t0x788c545a18000000ull\n\nstatic struct pt_regs signal_regs;\nstatic jmp_buf setjmp_env;\n\nstatic void save_regs(ucontext_t *ctxt)\n{\n\tstruct pt_regs *regs = ctxt->uc_mcontext.regs;\n\n\tmemcpy(&signal_regs, regs, sizeof(signal_regs));\n}\n\nstatic void segv_handler(int signum, siginfo_t *info, void *ctxt_v)\n{\n\tsave_regs(ctxt_v);\n\tlongjmp(setjmp_env, 1);\n}\n\nstatic void usr2_handler(int signum, siginfo_t *info, void *ctxt_v)\n{\n\tsave_regs(ctxt_v);\n}\n\nstatic int ok(void)\n{\n\tprintf(\"Everything is OK in here.\\n\");\n\treturn 0;\n}\n\n#define REG_POISON\t0x5a5a\n#define POISONED_REG(n)\t((((unsigned long)REG_POISON) << 48) | ((n) << 32) | \\\n\t\t\t (((unsigned long)REG_POISON) << 16) | (n))\n\nstatic inline void poison_regs(void)\n{\n\t#define POISON_REG(n)\t\\\n\t  \"lis  \" __stringify(n) \",\" __stringify(REG_POISON) \";\" \\\n\t  \"addi \" __stringify(n) \",\" __stringify(n) \",\" __stringify(n) \";\" \\\n\t  \"sldi \" __stringify(n) \",\" __stringify(n) \", 32 ;\" \\\n\t  \"oris \" __stringify(n) \",\" __stringify(n) \",\" __stringify(REG_POISON) \";\" \\\n\t  \"addi \" __stringify(n) \",\" __stringify(n) \",\" __stringify(n) \";\"\n\n\tasm (POISON_REG(15)\n\t     POISON_REG(16)\n\t     POISON_REG(17)\n\t     POISON_REG(18)\n\t     POISON_REG(19)\n\t     POISON_REG(20)\n\t     POISON_REG(21)\n\t     POISON_REG(22)\n\t     POISON_REG(23)\n\t     POISON_REG(24)\n\t     POISON_REG(25)\n\t     POISON_REG(26)\n\t     POISON_REG(27)\n\t     POISON_REG(28)\n\t     POISON_REG(29)\n\t     : \n\t     : \n\t     : \"15\", \"16\", \"17\", \"18\", \"19\", \"20\", \"21\", \"22\", \"23\", \"24\", \"25\",\n\t       \"26\", \"27\", \"28\", \"29\"\n\t);\n\t#undef POISON_REG\n}\n\nstatic int check_regs(void)\n{\n\tunsigned long i;\n\n\tfor (i = 15; i <= 29; i++)\n\t\tFAIL_IF(signal_regs.gpr[i] != POISONED_REG(i));\n\n\tprintf(\"Regs OK\\n\");\n\treturn 0;\n}\n\nstatic void dump_regs(void)\n{\n\tfor (int i = 0; i < 32; i += 4) {\n\t\tprintf(\"r%02d 0x%016lx  r%02d 0x%016lx  \" \\\n\t\t       \"r%02d 0x%016lx  r%02d 0x%016lx\\n\",\n\t\t       i, signal_regs.gpr[i],\n\t\t       i+1, signal_regs.gpr[i+1],\n\t\t       i+2, signal_regs.gpr[i+2],\n\t\t       i+3, signal_regs.gpr[i+3]);\n\t}\n}\n\n#ifdef _CALL_AIXDESC\nstruct opd {\n\tunsigned long ip;\n\tunsigned long toc;\n\tunsigned long env;\n};\nstatic struct opd bad_opd = {\n\t.ip = BAD_NIP,\n};\n#define BAD_FUNC (&bad_opd)\n#else\n#define BAD_FUNC BAD_NIP\n#endif\n\nint test_wild_bctr(void)\n{\n\tint (*func_ptr)(void);\n\tstruct sigaction segv = {\n\t\t.sa_sigaction = segv_handler,\n\t\t.sa_flags = SA_SIGINFO\n\t};\n\tstruct sigaction usr2 = {\n\t\t.sa_sigaction = usr2_handler,\n\t\t.sa_flags = SA_SIGINFO\n\t};\n\n\tFAIL_IF(sigaction(SIGSEGV, &segv, NULL));\n\tFAIL_IF(sigaction(SIGUSR2, &usr2, NULL));\n\n\tbzero(&signal_regs, sizeof(signal_regs));\n\n\tif (setjmp(setjmp_env) == 0) {\n\t\tfunc_ptr = ok;\n\t\tfunc_ptr();\n\n\t\tkill(getpid(), SIGUSR2);\n\t\tprintf(\"Regs before:\\n\");\n\t\tdump_regs();\n\t\tbzero(&signal_regs, sizeof(signal_regs));\n\n\t\tpoison_regs();\n\n\t\tfunc_ptr = (int (*)(void))BAD_FUNC;\n\t\tfunc_ptr();\n\n\t\tFAIL_IF(1);  \n\t}\n\n\tFAIL_IF(signal_regs.nip != BAD_NIP);\n\n\tprintf(\"All good - took SEGV as expected branching to 0x%llx\\n\", BAD_NIP);\n\n\tdump_regs();\n\tFAIL_IF(check_regs());\n\n\treturn 0;\n}\n\nint main(void)\n{\n\treturn test_harness(test_wild_bctr, \"wild_bctr\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}