{
  "module_name": "stack_expansion_ldst.c",
  "hash_id": "455f2fbfd64b330695cedb8f31c3bd9c99aecb498bd02a896ff47e356914ac88",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/mm/stack_expansion_ldst.c",
  "human_readable_source": "\n \n\n#undef NDEBUG\n#include <assert.h>\n\n#include <err.h>\n#include <errno.h>\n#include <stdio.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/resource.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n\n#define _KB (1024)\n#define _MB (1024 * 1024)\n\nvolatile char *stack_top_ptr;\nvolatile unsigned long stack_top_sp;\nvolatile char c;\n\nenum access_type {\n\tLOAD,\n\tSTORE,\n};\n\n \n__attribute__ ((noinline))\nint consume_stack(unsigned long target_sp, unsigned long stack_high, int delta, enum access_type type)\n{\n\tunsigned long target;\n\tchar stack_cur;\n\n\tif ((unsigned long)&stack_cur > target_sp)\n\t\treturn consume_stack(target_sp, stack_high, delta, type);\n\telse {\n\t\t\n\t\t\n\t\tstack_top_ptr = &stack_cur;\n\n#ifdef __powerpc__\n\t\tasm volatile (\"mr %[sp], %%r1\" : [sp] \"=r\" (stack_top_sp));\n#else\n\t\tasm volatile (\"mov %%rsp, %[sp]\" : [sp] \"=r\" (stack_top_sp));\n#endif\n\t\ttarget = stack_high - delta + 1;\n\t\tvolatile char *p = (char *)target;\n\n\t\tif (type == STORE)\n\t\t\t*p = c;\n\t\telse\n\t\t\tc = *p;\n\n\t\t\n\t\t\n\t\tgetpid();\n\t}\n\n\treturn 0;\n}\n\nstatic int search_proc_maps(char *needle, unsigned long *low, unsigned long *high)\n{\n\tunsigned long start, end;\n\tstatic char buf[4096];\n\tchar name[128];\n\tFILE *f;\n\tint rc;\n\n\tf = fopen(\"/proc/self/maps\", \"r\");\n\tif (!f) {\n\t\tperror(\"fopen\");\n\t\treturn -1;\n\t}\n\n\twhile (fgets(buf, sizeof(buf), f)) {\n\t\trc = sscanf(buf, \"%lx-%lx %*c%*c%*c%*c %*x %*d:%*d %*d %127s\\n\",\n\t\t\t    &start, &end, name);\n\t\tif (rc == 2)\n\t\t\tcontinue;\n\n\t\tif (rc != 3) {\n\t\t\tprintf(\"sscanf errored\\n\");\n\t\t\trc = -1;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (strstr(name, needle)) {\n\t\t\t*low = start;\n\t\t\t*high = end - 1;\n\t\t\trc = 0;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfclose(f);\n\n\treturn rc;\n}\n\nint child(unsigned int stack_used, int delta, enum access_type type)\n{\n\tunsigned long low, stack_high;\n\n\tassert(search_proc_maps(\"[stack]\", &low, &stack_high) == 0);\n\n\tassert(consume_stack(stack_high - stack_used, stack_high, delta, type) == 0);\n\n\tprintf(\"Access OK: %s delta %-7d used size 0x%06x stack high 0x%lx top_ptr %p top sp 0x%lx actual used 0x%lx\\n\",\n\t       type == LOAD ? \"load\" : \"store\", delta, stack_used, stack_high,\n\t       stack_top_ptr, stack_top_sp, stack_high - stack_top_sp + 1);\n\n\treturn 0;\n}\n\nstatic int test_one(unsigned int stack_used, int delta, enum access_type type)\n{\n\tpid_t pid;\n\tint rc;\n\n\tpid = fork();\n\tif (pid == 0)\n\t\texit(child(stack_used, delta, type));\n\n\tassert(waitpid(pid, &rc, 0) != -1);\n\n\tif (WIFEXITED(rc) && WEXITSTATUS(rc) == 0)\n\t\treturn 0;\n\n\t\n\tassert(!WIFEXITED(rc));\n\n\tprintf(\"Faulted:   %s delta %-7d used size 0x%06x signal %d\\n\",\n\t       type == LOAD ? \"load\" : \"store\", delta, stack_used,\n\t       WTERMSIG(rc));\n\n\treturn 1;\n}\n\n\n\n#define DEFAULT_SIZE\t(32 * _KB)\n\nstatic void test_one_type(enum access_type type, unsigned long page_size, unsigned long rlim_cur)\n{\n\tunsigned long delta;\n\n\t\n\tfor (delta = page_size; delta <= rlim_cur; delta += page_size)\n\t\tassert(test_one(DEFAULT_SIZE, delta, type) == 0);\n\n\tassert(test_one(DEFAULT_SIZE, rlim_cur, type) == 0);\n\n\t\n\tassert(test_one(DEFAULT_SIZE, rlim_cur + 1, type) != 0);\n}\n\nstatic int test(void)\n{\n\tunsigned long page_size;\n\tstruct rlimit rlimit;\n\n\tpage_size = getpagesize();\n\tgetrlimit(RLIMIT_STACK, &rlimit);\n\tprintf(\"Stack rlimit is 0x%lx\\n\", rlimit.rlim_cur);\n\n\tprintf(\"Testing loads ...\\n\");\n\ttest_one_type(LOAD, page_size, rlimit.rlim_cur);\n\tprintf(\"Testing stores ...\\n\");\n\ttest_one_type(STORE, page_size, rlimit.rlim_cur);\n\n\tprintf(\"All OK\\n\");\n\n\treturn 0;\n}\n\n#ifdef __powerpc__\n#include \"utils.h\"\n\nint main(void)\n{\n\treturn test_harness(test, \"stack_expansion_ldst\");\n}\n#else\nint main(void)\n{\n\treturn test();\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}