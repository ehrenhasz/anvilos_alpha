{
  "module_name": "stack_expansion_signal.c",
  "hash_id": "5f34637b246514b49cf73beaf3005d6dfe9f3d3d49a28fb53a7f1c9be0bf03cc",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/mm/stack_expansion_signal.c",
  "human_readable_source": "\n \n\n#include <err.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <signal.h>\n#include <sys/types.h>\n#include <unistd.h>\n\n#include \"../pmu/lib.h\"\n#include \"utils.h\"\n\n#define _KB (1024)\n#define _MB (1024 * 1024)\n\nstatic char *stack_base_ptr;\nstatic char *stack_top_ptr;\n\nstatic volatile sig_atomic_t sig_occurred = 0;\n\nstatic void sigusr1_handler(int signal_arg)\n{\n\tsig_occurred = 1;\n}\n\nstatic int consume_stack(unsigned int stack_size, union pipe write_pipe)\n{\n\tchar stack_cur;\n\n\tif ((stack_base_ptr - &stack_cur) < stack_size)\n\t\treturn consume_stack(stack_size, write_pipe);\n\telse {\n\t\tstack_top_ptr = &stack_cur;\n\n\t\tFAIL_IF(notify_parent(write_pipe));\n\n\t\twhile (!sig_occurred)\n\t\t\tbarrier();\n\t}\n\n\treturn 0;\n}\n\nstatic int child(unsigned int stack_size, union pipe write_pipe)\n{\n\tstruct sigaction act;\n\tchar stack_base;\n\n\tact.sa_handler = sigusr1_handler;\n\tsigemptyset(&act.sa_mask);\n\tact.sa_flags = 0;\n\tif (sigaction(SIGUSR1, &act, NULL) < 0)\n\t\terr(1, \"sigaction\");\n\n\tstack_base_ptr = (char *) (((size_t) &stack_base + 65535) & ~65535UL);\n\n\tFAIL_IF(consume_stack(stack_size, write_pipe));\n\n\tprintf(\"size 0x%06x: OK, stack base %p top %p (%zx used)\\n\",\n\t\tstack_size, stack_base_ptr, stack_top_ptr,\n\t\tstack_base_ptr - stack_top_ptr);\n\n\treturn 0;\n}\n\nstatic int test_one_size(unsigned int stack_size)\n{\n\tunion pipe read_pipe, write_pipe;\n\tpid_t pid;\n\n\tFAIL_IF(pipe(read_pipe.fds) == -1);\n\tFAIL_IF(pipe(write_pipe.fds) == -1);\n\n\tpid = fork();\n\tif (pid == 0) {\n\t\tclose(read_pipe.read_fd);\n\t\tclose(write_pipe.write_fd);\n\t\texit(child(stack_size, read_pipe));\n\t}\n\n\tclose(read_pipe.write_fd);\n\tclose(write_pipe.read_fd);\n\tFAIL_IF(sync_with_child(read_pipe, write_pipe));\n\n\tkill(pid, SIGUSR1);\n\n\tFAIL_IF(wait_for_child(pid));\n\n\tclose(read_pipe.read_fd);\n\tclose(write_pipe.write_fd);\n\n\treturn 0;\n}\n\nint test(void)\n{\n\tunsigned int i, size;\n\n\t\n\t\n\tfor (i = 0; i < (128 * _KB); i += 64) {\n\t\tsize = i + (1 * _MB) - (64 * _KB);\n\t\tFAIL_IF(test_one_size(size));\n\t}\n\n\treturn 0;\n}\n\nint main(void)\n{\n\treturn test_harness(test, \"stack_expansion_signal\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}