{
  "module_name": "cycles_with_freeze_test.c",
  "hash_id": "7128e68842afc8b68082bcca3bc800b0709b6f477c63d22f72ffb9a36f64b5b2",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/pmu/ebb/cycles_with_freeze_test.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdbool.h>\n\n#include \"ebb.h\"\n\n\n \n\nstatic bool counters_frozen = false;\nstatic int ebbs_while_frozen = 0;\n\nstatic void ebb_callee(void)\n{\n\tuint64_t mask, val;\n\n\tmask = MMCR0_PMAO | MMCR0_FC;\n\n\tval = mfspr(SPRN_BESCR);\n\tif (!(val & BESCR_PMEO)) {\n\t\tebb_state.stats.spurious++;\n\t\tgoto out;\n\t}\n\n\tebb_state.stats.ebb_count++;\n\ttrace_log_counter(ebb_state.trace, ebb_state.stats.ebb_count);\n\n\tval = mfspr(SPRN_MMCR0);\n\ttrace_log_reg(ebb_state.trace, SPRN_MMCR0, val);\n\n\tif (counters_frozen) {\n\t\ttrace_log_string(ebb_state.trace, \"frozen\");\n\t\tebbs_while_frozen++;\n\t\tmask &= ~MMCR0_FC;\n\t}\n\n\tcount_pmc(1, sample_period);\nout:\n\treset_ebb_with_clear_mask(mask);\n}\n\nint cycles_with_freeze(void)\n{\n\tstruct event event;\n\tuint64_t val;\n\tbool fc_cleared;\n\n\tSKIP_IF(!ebb_is_supported());\n\n\tevent_init_named(&event, 0x1001e, \"cycles\");\n\tevent_leader_ebb_init(&event);\n\n\tevent.attr.exclude_kernel = 1;\n\tevent.attr.exclude_hv = 1;\n\tevent.attr.exclude_idle = 1;\n\n\tFAIL_IF(event_open(&event));\n\n\tsetup_ebb_handler(ebb_callee);\n\tebb_global_enable();\n\tFAIL_IF(ebb_event_enable(&event));\n\n\tmtspr(SPRN_PMC1, pmc_sample_period(sample_period));\n\n\tfc_cleared = false;\n\n\t \n\twhile ((ebb_state.stats.ebb_count < 20 && !fc_cleared) ||\n\t\tebb_state.stats.ebb_count < 1)\n\t{\n\t\tcounters_frozen = false;\n\t\tmb();\n\t\tmtspr(SPRN_MMCR0, mfspr(SPRN_MMCR0) & ~MMCR0_FC);\n\n\t\tFAIL_IF(core_busy_loop());\n\n\t\tcounters_frozen = true;\n\t\tmb();\n\t\tmtspr(SPRN_MMCR0, mfspr(SPRN_MMCR0) |  MMCR0_FC);\n\n\t\tval = mfspr(SPRN_MMCR0);\n\t\tif (! (val & MMCR0_FC)) {\n\t\t\tprintf(\"Outside of loop, FC NOT set MMCR0 0x%lx\\n\", val);\n\t\t\tfc_cleared = true;\n\t\t}\n\t}\n\n\tebb_global_disable();\n\tebb_freeze_pmcs();\n\n\tdump_ebb_state();\n\n\tprintf(\"EBBs while frozen %d\\n\", ebbs_while_frozen);\n\n\tevent_close(&event);\n\n\tFAIL_IF(ebb_state.stats.ebb_count == 0);\n\tFAIL_IF(fc_cleared);\n\n\treturn 0;\n}\n\nint main(void)\n{\n\treturn test_harness(cycles_with_freeze, \"cycles_with_freeze\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}