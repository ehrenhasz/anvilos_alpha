{
  "module_name": "harness.c",
  "hash_id": "d5a1d3c0faaa6f464582071e3ca0d15a63fca4d4b84a989490c5ab476c371d1d",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/harness.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <signal.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n#include <elf.h>\n#include <fcntl.h>\n#include <link.h>\n#include <sys/stat.h>\n\n#include \"subunit.h\"\n#include \"utils.h\"\n\n#define KILL_TIMEOUT\t5\n\n \nstatic uint64_t timeout = 120;\n\nint run_test(int (test_function)(void), const char *name)\n{\n\tbool terminated;\n\tint rc, status;\n\tpid_t pid;\n\n\t \n\tfflush(stdout);\n\n\tpid = fork();\n\tif (pid == 0) {\n\t\tsetpgid(0, 0);\n\t\texit(test_function());\n\t} else if (pid == -1) {\n\t\tperror(\"fork\");\n\t\treturn 1;\n\t}\n\n\tsetpgid(pid, pid);\n\n\tif (timeout != -1)\n\t\t \n\t\talarm(timeout);\n\tterminated = false;\n\nwait:\n\trc = waitpid(pid, &status, 0);\n\tif (rc == -1) {\n\t\tif (errno != EINTR) {\n\t\t\tprintf(\"unknown error from waitpid\\n\");\n\t\t\treturn 1;\n\t\t}\n\n\t\tif (terminated) {\n\t\t\tprintf(\"!! force killing %s\\n\", name);\n\t\t\tkill(-pid, SIGKILL);\n\t\t\treturn 1;\n\t\t} else {\n\t\t\tprintf(\"!! killing %s\\n\", name);\n\t\t\tkill(-pid, SIGTERM);\n\t\t\tterminated = true;\n\t\t\talarm(KILL_TIMEOUT);\n\t\t\tgoto wait;\n\t\t}\n\t}\n\n\t \n\tkill(-pid, SIGTERM);\n\n\tif (WIFEXITED(status))\n\t\tstatus = WEXITSTATUS(status);\n\telse {\n\t\tif (WIFSIGNALED(status))\n\t\t\tprintf(\"!! child died by signal %d\\n\", WTERMSIG(status));\n\t\telse\n\t\t\tprintf(\"!! child died by unknown cause\\n\");\n\n\t\tstatus = 1;  \n\t}\n\n\treturn status;\n}\n\nstatic void sig_handler(int signum)\n{\n\t \n}\n\nstatic struct sigaction sig_action = {\n\t.sa_handler = sig_handler,\n};\n\nvoid test_harness_set_timeout(uint64_t time)\n{\n\ttimeout = time;\n}\n\nint test_harness(int (test_function)(void), const char *name)\n{\n\tint rc;\n\n\ttest_start(name);\n\ttest_set_git_version(GIT_VERSION);\n\n\tif (sigaction(SIGINT, &sig_action, NULL)) {\n\t\tperror(\"sigaction (sigint)\");\n\t\ttest_error(name);\n\t\treturn 1;\n\t}\n\n\tif (sigaction(SIGALRM, &sig_action, NULL)) {\n\t\tperror(\"sigaction (sigalrm)\");\n\t\ttest_error(name);\n\t\treturn 1;\n\t}\n\n\trc = run_test(test_function, name);\n\n\tif (rc == MAGIC_SKIP_RETURN_VALUE) {\n\t\ttest_skip(name);\n\t\t \n\t\trc = 0;\n\t} else\n\t\ttest_finish(name, rc);\n\n\treturn rc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}