{
  "module_name": "pkeys.h",
  "hash_id": "d19cb5953a88f1cd5f20af5264d72a57134c25773b039e2e100fe1567f464dd7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/include/pkeys.h",
  "human_readable_source": " \n \n\n#ifndef _SELFTESTS_POWERPC_PKEYS_H\n#define _SELFTESTS_POWERPC_PKEYS_H\n\n#include <sys/mman.h>\n\n#include \"reg.h\"\n#include \"utils.h\"\n\n \n#undef PKEY_DISABLE_ACCESS\n#define PKEY_DISABLE_ACCESS\t0x3\n\n#undef PKEY_DISABLE_WRITE\n#define PKEY_DISABLE_WRITE\t0x2\n\n#undef PKEY_DISABLE_EXECUTE\n#define PKEY_DISABLE_EXECUTE\t0x4\n\n \n#ifndef SEGV_PKUERR\n#define SEGV_PKUERR\t4\n#endif\n\n#define SI_PKEY_OFFSET\t0x20\n\n#define __NR_pkey_mprotect\t386\n#define __NR_pkey_alloc\t\t384\n#define __NR_pkey_free\t\t385\n\n#define PKEY_BITS_PER_PKEY\t2\n#define NR_PKEYS\t\t32\n#define PKEY_BITS_MASK\t\t((1UL << PKEY_BITS_PER_PKEY) - 1)\n\ninline unsigned long pkeyreg_get(void)\n{\n\treturn mfspr(SPRN_AMR);\n}\n\ninline void pkeyreg_set(unsigned long amr)\n{\n\tset_amr(amr);\n}\n\nvoid pkey_set_rights(int pkey, unsigned long rights)\n{\n\tunsigned long amr, shift;\n\n\tshift = (NR_PKEYS - pkey - 1) * PKEY_BITS_PER_PKEY;\n\tamr = pkeyreg_get();\n\tamr &= ~(PKEY_BITS_MASK << shift);\n\tamr |= (rights & PKEY_BITS_MASK) << shift;\n\tpkeyreg_set(amr);\n}\n\nint sys_pkey_mprotect(void *addr, size_t len, int prot, int pkey)\n{\n\treturn syscall(__NR_pkey_mprotect, addr, len, prot, pkey);\n}\n\nint sys_pkey_alloc(unsigned long flags, unsigned long rights)\n{\n\treturn syscall(__NR_pkey_alloc, flags, rights);\n}\n\nint sys_pkey_free(int pkey)\n{\n\treturn syscall(__NR_pkey_free, pkey);\n}\n\nint pkeys_unsupported(void)\n{\n\tbool hash_mmu = false;\n\tint pkey;\n\n\t \n\tFAIL_IF(using_hash_mmu(&hash_mmu));\n\tSKIP_IF(!hash_mmu);\n\n\t \n\tpkey = sys_pkey_alloc(0, 0);\n\tSKIP_IF(pkey < 0);\n\tsys_pkey_free(pkey);\n\n\treturn 0;\n}\n\nint siginfo_pkey(siginfo_t *si)\n{\n\t \n#ifdef si_pkey\n\treturn si->si_pkey;\n#else\n\treturn *((int *)(((char *) si) + SI_PKEY_OFFSET));\n#endif\n}\n\n#define pkey_rights(r) ({\t\t\t\t\t\t\\\n\tstatic char buf[4] = \"rwx\";\t\t\t\t\t\\\n\tunsigned int amr_bits;\t\t\t\t\t\t\\\n\tif ((r) & PKEY_DISABLE_EXECUTE)\t\t\t\t\t\\\n\t\tbuf[2] = '-';\t\t\t\t\t\t\\\n\tamr_bits = (r) & PKEY_BITS_MASK;\t\t\t\t\\\n\tif (amr_bits & PKEY_DISABLE_WRITE)\t\t\t\t\\\n\t\tbuf[1] = '-';\t\t\t\t\t\t\\\n\tif (amr_bits & PKEY_DISABLE_ACCESS & ~PKEY_DISABLE_WRITE)\t\\\n\t\tbuf[0] = '-';\t\t\t\t\t\t\\\n\tbuf;\t\t\t\t\t\t\t\t\\\n})\n\nunsigned long next_pkey_rights(unsigned long rights)\n{\n\tif (rights == PKEY_DISABLE_ACCESS)\n\t\treturn PKEY_DISABLE_EXECUTE;\n\telse if (rights == (PKEY_DISABLE_ACCESS | PKEY_DISABLE_EXECUTE))\n\t\treturn 0;\n\n\tif ((rights & PKEY_BITS_MASK) == 0)\n\t\trights |= PKEY_DISABLE_WRITE;\n\telse if ((rights & PKEY_BITS_MASK) == PKEY_DISABLE_WRITE)\n\t\trights |= PKEY_DISABLE_ACCESS;\n\n\treturn rights;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}