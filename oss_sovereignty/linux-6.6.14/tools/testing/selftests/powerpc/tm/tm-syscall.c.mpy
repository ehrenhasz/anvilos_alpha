{
  "module_name": "tm-syscall.c",
  "hash_id": "026678e47be11ca40055d19fe18c6bda3821bf020d539cd7c7e2e1d07ebc7337",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/tm/tm-syscall.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/syscall.h>\n#include <asm/tm.h>\n#include <sys/time.h>\n#include <stdlib.h>\n\n#include \"utils.h\"\n#include \"tm.h\"\n\n#ifndef PPC_FEATURE2_SCV\n#define PPC_FEATURE2_SCV               0x00100000  \n#endif\n\nextern int getppid_tm_active(void);\nextern int getppid_tm_suspended(void);\nextern int getppid_scv_tm_active(void);\nextern int getppid_scv_tm_suspended(void);\n\nunsigned retries = 0;\n\n#define TEST_DURATION 10  \n\npid_t getppid_tm(bool scv, bool suspend)\n{\n\tint i;\n\tpid_t pid;\n\n\tfor (i = 0; i < TM_RETRIES; i++) {\n\t\tif (suspend) {\n\t\t\tif (scv)\n\t\t\t\tpid = getppid_scv_tm_suspended();\n\t\t\telse\n\t\t\t\tpid = getppid_tm_suspended();\n\t\t} else {\n\t\t\tif (scv)\n\t\t\t\tpid = getppid_scv_tm_active();\n\t\t\telse\n\t\t\t\tpid = getppid_tm_active();\n\t\t}\n\n\t\tif (pid >= 0)\n\t\t\treturn pid;\n\n\t\tif (failure_is_persistent()) {\n\t\t\tif (failure_is_syscall())\n\t\t\t\treturn -1;\n\n\t\t\tprintf(\"Unexpected persistent transaction failure.\\n\");\n\t\t\tprintf(\"TEXASR 0x%016lx, TFIAR 0x%016lx.\\n\",\n\t\t\t       __builtin_get_texasr(), __builtin_get_tfiar());\n\t\t\texit(-1);\n\t\t}\n\n\t\tretries++;\n\t}\n\n\tprintf(\"Exceeded limit of %d temporary transaction failures.\\n\", TM_RETRIES);\n\tprintf(\"TEXASR 0x%016lx, TFIAR 0x%016lx.\\n\",\n\t       __builtin_get_texasr(), __builtin_get_tfiar());\n\n\texit(-1);\n}\n\nint tm_syscall(void)\n{\n\tunsigned count = 0;\n\tstruct timeval end, now;\n\n\tSKIP_IF(!have_htm_nosc());\n\tSKIP_IF(htm_is_synthetic());\n\n\tsetbuf(stdout, NULL);\n\n\tprintf(\"Testing transactional syscalls for %d seconds...\\n\", TEST_DURATION);\n\n\tgettimeofday(&end, NULL);\n\tnow.tv_sec = TEST_DURATION;\n\tnow.tv_usec = 0;\n\ttimeradd(&end, &now, &end);\n\n\tfor (count = 0; timercmp(&now, &end, <); count++) {\n\t\t \n\t\tFAIL_IF(getppid_tm(false, true) == -1);  \n\n\t\t \n\t\tFAIL_IF(getppid_tm(false, false) != -1);   \n\t\tFAIL_IF(!failure_is_persistent());  \n\t\tFAIL_IF(!failure_is_syscall());     \n\n\t\t \n\t\tif (have_hwcap2(PPC_FEATURE2_SCV)) {\n\t\t\tFAIL_IF(getppid_tm(true, true) == -1);  \n\t\t\tFAIL_IF(getppid_tm(true, false) != -1);   \n\t\t\tFAIL_IF(!failure_is_persistent());  \n\t\t\tFAIL_IF(!failure_is_syscall());     \n\t\t}\n\n\t\tgettimeofday(&now, 0);\n\t}\n\n\tprintf(\"%d active and suspended transactions behaved correctly.\\n\", count);\n\tprintf(\"(There were %d transaction retries.)\\n\", retries);\n\n\treturn 0;\n}\n\nint main(void)\n{\n\treturn test_harness(tm_syscall, \"tm_syscall\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}