{
  "module_name": "tm-trap.c",
  "hash_id": "85de520e239b2150cf17608cb1f2757fe70c6463d2361e9404721f12c5dc8592",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/tm/tm-trap.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <error.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <htmintrin.h>\n#include <inttypes.h>\n#include <pthread.h>\n#include <sched.h>\n#include <signal.h>\n#include <stdbool.h>\n\n#include \"tm.h\"\n#include \"utils.h\"\n\n#define pr_error(error_code, format, ...) \\\n\terror_at_line(1, error_code, __FILE__, __LINE__, format, ##__VA_ARGS__)\n\n#define MSR_LE 1UL\n#define LE     1UL\n\npthread_t t0_ping;\npthread_t t1_pong;\n\nint exit_from_pong;\n\nint trap_event;\nint le;\n\nbool success;\n\nvoid trap_signal_handler(int signo, siginfo_t *si, void *uc)\n{\n\tucontext_t *ucp = uc;\n\tuint64_t thread_endianness;\n\n\t \n\tthread_endianness = MSR_LE & ucp->uc_mcontext.gp_regs[PT_MSR];\n\n\t \n\n\tif (le) {\n\t\t \n\t\tif (trap_event == 0) {\n\t\t\t \n\t\t}\n\t\t \n\t\telse if (trap_event == 1) {\n\t\t\t \n\n\t\t\tif (thread_endianness == LE) {\n\t\t\t\t \n\t\t\t\tucp->uc_mcontext.gp_regs[PT_NIP] += 16;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tucp->uc_mcontext.gp_regs[PT_MSR] |= 1UL;\n\t\t\t\tucp->uc_mcontext.gp_regs[PT_NIP] += 4;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\n\telse {\n\t\t \n\t\tif (trap_event == 0) {\n\t\t\t \n\t\t\tucp->uc_mcontext.gp_regs[PT_MSR] |= 1UL;\n\t\t}\n\t\t \n\t\telse if (trap_event == 1) {\n\t\t\t \n\t\t}\n\t\t \n\t\telse {\n\t\t\t \n\n\t\t\t \n\t\t\tucp->uc_mcontext.gp_regs[PT_MSR] &= ~1UL;\n\t\t\tucp->uc_mcontext.gp_regs[PT_NIP] += 8;\n\t\t}\n\t}\n\n\ttrap_event++;\n}\n\nvoid usr1_signal_handler(int signo, siginfo_t *si, void *not_used)\n{\n\t \n\texit_from_pong = 1;\n}\n\nvoid *ping(void *not_used)\n{\n\tuint64_t i;\n\n\ttrap_event = 0;\n\n\t \n\tfor (i = 0; i < 1024*1024*512; i++)\n\t\t;\n\n\tasm goto(\n\t\t \n\n\t\t\" tbegin.        ;\"  \n\t\t\" tdi  0, 0, 0x48;\"  \n\t\t\" trap           ;\"  \n\t\t\".long 0x1D05007C;\"  \n\t\t\".long 0x0800E07F;\"  \n\t\t\" b %l[failure]  ;\"  \n\t\t\" b %l[success]  ;\"  \n\n\t\t: : : : failure, success);\n\nfailure:\n\tsuccess = false;\n\tgoto exit_from_ping;\n\nsuccess:\n\tsuccess = true;\n\nexit_from_ping:\n\t \n\tpthread_kill(t1_pong, SIGUSR1);\n\treturn NULL;\n}\n\nvoid *pong(void *not_used)\n{\n\twhile (!exit_from_pong)\n\t\t \n\t\tsched_yield();\n\n\treturn NULL;\n}\n\nint tm_trap_test(void)\n{\n\tuint16_t k = 1;\n\tint cpu, rc;\n\n\tpthread_attr_t attr;\n\tcpu_set_t cpuset;\n\n\tstruct sigaction trap_sa;\n\n\tSKIP_IF(!have_htm());\n\tSKIP_IF(htm_is_synthetic());\n\n\ttrap_sa.sa_flags = SA_SIGINFO;\n\ttrap_sa.sa_sigaction = trap_signal_handler;\n\tsigaction(SIGTRAP, &trap_sa, NULL);\n\n\tstruct sigaction usr1_sa;\n\n\tusr1_sa.sa_flags = SA_SIGINFO;\n\tusr1_sa.sa_sigaction = usr1_signal_handler;\n\tsigaction(SIGUSR1, &usr1_sa, NULL);\n\n\tcpu = pick_online_cpu();\n\tFAIL_IF(cpu < 0);\n\n\t\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(cpu, &cpuset);\n\n\t \n\trc = pthread_attr_init(&attr);\n\tif (rc)\n\t\tpr_error(rc, \"pthread_attr_init()\");\n\n\t \n\trc = pthread_attr_setaffinity_np(&attr, sizeof(cpu_set_t), &cpuset);\n\tif (rc)\n\t\tpr_error(rc, \"pthread_attr_setaffinity()\");\n\n\t \n\tle = (int) *(uint8_t *)&k;\n\n\tprintf(\"%s machine detected. Checking if endianness flips %s\",\n\t\tle ? \"Little-Endian\" : \"Big-Endian\",\n\t\t\"inadvertently on trap in TM... \");\n\n\trc = fflush(0);\n\tif (rc)\n\t\tpr_error(rc, \"fflush()\");\n\n\t \n\trc = pthread_create(&t0_ping, &attr, ping, NULL);\n\tif (rc)\n\t\tpr_error(rc, \"pthread_create()\");\n\n\texit_from_pong = 0;\n\n\t \n\trc = pthread_create(&t1_pong, &attr, pong, NULL);\n\tif (rc)\n\t\tpr_error(rc, \"pthread_create()\");\n\n\trc = pthread_join(t0_ping, NULL);\n\tif (rc)\n\t\tpr_error(rc, \"pthread_join()\");\n\n\trc = pthread_join(t1_pong, NULL);\n\tif (rc)\n\t\tpr_error(rc, \"pthread_join()\");\n\n\tif (success) {\n\t\tprintf(\"no.\\n\");  \n\t\treturn EXIT_SUCCESS;\n\t}\n\n\tprintf(\"yes!\\n\");  \n\treturn EXIT_FAILURE;\n}\n\nint main(int argc, char **argv)\n{\n\treturn test_harness(tm_trap_test, \"tm_trap_test\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}