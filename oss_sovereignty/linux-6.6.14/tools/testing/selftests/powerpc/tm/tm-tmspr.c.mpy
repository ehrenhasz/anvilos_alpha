{
  "module_name": "tm-tmspr.c",
  "hash_id": "994aea9dc55be3e58fac89039de66bd3e3d19c24e726a42c41e4aae84e813812",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/tm/tm-tmspr.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <pthread.h>\n#include <string.h>\n\n#include \"utils.h\"\n#include \"tm.h\"\n\nint\tnum_loops\t= 1000000;\nint\tpassed = 1;\n\nvoid tfiar_tfhar(void *in)\n{\n\tunsigned long tfhar, tfhar_rd, tfiar, tfiar_rd;\n\tint i;\n\n\t \n\ttfiar = ((unsigned long)in) + 1;\n\ttfiar += 2;\n\tmtspr(SPRN_TFIAR, tfiar);\n\n\t \n\ttfhar = ((unsigned long)in);\n\ttfhar &= ~0x3UL;\n\ttfhar += 4;\n\tmtspr(SPRN_TFHAR, tfhar);\n\n\tfor (i = 0; i < num_loops; i++)\t{\n\t\ttfhar_rd = mfspr(SPRN_TFHAR);\n\t\ttfiar_rd = mfspr(SPRN_TFIAR);\n\t\tif ( (tfhar != tfhar_rd) || (tfiar != tfiar_rd) ) {\n\t\t\tpassed = 0;\n\t\t\treturn;\n\t\t}\n\t}\n\treturn;\n}\n\nvoid texasr(void *in)\n{\n\tunsigned long i;\n\tuint64_t result = 0;\n\n\tfor (i = 0; i < num_loops; i++) {\n\t\tasm __volatile__(\n\t\t\t\"tbegin.;\"\n\t\t\t\"beq    3f ;\"\n\t\t\t\"tabort. 0 ;\"\n\t\t\t\"tend.;\"\n\n\t\t\t \n\t\t\t\"3: ;\"\n\t\t\t::: \"memory\");\n\n                 \n                result = mfspr(SPRN_TEXASR);\n\t\tif ((result & TEXASR_FS) == 0) {\n\t\t\tpassed = 0;\n\t\t\treturn;\n\t\t}\n\t}\n\treturn;\n}\n\nint test_tmspr()\n{\n\tpthread_t\t*thread;\n\tint\t   \tthread_num;\n\tunsigned long\ti;\n\n\tSKIP_IF(!have_htm());\n\tSKIP_IF(htm_is_synthetic());\n\n\t \n\tthread_num = 10 * sysconf(_SC_NPROCESSORS_ONLN);\n\n\tthread = malloc(thread_num * sizeof(pthread_t));\n\tif (thread == NULL)\n\t\treturn EXIT_FAILURE;\n\n\t \n\tfor (i = 0; i < thread_num; i += 2) {\n\t\tif (pthread_create(&thread[i], NULL, (void *)tfiar_tfhar,\n\t\t\t\t   (void *)i))\n\t\t\treturn EXIT_FAILURE;\n\t}\n\t \n\tfor (i = 1; i < thread_num; i += 2) {\n\t\tif (pthread_create(&thread[i], NULL, (void *)texasr, (void *)i))\n\t\t\treturn EXIT_FAILURE;\n\t}\n\n\tfor (i = 0; i < thread_num; i++) {\n\t\tif (pthread_join(thread[i], NULL) != 0)\n\t\t\treturn EXIT_FAILURE;\n\t}\n\n\tfree(thread);\n\n\tif (passed)\n\t\treturn 0;\n\telse\n\t\treturn 1;\n}\n\nint main(int argc, char *argv[])\n{\n\tif (argc > 1) {\n\t\tif (strcmp(argv[1], \"-h\") == 0) {\n\t\t\tprintf(\"Syntax:\\t [<num loops>]\\n\");\n\t\t\treturn 0;\n\t\t} else {\n\t\t\tnum_loops = atoi(argv[1]);\n\t\t}\n\t}\n\treturn test_harness(test_tmspr, \"tm_tmspr\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}