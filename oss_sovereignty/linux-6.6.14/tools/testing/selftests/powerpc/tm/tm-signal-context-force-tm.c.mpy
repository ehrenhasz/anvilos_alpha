{
  "module_name": "tm-signal-context-force-tm.c",
  "hash_id": "0836cc445376a018e9e13fc68c8f4ec13dec02de4a0973ed28000b3fe45007af",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/tm/tm-signal-context-force-tm.c",
  "human_readable_source": "\n \n\n#define _GNU_SOURCE\n#include <stdio.h>\n#include <stdlib.h>\n#include <signal.h>\n#include <string.h>\n#include <ucontext.h>\n#include <unistd.h>\n#include <sys/mman.h>\n\n#include \"tm.h\"\n#include \"utils.h\"\n#include \"reg.h\"\n\n#define COUNT_MAX       5000\t\t \n\n \n#ifndef __powerpc64__\n#undef  MSR_TS_S\n#define MSR_TS_S\t0\n#endif\n\n \nucontext_t init_context;\n\n \nstatic volatile int count;\n\nvoid usr_signal_handler(int signo, siginfo_t *si, void *uc)\n{\n\tucontext_t *ucp = uc;\n\tint ret;\n\n\t \n\tucp->uc_link = mmap(NULL, sizeof(ucontext_t),\n\t\t\t    PROT_READ | PROT_WRITE,\n\t\t\t    MAP_PRIVATE | MAP_ANONYMOUS, 0, 0);\n\tif (ucp->uc_link == (void *)-1) {\n\t\tperror(\"Mmap failed\");\n\t\texit(-1);\n\t}\n\n\t \n\tret = madvise(ucp->uc_link, sizeof(ucontext_t), MADV_DONTNEED);\n\tif (ret) {\n\t\tperror(\"madvise failed\");\n\t\texit(-1);\n\t}\n\n\tmemcpy(&ucp->uc_link->uc_mcontext, &ucp->uc_mcontext,\n\t\tsizeof(ucp->uc_mcontext));\n\n\t \n\tUCONTEXT_MSR(ucp) |= MSR_TS_S;\n\n\t \n\tif (fork() == 0) {\n\t\t \n\t\tcount = COUNT_MAX;\n\t}\n\n\t \n}\n\nvoid seg_signal_handler(int signo, siginfo_t *si, void *uc)\n{\n\tcount++;\n\n\t \n\tsetcontext(&init_context);\n}\n\nvoid tm_trap_test(void)\n{\n\tstruct sigaction usr_sa, seg_sa;\n\tstack_t ss;\n\n\tusr_sa.sa_flags = SA_SIGINFO | SA_ONSTACK;\n\tusr_sa.sa_sigaction = usr_signal_handler;\n\n\tseg_sa.sa_flags = SA_SIGINFO;\n\tseg_sa.sa_sigaction = seg_signal_handler;\n\n\t \n\tgetcontext(&init_context);\n\n\twhile (count < COUNT_MAX) {\n\t\t \n\t\tss.ss_sp = mmap(NULL, SIGSTKSZ, PROT_READ | PROT_WRITE,\n\t\t\t\tMAP_PRIVATE | MAP_ANONYMOUS, 0, 0);\n\t\tss.ss_size = SIGSTKSZ;\n\t\tss.ss_flags = 0;\n\n\t\tif (ss.ss_sp == (void *)-1) {\n\t\t\tperror(\"mmap error\\n\");\n\t\t\texit(-1);\n\t\t}\n\n\t\t \n\t\tif (madvise(ss.ss_sp, SIGSTKSZ, MADV_DONTNEED)) {\n\t\t\tperror(\"madvise\\n\");\n\t\t\texit(-1);\n\t\t}\n\n\t\t \n\t\tif (sigaltstack(&ss, NULL)) {\n\t\t\tperror(\"sigaltstack\\n\");\n\t\t\texit(-1);\n\t\t}\n\n\t\t \n\t\tsigaction(SIGUSR1, &usr_sa, NULL);\n\t\t \n\t\tsigaction(SIGSEGV, &seg_sa, NULL);\n\n\t\traise(SIGUSR1);\n\t\tcount++;\n\t}\n}\n\nint tm_signal_context_force_tm(void)\n{\n\tSKIP_IF(!have_htm());\n\t \n\tSKIP_IF(!is_ppc64le());\n\n\ttm_trap_test();\n\n\treturn EXIT_SUCCESS;\n}\n\nint main(int argc, char **argv)\n{\n\ttest_harness(tm_signal_context_force_tm, \"tm_signal_context_force_tm\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}