{
  "module_name": "uaccess_flush.c",
  "hash_id": "4f19be020bd2a5b7bc006177a02888d8931787f16974de8d9a1ca6ade979a848",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/security/uaccess_flush.c",
  "human_readable_source": "\n\n \n\n#define __SANE_USERSPACE_TYPES__\n\n#include <sys/types.h>\n#include <stdint.h>\n#include <malloc.h>\n#include <unistd.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <string.h>\n#include <stdio.h>\n#include \"utils.h\"\n#include \"flush_utils.h\"\n\nint uaccess_flush_test(void)\n{\n\tchar *p;\n\tint repetitions = 10;\n\tint fd, passes = 0, iter, rc = 0;\n\tstruct perf_event_read v;\n\t__u64 l1d_misses_total = 0;\n\tunsigned long iterations = 100000, zero_size = 24 * 1024;\n\tunsigned long l1d_misses_expected;\n\tint rfi_flush_orig;\n\tint entry_flush_orig;\n\tint uaccess_flush, uaccess_flush_orig;\n\n\tSKIP_IF(geteuid() != 0);\n\n\t\n\tSKIP_IF(!have_hwcap(PPC_FEATURE_ARCH_2_06));\n\n\tif (read_debugfs_int(\"powerpc/rfi_flush\", &rfi_flush_orig) < 0) {\n\t\tperror(\"Unable to read powerpc/rfi_flush debugfs file\");\n\t\tSKIP_IF(1);\n\t}\n\n\tif (read_debugfs_int(\"powerpc/entry_flush\", &entry_flush_orig) < 0) {\n\t\tperror(\"Unable to read powerpc/entry_flush debugfs file\");\n\t\tSKIP_IF(1);\n\t}\n\n\tif (read_debugfs_int(\"powerpc/uaccess_flush\", &uaccess_flush_orig) < 0) {\n\t\tperror(\"Unable to read powerpc/entry_flush debugfs file\");\n\t\tSKIP_IF(1);\n\t}\n\n\tif (rfi_flush_orig != 0) {\n\t\tif (write_debugfs_int(\"powerpc/rfi_flush\", 0) < 0) {\n\t\t\tperror(\"error writing to powerpc/rfi_flush debugfs file\");\n\t\t\tFAIL_IF(1);\n\t\t}\n\t}\n\n\tif (entry_flush_orig != 0) {\n\t\tif (write_debugfs_int(\"powerpc/entry_flush\", 0) < 0) {\n\t\t\tperror(\"error writing to powerpc/entry_flush debugfs file\");\n\t\t\tFAIL_IF(1);\n\t\t}\n\t}\n\n\tuaccess_flush = uaccess_flush_orig;\n\n\tfd = perf_event_open_counter(PERF_TYPE_HW_CACHE, PERF_L1D_READ_MISS_CONFIG, -1);\n\tFAIL_IF(fd < 0);\n\n\tp = (char *)memalign(zero_size, CACHELINE_SIZE);\n\n\tFAIL_IF(perf_event_enable(fd));\n\n\t\n\tset_dscr(1);\n\n\titer = repetitions;\n\n\t \n\tl1d_misses_expected = iterations * (zero_size / CACHELINE_SIZE - 2);\n\nagain:\n\tFAIL_IF(perf_event_reset(fd));\n\n\tsyscall_loop_uaccess(p, iterations, zero_size);\n\n\tFAIL_IF(read(fd, &v, sizeof(v)) != sizeof(v));\n\n\tif (uaccess_flush && v.l1d_misses >= l1d_misses_expected)\n\t\tpasses++;\n\telse if (!uaccess_flush && v.l1d_misses < (l1d_misses_expected / 2))\n\t\tpasses++;\n\n\tl1d_misses_total += v.l1d_misses;\n\n\twhile (--iter)\n\t\tgoto again;\n\n\tif (passes < repetitions) {\n\t\tprintf(\"FAIL (L1D misses with uaccess_flush=%d: %llu %c %lu) [%d/%d failures]\\n\",\n\t\t       uaccess_flush, l1d_misses_total, uaccess_flush ? '<' : '>',\n\t\t       uaccess_flush ? repetitions * l1d_misses_expected :\n\t\t       repetitions * l1d_misses_expected / 2,\n\t\t       repetitions - passes, repetitions);\n\t\trc = 1;\n\t} else {\n\t\tprintf(\"PASS (L1D misses with uaccess_flush=%d: %llu %c %lu) [%d/%d pass]\\n\",\n\t\t       uaccess_flush, l1d_misses_total, uaccess_flush ? '>' : '<',\n\t\t       uaccess_flush ? repetitions * l1d_misses_expected :\n\t\t       repetitions * l1d_misses_expected / 2,\n\t\t       passes, repetitions);\n\t}\n\n\tif (uaccess_flush == uaccess_flush_orig) {\n\t\tuaccess_flush = !uaccess_flush_orig;\n\t\tif (write_debugfs_int(\"powerpc/uaccess_flush\", uaccess_flush) < 0) {\n\t\t\tperror(\"error writing to powerpc/uaccess_flush debugfs file\");\n\t\t\treturn 1;\n\t\t}\n\t\titer = repetitions;\n\t\tl1d_misses_total = 0;\n\t\tpasses = 0;\n\t\tgoto again;\n\t}\n\n\tperf_event_disable(fd);\n\tclose(fd);\n\n\tset_dscr(0);\n\n\tif (write_debugfs_int(\"powerpc/rfi_flush\", rfi_flush_orig) < 0) {\n\t\tperror(\"unable to restore original value of powerpc/rfi_flush debugfs file\");\n\t\treturn 1;\n\t}\n\n\tif (write_debugfs_int(\"powerpc/entry_flush\", entry_flush_orig) < 0) {\n\t\tperror(\"unable to restore original value of powerpc/entry_flush debugfs file\");\n\t\treturn 1;\n\t}\n\n\tif (write_debugfs_int(\"powerpc/uaccess_flush\", uaccess_flush_orig) < 0) {\n\t\tperror(\"unable to restore original value of powerpc/uaccess_flush debugfs file\");\n\t\treturn 1;\n\t}\n\n\treturn rc;\n}\n\nint main(int argc, char *argv[])\n{\n\treturn test_harness(uaccess_flush_test, \"uaccess_flush_test\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}