{
  "module_name": "spectre_v2.c",
  "hash_id": "2f2043f804d70f6a4b60e15f32597d55bcc0b46dcc61b1aba042aa2819512cf0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/security/spectre_v2.c",
  "human_readable_source": "\n\n \n\n#define __SANE_USERSPACE_TYPES__\n\n#include <sys/types.h>\n#include <stdint.h>\n#include <malloc.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <string.h>\n#include <stdio.h>\n#include <sys/prctl.h>\n#include \"utils.h\"\n\n#include \"../pmu/event.h\"\n\n\nextern void pattern_cache_loop(void);\nextern void indirect_branch_loop(void);\n\nstatic int do_count_loop(struct event *events, bool is_p9, s64 *miss_percent)\n{\n\tu64 pred, mpred;\n\n\tprctl(PR_TASK_PERF_EVENTS_ENABLE);\n\n\tif (is_p9)\n\t\tpattern_cache_loop();\n\telse\n\t\tindirect_branch_loop();\n\n\tprctl(PR_TASK_PERF_EVENTS_DISABLE);\n\n\tevent_read(&events[0]);\n\tevent_read(&events[1]);\n\n\t\n\t\n\tFAIL_IF(events[0].result.running != events[0].result.enabled);\n\tFAIL_IF(events[1].result.running != events[1].result.enabled);\n\n\tpred =  events[0].result.value;\n\tmpred = events[1].result.value;\n\n\tif (is_p9) {\n\t\tevent_read(&events[2]);\n\t\tevent_read(&events[3]);\n\t\tFAIL_IF(events[2].result.running != events[2].result.enabled);\n\t\tFAIL_IF(events[3].result.running != events[3].result.enabled);\n\n\t\tpred  += events[2].result.value;\n\t\tmpred += events[3].result.value;\n\t}\n\n\t*miss_percent = 100 * mpred / pred;\n\n\treturn 0;\n}\n\nstatic void setup_event(struct event *e, u64 config, char *name)\n{\n\tevent_init_named(e, config, name);\n\n\te->attr.disabled = 1;\n\te->attr.exclude_kernel = 1;\n\te->attr.exclude_hv = 1;\n\te->attr.exclude_idle = 1;\n}\n\nenum spectre_v2_state {\n\tVULNERABLE = 0,\n\tUNKNOWN = 1,\t\t\n\tNOT_AFFECTED,\n\tBRANCH_SERIALISATION,\n\tCOUNT_CACHE_DISABLED,\n\tCOUNT_CACHE_FLUSH_SW,\n\tCOUNT_CACHE_FLUSH_HW,\n\tBTB_FLUSH,\n};\n\nstatic enum spectre_v2_state get_sysfs_state(void)\n{\n\tenum spectre_v2_state state = UNKNOWN;\n\tchar buf[256];\n\tint len;\n\n\tmemset(buf, 0, sizeof(buf));\n\tFAIL_IF(read_sysfs_file(\"devices/system/cpu/vulnerabilities/spectre_v2\", buf, sizeof(buf)));\n\n\t\n\tbuf[sizeof(buf) - 1] = '\\0';\n\n\t\n\tlen = strlen(buf);\n\tFAIL_IF(len < 1);\n\tbuf[len - 1] = '\\0';\n\n\tprintf(\"sysfs reports: '%s'\\n\", buf);\n\n\t\n\tif (strstr(buf, \"Vulnerable\"))\n\t\tstate = VULNERABLE;\n\telse if (strstr(buf, \"Not affected\"))\n\t\tstate = NOT_AFFECTED;\n\telse if (strstr(buf, \"Indirect branch serialisation (kernel only)\"))\n\t\tstate = BRANCH_SERIALISATION;\n\telse if (strstr(buf, \"Indirect branch cache disabled\"))\n\t\tstate = COUNT_CACHE_DISABLED;\n\telse if (strstr(buf, \"Software count cache flush (hardware accelerated)\"))\n\t\tstate = COUNT_CACHE_FLUSH_HW;\n\telse if (strstr(buf, \"Software count cache flush\"))\n\t\tstate = COUNT_CACHE_FLUSH_SW;\n\telse if (strstr(buf, \"Branch predictor state flush\"))\n\t\tstate = BTB_FLUSH;\n\n\treturn state;\n}\n\n#define PM_BR_PRED_CCACHE\t0x040a4\t\n#define PM_BR_MPRED_CCACHE\t0x040ac\t\n#define PM_BR_PRED_PCACHE\t0x048a0\t\n#define PM_BR_MPRED_PCACHE\t0x048b0\t\n\nint spectre_v2_test(void)\n{\n\tenum spectre_v2_state state;\n\tstruct event events[4];\n\ts64 miss_percent;\n\tbool is_p9;\n\n\t\n\tSKIP_IF(!have_hwcap2(PPC_FEATURE2_ARCH_2_07));\n\n\tstate = get_sysfs_state();\n\tif (state == UNKNOWN) {\n\t\tprintf(\"Error: couldn't determine spectre_v2 mitigation state?\\n\");\n\t\treturn -1;\n\t}\n\n\tmemset(events, 0, sizeof(events));\n\n\tsetup_event(&events[0], PM_BR_PRED_CCACHE,  \"PM_BR_PRED_CCACHE\");\n\tsetup_event(&events[1], PM_BR_MPRED_CCACHE, \"PM_BR_MPRED_CCACHE\");\n\tFAIL_IF(event_open(&events[0]));\n\tFAIL_IF(event_open_with_group(&events[1], events[0].fd) == -1);\n\n\tis_p9 = ((mfspr(SPRN_PVR) >>  16) & 0xFFFF) == 0x4e;\n\n\tif (is_p9) {\n\t\t\n\t\tsetup_event(&events[2], PM_BR_PRED_PCACHE,  \"PM_BR_PRED_PCACHE\");\n\t\tsetup_event(&events[3], PM_BR_MPRED_PCACHE, \"PM_BR_MPRED_PCACHE\");\n\n\t\tFAIL_IF(event_open_with_group(&events[2], events[0].fd) == -1);\n\t\tFAIL_IF(event_open_with_group(&events[3], events[0].fd) == -1);\n\t}\n\n\tFAIL_IF(do_count_loop(events, is_p9, &miss_percent));\n\n\tevent_report_justified(&events[0], 18, 10);\n\tevent_report_justified(&events[1], 18, 10);\n\tevent_close(&events[0]);\n\tevent_close(&events[1]);\n\n\tif (is_p9) {\n\t\tevent_report_justified(&events[2], 18, 10);\n\t\tevent_report_justified(&events[3], 18, 10);\n\t\tevent_close(&events[2]);\n\t\tevent_close(&events[3]);\n\t}\n\n\tprintf(\"Miss percent %lld %%\\n\", miss_percent);\n\n\tswitch (state) {\n\tcase VULNERABLE:\n\tcase NOT_AFFECTED:\n\tcase COUNT_CACHE_FLUSH_SW:\n\tcase COUNT_CACHE_FLUSH_HW:\n\t\t\n\t\tif (miss_percent > 15) {\n\t\t\tif (miss_percent > 95) {\n\t\t\t\t \n\t\t\t\tprintf(\"Branch misses > 95%% unexpected in this configuration.\\n\");\n\t\t\t\tprintf(\"Count cache likely disabled without Linux knowing.\\n\");\n\t\t\t\tif (state == COUNT_CACHE_FLUSH_SW)\n\t\t\t\t\tprintf(\"WARNING: Kernel performing unnecessary flushes.\\n\");\n\t\t\t\treturn 4;\n\t\t\t}\n\t\t\tprintf(\"Branch misses > 15%% unexpected in this configuration!\\n\");\n\t\t\tprintf(\"Possible mismatch between reported & actual mitigation\\n\");\n\n\t\t\treturn 1;\n\t\t}\n\t\tbreak;\n\tcase BRANCH_SERIALISATION:\n\t\t\n\t\tif (miss_percent > 25) {\n\t\t\tprintf(\"Branch misses > 25%% unexpected in this configuration!\\n\");\n\t\t\tprintf(\"Possible mismatch between reported & actual mitigation\\n\");\n\t\t\treturn 1;\n\t\t}\n\t\tbreak;\n\tcase COUNT_CACHE_DISABLED:\n\t\tif (miss_percent < 95) {\n\t\t\tprintf(\"Branch misses < 95%% unexpected in this configuration!\\n\");\n\t\t\tprintf(\"Possible mismatch between reported & actual mitigation\\n\");\n\t\t\treturn 1;\n\t\t}\n\t\tbreak;\n\tcase UNKNOWN:\n\tcase BTB_FLUSH:\n\t\tprintf(\"Not sure!\\n\");\n\t\treturn 1;\n\t}\n\n\tprintf(\"OK - Measured branch prediction rates match reported spectre v2 mitigation.\\n\");\n\n\treturn 0;\n}\n\nint main(int argc, char *argv[])\n{\n\treturn test_harness(spectre_v2_test, \"spectre_v2\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}