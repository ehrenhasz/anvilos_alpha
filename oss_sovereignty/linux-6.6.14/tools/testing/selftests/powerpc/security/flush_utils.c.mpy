{
  "module_name": "flush_utils.c",
  "hash_id": "273f5e8719a60f6bc57c21c4e2de0659a1dfb11cde3474cd1d3de67f57844e32",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/security/flush_utils.c",
  "human_readable_source": "\n\n \n\n#define __SANE_USERSPACE_TYPES__\n\n#include <sys/types.h>\n#include <stdint.h>\n#include <unistd.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <string.h>\n#include <stdio.h>\n#include <sys/utsname.h>\n#include \"reg.h\"\n#include \"utils.h\"\n#include \"flush_utils.h\"\n\nstatic inline __u64 load(void *addr)\n{\n\t__u64 tmp;\n\n\tasm volatile(\"ld %0,0(%1)\" : \"=r\"(tmp) : \"b\"(addr));\n\n\treturn tmp;\n}\n\nvoid syscall_loop(char *p, unsigned long iterations,\n\t\t  unsigned long zero_size)\n{\n\tfor (unsigned long i = 0; i < iterations; i++) {\n\t\tfor (unsigned long j = 0; j < zero_size; j += CACHELINE_SIZE)\n\t\t\tload(p + j);\n\t\tgetppid();\n\t}\n}\n\nvoid syscall_loop_uaccess(char *p, unsigned long iterations,\n\t\t\t  unsigned long zero_size)\n{\n\tstruct utsname utsname;\n\n\tfor (unsigned long i = 0; i < iterations; i++) {\n\t\tfor (unsigned long j = 0; j < zero_size; j += CACHELINE_SIZE)\n\t\t\tload(p + j);\n\t\tuname(&utsname);\n\t}\n}\n\nstatic void sigill_handler(int signr, siginfo_t *info, void *unused)\n{\n\tstatic int warned;\n\tucontext_t *ctx = (ucontext_t *)unused;\n\tunsigned long *pc = &UCONTEXT_NIA(ctx);\n\n\t \n\tif ((*((unsigned int *)*pc) & 0xfc1fffff) == 0x7c0303a6) {\n\t\tif (!warned++)\n\t\t\tprintf(\"WARNING: Skipping over dscr setup. Consider running 'ppc64_cpu --dscr=1' manually.\\n\");\n\t\t*pc += 4;\n\t} else {\n\t\tprintf(\"SIGILL at %p\\n\", pc);\n\t\tabort();\n\t}\n}\n\nvoid set_dscr(unsigned long val)\n{\n\tstatic int init;\n\tstruct sigaction sa;\n\n\tif (!init) {\n\t\tmemset(&sa, 0, sizeof(sa));\n\t\tsa.sa_sigaction = sigill_handler;\n\t\tsa.sa_flags = SA_SIGINFO;\n\t\tif (sigaction(SIGILL, &sa, NULL))\n\t\t\tperror(\"sigill_handler\");\n\t\tinit = 1;\n\t}\n\n\tmtspr(SPRN_DSCR, val);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}