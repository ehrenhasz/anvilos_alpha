{
  "module_name": "fork.c",
  "hash_id": "86a3fc3afa8bef8b9791e6682a8ba611e146a83e517ff6d7bb7906b51c7a674e",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/powerpc/benchmarks/fork.c",
  "human_readable_source": "\n\n \n\n#define _GNU_SOURCE\n#include <assert.h>\n#include <errno.h>\n#include <getopt.h>\n#include <limits.h>\n#include <linux/futex.h>\n#include <pthread.h>\n#include <sched.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/shm.h>\n#include <sys/syscall.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n\nstatic unsigned int timeout = 30;\n\nstatic void set_cpu(int cpu)\n{\n\tcpu_set_t cpuset;\n\n\tif (cpu == -1)\n\t\treturn;\n\n\tCPU_ZERO(&cpuset);\n\tCPU_SET(cpu, &cpuset);\n\n\tif (sched_setaffinity(0, sizeof(cpuset), &cpuset)) {\n\t\tperror(\"sched_setaffinity\");\n\t\texit(1);\n\t}\n}\n\nstatic void start_process_on(void *(*fn)(void *), void *arg, int cpu)\n{\n\tint pid;\n\n\tpid = fork();\n\tif (pid == -1) {\n\t\tperror(\"fork\");\n\t\texit(1);\n\t}\n\n\tif (pid)\n\t\treturn;\n\n\tset_cpu(cpu);\n\n\tfn(arg);\n\n\texit(0);\n}\n\nstatic int cpu;\nstatic int do_fork = 0;\nstatic int do_vfork = 0;\nstatic int do_exec = 0;\nstatic char *exec_file;\nstatic int exec_target = 0;\nstatic unsigned long iterations;\nstatic unsigned long iterations_prev;\n\nstatic void run_exec(void)\n{\n\tchar *const argv[] = { \"./exec_target\", NULL };\n\n\tif (execve(\"./exec_target\", argv, NULL) == -1) {\n\t\tperror(\"execve\");\n\t\texit(1);\n\t}\n}\n\nstatic void bench_fork(void)\n{\n\twhile (1) {\n\t\tpid_t pid = fork();\n\t\tif (pid == -1) {\n\t\t\tperror(\"fork\");\n\t\t\texit(1);\n\t\t}\n\t\tif (pid == 0) {\n\t\t\tif (do_exec)\n\t\t\t\trun_exec();\n\t\t\t_exit(0);\n\t\t}\n\t\tpid = waitpid(pid, NULL, 0);\n\t\tif (pid == -1) {\n\t\t\tperror(\"waitpid\");\n\t\t\texit(1);\n\t\t}\n\t\titerations++;\n\t}\n}\n\nstatic void bench_vfork(void)\n{\n\twhile (1) {\n\t\tpid_t pid = vfork();\n\t\tif (pid == -1) {\n\t\t\tperror(\"fork\");\n\t\t\texit(1);\n\t\t}\n\t\tif (pid == 0) {\n\t\t\tif (do_exec)\n\t\t\t\trun_exec();\n\t\t\t_exit(0);\n\t\t}\n\t\tpid = waitpid(pid, NULL, 0);\n\t\tif (pid == -1) {\n\t\t\tperror(\"waitpid\");\n\t\t\texit(1);\n\t\t}\n\t\titerations++;\n\t}\n}\n\nstatic void *null_fn(void *arg)\n{\n\tpthread_exit(NULL);\n}\n\nstatic void bench_thread(void)\n{\n\tpthread_t tid;\n\tcpu_set_t cpuset;\n\tpthread_attr_t attr;\n\tint rc;\n\n\trc = pthread_attr_init(&attr);\n\tif (rc) {\n\t\terrno = rc;\n\t\tperror(\"pthread_attr_init\");\n\t\texit(1);\n\t}\n\n\tif (cpu != -1) {\n\t\tCPU_ZERO(&cpuset);\n\t\tCPU_SET(cpu, &cpuset);\n\n\t\trc = pthread_attr_setaffinity_np(&attr, sizeof(cpu_set_t), &cpuset);\n\t\tif (rc) {\n\t\t\terrno = rc;\n\t\t\tperror(\"pthread_attr_setaffinity_np\");\n\t\t\texit(1);\n\t\t}\n\t}\n\n\twhile (1) {\n\t\trc = pthread_create(&tid, &attr, null_fn, NULL);\n\t\tif (rc) {\n\t\t\terrno = rc;\n\t\t\tperror(\"pthread_create\");\n\t\t\texit(1);\n\t\t}\n\t\trc = pthread_join(tid, NULL);\n\t\tif (rc) {\n\t\t\terrno = rc;\n\t\t\tperror(\"pthread_join\");\n\t\t\texit(1);\n\t\t}\n\t\titerations++;\n\t}\n}\n\nstatic void sigalrm_handler(int junk)\n{\n\tunsigned long i = iterations;\n\n\tprintf(\"%ld\\n\", i - iterations_prev);\n\titerations_prev = i;\n\n\tif (--timeout == 0)\n\t\tkill(0, SIGUSR1);\n\n\talarm(1);\n}\n\nstatic void sigusr1_handler(int junk)\n{\n\texit(0);\n}\n\nstatic void *bench_proc(void *arg)\n{\n\tsignal(SIGALRM, sigalrm_handler);\n\talarm(1);\n\n\tif (do_fork)\n\t\tbench_fork();\n\telse if (do_vfork)\n\t\tbench_vfork();\n\telse\n\t\tbench_thread();\n\n\treturn NULL;\n}\n\nstatic struct option options[] = {\n\t{ \"fork\", no_argument, &do_fork, 1 },\n\t{ \"vfork\", no_argument, &do_vfork, 1 },\n\t{ \"exec\", no_argument, &do_exec, 1 },\n\t{ \"timeout\", required_argument, 0, 's' },\n\t{ \"exec-target\", no_argument, &exec_target, 1 },\n\t{ NULL },\n};\n\nstatic void usage(void)\n{\n\tfprintf(stderr, \"Usage: fork <options> CPU\\n\\n\");\n\tfprintf(stderr, \"\\t\\t--fork\\tUse fork() (default threads)\\n\");\n\tfprintf(stderr, \"\\t\\t--vfork\\tUse vfork() (default threads)\\n\");\n\tfprintf(stderr, \"\\t\\t--exec\\tAlso exec() (default no exec)\\n\");\n\tfprintf(stderr, \"\\t\\t--timeout=X\\tDuration in seconds to run (default 30)\\n\");\n\tfprintf(stderr, \"\\t\\t--exec-target\\tInternal option for exec workload\\n\");\n}\n\nint main(int argc, char *argv[])\n{\n\tsigned char c;\n\n\twhile (1) {\n\t\tint option_index = 0;\n\n\t\tc = getopt_long(argc, argv, \"\", options, &option_index);\n\n\t\tif (c == -1)\n\t\t\tbreak;\n\n\t\tswitch (c) {\n\t\tcase 0:\n\t\t\tif (options[option_index].flag != 0)\n\t\t\t\tbreak;\n\n\t\t\tusage();\n\t\t\texit(1);\n\t\t\tbreak;\n\n\t\tcase 's':\n\t\t\ttimeout = atoi(optarg);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tusage();\n\t\t\texit(1);\n\t\t}\n\t}\n\n\tif (do_fork && do_vfork) {\n\t\tusage();\n\t\texit(1);\n\t}\n\tif (do_exec && !do_fork && !do_vfork) {\n\t\tusage();\n\t\texit(1);\n\t}\n\n\tif (do_exec) {\n\t\tchar *dirname = strdup(argv[0]);\n\t\tint i;\n\t\ti = strlen(dirname) - 1;\n\t\twhile (i) {\n\t\t\tif (dirname[i] == '/') {\n\t\t\t\tdirname[i] = '\\0';\n\t\t\t\tif (chdir(dirname) == -1) {\n\t\t\t\t\tperror(\"chdir\");\n\t\t\t\t\texit(1);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\ti--;\n\t\t}\n\t}\n\n\tif (exec_target) {\n\t\texit(0);\n\t}\n\n\tif (((argc - optind) != 1)) {\n\t\tcpu = -1;\n\t} else {\n\t\tcpu = atoi(argv[optind++]);\n\t}\n\n\tif (do_exec)\n\t\texec_file = argv[0];\n\n\tset_cpu(cpu);\n\n\tprintf(\"Using \");\n\tif (do_fork)\n\t\tprintf(\"fork\");\n\telse if (do_vfork)\n\t\tprintf(\"vfork\");\n\telse\n\t\tprintf(\"clone\");\n\n\tif (do_exec)\n\t\tprintf(\" + exec\");\n\n\tprintf(\" on cpu %d\\n\", cpu);\n\n\t \n\tsetpgid(getpid(), getpid());\n\n\tsignal(SIGUSR1, sigusr1_handler);\n\n\tstart_process_on(bench_proc, NULL, cpu);\n\n\twhile (1)\n\t\tsleep(3600);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}