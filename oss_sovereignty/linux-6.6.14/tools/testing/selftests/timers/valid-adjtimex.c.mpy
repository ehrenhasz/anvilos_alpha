{
  "module_name": "valid-adjtimex.c",
  "hash_id": "cc2e66e36ef456b22bb7cc9e80eea317ca82c55f410964cec655b7abe648c1fc",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/timers/valid-adjtimex.c",
  "human_readable_source": " \n\n\n\n#include <stdio.h>\n#include <stdlib.h>\n#include <time.h>\n#include <sys/time.h>\n#include <sys/timex.h>\n#include <string.h>\n#include <signal.h>\n#include <unistd.h>\n#include \"../kselftest.h\"\n\n#define NSEC_PER_SEC 1000000000LL\n#define USEC_PER_SEC 1000000LL\n\n#define ADJ_SETOFFSET 0x0100\n\n#include <sys/syscall.h>\nint clock_adjtime(clockid_t id, struct timex *tx)\n{\n\treturn syscall(__NR_clock_adjtime, id, tx);\n}\n\n\n \nint clear_time_state(void)\n{\n\tstruct timex tx;\n\tint ret;\n\n\ttx.modes = ADJ_STATUS;\n\ttx.status = 0;\n\tret = adjtimex(&tx);\n\treturn ret;\n}\n\n#define NUM_FREQ_VALID 32\n#define NUM_FREQ_OUTOFRANGE 4\n#define NUM_FREQ_INVALID 2\n\nlong valid_freq[NUM_FREQ_VALID] = {\n\t-499<<16,\n\t-450<<16,\n\t-400<<16,\n\t-350<<16,\n\t-300<<16,\n\t-250<<16,\n\t-200<<16,\n\t-150<<16,\n\t-100<<16,\n\t-75<<16,\n\t-50<<16,\n\t-25<<16,\n\t-10<<16,\n\t-5<<16,\n\t-1<<16,\n\t-1000,\n\t1<<16,\n\t5<<16,\n\t10<<16,\n\t25<<16,\n\t50<<16,\n\t75<<16,\n\t100<<16,\n\t150<<16,\n\t200<<16,\n\t250<<16,\n\t300<<16,\n\t350<<16,\n\t400<<16,\n\t450<<16,\n\t499<<16,\n};\n\nlong outofrange_freq[NUM_FREQ_OUTOFRANGE] = {\n\t-1000<<16,\n\t-550<<16,\n\t550<<16,\n\t1000<<16,\n};\n\n#define LONG_MAX (~0UL>>1)\n#define LONG_MIN (-LONG_MAX - 1)\n\nlong invalid_freq[NUM_FREQ_INVALID] = {\n\tLONG_MAX,\n\tLONG_MIN,\n};\n\nint validate_freq(void)\n{\n\tstruct timex tx;\n\tint ret, pass = 0;\n\tint i;\n\n\tclear_time_state();\n\n\tmemset(&tx, 0, sizeof(struct timex));\n\t \n\n\tprintf(\"Testing ADJ_FREQ... \");\n\tfflush(stdout);\n\tfor (i = 0; i < NUM_FREQ_VALID; i++) {\n\t\ttx.modes = ADJ_FREQUENCY;\n\t\ttx.freq = valid_freq[i];\n\n\t\tret = adjtimex(&tx);\n\t\tif (ret < 0) {\n\t\t\tprintf(\"[FAIL]\\n\");\n\t\t\tprintf(\"Error: adjtimex(ADJ_FREQ, %ld - %ld ppm\\n\",\n\t\t\t\tvalid_freq[i], valid_freq[i]>>16);\n\t\t\tpass = -1;\n\t\t\tgoto out;\n\t\t}\n\t\ttx.modes = 0;\n\t\tret = adjtimex(&tx);\n\t\tif (tx.freq != valid_freq[i]) {\n\t\t\tprintf(\"Warning: freq value %ld not what we set it (%ld)!\\n\",\n\t\t\t\t\ttx.freq, valid_freq[i]);\n\t\t}\n\t}\n\tfor (i = 0; i < NUM_FREQ_OUTOFRANGE; i++) {\n\t\ttx.modes = ADJ_FREQUENCY;\n\t\ttx.freq = outofrange_freq[i];\n\n\t\tret = adjtimex(&tx);\n\t\tif (ret < 0) {\n\t\t\tprintf(\"[FAIL]\\n\");\n\t\t\tprintf(\"Error: adjtimex(ADJ_FREQ, %ld - %ld ppm\\n\",\n\t\t\t\toutofrange_freq[i], outofrange_freq[i]>>16);\n\t\t\tpass = -1;\n\t\t\tgoto out;\n\t\t}\n\t\ttx.modes = 0;\n\t\tret = adjtimex(&tx);\n\t\tif (tx.freq == outofrange_freq[i]) {\n\t\t\tprintf(\"[FAIL]\\n\");\n\t\t\tprintf(\"ERROR: out of range value %ld actually set!\\n\",\n\t\t\t\t\ttx.freq);\n\t\t\tpass = -1;\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\n\tif (sizeof(long) == 8) {  \n\t\tfor (i = 0; i < NUM_FREQ_INVALID; i++) {\n\t\t\ttx.modes = ADJ_FREQUENCY;\n\t\t\ttx.freq = invalid_freq[i];\n\t\t\tret = adjtimex(&tx);\n\t\t\tif (ret >= 0) {\n\t\t\t\tprintf(\"[FAIL]\\n\");\n\t\t\t\tprintf(\"Error: No failure on invalid ADJ_FREQUENCY %ld\\n\",\n\t\t\t\t\tinvalid_freq[i]);\n\t\t\t\tpass = -1;\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\t}\n\n\tprintf(\"[OK]\\n\");\nout:\n\t \n\ttx.modes = ADJ_FREQUENCY;\n\ttx.freq = 0;\n\tret = adjtimex(&tx);\n\n\treturn pass;\n}\n\n\nint set_offset(long long offset, int use_nano)\n{\n\tstruct timex tmx = {};\n\tint ret;\n\n\ttmx.modes = ADJ_SETOFFSET;\n\tif (use_nano) {\n\t\ttmx.modes |= ADJ_NANO;\n\n\t\ttmx.time.tv_sec = offset / NSEC_PER_SEC;\n\t\ttmx.time.tv_usec = offset % NSEC_PER_SEC;\n\n\t\tif (offset < 0 && tmx.time.tv_usec) {\n\t\t\ttmx.time.tv_sec -= 1;\n\t\t\ttmx.time.tv_usec += NSEC_PER_SEC;\n\t\t}\n\t} else {\n\t\ttmx.time.tv_sec = offset / USEC_PER_SEC;\n\t\ttmx.time.tv_usec = offset % USEC_PER_SEC;\n\n\t\tif (offset < 0 && tmx.time.tv_usec) {\n\t\t\ttmx.time.tv_sec -= 1;\n\t\t\ttmx.time.tv_usec += USEC_PER_SEC;\n\t\t}\n\t}\n\n\tret = clock_adjtime(CLOCK_REALTIME, &tmx);\n\tif (ret < 0) {\n\t\tprintf(\"(sec: %ld  usec: %ld) \", tmx.time.tv_sec, tmx.time.tv_usec);\n\t\tprintf(\"[FAIL]\\n\");\n\t\treturn -1;\n\t}\n\treturn 0;\n}\n\nint set_bad_offset(long sec, long usec, int use_nano)\n{\n\tstruct timex tmx = {};\n\tint ret;\n\n\ttmx.modes = ADJ_SETOFFSET;\n\tif (use_nano)\n\t\ttmx.modes |= ADJ_NANO;\n\n\ttmx.time.tv_sec = sec;\n\ttmx.time.tv_usec = usec;\n\tret = clock_adjtime(CLOCK_REALTIME, &tmx);\n\tif (ret >= 0) {\n\t\tprintf(\"Invalid (sec: %ld  usec: %ld) did not fail! \", tmx.time.tv_sec, tmx.time.tv_usec);\n\t\tprintf(\"[FAIL]\\n\");\n\t\treturn -1;\n\t}\n\treturn 0;\n}\n\nint validate_set_offset(void)\n{\n\tprintf(\"Testing ADJ_SETOFFSET... \");\n\tfflush(stdout);\n\n\t \n\tif (set_offset(NSEC_PER_SEC - 1, 1))\n\t\treturn -1;\n\n\tif (set_offset(-NSEC_PER_SEC + 1, 1))\n\t\treturn -1;\n\n\tif (set_offset(-NSEC_PER_SEC - 1, 1))\n\t\treturn -1;\n\n\tif (set_offset(5 * NSEC_PER_SEC, 1))\n\t\treturn -1;\n\n\tif (set_offset(-5 * NSEC_PER_SEC, 1))\n\t\treturn -1;\n\n\tif (set_offset(5 * NSEC_PER_SEC + NSEC_PER_SEC / 2, 1))\n\t\treturn -1;\n\n\tif (set_offset(-5 * NSEC_PER_SEC - NSEC_PER_SEC / 2, 1))\n\t\treturn -1;\n\n\tif (set_offset(USEC_PER_SEC - 1, 0))\n\t\treturn -1;\n\n\tif (set_offset(-USEC_PER_SEC + 1, 0))\n\t\treturn -1;\n\n\tif (set_offset(-USEC_PER_SEC - 1, 0))\n\t\treturn -1;\n\n\tif (set_offset(5 * USEC_PER_SEC, 0))\n\t\treturn -1;\n\n\tif (set_offset(-5 * USEC_PER_SEC, 0))\n\t\treturn -1;\n\n\tif (set_offset(5 * USEC_PER_SEC + USEC_PER_SEC / 2, 0))\n\t\treturn -1;\n\n\tif (set_offset(-5 * USEC_PER_SEC - USEC_PER_SEC / 2, 0))\n\t\treturn -1;\n\n\t \n\tif (set_bad_offset(0, -1, 1))\n\t\treturn -1;\n\tif (set_bad_offset(0, -1, 0))\n\t\treturn -1;\n\tif (set_bad_offset(0, 2 * NSEC_PER_SEC, 1))\n\t\treturn -1;\n\tif (set_bad_offset(0, 2 * USEC_PER_SEC, 0))\n\t\treturn -1;\n\tif (set_bad_offset(0, NSEC_PER_SEC, 1))\n\t\treturn -1;\n\tif (set_bad_offset(0, USEC_PER_SEC, 0))\n\t\treturn -1;\n\tif (set_bad_offset(0, -NSEC_PER_SEC, 1))\n\t\treturn -1;\n\tif (set_bad_offset(0, -USEC_PER_SEC, 0))\n\t\treturn -1;\n\n\tprintf(\"[OK]\\n\");\n\treturn 0;\n}\n\nint main(int argc, char **argv)\n{\n\tif (validate_freq())\n\t\treturn ksft_exit_fail();\n\n\tif (validate_set_offset())\n\t\treturn ksft_exit_fail();\n\n\treturn ksft_exit_pass();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}