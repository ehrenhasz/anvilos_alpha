{
  "module_name": "rtcpie.c",
  "hash_id": "a9152d270e52e7740a1fa023758af4d321b4e4c29c1925c079e33cbc05ce55f2",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/timers/rtcpie.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <linux/rtc.h>\n#include <sys/ioctl.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <errno.h>\n\n#include \"../kselftest.h\"\n\n \nstatic const char default_rtc[] = \"/dev/rtc0\";\n\nint main(int argc, char **argv)\n{\n\tint i, fd, retval, irqcount = 0;\n\tunsigned long tmp, data, old_pie_rate;\n\tconst char *rtc = default_rtc;\n\tstruct timeval start, end, diff;\n\n\tswitch (argc) {\n\tcase 2:\n\t\trtc = argv[1];\n\t\tbreak;\n\tcase 1:\n\t\tfd = open(default_rtc, O_RDONLY);\n\t\tif (fd == -1) {\n\t\t\tprintf(\"Default RTC %s does not exist. Test Skipped!\\n\", default_rtc);\n\t\t\texit(KSFT_SKIP);\n\t\t}\n\t\tclose(fd);\n\t\tbreak;\n\tdefault:\n\t\tfprintf(stderr, \"usage:  rtctest [rtcdev] [d]\\n\");\n\t\treturn 1;\n\t}\n\n\tfd = open(rtc, O_RDONLY);\n\n\tif (fd ==  -1) {\n\t\tperror(rtc);\n\t\texit(errno);\n\t}\n\n\t \n\tretval = ioctl(fd, RTC_IRQP_READ, &old_pie_rate);\n\tif (retval == -1) {\n\t\t \n\t\tif (errno == EINVAL) {\n\t\t\tfprintf(stderr, \"\\nNo periodic IRQ support\\n\");\n\t\t\tgoto done;\n\t\t}\n\t\tperror(\"RTC_IRQP_READ ioctl\");\n\t\texit(errno);\n\t}\n\tfprintf(stderr, \"\\nPeriodic IRQ rate is %ldHz.\\n\", old_pie_rate);\n\n\tfprintf(stderr, \"Counting 20 interrupts at:\");\n\tfflush(stderr);\n\n\t \n\tfor (tmp=2; tmp<=64; tmp*=2) {\n\n\t\tretval = ioctl(fd, RTC_IRQP_SET, tmp);\n\t\tif (retval == -1) {\n\t\t\t \n\t\t\tif (errno == EINVAL) {\n\t\t\t\tfprintf(stderr,\n\t\t\t\t\t\"\\n...Periodic IRQ rate is fixed\\n\");\n\t\t\t\tgoto done;\n\t\t\t}\n\t\t\tperror(\"RTC_IRQP_SET ioctl\");\n\t\t\texit(errno);\n\t\t}\n\n\t\tfprintf(stderr, \"\\n%ldHz:\\t\", tmp);\n\t\tfflush(stderr);\n\n\t\t \n\t\tretval = ioctl(fd, RTC_PIE_ON, 0);\n\t\tif (retval == -1) {\n\t\t\tperror(\"RTC_PIE_ON ioctl\");\n\t\t\texit(errno);\n\t\t}\n\n\t\tfor (i=1; i<21; i++) {\n\t\t\tgettimeofday(&start, NULL);\n\t\t\t \n\t\t\tretval = read(fd, &data, sizeof(unsigned long));\n\t\t\tif (retval == -1) {\n\t\t\t\tperror(\"read\");\n\t\t\t\texit(errno);\n\t\t\t}\n\t\t\tgettimeofday(&end, NULL);\n\t\t\ttimersub(&end, &start, &diff);\n\t\t\tif (diff.tv_sec > 0 ||\n\t\t\t    diff.tv_usec > ((1000000L / tmp) * 1.10)) {\n\t\t\t\tfprintf(stderr, \"\\nPIE delta error: %ld.%06ld should be close to 0.%06ld\\n\",\n\t\t\t\t       diff.tv_sec, diff.tv_usec,\n\t\t\t\t       (1000000L / tmp));\n\t\t\t\tfflush(stdout);\n\t\t\t\texit(-1);\n\t\t\t}\n\n\t\t\tfprintf(stderr, \" %d\",i);\n\t\t\tfflush(stderr);\n\t\t\tirqcount++;\n\t\t}\n\n\t\t \n\t\tretval = ioctl(fd, RTC_PIE_OFF, 0);\n\t\tif (retval == -1) {\n\t\t\tperror(\"RTC_PIE_OFF ioctl\");\n\t\t\texit(errno);\n\t\t}\n\t}\n\ndone:\n\tioctl(fd, RTC_IRQP_SET, old_pie_rate);\n\n\tfprintf(stderr, \"\\n\\n\\t\\t\\t *** Test complete ***\\n\");\n\n\tclose(fd);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}