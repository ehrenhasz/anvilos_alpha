{
  "module_name": "setns-sysvipc.c",
  "hash_id": "7e2e602d4732e0ffe32741d4b0ecd7d33ba7444b544b3cf240fab0d42c03c6ba",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/proc/setns-sysvipc.c",
  "human_readable_source": " \n \n#undef NDEBUG\n#include <assert.h>\n#include <errno.h>\n#include <stdio.h>\n#include <sched.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <sys/ipc.h>\n#include <sys/shm.h>\n\nstatic pid_t pid = -1;\n\nstatic void f(void)\n{\n\tif (pid > 0) {\n\t\tkill(pid, SIGTERM);\n\t}\n}\n\nint main(void)\n{\n\tint fd[2];\n\tchar _ = 0;\n\tint nsfd;\n\n\tatexit(f);\n\n\t \n\tif (unshare(CLONE_NEWIPC) == -1) {\n\t\tif (errno == ENOSYS || errno == EPERM) {\n\t\t\treturn 4;\n\t\t}\n\t\treturn 1;\n\t}\n\t \n\tif (shmget(IPC_PRIVATE, 1, IPC_CREAT) == -1) {\n\t\treturn 1;\n\t}\n\n\tif (pipe(fd) == -1) {\n\t\treturn 1;\n\t}\n\n\tpid = fork();\n\tif (pid == -1) {\n\t\treturn 1;\n\t}\n\n\tif (pid == 0) {\n\t\tif (unshare(CLONE_NEWIPC) == -1) {\n\t\t\treturn 1;\n\t\t}\n\n\t\tif (write(fd[1], &_, 1) != 1) {\n\t\t\treturn 1;\n\t\t}\n\n\t\tpause();\n\n\t\treturn 0;\n\t}\n\n\tif (read(fd[0], &_, 1) != 1) {\n\t\treturn 1;\n\t}\n\n\t{\n\t\tchar buf[64];\n\t\tsnprintf(buf, sizeof(buf), \"/proc/%u/ns/ipc\", pid);\n\t\tnsfd = open(buf, O_RDONLY);\n\t\tif (nsfd == -1) {\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\t \n\t(void)open(\"/proc/sysvipc/shm\", O_RDONLY);\n\n\tif (setns(nsfd, CLONE_NEWIPC) == -1) {\n\t\treturn 1;\n\t}\n\n\tkill(pid, SIGTERM);\n\tpid = 0;\n\n\t{\n\t\tchar buf[4096];\n\t\tssize_t rv;\n\t\tint fd;\n\n\t\tfd = open(\"/proc/sysvipc/shm\", O_RDONLY);\n\t\tif (fd == -1) {\n\t\t\treturn 1;\n\t\t}\n\n#define S32 \"       key      shmid perms       size  cpid  lpid nattch   uid   gid  cuid  cgid      atime      dtime      ctime        rss       swap\\n\"\n#define S64 \"       key      shmid perms                  size  cpid  lpid nattch   uid   gid  cuid  cgid      atime      dtime      ctime                   rss                  swap\\n\"\n\t\trv = read(fd, buf, sizeof(buf));\n\t\tif (rv == strlen(S32)) {\n\t\t\tassert(memcmp(buf, S32, strlen(S32)) == 0);\n\t\t} else if (rv == strlen(S64)) {\n\t\t\tassert(memcmp(buf, S64, strlen(S64)) == 0);\n\t\t} else {\n\t\t\tassert(0);\n\t\t}\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}