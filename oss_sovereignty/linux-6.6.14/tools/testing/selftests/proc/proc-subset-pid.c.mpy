{
  "module_name": "proc-subset-pid.c",
  "hash_id": "184cd6f93581fe3562b16ea66350d0da311465d807cd4422be9c7cb17a396e76",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/proc/proc-subset-pid.c",
  "human_readable_source": " \n \n#undef NDEBUG\n#include <assert.h>\n#include <errno.h>\n#include <sched.h>\n#include <stdbool.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mount.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <stdio.h>\n\nstatic inline bool streq(const char *a, const char *b)\n{\n\treturn strcmp(a, b) == 0;\n}\n\nstatic void make_private_proc(void)\n{\n\tif (unshare(CLONE_NEWNS) == -1) {\n\t\tif (errno == ENOSYS || errno == EPERM) {\n\t\t\texit(4);\n\t\t}\n\t\texit(1);\n\t}\n\tif (mount(NULL, \"/\", NULL, MS_PRIVATE|MS_REC, NULL) == -1) {\n\t\texit(1);\n\t}\n\tif (mount(NULL, \"/proc\", \"proc\", 0, \"subset=pid\") == -1) {\n\t\texit(1);\n\t}\n}\n\nstatic bool string_is_pid(const char *s)\n{\n\twhile (1) {\n\t\tswitch (*s++) {\n\t\tcase '0':case '1':case '2':case '3':case '4':\n\t\tcase '5':case '6':case '7':case '8':case '9':\n\t\t\tcontinue;\n\n\t\tcase '\\0':\n\t\t\treturn true;\n\n\t\tdefault:\n\t\t\treturn false;\n\t\t}\n\t}\n}\n\nint main(void)\n{\n\tmake_private_proc();\n\n\tDIR *d = opendir(\"/proc\");\n\tassert(d);\n\n\tstruct dirent *de;\n\n\tbool dot = false;\n\tbool dot_dot = false;\n\tbool self = false;\n\tbool thread_self = false;\n\n\twhile ((de = readdir(d))) {\n\t\tif (streq(de->d_name, \".\")) {\n\t\t\tassert(!dot);\n\t\t\tdot = true;\n\t\t\tassert(de->d_type == DT_DIR);\n\t\t} else if (streq(de->d_name, \"..\")) {\n\t\t\tassert(!dot_dot);\n\t\t\tdot_dot = true;\n\t\t\tassert(de->d_type == DT_DIR);\n\t\t} else if (streq(de->d_name, \"self\")) {\n\t\t\tassert(!self);\n\t\t\tself = true;\n\t\t\tassert(de->d_type == DT_LNK);\n\t\t} else if (streq(de->d_name, \"thread-self\")) {\n\t\t\tassert(!thread_self);\n\t\t\tthread_self = true;\n\t\t\tassert(de->d_type == DT_LNK);\n\t\t} else {\n\t\t\tif (!string_is_pid(de->d_name)) {\n\t\t\t\tfprintf(stderr, \"d_name '%s'\\n\", de->d_name);\n\t\t\t\tassert(0);\n\t\t\t}\n\t\t\tassert(de->d_type == DT_DIR);\n\t\t}\n\t}\n\n\tchar c;\n\tint rv = readlink(\"/proc/cpuinfo\", &c, 1);\n\tassert(rv == -1 && errno == ENOENT);\n\n\tint fd = open(\"/proc/cpuinfo\", O_RDONLY);\n\tassert(fd == -1 && errno == ENOENT);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}