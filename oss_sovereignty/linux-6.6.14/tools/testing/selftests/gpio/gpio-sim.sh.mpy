{
  "module_name": "gpio-sim.sh",
  "hash_id": "56f0eb937adc12a1190922c7a34a5874f72ba2a58af5ca25d9a6399eb20bd92c",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/gpio/gpio-sim.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n# Copyright (C) 2021 Bartosz Golaszewski <brgl@bgdev.pl>\n\nBASE_DIR=`dirname $0`\nCONFIGFS_DIR=\"/sys/kernel/config/gpio-sim\"\nMODULE=\"gpio-sim\"\n\nfail() {\n\techo \"$*\" >&2\n\techo \"GPIO $MODULE test FAIL\"\n\texit 1\n}\n\nskip() {\n\techo \"$*\" >&2\n\techo \"GPIO $MODULE test SKIP\"\n\texit 4\n}\n\nremove_chip() {\n\tlocal CHIP=$1\n\n\tfor FILE in $CONFIGFS_DIR/$CHIP/*; do\n\t\tBANK=`basename $FILE`\n\t\tif [ \"$BANK\" = \"live\" -o \"$BANK\" = \"dev_name\" ]; then\n\t\t\tcontinue\n\t\tfi\n\n\t\tLINES=`ls $CONFIGFS_DIR/$CHIP/$BANK/ | grep -E ^line`\n\t\tif [ \"$?\" = 0 ]; then\n\t\t\tfor LINE in $LINES; do\n\t\t\t\tif [ -e $CONFIGFS_DIR/$CHIP/$BANK/$LINE/hog ]; then\n\t\t\t\t\trmdir $CONFIGFS_DIR/$CHIP/$BANK/$LINE/hog || \\\n\t\t\t\t\t\tfail \"Unable to remove the hog\"\n\t\t\t\tfi\n\n\t\t\t\trmdir $CONFIGFS_DIR/$CHIP/$BANK/$LINE || \\\n\t\t\t\t\tfail \"Unable to remove the line\"\n\t\t\tdone\n\t\tfi\n\n\t\trmdir $CONFIGFS_DIR/$CHIP/$BANK\n\tdone\n\n\trmdir $CONFIGFS_DIR/$CHIP || fail \"Unable to remove the chip\"\n}\n\nconfigfs_cleanup() {\n\tfor CHIP in `ls $CONFIGFS_DIR/`; do\n\t\tremove_chip $CHIP\n\tdone\n}\n\ncreate_chip() {\n\tlocal CHIP=$1\n\n\tmkdir $CONFIGFS_DIR/$CHIP\n}\n\ncreate_bank() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\n\tmkdir $CONFIGFS_DIR/$CHIP/$BANK\n}\n\nset_label() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\tlocal LABEL=$3\n\n\techo $LABEL > $CONFIGFS_DIR/$CHIP/$BANK/label || fail \"Unable to set the chip label\"\n}\n\nset_num_lines() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\tlocal NUM_LINES=$3\n\n\techo $NUM_LINES > $CONFIGFS_DIR/$CHIP/$BANK/num_lines || \\\n\t\tfail \"Unable to set the number of lines\"\n}\n\nset_line_name() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\tlocal OFFSET=$3\n\tlocal NAME=$4\n\tlocal LINE_DIR=$CONFIGFS_DIR/$CHIP/$BANK/line$OFFSET\n\n\ttest -d $LINE_DIR || mkdir $LINE_DIR\n\techo $NAME > $LINE_DIR/name || fail \"Unable to set the line name\"\n}\n\nenable_chip() {\n\tlocal CHIP=$1\n\n\techo 1 > $CONFIGFS_DIR/$CHIP/live || fail \"Unable to enable the chip\"\n}\n\ndisable_chip() {\n\tlocal CHIP=$1\n\n\techo 0 > $CONFIGFS_DIR/$CHIP/live || fail \"Unable to disable the chip\"\n}\n\nconfigfs_chip_name() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\n\tcat $CONFIGFS_DIR/$CHIP/$BANK/chip_name 2> /dev/null || \\\n\t\tfail \"unable to read the chip name from configfs\"\n}\n\nconfigfs_dev_name() {\n\tlocal CHIP=$1\n\n\tcat $CONFIGFS_DIR/$CHIP/dev_name 2> /dev/null || \\\n\t\tfail \"unable to read the device name from configfs\"\n}\n\nget_chip_num_lines() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\n\t$BASE_DIR/gpio-chip-info /dev/`configfs_chip_name $CHIP $BANK` num-lines || \\\n\t\tfail \"unable to read the number of lines from the character device\"\n}\n\nget_chip_label() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\n\t$BASE_DIR/gpio-chip-info /dev/`configfs_chip_name $CHIP $BANK` label || \\\n\t\tfail \"unable to read the chip label from the character device\"\n}\n\nget_line_name() {\n\tlocal CHIP=$1\n\tlocal BANK=$2\n\tlocal OFFSET=$3\n\n\t$BASE_DIR/gpio-line-name /dev/`configfs_chip_name $CHIP $BANK` $OFFSET || \\\n\t\tfail \"unable to read the line name from the character device\"\n}\n\nsysfs_set_pull() {\n\tlocal DEV=$1\n\tlocal BANK=$2\n\tlocal OFFSET=$3\n\tlocal PULL=$4\n\tlocal DEVNAME=`configfs_dev_name $DEV`\n\tlocal CHIPNAME=`configfs_chip_name $DEV $BANK`\n\tlocal SYSFS_PATH=\"/sys/devices/platform/$DEVNAME/$CHIPNAME/sim_gpio$OFFSET/pull\"\n\n\techo $PULL > $SYSFS_PATH || fail \"Unable to set line pull in sysfs\"\n}\n\n# Load the gpio-sim module. This will pull in configfs if needed too.\nmodprobe gpio-sim || skip \"unable to load the gpio-sim module\"\n# Make sure configfs is mounted at /sys/kernel/config. Wait a bit if needed.\nfor IDX in `seq 5`; do\n\tif [ \"$IDX\" -eq \"5\" ]; then\n\t\tskip \"configfs not mounted at /sys/kernel/config\"\n\tfi\n\n\tmountpoint -q /sys/kernel/config && break\n\tsleep 0.1\ndone\n# If the module was already loaded: remove all previous chips\nconfigfs_cleanup\n\ntrap \"exit 1\" SIGTERM SIGINT\ntrap configfs_cleanup EXIT\n\necho \"1. chip_name and dev_name attributes\"\n\necho \"1.1. Chip name is communicated to user\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\ntest -n `cat $CONFIGFS_DIR/chip/bank/chip_name` || fail \"chip_name doesn't work\"\nremove_chip chip\n\necho \"1.2. chip_name returns 'none' if the chip is still pending\"\ncreate_chip chip\ncreate_bank chip bank\ntest \"`cat $CONFIGFS_DIR/chip/bank/chip_name`\" = \"none\" || \\\n\tfail \"chip_name doesn't return 'none' for a pending chip\"\nremove_chip chip\n\necho \"1.3. Device name is communicated to user\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\ntest -n `cat $CONFIGFS_DIR/chip/dev_name` || fail \"dev_name doesn't work\"\nremove_chip chip\n\necho \"2. Creating and configuring simulated chips\"\n\necho \"2.1. Default number of lines is 1\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\ntest \"`get_chip_num_lines chip bank`\" = \"1\" || fail \"default number of lines is not 1\"\nremove_chip chip\n\necho \"2.2. Number of lines can be specified\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 16\nenable_chip chip\ntest \"`get_chip_num_lines chip bank`\" = \"16\" || fail \"number of lines is not 16\"\nremove_chip chip\n\necho \"2.3. Label can be set\"\ncreate_chip chip\ncreate_bank chip bank\nset_label chip bank foobar\nenable_chip chip\ntest \"`get_chip_label chip bank`\" = \"foobar\" || fail \"label is incorrect\"\nremove_chip chip\n\necho \"2.4. Label can be left empty\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\ntest -z \"`cat $CONFIGFS_DIR/chip/bank/label`\" || fail \"label is not empty\"\nremove_chip chip\n\necho \"2.5. Line names can be configured\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 16\nset_line_name chip bank 0 foo\nset_line_name chip bank 2 bar\nenable_chip chip\ntest \"`get_line_name chip bank 0`\" = \"foo\" || fail \"line name is incorrect\"\ntest \"`get_line_name chip bank 2`\" = \"bar\" || fail \"line name is incorrect\"\nremove_chip chip\n\necho \"2.6. Line config can remain unused if offset is greater than number of lines\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 2\nset_line_name chip bank 5 foobar\nenable_chip chip\ntest \"`get_line_name chip bank 0`\" = \"\" || fail \"line name is incorrect\"\ntest \"`get_line_name chip bank 1`\" = \"\" || fail \"line name is incorrect\"\nremove_chip chip\n\necho \"2.7. Line configfs directory names are sanitized\"\ncreate_chip chip\ncreate_bank chip bank\nmkdir $CONFIGFS_DIR/chip/bank/line12foobar 2> /dev/null && \\\n\tfail \"invalid configfs line name accepted\"\nmkdir $CONFIGFS_DIR/chip/bank/line_no_offset 2> /dev/null && \\\n\tfail \"invalid configfs line name accepted\"\nremove_chip chip\n\necho \"2.8. Multiple chips can be created\"\nCHIPS=\"chip0 chip1 chip2\"\nfor CHIP in $CHIPS; do\n\tcreate_chip $CHIP\n\tcreate_bank $CHIP bank\n\tenable_chip $CHIP\ndone\nfor CHIP in $CHIPS; do\n\tremove_chip $CHIP\ndone\n\necho \"2.9. Can't modify settings when chip is live\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\necho foobar > $CONFIGFS_DIR/chip/bank/label 2> /dev/null && \\\n\tfail \"Setting label of a live chip should fail\"\necho 8 > $CONFIGFS_DIR/chip/bank/num_lines 2> /dev/null && \\\n\tfail \"Setting number of lines of a live chip should fail\"\nremove_chip chip\n\necho \"2.10. Can't create line items when chip is live\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\nmkdir $CONFIGFS_DIR/chip/bank/line0 2> /dev/null && fail \"Creating line item should fail\"\nremove_chip chip\n\necho \"2.11. Probe errors are propagated to user-space\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 99999\necho 1 > $CONFIGFS_DIR/chip/live 2> /dev/null && fail \"Probe error was not propagated\"\nremove_chip chip\n\necho \"2.12. Cannot enable a chip without any GPIO banks\"\ncreate_chip chip\necho 1 > $CONFIGFS_DIR/chip/live 2> /dev/null && fail \"Chip enabled without any GPIO banks\"\nremove_chip chip\n\necho \"2.13. Duplicate chip labels are not allowed\"\ncreate_chip chip\ncreate_bank chip bank0\nset_label chip bank0 foobar\ncreate_bank chip bank1\nset_label chip bank1 foobar\necho 1 > $CONFIGFS_DIR/chip/live 2> /dev/null && fail \"Duplicate chip labels were not rejected\"\nremove_chip chip\n\necho \"2.14. Lines can be hogged\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 8\nmkdir -p $CONFIGFS_DIR/chip/bank/line4/hog\nenable_chip chip\n$BASE_DIR/gpio-mockup-cdev -s 1 /dev/`configfs_chip_name chip bank` 4 2> /dev/null && \\\n\tfail \"Setting the value of a hogged line shouldn't succeed\"\nremove_chip chip\n\necho \"3. Controlling simulated chips\"\n\necho \"3.1. Pull can be set over sysfs\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 8\nenable_chip chip\nsysfs_set_pull chip bank 0 pull-up\n$BASE_DIR/gpio-mockup-cdev /dev/`configfs_chip_name chip bank` 0\ntest \"$?\" = \"1\" || fail \"pull set incorrectly\"\nsysfs_set_pull chip bank 0 pull-down\n$BASE_DIR/gpio-mockup-cdev /dev/`configfs_chip_name chip bank` 1\ntest \"$?\" = \"0\" || fail \"pull set incorrectly\"\nremove_chip chip\n\necho \"3.2. Pull can be read from sysfs\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 8\nenable_chip chip\nDEVNAME=`configfs_dev_name chip`\nCHIPNAME=`configfs_chip_name chip bank`\nSYSFS_PATH=/sys/devices/platform/$DEVNAME/$CHIPNAME/sim_gpio0/pull\ntest `cat $SYSFS_PATH` = \"pull-down\" || fail \"reading the pull failed\"\nsysfs_set_pull chip bank 0 pull-up\ntest `cat $SYSFS_PATH` = \"pull-up\" || fail \"reading the pull failed\"\nremove_chip chip\n\necho \"3.3. Incorrect input in sysfs is rejected\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 8\nenable_chip chip\nDEVNAME=`configfs_dev_name chip`\nCHIPNAME=`configfs_chip_name chip bank`\nSYSFS_PATH=\"/sys/devices/platform/$DEVNAME/$CHIPNAME/sim_gpio0/pull\"\necho foobar > $SYSFS_PATH 2> /dev/null && fail \"invalid input not detected\"\nremove_chip chip\n\necho \"3.4. Can't write to value\"\ncreate_chip chip\ncreate_bank chip bank\nenable_chip chip\nDEVNAME=`configfs_dev_name chip`\nCHIPNAME=`configfs_chip_name chip bank`\nSYSFS_PATH=\"/sys/devices/platform/$DEVNAME/$CHIPNAME/sim_gpio0/value\"\necho 1 > $SYSFS_PATH 2> /dev/null && fail \"writing to 'value' succeeded unexpectedly\"\nremove_chip chip\n\necho \"4. Simulated GPIO chips are functional\"\n\necho \"4.1. Values can be read from sysfs\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 8\nenable_chip chip\nDEVNAME=`configfs_dev_name chip`\nCHIPNAME=`configfs_chip_name chip bank`\nSYSFS_PATH=\"/sys/devices/platform/$DEVNAME/$CHIPNAME/sim_gpio0/value\"\ntest `cat $SYSFS_PATH` = \"0\" || fail \"incorrect value read from sysfs\"\n$BASE_DIR/gpio-mockup-cdev -s 1 /dev/`configfs_chip_name chip bank` 0 &\nsleep 0.1 # FIXME Any better way?\ntest `cat $SYSFS_PATH` = \"1\" || fail \"incorrect value read from sysfs\"\nkill $!\nremove_chip chip\n\necho \"4.2. Bias settings work correctly\"\ncreate_chip chip\ncreate_bank chip bank\nset_num_lines chip bank 8\nenable_chip chip\nDEVNAME=`configfs_dev_name chip`\nCHIPNAME=`configfs_chip_name chip bank`\nSYSFS_PATH=\"/sys/devices/platform/$DEVNAME/$CHIPNAME/sim_gpio0/value\"\n$BASE_DIR/gpio-mockup-cdev -b pull-up /dev/`configfs_chip_name chip bank` 0\ntest `cat $SYSFS_PATH` = \"1\" || fail \"bias setting does not work\"\nremove_chip chip\n\necho \"GPIO $MODULE test PASS\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}