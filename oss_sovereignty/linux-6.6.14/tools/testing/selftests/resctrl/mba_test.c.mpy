{
  "module_name": "mba_test.c",
  "hash_id": "4f1b2f4ecd2bf280cbd9ddc460e6d3bf18de245c9301797c879530d3bf56add7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/resctrl/mba_test.c",
  "human_readable_source": "\n \n#include \"resctrl.h\"\n\n#define RESULT_FILE_NAME\t\"result_mba\"\n#define NUM_OF_RUNS\t\t5\n#define MAX_DIFF_PERCENT\t8\n#define ALLOCATION_MAX\t\t100\n#define ALLOCATION_MIN\t\t10\n#define ALLOCATION_STEP\t\t10\n\n \nstatic int mba_setup(struct resctrl_val_param *p)\n{\n\tstatic int runs_per_allocation, allocation = 100;\n\tchar allocation_str[64];\n\tint ret;\n\n\tif (runs_per_allocation >= NUM_OF_RUNS)\n\t\truns_per_allocation = 0;\n\n\t \n\tif (runs_per_allocation++ != 0)\n\t\treturn 0;\n\n\tif (allocation < ALLOCATION_MIN || allocation > ALLOCATION_MAX)\n\t\treturn END_OF_TESTS;\n\n\tsprintf(allocation_str, \"%d\", allocation);\n\n\tret = write_schemata(p->ctrlgrp, allocation_str, p->cpu_no,\n\t\t\t     p->resctrl_val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tallocation -= ALLOCATION_STEP;\n\n\treturn 0;\n}\n\nstatic bool show_mba_info(unsigned long *bw_imc, unsigned long *bw_resc)\n{\n\tint allocation, runs;\n\tbool ret = false;\n\n\tksft_print_msg(\"Results are displayed in (MB)\\n\");\n\t \n\tfor (allocation = 0; allocation < ALLOCATION_MAX / ALLOCATION_STEP;\n\t     allocation++) {\n\t\tunsigned long avg_bw_imc, avg_bw_resc;\n\t\tunsigned long sum_bw_imc = 0, sum_bw_resc = 0;\n\t\tint avg_diff_per;\n\t\tfloat avg_diff;\n\n\t\t \n\t\tfor (runs = NUM_OF_RUNS * allocation + 1;\n\t\t     runs < NUM_OF_RUNS * allocation + NUM_OF_RUNS ; runs++) {\n\t\t\tsum_bw_imc += bw_imc[runs];\n\t\t\tsum_bw_resc += bw_resc[runs];\n\t\t}\n\n\t\tavg_bw_imc = sum_bw_imc / (NUM_OF_RUNS - 1);\n\t\tavg_bw_resc = sum_bw_resc / (NUM_OF_RUNS - 1);\n\t\tavg_diff = (float)labs(avg_bw_resc - avg_bw_imc) / avg_bw_imc;\n\t\tavg_diff_per = (int)(avg_diff * 100);\n\n\t\tksft_print_msg(\"%s Check MBA diff within %d%% for schemata %u\\n\",\n\t\t\t       avg_diff_per > MAX_DIFF_PERCENT ?\n\t\t\t       \"Fail:\" : \"Pass:\",\n\t\t\t       MAX_DIFF_PERCENT,\n\t\t\t       ALLOCATION_MAX - ALLOCATION_STEP * allocation);\n\n\t\tksft_print_msg(\"avg_diff_per: %d%%\\n\", avg_diff_per);\n\t\tksft_print_msg(\"avg_bw_imc: %lu\\n\", avg_bw_imc);\n\t\tksft_print_msg(\"avg_bw_resc: %lu\\n\", avg_bw_resc);\n\t\tif (avg_diff_per > MAX_DIFF_PERCENT)\n\t\t\tret = true;\n\t}\n\n\tksft_print_msg(\"%s Check schemata change using MBA\\n\",\n\t\t       ret ? \"Fail:\" : \"Pass:\");\n\tif (ret)\n\t\tksft_print_msg(\"At least one test failed\\n\");\n\n\treturn ret;\n}\n\nstatic int check_results(void)\n{\n\tchar *token_array[8], output[] = RESULT_FILE_NAME, temp[512];\n\tunsigned long bw_imc[1024], bw_resc[1024];\n\tint runs;\n\tFILE *fp;\n\n\tfp = fopen(output, \"r\");\n\tif (!fp) {\n\t\tperror(output);\n\n\t\treturn errno;\n\t}\n\n\truns = 0;\n\twhile (fgets(temp, sizeof(temp), fp)) {\n\t\tchar *token = strtok(temp, \":\\t\");\n\t\tint fields = 0;\n\n\t\twhile (token) {\n\t\t\ttoken_array[fields++] = token;\n\t\t\ttoken = strtok(NULL, \":\\t\");\n\t\t}\n\n\t\t \n\t\tbw_imc[runs] = strtoul(token_array[3], NULL, 0);\n\t\t \n\t\tbw_resc[runs] = strtoul(token_array[5], NULL, 0);\n\t\truns++;\n\t}\n\n\tfclose(fp);\n\n\treturn show_mba_info(bw_imc, bw_resc);\n}\n\nvoid mba_test_cleanup(void)\n{\n\tremove(RESULT_FILE_NAME);\n}\n\nint mba_schemata_change(int cpu_no, const char * const *benchmark_cmd)\n{\n\tstruct resctrl_val_param param = {\n\t\t.resctrl_val\t= MBA_STR,\n\t\t.ctrlgrp\t= \"c1\",\n\t\t.mongrp\t\t= \"m1\",\n\t\t.cpu_no\t\t= cpu_no,\n\t\t.filename\t= RESULT_FILE_NAME,\n\t\t.bw_report\t= \"reads\",\n\t\t.setup\t\t= mba_setup\n\t};\n\tint ret;\n\n\tremove(RESULT_FILE_NAME);\n\n\tret = resctrl_val(benchmark_cmd, &param);\n\tif (ret)\n\t\tgoto out;\n\n\tret = check_results();\n\nout:\n\tmba_test_cleanup();\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}