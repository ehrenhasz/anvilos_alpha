{
  "module_name": "tpidr2_siginfo.c",
  "hash_id": "9d8f92f3ac0c0e353377bf72af6260753f2479b7e2e5a1272867d7e00325439a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/arm64/signal/testcases/tpidr2_siginfo.c",
  "human_readable_source": "\n \n\n#include <signal.h>\n#include <ucontext.h>\n#include <sys/auxv.h>\n#include <sys/prctl.h>\n#include <unistd.h>\n#include <asm/sigcontext.h>\n\n#include \"test_signals_utils.h\"\n#include \"testcases.h\"\n\nstatic union {\n\tucontext_t uc;\n\tchar buf[1024 * 128];\n} context;\n\n#define SYS_TPIDR2 \"S3_3_C13_C0_5\"\n\nstatic uint64_t get_tpidr2(void)\n{\n\tuint64_t val;\n\n\tasm volatile (\n\t\t\"mrs\t%0, \" SYS_TPIDR2 \"\\n\"\n\t\t: \"=r\"(val)\n\t\t:\n\t\t: \"cc\");\n\n\treturn val;\n}\n\nint tpidr2_present(struct tdescr *td, siginfo_t *si, ucontext_t *uc)\n{\n\tstruct _aarch64_ctx *head = GET_BUF_RESV_HEAD(context);\n\tstruct tpidr2_context *tpidr2_ctx;\n\tsize_t offset;\n\tbool in_sigframe;\n\tbool have_sme;\n\t__u64 orig_tpidr2;\n\n\thave_sme = getauxval(AT_HWCAP2) & HWCAP2_SME;\n\tif (have_sme)\n\t\torig_tpidr2 = get_tpidr2();\n\n\tif (!get_current_context(td, &context.uc, sizeof(context)))\n\t\treturn 1;\n\n\ttpidr2_ctx = (struct tpidr2_context *)\n\t\tget_header(head, TPIDR2_MAGIC, td->live_sz, &offset);\n\n\tin_sigframe = tpidr2_ctx != NULL;\n\n\tfprintf(stderr, \"TPIDR2 sigframe %s on system %s SME\\n\",\n\t\tin_sigframe ? \"present\" : \"absent\",\n\t\thave_sme ? \"with\" : \"without\");\n\n\ttd->pass = (in_sigframe == have_sme);\n\n\t \n\tif (have_sme && tpidr2_ctx) {\n\t\tif (tpidr2_ctx->tpidr2 != orig_tpidr2) {\n\t\t\tfprintf(stderr, \"TPIDR2 in frame is %llx, was %llx\\n\",\n\t\t\t\ttpidr2_ctx->tpidr2, orig_tpidr2);\n\t\t\ttd->pass = false;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstruct tdescr tde = {\n\t.name = \"TPIDR2\",\n\t.descr = \"Validate that TPIDR2 is present as expected\",\n\t.timeout = 3,\n\t.run = tpidr2_present,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}