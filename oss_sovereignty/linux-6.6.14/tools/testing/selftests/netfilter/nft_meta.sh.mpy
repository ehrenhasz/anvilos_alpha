{
  "module_name": "nft_meta.sh",
  "hash_id": "64d0d50015c2d6d7a56913e01483e7a0d67fa373bb0afe5f622229e5d7965027",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/nft_meta.sh",
  "human_readable_source": "#!/bin/bash\n\n# check iif/iifname/oifgroup/iiftype match.\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\nsfx=$(mktemp -u \"XXXXXXXX\")\nns0=\"ns0-$sfx\"\n\nif ! nft --version > /dev/null 2>&1; then\n\techo \"SKIP: Could not run test without nft tool\"\n\texit $ksft_skip\nfi\n\ncleanup()\n{\n\tip netns del \"$ns0\"\n}\n\nip netns add \"$ns0\"\nip -net \"$ns0\" link set lo up\nip -net \"$ns0\" addr add 127.0.0.1 dev lo\n\ntrap cleanup EXIT\n\ncurrentyear=$(date +%Y)\nlastyear=$((currentyear-1))\nip netns exec \"$ns0\" nft -f /dev/stdin <<EOF\ntable inet filter {\n\tcounter iifcount {}\n\tcounter iifnamecount {}\n\tcounter iifgroupcount {}\n\tcounter iiftypecount {}\n\tcounter infproto4count {}\n\tcounter il4protocounter {}\n\tcounter imarkcounter {}\n\tcounter icpu0counter {}\n\tcounter ilastyearcounter {}\n\tcounter icurrentyearcounter {}\n\n\tcounter oifcount {}\n\tcounter oifnamecount {}\n\tcounter oifgroupcount {}\n\tcounter oiftypecount {}\n\tcounter onfproto4count {}\n\tcounter ol4protocounter {}\n\tcounter oskuidcounter {}\n\tcounter oskgidcounter {}\n\tcounter omarkcounter {}\n\n\tchain input {\n\t\ttype filter hook input priority 0; policy accept;\n\n\t\tmeta iif lo counter name \"iifcount\"\n\t\tmeta iifname \"lo\" counter name \"iifnamecount\"\n\t\tmeta iifgroup \"default\" counter name \"iifgroupcount\"\n\t\tmeta iiftype \"loopback\" counter name \"iiftypecount\"\n\t\tmeta nfproto ipv4 counter name \"infproto4count\"\n\t\tmeta l4proto icmp counter name \"il4protocounter\"\n\t\tmeta mark 42 counter name \"imarkcounter\"\n\t\tmeta cpu 0 counter name \"icpu0counter\"\n\t\tmeta time \"$lastyear-01-01\" - \"$lastyear-12-31\" counter name ilastyearcounter\n\t\tmeta time \"$currentyear-01-01\" - \"$currentyear-12-31\" counter name icurrentyearcounter\n\t}\n\n\tchain output {\n\t\ttype filter hook output priority 0; policy accept;\n\t\tmeta oif lo counter name \"oifcount\" counter\n\t\tmeta oifname \"lo\" counter name \"oifnamecount\"\n\t\tmeta oifgroup \"default\" counter name \"oifgroupcount\"\n\t\tmeta oiftype \"loopback\" counter name \"oiftypecount\"\n\t\tmeta nfproto ipv4 counter name \"onfproto4count\"\n\t\tmeta l4proto icmp counter name \"ol4protocounter\"\n\t\tmeta skuid 0 counter name \"oskuidcounter\"\n\t\tmeta skgid 0 counter name \"oskgidcounter\"\n\t\tmeta mark 42 counter name \"omarkcounter\"\n\t}\n}\nEOF\n\nif [ $? -ne 0 ]; then\n\techo \"SKIP: Could not add test ruleset\"\n\texit $ksft_skip\nfi\n\nret=0\n\ncheck_one_counter()\n{\n\tlocal cname=\"$1\"\n\tlocal want=\"packets $2\"\n\tlocal verbose=\"$3\"\n\n\tif ! ip netns exec \"$ns0\" nft list counter inet filter $cname | grep -q \"$want\"; then\n\t\techo \"FAIL: $cname, want \\\"$want\\\", got\"\n\t\tret=1\n\t\tip netns exec \"$ns0\" nft list counter inet filter $cname\n\tfi\n}\n\ncheck_lo_counters()\n{\n\tlocal want=\"$1\"\n\tlocal verbose=\"$2\"\n\tlocal counter\n\n\tfor counter in iifcount iifnamecount iifgroupcount iiftypecount infproto4count \\\n\t\t       oifcount oifnamecount oifgroupcount oiftypecount onfproto4count \\\n\t\t       il4protocounter icurrentyearcounter ol4protocounter \\\n\t     ; do\n\t\tcheck_one_counter \"$counter\" \"$want\" \"$verbose\"\n\tdone\n}\n\ncheck_lo_counters \"0\" false\nip netns exec \"$ns0\" ping -q -c 1 127.0.0.1 -m 42 > /dev/null\n\ncheck_lo_counters \"2\" true\n\ncheck_one_counter oskuidcounter \"1\" true\ncheck_one_counter oskgidcounter \"1\" true\ncheck_one_counter imarkcounter \"1\" true\ncheck_one_counter omarkcounter \"1\" true\ncheck_one_counter ilastyearcounter \"0\" true\n\nif [ $ret -eq 0 ];then\n\techo \"OK: nftables meta iif/oif counters at expected values\"\nelse\n\texit $ret\nfi\n\n#First CPU execution and counter\ntaskset -p 01 $$ > /dev/null\nip netns exec \"$ns0\" nft reset counters > /dev/null\nip netns exec \"$ns0\" ping -q -c 1 127.0.0.1 > /dev/null\ncheck_one_counter icpu0counter \"2\" true\n\nif [ $ret -eq 0 ];then\n\techo \"OK: nftables meta cpu counter at expected values\"\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}