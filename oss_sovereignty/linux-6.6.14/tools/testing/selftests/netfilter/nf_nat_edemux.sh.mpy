{
  "module_name": "nf_nat_edemux.sh",
  "hash_id": "ea08063a4184562ea8bb4d1ed12f20a0887346b304dfe36465e29eadc4e2ea50",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/nf_nat_edemux.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Test NAT source port clash resolution\n#\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\nret=0\n\nsfx=$(mktemp -u \"XXXXXXXX\")\nns1=\"ns1-$sfx\"\nns2=\"ns2-$sfx\"\n\ncleanup()\n{\n\tip netns del $ns1\n\tip netns del $ns2\n}\n\niperf3 -v > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without iperf3\"\n\texit $ksft_skip\nfi\n\niptables --version > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without iptables\"\n\texit $ksft_skip\nfi\n\nip -Version > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nip netns add \"$ns1\"\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not create net namespace $ns1\"\n\texit $ksft_skip\nfi\n\ntrap cleanup EXIT\n\nip netns add $ns2\n\n# Connect the namespaces using a veth pair\nip link add name veth2 type veth peer name veth1\nip link set netns $ns1 dev veth1\nip link set netns $ns2 dev veth2\n\nip netns exec $ns1 ip link set up dev lo\nip netns exec $ns1 ip link set up dev veth1\nip netns exec $ns1 ip addr add 192.168.1.1/24 dev veth1\n\nip netns exec $ns2 ip link set up dev lo\nip netns exec $ns2 ip link set up dev veth2\nip netns exec $ns2 ip addr add 192.168.1.2/24 dev veth2\n\n# Create a server in one namespace\nip netns exec $ns1 iperf3 -s > /dev/null 2>&1 &\niperfs=$!\n\n# Restrict source port to just one so we don't have to exhaust\n# all others.\nip netns exec $ns2 sysctl -q net.ipv4.ip_local_port_range=\"10000 10000\"\n\n# add a virtual IP using DNAT\nip netns exec $ns2 iptables -t nat -A OUTPUT -d 10.96.0.1/32 -p tcp --dport 443 -j DNAT --to-destination 192.168.1.1:5201\n\n# ... and route it to the other namespace\nip netns exec $ns2 ip route add 10.96.0.1 via 192.168.1.1\n\nsleep 1\n\n# add a persistent connection from the other namespace\nip netns exec $ns2 socat -t 10 - TCP:192.168.1.1:5201 > /dev/null &\n\nsleep 1\n\n# ip daddr:dport will be rewritten to 192.168.1.1 5201\n# NAT must reallocate source port 10000 because\n# 192.168.1.2:10000 -> 192.168.1.1:5201 is already in use\necho test | ip netns exec $ns2 socat -t 3 -u STDIN TCP:10.96.0.1:443 >/dev/null\nret=$?\n\nkill $iperfs\n\n# Check socat can connect to 10.96.0.1:443 (aka 192.168.1.1:5201).\nif [ $ret -eq 0 ]; then\n\techo \"PASS: socat can connect via NAT'd address\"\nelse\n\techo \"FAIL: socat cannot connect via NAT'd address\"\n\texit 1\nfi\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}