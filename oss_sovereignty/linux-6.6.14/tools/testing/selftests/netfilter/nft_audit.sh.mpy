{
  "module_name": "nft_audit.sh",
  "hash_id": "852d45af3b36e9e71be6bb2448d7a3ab544f082f0401c64c1687624a4c94d1f7",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/nft_audit.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Check that audit logs generated for nft commands are as expected.\n\nSKIP_RC=4\nRC=0\n\nnft --version >/dev/null 2>&1 || {\n\techo \"SKIP: missing nft tool\"\n\texit $SKIP_RC\n}\n\n# Run everything in a separate network namespace\n[ \"${1}\" != \"run\" ] && { unshare -n \"${0}\" run; exit $?; }\n\n# give other scripts a chance to finish - audit_logread sees all activity\nsleep 1\n\nlogfile=$(mktemp)\nrulefile=$(mktemp)\necho \"logging into $logfile\"\n./audit_logread >\"$logfile\" &\nlogread_pid=$!\ntrap 'kill $logread_pid; rm -f $logfile $rulefile' EXIT\nexec 3<\"$logfile\"\n\ndo_test() { # (cmd, log)\n\techo -n \"testing for cmd: $1 ... \"\n\tcat <&3 >/dev/null\n\t$1 >/dev/null || exit 1\n\tsleep 0.1\n\tres=$(diff -a -u <(echo \"$2\") - <&3)\n\t[ $? -eq 0 ] && { echo \"OK\"; return; }\n\techo \"FAIL\"\n\tgrep -v '^\\(---\\|+++\\|@@\\)' <<< \"$res\"\n\t((RC--))\n}\n\nnft flush ruleset\n\n# adding tables, chains and rules\n\nfor table in t1 t2; do\n\tdo_test \"nft add table $table\" \\\n\t\"table=$table family=2 entries=1 op=nft_register_table\"\n\n\tdo_test \"nft add chain $table c1\" \\\n\t\"table=$table family=2 entries=1 op=nft_register_chain\"\n\n\tdo_test \"nft add chain $table c2; add chain $table c3\" \\\n\t\"table=$table family=2 entries=2 op=nft_register_chain\"\n\n\tcmd=\"add rule $table c1 counter\"\n\n\tdo_test \"nft $cmd\" \\\n\t\"table=$table family=2 entries=1 op=nft_register_rule\"\n\n\tdo_test \"nft $cmd; $cmd\" \\\n\t\"table=$table family=2 entries=2 op=nft_register_rule\"\n\n\tcmd=\"\"\n\tsep=\"\"\n\tfor chain in c2 c3; do\n\t\tfor i in {1..3}; do\n\t\t\tcmd+=\"$sep add rule $table $chain counter\"\n\t\t\tsep=\";\"\n\t\tdone\n\tdone\n\tdo_test \"nft $cmd\" \\\n\t\"table=$table family=2 entries=6 op=nft_register_rule\"\ndone\n\nfor ((i = 0; i < 500; i++)); do\n\techo \"add rule t2 c3 counter accept comment \\\"rule $i\\\"\"\ndone >$rulefile\ndo_test \"nft -f $rulefile\" \\\n'table=t2 family=2 entries=500 op=nft_register_rule'\n\n# adding sets and elements\n\nsettype='type inet_service; counter'\nsetelem='{ 22, 80, 443 }'\nsetblock=\"{ $settype; elements = $setelem; }\"\ndo_test \"nft add set t1 s $setblock\" \\\n\"table=t1 family=2 entries=4 op=nft_register_set\"\n\ndo_test \"nft add set t1 s2 $setblock; add set t1 s3 { $settype; }\" \\\n\"table=t1 family=2 entries=5 op=nft_register_set\"\n\ndo_test \"nft add element t1 s3 $setelem\" \\\n\"table=t1 family=2 entries=3 op=nft_register_setelem\"\n\n# adding counters\n\ndo_test 'nft add counter t1 c1' \\\n'table=t1 family=2 entries=1 op=nft_register_obj'\n\ndo_test 'nft add counter t2 c1; add counter t2 c2' \\\n'table=t2 family=2 entries=2 op=nft_register_obj'\n\nfor ((i = 3; i <= 500; i++)); do\n\techo \"add counter t2 c$i\"\ndone >$rulefile\ndo_test \"nft -f $rulefile\" \\\n'table=t2 family=2 entries=498 op=nft_register_obj'\n\n# adding/updating quotas\n\ndo_test 'nft add quota t1 q1 { 10 bytes }' \\\n'table=t1 family=2 entries=1 op=nft_register_obj'\n\ndo_test 'nft add quota t2 q1 { 10 bytes }; add quota t2 q2 { 10 bytes }' \\\n'table=t2 family=2 entries=2 op=nft_register_obj'\n\nfor ((i = 3; i <= 500; i++)); do\n\techo \"add quota t2 q$i { 10 bytes }\"\ndone >$rulefile\ndo_test \"nft -f $rulefile\" \\\n'table=t2 family=2 entries=498 op=nft_register_obj'\n\n# changing the quota value triggers obj update path\ndo_test 'nft add quota t1 q1 { 20 bytes }' \\\n'table=t1 family=2 entries=1 op=nft_register_obj'\n\n# resetting rules\n\ndo_test 'nft reset rules t1 c2' \\\n'table=t1 family=2 entries=3 op=nft_reset_rule'\n\ndo_test 'nft reset rules table t1' \\\n'table=t1 family=2 entries=3 op=nft_reset_rule\ntable=t1 family=2 entries=3 op=nft_reset_rule\ntable=t1 family=2 entries=3 op=nft_reset_rule'\n\ndo_test 'nft reset rules t2 c3' \\\n'table=t2 family=2 entries=189 op=nft_reset_rule\ntable=t2 family=2 entries=188 op=nft_reset_rule\ntable=t2 family=2 entries=126 op=nft_reset_rule'\n\ndo_test 'nft reset rules t2' \\\n'table=t2 family=2 entries=3 op=nft_reset_rule\ntable=t2 family=2 entries=3 op=nft_reset_rule\ntable=t2 family=2 entries=186 op=nft_reset_rule\ntable=t2 family=2 entries=188 op=nft_reset_rule\ntable=t2 family=2 entries=129 op=nft_reset_rule'\n\ndo_test 'nft reset rules' \\\n'table=t1 family=2 entries=3 op=nft_reset_rule\ntable=t1 family=2 entries=3 op=nft_reset_rule\ntable=t1 family=2 entries=3 op=nft_reset_rule\ntable=t2 family=2 entries=3 op=nft_reset_rule\ntable=t2 family=2 entries=3 op=nft_reset_rule\ntable=t2 family=2 entries=180 op=nft_reset_rule\ntable=t2 family=2 entries=188 op=nft_reset_rule\ntable=t2 family=2 entries=135 op=nft_reset_rule'\n\n# resetting sets and elements\n\nelem=(22 ,80 ,443)\nrelem=\"\"\nfor i in {1..3}; do\n\trelem+=\"${elem[((i - 1))]}\"\n\tdo_test \"nft reset element t1 s { $relem }\" \\\n\t\"table=t1 family=2 entries=$i op=nft_reset_setelem\"\ndone\n\ndo_test 'nft reset set t1 s' \\\n'table=t1 family=2 entries=3 op=nft_reset_setelem'\n\n# resetting counters\n\ndo_test 'nft reset counter t1 c1' \\\n'table=t1 family=2 entries=1 op=nft_reset_obj'\n\ndo_test 'nft reset counters t1' \\\n'table=t1 family=2 entries=1 op=nft_reset_obj'\n\ndo_test 'nft reset counters t2' \\\n'table=t2 family=2 entries=342 op=nft_reset_obj\ntable=t2 family=2 entries=158 op=nft_reset_obj'\n\ndo_test 'nft reset counters' \\\n'table=t1 family=2 entries=1 op=nft_reset_obj\ntable=t2 family=2 entries=341 op=nft_reset_obj\ntable=t2 family=2 entries=159 op=nft_reset_obj'\n\n# resetting quotas\n\ndo_test 'nft reset quota t1 q1' \\\n'table=t1 family=2 entries=1 op=nft_reset_obj'\n\ndo_test 'nft reset quotas t1' \\\n'table=t1 family=2 entries=1 op=nft_reset_obj'\n\ndo_test 'nft reset quotas t2' \\\n'table=t2 family=2 entries=315 op=nft_reset_obj\ntable=t2 family=2 entries=185 op=nft_reset_obj'\n\ndo_test 'nft reset quotas' \\\n'table=t1 family=2 entries=1 op=nft_reset_obj\ntable=t2 family=2 entries=314 op=nft_reset_obj\ntable=t2 family=2 entries=186 op=nft_reset_obj'\n\n# deleting rules\n\nreadarray -t handles < <(nft -a list chain t1 c1 | \\\n\t\t\t sed -n 's/.*counter.* handle \\(.*\\)$/\\1/p')\n\ndo_test \"nft delete rule t1 c1 handle ${handles[0]}\" \\\n'table=t1 family=2 entries=1 op=nft_unregister_rule'\n\ncmd='delete rule t1 c1 handle'\ndo_test \"nft $cmd ${handles[1]}; $cmd ${handles[2]}\" \\\n'table=t1 family=2 entries=2 op=nft_unregister_rule'\n\ndo_test 'nft flush chain t1 c2' \\\n'table=t1 family=2 entries=3 op=nft_unregister_rule'\n\ndo_test 'nft flush table t2' \\\n'table=t2 family=2 entries=509 op=nft_unregister_rule'\n\n# deleting chains\n\ndo_test 'nft delete chain t2 c2' \\\n'table=t2 family=2 entries=1 op=nft_unregister_chain'\n\n# deleting sets and elements\n\ndo_test 'nft delete element t1 s { 22 }' \\\n'table=t1 family=2 entries=1 op=nft_unregister_setelem'\n\ndo_test 'nft delete element t1 s { 80, 443 }' \\\n'table=t1 family=2 entries=2 op=nft_unregister_setelem'\n\ndo_test 'nft flush set t1 s2' \\\n'table=t1 family=2 entries=3 op=nft_unregister_setelem'\n\ndo_test 'nft delete set t1 s2' \\\n'table=t1 family=2 entries=1 op=nft_unregister_set'\n\ndo_test 'nft delete set t1 s3' \\\n'table=t1 family=2 entries=1 op=nft_unregister_set'\n\nexit $RC\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}