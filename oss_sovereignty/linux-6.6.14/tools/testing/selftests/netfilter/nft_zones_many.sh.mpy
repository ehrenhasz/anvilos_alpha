{
  "module_name": "nft_zones_many.sh",
  "hash_id": "c43e4d01911dc9b3725f01f5d1e975892ee25ab247909af89bb303e1ced0dd7f",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/nft_zones_many.sh",
  "human_readable_source": "#!/bin/bash\n\n# Test insertion speed for packets with identical addresses/ports\n# that are all placed in distinct conntrack zones.\n\nsfx=$(mktemp -u \"XXXXXXXX\")\nns=\"ns-$sfx\"\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nzones=2000\nhave_ct_tool=0\nret=0\n\ncleanup()\n{\n\tip netns del $ns\n}\n\nchecktool (){\n\tif ! $1 > /dev/null 2>&1; then\n\t\techo \"SKIP: Could not $2\"\n\t\texit $ksft_skip\n\tfi\n}\n\nchecktool \"nft --version\" \"run test without nft tool\"\nchecktool \"ip -Version\" \"run test without ip tool\"\nchecktool \"socat -V\" \"run test without socat tool\"\nchecktool \"ip netns add $ns\" \"create net namespace\"\n\ntrap cleanup EXIT\n\nconntrack -V > /dev/null 2>&1\nif [ $? -eq 0 ];then\n\thave_ct_tool=1\nfi\n\nip -net \"$ns\" link set lo up\n\ntest_zones() {\n\tlocal max_zones=$1\n\nip netns exec $ns sysctl -q net.netfilter.nf_conntrack_udp_timeout=3600\nip netns exec $ns nft -f /dev/stdin<<EOF\nflush ruleset\ntable inet raw {\n\tmap rndzone {\n\t\ttypeof numgen inc mod $max_zones : ct zone\n\t}\n\n\tchain output {\n\t\ttype filter hook output priority -64000; policy accept;\n\t\tudp dport 12345  ct zone set numgen inc mod 65536 map @rndzone\n\t}\n}\nEOF\n\t(\n\t\techo \"add element inet raw rndzone {\"\n\tfor i in $(seq 1 $max_zones);do\n\t\techo -n \"$i : $i\"\n\t\tif [ $i -lt $max_zones ]; then\n\t\t\techo \",\"\n\t\telse\n\t\t\techo \"}\"\n\t\tfi\n\tdone\n\t) | ip netns exec $ns nft -f /dev/stdin\n\n\tlocal i=0\n\tlocal j=0\n\tlocal outerstart=$(date +%s%3N)\n\tlocal stop=$outerstart\n\n\twhile [ $i -lt $max_zones ]; do\n\t\tlocal start=$(date +%s%3N)\n\t\ti=$((i + 1000))\n\t\tj=$((j + 1))\n\t\t# nft rule in output places each packet in a different zone.\n\t\tdd if=/dev/zero of=/dev/stdout bs=8k count=1000 2>/dev/null | ip netns exec \"$ns\" socat STDIN UDP:127.0.0.1:12345,sourceport=12345\n\t\tif [ $? -ne 0 ] ;then\n\t\t\tret=1\n\t\t\tbreak\n\t\tfi\n\n\t\tstop=$(date +%s%3N)\n\t\tlocal duration=$((stop-start))\n\t\techo \"PASS: added 1000 entries in $duration ms (now $i total, loop $j)\"\n\tdone\n\n\tif [ $have_ct_tool -eq 1 ]; then\n\t\tlocal count=$(ip netns exec \"$ns\" conntrack -C)\n\t\tlocal duration=$((stop-outerstart))\n\n\t\tif [ $count -eq $max_zones ]; then\n\t\t\techo \"PASS: inserted $count entries from packet path in $duration ms total\"\n\t\telse\n\t\t\tip netns exec $ns conntrack -S 1>&2\n\t\t\techo \"FAIL: inserted $count entries from packet path in $duration ms total, expected $max_zones entries\"\n\t\t\tret=1\n\t\tfi\n\tfi\n\n\tif [ $ret -ne 0 ];then\n\t\techo \"FAIL: insert $max_zones entries from packet path\" 1>&2\n\tfi\n}\n\ntest_conntrack_tool() {\n\tlocal max_zones=$1\n\n\tip netns exec $ns conntrack -F >/dev/null 2>/dev/null\n\n\tlocal outerstart=$(date +%s%3N)\n\tlocal start=$(date +%s%3N)\n\tlocal stop=$start\n\tlocal i=0\n\twhile [ $i -lt $max_zones ]; do\n\t\ti=$((i + 1))\n\t\tip netns exec \"$ns\" conntrack -I -s 1.1.1.1 -d 2.2.2.2 --protonum 6 \\\n\t                 --timeout 3600 --state ESTABLISHED --sport 12345 --dport 1000 --zone $i >/dev/null 2>&1\n\t\tif [ $? -ne 0 ];then\n\t\t\tip netns exec \"$ns\" conntrack -I -s 1.1.1.1 -d 2.2.2.2 --protonum 6 \\\n\t                 --timeout 3600 --state ESTABLISHED --sport 12345 --dport 1000 --zone $i > /dev/null\n\t\t\techo \"FAIL: conntrack -I returned an error\"\n\t\t\tret=1\n\t\t\tbreak\n\t\tfi\n\n\t\tif [ $((i%1000)) -eq 0 ];then\n\t\t\tstop=$(date +%s%3N)\n\n\t\t\tlocal duration=$((stop-start))\n\t\t\techo \"PASS: added 1000 entries in $duration ms (now $i total)\"\n\t\t\tstart=$stop\n\t\tfi\n\tdone\n\n\tlocal count=$(ip netns exec \"$ns\" conntrack -C)\n\tlocal duration=$((stop-outerstart))\n\n\tif [ $count -eq $max_zones ]; then\n\t\techo \"PASS: inserted $count entries via ctnetlink in $duration ms\"\n\telse\n\t\tip netns exec $ns conntrack -S 1>&2\n\t\techo \"FAIL: inserted $count entries via ctnetlink in $duration ms, expected $max_zones entries ($duration ms)\"\n\t\tret=1\n\tfi\n}\n\ntest_zones $zones\n\nif [ $have_ct_tool -eq 1 ];then\n\ttest_conntrack_tool $zones\nelse\n\techo \"SKIP: Could not run ctnetlink insertion test without conntrack tool\"\n\tif [ $ret -eq 0 ];then\n\t\texit $ksft_skip\n\tfi\nfi\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}