{
  "module_name": "nft_conntrack_helper.sh",
  "hash_id": "0824b3973241cafc4340fd3aeabb8fb04e433819782135db1aab7f9ec0613304",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/nft_conntrack_helper.sh",
  "human_readable_source": "#!/bin/bash\n#\n# This tests connection tracking helper assignment:\n# 1. can attach ftp helper to a connection from nft ruleset.\n# 2. auto-assign still works.\n#\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\nret=0\n\nsfx=$(mktemp -u \"XXXXXXXX\")\nns1=\"ns1-$sfx\"\nns2=\"ns2-$sfx\"\ntestipv6=1\n\ncleanup()\n{\n\tip netns del ${ns1}\n\tip netns del ${ns2}\n}\n\nnft --version > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without nft tool\"\n\texit $ksft_skip\nfi\n\nip -Version > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nconntrack -V > /dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without conntrack tool\"\n\texit $ksft_skip\nfi\n\nwhich nc >/dev/null 2>&1\nif [ $? -ne 0 ];then\n\techo \"SKIP: Could not run test without netcat tool\"\n\texit $ksft_skip\nfi\n\ntrap cleanup EXIT\n\nip netns add ${ns1}\nip netns add ${ns2}\n\nip link add veth0 netns ${ns1} type veth peer name veth0 netns ${ns2} > /dev/null 2>&1\nif [ $? -ne 0 ];then\n    echo \"SKIP: No virtual ethernet pair device support in kernel\"\n    exit $ksft_skip\nfi\n\nip -net ${ns1} link set lo up\nip -net ${ns1} link set veth0 up\n\nip -net ${ns2} link set lo up\nip -net ${ns2} link set veth0 up\n\nip -net ${ns1} addr add 10.0.1.1/24 dev veth0\nip -net ${ns1} addr add dead:1::1/64 dev veth0\n\nip -net ${ns2} addr add 10.0.1.2/24 dev veth0\nip -net ${ns2} addr add dead:1::2/64 dev veth0\n\nload_ruleset_family() {\n\tlocal family=$1\n\tlocal ns=$2\n\nip netns exec ${ns} nft -f - <<EOF\ntable $family raw {\n\tct helper ftp {\n             type \"ftp\" protocol tcp\n        }\n\tchain pre {\n\t\ttype filter hook prerouting priority 0; policy accept;\n\t\ttcp dport 2121 ct helper set \"ftp\"\n\t}\n\tchain output {\n\t\ttype filter hook output priority 0; policy accept;\n\t\ttcp dport 2121 ct helper set \"ftp\"\n\t}\n}\nEOF\n\treturn $?\n}\n\ncheck_for_helper()\n{\n\tlocal netns=$1\n\tlocal message=$2\n\tlocal port=$3\n\n\tif echo $message |grep -q 'ipv6';then\n\t\tlocal family=\"ipv6\"\n\telse\n\t\tlocal family=\"ipv4\"\n\tfi\n\n\tip netns exec ${netns} conntrack -L -f $family -p tcp --dport $port 2> /dev/null |grep -q 'helper=ftp'\n\tif [ $? -ne 0 ] ; then\n\t\tif [ $autoassign -eq 0 ] ;then\n\t\t\techo \"FAIL: ${netns} did not show attached helper $message\" 1>&2\n\t\t\tret=1\n\t\telse\n\t\t\techo \"PASS: ${netns} did not show attached helper $message\" 1>&2\n\t\tfi\n\telse\n\t\tif [ $autoassign -eq 0 ] ;then\n\t\t\techo \"PASS: ${netns} connection on port $port has ftp helper attached\" 1>&2\n\t\telse\n\t\t\techo \"FAIL: ${netns} connection on port $port has ftp helper attached\" 1>&2\n\t\t\tret=1\n\t\tfi\n\tfi\n\n\treturn 0\n}\n\ntest_helper()\n{\n\tlocal port=$1\n\tlocal autoassign=$2\n\n\tif [ $autoassign -eq 0 ] ;then\n\t\tmsg=\"set via ruleset\"\n\telse\n\t\tmsg=\"auto-assign\"\n\tfi\n\n\tsleep 3 | ip netns exec ${ns2} nc -w 2 -l -p $port > /dev/null &\n\n\tsleep 1 | ip netns exec ${ns1} nc -w 2 10.0.1.2 $port > /dev/null &\n\tsleep 1\n\n\tcheck_for_helper \"$ns1\" \"ip $msg\" $port $autoassign\n\tcheck_for_helper \"$ns2\" \"ip $msg\" $port $autoassign\n\n\twait\n\n\tif [ $testipv6 -eq 0 ] ;then\n\t\treturn 0\n\tfi\n\n\tip netns exec ${ns1} conntrack -F 2> /dev/null\n\tip netns exec ${ns2} conntrack -F 2> /dev/null\n\n\tsleep 3 | ip netns exec ${ns2} nc -w 2 -6 -l -p $port > /dev/null &\n\n\tsleep 1 | ip netns exec ${ns1} nc -w 2 -6 dead:1::2 $port > /dev/null &\n\tsleep 1\n\n\tcheck_for_helper \"$ns1\" \"ipv6 $msg\" $port\n\tcheck_for_helper \"$ns2\" \"ipv6 $msg\" $port\n\n\twait\n}\n\nload_ruleset_family ip ${ns1}\nif [ $? -ne 0 ];then\n\techo \"FAIL: ${ns1} cannot load ip ruleset\" 1>&2\n\texit 1\nfi\n\nload_ruleset_family ip6 ${ns1}\nif [ $? -ne 0 ];then\n\techo \"SKIP: ${ns1} cannot load ip6 ruleset\" 1>&2\n\ttestipv6=0\nfi\n\nload_ruleset_family inet ${ns2}\nif [ $? -ne 0 ];then\n\techo \"SKIP: ${ns1} cannot load inet ruleset\" 1>&2\n\tload_ruleset_family ip ${ns2}\n\tif [ $? -ne 0 ];then\n\t\techo \"FAIL: ${ns2} cannot load ip ruleset\" 1>&2\n\t\texit 1\n\tfi\n\n\tif [ $testipv6 -eq 1 ] ;then\n\t\tload_ruleset_family ip6 ${ns2}\n\t\tif [ $? -ne 0 ];then\n\t\t\techo \"FAIL: ${ns2} cannot load ip6 ruleset\" 1>&2\n\t\t\texit 1\n\t\tfi\n\tfi\nfi\n\ntest_helper 2121 0\nip netns exec ${ns1} sysctl -qe 'net.netfilter.nf_conntrack_helper=1'\nip netns exec ${ns2} sysctl -qe 'net.netfilter.nf_conntrack_helper=1'\ntest_helper 21 1\n\nexit $ret\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}