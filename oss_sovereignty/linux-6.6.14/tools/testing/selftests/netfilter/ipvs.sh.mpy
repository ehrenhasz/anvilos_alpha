{
  "module_name": "ipvs.sh",
  "hash_id": "5ccc7e539f04a84f794df382dde4b15637257c17f152c22064f46459eee52ab0",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/ipvs.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n#\n# End-to-end ipvs test suite\n# Topology:\n#--------------------------------------------------------------+\n#                      |                                       |\n#         ns0          |         ns1                           |\n#      -----------     |     -----------    -----------        |\n#      | veth01  | --------- | veth10  |    | veth12  |        |\n#      -----------    peer   -----------    -----------        |\n#           |          |                        |              |\n#      -----------     |                        |              |\n#      |  br0    |     |-----------------  peer |--------------|\n#      -----------     |                        |              |\n#           |          |                        |              |\n#      ----------     peer   ----------      -----------       |\n#      |  veth02 | --------- |  veth20 |     | veth21  |       |\n#      ----------      |     ----------      -----------       |\n#                      |         ns2                           |\n#                      |                                       |\n#--------------------------------------------------------------+\n#\n# We assume that all network driver are loaded\n#\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\nret=0\nGREEN='\\033[0;92m'\nRED='\\033[0;31m'\nNC='\\033[0m' # No Color\n\nreadonly port=8080\n\nreadonly vip_v4=207.175.44.110\nreadonly cip_v4=10.0.0.2\nreadonly gip_v4=10.0.0.1\nreadonly dip_v4=172.16.0.1\nreadonly rip_v4=172.16.0.2\nreadonly sip_v4=10.0.0.3\n\nreadonly infile=\"$(mktemp)\"\nreadonly outfile=\"$(mktemp)\"\nreadonly datalen=32\n\nsysipvsnet=\"/proc/sys/net/ipv4/vs/\"\nif [ ! -d $sysipvsnet ]; then\n\tmodprobe -q ip_vs\n\tif [ $? -ne 0 ]; then\n\t\techo \"skip: could not run test without ipvs module\"\n\t\texit $ksft_skip\n\tfi\nfi\n\nip -Version > /dev/null 2>&1\nif [ $? -ne 0 ]; then\n\techo \"SKIP: Could not run test without ip tool\"\n\texit $ksft_skip\nfi\n\nipvsadm -v > /dev/null 2>&1\nif [ $? -ne 0 ]; then\n\techo \"SKIP: Could not run test without ipvsadm\"\n\texit $ksft_skip\nfi\n\nsetup() {\n\tip netns add ns0\n\tip netns add ns1\n\tip netns add ns2\n\n\tip link add veth01 netns ns0 type veth peer name veth10 netns ns1\n\tip link add veth02 netns ns0 type veth peer name veth20 netns ns2\n\tip link add veth12 netns ns1 type veth peer name veth21 netns ns2\n\n\tip netns exec ns0 ip link set veth01 up\n\tip netns exec ns0 ip link set veth02 up\n\tip netns exec ns0 ip link add br0 type bridge\n\tip netns exec ns0 ip link set veth01 master br0\n\tip netns exec ns0 ip link set veth02 master br0\n\tip netns exec ns0 ip link set br0 up\n\tip netns exec ns0 ip addr add ${cip_v4}/24 dev br0\n\n\tip netns exec ns1 ip link set lo up\n\tip netns exec ns1 ip link set veth10 up\n\tip netns exec ns1 ip addr add ${gip_v4}/24 dev veth10\n\tip netns exec ns1 ip link set veth12 up\n\tip netns exec ns1 ip addr add ${dip_v4}/24 dev veth12\n\n\tip netns exec ns2 ip link set lo up\n\tip netns exec ns2 ip link set veth21 up\n\tip netns exec ns2 ip addr add ${rip_v4}/24 dev veth21\n\tip netns exec ns2 ip link set veth20 up\n\tip netns exec ns2 ip addr add ${sip_v4}/24 dev veth20\n\n\tsleep 1\n\n\tdd if=/dev/urandom of=\"${infile}\" bs=\"${datalen}\" count=1 status=none\n}\n\ncleanup() {\n\tfor i in 0 1 2\n\tdo\n\t\tip netns del ns$i > /dev/null 2>&1\n\tdone\n\n\tif [ -f \"${outfile}\" ]; then\n\t\trm \"${outfile}\"\n\tfi\n\tif [ -f \"${infile}\" ]; then\n\t\trm \"${infile}\"\n\tfi\n}\n\nserver_listen() {\n\tip netns exec ns2 nc -l -p 8080 > \"${outfile}\" &\n\tserver_pid=$!\n\tsleep 0.2\n}\n\nclient_connect() {\n\tip netns exec ns0 timeout 2 nc -w 1 ${vip_v4} ${port} < \"${infile}\"\n}\n\nverify_data() {\n\twait \"${server_pid}\"\n\tcmp \"$infile\" \"$outfile\" 2>/dev/null\n}\n\ntest_service() {\n\tserver_listen\n\tclient_connect\n\tverify_data\n}\n\n\ntest_dr() {\n\tip netns exec ns0 ip route add ${vip_v4} via ${gip_v4} dev br0\n\n\tip netns exec ns1 sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ns1 ipvsadm -A -t ${vip_v4}:${port} -s rr\n\tip netns exec ns1 ipvsadm -a -t ${vip_v4}:${port} -r ${rip_v4}:${port}\n\tip netns exec ns1 ip addr add ${vip_v4}/32 dev lo:1\n\n\t# avoid incorrect arp response\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.all.arp_ignore=1\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.all.arp_announce=2\n\t# avoid reverse route lookup\n\tip netns exec ns2 sysctl -qw  net.ipv4.conf.all.rp_filter=0\n\tip netns exec ns2 sysctl -qw  net.ipv4.conf.veth21.rp_filter=0\n\tip netns exec ns2 ip addr add ${vip_v4}/32 dev lo:1\n\n\ttest_service\n}\n\ntest_nat() {\n\tip netns exec ns0 ip route add ${vip_v4} via ${gip_v4} dev br0\n\n\tip netns exec ns1 sysctl -qw net.ipv4.ip_forward=1\n\tip netns exec ns1 ipvsadm -A -t ${vip_v4}:${port} -s rr\n\tip netns exec ns1 ipvsadm -a -m -t ${vip_v4}:${port} -r ${rip_v4}:${port}\n\tip netns exec ns1 ip addr add ${vip_v4}/32 dev lo:1\n\n\tip netns exec ns2 ip link del veth20\n\tip netns exec ns2 ip route add default via ${dip_v4} dev veth21\n\n\ttest_service\n}\n\ntest_tun() {\n\tip netns exec ns0 ip route add ${vip_v4} via ${gip_v4} dev br0\n\n\tip netns exec ns1 modprobe ipip\n\tip netns exec ns1 ip link set tunl0 up\n\tip netns exec ns1 sysctl -qw net.ipv4.ip_forward=0\n\tip netns exec ns1 sysctl -qw net.ipv4.conf.all.send_redirects=0\n\tip netns exec ns1 sysctl -qw net.ipv4.conf.default.send_redirects=0\n\tip netns exec ns1 ipvsadm -A -t ${vip_v4}:${port} -s rr\n\tip netns exec ns1 ipvsadm -a -i -t ${vip_v4}:${port} -r ${rip_v4}:${port}\n\tip netns exec ns1 ip addr add ${vip_v4}/32 dev lo:1\n\n\tip netns exec ns2 modprobe ipip\n\tip netns exec ns2 ip link set tunl0 up\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.all.arp_ignore=1\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.all.arp_announce=2\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.all.rp_filter=0\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.tunl0.rp_filter=0\n\tip netns exec ns2 sysctl -qw net.ipv4.conf.veth21.rp_filter=0\n\tip netns exec ns2 ip addr add ${vip_v4}/32 dev lo:1\n\n\ttest_service\n}\n\nrun_tests() {\n\tlocal errors=\n\n\techo \"Testing DR mode...\"\n\tcleanup\n\tsetup\n\ttest_dr\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing NAT mode...\"\n\tcleanup\n\tsetup\n\ttest_nat\n\terrors=$(( $errors + $? ))\n\n\techo \"Testing Tunnel mode...\"\n\tcleanup\n\tsetup\n\ttest_tun\n\terrors=$(( $errors + $? ))\n\n\treturn $errors\n}\n\ntrap cleanup EXIT\n\nrun_tests\n\nif [ $? -ne 0 ]; then\n\techo -e \"$(basename $0): ${RED}FAIL${NC}\"\n\texit 1\nfi\necho -e \"$(basename $0): ${GREEN}PASS${NC}\"\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}