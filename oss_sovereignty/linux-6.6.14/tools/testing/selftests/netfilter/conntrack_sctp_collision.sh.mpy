{
  "module_name": "conntrack_sctp_collision.sh",
  "hash_id": "4822e7a0a6951efc81d7f6142bd3097e8c3052219662d59ade766d2cfc4af526",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/netfilter/conntrack_sctp_collision.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Testing For SCTP COLLISION SCENARIO as Below:\n#\n#   14:35:47.655279 IP CLIENT_IP.PORT > SERVER_IP.PORT: sctp (1) [INIT] [init tag: 2017837359]\n#   14:35:48.353250 IP SERVER_IP.PORT > CLIENT_IP.PORT: sctp (1) [INIT] [init tag: 1187206187]\n#   14:35:48.353275 IP CLIENT_IP.PORT > SERVER_IP.PORT: sctp (1) [INIT ACK] [init tag: 2017837359]\n#   14:35:48.353283 IP SERVER_IP.PORT > CLIENT_IP.PORT: sctp (1) [COOKIE ECHO]\n#   14:35:48.353977 IP CLIENT_IP.PORT > SERVER_IP.PORT: sctp (1) [COOKIE ACK]\n#   14:35:48.855335 IP SERVER_IP.PORT > CLIENT_IP.PORT: sctp (1) [INIT ACK] [init tag: 164579970]\n#\n# TOPO: SERVER_NS (link0)<--->(link1) ROUTER_NS (link2)<--->(link3) CLIENT_NS\n\nCLIENT_NS=$(mktemp -u client-XXXXXXXX)\nCLIENT_IP=\"198.51.200.1\"\nCLIENT_PORT=1234\n\nSERVER_NS=$(mktemp -u server-XXXXXXXX)\nSERVER_IP=\"198.51.100.1\"\nSERVER_PORT=1234\n\nROUTER_NS=$(mktemp -u router-XXXXXXXX)\nCLIENT_GW=\"198.51.200.2\"\nSERVER_GW=\"198.51.100.2\"\n\n# setup the topo\nsetup() {\n\tip net add $CLIENT_NS\n\tip net add $SERVER_NS\n\tip net add $ROUTER_NS\n\tip -n $SERVER_NS link add link0 type veth peer name link1 netns $ROUTER_NS\n\tip -n $CLIENT_NS link add link3 type veth peer name link2 netns $ROUTER_NS\n\n\tip -n $SERVER_NS link set link0 up\n\tip -n $SERVER_NS addr add $SERVER_IP/24 dev link0\n\tip -n $SERVER_NS route add $CLIENT_IP dev link0 via $SERVER_GW\n\n\tip -n $ROUTER_NS link set link1 up\n\tip -n $ROUTER_NS link set link2 up\n\tip -n $ROUTER_NS addr add $SERVER_GW/24 dev link1\n\tip -n $ROUTER_NS addr add $CLIENT_GW/24 dev link2\n\tip net exec $ROUTER_NS sysctl -wq net.ipv4.ip_forward=1\n\n\tip -n $CLIENT_NS link set link3 up\n\tip -n $CLIENT_NS addr add $CLIENT_IP/24 dev link3\n\tip -n $CLIENT_NS route add $SERVER_IP dev link3 via $CLIENT_GW\n\n\t# simulate the delay on OVS upcall by setting up a delay for INIT_ACK with\n\t# tc on $SERVER_NS side\n\ttc -n $SERVER_NS qdisc add dev link0 root handle 1: htb\n\ttc -n $SERVER_NS class add dev link0 parent 1: classid 1:1 htb rate 100mbit\n\ttc -n $SERVER_NS filter add dev link0 parent 1: protocol ip u32 match ip protocol 132 \\\n\t\t0xff match u8 2 0xff at 32 flowid 1:1\n\ttc -n $SERVER_NS qdisc add dev link0 parent 1:1 handle 10: netem delay 1200ms\n\n\t# simulate the ctstate check on OVS nf_conntrack\n\tip net exec $ROUTER_NS iptables -A FORWARD -m state --state INVALID,UNTRACKED -j DROP\n\tip net exec $ROUTER_NS iptables -A INPUT -p sctp -j DROP\n\n\t# use a smaller number for assoc's max_retrans to reproduce the issue\n\tmodprobe sctp\n\tip net exec $CLIENT_NS sysctl -wq net.sctp.association_max_retrans=3\n}\n\ncleanup() {\n\tip net exec $CLIENT_NS pkill sctp_collision 2>&1 >/dev/null\n\tip net exec $SERVER_NS pkill sctp_collision 2>&1 >/dev/null\n\tip net del \"$CLIENT_NS\"\n\tip net del \"$SERVER_NS\"\n\tip net del \"$ROUTER_NS\"\n}\n\ndo_test() {\n\tip net exec $SERVER_NS ./sctp_collision server \\\n\t\t$SERVER_IP $SERVER_PORT $CLIENT_IP $CLIENT_PORT &\n\tip net exec $CLIENT_NS ./sctp_collision client \\\n\t\t$CLIENT_IP $CLIENT_PORT $SERVER_IP $SERVER_PORT\n}\n\n# NOTE: one way to work around the issue is set a smaller hb_interval\n# ip net exec $CLIENT_NS sysctl -wq net.sctp.hb_interval=3500\n\n# run the test case\ntrap cleanup EXIT\nsetup && \\\necho \"Test for SCTP Collision in nf_conntrack:\" && \\\ndo_test && echo \"PASS!\"\nexit $?\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}