{
  "module_name": "dma_map_benchmark.c",
  "hash_id": "c0bda4388f5ab9f02a6faec8e3bc6660aaef19f584eed6c54fb45f13585c0bc1",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/dma/dma_map_benchmark.c",
  "human_readable_source": "\n \n\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <sys/ioctl.h>\n#include <sys/mman.h>\n#include <linux/types.h>\n#include <linux/map_benchmark.h>\n\n#define NSEC_PER_MSEC\t1000000L\n\nstatic char *directions[] = {\n\t\"BIDIRECTIONAL\",\n\t\"TO_DEVICE\",\n\t\"FROM_DEVICE\",\n};\n\nint main(int argc, char **argv)\n{\n\tstruct map_benchmark map;\n\tint fd, opt;\n\t \n\tint threads = 1, seconds = 20, node = -1;\n\t \n\tint bits = 32, xdelay = 0, dir = DMA_MAP_BIDIRECTIONAL;\n\t \n\tint granule = 1;\n\n\tint cmd = DMA_MAP_BENCHMARK;\n\tchar *p;\n\n\twhile ((opt = getopt(argc, argv, \"t:s:n:b:d:x:g:\")) != -1) {\n\t\tswitch (opt) {\n\t\tcase 't':\n\t\t\tthreads = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 's':\n\t\t\tseconds = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\tnode = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'b':\n\t\t\tbits = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'd':\n\t\t\tdir = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'x':\n\t\t\txdelay = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'g':\n\t\t\tgranule = atoi(optarg);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\tif (threads <= 0 || threads > DMA_MAP_MAX_THREADS) {\n\t\tfprintf(stderr, \"invalid number of threads, must be in 1-%d\\n\",\n\t\t\tDMA_MAP_MAX_THREADS);\n\t\texit(1);\n\t}\n\n\tif (seconds <= 0 || seconds > DMA_MAP_MAX_SECONDS) {\n\t\tfprintf(stderr, \"invalid number of seconds, must be in 1-%d\\n\",\n\t\t\tDMA_MAP_MAX_SECONDS);\n\t\texit(1);\n\t}\n\n\tif (xdelay < 0 || xdelay > DMA_MAP_MAX_TRANS_DELAY) {\n\t\tfprintf(stderr, \"invalid transmit delay, must be in 0-%ld\\n\",\n\t\t\tDMA_MAP_MAX_TRANS_DELAY);\n\t\texit(1);\n\t}\n\n\t \n\tif (bits < 20 || bits > 64) {\n\t\tfprintf(stderr, \"invalid dma mask bit, must be in 20-64\\n\");\n\t\texit(1);\n\t}\n\n\tif (dir != DMA_MAP_BIDIRECTIONAL && dir != DMA_MAP_TO_DEVICE &&\n\t\t\tdir != DMA_MAP_FROM_DEVICE) {\n\t\tfprintf(stderr, \"invalid dma direction\\n\");\n\t\texit(1);\n\t}\n\n\tif (granule < 1 || granule > 1024) {\n\t\tfprintf(stderr, \"invalid granule size\\n\");\n\t\texit(1);\n\t}\n\n\tfd = open(\"/sys/kernel/debug/dma_map_benchmark\", O_RDWR);\n\tif (fd == -1) {\n\t\tperror(\"open\");\n\t\texit(1);\n\t}\n\n\tmemset(&map, 0, sizeof(map));\n\tmap.seconds = seconds;\n\tmap.threads = threads;\n\tmap.node = node;\n\tmap.dma_bits = bits;\n\tmap.dma_dir = dir;\n\tmap.dma_trans_ns = xdelay;\n\tmap.granule = granule;\n\n\tif (ioctl(fd, cmd, &map)) {\n\t\tperror(\"ioctl\");\n\t\texit(1);\n\t}\n\n\tprintf(\"dma mapping benchmark: threads:%d seconds:%d node:%d dir:%s granule: %d\\n\",\n\t\t\tthreads, seconds, node, dir[directions], granule);\n\tprintf(\"average map latency(us):%.1f standard deviation:%.1f\\n\",\n\t\t\tmap.avg_map_100ns/10.0, map.map_stddev/10.0);\n\tprintf(\"average unmap latency(us):%.1f standard deviation:%.1f\\n\",\n\t\t\tmap.avg_unmap_100ns/10.0, map.unmap_stddev/10.0);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}