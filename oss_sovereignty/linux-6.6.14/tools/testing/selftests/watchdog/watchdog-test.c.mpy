{
  "module_name": "watchdog-test.c",
  "hash_id": "301521d82f5e2bc96d8b9c3207cb2ee59ab8331967c67419b5f350f9ef89bfda",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/watchdog/watchdog-test.c",
  "human_readable_source": "\n \n\n#include <errno.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <signal.h>\n#include <getopt.h>\n#include <sys/ioctl.h>\n#include <linux/types.h>\n#include <linux/watchdog.h>\n\n#define DEFAULT_PING_RATE\t1\n\nint fd;\nconst char v = 'V';\nstatic const char sopts[] = \"bdehp:st:Tn:NLf:i\";\nstatic const struct option lopts[] = {\n\t{\"bootstatus\",          no_argument, NULL, 'b'},\n\t{\"disable\",             no_argument, NULL, 'd'},\n\t{\"enable\",              no_argument, NULL, 'e'},\n\t{\"help\",                no_argument, NULL, 'h'},\n\t{\"pingrate\",      required_argument, NULL, 'p'},\n\t{\"status\",              no_argument, NULL, 's'},\n\t{\"timeout\",       required_argument, NULL, 't'},\n\t{\"gettimeout\",          no_argument, NULL, 'T'},\n\t{\"pretimeout\",    required_argument, NULL, 'n'},\n\t{\"getpretimeout\",       no_argument, NULL, 'N'},\n\t{\"gettimeleft\",\t\tno_argument, NULL, 'L'},\n\t{\"file\",          required_argument, NULL, 'f'},\n\t{\"info\",\t\tno_argument, NULL, 'i'},\n\t{NULL,                  no_argument, NULL, 0x0}\n};\n\n \nstatic void keep_alive(void)\n{\n\tint dummy;\n\tint ret;\n\n\tret = ioctl(fd, WDIOC_KEEPALIVE, &dummy);\n\tif (!ret)\n\t\tprintf(\".\");\n}\n\n \n\nstatic void term(int sig)\n{\n\tint ret = write(fd, &v, 1);\n\n\tclose(fd);\n\tif (ret < 0)\n\t\tprintf(\"\\nStopping watchdog ticks failed (%d)...\\n\", errno);\n\telse\n\t\tprintf(\"\\nStopping watchdog ticks...\\n\");\n\texit(0);\n}\n\nstatic void usage(char *progname)\n{\n\tprintf(\"Usage: %s [options]\\n\", progname);\n\tprintf(\" -f, --file\\t\\tOpen watchdog device file\\n\");\n\tprintf(\"\\t\\t\\tDefault is /dev/watchdog\\n\");\n\tprintf(\" -i, --info\\t\\tShow watchdog_info\\n\");\n\tprintf(\" -s, --status\\t\\tGet status & supported features\\n\");\n\tprintf(\" -b, --bootstatus\\tGet last boot status (Watchdog/POR)\\n\");\n\tprintf(\" -d, --disable\\t\\tTurn off the watchdog timer\\n\");\n\tprintf(\" -e, --enable\\t\\tTurn on the watchdog timer\\n\");\n\tprintf(\" -h, --help\\t\\tPrint the help message\\n\");\n\tprintf(\" -p, --pingrate=P\\tSet ping rate to P seconds (default %d)\\n\",\n\t       DEFAULT_PING_RATE);\n\tprintf(\" -t, --timeout=T\\tSet timeout to T seconds\\n\");\n\tprintf(\" -T, --gettimeout\\tGet the timeout\\n\");\n\tprintf(\" -n, --pretimeout=T\\tSet the pretimeout to T seconds\\n\");\n\tprintf(\" -N, --getpretimeout\\tGet the pretimeout\\n\");\n\tprintf(\" -L, --gettimeleft\\tGet the time left until timer expires\\n\");\n\tprintf(\"\\n\");\n\tprintf(\"Parameters are parsed left-to-right in real-time.\\n\");\n\tprintf(\"Example: %s -d -t 10 -p 5 -e\\n\", progname);\n\tprintf(\"Example: %s -t 12 -T -n 7 -N\\n\", progname);\n}\n\nstruct wdiof_status {\n\tint flag;\n\tconst char *status_str;\n};\n\n#define WDIOF_NUM_STATUS 8\n\nstatic const struct wdiof_status wdiof_status[WDIOF_NUM_STATUS] = {\n\t{WDIOF_SETTIMEOUT,  \"Set timeout (in seconds)\"},\n\t{WDIOF_MAGICCLOSE,  \"Supports magic close char\"},\n\t{WDIOF_PRETIMEOUT,  \"Pretimeout (in seconds), get/set\"},\n\t{WDIOF_ALARMONLY,  \"Watchdog triggers a management or other external alarm not a reboot\"},\n\t{WDIOF_KEEPALIVEPING,  \"Keep alive ping reply\"},\n\t{WDIOS_DISABLECARD,  \"Turn off the watchdog timer\"},\n\t{WDIOS_ENABLECARD,  \"Turn on the watchdog timer\"},\n\t{WDIOS_TEMPPANIC,  \"Kernel panic on temperature trip\"},\n};\n\nstatic void print_status(int flags)\n{\n\tint wdiof = 0;\n\n\tif (flags == WDIOS_UNKNOWN) {\n\t\tprintf(\"Unknown status error from WDIOC_GETSTATUS\\n\");\n\t\treturn;\n\t}\n\n\tfor (wdiof = 0; wdiof < WDIOF_NUM_STATUS; wdiof++) {\n\t\tif (flags & wdiof_status[wdiof].flag)\n\t\t\tprintf(\"Support/Status: %s\\n\",\n\t\t\t\twdiof_status[wdiof].status_str);\n\t}\n}\n\n#define WDIOF_NUM_BOOTSTATUS 7\n\nstatic const struct wdiof_status wdiof_bootstatus[WDIOF_NUM_BOOTSTATUS] = {\n\t{WDIOF_OVERHEAT, \"Reset due to CPU overheat\"},\n\t{WDIOF_FANFAULT, \"Fan failed\"},\n\t{WDIOF_EXTERN1, \"External relay 1\"},\n\t{WDIOF_EXTERN2, \"External relay 2\"},\n\t{WDIOF_POWERUNDER, \"Power bad/power fault\"},\n\t{WDIOF_CARDRESET, \"Card previously reset the CPU\"},\n\t{WDIOF_POWEROVER,  \"Power over voltage\"},\n};\n\nstatic void print_boot_status(int flags)\n{\n\tint wdiof = 0;\n\n\tif (flags == WDIOF_UNKNOWN) {\n\t\tprintf(\"Unknown flag error from WDIOC_GETBOOTSTATUS\\n\");\n\t\treturn;\n\t}\n\n\tif (flags == 0) {\n\t\tprintf(\"Last boot is caused by: Power-On-Reset\\n\");\n\t\treturn;\n\t}\n\n\tfor (wdiof = 0; wdiof < WDIOF_NUM_BOOTSTATUS; wdiof++) {\n\t\tif (flags & wdiof_bootstatus[wdiof].flag)\n\t\t\tprintf(\"Last boot is caused by: %s\\n\",\n\t\t\t\twdiof_bootstatus[wdiof].status_str);\n\t}\n}\n\nint main(int argc, char *argv[])\n{\n\tint flags;\n\tunsigned int ping_rate = DEFAULT_PING_RATE;\n\tint ret;\n\tint c;\n\tint oneshot = 0;\n\tchar *file = \"/dev/watchdog\";\n\tstruct watchdog_info info;\n\tint temperature;\n\n\tsetbuf(stdout, NULL);\n\n\twhile ((c = getopt_long(argc, argv, sopts, lopts, NULL)) != -1) {\n\t\tif (c == 'f')\n\t\t\tfile = optarg;\n\t}\n\n\tfd = open(file, O_WRONLY);\n\n\tif (fd == -1) {\n\t\tif (errno == ENOENT)\n\t\t\tprintf(\"Watchdog device (%s) not found.\\n\", file);\n\t\telse if (errno == EACCES)\n\t\t\tprintf(\"Run watchdog as root.\\n\");\n\t\telse\n\t\t\tprintf(\"Watchdog device open failed %s\\n\",\n\t\t\t\tstrerror(errno));\n\t\texit(-1);\n\t}\n\n\t \n\tret = ioctl(fd, WDIOC_GETSUPPORT, &info);\n\tif (ret) {\n\t\tprintf(\"WDIOC_GETSUPPORT error '%s'\\n\", strerror(errno));\n\t\tclose(fd);\n\t\texit(ret);\n\t}\n\n\toptind = 0;\n\n\twhile ((c = getopt_long(argc, argv, sopts, lopts, NULL)) != -1) {\n\t\tswitch (c) {\n\t\tcase 'b':\n\t\t\tflags = 0;\n\t\t\toneshot = 1;\n\t\t\tret = ioctl(fd, WDIOC_GETBOOTSTATUS, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprint_boot_status(flags);\n\t\t\telse\n\t\t\t\tprintf(\"WDIOC_GETBOOTSTATUS error '%s'\\n\", strerror(errno));\n\t\t\tbreak;\n\t\tcase 'd':\n\t\t\tflags = WDIOS_DISABLECARD;\n\t\t\tret = ioctl(fd, WDIOC_SETOPTIONS, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"Watchdog card disabled.\\n\");\n\t\t\telse {\n\t\t\t\tprintf(\"WDIOS_DISABLECARD error '%s'\\n\", strerror(errno));\n\t\t\t\toneshot = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'e':\n\t\t\tflags = WDIOS_ENABLECARD;\n\t\t\tret = ioctl(fd, WDIOC_SETOPTIONS, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"Watchdog card enabled.\\n\");\n\t\t\telse {\n\t\t\t\tprintf(\"WDIOS_ENABLECARD error '%s'\\n\", strerror(errno));\n\t\t\t\toneshot = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\tping_rate = strtoul(optarg, NULL, 0);\n\t\t\tif (!ping_rate)\n\t\t\t\tping_rate = DEFAULT_PING_RATE;\n\t\t\tprintf(\"Watchdog ping rate set to %u seconds.\\n\", ping_rate);\n\t\t\tbreak;\n\t\tcase 's':\n\t\t\tflags = 0;\n\t\t\toneshot = 1;\n\t\t\tret = ioctl(fd, WDIOC_GETSTATUS, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprint_status(flags);\n\t\t\telse\n\t\t\t\tprintf(\"WDIOC_GETSTATUS error '%s'\\n\", strerror(errno));\n\t\t\tret = ioctl(fd, WDIOC_GETTEMP, &temperature);\n\t\t\tif (ret)\n\t\t\t\tprintf(\"WDIOC_GETTEMP: '%s'\\n\", strerror(errno));\n\t\t\telse\n\t\t\t\tprintf(\"Temperature %d\\n\", temperature);\n\n\t\t\tbreak;\n\t\tcase 't':\n\t\t\tflags = strtoul(optarg, NULL, 0);\n\t\t\tret = ioctl(fd, WDIOC_SETTIMEOUT, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"Watchdog timeout set to %u seconds.\\n\", flags);\n\t\t\telse {\n\t\t\t\tprintf(\"WDIOC_SETTIMEOUT error '%s'\\n\", strerror(errno));\n\t\t\t\toneshot = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'T':\n\t\t\toneshot = 1;\n\t\t\tret = ioctl(fd, WDIOC_GETTIMEOUT, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"WDIOC_GETTIMEOUT returns %u seconds.\\n\", flags);\n\t\t\telse\n\t\t\t\tprintf(\"WDIOC_GETTIMEOUT error '%s'\\n\", strerror(errno));\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\tflags = strtoul(optarg, NULL, 0);\n\t\t\tret = ioctl(fd, WDIOC_SETPRETIMEOUT, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"Watchdog pretimeout set to %u seconds.\\n\", flags);\n\t\t\telse {\n\t\t\t\tprintf(\"WDIOC_SETPRETIMEOUT error '%s'\\n\", strerror(errno));\n\t\t\t\toneshot = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'N':\n\t\t\toneshot = 1;\n\t\t\tret = ioctl(fd, WDIOC_GETPRETIMEOUT, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"WDIOC_GETPRETIMEOUT returns %u seconds.\\n\", flags);\n\t\t\telse\n\t\t\t\tprintf(\"WDIOC_GETPRETIMEOUT error '%s'\\n\", strerror(errno));\n\t\t\tbreak;\n\t\tcase 'L':\n\t\t\toneshot = 1;\n\t\t\tret = ioctl(fd, WDIOC_GETTIMELEFT, &flags);\n\t\t\tif (!ret)\n\t\t\t\tprintf(\"WDIOC_GETTIMELEFT returns %u seconds.\\n\", flags);\n\t\t\telse\n\t\t\t\tprintf(\"WDIOC_GETTIMELEFT error '%s'\\n\", strerror(errno));\n\t\t\tbreak;\n\t\tcase 'f':\n\t\t\t \n\t\t\tbreak;\n\t\tcase 'i':\n\t\t\t \n\t\t\toneshot = 1;\n\t\t\tprintf(\"watchdog_info:\\n\");\n\t\t\tprintf(\" identity:\\t\\t%s\\n\", info.identity);\n\t\t\tprintf(\" firmware_version:\\t%u\\n\",\n\t\t\t       info.firmware_version);\n\t\t\tprint_status(info.options);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tusage(argv[0]);\n\t\t\tgoto end;\n\t\t}\n\t}\n\n\tif (oneshot)\n\t\tgoto end;\n\n\tprintf(\"Watchdog Ticking Away!\\n\");\n\n\tsignal(SIGINT, term);\n\n\twhile (1) {\n\t\tkeep_alive();\n\t\tsleep(ping_rate);\n\t}\nend:\n\t \n\tret = write(fd, &v, 1);\n\tif (ret < 0)\n\t\tprintf(\"Stopping watchdog ticks failed (%d)...\\n\", errno);\n\tclose(fd);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}