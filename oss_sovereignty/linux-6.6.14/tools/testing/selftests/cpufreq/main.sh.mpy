{
  "module_name": "main.sh",
  "hash_id": "7e6c866c43cb33c5b4ebcb363f6e1fb68435ba9d76ac5d37d2288bee8f8b851a",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/cpufreq/main.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\nsource cpu.sh\nsource cpufreq.sh\nsource governor.sh\nsource module.sh\nsource special-tests.sh\n\nFUNC=basic\t# do basic tests by default\nOUTFILE=cpufreq_selftest\nSYSFS=\nCPUROOT=\nCPUFREQROOT=\n\n# Kselftest framework requirement - SKIP code is 4.\nksft_skip=4\n\nhelpme()\n{\n\tprintf \"Usage: $0 [-h] [-todg args]\n\t[-h <help>]\n\t[-o <output-file-for-dump>]\n\t[-t <basic: Basic cpufreq testing\n\t     suspend: suspend/resume,\n\t     hibernate: hibernate/resume,\n\t     modtest: test driver or governor modules. Only to be used with -d or -g options,\n\t     sptest1: Simple governor switch to produce lockdep.\n\t     sptest2: Concurrent governor switch to produce lockdep.\n\t     sptest3: Governor races, shuffle between governors quickly.\n\t     sptest4: CPU hotplugs with updates to cpufreq files.>]\n\t[-d <driver's module name: only with \\\"-t modtest>\\\"]\n\t[-g <governor's module name: only with \\\"-t modtest>\\\"]\n\t\\n\"\n\texit 2\n}\n\nprerequisite()\n{\n\tmsg=\"skip all tests:\"\n\n\tif [ $UID != 0 ]; then\n\t\techo $msg must be run as root >&2\n\t\texit $ksft_skip\n\tfi\n\n\ttaskset -p 01 $$\n\n\tSYSFS=`mount -t sysfs | head -1 | awk '{ print $3 }'`\n\n\tif [ ! -d \"$SYSFS\" ]; then\n\t\techo $msg sysfs is not mounted >&2\n\t\texit 2\n\tfi\n\n\tCPUROOT=$SYSFS/devices/system/cpu\n\tCPUFREQROOT=\"$CPUROOT/cpufreq\"\n\n\tif ! ls $CPUROOT/cpu* > /dev/null 2>&1; then\n\t\techo $msg cpus not available in sysfs >&2\n\t\texit 2\n\tfi\n\n\tif ! ls $CPUROOT/cpufreq > /dev/null 2>&1; then\n\t\techo $msg cpufreq directory not available in sysfs >&2\n\t\texit 2\n\tfi\n}\n\nparse_arguments()\n{\n\twhile getopts ht:o:d:g: arg\n\tdo\n\t\tcase $arg in\n\t\t\th) # --help\n\t\t\t\thelpme\n\t\t\t\t;;\n\n\t\t\tt) # --func_type (Function to perform: basic, suspend, hibernate, modtest, sptest1/2/3/4 (default: basic))\n\t\t\t\tFUNC=$OPTARG\n\t\t\t\t;;\n\n\t\t\to) # --output-file (Output file to store dumps)\n\t\t\t\tOUTFILE=$OPTARG\n\t\t\t\t;;\n\n\t\t\td) # --driver-mod-name (Name of the driver module)\n\t\t\t\tDRIVER_MOD=$OPTARG\n\t\t\t\t;;\n\n\t\t\tg) # --governor-mod-name (Name of the governor module)\n\t\t\t\tGOVERNOR_MOD=$OPTARG\n\t\t\t\t;;\n\n\t\t\t\\?)\n\t\t\t\thelpme\n\t\t\t\t;;\n\t\tesac\n\tdone\n}\n\ndo_test()\n{\n\t# Check if CPUs are managed by cpufreq or not\n\tcount=$(count_cpufreq_managed_cpus)\n\n\tif [ $count = 0 -a $FUNC != \"modtest\" ]; then\n\t\techo \"No cpu is managed by cpufreq core, exiting\"\n\t\texit 2;\n\tfi\n\n\tcase \"$FUNC\" in\n\t\t\"basic\")\n\t\tcpufreq_basic_tests\n\t\t;;\n\n\t\t\"suspend\")\n\t\tdo_suspend \"suspend\" 1\n\t\t;;\n\n\t\t\"hibernate\")\n\t\tdo_suspend \"hibernate\" 1\n\t\t;;\n\n\t\t\"modtest\")\n\t\t# Do we have modules in place?\n\t\tif [ -z $DRIVER_MOD ] && [ -z $GOVERNOR_MOD ]; then\n\t\t\techo \"No driver or governor module passed with -d or -g\"\n\t\t\texit 2;\n\t\tfi\n\n\t\tif [ $DRIVER_MOD ]; then\n\t\t\tif [ $GOVERNOR_MOD ]; then\n\t\t\t\tmodule_test $DRIVER_MOD $GOVERNOR_MOD\n\t\t\telse\n\t\t\t\tmodule_driver_test $DRIVER_MOD\n\t\t\tfi\n\t\telse\n\t\t\tif [ $count = 0 ]; then\n\t\t\t\techo \"No cpu is managed by cpufreq core, exiting\"\n\t\t\t\texit 2;\n\t\t\tfi\n\n\t\t\tmodule_governor_test $GOVERNOR_MOD\n\t\tfi\n\t\t;;\n\n\t\t\"sptest1\")\n\t\tsimple_lockdep\n\t\t;;\n\n\t\t\"sptest2\")\n\t\tconcurrent_lockdep\n\t\t;;\n\n\t\t\"sptest3\")\n\t\tgovernor_race\n\t\t;;\n\n\t\t\"sptest4\")\n\t\thotplug_with_updates\n\t\t;;\n\n\t\t*)\n\t\techo \"Invalid [-f] function type\"\n\t\thelpme\n\t\t;;\n\tesac\n}\n\n# clear dumps\n# $1: file name\nclear_dumps()\n{\n\techo \"\" > $1.txt\n\techo \"\" > $1.dmesg_cpufreq.txt\n\techo \"\" > $1.dmesg_full.txt\n}\n\n# $1: output file name\ndmesg_dumps()\n{\n\tdmesg | grep cpufreq >> $1.dmesg_cpufreq.txt\n\n\t# We may need the full logs as well\n\tdmesg >> $1.dmesg_full.txt\n}\n\n# Parse arguments\nparse_arguments $@\n\n# Make sure all requirements are met\nprerequisite\n\n# Run requested functions\nclear_dumps $OUTFILE\ndo_test | tee -a $OUTFILE.txt\ndmesg_dumps $OUTFILE\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}