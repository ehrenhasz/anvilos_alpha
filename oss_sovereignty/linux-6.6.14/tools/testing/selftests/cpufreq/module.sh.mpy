{
  "module_name": "module.sh",
  "hash_id": "094cc5b47c55937da8698027e3832ffa9eb84829e5c98b312803a11fbb38fc68",
  "original_prompt": "Ingested from linux-6.6.14/tools/testing/selftests/cpufreq/module.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Modules specific tests cases\n\n# protect against multiple inclusion\nif [ $FILE_MODULE ]; then\n\treturn 0\nelse\n\tFILE_MODULE=DONE\nfi\n\nsource cpu.sh\nsource cpufreq.sh\nsource governor.sh\n\n# Check basic insmod/rmmod\n# $1: module\ntest_basic_insmod_rmmod()\n{\n\tprintf \"** Test: Running ${FUNCNAME[0]} **\\n\\n\"\n\n\tprintf \"Inserting $1 module\\n\"\n\t# insert module\n\tinsmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"Insmod $1 failed\\n\"\n\t\texit;\n\tfi\n\n\tprintf \"Removing $1 module\\n\"\n\t# remove module\n\trmmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"rmmod $1 failed\\n\"\n\t\texit;\n\tfi\n\n\tprintf \"\\n\"\n}\n\n# Insert cpufreq driver module and perform basic tests\n# $1: cpufreq-driver module to insert\n# $2: If we want to play with CPUs (1) or not (0)\nmodule_driver_test_single()\n{\n\tprintf \"** Test: Running ${FUNCNAME[0]} for driver $1 and cpus_hotplug=$2 **\\n\\n\"\n\n\tif [ $2 -eq 1 ]; then\n\t\t# offline all non-boot CPUs\n\t\tfor_each_non_boot_cpu offline_cpu\n\t\tprintf \"\\n\"\n\tfi\n\n\t# insert module\n\tprintf \"Inserting $1 module\\n\\n\"\n\tinsmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"Insmod $1 failed\\n\"\n\t\treturn;\n\tfi\n\n\tif [ $2 -eq 1 ]; then\n\t\t# online all non-boot CPUs\n\t\tfor_each_non_boot_cpu online_cpu\n\t\tprintf \"\\n\"\n\tfi\n\n\t# run basic tests\n\tcpufreq_basic_tests\n\n\t# remove module\n\tprintf \"Removing $1 module\\n\\n\"\n\trmmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"rmmod $1 failed\\n\"\n\t\treturn;\n\tfi\n\n\t# There shouldn't be any cpufreq directories now.\n\tfor_each_cpu cpu_should_not_have_cpufreq_directory\n\tprintf \"\\n\"\n}\n\n# $1: cpufreq-driver module to insert\nmodule_driver_test()\n{\n\tprintf \"** Test: Running ${FUNCNAME[0]} **\\n\\n\"\n\n\t# check if module is present or not\n\tls $1 > /dev/null\n\tif [ $? != 0 ]; then\n\t\tprintf \"$1: not present in `pwd` folder\\n\"\n\t\treturn;\n\tfi\n\n\t# test basic module tests\n\ttest_basic_insmod_rmmod $1\n\n\t# Do simple module test\n\tmodule_driver_test_single $1 0\n\n\t# Remove CPUs before inserting module and then bring them back\n\tmodule_driver_test_single $1 1\n\tprintf \"\\n\"\n}\n\n# find governor name based on governor module name\n# $1: governor module name\nfind_gov_name()\n{\n\tif [ $1 = \"cpufreq_ondemand.ko\" ]; then\n\t\tprintf \"ondemand\"\n\telif [ $1 = \"cpufreq_conservative.ko\" ]; then\n\t\tprintf \"conservative\"\n\telif [ $1 = \"cpufreq_userspace.ko\" ]; then\n\t\tprintf \"userspace\"\n\telif [ $1 = \"cpufreq_performance.ko\" ]; then\n\t\tprintf \"performance\"\n\telif [ $1 = \"cpufreq_powersave.ko\" ]; then\n\t\tprintf \"powersave\"\n\telif [ $1 = \"cpufreq_schedutil.ko\" ]; then\n\t\tprintf \"schedutil\"\n\tfi\n}\n\n# $1: governor string, $2: governor module, $3: policy\n# example: module_governor_test_single \"ondemand\" \"cpufreq_ondemand.ko\" 2\nmodule_governor_test_single()\n{\n\tprintf \"** Test: Running ${FUNCNAME[0]} for $3 **\\n\\n\"\n\n\tbackup_governor $3\n\n\t# switch to new governor\n\tprintf \"Switch from $CUR_GOV to $1\\n\"\n\tswitch_show_governor $3 $1\n\n\t# try removing module, it should fail as governor is used\n\tprintf \"Removing $2 module\\n\\n\"\n\trmmod $2\n\tif [ $? = 0 ]; then\n\t\tprintf \"WARN: rmmod $2 succeeded even if governor is used\\n\"\n\t\tinsmod $2\n\telse\n\t\tprintf \"Pass: unable to remove $2 while it is being used\\n\\n\"\n\tfi\n\n\t# switch back to old governor\n\tprintf \"Switchback to $CUR_GOV from $1\\n\"\n\trestore_governor $3\n\tprintf \"\\n\"\n}\n\n# Insert cpufreq governor module and perform basic tests\n# $1: cpufreq-governor module to insert\nmodule_governor_test()\n{\n\tprintf \"** Test: Running ${FUNCNAME[0]} **\\n\\n\"\n\n\t# check if module is present or not\n\tls $1 > /dev/null\n\tif [ $? != 0 ]; then\n\t\tprintf \"$1: not present in `pwd` folder\\n\"\n\t\treturn;\n\tfi\n\n\t# test basic module tests\n\ttest_basic_insmod_rmmod $1\n\n\t# insert module\n\tprintf \"Inserting $1 module\\n\\n\"\n\tinsmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"Insmod $1 failed\\n\"\n\t\treturn;\n\tfi\n\n\t# switch to new governor for each cpu\n\tfor_each_policy module_governor_test_single $(find_gov_name $1) $1\n\n\t# remove module\n\tprintf \"Removing $1 module\\n\\n\"\n\trmmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"rmmod $1 failed\\n\"\n\t\treturn;\n\tfi\n\tprintf \"\\n\"\n}\n\n# test modules: driver and governor\n# $1: driver module, $2: governor module\nmodule_test()\n{\n\tprintf \"** Test: Running ${FUNCNAME[0]} **\\n\\n\"\n\n\t# check if modules are present or not\n\tls $1 $2 > /dev/null\n\tif [ $? != 0 ]; then\n\t\tprintf \"$1 or $2: is not present in `pwd` folder\\n\"\n\t\treturn;\n\tfi\n\n\t# TEST1: Insert gov after driver\n\t# insert driver module\n\tprintf \"Inserting $1 module\\n\\n\"\n\tinsmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"Insmod $1 failed\\n\"\n\t\treturn;\n\tfi\n\n\t# run governor tests\n\tmodule_governor_test $2\n\n\t# remove driver module\n\tprintf \"Removing $1 module\\n\\n\"\n\trmmod $1\n\tif [ $? != 0 ]; then\n\t\tprintf \"rmmod $1 failed\\n\"\n\t\treturn;\n\tfi\n\n\t# TEST2: Insert driver after governor\n\t# insert governor module\n\tprintf \"Inserting $2 module\\n\\n\"\n\tinsmod $2\n\tif [ $? != 0 ]; then\n\t\tprintf \"Insmod $2 failed\\n\"\n\t\treturn;\n\tfi\n\n\t# run governor tests\n\tmodule_driver_test $1\n\n\t# remove driver module\n\tprintf \"Removing $2 module\\n\\n\"\n\trmmod $2\n\tif [ $? != 0 ]; then\n\t\tprintf \"rmmod $2 failed\\n\"\n\t\treturn;\n\tfi\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}