{
  "module_name": "orc_dump.c",
  "hash_id": "ee6492ffb6e84899515d19f6963ee01120b64a39446f5626b837d9a6b9ee4cd0",
  "original_prompt": "Ingested from linux-6.6.14/tools/objtool/orc_dump.c",
  "human_readable_source": "\n \n\n#include <unistd.h>\n#include <asm/orc_types.h>\n#include <objtool/objtool.h>\n#include <objtool/warn.h>\n#include <objtool/endianness.h>\n\nstatic const char *reg_name(unsigned int reg)\n{\n\tswitch (reg) {\n\tcase ORC_REG_PREV_SP:\n\t\treturn \"prevsp\";\n\tcase ORC_REG_DX:\n\t\treturn \"dx\";\n\tcase ORC_REG_DI:\n\t\treturn \"di\";\n\tcase ORC_REG_BP:\n\t\treturn \"bp\";\n\tcase ORC_REG_SP:\n\t\treturn \"sp\";\n\tcase ORC_REG_R10:\n\t\treturn \"r10\";\n\tcase ORC_REG_R13:\n\t\treturn \"r13\";\n\tcase ORC_REG_BP_INDIRECT:\n\t\treturn \"bp(ind)\";\n\tcase ORC_REG_SP_INDIRECT:\n\t\treturn \"sp(ind)\";\n\tdefault:\n\t\treturn \"?\";\n\t}\n}\n\nstatic const char *orc_type_name(unsigned int type)\n{\n\tswitch (type) {\n\tcase ORC_TYPE_UNDEFINED:\n\t\treturn \"(und)\";\n\tcase ORC_TYPE_END_OF_STACK:\n\t\treturn \"end\";\n\tcase ORC_TYPE_CALL:\n\t\treturn \"call\";\n\tcase ORC_TYPE_REGS:\n\t\treturn \"regs\";\n\tcase ORC_TYPE_REGS_PARTIAL:\n\t\treturn \"regs (partial)\";\n\tdefault:\n\t\treturn \"?\";\n\t}\n}\n\nstatic void print_reg(unsigned int reg, int offset)\n{\n\tif (reg == ORC_REG_BP_INDIRECT)\n\t\tprintf(\"(bp%+d)\", offset);\n\telse if (reg == ORC_REG_SP_INDIRECT)\n\t\tprintf(\"(sp)%+d\", offset);\n\telse if (reg == ORC_REG_UNDEFINED)\n\t\tprintf(\"(und)\");\n\telse\n\t\tprintf(\"%s%+d\", reg_name(reg), offset);\n}\n\nint orc_dump(const char *_objname)\n{\n\tint fd, nr_entries, i, *orc_ip = NULL, orc_size = 0;\n\tstruct orc_entry *orc = NULL;\n\tchar *name;\n\tsize_t nr_sections;\n\tElf64_Addr orc_ip_addr = 0;\n\tsize_t shstrtab_idx, strtab_idx = 0;\n\tElf *elf;\n\tElf_Scn *scn;\n\tGElf_Shdr sh;\n\tGElf_Rela rela;\n\tGElf_Sym sym;\n\tElf_Data *data, *symtab = NULL, *rela_orc_ip = NULL;\n\tstruct elf dummy_elf = {};\n\n\n\tobjname = _objname;\n\n\telf_version(EV_CURRENT);\n\n\tfd = open(objname, O_RDONLY);\n\tif (fd == -1) {\n\t\tperror(\"open\");\n\t\treturn -1;\n\t}\n\n\telf = elf_begin(fd, ELF_C_READ_MMAP, NULL);\n\tif (!elf) {\n\t\tWARN_ELF(\"elf_begin\");\n\t\treturn -1;\n\t}\n\n\tif (!elf64_getehdr(elf)) {\n\t\tWARN_ELF(\"elf64_getehdr\");\n\t\treturn -1;\n\t}\n\tmemcpy(&dummy_elf.ehdr, elf64_getehdr(elf), sizeof(dummy_elf.ehdr));\n\n\tif (elf_getshdrnum(elf, &nr_sections)) {\n\t\tWARN_ELF(\"elf_getshdrnum\");\n\t\treturn -1;\n\t}\n\n\tif (elf_getshdrstrndx(elf, &shstrtab_idx)) {\n\t\tWARN_ELF(\"elf_getshdrstrndx\");\n\t\treturn -1;\n\t}\n\n\tfor (i = 0; i < nr_sections; i++) {\n\t\tscn = elf_getscn(elf, i);\n\t\tif (!scn) {\n\t\t\tWARN_ELF(\"elf_getscn\");\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (!gelf_getshdr(scn, &sh)) {\n\t\t\tWARN_ELF(\"gelf_getshdr\");\n\t\t\treturn -1;\n\t\t}\n\n\t\tname = elf_strptr(elf, shstrtab_idx, sh.sh_name);\n\t\tif (!name) {\n\t\t\tWARN_ELF(\"elf_strptr\");\n\t\t\treturn -1;\n\t\t}\n\n\t\tdata = elf_getdata(scn, NULL);\n\t\tif (!data) {\n\t\t\tWARN_ELF(\"elf_getdata\");\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (!strcmp(name, \".symtab\")) {\n\t\t\tsymtab = data;\n\t\t} else if (!strcmp(name, \".strtab\")) {\n\t\t\tstrtab_idx = i;\n\t\t} else if (!strcmp(name, \".orc_unwind\")) {\n\t\t\torc = data->d_buf;\n\t\t\torc_size = sh.sh_size;\n\t\t} else if (!strcmp(name, \".orc_unwind_ip\")) {\n\t\t\torc_ip = data->d_buf;\n\t\t\torc_ip_addr = sh.sh_addr;\n\t\t} else if (!strcmp(name, \".rela.orc_unwind_ip\")) {\n\t\t\trela_orc_ip = data;\n\t\t}\n\t}\n\n\tif (!symtab || !strtab_idx || !orc || !orc_ip)\n\t\treturn 0;\n\n\tif (orc_size % sizeof(*orc) != 0) {\n\t\tWARN(\"bad .orc_unwind section size\");\n\t\treturn -1;\n\t}\n\n\tnr_entries = orc_size / sizeof(*orc);\n\tfor (i = 0; i < nr_entries; i++) {\n\t\tif (rela_orc_ip) {\n\t\t\tif (!gelf_getrela(rela_orc_ip, i, &rela)) {\n\t\t\t\tWARN_ELF(\"gelf_getrela\");\n\t\t\t\treturn -1;\n\t\t\t}\n\n\t\t\tif (!gelf_getsym(symtab, GELF_R_SYM(rela.r_info), &sym)) {\n\t\t\t\tWARN_ELF(\"gelf_getsym\");\n\t\t\t\treturn -1;\n\t\t\t}\n\n\t\t\tif (GELF_ST_TYPE(sym.st_info) == STT_SECTION) {\n\t\t\t\tscn = elf_getscn(elf, sym.st_shndx);\n\t\t\t\tif (!scn) {\n\t\t\t\t\tWARN_ELF(\"elf_getscn\");\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\n\t\t\t\tif (!gelf_getshdr(scn, &sh)) {\n\t\t\t\t\tWARN_ELF(\"gelf_getshdr\");\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\n\t\t\t\tname = elf_strptr(elf, shstrtab_idx, sh.sh_name);\n\t\t\t\tif (!name) {\n\t\t\t\t\tWARN_ELF(\"elf_strptr\");\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tname = elf_strptr(elf, strtab_idx, sym.st_name);\n\t\t\t\tif (!name) {\n\t\t\t\t\tWARN_ELF(\"elf_strptr\");\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprintf(\"%s+%llx:\", name, (unsigned long long)rela.r_addend);\n\n\t\t} else {\n\t\t\tprintf(\"%llx:\", (unsigned long long)(orc_ip_addr + (i * sizeof(int)) + orc_ip[i]));\n\t\t}\n\n\t\tprintf(\"type:%s\", orc_type_name(orc[i].type));\n\n\t\tprintf(\" sp:\");\n\n\t\tprint_reg(orc[i].sp_reg, bswap_if_needed(&dummy_elf, orc[i].sp_offset));\n\n\t\tprintf(\" bp:\");\n\n\t\tprint_reg(orc[i].bp_reg, bswap_if_needed(&dummy_elf, orc[i].bp_offset));\n\n\t\tprintf(\" signal:%d\\n\", orc[i].signal);\n\t}\n\n\telf_end(elf);\n\tclose(fd);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}