{
  "module_name": "freefall.c",
  "hash_id": "0a3928f4d0af3a025a871e32906a73cc68515869a9be2dcef59f98611f584dd3",
  "original_prompt": "Ingested from linux-6.6.14/tools/laptop/freefall/freefall.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <string.h>\n#include <stdint.h>\n#include <errno.h>\n#include <signal.h>\n#include <sys/mman.h>\n#include <sched.h>\n#include <syslog.h>\n\nstatic int noled;\nstatic char unload_heads_path[64];\nstatic char device_path[32];\nstatic const char app_name[] = \"FREE FALL\";\n\nstatic int set_unload_heads_path(char *device)\n{\n\tif (strlen(device) <= 5 || strncmp(device, \"/dev/\", 5) != 0)\n\t\treturn -EINVAL;\n\tstrncpy(device_path, device, sizeof(device_path) - 1);\n\n\tsnprintf(unload_heads_path, sizeof(unload_heads_path) - 1,\n\t\t\t\t\"/sys/block/%s/device/unload_heads\", device+5);\n\treturn 0;\n}\n\nstatic int valid_disk(void)\n{\n\tint fd = open(unload_heads_path, O_RDONLY);\n\n\tif (fd < 0) {\n\t\tperror(unload_heads_path);\n\t\treturn 0;\n\t}\n\n\tclose(fd);\n\treturn 1;\n}\n\nstatic void write_int(char *path, int i)\n{\n\tchar buf[1024];\n\tint fd = open(path, O_RDWR);\n\n\tif (fd < 0) {\n\t\tperror(\"open\");\n\t\texit(1);\n\t}\n\n\tsprintf(buf, \"%d\", i);\n\n\tif (write(fd, buf, strlen(buf)) != strlen(buf)) {\n\t\tperror(\"write\");\n\t\texit(1);\n\t}\n\n\tclose(fd);\n}\n\nstatic void set_led(int on)\n{\n\tif (noled)\n\t\treturn;\n\twrite_int(\"/sys/class/leds/hp::hddprotect/brightness\", on);\n}\n\nstatic void protect(int seconds)\n{\n\tconst char *str = (seconds == 0) ? \"Unparked\" : \"Parked\";\n\n\twrite_int(unload_heads_path, seconds*1000);\n\tsyslog(LOG_INFO, \"%s %s disk head\\n\", str, device_path);\n}\n\nstatic int on_ac(void)\n{\n\t \n\treturn 1;\n}\n\nstatic int lid_open(void)\n{\n\t \n\treturn 1;\n}\n\nstatic void ignore_me(int signum)\n{\n\tprotect(0);\n\tset_led(0);\n}\n\nint main(int argc, char **argv)\n{\n\tint fd, ret;\n\tstruct stat st;\n\tstruct sched_param param;\n\n\tif (argc == 1)\n\t\tret = set_unload_heads_path(\"/dev/sda\");\n\telse if (argc == 2)\n\t\tret = set_unload_heads_path(argv[1]);\n\telse\n\t\tret = -EINVAL;\n\n\tif (ret || !valid_disk()) {\n\t\tfprintf(stderr, \"usage: %s <device> (default: /dev/sda)\\n\",\n\t\t\t\targv[0]);\n\t\texit(1);\n\t}\n\n\tfd = open(\"/dev/freefall\", O_RDONLY);\n\tif (fd < 0) {\n\t\tperror(\"/dev/freefall\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\tif (stat(\"/sys/class/leds/hp::hddprotect/brightness\", &st))\n\t\tnoled = 1;\n\n\tif (daemon(0, 0) != 0) {\n\t\tperror(\"daemon\");\n\t\treturn EXIT_FAILURE;\n\t}\n\n\topenlog(app_name, LOG_CONS | LOG_PID | LOG_NDELAY, LOG_LOCAL1);\n\n\tparam.sched_priority = sched_get_priority_max(SCHED_FIFO);\n\tsched_setscheduler(0, SCHED_FIFO, &param);\n\tmlockall(MCL_CURRENT|MCL_FUTURE);\n\n\tsignal(SIGALRM, ignore_me);\n\n\tfor (;;) {\n\t\tunsigned char count;\n\n\t\tret = read(fd, &count, sizeof(count));\n\t\talarm(0);\n\t\tif ((ret == -1) && (errno == EINTR)) {\n\t\t\t \n\t\t\tcontinue;\n\t\t}\n\n\t\tif (ret != sizeof(count)) {\n\t\t\tperror(\"read\");\n\t\t\tbreak;\n\t\t}\n\n\t\tprotect(21);\n\t\tset_led(1);\n\t\tif (1 || on_ac() || lid_open())\n\t\t\talarm(2);\n\t\telse\n\t\t\talarm(20);\n\t}\n\n\tcloselog();\n\tclose(fd);\n\treturn EXIT_SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}