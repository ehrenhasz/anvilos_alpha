{
  "module_name": "dslm.c",
  "hash_id": "ea38ad570e180b22ea47be2c8049ba5ce86705581c2bf13f9742e45d479ba5e6",
  "original_prompt": "Ingested from linux-6.6.14/tools/laptop/dslm/dslm.c",
  "human_readable_source": " \n#include <unistd.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <time.h>\n#include <string.h>\n#include <signal.h>\n#include <sys/ioctl.h>\n#include <linux/hdreg.h>\n\n#ifdef DEBUG\n#define D(x) x\n#else\n#define D(x)\n#endif\n\nint endit = 0;\n\n \nstatic int check_powermode(int fd)\n{\n    unsigned char args[4] = {WIN_CHECKPOWERMODE1,0,0,0};\n    int state;\n\n    if (ioctl(fd, HDIO_DRIVE_CMD, &args)\n\t&& (args[0] = WIN_CHECKPOWERMODE2)  \n\t&& ioctl(fd, HDIO_DRIVE_CMD, &args)) {\n\tif (errno != EIO || args[0] != 0 || args[1] != 0) {\n\t    state = -1;  \n\t} else\n\t    state = 0;  \n    } else {\n\tstate = (args[2] == 255) ? 1 : 0;\n    }\n    D(printf(\" drive state is:  %d\\n\", state));\n\n    return state;\n}\n\nstatic char *state_name(int i)\n{\n    if (i == -1) return \"unknown\";\n    if (i == 0) return \"sleeping\";\n    if (i == 1) return \"active\";\n\n    return \"internal error\";\n}\n\nstatic char *myctime(time_t time)\n{\n    char *ts = ctime(&time);\n    ts[strlen(ts) - 1] = 0;\n\n    return ts;\n}\n\nstatic void measure(int fd)\n{\n    time_t start_time;\n    int last_state;\n    time_t last_time;\n    int curr_state;\n    time_t curr_time = 0;\n    time_t time_diff;\n    time_t active_time = 0;\n    time_t sleep_time = 0;\n    time_t unknown_time = 0;\n    time_t total_time = 0;\n    int changes = 0;\n    float tmp;\n\n    printf(\"Starting measurements\\n\");\n\n    last_state = check_powermode(fd);\n    start_time = last_time = time(0);\n    printf(\"  System is in state %s\\n\\n\", state_name(last_state));\n\n    while(!endit) {\n\tsleep(1);\n\tcurr_state = check_powermode(fd);\n\n\tif (curr_state != last_state || endit) {\n\t    changes++;\n\t    curr_time = time(0);\n\t    time_diff = curr_time - last_time;\n\n\t    if (last_state == 1) active_time += time_diff;\n\t    else if (last_state == 0) sleep_time += time_diff;\n\t    else unknown_time += time_diff;\n\n\t    last_state = curr_state;\n\t    last_time = curr_time;\n\n\t    printf(\"%s: State-change to %s\\n\", myctime(curr_time),\n\t\t   state_name(curr_state));\n\t}\n    }\n    changes--;  \n\n    total_time = time(0) - start_time;\n    printf(\"\\nTotal running time:  %lus\\n\", curr_time - start_time);\n    printf(\" State changed %d times\\n\", changes);\n\n    tmp = (float)sleep_time / (float)total_time * 100;\n    printf(\" Time in sleep state:   %lus (%.2f%%)\\n\", sleep_time, tmp);\n    tmp = (float)active_time / (float)total_time * 100;\n    printf(\" Time in active state:  %lus (%.2f%%)\\n\", active_time, tmp);\n    tmp = (float)unknown_time / (float)total_time * 100;\n    printf(\" Time in unknown state: %lus (%.2f%%)\\n\", unknown_time, tmp);\n}\n\nstatic void ender(int s)\n{\n    endit = 1;\n}\n\nstatic void usage(void)\n{\n    puts(\"usage: dslm [-w <time>] <disk>\");\n    exit(0);\n}\n\nint main(int argc, char **argv)\n{\n    int fd;\n    char *disk = 0;\n    int settle_time = 60;\n\n     \n    if (argc == 2)\n\tdisk = argv[1];\n    else if (argc == 4) {\n\tsettle_time = atoi(argv[2]);\n\tdisk = argv[3];\n    } else\n\tusage();\n\n    if (!(fd = open(disk, O_RDONLY|O_NONBLOCK))) {\n\tprintf(\"Can't open %s, because: %s\\n\", disk, strerror(errno));\n\texit(-1);\n    }\n\n    if (settle_time) {\n\tprintf(\"Waiting %d seconds for the system to settle down to \"\n\t       \"'normal'\\n\", settle_time);\n\tsleep(settle_time);\n    } else\n\tputs(\"Not waiting for system to settle down\");\n\n    signal(SIGINT, ender);\n\n    measure(fd);\n\n    close(fd);\n\n    return 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}