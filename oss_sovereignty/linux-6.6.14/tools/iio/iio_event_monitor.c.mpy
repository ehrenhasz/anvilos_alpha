{
  "module_name": "iio_event_monitor.c",
  "hash_id": "863602cea067ad6c1b8cc2af37185433695e1128b0fa0b33b617e0911aa11c0b",
  "original_prompt": "Ingested from linux-6.6.14/tools/iio/iio_event_monitor.c",
  "human_readable_source": "\n \n\n#include <unistd.h>\n#include <stdlib.h>\n#include <dirent.h>\n#include <stdbool.h>\n#include <stdio.h>\n#include <errno.h>\n#include <string.h>\n#include <poll.h>\n#include <fcntl.h>\n#include <sys/ioctl.h>\n#include \"iio_utils.h\"\n#include <linux/iio/events.h>\n#include <linux/iio/types.h>\n\nstatic const char * const iio_chan_type_name_spec[] = {\n\t[IIO_VOLTAGE] = \"voltage\",\n\t[IIO_CURRENT] = \"current\",\n\t[IIO_POWER] = \"power\",\n\t[IIO_ACCEL] = \"accel\",\n\t[IIO_ANGL_VEL] = \"anglvel\",\n\t[IIO_MAGN] = \"magn\",\n\t[IIO_LIGHT] = \"illuminance\",\n\t[IIO_INTENSITY] = \"intensity\",\n\t[IIO_PROXIMITY] = \"proximity\",\n\t[IIO_TEMP] = \"temp\",\n\t[IIO_INCLI] = \"incli\",\n\t[IIO_ROT] = \"rot\",\n\t[IIO_ANGL] = \"angl\",\n\t[IIO_TIMESTAMP] = \"timestamp\",\n\t[IIO_CAPACITANCE] = \"capacitance\",\n\t[IIO_ALTVOLTAGE] = \"altvoltage\",\n\t[IIO_CCT] = \"cct\",\n\t[IIO_PRESSURE] = \"pressure\",\n\t[IIO_HUMIDITYRELATIVE] = \"humidityrelative\",\n\t[IIO_ACTIVITY] = \"activity\",\n\t[IIO_STEPS] = \"steps\",\n\t[IIO_ENERGY] = \"energy\",\n\t[IIO_DISTANCE] = \"distance\",\n\t[IIO_VELOCITY] = \"velocity\",\n\t[IIO_CONCENTRATION] = \"concentration\",\n\t[IIO_RESISTANCE] = \"resistance\",\n\t[IIO_PH] = \"ph\",\n\t[IIO_UVINDEX] = \"uvindex\",\n\t[IIO_GRAVITY] = \"gravity\",\n\t[IIO_POSITIONRELATIVE] = \"positionrelative\",\n\t[IIO_PHASE] = \"phase\",\n\t[IIO_MASSCONCENTRATION] = \"massconcentration\",\n};\n\nstatic const char * const iio_ev_type_text[] = {\n\t[IIO_EV_TYPE_THRESH] = \"thresh\",\n\t[IIO_EV_TYPE_MAG] = \"mag\",\n\t[IIO_EV_TYPE_ROC] = \"roc\",\n\t[IIO_EV_TYPE_THRESH_ADAPTIVE] = \"thresh_adaptive\",\n\t[IIO_EV_TYPE_MAG_ADAPTIVE] = \"mag_adaptive\",\n\t[IIO_EV_TYPE_CHANGE] = \"change\",\n\t[IIO_EV_TYPE_MAG_REFERENCED] = \"mag_referenced\",\n\t[IIO_EV_TYPE_GESTURE] = \"gesture\",\n};\n\nstatic const char * const iio_ev_dir_text[] = {\n\t[IIO_EV_DIR_EITHER] = \"either\",\n\t[IIO_EV_DIR_RISING] = \"rising\",\n\t[IIO_EV_DIR_FALLING] = \"falling\",\n\t[IIO_EV_DIR_SINGLETAP] = \"singletap\",\n\t[IIO_EV_DIR_DOUBLETAP] = \"doubletap\",\n};\n\nstatic const char * const iio_modifier_names[] = {\n\t[IIO_MOD_X] = \"x\",\n\t[IIO_MOD_Y] = \"y\",\n\t[IIO_MOD_Z] = \"z\",\n\t[IIO_MOD_X_AND_Y] = \"x&y\",\n\t[IIO_MOD_X_AND_Z] = \"x&z\",\n\t[IIO_MOD_Y_AND_Z] = \"y&z\",\n\t[IIO_MOD_X_AND_Y_AND_Z] = \"x&y&z\",\n\t[IIO_MOD_X_OR_Y] = \"x|y\",\n\t[IIO_MOD_X_OR_Z] = \"x|z\",\n\t[IIO_MOD_Y_OR_Z] = \"y|z\",\n\t[IIO_MOD_X_OR_Y_OR_Z] = \"x|y|z\",\n\t[IIO_MOD_LIGHT_BOTH] = \"both\",\n\t[IIO_MOD_LIGHT_IR] = \"ir\",\n\t[IIO_MOD_ROOT_SUM_SQUARED_X_Y] = \"sqrt(x^2+y^2)\",\n\t[IIO_MOD_SUM_SQUARED_X_Y_Z] = \"x^2+y^2+z^2\",\n\t[IIO_MOD_LIGHT_CLEAR] = \"clear\",\n\t[IIO_MOD_LIGHT_RED] = \"red\",\n\t[IIO_MOD_LIGHT_GREEN] = \"green\",\n\t[IIO_MOD_LIGHT_BLUE] = \"blue\",\n\t[IIO_MOD_LIGHT_UV] = \"uv\",\n\t[IIO_MOD_LIGHT_DUV] = \"duv\",\n\t[IIO_MOD_QUATERNION] = \"quaternion\",\n\t[IIO_MOD_TEMP_AMBIENT] = \"ambient\",\n\t[IIO_MOD_TEMP_OBJECT] = \"object\",\n\t[IIO_MOD_NORTH_MAGN] = \"from_north_magnetic\",\n\t[IIO_MOD_NORTH_TRUE] = \"from_north_true\",\n\t[IIO_MOD_NORTH_MAGN_TILT_COMP] = \"from_north_magnetic_tilt_comp\",\n\t[IIO_MOD_NORTH_TRUE_TILT_COMP] = \"from_north_true_tilt_comp\",\n\t[IIO_MOD_RUNNING] = \"running\",\n\t[IIO_MOD_JOGGING] = \"jogging\",\n\t[IIO_MOD_WALKING] = \"walking\",\n\t[IIO_MOD_STILL] = \"still\",\n\t[IIO_MOD_ROOT_SUM_SQUARED_X_Y_Z] = \"sqrt(x^2+y^2+z^2)\",\n\t[IIO_MOD_I] = \"i\",\n\t[IIO_MOD_Q] = \"q\",\n\t[IIO_MOD_CO2] = \"co2\",\n\t[IIO_MOD_ETHANOL] = \"ethanol\",\n\t[IIO_MOD_H2] = \"h2\",\n\t[IIO_MOD_VOC] = \"voc\",\n\t[IIO_MOD_PM1] = \"pm1\",\n\t[IIO_MOD_PM2P5] = \"pm2p5\",\n\t[IIO_MOD_PM4] = \"pm4\",\n\t[IIO_MOD_PM10] = \"pm10\",\n\t[IIO_MOD_O2] = \"o2\",\n\t[IIO_MOD_LINEAR_X] = \"linear_x\",\n\t[IIO_MOD_LINEAR_Y] = \"linear_y\",\n\t[IIO_MOD_LINEAR_Z] = \"linear_z\",\n\t[IIO_MOD_PITCH] = \"pitch\",\n\t[IIO_MOD_YAW] = \"yaw\",\n\t[IIO_MOD_ROLL] = \"roll\",\n};\n\nstatic bool event_is_known(struct iio_event_data *event)\n{\n\tenum iio_chan_type type = IIO_EVENT_CODE_EXTRACT_CHAN_TYPE(event->id);\n\tenum iio_modifier mod = IIO_EVENT_CODE_EXTRACT_MODIFIER(event->id);\n\tenum iio_event_type ev_type = IIO_EVENT_CODE_EXTRACT_TYPE(event->id);\n\tenum iio_event_direction dir = IIO_EVENT_CODE_EXTRACT_DIR(event->id);\n\n\tswitch (type) {\n\tcase IIO_VOLTAGE:\n\tcase IIO_CURRENT:\n\tcase IIO_POWER:\n\tcase IIO_ACCEL:\n\tcase IIO_ANGL_VEL:\n\tcase IIO_MAGN:\n\tcase IIO_LIGHT:\n\tcase IIO_INTENSITY:\n\tcase IIO_PROXIMITY:\n\tcase IIO_TEMP:\n\tcase IIO_INCLI:\n\tcase IIO_ROT:\n\tcase IIO_ANGL:\n\tcase IIO_TIMESTAMP:\n\tcase IIO_CAPACITANCE:\n\tcase IIO_ALTVOLTAGE:\n\tcase IIO_CCT:\n\tcase IIO_PRESSURE:\n\tcase IIO_HUMIDITYRELATIVE:\n\tcase IIO_ACTIVITY:\n\tcase IIO_STEPS:\n\tcase IIO_ENERGY:\n\tcase IIO_DISTANCE:\n\tcase IIO_VELOCITY:\n\tcase IIO_CONCENTRATION:\n\tcase IIO_RESISTANCE:\n\tcase IIO_PH:\n\tcase IIO_UVINDEX:\n\tcase IIO_GRAVITY:\n\tcase IIO_POSITIONRELATIVE:\n\tcase IIO_PHASE:\n\tcase IIO_MASSCONCENTRATION:\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\tswitch (mod) {\n\tcase IIO_NO_MOD:\n\tcase IIO_MOD_X:\n\tcase IIO_MOD_Y:\n\tcase IIO_MOD_Z:\n\tcase IIO_MOD_X_AND_Y:\n\tcase IIO_MOD_X_AND_Z:\n\tcase IIO_MOD_Y_AND_Z:\n\tcase IIO_MOD_X_AND_Y_AND_Z:\n\tcase IIO_MOD_X_OR_Y:\n\tcase IIO_MOD_X_OR_Z:\n\tcase IIO_MOD_Y_OR_Z:\n\tcase IIO_MOD_X_OR_Y_OR_Z:\n\tcase IIO_MOD_LIGHT_BOTH:\n\tcase IIO_MOD_LIGHT_IR:\n\tcase IIO_MOD_ROOT_SUM_SQUARED_X_Y:\n\tcase IIO_MOD_SUM_SQUARED_X_Y_Z:\n\tcase IIO_MOD_LIGHT_CLEAR:\n\tcase IIO_MOD_LIGHT_RED:\n\tcase IIO_MOD_LIGHT_GREEN:\n\tcase IIO_MOD_LIGHT_BLUE:\n\tcase IIO_MOD_LIGHT_UV:\n\tcase IIO_MOD_LIGHT_DUV:\n\tcase IIO_MOD_QUATERNION:\n\tcase IIO_MOD_TEMP_AMBIENT:\n\tcase IIO_MOD_TEMP_OBJECT:\n\tcase IIO_MOD_NORTH_MAGN:\n\tcase IIO_MOD_NORTH_TRUE:\n\tcase IIO_MOD_NORTH_MAGN_TILT_COMP:\n\tcase IIO_MOD_NORTH_TRUE_TILT_COMP:\n\tcase IIO_MOD_RUNNING:\n\tcase IIO_MOD_JOGGING:\n\tcase IIO_MOD_WALKING:\n\tcase IIO_MOD_STILL:\n\tcase IIO_MOD_ROOT_SUM_SQUARED_X_Y_Z:\n\tcase IIO_MOD_I:\n\tcase IIO_MOD_Q:\n\tcase IIO_MOD_CO2:\n\tcase IIO_MOD_ETHANOL:\n\tcase IIO_MOD_H2:\n\tcase IIO_MOD_VOC:\n\tcase IIO_MOD_PM1:\n\tcase IIO_MOD_PM2P5:\n\tcase IIO_MOD_PM4:\n\tcase IIO_MOD_PM10:\n\tcase IIO_MOD_O2:\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\tswitch (ev_type) {\n\tcase IIO_EV_TYPE_THRESH:\n\tcase IIO_EV_TYPE_MAG:\n\tcase IIO_EV_TYPE_ROC:\n\tcase IIO_EV_TYPE_THRESH_ADAPTIVE:\n\tcase IIO_EV_TYPE_MAG_ADAPTIVE:\n\tcase IIO_EV_TYPE_CHANGE:\n\tcase IIO_EV_TYPE_GESTURE:\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\tswitch (dir) {\n\tcase IIO_EV_DIR_EITHER:\n\tcase IIO_EV_DIR_RISING:\n\tcase IIO_EV_DIR_FALLING:\n\tcase IIO_EV_DIR_SINGLETAP:\n\tcase IIO_EV_DIR_DOUBLETAP:\n\tcase IIO_EV_DIR_NONE:\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void print_event(struct iio_event_data *event)\n{\n\tenum iio_chan_type type = IIO_EVENT_CODE_EXTRACT_CHAN_TYPE(event->id);\n\tenum iio_modifier mod = IIO_EVENT_CODE_EXTRACT_MODIFIER(event->id);\n\tenum iio_event_type ev_type = IIO_EVENT_CODE_EXTRACT_TYPE(event->id);\n\tenum iio_event_direction dir = IIO_EVENT_CODE_EXTRACT_DIR(event->id);\n\tint chan = IIO_EVENT_CODE_EXTRACT_CHAN(event->id);\n\tint chan2 = IIO_EVENT_CODE_EXTRACT_CHAN2(event->id);\n\tbool diff = IIO_EVENT_CODE_EXTRACT_DIFF(event->id);\n\n\tif (!event_is_known(event)) {\n\t\tfprintf(stderr, \"Unknown event: time: %lld, id: %llx\\n\",\n\t\t\tevent->timestamp, event->id);\n\n\t\treturn;\n\t}\n\n\tprintf(\"Event: time: %lld, type: %s\", event->timestamp,\n\t       iio_chan_type_name_spec[type]);\n\n\tif (mod != IIO_NO_MOD)\n\t\tprintf(\"(%s)\", iio_modifier_names[mod]);\n\n\tif (chan >= 0) {\n\t\tprintf(\", channel: %d\", chan);\n\t\tif (diff && chan2 >= 0)\n\t\t\tprintf(\"-%d\", chan2);\n\t}\n\n\tprintf(\", evtype: %s\", iio_ev_type_text[ev_type]);\n\n\tif (dir != IIO_EV_DIR_NONE)\n\t\tprintf(\", direction: %s\", iio_ev_dir_text[dir]);\n\n\tprintf(\"\\n\");\n\tfflush(stdout);\n}\n\n \nstatic void enable_events(char *dev_dir, int enable)\n{\n\tconst struct dirent *ent;\n\tchar evdir[256];\n\tint ret;\n\tDIR *dp;\n\n\tsnprintf(evdir, sizeof(evdir), FORMAT_EVENTS_DIR, dev_dir);\n\tevdir[sizeof(evdir)-1] = '\\0';\n\n\tdp = opendir(evdir);\n\tif (!dp) {\n\t\tfprintf(stderr, \"Enabling/disabling events: can't open %s\\n\",\n\t\t\tevdir);\n\t\treturn;\n\t}\n\n\twhile (ent = readdir(dp), ent) {\n\t\tif (iioutils_check_suffix(ent->d_name, \"_en\")) {\n\t\t\tprintf(\"%sabling: %s\\n\",\n\t\t\t       enable ? \"En\" : \"Dis\",\n\t\t\t       ent->d_name);\n\t\t\tret = write_sysfs_int(ent->d_name, evdir,\n\t\t\t\t\t      enable);\n\t\t\tif (ret < 0)\n\t\t\t\tfprintf(stderr, \"Failed to enable/disable %s\\n\",\n\t\t\t\t\tent->d_name);\n\t\t}\n\t}\n\n\tif (closedir(dp) == -1) {\n\t\tperror(\"Enabling/disabling channels: \"\n\t\t       \"Failed to close directory\");\n\t\treturn;\n\t}\n}\n\nint main(int argc, char **argv)\n{\n\tstruct iio_event_data event;\n\tconst char *device_name;\n\tchar *dev_dir_name = NULL;\n\tchar *chrdev_name;\n\tint ret;\n\tint dev_num;\n\tint fd, event_fd;\n\tbool all_events = false;\n\n\tif (argc == 2) {\n\t\tdevice_name = argv[1];\n\t} else if (argc == 3) {\n\t\tdevice_name = argv[2];\n\t\tif (!strcmp(argv[1], \"-a\"))\n\t\t\tall_events = true;\n\t} else {\n\t\tfprintf(stderr,\n\t\t\t\"Usage: iio_event_monitor [options] <device_name>\\n\"\n\t\t\t\"Listen and display events from IIO devices\\n\"\n\t\t\t\"  -a         Auto-activate all available events\\n\");\n\t\treturn -1;\n\t}\n\n\tdev_num = find_type_by_name(device_name, \"iio:device\");\n\tif (dev_num >= 0) {\n\t\tprintf(\"Found IIO device with name %s with device number %d\\n\",\n\t\t       device_name, dev_num);\n\t\tret = asprintf(&chrdev_name, \"/dev/iio:device%d\", dev_num);\n\t\tif (ret < 0)\n\t\t\treturn -ENOMEM;\n\t\t \n\t\tret = asprintf(&dev_dir_name, \"%siio:device%d\", iio_dir, dev_num);\n\t\tif (ret < 0)\n\t\t\treturn -ENOMEM;\n\t} else {\n\t\t \n\t\tchrdev_name = strdup(device_name);\n\t\tif (!chrdev_name)\n\t\t\treturn -ENOMEM;\n\t}\n\n\tif (all_events && dev_dir_name)\n\t\tenable_events(dev_dir_name, 1);\n\n\tfd = open(chrdev_name, 0);\n\tif (fd == -1) {\n\t\tret = -errno;\n\t\tfprintf(stderr, \"Failed to open %s\\n\", chrdev_name);\n\t\tgoto error_free_chrdev_name;\n\t}\n\n\tret = ioctl(fd, IIO_GET_EVENT_FD_IOCTL, &event_fd);\n\tif (ret == -1 || event_fd == -1) {\n\t\tret = -errno;\n\t\tif (ret == -ENODEV)\n\t\t\tfprintf(stderr,\n\t\t\t\t\"This device does not support events\\n\");\n\t\telse\n\t\t\tfprintf(stderr, \"Failed to retrieve event fd\\n\");\n\t\tif (close(fd) == -1)\n\t\t\tperror(\"Failed to close character device file\");\n\n\t\tgoto error_free_chrdev_name;\n\t}\n\n\tif (close(fd) == -1)  {\n\t\tret = -errno;\n\t\tgoto error_free_chrdev_name;\n\t}\n\n\twhile (true) {\n\t\tret = read(event_fd, &event, sizeof(event));\n\t\tif (ret == -1) {\n\t\t\tif (errno == EAGAIN) {\n\t\t\t\tfprintf(stderr, \"nothing available\\n\");\n\t\t\t\tcontinue;\n\t\t\t} else {\n\t\t\t\tret = -errno;\n\t\t\t\tperror(\"Failed to read event from device\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (ret != sizeof(event)) {\n\t\t\tfprintf(stderr, \"Reading event failed!\\n\");\n\t\t\tret = -EIO;\n\t\t\tbreak;\n\t\t}\n\n\t\tprint_event(&event);\n\t}\n\n\tif (close(event_fd) == -1)\n\t\tperror(\"Failed to close event file\");\n\nerror_free_chrdev_name:\n\t \n\tif (all_events && dev_dir_name)\n\t\tenable_events(dev_dir_name, 0);\n\n\tfree(chrdev_name);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}