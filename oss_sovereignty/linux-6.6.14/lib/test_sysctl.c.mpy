{
  "module_name": "test_sysctl.c",
  "hash_id": "a53fbd51bb05a34cb1bcf773ec603d7eb625f8715a15f82ec77d6ad9db9cbf12",
  "original_prompt": "Ingested from linux-6.6.14/lib/test_sysctl.c",
  "human_readable_source": "\n \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/init.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/printk.h>\n#include <linux/fs.h>\n#include <linux/miscdevice.h>\n#include <linux/slab.h>\n#include <linux/uaccess.h>\n#include <linux/async.h>\n#include <linux/delay.h>\n#include <linux/vmalloc.h>\n\nstatic int i_zero;\nstatic int i_one_hundred = 100;\nstatic int match_int_ok = 1;\n\n\nstatic struct {\n\tstruct ctl_table_header *test_h_setup_node;\n\tstruct ctl_table_header *test_h_mnt;\n\tstruct ctl_table_header *test_h_mnterror;\n} sysctl_test_headers;\n\nstruct test_sysctl_data {\n\tint int_0001;\n\tint int_0002;\n\tint int_0003[4];\n\n\tint boot_int;\n\n\tunsigned int uint_0001;\n\n\tchar string_0001[65];\n\n#define SYSCTL_TEST_BITMAP_SIZE\t65536\n\tunsigned long *bitmap_0001;\n};\n\nstatic struct test_sysctl_data test_data = {\n\t.int_0001 = 60,\n\t.int_0002 = 1,\n\n\t.int_0003[0] = 0,\n\t.int_0003[1] = 1,\n\t.int_0003[2] = 2,\n\t.int_0003[3] = 3,\n\n\t.boot_int = 0,\n\n\t.uint_0001 = 314,\n\n\t.string_0001 = \"(none)\",\n};\n\n \nstatic struct ctl_table test_table[] = {\n\t{\n\t\t.procname\t= \"int_0001\",\n\t\t.data\t\t= &test_data.int_0001,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t\t.extra1\t\t= &i_zero,\n\t\t.extra2         = &i_one_hundred,\n\t},\n\t{\n\t\t.procname\t= \"int_0002\",\n\t\t.data\t\t= &test_data.int_0002,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t},\n\t{\n\t\t.procname\t= \"int_0003\",\n\t\t.data\t\t= &test_data.int_0003,\n\t\t.maxlen\t\t= sizeof(test_data.int_0003),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t},\n\t{\n\t\t.procname\t= \"match_int\",\n\t\t.data\t\t= &match_int_ok,\n\t\t.maxlen\t\t= sizeof(match_int_ok),\n\t\t.mode\t\t= 0444,\n\t\t.proc_handler\t= proc_dointvec,\n\t},\n\t{\n\t\t.procname\t= \"boot_int\",\n\t\t.data\t\t= &test_data.boot_int,\n\t\t.maxlen\t\t= sizeof(test_data.boot_int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE,\n\t},\n\t{\n\t\t.procname\t= \"uint_0001\",\n\t\t.data\t\t= &test_data.uint_0001,\n\t\t.maxlen\t\t= sizeof(unsigned int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_douintvec,\n\t},\n\t{\n\t\t.procname\t= \"string_0001\",\n\t\t.data\t\t= &test_data.string_0001,\n\t\t.maxlen\t\t= sizeof(test_data.string_0001),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dostring,\n\t},\n\t{\n\t\t.procname\t= \"bitmap_0001\",\n\t\t.data\t\t= &test_data.bitmap_0001,\n\t\t.maxlen\t\t= SYSCTL_TEST_BITMAP_SIZE,\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_do_large_bitmap,\n\t},\n\t{ }\n};\n\nstatic void test_sysctl_calc_match_int_ok(void)\n{\n\tint i;\n\n\tstruct {\n\t\tint defined;\n\t\tint wanted;\n\t} match_int[] = {\n\t\t{.defined = *(int *)SYSCTL_ZERO,\t.wanted = 0},\n\t\t{.defined = *(int *)SYSCTL_ONE,\t\t.wanted = 1},\n\t\t{.defined = *(int *)SYSCTL_TWO,\t\t.wanted = 2},\n\t\t{.defined = *(int *)SYSCTL_THREE,\t.wanted = 3},\n\t\t{.defined = *(int *)SYSCTL_FOUR,\t.wanted = 4},\n\t\t{.defined = *(int *)SYSCTL_ONE_HUNDRED, .wanted = 100},\n\t\t{.defined = *(int *)SYSCTL_TWO_HUNDRED,\t.wanted = 200},\n\t\t{.defined = *(int *)SYSCTL_ONE_THOUSAND, .wanted = 1000},\n\t\t{.defined = *(int *)SYSCTL_THREE_THOUSAND, .wanted = 3000},\n\t\t{.defined = *(int *)SYSCTL_INT_MAX,\t.wanted = INT_MAX},\n\t\t{.defined = *(int *)SYSCTL_MAXOLDUID,\t.wanted = 65535},\n\t\t{.defined = *(int *)SYSCTL_NEG_ONE,\t.wanted = -1},\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(match_int); i++)\n\t\tif (match_int[i].defined != match_int[i].wanted)\n\t\t\tmatch_int_ok = 0;\n}\n\nstatic int test_sysctl_setup_node_tests(void)\n{\n\ttest_sysctl_calc_match_int_ok();\n\ttest_data.bitmap_0001 = kzalloc(SYSCTL_TEST_BITMAP_SIZE/8, GFP_KERNEL);\n\tif (!test_data.bitmap_0001)\n\t\treturn -ENOMEM;\n\tsysctl_test_headers.test_h_setup_node = register_sysctl(\"debug/test_sysctl\", test_table);\n\tif (!sysctl_test_headers.test_h_setup_node) {\n\t\tkfree(test_data.bitmap_0001);\n\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\n \nstatic struct ctl_table test_table_unregister[] = {\n\t{\n\t\t.procname\t= \"unregister_error\",\n\t\t.data\t\t= &test_data.int_0001,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec_minmax,\n\t},\n\t{}\n};\n\nstatic int test_sysctl_run_unregister_nested(void)\n{\n\tstruct ctl_table_header *unregister;\n\n\tunregister = register_sysctl(\"debug/test_sysctl/unregister_error\",\n\t\t\t\t   test_table_unregister);\n\tif (!unregister)\n\t\treturn -ENOMEM;\n\n\tunregister_sysctl_table(unregister);\n\treturn 0;\n}\n\nstatic int test_sysctl_run_register_mount_point(void)\n{\n\tsysctl_test_headers.test_h_mnt\n\t\t= register_sysctl_mount_point(\"debug/test_sysctl/mnt\");\n\tif (!sysctl_test_headers.test_h_mnt)\n\t\treturn -ENOMEM;\n\n\tsysctl_test_headers.test_h_mnterror\n\t\t= register_sysctl(\"debug/test_sysctl/mnt/mnt_error\",\n\t\t\t\t  test_table_unregister);\n\t \n\n\treturn 0;\n}\n\nstatic int __init test_sysctl_init(void)\n{\n\tint err;\n\n\terr = test_sysctl_setup_node_tests();\n\tif (err)\n\t\tgoto out;\n\n\terr = test_sysctl_run_unregister_nested();\n\tif (err)\n\t\tgoto out;\n\n\terr = test_sysctl_run_register_mount_point();\n\nout:\n\treturn err;\n}\nmodule_init(test_sysctl_init);\n\nstatic void __exit test_sysctl_exit(void)\n{\n\tkfree(test_data.bitmap_0001);\n\tif (sysctl_test_headers.test_h_setup_node)\n\t\tunregister_sysctl_table(sysctl_test_headers.test_h_setup_node);\n\tif (sysctl_test_headers.test_h_mnt)\n\t\tunregister_sysctl_table(sysctl_test_headers.test_h_mnt);\n\tif (sysctl_test_headers.test_h_mnterror)\n\t\tunregister_sysctl_table(sysctl_test_headers.test_h_mnterror);\n}\n\nmodule_exit(test_sysctl_exit);\n\nMODULE_AUTHOR(\"Luis R. Rodriguez <mcgrof@kernel.org>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}