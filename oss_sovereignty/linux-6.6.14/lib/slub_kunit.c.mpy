{
  "module_name": "slub_kunit.c",
  "hash_id": "f4f5fc1c8a7c65f2c24cbaa5a12b9f1d2f3599f1f8124a98c91897ad0ffde16e",
  "original_prompt": "Ingested from linux-6.6.14/lib/slub_kunit.c",
  "human_readable_source": "\n#include <kunit/test.h>\n#include <kunit/test-bug.h>\n#include <linux/mm.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include \"../mm/slab.h\"\n\nstatic struct kunit_resource resource;\nstatic int slab_errors;\n\n \nstatic struct kmem_cache *test_kmem_cache_create(const char *name,\n\t\t\t\tunsigned int size, slab_flags_t flags)\n{\n\tstruct kmem_cache *s = kmem_cache_create(name, size, 0,\n\t\t\t\t\t(flags | SLAB_NO_USER_FLAGS), NULL);\n\ts->flags |= SLAB_SKIP_KFENCE;\n\treturn s;\n}\n\nstatic void test_clobber_zone(struct kunit *test)\n{\n\tstruct kmem_cache *s = test_kmem_cache_create(\"TestSlub_RZ_alloc\", 64,\n\t\t\t\t\t\t\tSLAB_RED_ZONE);\n\tu8 *p = kmem_cache_alloc(s, GFP_KERNEL);\n\n\tkasan_disable_current();\n\tp[64] = 0x12;\n\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 2, slab_errors);\n\n\tkasan_enable_current();\n\tkmem_cache_free(s, p);\n\tkmem_cache_destroy(s);\n}\n\n#ifndef CONFIG_KASAN\nstatic void test_next_pointer(struct kunit *test)\n{\n\tstruct kmem_cache *s = test_kmem_cache_create(\"TestSlub_next_ptr_free\",\n\t\t\t\t\t\t\t64, SLAB_POISON);\n\tu8 *p = kmem_cache_alloc(s, GFP_KERNEL);\n\tunsigned long tmp;\n\tunsigned long *ptr_addr;\n\n\tkmem_cache_free(s, p);\n\n\tptr_addr = (unsigned long *)(p + s->offset);\n\ttmp = *ptr_addr;\n\tp[s->offset] = 0x12;\n\n\t \n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 3, slab_errors);\n\n\t \n\t*ptr_addr = tmp;\n\tslab_errors = 0;\n\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 2, slab_errors);\n\n\t \n\tslab_errors = 0;\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 0, slab_errors);\n\n\tkmem_cache_destroy(s);\n}\n\nstatic void test_first_word(struct kunit *test)\n{\n\tstruct kmem_cache *s = test_kmem_cache_create(\"TestSlub_1th_word_free\",\n\t\t\t\t\t\t\t64, SLAB_POISON);\n\tu8 *p = kmem_cache_alloc(s, GFP_KERNEL);\n\n\tkmem_cache_free(s, p);\n\t*p = 0x78;\n\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 2, slab_errors);\n\n\tkmem_cache_destroy(s);\n}\n\nstatic void test_clobber_50th_byte(struct kunit *test)\n{\n\tstruct kmem_cache *s = test_kmem_cache_create(\"TestSlub_50th_word_free\",\n\t\t\t\t\t\t\t64, SLAB_POISON);\n\tu8 *p = kmem_cache_alloc(s, GFP_KERNEL);\n\n\tkmem_cache_free(s, p);\n\tp[50] = 0x9a;\n\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 2, slab_errors);\n\n\tkmem_cache_destroy(s);\n}\n#endif\n\nstatic void test_clobber_redzone_free(struct kunit *test)\n{\n\tstruct kmem_cache *s = test_kmem_cache_create(\"TestSlub_RZ_free\", 64,\n\t\t\t\t\t\t\tSLAB_RED_ZONE);\n\tu8 *p = kmem_cache_alloc(s, GFP_KERNEL);\n\n\tkasan_disable_current();\n\tkmem_cache_free(s, p);\n\tp[64] = 0xab;\n\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 2, slab_errors);\n\n\tkasan_enable_current();\n\tkmem_cache_destroy(s);\n}\n\nstatic void test_kmalloc_redzone_access(struct kunit *test)\n{\n\tstruct kmem_cache *s = test_kmem_cache_create(\"TestSlub_RZ_kmalloc\", 32,\n\t\t\t\tSLAB_KMALLOC|SLAB_STORE_USER|SLAB_RED_ZONE);\n\tu8 *p = kmalloc_trace(s, GFP_KERNEL, 18);\n\n\tkasan_disable_current();\n\n\t \n\tOPTIMIZER_HIDE_VAR(p);\n\tp[18] = 0xab;\n\tp[19] = 0xab;\n\n\tvalidate_slab_cache(s);\n\tKUNIT_EXPECT_EQ(test, 2, slab_errors);\n\n\tkasan_enable_current();\n\tkmem_cache_free(s, p);\n\tkmem_cache_destroy(s);\n}\n\nstatic int test_init(struct kunit *test)\n{\n\tslab_errors = 0;\n\n\tkunit_add_named_resource(test, NULL, NULL, &resource,\n\t\t\t\t\t\"slab_errors\", &slab_errors);\n\treturn 0;\n}\n\nstatic struct kunit_case test_cases[] = {\n\tKUNIT_CASE(test_clobber_zone),\n\n#ifndef CONFIG_KASAN\n\tKUNIT_CASE(test_next_pointer),\n\tKUNIT_CASE(test_first_word),\n\tKUNIT_CASE(test_clobber_50th_byte),\n#endif\n\n\tKUNIT_CASE(test_clobber_redzone_free),\n\tKUNIT_CASE(test_kmalloc_redzone_access),\n\t{}\n};\n\nstatic struct kunit_suite test_suite = {\n\t.name = \"slub_test\",\n\t.init = test_init,\n\t.test_cases = test_cases,\n};\nkunit_test_suite(test_suite);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}