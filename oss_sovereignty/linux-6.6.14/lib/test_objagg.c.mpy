{
  "module_name": "test_objagg.c",
  "hash_id": "97fba2eab7882b8b4e3387435aa0d68607ea1e917979df3ee134a6bf55bdb08f",
  "original_prompt": "Ingested from linux-6.6.14/lib/test_objagg.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/random.h>\n#include <linux/objagg.h>\n\nstruct tokey {\n\tunsigned int id;\n};\n\n#define NUM_KEYS 32\n\nstatic int key_id_index(unsigned int key_id)\n{\n\tif (key_id >= NUM_KEYS) {\n\t\tWARN_ON(1);\n\t\treturn 0;\n\t}\n\treturn key_id;\n}\n\n#define BUF_LEN 128\n\nstruct world {\n\tunsigned int root_count;\n\tunsigned int delta_count;\n\tchar next_root_buf[BUF_LEN];\n\tstruct objagg_obj *objagg_objs[NUM_KEYS];\n\tunsigned int key_refs[NUM_KEYS];\n};\n\nstruct root {\n\tstruct tokey key;\n\tchar buf[BUF_LEN];\n};\n\nstruct delta {\n\tunsigned int key_id_diff;\n};\n\nstatic struct objagg_obj *world_obj_get(struct world *world,\n\t\t\t\t\tstruct objagg *objagg,\n\t\t\t\t\tunsigned int key_id)\n{\n\tstruct objagg_obj *objagg_obj;\n\tstruct tokey key;\n\tint err;\n\n\tkey.id = key_id;\n\tobjagg_obj = objagg_obj_get(objagg, &key);\n\tif (IS_ERR(objagg_obj)) {\n\t\tpr_err(\"Key %u: Failed to get object.\\n\", key_id);\n\t\treturn objagg_obj;\n\t}\n\tif (!world->key_refs[key_id_index(key_id)]) {\n\t\tworld->objagg_objs[key_id_index(key_id)] = objagg_obj;\n\t} else if (world->objagg_objs[key_id_index(key_id)] != objagg_obj) {\n\t\tpr_err(\"Key %u: God another object for the same key.\\n\",\n\t\t       key_id);\n\t\terr = -EINVAL;\n\t\tgoto err_key_id_check;\n\t}\n\tworld->key_refs[key_id_index(key_id)]++;\n\treturn objagg_obj;\n\nerr_key_id_check:\n\tobjagg_obj_put(objagg, objagg_obj);\n\treturn ERR_PTR(err);\n}\n\nstatic void world_obj_put(struct world *world, struct objagg *objagg,\n\t\t\t  unsigned int key_id)\n{\n\tstruct objagg_obj *objagg_obj;\n\n\tif (!world->key_refs[key_id_index(key_id)])\n\t\treturn;\n\tobjagg_obj = world->objagg_objs[key_id_index(key_id)];\n\tobjagg_obj_put(objagg, objagg_obj);\n\tworld->key_refs[key_id_index(key_id)]--;\n}\n\n#define MAX_KEY_ID_DIFF 5\n\nstatic bool delta_check(void *priv, const void *parent_obj, const void *obj)\n{\n\tconst struct tokey *parent_key = parent_obj;\n\tconst struct tokey *key = obj;\n\tint diff = key->id - parent_key->id;\n\n\treturn diff >= 0 && diff <= MAX_KEY_ID_DIFF;\n}\n\nstatic void *delta_create(void *priv, void *parent_obj, void *obj)\n{\n\tstruct tokey *parent_key = parent_obj;\n\tstruct world *world = priv;\n\tstruct tokey *key = obj;\n\tint diff = key->id - parent_key->id;\n\tstruct delta *delta;\n\n\tif (!delta_check(priv, parent_obj, obj))\n\t\treturn ERR_PTR(-EINVAL);\n\n\tdelta = kzalloc(sizeof(*delta), GFP_KERNEL);\n\tif (!delta)\n\t\treturn ERR_PTR(-ENOMEM);\n\tdelta->key_id_diff = diff;\n\tworld->delta_count++;\n\treturn delta;\n}\n\nstatic void delta_destroy(void *priv, void *delta_priv)\n{\n\tstruct delta *delta = delta_priv;\n\tstruct world *world = priv;\n\n\tworld->delta_count--;\n\tkfree(delta);\n}\n\nstatic void *root_create(void *priv, void *obj, unsigned int id)\n{\n\tstruct world *world = priv;\n\tstruct tokey *key = obj;\n\tstruct root *root;\n\n\troot = kzalloc(sizeof(*root), GFP_KERNEL);\n\tif (!root)\n\t\treturn ERR_PTR(-ENOMEM);\n\tmemcpy(&root->key, key, sizeof(root->key));\n\tmemcpy(root->buf, world->next_root_buf, sizeof(root->buf));\n\tworld->root_count++;\n\treturn root;\n}\n\nstatic void root_destroy(void *priv, void *root_priv)\n{\n\tstruct root *root = root_priv;\n\tstruct world *world = priv;\n\n\tworld->root_count--;\n\tkfree(root);\n}\n\nstatic int test_nodelta_obj_get(struct world *world, struct objagg *objagg,\n\t\t\t\tunsigned int key_id, bool should_create_root)\n{\n\tunsigned int orig_root_count = world->root_count;\n\tstruct objagg_obj *objagg_obj;\n\tconst struct root *root;\n\tint err;\n\n\tif (should_create_root)\n\t\tget_random_bytes(world->next_root_buf,\n\t\t\t      sizeof(world->next_root_buf));\n\n\tobjagg_obj = world_obj_get(world, objagg, key_id);\n\tif (IS_ERR(objagg_obj)) {\n\t\tpr_err(\"Key %u: Failed to get object.\\n\", key_id);\n\t\treturn PTR_ERR(objagg_obj);\n\t}\n\tif (should_create_root) {\n\t\tif (world->root_count != orig_root_count + 1) {\n\t\t\tpr_err(\"Key %u: Root was not created\\n\", key_id);\n\t\t\terr = -EINVAL;\n\t\t\tgoto err_check_root_count;\n\t\t}\n\t} else {\n\t\tif (world->root_count != orig_root_count) {\n\t\t\tpr_err(\"Key %u: Root was incorrectly created\\n\",\n\t\t\t       key_id);\n\t\t\terr = -EINVAL;\n\t\t\tgoto err_check_root_count;\n\t\t}\n\t}\n\troot = objagg_obj_root_priv(objagg_obj);\n\tif (root->key.id != key_id) {\n\t\tpr_err(\"Key %u: Root has unexpected key id\\n\", key_id);\n\t\terr = -EINVAL;\n\t\tgoto err_check_key_id;\n\t}\n\tif (should_create_root &&\n\t    memcmp(world->next_root_buf, root->buf, sizeof(root->buf))) {\n\t\tpr_err(\"Key %u: Buffer does not match the expected content\\n\",\n\t\t       key_id);\n\t\terr = -EINVAL;\n\t\tgoto err_check_buf;\n\t}\n\treturn 0;\n\nerr_check_buf:\nerr_check_key_id:\nerr_check_root_count:\n\tobjagg_obj_put(objagg, objagg_obj);\n\treturn err;\n}\n\nstatic int test_nodelta_obj_put(struct world *world, struct objagg *objagg,\n\t\t\t\tunsigned int key_id, bool should_destroy_root)\n{\n\tunsigned int orig_root_count = world->root_count;\n\n\tworld_obj_put(world, objagg, key_id);\n\n\tif (should_destroy_root) {\n\t\tif (world->root_count != orig_root_count - 1) {\n\t\t\tpr_err(\"Key %u: Root was not destroyed\\n\", key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\tif (world->root_count != orig_root_count) {\n\t\t\tpr_err(\"Key %u: Root was incorrectly destroyed\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int check_stats_zero(struct objagg *objagg)\n{\n\tconst struct objagg_stats *stats;\n\tint err = 0;\n\n\tstats = objagg_stats_get(objagg);\n\tif (IS_ERR(stats))\n\t\treturn PTR_ERR(stats);\n\n\tif (stats->stats_info_count != 0) {\n\t\tpr_err(\"Stats: Object count is not zero while it should be\\n\");\n\t\terr = -EINVAL;\n\t}\n\n\tobjagg_stats_put(stats);\n\treturn err;\n}\n\nstatic int check_stats_nodelta(struct objagg *objagg)\n{\n\tconst struct objagg_stats *stats;\n\tint i;\n\tint err;\n\n\tstats = objagg_stats_get(objagg);\n\tif (IS_ERR(stats))\n\t\treturn PTR_ERR(stats);\n\n\tif (stats->stats_info_count != NUM_KEYS) {\n\t\tpr_err(\"Stats: Unexpected object count (%u expected, %u returned)\\n\",\n\t\t       NUM_KEYS, stats->stats_info_count);\n\t\terr = -EINVAL;\n\t\tgoto stats_put;\n\t}\n\n\tfor (i = 0; i < stats->stats_info_count; i++) {\n\t\tif (stats->stats_info[i].stats.user_count != 2) {\n\t\t\tpr_err(\"Stats: incorrect user count\\n\");\n\t\t\terr = -EINVAL;\n\t\t\tgoto stats_put;\n\t\t}\n\t\tif (stats->stats_info[i].stats.delta_user_count != 2) {\n\t\t\tpr_err(\"Stats: incorrect delta user count\\n\");\n\t\t\terr = -EINVAL;\n\t\t\tgoto stats_put;\n\t\t}\n\t}\n\terr = 0;\n\nstats_put:\n\tobjagg_stats_put(stats);\n\treturn err;\n}\n\nstatic bool delta_check_dummy(void *priv, const void *parent_obj,\n\t\t\t      const void *obj)\n{\n\treturn false;\n}\n\nstatic void *delta_create_dummy(void *priv, void *parent_obj, void *obj)\n{\n\treturn ERR_PTR(-EOPNOTSUPP);\n}\n\nstatic void delta_destroy_dummy(void *priv, void *delta_priv)\n{\n}\n\nstatic const struct objagg_ops nodelta_ops = {\n\t.obj_size = sizeof(struct tokey),\n\t.delta_check = delta_check_dummy,\n\t.delta_create = delta_create_dummy,\n\t.delta_destroy = delta_destroy_dummy,\n\t.root_create = root_create,\n\t.root_destroy = root_destroy,\n};\n\nstatic int test_nodelta(void)\n{\n\tstruct world world = {};\n\tstruct objagg *objagg;\n\tint i;\n\tint err;\n\n\tobjagg = objagg_create(&nodelta_ops, NULL, &world);\n\tif (IS_ERR(objagg))\n\t\treturn PTR_ERR(objagg);\n\n\terr = check_stats_zero(objagg);\n\tif (err)\n\t\tgoto err_stats_first_zero;\n\n\t \n\tfor (i = 0; i < NUM_KEYS; i++) {\n\t\terr = test_nodelta_obj_get(&world, objagg, i, true);\n\t\tif (err)\n\t\t\tgoto err_obj_first_get;\n\t}\n\n\t \n\tfor (i = 0; i < NUM_KEYS; i++) {\n\t\terr = test_nodelta_obj_get(&world, objagg, i, false);\n\t\tif (err)\n\t\t\tgoto err_obj_second_get;\n\t}\n\n\terr = check_stats_nodelta(objagg);\n\tif (err)\n\t\tgoto err_stats_nodelta;\n\n\tfor (i = NUM_KEYS - 1; i >= 0; i--) {\n\t\terr = test_nodelta_obj_put(&world, objagg, i, false);\n\t\tif (err)\n\t\t\tgoto err_obj_first_put;\n\t}\n\tfor (i = NUM_KEYS - 1; i >= 0; i--) {\n\t\terr = test_nodelta_obj_put(&world, objagg, i, true);\n\t\tif (err)\n\t\t\tgoto err_obj_second_put;\n\t}\n\n\terr = check_stats_zero(objagg);\n\tif (err)\n\t\tgoto err_stats_second_zero;\n\n\tobjagg_destroy(objagg);\n\treturn 0;\n\nerr_stats_nodelta:\nerr_obj_first_put:\nerr_obj_second_get:\n\tfor (i--; i >= 0; i--)\n\t\tworld_obj_put(&world, objagg, i);\n\n\ti = NUM_KEYS;\nerr_obj_first_get:\nerr_obj_second_put:\n\tfor (i--; i >= 0; i--)\n\t\tworld_obj_put(&world, objagg, i);\nerr_stats_first_zero:\nerr_stats_second_zero:\n\tobjagg_destroy(objagg);\n\treturn err;\n}\n\nstatic const struct objagg_ops delta_ops = {\n\t.obj_size = sizeof(struct tokey),\n\t.delta_check = delta_check,\n\t.delta_create = delta_create,\n\t.delta_destroy = delta_destroy,\n\t.root_create = root_create,\n\t.root_destroy = root_destroy,\n};\n\nenum action {\n\tACTION_GET,\n\tACTION_PUT,\n};\n\nenum expect_delta {\n\tEXPECT_DELTA_SAME,\n\tEXPECT_DELTA_INC,\n\tEXPECT_DELTA_DEC,\n};\n\nenum expect_root {\n\tEXPECT_ROOT_SAME,\n\tEXPECT_ROOT_INC,\n\tEXPECT_ROOT_DEC,\n};\n\nstruct expect_stats_info {\n\tstruct objagg_obj_stats stats;\n\tbool is_root;\n\tunsigned int key_id;\n};\n\nstruct expect_stats {\n\tunsigned int info_count;\n\tstruct expect_stats_info info[NUM_KEYS];\n};\n\nstruct action_item {\n\tunsigned int key_id;\n\tenum action action;\n\tenum expect_delta expect_delta;\n\tenum expect_root expect_root;\n\tstruct expect_stats expect_stats;\n};\n\n#define EXPECT_STATS(count, ...)\t\t\\\n{\t\t\t\t\t\t\\\n\t.info_count = count,\t\t\t\\\n\t.info = { __VA_ARGS__ }\t\t\t\\\n}\n\n#define ROOT(key_id, user_count, delta_user_count)\t\\\n\t{{user_count, delta_user_count}, true, key_id}\n\n#define DELTA(key_id, user_count)\t\t\t\\\n\t{{user_count, user_count}, false, key_id}\n\nstatic const struct action_item action_items[] = {\n\t{\n\t\t1, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_INC,\n\t\tEXPECT_STATS(1, ROOT(1, 1, 1)),\n\t},\t \n\t{\n\t\t7, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_INC,\n\t\tEXPECT_STATS(2, ROOT(1, 1, 1), ROOT(7, 1, 1)),\n\t},\t \n\t{\n\t\t3, ACTION_GET, EXPECT_DELTA_INC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(3, ROOT(1, 1, 2), ROOT(7, 1, 1),\n\t\t\t\tDELTA(3, 1)),\n\t},\t \n\t{\n\t\t5, ACTION_GET, EXPECT_DELTA_INC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(4, ROOT(1, 1, 3), ROOT(7, 1, 1),\n\t\t\t\tDELTA(3, 1), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t3, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(4, ROOT(1, 1, 4), ROOT(7, 1, 1),\n\t\t\t\tDELTA(3, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t1, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(4, ROOT(1, 2, 5), ROOT(7, 1, 1),\n\t\t\t\tDELTA(3, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t30, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_INC,\n\t\tEXPECT_STATS(5, ROOT(1, 2, 5), ROOT(7, 1, 1), ROOT(30, 1, 1),\n\t\t\t\tDELTA(3, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_GET, EXPECT_DELTA_INC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(6, ROOT(1, 2, 5), ROOT(7, 1, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(3, 2), DELTA(5, 1), DELTA(8, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(6, ROOT(1, 2, 5), ROOT(7, 1, 3), ROOT(30, 1, 1),\n\t\t\t\tDELTA(3, 2), DELTA(8, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t3, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(6, ROOT(1, 2, 4), ROOT(7, 1, 3), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 2), DELTA(3, 1), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t3, ACTION_PUT, EXPECT_DELTA_DEC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(1, 2, 3), ROOT(7, 1, 3), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t1, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(7, 1, 3), ROOT(1, 1, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t1, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(7, 1, 3), ROOT(30, 1, 1), ROOT(1, 0, 1),\n\t\t\t\tDELTA(8, 2), DELTA(5, 1)),\n\t},\t \n\t{\n\t\t5, ACTION_PUT, EXPECT_DELTA_DEC, EXPECT_ROOT_DEC,\n\t\tEXPECT_STATS(3, ROOT(7, 1, 3), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 2)),\n\t},\t \n\t{\n\t\t5, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_INC,\n\t\tEXPECT_STATS(4, ROOT(7, 1, 3), ROOT(30, 1, 1), ROOT(5, 1, 1),\n\t\t\t\tDELTA(8, 2)),\n\t},\t \n\t{\n\t\t6, ACTION_GET, EXPECT_DELTA_INC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(7, 1, 3), ROOT(5, 1, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 2), DELTA(6, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_GET, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(7, 1, 4), ROOT(5, 1, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 3), DELTA(6, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(7, 1, 3), ROOT(5, 1, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 2), DELTA(6, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(7, 1, 2), ROOT(5, 1, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 1), DELTA(6, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_PUT, EXPECT_DELTA_DEC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(4, ROOT(5, 1, 2), ROOT(7, 1, 1), ROOT(30, 1, 1),\n\t\t\t\tDELTA(6, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_GET, EXPECT_DELTA_INC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(5, ROOT(5, 1, 3), ROOT(7, 1, 1), ROOT(30, 1, 1),\n\t\t\t\tDELTA(6, 1), DELTA(8, 1)),\n\t},\t \n\t{\n\t\t7, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_DEC,\n\t\tEXPECT_STATS(4, ROOT(5, 1, 3), ROOT(30, 1, 1),\n\t\t\t\tDELTA(6, 1), DELTA(8, 1)),\n\t},\t \n\t{\n\t\t30, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_DEC,\n\t\tEXPECT_STATS(3, ROOT(5, 1, 3),\n\t\t\t\tDELTA(6, 1), DELTA(8, 1)),\n\t},\t \n\t{\n\t\t5, ACTION_PUT, EXPECT_DELTA_SAME, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(3, ROOT(5, 0, 2),\n\t\t\t\tDELTA(6, 1), DELTA(8, 1)),\n\t},\t \n\t{\n\t\t6, ACTION_PUT, EXPECT_DELTA_DEC, EXPECT_ROOT_SAME,\n\t\tEXPECT_STATS(2, ROOT(5, 0, 1),\n\t\t\t\tDELTA(8, 1)),\n\t},\t \n\t{\n\t\t8, ACTION_PUT, EXPECT_DELTA_DEC, EXPECT_ROOT_DEC,\n\t\tEXPECT_STATS(0, ),\n\t},\t \n};\n\nstatic int check_expect(struct world *world,\n\t\t\tconst struct action_item *action_item,\n\t\t\tunsigned int orig_delta_count,\n\t\t\tunsigned int orig_root_count)\n{\n\tunsigned int key_id = action_item->key_id;\n\n\tswitch (action_item->expect_delta) {\n\tcase EXPECT_DELTA_SAME:\n\t\tif (orig_delta_count != world->delta_count) {\n\t\t\tpr_err(\"Key %u: Delta count changed while expected to remain the same.\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase EXPECT_DELTA_INC:\n\t\tif (WARN_ON(action_item->action == ACTION_PUT))\n\t\t\treturn -EINVAL;\n\t\tif (orig_delta_count + 1 != world->delta_count) {\n\t\t\tpr_err(\"Key %u: Delta count was not incremented.\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase EXPECT_DELTA_DEC:\n\t\tif (WARN_ON(action_item->action == ACTION_GET))\n\t\t\treturn -EINVAL;\n\t\tif (orig_delta_count - 1 != world->delta_count) {\n\t\t\tpr_err(\"Key %u: Delta count was not decremented.\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\t}\n\n\tswitch (action_item->expect_root) {\n\tcase EXPECT_ROOT_SAME:\n\t\tif (orig_root_count != world->root_count) {\n\t\t\tpr_err(\"Key %u: Root count changed while expected to remain the same.\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase EXPECT_ROOT_INC:\n\t\tif (WARN_ON(action_item->action == ACTION_PUT))\n\t\t\treturn -EINVAL;\n\t\tif (orig_root_count + 1 != world->root_count) {\n\t\t\tpr_err(\"Key %u: Root count was not incremented.\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase EXPECT_ROOT_DEC:\n\t\tif (WARN_ON(action_item->action == ACTION_GET))\n\t\t\treturn -EINVAL;\n\t\tif (orig_root_count - 1 != world->root_count) {\n\t\t\tpr_err(\"Key %u: Root count was not decremented.\\n\",\n\t\t\t       key_id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic unsigned int obj_to_key_id(struct objagg_obj *objagg_obj)\n{\n\tconst struct tokey *root_key;\n\tconst struct delta *delta;\n\tunsigned int key_id;\n\n\troot_key = objagg_obj_root_priv(objagg_obj);\n\tkey_id = root_key->id;\n\tdelta = objagg_obj_delta_priv(objagg_obj);\n\tif (delta)\n\t\tkey_id += delta->key_id_diff;\n\treturn key_id;\n}\n\nstatic int\ncheck_expect_stats_nums(const struct objagg_obj_stats_info *stats_info,\n\t\t\tconst struct expect_stats_info *expect_stats_info,\n\t\t\tconst char **errmsg)\n{\n\tif (stats_info->is_root != expect_stats_info->is_root) {\n\t\tif (errmsg)\n\t\t\t*errmsg = \"Incorrect root/delta indication\";\n\t\treturn -EINVAL;\n\t}\n\tif (stats_info->stats.user_count !=\n\t    expect_stats_info->stats.user_count) {\n\t\tif (errmsg)\n\t\t\t*errmsg = \"Incorrect user count\";\n\t\treturn -EINVAL;\n\t}\n\tif (stats_info->stats.delta_user_count !=\n\t    expect_stats_info->stats.delta_user_count) {\n\t\tif (errmsg)\n\t\t\t*errmsg = \"Incorrect delta user count\";\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int\ncheck_expect_stats_key_id(const struct objagg_obj_stats_info *stats_info,\n\t\t\t  const struct expect_stats_info *expect_stats_info,\n\t\t\t  const char **errmsg)\n{\n\tif (obj_to_key_id(stats_info->objagg_obj) !=\n\t    expect_stats_info->key_id) {\n\t\tif (errmsg)\n\t\t\t*errmsg = \"incorrect key id\";\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int check_expect_stats_neigh(const struct objagg_stats *stats,\n\t\t\t\t    const struct expect_stats *expect_stats,\n\t\t\t\t    int pos)\n{\n\tint i;\n\tint err;\n\n\tfor (i = pos - 1; i >= 0; i--) {\n\t\terr = check_expect_stats_nums(&stats->stats_info[i],\n\t\t\t\t\t      &expect_stats->info[pos], NULL);\n\t\tif (err)\n\t\t\tbreak;\n\t\terr = check_expect_stats_key_id(&stats->stats_info[i],\n\t\t\t\t\t\t&expect_stats->info[pos], NULL);\n\t\tif (!err)\n\t\t\treturn 0;\n\t}\n\tfor (i = pos + 1; i < stats->stats_info_count; i++) {\n\t\terr = check_expect_stats_nums(&stats->stats_info[i],\n\t\t\t\t\t      &expect_stats->info[pos], NULL);\n\t\tif (err)\n\t\t\tbreak;\n\t\terr = check_expect_stats_key_id(&stats->stats_info[i],\n\t\t\t\t\t\t&expect_stats->info[pos], NULL);\n\t\tif (!err)\n\t\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstatic int __check_expect_stats(const struct objagg_stats *stats,\n\t\t\t\tconst struct expect_stats *expect_stats,\n\t\t\t\tconst char **errmsg)\n{\n\tint i;\n\tint err;\n\n\tif (stats->stats_info_count != expect_stats->info_count) {\n\t\t*errmsg = \"Unexpected object count\";\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < stats->stats_info_count; i++) {\n\t\terr = check_expect_stats_nums(&stats->stats_info[i],\n\t\t\t\t\t      &expect_stats->info[i], errmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = check_expect_stats_key_id(&stats->stats_info[i],\n\t\t\t\t\t\t&expect_stats->info[i], errmsg);\n\t\tif (err) {\n\t\t\t \n\t\t\terr = check_expect_stats_neigh(stats, expect_stats, i);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int check_expect_stats(struct objagg *objagg,\n\t\t\t      const struct expect_stats *expect_stats,\n\t\t\t      const char **errmsg)\n{\n\tconst struct objagg_stats *stats;\n\tint err;\n\n\tstats = objagg_stats_get(objagg);\n\tif (IS_ERR(stats)) {\n\t\t*errmsg = \"objagg_stats_get() failed.\";\n\t\treturn PTR_ERR(stats);\n\t}\n\terr = __check_expect_stats(stats, expect_stats, errmsg);\n\tobjagg_stats_put(stats);\n\treturn err;\n}\n\nstatic int test_delta_action_item(struct world *world,\n\t\t\t\t  struct objagg *objagg,\n\t\t\t\t  const struct action_item *action_item,\n\t\t\t\t  bool inverse)\n{\n\tunsigned int orig_delta_count = world->delta_count;\n\tunsigned int orig_root_count = world->root_count;\n\tunsigned int key_id = action_item->key_id;\n\tenum action action = action_item->action;\n\tstruct objagg_obj *objagg_obj;\n\tconst char *errmsg;\n\tint err;\n\n\tif (inverse)\n\t\taction = action == ACTION_GET ? ACTION_PUT : ACTION_GET;\n\n\tswitch (action) {\n\tcase ACTION_GET:\n\t\tobjagg_obj = world_obj_get(world, objagg, key_id);\n\t\tif (IS_ERR(objagg_obj))\n\t\t\treturn PTR_ERR(objagg_obj);\n\t\tbreak;\n\tcase ACTION_PUT:\n\t\tworld_obj_put(world, objagg, key_id);\n\t\tbreak;\n\t}\n\n\tif (inverse)\n\t\treturn 0;\n\terr = check_expect(world, action_item,\n\t\t\t   orig_delta_count, orig_root_count);\n\tif (err)\n\t\tgoto errout;\n\n\terr = check_expect_stats(objagg, &action_item->expect_stats, &errmsg);\n\tif (err) {\n\t\tpr_err(\"Key %u: Stats: %s\\n\", action_item->key_id, errmsg);\n\t\tgoto errout;\n\t}\n\n\treturn 0;\n\nerrout:\n\t \n\ttest_delta_action_item(world, objagg, action_item, true);\n\treturn err;\n}\n\nstatic int test_delta(void)\n{\n\tstruct world world = {};\n\tstruct objagg *objagg;\n\tint i;\n\tint err;\n\n\tobjagg = objagg_create(&delta_ops, NULL, &world);\n\tif (IS_ERR(objagg))\n\t\treturn PTR_ERR(objagg);\n\n\tfor (i = 0; i < ARRAY_SIZE(action_items); i++) {\n\t\terr = test_delta_action_item(&world, objagg,\n\t\t\t\t\t     &action_items[i], false);\n\t\tif (err)\n\t\t\tgoto err_do_action_item;\n\t}\n\n\tobjagg_destroy(objagg);\n\treturn 0;\n\nerr_do_action_item:\n\tfor (i--; i >= 0; i--)\n\t\ttest_delta_action_item(&world, objagg, &action_items[i], true);\n\n\tobjagg_destroy(objagg);\n\treturn err;\n}\n\nstruct hints_case {\n\tconst unsigned int *key_ids;\n\tsize_t key_ids_count;\n\tstruct expect_stats expect_stats;\n\tstruct expect_stats expect_stats_hints;\n};\n\nstatic const unsigned int hints_case_key_ids[] = {\n\t1, 7, 3, 5, 3, 1, 30, 8, 8, 5, 6, 8,\n};\n\nstatic const struct hints_case hints_case = {\n\t.key_ids = hints_case_key_ids,\n\t.key_ids_count = ARRAY_SIZE(hints_case_key_ids),\n\t.expect_stats =\n\t\tEXPECT_STATS(7, ROOT(1, 2, 7), ROOT(7, 1, 4), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 3), DELTA(3, 2),\n\t\t\t\tDELTA(5, 2), DELTA(6, 1)),\n\t.expect_stats_hints =\n\t\tEXPECT_STATS(7, ROOT(3, 2, 9), ROOT(1, 2, 2), ROOT(30, 1, 1),\n\t\t\t\tDELTA(8, 3), DELTA(5, 2),\n\t\t\t\tDELTA(6, 1), DELTA(7, 1)),\n};\n\nstatic void __pr_debug_stats(const struct objagg_stats *stats)\n{\n\tint i;\n\n\tfor (i = 0; i < stats->stats_info_count; i++)\n\t\tpr_debug(\"Stat index %d key %u: u %d, d %d, %s\\n\", i,\n\t\t\t obj_to_key_id(stats->stats_info[i].objagg_obj),\n\t\t\t stats->stats_info[i].stats.user_count,\n\t\t\t stats->stats_info[i].stats.delta_user_count,\n\t\t\t stats->stats_info[i].is_root ? \"root\" : \"noroot\");\n}\n\nstatic void pr_debug_stats(struct objagg *objagg)\n{\n\tconst struct objagg_stats *stats;\n\n\tstats = objagg_stats_get(objagg);\n\tif (IS_ERR(stats))\n\t\treturn;\n\t__pr_debug_stats(stats);\n\tobjagg_stats_put(stats);\n}\n\nstatic void pr_debug_hints_stats(struct objagg_hints *objagg_hints)\n{\n\tconst struct objagg_stats *stats;\n\n\tstats = objagg_hints_stats_get(objagg_hints);\n\tif (IS_ERR(stats))\n\t\treturn;\n\t__pr_debug_stats(stats);\n\tobjagg_stats_put(stats);\n}\n\nstatic int check_expect_hints_stats(struct objagg_hints *objagg_hints,\n\t\t\t\t    const struct expect_stats *expect_stats,\n\t\t\t\t    const char **errmsg)\n{\n\tconst struct objagg_stats *stats;\n\tint err;\n\n\tstats = objagg_hints_stats_get(objagg_hints);\n\tif (IS_ERR(stats))\n\t\treturn PTR_ERR(stats);\n\terr = __check_expect_stats(stats, expect_stats, errmsg);\n\tobjagg_stats_put(stats);\n\treturn err;\n}\n\nstatic int test_hints_case(const struct hints_case *hints_case)\n{\n\tstruct objagg_obj *objagg_obj;\n\tstruct objagg_hints *hints;\n\tstruct world world2 = {};\n\tstruct world world = {};\n\tstruct objagg *objagg2;\n\tstruct objagg *objagg;\n\tconst char *errmsg;\n\tint i;\n\tint err;\n\n\tobjagg = objagg_create(&delta_ops, NULL, &world);\n\tif (IS_ERR(objagg))\n\t\treturn PTR_ERR(objagg);\n\n\tfor (i = 0; i < hints_case->key_ids_count; i++) {\n\t\tobjagg_obj = world_obj_get(&world, objagg,\n\t\t\t\t\t   hints_case->key_ids[i]);\n\t\tif (IS_ERR(objagg_obj)) {\n\t\t\terr = PTR_ERR(objagg_obj);\n\t\t\tgoto err_world_obj_get;\n\t\t}\n\t}\n\n\tpr_debug_stats(objagg);\n\terr = check_expect_stats(objagg, &hints_case->expect_stats, &errmsg);\n\tif (err) {\n\t\tpr_err(\"Stats: %s\\n\", errmsg);\n\t\tgoto err_check_expect_stats;\n\t}\n\n\thints = objagg_hints_get(objagg, OBJAGG_OPT_ALGO_SIMPLE_GREEDY);\n\tif (IS_ERR(hints)) {\n\t\terr = PTR_ERR(hints);\n\t\tgoto err_hints_get;\n\t}\n\n\tpr_debug_hints_stats(hints);\n\terr = check_expect_hints_stats(hints, &hints_case->expect_stats_hints,\n\t\t\t\t       &errmsg);\n\tif (err) {\n\t\tpr_err(\"Hints stats: %s\\n\", errmsg);\n\t\tgoto err_check_expect_hints_stats;\n\t}\n\n\tobjagg2 = objagg_create(&delta_ops, hints, &world2);\n\tif (IS_ERR(objagg2))\n\t\treturn PTR_ERR(objagg2);\n\n\tfor (i = 0; i < hints_case->key_ids_count; i++) {\n\t\tobjagg_obj = world_obj_get(&world2, objagg2,\n\t\t\t\t\t   hints_case->key_ids[i]);\n\t\tif (IS_ERR(objagg_obj)) {\n\t\t\terr = PTR_ERR(objagg_obj);\n\t\t\tgoto err_world2_obj_get;\n\t\t}\n\t}\n\n\tpr_debug_stats(objagg2);\n\terr = check_expect_stats(objagg2, &hints_case->expect_stats_hints,\n\t\t\t\t &errmsg);\n\tif (err) {\n\t\tpr_err(\"Stats2: %s\\n\", errmsg);\n\t\tgoto err_check_expect_stats2;\n\t}\n\n\terr = 0;\n\nerr_check_expect_stats2:\nerr_world2_obj_get:\n\tfor (i--; i >= 0; i--)\n\t\tworld_obj_put(&world2, objagg, hints_case->key_ids[i]);\n\ti = hints_case->key_ids_count;\n\tobjagg_destroy(objagg2);\nerr_check_expect_hints_stats:\n\tobjagg_hints_put(hints);\nerr_hints_get:\nerr_check_expect_stats:\nerr_world_obj_get:\n\tfor (i--; i >= 0; i--)\n\t\tworld_obj_put(&world, objagg, hints_case->key_ids[i]);\n\n\tobjagg_destroy(objagg);\n\treturn err;\n}\nstatic int test_hints(void)\n{\n\treturn test_hints_case(&hints_case);\n}\n\nstatic int __init test_objagg_init(void)\n{\n\tint err;\n\n\terr = test_nodelta();\n\tif (err)\n\t\treturn err;\n\terr = test_delta();\n\tif (err)\n\t\treturn err;\n\treturn test_hints();\n}\n\nstatic void __exit test_objagg_exit(void)\n{\n}\n\nmodule_init(test_objagg_init);\nmodule_exit(test_objagg_exit);\nMODULE_LICENSE(\"Dual BSD/GPL\");\nMODULE_AUTHOR(\"Jiri Pirko <jiri@mellanox.com>\");\nMODULE_DESCRIPTION(\"Test module for objagg\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}