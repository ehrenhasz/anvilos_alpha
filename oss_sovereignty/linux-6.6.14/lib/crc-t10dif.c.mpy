{
  "module_name": "crc-t10dif.c",
  "hash_id": "ffcb43df415e0cf9f0c12d72ab8d012652028e2c64695295a215e2e753bb02d0",
  "original_prompt": "Ingested from linux-6.6.14/lib/crc-t10dif.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/module.h>\n#include <linux/crc-t10dif.h>\n#include <linux/err.h>\n#include <linux/init.h>\n#include <crypto/hash.h>\n#include <crypto/algapi.h>\n#include <linux/static_key.h>\n#include <linux/notifier.h>\n\nstatic struct crypto_shash __rcu *crct10dif_tfm;\nstatic DEFINE_STATIC_KEY_TRUE(crct10dif_fallback);\nstatic DEFINE_MUTEX(crc_t10dif_mutex);\nstatic struct work_struct crct10dif_rehash_work;\n\nstatic int crc_t10dif_notify(struct notifier_block *self, unsigned long val, void *data)\n{\n\tstruct crypto_alg *alg = data;\n\n\tif (val != CRYPTO_MSG_ALG_LOADED ||\n\t    strcmp(alg->cra_name, CRC_T10DIF_STRING))\n\t\treturn NOTIFY_DONE;\n\n\tschedule_work(&crct10dif_rehash_work);\n\treturn NOTIFY_OK;\n}\n\nstatic void crc_t10dif_rehash(struct work_struct *work)\n{\n\tstruct crypto_shash *new, *old;\n\n\tmutex_lock(&crc_t10dif_mutex);\n\told = rcu_dereference_protected(crct10dif_tfm,\n\t\t\t\t\tlockdep_is_held(&crc_t10dif_mutex));\n\tnew = crypto_alloc_shash(CRC_T10DIF_STRING, 0, 0);\n\tif (IS_ERR(new)) {\n\t\tmutex_unlock(&crc_t10dif_mutex);\n\t\treturn;\n\t}\n\trcu_assign_pointer(crct10dif_tfm, new);\n\tmutex_unlock(&crc_t10dif_mutex);\n\n\tif (old) {\n\t\tsynchronize_rcu();\n\t\tcrypto_free_shash(old);\n\t} else {\n\t\tstatic_branch_disable(&crct10dif_fallback);\n\t}\n}\n\nstatic struct notifier_block crc_t10dif_nb = {\n\t.notifier_call = crc_t10dif_notify,\n};\n\n__u16 crc_t10dif_update(__u16 crc, const unsigned char *buffer, size_t len)\n{\n\tstruct {\n\t\tstruct shash_desc shash;\n\t\t__u16 crc;\n\t} desc;\n\tint err;\n\n\tif (static_branch_unlikely(&crct10dif_fallback))\n\t\treturn crc_t10dif_generic(crc, buffer, len);\n\n\trcu_read_lock();\n\tdesc.shash.tfm = rcu_dereference(crct10dif_tfm);\n\tdesc.crc = crc;\n\terr = crypto_shash_update(&desc.shash, buffer, len);\n\trcu_read_unlock();\n\n\tBUG_ON(err);\n\n\treturn desc.crc;\n}\nEXPORT_SYMBOL(crc_t10dif_update);\n\n__u16 crc_t10dif(const unsigned char *buffer, size_t len)\n{\n\treturn crc_t10dif_update(0, buffer, len);\n}\nEXPORT_SYMBOL(crc_t10dif);\n\nstatic int __init crc_t10dif_mod_init(void)\n{\n\tINIT_WORK(&crct10dif_rehash_work, crc_t10dif_rehash);\n\tcrypto_register_notifier(&crc_t10dif_nb);\n\tcrc_t10dif_rehash(&crct10dif_rehash_work);\n\treturn 0;\n}\n\nstatic void __exit crc_t10dif_mod_fini(void)\n{\n\tcrypto_unregister_notifier(&crc_t10dif_nb);\n\tcancel_work_sync(&crct10dif_rehash_work);\n\tcrypto_free_shash(rcu_dereference_protected(crct10dif_tfm, 1));\n}\n\nmodule_init(crc_t10dif_mod_init);\nmodule_exit(crc_t10dif_mod_fini);\n\nstatic int crc_t10dif_transform_show(char *buffer, const struct kernel_param *kp)\n{\n\tstruct crypto_shash *tfm;\n\tint len;\n\n\tif (static_branch_unlikely(&crct10dif_fallback))\n\t\treturn sprintf(buffer, \"fallback\\n\");\n\n\trcu_read_lock();\n\ttfm = rcu_dereference(crct10dif_tfm);\n\tlen = snprintf(buffer, PAGE_SIZE, \"%s\\n\",\n\t\t       crypto_shash_driver_name(tfm));\n\trcu_read_unlock();\n\n\treturn len;\n}\n\nmodule_param_call(transform, NULL, crc_t10dif_transform_show, NULL, 0444);\n\nMODULE_DESCRIPTION(\"T10 DIF CRC calculation (library API)\");\nMODULE_LICENSE(\"GPL\");\nMODULE_SOFTDEP(\"pre: crct10dif\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}