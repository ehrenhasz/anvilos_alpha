{
  "module_name": "assert.c",
  "hash_id": "29ce3d4be36c752f545eb746dfae53e05e7bd3591bd136c94cf09228f69c0b61",
  "original_prompt": "Ingested from linux-6.6.14/lib/kunit/assert.c",
  "human_readable_source": "\n \n#include <kunit/assert.h>\n#include <kunit/test.h>\n\n#include \"string-stream.h\"\n\nvoid kunit_assert_prologue(const struct kunit_loc *loc,\n\t\t\t   enum kunit_assert_type type,\n\t\t\t      struct string_stream *stream)\n{\n\tconst char *expect_or_assert = NULL;\n\n\tswitch (type) {\n\tcase KUNIT_EXPECTATION:\n\t\texpect_or_assert = \"EXPECTATION\";\n\t\tbreak;\n\tcase KUNIT_ASSERTION:\n\t\texpect_or_assert = \"ASSERTION\";\n\t\tbreak;\n\t}\n\n\tstring_stream_add(stream, \"%s FAILED at %s:%d\\n\",\n\t\t\t  expect_or_assert, loc->file, loc->line);\n}\nEXPORT_SYMBOL_GPL(kunit_assert_prologue);\n\nstatic void kunit_assert_print_msg(const struct va_format *message,\n\t\t\t\t   struct string_stream *stream)\n{\n\tif (message->fmt)\n\t\tstring_stream_add(stream, \"\\n%pV\", message);\n}\n\nvoid kunit_fail_assert_format(const struct kunit_assert *assert,\n\t\t\t      const struct va_format *message,\n\t\t\t      struct string_stream *stream)\n{\n\tstring_stream_add(stream, \"%pV\", message);\n}\nEXPORT_SYMBOL_GPL(kunit_fail_assert_format);\n\nvoid kunit_unary_assert_format(const struct kunit_assert *assert,\n\t\t\t       const struct va_format *message,\n\t\t\t       struct string_stream *stream)\n{\n\tstruct kunit_unary_assert *unary_assert;\n\n\tunary_assert = container_of(assert, struct kunit_unary_assert, assert);\n\n\tif (unary_assert->expected_true)\n\t\tstring_stream_add(stream,\n\t\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s to be true, but is false\\n\",\n\t\t\t\t  unary_assert->condition);\n\telse\n\t\tstring_stream_add(stream,\n\t\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s to be false, but is true\\n\",\n\t\t\t\t  unary_assert->condition);\n\tkunit_assert_print_msg(message, stream);\n}\nEXPORT_SYMBOL_GPL(kunit_unary_assert_format);\n\nvoid kunit_ptr_not_err_assert_format(const struct kunit_assert *assert,\n\t\t\t\t     const struct va_format *message,\n\t\t\t\t     struct string_stream *stream)\n{\n\tstruct kunit_ptr_not_err_assert *ptr_assert;\n\n\tptr_assert = container_of(assert, struct kunit_ptr_not_err_assert,\n\t\t\t\t  assert);\n\n\tif (!ptr_assert->value) {\n\t\tstring_stream_add(stream,\n\t\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s is not null, but is\\n\",\n\t\t\t\t  ptr_assert->text);\n\t} else if (IS_ERR(ptr_assert->value)) {\n\t\tstring_stream_add(stream,\n\t\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s is not error, but is: %ld\\n\",\n\t\t\t\t  ptr_assert->text,\n\t\t\t\t  PTR_ERR(ptr_assert->value));\n\t}\n\tkunit_assert_print_msg(message, stream);\n}\nEXPORT_SYMBOL_GPL(kunit_ptr_not_err_assert_format);\n\n \nstatic bool is_literal(struct kunit *test, const char *text, long long value,\n\t\t       gfp_t gfp)\n{\n\tchar *buffer;\n\tint len;\n\tbool ret;\n\n\tlen = snprintf(NULL, 0, \"%lld\", value);\n\tif (strlen(text) != len)\n\t\treturn false;\n\n\tbuffer = kunit_kmalloc(test, len+1, gfp);\n\tif (!buffer)\n\t\treturn false;\n\n\tsnprintf(buffer, len+1, \"%lld\", value);\n\tret = strncmp(buffer, text, len) == 0;\n\n\tkunit_kfree(test, buffer);\n\treturn ret;\n}\n\nvoid kunit_binary_assert_format(const struct kunit_assert *assert,\n\t\t\t\tconst struct va_format *message,\n\t\t\t\tstruct string_stream *stream)\n{\n\tstruct kunit_binary_assert *binary_assert;\n\n\tbinary_assert = container_of(assert, struct kunit_binary_assert,\n\t\t\t\t     assert);\n\n\tstring_stream_add(stream,\n\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s %s %s, but\\n\",\n\t\t\t  binary_assert->text->left_text,\n\t\t\t  binary_assert->text->operation,\n\t\t\t  binary_assert->text->right_text);\n\tif (!is_literal(stream->test, binary_assert->text->left_text,\n\t\t\tbinary_assert->left_value, stream->gfp))\n\t\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s == %lld (0x%llx)\\n\",\n\t\t\t\t  binary_assert->text->left_text,\n\t\t\t\t  binary_assert->left_value,\n\t\t\t\t  binary_assert->left_value);\n\tif (!is_literal(stream->test, binary_assert->text->right_text,\n\t\t\tbinary_assert->right_value, stream->gfp))\n\t\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s == %lld (0x%llx)\",\n\t\t\t\t  binary_assert->text->right_text,\n\t\t\t\t  binary_assert->right_value,\n\t\t\t\t  binary_assert->right_value);\n\tkunit_assert_print_msg(message, stream);\n}\nEXPORT_SYMBOL_GPL(kunit_binary_assert_format);\n\nvoid kunit_binary_ptr_assert_format(const struct kunit_assert *assert,\n\t\t\t\t    const struct va_format *message,\n\t\t\t\t    struct string_stream *stream)\n{\n\tstruct kunit_binary_ptr_assert *binary_assert;\n\n\tbinary_assert = container_of(assert, struct kunit_binary_ptr_assert,\n\t\t\t\t     assert);\n\n\tstring_stream_add(stream,\n\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s %s %s, but\\n\",\n\t\t\t  binary_assert->text->left_text,\n\t\t\t  binary_assert->text->operation,\n\t\t\t  binary_assert->text->right_text);\n\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s == %px\\n\",\n\t\t\t  binary_assert->text->left_text,\n\t\t\t  binary_assert->left_value);\n\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s == %px\",\n\t\t\t  binary_assert->text->right_text,\n\t\t\t  binary_assert->right_value);\n\tkunit_assert_print_msg(message, stream);\n}\nEXPORT_SYMBOL_GPL(kunit_binary_ptr_assert_format);\n\n \nstatic bool is_str_literal(const char *text, const char *value)\n{\n\tint len;\n\n\tlen = strlen(text);\n\tif (len < 2)\n\t\treturn false;\n\tif (text[0] != '\\\"' || text[len - 1] != '\\\"')\n\t\treturn false;\n\n\treturn strncmp(text + 1, value, len - 2) == 0;\n}\n\nvoid kunit_binary_str_assert_format(const struct kunit_assert *assert,\n\t\t\t\t    const struct va_format *message,\n\t\t\t\t    struct string_stream *stream)\n{\n\tstruct kunit_binary_str_assert *binary_assert;\n\n\tbinary_assert = container_of(assert, struct kunit_binary_str_assert,\n\t\t\t\t     assert);\n\n\tstring_stream_add(stream,\n\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s %s %s, but\\n\",\n\t\t\t  binary_assert->text->left_text,\n\t\t\t  binary_assert->text->operation,\n\t\t\t  binary_assert->text->right_text);\n\tif (!is_str_literal(binary_assert->text->left_text, binary_assert->left_value))\n\t\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s == \\\"%s\\\"\\n\",\n\t\t\t\t  binary_assert->text->left_text,\n\t\t\t\t  binary_assert->left_value);\n\tif (!is_str_literal(binary_assert->text->right_text, binary_assert->right_value))\n\t\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s == \\\"%s\\\"\",\n\t\t\t\t  binary_assert->text->right_text,\n\t\t\t\t  binary_assert->right_value);\n\tkunit_assert_print_msg(message, stream);\n}\nEXPORT_SYMBOL_GPL(kunit_binary_str_assert_format);\n\n \nstatic void kunit_assert_hexdump(struct string_stream *stream,\n\t\t\t\t const void *buf,\n\t\t\t\t const void *compared_buf,\n\t\t\t\t const size_t len)\n{\n\tsize_t i;\n\tconst u8 *buf1 = buf;\n\tconst u8 *buf2 = compared_buf;\n\n\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT);\n\n\tfor (i = 0; i < len; ++i) {\n\t\tif (!(i % 16) && i)\n\t\t\tstring_stream_add(stream, \"\\n\" KUNIT_SUBSUBTEST_INDENT);\n\n\t\tif (buf1[i] != buf2[i])\n\t\t\tstring_stream_add(stream, \"<%02x>\", buf1[i]);\n\t\telse\n\t\t\tstring_stream_add(stream, \" %02x \", buf1[i]);\n\t}\n}\n\nvoid kunit_mem_assert_format(const struct kunit_assert *assert,\n\t\t\t     const struct va_format *message,\n\t\t\t     struct string_stream *stream)\n{\n\tstruct kunit_mem_assert *mem_assert;\n\n\tmem_assert = container_of(assert, struct kunit_mem_assert,\n\t\t\t\t  assert);\n\n\tif (!mem_assert->left_value) {\n\t\tstring_stream_add(stream,\n\t\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s is not null, but is\\n\",\n\t\t\t\t  mem_assert->text->left_text);\n\t} else if (!mem_assert->right_value) {\n\t\tstring_stream_add(stream,\n\t\t\t\t  KUNIT_SUBTEST_INDENT \"Expected %s is not null, but is\\n\",\n\t\t\t\t  mem_assert->text->right_text);\n\t} else {\n\t\tstring_stream_add(stream,\n\t\t\t\tKUNIT_SUBTEST_INDENT \"Expected %s %s %s, but\\n\",\n\t\t\t\tmem_assert->text->left_text,\n\t\t\t\tmem_assert->text->operation,\n\t\t\t\tmem_assert->text->right_text);\n\n\t\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s ==\\n\",\n\t\t\t\tmem_assert->text->left_text);\n\t\tkunit_assert_hexdump(stream, mem_assert->left_value,\n\t\t\t\t\tmem_assert->right_value, mem_assert->size);\n\n\t\tstring_stream_add(stream, \"\\n\");\n\n\t\tstring_stream_add(stream, KUNIT_SUBSUBTEST_INDENT \"%s ==\\n\",\n\t\t\t\tmem_assert->text->right_text);\n\t\tkunit_assert_hexdump(stream, mem_assert->right_value,\n\t\t\t\t\tmem_assert->left_value, mem_assert->size);\n\n\t\tkunit_assert_print_msg(message, stream);\n\t}\n}\nEXPORT_SYMBOL_GPL(kunit_mem_assert_format);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}