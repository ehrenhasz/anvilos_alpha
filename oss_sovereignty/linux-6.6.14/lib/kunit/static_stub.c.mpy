{
  "module_name": "static_stub.c",
  "hash_id": "0de23d1a00b82bbef0b39b1cd922ce127a13f96b8a8429a361e0ed467af18262",
  "original_prompt": "Ingested from linux-6.6.14/lib/kunit/static_stub.c",
  "human_readable_source": "\n \n\n#include <kunit/test.h>\n#include <kunit/static_stub.h>\n#include \"hooks-impl.h\"\n\n\n \nstruct kunit_static_stub_ctx {\n\tvoid *real_fn_addr;\n\tvoid *replacement_addr;\n};\n\nstatic void __kunit_static_stub_resource_free(struct kunit_resource *res)\n{\n\tkfree(res->data);\n}\n\n \nstatic bool __kunit_static_stub_resource_match(struct kunit *test,\n\t\t\t\t\t\tstruct kunit_resource *res,\n\t\t\t\t\t\tvoid *match_real_fn_addr)\n{\n\t \n\tstruct kunit_static_stub_ctx *ctx = res->data;\n\n\t \n\tif (res->free != &__kunit_static_stub_resource_free)\n\t\treturn false;\n\n\treturn ctx->real_fn_addr == match_real_fn_addr;\n}\n\n \nvoid *__kunit_get_static_stub_address_impl(struct kunit *test, void *real_fn_addr)\n{\n\tstruct kunit_resource *res;\n\tstruct kunit_static_stub_ctx *ctx;\n\tvoid *replacement_addr;\n\n\tres = kunit_find_resource(test,\n\t\t\t\t  __kunit_static_stub_resource_match,\n\t\t\t\t  real_fn_addr);\n\n\tif (!res)\n\t\treturn NULL;\n\n\tctx = res->data;\n\treplacement_addr = ctx->replacement_addr;\n\tkunit_put_resource(res);\n\treturn replacement_addr;\n}\n\nvoid kunit_deactivate_static_stub(struct kunit *test, void *real_fn_addr)\n{\n\tstruct kunit_resource *res;\n\n\tKUNIT_ASSERT_PTR_NE_MSG(test, real_fn_addr, NULL,\n\t\t\t\t\"Tried to deactivate a NULL stub.\");\n\n\t \n\tres = kunit_find_resource(test,\n\t\t\t\t  __kunit_static_stub_resource_match,\n\t\t\t\t  real_fn_addr);\n\n\t \n\tKUNIT_ASSERT_PTR_NE_MSG(test, res, NULL,\n\t\t\t\t\"Tried to deactivate a nonexistent stub.\");\n\n\t \n\tkunit_remove_resource(test, res);\n\tkunit_put_resource(res);\n}\nEXPORT_SYMBOL_GPL(kunit_deactivate_static_stub);\n\n \nvoid __kunit_activate_static_stub(struct kunit *test,\n\t\t\t\t  void *real_fn_addr,\n\t\t\t\t  void *replacement_addr)\n{\n\tstruct kunit_static_stub_ctx *ctx;\n\tstruct kunit_resource *res;\n\n\tKUNIT_ASSERT_PTR_NE_MSG(test, real_fn_addr, NULL,\n\t\t\t\t\"Tried to activate a stub for function NULL\");\n\n\t \n\tif (!replacement_addr) {\n\t\tkunit_deactivate_static_stub(test, replacement_addr);\n\t\treturn;\n\t}\n\n\t \n\tres = kunit_find_resource(test,\n\t\t\t\t  __kunit_static_stub_resource_match,\n\t\t\t\t  real_fn_addr);\n\tif (res) {\n\t\tctx = res->data;\n\t\tctx->replacement_addr = replacement_addr;\n\n\t\t \n\t\tkunit_put_resource(res);\n\t} else {\n\t\tctx = kmalloc(sizeof(*ctx), GFP_KERNEL);\n\t\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ctx);\n\t\tctx->real_fn_addr = real_fn_addr;\n\t\tctx->replacement_addr = replacement_addr;\n\t\tres = kunit_alloc_resource(test, NULL,\n\t\t\t\t     &__kunit_static_stub_resource_free,\n\t\t\t\t     GFP_KERNEL, ctx);\n\t}\n}\nEXPORT_SYMBOL_GPL(__kunit_activate_static_stub);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}