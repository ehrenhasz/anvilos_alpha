{
  "module_name": "debugfs.c",
  "hash_id": "16f929b9b24a805efb6e0e3a6561012585179113b1ef3aaa6e5d7b8d7b3aef8b",
  "original_prompt": "Ingested from linux-6.6.14/lib/kunit/debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/module.h>\n\n#include <kunit/test.h>\n\n#include \"string-stream.h\"\n#include \"debugfs.h\"\n\n#define KUNIT_DEBUGFS_ROOT             \"kunit\"\n#define KUNIT_DEBUGFS_RESULTS          \"results\"\n\n \n\nstatic struct dentry *debugfs_rootdir;\n\nvoid kunit_debugfs_cleanup(void)\n{\n\tdebugfs_remove_recursive(debugfs_rootdir);\n}\n\nvoid kunit_debugfs_init(void)\n{\n\tif (!debugfs_rootdir)\n\t\tdebugfs_rootdir = debugfs_create_dir(KUNIT_DEBUGFS_ROOT, NULL);\n}\n\nstatic void debugfs_print_result(struct seq_file *seq,\n\t\t\t\t struct kunit_suite *suite,\n\t\t\t\t struct kunit_case *test_case)\n{\n\tif (!test_case || !test_case->log)\n\t\treturn;\n\n\tseq_printf(seq, \"%s\", test_case->log);\n}\n\n \nstatic int debugfs_print_results(struct seq_file *seq, void *v)\n{\n\tstruct kunit_suite *suite = (struct kunit_suite *)seq->private;\n\tenum kunit_status success;\n\tstruct kunit_case *test_case;\n\n\tif (!suite)\n\t\treturn 0;\n\n\tsuccess = kunit_suite_has_succeeded(suite);\n\n\t \n\tseq_puts(seq, \"KTAP version 1\\n\");\n\tseq_puts(seq, \"1..1\\n\");\n\n\t \n\tseq_puts(seq, KUNIT_SUBTEST_INDENT \"KTAP version 1\\n\");\n\tseq_printf(seq, KUNIT_SUBTEST_INDENT \"# Subtest: %s\\n\", suite->name);\n\tseq_printf(seq, KUNIT_SUBTEST_INDENT \"1..%zd\\n\", kunit_suite_num_test_cases(suite));\n\n\tkunit_suite_for_each_test_case(suite, test_case)\n\t\tdebugfs_print_result(seq, suite, test_case);\n\n\tif (suite->log)\n\t\tseq_printf(seq, \"%s\", suite->log);\n\n\tseq_printf(seq, \"%s %d %s\\n\",\n\t\t   kunit_status_to_ok_not_ok(success), 1, suite->name);\n\treturn 0;\n}\n\nstatic int debugfs_release(struct inode *inode, struct file *file)\n{\n\treturn single_release(inode, file);\n}\n\nstatic int debugfs_results_open(struct inode *inode, struct file *file)\n{\n\tstruct kunit_suite *suite;\n\n\tsuite = (struct kunit_suite *)inode->i_private;\n\n\treturn single_open(file, debugfs_print_results, suite);\n}\n\nstatic const struct file_operations debugfs_results_fops = {\n\t.open = debugfs_results_open,\n\t.read = seq_read,\n\t.llseek = seq_lseek,\n\t.release = debugfs_release,\n};\n\nvoid kunit_debugfs_create_suite(struct kunit_suite *suite)\n{\n\tstruct kunit_case *test_case;\n\n\t \n\tsuite->log = kzalloc(KUNIT_LOG_SIZE, GFP_KERNEL);\n\tkunit_suite_for_each_test_case(suite, test_case)\n\t\ttest_case->log = kzalloc(KUNIT_LOG_SIZE, GFP_KERNEL);\n\n\tsuite->debugfs = debugfs_create_dir(suite->name, debugfs_rootdir);\n\n\tdebugfs_create_file(KUNIT_DEBUGFS_RESULTS, S_IFREG | 0444,\n\t\t\t    suite->debugfs,\n\t\t\t    suite, &debugfs_results_fops);\n}\n\nvoid kunit_debugfs_destroy_suite(struct kunit_suite *suite)\n{\n\tstruct kunit_case *test_case;\n\n\tdebugfs_remove_recursive(suite->debugfs);\n\tkfree(suite->log);\n\tkunit_suite_for_each_test_case(suite, test_case)\n\t\tkfree(test_case->log);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}