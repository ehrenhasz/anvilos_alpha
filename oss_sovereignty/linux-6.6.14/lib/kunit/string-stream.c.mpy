{
  "module_name": "string-stream.c",
  "hash_id": "fc689b92daf1f37694ea30021d8443b9cbe474e8f4175f140946cf84644d827a",
  "original_prompt": "Ingested from linux-6.6.14/lib/kunit/string-stream.c",
  "human_readable_source": "\n \n\n#include <kunit/test.h>\n#include <linux/list.h>\n#include <linux/slab.h>\n\n#include \"string-stream.h\"\n\n\nstatic struct string_stream_fragment *alloc_string_stream_fragment(\n\t\tstruct kunit *test, int len, gfp_t gfp)\n{\n\tstruct string_stream_fragment *frag;\n\n\tfrag = kunit_kzalloc(test, sizeof(*frag), gfp);\n\tif (!frag)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tfrag->fragment = kunit_kmalloc(test, len, gfp);\n\tif (!frag->fragment) {\n\t\tkunit_kfree(test, frag);\n\t\treturn ERR_PTR(-ENOMEM);\n\t}\n\n\treturn frag;\n}\n\nstatic void string_stream_fragment_destroy(struct kunit *test,\n\t\t\t\t\t   struct string_stream_fragment *frag)\n{\n\tlist_del(&frag->node);\n\tkunit_kfree(test, frag->fragment);\n\tkunit_kfree(test, frag);\n}\n\nint string_stream_vadd(struct string_stream *stream,\n\t\t       const char *fmt,\n\t\t       va_list args)\n{\n\tstruct string_stream_fragment *frag_container;\n\tint len;\n\tva_list args_for_counting;\n\n\t \n\tva_copy(args_for_counting, args);\n\n\t \n\tlen = vsnprintf(NULL, 0, fmt, args_for_counting) + 1;\n\n\tva_end(args_for_counting);\n\n\tfrag_container = alloc_string_stream_fragment(stream->test,\n\t\t\t\t\t\t      len,\n\t\t\t\t\t\t      stream->gfp);\n\tif (IS_ERR(frag_container))\n\t\treturn PTR_ERR(frag_container);\n\n\tlen = vsnprintf(frag_container->fragment, len, fmt, args);\n\tspin_lock(&stream->lock);\n\tstream->length += len;\n\tlist_add_tail(&frag_container->node, &stream->fragments);\n\tspin_unlock(&stream->lock);\n\n\treturn 0;\n}\n\nint string_stream_add(struct string_stream *stream, const char *fmt, ...)\n{\n\tva_list args;\n\tint result;\n\n\tva_start(args, fmt);\n\tresult = string_stream_vadd(stream, fmt, args);\n\tva_end(args);\n\n\treturn result;\n}\n\nstatic void string_stream_clear(struct string_stream *stream)\n{\n\tstruct string_stream_fragment *frag_container, *frag_container_safe;\n\n\tspin_lock(&stream->lock);\n\tlist_for_each_entry_safe(frag_container,\n\t\t\t\t frag_container_safe,\n\t\t\t\t &stream->fragments,\n\t\t\t\t node) {\n\t\tstring_stream_fragment_destroy(stream->test, frag_container);\n\t}\n\tstream->length = 0;\n\tspin_unlock(&stream->lock);\n}\n\nchar *string_stream_get_string(struct string_stream *stream)\n{\n\tstruct string_stream_fragment *frag_container;\n\tsize_t buf_len = stream->length + 1;  \n\tchar *buf;\n\n\tbuf = kunit_kzalloc(stream->test, buf_len, stream->gfp);\n\tif (!buf)\n\t\treturn NULL;\n\n\tspin_lock(&stream->lock);\n\tlist_for_each_entry(frag_container, &stream->fragments, node)\n\t\tstrlcat(buf, frag_container->fragment, buf_len);\n\tspin_unlock(&stream->lock);\n\n\treturn buf;\n}\n\nint string_stream_append(struct string_stream *stream,\n\t\t\t struct string_stream *other)\n{\n\tconst char *other_content;\n\n\tother_content = string_stream_get_string(other);\n\n\tif (!other_content)\n\t\treturn -ENOMEM;\n\n\treturn string_stream_add(stream, other_content);\n}\n\nbool string_stream_is_empty(struct string_stream *stream)\n{\n\treturn list_empty(&stream->fragments);\n}\n\nstruct string_stream *alloc_string_stream(struct kunit *test, gfp_t gfp)\n{\n\tstruct string_stream *stream;\n\n\tstream = kunit_kzalloc(test, sizeof(*stream), gfp);\n\tif (!stream)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tstream->gfp = gfp;\n\tstream->test = test;\n\tINIT_LIST_HEAD(&stream->fragments);\n\tspin_lock_init(&stream->lock);\n\n\treturn stream;\n}\n\nvoid string_stream_destroy(struct string_stream *stream)\n{\n\tstring_stream_clear(stream);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}