{
  "module_name": "resource.c",
  "hash_id": "bcce8ea37cbe9a0ca86f67774f36fac0c06b1a20ba8613ae43896e626a80b883",
  "original_prompt": "Ingested from linux-6.6.14/lib/kunit/resource.c",
  "human_readable_source": "\n \n\n#include <kunit/resource.h>\n#include <kunit/test.h>\n#include <linux/kref.h>\n\n \nint __kunit_add_resource(struct kunit *test,\n\t\t\t kunit_resource_init_t init,\n\t\t\t kunit_resource_free_t free,\n\t\t\t struct kunit_resource *res,\n\t\t\t void *data)\n{\n\tint ret = 0;\n\tunsigned long flags;\n\n\tres->free = free;\n\tkref_init(&res->refcount);\n\n\tif (init) {\n\t\tret = init(res, data);\n\t\tif (ret)\n\t\t\treturn ret;\n\t} else {\n\t\tres->data = data;\n\t}\n\n\tspin_lock_irqsave(&test->lock, flags);\n\tlist_add_tail(&res->node, &test->resources);\n\t \n\tspin_unlock_irqrestore(&test->lock, flags);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(__kunit_add_resource);\n\nvoid kunit_remove_resource(struct kunit *test, struct kunit_resource *res)\n{\n\tunsigned long flags;\n\tbool was_linked;\n\n\tspin_lock_irqsave(&test->lock, flags);\n\twas_linked = !list_empty(&res->node);\n\tlist_del_init(&res->node);\n\tspin_unlock_irqrestore(&test->lock, flags);\n\n\tif (was_linked)\n\t\tkunit_put_resource(res);\n}\nEXPORT_SYMBOL_GPL(kunit_remove_resource);\n\nint kunit_destroy_resource(struct kunit *test, kunit_resource_match_t match,\n\t\t\t   void *match_data)\n{\n\tstruct kunit_resource *res = kunit_find_resource(test, match,\n\t\t\t\t\t\t\t match_data);\n\n\tif (!res)\n\t\treturn -ENOENT;\n\n\tkunit_remove_resource(test, res);\n\n\t \n\tkunit_put_resource(res);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(kunit_destroy_resource);\n\nstruct kunit_action_ctx {\n\tstruct kunit_resource res;\n\tkunit_action_t *func;\n\tvoid *ctx;\n};\n\nstatic void __kunit_action_free(struct kunit_resource *res)\n{\n\tstruct kunit_action_ctx *action_ctx = container_of(res, struct kunit_action_ctx, res);\n\n\taction_ctx->func(action_ctx->ctx);\n}\n\n\nint kunit_add_action(struct kunit *test, void (*action)(void *), void *ctx)\n{\n\tstruct kunit_action_ctx *action_ctx;\n\n\tKUNIT_ASSERT_NOT_NULL_MSG(test, action, \"Tried to action a NULL function!\");\n\n\taction_ctx = kzalloc(sizeof(*action_ctx), GFP_KERNEL);\n\tif (!action_ctx)\n\t\treturn -ENOMEM;\n\n\taction_ctx->func = action;\n\taction_ctx->ctx = ctx;\n\n\taction_ctx->res.should_kfree = true;\n\t \n\t__kunit_add_resource(test, NULL, __kunit_action_free, &action_ctx->res, action_ctx);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(kunit_add_action);\n\nint kunit_add_action_or_reset(struct kunit *test, void (*action)(void *),\n\t\t\t      void *ctx)\n{\n\tint res = kunit_add_action(test, action, ctx);\n\n\tif (res)\n\t\taction(ctx);\n\treturn res;\n}\nEXPORT_SYMBOL_GPL(kunit_add_action_or_reset);\n\nstatic bool __kunit_action_match(struct kunit *test,\n\t\t\t\tstruct kunit_resource *res, void *match_data)\n{\n\tstruct kunit_action_ctx *match_ctx = (struct kunit_action_ctx *)match_data;\n\tstruct kunit_action_ctx *res_ctx = container_of(res, struct kunit_action_ctx, res);\n\n\t \n\tif (res->free != __kunit_action_free)\n\t\treturn false;\n\n\t \n\treturn (match_ctx->func == res_ctx->func) && (match_ctx->ctx == res_ctx->ctx);\n}\n\nvoid kunit_remove_action(struct kunit *test,\n\t\t\tkunit_action_t *action,\n\t\t\tvoid *ctx)\n{\n\tstruct kunit_action_ctx match_ctx;\n\tstruct kunit_resource *res;\n\n\tmatch_ctx.func = action;\n\tmatch_ctx.ctx = ctx;\n\n\tres = kunit_find_resource(test, __kunit_action_match, &match_ctx);\n\tif (res) {\n\t\t \n\t\tres->free = NULL;\n\t\tkunit_remove_resource(test, res);\n\t\tkunit_put_resource(res);\n\t}\n}\nEXPORT_SYMBOL_GPL(kunit_remove_action);\n\nvoid kunit_release_action(struct kunit *test,\n\t\t\t kunit_action_t *action,\n\t\t\t void *ctx)\n{\n\tstruct kunit_action_ctx match_ctx;\n\tstruct kunit_resource *res;\n\n\tmatch_ctx.func = action;\n\tmatch_ctx.ctx = ctx;\n\n\tres = kunit_find_resource(test, __kunit_action_match, &match_ctx);\n\tif (res) {\n\t\tkunit_remove_resource(test, res);\n\t\t \n\t\tkunit_put_resource(res);\n\t}\n}\nEXPORT_SYMBOL_GPL(kunit_release_action);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}