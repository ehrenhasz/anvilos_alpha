{
  "module_name": "nmi_backtrace.c",
  "hash_id": "9b6c200b712bc936516301e7b2534ba9565da7efbf3f6e18512ca38d9e7bc8f9",
  "original_prompt": "Ingested from linux-6.6.14/lib/nmi_backtrace.c",
  "human_readable_source": "\n \n#include <linux/cpumask.h>\n#include <linux/delay.h>\n#include <linux/kprobes.h>\n#include <linux/nmi.h>\n#include <linux/cpu.h>\n#include <linux/sched/debug.h>\n\n#ifdef arch_trigger_cpumask_backtrace\n \nstatic DECLARE_BITMAP(backtrace_mask, NR_CPUS) __read_mostly;\n\n \nstatic unsigned long backtrace_flag;\n\n \nvoid nmi_trigger_cpumask_backtrace(const cpumask_t *mask,\n\t\t\t\t   int exclude_cpu,\n\t\t\t\t   void (*raise)(cpumask_t *mask))\n{\n\tint i, this_cpu = get_cpu();\n\n\tif (test_and_set_bit(0, &backtrace_flag)) {\n\t\t \n\t\tput_cpu();\n\t\treturn;\n\t}\n\n\tcpumask_copy(to_cpumask(backtrace_mask), mask);\n\tif (exclude_cpu != -1)\n\t\tcpumask_clear_cpu(exclude_cpu, to_cpumask(backtrace_mask));\n\n\t \n\tif (cpumask_test_cpu(this_cpu, to_cpumask(backtrace_mask)))\n\t\tnmi_cpu_backtrace(NULL);\n\n\tif (!cpumask_empty(to_cpumask(backtrace_mask))) {\n\t\tpr_info(\"Sending NMI from CPU %d to CPUs %*pbl:\\n\",\n\t\t\tthis_cpu, nr_cpumask_bits, to_cpumask(backtrace_mask));\n\t\tnmi_backtrace_stall_snap(to_cpumask(backtrace_mask));\n\t\traise(to_cpumask(backtrace_mask));\n\t}\n\n\t \n\tfor (i = 0; i < 10 * 1000; i++) {\n\t\tif (cpumask_empty(to_cpumask(backtrace_mask)))\n\t\t\tbreak;\n\t\tmdelay(1);\n\t\ttouch_softlockup_watchdog();\n\t}\n\tnmi_backtrace_stall_check(to_cpumask(backtrace_mask));\n\n\t \n\tprintk_trigger_flush();\n\n\tclear_bit_unlock(0, &backtrace_flag);\n\tput_cpu();\n}\n\n\nstatic bool backtrace_idle;\nmodule_param(backtrace_idle, bool, 0644);\n\nbool nmi_cpu_backtrace(struct pt_regs *regs)\n{\n\tint cpu = smp_processor_id();\n\tunsigned long flags;\n\n\tif (cpumask_test_cpu(cpu, to_cpumask(backtrace_mask))) {\n\t\t \n\t\tprintk_cpu_sync_get_irqsave(flags);\n\t\tif (!READ_ONCE(backtrace_idle) && regs && cpu_in_idle(instruction_pointer(regs))) {\n\t\t\tpr_warn(\"NMI backtrace for cpu %d skipped: idling at %pS\\n\",\n\t\t\t\tcpu, (void *)instruction_pointer(regs));\n\t\t} else {\n\t\t\tpr_warn(\"NMI backtrace for cpu %d\\n\", cpu);\n\t\t\tif (regs)\n\t\t\t\tshow_regs(regs);\n\t\t\telse\n\t\t\t\tdump_stack();\n\t\t}\n\t\tprintk_cpu_sync_put_irqrestore(flags);\n\t\tcpumask_clear_cpu(cpu, to_cpumask(backtrace_mask));\n\t\treturn true;\n\t}\n\n\treturn false;\n}\nNOKPROBE_SYMBOL(nmi_cpu_backtrace);\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}