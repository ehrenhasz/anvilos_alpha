{
  "module_name": "kfifo.c",
  "hash_id": "4a1d2dfabbec1eee1c4675550aa6e1d29a9757fd55fb99d8d4ad30de478d6cb0",
  "original_prompt": "Ingested from linux-6.6.14/lib/kfifo.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/export.h>\n#include <linux/slab.h>\n#include <linux/err.h>\n#include <linux/log2.h>\n#include <linux/uaccess.h>\n#include <linux/kfifo.h>\n\n \nstatic inline unsigned int kfifo_unused(struct __kfifo *fifo)\n{\n\treturn (fifo->mask + 1) - (fifo->in - fifo->out);\n}\n\nint __kfifo_alloc(struct __kfifo *fifo, unsigned int size,\n\t\tsize_t esize, gfp_t gfp_mask)\n{\n\t \n\tsize = roundup_pow_of_two(size);\n\n\tfifo->in = 0;\n\tfifo->out = 0;\n\tfifo->esize = esize;\n\n\tif (size < 2) {\n\t\tfifo->data = NULL;\n\t\tfifo->mask = 0;\n\t\treturn -EINVAL;\n\t}\n\n\tfifo->data = kmalloc_array(esize, size, gfp_mask);\n\n\tif (!fifo->data) {\n\t\tfifo->mask = 0;\n\t\treturn -ENOMEM;\n\t}\n\tfifo->mask = size - 1;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(__kfifo_alloc);\n\nvoid __kfifo_free(struct __kfifo *fifo)\n{\n\tkfree(fifo->data);\n\tfifo->in = 0;\n\tfifo->out = 0;\n\tfifo->esize = 0;\n\tfifo->data = NULL;\n\tfifo->mask = 0;\n}\nEXPORT_SYMBOL(__kfifo_free);\n\nint __kfifo_init(struct __kfifo *fifo, void *buffer,\n\t\tunsigned int size, size_t esize)\n{\n\tsize /= esize;\n\n\tif (!is_power_of_2(size))\n\t\tsize = rounddown_pow_of_two(size);\n\n\tfifo->in = 0;\n\tfifo->out = 0;\n\tfifo->esize = esize;\n\tfifo->data = buffer;\n\n\tif (size < 2) {\n\t\tfifo->mask = 0;\n\t\treturn -EINVAL;\n\t}\n\tfifo->mask = size - 1;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(__kfifo_init);\n\nstatic void kfifo_copy_in(struct __kfifo *fifo, const void *src,\n\t\tunsigned int len, unsigned int off)\n{\n\tunsigned int size = fifo->mask + 1;\n\tunsigned int esize = fifo->esize;\n\tunsigned int l;\n\n\toff &= fifo->mask;\n\tif (esize != 1) {\n\t\toff *= esize;\n\t\tsize *= esize;\n\t\tlen *= esize;\n\t}\n\tl = min(len, size - off);\n\n\tmemcpy(fifo->data + off, src, l);\n\tmemcpy(fifo->data, src + l, len - l);\n\t \n\tsmp_wmb();\n}\n\nunsigned int __kfifo_in(struct __kfifo *fifo,\n\t\tconst void *buf, unsigned int len)\n{\n\tunsigned int l;\n\n\tl = kfifo_unused(fifo);\n\tif (len > l)\n\t\tlen = l;\n\n\tkfifo_copy_in(fifo, buf, len, fifo->in);\n\tfifo->in += len;\n\treturn len;\n}\nEXPORT_SYMBOL(__kfifo_in);\n\nstatic void kfifo_copy_out(struct __kfifo *fifo, void *dst,\n\t\tunsigned int len, unsigned int off)\n{\n\tunsigned int size = fifo->mask + 1;\n\tunsigned int esize = fifo->esize;\n\tunsigned int l;\n\n\toff &= fifo->mask;\n\tif (esize != 1) {\n\t\toff *= esize;\n\t\tsize *= esize;\n\t\tlen *= esize;\n\t}\n\tl = min(len, size - off);\n\n\tmemcpy(dst, fifo->data + off, l);\n\tmemcpy(dst + l, fifo->data, len - l);\n\t \n\tsmp_wmb();\n}\n\nunsigned int __kfifo_out_peek(struct __kfifo *fifo,\n\t\tvoid *buf, unsigned int len)\n{\n\tunsigned int l;\n\n\tl = fifo->in - fifo->out;\n\tif (len > l)\n\t\tlen = l;\n\n\tkfifo_copy_out(fifo, buf, len, fifo->out);\n\treturn len;\n}\nEXPORT_SYMBOL(__kfifo_out_peek);\n\nunsigned int __kfifo_out(struct __kfifo *fifo,\n\t\tvoid *buf, unsigned int len)\n{\n\tlen = __kfifo_out_peek(fifo, buf, len);\n\tfifo->out += len;\n\treturn len;\n}\nEXPORT_SYMBOL(__kfifo_out);\n\nstatic unsigned long kfifo_copy_from_user(struct __kfifo *fifo,\n\tconst void __user *from, unsigned int len, unsigned int off,\n\tunsigned int *copied)\n{\n\tunsigned int size = fifo->mask + 1;\n\tunsigned int esize = fifo->esize;\n\tunsigned int l;\n\tunsigned long ret;\n\n\toff &= fifo->mask;\n\tif (esize != 1) {\n\t\toff *= esize;\n\t\tsize *= esize;\n\t\tlen *= esize;\n\t}\n\tl = min(len, size - off);\n\n\tret = copy_from_user(fifo->data + off, from, l);\n\tif (unlikely(ret))\n\t\tret = DIV_ROUND_UP(ret + len - l, esize);\n\telse {\n\t\tret = copy_from_user(fifo->data, from + l, len - l);\n\t\tif (unlikely(ret))\n\t\t\tret = DIV_ROUND_UP(ret, esize);\n\t}\n\t \n\tsmp_wmb();\n\t*copied = len - ret * esize;\n\t \n\treturn ret;\n}\n\nint __kfifo_from_user(struct __kfifo *fifo, const void __user *from,\n\t\tunsigned long len, unsigned int *copied)\n{\n\tunsigned int l;\n\tunsigned long ret;\n\tunsigned int esize = fifo->esize;\n\tint err;\n\n\tif (esize != 1)\n\t\tlen /= esize;\n\n\tl = kfifo_unused(fifo);\n\tif (len > l)\n\t\tlen = l;\n\n\tret = kfifo_copy_from_user(fifo, from, len, fifo->in, copied);\n\tif (unlikely(ret)) {\n\t\tlen -= ret;\n\t\terr = -EFAULT;\n\t} else\n\t\terr = 0;\n\tfifo->in += len;\n\treturn err;\n}\nEXPORT_SYMBOL(__kfifo_from_user);\n\nstatic unsigned long kfifo_copy_to_user(struct __kfifo *fifo, void __user *to,\n\t\tunsigned int len, unsigned int off, unsigned int *copied)\n{\n\tunsigned int l;\n\tunsigned long ret;\n\tunsigned int size = fifo->mask + 1;\n\tunsigned int esize = fifo->esize;\n\n\toff &= fifo->mask;\n\tif (esize != 1) {\n\t\toff *= esize;\n\t\tsize *= esize;\n\t\tlen *= esize;\n\t}\n\tl = min(len, size - off);\n\n\tret = copy_to_user(to, fifo->data + off, l);\n\tif (unlikely(ret))\n\t\tret = DIV_ROUND_UP(ret + len - l, esize);\n\telse {\n\t\tret = copy_to_user(to + l, fifo->data, len - l);\n\t\tif (unlikely(ret))\n\t\t\tret = DIV_ROUND_UP(ret, esize);\n\t}\n\t \n\tsmp_wmb();\n\t*copied = len - ret * esize;\n\t \n\treturn ret;\n}\n\nint __kfifo_to_user(struct __kfifo *fifo, void __user *to,\n\t\tunsigned long len, unsigned int *copied)\n{\n\tunsigned int l;\n\tunsigned long ret;\n\tunsigned int esize = fifo->esize;\n\tint err;\n\n\tif (esize != 1)\n\t\tlen /= esize;\n\n\tl = fifo->in - fifo->out;\n\tif (len > l)\n\t\tlen = l;\n\tret = kfifo_copy_to_user(fifo, to, len, fifo->out, copied);\n\tif (unlikely(ret)) {\n\t\tlen -= ret;\n\t\terr = -EFAULT;\n\t} else\n\t\terr = 0;\n\tfifo->out += len;\n\treturn err;\n}\nEXPORT_SYMBOL(__kfifo_to_user);\n\nstatic int setup_sgl_buf(struct scatterlist *sgl, void *buf,\n\t\tint nents, unsigned int len)\n{\n\tint n;\n\tunsigned int l;\n\tunsigned int off;\n\tstruct page *page;\n\n\tif (!nents)\n\t\treturn 0;\n\n\tif (!len)\n\t\treturn 0;\n\n\tn = 0;\n\tpage = virt_to_page(buf);\n\toff = offset_in_page(buf);\n\tl = 0;\n\n\twhile (len >= l + PAGE_SIZE - off) {\n\t\tstruct page *npage;\n\n\t\tl += PAGE_SIZE;\n\t\tbuf += PAGE_SIZE;\n\t\tnpage = virt_to_page(buf);\n\t\tif (page_to_phys(page) != page_to_phys(npage) - l) {\n\t\t\tsg_set_page(sgl, page, l - off, off);\n\t\t\tsgl = sg_next(sgl);\n\t\t\tif (++n == nents || sgl == NULL)\n\t\t\t\treturn n;\n\t\t\tpage = npage;\n\t\t\tlen -= l - off;\n\t\t\tl = off = 0;\n\t\t}\n\t}\n\tsg_set_page(sgl, page, len, off);\n\treturn n + 1;\n}\n\nstatic unsigned int setup_sgl(struct __kfifo *fifo, struct scatterlist *sgl,\n\t\tint nents, unsigned int len, unsigned int off)\n{\n\tunsigned int size = fifo->mask + 1;\n\tunsigned int esize = fifo->esize;\n\tunsigned int l;\n\tunsigned int n;\n\n\toff &= fifo->mask;\n\tif (esize != 1) {\n\t\toff *= esize;\n\t\tsize *= esize;\n\t\tlen *= esize;\n\t}\n\tl = min(len, size - off);\n\n\tn = setup_sgl_buf(sgl, fifo->data + off, nents, l);\n\tn += setup_sgl_buf(sgl + n, fifo->data, nents - n, len - l);\n\n\treturn n;\n}\n\nunsigned int __kfifo_dma_in_prepare(struct __kfifo *fifo,\n\t\tstruct scatterlist *sgl, int nents, unsigned int len)\n{\n\tunsigned int l;\n\n\tl = kfifo_unused(fifo);\n\tif (len > l)\n\t\tlen = l;\n\n\treturn setup_sgl(fifo, sgl, nents, len, fifo->in);\n}\nEXPORT_SYMBOL(__kfifo_dma_in_prepare);\n\nunsigned int __kfifo_dma_out_prepare(struct __kfifo *fifo,\n\t\tstruct scatterlist *sgl, int nents, unsigned int len)\n{\n\tunsigned int l;\n\n\tl = fifo->in - fifo->out;\n\tif (len > l)\n\t\tlen = l;\n\n\treturn setup_sgl(fifo, sgl, nents, len, fifo->out);\n}\nEXPORT_SYMBOL(__kfifo_dma_out_prepare);\n\nunsigned int __kfifo_max_r(unsigned int len, size_t recsize)\n{\n\tunsigned int max = (1 << (recsize << 3)) - 1;\n\n\tif (len > max)\n\t\treturn max;\n\treturn len;\n}\nEXPORT_SYMBOL(__kfifo_max_r);\n\n#define\t__KFIFO_PEEK(data, out, mask) \\\n\t((data)[(out) & (mask)])\n \nstatic unsigned int __kfifo_peek_n(struct __kfifo *fifo, size_t recsize)\n{\n\tunsigned int l;\n\tunsigned int mask = fifo->mask;\n\tunsigned char *data = fifo->data;\n\n\tl = __KFIFO_PEEK(data, fifo->out, mask);\n\n\tif (--recsize)\n\t\tl |= __KFIFO_PEEK(data, fifo->out + 1, mask) << 8;\n\n\treturn l;\n}\n\n#define\t__KFIFO_POKE(data, in, mask, val) \\\n\t( \\\n\t(data)[(in) & (mask)] = (unsigned char)(val) \\\n\t)\n\n \nstatic void __kfifo_poke_n(struct __kfifo *fifo, unsigned int n, size_t recsize)\n{\n\tunsigned int mask = fifo->mask;\n\tunsigned char *data = fifo->data;\n\n\t__KFIFO_POKE(data, fifo->in, mask, n);\n\n\tif (recsize > 1)\n\t\t__KFIFO_POKE(data, fifo->in + 1, mask, n >> 8);\n}\n\nunsigned int __kfifo_len_r(struct __kfifo *fifo, size_t recsize)\n{\n\treturn __kfifo_peek_n(fifo, recsize);\n}\nEXPORT_SYMBOL(__kfifo_len_r);\n\nunsigned int __kfifo_in_r(struct __kfifo *fifo, const void *buf,\n\t\tunsigned int len, size_t recsize)\n{\n\tif (len + recsize > kfifo_unused(fifo))\n\t\treturn 0;\n\n\t__kfifo_poke_n(fifo, len, recsize);\n\n\tkfifo_copy_in(fifo, buf, len, fifo->in + recsize);\n\tfifo->in += len + recsize;\n\treturn len;\n}\nEXPORT_SYMBOL(__kfifo_in_r);\n\nstatic unsigned int kfifo_out_copy_r(struct __kfifo *fifo,\n\tvoid *buf, unsigned int len, size_t recsize, unsigned int *n)\n{\n\t*n = __kfifo_peek_n(fifo, recsize);\n\n\tif (len > *n)\n\t\tlen = *n;\n\n\tkfifo_copy_out(fifo, buf, len, fifo->out + recsize);\n\treturn len;\n}\n\nunsigned int __kfifo_out_peek_r(struct __kfifo *fifo, void *buf,\n\t\tunsigned int len, size_t recsize)\n{\n\tunsigned int n;\n\n\tif (fifo->in == fifo->out)\n\t\treturn 0;\n\n\treturn kfifo_out_copy_r(fifo, buf, len, recsize, &n);\n}\nEXPORT_SYMBOL(__kfifo_out_peek_r);\n\nunsigned int __kfifo_out_r(struct __kfifo *fifo, void *buf,\n\t\tunsigned int len, size_t recsize)\n{\n\tunsigned int n;\n\n\tif (fifo->in == fifo->out)\n\t\treturn 0;\n\n\tlen = kfifo_out_copy_r(fifo, buf, len, recsize, &n);\n\tfifo->out += n + recsize;\n\treturn len;\n}\nEXPORT_SYMBOL(__kfifo_out_r);\n\nvoid __kfifo_skip_r(struct __kfifo *fifo, size_t recsize)\n{\n\tunsigned int n;\n\n\tn = __kfifo_peek_n(fifo, recsize);\n\tfifo->out += n + recsize;\n}\nEXPORT_SYMBOL(__kfifo_skip_r);\n\nint __kfifo_from_user_r(struct __kfifo *fifo, const void __user *from,\n\tunsigned long len, unsigned int *copied, size_t recsize)\n{\n\tunsigned long ret;\n\n\tlen = __kfifo_max_r(len, recsize);\n\n\tif (len + recsize > kfifo_unused(fifo)) {\n\t\t*copied = 0;\n\t\treturn 0;\n\t}\n\n\t__kfifo_poke_n(fifo, len, recsize);\n\n\tret = kfifo_copy_from_user(fifo, from, len, fifo->in + recsize, copied);\n\tif (unlikely(ret)) {\n\t\t*copied = 0;\n\t\treturn -EFAULT;\n\t}\n\tfifo->in += len + recsize;\n\treturn 0;\n}\nEXPORT_SYMBOL(__kfifo_from_user_r);\n\nint __kfifo_to_user_r(struct __kfifo *fifo, void __user *to,\n\tunsigned long len, unsigned int *copied, size_t recsize)\n{\n\tunsigned long ret;\n\tunsigned int n;\n\n\tif (fifo->in == fifo->out) {\n\t\t*copied = 0;\n\t\treturn 0;\n\t}\n\n\tn = __kfifo_peek_n(fifo, recsize);\n\tif (len > n)\n\t\tlen = n;\n\n\tret = kfifo_copy_to_user(fifo, to, len, fifo->out + recsize, copied);\n\tif (unlikely(ret)) {\n\t\t*copied = 0;\n\t\treturn -EFAULT;\n\t}\n\tfifo->out += n + recsize;\n\treturn 0;\n}\nEXPORT_SYMBOL(__kfifo_to_user_r);\n\nunsigned int __kfifo_dma_in_prepare_r(struct __kfifo *fifo,\n\tstruct scatterlist *sgl, int nents, unsigned int len, size_t recsize)\n{\n\tBUG_ON(!nents);\n\n\tlen = __kfifo_max_r(len, recsize);\n\n\tif (len + recsize > kfifo_unused(fifo))\n\t\treturn 0;\n\n\treturn setup_sgl(fifo, sgl, nents, len, fifo->in + recsize);\n}\nEXPORT_SYMBOL(__kfifo_dma_in_prepare_r);\n\nvoid __kfifo_dma_in_finish_r(struct __kfifo *fifo,\n\tunsigned int len, size_t recsize)\n{\n\tlen = __kfifo_max_r(len, recsize);\n\t__kfifo_poke_n(fifo, len, recsize);\n\tfifo->in += len + recsize;\n}\nEXPORT_SYMBOL(__kfifo_dma_in_finish_r);\n\nunsigned int __kfifo_dma_out_prepare_r(struct __kfifo *fifo,\n\tstruct scatterlist *sgl, int nents, unsigned int len, size_t recsize)\n{\n\tBUG_ON(!nents);\n\n\tlen = __kfifo_max_r(len, recsize);\n\n\tif (len + recsize > fifo->in - fifo->out)\n\t\treturn 0;\n\n\treturn setup_sgl(fifo, sgl, nents, len, fifo->out + recsize);\n}\nEXPORT_SYMBOL(__kfifo_dma_out_prepare_r);\n\nvoid __kfifo_dma_out_finish_r(struct __kfifo *fifo, size_t recsize)\n{\n\tunsigned int len;\n\n\tlen = __kfifo_peek_n(fifo, recsize);\n\tfifo->out += len + recsize;\n}\nEXPORT_SYMBOL(__kfifo_dma_out_finish_r);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}