{
  "module_name": "atomic64_test.c",
  "hash_id": "0f7dbbf238f877e925b5a3668219b385e3ee175f4256aef8fb589de0f601bf5c",
  "original_prompt": "Ingested from linux-6.6.14/lib/atomic64_test.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/init.h>\n#include <linux/bug.h>\n#include <linux/kernel.h>\n#include <linux/atomic.h>\n#include <linux/module.h>\n\n#ifdef CONFIG_X86\n#include <asm/cpufeature.h>\t \n#endif\n\n#define TEST(bit, op, c_op, val)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tatomic##bit##_set(&v, v0);\t\t\t\t\\\n\tr = v0;\t\t\t\t\t\t\t\\\n\tatomic##bit##_##op(val, &v);\t\t\t\t\\\n\tr c_op val;\t\t\t\t\t\t\\\n\tWARN(atomic##bit##_read(&v) != r, \"%Lx != %Lx\\n\",\t\\\n\t\t(unsigned long long)atomic##bit##_read(&v),\t\\\n\t\t(unsigned long long)r);\t\t\t\t\\\n} while (0)\n\n \n\n#define FAMILY_TEST(test, bit, op, args...)\t\\\ndo {\t\t\t\t\t\t\\\n\ttest(bit, op, ##args);\t\t\\\n\ttest(bit, op##_acquire, ##args);\t\\\n\ttest(bit, op##_release, ##args);\t\\\n\ttest(bit, op##_relaxed, ##args);\t\\\n} while (0)\n\n#define TEST_RETURN(bit, op, c_op, val)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tatomic##bit##_set(&v, v0);\t\t\t\t\\\n\tr = v0;\t\t\t\t\t\t\t\\\n\tr c_op val;\t\t\t\t\t\t\\\n\tBUG_ON(atomic##bit##_##op(val, &v) != r);\t\t\\\n\tBUG_ON(atomic##bit##_read(&v) != r);\t\t\t\\\n} while (0)\n\n#define TEST_FETCH(bit, op, c_op, val)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tatomic##bit##_set(&v, v0);\t\t\t\t\\\n\tr = v0;\t\t\t\t\t\t\t\\\n\tr c_op val;\t\t\t\t\t\t\\\n\tBUG_ON(atomic##bit##_##op(val, &v) != v0);\t\t\\\n\tBUG_ON(atomic##bit##_read(&v) != r);\t\t\t\\\n} while (0)\n\n#define RETURN_FAMILY_TEST(bit, op, c_op, val)\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tFAMILY_TEST(TEST_RETURN, bit, op, c_op, val);\t\t\\\n} while (0)\n\n#define FETCH_FAMILY_TEST(bit, op, c_op, val)\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tFAMILY_TEST(TEST_FETCH, bit, op, c_op, val);\t\t\\\n} while (0)\n\n#define TEST_ARGS(bit, op, init, ret, expect, args...)\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tatomic##bit##_set(&v, init);\t\t\t\t\\\n\tBUG_ON(atomic##bit##_##op(&v, ##args) != ret);\t\t\\\n\tBUG_ON(atomic##bit##_read(&v) != expect);\t\t\\\n} while (0)\n\n#define XCHG_FAMILY_TEST(bit, init, new)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tFAMILY_TEST(TEST_ARGS, bit, xchg, init, init, new, new);\t\\\n} while (0)\n\n#define CMPXCHG_FAMILY_TEST(bit, init, new, wrong)\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tFAMILY_TEST(TEST_ARGS, bit, cmpxchg, \t\t\t\t\\\n\t\t\tinit, init, new, init, new);\t\t\t\\\n\tFAMILY_TEST(TEST_ARGS, bit, cmpxchg,\t\t\t\t\\\n\t\t\tinit, init, init, wrong, new);\t\t\t\\\n} while (0)\n\n#define INC_RETURN_FAMILY_TEST(bit, i)\t\t\t\\\ndo {\t\t\t\t\t\t\t\\\n\tFAMILY_TEST(TEST_ARGS, bit, inc_return,\t\t\\\n\t\t\ti, (i) + one, (i) + one);\t\\\n} while (0)\n\n#define DEC_RETURN_FAMILY_TEST(bit, i)\t\t\t\\\ndo {\t\t\t\t\t\t\t\\\n\tFAMILY_TEST(TEST_ARGS, bit, dec_return,\t\t\\\n\t\t\ti, (i) - one, (i) - one);\t\\\n} while (0)\n\nstatic __init void test_atomic(void)\n{\n\tint v0 = 0xaaa31337;\n\tint v1 = 0xdeadbeef;\n\tint onestwos = 0x11112222;\n\tint one = 1;\n\n\tatomic_t v;\n\tint r;\n\n\tTEST(, add, +=, onestwos);\n\tTEST(, add, +=, -one);\n\tTEST(, sub, -=, onestwos);\n\tTEST(, sub, -=, -one);\n\tTEST(, or, |=, v1);\n\tTEST(, and, &=, v1);\n\tTEST(, xor, ^=, v1);\n\tTEST(, andnot, &= ~, v1);\n\n\tRETURN_FAMILY_TEST(, add_return, +=, onestwos);\n\tRETURN_FAMILY_TEST(, add_return, +=, -one);\n\tRETURN_FAMILY_TEST(, sub_return, -=, onestwos);\n\tRETURN_FAMILY_TEST(, sub_return, -=, -one);\n\n\tFETCH_FAMILY_TEST(, fetch_add, +=, onestwos);\n\tFETCH_FAMILY_TEST(, fetch_add, +=, -one);\n\tFETCH_FAMILY_TEST(, fetch_sub, -=, onestwos);\n\tFETCH_FAMILY_TEST(, fetch_sub, -=, -one);\n\n\tFETCH_FAMILY_TEST(, fetch_or,  |=, v1);\n\tFETCH_FAMILY_TEST(, fetch_and, &=, v1);\n\tFETCH_FAMILY_TEST(, fetch_andnot, &= ~, v1);\n\tFETCH_FAMILY_TEST(, fetch_xor, ^=, v1);\n\n\tINC_RETURN_FAMILY_TEST(, v0);\n\tDEC_RETURN_FAMILY_TEST(, v0);\n\n\tXCHG_FAMILY_TEST(, v0, v1);\n\tCMPXCHG_FAMILY_TEST(, v0, v1, onestwos);\n\n}\n\n#define INIT(c) do { atomic64_set(&v, c); r = c; } while (0)\nstatic __init void test_atomic64(void)\n{\n\tlong long v0 = 0xaaa31337c001d00dLL;\n\tlong long v1 = 0xdeadbeefdeafcafeLL;\n\tlong long v2 = 0xfaceabadf00df001LL;\n\tlong long v3 = 0x8000000000000000LL;\n\tlong long onestwos = 0x1111111122222222LL;\n\tlong long one = 1LL;\n\tint r_int;\n\n\tatomic64_t v = ATOMIC64_INIT(v0);\n\tlong long r = v0;\n\tBUG_ON(v.counter != r);\n\n\tatomic64_set(&v, v1);\n\tr = v1;\n\tBUG_ON(v.counter != r);\n\tBUG_ON(atomic64_read(&v) != r);\n\n\tTEST(64, add, +=, onestwos);\n\tTEST(64, add, +=, -one);\n\tTEST(64, sub, -=, onestwos);\n\tTEST(64, sub, -=, -one);\n\tTEST(64, or, |=, v1);\n\tTEST(64, and, &=, v1);\n\tTEST(64, xor, ^=, v1);\n\tTEST(64, andnot, &= ~, v1);\n\n\tRETURN_FAMILY_TEST(64, add_return, +=, onestwos);\n\tRETURN_FAMILY_TEST(64, add_return, +=, -one);\n\tRETURN_FAMILY_TEST(64, sub_return, -=, onestwos);\n\tRETURN_FAMILY_TEST(64, sub_return, -=, -one);\n\n\tFETCH_FAMILY_TEST(64, fetch_add, +=, onestwos);\n\tFETCH_FAMILY_TEST(64, fetch_add, +=, -one);\n\tFETCH_FAMILY_TEST(64, fetch_sub, -=, onestwos);\n\tFETCH_FAMILY_TEST(64, fetch_sub, -=, -one);\n\n\tFETCH_FAMILY_TEST(64, fetch_or,  |=, v1);\n\tFETCH_FAMILY_TEST(64, fetch_and, &=, v1);\n\tFETCH_FAMILY_TEST(64, fetch_andnot, &= ~, v1);\n\tFETCH_FAMILY_TEST(64, fetch_xor, ^=, v1);\n\n\tINIT(v0);\n\tatomic64_inc(&v);\n\tr += one;\n\tBUG_ON(v.counter != r);\n\n\tINIT(v0);\n\tatomic64_dec(&v);\n\tr -= one;\n\tBUG_ON(v.counter != r);\n\n\tINC_RETURN_FAMILY_TEST(64, v0);\n\tDEC_RETURN_FAMILY_TEST(64, v0);\n\n\tXCHG_FAMILY_TEST(64, v0, v1);\n\tCMPXCHG_FAMILY_TEST(64, v0, v1, v2);\n\n\tINIT(v0);\n\tBUG_ON(atomic64_add_unless(&v, one, v0));\n\tBUG_ON(v.counter != r);\n\n\tINIT(v0);\n\tBUG_ON(!atomic64_add_unless(&v, one, v1));\n\tr += one;\n\tBUG_ON(v.counter != r);\n\n\tINIT(onestwos);\n\tBUG_ON(atomic64_dec_if_positive(&v) != (onestwos - 1));\n\tr -= one;\n\tBUG_ON(v.counter != r);\n\n\tINIT(0);\n\tBUG_ON(atomic64_dec_if_positive(&v) != -one);\n\tBUG_ON(v.counter != r);\n\n\tINIT(-one);\n\tBUG_ON(atomic64_dec_if_positive(&v) != (-one - one));\n\tBUG_ON(v.counter != r);\n\n\tINIT(onestwos);\n\tBUG_ON(!atomic64_inc_not_zero(&v));\n\tr += one;\n\tBUG_ON(v.counter != r);\n\n\tINIT(0);\n\tBUG_ON(atomic64_inc_not_zero(&v));\n\tBUG_ON(v.counter != r);\n\n\tINIT(-one);\n\tBUG_ON(!atomic64_inc_not_zero(&v));\n\tr += one;\n\tBUG_ON(v.counter != r);\n\n\t \n\tINIT(v3);\n\tr_int = atomic64_inc_not_zero(&v);\n\tBUG_ON(!r_int);\n}\n\nstatic __init int test_atomics_init(void)\n{\n\ttest_atomic();\n\ttest_atomic64();\n\n#ifdef CONFIG_X86\n\tpr_info(\"passed for %s platform %s CX8 and %s SSE\\n\",\n#ifdef CONFIG_X86_64\n\t\t\"x86-64\",\n#elif defined(CONFIG_X86_CMPXCHG64)\n\t\t\"i586+\",\n#else\n\t\t\"i386+\",\n#endif\n\t       boot_cpu_has(X86_FEATURE_CX8) ? \"with\" : \"without\",\n\t       boot_cpu_has(X86_FEATURE_XMM) ? \"with\" : \"without\");\n#else\n\tpr_info(\"passed\\n\");\n#endif\n\n\treturn 0;\n}\n\nstatic __exit void test_atomics_exit(void) {}\n\nmodule_init(test_atomics_init);\nmodule_exit(test_atomics_exit);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}