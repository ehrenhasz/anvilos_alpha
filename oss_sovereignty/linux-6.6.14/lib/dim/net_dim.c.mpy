{
  "module_name": "net_dim.c",
  "hash_id": "d5c99ee2d92c29c9c6c0e4b8720739ebadca09533eda9a7b0eec47df3e7472b4",
  "original_prompt": "Ingested from linux-6.6.14/lib/dim/net_dim.c",
  "human_readable_source": "\n \n\n#include <linux/dim.h>\n\n \n#define NET_DIM_PARAMS_NUM_PROFILES 5\n#define NET_DIM_DEFAULT_RX_CQ_PKTS_FROM_EQE 256\n#define NET_DIM_DEFAULT_TX_CQ_PKTS_FROM_EQE 128\n#define NET_DIM_DEF_PROFILE_CQE 1\n#define NET_DIM_DEF_PROFILE_EQE 1\n\n#define NET_DIM_RX_EQE_PROFILES { \\\n\t{.usec = 1,   .pkts = NET_DIM_DEFAULT_RX_CQ_PKTS_FROM_EQE,}, \\\n\t{.usec = 8,   .pkts = NET_DIM_DEFAULT_RX_CQ_PKTS_FROM_EQE,}, \\\n\t{.usec = 64,  .pkts = NET_DIM_DEFAULT_RX_CQ_PKTS_FROM_EQE,}, \\\n\t{.usec = 128, .pkts = NET_DIM_DEFAULT_RX_CQ_PKTS_FROM_EQE,}, \\\n\t{.usec = 256, .pkts = NET_DIM_DEFAULT_RX_CQ_PKTS_FROM_EQE,}  \\\n}\n\n#define NET_DIM_RX_CQE_PROFILES { \\\n\t{.usec = 2,  .pkts = 256,},             \\\n\t{.usec = 8,  .pkts = 128,},             \\\n\t{.usec = 16, .pkts = 64,},              \\\n\t{.usec = 32, .pkts = 64,},              \\\n\t{.usec = 64, .pkts = 64,}               \\\n}\n\n#define NET_DIM_TX_EQE_PROFILES { \\\n\t{.usec = 1,   .pkts = NET_DIM_DEFAULT_TX_CQ_PKTS_FROM_EQE,},  \\\n\t{.usec = 8,   .pkts = NET_DIM_DEFAULT_TX_CQ_PKTS_FROM_EQE,},  \\\n\t{.usec = 32,  .pkts = NET_DIM_DEFAULT_TX_CQ_PKTS_FROM_EQE,},  \\\n\t{.usec = 64,  .pkts = NET_DIM_DEFAULT_TX_CQ_PKTS_FROM_EQE,},  \\\n\t{.usec = 128, .pkts = NET_DIM_DEFAULT_TX_CQ_PKTS_FROM_EQE,}   \\\n}\n\n#define NET_DIM_TX_CQE_PROFILES { \\\n\t{.usec = 5,  .pkts = 128,},  \\\n\t{.usec = 8,  .pkts = 64,},  \\\n\t{.usec = 16, .pkts = 32,},  \\\n\t{.usec = 32, .pkts = 32,},  \\\n\t{.usec = 64, .pkts = 32,}   \\\n}\n\nstatic const struct dim_cq_moder\nrx_profile[DIM_CQ_PERIOD_NUM_MODES][NET_DIM_PARAMS_NUM_PROFILES] = {\n\tNET_DIM_RX_EQE_PROFILES,\n\tNET_DIM_RX_CQE_PROFILES,\n};\n\nstatic const struct dim_cq_moder\ntx_profile[DIM_CQ_PERIOD_NUM_MODES][NET_DIM_PARAMS_NUM_PROFILES] = {\n\tNET_DIM_TX_EQE_PROFILES,\n\tNET_DIM_TX_CQE_PROFILES,\n};\n\nstruct dim_cq_moder\nnet_dim_get_rx_moderation(u8 cq_period_mode, int ix)\n{\n\tstruct dim_cq_moder cq_moder = rx_profile[cq_period_mode][ix];\n\n\tcq_moder.cq_period_mode = cq_period_mode;\n\treturn cq_moder;\n}\nEXPORT_SYMBOL(net_dim_get_rx_moderation);\n\nstruct dim_cq_moder\nnet_dim_get_def_rx_moderation(u8 cq_period_mode)\n{\n\tu8 profile_ix = cq_period_mode == DIM_CQ_PERIOD_MODE_START_FROM_CQE ?\n\t\t\tNET_DIM_DEF_PROFILE_CQE : NET_DIM_DEF_PROFILE_EQE;\n\n\treturn net_dim_get_rx_moderation(cq_period_mode, profile_ix);\n}\nEXPORT_SYMBOL(net_dim_get_def_rx_moderation);\n\nstruct dim_cq_moder\nnet_dim_get_tx_moderation(u8 cq_period_mode, int ix)\n{\n\tstruct dim_cq_moder cq_moder = tx_profile[cq_period_mode][ix];\n\n\tcq_moder.cq_period_mode = cq_period_mode;\n\treturn cq_moder;\n}\nEXPORT_SYMBOL(net_dim_get_tx_moderation);\n\nstruct dim_cq_moder\nnet_dim_get_def_tx_moderation(u8 cq_period_mode)\n{\n\tu8 profile_ix = cq_period_mode == DIM_CQ_PERIOD_MODE_START_FROM_CQE ?\n\t\t\tNET_DIM_DEF_PROFILE_CQE : NET_DIM_DEF_PROFILE_EQE;\n\n\treturn net_dim_get_tx_moderation(cq_period_mode, profile_ix);\n}\nEXPORT_SYMBOL(net_dim_get_def_tx_moderation);\n\nstatic int net_dim_step(struct dim *dim)\n{\n\tif (dim->tired == (NET_DIM_PARAMS_NUM_PROFILES * 2))\n\t\treturn DIM_TOO_TIRED;\n\n\tswitch (dim->tune_state) {\n\tcase DIM_PARKING_ON_TOP:\n\tcase DIM_PARKING_TIRED:\n\t\tbreak;\n\tcase DIM_GOING_RIGHT:\n\t\tif (dim->profile_ix == (NET_DIM_PARAMS_NUM_PROFILES - 1))\n\t\t\treturn DIM_ON_EDGE;\n\t\tdim->profile_ix++;\n\t\tdim->steps_right++;\n\t\tbreak;\n\tcase DIM_GOING_LEFT:\n\t\tif (dim->profile_ix == 0)\n\t\t\treturn DIM_ON_EDGE;\n\t\tdim->profile_ix--;\n\t\tdim->steps_left++;\n\t\tbreak;\n\t}\n\n\tdim->tired++;\n\treturn DIM_STEPPED;\n}\n\nstatic void net_dim_exit_parking(struct dim *dim)\n{\n\tdim->tune_state = dim->profile_ix ? DIM_GOING_LEFT : DIM_GOING_RIGHT;\n\tnet_dim_step(dim);\n}\n\nstatic int net_dim_stats_compare(struct dim_stats *curr,\n\t\t\t\t struct dim_stats *prev)\n{\n\tif (!prev->bpms)\n\t\treturn curr->bpms ? DIM_STATS_BETTER : DIM_STATS_SAME;\n\n\tif (IS_SIGNIFICANT_DIFF(curr->bpms, prev->bpms))\n\t\treturn (curr->bpms > prev->bpms) ? DIM_STATS_BETTER :\n\t\t\t\t\t\t   DIM_STATS_WORSE;\n\n\tif (!prev->ppms)\n\t\treturn curr->ppms ? DIM_STATS_BETTER :\n\t\t\t\t    DIM_STATS_SAME;\n\n\tif (IS_SIGNIFICANT_DIFF(curr->ppms, prev->ppms))\n\t\treturn (curr->ppms > prev->ppms) ? DIM_STATS_BETTER :\n\t\t\t\t\t\t   DIM_STATS_WORSE;\n\n\tif (!prev->epms)\n\t\treturn DIM_STATS_SAME;\n\n\tif (IS_SIGNIFICANT_DIFF(curr->epms, prev->epms))\n\t\treturn (curr->epms < prev->epms) ? DIM_STATS_BETTER :\n\t\t\t\t\t\t   DIM_STATS_WORSE;\n\n\treturn DIM_STATS_SAME;\n}\n\nstatic bool net_dim_decision(struct dim_stats *curr_stats, struct dim *dim)\n{\n\tint prev_state = dim->tune_state;\n\tint prev_ix = dim->profile_ix;\n\tint stats_res;\n\tint step_res;\n\n\tswitch (dim->tune_state) {\n\tcase DIM_PARKING_ON_TOP:\n\t\tstats_res = net_dim_stats_compare(curr_stats,\n\t\t\t\t\t\t  &dim->prev_stats);\n\t\tif (stats_res != DIM_STATS_SAME)\n\t\t\tnet_dim_exit_parking(dim);\n\t\tbreak;\n\n\tcase DIM_PARKING_TIRED:\n\t\tdim->tired--;\n\t\tif (!dim->tired)\n\t\t\tnet_dim_exit_parking(dim);\n\t\tbreak;\n\n\tcase DIM_GOING_RIGHT:\n\tcase DIM_GOING_LEFT:\n\t\tstats_res = net_dim_stats_compare(curr_stats,\n\t\t\t\t\t\t  &dim->prev_stats);\n\t\tif (stats_res != DIM_STATS_BETTER)\n\t\t\tdim_turn(dim);\n\n\t\tif (dim_on_top(dim)) {\n\t\t\tdim_park_on_top(dim);\n\t\t\tbreak;\n\t\t}\n\n\t\tstep_res = net_dim_step(dim);\n\t\tswitch (step_res) {\n\t\tcase DIM_ON_EDGE:\n\t\t\tdim_park_on_top(dim);\n\t\t\tbreak;\n\t\tcase DIM_TOO_TIRED:\n\t\t\tdim_park_tired(dim);\n\t\t\tbreak;\n\t\t}\n\n\t\tbreak;\n\t}\n\n\tif (prev_state != DIM_PARKING_ON_TOP ||\n\t    dim->tune_state != DIM_PARKING_ON_TOP)\n\t\tdim->prev_stats = *curr_stats;\n\n\treturn dim->profile_ix != prev_ix;\n}\n\nvoid net_dim(struct dim *dim, struct dim_sample end_sample)\n{\n\tstruct dim_stats curr_stats;\n\tu16 nevents;\n\n\tswitch (dim->state) {\n\tcase DIM_MEASURE_IN_PROGRESS:\n\t\tnevents = BIT_GAP(BITS_PER_TYPE(u16),\n\t\t\t\t  end_sample.event_ctr,\n\t\t\t\t  dim->start_sample.event_ctr);\n\t\tif (nevents < DIM_NEVENTS)\n\t\t\tbreak;\n\t\tif (!dim_calc_stats(&dim->start_sample, &end_sample, &curr_stats))\n\t\t\tbreak;\n\t\tif (net_dim_decision(&curr_stats, dim)) {\n\t\t\tdim->state = DIM_APPLY_NEW_PROFILE;\n\t\t\tschedule_work(&dim->work);\n\t\t\tbreak;\n\t\t}\n\t\tfallthrough;\n\tcase DIM_START_MEASURE:\n\t\tdim_update_sample(end_sample.event_ctr, end_sample.pkt_ctr,\n\t\t\t\t  end_sample.byte_ctr, &dim->start_sample);\n\t\tdim->state = DIM_MEASURE_IN_PROGRESS;\n\t\tbreak;\n\tcase DIM_APPLY_NEW_PROFILE:\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL(net_dim);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}