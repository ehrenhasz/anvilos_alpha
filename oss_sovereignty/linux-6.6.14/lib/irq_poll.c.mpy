{
  "module_name": "irq_poll.c",
  "hash_id": "299420534cd36cdc70707dac0a2518bf4e53a22d2c8438fee8c8c3113513b647",
  "original_prompt": "Ingested from linux-6.6.14/lib/irq_poll.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/bio.h>\n#include <linux/interrupt.h>\n#include <linux/cpu.h>\n#include <linux/irq_poll.h>\n#include <linux/delay.h>\n\nstatic unsigned int irq_poll_budget __read_mostly = 256;\n\nstatic DEFINE_PER_CPU(struct list_head, blk_cpu_iopoll);\n\n \nvoid irq_poll_sched(struct irq_poll *iop)\n{\n\tunsigned long flags;\n\n\tif (test_bit(IRQ_POLL_F_DISABLE, &iop->state))\n\t\treturn;\n\tif (test_and_set_bit(IRQ_POLL_F_SCHED, &iop->state))\n\t\treturn;\n\n\tlocal_irq_save(flags);\n\tlist_add_tail(&iop->list, this_cpu_ptr(&blk_cpu_iopoll));\n\traise_softirq_irqoff(IRQ_POLL_SOFTIRQ);\n\tlocal_irq_restore(flags);\n}\nEXPORT_SYMBOL(irq_poll_sched);\n\n \nstatic void __irq_poll_complete(struct irq_poll *iop)\n{\n\tlist_del(&iop->list);\n\tsmp_mb__before_atomic();\n\tclear_bit_unlock(IRQ_POLL_F_SCHED, &iop->state);\n}\n\n \nvoid irq_poll_complete(struct irq_poll *iop)\n{\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\t__irq_poll_complete(iop);\n\tlocal_irq_restore(flags);\n}\nEXPORT_SYMBOL(irq_poll_complete);\n\nstatic void __latent_entropy irq_poll_softirq(struct softirq_action *h)\n{\n\tstruct list_head *list = this_cpu_ptr(&blk_cpu_iopoll);\n\tint rearm = 0, budget = irq_poll_budget;\n\tunsigned long start_time = jiffies;\n\n\tlocal_irq_disable();\n\n\twhile (!list_empty(list)) {\n\t\tstruct irq_poll *iop;\n\t\tint work, weight;\n\n\t\t \n\t\tif (budget <= 0 || time_after(jiffies, start_time)) {\n\t\t\trearm = 1;\n\t\t\tbreak;\n\t\t}\n\n\t\tlocal_irq_enable();\n\n\t\t \n\t\tiop = list_entry(list->next, struct irq_poll, list);\n\n\t\tweight = iop->weight;\n\t\twork = 0;\n\t\tif (test_bit(IRQ_POLL_F_SCHED, &iop->state))\n\t\t\twork = iop->poll(iop, weight);\n\n\t\tbudget -= work;\n\n\t\tlocal_irq_disable();\n\n\t\t \n\t\tif (work >= weight) {\n\t\t\tif (test_bit(IRQ_POLL_F_DISABLE, &iop->state))\n\t\t\t\t__irq_poll_complete(iop);\n\t\t\telse\n\t\t\t\tlist_move_tail(&iop->list, list);\n\t\t}\n\t}\n\n\tif (rearm)\n\t\t__raise_softirq_irqoff(IRQ_POLL_SOFTIRQ);\n\n\tlocal_irq_enable();\n}\n\n \nvoid irq_poll_disable(struct irq_poll *iop)\n{\n\tset_bit(IRQ_POLL_F_DISABLE, &iop->state);\n\twhile (test_and_set_bit(IRQ_POLL_F_SCHED, &iop->state))\n\t\tmsleep(1);\n\tclear_bit(IRQ_POLL_F_DISABLE, &iop->state);\n}\nEXPORT_SYMBOL(irq_poll_disable);\n\n \nvoid irq_poll_enable(struct irq_poll *iop)\n{\n\tBUG_ON(!test_bit(IRQ_POLL_F_SCHED, &iop->state));\n\tsmp_mb__before_atomic();\n\tclear_bit_unlock(IRQ_POLL_F_SCHED, &iop->state);\n}\nEXPORT_SYMBOL(irq_poll_enable);\n\n \nvoid irq_poll_init(struct irq_poll *iop, int weight, irq_poll_fn *poll_fn)\n{\n\tmemset(iop, 0, sizeof(*iop));\n\tINIT_LIST_HEAD(&iop->list);\n\tiop->weight = weight;\n\tiop->poll = poll_fn;\n}\nEXPORT_SYMBOL(irq_poll_init);\n\nstatic int irq_poll_cpu_dead(unsigned int cpu)\n{\n\t \n\tlocal_bh_disable();\n\tlocal_irq_disable();\n\tlist_splice_init(&per_cpu(blk_cpu_iopoll, cpu),\n\t\t\t this_cpu_ptr(&blk_cpu_iopoll));\n\t__raise_softirq_irqoff(IRQ_POLL_SOFTIRQ);\n\tlocal_irq_enable();\n\tlocal_bh_enable();\n\n\treturn 0;\n}\n\nstatic __init int irq_poll_setup(void)\n{\n\tint i;\n\n\tfor_each_possible_cpu(i)\n\t\tINIT_LIST_HEAD(&per_cpu(blk_cpu_iopoll, i));\n\n\topen_softirq(IRQ_POLL_SOFTIRQ, irq_poll_softirq);\n\tcpuhp_setup_state_nocalls(CPUHP_IRQ_POLL_DEAD, \"irq_poll:dead\", NULL,\n\t\t\t\t  irq_poll_cpu_dead);\n\treturn 0;\n}\nsubsys_initcall(irq_poll_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}