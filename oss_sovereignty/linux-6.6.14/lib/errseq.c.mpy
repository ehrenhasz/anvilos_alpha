{
  "module_name": "errseq.c",
  "hash_id": "4c9bdb44c311517c86383a8be44152565cfa0c155599b139e18743929c1a4b85",
  "original_prompt": "Ingested from linux-6.6.14/lib/errseq.c",
  "human_readable_source": "\n#include <linux/err.h>\n#include <linux/bug.h>\n#include <linux/atomic.h>\n#include <linux/errseq.h>\n#include <linux/log2.h>\n\n \n\n \n#define ERRSEQ_SHIFT\t\tilog2(MAX_ERRNO + 1)\n\n \n#define ERRSEQ_SEEN\t\t(1 << ERRSEQ_SHIFT)\n\n \n#define ERRSEQ_CTR_INC\t\t(1 << (ERRSEQ_SHIFT + 1))\n\n \nerrseq_t errseq_set(errseq_t *eseq, int err)\n{\n\terrseq_t cur, old;\n\n\t \n\tBUILD_BUG_ON_NOT_POWER_OF_2(MAX_ERRNO + 1);\n\n\t \n\told = READ_ONCE(*eseq);\n\n\tif (WARN(unlikely(err == 0 || (unsigned int)-err > MAX_ERRNO),\n\t\t\t\t\"err = %d\\n\", err))\n\t\treturn old;\n\n\tfor (;;) {\n\t\terrseq_t new;\n\n\t\t \n\t\tnew = (old & ~(MAX_ERRNO|ERRSEQ_SEEN)) | -err;\n\n\t\t \n\t\tif (old & ERRSEQ_SEEN)\n\t\t\tnew += ERRSEQ_CTR_INC;\n\n\t\t \n\t\tif (new == old) {\n\t\t\tcur = new;\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tcur = cmpxchg(eseq, old, new);\n\n\t\t \n\t\tif (likely(cur == old || cur == new))\n\t\t\tbreak;\n\n\t\t \n\t\told = cur;\n\t}\n\treturn cur;\n}\nEXPORT_SYMBOL(errseq_set);\n\n \nerrseq_t errseq_sample(errseq_t *eseq)\n{\n\terrseq_t old = READ_ONCE(*eseq);\n\n\t \n\tif (!(old & ERRSEQ_SEEN))\n\t\told = 0;\n\treturn old;\n}\nEXPORT_SYMBOL(errseq_sample);\n\n \nint errseq_check(errseq_t *eseq, errseq_t since)\n{\n\terrseq_t cur = READ_ONCE(*eseq);\n\n\tif (likely(cur == since))\n\t\treturn 0;\n\treturn -(cur & MAX_ERRNO);\n}\nEXPORT_SYMBOL(errseq_check);\n\n \nint errseq_check_and_advance(errseq_t *eseq, errseq_t *since)\n{\n\tint err = 0;\n\terrseq_t old, new;\n\n\t \n\told = READ_ONCE(*eseq);\n\tif (old != *since) {\n\t\t \n\t\tnew = old | ERRSEQ_SEEN;\n\t\tif (new != old)\n\t\t\tcmpxchg(eseq, old, new);\n\t\t*since = new;\n\t\terr = -(new & MAX_ERRNO);\n\t}\n\treturn err;\n}\nEXPORT_SYMBOL(errseq_check_and_advance);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}