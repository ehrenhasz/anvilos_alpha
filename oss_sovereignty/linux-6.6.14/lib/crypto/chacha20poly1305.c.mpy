{
  "module_name": "chacha20poly1305.c",
  "hash_id": "ab9a5ebc5b21447aecfd44ee06ebd96bc5059747d45f43d574366903363041e4",
  "original_prompt": "Ingested from linux-6.6.14/lib/crypto/chacha20poly1305.c",
  "human_readable_source": "\n \n\n#include <crypto/algapi.h>\n#include <crypto/chacha20poly1305.h>\n#include <crypto/chacha.h>\n#include <crypto/poly1305.h>\n#include <crypto/scatterwalk.h>\n\n#include <asm/unaligned.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n\n#define CHACHA_KEY_WORDS\t(CHACHA_KEY_SIZE / sizeof(u32))\n\nstatic void chacha_load_key(u32 *k, const u8 *in)\n{\n\tk[0] = get_unaligned_le32(in);\n\tk[1] = get_unaligned_le32(in + 4);\n\tk[2] = get_unaligned_le32(in + 8);\n\tk[3] = get_unaligned_le32(in + 12);\n\tk[4] = get_unaligned_le32(in + 16);\n\tk[5] = get_unaligned_le32(in + 20);\n\tk[6] = get_unaligned_le32(in + 24);\n\tk[7] = get_unaligned_le32(in + 28);\n}\n\nstatic void xchacha_init(u32 *chacha_state, const u8 *key, const u8 *nonce)\n{\n\tu32 k[CHACHA_KEY_WORDS];\n\tu8 iv[CHACHA_IV_SIZE];\n\n\tmemset(iv, 0, 8);\n\tmemcpy(iv + 8, nonce + 16, 8);\n\n\tchacha_load_key(k, key);\n\n\t \n\tchacha_init(chacha_state, k, nonce);\n\thchacha_block(chacha_state, k, 20);\n\n\tchacha_init(chacha_state, k, iv);\n\n\tmemzero_explicit(k, sizeof(k));\n\tmemzero_explicit(iv, sizeof(iv));\n}\n\nstatic void\n__chacha20poly1305_encrypt(u8 *dst, const u8 *src, const size_t src_len,\n\t\t\t   const u8 *ad, const size_t ad_len, u32 *chacha_state)\n{\n\tconst u8 *pad0 = page_address(ZERO_PAGE(0));\n\tstruct poly1305_desc_ctx poly1305_state;\n\tunion {\n\t\tu8 block0[POLY1305_KEY_SIZE];\n\t\t__le64 lens[2];\n\t} b;\n\n\tchacha20_crypt(chacha_state, b.block0, pad0, sizeof(b.block0));\n\tpoly1305_init(&poly1305_state, b.block0);\n\n\tpoly1305_update(&poly1305_state, ad, ad_len);\n\tif (ad_len & 0xf)\n\t\tpoly1305_update(&poly1305_state, pad0, 0x10 - (ad_len & 0xf));\n\n\tchacha20_crypt(chacha_state, dst, src, src_len);\n\n\tpoly1305_update(&poly1305_state, dst, src_len);\n\tif (src_len & 0xf)\n\t\tpoly1305_update(&poly1305_state, pad0, 0x10 - (src_len & 0xf));\n\n\tb.lens[0] = cpu_to_le64(ad_len);\n\tb.lens[1] = cpu_to_le64(src_len);\n\tpoly1305_update(&poly1305_state, (u8 *)b.lens, sizeof(b.lens));\n\n\tpoly1305_final(&poly1305_state, dst + src_len);\n\n\tmemzero_explicit(chacha_state, CHACHA_STATE_WORDS * sizeof(u32));\n\tmemzero_explicit(&b, sizeof(b));\n}\n\nvoid chacha20poly1305_encrypt(u8 *dst, const u8 *src, const size_t src_len,\n\t\t\t      const u8 *ad, const size_t ad_len,\n\t\t\t      const u64 nonce,\n\t\t\t      const u8 key[CHACHA20POLY1305_KEY_SIZE])\n{\n\tu32 chacha_state[CHACHA_STATE_WORDS];\n\tu32 k[CHACHA_KEY_WORDS];\n\t__le64 iv[2];\n\n\tchacha_load_key(k, key);\n\n\tiv[0] = 0;\n\tiv[1] = cpu_to_le64(nonce);\n\n\tchacha_init(chacha_state, k, (u8 *)iv);\n\t__chacha20poly1305_encrypt(dst, src, src_len, ad, ad_len, chacha_state);\n\n\tmemzero_explicit(iv, sizeof(iv));\n\tmemzero_explicit(k, sizeof(k));\n}\nEXPORT_SYMBOL(chacha20poly1305_encrypt);\n\nvoid xchacha20poly1305_encrypt(u8 *dst, const u8 *src, const size_t src_len,\n\t\t\t       const u8 *ad, const size_t ad_len,\n\t\t\t       const u8 nonce[XCHACHA20POLY1305_NONCE_SIZE],\n\t\t\t       const u8 key[CHACHA20POLY1305_KEY_SIZE])\n{\n\tu32 chacha_state[CHACHA_STATE_WORDS];\n\n\txchacha_init(chacha_state, key, nonce);\n\t__chacha20poly1305_encrypt(dst, src, src_len, ad, ad_len, chacha_state);\n}\nEXPORT_SYMBOL(xchacha20poly1305_encrypt);\n\nstatic bool\n__chacha20poly1305_decrypt(u8 *dst, const u8 *src, const size_t src_len,\n\t\t\t   const u8 *ad, const size_t ad_len, u32 *chacha_state)\n{\n\tconst u8 *pad0 = page_address(ZERO_PAGE(0));\n\tstruct poly1305_desc_ctx poly1305_state;\n\tsize_t dst_len;\n\tint ret;\n\tunion {\n\t\tu8 block0[POLY1305_KEY_SIZE];\n\t\tu8 mac[POLY1305_DIGEST_SIZE];\n\t\t__le64 lens[2];\n\t} b;\n\n\tif (unlikely(src_len < POLY1305_DIGEST_SIZE))\n\t\treturn false;\n\n\tchacha20_crypt(chacha_state, b.block0, pad0, sizeof(b.block0));\n\tpoly1305_init(&poly1305_state, b.block0);\n\n\tpoly1305_update(&poly1305_state, ad, ad_len);\n\tif (ad_len & 0xf)\n\t\tpoly1305_update(&poly1305_state, pad0, 0x10 - (ad_len & 0xf));\n\n\tdst_len = src_len - POLY1305_DIGEST_SIZE;\n\tpoly1305_update(&poly1305_state, src, dst_len);\n\tif (dst_len & 0xf)\n\t\tpoly1305_update(&poly1305_state, pad0, 0x10 - (dst_len & 0xf));\n\n\tb.lens[0] = cpu_to_le64(ad_len);\n\tb.lens[1] = cpu_to_le64(dst_len);\n\tpoly1305_update(&poly1305_state, (u8 *)b.lens, sizeof(b.lens));\n\n\tpoly1305_final(&poly1305_state, b.mac);\n\n\tret = crypto_memneq(b.mac, src + dst_len, POLY1305_DIGEST_SIZE);\n\tif (likely(!ret))\n\t\tchacha20_crypt(chacha_state, dst, src, dst_len);\n\n\tmemzero_explicit(&b, sizeof(b));\n\n\treturn !ret;\n}\n\nbool chacha20poly1305_decrypt(u8 *dst, const u8 *src, const size_t src_len,\n\t\t\t      const u8 *ad, const size_t ad_len,\n\t\t\t      const u64 nonce,\n\t\t\t      const u8 key[CHACHA20POLY1305_KEY_SIZE])\n{\n\tu32 chacha_state[CHACHA_STATE_WORDS];\n\tu32 k[CHACHA_KEY_WORDS];\n\t__le64 iv[2];\n\tbool ret;\n\n\tchacha_load_key(k, key);\n\n\tiv[0] = 0;\n\tiv[1] = cpu_to_le64(nonce);\n\n\tchacha_init(chacha_state, k, (u8 *)iv);\n\tret = __chacha20poly1305_decrypt(dst, src, src_len, ad, ad_len,\n\t\t\t\t\t chacha_state);\n\n\tmemzero_explicit(chacha_state, sizeof(chacha_state));\n\tmemzero_explicit(iv, sizeof(iv));\n\tmemzero_explicit(k, sizeof(k));\n\treturn ret;\n}\nEXPORT_SYMBOL(chacha20poly1305_decrypt);\n\nbool xchacha20poly1305_decrypt(u8 *dst, const u8 *src, const size_t src_len,\n\t\t\t       const u8 *ad, const size_t ad_len,\n\t\t\t       const u8 nonce[XCHACHA20POLY1305_NONCE_SIZE],\n\t\t\t       const u8 key[CHACHA20POLY1305_KEY_SIZE])\n{\n\tu32 chacha_state[CHACHA_STATE_WORDS];\n\n\txchacha_init(chacha_state, key, nonce);\n\treturn __chacha20poly1305_decrypt(dst, src, src_len, ad, ad_len,\n\t\t\t\t\t  chacha_state);\n}\nEXPORT_SYMBOL(xchacha20poly1305_decrypt);\n\nstatic\nbool chacha20poly1305_crypt_sg_inplace(struct scatterlist *src,\n\t\t\t\t       const size_t src_len,\n\t\t\t\t       const u8 *ad, const size_t ad_len,\n\t\t\t\t       const u64 nonce,\n\t\t\t\t       const u8 key[CHACHA20POLY1305_KEY_SIZE],\n\t\t\t\t       int encrypt)\n{\n\tconst u8 *pad0 = page_address(ZERO_PAGE(0));\n\tstruct poly1305_desc_ctx poly1305_state;\n\tu32 chacha_state[CHACHA_STATE_WORDS];\n\tstruct sg_mapping_iter miter;\n\tsize_t partial = 0;\n\tunsigned int flags;\n\tbool ret = true;\n\tint sl;\n\tunion {\n\t\tstruct {\n\t\t\tu32 k[CHACHA_KEY_WORDS];\n\t\t\t__le64 iv[2];\n\t\t};\n\t\tu8 block0[POLY1305_KEY_SIZE];\n\t\tu8 chacha_stream[CHACHA_BLOCK_SIZE];\n\t\tstruct {\n\t\t\tu8 mac[2][POLY1305_DIGEST_SIZE];\n\t\t};\n\t\t__le64 lens[2];\n\t} b __aligned(16);\n\n\tif (WARN_ON(src_len > INT_MAX))\n\t\treturn false;\n\n\tchacha_load_key(b.k, key);\n\n\tb.iv[0] = 0;\n\tb.iv[1] = cpu_to_le64(nonce);\n\n\tchacha_init(chacha_state, b.k, (u8 *)b.iv);\n\tchacha20_crypt(chacha_state, b.block0, pad0, sizeof(b.block0));\n\tpoly1305_init(&poly1305_state, b.block0);\n\n\tif (unlikely(ad_len)) {\n\t\tpoly1305_update(&poly1305_state, ad, ad_len);\n\t\tif (ad_len & 0xf)\n\t\t\tpoly1305_update(&poly1305_state, pad0, 0x10 - (ad_len & 0xf));\n\t}\n\n\tflags = SG_MITER_TO_SG | SG_MITER_ATOMIC;\n\n\tsg_miter_start(&miter, src, sg_nents(src), flags);\n\n\tfor (sl = src_len; sl > 0 && sg_miter_next(&miter); sl -= miter.length) {\n\t\tu8 *addr = miter.addr;\n\t\tsize_t length = min_t(size_t, sl, miter.length);\n\n\t\tif (!encrypt)\n\t\t\tpoly1305_update(&poly1305_state, addr, length);\n\n\t\tif (unlikely(partial)) {\n\t\t\tsize_t l = min(length, CHACHA_BLOCK_SIZE - partial);\n\n\t\t\tcrypto_xor(addr, b.chacha_stream + partial, l);\n\t\t\tpartial = (partial + l) & (CHACHA_BLOCK_SIZE - 1);\n\n\t\t\taddr += l;\n\t\t\tlength -= l;\n\t\t}\n\n\t\tif (likely(length >= CHACHA_BLOCK_SIZE || length == sl)) {\n\t\t\tsize_t l = length;\n\n\t\t\tif (unlikely(length < sl))\n\t\t\t\tl &= ~(CHACHA_BLOCK_SIZE - 1);\n\t\t\tchacha20_crypt(chacha_state, addr, addr, l);\n\t\t\taddr += l;\n\t\t\tlength -= l;\n\t\t}\n\n\t\tif (unlikely(length > 0)) {\n\t\t\tchacha20_crypt(chacha_state, b.chacha_stream, pad0,\n\t\t\t\t       CHACHA_BLOCK_SIZE);\n\t\t\tcrypto_xor(addr, b.chacha_stream, length);\n\t\t\tpartial = length;\n\t\t}\n\n\t\tif (encrypt)\n\t\t\tpoly1305_update(&poly1305_state, miter.addr,\n\t\t\t\t\tmin_t(size_t, sl, miter.length));\n\t}\n\n\tif (src_len & 0xf)\n\t\tpoly1305_update(&poly1305_state, pad0, 0x10 - (src_len & 0xf));\n\n\tb.lens[0] = cpu_to_le64(ad_len);\n\tb.lens[1] = cpu_to_le64(src_len);\n\tpoly1305_update(&poly1305_state, (u8 *)b.lens, sizeof(b.lens));\n\n\tif (likely(sl <= -POLY1305_DIGEST_SIZE)) {\n\t\tif (encrypt) {\n\t\t\tpoly1305_final(&poly1305_state,\n\t\t\t\t       miter.addr + miter.length + sl);\n\t\t\tret = true;\n\t\t} else {\n\t\t\tpoly1305_final(&poly1305_state, b.mac[0]);\n\t\t\tret = !crypto_memneq(b.mac[0],\n\t\t\t\t\t     miter.addr + miter.length + sl,\n\t\t\t\t\t     POLY1305_DIGEST_SIZE);\n\t\t}\n\t}\n\n\tsg_miter_stop(&miter);\n\n\tif (unlikely(sl > -POLY1305_DIGEST_SIZE)) {\n\t\tpoly1305_final(&poly1305_state, b.mac[1]);\n\t\tscatterwalk_map_and_copy(b.mac[encrypt], src, src_len,\n\t\t\t\t\t sizeof(b.mac[1]), encrypt);\n\t\tret = encrypt ||\n\t\t      !crypto_memneq(b.mac[0], b.mac[1], POLY1305_DIGEST_SIZE);\n\t}\n\n\tmemzero_explicit(chacha_state, sizeof(chacha_state));\n\tmemzero_explicit(&b, sizeof(b));\n\n\treturn ret;\n}\n\nbool chacha20poly1305_encrypt_sg_inplace(struct scatterlist *src, size_t src_len,\n\t\t\t\t\t const u8 *ad, const size_t ad_len,\n\t\t\t\t\t const u64 nonce,\n\t\t\t\t\t const u8 key[CHACHA20POLY1305_KEY_SIZE])\n{\n\treturn chacha20poly1305_crypt_sg_inplace(src, src_len, ad, ad_len,\n\t\t\t\t\t\t nonce, key, 1);\n}\nEXPORT_SYMBOL(chacha20poly1305_encrypt_sg_inplace);\n\nbool chacha20poly1305_decrypt_sg_inplace(struct scatterlist *src, size_t src_len,\n\t\t\t\t\t const u8 *ad, const size_t ad_len,\n\t\t\t\t\t const u64 nonce,\n\t\t\t\t\t const u8 key[CHACHA20POLY1305_KEY_SIZE])\n{\n\tif (unlikely(src_len < POLY1305_DIGEST_SIZE))\n\t\treturn false;\n\n\treturn chacha20poly1305_crypt_sg_inplace(src,\n\t\t\t\t\t\t src_len - POLY1305_DIGEST_SIZE,\n\t\t\t\t\t\t ad, ad_len, nonce, key, 0);\n}\nEXPORT_SYMBOL(chacha20poly1305_decrypt_sg_inplace);\n\nstatic int __init chacha20poly1305_init(void)\n{\n\tif (!IS_ENABLED(CONFIG_CRYPTO_MANAGER_DISABLE_TESTS) &&\n\t    WARN_ON(!chacha20poly1305_selftest()))\n\t\treturn -ENODEV;\n\treturn 0;\n}\n\nstatic void __exit chacha20poly1305_exit(void)\n{\n}\n\nmodule_init(chacha20poly1305_init);\nmodule_exit(chacha20poly1305_exit);\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"ChaCha20Poly1305 AEAD construction\");\nMODULE_AUTHOR(\"Jason A. Donenfeld <Jason@zx2c4.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}