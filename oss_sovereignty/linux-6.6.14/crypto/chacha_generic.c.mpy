{
  "module_name": "chacha_generic.c",
  "hash_id": "b50da2405b350927d0dfc6ed24ed34e83c247c32c15a0938bc75c6a7d27802d4",
  "original_prompt": "Ingested from linux-6.6.14/crypto/chacha_generic.c",
  "human_readable_source": "\n \n\n#include <asm/unaligned.h>\n#include <crypto/algapi.h>\n#include <crypto/internal/chacha.h>\n#include <crypto/internal/skcipher.h>\n#include <linux/module.h>\n\nstatic int chacha_stream_xor(struct skcipher_request *req,\n\t\t\t     const struct chacha_ctx *ctx, const u8 *iv)\n{\n\tstruct skcipher_walk walk;\n\tu32 state[16];\n\tint err;\n\n\terr = skcipher_walk_virt(&walk, req, false);\n\n\tchacha_init_generic(state, ctx->key, iv);\n\n\twhile (walk.nbytes > 0) {\n\t\tunsigned int nbytes = walk.nbytes;\n\n\t\tif (nbytes < walk.total)\n\t\t\tnbytes = round_down(nbytes, CHACHA_BLOCK_SIZE);\n\n\t\tchacha_crypt_generic(state, walk.dst.virt.addr,\n\t\t\t\t     walk.src.virt.addr, nbytes, ctx->nrounds);\n\t\terr = skcipher_walk_done(&walk, walk.nbytes - nbytes);\n\t}\n\n\treturn err;\n}\n\nstatic int crypto_chacha_crypt(struct skcipher_request *req)\n{\n\tstruct crypto_skcipher *tfm = crypto_skcipher_reqtfm(req);\n\tstruct chacha_ctx *ctx = crypto_skcipher_ctx(tfm);\n\n\treturn chacha_stream_xor(req, ctx, req->iv);\n}\n\nstatic int crypto_xchacha_crypt(struct skcipher_request *req)\n{\n\tstruct crypto_skcipher *tfm = crypto_skcipher_reqtfm(req);\n\tstruct chacha_ctx *ctx = crypto_skcipher_ctx(tfm);\n\tstruct chacha_ctx subctx;\n\tu32 state[16];\n\tu8 real_iv[16];\n\n\t \n\tchacha_init_generic(state, ctx->key, req->iv);\n\thchacha_block_generic(state, subctx.key, ctx->nrounds);\n\tsubctx.nrounds = ctx->nrounds;\n\n\t \n\tmemcpy(&real_iv[0], req->iv + 24, 8);  \n\tmemcpy(&real_iv[8], req->iv + 16, 8);  \n\n\t \n\treturn chacha_stream_xor(req, &subctx, real_iv);\n}\n\nstatic struct skcipher_alg algs[] = {\n\t{\n\t\t.base.cra_name\t\t= \"chacha20\",\n\t\t.base.cra_driver_name\t= \"chacha20-generic\",\n\t\t.base.cra_priority\t= 100,\n\t\t.base.cra_blocksize\t= 1,\n\t\t.base.cra_ctxsize\t= sizeof(struct chacha_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\n\t\t.min_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.max_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.ivsize\t\t\t= CHACHA_IV_SIZE,\n\t\t.chunksize\t\t= CHACHA_BLOCK_SIZE,\n\t\t.setkey\t\t\t= chacha20_setkey,\n\t\t.encrypt\t\t= crypto_chacha_crypt,\n\t\t.decrypt\t\t= crypto_chacha_crypt,\n\t}, {\n\t\t.base.cra_name\t\t= \"xchacha20\",\n\t\t.base.cra_driver_name\t= \"xchacha20-generic\",\n\t\t.base.cra_priority\t= 100,\n\t\t.base.cra_blocksize\t= 1,\n\t\t.base.cra_ctxsize\t= sizeof(struct chacha_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\n\t\t.min_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.max_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.ivsize\t\t\t= XCHACHA_IV_SIZE,\n\t\t.chunksize\t\t= CHACHA_BLOCK_SIZE,\n\t\t.setkey\t\t\t= chacha20_setkey,\n\t\t.encrypt\t\t= crypto_xchacha_crypt,\n\t\t.decrypt\t\t= crypto_xchacha_crypt,\n\t}, {\n\t\t.base.cra_name\t\t= \"xchacha12\",\n\t\t.base.cra_driver_name\t= \"xchacha12-generic\",\n\t\t.base.cra_priority\t= 100,\n\t\t.base.cra_blocksize\t= 1,\n\t\t.base.cra_ctxsize\t= sizeof(struct chacha_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\n\t\t.min_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.max_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.ivsize\t\t\t= XCHACHA_IV_SIZE,\n\t\t.chunksize\t\t= CHACHA_BLOCK_SIZE,\n\t\t.setkey\t\t\t= chacha12_setkey,\n\t\t.encrypt\t\t= crypto_xchacha_crypt,\n\t\t.decrypt\t\t= crypto_xchacha_crypt,\n\t}\n};\n\nstatic int __init chacha_generic_mod_init(void)\n{\n\treturn crypto_register_skciphers(algs, ARRAY_SIZE(algs));\n}\n\nstatic void __exit chacha_generic_mod_fini(void)\n{\n\tcrypto_unregister_skciphers(algs, ARRAY_SIZE(algs));\n}\n\nsubsys_initcall(chacha_generic_mod_init);\nmodule_exit(chacha_generic_mod_fini);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Martin Willi <martin@strongswan.org>\");\nMODULE_DESCRIPTION(\"ChaCha and XChaCha stream ciphers (generic)\");\nMODULE_ALIAS_CRYPTO(\"chacha20\");\nMODULE_ALIAS_CRYPTO(\"chacha20-generic\");\nMODULE_ALIAS_CRYPTO(\"xchacha20\");\nMODULE_ALIAS_CRYPTO(\"xchacha20-generic\");\nMODULE_ALIAS_CRYPTO(\"xchacha12\");\nMODULE_ALIAS_CRYPTO(\"xchacha12-generic\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}