{
  "module_name": "geniv.c",
  "hash_id": "87caa5c15bca19b37fe0ad4fbcfd123379eadbc1adccc7f26479d8a96b8c51b2",
  "original_prompt": "Ingested from linux-6.6.14/crypto/geniv.c",
  "human_readable_source": "\n \n\n#include <crypto/internal/geniv.h>\n#include <crypto/internal/rng.h>\n#include <crypto/null.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/rtnetlink.h>\n#include <linux/slab.h>\n\nstatic int aead_geniv_setkey(struct crypto_aead *tfm,\n\t\t\t     const u8 *key, unsigned int keylen)\n{\n\tstruct aead_geniv_ctx *ctx = crypto_aead_ctx(tfm);\n\n\treturn crypto_aead_setkey(ctx->child, key, keylen);\n}\n\nstatic int aead_geniv_setauthsize(struct crypto_aead *tfm,\n\t\t\t\t  unsigned int authsize)\n{\n\tstruct aead_geniv_ctx *ctx = crypto_aead_ctx(tfm);\n\n\treturn crypto_aead_setauthsize(ctx->child, authsize);\n}\n\nstatic void aead_geniv_free(struct aead_instance *inst)\n{\n\tcrypto_drop_aead(aead_instance_ctx(inst));\n\tkfree(inst);\n}\n\nstruct aead_instance *aead_geniv_alloc(struct crypto_template *tmpl,\n\t\t\t\t       struct rtattr **tb)\n{\n\tstruct crypto_aead_spawn *spawn;\n\tstruct aead_instance *inst;\n\tstruct aead_alg *alg;\n\tunsigned int ivsize;\n\tunsigned int maxauthsize;\n\tu32 mask;\n\tint err;\n\n\terr = crypto_check_attr_type(tb, CRYPTO_ALG_TYPE_AEAD, &mask);\n\tif (err)\n\t\treturn ERR_PTR(err);\n\n\tinst = kzalloc(sizeof(*inst) + sizeof(*spawn), GFP_KERNEL);\n\tif (!inst)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tspawn = aead_instance_ctx(inst);\n\n\terr = crypto_grab_aead(spawn, aead_crypto_instance(inst),\n\t\t\t       crypto_attr_alg_name(tb[1]), 0, mask);\n\tif (err)\n\t\tgoto err_free_inst;\n\n\talg = crypto_spawn_aead_alg(spawn);\n\n\tivsize = crypto_aead_alg_ivsize(alg);\n\tmaxauthsize = crypto_aead_alg_maxauthsize(alg);\n\n\terr = -EINVAL;\n\tif (ivsize < sizeof(u64))\n\t\tgoto err_free_inst;\n\n\terr = -ENAMETOOLONG;\n\tif (snprintf(inst->alg.base.cra_name, CRYPTO_MAX_ALG_NAME,\n\t\t     \"%s(%s)\", tmpl->name, alg->base.cra_name) >=\n\t    CRYPTO_MAX_ALG_NAME)\n\t\tgoto err_free_inst;\n\tif (snprintf(inst->alg.base.cra_driver_name, CRYPTO_MAX_ALG_NAME,\n\t\t     \"%s(%s)\", tmpl->name, alg->base.cra_driver_name) >=\n\t    CRYPTO_MAX_ALG_NAME)\n\t\tgoto err_free_inst;\n\n\tinst->alg.base.cra_priority = alg->base.cra_priority;\n\tinst->alg.base.cra_blocksize = alg->base.cra_blocksize;\n\tinst->alg.base.cra_alignmask = alg->base.cra_alignmask;\n\tinst->alg.base.cra_ctxsize = sizeof(struct aead_geniv_ctx);\n\n\tinst->alg.setkey = aead_geniv_setkey;\n\tinst->alg.setauthsize = aead_geniv_setauthsize;\n\n\tinst->alg.ivsize = ivsize;\n\tinst->alg.maxauthsize = maxauthsize;\n\n\tinst->free = aead_geniv_free;\n\nout:\n\treturn inst;\n\nerr_free_inst:\n\taead_geniv_free(inst);\n\tinst = ERR_PTR(err);\n\tgoto out;\n}\nEXPORT_SYMBOL_GPL(aead_geniv_alloc);\n\nint aead_init_geniv(struct crypto_aead *aead)\n{\n\tstruct aead_geniv_ctx *ctx = crypto_aead_ctx(aead);\n\tstruct aead_instance *inst = aead_alg_instance(aead);\n\tstruct crypto_aead *child;\n\tint err;\n\n\tspin_lock_init(&ctx->lock);\n\n\terr = crypto_get_default_rng();\n\tif (err)\n\t\tgoto out;\n\n\terr = crypto_rng_get_bytes(crypto_default_rng, ctx->salt,\n\t\t\t\t   crypto_aead_ivsize(aead));\n\tcrypto_put_default_rng();\n\tif (err)\n\t\tgoto out;\n\n\tctx->sknull = crypto_get_default_null_skcipher();\n\terr = PTR_ERR(ctx->sknull);\n\tif (IS_ERR(ctx->sknull))\n\t\tgoto out;\n\n\tchild = crypto_spawn_aead(aead_instance_ctx(inst));\n\terr = PTR_ERR(child);\n\tif (IS_ERR(child))\n\t\tgoto drop_null;\n\n\tctx->child = child;\n\tcrypto_aead_set_reqsize(aead, crypto_aead_reqsize(child) +\n\t\t\t\t      sizeof(struct aead_request));\n\n\terr = 0;\n\nout:\n\treturn err;\n\ndrop_null:\n\tcrypto_put_default_null_skcipher();\n\tgoto out;\n}\nEXPORT_SYMBOL_GPL(aead_init_geniv);\n\nvoid aead_exit_geniv(struct crypto_aead *tfm)\n{\n\tstruct aead_geniv_ctx *ctx = crypto_aead_ctx(tfm);\n\n\tcrypto_free_aead(ctx->child);\n\tcrypto_put_default_null_skcipher();\n}\nEXPORT_SYMBOL_GPL(aead_exit_geniv);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Shared IV generator code\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}