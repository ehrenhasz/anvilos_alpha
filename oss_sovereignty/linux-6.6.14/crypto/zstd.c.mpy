{
  "module_name": "zstd.c",
  "hash_id": "d6e95be34eb4b09bace080d11bf7861591d390129e14de03f1bd44259fdde0cc",
  "original_prompt": "Ingested from linux-6.6.14/crypto/zstd.c",
  "human_readable_source": "\n \n#include <linux/crypto.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n#include <linux/net.h>\n#include <linux/vmalloc.h>\n#include <linux/zstd.h>\n#include <crypto/internal/scompress.h>\n\n\n#define ZSTD_DEF_LEVEL\t3\n\nstruct zstd_ctx {\n\tzstd_cctx *cctx;\n\tzstd_dctx *dctx;\n\tvoid *cwksp;\n\tvoid *dwksp;\n};\n\nstatic zstd_parameters zstd_params(void)\n{\n\treturn zstd_get_params(ZSTD_DEF_LEVEL, 0);\n}\n\nstatic int zstd_comp_init(struct zstd_ctx *ctx)\n{\n\tint ret = 0;\n\tconst zstd_parameters params = zstd_params();\n\tconst size_t wksp_size = zstd_cctx_workspace_bound(&params.cParams);\n\n\tctx->cwksp = vzalloc(wksp_size);\n\tif (!ctx->cwksp) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tctx->cctx = zstd_init_cctx(ctx->cwksp, wksp_size);\n\tif (!ctx->cctx) {\n\t\tret = -EINVAL;\n\t\tgoto out_free;\n\t}\nout:\n\treturn ret;\nout_free:\n\tvfree(ctx->cwksp);\n\tgoto out;\n}\n\nstatic int zstd_decomp_init(struct zstd_ctx *ctx)\n{\n\tint ret = 0;\n\tconst size_t wksp_size = zstd_dctx_workspace_bound();\n\n\tctx->dwksp = vzalloc(wksp_size);\n\tif (!ctx->dwksp) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tctx->dctx = zstd_init_dctx(ctx->dwksp, wksp_size);\n\tif (!ctx->dctx) {\n\t\tret = -EINVAL;\n\t\tgoto out_free;\n\t}\nout:\n\treturn ret;\nout_free:\n\tvfree(ctx->dwksp);\n\tgoto out;\n}\n\nstatic void zstd_comp_exit(struct zstd_ctx *ctx)\n{\n\tvfree(ctx->cwksp);\n\tctx->cwksp = NULL;\n\tctx->cctx = NULL;\n}\n\nstatic void zstd_decomp_exit(struct zstd_ctx *ctx)\n{\n\tvfree(ctx->dwksp);\n\tctx->dwksp = NULL;\n\tctx->dctx = NULL;\n}\n\nstatic int __zstd_init(void *ctx)\n{\n\tint ret;\n\n\tret = zstd_comp_init(ctx);\n\tif (ret)\n\t\treturn ret;\n\tret = zstd_decomp_init(ctx);\n\tif (ret)\n\t\tzstd_comp_exit(ctx);\n\treturn ret;\n}\n\nstatic void *zstd_alloc_ctx(struct crypto_scomp *tfm)\n{\n\tint ret;\n\tstruct zstd_ctx *ctx;\n\n\tctx = kzalloc(sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = __zstd_init(ctx);\n\tif (ret) {\n\t\tkfree(ctx);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn ctx;\n}\n\nstatic int zstd_init(struct crypto_tfm *tfm)\n{\n\tstruct zstd_ctx *ctx = crypto_tfm_ctx(tfm);\n\n\treturn __zstd_init(ctx);\n}\n\nstatic void __zstd_exit(void *ctx)\n{\n\tzstd_comp_exit(ctx);\n\tzstd_decomp_exit(ctx);\n}\n\nstatic void zstd_free_ctx(struct crypto_scomp *tfm, void *ctx)\n{\n\t__zstd_exit(ctx);\n\tkfree_sensitive(ctx);\n}\n\nstatic void zstd_exit(struct crypto_tfm *tfm)\n{\n\tstruct zstd_ctx *ctx = crypto_tfm_ctx(tfm);\n\n\t__zstd_exit(ctx);\n}\n\nstatic int __zstd_compress(const u8 *src, unsigned int slen,\n\t\t\t   u8 *dst, unsigned int *dlen, void *ctx)\n{\n\tsize_t out_len;\n\tstruct zstd_ctx *zctx = ctx;\n\tconst zstd_parameters params = zstd_params();\n\n\tout_len = zstd_compress_cctx(zctx->cctx, dst, *dlen, src, slen, &params);\n\tif (zstd_is_error(out_len))\n\t\treturn -EINVAL;\n\t*dlen = out_len;\n\treturn 0;\n}\n\nstatic int zstd_compress(struct crypto_tfm *tfm, const u8 *src,\n\t\t\t unsigned int slen, u8 *dst, unsigned int *dlen)\n{\n\tstruct zstd_ctx *ctx = crypto_tfm_ctx(tfm);\n\n\treturn __zstd_compress(src, slen, dst, dlen, ctx);\n}\n\nstatic int zstd_scompress(struct crypto_scomp *tfm, const u8 *src,\n\t\t\t  unsigned int slen, u8 *dst, unsigned int *dlen,\n\t\t\t  void *ctx)\n{\n\treturn __zstd_compress(src, slen, dst, dlen, ctx);\n}\n\nstatic int __zstd_decompress(const u8 *src, unsigned int slen,\n\t\t\t     u8 *dst, unsigned int *dlen, void *ctx)\n{\n\tsize_t out_len;\n\tstruct zstd_ctx *zctx = ctx;\n\n\tout_len = zstd_decompress_dctx(zctx->dctx, dst, *dlen, src, slen);\n\tif (zstd_is_error(out_len))\n\t\treturn -EINVAL;\n\t*dlen = out_len;\n\treturn 0;\n}\n\nstatic int zstd_decompress(struct crypto_tfm *tfm, const u8 *src,\n\t\t\t   unsigned int slen, u8 *dst, unsigned int *dlen)\n{\n\tstruct zstd_ctx *ctx = crypto_tfm_ctx(tfm);\n\n\treturn __zstd_decompress(src, slen, dst, dlen, ctx);\n}\n\nstatic int zstd_sdecompress(struct crypto_scomp *tfm, const u8 *src,\n\t\t\t    unsigned int slen, u8 *dst, unsigned int *dlen,\n\t\t\t    void *ctx)\n{\n\treturn __zstd_decompress(src, slen, dst, dlen, ctx);\n}\n\nstatic struct crypto_alg alg = {\n\t.cra_name\t\t= \"zstd\",\n\t.cra_driver_name\t= \"zstd-generic\",\n\t.cra_flags\t\t= CRYPTO_ALG_TYPE_COMPRESS,\n\t.cra_ctxsize\t\t= sizeof(struct zstd_ctx),\n\t.cra_module\t\t= THIS_MODULE,\n\t.cra_init\t\t= zstd_init,\n\t.cra_exit\t\t= zstd_exit,\n\t.cra_u\t\t\t= { .compress = {\n\t.coa_compress\t\t= zstd_compress,\n\t.coa_decompress\t\t= zstd_decompress } }\n};\n\nstatic struct scomp_alg scomp = {\n\t.alloc_ctx\t\t= zstd_alloc_ctx,\n\t.free_ctx\t\t= zstd_free_ctx,\n\t.compress\t\t= zstd_scompress,\n\t.decompress\t\t= zstd_sdecompress,\n\t.base\t\t\t= {\n\t\t.cra_name\t= \"zstd\",\n\t\t.cra_driver_name = \"zstd-scomp\",\n\t\t.cra_module\t = THIS_MODULE,\n\t}\n};\n\nstatic int __init zstd_mod_init(void)\n{\n\tint ret;\n\n\tret = crypto_register_alg(&alg);\n\tif (ret)\n\t\treturn ret;\n\n\tret = crypto_register_scomp(&scomp);\n\tif (ret)\n\t\tcrypto_unregister_alg(&alg);\n\n\treturn ret;\n}\n\nstatic void __exit zstd_mod_fini(void)\n{\n\tcrypto_unregister_alg(&alg);\n\tcrypto_unregister_scomp(&scomp);\n}\n\nsubsys_initcall(zstd_mod_init);\nmodule_exit(zstd_mod_fini);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Zstd Compression Algorithm\");\nMODULE_ALIAS_CRYPTO(\"zstd\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}