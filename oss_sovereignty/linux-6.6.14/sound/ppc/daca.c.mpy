{
  "module_name": "daca.c",
  "hash_id": "35ce43c19b4269f581abb4dd4f77fdf90e1e617788cea9bb7d21a5e6f1e91a7b",
  "original_prompt": "Ingested from linux-6.6.14/sound/ppc/daca.c",
  "human_readable_source": "\n \n\n\n#include <linux/init.h>\n#include <linux/i2c.h>\n#include <linux/kmod.h>\n#include <linux/slab.h>\n#include <sound/core.h>\n#include \"pmac.h\"\n\n \n#define DACA_I2C_ADDR\t0x4d\n\n \n#define DACA_REG_SR\t0x01\n#define DACA_REG_AVOL\t0x02\n#define DACA_REG_GCFG\t0x03\n\n \n#define DACA_VOL_MAX\t0x38\n\n\nstruct pmac_daca {\n\tstruct pmac_keywest i2c;\n\tint left_vol, right_vol;\n\tunsigned int deemphasis : 1;\n\tunsigned int amp_on : 1;\n};\n\n\n \nstatic int daca_init_client(struct pmac_keywest *i2c)\n{\n\tunsigned short wdata = 0x00;\n\t \n\t \n\tif (i2c_smbus_write_byte_data(i2c->client, DACA_REG_SR, 0x08) < 0 ||\n\t    i2c_smbus_write_byte_data(i2c->client, DACA_REG_GCFG, 0x05) < 0)\n\t\treturn -EINVAL;\n\treturn i2c_smbus_write_block_data(i2c->client, DACA_REG_AVOL,\n\t\t\t\t\t  2, (unsigned char*)&wdata);\n}\n\n \nstatic int daca_set_volume(struct pmac_daca *mix)\n{\n\tunsigned char data[2];\n  \n\tif (! mix->i2c.client)\n\t\treturn -ENODEV;\n  \n\tif (mix->left_vol > DACA_VOL_MAX)\n\t\tdata[0] = DACA_VOL_MAX;\n\telse\n\t\tdata[0] = mix->left_vol;\n\tif (mix->right_vol > DACA_VOL_MAX)\n\t\tdata[1] = DACA_VOL_MAX;\n\telse\n\t\tdata[1] = mix->right_vol;\n\tdata[1] |= mix->deemphasis ? 0x40 : 0;\n\tif (i2c_smbus_write_block_data(mix->i2c.client, DACA_REG_AVOL,\n\t\t\t\t       2, data) < 0) {\n\t\tsnd_printk(KERN_ERR \"failed to set volume \\n\");\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\n\n \n#define daca_info_deemphasis\t\tsnd_ctl_boolean_mono_info\n\nstatic int daca_get_deemphasis(struct snd_kcontrol *kcontrol,\n\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_pmac *chip = snd_kcontrol_chip(kcontrol);\n\tstruct pmac_daca *mix;\n\tmix = chip->mixer_data;\n\tif (!mix)\n\t\treturn -ENODEV;\n\tucontrol->value.integer.value[0] = mix->deemphasis ? 1 : 0;\n\treturn 0;\n}\n\nstatic int daca_put_deemphasis(struct snd_kcontrol *kcontrol,\n\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_pmac *chip = snd_kcontrol_chip(kcontrol);\n\tstruct pmac_daca *mix;\n\tint change;\n\n\tmix = chip->mixer_data;\n\tif (!mix)\n\t\treturn -ENODEV;\n\tchange = mix->deemphasis != ucontrol->value.integer.value[0];\n\tif (change) {\n\t\tmix->deemphasis = !!ucontrol->value.integer.value[0];\n\t\tdaca_set_volume(mix);\n\t}\n\treturn change;\n}\n\n \nstatic int daca_info_volume(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_info *uinfo)\n{\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\n\tuinfo->count = 2;\n\tuinfo->value.integer.min = 0;\n\tuinfo->value.integer.max = DACA_VOL_MAX;\n\treturn 0;\n}\n\nstatic int daca_get_volume(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_pmac *chip = snd_kcontrol_chip(kcontrol);\n\tstruct pmac_daca *mix;\n\tmix = chip->mixer_data;\n\tif (!mix)\n\t\treturn -ENODEV;\n\tucontrol->value.integer.value[0] = mix->left_vol;\n\tucontrol->value.integer.value[1] = mix->right_vol;\n\treturn 0;\n}\n\nstatic int daca_put_volume(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_pmac *chip = snd_kcontrol_chip(kcontrol);\n\tstruct pmac_daca *mix;\n\tunsigned int vol[2];\n\tint change;\n\n\tmix = chip->mixer_data;\n\tif (!mix)\n\t\treturn -ENODEV;\n\tvol[0] = ucontrol->value.integer.value[0];\n\tvol[1] = ucontrol->value.integer.value[1];\n\tif (vol[0] > DACA_VOL_MAX || vol[1] > DACA_VOL_MAX)\n\t\treturn -EINVAL;\n\tchange = mix->left_vol != vol[0] ||\n\t\tmix->right_vol != vol[1];\n\tif (change) {\n\t\tmix->left_vol = vol[0];\n\t\tmix->right_vol = vol[1];\n\t\tdaca_set_volume(mix);\n\t}\n\treturn change;\n}\n\n \n#define daca_info_amp\tdaca_info_deemphasis\n\nstatic int daca_get_amp(struct snd_kcontrol *kcontrol,\n\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_pmac *chip = snd_kcontrol_chip(kcontrol);\n\tstruct pmac_daca *mix;\n\tmix = chip->mixer_data;\n\tif (!mix)\n\t\treturn -ENODEV;\n\tucontrol->value.integer.value[0] = mix->amp_on ? 1 : 0;\n\treturn 0;\n}\n\nstatic int daca_put_amp(struct snd_kcontrol *kcontrol,\n\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_pmac *chip = snd_kcontrol_chip(kcontrol);\n\tstruct pmac_daca *mix;\n\tint change;\n\n\tmix = chip->mixer_data;\n\tif (!mix)\n\t\treturn -ENODEV;\n\tchange = mix->amp_on != ucontrol->value.integer.value[0];\n\tif (change) {\n\t\tmix->amp_on = !!ucontrol->value.integer.value[0];\n\t\ti2c_smbus_write_byte_data(mix->i2c.client, DACA_REG_GCFG,\n\t\t\t\t\t  mix->amp_on ? 0x05 : 0x04);\n\t}\n\treturn change;\n}\n\nstatic const struct snd_kcontrol_new daca_mixers[] = {\n\t{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER,\n\t  .name = \"Deemphasis Switch\",\n\t  .info = daca_info_deemphasis,\n\t  .get = daca_get_deemphasis,\n\t  .put = daca_put_deemphasis\n\t},\n\t{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER,\n\t  .name = \"Master Playback Volume\",\n\t  .info = daca_info_volume,\n\t  .get = daca_get_volume,\n\t  .put = daca_put_volume\n\t},\n\t{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER,\n\t  .name = \"Power Amplifier Switch\",\n\t  .info = daca_info_amp,\n\t  .get = daca_get_amp,\n\t  .put = daca_put_amp\n\t},\n};\n\n\n#ifdef CONFIG_PM\nstatic void daca_resume(struct snd_pmac *chip)\n{\n\tstruct pmac_daca *mix = chip->mixer_data;\n\ti2c_smbus_write_byte_data(mix->i2c.client, DACA_REG_SR, 0x08);\n\ti2c_smbus_write_byte_data(mix->i2c.client, DACA_REG_GCFG,\n\t\t\t\t  mix->amp_on ? 0x05 : 0x04);\n\tdaca_set_volume(mix);\n}\n#endif  \n\n\nstatic void daca_cleanup(struct snd_pmac *chip)\n{\n\tstruct pmac_daca *mix = chip->mixer_data;\n\tif (! mix)\n\t\treturn;\n\tsnd_pmac_keywest_cleanup(&mix->i2c);\n\tkfree(mix);\n\tchip->mixer_data = NULL;\n}\n\n \nint snd_pmac_daca_init(struct snd_pmac *chip)\n{\n\tint i, err;\n\tstruct pmac_daca *mix;\n\n\trequest_module(\"i2c-powermac\");\n\n\tmix = kzalloc(sizeof(*mix), GFP_KERNEL);\n\tif (! mix)\n\t\treturn -ENOMEM;\n\tchip->mixer_data = mix;\n\tchip->mixer_free = daca_cleanup;\n\tmix->amp_on = 1;  \n\n\tmix->i2c.addr = DACA_I2C_ADDR;\n\tmix->i2c.init_client = daca_init_client;\n\tmix->i2c.name = \"DACA\";\n\terr = snd_pmac_keywest_init(&mix->i2c);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\tstrcpy(chip->card->mixername, \"PowerMac DACA\");\n\n\tfor (i = 0; i < ARRAY_SIZE(daca_mixers); i++) {\n\t\terr = snd_ctl_add(chip->card, snd_ctl_new1(&daca_mixers[i], chip));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n#ifdef CONFIG_PM\n\tchip->resume = daca_resume;\n#endif\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}