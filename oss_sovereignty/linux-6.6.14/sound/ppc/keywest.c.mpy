{
  "module_name": "keywest.c",
  "hash_id": "621f47bc177872e6ec48541a6b4945d39f1e50d37d7d3c02a11010a736b0c118",
  "original_prompt": "Ingested from linux-6.6.14/sound/ppc/keywest.c",
  "human_readable_source": "\n \n\n\n#include <linux/init.h>\n#include <linux/i2c.h>\n#include <linux/delay.h>\n#include <linux/module.h>\n#include <sound/core.h>\n#include \"pmac.h\"\n\nstatic struct pmac_keywest *keywest_ctx;\nstatic bool keywest_probed;\n\nstatic int keywest_probe(struct i2c_client *client)\n{\n\tkeywest_probed = true;\n\t \n\tif (!keywest_ctx->client)\n\t\tkeywest_ctx->client = client;\n\ti2c_set_clientdata(client, keywest_ctx);\n\treturn 0;\n}\n\n \nstatic int keywest_attach_adapter(struct i2c_adapter *adapter)\n{\n\tstruct i2c_board_info info;\n\tstruct i2c_client *client;\n\n\tif (! keywest_ctx)\n\t\treturn -EINVAL;\n\n\tif (strncmp(adapter->name, \"mac-io\", 6))\n\t\treturn -EINVAL;  \n\n\tmemset(&info, 0, sizeof(struct i2c_board_info));\n\tstrscpy(info.type, \"keywest\", I2C_NAME_SIZE);\n\tinfo.addr = keywest_ctx->addr;\n\tclient = i2c_new_client_device(adapter, &info);\n\tif (IS_ERR(client))\n\t\treturn PTR_ERR(client);\n\tkeywest_ctx->client = client;\n\n\t \n\tif (!keywest_ctx->client->dev.driver) {\n\t\ti2c_unregister_device(keywest_ctx->client);\n\t\tkeywest_ctx->client = NULL;\n\t\treturn -ENODEV;\n\t}\n\t\n\t \n\tlist_add_tail(&keywest_ctx->client->detected,\n\t\t      &to_i2c_driver(keywest_ctx->client->dev.driver)->clients);\n\treturn 0;\n}\n\nstatic void keywest_remove(struct i2c_client *client)\n{\n\tif (! keywest_ctx)\n\t\treturn;\n\tif (client == keywest_ctx->client)\n\t\tkeywest_ctx->client = NULL;\n}\n\n\nstatic const struct i2c_device_id keywest_i2c_id[] = {\n\t{ \"MAC,tas3004\", 0 },\t\t \n\t{ \"keywest\", 0 },\t\t \n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, keywest_i2c_id);\n\nstatic struct i2c_driver keywest_driver = {\n\t.driver = {\n\t\t.name = \"PMac Keywest Audio\",\n\t},\n\t.probe = keywest_probe,\n\t.remove = keywest_remove,\n\t.id_table = keywest_i2c_id,\n};\n\n \nvoid snd_pmac_keywest_cleanup(struct pmac_keywest *i2c)\n{\n\tif (keywest_ctx && keywest_ctx == i2c) {\n\t\ti2c_del_driver(&keywest_driver);\n\t\tkeywest_ctx = NULL;\n\t}\n}\n\nint snd_pmac_tumbler_post_init(void)\n{\n\tint err;\n\t\n\tif (!keywest_ctx || !keywest_ctx->client)\n\t\treturn -ENXIO;\n\n\terr = keywest_ctx->init_client(keywest_ctx);\n\tif (err < 0) {\n\t\tsnd_printk(KERN_ERR \"tumbler: %i :cannot initialize the MCS\\n\", err);\n\t\treturn err;\n\t}\n\treturn 0;\n}\n\n \nint snd_pmac_keywest_init(struct pmac_keywest *i2c)\n{\n\tstruct i2c_adapter *adap;\n\tint err, i = 0;\n\n\tif (keywest_ctx)\n\t\treturn -EBUSY;\n\n\tadap = i2c_get_adapter(0);\n\tif (!adap)\n\t\treturn -EPROBE_DEFER;\n\n\tkeywest_ctx = i2c;\n\n\terr = i2c_add_driver(&keywest_driver);\n\tif (err) {\n\t\tsnd_printk(KERN_ERR \"cannot register keywest i2c driver\\n\");\n\t\ti2c_put_adapter(adap);\n\t\treturn err;\n\t}\n\n\t \n\tif (keywest_probed)\n\t\treturn 0;\n\n\t \n\twhile (adap) {\n\t\t \n\t\terr = keywest_attach_adapter(adap);\n\t\tif (!err)\n\t\t\treturn 0;\n\t\ti2c_put_adapter(adap);\n\t\tadap = i2c_get_adapter(++i);\n\t}\n\n\treturn -ENODEV;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}