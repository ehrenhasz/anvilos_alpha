{
  "module_name": "virtio_chmap.c",
  "hash_id": "dc9f92c6c176dba2f7ab8cfe42cac40d727c4315cd04b8222e5d5db17a4b464a",
  "original_prompt": "Ingested from linux-6.6.14/sound/virtio/virtio_chmap.c",
  "human_readable_source": "\n \n#include <linux/virtio_config.h>\n\n#include \"virtio_card.h\"\n\n \nstatic const u8 g_v2a_position_map[] = {\n\t[VIRTIO_SND_CHMAP_NONE] = SNDRV_CHMAP_UNKNOWN,\n\t[VIRTIO_SND_CHMAP_NA] = SNDRV_CHMAP_NA,\n\t[VIRTIO_SND_CHMAP_MONO] = SNDRV_CHMAP_MONO,\n\t[VIRTIO_SND_CHMAP_FL] = SNDRV_CHMAP_FL,\n\t[VIRTIO_SND_CHMAP_FR] = SNDRV_CHMAP_FR,\n\t[VIRTIO_SND_CHMAP_RL] = SNDRV_CHMAP_RL,\n\t[VIRTIO_SND_CHMAP_RR] = SNDRV_CHMAP_RR,\n\t[VIRTIO_SND_CHMAP_FC] = SNDRV_CHMAP_FC,\n\t[VIRTIO_SND_CHMAP_LFE] = SNDRV_CHMAP_LFE,\n\t[VIRTIO_SND_CHMAP_SL] = SNDRV_CHMAP_SL,\n\t[VIRTIO_SND_CHMAP_SR] = SNDRV_CHMAP_SR,\n\t[VIRTIO_SND_CHMAP_RC] = SNDRV_CHMAP_RC,\n\t[VIRTIO_SND_CHMAP_FLC] = SNDRV_CHMAP_FLC,\n\t[VIRTIO_SND_CHMAP_FRC] = SNDRV_CHMAP_FRC,\n\t[VIRTIO_SND_CHMAP_RLC] = SNDRV_CHMAP_RLC,\n\t[VIRTIO_SND_CHMAP_RRC] = SNDRV_CHMAP_RRC,\n\t[VIRTIO_SND_CHMAP_FLW] = SNDRV_CHMAP_FLW,\n\t[VIRTIO_SND_CHMAP_FRW] = SNDRV_CHMAP_FRW,\n\t[VIRTIO_SND_CHMAP_FLH] = SNDRV_CHMAP_FLH,\n\t[VIRTIO_SND_CHMAP_FCH] = SNDRV_CHMAP_FCH,\n\t[VIRTIO_SND_CHMAP_FRH] = SNDRV_CHMAP_FRH,\n\t[VIRTIO_SND_CHMAP_TC] = SNDRV_CHMAP_TC,\n\t[VIRTIO_SND_CHMAP_TFL] = SNDRV_CHMAP_TFL,\n\t[VIRTIO_SND_CHMAP_TFR] = SNDRV_CHMAP_TFR,\n\t[VIRTIO_SND_CHMAP_TFC] = SNDRV_CHMAP_TFC,\n\t[VIRTIO_SND_CHMAP_TRL] = SNDRV_CHMAP_TRL,\n\t[VIRTIO_SND_CHMAP_TRR] = SNDRV_CHMAP_TRR,\n\t[VIRTIO_SND_CHMAP_TRC] = SNDRV_CHMAP_TRC,\n\t[VIRTIO_SND_CHMAP_TFLC] = SNDRV_CHMAP_TFLC,\n\t[VIRTIO_SND_CHMAP_TFRC] = SNDRV_CHMAP_TFRC,\n\t[VIRTIO_SND_CHMAP_TSL] = SNDRV_CHMAP_TSL,\n\t[VIRTIO_SND_CHMAP_TSR] = SNDRV_CHMAP_TSR,\n\t[VIRTIO_SND_CHMAP_LLFE] = SNDRV_CHMAP_LLFE,\n\t[VIRTIO_SND_CHMAP_RLFE] = SNDRV_CHMAP_RLFE,\n\t[VIRTIO_SND_CHMAP_BC] = SNDRV_CHMAP_BC,\n\t[VIRTIO_SND_CHMAP_BLC] = SNDRV_CHMAP_BLC,\n\t[VIRTIO_SND_CHMAP_BRC] = SNDRV_CHMAP_BRC\n};\n\n \nint virtsnd_chmap_parse_cfg(struct virtio_snd *snd)\n{\n\tstruct virtio_device *vdev = snd->vdev;\n\tu32 i;\n\tint rc;\n\n\tvirtio_cread_le(vdev, struct virtio_snd_config, chmaps, &snd->nchmaps);\n\tif (!snd->nchmaps)\n\t\treturn 0;\n\n\tsnd->chmaps = devm_kcalloc(&vdev->dev, snd->nchmaps,\n\t\t\t\t   sizeof(*snd->chmaps), GFP_KERNEL);\n\tif (!snd->chmaps)\n\t\treturn -ENOMEM;\n\n\trc = virtsnd_ctl_query_info(snd, VIRTIO_SND_R_CHMAP_INFO, 0,\n\t\t\t\t    snd->nchmaps, sizeof(*snd->chmaps),\n\t\t\t\t    snd->chmaps);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\tfor (i = 0; i < snd->nchmaps; ++i) {\n\t\tstruct virtio_snd_chmap_info *info = &snd->chmaps[i];\n\t\tu32 nid = le32_to_cpu(info->hdr.hda_fn_nid);\n\t\tstruct virtio_pcm *vpcm;\n\t\tstruct virtio_pcm_stream *vs;\n\n\t\tvpcm = virtsnd_pcm_find_or_create(snd, nid);\n\t\tif (IS_ERR(vpcm))\n\t\t\treturn PTR_ERR(vpcm);\n\n\t\tswitch (info->direction) {\n\t\tcase VIRTIO_SND_D_OUTPUT:\n\t\t\tvs = &vpcm->streams[SNDRV_PCM_STREAM_PLAYBACK];\n\t\t\tbreak;\n\t\tcase VIRTIO_SND_D_INPUT:\n\t\t\tvs = &vpcm->streams[SNDRV_PCM_STREAM_CAPTURE];\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(&vdev->dev,\n\t\t\t\t\"chmap #%u: unknown direction (%u)\\n\", i,\n\t\t\t\tinfo->direction);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tvs->nchmaps++;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int virtsnd_chmap_add_ctls(struct snd_pcm *pcm, int direction,\n\t\t\t\t  struct virtio_pcm_stream *vs)\n{\n\tu32 i;\n\tint max_channels = 0;\n\n\tfor (i = 0; i < vs->nchmaps; i++)\n\t\tif (max_channels < vs->chmaps[i].channels)\n\t\t\tmax_channels = vs->chmaps[i].channels;\n\n\treturn snd_pcm_add_chmap_ctls(pcm, direction, vs->chmaps, max_channels,\n\t\t\t\t      0, NULL);\n}\n\n \nint virtsnd_chmap_build_devs(struct virtio_snd *snd)\n{\n\tstruct virtio_device *vdev = snd->vdev;\n\tstruct virtio_pcm *vpcm;\n\tstruct virtio_pcm_stream *vs;\n\tu32 i;\n\tint rc;\n\n\t \n\tlist_for_each_entry(vpcm, &snd->pcm_list, list) {\n\t\tfor (i = 0; i < ARRAY_SIZE(vpcm->streams); ++i) {\n\t\t\tvs = &vpcm->streams[i];\n\n\t\t\tif (!vs->nchmaps)\n\t\t\t\tcontinue;\n\n\t\t\tvs->chmaps = devm_kcalloc(&vdev->dev, vs->nchmaps + 1,\n\t\t\t\t\t\t  sizeof(*vs->chmaps),\n\t\t\t\t\t\t  GFP_KERNEL);\n\t\t\tif (!vs->chmaps)\n\t\t\t\treturn -ENOMEM;\n\n\t\t\tvs->nchmaps = 0;\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < snd->nchmaps; ++i) {\n\t\tstruct virtio_snd_chmap_info *info = &snd->chmaps[i];\n\t\tunsigned int channels = info->channels;\n\t\tunsigned int ch;\n\t\tstruct snd_pcm_chmap_elem *chmap;\n\n\t\tvpcm = virtsnd_pcm_find(snd, le32_to_cpu(info->hdr.hda_fn_nid));\n\t\tif (IS_ERR(vpcm))\n\t\t\treturn PTR_ERR(vpcm);\n\n\t\tif (info->direction == VIRTIO_SND_D_OUTPUT)\n\t\t\tvs = &vpcm->streams[SNDRV_PCM_STREAM_PLAYBACK];\n\t\telse\n\t\t\tvs = &vpcm->streams[SNDRV_PCM_STREAM_CAPTURE];\n\n\t\tchmap = &vs->chmaps[vs->nchmaps++];\n\n\t\tif (channels > ARRAY_SIZE(chmap->map))\n\t\t\tchannels = ARRAY_SIZE(chmap->map);\n\n\t\tchmap->channels = channels;\n\n\t\tfor (ch = 0; ch < channels; ++ch) {\n\t\t\tu8 position = info->positions[ch];\n\n\t\t\tif (position >= ARRAY_SIZE(g_v2a_position_map))\n\t\t\t\treturn -EINVAL;\n\n\t\t\tchmap->map[ch] = g_v2a_position_map[position];\n\t\t}\n\t}\n\n\t \n\tlist_for_each_entry(vpcm, &snd->pcm_list, list) {\n\t\tif (!vpcm->pcm)\n\t\t\tcontinue;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(vpcm->streams); ++i) {\n\t\t\tvs = &vpcm->streams[i];\n\n\t\t\tif (!vs->nchmaps)\n\t\t\t\tcontinue;\n\n\t\t\trc = virtsnd_chmap_add_ctls(vpcm->pcm, i, vs);\n\t\t\tif (rc)\n\t\t\t\treturn rc;\n\t\t}\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}