{
  "module_name": "virtio_jack.c",
  "hash_id": "280aee7a1e0f41daad446e279b7960aac7128058a10ea5dcedb2d375ed375935",
  "original_prompt": "Ingested from linux-6.6.14/sound/virtio/virtio_jack.c",
  "human_readable_source": "\n \n#include <linux/virtio_config.h>\n#include <sound/jack.h>\n#include <sound/hda_verbs.h>\n\n#include \"virtio_card.h\"\n\n \n\n \nstruct virtio_jack {\n\tstruct snd_jack *jack;\n\tu32 nid;\n\tu32 features;\n\tu32 defconf;\n\tu32 caps;\n\tbool connected;\n\tint type;\n};\n\n \nstatic const char *virtsnd_jack_get_label(struct virtio_jack *vjack)\n{\n\tunsigned int defconf = vjack->defconf;\n\tunsigned int device =\n\t\t(defconf & AC_DEFCFG_DEVICE) >> AC_DEFCFG_DEVICE_SHIFT;\n\tunsigned int location =\n\t\t(defconf & AC_DEFCFG_LOCATION) >> AC_DEFCFG_LOCATION_SHIFT;\n\n\tswitch (device) {\n\tcase AC_JACK_LINE_OUT:\n\t\treturn \"Line Out\";\n\tcase AC_JACK_SPEAKER:\n\t\treturn \"Speaker\";\n\tcase AC_JACK_HP_OUT:\n\t\treturn \"Headphone\";\n\tcase AC_JACK_CD:\n\t\treturn \"CD\";\n\tcase AC_JACK_SPDIF_OUT:\n\tcase AC_JACK_DIG_OTHER_OUT:\n\t\tif (location == AC_JACK_LOC_HDMI)\n\t\t\treturn \"HDMI Out\";\n\t\telse\n\t\t\treturn \"SPDIF Out\";\n\tcase AC_JACK_LINE_IN:\n\t\treturn \"Line\";\n\tcase AC_JACK_AUX:\n\t\treturn \"Aux\";\n\tcase AC_JACK_MIC_IN:\n\t\treturn \"Mic\";\n\tcase AC_JACK_SPDIF_IN:\n\t\treturn \"SPDIF In\";\n\tcase AC_JACK_DIG_OTHER_IN:\n\t\treturn \"Digital In\";\n\tdefault:\n\t\treturn \"Misc\";\n\t}\n}\n\n \nstatic int virtsnd_jack_get_type(struct virtio_jack *vjack)\n{\n\tunsigned int defconf = vjack->defconf;\n\tunsigned int device =\n\t\t(defconf & AC_DEFCFG_DEVICE) >> AC_DEFCFG_DEVICE_SHIFT;\n\n\tswitch (device) {\n\tcase AC_JACK_LINE_OUT:\n\tcase AC_JACK_SPEAKER:\n\t\treturn SND_JACK_LINEOUT;\n\tcase AC_JACK_HP_OUT:\n\t\treturn SND_JACK_HEADPHONE;\n\tcase AC_JACK_SPDIF_OUT:\n\tcase AC_JACK_DIG_OTHER_OUT:\n\t\treturn SND_JACK_AVOUT;\n\tcase AC_JACK_MIC_IN:\n\t\treturn SND_JACK_MICROPHONE;\n\tdefault:\n\t\treturn SND_JACK_LINEIN;\n\t}\n}\n\n \nint virtsnd_jack_parse_cfg(struct virtio_snd *snd)\n{\n\tstruct virtio_device *vdev = snd->vdev;\n\tstruct virtio_snd_jack_info *info;\n\tu32 i;\n\tint rc;\n\n\tvirtio_cread_le(vdev, struct virtio_snd_config, jacks, &snd->njacks);\n\tif (!snd->njacks)\n\t\treturn 0;\n\n\tsnd->jacks = devm_kcalloc(&vdev->dev, snd->njacks, sizeof(*snd->jacks),\n\t\t\t\t  GFP_KERNEL);\n\tif (!snd->jacks)\n\t\treturn -ENOMEM;\n\n\tinfo = kcalloc(snd->njacks, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\trc = virtsnd_ctl_query_info(snd, VIRTIO_SND_R_JACK_INFO, 0, snd->njacks,\n\t\t\t\t    sizeof(*info), info);\n\tif (rc)\n\t\tgoto on_exit;\n\n\tfor (i = 0; i < snd->njacks; ++i) {\n\t\tstruct virtio_jack *vjack = &snd->jacks[i];\n\n\t\tvjack->nid = le32_to_cpu(info[i].hdr.hda_fn_nid);\n\t\tvjack->features = le32_to_cpu(info[i].features);\n\t\tvjack->defconf = le32_to_cpu(info[i].hda_reg_defconf);\n\t\tvjack->caps = le32_to_cpu(info[i].hda_reg_caps);\n\t\tvjack->connected = info[i].connected;\n\t}\n\non_exit:\n\tkfree(info);\n\n\treturn rc;\n}\n\n \nint virtsnd_jack_build_devs(struct virtio_snd *snd)\n{\n\tu32 i;\n\tint rc;\n\n\tfor (i = 0; i < snd->njacks; ++i) {\n\t\tstruct virtio_jack *vjack = &snd->jacks[i];\n\n\t\tvjack->type = virtsnd_jack_get_type(vjack);\n\n\t\trc = snd_jack_new(snd->card, virtsnd_jack_get_label(vjack),\n\t\t\t\t  vjack->type, &vjack->jack, true, true);\n\t\tif (rc)\n\t\t\treturn rc;\n\n\t\tif (vjack->jack)\n\t\t\tvjack->jack->private_data = vjack;\n\n\t\tsnd_jack_report(vjack->jack,\n\t\t\t\tvjack->connected ? vjack->type : 0);\n\t}\n\n\treturn 0;\n}\n\n \nvoid virtsnd_jack_event(struct virtio_snd *snd, struct virtio_snd_event *event)\n{\n\tu32 jack_id = le32_to_cpu(event->data);\n\tstruct virtio_jack *vjack;\n\n\tif (jack_id >= snd->njacks)\n\t\treturn;\n\n\tvjack = &snd->jacks[jack_id];\n\n\tswitch (le32_to_cpu(event->hdr.code)) {\n\tcase VIRTIO_SND_EVT_JACK_CONNECTED:\n\t\tvjack->connected = true;\n\t\tbreak;\n\tcase VIRTIO_SND_EVT_JACK_DISCONNECTED:\n\t\tvjack->connected = false;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tsnd_jack_report(vjack->jack, vjack->connected ? vjack->type : 0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}