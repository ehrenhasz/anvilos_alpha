{
  "module_name": "control.c",
  "hash_id": "5bf1b1ccd1ec077981304bad73022dde887519f28bfaaf2daa89c6e1d421f684",
  "original_prompt": "Ingested from linux-6.6.14/sound/aoa/soundbus/i2sbus/control.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n\n#include <asm/prom.h>\n#include <asm/macio.h>\n#include <asm/pmac_feature.h>\n#include <asm/pmac_pfunc.h>\n#include <asm/keylargo.h>\n\n#include \"i2sbus.h\"\n\nint i2sbus_control_init(struct macio_dev* dev, struct i2sbus_control **c)\n{\n\t*c = kzalloc(sizeof(struct i2sbus_control), GFP_KERNEL);\n\tif (!*c)\n\t\treturn -ENOMEM;\n\n\tINIT_LIST_HEAD(&(*c)->list);\n\n\t(*c)->macio = dev->bus->chip;\n\treturn 0;\n}\n\nvoid i2sbus_control_destroy(struct i2sbus_control *c)\n{\n\tkfree(c);\n}\n\n \nint i2sbus_control_add_dev(struct i2sbus_control *c,\n\t\t\t   struct i2sbus_dev *i2sdev)\n{\n\tstruct device_node *np;\n\n\tnp = i2sdev->sound.ofdev.dev.of_node;\n\ti2sdev->enable = pmf_find_function(np, \"enable\");\n\ti2sdev->cell_enable = pmf_find_function(np, \"cell-enable\");\n\ti2sdev->clock_enable = pmf_find_function(np, \"clock-enable\");\n\ti2sdev->cell_disable = pmf_find_function(np, \"cell-disable\");\n\ti2sdev->clock_disable = pmf_find_function(np, \"clock-disable\");\n\n\t \n\tif (i2sdev->bus_number != 0 && i2sdev->bus_number != 1 &&\n\t    (!i2sdev->enable ||\n\t     !i2sdev->cell_enable || !i2sdev->clock_enable ||\n\t     !i2sdev->cell_disable || !i2sdev->clock_disable)) {\n\t\tpmf_put_function(i2sdev->enable);\n\t\tpmf_put_function(i2sdev->cell_enable);\n\t\tpmf_put_function(i2sdev->clock_enable);\n\t\tpmf_put_function(i2sdev->cell_disable);\n\t\tpmf_put_function(i2sdev->clock_disable);\n\t\treturn -ENODEV;\n\t}\n\n\tlist_add(&i2sdev->item, &c->list);\n\n\treturn 0;\n}\n\nvoid i2sbus_control_remove_dev(struct i2sbus_control *c,\n\t\t\t       struct i2sbus_dev *i2sdev)\n{\n\t \n\tlist_del(&i2sdev->item);\n\tif (list_empty(&c->list))\n\t\ti2sbus_control_destroy(c);\n}\n\nint i2sbus_control_enable(struct i2sbus_control *c,\n\t\t\t  struct i2sbus_dev *i2sdev)\n{\n\tstruct pmf_args args = { .count = 0 };\n\tstruct macio_chip *macio = c->macio;\n\n\tif (i2sdev->enable)\n\t\treturn pmf_call_one(i2sdev->enable, &args);\n\n\tif (macio == NULL || macio->base == NULL)\n\t\treturn -ENODEV;\n\n\tswitch (i2sdev->bus_number) {\n\tcase 0:\n\t\t \n\t\tMACIO_BIS(KEYLARGO_FCR1, KL1_I2S0_ENABLE);\n\t\tbreak;\n\tcase 1:\n\t\tMACIO_BIS(KEYLARGO_FCR1, KL1_I2S1_ENABLE);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\n\nint i2sbus_control_cell(struct i2sbus_control *c,\n\t\t\tstruct i2sbus_dev *i2sdev,\n\t\t\tint enable)\n{\n\tstruct pmf_args args = { .count = 0 };\n\tstruct macio_chip *macio = c->macio;\n\n\tswitch (enable) {\n\tcase 0:\n\t\tif (i2sdev->cell_disable)\n\t\t\treturn pmf_call_one(i2sdev->cell_disable, &args);\n\t\tbreak;\n\tcase 1:\n\t\tif (i2sdev->cell_enable)\n\t\t\treturn pmf_call_one(i2sdev->cell_enable, &args);\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_ERR \"i2sbus: INVALID CELL ENABLE VALUE\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (macio == NULL || macio->base == NULL)\n\t\treturn -ENODEV;\n\n\tswitch (i2sdev->bus_number) {\n\tcase 0:\n\t\tif (enable)\n\t\t\tMACIO_BIS(KEYLARGO_FCR1, KL1_I2S0_CELL_ENABLE);\n\t\telse\n\t\t\tMACIO_BIC(KEYLARGO_FCR1, KL1_I2S0_CELL_ENABLE);\n\t\tbreak;\n\tcase 1:\n\t\tif (enable)\n\t\t\tMACIO_BIS(KEYLARGO_FCR1, KL1_I2S1_CELL_ENABLE);\n\t\telse\n\t\t\tMACIO_BIC(KEYLARGO_FCR1, KL1_I2S1_CELL_ENABLE);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\n\nint i2sbus_control_clock(struct i2sbus_control *c,\n\t\t\t struct i2sbus_dev *i2sdev,\n\t\t\t int enable)\n{\n\tstruct pmf_args args = { .count = 0 };\n\tstruct macio_chip *macio = c->macio;\n\n\tswitch (enable) {\n\tcase 0:\n\t\tif (i2sdev->clock_disable)\n\t\t\treturn pmf_call_one(i2sdev->clock_disable, &args);\n\t\tbreak;\n\tcase 1:\n\t\tif (i2sdev->clock_enable)\n\t\t\treturn pmf_call_one(i2sdev->clock_enable, &args);\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_ERR \"i2sbus: INVALID CLOCK ENABLE VALUE\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (macio == NULL || macio->base == NULL)\n\t\treturn -ENODEV;\n\n\tswitch (i2sdev->bus_number) {\n\tcase 0:\n\t\tif (enable)\n\t\t\tMACIO_BIS(KEYLARGO_FCR1, KL1_I2S0_CLK_ENABLE_BIT);\n\t\telse\n\t\t\tMACIO_BIC(KEYLARGO_FCR1, KL1_I2S0_CLK_ENABLE_BIT);\n\t\tbreak;\n\tcase 1:\n\t\tif (enable)\n\t\t\tMACIO_BIS(KEYLARGO_FCR1, KL1_I2S1_CLK_ENABLE_BIT);\n\t\telse\n\t\t\tMACIO_BIC(KEYLARGO_FCR1, KL1_I2S1_CLK_ENABLE_BIT);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}