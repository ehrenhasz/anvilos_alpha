{
  "module_name": "motu-command-dsp-message-parser.c",
  "hash_id": "3374a5ff9834b78848eb4c52f7d24f5140720eb3b9aee1fee5d36368e657acdd",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/motu/motu-command-dsp-message-parser.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n#include \"motu.h\"\n\nenum msg_parser_state {\n\tINITIALIZED,\n\tFRAGMENT_DETECTED,\n\tAVAILABLE,\n};\n\nstruct msg_parser {\n\tspinlock_t lock;\n\tenum msg_parser_state state;\n\tunsigned int interval;\n\tunsigned int message_count;\n\tunsigned int fragment_pos;\n\tunsigned int value_index;\n\tu64 value;\n\tstruct snd_firewire_motu_command_dsp_meter meter;\n};\n\nint snd_motu_command_dsp_message_parser_new(struct snd_motu *motu)\n{\n\tstruct msg_parser *parser;\n\n\tparser = devm_kzalloc(&motu->card->card_dev, sizeof(*parser), GFP_KERNEL);\n\tif (!parser)\n\t\treturn -ENOMEM;\n\tspin_lock_init(&parser->lock);\n\tmotu->message_parser = parser;\n\n\treturn 0;\n}\n\nint snd_motu_command_dsp_message_parser_init(struct snd_motu *motu, enum cip_sfc sfc)\n{\n\tstruct msg_parser *parser = motu->message_parser;\n\n\tparser->state = INITIALIZED;\n\n\t\n\tswitch (sfc) {\n\tcase CIP_SFC_176400:\n\tcase CIP_SFC_192000:\n\t\tparser->interval = 4;\n\t\tbreak;\n\tcase CIP_SFC_88200:\n\tcase CIP_SFC_96000:\n\t\tparser->interval = 2;\n\t\tbreak;\n\tcase CIP_SFC_32000:\n\tcase CIP_SFC_44100:\n\tcase CIP_SFC_48000:\n\tdefault:\n\t\tparser->interval = 1;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n#define FRAGMENT_POS\t\t\t6\n#define MIDI_BYTE_POS\t\t\t7\n#define MIDI_FLAG_POS\t\t\t8\n\n#define FRAGMENTS_PER_VALUE\t\t4\n#define VALUES_AT_IMAGE_END\t\t0xffffffffffffffff\n\nvoid snd_motu_command_dsp_message_parser_parse(const struct amdtp_stream *s,\n\t\t\t\t\tconst struct pkt_desc *desc, unsigned int count)\n{\n\tstruct snd_motu *motu = container_of(s, struct snd_motu, tx_stream);\n\tunsigned int data_block_quadlets = s->data_block_quadlets;\n\tstruct msg_parser *parser = motu->message_parser;\n\tunsigned int interval = parser->interval;\n\tunsigned long flags;\n\tint i;\n\n\tspin_lock_irqsave(&parser->lock, flags);\n\n\tfor (i = 0; i < count; ++i) {\n\t\t__be32 *buffer = desc->ctx_payload;\n\t\tunsigned int data_blocks = desc->data_blocks;\n\t\tint j;\n\n\t\tdesc = amdtp_stream_next_packet_desc(s, desc);\n\n\t\tfor (j = 0; j < data_blocks; ++j) {\n\t\t\tu8 *b = (u8 *)buffer;\n\t\t\tbuffer += data_block_quadlets;\n\n\t\t\tswitch (parser->state) {\n\t\t\tcase INITIALIZED:\n\t\t\t{\n\t\t\t\tu8 fragment = b[FRAGMENT_POS];\n\n\t\t\t\tif (fragment > 0) {\n\t\t\t\t\tparser->value = fragment;\n\t\t\t\t\tparser->message_count = 1;\n\t\t\t\t\tparser->state = FRAGMENT_DETECTED;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase FRAGMENT_DETECTED:\n\t\t\t{\n\t\t\t\tif (parser->message_count % interval == 0) {\n\t\t\t\t\tu8 fragment = b[FRAGMENT_POS];\n\n\t\t\t\t\tparser->value >>= 8;\n\t\t\t\t\tparser->value |= (u64)fragment << 56;\n\n\t\t\t\t\tif (parser->value == VALUES_AT_IMAGE_END) {\n\t\t\t\t\t\tparser->state = AVAILABLE;\n\t\t\t\t\t\tparser->fragment_pos = 0;\n\t\t\t\t\t\tparser->value_index = 0;\n\t\t\t\t\t\tparser->message_count = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t++parser->message_count;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase AVAILABLE:\n\t\t\tdefault:\n\t\t\t{\n\t\t\t\tif (parser->message_count % interval == 0) {\n\t\t\t\t\tu8 fragment = b[FRAGMENT_POS];\n\n\t\t\t\t\tparser->value >>= 8;\n\t\t\t\t\tparser->value |= (u64)fragment << 56;\n\t\t\t\t\t++parser->fragment_pos;\n\n\t\t\t\t\tif (parser->fragment_pos == 4) {\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (parser->value_index <\n\t\t\t\t\t\t    SNDRV_FIREWIRE_MOTU_COMMAND_DSP_METER_COUNT - 2) {\n\t\t\t\t\t\t\tu32 val = (u32)(parser->value >> 32);\n\t\t\t\t\t\t\tparser->meter.data[parser->value_index] = val;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t++parser->value_index;\n\t\t\t\t\t\tparser->fragment_pos = 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (parser->value == VALUES_AT_IMAGE_END) {\n\t\t\t\t\t\tparser->value_index = 0;\n\t\t\t\t\t\tparser->fragment_pos = 0;\n\t\t\t\t\t\tparser->message_count = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t++parser->message_count;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tspin_unlock_irqrestore(&parser->lock, flags);\n}\n\nvoid snd_motu_command_dsp_message_parser_copy_meter(struct snd_motu *motu,\n\t\t\t\t\tstruct snd_firewire_motu_command_dsp_meter *meter)\n{\n\tstruct msg_parser *parser = motu->message_parser;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&parser->lock, flags);\n\tmemcpy(meter, &parser->meter, sizeof(*meter));\n\tspin_unlock_irqrestore(&parser->lock, flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}