{
  "module_name": "motu.c",
  "hash_id": "3a5ccb567a8c79418f8aaf76e02d4dc7c0866f3324ded9e5b2397ef206b85dfd",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/motu/motu.c",
  "human_readable_source": "\n \n\n#include \"motu.h\"\n\n#define OUI_MOTU\t0x0001f2\n\nMODULE_DESCRIPTION(\"MOTU FireWire driver\");\nMODULE_AUTHOR(\"Takashi Sakamoto <o-takashi@sakamocchi.jp>\");\nMODULE_LICENSE(\"GPL\");\n\nconst unsigned int snd_motu_clock_rates[SND_MOTU_CLOCK_RATE_COUNT] = {\n\t \n\t[0] =  44100,\n\t[1] =  48000,\n\t \n\t[2] =  88200,\n\t[3] =  96000,\n\t \n\t[4] = 176400,\n\t[5] = 192000,\n};\n\nstatic void name_card(struct snd_motu *motu)\n{\n\tstruct fw_device *fw_dev = fw_parent_device(motu->unit);\n\tstruct fw_csr_iterator it;\n\tint key, val;\n\tu32 version = 0;\n\n\tfw_csr_iterator_init(&it, motu->unit->directory);\n\twhile (fw_csr_iterator_next(&it, &key, &val)) {\n\t\tswitch (key) {\n\t\tcase CSR_MODEL:\n\t\t\tversion = val;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tstrcpy(motu->card->driver, \"FW-MOTU\");\n\tstrcpy(motu->card->shortname, motu->spec->name);\n\tstrcpy(motu->card->mixername, motu->spec->name);\n\tsnprintf(motu->card->longname, sizeof(motu->card->longname),\n\t\t \"MOTU %s (version:%06x), GUID %08x%08x at %s, S%d\",\n\t\t motu->spec->name, version,\n\t\t fw_dev->config_rom[3], fw_dev->config_rom[4],\n\t\t dev_name(&motu->unit->device), 100 << fw_dev->max_speed);\n}\n\nstatic void motu_card_free(struct snd_card *card)\n{\n\tstruct snd_motu *motu = card->private_data;\n\n\tsnd_motu_transaction_unregister(motu);\n\tsnd_motu_stream_destroy_duplex(motu);\n\n\tmutex_destroy(&motu->mutex);\n\tfw_unit_put(motu->unit);\n}\n\nstatic int motu_probe(struct fw_unit *unit, const struct ieee1394_device_id *entry)\n{\n\tstruct snd_card *card;\n\tstruct snd_motu *motu;\n\tint err;\n\n\terr = snd_card_new(&unit->device, -1, NULL, THIS_MODULE, sizeof(*motu), &card);\n\tif (err < 0)\n\t\treturn err;\n\tcard->private_free = motu_card_free;\n\n\tmotu = card->private_data;\n\tmotu->unit = fw_unit_get(unit);\n\tdev_set_drvdata(&unit->device, motu);\n\tmotu->card = card;\n\n\tmotu->spec = (const struct snd_motu_spec *)entry->driver_data;\n\tmutex_init(&motu->mutex);\n\tspin_lock_init(&motu->lock);\n\tinit_waitqueue_head(&motu->hwdep_wait);\n\n\tname_card(motu);\n\n\terr = snd_motu_transaction_register(motu);\n\tif (err < 0)\n\t\tgoto error;\n\n\terr = snd_motu_stream_init_duplex(motu);\n\tif (err < 0)\n\t\tgoto error;\n\n\tsnd_motu_proc_init(motu);\n\n\terr = snd_motu_create_pcm_devices(motu);\n\tif (err < 0)\n\t\tgoto error;\n\n\tif ((motu->spec->flags & SND_MOTU_SPEC_RX_MIDI_2ND_Q) ||\n\t    (motu->spec->flags & SND_MOTU_SPEC_RX_MIDI_3RD_Q) ||\n\t    (motu->spec->flags & SND_MOTU_SPEC_TX_MIDI_2ND_Q) ||\n\t    (motu->spec->flags & SND_MOTU_SPEC_TX_MIDI_3RD_Q)) {\n\t\terr = snd_motu_create_midi_devices(motu);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\terr = snd_motu_create_hwdep_device(motu);\n\tif (err < 0)\n\t\tgoto error;\n\n\tif (motu->spec->flags & SND_MOTU_SPEC_REGISTER_DSP) {\n\t\terr = snd_motu_register_dsp_message_parser_new(motu);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t} else if (motu->spec->flags & SND_MOTU_SPEC_COMMAND_DSP) {\n\t\terr = snd_motu_command_dsp_message_parser_new(motu);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\terr = snd_card_register(card);\n\tif (err < 0)\n\t\tgoto error;\n\n\treturn 0;\nerror:\n\tsnd_card_free(card);\n\treturn err;\n}\n\nstatic void motu_remove(struct fw_unit *unit)\n{\n\tstruct snd_motu *motu = dev_get_drvdata(&unit->device);\n\n\t\n\tsnd_card_free(motu->card);\n}\n\nstatic void motu_bus_update(struct fw_unit *unit)\n{\n\tstruct snd_motu *motu = dev_get_drvdata(&unit->device);\n\n\t \n\tsnd_motu_transaction_reregister(motu);\n}\n\n#define SND_MOTU_DEV_ENTRY(model, data)\t\t\t\\\n{\t\t\t\t\t\t\t\\\n\t.match_flags\t= IEEE1394_MATCH_VENDOR_ID |\t\\\n\t\t\t  IEEE1394_MATCH_SPECIFIER_ID |\t\\\n\t\t\t  IEEE1394_MATCH_VERSION,\t\\\n\t.vendor_id\t= OUI_MOTU,\t\t\t\\\n\t.specifier_id\t= OUI_MOTU,\t\t\t\\\n\t.version\t= model,\t\t\t\\\n\t.driver_data\t= (kernel_ulong_t)data,\t\t\\\n}\n\nstatic const struct ieee1394_device_id motu_id_table[] = {\n\tSND_MOTU_DEV_ENTRY(0x000001, &snd_motu_spec_828),\n\tSND_MOTU_DEV_ENTRY(0x000002, &snd_motu_spec_896),\n\tSND_MOTU_DEV_ENTRY(0x000003, &snd_motu_spec_828mk2),\n\tSND_MOTU_DEV_ENTRY(0x000005, &snd_motu_spec_896hd),\n\tSND_MOTU_DEV_ENTRY(0x000009, &snd_motu_spec_traveler),\n\tSND_MOTU_DEV_ENTRY(0x00000d, &snd_motu_spec_ultralite),\n\tSND_MOTU_DEV_ENTRY(0x00000f, &snd_motu_spec_8pre),\n\tSND_MOTU_DEV_ENTRY(0x000015, &snd_motu_spec_828mk3_fw), \n\tSND_MOTU_DEV_ENTRY(0x000019, &snd_motu_spec_ultralite_mk3), \n\tSND_MOTU_DEV_ENTRY(0x00001b, &snd_motu_spec_traveler_mk3),\n\tSND_MOTU_DEV_ENTRY(0x000030, &snd_motu_spec_ultralite_mk3), \n\tSND_MOTU_DEV_ENTRY(0x000035, &snd_motu_spec_828mk3_hybrid), \n\tSND_MOTU_DEV_ENTRY(0x000033, &snd_motu_spec_audio_express),\n\tSND_MOTU_DEV_ENTRY(0x000039, &snd_motu_spec_track16),\n\tSND_MOTU_DEV_ENTRY(0x000045, &snd_motu_spec_4pre),\n\t{ }\n};\nMODULE_DEVICE_TABLE(ieee1394, motu_id_table);\n\nstatic struct fw_driver motu_driver = {\n\t.driver   = {\n\t\t.owner\t= THIS_MODULE,\n\t\t.name\t= KBUILD_MODNAME,\n\t\t.bus\t= &fw_bus_type,\n\t},\n\t.probe    = motu_probe,\n\t.update   = motu_bus_update,\n\t.remove   = motu_remove,\n\t.id_table = motu_id_table,\n};\n\nstatic int __init alsa_motu_init(void)\n{\n\treturn driver_register(&motu_driver.driver);\n}\n\nstatic void __exit alsa_motu_exit(void)\n{\n\tdriver_unregister(&motu_driver.driver);\n}\n\nmodule_init(alsa_motu_init);\nmodule_exit(alsa_motu_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}