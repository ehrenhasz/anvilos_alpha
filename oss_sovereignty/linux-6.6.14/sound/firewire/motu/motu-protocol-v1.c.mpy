{
  "module_name": "motu-protocol-v1.c",
  "hash_id": "b783afdaa1d234602e4be9cc93730e841f5b2863831c9d369232e6389dec41e9",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/motu/motu-protocol-v1.c",
  "human_readable_source": "\n\n\n\n\n#include \"motu.h\"\n\n#include <linux/delay.h>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n#define CLK_828_STATUS_OFFSET\t\t\t\t0x0b00\n#define  CLK_828_STATUS_MASK\t\t\t\t0x0000ffff\n#define  CLK_828_STATUS_FLAG_OPT_IN_IFACE_IS_SPDIF\t0x00008000\n#define  CLK_828_STATUS_FLAG_OPT_OUT_IFACE_IS_SPDIF\t0x00004000\n#define  CLK_828_STATUS_FLAG_FETCH_PCM_FRAMES\t\t0x00000080\n#define  CLK_828_STATUS_FLAG_ENABLE_OUTPUT\t\t0x00000008\n#define  CLK_828_STATUS_FLAG_RATE_48000\t\t\t0x00000004\n#define  CLK_828_STATUS_MASK_SRC\t\t\t0x00000023\n#define   CLK_828_STATUS_FLAG_SRC_ADAT_ON_OPT\t\t0x00000021\n#define   CLK_828_STATUS_FLAG_SRC_SPH\t\t\t0x00000003\n#define   CLK_828_STATUS_FLAG_SRC_SPDIF\t\t\t0x00000002\n#define   CLK_828_STATUS_FLAG_SRC_ADAT_ON_DSUB\t\t0x00000001\n#define   CLK_828_STATUS_FLAG_SRC_INTERNAL\t\t0x00000000\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n#define CLK_896_STATUS_OFFSET\t\t\t0x0b14\n#define  CLK_896_STATUS_FLAG_FETCH_ENABLE\t0x20000000\n#define  CLK_896_STATUS_FLAG_OUTPUT_ON\t\t0x03000000\n#define  CLK_896_STATUS_MASK_SRC\t\t0x00000007\n#define   CLK_896_STATUS_FLAG_SRC_INTERNAL\t0x00000000\n#define   CLK_896_STATUS_FLAG_SRC_ADAT_ON_OPT\t0x00000001\n#define   CLK_896_STATUS_FLAG_SRC_AESEBU\t0x00000002\n#define   CLK_896_STATUS_FLAG_SRC_SPH\t\t0x00000003\n#define   CLK_896_STATUS_FLAG_SRC_WORD\t\t0x00000004\n#define   CLK_896_STATUS_FLAG_SRC_ADAT_ON_DSUB\t0x00000005\n#define  CLK_896_STATUS_MASK_RATE\t\t0x00000018\n#define   CLK_896_STATUS_FLAG_RATE_44100\t0x00000000\n#define   CLK_896_STATUS_FLAG_RATE_48000\t0x00000008\n#define   CLK_896_STATUS_FLAG_RATE_88200\t0x00000010\n#define   CLK_896_STATUS_FLAG_RATE_96000\t0x00000018\n\nstatic void parse_clock_rate_828(u32 data, unsigned int *rate)\n{\n\tif (data & CLK_828_STATUS_FLAG_RATE_48000)\n\t\t*rate = 48000;\n\telse\n\t\t*rate = 44100;\n}\n\nstatic int get_clock_rate_828(struct snd_motu *motu, unsigned int *rate)\n{\n\t__be32 reg;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tparse_clock_rate_828(be32_to_cpu(reg), rate);\n\n\treturn 0;\n}\n\nstatic int parse_clock_rate_896(u32 data, unsigned int *rate)\n{\n\tswitch (data & CLK_896_STATUS_MASK_RATE) {\n\tcase CLK_896_STATUS_FLAG_RATE_44100:\n\t\t*rate = 44100;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_RATE_48000:\n\t\t*rate = 48000;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_RATE_88200:\n\t\t*rate = 88200;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_RATE_96000:\n\t\t*rate = 96000;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENXIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int get_clock_rate_896(struct snd_motu *motu, unsigned int *rate)\n{\n\t__be32 reg;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_896_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\treturn parse_clock_rate_896(be32_to_cpu(reg), rate);\n}\n\nint snd_motu_protocol_v1_get_clock_rate(struct snd_motu *motu, unsigned int *rate)\n{\n\tif (motu->spec == &snd_motu_spec_828)\n\t\treturn get_clock_rate_828(motu, rate);\n\telse if (motu->spec == &snd_motu_spec_896)\n\t\treturn get_clock_rate_896(motu, rate);\n\telse\n\t\treturn -ENXIO;\n}\n\nstatic int set_clock_rate_828(struct snd_motu *motu, unsigned int rate)\n{\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg) & CLK_828_STATUS_MASK;\n\n\tdata &= ~CLK_828_STATUS_FLAG_RATE_48000;\n\tif (rate == 48000)\n\t\tdata |= CLK_828_STATUS_FLAG_RATE_48000;\n\n\treg = cpu_to_be32(data);\n\treturn snd_motu_transaction_write(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n}\n\nstatic int set_clock_rate_896(struct snd_motu *motu, unsigned int rate)\n{\n\tunsigned int flag;\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_896_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg);\n\n\tswitch (rate) {\n\tcase 44100:\n\t\tflag = CLK_896_STATUS_FLAG_RATE_44100;\n\t\tbreak;\n\tcase 48000:\n\t\tflag = CLK_896_STATUS_FLAG_RATE_48000;\n\t\tbreak;\n\tcase 88200:\n\t\tflag = CLK_896_STATUS_FLAG_RATE_88200;\n\t\tbreak;\n\tcase 96000:\n\t\tflag = CLK_896_STATUS_FLAG_RATE_96000;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tdata &= ~CLK_896_STATUS_MASK_RATE;\n\tdata |= flag;\n\n\treg = cpu_to_be32(data);\n\treturn snd_motu_transaction_write(motu, CLK_896_STATUS_OFFSET, &reg, sizeof(reg));\n}\n\nint snd_motu_protocol_v1_set_clock_rate(struct snd_motu *motu, unsigned int rate)\n{\n\tif (motu->spec == &snd_motu_spec_828)\n\t\treturn set_clock_rate_828(motu, rate);\n\telse if (motu->spec == &snd_motu_spec_896)\n\t\treturn set_clock_rate_896(motu, rate);\n\telse\n\t\treturn -ENXIO;\n}\n\nstatic int get_clock_source_828(struct snd_motu *motu, enum snd_motu_clock_source *src)\n{\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg) & CLK_828_STATUS_MASK;\n\n\tswitch (data & CLK_828_STATUS_MASK_SRC) {\n\tcase CLK_828_STATUS_FLAG_SRC_ADAT_ON_OPT:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_ADAT_ON_OPT;\n\t\tbreak;\n\tcase CLK_828_STATUS_FLAG_SRC_SPH:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_SPH;\n\t\tbreak;\n\tcase CLK_828_STATUS_FLAG_SRC_SPDIF:\n\t{\n\t\tif (data & CLK_828_STATUS_FLAG_OPT_IN_IFACE_IS_SPDIF)\n\t\t\t*src = SND_MOTU_CLOCK_SOURCE_SPDIF_ON_COAX;\n\t\telse\n\t\t\t*src = SND_MOTU_CLOCK_SOURCE_SPDIF_ON_OPT;\n\t\tbreak;\n\t}\n\tcase CLK_828_STATUS_FLAG_SRC_ADAT_ON_DSUB:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_ADAT_ON_DSUB;\n\t\tbreak;\n\tcase CLK_828_STATUS_FLAG_SRC_INTERNAL:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_INTERNAL;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENXIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int get_clock_source_896(struct snd_motu *motu, enum snd_motu_clock_source *src)\n{\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_896_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg);\n\n\tswitch (data & CLK_896_STATUS_MASK_SRC) {\n\tcase CLK_896_STATUS_FLAG_SRC_INTERNAL:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_INTERNAL;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_SRC_ADAT_ON_OPT:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_ADAT_ON_OPT;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_SRC_AESEBU:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_AESEBU_ON_XLR;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_SRC_SPH:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_SPH;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_SRC_WORD:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_WORD_ON_BNC;\n\t\tbreak;\n\tcase CLK_896_STATUS_FLAG_SRC_ADAT_ON_DSUB:\n\t\t*src = SND_MOTU_CLOCK_SOURCE_ADAT_ON_DSUB;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENXIO;\n\t}\n\n\treturn 0;\n}\n\nint snd_motu_protocol_v1_get_clock_source(struct snd_motu *motu, enum snd_motu_clock_source *src)\n{\n\tif (motu->spec == &snd_motu_spec_828)\n\t\treturn get_clock_source_828(motu, src);\n\telse if (motu->spec == &snd_motu_spec_896)\n\t\treturn get_clock_source_896(motu, src);\n\telse\n\t\treturn -ENXIO;\n}\n\nstatic int switch_fetching_mode_828(struct snd_motu *motu, bool enable)\n{\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg) & CLK_828_STATUS_MASK;\n\n\tdata &= ~(CLK_828_STATUS_FLAG_FETCH_PCM_FRAMES | CLK_828_STATUS_FLAG_ENABLE_OUTPUT);\n\tif (enable) {\n\t\t\n\t\t\n\t\t\n\t\tmsleep(100);\n\t\tdata |= CLK_828_STATUS_FLAG_FETCH_PCM_FRAMES | CLK_828_STATUS_FLAG_ENABLE_OUTPUT;\n\t}\n\n\treg = cpu_to_be32(data);\n\treturn snd_motu_transaction_write(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n}\n\nstatic int switch_fetching_mode_896(struct snd_motu *motu, bool enable)\n{\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\terr = snd_motu_transaction_read(motu, CLK_896_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg);\n\n\tdata &= ~CLK_896_STATUS_FLAG_FETCH_ENABLE;\n\tif (enable)\n\t\tdata |= CLK_896_STATUS_FLAG_FETCH_ENABLE | CLK_896_STATUS_FLAG_OUTPUT_ON;\n\n\treg = cpu_to_be32(data);\n\treturn snd_motu_transaction_write(motu, CLK_896_STATUS_OFFSET, &reg, sizeof(reg));\n}\n\nint snd_motu_protocol_v1_switch_fetching_mode(struct snd_motu *motu, bool enable)\n{\n\tif (motu->spec == &snd_motu_spec_828)\n\t\treturn switch_fetching_mode_828(motu, enable);\n\telse if (motu->spec == &snd_motu_spec_896)\n\t\treturn switch_fetching_mode_896(motu, enable);\n\telse\n\t\treturn -ENXIO;\n}\n\nstatic int detect_packet_formats_828(struct snd_motu *motu)\n{\n\t__be32 reg;\n\tu32 data;\n\tint err;\n\n\tmotu->tx_packet_formats.pcm_byte_offset = 4;\n\tmotu->tx_packet_formats.msg_chunks = 2;\n\n\tmotu->rx_packet_formats.pcm_byte_offset = 4;\n\tmotu->rx_packet_formats.msg_chunks = 0;\n\n\terr = snd_motu_transaction_read(motu, CLK_828_STATUS_OFFSET, &reg, sizeof(reg));\n\tif (err < 0)\n\t\treturn err;\n\tdata = be32_to_cpu(reg) & CLK_828_STATUS_MASK;\n\n\t\n\tif (!(data & CLK_828_STATUS_FLAG_OPT_IN_IFACE_IS_SPDIF))\n\t\tmotu->tx_packet_formats.pcm_chunks[0] += 8;\n\n\tif (!(data & CLK_828_STATUS_FLAG_OPT_OUT_IFACE_IS_SPDIF))\n\t\tmotu->rx_packet_formats.pcm_chunks[0] += 8;\n\n\treturn 0;\n}\n\nstatic int detect_packet_formats_896(struct snd_motu *motu)\n{\n\t\n\tmotu->tx_packet_formats.pcm_byte_offset = 4;\n\tmotu->rx_packet_formats.pcm_byte_offset = 4;\n\n\t\n\tmotu->tx_packet_formats.msg_chunks = 0;\n\tmotu->rx_packet_formats.msg_chunks = 0;\n\n\t\n\t\n\tmotu->tx_packet_formats.pcm_chunks[0] += 8;\n\tmotu->tx_packet_formats.pcm_chunks[1] += 8;\n\n\tmotu->rx_packet_formats.pcm_chunks[0] += 8;\n\tmotu->rx_packet_formats.pcm_chunks[1] += 8;\n\n\treturn 0;\n}\n\nint snd_motu_protocol_v1_cache_packet_formats(struct snd_motu *motu)\n{\n\tmemcpy(motu->tx_packet_formats.pcm_chunks, motu->spec->tx_fixed_pcm_chunks,\n\t       sizeof(motu->tx_packet_formats.pcm_chunks));\n\tmemcpy(motu->rx_packet_formats.pcm_chunks, motu->spec->rx_fixed_pcm_chunks,\n\t       sizeof(motu->rx_packet_formats.pcm_chunks));\n\n\tif (motu->spec == &snd_motu_spec_828)\n\t\treturn detect_packet_formats_828(motu);\n\telse if (motu->spec == &snd_motu_spec_896)\n\t\treturn detect_packet_formats_896(motu);\n\telse\n\t\treturn 0;\n}\n\nconst struct snd_motu_spec snd_motu_spec_828 = {\n\t.name = \"828\",\n\t.protocol_version = SND_MOTU_PROTOCOL_V1,\n\t.tx_fixed_pcm_chunks = {10, 0, 0},\n\t.rx_fixed_pcm_chunks = {10, 0, 0},\n};\n\nconst struct snd_motu_spec snd_motu_spec_896 = {\n\t.name = \"896\",\n\t.tx_fixed_pcm_chunks = {10, 10, 0},\n\t.rx_fixed_pcm_chunks = {10, 10, 0},\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}