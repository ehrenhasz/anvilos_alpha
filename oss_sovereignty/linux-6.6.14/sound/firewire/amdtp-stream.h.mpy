{
  "module_name": "amdtp-stream.h",
  "hash_id": "df6672643ee64ec244a0e7cc455752e31e0178a31aee1fcc30845f2b34c8d75e",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/amdtp-stream.h",
  "human_readable_source": " \n#ifndef SOUND_FIREWIRE_AMDTP_H_INCLUDED\n#define SOUND_FIREWIRE_AMDTP_H_INCLUDED\n\n#include <linux/err.h>\n#include <linux/interrupt.h>\n#include <linux/mutex.h>\n#include <linux/sched.h>\n#include <sound/asound.h>\n#include \"packets-buffer.h\"\n\n \nenum cip_flags {\n\tCIP_NONBLOCKING\t\t= 0x00,\n\tCIP_BLOCKING\t\t= 0x01,\n\tCIP_EMPTY_WITH_TAG0\t= 0x02,\n\tCIP_DBC_IS_END_EVENT\t= 0x04,\n\tCIP_WRONG_DBS\t\t= 0x08,\n\tCIP_SKIP_DBC_ZERO_CHECK\t= 0x10,\n\tCIP_EMPTY_HAS_WRONG_DBC\t= 0x20,\n\tCIP_JUMBO_PAYLOAD\t= 0x40,\n\tCIP_HEADER_WITHOUT_EOH\t= 0x80,\n\tCIP_NO_HEADER\t\t= 0x100,\n\tCIP_UNALIGHED_DBC\t= 0x200,\n\tCIP_UNAWARE_SYT\t\t= 0x400,\n};\n\n \nenum cip_sfc {\n\tCIP_SFC_32000  = 0,\n\tCIP_SFC_44100  = 1,\n\tCIP_SFC_48000  = 2,\n\tCIP_SFC_88200  = 3,\n\tCIP_SFC_96000  = 4,\n\tCIP_SFC_176400 = 5,\n\tCIP_SFC_192000 = 6,\n\tCIP_SFC_COUNT\n};\n\nstruct fw_unit;\nstruct fw_iso_context;\nstruct snd_pcm_substream;\nstruct snd_pcm_runtime;\n\nenum amdtp_stream_direction {\n\tAMDTP_OUT_STREAM = 0,\n\tAMDTP_IN_STREAM\n};\n\nstruct pkt_desc {\n\tu32 cycle;\n\tu32 syt;\n\tunsigned int data_blocks;\n\tunsigned int data_block_counter;\n\t__be32 *ctx_payload;\n\tstruct list_head link;\n};\n\nstruct amdtp_stream;\ntypedef void (*amdtp_stream_process_ctx_payloads_t)(struct amdtp_stream *s,\n\t\t\t\t\t\t    const struct pkt_desc *desc,\n\t\t\t\t\t\t    unsigned int count,\n\t\t\t\t\t\t    struct snd_pcm_substream *pcm);\n\nstruct amdtp_domain;\nstruct amdtp_stream {\n\tstruct fw_unit *unit;\n\t \n\tunsigned int flags;\n\tenum amdtp_stream_direction direction;\n\tstruct mutex mutex;\n\n\t \n\tstruct fw_iso_context *context;\n\tstruct iso_packets_buffer buffer;\n\tunsigned int queue_size;\n\tint packet_index;\n\tstruct pkt_desc *packet_descs;\n\tstruct list_head packet_descs_list;\n\tstruct pkt_desc *packet_descs_cursor;\n\tint tag;\n\tunion {\n\t\tstruct {\n\t\t\tunsigned int ctx_header_size;\n\n\t\t\t \n\t\t\tunsigned int max_ctx_payload_length;\n\n\t\t\t \n\t\t\t \n\t\t\t \n\t\t\tunsigned int dbc_interval;\n\n\t\t\t \n\t\t\tbool event_starts;\n\n\t\t\tstruct {\n\t\t\t\tstruct seq_desc *descs;\n\t\t\t\tunsigned int size;\n\t\t\t\tunsigned int pos;\n\t\t\t} cache;\n\t\t} tx;\n\t\tstruct {\n\t\t\t \n\t\t\tunsigned int fdf;\n\n\t\t\t \n\t\t\tunsigned int event_count;\n\n\t\t\t \n\t\t\tstruct {\n\t\t\t\tstruct seq_desc *descs;\n\t\t\t\tunsigned int size;\n\t\t\t\tunsigned int pos;\n\t\t\t} seq;\n\n\t\t\tunsigned int data_block_state;\n\t\t\tunsigned int syt_offset_state;\n\t\t\tunsigned int last_syt_offset;\n\n\t\t\tstruct amdtp_stream *replay_target;\n\t\t\tunsigned int cache_pos;\n\t\t} rx;\n\t} ctx_data;\n\n\t \n\tunsigned int source_node_id_field;\n\tunsigned int data_block_quadlets;\n\tunsigned int data_block_counter;\n\tunsigned int sph;\n\tunsigned int fmt;\n\n\t \n\tunsigned int transfer_delay;\n\tenum cip_sfc sfc;\n\tunsigned int syt_interval;\n\n\t \n\tstruct snd_pcm_substream *pcm;\n\tsnd_pcm_uframes_t pcm_buffer_pointer;\n\tunsigned int pcm_period_pointer;\n\tunsigned int pcm_frame_multiplier;\n\n\t \n\t \n\tbool ready_processing;\n\twait_queue_head_t ready_wait;\n\tunsigned int next_cycle;\n\n\t \n\tvoid *protocol;\n\tamdtp_stream_process_ctx_payloads_t process_ctx_payloads;\n\n\t \n\tint channel;\n\tint speed;\n\tstruct list_head list;\n\tstruct amdtp_domain *domain;\n};\n\nint amdtp_stream_init(struct amdtp_stream *s, struct fw_unit *unit,\n\t\t      enum amdtp_stream_direction dir, unsigned int flags,\n\t\t      unsigned int fmt,\n\t\t      amdtp_stream_process_ctx_payloads_t process_ctx_payloads,\n\t\t      unsigned int protocol_size);\nvoid amdtp_stream_destroy(struct amdtp_stream *s);\n\nint amdtp_stream_set_parameters(struct amdtp_stream *s, unsigned int rate,\n\t\t\t\tunsigned int data_block_quadlets, unsigned int pcm_frame_multiplier);\nunsigned int amdtp_stream_get_max_payload(struct amdtp_stream *s);\n\nvoid amdtp_stream_update(struct amdtp_stream *s);\n\nint amdtp_stream_add_pcm_hw_constraints(struct amdtp_stream *s,\n\t\t\t\t\tstruct snd_pcm_runtime *runtime);\n\nvoid amdtp_stream_pcm_prepare(struct amdtp_stream *s);\nvoid amdtp_stream_pcm_abort(struct amdtp_stream *s);\n\nextern const unsigned int amdtp_syt_intervals[CIP_SFC_COUNT];\nextern const unsigned int amdtp_rate_table[CIP_SFC_COUNT];\n\n \nstatic inline bool amdtp_stream_running(struct amdtp_stream *s)\n{\n\treturn !IS_ERR(s->context);\n}\n\n \nstatic inline bool amdtp_streaming_error(struct amdtp_stream *s)\n{\n\treturn s->packet_index < 0;\n}\n\n \nstatic inline bool amdtp_stream_pcm_running(struct amdtp_stream *s)\n{\n\treturn !!s->pcm;\n}\n\n \nstatic inline void amdtp_stream_pcm_trigger(struct amdtp_stream *s,\n\t\t\t\t\t    struct snd_pcm_substream *pcm)\n{\n\tWRITE_ONCE(s->pcm, pcm);\n}\n\n \n#define amdtp_stream_next_packet_desc(s, desc) \\\n\tlist_next_entry_circular(desc, &s->packet_descs_list, link)\n\nstatic inline bool cip_sfc_is_base_44100(enum cip_sfc sfc)\n{\n\treturn sfc & 1;\n}\n\nstruct seq_desc {\n\tunsigned int syt_offset;\n\tunsigned int data_blocks;\n};\n\nstruct amdtp_domain {\n\tstruct list_head streams;\n\n\tunsigned int events_per_period;\n\tunsigned int events_per_buffer;\n\n\tstruct amdtp_stream *irq_target;\n\n\tstruct {\n\t\tunsigned int tx_init_skip;\n\t\tunsigned int tx_start;\n\t\tunsigned int rx_start;\n\t} processing_cycle;\n\n\tstruct {\n\t\tbool enable:1;\n\t\tbool on_the_fly:1;\n\t} replay;\n};\n\nint amdtp_domain_init(struct amdtp_domain *d);\nvoid amdtp_domain_destroy(struct amdtp_domain *d);\n\nint amdtp_domain_add_stream(struct amdtp_domain *d, struct amdtp_stream *s,\n\t\t\t    int channel, int speed);\n\nint amdtp_domain_start(struct amdtp_domain *d, unsigned int tx_init_skip_cycles, bool replay_seq,\n\t\t       bool replay_on_the_fly);\nvoid amdtp_domain_stop(struct amdtp_domain *d);\n\nstatic inline int amdtp_domain_set_events_per_period(struct amdtp_domain *d,\n\t\t\t\t\t\tunsigned int events_per_period,\n\t\t\t\t\t\tunsigned int events_per_buffer)\n{\n\td->events_per_period = events_per_period;\n\td->events_per_buffer = events_per_buffer;\n\n\treturn 0;\n}\n\nunsigned long amdtp_domain_stream_pcm_pointer(struct amdtp_domain *d,\n\t\t\t\t\t      struct amdtp_stream *s);\nint amdtp_domain_stream_pcm_ack(struct amdtp_domain *d, struct amdtp_stream *s);\n\n \nstatic inline bool amdtp_domain_wait_ready(struct amdtp_domain *d, unsigned int timeout_ms)\n{\n\tstruct amdtp_stream *s;\n\n\tlist_for_each_entry(s, &d->streams, list) {\n\t\tunsigned int j = msecs_to_jiffies(timeout_ms);\n\n\t\tif (wait_event_interruptible_timeout(s->ready_wait, s->ready_processing, j) <= 0)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}