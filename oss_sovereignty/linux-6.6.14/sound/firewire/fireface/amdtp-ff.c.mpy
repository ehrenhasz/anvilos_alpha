{
  "module_name": "amdtp-ff.c",
  "hash_id": "9b0b53708bd821094b135a9cb28a95b8c251850dd29304af064045c187ae8b92",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/fireface/amdtp-ff.c",
  "human_readable_source": "\n \n\n#include <sound/pcm.h>\n#include \"ff.h\"\n\nstruct amdtp_ff {\n\tunsigned int pcm_channels;\n};\n\nint amdtp_ff_set_parameters(struct amdtp_stream *s, unsigned int rate,\n\t\t\t    unsigned int pcm_channels)\n{\n\tstruct amdtp_ff *p = s->protocol;\n\tunsigned int data_channels;\n\n\tif (amdtp_stream_running(s))\n\t\treturn -EBUSY;\n\n\tp->pcm_channels = pcm_channels;\n\tdata_channels = pcm_channels;\n\n\treturn amdtp_stream_set_parameters(s, rate, data_channels, 1);\n}\n\nstatic void write_pcm_s32(struct amdtp_stream *s, struct snd_pcm_substream *pcm,\n\t\t\t  __le32 *buffer, unsigned int frames,\n\t\t\t  unsigned int pcm_frames)\n{\n\tstruct amdtp_ff *p = s->protocol;\n\tunsigned int channels = p->pcm_channels;\n\tstruct snd_pcm_runtime *runtime = pcm->runtime;\n\tunsigned int pcm_buffer_pointer;\n\tint remaining_frames;\n\tconst u32 *src;\n\tint i, c;\n\n\tpcm_buffer_pointer = s->pcm_buffer_pointer + pcm_frames;\n\tpcm_buffer_pointer %= runtime->buffer_size;\n\n\tsrc = (void *)runtime->dma_area +\n\t\t\t\tframes_to_bytes(runtime, pcm_buffer_pointer);\n\tremaining_frames = runtime->buffer_size - pcm_buffer_pointer;\n\n\tfor (i = 0; i < frames; ++i) {\n\t\tfor (c = 0; c < channels; ++c) {\n\t\t\tbuffer[c] = cpu_to_le32(*src);\n\t\t\tsrc++;\n\t\t}\n\t\tbuffer += s->data_block_quadlets;\n\t\tif (--remaining_frames == 0)\n\t\t\tsrc = (void *)runtime->dma_area;\n\t}\n}\n\nstatic void read_pcm_s32(struct amdtp_stream *s, struct snd_pcm_substream *pcm,\n\t\t\t __le32 *buffer, unsigned int frames,\n\t\t\t unsigned int pcm_frames)\n{\n\tstruct amdtp_ff *p = s->protocol;\n\tunsigned int channels = p->pcm_channels;\n\tstruct snd_pcm_runtime *runtime = pcm->runtime;\n\tunsigned int pcm_buffer_pointer;\n\tint remaining_frames;\n\tu32 *dst;\n\tint i, c;\n\n\tpcm_buffer_pointer = s->pcm_buffer_pointer + pcm_frames;\n\tpcm_buffer_pointer %= runtime->buffer_size;\n\n\tdst  = (void *)runtime->dma_area +\n\t\t\t\tframes_to_bytes(runtime, pcm_buffer_pointer);\n\tremaining_frames = runtime->buffer_size - pcm_buffer_pointer;\n\n\tfor (i = 0; i < frames; ++i) {\n\t\tfor (c = 0; c < channels; ++c) {\n\t\t\t*dst = le32_to_cpu(buffer[c]) & 0xffffff00;\n\t\t\tdst++;\n\t\t}\n\t\tbuffer += s->data_block_quadlets;\n\t\tif (--remaining_frames == 0)\n\t\t\tdst = (void *)runtime->dma_area;\n\t}\n}\n\nstatic void write_pcm_silence(struct amdtp_stream *s,\n\t\t\t      __le32 *buffer, unsigned int frames)\n{\n\tstruct amdtp_ff *p = s->protocol;\n\tunsigned int i, c, channels = p->pcm_channels;\n\n\tfor (i = 0; i < frames; ++i) {\n\t\tfor (c = 0; c < channels; ++c)\n\t\t\tbuffer[c] = cpu_to_le32(0x00000000);\n\t\tbuffer += s->data_block_quadlets;\n\t}\n}\n\nint amdtp_ff_add_pcm_hw_constraints(struct amdtp_stream *s,\n\t\t\t\t    struct snd_pcm_runtime *runtime)\n{\n\tint err;\n\n\terr = snd_pcm_hw_constraint_msbits(runtime, 0, 32, 24);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn amdtp_stream_add_pcm_hw_constraints(s, runtime);\n}\n\nstatic void process_it_ctx_payloads(struct amdtp_stream *s, const struct pkt_desc *desc,\n\t\t\t\t    unsigned int count, struct snd_pcm_substream *pcm)\n{\n\tunsigned int pcm_frames = 0;\n\tint i;\n\n\tfor (i = 0; i < count; ++i) {\n\t\t__le32 *buf = (__le32 *)desc->ctx_payload;\n\t\tunsigned int data_blocks = desc->data_blocks;\n\n\t\tif (pcm) {\n\t\t\twrite_pcm_s32(s, pcm, buf, data_blocks, pcm_frames);\n\t\t\tpcm_frames += data_blocks;\n\t\t} else {\n\t\t\twrite_pcm_silence(s, buf, data_blocks);\n\t\t}\n\n\t\tdesc = amdtp_stream_next_packet_desc(s, desc);\n\t}\n}\n\nstatic void process_ir_ctx_payloads(struct amdtp_stream *s, const struct pkt_desc *desc,\n\t\t\t\t    unsigned int count, struct snd_pcm_substream *pcm)\n{\n\tunsigned int pcm_frames = 0;\n\tint i;\n\n\tfor (i = 0; i < count; ++i) {\n\t\t__le32 *buf = (__le32 *)desc->ctx_payload;\n\t\tunsigned int data_blocks = desc->data_blocks;\n\n\t\tif (pcm) {\n\t\t\tread_pcm_s32(s, pcm, buf, data_blocks, pcm_frames);\n\t\t\tpcm_frames += data_blocks;\n\t\t}\n\n\t\tdesc = amdtp_stream_next_packet_desc(s, desc);\n\t}\n}\n\nint amdtp_ff_init(struct amdtp_stream *s, struct fw_unit *unit,\n\t\t  enum amdtp_stream_direction dir)\n{\n\tamdtp_stream_process_ctx_payloads_t process_ctx_payloads;\n\n\tif (dir == AMDTP_IN_STREAM)\n\t\tprocess_ctx_payloads = process_ir_ctx_payloads;\n\telse\n\t\tprocess_ctx_payloads = process_it_ctx_payloads;\n\n\treturn amdtp_stream_init(s, unit, dir, CIP_BLOCKING | CIP_UNAWARE_SYT | CIP_NO_HEADER, 0,\n\t\t\t\t process_ctx_payloads, sizeof(struct amdtp_ff));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}