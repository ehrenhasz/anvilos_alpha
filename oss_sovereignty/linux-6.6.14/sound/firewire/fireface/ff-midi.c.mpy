{
  "module_name": "ff-midi.c",
  "hash_id": "7587abfc48b05d8c0655db10da1d4d8c2579deefedd664bba5904062538a1ac3",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/fireface/ff-midi.c",
  "human_readable_source": "\n \n\n#include \"ff.h\"\n\nstatic int midi_capture_open(struct snd_rawmidi_substream *substream)\n{\n\t \n\treturn 0;\n}\n\nstatic int midi_playback_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_ff *ff = substream->rmidi->private_data;\n\n\t \n\tff->on_sysex[substream->number] = 0;\n\tff->rx_midi_error[substream->number] = false;\n\n\tWRITE_ONCE(ff->rx_midi_substreams[substream->number], substream);\n\n\treturn 0;\n}\n\nstatic int midi_capture_close(struct snd_rawmidi_substream *substream)\n{\n\t \n\treturn 0;\n}\n\nstatic int midi_playback_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_ff *ff = substream->rmidi->private_data;\n\n\tcancel_work_sync(&ff->rx_midi_work[substream->number]);\n\tWRITE_ONCE(ff->rx_midi_substreams[substream->number], NULL);\n\n\treturn 0;\n}\n\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t int up)\n{\n\tstruct snd_ff *ff = substream->rmidi->private_data;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&ff->lock, flags);\n\n\tif (up)\n\t\tWRITE_ONCE(ff->tx_midi_substreams[substream->number],\n\t\t\t   substream);\n\telse\n\t\tWRITE_ONCE(ff->tx_midi_substreams[substream->number], NULL);\n\n\tspin_unlock_irqrestore(&ff->lock, flags);\n}\n\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t  int up)\n{\n\tstruct snd_ff *ff = substream->rmidi->private_data;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&ff->lock, flags);\n\n\tif (up || !ff->rx_midi_error[substream->number])\n\t\tschedule_work(&ff->rx_midi_work[substream->number]);\n\n\tspin_unlock_irqrestore(&ff->lock, flags);\n}\n\nstatic void set_midi_substream_names(struct snd_rawmidi_str *stream,\n\t\t\t\t     const char *const name)\n{\n\tstruct snd_rawmidi_substream *substream;\n\n\tlist_for_each_entry(substream, &stream->substreams, list) {\n\t\tscnprintf(substream->name, sizeof(substream->name),\n\t\t\t  \"%s MIDI %d\", name, substream->number + 1);\n\t}\n}\n\nint snd_ff_create_midi_devices(struct snd_ff *ff)\n{\n\tstatic const struct snd_rawmidi_ops midi_capture_ops = {\n\t\t.open\t\t= midi_capture_open,\n\t\t.close\t\t= midi_capture_close,\n\t\t.trigger\t= midi_capture_trigger,\n\t};\n\tstatic const struct snd_rawmidi_ops midi_playback_ops = {\n\t\t.open\t\t= midi_playback_open,\n\t\t.close\t\t= midi_playback_close,\n\t\t.trigger\t= midi_playback_trigger,\n\t};\n\tstruct snd_rawmidi *rmidi;\n\tstruct snd_rawmidi_str *stream;\n\tint err;\n\n\terr = snd_rawmidi_new(ff->card, ff->card->driver, 0,\n\t\t\t      ff->spec->midi_out_ports, ff->spec->midi_in_ports,\n\t\t\t      &rmidi);\n\tif (err < 0)\n\t\treturn err;\n\n\tsnprintf(rmidi->name, sizeof(rmidi->name),\n\t\t \"%s MIDI\", ff->card->shortname);\n\trmidi->private_data = ff;\n\n\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\n\t\t\t    &midi_capture_ops);\n\tstream = &rmidi->streams[SNDRV_RAWMIDI_STREAM_INPUT];\n\tset_midi_substream_names(stream, ff->card->shortname);\n\n\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\n\t\t\t    &midi_playback_ops);\n\tstream = &rmidi->streams[SNDRV_RAWMIDI_STREAM_OUTPUT];\n\tset_midi_substream_names(stream, ff->card->shortname);\n\n\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}