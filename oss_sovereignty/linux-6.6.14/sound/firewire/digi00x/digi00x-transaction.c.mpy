{
  "module_name": "digi00x-transaction.c",
  "hash_id": "b3ccce7024238ce7b721dd33a277af3d88eae662e97748ad53ba7b3e189584ed",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/digi00x/digi00x-transaction.c",
  "human_readable_source": "\n \n\n#include <sound/asound.h>\n#include \"digi00x.h\"\n\nstatic void handle_unknown_message(struct snd_dg00x *dg00x,\n\t\t\t\t   unsigned long long offset, __be32 *buf)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dg00x->lock, flags);\n\tdg00x->msg = be32_to_cpu(*buf);\n\tspin_unlock_irqrestore(&dg00x->lock, flags);\n\n\twake_up(&dg00x->hwdep_wait);\n}\n\nstatic void handle_message(struct fw_card *card, struct fw_request *request,\n\t\t\t   int tcode, int destination, int source,\n\t\t\t   int generation, unsigned long long offset,\n\t\t\t   void *data, size_t length, void *callback_data)\n{\n\tstruct snd_dg00x *dg00x = callback_data;\n\t__be32 *buf = (__be32 *)data;\n\n\tfw_send_response(card, request, RCODE_COMPLETE);\n\n\tif (offset == dg00x->async_handler.offset)\n\t\thandle_unknown_message(dg00x, offset, buf);\n}\n\nint snd_dg00x_transaction_reregister(struct snd_dg00x *dg00x)\n{\n\tstruct fw_device *device = fw_parent_device(dg00x->unit);\n\t__be32 data[2];\n\n\t \n\tdata[0] = cpu_to_be32((device->card->node_id << 16) |\n\t\t\t      (dg00x->async_handler.offset >> 32));\n\tdata[1] = cpu_to_be32(dg00x->async_handler.offset);\n\treturn snd_fw_transaction(dg00x->unit, TCODE_WRITE_BLOCK_REQUEST,\n\t\t\t\t  DG00X_ADDR_BASE + DG00X_OFFSET_MESSAGE_ADDR,\n\t\t\t\t  &data, sizeof(data), 0);\n}\n\nvoid snd_dg00x_transaction_unregister(struct snd_dg00x *dg00x)\n{\n\tif (dg00x->async_handler.callback_data == NULL)\n\t\treturn;\n\n\tfw_core_remove_address_handler(&dg00x->async_handler);\n\n\tdg00x->async_handler.callback_data = NULL;\n}\n\nint snd_dg00x_transaction_register(struct snd_dg00x *dg00x)\n{\n\tstatic const struct fw_address_region resp_register_region = {\n\t\t.start\t= 0xffffe0000000ull,\n\t\t.end\t= 0xffffe000ffffull,\n\t};\n\tint err;\n\n\tdg00x->async_handler.length = 4;\n\tdg00x->async_handler.address_callback = handle_message;\n\tdg00x->async_handler.callback_data = dg00x;\n\n\terr = fw_core_add_address_handler(&dg00x->async_handler,\n\t\t\t\t\t  &resp_register_region);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = snd_dg00x_transaction_reregister(dg00x);\n\tif (err < 0)\n\t\tsnd_dg00x_transaction_unregister(dg00x);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}