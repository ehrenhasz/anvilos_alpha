{
  "module_name": "digi00x-midi.c",
  "hash_id": "c370ee82dcbf2d686d4a14498409000986b26099e3bfa6631954e9334b31408f",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/digi00x/digi00x-midi.c",
  "human_readable_source": "\n \n\n#include \"digi00x.h\"\n\nstatic int midi_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_dg00x *dg00x = substream->rmidi->private_data;\n\tint err;\n\n\terr = snd_dg00x_stream_lock_try(dg00x);\n\tif (err < 0)\n\t\treturn err;\n\n\tmutex_lock(&dg00x->mutex);\n\terr = snd_dg00x_stream_reserve_duplex(dg00x, 0, 0, 0);\n\tif (err >= 0) {\n\t\t++dg00x->substreams_counter;\n\t\terr = snd_dg00x_stream_start_duplex(dg00x);\n\t\tif (err < 0)\n\t\t\t--dg00x->substreams_counter;\n\t}\n\tmutex_unlock(&dg00x->mutex);\n\tif (err < 0)\n\t\tsnd_dg00x_stream_lock_release(dg00x);\n\n\treturn err;\n}\n\nstatic int midi_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_dg00x *dg00x = substream->rmidi->private_data;\n\n\tmutex_lock(&dg00x->mutex);\n\t--dg00x->substreams_counter;\n\tsnd_dg00x_stream_stop_duplex(dg00x);\n\tmutex_unlock(&dg00x->mutex);\n\n\tsnd_dg00x_stream_lock_release(dg00x);\n\treturn 0;\n}\n\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t int up)\n{\n\tstruct snd_dg00x *dg00x = substream->rmidi->private_data;\n\tunsigned int port;\n\tunsigned long flags;\n\n\tif (substream->rmidi->device == 0)\n\t\tport = substream->number;\n\telse\n\t\tport = 2;\n\n\tspin_lock_irqsave(&dg00x->lock, flags);\n\n\tif (up)\n\t\tamdtp_dot_midi_trigger(&dg00x->tx_stream, port, substream);\n\telse\n\t\tamdtp_dot_midi_trigger(&dg00x->tx_stream, port, NULL);\n\n\tspin_unlock_irqrestore(&dg00x->lock, flags);\n}\n\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t  int up)\n{\n\tstruct snd_dg00x *dg00x = substream->rmidi->private_data;\n\tunsigned int port;\n\tunsigned long flags;\n\n\tif (substream->rmidi->device == 0)\n\t\tport = substream->number;\n\telse\n\t\tport = 2;\n\n\tspin_lock_irqsave(&dg00x->lock, flags);\n\n\tif (up)\n\t\tamdtp_dot_midi_trigger(&dg00x->rx_stream, port, substream);\n\telse\n\t\tamdtp_dot_midi_trigger(&dg00x->rx_stream, port, NULL);\n\n\tspin_unlock_irqrestore(&dg00x->lock, flags);\n}\n\nstatic void set_substream_names(struct snd_dg00x *dg00x,\n\t\t\t\tstruct snd_rawmidi *rmidi, bool is_console)\n{\n\tstruct snd_rawmidi_substream *subs;\n\tstruct snd_rawmidi_str *str;\n\tint i;\n\n\tfor (i = 0; i < 2; ++i) {\n\t\tstr = &rmidi->streams[i];\n\n\t\tlist_for_each_entry(subs, &str->substreams, list) {\n\t\t\tif (!is_console) {\n\t\t\t\tscnprintf(subs->name, sizeof(subs->name),\n\t\t\t\t\t  \"%s MIDI %d\",\n\t\t\t\t\t  dg00x->card->shortname,\n\t\t\t\t\t  subs->number + 1);\n\t\t\t} else {\n\t\t\t\tscnprintf(subs->name, sizeof(subs->name),\n\t\t\t\t\t  \"%s control\",\n\t\t\t\t\t  dg00x->card->shortname);\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic int add_substream_pair(struct snd_dg00x *dg00x, unsigned int out_ports,\n\t\t\t      unsigned int in_ports, bool is_console)\n{\n\tstatic const struct snd_rawmidi_ops capture_ops = {\n\t\t.open = midi_open,\n\t\t.close = midi_close,\n\t\t.trigger = midi_capture_trigger,\n\t};\n\tstatic const struct snd_rawmidi_ops playback_ops = {\n\t\t.open = midi_open,\n\t\t.close = midi_close,\n\t\t.trigger = midi_playback_trigger,\n\t};\n\tconst char *label;\n\tstruct snd_rawmidi *rmidi;\n\tint err;\n\n\t \n\terr = snd_rawmidi_new(dg00x->card, dg00x->card->driver, is_console,\n\t\t\t      out_ports, in_ports, &rmidi);\n\tif (err < 0)\n\t\treturn err;\n\trmidi->private_data = dg00x;\n\n\tif (!is_console)\n\t\tlabel = \"%s control\";\n\telse\n\t\tlabel = \"%s MIDI\";\n\tsnprintf(rmidi->name, sizeof(rmidi->name), label,\n\t\t dg00x->card->shortname);\n\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &playback_ops);\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &capture_ops);\n\n\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT |\n\t\t\t     SNDRV_RAWMIDI_INFO_OUTPUT |\n\t\t\t     SNDRV_RAWMIDI_INFO_DUPLEX;\n\n\tset_substream_names(dg00x, rmidi, is_console);\n\n\treturn 0;\n}\n\nint snd_dg00x_create_midi_devices(struct snd_dg00x *dg00x)\n{\n\tint err;\n\n\t \n\terr = add_substream_pair(dg00x, DOT_MIDI_OUT_PORTS, DOT_MIDI_IN_PORTS,\n\t\t\t\t false);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (dg00x->is_console)\n\t\terr = add_substream_pair(dg00x, 1, 1, true);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}