{
  "module_name": "dice-extension.c",
  "hash_id": "5808b4d14d8e8c97d075bb5b1957a03e63c63de74ce1c288a28bb8f7256c6489",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/dice/dice-extension.c",
  "human_readable_source": "\n \n\n#include \"dice.h\"\n\n \n\n#define DICE_EXT_APP_SPACE\t\t0xffffe0200000uLL\n\n#define DICE_EXT_APP_CAPS_OFFSET\t0x00\n#define DICE_EXT_APP_CAPS_SIZE\t\t0x04\n#define DICE_EXT_APP_CMD_OFFSET\t\t0x08\n#define DICE_EXT_APP_CMD_SIZE\t\t0x0c\n#define DICE_EXT_APP_MIXER_OFFSET\t0x10\n#define DICE_EXT_APP_MIXER_SIZE\t\t0x14\n#define DICE_EXT_APP_PEAK_OFFSET\t0x18\n#define DICE_EXT_APP_PEAK_SIZE\t\t0x1c\n#define DICE_EXT_APP_ROUTER_OFFSET\t0x20\n#define DICE_EXT_APP_ROUTER_SIZE\t0x24\n#define DICE_EXT_APP_STREAM_OFFSET\t0x28\n#define DICE_EXT_APP_STREAM_SIZE\t0x2c\n#define DICE_EXT_APP_CURRENT_OFFSET\t0x30\n#define DICE_EXT_APP_CURRENT_SIZE\t0x34\n#define DICE_EXT_APP_STANDALONE_OFFSET\t0x38\n#define DICE_EXT_APP_STANDALONE_SIZE\t0x3c\n#define DICE_EXT_APP_APPLICATION_OFFSET\t0x40\n#define DICE_EXT_APP_APPLICATION_SIZE\t0x44\n\n#define EXT_APP_STREAM_TX_NUMBER\t0x0000\n#define EXT_APP_STREAM_RX_NUMBER\t0x0004\n#define EXT_APP_STREAM_ENTRIES\t\t0x0008\n#define EXT_APP_STREAM_ENTRY_SIZE\t0x010c\n#define  EXT_APP_NUMBER_AUDIO\t\t0x0000\n#define  EXT_APP_NUMBER_MIDI\t\t0x0004\n#define  EXT_APP_NAMES\t\t\t0x0008\n#define   EXT_APP_NAMES_SIZE\t\t256\n#define  EXT_APP_AC3\t\t\t0x0108\n\n#define EXT_APP_CONFIG_LOW_ROUTER\t0x0000\n#define EXT_APP_CONFIG_LOW_STREAM\t0x1000\n#define EXT_APP_CONFIG_MIDDLE_ROUTER\t0x2000\n#define EXT_APP_CONFIG_MIDDLE_STREAM\t0x3000\n#define EXT_APP_CONFIG_HIGH_ROUTER\t0x4000\n#define EXT_APP_CONFIG_HIGH_STREAM\t0x5000\n\nstatic inline int read_transaction(struct snd_dice *dice, u64 section_addr,\n\t\t\t\t   u32 offset, void *buf, size_t len)\n{\n\treturn snd_fw_transaction(dice->unit,\n\t\t\t\t  len == 4 ? TCODE_READ_QUADLET_REQUEST :\n\t\t\t\t\t     TCODE_READ_BLOCK_REQUEST,\n\t\t\t\t  section_addr + offset, buf, len, 0);\n}\n\nstatic int read_stream_entries(struct snd_dice *dice, u64 section_addr,\n\t\t\t       u32 base_offset, unsigned int stream_count,\n\t\t\t       unsigned int mode,\n\t\t\t       unsigned int pcm_channels[MAX_STREAMS][3],\n\t\t\t       unsigned int midi_ports[MAX_STREAMS])\n{\n\tu32 entry_offset;\n\t__be32 reg[2];\n\tint err;\n\tint i;\n\n\tfor (i = 0; i < stream_count; ++i) {\n\t\tentry_offset = base_offset + i * EXT_APP_STREAM_ENTRY_SIZE;\n\t\terr = read_transaction(dice, section_addr,\n\t\t\t\t    entry_offset + EXT_APP_NUMBER_AUDIO,\n\t\t\t\t    reg, sizeof(reg));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tpcm_channels[i][mode] = be32_to_cpu(reg[0]);\n\t\tmidi_ports[i] = max(midi_ports[i], be32_to_cpu(reg[1]));\n\t}\n\n\treturn 0;\n}\n\nstatic int detect_stream_formats(struct snd_dice *dice, u64 section_addr)\n{\n\tu32 base_offset;\n\t__be32 reg[2];\n\tunsigned int stream_count;\n\tint mode;\n\tint err = 0;\n\n\tfor (mode = 0; mode < SND_DICE_RATE_MODE_COUNT; ++mode) {\n\t\tunsigned int cap;\n\n\t\t \n\t\tif (mode == 2) {\n\t\t\tcap = CLOCK_CAP_RATE_176400 | CLOCK_CAP_RATE_192000;\n\t\t} else if (mode == 1) {\n\t\t\tcap = CLOCK_CAP_RATE_88200 | CLOCK_CAP_RATE_96000;\n\t\t} else {\n\t\t\tcap = CLOCK_CAP_RATE_32000 | CLOCK_CAP_RATE_44100 |\n\t\t\t      CLOCK_CAP_RATE_48000;\n\t\t}\n\t\tif (!(cap & dice->clock_caps))\n\t\t\tcontinue;\n\n\t\tbase_offset = 0x2000 * mode + 0x1000;\n\n\t\terr = read_transaction(dice, section_addr,\n\t\t\t\t       base_offset + EXT_APP_STREAM_TX_NUMBER,\n\t\t\t\t       &reg, sizeof(reg));\n\t\tif (err < 0)\n\t\t\tbreak;\n\n\t\tbase_offset += EXT_APP_STREAM_ENTRIES;\n\t\tstream_count = be32_to_cpu(reg[0]);\n\t\terr = read_stream_entries(dice, section_addr, base_offset,\n\t\t\t\t\t  stream_count, mode,\n\t\t\t\t\t  dice->tx_pcm_chs,\n\t\t\t\t\t  dice->tx_midi_ports);\n\t\tif (err < 0)\n\t\t\tbreak;\n\n\t\tbase_offset += stream_count * EXT_APP_STREAM_ENTRY_SIZE;\n\t\tstream_count = be32_to_cpu(reg[1]);\n\t\terr = read_stream_entries(dice, section_addr, base_offset,\n\t\t\t\t\t  stream_count,\n\t\t\t\t\t  mode, dice->rx_pcm_chs,\n\t\t\t\t\t  dice->rx_midi_ports);\n\t\tif (err < 0)\n\t\t\tbreak;\n\t}\n\n\treturn err;\n}\n\nint snd_dice_detect_extension_formats(struct snd_dice *dice)\n{\n\t__be32 *pointers;\n\tunsigned int i;\n\tu64 section_addr;\n\tint err;\n\n\tpointers = kmalloc_array(9, sizeof(__be32) * 2, GFP_KERNEL);\n\tif (pointers == NULL)\n\t\treturn -ENOMEM;\n\n\terr = snd_fw_transaction(dice->unit, TCODE_READ_BLOCK_REQUEST,\n\t\t\t\t DICE_EXT_APP_SPACE, pointers,\n\t\t\t\t 9 * sizeof(__be32) * 2, 0);\n\tif (err < 0)\n\t\tgoto end;\n\n\t \n\tfor (i = 0; i < 9; ++i) {\n\t\tint j;\n\n\t\tfor (j = i + 1; j < 9; ++j) {\n\t\t\tif (pointers[i * 2] == pointers[j * 2]) {\n\t\t\t\t\n\t\t\t\terr = -ENXIO;\n\t\t\t\tgoto end;\n\t\t\t}\n\t\t}\n\t}\n\n\tsection_addr = DICE_EXT_APP_SPACE + be32_to_cpu(pointers[12]) * 4;\n\terr = detect_stream_formats(dice, section_addr);\nend:\n\tkfree(pointers);\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}