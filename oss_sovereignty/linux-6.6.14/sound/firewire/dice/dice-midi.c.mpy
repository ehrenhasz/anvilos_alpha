{
  "module_name": "dice-midi.c",
  "hash_id": "f0375cc76e595cccfc7ebcf5180789282cf82ac50979e538f225b4eb4653ed64",
  "original_prompt": "Ingested from linux-6.6.14/sound/firewire/dice/dice-midi.c",
  "human_readable_source": "\n \n#include \"dice.h\"\n\nstatic int midi_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_dice *dice = substream->rmidi->private_data;\n\tint err;\n\n\terr = snd_dice_stream_lock_try(dice);\n\tif (err < 0)\n\t\treturn err;\n\n\tmutex_lock(&dice->mutex);\n\n\terr = snd_dice_stream_reserve_duplex(dice, 0, 0, 0);\n\tif (err >= 0) {\n\t\t++dice->substreams_counter;\n\t\terr = snd_dice_stream_start_duplex(dice);\n\t\tif (err < 0)\n\t\t\t--dice->substreams_counter;\n\t}\n\n\tmutex_unlock(&dice->mutex);\n\n\tif (err < 0)\n\t\tsnd_dice_stream_lock_release(dice);\n\n\treturn err;\n}\n\nstatic int midi_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_dice *dice = substream->rmidi->private_data;\n\n\tmutex_lock(&dice->mutex);\n\n\t--dice->substreams_counter;\n\tsnd_dice_stream_stop_duplex(dice);\n\n\tmutex_unlock(&dice->mutex);\n\n\tsnd_dice_stream_lock_release(dice);\n\treturn 0;\n}\n\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substrm, int up)\n{\n\tstruct snd_dice *dice = substrm->rmidi->private_data;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dice->lock, flags);\n\n\tif (up)\n\t\tamdtp_am824_midi_trigger(&dice->tx_stream[0],\n\t\t\t\t\t  substrm->number, substrm);\n\telse\n\t\tamdtp_am824_midi_trigger(&dice->tx_stream[0],\n\t\t\t\t\t  substrm->number, NULL);\n\n\tspin_unlock_irqrestore(&dice->lock, flags);\n}\n\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substrm, int up)\n{\n\tstruct snd_dice *dice = substrm->rmidi->private_data;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dice->lock, flags);\n\n\tif (up)\n\t\tamdtp_am824_midi_trigger(&dice->rx_stream[0],\n\t\t\t\t\t substrm->number, substrm);\n\telse\n\t\tamdtp_am824_midi_trigger(&dice->rx_stream[0],\n\t\t\t\t\t substrm->number, NULL);\n\n\tspin_unlock_irqrestore(&dice->lock, flags);\n}\n\nstatic void set_midi_substream_names(struct snd_dice *dice,\n\t\t\t\t     struct snd_rawmidi_str *str)\n{\n\tstruct snd_rawmidi_substream *subs;\n\n\tlist_for_each_entry(subs, &str->substreams, list) {\n\t\tscnprintf(subs->name, sizeof(subs->name),\n\t\t\t  \"%s MIDI %d\", dice->card->shortname, subs->number + 1);\n\t}\n}\n\nint snd_dice_create_midi(struct snd_dice *dice)\n{\n\tstatic const struct snd_rawmidi_ops capture_ops = {\n\t\t.open\t\t= midi_open,\n\t\t.close\t\t= midi_close,\n\t\t.trigger\t= midi_capture_trigger,\n\t};\n\tstatic const struct snd_rawmidi_ops playback_ops = {\n\t\t.open\t\t= midi_open,\n\t\t.close\t\t= midi_close,\n\t\t.trigger\t= midi_playback_trigger,\n\t};\n\tstruct snd_rawmidi *rmidi;\n\tstruct snd_rawmidi_str *str;\n\tunsigned int midi_in_ports, midi_out_ports;\n\tint i;\n\tint err;\n\n\tmidi_in_ports = 0;\n\tmidi_out_ports = 0;\n\tfor (i = 0; i < MAX_STREAMS; ++i) {\n\t\tmidi_in_ports = max(midi_in_ports, dice->tx_midi_ports[i]);\n\t\tmidi_out_ports = max(midi_out_ports, dice->rx_midi_ports[i]);\n\t}\n\n\tif (midi_in_ports + midi_out_ports == 0)\n\t\treturn 0;\n\n\t \n\terr = snd_rawmidi_new(dice->card, dice->card->driver, 0,\n\t\t\t      midi_out_ports, midi_in_ports,\n\t\t\t      &rmidi);\n\tif (err < 0)\n\t\treturn err;\n\n\tsnprintf(rmidi->name, sizeof(rmidi->name),\n\t\t \"%s MIDI\", dice->card->shortname);\n\trmidi->private_data = dice;\n\n\tif (midi_in_ports > 0) {\n\t\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\n\n\t\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\n\t\t\t\t    &capture_ops);\n\n\t\tstr = &rmidi->streams[SNDRV_RAWMIDI_STREAM_INPUT];\n\n\t\tset_midi_substream_names(dice, str);\n\t}\n\n\tif (midi_out_ports > 0) {\n\t\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\n\n\t\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\n\t\t\t\t    &playback_ops);\n\n\t\tstr = &rmidi->streams[SNDRV_RAWMIDI_STREAM_OUTPUT];\n\n\t\tset_midi_substream_names(dice, str);\n\t}\n\n\tif ((midi_out_ports > 0) && (midi_in_ports > 0))\n\t\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}