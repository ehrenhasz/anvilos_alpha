{
  "module_name": "pxa2xx-pcm-lib.c",
  "hash_id": "1f11f20bbfb16432c8aed7c32a945cda8c6c0187f9e59c71d263c637d743b3c5",
  "original_prompt": "Ingested from linux-6.6.14/sound/arm/pxa2xx-pcm-lib.c",
  "human_readable_source": "\n\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/dma-mapping.h>\n#include <linux/dmaengine.h>\n#include <linux/dma/pxa-dma.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/pxa2xx-lib.h>\n#include <sound/dmaengine_pcm.h>\n\nstatic const struct snd_pcm_hardware pxa2xx_pcm_hardware = {\n\t.info\t\t\t= SNDRV_PCM_INFO_MMAP |\n\t\t\t\t  SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t\t  SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t\t  SNDRV_PCM_INFO_PAUSE |\n\t\t\t\t  SNDRV_PCM_INFO_RESUME,\n\t.formats\t\t= SNDRV_PCM_FMTBIT_S16_LE |\n\t\t\t\t  SNDRV_PCM_FMTBIT_S24_LE |\n\t\t\t\t  SNDRV_PCM_FMTBIT_S32_LE,\n\t.period_bytes_min\t= 32,\n\t.period_bytes_max\t= 8192 - 32,\n\t.periods_min\t\t= 1,\n\t.periods_max\t\t= 256,\n\t.buffer_bytes_max\t= 128 * 1024,\n\t.fifo_size\t\t= 32,\n};\n\nint pxa2xx_pcm_hw_params(struct snd_pcm_substream *substream,\n\t\t\t struct snd_pcm_hw_params *params)\n{\n\tstruct dma_chan *chan = snd_dmaengine_pcm_get_chan(substream);\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tstruct snd_dmaengine_dai_dma_data *dma_params;\n\tstruct dma_slave_config config;\n\tint ret;\n\n\tdma_params = snd_soc_dai_get_dma_data(asoc_rtd_to_cpu(rtd, 0), substream);\n\tif (!dma_params)\n\t\treturn 0;\n\n\tret = snd_hwparams_to_dma_slave_config(substream, params, &config);\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_dmaengine_pcm_set_config_from_dai_data(substream,\n\t\t\tsnd_soc_dai_get_dma_data(asoc_rtd_to_cpu(rtd, 0), substream),\n\t\t\t&config);\n\n\tret = dmaengine_slave_config(chan, &config);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(pxa2xx_pcm_hw_params);\n\nint pxa2xx_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\n{\n\treturn snd_dmaengine_pcm_trigger(substream, cmd);\n}\nEXPORT_SYMBOL(pxa2xx_pcm_trigger);\n\nsnd_pcm_uframes_t\npxa2xx_pcm_pointer(struct snd_pcm_substream *substream)\n{\n\treturn snd_dmaengine_pcm_pointer(substream);\n}\nEXPORT_SYMBOL(pxa2xx_pcm_pointer);\n\nint pxa2xx_pcm_prepare(struct snd_pcm_substream *substream)\n{\n\treturn 0;\n}\nEXPORT_SYMBOL(pxa2xx_pcm_prepare);\n\nint pxa2xx_pcm_open(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_dmaengine_dai_dma_data *dma_params;\n\tint ret;\n\n\truntime->hw = pxa2xx_pcm_hardware;\n\n\tdma_params = snd_soc_dai_get_dma_data(asoc_rtd_to_cpu(rtd, 0), substream);\n\tif (!dma_params)\n\t\treturn 0;\n\n\t \n\tret = snd_pcm_hw_constraint_step(runtime, 0,\n\t\tSNDRV_PCM_HW_PARAM_PERIOD_BYTES, 32);\n\tif (ret)\n\t\treturn ret;\n\n\tret = snd_pcm_hw_constraint_step(runtime, 0,\n\t\tSNDRV_PCM_HW_PARAM_BUFFER_BYTES, 32);\n\tif (ret)\n\t\treturn ret;\n\n\tret = snd_pcm_hw_constraint_integer(runtime,\n\t\t\t\t\t    SNDRV_PCM_HW_PARAM_PERIODS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn snd_dmaengine_pcm_open(\n\t\tsubstream, dma_request_slave_channel(asoc_rtd_to_cpu(rtd, 0)->dev,\n\t\t\t\t\t\t     dma_params->chan_name));\n}\nEXPORT_SYMBOL(pxa2xx_pcm_open);\n\nint pxa2xx_pcm_close(struct snd_pcm_substream *substream)\n{\n\treturn snd_dmaengine_pcm_close_release_chan(substream);\n}\nEXPORT_SYMBOL(pxa2xx_pcm_close);\n\nint pxa2xx_pcm_preallocate_dma_buffer(struct snd_pcm *pcm)\n{\n\tsize_t size = pxa2xx_pcm_hardware.buffer_bytes_max;\n\n\treturn snd_pcm_set_fixed_buffer_all(pcm, SNDRV_DMA_TYPE_DEV_WC,\n\t\t\t\t\t    pcm->card->dev, size);\n}\nEXPORT_SYMBOL(pxa2xx_pcm_preallocate_dma_buffer);\n\nint pxa2xx_soc_pcm_new(struct snd_soc_component *component,\n\t\t       struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_card *card = rtd->card->snd_card;\n\tstruct snd_pcm *pcm = rtd->pcm;\n\tint ret;\n\n\tret = dma_coerce_mask_and_coherent(card->dev, DMA_BIT_MASK(32));\n\tif (ret)\n\t\treturn ret;\n\n\treturn pxa2xx_pcm_preallocate_dma_buffer(pcm);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_new);\n\nint pxa2xx_soc_pcm_open(struct snd_soc_component *component,\n\t\t\tstruct snd_pcm_substream *substream)\n{\n\treturn pxa2xx_pcm_open(substream);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_open);\n\nint pxa2xx_soc_pcm_close(struct snd_soc_component *component,\n\t\t\t struct snd_pcm_substream *substream)\n{\n\treturn pxa2xx_pcm_close(substream);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_close);\n\nint pxa2xx_soc_pcm_hw_params(struct snd_soc_component *component,\n\t\t\t     struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\treturn pxa2xx_pcm_hw_params(substream, params);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_hw_params);\n\nint pxa2xx_soc_pcm_prepare(struct snd_soc_component *component,\n\t\t\t   struct snd_pcm_substream *substream)\n{\n\treturn pxa2xx_pcm_prepare(substream);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_prepare);\n\nint pxa2xx_soc_pcm_trigger(struct snd_soc_component *component,\n\t\t\t   struct snd_pcm_substream *substream, int cmd)\n{\n\treturn pxa2xx_pcm_trigger(substream, cmd);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_trigger);\n\nsnd_pcm_uframes_t\npxa2xx_soc_pcm_pointer(struct snd_soc_component *component,\n\t\t       struct snd_pcm_substream *substream)\n{\n\treturn pxa2xx_pcm_pointer(substream);\n}\nEXPORT_SYMBOL(pxa2xx_soc_pcm_pointer);\n\nMODULE_AUTHOR(\"Nicolas Pitre\");\nMODULE_DESCRIPTION(\"Intel PXA2xx sound library\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}