{
  "module_name": "pxa2xx-ac97.c",
  "hash_id": "5ceb486682fc5947801d7c0c164f4d17300463c1616c04ffa02286d654d388db",
  "original_prompt": "Ingested from linux-6.6.14/sound/arm/pxa2xx-ac97.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/dmaengine.h>\n#include <linux/dma-mapping.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/ac97_codec.h>\n#include <sound/initval.h>\n#include <sound/pxa2xx-lib.h>\n#include <sound/dmaengine_pcm.h>\n\n#include <linux/platform_data/asoc-pxa.h>\n\nstatic void pxa2xx_ac97_legacy_reset(struct snd_ac97 *ac97)\n{\n\tif (!pxa2xx_ac97_try_cold_reset())\n\t\tpxa2xx_ac97_try_warm_reset();\n\n\tpxa2xx_ac97_finish_reset();\n}\n\nstatic unsigned short pxa2xx_ac97_legacy_read(struct snd_ac97 *ac97,\n\t\t\t\t\t      unsigned short reg)\n{\n\tint ret;\n\n\tret = pxa2xx_ac97_read(ac97->num, reg);\n\tif (ret < 0)\n\t\treturn 0;\n\telse\n\t\treturn (unsigned short)(ret & 0xffff);\n}\n\nstatic void pxa2xx_ac97_legacy_write(struct snd_ac97 *ac97,\n\t\t\t\t     unsigned short reg, unsigned short val)\n{\n\tpxa2xx_ac97_write(ac97->num, reg, val);\n}\n\nstatic const struct snd_ac97_bus_ops pxa2xx_ac97_ops = {\n\t.read\t= pxa2xx_ac97_legacy_read,\n\t.write\t= pxa2xx_ac97_legacy_write,\n\t.reset\t= pxa2xx_ac97_legacy_reset,\n};\n\nstatic struct snd_pcm *pxa2xx_ac97_pcm;\nstatic struct snd_ac97 *pxa2xx_ac97_ac97;\n\nstatic int pxa2xx_ac97_pcm_open(struct snd_pcm_substream *substream)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tpxa2xx_audio_ops_t *platform_ops;\n\tint ret, i;\n\n\tret = pxa2xx_pcm_open(substream);\n\tif (ret)\n\t\treturn ret;\n\n\truntime->hw.channels_min = 2;\n\truntime->hw.channels_max = 2;\n\n\ti = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) ?\n\t\tAC97_RATES_FRONT_DAC : AC97_RATES_ADC;\n\truntime->hw.rates = pxa2xx_ac97_ac97->rates[i];\n\tsnd_pcm_limit_hw_rates(runtime);\n\n\tplatform_ops = substream->pcm->card->dev->platform_data;\n\tif (platform_ops && platform_ops->startup) {\n\t\tret = platform_ops->startup(substream, platform_ops->priv);\n\t\tif (ret < 0)\n\t\t\tpxa2xx_pcm_close(substream);\n\t}\n\n\treturn ret;\n}\n\nstatic int pxa2xx_ac97_pcm_close(struct snd_pcm_substream *substream)\n{\n\tpxa2xx_audio_ops_t *platform_ops;\n\n\tplatform_ops = substream->pcm->card->dev->platform_data;\n\tif (platform_ops && platform_ops->shutdown)\n\t\tplatform_ops->shutdown(substream, platform_ops->priv);\n\n\treturn 0;\n}\n\nstatic int pxa2xx_ac97_pcm_prepare(struct snd_pcm_substream *substream)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tint reg = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) ?\n\t\t  AC97_PCM_FRONT_DAC_RATE : AC97_PCM_LR_ADC_RATE;\n\tint ret;\n\n\tret = pxa2xx_pcm_prepare(substream);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn snd_ac97_set_rate(pxa2xx_ac97_ac97, reg, runtime->rate);\n}\n\n#ifdef CONFIG_PM_SLEEP\n\nstatic int pxa2xx_ac97_do_suspend(struct snd_card *card)\n{\n\tpxa2xx_audio_ops_t *platform_ops = card->dev->platform_data;\n\n\tsnd_power_change_state(card, SNDRV_CTL_POWER_D3cold);\n\tsnd_ac97_suspend(pxa2xx_ac97_ac97);\n\tif (platform_ops && platform_ops->suspend)\n\t\tplatform_ops->suspend(platform_ops->priv);\n\n\treturn pxa2xx_ac97_hw_suspend();\n}\n\nstatic int pxa2xx_ac97_do_resume(struct snd_card *card)\n{\n\tpxa2xx_audio_ops_t *platform_ops = card->dev->platform_data;\n\tint rc;\n\n\trc = pxa2xx_ac97_hw_resume();\n\tif (rc)\n\t\treturn rc;\n\n\tif (platform_ops && platform_ops->resume)\n\t\tplatform_ops->resume(platform_ops->priv);\n\tsnd_ac97_resume(pxa2xx_ac97_ac97);\n\tsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\n\n\treturn 0;\n}\n\nstatic int pxa2xx_ac97_suspend(struct device *dev)\n{\n\tstruct snd_card *card = dev_get_drvdata(dev);\n\tint ret = 0;\n\n\tif (card)\n\t\tret = pxa2xx_ac97_do_suspend(card);\n\n\treturn ret;\n}\n\nstatic int pxa2xx_ac97_resume(struct device *dev)\n{\n\tstruct snd_card *card = dev_get_drvdata(dev);\n\tint ret = 0;\n\n\tif (card)\n\t\tret = pxa2xx_ac97_do_resume(card);\n\n\treturn ret;\n}\n\nstatic SIMPLE_DEV_PM_OPS(pxa2xx_ac97_pm_ops, pxa2xx_ac97_suspend, pxa2xx_ac97_resume);\n#endif\n\nstatic const struct snd_pcm_ops pxa2xx_ac97_pcm_ops = {\n\t.open\t\t= pxa2xx_ac97_pcm_open,\n\t.close\t\t= pxa2xx_ac97_pcm_close,\n\t.hw_params\t= pxa2xx_pcm_hw_params,\n\t.prepare\t= pxa2xx_ac97_pcm_prepare,\n\t.trigger\t= pxa2xx_pcm_trigger,\n\t.pointer\t= pxa2xx_pcm_pointer,\n};\n\n\nstatic int pxa2xx_ac97_pcm_new(struct snd_card *card)\n{\n\tstruct snd_pcm *pcm;\n\tint ret;\n\n\tret = snd_pcm_new(card, \"PXA2xx-PCM\", 0, 1, 1, &pcm);\n\tif (ret)\n\t\tgoto out;\n\n\tret = dma_coerce_mask_and_coherent(card->dev, DMA_BIT_MASK(32));\n\tif (ret)\n\t\tgoto out;\n\n\tsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, &pxa2xx_ac97_pcm_ops);\n\tsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &pxa2xx_ac97_pcm_ops);\n\tret = pxa2xx_pcm_preallocate_dma_buffer(pcm);\n\tif (ret)\n\t\tgoto out;\n\n\tpxa2xx_ac97_pcm = pcm;\n\tret = 0;\n\n out:\n\treturn ret;\n}\n\nstatic int pxa2xx_ac97_probe(struct platform_device *dev)\n{\n\tstruct snd_card *card;\n\tstruct snd_ac97_bus *ac97_bus;\n\tstruct snd_ac97_template ac97_template;\n\tint ret;\n\tpxa2xx_audio_ops_t *pdata = dev->dev.platform_data;\n\n\tif (dev->id >= 0) {\n\t\tdev_err(&dev->dev, \"PXA2xx has only one AC97 port.\\n\");\n\t\tret = -ENXIO;\n\t\tgoto err_dev;\n\t}\n\n\tret = snd_card_new(&dev->dev, SNDRV_DEFAULT_IDX1, SNDRV_DEFAULT_STR1,\n\t\t\t   THIS_MODULE, 0, &card);\n\tif (ret < 0)\n\t\tgoto err;\n\n\tstrscpy(card->driver, dev->dev.driver->name, sizeof(card->driver));\n\n\tret = pxa2xx_ac97_pcm_new(card);\n\tif (ret)\n\t\tgoto err;\n\n\tret = pxa2xx_ac97_hw_probe(dev);\n\tif (ret)\n\t\tgoto err;\n\n\tret = snd_ac97_bus(card, 0, &pxa2xx_ac97_ops, NULL, &ac97_bus);\n\tif (ret)\n\t\tgoto err_remove;\n\tmemset(&ac97_template, 0, sizeof(ac97_template));\n\tret = snd_ac97_mixer(ac97_bus, &ac97_template, &pxa2xx_ac97_ac97);\n\tif (ret)\n\t\tgoto err_remove;\n\n\tsnprintf(card->shortname, sizeof(card->shortname),\n\t\t \"%s\", snd_ac97_get_short_name(pxa2xx_ac97_ac97));\n\tsnprintf(card->longname, sizeof(card->longname),\n\t\t \"%s (%s)\", dev->dev.driver->name, card->mixername);\n\n\tif (pdata && pdata->codec_pdata[0])\n\t\tsnd_ac97_dev_add_pdata(ac97_bus->codec[0], pdata->codec_pdata[0]);\n\tret = snd_card_register(card);\n\tif (ret == 0) {\n\t\tplatform_set_drvdata(dev, card);\n\t\treturn 0;\n\t}\n\nerr_remove:\n\tpxa2xx_ac97_hw_remove(dev);\nerr:\n\tif (card)\n\t\tsnd_card_free(card);\nerr_dev:\n\treturn ret;\n}\n\nstatic void pxa2xx_ac97_remove(struct platform_device *dev)\n{\n\tstruct snd_card *card = platform_get_drvdata(dev);\n\n\tif (card) {\n\t\tsnd_card_free(card);\n\t\tpxa2xx_ac97_hw_remove(dev);\n\t}\n}\n\nstatic struct platform_driver pxa2xx_ac97_driver = {\n\t.probe\t\t= pxa2xx_ac97_probe,\n\t.remove_new\t= pxa2xx_ac97_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"pxa2xx-ac97\",\n#ifdef CONFIG_PM_SLEEP\n\t\t.pm\t= &pxa2xx_ac97_pm_ops,\n#endif\n\t},\n};\n\nmodule_platform_driver(pxa2xx_ac97_driver);\n\nMODULE_AUTHOR(\"Nicolas Pitre\");\nMODULE_DESCRIPTION(\"AC97 driver for the Intel PXA2xx chip\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:pxa2xx-ac97\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}