{
  "module_name": "au88x0_mpu401.c",
  "hash_id": "01cad5783739d09bb25b1fb5a24a737e9e140cd6cc4c72196c5951c2dfd036fd",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/au88x0/au88x0_mpu401.c",
  "human_readable_source": "\n \n\n#include <linux/time.h>\n#include <linux/init.h>\n#include <sound/core.h>\n#include <sound/mpu401.h>\n#include \"au88x0.h\"\n\n \n \n#ifndef MPU401_HW_AUREAL\n#define VORTEX_MPU401_LEGACY\n#endif\n\n \n#define MIDI_CLOCK_DIV      0x61\n \n#define MPU401_RESET\t\t0xff\n#define MPU401_ENTER_UART\t0x3f\n#define MPU401_ACK\t\t    0xfe\n\nstatic int snd_vortex_midi(vortex_t *vortex)\n{\n\tstruct snd_rawmidi *rmidi;\n\tint temp, mode;\n\tstruct snd_mpu401 *mpu;\n\tunsigned long port;\n\n#ifdef VORTEX_MPU401_LEGACY\n\t \n\t \n\tport = (0x03 << 5);\t \n\ttemp =\n\t    (hwread(vortex->mmio, VORTEX_CTRL) & ~CTRL_MIDI_PORT) |\n\t    CTRL_MIDI_EN | port;\n\thwwrite(vortex->mmio, VORTEX_CTRL, temp);\n#else\n\t \n\ttemp =\n\t    (hwread(vortex->mmio, VORTEX_CTRL) & ~CTRL_MIDI_PORT) &\n\t    ~CTRL_MIDI_EN;\n\thwwrite(vortex->mmio, VORTEX_CTRL, temp);\n#endif\n\t \n\tmode = 1;\n\ttemp = hwread(vortex->mmio, VORTEX_CTRL2) & 0xffff00cf;\n\ttemp |= (MIDI_CLOCK_DIV << 8) | ((mode >> 24) & 0xff) << 4;\n\thwwrite(vortex->mmio, VORTEX_CTRL2, temp);\n\thwwrite(vortex->mmio, VORTEX_MIDI_CMD, MPU401_RESET);\n\n\t \n\ttemp = hwread(vortex->mmio, VORTEX_MIDI_DATA);\n\tif (temp != MPU401_ACK   ) {\n\t\tdev_err(vortex->card->dev, \"midi port doesn't acknowledge!\\n\");\n\t\treturn -ENODEV;\n\t}\n\t \n\thwwrite(vortex->mmio, VORTEX_IRQ_CTRL,\n\t\thwread(vortex->mmio, VORTEX_IRQ_CTRL) | IRQ_MIDI);\n\n\t \n#ifdef VORTEX_MPU401_LEGACY\n\ttemp = snd_mpu401_uart_new(vortex->card, 0, MPU401_HW_MPU401, 0x330,\n\t\t\t\t   MPU401_INFO_IRQ_HOOK, -1, &rmidi);\n\tif (temp) {\n\t\thwwrite(vortex->mmio, VORTEX_CTRL,\n\t\t\t(hwread(vortex->mmio, VORTEX_CTRL) &\n\t\t\t ~CTRL_MIDI_PORT) & ~CTRL_MIDI_EN);\n\t\treturn temp;\n\t}\n#else\n\tport = (unsigned long)(vortex->mmio + VORTEX_MIDI_DATA);\n\ttemp = snd_mpu401_uart_new(vortex->card, 0, MPU401_HW_AUREAL, port,\n\t\t\t\t   MPU401_INFO_INTEGRATED | MPU401_INFO_MMIO |\n\t\t\t\t   MPU401_INFO_IRQ_HOOK, -1, &rmidi);\n\tif (temp) {\n\t\thwwrite(vortex->mmio, VORTEX_CTRL,\n\t\t\t(hwread(vortex->mmio, VORTEX_CTRL) &\n\t\t\t ~CTRL_MIDI_PORT) & ~CTRL_MIDI_EN);\n\t\treturn temp;\n\t}\n\tmpu = rmidi->private_data;\n\tmpu->cport = (unsigned long)(vortex->mmio + VORTEX_MIDI_CMD);\n#endif\n\t \n\tsnprintf(rmidi->name, sizeof(rmidi->name), \"%s MIDI %d\", CARD_NAME_SHORT , vortex->card->number);\n\n\tvortex->rmidi = rmidi;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}