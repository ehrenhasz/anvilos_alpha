{
  "module_name": "au88x0_synth.c",
  "hash_id": "1b19074da9aca24d64e0a86603a9eed65b916e07547653f8e5e88fb5d364ebf1",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/au88x0/au88x0_synth.c",
  "human_readable_source": "\n \n\n \n\n#include \"au88x0.h\"\n#include \"au88x0_wt.h\"\n\nstatic void vortex_fifo_setwtvalid(vortex_t * vortex, int fifo, int en);\nstatic void vortex_connection_adb_mixin(vortex_t * vortex, int en,\n\t\t\t\t\tunsigned char channel,\n\t\t\t\t\tunsigned char source,\n\t\t\t\t\tunsigned char mixin);\nstatic void vortex_connection_mixin_mix(vortex_t * vortex, int en,\n\t\t\t\t\tunsigned char mixin,\n\t\t\t\t\tunsigned char mix, int a);\nstatic void vortex_fifo_wtinitialize(vortex_t * vortex, int fifo, int j);\nstatic int vortex_wt_SetReg(vortex_t * vortex, unsigned char reg, int wt,\n\t\t\t    u32 val);\n\n \n\n \nstatic void vortex_wt_setstereo(vortex_t * vortex, u32 wt, u32 stereo)\n{\n\tint temp;\n\n\t\n\ttemp = hwread(vortex->mmio, WT_STEREO(wt));\n\ttemp = (temp & 0xfe) | (stereo & 1);\n\t\n\thwwrite(vortex->mmio, WT_STEREO(wt), temp);\n}\n\n \nstatic void vortex_wt_setdsout(vortex_t * vortex, u32 wt, int en)\n{\n\tint temp;\n\n\t \n\ttemp = hwread(vortex->mmio, WT_DSREG((wt >= 0x20) ? 1 : 0));\n\tif (en)\n\t\ttemp |= (1 << (wt & 0x1f));\n\telse\n\t\ttemp &= ~(1 << (wt & 0x1f));\n\thwwrite(vortex->mmio, WT_DSREG((wt >= 0x20) ? 1 : 0), temp);\n}\n\n \nstatic int vortex_wt_allocroute(vortex_t * vortex, int wt, int nr_ch)\n{\n\twt_voice_t *voice = &(vortex->wt_voice[wt]);\n\tint temp;\n\n\t\n\tif (nr_ch) {\n\t\tvortex_fifo_wtinitialize(vortex, wt, 1);\n\t\tvortex_fifo_setwtvalid(vortex, wt, 1);\n\t\tvortex_wt_setstereo(vortex, wt, nr_ch - 1);\n\t} else\n\t\tvortex_fifo_setwtvalid(vortex, wt, 0);\n\t\n\t \n\tvortex_wt_setdsout(vortex, wt, 1);\n\t \n\thwwrite(vortex->mmio, WT_SRAMP(0), 0x880000);\n\t\n#ifdef CHIP_AU8830\n\thwwrite(vortex->mmio, WT_SRAMP(1), 0x880000);\n\t\n#endif\n\thwwrite(vortex->mmio, WT_PARM(wt, 0), 0);\n\thwwrite(vortex->mmio, WT_PARM(wt, 1), 0);\n\thwwrite(vortex->mmio, WT_PARM(wt, 2), 0);\n\n\ttemp = hwread(vortex->mmio, WT_PARM(wt, 3));\n\tdev_dbg(vortex->card->dev, \"WT PARM3: %x\\n\", temp);\n\t\n\n\thwwrite(vortex->mmio, WT_DELAY(wt, 0), 0);\n\thwwrite(vortex->mmio, WT_DELAY(wt, 1), 0);\n\thwwrite(vortex->mmio, WT_DELAY(wt, 2), 0);\n\thwwrite(vortex->mmio, WT_DELAY(wt, 3), 0);\n\n\tdev_dbg(vortex->card->dev, \"WT GMODE: %x\\n\",\n\t\thwread(vortex->mmio, WT_GMODE(wt)));\n\n\thwwrite(vortex->mmio, WT_PARM(wt, 2), 0xffffffff);\n\thwwrite(vortex->mmio, WT_PARM(wt, 3), 0xcff1c810);\n\n\tvoice->parm0 = voice->parm1 = 0xcfb23e2f;\n\thwwrite(vortex->mmio, WT_PARM(wt, 0), voice->parm0);\n\thwwrite(vortex->mmio, WT_PARM(wt, 1), voice->parm1);\n\tdev_dbg(vortex->card->dev, \"WT GMODE 2 : %x\\n\",\n\t\thwread(vortex->mmio, WT_GMODE(wt)));\n\treturn 0;\n}\n\n\nstatic void vortex_wt_connect(vortex_t * vortex, int en)\n{\n\tint i, ii, mix;\n\n#define NR_WTROUTES 6\n#ifdef CHIP_AU8830\n#define NR_WTBLOCKS 2\n#else\n#define NR_WTBLOCKS 1\n#endif\n\n\tfor (i = 0; i < NR_WTBLOCKS; i++) {\n\t\tfor (ii = 0; ii < NR_WTROUTES; ii++) {\n\t\t\tmix =\n\t\t\t    vortex_adb_checkinout(vortex,\n\t\t\t\t\t\t  vortex->fixed_res, en,\n\t\t\t\t\t\t  VORTEX_RESOURCE_MIXIN);\n\t\t\tvortex->mixwt[(i * NR_WTROUTES) + ii] = mix;\n\n\t\t\tvortex_route(vortex, en, 0x11,\n\t\t\t\t     ADB_WTOUT(i, ii + 0x20), ADB_MIXIN(mix));\n\n\t\t\tvortex_connection_mixin_mix(vortex, en, mix,\n\t\t\t\t\t\t    vortex->mixplayb[ii % 2], 0);\n\t\t\tif (VORTEX_IS_QUAD(vortex))\n\t\t\t\tvortex_connection_mixin_mix(vortex, en,\n\t\t\t\t\t\t\t    mix,\n\t\t\t\t\t\t\t    vortex->mixplayb[2 +\n\t\t\t\t\t\t\t\t     (ii % 2)], 0);\n\t\t}\n\t}\n\tfor (i = 0; i < NR_WT; i++) {\n\t\thwwrite(vortex->mmio, WT_RUN(i), 1);\n\t}\n}\n\n \n#if 0\nstatic int vortex_wt_GetReg(vortex_t * vortex, char reg, int wt)\n{\n\t\n\n\tif (reg == 4) {\n\t\treturn hwread(vortex->mmio, WT_PARM(wt, 3));\n\t}\n\tif (reg == 7) {\n\t\treturn hwread(vortex->mmio, WT_GMODE(wt));\n\t}\n\n\treturn 0;\n}\n\n \nstatic int\nvortex_wt_SetReg2(vortex_t * vortex, unsigned char reg, int wt,\n\t\t  u16 val)\n{\n\t \n\treturn 1;\n}\n\n \n#endif\nstatic int\nvortex_wt_SetReg(vortex_t * vortex, unsigned char reg, int wt,\n\t\t u32 val)\n{\n\tint ecx;\n\n\tif ((reg == 5) || ((reg >= 7) && (reg <= 10)) || (reg == 0xc)) {\n\t\tif (wt >= (NR_WT / NR_WT_PB)) {\n\t\t\tdev_warn(vortex->card->dev,\n\t\t\t\t \"WT SetReg: bank out of range. reg=0x%x, wt=%d\\n\",\n\t\t\t\t reg, wt);\n\t\t\treturn 0;\n\t\t}\n\t} else {\n\t\tif (wt >= NR_WT) {\n\t\t\tdev_err(vortex->card->dev,\n\t\t\t\t\"WT SetReg: voice out of range\\n\");\n\t\t\treturn 0;\n\t\t}\n\t}\n\tif (reg > 0xc)\n\t\treturn 0;\n\n\tswitch (reg) {\n\t\t \n\tcase 0:\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_RUN(wt), val);\n\t\treturn 0xc;\n\tcase 1:\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_PARM(wt, 0), val);\n\t\treturn 0xc;\n\tcase 2:\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_PARM(wt, 1), val);\n\t\treturn 0xc;\n\tcase 3:\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_PARM(wt, 2), val);\n\t\treturn 0xc;\n\tcase 4:\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_PARM(wt, 3), val);\n\t\treturn 0xc;\n\tcase 6:\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_MUTE(wt), val);\n\t\treturn 0xc;\n\tcase 0xb:\n\t\t\t \n\t\t \n\t\thwwrite(vortex->mmio, WT_DELAY(wt, 3), val);\n\t\thwwrite(vortex->mmio, WT_DELAY(wt, 2), val);\n\t\thwwrite(vortex->mmio, WT_DELAY(wt, 1), val);\n\t\thwwrite(vortex->mmio, WT_DELAY(wt, 0), val);\n\t\treturn 0xc;\n\t\t \n\tcase 5:\t\t \n\t\tecx = WT_SRAMP(wt);\n\t\tbreak;\n\tcase 8:\t\t \n\t\tecx = WT_ARAMP(wt);\n\t\tbreak;\n\tcase 9:\t\t \n\t\tecx = WT_MRAMP(wt);\n\t\tbreak;\n\tcase 0xa:\t\t \n\t\tecx = WT_CTRL(wt);\n\t\tbreak;\n\tcase 0xc:\t\t \n\t\tecx = WT_DSREG(wt);\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\t \n\thwwrite(vortex->mmio, ecx, val);\n\treturn 1;\n}\n\nstatic void vortex_wt_init(vortex_t * vortex)\n{\n\tu32 var4, var8, varc, var10 = 0, edi;\n\n\tvar10 &= 0xFFFFFFE3;\n\tvar10 |= 0x22;\n\tvar10 &= 0xFFFFFEBF;\n\tvar10 |= 0x80;\n\tvar10 |= 0x200;\n\tvar10 &= 0xfffffffe;\n\tvar10 &= 0xfffffbff;\n\tvar10 |= 0x1800;\n\t\n\tvar4 = 0x10000000;\n\tvarc = 0x00830000;\n\tvar8 = 0x00830000;\n\n\t \n\tfor (edi = 0; edi < (NR_WT / NR_WT_PB); edi++) {\n\t\tvortex_wt_SetReg(vortex, 0xc, edi, 0);\t \n\t\tvortex_wt_SetReg(vortex, 0xa, edi, var10);\t \n\t\tvortex_wt_SetReg(vortex, 0x9, edi, var4);\t \n\t\tvortex_wt_SetReg(vortex, 0x8, edi, varc);\t \n\t\tvortex_wt_SetReg(vortex, 0x5, edi, var8);\t \n\t}\n\t \n\tfor (edi = 0; edi < NR_WT; edi++) {\n\t\tvortex_wt_SetReg(vortex, 0x4, edi, 0);\t \n\t\tvortex_wt_SetReg(vortex, 0x3, edi, 0);\t \n\t\tvortex_wt_SetReg(vortex, 0x2, edi, 0);\t \n\t\tvortex_wt_SetReg(vortex, 0x1, edi, 0);\t \n\t\tvortex_wt_SetReg(vortex, 0xb, edi, 0);\t \n\t}\n\tvar10 |= 1;\n\tfor (edi = 0; edi < (NR_WT / NR_WT_PB); edi++)\n\t\tvortex_wt_SetReg(vortex, 0xa, edi, var10);\t \n}\n\n \n#if 0\nstatic void vortex_wt_SetVolume(vortex_t * vortex, int wt, int vol[])\n{\n\twt_voice_t *voice = &(vortex->wt_voice[wt]);\n\tint ecx = vol[1], eax = vol[0];\n\n\t \n\tvoice->parm0 &= 0xff00ffff;\n\tvoice->parm0 |= (vol[0] & 0xff) << 0x10;\n\tvoice->parm1 &= 0xff00ffff;\n\tvoice->parm1 |= (vol[1] & 0xff) << 0x10;\n\n\t \n\thwwrite(vortex, WT_PARM(wt, 0), voice->parm0);\n\thwwrite(vortex, WT_PARM(wt, 1), voice->parm0);\n\n\tif (voice->this_1D0 & 4) {\n\t\teax >>= 8;\n\t\tecx = eax;\n\t\tif (ecx < 0x80)\n\t\t\tecx = 0x7f;\n\t\tvoice->parm3 &= 0xFFFFC07F;\n\t\tvoice->parm3 |= (ecx & 0x7f) << 7;\n\t\tvoice->parm3 &= 0xFFFFFF80;\n\t\tvoice->parm3 |= (eax & 0x7f);\n\t} else {\n\t\tvoice->parm3 &= 0xFFE03FFF;\n\t\tvoice->parm3 |= (eax & 0xFE00) << 5;\n\t}\n\n\thwwrite(vortex, WT_PARM(wt, 3), voice->parm3);\n}\n\n \nstatic void vortex_wt_SetFrequency(vortex_t * vortex, int wt, unsigned int sr)\n{\n\twt_voice_t *voice = &(vortex->wt_voice[wt]);\n\tu32 eax, edx;\n\n\t\n\teax = ((sr << 0xf) * 0x57619F1) & 0xffffffff;\n\tedx = (((sr << 0xf) * 0x57619F1)) >> 0x20;\n\n\tedx >>= 0xa;\n\tedx <<= 1;\n\tif (edx) {\n\t\tif (edx & 0x0FFF80000)\n\t\t\teax = 0x7fff;\n\t\telse {\n\t\t\tedx <<= 0xd;\n\t\t\teax = 7;\n\t\t\twhile ((edx & 0x80000000) == 0) {\n\t\t\t\tedx <<= 1;\n\t\t\t\teax--;\n\t\t\t\tif (eax == 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (eax)\n\t\t\t\tedx <<= 1;\n\t\t\teax <<= 0xc;\n\t\t\tedx >>= 0x14;\n\t\t\teax |= edx;\n\t\t}\n\t} else\n\t\teax = 0;\n\tvoice->parm0 &= 0xffff0001;\n\tvoice->parm0 |= (eax & 0x7fff) << 1;\n\tvoice->parm1 = voice->parm0 | 1;\n\t\n\t\n\t\n\thwwrite(vortex->mmio, WT_PARM(wt, 0), voice->parm0);\n\thwwrite(vortex->mmio, WT_PARM(wt, 1), voice->parm1);\n}\n#endif\n\n \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}