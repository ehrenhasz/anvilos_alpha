{
  "module_name": "ali5451.c",
  "hash_id": "1df8c3218d35641b6ac9e009d71950b4dafc1a8e7544183f7eedaa4d39015d51",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ali5451/ali5451.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/dma-mapping.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/info.h>\n#include <sound/ac97_codec.h>\n#include <sound/mpu401.h>\n#include <sound/initval.h>\n\nMODULE_AUTHOR(\"Matt Wu <Matt_Wu@acersoftech.com.cn>\");\nMODULE_DESCRIPTION(\"ALI M5451\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int index = SNDRV_DEFAULT_IDX1;\t \nstatic char *id = SNDRV_DEFAULT_STR1;\t \nstatic int pcm_channels = 32;\nstatic bool spdif;\n\nmodule_param(index, int, 0444);\nMODULE_PARM_DESC(index, \"Index value for ALI M5451 PCI Audio.\");\nmodule_param(id, charp, 0444);\nMODULE_PARM_DESC(id, \"ID string for ALI M5451 PCI Audio.\");\nmodule_param(pcm_channels, int, 0444);\nMODULE_PARM_DESC(pcm_channels, \"PCM Channels\");\nmodule_param(spdif, bool, 0444);\nMODULE_PARM_DESC(spdif, \"Support SPDIF I/O\");\n\n \nstatic bool enable;\nmodule_param(enable, bool, 0444);\n\n\n \n\n#define DEVICE_ID_ALI5451\t((PCI_VENDOR_ID_AL<<16)|PCI_DEVICE_ID_AL_M5451)\n\n\n#define ALI_CHANNELS\t\t32\n\n#define ALI_PCM_IN_CHANNEL\t31\n#define ALI_SPDIF_IN_CHANNEL\t19\n#define ALI_SPDIF_OUT_CHANNEL\t15\n#define ALI_CENTER_CHANNEL\t24\n#define ALI_LEF_CHANNEL\t\t23\n#define ALI_SURR_LEFT_CHANNEL\t26\n#define ALI_SURR_RIGHT_CHANNEL\t25\n#define ALI_MODEM_IN_CHANNEL    21\n#define ALI_MODEM_OUT_CHANNEL   20\n\n#define\tSNDRV_ALI_VOICE_TYPE_PCM\t01\n#define SNDRV_ALI_VOICE_TYPE_OTH\t02\n\n#define\tALI_5451_V02\t\t0x02\n\n \n\n#define ALI_LEGACY_DMAR0        0x00   \n#define ALI_LEGACY_DMAR4        0x04   \n#define ALI_LEGACY_DMAR11       0x0b   \n#define ALI_LEGACY_DMAR15       0x0f   \n#define ALI_MPUR0\t\t0x20\n#define ALI_MPUR1\t\t0x21\n#define ALI_MPUR2\t\t0x22\n#define ALI_MPUR3\t\t0x23\n\n#define\tALI_AC97_WRITE\t\t0x40\n#define ALI_AC97_READ\t\t0x44\n\n#define ALI_SCTRL\t\t0x48\n#define   ALI_SPDIF_OUT_ENABLE\t\t0x20\n#define   ALI_SCTRL_LINE_IN2\t\t(1 << 9)\n#define   ALI_SCTRL_GPIO_IN2\t\t(1 << 13)\n#define   ALI_SCTRL_LINE_OUT_EN \t(1 << 20)\n#define   ALI_SCTRL_GPIO_OUT_EN \t(1 << 23)\n#define   ALI_SCTRL_CODEC1_READY\t(1 << 24)\n#define   ALI_SCTRL_CODEC2_READY\t(1 << 25)\n#define ALI_AC97_GPIO\t\t0x4c\n#define   ALI_AC97_GPIO_ENABLE\t\t0x8000\n#define   ALI_AC97_GPIO_DATA_SHIFT\t16\n#define ALI_SPDIF_CS\t\t0x70\n#define ALI_SPDIF_CTRL\t\t0x74\n#define   ALI_SPDIF_IN_FUNC_ENABLE\t0x02\n#define   ALI_SPDIF_IN_CH_STATUS\t0x40\n#define   ALI_SPDIF_OUT_CH_STATUS\t0xbf\n#define ALI_START\t\t0x80\n#define ALI_STOP\t\t0x84\n#define ALI_CSPF\t\t0x90\n#define ALI_AINT\t\t0x98\n#define ALI_GC_CIR\t\t0xa0\n\t#define ENDLP_IE\t\t0x00001000\n\t#define MIDLP_IE\t\t0x00002000\n#define ALI_AINTEN\t\t0xa4\n#define ALI_VOLUME\t\t0xa8\n#define ALI_SBDELTA_DELTA_R     0xac\n#define ALI_MISCINT\t\t0xb0\n\t#define ADDRESS_IRQ\t\t0x00000020\n\t#define TARGET_REACHED\t\t0x00008000\n\t#define MIXER_OVERFLOW\t\t0x00000800\n\t#define MIXER_UNDERFLOW\t\t0x00000400\n\t#define GPIO_IRQ\t\t0x01000000\n#define ALI_SBBL_SBCL           0xc0\n#define ALI_SBCTRL_SBE2R_SBDD   0xc4\n#define ALI_STIMER\t\t0xc8\n#define ALI_GLOBAL_CONTROL\t0xd4\n#define   ALI_SPDIF_OUT_SEL_PCM\t\t0x00000400  \n#define   ALI_SPDIF_IN_SUPPORT\t\t0x00000800  \n#define   ALI_SPDIF_OUT_CH_ENABLE\t0x00008000  \n#define   ALI_SPDIF_IN_CH_ENABLE\t0x00080000  \n#define   ALI_PCM_IN_ENABLE\t\t0x80000000  \n\n#define ALI_CSO_ALPHA_FMS\t0xe0\n#define ALI_LBA\t\t\t0xe4\n#define ALI_ESO_DELTA\t\t0xe8\n#define ALI_GVSEL_PAN_VOC_CTRL_EC\t0xf0\n#define ALI_EBUF1\t\t0xf4\n#define ALI_EBUF2\t\t0xf8\n\n#define ALI_REG(codec, x) ((codec)->port + x)\n\n#define MAX_CODECS 2\n\n\nstruct snd_ali;\nstruct snd_ali_voice;\n\nstruct snd_ali_channel_control {\n\t \n\tstruct REGDATA {\n\t\tunsigned int start;\n\t\tunsigned int stop;\n\t\tunsigned int aint;\n\t\tunsigned int ainten;\n\t} data;\n\t\t\n\t \n\tstruct REGS {\n\t\tunsigned int start;\n\t\tunsigned int stop;\n\t\tunsigned int aint;\n\t\tunsigned int ainten;\n\t\tunsigned int ac97read;\n\t\tunsigned int ac97write;\n\t} regs;\n\n};\n\nstruct snd_ali_voice {\n\tunsigned int number;\n\tunsigned int use :1,\n\t\tpcm :1,\n\t\tmidi :1,\n\t\tmode :1,\n\t\tsynth :1,\n\t\trunning :1;\n\n\t \n\tstruct snd_ali *codec;\n\tstruct snd_pcm_substream *substream;\n\tstruct snd_ali_voice *extra;\n\t\n\tint eso;                 \n\tint count;               \n\n\t \n\n\tvoid *private_data;\n\tvoid (*private_free)(void *private_data);\n};\n\n\nstruct snd_alidev {\n\n\tstruct snd_ali_voice voices[ALI_CHANNELS];\t\n\n\tunsigned int\tchcnt;\t\t\t \n\tunsigned int\tchmap;\t\t\t \n\tunsigned int synthcount;\n\n};\n\n\n#define ALI_GLOBAL_REGS\t\t56\n#define ALI_CHANNEL_REGS\t8\nstruct snd_ali_image {\n\tu32 regs[ALI_GLOBAL_REGS];\n\tu32 channel_regs[ALI_CHANNELS][ALI_CHANNEL_REGS];\n};\n\n\nstruct snd_ali {\n\tint\t\tirq;\n\tunsigned long\tport;\n\tunsigned char\trevision;\n\n\tunsigned int hw_initialized :1;\n\tunsigned int spdif_support :1;\n\n\tstruct pci_dev\t*pci;\n\tstruct pci_dev\t*pci_m1533;\n\tstruct pci_dev\t*pci_m7101;\n\n\tstruct snd_card\t*card;\n\tstruct snd_pcm\t*pcm[MAX_CODECS];\n\tstruct snd_alidev\tsynth;\n\tstruct snd_ali_channel_control chregs;\n\n\t \n\tunsigned int\tspdif_mask;\n\n\tunsigned int spurious_irq_count;\n\tunsigned int spurious_irq_max_delta;\n\n\tunsigned int num_of_codecs;\n\n\tstruct snd_ac97_bus *ac97_bus;\n\tstruct snd_ac97 *ac97[MAX_CODECS];\n\tunsigned short\tac97_ext_id;\n\tunsigned short\tac97_ext_status;\n\n\tspinlock_t\treg_lock;\n\tspinlock_t\tvoice_alloc;\n\n#ifdef CONFIG_PM_SLEEP\n\tstruct snd_ali_image *image;\n#endif\n};\n\nstatic const struct pci_device_id snd_ali_ids[] = {\n\t{PCI_DEVICE(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M5451), 0, 0, 0},\n\t{0, }\n};\nMODULE_DEVICE_TABLE(pci, snd_ali_ids);\n\nstatic void snd_ali_clear_voices(struct snd_ali *, unsigned int, unsigned int);\nstatic unsigned short snd_ali_codec_peek(struct snd_ali *, int, unsigned short);\nstatic void snd_ali_codec_poke(struct snd_ali *, int, unsigned short,\n\t\t\t       unsigned short);\n\n \n\nstatic inline unsigned int snd_ali_5451_peek(struct snd_ali *codec,\n\t\t\t\t\t     unsigned int port)\n{\n\treturn (unsigned int)inl(ALI_REG(codec, port)); \n}\n\nstatic inline void snd_ali_5451_poke(struct snd_ali *codec,\n\t\t\t\t     unsigned int port,\n\t\t\t\t     unsigned int val)\n{\n\toutl((unsigned int)val, ALI_REG(codec, port));\n}\n\nstatic int snd_ali_codec_ready(struct snd_ali *codec,\n\t\t\t       unsigned int port)\n{\n\tunsigned long end_time;\n\tunsigned int res;\n\t\n\tend_time = jiffies + msecs_to_jiffies(250);\n\n\tfor (;;) {\n\t\tres = snd_ali_5451_peek(codec,port);\n\t\tif (!(res & 0x8000))\n\t\t\treturn 0;\n\t\tif (!time_after_eq(end_time, jiffies))\n\t\t\tbreak;\n\t\tschedule_timeout_uninterruptible(1);\n\t}\n\n\tsnd_ali_5451_poke(codec, port, res & ~0x8000);\n\tdev_dbg(codec->card->dev, \"ali_codec_ready: codec is not ready.\\n \");\n\treturn -EIO;\n}\n\nstatic int snd_ali_stimer_ready(struct snd_ali *codec)\n{\n\tunsigned long end_time;\n\tunsigned long dwChk1,dwChk2;\n\t\n\tdwChk1 = snd_ali_5451_peek(codec, ALI_STIMER);\n\tend_time = jiffies + msecs_to_jiffies(250);\n\n\tfor (;;) {\n\t\tdwChk2 = snd_ali_5451_peek(codec, ALI_STIMER);\n\t\tif (dwChk2 != dwChk1)\n\t\t\treturn 0;\n\t\tif (!time_after_eq(end_time, jiffies))\n\t\t\tbreak;\n\t\tschedule_timeout_uninterruptible(1);\n\t}\n\n\tdev_err(codec->card->dev, \"ali_stimer_read: stimer is not ready.\\n\");\n\treturn -EIO;\n}\n\nstatic void snd_ali_codec_poke(struct snd_ali *codec,int secondary,\n\t\t\t       unsigned short reg,\n\t\t\t       unsigned short val)\n{\n\tunsigned int dwVal;\n\tunsigned int port;\n\n\tif (reg >= 0x80) {\n\t\tdev_err(codec->card->dev,\n\t\t\t\"ali_codec_poke: reg(%xh) invalid.\\n\", reg);\n\t\treturn;\n\t}\n\n\tport = codec->chregs.regs.ac97write;\n\n\tif (snd_ali_codec_ready(codec, port) < 0)\n\t\treturn;\n\tif (snd_ali_stimer_ready(codec) < 0)\n\t\treturn;\n\n\tdwVal  = (unsigned int) (reg & 0xff);\n\tdwVal |= 0x8000 | (val << 16);\n\tif (secondary)\n\t\tdwVal |= 0x0080;\n\tif (codec->revision == ALI_5451_V02)\n\t\tdwVal |= 0x0100;\n\n\tsnd_ali_5451_poke(codec, port, dwVal);\n\n\treturn ;\n}\n\nstatic unsigned short snd_ali_codec_peek(struct snd_ali *codec,\n\t\t\t\t\t int secondary,\n\t\t\t\t\t unsigned short reg)\n{\n\tunsigned int dwVal;\n\tunsigned int port;\n\n\tif (reg >= 0x80) {\n\t\tdev_err(codec->card->dev,\n\t\t\t\"ali_codec_peek: reg(%xh) invalid.\\n\", reg);\n\t\treturn ~0;\n\t}\n\n\tport = codec->chregs.regs.ac97read;\n\n\tif (snd_ali_codec_ready(codec, port) < 0)\n\t\treturn ~0;\n\tif (snd_ali_stimer_ready(codec) < 0)\n\t\treturn ~0;\n\n\tdwVal  = (unsigned int) (reg & 0xff);\n\tdwVal |= 0x8000;\t\t\t\t \n\tif (secondary)\n\t\tdwVal |= 0x0080;\n\n\tsnd_ali_5451_poke(codec, port, dwVal);\n\n\tif (snd_ali_stimer_ready(codec) < 0)\n\t\treturn ~0;\n\tif (snd_ali_codec_ready(codec, port) < 0)\n\t\treturn ~0;\n\t\n\treturn (snd_ali_5451_peek(codec, port) & 0xffff0000) >> 16;\n}\n\nstatic void snd_ali_codec_write(struct snd_ac97 *ac97,\n\t\t\t\tunsigned short reg,\n\t\t\t\tunsigned short val )\n{\n\tstruct snd_ali *codec = ac97->private_data;\n\n\tdev_dbg(codec->card->dev, \"codec_write: reg=%xh data=%xh.\\n\", reg, val);\n\tif (reg == AC97_GPIO_STATUS) {\n\t\toutl((val << ALI_AC97_GPIO_DATA_SHIFT) | ALI_AC97_GPIO_ENABLE,\n\t\t     ALI_REG(codec, ALI_AC97_GPIO));\n\t\treturn;\n\t}\n\tsnd_ali_codec_poke(codec, ac97->num, reg, val);\n\treturn ;\n}\n\n\nstatic unsigned short snd_ali_codec_read(struct snd_ac97 *ac97,\n\t\t\t\t\t unsigned short reg)\n{\n\tstruct snd_ali *codec = ac97->private_data;\n\n\tdev_dbg(codec->card->dev, \"codec_read reg=%xh.\\n\", reg);\n\treturn snd_ali_codec_peek(codec, ac97->num, reg);\n}\n\n \n\nstatic int snd_ali_reset_5451(struct snd_ali *codec)\n{\n\tstruct pci_dev *pci_dev;\n\tunsigned short wCount, wReg;\n\tunsigned int   dwVal;\n\t\n\tpci_dev = codec->pci_m1533;\n\tif (pci_dev) {\n\t\tpci_read_config_dword(pci_dev, 0x7c, &dwVal);\n\t\tpci_write_config_dword(pci_dev, 0x7c, dwVal | 0x08000000);\n\t\tmdelay(5);\n\t\tpci_read_config_dword(pci_dev, 0x7c, &dwVal);\n\t\tpci_write_config_dword(pci_dev, 0x7c, dwVal & 0xf7ffffff);\n\t\tmdelay(5);\n\t}\n\t\n\tpci_dev = codec->pci;\n\tpci_read_config_dword(pci_dev, 0x44, &dwVal);\n\tpci_write_config_dword(pci_dev, 0x44, dwVal | 0x000c0000);\n\tudelay(500);\n\tpci_read_config_dword(pci_dev, 0x44, &dwVal);\n\tpci_write_config_dword(pci_dev, 0x44, dwVal & 0xfffbffff);\n\tmdelay(5);\n\t\n\twCount = 200;\n\twhile(wCount--) {\n\t\twReg = snd_ali_codec_peek(codec, 0, AC97_POWERDOWN);\n\t\tif ((wReg & 0x000f) == 0x000f)\n\t\t\treturn 0;\n\t\tmdelay(5);\n\t}\n\n\t \n\t \n\treturn 0;\n}\n\n \n\nstatic void snd_ali_enable_special_channel(struct snd_ali *codec,\n\t\t\t\t\t   unsigned int channel)\n{\n\tunsigned long dwVal;\n\n\tdwVal  = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\tdwVal |= 1 << (channel & 0x0000001f);\n\toutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n}\n\nstatic void snd_ali_disable_special_channel(struct snd_ali *codec,\n\t\t\t\t\t    unsigned int channel)\n{\n\tunsigned long dwVal;\n\n\tdwVal  = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\tdwVal &= ~(1 << (channel & 0x0000001f));\n\toutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n}\n\nstatic void snd_ali_enable_address_interrupt(struct snd_ali *codec)\n{\n\tunsigned int gc;\n\n\tgc  = inl(ALI_REG(codec, ALI_GC_CIR));\n\tgc |= ENDLP_IE;\n\tgc |= MIDLP_IE;\n\toutl( gc, ALI_REG(codec, ALI_GC_CIR));\n}\n\nstatic void snd_ali_disable_address_interrupt(struct snd_ali *codec)\n{\n\tunsigned int gc;\n\n\tgc  = inl(ALI_REG(codec, ALI_GC_CIR));\n\tgc &= ~ENDLP_IE;\n\tgc &= ~MIDLP_IE;\n\toutl(gc, ALI_REG(codec, ALI_GC_CIR));\n}\n\nstatic void snd_ali_disable_voice_irq(struct snd_ali *codec,\n\t\t\t\t      unsigned int channel)\n{\n\tunsigned int mask;\n\tstruct snd_ali_channel_control *pchregs = &(codec->chregs);\n\n\tdev_dbg(codec->card->dev, \"disable_voice_irq channel=%d\\n\", channel);\n\n\tmask = 1 << (channel & 0x1f);\n\tpchregs->data.ainten  = inl(ALI_REG(codec, pchregs->regs.ainten));\n\tpchregs->data.ainten &= ~mask;\n\toutl(pchregs->data.ainten, ALI_REG(codec, pchregs->regs.ainten));\n}\n\nstatic int snd_ali_alloc_pcm_channel(struct snd_ali *codec, int channel)\n{\n\tunsigned int idx =  channel & 0x1f;\n\n\tif (codec->synth.chcnt >= ALI_CHANNELS){\n\t\tdev_err(codec->card->dev,\n\t\t\t   \"ali_alloc_pcm_channel: no free channels.\\n\");\n\t\treturn -1;\n\t}\n\n\tif (!(codec->synth.chmap & (1 << idx))) {\n\t\tcodec->synth.chmap |= 1 << idx;\n\t\tcodec->synth.chcnt++;\n\t\tdev_dbg(codec->card->dev, \"alloc_pcm_channel no. %d.\\n\", idx);\n\t\treturn idx;\n\t}\n\treturn -1;\n}\n\nstatic int snd_ali_find_free_channel(struct snd_ali * codec, int rec)\n{\n\tint idx;\n\tint result = -1;\n\n\tdev_dbg(codec->card->dev,\n\t\t\"find_free_channel: for %s\\n\", rec ? \"rec\" : \"pcm\");\n\n\t \n\tif (rec) {\n\t\tif (codec->spdif_support &&\n\t\t    (inl(ALI_REG(codec, ALI_GLOBAL_CONTROL)) &\n\t\t     ALI_SPDIF_IN_SUPPORT))\n\t\t\tidx = ALI_SPDIF_IN_CHANNEL;\n\t\telse\n\t\t\tidx = ALI_PCM_IN_CHANNEL;\n\n\t\tresult = snd_ali_alloc_pcm_channel(codec, idx);\n\t\tif (result >= 0)\n\t\t\treturn result;\n\t\telse {\n\t\t\tdev_err(codec->card->dev,\n\t\t\t\t\"ali_find_free_channel: record channel is busy now.\\n\");\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\t \n\tif (codec->spdif_support &&\n\t    (inl(ALI_REG(codec, ALI_GLOBAL_CONTROL)) &\n\t     ALI_SPDIF_OUT_CH_ENABLE)) {\n\t\tidx = ALI_SPDIF_OUT_CHANNEL;\n\t\tresult = snd_ali_alloc_pcm_channel(codec, idx);\n\t\tif (result >= 0)\n\t\t\treturn result;\n\t\telse\n\t\t\tdev_err(codec->card->dev,\n\t\t\t\t\"ali_find_free_channel: S/PDIF out channel is in busy now.\\n\");\n\t}\n\n\tfor (idx = 0; idx < ALI_CHANNELS; idx++) {\n\t\tresult = snd_ali_alloc_pcm_channel(codec, idx);\n\t\tif (result >= 0)\n\t\t\treturn result;\n\t}\n\tdev_err(codec->card->dev, \"ali_find_free_channel: no free channels.\\n\");\n\treturn -1;\n}\n\nstatic void snd_ali_free_channel_pcm(struct snd_ali *codec, int channel)\n{\n\tunsigned int idx = channel & 0x0000001f;\n\n\tdev_dbg(codec->card->dev, \"free_channel_pcm channel=%d\\n\", channel);\n\n\tif (channel < 0 || channel >= ALI_CHANNELS)\n\t\treturn;\n\n\tif (!(codec->synth.chmap & (1 << idx))) {\n\t\tdev_err(codec->card->dev,\n\t\t\t\"ali_free_channel_pcm: channel %d is not in use.\\n\",\n\t\t\tchannel);\n\t\treturn;\n\t} else {\n\t\tcodec->synth.chmap &= ~(1 << idx);\n\t\tcodec->synth.chcnt--;\n\t}\n}\n\nstatic void snd_ali_stop_voice(struct snd_ali *codec, unsigned int channel)\n{\n\tunsigned int mask = 1 << (channel & 0x1f);\n\n\tdev_dbg(codec->card->dev, \"stop_voice: channel=%d\\n\", channel);\n\toutl(mask, ALI_REG(codec, codec->chregs.regs.stop));\n}\n\n \n\nstatic void snd_ali_delay(struct snd_ali *codec,int interval)\n{\n\tunsigned long  begintimer,currenttimer;\n\n\tbegintimer   = inl(ALI_REG(codec, ALI_STIMER));\n\tcurrenttimer = inl(ALI_REG(codec, ALI_STIMER));\n\n\twhile (currenttimer < begintimer + interval) {\n\t\tif (snd_ali_stimer_ready(codec) < 0)\n\t\t\tbreak;\n\t\tcurrenttimer = inl(ALI_REG(codec,  ALI_STIMER));\n\t\tcpu_relax();\n\t}\n}\n\nstatic void snd_ali_detect_spdif_rate(struct snd_ali *codec)\n{\n\tu16 wval;\n\tu16 count = 0;\n\tu8  bval, R1 = 0, R2;\n\n\tbval  = inb(ALI_REG(codec, ALI_SPDIF_CTRL + 1));\n\tbval |= 0x1F;\n\toutb(bval, ALI_REG(codec, ALI_SPDIF_CTRL + 1));\n\n\twhile ((R1 < 0x0b || R1 > 0x0e) && R1 != 0x12 && count <= 50000) {\n\t\tcount ++;\n\t\tsnd_ali_delay(codec, 6);\n\t\tbval = inb(ALI_REG(codec, ALI_SPDIF_CTRL + 1));\n\t\tR1 = bval & 0x1F;\n\t}\n\n\tif (count > 50000) {\n\t\tdev_err(codec->card->dev, \"ali_detect_spdif_rate: timeout!\\n\");\n\t\treturn;\n\t}\n\n\tfor (count = 0; count <= 50000; count++) {\n\t\tsnd_ali_delay(codec, 6);\n\t\tbval = inb(ALI_REG(codec,ALI_SPDIF_CTRL + 1));\n\t\tR2 = bval & 0x1F;\n\t\tif (R2 != R1)\n\t\t\tR1 = R2;\n\t\telse\n\t\t\tbreak;\n\t}\n\n\tif (count > 50000) {\n\t\tdev_err(codec->card->dev, \"ali_detect_spdif_rate: timeout!\\n\");\n\t\treturn;\n\t}\n\n\tif (R2 >= 0x0b && R2 <= 0x0e) {\n\t\twval  = inw(ALI_REG(codec, ALI_SPDIF_CTRL + 2));\n\t\twval &= 0xe0f0;\n\t\twval |= (0x09 << 8) | 0x05;\n\t\toutw(wval, ALI_REG(codec, ALI_SPDIF_CTRL + 2));\n\n\t\tbval  = inb(ALI_REG(codec, ALI_SPDIF_CS + 3)) & 0xf0;\n\t\toutb(bval | 0x02, ALI_REG(codec, ALI_SPDIF_CS + 3));\n\t} else if (R2 == 0x12) {\n\t\twval  = inw(ALI_REG(codec, ALI_SPDIF_CTRL + 2));\n\t\twval &= 0xe0f0;\n\t\twval |= (0x0e << 8) | 0x08;\n\t\toutw(wval, ALI_REG(codec, ALI_SPDIF_CTRL + 2));\n\n\t\tbval  = inb(ALI_REG(codec,ALI_SPDIF_CS + 3)) & 0xf0;\n\t\toutb(bval | 0x03, ALI_REG(codec, ALI_SPDIF_CS + 3));\n\t}\n}\n\nstatic unsigned int snd_ali_get_spdif_in_rate(struct snd_ali *codec)\n{\n\tu32\tdwRate;\n\tu8\tbval;\n\n\tbval  = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\n\tbval &= 0x7f;\n\tbval |= 0x40;\n\toutb(bval, ALI_REG(codec, ALI_SPDIF_CTRL));\n\n\tsnd_ali_detect_spdif_rate(codec);\n\n\tbval  = inb(ALI_REG(codec, ALI_SPDIF_CS + 3));\n\tbval &= 0x0f;\n\n\tswitch (bval) {\n\tcase 0: dwRate = 44100; break;\n\tcase 1: dwRate = 48000; break;\n\tcase 2: dwRate = 32000; break;\n\tdefault: dwRate = 0; break;\n\t}\n\n\treturn dwRate;\n}\n\nstatic void snd_ali_enable_spdif_in(struct snd_ali *codec)\n{\t\n\tunsigned int dwVal;\n\n\tdwVal = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\tdwVal |= ALI_SPDIF_IN_SUPPORT;\n\toutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\n\tdwVal = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\n\tdwVal |= 0x02;\n\toutb(dwVal, ALI_REG(codec, ALI_SPDIF_CTRL));\n\n\tsnd_ali_enable_special_channel(codec, ALI_SPDIF_IN_CHANNEL);\n}\n\nstatic void snd_ali_disable_spdif_in(struct snd_ali *codec)\n{\n\tunsigned int dwVal;\n\t\n\tdwVal = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\tdwVal &= ~ALI_SPDIF_IN_SUPPORT;\n\toutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\t\n\tsnd_ali_disable_special_channel(codec, ALI_SPDIF_IN_CHANNEL);\t\n}\n\n\nstatic void snd_ali_set_spdif_out_rate(struct snd_ali *codec, unsigned int rate)\n{\n\tunsigned char  bVal;\n\tunsigned int  dwRate;\n\t\n\tswitch (rate) {\n\tcase 32000: dwRate = 0x300; break;\n\tcase 48000: dwRate = 0x200; break;\n\tdefault: dwRate = 0; break;\n\t}\n\t\n\tbVal  = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\n\tbVal &= (unsigned char)(~(1<<6));\n\t\n\tbVal |= 0x80;\t\t \n\toutb(bVal, ALI_REG(codec, ALI_SPDIF_CTRL));\n\toutb(dwRate | 0x20, ALI_REG(codec, ALI_SPDIF_CS + 2));\n\t\n\tbVal &= ~0x80;\t \n\toutb(bVal, ALI_REG(codec, ALI_SPDIF_CTRL));\n\toutw(rate | 0x10, ALI_REG(codec, ALI_SPDIF_CS + 2));\n}\n\nstatic void snd_ali_enable_spdif_out(struct snd_ali *codec)\n{\n\tunsigned short wVal;\n\tunsigned char bVal;\n        struct pci_dev *pci_dev;\n\n        pci_dev = codec->pci_m1533;\n        if (pci_dev == NULL)\n                return;\n        pci_read_config_byte(pci_dev, 0x61, &bVal);\n        bVal |= 0x40;\n        pci_write_config_byte(pci_dev, 0x61, bVal);\n        pci_read_config_byte(pci_dev, 0x7d, &bVal);\n        bVal |= 0x01;\n        pci_write_config_byte(pci_dev, 0x7d, bVal);\n\n        pci_read_config_byte(pci_dev, 0x7e, &bVal);\n        bVal &= (~0x20);\n        bVal |= 0x10;\n        pci_write_config_byte(pci_dev, 0x7e, bVal);\n\n\tbVal = inb(ALI_REG(codec, ALI_SCTRL));\n\toutb(bVal | ALI_SPDIF_OUT_ENABLE, ALI_REG(codec, ALI_SCTRL));\n\n\tbVal = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\n\toutb(bVal & ALI_SPDIF_OUT_CH_STATUS, ALI_REG(codec, ALI_SPDIF_CTRL));\n   \n\twVal = inw(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\twVal |= ALI_SPDIF_OUT_SEL_PCM;\n\toutw(wVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\tsnd_ali_disable_special_channel(codec, ALI_SPDIF_OUT_CHANNEL);\n}\n\nstatic void snd_ali_enable_spdif_chnout(struct snd_ali *codec)\n{\n\tunsigned short wVal;\n\n\twVal  = inw(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n   \twVal &= ~ALI_SPDIF_OUT_SEL_PCM;\n   \toutw(wVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n \n\tsnd_ali_enable_special_channel(codec, ALI_SPDIF_OUT_CHANNEL);\n}\n\nstatic void snd_ali_disable_spdif_chnout(struct snd_ali *codec)\n{\n\tunsigned short wVal;\n\n  \twVal  = inw(ALI_REG(codec, ALI_GLOBAL_CONTROL));\n   \twVal |= ALI_SPDIF_OUT_SEL_PCM;\n   \toutw(wVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\n\tsnd_ali_enable_special_channel(codec, ALI_SPDIF_OUT_CHANNEL);\n}\n\nstatic void snd_ali_disable_spdif_out(struct snd_ali *codec)\n{\n\tunsigned char  bVal;\n\n\tbVal = inb(ALI_REG(codec, ALI_SCTRL));\n\toutb(bVal & ~ALI_SPDIF_OUT_ENABLE, ALI_REG(codec, ALI_SCTRL));\n\n\tsnd_ali_disable_spdif_chnout(codec);\n}\n\nstatic void snd_ali_update_ptr(struct snd_ali *codec, int channel)\n{\n\tstruct snd_ali_voice *pvoice;\n\tstruct snd_ali_channel_control *pchregs;\n\tunsigned int old, mask;\n\n\tpchregs = &(codec->chregs);\n\n\t \n\told  = pchregs->data.aint;\n\tmask = 1U << (channel & 0x1f);\n\n\tif (!(old & mask))\n\t\treturn;\n\n\tpvoice = &codec->synth.voices[channel];\n\n\tudelay(100);\n\tspin_lock(&codec->reg_lock);\n\n\tif (pvoice->pcm && pvoice->substream) {\n\t\t \n\t\tif (pvoice->running) {\n\t\t\tdev_dbg(codec->card->dev,\n\t\t\t\t\"update_ptr: cso=%4.4x cspf=%d.\\n\",\n\t\t\t\tinw(ALI_REG(codec, ALI_CSO_ALPHA_FMS + 2)),\n\t\t\t\t(inl(ALI_REG(codec, ALI_CSPF)) & mask) == mask);\n\t\t\tspin_unlock(&codec->reg_lock);\n\t\t\tsnd_pcm_period_elapsed(pvoice->substream);\n\t\t\tspin_lock(&codec->reg_lock);\n\t\t} else {\n\t\t\tsnd_ali_stop_voice(codec, channel);\n\t\t\tsnd_ali_disable_voice_irq(codec, channel);\n\t\t}\t\n\t} else if (codec->synth.voices[channel].synth) {\n\t\t \n\t} else if (codec->synth.voices[channel].midi) {\n\t\t \n\t} else {\n\t\t \n\t\tsnd_ali_stop_voice(codec, channel);\n\t\tsnd_ali_disable_voice_irq(codec, channel);\n\t}\n\tspin_unlock(&codec->reg_lock);\n\toutl(mask,ALI_REG(codec,pchregs->regs.aint));\n\tpchregs->data.aint = old & (~mask);\n}\n\nstatic irqreturn_t snd_ali_card_interrupt(int irq, void *dev_id)\n{\n\tstruct snd_ali \t*codec = dev_id;\n\tint channel;\n\tunsigned int audio_int;\n\tstruct snd_ali_channel_control *pchregs;\n\n\tif (codec == NULL || !codec->hw_initialized)\n\t\treturn IRQ_NONE;\n\n\taudio_int = inl(ALI_REG(codec, ALI_MISCINT));\n\tif (!audio_int)\n\t\treturn IRQ_NONE;\n\n\tpchregs = &(codec->chregs);\n\tif (audio_int & ADDRESS_IRQ) {\n\t\t \n\t\tpchregs->data.aint = inl(ALI_REG(codec, pchregs->regs.aint));\n\t\tfor (channel = 0; channel < ALI_CHANNELS; channel++)\n\t\t\tsnd_ali_update_ptr(codec, channel);\n\t}\n\toutl((TARGET_REACHED | MIXER_OVERFLOW | MIXER_UNDERFLOW),\n\t\tALI_REG(codec, ALI_MISCINT));\n\n\treturn IRQ_HANDLED;\n}\n\n\nstatic struct snd_ali_voice *snd_ali_alloc_voice(struct snd_ali * codec,\n\t\t\t\t\t\t int type, int rec, int channel)\n{\n\tstruct snd_ali_voice *pvoice;\n\tint idx;\n\n\tdev_dbg(codec->card->dev, \"alloc_voice: type=%d rec=%d\\n\", type, rec);\n\n\tspin_lock_irq(&codec->voice_alloc);\n\tif (type == SNDRV_ALI_VOICE_TYPE_PCM) {\n\t\tidx = channel > 0 ? snd_ali_alloc_pcm_channel(codec, channel) :\n\t\t\tsnd_ali_find_free_channel(codec,rec);\n\t\tif (idx < 0) {\n\t\t\tdev_err(codec->card->dev, \"ali_alloc_voice: err.\\n\");\n\t\t\tspin_unlock_irq(&codec->voice_alloc);\n\t\t\treturn NULL;\n\t\t}\n\t\tpvoice = &(codec->synth.voices[idx]);\n\t\tpvoice->codec = codec;\n\t\tpvoice->use = 1;\n\t\tpvoice->pcm = 1;\n\t\tpvoice->mode = rec;\n\t\tspin_unlock_irq(&codec->voice_alloc);\n\t\treturn pvoice;\n\t}\n\tspin_unlock_irq(&codec->voice_alloc);\n\treturn NULL;\n}\n\n\nstatic void snd_ali_free_voice(struct snd_ali * codec,\n\t\t\t       struct snd_ali_voice *pvoice)\n{\n\tvoid (*private_free)(void *);\n\tvoid *private_data;\n\n\tdev_dbg(codec->card->dev, \"free_voice: channel=%d\\n\", pvoice->number);\n\tif (!pvoice->use)\n\t\treturn;\n\tsnd_ali_clear_voices(codec, pvoice->number, pvoice->number);\n\tspin_lock_irq(&codec->voice_alloc);\n\tprivate_free = pvoice->private_free;\n\tprivate_data = pvoice->private_data;\n\tpvoice->private_free = NULL;\n\tpvoice->private_data = NULL;\n\tif (pvoice->pcm)\n\t\tsnd_ali_free_channel_pcm(codec, pvoice->number);\n\tpvoice->use = pvoice->pcm = pvoice->synth = 0;\n\tpvoice->substream = NULL;\n\tspin_unlock_irq(&codec->voice_alloc);\n\tif (private_free)\n\t\tprivate_free(private_data);\n}\n\n\nstatic void snd_ali_clear_voices(struct snd_ali *codec,\n\t\t\t\t unsigned int v_min,\n\t\t\t\t unsigned int v_max)\n{\n\tunsigned int i;\n\n\tfor (i = v_min; i <= v_max; i++) {\n\t\tsnd_ali_stop_voice(codec, i);\n\t\tsnd_ali_disable_voice_irq(codec, i);\n\t}\n}\n\nstatic void snd_ali_write_voice_regs(struct snd_ali *codec,\n\t\t\t unsigned int Channel,\n\t\t\t unsigned int LBA,\n\t\t\t unsigned int CSO,\n\t\t\t unsigned int ESO,\n\t\t\t unsigned int DELTA,\n\t\t\t unsigned int ALPHA_FMS,\n\t\t\t unsigned int GVSEL,\n\t\t\t unsigned int PAN,\n\t\t\t unsigned int VOL,\n\t\t\t unsigned int CTRL,\n\t\t\t unsigned int EC)\n{\n\tunsigned int ctlcmds[4];\n\t\n\toutb((unsigned char)(Channel & 0x001f), ALI_REG(codec, ALI_GC_CIR));\n\n\tctlcmds[0] =  (CSO << 16) | (ALPHA_FMS & 0x0000ffff);\n\tctlcmds[1] =  LBA;\n\tctlcmds[2] =  (ESO << 16) | (DELTA & 0x0ffff);\n\tctlcmds[3] =  (GVSEL << 31) |\n\t\t      ((PAN & 0x0000007f) << 24) |\n\t\t      ((VOL & 0x000000ff) << 16) |\n\t\t      ((CTRL & 0x0000000f) << 12) |\n\t\t      (EC & 0x00000fff);\n\n\toutb(Channel, ALI_REG(codec, ALI_GC_CIR));\n\n\toutl(ctlcmds[0], ALI_REG(codec, ALI_CSO_ALPHA_FMS));\n\toutl(ctlcmds[1], ALI_REG(codec, ALI_LBA));\n\toutl(ctlcmds[2], ALI_REG(codec, ALI_ESO_DELTA));\n\toutl(ctlcmds[3], ALI_REG(codec, ALI_GVSEL_PAN_VOC_CTRL_EC));\n\n\toutl(0x30000000, ALI_REG(codec, ALI_EBUF1));\t \n\toutl(0x30000000, ALI_REG(codec, ALI_EBUF2));\t \n}\n\nstatic unsigned int snd_ali_convert_rate(unsigned int rate, int rec)\n{\n\tunsigned int delta;\n\n\tif (rate < 4000)\n\t\trate = 4000;\n\tif (rate > 48000)\n\t\trate = 48000;\n\n\tif (rec) {\n\t\tif (rate == 44100)\n\t\t\tdelta = 0x116a;\n\t\telse if (rate == 8000)\n\t\t\tdelta = 0x6000;\n\t\telse if (rate == 48000)\n\t\t\tdelta = 0x1000;\n\t\telse\n\t\t\tdelta = ((48000 << 12) / rate) & 0x0000ffff;\n\t} else {\n\t\tif (rate == 44100)\n\t\t\tdelta = 0xeb3;\n\t\telse if (rate == 8000)\n\t\t\tdelta = 0x2ab;\n\t\telse if (rate == 48000)\n\t\t\tdelta = 0x1000;\n\t\telse \n\t\t\tdelta = (((rate << 12) + rate) / 48000) & 0x0000ffff;\n\t}\n\n\treturn delta;\n}\n\nstatic unsigned int snd_ali_control_mode(struct snd_pcm_substream *substream)\n{\n\tunsigned int CTRL;\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\t \n\tCTRL = 0x00000001;\n\tif (snd_pcm_format_width(runtime->format) == 16)\n\t\tCTRL |= 0x00000008;\t \n\tif (!snd_pcm_format_unsigned(runtime->format))\n\t\tCTRL |= 0x00000002;\t \n\tif (runtime->channels > 1)\n\t\tCTRL |= 0x00000004;\t \n\treturn CTRL;\n}\n\n \n\nstatic int snd_ali_trigger(struct snd_pcm_substream *substream,\n\t\t\t       int cmd)\n\t\t\t\t    \n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_substream *s;\n\tunsigned int what, whati;\n\tstruct snd_ali_voice *pvoice, *evoice;\n\tunsigned int val;\n\tint do_start;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\t\tdo_start = 1;\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\t\tdo_start = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\twhat = whati = 0;\n\tsnd_pcm_group_for_each_entry(s, substream) {\n\t\tif ((struct snd_ali *) snd_pcm_substream_chip(s) == codec) {\n\t\t\tpvoice = s->runtime->private_data;\n\t\t\tevoice = pvoice->extra;\n\t\t\twhat |= 1 << (pvoice->number & 0x1f);\n\t\t\tif (evoice == NULL)\n\t\t\t\twhati |= 1 << (pvoice->number & 0x1f);\n\t\t\telse {\n\t\t\t\twhati |= 1 << (evoice->number & 0x1f);\n\t\t\t\twhat |= 1 << (evoice->number & 0x1f);\n\t\t\t}\n\t\t\tif (do_start) {\n\t\t\t\tpvoice->running = 1;\n\t\t\t\tif (evoice != NULL)\n\t\t\t\t\tevoice->running = 1;\n\t\t\t} else {\n\t\t\t\tpvoice->running = 0;\n\t\t\t\tif (evoice != NULL)\n\t\t\t\t\tevoice->running = 0;\n\t\t\t}\n\t\t\tsnd_pcm_trigger_done(s, substream);\n\t\t}\n\t}\n\tspin_lock(&codec->reg_lock);\n\tif (!do_start)\n\t\toutl(what, ALI_REG(codec, ALI_STOP));\n\tval = inl(ALI_REG(codec, ALI_AINTEN));\n\tif (do_start)\n\t\tval |= whati;\n\telse\n\t\tval &= ~whati;\n\toutl(val, ALI_REG(codec, ALI_AINTEN));\n\tif (do_start)\n\t\toutl(what, ALI_REG(codec, ALI_START));\n\tdev_dbg(codec->card->dev, \"trigger: what=%xh whati=%xh\\n\", what, whati);\n\tspin_unlock(&codec->reg_lock);\n\n\treturn 0;\n}\n\nstatic int snd_ali_playback_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t      struct snd_pcm_hw_params *hw_params)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\tstruct snd_ali_voice *evoice = pvoice->extra;\n\n\t \n\n\tif (params_buffer_size(hw_params) / 2 !=\n\t    params_period_size(hw_params)) {\n\t\tif (!evoice) {\n\t\t\tevoice = snd_ali_alloc_voice(codec,\n\t\t\t\t\t\t     SNDRV_ALI_VOICE_TYPE_PCM,\n\t\t\t\t\t\t     0, -1);\n\t\t\tif (!evoice)\n\t\t\t\treturn -ENOMEM;\n\t\t\tpvoice->extra = evoice;\n\t\t\tevoice->substream = substream;\n\t\t}\n\t} else {\n\t\tif (evoice) {\n\t\t\tsnd_ali_free_voice(codec, evoice);\n\t\t\tpvoice->extra = evoice = NULL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int snd_ali_playback_hw_free(struct snd_pcm_substream *substream)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\tstruct snd_ali_voice *evoice = pvoice ? pvoice->extra : NULL;\n\n\tif (evoice) {\n\t\tsnd_ali_free_voice(codec, evoice);\n\t\tpvoice->extra = NULL;\n\t}\n\treturn 0;\n}\n\nstatic int snd_ali_playback_prepare(struct snd_pcm_substream *substream)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\tstruct snd_ali_voice *evoice = pvoice->extra;\n\n\tunsigned int LBA;\n\tunsigned int Delta;\n\tunsigned int ESO;\n\tunsigned int CTRL;\n\tunsigned int GVSEL;\n\tunsigned int PAN;\n\tunsigned int VOL;\n\tunsigned int EC;\n\t\n\tdev_dbg(codec->card->dev, \"playback_prepare ...\\n\");\n\n\tspin_lock_irq(&codec->reg_lock);\t\n\t\n\t \n\tDelta = snd_ali_convert_rate(runtime->rate, 0);\n\n\tif (pvoice->number == ALI_SPDIF_IN_CHANNEL || \n\t    pvoice->number == ALI_PCM_IN_CHANNEL)\n\t\tsnd_ali_disable_special_channel(codec, pvoice->number);\n\telse if (codec->spdif_support &&\n\t\t (inl(ALI_REG(codec, ALI_GLOBAL_CONTROL)) &\n\t\t  ALI_SPDIF_OUT_CH_ENABLE)\n\t\t && pvoice->number == ALI_SPDIF_OUT_CHANNEL) {\n\t\tsnd_ali_set_spdif_out_rate(codec, runtime->rate);\n\t\tDelta = 0x1000;\n\t}\n\t\n\t \n\tLBA = runtime->dma_addr;\n\n\t \n\tpvoice->count = runtime->period_size;\n\n\t \n\tpvoice->eso = runtime->buffer_size; \n\n\tdev_dbg(codec->card->dev, \"playback_prepare: eso=%xh count=%xh\\n\",\n\t\t       pvoice->eso, pvoice->count);\n\n\t \n\tESO = pvoice->eso -1;\n\t \n\tCTRL = snd_ali_control_mode(substream);\n\n\tGVSEL = 1;\n\tPAN = 0;\n\tVOL = 0;\n\tEC = 0;\n\tdev_dbg(codec->card->dev, \"playback_prepare:\\n\");\n\tdev_dbg(codec->card->dev,\n\t\t\"ch=%d, Rate=%d Delta=%xh,GVSEL=%xh,PAN=%xh,CTRL=%xh\\n\",\n\t\t       pvoice->number,runtime->rate,Delta,GVSEL,PAN,CTRL);\n\tsnd_ali_write_voice_regs(codec,\n\t\t\t\t pvoice->number,\n\t\t\t\t LBA,\n\t\t\t\t 0,\t \n\t\t\t\t ESO,\n\t\t\t\t Delta,\n\t\t\t\t 0,\t \n\t\t\t\t GVSEL,\n\t\t\t\t PAN,\n\t\t\t\t VOL,\n\t\t\t\t CTRL,\n\t\t\t\t EC);\n\tif (evoice) {\n\t\tevoice->count = pvoice->count;\n\t\tevoice->eso = pvoice->count << 1;\n\t\tESO = evoice->eso - 1;\n\t\tsnd_ali_write_voice_regs(codec,\n\t\t\t\t\t evoice->number,\n\t\t\t\t\t LBA,\n\t\t\t\t\t 0,\t \n\t\t\t\t\t ESO,\n\t\t\t\t\t Delta,\n\t\t\t\t\t 0,\t \n\t\t\t\t\t GVSEL,\n\t\t\t\t\t 0x7f,\n\t\t\t\t\t 0x3ff,\n\t\t\t\t\t CTRL,\n\t\t\t\t\t EC);\n\t}\n\tspin_unlock_irq(&codec->reg_lock);\n\treturn 0;\n}\n\n\nstatic int snd_ali_prepare(struct snd_pcm_substream *substream)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\tunsigned int LBA;\n\tunsigned int Delta;\n\tunsigned int ESO;\n\tunsigned int CTRL;\n\tunsigned int GVSEL;\n\tunsigned int PAN;\n\tunsigned int VOL;\n\tunsigned int EC;\n\tu8\t bValue;\n\n\tspin_lock_irq(&codec->reg_lock);\n\n\tdev_dbg(codec->card->dev, \"ali_prepare...\\n\");\n\n\tsnd_ali_enable_special_channel(codec,pvoice->number);\n\n\tDelta = (pvoice->number == ALI_MODEM_IN_CHANNEL ||\n\t\t pvoice->number == ALI_MODEM_OUT_CHANNEL) ? \n\t\t0x1000 : snd_ali_convert_rate(runtime->rate, pvoice->mode);\n\n\t \n\tif (pvoice->number == ALI_SPDIF_IN_CHANNEL) {\n\n\t\tunsigned int rate;\n\t\t\n\t\tspin_unlock_irq(&codec->reg_lock);\n\t\tif (codec->revision != ALI_5451_V02)\n\t\t\treturn -1;\n\n\t\trate = snd_ali_get_spdif_in_rate(codec);\n\t\tif (rate == 0) {\n\t\t\tdev_warn(codec->card->dev,\n\t\t\t\t \"ali_capture_prepare: spdif rate detect err!\\n\");\n\t\t\trate = 48000;\n\t\t}\n\t\tspin_lock_irq(&codec->reg_lock);\n\t\tbValue = inb(ALI_REG(codec,ALI_SPDIF_CTRL));\n\t\tif (bValue & 0x10) {\n\t\t\toutb(bValue,ALI_REG(codec,ALI_SPDIF_CTRL));\n\t\t\tdev_warn(codec->card->dev,\n\t\t\t\t \"clear SPDIF parity error flag.\\n\");\n\t\t}\n\n\t\tif (rate != 48000)\n\t\t\tDelta = ((rate << 12) / runtime->rate) & 0x00ffff;\n\t}\n\n\t \n\tpvoice->eso = runtime->buffer_size; \n\n\t \n\tpvoice->count = runtime->period_size;\n\n\t \n\tLBA = runtime->dma_addr;\n\n\t \n\tESO = pvoice->eso - 1;\n\tCTRL = snd_ali_control_mode(substream);\n\tGVSEL = 0;\n\tPAN = 0x00;\n\tVOL = 0x00;\n\tEC = 0;\n\n\tsnd_ali_write_voice_regs(    codec,\n\t\t\t\t     pvoice->number,\n\t\t\t\t     LBA,\n\t\t\t\t     0,\t \n\t\t\t\t     ESO,\n\t\t\t\t     Delta,\n\t\t\t\t     0,\t \n\t\t\t\t     GVSEL,\n\t\t\t\t     PAN,\n\t\t\t\t     VOL,\n\t\t\t\t     CTRL,\n\t\t\t\t     EC);\n\n\tspin_unlock_irq(&codec->reg_lock);\n\n\treturn 0;\n}\n\n\nstatic snd_pcm_uframes_t\nsnd_ali_playback_pointer(struct snd_pcm_substream *substream)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\tunsigned int cso;\n\n\tspin_lock(&codec->reg_lock);\n\tif (!pvoice->running) {\n\t\tspin_unlock(&codec->reg_lock);\n\t\treturn 0;\n\t}\n\toutb(pvoice->number, ALI_REG(codec, ALI_GC_CIR));\n\tcso = inw(ALI_REG(codec, ALI_CSO_ALPHA_FMS + 2));\n\tspin_unlock(&codec->reg_lock);\n\tdev_dbg(codec->card->dev, \"playback pointer returned cso=%xh.\\n\", cso);\n\n\tcso %= runtime->buffer_size;\n\treturn cso;\n}\n\n\nstatic snd_pcm_uframes_t snd_ali_pointer(struct snd_pcm_substream *substream)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\tunsigned int cso;\n\n\tspin_lock(&codec->reg_lock);\n\tif (!pvoice->running) {\n\t\tspin_unlock(&codec->reg_lock);\n\t\treturn 0;\n\t}\n\toutb(pvoice->number, ALI_REG(codec, ALI_GC_CIR));\n\tcso = inw(ALI_REG(codec, ALI_CSO_ALPHA_FMS + 2));\n\tspin_unlock(&codec->reg_lock);\n\n\tcso %= runtime->buffer_size;\n\treturn cso;\n}\n\nstatic const struct snd_pcm_hardware snd_ali_playback =\n{\n\t.info =\t\t(SNDRV_PCM_INFO_MMAP | SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t SNDRV_PCM_INFO_BLOCK_TRANSFER |\n\t\t\t SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t SNDRV_PCM_INFO_RESUME |\n\t\t\t SNDRV_PCM_INFO_SYNC_START),\n\t.formats =\t(SNDRV_PCM_FMTBIT_U8 | SNDRV_PCM_FMTBIT_S16_LE |\n\t\t\t SNDRV_PCM_FMTBIT_S8 | SNDRV_PCM_FMTBIT_U16_LE),\n\t.rates =\tSNDRV_PCM_RATE_CONTINUOUS | SNDRV_PCM_RATE_8000_48000,\n\t.rate_min =\t\t4000,\n\t.rate_max =\t\t48000,\n\t.channels_min =\t\t1,\n\t.channels_max =\t\t2,\n\t.buffer_bytes_max =\t(256*1024),\n\t.period_bytes_min =\t64,\n\t.period_bytes_max =\t(256*1024),\n\t.periods_min =\t\t1,\n\t.periods_max =\t\t1024,\n\t.fifo_size =\t\t0,\n};\n\n \n\nstatic const struct snd_pcm_hardware snd_ali_capture =\n{\n\t.info =\t\t(SNDRV_PCM_INFO_MMAP | SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t SNDRV_PCM_INFO_BLOCK_TRANSFER |\n\t\t\t SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t SNDRV_PCM_INFO_RESUME |\n\t\t\t SNDRV_PCM_INFO_SYNC_START),\n\t.formats =\t(SNDRV_PCM_FMTBIT_U8 | SNDRV_PCM_FMTBIT_S16_LE |\n\t\t\t SNDRV_PCM_FMTBIT_S8 | SNDRV_PCM_FMTBIT_U16_LE),\n\t.rates =\tSNDRV_PCM_RATE_CONTINUOUS | SNDRV_PCM_RATE_8000_48000,\n\t.rate_min =\t\t4000,\n\t.rate_max =\t\t48000,\n\t.channels_min =\t\t1,\n\t.channels_max =\t\t2,\n\t.buffer_bytes_max =\t(128*1024),\n\t.period_bytes_min =\t64,\n\t.period_bytes_max =\t(128*1024),\n\t.periods_min =\t\t1,\n\t.periods_max =\t\t1024,\n\t.fifo_size =\t\t0,\n};\n\nstatic void snd_ali_pcm_free_substream(struct snd_pcm_runtime *runtime)\n{\n\tstruct snd_ali_voice *pvoice = runtime->private_data;\n\n\tif (pvoice)\n\t\tsnd_ali_free_voice(pvoice->codec, pvoice);\n}\n\nstatic int snd_ali_open(struct snd_pcm_substream *substream, int rec,\n\t\t\tint channel, const struct snd_pcm_hardware *phw)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_ali_voice *pvoice;\n\n\tpvoice = snd_ali_alloc_voice(codec, SNDRV_ALI_VOICE_TYPE_PCM, rec,\n\t\t\t\t     channel);\n\tif (!pvoice)\n\t\treturn -EAGAIN;\n\n\tpvoice->substream = substream;\n\truntime->private_data = pvoice;\n\truntime->private_free = snd_ali_pcm_free_substream;\n\n\truntime->hw = *phw;\n\tsnd_pcm_set_sync(substream);\n\tsnd_pcm_hw_constraint_minmax(runtime, SNDRV_PCM_HW_PARAM_BUFFER_SIZE,\n\t\t\t\t     0, 64*1024);\n\treturn 0;\n}\n\nstatic int snd_ali_playback_open(struct snd_pcm_substream *substream)\n{\n\treturn snd_ali_open(substream, 0, -1, &snd_ali_playback);\n}\n\nstatic int snd_ali_capture_open(struct snd_pcm_substream *substream)\n{\n\treturn snd_ali_open(substream, 1, -1, &snd_ali_capture);\n}\n\nstatic int snd_ali_playback_close(struct snd_pcm_substream *substream)\n{\n\treturn 0;\n}\n\nstatic int snd_ali_close(struct snd_pcm_substream *substream)\n{\n\tstruct snd_ali *codec = snd_pcm_substream_chip(substream);\n\tstruct snd_ali_voice *pvoice = substream->runtime->private_data;\n\n\tsnd_ali_disable_special_channel(codec,pvoice->number);\n\n\treturn 0;\n}\n\nstatic const struct snd_pcm_ops snd_ali_playback_ops = {\n\t.open =\t\tsnd_ali_playback_open,\n\t.close =\tsnd_ali_playback_close,\n\t.hw_params =\tsnd_ali_playback_hw_params,\n\t.hw_free =\tsnd_ali_playback_hw_free,\n\t.prepare =\tsnd_ali_playback_prepare,\n\t.trigger =\tsnd_ali_trigger,\n\t.pointer =\tsnd_ali_playback_pointer,\n};\n\nstatic const struct snd_pcm_ops snd_ali_capture_ops = {\n\t.open =\t\tsnd_ali_capture_open,\n\t.close =\tsnd_ali_close,\n\t.prepare =\tsnd_ali_prepare,\n\t.trigger =\tsnd_ali_trigger,\n\t.pointer =\tsnd_ali_pointer,\n};\n\n \n\nstatic int snd_ali_modem_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *hw_params)\n{\n\tstruct snd_ali *chip = snd_pcm_substream_chip(substream);\n\tunsigned int modem_num = chip->num_of_codecs - 1;\n\tsnd_ac97_write(chip->ac97[modem_num], AC97_LINE1_RATE,\n\t\t       params_rate(hw_params));\n\tsnd_ac97_write(chip->ac97[modem_num], AC97_LINE1_LEVEL, 0);\n\treturn 0;\n}\n\nstatic const struct snd_pcm_hardware snd_ali_modem =\n{\n\t.info =\t\t(SNDRV_PCM_INFO_MMAP | SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t SNDRV_PCM_INFO_BLOCK_TRANSFER |\n\t\t\t SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t SNDRV_PCM_INFO_RESUME |\n\t\t\t SNDRV_PCM_INFO_SYNC_START),\n\t.formats =\tSNDRV_PCM_FMTBIT_S16_LE,\n\t.rates =\t(SNDRV_PCM_RATE_KNOT | SNDRV_PCM_RATE_8000 |\n\t\t\t SNDRV_PCM_RATE_16000),\n\t.rate_min =\t\t8000,\n\t.rate_max =\t\t16000,\n\t.channels_min =\t\t1,\n\t.channels_max =\t\t1,\n\t.buffer_bytes_max =\t(256*1024),\n\t.period_bytes_min =\t64,\n\t.period_bytes_max =\t(256*1024),\n\t.periods_min =\t\t1,\n\t.periods_max =\t\t1024,\n\t.fifo_size =\t\t0,\n};\n\nstatic int snd_ali_modem_open(struct snd_pcm_substream *substream, int rec,\n\t\t\t      int channel)\n{\n\tstatic const unsigned int rates[] = {8000, 9600, 12000, 16000};\n\tstatic const struct snd_pcm_hw_constraint_list hw_constraint_rates = {\n\t\t.count = ARRAY_SIZE(rates),\n\t\t.list = rates,\n\t\t.mask = 0,\n\t};\n\tint err = snd_ali_open(substream, rec, channel, &snd_ali_modem);\n\n\tif (err)\n\t\treturn err;\n\treturn snd_pcm_hw_constraint_list(substream->runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_RATE, &hw_constraint_rates);\n}\n\nstatic int snd_ali_modem_playback_open(struct snd_pcm_substream *substream)\n{\n\treturn snd_ali_modem_open(substream, 0, ALI_MODEM_OUT_CHANNEL);\n}\n\nstatic int snd_ali_modem_capture_open(struct snd_pcm_substream *substream)\n{\n\treturn snd_ali_modem_open(substream, 1, ALI_MODEM_IN_CHANNEL);\n}\n\nstatic const struct snd_pcm_ops snd_ali_modem_playback_ops = {\n\t.open =\t\tsnd_ali_modem_playback_open,\n\t.close =\tsnd_ali_close,\n\t.hw_params =\tsnd_ali_modem_hw_params,\n\t.prepare =\tsnd_ali_prepare,\n\t.trigger =\tsnd_ali_trigger,\n\t.pointer =\tsnd_ali_pointer,\n};\n\nstatic const struct snd_pcm_ops snd_ali_modem_capture_ops = {\n\t.open =\t\tsnd_ali_modem_capture_open,\n\t.close =\tsnd_ali_close,\n\t.hw_params =\tsnd_ali_modem_hw_params,\n\t.prepare =\tsnd_ali_prepare,\n\t.trigger =\tsnd_ali_trigger,\n\t.pointer =\tsnd_ali_pointer,\n};\n\n\nstruct ali_pcm_description {\n\tchar *name;\n\tunsigned int playback_num;\n\tunsigned int capture_num;\n\tconst struct snd_pcm_ops *playback_ops;\n\tconst struct snd_pcm_ops *capture_ops;\n\tunsigned short class;\n};\n\n\nstatic void snd_ali_pcm_free(struct snd_pcm *pcm)\n{\n\tstruct snd_ali *codec = pcm->private_data;\n\tcodec->pcm[pcm->device] = NULL;\n}\n\n\nstatic int snd_ali_pcm(struct snd_ali *codec, int device,\n\t\t       struct ali_pcm_description *desc)\n{\n\tstruct snd_pcm *pcm;\n\tint err;\n\n\terr = snd_pcm_new(codec->card, desc->name, device,\n\t\t\t  desc->playback_num, desc->capture_num, &pcm);\n\tif (err < 0) {\n\t\tdev_err(codec->card->dev,\n\t\t\t\"snd_ali_pcm: err called snd_pcm_new.\\n\");\n\t\treturn err;\n\t}\n\tpcm->private_data = codec;\n\tpcm->private_free = snd_ali_pcm_free;\n\tif (desc->playback_ops)\n\t\tsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK,\n\t\t\t\tdesc->playback_ops);\n\tif (desc->capture_ops)\n\t\tsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE,\n\t\t\t\tdesc->capture_ops);\n\n\tsnd_pcm_set_managed_buffer_all(pcm, SNDRV_DMA_TYPE_DEV,\n\t\t\t\t       &codec->pci->dev, 64*1024, 128*1024);\n\n\tpcm->info_flags = 0;\n\tpcm->dev_class = desc->class;\n\tpcm->dev_subclass = SNDRV_PCM_SUBCLASS_GENERIC_MIX;\n\tstrcpy(pcm->name, desc->name);\n\tcodec->pcm[0] = pcm;\n\treturn 0;\n}\n\nstatic struct ali_pcm_description ali_pcms[] = {\n\t{ .name = \"ALI 5451\",\n\t  .playback_num = ALI_CHANNELS,\n\t  .capture_num = 1,\n\t  .playback_ops = &snd_ali_playback_ops,\n\t  .capture_ops = &snd_ali_capture_ops\n\t},\n\t{ .name = \"ALI 5451 modem\",\n\t  .playback_num = 1,\n\t  .capture_num = 1,\n\t  .playback_ops = &snd_ali_modem_playback_ops,\n\t  .capture_ops = &snd_ali_modem_capture_ops,\n\t  .class = SNDRV_PCM_CLASS_MODEM\n\t}\n};\n\nstatic int snd_ali_build_pcms(struct snd_ali *codec)\n{\n\tint i, err;\n\tfor (i = 0; i < codec->num_of_codecs && i < ARRAY_SIZE(ali_pcms); i++) {\n\t\terr = snd_ali_pcm(codec, i, &ali_pcms[i]);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\treturn 0;\n}\n\n\n#define ALI5451_SPDIF(xname, xindex, value) \\\n{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex,\\\n.info = snd_ali5451_spdif_info, .get = snd_ali5451_spdif_get, \\\n.put = snd_ali5451_spdif_put, .private_value = value}\n\n#define snd_ali5451_spdif_info\t\tsnd_ctl_boolean_mono_info\n\nstatic int snd_ali5451_spdif_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_ali *codec = kcontrol->private_data;\n\tunsigned int spdif_enable;\n\n\tspdif_enable = ucontrol->value.integer.value[0] ? 1 : 0;\n\n\tspin_lock_irq(&codec->reg_lock);\n\tswitch (kcontrol->private_value) {\n\tcase 0:\n\t\tspdif_enable = (codec->spdif_mask & 0x02) ? 1 : 0;\n\t\tbreak;\n\tcase 1:\n\t\tspdif_enable = ((codec->spdif_mask & 0x02) &&\n\t\t\t  (codec->spdif_mask & 0x04)) ? 1 : 0;\n\t\tbreak;\n\tcase 2:\n\t\tspdif_enable = (codec->spdif_mask & 0x01) ? 1 : 0;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tucontrol->value.integer.value[0] = spdif_enable;\n\tspin_unlock_irq(&codec->reg_lock);\n\treturn 0;\n}\n\nstatic int snd_ali5451_spdif_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_ali *codec = kcontrol->private_data;\n\tunsigned int change = 0, spdif_enable = 0;\n\n\tspdif_enable = ucontrol->value.integer.value[0] ? 1 : 0;\n\n\tspin_lock_irq(&codec->reg_lock);\n\tswitch (kcontrol->private_value) {\n\tcase 0:\n\t\tchange = (codec->spdif_mask & 0x02) ? 1 : 0;\n\t\tchange = change ^ spdif_enable;\n\t\tif (change) {\n\t\t\tif (spdif_enable) {\n\t\t\t\tcodec->spdif_mask |= 0x02;\n\t\t\t\tsnd_ali_enable_spdif_out(codec);\n\t\t\t} else {\n\t\t\t\tcodec->spdif_mask &= ~(0x02);\n\t\t\t\tcodec->spdif_mask &= ~(0x04);\n\t\t\t\tsnd_ali_disable_spdif_out(codec);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase 1: \n\t\tchange = (codec->spdif_mask & 0x04) ? 1 : 0;\n\t\tchange = change ^ spdif_enable;\n\t\tif (change && (codec->spdif_mask & 0x02)) {\n\t\t\tif (spdif_enable) {\n\t\t\t\tcodec->spdif_mask |= 0x04;\n\t\t\t\tsnd_ali_enable_spdif_chnout(codec);\n\t\t\t} else {\n\t\t\t\tcodec->spdif_mask &= ~(0x04);\n\t\t\t\tsnd_ali_disable_spdif_chnout(codec);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tchange = (codec->spdif_mask & 0x01) ? 1 : 0;\n\t\tchange = change ^ spdif_enable;\n\t\tif (change) {\n\t\t\tif (spdif_enable) {\n\t\t\t\tcodec->spdif_mask |= 0x01;\n\t\t\t\tsnd_ali_enable_spdif_in(codec);\n\t\t\t} else {\n\t\t\t\tcodec->spdif_mask &= ~(0x01);\n\t\t\t\tsnd_ali_disable_spdif_in(codec);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tspin_unlock_irq(&codec->reg_lock);\n\t\n\treturn change;\n}\n\nstatic const struct snd_kcontrol_new snd_ali5451_mixer_spdif[] = {\n\t \n\t \n\tALI5451_SPDIF(SNDRV_CTL_NAME_IEC958(\"Output \",NONE,SWITCH), 0, 0),\n\t \n\tALI5451_SPDIF(SNDRV_CTL_NAME_IEC958(\"Channel Output \",NONE,SWITCH), 0, 1),\n\t \n\tALI5451_SPDIF(SNDRV_CTL_NAME_IEC958(\"\",CAPTURE,SWITCH), 0, 2)\n};\n\nstatic int snd_ali_mixer(struct snd_ali *codec)\n{\n\tstruct snd_ac97_template ac97;\n\tunsigned int idx;\n\tint i, err;\n\tstatic const struct snd_ac97_bus_ops ops = {\n\t\t.write = snd_ali_codec_write,\n\t\t.read = snd_ali_codec_read,\n\t};\n\n\terr = snd_ac97_bus(codec->card, 0, &ops, codec, &codec->ac97_bus);\n\tif (err < 0)\n\t\treturn err;\n\n\tmemset(&ac97, 0, sizeof(ac97));\n\tac97.private_data = codec;\n\n\tfor (i = 0; i < codec->num_of_codecs; i++) {\n\t\tac97.num = i;\n\t\terr = snd_ac97_mixer(codec->ac97_bus, &ac97, &codec->ac97[i]);\n\t\tif (err < 0) {\n\t\t\tdev_err(codec->card->dev,\n\t\t\t\t   \"ali mixer %d creating error.\\n\", i);\n\t\t\tif (i == 0)\n\t\t\t\treturn err;\n\t\t\tcodec->num_of_codecs = 1;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (codec->spdif_support) {\n\t\tfor (idx = 0; idx < ARRAY_SIZE(snd_ali5451_mixer_spdif); idx++) {\n\t\t\terr = snd_ctl_add(codec->card,\n\t\t\t\t\t  snd_ctl_new1(&snd_ali5451_mixer_spdif[idx], codec));\n\t\t\tif (err < 0)\n\t\t\t\treturn err;\n\t\t}\n\t}\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int ali_suspend(struct device *dev)\n{\n\tstruct snd_card *card = dev_get_drvdata(dev);\n\tstruct snd_ali *chip = card->private_data;\n\tstruct snd_ali_image *im;\n\tint i, j;\n\n\tim = chip->image;\n\tif (!im)\n\t\treturn 0;\n\n\tsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\n\tfor (i = 0; i < chip->num_of_codecs; i++)\n\t\tsnd_ac97_suspend(chip->ac97[i]);\n\n\tspin_lock_irq(&chip->reg_lock);\n\t\n\tim->regs[ALI_MISCINT >> 2] = inl(ALI_REG(chip, ALI_MISCINT));\n\t \n\tim->regs[ALI_STOP >> 2] = inl(ALI_REG(chip, ALI_STOP));\n\t\n\t \n\toutl(0, ALI_REG(chip, ALI_MISCINT));\n\t\n\tfor (i = 0; i < ALI_GLOBAL_REGS; i++) {\t\n\t\tif ((i*4 == ALI_MISCINT) || (i*4 == ALI_STOP))\n\t\t\tcontinue;\n\t\tim->regs[i] = inl(ALI_REG(chip, i*4));\n\t}\n\t\n\tfor (i = 0; i < ALI_CHANNELS; i++) {\n\t\toutb(i, ALI_REG(chip, ALI_GC_CIR));\n\t\tfor (j = 0; j < ALI_CHANNEL_REGS; j++) \n\t\t\tim->channel_regs[i][j] = inl(ALI_REG(chip, j*4 + 0xe0));\n\t}\n\n\t \n\toutl(0xffffffff, ALI_REG(chip, ALI_STOP));\n\n\tspin_unlock_irq(&chip->reg_lock);\n\treturn 0;\n}\n\nstatic int ali_resume(struct device *dev)\n{\n\tstruct snd_card *card = dev_get_drvdata(dev);\n\tstruct snd_ali *chip = card->private_data;\n\tstruct snd_ali_image *im;\n\tint i, j;\n\n\tim = chip->image;\n\tif (!im)\n\t\treturn 0;\n\n\tspin_lock_irq(&chip->reg_lock);\n\t\n\tfor (i = 0; i < ALI_CHANNELS; i++) {\n\t\toutb(i, ALI_REG(chip, ALI_GC_CIR));\n\t\tfor (j = 0; j < ALI_CHANNEL_REGS; j++) \n\t\t\toutl(im->channel_regs[i][j], ALI_REG(chip, j*4 + 0xe0));\n\t}\n\t\n\tfor (i = 0; i < ALI_GLOBAL_REGS; i++) {\t\n\t\tif ((i*4 == ALI_MISCINT) || (i*4 == ALI_STOP) ||\n\t\t    (i*4 == ALI_START))\n\t\t\tcontinue;\n\t\toutl(im->regs[i], ALI_REG(chip, i*4));\n\t}\n\t\n\t \n\toutl(im->regs[ALI_START >> 2], ALI_REG(chip, ALI_START));\n\t \n\toutl(im->regs[ALI_MISCINT >> 2], ALI_REG(chip, ALI_MISCINT));\n\t\n\tspin_unlock_irq(&chip->reg_lock);\n\n\tfor (i = 0 ; i < chip->num_of_codecs; i++)\n\t\tsnd_ac97_resume(chip->ac97[i]);\n\t\n\tsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(ali_pm, ali_suspend, ali_resume);\n#define ALI_PM_OPS\t&ali_pm\n#else\n#define ALI_PM_OPS\tNULL\n#endif  \n\nstatic void snd_ali_free(struct snd_card *card)\n{\n\tstruct snd_ali *codec = card->private_data;\n\n\tif (codec->hw_initialized)\n\t\tsnd_ali_disable_address_interrupt(codec);\n\tpci_dev_put(codec->pci_m1533);\n\tpci_dev_put(codec->pci_m7101);\n}\n\nstatic int snd_ali_chip_init(struct snd_ali *codec)\n{\n\tunsigned int legacy;\n\tunsigned char temp;\n\tstruct pci_dev *pci_dev;\n\n\tdev_dbg(codec->card->dev, \"chip initializing ...\\n\");\n\n\tif (snd_ali_reset_5451(codec)) {\n\t\tdev_err(codec->card->dev, \"ali_chip_init: reset 5451 error.\\n\");\n\t\treturn -1;\n\t}\n\n\tif (codec->revision == ALI_5451_V02) {\n        \tpci_dev = codec->pci_m1533;\n\t\tpci_read_config_byte(pci_dev, 0x59, &temp);\n\t\ttemp |= 0x80;\n\t\tpci_write_config_byte(pci_dev, 0x59, temp);\n\t\n\t\tpci_dev = codec->pci_m7101;\n\t\tpci_read_config_byte(pci_dev, 0xb8, &temp);\n\t\ttemp |= 0x20;\n\t\tpci_write_config_byte(pci_dev, 0xB8, temp);\n\t}\n\n\tpci_read_config_dword(codec->pci, 0x44, &legacy);\n\tlegacy &= 0xff00ff00;\n\tlegacy |= 0x000800aa;\n\tpci_write_config_dword(codec->pci, 0x44, legacy);\n\n\toutl(0x80000001, ALI_REG(codec, ALI_GLOBAL_CONTROL));\n\toutl(0x00000000, ALI_REG(codec, ALI_AINTEN));\n\toutl(0xffffffff, ALI_REG(codec, ALI_AINT));\n\toutl(0x00000000, ALI_REG(codec, ALI_VOLUME));\n\toutb(0x10, \t ALI_REG(codec, ALI_MPUR2));\n\n\tcodec->ac97_ext_id = snd_ali_codec_peek(codec, 0, AC97_EXTENDED_ID);\n\tcodec->ac97_ext_status = snd_ali_codec_peek(codec, 0,\n\t\t\t\t\t\t    AC97_EXTENDED_STATUS);\n\tif (codec->spdif_support) {\n\t\tsnd_ali_enable_spdif_out(codec);\n\t\tcodec->spdif_mask = 0x00000002;\n\t}\n\n\tcodec->num_of_codecs = 1;\n\n\t \n\tif (inl(ALI_REG(codec, ALI_SCTRL)) & ALI_SCTRL_CODEC2_READY) {\n\t\tcodec->num_of_codecs++;\n\t\toutl(inl(ALI_REG(codec, ALI_SCTRL)) |\n\t\t     (ALI_SCTRL_LINE_IN2 | ALI_SCTRL_GPIO_IN2 |\n\t\t      ALI_SCTRL_LINE_OUT_EN),\n\t\t     ALI_REG(codec, ALI_SCTRL));\n\t}\n\n\tdev_dbg(codec->card->dev, \"chip initialize succeed.\\n\");\n\treturn 0;\n\n}\n\n \nstatic void snd_ali_proc_read(struct snd_info_entry *entry,\n\t\t\t      struct snd_info_buffer *buf)\n{\n\tstruct snd_ali *codec = entry->private_data;\n\tint i;\n\tfor (i = 0; i < 256 ; i+= 4)\n\t\tsnd_iprintf(buf, \"%02x: %08x\\n\", i, inl(ALI_REG(codec, i)));\n}\n\nstatic void snd_ali_proc_init(struct snd_ali *codec)\n{\n\tsnd_card_ro_proc_new(codec->card, \"ali5451\", codec, snd_ali_proc_read);\n}\n\nstatic int snd_ali_resources(struct snd_ali *codec)\n{\n\tint err;\n\n\tdev_dbg(codec->card->dev, \"resources allocation ...\\n\");\n\terr = pci_request_regions(codec->pci, \"ALI 5451\");\n\tif (err < 0)\n\t\treturn err;\n\tcodec->port = pci_resource_start(codec->pci, 0);\n\n\tif (devm_request_irq(&codec->pci->dev, codec->pci->irq,\n\t\t\t     snd_ali_card_interrupt,\n\t\t\t     IRQF_SHARED, KBUILD_MODNAME, codec)) {\n\t\tdev_err(codec->card->dev, \"Unable to request irq.\\n\");\n\t\treturn -EBUSY;\n\t}\n\tcodec->irq = codec->pci->irq;\n\tcodec->card->sync_irq = codec->irq;\n\tdev_dbg(codec->card->dev, \"resources allocated.\\n\");\n\treturn 0;\n}\n\nstatic int snd_ali_create(struct snd_card *card,\n\t\t\t  struct pci_dev *pci,\n\t\t\t  int pcm_streams,\n\t\t\t  int spdif_support)\n{\n\tstruct snd_ali *codec = card->private_data;\n\tint i, err;\n\tunsigned short cmdw;\n\n\tdev_dbg(card->dev, \"creating ...\\n\");\n\n\t \n\terr = pcim_enable_device(pci);\n\tif (err < 0)\n\t\treturn err;\n\t \n\tif (dma_set_mask_and_coherent(&pci->dev, DMA_BIT_MASK(31))) {\n\t\tdev_err(card->dev,\n\t\t\t\"architecture does not support 31bit PCI busmaster DMA\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tspin_lock_init(&codec->reg_lock);\n\tspin_lock_init(&codec->voice_alloc);\n\n\tcodec->card = card;\n\tcodec->pci = pci;\n\tcodec->irq = -1;\n\tcodec->revision = pci->revision;\n\tcodec->spdif_support = spdif_support;\n\n\tif (pcm_streams < 1)\n\t\tpcm_streams = 1;\n\tif (pcm_streams > 32)\n\t\tpcm_streams = 32;\n\t\n\tpci_set_master(pci);\n\tpci_read_config_word(pci, PCI_COMMAND, &cmdw);\n\tif ((cmdw & PCI_COMMAND_IO) != PCI_COMMAND_IO) {\n\t\tcmdw |= PCI_COMMAND_IO;\n\t\tpci_write_config_word(pci, PCI_COMMAND, cmdw);\n\t}\n\t\n\tif (snd_ali_resources(codec))\n\t\treturn -EBUSY;\n\tcard->private_free = snd_ali_free;\n\n\tcodec->synth.chmap = 0;\n\tcodec->synth.chcnt = 0;\n\tcodec->spdif_mask = 0;\n\tcodec->synth.synthcount = 0;\n\n\tif (codec->revision == ALI_5451_V02)\n\t\tcodec->chregs.regs.ac97read = ALI_AC97_WRITE;\n\telse\n\t\tcodec->chregs.regs.ac97read = ALI_AC97_READ;\n\tcodec->chregs.regs.ac97write = ALI_AC97_WRITE;\n\n\tcodec->chregs.regs.start  = ALI_START;\n\tcodec->chregs.regs.stop   = ALI_STOP;\n\tcodec->chregs.regs.aint   = ALI_AINT;\n\tcodec->chregs.regs.ainten = ALI_AINTEN;\n\n\tcodec->chregs.data.start  = 0x00;\n\tcodec->chregs.data.stop   = 0x00;\n\tcodec->chregs.data.aint   = 0x00;\n\tcodec->chregs.data.ainten = 0x00;\n\n\t \n\tcodec->pci_m1533 = pci_get_device(0x10b9, 0x1533, NULL);\n\tif (!codec->pci_m1533) {\n\t\tdev_err(card->dev, \"cannot find ALi 1533 chip.\\n\");\n\t\treturn -ENODEV;\n\t}\n\t \n\tcodec->pci_m7101 = pci_get_device(0x10b9, 0x7101, NULL);\n\tif (!codec->pci_m7101 && codec->revision == ALI_5451_V02) {\n\t\tdev_err(card->dev, \"cannot find ALi 7101 chip.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tfor (i = 0; i < ALI_CHANNELS; i++)\n\t\tcodec->synth.voices[i].number = i;\n\n\terr = snd_ali_chip_init(codec);\n\tif (err < 0) {\n\t\tdev_err(card->dev, \"ali create: chip init error.\\n\");\n\t\treturn err;\n\t}\n\n#ifdef CONFIG_PM_SLEEP\n\tcodec->image = devm_kmalloc(&pci->dev, sizeof(*codec->image),\n\t\t\t\t    GFP_KERNEL);\n\tif (!codec->image)\n\t\tdev_warn(card->dev, \"can't allocate apm buffer\\n\");\n#endif\n\n\tsnd_ali_enable_address_interrupt(codec);\n\tcodec->hw_initialized = 1;\n\treturn 0;\n}\n\nstatic int __snd_ali_probe(struct pci_dev *pci,\n\t\t\t   const struct pci_device_id *pci_id)\n{\n\tstruct snd_card *card;\n\tstruct snd_ali *codec;\n\tint err;\n\n\tdev_dbg(&pci->dev, \"probe ...\\n\");\n\n\terr = snd_devm_card_new(&pci->dev, index, id, THIS_MODULE,\n\t\t\t\tsizeof(*codec), &card);\n\tif (err < 0)\n\t\treturn err;\n\tcodec = card->private_data;\n\n\terr = snd_ali_create(card, pci, pcm_channels, spdif);\n\tif (err < 0)\n\t\treturn err;\n\n\tdev_dbg(&pci->dev, \"mixer building ...\\n\");\n\terr = snd_ali_mixer(codec);\n\tif (err < 0)\n\t\treturn err;\n\t\n\tdev_dbg(&pci->dev, \"pcm building ...\\n\");\n\terr = snd_ali_build_pcms(codec);\n\tif (err < 0)\n\t\treturn err;\n\n\tsnd_ali_proc_init(codec);\n\n\tstrcpy(card->driver, \"ALI5451\");\n\tstrcpy(card->shortname, \"ALI 5451\");\n\t\n\tsprintf(card->longname, \"%s at 0x%lx, irq %i\",\n\t\tcard->shortname, codec->port, codec->irq);\n\n\tdev_dbg(&pci->dev, \"register card.\\n\");\n\terr = snd_card_register(card);\n\tif (err < 0)\n\t\treturn err;\n\n\tpci_set_drvdata(pci, card);\n\treturn 0;\n}\n\nstatic int snd_ali_probe(struct pci_dev *pci,\n\t\t\t const struct pci_device_id *pci_id)\n{\n\treturn snd_card_free_on_error(&pci->dev, __snd_ali_probe(pci, pci_id));\n}\n\nstatic struct pci_driver ali5451_driver = {\n\t.name = KBUILD_MODNAME,\n\t.id_table = snd_ali_ids,\n\t.probe = snd_ali_probe,\n\t.driver = {\n\t\t.pm = ALI_PM_OPS,\n\t},\n};                                \n\nmodule_pci_driver(ali5451_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}