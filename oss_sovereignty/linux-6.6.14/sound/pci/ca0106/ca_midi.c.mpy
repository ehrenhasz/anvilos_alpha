{
  "module_name": "ca_midi.c",
  "hash_id": "48da3216a2a14cd178b04df8829cf06948c5c1ad7a41207ceb87d18e65f99edc",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ca0106/ca_midi.c",
  "human_readable_source": "\n \n\n#include <linux/spinlock.h>\n#include <sound/core.h>\n#include <sound/rawmidi.h>\n\n#include \"ca_midi.h\"\n\n#define ca_midi_write_data(midi, data)\tmidi->write(midi, data, 0)\n#define ca_midi_write_cmd(midi, data)\tmidi->write(midi, data, 1)\n#define ca_midi_read_data(midi)\t\tmidi->read(midi, 0)\n#define ca_midi_read_stat(midi)\t\tmidi->read(midi, 1)\n#define ca_midi_input_avail(midi)\t(!(ca_midi_read_stat(midi) & midi->input_avail))\n#define ca_midi_output_ready(midi)\t(!(ca_midi_read_stat(midi) & midi->output_ready))\n\nstatic void ca_midi_clear_rx(struct snd_ca_midi *midi)\n{\n\tint timeout = 100000;\n\tfor (; timeout > 0 && ca_midi_input_avail(midi); timeout--)\n\t\tca_midi_read_data(midi);\n#ifdef CONFIG_SND_DEBUG\n\tif (timeout <= 0)\n\t\tpr_err(\"ca_midi_clear_rx: timeout (status = 0x%x)\\n\",\n\t\t\t   ca_midi_read_stat(midi));\n#endif\n}\n\nstatic void ca_midi_interrupt(struct snd_ca_midi *midi, unsigned int status)\n{\n\tunsigned char byte;\n\n\tif (midi->rmidi == NULL) {\n\t\tmidi->interrupt_disable(midi,midi->tx_enable | midi->rx_enable);\n\t\treturn;\n\t}\n\n\tspin_lock(&midi->input_lock);\n\tif ((status & midi->ipr_rx) && ca_midi_input_avail(midi)) {\n\t\tif (!(midi->midi_mode & CA_MIDI_MODE_INPUT)) {\n\t\t\tca_midi_clear_rx(midi);\n\t\t} else {\n\t\t\tbyte = ca_midi_read_data(midi);\n\t\t\tif(midi->substream_input)\n\t\t\t\tsnd_rawmidi_receive(midi->substream_input, &byte, 1);\n\n\n\t\t}\n\t}\n\tspin_unlock(&midi->input_lock);\n\n\tspin_lock(&midi->output_lock);\n\tif ((status & midi->ipr_tx) && ca_midi_output_ready(midi)) {\n\t\tif (midi->substream_output &&\n\t\t    snd_rawmidi_transmit(midi->substream_output, &byte, 1) == 1) {\n\t\t\tca_midi_write_data(midi, byte);\n\t\t} else {\n\t\t\tmidi->interrupt_disable(midi,midi->tx_enable);\n\t\t}\n\t}\n\tspin_unlock(&midi->output_lock);\n\n}\n\nstatic void ca_midi_cmd(struct snd_ca_midi *midi, unsigned char cmd, int ack)\n{\n\tunsigned long flags;\n\tint timeout, ok;\n\n\tspin_lock_irqsave(&midi->input_lock, flags);\n\tca_midi_write_data(midi, 0x00);\n\t \n\n\tca_midi_write_cmd(midi, cmd);\n\tif (ack) {\n\t\tok = 0;\n\t\ttimeout = 10000;\n\t\twhile (!ok && timeout-- > 0) {\n\t\t\tif (ca_midi_input_avail(midi)) {\n\t\t\t\tif (ca_midi_read_data(midi) == midi->ack)\n\t\t\t\t\tok = 1;\n\t\t\t}\n\t\t}\n\t\tif (!ok && ca_midi_read_data(midi) == midi->ack)\n\t\t\tok = 1;\n\t} else {\n\t\tok = 1;\n\t}\n\tspin_unlock_irqrestore(&midi->input_lock, flags);\n\tif (!ok)\n\t\tpr_err(\"ca_midi_cmd: 0x%x failed at 0x%x (status = 0x%x, data = 0x%x)!!!\\n\",\n\t\t\t   cmd,\n\t\t\t   midi->get_dev_id_port(midi->dev_id),\n\t\t\t   ca_midi_read_stat(midi),\n\t\t\t   ca_midi_read_data(midi));\n}\n\nstatic int ca_midi_input_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_ca_midi *midi = substream->rmidi->private_data;\n\tunsigned long flags;\n\t\n\tif (snd_BUG_ON(!midi->dev_id))\n\t\treturn -ENXIO;\n\tspin_lock_irqsave(&midi->open_lock, flags);\n\tmidi->midi_mode |= CA_MIDI_MODE_INPUT;\n\tmidi->substream_input = substream;\n\tif (!(midi->midi_mode & CA_MIDI_MODE_OUTPUT)) {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t\tca_midi_cmd(midi, midi->reset, 1);\n\t\tca_midi_cmd(midi, midi->enter_uart, 1);\n\t} else {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t}\n\treturn 0;\n}\n\nstatic int ca_midi_output_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_ca_midi *midi = substream->rmidi->private_data;\n\tunsigned long flags;\n\n\tif (snd_BUG_ON(!midi->dev_id))\n\t\treturn -ENXIO;\n\tspin_lock_irqsave(&midi->open_lock, flags);\n\tmidi->midi_mode |= CA_MIDI_MODE_OUTPUT;\n\tmidi->substream_output = substream;\n\tif (!(midi->midi_mode & CA_MIDI_MODE_INPUT)) {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t\tca_midi_cmd(midi, midi->reset, 1);\n\t\tca_midi_cmd(midi, midi->enter_uart, 1);\n\t} else {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t}\n\treturn 0;\n}\n\nstatic int ca_midi_input_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_ca_midi *midi = substream->rmidi->private_data;\n\tunsigned long flags;\n\n\tif (snd_BUG_ON(!midi->dev_id))\n\t\treturn -ENXIO;\n\tspin_lock_irqsave(&midi->open_lock, flags);\n\tmidi->interrupt_disable(midi,midi->rx_enable);\n\tmidi->midi_mode &= ~CA_MIDI_MODE_INPUT;\n\tmidi->substream_input = NULL;\n\tif (!(midi->midi_mode & CA_MIDI_MODE_OUTPUT)) {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t\tca_midi_cmd(midi, midi->reset, 0);\n\t} else {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t}\n\treturn 0;\n}\n\nstatic int ca_midi_output_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_ca_midi *midi = substream->rmidi->private_data;\n\tunsigned long flags;\n\n\tif (snd_BUG_ON(!midi->dev_id))\n\t\treturn -ENXIO;\n\t\n\tspin_lock_irqsave(&midi->open_lock, flags);\n\n\tmidi->interrupt_disable(midi,midi->tx_enable);\n\tmidi->midi_mode &= ~CA_MIDI_MODE_OUTPUT;\n\tmidi->substream_output = NULL;\n\t\n\tif (!(midi->midi_mode & CA_MIDI_MODE_INPUT)) {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t\tca_midi_cmd(midi, midi->reset, 0);\n\t} else {\n\t\tspin_unlock_irqrestore(&midi->open_lock, flags);\n\t}\n\treturn 0;\n}\n\nstatic void ca_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\n{\n\tstruct snd_ca_midi *midi = substream->rmidi->private_data;\n\n\tif (snd_BUG_ON(!midi->dev_id))\n\t\treturn;\n\n\tif (up) {\n\t\tmidi->interrupt_enable(midi,midi->rx_enable);\n\t} else {\n\t\tmidi->interrupt_disable(midi, midi->rx_enable);\n\t}\n}\n\nstatic void ca_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\n{\n\tstruct snd_ca_midi *midi = substream->rmidi->private_data;\n\tunsigned long flags;\n\n\tif (snd_BUG_ON(!midi->dev_id))\n\t\treturn;\n\n\tif (up) {\n\t\tint max = 4;\n\t\tunsigned char byte;\n\n\t\tspin_lock_irqsave(&midi->output_lock, flags);\n\t\n\t\t \n\t\twhile (max > 0) {\n\t\t\tif (ca_midi_output_ready(midi)) {\n\t\t\t\tif (!(midi->midi_mode & CA_MIDI_MODE_OUTPUT) ||\n\t\t\t\t    snd_rawmidi_transmit(substream, &byte, 1) != 1) {\n\t\t\t\t\t \n\t\t\t\t\tspin_unlock_irqrestore(&midi->output_lock, flags);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tca_midi_write_data(midi, byte);\n\t\t\t\tmax--;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tspin_unlock_irqrestore(&midi->output_lock, flags);\n\t\tmidi->interrupt_enable(midi,midi->tx_enable);\n\n\t} else {\n\t\tmidi->interrupt_disable(midi,midi->tx_enable);\n\t}\n}\n\nstatic const struct snd_rawmidi_ops ca_midi_output =\n{\n\t.open =\t\tca_midi_output_open,\n\t.close =\tca_midi_output_close,\n\t.trigger =\tca_midi_output_trigger,\n};\n\nstatic const struct snd_rawmidi_ops ca_midi_input =\n{\n\t.open =\t\tca_midi_input_open,\n\t.close =\tca_midi_input_close,\n\t.trigger =\tca_midi_input_trigger,\n};\n\nstatic void ca_midi_free(struct snd_ca_midi *midi)\n{\n\tmidi->interrupt = NULL;\n\tmidi->interrupt_enable = NULL;\n\tmidi->interrupt_disable = NULL;\n\tmidi->read = NULL;\n\tmidi->write = NULL;\n\tmidi->get_dev_id_card = NULL;\n\tmidi->get_dev_id_port = NULL;\n\tmidi->rmidi = NULL;\n}\n\nstatic void ca_rmidi_free(struct snd_rawmidi *rmidi)\n{\n\tca_midi_free(rmidi->private_data);\n}\n\nint ca_midi_init(void *dev_id, struct snd_ca_midi *midi, int device, char *name)\n{\n\tstruct snd_rawmidi *rmidi;\n\tint err;\n\n\terr = snd_rawmidi_new(midi->get_dev_id_card(midi->dev_id), name, device, 1, 1, &rmidi);\n\tif (err < 0)\n\t\treturn err;\n\n\tmidi->dev_id = dev_id;\n\tmidi->interrupt = ca_midi_interrupt;\n\n\tspin_lock_init(&midi->open_lock);\n\tspin_lock_init(&midi->input_lock);\n\tspin_lock_init(&midi->output_lock);\n\n\tstrcpy(rmidi->name, name);\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &ca_midi_output);\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &ca_midi_input);\n\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT |\n\t                     SNDRV_RAWMIDI_INFO_INPUT |\n\t                     SNDRV_RAWMIDI_INFO_DUPLEX;\n\trmidi->private_data = midi;\n\trmidi->private_free = ca_rmidi_free;\n\t\n\tmidi->rmidi = rmidi;\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}