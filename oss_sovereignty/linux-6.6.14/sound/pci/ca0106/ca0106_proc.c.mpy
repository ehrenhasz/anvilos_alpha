{
  "module_name": "ca0106_proc.c",
  "hash_id": "4fc34084e9246f11cbab60720817687d509ac011a0645796252ac4fe868371cb",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ca0106/ca0106_proc.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/moduleparam.h>\n#include <linux/io.h>\n#include <sound/core.h>\n#include <sound/initval.h>\n#include <sound/pcm.h>\n#include <sound/ac97_codec.h>\n#include <sound/info.h>\n#include <sound/asoundef.h>\n\n#include \"ca0106.h\"\n\n\nstruct snd_ca0106_category_str {\n\tint val;\n\tconst char *name;\n};\n\nstatic const struct snd_ca0106_category_str snd_ca0106_con_category[] = {\n\t{ IEC958_AES1_CON_DAT, \"DAT\" },\n\t{ IEC958_AES1_CON_VCR, \"VCR\" },\n\t{ IEC958_AES1_CON_MICROPHONE, \"microphone\" },\n\t{ IEC958_AES1_CON_SYNTHESIZER, \"synthesizer\" },\n\t{ IEC958_AES1_CON_RATE_CONVERTER, \"rate converter\" },\n\t{ IEC958_AES1_CON_MIXER, \"mixer\" },\n\t{ IEC958_AES1_CON_SAMPLER, \"sampler\" },\n\t{ IEC958_AES1_CON_PCM_CODER, \"PCM coder\" },\n\t{ IEC958_AES1_CON_IEC908_CD, \"CD\" },\n\t{ IEC958_AES1_CON_NON_IEC908_CD, \"non-IEC908 CD\" },\n\t{ IEC958_AES1_CON_GENERAL, \"general\" },\n};\n\n\nstatic void snd_ca0106_proc_dump_iec958( struct snd_info_buffer *buffer, u32 value)\n{\n\tint i;\n\tu32 status[4];\n\tstatus[0] = value & 0xff;\n\tstatus[1] = (value >> 8) & 0xff;\n\tstatus[2] = (value >> 16)  & 0xff;\n\tstatus[3] = (value >> 24)  & 0xff;\n\t\n\tif (! (status[0] & IEC958_AES0_PROFESSIONAL)) {\n\t\t \n\t\tsnd_iprintf(buffer, \"Mode: consumer\\n\");\n\t\tsnd_iprintf(buffer, \"Data: \");\n\t\tif (!(status[0] & IEC958_AES0_NONAUDIO)) {\n\t\t\tsnd_iprintf(buffer, \"audio\\n\");\n\t\t} else {\n\t\t\tsnd_iprintf(buffer, \"non-audio\\n\");\n\t\t}\n\t\tsnd_iprintf(buffer, \"Rate: \");\n\t\tswitch (status[3] & IEC958_AES3_CON_FS) {\n\t\tcase IEC958_AES3_CON_FS_44100:\n\t\t\tsnd_iprintf(buffer, \"44100 Hz\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES3_CON_FS_48000:\n\t\t\tsnd_iprintf(buffer, \"48000 Hz\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES3_CON_FS_32000:\n\t\t\tsnd_iprintf(buffer, \"32000 Hz\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tsnd_iprintf(buffer, \"Copyright: \");\n\t\tif (status[0] & IEC958_AES0_CON_NOT_COPYRIGHT) {\n\t\t\tsnd_iprintf(buffer, \"permitted\\n\");\n\t\t} else {\n\t\t\tsnd_iprintf(buffer, \"protected\\n\");\n\t\t}\n\t\tsnd_iprintf(buffer, \"Emphasis: \");\n\t\tif ((status[0] & IEC958_AES0_CON_EMPHASIS) != IEC958_AES0_CON_EMPHASIS_5015) {\n\t\t\tsnd_iprintf(buffer, \"none\\n\");\n\t\t} else {\n\t\t\tsnd_iprintf(buffer, \"50/15us\\n\");\n\t\t}\n\t\tsnd_iprintf(buffer, \"Category: \");\n\t\tfor (i = 0; i < ARRAY_SIZE(snd_ca0106_con_category); i++) {\n\t\t\tif ((status[1] & IEC958_AES1_CON_CATEGORY) == snd_ca0106_con_category[i].val) {\n\t\t\t\tsnd_iprintf(buffer, \"%s\\n\", snd_ca0106_con_category[i].name);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (i >= ARRAY_SIZE(snd_ca0106_con_category)) {\n\t\t\tsnd_iprintf(buffer, \"unknown 0x%x\\n\", status[1] & IEC958_AES1_CON_CATEGORY);\n\t\t}\n\t\tsnd_iprintf(buffer, \"Original: \");\n\t\tif (status[1] & IEC958_AES1_CON_ORIGINAL) {\n\t\t\tsnd_iprintf(buffer, \"original\\n\");\n\t\t} else {\n\t\t\tsnd_iprintf(buffer, \"1st generation\\n\");\n\t\t}\n\t\tsnd_iprintf(buffer, \"Clock: \");\n\t\tswitch (status[3] & IEC958_AES3_CON_CLOCK) {\n\t\tcase IEC958_AES3_CON_CLOCK_1000PPM:\n\t\t\tsnd_iprintf(buffer, \"1000 ppm\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES3_CON_CLOCK_50PPM:\n\t\t\tsnd_iprintf(buffer, \"50 ppm\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES3_CON_CLOCK_VARIABLE:\n\t\t\tsnd_iprintf(buffer, \"variable pitch\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tsnd_iprintf(buffer, \"Mode: professional\\n\");\n\t\tsnd_iprintf(buffer, \"Data: \");\n\t\tif (!(status[0] & IEC958_AES0_NONAUDIO)) {\n\t\t\tsnd_iprintf(buffer, \"audio\\n\");\n\t\t} else {\n\t\t\tsnd_iprintf(buffer, \"non-audio\\n\");\n\t\t}\n\t\tsnd_iprintf(buffer, \"Rate: \");\n\t\tswitch (status[0] & IEC958_AES0_PRO_FS) {\n\t\tcase IEC958_AES0_PRO_FS_44100:\n\t\t\tsnd_iprintf(buffer, \"44100 Hz\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES0_PRO_FS_48000:\n\t\t\tsnd_iprintf(buffer, \"48000 Hz\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES0_PRO_FS_32000:\n\t\t\tsnd_iprintf(buffer, \"32000 Hz\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tsnd_iprintf(buffer, \"Rate Locked: \");\n\t\tif (status[0] & IEC958_AES0_PRO_FREQ_UNLOCKED)\n\t\t\tsnd_iprintf(buffer, \"no\\n\");\n\t\telse\n\t\t\tsnd_iprintf(buffer, \"yes\\n\");\n\t\tsnd_iprintf(buffer, \"Emphasis: \");\n\t\tswitch (status[0] & IEC958_AES0_PRO_EMPHASIS) {\n\t\tcase IEC958_AES0_PRO_EMPHASIS_CCITT:\n\t\t\tsnd_iprintf(buffer, \"CCITT J.17\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES0_PRO_EMPHASIS_NONE:\n\t\t\tsnd_iprintf(buffer, \"none\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES0_PRO_EMPHASIS_5015:\n\t\t\tsnd_iprintf(buffer, \"50/15us\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES0_PRO_EMPHASIS_NOTID:\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tsnd_iprintf(buffer, \"Stereophonic: \");\n\t\tif ((status[1] & IEC958_AES1_PRO_MODE) == IEC958_AES1_PRO_MODE_STEREOPHONIC) {\n\t\t\tsnd_iprintf(buffer, \"stereo\\n\");\n\t\t} else {\n\t\t\tsnd_iprintf(buffer, \"not indicated\\n\");\n\t\t}\n\t\tsnd_iprintf(buffer, \"Userbits: \");\n\t\tswitch (status[1] & IEC958_AES1_PRO_USERBITS) {\n\t\tcase IEC958_AES1_PRO_USERBITS_192:\n\t\t\tsnd_iprintf(buffer, \"192bit\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES1_PRO_USERBITS_UDEF:\n\t\t\tsnd_iprintf(buffer, \"user-defined\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tsnd_iprintf(buffer, \"Sample Bits: \");\n\t\tswitch (status[2] & IEC958_AES2_PRO_SBITS) {\n\t\tcase IEC958_AES2_PRO_SBITS_20:\n\t\t\tsnd_iprintf(buffer, \"20 bit\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES2_PRO_SBITS_24:\n\t\t\tsnd_iprintf(buffer, \"24 bit\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES2_PRO_SBITS_UDEF:\n\t\t\tsnd_iprintf(buffer, \"user defined\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tsnd_iprintf(buffer, \"Word Length: \");\n\t\tswitch (status[2] & IEC958_AES2_PRO_WORDLEN) {\n\t\tcase IEC958_AES2_PRO_WORDLEN_22_18:\n\t\t\tsnd_iprintf(buffer, \"22 bit or 18 bit\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES2_PRO_WORDLEN_23_19:\n\t\t\tsnd_iprintf(buffer, \"23 bit or 19 bit\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES2_PRO_WORDLEN_24_20:\n\t\t\tsnd_iprintf(buffer, \"24 bit or 20 bit\\n\");\n\t\t\tbreak;\n\t\tcase IEC958_AES2_PRO_WORDLEN_20_16:\n\t\t\tsnd_iprintf(buffer, \"20 bit or 16 bit\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsnd_iprintf(buffer, \"unknown\\n\");\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void snd_ca0106_proc_iec958(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n\tu32 value;\n\n        value = snd_ca0106_ptr_read(emu, SAMPLE_RATE_TRACKER_STATUS, 0);\n\tsnd_iprintf(buffer, \"Status: %s, %s, %s\\n\",\n\t\t  (value & 0x100000) ? \"Rate Locked\" : \"Not Rate Locked\",\n\t\t  (value & 0x200000) ? \"SPDIF Locked\" : \"No SPDIF Lock\",\n\t\t  (value & 0x400000) ? \"Audio Valid\" : \"No valid audio\" );\n\tsnd_iprintf(buffer, \"Estimated sample rate: %u\\n\", \n\t\t  ((value & 0xfffff) * 48000) / 0x8000 );\n\tif (value & 0x200000) {\n\t\tsnd_iprintf(buffer, \"IEC958/SPDIF input status:\\n\");\n        \tvalue = snd_ca0106_ptr_read(emu, SPDIF_INPUT_STATUS, 0);\n\t\tsnd_ca0106_proc_dump_iec958(buffer, value);\n\t}\n\n\tsnd_iprintf(buffer, \"\\n\");\n}\n\nstatic void snd_ca0106_proc_reg_write32(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n\tunsigned long flags;\n        char line[64];\n        u32 reg, val;\n        while (!snd_info_get_line(buffer, line, sizeof(line))) {\n                if (sscanf(line, \"%x %x\", &reg, &val) != 2)\n                        continue;\n\t\tif (reg < 0x40 && val <= 0xffffffff) {\n\t\t\tspin_lock_irqsave(&emu->emu_lock, flags);\n\t\t\toutl(val, emu->port + (reg & 0xfffffffc));\n\t\t\tspin_unlock_irqrestore(&emu->emu_lock, flags);\n\t\t}\n        }\n}\n\nstatic void snd_ca0106_proc_reg_read32(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n\tunsigned long value;\n\tunsigned long flags;\n\tint i;\n\tsnd_iprintf(buffer, \"Registers:\\n\\n\");\n\tfor(i = 0; i < 0x20; i+=4) {\n\t\tspin_lock_irqsave(&emu->emu_lock, flags);\n\t\tvalue = inl(emu->port + i);\n\t\tspin_unlock_irqrestore(&emu->emu_lock, flags);\n\t\tsnd_iprintf(buffer, \"Register %02X: %08lX\\n\", i, value);\n\t}\n}\n\nstatic void snd_ca0106_proc_reg_read16(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n        unsigned int value;\n\tunsigned long flags;\n\tint i;\n\tsnd_iprintf(buffer, \"Registers:\\n\\n\");\n\tfor(i = 0; i < 0x20; i+=2) {\n\t\tspin_lock_irqsave(&emu->emu_lock, flags);\n\t\tvalue = inw(emu->port + i);\n\t\tspin_unlock_irqrestore(&emu->emu_lock, flags);\n\t\tsnd_iprintf(buffer, \"Register %02X: %04X\\n\", i, value);\n\t}\n}\n\nstatic void snd_ca0106_proc_reg_read8(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n\tunsigned int value;\n\tunsigned long flags;\n\tint i;\n\tsnd_iprintf(buffer, \"Registers:\\n\\n\");\n\tfor(i = 0; i < 0x20; i+=1) {\n\t\tspin_lock_irqsave(&emu->emu_lock, flags);\n\t\tvalue = inb(emu->port + i);\n\t\tspin_unlock_irqrestore(&emu->emu_lock, flags);\n\t\tsnd_iprintf(buffer, \"Register %02X: %02X\\n\", i, value);\n\t}\n}\n\nstatic void snd_ca0106_proc_reg_read1(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n\tunsigned long value;\n\tint i,j;\n\n\tsnd_iprintf(buffer, \"Registers\\n\");\n\tfor(i = 0; i < 0x40; i++) {\n\t\tsnd_iprintf(buffer, \"%02X: \",i);\n\t\tfor (j = 0; j < 4; j++) {\n                  value = snd_ca0106_ptr_read(emu, i, j);\n\t\t  snd_iprintf(buffer, \"%08lX \", value);\n                }\n\t        snd_iprintf(buffer, \"\\n\");\n\t}\n}\n\nstatic void snd_ca0106_proc_reg_read2(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n\tunsigned long value;\n\tint i,j;\n\n\tsnd_iprintf(buffer, \"Registers\\n\");\n\tfor(i = 0x40; i < 0x80; i++) {\n\t\tsnd_iprintf(buffer, \"%02X: \",i);\n\t\tfor (j = 0; j < 4; j++) {\n                  value = snd_ca0106_ptr_read(emu, i, j);\n\t\t  snd_iprintf(buffer, \"%08lX \", value);\n                }\n\t        snd_iprintf(buffer, \"\\n\");\n\t}\n}\n\nstatic void snd_ca0106_proc_reg_write(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n        char line[64];\n        unsigned int reg, channel_id , val;\n        while (!snd_info_get_line(buffer, line, sizeof(line))) {\n                if (sscanf(line, \"%x %x %x\", &reg, &channel_id, &val) != 3)\n                        continue;\n\t\tif (reg < 0x80 && val <= 0xffffffff && channel_id <= 3)\n                        snd_ca0106_ptr_write(emu, reg, channel_id, val);\n        }\n}\n\nstatic void snd_ca0106_proc_i2c_write(struct snd_info_entry *entry, \n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tstruct snd_ca0106 *emu = entry->private_data;\n        char line[64];\n        unsigned int reg, val;\n        while (!snd_info_get_line(buffer, line, sizeof(line))) {\n                if (sscanf(line, \"%x %x\", &reg, &val) != 2)\n                        continue;\n                if ((reg <= 0x7f) || (val <= 0x1ff)) {\n                        snd_ca0106_i2c_write(emu, reg, val);\n\t\t}\n        }\n}\n\nint snd_ca0106_proc_init(struct snd_ca0106 *emu)\n{\n\tsnd_card_ro_proc_new(emu->card, \"iec958\", emu, snd_ca0106_proc_iec958);\n\tsnd_card_rw_proc_new(emu->card, \"ca0106_reg32\", emu,\n\t\t\t     snd_ca0106_proc_reg_read32,\n\t\t\t     snd_ca0106_proc_reg_write32);\n\tsnd_card_ro_proc_new(emu->card, \"ca0106_reg16\", emu,\n\t\t\t     snd_ca0106_proc_reg_read16);\n\tsnd_card_ro_proc_new(emu->card, \"ca0106_reg8\", emu,\n\t\t\t     snd_ca0106_proc_reg_read8);\n\tsnd_card_rw_proc_new(emu->card, \"ca0106_regs1\", emu,\n\t\t\t     snd_ca0106_proc_reg_read1,\n\t\t\t     snd_ca0106_proc_reg_write);\n\tsnd_card_rw_proc_new(emu->card, \"ca0106_i2c\", emu, NULL,\n\t\t\t     snd_ca0106_proc_i2c_write);\n\tsnd_card_ro_proc_new(emu->card, \"ca0106_regs2\", emu,\n\t\t\t     snd_ca0106_proc_reg_read2);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}