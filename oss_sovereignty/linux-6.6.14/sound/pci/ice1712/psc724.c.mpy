{
  "module_name": "psc724.c",
  "hash_id": "926a4b6cb297cae001f3c171024949af8b179b32c2227a7171d9ba3518db6388",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ice1712/psc724.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <sound/core.h>\n\n#include \"ice1712.h\"\n#include \"envy24ht.h\"\n#include \"psc724.h\"\n#include \"wm8766.h\"\n#include \"wm8776.h\"\n\nstruct psc724_spec {\n\tstruct snd_wm8766 wm8766;\n\tstruct snd_wm8776 wm8776;\n\tbool mute_all, jack_detect;\n\tstruct snd_ice1712 *ice;\n\tstruct delayed_work hp_work;\n\tbool hp_connected;\n};\n\n \n \n \n \n\n \n\n#define GPIO_HP_JACK\t(1 << 14)\n#define GPIO_MUTE_SUR\t(1 << 20)\n#define GPIO_MUTE_ALL\t(1 << 22)\n\n#define JACK_INTERVAL\t1000\n\n#define PSC724_SPI_DELAY 1\n\n#define PSC724_SPI_DATA\t(1 << 16)\n#define PSC724_SPI_CLK\t(1 << 17)\n#define PSC724_SPI_LOAD\t(1 << 18)\n#define PSC724_SPI_MASK\t(PSC724_SPI_DATA | PSC724_SPI_CLK | PSC724_SPI_LOAD)\n\nstatic void psc724_wm8766_write(struct snd_wm8766 *wm, u16 addr, u16 data)\n{\n\tstruct psc724_spec *spec = container_of(wm, struct psc724_spec, wm8766);\n\tstruct snd_ice1712 *ice = spec->ice;\n\tu32 st, bits;\n\tint i;\n\n\tsnd_ice1712_save_gpio_status(ice);\n\n\tst = ((addr & 0x7f) << 9) | (data & 0x1ff);\n\tsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction | PSC724_SPI_MASK);\n\tsnd_ice1712_gpio_set_mask(ice, ice->gpio.write_mask & ~PSC724_SPI_MASK);\n\tbits = snd_ice1712_gpio_read(ice) & ~PSC724_SPI_MASK;\n\tsnd_ice1712_gpio_write(ice, bits);\n\n\tfor (i = 0; i < 16; i++) {\n\t\tudelay(PSC724_SPI_DELAY);\n\t\tbits &= ~PSC724_SPI_CLK;\n\t\t \n\t\tst <<= 1;\n\t\tif (st & 0x10000)\n\t\t\tbits |= PSC724_SPI_DATA;\n\t\telse\n\t\t\tbits &= ~PSC724_SPI_DATA;\n\t\tsnd_ice1712_gpio_write(ice, bits);\n\t\t \n\t\tudelay(PSC724_SPI_DELAY);\n\t\tbits |= PSC724_SPI_CLK;\n\t\tsnd_ice1712_gpio_write(ice, bits);\n\t}\n\t \n\tudelay(PSC724_SPI_DELAY);\n\tbits |= PSC724_SPI_LOAD;\n\tsnd_ice1712_gpio_write(ice, bits);\n\t \n\tudelay(PSC724_SPI_DELAY);\n\tbits |= (PSC724_SPI_DATA | PSC724_SPI_CLK);\n\tsnd_ice1712_gpio_write(ice, bits);\n\n\tsnd_ice1712_restore_gpio_status(ice);\n}\n\nstatic void psc724_wm8776_write(struct snd_wm8776 *wm, u8 addr, u8 data)\n{\n\tstruct psc724_spec *spec = container_of(wm, struct psc724_spec, wm8776);\n\n\tsnd_vt1724_write_i2c(spec->ice, 0x34, addr, data);\n}\n\n \n\nstatic void psc724_set_master_switch(struct snd_ice1712 *ice, bool on)\n{\n\tunsigned int bits = snd_ice1712_gpio_read(ice);\n\tstruct psc724_spec *spec = ice->spec;\n\n\tspec->mute_all = !on;\n\tif (on)\n\t\tbits &= ~(GPIO_MUTE_ALL | GPIO_MUTE_SUR);\n\telse\n\t\tbits |= GPIO_MUTE_ALL | GPIO_MUTE_SUR;\n\tsnd_ice1712_gpio_write(ice, bits);\n}\n\nstatic bool psc724_get_master_switch(struct snd_ice1712 *ice)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\n\treturn !spec->mute_all;\n}\n\n \n\nstatic void psc724_set_jack_state(struct snd_ice1712 *ice, bool hp_connected)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\tstruct snd_kcontrol *kctl;\n\tu16 power = spec->wm8776.regs[WM8776_REG_PWRDOWN] & ~WM8776_PWR_HPPD;\n\n\tpsc724_set_master_switch(ice, !hp_connected);\n\tif (!hp_connected)\n\t\tpower |= WM8776_PWR_HPPD;\n\tsnd_wm8776_set_power(&spec->wm8776, power);\n\tspec->hp_connected = hp_connected;\n\t \n\tkctl = snd_ctl_find_id_mixer(ice->card,\n\t\t\t\t     \"Master Speakers Playback Switch\");\n\tif (kctl)\n\t\tsnd_ctl_notify(ice->card, SNDRV_CTL_EVENT_MASK_VALUE, &kctl->id);\n\t \n\tkctl = snd_ctl_find_id_mixer(ice->card,\n\t\t\t\t     spec->wm8776.ctl[WM8776_CTL_HP_SW].name);\n\tif (kctl)\n\t\tsnd_ctl_notify(ice->card, SNDRV_CTL_EVENT_MASK_VALUE, &kctl->id);\n}\n\nstatic void psc724_update_hp_jack_state(struct work_struct *work)\n{\n\tstruct psc724_spec *spec = container_of(work, struct psc724_spec,\n\t\t\t\t\t\thp_work.work);\n\tstruct snd_ice1712 *ice = spec->ice;\n\tbool hp_connected = snd_ice1712_gpio_read(ice) & GPIO_HP_JACK;\n\n\tschedule_delayed_work(&spec->hp_work, msecs_to_jiffies(JACK_INTERVAL));\n\tif (hp_connected == spec->hp_connected)\n\t\treturn;\n\tpsc724_set_jack_state(ice, hp_connected);\n}\n\nstatic void psc724_set_jack_detection(struct snd_ice1712 *ice, bool on)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\n\tif (spec->jack_detect == on)\n\t\treturn;\n\n\tspec->jack_detect = on;\n\tif (on) {\n\t\tbool hp_connected = snd_ice1712_gpio_read(ice) & GPIO_HP_JACK;\n\t\tpsc724_set_jack_state(ice, hp_connected);\n\t\tschedule_delayed_work(&spec->hp_work,\n\t\t\t\t\tmsecs_to_jiffies(JACK_INTERVAL));\n\t} else\n\t\tcancel_delayed_work_sync(&spec->hp_work);\n}\n\nstatic bool psc724_get_jack_detection(struct snd_ice1712 *ice)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\n\treturn spec->jack_detect;\n}\n\n \n\nstruct psc724_control {\n\tconst char *name;\n\tvoid (*set)(struct snd_ice1712 *ice, bool on);\n\tbool (*get)(struct snd_ice1712 *ice);\n};\n\nstatic const struct psc724_control psc724_cont[] = {\n\t{\n\t\t.name = \"Master Speakers Playback Switch\",\n\t\t.set = psc724_set_master_switch,\n\t\t.get = psc724_get_master_switch,\n\t},\n\t{\n\t\t.name = \"Headphone Jack Detection Playback Switch\",\n\t\t.set = psc724_set_jack_detection,\n\t\t.get = psc724_get_jack_detection,\n\t},\n};\n\nstatic int psc724_ctl_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\n\tint n = kcontrol->private_value;\n\n\tucontrol->value.integer.value[0] = psc724_cont[n].get(ice);\n\n\treturn 0;\n}\n\nstatic int psc724_ctl_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\n\tint n = kcontrol->private_value;\n\n\tpsc724_cont[n].set(ice, ucontrol->value.integer.value[0]);\n\n\treturn 0;\n}\n\nstatic const char *front_volume\t= \"Front Playback Volume\";\nstatic const char *front_switch\t= \"Front Playback Switch\";\nstatic const char *front_zc\t= \"Front Zero Cross Detect Playback Switch\";\nstatic const char *front_izd\t= \"Front Infinite Zero Detect Playback Switch\";\nstatic const char *front_phase\t= \"Front Phase Invert Playback Switch\";\nstatic const char *front_deemph\t= \"Front Deemphasis Playback Switch\";\nstatic const char *ain1_switch\t= \"Line Capture Switch\";\nstatic const char *ain2_switch\t= \"CD Capture Switch\";\nstatic const char *ain3_switch\t= \"AUX Capture Switch\";\nstatic const char *ain4_switch\t= \"Front Mic Capture Switch\";\nstatic const char *ain5_switch\t= \"Rear Mic Capture Switch\";\nstatic const char *rear_volume\t= \"Surround Playback Volume\";\nstatic const char *clfe_volume\t= \"CLFE Playback Volume\";\nstatic const char *rear_switch\t= \"Surround Playback Switch\";\nstatic const char *clfe_switch\t= \"CLFE Playback Switch\";\nstatic const char *rear_phase\t= \"Surround Phase Invert Playback Switch\";\nstatic const char *clfe_phase\t= \"CLFE Phase Invert Playback Switch\";\nstatic const char *rear_deemph\t= \"Surround Deemphasis Playback Switch\";\nstatic const char *clfe_deemph\t= \"CLFE Deemphasis Playback Switch\";\nstatic const char *rear_clfe_izd = \"Rear Infinite Zero Detect Playback Switch\";\nstatic const char *rear_clfe_zc\t= \"Rear Zero Cross Detect Playback Switch\";\n\nstatic int psc724_add_controls(struct snd_ice1712 *ice)\n{\n\tstruct snd_kcontrol_new cont;\n\tstruct snd_kcontrol *ctl;\n\tint err, i;\n\tstruct psc724_spec *spec = ice->spec;\n\n\tspec->wm8776.ctl[WM8776_CTL_DAC_VOL].name = front_volume;\n\tspec->wm8776.ctl[WM8776_CTL_DAC_SW].name = front_switch;\n\tspec->wm8776.ctl[WM8776_CTL_DAC_ZC_SW].name = front_zc;\n\tspec->wm8776.ctl[WM8776_CTL_AUX_SW].name = NULL;\n\tspec->wm8776.ctl[WM8776_CTL_DAC_IZD_SW].name = front_izd;\n\tspec->wm8776.ctl[WM8776_CTL_PHASE_SW].name = front_phase;\n\tspec->wm8776.ctl[WM8776_CTL_DEEMPH_SW].name = front_deemph;\n\tspec->wm8776.ctl[WM8776_CTL_INPUT1_SW].name = ain1_switch;\n\tspec->wm8776.ctl[WM8776_CTL_INPUT2_SW].name = ain2_switch;\n\tspec->wm8776.ctl[WM8776_CTL_INPUT3_SW].name = ain3_switch;\n\tspec->wm8776.ctl[WM8776_CTL_INPUT4_SW].name = ain4_switch;\n\tspec->wm8776.ctl[WM8776_CTL_INPUT5_SW].name = ain5_switch;\n\tsnd_wm8776_build_controls(&spec->wm8776);\n\tspec->wm8766.ctl[WM8766_CTL_CH1_VOL].name = rear_volume;\n\tspec->wm8766.ctl[WM8766_CTL_CH2_VOL].name = clfe_volume;\n\tspec->wm8766.ctl[WM8766_CTL_CH3_VOL].name = NULL;\n\tspec->wm8766.ctl[WM8766_CTL_CH1_SW].name = rear_switch;\n\tspec->wm8766.ctl[WM8766_CTL_CH2_SW].name = clfe_switch;\n\tspec->wm8766.ctl[WM8766_CTL_CH3_SW].name = NULL;\n\tspec->wm8766.ctl[WM8766_CTL_PHASE1_SW].name = rear_phase;\n\tspec->wm8766.ctl[WM8766_CTL_PHASE2_SW].name = clfe_phase;\n\tspec->wm8766.ctl[WM8766_CTL_PHASE3_SW].name = NULL;\n\tspec->wm8766.ctl[WM8766_CTL_DEEMPH1_SW].name = rear_deemph;\n\tspec->wm8766.ctl[WM8766_CTL_DEEMPH2_SW].name = clfe_deemph;\n\tspec->wm8766.ctl[WM8766_CTL_DEEMPH3_SW].name = NULL;\n\tspec->wm8766.ctl[WM8766_CTL_IZD_SW].name = rear_clfe_izd;\n\tspec->wm8766.ctl[WM8766_CTL_ZC_SW].name = rear_clfe_zc;\n\tsnd_wm8766_build_controls(&spec->wm8766);\n\n\tmemset(&cont, 0, sizeof(cont));\n\tcont.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\n\tfor (i = 0; i < ARRAY_SIZE(psc724_cont); i++) {\n\t\tcont.private_value = i;\n\t\tcont.name = psc724_cont[i].name;\n\t\tcont.access = SNDRV_CTL_ELEM_ACCESS_READWRITE;\n\t\tcont.info = snd_ctl_boolean_mono_info;\n\t\tcont.get = psc724_ctl_get;\n\t\tcont.put = psc724_ctl_put;\n\t\tctl = snd_ctl_new1(&cont, ice);\n\t\tif (!ctl)\n\t\t\treturn -ENOMEM;\n\t\terr = snd_ctl_add(ice->card, ctl);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic void psc724_set_pro_rate(struct snd_ice1712 *ice, unsigned int rate)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\t \n\tsnd_wm8776_volume_restore(&spec->wm8776);\n\tsnd_wm8766_volume_restore(&spec->wm8766);\n}\n\n \n\n#ifdef CONFIG_PM_SLEEP\nstatic int psc724_resume(struct snd_ice1712 *ice)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\n\tsnd_wm8776_resume(&spec->wm8776);\n\tsnd_wm8766_resume(&spec->wm8766);\n\n\treturn 0;\n}\n#endif\n\n \n\nstatic int psc724_init(struct snd_ice1712 *ice)\n{\n\tstruct psc724_spec *spec;\n\n\tspec = kzalloc(sizeof(*spec), GFP_KERNEL);\n\tif (!spec)\n\t\treturn -ENOMEM;\n\tice->spec = spec;\n\tspec->ice = ice;\n\n\tice->num_total_dacs = 6;\n\tice->num_total_adcs = 2;\n\tspec->wm8776.ops.write = psc724_wm8776_write;\n\tspec->wm8776.card = ice->card;\n\tsnd_wm8776_init(&spec->wm8776);\n\tspec->wm8766.ops.write = psc724_wm8766_write;\n\tspec->wm8766.card = ice->card;\n#ifdef CONFIG_PM_SLEEP\n\tice->pm_resume = psc724_resume;\n\tice->pm_suspend_enabled = 1;\n#endif\n\tsnd_wm8766_init(&spec->wm8766);\n\tsnd_wm8766_set_if(&spec->wm8766,\n\t\t\tWM8766_IF_FMT_I2S | WM8766_IF_IWL_24BIT);\n\tice->gpio.set_pro_rate = psc724_set_pro_rate;\n\tINIT_DELAYED_WORK(&spec->hp_work, psc724_update_hp_jack_state);\n\tpsc724_set_jack_detection(ice, true);\n\treturn 0;\n}\n\nstatic void psc724_exit(struct snd_ice1712 *ice)\n{\n\tstruct psc724_spec *spec = ice->spec;\n\n\tcancel_delayed_work_sync(&spec->hp_work);\n}\n\n \nstatic const unsigned char psc724_eeprom[] = {\n\t[ICE_EEP2_SYSCONF]\t= 0x42,\t \n\t[ICE_EEP2_ACLINK]\t= 0x80,\t \n\t[ICE_EEP2_I2S]\t\t= 0xf0,\t \n\t[ICE_EEP2_SPDIF]\t= 0xc1,\t \n\t \n\t[ICE_EEP2_GPIO_DIR2]\t= 0x5f,  \n\t \n\t[ICE_EEP2_GPIO_MASK]\t= 0xff,  \n\t[ICE_EEP2_GPIO_MASK1]\t= 0xff,  \n\t[ICE_EEP2_GPIO_MASK2]\t= 0xa0,  \n\t \n\t[ICE_EEP2_GPIO_STATE2]\t= 0x20,\t \n};\n\nstruct snd_ice1712_card_info snd_vt1724_psc724_cards[] = {\n\t{\n\t\t.subvendor = VT1724_SUBDEVICE_PSC724,\n\t\t.name = \"Philips PSC724 Ultimate Edge\",\n\t\t.model = \"psc724\",\n\t\t.chip_init = psc724_init,\n\t\t.chip_exit = psc724_exit,\n\t\t.build_controls = psc724_add_controls,\n\t\t.eeprom_size = sizeof(psc724_eeprom),\n\t\t.eeprom_data = psc724_eeprom,\n\t},\n\t{}  \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}