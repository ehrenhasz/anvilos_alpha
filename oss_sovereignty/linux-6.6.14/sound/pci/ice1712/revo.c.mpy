{
  "module_name": "revo.c",
  "hash_id": "b40acb87358525f56137dba1a2a82b73e6ee1a1b83625645a51e2a9f82077f3b",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ice1712/revo.c",
  "human_readable_source": "\n       \n\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <sound/core.h>\n\n#include \"ice1712.h\"\n#include \"envy24ht.h\"\n#include \"revo.h\"\n\n \nstruct revo51_spec {\n\tstruct snd_i2c_device *dev;\n\tstruct snd_pt2258 *pt2258;\n\tstruct ak4114 *ak4114;\n};\n\nstatic void revo_i2s_mclk_changed(struct snd_ice1712 *ice)\n{\n\t \n\toutb(inb(ICEMT1724(ice, AC97_CMD)) | 0x80, ICEMT1724(ice, AC97_CMD));\n\tmdelay(5);\n\t \n\toutb(inb(ICEMT1724(ice, AC97_CMD)) & ~0x80, ICEMT1724(ice, AC97_CMD));\n}\n\n \nstatic void revo_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\n{\n\tunsigned char old, tmp, dfs;\n\tint reg, shift;\n\n\tif (rate == 0)\t \n\t\treturn;\n\n\t \n\tif (rate > 96000)\n\t\tdfs = 2;\n\telse if (rate > 48000)\n\t\tdfs = 1;\n\telse\n\t\tdfs = 0;\n\n\tif (ak->type == SND_AK4355 || ak->type == SND_AK4358) {\n\t\treg = 2;\n\t\tshift = 4;\n\t} else {\n\t\treg = 1;\n\t\tshift = 3;\n\t}\n\ttmp = snd_akm4xxx_get(ak, 0, reg);\n\told = (tmp >> shift) & 0x03;\n\tif (old == dfs)\n\t\treturn;\n\n\t \n\tsnd_akm4xxx_reset(ak, 1);\n\ttmp = snd_akm4xxx_get(ak, 0, reg);\n\ttmp &= ~(0x03 << shift);\n\ttmp |= dfs << shift;\n\t \n\tsnd_akm4xxx_set(ak, 0, reg, tmp);  \n\tsnd_akm4xxx_reset(ak, 0);\n}\n\n \n\nstatic void revo_i2c_start(struct snd_i2c_bus *bus)\n{\n\tstruct snd_ice1712 *ice = bus->private_data;\n\tsnd_ice1712_save_gpio_status(ice);\n}\n\nstatic void revo_i2c_stop(struct snd_i2c_bus *bus)\n{\n\tstruct snd_ice1712 *ice = bus->private_data;\n\tsnd_ice1712_restore_gpio_status(ice);\n}\n\nstatic void revo_i2c_direction(struct snd_i2c_bus *bus, int clock, int data)\n{\n\tstruct snd_ice1712 *ice = bus->private_data;\n\tunsigned int mask, val;\n\n\tval = 0;\n\tif (clock)\n\t\tval |= VT1724_REVO_I2C_CLOCK;\t \n\tif (data)\n\t\tval |= VT1724_REVO_I2C_DATA;\t \n\tmask = VT1724_REVO_I2C_CLOCK | VT1724_REVO_I2C_DATA;\n\tice->gpio.direction &= ~mask;\n\tice->gpio.direction |= val;\n\tsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction);\n\tsnd_ice1712_gpio_set_mask(ice, ~mask);\n}\n\nstatic void revo_i2c_setlines(struct snd_i2c_bus *bus, int clk, int data)\n{\n\tstruct snd_ice1712 *ice = bus->private_data;\n\tunsigned int val = 0;\n\n\tif (clk)\n\t\tval |= VT1724_REVO_I2C_CLOCK;\n\tif (data)\n\t\tval |= VT1724_REVO_I2C_DATA;\n\tsnd_ice1712_gpio_write_bits(ice,\n\t\t\t\t    VT1724_REVO_I2C_DATA |\n\t\t\t\t    VT1724_REVO_I2C_CLOCK, val);\n\tudelay(5);\n}\n\nstatic int revo_i2c_getdata(struct snd_i2c_bus *bus, int ack)\n{\n\tstruct snd_ice1712 *ice = bus->private_data;\n\tint bit;\n\n\tif (ack)\n\t\tudelay(5);\n\tbit = snd_ice1712_gpio_read_bits(ice, VT1724_REVO_I2C_DATA) ? 1 : 0;\n\treturn bit;\n}\n\nstatic struct snd_i2c_bit_ops revo51_bit_ops = {\n\t.start = revo_i2c_start,\n\t.stop = revo_i2c_stop,\n\t.direction = revo_i2c_direction,\n\t.setlines = revo_i2c_setlines,\n\t.getdata = revo_i2c_getdata,\n};\n\nstatic int revo51_i2c_init(struct snd_ice1712 *ice,\n\t\t\t   struct snd_pt2258 *pt)\n{\n\tstruct revo51_spec *spec;\n\tint err;\n\n\tspec = kzalloc(sizeof(*spec), GFP_KERNEL);\n\tif (!spec)\n\t\treturn -ENOMEM;\n\tice->spec = spec;\n\n\t \n\terr = snd_i2c_bus_create(ice->card, \"ICE1724 GPIO6\", NULL, &ice->i2c);\n\tif (err < 0)\n\t\treturn err;\n\n\tice->i2c->private_data = ice;\n\tice->i2c->hw_ops.bit = &revo51_bit_ops;\n\n\t \n\terr = snd_i2c_device_create(ice->i2c, \"PT2258\", 0x40, &spec->dev);\n\tif (err < 0)\n\t\treturn err;\n\n\tpt->card = ice->card;\n\tpt->i2c_bus = ice->i2c;\n\tpt->i2c_dev = spec->dev;\n\tspec->pt2258 = pt;\n\n\tsnd_pt2258_reset(pt);\n\n\treturn 0;\n}\n\n \n\n#define AK_DAC(xname,xch) { .name = xname, .num_channels = xch }\n\nstatic const struct snd_akm4xxx_dac_channel revo71_front[] = {\n\t{\n\t\t.name = \"PCM Playback Volume\",\n\t\t.num_channels = 2,\n\t\t \n\t\t.switch_name = \"PCM Playback Switch\",\n\t},\n};\n\nstatic const struct snd_akm4xxx_dac_channel revo71_surround[] = {\n\tAK_DAC(\"PCM Center Playback Volume\", 1),\n\tAK_DAC(\"PCM LFE Playback Volume\", 1),\n\tAK_DAC(\"PCM Side Playback Volume\", 2),\n\tAK_DAC(\"PCM Rear Playback Volume\", 2),\n};\n\nstatic const struct snd_akm4xxx_dac_channel revo51_dac[] = {\n\tAK_DAC(\"PCM Playback Volume\", 2),\n\tAK_DAC(\"PCM Center Playback Volume\", 1),\n\tAK_DAC(\"PCM LFE Playback Volume\", 1),\n\tAK_DAC(\"PCM Rear Playback Volume\", 2),\n\tAK_DAC(\"PCM Headphone Volume\", 2),\n};\n\nstatic const char *revo51_adc_input_names[] = {\n\t\"Mic\",\n\t\"Line\",\n\t\"CD\",\n\tNULL\n};\n\nstatic const struct snd_akm4xxx_adc_channel revo51_adc[] = {\n\t{\n\t\t.name = \"PCM Capture Volume\",\n\t\t.switch_name = \"PCM Capture Switch\",\n\t\t.num_channels = 2,\n\t\t.input_names = revo51_adc_input_names\n\t},\n};\n\nstatic const struct snd_akm4xxx akm_revo_front = {\n\t.type = SND_AK4381,\n\t.num_dacs = 2,\n\t.ops = {\n\t\t.set_rate_val = revo_set_rate_val\n\t},\n\t.dac_info = revo71_front,\n};\n\nstatic const struct snd_ak4xxx_private akm_revo_front_priv = {\n\t.caddr = 1,\n\t.cif = 0,\n\t.data_mask = VT1724_REVO_CDOUT,\n\t.clk_mask = VT1724_REVO_CCLK,\n\t.cs_mask = VT1724_REVO_CS0 | VT1724_REVO_CS1 | VT1724_REVO_CS2,\n\t.cs_addr = VT1724_REVO_CS0 | VT1724_REVO_CS2,\n\t.cs_none = VT1724_REVO_CS0 | VT1724_REVO_CS1 | VT1724_REVO_CS2,\n\t.add_flags = VT1724_REVO_CCLK,  \n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_revo_surround = {\n\t.type = SND_AK4355,\n\t.idx_offset = 1,\n\t.num_dacs = 6,\n\t.ops = {\n\t\t.set_rate_val = revo_set_rate_val\n\t},\n\t.dac_info = revo71_surround,\n};\n\nstatic const struct snd_ak4xxx_private akm_revo_surround_priv = {\n\t.caddr = 3,\n\t.cif = 0,\n\t.data_mask = VT1724_REVO_CDOUT,\n\t.clk_mask = VT1724_REVO_CCLK,\n\t.cs_mask = VT1724_REVO_CS0 | VT1724_REVO_CS1 | VT1724_REVO_CS2,\n\t.cs_addr = VT1724_REVO_CS0 | VT1724_REVO_CS1,\n\t.cs_none = VT1724_REVO_CS0 | VT1724_REVO_CS1 | VT1724_REVO_CS2,\n\t.add_flags = VT1724_REVO_CCLK,  \n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_revo51 = {\n\t.type = SND_AK4358,\n\t.num_dacs = 8,\n\t.ops = {\n\t\t.set_rate_val = revo_set_rate_val\n\t},\n\t.dac_info = revo51_dac,\n};\n\nstatic const struct snd_ak4xxx_private akm_revo51_priv = {\n\t.caddr = 2,\n\t.cif = 0,\n\t.data_mask = VT1724_REVO_CDOUT,\n\t.clk_mask = VT1724_REVO_CCLK,\n\t.cs_mask = VT1724_REVO_CS0 | VT1724_REVO_CS1,\n\t.cs_addr = VT1724_REVO_CS1,\n\t.cs_none = VT1724_REVO_CS0 | VT1724_REVO_CS1,\n\t.add_flags = VT1724_REVO_CCLK,  \n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_revo51_adc = {\n\t.type = SND_AK5365,\n\t.num_adcs = 2,\n\t.adc_info = revo51_adc,\n};\n\nstatic const struct snd_ak4xxx_private akm_revo51_adc_priv = {\n\t.caddr = 2,\n\t.cif = 0,\n\t.data_mask = VT1724_REVO_CDOUT,\n\t.clk_mask = VT1724_REVO_CCLK,\n\t.cs_mask = VT1724_REVO_CS0 | VT1724_REVO_CS1,\n\t.cs_addr = VT1724_REVO_CS0,\n\t.cs_none = VT1724_REVO_CS0 | VT1724_REVO_CS1,\n\t.add_flags = VT1724_REVO_CCLK,  \n\t.mask_flags = 0,\n};\n\nstatic struct snd_pt2258 ptc_revo51_volume;\n\n \nstatic void ap192_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\n{\n\tstruct snd_ice1712 *ice = ak->private_data[0];\n\tint dfs;\n\n\trevo_set_rate_val(ak, rate);\n\n\t \n\tsnd_ice1712_gpio_write_bits(ice, 1 << 8, rate > 96000 ? 1 << 8 : 0);\n\t \n\tif (rate > 96000)\n\t\tdfs = 2;\n\telse if (rate > 48000)\n\t\tdfs = 1;\n\telse\n\t\tdfs = 0;\n\tsnd_ice1712_gpio_write_bits(ice, 3 << 9, dfs << 9);\n\t \n\tsnd_ice1712_gpio_write_bits(ice, 1 << 11, 0);\n\tsnd_ice1712_gpio_write_bits(ice, 1 << 11, 1 << 11);\n}\n\nstatic const struct snd_akm4xxx_dac_channel ap192_dac[] = {\n\tAK_DAC(\"PCM Playback Volume\", 2)\n};\n\nstatic const struct snd_akm4xxx akm_ap192 = {\n\t.type = SND_AK4358,\n\t.num_dacs = 2,\n\t.ops = {\n\t\t.set_rate_val = ap192_set_rate_val\n\t},\n\t.dac_info = ap192_dac,\n};\n\nstatic const struct snd_ak4xxx_private akm_ap192_priv = {\n\t.caddr = 2,\n\t.cif = 0,\n\t.data_mask = VT1724_REVO_CDOUT,\n\t.clk_mask = VT1724_REVO_CCLK,\n\t.cs_mask = VT1724_REVO_CS0 | VT1724_REVO_CS3,\n\t.cs_addr = VT1724_REVO_CS3,\n\t.cs_none = VT1724_REVO_CS0 | VT1724_REVO_CS3,\n\t.add_flags = VT1724_REVO_CCLK,  \n\t.mask_flags = 0,\n};\n\n \n \n#define AK4114_ADDR\t0x00\n\nstatic void write_data(struct snd_ice1712 *ice, unsigned int gpio,\n\t\t       unsigned int data, int idx)\n{\n\tfor (; idx >= 0; idx--) {\n\t\t \n\t\tgpio &= ~VT1724_REVO_CCLK;\n\t\tsnd_ice1712_gpio_write(ice, gpio);\n\t\tudelay(1);\n\t\t \n\t\tif (data & (1 << idx))\n\t\t\tgpio |= VT1724_REVO_CDOUT;\n\t\telse\n\t\t\tgpio &= ~VT1724_REVO_CDOUT;\n\t\tsnd_ice1712_gpio_write(ice, gpio);\n\t\tudelay(1);\n\t\t \n\t\tgpio |= VT1724_REVO_CCLK;\n\t\tsnd_ice1712_gpio_write(ice, gpio);\n\t\tudelay(1);\n\t}\n}\n\nstatic unsigned char read_data(struct snd_ice1712 *ice, unsigned int gpio,\n\t\t\t       int idx)\n{\n\tunsigned char data = 0;\n\n\tfor (; idx >= 0; idx--) {\n\t\t \n\t\tgpio &= ~VT1724_REVO_CCLK;\n\t\tsnd_ice1712_gpio_write(ice, gpio);\n\t\tudelay(1);\n\t\t \n\t\tif (snd_ice1712_gpio_read(ice) & VT1724_REVO_CDIN)\n\t\t\tdata |= (1 << idx);\n\t\tudelay(1);\n\t\t \n\t\tgpio |= VT1724_REVO_CCLK;\n\t\tsnd_ice1712_gpio_write(ice, gpio);\n\t\tudelay(1);\n\t}\n\treturn data;\n}\n\nstatic unsigned int ap192_4wire_start(struct snd_ice1712 *ice)\n{\n\tunsigned int tmp;\n\n\tsnd_ice1712_save_gpio_status(ice);\n\ttmp = snd_ice1712_gpio_read(ice);\n\ttmp |= VT1724_REVO_CCLK;  \n\ttmp |= VT1724_REVO_CS0;\n\ttmp &= ~VT1724_REVO_CS3;\n\tsnd_ice1712_gpio_write(ice, tmp);\n\tudelay(1);\n\treturn tmp;\n}\n\nstatic void ap192_4wire_finish(struct snd_ice1712 *ice, unsigned int tmp)\n{\n\ttmp |= VT1724_REVO_CS3;\n\ttmp |= VT1724_REVO_CS0;\n\tsnd_ice1712_gpio_write(ice, tmp);\n\tudelay(1);\n\tsnd_ice1712_restore_gpio_status(ice);\n}\n\nstatic void ap192_ak4114_write(void *private_data, unsigned char addr,\n\t\t\t       unsigned char data)\n{\n\tstruct snd_ice1712 *ice = private_data;\n\tunsigned int tmp, addrdata;\n\n\ttmp = ap192_4wire_start(ice);\n\taddrdata = (AK4114_ADDR << 6) | 0x20 | (addr & 0x1f);\n\taddrdata = (addrdata << 8) | data;\n\twrite_data(ice, tmp, addrdata, 15);\n\tap192_4wire_finish(ice, tmp);\n}\n\nstatic unsigned char ap192_ak4114_read(void *private_data, unsigned char addr)\n{\n\tstruct snd_ice1712 *ice = private_data;\n\tunsigned int tmp;\n\tunsigned char data;\n\n\ttmp = ap192_4wire_start(ice);\n\twrite_data(ice, tmp, (AK4114_ADDR << 6) | (addr & 0x1f), 7);\n\tdata = read_data(ice, tmp, 7);\n\tap192_4wire_finish(ice, tmp);\n\treturn data;\n}\n\nstatic int ap192_ak4114_init(struct snd_ice1712 *ice)\n{\n\tstatic const unsigned char ak4114_init_vals[] = {\n\t\tAK4114_RST | AK4114_PWN | AK4114_OCKS0,\n\t\tAK4114_DIF_I24I2S,\n\t\tAK4114_TX1E,\n\t\tAK4114_EFH_1024 | AK4114_DIT | AK4114_IPS(0),\n\t\t0,\n\t\t0\n\t};\n\tstatic const unsigned char ak4114_init_txcsb[] = {\n\t\t0x41, 0x02, 0x2c, 0x00, 0x00\n\t};\n\tint err;\n\n\tstruct revo51_spec *spec;\n\tspec = kzalloc(sizeof(*spec), GFP_KERNEL);\n\tif (!spec)\n\t\treturn -ENOMEM;\n\tice->spec = spec;\n\n\terr = snd_ak4114_create(ice->card,\n\t\t\t\t ap192_ak4114_read,\n\t\t\t\t ap192_ak4114_write,\n\t\t\t\t ak4114_init_vals, ak4114_init_txcsb,\n\t\t\t\t ice, &spec->ak4114);\n\tif (err < 0)\n\t\treturn err;\n\t \n\tspec->ak4114->check_flags = AK4114_CHECK_NO_RATE;\n\n\treturn 0;\n}\n\nstatic int revo_init(struct snd_ice1712 *ice)\n{\n\tstruct snd_akm4xxx *ak;\n\tint err;\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase VT1724_SUBDEVICE_REVOLUTION71:\n\t\tice->num_total_dacs = 8;\n\t\tice->num_total_adcs = 2;\n\t\tice->gpio.i2s_mclk_changed = revo_i2s_mclk_changed;\n\t\tbreak;\n\tcase VT1724_SUBDEVICE_REVOLUTION51:\n\t\tice->num_total_dacs = 8;\n\t\tice->num_total_adcs = 2;\n\t\tbreak;\n\tcase VT1724_SUBDEVICE_AUDIOPHILE192:\n\t\tice->num_total_dacs = 2;\n\t\tice->num_total_adcs = 2;\n\t\tbreak;\n\tdefault:\n\t\tsnd_BUG();\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tak = ice->akm = kcalloc(2, sizeof(struct snd_akm4xxx), GFP_KERNEL);\n\tif (! ak)\n\t\treturn -ENOMEM;\n\tswitch (ice->eeprom.subvendor) {\n\tcase VT1724_SUBDEVICE_REVOLUTION71:\n\t\tice->akm_codecs = 2;\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_revo_front,\n\t\t\t\t\t\t&akm_revo_front_priv, ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = snd_ice1712_akm4xxx_init(ak+1, &akm_revo_surround,\n\t\t\t\t\t\t&akm_revo_surround_priv, ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\t \n\t\tsnd_ice1712_gpio_write_bits(ice, VT1724_REVO_MUTE,\n\t\t\t\t\t\tVT1724_REVO_MUTE);\n\t\tbreak;\n\tcase VT1724_SUBDEVICE_REVOLUTION51:\n\t\tice->akm_codecs = 2;\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_revo51,\n\t\t\t\t\t       &akm_revo51_priv, ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = snd_ice1712_akm4xxx_init(ak+1, &akm_revo51_adc,\n\t\t\t\t\t       &akm_revo51_adc_priv, ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = revo51_i2c_init(ice, &ptc_revo51_volume);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\t \n\t\tsnd_ice1712_gpio_write_bits(ice, VT1724_REVO_MUTE,\n\t\t\t\t\t    VT1724_REVO_MUTE);\n\t\tbreak;\n\tcase VT1724_SUBDEVICE_AUDIOPHILE192:\n\t\tice->akm_codecs = 1;\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_ap192, &akm_ap192_priv,\n\t\t\t\t\t       ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = ap192_ak4114_init(ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\t\n\t\t \n\t\tsnd_ice1712_gpio_write_bits(ice, VT1724_REVO_MUTE,\n\t\t\t\t\t    VT1724_REVO_MUTE);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n\nstatic int revo_add_controls(struct snd_ice1712 *ice)\n{\n\tstruct revo51_spec *spec = ice->spec;\n\tint err;\n\n\tswitch (ice->eeprom.subvendor) {\n\tcase VT1724_SUBDEVICE_REVOLUTION71:\n\t\terr = snd_ice1712_akm4xxx_build_controls(ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tcase VT1724_SUBDEVICE_REVOLUTION51:\n\t\terr = snd_ice1712_akm4xxx_build_controls(ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tspec = ice->spec;\n\t\terr = snd_pt2258_build_controls(spec->pt2258);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tcase VT1724_SUBDEVICE_AUDIOPHILE192:\n\t\terr = snd_ice1712_akm4xxx_build_controls(ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\t \n\t\terr = snd_ak4114_build(spec->ak4114, NULL,\n\t\t   ice->pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\n \nstruct snd_ice1712_card_info snd_vt1724_revo_cards[] = {\n\t{\n\t\t.subvendor = VT1724_SUBDEVICE_REVOLUTION71,\n\t\t.name = \"M Audio Revolution-7.1\",\n\t\t.model = \"revo71\",\n\t\t.chip_init = revo_init,\n\t\t.build_controls = revo_add_controls,\n\t},\n\t{\n\t\t.subvendor = VT1724_SUBDEVICE_REVOLUTION51,\n\t\t.name = \"M Audio Revolution-5.1\",\n\t\t.model = \"revo51\",\n\t\t.chip_init = revo_init,\n\t\t.build_controls = revo_add_controls,\n\t},\n\t{\n\t\t.subvendor = VT1724_SUBDEVICE_AUDIOPHILE192,\n\t\t.name = \"M Audio Audiophile192\",\n\t\t.model = \"ap192\",\n\t\t.chip_init = revo_init,\n\t\t.build_controls = revo_add_controls,\n\t},\n\t{ }  \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}