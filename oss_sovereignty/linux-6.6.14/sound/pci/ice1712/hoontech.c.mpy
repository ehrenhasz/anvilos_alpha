{
  "module_name": "hoontech.c",
  "hash_id": "9e72c0b8f5dcb27ee5ee964637b93081b76048d4d1d48c11b2990ea2077ff0a5",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ice1712/hoontech.c",
  "human_readable_source": "\n       \n\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/mutex.h>\n\n#include <sound/core.h>\n\n#include \"ice1712.h\"\n#include \"hoontech.h\"\n\n \nstruct hoontech_spec {\n\tunsigned char boxbits[4];\n\tunsigned int config;\n\tunsigned short boxconfig[4];\n};\n\nstatic void snd_ice1712_stdsp24_gpio_write(struct snd_ice1712 *ice, unsigned char byte)\n{\n\tbyte |= ICE1712_STDSP24_CLOCK_BIT;\n\tudelay(100);\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, byte);\n\tbyte &= ~ICE1712_STDSP24_CLOCK_BIT;\n\tudelay(100);\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, byte);\n\tbyte |= ICE1712_STDSP24_CLOCK_BIT;\n\tudelay(100);\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, byte);\n}\n\nstatic void snd_ice1712_stdsp24_darear(struct snd_ice1712 *ice, int activate)\n{\n\tstruct hoontech_spec *spec = ice->spec;\n\tmutex_lock(&ice->gpio_mutex);\n\tICE1712_STDSP24_0_DAREAR(spec->boxbits, activate);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[0]);\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\nstatic void snd_ice1712_stdsp24_mute(struct snd_ice1712 *ice, int activate)\n{\n\tstruct hoontech_spec *spec = ice->spec;\n\tmutex_lock(&ice->gpio_mutex);\n\tICE1712_STDSP24_3_MUTE(spec->boxbits, activate);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\nstatic void snd_ice1712_stdsp24_insel(struct snd_ice1712 *ice, int activate)\n{\n\tstruct hoontech_spec *spec = ice->spec;\n\tmutex_lock(&ice->gpio_mutex);\n\tICE1712_STDSP24_3_INSEL(spec->boxbits, activate);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\nstatic void snd_ice1712_stdsp24_box_channel(struct snd_ice1712 *ice, int box, int chn, int activate)\n{\n\tstruct hoontech_spec *spec = ice->spec;\n\n\tmutex_lock(&ice->gpio_mutex);\n\n\t \n\tICE1712_STDSP24_0_BOX(spec->boxbits, box);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[0]);\n\n\t \n\tif (chn == 3)\n\t\tICE1712_STDSP24_2_CHN4(spec->boxbits, 0);\n\tICE1712_STDSP24_2_MIDI1(spec->boxbits, activate);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\n\n\tICE1712_STDSP24_1_CHN1(spec->boxbits, 1);\n\tICE1712_STDSP24_1_CHN2(spec->boxbits, 1);\n\tICE1712_STDSP24_1_CHN3(spec->boxbits, 1);\n\tICE1712_STDSP24_2_CHN4(spec->boxbits, 1);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[1]);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\tudelay(100);\n\tif (chn == 3) {\n\t\tICE1712_STDSP24_2_CHN4(spec->boxbits, 0);\n\t\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\t} else {\n\t\tswitch (chn) {\n\t\tcase 0:\tICE1712_STDSP24_1_CHN1(spec->boxbits, 0); break;\n\t\tcase 1:\tICE1712_STDSP24_1_CHN2(spec->boxbits, 0); break;\n\t\tcase 2:\tICE1712_STDSP24_1_CHN3(spec->boxbits, 0); break;\n\t\t}\n\t\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[1]);\n\t}\n\tudelay(100);\n\tICE1712_STDSP24_1_CHN1(spec->boxbits, 1);\n\tICE1712_STDSP24_1_CHN2(spec->boxbits, 1);\n\tICE1712_STDSP24_1_CHN3(spec->boxbits, 1);\n\tICE1712_STDSP24_2_CHN4(spec->boxbits, 1);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[1]);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\tudelay(100);\n\n\tICE1712_STDSP24_2_MIDI1(spec->boxbits, 0);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\nstatic void snd_ice1712_stdsp24_box_midi(struct snd_ice1712 *ice, int box, int master)\n{\n\tstruct hoontech_spec *spec = ice->spec;\n\n\tmutex_lock(&ice->gpio_mutex);\n\n\t \n\tICE1712_STDSP24_0_BOX(spec->boxbits, box);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[0]);\n\n\tICE1712_STDSP24_2_MIDIIN(spec->boxbits, 1);\n\tICE1712_STDSP24_2_MIDI1(spec->boxbits, master);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\n\n\tudelay(100);\n\t\n\tICE1712_STDSP24_2_MIDIIN(spec->boxbits, 0);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\t\n\tmdelay(10);\n\t\n\tICE1712_STDSP24_2_MIDIIN(spec->boxbits, 1);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\n\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\nstatic void snd_ice1712_stdsp24_midi2(struct snd_ice1712 *ice, int activate)\n{\n\tstruct hoontech_spec *spec = ice->spec;\n\tmutex_lock(&ice->gpio_mutex);\n\tICE1712_STDSP24_3_MIDI2(spec->boxbits, activate);\n\tsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\nstatic int hoontech_init(struct snd_ice1712 *ice, bool staudio)\n{\n\tstruct hoontech_spec *spec;\n\tint box, chn;\n\n\tice->num_total_dacs = 8;\n\tice->num_total_adcs = 8;\n\n\tspec = kzalloc(sizeof(*spec), GFP_KERNEL);\n\tif (!spec)\n\t\treturn -ENOMEM;\n\tice->spec = spec;\n\n\tICE1712_STDSP24_SET_ADDR(spec->boxbits, 0);\n\tICE1712_STDSP24_CLOCK(spec->boxbits, 0, 1);\n\tICE1712_STDSP24_0_BOX(spec->boxbits, 0);\n\tICE1712_STDSP24_0_DAREAR(spec->boxbits, 0);\n\n\tICE1712_STDSP24_SET_ADDR(spec->boxbits, 1);\n\tICE1712_STDSP24_CLOCK(spec->boxbits, 1, 1);\n\tICE1712_STDSP24_1_CHN1(spec->boxbits, 1);\n\tICE1712_STDSP24_1_CHN2(spec->boxbits, 1);\n\tICE1712_STDSP24_1_CHN3(spec->boxbits, 1);\n\t\n\tICE1712_STDSP24_SET_ADDR(spec->boxbits, 2);\n\tICE1712_STDSP24_CLOCK(spec->boxbits, 2, 1);\n\tICE1712_STDSP24_2_CHN4(spec->boxbits, 1);\n\tICE1712_STDSP24_2_MIDIIN(spec->boxbits, 1);\n\tICE1712_STDSP24_2_MIDI1(spec->boxbits, 0);\n\n\tICE1712_STDSP24_SET_ADDR(spec->boxbits, 3);\n\tICE1712_STDSP24_CLOCK(spec->boxbits, 3, 1);\n\tICE1712_STDSP24_3_MIDI2(spec->boxbits, 0);\n\tICE1712_STDSP24_3_MUTE(spec->boxbits, 1);\n\tICE1712_STDSP24_3_INSEL(spec->boxbits, 0);\n\n\t \n\tif (staudio)\n\t\tspec->config = ICE1712_STDSP24_MUTE;\n\telse\n\t\tspec->config = 0;\n\t\t\t     \n\t \n\tspec->boxconfig[0] = ICE1712_STDSP24_BOX_CHN1 |\n\t\t\t\t     ICE1712_STDSP24_BOX_CHN2 |\n\t\t\t\t     ICE1712_STDSP24_BOX_CHN3 |\n\t\t\t\t     ICE1712_STDSP24_BOX_CHN4 |\n\t\t\t\t     ICE1712_STDSP24_BOX_MIDI1 |\n\t\t\t\t     ICE1712_STDSP24_BOX_MIDI2;\n\tif (staudio) {\n\t\tspec->boxconfig[1] =\n\t\tspec->boxconfig[2] =\n\t\tspec->boxconfig[3] = spec->boxconfig[0];\n\t} else {\n\t\tspec->boxconfig[1] =\n\t\tspec->boxconfig[2] =\n\t\tspec->boxconfig[3] = 0;\n\t}\n\n\tsnd_ice1712_stdsp24_darear(ice,\n\t\t(spec->config & ICE1712_STDSP24_DAREAR) ? 1 : 0);\n\tsnd_ice1712_stdsp24_mute(ice,\n\t\t(spec->config & ICE1712_STDSP24_MUTE) ? 1 : 0);\n\tsnd_ice1712_stdsp24_insel(ice,\n\t\t(spec->config & ICE1712_STDSP24_INSEL) ? 1 : 0);\n\tfor (box = 0; box < 4; box++) {\n\t\tif (spec->boxconfig[box] & ICE1712_STDSP24_BOX_MIDI2)\n                        snd_ice1712_stdsp24_midi2(ice, 1);\n\t\tfor (chn = 0; chn < 4; chn++)\n\t\t\tsnd_ice1712_stdsp24_box_channel(ice, box, chn,\n\t\t\t\t(spec->boxconfig[box] & (1 << chn)) ? 1 : 0);\n\t\tif (spec->boxconfig[box] & ICE1712_STDSP24_BOX_MIDI1)\n\t\t\tsnd_ice1712_stdsp24_box_midi(ice, box, 1);\n\t}\n\n\treturn 0;\n}\n\nstatic int snd_ice1712_hoontech_init(struct snd_ice1712 *ice)\n{\n\treturn hoontech_init(ice, false);\n}\n\nstatic int snd_ice1712_staudio_init(struct snd_ice1712 *ice)\n{\n\treturn hoontech_init(ice, true);\n}\n\n \n\n \nstatic void stdsp24_ak4524_lock(struct snd_akm4xxx *ak, int chip)\n{\n\tstruct snd_ice1712 *ice = ak->private_data[0];\n\tunsigned char tmp;\n\tsnd_ice1712_save_gpio_status(ice);\n\ttmp =\tICE1712_STDSP24_SERIAL_DATA |\n\t\tICE1712_STDSP24_SERIAL_CLOCK |\n\t\tICE1712_STDSP24_AK4524_CS;\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DIRECTION,\n\t\t\t  ice->gpio.direction | tmp);\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_WRITE_MASK, ~tmp);\n}\n\nstatic int snd_ice1712_value_init(struct snd_ice1712 *ice)\n{\n\t \n\tstatic const struct snd_akm4xxx akm_stdsp24_mv = {\n\t\t.num_adcs = 2,\n\t\t.num_dacs = 2,\n\t\t.type = SND_AK4524,\n\t\t.ops = {\n\t\t\t.lock = stdsp24_ak4524_lock\n\t\t}\n\t};\n\n\tstatic const struct snd_ak4xxx_private akm_stdsp24_mv_priv = {\n\t\t.caddr = 2,\n\t\t.cif = 1,  \n\t\t.data_mask = ICE1712_STDSP24_SERIAL_DATA,\n\t\t.clk_mask = ICE1712_STDSP24_SERIAL_CLOCK,\n\t\t.cs_mask = ICE1712_STDSP24_AK4524_CS,\n\t\t.cs_addr = ICE1712_STDSP24_AK4524_CS,\n\t\t.cs_none = 0,\n\t\t.add_flags = 0,\n\t};\n\n\tint err;\n\tstruct snd_akm4xxx *ak;\n\n\t \n\tice->num_total_dacs = 2;\n\n\t \n\tice->num_total_adcs = 2;\n\t\n\t \n\tak = ice->akm = kmalloc(sizeof(struct snd_akm4xxx), GFP_KERNEL);\n\tif (! ak)\n\t\treturn -ENOMEM;\n\tice->akm_codecs = 1;\n\n\terr = snd_ice1712_akm4xxx_init(ak, &akm_stdsp24_mv, &akm_stdsp24_mv_priv, ice);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\treturn snd_ice1712_akm4xxx_build_controls(ice);\n}\n\nstatic int snd_ice1712_ez8_init(struct snd_ice1712 *ice)\n{\n\tice->gpio.write_mask = ice->eeprom.gpiomask;\n\tice->gpio.direction = ice->eeprom.gpiodir;\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_WRITE_MASK, ice->eeprom.gpiomask);\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DIRECTION, ice->eeprom.gpiodir);\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, ice->eeprom.gpiostate);\n\treturn 0;\n}\n\n\n \nstruct snd_ice1712_card_info snd_ice1712_hoontech_cards[] = {\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_STDSP24,\n\t\t.name = \"Hoontech SoundTrack Audio DSP24\",\n\t\t.model = \"dsp24\",\n\t\t.chip_init = snd_ice1712_hoontech_init,\n\t\t.mpu401_1_name = \"MIDI-1 Hoontech/STA DSP24\",\n\t\t.mpu401_2_name = \"MIDI-2 Hoontech/STA DSP24\",\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_STDSP24_VALUE,\t \n\t\t.name = \"Hoontech SoundTrack Audio DSP24 Value\",\n\t\t.model = \"dsp24_value\",\n\t\t.chip_init = snd_ice1712_value_init,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_STDSP24_MEDIA7_1,\n\t\t.name = \"Hoontech STA DSP24 Media 7.1\",\n\t\t.model = \"dsp24_71\",\n\t\t.chip_init = snd_ice1712_hoontech_init,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_EVENT_EZ8,\t \n\t\t.name = \"Event Electronics EZ8\",\n\t\t.model = \"ez8\",\n\t\t.chip_init = snd_ice1712_ez8_init,\n\t},\n\t{\n\t\t \n\t\t.subvendor = ICE1712_SUBDEVICE_STAUDIO_ADCIII,\t \n\t\t.name = \"STAudio ADCIII\",\n\t\t.model = \"staudio\",\n\t\t.chip_init = snd_ice1712_staudio_init,\n\t},\n\t{ }  \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}