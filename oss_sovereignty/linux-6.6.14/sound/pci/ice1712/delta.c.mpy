{
  "module_name": "delta.c",
  "hash_id": "0b7c63790138beba71d89af72880a869f5aaaca4811501a4a111ab6b4f0e94a3",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/ice1712/delta.c",
  "human_readable_source": "\n       \n\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/mutex.h>\n\n#include <sound/core.h>\n#include <sound/cs8427.h>\n#include <sound/asoundef.h>\n\n#include \"ice1712.h\"\n#include \"delta.h\"\n\n#define SND_CS8403\n#include <sound/cs8403.h>\n\n\n \n\n \nstatic void ap_cs8427_write_byte(struct snd_ice1712 *ice, unsigned char data, unsigned char tmp)\n{\n\tint idx;\n\n\tfor (idx = 7; idx >= 0; idx--) {\n\t\ttmp &= ~(ICE1712_DELTA_AP_DOUT|ICE1712_DELTA_AP_CCLK);\n\t\tif (data & (1 << idx))\n\t\t\ttmp |= ICE1712_DELTA_AP_DOUT;\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\t\tudelay(5);\n\t\ttmp |= ICE1712_DELTA_AP_CCLK;\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\t\tudelay(5);\n\t}\n}\n\n \nstatic unsigned char ap_cs8427_read_byte(struct snd_ice1712 *ice, unsigned char tmp)\n{\n\tunsigned char data = 0;\n\tint idx;\n\t\n\tfor (idx = 7; idx >= 0; idx--) {\n\t\ttmp &= ~ICE1712_DELTA_AP_CCLK;\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\t\tudelay(5);\n\t\tif (snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA) & ICE1712_DELTA_AP_DIN)\n\t\t\tdata |= 1 << idx;\n\t\ttmp |= ICE1712_DELTA_AP_CCLK;\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\t\tudelay(5);\n\t}\n\treturn data;\n}\n\n \nstatic unsigned char ap_cs8427_codec_select(struct snd_ice1712 *ice)\n{\n\tunsigned char tmp;\n\ttmp = snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA);\n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\t\ttmp &= ~ICE1712_DELTA_1010LT_CS;\n\t\ttmp |= ICE1712_DELTA_1010LT_CCLK | ICE1712_DELTA_1010LT_CS_CS8427;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\t\ttmp |= ICE1712_DELTA_AP_CCLK | ICE1712_DELTA_AP_CS_CODEC;\n\t\ttmp &= ~ICE1712_DELTA_AP_CS_DIGITAL;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA66E:\n\t\ttmp |= ICE1712_DELTA_66E_CCLK | ICE1712_DELTA_66E_CS_CHIP_A |\n\t\t       ICE1712_DELTA_66E_CS_CHIP_B;\n\t\ttmp &= ~ICE1712_DELTA_66E_CS_CS8427;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_VX442:\n\t\ttmp |= ICE1712_VX442_CCLK | ICE1712_VX442_CODEC_CHIP_A | ICE1712_VX442_CODEC_CHIP_B;\n\t\ttmp &= ~ICE1712_VX442_CS_DIGITAL;\n\t\tbreak;\n\t}\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\tudelay(5);\n\treturn tmp;\n}\n\n \nstatic void ap_cs8427_codec_deassert(struct snd_ice1712 *ice, unsigned char tmp)\n{\n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\t\ttmp &= ~ICE1712_DELTA_1010LT_CS;\n\t\ttmp |= ICE1712_DELTA_1010LT_CS_NONE;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\t\ttmp |= ICE1712_DELTA_AP_CS_DIGITAL;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA66E:\n\t\ttmp |= ICE1712_DELTA_66E_CS_CS8427;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_VX442:\n\t\ttmp |= ICE1712_VX442_CS_DIGITAL;\n\t\tbreak;\n\t}\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n}\n\n \nstatic int ap_cs8427_sendbytes(struct snd_i2c_device *device, unsigned char *bytes, int count)\n{\n\tstruct snd_ice1712 *ice = device->bus->private_data;\n\tint res = count;\n\tunsigned char tmp;\n\n\tmutex_lock(&ice->gpio_mutex);\n\ttmp = ap_cs8427_codec_select(ice);\n\tap_cs8427_write_byte(ice, (device->addr << 1) | 0, tmp);  \n\twhile (count-- > 0)\n\t\tap_cs8427_write_byte(ice, *bytes++, tmp);\n\tap_cs8427_codec_deassert(ice, tmp);\n\tmutex_unlock(&ice->gpio_mutex);\n\treturn res;\n}\n\n \nstatic int ap_cs8427_readbytes(struct snd_i2c_device *device, unsigned char *bytes, int count)\n{\n\tstruct snd_ice1712 *ice = device->bus->private_data;\n\tint res = count;\n\tunsigned char tmp;\n\t\n\tmutex_lock(&ice->gpio_mutex);\n\ttmp = ap_cs8427_codec_select(ice);\n\tap_cs8427_write_byte(ice, (device->addr << 1) | 1, tmp);  \n\twhile (count-- > 0)\n\t\t*bytes++ = ap_cs8427_read_byte(ice, tmp);\n\tap_cs8427_codec_deassert(ice, tmp);\n\tmutex_unlock(&ice->gpio_mutex);\n\treturn res;\n}\n\nstatic int ap_cs8427_probeaddr(struct snd_i2c_bus *bus, unsigned short addr)\n{\n\tif (addr == 0x10)\n\t\treturn 1;\n\treturn -ENOENT;\n}\n\nstatic const struct snd_i2c_ops ap_cs8427_i2c_ops = {\n\t.sendbytes = ap_cs8427_sendbytes,\n\t.readbytes = ap_cs8427_readbytes,\n\t.probeaddr = ap_cs8427_probeaddr,\n};\n\n \n\nstatic void snd_ice1712_delta_cs8403_spdif_write(struct snd_ice1712 *ice, unsigned char bits)\n{\n\tunsigned char tmp, mask1, mask2;\n\tint idx;\n\t \n\tmask1 = ICE1712_DELTA_SPDIF_OUT_STAT_CLOCK;\n\tmask2 = ICE1712_DELTA_SPDIF_OUT_STAT_DATA;\n\tmutex_lock(&ice->gpio_mutex);\n\ttmp = snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA);\n\tfor (idx = 7; idx >= 0; idx--) {\n\t\ttmp &= ~(mask1 | mask2);\n\t\tif (bits & (1 << idx))\n\t\t\ttmp |= mask2;\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\t\tudelay(100);\n\t\ttmp |= mask1;\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\t\tudelay(100);\n\t}\n\ttmp &= ~mask1;\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\n\nstatic void delta_spdif_default_get(struct snd_ice1712 *ice, struct snd_ctl_elem_value *ucontrol)\n{\n\tsnd_cs8403_decode_spdif_bits(&ucontrol->value.iec958, ice->spdif.cs8403_bits);\n}\n\nstatic int delta_spdif_default_put(struct snd_ice1712 *ice, struct snd_ctl_elem_value *ucontrol)\n{\n\tunsigned int val;\n\tint change;\n\n\tval = snd_cs8403_encode_spdif_bits(&ucontrol->value.iec958);\n\tspin_lock_irq(&ice->reg_lock);\n\tchange = ice->spdif.cs8403_bits != val;\n\tice->spdif.cs8403_bits = val;\n\tif (change && ice->playback_pro_substream == NULL) {\n\t\tspin_unlock_irq(&ice->reg_lock);\n\t\tsnd_ice1712_delta_cs8403_spdif_write(ice, val);\n\t} else {\n\t\tspin_unlock_irq(&ice->reg_lock);\n\t}\n\treturn change;\n}\n\nstatic void delta_spdif_stream_get(struct snd_ice1712 *ice, struct snd_ctl_elem_value *ucontrol)\n{\n\tsnd_cs8403_decode_spdif_bits(&ucontrol->value.iec958, ice->spdif.cs8403_stream_bits);\n}\n\nstatic int delta_spdif_stream_put(struct snd_ice1712 *ice, struct snd_ctl_elem_value *ucontrol)\n{\n\tunsigned int val;\n\tint change;\n\n\tval = snd_cs8403_encode_spdif_bits(&ucontrol->value.iec958);\n\tspin_lock_irq(&ice->reg_lock);\n\tchange = ice->spdif.cs8403_stream_bits != val;\n\tice->spdif.cs8403_stream_bits = val;\n\tif (change && ice->playback_pro_substream != NULL) {\n\t\tspin_unlock_irq(&ice->reg_lock);\n\t\tsnd_ice1712_delta_cs8403_spdif_write(ice, val);\n\t} else {\n\t\tspin_unlock_irq(&ice->reg_lock);\n\t}\n\treturn change;\n}\n\n\n \nstatic void delta_ak4524_lock(struct snd_akm4xxx *ak, int chip)\n{\n        struct snd_ak4xxx_private *priv = (void *)ak->private_value[0];\n        struct snd_ice1712 *ice = ak->private_data[0];\n\n\tsnd_ice1712_save_gpio_status(ice);\n\tpriv->cs_mask =\n\tpriv->cs_addr = chip == 0 ? ICE1712_DELTA_CODEC_CHIP_A :\n\t\t\t\t    ICE1712_DELTA_CODEC_CHIP_B;\n}\n\n \nstatic void delta1010lt_ak4524_lock(struct snd_akm4xxx *ak, int chip)\n{\n        struct snd_ak4xxx_private *priv = (void *)ak->private_value[0];\n        struct snd_ice1712 *ice = ak->private_data[0];\n\n\tsnd_ice1712_save_gpio_status(ice);\n\tpriv->cs_mask = ICE1712_DELTA_1010LT_CS;\n\tpriv->cs_addr = chip << 4;\n}\n\n \nstatic void delta66e_ak4524_lock(struct snd_akm4xxx *ak, int chip)\n{\n\tstruct snd_ak4xxx_private *priv = (void *)ak->private_value[0];\n\tstruct snd_ice1712 *ice = ak->private_data[0];\n\n\tsnd_ice1712_save_gpio_status(ice);\n\tpriv->cs_mask =\n\tpriv->cs_addr = chip == 0 ? ICE1712_DELTA_66E_CS_CHIP_A :\n\t\t\t\t    ICE1712_DELTA_66E_CS_CHIP_B;\n}\n\n \nstatic void vx442_ak4524_lock(struct snd_akm4xxx *ak, int chip)\n{\n        struct snd_ak4xxx_private *priv = (void *)ak->private_value[0];\n        struct snd_ice1712 *ice = ak->private_data[0];\n\n\tsnd_ice1712_save_gpio_status(ice);\n\tpriv->cs_mask =\n\tpriv->cs_addr = chip == 0 ? ICE1712_VX442_CODEC_CHIP_A :\n\t\t\t\t    ICE1712_VX442_CODEC_CHIP_B;\n}\n\n \nstatic void delta_1010_set_rate_val(struct snd_ice1712 *ice, unsigned int rate)\n{\n\tunsigned char tmp, tmp2;\n\n\tif (rate == 0)\t \n\t\treturn;\n\n\tmutex_lock(&ice->gpio_mutex);\n\ttmp = snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA);\n\ttmp2 = tmp & ~ICE1712_DELTA_DFS;\n\tif (rate > 48000)\n\t\ttmp2 |= ICE1712_DELTA_DFS;\n\tif (tmp != tmp2)\n\t\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp2);\n\tmutex_unlock(&ice->gpio_mutex);\n}\n\n \nstatic void delta_ak4524_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\n{\n\tunsigned char tmp, tmp2;\n\tstruct snd_ice1712 *ice = ak->private_data[0];\n\n\tif (rate == 0)\t \n\t\treturn;\n\n\t \n\tmutex_lock(&ice->gpio_mutex);\n\ttmp = snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA);\n\tmutex_unlock(&ice->gpio_mutex);\n\ttmp2 = tmp & ~ICE1712_DELTA_DFS; \n\tif (rate > 48000)\n\t\ttmp2 |= ICE1712_DELTA_DFS;\n\tif (tmp == tmp2)\n\t\treturn;\n\n\t \n\tsnd_akm4xxx_reset(ak, 1);\n\tmutex_lock(&ice->gpio_mutex);\n\ttmp = snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA) & ~ICE1712_DELTA_DFS;\n\tif (rate > 48000)\n\t\ttmp |= ICE1712_DELTA_DFS;\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\tmutex_unlock(&ice->gpio_mutex);\n\tsnd_akm4xxx_reset(ak, 0);\n}\n\n \nstatic void vx442_ak4524_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\n{\n\tunsigned char val;\n\n\tval = (rate > 48000) ? 0x65 : 0x60;\n\tif (snd_akm4xxx_get(ak, 0, 0x02) != val ||\n\t    snd_akm4xxx_get(ak, 1, 0x02) != val) {\n\t\tsnd_akm4xxx_reset(ak, 1);\n\t\tsnd_akm4xxx_write(ak, 0, 0x02, val);\n\t\tsnd_akm4xxx_write(ak, 1, 0x02, val);\n\t\tsnd_akm4xxx_reset(ak, 0);\n\t}\n}\n\n\n \n\n \nstatic void delta_open_spdif(struct snd_ice1712 *ice, struct snd_pcm_substream *substream)\n{\n\tice->spdif.cs8403_stream_bits = ice->spdif.cs8403_bits;\n}\n\n \nstatic void delta_setup_spdif(struct snd_ice1712 *ice, int rate)\n{\n\tunsigned long flags;\n\tunsigned int tmp;\n\tint change;\n\n\tspin_lock_irqsave(&ice->reg_lock, flags);\n\ttmp = ice->spdif.cs8403_stream_bits;\n\tif (tmp & 0x01)\t\t \n\t\ttmp &= (tmp & 0x01) ? ~0x06 : ~0x18;\n\tswitch (rate) {\n\tcase 32000: tmp |= (tmp & 0x01) ? 0x04 : 0x00; break;\n\tcase 44100: tmp |= (tmp & 0x01) ? 0x00 : 0x10; break;\n\tcase 48000: tmp |= (tmp & 0x01) ? 0x02 : 0x08; break;\n\tdefault: tmp |= (tmp & 0x01) ? 0x00 : 0x18; break;\n\t}\n\tchange = ice->spdif.cs8403_stream_bits != tmp;\n\tice->spdif.cs8403_stream_bits = tmp;\n\tspin_unlock_irqrestore(&ice->reg_lock, flags);\n\tif (change)\n\t\tsnd_ctl_notify(ice->card, SNDRV_CTL_EVENT_MASK_VALUE, &ice->spdif.stream_ctl->id);\n\tsnd_ice1712_delta_cs8403_spdif_write(ice, tmp);\n}\n\n#define snd_ice1712_delta1010lt_wordclock_status_info \\\n\tsnd_ctl_boolean_mono_info\n\nstatic int snd_ice1712_delta1010lt_wordclock_status_get(struct snd_kcontrol *kcontrol,\n\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tchar reg = 0x10;  \n\tstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\n\n\tif (snd_i2c_sendbytes(ice->cs8427, &reg, 1) != 1)\n\t\tdev_err(ice->card->dev,\n\t\t\t\"unable to send register 0x%x byte to CS8427\\n\", reg);\n\tsnd_i2c_readbytes(ice->cs8427, &reg, 1);\n\tucontrol->value.integer.value[0] = (reg & CS8427_UNLOCK) ? 1 : 0;\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new snd_ice1712_delta1010lt_wordclock_status =\n{\n\t.access =\t(SNDRV_CTL_ELEM_ACCESS_READ),\n\t.iface =\tSNDRV_CTL_ELEM_IFACE_MIXER,\n\t.name =         \"Word Clock Status\",\n\t.info =\t\tsnd_ice1712_delta1010lt_wordclock_status_info,\n\t.get =\t\tsnd_ice1712_delta1010lt_wordclock_status_get,\n};\n\n \n\nstatic const struct snd_akm4xxx akm_audiophile = {\n\t.type = SND_AK4528,\n\t.num_adcs = 2,\n\t.num_dacs = 2,\n\t.ops = {\n\t\t.set_rate_val = delta_ak4524_set_rate_val\n\t}\n};\n\nstatic const struct snd_ak4xxx_private akm_audiophile_priv = {\n\t.caddr = 2,\n\t.cif = 0,\n\t.data_mask = ICE1712_DELTA_AP_DOUT,\n\t.clk_mask = ICE1712_DELTA_AP_CCLK,\n\t.cs_mask = ICE1712_DELTA_AP_CS_CODEC,\n\t.cs_addr = ICE1712_DELTA_AP_CS_CODEC,\n\t.cs_none = 0,\n\t.add_flags = ICE1712_DELTA_AP_CS_DIGITAL,\n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_delta410 = {\n\t.type = SND_AK4529,\n\t.num_adcs = 2,\n\t.num_dacs = 8,\n\t.ops = {\n\t\t.set_rate_val = delta_ak4524_set_rate_val\n\t}\n};\n\nstatic const struct snd_ak4xxx_private akm_delta410_priv = {\n\t.caddr = 0,\n\t.cif = 0,\n\t.data_mask = ICE1712_DELTA_AP_DOUT,\n\t.clk_mask = ICE1712_DELTA_AP_CCLK,\n\t.cs_mask = ICE1712_DELTA_AP_CS_CODEC,\n\t.cs_addr = ICE1712_DELTA_AP_CS_CODEC,\n\t.cs_none = 0,\n\t.add_flags = ICE1712_DELTA_AP_CS_DIGITAL,\n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_delta1010lt = {\n\t.type = SND_AK4524,\n\t.num_adcs = 8,\n\t.num_dacs = 8,\n\t.ops = {\n\t\t.lock = delta1010lt_ak4524_lock,\n\t\t.set_rate_val = delta_ak4524_set_rate_val\n\t}\n};\n\nstatic const struct snd_ak4xxx_private akm_delta1010lt_priv = {\n\t.caddr = 2,\n\t.cif = 0,  \n\t.data_mask = ICE1712_DELTA_1010LT_DOUT,\n\t.clk_mask = ICE1712_DELTA_1010LT_CCLK,\n\t.cs_mask = 0,\n\t.cs_addr = 0,  \n\t.cs_none = ICE1712_DELTA_1010LT_CS_NONE,\n\t.add_flags = 0,\n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_delta66e = {\n\t.type = SND_AK4524,\n\t.num_adcs = 4,\n\t.num_dacs = 4,\n\t.ops = {\n\t\t.lock = delta66e_ak4524_lock,\n\t\t.set_rate_val = delta_ak4524_set_rate_val\n\t}\n};\n\nstatic const struct snd_ak4xxx_private akm_delta66e_priv = {\n\t.caddr = 2,\n\t.cif = 0,  \n\t.data_mask = ICE1712_DELTA_66E_DOUT,\n\t.clk_mask = ICE1712_DELTA_66E_CCLK,\n\t.cs_mask = 0,\n\t.cs_addr = 0,  \n\t.cs_none = 0,\n\t.add_flags = 0,\n\t.mask_flags = 0,\n};\n\n\nstatic const struct snd_akm4xxx akm_delta44 = {\n\t.type = SND_AK4524,\n\t.num_adcs = 4,\n\t.num_dacs = 4,\n\t.ops = {\n\t\t.lock = delta_ak4524_lock,\n\t\t.set_rate_val = delta_ak4524_set_rate_val\n\t}\n};\n\nstatic const struct snd_ak4xxx_private akm_delta44_priv = {\n\t.caddr = 2,\n\t.cif = 0,  \n\t.data_mask = ICE1712_DELTA_CODEC_SERIAL_DATA,\n\t.clk_mask = ICE1712_DELTA_CODEC_SERIAL_CLOCK,\n\t.cs_mask = 0,\n\t.cs_addr = 0,  \n\t.cs_none = 0,\n\t.add_flags = 0,\n\t.mask_flags = 0,\n};\n\nstatic const struct snd_akm4xxx akm_vx442 = {\n\t.type = SND_AK4524,\n\t.num_adcs = 4,\n\t.num_dacs = 4,\n\t.ops = {\n\t\t.lock = vx442_ak4524_lock,\n\t\t.set_rate_val = vx442_ak4524_set_rate_val\n\t}\n};\n\nstatic const struct snd_ak4xxx_private akm_vx442_priv = {\n\t.caddr = 2,\n\t.cif = 0,\n\t.data_mask = ICE1712_VX442_DOUT,\n\t.clk_mask = ICE1712_VX442_CCLK,\n\t.cs_mask = 0,\n\t.cs_addr = 0,  \n\t.cs_none = 0,\n\t.add_flags = 0,\n\t.mask_flags = 0,\n};\n\n#ifdef CONFIG_PM_SLEEP\nstatic int snd_ice1712_delta_resume(struct snd_ice1712 *ice)\n{\n\tunsigned char akm_img_bak[AK4XXX_IMAGE_SIZE];\n\tunsigned char akm_vol_bak[AK4XXX_IMAGE_SIZE];\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\tcase ICE1712_SUBDEVICE_VX442:\n\tcase ICE1712_SUBDEVICE_DELTA66E:\n\t\tsnd_cs8427_init(ice->i2c, ice->cs8427);\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\t\t \n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\t\t \n\t\tsnd_ice1712_delta_cs8403_spdif_write(ice, ice->spdif.cs8403_bits);\n\t\tbreak;\n\t}\n\n\t \n\tif (ice->akm_codecs) {\n\t\tmemcpy(akm_img_bak, ice->akm->images, sizeof(akm_img_bak));\n\t\tmemcpy(akm_vol_bak, ice->akm->volumes, sizeof(akm_vol_bak));\n\t\tsnd_akm4xxx_init(ice->akm);\n\t\tmemcpy(ice->akm->images, akm_img_bak, sizeof(akm_img_bak));\n\t\tmemcpy(ice->akm->volumes, akm_vol_bak, sizeof(akm_vol_bak));\n\t\tsnd_akm4xxx_reset(ice->akm, 0);\n\t}\n\n\treturn 0;\n}\n\nstatic int snd_ice1712_delta_suspend(struct snd_ice1712 *ice)\n{\n\tif (ice->akm_codecs)  \n\t\tsnd_akm4xxx_reset(ice->akm, 1);\n\n\treturn 0;\n}\n#endif\n\nstatic int snd_ice1712_delta_init(struct snd_ice1712 *ice)\n{\n\tint err;\n\tstruct snd_akm4xxx *ak;\n\tunsigned char tmp;\n\n\tif (ice->eeprom.subvendor == ICE1712_SUBDEVICE_DELTA1010 &&\n\t    ice->eeprom.gpiodir == 0x7b)\n\t\tice->eeprom.subvendor = ICE1712_SUBDEVICE_DELTA1010E;\n\n\tif (ice->eeprom.subvendor == ICE1712_SUBDEVICE_DELTA66 &&\n\t    ice->eeprom.gpiodir == 0xfb)\n\t    \tice->eeprom.subvendor = ICE1712_SUBDEVICE_DELTA66E;\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\t\tice->num_total_dacs = 2;\n\t\tice->num_total_adcs = 2;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\t\tice->num_total_dacs = 8;\n\t\tice->num_total_adcs = 2;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA44:\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\t\tice->num_total_dacs = ice->omni ? 8 : 4;\n\t\tice->num_total_adcs = ice->omni ? 8 : 4;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\tcase ICE1712_SUBDEVICE_EDIROLDA2496:\n\t\tice->num_total_dacs = 8;\n\t\tice->num_total_adcs = 8;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\t\tice->num_total_dacs = 4;\t \n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_VX442:\n\tcase ICE1712_SUBDEVICE_DELTA66E:\t \n\t\tice->num_total_dacs = 4;\n\t\tice->num_total_adcs = 4;\n\t\tbreak;\n\t}\n#ifdef CONFIG_PM_SLEEP\n\tice->pm_resume = snd_ice1712_delta_resume;\n\tice->pm_suspend = snd_ice1712_delta_suspend;\n\tice->pm_suspend_enabled = 1;\n#endif\n\t \n\ttmp = snd_ice1712_read(ice, ICE1712_IREG_GPIO_DATA);\n\ttmp |= ICE1712_DELTA_AP_CCLK;\n\tsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, tmp);\n\tudelay(5);\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\tcase ICE1712_SUBDEVICE_VX442:\n\tcase ICE1712_SUBDEVICE_DELTA66E:\n\t\terr = snd_i2c_bus_create(ice->card, \"ICE1712 GPIO 1\", NULL, &ice->i2c);\n\t\tif (err < 0) {\n\t\t\tdev_err(ice->card->dev, \"unable to create I2C bus\\n\");\n\t\t\treturn err;\n\t\t}\n\t\tice->i2c->private_data = ice;\n\t\tice->i2c->ops = &ap_cs8427_i2c_ops;\n\t\terr = snd_ice1712_init_cs8427(ice, CS8427_BASE_ADDR);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\t\tice->gpio.set_pro_rate = delta_1010_set_rate_val;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\t\tice->gpio.set_pro_rate = delta_1010_set_rate_val;\n\t\tfallthrough;\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\t\tice->spdif.ops.open = delta_open_spdif;\n\t\tice->spdif.ops.setup_rate = delta_setup_spdif;\n\t\tice->spdif.ops.default_get = delta_spdif_default_get;\n\t\tice->spdif.ops.default_put = delta_spdif_default_put;\n\t\tice->spdif.ops.stream_get = delta_spdif_stream_get;\n\t\tice->spdif.ops.stream_put = delta_spdif_stream_put;\n\t\t \n\t\tsnd_ice1712_delta_cs8403_spdif_write(ice, ice->spdif.cs8403_bits);\n\t\tbreak;\n\t}\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\t\treturn 0;\n\t}\n\n\t \n\tak = ice->akm = kmalloc(sizeof(struct snd_akm4xxx), GFP_KERNEL);\n\tif (! ak)\n\t\treturn -ENOMEM;\n\tice->akm_codecs = 1;\n\n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_audiophile, &akm_audiophile_priv, ice);\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_delta410, &akm_delta410_priv, ice);\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\tcase ICE1712_SUBDEVICE_EDIROLDA2496:\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_delta1010lt, &akm_delta1010lt_priv, ice);\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\tcase ICE1712_SUBDEVICE_DELTA44:\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_delta44, &akm_delta44_priv, ice);\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_VX442:\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_vx442, &akm_vx442_priv, ice);\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA66E:\n\t\terr = snd_ice1712_akm4xxx_init(ak, &akm_delta66e, &akm_delta66e_priv, ice);\n\t\tbreak;\n\tdefault:\n\t\tsnd_BUG();\n\t\treturn -EINVAL;\n\t}\n\n\treturn err;\n}\n\n\n \n\nstatic const struct snd_kcontrol_new snd_ice1712_delta1010_wordclock_select =\nICE1712_GPIO(SNDRV_CTL_ELEM_IFACE_MIXER, \"Word Clock Sync\", 0, ICE1712_DELTA_WORD_CLOCK_SELECT, 1, 0);\nstatic const struct snd_kcontrol_new snd_ice1712_delta1010lt_wordclock_select =\nICE1712_GPIO(SNDRV_CTL_ELEM_IFACE_MIXER, \"Word Clock Sync\", 0, ICE1712_DELTA_1010LT_WORDCLOCK, 0, 0);\nstatic const struct snd_kcontrol_new snd_ice1712_delta1010_wordclock_status =\nICE1712_GPIO(SNDRV_CTL_ELEM_IFACE_MIXER, \"Word Clock Status\", 0, ICE1712_DELTA_WORD_CLOCK_STATUS, 1, SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE);\nstatic const struct snd_kcontrol_new snd_ice1712_deltadio2496_spdif_in_select =\nICE1712_GPIO(SNDRV_CTL_ELEM_IFACE_MIXER, \"IEC958 Input Optical\", 0, ICE1712_DELTA_SPDIF_INPUT_SELECT, 0, 0);\nstatic const struct snd_kcontrol_new snd_ice1712_delta_spdif_in_status =\nICE1712_GPIO(SNDRV_CTL_ELEM_IFACE_MIXER, \"Delta IEC958 Input Status\", 0, ICE1712_DELTA_SPDIF_IN_STAT, 1, SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE);\n\n\nstatic int snd_ice1712_delta_add_controls(struct snd_ice1712 *ice)\n{\n\tint err;\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\t\terr = snd_ctl_add(ice->card, snd_ctl_new1(&snd_ice1712_delta1010_wordclock_select, ice));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = snd_ctl_add(ice->card, snd_ctl_new1(&snd_ice1712_delta1010_wordclock_status, ice));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\t\terr = snd_ctl_add(ice->card, snd_ctl_new1(&snd_ice1712_deltadio2496_spdif_in_select, ice));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tcase ICE1712_SUBDEVICE_DELTA1010E:\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\t\terr = snd_ctl_add(ice->card, snd_ctl_new1(&snd_ice1712_delta1010lt_wordclock_select, ice));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = snd_ctl_add(ice->card, snd_ctl_new1(&snd_ice1712_delta1010lt_wordclock_status, ice));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\t}\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\t\terr = snd_ice1712_spdif_build_controls(ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\t}\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010:\n\tcase ICE1712_SUBDEVICE_DELTADIO2496:\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\tcase ICE1712_SUBDEVICE_MEDIASTATION:\n\t\terr = snd_ctl_add(ice->card, snd_ctl_new1(&snd_ice1712_delta_spdif_in_status, ice));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\t}\n\n\t \n\tswitch (ice->eeprom.subvendor) {\n\tcase ICE1712_SUBDEVICE_DELTA1010LT:\n\tcase ICE1712_SUBDEVICE_AUDIOPHILE:\n\tcase ICE1712_SUBDEVICE_DELTA410:\n\tcase ICE1712_SUBDEVICE_DELTA44:\n\tcase ICE1712_SUBDEVICE_DELTA66:\n\tcase ICE1712_SUBDEVICE_VX442:\n\tcase ICE1712_SUBDEVICE_DELTA66E:\n\tcase ICE1712_SUBDEVICE_EDIROLDA2496:\n\t\terr = snd_ice1712_akm4xxx_build_controls(ice);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n\n \nstruct snd_ice1712_card_info snd_ice1712_delta_cards[] = {\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_DELTA1010,\n\t\t.name = \"M Audio Delta 1010\",\n\t\t.model = \"delta1010\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_DELTADIO2496,\n\t\t.name = \"M Audio Delta DiO 2496\",\n\t\t.model = \"dio2496\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t\t.no_mpu401 = 1,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_DELTA66,\n\t\t.name = \"M Audio Delta 66\",\n\t\t.model = \"delta66\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t\t.no_mpu401 = 1,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_DELTA44,\n\t\t.name = \"M Audio Delta 44\",\n\t\t.model = \"delta44\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t\t.no_mpu401 = 1,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_AUDIOPHILE,\n\t\t.name = \"M Audio Audiophile 24/96\",\n\t\t.model = \"audiophile\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_DELTA410,\n\t\t.name = \"M Audio Delta 410\",\n\t\t.model = \"delta410\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_DELTA1010LT,\n\t\t.name = \"M Audio Delta 1010LT\",\n\t\t.model = \"delta1010lt\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_VX442,\n\t\t.name = \"Digigram VX442\",\n\t\t.model = \"vx442\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t\t.no_mpu401 = 1,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_MEDIASTATION,\n\t\t.name = \"Lionstracs Mediastation\",\n\t\t.model = \"mediastation\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t},\n\t{\n\t\t.subvendor = ICE1712_SUBDEVICE_EDIROLDA2496,\n\t\t.name = \"Edirol DA2496\",\n\t\t.model = \"da2496\",\n\t\t.chip_init = snd_ice1712_delta_init,\n\t\t.build_controls = snd_ice1712_delta_add_controls,\n\t},\n\t{ }  \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}