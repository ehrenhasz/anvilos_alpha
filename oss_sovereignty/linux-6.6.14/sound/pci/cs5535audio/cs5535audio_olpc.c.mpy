{
  "module_name": "cs5535audio_olpc.c",
  "hash_id": "e3a3591e72e4067f866d3c19641ec935f0274910e7ee66599f8d382842e814ad",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/cs5535audio/cs5535audio_olpc.c",
  "human_readable_source": "\n \n#include <sound/core.h>\n#include <sound/info.h>\n#include <sound/control.h>\n#include <sound/ac97_codec.h>\n#include <linux/gpio.h>\n\n#include <asm/olpc.h>\n#include \"cs5535audio.h\"\n\n#define DRV_NAME \"cs5535audio-olpc\"\n\n \nvoid olpc_analog_input(struct snd_ac97 *ac97, int on)\n{\n\tint err;\n\n\tif (!machine_is_olpc())\n\t\treturn;\n\n\t \n\terr = snd_ac97_update_bits(ac97, AC97_AD_TEST2,\n\t\t\t1 << AC97_AD_HPFD_SHIFT, on << AC97_AD_HPFD_SHIFT);\n\tif (err < 0) {\n\t\tdev_err(ac97->bus->card->dev,\n\t\t\t\"setting High Pass Filter - %d\\n\", err);\n\t\treturn;\n\t}\n\n\t \n\tgpio_set_value(OLPC_GPIO_MIC_AC, on);\n}\n\n \nvoid olpc_mic_bias(struct snd_ac97 *ac97, int on)\n{\n\tint err;\n\n\tif (!machine_is_olpc())\n\t\treturn;\n\n\ton = on ? 0 : 1;\n\terr = snd_ac97_update_bits(ac97, AC97_AD_MISC,\n\t\t\t1 << AC97_AD_VREFD_SHIFT, on << AC97_AD_VREFD_SHIFT);\n\tif (err < 0)\n\t\tdev_err(ac97->bus->card->dev, \"setting MIC Bias - %d\\n\", err);\n}\n\nstatic int olpc_dc_info(struct snd_kcontrol *kctl,\n\t\tstruct snd_ctl_elem_info *uinfo)\n{\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_BOOLEAN;\n\tuinfo->count = 1;\n\tuinfo->value.integer.min = 0;\n\tuinfo->value.integer.max = 1;\n\treturn 0;\n}\n\nstatic int olpc_dc_get(struct snd_kcontrol *kctl, struct snd_ctl_elem_value *v)\n{\n\tv->value.integer.value[0] = gpio_get_value(OLPC_GPIO_MIC_AC);\n\treturn 0;\n}\n\nstatic int olpc_dc_put(struct snd_kcontrol *kctl, struct snd_ctl_elem_value *v)\n{\n\tstruct cs5535audio *cs5535au = snd_kcontrol_chip(kctl);\n\n\tolpc_analog_input(cs5535au->ac97, v->value.integer.value[0]);\n\treturn 1;\n}\n\nstatic int olpc_mic_info(struct snd_kcontrol *kctl,\n\t\tstruct snd_ctl_elem_info *uinfo)\n{\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_BOOLEAN;\n\tuinfo->count = 1;\n\tuinfo->value.integer.min = 0;\n\tuinfo->value.integer.max = 1;\n\treturn 0;\n}\n\nstatic int olpc_mic_get(struct snd_kcontrol *kctl, struct snd_ctl_elem_value *v)\n{\n\tstruct cs5535audio *cs5535au = snd_kcontrol_chip(kctl);\n\tstruct snd_ac97 *ac97 = cs5535au->ac97;\n\tint i;\n\n\ti = (snd_ac97_read(ac97, AC97_AD_MISC) >> AC97_AD_VREFD_SHIFT) & 0x1;\n\tv->value.integer.value[0] = i ? 0 : 1;\n\treturn 0;\n}\n\nstatic int olpc_mic_put(struct snd_kcontrol *kctl, struct snd_ctl_elem_value *v)\n{\n\tstruct cs5535audio *cs5535au = snd_kcontrol_chip(kctl);\n\n\tolpc_mic_bias(cs5535au->ac97, v->value.integer.value[0]);\n\treturn 1;\n}\n\nstatic const struct snd_kcontrol_new olpc_cs5535audio_ctls[] = {\n{\n\t.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\n\t.name = \"DC Mode Enable\",\n\t.info = olpc_dc_info,\n\t.get = olpc_dc_get,\n\t.put = olpc_dc_put,\n\t.private_value = 0,\n},\n{\n\t.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\n\t.name = \"MIC Bias Enable\",\n\t.info = olpc_mic_info,\n\t.get = olpc_mic_get,\n\t.put = olpc_mic_put,\n\t.private_value = 0,\n},\n};\n\nvoid olpc_prequirks(struct snd_card *card,\n\t\t    struct snd_ac97_template *ac97)\n{\n\tif (!machine_is_olpc())\n\t\treturn;\n\n\t \n\tif (olpc_board_at_least(olpc_board_pre(0xb3)))\n\t\tac97->scaps |= AC97_SCAP_INV_EAPD;\n}\n\nint olpc_quirks(struct snd_card *card, struct snd_ac97 *ac97)\n{\n\tstruct snd_ctl_elem_id elem;\n\tint i, err;\n\n\tif (!machine_is_olpc())\n\t\treturn 0;\n\n\tif (gpio_request(OLPC_GPIO_MIC_AC, DRV_NAME)) {\n\t\tdev_err(card->dev, \"unable to allocate MIC GPIO\\n\");\n\t\treturn -EIO;\n\t}\n\tgpio_direction_output(OLPC_GPIO_MIC_AC, 0);\n\n\t \n\tmemset(&elem, 0, sizeof(elem));\n\telem.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\n\tstrscpy(elem.name, \"High Pass Filter Enable\", sizeof(elem.name));\n\tsnd_ctl_remove_id(card, &elem);\n\n\t \n\tmemset(&elem, 0, sizeof(elem));\n\telem.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\n\tstrscpy(elem.name, \"V_REFOUT Enable\", sizeof(elem.name));\n\tsnd_ctl_remove_id(card, &elem);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(olpc_cs5535audio_ctls); i++) {\n\t\terr = snd_ctl_add(card, snd_ctl_new1(&olpc_cs5535audio_ctls[i],\n\t\t\t\tac97->private_data));\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\t \n\tolpc_mic_bias(ac97, 0);\n\treturn 0;\n}\n\nvoid olpc_quirks_cleanup(void)\n{\n\tif (machine_is_olpc())\n\t\tgpio_free(OLPC_GPIO_MIC_AC);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}