{
  "module_name": "hpidspcd.c",
  "hash_id": "f386bb75650e57defeb3d491e63d71a3f0304c575faaf6cf154c9336d778f0fb",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/asihpi/hpidspcd.c",
  "human_readable_source": "\n \n#define SOURCEFILE_NAME \"hpidspcd.c\"\n#include \"hpidspcd.h\"\n#include \"hpidebug.h\"\n#include \"hpi_version.h\"\n\nstruct dsp_code_private {\n\t \n\tconst struct firmware *firmware;\n\tstruct pci_dev *dev;\n};\n\n \nshort hpi_dsp_code_open(u32 adapter, void *os_data, struct dsp_code *dsp_code,\n\tu32 *os_error_code)\n{\n\tconst struct firmware *firmware;\n\tstruct pci_dev *dev = os_data;\n\tstruct code_header header;\n\tchar fw_name[20];\n\tshort err_ret = HPI_ERROR_DSP_FILE_NOT_FOUND;\n\tint err;\n\n\tsprintf(fw_name, \"asihpi/dsp%04x.bin\", adapter);\n\n\terr = request_firmware(&firmware, fw_name, &dev->dev);\n\n\tif (err || !firmware) {\n\t\tdev_err(&dev->dev, \"%d, request_firmware failed for %s\\n\",\n\t\t\terr, fw_name);\n\t\tgoto error1;\n\t}\n\tif (firmware->size < sizeof(header)) {\n\t\tdev_err(&dev->dev, \"Header size too small %s\\n\", fw_name);\n\t\tgoto error2;\n\t}\n\tmemcpy(&header, firmware->data, sizeof(header));\n\n\tif ((header.type != 0x45444F43) ||\t \n\t\t(header.adapter != adapter)\n\t\t|| (header.size != firmware->size)) {\n\t\tdev_err(&dev->dev,\n\t\t\t\"Invalid firmware header size %d != file %zd\\n\",\n\t\t\theader.size, firmware->size);\n\t\tgoto error2;\n\t}\n\n\tif (HPI_VER_MAJOR(header.version) != HPI_VER_MAJOR(HPI_VER)) {\n\t\t \n\t\tdev_err(&dev->dev,\n\t\t\t\"Incompatible firmware version DSP image %X != Driver %X\\n\",\n\t\t\theader.version, HPI_VER);\n\t\tgoto error2;\n\t}\n\n\tif (header.version != HPI_VER) {\n\t\tdev_warn(&dev->dev,\n\t\t\t\"Firmware version mismatch: DSP image %X != Driver %X\\n\",\n\t\t\theader.version, HPI_VER);\n\t}\n\n\tHPI_DEBUG_LOG(DEBUG, \"dsp code %s opened\\n\", fw_name);\n\tdsp_code->pvt = kmalloc(sizeof(*dsp_code->pvt), GFP_KERNEL);\n\tif (!dsp_code->pvt) {\n\t\terr_ret = HPI_ERROR_MEMORY_ALLOC;\n\t\tgoto error2;\n\t}\n\n\tdsp_code->pvt->dev = dev;\n\tdsp_code->pvt->firmware = firmware;\n\tdsp_code->header = header;\n\tdsp_code->block_length = header.size / sizeof(u32);\n\tdsp_code->word_count = sizeof(header) / sizeof(u32);\n\treturn 0;\n\nerror2:\n\trelease_firmware(firmware);\nerror1:\n\tdsp_code->block_length = 0;\n\treturn err_ret;\n}\n\n \nvoid hpi_dsp_code_close(struct dsp_code *dsp_code)\n{\n\tHPI_DEBUG_LOG(DEBUG, \"dsp code closed\\n\");\n\trelease_firmware(dsp_code->pvt->firmware);\n\tkfree(dsp_code->pvt);\n}\n\n \nvoid hpi_dsp_code_rewind(struct dsp_code *dsp_code)\n{\n\t \n\tdsp_code->word_count = sizeof(struct code_header) / sizeof(u32);\n}\n\n \nshort hpi_dsp_code_read_word(struct dsp_code *dsp_code, u32 *pword)\n{\n\tif (dsp_code->word_count + 1 > dsp_code->block_length)\n\t\treturn HPI_ERROR_DSP_FILE_FORMAT;\n\n\t*pword = ((u32 *)(dsp_code->pvt->firmware->data))[dsp_code->\n\t\tword_count];\n\tdsp_code->word_count++;\n\treturn 0;\n}\n\n \nshort hpi_dsp_code_read_block(size_t words_requested,\n\tstruct dsp_code *dsp_code, u32 **ppblock)\n{\n\tif (dsp_code->word_count + words_requested > dsp_code->block_length)\n\t\treturn HPI_ERROR_DSP_FILE_FORMAT;\n\n\t*ppblock =\n\t\t((u32 *)(dsp_code->pvt->firmware->data)) +\n\t\tdsp_code->word_count;\n\tdsp_code->word_count += words_requested;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}