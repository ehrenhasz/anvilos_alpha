{
  "module_name": "xonar_lib.c",
  "hash_id": "7dcec4cf94b60cba0ee03ab6c46d52e2c021cb929006cdf3a3629d0302543c24",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/oxygen/xonar_lib.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <sound/core.h>\n#include <sound/control.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include \"xonar.h\"\n\n\n#define GPIO_CS53x1_M_MASK\t0x000c\n#define GPIO_CS53x1_M_SINGLE\t0x0000\n#define GPIO_CS53x1_M_DOUBLE\t0x0004\n#define GPIO_CS53x1_M_QUAD\t0x0008\n\n\nvoid xonar_enable_output(struct oxygen *chip)\n{\n\tstruct xonar_generic *data = chip->model_data;\n\n\toxygen_set_bits16(chip, OXYGEN_GPIO_CONTROL, data->output_enable_bit);\n\tmsleep(data->anti_pop_delay);\n\toxygen_set_bits16(chip, OXYGEN_GPIO_DATA, data->output_enable_bit);\n}\n\nvoid xonar_disable_output(struct oxygen *chip)\n{\n\tstruct xonar_generic *data = chip->model_data;\n\n\toxygen_clear_bits16(chip, OXYGEN_GPIO_DATA, data->output_enable_bit);\n}\n\nstatic void xonar_ext_power_gpio_changed(struct oxygen *chip)\n{\n\tstruct xonar_generic *data = chip->model_data;\n\tu8 has_power;\n\n\thas_power = !!(oxygen_read8(chip, data->ext_power_reg)\n\t\t       & data->ext_power_bit);\n\tif (has_power != data->has_power) {\n\t\tdata->has_power = has_power;\n\t\tif (has_power) {\n\t\t\tdev_notice(chip->card->dev, \"power restored\\n\");\n\t\t} else {\n\t\t\tdev_crit(chip->card->dev,\n\t\t\t\t   \"Hey! Don't unplug the power cable!\\n\");\n\t\t\t \n\t\t}\n\t}\n}\n\nvoid xonar_init_ext_power(struct oxygen *chip)\n{\n\tstruct xonar_generic *data = chip->model_data;\n\n\toxygen_set_bits8(chip, data->ext_power_int_reg,\n\t\t\t data->ext_power_bit);\n\tchip->interrupt_mask |= OXYGEN_INT_GPIO;\n\tchip->model.gpio_changed = xonar_ext_power_gpio_changed;\n\tdata->has_power = !!(oxygen_read8(chip, data->ext_power_reg)\n\t\t\t     & data->ext_power_bit);\n}\n\nvoid xonar_init_cs53x1(struct oxygen *chip)\n{\n\toxygen_set_bits16(chip, OXYGEN_GPIO_CONTROL, GPIO_CS53x1_M_MASK);\n\toxygen_write16_masked(chip, OXYGEN_GPIO_DATA,\n\t\t\t      GPIO_CS53x1_M_SINGLE, GPIO_CS53x1_M_MASK);\n}\n\nvoid xonar_set_cs53x1_params(struct oxygen *chip,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tunsigned int value;\n\n\tif (params_rate(params) <= 54000)\n\t\tvalue = GPIO_CS53x1_M_SINGLE;\n\telse if (params_rate(params) <= 108000)\n\t\tvalue = GPIO_CS53x1_M_DOUBLE;\n\telse\n\t\tvalue = GPIO_CS53x1_M_QUAD;\n\toxygen_write16_masked(chip, OXYGEN_GPIO_DATA,\n\t\t\t      value, GPIO_CS53x1_M_MASK);\n}\n\nint xonar_gpio_bit_switch_get(struct snd_kcontrol *ctl,\n\t\t\t      struct snd_ctl_elem_value *value)\n{\n\tstruct oxygen *chip = ctl->private_data;\n\tu16 bit = ctl->private_value;\n\tbool invert = ctl->private_value & XONAR_GPIO_BIT_INVERT;\n\n\tvalue->value.integer.value[0] =\n\t\t!!(oxygen_read16(chip, OXYGEN_GPIO_DATA) & bit) ^ invert;\n\treturn 0;\n}\n\nint xonar_gpio_bit_switch_put(struct snd_kcontrol *ctl,\n\t\t\t      struct snd_ctl_elem_value *value)\n{\n\tstruct oxygen *chip = ctl->private_data;\n\tu16 bit = ctl->private_value;\n\tbool invert = ctl->private_value & XONAR_GPIO_BIT_INVERT;\n\tu16 old_bits, new_bits;\n\tint changed;\n\n\tspin_lock_irq(&chip->reg_lock);\n\told_bits = oxygen_read16(chip, OXYGEN_GPIO_DATA);\n\tif (!!value->value.integer.value[0] ^ invert)\n\t\tnew_bits = old_bits | bit;\n\telse\n\t\tnew_bits = old_bits & ~bit;\n\tchanged = new_bits != old_bits;\n\tif (changed)\n\t\toxygen_write16(chip, OXYGEN_GPIO_DATA, new_bits);\n\tspin_unlock_irq(&chip->reg_lock);\n\treturn changed;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}