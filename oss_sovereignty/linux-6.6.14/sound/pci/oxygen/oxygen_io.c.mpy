{
  "module_name": "oxygen_io.c",
  "hash_id": "2728d0af72e7b8f1f3a890c404bdb5e97439ad4baaf312e7317dd170806aec86",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/oxygen/oxygen_io.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/sched.h>\n#include <linux/export.h>\n#include <linux/io.h>\n#include <sound/core.h>\n#include <sound/mpu401.h>\n#include \"oxygen.h\"\n\nu8 oxygen_read8(struct oxygen *chip, unsigned int reg)\n{\n\treturn inb(chip->addr + reg);\n}\nEXPORT_SYMBOL(oxygen_read8);\n\nu16 oxygen_read16(struct oxygen *chip, unsigned int reg)\n{\n\treturn inw(chip->addr + reg);\n}\nEXPORT_SYMBOL(oxygen_read16);\n\nu32 oxygen_read32(struct oxygen *chip, unsigned int reg)\n{\n\treturn inl(chip->addr + reg);\n}\nEXPORT_SYMBOL(oxygen_read32);\n\nvoid oxygen_write8(struct oxygen *chip, unsigned int reg, u8 value)\n{\n\toutb(value, chip->addr + reg);\n\tchip->saved_registers._8[reg] = value;\n}\nEXPORT_SYMBOL(oxygen_write8);\n\nvoid oxygen_write16(struct oxygen *chip, unsigned int reg, u16 value)\n{\n\toutw(value, chip->addr + reg);\n\tchip->saved_registers._16[reg / 2] = cpu_to_le16(value);\n}\nEXPORT_SYMBOL(oxygen_write16);\n\nvoid oxygen_write32(struct oxygen *chip, unsigned int reg, u32 value)\n{\n\toutl(value, chip->addr + reg);\n\tchip->saved_registers._32[reg / 4] = cpu_to_le32(value);\n}\nEXPORT_SYMBOL(oxygen_write32);\n\nvoid oxygen_write8_masked(struct oxygen *chip, unsigned int reg,\n\t\t\t  u8 value, u8 mask)\n{\n\tu8 tmp = inb(chip->addr + reg);\n\ttmp &= ~mask;\n\ttmp |= value & mask;\n\toutb(tmp, chip->addr + reg);\n\tchip->saved_registers._8[reg] = tmp;\n}\nEXPORT_SYMBOL(oxygen_write8_masked);\n\nvoid oxygen_write16_masked(struct oxygen *chip, unsigned int reg,\n\t\t\t   u16 value, u16 mask)\n{\n\tu16 tmp = inw(chip->addr + reg);\n\ttmp &= ~mask;\n\ttmp |= value & mask;\n\toutw(tmp, chip->addr + reg);\n\tchip->saved_registers._16[reg / 2] = cpu_to_le16(tmp);\n}\nEXPORT_SYMBOL(oxygen_write16_masked);\n\nvoid oxygen_write32_masked(struct oxygen *chip, unsigned int reg,\n\t\t\t   u32 value, u32 mask)\n{\n\tu32 tmp = inl(chip->addr + reg);\n\ttmp &= ~mask;\n\ttmp |= value & mask;\n\toutl(tmp, chip->addr + reg);\n\tchip->saved_registers._32[reg / 4] = cpu_to_le32(tmp);\n}\nEXPORT_SYMBOL(oxygen_write32_masked);\n\nstatic int oxygen_ac97_wait(struct oxygen *chip, unsigned int mask)\n{\n\tu8 status = 0;\n\n\t \n\twait_event_timeout(chip->ac97_waitqueue,\n\t\t\t   ({ status |= oxygen_read8(chip, OXYGEN_AC97_INTERRUPT_STATUS);\n\t\t\t      status & mask; }),\n\t\t\t   msecs_to_jiffies(1) + 1);\n\t \n\tstatus |= oxygen_read8(chip, OXYGEN_AC97_INTERRUPT_STATUS);\n\treturn status & mask ? 0 : -EIO;\n}\n\n \n\nvoid oxygen_write_ac97(struct oxygen *chip, unsigned int codec,\n\t\t       unsigned int index, u16 data)\n{\n\tunsigned int count, succeeded;\n\tu32 reg;\n\n\treg = data;\n\treg |= index << OXYGEN_AC97_REG_ADDR_SHIFT;\n\treg |= OXYGEN_AC97_REG_DIR_WRITE;\n\treg |= codec << OXYGEN_AC97_REG_CODEC_SHIFT;\n\tsucceeded = 0;\n\tfor (count = 5; count > 0; --count) {\n\t\tudelay(5);\n\t\toxygen_write32(chip, OXYGEN_AC97_REGS, reg);\n\t\t \n\t\tif (oxygen_ac97_wait(chip, OXYGEN_AC97_INT_WRITE_DONE) >= 0 &&\n\t\t    ++succeeded >= 2) {\n\t\t\tchip->saved_ac97_registers[codec][index / 2] = data;\n\t\t\treturn;\n\t\t}\n\t}\n\tdev_err(chip->card->dev, \"AC'97 write timeout\\n\");\n}\nEXPORT_SYMBOL(oxygen_write_ac97);\n\nu16 oxygen_read_ac97(struct oxygen *chip, unsigned int codec,\n\t\t     unsigned int index)\n{\n\tunsigned int count;\n\tunsigned int last_read = UINT_MAX;\n\tu32 reg;\n\n\treg = index << OXYGEN_AC97_REG_ADDR_SHIFT;\n\treg |= OXYGEN_AC97_REG_DIR_READ;\n\treg |= codec << OXYGEN_AC97_REG_CODEC_SHIFT;\n\tfor (count = 5; count > 0; --count) {\n\t\tudelay(5);\n\t\toxygen_write32(chip, OXYGEN_AC97_REGS, reg);\n\t\tudelay(10);\n\t\tif (oxygen_ac97_wait(chip, OXYGEN_AC97_INT_READ_DONE) >= 0) {\n\t\t\tu16 value = oxygen_read16(chip, OXYGEN_AC97_REGS);\n\t\t\t \n\t\t\tif (value == last_read)\n\t\t\t\treturn value;\n\t\t\tlast_read = value;\n\t\t\t \n\t\t\treg ^= 0xffff;\n\t\t}\n\t}\n\tdev_err(chip->card->dev, \"AC'97 read timeout on codec %u\\n\", codec);\n\treturn 0;\n}\nEXPORT_SYMBOL(oxygen_read_ac97);\n\nvoid oxygen_write_ac97_masked(struct oxygen *chip, unsigned int codec,\n\t\t\t      unsigned int index, u16 data, u16 mask)\n{\n\tu16 value = oxygen_read_ac97(chip, codec, index);\n\tvalue &= ~mask;\n\tvalue |= data & mask;\n\toxygen_write_ac97(chip, codec, index, value);\n}\nEXPORT_SYMBOL(oxygen_write_ac97_masked);\n\nstatic int oxygen_wait_spi(struct oxygen *chip)\n{\n\tunsigned int count;\n\n\t \n\tfor (count = 50; count > 0; count--) {\n\t\tudelay(4);\n\t\tif ((oxygen_read8(chip, OXYGEN_SPI_CONTROL) &\n\t\t\t\t\t\tOXYGEN_SPI_BUSY) == 0)\n\t\t\treturn 0;\n\t}\n\tdev_err(chip->card->dev, \"oxygen: SPI wait timeout\\n\");\n\treturn -EIO;\n}\n\nint oxygen_write_spi(struct oxygen *chip, u8 control, unsigned int data)\n{\n\t \n\toxygen_write8(chip, OXYGEN_SPI_DATA1, data);\n\toxygen_write8(chip, OXYGEN_SPI_DATA2, data >> 8);\n\tif (control & OXYGEN_SPI_DATA_LENGTH_3)\n\t\toxygen_write8(chip, OXYGEN_SPI_DATA3, data >> 16);\n\toxygen_write8(chip, OXYGEN_SPI_CONTROL, control);\n\treturn oxygen_wait_spi(chip);\n}\nEXPORT_SYMBOL(oxygen_write_spi);\n\nvoid oxygen_write_i2c(struct oxygen *chip, u8 device, u8 map, u8 data)\n{\n\t \n\tmsleep(1);\n\n\toxygen_write8(chip, OXYGEN_2WIRE_MAP, map);\n\toxygen_write8(chip, OXYGEN_2WIRE_DATA, data);\n\toxygen_write8(chip, OXYGEN_2WIRE_CONTROL,\n\t\t      device | OXYGEN_2WIRE_DIR_WRITE);\n}\nEXPORT_SYMBOL(oxygen_write_i2c);\n\nstatic void _write_uart(struct oxygen *chip, unsigned int port, u8 data)\n{\n\tif (oxygen_read8(chip, OXYGEN_MPU401 + 1) & MPU401_TX_FULL)\n\t\tmsleep(1);\n\toxygen_write8(chip, OXYGEN_MPU401 + port, data);\n}\n\nvoid oxygen_reset_uart(struct oxygen *chip)\n{\n\t_write_uart(chip, 1, MPU401_RESET);\n\tmsleep(1);  \n\t_write_uart(chip, 1, MPU401_ENTER_UART);\n}\nEXPORT_SYMBOL(oxygen_reset_uart);\n\nvoid oxygen_write_uart(struct oxygen *chip, u8 data)\n{\n\t_write_uart(chip, 0, data);\n}\nEXPORT_SYMBOL(oxygen_write_uart);\n\nu16 oxygen_read_eeprom(struct oxygen *chip, unsigned int index)\n{\n\tunsigned int timeout;\n\n\toxygen_write8(chip, OXYGEN_EEPROM_CONTROL,\n\t\t      index | OXYGEN_EEPROM_DIR_READ);\n\tfor (timeout = 0; timeout < 100; ++timeout) {\n\t\tudelay(1);\n\t\tif (!(oxygen_read8(chip, OXYGEN_EEPROM_STATUS)\n\t\t      & OXYGEN_EEPROM_BUSY))\n\t\t\tbreak;\n\t}\n\treturn oxygen_read16(chip, OXYGEN_EEPROM_DATA);\n}\n\nvoid oxygen_write_eeprom(struct oxygen *chip, unsigned int index, u16 value)\n{\n\tunsigned int timeout;\n\n\toxygen_write16(chip, OXYGEN_EEPROM_DATA, value);\n\toxygen_write8(chip, OXYGEN_EEPROM_CONTROL,\n\t\t      index | OXYGEN_EEPROM_DIR_WRITE);\n\tfor (timeout = 0; timeout < 10; ++timeout) {\n\t\tmsleep(1);\n\t\tif (!(oxygen_read8(chip, OXYGEN_EEPROM_STATUS)\n\t\t      & OXYGEN_EEPROM_BUSY))\n\t\t\treturn;\n\t}\n\tdev_err(chip->card->dev, \"EEPROM write timeout\\n\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}