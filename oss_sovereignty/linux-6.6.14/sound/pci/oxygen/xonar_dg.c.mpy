{
  "module_name": "xonar_dg.c",
  "hash_id": "b6760235f053015a633811c9a35d4614e4947e7d1c4e1bda67e34047c431496f",
  "original_prompt": "Ingested from linux-6.6.14/sound/pci/oxygen/xonar_dg.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/pci.h>\n#include <linux/delay.h>\n#include <sound/control.h>\n#include <sound/core.h>\n#include <sound/info.h>\n#include <sound/pcm.h>\n#include <sound/tlv.h>\n#include \"oxygen.h\"\n#include \"xonar_dg.h\"\n#include \"cs4245.h\"\n\nint cs4245_write_spi(struct oxygen *chip, u8 reg)\n{\n\tstruct dg *data = chip->model_data;\n\tunsigned int packet;\n\n\tpacket = reg << 8;\n\tpacket |= (CS4245_SPI_ADDRESS | CS4245_SPI_WRITE) << 16;\n\tpacket |= data->cs4245_shadow[reg];\n\n\treturn oxygen_write_spi(chip, OXYGEN_SPI_TRIGGER |\n\t\t\t\tOXYGEN_SPI_DATA_LENGTH_3 |\n\t\t\t\tOXYGEN_SPI_CLOCK_1280 |\n\t\t\t\t(0 << OXYGEN_SPI_CODEC_SHIFT) |\n\t\t\t\tOXYGEN_SPI_CEN_LATCH_CLOCK_HI,\n\t\t\t\tpacket);\n}\n\nint cs4245_read_spi(struct oxygen *chip, u8 addr)\n{\n\tstruct dg *data = chip->model_data;\n\tint ret;\n\n\tret = oxygen_write_spi(chip, OXYGEN_SPI_TRIGGER |\n\t\tOXYGEN_SPI_DATA_LENGTH_2 |\n\t\tOXYGEN_SPI_CEN_LATCH_CLOCK_HI |\n\t\tOXYGEN_SPI_CLOCK_1280 | (0 << OXYGEN_SPI_CODEC_SHIFT),\n\t\t((CS4245_SPI_ADDRESS | CS4245_SPI_WRITE) << 8) | addr);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = oxygen_write_spi(chip, OXYGEN_SPI_TRIGGER |\n\t\tOXYGEN_SPI_DATA_LENGTH_2 |\n\t\tOXYGEN_SPI_CEN_LATCH_CLOCK_HI |\n\t\tOXYGEN_SPI_CLOCK_1280 | (0 << OXYGEN_SPI_CODEC_SHIFT),\n\t\t(CS4245_SPI_ADDRESS | CS4245_SPI_READ) << 8);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata->cs4245_shadow[addr] = oxygen_read8(chip, OXYGEN_SPI_DATA1);\n\n\treturn 0;\n}\n\nint cs4245_shadow_control(struct oxygen *chip, enum cs4245_shadow_operation op)\n{\n\tstruct dg *data = chip->model_data;\n\tunsigned char addr;\n\tint ret;\n\n\tfor (addr = 1; addr < ARRAY_SIZE(data->cs4245_shadow); addr++) {\n\t\tret = (op == CS4245_SAVE_TO_SHADOW ?\n\t\t\tcs4245_read_spi(chip, addr) :\n\t\t\tcs4245_write_spi(chip, addr));\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic void cs4245_init(struct oxygen *chip)\n{\n\tstruct dg *data = chip->model_data;\n\n\t \n\tcs4245_shadow_control(chip, CS4245_SAVE_TO_SHADOW);\n\n\t \n\tdata->cs4245_shadow[CS4245_POWER_CTRL] = 0;\n\tdata->cs4245_shadow[CS4245_SIGNAL_SEL] =\n\t\tCS4245_A_OUT_SEL_DAC | CS4245_ASYNCH;\n\tdata->cs4245_shadow[CS4245_DAC_CTRL_1] =\n\t\tCS4245_DAC_FM_SINGLE | CS4245_DAC_DIF_LJUST;\n\tdata->cs4245_shadow[CS4245_DAC_CTRL_2] =\n\t\tCS4245_DAC_SOFT | CS4245_DAC_ZERO | CS4245_INVERT_DAC;\n\tdata->cs4245_shadow[CS4245_ADC_CTRL] =\n\t\tCS4245_ADC_FM_SINGLE | CS4245_ADC_DIF_LJUST;\n\tdata->cs4245_shadow[CS4245_ANALOG_IN] =\n\t\tCS4245_PGA_SOFT | CS4245_PGA_ZERO;\n\tdata->cs4245_shadow[CS4245_PGA_B_CTRL] = 0;\n\tdata->cs4245_shadow[CS4245_PGA_A_CTRL] = 0;\n\tdata->cs4245_shadow[CS4245_DAC_A_CTRL] = 8;\n\tdata->cs4245_shadow[CS4245_DAC_B_CTRL] = 8;\n\n\tcs4245_shadow_control(chip, CS4245_LOAD_FROM_SHADOW);\n\tsnd_component_add(chip->card, \"CS4245\");\n}\n\nvoid dg_init(struct oxygen *chip)\n{\n\tstruct dg *data = chip->model_data;\n\n\tdata->output_sel = PLAYBACK_DST_HP_FP;\n\tdata->input_sel = CAPTURE_SRC_MIC;\n\n\tcs4245_init(chip);\n\toxygen_write16(chip, OXYGEN_GPIO_CONTROL,\n\t\t       GPIO_OUTPUT_ENABLE | GPIO_HP_REAR | GPIO_INPUT_ROUTE);\n\t \n\tmsleep(2500);\n\toxygen_write16(chip, OXYGEN_GPIO_DATA,\n\t\t       GPIO_OUTPUT_ENABLE | GPIO_INPUT_ROUTE);\n}\n\nvoid dg_cleanup(struct oxygen *chip)\n{\n\toxygen_clear_bits16(chip, OXYGEN_GPIO_DATA, GPIO_OUTPUT_ENABLE);\n}\n\nvoid dg_suspend(struct oxygen *chip)\n{\n\tdg_cleanup(chip);\n}\n\nvoid dg_resume(struct oxygen *chip)\n{\n\tcs4245_shadow_control(chip, CS4245_LOAD_FROM_SHADOW);\n\tmsleep(2500);\n\toxygen_set_bits16(chip, OXYGEN_GPIO_DATA, GPIO_OUTPUT_ENABLE);\n}\n\nvoid set_cs4245_dac_params(struct oxygen *chip,\n\t\t\t\t  struct snd_pcm_hw_params *params)\n{\n\tstruct dg *data = chip->model_data;\n\tunsigned char dac_ctrl;\n\tunsigned char mclk_freq;\n\n\tdac_ctrl = data->cs4245_shadow[CS4245_DAC_CTRL_1] & ~CS4245_DAC_FM_MASK;\n\tmclk_freq = data->cs4245_shadow[CS4245_MCLK_FREQ] & ~CS4245_MCLK1_MASK;\n\tif (params_rate(params) <= 50000) {\n\t\tdac_ctrl |= CS4245_DAC_FM_SINGLE;\n\t\tmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK1_SHIFT;\n\t} else if (params_rate(params) <= 100000) {\n\t\tdac_ctrl |= CS4245_DAC_FM_DOUBLE;\n\t\tmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK1_SHIFT;\n\t} else {\n\t\tdac_ctrl |= CS4245_DAC_FM_QUAD;\n\t\tmclk_freq |= CS4245_MCLK_2 << CS4245_MCLK1_SHIFT;\n\t}\n\tdata->cs4245_shadow[CS4245_DAC_CTRL_1] = dac_ctrl;\n\tdata->cs4245_shadow[CS4245_MCLK_FREQ] = mclk_freq;\n\tcs4245_write_spi(chip, CS4245_DAC_CTRL_1);\n\tcs4245_write_spi(chip, CS4245_MCLK_FREQ);\n}\n\nvoid set_cs4245_adc_params(struct oxygen *chip,\n\t\t\t\t  struct snd_pcm_hw_params *params)\n{\n\tstruct dg *data = chip->model_data;\n\tunsigned char adc_ctrl;\n\tunsigned char mclk_freq;\n\n\tadc_ctrl = data->cs4245_shadow[CS4245_ADC_CTRL] & ~CS4245_ADC_FM_MASK;\n\tmclk_freq = data->cs4245_shadow[CS4245_MCLK_FREQ] & ~CS4245_MCLK2_MASK;\n\tif (params_rate(params) <= 50000) {\n\t\tadc_ctrl |= CS4245_ADC_FM_SINGLE;\n\t\tmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK2_SHIFT;\n\t} else if (params_rate(params) <= 100000) {\n\t\tadc_ctrl |= CS4245_ADC_FM_DOUBLE;\n\t\tmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK2_SHIFT;\n\t} else {\n\t\tadc_ctrl |= CS4245_ADC_FM_QUAD;\n\t\tmclk_freq |= CS4245_MCLK_2 << CS4245_MCLK2_SHIFT;\n\t}\n\tdata->cs4245_shadow[CS4245_ADC_CTRL] = adc_ctrl;\n\tdata->cs4245_shadow[CS4245_MCLK_FREQ] = mclk_freq;\n\tcs4245_write_spi(chip, CS4245_ADC_CTRL);\n\tcs4245_write_spi(chip, CS4245_MCLK_FREQ);\n}\n\nstatic inline unsigned int shift_bits(unsigned int value,\n\t\t\t\t      unsigned int shift_from,\n\t\t\t\t      unsigned int shift_to,\n\t\t\t\t      unsigned int mask)\n{\n\tif (shift_from < shift_to)\n\t\treturn (value << (shift_to - shift_from)) & mask;\n\telse\n\t\treturn (value >> (shift_from - shift_to)) & mask;\n}\n\nunsigned int adjust_dg_dac_routing(struct oxygen *chip,\n\t\t\t\t\t  unsigned int play_routing)\n{\n\tstruct dg *data = chip->model_data;\n\n\tswitch (data->output_sel) {\n\tcase PLAYBACK_DST_HP:\n\tcase PLAYBACK_DST_HP_FP:\n\t\toxygen_write8_masked(chip, OXYGEN_PLAY_ROUTING,\n\t\t\tOXYGEN_PLAY_MUTE23 | OXYGEN_PLAY_MUTE45 |\n\t\t\tOXYGEN_PLAY_MUTE67, OXYGEN_PLAY_MUTE_MASK);\n\t\tbreak;\n\tcase PLAYBACK_DST_MULTICH:\n\t\toxygen_write8_masked(chip, OXYGEN_PLAY_ROUTING,\n\t\t\tOXYGEN_PLAY_MUTE01, OXYGEN_PLAY_MUTE_MASK);\n\t\tbreak;\n\t}\n\treturn (play_routing & OXYGEN_PLAY_DAC0_SOURCE_MASK) |\n\t       shift_bits(play_routing,\n\t\t\t  OXYGEN_PLAY_DAC2_SOURCE_SHIFT,\n\t\t\t  OXYGEN_PLAY_DAC1_SOURCE_SHIFT,\n\t\t\t  OXYGEN_PLAY_DAC1_SOURCE_MASK) |\n\t       shift_bits(play_routing,\n\t\t\t  OXYGEN_PLAY_DAC1_SOURCE_SHIFT,\n\t\t\t  OXYGEN_PLAY_DAC2_SOURCE_SHIFT,\n\t\t\t  OXYGEN_PLAY_DAC2_SOURCE_MASK) |\n\t       shift_bits(play_routing,\n\t\t\t  OXYGEN_PLAY_DAC0_SOURCE_SHIFT,\n\t\t\t  OXYGEN_PLAY_DAC3_SOURCE_SHIFT,\n\t\t\t  OXYGEN_PLAY_DAC3_SOURCE_MASK);\n}\n\nvoid dump_cs4245_registers(struct oxygen *chip,\n\t\t\t\t  struct snd_info_buffer *buffer)\n{\n\tstruct dg *data = chip->model_data;\n\tunsigned int addr;\n\n\tsnd_iprintf(buffer, \"\\nCS4245:\");\n\tcs4245_read_spi(chip, CS4245_INT_STATUS);\n\tfor (addr = 1; addr < ARRAY_SIZE(data->cs4245_shadow); addr++)\n\t\tsnd_iprintf(buffer, \" %02x\", data->cs4245_shadow[addr]);\n\tsnd_iprintf(buffer, \"\\n\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}