{
  "module_name": "hdac_i915.c",
  "hash_id": "1e539a9f034fc84fcaa473000e78bff8e2f4b8cd13d58064dbefeb0dfa675a95",
  "original_prompt": "Ingested from linux-6.6.14/sound/hda/hdac_i915.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <sound/core.h>\n#include <sound/hdaudio.h>\n#include <sound/hda_i915.h>\n#include <sound/hda_register.h>\n\n \nvoid snd_hdac_i915_set_bclk(struct hdac_bus *bus)\n{\n\tstruct drm_audio_component *acomp = bus->audio_component;\n\tstruct pci_dev *pci = to_pci_dev(bus->dev);\n\tint cdclk_freq;\n\tunsigned int bclk_m, bclk_n;\n\n\tif (!acomp || !acomp->ops || !acomp->ops->get_cdclk_freq)\n\t\treturn;  \n\tif (!HDA_CONTROLLER_IS_HSW(pci))\n\t\treturn;  \n\n\tcdclk_freq = acomp->ops->get_cdclk_freq(acomp->dev);\n\tswitch (cdclk_freq) {\n\tcase 337500:\n\t\tbclk_m = 16;\n\t\tbclk_n = 225;\n\t\tbreak;\n\n\tcase 450000:\n\tdefault:  \n\t\tbclk_m = 4;\n\t\tbclk_n = 75;\n\t\tbreak;\n\n\tcase 540000:\n\t\tbclk_m = 4;\n\t\tbclk_n = 90;\n\t\tbreak;\n\n\tcase 675000:\n\t\tbclk_m = 8;\n\t\tbclk_n = 225;\n\t\tbreak;\n\t}\n\n\tsnd_hdac_chip_writew(bus, HSW_EM4, bclk_m);\n\tsnd_hdac_chip_writew(bus, HSW_EM5, bclk_n);\n}\nEXPORT_SYMBOL_GPL(snd_hdac_i915_set_bclk);\n\n \nstatic bool connectivity_check(struct pci_dev *i915, struct pci_dev *hdac)\n{\n\tstruct pci_bus *bus_a = i915->bus, *bus_b = hdac->bus;\n\n\t \n\tif (bus_a == bus_b)\n\t\treturn true;\n\n\tbus_a = bus_a->parent;\n\tbus_b = bus_b->parent;\n\n\t \n\tif (bus_a == bus_b)\n\t\treturn true;\n\n\tif (!bus_a || !bus_b)\n\t\treturn false;\n\n\t \n\tbus_a = bus_a->parent;\n\tbus_b = bus_b->parent;\n\tif (bus_a && bus_a == bus_b)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic int i915_component_master_match(struct device *dev, int subcomponent,\n\t\t\t\t       void *data)\n{\n\tstruct pci_dev *hdac_pci, *i915_pci;\n\tstruct hdac_bus *bus = data;\n\n\tif (!dev_is_pci(dev))\n\t\treturn 0;\n\n\thdac_pci = to_pci_dev(bus->dev);\n\ti915_pci = to_pci_dev(dev);\n\n\tif (!strcmp(dev->driver->name, \"i915\") &&\n\t    subcomponent == I915_COMPONENT_AUDIO &&\n\t    connectivity_check(i915_pci, hdac_pci))\n\t\treturn 1;\n\n\treturn 0;\n}\n\n \nstatic int i915_gfx_present(struct pci_dev *hdac_pci)\n{\n\tstruct pci_dev *display_dev = NULL;\n\n\tfor_each_pci_dev(display_dev) {\n\t\tif (display_dev->vendor == PCI_VENDOR_ID_INTEL &&\n\t\t    (display_dev->class >> 16) == PCI_BASE_CLASS_DISPLAY &&\n\t\t    connectivity_check(display_dev, hdac_pci)) {\n\t\t\tpci_dev_put(display_dev);\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n \nint snd_hdac_i915_init(struct hdac_bus *bus)\n{\n\tstruct drm_audio_component *acomp;\n\tint err;\n\n\tif (!i915_gfx_present(to_pci_dev(bus->dev)))\n\t\treturn -ENODEV;\n\n\terr = snd_hdac_acomp_init(bus, NULL,\n\t\t\t\t  i915_component_master_match,\n\t\t\t\t  sizeof(struct i915_audio_component) - sizeof(*acomp));\n\tif (err < 0)\n\t\treturn err;\n\tacomp = bus->audio_component;\n\tif (!acomp)\n\t\treturn -ENODEV;\n\tif (!acomp->ops) {\n\t\tif (!IS_ENABLED(CONFIG_MODULES) ||\n\t\t    !request_module(\"i915\")) {\n\t\t\t \n\t\t\twait_for_completion_killable_timeout(&acomp->master_bind_complete,\n\t\t\t\t\t\t\t     msecs_to_jiffies(60 * 1000));\n\t\t}\n\t}\n\tif (!acomp->ops) {\n\t\tdev_info(bus->dev, \"couldn't bind with audio component\\n\");\n\t\tsnd_hdac_acomp_exit(bus);\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(snd_hdac_i915_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}