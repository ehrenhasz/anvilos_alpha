{
  "module_name": "hdac_ext_stream.c",
  "hash_id": "e233f73152576d1c90fd09564111ffc324442c9225d88ac2eaade1fe353cee20",
  "original_prompt": "Ingested from linux-6.6.14/sound/hda/ext/hdac_ext_stream.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <sound/pcm.h>\n#include <sound/hda_register.h>\n#include <sound/hdaudio_ext.h>\n#include <sound/compress_driver.h>\n\n \nstatic void snd_hdac_ext_stream_init(struct hdac_bus *bus,\n\t\t\t\t     struct hdac_ext_stream *hext_stream,\n\t\t\t\t     int idx, int direction, int tag)\n{\n\tif (bus->ppcap) {\n\t\thext_stream->pphc_addr = bus->ppcap + AZX_PPHC_BASE +\n\t\t\t\tAZX_PPHC_INTERVAL * idx;\n\n\t\thext_stream->pplc_addr = bus->ppcap + AZX_PPLC_BASE +\n\t\t\t\tAZX_PPLC_MULTI * bus->num_streams +\n\t\t\t\tAZX_PPLC_INTERVAL * idx;\n\t}\n\n\thext_stream->decoupled = false;\n\tsnd_hdac_stream_init(bus, &hext_stream->hstream, idx, direction, tag);\n}\n\n \nint snd_hdac_ext_stream_init_all(struct hdac_bus *bus, int start_idx,\n\t\t\t\t int num_stream, int dir)\n{\n\tint stream_tag = 0;\n\tint i, tag, idx = start_idx;\n\n\tfor (i = 0; i < num_stream; i++) {\n\t\tstruct hdac_ext_stream *hext_stream =\n\t\t\t\tkzalloc(sizeof(*hext_stream), GFP_KERNEL);\n\t\tif (!hext_stream)\n\t\t\treturn -ENOMEM;\n\t\ttag = ++stream_tag;\n\t\tsnd_hdac_ext_stream_init(bus, hext_stream, idx, dir, tag);\n\t\tidx++;\n\t}\n\n\treturn 0;\n\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_init_all);\n\n \nvoid snd_hdac_ext_stream_free_all(struct hdac_bus *bus)\n{\n\tstruct hdac_stream *s, *_s;\n\tstruct hdac_ext_stream *hext_stream;\n\n\tlist_for_each_entry_safe(s, _s, &bus->stream_list, list) {\n\t\thext_stream = stream_to_hdac_ext_stream(s);\n\t\tsnd_hdac_ext_stream_decouple(bus, hext_stream, false);\n\t\tlist_del(&s->list);\n\t\tkfree(hext_stream);\n\t}\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_free_all);\n\nvoid snd_hdac_ext_stream_decouple_locked(struct hdac_bus *bus,\n\t\t\t\t\t struct hdac_ext_stream *hext_stream,\n\t\t\t\t\t bool decouple)\n{\n\tstruct hdac_stream *hstream = &hext_stream->hstream;\n\tu32 val;\n\tint mask = AZX_PPCTL_PROCEN(hstream->index);\n\n\tval = readw(bus->ppcap + AZX_REG_PP_PPCTL) & mask;\n\n\tif (decouple && !val)\n\t\tsnd_hdac_updatel(bus->ppcap, AZX_REG_PP_PPCTL, mask, mask);\n\telse if (!decouple && val)\n\t\tsnd_hdac_updatel(bus->ppcap, AZX_REG_PP_PPCTL, mask, 0);\n\n\thext_stream->decoupled = decouple;\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_decouple_locked);\n\n \nvoid snd_hdac_ext_stream_decouple(struct hdac_bus *bus,\n\t\t\t\t  struct hdac_ext_stream *hext_stream, bool decouple)\n{\n\tspin_lock_irq(&bus->reg_lock);\n\tsnd_hdac_ext_stream_decouple_locked(bus, hext_stream, decouple);\n\tspin_unlock_irq(&bus->reg_lock);\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_decouple);\n\n \nvoid snd_hdac_ext_stream_start(struct hdac_ext_stream *hext_stream)\n{\n\tsnd_hdac_updatel(hext_stream->pplc_addr, AZX_REG_PPLCCTL,\n\t\t\t AZX_PPLCCTL_RUN, AZX_PPLCCTL_RUN);\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_start);\n\n \nvoid snd_hdac_ext_stream_clear(struct hdac_ext_stream *hext_stream)\n{\n\tsnd_hdac_updatel(hext_stream->pplc_addr, AZX_REG_PPLCCTL, AZX_PPLCCTL_RUN, 0);\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_clear);\n\n \nvoid snd_hdac_ext_stream_reset(struct hdac_ext_stream *hext_stream)\n{\n\tunsigned char val;\n\tint timeout;\n\n\tsnd_hdac_ext_stream_clear(hext_stream);\n\n\tsnd_hdac_updatel(hext_stream->pplc_addr, AZX_REG_PPLCCTL,\n\t\t\t AZX_PPLCCTL_STRST, AZX_PPLCCTL_STRST);\n\tudelay(3);\n\ttimeout = 50;\n\tdo {\n\t\tval = readl(hext_stream->pplc_addr + AZX_REG_PPLCCTL) &\n\t\t\t\tAZX_PPLCCTL_STRST;\n\t\tif (val)\n\t\t\tbreak;\n\t\tudelay(3);\n\t} while (--timeout);\n\tval &= ~AZX_PPLCCTL_STRST;\n\twritel(val, hext_stream->pplc_addr + AZX_REG_PPLCCTL);\n\tudelay(3);\n\n\ttimeout = 50;\n\t \n\tdo {\n\t\tval = readl(hext_stream->pplc_addr + AZX_REG_PPLCCTL) & AZX_PPLCCTL_STRST;\n\t\tif (!val)\n\t\t\tbreak;\n\t\tudelay(3);\n\t} while (--timeout);\n\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_reset);\n\n \nint snd_hdac_ext_stream_setup(struct hdac_ext_stream *hext_stream, int fmt)\n{\n\tstruct hdac_stream *hstream = &hext_stream->hstream;\n\tunsigned int val;\n\n\t \n\tsnd_hdac_ext_stream_clear(hext_stream);\n\t \n\tval = readl(hext_stream->pplc_addr + AZX_REG_PPLCCTL);\n\tval = (val & ~AZX_PPLCCTL_STRM_MASK) |\n\t\t(hstream->stream_tag << AZX_PPLCCTL_STRM_SHIFT);\n\twritel(val, hext_stream->pplc_addr + AZX_REG_PPLCCTL);\n\n\t \n\twritew(fmt, hext_stream->pplc_addr + AZX_REG_PPLCFMT);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_setup);\n\nstatic struct hdac_ext_stream *\nhdac_ext_link_dma_stream_assign(struct hdac_bus *bus,\n\t\t\t\tstruct snd_pcm_substream *substream)\n{\n\tstruct hdac_ext_stream *res = NULL;\n\tstruct hdac_stream *hstream = NULL;\n\n\tif (!bus->ppcap) {\n\t\tdev_err(bus->dev, \"stream type not supported\\n\");\n\t\treturn NULL;\n\t}\n\n\tspin_lock_irq(&bus->reg_lock);\n\tlist_for_each_entry(hstream, &bus->stream_list, list) {\n\t\tstruct hdac_ext_stream *hext_stream = container_of(hstream,\n\t\t\t\t\t\t\t\t struct hdac_ext_stream,\n\t\t\t\t\t\t\t\t hstream);\n\t\tif (hstream->direction != substream->stream)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (!hext_stream->link_locked) {\n\t\t\tres = hext_stream;\n\t\t\tbreak;\n\t\t}\n\n\t}\n\tif (res) {\n\t\tsnd_hdac_ext_stream_decouple_locked(bus, res, true);\n\t\tres->link_locked = 1;\n\t\tres->link_substream = substream;\n\t}\n\tspin_unlock_irq(&bus->reg_lock);\n\treturn res;\n}\n\nstatic struct hdac_ext_stream *\nhdac_ext_host_dma_stream_assign(struct hdac_bus *bus,\n\t\t\t\tstruct snd_pcm_substream *substream)\n{\n\tstruct hdac_ext_stream *res = NULL;\n\tstruct hdac_stream *hstream = NULL;\n\n\tif (!bus->ppcap) {\n\t\tdev_err(bus->dev, \"stream type not supported\\n\");\n\t\treturn NULL;\n\t}\n\n\tspin_lock_irq(&bus->reg_lock);\n\tlist_for_each_entry(hstream, &bus->stream_list, list) {\n\t\tstruct hdac_ext_stream *hext_stream = container_of(hstream,\n\t\t\t\t\t\t\t\t struct hdac_ext_stream,\n\t\t\t\t\t\t\t\t hstream);\n\t\tif (hstream->direction != substream->stream)\n\t\t\tcontinue;\n\n\t\tif (!hstream->opened) {\n\t\t\tres = hext_stream;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (res) {\n\t\tsnd_hdac_ext_stream_decouple_locked(bus, res, true);\n\t\tres->hstream.opened = 1;\n\t\tres->hstream.running = 0;\n\t\tres->hstream.substream = substream;\n\t}\n\tspin_unlock_irq(&bus->reg_lock);\n\n\treturn res;\n}\n\n \nstruct hdac_ext_stream *snd_hdac_ext_stream_assign(struct hdac_bus *bus,\n\t\t\t\t\t   struct snd_pcm_substream *substream,\n\t\t\t\t\t   int type)\n{\n\tstruct hdac_ext_stream *hext_stream = NULL;\n\tstruct hdac_stream *hstream = NULL;\n\n\tswitch (type) {\n\tcase HDAC_EXT_STREAM_TYPE_COUPLED:\n\t\thstream = snd_hdac_stream_assign(bus, substream);\n\t\tif (hstream)\n\t\t\thext_stream = container_of(hstream,\n\t\t\t\t\t\t   struct hdac_ext_stream,\n\t\t\t\t\t\t   hstream);\n\t\treturn hext_stream;\n\n\tcase HDAC_EXT_STREAM_TYPE_HOST:\n\t\treturn hdac_ext_host_dma_stream_assign(bus, substream);\n\n\tcase HDAC_EXT_STREAM_TYPE_LINK:\n\t\treturn hdac_ext_link_dma_stream_assign(bus, substream);\n\n\tdefault:\n\t\treturn NULL;\n\t}\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_assign);\n\n \nvoid snd_hdac_ext_stream_release(struct hdac_ext_stream *hext_stream, int type)\n{\n\tstruct hdac_bus *bus = hext_stream->hstream.bus;\n\n\tswitch (type) {\n\tcase HDAC_EXT_STREAM_TYPE_COUPLED:\n\t\tsnd_hdac_stream_release(&hext_stream->hstream);\n\t\tbreak;\n\n\tcase HDAC_EXT_STREAM_TYPE_HOST:\n\t\tspin_lock_irq(&bus->reg_lock);\n\t\t \n\t\tif (!hext_stream->link_locked)\n\t\t\tsnd_hdac_ext_stream_decouple_locked(bus, hext_stream, false);\n\t\tsnd_hdac_stream_release_locked(&hext_stream->hstream);\n\t\tspin_unlock_irq(&bus->reg_lock);\n\t\tbreak;\n\n\tcase HDAC_EXT_STREAM_TYPE_LINK:\n\t\tspin_lock_irq(&bus->reg_lock);\n\t\t \n\t\tif (!hext_stream->hstream.opened)\n\t\t\tsnd_hdac_ext_stream_decouple_locked(bus, hext_stream, false);\n\t\thext_stream->link_locked = 0;\n\t\thext_stream->link_substream = NULL;\n\t\tspin_unlock_irq(&bus->reg_lock);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_dbg(bus->dev, \"Invalid type %d\\n\", type);\n\t}\n\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_stream_release);\n\n \nstruct hdac_ext_stream *snd_hdac_ext_cstream_assign(struct hdac_bus *bus,\n\t\t\t\t\t\t    struct snd_compr_stream *cstream)\n{\n\tstruct hdac_ext_stream *res = NULL;\n\tstruct hdac_stream *hstream;\n\n\tspin_lock_irq(&bus->reg_lock);\n\tlist_for_each_entry(hstream, &bus->stream_list, list) {\n\t\tstruct hdac_ext_stream *hext_stream = stream_to_hdac_ext_stream(hstream);\n\n\t\tif (hstream->direction != cstream->direction)\n\t\t\tcontinue;\n\n\t\tif (!hstream->opened) {\n\t\t\tres = hext_stream;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (res) {\n\t\tsnd_hdac_ext_stream_decouple_locked(bus, res, true);\n\t\tres->hstream.opened = 1;\n\t\tres->hstream.running = 0;\n\t\tres->hstream.cstream = cstream;\n\t}\n\tspin_unlock_irq(&bus->reg_lock);\n\n\treturn res;\n}\nEXPORT_SYMBOL_GPL(snd_hdac_ext_cstream_assign);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}