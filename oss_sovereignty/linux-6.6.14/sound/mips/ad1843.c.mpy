{
  "module_name": "ad1843.c",
  "hash_id": "cffc432c3078915939c8f71967158d7e13a8bbf8c3bc140775373e3d8352f8cb",
  "original_prompt": "Ingested from linux-6.6.14/sound/mips/ad1843.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/sched.h>\n#include <linux/errno.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/ad1843.h>\n\n \n\nstruct ad1843_bitfield {\n\tchar reg;\n\tchar lo_bit;\n\tchar nbits;\n};\n\nstatic const struct ad1843_bitfield\n\tad1843_PDNO   = {  0, 14,  1 },\t \n\tad1843_INIT   = {  0, 15,  1 },\t \n\tad1843_RIG    = {  2,  0,  4 },\t \n\tad1843_RMGE   = {  2,  4,  1 },\t \n\tad1843_RSS    = {  2,  5,  3 },\t \n\tad1843_LIG    = {  2,  8,  4 },\t \n\tad1843_LMGE   = {  2, 12,  1 },\t \n\tad1843_LSS    = {  2, 13,  3 },\t \n\tad1843_RD2M   = {  3,  0,  5 },\t \n\tad1843_RD2MM  = {  3,  7,  1 },\t \n\tad1843_LD2M   = {  3,  8,  5 },\t \n\tad1843_LD2MM  = {  3, 15,  1 },\t \n\tad1843_RX1M   = {  4,  0,  5 },\t \n\tad1843_RX1MM  = {  4,  7,  1 },\t \n\tad1843_LX1M   = {  4,  8,  5 },\t \n\tad1843_LX1MM  = {  4, 15,  1 },\t \n\tad1843_RX2M   = {  5,  0,  5 },\t \n\tad1843_RX2MM  = {  5,  7,  1 },\t \n\tad1843_LX2M   = {  5,  8,  5 },\t \n\tad1843_LX2MM  = {  5, 15,  1 },\t \n\tad1843_RMCM   = {  7,  0,  5 },\t \n\tad1843_RMCMM  = {  7,  7,  1 },\t \n\tad1843_LMCM   = {  7,  8,  5 },\t \n\tad1843_LMCMM  = {  7, 15,  1 },\t \n\tad1843_HPOS   = {  8,  4,  1 },\t \n\tad1843_HPOM   = {  8,  5,  1 },\t \n\tad1843_MPOM   = {  8,  6,  1 },\t \n\tad1843_RDA1G  = {  9,  0,  6 },\t \n\tad1843_RDA1GM = {  9,  7,  1 },\t \n\tad1843_LDA1G  = {  9,  8,  6 },\t \n\tad1843_LDA1GM = {  9, 15,  1 },\t \n\tad1843_RDA2G  = { 10,  0,  6 },\t \n\tad1843_RDA2GM = { 10,  7,  1 },\t \n\tad1843_LDA2G  = { 10,  8,  6 },\t \n\tad1843_LDA2GM = { 10, 15,  1 },\t \n\tad1843_RDA1AM = { 11,  7,  1 },\t \n\tad1843_LDA1AM = { 11, 15,  1 },\t \n\tad1843_RDA2AM = { 12,  7,  1 },\t \n\tad1843_LDA2AM = { 12, 15,  1 },\t \n\tad1843_ADLC   = { 15,  0,  2 },\t \n\tad1843_ADRC   = { 15,  2,  2 },\t \n\tad1843_DA1C   = { 15,  8,  2 },\t \n\tad1843_DA2C   = { 15, 10,  2 },\t \n\tad1843_C1C    = { 17,  0, 16 },\t \n\tad1843_C2C    = { 20,  0, 16 },\t \n\tad1843_C3C    = { 23,  0, 16 },\t \n\tad1843_DAADL  = { 25,  4,  2 },\t \n\tad1843_DAADR  = { 25,  6,  2 },\t \n\tad1843_DAMIX  = { 25, 14,  1 },\t \n\tad1843_DRSFLT = { 25, 15,  1 },\t \n\tad1843_ADLF   = { 26,  0,  2 },  \n\tad1843_ADRF   = { 26,  2,  2 },  \n\tad1843_ADTLK  = { 26,  4,  1 },\t \n\tad1843_SCF    = { 26,  7,  1 },\t \n\tad1843_DA1F   = { 26,  8,  2 },\t \n\tad1843_DA2F   = { 26, 10,  2 },\t \n\tad1843_DA1SM  = { 26, 14,  1 },\t \n\tad1843_DA2SM  = { 26, 15,  1 },\t \n\tad1843_ADLEN  = { 27,  0,  1 },\t \n\tad1843_ADREN  = { 27,  1,  1 },\t \n\tad1843_AAMEN  = { 27,  4,  1 },\t \n\tad1843_ANAEN  = { 27,  7,  1 },\t \n\tad1843_DA1EN  = { 27,  8,  1 },\t \n\tad1843_DA2EN  = { 27,  9,  1 },\t \n\tad1843_DDMEN  = { 27, 12,  1 },\t \n\tad1843_C1EN   = { 28, 11,  1 },\t \n\tad1843_C2EN   = { 28, 12,  1 },\t \n\tad1843_C3EN   = { 28, 13,  1 },\t \n\tad1843_PDNI   = { 28, 15,  1 };\t \n\n \n\nstruct ad1843_gain {\n\tint\tnegative;\t\t \n\tconst struct ad1843_bitfield *lfield;\n\tconst struct ad1843_bitfield *rfield;\n\tconst struct ad1843_bitfield *lmute;\n\tconst struct ad1843_bitfield *rmute;\n};\n\nstatic const struct ad1843_gain ad1843_gain_RECLEV = {\n\t.negative = 0,\n\t.lfield   = &ad1843_LIG,\n\t.rfield   = &ad1843_RIG\n};\nstatic const struct ad1843_gain ad1843_gain_LINE = {\n\t.negative = 1,\n\t.lfield   = &ad1843_LX1M,\n\t.rfield   = &ad1843_RX1M,\n\t.lmute    = &ad1843_LX1MM,\n\t.rmute    = &ad1843_RX1MM\n};\nstatic const struct ad1843_gain ad1843_gain_LINE_2 = {\n\t.negative = 1,\n\t.lfield   = &ad1843_LDA2G,\n\t.rfield   = &ad1843_RDA2G,\n\t.lmute    = &ad1843_LDA2GM,\n\t.rmute    = &ad1843_RDA2GM\n};\nstatic const struct ad1843_gain ad1843_gain_MIC = {\n\t.negative = 1,\n\t.lfield   = &ad1843_LMCM,\n\t.rfield   = &ad1843_RMCM,\n\t.lmute    = &ad1843_LMCMM,\n\t.rmute    = &ad1843_RMCMM\n};\nstatic const struct ad1843_gain ad1843_gain_PCM_0 = {\n\t.negative = 1,\n\t.lfield   = &ad1843_LDA1G,\n\t.rfield   = &ad1843_RDA1G,\n\t.lmute    = &ad1843_LDA1GM,\n\t.rmute    = &ad1843_RDA1GM\n};\nstatic const struct ad1843_gain ad1843_gain_PCM_1 = {\n\t.negative = 1,\n\t.lfield   = &ad1843_LD2M,\n\t.rfield   = &ad1843_RD2M,\n\t.lmute    = &ad1843_LD2MM,\n\t.rmute    = &ad1843_RD2MM\n};\n\nstatic const struct ad1843_gain *ad1843_gain[AD1843_GAIN_SIZE] =\n{\n\t&ad1843_gain_RECLEV,\n\t&ad1843_gain_LINE,\n\t&ad1843_gain_LINE_2,\n\t&ad1843_gain_MIC,\n\t&ad1843_gain_PCM_0,\n\t&ad1843_gain_PCM_1,\n};\n\n \n\nstatic int ad1843_read_bits(struct snd_ad1843 *ad1843,\n\t\t\t    const struct ad1843_bitfield *field)\n{\n\tint w;\n\n\tw = ad1843->read(ad1843->chip, field->reg);\n\treturn w >> field->lo_bit & ((1 << field->nbits) - 1);\n}\n\n \n\nstatic int ad1843_write_bits(struct snd_ad1843 *ad1843,\n\t\t\t     const struct ad1843_bitfield *field,\n\t\t\t     int newval)\n{\n\tint w, mask, oldval, newbits;\n\n\tw = ad1843->read(ad1843->chip, field->reg);\n\tmask = ((1 << field->nbits) - 1) << field->lo_bit;\n\toldval = (w & mask) >> field->lo_bit;\n\tnewbits = (newval << field->lo_bit) & mask;\n\tw = (w & ~mask) | newbits;\n\tad1843->write(ad1843->chip, field->reg, w);\n\n\treturn oldval;\n}\n\n \n\nstatic void ad1843_read_multi(struct snd_ad1843 *ad1843, int argcount, ...)\n{\n\tva_list ap;\n\tconst struct ad1843_bitfield *fp;\n\tint w = 0, mask, *value, reg = -1;\n\n\tva_start(ap, argcount);\n\twhile (--argcount >= 0) {\n\t\tfp = va_arg(ap, const struct ad1843_bitfield *);\n\t\tvalue = va_arg(ap, int *);\n\t\tif (reg == -1) {\n\t\t\treg = fp->reg;\n\t\t\tw = ad1843->read(ad1843->chip, reg);\n\t\t}\n\n\t\tmask = (1 << fp->nbits) - 1;\n\t\t*value = w >> fp->lo_bit & mask;\n\t}\n\tva_end(ap);\n}\n\n \n\nstatic void ad1843_write_multi(struct snd_ad1843 *ad1843, int argcount, ...)\n{\n\tva_list ap;\n\tint reg;\n\tconst struct ad1843_bitfield *fp;\n\tint value;\n\tint w, m, mask, bits;\n\n\tmask = 0;\n\tbits = 0;\n\treg = -1;\n\n\tva_start(ap, argcount);\n\twhile (--argcount >= 0) {\n\t\tfp = va_arg(ap, const struct ad1843_bitfield *);\n\t\tvalue = va_arg(ap, int);\n\t\tif (reg == -1)\n\t\t\treg = fp->reg;\n\t\telse\n\t\t\tWARN_ON(reg != fp->reg);\n\t\tm = ((1 << fp->nbits) - 1) << fp->lo_bit;\n\t\tmask |= m;\n\t\tbits |= (value << fp->lo_bit) & m;\n\t}\n\tva_end(ap);\n\n\tif (~mask & 0xFFFF)\n\t\tw = ad1843->read(ad1843->chip, reg);\n\telse\n\t\tw = 0;\n\tw = (w & ~mask) | bits;\n\tad1843->write(ad1843->chip, reg, w);\n}\n\nint ad1843_get_gain_max(struct snd_ad1843 *ad1843, int id)\n{\n\tconst struct ad1843_gain *gp = ad1843_gain[id];\n\tint ret;\n\n\tret = (1 << gp->lfield->nbits);\n\tif (!gp->lmute)\n\t\tret -= 1;\n\treturn ret;\n}\n\n \n\nint ad1843_get_gain(struct snd_ad1843 *ad1843, int id)\n{\n\tint lg, rg, lm, rm;\n\tconst struct ad1843_gain *gp = ad1843_gain[id];\n\tunsigned short mask = (1 << gp->lfield->nbits) - 1;\n\n\tad1843_read_multi(ad1843, 2, gp->lfield, &lg, gp->rfield, &rg);\n\tif (gp->negative) {\n\t\tlg = mask - lg;\n\t\trg = mask - rg;\n\t}\n\tif (gp->lmute) {\n\t\tad1843_read_multi(ad1843, 2, gp->lmute, &lm, gp->rmute, &rm);\n\t\tif (lm)\n\t\t\tlg = 0;\n\t\tif (rm)\n\t\t\trg = 0;\n\t}\n\treturn lg << 0 | rg << 8;\n}\n\n \n\nint ad1843_set_gain(struct snd_ad1843 *ad1843, int id, int newval)\n{\n\tconst struct ad1843_gain *gp = ad1843_gain[id];\n\tunsigned short mask = (1 << gp->lfield->nbits) - 1;\n\n\tint lg = (newval >> 0) & mask;\n\tint rg = (newval >> 8) & mask;\n\tint lm = (lg == 0) ? 1 : 0;\n\tint rm = (rg == 0) ? 1 : 0;\n\n\tif (gp->negative) {\n\t\tlg = mask - lg;\n\t\trg = mask - rg;\n\t}\n\tif (gp->lmute)\n\t\tad1843_write_multi(ad1843, 2, gp->lmute, lm, gp->rmute, rm);\n\tad1843_write_multi(ad1843, 2, gp->lfield, lg, gp->rfield, rg);\n\treturn ad1843_get_gain(ad1843, id);\n}\n\n \n\nint ad1843_get_recsrc(struct snd_ad1843 *ad1843)\n{\n\tint val = ad1843_read_bits(ad1843, &ad1843_LSS);\n\n\tif (val < 0 || val > 2) {\n\t\tval = 2;\n\t\tad1843_write_multi(ad1843, 2,\n\t\t\t\t   &ad1843_LSS, val, &ad1843_RSS, val);\n\t}\n\treturn val;\n}\n\n \n\nint ad1843_set_recsrc(struct snd_ad1843 *ad1843, int newsrc)\n{\n\tif (newsrc < 0 || newsrc > 2)\n\t\treturn -EINVAL;\n\n\tad1843_write_multi(ad1843, 2, &ad1843_LSS, newsrc, &ad1843_RSS, newsrc);\n\treturn newsrc;\n}\n\n \n\nvoid ad1843_setup_dac(struct snd_ad1843 *ad1843,\n\t\t      unsigned int id,\n\t\t      unsigned int framerate,\n\t\t      snd_pcm_format_t fmt,\n\t\t      unsigned int channels)\n{\n\tint ad_fmt = 0, ad_mode = 0;\n\n\tswitch (fmt) {\n\tcase SNDRV_PCM_FORMAT_S8:\n\t\tad_fmt = 0;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_U8:\n\t\tad_fmt = 0;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tad_fmt = 1;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_MU_LAW:\n\t\tad_fmt = 2;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_A_LAW:\n\t\tad_fmt = 3;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (channels) {\n\tcase 2:\n\t\tad_mode = 0;\n\t\tbreak;\n\tcase 1:\n\t\tad_mode = 1;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (id) {\n\t\tad1843_write_bits(ad1843, &ad1843_C2C, framerate);\n\t\tad1843_write_multi(ad1843, 2,\n\t\t\t\t   &ad1843_DA2SM, ad_mode,\n\t\t\t\t   &ad1843_DA2F, ad_fmt);\n\t} else {\n\t\tad1843_write_bits(ad1843, &ad1843_C1C, framerate);\n\t\tad1843_write_multi(ad1843, 2,\n\t\t\t\t   &ad1843_DA1SM, ad_mode,\n\t\t\t\t   &ad1843_DA1F, ad_fmt);\n\t}\n}\n\nvoid ad1843_shutdown_dac(struct snd_ad1843 *ad1843, unsigned int id)\n{\n\tif (id)\n\t\tad1843_write_bits(ad1843, &ad1843_DA2F, 1);\n\telse\n\t\tad1843_write_bits(ad1843, &ad1843_DA1F, 1);\n}\n\nvoid ad1843_setup_adc(struct snd_ad1843 *ad1843,\n\t\t      unsigned int framerate,\n\t\t      snd_pcm_format_t fmt,\n\t\t      unsigned int channels)\n{\n\tint da_fmt = 0;\n\n\tswitch (fmt) {\n\tcase SNDRV_PCM_FORMAT_S8:\tda_fmt = 0; break;\n\tcase SNDRV_PCM_FORMAT_U8:\tda_fmt = 0; break;\n\tcase SNDRV_PCM_FORMAT_S16_LE:\tda_fmt = 1; break;\n\tcase SNDRV_PCM_FORMAT_MU_LAW:\tda_fmt = 2; break;\n\tcase SNDRV_PCM_FORMAT_A_LAW:\tda_fmt = 3; break;\n\tdefault:\t\tbreak;\n\t}\n\n\tad1843_write_bits(ad1843, &ad1843_C3C, framerate);\n\tad1843_write_multi(ad1843, 2,\n\t\t\t   &ad1843_ADLF, da_fmt, &ad1843_ADRF, da_fmt);\n}\n\nvoid ad1843_shutdown_adc(struct snd_ad1843 *ad1843)\n{\n\t \n}\n\n \n\nint ad1843_init(struct snd_ad1843 *ad1843)\n{\n\tunsigned long later;\n\n\tif (ad1843_read_bits(ad1843, &ad1843_INIT) != 0) {\n\t\tprintk(KERN_ERR \"ad1843: AD1843 won't initialize\\n\");\n\t\treturn -EIO;\n\t}\n\n\tad1843_write_bits(ad1843, &ad1843_SCF, 1);\n\n\t \n\tad1843_write_bits(ad1843, &ad1843_PDNI, 0);\n\tlater = jiffies + msecs_to_jiffies(500);\n\n\twhile (ad1843_read_bits(ad1843, &ad1843_PDNO)) {\n\t\tif (time_after(jiffies, later)) {\n\t\t\tprintk(KERN_ERR\n\t\t\t       \"ad1843: AD1843 won't power up\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tschedule_timeout_interruptible(5);\n\t}\n\n\t \n\tad1843_write_multi(ad1843, 3,\n\t\t\t   &ad1843_C1EN, 1,\n\t\t\t   &ad1843_C2EN, 1,\n\t\t\t   &ad1843_C3EN, 1);\n\n\t \n\n\t \n\tad1843_write_multi(ad1843, 4,\n\t\t\t   &ad1843_DA1C, 1,\n\t\t\t   &ad1843_DA2C, 2,\n\t\t\t   &ad1843_ADLC, 3,\n\t\t\t   &ad1843_ADRC, 3);\n\n\t \n\tad1843_write_bits(ad1843, &ad1843_ADTLK, 1);\n\tad1843_write_multi(ad1843, 7,\n\t\t\t   &ad1843_ANAEN, 1,\n\t\t\t   &ad1843_AAMEN, 1,\n\t\t\t   &ad1843_DA1EN, 1,\n\t\t\t   &ad1843_DA2EN, 1,\n\t\t\t   &ad1843_DDMEN, 1,\n\t\t\t   &ad1843_ADLEN, 1,\n\t\t\t   &ad1843_ADREN, 1);\n\n\t \n\n\t \n\tad1843_set_gain(ad1843, AD1843_GAIN_RECLEV, 0);\n\tad1843_set_gain(ad1843, AD1843_GAIN_LINE, 0);\n\tad1843_set_gain(ad1843, AD1843_GAIN_LINE_2, 0);\n\tad1843_set_gain(ad1843, AD1843_GAIN_MIC, 0);\n\tad1843_set_gain(ad1843, AD1843_GAIN_PCM_0, 0);\n\tad1843_set_gain(ad1843, AD1843_GAIN_PCM_1, 0);\n\n\t \n\t \n\tad1843_write_multi(ad1843, 2, &ad1843_LDA1GM, 0, &ad1843_RDA1GM, 0);\n\t \n\tad1843_write_multi(ad1843, 2, &ad1843_LDA2GM, 0, &ad1843_RDA2GM, 0);\n\n\t \n\tad1843_set_recsrc(ad1843, 2);\n\tad1843_write_multi(ad1843, 2, &ad1843_LMGE, 1, &ad1843_RMGE, 1);\n\n\t \n\tad1843_write_multi(ad1843, 3,\n\t\t\t   &ad1843_HPOS, 1,\n\t\t\t   &ad1843_HPOM, 0,\n\t\t\t   &ad1843_MPOM, 0);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}