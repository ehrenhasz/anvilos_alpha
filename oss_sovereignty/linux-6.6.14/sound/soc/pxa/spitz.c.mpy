{
  "module_name": "spitz.c",
  "hash_id": "2312c50efe2b9afbb673c3f17f7d62406a63369cefb9b3dd4f4910b9016baaa1",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/pxa/spitz.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/timer.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/gpio/consumer.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n\n#include <asm/mach-types.h>\n#include \"../codecs/wm8750.h\"\n#include \"pxa2xx-i2s.h\"\n\n#define SPITZ_HP        0\n#define SPITZ_MIC       1\n#define SPITZ_LINE      2\n#define SPITZ_HEADSET   3\n#define SPITZ_HP_OFF    4\n#define SPITZ_SPK_ON    0\n#define SPITZ_SPK_OFF   1\n\n  \n#define SPITZ_AUDIO_CLOCK 12288000\n\nstatic int spitz_jack_func;\nstatic int spitz_spk_func;\nstatic struct gpio_desc *gpiod_mic, *gpiod_mute_l, *gpiod_mute_r;\n\nstatic void spitz_ext_control(struct snd_soc_dapm_context *dapm)\n{\n\tsnd_soc_dapm_mutex_lock(dapm);\n\n\tif (spitz_spk_func == SPITZ_SPK_ON)\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Ext Spk\");\n\telse\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Ext Spk\");\n\n\t \n\tswitch (spitz_jack_func) {\n\tcase SPITZ_HP:\n\t\t \n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headset Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Mic Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Line Jack\");\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Headphone Jack\");\n\t\tgpiod_set_value(gpiod_mute_l, 1);\n\t\tgpiod_set_value(gpiod_mute_r, 1);\n\t\tbreak;\n\tcase SPITZ_MIC:\n\t\t \n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headphone Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headset Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Line Jack\");\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Mic Jack\");\n\t\tgpiod_set_value(gpiod_mute_l, 0);\n\t\tgpiod_set_value(gpiod_mute_r, 0);\n\t\tbreak;\n\tcase SPITZ_LINE:\n\t\t \n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headphone Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headset Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Mic Jack\");\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Line Jack\");\n\t\tgpiod_set_value(gpiod_mute_l, 0);\n\t\tgpiod_set_value(gpiod_mute_r, 0);\n\t\tbreak;\n\tcase SPITZ_HEADSET:\n\t\t \n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headphone Jack\");\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Mic Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Line Jack\");\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Headset Jack\");\n\t\tgpiod_set_value(gpiod_mute_l, 0);\n\t\tgpiod_set_value(gpiod_mute_r, 1);\n\t\tbreak;\n\tcase SPITZ_HP_OFF:\n\n\t\t \n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headphone Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headset Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Mic Jack\");\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Line Jack\");\n\t\tgpiod_set_value(gpiod_mute_l, 0);\n\t\tgpiod_set_value(gpiod_mute_r, 0);\n\t\tbreak;\n\t}\n\n\tsnd_soc_dapm_sync_unlocked(dapm);\n\n\tsnd_soc_dapm_mutex_unlock(dapm);\n}\n\nstatic int spitz_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\n\t \n\tspitz_ext_control(&rtd->card->dapm);\n\n\treturn 0;\n}\n\nstatic int spitz_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tunsigned int clk = 0;\n\tint ret = 0;\n\n\tswitch (params_rate(params)) {\n\tcase 8000:\n\tcase 16000:\n\tcase 48000:\n\tcase 96000:\n\t\tclk = 12288000;\n\t\tbreak;\n\tcase 11025:\n\tcase 22050:\n\tcase 44100:\n\t\tclk = 11289600;\n\t\tbreak;\n\t}\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8750_SYSCLK, clk,\n\t\tSND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = snd_soc_dai_set_sysclk(cpu_dai, PXA2XX_I2S_SYSCLK, 0,\n\t\tSND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops spitz_ops = {\n\t.startup = spitz_startup,\n\t.hw_params = spitz_hw_params,\n};\n\nstatic int spitz_get_jack(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tucontrol->value.enumerated.item[0] = spitz_jack_func;\n\treturn 0;\n}\n\nstatic int spitz_set_jack(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\n\tif (spitz_jack_func == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\tspitz_jack_func = ucontrol->value.enumerated.item[0];\n\tspitz_ext_control(&card->dapm);\n\treturn 1;\n}\n\nstatic int spitz_get_spk(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tucontrol->value.enumerated.item[0] = spitz_spk_func;\n\treturn 0;\n}\n\nstatic int spitz_set_spk(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\n\tif (spitz_spk_func == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\tspitz_spk_func = ucontrol->value.enumerated.item[0];\n\tspitz_ext_control(&card->dapm);\n\treturn 1;\n}\n\nstatic int spitz_mic_bias(struct snd_soc_dapm_widget *w,\n\tstruct snd_kcontrol *k, int event)\n{\n\tgpiod_set_value_cansleep(gpiod_mic, SND_SOC_DAPM_EVENT_ON(event));\n\treturn 0;\n}\n\n \nstatic const struct snd_soc_dapm_widget wm8750_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic Jack\", spitz_mic_bias),\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line Jack\", NULL),\n\n\t \n\tSND_SOC_DAPM_HP(\"Headset Jack\", NULL),\n};\n\n \nstatic const struct snd_soc_dapm_route spitz_audio_map[] = {\n\n\t \n\t{\"Headphone Jack\", NULL, \"LOUT1\"},\n\t{\"Headphone Jack\", NULL, \"ROUT1\"},\n\n\t \n\t{\"Headset Jack\", NULL, \"ROUT1\"},\n\n\t \n\t{\"Ext Spk\", NULL, \"ROUT2\"},\n\t{\"Ext Spk\", NULL, \"LOUT2\"},\n\n\t \n\t{\"LINPUT1\", NULL, \"Mic Bias\"},\n\t{\"Mic Bias\", NULL, \"Mic Jack\"},\n\n\t \n\t{\"LINPUT1\", NULL, \"Line Jack\"},\n};\n\nstatic const char * const jack_function[] = {\"Headphone\", \"Mic\", \"Line\",\n\t\"Headset\", \"Off\"};\nstatic const char * const spk_function[] = {\"On\", \"Off\"};\nstatic const struct soc_enum spitz_enum[] = {\n\tSOC_ENUM_SINGLE_EXT(5, jack_function),\n\tSOC_ENUM_SINGLE_EXT(2, spk_function),\n};\n\nstatic const struct snd_kcontrol_new wm8750_spitz_controls[] = {\n\tSOC_ENUM_EXT(\"Jack Function\", spitz_enum[0], spitz_get_jack,\n\t\tspitz_set_jack),\n\tSOC_ENUM_EXT(\"Speaker Function\", spitz_enum[1], spitz_get_spk,\n\t\tspitz_set_spk),\n};\n\n \nSND_SOC_DAILINK_DEFS(wm8750,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"pxa2xx-i2s\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8750.0-001b\", \"wm8750-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"pxa-pcm-audio\")));\n\nstatic struct snd_soc_dai_link spitz_dai = {\n\t.name = \"wm8750\",\n\t.stream_name = \"WM8750\",\n\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t   SND_SOC_DAIFMT_CBS_CFS,\n\t.ops = &spitz_ops,\n\tSND_SOC_DAILINK_REG(wm8750),\n};\n\n \nstatic struct snd_soc_card snd_soc_spitz = {\n\t.name = \"Spitz\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &spitz_dai,\n\t.num_links = 1,\n\n\t.controls = wm8750_spitz_controls,\n\t.num_controls = ARRAY_SIZE(wm8750_spitz_controls),\n\t.dapm_widgets = wm8750_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(wm8750_dapm_widgets),\n\t.dapm_routes = spitz_audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(spitz_audio_map),\n\t.fully_routed = true,\n};\n\nstatic int spitz_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &snd_soc_spitz;\n\tint ret;\n\n\tgpiod_mic = devm_gpiod_get(&pdev->dev, \"mic\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpiod_mic))\n\t\treturn PTR_ERR(gpiod_mic);\n\tgpiod_mute_l = devm_gpiod_get(&pdev->dev, \"mute-l\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpiod_mute_l))\n\t\treturn PTR_ERR(gpiod_mute_l);\n\tgpiod_mute_r = devm_gpiod_get(&pdev->dev, \"mute-r\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpiod_mute_r))\n\t\treturn PTR_ERR(gpiod_mute_r);\n\n\tcard->dev = &pdev->dev;\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret)\n\t\tdev_err(&pdev->dev, \"snd_soc_register_card() failed: %d\\n\",\n\t\t\tret);\n\n\treturn ret;\n}\n\nstatic struct platform_driver spitz_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"spitz-audio\",\n\t\t.pm     = &snd_soc_pm_ops,\n\t},\n\t.probe\t\t= spitz_probe,\n};\n\nmodule_platform_driver(spitz_driver);\n\nMODULE_AUTHOR(\"Richard Purdie\");\nMODULE_DESCRIPTION(\"ALSA SoC Spitz\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:spitz-audio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}