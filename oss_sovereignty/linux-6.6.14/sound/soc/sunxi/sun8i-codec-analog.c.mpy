{
  "module_name": "sun8i-codec-analog.c",
  "hash_id": "1724cea0c744d7e248c10ab9f0a8f6d7436639dd4885fb974c6093a20fa6f443",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sunxi/sun8i-codec-analog.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/tlv.h>\n\n#include \"sun8i-adda-pr-regmap.h\"\n\n \n#define SUN8I_ADDA_HP_VOLC\t\t0x00\n#define SUN8I_ADDA_HP_VOLC_PA_CLK_GATE\t\t7\n#define SUN8I_ADDA_HP_VOLC_HP_VOL\t\t0\n#define SUN8I_ADDA_LOMIXSC\t\t0x01\n#define SUN8I_ADDA_LOMIXSC_MIC1\t\t\t6\n#define SUN8I_ADDA_LOMIXSC_MIC2\t\t\t5\n#define SUN8I_ADDA_LOMIXSC_PHONE\t\t4\n#define SUN8I_ADDA_LOMIXSC_PHONEN\t\t3\n#define SUN8I_ADDA_LOMIXSC_LINEINL\t\t2\n#define SUN8I_ADDA_LOMIXSC_DACL\t\t\t1\n#define SUN8I_ADDA_LOMIXSC_DACR\t\t\t0\n#define SUN8I_ADDA_ROMIXSC\t\t0x02\n#define SUN8I_ADDA_ROMIXSC_MIC1\t\t\t6\n#define SUN8I_ADDA_ROMIXSC_MIC2\t\t\t5\n#define SUN8I_ADDA_ROMIXSC_PHONE\t\t4\n#define SUN8I_ADDA_ROMIXSC_PHONEP\t\t3\n#define SUN8I_ADDA_ROMIXSC_LINEINR\t\t2\n#define SUN8I_ADDA_ROMIXSC_DACR\t\t\t1\n#define SUN8I_ADDA_ROMIXSC_DACL\t\t\t0\n#define SUN8I_ADDA_DAC_PA_SRC\t\t0x03\n#define SUN8I_ADDA_DAC_PA_SRC_DACAREN\t\t7\n#define SUN8I_ADDA_DAC_PA_SRC_DACALEN\t\t6\n#define SUN8I_ADDA_DAC_PA_SRC_RMIXEN\t\t5\n#define SUN8I_ADDA_DAC_PA_SRC_LMIXEN\t\t4\n#define SUN8I_ADDA_DAC_PA_SRC_RHPPAMUTE\t\t3\n#define SUN8I_ADDA_DAC_PA_SRC_LHPPAMUTE\t\t2\n#define SUN8I_ADDA_DAC_PA_SRC_RHPIS\t\t1\n#define SUN8I_ADDA_DAC_PA_SRC_LHPIS\t\t0\n#define SUN8I_ADDA_PHONEIN_GCTRL\t0x04\n#define SUN8I_ADDA_PHONEIN_GCTRL_PHONEPG\t4\n#define SUN8I_ADDA_PHONEIN_GCTRL_PHONENG\t0\n#define SUN8I_ADDA_LINEIN_GCTRL\t\t0x05\n#define SUN8I_ADDA_LINEIN_GCTRL_LINEING\t\t4\n#define SUN8I_ADDA_LINEIN_GCTRL_PHONEG\t\t0\n#define SUN8I_ADDA_MICIN_GCTRL\t\t0x06\n#define SUN8I_ADDA_MICIN_GCTRL_MIC1G\t\t4\n#define SUN8I_ADDA_MICIN_GCTRL_MIC2G\t\t0\n#define SUN8I_ADDA_PAEN_HP_CTRL\t\t0x07\n#define SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN\t\t7\n#define SUN8I_ADDA_PAEN_HP_CTRL_LINEOUTEN\t7\t \n#define SUN8I_ADDA_PAEN_HP_CTRL_HPCOM_FC\t5\n#define SUN8I_ADDA_PAEN_HP_CTRL_COMPTEN\t\t4\n#define SUN8I_ADDA_PAEN_HP_CTRL_PA_ANTI_POP_CTRL\t2\n#define SUN8I_ADDA_PAEN_HP_CTRL_LTRNMUTE\t1\n#define SUN8I_ADDA_PAEN_HP_CTRL_RTLNMUTE\t0\n#define SUN8I_ADDA_PHONEOUT_CTRL\t0x08\n#define SUN8I_ADDA_PHONEOUT_CTRL_PHONEOUTG\t5\n#define SUN8I_ADDA_PHONEOUT_CTRL_PHONEOUTEN\t4\n#define SUN8I_ADDA_PHONEOUT_CTRL_PHONEOUT_MIC1\t3\n#define SUN8I_ADDA_PHONEOUT_CTRL_PHONEOUT_MIC2\t2\n#define SUN8I_ADDA_PHONEOUT_CTRL_PHONEOUT_RMIX\t1\n#define SUN8I_ADDA_PHONEOUT_CTRL_PHONEOUT_LMIX\t0\n#define SUN8I_ADDA_PHONE_GAIN_CTRL\t0x09\n#define SUN8I_ADDA_PHONE_GAIN_CTRL_LINEOUT_VOL\t3\n#define SUN8I_ADDA_PHONE_GAIN_CTRL_PHONEPREG\t0\n#define SUN8I_ADDA_MIC2G_CTRL\t\t0x0a\n#define SUN8I_ADDA_MIC2G_CTRL_MIC2AMPEN\t\t7\n#define SUN8I_ADDA_MIC2G_CTRL_MIC2BOOST\t\t4\n#define SUN8I_ADDA_MIC2G_CTRL_LINEOUTLEN\t3\n#define SUN8I_ADDA_MIC2G_CTRL_LINEOUTREN\t2\n#define SUN8I_ADDA_MIC2G_CTRL_LINEOUTLSRC\t1\n#define SUN8I_ADDA_MIC2G_CTRL_LINEOUTRSRC\t0\n#define SUN8I_ADDA_MIC1G_MICBIAS_CTRL\t0x0b\n#define SUN8I_ADDA_MIC1G_MICBIAS_CTRL_HMICBIASEN\t7\n#define SUN8I_ADDA_MIC1G_MICBIAS_CTRL_MMICBIASEN\t6\n#define SUN8I_ADDA_MIC1G_MICBIAS_CTRL_HMICBIAS_MODE\t5\n#define SUN8I_ADDA_MIC1G_MICBIAS_CTRL_MIC1AMPEN\t\t3\n#define SUN8I_ADDA_MIC1G_MICBIAS_CTRL_MIC1BOOST\t\t0\n#define SUN8I_ADDA_LADCMIXSC\t\t0x0c\n#define SUN8I_ADDA_LADCMIXSC_MIC1\t\t6\n#define SUN8I_ADDA_LADCMIXSC_MIC2\t\t5\n#define SUN8I_ADDA_LADCMIXSC_PHONE\t\t4\n#define SUN8I_ADDA_LADCMIXSC_PHONEN\t\t3\n#define SUN8I_ADDA_LADCMIXSC_LINEINL\t\t2\n#define SUN8I_ADDA_LADCMIXSC_OMIXRL\t\t1\n#define SUN8I_ADDA_LADCMIXSC_OMIXRR\t\t0\n#define SUN8I_ADDA_RADCMIXSC\t\t0x0d\n#define SUN8I_ADDA_RADCMIXSC_MIC1\t\t6\n#define SUN8I_ADDA_RADCMIXSC_MIC2\t\t5\n#define SUN8I_ADDA_RADCMIXSC_PHONE\t\t4\n#define SUN8I_ADDA_RADCMIXSC_PHONEP\t\t3\n#define SUN8I_ADDA_RADCMIXSC_LINEINR\t\t2\n#define SUN8I_ADDA_RADCMIXSC_OMIXR\t\t1\n#define SUN8I_ADDA_RADCMIXSC_OMIXL\t\t0\n#define SUN8I_ADDA_RES\t\t\t0x0e\n#define SUN8I_ADDA_RES_MMICBIAS_SEL\t\t4\n#define SUN8I_ADDA_RES_PA_ANTI_POP_CTRL\t\t0\n#define SUN8I_ADDA_ADC_AP_EN\t\t0x0f\n#define SUN8I_ADDA_ADC_AP_EN_ADCREN\t\t7\n#define SUN8I_ADDA_ADC_AP_EN_ADCLEN\t\t6\n#define SUN8I_ADDA_ADC_AP_EN_ADCG\t\t0\n\n \nstatic const struct snd_kcontrol_new sun8i_codec_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE_R(\"DAC Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_DACL, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"DAC Reversed Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_DACR, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Line In Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_LINEINL, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mic1 Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_MIC1, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mic2 Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_MIC2, 1, 0),\n};\n\n \nstatic const struct snd_kcontrol_new sun8i_v3s_codec_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE_R(\"DAC Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_DACL, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"DAC Reversed Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_DACR, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mic1 Playback Switch\",\n\t\t\t  SUN8I_ADDA_LOMIXSC,\n\t\t\t  SUN8I_ADDA_ROMIXSC,\n\t\t\t  SUN8I_ADDA_LOMIXSC_MIC1, 1, 0),\n};\n\n \nstatic const struct snd_kcontrol_new sun8i_codec_adc_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE_R(\"Mixer Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_OMIXRL, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mixer Reversed Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_OMIXRR, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Line In Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_LINEINL, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mic1 Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_MIC1, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mic2 Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_MIC2, 1, 0),\n};\n\n \nstatic const struct snd_kcontrol_new sun8i_v3s_codec_adc_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE_R(\"Mixer Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_OMIXRL, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mixer Reversed Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_OMIXRR, 1, 0),\n\tSOC_DAPM_DOUBLE_R(\"Mic1 Capture Switch\",\n\t\t\t  SUN8I_ADDA_LADCMIXSC,\n\t\t\t  SUN8I_ADDA_RADCMIXSC,\n\t\t\t  SUN8I_ADDA_LADCMIXSC_MIC1, 1, 0),\n};\n\n \nstatic const DECLARE_TLV_DB_SCALE(sun8i_codec_out_mixer_pregain_scale,\n\t\t\t\t  -450, 150, 0);\nstatic const DECLARE_TLV_DB_RANGE(sun8i_codec_mic_gain_scale,\n\t0, 0, TLV_DB_SCALE_ITEM(0, 0, 0),\n\t1, 7, TLV_DB_SCALE_ITEM(2400, 300, 0),\n);\n\nstatic const struct snd_kcontrol_new sun8i_codec_common_controls[] = {\n\t \n\tSOC_SINGLE_TLV(\"Mic1 Playback Volume\", SUN8I_ADDA_MICIN_GCTRL,\n\t\t       SUN8I_ADDA_MICIN_GCTRL_MIC1G,\n\t\t       0x7, 0, sun8i_codec_out_mixer_pregain_scale),\n\n\t \n\tSOC_SINGLE_TLV(\"Mic1 Boost Volume\", SUN8I_ADDA_MIC1G_MICBIAS_CTRL,\n\t\t       SUN8I_ADDA_MIC1G_MICBIAS_CTRL_MIC1BOOST, 0x7, 0,\n\t\t       sun8i_codec_mic_gain_scale),\n\n\t \n\tSOC_SINGLE_TLV(\"ADC Gain Capture Volume\", SUN8I_ADDA_ADC_AP_EN,\n\t\t       SUN8I_ADDA_ADC_AP_EN_ADCG, 0x7, 0,\n\t\t       sun8i_codec_out_mixer_pregain_scale),\n};\n\nstatic const struct snd_soc_dapm_widget sun8i_codec_common_widgets[] = {\n\t \n\tSND_SOC_DAPM_ADC(\"Left ADC\", NULL, SUN8I_ADDA_ADC_AP_EN,\n\t\t\t SUN8I_ADDA_ADC_AP_EN_ADCLEN, 0),\n\tSND_SOC_DAPM_ADC(\"Right ADC\", NULL, SUN8I_ADDA_ADC_AP_EN,\n\t\t\t SUN8I_ADDA_ADC_AP_EN_ADCREN, 0),\n\n\t \n\tSND_SOC_DAPM_DAC(\"Left DAC\", NULL, SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t SUN8I_ADDA_DAC_PA_SRC_DACALEN, 0),\n\tSND_SOC_DAPM_DAC(\"Right DAC\", NULL, SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t SUN8I_ADDA_DAC_PA_SRC_DACAREN, 0),\n\t \n\n\t \n\tSND_SOC_DAPM_INPUT(\"MIC1\"),\n\n\t \n\tSND_SOC_DAPM_PGA(\"Mic1 Amplifier\", SUN8I_ADDA_MIC1G_MICBIAS_CTRL,\n\t\t\t SUN8I_ADDA_MIC1G_MICBIAS_CTRL_MIC1AMPEN, 0, NULL, 0),\n};\n\nstatic const struct snd_soc_dapm_widget sun8i_codec_mixer_widgets[] = {\n\tSND_SOC_DAPM_MIXER(\"Left Mixer\", SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t   SUN8I_ADDA_DAC_PA_SRC_LMIXEN, 0,\n\t\t\t   sun8i_codec_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_codec_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Right Mixer\", SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t   SUN8I_ADDA_DAC_PA_SRC_RMIXEN, 0,\n\t\t\t   sun8i_codec_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_codec_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Left ADC Mixer\", SUN8I_ADDA_ADC_AP_EN,\n\t\t\t   SUN8I_ADDA_ADC_AP_EN_ADCLEN, 0,\n\t\t\t   sun8i_codec_adc_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_codec_adc_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Right ADC Mixer\", SUN8I_ADDA_ADC_AP_EN,\n\t\t\t   SUN8I_ADDA_ADC_AP_EN_ADCREN, 0,\n\t\t\t   sun8i_codec_adc_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_codec_adc_mixer_controls)),\n};\n\nstatic const struct snd_soc_dapm_widget sun8i_v3s_codec_mixer_widgets[] = {\n\tSND_SOC_DAPM_MIXER(\"Left Mixer\", SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t   SUN8I_ADDA_DAC_PA_SRC_LMIXEN, 0,\n\t\t\t   sun8i_v3s_codec_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_v3s_codec_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Right Mixer\", SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t   SUN8I_ADDA_DAC_PA_SRC_RMIXEN, 0,\n\t\t\t   sun8i_v3s_codec_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_v3s_codec_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Left ADC Mixer\", SUN8I_ADDA_ADC_AP_EN,\n\t\t\t   SUN8I_ADDA_ADC_AP_EN_ADCLEN, 0,\n\t\t\t   sun8i_v3s_codec_adc_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_v3s_codec_adc_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Right ADC Mixer\", SUN8I_ADDA_ADC_AP_EN,\n\t\t\t   SUN8I_ADDA_ADC_AP_EN_ADCREN, 0,\n\t\t\t   sun8i_v3s_codec_adc_mixer_controls,\n\t\t\t   ARRAY_SIZE(sun8i_v3s_codec_adc_mixer_controls)),\n};\n\nstatic const struct snd_soc_dapm_route sun8i_codec_common_routes[] = {\n\t \n\t{ \"Mic1 Amplifier\", NULL, \"MIC1\"},\n};\n\nstatic const struct snd_soc_dapm_route sun8i_codec_mixer_routes[] = {\n\t \n\t{ \"Left Mixer\", \"DAC Playback Switch\", \"Left DAC\" },\n\t{ \"Left Mixer\", \"DAC Reversed Playback Switch\", \"Right DAC\" },\n\t{ \"Left Mixer\", \"Mic1 Playback Switch\", \"Mic1 Amplifier\" },\n\n\t \n\t{ \"Right Mixer\", \"DAC Playback Switch\", \"Right DAC\" },\n\t{ \"Right Mixer\", \"DAC Reversed Playback Switch\", \"Left DAC\" },\n\t{ \"Right Mixer\", \"Mic1 Playback Switch\", \"Mic1 Amplifier\" },\n\n\t \n\t{ \"Left ADC Mixer\", \"Mixer Capture Switch\", \"Left Mixer\" },\n\t{ \"Left ADC Mixer\", \"Mixer Reversed Capture Switch\", \"Right Mixer\" },\n\t{ \"Left ADC Mixer\", \"Mic1 Capture Switch\", \"Mic1 Amplifier\" },\n\n\t \n\t{ \"Right ADC Mixer\", \"Mixer Capture Switch\", \"Right Mixer\" },\n\t{ \"Right ADC Mixer\", \"Mixer Reversed Capture Switch\", \"Left Mixer\" },\n\t{ \"Right ADC Mixer\", \"Mic1 Capture Switch\", \"Mic1 Amplifier\" },\n\n\t \n\t{ \"Left ADC\", NULL, \"Left ADC Mixer\" },\n\t{ \"Right ADC\", NULL, \"Right ADC Mixer\" },\n};\n\n \nstatic const DECLARE_TLV_DB_SCALE(sun8i_codec_hp_vol_scale, -6300, 100, 1);\nstatic const struct snd_kcontrol_new sun8i_codec_headphone_controls[] = {\n\tSOC_SINGLE_TLV(\"Headphone Playback Volume\",\n\t\t       SUN8I_ADDA_HP_VOLC,\n\t\t       SUN8I_ADDA_HP_VOLC_HP_VOL, 0x3f, 0,\n\t\t       sun8i_codec_hp_vol_scale),\n\tSOC_DOUBLE(\"Headphone Playback Switch\",\n\t\t   SUN8I_ADDA_DAC_PA_SRC,\n\t\t   SUN8I_ADDA_DAC_PA_SRC_LHPPAMUTE,\n\t\t   SUN8I_ADDA_DAC_PA_SRC_RHPPAMUTE, 1, 0),\n};\n\nstatic const char * const sun8i_codec_hp_src_enum_text[] = {\n\t\"DAC\", \"Mixer\",\n};\n\nstatic SOC_ENUM_DOUBLE_DECL(sun8i_codec_hp_src_enum,\n\t\t\t    SUN8I_ADDA_DAC_PA_SRC,\n\t\t\t    SUN8I_ADDA_DAC_PA_SRC_LHPIS,\n\t\t\t    SUN8I_ADDA_DAC_PA_SRC_RHPIS,\n\t\t\t    sun8i_codec_hp_src_enum_text);\n\nstatic const struct snd_kcontrol_new sun8i_codec_hp_src[] = {\n\tSOC_DAPM_ENUM(\"Headphone Source Playback Route\",\n\t\t      sun8i_codec_hp_src_enum),\n};\n\nstatic int sun8i_headphone_amp_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t     struct snd_kcontrol *k, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\n\tif (SND_SOC_DAPM_EVENT_ON(event)) {\n\t\tsnd_soc_component_update_bits(component, SUN8I_ADDA_PAEN_HP_CTRL,\n\t\t\t\t\t      BIT(SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN),\n\t\t\t\t\t      BIT(SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN));\n\t\t \n\t\tmsleep(700);\n\t} else if (SND_SOC_DAPM_EVENT_OFF(event)) {\n\t\tsnd_soc_component_update_bits(component, SUN8I_ADDA_PAEN_HP_CTRL,\n\t\t\t\t\t      BIT(SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN),\n\t\t\t\t\t      0x0);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dapm_widget sun8i_codec_headphone_widgets[] = {\n\tSND_SOC_DAPM_MUX(\"Headphone Source Playback Route\",\n\t\t\t SND_SOC_NOPM, 0, 0, sun8i_codec_hp_src),\n\tSND_SOC_DAPM_OUT_DRV_E(\"Headphone Amp\", SUN8I_ADDA_PAEN_HP_CTRL,\n\t\t\t       SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN, 0, NULL, 0,\n\t\t\t       sun8i_headphone_amp_event,\n\t\t\t       SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"HPCOM Protection\", SUN8I_ADDA_PAEN_HP_CTRL,\n\t\t\t    SUN8I_ADDA_PAEN_HP_CTRL_COMPTEN, 0, NULL, 0),\n\tSND_SOC_DAPM_REG(snd_soc_dapm_supply, \"HPCOM\", SUN8I_ADDA_PAEN_HP_CTRL,\n\t\t\t SUN8I_ADDA_PAEN_HP_CTRL_HPCOM_FC, 0x3, 0x3, 0),\n\tSND_SOC_DAPM_OUTPUT(\"HP\"),\n};\n\nstatic const struct snd_soc_dapm_route sun8i_codec_headphone_routes[] = {\n\t{ \"Headphone Source Playback Route\", \"DAC\", \"Left DAC\" },\n\t{ \"Headphone Source Playback Route\", \"DAC\", \"Right DAC\" },\n\t{ \"Headphone Source Playback Route\", \"Mixer\", \"Left Mixer\" },\n\t{ \"Headphone Source Playback Route\", \"Mixer\", \"Right Mixer\" },\n\t{ \"Headphone Amp\", NULL, \"Headphone Source Playback Route\" },\n\t{ \"HPCOM\", NULL, \"HPCOM Protection\" },\n\t{ \"HP\", NULL, \"Headphone Amp\" },\n};\n\nstatic int sun8i_codec_add_headphone(struct snd_soc_component *cmpnt)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tret = snd_soc_add_component_controls(cmpnt,\n\t\t\t\t\t     sun8i_codec_headphone_controls,\n\t\t\t\t\t     ARRAY_SIZE(sun8i_codec_headphone_controls));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Headphone controls: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_new_controls(dapm, sun8i_codec_headphone_widgets,\n\t\t\t\t\tARRAY_SIZE(sun8i_codec_headphone_widgets));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Headphone DAPM widgets: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(dapm, sun8i_codec_headphone_routes,\n\t\t\t\t      ARRAY_SIZE(sun8i_codec_headphone_routes));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Headphone DAPM routes: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\n \nstatic const struct snd_soc_dapm_widget sun8i_codec_mbias_widgets[] = {\n\tSND_SOC_DAPM_SUPPLY(\"MBIAS\", SUN8I_ADDA_MIC1G_MICBIAS_CTRL,\n\t\t\t    SUN8I_ADDA_MIC1G_MICBIAS_CTRL_MMICBIASEN,\n\t\t\t    0, NULL, 0),\n};\n\nstatic int sun8i_codec_add_mbias(struct snd_soc_component *cmpnt)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(dapm, sun8i_codec_mbias_widgets,\n\t\t\t\t\tARRAY_SIZE(sun8i_codec_mbias_widgets));\n\tif (ret)\n\t\tdev_err(dev, \"Failed to add MBIAS DAPM widgets: %d\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic const struct snd_soc_dapm_widget sun8i_codec_hmic_widgets[] = {\n\tSND_SOC_DAPM_SUPPLY(\"HBIAS\", SUN8I_ADDA_MIC1G_MICBIAS_CTRL,\n\t\t\t    SUN8I_ADDA_MIC1G_MICBIAS_CTRL_HMICBIASEN,\n\t\t\t    0, NULL, 0),\n};\n\nstatic int sun8i_codec_add_hmic(struct snd_soc_component *cmpnt)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(dapm, sun8i_codec_hmic_widgets,\n\t\t\t\t\tARRAY_SIZE(sun8i_codec_hmic_widgets));\n\tif (ret)\n\t\tdev_err(dev, \"Failed to add Mic3 DAPM widgets: %d\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic const struct snd_kcontrol_new sun8i_codec_linein_controls[] = {\n\t \n\tSOC_SINGLE_TLV(\"Line In Playback Volume\", SUN8I_ADDA_LINEIN_GCTRL,\n\t\t       SUN8I_ADDA_LINEIN_GCTRL_LINEING,\n\t\t       0x7, 0, sun8i_codec_out_mixer_pregain_scale),\n};\n\nstatic const struct snd_soc_dapm_widget sun8i_codec_linein_widgets[] = {\n\t \n\tSND_SOC_DAPM_INPUT(\"LINEIN\"),\n};\n\nstatic const struct snd_soc_dapm_route sun8i_codec_linein_routes[] = {\n\t{ \"Left Mixer\", \"Line In Playback Switch\", \"LINEIN\" },\n\n\t{ \"Right Mixer\", \"Line In Playback Switch\", \"LINEIN\" },\n\n\t{ \"Left ADC Mixer\", \"Line In Capture Switch\", \"LINEIN\" },\n\n\t{ \"Right ADC Mixer\", \"Line In Capture Switch\", \"LINEIN\" },\n};\n\nstatic int sun8i_codec_add_linein(struct snd_soc_component *cmpnt)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tret = snd_soc_add_component_controls(cmpnt,\n\t\t\t\t\t     sun8i_codec_linein_controls,\n\t\t\t\t\t     ARRAY_SIZE(sun8i_codec_linein_controls));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Line In controls: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_new_controls(dapm, sun8i_codec_linein_widgets,\n\t\t\t\t\tARRAY_SIZE(sun8i_codec_linein_widgets));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Line In DAPM widgets: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(dapm, sun8i_codec_linein_routes,\n\t\t\t\t      ARRAY_SIZE(sun8i_codec_linein_routes));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Line In DAPM routes: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\n\n \nstatic const DECLARE_TLV_DB_RANGE(sun8i_codec_lineout_vol_scale,\n\t0, 1, TLV_DB_SCALE_ITEM(TLV_DB_GAIN_MUTE, 0, 1),\n\t2, 31, TLV_DB_SCALE_ITEM(-4350, 150, 0),\n);\nstatic const struct snd_kcontrol_new sun8i_codec_lineout_controls[] = {\n\tSOC_SINGLE_TLV(\"Line Out Playback Volume\",\n\t\t       SUN8I_ADDA_PHONE_GAIN_CTRL,\n\t\t       SUN8I_ADDA_PHONE_GAIN_CTRL_LINEOUT_VOL, 0x1f, 0,\n\t\t       sun8i_codec_lineout_vol_scale),\n\tSOC_DOUBLE(\"Line Out Playback Switch\",\n\t\t   SUN8I_ADDA_MIC2G_CTRL,\n\t\t   SUN8I_ADDA_MIC2G_CTRL_LINEOUTLEN,\n\t\t   SUN8I_ADDA_MIC2G_CTRL_LINEOUTREN, 1, 0),\n};\n\nstatic const char * const sun8i_codec_lineout_src_enum_text[] = {\n\t\"Stereo\", \"Mono Differential\",\n};\n\nstatic SOC_ENUM_DOUBLE_DECL(sun8i_codec_lineout_src_enum,\n\t\t\t    SUN8I_ADDA_MIC2G_CTRL,\n\t\t\t    SUN8I_ADDA_MIC2G_CTRL_LINEOUTLSRC,\n\t\t\t    SUN8I_ADDA_MIC2G_CTRL_LINEOUTRSRC,\n\t\t\t    sun8i_codec_lineout_src_enum_text);\n\nstatic const struct snd_kcontrol_new sun8i_codec_lineout_src[] = {\n\tSOC_DAPM_ENUM(\"Line Out Source Playback Route\",\n\t\t      sun8i_codec_lineout_src_enum),\n};\n\nstatic const struct snd_soc_dapm_widget sun8i_codec_lineout_widgets[] = {\n\tSND_SOC_DAPM_MUX(\"Line Out Source Playback Route\",\n\t\t\t SND_SOC_NOPM, 0, 0, sun8i_codec_lineout_src),\n\t \n\tSND_SOC_DAPM_SUPPLY(\"Line Out Enable\", SUN8I_ADDA_PAEN_HP_CTRL,\n\t\t\t    SUN8I_ADDA_PAEN_HP_CTRL_LINEOUTEN, 0, NULL, 0),\n\tSND_SOC_DAPM_OUTPUT(\"LINEOUT\"),\n};\n\nstatic const struct snd_soc_dapm_route sun8i_codec_lineout_routes[] = {\n\t{ \"Line Out Source Playback Route\", \"Stereo\", \"Left Mixer\" },\n\t{ \"Line Out Source Playback Route\", \"Stereo\", \"Right Mixer\" },\n\t{ \"Line Out Source Playback Route\", \"Mono Differential\", \"Left Mixer\" },\n\t{ \"Line Out Source Playback Route\", \"Mono Differential\", \"Right Mixer\" },\n\t{ \"LINEOUT\", NULL, \"Line Out Source Playback Route\" },\n\t{ \"LINEOUT\", NULL, \"Line Out Enable\", },\n};\n\nstatic int sun8i_codec_add_lineout(struct snd_soc_component *cmpnt)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tret = snd_soc_add_component_controls(cmpnt,\n\t\t\t\t\t     sun8i_codec_lineout_controls,\n\t\t\t\t\t     ARRAY_SIZE(sun8i_codec_lineout_controls));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Line Out controls: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_new_controls(dapm, sun8i_codec_lineout_widgets,\n\t\t\t\t\tARRAY_SIZE(sun8i_codec_lineout_widgets));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Line Out DAPM widgets: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(dapm, sun8i_codec_lineout_routes,\n\t\t\t\t      ARRAY_SIZE(sun8i_codec_lineout_routes));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Line Out DAPM routes: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\n \nstatic const struct snd_kcontrol_new sun8i_codec_mic2_controls[] = {\n\t \n\tSOC_SINGLE_TLV(\"Mic2 Playback Volume\",\n\t\t       SUN8I_ADDA_MICIN_GCTRL, SUN8I_ADDA_MICIN_GCTRL_MIC2G,\n\t\t       0x7, 0, sun8i_codec_out_mixer_pregain_scale),\n\n\t \n\tSOC_SINGLE_TLV(\"Mic2 Boost Volume\", SUN8I_ADDA_MIC2G_CTRL,\n\t\t       SUN8I_ADDA_MIC2G_CTRL_MIC2BOOST, 0x7, 0,\n\t\t       sun8i_codec_mic_gain_scale),\n};\n\nstatic const struct snd_soc_dapm_widget sun8i_codec_mic2_widgets[] = {\n\t \n\tSND_SOC_DAPM_INPUT(\"MIC2\"),\n\n\t \n\tSND_SOC_DAPM_PGA(\"Mic2 Amplifier\", SUN8I_ADDA_MIC2G_CTRL,\n\t\t\t SUN8I_ADDA_MIC2G_CTRL_MIC2AMPEN, 0, NULL, 0),\n};\n\nstatic const struct snd_soc_dapm_route sun8i_codec_mic2_routes[] = {\n\t{ \"Mic2 Amplifier\", NULL, \"MIC2\"},\n\n\t{ \"Left Mixer\", \"Mic2 Playback Switch\", \"Mic2 Amplifier\" },\n\n\t{ \"Right Mixer\", \"Mic2 Playback Switch\", \"Mic2 Amplifier\" },\n\n\t{ \"Left ADC Mixer\", \"Mic2 Capture Switch\", \"Mic2 Amplifier\" },\n\n\t{ \"Right ADC Mixer\", \"Mic2 Capture Switch\", \"Mic2 Amplifier\" },\n};\n\nstatic int sun8i_codec_add_mic2(struct snd_soc_component *cmpnt)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tret = snd_soc_add_component_controls(cmpnt,\n\t\t\t\t\t     sun8i_codec_mic2_controls,\n\t\t\t\t\t     ARRAY_SIZE(sun8i_codec_mic2_controls));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add MIC2 controls: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_new_controls(dapm, sun8i_codec_mic2_widgets,\n\t\t\t\t\tARRAY_SIZE(sun8i_codec_mic2_widgets));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add MIC2 DAPM widgets: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(dapm, sun8i_codec_mic2_routes,\n\t\t\t\t      ARRAY_SIZE(sun8i_codec_mic2_routes));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add MIC2 DAPM routes: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstruct sun8i_codec_analog_quirks {\n\tbool has_headphone;\n\tbool has_hmic;\n\tbool has_linein;\n\tbool has_lineout;\n\tbool has_mbias;\n\tbool has_mic2;\n};\n\nstatic const struct sun8i_codec_analog_quirks sun8i_a23_quirks = {\n\t.has_headphone\t= true,\n\t.has_hmic\t= true,\n\t.has_linein\t= true,\n\t.has_mbias\t= true,\n\t.has_mic2\t= true,\n};\n\nstatic const struct sun8i_codec_analog_quirks sun8i_h3_quirks = {\n\t.has_linein\t= true,\n\t.has_lineout\t= true,\n\t.has_mbias\t= true,\n\t.has_mic2\t= true,\n};\n\nstatic int sun8i_codec_analog_add_mixer(struct snd_soc_component *cmpnt,\n\t\t\t\t\tconst struct sun8i_codec_analog_quirks *quirks)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\n\tstruct device *dev = cmpnt->dev;\n\tint ret;\n\n\tif (!quirks->has_mic2 && !quirks->has_linein) {\n\t\t \n\t\tret = snd_soc_dapm_new_controls(dapm,\n\t\t\t\t\t\tsun8i_v3s_codec_mixer_widgets,\n\t\t\t\t\t\tARRAY_SIZE(sun8i_v3s_codec_mixer_widgets));\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to add V3s Mixer DAPM widgets: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\t \n\t\tret = snd_soc_dapm_new_controls(dapm,\n\t\t\t\t\t\tsun8i_codec_mixer_widgets,\n\t\t\t\t\t\tARRAY_SIZE(sun8i_codec_mixer_widgets));\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to add Mixer DAPM widgets: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = snd_soc_dapm_add_routes(dapm, sun8i_codec_mixer_routes,\n\t\t\t\t      ARRAY_SIZE(sun8i_codec_mixer_routes));\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add Mixer DAPM routes: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct sun8i_codec_analog_quirks sun8i_v3s_quirks = {\n\t.has_headphone\t= true,\n\t.has_hmic\t= true,\n};\n\nstatic int sun8i_codec_analog_cmpnt_probe(struct snd_soc_component *cmpnt)\n{\n\tstruct device *dev = cmpnt->dev;\n\tconst struct sun8i_codec_analog_quirks *quirks;\n\tint ret;\n\n\t \n\tquirks = of_device_get_match_data(dev);\n\n\t \n\tret = sun8i_codec_analog_add_mixer(cmpnt, quirks);\n\tif (ret)\n\t\treturn ret;\n\n\tif (quirks->has_headphone) {\n\t\tret = sun8i_codec_add_headphone(cmpnt);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (quirks->has_hmic) {\n\t\tret = sun8i_codec_add_hmic(cmpnt);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (quirks->has_linein) {\n\t\tret = sun8i_codec_add_linein(cmpnt);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (quirks->has_lineout) {\n\t\tret = sun8i_codec_add_lineout(cmpnt);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (quirks->has_mbias) {\n\t\tret = sun8i_codec_add_mbias(cmpnt);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (quirks->has_mic2) {\n\t\tret = sun8i_codec_add_mic2(cmpnt);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver sun8i_codec_analog_cmpnt_drv = {\n\t.controls\t\t= sun8i_codec_common_controls,\n\t.num_controls\t\t= ARRAY_SIZE(sun8i_codec_common_controls),\n\t.dapm_widgets\t\t= sun8i_codec_common_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(sun8i_codec_common_widgets),\n\t.dapm_routes\t\t= sun8i_codec_common_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(sun8i_codec_common_routes),\n\t.probe\t\t\t= sun8i_codec_analog_cmpnt_probe,\n};\n\nstatic const struct of_device_id sun8i_codec_analog_of_match[] = {\n\t{\n\t\t.compatible = \"allwinner,sun8i-a23-codec-analog\",\n\t\t.data = &sun8i_a23_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-h3-codec-analog\",\n\t\t.data = &sun8i_h3_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-v3s-codec-analog\",\n\t\t.data = &sun8i_v3s_quirks,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, sun8i_codec_analog_of_match);\n\nstatic int sun8i_codec_analog_probe(struct platform_device *pdev)\n{\n\tstruct regmap *regmap;\n\tvoid __iomem *base;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base)) {\n\t\tdev_err(&pdev->dev, \"Failed to map the registers\\n\");\n\t\treturn PTR_ERR(base);\n\t}\n\n\tregmap = sun8i_adda_pr_regmap_init(&pdev->dev, base);\n\tif (IS_ERR(regmap)) {\n\t\tdev_err(&pdev->dev, \"Failed to create regmap\\n\");\n\t\treturn PTR_ERR(regmap);\n\t}\n\n\treturn devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t\t       &sun8i_codec_analog_cmpnt_drv,\n\t\t\t\t\t       NULL, 0);\n}\n\nstatic struct platform_driver sun8i_codec_analog_driver = {\n\t.driver = {\n\t\t.name = \"sun8i-codec-analog\",\n\t\t.of_match_table = sun8i_codec_analog_of_match,\n\t},\n\t.probe = sun8i_codec_analog_probe,\n};\nmodule_platform_driver(sun8i_codec_analog_driver);\n\nMODULE_DESCRIPTION(\"Allwinner internal codec analog controls driver\");\nMODULE_AUTHOR(\"Chen-Yu Tsai <wens@csie.org>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:sun8i-codec-analog\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}