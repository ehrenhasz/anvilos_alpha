{
  "module_name": "sun4i-spdif.c",
  "hash_id": "614b2ef1a828dc6b561c44d55959c394c052eda8e298d173734f020bcdfcc083",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sunxi/sun4i-spdif.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/regmap.h>\n#include <linux/of_address.h>\n#include <linux/of_device.h>\n#include <linux/ioport.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/reset.h>\n#include <linux/spinlock.h>\n#include <sound/asoundef.h>\n#include <sound/dmaengine_pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#define\tSUN4I_SPDIF_CTL\t\t(0x00)\n\t#define SUN4I_SPDIF_CTL_MCLKDIV(v)\t\t((v) << 4)  \n\t#define SUN4I_SPDIF_CTL_MCLKOUTEN\t\tBIT(2)\n\t#define SUN4I_SPDIF_CTL_GEN\t\t\tBIT(1)\n\t#define SUN4I_SPDIF_CTL_RESET\t\t\tBIT(0)\n\n#define SUN4I_SPDIF_TXCFG\t(0x04)\n\t#define SUN4I_SPDIF_TXCFG_SINGLEMOD\t\tBIT(31)\n\t#define SUN4I_SPDIF_TXCFG_ASS\t\t\tBIT(17)\n\t#define SUN4I_SPDIF_TXCFG_NONAUDIO\t\tBIT(16)\n\t#define SUN4I_SPDIF_TXCFG_TXRATIO(v)\t\t((v) << 4)\n\t#define SUN4I_SPDIF_TXCFG_TXRATIO_MASK\t\tGENMASK(8, 4)\n\t#define SUN4I_SPDIF_TXCFG_FMTRVD\t\tGENMASK(3, 2)\n\t#define SUN4I_SPDIF_TXCFG_FMT16BIT\t\t(0 << 2)\n\t#define SUN4I_SPDIF_TXCFG_FMT20BIT\t\t(1 << 2)\n\t#define SUN4I_SPDIF_TXCFG_FMT24BIT\t\t(2 << 2)\n\t#define SUN4I_SPDIF_TXCFG_CHSTMODE\t\tBIT(1)\n\t#define SUN4I_SPDIF_TXCFG_TXEN\t\t\tBIT(0)\n\n#define SUN4I_SPDIF_RXCFG\t(0x08)\n\t#define SUN4I_SPDIF_RXCFG_LOCKFLAG\t\tBIT(4)\n\t#define SUN4I_SPDIF_RXCFG_CHSTSRC\t\tBIT(3)\n\t#define SUN4I_SPDIF_RXCFG_CHSTCP\t\tBIT(1)\n\t#define SUN4I_SPDIF_RXCFG_RXEN\t\t\tBIT(0)\n\n#define SUN4I_SPDIF_TXFIFO\t(0x0C)\n\n#define SUN4I_SPDIF_RXFIFO\t(0x10)\n\n#define SUN4I_SPDIF_FCTL\t(0x14)\n\t#define SUN4I_SPDIF_FCTL_FIFOSRC\t\tBIT(31)\n\t#define SUN4I_SPDIF_FCTL_FTX\t\t\tBIT(17)\n\t#define SUN4I_SPDIF_FCTL_FRX\t\t\tBIT(16)\n\t#define SUN4I_SPDIF_FCTL_TXTL(v)\t\t((v) << 8)\n\t#define SUN4I_SPDIF_FCTL_TXTL_MASK\t\tGENMASK(12, 8)\n\t#define SUN4I_SPDIF_FCTL_RXTL(v)\t\t((v) << 3)\n\t#define SUN4I_SPDIF_FCTL_RXTL_MASK\t\tGENMASK(7, 3)\n\t#define SUN4I_SPDIF_FCTL_TXIM\t\t\tBIT(2)\n\t#define SUN4I_SPDIF_FCTL_RXOM(v)\t\t((v) << 0)\n\t#define SUN4I_SPDIF_FCTL_RXOM_MASK\t\tGENMASK(1, 0)\n\n#define SUN50I_H6_SPDIF_FCTL (0x14)\n\t#define SUN50I_H6_SPDIF_FCTL_HUB_EN\t\tBIT(31)\n\t#define SUN50I_H6_SPDIF_FCTL_FTX\t\tBIT(30)\n\t#define SUN50I_H6_SPDIF_FCTL_FRX\t\tBIT(29)\n\t#define SUN50I_H6_SPDIF_FCTL_TXTL(v)\t\t((v) << 12)\n\t#define SUN50I_H6_SPDIF_FCTL_TXTL_MASK\t\tGENMASK(19, 12)\n\t#define SUN50I_H6_SPDIF_FCTL_RXTL(v)\t\t((v) << 4)\n\t#define SUN50I_H6_SPDIF_FCTL_RXTL_MASK\t\tGENMASK(10, 4)\n\t#define SUN50I_H6_SPDIF_FCTL_TXIM\t\tBIT(2)\n\t#define SUN50I_H6_SPDIF_FCTL_RXOM(v)\t\t((v) << 0)\n\t#define SUN50I_H6_SPDIF_FCTL_RXOM_MASK\t\tGENMASK(1, 0)\n\n#define SUN4I_SPDIF_FSTA\t(0x18)\n\t#define SUN4I_SPDIF_FSTA_TXE\t\t\tBIT(14)\n\t#define SUN4I_SPDIF_FSTA_TXECNTSHT\t\t(8)\n\t#define SUN4I_SPDIF_FSTA_RXA\t\t\tBIT(6)\n\t#define SUN4I_SPDIF_FSTA_RXACNTSHT\t\t(0)\n\n#define SUN4I_SPDIF_INT\t\t(0x1C)\n\t#define SUN4I_SPDIF_INT_RXLOCKEN\t\tBIT(18)\n\t#define SUN4I_SPDIF_INT_RXUNLOCKEN\t\tBIT(17)\n\t#define SUN4I_SPDIF_INT_RXPARERREN\t\tBIT(16)\n\t#define SUN4I_SPDIF_INT_TXDRQEN\t\t\tBIT(7)\n\t#define SUN4I_SPDIF_INT_TXUIEN\t\t\tBIT(6)\n\t#define SUN4I_SPDIF_INT_TXOIEN\t\t\tBIT(5)\n\t#define SUN4I_SPDIF_INT_TXEIEN\t\t\tBIT(4)\n\t#define SUN4I_SPDIF_INT_RXDRQEN\t\t\tBIT(2)\n\t#define SUN4I_SPDIF_INT_RXOIEN\t\t\tBIT(1)\n\t#define SUN4I_SPDIF_INT_RXAIEN\t\t\tBIT(0)\n\n#define SUN4I_SPDIF_ISTA\t(0x20)\n\t#define SUN4I_SPDIF_ISTA_RXLOCKSTA\t\tBIT(18)\n\t#define SUN4I_SPDIF_ISTA_RXUNLOCKSTA\t\tBIT(17)\n\t#define SUN4I_SPDIF_ISTA_RXPARERRSTA\t\tBIT(16)\n\t#define SUN4I_SPDIF_ISTA_TXUSTA\t\t\tBIT(6)\n\t#define SUN4I_SPDIF_ISTA_TXOSTA\t\t\tBIT(5)\n\t#define SUN4I_SPDIF_ISTA_TXESTA\t\t\tBIT(4)\n\t#define SUN4I_SPDIF_ISTA_RXOSTA\t\t\tBIT(1)\n\t#define SUN4I_SPDIF_ISTA_RXASTA\t\t\tBIT(0)\n\n#define SUN8I_SPDIF_TXFIFO\t(0x20)\n\n#define SUN4I_SPDIF_TXCNT\t(0x24)\n\n#define SUN4I_SPDIF_RXCNT\t(0x28)\n\n#define SUN4I_SPDIF_TXCHSTA0\t(0x2C)\n\t#define SUN4I_SPDIF_TXCHSTA0_CLK(v)\t\t((v) << 28)\n\t#define SUN4I_SPDIF_TXCHSTA0_SAMFREQ(v)\t\t((v) << 24)\n\t#define SUN4I_SPDIF_TXCHSTA0_SAMFREQ_MASK\tGENMASK(27, 24)\n\t#define SUN4I_SPDIF_TXCHSTA0_CHNUM(v)\t\t((v) << 20)\n\t#define SUN4I_SPDIF_TXCHSTA0_CHNUM_MASK\t\tGENMASK(23, 20)\n\t#define SUN4I_SPDIF_TXCHSTA0_SRCNUM(v)\t\t((v) << 16)\n\t#define SUN4I_SPDIF_TXCHSTA0_CATACOD(v)\t\t((v) << 8)\n\t#define SUN4I_SPDIF_TXCHSTA0_MODE(v)\t\t((v) << 6)\n\t#define SUN4I_SPDIF_TXCHSTA0_EMPHASIS(v)\t((v) << 3)\n\t#define SUN4I_SPDIF_TXCHSTA0_CP\t\t\tBIT(2)\n\t#define SUN4I_SPDIF_TXCHSTA0_AUDIO\t\tBIT(1)\n\t#define SUN4I_SPDIF_TXCHSTA0_PRO\t\tBIT(0)\n\n#define SUN4I_SPDIF_TXCHSTA1\t(0x30)\n\t#define SUN4I_SPDIF_TXCHSTA1_CGMSA(v)\t\t((v) << 8)\n\t#define SUN4I_SPDIF_TXCHSTA1_ORISAMFREQ(v)\t((v) << 4)\n\t#define SUN4I_SPDIF_TXCHSTA1_ORISAMFREQ_MASK\tGENMASK(7, 4)\n\t#define SUN4I_SPDIF_TXCHSTA1_SAMWORDLEN(v)\t((v) << 1)\n\t#define SUN4I_SPDIF_TXCHSTA1_MAXWORDLEN\t\tBIT(0)\n\n#define SUN4I_SPDIF_RXCHSTA0\t(0x34)\n\t#define SUN4I_SPDIF_RXCHSTA0_CLK(v)\t\t((v) << 28)\n\t#define SUN4I_SPDIF_RXCHSTA0_SAMFREQ(v)\t\t((v) << 24)\n\t#define SUN4I_SPDIF_RXCHSTA0_CHNUM(v)\t\t((v) << 20)\n\t#define SUN4I_SPDIF_RXCHSTA0_SRCNUM(v)\t\t((v) << 16)\n\t#define SUN4I_SPDIF_RXCHSTA0_CATACOD(v)\t\t((v) << 8)\n\t#define SUN4I_SPDIF_RXCHSTA0_MODE(v)\t\t((v) << 6)\n\t#define SUN4I_SPDIF_RXCHSTA0_EMPHASIS(v)\t((v) << 3)\n\t#define SUN4I_SPDIF_RXCHSTA0_CP\t\t\tBIT(2)\n\t#define SUN4I_SPDIF_RXCHSTA0_AUDIO\t\tBIT(1)\n\t#define SUN4I_SPDIF_RXCHSTA0_PRO\t\tBIT(0)\n\n#define SUN4I_SPDIF_RXCHSTA1\t(0x38)\n\t#define SUN4I_SPDIF_RXCHSTA1_CGMSA(v)\t\t((v) << 8)\n\t#define SUN4I_SPDIF_RXCHSTA1_ORISAMFREQ(v)\t((v) << 4)\n\t#define SUN4I_SPDIF_RXCHSTA1_SAMWORDLEN(v)\t((v) << 1)\n\t#define SUN4I_SPDIF_RXCHSTA1_MAXWORDLEN\t\tBIT(0)\n\n \n#define SUN4I_SPDIF_SAMFREQ_44_1KHZ\t\t0x0\n#define SUN4I_SPDIF_SAMFREQ_NOT_INDICATED\t0x1\n#define SUN4I_SPDIF_SAMFREQ_48KHZ\t\t0x2\n#define SUN4I_SPDIF_SAMFREQ_32KHZ\t\t0x3\n#define SUN4I_SPDIF_SAMFREQ_22_05KHZ\t\t0x4\n#define SUN4I_SPDIF_SAMFREQ_24KHZ\t\t0x6\n#define SUN4I_SPDIF_SAMFREQ_88_2KHZ\t\t0x8\n#define SUN4I_SPDIF_SAMFREQ_76_8KHZ\t\t0x9\n#define SUN4I_SPDIF_SAMFREQ_96KHZ\t\t0xa\n#define SUN4I_SPDIF_SAMFREQ_176_4KHZ\t\t0xc\n#define SUN4I_SPDIF_SAMFREQ_192KHZ\t\t0xe\n\n \nstruct sun4i_spdif_quirks {\n\tunsigned int reg_dac_txdata;\n\tbool has_reset;\n\tunsigned int val_fctl_ftx;\n};\n\nstruct sun4i_spdif_dev {\n\tstruct platform_device *pdev;\n\tstruct clk *spdif_clk;\n\tstruct clk *apb_clk;\n\tstruct reset_control *rst;\n\tstruct snd_soc_dai_driver cpu_dai_drv;\n\tstruct regmap *regmap;\n\tstruct snd_dmaengine_dai_dma_data dma_params_tx;\n\tconst struct sun4i_spdif_quirks *quirks;\n\tspinlock_t lock;\n};\n\nstatic void sun4i_spdif_configure(struct sun4i_spdif_dev *host)\n{\n\tconst struct sun4i_spdif_quirks *quirks = host->quirks;\n\n\t \n\tregmap_write(host->regmap, SUN4I_SPDIF_CTL, SUN4I_SPDIF_CTL_RESET);\n\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_FCTL,\n\t\t\t   quirks->val_fctl_ftx, quirks->val_fctl_ftx);\n\n\t \n\tregmap_write(host->regmap, SUN4I_SPDIF_TXCNT, 0);\n}\n\nstatic void sun4i_snd_txctrl_on(struct snd_pcm_substream *substream,\n\t\t\t\tstruct sun4i_spdif_dev *host)\n{\n\tif (substream->runtime->channels == 1)\n\t\tregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\n\t\t\t\t   SUN4I_SPDIF_TXCFG_SINGLEMOD,\n\t\t\t\t   SUN4I_SPDIF_TXCFG_SINGLEMOD);\n\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\n\t\t\t   SUN4I_SPDIF_TXCFG_TXEN, SUN4I_SPDIF_TXCFG_TXEN);\n\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_INT,\n\t\t\t   SUN4I_SPDIF_INT_TXDRQEN, SUN4I_SPDIF_INT_TXDRQEN);\n\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_CTL,\n\t\t\t   SUN4I_SPDIF_CTL_GEN, SUN4I_SPDIF_CTL_GEN);\n}\n\nstatic void sun4i_snd_txctrl_off(struct snd_pcm_substream *substream,\n\t\t\t\t struct sun4i_spdif_dev *host)\n{\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\n\t\t\t   SUN4I_SPDIF_TXCFG_TXEN, 0);\n\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_INT,\n\t\t\t   SUN4I_SPDIF_INT_TXDRQEN, 0);\n\n\t \n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_CTL,\n\t\t\t   SUN4I_SPDIF_CTL_GEN, 0);\n}\n\nstatic int sun4i_spdif_startup(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_soc_dai *cpu_dai)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(asoc_rtd_to_cpu(rtd, 0));\n\n\tif (substream->stream != SNDRV_PCM_STREAM_PLAYBACK)\n\t\treturn -EINVAL;\n\n\tsun4i_spdif_configure(host);\n\n\treturn 0;\n}\n\nstatic int sun4i_spdif_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t\t struct snd_soc_dai *cpu_dai)\n{\n\tint ret = 0;\n\tint fmt;\n\tunsigned long rate = params_rate(params);\n\tu32 mclk_div = 0;\n\tunsigned int mclk = 0;\n\tu32 reg_val;\n\tstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(cpu_dai);\n\tstruct platform_device *pdev = host->pdev;\n\n\t \n\tswitch (params_channels(params)) {\n\tcase 1:  \n\tcase 2:\n\t\tfmt = 0;\n\t\tbreak;\n\tcase 4:  \n\t\tfmt = SUN4I_SPDIF_TXCFG_NONAUDIO;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (params_format(params)) {\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tfmt |= SUN4I_SPDIF_TXCFG_FMT16BIT;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S20_3LE:\n\t\tfmt |= SUN4I_SPDIF_TXCFG_FMT20BIT;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S24_LE:\n\t\tfmt |= SUN4I_SPDIF_TXCFG_FMT24BIT;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (rate) {\n\tcase 22050:\n\tcase 44100:\n\tcase 88200:\n\tcase 176400:\n\t\tmclk = 22579200;\n\t\tbreak;\n\tcase 24000:\n\tcase 32000:\n\tcase 48000:\n\tcase 96000:\n\tcase 192000:\n\t\tmclk = 24576000;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = clk_set_rate(host->spdif_clk, mclk);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Setting SPDIF clock rate for %d Hz failed!\\n\", mclk);\n\t\treturn ret;\n\t}\n\n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_FCTL,\n\t\t\t   SUN4I_SPDIF_FCTL_TXIM, SUN4I_SPDIF_FCTL_TXIM);\n\n\tswitch (rate) {\n\tcase 22050:\n\tcase 24000:\n\t\tmclk_div = 8;\n\t\tbreak;\n\tcase 32000:\n\t\tmclk_div = 6;\n\t\tbreak;\n\tcase 44100:\n\tcase 48000:\n\t\tmclk_div = 4;\n\t\tbreak;\n\tcase 88200:\n\tcase 96000:\n\t\tmclk_div = 2;\n\t\tbreak;\n\tcase 176400:\n\tcase 192000:\n\t\tmclk_div = 1;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treg_val = 0;\n\treg_val |= SUN4I_SPDIF_TXCFG_ASS;\n\treg_val |= fmt;  \n\treg_val |= SUN4I_SPDIF_TXCFG_CHSTMODE;\n\treg_val |= SUN4I_SPDIF_TXCFG_TXRATIO(mclk_div - 1);\n\tregmap_write(host->regmap, SUN4I_SPDIF_TXCFG, reg_val);\n\n\treturn 0;\n}\n\nstatic int sun4i_spdif_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t\t       struct snd_soc_dai *dai)\n{\n\tint ret = 0;\n\tstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(dai);\n\n\tif (substream->stream != SNDRV_PCM_STREAM_PLAYBACK)\n\t\treturn -EINVAL;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tsun4i_snd_txctrl_on(substream, host);\n\t\tbreak;\n\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tsun4i_snd_txctrl_off(substream, host);\n\t\tbreak;\n\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int sun4i_spdif_info(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_info *uinfo)\n{\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_IEC958;\n\tuinfo->count = 1;\n\n\treturn 0;\n}\n\nstatic int sun4i_spdif_get_status_mask(struct snd_kcontrol *kcontrol,\n\t\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tu8 *status = ucontrol->value.iec958.status;\n\n\tstatus[0] = 0xff;\n\tstatus[1] = 0xff;\n\tstatus[2] = 0xff;\n\tstatus[3] = 0xff;\n\tstatus[4] = 0xff;\n\tstatus[5] = 0x03;\n\n\treturn 0;\n}\n\nstatic int sun4i_spdif_get_status(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\n\tstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(cpu_dai);\n\tu8 *status = ucontrol->value.iec958.status;\n\tunsigned long flags;\n\tunsigned int reg;\n\n\tspin_lock_irqsave(&host->lock, flags);\n\n\tregmap_read(host->regmap, SUN4I_SPDIF_TXCHSTA0, &reg);\n\n\tstatus[0] = reg & 0xff;\n\tstatus[1] = (reg >> 8) & 0xff;\n\tstatus[2] = (reg >> 16) & 0xff;\n\tstatus[3] = (reg >> 24) & 0xff;\n\n\tregmap_read(host->regmap, SUN4I_SPDIF_TXCHSTA1, &reg);\n\n\tstatus[4] = reg & 0xff;\n\tstatus[5] = (reg >> 8) & 0x3;\n\n\tspin_unlock_irqrestore(&host->lock, flags);\n\n\treturn 0;\n}\n\nstatic int sun4i_spdif_set_status(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\n\tstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(cpu_dai);\n\tu8 *status = ucontrol->value.iec958.status;\n\tunsigned long flags;\n\tunsigned int reg;\n\tbool chg0, chg1;\n\n\tspin_lock_irqsave(&host->lock, flags);\n\n\treg = (u32)status[3] << 24;\n\treg |= (u32)status[2] << 16;\n\treg |= (u32)status[1] << 8;\n\treg |= (u32)status[0];\n\n\tregmap_update_bits_check(host->regmap, SUN4I_SPDIF_TXCHSTA0,\n\t\t\t\t GENMASK(31,0), reg, &chg0);\n\n\treg = (u32)status[5] << 8;\n\treg |= (u32)status[4];\n\n\tregmap_update_bits_check(host->regmap, SUN4I_SPDIF_TXCHSTA1,\n\t\t\t\t GENMASK(9,0), reg, &chg1);\n\n\treg = SUN4I_SPDIF_TXCFG_CHSTMODE;\n\tif (status[0] & IEC958_AES0_NONAUDIO)\n\t\treg |= SUN4I_SPDIF_TXCFG_NONAUDIO;\n\n\tregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\n\t\t\t   SUN4I_SPDIF_TXCFG_CHSTMODE |\n\t\t\t   SUN4I_SPDIF_TXCFG_NONAUDIO, reg);\n\n\tspin_unlock_irqrestore(&host->lock, flags);\n\n\treturn chg0 || chg1;\n}\n\nstatic struct snd_kcontrol_new sun4i_spdif_controls[] = {\n\t{\n\t\t.access = SNDRV_CTL_ELEM_ACCESS_READ,\n\t\t.iface = SNDRV_CTL_ELEM_IFACE_PCM,\n\t\t.name = SNDRV_CTL_NAME_IEC958(\"\", PLAYBACK, MASK),\n\t\t.info = sun4i_spdif_info,\n\t\t.get = sun4i_spdif_get_status_mask\n\t},\n\t{\n\t\t.iface = SNDRV_CTL_ELEM_IFACE_PCM,\n\t\t.name = SNDRV_CTL_NAME_IEC958(\"\", PLAYBACK, DEFAULT),\n\t\t.info = sun4i_spdif_info,\n\t\t.get = sun4i_spdif_get_status,\n\t\t.put = sun4i_spdif_set_status\n\t}\n};\n\nstatic int sun4i_spdif_soc_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(dai);\n\n\tsnd_soc_dai_init_dma_data(dai, &host->dma_params_tx, NULL);\n\tsnd_soc_add_dai_controls(dai, sun4i_spdif_controls,\n\t\t\t\t ARRAY_SIZE(sun4i_spdif_controls));\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops sun4i_spdif_dai_ops = {\n\t.probe\t\t= sun4i_spdif_soc_dai_probe,\n\t.startup\t= sun4i_spdif_startup,\n\t.trigger\t= sun4i_spdif_trigger,\n\t.hw_params\t= sun4i_spdif_hw_params,\n};\n\nstatic const struct regmap_config sun4i_spdif_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.max_register = SUN4I_SPDIF_RXCHSTA1,\n};\n\n#define SUN4I_RATES\tSNDRV_PCM_RATE_8000_192000\n\n#define SUN4I_FORMATS\t(SNDRV_PCM_FORMAT_S16_LE | \\\n\t\t\t\tSNDRV_PCM_FORMAT_S20_3LE | \\\n\t\t\t\tSNDRV_PCM_FORMAT_S24_LE)\n\nstatic struct snd_soc_dai_driver sun4i_spdif_dai = {\n\t.playback = {\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = SUN4I_RATES,\n\t\t.formats = SUN4I_FORMATS,\n\t},\n\t.ops = &sun4i_spdif_dai_ops,\n\t.name = \"spdif\",\n};\n\nstatic const struct sun4i_spdif_quirks sun4i_a10_spdif_quirks = {\n\t.reg_dac_txdata\t= SUN4I_SPDIF_TXFIFO,\n\t.val_fctl_ftx   = SUN4I_SPDIF_FCTL_FTX,\n};\n\nstatic const struct sun4i_spdif_quirks sun6i_a31_spdif_quirks = {\n\t.reg_dac_txdata\t= SUN4I_SPDIF_TXFIFO,\n\t.val_fctl_ftx   = SUN4I_SPDIF_FCTL_FTX,\n\t.has_reset\t= true,\n};\n\nstatic const struct sun4i_spdif_quirks sun8i_h3_spdif_quirks = {\n\t.reg_dac_txdata\t= SUN8I_SPDIF_TXFIFO,\n\t.val_fctl_ftx   = SUN4I_SPDIF_FCTL_FTX,\n\t.has_reset\t= true,\n};\n\nstatic const struct sun4i_spdif_quirks sun50i_h6_spdif_quirks = {\n\t.reg_dac_txdata = SUN8I_SPDIF_TXFIFO,\n\t.val_fctl_ftx   = SUN50I_H6_SPDIF_FCTL_FTX,\n\t.has_reset      = true,\n};\n\nstatic const struct of_device_id sun4i_spdif_of_match[] = {\n\t{\n\t\t.compatible = \"allwinner,sun4i-a10-spdif\",\n\t\t.data = &sun4i_a10_spdif_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun6i-a31-spdif\",\n\t\t.data = &sun6i_a31_spdif_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-h3-spdif\",\n\t\t.data = &sun8i_h3_spdif_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun50i-h6-spdif\",\n\t\t.data = &sun50i_h6_spdif_quirks,\n\t},\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, sun4i_spdif_of_match);\n\nstatic const struct snd_soc_component_driver sun4i_spdif_component = {\n\t.name\t\t\t= \"sun4i-spdif\",\n\t.legacy_dai_naming\t= 1,\n};\n\nstatic int sun4i_spdif_runtime_suspend(struct device *dev)\n{\n\tstruct sun4i_spdif_dev *host  = dev_get_drvdata(dev);\n\n\tclk_disable_unprepare(host->spdif_clk);\n\tclk_disable_unprepare(host->apb_clk);\n\n\treturn 0;\n}\n\nstatic int sun4i_spdif_runtime_resume(struct device *dev)\n{\n\tstruct sun4i_spdif_dev *host  = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = clk_prepare_enable(host->spdif_clk);\n\tif (ret)\n\t\treturn ret;\n\tret = clk_prepare_enable(host->apb_clk);\n\tif (ret)\n\t\tclk_disable_unprepare(host->spdif_clk);\n\n\treturn ret;\n}\n\nstatic int sun4i_spdif_probe(struct platform_device *pdev)\n{\n\tstruct sun4i_spdif_dev *host;\n\tstruct resource *res;\n\tconst struct sun4i_spdif_quirks *quirks;\n\tint ret;\n\tvoid __iomem *base;\n\n\tdev_dbg(&pdev->dev, \"Entered %s\\n\", __func__);\n\n\thost = devm_kzalloc(&pdev->dev, sizeof(*host), GFP_KERNEL);\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\thost->pdev = pdev;\n\tspin_lock_init(&host->lock);\n\n\t \n\tmemcpy(&host->cpu_dai_drv, &sun4i_spdif_dai, sizeof(sun4i_spdif_dai));\n\thost->cpu_dai_drv.name = dev_name(&pdev->dev);\n\n\t \n\tbase = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tquirks = of_device_get_match_data(&pdev->dev);\n\tif (quirks == NULL) {\n\t\tdev_err(&pdev->dev, \"Failed to determine the quirks to use\\n\");\n\t\treturn -ENODEV;\n\t}\n\thost->quirks = quirks;\n\n\thost->regmap = devm_regmap_init_mmio(&pdev->dev, base,\n\t\t\t\t\t\t&sun4i_spdif_regmap_config);\n\n\t \n\thost->apb_clk = devm_clk_get(&pdev->dev, \"apb\");\n\tif (IS_ERR(host->apb_clk)) {\n\t\tdev_err(&pdev->dev, \"failed to get a apb clock.\\n\");\n\t\treturn PTR_ERR(host->apb_clk);\n\t}\n\n\thost->spdif_clk = devm_clk_get(&pdev->dev, \"spdif\");\n\tif (IS_ERR(host->spdif_clk)) {\n\t\tdev_err(&pdev->dev, \"failed to get a spdif clock.\\n\");\n\t\treturn PTR_ERR(host->spdif_clk);\n\t}\n\n\thost->dma_params_tx.addr = res->start + quirks->reg_dac_txdata;\n\thost->dma_params_tx.maxburst = 8;\n\thost->dma_params_tx.addr_width = DMA_SLAVE_BUSWIDTH_2_BYTES;\n\n\tplatform_set_drvdata(pdev, host);\n\n\tif (quirks->has_reset) {\n\t\thost->rst = devm_reset_control_get_optional_exclusive(&pdev->dev,\n\t\t\t\t\t\t\t\t      NULL);\n\t\tif (PTR_ERR(host->rst) == -EPROBE_DEFER) {\n\t\t\tret = -EPROBE_DEFER;\n\t\t\tdev_err(&pdev->dev, \"Failed to get reset: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t\tif (!IS_ERR(host->rst))\n\t\t\treset_control_deassert(host->rst);\n\t}\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t&sun4i_spdif_component, &sun4i_spdif_dai, 1);\n\tif (ret)\n\t\treturn ret;\n\n\tpm_runtime_enable(&pdev->dev);\n\tif (!pm_runtime_enabled(&pdev->dev)) {\n\t\tret = sun4i_spdif_runtime_resume(&pdev->dev);\n\t\tif (ret)\n\t\t\tgoto err_unregister;\n\t}\n\n\tret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\n\tif (ret)\n\t\tgoto err_suspend;\n\treturn 0;\nerr_suspend:\n\tif (!pm_runtime_status_suspended(&pdev->dev))\n\t\tsun4i_spdif_runtime_suspend(&pdev->dev);\nerr_unregister:\n\tpm_runtime_disable(&pdev->dev);\n\treturn ret;\n}\n\nstatic void sun4i_spdif_remove(struct platform_device *pdev)\n{\n\tpm_runtime_disable(&pdev->dev);\n\tif (!pm_runtime_status_suspended(&pdev->dev))\n\t\tsun4i_spdif_runtime_suspend(&pdev->dev);\n}\n\nstatic const struct dev_pm_ops sun4i_spdif_pm = {\n\tSET_RUNTIME_PM_OPS(sun4i_spdif_runtime_suspend,\n\t\t\t   sun4i_spdif_runtime_resume, NULL)\n};\n\nstatic struct platform_driver sun4i_spdif_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"sun4i-spdif\",\n\t\t.of_match_table = sun4i_spdif_of_match,\n\t\t.pm\t= &sun4i_spdif_pm,\n\t},\n\t.probe\t\t= sun4i_spdif_probe,\n\t.remove_new\t= sun4i_spdif_remove,\n};\n\nmodule_platform_driver(sun4i_spdif_driver);\n\nMODULE_AUTHOR(\"Marcus Cooper <codekipper@gmail.com>\");\nMODULE_AUTHOR(\"Andrea Venturi <be17068@iperbole.bo.it>\");\nMODULE_DESCRIPTION(\"Allwinner sun4i SPDIF SoC Interface\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:sun4i-spdif\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}