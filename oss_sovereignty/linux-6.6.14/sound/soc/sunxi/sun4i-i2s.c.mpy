{
  "module_name": "sun4i-i2s.c",
  "hash_id": "1e8d81695653de56e5278e78c7525a8602d74bc2ee6bebd4f1d5198a4846fb44",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sunxi/sun4i-i2s.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/dmaengine.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n#include <linux/reset.h>\n\n#include <sound/dmaengine_pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n\n#define SUN4I_I2S_CTRL_REG\t\t0x00\n#define SUN4I_I2S_CTRL_SDO_EN_MASK\t\tGENMASK(11, 8)\n#define SUN4I_I2S_CTRL_SDO_EN(sdo)\t\t\tBIT(8 + (sdo))\n#define SUN4I_I2S_CTRL_MODE_MASK\t\tBIT(5)\n#define SUN4I_I2S_CTRL_MODE_SLAVE\t\t\t(1 << 5)\n#define SUN4I_I2S_CTRL_MODE_MASTER\t\t\t(0 << 5)\n#define SUN4I_I2S_CTRL_TX_EN\t\t\tBIT(2)\n#define SUN4I_I2S_CTRL_RX_EN\t\t\tBIT(1)\n#define SUN4I_I2S_CTRL_GL_EN\t\t\tBIT(0)\n\n#define SUN4I_I2S_FMT0_REG\t\t0x04\n#define SUN4I_I2S_FMT0_LRCLK_POLARITY_MASK\tBIT(7)\n#define SUN4I_I2S_FMT0_LRCLK_POLARITY_INVERTED\t\t(1 << 7)\n#define SUN4I_I2S_FMT0_LRCLK_POLARITY_NORMAL\t\t(0 << 7)\n#define SUN4I_I2S_FMT0_BCLK_POLARITY_MASK\tBIT(6)\n#define SUN4I_I2S_FMT0_BCLK_POLARITY_INVERTED\t\t(1 << 6)\n#define SUN4I_I2S_FMT0_BCLK_POLARITY_NORMAL\t\t(0 << 6)\n#define SUN4I_I2S_FMT0_SR_MASK\t\t\tGENMASK(5, 4)\n#define SUN4I_I2S_FMT0_SR(sr)\t\t\t\t((sr) << 4)\n#define SUN4I_I2S_FMT0_WSS_MASK\t\t\tGENMASK(3, 2)\n#define SUN4I_I2S_FMT0_WSS(wss)\t\t\t\t((wss) << 2)\n#define SUN4I_I2S_FMT0_FMT_MASK\t\t\tGENMASK(1, 0)\n#define SUN4I_I2S_FMT0_FMT_RIGHT_J\t\t\t(2 << 0)\n#define SUN4I_I2S_FMT0_FMT_LEFT_J\t\t\t(1 << 0)\n#define SUN4I_I2S_FMT0_FMT_I2S\t\t\t\t(0 << 0)\n\n#define SUN4I_I2S_FMT1_REG\t\t0x08\n#define SUN4I_I2S_FMT1_REG_SEXT_MASK\t\tBIT(8)\n#define SUN4I_I2S_FMT1_REG_SEXT(sext)\t\t\t((sext) << 8)\n\n#define SUN4I_I2S_FIFO_TX_REG\t\t0x0c\n#define SUN4I_I2S_FIFO_RX_REG\t\t0x10\n\n#define SUN4I_I2S_FIFO_CTRL_REG\t\t0x14\n#define SUN4I_I2S_FIFO_CTRL_FLUSH_TX\t\tBIT(25)\n#define SUN4I_I2S_FIFO_CTRL_FLUSH_RX\t\tBIT(24)\n#define SUN4I_I2S_FIFO_CTRL_TX_MODE_MASK\tBIT(2)\n#define SUN4I_I2S_FIFO_CTRL_TX_MODE(mode)\t\t((mode) << 2)\n#define SUN4I_I2S_FIFO_CTRL_RX_MODE_MASK\tGENMASK(1, 0)\n#define SUN4I_I2S_FIFO_CTRL_RX_MODE(mode)\t\t(mode)\n\n#define SUN4I_I2S_FIFO_STA_REG\t\t0x18\n\n#define SUN4I_I2S_DMA_INT_CTRL_REG\t0x1c\n#define SUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN\tBIT(7)\n#define SUN4I_I2S_DMA_INT_CTRL_RX_DRQ_EN\tBIT(3)\n\n#define SUN4I_I2S_INT_STA_REG\t\t0x20\n\n#define SUN4I_I2S_CLK_DIV_REG\t\t0x24\n#define SUN4I_I2S_CLK_DIV_MCLK_EN\t\tBIT(7)\n#define SUN4I_I2S_CLK_DIV_BCLK_MASK\t\tGENMASK(6, 4)\n#define SUN4I_I2S_CLK_DIV_BCLK(bclk)\t\t\t((bclk) << 4)\n#define SUN4I_I2S_CLK_DIV_MCLK_MASK\t\tGENMASK(3, 0)\n#define SUN4I_I2S_CLK_DIV_MCLK(mclk)\t\t\t((mclk) << 0)\n\n#define SUN4I_I2S_TX_CNT_REG\t\t0x28\n#define SUN4I_I2S_RX_CNT_REG\t\t0x2c\n\n#define SUN4I_I2S_TX_CHAN_SEL_REG\t0x30\n#define SUN4I_I2S_CHAN_SEL_MASK\t\t\tGENMASK(2, 0)\n#define SUN4I_I2S_CHAN_SEL(num_chan)\t\t(((num_chan) - 1) << 0)\n\n#define SUN4I_I2S_TX_CHAN_MAP_REG\t0x34\n#define SUN4I_I2S_TX_CHAN_MAP(chan, sample)\t((sample) << (chan << 2))\n\n#define SUN4I_I2S_RX_CHAN_SEL_REG\t0x38\n#define SUN4I_I2S_RX_CHAN_MAP_REG\t0x3c\n\n \n#define SUN8I_I2S_CTRL_BCLK_OUT\t\t\tBIT(18)\n#define SUN8I_I2S_CTRL_LRCK_OUT\t\t\tBIT(17)\n\n#define SUN8I_I2S_CTRL_MODE_MASK\t\tGENMASK(5, 4)\n#define SUN8I_I2S_CTRL_MODE_RIGHT\t\t(2 << 4)\n#define SUN8I_I2S_CTRL_MODE_LEFT\t\t(1 << 4)\n#define SUN8I_I2S_CTRL_MODE_PCM\t\t\t(0 << 4)\n\n#define SUN8I_I2S_FMT0_LRCLK_POLARITY_MASK\tBIT(19)\n#define SUN8I_I2S_FMT0_LRCLK_POLARITY_INVERTED\t\t(1 << 19)\n#define SUN8I_I2S_FMT0_LRCLK_POLARITY_NORMAL\t\t(0 << 19)\n#define SUN8I_I2S_FMT0_LRCK_PERIOD_MASK\t\tGENMASK(17, 8)\n#define SUN8I_I2S_FMT0_LRCK_PERIOD(period)\t((period - 1) << 8)\n#define SUN8I_I2S_FMT0_BCLK_POLARITY_MASK\tBIT(7)\n#define SUN8I_I2S_FMT0_BCLK_POLARITY_INVERTED\t\t(1 << 7)\n#define SUN8I_I2S_FMT0_BCLK_POLARITY_NORMAL\t\t(0 << 7)\n\n#define SUN8I_I2S_FMT1_REG_SEXT_MASK\t\tGENMASK(5, 4)\n#define SUN8I_I2S_FMT1_REG_SEXT(sext)\t\t\t((sext) << 4)\n\n#define SUN8I_I2S_INT_STA_REG\t\t0x0c\n#define SUN8I_I2S_FIFO_TX_REG\t\t0x20\n\n#define SUN8I_I2S_CHAN_CFG_REG\t\t0x30\n#define SUN8I_I2S_CHAN_CFG_RX_SLOT_NUM_MASK\tGENMASK(7, 4)\n#define SUN8I_I2S_CHAN_CFG_RX_SLOT_NUM(chan)\t((chan - 1) << 4)\n#define SUN8I_I2S_CHAN_CFG_TX_SLOT_NUM_MASK\tGENMASK(3, 0)\n#define SUN8I_I2S_CHAN_CFG_TX_SLOT_NUM(chan)\t(chan - 1)\n\n#define SUN8I_I2S_TX_CHAN_MAP_REG\t0x44\n#define SUN8I_I2S_TX_CHAN_SEL_REG\t0x34\n#define SUN8I_I2S_TX_CHAN_OFFSET_MASK\t\tGENMASK(13, 12)\n#define SUN8I_I2S_TX_CHAN_OFFSET(offset)\t(offset << 12)\n#define SUN8I_I2S_TX_CHAN_EN_MASK\t\tGENMASK(11, 4)\n#define SUN8I_I2S_TX_CHAN_EN(num_chan)\t\t(((1 << num_chan) - 1) << 4)\n\n#define SUN8I_I2S_RX_CHAN_SEL_REG\t0x54\n#define SUN8I_I2S_RX_CHAN_MAP_REG\t0x58\n\n \n#define SUN50I_H6_I2S_TX_CHAN_SEL_OFFSET_MASK\tGENMASK(21, 20)\n#define SUN50I_H6_I2S_TX_CHAN_SEL_OFFSET(offset)\t((offset) << 20)\n#define SUN50I_H6_I2S_TX_CHAN_SEL_MASK\t\tGENMASK(19, 16)\n#define SUN50I_H6_I2S_TX_CHAN_SEL(chan)\t\t((chan - 1) << 16)\n#define SUN50I_H6_I2S_TX_CHAN_EN_MASK\t\tGENMASK(15, 0)\n#define SUN50I_H6_I2S_TX_CHAN_EN(num_chan)\t(((1 << num_chan) - 1))\n\n#define SUN50I_H6_I2S_TX_CHAN_SEL_REG(pin)\t(0x34 + 4 * (pin))\n#define SUN50I_H6_I2S_TX_CHAN_MAP0_REG(pin)\t(0x44 + 8 * (pin))\n#define SUN50I_H6_I2S_TX_CHAN_MAP1_REG(pin)\t(0x48 + 8 * (pin))\n\n#define SUN50I_H6_I2S_RX_CHAN_SEL_REG\t0x64\n#define SUN50I_H6_I2S_RX_CHAN_MAP0_REG\t0x68\n#define SUN50I_H6_I2S_RX_CHAN_MAP1_REG\t0x6C\n\n#define SUN50I_R329_I2S_RX_CHAN_MAP0_REG 0x68\n#define SUN50I_R329_I2S_RX_CHAN_MAP1_REG 0x6c\n#define SUN50I_R329_I2S_RX_CHAN_MAP2_REG 0x70\n#define SUN50I_R329_I2S_RX_CHAN_MAP3_REG 0x74\n\nstruct sun4i_i2s;\n\n \nstruct sun4i_i2s_quirks {\n\tbool\t\t\t\thas_reset;\n\tunsigned int\t\t\treg_offset_txdata;\t \n\tconst struct regmap_config\t*sun4i_i2s_regmap;\n\n\t \n\tstruct reg_field\t\tfield_clkdiv_mclk_en;\n\tstruct reg_field\t\tfield_fmt_wss;\n\tstruct reg_field\t\tfield_fmt_sr;\n\n\tunsigned int\t\t\tnum_din_pins;\n\tunsigned int\t\t\tnum_dout_pins;\n\n\tconst struct sun4i_i2s_clk_div\t*bclk_dividers;\n\tunsigned int\t\t\tnum_bclk_dividers;\n\tconst struct sun4i_i2s_clk_div\t*mclk_dividers;\n\tunsigned int\t\t\tnum_mclk_dividers;\n\n\tunsigned long (*get_bclk_parent_rate)(const struct sun4i_i2s *i2s);\n\tint\t(*get_sr)(unsigned int width);\n\tint\t(*get_wss)(unsigned int width);\n\n\t \n\tint\t(*set_chan_cfg)(const struct sun4i_i2s *i2s,\n\t\t\t\tunsigned int channels,\tunsigned int slots,\n\t\t\t\tunsigned int slot_width);\n\tint\t(*set_fmt)(const struct sun4i_i2s *i2s, unsigned int fmt);\n};\n\nstruct sun4i_i2s {\n\tstruct clk\t*bus_clk;\n\tstruct clk\t*mod_clk;\n\tstruct regmap\t*regmap;\n\tstruct reset_control *rst;\n\n\tunsigned int\tformat;\n\tunsigned int\tmclk_freq;\n\tunsigned int\tslots;\n\tunsigned int\tslot_width;\n\n\tstruct snd_dmaengine_dai_dma_data\tcapture_dma_data;\n\tstruct snd_dmaengine_dai_dma_data\tplayback_dma_data;\n\n\t \n\tstruct regmap_field\t*field_clkdiv_mclk_en;\n\tstruct regmap_field\t*field_fmt_wss;\n\tstruct regmap_field\t*field_fmt_sr;\n\n\tconst struct sun4i_i2s_quirks\t*variant;\n};\n\nstruct sun4i_i2s_clk_div {\n\tu8\tdiv;\n\tu8\tval;\n};\n\nstatic const struct sun4i_i2s_clk_div sun4i_i2s_bclk_div[] = {\n\t{ .div = 2, .val = 0 },\n\t{ .div = 4, .val = 1 },\n\t{ .div = 6, .val = 2 },\n\t{ .div = 8, .val = 3 },\n\t{ .div = 12, .val = 4 },\n\t{ .div = 16, .val = 5 },\n\t \n};\n\nstatic const struct sun4i_i2s_clk_div sun4i_i2s_mclk_div[] = {\n\t{ .div = 1, .val = 0 },\n\t{ .div = 2, .val = 1 },\n\t{ .div = 4, .val = 2 },\n\t{ .div = 6, .val = 3 },\n\t{ .div = 8, .val = 4 },\n\t{ .div = 12, .val = 5 },\n\t{ .div = 16, .val = 6 },\n\t{ .div = 24, .val = 7 },\n\t \n};\n\nstatic const struct sun4i_i2s_clk_div sun8i_i2s_clk_div[] = {\n\t{ .div = 1, .val = 1 },\n\t{ .div = 2, .val = 2 },\n\t{ .div = 4, .val = 3 },\n\t{ .div = 6, .val = 4 },\n\t{ .div = 8, .val = 5 },\n\t{ .div = 12, .val = 6 },\n\t{ .div = 16, .val = 7 },\n\t{ .div = 24, .val = 8 },\n\t{ .div = 32, .val = 9 },\n\t{ .div = 48, .val = 10 },\n\t{ .div = 64, .val = 11 },\n\t{ .div = 96, .val = 12 },\n\t{ .div = 128, .val = 13 },\n\t{ .div = 176, .val = 14 },\n\t{ .div = 192, .val = 15 },\n};\n\nstatic unsigned long sun4i_i2s_get_bclk_parent_rate(const struct sun4i_i2s *i2s)\n{\n\treturn i2s->mclk_freq;\n}\n\nstatic unsigned long sun8i_i2s_get_bclk_parent_rate(const struct sun4i_i2s *i2s)\n{\n\treturn clk_get_rate(i2s->mod_clk);\n}\n\nstatic int sun4i_i2s_get_bclk_div(struct sun4i_i2s *i2s,\n\t\t\t\t  unsigned long parent_rate,\n\t\t\t\t  unsigned int sampling_rate,\n\t\t\t\t  unsigned int channels,\n\t\t\t\t  unsigned int word_size)\n{\n\tconst struct sun4i_i2s_clk_div *dividers = i2s->variant->bclk_dividers;\n\tint div = parent_rate / sampling_rate / word_size / channels;\n\tint i;\n\n\tfor (i = 0; i < i2s->variant->num_bclk_dividers; i++) {\n\t\tconst struct sun4i_i2s_clk_div *bdiv = &dividers[i];\n\n\t\tif (bdiv->div == div)\n\t\t\treturn bdiv->val;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int sun4i_i2s_get_mclk_div(struct sun4i_i2s *i2s,\n\t\t\t\t  unsigned long parent_rate,\n\t\t\t\t  unsigned long mclk_rate)\n{\n\tconst struct sun4i_i2s_clk_div *dividers = i2s->variant->mclk_dividers;\n\tint div = parent_rate / mclk_rate;\n\tint i;\n\n\tfor (i = 0; i < i2s->variant->num_mclk_dividers; i++) {\n\t\tconst struct sun4i_i2s_clk_div *mdiv = &dividers[i];\n\n\t\tif (mdiv->div == div)\n\t\t\treturn mdiv->val;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int sun4i_i2s_oversample_rates[] = { 128, 192, 256, 384, 512, 768 };\nstatic bool sun4i_i2s_oversample_is_valid(unsigned int oversample)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(sun4i_i2s_oversample_rates); i++)\n\t\tif (sun4i_i2s_oversample_rates[i] == oversample)\n\t\t\treturn true;\n\n\treturn false;\n}\n\nstatic int sun4i_i2s_set_clk_rate(struct snd_soc_dai *dai,\n\t\t\t\t  unsigned int rate,\n\t\t\t\t  unsigned int slots,\n\t\t\t\t  unsigned int slot_width)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tunsigned int oversample_rate, clk_rate, bclk_parent_rate;\n\tint bclk_div, mclk_div;\n\tint ret;\n\n\tswitch (rate) {\n\tcase 176400:\n\tcase 88200:\n\tcase 44100:\n\tcase 22050:\n\tcase 11025:\n\t\tclk_rate = 22579200;\n\t\tbreak;\n\n\tcase 192000:\n\tcase 128000:\n\tcase 96000:\n\tcase 64000:\n\tcase 48000:\n\tcase 32000:\n\tcase 24000:\n\tcase 16000:\n\tcase 12000:\n\tcase 8000:\n\t\tclk_rate = 24576000;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(dai->dev, \"Unsupported sample rate: %u\\n\", rate);\n\t\treturn -EINVAL;\n\t}\n\n\tret = clk_set_rate(i2s->mod_clk, clk_rate);\n\tif (ret)\n\t\treturn ret;\n\n\toversample_rate = i2s->mclk_freq / rate;\n\tif (!sun4i_i2s_oversample_is_valid(oversample_rate)) {\n\t\tdev_err(dai->dev, \"Unsupported oversample rate: %d\\n\",\n\t\t\toversample_rate);\n\t\treturn -EINVAL;\n\t}\n\n\tbclk_parent_rate = i2s->variant->get_bclk_parent_rate(i2s);\n\tbclk_div = sun4i_i2s_get_bclk_div(i2s, bclk_parent_rate,\n\t\t\t\t\t  rate, slots, slot_width);\n\tif (bclk_div < 0) {\n\t\tdev_err(dai->dev, \"Unsupported BCLK divider: %d\\n\", bclk_div);\n\t\treturn -EINVAL;\n\t}\n\n\tmclk_div = sun4i_i2s_get_mclk_div(i2s, clk_rate, i2s->mclk_freq);\n\tif (mclk_div < 0) {\n\t\tdev_err(dai->dev, \"Unsupported MCLK divider: %d\\n\", mclk_div);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_write(i2s->regmap, SUN4I_I2S_CLK_DIV_REG,\n\t\t     SUN4I_I2S_CLK_DIV_BCLK(bclk_div) |\n\t\t     SUN4I_I2S_CLK_DIV_MCLK(mclk_div));\n\n\tregmap_field_write(i2s->field_clkdiv_mclk_en, 1);\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_get_sr(unsigned int width)\n{\n\tswitch (width) {\n\tcase 16:\n\t\treturn 0;\n\tcase 20:\n\t\treturn 1;\n\tcase 24:\n\t\treturn 2;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int sun4i_i2s_get_wss(unsigned int width)\n{\n\tswitch (width) {\n\tcase 16:\n\t\treturn 0;\n\tcase 20:\n\t\treturn 1;\n\tcase 24:\n\t\treturn 2;\n\tcase 32:\n\t\treturn 3;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int sun8i_i2s_get_sr_wss(unsigned int width)\n{\n\tswitch (width) {\n\tcase 8:\n\t\treturn 1;\n\tcase 12:\n\t\treturn 2;\n\tcase 16:\n\t\treturn 3;\n\tcase 20:\n\t\treturn 4;\n\tcase 24:\n\t\treturn 5;\n\tcase 28:\n\t\treturn 6;\n\tcase 32:\n\t\treturn 7;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int sun4i_i2s_set_chan_cfg(const struct sun4i_i2s *i2s,\n\t\t\t\t  unsigned int channels, unsigned int slots,\n\t\t\t\t  unsigned int slot_width)\n{\n\t \n\tregmap_write(i2s->regmap, SUN4I_I2S_TX_CHAN_MAP_REG, 0x76543210);\n\tregmap_write(i2s->regmap, SUN4I_I2S_RX_CHAN_MAP_REG, 0x00003210);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_TX_CHAN_SEL_REG,\n\t\t\t   SUN4I_I2S_CHAN_SEL_MASK,\n\t\t\t   SUN4I_I2S_CHAN_SEL(channels));\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_RX_CHAN_SEL_REG,\n\t\t\t   SUN4I_I2S_CHAN_SEL_MASK,\n\t\t\t   SUN4I_I2S_CHAN_SEL(channels));\n\n\treturn 0;\n}\n\nstatic int sun8i_i2s_set_chan_cfg(const struct sun4i_i2s *i2s,\n\t\t\t\t  unsigned int channels, unsigned int slots,\n\t\t\t\t  unsigned int slot_width)\n{\n\tunsigned int lrck_period;\n\n\t \n\tregmap_write(i2s->regmap, SUN8I_I2S_TX_CHAN_MAP_REG, 0x76543210);\n\tregmap_write(i2s->regmap, SUN8I_I2S_RX_CHAN_MAP_REG, 0x76543210);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_TX_CHAN_SEL_REG,\n\t\t\t   SUN4I_I2S_CHAN_SEL_MASK,\n\t\t\t   SUN4I_I2S_CHAN_SEL(channels));\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_RX_CHAN_SEL_REG,\n\t\t\t   SUN4I_I2S_CHAN_SEL_MASK,\n\t\t\t   SUN4I_I2S_CHAN_SEL(channels));\n\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_CHAN_CFG_REG,\n\t\t\t   SUN8I_I2S_CHAN_CFG_TX_SLOT_NUM_MASK,\n\t\t\t   SUN8I_I2S_CHAN_CFG_TX_SLOT_NUM(channels));\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_CHAN_CFG_REG,\n\t\t\t   SUN8I_I2S_CHAN_CFG_RX_SLOT_NUM_MASK,\n\t\t\t   SUN8I_I2S_CHAN_CFG_RX_SLOT_NUM(channels));\n\n\tswitch (i2s->format & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tlrck_period = slot_width * slots;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tlrck_period = slot_width;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\n\t\t\t   SUN8I_I2S_FMT0_LRCK_PERIOD_MASK,\n\t\t\t   SUN8I_I2S_FMT0_LRCK_PERIOD(lrck_period));\n\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_TX_CHAN_SEL_REG,\n\t\t\t   SUN8I_I2S_TX_CHAN_EN_MASK,\n\t\t\t   SUN8I_I2S_TX_CHAN_EN(channels));\n\n\treturn 0;\n}\n\nstatic int sun50i_h6_i2s_set_chan_cfg(const struct sun4i_i2s *i2s,\n\t\t\t\t      unsigned int channels, unsigned int slots,\n\t\t\t\t      unsigned int slot_width)\n{\n\tunsigned int lrck_period;\n\n\t \n\tregmap_write(i2s->regmap, SUN50I_H6_I2S_TX_CHAN_MAP0_REG(0), 0xFEDCBA98);\n\tregmap_write(i2s->regmap, SUN50I_H6_I2S_TX_CHAN_MAP1_REG(0), 0x76543210);\n\tif (i2s->variant->num_din_pins > 1) {\n\t\tregmap_write(i2s->regmap, SUN50I_R329_I2S_RX_CHAN_MAP0_REG, 0x0F0E0D0C);\n\t\tregmap_write(i2s->regmap, SUN50I_R329_I2S_RX_CHAN_MAP1_REG, 0x0B0A0908);\n\t\tregmap_write(i2s->regmap, SUN50I_R329_I2S_RX_CHAN_MAP2_REG, 0x07060504);\n\t\tregmap_write(i2s->regmap, SUN50I_R329_I2S_RX_CHAN_MAP3_REG, 0x03020100);\n\t} else {\n\t\tregmap_write(i2s->regmap, SUN50I_H6_I2S_RX_CHAN_MAP0_REG, 0xFEDCBA98);\n\t\tregmap_write(i2s->regmap, SUN50I_H6_I2S_RX_CHAN_MAP1_REG, 0x76543210);\n\t}\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN50I_H6_I2S_TX_CHAN_SEL_REG(0),\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL_MASK,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL(channels));\n\tregmap_update_bits(i2s->regmap, SUN50I_H6_I2S_RX_CHAN_SEL_REG,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL_MASK,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL(channels));\n\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_CHAN_CFG_REG,\n\t\t\t   SUN8I_I2S_CHAN_CFG_TX_SLOT_NUM_MASK,\n\t\t\t   SUN8I_I2S_CHAN_CFG_TX_SLOT_NUM(channels));\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_CHAN_CFG_REG,\n\t\t\t   SUN8I_I2S_CHAN_CFG_RX_SLOT_NUM_MASK,\n\t\t\t   SUN8I_I2S_CHAN_CFG_RX_SLOT_NUM(channels));\n\n\tswitch (i2s->format & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tlrck_period = slot_width * slots;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tlrck_period = slot_width;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\n\t\t\t   SUN8I_I2S_FMT0_LRCK_PERIOD_MASK,\n\t\t\t   SUN8I_I2S_FMT0_LRCK_PERIOD(lrck_period));\n\n\tregmap_update_bits(i2s->regmap, SUN50I_H6_I2S_TX_CHAN_SEL_REG(0),\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_EN_MASK,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_EN(channels));\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_pcm_hw_params *params,\n\t\t\t       struct snd_soc_dai *dai)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tunsigned int word_size = params_width(params);\n\tunsigned int slot_width = params_physical_width(params);\n\tunsigned int channels = params_channels(params);\n\n\tunsigned int slots = channels;\n\n\tint ret, sr, wss;\n\tu32 width;\n\n\tif (i2s->slots)\n\t\tslots = i2s->slots;\n\n\tif (i2s->slot_width)\n\t\tslot_width = i2s->slot_width;\n\n\tret = i2s->variant->set_chan_cfg(i2s, channels, slots, slot_width);\n\tif (ret < 0) {\n\t\tdev_err(dai->dev, \"Invalid channel configuration\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FIFO_CTRL_REG,\n\t\t\t   SUN4I_I2S_FIFO_CTRL_TX_MODE_MASK |\n\t\t\t   SUN4I_I2S_FIFO_CTRL_RX_MODE_MASK,\n\t\t\t   SUN4I_I2S_FIFO_CTRL_TX_MODE(1) |\n\t\t\t   SUN4I_I2S_FIFO_CTRL_RX_MODE(1));\n\n\tswitch (params_physical_width(params)) {\n\tcase 16:\n\t\twidth = DMA_SLAVE_BUSWIDTH_2_BYTES;\n\t\tbreak;\n\tcase 32:\n\t\twidth = DMA_SLAVE_BUSWIDTH_4_BYTES;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dai->dev, \"Unsupported physical sample width: %d\\n\",\n\t\t\tparams_physical_width(params));\n\t\treturn -EINVAL;\n\t}\n\ti2s->playback_dma_data.addr_width = width;\n\n\tsr = i2s->variant->get_sr(word_size);\n\tif (sr < 0)\n\t\treturn -EINVAL;\n\n\twss = i2s->variant->get_wss(slot_width);\n\tif (wss < 0)\n\t\treturn -EINVAL;\n\n\tregmap_field_write(i2s->field_fmt_wss, wss);\n\tregmap_field_write(i2s->field_fmt_sr, sr);\n\n\treturn sun4i_i2s_set_clk_rate(dai, params_rate(params),\n\t\t\t\t      slots, slot_width);\n}\n\nstatic int sun4i_i2s_set_soc_fmt(const struct sun4i_i2s *i2s,\n\t\t\t\t unsigned int fmt)\n{\n\tu32 val;\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\t \n\t\tval = SUN4I_I2S_FMT0_BCLK_POLARITY_INVERTED |\n\t\t      SUN4I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\t \n\t\tval = SUN4I_I2S_FMT0_BCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\t \n\t\tval = SUN4I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tval = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\n\t\t\t   SUN4I_I2S_FMT0_LRCLK_POLARITY_MASK |\n\t\t\t   SUN4I_I2S_FMT0_BCLK_POLARITY_MASK,\n\t\t\t   val);\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tval = SUN4I_I2S_FMT0_FMT_I2S;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tval = SUN4I_I2S_FMT0_FMT_LEFT_J;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\tval = SUN4I_I2S_FMT0_FMT_RIGHT_J;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\n\t\t\t   SUN4I_I2S_FMT0_FMT_MASK, val);\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\t \n\t\tval = SUN4I_I2S_CTRL_MODE_MASTER;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_BC_FC:\n\t\t \n\t\tval = SUN4I_I2S_CTRL_MODE_SLAVE;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_MODE_MASK, val);\n\n\treturn 0;\n}\n\nstatic int sun8i_i2s_set_soc_fmt(const struct sun4i_i2s *i2s,\n\t\t\t\t unsigned int fmt)\n{\n\tu32 mode, val;\n\tu8 offset;\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\t \n\t\tval = SUN8I_I2S_FMT0_BCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\t \n\t\tval = SUN8I_I2S_FMT0_BCLK_POLARITY_INVERTED |\n\t\t      SUN8I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\t \n\t\tval = 0;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tval = SUN8I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\n\t\t\t   SUN8I_I2S_FMT0_LRCLK_POLARITY_MASK |\n\t\t\t   SUN8I_I2S_FMT0_BCLK_POLARITY_MASK,\n\t\t\t   val);\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tmode = SUN8I_I2S_CTRL_MODE_PCM;\n\t\toffset = 1;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tmode = SUN8I_I2S_CTRL_MODE_PCM;\n\t\toffset = 0;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tmode = SUN8I_I2S_CTRL_MODE_LEFT;\n\t\toffset = 1;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tmode = SUN8I_I2S_CTRL_MODE_LEFT;\n\t\toffset = 0;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\tmode = SUN8I_I2S_CTRL_MODE_RIGHT;\n\t\toffset = 0;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN8I_I2S_CTRL_MODE_MASK, mode);\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_TX_CHAN_SEL_REG,\n\t\t\t   SUN8I_I2S_TX_CHAN_OFFSET_MASK,\n\t\t\t   SUN8I_I2S_TX_CHAN_OFFSET(offset));\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_RX_CHAN_SEL_REG,\n\t\t\t   SUN8I_I2S_TX_CHAN_OFFSET_MASK,\n\t\t\t   SUN8I_I2S_TX_CHAN_OFFSET(offset));\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\t \n\t\tval = SUN8I_I2S_CTRL_BCLK_OUT |\tSUN8I_I2S_CTRL_LRCK_OUT;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_BC_FC:\n\t\t \n\t\tval = 0;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN8I_I2S_CTRL_BCLK_OUT | SUN8I_I2S_CTRL_LRCK_OUT,\n\t\t\t   val);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT1_REG,\n\t\t\t   SUN8I_I2S_FMT1_REG_SEXT_MASK,\n\t\t\t   SUN8I_I2S_FMT1_REG_SEXT(0));\n\n\treturn 0;\n}\n\nstatic int sun50i_h6_i2s_set_soc_fmt(const struct sun4i_i2s *i2s,\n\t\t\t\t     unsigned int fmt)\n{\n\tu32 mode, val;\n\tu8 offset;\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\t \n\t\tval = SUN8I_I2S_FMT0_BCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\t \n\t\tval = SUN8I_I2S_FMT0_BCLK_POLARITY_INVERTED |\n\t\t      SUN8I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\t \n\t\tval = 0;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tval = SUN8I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\n\t\t\t   SUN8I_I2S_FMT0_LRCLK_POLARITY_MASK |\n\t\t\t   SUN8I_I2S_FMT0_BCLK_POLARITY_MASK,\n\t\t\t   val);\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tmode = SUN8I_I2S_CTRL_MODE_PCM;\n\t\toffset = 1;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tmode = SUN8I_I2S_CTRL_MODE_PCM;\n\t\toffset = 0;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tmode = SUN8I_I2S_CTRL_MODE_LEFT;\n\t\toffset = 1;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tmode = SUN8I_I2S_CTRL_MODE_LEFT;\n\t\toffset = 0;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\tmode = SUN8I_I2S_CTRL_MODE_RIGHT;\n\t\toffset = 0;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN8I_I2S_CTRL_MODE_MASK, mode);\n\tregmap_update_bits(i2s->regmap, SUN8I_I2S_TX_CHAN_SEL_REG,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL_OFFSET_MASK,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL_OFFSET(offset));\n\tregmap_update_bits(i2s->regmap, SUN50I_H6_I2S_RX_CHAN_SEL_REG,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL_OFFSET_MASK,\n\t\t\t   SUN50I_H6_I2S_TX_CHAN_SEL_OFFSET(offset));\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\t \n\t\tval = SUN8I_I2S_CTRL_BCLK_OUT |\tSUN8I_I2S_CTRL_LRCK_OUT;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_BC_FC:\n\t\t \n\t\tval = 0;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN8I_I2S_CTRL_BCLK_OUT | SUN8I_I2S_CTRL_LRCK_OUT,\n\t\t\t   val);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT1_REG,\n\t\t\t   SUN8I_I2S_FMT1_REG_SEXT_MASK,\n\t\t\t   SUN8I_I2S_FMT1_REG_SEXT(0));\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tint ret;\n\n\tret = i2s->variant->set_fmt(i2s, fmt);\n\tif (ret) {\n\t\tdev_err(dai->dev, \"Unsupported format configuration\\n\");\n\t\treturn ret;\n\t}\n\n\ti2s->format = fmt;\n\n\treturn 0;\n}\n\nstatic void sun4i_i2s_start_capture(struct sun4i_i2s *i2s)\n{\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FIFO_CTRL_REG,\n\t\t\t   SUN4I_I2S_FIFO_CTRL_FLUSH_RX,\n\t\t\t   SUN4I_I2S_FIFO_CTRL_FLUSH_RX);\n\n\t \n\tregmap_write(i2s->regmap, SUN4I_I2S_RX_CNT_REG, 0);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_RX_EN,\n\t\t\t   SUN4I_I2S_CTRL_RX_EN);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_DMA_INT_CTRL_REG,\n\t\t\t   SUN4I_I2S_DMA_INT_CTRL_RX_DRQ_EN,\n\t\t\t   SUN4I_I2S_DMA_INT_CTRL_RX_DRQ_EN);\n}\n\nstatic void sun4i_i2s_start_playback(struct sun4i_i2s *i2s)\n{\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_FIFO_CTRL_REG,\n\t\t\t   SUN4I_I2S_FIFO_CTRL_FLUSH_TX,\n\t\t\t   SUN4I_I2S_FIFO_CTRL_FLUSH_TX);\n\n\t \n\tregmap_write(i2s->regmap, SUN4I_I2S_TX_CNT_REG, 0);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_TX_EN,\n\t\t\t   SUN4I_I2S_CTRL_TX_EN);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_DMA_INT_CTRL_REG,\n\t\t\t   SUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN,\n\t\t\t   SUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN);\n}\n\nstatic void sun4i_i2s_stop_capture(struct sun4i_i2s *i2s)\n{\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_RX_EN,\n\t\t\t   0);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_DMA_INT_CTRL_REG,\n\t\t\t   SUN4I_I2S_DMA_INT_CTRL_RX_DRQ_EN,\n\t\t\t   0);\n}\n\nstatic void sun4i_i2s_stop_playback(struct sun4i_i2s *i2s)\n{\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_TX_EN,\n\t\t\t   0);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_DMA_INT_CTRL_REG,\n\t\t\t   SUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN,\n\t\t\t   0);\n}\n\nstatic int sun4i_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t\t     struct snd_soc_dai *dai)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\t\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\t\tsun4i_i2s_start_playback(i2s);\n\t\telse\n\t\t\tsun4i_i2s_start_capture(i2s);\n\t\tbreak;\n\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\t\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\t\tsun4i_i2s_stop_playback(i2s);\n\t\telse\n\t\t\tsun4i_i2s_stop_capture(i2s);\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_set_sysclk(struct snd_soc_dai *dai, int clk_id,\n\t\t\t\tunsigned int freq, int dir)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tif (clk_id != 0)\n\t\treturn -EINVAL;\n\n\ti2s->mclk_freq = freq;\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_set_tdm_slot(struct snd_soc_dai *dai,\n\t\t\t\t  unsigned int tx_mask, unsigned int rx_mask,\n\t\t\t\t  int slots, int slot_width)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tif (slots > 8)\n\t\treturn -EINVAL;\n\n\ti2s->slots = slots;\n\ti2s->slot_width = slot_width;\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tsnd_soc_dai_init_dma_data(dai,\n\t\t\t\t  &i2s->playback_dma_data,\n\t\t\t\t  &i2s->capture_dma_data);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops sun4i_i2s_dai_ops = {\n\t.probe\t\t= sun4i_i2s_dai_probe,\n\t.hw_params\t= sun4i_i2s_hw_params,\n\t.set_fmt\t= sun4i_i2s_set_fmt,\n\t.set_sysclk\t= sun4i_i2s_set_sysclk,\n\t.set_tdm_slot\t= sun4i_i2s_set_tdm_slot,\n\t.trigger\t= sun4i_i2s_trigger,\n};\n\n#define SUN4I_FORMATS\t(SNDRV_PCM_FMTBIT_S16_LE | \\\n\t\t\t SNDRV_PCM_FMTBIT_S20_LE | \\\n\t\t\t SNDRV_PCM_FMTBIT_S24_LE)\n\nstatic struct snd_soc_dai_driver sun4i_i2s_dai = {\n\t.capture = {\n\t\t.stream_name = \"Capture\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 8,\n\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t.formats = SUN4I_FORMATS,\n\t},\n\t.playback = {\n\t\t.stream_name = \"Playback\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 8,\n\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t.formats = SUN4I_FORMATS,\n\t},\n\t.ops = &sun4i_i2s_dai_ops,\n\t.symmetric_rate = 1,\n};\n\nstatic const struct snd_soc_component_driver sun4i_i2s_component = {\n\t.name\t\t\t= \"sun4i-dai\",\n\t.legacy_dai_naming\t= 1,\n};\n\nstatic bool sun4i_i2s_rd_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase SUN4I_I2S_FIFO_TX_REG:\n\t\treturn false;\n\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic bool sun4i_i2s_wr_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase SUN4I_I2S_FIFO_RX_REG:\n\tcase SUN4I_I2S_FIFO_STA_REG:\n\t\treturn false;\n\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic bool sun4i_i2s_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase SUN4I_I2S_FIFO_RX_REG:\n\tcase SUN4I_I2S_INT_STA_REG:\n\tcase SUN4I_I2S_RX_CNT_REG:\n\tcase SUN4I_I2S_TX_CNT_REG:\n\t\treturn true;\n\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool sun8i_i2s_rd_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase SUN8I_I2S_FIFO_TX_REG:\n\t\treturn false;\n\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic bool sun8i_i2s_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase SUN4I_I2S_FIFO_CTRL_REG:\n\tcase SUN4I_I2S_FIFO_RX_REG:\n\tcase SUN4I_I2S_FIFO_STA_REG:\n\tcase SUN4I_I2S_RX_CNT_REG:\n\tcase SUN4I_I2S_TX_CNT_REG:\n\tcase SUN8I_I2S_FIFO_TX_REG:\n\tcase SUN8I_I2S_INT_STA_REG:\n\t\treturn true;\n\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct reg_default sun4i_i2s_reg_defaults[] = {\n\t{ SUN4I_I2S_CTRL_REG, 0x00000000 },\n\t{ SUN4I_I2S_FMT0_REG, 0x0000000c },\n\t{ SUN4I_I2S_FMT1_REG, 0x00004020 },\n\t{ SUN4I_I2S_FIFO_CTRL_REG, 0x000400f0 },\n\t{ SUN4I_I2S_DMA_INT_CTRL_REG, 0x00000000 },\n\t{ SUN4I_I2S_CLK_DIV_REG, 0x00000000 },\n\t{ SUN4I_I2S_TX_CHAN_SEL_REG, 0x00000001 },\n\t{ SUN4I_I2S_TX_CHAN_MAP_REG, 0x76543210 },\n\t{ SUN4I_I2S_RX_CHAN_SEL_REG, 0x00000001 },\n\t{ SUN4I_I2S_RX_CHAN_MAP_REG, 0x00003210 },\n};\n\nstatic const struct reg_default sun8i_i2s_reg_defaults[] = {\n\t{ SUN4I_I2S_CTRL_REG, 0x00060000 },\n\t{ SUN4I_I2S_FMT0_REG, 0x00000033 },\n\t{ SUN4I_I2S_FMT1_REG, 0x00000030 },\n\t{ SUN4I_I2S_FIFO_CTRL_REG, 0x000400f0 },\n\t{ SUN4I_I2S_DMA_INT_CTRL_REG, 0x00000000 },\n\t{ SUN4I_I2S_CLK_DIV_REG, 0x00000000 },\n\t{ SUN8I_I2S_CHAN_CFG_REG, 0x00000000 },\n\t{ SUN8I_I2S_TX_CHAN_SEL_REG, 0x00000000 },\n\t{ SUN8I_I2S_TX_CHAN_MAP_REG, 0x00000000 },\n\t{ SUN8I_I2S_RX_CHAN_SEL_REG, 0x00000000 },\n\t{ SUN8I_I2S_RX_CHAN_MAP_REG, 0x00000000 },\n};\n\nstatic const struct reg_default sun50i_h6_i2s_reg_defaults[] = {\n\t{ SUN4I_I2S_CTRL_REG, 0x00060000 },\n\t{ SUN4I_I2S_FMT0_REG, 0x00000033 },\n\t{ SUN4I_I2S_FMT1_REG, 0x00000030 },\n\t{ SUN4I_I2S_FIFO_CTRL_REG, 0x000400f0 },\n\t{ SUN4I_I2S_DMA_INT_CTRL_REG, 0x00000000 },\n\t{ SUN4I_I2S_CLK_DIV_REG, 0x00000000 },\n\t{ SUN8I_I2S_CHAN_CFG_REG, 0x00000000 },\n\t{ SUN50I_H6_I2S_TX_CHAN_SEL_REG(0), 0x00000000 },\n\t{ SUN50I_H6_I2S_TX_CHAN_MAP0_REG(0), 0x00000000 },\n\t{ SUN50I_H6_I2S_TX_CHAN_MAP1_REG(0), 0x00000000 },\n\t{ SUN50I_H6_I2S_RX_CHAN_SEL_REG, 0x00000000 },\n\t{ SUN50I_H6_I2S_RX_CHAN_MAP0_REG, 0x00000000 },\n\t{ SUN50I_H6_I2S_RX_CHAN_MAP1_REG, 0x00000000 },\n};\n\nstatic const struct regmap_config sun4i_i2s_regmap_config = {\n\t.reg_bits\t= 32,\n\t.reg_stride\t= 4,\n\t.val_bits\t= 32,\n\t.max_register\t= SUN4I_I2S_RX_CHAN_MAP_REG,\n\n\t.cache_type\t= REGCACHE_FLAT,\n\t.reg_defaults\t= sun4i_i2s_reg_defaults,\n\t.num_reg_defaults\t= ARRAY_SIZE(sun4i_i2s_reg_defaults),\n\t.writeable_reg\t= sun4i_i2s_wr_reg,\n\t.readable_reg\t= sun4i_i2s_rd_reg,\n\t.volatile_reg\t= sun4i_i2s_volatile_reg,\n};\n\nstatic const struct regmap_config sun8i_i2s_regmap_config = {\n\t.reg_bits\t= 32,\n\t.reg_stride\t= 4,\n\t.val_bits\t= 32,\n\t.max_register\t= SUN8I_I2S_RX_CHAN_MAP_REG,\n\t.cache_type\t= REGCACHE_FLAT,\n\t.reg_defaults\t= sun8i_i2s_reg_defaults,\n\t.num_reg_defaults\t= ARRAY_SIZE(sun8i_i2s_reg_defaults),\n\t.writeable_reg\t= sun4i_i2s_wr_reg,\n\t.readable_reg\t= sun8i_i2s_rd_reg,\n\t.volatile_reg\t= sun8i_i2s_volatile_reg,\n};\n\nstatic const struct regmap_config sun50i_h6_i2s_regmap_config = {\n\t.reg_bits\t= 32,\n\t.reg_stride\t= 4,\n\t.val_bits\t= 32,\n\t.max_register\t= SUN50I_R329_I2S_RX_CHAN_MAP3_REG,\n\t.cache_type\t= REGCACHE_FLAT,\n\t.reg_defaults\t= sun50i_h6_i2s_reg_defaults,\n\t.num_reg_defaults\t= ARRAY_SIZE(sun50i_h6_i2s_reg_defaults),\n\t.writeable_reg\t= sun4i_i2s_wr_reg,\n\t.readable_reg\t= sun8i_i2s_rd_reg,\n\t.volatile_reg\t= sun8i_i2s_volatile_reg,\n};\n\nstatic int sun4i_i2s_runtime_resume(struct device *dev)\n{\n\tstruct sun4i_i2s *i2s = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = clk_prepare_enable(i2s->bus_clk);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to enable bus clock\\n\");\n\t\treturn ret;\n\t}\n\n\tregcache_cache_only(i2s->regmap, false);\n\tregcache_mark_dirty(i2s->regmap);\n\n\tret = regcache_sync(i2s->regmap);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to sync regmap cache\\n\");\n\t\tgoto err_disable_clk;\n\t}\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_GL_EN, SUN4I_I2S_CTRL_GL_EN);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_SDO_EN_MASK,\n\t\t\t   SUN4I_I2S_CTRL_SDO_EN(0));\n\n\tret = clk_prepare_enable(i2s->mod_clk);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to enable module clock\\n\");\n\t\tgoto err_disable_clk;\n\t}\n\n\treturn 0;\n\nerr_disable_clk:\n\tclk_disable_unprepare(i2s->bus_clk);\n\treturn ret;\n}\n\nstatic int sun4i_i2s_runtime_suspend(struct device *dev)\n{\n\tstruct sun4i_i2s *i2s = dev_get_drvdata(dev);\n\n\tclk_disable_unprepare(i2s->mod_clk);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_SDO_EN_MASK, 0);\n\n\t \n\tregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\n\t\t\t   SUN4I_I2S_CTRL_GL_EN, 0);\n\n\tregcache_cache_only(i2s->regmap, true);\n\n\tclk_disable_unprepare(i2s->bus_clk);\n\n\treturn 0;\n}\n\nstatic const struct sun4i_i2s_quirks sun4i_a10_i2s_quirks = {\n\t.has_reset\t\t= false,\n\t.reg_offset_txdata\t= SUN4I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun4i_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 7, 7),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 2, 3),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 5),\n\t.bclk_dividers\t\t= sun4i_i2s_bclk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun4i_i2s_bclk_div),\n\t.mclk_dividers\t\t= sun4i_i2s_mclk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun4i_i2s_mclk_div),\n\t.get_bclk_parent_rate\t= sun4i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun4i_i2s_get_sr,\n\t.get_wss\t\t= sun4i_i2s_get_wss,\n\t.set_chan_cfg\t\t= sun4i_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun4i_i2s_set_soc_fmt,\n};\n\nstatic const struct sun4i_i2s_quirks sun6i_a31_i2s_quirks = {\n\t.has_reset\t\t= true,\n\t.reg_offset_txdata\t= SUN4I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun4i_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 7, 7),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 2, 3),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 5),\n\t.bclk_dividers\t\t= sun4i_i2s_bclk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun4i_i2s_bclk_div),\n\t.mclk_dividers\t\t= sun4i_i2s_mclk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun4i_i2s_mclk_div),\n\t.get_bclk_parent_rate\t= sun4i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun4i_i2s_get_sr,\n\t.get_wss\t\t= sun4i_i2s_get_wss,\n\t.set_chan_cfg\t\t= sun4i_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun4i_i2s_set_soc_fmt,\n};\n\n \nstatic const struct sun4i_i2s_quirks sun8i_a83t_i2s_quirks = {\n\t.has_reset\t\t= true,\n\t.reg_offset_txdata\t= SUN8I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun4i_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 7, 7),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 2, 3),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 5),\n\t.bclk_dividers\t\t= sun4i_i2s_bclk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun4i_i2s_bclk_div),\n\t.mclk_dividers\t\t= sun4i_i2s_mclk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun4i_i2s_mclk_div),\n\t.get_bclk_parent_rate\t= sun4i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun4i_i2s_get_sr,\n\t.get_wss\t\t= sun4i_i2s_get_wss,\n\t.set_chan_cfg\t\t= sun4i_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun4i_i2s_set_soc_fmt,\n};\n\nstatic const struct sun4i_i2s_quirks sun8i_h3_i2s_quirks = {\n\t.has_reset\t\t= true,\n\t.reg_offset_txdata\t= SUN8I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun8i_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 8, 8),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 0, 2),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 6),\n\t.bclk_dividers\t\t= sun8i_i2s_clk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun8i_i2s_clk_div),\n\t.mclk_dividers\t\t= sun8i_i2s_clk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun8i_i2s_clk_div),\n\t.get_bclk_parent_rate\t= sun8i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun8i_i2s_get_sr_wss,\n\t.get_wss\t\t= sun8i_i2s_get_sr_wss,\n\t.set_chan_cfg\t\t= sun8i_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun8i_i2s_set_soc_fmt,\n};\n\nstatic const struct sun4i_i2s_quirks sun50i_a64_codec_i2s_quirks = {\n\t.has_reset\t\t= true,\n\t.reg_offset_txdata\t= SUN8I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun4i_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 7, 7),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 2, 3),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 5),\n\t.bclk_dividers\t\t= sun4i_i2s_bclk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun4i_i2s_bclk_div),\n\t.mclk_dividers\t\t= sun4i_i2s_mclk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun4i_i2s_mclk_div),\n\t.get_bclk_parent_rate\t= sun4i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun4i_i2s_get_sr,\n\t.get_wss\t\t= sun4i_i2s_get_wss,\n\t.set_chan_cfg\t\t= sun4i_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun4i_i2s_set_soc_fmt,\n};\n\nstatic const struct sun4i_i2s_quirks sun50i_h6_i2s_quirks = {\n\t.has_reset\t\t= true,\n\t.reg_offset_txdata\t= SUN8I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun50i_h6_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 8, 8),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 0, 2),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 6),\n\t.bclk_dividers\t\t= sun8i_i2s_clk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun8i_i2s_clk_div),\n\t.mclk_dividers\t\t= sun8i_i2s_clk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun8i_i2s_clk_div),\n\t.get_bclk_parent_rate\t= sun8i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun8i_i2s_get_sr_wss,\n\t.get_wss\t\t= sun8i_i2s_get_sr_wss,\n\t.set_chan_cfg\t\t= sun50i_h6_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun50i_h6_i2s_set_soc_fmt,\n};\n\nstatic const struct sun4i_i2s_quirks sun50i_r329_i2s_quirks = {\n\t.has_reset\t\t= true,\n\t.reg_offset_txdata\t= SUN8I_I2S_FIFO_TX_REG,\n\t.sun4i_i2s_regmap\t= &sun50i_h6_i2s_regmap_config,\n\t.field_clkdiv_mclk_en\t= REG_FIELD(SUN4I_I2S_CLK_DIV_REG, 8, 8),\n\t.field_fmt_wss\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 0, 2),\n\t.field_fmt_sr\t\t= REG_FIELD(SUN4I_I2S_FMT0_REG, 4, 6),\n\t.num_din_pins\t\t= 4,\n\t.num_dout_pins\t\t= 4,\n\t.bclk_dividers\t\t= sun8i_i2s_clk_div,\n\t.num_bclk_dividers\t= ARRAY_SIZE(sun8i_i2s_clk_div),\n\t.mclk_dividers\t\t= sun8i_i2s_clk_div,\n\t.num_mclk_dividers\t= ARRAY_SIZE(sun8i_i2s_clk_div),\n\t.get_bclk_parent_rate\t= sun8i_i2s_get_bclk_parent_rate,\n\t.get_sr\t\t\t= sun8i_i2s_get_sr_wss,\n\t.get_wss\t\t= sun8i_i2s_get_sr_wss,\n\t.set_chan_cfg\t\t= sun50i_h6_i2s_set_chan_cfg,\n\t.set_fmt\t\t= sun50i_h6_i2s_set_soc_fmt,\n};\n\nstatic int sun4i_i2s_init_regmap_fields(struct device *dev,\n\t\t\t\t\tstruct sun4i_i2s *i2s)\n{\n\ti2s->field_clkdiv_mclk_en =\n\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\ti2s->variant->field_clkdiv_mclk_en);\n\tif (IS_ERR(i2s->field_clkdiv_mclk_en))\n\t\treturn PTR_ERR(i2s->field_clkdiv_mclk_en);\n\n\ti2s->field_fmt_wss =\n\t\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\t\ti2s->variant->field_fmt_wss);\n\tif (IS_ERR(i2s->field_fmt_wss))\n\t\treturn PTR_ERR(i2s->field_fmt_wss);\n\n\ti2s->field_fmt_sr =\n\t\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\t\ti2s->variant->field_fmt_sr);\n\tif (IS_ERR(i2s->field_fmt_sr))\n\t\treturn PTR_ERR(i2s->field_fmt_sr);\n\n\treturn 0;\n}\n\nstatic int sun4i_i2s_probe(struct platform_device *pdev)\n{\n\tstruct sun4i_i2s *i2s;\n\tstruct resource *res;\n\tvoid __iomem *regs;\n\tint irq, ret;\n\n\ti2s = devm_kzalloc(&pdev->dev, sizeof(*i2s), GFP_KERNEL);\n\tif (!i2s)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, i2s);\n\n\tregs = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(regs))\n\t\treturn PTR_ERR(regs);\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\ti2s->variant = of_device_get_match_data(&pdev->dev);\n\tif (!i2s->variant) {\n\t\tdev_err(&pdev->dev, \"Failed to determine the quirks to use\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\ti2s->bus_clk = devm_clk_get(&pdev->dev, \"apb\");\n\tif (IS_ERR(i2s->bus_clk)) {\n\t\tdev_err(&pdev->dev, \"Can't get our bus clock\\n\");\n\t\treturn PTR_ERR(i2s->bus_clk);\n\t}\n\n\ti2s->regmap = devm_regmap_init_mmio(&pdev->dev, regs,\n\t\t\t\t\t    i2s->variant->sun4i_i2s_regmap);\n\tif (IS_ERR(i2s->regmap)) {\n\t\tdev_err(&pdev->dev, \"Regmap initialisation failed\\n\");\n\t\treturn PTR_ERR(i2s->regmap);\n\t}\n\n\ti2s->mod_clk = devm_clk_get(&pdev->dev, \"mod\");\n\tif (IS_ERR(i2s->mod_clk)) {\n\t\tdev_err(&pdev->dev, \"Can't get our mod clock\\n\");\n\t\treturn PTR_ERR(i2s->mod_clk);\n\t}\n\n\tif (i2s->variant->has_reset) {\n\t\ti2s->rst = devm_reset_control_get_exclusive(&pdev->dev, NULL);\n\t\tif (IS_ERR(i2s->rst)) {\n\t\t\tdev_err(&pdev->dev, \"Failed to get reset control\\n\");\n\t\t\treturn PTR_ERR(i2s->rst);\n\t\t}\n\t}\n\n\tif (!IS_ERR(i2s->rst)) {\n\t\tret = reset_control_deassert(i2s->rst);\n\t\tif (ret) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Failed to deassert the reset control\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\ti2s->playback_dma_data.addr = res->start +\n\t\t\t\t\ti2s->variant->reg_offset_txdata;\n\ti2s->playback_dma_data.maxburst = 8;\n\n\ti2s->capture_dma_data.addr = res->start + SUN4I_I2S_FIFO_RX_REG;\n\ti2s->capture_dma_data.maxburst = 8;\n\n\tpm_runtime_enable(&pdev->dev);\n\tif (!pm_runtime_enabled(&pdev->dev)) {\n\t\tret = sun4i_i2s_runtime_resume(&pdev->dev);\n\t\tif (ret)\n\t\t\tgoto err_pm_disable;\n\t}\n\n\tret = sun4i_i2s_init_regmap_fields(&pdev->dev, i2s);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Could not initialise regmap fields\\n\");\n\t\tgoto err_suspend;\n\t}\n\n\tret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Could not register PCM\\n\");\n\t\tgoto err_suspend;\n\t}\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t\t      &sun4i_i2s_component,\n\t\t\t\t\t      &sun4i_i2s_dai, 1);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Could not register DAI\\n\");\n\t\tgoto err_suspend;\n\t}\n\n\treturn 0;\n\nerr_suspend:\n\tif (!pm_runtime_status_suspended(&pdev->dev))\n\t\tsun4i_i2s_runtime_suspend(&pdev->dev);\nerr_pm_disable:\n\tpm_runtime_disable(&pdev->dev);\n\tif (!IS_ERR(i2s->rst))\n\t\treset_control_assert(i2s->rst);\n\n\treturn ret;\n}\n\nstatic void sun4i_i2s_remove(struct platform_device *pdev)\n{\n\tstruct sun4i_i2s *i2s = dev_get_drvdata(&pdev->dev);\n\n\tpm_runtime_disable(&pdev->dev);\n\tif (!pm_runtime_status_suspended(&pdev->dev))\n\t\tsun4i_i2s_runtime_suspend(&pdev->dev);\n\n\tif (!IS_ERR(i2s->rst))\n\t\treset_control_assert(i2s->rst);\n}\n\nstatic const struct of_device_id sun4i_i2s_match[] = {\n\t{\n\t\t.compatible = \"allwinner,sun4i-a10-i2s\",\n\t\t.data = &sun4i_a10_i2s_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun6i-a31-i2s\",\n\t\t.data = &sun6i_a31_i2s_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-a83t-i2s\",\n\t\t.data = &sun8i_a83t_i2s_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-h3-i2s\",\n\t\t.data = &sun8i_h3_i2s_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun50i-a64-codec-i2s\",\n\t\t.data = &sun50i_a64_codec_i2s_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun50i-h6-i2s\",\n\t\t.data = &sun50i_h6_i2s_quirks,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun50i-r329-i2s\",\n\t\t.data = &sun50i_r329_i2s_quirks,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, sun4i_i2s_match);\n\nstatic const struct dev_pm_ops sun4i_i2s_pm_ops = {\n\t.runtime_resume\t\t= sun4i_i2s_runtime_resume,\n\t.runtime_suspend\t= sun4i_i2s_runtime_suspend,\n};\n\nstatic struct platform_driver sun4i_i2s_driver = {\n\t.probe\t= sun4i_i2s_probe,\n\t.remove_new = sun4i_i2s_remove,\n\t.driver\t= {\n\t\t.name\t\t= \"sun4i-i2s\",\n\t\t.of_match_table\t= sun4i_i2s_match,\n\t\t.pm\t\t= &sun4i_i2s_pm_ops,\n\t},\n};\nmodule_platform_driver(sun4i_i2s_driver);\n\nMODULE_AUTHOR(\"Andrea Venturi <be17068@iperbole.bo.it>\");\nMODULE_AUTHOR(\"Maxime Ripard <maxime.ripard@free-electrons.com>\");\nMODULE_DESCRIPTION(\"Allwinner A10 I2S driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}