{
  "module_name": "acp-rt5645.c",
  "hash_id": "0bbd8341d838ce2c1bf009f6666d45535e144b019f4be4ad103bf5d677b4a799",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/amd/acp-rt5645.c",
  "human_readable_source": " \n\n#include <sound/core.h>\n#include <sound/soc.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc-dapm.h>\n#include <sound/jack.h>\n#include <linux/gpio.h>\n#include <linux/module.h>\n#include <linux/i2c.h>\n#include <linux/acpi.h>\n\n#include \"../codecs/rt5645.h\"\n\n#define CZ_PLAT_CLK 24000000\n\nstatic struct snd_soc_jack cz_jack;\nstatic struct snd_soc_jack_pin cz_jack_pins[] = {\n\t{\n\t\t.pin = \"Headphones\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int cz_aif1_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tint ret = 0;\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tret = snd_soc_dai_set_pll(codec_dai, 0, RT5645_PLL1_S_MCLK,\n\t\t\t\t  CZ_PLAT_CLK, params_rate(params) * 512);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set codec pll: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, RT5645_SCLK_S_PLL1,\n\t\t\t\tparams_rate(params) * 512, SND_SOC_CLOCK_OUT);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set codec sysclk: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic int cz_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tint ret;\n\tstruct snd_soc_card *card;\n\tstruct snd_soc_component *codec;\n\n\tcodec = asoc_rtd_to_codec(rtd, 0)->component;\n\tcard = rtd->card;\n\n\tret = snd_soc_card_jack_new_pins(card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADPHONE | SND_JACK_MICROPHONE |\n\t\t\t\t\t SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t SND_JACK_BTN_2 | SND_JACK_BTN_3,\n\t\t\t\t\t &cz_jack,\n\t\t\t\t\t cz_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(cz_jack_pins));\n\tif (ret) {\n\t\tdev_err(card->dev, \"HP jack creation failed %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trt5645_set_jack_detect(codec, &cz_jack, &cz_jack, &cz_jack);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops cz_aif1_ops = {\n\t.hw_params = cz_aif1_hw_params,\n};\n\nSND_SOC_DAILINK_DEF(designware1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"designware-i2s.1.auto\")));\nSND_SOC_DAILINK_DEF(designware2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"designware-i2s.2.auto\")));\n\nSND_SOC_DAILINK_DEF(codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-10EC5650:00\", \"rt5645-aif1\")));\n\nSND_SOC_DAILINK_DEF(platform,\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"acp_audio_dma.0.auto\")));\n\nstatic struct snd_soc_dai_link cz_dai_rt5650[] = {\n\t{\n\t\t.name = \"amd-rt5645-play\",\n\t\t.stream_name = \"RT5645_AIF1\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBP_CFP,\n\t\t.init = cz_init,\n\t\t.ops = &cz_aif1_ops,\n\t\tSND_SOC_DAILINK_REG(designware1, codec, platform),\n\t},\n\t{\n\t\t.name = \"amd-rt5645-cap\",\n\t\t.stream_name = \"RT5645_AIF1\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBP_CFP,\n\t\t.ops = &cz_aif1_ops,\n\t\tSND_SOC_DAILINK_REG(designware2, codec, platform),\n\t},\n};\n\nstatic const struct snd_soc_dapm_widget cz_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphones\", NULL),\n\tSND_SOC_DAPM_SPK(\"Speakers\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Int Mic\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route cz_audio_route[] = {\n\t{\"Headphones\", NULL, \"HPOL\"},\n\t{\"Headphones\", NULL, \"HPOR\"},\n\t{\"RECMIXL\", NULL, \"Headset Mic\"},\n\t{\"RECMIXR\", NULL, \"Headset Mic\"},\n\t{\"Speakers\", NULL, \"SPOL\"},\n\t{\"Speakers\", NULL, \"SPOR\"},\n\t{\"DMIC L2\", NULL, \"Int Mic\"},\n\t{\"DMIC R2\", NULL, \"Int Mic\"},\n};\n\nstatic const struct snd_kcontrol_new cz_mc_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphones\"),\n\tSOC_DAPM_PIN_SWITCH(\"Speakers\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Int Mic\"),\n};\n\nstatic struct snd_soc_card cz_card = {\n\t.name = \"acprt5650\",\n\t.owner = THIS_MODULE,\n\t.dai_link = cz_dai_rt5650,\n\t.num_links = ARRAY_SIZE(cz_dai_rt5650),\n\t.dapm_widgets = cz_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(cz_widgets),\n\t.dapm_routes = cz_audio_route,\n\t.num_dapm_routes = ARRAY_SIZE(cz_audio_route),\n\t.controls = cz_mc_controls,\n\t.num_controls = ARRAY_SIZE(cz_mc_controls),\n};\n\nstatic int cz_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tstruct snd_soc_card *card;\n\n\tcard = &cz_card;\n\tcz_card.dev = &pdev->dev;\n\tplatform_set_drvdata(pdev, card);\n\tret = devm_snd_soc_register_card(&pdev->dev, &cz_card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\t\"devm_snd_soc_register_card(%s) failed: %d\\n\",\n\t\t\t\tcz_card.name, ret);\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id cz_audio_acpi_match[] = {\n\t{ \"AMDI1002\", 0 },\n\t{},\n};\nMODULE_DEVICE_TABLE(acpi, cz_audio_acpi_match);\n#endif\n\nstatic struct platform_driver cz_pcm_driver = {\n\t.driver = {\n\t\t.name = \"cz-rt5645\",\n\t\t.acpi_match_table = ACPI_PTR(cz_audio_acpi_match),\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = cz_probe,\n};\n\nmodule_platform_driver(cz_pcm_driver);\n\nMODULE_AUTHOR(\"akshu.agrawal@amd.com\");\nMODULE_DESCRIPTION(\"cz-rt5645 audio support\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}