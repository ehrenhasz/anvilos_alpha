{
  "module_name": "smdk_spdif.c",
  "hash_id": "c8d2c4829e48dd4efb07b0cdb1d9f3dc4a55adca7ba1add5ff7961636b669e4b",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/smdk_spdif.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/module.h>\n\n#include <sound/soc.h>\n\n#include \"spdif.h\"\n\n \nstatic int set_audio_clock_heirachy(struct platform_device *pdev)\n{\n\tstruct clk *fout_epll, *mout_epll, *sclk_audio0, *sclk_spdif;\n\tint ret = 0;\n\n\tfout_epll = clk_get(NULL, \"fout_epll\");\n\tif (IS_ERR(fout_epll)) {\n\t\tprintk(KERN_WARNING \"%s: Cannot find fout_epll.\\n\",\n\t\t\t\t__func__);\n\t\treturn -EINVAL;\n\t}\n\n\tmout_epll = clk_get(NULL, \"mout_epll\");\n\tif (IS_ERR(mout_epll)) {\n\t\tprintk(KERN_WARNING \"%s: Cannot find mout_epll.\\n\",\n\t\t\t\t__func__);\n\t\tret = -EINVAL;\n\t\tgoto out1;\n\t}\n\n\tsclk_audio0 = clk_get(&pdev->dev, \"sclk_audio\");\n\tif (IS_ERR(sclk_audio0)) {\n\t\tprintk(KERN_WARNING \"%s: Cannot find sclk_audio.\\n\",\n\t\t\t\t__func__);\n\t\tret = -EINVAL;\n\t\tgoto out2;\n\t}\n\n\tsclk_spdif = clk_get(NULL, \"sclk_spdif\");\n\tif (IS_ERR(sclk_spdif)) {\n\t\tprintk(KERN_WARNING \"%s: Cannot find sclk_spdif.\\n\",\n\t\t\t\t__func__);\n\t\tret = -EINVAL;\n\t\tgoto out3;\n\t}\n\n\t \n\tclk_set_parent(mout_epll, fout_epll);\n\tclk_set_parent(sclk_audio0, mout_epll);\n\tclk_set_parent(sclk_spdif, sclk_audio0);\n\n\tclk_put(sclk_spdif);\nout3:\n\tclk_put(sclk_audio0);\nout2:\n\tclk_put(mout_epll);\nout1:\n\tclk_put(fout_epll);\n\n\treturn ret;\n}\n\n \nstatic int set_audio_clock_rate(unsigned long epll_rate,\n\t\t\t\tunsigned long audio_rate)\n{\n\tstruct clk *fout_epll, *sclk_spdif;\n\n\tfout_epll = clk_get(NULL, \"fout_epll\");\n\tif (IS_ERR(fout_epll)) {\n\t\tprintk(KERN_ERR \"%s: failed to get fout_epll\\n\", __func__);\n\t\treturn -ENOENT;\n\t}\n\n\tclk_set_rate(fout_epll, epll_rate);\n\tclk_put(fout_epll);\n\n\tsclk_spdif = clk_get(NULL, \"sclk_spdif\");\n\tif (IS_ERR(sclk_spdif)) {\n\t\tprintk(KERN_ERR \"%s: failed to get sclk_spdif\\n\", __func__);\n\t\treturn -ENOENT;\n\t}\n\n\tclk_set_rate(sclk_spdif, audio_rate);\n\tclk_put(sclk_spdif);\n\n\treturn 0;\n}\n\nstatic int smdk_hw_params(struct snd_pcm_substream *substream,\n\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tunsigned long pll_out, rclk_rate;\n\tint ret, ratio;\n\n\tswitch (params_rate(params)) {\n\tcase 44100:\n\t\tpll_out = 45158400;\n\t\tbreak;\n\tcase 32000:\n\tcase 48000:\n\tcase 96000:\n\t\tpll_out = 49152000;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tratio = 512;\n\trclk_rate = params_rate(params) * ratio;\n\n\t \n\tret = set_audio_clock_rate(pll_out, rclk_rate);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = snd_soc_dai_set_sysclk(cpu_dai, SND_SOC_SPDIF_INT_MCLK,\n\t\t\t\t\trclk_rate, SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops smdk_spdif_ops = {\n\t.hw_params = smdk_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(spdif,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-spdif\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"spdif-dit\", \"dit-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-spdif\")));\n\nstatic struct snd_soc_dai_link smdk_dai = {\n\t.name = \"S/PDIF\",\n\t.stream_name = \"S/PDIF PCM Playback\",\n\t.ops = &smdk_spdif_ops,\n\tSND_SOC_DAILINK_REG(spdif),\n};\n\nstatic struct snd_soc_card smdk = {\n\t.name = \"SMDK-S/PDIF\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &smdk_dai,\n\t.num_links = 1,\n};\n\nstatic struct platform_device *smdk_snd_spdif_dit_device;\nstatic struct platform_device *smdk_snd_spdif_device;\n\nstatic int __init smdk_init(void)\n{\n\tint ret;\n\n\tsmdk_snd_spdif_dit_device = platform_device_alloc(\"spdif-dit\", -1);\n\tif (!smdk_snd_spdif_dit_device)\n\t\treturn -ENOMEM;\n\n\tret = platform_device_add(smdk_snd_spdif_dit_device);\n\tif (ret)\n\t\tgoto err1;\n\n\tsmdk_snd_spdif_device = platform_device_alloc(\"soc-audio\", -1);\n\tif (!smdk_snd_spdif_device) {\n\t\tret = -ENOMEM;\n\t\tgoto err2;\n\t}\n\n\tplatform_set_drvdata(smdk_snd_spdif_device, &smdk);\n\n\tret = platform_device_add(smdk_snd_spdif_device);\n\tif (ret)\n\t\tgoto err3;\n\n\t \n\tret = set_audio_clock_heirachy(smdk_snd_spdif_device);\n\tif (ret)\n\t\tgoto err4;\n\n\treturn 0;\nerr4:\n\tplatform_device_del(smdk_snd_spdif_device);\nerr3:\n\tplatform_device_put(smdk_snd_spdif_device);\nerr2:\n\tplatform_device_del(smdk_snd_spdif_dit_device);\nerr1:\n\tplatform_device_put(smdk_snd_spdif_dit_device);\n\treturn ret;\n}\n\nstatic void __exit smdk_exit(void)\n{\n\tplatform_device_unregister(smdk_snd_spdif_device);\n\tplatform_device_unregister(smdk_snd_spdif_dit_device);\n}\n\nmodule_init(smdk_init);\nmodule_exit(smdk_exit);\n\nMODULE_AUTHOR(\"Seungwhan Youn, <sw.youn@samsung.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC SMDK+S/PDIF\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}