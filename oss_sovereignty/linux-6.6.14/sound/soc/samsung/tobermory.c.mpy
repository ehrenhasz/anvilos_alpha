{
  "module_name": "tobermory.c",
  "hash_id": "5f7e14f571e9198ff6f7c7522d16ecd415a57be2f120112e1a50f00deeb32c28",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/tobermory.c",
  "human_readable_source": "\n\n\n\n\n\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/jack.h>\n#include <linux/gpio.h>\n#include <linux/module.h>\n\n#include \"../codecs/wm8962.h\"\n\nstatic int sample_rate = 44100;\n\nstatic int tobermory_set_bias_level(struct snd_soc_card *card,\n\t\t\t\t\t  struct snd_soc_dapm_context *dapm,\n\t\t\t\t\t  enum snd_soc_bias_level level)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[0]);\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tif (dapm->dev != codec_dai->dev)\n\t\treturn 0;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tif (dapm->bias_level == SND_SOC_BIAS_STANDBY) {\n\t\t\tret = snd_soc_dai_set_pll(codec_dai, WM8962_FLL,\n\t\t\t\t\t\t  WM8962_FLL_MCLK, 32768,\n\t\t\t\t\t\t  sample_rate * 512);\n\t\t\tif (ret < 0)\n\t\t\t\tpr_err(\"Failed to start FLL: %d\\n\", ret);\n\n\t\t\tret = snd_soc_dai_set_sysclk(codec_dai,\n\t\t\t\t\t\t     WM8962_SYSCLK_FLL,\n\t\t\t\t\t\t     sample_rate * 512,\n\t\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\t\tif (ret < 0) {\n\t\t\t\tpr_err(\"Failed to set SYSCLK: %d\\n\", ret);\n\t\t\t\tsnd_soc_dai_set_pll(codec_dai, WM8962_FLL,\n\t\t\t\t\t\t    0, 0, 0);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int tobermory_set_bias_level_post(struct snd_soc_card *card,\n\t\t\t\t\t       struct snd_soc_dapm_context *dapm,\n\t\t\t\t\t       enum snd_soc_bias_level level)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[0]);\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tif (dapm->dev != codec_dai->dev)\n\t\treturn 0;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_STANDBY:\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, WM8962_SYSCLK_MCLK,\n\t\t\t\t\t     32768, SND_SOC_CLOCK_IN);\n\t\tif (ret < 0) {\n\t\t\tpr_err(\"Failed to switch away from FLL: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dai_set_pll(codec_dai, WM8962_FLL,\n\t\t\t\t\t  0, 0, 0);\n\t\tif (ret < 0) {\n\t\t\tpr_err(\"Failed to stop FLL: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tdapm->bias_level = level;\n\n\treturn 0;\n}\n\nstatic int tobermory_hw_params(struct snd_pcm_substream *substream,\n\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tsample_rate = params_rate(params);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops tobermory_ops = {\n\t.hw_params = tobermory_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(cpu,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8962.1-001a\", \"wm8962\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s.0\")));\n\nstatic struct snd_soc_dai_link tobermory_dai[] = {\n\t{\n\t\t.name = \"CPU\",\n\t\t.stream_name = \"CPU\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.ops = &tobermory_ops,\n\t\tSND_SOC_DAILINK_REG(cpu),\n\t},\n};\n\nstatic const struct snd_kcontrol_new controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Main Speaker\"),\n\tSOC_DAPM_PIN_SWITCH(\"DMIC\"),\n};\n\nstatic const struct snd_soc_dapm_widget widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\n\tSND_SOC_DAPM_MIC(\"DMIC\", NULL),\n\tSND_SOC_DAPM_MIC(\"AMIC\", NULL),\n\n\tSND_SOC_DAPM_SPK(\"Main Speaker\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route audio_paths[] = {\n\t{ \"Headphone\", NULL, \"HPOUTL\" },\n\t{ \"Headphone\", NULL, \"HPOUTR\" },\n\n\t{ \"Main Speaker\", NULL, \"SPKOUTL\" },\n\t{ \"Main Speaker\", NULL, \"SPKOUTR\" },\n\n\t{ \"Headset Mic\", NULL, \"MICBIAS\" },\n\t{ \"IN4L\", NULL, \"Headset Mic\" },\n\t{ \"IN4R\", NULL, \"Headset Mic\" },\n\n\t{ \"AMIC\", NULL, \"MICBIAS\" },\n\t{ \"IN1L\", NULL, \"AMIC\" },\n\t{ \"IN1R\", NULL, \"AMIC\" },\n\n\t{ \"DMIC\", NULL, \"MICBIAS\" },\n\t{ \"DMICDAT\", NULL, \"DMIC\" },\n};\n\nstatic struct snd_soc_jack tobermory_headset;\n\n \nstatic struct snd_soc_jack_pin tobermory_headset_pins[] = {\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Headphone\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int tobermory_late_probe(struct snd_soc_card *card)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_component *component;\n\tstruct snd_soc_dai *codec_dai;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[0]);\n\tcomponent = asoc_rtd_to_codec(rtd, 0)->component;\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8962_SYSCLK_MCLK,\n\t\t\t\t     32768, SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = snd_soc_card_jack_new_pins(card, \"Headset\", SND_JACK_HEADSET |\n\t\t\t\t\t SND_JACK_BTN_0, &tobermory_headset,\n\t\t\t\t\t tobermory_headset_pins,\n\t\t\t\t\t ARRAY_SIZE(tobermory_headset_pins));\n\tif (ret)\n\t\treturn ret;\n\n\twm8962_mic_detect(component, &tobermory_headset);\n\n\treturn 0;\n}\n\nstatic struct snd_soc_card tobermory = {\n\t.name = \"Tobermory\",\n\t.owner = THIS_MODULE,\n\t.dai_link = tobermory_dai,\n\t.num_links = ARRAY_SIZE(tobermory_dai),\n\n\t.set_bias_level = tobermory_set_bias_level,\n\t.set_bias_level_post = tobermory_set_bias_level_post,\n\n\t.controls = controls,\n\t.num_controls = ARRAY_SIZE(controls),\n\t.dapm_widgets = widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(widgets),\n\t.dapm_routes = audio_paths,\n\t.num_dapm_routes = ARRAY_SIZE(audio_paths),\n\t.fully_routed = true,\n\n\t.late_probe = tobermory_late_probe,\n};\n\nstatic int tobermory_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &tobermory;\n\tint ret;\n\n\tcard->dev = &pdev->dev;\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret)\n\t\tdev_err_probe(&pdev->dev, ret, \"snd_soc_register_card() failed\\n\");\n\n\treturn ret;\n}\n\nstatic struct platform_driver tobermory_driver = {\n\t.driver = {\n\t\t.name = \"tobermory\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = tobermory_probe,\n};\n\nmodule_platform_driver(tobermory_driver);\n\nMODULE_DESCRIPTION(\"Tobermory audio support\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:tobermory\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}