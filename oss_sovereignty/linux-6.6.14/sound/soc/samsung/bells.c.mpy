{
  "module_name": "bells.c",
  "hash_id": "367a108b908a7b9d0e928cee943eee821c9fb1b77245fa1ce0a5e6fdaa2f94c5",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/bells.c",
  "human_readable_source": "\n\n\n\n\n\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/jack.h>\n#include <linux/gpio.h>\n#include <linux/module.h>\n\n#include \"../codecs/wm5102.h\"\n#include \"../codecs/wm9081.h\"\n\n \n#define BCLK2_RATE (64 * 8000)\n\n \n#define MCLK_RATE 24576000\n\n#define SYS_AUDIO_RATE 44100\n#define SYS_MCLK_RATE  (SYS_AUDIO_RATE * 512)\n\n#define DAI_AP_DSP    0\n#define DAI_DSP_CODEC 1\n#define DAI_CODEC_CP  2\n#define DAI_CODEC_SUB 3\n\nstruct bells_drvdata {\n\tint sysclk_rate;\n\tint asyncclk_rate;\n};\n\nstatic struct bells_drvdata wm2200_drvdata = {\n\t.sysclk_rate = 22579200,\n};\n\nstatic struct bells_drvdata wm5102_drvdata = {\n\t.sysclk_rate = 45158400,\n\t.asyncclk_rate = 49152000,\n};\n\nstatic struct bells_drvdata wm5110_drvdata = {\n\t.sysclk_rate = 135475200,\n\t.asyncclk_rate = 147456000,\n};\n\nstatic int bells_set_bias_level(struct snd_soc_card *card,\n\t\t\t\tstruct snd_soc_dapm_context *dapm,\n\t\t\t\tenum snd_soc_bias_level level)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_component *component;\n\tstruct bells_drvdata *bells = card->drvdata;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[DAI_DSP_CODEC]);\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\tcomponent = codec_dai->component;\n\n\tif (dapm->dev != codec_dai->dev)\n\t\treturn 0;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tif (dapm->bias_level != SND_SOC_BIAS_STANDBY)\n\t\t\tbreak;\n\n\t\tret = snd_soc_component_set_pll(component, WM5102_FLL1,\n\t\t\t\t\t    ARIZONA_FLL_SRC_MCLK1,\n\t\t\t\t\t    MCLK_RATE,\n\t\t\t\t\t    bells->sysclk_rate);\n\t\tif (ret < 0)\n\t\t\tpr_err(\"Failed to start FLL: %d\\n\", ret);\n\n\t\tif (bells->asyncclk_rate) {\n\t\t\tret = snd_soc_component_set_pll(component, WM5102_FLL2,\n\t\t\t\t\t\t    ARIZONA_FLL_SRC_AIF2BCLK,\n\t\t\t\t\t\t    BCLK2_RATE,\n\t\t\t\t\t\t    bells->asyncclk_rate);\n\t\t\tif (ret < 0)\n\t\t\t\tpr_err(\"Failed to start FLL: %d\\n\", ret);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int bells_set_bias_level_post(struct snd_soc_card *card,\n\t\t\t\t     struct snd_soc_dapm_context *dapm,\n\t\t\t\t     enum snd_soc_bias_level level)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_component *component;\n\tstruct bells_drvdata *bells = card->drvdata;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[DAI_DSP_CODEC]);\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\tcomponent = codec_dai->component;\n\n\tif (dapm->dev != codec_dai->dev)\n\t\treturn 0;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_STANDBY:\n\t\tret = snd_soc_component_set_pll(component, WM5102_FLL1, 0, 0, 0);\n\t\tif (ret < 0) {\n\t\t\tpr_err(\"Failed to stop FLL: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (bells->asyncclk_rate) {\n\t\t\tret = snd_soc_component_set_pll(component, WM5102_FLL2,\n\t\t\t\t\t\t    0, 0, 0);\n\t\t\tif (ret < 0) {\n\t\t\t\tpr_err(\"Failed to stop FLL: %d\\n\", ret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tdapm->bias_level = level;\n\n\treturn 0;\n}\n\nstatic int bells_late_probe(struct snd_soc_card *card)\n{\n\tstruct bells_drvdata *bells = card->drvdata;\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_component *wm0010;\n\tstruct snd_soc_component *component;\n\tstruct snd_soc_dai *aif1_dai;\n\tstruct snd_soc_dai *aif2_dai;\n\tstruct snd_soc_dai *aif3_dai;\n\tstruct snd_soc_dai *wm9081_dai;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[DAI_AP_DSP]);\n\twm0010 = asoc_rtd_to_codec(rtd, 0)->component;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[DAI_DSP_CODEC]);\n\tcomponent = asoc_rtd_to_codec(rtd, 0)->component;\n\taif1_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tret = snd_soc_component_set_sysclk(component, ARIZONA_CLK_SYSCLK,\n\t\t\t\t       ARIZONA_CLK_SRC_FLL1,\n\t\t\t\t       bells->sysclk_rate,\n\t\t\t\t       SND_SOC_CLOCK_IN);\n\tif (ret != 0) {\n\t\tdev_err(component->dev, \"Failed to set SYSCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_component_set_sysclk(wm0010, 0, 0, SYS_MCLK_RATE, 0);\n\tif (ret != 0) {\n\t\tdev_err(wm0010->dev, \"Failed to set WM0010 clock: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(aif1_dai, ARIZONA_CLK_SYSCLK, 0, 0);\n\tif (ret != 0)\n\t\tdev_err(aif1_dai->dev, \"Failed to set AIF1 clock: %d\\n\", ret);\n\n\tret = snd_soc_component_set_sysclk(component, ARIZONA_CLK_OPCLK, 0,\n\t\t\t\t       SYS_MCLK_RATE, SND_SOC_CLOCK_OUT);\n\tif (ret != 0)\n\t\tdev_err(component->dev, \"Failed to set OPCLK: %d\\n\", ret);\n\n\tif (card->num_rtd == DAI_CODEC_CP)\n\t\treturn 0;\n\n\tret = snd_soc_component_set_sysclk(component, ARIZONA_CLK_ASYNCCLK,\n\t\t\t\t       ARIZONA_CLK_SRC_FLL2,\n\t\t\t\t       bells->asyncclk_rate,\n\t\t\t\t       SND_SOC_CLOCK_IN);\n\tif (ret != 0) {\n\t\tdev_err(component->dev, \"Failed to set ASYNCCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[DAI_CODEC_CP]);\n\taif2_dai = asoc_rtd_to_cpu(rtd, 0);\n\n\tret = snd_soc_dai_set_sysclk(aif2_dai, ARIZONA_CLK_ASYNCCLK, 0, 0);\n\tif (ret != 0) {\n\t\tdev_err(aif2_dai->dev, \"Failed to set AIF2 clock: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (card->num_rtd == DAI_CODEC_SUB)\n\t\treturn 0;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[DAI_CODEC_SUB]);\n\taif3_dai = asoc_rtd_to_cpu(rtd, 0);\n\twm9081_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tret = snd_soc_dai_set_sysclk(aif3_dai, ARIZONA_CLK_SYSCLK, 0, 0);\n\tif (ret != 0) {\n\t\tdev_err(aif1_dai->dev, \"Failed to set AIF1 clock: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_component_set_sysclk(wm9081_dai->component, WM9081_SYSCLK_MCLK,\n\t\t\t\t       0, SYS_MCLK_RATE, 0);\n\tif (ret != 0) {\n\t\tdev_err(wm9081_dai->dev, \"Failed to set MCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_pcm_stream baseband_params = {\n\t.formats = SNDRV_PCM_FMTBIT_S32_LE,\n\t.rate_min = 8000,\n\t.rate_max = 8000,\n\t.channels_min = 2,\n\t.channels_max = 2,\n};\n\nstatic const struct snd_soc_pcm_stream sub_params = {\n\t.formats = SNDRV_PCM_FMTBIT_S32_LE,\n\t.rate_min = SYS_AUDIO_RATE,\n\t.rate_max = SYS_AUDIO_RATE,\n\t.channels_min = 2,\n\t.channels_max = 2,\n};\n\nSND_SOC_DAILINK_DEFS(wm2200_cpu_dsp,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"spi0.0\", \"wm0010-sdi1\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s.0\")));\n\nSND_SOC_DAILINK_DEFS(wm2200_dsp_codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm0010-sdi2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm2200.1-003a\", \"wm2200\")));\n\nstatic struct snd_soc_dai_link bells_dai_wm2200[] = {\n\t{\n\t\t.name = \"CPU-DSP\",\n\t\t.stream_name = \"CPU-DSP\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\tSND_SOC_DAILINK_REG(wm2200_cpu_dsp),\n\t},\n\t{\n\t\t.name = \"DSP-CODEC\",\n\t\t.stream_name = \"DSP-CODEC\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.c2c_params = &sub_params,\n\t\t.num_c2c_params = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(wm2200_dsp_codec),\n\t},\n};\n\nSND_SOC_DAILINK_DEFS(wm5102_cpu_dsp,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"spi0.0\", \"wm0010-sdi1\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s.0\")));\n\nSND_SOC_DAILINK_DEFS(wm5102_dsp_codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm0010-sdi2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm5102-codec\", \"wm5102-aif1\")));\n\nSND_SOC_DAILINK_DEFS(wm5102_baseband,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm5102-aif2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm1250-ev1.1-0027\", \"wm1250-ev1\")));\n\nSND_SOC_DAILINK_DEFS(wm5102_sub,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm5102-aif3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm9081.1-006c\", \"wm9081-hifi\")));\n\nstatic struct snd_soc_dai_link bells_dai_wm5102[] = {\n\t{\n\t\t.name = \"CPU-DSP\",\n\t\t.stream_name = \"CPU-DSP\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\tSND_SOC_DAILINK_REG(wm5102_cpu_dsp),\n\t},\n\t{\n\t\t.name = \"DSP-CODEC\",\n\t\t.stream_name = \"DSP-CODEC\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.c2c_params = &sub_params,\n\t\t.num_c2c_params = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(wm5102_dsp_codec),\n\t},\n\t{\n\t\t.name = \"Baseband\",\n\t\t.stream_name = \"Baseband\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.ignore_suspend = 1,\n\t\t.c2c_params = &baseband_params,\n\t\t.num_c2c_params = 1,\n\t\tSND_SOC_DAILINK_REG(wm5102_baseband),\n\t},\n\t{\n\t\t.name = \"Sub\",\n\t\t.stream_name = \"Sub\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBS_CFS,\n\t\t.ignore_suspend = 1,\n\t\t.c2c_params = &sub_params,\n\t\t.num_c2c_params = 1,\n\t\tSND_SOC_DAILINK_REG(wm5102_sub),\n\t},\n};\n\nSND_SOC_DAILINK_DEFS(wm5110_cpu_dsp,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"spi0.0\", \"wm0010-sdi1\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s.0\")));\n\nSND_SOC_DAILINK_DEFS(wm5110_dsp_codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm0010-sdi2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm5110-codec\", \"wm5110-aif1\")));\n\nSND_SOC_DAILINK_DEFS(wm5110_baseband,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm5110-aif2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm1250-ev1.1-0027\", \"wm1250-ev1\")));\n\n\nSND_SOC_DAILINK_DEFS(wm5110_sub,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm5110-aif3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm9081.1-006c\", \"wm9081-hifi\")));\n\nstatic struct snd_soc_dai_link bells_dai_wm5110[] = {\n\t{\n\t\t.name = \"CPU-DSP\",\n\t\t.stream_name = \"CPU-DSP\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\tSND_SOC_DAILINK_REG(wm5110_cpu_dsp),\n\t},\n\t{\n\t\t.name = \"DSP-CODEC\",\n\t\t.stream_name = \"DSP-CODEC\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.c2c_params = &sub_params,\n\t\t.num_c2c_params = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(wm5110_dsp_codec),\n\t},\n\t{\n\t\t.name = \"Baseband\",\n\t\t.stream_name = \"Baseband\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.ignore_suspend = 1,\n\t\t.c2c_params = &baseband_params,\n\t\t.num_c2c_params = 1,\n\t\tSND_SOC_DAILINK_REG(wm5110_baseband),\n\t},\n\t{\n\t\t.name = \"Sub\",\n\t\t.stream_name = \"Sub\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBS_CFS,\n\t\t.ignore_suspend = 1,\n\t\t.c2c_params = &sub_params,\n\t\t.num_c2c_params = 1,\n\t\tSND_SOC_DAILINK_REG(wm5110_sub),\n\t},\n};\n\nstatic struct snd_soc_codec_conf bells_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"wm9081.1-006c\"),\n\t\t.name_prefix = \"Sub\",\n\t},\n};\n\nstatic const struct snd_soc_dapm_widget bells_widgets[] = {\n\tSND_SOC_DAPM_MIC(\"DMIC\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route bells_routes[] = {\n\t{ \"Sub CLK_SYS\", NULL, \"OPCLK\" },\n\t{ \"CLKIN\", NULL, \"OPCLK\" },\n\n\t{ \"DMIC\", NULL, \"MICBIAS2\" },\n\t{ \"IN2L\", NULL, \"DMIC\" },\n\t{ \"IN2R\", NULL, \"DMIC\" },\n};\n\nstatic struct snd_soc_card bells_cards[] = {\n\t{\n\t\t.name = \"Bells WM2200\",\n\t\t.owner = THIS_MODULE,\n\t\t.dai_link = bells_dai_wm2200,\n\t\t.num_links = ARRAY_SIZE(bells_dai_wm2200),\n\t\t.codec_conf = bells_codec_conf,\n\t\t.num_configs = ARRAY_SIZE(bells_codec_conf),\n\n\t\t.late_probe = bells_late_probe,\n\n\t\t.dapm_widgets = bells_widgets,\n\t\t.num_dapm_widgets = ARRAY_SIZE(bells_widgets),\n\t\t.dapm_routes = bells_routes,\n\t\t.num_dapm_routes = ARRAY_SIZE(bells_routes),\n\n\t\t.set_bias_level = bells_set_bias_level,\n\t\t.set_bias_level_post = bells_set_bias_level_post,\n\n\t\t.drvdata = &wm2200_drvdata,\n\t},\n\t{\n\t\t.name = \"Bells WM5102\",\n\t\t.owner = THIS_MODULE,\n\t\t.dai_link = bells_dai_wm5102,\n\t\t.num_links = ARRAY_SIZE(bells_dai_wm5102),\n\t\t.codec_conf = bells_codec_conf,\n\t\t.num_configs = ARRAY_SIZE(bells_codec_conf),\n\n\t\t.late_probe = bells_late_probe,\n\n\t\t.dapm_widgets = bells_widgets,\n\t\t.num_dapm_widgets = ARRAY_SIZE(bells_widgets),\n\t\t.dapm_routes = bells_routes,\n\t\t.num_dapm_routes = ARRAY_SIZE(bells_routes),\n\n\t\t.set_bias_level = bells_set_bias_level,\n\t\t.set_bias_level_post = bells_set_bias_level_post,\n\n\t\t.drvdata = &wm5102_drvdata,\n\t},\n\t{\n\t\t.name = \"Bells WM5110\",\n\t\t.owner = THIS_MODULE,\n\t\t.dai_link = bells_dai_wm5110,\n\t\t.num_links = ARRAY_SIZE(bells_dai_wm5110),\n\t\t.codec_conf = bells_codec_conf,\n\t\t.num_configs = ARRAY_SIZE(bells_codec_conf),\n\n\t\t.late_probe = bells_late_probe,\n\n\t\t.dapm_widgets = bells_widgets,\n\t\t.num_dapm_widgets = ARRAY_SIZE(bells_widgets),\n\t\t.dapm_routes = bells_routes,\n\t\t.num_dapm_routes = ARRAY_SIZE(bells_routes),\n\n\t\t.set_bias_level = bells_set_bias_level,\n\t\t.set_bias_level_post = bells_set_bias_level_post,\n\n\t\t.drvdata = &wm5110_drvdata,\n\t},\n};\n\nstatic int bells_probe(struct platform_device *pdev)\n{\n\tint ret;\n\n\tbells_cards[pdev->id].dev = &pdev->dev;\n\n\tret = devm_snd_soc_register_card(&pdev->dev, &bells_cards[pdev->id]);\n\tif (ret)\n\t\tdev_err(&pdev->dev,\n\t\t\t\"snd_soc_register_card(%s) failed: %d\\n\",\n\t\t\tbells_cards[pdev->id].name, ret);\n\n\treturn ret;\n}\n\nstatic struct platform_driver bells_driver = {\n\t.driver = {\n\t\t.name = \"bells\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = bells_probe,\n};\n\nmodule_platform_driver(bells_driver);\n\nMODULE_DESCRIPTION(\"Bells audio support\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:bells\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}