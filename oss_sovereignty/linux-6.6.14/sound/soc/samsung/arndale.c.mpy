{
  "module_name": "arndale.c",
  "hash_id": "b644307b84f3139819737d2af173509446127b099460b1e1d87f5162b86a38c2",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/arndale.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/clk.h>\n\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n\n#include \"../codecs/wm8994.h\"\n#include \"i2s.h\"\n\nstatic int arndale_rt5631_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint rfs, ret;\n\tunsigned long rclk;\n\n\trfs = 256;\n\n\trclk = params_rate(params) * rfs;\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, SAMSUNG_I2S_CDCLK,\n\t\t\t\t\t0, SND_SOC_CLOCK_OUT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, SAMSUNG_I2S_RCLKSRC_0,\n\t\t\t\t\t0, SND_SOC_CLOCK_OUT);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, 0, rclk, SND_SOC_CLOCK_OUT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops arndale_rt5631_ops = {\n\t.hw_params = arndale_rt5631_hw_params,\n};\n\nstatic int arndale_wm1811_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tunsigned int rfs, rclk;\n\n\t \n\tif (params_width(params) == 24)\n\t\trfs = 384;\n\telse if (params_rate(params) == 8000 || params_rate(params) == 11025)\n\t\trfs = 512;\n\telse\n\t\trfs = 256;\n\n\trclk = params_rate(params) * rfs;\n\n\t \n\treturn snd_soc_dai_set_sysclk(codec_dai, WM8994_SYSCLK_MCLK1,\n\t\t\t\t\trclk + 1, SND_SOC_CLOCK_IN);\n}\n\nstatic const struct snd_soc_ops arndale_wm1811_ops = {\n\t.hw_params = arndale_wm1811_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(rt5631_hifi,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"rt5631-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link arndale_rt5631_dai[] = {\n\t{\n\t\t.name = \"RT5631 HiFi\",\n\t\t.stream_name = \"Primary\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S\n\t\t\t| SND_SOC_DAIFMT_NB_NF\n\t\t\t| SND_SOC_DAIFMT_CBS_CFS,\n\t\t.ops = &arndale_rt5631_ops,\n\t\tSND_SOC_DAILINK_REG(rt5631_hifi),\n\t},\n};\n\nSND_SOC_DAILINK_DEFS(wm1811_hifi,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"wm8994-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link arndale_wm1811_dai[] = {\n\t{\n\t\t.name = \"WM1811 HiFi\",\n\t\t.stream_name = \"Primary\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S\n\t\t\t| SND_SOC_DAIFMT_NB_NF\n\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.ops = &arndale_wm1811_ops,\n\t\tSND_SOC_DAILINK_REG(wm1811_hifi),\n\t},\n};\n\nstatic struct snd_soc_card arndale_rt5631 = {\n\t.name = \"Arndale RT5631\",\n\t.owner = THIS_MODULE,\n\t.dai_link = arndale_rt5631_dai,\n\t.num_links = ARRAY_SIZE(arndale_rt5631_dai),\n};\n\nstatic struct snd_soc_card arndale_wm1811 = {\n\t.name = \"Arndale WM1811\",\n\t.owner = THIS_MODULE,\n\t.dai_link = arndale_wm1811_dai,\n\t.num_links = ARRAY_SIZE(arndale_wm1811_dai),\n};\n\nstatic void arndale_put_of_nodes(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai_link *dai_link;\n\tint i;\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tof_node_put(dai_link->cpus->of_node);\n\t\tof_node_put(dai_link->codecs->of_node);\n\t}\n}\n\nstatic int arndale_audio_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct snd_soc_card *card;\n\tstruct snd_soc_dai_link *dai_link;\n\tint ret;\n\n\tcard = (struct snd_soc_card *)of_device_get_match_data(&pdev->dev);\n\tcard->dev = &pdev->dev;\n\tdai_link = card->dai_link;\n\n\tdai_link->cpus->of_node = of_parse_phandle(np, \"samsung,audio-cpu\", 0);\n\tif (!dai_link->cpus->of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'samsung,audio-cpu' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (!dai_link->platforms->name)\n\t\tdai_link->platforms->of_node = dai_link->cpus->of_node;\n\n\tdai_link->codecs->of_node = of_parse_phandle(np, \"samsung,audio-codec\", 0);\n\tif (!dai_link->codecs->of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'samsung,audio-codec' missing or invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_put_of_nodes;\n\t}\n\n\tret = devm_snd_soc_register_card(card->dev, card);\n\tif (ret) {\n\t\tdev_err_probe(&pdev->dev, ret,\n\t\t\t      \"snd_soc_register_card() failed\\n\");\n\t\tgoto err_put_of_nodes;\n\t}\n\treturn 0;\n\nerr_put_of_nodes:\n\tarndale_put_of_nodes(card);\n\treturn ret;\n}\n\nstatic void arndale_audio_remove(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = platform_get_drvdata(pdev);\n\n\tarndale_put_of_nodes(card);\n}\n\nstatic const struct of_device_id arndale_audio_of_match[] = {\n\t{ .compatible = \"samsung,arndale-rt5631\",  .data = &arndale_rt5631 },\n\t{ .compatible = \"samsung,arndale-alc5631\", .data = &arndale_rt5631 },\n\t{ .compatible = \"samsung,arndale-wm1811\",  .data = &arndale_wm1811 },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, arndale_audio_of_match);\n\nstatic struct platform_driver arndale_audio_driver = {\n\t.driver = {\n\t\t.name = \"arndale-audio\",\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = arndale_audio_of_match,\n\t},\n\t.probe = arndale_audio_probe,\n\t.remove_new = arndale_audio_remove,\n};\n\nmodule_platform_driver(arndale_audio_driver);\n\nMODULE_AUTHOR(\"Claude <claude@insignal.co.kr>\");\nMODULE_DESCRIPTION(\"ALSA SoC Driver for Arndale Board\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}