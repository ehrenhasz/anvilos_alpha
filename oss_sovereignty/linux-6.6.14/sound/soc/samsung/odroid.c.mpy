{
  "module_name": "odroid.c",
  "hash_id": "de61cb07917bf3740189317549b0aa5088ae24f1864a26158b3cde7e0736fd84",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/odroid.c",
  "human_readable_source": "\n\n\n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/module.h>\n#include <sound/soc.h>\n#include <sound/pcm_params.h>\n#include \"i2s.h\"\n#include \"i2s-regs.h\"\n\nstruct odroid_priv {\n\tstruct snd_soc_card card;\n\tstruct clk *clk_i2s_bus;\n\tstruct clk *sclk_i2s;\n\n\t \n\tspinlock_t lock;\n\tunsigned int be_sample_rate;\n\tbool be_active;\n};\n\nstatic int odroid_card_fe_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\tsnd_pcm_hw_constraint_single(runtime, SNDRV_PCM_HW_PARAM_CHANNELS, 2);\n\n\treturn 0;\n}\n\nstatic int odroid_card_fe_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct odroid_priv *priv = snd_soc_card_get_drvdata(rtd->card);\n\tunsigned long flags;\n\tint ret = 0;\n\n\tspin_lock_irqsave(&priv->lock, flags);\n\tif (priv->be_active && priv->be_sample_rate != params_rate(params))\n\t\tret = -EINVAL;\n\tspin_unlock_irqrestore(&priv->lock, flags);\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops odroid_card_fe_ops = {\n\t.startup = odroid_card_fe_startup,\n\t.hw_params = odroid_card_fe_hw_params,\n};\n\nstatic int odroid_card_be_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct odroid_priv *priv = snd_soc_card_get_drvdata(rtd->card);\n\tunsigned int pll_freq, rclk_freq, rfs;\n\tunsigned long flags;\n\tint ret;\n\n\tswitch (params_rate(params)) {\n\tcase 64000:\n\t\tpll_freq = 196608001U;\n\t\trfs = 384;\n\t\tbreak;\n\tcase 44100:\n\tcase 88200:\n\t\tpll_freq = 180633609U;\n\t\trfs = 512;\n\t\tbreak;\n\tcase 32000:\n\tcase 48000:\n\tcase 96000:\n\t\tpll_freq = 196608001U;\n\t\trfs = 512;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = clk_set_rate(priv->clk_i2s_bus, pll_freq / 2 + 1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\trclk_freq = params_rate(params) * rfs + 2;\n\n\tret = clk_set_rate(priv->sclk_i2s, rclk_freq);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (rtd->dai_link->num_codecs > 1) {\n\t\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 1);\n\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, 0, rclk_freq,\n\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tspin_lock_irqsave(&priv->lock, flags);\n\tpriv->be_sample_rate = params_rate(params);\n\tspin_unlock_irqrestore(&priv->lock, flags);\n\n\treturn 0;\n}\n\nstatic int odroid_card_be_trigger(struct snd_pcm_substream *substream, int cmd)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct odroid_priv *priv = snd_soc_card_get_drvdata(rtd->card);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&priv->lock, flags);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tpriv->be_active = true;\n\t\tbreak;\n\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tpriv->be_active = false;\n\t\tbreak;\n\t}\n\n\tspin_unlock_irqrestore(&priv->lock, flags);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops odroid_card_be_ops = {\n\t.hw_params = odroid_card_be_hw_params,\n\t.trigger = odroid_card_be_trigger,\n};\n\n \nstatic const struct snd_soc_dapm_route odroid_dapm_routes[] = {\n\t{ \"I2S Playback\", NULL, \"Mixer DAI TX\" },\n\t{ \"HiFi Playback\", NULL, \"Mixer DAI TX\" },\n};\n\nSND_SOC_DAILINK_DEFS(primary,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"3830000.i2s\")));\n\nSND_SOC_DAILINK_DEFS(mixer,\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()));\n\nSND_SOC_DAILINK_DEFS(secondary,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"3830000.i2s-sec\")));\n\nstatic struct snd_soc_dai_link odroid_card_dais[] = {\n\t{\n\t\t \n\t\t.ops = &odroid_card_fe_ops,\n\t\t.name = \"Primary\",\n\t\t.stream_name = \"Primary\",\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(primary),\n\t}, {\n\t\t \n\t\t.name = \"I2S Mixer\",\n\t\t.ops = &odroid_card_be_ops,\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\t\tSND_SOC_DAIFMT_CBS_CFS,\n\t\tSND_SOC_DAILINK_REG(mixer),\n\t}, {\n\t\t \n\t\t.playback_only = 1,\n\t\t.ops = &odroid_card_fe_ops,\n\t\t.name = \"Secondary\",\n\t\t.stream_name = \"Secondary\",\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(secondary),\n\t}\n};\n\nstatic int odroid_audio_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *cpu_dai = NULL;\n\tstruct device_node *cpu, *codec;\n\tstruct odroid_priv *priv;\n\tstruct snd_soc_card *card;\n\tstruct snd_soc_dai_link *link, *codec_link;\n\tint num_pcms, ret, i;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tcard = &priv->card;\n\tcard->dev = dev;\n\n\tcard->owner = THIS_MODULE;\n\tcard->fully_routed = true;\n\n\tspin_lock_init(&priv->lock);\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tret = snd_soc_of_parse_card_name(card, \"model\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (of_property_present(dev->of_node, \"samsung,audio-widgets\")) {\n\t\tret = snd_soc_of_parse_audio_simple_widgets(card,\n\t\t\t\t\t\t\"samsung,audio-widgets\");\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tret = 0;\n\tif (of_property_present(dev->of_node, \"audio-routing\"))\n\t\tret = snd_soc_of_parse_audio_routing(card, \"audio-routing\");\n\telse if (of_property_present(dev->of_node, \"samsung,audio-routing\"))\n\t\tret = snd_soc_of_parse_audio_routing(card, \"samsung,audio-routing\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tcard->dai_link = odroid_card_dais;\n\tcard->num_links = ARRAY_SIZE(odroid_card_dais);\n\n\tcpu = of_get_child_by_name(dev->of_node, \"cpu\");\n\tcodec = of_get_child_by_name(dev->of_node, \"codec\");\n\tlink = card->dai_link;\n\tcodec_link = &card->dai_link[1];\n\n\t \n\tnum_pcms = of_count_phandle_with_args(cpu, \"sound-dai\",\n\t\t\t\t\t      \"#sound-dai-cells\");\n\tif (num_pcms == 1) {\n\t\tcard->dapm_routes = odroid_dapm_routes;\n\t\tcard->num_dapm_routes = ARRAY_SIZE(odroid_dapm_routes);\n\t\tcard->num_links--;\n\t}\n\n\tfor (i = 0; i < num_pcms; i++, link += 2) {\n\t\tret = snd_soc_of_get_dai_name(cpu, &link->cpus->dai_name, i);\n\t\tif (ret < 0)\n\t\t\tbreak;\n\t}\n\tif (ret == 0) {\n\t\tcpu_dai = of_parse_phandle(cpu, \"sound-dai\", 0);\n\t\tif (!cpu_dai)\n\t\t\tret = -EINVAL;\n\t}\n\n\tof_node_put(cpu);\n\tif (ret < 0)\n\t\tgoto err_put_node;\n\n\tret = snd_soc_of_get_dai_link_codecs(dev, codec, codec_link);\n\tif (ret < 0)\n\t\tgoto err_put_cpu_dai;\n\n\t \n\tif (codec_link->num_codecs > 1) {\n\t\tcard->dai_link[0].dpcm_capture = 1;\n\t\tcard->dai_link[1].dpcm_capture = 1;\n\t}\n\n\tpriv->sclk_i2s = of_clk_get_by_name(cpu_dai, \"i2s_opclk1\");\n\tif (IS_ERR(priv->sclk_i2s)) {\n\t\tret = PTR_ERR(priv->sclk_i2s);\n\t\tgoto err_put_cpu_dai;\n\t}\n\n\tpriv->clk_i2s_bus = of_clk_get_by_name(cpu_dai, \"iis\");\n\tif (IS_ERR(priv->clk_i2s_bus)) {\n\t\tret = PTR_ERR(priv->clk_i2s_bus);\n\t\tgoto err_put_sclk;\n\t}\n\n\tret = devm_snd_soc_register_card(dev, card);\n\tif (ret < 0) {\n\t\tdev_err_probe(dev, ret, \"snd_soc_register_card() failed\\n\");\n\t\tgoto err_put_clk_i2s;\n\t}\n\n\tof_node_put(cpu_dai);\n\tof_node_put(codec);\n\treturn 0;\n\nerr_put_clk_i2s:\n\tclk_put(priv->clk_i2s_bus);\nerr_put_sclk:\n\tclk_put(priv->sclk_i2s);\nerr_put_cpu_dai:\n\tof_node_put(cpu_dai);\n\tsnd_soc_of_put_dai_link_codecs(codec_link);\nerr_put_node:\n\tof_node_put(codec);\n\treturn ret;\n}\n\nstatic void odroid_audio_remove(struct platform_device *pdev)\n{\n\tstruct odroid_priv *priv = platform_get_drvdata(pdev);\n\n\tsnd_soc_of_put_dai_link_codecs(&priv->card.dai_link[1]);\n\tclk_put(priv->sclk_i2s);\n\tclk_put(priv->clk_i2s_bus);\n}\n\nstatic const struct of_device_id odroid_audio_of_match[] = {\n\t{ .compatible\t= \"hardkernel,odroid-xu3-audio\" },\n\t{ .compatible\t= \"hardkernel,odroid-xu4-audio\" },\n\t{ .compatible\t= \"samsung,odroid-xu3-audio\" },\n\t{ .compatible\t= \"samsung,odroid-xu4-audio\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, odroid_audio_of_match);\n\nstatic struct platform_driver odroid_audio_driver = {\n\t.driver = {\n\t\t.name\t\t= \"odroid-audio\",\n\t\t.of_match_table\t= odroid_audio_of_match,\n\t\t.pm\t\t= &snd_soc_pm_ops,\n\t},\n\t.probe\t= odroid_audio_probe,\n\t.remove_new = odroid_audio_remove,\n};\nmodule_platform_driver(odroid_audio_driver);\n\nMODULE_AUTHOR(\"Sylwester Nawrocki <s.nawrocki@samsung.com>\");\nMODULE_DESCRIPTION(\"Odroid XU3/XU4 audio support\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}