{
  "module_name": "snow.c",
  "hash_id": "5bc89859617796275ce7103541379ee010511f87bd2e32a15fecf6264f71fa34",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/snow.c",
  "human_readable_source": "\n\n\n\n#include <linux/clk.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#include \"i2s.h\"\n\n#define FIN_PLL_RATE\t\t24000000\n\nSND_SOC_DAILINK_DEFS(links,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstruct snow_priv {\n\tstruct snd_soc_dai_link dai_link;\n\tstruct clk *clk_i2s_bus;\n};\n\nstatic int snow_card_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tstatic const unsigned int pll_rate[] = {\n\t\t73728000U, 67737602U, 49152000U, 45158401U, 32768001U\n\t};\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snow_priv *priv = snd_soc_card_get_drvdata(rtd->card);\n\tint bfs, psr, rfs, bitwidth;\n\tunsigned long int rclk;\n\tlong int freq = -EINVAL;\n\tint ret, i;\n\n\tbitwidth = snd_pcm_format_width(params_format(params));\n\tif (bitwidth < 0) {\n\t\tdev_err(rtd->card->dev, \"Invalid bit-width: %d\\n\", bitwidth);\n\t\treturn bitwidth;\n\t}\n\n\tif (bitwidth != 16 && bitwidth != 24) {\n\t\tdev_err(rtd->card->dev, \"Unsupported bit-width: %d\\n\", bitwidth);\n\t\treturn -EINVAL;\n\t}\n\n\tbfs = 2 * bitwidth;\n\n\tswitch (params_rate(params)) {\n\tcase 16000:\n\tcase 22050:\n\tcase 24000:\n\tcase 32000:\n\tcase 44100:\n\tcase 48000:\n\tcase 88200:\n\tcase 96000:\n\t\trfs = 8 * bfs;\n\t\tbreak;\n\tcase 64000:\n\t\trfs = 384;\n\t\tbreak;\n\tcase 8000:\n\tcase 11025:\n\tcase 12000:\n\t\trfs = 16 * bfs;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\trclk = params_rate(params) * rfs;\n\n\tfor (psr = 8; psr > 0; psr /= 2) {\n\t\tfor (i = 0; i < ARRAY_SIZE(pll_rate); i++) {\n\t\t\tif ((pll_rate[i] - rclk * psr) <= 2) {\n\t\t\t\tfreq = pll_rate[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (freq < 0) {\n\t\tdev_err(rtd->card->dev, \"Unsupported RCLK rate: %lu\\n\", rclk);\n\t\treturn -EINVAL;\n\t}\n\n\tret = clk_set_rate(priv->clk_i2s_bus, freq);\n\tif (ret < 0) {\n\t\tdev_err(rtd->card->dev, \"I2S bus clock rate set failed\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops snow_card_ops = {\n\t.hw_params = snow_card_hw_params,\n};\n\nstatic int snow_late_probe(struct snd_soc_card *card)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[0]);\n\n\t \n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\t \n\treturn snd_soc_dai_set_sysclk(codec_dai, 0,\n\t\t\t\tFIN_PLL_RATE, SND_SOC_CLOCK_IN);\n}\n\nstatic struct snd_soc_card snow_snd = {\n\t.name = \"Snow-I2S\",\n\t.owner = THIS_MODULE,\n\t.late_probe = snow_late_probe,\n};\n\nstatic int snow_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct snd_soc_card *card = &snow_snd;\n\tstruct device_node *cpu, *codec;\n\tstruct snd_soc_dai_link *link;\n\tstruct snow_priv *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tlink = &priv->dai_link;\n\n\tlink->dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS;\n\n\tlink->name = \"Primary\";\n\tlink->stream_name = link->name;\n\n\tlink->cpus = links_cpus;\n\tlink->num_cpus = ARRAY_SIZE(links_cpus);\n\tlink->codecs = links_codecs;\n\tlink->num_codecs = ARRAY_SIZE(links_codecs);\n\tlink->platforms = links_platforms;\n\tlink->num_platforms = ARRAY_SIZE(links_platforms);\n\n\tcard->dai_link = link;\n\tcard->num_links = 1;\n\tcard->dev = dev;\n\n\t \n\tcpu = of_get_child_by_name(dev->of_node, \"cpu\");\n\n\tif (cpu) {\n\t\tlink->ops = &snow_card_ops;\n\n\t\tlink->cpus->of_node = of_parse_phandle(cpu, \"sound-dai\", 0);\n\t\tof_node_put(cpu);\n\n\t\tif (!link->cpus->of_node) {\n\t\t\tdev_err(dev, \"Failed parsing cpu/sound-dai property\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tcodec = of_get_child_by_name(dev->of_node, \"codec\");\n\t\tret = snd_soc_of_get_dai_link_codecs(dev, codec, link);\n\t\tof_node_put(codec);\n\n\t\tif (ret < 0) {\n\t\t\tof_node_put(link->cpus->of_node);\n\t\t\tdev_err(dev, \"Failed parsing codec node\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tpriv->clk_i2s_bus = of_clk_get_by_name(link->cpus->of_node,\n\t\t\t\t\t\t       \"i2s_opclk0\");\n\t\tif (IS_ERR(priv->clk_i2s_bus)) {\n\t\t\tsnd_soc_of_put_dai_link_codecs(link);\n\t\t\tof_node_put(link->cpus->of_node);\n\t\t\treturn PTR_ERR(priv->clk_i2s_bus);\n\t\t}\n\t} else {\n\t\tlink->codecs->dai_name = \"HiFi\";\n\n\t\tlink->cpus->of_node = of_parse_phandle(dev->of_node,\n\t\t\t\t\t\t\"samsung,i2s-controller\", 0);\n\t\tif (!link->cpus->of_node) {\n\t\t\tdev_err(dev, \"i2s-controller property parse error\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tlink->codecs->of_node = of_parse_phandle(dev->of_node,\n\t\t\t\t\t\t\"samsung,audio-codec\", 0);\n\t\tif (!link->codecs->of_node) {\n\t\t\tof_node_put(link->cpus->of_node);\n\t\t\tdev_err(dev, \"audio-codec property parse error\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tlink->platforms->of_node = link->cpus->of_node;\n\n\t \n\tsnd_soc_of_parse_card_name(card, \"samsung,model\");\n\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tret = devm_snd_soc_register_card(dev, card);\n\tif (ret)\n\t\treturn dev_err_probe(&pdev->dev, ret,\n\t\t\t\t     \"snd_soc_register_card failed\\n\");\n\n\treturn 0;\n}\n\nstatic void snow_remove(struct platform_device *pdev)\n{\n\tstruct snow_priv *priv = platform_get_drvdata(pdev);\n\tstruct snd_soc_dai_link *link = &priv->dai_link;\n\n\tof_node_put(link->cpus->of_node);\n\tof_node_put(link->codecs->of_node);\n\tsnd_soc_of_put_dai_link_codecs(link);\n\n\tclk_put(priv->clk_i2s_bus);\n}\n\nstatic const struct of_device_id snow_of_match[] = {\n\t{ .compatible = \"google,snow-audio-max98090\", },\n\t{ .compatible = \"google,snow-audio-max98091\", },\n\t{ .compatible = \"google,snow-audio-max98095\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, snow_of_match);\n\nstatic struct platform_driver snow_driver = {\n\t.driver = {\n\t\t.name = \"snow-audio\",\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = snow_of_match,\n\t},\n\t.probe = snow_probe,\n\t.remove_new = snow_remove,\n};\n\nmodule_platform_driver(snow_driver);\n\nMODULE_DESCRIPTION(\"ALSA SoC Audio machine driver for Snow\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}