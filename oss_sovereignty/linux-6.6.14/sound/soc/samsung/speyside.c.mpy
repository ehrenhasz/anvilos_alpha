{
  "module_name": "speyside.c",
  "hash_id": "4dab4955efa552c12f57801858ddb050bf954b7df87607ffdaf65f2c531af00d",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/speyside.c",
  "human_readable_source": "\n\n\n\n\n\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/jack.h>\n#include <linux/gpio.h>\n#include <linux/module.h>\n\n#include \"../codecs/wm8996.h\"\n#include \"../codecs/wm9081.h\"\n\n#define WM8996_HPSEL_GPIO 214\n#define MCLK_AUDIO_RATE (512 * 48000)\n\nstatic int speyside_set_bias_level(struct snd_soc_card *card,\n\t\t\t\t   struct snd_soc_dapm_context *dapm,\n\t\t\t\t   enum snd_soc_bias_level level)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[1]);\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tif (dapm->dev != codec_dai->dev)\n\t\treturn 0;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_STANDBY:\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, WM8996_SYSCLK_MCLK2,\n\t\t\t\t\t     32768, SND_SOC_CLOCK_IN);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = snd_soc_dai_set_pll(codec_dai, WM8996_FLL_MCLK2,\n\t\t\t\t\t  0, 0, 0);\n\t\tif (ret < 0) {\n\t\t\tpr_err(\"Failed to stop FLL\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int speyside_set_bias_level_post(struct snd_soc_card *card,\n\t\t\t\t\tstruct snd_soc_dapm_context *dapm,\n\t\t\t\t\tenum snd_soc_bias_level level)\n{\n\tstruct snd_soc_pcm_runtime *rtd;\n\tstruct snd_soc_dai *codec_dai;\n\tint ret;\n\n\trtd = snd_soc_get_pcm_runtime(card, &card->dai_link[1]);\n\tcodec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tif (dapm->dev != codec_dai->dev)\n\t\treturn 0;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tif (card->dapm.bias_level == SND_SOC_BIAS_STANDBY) {\n\t\t\tret = snd_soc_dai_set_pll(codec_dai, 0,\n\t\t\t\t\t\t  WM8996_FLL_MCLK2,\n\t\t\t\t\t\t  32768, MCLK_AUDIO_RATE);\n\t\t\tif (ret < 0) {\n\t\t\t\tpr_err(\"Failed to start FLL\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tret = snd_soc_dai_set_sysclk(codec_dai,\n\t\t\t\t\t\t     WM8996_SYSCLK_FLL,\n\t\t\t\t\t\t     MCLK_AUDIO_RATE,\n\t\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tcard->dapm.bias_level = level;\n\n\treturn 0;\n}\n\nstatic struct snd_soc_jack speyside_headset;\n\n \nstatic struct snd_soc_jack_pin speyside_headset_pins[] = {\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n};\n\n \nstatic int speyside_jack_polarity;\n\nstatic int speyside_get_micbias(struct snd_soc_dapm_widget *source,\n\t\t\t\tstruct snd_soc_dapm_widget *sink)\n{\n\tif (speyside_jack_polarity && (strcmp(source->name, \"MICB1\") == 0))\n\t\treturn 1;\n\tif (!speyside_jack_polarity && (strcmp(source->name, \"MICB2\") == 0))\n\t\treturn 1;\n\n\treturn 0;\n}\n\nstatic void speyside_set_polarity(struct snd_soc_component *component,\n\t\t\t\t  int polarity)\n{\n\tspeyside_jack_polarity = !polarity;\n\tgpio_direction_output(WM8996_HPSEL_GPIO, speyside_jack_polarity);\n\n\t \n\tsnd_soc_dapm_sync(snd_soc_component_get_dapm(component));\n}\n\nstatic int speyside_wm0010_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(dai, 0, MCLK_AUDIO_RATE, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int speyside_wm8996_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_component *component = dai->component;\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(dai, WM8996_SYSCLK_MCLK2, 32768, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = gpio_request(WM8996_HPSEL_GPIO, \"HP_SEL\");\n\tif (ret != 0)\n\t\tpr_err(\"Failed to request HP_SEL GPIO: %d\\n\", ret);\n\tgpio_direction_output(WM8996_HPSEL_GPIO, speyside_jack_polarity);\n\n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset\",\n\t\t\t\t\t SND_JACK_LINEOUT | SND_JACK_HEADSET |\n\t\t\t\t\t SND_JACK_BTN_0,\n\t\t\t\t\t &speyside_headset,\n\t\t\t\t\t speyside_headset_pins,\n\t\t\t\t\t ARRAY_SIZE(speyside_headset_pins));\n\tif (ret)\n\t\treturn ret;\n\n\twm8996_detect(component, &speyside_headset, speyside_set_polarity);\n\n\treturn 0;\n}\n\nstatic int speyside_late_probe(struct snd_soc_card *card)\n{\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"Headphone\");\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"Headset Mic\");\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"Main AMIC\");\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"Main DMIC\");\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"Main Speaker\");\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"WM1250 Output\");\n\tsnd_soc_dapm_ignore_suspend(&card->dapm, \"WM1250 Input\");\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_pcm_stream dsp_codec_params = {\n\t.formats = SNDRV_PCM_FMTBIT_S32_LE,\n\t.rate_min = 48000,\n\t.rate_max = 48000,\n\t.channels_min = 2,\n\t.channels_max = 2,\n};\n\nSND_SOC_DAILINK_DEFS(cpu_dsp,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"spi0.0\", \"wm0010-sdi1\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s.0\")));\n\nSND_SOC_DAILINK_DEFS(dsp_codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm0010-sdi2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8996.1-001a\", \"wm8996-aif1\")));\n\nSND_SOC_DAILINK_DEFS(baseband,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"wm8996-aif2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm1250-ev1.1-0027\", \"wm1250-ev1\")));\n\nstatic struct snd_soc_dai_link speyside_dai[] = {\n\t{\n\t\t.name = \"CPU-DSP\",\n\t\t.stream_name = \"CPU-DSP\",\n\t\t.init = speyside_wm0010_init,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\tSND_SOC_DAILINK_REG(cpu_dsp),\n\t},\n\t{\n\t\t.name = \"DSP-CODEC\",\n\t\t.stream_name = \"DSP-CODEC\",\n\t\t.init = speyside_wm8996_init,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.c2c_params = &dsp_codec_params,\n\t\t.num_c2c_params = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(dsp_codec),\n\t},\n\t{\n\t\t.name = \"Baseband\",\n\t\t.stream_name = \"Baseband\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t| SND_SOC_DAIFMT_CBM_CFM,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(baseband),\n\t},\n};\n\nstatic int speyside_wm9081_init(struct snd_soc_component *component)\n{\n\t \n\treturn snd_soc_component_set_sysclk(component, WM9081_SYSCLK_MCLK, 0,\n\t\t\t\t\tMCLK_AUDIO_RATE, 0);\n}\n\nstatic struct snd_soc_aux_dev speyside_aux_dev[] = {\n\t{\n\t\t.dlc = COMP_AUX(\"wm9081.1-006c\"),\n\t\t.init = speyside_wm9081_init,\n\t},\n};\n\nstatic struct snd_soc_codec_conf speyside_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"wm9081.1-006c\"),\n\t\t.name_prefix = \"Sub\",\n\t},\n};\n\nstatic const struct snd_kcontrol_new controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Main Speaker\"),\n\tSOC_DAPM_PIN_SWITCH(\"Main DMIC\"),\n\tSOC_DAPM_PIN_SWITCH(\"Main AMIC\"),\n\tSOC_DAPM_PIN_SWITCH(\"WM1250 Input\"),\n\tSOC_DAPM_PIN_SWITCH(\"WM1250 Output\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n};\n\nstatic const struct snd_soc_dapm_widget widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\n\tSND_SOC_DAPM_SPK(\"Main Speaker\", NULL),\n\n\tSND_SOC_DAPM_MIC(\"Main AMIC\", NULL),\n\tSND_SOC_DAPM_MIC(\"Main DMIC\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route audio_paths[] = {\n\t{ \"IN1RN\", NULL, \"MICB1\" },\n\t{ \"IN1RP\", NULL, \"MICB1\" },\n\t{ \"IN1RN\", NULL, \"MICB2\" },\n\t{ \"IN1RP\", NULL, \"MICB2\" },\n\t{ \"MICB1\", NULL, \"Headset Mic\", speyside_get_micbias },\n\t{ \"MICB2\", NULL, \"Headset Mic\", speyside_get_micbias },\n\n\t{ \"IN1LP\", NULL, \"MICB2\" },\n\t{ \"IN1RN\", NULL, \"MICB1\" },\n\t{ \"MICB2\", NULL, \"Main AMIC\" },\n\n\t{ \"DMIC1DAT\", NULL, \"MICB1\" },\n\t{ \"DMIC2DAT\", NULL, \"MICB1\" },\n\t{ \"MICB1\", NULL, \"Main DMIC\" },\n\n\t{ \"Headphone\", NULL, \"HPOUT1L\" },\n\t{ \"Headphone\", NULL, \"HPOUT1R\" },\n\n\t{ \"Sub IN1\", NULL, \"HPOUT2L\" },\n\t{ \"Sub IN2\", NULL, \"HPOUT2R\" },\n\n\t{ \"Main Speaker\", NULL, \"Sub SPKN\" },\n\t{ \"Main Speaker\", NULL, \"Sub SPKP\" },\n\t{ \"Main Speaker\", NULL, \"SPKDAT\" },\n};\n\nstatic struct snd_soc_card speyside = {\n\t.name = \"Speyside\",\n\t.owner = THIS_MODULE,\n\t.dai_link = speyside_dai,\n\t.num_links = ARRAY_SIZE(speyside_dai),\n\t.aux_dev = speyside_aux_dev,\n\t.num_aux_devs = ARRAY_SIZE(speyside_aux_dev),\n\t.codec_conf = speyside_codec_conf,\n\t.num_configs = ARRAY_SIZE(speyside_codec_conf),\n\n\t.set_bias_level = speyside_set_bias_level,\n\t.set_bias_level_post = speyside_set_bias_level_post,\n\n\t.controls = controls,\n\t.num_controls = ARRAY_SIZE(controls),\n\t.dapm_widgets = widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(widgets),\n\t.dapm_routes = audio_paths,\n\t.num_dapm_routes = ARRAY_SIZE(audio_paths),\n\t.fully_routed = true,\n\n\t.late_probe = speyside_late_probe,\n};\n\nstatic int speyside_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &speyside;\n\tint ret;\n\n\tcard->dev = &pdev->dev;\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret)\n\t\tdev_err_probe(&pdev->dev, ret, \"snd_soc_register_card() failed\\n\");\n\n\treturn ret;\n}\n\nstatic struct platform_driver speyside_driver = {\n\t.driver = {\n\t\t.name = \"speyside\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = speyside_probe,\n};\n\nmodule_platform_driver(speyside_driver);\n\nMODULE_DESCRIPTION(\"Speyside audio support\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:speyside\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}