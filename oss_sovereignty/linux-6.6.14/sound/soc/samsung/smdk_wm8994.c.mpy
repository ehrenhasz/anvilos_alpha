{
  "module_name": "smdk_wm8994.c",
  "hash_id": "9214244ea4a0df53b60914aa9b6bf45892466fd7b4265a006730257b1048e444",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/samsung/smdk_wm8994.c",
  "human_readable_source": "\n\n#include \"../codecs/wm8994.h\"\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n\n  \n\n  \n\n \n#define SMDK_WM8994_FREQ 16934000\n\nstruct smdk_wm8994_data {\n\tint mclk1_rate;\n};\n\n \nstatic struct smdk_wm8994_data smdk_board_data = {\n\t.mclk1_rate = SMDK_WM8994_FREQ,\n};\n\nstatic int smdk_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tunsigned int pll_out;\n\tint ret;\n\n\t \n\tif (params_width(params) == 24)\n\t\tpll_out = params_rate(params) * 384;\n\telse if (params_rate(params) == 8000 || params_rate(params) == 11025)\n\t\tpll_out = params_rate(params) * 512;\n\telse\n\t\tpll_out = params_rate(params) * 256;\n\n\tret = snd_soc_dai_set_pll(codec_dai, WM8994_FLL1, WM8994_FLL_SRC_MCLK1,\n\t\t\t\t\tSMDK_WM8994_FREQ, pll_out);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8994_SYSCLK_FLL1,\n\t\t\t\t\tpll_out, SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\n \nstatic const struct snd_soc_ops smdk_ops = {\n\t.hw_params = smdk_hw_params,\n};\n\nstatic int smdk_wm8994_init_paiftx(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dapm_context *dapm = &rtd->card->dapm;\n\n\t \n\tsnd_soc_dapm_nc_pin(dapm, \"HPOUT2P\");\n\tsnd_soc_dapm_nc_pin(dapm, \"HPOUT2N\");\n\tsnd_soc_dapm_nc_pin(dapm, \"SPKOUTLN\");\n\tsnd_soc_dapm_nc_pin(dapm, \"SPKOUTLP\");\n\tsnd_soc_dapm_nc_pin(dapm, \"SPKOUTRP\");\n\tsnd_soc_dapm_nc_pin(dapm, \"SPKOUTRN\");\n\tsnd_soc_dapm_nc_pin(dapm, \"LINEOUT1N\");\n\tsnd_soc_dapm_nc_pin(dapm, \"LINEOUT1P\");\n\tsnd_soc_dapm_nc_pin(dapm, \"LINEOUT2N\");\n\tsnd_soc_dapm_nc_pin(dapm, \"LINEOUT2P\");\n\tsnd_soc_dapm_nc_pin(dapm, \"IN1LP\");\n\tsnd_soc_dapm_nc_pin(dapm, \"IN2LP:VXRN\");\n\tsnd_soc_dapm_nc_pin(dapm, \"IN1RP\");\n\tsnd_soc_dapm_nc_pin(dapm, \"IN2RP:VXRP\");\n\n\treturn 0;\n}\n\nSND_SOC_DAILINK_DEFS(aif1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8994-codec\", \"wm8994-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s.0\")));\n\nSND_SOC_DAILINK_DEFS(fifo_tx,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"samsung-i2s-sec\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8994-codec\", \"wm8994-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"samsung-i2s-sec\")));\n\nstatic struct snd_soc_dai_link smdk_dai[] = {\n\t{  \n\t\t.name = \"WM8994 AIF1\",\n\t\t.stream_name = \"Pri_Dai\",\n\t\t.init = smdk_wm8994_init_paiftx,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBM_CFM,\n\t\t.ops = &smdk_ops,\n\t\tSND_SOC_DAILINK_REG(aif1),\n\t}, {  \n\t\t.name = \"Sec_FIFO TX\",\n\t\t.stream_name = \"Sec_Dai\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBM_CFM,\n\t\t.ops = &smdk_ops,\n\t\tSND_SOC_DAILINK_REG(fifo_tx),\n\t},\n};\n\nstatic struct snd_soc_card smdk = {\n\t.name = \"SMDK-I2S\",\n\t.owner = THIS_MODULE,\n\t.dai_link = smdk_dai,\n\t.num_links = ARRAY_SIZE(smdk_dai),\n};\n\nstatic const struct of_device_id samsung_wm8994_of_match[] __maybe_unused = {\n\t{ .compatible = \"samsung,smdk-wm8994\", .data = &smdk_board_data },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, samsung_wm8994_of_match);\n\nstatic int smdk_audio_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct snd_soc_card *card = &smdk;\n\tstruct smdk_wm8994_data *board;\n\tconst struct of_device_id *id;\n\n\tcard->dev = &pdev->dev;\n\n\tboard = devm_kzalloc(&pdev->dev, sizeof(*board), GFP_KERNEL);\n\tif (!board)\n\t\treturn -ENOMEM;\n\n\tif (np) {\n\t\tsmdk_dai[0].cpus->dai_name = NULL;\n\t\tsmdk_dai[0].cpus->of_node = of_parse_phandle(np,\n\t\t\t\t\"samsung,i2s-controller\", 0);\n\t\tif (!smdk_dai[0].cpus->of_node) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t   \"Property 'samsung,i2s-controller' missing or invalid\\n\");\n\t\t\tret = -EINVAL;\n\t\t\treturn ret;\n\t\t}\n\n\t\tsmdk_dai[0].platforms->name = NULL;\n\t\tsmdk_dai[0].platforms->of_node = smdk_dai[0].cpus->of_node;\n\t}\n\n\tid = of_match_device(samsung_wm8994_of_match, &pdev->dev);\n\tif (id)\n\t\t*board = *((struct smdk_wm8994_data *)id->data);\n\n\tplatform_set_drvdata(pdev, board);\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\n\tif (ret)\n\t\tdev_err_probe(&pdev->dev, ret, \"snd_soc_register_card() failed\\n\");\n\n\treturn ret;\n}\n\nstatic struct platform_driver smdk_audio_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"smdk-audio-wm8994\",\n\t\t.of_match_table = of_match_ptr(samsung_wm8994_of_match),\n\t\t.pm\t= &snd_soc_pm_ops,\n\t},\n\t.probe\t\t= smdk_audio_probe,\n};\n\nmodule_platform_driver(smdk_audio_driver);\n\nMODULE_DESCRIPTION(\"ALSA SoC SMDK WM8994\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:smdk-audio-wm8994\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}