{
  "module_name": "imx-audio-rpmsg.c",
  "hash_id": "80ee4e97396c48a06673a3dc7f9c05a09addbc54f81b7e28cce59a1af57aeff2",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/fsl/imx-audio-rpmsg.c",
  "human_readable_source": "\n\n\n#include <linux/module.h>\n#include <linux/rpmsg.h>\n#include \"imx-pcm-rpmsg.h\"\n\n \nstruct imx_audio_rpmsg {\n\tstruct platform_device *rpmsg_pdev;\n};\n\nstatic int imx_audio_rpmsg_cb(struct rpmsg_device *rpdev, void *data, int len,\n\t\t\t      void *priv, u32 src)\n{\n\tstruct imx_audio_rpmsg *rpmsg = dev_get_drvdata(&rpdev->dev);\n\tstruct rpmsg_r_msg *r_msg = (struct rpmsg_r_msg *)data;\n\tstruct rpmsg_info *info;\n\tstruct rpmsg_msg *msg;\n\tunsigned long flags;\n\n\tif (!rpmsg->rpmsg_pdev)\n\t\treturn 0;\n\n\tinfo = platform_get_drvdata(rpmsg->rpmsg_pdev);\n\n\tdev_dbg(&rpdev->dev, \"get from%d: cmd:%d. %d\\n\",\n\t\tsrc, r_msg->header.cmd, r_msg->param.resp);\n\n\tswitch (r_msg->header.type) {\n\tcase MSG_TYPE_C:\n\t\t \n\t\tswitch (r_msg->header.cmd) {\n\t\tcase TX_PERIOD_DONE:\n\t\t\tspin_lock_irqsave(&info->lock[TX], flags);\n\t\t\tmsg = &info->msg[TX_PERIOD_DONE + MSG_TYPE_A_NUM];\n\t\t\tmsg->r_msg.param.buffer_tail =\n\t\t\t\t\t\tr_msg->param.buffer_tail;\n\t\t\tmsg->r_msg.param.buffer_tail %= info->num_period[TX];\n\t\t\tspin_unlock_irqrestore(&info->lock[TX], flags);\n\t\t\tinfo->callback[TX](info->callback_param[TX]);\n\t\t\tbreak;\n\t\tcase RX_PERIOD_DONE:\n\t\t\tspin_lock_irqsave(&info->lock[RX], flags);\n\t\t\tmsg = &info->msg[RX_PERIOD_DONE + MSG_TYPE_A_NUM];\n\t\t\tmsg->r_msg.param.buffer_tail =\n\t\t\t\t\t\tr_msg->param.buffer_tail;\n\t\t\tmsg->r_msg.param.buffer_tail %= info->num_period[1];\n\t\t\tspin_unlock_irqrestore(&info->lock[RX], flags);\n\t\t\tinfo->callback[RX](info->callback_param[RX]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_warn(&rpdev->dev, \"unknown msg command\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase MSG_TYPE_B:\n\t\t \n\t\tmemcpy(&info->r_msg, r_msg, sizeof(struct rpmsg_r_msg));\n\t\tcomplete(&info->cmd_complete);\n\t\tbreak;\n\tdefault:\n\t\tdev_warn(&rpdev->dev, \"unknown msg type\\n\");\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int imx_audio_rpmsg_probe(struct rpmsg_device *rpdev)\n{\n\tstruct imx_audio_rpmsg *data;\n\tint ret = 0;\n\n\tdev_info(&rpdev->dev, \"new channel: 0x%x -> 0x%x!\\n\",\n\t\t rpdev->src, rpdev->dst);\n\n\tdata = devm_kzalloc(&rpdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&rpdev->dev, data);\n\n\t \n\tdata->rpmsg_pdev = platform_device_register_data(&rpdev->dev,\n\t\t\t\t\t\t\t IMX_PCM_DRV_NAME,\n\t\t\t\t\t\t\t PLATFORM_DEVID_AUTO,\n\t\t\t\t\t\t\t NULL, 0);\n\tif (IS_ERR(data->rpmsg_pdev)) {\n\t\tdev_err(&rpdev->dev, \"failed to register rpmsg platform.\\n\");\n\t\tret = PTR_ERR(data->rpmsg_pdev);\n\t}\n\n\treturn ret;\n}\n\nstatic void imx_audio_rpmsg_remove(struct rpmsg_device *rpdev)\n{\n\tstruct imx_audio_rpmsg *data = dev_get_drvdata(&rpdev->dev);\n\n\tif (data->rpmsg_pdev)\n\t\tplatform_device_unregister(data->rpmsg_pdev);\n\n\tdev_info(&rpdev->dev, \"audio rpmsg driver is removed\\n\");\n}\n\nstatic struct rpmsg_device_id imx_audio_rpmsg_id_table[] = {\n\t{ .name\t= \"rpmsg-audio-channel\" },\n\t{ .name = \"rpmsg-micfil-channel\" },\n\t{ },\n};\n\nstatic struct rpmsg_driver imx_audio_rpmsg_driver = {\n\t.drv.name\t= \"imx_audio_rpmsg\",\n\t.id_table\t= imx_audio_rpmsg_id_table,\n\t.probe\t\t= imx_audio_rpmsg_probe,\n\t.callback\t= imx_audio_rpmsg_cb,\n\t.remove\t\t= imx_audio_rpmsg_remove,\n};\n\nmodule_rpmsg_driver(imx_audio_rpmsg_driver);\n\nMODULE_DESCRIPTION(\"Freescale SoC Audio RPMSG interface\");\nMODULE_AUTHOR(\"Shengjiu Wang <shengjiu.wang@nxp.com>\");\nMODULE_ALIAS(\"platform:imx_audio_rpmsg\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}