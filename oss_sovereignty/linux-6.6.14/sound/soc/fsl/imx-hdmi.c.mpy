{
  "module_name": "imx-hdmi.c",
  "hash_id": "78197b968812dd3b250ffa462f0700f08e1b626cee5887977a1876009c9d2bc6",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/fsl/imx-hdmi.c",
  "human_readable_source": "\n\n\n#include <linux/module.h>\n#include <linux/of_platform.h>\n#include <sound/jack.h>\n#include <sound/pcm_params.h>\n#include <sound/hdmi-codec.h>\n#include \"fsl_sai.h\"\n\n \nstruct cpu_priv {\n\tu32 sysclk_id[2];\n\tu32 slot_width;\n};\n\nstruct imx_hdmi_data {\n\tstruct snd_soc_dai_link dai;\n\tstruct snd_soc_card card;\n\tstruct snd_soc_jack hdmi_jack;\n\tstruct snd_soc_jack_pin hdmi_jack_pin;\n\tstruct cpu_priv cpu_priv;\n\tu32 dai_fmt;\n};\n\nstatic int imx_hdmi_hw_params(struct snd_pcm_substream *substream,\n\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tstruct imx_hdmi_data *data = snd_soc_card_get_drvdata(rtd->card);\n\tbool tx = substream->stream == SNDRV_PCM_STREAM_PLAYBACK;\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct device *dev = card->dev;\n\tu32 slot_width = data->cpu_priv.slot_width;\n\tint ret;\n\n\t \n\tret = snd_soc_dai_set_sysclk(cpu_dai, data->cpu_priv.sysclk_id[tx],\n\t\t\t\t     8 * slot_width * params_rate(params),\n\t\t\t\t     tx ? SND_SOC_CLOCK_OUT : SND_SOC_CLOCK_IN);\n\tif (ret && ret != -ENOTSUPP) {\n\t\tdev_err(dev, \"failed to set cpu sysclk: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_tdm_slot(cpu_dai, 0, 0, 2, slot_width);\n\tif (ret && ret != -ENOTSUPP) {\n\t\tdev_err(dev, \"failed to set cpu dai tdm slot: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops imx_hdmi_ops = {\n\t.hw_params = imx_hdmi_hw_params,\n};\n\nstatic const struct snd_soc_dapm_widget imx_hdmi_widgets[] = {\n\tSND_SOC_DAPM_LINE(\"HDMI Jack\", NULL),\n};\n\nstatic int imx_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_component *component = codec_dai->component;\n\tstruct imx_hdmi_data *data = snd_soc_card_get_drvdata(card);\n\tint ret;\n\n\tdata->hdmi_jack_pin.pin = \"HDMI Jack\";\n\tdata->hdmi_jack_pin.mask = SND_JACK_LINEOUT;\n\t \n\tret = snd_soc_card_jack_new_pins(card, \"HDMI Jack\", SND_JACK_LINEOUT,\n\t\t\t\t\t &data->hdmi_jack,\n\t\t\t\t\t &data->hdmi_jack_pin, 1);\n\tif (ret) {\n\t\tdev_err(card->dev, \"Can't new HDMI Jack %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_component_set_jack(component, &data->hdmi_jack, NULL);\n\tif (ret && ret != -ENOTSUPP) {\n\t\tdev_err(card->dev, \"Can't set HDMI Jack %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n};\n\nstatic int imx_hdmi_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tbool hdmi_out = of_property_read_bool(np, \"hdmi-out\");\n\tbool hdmi_in = of_property_read_bool(np, \"hdmi-in\");\n\tstruct snd_soc_dai_link_component *dlc;\n\tstruct platform_device *cpu_pdev;\n\tstruct device_node *cpu_np;\n\tstruct imx_hdmi_data *data;\n\tint ret;\n\n\tdlc = devm_kzalloc(&pdev->dev, 3 * sizeof(*dlc), GFP_KERNEL);\n\tif (!dlc)\n\t\treturn -ENOMEM;\n\n\tcpu_np = of_parse_phandle(np, \"audio-cpu\", 0);\n\tif (!cpu_np) {\n\t\tdev_err(&pdev->dev, \"cpu dai phandle missing or invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto fail;\n\t}\n\n\tcpu_pdev = of_find_device_by_node(cpu_np);\n\tif (!cpu_pdev) {\n\t\tdev_err(&pdev->dev, \"failed to find SAI platform device\\n\");\n\t\tret = -EINVAL;\n\t\tgoto fail;\n\t}\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (!data) {\n\t\tret = -ENOMEM;\n\t\tput_device(&cpu_pdev->dev);\n\t\tgoto fail;\n\t}\n\n\tdata->dai.cpus = &dlc[0];\n\tdata->dai.num_cpus = 1;\n\tdata->dai.platforms = &dlc[1];\n\tdata->dai.num_platforms = 1;\n\tdata->dai.codecs = &dlc[2];\n\tdata->dai.num_codecs = 1;\n\n\tdata->dai.name = \"i.MX HDMI\";\n\tdata->dai.stream_name = \"i.MX HDMI\";\n\tdata->dai.cpus->dai_name = dev_name(&cpu_pdev->dev);\n\tdata->dai.platforms->of_node = cpu_np;\n\tdata->dai.ops = &imx_hdmi_ops;\n\tdata->dai.playback_only = true;\n\tdata->dai.capture_only = false;\n\tdata->dai.init = imx_hdmi_init;\n\n\tput_device(&cpu_pdev->dev);\n\n\tif (of_node_name_eq(cpu_np, \"sai\")) {\n\t\tdata->cpu_priv.sysclk_id[1] = FSL_SAI_CLK_MAST1;\n\t\tdata->cpu_priv.sysclk_id[0] = FSL_SAI_CLK_MAST1;\n\t}\n\n\tif (of_device_is_compatible(np, \"fsl,imx-audio-sii902x\")) {\n\t\tdata->dai_fmt = SND_SOC_DAIFMT_LEFT_J;\n\t\tdata->cpu_priv.slot_width = 24;\n\t} else {\n\t\tdata->dai_fmt = SND_SOC_DAIFMT_I2S;\n\t\tdata->cpu_priv.slot_width = 32;\n\t}\n\n\tif ((hdmi_out && hdmi_in) || (!hdmi_out && !hdmi_in)) {\n\t\tdev_err(&pdev->dev, \"Invalid HDMI DAI link\\n\");\n\t\tret = -EINVAL;\n\t\tgoto fail;\n\t}\n\n\tif (hdmi_out) {\n\t\tdata->dai.playback_only = true;\n\t\tdata->dai.capture_only = false;\n\t\tdata->dai.codecs->dai_name = \"i2s-hifi\";\n\t\tdata->dai.codecs->name = \"hdmi-audio-codec.1\";\n\t\tdata->dai.dai_fmt = data->dai_fmt |\n\t\t\t\t    SND_SOC_DAIFMT_NB_NF |\n\t\t\t\t    SND_SOC_DAIFMT_CBC_CFC;\n\t}\n\n\tif (hdmi_in) {\n\t\tdata->dai.playback_only = false;\n\t\tdata->dai.capture_only = true;\n\t\tdata->dai.codecs->dai_name = \"i2s-hifi\";\n\t\tdata->dai.codecs->name = \"hdmi-audio-codec.2\";\n\t\tdata->dai.dai_fmt = data->dai_fmt |\n\t\t\t\t    SND_SOC_DAIFMT_NB_NF |\n\t\t\t\t    SND_SOC_DAIFMT_CBP_CFP;\n\t}\n\n\tdata->card.dapm_widgets = imx_hdmi_widgets;\n\tdata->card.num_dapm_widgets = ARRAY_SIZE(imx_hdmi_widgets);\n\tdata->card.dev = &pdev->dev;\n\tdata->card.owner = THIS_MODULE;\n\tret = snd_soc_of_parse_card_name(&data->card, \"model\");\n\tif (ret)\n\t\tgoto fail;\n\n\tdata->card.num_links = 1;\n\tdata->card.dai_link = &data->dai;\n\n\tsnd_soc_card_set_drvdata(&data->card, data);\n\tret = devm_snd_soc_register_card(&pdev->dev, &data->card);\n\tif (ret) {\n\t\tdev_err_probe(&pdev->dev, ret, \"snd_soc_register_card failed\\n\");\n\t\tgoto fail;\n\t}\n\nfail:\n\tof_node_put(cpu_np);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id imx_hdmi_dt_ids[] = {\n\t{ .compatible = \"fsl,imx-audio-hdmi\", },\n\t{ .compatible = \"fsl,imx-audio-sii902x\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, imx_hdmi_dt_ids);\n\nstatic struct platform_driver imx_hdmi_driver = {\n\t.driver = {\n\t\t.name = \"imx-hdmi\",\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = imx_hdmi_dt_ids,\n\t},\n\t.probe = imx_hdmi_probe,\n};\nmodule_platform_driver(imx_hdmi_driver);\n\nMODULE_AUTHOR(\"Freescale Semiconductor, Inc.\");\nMODULE_DESCRIPTION(\"Freescale i.MX hdmi audio ASoC machine driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:imx-hdmi\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}