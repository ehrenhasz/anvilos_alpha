{
  "module_name": "pcm030-audio-fabric.c",
  "hash_id": "640a894888286265577233ac53534838866c836d8182a4db19a4a2158c7badda",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/fsl/pcm030-audio-fabric.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/of_device.h>\n#include <linux/of_platform.h>\n\n#include <sound/soc.h>\n\n#include \"mpc5200_dma.h\"\n\n#define DRV_NAME \"pcm030-audio-fabric\"\n\nstruct pcm030_audio_data {\n\tstruct snd_soc_card *card;\n\tstruct platform_device *codec_device;\n};\n\nSND_SOC_DAILINK_DEFS(analog,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"mpc5200-psc-ac97.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm9712-codec\", \"wm9712-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(iec958,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"mpc5200-psc-ac97.1\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm9712-codec\", \"wm9712-aux\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link pcm030_fabric_dai[] = {\n{\n\t.name = \"AC97.0\",\n\t.stream_name = \"AC97 Analog\",\n\tSND_SOC_DAILINK_REG(analog),\n},\n{\n\t.name = \"AC97.1\",\n\t.stream_name = \"AC97 IEC958\",\n\tSND_SOC_DAILINK_REG(iec958),\n},\n};\n\nstatic struct snd_soc_card pcm030_card = {\n\t.name = \"pcm030\",\n\t.owner = THIS_MODULE,\n\t.dai_link = pcm030_fabric_dai,\n\t.num_links = ARRAY_SIZE(pcm030_fabric_dai),\n};\n\nstatic int pcm030_fabric_probe(struct platform_device *op)\n{\n\tstruct device_node *np = op->dev.of_node;\n\tstruct device_node *platform_np;\n\tstruct snd_soc_card *card = &pcm030_card;\n\tstruct pcm030_audio_data *pdata;\n\tstruct snd_soc_dai_link *dai_link;\n\tint ret;\n\tint i;\n\n\tif (!of_machine_is_compatible(\"phytec,pcm030\"))\n\t\treturn -ENODEV;\n\n\tpdata = devm_kzalloc(&op->dev, sizeof(struct pcm030_audio_data),\n\t\t\t     GFP_KERNEL);\n\tif (!pdata)\n\t\treturn -ENOMEM;\n\n\tcard->dev = &op->dev;\n\n\tpdata->card = card;\n\n\tplatform_np = of_parse_phandle(np, \"asoc-platform\", 0);\n\tif (!platform_np) {\n\t\tdev_err(&op->dev, \"ac97 not registered\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tfor_each_card_prelinks(card, i, dai_link)\n\t\tdai_link->platforms->of_node = platform_np;\n\n\tret = request_module(\"snd-soc-wm9712\");\n\tif (ret)\n\t\tdev_err(&op->dev, \"request_module returned: %d\\n\", ret);\n\n\tpdata->codec_device = platform_device_alloc(\"wm9712-codec\", -1);\n\tif (!pdata->codec_device)\n\t\tdev_err(&op->dev, \"platform_device_alloc() failed\\n\");\n\n\tret = platform_device_add(pdata->codec_device);\n\tif (ret) {\n\t\tdev_err(&op->dev, \"platform_device_add() failed: %d\\n\", ret);\n\t\tplatform_device_put(pdata->codec_device);\n\t}\n\n\tret = snd_soc_register_card(card);\n\tif (ret) {\n\t\tdev_err(&op->dev, \"snd_soc_register_card() failed: %d\\n\", ret);\n\t\tplatform_device_unregister(pdata->codec_device);\n\t}\n\n\tplatform_set_drvdata(op, pdata);\n\treturn ret;\n\n}\n\nstatic void pcm030_fabric_remove(struct platform_device *op)\n{\n\tstruct pcm030_audio_data *pdata = platform_get_drvdata(op);\n\n\tsnd_soc_unregister_card(pdata->card);\n\tplatform_device_unregister(pdata->codec_device);\n}\n\nstatic const struct of_device_id pcm030_audio_match[] = {\n\t{ .compatible = \"phytec,pcm030-audio-fabric\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, pcm030_audio_match);\n\nstatic struct platform_driver pcm030_fabric_driver = {\n\t.probe\t\t= pcm030_fabric_probe,\n\t.remove_new\t= pcm030_fabric_remove,\n\t.driver\t\t= {\n\t\t.name\t= DRV_NAME,\n\t\t.of_match_table    = pcm030_audio_match,\n\t},\n};\n\nmodule_platform_driver(pcm030_fabric_driver);\n\n\nMODULE_AUTHOR(\"Jon Smirl <jonsmirl@gmail.com>\");\nMODULE_DESCRIPTION(DRV_NAME \": mpc5200 pcm030 fabric driver\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}