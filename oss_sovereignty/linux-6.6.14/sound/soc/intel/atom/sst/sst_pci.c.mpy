{
  "module_name": "sst_pci.c",
  "hash_id": "8743eb9550689ac65415918693ee741d982f1a80fdb528a5cf76818834fb11a0",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/atom/sst/sst_pci.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/fs.h>\n#include <linux/firmware.h>\n#include <sound/core.h>\n#include <sound/soc.h>\n#include <asm/platform_sst_audio.h>\n#include \"../sst-mfld-platform.h\"\n#include \"sst.h\"\n\nstatic int sst_platform_get_resources(struct intel_sst_drv *ctx)\n{\n\tint ddr_base, ret = 0;\n\tstruct pci_dev *pci = ctx->pci;\n\n\tret = pci_request_regions(pci, SST_DRV_NAME);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\t \n\tif (ctx->dev_id == PCI_DEVICE_ID_INTEL_SST_TNG) {\n\t\tctx->ddr_base = pci_resource_start(pci, 0);\n\t\t \n\t\tddr_base = relocate_imr_addr_mrfld(ctx->ddr_base);\n\t\tif (!ctx->pdata->lib_info) {\n\t\t\tdev_err(ctx->dev, \"lib_info pointer NULL\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto do_release_regions;\n\t\t}\n\t\tif (ddr_base != ctx->pdata->lib_info->mod_base) {\n\t\t\tdev_err(ctx->dev,\n\t\t\t\t\t\"FW LSP DDR BASE does not match with IFWI\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto do_release_regions;\n\t\t}\n\t\tctx->ddr_end = pci_resource_end(pci, 0);\n\n\t\tctx->ddr = pcim_iomap(pci, 0,\n\t\t\t\t\tpci_resource_len(pci, 0));\n\t\tif (!ctx->ddr) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto do_release_regions;\n\t\t}\n\t\tdev_dbg(ctx->dev, \"sst: DDR Ptr %p\\n\", ctx->ddr);\n\t} else {\n\t\tctx->ddr = NULL;\n\t}\n\t \n\tctx->shim_phy_add = pci_resource_start(pci, 1);\n\tctx->shim = pcim_iomap(pci, 1, pci_resource_len(pci, 1));\n\tif (!ctx->shim) {\n\t\tret = -EINVAL;\n\t\tgoto do_release_regions;\n\t}\n\tdev_dbg(ctx->dev, \"SST Shim Ptr %p\\n\", ctx->shim);\n\n\t \n\tctx->mailbox_add = pci_resource_start(pci, 2);\n\tctx->mailbox = pcim_iomap(pci, 2, pci_resource_len(pci, 2));\n\tif (!ctx->mailbox) {\n\t\tret = -EINVAL;\n\t\tgoto do_release_regions;\n\t}\n\tdev_dbg(ctx->dev, \"SRAM Ptr %p\\n\", ctx->mailbox);\n\n\t \n\tctx->iram_end = pci_resource_end(pci, 3);\n\tctx->iram_base = pci_resource_start(pci, 3);\n\tctx->iram = pcim_iomap(pci, 3, pci_resource_len(pci, 3));\n\tif (!ctx->iram) {\n\t\tret = -EINVAL;\n\t\tgoto do_release_regions;\n\t}\n\tdev_dbg(ctx->dev, \"IRAM Ptr %p\\n\", ctx->iram);\n\n\t \n\tctx->dram_end = pci_resource_end(pci, 4);\n\tctx->dram_base = pci_resource_start(pci, 4);\n\tctx->dram = pcim_iomap(pci, 4, pci_resource_len(pci, 4));\n\tif (!ctx->dram) {\n\t\tret = -EINVAL;\n\t\tgoto do_release_regions;\n\t}\n\tdev_dbg(ctx->dev, \"DRAM Ptr %p\\n\", ctx->dram);\ndo_release_regions:\n\tpci_release_regions(pci);\n\treturn ret;\n}\n\n \nstatic int intel_sst_probe(struct pci_dev *pci,\n\t\t\tconst struct pci_device_id *pci_id)\n{\n\tint ret = 0;\n\tstruct intel_sst_drv *sst_drv_ctx;\n\tstruct sst_platform_info *sst_pdata = pci->dev.platform_data;\n\n\tdev_dbg(&pci->dev, \"Probe for DID %x\\n\", pci->device);\n\tret = sst_alloc_drv_context(&sst_drv_ctx, &pci->dev, pci->device);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tsst_drv_ctx->pdata = sst_pdata;\n\tsst_drv_ctx->irq_num = pci->irq;\n\tsnprintf(sst_drv_ctx->firmware_name, sizeof(sst_drv_ctx->firmware_name),\n\t\t\t\"%s%04x%s\", \"fw_sst_\",\n\t\t\tsst_drv_ctx->dev_id, \".bin\");\n\n\tret = sst_context_init(sst_drv_ctx);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = pcim_enable_device(pci);\n\tif (ret) {\n\t\tdev_err(sst_drv_ctx->dev,\n\t\t\t\"device can't be enabled. Returned err: %d\\n\", ret);\n\t\tgoto do_free_drv_ctx;\n\t}\n\tsst_drv_ctx->pci = pci_dev_get(pci);\n\tret = sst_platform_get_resources(sst_drv_ctx);\n\tif (ret < 0)\n\t\tgoto do_free_drv_ctx;\n\n\tpci_set_drvdata(pci, sst_drv_ctx);\n\tsst_configure_runtime_pm(sst_drv_ctx);\n\n\treturn ret;\n\ndo_free_drv_ctx:\n\tsst_context_cleanup(sst_drv_ctx);\n\tdev_err(sst_drv_ctx->dev, \"Probe failed with %d\\n\", ret);\n\treturn ret;\n}\n\n \nstatic void intel_sst_remove(struct pci_dev *pci)\n{\n\tstruct intel_sst_drv *sst_drv_ctx = pci_get_drvdata(pci);\n\n\tsst_context_cleanup(sst_drv_ctx);\n\tpci_dev_put(sst_drv_ctx->pci);\n\tpci_release_regions(pci);\n\tpci_set_drvdata(pci, NULL);\n}\n\n \nstatic const struct pci_device_id intel_sst_ids[] = {\n\t{ PCI_DEVICE_DATA(INTEL, SST_TNG, 0) },\n\t{ 0, }\n};\n\nstatic struct pci_driver sst_driver = {\n\t.name = SST_DRV_NAME,\n\t.id_table = intel_sst_ids,\n\t.probe = intel_sst_probe,\n\t.remove = intel_sst_remove,\n#ifdef CONFIG_PM\n\t.driver = {\n\t\t.pm = &intel_sst_pm,\n\t},\n#endif\n};\n\nmodule_pci_driver(sst_driver);\n\nMODULE_DESCRIPTION(\"Intel (R) SST(R) Audio Engine PCI Driver\");\nMODULE_AUTHOR(\"Vinod Koul <vinod.koul@intel.com>\");\nMODULE_AUTHOR(\"Harsha Priya <priya.harsha@intel.com>\");\nMODULE_AUTHOR(\"Dharageswari R <dharageswari.r@intel.com>\");\nMODULE_AUTHOR(\"KP Jeeja <jeeja.kp@intel.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"sst\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}