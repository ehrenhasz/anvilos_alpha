{
  "module_name": "messages.c",
  "hash_id": "78a3e1350a76d0b59f8365ae3f38f9d6ac64b4fba25876b54d1b4fe6bde8ef04",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/catpt/messages.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/slab.h>\n#include \"core.h\"\n#include \"messages.h\"\n#include \"registers.h\"\n\nint catpt_ipc_get_fw_version(struct catpt_dev *cdev,\n\t\t\t     struct catpt_fw_version *version)\n{\n\tunion catpt_global_msg msg = CATPT_GLOBAL_MSG(GET_FW_VERSION);\n\tstruct catpt_ipc_msg request = {{0}}, reply;\n\tint ret;\n\n\trequest.header = msg.val;\n\treply.size = sizeof(*version);\n\treply.data = version;\n\n\tret = catpt_dsp_send_msg(cdev, request, &reply);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"get fw version failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstruct catpt_alloc_stream_input {\n\tenum catpt_path_id path_id:8;\n\tenum catpt_stream_type stream_type:8;\n\tenum catpt_format_id format_id:8;\n\tu8 reserved;\n\tstruct catpt_audio_format input_format;\n\tstruct catpt_ring_info ring_info;\n\tu8 num_entries;\n\t \n\tstruct catpt_memory_info persistent_mem;\n\tstruct catpt_memory_info scratch_mem;\n\tu32 num_notifications;  \n} __packed;\n\nint catpt_ipc_alloc_stream(struct catpt_dev *cdev,\n\t\t\t   enum catpt_path_id path_id,\n\t\t\t   enum catpt_stream_type type,\n\t\t\t   struct catpt_audio_format *afmt,\n\t\t\t   struct catpt_ring_info *rinfo,\n\t\t\t   u8 num_modules,\n\t\t\t   struct catpt_module_entry *modules,\n\t\t\t   struct resource *persistent,\n\t\t\t   struct resource *scratch,\n\t\t\t   struct catpt_stream_info *sinfo)\n{\n\tunion catpt_global_msg msg = CATPT_GLOBAL_MSG(ALLOCATE_STREAM);\n\tstruct catpt_alloc_stream_input input;\n\tstruct catpt_ipc_msg request, reply;\n\tsize_t size, arrsz;\n\tu8 *payload;\n\toff_t off;\n\tint ret;\n\n\toff = offsetof(struct catpt_alloc_stream_input, persistent_mem);\n\tarrsz = sizeof(*modules) * num_modules;\n\tsize = sizeof(input) + arrsz;\n\n\tpayload = kzalloc(size, GFP_KERNEL);\n\tif (!payload)\n\t\treturn -ENOMEM;\n\n\tmemset(&input, 0, sizeof(input));\n\tinput.path_id = path_id;\n\tinput.stream_type = type;\n\tinput.format_id = CATPT_FORMAT_PCM;\n\tinput.input_format = *afmt;\n\tinput.ring_info = *rinfo;\n\tinput.num_entries = num_modules;\n\tinput.persistent_mem.offset = catpt_to_dsp_offset(persistent->start);\n\tinput.persistent_mem.size = resource_size(persistent);\n\tif (scratch) {\n\t\tinput.scratch_mem.offset = catpt_to_dsp_offset(scratch->start);\n\t\tinput.scratch_mem.size = resource_size(scratch);\n\t}\n\n\t \n\tmemcpy(payload, &input, sizeof(input));\n\tmemmove(payload + off + arrsz, payload + off, sizeof(input) - off);\n\tmemcpy(payload + off, modules, arrsz);\n\n\trequest.header = msg.val;\n\trequest.size = size;\n\trequest.data = payload;\n\treply.size = sizeof(*sinfo);\n\treply.data = sinfo;\n\n\tret = catpt_dsp_send_msg(cdev, request, &reply);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"alloc stream type %d failed: %d\\n\",\n\t\t\ttype, ret);\n\n\tkfree(payload);\n\treturn ret;\n}\n\nint catpt_ipc_free_stream(struct catpt_dev *cdev, u8 stream_hw_id)\n{\n\tunion catpt_global_msg msg = CATPT_GLOBAL_MSG(FREE_STREAM);\n\tstruct catpt_ipc_msg request;\n\tint ret;\n\n\trequest.header = msg.val;\n\trequest.size = sizeof(stream_hw_id);\n\trequest.data = &stream_hw_id;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"free stream %d failed: %d\\n\",\n\t\t\tstream_hw_id, ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_set_device_format(struct catpt_dev *cdev,\n\t\t\t\tstruct catpt_ssp_device_format *devfmt)\n{\n\tunion catpt_global_msg msg = CATPT_GLOBAL_MSG(SET_DEVICE_FORMATS);\n\tstruct catpt_ipc_msg request;\n\tint ret;\n\n\trequest.header = msg.val;\n\trequest.size = sizeof(*devfmt);\n\trequest.data = devfmt;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"set device format failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_enter_dxstate(struct catpt_dev *cdev, enum catpt_dx_state state,\n\t\t\t    struct catpt_dx_context *context)\n{\n\tunion catpt_global_msg msg = CATPT_GLOBAL_MSG(ENTER_DX_STATE);\n\tstruct catpt_ipc_msg request, reply;\n\tint ret;\n\n\trequest.header = msg.val;\n\trequest.size = sizeof(state);\n\trequest.data = &state;\n\treply.size = sizeof(*context);\n\treply.data = context;\n\n\tret = catpt_dsp_send_msg(cdev, request, &reply);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"enter dx state failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_get_mixer_stream_info(struct catpt_dev *cdev,\n\t\t\t\t    struct catpt_mixer_stream_info *info)\n{\n\tunion catpt_global_msg msg = CATPT_GLOBAL_MSG(GET_MIXER_STREAM_INFO);\n\tstruct catpt_ipc_msg request = {{0}}, reply;\n\tint ret;\n\n\trequest.header = msg.val;\n\treply.size = sizeof(*info);\n\treply.data = info;\n\n\tret = catpt_dsp_send_msg(cdev, request, &reply);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"get mixer info failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_reset_stream(struct catpt_dev *cdev, u8 stream_hw_id)\n{\n\tunion catpt_stream_msg msg = CATPT_STREAM_MSG(RESET_STREAM);\n\tstruct catpt_ipc_msg request = {{0}};\n\tint ret;\n\n\tmsg.stream_hw_id = stream_hw_id;\n\trequest.header = msg.val;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"reset stream %d failed: %d\\n\",\n\t\t\tstream_hw_id, ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_pause_stream(struct catpt_dev *cdev, u8 stream_hw_id)\n{\n\tunion catpt_stream_msg msg = CATPT_STREAM_MSG(PAUSE_STREAM);\n\tstruct catpt_ipc_msg request = {{0}};\n\tint ret;\n\n\tmsg.stream_hw_id = stream_hw_id;\n\trequest.header = msg.val;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"pause stream %d failed: %d\\n\",\n\t\t\tstream_hw_id, ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_resume_stream(struct catpt_dev *cdev, u8 stream_hw_id)\n{\n\tunion catpt_stream_msg msg = CATPT_STREAM_MSG(RESUME_STREAM);\n\tstruct catpt_ipc_msg request = {{0}};\n\tint ret;\n\n\tmsg.stream_hw_id = stream_hw_id;\n\trequest.header = msg.val;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"resume stream %d failed: %d\\n\",\n\t\t\tstream_hw_id, ret);\n\n\treturn ret;\n}\n\nstruct catpt_set_volume_input {\n\tu32 channel;\n\tu32 target_volume;\n\tu64 curve_duration;\n\tu32 curve_type;\n} __packed;\n\nint catpt_ipc_set_volume(struct catpt_dev *cdev, u8 stream_hw_id,\n\t\t\t u32 channel, u32 volume,\n\t\t\t u32 curve_duration,\n\t\t\t enum catpt_audio_curve_type curve_type)\n{\n\tunion catpt_stream_msg msg = CATPT_STAGE_MSG(SET_VOLUME);\n\tstruct catpt_ipc_msg request;\n\tstruct catpt_set_volume_input input;\n\tint ret;\n\n\tmsg.stream_hw_id = stream_hw_id;\n\tinput.channel = channel;\n\tinput.target_volume = volume;\n\tinput.curve_duration = curve_duration;\n\tinput.curve_type = curve_type;\n\n\trequest.header = msg.val;\n\trequest.size = sizeof(input);\n\trequest.data = &input;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"set stream %d volume failed: %d\\n\",\n\t\t\tstream_hw_id, ret);\n\n\treturn ret;\n}\n\nstruct catpt_set_write_pos_input {\n\tu32 new_write_pos;\n\tbool end_of_buffer;\n\tbool low_latency;\n} __packed;\n\nint catpt_ipc_set_write_pos(struct catpt_dev *cdev, u8 stream_hw_id,\n\t\t\t    u32 pos, bool eob, bool ll)\n{\n\tunion catpt_stream_msg msg = CATPT_STAGE_MSG(SET_WRITE_POSITION);\n\tstruct catpt_ipc_msg request;\n\tstruct catpt_set_write_pos_input input;\n\tint ret;\n\n\tmsg.stream_hw_id = stream_hw_id;\n\tinput.new_write_pos = pos;\n\tinput.end_of_buffer = eob;\n\tinput.low_latency = ll;\n\n\trequest.header = msg.val;\n\trequest.size = sizeof(input);\n\trequest.data = &input;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"set stream %d write pos failed: %d\\n\",\n\t\t\tstream_hw_id, ret);\n\n\treturn ret;\n}\n\nint catpt_ipc_mute_loopback(struct catpt_dev *cdev, u8 stream_hw_id, bool mute)\n{\n\tunion catpt_stream_msg msg = CATPT_STAGE_MSG(MUTE_LOOPBACK);\n\tstruct catpt_ipc_msg request;\n\tint ret;\n\n\tmsg.stream_hw_id = stream_hw_id;\n\trequest.header = msg.val;\n\trequest.size = sizeof(mute);\n\trequest.data = &mute;\n\n\tret = catpt_dsp_send_msg(cdev, request, NULL);\n\tif (ret)\n\t\tdev_err(cdev->dev, \"mute loopback failed: %d\\n\", ret);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}