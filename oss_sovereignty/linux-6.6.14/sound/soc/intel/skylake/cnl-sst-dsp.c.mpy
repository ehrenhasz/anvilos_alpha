{
  "module_name": "cnl-sst-dsp.c",
  "hash_id": "1cd12dacff3684d593062db670d173190ff3a39bd077826cbd3b2fab0dba9fbd",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/skylake/cnl-sst-dsp.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include \"../common/sst-dsp.h\"\n#include \"../common/sst-ipc.h\"\n#include \"../common/sst-dsp-priv.h\"\n#include \"cnl-sst-dsp.h\"\n\n \n#define CNL_DSP_PU_TO\t\t50\n#define CNL_DSP_PD_TO\t\t50\n#define CNL_DSP_RESET_TO\t50\n\nstatic int\ncnl_dsp_core_set_reset_state(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\t \n\tsst_dsp_shim_update_bits_unlocked(ctx,\n\t\t\tCNL_ADSP_REG_ADSPCS, CNL_ADSPCS_CRST(core_mask),\n\t\t\tCNL_ADSPCS_CRST(core_mask));\n\n\t \n\treturn sst_dsp_register_poll(ctx,\n\t\t\tCNL_ADSP_REG_ADSPCS,\n\t\t\tCNL_ADSPCS_CRST(core_mask),\n\t\t\tCNL_ADSPCS_CRST(core_mask),\n\t\t\tCNL_DSP_RESET_TO,\n\t\t\t\"Set reset\");\n}\n\nstatic int\ncnl_dsp_core_unset_reset_state(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\t \n\tsst_dsp_shim_update_bits_unlocked(ctx, CNL_ADSP_REG_ADSPCS,\n\t\t\t\t\tCNL_ADSPCS_CRST(core_mask), 0);\n\n\t \n\treturn sst_dsp_register_poll(ctx,\n\t\t\tCNL_ADSP_REG_ADSPCS,\n\t\t\tCNL_ADSPCS_CRST(core_mask),\n\t\t\t0,\n\t\t\tCNL_DSP_RESET_TO,\n\t\t\t\"Unset reset\");\n}\n\nstatic bool is_cnl_dsp_core_enable(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\tint val;\n\tbool is_enable;\n\n\tval = sst_dsp_shim_read_unlocked(ctx, CNL_ADSP_REG_ADSPCS);\n\n\tis_enable = (val & CNL_ADSPCS_CPA(core_mask)) &&\n\t\t\t(val & CNL_ADSPCS_SPA(core_mask)) &&\n\t\t\t!(val & CNL_ADSPCS_CRST(core_mask)) &&\n\t\t\t!(val & CNL_ADSPCS_CSTALL(core_mask));\n\n\tdev_dbg(ctx->dev, \"DSP core(s) enabled? %d: core_mask %#x\\n\",\n\t\tis_enable, core_mask);\n\n\treturn is_enable;\n}\n\nstatic int cnl_dsp_reset_core(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\t \n\tsst_dsp_shim_update_bits_unlocked(ctx, CNL_ADSP_REG_ADSPCS,\n\t\t\tCNL_ADSPCS_CSTALL(core_mask),\n\t\t\tCNL_ADSPCS_CSTALL(core_mask));\n\n\t \n\treturn cnl_dsp_core_set_reset_state(ctx, core_mask);\n}\n\nstatic int cnl_dsp_start_core(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\tint ret;\n\n\t \n\tret = cnl_dsp_core_unset_reset_state(ctx, core_mask);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tsst_dsp_shim_update_bits_unlocked(ctx, CNL_ADSP_REG_ADSPCS,\n\t\t\t\tCNL_ADSPCS_CSTALL(core_mask), 0);\n\n\tif (!is_cnl_dsp_core_enable(ctx, core_mask)) {\n\t\tcnl_dsp_reset_core(ctx, core_mask);\n\t\tdev_err(ctx->dev, \"DSP core mask %#x enable failed\\n\",\n\t\t\tcore_mask);\n\t\tret = -EIO;\n\t}\n\n\treturn ret;\n}\n\nstatic int cnl_dsp_core_power_up(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\t \n\tsst_dsp_shim_update_bits_unlocked(ctx, CNL_ADSP_REG_ADSPCS,\n\t\t\t\t\t  CNL_ADSPCS_SPA(core_mask),\n\t\t\t\t\t  CNL_ADSPCS_SPA(core_mask));\n\n\t \n\treturn sst_dsp_register_poll(ctx, CNL_ADSP_REG_ADSPCS,\n\t\t\t\t    CNL_ADSPCS_CPA(core_mask),\n\t\t\t\t    CNL_ADSPCS_CPA(core_mask),\n\t\t\t\t    CNL_DSP_PU_TO,\n\t\t\t\t    \"Power up\");\n}\n\nstatic int cnl_dsp_core_power_down(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\t \n\tsst_dsp_shim_update_bits_unlocked(ctx, CNL_ADSP_REG_ADSPCS,\n\t\t\t\t\tCNL_ADSPCS_SPA(core_mask), 0);\n\n\t \n\treturn sst_dsp_register_poll(ctx,\n\t\t\tCNL_ADSP_REG_ADSPCS,\n\t\t\tCNL_ADSPCS_CPA(core_mask),\n\t\t\t0,\n\t\t\tCNL_DSP_PD_TO,\n\t\t\t\"Power down\");\n}\n\nint cnl_dsp_enable_core(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\tint ret;\n\n\t \n\tret = cnl_dsp_core_power_up(ctx, core_mask);\n\tif (ret < 0) {\n\t\tdev_dbg(ctx->dev, \"DSP core mask %#x power up failed\",\n\t\t\tcore_mask);\n\t\treturn ret;\n\t}\n\n\treturn cnl_dsp_start_core(ctx, core_mask);\n}\n\nint cnl_dsp_disable_core(struct sst_dsp *ctx, unsigned int core_mask)\n{\n\tint ret;\n\n\tret = cnl_dsp_reset_core(ctx, core_mask);\n\tif (ret < 0) {\n\t\tdev_err(ctx->dev, \"DSP core mask %#x reset failed\\n\",\n\t\t\tcore_mask);\n\t\treturn ret;\n\t}\n\n\t \n\tret = cnl_dsp_core_power_down(ctx, core_mask);\n\tif (ret < 0) {\n\t\tdev_err(ctx->dev, \"DSP core mask %#x power down failed\\n\",\n\t\t\tcore_mask);\n\t\treturn ret;\n\t}\n\n\tif (is_cnl_dsp_core_enable(ctx, core_mask)) {\n\t\tdev_err(ctx->dev, \"DSP core mask %#x disable failed\\n\",\n\t\t\tcore_mask);\n\t\tret = -EIO;\n\t}\n\n\treturn ret;\n}\n\nirqreturn_t cnl_dsp_sst_interrupt(int irq, void *dev_id)\n{\n\tstruct sst_dsp *ctx = dev_id;\n\tu32 val;\n\tirqreturn_t ret = IRQ_NONE;\n\n\tspin_lock(&ctx->spinlock);\n\n\tval = sst_dsp_shim_read_unlocked(ctx, CNL_ADSP_REG_ADSPIS);\n\tctx->intr_status = val;\n\n\tif (val == 0xffffffff) {\n\t\tspin_unlock(&ctx->spinlock);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (val & CNL_ADSPIS_IPC) {\n\t\tcnl_ipc_int_disable(ctx);\n\t\tret = IRQ_WAKE_THREAD;\n\t}\n\n\tspin_unlock(&ctx->spinlock);\n\n\treturn ret;\n}\n\nvoid cnl_dsp_free(struct sst_dsp *dsp)\n{\n\tcnl_ipc_int_disable(dsp);\n\n\tfree_irq(dsp->irq, dsp);\n\tcnl_ipc_op_int_disable(dsp);\n\tcnl_dsp_disable_core(dsp, SKL_DSP_CORE0_MASK);\n}\nEXPORT_SYMBOL_GPL(cnl_dsp_free);\n\nvoid cnl_ipc_int_enable(struct sst_dsp *ctx)\n{\n\tsst_dsp_shim_update_bits(ctx, CNL_ADSP_REG_ADSPIC,\n\t\t\t\t CNL_ADSPIC_IPC, CNL_ADSPIC_IPC);\n}\n\nvoid cnl_ipc_int_disable(struct sst_dsp *ctx)\n{\n\tsst_dsp_shim_update_bits_unlocked(ctx, CNL_ADSP_REG_ADSPIC,\n\t\t\t\t\t  CNL_ADSPIC_IPC, 0);\n}\n\nvoid cnl_ipc_op_int_enable(struct sst_dsp *ctx)\n{\n\t \n\tsst_dsp_shim_update_bits(ctx, CNL_ADSP_REG_HIPCCTL,\n\t\t\t\t CNL_ADSP_REG_HIPCCTL_DONE,\n\t\t\t\t CNL_ADSP_REG_HIPCCTL_DONE);\n\n\t \n\tsst_dsp_shim_update_bits(ctx, CNL_ADSP_REG_HIPCCTL,\n\t\t\t\t CNL_ADSP_REG_HIPCCTL_BUSY,\n\t\t\t\t CNL_ADSP_REG_HIPCCTL_BUSY);\n}\n\nvoid cnl_ipc_op_int_disable(struct sst_dsp *ctx)\n{\n\t \n\tsst_dsp_shim_update_bits(ctx, CNL_ADSP_REG_HIPCCTL,\n\t\t\t\t CNL_ADSP_REG_HIPCCTL_DONE, 0);\n\n\t \n\tsst_dsp_shim_update_bits(ctx, CNL_ADSP_REG_HIPCCTL,\n\t\t\t\t CNL_ADSP_REG_HIPCCTL_BUSY, 0);\n}\n\nbool cnl_ipc_int_status(struct sst_dsp *ctx)\n{\n\treturn sst_dsp_shim_read_unlocked(ctx, CNL_ADSP_REG_ADSPIS) &\n\t\t\t\t\t\t\tCNL_ADSPIS_IPC;\n}\n\nvoid cnl_ipc_free(struct sst_generic_ipc *ipc)\n{\n\tcnl_ipc_op_int_disable(ipc->dsp);\n\tsst_ipc_fini(ipc);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}