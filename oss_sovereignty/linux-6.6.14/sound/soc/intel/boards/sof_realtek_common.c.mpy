{
  "module_name": "sof_realtek_common.c",
  "hash_id": "a19ecbe0e60bcec4f2429f8e23c90569ca09c143f07b774cf5113830da34c11e",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_realtek_common.c",
  "human_readable_source": "\n\n\n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include <sound/soc-dai.h>\n#include <sound/soc-dapm.h>\n#include <sound/sof.h>\n#include <uapi/sound/asound.h>\n#include \"../../codecs/rt1011.h\"\n#include \"../../codecs/rt1015.h\"\n#include \"../../codecs/rt1308.h\"\n#include \"sof_realtek_common.h\"\n\n \nstatic const struct snd_soc_dapm_route speaker_map_lr[] = {\n\t \n\t{ \"Left Spk\", NULL, \"Left SPO\" },\n\t{ \"Right Spk\", NULL, \"Right SPO\" },\n};\n\n \nstatic struct snd_soc_codec_conf rt1011_codec_confs[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1011_DEV0_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1011_DEV1_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n};\n\nstatic struct snd_soc_dai_link_component rt1011_dai_link_components[] = {\n\t{\n\t\t.name = RT1011_DEV0_NAME,\n\t\t.dai_name = RT1011_CODEC_DAI,\n\t},\n\t{\n\t\t.name = RT1011_DEV1_NAME,\n\t\t.dai_name = RT1011_CODEC_DAI,\n\t},\n};\n\nstatic const struct {\n\tunsigned int tx;\n\tunsigned int rx;\n} rt1011_tdm_mask[] = {\n\t{.tx = 0x4, .rx = 0x1},\n\t{.tx = 0x8, .rx = 0x2},\n};\n\nstatic int rt1011_hw_params(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tint srate, i, ret = 0;\n\n\tsrate = params_rate(params);\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\t \n\t\tret = snd_soc_dai_set_pll(codec_dai, 0, RT1011_PLL1_S_BCLK,\n\t\t\t\t\t  100 * srate, 256 * srate);\n\t\tif (ret < 0) {\n\t\t\tdev_err(codec_dai->dev, \"fail to set pll, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, RT1011_FS_SYS_PRE_S_PLL1,\n\t\t\t\t\t     256 * srate, SND_SOC_CLOCK_IN);\n\t\tif (ret < 0) {\n\t\t\tdev_err(codec_dai->dev, \"fail to set sysclk, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (i >= ARRAY_SIZE(rt1011_tdm_mask)) {\n\t\t\tdev_err(codec_dai->dev, \"invalid codec index %d\\n\",\n\t\t\t\ti);\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tret = snd_soc_dai_set_tdm_slot(codec_dai, rt1011_tdm_mask[i].tx,\n\t\t\t\t\t       rt1011_tdm_mask[i].rx, 4,\n\t\t\t\t\t       params_width(params));\n\t\tif (ret < 0) {\n\t\t\tdev_err(codec_dai->dev, \"fail to set tdm slot, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops rt1011_ops = {\n\t.hw_params = rt1011_hw_params,\n};\n\nstatic int rt1011_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, speaker_map_lr,\n\t\t\t\t      ARRAY_SIZE(speaker_map_lr));\n\tif (ret)\n\t\tdev_err(rtd->dev, \"Speaker map addition failed: %d\\n\", ret);\n\treturn ret;\n}\n\nvoid sof_rt1011_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = rt1011_dai_link_components;\n\tlink->num_codecs = ARRAY_SIZE(rt1011_dai_link_components);\n\tlink->init = rt1011_init;\n\tlink->ops = &rt1011_ops;\n}\nEXPORT_SYMBOL_NS(sof_rt1011_dai_link, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\nvoid sof_rt1011_codec_conf(struct snd_soc_card *card)\n{\n\tcard->codec_conf = rt1011_codec_confs;\n\tcard->num_configs = ARRAY_SIZE(rt1011_codec_confs);\n}\nEXPORT_SYMBOL_NS(sof_rt1011_codec_conf, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\n \nstatic const struct snd_soc_dapm_route rt1015p_1dev_dapm_routes[] = {\n\t \n\t{ \"Left Spk\", NULL, \"Speaker\" },\n\t{ \"Right Spk\", NULL, \"Speaker\" },\n};\n\nstatic const struct snd_soc_dapm_route rt1015p_2dev_dapm_routes[] = {\n\t \n\t{ \"Left Spk\", NULL, \"Left Speaker\" },\n\t{ \"Right Spk\", NULL, \"Right Speaker\" },\n};\n\nstatic struct snd_soc_codec_conf rt1015p_codec_confs[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015P_DEV0_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015P_DEV1_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n};\n\nstatic struct snd_soc_dai_link_component rt1015p_dai_link_components[] = {\n\t{\n\t\t.name = RT1015P_DEV0_NAME,\n\t\t.dai_name = RT1015P_CODEC_DAI,\n\t},\n\t{\n\t\t.name = RT1015P_DEV1_NAME,\n\t\t.dai_name = RT1015P_CODEC_DAI,\n\t},\n};\n\nstatic int rt1015p_get_num_codecs(void)\n{\n\tstatic int dev_num;\n\n\tif (dev_num)\n\t\treturn dev_num;\n\n\tif (!acpi_dev_present(\"RTL1015\", \"1\", -1))\n\t\tdev_num = 1;\n\telse\n\t\tdev_num = 2;\n\n\treturn dev_num;\n}\n\nstatic int rt1015p_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\t \n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops rt1015p_ops = {\n\t.hw_params = rt1015p_hw_params,\n};\n\nstatic int rt1015p_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tif (rt1015p_get_num_codecs() == 1)\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, rt1015p_1dev_dapm_routes,\n\t\t\t\t\t      ARRAY_SIZE(rt1015p_1dev_dapm_routes));\n\telse\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, rt1015p_2dev_dapm_routes,\n\t\t\t\t\t      ARRAY_SIZE(rt1015p_2dev_dapm_routes));\n\tif (ret)\n\t\tdev_err(rtd->dev, \"Speaker map addition failed: %d\\n\", ret);\n\treturn ret;\n}\n\nvoid sof_rt1015p_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = rt1015p_dai_link_components;\n\tlink->num_codecs = rt1015p_get_num_codecs();\n\tlink->init = rt1015p_init;\n\tlink->ops = &rt1015p_ops;\n}\nEXPORT_SYMBOL_NS(sof_rt1015p_dai_link, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\nvoid sof_rt1015p_codec_conf(struct snd_soc_card *card)\n{\n\tif (rt1015p_get_num_codecs() == 1)\n\t\treturn;\n\n\tcard->codec_conf = rt1015p_codec_confs;\n\tcard->num_configs = ARRAY_SIZE(rt1015p_codec_confs);\n}\nEXPORT_SYMBOL_NS(sof_rt1015p_codec_conf, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\n \n\nstatic const struct {\n\tunsigned int tx;\n\tunsigned int rx;\n} rt1015_tdm_mask[] = {\n\t{.tx = 0x0, .rx = 0x1},\n\t{.tx = 0x0, .rx = 0x2},\n};\n\nstatic int rt1015_hw_params(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai_link *dai_link = rtd->dai_link;\n\tstruct snd_soc_dai *codec_dai;\n\tint i, clk_freq;\n\tint ret = 0;\n\n\tclk_freq = sof_dai_get_bclk(rtd);\n\n\tif (clk_freq <= 0) {\n\t\tdev_err(rtd->dev, \"fail to get bclk freq, ret %d\\n\", clk_freq);\n\t\treturn -EINVAL;\n\t}\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\tret = snd_soc_dai_set_pll(codec_dai, 0, RT1015_PLL_S_BCLK,\n\t\t\t\t\t  clk_freq,\n\t\t\t\t\t  params_rate(params) * 256);\n\t\tif (ret) {\n\t\t\tdev_err(codec_dai->dev, \"fail to set pll, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, RT1015_SCLK_S_PLL,\n\t\t\t\t\t     params_rate(params) * 256,\n\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\tif (ret) {\n\t\t\tdev_err(codec_dai->dev, \"fail to set sysclk, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tswitch (dai_link->dai_fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\t\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tcase SND_SOC_DAIFMT_DSP_B:\n\t\t\t \n\t\t\tret = snd_soc_dai_set_tdm_slot(codec_dai,\n\t\t\t\t\t\t       rt1015_tdm_mask[i].tx,\n\t\t\t\t\t\t       rt1015_tdm_mask[i].rx,\n\t\t\t\t\t\t       4,\n\t\t\t\t\t\t       params_width(params));\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(codec_dai->dev, \"fail to set tdm slot, ret %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_dbg(codec_dai->dev, \"codec is in I2S mode\\n\");\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic struct snd_soc_ops rt1015_ops = {\n\t.hw_params = rt1015_hw_params,\n};\n\nstatic struct snd_soc_codec_conf rt1015_amp_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015_DEV0_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015_DEV1_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n};\n\nstatic struct snd_soc_dai_link_component rt1015_components[] = {\n\t{\n\t\t.name = RT1015_DEV0_NAME,\n\t\t.dai_name = RT1015_CODEC_DAI,\n\t},\n\t{\n\t\t.name = RT1015_DEV1_NAME,\n\t\t.dai_name = RT1015_CODEC_DAI,\n\t},\n};\n\nstatic int speaker_codec_init_lr(struct snd_soc_pcm_runtime *rtd)\n{\n\treturn snd_soc_dapm_add_routes(&rtd->card->dapm, speaker_map_lr,\n\t\t\t\t\tARRAY_SIZE(speaker_map_lr));\n}\n\nvoid sof_rt1015_codec_conf(struct snd_soc_card *card)\n{\n\tcard->codec_conf = rt1015_amp_conf;\n\tcard->num_configs = ARRAY_SIZE(rt1015_amp_conf);\n}\nEXPORT_SYMBOL_NS(sof_rt1015_codec_conf, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\nvoid sof_rt1015_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = rt1015_components;\n\tlink->num_codecs = ARRAY_SIZE(rt1015_components);\n\tlink->init = speaker_codec_init_lr;\n\tlink->ops = &rt1015_ops;\n}\nEXPORT_SYMBOL_NS(sof_rt1015_dai_link, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\n \nstatic const struct snd_kcontrol_new rt1308_kcontrols[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Speakers\"),\n};\n\nstatic const struct snd_soc_dapm_widget rt1308_dapm_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Speakers\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route rt1308_dapm_routes[] = {\n\t \n\t{\"Speakers\", NULL, \"SPOL\"},\n\t{\"Speakers\", NULL, \"SPOR\"},\n};\n\nstatic struct snd_soc_dai_link_component rt1308_components[] = {\n\t{\n\t\t.name = RT1308_DEV0_NAME,\n\t\t.dai_name = RT1308_CODEC_DAI,\n\t}\n};\n\nstatic int rt1308_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, rt1308_dapm_widgets,\n\t\t\t\t\tARRAY_SIZE(rt1308_dapm_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"fail to add dapm controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, rt1308_kcontrols,\n\t\t\t\t\tARRAY_SIZE(rt1308_kcontrols));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"fail to add card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, rt1308_dapm_routes,\n\t\t\t\t      ARRAY_SIZE(rt1308_dapm_routes));\n\n\tif (ret)\n\t\tdev_err(rtd->dev, \"fail to add dapm routes, ret %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int rt1308_hw_params(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint clk_id, clk_freq, pll_out;\n\tint ret;\n\n\tclk_id = RT1308_PLL_S_MCLK;\n\t \n\tclk_freq = sof_dai_get_mclk(rtd);\n\n\tpll_out = params_rate(params) * 512;\n\n\t \n\tret = snd_soc_dai_set_pll(codec_dai, 0, clk_id, clk_freq, pll_out);\n\tif (ret < 0) {\n\t\tdev_err(card->dev, \"Failed to set RT1308 PLL: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, RT1308_FS_SYS_S_PLL, pll_out,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\tdev_err(card->dev, \"Failed to set RT1308 SYSCLK: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops rt1308_ops = {\n\t.hw_params = rt1308_hw_params,\n};\n\nvoid sof_rt1308_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = rt1308_components;\n\tlink->num_codecs = ARRAY_SIZE(rt1308_components);\n\tlink->init = rt1308_init;\n\tlink->ops = &rt1308_ops;\n}\nEXPORT_SYMBOL_NS(sof_rt1308_dai_link, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\n \n\nstatic const struct snd_soc_dapm_route rt1019p_dapm_routes[] = {\n\t \n\t{ \"Left Spk\", NULL, \"Speaker\" },\n\t{ \"Right Spk\", NULL, \"Speaker\" },\n};\n\nstatic struct snd_soc_dai_link_component rt1019p_components[] = {\n\t{\n\t\t.name = RT1019P_DEV0_NAME,\n\t\t.dai_name = RT1019P_CODEC_DAI,\n\t},\n};\n\nstatic int rt1019p_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, rt1019p_dapm_routes,\n\t\t\t\t      ARRAY_SIZE(rt1019p_dapm_routes));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Speaker map addition failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\treturn ret;\n}\n\nvoid sof_rt1019p_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = rt1019p_components;\n\tlink->num_codecs = ARRAY_SIZE(rt1019p_components);\n\tlink->init = rt1019p_init;\n}\nEXPORT_SYMBOL_NS(sof_rt1019p_dai_link, SND_SOC_INTEL_SOF_REALTEK_COMMON);\n\nMODULE_DESCRIPTION(\"ASoC Intel SOF Realtek helpers\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}