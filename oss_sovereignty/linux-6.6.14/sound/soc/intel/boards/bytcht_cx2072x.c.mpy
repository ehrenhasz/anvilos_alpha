{
  "module_name": "bytcht_cx2072x.c",
  "hash_id": "11d17ead9efcba99f42c19ad3532061e1cbe3bf5f9bc5f836b2b67a795d05cc6",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/bytcht_cx2072x.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/acpi.h>\n#include <linux/device.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/jack.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/cx2072x.h\"\n#include \"../atom/sst-atom-controls.h\"\n\nstatic const struct snd_soc_dapm_widget byt_cht_cx2072x_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Int Mic\", NULL),\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route byt_cht_cx2072x_audio_map[] = {\n\t \n\t{\"Headphone\", NULL, \"PORTA\"},\n\t{\"Ext Spk\", NULL, \"PORTG\"},\n\t{\"PORTC\", NULL, \"Int Mic\"},\n\t{\"PORTD\", NULL, \"Headset Mic\"},\n\n\t{\"Playback\", NULL, \"ssp2 Tx\"},\n\t{\"ssp2 Tx\", NULL, \"codec_out0\"},\n\t{\"ssp2 Tx\", NULL, \"codec_out1\"},\n\t{\"codec_in0\", NULL, \"ssp2 Rx\"},\n\t{\"codec_in1\", NULL, \"ssp2 Rx\"},\n\t{\"ssp2 Rx\", NULL, \"Capture\"},\n};\n\nstatic const struct snd_kcontrol_new byt_cht_cx2072x_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Int Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Ext Spk\"),\n};\n\nstatic struct snd_soc_jack byt_cht_cx2072x_headset;\n\n \nstatic struct snd_soc_jack_pin byt_cht_cx2072x_headset_pins[] = {\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Headphone\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n};\n\nstatic const struct acpi_gpio_params byt_cht_cx2072x_headset_gpios;\nstatic const struct acpi_gpio_mapping byt_cht_cx2072x_acpi_gpios[] = {\n\t{ \"headset-gpios\", &byt_cht_cx2072x_headset_gpios, 1 },\n\t{},\n};\n\nstatic int byt_cht_cx2072x_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct snd_soc_component *codec = asoc_rtd_to_codec(rtd, 0)->component;\n\tint ret;\n\n\tif (devm_acpi_dev_add_driver_gpios(codec->dev,\n\t\t\t\t\t   byt_cht_cx2072x_acpi_gpios))\n\t\tdev_warn(rtd->dev, \"Unable to add GPIO mapping table\\n\");\n\n\tcard->dapm.idle_bias_off = true;\n\n\t \n\tret = snd_soc_dai_set_sysclk(asoc_rtd_to_codec(rtd, 0), CX2072X_MCLK_EXTERNAL_PLL,\n\t\t\t\t     19200000, SND_SOC_CLOCK_IN);\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Could not set sysclk\\n\");\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_card_jack_new_pins(card, \"Headset\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_BTN_0,\n\t\t\t\t\t &byt_cht_cx2072x_headset,\n\t\t\t\t\t byt_cht_cx2072x_headset_pins,\n\t\t\t\t\t ARRAY_SIZE(byt_cht_cx2072x_headset_pins));\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_soc_component_set_jack(codec, &byt_cht_cx2072x_headset, NULL);\n\n\tsnd_soc_dai_set_bclk_ratio(asoc_rtd_to_codec(rtd, 0), 50);\n\n\treturn 0;\n}\n\nstatic int byt_cht_cx2072x_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t struct snd_pcm_hw_params *params)\n{\n\tstruct snd_interval *rate =\n\t\thw_param_interval(params, SNDRV_PCM_HW_PARAM_RATE);\n\tstruct snd_interval *channels =\n\t\thw_param_interval(params, SNDRV_PCM_HW_PARAM_CHANNELS);\n\tint ret;\n\n\t \n\trate->min = rate->max = 48000;\n\tchannels->min = channels->max = 2;\n\n\t \n\tparams_set_format(params, SNDRV_PCM_FORMAT_S24_LE);\n\n\t \n\tret = snd_soc_dai_set_fmt(asoc_rtd_to_cpu(rtd, 0),\n\t\t\t\tSND_SOC_DAIFMT_I2S     |\n\t\t\t\tSND_SOC_DAIFMT_NB_NF   |\n\t\t\t\tSND_SOC_DAIFMT_BP_FP);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set format to I2S, err %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_tdm_slot(asoc_rtd_to_cpu(rtd, 0), 0x3, 0x3, 2, 24);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set I2S config, err %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int byt_cht_cx2072x_aif1_startup(struct snd_pcm_substream *substream)\n{\n\treturn snd_pcm_hw_constraint_single(substream->runtime,\n\t\t\t\t\t    SNDRV_PCM_HW_PARAM_RATE, 48000);\n}\n\nstatic const struct snd_soc_ops byt_cht_cx2072x_aif1_ops = {\n\t.startup = byt_cht_cx2072x_aif1_startup,\n};\n\nSND_SOC_DAILINK_DEF(dummy,\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()));\n\nSND_SOC_DAILINK_DEF(media,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"media-cpu-dai\")));\n\nSND_SOC_DAILINK_DEF(deepbuffer,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"deepbuffer-cpu-dai\")));\n\nSND_SOC_DAILINK_DEF(ssp2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"ssp2-port\")));\n\nSND_SOC_DAILINK_DEF(cx2072x,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-14F10720:00\", \"cx2072x-hifi\")));\n\nSND_SOC_DAILINK_DEF(platform,\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"sst-mfld-platform\")));\n\nstatic struct snd_soc_dai_link byt_cht_cx2072x_dais[] = {\n\t[MERR_DPCM_AUDIO] = {\n\t\t.name = \"Audio Port\",\n\t\t.stream_name = \"Audio\",\n\t\t.nonatomic = true,\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ops = &byt_cht_cx2072x_aif1_ops,\n\t\tSND_SOC_DAILINK_REG(media, dummy, platform),\n\t},\n\t[MERR_DPCM_DEEP_BUFFER] = {\n\t\t.name = \"Deep-Buffer Audio Port\",\n\t\t.stream_name = \"Deep-Buffer Audio\",\n\t\t.nonatomic = true,\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ops = &byt_cht_cx2072x_aif1_ops,\n\t\tSND_SOC_DAILINK_REG(deepbuffer, dummy, platform),\n\t},\n\t \n\t{\n\t\t.name = \"SSP2-Codec\",\n\t\t.id = 0,\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF\n\t\t\t\t\t      | SND_SOC_DAIFMT_CBC_CFC,\n\t\t.init = byt_cht_cx2072x_init,\n\t\t.be_hw_params_fixup = byt_cht_cx2072x_fixup,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(ssp2, cx2072x, platform),\n\t},\n};\n\n \n#define SOF_CARD_NAME \"bytcht cx2072x\"  \n#define SOF_DRIVER_NAME \"SOF\"\n\n#define CARD_NAME \"bytcht-cx2072x\"\n#define DRIVER_NAME NULL  \n\n \nstatic struct snd_soc_card byt_cht_cx2072x_card = {\n\t.name = CARD_NAME,\n\t.driver_name = DRIVER_NAME,\n\t.owner = THIS_MODULE,\n\t.dai_link = byt_cht_cx2072x_dais,\n\t.num_links = ARRAY_SIZE(byt_cht_cx2072x_dais),\n\t.dapm_widgets = byt_cht_cx2072x_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(byt_cht_cx2072x_widgets),\n\t.dapm_routes = byt_cht_cx2072x_audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(byt_cht_cx2072x_audio_map),\n\t.controls = byt_cht_cx2072x_controls,\n\t.num_controls = ARRAY_SIZE(byt_cht_cx2072x_controls),\n};\n\nstatic char codec_name[SND_ACPI_I2C_ID_LEN];\n\nstatic int snd_byt_cht_cx2072x_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_acpi_mach *mach;\n\tstruct acpi_device *adev;\n\tint dai_index = 0;\n\tbool sof_parent;\n\tint i, ret;\n\n\tbyt_cht_cx2072x_card.dev = &pdev->dev;\n\tmach = dev_get_platdata(&pdev->dev);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(byt_cht_cx2072x_dais); i++) {\n\t\tif (!strcmp(byt_cht_cx2072x_dais[i].codecs->name,\n\t\t\t    \"i2c-14F10720:00\")) {\n\t\t\tdai_index = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tadev = acpi_dev_get_first_match_dev(mach->id, NULL, -1);\n\tif (adev) {\n\t\tsnprintf(codec_name, sizeof(codec_name), \"i2c-%s\",\n\t\t\t acpi_dev_name(adev));\n\t\tbyt_cht_cx2072x_dais[dai_index].codecs->name = codec_name;\n\t}\n\tacpi_dev_put(adev);\n\n\t \n\tret = snd_soc_fixup_dai_links_platform_name(&byt_cht_cx2072x_card,\n\t\t\t\t\t\t    mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\tsof_parent = snd_soc_acpi_sof_parent(&pdev->dev);\n\n\t \n\tif (sof_parent) {\n\t\tbyt_cht_cx2072x_card.name = SOF_CARD_NAME;\n\t\tbyt_cht_cx2072x_card.driver_name = SOF_DRIVER_NAME;\n\t} else {\n\t\tbyt_cht_cx2072x_card.name = CARD_NAME;\n\t\tbyt_cht_cx2072x_card.driver_name = DRIVER_NAME;\n\t}\n\n\t \n\tif (sof_parent)\n\t\tpdev->dev.driver->pm = &snd_soc_pm_ops;\n\n\treturn devm_snd_soc_register_card(&pdev->dev, &byt_cht_cx2072x_card);\n}\n\nstatic struct platform_driver snd_byt_cht_cx2072x_driver = {\n\t.driver = {\n\t\t.name = \"bytcht_cx2072x\",\n\t},\n\t.probe = snd_byt_cht_cx2072x_probe,\n};\nmodule_platform_driver(snd_byt_cht_cx2072x_driver);\n\nMODULE_DESCRIPTION(\"ASoC Intel(R) Baytrail/Cherrytrail Machine driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:bytcht_cx2072x\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}