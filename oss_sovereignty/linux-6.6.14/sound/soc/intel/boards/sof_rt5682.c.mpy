{
  "module_name": "sof_rt5682.c",
  "hash_id": "3589f663f0ca5a74a96aad350d140be7a2a14a330b07452a5fb9fe617bf64a50",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_rt5682.c",
  "human_readable_source": "\n\n\n \n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/clk.h>\n#include <linux/dmi.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/sof.h>\n#include <sound/rt5682.h>\n#include <sound/rt5682s.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/rt5682.h\"\n#include \"../../codecs/rt5682s.h\"\n#include \"../../codecs/rt5645.h\"\n#include \"../../codecs/hdac_hdmi.h\"\n#include \"../common/soc-intel-quirks.h\"\n#include \"hda_dsp_common.h\"\n#include \"sof_maxim_common.h\"\n#include \"sof_realtek_common.h\"\n\n#define NAME_SIZE 32\n\n#define SOF_RT5682_SSP_CODEC(quirk)\t\t((quirk) & GENMASK(2, 0))\n#define SOF_RT5682_SSP_CODEC_MASK\t\t\t(GENMASK(2, 0))\n#define SOF_RT5682_MCLK_EN\t\t\tBIT(3)\n#define SOF_RT5682_MCLK_24MHZ\t\t\tBIT(4)\n#define SOF_SPEAKER_AMP_PRESENT\t\tBIT(5)\n#define SOF_RT5682_SSP_AMP_SHIFT\t\t6\n#define SOF_RT5682_SSP_AMP_MASK                 (GENMASK(8, 6))\n#define SOF_RT5682_SSP_AMP(quirk)\t\\\n\t(((quirk) << SOF_RT5682_SSP_AMP_SHIFT) & SOF_RT5682_SSP_AMP_MASK)\n#define SOF_RT5682_MCLK_BYTCHT_EN\t\tBIT(9)\n#define SOF_RT5682_NUM_HDMIDEV_SHIFT\t\t10\n#define SOF_RT5682_NUM_HDMIDEV_MASK\t\t(GENMASK(12, 10))\n#define SOF_RT5682_NUM_HDMIDEV(quirk)\t\\\n\t((quirk << SOF_RT5682_NUM_HDMIDEV_SHIFT) & SOF_RT5682_NUM_HDMIDEV_MASK)\n#define SOF_RT1011_SPEAKER_AMP_PRESENT\t\tBIT(13)\n#define SOF_RT1015_SPEAKER_AMP_PRESENT\t\tBIT(14)\n#define SOF_RT1015P_SPEAKER_AMP_PRESENT\t\tBIT(16)\n#define SOF_MAX98373_SPEAKER_AMP_PRESENT\tBIT(17)\n#define SOF_MAX98360A_SPEAKER_AMP_PRESENT\tBIT(18)\n\n \n#define SOF_BT_OFFLOAD_SSP_SHIFT\t\t19\n#define SOF_BT_OFFLOAD_SSP_MASK\t\t(GENMASK(21, 19))\n#define SOF_BT_OFFLOAD_SSP(quirk)\t\\\n\t(((quirk) << SOF_BT_OFFLOAD_SSP_SHIFT) & SOF_BT_OFFLOAD_SSP_MASK)\n#define SOF_SSP_BT_OFFLOAD_PRESENT\t\tBIT(22)\n#define SOF_RT5682S_HEADPHONE_CODEC_PRESENT\tBIT(23)\n#define SOF_MAX98390_SPEAKER_AMP_PRESENT\tBIT(24)\n#define SOF_RT1019_SPEAKER_AMP_PRESENT\tBIT(26)\n#define SOF_RT5650_HEADPHONE_CODEC_PRESENT\tBIT(27)\n\n \n#define SOF_NO_OF_HDMI_CAPTURE_SSP_SHIFT  27\n#define SOF_SSP_HDMI_CAPTURE_PRESENT_MASK (GENMASK(30, 27))\n#define SOF_HDMI_CAPTURE_SSP_MASK(quirk)   \\\n\t(((quirk) << SOF_NO_OF_HDMI_CAPTURE_SSP_SHIFT) & SOF_SSP_HDMI_CAPTURE_PRESENT_MASK)\n\n \nstatic unsigned long sof_rt5682_quirk = SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0);\n\nstatic int is_legacy_cpu;\n\nstruct sof_hdmi_pcm {\n\tstruct list_head head;\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_jack hdmi_jack;\n\tint device;\n};\n\nstruct sof_card_private {\n\tstruct clk *mclk;\n\tstruct snd_soc_jack sof_headset;\n\tstruct list_head hdmi_pcm_list;\n\tbool common_hdmi_codec_drv;\n\tbool idisp_codec;\n};\n\nstatic int sof_rt5682_quirk_cb(const struct dmi_system_id *id)\n{\n\tsof_rt5682_quirk = (unsigned long)id->driver_data;\n\treturn 1;\n}\n\nstatic const struct dmi_system_id sof_rt5682_quirk_table[] = {\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Circuitco\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Minnowboard Max\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_SSP_CODEC(2)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"AAEON\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"UP-CHT01\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_SSP_CODEC(2)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Intel Corporation\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"WhiskeyLake Client\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(1)),\n\t},\n\t{\n\t\t \n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"HP\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Dooly\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1015_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Hatch\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Intel Corporation\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Ice Lake Client\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Volteer\"),\n\t\t\tDMI_MATCH(DMI_OEM_STRING, \"AUDIO-MAX98373_ALC5682I_I2S_UP4\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(2) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Intel Corporation\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Alder Lake Client Platform\"),\n\t\t\tDMI_MATCH(DMI_OEM_STRING, \"AUDIO-ADL_MAX98373_ALC5682I_I2S\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(2) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Brya\"),\n\t\t\tDMI_MATCH(DMI_OEM_STRING, \"AUDIO-MAX98390_ALC5682I_I2S\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98390_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(2) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Brya\"),\n\t\t\tDMI_MATCH(DMI_OEM_STRING, \"AUDIO-MAX98360_ALC5682I_I2S_AMP_SSP2\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(2) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Rex\"),\n\t\t\tDMI_MATCH(DMI_OEM_STRING, \"AUDIO-MAX98360_ALC5682I_I2S\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(2) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(0) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(1) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT\n\t\t\t\t\t),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Rex\"),\n\t\t\tDMI_MATCH(DMI_OEM_STRING, \"AUDIO-ALC1019_ALC5682I_I2S\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(2) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1019_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(0) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(3)\n\t\t\t\t\t),\n\t},\n\t{\n\t\t.callback = sof_rt5682_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_PRODUCT_FAMILY, \"Google_Rex\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(2) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(0) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(1) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT\n\t\t\t\t\t),\n\t},\n\t{}\n};\n\nstatic int sof_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct sof_hdmi_pcm *pcm;\n\n\tpcm = devm_kzalloc(rtd->card->dev, sizeof(*pcm), GFP_KERNEL);\n\tif (!pcm)\n\t\treturn -ENOMEM;\n\n\t \n\tpcm->device = rtd->dai_link->id;\n\tpcm->codec_dai = dai;\n\n\tlist_add_tail(&pcm->head, &ctx->hdmi_pcm_list);\n\n\treturn 0;\n}\n\nstatic struct snd_soc_jack_pin jack_pins[] = {\n\t{\n\t\t.pin    = \"Headphone Jack\",\n\t\t.mask   = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin    = \"Headset Mic\",\n\t\t.mask   = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int sof_rt5682_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_jack *jack;\n\tint extra_jack_data;\n\tint ret;\n\n\t \n\tif ((sof_rt5682_quirk & SOF_RT5682_MCLK_EN) &&\n\t    (sof_rt5682_quirk & SOF_RT5682_MCLK_24MHZ)) {\n\t\tif (sof_rt5682_quirk & SOF_RT5682S_HEADPHONE_CODEC_PRESENT)\n\t\t\trt5682s_sel_asrc_clk_src(component,\n\t\t\t\t\t\t RT5682S_DA_STEREO1_FILTER |\n\t\t\t\t\t\t RT5682S_AD_STEREO1_FILTER,\n\t\t\t\t\t\t RT5682S_CLK_SEL_I2S1_ASRC);\n\t\telse if (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT) {\n\t\t\trt5645_sel_asrc_clk_src(component,\n\t\t\t\t\t\tRT5645_DA_STEREO_FILTER |\n\t\t\t\t\t\tRT5645_AD_STEREO_FILTER,\n\t\t\t\t\t\tRT5645_CLK_SEL_I2S1_ASRC);\n\t\t\trt5645_sel_asrc_clk_src(component,\n\t\t\t\t\t\tRT5645_DA_MONO_L_FILTER |\n\t\t\t\t\t\tRT5645_DA_MONO_R_FILTER,\n\t\t\t\t\t\tRT5645_CLK_SEL_I2S2_ASRC);\n\t\t} else\n\t\t\trt5682_sel_asrc_clk_src(component,\n\t\t\t\t\t\tRT5682_DA_STEREO1_FILTER |\n\t\t\t\t\t\tRT5682_AD_STEREO1_FILTER,\n\t\t\t\t\t\tRT5682_CLK_SEL_I2S1_ASRC);\n\t}\n\n\tif (sof_rt5682_quirk & SOF_RT5682_MCLK_BYTCHT_EN) {\n\t\t \n\t\tret = clk_prepare_enable(ctx->mclk);\n\t\tif (!ret)\n\t\t\tclk_disable_unprepare(ctx->mclk);\n\n\t\tret = clk_set_rate(ctx->mclk, 19200000);\n\n\t\tif (ret)\n\t\t\tdev_err(rtd->dev, \"unable to set MCLK rate\\n\");\n\t}\n\n\t \n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_BTN_0 |\n\t\t\t\t\t SND_JACK_BTN_1 | SND_JACK_BTN_2 |\n\t\t\t\t\t SND_JACK_BTN_3,\n\t\t\t\t\t &ctx->sof_headset,\n\t\t\t\t\t jack_pins,\n\t\t\t\t\t ARRAY_SIZE(jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack creation failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tjack = &ctx->sof_headset;\n\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\n\tif (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT) {\n\t\textra_jack_data = SND_JACK_MICROPHONE | SND_JACK_BTN_0;\n\t\tret = snd_soc_component_set_jack(component, jack, &extra_jack_data);\n\t} else\n\t\tret = snd_soc_component_set_jack(component, jack, NULL);\n\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack call-back failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n};\n\nstatic void sof_rt5682_codec_exit(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_set_jack(component, NULL, NULL);\n}\n\nstatic int sof_rt5682_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint pll_id, pll_source, pll_in, pll_out, clk_id, ret;\n\n\tif (sof_rt5682_quirk & SOF_RT5682_MCLK_EN) {\n\t\tif (sof_rt5682_quirk & SOF_RT5682_MCLK_BYTCHT_EN) {\n\t\t\tret = clk_prepare_enable(ctx->mclk);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(rtd->dev,\n\t\t\t\t\t\"could not configure MCLK state\");\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\n\t\tif (sof_rt5682_quirk & SOF_RT5682S_HEADPHONE_CODEC_PRESENT)\n\t\t\tpll_source = RT5682S_PLL_S_MCLK;\n\t\telse if (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT)\n\t\t\tpll_source = RT5645_PLL1_S_MCLK;\n\t\telse\n\t\t\tpll_source = RT5682_PLL1_S_MCLK;\n\n\t\t \n\t\tpll_in = sof_dai_get_mclk(rtd);\n\n\t\t \n\t\tif (sof_rt5682_quirk & SOF_RT5682_MCLK_24MHZ) {\n\t\t\tif (pll_in != 24000000)\n\t\t\t\tdev_warn(rtd->dev, \"configure wrong mclk in tplg, please use 24MHz.\\n\");\n\t\t\tpll_in = 24000000;\n\t\t} else if (pll_in == 0) {\n\t\t\t \n\t\t\tpll_in = 19200000;\n\t\t} else if (pll_in < 0) {\n\t\t\treturn pll_in;\n\t\t}\n\t} else {\n\t\tif (sof_rt5682_quirk & SOF_RT5682S_HEADPHONE_CODEC_PRESENT)\n\t\t\tpll_source = RT5682S_PLL_S_BCLK1;\n\t\telse if (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT)\n\t\t\tpll_source = RT5645_PLL1_S_BCLK1;\n\t\telse\n\t\t\tpll_source = RT5682_PLL1_S_BCLK1;\n\n\t\tpll_in = params_rate(params) * 50;\n\t}\n\n\tif (sof_rt5682_quirk & SOF_RT5682S_HEADPHONE_CODEC_PRESENT) {\n\t\tpll_id = RT5682S_PLL2;\n\t\tclk_id = RT5682S_SCLK_S_PLL2;\n\t} else if (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT) {\n\t\tpll_id = 0;  \n\t\tclk_id = RT5645_SCLK_S_PLL1;\n\t} else {\n\t\tpll_id = RT5682_PLL1;\n\t\tclk_id = RT5682_SCLK_S_PLL1;\n\t}\n\n\tpll_out = params_rate(params) * 512;\n\n\t \n\tif (pll_in == pll_out)\n\t\tclk_id = RT5682S_SCLK_S_MCLK;\n\telse {\n\t\t \n\t\tret = snd_soc_dai_set_pll(codec_dai, pll_id, pll_source, pll_in,\n\t\t\t\t\t  pll_out);\n\t\tif (ret < 0)\n\t\t\tdev_err(rtd->dev, \"snd_soc_dai_set_pll err = %d\\n\", ret);\n\t}\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, clk_id,\n\t\t\t\t     pll_out, SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\tdev_err(rtd->dev, \"snd_soc_dai_set_sysclk err = %d\\n\", ret);\n\n\t \n\tret = snd_soc_dai_set_tdm_slot(codec_dai, 0x0, 0x0, 2,\n\t\t\t\t       params_width(params));\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"set TDM slot err:%d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic struct snd_soc_ops sof_rt5682_ops = {\n\t.hw_params = sof_rt5682_hw_params,\n};\n\nstatic struct snd_soc_dai_link_component platform_component[] = {\n\t{\n\t\t \n\t\t.name = \"0000:00:1f.3\"\n\t}\n};\n\nstatic int sof_card_late_probe(struct snd_soc_card *card)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_component *component = NULL;\n\tstruct snd_soc_dapm_context *dapm = &card->dapm;\n\tchar jack_name[NAME_SIZE];\n\tstruct sof_hdmi_pcm *pcm;\n\tint err;\n\n\tif (sof_rt5682_quirk & SOF_MAX98373_SPEAKER_AMP_PRESENT) {\n\t\t \n\t\tsnd_soc_dapm_disable_pin(dapm, \"Left Spk\");\n\t\tsnd_soc_dapm_disable_pin(dapm, \"Right Spk\");\n\t\terr = snd_soc_dapm_sync(dapm);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\t \n\tif (is_legacy_cpu || !ctx->idisp_codec)\n\t\treturn 0;\n\n\tif (list_empty(&ctx->hdmi_pcm_list))\n\t\treturn -EINVAL;\n\n\tif (ctx->common_hdmi_codec_drv) {\n\t\tpcm = list_first_entry(&ctx->hdmi_pcm_list, struct sof_hdmi_pcm,\n\t\t\t\t       head);\n\t\tcomponent = pcm->codec_dai->component;\n\t\treturn hda_dsp_hdmi_build_controls(card, component);\n\t}\n\n\tlist_for_each_entry(pcm, &ctx->hdmi_pcm_list, head) {\n\t\tcomponent = pcm->codec_dai->component;\n\t\tsnprintf(jack_name, sizeof(jack_name),\n\t\t\t \"HDMI/DP, pcm=%d Jack\", pcm->device);\n\t\terr = snd_soc_card_jack_new(card, jack_name,\n\t\t\t\t\t    SND_JACK_AVOUT, &pcm->hdmi_jack);\n\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = hdac_hdmi_jack_init(pcm->codec_dai, pcm->device,\n\t\t\t\t\t  &pcm->hdmi_jack);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\treturn hdac_hdmi_jack_port_init(component, &card->dapm);\n}\n\nstatic const struct snd_kcontrol_new sof_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone Jack\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Left Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Right Spk\"),\n\n};\n\nstatic const struct snd_soc_dapm_widget sof_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_SPK(\"Left Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Right Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_widget dmic_widgets[] = {\n\tSND_SOC_DAPM_MIC(\"SoC DMIC\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route sof_map[] = {\n\t \n\t{ \"Headphone Jack\", NULL, \"HPOL\" },\n\t{ \"Headphone Jack\", NULL, \"HPOR\" },\n\n\t \n\t{ \"IN1P\", NULL, \"Headset Mic\" },\n};\n\nstatic const struct snd_soc_dapm_route rt5650_spk_dapm_routes[] = {\n\t \n\t{ \"Left Spk\", NULL, \"SPOL\" },\n\t{ \"Right Spk\", NULL, \"SPOR\" },\n};\n\nstatic const struct snd_soc_dapm_route dmic_map[] = {\n\t \n\t{\"DMic\", NULL, \"SoC DMIC\"},\n};\n\nstatic int rt5650_spk_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, rt5650_spk_dapm_routes,\n\t\t\t\t      ARRAY_SIZE(rt5650_spk_dapm_routes));\n\tif (ret)\n\t\tdev_err(rtd->dev, \"fail to add dapm routes, ret=%d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int dmic_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, dmic_widgets,\n\t\t\t\t\tARRAY_SIZE(dmic_widgets));\n\tif (ret) {\n\t\tdev_err(card->dev, \"DMic widget addition failed: %d\\n\", ret);\n\t\t \n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, dmic_map,\n\t\t\t\t      ARRAY_SIZE(dmic_map));\n\n\tif (ret)\n\t\tdev_err(card->dev, \"DMic map addition failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic struct snd_soc_card sof_audio_card_rt5682 = {\n\t.name = \"rt5682\",  \n\t.owner = THIS_MODULE,\n\t.controls = sof_controls,\n\t.num_controls = ARRAY_SIZE(sof_controls),\n\t.dapm_widgets = sof_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(sof_widgets),\n\t.dapm_routes = sof_map,\n\t.num_dapm_routes = ARRAY_SIZE(sof_map),\n\t.fully_routed = true,\n\t.late_probe = sof_card_late_probe,\n};\n\nstatic struct snd_soc_dai_link_component rt5682_component[] = {\n\t{\n\t\t.name = \"i2c-10EC5682:00\",\n\t\t.dai_name = \"rt5682-aif1\",\n\t}\n};\n\nstatic struct snd_soc_dai_link_component rt5682s_component[] = {\n\t{\n\t\t.name = \"i2c-RTL5682:00\",\n\t\t.dai_name = \"rt5682s-aif1\",\n\t}\n};\n\nstatic struct snd_soc_dai_link_component rt5650_components[] = {\n\t{\n\t\t.name = \"i2c-10EC5650:00\",\n\t\t.dai_name = \"rt5645-aif1\",\n\t},\n\t{\n\t\t.name = \"i2c-10EC5650:00\",\n\t\t.dai_name = \"rt5645-aif2\",\n\t}\n};\n\nstatic struct snd_soc_dai_link_component dmic_component[] = {\n\t{\n\t\t.name = \"dmic-codec\",\n\t\t.dai_name = \"dmic-hifi\",\n\t}\n};\n\n#define IDISP_CODEC_MASK\t0x4\n\nstatic struct snd_soc_dai_link *sof_card_dai_links_create(struct device *dev,\n\t\t\t\t\t\t\t  int ssp_codec,\n\t\t\t\t\t\t\t  int ssp_amp,\n\t\t\t\t\t\t\t  int dmic_be_num,\n\t\t\t\t\t\t\t  int hdmi_num,\n\t\t\t\t\t\t\t  bool idisp_codec)\n{\n\tstruct snd_soc_dai_link_component *idisp_components;\n\tstruct snd_soc_dai_link_component *cpus;\n\tstruct snd_soc_dai_link *links;\n\tint i, id = 0;\n\tint hdmi_id_offset = 0;\n\n\tlinks = devm_kcalloc(dev, sof_audio_card_rt5682.num_links,\n\t\t\t    sizeof(struct snd_soc_dai_link), GFP_KERNEL);\n\tcpus = devm_kcalloc(dev, sof_audio_card_rt5682.num_links,\n\t\t\t    sizeof(struct snd_soc_dai_link_component), GFP_KERNEL);\n\tif (!links || !cpus)\n\t\tgoto devm_err;\n\n\t \n\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\"SSP%d-Codec\", ssp_codec);\n\tif (!links[id].name)\n\t\tgoto devm_err;\n\n\tlinks[id].id = id;\n\tif (sof_rt5682_quirk & SOF_RT5682S_HEADPHONE_CODEC_PRESENT) {\n\t\tlinks[id].codecs = rt5682s_component;\n\t\tlinks[id].num_codecs = ARRAY_SIZE(rt5682s_component);\n\t} else if (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT) {\n\t\tlinks[id].codecs = &rt5650_components[0];\n\t\tlinks[id].num_codecs = 1;\n\t} else {\n\t\tlinks[id].codecs = rt5682_component;\n\t\tlinks[id].num_codecs = ARRAY_SIZE(rt5682_component);\n\t}\n\tlinks[id].platforms = platform_component;\n\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\tlinks[id].init = sof_rt5682_codec_init;\n\tlinks[id].exit = sof_rt5682_codec_exit;\n\tlinks[id].ops = &sof_rt5682_ops;\n\tlinks[id].dpcm_playback = 1;\n\tlinks[id].dpcm_capture = 1;\n\tlinks[id].no_pcm = 1;\n\tlinks[id].cpus = &cpus[id];\n\tlinks[id].num_cpus = 1;\n\tif (is_legacy_cpu) {\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"ssp%d-port\",\n\t\t\t\t\t\t\t  ssp_codec);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t} else {\n\t\t \n\t\tlinks[id].ignore_pmdown_time = 1;\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"SSP%d Pin\",\n\t\t\t\t\t\t\t  ssp_codec);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t}\n\tid++;\n\n\t \n\tif (dmic_be_num > 0) {\n\t\t \n\t\tlinks[id].name = \"dmic01\";\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].cpus->dai_name = \"DMIC01 Pin\";\n\t\tlinks[id].init = dmic_init;\n\t\tif (dmic_be_num > 1) {\n\t\t\t \n\t\t\tlinks[id + 1].name = \"dmic16k\";\n\t\t\tlinks[id + 1].cpus = &cpus[id + 1];\n\t\t\tlinks[id + 1].cpus->dai_name = \"DMIC16k Pin\";\n\t\t\tdmic_be_num = 2;\n\t\t}\n\t}\n\n\tfor (i = 0; i < dmic_be_num; i++) {\n\t\tlinks[id].id = id;\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].codecs = dmic_component;\n\t\tlinks[id].num_codecs = ARRAY_SIZE(dmic_component);\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].ignore_suspend = 1;\n\t\tlinks[id].dpcm_capture = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tid++;\n\t}\n\n\t \n\tif (hdmi_num > 0) {\n\t\tidisp_components = devm_kcalloc(dev,\n\t\t\t\t   hdmi_num,\n\t\t\t\t   sizeof(struct snd_soc_dai_link_component),\n\t\t\t\t   GFP_KERNEL);\n\t\tif (!idisp_components)\n\t\t\tgoto devm_err;\n\t}\n\tfor (i = 1; i <= hdmi_num; i++) {\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\"iDisp%d\", i);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].id = id;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"iDisp%d Pin\", i);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\n\t\tif (idisp_codec) {\n\t\t\tidisp_components[i - 1].name = \"ehdaudio0D2\";\n\t\t\tidisp_components[i - 1].dai_name = devm_kasprintf(dev,\n\t\t\t\t\t\t\t\t\t  GFP_KERNEL,\n\t\t\t\t\t\t\t\t\t  \"intel-hdmi-hifi%d\",\n\t\t\t\t\t\t\t\t\t  i);\n\t\t\tif (!idisp_components[i - 1].dai_name)\n\t\t\t\tgoto devm_err;\n\t\t} else {\n\t\t\tidisp_components[i - 1] = asoc_dummy_dlc;\n\t\t}\n\n\t\tlinks[id].codecs = &idisp_components[i - 1];\n\t\tlinks[id].num_codecs = 1;\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].init = sof_hdmi_init;\n\t\tlinks[id].dpcm_playback = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tid++;\n\t}\n\n\t \n\tif (sof_rt5682_quirk & SOF_SPEAKER_AMP_PRESENT) {\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\"SSP%d-Codec\", ssp_amp);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].id = id;\n\t\tif (sof_rt5682_quirk & SOF_RT1015_SPEAKER_AMP_PRESENT) {\n\t\t\tsof_rt1015_dai_link(&links[id]);\n\t\t} else if (sof_rt5682_quirk & SOF_RT1015P_SPEAKER_AMP_PRESENT) {\n\t\t\tsof_rt1015p_dai_link(&links[id]);\n\t\t} else if (sof_rt5682_quirk & SOF_RT1019_SPEAKER_AMP_PRESENT) {\n\t\t\tsof_rt1019p_dai_link(&links[id]);\n\t\t} else if (sof_rt5682_quirk &\n\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT) {\n\t\t\tlinks[id].codecs = max_98373_components;\n\t\t\tlinks[id].num_codecs = ARRAY_SIZE(max_98373_components);\n\t\t\tlinks[id].init = max_98373_spk_codec_init;\n\t\t\tlinks[id].ops = &max_98373_ops;\n\t\t} else if (sof_rt5682_quirk &\n\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT) {\n\t\t\tmax_98360a_dai_link(&links[id]);\n\t\t} else if (sof_rt5682_quirk &\n\t\t\t\tSOF_RT1011_SPEAKER_AMP_PRESENT) {\n\t\t\tsof_rt1011_dai_link(&links[id]);\n\t\t} else if (sof_rt5682_quirk &\n\t\t\t\tSOF_MAX98390_SPEAKER_AMP_PRESENT) {\n\t\t\tmax_98390_dai_link(dev, &links[id]);\n\t\t} else if (sof_rt5682_quirk & SOF_RT5650_HEADPHONE_CODEC_PRESENT) {\n\t\t\tlinks[id].codecs = &rt5650_components[1];\n\t\t\tlinks[id].num_codecs = 1;\n\t\t\tlinks[id].init = rt5650_spk_init;\n\t\t\tlinks[id].ops = &sof_rt5682_ops;\n\t\t} else {\n\t\t\tmax_98357a_dai_link(&links[id]);\n\t\t}\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].dpcm_playback = 1;\n\t\t \n\t\tlinks[id].dpcm_capture = 1;\n\n\t\tlinks[id].no_pcm = 1;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].num_cpus = 1;\n\t\tif (is_legacy_cpu) {\n\t\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t\t  \"ssp%d-port\",\n\t\t\t\t\t\t\t\t  ssp_amp);\n\t\t\tif (!links[id].cpus->dai_name)\n\t\t\t\tgoto devm_err;\n\n\t\t} else {\n\t\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t\t  \"SSP%d Pin\",\n\t\t\t\t\t\t\t\t  ssp_amp);\n\t\t\tif (!links[id].cpus->dai_name)\n\t\t\t\tgoto devm_err;\n\t\t}\n\t\tid++;\n\t}\n\n\t \n\tif (sof_rt5682_quirk & SOF_SSP_BT_OFFLOAD_PRESENT) {\n\t\tint port = (sof_rt5682_quirk & SOF_BT_OFFLOAD_SSP_MASK) >>\n\t\t\t\tSOF_BT_OFFLOAD_SSP_SHIFT;\n\n\t\tlinks[id].id = id;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"SSP%d Pin\", port);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL, \"SSP%d-BT\", port);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\t\tlinks[id].codecs = &asoc_dummy_dlc;\n\t\tlinks[id].num_codecs = 1;\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].dpcm_playback = 1;\n\t\tlinks[id].dpcm_capture = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tlinks[id].num_cpus = 1;\n\t}\n\n\t \n\tif (sof_rt5682_quirk & SOF_SSP_HDMI_CAPTURE_PRESENT_MASK) {\n\t\tunsigned long hdmi_in_ssp = (sof_rt5682_quirk &\n\t\t\t\tSOF_SSP_HDMI_CAPTURE_PRESENT_MASK) >>\n\t\t\t\tSOF_NO_OF_HDMI_CAPTURE_SSP_SHIFT;\n\t\tint port = 0;\n\n\t\tfor_each_set_bit(port, &hdmi_in_ssp, 32) {\n\t\t\tlinks[id].cpus = &cpus[id];\n\t\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t\t  \"SSP%d Pin\", port);\n\t\t\tif (!links[id].cpus->dai_name)\n\t\t\t\treturn NULL;\n\t\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL, \"SSP%d-HDMI\", port);\n\t\t\tif (!links[id].name)\n\t\t\t\treturn NULL;\n\t\t\tlinks[id].id = id + hdmi_id_offset;\n\t\t\tlinks[id].codecs = &asoc_dummy_dlc;\n\t\t\tlinks[id].num_codecs = 1;\n\t\t\tlinks[id].platforms = platform_component;\n\t\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\t\tlinks[id].dpcm_capture = 1;\n\t\t\tlinks[id].no_pcm = 1;\n\t\t\tlinks[id].num_cpus = 1;\n\t\t\tid++;\n\t\t}\n\t}\n\n\treturn links;\ndevm_err:\n\treturn NULL;\n}\n\nstatic int sof_audio_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_dai_link *dai_links;\n\tstruct snd_soc_acpi_mach *mach;\n\tstruct sof_card_private *ctx;\n\tint dmic_be_num, hdmi_num;\n\tint ret, ssp_amp, ssp_codec;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tif (pdev->id_entry && pdev->id_entry->driver_data)\n\t\tsof_rt5682_quirk = (unsigned long)pdev->id_entry->driver_data;\n\n\tdmi_check_system(sof_rt5682_quirk_table);\n\n\tmach = pdev->dev.platform_data;\n\n\t \n\tif ((sof_rt5682_quirk & SOF_SPEAKER_AMP_PRESENT) && !mach->quirk_data)\n\t\tsof_rt5682_quirk &= ~SOF_SPEAKER_AMP_PRESENT;\n\n\t \n\tif (acpi_dev_present(\"RTL5682\", NULL, -1))\n\t\tsof_rt5682_quirk |= SOF_RT5682S_HEADPHONE_CODEC_PRESENT;\n\telse if (acpi_dev_present(\"10EC5650\", NULL, -1)) {\n\t\tsof_rt5682_quirk |= SOF_RT5650_HEADPHONE_CODEC_PRESENT;\n\n\t\tsof_audio_card_rt5682.name = devm_kstrdup(&pdev->dev, \"rt5650\",\n\t\t\t\t\t\t\t  GFP_KERNEL);\n\t}\n\n\tif (soc_intel_is_byt() || soc_intel_is_cht()) {\n\t\tis_legacy_cpu = 1;\n\t\tdmic_be_num = 0;\n\t\thdmi_num = 0;\n\t\t \n\t\tsof_rt5682_quirk = SOF_RT5682_MCLK_EN |\n\t\t\t\t\t\tSOF_RT5682_MCLK_BYTCHT_EN |\n\t\t\t\t\t\tSOF_RT5682_SSP_CODEC(2);\n\t} else {\n\t\tdmic_be_num = 2;\n\t\thdmi_num = (sof_rt5682_quirk & SOF_RT5682_NUM_HDMIDEV_MASK) >>\n\t\t\t SOF_RT5682_NUM_HDMIDEV_SHIFT;\n\t\t \n\t\tif (!hdmi_num)\n\t\t\thdmi_num = 3;\n\n\t\tif (mach->mach_params.codec_mask & IDISP_CODEC_MASK)\n\t\t\tctx->idisp_codec = true;\n\t}\n\n\t \n\tif (sof_rt5682_quirk & SOF_RT5682_MCLK_BYTCHT_EN) {\n\t\tctx->mclk = devm_clk_get(&pdev->dev, \"pmc_plt_clk_3\");\n\t\tif (IS_ERR(ctx->mclk)) {\n\t\t\tret = PTR_ERR(ctx->mclk);\n\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Failed to get MCLK from pmc_plt_clk_3: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = clk_prepare_enable(ctx->mclk);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"could not configure MCLK state\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tdev_dbg(&pdev->dev, \"sof_rt5682_quirk = %lx\\n\", sof_rt5682_quirk);\n\n\tssp_amp = (sof_rt5682_quirk & SOF_RT5682_SSP_AMP_MASK) >>\n\t\t\tSOF_RT5682_SSP_AMP_SHIFT;\n\n\tssp_codec = sof_rt5682_quirk & SOF_RT5682_SSP_CODEC_MASK;\n\n\t \n\tsof_audio_card_rt5682.num_links = 1 + dmic_be_num + hdmi_num;\n\n\tif (sof_rt5682_quirk & SOF_SPEAKER_AMP_PRESENT)\n\t\tsof_audio_card_rt5682.num_links++;\n\n\tif (sof_rt5682_quirk & SOF_MAX98373_SPEAKER_AMP_PRESENT)\n\t\tmax_98373_set_codec_conf(&sof_audio_card_rt5682);\n\telse if (sof_rt5682_quirk & SOF_RT1011_SPEAKER_AMP_PRESENT)\n\t\tsof_rt1011_codec_conf(&sof_audio_card_rt5682);\n\telse if (sof_rt5682_quirk & SOF_RT1015P_SPEAKER_AMP_PRESENT)\n\t\tsof_rt1015p_codec_conf(&sof_audio_card_rt5682);\n\telse if (sof_rt5682_quirk & SOF_MAX98390_SPEAKER_AMP_PRESENT) {\n\t\tmax_98390_set_codec_conf(&pdev->dev, &sof_audio_card_rt5682);\n\t}\n\n\tif (sof_rt5682_quirk & SOF_SSP_BT_OFFLOAD_PRESENT)\n\t\tsof_audio_card_rt5682.num_links++;\n\n\tif (sof_rt5682_quirk & SOF_SSP_HDMI_CAPTURE_PRESENT_MASK)\n\t\tsof_audio_card_rt5682.num_links +=\n\t\t\thweight32((sof_rt5682_quirk & SOF_SSP_HDMI_CAPTURE_PRESENT_MASK) >>\n\t\t\t\t\tSOF_NO_OF_HDMI_CAPTURE_SSP_SHIFT);\n\n\tdai_links = sof_card_dai_links_create(&pdev->dev, ssp_codec, ssp_amp,\n\t\t\t\t\t      dmic_be_num, hdmi_num, ctx->idisp_codec);\n\tif (!dai_links)\n\t\treturn -ENOMEM;\n\n\tsof_audio_card_rt5682.dai_link = dai_links;\n\n\tif (sof_rt5682_quirk & SOF_RT1015_SPEAKER_AMP_PRESENT)\n\t\tsof_rt1015_codec_conf(&sof_audio_card_rt5682);\n\n\tINIT_LIST_HEAD(&ctx->hdmi_pcm_list);\n\n\tsof_audio_card_rt5682.dev = &pdev->dev;\n\n\t \n\tret = snd_soc_fixup_dai_links_platform_name(&sof_audio_card_rt5682,\n\t\t\t\t\t\t    mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\tctx->common_hdmi_codec_drv = mach->mach_params.common_hdmi_codec_drv;\n\n\tsnd_soc_card_set_drvdata(&sof_audio_card_rt5682, ctx);\n\n\treturn devm_snd_soc_register_card(&pdev->dev,\n\t\t\t\t\t  &sof_audio_card_rt5682);\n}\n\nstatic const struct platform_device_id board_ids[] = {\n\t{\n\t\t.name = \"sof_rt5682\",\n\t},\n\t{\n\t\t.name = \"cml_rt1015_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1015_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{\n\t\t.name = \"jsl_rt5682_rt1015\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1015_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{\n\t\t.name = \"jsl_rt5682_mx98360\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{\n\t\t.name = \"jsl_rt5682_rt1015p\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1015P_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{\n\t\t.name = \"jsl_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0)),\n\t},\n\t{\n\t\t.name = \"tgl_mx98357_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"tgl_rt1011_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1011_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"tgl_mx98373_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_mx98373_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_mx98357_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(2) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.name = \"adl_max98390_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98390_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_mx98360_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_rt1019_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1019_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_rt5682_c1_h02\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(3) |\n\t\t\t\t\t \n\t\t\t\t\tSOF_HDMI_CAPTURE_SSP_MASK(0x5)),\n\t},\n\t{\n\t\t.name = \"rpl_mx98357_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(2) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.name = \"rpl_mx98360_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"rpl_rt1019_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1019_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"mtl_mx98357_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"mtl_mx98360_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.name = \"mtl_rt1019_rt5682\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(2) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1019_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(0) |\n\t\t\t\t\tSOF_RT5682_NUM_HDMIDEV(3)),\n\t},\n\t{\n\t\t.name = \"jsl_rt5650\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_RT5682_MCLK_EN |\n\t\t\t\t\tSOF_RT5682_MCLK_24MHZ |\n\t\t\t\t\tSOF_RT5682_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT5682_SSP_AMP(1)),\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, board_ids);\n\nstatic struct platform_driver sof_audio = {\n\t.probe = sof_audio_probe,\n\t.driver = {\n\t\t.name = \"sof_rt5682\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.id_table = board_ids,\n};\nmodule_platform_driver(sof_audio)\n\n \nMODULE_DESCRIPTION(\"SOF Audio Machine driver\");\nMODULE_AUTHOR(\"Bard Liao <bard.liao@intel.com>\");\nMODULE_AUTHOR(\"Sathya Prakash M R <sathya.prakash.m.r@intel.com>\");\nMODULE_AUTHOR(\"Brent Lu <brent.lu@intel.com>\");\nMODULE_AUTHOR(\"Mac Chiang <mac.chiang@intel.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_IMPORT_NS(SND_SOC_INTEL_HDA_DSP_COMMON);\nMODULE_IMPORT_NS(SND_SOC_INTEL_SOF_MAXIM_COMMON);\nMODULE_IMPORT_NS(SND_SOC_INTEL_SOF_REALTEK_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}