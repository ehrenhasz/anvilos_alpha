{
  "module_name": "sof_sdw_rt_sdca_jack_common.c",
  "hash_id": "53402b0ae4bea3f2c0d98756fc9fde256b1ace688c8a7ff8a860195316c642c6",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_sdw_rt_sdca_jack_common.c",
  "human_readable_source": "\n\n\n \n\n#include <linux/device.h>\n#include <linux/errno.h>\n#include <linux/input.h>\n#include <linux/soundwire/sdw.h>\n#include <linux/soundwire/sdw_type.h>\n#include <sound/control.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include <sound/soc-dapm.h>\n#include <sound/jack.h>\n#include \"sof_sdw_common.h\"\n\n \nstatic int rt_sdca_jack_add_codec_device_props(struct device *sdw_dev)\n{\n\tstruct property_entry props[MAX_NO_PROPS] = {};\n\tstruct fwnode_handle *fwnode;\n\tint ret;\n\n\tif (!SOF_JACK_JDSRC(sof_sdw_quirk))\n\t\treturn 0;\n\n\tprops[0] = PROPERTY_ENTRY_U32(\"realtek,jd-src\", SOF_JACK_JDSRC(sof_sdw_quirk));\n\n\tfwnode = fwnode_create_software_node(props, NULL);\n\tif (IS_ERR(fwnode))\n\t\treturn PTR_ERR(fwnode);\n\n\tret = device_add_software_node(sdw_dev, to_software_node(fwnode));\n\n\tfwnode_handle_put(fwnode);\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_dapm_widget rt_sdca_jack_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route rt711_sdca_map[] = {\n\t{ \"Headphone\", NULL, \"rt711 HP\" },\n\t{ \"rt711 MIC2\", NULL, \"Headset Mic\" },\n};\n\nstatic const struct snd_soc_dapm_route rt712_sdca_map[] = {\n\t{ \"Headphone\", NULL, \"rt712 HP\" },\n\t{ \"rt712 MIC2\", NULL, \"Headset Mic\" },\n};\n\nstatic const struct snd_soc_dapm_route rt713_sdca_map[] = {\n\t{ \"Headphone\", NULL, \"rt713 HP\" },\n\t{ \"rt713 MIC2\", NULL, \"Headset Mic\" },\n};\n\nstatic const struct snd_kcontrol_new rt_sdca_jack_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n};\n\nstatic struct snd_soc_jack_pin rt_sdca_jack_pins[] = {\n\t{\n\t\t.pin    = \"Headphone\",\n\t\t.mask   = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin    = \"Headset Mic\",\n\t\t.mask   = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int rt_sdca_jack_rtd_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct mc_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_component *component = codec_dai->component;\n\tstruct snd_soc_jack *jack;\n\tint ret;\n\n\tcard->components = devm_kasprintf(card->dev, GFP_KERNEL,\n\t\t\t\t\t  \"%s hs:%s-sdca\",\n\t\t\t\t\t  card->components, component->name_prefix);\n\tif (!card->components)\n\t\treturn -ENOMEM;\n\n\tret = snd_soc_add_card_controls(card, rt_sdca_jack_controls,\n\t\t\t\t\tARRAY_SIZE(rt_sdca_jack_controls));\n\tif (ret) {\n\t\tdev_err(card->dev, \"rt sdca jack controls addition failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, rt_sdca_jack_widgets,\n\t\t\t\t\tARRAY_SIZE(rt_sdca_jack_widgets));\n\tif (ret) {\n\t\tdev_err(card->dev, \"rt sdca jack widgets addition failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (strstr(component->name_prefix, \"rt711\")) {\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, rt711_sdca_map,\n\t\t\t\t\t      ARRAY_SIZE(rt711_sdca_map));\n\t} else if (strstr(component->name_prefix, \"rt712\")) {\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, rt712_sdca_map,\n\t\t\t\t\t      ARRAY_SIZE(rt712_sdca_map));\n\t} else if (strstr(component->name_prefix, \"rt713\")) {\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, rt713_sdca_map,\n\t\t\t\t\t      ARRAY_SIZE(rt713_sdca_map));\n\t} else {\n\t\tdev_err(card->dev, \"%s is not supported\\n\", component->name_prefix);\n\t\treturn -EINVAL;\n\t}\n\n\tif (ret) {\n\t\tdev_err(card->dev, \"rt sdca jack map addition failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_BTN_0 |\n\t\t\t\t\t SND_JACK_BTN_1 | SND_JACK_BTN_2 |\n\t\t\t\t\t SND_JACK_BTN_3,\n\t\t\t\t\t &ctx->sdw_headset,\n\t\t\t\t\t rt_sdca_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(rt_sdca_jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->card->dev, \"Headset Jack creation failed: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tjack = &ctx->sdw_headset;\n\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\n\tret = snd_soc_component_set_jack(component, jack, NULL);\n\n\tif (ret)\n\t\tdev_err(rtd->card->dev, \"Headset Jack call-back failed: %d\\n\",\n\t\t\tret);\n\n\treturn ret;\n}\n\nint sof_sdw_rt_sdca_jack_exit(struct snd_soc_card *card, struct snd_soc_dai_link *dai_link)\n{\n\tstruct mc_private *ctx = snd_soc_card_get_drvdata(card);\n\n\tif (!ctx->headset_codec_dev)\n\t\treturn 0;\n\n\tif (!SOF_JACK_JDSRC(sof_sdw_quirk))\n\t\treturn 0;\n\n\tdevice_remove_software_node(ctx->headset_codec_dev);\n\tput_device(ctx->headset_codec_dev);\n\tctx->headset_codec_dev = NULL;\n\n\treturn 0;\n}\n\nint sof_sdw_rt_sdca_jack_init(struct snd_soc_card *card,\n\t\t\t      const struct snd_soc_acpi_link_adr *link,\n\t\t\t      struct snd_soc_dai_link *dai_links,\n\t\t\t      struct sof_sdw_codec_info *info,\n\t\t\t      bool playback)\n{\n\tstruct mc_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct device *sdw_dev;\n\tint ret;\n\n\t \n\tif (!playback)\n\t\treturn 0;\n\n\tsdw_dev = bus_find_device_by_name(&sdw_bus_type, NULL, dai_links->codecs[0].name);\n\tif (!sdw_dev)\n\t\treturn -EPROBE_DEFER;\n\n\tret = rt_sdca_jack_add_codec_device_props(sdw_dev);\n\tif (ret < 0) {\n\t\tput_device(sdw_dev);\n\t\treturn ret;\n\t}\n\tctx->headset_codec_dev = sdw_dev;\n\n\tdai_links->init = rt_sdca_jack_rtd_init;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}