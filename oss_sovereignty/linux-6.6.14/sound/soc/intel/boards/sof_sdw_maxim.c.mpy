{
  "module_name": "sof_sdw_maxim.c",
  "hash_id": "2ee2ab97cf71751cb2c36efd569b1d37535431d1b8d40564273b7ae436cef895",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_sdw_maxim.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/device.h>\n#include <linux/errno.h>\n#include <sound/control.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include <sound/soc-dapm.h>\n#include \"sof_sdw_common.h\"\n#include \"sof_maxim_common.h\"\n\nstatic int maxim_part_id;\n#define SOF_SDW_PART_ID_MAX98363 0x8363\n#define SOF_SDW_PART_ID_MAX98373 0x8373\n\nstatic const struct snd_soc_dapm_widget maxim_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Left Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Right Spk\", NULL),\n};\n\nstatic const struct snd_kcontrol_new maxim_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Left Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Right Spk\"),\n};\n\nstatic int spk_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tcard->components = devm_kasprintf(card->dev, GFP_KERNEL,\n\t\t\t\t\t  \"%s spk:mx%04x\",\n\t\t\t\t\t  card->components, maxim_part_id);\n\tif (!card->components)\n\t\treturn -ENOMEM;\n\n\tdev_dbg(card->dev, \"soundwire maxim card components assigned : %s\\n\",\n\t\tcard->components);\n\n\tret = snd_soc_add_card_controls(card, maxim_controls,\n\t\t\t\t\tARRAY_SIZE(maxim_controls));\n\tif (ret) {\n\t\tdev_err(card->dev, \"mx%04x ctrls addition failed: %d\\n\", maxim_part_id, ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, maxim_widgets,\n\t\t\t\t\tARRAY_SIZE(maxim_widgets));\n\tif (ret) {\n\t\tdev_err(card->dev, \"mx%04x widgets addition failed: %d\\n\", maxim_part_id, ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, max_98373_dapm_routes, 2);\n\tif (ret)\n\t\tdev_err(rtd->dev, \"failed to add first SPK map: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int mx8373_enable_spk_pin(struct snd_pcm_substream *substream, bool enable)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_dai *cpu_dai;\n\tint ret;\n\tint j;\n\n\t \n\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\treturn 0;\n\n\tcpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tfor_each_rtd_codec_dais(rtd, j, codec_dai) {\n\t\tstruct snd_soc_dapm_context *dapm =\n\t\t\t\tsnd_soc_component_get_dapm(cpu_dai->component);\n\t\tchar pin_name[16];\n\n\t\tsnprintf(pin_name, ARRAY_SIZE(pin_name), \"%s Spk\",\n\t\t\t codec_dai->component->name_prefix);\n\n\t\tif (enable)\n\t\t\tret = snd_soc_dapm_enable_pin(dapm, pin_name);\n\t\telse\n\t\t\tret = snd_soc_dapm_disable_pin(dapm, pin_name);\n\n\t\tif (!ret)\n\t\t\tsnd_soc_dapm_sync(dapm);\n\t}\n\n\treturn 0;\n}\n\nstatic int mx8373_sdw_prepare(struct snd_pcm_substream *substream)\n{\n\tint ret;\n\n\t \n\tret = sdw_prepare(substream);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn mx8373_enable_spk_pin(substream, true);\n}\n\nstatic int mx8373_sdw_hw_free(struct snd_pcm_substream *substream)\n{\n\tint ret;\n\n\t \n\tret = sdw_hw_free(substream);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn mx8373_enable_spk_pin(substream, false);\n}\n\nstatic const struct snd_soc_ops max_98373_sdw_ops = {\n\t.startup = sdw_startup,\n\t.prepare = mx8373_sdw_prepare,\n\t.trigger = sdw_trigger,\n\t.hw_params = sdw_hw_params,\n\t.hw_free = mx8373_sdw_hw_free,\n\t.shutdown = sdw_shutdown,\n};\n\nstatic int mx8373_sdw_late_probe(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dapm_context *dapm = &card->dapm;\n\n\t \n\tsnd_soc_dapm_disable_pin(dapm, \"Left Spk\");\n\tsnd_soc_dapm_disable_pin(dapm, \"Right Spk\");\n\treturn snd_soc_dapm_sync(dapm);\n}\n\nint sof_sdw_maxim_init(struct snd_soc_card *card,\n\t\t       const struct snd_soc_acpi_link_adr *link,\n\t\t       struct snd_soc_dai_link *dai_links,\n\t\t       struct sof_sdw_codec_info *info,\n\t\t       bool playback)\n{\n\tinfo->amp_num++;\n\tif (info->amp_num == 2)\n\t\tdai_links->init = spk_init;\n\n\tmaxim_part_id = info->part_id;\n\tswitch (maxim_part_id) {\n\tcase SOF_SDW_PART_ID_MAX98363:\n\t\t \n\t\tbreak;\n\tcase SOF_SDW_PART_ID_MAX98373:\n\t\tinfo->codec_card_late_probe = mx8373_sdw_late_probe;\n\t\tdai_links->ops = &max_98373_sdw_ops;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(card->dev, \"Invalid maxim_part_id %#x\\n\", maxim_part_id);\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}