{
  "module_name": "sof_pcm512x.c",
  "hash_id": "458f8e3951625b18afee69bc6d13eb167a744119c17cc3a6737a0a5a45fad36d",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_pcm512x.c",
  "human_readable_source": "\n\n\n \n#include <linux/clk.h>\n#include <linux/dmi.h>\n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/types.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/pcm512x.h\"\n#include \"../common/soc-intel-quirks.h\"\n#include \"hda_dsp_common.h\"\n\n#define NAME_SIZE 32\n\n#define SOF_PCM512X_SSP_CODEC(quirk)\t\t((quirk) & GENMASK(3, 0))\n#define SOF_PCM512X_SSP_CODEC_MASK\t\t\t(GENMASK(3, 0))\n#define SOF_PCM512X_ENABLE_SSP_CAPTURE\t\tBIT(4)\n#define SOF_PCM512X_ENABLE_DMIC\t\t\tBIT(5)\n\n#define IDISP_CODEC_MASK\t0x4\n\n \nstatic unsigned long sof_pcm512x_quirk =\n\tSOF_PCM512X_SSP_CODEC(5) |\n\tSOF_PCM512X_ENABLE_SSP_CAPTURE |\n\tSOF_PCM512X_ENABLE_DMIC;\n\nstatic bool is_legacy_cpu;\n\nstruct sof_hdmi_pcm {\n\tstruct list_head head;\n\tstruct snd_soc_dai *codec_dai;\n\tint device;\n};\n\nstruct sof_card_private {\n\tstruct list_head hdmi_pcm_list;\n\tbool idisp_codec;\n};\n\nstatic int sof_pcm512x_quirk_cb(const struct dmi_system_id *id)\n{\n\tsof_pcm512x_quirk = (unsigned long)id->driver_data;\n\treturn 1;\n}\n\nstatic const struct dmi_system_id sof_pcm512x_quirk_table[] = {\n\t{\n\t\t.callback = sof_pcm512x_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"AAEON\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"UP-CHT01\"),\n\t\t},\n\t\t.driver_data = (void *)(SOF_PCM512X_SSP_CODEC(2)),\n\t},\n\t{}\n};\n\nstatic int sof_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct sof_hdmi_pcm *pcm;\n\n\tpcm = devm_kzalloc(rtd->card->dev, sizeof(*pcm), GFP_KERNEL);\n\tif (!pcm)\n\t\treturn -ENOMEM;\n\n\t \n\tpcm->device = rtd->dai_link->id;\n\tpcm->codec_dai = dai;\n\n\tlist_add_tail(&pcm->head, &ctx->hdmi_pcm_list);\n\n\treturn 0;\n}\n\nstatic int sof_pcm512x_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *codec = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_update_bits(codec, PCM512x_GPIO_EN, 0x08, 0x08);\n\tsnd_soc_component_update_bits(codec, PCM512x_GPIO_OUTPUT_4, 0x0f, 0x02);\n\tsnd_soc_component_update_bits(codec, PCM512x_GPIO_CONTROL_1,\n\t\t\t\t      0x08, 0x08);\n\n\treturn 0;\n}\n\nstatic int aif1_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_component *codec = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_update_bits(codec, PCM512x_GPIO_CONTROL_1,\n\t\t\t\t      0x08, 0x08);\n\n\treturn 0;\n}\n\nstatic void aif1_shutdown(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_component *codec = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_update_bits(codec, PCM512x_GPIO_CONTROL_1,\n\t\t\t\t      0x08, 0x00);\n}\n\nstatic const struct snd_soc_ops sof_pcm512x_ops = {\n\t.startup = aif1_startup,\n\t.shutdown = aif1_shutdown,\n};\n\nstatic struct snd_soc_dai_link_component platform_component[] = {\n\t{\n\t\t \n\t\t.name = \"0000:00:1f.3\"\n\t}\n};\n\nstatic int sof_card_late_probe(struct snd_soc_card *card)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct sof_hdmi_pcm *pcm;\n\n\t \n\tif (is_legacy_cpu)\n\t\treturn 0;\n\n\tif (list_empty(&ctx->hdmi_pcm_list))\n\t\treturn -EINVAL;\n\n\tif (!ctx->idisp_codec)\n\t\treturn 0;\n\n\tpcm = list_first_entry(&ctx->hdmi_pcm_list, struct sof_hdmi_pcm, head);\n\n\treturn hda_dsp_hdmi_build_controls(card, pcm->codec_dai->component);\n}\n\nstatic const struct snd_kcontrol_new sof_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Ext Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget sof_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_widget dmic_widgets[] = {\n\tSND_SOC_DAPM_MIC(\"SoC DMIC\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route sof_map[] = {\n\t \n\t{\"Ext Spk\", NULL, \"OUTR\"},\n\t{\"Ext Spk\", NULL, \"OUTL\"},\n};\n\nstatic const struct snd_soc_dapm_route dmic_map[] = {\n\t \n\t{\"DMic\", NULL, \"SoC DMIC\"},\n};\n\nstatic int dmic_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, dmic_widgets,\n\t\t\t\t\tARRAY_SIZE(dmic_widgets));\n\tif (ret) {\n\t\tdev_err(card->dev, \"DMic widget addition failed: %d\\n\", ret);\n\t\t \n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, dmic_map,\n\t\t\t\t      ARRAY_SIZE(dmic_map));\n\n\tif (ret)\n\t\tdev_err(card->dev, \"DMic map addition failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic struct snd_soc_card sof_audio_card_pcm512x = {\n\t.name = \"pcm512x\",\n\t.owner = THIS_MODULE,\n\t.controls = sof_controls,\n\t.num_controls = ARRAY_SIZE(sof_controls),\n\t.dapm_widgets = sof_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(sof_widgets),\n\t.dapm_routes = sof_map,\n\t.num_dapm_routes = ARRAY_SIZE(sof_map),\n\t.fully_routed = true,\n\t.late_probe = sof_card_late_probe,\n};\n\nSND_SOC_DAILINK_DEF(pcm512x_component,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-104C5122:00\", \"pcm512x-hifi\")));\nSND_SOC_DAILINK_DEF(dmic_component,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"dmic-codec\", \"dmic-hifi\")));\n\nstatic struct snd_soc_dai_link *sof_card_dai_links_create(struct device *dev,\n\t\t\t\t\t\t\t  int ssp_codec,\n\t\t\t\t\t\t\t  int dmic_be_num,\n\t\t\t\t\t\t\t  int hdmi_num,\n\t\t\t\t\t\t\t  bool idisp_codec)\n{\n\tstruct snd_soc_dai_link_component *idisp_components;\n\tstruct snd_soc_dai_link_component *cpus;\n\tstruct snd_soc_dai_link *links;\n\tint i, id = 0;\n\n\tlinks = devm_kcalloc(dev, sof_audio_card_pcm512x.num_links,\n\t\t\tsizeof(struct snd_soc_dai_link), GFP_KERNEL);\n\tcpus = devm_kcalloc(dev, sof_audio_card_pcm512x.num_links,\n\t\t\tsizeof(struct snd_soc_dai_link_component), GFP_KERNEL);\n\tif (!links || !cpus)\n\t\tgoto devm_err;\n\n\t \n\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\"SSP%d-Codec\", ssp_codec);\n\tif (!links[id].name)\n\t\tgoto devm_err;\n\n\tlinks[id].id = id;\n\tlinks[id].codecs = pcm512x_component;\n\tlinks[id].num_codecs = ARRAY_SIZE(pcm512x_component);\n\tlinks[id].platforms = platform_component;\n\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\tlinks[id].init = sof_pcm512x_codec_init;\n\tlinks[id].ops = &sof_pcm512x_ops;\n\tlinks[id].dpcm_playback = 1;\n\t \n\tif (sof_pcm512x_quirk & SOF_PCM512X_ENABLE_SSP_CAPTURE)\n\t\tlinks[id].dpcm_capture = 1;\n\tlinks[id].no_pcm = 1;\n\tlinks[id].cpus = &cpus[id];\n\tlinks[id].num_cpus = 1;\n\tif (is_legacy_cpu) {\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"ssp%d-port\",\n\t\t\t\t\t\t\t  ssp_codec);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t} else {\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"SSP%d Pin\",\n\t\t\t\t\t\t\t  ssp_codec);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t}\n\tid++;\n\n\t \n\tif (dmic_be_num > 0) {\n\t\t \n\t\tlinks[id].name = \"dmic01\";\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].cpus->dai_name = \"DMIC01 Pin\";\n\t\tlinks[id].init = dmic_init;\n\t\tif (dmic_be_num > 1) {\n\t\t\t \n\t\t\tlinks[id + 1].name = \"dmic16k\";\n\t\t\tlinks[id + 1].cpus = &cpus[id + 1];\n\t\t\tlinks[id + 1].cpus->dai_name = \"DMIC16k Pin\";\n\t\t\tdmic_be_num = 2;\n\t\t}\n\t}\n\n\tfor (i = 0; i < dmic_be_num; i++) {\n\t\tlinks[id].id = id;\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].codecs = dmic_component;\n\t\tlinks[id].num_codecs = ARRAY_SIZE(dmic_component);\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].ignore_suspend = 1;\n\t\tlinks[id].dpcm_capture = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tid++;\n\t}\n\n\t \n\tif (hdmi_num > 0) {\n\t\tidisp_components = devm_kcalloc(dev, hdmi_num,\n\t\t\t\tsizeof(struct snd_soc_dai_link_component),\n\t\t\t\tGFP_KERNEL);\n\t\tif (!idisp_components)\n\t\t\tgoto devm_err;\n\t}\n\tfor (i = 1; i <= hdmi_num; i++) {\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\"iDisp%d\", i);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].id = id;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"iDisp%d Pin\", i);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\n\t\t \n\t\tif (idisp_codec) {\n\t\t\tidisp_components[i - 1].name = \"ehdaudio0D2\";\n\t\t\tidisp_components[i - 1].dai_name =\n\t\t\t\tdevm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t       \"intel-hdmi-hifi%d\", i);\n\t\t} else {\n\t\t\tidisp_components[i - 1] = asoc_dummy_dlc;\n\t\t}\n\t\tif (!idisp_components[i - 1].dai_name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].codecs = &idisp_components[i - 1];\n\t\tlinks[id].num_codecs = 1;\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].init = sof_hdmi_init;\n\t\tlinks[id].dpcm_playback = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tid++;\n\t}\n\n\treturn links;\ndevm_err:\n\treturn NULL;\n}\n\nstatic int sof_audio_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_acpi_mach *mach = pdev->dev.platform_data;\n\tstruct snd_soc_dai_link *dai_links;\n\tstruct sof_card_private *ctx;\n\tint dmic_be_num, hdmi_num;\n\tint ret, ssp_codec;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\thdmi_num = 0;\n\tif (soc_intel_is_byt() || soc_intel_is_cht()) {\n\t\tis_legacy_cpu = true;\n\t\tdmic_be_num = 0;\n\t\t \n\t\tsof_pcm512x_quirk = SOF_PCM512X_SSP_CODEC(2);\n\t} else {\n\t\tdmic_be_num = 2;\n\t\tif (mach->mach_params.common_hdmi_codec_drv &&\n\t\t    (mach->mach_params.codec_mask & IDISP_CODEC_MASK))\n\t\t\tctx->idisp_codec = true;\n\n\t\t \n\t\thdmi_num = 3;\n\t}\n\n\tdmi_check_system(sof_pcm512x_quirk_table);\n\n\tdev_dbg(&pdev->dev, \"sof_pcm512x_quirk = %lx\\n\", sof_pcm512x_quirk);\n\n\tssp_codec = sof_pcm512x_quirk & SOF_PCM512X_SSP_CODEC_MASK;\n\n\tif (!(sof_pcm512x_quirk & SOF_PCM512X_ENABLE_DMIC))\n\t\tdmic_be_num = 0;\n\n\t \n\tsof_audio_card_pcm512x.num_links = 1 + dmic_be_num + hdmi_num;\n\n\tdai_links = sof_card_dai_links_create(&pdev->dev, ssp_codec,\n\t\t\t\t\t      dmic_be_num, hdmi_num,\n\t\t\t\t\t      ctx->idisp_codec);\n\tif (!dai_links)\n\t\treturn -ENOMEM;\n\n\tsof_audio_card_pcm512x.dai_link = dai_links;\n\n\tINIT_LIST_HEAD(&ctx->hdmi_pcm_list);\n\n\tsof_audio_card_pcm512x.dev = &pdev->dev;\n\n\t \n\tret = snd_soc_fixup_dai_links_platform_name(&sof_audio_card_pcm512x,\n\t\t\t\t\t\t    mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_soc_card_set_drvdata(&sof_audio_card_pcm512x, ctx);\n\n\treturn devm_snd_soc_register_card(&pdev->dev,\n\t\t\t\t\t  &sof_audio_card_pcm512x);\n}\n\nstatic void sof_pcm512x_remove(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = platform_get_drvdata(pdev);\n\tstruct snd_soc_component *component;\n\n\tfor_each_card_components(card, component) {\n\t\tif (!strcmp(component->name, pcm512x_component[0].name)) {\n\t\t\tsnd_soc_component_set_jack(component, NULL, NULL);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic struct platform_driver sof_audio = {\n\t.probe = sof_audio_probe,\n\t.remove_new = sof_pcm512x_remove,\n\t.driver = {\n\t\t.name = \"sof_pcm512x\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n};\nmodule_platform_driver(sof_audio)\n\nMODULE_DESCRIPTION(\"ASoC Intel(R) SOF + PCM512x Machine driver\");\nMODULE_AUTHOR(\"Pierre-Louis Bossart\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:sof_pcm512x\");\nMODULE_IMPORT_NS(SND_SOC_INTEL_HDA_DSP_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}