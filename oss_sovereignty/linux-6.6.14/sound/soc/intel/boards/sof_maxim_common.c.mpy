{
  "module_name": "sof_maxim_common.c",
  "hash_id": "24534308eb9cbbcb6af99abbd3006cd759b8f89aa8dc503ce26b2727b6ac296b",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_maxim_common.c",
  "human_readable_source": "\n\n\n#include <linux/module.h>\n#include <linux/string.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include <sound/soc-dai.h>\n#include <sound/soc-dapm.h>\n#include <uapi/sound/asound.h>\n#include \"sof_maxim_common.h\"\n\n \nstatic unsigned int get_num_codecs(const char *hid)\n{\n\tstruct acpi_device *adev;\n\tunsigned int dev_num = 0;\n\n\tfor_each_acpi_dev_match(adev, hid, NULL, -1)\n\t\tdev_num++;\n\n\treturn dev_num;\n}\n\n#define MAX_98373_PIN_NAME 16\n\nconst struct snd_soc_dapm_route max_98373_dapm_routes[] = {\n\t \n\t{ \"Left Spk\", NULL, \"Left BE_OUT\" },\n\t{ \"Right Spk\", NULL, \"Right BE_OUT\" },\n};\nEXPORT_SYMBOL_NS(max_98373_dapm_routes, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nstatic struct snd_soc_codec_conf max_98373_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(MAX_98373_DEV0_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(MAX_98373_DEV1_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n};\n\nstruct snd_soc_dai_link_component max_98373_components[] = {\n\t{   \n\t\t.name = MAX_98373_DEV0_NAME,\n\t\t.dai_name = MAX_98373_CODEC_DAI,\n\t},\n\t{   \n\t\t.name = MAX_98373_DEV1_NAME,\n\t\t.dai_name = MAX_98373_CODEC_DAI,\n\t},\n};\nEXPORT_SYMBOL_NS(max_98373_components, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nstatic int max_98373_hw_params(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tint j;\n\n\tfor_each_rtd_codec_dais(rtd, j, codec_dai) {\n\t\tif (!strcmp(codec_dai->component->name, MAX_98373_DEV0_NAME)) {\n\t\t\t \n\t\t\tsnd_soc_dai_set_tdm_slot(codec_dai, 0x03, 3, 8, 32);\n\t\t}\n\t\tif (!strcmp(codec_dai->component->name, MAX_98373_DEV1_NAME)) {\n\t\t\t \n\t\t\tsnd_soc_dai_set_tdm_slot(codec_dai, 0x0C, 3, 8, 32);\n\t\t}\n\t}\n\treturn 0;\n}\n\nint max_98373_trigger(struct snd_pcm_substream *substream, int cmd)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_dai *cpu_dai;\n\tint j;\n\tint ret = 0;\n\n\t \n\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\treturn 0;\n\n\tcpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tfor_each_rtd_codec_dais(rtd, j, codec_dai) {\n\t\tstruct snd_soc_dapm_context *dapm =\n\t\t\t\tsnd_soc_component_get_dapm(cpu_dai->component);\n\t\tchar pin_name[MAX_98373_PIN_NAME];\n\n\t\tsnprintf(pin_name, ARRAY_SIZE(pin_name), \"%s Spk\",\n\t\t\t codec_dai->component->name_prefix);\n\n\t\tswitch (cmd) {\n\t\tcase SNDRV_PCM_TRIGGER_START:\n\t\tcase SNDRV_PCM_TRIGGER_RESUME:\n\t\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\t\tret = snd_soc_dapm_enable_pin(dapm, pin_name);\n\t\t\tif (!ret)\n\t\t\t\tsnd_soc_dapm_sync(dapm);\n\t\t\tbreak;\n\t\tcase SNDRV_PCM_TRIGGER_STOP:\n\t\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\t\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\t\tret = snd_soc_dapm_disable_pin(dapm, pin_name);\n\t\t\tif (!ret)\n\t\t\t\tsnd_soc_dapm_sync(dapm);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_NS(max_98373_trigger, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nstruct snd_soc_ops max_98373_ops = {\n\t.hw_params = max_98373_hw_params,\n\t.trigger = max_98373_trigger,\n};\nEXPORT_SYMBOL_NS(max_98373_ops, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nint max_98373_spk_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, max_98373_dapm_routes,\n\t\t\t\t      ARRAY_SIZE(max_98373_dapm_routes));\n\tif (ret)\n\t\tdev_err(rtd->dev, \"Speaker map addition failed: %d\\n\", ret);\n\treturn ret;\n}\nEXPORT_SYMBOL_NS(max_98373_spk_codec_init, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nvoid max_98373_set_codec_conf(struct snd_soc_card *card)\n{\n\tcard->codec_conf = max_98373_codec_conf;\n\tcard->num_configs = ARRAY_SIZE(max_98373_codec_conf);\n}\nEXPORT_SYMBOL_NS(max_98373_set_codec_conf, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\n \nstatic const struct snd_soc_dapm_route max_98390_dapm_routes[] = {\n\t \n\t{ \"Left Spk\", NULL, \"Left BE_OUT\" },\n\t{ \"Right Spk\", NULL, \"Right BE_OUT\" },\n};\n\nstatic const struct snd_kcontrol_new max_98390_tt_kcontrols[] = {\n\tSOC_DAPM_PIN_SWITCH(\"TL Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"TR Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget max_98390_tt_dapm_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"TL Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"TR Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route max_98390_tt_dapm_routes[] = {\n\t \n\t{ \"TL Spk\", NULL, \"Tweeter Left BE_OUT\" },\n\t{ \"TR Spk\", NULL, \"Tweeter Right BE_OUT\" },\n};\n\nstatic struct snd_soc_codec_conf max_98390_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(MAX_98390_DEV0_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(MAX_98390_DEV1_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(MAX_98390_DEV2_NAME),\n\t\t.name_prefix = \"Tweeter Right\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(MAX_98390_DEV3_NAME),\n\t\t.name_prefix = \"Tweeter Left\",\n\t},\n};\n\nstatic struct snd_soc_dai_link_component max_98390_components[] = {\n\t{\n\t\t.name = MAX_98390_DEV0_NAME,\n\t\t.dai_name = MAX_98390_CODEC_DAI,\n\t},\n\t{\n\t\t.name = MAX_98390_DEV1_NAME,\n\t\t.dai_name = MAX_98390_CODEC_DAI,\n\t},\n\t{\n\t\t.name = MAX_98390_DEV2_NAME,\n\t\t.dai_name = MAX_98390_CODEC_DAI,\n\t},\n\t{\n\t\t.name = MAX_98390_DEV3_NAME,\n\t\t.dai_name = MAX_98390_CODEC_DAI,\n\t},\n};\n\nstatic const struct {\n\tunsigned int tx;\n\tunsigned int rx;\n} max_98390_tdm_mask[] = {\n\t{.tx = 0x01, .rx = 0x3},\n\t{.tx = 0x02, .rx = 0x3},\n\t{.tx = 0x04, .rx = 0x3},\n\t{.tx = 0x08, .rx = 0x3},\n};\n\nstatic int max_98390_hw_params(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tint i, ret;\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\tif (i >= ARRAY_SIZE(max_98390_tdm_mask)) {\n\t\t\tdev_err(codec_dai->dev, \"invalid codec index %d\\n\", i);\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tret = snd_soc_dai_set_tdm_slot(codec_dai, max_98390_tdm_mask[i].tx,\n\t\t\t\t\t       max_98390_tdm_mask[i].rx, 4,\n\t\t\t\t\t       params_width(params));\n\t\tif (ret < 0) {\n\t\t\tdev_err(codec_dai->dev, \"fail to set tdm slot, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int max_98390_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tunsigned int num_codecs = get_num_codecs(MAX_98390_ACPI_HID);\n\tint ret;\n\n\tswitch (num_codecs) {\n\tcase 4:\n\t\t \n\t\tret = snd_soc_dapm_new_controls(&card->dapm, max_98390_tt_dapm_widgets,\n\t\t\t\t\t\tARRAY_SIZE(max_98390_tt_dapm_widgets));\n\t\tif (ret) {\n\t\t\tdev_err(rtd->dev, \"unable to add tweeter dapm widgets, ret %d\\n\",\n\t\t\t\tret);\n\t\t\t \n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_add_card_controls(card, max_98390_tt_kcontrols,\n\t\t\t\t\t\tARRAY_SIZE(max_98390_tt_kcontrols));\n\t\tif (ret) {\n\t\t\tdev_err(rtd->dev, \"unable to add tweeter controls, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, max_98390_tt_dapm_routes,\n\t\t\t\t\t      ARRAY_SIZE(max_98390_tt_dapm_routes));\n\t\tif (ret) {\n\t\t\tdev_err(rtd->dev, \"unable to add tweeter dapm routes, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tfallthrough;\n\tcase 2:\n\t\t \n\t\tret = snd_soc_dapm_add_routes(&card->dapm, max_98390_dapm_routes,\n\t\t\t\t\t      ARRAY_SIZE(max_98390_dapm_routes));\n\t\tif (ret) {\n\t\t\tdev_err(rtd->dev, \"unable to add dapm routes, ret %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(rtd->dev, \"invalid codec number %d\\n\", num_codecs);\n\t\treturn -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops max_98390_ops = {\n\t.hw_params = max_98390_hw_params,\n};\n\nvoid max_98390_dai_link(struct device *dev, struct snd_soc_dai_link *link)\n{\n\tunsigned int num_codecs = get_num_codecs(MAX_98390_ACPI_HID);\n\n\tlink->codecs = max_98390_components;\n\n\tswitch (num_codecs) {\n\tcase 2:\n\tcase 4:\n\t\tlink->num_codecs = num_codecs;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"invalid codec number %d for %s\\n\", num_codecs,\n\t\t\tMAX_98390_ACPI_HID);\n\t\tbreak;\n\t}\n\n\tlink->init = max_98390_init;\n\tlink->ops = &max_98390_ops;\n}\nEXPORT_SYMBOL_NS(max_98390_dai_link, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nvoid max_98390_set_codec_conf(struct device *dev, struct snd_soc_card *card)\n{\n\tunsigned int num_codecs = get_num_codecs(MAX_98390_ACPI_HID);\n\n\tcard->codec_conf = max_98390_codec_conf;\n\n\tswitch (num_codecs) {\n\tcase 2:\n\tcase 4:\n\t\tcard->num_configs = num_codecs;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"invalid codec number %d for %s\\n\", num_codecs,\n\t\t\tMAX_98390_ACPI_HID);\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_NS(max_98390_set_codec_conf, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\n \nstatic const struct snd_kcontrol_new max_98357a_kcontrols[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget max_98357a_dapm_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route max_98357a_dapm_routes[] = {\n\t \n\t{\"Spk\", NULL, \"Speaker\"},\n};\n\nstatic struct snd_soc_dai_link_component max_98357a_components[] = {\n\t{\n\t\t.name = MAX_98357A_DEV0_NAME,\n\t\t.dai_name = MAX_98357A_CODEC_DAI,\n\t}\n};\n\nstatic struct snd_soc_dai_link_component max_98360a_components[] = {\n\t{\n\t\t.name = MAX_98360A_DEV0_NAME,\n\t\t.dai_name = MAX_98357A_CODEC_DAI,\n\t}\n};\n\nstatic int max_98357a_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, max_98357a_dapm_widgets,\n\t\t\t\t\tARRAY_SIZE(max_98357a_dapm_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add dapm controls, ret %d\\n\", ret);\n\t\t \n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, max_98357a_kcontrols,\n\t\t\t\t\tARRAY_SIZE(max_98357a_kcontrols));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, max_98357a_dapm_routes,\n\t\t\t\t      ARRAY_SIZE(max_98357a_dapm_routes));\n\n\tif (ret)\n\t\tdev_err(rtd->dev, \"unable to add dapm routes, ret %d\\n\", ret);\n\n\treturn ret;\n}\n\nvoid max_98357a_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = max_98357a_components;\n\tlink->num_codecs = ARRAY_SIZE(max_98357a_components);\n\tlink->init = max_98357a_init;\n}\nEXPORT_SYMBOL_NS(max_98357a_dai_link, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nvoid max_98360a_dai_link(struct snd_soc_dai_link *link)\n{\n\tlink->codecs = max_98360a_components;\n\tlink->num_codecs = ARRAY_SIZE(max_98360a_components);\n\tlink->init = max_98357a_init;\n}\nEXPORT_SYMBOL_NS(max_98360a_dai_link, SND_SOC_INTEL_SOF_MAXIM_COMMON);\n\nMODULE_DESCRIPTION(\"ASoC Intel SOF Maxim helpers\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}