{
  "module_name": "cml_rt1011_rt5682.c",
  "hash_id": "e533bd4552b56b22ae8f6d589f07d4242cd09929cb7f8fc1afb27e15b0dbf57f",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/cml_rt1011_rt5682.c",
  "human_readable_source": "\n\n\n \n\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/clk.h>\n#include <linux/dmi.h>\n#include <linux/slab.h>\n#include <linux/acpi.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/rt5682.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/rt1011.h\"\n#include \"../../codecs/rt5682.h\"\n#include \"../../codecs/hdac_hdmi.h\"\n#include \"hda_dsp_common.h\"\n\n \n#define CML_PLAT_CLK\t24000000\n#define CML_RT1011_CODEC_DAI \"rt1011-aif\"\n#define CML_RT5682_CODEC_DAI \"rt5682-aif1\"\n#define NAME_SIZE 32\n\n#define SOF_RT1011_SPEAKER_WL\t\tBIT(0)\n#define SOF_RT1011_SPEAKER_WR\t\tBIT(1)\n#define SOF_RT1011_SPEAKER_TL\t\tBIT(2)\n#define SOF_RT1011_SPEAKER_TR\t\tBIT(3)\n\n \nstatic unsigned long sof_rt1011_quirk = SOF_RT1011_SPEAKER_WL |\n\t\t\t\t\tSOF_RT1011_SPEAKER_WR;\n\nstatic int sof_rt1011_quirk_cb(const struct dmi_system_id *id)\n{\n\tsof_rt1011_quirk = (unsigned long)id->driver_data;\n\treturn 1;\n}\n\nstatic const struct dmi_system_id sof_rt1011_quirk_table[] = {\n\t{\n\t\t.callback = sof_rt1011_quirk_cb,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Google\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Helios\"),\n\t},\n\t\t.driver_data = (void *)(SOF_RT1011_SPEAKER_WL | SOF_RT1011_SPEAKER_WR |\n\t\t\t\t\tSOF_RT1011_SPEAKER_TL | SOF_RT1011_SPEAKER_TR),\n\t},\n\t{\n\t}\n};\n\nstatic struct snd_soc_jack hdmi_jack[3];\n\nstruct hdmi_pcm {\n\tstruct list_head head;\n\tstruct snd_soc_dai *codec_dai;\n\tint device;\n};\n\nstruct card_private {\n\tchar codec_name[SND_ACPI_I2C_ID_LEN];\n\tstruct snd_soc_jack headset;\n\tstruct list_head hdmi_pcm_list;\n\tbool common_hdmi_codec_drv;\n};\n\nstatic const struct snd_kcontrol_new cml_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone Jack\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"WL Ext Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"WR Ext Spk\"),\n};\n\nstatic const struct snd_kcontrol_new cml_rt1011_tt_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"TL Ext Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"TR Ext Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget cml_rt1011_rt5682_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"WL Ext Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"WR Ext Spk\", NULL),\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"SoC DMIC\", NULL),\n};\n\nstatic const struct snd_soc_dapm_widget cml_rt1011_tt_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"TL Ext Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"TR Ext Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route cml_rt1011_rt5682_map[] = {\n\t \n\t{\"WL Ext Spk\", NULL, \"WL SPO\"},\n\t{\"WR Ext Spk\", NULL, \"WR SPO\"},\n\n\t \n\t{ \"Headphone Jack\", NULL, \"HPOL\" },\n\t{ \"Headphone Jack\", NULL, \"HPOR\" },\n\n\t \n\t{ \"IN1P\", NULL, \"Headset Mic\" },\n\n\t \n\t{\"DMic\", NULL, \"SoC DMIC\"},\n};\n\nstatic const struct snd_soc_dapm_route cml_rt1011_tt_map[] = {\n\t \n\t{\"TL Ext Spk\", NULL, \"TL SPO\" },\n\t{\"TR Ext Spk\", NULL, \"TR SPO\" },\n};\n\nstatic struct snd_soc_jack_pin jack_pins[] = {\n\t{\n\t\t.pin    = \"Headphone Jack\",\n\t\t.mask   = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin    = \"Headset Mic\",\n\t\t.mask   = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int cml_rt5682_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_jack *jack;\n\tint ret;\n\n\t \n\trt5682_sel_asrc_clk_src(component, RT5682_DA_STEREO1_FILTER |\n\t\t\t\t\tRT5682_AD_STEREO1_FILTER,\n\t\t\t\t\tRT5682_CLK_SEL_I2S1_ASRC);\n\n\t \n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_BTN_0 |\n\t\t\t\t\t SND_JACK_BTN_1 | SND_JACK_BTN_2 |\n\t\t\t\t\t SND_JACK_BTN_3,\n\t\t\t\t\t &ctx->headset,\n\t\t\t\t\t jack_pins,\n\t\t\t\t\t ARRAY_SIZE(jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack creation failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tjack = &ctx->headset;\n\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\tret = snd_soc_component_set_jack(component, jack, NULL);\n\tif (ret)\n\t\tdev_err(rtd->dev, \"Headset Jack call-back failed: %d\\n\", ret);\n\n\treturn ret;\n};\n\nstatic void cml_rt5682_codec_exit(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_set_jack(component, NULL, NULL);\n}\n\nstatic int cml_rt1011_spk_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tint ret = 0;\n\tstruct snd_soc_card *card = rtd->card;\n\n\tif (sof_rt1011_quirk & (SOF_RT1011_SPEAKER_TL |\n\t\t\t\tSOF_RT1011_SPEAKER_TR)) {\n\n\t\tret = snd_soc_add_card_controls(card, cml_rt1011_tt_controls,\n\t\t\t\t\tARRAY_SIZE(cml_rt1011_tt_controls));\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = snd_soc_dapm_new_controls(&card->dapm,\n\t\t\t\t\tcml_rt1011_tt_widgets,\n\t\t\t\t\tARRAY_SIZE(cml_rt1011_tt_widgets));\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = snd_soc_dapm_add_routes(&card->dapm, cml_rt1011_tt_map,\n\t\t\t\t\tARRAY_SIZE(cml_rt1011_tt_map));\n\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic int cml_rt5682_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint clk_id, clk_freq, pll_out, ret;\n\n\tclk_id = RT5682_PLL1_S_MCLK;\n\tclk_freq = CML_PLAT_CLK;\n\n\tpll_out = params_rate(params) * 512;\n\n\tret = snd_soc_dai_set_pll(codec_dai, 0, clk_id, clk_freq, pll_out);\n\tif (ret < 0)\n\t\tdev_warn(rtd->dev, \"snd_soc_dai_set_pll err = %d\\n\", ret);\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, RT5682_SCLK_S_PLL1,\n\t\t\t\t     pll_out, SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\tdev_warn(rtd->dev, \"snd_soc_dai_set_sysclk err = %d\\n\", ret);\n\n\t \n\tret = snd_soc_dai_set_tdm_slot(codec_dai, 0x0, 0x0, 2,\n\t\t\t\t       params_width(params));\n\tif (ret < 0)\n\t\tdev_warn(rtd->dev, \"set TDM slot err:%d\\n\", ret);\n\treturn ret;\n}\n\nstatic int cml_rt1011_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_card *card = rtd->card;\n\tint srate, i, ret = 0;\n\n\tsrate = params_rate(params);\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\n\t\t \n\t\tret = snd_soc_dai_set_pll(codec_dai, 0, RT1011_PLL1_S_BCLK,\n\t\t\t\t\t  100 * srate, 256 * srate);\n\t\tif (ret < 0) {\n\t\t\tdev_err(card->dev, \"codec_dai clock not set\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dai_set_sysclk(codec_dai,\n\t\t\t\t\t     RT1011_FS_SYS_PRE_S_PLL1,\n\t\t\t\t\t     256 * srate, SND_SOC_CLOCK_IN);\n\t\tif (ret < 0) {\n\t\t\tdev_err(card->dev, \"codec_dai clock not set\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tif (sof_rt1011_quirk & (SOF_RT1011_SPEAKER_WL |\n\t\t\t\t\tSOF_RT1011_SPEAKER_WR)) {\n\t\t\tif (!strcmp(codec_dai->component->name, \"i2c-10EC1011:00\")) {\n\t\t\t\tret = snd_soc_dai_set_tdm_slot(codec_dai,\n\t\t\t\t\t\t\t       0x4, 0x1, 4, 24);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!strcmp(codec_dai->component->name, \"i2c-10EC1011:01\")) {\n\t\t\t\tret = snd_soc_dai_set_tdm_slot(codec_dai,\n\t\t\t\t\t\t\t       0x8, 0x2, 4, 24);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (sof_rt1011_quirk & (SOF_RT1011_SPEAKER_TL |\n\t\t\t\t\tSOF_RT1011_SPEAKER_TR)) {\n\t\t\tif (!strcmp(codec_dai->component->name, \"i2c-10EC1011:02\")) {\n\t\t\t\tret = snd_soc_dai_set_tdm_slot(codec_dai,\n\t\t\t\t\t\t\t       0x1, 0x1, 4, 24);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!strcmp(codec_dai->component->name, \"i2c-10EC1011:03\")) {\n\t\t\t\tret = snd_soc_dai_set_tdm_slot(codec_dai,\n\t\t\t\t\t\t\t       0x2, 0x2, 4, 24);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (ret < 0)\n\t\tdev_err(rtd->dev,\n\t\t\t\"set codec TDM slot for %s failed with error %d\\n\",\n\t\t\tcodec_dai->component->name, ret);\n\treturn ret;\n}\n\nstatic struct snd_soc_ops cml_rt5682_ops = {\n\t.hw_params = cml_rt5682_hw_params,\n};\n\nstatic const struct snd_soc_ops cml_rt1011_ops = {\n\t.hw_params = cml_rt1011_hw_params,\n};\n\nstatic int sof_card_late_probe(struct snd_soc_card *card)\n{\n\tstruct card_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_component *component = NULL;\n\tchar jack_name[NAME_SIZE];\n\tstruct hdmi_pcm *pcm;\n\tint ret, i = 0;\n\n\tif (list_empty(&ctx->hdmi_pcm_list))\n\t\treturn -EINVAL;\n\n\tif (ctx->common_hdmi_codec_drv) {\n\t\tpcm = list_first_entry(&ctx->hdmi_pcm_list, struct hdmi_pcm,\n\t\t\t\t       head);\n\t\tcomponent = pcm->codec_dai->component;\n\t\treturn hda_dsp_hdmi_build_controls(card, component);\n\t}\n\n\tlist_for_each_entry(pcm, &ctx->hdmi_pcm_list, head) {\n\t\tcomponent = pcm->codec_dai->component;\n\t\tsnprintf(jack_name, sizeof(jack_name),\n\t\t\t \"HDMI/DP, pcm=%d Jack\", pcm->device);\n\t\tret = snd_soc_card_jack_new(card, jack_name,\n\t\t\t\t\t    SND_JACK_AVOUT, &hdmi_jack[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = hdac_hdmi_jack_init(pcm->codec_dai, pcm->device,\n\t\t\t\t\t  &hdmi_jack[i]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\ti++;\n\t}\n\n\treturn hdac_hdmi_jack_port_init(component, &card->dapm);\n}\n\nstatic int hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct hdmi_pcm *pcm;\n\n\tpcm = devm_kzalloc(rtd->card->dev, sizeof(*pcm), GFP_KERNEL);\n\tif (!pcm)\n\t\treturn -ENOMEM;\n\n\tpcm->device = dai->id;\n\tpcm->codec_dai = dai;\n\n\tlist_add_tail(&pcm->head, &ctx->hdmi_pcm_list);\n\n\treturn 0;\n}\n\n \n\nSND_SOC_DAILINK_DEF(ssp0_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"SSP0 Pin\")));\nSND_SOC_DAILINK_DEF(ssp0_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-10EC5682:00\",\n\t\t\t\tCML_RT5682_CODEC_DAI)));\n\nSND_SOC_DAILINK_DEF(ssp1_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"SSP1 Pin\")));\nSND_SOC_DAILINK_DEF(ssp1_codec_2spk,\n\tDAILINK_COMP_ARRAY(\n\t  COMP_CODEC(\"i2c-10EC1011:00\", CML_RT1011_CODEC_DAI),\n\t  COMP_CODEC(\"i2c-10EC1011:01\", CML_RT1011_CODEC_DAI)));\nSND_SOC_DAILINK_DEF(ssp1_codec_4spk,\n\tDAILINK_COMP_ARRAY(\n\t  COMP_CODEC(\"i2c-10EC1011:00\", CML_RT1011_CODEC_DAI),\n\t  COMP_CODEC(\"i2c-10EC1011:01\", CML_RT1011_CODEC_DAI),\n\t  COMP_CODEC(\"i2c-10EC1011:02\", CML_RT1011_CODEC_DAI),\n\t  COMP_CODEC(\"i2c-10EC1011:03\", CML_RT1011_CODEC_DAI)));\n\n\nSND_SOC_DAILINK_DEF(dmic_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DMIC01 Pin\")));\n\nSND_SOC_DAILINK_DEF(dmic16k_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DMIC16k Pin\")));\n\nSND_SOC_DAILINK_DEF(dmic_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"dmic-codec\", \"dmic-hifi\")));\n\nSND_SOC_DAILINK_DEF(idisp1_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp1 Pin\")));\nSND_SOC_DAILINK_DEF(idisp1_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi1\")));\n\nSND_SOC_DAILINK_DEF(idisp2_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp2 Pin\")));\nSND_SOC_DAILINK_DEF(idisp2_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi2\")));\n\nSND_SOC_DAILINK_DEF(idisp3_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp3 Pin\")));\nSND_SOC_DAILINK_DEF(idisp3_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi3\")));\n\nSND_SOC_DAILINK_DEF(platform,\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"0000:00:1f.3\")));\n\nstatic struct snd_soc_dai_link cml_rt1011_rt5682_dailink[] = {\n\t \n\t{\n\t\t \n\t\t.name = \"SSP0-Codec\",\n\t\t.id = 0,\n\t\t.init = cml_rt5682_codec_init,\n\t\t.exit = cml_rt5682_codec_exit,\n\t\t.ignore_pmdown_time = 1,\n\t\t.ops = &cml_rt5682_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(ssp0_pin, ssp0_codec, platform),\n\t},\n\t{\n\t\t.name = \"dmic01\",\n\t\t.id = 1,\n\t\t.ignore_suspend = 1,\n\t\t.dpcm_capture = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(dmic_pin, dmic_codec, platform),\n\t},\n\t{\n\t\t.name = \"dmic16k\",\n\t\t.id = 2,\n\t\t.ignore_suspend = 1,\n\t\t.dpcm_capture = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(dmic16k_pin, dmic_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp1\",\n\t\t.id = 3,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp1_pin, idisp1_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp2\",\n\t\t.id = 4,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp2_pin, idisp2_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp3\",\n\t\t.id = 5,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp3_pin, idisp3_codec, platform),\n\t},\n\t{\n\t\t \n\t\t.name = \"SSP1-Codec\",\n\t\t.id = 6,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,  \n\t\t.no_pcm = 1,\n\t\t.init = cml_rt1011_spk_init,\n\t\t.ops = &cml_rt1011_ops,\n\t\tSND_SOC_DAILINK_REG(ssp1_pin, ssp1_codec_2spk, platform),\n\t},\n};\n\nstatic struct snd_soc_codec_conf rt1011_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"i2c-10EC1011:00\"),\n\t\t.name_prefix = \"WL\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"i2c-10EC1011:01\"),\n\t\t.name_prefix = \"WR\",\n\t},\n\t \n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"i2c-10EC1011:02\"),\n\t\t.name_prefix = \"TL\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"i2c-10EC1011:03\"),\n\t\t.name_prefix = \"TR\",\n\t},\n};\n\n \nstatic struct snd_soc_card snd_soc_card_cml = {\n\t.name = \"cml_rt1011_rt5682\",\n\t.owner = THIS_MODULE,\n\t.dai_link = cml_rt1011_rt5682_dailink,\n\t.num_links = ARRAY_SIZE(cml_rt1011_rt5682_dailink),\n\t.codec_conf = rt1011_conf,\n\t.num_configs = ARRAY_SIZE(rt1011_conf),\n\t.dapm_widgets = cml_rt1011_rt5682_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(cml_rt1011_rt5682_widgets),\n\t.dapm_routes = cml_rt1011_rt5682_map,\n\t.num_dapm_routes = ARRAY_SIZE(cml_rt1011_rt5682_map),\n\t.controls = cml_controls,\n\t.num_controls = ARRAY_SIZE(cml_controls),\n\t.fully_routed = true,\n\t.late_probe = sof_card_late_probe,\n};\n\nstatic int snd_cml_rt1011_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_dai_link *dai_link;\n\tstruct card_private *ctx;\n\tstruct snd_soc_acpi_mach *mach;\n\tconst char *platform_name;\n\tint ret, i;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tINIT_LIST_HEAD(&ctx->hdmi_pcm_list);\n\tmach = pdev->dev.platform_data;\n\tsnd_soc_card_cml.dev = &pdev->dev;\n\tplatform_name = mach->mach_params.platform;\n\n\tdmi_check_system(sof_rt1011_quirk_table);\n\n\tdev_dbg(&pdev->dev, \"sof_rt1011_quirk = %lx\\n\", sof_rt1011_quirk);\n\n\t \n\tif (sof_rt1011_quirk & (SOF_RT1011_SPEAKER_TL |\n\t\t\t\tSOF_RT1011_SPEAKER_TR)) {\n\t\tfor_each_card_prelinks(&snd_soc_card_cml, i, dai_link) {\n\t\t\tif (!strcmp(dai_link->codecs[0].dai_name,\n\t\t\t\t    CML_RT1011_CODEC_DAI)) {\n\t\t\t\tdai_link->codecs = ssp1_codec_4spk;\n\t\t\t\tdai_link->num_codecs = ARRAY_SIZE(ssp1_codec_4spk);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tret = snd_soc_fixup_dai_links_platform_name(&snd_soc_card_cml,\n\t\t\t\t\t\t    platform_name);\n\tif (ret)\n\t\treturn ret;\n\n\tctx->common_hdmi_codec_drv = mach->mach_params.common_hdmi_codec_drv;\n\n\tsnd_soc_card_set_drvdata(&snd_soc_card_cml, ctx);\n\n\treturn devm_snd_soc_register_card(&pdev->dev, &snd_soc_card_cml);\n}\n\nstatic struct platform_driver snd_cml_rt1011_rt5682_driver = {\n\t.probe = snd_cml_rt1011_probe,\n\t.driver = {\n\t\t.name = \"cml_rt1011_rt5682\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n};\nmodule_platform_driver(snd_cml_rt1011_rt5682_driver);\n\n \nMODULE_DESCRIPTION(\"Cometlake Audio Machine driver - RT1011 and RT5682 in I2S mode\");\nMODULE_AUTHOR(\"Naveen Manohar <naveen.m@intel.com>\");\nMODULE_AUTHOR(\"Sathya Prakash M R <sathya.prakash.m.r@intel.com>\");\nMODULE_AUTHOR(\"Shuming Fan <shumingf@realtek.com>\");\nMODULE_AUTHOR(\"Mac Chiang <mac.chiang@intel.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:cml_rt1011_rt5682\");\nMODULE_IMPORT_NS(SND_SOC_INTEL_HDA_DSP_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}