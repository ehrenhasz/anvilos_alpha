{
  "module_name": "sof_nau8825.c",
  "hash_id": "e02a0ba70e1e461fed5e0286e94743858971f8d0633de8695e337a0d060716b0",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/sof_nau8825.c",
  "human_readable_source": "\n\n\n\n \n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/dmi.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/sof.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/nau8825.h\"\n#include \"../common/soc-intel-quirks.h\"\n#include \"hda_dsp_common.h\"\n#include \"sof_realtek_common.h\"\n#include \"sof_maxim_common.h\"\n\n#define NAME_SIZE 32\n\n#define SOF_NAU8825_SSP_CODEC(quirk)\t\t((quirk) & GENMASK(2, 0))\n#define SOF_NAU8825_SSP_CODEC_MASK\t\t(GENMASK(2, 0))\n#define SOF_SPEAKER_AMP_PRESENT\t\tBIT(3)\n#define SOF_NAU8825_SSP_AMP_SHIFT\t\t4\n#define SOF_NAU8825_SSP_AMP_MASK\t\t(GENMASK(6, 4))\n#define SOF_NAU8825_SSP_AMP(quirk)\t\\\n\t(((quirk) << SOF_NAU8825_SSP_AMP_SHIFT) & SOF_NAU8825_SSP_AMP_MASK)\n#define SOF_NAU8825_NUM_HDMIDEV_SHIFT\t\t7\n#define SOF_NAU8825_NUM_HDMIDEV_MASK\t\t(GENMASK(9, 7))\n#define SOF_NAU8825_NUM_HDMIDEV(quirk)\t\\\n\t(((quirk) << SOF_NAU8825_NUM_HDMIDEV_SHIFT) & SOF_NAU8825_NUM_HDMIDEV_MASK)\n\n \n#define SOF_BT_OFFLOAD_SSP_SHIFT\t\t10\n#define SOF_BT_OFFLOAD_SSP_MASK\t\t(GENMASK(12, 10))\n#define SOF_BT_OFFLOAD_SSP(quirk)\t\\\n\t(((quirk) << SOF_BT_OFFLOAD_SSP_SHIFT) & SOF_BT_OFFLOAD_SSP_MASK)\n#define SOF_SSP_BT_OFFLOAD_PRESENT\t\tBIT(13)\n#define SOF_RT1019P_SPEAKER_AMP_PRESENT\tBIT(14)\n#define SOF_MAX98373_SPEAKER_AMP_PRESENT\tBIT(15)\n#define SOF_MAX98360A_SPEAKER_AMP_PRESENT\tBIT(16)\n#define SOF_RT1015P_SPEAKER_AMP_PRESENT\tBIT(17)\n#define SOF_NAU8318_SPEAKER_AMP_PRESENT\tBIT(18)\n\nstatic unsigned long sof_nau8825_quirk = SOF_NAU8825_SSP_CODEC(0);\n\nstruct sof_hdmi_pcm {\n\tstruct list_head head;\n\tstruct snd_soc_dai *codec_dai;\n\tint device;\n};\n\nstruct sof_card_private {\n\tstruct clk *mclk;\n\tstruct snd_soc_jack sof_headset;\n\tstruct list_head hdmi_pcm_list;\n};\n\nstatic int sof_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct sof_hdmi_pcm *pcm;\n\n\tpcm = devm_kzalloc(rtd->card->dev, sizeof(*pcm), GFP_KERNEL);\n\tif (!pcm)\n\t\treturn -ENOMEM;\n\n\t \n\tpcm->device = rtd->dai_link->id;\n\tpcm->codec_dai = dai;\n\n\tlist_add_tail(&pcm->head, &ctx->hdmi_pcm_list);\n\n\treturn 0;\n}\n\nstatic struct snd_soc_jack_pin jack_pins[] = {\n\t{\n\t\t.pin    = \"Headphone Jack\",\n\t\t.mask   = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin    = \"Headset Mic\",\n\t\t.mask   = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int sof_nau8825_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tstruct snd_soc_jack *jack;\n\tint ret;\n\n\t \n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_BTN_0 |\n\t\t\t\t\t SND_JACK_BTN_1 | SND_JACK_BTN_2 |\n\t\t\t\t\t SND_JACK_BTN_3,\n\t\t\t\t\t &ctx->sof_headset,\n\t\t\t\t\t jack_pins,\n\t\t\t\t\t ARRAY_SIZE(jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack creation failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tjack = &ctx->sof_headset;\n\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\tret = snd_soc_component_set_jack(component, jack, NULL);\n\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack call-back failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n};\n\nstatic void sof_nau8825_codec_exit(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_set_jack(component, NULL, NULL);\n}\n\nstatic int sof_nau8825_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint clk_freq, ret;\n\n\tclk_freq = sof_dai_get_bclk(rtd);  \n\n\tif (clk_freq <= 0) {\n\t\tdev_err(rtd->dev, \"get bclk freq failed: %d\\n\", clk_freq);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, NAU8825_CLK_FLL_BLK, 0,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"can't set BCLK clock %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = snd_soc_dai_set_pll(codec_dai, 0, 0, clk_freq,\n\t\t\t\t  params_rate(params) * 256);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"can't set BCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic struct snd_soc_ops sof_nau8825_ops = {\n\t.hw_params = sof_nau8825_hw_params,\n};\n\nstatic struct snd_soc_dai_link_component platform_component[] = {\n\t{\n\t\t \n\t\t.name = \"0000:00:1f.3\"\n\t}\n};\n\nstatic int sof_card_late_probe(struct snd_soc_card *card)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_dapm_context *dapm = &card->dapm;\n\tstruct sof_hdmi_pcm *pcm;\n\tint err;\n\n\tif (sof_nau8825_quirk & SOF_MAX98373_SPEAKER_AMP_PRESENT) {\n\t\t \n\t\tsnd_soc_dapm_disable_pin(dapm, \"Left Spk\");\n\t\tsnd_soc_dapm_disable_pin(dapm, \"Right Spk\");\n\t\terr = snd_soc_dapm_sync(dapm);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tif (list_empty(&ctx->hdmi_pcm_list))\n\t\treturn -EINVAL;\n\n\tpcm = list_first_entry(&ctx->hdmi_pcm_list, struct sof_hdmi_pcm, head);\n\n\treturn hda_dsp_hdmi_build_controls(card, pcm->codec_dai->component);\n}\n\nstatic const struct snd_kcontrol_new sof_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone Jack\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Left Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Right Spk\"),\n};\n\nstatic const struct snd_kcontrol_new speaker_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget sof_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_SPK(\"Left Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Right Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_widget speaker_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_widget dmic_widgets[] = {\n\tSND_SOC_DAPM_MIC(\"SoC DMIC\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route sof_map[] = {\n\t \n\t{ \"Headphone Jack\", NULL, \"HPOL\" },\n\t{ \"Headphone Jack\", NULL, \"HPOR\" },\n\n\t \n\t{ \"MIC\", NULL, \"Headset Mic\" },\n};\n\nstatic const struct snd_soc_dapm_route speaker_map[] = {\n\t \n\t{ \"Spk\", NULL, \"Speaker\" },\n};\n\nstatic const struct snd_soc_dapm_route dmic_map[] = {\n\t \n\t{\"DMic\", NULL, \"SoC DMIC\"},\n};\n\nstatic int speaker_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, speaker_widgets,\n\t\t\t\t\tARRAY_SIZE(speaker_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add dapm controls, ret %d\\n\", ret);\n\t\t \n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, speaker_controls,\n\t\t\t\t\tARRAY_SIZE(speaker_controls));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, speaker_map,\n\t\t\t\t      ARRAY_SIZE(speaker_map));\n\n\tif (ret)\n\t\tdev_err(rtd->dev, \"Speaker map addition failed: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic int dmic_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, dmic_widgets,\n\t\t\t\t\tARRAY_SIZE(dmic_widgets));\n\tif (ret) {\n\t\tdev_err(card->dev, \"DMic widget addition failed: %d\\n\", ret);\n\t\t \n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dapm_add_routes(&card->dapm, dmic_map,\n\t\t\t\t      ARRAY_SIZE(dmic_map));\n\n\tif (ret)\n\t\tdev_err(card->dev, \"DMic map addition failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic struct snd_soc_card sof_audio_card_nau8825 = {\n\t.name = \"nau8825\",  \n\t.owner = THIS_MODULE,\n\t.controls = sof_controls,\n\t.num_controls = ARRAY_SIZE(sof_controls),\n\t.dapm_widgets = sof_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(sof_widgets),\n\t.dapm_routes = sof_map,\n\t.num_dapm_routes = ARRAY_SIZE(sof_map),\n\t.fully_routed = true,\n\t.late_probe = sof_card_late_probe,\n};\n\nstatic struct snd_soc_dai_link_component nau8825_component[] = {\n\t{\n\t\t.name = \"i2c-10508825:00\",\n\t\t.dai_name = \"nau8825-hifi\",\n\t}\n};\n\nstatic struct snd_soc_dai_link_component dmic_component[] = {\n\t{\n\t\t.name = \"dmic-codec\",\n\t\t.dai_name = \"dmic-hifi\",\n\t}\n};\n\nstatic struct snd_soc_dai_link_component rt1019p_component[] = {\n\t{\n\t\t.name = \"RTL1019:00\",\n\t\t.dai_name = \"HiFi\",\n\t}\n};\n\nstatic struct snd_soc_dai_link_component nau8318_components[] = {\n\t{\n\t\t.name = \"NVTN2012:00\",\n\t\t.dai_name = \"nau8315-hifi\",\n\t}\n};\n\nstatic struct snd_soc_dai_link *sof_card_dai_links_create(struct device *dev,\n\t\t\t\t\t\t\t  int ssp_codec,\n\t\t\t\t\t\t\t  int ssp_amp,\n\t\t\t\t\t\t\t  int dmic_be_num,\n\t\t\t\t\t\t\t  int hdmi_num)\n{\n\tstruct snd_soc_dai_link_component *idisp_components;\n\tstruct snd_soc_dai_link_component *cpus;\n\tstruct snd_soc_dai_link *links;\n\tint i, id = 0;\n\n\tlinks = devm_kcalloc(dev, sof_audio_card_nau8825.num_links,\n\t\t\t    sizeof(struct snd_soc_dai_link), GFP_KERNEL);\n\tcpus = devm_kcalloc(dev, sof_audio_card_nau8825.num_links,\n\t\t\t    sizeof(struct snd_soc_dai_link_component), GFP_KERNEL);\n\tif (!links || !cpus)\n\t\tgoto devm_err;\n\n\t \n\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\"SSP%d-Codec\", ssp_codec);\n\tif (!links[id].name)\n\t\tgoto devm_err;\n\n\tlinks[id].id = id;\n\tlinks[id].codecs = nau8825_component;\n\tlinks[id].num_codecs = ARRAY_SIZE(nau8825_component);\n\tlinks[id].platforms = platform_component;\n\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\tlinks[id].init = sof_nau8825_codec_init;\n\tlinks[id].exit = sof_nau8825_codec_exit;\n\tlinks[id].ops = &sof_nau8825_ops;\n\tlinks[id].dpcm_playback = 1;\n\tlinks[id].dpcm_capture = 1;\n\tlinks[id].no_pcm = 1;\n\tlinks[id].cpus = &cpus[id];\n\tlinks[id].num_cpus = 1;\n\n\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t  \"SSP%d Pin\",\n\t\t\t\t\t\t  ssp_codec);\n\tif (!links[id].cpus->dai_name)\n\t\tgoto devm_err;\n\n\tid++;\n\n\t \n\tif (dmic_be_num > 0) {\n\t\t \n\t\tlinks[id].name = \"dmic01\";\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].cpus->dai_name = \"DMIC01 Pin\";\n\t\tlinks[id].init = dmic_init;\n\t\tif (dmic_be_num > 1) {\n\t\t\t \n\t\t\tlinks[id + 1].name = \"dmic16k\";\n\t\t\tlinks[id + 1].cpus = &cpus[id + 1];\n\t\t\tlinks[id + 1].cpus->dai_name = \"DMIC16k Pin\";\n\t\t\tdmic_be_num = 2;\n\t\t}\n\t}\n\n\tfor (i = 0; i < dmic_be_num; i++) {\n\t\tlinks[id].id = id;\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].codecs = dmic_component;\n\t\tlinks[id].num_codecs = ARRAY_SIZE(dmic_component);\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].ignore_suspend = 1;\n\t\tlinks[id].dpcm_capture = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tid++;\n\t}\n\n\t \n\tif (hdmi_num > 0) {\n\t\tidisp_components = devm_kcalloc(dev,\n\t\t\t\t\t\thdmi_num,\n\t\t\t\t\t\tsizeof(struct snd_soc_dai_link_component),\n\t\t\t\t\t\tGFP_KERNEL);\n\t\tif (!idisp_components)\n\t\t\tgoto devm_err;\n\t}\n\tfor (i = 1; i <= hdmi_num; i++) {\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\"iDisp%d\", i);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].id = id;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"iDisp%d Pin\", i);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\n\t\tidisp_components[i - 1].name = \"ehdaudio0D2\";\n\t\tidisp_components[i - 1].dai_name = devm_kasprintf(dev,\n\t\t\t\t\t\t\t\t  GFP_KERNEL,\n\t\t\t\t\t\t\t\t  \"intel-hdmi-hifi%d\",\n\t\t\t\t\t\t\t\t  i);\n\t\tif (!idisp_components[i - 1].dai_name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].codecs = &idisp_components[i - 1];\n\t\tlinks[id].num_codecs = 1;\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].init = sof_hdmi_init;\n\t\tlinks[id].dpcm_playback = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tid++;\n\t}\n\n\t \n\tif (sof_nau8825_quirk & SOF_SPEAKER_AMP_PRESENT) {\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\"SSP%d-Codec\", ssp_amp);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\n\t\tlinks[id].id = id;\n\t\tif (sof_nau8825_quirk & SOF_RT1019P_SPEAKER_AMP_PRESENT) {\n\t\t\tlinks[id].codecs = rt1019p_component;\n\t\t\tlinks[id].num_codecs = ARRAY_SIZE(rt1019p_component);\n\t\t\tlinks[id].init = speaker_codec_init;\n\t\t} else if (sof_nau8825_quirk &\n\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT) {\n\t\t\tlinks[id].codecs = max_98373_components;\n\t\t\tlinks[id].num_codecs = ARRAY_SIZE(max_98373_components);\n\t\t\tlinks[id].init = max_98373_spk_codec_init;\n\t\t\tlinks[id].ops = &max_98373_ops;\n\t\t} else if (sof_nau8825_quirk &\n\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT) {\n\t\t\tmax_98360a_dai_link(&links[id]);\n\t\t} else if (sof_nau8825_quirk & SOF_RT1015P_SPEAKER_AMP_PRESENT) {\n\t\t\tsof_rt1015p_dai_link(&links[id]);\n\t\t} else if (sof_nau8825_quirk &\n\t\t\t\tSOF_NAU8318_SPEAKER_AMP_PRESENT) {\n\t\t\tlinks[id].codecs = nau8318_components;\n\t\t\tlinks[id].num_codecs = ARRAY_SIZE(nau8318_components);\n\t\t\tlinks[id].init = speaker_codec_init;\n\t\t} else {\n\t\t\tgoto devm_err;\n\t\t}\n\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].dpcm_playback = 1;\n\t\t \n\t\tlinks[id].dpcm_capture = 1;\n\n\t\tlinks[id].no_pcm = 1;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].num_cpus = 1;\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"SSP%d Pin\",\n\t\t\t\t\t\t\t  ssp_amp);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t\tid++;\n\t}\n\n\t \n\tif (sof_nau8825_quirk & SOF_SSP_BT_OFFLOAD_PRESENT) {\n\t\tint port = (sof_nau8825_quirk & SOF_BT_OFFLOAD_SSP_MASK) >>\n\t\t\t\tSOF_BT_OFFLOAD_SSP_SHIFT;\n\n\t\tlinks[id].id = id;\n\t\tlinks[id].cpus = &cpus[id];\n\t\tlinks[id].cpus->dai_name = devm_kasprintf(dev, GFP_KERNEL,\n\t\t\t\t\t\t\t  \"SSP%d Pin\", port);\n\t\tif (!links[id].cpus->dai_name)\n\t\t\tgoto devm_err;\n\t\tlinks[id].name = devm_kasprintf(dev, GFP_KERNEL, \"SSP%d-BT\", port);\n\t\tif (!links[id].name)\n\t\t\tgoto devm_err;\n\t\tlinks[id].codecs = &asoc_dummy_dlc;\n\t\tlinks[id].num_codecs = 1;\n\t\tlinks[id].platforms = platform_component;\n\t\tlinks[id].num_platforms = ARRAY_SIZE(platform_component);\n\t\tlinks[id].dpcm_playback = 1;\n\t\tlinks[id].dpcm_capture = 1;\n\t\tlinks[id].no_pcm = 1;\n\t\tlinks[id].num_cpus = 1;\n\t}\n\n\treturn links;\ndevm_err:\n\treturn NULL;\n}\n\nstatic int sof_audio_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_dai_link *dai_links;\n\tstruct snd_soc_acpi_mach *mach;\n\tstruct sof_card_private *ctx;\n\tint dmic_be_num, hdmi_num;\n\tint ret, ssp_amp, ssp_codec;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tif (pdev->id_entry && pdev->id_entry->driver_data)\n\t\tsof_nau8825_quirk = (unsigned long)pdev->id_entry->driver_data;\n\n\tmach = pdev->dev.platform_data;\n\n\t \n\tif ((sof_nau8825_quirk & SOF_SPEAKER_AMP_PRESENT) && !mach->quirk_data)\n\t\tsof_nau8825_quirk &= ~SOF_SPEAKER_AMP_PRESENT;\n\n\tdev_dbg(&pdev->dev, \"sof_nau8825_quirk = %lx\\n\", sof_nau8825_quirk);\n\n\t \n\tdmic_be_num = 2;\n\thdmi_num = (sof_nau8825_quirk & SOF_NAU8825_NUM_HDMIDEV_MASK) >>\n\t\t\tSOF_NAU8825_NUM_HDMIDEV_SHIFT;\n\t \n\tif (!hdmi_num)\n\t\thdmi_num = 3;\n\n\tssp_amp = (sof_nau8825_quirk & SOF_NAU8825_SSP_AMP_MASK) >>\n\t\t\tSOF_NAU8825_SSP_AMP_SHIFT;\n\n\tssp_codec = sof_nau8825_quirk & SOF_NAU8825_SSP_CODEC_MASK;\n\n\t \n\tsof_audio_card_nau8825.num_links = 1 + dmic_be_num + hdmi_num;\n\n\tif (sof_nau8825_quirk & SOF_SPEAKER_AMP_PRESENT)\n\t\tsof_audio_card_nau8825.num_links++;\n\n\tif (sof_nau8825_quirk & SOF_MAX98373_SPEAKER_AMP_PRESENT)\n\t\tmax_98373_set_codec_conf(&sof_audio_card_nau8825);\n\telse if (sof_nau8825_quirk & SOF_RT1015P_SPEAKER_AMP_PRESENT)\n\t\tsof_rt1015p_codec_conf(&sof_audio_card_nau8825);\n\n\tif (sof_nau8825_quirk & SOF_SSP_BT_OFFLOAD_PRESENT)\n\t\tsof_audio_card_nau8825.num_links++;\n\n\tdai_links = sof_card_dai_links_create(&pdev->dev, ssp_codec, ssp_amp,\n\t\t\t\t\t      dmic_be_num, hdmi_num);\n\tif (!dai_links)\n\t\treturn -ENOMEM;\n\n\tsof_audio_card_nau8825.dai_link = dai_links;\n\n\tINIT_LIST_HEAD(&ctx->hdmi_pcm_list);\n\n\tsof_audio_card_nau8825.dev = &pdev->dev;\n\n\t \n\tret = snd_soc_fixup_dai_links_platform_name(&sof_audio_card_nau8825,\n\t\t\t\t\t\t    mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_soc_card_set_drvdata(&sof_audio_card_nau8825, ctx);\n\n\treturn devm_snd_soc_register_card(&pdev->dev,\n\t\t\t\t\t  &sof_audio_card_nau8825);\n}\n\nstatic const struct platform_device_id board_ids[] = {\n\t{\n\t\t.name = \"sof_nau8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\n\t},\n\t{\n\t\t.name = \"adl_rt1019p_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1019P_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(2) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4)),\n\t},\n\t{\n\t\t.name = \"adl_max98373_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(1) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t \n\t\t.name = \"adl_mx98360a_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98360A_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(1) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\n\t},\n\t{\n\t\t.name = \"adl_rt1015p_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_RT1015P_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(1) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"adl_nau8318_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8318_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(1) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"rpl_max98373_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_MAX98373_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(1) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{\n\t\t.name = \"rpl_nau8318_8825\",\n\t\t.driver_data = (kernel_ulong_t)(SOF_NAU8825_SSP_CODEC(0) |\n\t\t\t\t\tSOF_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8318_SPEAKER_AMP_PRESENT |\n\t\t\t\t\tSOF_NAU8825_SSP_AMP(1) |\n\t\t\t\t\tSOF_NAU8825_NUM_HDMIDEV(4) |\n\t\t\t\t\tSOF_BT_OFFLOAD_SSP(2) |\n\t\t\t\t\tSOF_SSP_BT_OFFLOAD_PRESENT),\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, board_ids);\n\nstatic struct platform_driver sof_audio = {\n\t.probe = sof_audio_probe,\n\t.driver = {\n\t\t.name = \"sof_nau8825\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.id_table = board_ids,\n};\nmodule_platform_driver(sof_audio)\n\n \nMODULE_DESCRIPTION(\"SOF Audio Machine driver for NAU8825\");\nMODULE_AUTHOR(\"David Lin <ctlin0@nuvoton.com>\");\nMODULE_AUTHOR(\"Mac Chiang <mac.chiang@intel.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(SND_SOC_INTEL_HDA_DSP_COMMON);\nMODULE_IMPORT_NS(SND_SOC_INTEL_SOF_MAXIM_COMMON);\nMODULE_IMPORT_NS(SND_SOC_INTEL_SOF_REALTEK_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}