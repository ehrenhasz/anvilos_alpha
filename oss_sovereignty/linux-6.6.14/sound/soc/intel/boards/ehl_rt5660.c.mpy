{
  "module_name": "ehl_rt5660.c",
  "hash_id": "9d17b7a67c56d44e291f9cdd1dc236a0adaaa40bb89fa2adb60bc535936b54dd",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/ehl_rt5660.c",
  "human_readable_source": "\n\n\n \n\n#include <linux/acpi.h>\n#include <sound/core.h>\n#include <linux/device.h>\n#include <linux/errno.h>\n#include <linux/gfp.h>\n#include <sound/jack.h>\n#include <linux/kernel.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n\n#include \"hda_dsp_common.h\"\n#include \"../../codecs/rt5660.h\"\n\n#define DUAL_CHANNEL 2\n#define HDMI_LINK_START 3\n#define HDMI_LINE_END 6\n#define NAME_SIZE\t32\n#define IDISP_CODEC_MASK\t0x4\n\nstruct sof_card_private {\n\tstruct list_head hdmi_pcm_list;\n\tbool idisp_codec;\n};\n\nstatic const struct snd_kcontrol_new rt5660_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Speaker\"),\n\t \n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic2\"),\n\tSOC_DAPM_PIN_SWITCH(\"Line Out\"),\n};\n\nstatic const struct snd_soc_dapm_widget rt5660_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Speaker\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic2\", NULL),\n\tSND_SOC_DAPM_MIC(\"SoC DMIC\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line Out\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route rt5660_map[] = {\n\t{\"Speaker\", NULL, \"SPO\"},\n\n\t{\"Headset Mic\", NULL, \"MICBIAS1\"},\n\t{\"Headset Mic2\", NULL, \"MICBIAS2\"},\n\n\t{\"IN1P\", NULL, \"Headset Mic\"},\n\t{\"IN2P\", NULL, \"Headset Mic2\"},\n\n\t{\"Line Out\", NULL, \"LOUTL\"},\n\t{\"Line Out\", NULL, \"LOUTR\"},\n\n\t{\"DMic\", NULL, \"SoC DMIC\"},\n};\n\nstruct sof_hdmi_pcm {\n\tstruct list_head head;\n\tstruct snd_soc_dai *codec_dai;\n\tint device;\n};\n\nstatic int hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_dai *dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct sof_hdmi_pcm *pcm;\n\n\tpcm = devm_kzalloc(rtd->card->dev, sizeof(*pcm), GFP_KERNEL);\n\tif (!pcm)\n\t\treturn -ENOMEM;\n\n\t \n\tpcm->device = rtd->dai_link->id;\n\tpcm->codec_dai = dai;\n\n\tlist_add_tail(&pcm->head, &ctx->hdmi_pcm_list);\n\n\treturn 0;\n}\n\nstatic int card_late_probe(struct snd_soc_card *card)\n{\n\tstruct sof_card_private *ctx = snd_soc_card_get_drvdata(card);\n\tstruct sof_hdmi_pcm *pcm;\n\n\tif (list_empty(&ctx->hdmi_pcm_list))\n\t\treturn -ENOENT;\n\n\tif (!ctx->idisp_codec)\n\t\treturn 0;\n\n\tpcm = list_first_entry(&ctx->hdmi_pcm_list, struct sof_hdmi_pcm, head);\n\n\treturn hda_dsp_hdmi_build_controls(card, pcm->codec_dai->component);\n}\n\nstatic int rt5660_hw_params(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai,\n\t\t\t\t     RT5660_SCLK_S_PLL1,\n\t\t\t\t     params_rate(params) * 512,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"snd_soc_dai_set_sysclk err = %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_pll(codec_dai, 0,\n\t\t\t\t  RT5660_PLL1_S_BCLK,\n\t\t\t\t  params_rate(params) * 50,\n\t\t\t\t  params_rate(params) * 512);\n\tif (ret < 0)\n\t\tdev_err(codec_dai->dev, \"can't set codec pll: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic struct snd_soc_ops rt5660_ops = {\n\t.hw_params = rt5660_hw_params,\n};\n\nSND_SOC_DAILINK_DEF(ssp0_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"SSP0 Pin\")));\n\nSND_SOC_DAILINK_DEF(rt5660_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-10EC5660:00\", \"rt5660-aif1\")));\n\nSND_SOC_DAILINK_DEF(platform,\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"0000:00:1f.3\")));\n\nSND_SOC_DAILINK_DEF(dmic_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DMIC01 Pin\")));\nSND_SOC_DAILINK_DEF(dmic_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"dmic-codec\", \"dmic-hifi\")));\nSND_SOC_DAILINK_DEF(dmic16k,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DMIC16k Pin\")));\n\nSND_SOC_DAILINK_DEF(idisp1_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp1 Pin\")));\nSND_SOC_DAILINK_DEF(idisp1_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi1\")));\n\nSND_SOC_DAILINK_DEF(idisp2_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp2 Pin\")));\nSND_SOC_DAILINK_DEF(idisp2_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi2\")));\n\nSND_SOC_DAILINK_DEF(idisp3_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp3 Pin\")));\nSND_SOC_DAILINK_DEF(idisp3_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi3\")));\n\nSND_SOC_DAILINK_DEF(idisp4_pin,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"iDisp4 Pin\")));\nSND_SOC_DAILINK_DEF(idisp4_codec,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"ehdaudio0D2\", \"intel-hdmi-hifi4\")));\n\nstatic struct snd_soc_dai_link ehl_rt5660_dailink[] = {\n\t \n\t{\n\t\t.name = \"SSP0-Codec\",\n\t\t.id = 0,\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ops = &rt5660_ops,\n\t\tSND_SOC_DAILINK_REG(ssp0_pin, rt5660_codec, platform),\n\t},\n\t{\n\t\t.name = \"dmic48k\",\n\t\t.id = 1,\n\t\t.ignore_suspend = 1,\n\t\t.dpcm_capture = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(dmic_pin, dmic_codec, platform),\n\t},\n\t{\n\t\t.name = \"dmic16k\",\n\t\t.id = 2,\n\t\t.ignore_suspend = 1,\n\t\t.dpcm_capture = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(dmic16k, dmic_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp1\",\n\t\t.id = 5,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp1_pin, idisp1_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp2\",\n\t\t.id = 6,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp2_pin, idisp2_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp3\",\n\t\t.id = 7,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp3_pin, idisp3_codec, platform),\n\t},\n\t{\n\t\t.name = \"iDisp4\",\n\t\t.id = 8,\n\t\t.init = hdmi_init,\n\t\t.dpcm_playback = 1,\n\t\t.no_pcm = 1,\n\t\tSND_SOC_DAILINK_REG(idisp4_pin, idisp4_codec, platform),\n\t},\n};\n\n \nstatic struct snd_soc_card snd_soc_card_ehl_rt5660 = {\n\t.name = \"ehl-rt5660\",\n\t.owner = THIS_MODULE,\n\t.dai_link = ehl_rt5660_dailink,\n\t.num_links = ARRAY_SIZE(ehl_rt5660_dailink),\n\t.dapm_widgets = rt5660_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(rt5660_widgets),\n\t.dapm_routes = rt5660_map,\n\t.num_dapm_routes = ARRAY_SIZE(rt5660_map),\n\t.controls = rt5660_controls,\n\t.num_controls = ARRAY_SIZE(rt5660_controls),\n\t.fully_routed = true,\n\t.late_probe = card_late_probe,\n};\n\n \nstatic void hdmi_link_init(struct snd_soc_card *card,\n\t\t\t   struct sof_card_private *ctx,\n\t\t\t   struct snd_soc_acpi_mach *mach)\n{\n\tint i;\n\n\tif (mach->mach_params.common_hdmi_codec_drv &&\n\t    (mach->mach_params.codec_mask & IDISP_CODEC_MASK)) {\n\t\tctx->idisp_codec = true;\n\t\treturn;\n\t}\n\n\t \n\tfor (i = HDMI_LINK_START; i <= HDMI_LINE_END; i++)\n\t\tcard->dai_link[i].codecs[0] = asoc_dummy_dlc;\n}\n\nstatic int snd_ehl_rt5660_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_acpi_mach *mach;\n\tstruct snd_soc_card *card = &snd_soc_card_ehl_rt5660;\n\tstruct sof_card_private *ctx;\n\tint ret;\n\n\tcard->dev = &pdev->dev;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\tINIT_LIST_HEAD(&ctx->hdmi_pcm_list);\n\tsnd_soc_card_set_drvdata(card, ctx);\n\n\tmach = pdev->dev.platform_data;\n\tret = snd_soc_fixup_dai_links_platform_name(card,\n\t\t\t\t\t\t    mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\thdmi_link_init(card, ctx, mach);\n\n\treturn devm_snd_soc_register_card(&pdev->dev, card);\n}\n\nstatic const struct platform_device_id ehl_board_ids[] = {\n\t{ .name = \"ehl_rt5660\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, ehl_board_ids);\n\nstatic struct platform_driver snd_ehl_rt5660_driver = {\n\t.driver = {\n\t\t.name = \"ehl_rt5660\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = snd_ehl_rt5660_probe,\n\t.id_table = ehl_board_ids,\n};\n\nmodule_platform_driver(snd_ehl_rt5660_driver);\n\nMODULE_DESCRIPTION(\"ASoC Intel(R) Elkhartlake + rt5660 Machine driver\");\nMODULE_AUTHOR(\"libin.yang@intel.com\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_IMPORT_NS(SND_SOC_INTEL_HDA_DSP_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}