{
  "module_name": "bdw-rt5677.c",
  "hash_id": "0011ec7c992b5fd4b37c5073965de44f93950b1c95e115dd46161c31fa7daa05",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/bdw-rt5677.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/gpio/consumer.h>\n#include <linux/delay.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n#include <sound/pcm_params.h>\n#include <sound/jack.h>\n#include <sound/soc-acpi.h>\n\n#include \"../../codecs/rt5677.h\"\n\nstruct bdw_rt5677_priv {\n\tstruct gpio_desc *gpio_hp_en;\n\tstruct snd_soc_component *component;\n};\n\nstatic int bdw_rt5677_event_hp(struct snd_soc_dapm_widget *w,\n\t\t\tstruct snd_kcontrol *k, int event)\n{\n\tstruct snd_soc_dapm_context *dapm = w->dapm;\n\tstruct snd_soc_card *card = dapm->card;\n\tstruct bdw_rt5677_priv *bdw_rt5677 = snd_soc_card_get_drvdata(card);\n\n\tif (SND_SOC_DAPM_EVENT_ON(event))\n\t\tmsleep(70);\n\n\tgpiod_set_value_cansleep(bdw_rt5677->gpio_hp_en,\n\t\tSND_SOC_DAPM_EVENT_ON(event));\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dapm_widget bdw_rt5677_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", bdw_rt5677_event_hp),\n\tSND_SOC_DAPM_SPK(\"Speaker\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Local DMICs\", NULL),\n\tSND_SOC_DAPM_MIC(\"Remote DMICs\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route bdw_rt5677_map[] = {\n\t \n\t{\"Speaker\", NULL, \"PDM1L\"},\n\t{\"Speaker\", NULL, \"PDM1R\"},\n\n\t \n\t{\"Headphone\", NULL, \"LOUT1\"},\n\t{\"Headphone\", NULL, \"LOUT2\"},\n\t{\"IN1P\", NULL, \"Headset Mic\"},\n\t{\"IN1N\", NULL, \"Headset Mic\"},\n\n\t \n\t{\"DMIC L1\", NULL, \"Remote DMICs\"},\n\t{\"DMIC R1\", NULL, \"Remote DMICs\"},\n\t{\"DMIC L2\", NULL, \"Local DMICs\"},\n\t{\"DMIC R2\", NULL, \"Local DMICs\"},\n\n\t \n\t{\"SSP0 CODEC IN\", NULL, \"AIF1 Capture\"},\n\t{\"AIF1 Playback\", NULL, \"SSP0 CODEC OUT\"},\n\t{\"DSP Capture\", NULL, \"DSP Buffer\"},\n\n\t \n\t{ \"DSP Buffer\", NULL, \"SSP0 CODEC IN\" },\n\t{ \"SSP0 CODEC IN\", NULL, \"DSPTX\" },\n};\n\nstatic const struct snd_kcontrol_new bdw_rt5677_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Speaker\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Local DMICs\"),\n\tSOC_DAPM_PIN_SWITCH(\"Remote DMICs\"),\n};\n\n\nstatic struct snd_soc_jack headphone_jack;\nstatic struct snd_soc_jack mic_jack;\n\nstatic struct snd_soc_jack_pin headphone_jack_pin = {\n\t.pin\t= \"Headphone\",\n\t.mask\t= SND_JACK_HEADPHONE,\n};\n\nstatic struct snd_soc_jack_pin mic_jack_pin = {\n\t.pin\t= \"Headset Mic\",\n\t.mask\t= SND_JACK_MICROPHONE,\n};\n\nstatic struct snd_soc_jack_gpio headphone_jack_gpio = {\n\t.name\t\t\t= \"plug-det\",\n\t.report\t\t\t= SND_JACK_HEADPHONE,\n\t.debounce_time\t\t= 200,\n};\n\nstatic struct snd_soc_jack_gpio mic_jack_gpio = {\n\t.name\t\t\t= \"mic-present\",\n\t.report\t\t\t= SND_JACK_MICROPHONE,\n\t.debounce_time\t\t= 200,\n\t.invert\t\t\t= 1,\n};\n\n \nenum {\n\tRT5677_GPIO_PLUG_DET\t\t= 0,\n\tRT5677_GPIO_MIC_PRESENT_L\t= 1,\n\tRT5677_GPIO_HOTWORD_DET_L\t= 2,\n\tRT5677_GPIO_DSP_INT\t\t= 3,\n\tRT5677_GPIO_HP_AMP_SHDN_L\t= 4,\n};\n\nstatic const struct acpi_gpio_params plug_det_gpio = { RT5677_GPIO_PLUG_DET, 0, false };\nstatic const struct acpi_gpio_params mic_present_gpio = { RT5677_GPIO_MIC_PRESENT_L, 0, false };\nstatic const struct acpi_gpio_params headphone_enable_gpio = { RT5677_GPIO_HP_AMP_SHDN_L, 0, false };\n\nstatic const struct acpi_gpio_mapping bdw_rt5677_gpios[] = {\n\t{ \"plug-det-gpios\", &plug_det_gpio, 1 },\n\t{ \"mic-present-gpios\", &mic_present_gpio, 1 },\n\t{ \"headphone-enable-gpios\", &headphone_enable_gpio, 1 },\n\t{ NULL },\n};\n\nstatic int broadwell_ssp0_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_interval *rate = hw_param_interval(params,\n\t\t\t\t\t\t      SNDRV_PCM_HW_PARAM_RATE);\n\tstruct snd_interval *chan = hw_param_interval(params,\n\t\t\t\t\t\t      SNDRV_PCM_HW_PARAM_CHANNELS);\n\n\t \n\trate->min = rate->max = 48000;\n\tchan->min = chan->max = 2;\n\n\t \n\tparams_set_format(params, SNDRV_PCM_FORMAT_S16_LE);\n\treturn 0;\n}\n\nstatic int bdw_rt5677_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, RT5677_SCLK_S_MCLK, 24576000,\n\t\tSND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set codec sysclk configuration\\n\");\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic int bdw_rt5677_dsp_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, RT5677_SCLK_S_PLL1, 24576000,\n\t\tSND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set codec sysclk configuration\\n\");\n\t\treturn ret;\n\t}\n\tret = snd_soc_dai_set_pll(codec_dai, 0, RT5677_PLL1_S_MCLK,\n\t\t24000000, 24576000);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"can't set codec pll configuration\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops bdw_rt5677_ops = {\n\t.hw_params = bdw_rt5677_hw_params,\n};\n\nstatic const struct snd_soc_ops bdw_rt5677_dsp_ops = {\n\t.hw_params = bdw_rt5677_dsp_hw_params,\n};\n\nstatic const unsigned int channels[] = {\n\t2,\n};\n\nstatic const struct snd_pcm_hw_constraint_list constraints_channels = {\n\t.count = ARRAY_SIZE(channels),\n\t.list = channels,\n\t.mask = 0,\n};\n\nstatic int bdw_rt5677_fe_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\t \n\truntime->hw.channels_max = 2;\n\treturn snd_pcm_hw_constraint_list(runtime, 0,\n\t\t\t\t\t  SNDRV_PCM_HW_PARAM_CHANNELS,\n\t\t\t\t\t  &constraints_channels);\n}\n\nstatic const struct snd_soc_ops bdw_rt5677_fe_ops = {\n\t.startup = bdw_rt5677_fe_startup,\n};\n\nstatic int bdw_rt5677_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct bdw_rt5677_priv *bdw_rt5677 =\n\t\t\tsnd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tint ret;\n\n\tret = devm_acpi_dev_add_driver_gpios(component->dev, bdw_rt5677_gpios);\n\tif (ret)\n\t\tdev_warn(component->dev, \"Failed to add driver gpios\\n\");\n\n\t \n\trt5677_sel_asrc_clk_src(component, RT5677_DA_STEREO_FILTER |\n\t\t\tRT5677_AD_STEREO1_FILTER | RT5677_I2S1_SOURCE,\n\t\t\tRT5677_CLK_SEL_I2S1_ASRC);\n\t \n\trt5677_sel_asrc_clk_src(component, RT5677_AD_MONO_L_FILTER,\n\t\t\tRT5677_CLK_SEL_SYS2);\n\n\t \n\tbdw_rt5677->gpio_hp_en = gpiod_get(component->dev, \"headphone-enable\",\n\t\t\t\t\t   GPIOD_OUT_LOW);\n\tif (IS_ERR(bdw_rt5677->gpio_hp_en)) {\n\t\tdev_err(component->dev, \"Can't find HP_AMP_SHDN_L gpio\\n\");\n\t\treturn PTR_ERR(bdw_rt5677->gpio_hp_en);\n\t}\n\n\t \n\tif (!snd_soc_card_jack_new_pins(rtd->card, \"Headphone Jack\",\n\t\t\tSND_JACK_HEADPHONE, &headphone_jack,\n\t\t\t&headphone_jack_pin, 1)) {\n\t\theadphone_jack_gpio.gpiod_dev = component->dev;\n\t\tif (snd_soc_jack_add_gpios(&headphone_jack, 1,\n\t\t\t\t&headphone_jack_gpio))\n\t\t\tdev_err(component->dev, \"Can't add headphone jack gpio\\n\");\n\t} else {\n\t\tdev_err(component->dev, \"Can't create headphone jack\\n\");\n\t}\n\n\t \n\tif (!snd_soc_card_jack_new_pins(rtd->card, \"Mic Jack\",\n\t\t\tSND_JACK_MICROPHONE, &mic_jack,\n\t\t\t&mic_jack_pin, 1)) {\n\t\tmic_jack_gpio.gpiod_dev = component->dev;\n\t\tif (snd_soc_jack_add_gpios(&mic_jack, 1, &mic_jack_gpio))\n\t\t\tdev_err(component->dev, \"Can't add mic jack gpio\\n\");\n\t} else {\n\t\tdev_err(component->dev, \"Can't create mic jack\\n\");\n\t}\n\tbdw_rt5677->component = component;\n\n\tsnd_soc_dapm_force_enable_pin(dapm, \"MICBIAS1\");\n\treturn 0;\n}\n\nstatic void bdw_rt5677_exit(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct bdw_rt5677_priv *bdw_rt5677 =\n\t\t\tsnd_soc_card_get_drvdata(rtd->card);\n\n\t \n\tif (!IS_ERR_OR_NULL(bdw_rt5677->gpio_hp_en))\n\t\tgpiod_put(bdw_rt5677->gpio_hp_en);\n}\n\n \nSND_SOC_DAILINK_DEF(dummy,\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()));\n\nSND_SOC_DAILINK_DEF(fe,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"System Pin\")));\n\nSND_SOC_DAILINK_DEF(platform,\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"haswell-pcm-audio\")));\n\nSND_SOC_DAILINK_DEF(be,\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-RT5677CE:00\", \"rt5677-aif1\")));\n\nSND_SOC_DAILINK_DEF(ssp0_port,\n\t    DAILINK_COMP_ARRAY(COMP_CPU(\"ssp0-port\")));\n\n \nSND_SOC_DAILINK_DEFS(dsp,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"spi-RT5677AA:00\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-RT5677CE:00\", \"rt5677-dspbuffer\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"spi-RT5677AA:00\")));\n\nstatic struct snd_soc_dai_link bdw_rt5677_dais[] = {\n\t \n\t{\n\t\t.name = \"System PCM\",\n\t\t.stream_name = \"System Playback/Capture\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST\n\t\t},\n\t\t.dpcm_capture = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ops = &bdw_rt5677_fe_ops,\n\t\tSND_SOC_DAILINK_REG(fe, dummy, platform),\n\t},\n\n\t \n\t{\n\t\t.name = \"Codec DSP\",\n\t\t.stream_name = \"Wake on Voice\",\n\t\t.capture_only = 1,\n\t\t.ops = &bdw_rt5677_dsp_ops,\n\t\tSND_SOC_DAILINK_REG(dsp),\n\t},\n\n\t \n\t{\n\t\t \n\t\t.name = \"Codec\",\n\t\t.id = 0,\n\t\t.nonatomic = 1,\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBC_CFC,\n\t\t.ignore_pmdown_time = 1,\n\t\t.be_hw_params_fixup = broadwell_ssp0_fixup,\n\t\t.ops = &bdw_rt5677_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.init = bdw_rt5677_init,\n\t\t.exit = bdw_rt5677_exit,\n\t\tSND_SOC_DAILINK_REG(ssp0_port, be, platform),\n\t},\n};\n\nstatic int bdw_rt5677_suspend_pre(struct snd_soc_card *card)\n{\n\tstruct bdw_rt5677_priv *bdw_rt5677 = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_dapm_context *dapm;\n\n\tif (bdw_rt5677->component) {\n\t\tdapm = snd_soc_component_get_dapm(bdw_rt5677->component);\n\t\tsnd_soc_dapm_disable_pin(dapm, \"MICBIAS1\");\n\t}\n\treturn 0;\n}\n\nstatic int bdw_rt5677_resume_post(struct snd_soc_card *card)\n{\n\tstruct bdw_rt5677_priv *bdw_rt5677 = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_dapm_context *dapm;\n\n\tif (bdw_rt5677->component) {\n\t\tdapm = snd_soc_component_get_dapm(bdw_rt5677->component);\n\t\tsnd_soc_dapm_force_enable_pin(dapm, \"MICBIAS1\");\n\t}\n\treturn 0;\n}\n\n \n#define SOF_CARD_NAME \"bdw rt5677\"  \n#define SOF_DRIVER_NAME \"SOF\"\n\n#define CARD_NAME \"bdw-rt5677\"\n#define DRIVER_NAME NULL  \n\n \nstatic struct snd_soc_card bdw_rt5677_card = {\n\t.name = CARD_NAME,\n\t.driver_name = DRIVER_NAME,\n\t.owner = THIS_MODULE,\n\t.dai_link = bdw_rt5677_dais,\n\t.num_links = ARRAY_SIZE(bdw_rt5677_dais),\n\t.dapm_widgets = bdw_rt5677_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(bdw_rt5677_widgets),\n\t.dapm_routes = bdw_rt5677_map,\n\t.num_dapm_routes = ARRAY_SIZE(bdw_rt5677_map),\n\t.controls = bdw_rt5677_controls,\n\t.num_controls = ARRAY_SIZE(bdw_rt5677_controls),\n\t.fully_routed = true,\n\t.suspend_pre = bdw_rt5677_suspend_pre,\n\t.resume_post = bdw_rt5677_resume_post,\n};\n\nstatic int bdw_rt5677_probe(struct platform_device *pdev)\n{\n\tstruct bdw_rt5677_priv *bdw_rt5677;\n\tstruct snd_soc_acpi_mach *mach;\n\tint ret;\n\n\tbdw_rt5677_card.dev = &pdev->dev;\n\n\t \n\tbdw_rt5677 = devm_kzalloc(&pdev->dev, sizeof(struct bdw_rt5677_priv),\n\t\tGFP_KERNEL);\n\tif (!bdw_rt5677)\n\t\treturn -ENOMEM;\n\n\t \n\tmach = pdev->dev.platform_data;\n\tret = snd_soc_fixup_dai_links_platform_name(&bdw_rt5677_card,\n\t\t\t\t\t\t    mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (snd_soc_acpi_sof_parent(&pdev->dev)) {\n\t\tbdw_rt5677_card.name = SOF_CARD_NAME;\n\t\tbdw_rt5677_card.driver_name = SOF_DRIVER_NAME;\n\t} else {\n\t\tbdw_rt5677_card.name = CARD_NAME;\n\t\tbdw_rt5677_card.driver_name = DRIVER_NAME;\n\t}\n\n\tsnd_soc_card_set_drvdata(&bdw_rt5677_card, bdw_rt5677);\n\n\treturn devm_snd_soc_register_card(&pdev->dev, &bdw_rt5677_card);\n}\n\nstatic struct platform_driver bdw_rt5677_audio = {\n\t.probe = bdw_rt5677_probe,\n\t.driver = {\n\t\t.name = \"bdw-rt5677\",\n\t\t.pm = &snd_soc_pm_ops\n\t},\n};\n\nmodule_platform_driver(bdw_rt5677_audio)\n\n \nMODULE_AUTHOR(\"Ben Zhang\");\nMODULE_DESCRIPTION(\"Intel Broadwell RT5677 machine driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:bdw-rt5677\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}