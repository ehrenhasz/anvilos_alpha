{
  "module_name": "hsw_rt5640.c",
  "hash_id": "ff60ee6457be4a1cb422e0934224f4a661a72e96a3c9a5c4c71772710ef4f169",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/hsw_rt5640.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/rt5640.h\"\n\nstatic const struct snd_soc_dapm_widget card_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphones\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route card_routes[] = {\n\t{\"Headphones\", NULL, \"HPOR\"},\n\t{\"Headphones\", NULL, \"HPOL\"},\n\t{\"IN2P\", NULL, \"Mic\"},\n\n\t \n\t{\"SSP0 CODEC IN\", NULL, \"AIF1 Capture\"},\n\t{\"AIF1 Playback\", NULL, \"SSP0 CODEC OUT\"},\n};\n\nstatic int codec_link_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tstruct snd_interval *channels = hw_param_interval(params, SNDRV_PCM_HW_PARAM_CHANNELS);\n\tstruct snd_interval *rate = hw_param_interval(params, SNDRV_PCM_HW_PARAM_RATE);\n\n\t \n\trate->min = rate->max = 48000;\n\tchannels->min = channels->max = 2;\n\t \n\tparams_set_format(params, SNDRV_PCM_FORMAT_S16_LE);\n\n\treturn 0;\n}\n\nstatic int codec_link_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, RT5640_SCLK_S_MCLK, 12288000, SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"set codec sysclk failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tsnd_soc_component_update_bits(codec_dai->component, 0x83, 0xffff, 0x8000);\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops codec_link_ops = {\n\t.hw_params = codec_link_hw_params,\n};\n\nSND_SOC_DAILINK_DEF(system, DAILINK_COMP_ARRAY(COMP_CPU(\"System Pin\")));\nSND_SOC_DAILINK_DEF(offload0, DAILINK_COMP_ARRAY(COMP_CPU(\"Offload0 Pin\")));\nSND_SOC_DAILINK_DEF(offload1, DAILINK_COMP_ARRAY(COMP_CPU(\"Offload1 Pin\")));\nSND_SOC_DAILINK_DEF(loopback, DAILINK_COMP_ARRAY(COMP_CPU(\"Loopback Pin\")));\n\nSND_SOC_DAILINK_DEF(dummy, DAILINK_COMP_ARRAY(COMP_DUMMY()));\nSND_SOC_DAILINK_DEF(codec, DAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-INT33CA:00\", \"rt5640-aif1\")));\nSND_SOC_DAILINK_DEF(platform, DAILINK_COMP_ARRAY(COMP_PLATFORM(\"haswell-pcm-audio\")));\nSND_SOC_DAILINK_DEF(ssp0_port, DAILINK_COMP_ARRAY(COMP_CPU(\"ssp0-port\")));\n\nstatic struct snd_soc_dai_link card_dai_links[] = {\n\t \n\t{\n\t\t.name = \"System\",\n\t\t.stream_name = \"System Playback/Capture\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(system, dummy, platform),\n\t},\n\t{\n\t\t.name = \"Offload0\",\n\t\t.stream_name = \"Offload0 Playback\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(offload0, dummy, platform),\n\t},\n\t{\n\t\t.name = \"Offload1\",\n\t\t.stream_name = \"Offload1 Playback\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(offload1, dummy, platform),\n\t},\n\t{\n\t\t.name = \"Loopback\",\n\t\t.stream_name = \"Loopback\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(loopback, dummy, platform),\n\t},\n\t \n\t{\n\t\t \n\t\t.name = \"Codec\",\n\t\t.id = 0,\n\t\t.nonatomic = 1,\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBC_CFC,\n\t\t.ignore_pmdown_time = 1,\n\t\t.be_hw_params_fixup = codec_link_hw_params_fixup,\n\t\t.ops = &codec_link_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(ssp0_port, codec, platform),\n\t},\n};\n\nstatic struct snd_soc_card hsw_rt5640_card = {\n\t.name = \"haswell-rt5640\",\n\t.owner = THIS_MODULE,\n\t.dai_link = card_dai_links,\n\t.num_links = ARRAY_SIZE(card_dai_links),\n\t.dapm_widgets = card_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(card_widgets),\n\t.dapm_routes = card_routes,\n\t.num_dapm_routes = ARRAY_SIZE(card_routes),\n\t.fully_routed = true,\n};\n\nstatic int hsw_rt5640_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_acpi_mach *mach;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\thsw_rt5640_card.dev = dev;\n\tmach = dev_get_platdata(dev);\n\n\tret = snd_soc_fixup_dai_links_platform_name(&hsw_rt5640_card, mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_snd_soc_register_card(dev, &hsw_rt5640_card);\n}\n\nstatic struct platform_driver hsw_rt5640_driver = {\n\t.probe = hsw_rt5640_probe,\n\t.driver = {\n\t\t.name = \"hsw_rt5640\",\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n};\n\nmodule_platform_driver(hsw_rt5640_driver)\n\nMODULE_AUTHOR(\"Liam Girdwood, Xingchao Wang\");\nMODULE_DESCRIPTION(\"Sound card driver for Intel Haswell Lynx Point with Realtek 5640\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:hsw_rt5640\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}