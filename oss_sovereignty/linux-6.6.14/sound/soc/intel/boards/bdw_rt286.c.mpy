{
  "module_name": "bdw_rt286.c",
  "hash_id": "1daa4a9eba7df2c8656c08cdd817597ce0cf0dfa89c05b98f4b5f3ac572ca2af",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/intel/boards/bdw_rt286.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include \"../../codecs/rt286.h\"\n\nstatic struct snd_soc_jack card_headset;\n\nstatic struct snd_soc_jack_pin card_headset_pins[] = {\n\t{\n\t\t.pin = \"Mic Jack\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Headphone Jack\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n};\n\nstatic const struct snd_kcontrol_new card_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Speaker\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headphone Jack\"),\n};\n\nstatic const struct snd_soc_dapm_widget card_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_SPK(\"Speaker\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"DMIC1\", NULL),\n\tSND_SOC_DAPM_MIC(\"DMIC2\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line Jack\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route card_routes[] = {\n\t{\"Speaker\", NULL, \"SPOR\"},\n\t{\"Speaker\", NULL, \"SPOL\"},\n\n\t{\"Headphone Jack\", NULL, \"HPO Pin\"},\n\n\t{\"MIC1\", NULL, \"Mic Jack\"},\n\t{\"LINE1\", NULL, \"Line Jack\"},\n\n\t{\"DMIC1 Pin\", NULL, \"DMIC1\"},\n\t{\"DMIC2 Pin\", NULL, \"DMIC2\"},\n\n\t \n\t{\"SSP0 CODEC IN\", NULL, \"AIF1 Capture\"},\n\t{\"AIF1 Playback\", NULL, \"SSP0 CODEC OUT\"},\n};\n\nstatic int codec_link_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *codec = asoc_rtd_to_codec(rtd, 0)->component;\n\tint ret;\n\n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset\", SND_JACK_HEADSET | SND_JACK_BTN_0,\n\t\t\t\t\t &card_headset, card_headset_pins,\n\t\t\t\t\t ARRAY_SIZE(card_headset_pins));\n\tif (ret)\n\t\treturn ret;\n\n\treturn snd_soc_component_set_jack(codec, &card_headset, NULL);\n}\n\nstatic void codec_link_exit(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *codec = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_set_jack(codec, NULL, NULL);\n}\n\nstatic int codec_link_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tstruct snd_interval *channels = hw_param_interval(params, SNDRV_PCM_HW_PARAM_CHANNELS);\n\tstruct snd_interval *rate = hw_param_interval(params, SNDRV_PCM_HW_PARAM_RATE);\n\n\t \n\trate->min = rate->max = 48000;\n\tchannels->min = channels->max = 2;\n\t \n\tparams_set_format(params, SNDRV_PCM_FORMAT_S16_LE);\n\n\treturn 0;\n}\n\nstatic int codec_link_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, RT286_SCLK_S_PLL, 24000000, SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(rtd->dev, \"set codec sysclk failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops codec_link_ops = {\n\t.hw_params = codec_link_hw_params,\n};\n\nSND_SOC_DAILINK_DEF(system, DAILINK_COMP_ARRAY(COMP_CPU(\"System Pin\")));\nSND_SOC_DAILINK_DEF(offload0, DAILINK_COMP_ARRAY(COMP_CPU(\"Offload0 Pin\")));\nSND_SOC_DAILINK_DEF(offload1, DAILINK_COMP_ARRAY(COMP_CPU(\"Offload1 Pin\")));\nSND_SOC_DAILINK_DEF(loopback, DAILINK_COMP_ARRAY(COMP_CPU(\"Loopback Pin\")));\n\nSND_SOC_DAILINK_DEF(dummy, DAILINK_COMP_ARRAY(COMP_DUMMY()));\nSND_SOC_DAILINK_DEF(platform, DAILINK_COMP_ARRAY(COMP_PLATFORM(\"haswell-pcm-audio\")));\nSND_SOC_DAILINK_DEF(codec, DAILINK_COMP_ARRAY(COMP_CODEC(\"i2c-INT343A:00\", \"rt286-aif1\")));\nSND_SOC_DAILINK_DEF(ssp0_port, DAILINK_COMP_ARRAY(COMP_CPU(\"ssp0-port\")));\n\nstatic struct snd_soc_dai_link card_dai_links[] = {\n\t \n\t{\n\t\t.name = \"System PCM\",\n\t\t.stream_name = \"System Playback/Capture\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(system, dummy, platform),\n\t},\n\t{\n\t\t.name = \"Offload0\",\n\t\t.stream_name = \"Offload0 Playback\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(offload0, dummy, platform),\n\t},\n\t{\n\t\t.name = \"Offload1\",\n\t\t.stream_name = \"Offload1 Playback\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(offload1, dummy, platform),\n\t},\n\t{\n\t\t.name = \"Loopback PCM\",\n\t\t.stream_name = \"Loopback\",\n\t\t.nonatomic = 1,\n\t\t.dynamic = 1,\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(loopback, dummy, platform),\n\t},\n\t \n\t{\n\t\t \n\t\t.name = \"Codec\",\n\t\t.id = 0,\n\t\t.nonatomic = 1,\n\t\t.no_pcm = 1,\n\t\t.init = codec_link_init,\n\t\t.exit = codec_link_exit,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBC_CFC,\n\t\t.ignore_pmdown_time = 1,\n\t\t.be_hw_params_fixup = codec_link_hw_params_fixup,\n\t\t.ops = &codec_link_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(ssp0_port, codec, platform),\n\t},\n};\n\nstatic int card_suspend_pre(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai *codec_dai = snd_soc_card_get_codec_dai(card, \"rt286-aif1\");\n\n\tif (!codec_dai)\n\t\treturn 0;\n\n\treturn snd_soc_component_set_jack(codec_dai->component, NULL, NULL);\n}\n\nstatic int card_resume_post(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai *codec_dai = snd_soc_card_get_codec_dai(card, \"rt286-aif1\");\n\n\tif (!codec_dai)\n\t\treturn 0;\n\n\treturn snd_soc_component_set_jack(codec_dai->component, &card_headset, NULL);\n}\n\nstatic struct snd_soc_card bdw_rt286_card = {\n\t.owner = THIS_MODULE,\n\t.suspend_pre = card_suspend_pre,\n\t.resume_post = card_resume_post,\n\t.dai_link = card_dai_links,\n\t.num_links = ARRAY_SIZE(card_dai_links),\n\t.controls = card_controls,\n\t.num_controls = ARRAY_SIZE(card_controls),\n\t.dapm_widgets = card_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(card_widgets),\n\t.dapm_routes = card_routes,\n\t.num_dapm_routes = ARRAY_SIZE(card_routes),\n\t.fully_routed = true,\n};\n\n \n#define SOF_CARD_NAME \"bdw rt286\"  \n#define SOF_DRIVER_NAME \"SOF\"\n\n#define CARD_NAME \"broadwell-rt286\"\n\nstatic int bdw_rt286_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_acpi_mach *mach;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\tbdw_rt286_card.dev = dev;\n\tmach = dev_get_platdata(dev);\n\n\tret = snd_soc_fixup_dai_links_platform_name(&bdw_rt286_card, mach->mach_params.platform);\n\tif (ret)\n\t\treturn ret;\n\n\tif (snd_soc_acpi_sof_parent(dev)) {\n\t\tbdw_rt286_card.name = SOF_CARD_NAME;\n\t\tbdw_rt286_card.driver_name = SOF_DRIVER_NAME;\n\t} else {\n\t\tbdw_rt286_card.name = CARD_NAME;\n\t}\n\n\treturn devm_snd_soc_register_card(dev, &bdw_rt286_card);\n}\n\nstatic struct platform_driver bdw_rt286_driver = {\n\t.probe = bdw_rt286_probe,\n\t.driver = {\n\t\t.name = \"bdw_rt286\",\n\t\t.pm = &snd_soc_pm_ops\n\t},\n};\n\nmodule_platform_driver(bdw_rt286_driver)\n\nMODULE_AUTHOR(\"Liam Girdwood, Xingchao Wang\");\nMODULE_DESCRIPTION(\"Sound card driver for Intel Broadwell Wildcat Point with Realtek 286\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:bdw_rt286\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}