{
  "module_name": "max9759.c",
  "hash_id": "cddfac236ab12cfe8902b5d05125d91ea439465869cf8ac6b42e033145e96496",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/max9759.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/tlv.h>\n\n#define DRV_NAME \"max9759\"\n\nstruct max9759 {\n\tstruct gpio_desc *gpiod_shutdown;\n\tstruct gpio_desc *gpiod_mute;\n\tstruct gpio_descs *gpiod_gain;\n\tbool is_mute;\n\tunsigned int gain;\n};\n\nstatic int pga_event(struct snd_soc_dapm_widget *w,\n\t\t     struct snd_kcontrol *control, int event)\n{\n\tstruct snd_soc_component *c = snd_soc_dapm_to_component(w->dapm);\n\tstruct max9759 *priv = snd_soc_component_get_drvdata(c);\n\n\tif (SND_SOC_DAPM_EVENT_ON(event))\n\t\tgpiod_set_value_cansleep(priv->gpiod_shutdown, 0);\n\telse\n\t\tgpiod_set_value_cansleep(priv->gpiod_shutdown, 1);\n\n\treturn 0;\n}\n\n \nstatic const DECLARE_TLV_DB_SCALE(speaker_gain_tlv, 600, 600, 0);\n\nstatic int speaker_gain_control_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *c = snd_soc_kcontrol_component(kcontrol);\n\tstruct max9759 *priv = snd_soc_component_get_drvdata(c);\n\n\tucontrol->value.integer.value[0] = priv->gain;\n\n\treturn 0;\n}\n\nstatic const bool speaker_gain_table[4][2] = {\n\t \n\t{true, true},\t \n\t{false, true},\t \n\t{true, false},\t \n\t{false, false},\t \n};\n\nstatic int speaker_gain_control_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *c = snd_soc_kcontrol_component(kcontrol);\n\tstruct max9759 *priv = snd_soc_component_get_drvdata(c);\n\n\tif (ucontrol->value.integer.value[0] < 0 ||\n\t    ucontrol->value.integer.value[0] > 3)\n\t\treturn -EINVAL;\n\n\tpriv->gain = ucontrol->value.integer.value[0];\n\n\t \n\tgpiod_set_value_cansleep(priv->gpiod_gain->desc[0],\n\t\t\t\t speaker_gain_table[priv->gain][0]);\n\t \n\tgpiod_set_value_cansleep(priv->gpiod_gain->desc[1],\n\t\t\t\t speaker_gain_table[priv->gain][1]);\n\n\treturn 1;\n}\n\nstatic int speaker_mute_get(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *c = snd_soc_kcontrol_component(kcontrol);\n\tstruct max9759 *priv = snd_soc_component_get_drvdata(c);\n\n\tucontrol->value.integer.value[0] = !priv->is_mute;\n\n\treturn 0;\n}\n\nstatic int speaker_mute_put(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *c = snd_soc_kcontrol_component(kcontrol);\n\tstruct max9759 *priv = snd_soc_component_get_drvdata(c);\n\n\tpriv->is_mute = !ucontrol->value.integer.value[0];\n\n\tgpiod_set_value_cansleep(priv->gpiod_mute, priv->is_mute);\n\n\treturn 1;\n}\n\nstatic const struct snd_kcontrol_new max9759_dapm_controls[] = {\n\tSOC_SINGLE_EXT_TLV(\"Speaker Gain Volume\", 0, 0, 3, 0,\n\t\t\t   speaker_gain_control_get, speaker_gain_control_put,\n\t\t\t   speaker_gain_tlv),\n\tSOC_SINGLE_BOOL_EXT(\"Playback Switch\", 0,\n\t\t\t    speaker_mute_get, speaker_mute_put),\n};\n\nstatic const struct snd_soc_dapm_widget max9759_dapm_widgets[] = {\n\tSND_SOC_DAPM_INPUT(\"INL\"),\n\tSND_SOC_DAPM_INPUT(\"INR\"),\n\tSND_SOC_DAPM_PGA_E(\"PGA\", SND_SOC_NOPM, 0, 0, NULL, 0, pga_event,\n\t\t\t   (SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD)),\n\tSND_SOC_DAPM_OUTPUT(\"OUTL\"),\n\tSND_SOC_DAPM_OUTPUT(\"OUTR\"),\n};\n\nstatic const struct snd_soc_dapm_route max9759_dapm_routes[] = {\n\t{ \"PGA\", NULL, \"INL\" },\n\t{ \"PGA\", NULL, \"INR\" },\n\t{ \"OUTL\", NULL, \"PGA\" },\n\t{ \"OUTR\", NULL, \"PGA\" },\n};\n\nstatic const struct snd_soc_component_driver max9759_component_driver = {\n\t.controls\t\t= max9759_dapm_controls,\n\t.num_controls\t\t= ARRAY_SIZE(max9759_dapm_controls),\n\t.dapm_widgets\t\t= max9759_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(max9759_dapm_widgets),\n\t.dapm_routes\t\t= max9759_dapm_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(max9759_dapm_routes),\n};\n\nstatic int max9759_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct max9759 *priv;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, priv);\n\n\tpriv->gpiod_shutdown = devm_gpiod_get(dev, \"shutdown\", GPIOD_OUT_HIGH);\n\tif (IS_ERR(priv->gpiod_shutdown))\n\t\treturn dev_err_probe(dev, PTR_ERR(priv->gpiod_shutdown),\n\t\t\t\t     \"Failed to get 'shutdown' gpio\");\n\n\tpriv->gpiod_mute = devm_gpiod_get(dev, \"mute\", GPIOD_OUT_HIGH);\n\tif (IS_ERR(priv->gpiod_mute))\n\t\treturn dev_err_probe(dev, PTR_ERR(priv->gpiod_mute),\n\t\t\t\t     \"Failed to get 'mute' gpio\");\n\tpriv->is_mute = true;\n\n\tpriv->gpiod_gain = devm_gpiod_get_array(dev, \"gain\", GPIOD_OUT_HIGH);\n\tif (IS_ERR(priv->gpiod_gain))\n\t\treturn dev_err_probe(dev, PTR_ERR(priv->gpiod_gain),\n\t\t\t\t     \"Failed to get 'gain' gpios\");\n\tpriv->gain = 0;\n\n\tif (priv->gpiod_gain->ndescs != 2) {\n\t\tdev_err(dev, \"Invalid 'gain' gpios count: %d\",\n\t\t\tpriv->gpiod_gain->ndescs);\n\t\treturn -EINVAL;\n\t}\n\n\treturn devm_snd_soc_register_component(dev, &max9759_component_driver,\n\t\t\t\t\t       NULL, 0);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id max9759_ids[] = {\n\t{ .compatible = \"maxim,max9759\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max9759_ids);\n#endif\n\nstatic struct platform_driver max9759_driver = {\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.of_match_table = of_match_ptr(max9759_ids),\n\t},\n\t.probe = max9759_probe,\n};\n\nmodule_platform_driver(max9759_driver);\n\nMODULE_DESCRIPTION(\"ASoC MAX9759 amplifier driver\");\nMODULE_AUTHOR(\"Neil Armstrong <narmstrong@baylibre.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}