{
  "module_name": "wm8996.c",
  "hash_id": "024b092b71a4e3af533c31a76af92488387a5f162a891fa3d7bce042ba9249fc",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/wm8996.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/init.h>\n#include <linux/completion.h>\n#include <linux/delay.h>\n#include <linux/pm.h>\n#include <linux/gcd.h>\n#include <linux/gpio/driver.h>\n#include <linux/gpio.h>\n#include <linux/i2c.h>\n#include <linux/regmap.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slab.h>\n#include <linux/workqueue.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/initval.h>\n#include <sound/tlv.h>\n#include <trace/events/asoc.h>\n\n#include <sound/wm8996.h>\n#include \"wm8996.h\"\n\n#define WM8996_AIFS 2\n\n#define HPOUT1L 1\n#define HPOUT1R 2\n#define HPOUT2L 4\n#define HPOUT2R 8\n\n#define WM8996_NUM_SUPPLIES 3\nstatic const char *wm8996_supply_names[WM8996_NUM_SUPPLIES] = {\n\t\"DBVDD\",\n\t\"AVDD1\",\n\t\"AVDD2\",\n};\n\nstruct wm8996_priv {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tstruct snd_soc_component *component;\n\n\tint ldo1ena;\n\n\tint sysclk;\n\tint sysclk_src;\n\n\tint fll_src;\n\tint fll_fref;\n\tint fll_fout;\n\n\tstruct completion fll_lock;\n\n\tu16 dcs_pending;\n\tstruct completion dcs_done;\n\n\tu16 hpout_ena;\n\tu16 hpout_pending;\n\n\tstruct regulator_bulk_data supplies[WM8996_NUM_SUPPLIES];\n\tstruct notifier_block disable_nb[WM8996_NUM_SUPPLIES];\n\tint bg_ena;\n\n\tstruct wm8996_pdata pdata;\n\n\tint rx_rate[WM8996_AIFS];\n\tint bclk_rate[WM8996_AIFS];\n\n\t \n\tint num_retune_mobile_texts;\n\tconst char **retune_mobile_texts;\n\tint retune_mobile_cfg[2];\n\tstruct soc_enum retune_mobile_enum;\n\n\tstruct snd_soc_jack *jack;\n\tbool detecting;\n\tbool jack_mic;\n\tint jack_flips;\n\twm8996_polarity_fn polarity_cb;\n\n#ifdef CONFIG_GPIOLIB\n\tstruct gpio_chip gpio_chip;\n#endif\n};\n\n \n#define WM8996_REGULATOR_EVENT(n) \\\nstatic int wm8996_regulator_event_##n(struct notifier_block *nb, \\\n\t\t\t\t    unsigned long event, void *data)\t\\\n{ \\\n\tstruct wm8996_priv *wm8996 = container_of(nb, struct wm8996_priv, \\\n\t\t\t\t\t\t  disable_nb[n]); \\\n\tif (event & REGULATOR_EVENT_DISABLE) { \\\n\t\tregcache_mark_dirty(wm8996->regmap);\t\\\n\t} \\\n\treturn 0; \\\n}\n\nWM8996_REGULATOR_EVENT(0)\nWM8996_REGULATOR_EVENT(1)\nWM8996_REGULATOR_EVENT(2)\n\nstatic const struct reg_default wm8996_reg[] = {\n\t{ WM8996_POWER_MANAGEMENT_1, 0x0 },\n\t{ WM8996_POWER_MANAGEMENT_2, 0x0 },\n\t{ WM8996_POWER_MANAGEMENT_3, 0x0 },\n\t{ WM8996_POWER_MANAGEMENT_4, 0x0 },\n\t{ WM8996_POWER_MANAGEMENT_5, 0x0 },\n\t{ WM8996_POWER_MANAGEMENT_6, 0x0 },\n\t{ WM8996_POWER_MANAGEMENT_7, 0x10 },\n\t{ WM8996_POWER_MANAGEMENT_8, 0x0 },\n\t{ WM8996_LEFT_LINE_INPUT_VOLUME, 0x0 },\n\t{ WM8996_RIGHT_LINE_INPUT_VOLUME, 0x0 },\n\t{ WM8996_LINE_INPUT_CONTROL, 0x0 },\n\t{ WM8996_DAC1_HPOUT1_VOLUME, 0x88 },\n\t{ WM8996_DAC2_HPOUT2_VOLUME, 0x88 },\n\t{ WM8996_DAC1_LEFT_VOLUME, 0x2c0 },\n\t{ WM8996_DAC1_RIGHT_VOLUME, 0x2c0 },\n\t{ WM8996_DAC2_LEFT_VOLUME, 0x2c0 },\n\t{ WM8996_DAC2_RIGHT_VOLUME, 0x2c0 },\n\t{ WM8996_OUTPUT1_LEFT_VOLUME, 0x80 },\n\t{ WM8996_OUTPUT1_RIGHT_VOLUME, 0x80 },\n\t{ WM8996_OUTPUT2_LEFT_VOLUME, 0x80 },\n\t{ WM8996_OUTPUT2_RIGHT_VOLUME, 0x80 },\n\t{ WM8996_MICBIAS_1, 0x39 },\n\t{ WM8996_MICBIAS_2, 0x39 },\n\t{ WM8996_LDO_1, 0x3 },\n\t{ WM8996_LDO_2, 0x13 },\n\t{ WM8996_ACCESSORY_DETECT_MODE_1, 0x4 },\n\t{ WM8996_ACCESSORY_DETECT_MODE_2, 0x0 },\n\t{ WM8996_HEADPHONE_DETECT_1, 0x20 },\n\t{ WM8996_HEADPHONE_DETECT_2, 0x0 },\n\t{ WM8996_MIC_DETECT_1, 0x7600 },\n\t{ WM8996_MIC_DETECT_2, 0xbf },\n\t{ WM8996_CHARGE_PUMP_1, 0x1f25 },\n\t{ WM8996_CHARGE_PUMP_2, 0xab19 },\n\t{ WM8996_DC_SERVO_1, 0x0 },\n\t{ WM8996_DC_SERVO_3, 0x0 },\n\t{ WM8996_DC_SERVO_5, 0x2a2a },\n\t{ WM8996_DC_SERVO_6, 0x0 },\n\t{ WM8996_DC_SERVO_7, 0x0 },\n\t{ WM8996_ANALOGUE_HP_1, 0x0 },\n\t{ WM8996_ANALOGUE_HP_2, 0x0 },\n\t{ WM8996_CONTROL_INTERFACE_1, 0x8004 },\n\t{ WM8996_WRITE_SEQUENCER_CTRL_1, 0x0 },\n\t{ WM8996_WRITE_SEQUENCER_CTRL_2, 0x0 },\n\t{ WM8996_AIF_CLOCKING_1, 0x0 },\n\t{ WM8996_AIF_CLOCKING_2, 0x0 },\n\t{ WM8996_CLOCKING_1, 0x10 },\n\t{ WM8996_CLOCKING_2, 0x0 },\n\t{ WM8996_AIF_RATE, 0x83 },\n\t{ WM8996_FLL_CONTROL_1, 0x0 },\n\t{ WM8996_FLL_CONTROL_2, 0x0 },\n\t{ WM8996_FLL_CONTROL_3, 0x0 },\n\t{ WM8996_FLL_CONTROL_4, 0x5dc0 },\n\t{ WM8996_FLL_CONTROL_5, 0xc84 },\n\t{ WM8996_FLL_EFS_1, 0x0 },\n\t{ WM8996_FLL_EFS_2, 0x2 },\n\t{ WM8996_AIF1_CONTROL, 0x0 },\n\t{ WM8996_AIF1_BCLK, 0x0 },\n\t{ WM8996_AIF1_TX_LRCLK_1, 0x80 },\n\t{ WM8996_AIF1_TX_LRCLK_2, 0x8 },\n\t{ WM8996_AIF1_RX_LRCLK_1, 0x80 },\n\t{ WM8996_AIF1_RX_LRCLK_2, 0x0 },\n\t{ WM8996_AIF1TX_DATA_CONFIGURATION_1, 0x1818 },\n\t{ WM8996_AIF1TX_DATA_CONFIGURATION_2, 0 },\n\t{ WM8996_AIF1RX_DATA_CONFIGURATION, 0x1818 },\n\t{ WM8996_AIF1TX_CHANNEL_0_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1TX_CHANNEL_1_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1TX_CHANNEL_2_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1TX_CHANNEL_3_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1TX_CHANNEL_4_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1TX_CHANNEL_5_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_CHANNEL_0_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_CHANNEL_1_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_CHANNEL_2_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_CHANNEL_3_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_CHANNEL_4_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_CHANNEL_5_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1RX_MONO_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF1TX_TEST, 0x7 },\n\t{ WM8996_AIF2_CONTROL, 0x0 },\n\t{ WM8996_AIF2_BCLK, 0x0 },\n\t{ WM8996_AIF2_TX_LRCLK_1, 0x80 },\n\t{ WM8996_AIF2_TX_LRCLK_2, 0x8 },\n\t{ WM8996_AIF2_RX_LRCLK_1, 0x80 },\n\t{ WM8996_AIF2_RX_LRCLK_2, 0x0 },\n\t{ WM8996_AIF2TX_DATA_CONFIGURATION_1, 0x1818 },\n\t{ WM8996_AIF2RX_DATA_CONFIGURATION, 0x1818 },\n\t{ WM8996_AIF2RX_DATA_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF2TX_CHANNEL_0_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF2TX_CHANNEL_1_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF2RX_CHANNEL_0_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF2RX_CHANNEL_1_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF2RX_MONO_CONFIGURATION, 0x0 },\n\t{ WM8996_AIF2TX_TEST, 0x1 },\n\t{ WM8996_DSP1_TX_LEFT_VOLUME, 0xc0 },\n\t{ WM8996_DSP1_TX_RIGHT_VOLUME, 0xc0 },\n\t{ WM8996_DSP1_RX_LEFT_VOLUME, 0xc0 },\n\t{ WM8996_DSP1_RX_RIGHT_VOLUME, 0xc0 },\n\t{ WM8996_DSP1_TX_FILTERS, 0x2000 },\n\t{ WM8996_DSP1_RX_FILTERS_1, 0x200 },\n\t{ WM8996_DSP1_RX_FILTERS_2, 0x10 },\n\t{ WM8996_DSP1_DRC_1, 0x98 },\n\t{ WM8996_DSP1_DRC_2, 0x845 },\n\t{ WM8996_DSP1_RX_EQ_GAINS_1, 0x6318 },\n\t{ WM8996_DSP1_RX_EQ_GAINS_2, 0x6300 },\n\t{ WM8996_DSP1_RX_EQ_BAND_1_A, 0xfca },\n\t{ WM8996_DSP1_RX_EQ_BAND_1_B, 0x400 },\n\t{ WM8996_DSP1_RX_EQ_BAND_1_PG, 0xd8 },\n\t{ WM8996_DSP1_RX_EQ_BAND_2_A, 0x1eb5 },\n\t{ WM8996_DSP1_RX_EQ_BAND_2_B, 0xf145 },\n\t{ WM8996_DSP1_RX_EQ_BAND_2_C, 0xb75 },\n\t{ WM8996_DSP1_RX_EQ_BAND_2_PG, 0x1c5 },\n\t{ WM8996_DSP1_RX_EQ_BAND_3_A, 0x1c58 },\n\t{ WM8996_DSP1_RX_EQ_BAND_3_B, 0xf373 },\n\t{ WM8996_DSP1_RX_EQ_BAND_3_C, 0xa54 },\n\t{ WM8996_DSP1_RX_EQ_BAND_3_PG, 0x558 },\n\t{ WM8996_DSP1_RX_EQ_BAND_4_A, 0x168e },\n\t{ WM8996_DSP1_RX_EQ_BAND_4_B, 0xf829 },\n\t{ WM8996_DSP1_RX_EQ_BAND_4_C, 0x7ad },\n\t{ WM8996_DSP1_RX_EQ_BAND_4_PG, 0x1103 },\n\t{ WM8996_DSP1_RX_EQ_BAND_5_A, 0x564 },\n\t{ WM8996_DSP1_RX_EQ_BAND_5_B, 0x559 },\n\t{ WM8996_DSP1_RX_EQ_BAND_5_PG, 0x4000 },\n\t{ WM8996_DSP2_TX_LEFT_VOLUME, 0xc0 },\n\t{ WM8996_DSP2_TX_RIGHT_VOLUME, 0xc0 },\n\t{ WM8996_DSP2_RX_LEFT_VOLUME, 0xc0 },\n\t{ WM8996_DSP2_RX_RIGHT_VOLUME, 0xc0 },\n\t{ WM8996_DSP2_TX_FILTERS, 0x2000 },\n\t{ WM8996_DSP2_RX_FILTERS_1, 0x200 },\n\t{ WM8996_DSP2_RX_FILTERS_2, 0x10 },\n\t{ WM8996_DSP2_DRC_1, 0x98 },\n\t{ WM8996_DSP2_DRC_2, 0x845 },\n\t{ WM8996_DSP2_RX_EQ_GAINS_1, 0x6318 },\n\t{ WM8996_DSP2_RX_EQ_GAINS_2, 0x6300 },\n\t{ WM8996_DSP2_RX_EQ_BAND_1_A, 0xfca },\n\t{ WM8996_DSP2_RX_EQ_BAND_1_B, 0x400 },\n\t{ WM8996_DSP2_RX_EQ_BAND_1_PG, 0xd8 },\n\t{ WM8996_DSP2_RX_EQ_BAND_2_A, 0x1eb5 },\n\t{ WM8996_DSP2_RX_EQ_BAND_2_B, 0xf145 },\n\t{ WM8996_DSP2_RX_EQ_BAND_2_C, 0xb75 },\n\t{ WM8996_DSP2_RX_EQ_BAND_2_PG, 0x1c5 },\n\t{ WM8996_DSP2_RX_EQ_BAND_3_A, 0x1c58 },\n\t{ WM8996_DSP2_RX_EQ_BAND_3_B, 0xf373 },\n\t{ WM8996_DSP2_RX_EQ_BAND_3_C, 0xa54 },\n\t{ WM8996_DSP2_RX_EQ_BAND_3_PG, 0x558 },\n\t{ WM8996_DSP2_RX_EQ_BAND_4_A, 0x168e },\n\t{ WM8996_DSP2_RX_EQ_BAND_4_B, 0xf829 },\n\t{ WM8996_DSP2_RX_EQ_BAND_4_C, 0x7ad },\n\t{ WM8996_DSP2_RX_EQ_BAND_4_PG, 0x1103 },\n\t{ WM8996_DSP2_RX_EQ_BAND_5_A, 0x564 },\n\t{ WM8996_DSP2_RX_EQ_BAND_5_B, 0x559 },\n\t{ WM8996_DSP2_RX_EQ_BAND_5_PG, 0x4000 },\n\t{ WM8996_DAC1_MIXER_VOLUMES, 0x0 },\n\t{ WM8996_DAC1_LEFT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DAC1_RIGHT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DAC2_MIXER_VOLUMES, 0x0 },\n\t{ WM8996_DAC2_LEFT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DAC2_RIGHT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DSP1_TX_LEFT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DSP1_TX_RIGHT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DSP2_TX_LEFT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DSP2_TX_RIGHT_MIXER_ROUTING, 0x0 },\n\t{ WM8996_DSP_TX_MIXER_SELECT, 0x0 },\n\t{ WM8996_DAC_SOFTMUTE, 0x0 },\n\t{ WM8996_OVERSAMPLING, 0xd },\n\t{ WM8996_SIDETONE, 0x1040 },\n\t{ WM8996_GPIO_1, 0xa101 },\n\t{ WM8996_GPIO_2, 0xa101 },\n\t{ WM8996_GPIO_3, 0xa101 },\n\t{ WM8996_GPIO_4, 0xa101 },\n\t{ WM8996_GPIO_5, 0xa101 },\n\t{ WM8996_PULL_CONTROL_1, 0x0 },\n\t{ WM8996_PULL_CONTROL_2, 0x140 },\n\t{ WM8996_INTERRUPT_STATUS_1_MASK, 0x1f },\n\t{ WM8996_INTERRUPT_STATUS_2_MASK, 0x1ecf },\n\t{ WM8996_LEFT_PDM_SPEAKER, 0x0 },\n\t{ WM8996_RIGHT_PDM_SPEAKER, 0x1 },\n\t{ WM8996_PDM_SPEAKER_MUTE_SEQUENCE, 0x69 },\n\t{ WM8996_PDM_SPEAKER_VOLUME, 0x66 },\n};\n\nstatic const DECLARE_TLV_DB_SCALE(inpga_tlv, 0, 100, 0);\nstatic const DECLARE_TLV_DB_SCALE(sidetone_tlv, -3600, 150, 0);\nstatic const DECLARE_TLV_DB_SCALE(digital_tlv, -7200, 75, 1);\nstatic const DECLARE_TLV_DB_SCALE(out_digital_tlv, -1200, 150, 0);\nstatic const DECLARE_TLV_DB_SCALE(out_tlv, -900, 75, 0);\nstatic const DECLARE_TLV_DB_SCALE(spk_tlv, -900, 150, 0);\nstatic const DECLARE_TLV_DB_SCALE(eq_tlv, -1200, 100, 0);\nstatic const DECLARE_TLV_DB_SCALE(threedstereo_tlv, -1600, 183, 1);\n\nstatic const char *sidetone_hpf_text[] = {\n\t\"2.9kHz\", \"1.5kHz\", \"735Hz\", \"403Hz\", \"196Hz\", \"98Hz\", \"49Hz\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(sidetone_hpf,\n\t\t\t    WM8996_SIDETONE, 7, sidetone_hpf_text);\n\nstatic const char *hpf_mode_text[] = {\n\t\"HiFi\", \"Custom\", \"Voice\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(dsp1tx_hpf_mode,\n\t\t\t    WM8996_DSP1_TX_FILTERS, 3, hpf_mode_text);\n\nstatic SOC_ENUM_SINGLE_DECL(dsp2tx_hpf_mode,\n\t\t\t    WM8996_DSP2_TX_FILTERS, 3, hpf_mode_text);\n\nstatic const char *hpf_cutoff_text[] = {\n\t\"50Hz\", \"75Hz\", \"100Hz\", \"150Hz\", \"200Hz\", \"300Hz\", \"400Hz\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(dsp1tx_hpf_cutoff,\n\t\t\t    WM8996_DSP1_TX_FILTERS, 0, hpf_cutoff_text);\n\nstatic SOC_ENUM_SINGLE_DECL(dsp2tx_hpf_cutoff,\n\t\t\t    WM8996_DSP2_TX_FILTERS, 0, hpf_cutoff_text);\n\nstatic void wm8996_set_retune_mobile(struct snd_soc_component *component, int block)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tstruct wm8996_pdata *pdata = &wm8996->pdata;\n\tint base, best, best_val, save, i, cfg, iface;\n\n\tif (!wm8996->num_retune_mobile_texts)\n\t\treturn;\n\n\tswitch (block) {\n\tcase 0:\n\t\tbase = WM8996_DSP1_RX_EQ_GAINS_1;\n\t\tif (snd_soc_component_read(component, WM8996_POWER_MANAGEMENT_8) &\n\t\t    WM8996_DSP1RX_SRC)\n\t\t\tiface = 1;\n\t\telse\n\t\t\tiface = 0;\n\t\tbreak;\n\tcase 1:\n\t\tbase = WM8996_DSP1_RX_EQ_GAINS_2;\n\t\tif (snd_soc_component_read(component, WM8996_POWER_MANAGEMENT_8) &\n\t\t    WM8996_DSP2RX_SRC)\n\t\t\tiface = 1;\n\t\telse\n\t\t\tiface = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\t \n\tcfg = wm8996->retune_mobile_cfg[block];\n\tbest = 0;\n\tbest_val = INT_MAX;\n\tfor (i = 0; i < pdata->num_retune_mobile_cfgs; i++) {\n\t\tif (strcmp(pdata->retune_mobile_cfgs[i].name,\n\t\t\t   wm8996->retune_mobile_texts[cfg]) == 0 &&\n\t\t    abs(pdata->retune_mobile_cfgs[i].rate\n\t\t\t- wm8996->rx_rate[iface]) < best_val) {\n\t\t\tbest = i;\n\t\t\tbest_val = abs(pdata->retune_mobile_cfgs[i].rate\n\t\t\t\t       - wm8996->rx_rate[iface]);\n\t\t}\n\t}\n\n\tdev_dbg(component->dev, \"ReTune Mobile %d %s/%dHz for %dHz sample rate\\n\",\n\t\tblock,\n\t\tpdata->retune_mobile_cfgs[best].name,\n\t\tpdata->retune_mobile_cfgs[best].rate,\n\t\twm8996->rx_rate[iface]);\n\n\t \n\tsave = snd_soc_component_read(component, base);\n\tsave &= WM8996_DSP1RX_EQ_ENA;\n\n\tfor (i = 0; i < ARRAY_SIZE(pdata->retune_mobile_cfgs[best].regs); i++)\n\t\tsnd_soc_component_update_bits(component, base + i, 0xffff,\n\t\t\t\t    pdata->retune_mobile_cfgs[best].regs[i]);\n\n\tsnd_soc_component_update_bits(component, base, WM8996_DSP1RX_EQ_ENA, save);\n}\n\n \nstatic int wm8996_get_retune_mobile_block(const char *name)\n{\n\tif (strcmp(name, \"DSP1 EQ Mode\") == 0)\n\t\treturn 0;\n\tif (strcmp(name, \"DSP2 EQ Mode\") == 0)\n\t\treturn 1;\n\treturn -EINVAL;\n}\n\nstatic int wm8996_put_retune_mobile_enum(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tstruct wm8996_pdata *pdata = &wm8996->pdata;\n\tint block = wm8996_get_retune_mobile_block(kcontrol->id.name);\n\tint value = ucontrol->value.enumerated.item[0];\n\n\tif (block < 0)\n\t\treturn block;\n\n\tif (value >= pdata->num_retune_mobile_cfgs)\n\t\treturn -EINVAL;\n\n\twm8996->retune_mobile_cfg[block] = value;\n\n\twm8996_set_retune_mobile(component, block);\n\n\treturn 0;\n}\n\nstatic int wm8996_get_retune_mobile_enum(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint block = wm8996_get_retune_mobile_block(kcontrol->id.name);\n\n\tif (block < 0)\n\t\treturn block;\n\tucontrol->value.enumerated.item[0] = wm8996->retune_mobile_cfg[block];\n\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new wm8996_snd_controls[] = {\nSOC_DOUBLE_R_TLV(\"Capture Volume\", WM8996_LEFT_LINE_INPUT_VOLUME,\n\t\t WM8996_RIGHT_LINE_INPUT_VOLUME, 0, 31, 0, inpga_tlv),\nSOC_DOUBLE_R(\"Capture ZC Switch\", WM8996_LEFT_LINE_INPUT_VOLUME,\n\t     WM8996_RIGHT_LINE_INPUT_VOLUME, 5, 1, 0),\n\nSOC_DOUBLE_TLV(\"DAC1 Sidetone Volume\", WM8996_DAC1_MIXER_VOLUMES,\n\t       0, 5, 24, 0, sidetone_tlv),\nSOC_DOUBLE_TLV(\"DAC2 Sidetone Volume\", WM8996_DAC2_MIXER_VOLUMES,\n\t       0, 5, 24, 0, sidetone_tlv),\nSOC_SINGLE(\"Sidetone LPF Switch\", WM8996_SIDETONE, 12, 1, 0),\nSOC_ENUM(\"Sidetone HPF Cut-off\", sidetone_hpf),\nSOC_SINGLE(\"Sidetone HPF Switch\", WM8996_SIDETONE, 6, 1, 0),\n\nSOC_DOUBLE_R_TLV(\"DSP1 Capture Volume\", WM8996_DSP1_TX_LEFT_VOLUME,\n\t\t WM8996_DSP1_TX_RIGHT_VOLUME, 1, 96, 0, digital_tlv),\nSOC_DOUBLE_R_TLV(\"DSP2 Capture Volume\", WM8996_DSP2_TX_LEFT_VOLUME,\n\t\t WM8996_DSP2_TX_RIGHT_VOLUME, 1, 96, 0, digital_tlv),\n\nSOC_SINGLE(\"DSP1 Capture Notch Filter Switch\", WM8996_DSP1_TX_FILTERS,\n\t   13, 1, 0),\nSOC_DOUBLE(\"DSP1 Capture HPF Switch\", WM8996_DSP1_TX_FILTERS, 12, 11, 1, 0),\nSOC_ENUM(\"DSP1 Capture HPF Mode\", dsp1tx_hpf_mode),\nSOC_ENUM(\"DSP1 Capture HPF Cutoff\", dsp1tx_hpf_cutoff),\n\nSOC_SINGLE(\"DSP2 Capture Notch Filter Switch\", WM8996_DSP2_TX_FILTERS,\n\t   13, 1, 0),\nSOC_DOUBLE(\"DSP2 Capture HPF Switch\", WM8996_DSP2_TX_FILTERS, 12, 11, 1, 0),\nSOC_ENUM(\"DSP2 Capture HPF Mode\", dsp2tx_hpf_mode),\nSOC_ENUM(\"DSP2 Capture HPF Cutoff\", dsp2tx_hpf_cutoff),\n\nSOC_DOUBLE_R_TLV(\"DSP1 Playback Volume\", WM8996_DSP1_RX_LEFT_VOLUME,\n\t\t WM8996_DSP1_RX_RIGHT_VOLUME, 1, 112, 0, digital_tlv),\nSOC_SINGLE(\"DSP1 Playback Switch\", WM8996_DSP1_RX_FILTERS_1, 9, 1, 1),\n\nSOC_DOUBLE_R_TLV(\"DSP2 Playback Volume\", WM8996_DSP2_RX_LEFT_VOLUME,\n\t\t WM8996_DSP2_RX_RIGHT_VOLUME, 1, 112, 0, digital_tlv),\nSOC_SINGLE(\"DSP2 Playback Switch\", WM8996_DSP2_RX_FILTERS_1, 9, 1, 1),\n\nSOC_DOUBLE_R_TLV(\"DAC1 Volume\", WM8996_DAC1_LEFT_VOLUME,\n\t\t WM8996_DAC1_RIGHT_VOLUME, 1, 112, 0, digital_tlv),\nSOC_DOUBLE_R(\"DAC1 Switch\", WM8996_DAC1_LEFT_VOLUME,\n\t     WM8996_DAC1_RIGHT_VOLUME, 9, 1, 1),\n\nSOC_DOUBLE_R_TLV(\"DAC2 Volume\", WM8996_DAC2_LEFT_VOLUME,\n\t\t WM8996_DAC2_RIGHT_VOLUME, 1, 112, 0, digital_tlv),\nSOC_DOUBLE_R(\"DAC2 Switch\", WM8996_DAC2_LEFT_VOLUME,\n\t     WM8996_DAC2_RIGHT_VOLUME, 9, 1, 1),\n\nSOC_SINGLE(\"Speaker High Performance Switch\", WM8996_OVERSAMPLING, 3, 1, 0),\nSOC_SINGLE(\"DMIC High Performance Switch\", WM8996_OVERSAMPLING, 2, 1, 0),\nSOC_SINGLE(\"ADC High Performance Switch\", WM8996_OVERSAMPLING, 1, 1, 0),\nSOC_SINGLE(\"DAC High Performance Switch\", WM8996_OVERSAMPLING, 0, 1, 0),\n\nSOC_SINGLE(\"DAC Soft Mute Switch\", WM8996_DAC_SOFTMUTE, 1, 1, 0),\nSOC_SINGLE(\"DAC Slow Soft Mute Switch\", WM8996_DAC_SOFTMUTE, 0, 1, 0),\n\nSOC_SINGLE(\"DSP1 3D Stereo Switch\", WM8996_DSP1_RX_FILTERS_2, 8, 1, 0),\nSOC_SINGLE(\"DSP2 3D Stereo Switch\", WM8996_DSP2_RX_FILTERS_2, 8, 1, 0),\n\nSOC_SINGLE_TLV(\"DSP1 3D Stereo Volume\", WM8996_DSP1_RX_FILTERS_2, 10, 15,\n\t\t0, threedstereo_tlv),\nSOC_SINGLE_TLV(\"DSP2 3D Stereo Volume\", WM8996_DSP2_RX_FILTERS_2, 10, 15,\n\t\t0, threedstereo_tlv),\n\nSOC_DOUBLE_TLV(\"Digital Output 1 Volume\", WM8996_DAC1_HPOUT1_VOLUME, 0, 4,\n\t       8, 0, out_digital_tlv),\nSOC_DOUBLE_TLV(\"Digital Output 2 Volume\", WM8996_DAC2_HPOUT2_VOLUME, 0, 4,\n\t       8, 0, out_digital_tlv),\n\nSOC_DOUBLE_R_TLV(\"Output 1 Volume\", WM8996_OUTPUT1_LEFT_VOLUME,\n\t\t WM8996_OUTPUT1_RIGHT_VOLUME, 0, 12, 0, out_tlv),\nSOC_DOUBLE_R(\"Output 1 ZC Switch\",  WM8996_OUTPUT1_LEFT_VOLUME,\n\t     WM8996_OUTPUT1_RIGHT_VOLUME, 7, 1, 0),\n\nSOC_DOUBLE_R_TLV(\"Output 2 Volume\", WM8996_OUTPUT2_LEFT_VOLUME,\n\t\t WM8996_OUTPUT2_RIGHT_VOLUME, 0, 12, 0, out_tlv),\nSOC_DOUBLE_R(\"Output 2 ZC Switch\",  WM8996_OUTPUT2_LEFT_VOLUME,\n\t     WM8996_OUTPUT2_RIGHT_VOLUME, 7, 1, 0),\n\nSOC_DOUBLE_TLV(\"Speaker Volume\", WM8996_PDM_SPEAKER_VOLUME, 0, 4, 8, 0,\n\t       spk_tlv),\nSOC_DOUBLE_R(\"Speaker Switch\", WM8996_LEFT_PDM_SPEAKER,\n\t     WM8996_RIGHT_PDM_SPEAKER, 3, 1, 1),\nSOC_DOUBLE_R(\"Speaker ZC Switch\", WM8996_LEFT_PDM_SPEAKER,\n\t     WM8996_RIGHT_PDM_SPEAKER, 2, 1, 0),\n\nSOC_SINGLE(\"DSP1 EQ Switch\", WM8996_DSP1_RX_EQ_GAINS_1, 0, 1, 0),\nSOC_SINGLE(\"DSP2 EQ Switch\", WM8996_DSP2_RX_EQ_GAINS_1, 0, 1, 0),\n\nSOC_SINGLE(\"DSP1 DRC TXL Switch\", WM8996_DSP1_DRC_1, 0, 1, 0),\nSOC_SINGLE(\"DSP1 DRC TXR Switch\", WM8996_DSP1_DRC_1, 1, 1, 0),\nSOC_SINGLE(\"DSP1 DRC RX Switch\", WM8996_DSP1_DRC_1, 2, 1, 0),\nSND_SOC_BYTES_MASK(\"DSP1 DRC\", WM8996_DSP1_DRC_1, 5,\n\t\t   WM8996_DSP1RX_DRC_ENA | WM8996_DSP1TXL_DRC_ENA |\n\t\t   WM8996_DSP1TXR_DRC_ENA),\n\nSOC_SINGLE(\"DSP2 DRC TXL Switch\", WM8996_DSP2_DRC_1, 0, 1, 0),\nSOC_SINGLE(\"DSP2 DRC TXR Switch\", WM8996_DSP2_DRC_1, 1, 1, 0),\nSOC_SINGLE(\"DSP2 DRC RX Switch\", WM8996_DSP2_DRC_1, 2, 1, 0),\nSND_SOC_BYTES_MASK(\"DSP2 DRC\", WM8996_DSP2_DRC_1, 5,\n\t\t   WM8996_DSP2RX_DRC_ENA | WM8996_DSP2TXL_DRC_ENA |\n\t\t   WM8996_DSP2TXR_DRC_ENA),\n};\n\nstatic const struct snd_kcontrol_new wm8996_eq_controls[] = {\nSOC_SINGLE_TLV(\"DSP1 EQ B1 Volume\", WM8996_DSP1_RX_EQ_GAINS_1, 11, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP1 EQ B2 Volume\", WM8996_DSP1_RX_EQ_GAINS_1, 6, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP1 EQ B3 Volume\", WM8996_DSP1_RX_EQ_GAINS_1, 1, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP1 EQ B4 Volume\", WM8996_DSP1_RX_EQ_GAINS_2, 11, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP1 EQ B5 Volume\", WM8996_DSP1_RX_EQ_GAINS_2, 6, 31, 0,\n\t       eq_tlv),\n\nSOC_SINGLE_TLV(\"DSP2 EQ B1 Volume\", WM8996_DSP2_RX_EQ_GAINS_1, 11, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP2 EQ B2 Volume\", WM8996_DSP2_RX_EQ_GAINS_1, 6, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP2 EQ B3 Volume\", WM8996_DSP2_RX_EQ_GAINS_1, 1, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP2 EQ B4 Volume\", WM8996_DSP2_RX_EQ_GAINS_2, 11, 31, 0,\n\t       eq_tlv),\nSOC_SINGLE_TLV(\"DSP2 EQ B5 Volume\", WM8996_DSP2_RX_EQ_GAINS_2, 6, 31, 0,\n\t       eq_tlv),\n};\n\nstatic void wm8996_bg_enable(struct snd_soc_component *component)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\n\twm8996->bg_ena++;\n\tif (wm8996->bg_ena == 1) {\n\t\tsnd_soc_component_update_bits(component, WM8996_POWER_MANAGEMENT_1,\n\t\t\t\t    WM8996_BG_ENA, WM8996_BG_ENA);\n\t\tmsleep(2);\n\t}\n}\n\nstatic void wm8996_bg_disable(struct snd_soc_component *component)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\n\twm8996->bg_ena--;\n\tif (!wm8996->bg_ena)\n\t\tsnd_soc_component_update_bits(component, WM8996_POWER_MANAGEMENT_1,\n\t\t\t\t    WM8996_BG_ENA, 0);\n}\n\nstatic int bg_event(struct snd_soc_dapm_widget *w,\n\t\t    struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tint ret = 0;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\twm8996_bg_enable(component);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\twm8996_bg_disable(component);\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid event %d\\n\", event);\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic int cp_event(struct snd_soc_dapm_widget *w,\n\t\t    struct snd_kcontrol *kcontrol, int event)\n{\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tmsleep(5);\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid event %d\\n\", event);\n\t}\n\n\treturn 0;\n}\n\nstatic int rmv_short_event(struct snd_soc_dapm_widget *w,\n\t\t\t   struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\n\t \n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\twm8996->hpout_pending &= ~w->shift;\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\twm8996->hpout_pending |= w->shift;\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid event %d\\n\", event);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void wait_for_dc_servo(struct snd_soc_component *component, u16 mask)\n{\n\tstruct i2c_client *i2c = to_i2c_client(component->dev);\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\tunsigned long timeout = 200;\n\n\tsnd_soc_component_write(component, WM8996_DC_SERVO_2, mask);\n\n\t \n\tdo {\n\t\tif (i2c->irq) {\n\t\t\ttimeout = wait_for_completion_timeout(&wm8996->dcs_done,\n\t\t\t\t\t\t\t      msecs_to_jiffies(200));\n\t\t\tif (timeout == 0)\n\t\t\t\tdev_err(component->dev, \"DC servo timed out\\n\");\n\n\t\t} else {\n\t\t\tmsleep(1);\n\t\t\ttimeout--;\n\t\t}\n\n\t\tret = snd_soc_component_read(component, WM8996_DC_SERVO_2);\n\t\tdev_dbg(component->dev, \"DC servo state: %x\\n\", ret);\n\t} while (timeout && ret & mask);\n\n\tif (timeout == 0)\n\t\tdev_err(component->dev, \"DC servo timed out for %x\\n\", mask);\n\telse\n\t\tdev_dbg(component->dev, \"DC servo complete for %x\\n\", mask);\n}\n\nstatic void wm8996_seq_notifier(struct snd_soc_component *component,\n\t\t\t\tenum snd_soc_dapm_type event, int subseq)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tu16 val, mask;\n\n\t \n\tif (wm8996->dcs_pending) {\n\t\tdev_dbg(component->dev, \"Starting DC servo for %x\\n\",\n\t\t\twm8996->dcs_pending);\n\n\t\t \n\t\twait_for_dc_servo(component, wm8996->dcs_pending\n\t\t\t\t         << WM8996_DCS_TRIG_STARTUP_0_SHIFT);\n\n\t\twm8996->dcs_pending = 0;\n\t}\n\n\tif (wm8996->hpout_pending != wm8996->hpout_ena) {\n\t\tdev_dbg(component->dev, \"Applying RMV_SHORTs %x->%x\\n\",\n\t\t\twm8996->hpout_ena, wm8996->hpout_pending);\n\n\t\tval = 0;\n\t\tmask = 0;\n\t\tif (wm8996->hpout_pending & HPOUT1L) {\n\t\t\tval |= WM8996_HPOUT1L_RMV_SHORT | WM8996_HPOUT1L_OUTP;\n\t\t\tmask |= WM8996_HPOUT1L_RMV_SHORT | WM8996_HPOUT1L_OUTP;\n\t\t} else {\n\t\t\tmask |= WM8996_HPOUT1L_RMV_SHORT |\n\t\t\t\tWM8996_HPOUT1L_OUTP |\n\t\t\t\tWM8996_HPOUT1L_DLY;\n\t\t}\n\n\t\tif (wm8996->hpout_pending & HPOUT1R) {\n\t\t\tval |= WM8996_HPOUT1R_RMV_SHORT | WM8996_HPOUT1R_OUTP;\n\t\t\tmask |= WM8996_HPOUT1R_RMV_SHORT | WM8996_HPOUT1R_OUTP;\n\t\t} else {\n\t\t\tmask |= WM8996_HPOUT1R_RMV_SHORT |\n\t\t\t\tWM8996_HPOUT1R_OUTP |\n\t\t\t\tWM8996_HPOUT1R_DLY;\n\t\t}\n\n\t\tsnd_soc_component_update_bits(component, WM8996_ANALOGUE_HP_1, mask, val);\n\n\t\tval = 0;\n\t\tmask = 0;\n\t\tif (wm8996->hpout_pending & HPOUT2L) {\n\t\t\tval |= WM8996_HPOUT2L_RMV_SHORT | WM8996_HPOUT2L_OUTP;\n\t\t\tmask |= WM8996_HPOUT2L_RMV_SHORT | WM8996_HPOUT2L_OUTP;\n\t\t} else {\n\t\t\tmask |= WM8996_HPOUT2L_RMV_SHORT |\n\t\t\t\tWM8996_HPOUT2L_OUTP |\n\t\t\t\tWM8996_HPOUT2L_DLY;\n\t\t}\n\n\t\tif (wm8996->hpout_pending & HPOUT2R) {\n\t\t\tval |= WM8996_HPOUT2R_RMV_SHORT | WM8996_HPOUT2R_OUTP;\n\t\t\tmask |= WM8996_HPOUT2R_RMV_SHORT | WM8996_HPOUT2R_OUTP;\n\t\t} else {\n\t\t\tmask |= WM8996_HPOUT2R_RMV_SHORT |\n\t\t\t\tWM8996_HPOUT2R_OUTP |\n\t\t\t\tWM8996_HPOUT2R_DLY;\n\t\t}\n\n\t\tsnd_soc_component_update_bits(component, WM8996_ANALOGUE_HP_2, mask, val);\n\n\t\twm8996->hpout_ena = wm8996->hpout_pending;\n\t}\n}\n\nstatic int dcs_start(struct snd_soc_dapm_widget *w,\n\t\t     struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\twm8996->dcs_pending |= 1 << w->shift;\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid event %d\\n\", event);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const char *sidetone_text[] = {\n\t\"IN1\", \"IN2\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(left_sidetone_enum,\n\t\t\t    WM8996_SIDETONE, 0, sidetone_text);\n\nstatic const struct snd_kcontrol_new left_sidetone =\n\tSOC_DAPM_ENUM(\"Left Sidetone\", left_sidetone_enum);\n\nstatic SOC_ENUM_SINGLE_DECL(right_sidetone_enum,\n\t\t\t    WM8996_SIDETONE, 1, sidetone_text);\n\nstatic const struct snd_kcontrol_new right_sidetone =\n\tSOC_DAPM_ENUM(\"Right Sidetone\", right_sidetone_enum);\n\nstatic const char *spk_text[] = {\n\t\"DAC1L\", \"DAC1R\", \"DAC2L\", \"DAC2R\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(spkl_enum,\n\t\t\t    WM8996_LEFT_PDM_SPEAKER, 0, spk_text);\n\nstatic const struct snd_kcontrol_new spkl_mux =\n\tSOC_DAPM_ENUM(\"SPKL\", spkl_enum);\n\nstatic SOC_ENUM_SINGLE_DECL(spkr_enum,\n\t\t\t    WM8996_RIGHT_PDM_SPEAKER, 0, spk_text);\n\nstatic const struct snd_kcontrol_new spkr_mux =\n\tSOC_DAPM_ENUM(\"SPKR\", spkr_enum);\n\nstatic const char *dsp1rx_text[] = {\n\t\"AIF1\", \"AIF2\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(dsp1rx_enum,\n\t\t\t    WM8996_POWER_MANAGEMENT_8, 0, dsp1rx_text);\n\nstatic const struct snd_kcontrol_new dsp1rx =\n\tSOC_DAPM_ENUM(\"DSP1RX\", dsp1rx_enum);\n\nstatic const char *dsp2rx_text[] = {\n\t \"AIF2\", \"AIF1\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(dsp2rx_enum,\n\t\t\t    WM8996_POWER_MANAGEMENT_8, 4, dsp2rx_text);\n\nstatic const struct snd_kcontrol_new dsp2rx =\n\tSOC_DAPM_ENUM(\"DSP2RX\", dsp2rx_enum);\n\nstatic const char *aif2tx_text[] = {\n\t\"DSP2\", \"DSP1\", \"AIF1\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(aif2tx_enum,\n\t\t\t    WM8996_POWER_MANAGEMENT_8, 6, aif2tx_text);\n\nstatic const struct snd_kcontrol_new aif2tx =\n\tSOC_DAPM_ENUM(\"AIF2TX\", aif2tx_enum);\n\nstatic const char *inmux_text[] = {\n\t\"ADC\", \"DMIC1\", \"DMIC2\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(in1_enum,\n\t\t\t    WM8996_POWER_MANAGEMENT_7, 0, inmux_text);\n\nstatic const struct snd_kcontrol_new in1_mux =\n\tSOC_DAPM_ENUM(\"IN1 Mux\", in1_enum);\n\nstatic SOC_ENUM_SINGLE_DECL(in2_enum,\n\t\t\t    WM8996_POWER_MANAGEMENT_7, 4, inmux_text);\n\nstatic const struct snd_kcontrol_new in2_mux =\n\tSOC_DAPM_ENUM(\"IN2 Mux\", in2_enum);\n\nstatic const struct snd_kcontrol_new dac2r_mix[] = {\nSOC_DAPM_SINGLE(\"Right Sidetone Switch\", WM8996_DAC2_RIGHT_MIXER_ROUTING,\n\t\t5, 1, 0),\nSOC_DAPM_SINGLE(\"Left Sidetone Switch\", WM8996_DAC2_RIGHT_MIXER_ROUTING,\n\t\t4, 1, 0),\nSOC_DAPM_SINGLE(\"DSP2 Switch\", WM8996_DAC2_RIGHT_MIXER_ROUTING, 1, 1, 0),\nSOC_DAPM_SINGLE(\"DSP1 Switch\", WM8996_DAC2_RIGHT_MIXER_ROUTING, 0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dac2l_mix[] = {\nSOC_DAPM_SINGLE(\"Right Sidetone Switch\", WM8996_DAC2_LEFT_MIXER_ROUTING,\n\t\t5, 1, 0),\nSOC_DAPM_SINGLE(\"Left Sidetone Switch\", WM8996_DAC2_LEFT_MIXER_ROUTING,\n\t\t4, 1, 0),\nSOC_DAPM_SINGLE(\"DSP2 Switch\", WM8996_DAC2_LEFT_MIXER_ROUTING, 1, 1, 0),\nSOC_DAPM_SINGLE(\"DSP1 Switch\", WM8996_DAC2_LEFT_MIXER_ROUTING, 0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dac1r_mix[] = {\nSOC_DAPM_SINGLE(\"Right Sidetone Switch\", WM8996_DAC1_RIGHT_MIXER_ROUTING,\n\t\t5, 1, 0),\nSOC_DAPM_SINGLE(\"Left Sidetone Switch\", WM8996_DAC1_RIGHT_MIXER_ROUTING,\n\t\t4, 1, 0),\nSOC_DAPM_SINGLE(\"DSP2 Switch\", WM8996_DAC1_RIGHT_MIXER_ROUTING, 1, 1, 0),\nSOC_DAPM_SINGLE(\"DSP1 Switch\", WM8996_DAC1_RIGHT_MIXER_ROUTING, 0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dac1l_mix[] = {\nSOC_DAPM_SINGLE(\"Right Sidetone Switch\", WM8996_DAC1_LEFT_MIXER_ROUTING,\n\t\t5, 1, 0),\nSOC_DAPM_SINGLE(\"Left Sidetone Switch\", WM8996_DAC1_LEFT_MIXER_ROUTING,\n\t\t4, 1, 0),\nSOC_DAPM_SINGLE(\"DSP2 Switch\", WM8996_DAC1_LEFT_MIXER_ROUTING, 1, 1, 0),\nSOC_DAPM_SINGLE(\"DSP1 Switch\", WM8996_DAC1_LEFT_MIXER_ROUTING, 0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dsp1txl[] = {\nSOC_DAPM_SINGLE(\"IN1 Switch\", WM8996_DSP1_TX_LEFT_MIXER_ROUTING,\n\t\t1, 1, 0),\nSOC_DAPM_SINGLE(\"DAC Switch\", WM8996_DSP1_TX_LEFT_MIXER_ROUTING,\n\t\t0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dsp1txr[] = {\nSOC_DAPM_SINGLE(\"IN1 Switch\", WM8996_DSP1_TX_RIGHT_MIXER_ROUTING,\n\t\t1, 1, 0),\nSOC_DAPM_SINGLE(\"DAC Switch\", WM8996_DSP1_TX_RIGHT_MIXER_ROUTING,\n\t\t0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dsp2txl[] = {\nSOC_DAPM_SINGLE(\"IN1 Switch\", WM8996_DSP2_TX_LEFT_MIXER_ROUTING,\n\t\t1, 1, 0),\nSOC_DAPM_SINGLE(\"DAC Switch\", WM8996_DSP2_TX_LEFT_MIXER_ROUTING,\n\t\t0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new dsp2txr[] = {\nSOC_DAPM_SINGLE(\"IN1 Switch\", WM8996_DSP2_TX_RIGHT_MIXER_ROUTING,\n\t\t1, 1, 0),\nSOC_DAPM_SINGLE(\"DAC Switch\", WM8996_DSP2_TX_RIGHT_MIXER_ROUTING,\n\t\t0, 1, 0),\n};\n\n\nstatic const struct snd_soc_dapm_widget wm8996_dapm_widgets[] = {\nSND_SOC_DAPM_INPUT(\"IN1LN\"),\nSND_SOC_DAPM_INPUT(\"IN1LP\"),\nSND_SOC_DAPM_INPUT(\"IN1RN\"),\nSND_SOC_DAPM_INPUT(\"IN1RP\"),\n\nSND_SOC_DAPM_INPUT(\"IN2LN\"),\nSND_SOC_DAPM_INPUT(\"IN2LP\"),\nSND_SOC_DAPM_INPUT(\"IN2RN\"),\nSND_SOC_DAPM_INPUT(\"IN2RP\"),\n\nSND_SOC_DAPM_INPUT(\"DMIC1DAT\"),\nSND_SOC_DAPM_INPUT(\"DMIC2DAT\"),\n\nSND_SOC_DAPM_REGULATOR_SUPPLY(\"CPVDD\", 20, 0),\nSND_SOC_DAPM_SUPPLY_S(\"SYSCLK\", 1, WM8996_AIF_CLOCKING_1, 0, 0, NULL, 0),\nSND_SOC_DAPM_SUPPLY_S(\"SYSDSPCLK\", 2, WM8996_CLOCKING_1, 1, 0, NULL, 0),\nSND_SOC_DAPM_SUPPLY_S(\"AIFCLK\", 2, WM8996_CLOCKING_1, 2, 0, NULL, 0),\nSND_SOC_DAPM_SUPPLY_S(\"Charge Pump\", 2, WM8996_CHARGE_PUMP_1, 15, 0, cp_event,\n\t\t      SND_SOC_DAPM_POST_PMU),\nSND_SOC_DAPM_SUPPLY(\"Bandgap\", SND_SOC_NOPM, 0, 0, bg_event,\n\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\nSND_SOC_DAPM_SUPPLY(\"LDO2\", WM8996_POWER_MANAGEMENT_2, 1, 0, NULL, 0),\nSND_SOC_DAPM_SUPPLY(\"MICB1 Audio\", WM8996_MICBIAS_1, 4, 1, NULL, 0),\nSND_SOC_DAPM_SUPPLY(\"MICB2 Audio\", WM8996_MICBIAS_2, 4, 1, NULL, 0),\nSND_SOC_DAPM_MICBIAS(\"MICB2\", WM8996_POWER_MANAGEMENT_1, 9, 0),\nSND_SOC_DAPM_MICBIAS(\"MICB1\", WM8996_POWER_MANAGEMENT_1, 8, 0),\n\nSND_SOC_DAPM_PGA(\"IN1L PGA\", WM8996_POWER_MANAGEMENT_2, 5, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"IN1R PGA\", WM8996_POWER_MANAGEMENT_2, 4, 0, NULL, 0),\n\nSND_SOC_DAPM_MUX(\"IN1L Mux\", WM8996_POWER_MANAGEMENT_7, 2, 0, &in1_mux),\nSND_SOC_DAPM_MUX(\"IN1R Mux\", WM8996_POWER_MANAGEMENT_7, 3, 0, &in1_mux),\nSND_SOC_DAPM_MUX(\"IN2L Mux\", WM8996_POWER_MANAGEMENT_7, 6, 0, &in2_mux),\nSND_SOC_DAPM_MUX(\"IN2R Mux\", WM8996_POWER_MANAGEMENT_7, 7, 0, &in2_mux),\n\nSND_SOC_DAPM_SUPPLY(\"DMIC2\", WM8996_POWER_MANAGEMENT_7, 9, 0, NULL, 0),\nSND_SOC_DAPM_SUPPLY(\"DMIC1\", WM8996_POWER_MANAGEMENT_7, 8, 0, NULL, 0),\n\nSND_SOC_DAPM_ADC(\"DMIC2L\", NULL, WM8996_POWER_MANAGEMENT_3, 5, 0),\nSND_SOC_DAPM_ADC(\"DMIC2R\", NULL, WM8996_POWER_MANAGEMENT_3, 4, 0),\nSND_SOC_DAPM_ADC(\"DMIC1L\", NULL, WM8996_POWER_MANAGEMENT_3, 3, 0),\nSND_SOC_DAPM_ADC(\"DMIC1R\", NULL, WM8996_POWER_MANAGEMENT_3, 2, 0),\n\nSND_SOC_DAPM_ADC(\"ADCL\", NULL, WM8996_POWER_MANAGEMENT_3, 1, 0),\nSND_SOC_DAPM_ADC(\"ADCR\", NULL, WM8996_POWER_MANAGEMENT_3, 0, 0),\n\nSND_SOC_DAPM_MUX(\"Left Sidetone\", SND_SOC_NOPM, 0, 0, &left_sidetone),\nSND_SOC_DAPM_MUX(\"Right Sidetone\", SND_SOC_NOPM, 0, 0, &right_sidetone),\n\nSND_SOC_DAPM_AIF_IN(\"DSP2RXL\", NULL, 0, WM8996_POWER_MANAGEMENT_3, 11, 0),\nSND_SOC_DAPM_AIF_IN(\"DSP2RXR\", NULL, 1, WM8996_POWER_MANAGEMENT_3, 10, 0),\nSND_SOC_DAPM_AIF_IN(\"DSP1RXL\", NULL, 0, WM8996_POWER_MANAGEMENT_3, 9, 0),\nSND_SOC_DAPM_AIF_IN(\"DSP1RXR\", NULL, 1, WM8996_POWER_MANAGEMENT_3, 8, 0),\n\nSND_SOC_DAPM_MIXER(\"DSP2TXL\", WM8996_POWER_MANAGEMENT_5, 11, 0,\n\t\t   dsp2txl, ARRAY_SIZE(dsp2txl)),\nSND_SOC_DAPM_MIXER(\"DSP2TXR\", WM8996_POWER_MANAGEMENT_5, 10, 0,\n\t\t   dsp2txr, ARRAY_SIZE(dsp2txr)),\nSND_SOC_DAPM_MIXER(\"DSP1TXL\", WM8996_POWER_MANAGEMENT_5, 9, 0,\n\t\t   dsp1txl, ARRAY_SIZE(dsp1txl)),\nSND_SOC_DAPM_MIXER(\"DSP1TXR\", WM8996_POWER_MANAGEMENT_5, 8, 0,\n\t\t   dsp1txr, ARRAY_SIZE(dsp1txr)),\n\nSND_SOC_DAPM_MIXER(\"DAC2L Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t   dac2l_mix, ARRAY_SIZE(dac2l_mix)),\nSND_SOC_DAPM_MIXER(\"DAC2R Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t   dac2r_mix, ARRAY_SIZE(dac2r_mix)),\nSND_SOC_DAPM_MIXER(\"DAC1L Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t   dac1l_mix, ARRAY_SIZE(dac1l_mix)),\nSND_SOC_DAPM_MIXER(\"DAC1R Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t   dac1r_mix, ARRAY_SIZE(dac1r_mix)),\n\nSND_SOC_DAPM_DAC(\"DAC2L\", NULL, WM8996_POWER_MANAGEMENT_5, 3, 0),\nSND_SOC_DAPM_DAC(\"DAC2R\", NULL, WM8996_POWER_MANAGEMENT_5, 2, 0),\nSND_SOC_DAPM_DAC(\"DAC1L\", NULL, WM8996_POWER_MANAGEMENT_5, 1, 0),\nSND_SOC_DAPM_DAC(\"DAC1R\", NULL, WM8996_POWER_MANAGEMENT_5, 0, 0),\n\nSND_SOC_DAPM_AIF_IN(\"AIF2RX1\", NULL, 0, WM8996_POWER_MANAGEMENT_4, 9, 0),\nSND_SOC_DAPM_AIF_IN(\"AIF2RX0\", NULL, 1, WM8996_POWER_MANAGEMENT_4, 8, 0),\n\nSND_SOC_DAPM_AIF_OUT(\"AIF2TX1\", NULL, 0, WM8996_POWER_MANAGEMENT_6, 9, 0),\nSND_SOC_DAPM_AIF_OUT(\"AIF2TX0\", NULL, 1, WM8996_POWER_MANAGEMENT_6, 8, 0),\n\nSND_SOC_DAPM_AIF_IN(\"AIF1RX5\", NULL, 5, WM8996_POWER_MANAGEMENT_4, 5, 0),\nSND_SOC_DAPM_AIF_IN(\"AIF1RX4\", NULL, 4, WM8996_POWER_MANAGEMENT_4, 4, 0),\nSND_SOC_DAPM_AIF_IN(\"AIF1RX3\", NULL, 3, WM8996_POWER_MANAGEMENT_4, 3, 0),\nSND_SOC_DAPM_AIF_IN(\"AIF1RX2\", NULL, 2, WM8996_POWER_MANAGEMENT_4, 2, 0),\nSND_SOC_DAPM_AIF_IN(\"AIF1RX1\", NULL, 1, WM8996_POWER_MANAGEMENT_4, 1, 0),\nSND_SOC_DAPM_AIF_IN(\"AIF1RX0\", NULL, 0, WM8996_POWER_MANAGEMENT_4, 0, 0),\n\nSND_SOC_DAPM_AIF_OUT(\"AIF1TX5\", NULL, 5, WM8996_POWER_MANAGEMENT_6, 5, 0),\nSND_SOC_DAPM_AIF_OUT(\"AIF1TX4\", NULL, 4, WM8996_POWER_MANAGEMENT_6, 4, 0),\nSND_SOC_DAPM_AIF_OUT(\"AIF1TX3\", NULL, 3, WM8996_POWER_MANAGEMENT_6, 3, 0),\nSND_SOC_DAPM_AIF_OUT(\"AIF1TX2\", NULL, 2, WM8996_POWER_MANAGEMENT_6, 2, 0),\nSND_SOC_DAPM_AIF_OUT(\"AIF1TX1\", NULL, 1, WM8996_POWER_MANAGEMENT_6, 1, 0),\nSND_SOC_DAPM_AIF_OUT(\"AIF1TX0\", NULL, 0, WM8996_POWER_MANAGEMENT_6, 0, 0),\n\n \nSND_SOC_DAPM_PGA(\"AIF1RXA\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"AIF1RXB\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"AIF1RXC\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"AIF2RX\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"DSP2TX\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\nSND_SOC_DAPM_MUX(\"DSP1RX\", SND_SOC_NOPM, 0, 0, &dsp1rx),\nSND_SOC_DAPM_MUX(\"DSP2RX\", SND_SOC_NOPM, 0, 0, &dsp2rx),\nSND_SOC_DAPM_MUX(\"AIF2TX\", SND_SOC_NOPM, 0, 0, &aif2tx),\n\nSND_SOC_DAPM_MUX(\"SPKL\", SND_SOC_NOPM, 0, 0, &spkl_mux),\nSND_SOC_DAPM_MUX(\"SPKR\", SND_SOC_NOPM, 0, 0, &spkr_mux),\nSND_SOC_DAPM_PGA(\"SPKL PGA\", WM8996_LEFT_PDM_SPEAKER, 4, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"SPKR PGA\", WM8996_RIGHT_PDM_SPEAKER, 4, 0, NULL, 0),\n\nSND_SOC_DAPM_PGA_S(\"HPOUT2L PGA\", 0, WM8996_POWER_MANAGEMENT_1, 7, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT2L_DLY\", 1, WM8996_ANALOGUE_HP_2, 5, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT2L_DCS\", 2, WM8996_DC_SERVO_1, 2, 0, dcs_start,\n\t\t   SND_SOC_DAPM_POST_PMU),\nSND_SOC_DAPM_PGA_S(\"HPOUT2L_RMV_SHORT\", 3, SND_SOC_NOPM, HPOUT2L, 0,\n\t\t   rmv_short_event,\n\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),\n\nSND_SOC_DAPM_PGA_S(\"HPOUT2R PGA\", 0, WM8996_POWER_MANAGEMENT_1, 6, 0,NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT2R_DLY\", 1, WM8996_ANALOGUE_HP_2, 1, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT2R_DCS\", 2, WM8996_DC_SERVO_1, 3, 0, dcs_start,\n\t\t   SND_SOC_DAPM_POST_PMU),\nSND_SOC_DAPM_PGA_S(\"HPOUT2R_RMV_SHORT\", 3, SND_SOC_NOPM, HPOUT2R, 0,\n\t\t   rmv_short_event,\n\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),\n\nSND_SOC_DAPM_PGA_S(\"HPOUT1L PGA\", 0, WM8996_POWER_MANAGEMENT_1, 5, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT1L_DLY\", 1, WM8996_ANALOGUE_HP_1, 5, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT1L_DCS\", 2, WM8996_DC_SERVO_1, 0, 0, dcs_start,\n\t\t   SND_SOC_DAPM_POST_PMU),\nSND_SOC_DAPM_PGA_S(\"HPOUT1L_RMV_SHORT\", 3, SND_SOC_NOPM, HPOUT1L, 0,\n\t\t   rmv_short_event,\n\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),\n\nSND_SOC_DAPM_PGA_S(\"HPOUT1R PGA\", 0, WM8996_POWER_MANAGEMENT_1, 4, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT1R_DLY\", 1, WM8996_ANALOGUE_HP_1, 1, 0, NULL, 0),\nSND_SOC_DAPM_PGA_S(\"HPOUT1R_DCS\", 2, WM8996_DC_SERVO_1, 1, 0, dcs_start,\n\t\t   SND_SOC_DAPM_POST_PMU),\nSND_SOC_DAPM_PGA_S(\"HPOUT1R_RMV_SHORT\", 3, SND_SOC_NOPM, HPOUT1R, 0,\n\t\t   rmv_short_event,\n\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),\n\nSND_SOC_DAPM_OUTPUT(\"HPOUT1L\"),\nSND_SOC_DAPM_OUTPUT(\"HPOUT1R\"),\nSND_SOC_DAPM_OUTPUT(\"HPOUT2L\"),\nSND_SOC_DAPM_OUTPUT(\"HPOUT2R\"),\nSND_SOC_DAPM_OUTPUT(\"SPKDAT\"),\n};\n\nstatic const struct snd_soc_dapm_route wm8996_dapm_routes[] = {\n\t{ \"AIFCLK\", NULL, \"SYSCLK\" },\n\t{ \"SYSDSPCLK\", NULL, \"SYSCLK\" },\n\t{ \"Charge Pump\", NULL, \"SYSCLK\" },\n\t{ \"Charge Pump\", NULL, \"CPVDD\" },\n\n\t{ \"MICB1\", NULL, \"LDO2\" },\n\t{ \"MICB1\", NULL, \"MICB1 Audio\" },\n\t{ \"MICB1\", NULL, \"Bandgap\" },\n\t{ \"MICB2\", NULL, \"LDO2\" },\n\t{ \"MICB2\", NULL, \"MICB2 Audio\" },\n\t{ \"MICB2\", NULL, \"Bandgap\" },\n\n\t{ \"AIF1RX0\", NULL, \"AIF1 Playback\" },\n\t{ \"AIF1RX1\", NULL, \"AIF1 Playback\" },\n\t{ \"AIF1RX2\", NULL, \"AIF1 Playback\" },\n\t{ \"AIF1RX3\", NULL, \"AIF1 Playback\" },\n\t{ \"AIF1RX4\", NULL, \"AIF1 Playback\" },\n\t{ \"AIF1RX5\", NULL, \"AIF1 Playback\" },\n\n\t{ \"AIF2RX0\", NULL, \"AIF2 Playback\" },\n\t{ \"AIF2RX1\", NULL, \"AIF2 Playback\" },\n\n\t{ \"AIF1 Capture\", NULL, \"AIF1TX0\" },\n\t{ \"AIF1 Capture\", NULL, \"AIF1TX1\" },\n\t{ \"AIF1 Capture\", NULL, \"AIF1TX2\" },\n\t{ \"AIF1 Capture\", NULL, \"AIF1TX3\" },\n\t{ \"AIF1 Capture\", NULL, \"AIF1TX4\" },\n\t{ \"AIF1 Capture\", NULL, \"AIF1TX5\" },\n\n\t{ \"AIF2 Capture\", NULL, \"AIF2TX0\" },\n\t{ \"AIF2 Capture\", NULL, \"AIF2TX1\" },\n\n\t{ \"IN1L PGA\", NULL, \"IN2LN\" },\n\t{ \"IN1L PGA\", NULL, \"IN2LP\" },\n\t{ \"IN1L PGA\", NULL, \"IN1LN\" },\n\t{ \"IN1L PGA\", NULL, \"IN1LP\" },\n\t{ \"IN1L PGA\", NULL, \"Bandgap\" },\n\n\t{ \"IN1R PGA\", NULL, \"IN2RN\" },\n\t{ \"IN1R PGA\", NULL, \"IN2RP\" },\n\t{ \"IN1R PGA\", NULL, \"IN1RN\" },\n\t{ \"IN1R PGA\", NULL, \"IN1RP\" },\n\t{ \"IN1R PGA\", NULL, \"Bandgap\" },\n\n\t{ \"ADCL\", NULL, \"IN1L PGA\" },\n\n\t{ \"ADCR\", NULL, \"IN1R PGA\" },\n\n\t{ \"DMIC1L\", NULL, \"DMIC1DAT\" },\n\t{ \"DMIC1R\", NULL, \"DMIC1DAT\" },\n\t{ \"DMIC2L\", NULL, \"DMIC2DAT\" },\n\t{ \"DMIC2R\", NULL, \"DMIC2DAT\" },\n\n\t{ \"DMIC2L\", NULL, \"DMIC2\" },\n\t{ \"DMIC2R\", NULL, \"DMIC2\" },\n\t{ \"DMIC1L\", NULL, \"DMIC1\" },\n\t{ \"DMIC1R\", NULL, \"DMIC1\" },\n\n\t{ \"IN1L Mux\", \"ADC\", \"ADCL\" },\n\t{ \"IN1L Mux\", \"DMIC1\", \"DMIC1L\" },\n\t{ \"IN1L Mux\", \"DMIC2\", \"DMIC2L\" },\n\n\t{ \"IN1R Mux\", \"ADC\", \"ADCR\" },\n\t{ \"IN1R Mux\", \"DMIC1\", \"DMIC1R\" },\n\t{ \"IN1R Mux\", \"DMIC2\", \"DMIC2R\" },\n\n\t{ \"IN2L Mux\", \"ADC\", \"ADCL\" },\n\t{ \"IN2L Mux\", \"DMIC1\", \"DMIC1L\" },\n\t{ \"IN2L Mux\", \"DMIC2\", \"DMIC2L\" },\n\n\t{ \"IN2R Mux\", \"ADC\", \"ADCR\" },\n\t{ \"IN2R Mux\", \"DMIC1\", \"DMIC1R\" },\n\t{ \"IN2R Mux\", \"DMIC2\", \"DMIC2R\" },\n\n\t{ \"Left Sidetone\", \"IN1\", \"IN1L Mux\" },\n\t{ \"Left Sidetone\", \"IN2\", \"IN2L Mux\" },\n\n\t{ \"Right Sidetone\", \"IN1\", \"IN1R Mux\" },\n\t{ \"Right Sidetone\", \"IN2\", \"IN2R Mux\" },\n\n\t{ \"DSP1TXL\", \"IN1 Switch\", \"IN1L Mux\" },\n\t{ \"DSP1TXR\", \"IN1 Switch\", \"IN1R Mux\" },\n\n\t{ \"DSP2TXL\", \"IN1 Switch\", \"IN2L Mux\" },\n\t{ \"DSP2TXR\", \"IN1 Switch\", \"IN2R Mux\" },\n\n\t{ \"AIF1TX0\", NULL, \"DSP1TXL\" },\n\t{ \"AIF1TX1\", NULL, \"DSP1TXR\" },\n\t{ \"AIF1TX2\", NULL, \"DSP2TXL\" },\n\t{ \"AIF1TX3\", NULL, \"DSP2TXR\" },\n\t{ \"AIF1TX4\", NULL, \"AIF2RX0\" },\n\t{ \"AIF1TX5\", NULL, \"AIF2RX1\" },\n\n\t{ \"AIF1RX0\", NULL, \"AIFCLK\" },\n\t{ \"AIF1RX1\", NULL, \"AIFCLK\" },\n\t{ \"AIF1RX2\", NULL, \"AIFCLK\" },\n\t{ \"AIF1RX3\", NULL, \"AIFCLK\" },\n\t{ \"AIF1RX4\", NULL, \"AIFCLK\" },\n\t{ \"AIF1RX5\", NULL, \"AIFCLK\" },\n\n\t{ \"AIF2RX0\", NULL, \"AIFCLK\" },\n\t{ \"AIF2RX1\", NULL, \"AIFCLK\" },\n\n\t{ \"AIF1TX0\", NULL, \"AIFCLK\" },\n\t{ \"AIF1TX1\", NULL, \"AIFCLK\" },\n\t{ \"AIF1TX2\", NULL, \"AIFCLK\" },\n\t{ \"AIF1TX3\", NULL, \"AIFCLK\" },\n\t{ \"AIF1TX4\", NULL, \"AIFCLK\" },\n\t{ \"AIF1TX5\", NULL, \"AIFCLK\" },\n\n\t{ \"AIF2TX0\", NULL, \"AIFCLK\" },\n\t{ \"AIF2TX1\", NULL, \"AIFCLK\" },\n\n\t{ \"DSP1RXL\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP1RXR\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP2RXL\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP2RXR\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP1TXL\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP1TXR\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP2TXL\", NULL, \"SYSDSPCLK\" },\n\t{ \"DSP2TXR\", NULL, \"SYSDSPCLK\" },\n\n\t{ \"AIF1RXA\", NULL, \"AIF1RX0\" },\n\t{ \"AIF1RXA\", NULL, \"AIF1RX1\" },\n\t{ \"AIF1RXB\", NULL, \"AIF1RX2\" },\n\t{ \"AIF1RXB\", NULL, \"AIF1RX3\" },\n\t{ \"AIF1RXC\", NULL, \"AIF1RX4\" },\n\t{ \"AIF1RXC\", NULL, \"AIF1RX5\" },\n\n\t{ \"AIF2RX\", NULL, \"AIF2RX0\" },\n\t{ \"AIF2RX\", NULL, \"AIF2RX1\" },\n\n\t{ \"AIF2TX\", \"DSP2\", \"DSP2TX\" },\n\t{ \"AIF2TX\", \"DSP1\", \"DSP1RX\" },\n\t{ \"AIF2TX\", \"AIF1\", \"AIF1RXC\" },\n\n\t{ \"DSP1RXL\", NULL, \"DSP1RX\" },\n\t{ \"DSP1RXR\", NULL, \"DSP1RX\" },\n\t{ \"DSP2RXL\", NULL, \"DSP2RX\" },\n\t{ \"DSP2RXR\", NULL, \"DSP2RX\" },\n\n\t{ \"DSP2TX\", NULL, \"DSP2TXL\" },\n\t{ \"DSP2TX\", NULL, \"DSP2TXR\" },\n\n\t{ \"DSP1RX\", \"AIF1\", \"AIF1RXA\" },\n\t{ \"DSP1RX\", \"AIF2\", \"AIF2RX\" },\n\n\t{ \"DSP2RX\", \"AIF1\", \"AIF1RXB\" },\n\t{ \"DSP2RX\", \"AIF2\", \"AIF2RX\" },\n\n\t{ \"DAC2L Mixer\", \"DSP2 Switch\", \"DSP2RXL\" },\n\t{ \"DAC2L Mixer\", \"DSP1 Switch\", \"DSP1RXL\" },\n\t{ \"DAC2L Mixer\", \"Right Sidetone Switch\", \"Right Sidetone\" },\n\t{ \"DAC2L Mixer\", \"Left Sidetone Switch\", \"Left Sidetone\" },\n\n\t{ \"DAC2R Mixer\", \"DSP2 Switch\", \"DSP2RXR\" },\n\t{ \"DAC2R Mixer\", \"DSP1 Switch\", \"DSP1RXR\" },\n\t{ \"DAC2R Mixer\", \"Right Sidetone Switch\", \"Right Sidetone\" },\n\t{ \"DAC2R Mixer\", \"Left Sidetone Switch\", \"Left Sidetone\" },\n\n\t{ \"DAC1L Mixer\", \"DSP2 Switch\", \"DSP2RXL\" },\n\t{ \"DAC1L Mixer\", \"DSP1 Switch\", \"DSP1RXL\" },\n\t{ \"DAC1L Mixer\", \"Right Sidetone Switch\", \"Right Sidetone\" },\n\t{ \"DAC1L Mixer\", \"Left Sidetone Switch\", \"Left Sidetone\" },\n\n\t{ \"DAC1R Mixer\", \"DSP2 Switch\", \"DSP2RXR\" },\n\t{ \"DAC1R Mixer\", \"DSP1 Switch\", \"DSP1RXR\" },\n\t{ \"DAC1R Mixer\", \"Right Sidetone Switch\", \"Right Sidetone\" },\n\t{ \"DAC1R Mixer\", \"Left Sidetone Switch\", \"Left Sidetone\" },\n\n\t{ \"DAC1L\", NULL, \"DAC1L Mixer\" },\n\t{ \"DAC1R\", NULL, \"DAC1R Mixer\" },\n\t{ \"DAC2L\", NULL, \"DAC2L Mixer\" },\n\t{ \"DAC2R\", NULL, \"DAC2R Mixer\" },\n\n\t{ \"HPOUT2L PGA\", NULL, \"Charge Pump\" },\n\t{ \"HPOUT2L PGA\", NULL, \"Bandgap\" },\n\t{ \"HPOUT2L PGA\", NULL, \"DAC2L\" },\n\t{ \"HPOUT2L_DLY\", NULL, \"HPOUT2L PGA\" },\n\t{ \"HPOUT2L_DCS\", NULL, \"HPOUT2L_DLY\" },\n\t{ \"HPOUT2L_RMV_SHORT\", NULL, \"HPOUT2L_DCS\" },\n\n\t{ \"HPOUT2R PGA\", NULL, \"Charge Pump\" },\n\t{ \"HPOUT2R PGA\", NULL, \"Bandgap\" },\n\t{ \"HPOUT2R PGA\", NULL, \"DAC2R\" },\n\t{ \"HPOUT2R_DLY\", NULL, \"HPOUT2R PGA\" },\n\t{ \"HPOUT2R_DCS\", NULL, \"HPOUT2R_DLY\" },\n\t{ \"HPOUT2R_RMV_SHORT\", NULL, \"HPOUT2R_DCS\" },\n\n\t{ \"HPOUT1L PGA\", NULL, \"Charge Pump\" },\n\t{ \"HPOUT1L PGA\", NULL, \"Bandgap\" },\n\t{ \"HPOUT1L PGA\", NULL, \"DAC1L\" },\n\t{ \"HPOUT1L_DLY\", NULL, \"HPOUT1L PGA\" },\n\t{ \"HPOUT1L_DCS\", NULL, \"HPOUT1L_DLY\" },\n\t{ \"HPOUT1L_RMV_SHORT\", NULL, \"HPOUT1L_DCS\" },\n\n\t{ \"HPOUT1R PGA\", NULL, \"Charge Pump\" },\n\t{ \"HPOUT1R PGA\", NULL, \"Bandgap\" },\n\t{ \"HPOUT1R PGA\", NULL, \"DAC1R\" },\n\t{ \"HPOUT1R_DLY\", NULL, \"HPOUT1R PGA\" },\n\t{ \"HPOUT1R_DCS\", NULL, \"HPOUT1R_DLY\" },\n\t{ \"HPOUT1R_RMV_SHORT\", NULL, \"HPOUT1R_DCS\" },\n\n\t{ \"HPOUT2L\", NULL, \"HPOUT2L_RMV_SHORT\" },\n\t{ \"HPOUT2R\", NULL, \"HPOUT2R_RMV_SHORT\" },\n\t{ \"HPOUT1L\", NULL, \"HPOUT1L_RMV_SHORT\" },\n\t{ \"HPOUT1R\", NULL, \"HPOUT1R_RMV_SHORT\" },\n\n\t{ \"SPKL\", \"DAC1L\", \"DAC1L\" },\n\t{ \"SPKL\", \"DAC1R\", \"DAC1R\" },\n\t{ \"SPKL\", \"DAC2L\", \"DAC2L\" },\n\t{ \"SPKL\", \"DAC2R\", \"DAC2R\" },\n\n\t{ \"SPKR\", \"DAC1L\", \"DAC1L\" },\n\t{ \"SPKR\", \"DAC1R\", \"DAC1R\" },\n\t{ \"SPKR\", \"DAC2L\", \"DAC2L\" },\n\t{ \"SPKR\", \"DAC2R\", \"DAC2R\" },\n\n\t{ \"SPKL PGA\", NULL, \"SPKL\" },\n\t{ \"SPKR PGA\", NULL, \"SPKR\" },\n\n\t{ \"SPKDAT\", NULL, \"SPKL PGA\" },\n\t{ \"SPKDAT\", NULL, \"SPKR PGA\" },\n};\n\nstatic bool wm8996_readable_register(struct device *dev, unsigned int reg)\n{\n\t \n\tswitch (reg) {\n\tcase WM8996_SOFTWARE_RESET:\n\tcase WM8996_POWER_MANAGEMENT_1:\n\tcase WM8996_POWER_MANAGEMENT_2:\n\tcase WM8996_POWER_MANAGEMENT_3:\n\tcase WM8996_POWER_MANAGEMENT_4:\n\tcase WM8996_POWER_MANAGEMENT_5:\n\tcase WM8996_POWER_MANAGEMENT_6:\n\tcase WM8996_POWER_MANAGEMENT_7:\n\tcase WM8996_POWER_MANAGEMENT_8:\n\tcase WM8996_LEFT_LINE_INPUT_VOLUME:\n\tcase WM8996_RIGHT_LINE_INPUT_VOLUME:\n\tcase WM8996_LINE_INPUT_CONTROL:\n\tcase WM8996_DAC1_HPOUT1_VOLUME:\n\tcase WM8996_DAC2_HPOUT2_VOLUME:\n\tcase WM8996_DAC1_LEFT_VOLUME:\n\tcase WM8996_DAC1_RIGHT_VOLUME:\n\tcase WM8996_DAC2_LEFT_VOLUME:\n\tcase WM8996_DAC2_RIGHT_VOLUME:\n\tcase WM8996_OUTPUT1_LEFT_VOLUME:\n\tcase WM8996_OUTPUT1_RIGHT_VOLUME:\n\tcase WM8996_OUTPUT2_LEFT_VOLUME:\n\tcase WM8996_OUTPUT2_RIGHT_VOLUME:\n\tcase WM8996_MICBIAS_1:\n\tcase WM8996_MICBIAS_2:\n\tcase WM8996_LDO_1:\n\tcase WM8996_LDO_2:\n\tcase WM8996_ACCESSORY_DETECT_MODE_1:\n\tcase WM8996_ACCESSORY_DETECT_MODE_2:\n\tcase WM8996_HEADPHONE_DETECT_1:\n\tcase WM8996_HEADPHONE_DETECT_2:\n\tcase WM8996_MIC_DETECT_1:\n\tcase WM8996_MIC_DETECT_2:\n\tcase WM8996_MIC_DETECT_3:\n\tcase WM8996_CHARGE_PUMP_1:\n\tcase WM8996_CHARGE_PUMP_2:\n\tcase WM8996_DC_SERVO_1:\n\tcase WM8996_DC_SERVO_2:\n\tcase WM8996_DC_SERVO_3:\n\tcase WM8996_DC_SERVO_5:\n\tcase WM8996_DC_SERVO_6:\n\tcase WM8996_DC_SERVO_7:\n\tcase WM8996_DC_SERVO_READBACK_0:\n\tcase WM8996_ANALOGUE_HP_1:\n\tcase WM8996_ANALOGUE_HP_2:\n\tcase WM8996_CHIP_REVISION:\n\tcase WM8996_CONTROL_INTERFACE_1:\n\tcase WM8996_WRITE_SEQUENCER_CTRL_1:\n\tcase WM8996_WRITE_SEQUENCER_CTRL_2:\n\tcase WM8996_AIF_CLOCKING_1:\n\tcase WM8996_AIF_CLOCKING_2:\n\tcase WM8996_CLOCKING_1:\n\tcase WM8996_CLOCKING_2:\n\tcase WM8996_AIF_RATE:\n\tcase WM8996_FLL_CONTROL_1:\n\tcase WM8996_FLL_CONTROL_2:\n\tcase WM8996_FLL_CONTROL_3:\n\tcase WM8996_FLL_CONTROL_4:\n\tcase WM8996_FLL_CONTROL_5:\n\tcase WM8996_FLL_CONTROL_6:\n\tcase WM8996_FLL_EFS_1:\n\tcase WM8996_FLL_EFS_2:\n\tcase WM8996_AIF1_CONTROL:\n\tcase WM8996_AIF1_BCLK:\n\tcase WM8996_AIF1_TX_LRCLK_1:\n\tcase WM8996_AIF1_TX_LRCLK_2:\n\tcase WM8996_AIF1_RX_LRCLK_1:\n\tcase WM8996_AIF1_RX_LRCLK_2:\n\tcase WM8996_AIF1TX_DATA_CONFIGURATION_1:\n\tcase WM8996_AIF1TX_DATA_CONFIGURATION_2:\n\tcase WM8996_AIF1RX_DATA_CONFIGURATION:\n\tcase WM8996_AIF1TX_CHANNEL_0_CONFIGURATION:\n\tcase WM8996_AIF1TX_CHANNEL_1_CONFIGURATION:\n\tcase WM8996_AIF1TX_CHANNEL_2_CONFIGURATION:\n\tcase WM8996_AIF1TX_CHANNEL_3_CONFIGURATION:\n\tcase WM8996_AIF1TX_CHANNEL_4_CONFIGURATION:\n\tcase WM8996_AIF1TX_CHANNEL_5_CONFIGURATION:\n\tcase WM8996_AIF1RX_CHANNEL_0_CONFIGURATION:\n\tcase WM8996_AIF1RX_CHANNEL_1_CONFIGURATION:\n\tcase WM8996_AIF1RX_CHANNEL_2_CONFIGURATION:\n\tcase WM8996_AIF1RX_CHANNEL_3_CONFIGURATION:\n\tcase WM8996_AIF1RX_CHANNEL_4_CONFIGURATION:\n\tcase WM8996_AIF1RX_CHANNEL_5_CONFIGURATION:\n\tcase WM8996_AIF1RX_MONO_CONFIGURATION:\n\tcase WM8996_AIF1TX_TEST:\n\tcase WM8996_AIF2_CONTROL:\n\tcase WM8996_AIF2_BCLK:\n\tcase WM8996_AIF2_TX_LRCLK_1:\n\tcase WM8996_AIF2_TX_LRCLK_2:\n\tcase WM8996_AIF2_RX_LRCLK_1:\n\tcase WM8996_AIF2_RX_LRCLK_2:\n\tcase WM8996_AIF2TX_DATA_CONFIGURATION_1:\n\tcase WM8996_AIF2TX_DATA_CONFIGURATION_2:\n\tcase WM8996_AIF2RX_DATA_CONFIGURATION:\n\tcase WM8996_AIF2TX_CHANNEL_0_CONFIGURATION:\n\tcase WM8996_AIF2TX_CHANNEL_1_CONFIGURATION:\n\tcase WM8996_AIF2RX_CHANNEL_0_CONFIGURATION:\n\tcase WM8996_AIF2RX_CHANNEL_1_CONFIGURATION:\n\tcase WM8996_AIF2RX_MONO_CONFIGURATION:\n\tcase WM8996_AIF2TX_TEST:\n\tcase WM8996_DSP1_TX_LEFT_VOLUME:\n\tcase WM8996_DSP1_TX_RIGHT_VOLUME:\n\tcase WM8996_DSP1_RX_LEFT_VOLUME:\n\tcase WM8996_DSP1_RX_RIGHT_VOLUME:\n\tcase WM8996_DSP1_TX_FILTERS:\n\tcase WM8996_DSP1_RX_FILTERS_1:\n\tcase WM8996_DSP1_RX_FILTERS_2:\n\tcase WM8996_DSP1_DRC_1:\n\tcase WM8996_DSP1_DRC_2:\n\tcase WM8996_DSP1_DRC_3:\n\tcase WM8996_DSP1_DRC_4:\n\tcase WM8996_DSP1_DRC_5:\n\tcase WM8996_DSP1_RX_EQ_GAINS_1:\n\tcase WM8996_DSP1_RX_EQ_GAINS_2:\n\tcase WM8996_DSP1_RX_EQ_BAND_1_A:\n\tcase WM8996_DSP1_RX_EQ_BAND_1_B:\n\tcase WM8996_DSP1_RX_EQ_BAND_1_PG:\n\tcase WM8996_DSP1_RX_EQ_BAND_2_A:\n\tcase WM8996_DSP1_RX_EQ_BAND_2_B:\n\tcase WM8996_DSP1_RX_EQ_BAND_2_C:\n\tcase WM8996_DSP1_RX_EQ_BAND_2_PG:\n\tcase WM8996_DSP1_RX_EQ_BAND_3_A:\n\tcase WM8996_DSP1_RX_EQ_BAND_3_B:\n\tcase WM8996_DSP1_RX_EQ_BAND_3_C:\n\tcase WM8996_DSP1_RX_EQ_BAND_3_PG:\n\tcase WM8996_DSP1_RX_EQ_BAND_4_A:\n\tcase WM8996_DSP1_RX_EQ_BAND_4_B:\n\tcase WM8996_DSP1_RX_EQ_BAND_4_C:\n\tcase WM8996_DSP1_RX_EQ_BAND_4_PG:\n\tcase WM8996_DSP1_RX_EQ_BAND_5_A:\n\tcase WM8996_DSP1_RX_EQ_BAND_5_B:\n\tcase WM8996_DSP1_RX_EQ_BAND_5_PG:\n\tcase WM8996_DSP2_TX_LEFT_VOLUME:\n\tcase WM8996_DSP2_TX_RIGHT_VOLUME:\n\tcase WM8996_DSP2_RX_LEFT_VOLUME:\n\tcase WM8996_DSP2_RX_RIGHT_VOLUME:\n\tcase WM8996_DSP2_TX_FILTERS:\n\tcase WM8996_DSP2_RX_FILTERS_1:\n\tcase WM8996_DSP2_RX_FILTERS_2:\n\tcase WM8996_DSP2_DRC_1:\n\tcase WM8996_DSP2_DRC_2:\n\tcase WM8996_DSP2_DRC_3:\n\tcase WM8996_DSP2_DRC_4:\n\tcase WM8996_DSP2_DRC_5:\n\tcase WM8996_DSP2_RX_EQ_GAINS_1:\n\tcase WM8996_DSP2_RX_EQ_GAINS_2:\n\tcase WM8996_DSP2_RX_EQ_BAND_1_A:\n\tcase WM8996_DSP2_RX_EQ_BAND_1_B:\n\tcase WM8996_DSP2_RX_EQ_BAND_1_PG:\n\tcase WM8996_DSP2_RX_EQ_BAND_2_A:\n\tcase WM8996_DSP2_RX_EQ_BAND_2_B:\n\tcase WM8996_DSP2_RX_EQ_BAND_2_C:\n\tcase WM8996_DSP2_RX_EQ_BAND_2_PG:\n\tcase WM8996_DSP2_RX_EQ_BAND_3_A:\n\tcase WM8996_DSP2_RX_EQ_BAND_3_B:\n\tcase WM8996_DSP2_RX_EQ_BAND_3_C:\n\tcase WM8996_DSP2_RX_EQ_BAND_3_PG:\n\tcase WM8996_DSP2_RX_EQ_BAND_4_A:\n\tcase WM8996_DSP2_RX_EQ_BAND_4_B:\n\tcase WM8996_DSP2_RX_EQ_BAND_4_C:\n\tcase WM8996_DSP2_RX_EQ_BAND_4_PG:\n\tcase WM8996_DSP2_RX_EQ_BAND_5_A:\n\tcase WM8996_DSP2_RX_EQ_BAND_5_B:\n\tcase WM8996_DSP2_RX_EQ_BAND_5_PG:\n\tcase WM8996_DAC1_MIXER_VOLUMES:\n\tcase WM8996_DAC1_LEFT_MIXER_ROUTING:\n\tcase WM8996_DAC1_RIGHT_MIXER_ROUTING:\n\tcase WM8996_DAC2_MIXER_VOLUMES:\n\tcase WM8996_DAC2_LEFT_MIXER_ROUTING:\n\tcase WM8996_DAC2_RIGHT_MIXER_ROUTING:\n\tcase WM8996_DSP1_TX_LEFT_MIXER_ROUTING:\n\tcase WM8996_DSP1_TX_RIGHT_MIXER_ROUTING:\n\tcase WM8996_DSP2_TX_LEFT_MIXER_ROUTING:\n\tcase WM8996_DSP2_TX_RIGHT_MIXER_ROUTING:\n\tcase WM8996_DSP_TX_MIXER_SELECT:\n\tcase WM8996_DAC_SOFTMUTE:\n\tcase WM8996_OVERSAMPLING:\n\tcase WM8996_SIDETONE:\n\tcase WM8996_GPIO_1:\n\tcase WM8996_GPIO_2:\n\tcase WM8996_GPIO_3:\n\tcase WM8996_GPIO_4:\n\tcase WM8996_GPIO_5:\n\tcase WM8996_PULL_CONTROL_1:\n\tcase WM8996_PULL_CONTROL_2:\n\tcase WM8996_INTERRUPT_STATUS_1:\n\tcase WM8996_INTERRUPT_STATUS_2:\n\tcase WM8996_INTERRUPT_RAW_STATUS_2:\n\tcase WM8996_INTERRUPT_STATUS_1_MASK:\n\tcase WM8996_INTERRUPT_STATUS_2_MASK:\n\tcase WM8996_INTERRUPT_CONTROL:\n\tcase WM8996_LEFT_PDM_SPEAKER:\n\tcase WM8996_RIGHT_PDM_SPEAKER:\n\tcase WM8996_PDM_SPEAKER_MUTE_SEQUENCE:\n\tcase WM8996_PDM_SPEAKER_VOLUME:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool wm8996_volatile_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase WM8996_SOFTWARE_RESET:\n\tcase WM8996_CHIP_REVISION:\n\tcase WM8996_LDO_1:\n\tcase WM8996_LDO_2:\n\tcase WM8996_INTERRUPT_STATUS_1:\n\tcase WM8996_INTERRUPT_STATUS_2:\n\tcase WM8996_INTERRUPT_RAW_STATUS_2:\n\tcase WM8996_DC_SERVO_READBACK_0:\n\tcase WM8996_DC_SERVO_2:\n\tcase WM8996_DC_SERVO_6:\n\tcase WM8996_DC_SERVO_7:\n\tcase WM8996_FLL_CONTROL_6:\n\tcase WM8996_MIC_DETECT_3:\n\tcase WM8996_HEADPHONE_DETECT_1:\n\tcase WM8996_HEADPHONE_DETECT_2:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const int bclk_divs[] = {\n\t1, 2, 3, 4, 6, 8, 12, 16, 24, 32, 48, 64, 96\n};\n\nstatic void wm8996_update_bclk(struct snd_soc_component *component)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint aif, best, cur_val, bclk_rate, bclk_reg, i;\n\n\t \n\tif (wm8996->sysclk < 64000)\n\t\treturn;\n\n\tfor (aif = 0; aif < WM8996_AIFS; aif++) {\n\t\tswitch (aif) {\n\t\tcase 0:\n\t\t\tbclk_reg = WM8996_AIF1_BCLK;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tbclk_reg = WM8996_AIF2_BCLK;\n\t\t\tbreak;\n\t\t}\n\n\t\tbclk_rate = wm8996->bclk_rate[aif];\n\n\t\t \n\t\tbest = 0;\n\t\tfor (i = 0; i < ARRAY_SIZE(bclk_divs); i++) {\n\t\t\tcur_val = (wm8996->sysclk / bclk_divs[i]) - bclk_rate;\n\t\t\tif (cur_val < 0)  \n\t\t\t\tbreak;\n\t\t\tbest = i;\n\t\t}\n\t\tbclk_rate = wm8996->sysclk / bclk_divs[best];\n\t\tdev_dbg(component->dev, \"Using BCLK_DIV %d for actual BCLK %dHz\\n\",\n\t\t\tbclk_divs[best], bclk_rate);\n\n\t\tsnd_soc_component_update_bits(component, bclk_reg,\n\t\t\t\t    WM8996_AIF1_BCLK_DIV_MASK, best);\n\t}\n}\n\nstatic int wm8996_set_bias_level(struct snd_soc_component *component,\n\t\t\t\t enum snd_soc_bias_level level)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_ON:\n\t\tbreak;\n\tcase SND_SOC_BIAS_PREPARE:\n\t\t \n\t\tsnd_soc_component_update_bits(component, WM8996_MICBIAS_1,\n\t\t\t\t    WM8996_MICB1_MODE, 0);\n\t\tsnd_soc_component_update_bits(component, WM8996_MICBIAS_2,\n\t\t\t\t    WM8996_MICB2_MODE, 0);\n\t\tbreak;\n\n\tcase SND_SOC_BIAS_STANDBY:\n\t\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF) {\n\t\t\tret = regulator_bulk_enable(ARRAY_SIZE(wm8996->supplies),\n\t\t\t\t\t\t    wm8996->supplies);\n\t\t\tif (ret != 0) {\n\t\t\t\tdev_err(component->dev,\n\t\t\t\t\t\"Failed to enable supplies: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tif (wm8996->pdata.ldo_ena >= 0) {\n\t\t\t\tgpio_set_value_cansleep(wm8996->pdata.ldo_ena,\n\t\t\t\t\t\t\t1);\n\t\t\t\tmsleep(5);\n\t\t\t}\n\n\t\t\tregcache_cache_only(wm8996->regmap, false);\n\t\t\tregcache_sync(wm8996->regmap);\n\t\t}\n\n\t\t \n\t\tsnd_soc_component_update_bits(component, WM8996_MICBIAS_1,\n\t\t\t\t    WM8996_MICB1_MODE, WM8996_MICB1_MODE);\n\t\tsnd_soc_component_update_bits(component, WM8996_MICBIAS_2,\n\t\t\t\t    WM8996_MICB2_MODE, WM8996_MICB2_MODE);\n\t\tbreak;\n\n\tcase SND_SOC_BIAS_OFF:\n\t\tregcache_cache_only(wm8996->regmap, true);\n\t\tif (wm8996->pdata.ldo_ena >= 0) {\n\t\t\tgpio_set_value_cansleep(wm8996->pdata.ldo_ena, 0);\n\t\t\tregcache_cache_only(wm8996->regmap, true);\n\t\t}\n\t\tregulator_bulk_disable(ARRAY_SIZE(wm8996->supplies),\n\t\t\t\t       wm8996->supplies);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wm8996_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint aifctrl = 0;\n\tint bclk = 0;\n\tint lrclk_tx = 0;\n\tint lrclk_rx = 0;\n\tint aifctrl_reg, bclk_reg, lrclk_tx_reg, lrclk_rx_reg;\n\n\tswitch (dai->id) {\n\tcase 0:\n\t\taifctrl_reg = WM8996_AIF1_CONTROL;\n\t\tbclk_reg = WM8996_AIF1_BCLK;\n\t\tlrclk_tx_reg = WM8996_AIF1_TX_LRCLK_2;\n\t\tlrclk_rx_reg = WM8996_AIF1_RX_LRCLK_2;\n\t\tbreak;\n\tcase 1:\n\t\taifctrl_reg = WM8996_AIF2_CONTROL;\n\t\tbclk_reg = WM8996_AIF2_BCLK;\n\t\tlrclk_tx_reg = WM8996_AIF2_TX_LRCLK_2;\n\t\tlrclk_rx_reg = WM8996_AIF2_RX_LRCLK_2;\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid dai id %d\\n\", dai->id);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\tbclk |= WM8996_AIF1_BCLK_INV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\tlrclk_tx |= WM8996_AIF1TX_LRCLK_INV;\n\t\tlrclk_rx |= WM8996_AIF1RX_LRCLK_INV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\tbclk |= WM8996_AIF1_BCLK_INV;\n\t\tlrclk_tx |= WM8996_AIF1TX_LRCLK_INV;\n\t\tlrclk_rx |= WM8996_AIF1RX_LRCLK_INV;\n\t\tbreak;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\n\tcase SND_SOC_DAIFMT_CBS_CFS:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBS_CFM:\n\t\tlrclk_tx |= WM8996_AIF1TX_LRCLK_MSTR;\n\t\tlrclk_rx |= WM8996_AIF1RX_LRCLK_MSTR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFS:\n\t\tbclk |= WM8996_AIF1_BCLK_MSTR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFM:\n\t\tbclk |= WM8996_AIF1_BCLK_MSTR;\n\t\tlrclk_tx |= WM8996_AIF1TX_LRCLK_MSTR;\n\t\tlrclk_rx |= WM8996_AIF1RX_LRCLK_MSTR;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\taifctrl |= 1;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_I2S:\n\t\taifctrl |= 2;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\taifctrl |= 3;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_update_bits(component, aifctrl_reg, WM8996_AIF1_FMT_MASK, aifctrl);\n\tsnd_soc_component_update_bits(component, bclk_reg,\n\t\t\t    WM8996_AIF1_BCLK_INV | WM8996_AIF1_BCLK_MSTR,\n\t\t\t    bclk);\n\tsnd_soc_component_update_bits(component, lrclk_tx_reg,\n\t\t\t    WM8996_AIF1TX_LRCLK_INV |\n\t\t\t    WM8996_AIF1TX_LRCLK_MSTR,\n\t\t\t    lrclk_tx);\n\tsnd_soc_component_update_bits(component, lrclk_rx_reg,\n\t\t\t    WM8996_AIF1RX_LRCLK_INV |\n\t\t\t    WM8996_AIF1RX_LRCLK_MSTR,\n\t\t\t    lrclk_rx);\n\n\treturn 0;\n}\n\nstatic const int dsp_divs[] = {\n\t48000, 32000, 16000, 8000\n};\n\nstatic int wm8996_hw_params(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_pcm_hw_params *params,\n\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint bits, i, bclk_rate, best;\n\tint aifdata = 0;\n\tint lrclk = 0;\n\tint dsp = 0;\n\tint aifdata_reg, lrclk_reg, dsp_shift;\n\n\tswitch (dai->id) {\n\tcase 0:\n\t\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK ||\n\t\t    (snd_soc_component_read(component, WM8996_GPIO_1)) & WM8996_GP1_FN_MASK) {\n\t\t\taifdata_reg = WM8996_AIF1RX_DATA_CONFIGURATION;\n\t\t\tlrclk_reg = WM8996_AIF1_RX_LRCLK_1;\n\t\t} else {\n\t\t\taifdata_reg = WM8996_AIF1TX_DATA_CONFIGURATION_1;\n\t\t\tlrclk_reg = WM8996_AIF1_TX_LRCLK_1;\n\t\t}\n\t\tdsp_shift = 0;\n\t\tbreak;\n\tcase 1:\n\t\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK ||\n\t\t    (snd_soc_component_read(component, WM8996_GPIO_2)) & WM8996_GP2_FN_MASK) {\n\t\t\taifdata_reg = WM8996_AIF2RX_DATA_CONFIGURATION;\n\t\t\tlrclk_reg = WM8996_AIF2_RX_LRCLK_1;\n\t\t} else {\n\t\t\taifdata_reg = WM8996_AIF2TX_DATA_CONFIGURATION_1;\n\t\t\tlrclk_reg = WM8996_AIF2_TX_LRCLK_1;\n\t\t}\n\t\tdsp_shift = WM8996_DSP2_DIV_SHIFT;\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid dai id %d\\n\", dai->id);\n\t\treturn -EINVAL;\n\t}\n\n\tbclk_rate = snd_soc_params_to_bclk(params);\n\tif (bclk_rate < 0) {\n\t\tdev_err(component->dev, \"Unsupported BCLK rate: %d\\n\", bclk_rate);\n\t\treturn bclk_rate;\n\t}\n\n\twm8996->bclk_rate[dai->id] = bclk_rate;\n\twm8996->rx_rate[dai->id] = params_rate(params);\n\n\t \n\tbits = params_width(params);\n\tif (bits < 0)\n\t\treturn bits;\n\taifdata |= (bits << WM8996_AIF1TX_WL_SHIFT) | bits;\n\n\tbest = 0;\n\tfor (i = 0; i < ARRAY_SIZE(dsp_divs); i++) {\n\t\tif (abs(dsp_divs[i] - params_rate(params)) <\n\t\t    abs(dsp_divs[best] - params_rate(params)))\n\t\t\tbest = i;\n\t}\n\tdsp |= i << dsp_shift;\n\n\twm8996_update_bclk(component);\n\n\tlrclk = bclk_rate / params_rate(params);\n\tdev_dbg(dai->dev, \"Using LRCLK rate %d for actual LRCLK %dHz\\n\",\n\t\tlrclk, bclk_rate / lrclk);\n\n\tsnd_soc_component_update_bits(component, aifdata_reg,\n\t\t\t    WM8996_AIF1TX_WL_MASK |\n\t\t\t    WM8996_AIF1TX_SLOT_LEN_MASK,\n\t\t\t    aifdata);\n\tsnd_soc_component_update_bits(component, lrclk_reg, WM8996_AIF1RX_RATE_MASK,\n\t\t\t    lrclk);\n\tsnd_soc_component_update_bits(component, WM8996_AIF_CLOCKING_2,\n\t\t\t    WM8996_DSP1_DIV_MASK << dsp_shift, dsp);\n\n\treturn 0;\n}\n\nstatic int wm8996_set_sysclk(struct snd_soc_dai *dai,\n\t\tint clk_id, unsigned int freq, int dir)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint lfclk = 0;\n\tint ratediv = 0;\n\tint sync = WM8996_REG_SYNC;\n\tint src;\n\tint old;\n\n\tif (freq == wm8996->sysclk && clk_id == wm8996->sysclk_src)\n\t\treturn 0;\n\n\t \n\told = snd_soc_component_read(component, WM8996_AIF_CLOCKING_1) & WM8996_SYSCLK_ENA;\n\tsnd_soc_component_update_bits(component, WM8996_AIF_CLOCKING_1,\n\t\t\t    WM8996_SYSCLK_ENA, 0);\n\n\tswitch (clk_id) {\n\tcase WM8996_SYSCLK_MCLK1:\n\t\twm8996->sysclk = freq;\n\t\tsrc = 0;\n\t\tbreak;\n\tcase WM8996_SYSCLK_MCLK2:\n\t\twm8996->sysclk = freq;\n\t\tsrc = 1;\n\t\tbreak;\n\tcase WM8996_SYSCLK_FLL:\n\t\twm8996->sysclk = freq;\n\t\tsrc = 2;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"Unsupported clock source %d\\n\", clk_id);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (wm8996->sysclk) {\n\tcase 5644800:\n\tcase 6144000:\n\t\tsnd_soc_component_update_bits(component, WM8996_AIF_RATE,\n\t\t\t\t    WM8996_SYSCLK_RATE, 0);\n\t\tbreak;\n\tcase 22579200:\n\tcase 24576000:\n\t\tratediv = WM8996_SYSCLK_DIV;\n\t\twm8996->sysclk /= 2;\n\t\tfallthrough;\n\tcase 11289600:\n\tcase 12288000:\n\t\tsnd_soc_component_update_bits(component, WM8996_AIF_RATE,\n\t\t\t\t    WM8996_SYSCLK_RATE, WM8996_SYSCLK_RATE);\n\t\tbreak;\n\tcase 32000:\n\tcase 32768:\n\t\tlfclk = WM8996_LFCLK_ENA;\n\t\tsync = 0;\n\t\tbreak;\n\tdefault:\n\t\tdev_warn(component->dev, \"Unsupported clock rate %dHz\\n\",\n\t\t\t wm8996->sysclk);\n\t\treturn -EINVAL;\n\t}\n\n\twm8996_update_bclk(component);\n\n\tsnd_soc_component_update_bits(component, WM8996_AIF_CLOCKING_1,\n\t\t\t    WM8996_SYSCLK_SRC_MASK | WM8996_SYSCLK_DIV_MASK,\n\t\t\t    src << WM8996_SYSCLK_SRC_SHIFT | ratediv);\n\tsnd_soc_component_update_bits(component, WM8996_CLOCKING_1, WM8996_LFCLK_ENA, lfclk);\n\tsnd_soc_component_update_bits(component, WM8996_CONTROL_INTERFACE_1,\n\t\t\t    WM8996_REG_SYNC, sync);\n\tsnd_soc_component_update_bits(component, WM8996_AIF_CLOCKING_1,\n\t\t\t    WM8996_SYSCLK_ENA, old);\n\n\twm8996->sysclk_src = clk_id;\n\n\treturn 0;\n}\n\nstruct _fll_div {\n\tu16 fll_fratio;\n\tu16 fll_outdiv;\n\tu16 fll_refclk_div;\n\tu16 fll_loop_gain;\n\tu16 fll_ref_freq;\n\tu16 n;\n\tu16 theta;\n\tu16 lambda;\n};\n\nstatic struct {\n\tunsigned int min;\n\tunsigned int max;\n\tu16 fll_fratio;\n\tint ratio;\n} fll_fratios[] = {\n\t{       0,    64000, 4, 16 },\n\t{   64000,   128000, 3,  8 },\n\t{  128000,   256000, 2,  4 },\n\t{  256000,  1000000, 1,  2 },\n\t{ 1000000, 13500000, 0,  1 },\n};\n\nstatic int fll_factors(struct _fll_div *fll_div, unsigned int Fref,\n\t\t       unsigned int Fout)\n{\n\tunsigned int target;\n\tunsigned int div;\n\tunsigned int fratio, gcd_fll;\n\tint i;\n\n\t \n\tdiv = 1;\n\tfll_div->fll_refclk_div = 0;\n\twhile ((Fref / div) > 13500000) {\n\t\tdiv *= 2;\n\t\tfll_div->fll_refclk_div++;\n\n\t\tif (div > 8) {\n\t\t\tpr_err(\"Can't scale %dMHz input down to <=13.5MHz\\n\",\n\t\t\t       Fref);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tpr_debug(\"FLL Fref=%u Fout=%u\\n\", Fref, Fout);\n\n\t \n\tFref /= div;\n\n\tif (Fref >= 3000000)\n\t\tfll_div->fll_loop_gain = 5;\n\telse\n\t\tfll_div->fll_loop_gain = 0;\n\n\tif (Fref >= 48000)\n\t\tfll_div->fll_ref_freq = 0;\n\telse\n\t\tfll_div->fll_ref_freq = 1;\n\n\t \n\tdiv = 2;\n\twhile (Fout * div < 90000000) {\n\t\tdiv++;\n\t\tif (div > 64) {\n\t\t\tpr_err(\"Unable to find FLL_OUTDIV for Fout=%uHz\\n\",\n\t\t\t       Fout);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\ttarget = Fout * div;\n\tfll_div->fll_outdiv = div - 1;\n\n\tpr_debug(\"FLL Fvco=%dHz\\n\", target);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(fll_fratios); i++) {\n\t\tif (fll_fratios[i].min <= Fref && Fref <= fll_fratios[i].max) {\n\t\t\tfll_div->fll_fratio = fll_fratios[i].fll_fratio;\n\t\t\tfratio = fll_fratios[i].ratio;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (i == ARRAY_SIZE(fll_fratios)) {\n\t\tpr_err(\"Unable to find FLL_FRATIO for Fref=%uHz\\n\", Fref);\n\t\treturn -EINVAL;\n\t}\n\n\tfll_div->n = target / (fratio * Fref);\n\n\tif (target % Fref == 0) {\n\t\tfll_div->theta = 0;\n\t\tfll_div->lambda = 0;\n\t} else {\n\t\tgcd_fll = gcd(target, fratio * Fref);\n\n\t\tfll_div->theta = (target - (fll_div->n * fratio * Fref))\n\t\t\t/ gcd_fll;\n\t\tfll_div->lambda = (fratio * Fref) / gcd_fll;\n\t}\n\n\tpr_debug(\"FLL N=%x THETA=%x LAMBDA=%x\\n\",\n\t\t fll_div->n, fll_div->theta, fll_div->lambda);\n\tpr_debug(\"FLL_FRATIO=%x FLL_OUTDIV=%x FLL_REFCLK_DIV=%x\\n\",\n\t\t fll_div->fll_fratio, fll_div->fll_outdiv,\n\t\t fll_div->fll_refclk_div);\n\n\treturn 0;\n}\n\nstatic int wm8996_set_fll(struct snd_soc_component *component, int fll_id, int source,\n\t\t\t  unsigned int Fref, unsigned int Fout)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tstruct i2c_client *i2c = to_i2c_client(component->dev);\n\tstruct _fll_div fll_div;\n\tunsigned long timeout, time_left;\n\tint ret, reg, retry;\n\n\t \n\tif (source == wm8996->fll_src && Fref == wm8996->fll_fref &&\n\t    Fout == wm8996->fll_fout)\n\t\treturn 0;\n\n\tif (Fout == 0) {\n\t\tdev_dbg(component->dev, \"FLL disabled\\n\");\n\n\t\twm8996->fll_fref = 0;\n\t\twm8996->fll_fout = 0;\n\n\t\tsnd_soc_component_update_bits(component, WM8996_FLL_CONTROL_1,\n\t\t\t\t    WM8996_FLL_ENA, 0);\n\n\t\twm8996_bg_disable(component);\n\n\t\treturn 0;\n\t}\n\n\tret = fll_factors(&fll_div, Fref, Fout);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tswitch (source) {\n\tcase WM8996_FLL_MCLK1:\n\t\treg = 0;\n\t\tbreak;\n\tcase WM8996_FLL_MCLK2:\n\t\treg = 1;\n\t\tbreak;\n\tcase WM8996_FLL_DACLRCLK1:\n\t\treg = 2;\n\t\tbreak;\n\tcase WM8996_FLL_BCLK1:\n\t\treg = 3;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"Unknown FLL source %d\\n\", ret);\n\t\treturn -EINVAL;\n\t}\n\n\treg |= fll_div.fll_refclk_div << WM8996_FLL_REFCLK_DIV_SHIFT;\n\treg |= fll_div.fll_ref_freq << WM8996_FLL_REF_FREQ_SHIFT;\n\n\tsnd_soc_component_update_bits(component, WM8996_FLL_CONTROL_5,\n\t\t\t    WM8996_FLL_REFCLK_DIV_MASK | WM8996_FLL_REF_FREQ |\n\t\t\t    WM8996_FLL_REFCLK_SRC_MASK, reg);\n\n\treg = 0;\n\tif (fll_div.theta || fll_div.lambda)\n\t\treg |= WM8996_FLL_EFS_ENA | (3 << WM8996_FLL_LFSR_SEL_SHIFT);\n\telse\n\t\treg |= 1 << WM8996_FLL_LFSR_SEL_SHIFT;\n\tsnd_soc_component_write(component, WM8996_FLL_EFS_2, reg);\n\n\tsnd_soc_component_update_bits(component, WM8996_FLL_CONTROL_2,\n\t\t\t    WM8996_FLL_OUTDIV_MASK |\n\t\t\t    WM8996_FLL_FRATIO_MASK,\n\t\t\t    (fll_div.fll_outdiv << WM8996_FLL_OUTDIV_SHIFT) |\n\t\t\t    (fll_div.fll_fratio));\n\n\tsnd_soc_component_write(component, WM8996_FLL_CONTROL_3, fll_div.theta);\n\n\tsnd_soc_component_update_bits(component, WM8996_FLL_CONTROL_4,\n\t\t\t    WM8996_FLL_N_MASK | WM8996_FLL_LOOP_GAIN_MASK,\n\t\t\t    (fll_div.n << WM8996_FLL_N_SHIFT) |\n\t\t\t    fll_div.fll_loop_gain);\n\n\tsnd_soc_component_write(component, WM8996_FLL_EFS_1, fll_div.lambda);\n\n\t \n\tret = snd_soc_component_read(component, WM8996_FLL_CONTROL_1);\n\tif (!(ret & WM8996_FLL_ENA))\n\t\twm8996_bg_enable(component);\n\n\t \n\ttry_wait_for_completion(&wm8996->fll_lock);\n\n\tsnd_soc_component_update_bits(component, WM8996_FLL_CONTROL_1,\n\t\t\t    WM8996_FLL_ENA, WM8996_FLL_ENA);\n\n\t \n\tsnd_soc_component_write(component, WM8996_FLL_CONTROL_6, WM8996_FLL_SWITCH_CLK);\n\n\t \n\tif (Fref > 1000000)\n\t\ttimeout = usecs_to_jiffies(300);\n\telse\n\t\ttimeout = msecs_to_jiffies(2);\n\n\t \n\tif (i2c->irq)\n\t\ttimeout *= 10;\n\telse\n\t\t \n\t\ttimeout = (timeout/2) ? : 1;\n\n\tfor (retry = 0; retry < 10; retry++) {\n\t\ttime_left = wait_for_completion_timeout(&wm8996->fll_lock,\n\t\t\t\t\t\t\ttimeout);\n\t\tif (time_left != 0) {\n\t\t\tWARN_ON(!i2c->irq);\n\t\t\tret = 1;\n\t\t\tbreak;\n\t\t}\n\n\t\tret = snd_soc_component_read(component, WM8996_INTERRUPT_RAW_STATUS_2);\n\t\tif (ret & WM8996_FLL_LOCK_STS)\n\t\t\tbreak;\n\t}\n\tif (retry == 10) {\n\t\tdev_err(component->dev, \"Timed out waiting for FLL\\n\");\n\t\tret = -ETIMEDOUT;\n\t}\n\n\tdev_dbg(component->dev, \"FLL configured for %dHz->%dHz\\n\", Fref, Fout);\n\n\twm8996->fll_fref = Fref;\n\twm8996->fll_fout = Fout;\n\twm8996->fll_src = source;\n\n\treturn ret;\n}\n\n#ifdef CONFIG_GPIOLIB\nstatic void wm8996_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\n{\n\tstruct wm8996_priv *wm8996 = gpiochip_get_data(chip);\n\n\tregmap_update_bits(wm8996->regmap, WM8996_GPIO_1 + offset,\n\t\t\t   WM8996_GP1_LVL, !!value << WM8996_GP1_LVL_SHIFT);\n}\n\nstatic int wm8996_gpio_direction_out(struct gpio_chip *chip,\n\t\t\t\t     unsigned offset, int value)\n{\n\tstruct wm8996_priv *wm8996 = gpiochip_get_data(chip);\n\tint val;\n\n\tval = (1 << WM8996_GP1_FN_SHIFT) | (!!value << WM8996_GP1_LVL_SHIFT);\n\n\treturn regmap_update_bits(wm8996->regmap, WM8996_GPIO_1 + offset,\n\t\t\t\t  WM8996_GP1_FN_MASK | WM8996_GP1_DIR |\n\t\t\t\t  WM8996_GP1_LVL, val);\n}\n\nstatic int wm8996_gpio_get(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct wm8996_priv *wm8996 = gpiochip_get_data(chip);\n\tunsigned int reg;\n\tint ret;\n\n\tret = regmap_read(wm8996->regmap, WM8996_GPIO_1 + offset, &reg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn (reg & WM8996_GP1_LVL) != 0;\n}\n\nstatic int wm8996_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct wm8996_priv *wm8996 = gpiochip_get_data(chip);\n\n\treturn regmap_update_bits(wm8996->regmap, WM8996_GPIO_1 + offset,\n\t\t\t\t  WM8996_GP1_FN_MASK | WM8996_GP1_DIR,\n\t\t\t\t  (1 << WM8996_GP1_FN_SHIFT) |\n\t\t\t\t  (1 << WM8996_GP1_DIR_SHIFT));\n}\n\nstatic const struct gpio_chip wm8996_template_chip = {\n\t.label\t\t\t= \"wm8996\",\n\t.owner\t\t\t= THIS_MODULE,\n\t.direction_output\t= wm8996_gpio_direction_out,\n\t.set\t\t\t= wm8996_gpio_set,\n\t.direction_input\t= wm8996_gpio_direction_in,\n\t.get\t\t\t= wm8996_gpio_get,\n\t.can_sleep\t\t= 1,\n};\n\nstatic void wm8996_init_gpio(struct wm8996_priv *wm8996)\n{\n\tint ret;\n\n\twm8996->gpio_chip = wm8996_template_chip;\n\twm8996->gpio_chip.ngpio = 5;\n\twm8996->gpio_chip.parent = wm8996->dev;\n\n\tif (wm8996->pdata.gpio_base)\n\t\twm8996->gpio_chip.base = wm8996->pdata.gpio_base;\n\telse\n\t\twm8996->gpio_chip.base = -1;\n\n\tret = gpiochip_add_data(&wm8996->gpio_chip, wm8996);\n\tif (ret != 0)\n\t\tdev_err(wm8996->dev, \"Failed to add GPIOs: %d\\n\", ret);\n}\n\nstatic void wm8996_free_gpio(struct wm8996_priv *wm8996)\n{\n\tgpiochip_remove(&wm8996->gpio_chip);\n}\n#else\nstatic void wm8996_init_gpio(struct wm8996_priv *wm8996)\n{\n}\n\nstatic void wm8996_free_gpio(struct wm8996_priv *wm8996)\n{\n}\n#endif\n\n \nint wm8996_detect(struct snd_soc_component *component, struct snd_soc_jack *jack,\n\t\t  wm8996_polarity_fn polarity_cb)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\n\twm8996->jack = jack;\n\twm8996->detecting = true;\n\twm8996->polarity_cb = polarity_cb;\n\twm8996->jack_flips = 0;\n\n\tif (wm8996->polarity_cb)\n\t\twm8996->polarity_cb(component, 0);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_MICBIAS_1,\n\t\t\t    WM8996_MICB1_DISCH, 0);\n\tsnd_soc_component_update_bits(component, WM8996_MICBIAS_2,\n\t\t\t    WM8996_MICB2_DISCH, 0);\n\n\t \n\tsnd_soc_dapm_mutex_lock(dapm);\n\n\tsnd_soc_dapm_force_enable_pin_unlocked(dapm, \"LDO2\");\n\tsnd_soc_dapm_force_enable_pin_unlocked(dapm, \"SYSCLK\");\n\n\tsnd_soc_dapm_mutex_unlock(dapm);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1,\n\t\t\t    WM8996_MICD_ENA, WM8996_MICD_ENA);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1,\n\t\t\t    WM8996_MICD_RATE_MASK,\n\t\t\t    WM8996_MICD_RATE_MASK);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_INTERRUPT_STATUS_2_MASK,\n\t\t\t    WM8996_IM_MICD_EINT | WM8996_HP_DONE_EINT, 0);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(wm8996_detect);\n\nstatic void wm8996_hpdet_irq(struct snd_soc_component *component)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint val, reg, report;\n\n\t \n\treport = SND_JACK_HEADPHONE;\n\n\treg = snd_soc_component_read(component, WM8996_HEADPHONE_DETECT_2);\n\tif (reg < 0) {\n\t\tdev_err(component->dev, \"Failed to read HPDET status\\n\");\n\t\tgoto out;\n\t}\n\n\tif (!(reg & WM8996_HP_DONE)) {\n\t\tdev_err(component->dev, \"Got HPDET IRQ but HPDET is busy\\n\");\n\t\tgoto out;\n\t}\n\n\tval = reg & WM8996_HP_LVL_MASK;\n\n\tdev_dbg(component->dev, \"HPDET measured %d ohms\\n\", val);\n\n\t \n\tif (val >= 126)\n\t\treport = SND_JACK_LINEOUT;\n\telse\n\t\treport = SND_JACK_HEADPHONE;\n\nout:\n\tif (wm8996->jack_mic)\n\t\treport |= SND_JACK_MICROPHONE;\n\n\tsnd_soc_jack_report(wm8996->jack, report,\n\t\t\t    SND_JACK_LINEOUT | SND_JACK_HEADSET);\n\n\twm8996->detecting = false;\n\n\t \n\tif (!(snd_soc_component_read(component, WM8996_POWER_MANAGEMENT_1) &\n\t      (WM8996_HPOUT1L_ENA | WM8996_HPOUT1R_RMV_SHORT)))\n\t\tsnd_soc_component_update_bits(component, WM8996_ANALOGUE_HP_1,\n\t\t\t\t    WM8996_HPOUT1L_RMV_SHORT |\n\t\t\t\t    WM8996_HPOUT1R_RMV_SHORT, 0);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_ACCESSORY_DETECT_MODE_1,\n\t\t\t    WM8996_JD_MODE_MASK, 0);\n\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1, WM8996_MICD_ENA,\n\t\t\t    WM8996_MICD_ENA);\n\n\tsnd_soc_dapm_disable_pin(dapm, \"Bandgap\");\n\tsnd_soc_dapm_sync(dapm);\n}\n\nstatic void wm8996_hpdet_start(struct snd_soc_component *component)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_ANALOGUE_HP_1,\n\t\t\t    WM8996_HPOUT1L_RMV_SHORT |\n\t\t\t    WM8996_HPOUT1R_RMV_SHORT,\n\t\t\t    WM8996_HPOUT1L_RMV_SHORT |\n\t\t\t    WM8996_HPOUT1R_RMV_SHORT);\n\n\t \n\tsnd_soc_dapm_force_enable_pin(dapm, \"Bandgap\");\n\tsnd_soc_dapm_sync(dapm);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1, WM8996_MICD_ENA, 0);\n\tsnd_soc_component_update_bits(component, WM8996_ACCESSORY_DETECT_MODE_1,\n\t\t\t    WM8996_JD_MODE_MASK, 1);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_HEADPHONE_DETECT_1,\n\t\t\t    WM8996_HP_POLL, WM8996_HP_POLL);\n}\n\nstatic void wm8996_report_headphone(struct snd_soc_component *component)\n{\n\tdev_dbg(component->dev, \"Headphone detected\\n\");\n\twm8996_hpdet_start(component);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1,\n\t\t\t    WM8996_MICD_RATE_MASK |\n\t\t\t    WM8996_MICD_BIAS_STARTTIME_MASK,\n\t\t\t    7 << WM8996_MICD_RATE_SHIFT |\n\t\t\t    7 << WM8996_MICD_BIAS_STARTTIME_SHIFT);\n}\n\nstatic void wm8996_micd(struct snd_soc_component *component)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint val, reg;\n\n\tval = snd_soc_component_read(component, WM8996_MIC_DETECT_3);\n\n\tdev_dbg(component->dev, \"Microphone event: %x\\n\", val);\n\n\tif (!(val & WM8996_MICD_VALID)) {\n\t\tdev_warn(component->dev, \"Microphone detection state invalid\\n\");\n\t\treturn;\n\t}\n\n\t \n\tif (!(val & WM8996_MICD_STS)) {\n\t\tdev_dbg(component->dev, \"Jack removal detected\\n\");\n\t\twm8996->jack_mic = false;\n\t\twm8996->detecting = true;\n\t\twm8996->jack_flips = 0;\n\t\tsnd_soc_jack_report(wm8996->jack, 0,\n\t\t\t\t    SND_JACK_LINEOUT | SND_JACK_HEADSET |\n\t\t\t\t    SND_JACK_BTN_0);\n\n\t\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1,\n\t\t\t\t    WM8996_MICD_RATE_MASK |\n\t\t\t\t    WM8996_MICD_BIAS_STARTTIME_MASK,\n\t\t\t\t    WM8996_MICD_RATE_MASK |\n\t\t\t\t    9 << WM8996_MICD_BIAS_STARTTIME_SHIFT);\n\t\treturn;\n\t}\n\n\t \n\tif (val & 0x400) {\n\t\tif (wm8996->detecting) {\n\t\t\tdev_dbg(component->dev, \"Microphone detected\\n\");\n\t\t\twm8996->jack_mic = true;\n\t\t\twm8996_hpdet_start(component);\n\n\t\t\t \n\t\t\tsnd_soc_component_update_bits(component, WM8996_MIC_DETECT_1,\n\t\t\t\t\t    WM8996_MICD_RATE_MASK |\n\t\t\t\t\t    WM8996_MICD_BIAS_STARTTIME_MASK,\n\t\t\t\t\t    5 << WM8996_MICD_RATE_SHIFT |\n\t\t\t\t\t    7 << WM8996_MICD_BIAS_STARTTIME_SHIFT);\n\t\t} else {\n\t\t\tdev_dbg(component->dev, \"Mic button up\\n\");\n\t\t\tsnd_soc_jack_report(wm8996->jack, 0, SND_JACK_BTN_0);\n\t\t}\n\n\t\treturn;\n\t}\n\n\t \n\tif (wm8996->detecting && (val & 0x3f0)) {\n\t\twm8996->jack_flips++;\n\n\t\tif (wm8996->jack_flips > 1) {\n\t\t\twm8996_report_headphone(component);\n\t\t\treturn;\n\t\t}\n\n\t\treg = snd_soc_component_read(component, WM8996_ACCESSORY_DETECT_MODE_2);\n\t\treg ^= WM8996_HPOUT1FB_SRC | WM8996_MICD_SRC |\n\t\t\tWM8996_MICD_BIAS_SRC;\n\t\tsnd_soc_component_update_bits(component, WM8996_ACCESSORY_DETECT_MODE_2,\n\t\t\t\t    WM8996_HPOUT1FB_SRC | WM8996_MICD_SRC |\n\t\t\t\t    WM8996_MICD_BIAS_SRC, reg);\n\n\t\tif (wm8996->polarity_cb)\n\t\t\twm8996->polarity_cb(component,\n\t\t\t\t\t    (reg & WM8996_MICD_SRC) != 0);\n\n\t\tdev_dbg(component->dev, \"Set microphone polarity to %d\\n\",\n\t\t\t(reg & WM8996_MICD_SRC) != 0);\n\n\t\treturn;\n\t}\n\n\t \n\tif (val & 0x3fc) {\n\t\tif (wm8996->jack_mic) {\n\t\t\tdev_dbg(component->dev, \"Mic button detected\\n\");\n\t\t\tsnd_soc_jack_report(wm8996->jack, SND_JACK_BTN_0,\n\t\t\t\t\t    SND_JACK_BTN_0);\n\t\t} else if (wm8996->detecting) {\n\t\t\twm8996_report_headphone(component);\n\t\t}\n\t}\n}\n\nstatic irqreturn_t wm8996_irq(int irq, void *data)\n{\n\tstruct snd_soc_component *component = data;\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tint irq_val;\n\n\tirq_val = snd_soc_component_read(component, WM8996_INTERRUPT_STATUS_2);\n\tif (irq_val < 0) {\n\t\tdev_err(component->dev, \"Failed to read IRQ status: %d\\n\",\n\t\t\tirq_val);\n\t\treturn IRQ_NONE;\n\t}\n\tirq_val &= ~snd_soc_component_read(component, WM8996_INTERRUPT_STATUS_2_MASK);\n\n\tif (!irq_val)\n\t\treturn IRQ_NONE;\n\n\tsnd_soc_component_write(component, WM8996_INTERRUPT_STATUS_2, irq_val);\n\n\tif (irq_val & (WM8996_DCS_DONE_01_EINT | WM8996_DCS_DONE_23_EINT)) {\n\t\tdev_dbg(component->dev, \"DC servo IRQ\\n\");\n\t\tcomplete(&wm8996->dcs_done);\n\t}\n\n\tif (irq_val & WM8996_FIFOS_ERR_EINT)\n\t\tdev_err(component->dev, \"Digital core FIFO error\\n\");\n\n\tif (irq_val & WM8996_FLL_LOCK_EINT) {\n\t\tdev_dbg(component->dev, \"FLL locked\\n\");\n\t\tcomplete(&wm8996->fll_lock);\n\t}\n\n\tif (irq_val & WM8996_MICD_EINT)\n\t\twm8996_micd(component);\n\n\tif (irq_val & WM8996_HP_DONE_EINT)\n\t\twm8996_hpdet_irq(component);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t wm8996_edge_irq(int irq, void *data)\n{\n\tirqreturn_t ret = IRQ_NONE;\n\tirqreturn_t val;\n\n\tdo {\n\t\tval = wm8996_irq(irq, data);\n\t\tif (val != IRQ_NONE)\n\t\t\tret = val;\n\t} while (val != IRQ_NONE);\n\n\treturn ret;\n}\n\nstatic void wm8996_retune_mobile_pdata(struct snd_soc_component *component)\n{\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tstruct wm8996_pdata *pdata = &wm8996->pdata;\n\n\tstruct snd_kcontrol_new controls[] = {\n\t\tSOC_ENUM_EXT(\"DSP1 EQ Mode\",\n\t\t\t     wm8996->retune_mobile_enum,\n\t\t\t     wm8996_get_retune_mobile_enum,\n\t\t\t     wm8996_put_retune_mobile_enum),\n\t\tSOC_ENUM_EXT(\"DSP2 EQ Mode\",\n\t\t\t     wm8996->retune_mobile_enum,\n\t\t\t     wm8996_get_retune_mobile_enum,\n\t\t\t     wm8996_put_retune_mobile_enum),\n\t};\n\tint ret, i, j;\n\tconst char **t;\n\n\t \n\twm8996->num_retune_mobile_texts = 0;\n\twm8996->retune_mobile_texts = NULL;\n\tfor (i = 0; i < pdata->num_retune_mobile_cfgs; i++) {\n\t\tfor (j = 0; j < wm8996->num_retune_mobile_texts; j++) {\n\t\t\tif (strcmp(pdata->retune_mobile_cfgs[i].name,\n\t\t\t\t   wm8996->retune_mobile_texts[j]) == 0)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (j != wm8996->num_retune_mobile_texts)\n\t\t\tcontinue;\n\n\t\t \n\t\tt = krealloc(wm8996->retune_mobile_texts,\n\t\t\t     sizeof(char *) * \n\t\t\t     (wm8996->num_retune_mobile_texts + 1),\n\t\t\t     GFP_KERNEL);\n\t\tif (t == NULL)\n\t\t\tcontinue;\n\n\t\t \n\t\tt[wm8996->num_retune_mobile_texts] = \n\t\t\tpdata->retune_mobile_cfgs[i].name;\n\n\t\t \n\t\twm8996->num_retune_mobile_texts++;\n\t\twm8996->retune_mobile_texts = t;\n\t}\n\n\tdev_dbg(component->dev, \"Allocated %d unique ReTune Mobile names\\n\",\n\t\twm8996->num_retune_mobile_texts);\n\n\twm8996->retune_mobile_enum.items = wm8996->num_retune_mobile_texts;\n\twm8996->retune_mobile_enum.texts = wm8996->retune_mobile_texts;\n\n\tret = snd_soc_add_component_controls(component, controls, ARRAY_SIZE(controls));\n\tif (ret != 0)\n\t\tdev_err(component->dev,\n\t\t\t\"Failed to add ReTune Mobile controls: %d\\n\", ret);\n}\n\nstatic const struct regmap_config wm8996_regmap = {\n\t.reg_bits = 16,\n\t.val_bits = 16,\n\n\t.max_register = WM8996_MAX_REGISTER,\n\t.reg_defaults = wm8996_reg,\n\t.num_reg_defaults = ARRAY_SIZE(wm8996_reg),\n\t.volatile_reg = wm8996_volatile_register,\n\t.readable_reg = wm8996_readable_register,\n\t.cache_type = REGCACHE_MAPLE,\n};\n\nstatic int wm8996_probe(struct snd_soc_component *component)\n{\n\tint ret;\n\tstruct wm8996_priv *wm8996 = snd_soc_component_get_drvdata(component);\n\tstruct i2c_client *i2c = to_i2c_client(component->dev);\n\tint irq_flags;\n\n\twm8996->component = component;\n\n\tinit_completion(&wm8996->dcs_done);\n\tinit_completion(&wm8996->fll_lock);\n\n\tif (wm8996->pdata.num_retune_mobile_cfgs)\n\t\twm8996_retune_mobile_pdata(component);\n\telse\n\t\tsnd_soc_add_component_controls(component, wm8996_eq_controls,\n\t\t\t\t     ARRAY_SIZE(wm8996_eq_controls));\n\n\tif (i2c->irq) {\n\t\tif (wm8996->pdata.irq_flags)\n\t\t\tirq_flags = wm8996->pdata.irq_flags;\n\t\telse\n\t\t\tirq_flags = IRQF_TRIGGER_LOW;\n\n\t\tirq_flags |= IRQF_ONESHOT;\n\n\t\tif (irq_flags & (IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING))\n\t\t\tret = request_threaded_irq(i2c->irq, NULL,\n\t\t\t\t\t\t   wm8996_edge_irq,\n\t\t\t\t\t\t   irq_flags, \"wm8996\", component);\n\t\telse\n\t\t\tret = request_threaded_irq(i2c->irq, NULL, wm8996_irq,\n\t\t\t\t\t\t   irq_flags, \"wm8996\", component);\n\n\t\tif (ret == 0) {\n\t\t\t \n\t\t\tsnd_soc_component_update_bits(component, WM8996_INTERRUPT_CONTROL,\n\t\t\t\t\t    WM8996_IM_IRQ, 0);\n\n\t\t\t \n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t    WM8996_INTERRUPT_STATUS_2_MASK,\n\t\t\t\t\t    WM8996_IM_DCS_DONE_23_EINT |\n\t\t\t\t\t    WM8996_IM_DCS_DONE_01_EINT |\n\t\t\t\t\t    WM8996_IM_FLL_LOCK_EINT |\n\t\t\t\t\t    WM8996_IM_FIFOS_ERR_EINT,\n\t\t\t\t\t    0);\n\t\t} else {\n\t\t\tdev_err(component->dev, \"Failed to request IRQ: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void wm8996_remove(struct snd_soc_component *component)\n{\n\tstruct i2c_client *i2c = to_i2c_client(component->dev);\n\n\tsnd_soc_component_update_bits(component, WM8996_INTERRUPT_CONTROL,\n\t\t\t    WM8996_IM_IRQ, WM8996_IM_IRQ);\n\n\tif (i2c->irq)\n\t\tfree_irq(i2c->irq, component);\n}\n\nstatic const struct snd_soc_component_driver soc_component_dev_wm8996 = {\n\t.probe\t\t\t= wm8996_probe,\n\t.remove\t\t\t= wm8996_remove,\n\t.set_bias_level\t\t= wm8996_set_bias_level,\n\t.seq_notifier\t\t= wm8996_seq_notifier,\n\t.controls\t\t= wm8996_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(wm8996_snd_controls),\n\t.dapm_widgets\t\t= wm8996_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(wm8996_dapm_widgets),\n\t.dapm_routes\t\t= wm8996_dapm_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(wm8996_dapm_routes),\n\t.set_pll\t\t= wm8996_set_fll,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\n#define WM8996_RATES (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_16000 |\\\n\t\t      SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 |\\\n\t\t      SNDRV_PCM_RATE_48000)\n#define WM8996_FORMATS (SNDRV_PCM_FMTBIT_S8 | SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S20_3LE | SNDRV_PCM_FMTBIT_S24_LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S32_LE)\n\nstatic const struct snd_soc_dai_ops wm8996_dai_ops = {\n\t.set_fmt = wm8996_set_fmt,\n\t.hw_params = wm8996_hw_params,\n\t.set_sysclk = wm8996_set_sysclk,\n};\n\nstatic struct snd_soc_dai_driver wm8996_dai[] = {\n\t{\n\t\t.name = \"wm8996-aif1\",\n\t\t.playback = {\n\t\t\t.stream_name = \"AIF1 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 6,\n\t\t\t.rates = WM8996_RATES,\n\t\t\t.formats = WM8996_FORMATS,\n\t\t\t.sig_bits = 24,\n\t\t},\n\t\t.capture = {\n\t\t\t .stream_name = \"AIF1 Capture\",\n\t\t\t .channels_min = 1,\n\t\t\t .channels_max = 6,\n\t\t\t .rates = WM8996_RATES,\n\t\t\t .formats = WM8996_FORMATS,\n\t\t\t .sig_bits = 24,\n\t\t },\n\t\t.ops = &wm8996_dai_ops,\n\t},\n\t{\n\t\t.name = \"wm8996-aif2\",\n\t\t.playback = {\n\t\t\t.stream_name = \"AIF2 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = WM8996_RATES,\n\t\t\t.formats = WM8996_FORMATS,\n\t\t\t.sig_bits = 24,\n\t\t},\n\t\t.capture = {\n\t\t\t .stream_name = \"AIF2 Capture\",\n\t\t\t .channels_min = 1,\n\t\t\t .channels_max = 2,\n\t\t\t .rates = WM8996_RATES,\n\t\t\t .formats = WM8996_FORMATS,\n\t\t\t.sig_bits = 24,\n\t\t },\n\t\t.ops = &wm8996_dai_ops,\n\t},\n};\n\nstatic int wm8996_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct wm8996_priv *wm8996;\n\tint ret, i;\n\tunsigned int reg;\n\n\twm8996 = devm_kzalloc(&i2c->dev, sizeof(struct wm8996_priv),\n\t\t\t      GFP_KERNEL);\n\tif (wm8996 == NULL)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(i2c, wm8996);\n\twm8996->dev = &i2c->dev;\n\n\tif (dev_get_platdata(&i2c->dev))\n\t\tmemcpy(&wm8996->pdata, dev_get_platdata(&i2c->dev),\n\t\t       sizeof(wm8996->pdata));\n\n\tif (wm8996->pdata.ldo_ena > 0) {\n\t\tret = gpio_request_one(wm8996->pdata.ldo_ena,\n\t\t\t\t       GPIOF_OUT_INIT_LOW, \"WM8996 ENA\");\n\t\tif (ret < 0) {\n\t\t\tdev_err(&i2c->dev, \"Failed to request GPIO %d: %d\\n\",\n\t\t\t\twm8996->pdata.ldo_ena, ret);\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(wm8996->supplies); i++)\n\t\twm8996->supplies[i].supply = wm8996_supply_names[i];\n\n\tret = devm_regulator_bulk_get(&i2c->dev, ARRAY_SIZE(wm8996->supplies),\n\t\t\t\t      wm8996->supplies);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"Failed to request supplies: %d\\n\", ret);\n\t\tgoto err_gpio;\n\t}\n\n\twm8996->disable_nb[0].notifier_call = wm8996_regulator_event_0;\n\twm8996->disable_nb[1].notifier_call = wm8996_regulator_event_1;\n\twm8996->disable_nb[2].notifier_call = wm8996_regulator_event_2;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(wm8996->supplies); i++) {\n\t\tret = devm_regulator_register_notifier(\n\t\t\t\t\t\twm8996->supplies[i].consumer,\n\t\t\t\t\t\t&wm8996->disable_nb[i]);\n\t\tif (ret != 0) {\n\t\t\tdev_err(&i2c->dev,\n\t\t\t\t\"Failed to register regulator notifier: %d\\n\",\n\t\t\t\tret);\n\t\t}\n\t}\n\n\tret = regulator_bulk_enable(ARRAY_SIZE(wm8996->supplies),\n\t\t\t\t    wm8996->supplies);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"Failed to enable supplies: %d\\n\", ret);\n\t\tgoto err_gpio;\n\t}\n\n\tif (wm8996->pdata.ldo_ena > 0) {\n\t\tgpio_set_value_cansleep(wm8996->pdata.ldo_ena, 1);\n\t\tmsleep(5);\n\t}\n\n\twm8996->regmap = devm_regmap_init_i2c(i2c, &wm8996_regmap);\n\tif (IS_ERR(wm8996->regmap)) {\n\t\tret = PTR_ERR(wm8996->regmap);\n\t\tdev_err(&i2c->dev, \"regmap_init() failed: %d\\n\", ret);\n\t\tgoto err_enable;\n\t}\n\n\tret = regmap_read(wm8996->regmap, WM8996_SOFTWARE_RESET, &reg);\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"Failed to read ID register: %d\\n\", ret);\n\t\tgoto err_regmap;\n\t}\n\tif (reg != 0x8915) {\n\t\tdev_err(&i2c->dev, \"Device is not a WM8996, ID %x\\n\", reg);\n\t\tret = -EINVAL;\n\t\tgoto err_regmap;\n\t}\n\n\tret = regmap_read(wm8996->regmap, WM8996_CHIP_REVISION, &reg);\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"Failed to read device revision: %d\\n\",\n\t\t\tret);\n\t\tgoto err_regmap;\n\t}\n\n\tdev_info(&i2c->dev, \"revision %c\\n\",\n\t\t (reg & WM8996_CHIP_REV_MASK) + 'A');\n\n\tif (wm8996->pdata.ldo_ena > 0) {\n\t\tgpio_set_value_cansleep(wm8996->pdata.ldo_ena, 0);\n\t\tregcache_cache_only(wm8996->regmap, true);\n\t} else {\n\t\tret = regmap_write(wm8996->regmap, WM8996_SOFTWARE_RESET,\n\t\t\t\t   0x8915);\n\t\tif (ret != 0) {\n\t\t\tdev_err(&i2c->dev, \"Failed to issue reset: %d\\n\", ret);\n\t\t\tgoto err_regmap;\n\t\t}\n\t}\n\n\tregulator_bulk_disable(ARRAY_SIZE(wm8996->supplies), wm8996->supplies);\n\n\t \n\tregmap_update_bits(wm8996->regmap, WM8996_LINE_INPUT_CONTROL,\n\t\t\t   WM8996_INL_MODE_MASK | WM8996_INR_MODE_MASK,\n\t\t\t   wm8996->pdata.inl_mode << WM8996_INL_MODE_SHIFT |\n\t\t\t   wm8996->pdata.inr_mode);\n\n\tfor (i = 0; i < ARRAY_SIZE(wm8996->pdata.gpio_default); i++) {\n\t\tif (!wm8996->pdata.gpio_default[i])\n\t\t\tcontinue;\n\n\t\tregmap_write(wm8996->regmap, WM8996_GPIO_1 + i,\n\t\t\t     wm8996->pdata.gpio_default[i] & 0xffff);\n\t}\n\n\tif (wm8996->pdata.spkmute_seq)\n\t\tregmap_update_bits(wm8996->regmap,\n\t\t\t\t   WM8996_PDM_SPEAKER_MUTE_SEQUENCE,\n\t\t\t\t   WM8996_SPK_MUTE_ENDIAN |\n\t\t\t\t   WM8996_SPK_MUTE_SEQ1_MASK,\n\t\t\t\t   wm8996->pdata.spkmute_seq);\n\n\tregmap_update_bits(wm8996->regmap, WM8996_ACCESSORY_DETECT_MODE_2,\n\t\t\t   WM8996_MICD_BIAS_SRC | WM8996_HPOUT1FB_SRC |\n\t\t\t   WM8996_MICD_SRC, wm8996->pdata.micdet_def);\n\n\t \n\tregmap_update_bits(wm8996->regmap, WM8996_LEFT_LINE_INPUT_VOLUME,\n\t\t\t   WM8996_IN1_VU, WM8996_IN1_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_RIGHT_LINE_INPUT_VOLUME,\n\t\t\t   WM8996_IN1_VU, WM8996_IN1_VU);\n\n\tregmap_update_bits(wm8996->regmap, WM8996_DAC1_LEFT_VOLUME,\n\t\t\t   WM8996_DAC1_VU, WM8996_DAC1_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DAC1_RIGHT_VOLUME,\n\t\t\t   WM8996_DAC1_VU, WM8996_DAC1_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DAC2_LEFT_VOLUME,\n\t\t\t   WM8996_DAC2_VU, WM8996_DAC2_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DAC2_RIGHT_VOLUME,\n\t\t\t   WM8996_DAC2_VU, WM8996_DAC2_VU);\n\n\tregmap_update_bits(wm8996->regmap, WM8996_OUTPUT1_LEFT_VOLUME,\n\t\t\t   WM8996_DAC1_VU, WM8996_DAC1_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_OUTPUT1_RIGHT_VOLUME,\n\t\t\t   WM8996_DAC1_VU, WM8996_DAC1_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_OUTPUT2_LEFT_VOLUME,\n\t\t\t   WM8996_DAC2_VU, WM8996_DAC2_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_OUTPUT2_RIGHT_VOLUME,\n\t\t\t   WM8996_DAC2_VU, WM8996_DAC2_VU);\n\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP1_TX_LEFT_VOLUME,\n\t\t\t   WM8996_DSP1TX_VU, WM8996_DSP1TX_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP1_TX_RIGHT_VOLUME,\n\t\t\t   WM8996_DSP1TX_VU, WM8996_DSP1TX_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP2_TX_LEFT_VOLUME,\n\t\t\t   WM8996_DSP2TX_VU, WM8996_DSP2TX_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP2_TX_RIGHT_VOLUME,\n\t\t\t   WM8996_DSP2TX_VU, WM8996_DSP2TX_VU);\n\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP1_RX_LEFT_VOLUME,\n\t\t\t   WM8996_DSP1RX_VU, WM8996_DSP1RX_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP1_RX_RIGHT_VOLUME,\n\t\t\t   WM8996_DSP1RX_VU, WM8996_DSP1RX_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP2_RX_LEFT_VOLUME,\n\t\t\t   WM8996_DSP2RX_VU, WM8996_DSP2RX_VU);\n\tregmap_update_bits(wm8996->regmap, WM8996_DSP2_RX_RIGHT_VOLUME,\n\t\t\t   WM8996_DSP2RX_VU, WM8996_DSP2RX_VU);\n\n\t \n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1RX_CHANNEL_0_CONFIGURATION,\n\t\t\t   WM8996_AIF1RX_CHAN0_SLOTS_MASK |\n\t\t\t   WM8996_AIF1RX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1RX_CHAN0_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1RX_CHANNEL_1_CONFIGURATION,\n\t\t\t   WM8996_AIF1RX_CHAN1_SLOTS_MASK |\n\t\t\t   WM8996_AIF1RX_CHAN1_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1RX_CHAN1_SLOTS_SHIFT | 1);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1RX_CHANNEL_2_CONFIGURATION,\n\t\t\t   WM8996_AIF1RX_CHAN2_SLOTS_MASK |\n\t\t\t   WM8996_AIF1RX_CHAN2_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1RX_CHAN2_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1RX_CHANNEL_3_CONFIGURATION,\n\t\t\t   WM8996_AIF1RX_CHAN3_SLOTS_MASK |\n\t\t\t   WM8996_AIF1RX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1RX_CHAN3_SLOTS_SHIFT | 1);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1RX_CHANNEL_4_CONFIGURATION,\n\t\t\t   WM8996_AIF1RX_CHAN4_SLOTS_MASK |\n\t\t\t   WM8996_AIF1RX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1RX_CHAN4_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1RX_CHANNEL_5_CONFIGURATION,\n\t\t\t   WM8996_AIF1RX_CHAN5_SLOTS_MASK |\n\t\t\t   WM8996_AIF1RX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1RX_CHAN5_SLOTS_SHIFT | 1);\n\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF2RX_CHANNEL_0_CONFIGURATION,\n\t\t\t   WM8996_AIF2RX_CHAN0_SLOTS_MASK |\n\t\t\t   WM8996_AIF2RX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF2RX_CHAN0_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF2RX_CHANNEL_1_CONFIGURATION,\n\t\t\t   WM8996_AIF2RX_CHAN1_SLOTS_MASK |\n\t\t\t   WM8996_AIF2RX_CHAN1_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF2RX_CHAN1_SLOTS_SHIFT | 1);\n\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_0_CONFIGURATION,\n\t\t\t   WM8996_AIF1TX_CHAN0_SLOTS_MASK |\n\t\t\t   WM8996_AIF1TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN0_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_1_CONFIGURATION,\n\t\t\t   WM8996_AIF1TX_CHAN1_SLOTS_MASK |\n\t\t\t   WM8996_AIF1TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN1_SLOTS_SHIFT | 1);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_2_CONFIGURATION,\n\t\t\t   WM8996_AIF1TX_CHAN2_SLOTS_MASK |\n\t\t\t   WM8996_AIF1TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN2_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_3_CONFIGURATION,\n\t\t\t   WM8996_AIF1TX_CHAN3_SLOTS_MASK |\n\t\t\t   WM8996_AIF1TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN3_SLOTS_SHIFT | 1);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_4_CONFIGURATION,\n\t\t\t   WM8996_AIF1TX_CHAN4_SLOTS_MASK |\n\t\t\t   WM8996_AIF1TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN4_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_5_CONFIGURATION,\n\t\t\t   WM8996_AIF1TX_CHAN5_SLOTS_MASK |\n\t\t\t   WM8996_AIF1TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN5_SLOTS_SHIFT | 1);\n\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF2TX_CHANNEL_0_CONFIGURATION,\n\t\t\t   WM8996_AIF2TX_CHAN0_SLOTS_MASK |\n\t\t\t   WM8996_AIF2TX_CHAN0_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF2TX_CHAN0_SLOTS_SHIFT | 0);\n\tregmap_update_bits(wm8996->regmap,\n\t\t\t   WM8996_AIF1TX_CHANNEL_1_CONFIGURATION,\n\t\t\t   WM8996_AIF2TX_CHAN1_SLOTS_MASK |\n\t\t\t   WM8996_AIF2TX_CHAN1_START_SLOT_MASK,\n\t\t\t   1 << WM8996_AIF1TX_CHAN1_SLOTS_SHIFT | 1);\n\n\t \n\tret = regmap_read(wm8996->regmap, WM8996_GPIO_1, &reg);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"Failed to read GPIO1: %d\\n\", ret);\n\t\tgoto err_regmap;\n\t}\n\n\tif (reg & WM8996_GP1_FN_MASK)\n\t\tregmap_update_bits(wm8996->regmap, WM8996_AIF1_TX_LRCLK_2,\n\t\t\t\t   WM8996_AIF1TX_LRCLK_MODE,\n\t\t\t\t   WM8996_AIF1TX_LRCLK_MODE);\n\n\tret = regmap_read(wm8996->regmap, WM8996_GPIO_2, &reg);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"Failed to read GPIO2: %d\\n\", ret);\n\t\tgoto err_regmap;\n\t}\n\n\tif (reg & WM8996_GP2_FN_MASK)\n\t\tregmap_update_bits(wm8996->regmap, WM8996_AIF2_TX_LRCLK_2,\n\t\t\t\t   WM8996_AIF2TX_LRCLK_MODE,\n\t\t\t\t   WM8996_AIF2TX_LRCLK_MODE);\n\n\twm8996_init_gpio(wm8996);\n\n\tret = devm_snd_soc_register_component(&i2c->dev,\n\t\t\t\t     &soc_component_dev_wm8996, wm8996_dai,\n\t\t\t\t     ARRAY_SIZE(wm8996_dai));\n\tif (ret < 0)\n\t\tgoto err_gpiolib;\n\n\treturn ret;\n\nerr_gpiolib:\n\twm8996_free_gpio(wm8996);\nerr_regmap:\nerr_enable:\n\tif (wm8996->pdata.ldo_ena > 0)\n\t\tgpio_set_value_cansleep(wm8996->pdata.ldo_ena, 0);\n\tregulator_bulk_disable(ARRAY_SIZE(wm8996->supplies), wm8996->supplies);\nerr_gpio:\n\tif (wm8996->pdata.ldo_ena > 0)\n\t\tgpio_free(wm8996->pdata.ldo_ena);\nerr:\n\n\treturn ret;\n}\n\nstatic void wm8996_i2c_remove(struct i2c_client *client)\n{\n\tstruct wm8996_priv *wm8996 = i2c_get_clientdata(client);\n\n\twm8996_free_gpio(wm8996);\n\tif (wm8996->pdata.ldo_ena > 0) {\n\t\tgpio_set_value_cansleep(wm8996->pdata.ldo_ena, 0);\n\t\tgpio_free(wm8996->pdata.ldo_ena);\n\t}\n}\n\nstatic const struct i2c_device_id wm8996_i2c_id[] = {\n\t{ \"wm8996\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, wm8996_i2c_id);\n\nstatic struct i2c_driver wm8996_i2c_driver = {\n\t.driver = {\n\t\t.name = \"wm8996\",\n\t},\n\t.probe =    wm8996_i2c_probe,\n\t.remove =   wm8996_i2c_remove,\n\t.id_table = wm8996_i2c_id,\n};\n\nmodule_i2c_driver(wm8996_i2c_driver);\n\nMODULE_DESCRIPTION(\"ASoC WM8996 driver\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}