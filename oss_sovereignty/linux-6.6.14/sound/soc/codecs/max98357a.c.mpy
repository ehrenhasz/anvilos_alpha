{
  "module_name": "max98357a.c",
  "hash_id": "b0c75af222d86e060697234094ef37975f7eac5819f82b20119364d9e4e6d5f1",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/max98357a.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/gpio.h>\n#include <linux/gpio/consumer.h>\n#include <linux/kernel.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n#include <sound/soc-dapm.h>\n\nstruct max98357a_priv {\n\tstruct gpio_desc *sdmode;\n\tunsigned int sdmode_delay;\n\tint sdmode_switch;\n};\n\nstatic int max98357a_daiops_trigger(struct snd_pcm_substream *substream,\n\t\tint cmd, struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct max98357a_priv *max98357a =\n\t\tsnd_soc_component_get_drvdata(component);\n\n\tif (!max98357a->sdmode)\n\t\treturn 0;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tmdelay(max98357a->sdmode_delay);\n\t\tif (max98357a->sdmode_switch) {\n\t\t\tgpiod_set_value(max98357a->sdmode, 1);\n\t\t\tdev_dbg(component->dev, \"set sdmode to 1\");\n\t\t}\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tgpiod_set_value(max98357a->sdmode, 0);\n\t\tdev_dbg(component->dev, \"set sdmode to 0\");\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int max98357a_sdmode_event(struct snd_soc_dapm_widget *w,\n\t\tstruct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component =\n\t\tsnd_soc_dapm_to_component(w->dapm);\n\tstruct max98357a_priv *max98357a =\n\t\tsnd_soc_component_get_drvdata(component);\n\n\tif (event & SND_SOC_DAPM_POST_PMU)\n\t\tmax98357a->sdmode_switch = 1;\n\telse if (event & SND_SOC_DAPM_POST_PMD)\n\t\tmax98357a->sdmode_switch = 0;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dapm_widget max98357a_dapm_widgets[] = {\n\tSND_SOC_DAPM_OUTPUT(\"Speaker\"),\n\tSND_SOC_DAPM_OUT_DRV_E(\"SD_MODE\", SND_SOC_NOPM, 0, 0, NULL, 0,\n\t\t\tmax98357a_sdmode_event,\n\t\t\tSND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_POST_PMD),\n};\n\nstatic const struct snd_soc_dapm_route max98357a_dapm_routes[] = {\n\t{\"SD_MODE\", NULL, \"HiFi Playback\"},\n\t{\"Speaker\", NULL, \"SD_MODE\"},\n};\n\nstatic const struct snd_soc_component_driver max98357a_component_driver = {\n\t.dapm_widgets\t\t= max98357a_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(max98357a_dapm_widgets),\n\t.dapm_routes\t\t= max98357a_dapm_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(max98357a_dapm_routes),\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic const struct snd_soc_dai_ops max98357a_dai_ops = {\n\t.trigger        = max98357a_daiops_trigger,\n};\n\nstatic struct snd_soc_dai_driver max98357a_dai_driver = {\n\t.name = \"HiFi\",\n\t.playback = {\n\t\t.stream_name\t= \"HiFi Playback\",\n\t\t.formats\t= SNDRV_PCM_FMTBIT_S16 |\n\t\t\t\t\tSNDRV_PCM_FMTBIT_S24 |\n\t\t\t\t\tSNDRV_PCM_FMTBIT_S32,\n\t\t.rates\t\t= SNDRV_PCM_RATE_8000 |\n\t\t\t\t\tSNDRV_PCM_RATE_16000 |\n\t\t\t\t\tSNDRV_PCM_RATE_32000 |\n\t\t\t\t\tSNDRV_PCM_RATE_44100 |\n\t\t\t\t\tSNDRV_PCM_RATE_48000 |\n\t\t\t\t\tSNDRV_PCM_RATE_88200 |\n\t\t\t\t\tSNDRV_PCM_RATE_96000,\n\t\t.rate_min\t= 8000,\n\t\t.rate_max\t= 96000,\n\t\t.channels_min\t= 1,\n\t\t.channels_max\t= 2,\n\t},\n\t.ops    = &max98357a_dai_ops,\n};\n\nstatic int max98357a_platform_probe(struct platform_device *pdev)\n{\n\tstruct max98357a_priv *max98357a;\n\tint ret;\n\n\tmax98357a = devm_kzalloc(&pdev->dev, sizeof(*max98357a), GFP_KERNEL);\n\tif (!max98357a)\n\t\treturn -ENOMEM;\n\n\tmax98357a->sdmode = devm_gpiod_get_optional(&pdev->dev,\n\t\t\t\t\"sdmode\", GPIOD_OUT_LOW);\n\tif (IS_ERR(max98357a->sdmode))\n\t\treturn PTR_ERR(max98357a->sdmode);\n\n\tret = device_property_read_u32(&pdev->dev, \"sdmode-delay\",\n\t\t\t\t\t&max98357a->sdmode_delay);\n\tif (ret) {\n\t\tmax98357a->sdmode_delay = 0;\n\t\tdev_dbg(&pdev->dev,\n\t\t\t\"no optional property 'sdmode-delay' found, \"\n\t\t\t\"default: no delay\\n\");\n\t}\n\n\tdev_set_drvdata(&pdev->dev, max98357a);\n\n\treturn devm_snd_soc_register_component(&pdev->dev,\n\t\t\t&max98357a_component_driver,\n\t\t\t&max98357a_dai_driver, 1);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id max98357a_device_id[] = {\n\t{ .compatible = \"maxim,max98357a\" },\n\t{ .compatible = \"maxim,max98360a\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, max98357a_device_id);\n#endif\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id max98357a_acpi_match[] = {\n\t{ \"MX98357A\", 0 },\n\t{ \"MX98360A\", 0 },\n\t{},\n};\nMODULE_DEVICE_TABLE(acpi, max98357a_acpi_match);\n#endif\n\nstatic struct platform_driver max98357a_platform_driver = {\n\t.driver = {\n\t\t.name = \"max98357a\",\n\t\t.of_match_table = of_match_ptr(max98357a_device_id),\n\t\t.acpi_match_table = ACPI_PTR(max98357a_acpi_match),\n\t},\n\t.probe\t= max98357a_platform_probe,\n};\nmodule_platform_driver(max98357a_platform_driver);\n\nMODULE_DESCRIPTION(\"Maxim MAX98357A Codec Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}