{
  "module_name": "mt6358.c",
  "hash_id": "f94f148a2f1f607b5f2de43f236ce381fb5d42f0ce1d7e5082290b3f5c771ee9",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/mt6358.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/platform_device.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/delay.h>\n#include <linux/kthread.h>\n#include <linux/sched.h>\n#include <linux/mfd/mt6397/core.h>\n#include <linux/regulator/consumer.h>\n\n#include <sound/soc.h>\n#include <sound/tlv.h>\n\n#include \"mt6358.h\"\n\nenum {\n\tAUDIO_ANALOG_VOLUME_HSOUTL,\n\tAUDIO_ANALOG_VOLUME_HSOUTR,\n\tAUDIO_ANALOG_VOLUME_HPOUTL,\n\tAUDIO_ANALOG_VOLUME_HPOUTR,\n\tAUDIO_ANALOG_VOLUME_LINEOUTL,\n\tAUDIO_ANALOG_VOLUME_LINEOUTR,\n\tAUDIO_ANALOG_VOLUME_MICAMP1,\n\tAUDIO_ANALOG_VOLUME_MICAMP2,\n\tAUDIO_ANALOG_VOLUME_TYPE_MAX\n};\n\nenum {\n\tMUX_ADC_L,\n\tMUX_ADC_R,\n\tMUX_PGA_L,\n\tMUX_PGA_R,\n\tMUX_MIC_TYPE,\n\tMUX_HP_L,\n\tMUX_HP_R,\n\tMUX_NUM,\n};\n\nenum {\n\tDEVICE_HP,\n\tDEVICE_LO,\n\tDEVICE_RCV,\n\tDEVICE_MIC1,\n\tDEVICE_MIC2,\n\tDEVICE_NUM\n};\n\n \nenum {\n\t \n\tSUPPLY_SEQ_CLK_BUF,\n\tSUPPLY_SEQ_AUD_GLB,\n\tSUPPLY_SEQ_CLKSQ,\n\tSUPPLY_SEQ_VOW_AUD_LPW,\n\tSUPPLY_SEQ_AUD_VOW,\n\tSUPPLY_SEQ_VOW_CLK,\n\tSUPPLY_SEQ_VOW_LDO,\n\tSUPPLY_SEQ_TOP_CK,\n\tSUPPLY_SEQ_TOP_CK_LAST,\n\tSUPPLY_SEQ_AUD_TOP,\n\tSUPPLY_SEQ_AUD_TOP_LAST,\n\tSUPPLY_SEQ_AFE,\n\t \n\tSUPPLY_SEQ_ADC_SUPPLY,\n};\n\nenum {\n\tCH_L = 0,\n\tCH_R,\n\tNUM_CH,\n};\n\n#define REG_STRIDE 2\n\nstruct mt6358_priv {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\n\tunsigned int dl_rate;\n\tunsigned int ul_rate;\n\n\tint ana_gain[AUDIO_ANALOG_VOLUME_TYPE_MAX];\n\tunsigned int mux_select[MUX_NUM];\n\n\tint dev_counter[DEVICE_NUM];\n\n\tint mtkaif_protocol;\n\n\tstruct regulator *avdd_reg;\n\n\tint wov_enabled;\n\n\tunsigned int dmic_one_wire_mode;\n};\n\nint mt6358_set_mtkaif_protocol(struct snd_soc_component *cmpnt,\n\t\t\t       int mtkaif_protocol)\n{\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tpriv->mtkaif_protocol = mtkaif_protocol;\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt6358_set_mtkaif_protocol);\n\nstatic void playback_gpio_set(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE2_CLR,\n\t\t\t   0x01f8, 0x01f8);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE2_SET,\n\t\t\t   0xffff, 0x0249);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE2,\n\t\t\t   0xffff, 0x0249);\n}\n\nstatic void playback_gpio_reset(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE2_CLR,\n\t\t\t   0x01f8, 0x01f8);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE2,\n\t\t\t   0x01f8, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_DIR0,\n\t\t\t   0xf << 8, 0x0);\n}\n\nstatic void capture_gpio_set(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3_CLR,\n\t\t\t   0xffff, 0xffff);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3_SET,\n\t\t\t   0xffff, 0x0249);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3,\n\t\t\t   0xffff, 0x0249);\n}\n\nstatic void capture_gpio_reset(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3_CLR,\n\t\t\t   0xffff, 0xffff);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3,\n\t\t\t   0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_DIR0,\n\t\t\t   0xf << 12, 0x0);\n}\n\n \nstatic int mt6358_set_dcxo(struct mt6358_priv *priv, bool enable)\n{\n\tregmap_update_bits(priv->regmap, MT6358_DCXO_CW14,\n\t\t\t   0x1 << RG_XO_AUDIO_EN_M_SFT,\n\t\t\t   (enable ? 1 : 0) << RG_XO_AUDIO_EN_M_SFT);\n\treturn 0;\n}\n\n \nstatic int mt6358_set_clksq(struct mt6358_priv *priv, bool enable)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON6,\n\t\t\t   RG_CLKSQ_IN_SEL_TEST_MASK_SFT,\n\t\t\t   0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON6,\n\t\t\t   RG_CLKSQ_EN_MASK_SFT,\n\t\t\t   (enable ? 1 : 0) << RG_CLKSQ_EN_SFT);\n\treturn 0;\n}\n\n \nstatic int mt6358_set_aud_global_bias(struct mt6358_priv *priv, bool enable)\n{\n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t   RG_AUDGLB_PWRDN_VA28_MASK_SFT,\n\t\t\t   (enable ? 0 : 1) << RG_AUDGLB_PWRDN_VA28_SFT);\n\treturn 0;\n}\n\n \nstatic int mt6358_set_topck(struct mt6358_priv *priv, bool enable)\n{\n\tregmap_update_bits(priv->regmap, MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t   0x0066, enable ? 0x0 : 0x66);\n\treturn 0;\n}\n\nstatic int mt6358_mtkaif_tx_enable(struct mt6358_priv *priv)\n{\n\tswitch (priv->mtkaif_protocol) {\n\tcase MT6358_MTKAIF_PROTOCOL_2_CLK_P2:\n\t\t \n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_ADDA_MTKAIF_CFG0,\n\t\t\t\t   0xffff, 0x0010);\n\t\t \n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_AUD_PAD_TOP,\n\t\t\t\t   0xff00, 0x3800);\n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_AUD_PAD_TOP,\n\t\t\t\t   0xff00, 0x3900);\n\t\tbreak;\n\tcase MT6358_MTKAIF_PROTOCOL_2:\n\t\t \n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_ADDA_MTKAIF_CFG0,\n\t\t\t\t   0xffff, 0x0010);\n\t\t \n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_AUD_PAD_TOP,\n\t\t\t\t   0xff00, 0x3100);\n\t\tbreak;\n\tcase MT6358_MTKAIF_PROTOCOL_1:\n\tdefault:\n\t\t \n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_ADDA_MTKAIF_CFG0,\n\t\t\t\t   0xffff, 0x0000);\n\t\t \n\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t   MT6358_AFE_AUD_PAD_TOP,\n\t\t\t\t   0xff00, 0x3100);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int mt6358_mtkaif_tx_disable(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AFE_AUD_PAD_TOP,\n\t\t\t   0xff00, 0x3000);\n\treturn 0;\n}\n\nint mt6358_mtkaif_calibration_enable(struct snd_soc_component *cmpnt)\n{\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tplayback_gpio_set(priv);\n\tcapture_gpio_set(priv);\n\tmt6358_mtkaif_tx_enable(priv);\n\n\tmt6358_set_dcxo(priv, true);\n\tmt6358_set_aud_global_bias(priv, true);\n\tmt6358_set_clksq(priv, true);\n\tmt6358_set_topck(priv, true);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDIO_DIG_CFG,\n\t\t\t   RG_AUD_PAD_TOP_DAT_MISO2_LOOPBACK_MASK_SFT,\n\t\t\t   1 << RG_AUD_PAD_TOP_DAT_MISO2_LOOPBACK_SFT);\n\tregmap_update_bits(priv->regmap, MT6358_AUDIO_DIG_CFG,\n\t\t\t   RG_AUD_PAD_TOP_DAT_MISO_LOOPBACK_MASK_SFT,\n\t\t\t   1 << RG_AUD_PAD_TOP_DAT_MISO_LOOPBACK_SFT);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt6358_mtkaif_calibration_enable);\n\nint mt6358_mtkaif_calibration_disable(struct snd_soc_component *cmpnt)\n{\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDIO_DIG_CFG,\n\t\t\t   RG_AUD_PAD_TOP_DAT_MISO2_LOOPBACK_MASK_SFT,\n\t\t\t   0 << RG_AUD_PAD_TOP_DAT_MISO2_LOOPBACK_SFT);\n\tregmap_update_bits(priv->regmap, MT6358_AUDIO_DIG_CFG,\n\t\t\t   RG_AUD_PAD_TOP_DAT_MISO_LOOPBACK_MASK_SFT,\n\t\t\t   0 << RG_AUD_PAD_TOP_DAT_MISO_LOOPBACK_SFT);\n\n\tmt6358_set_topck(priv, false);\n\tmt6358_set_clksq(priv, false);\n\tmt6358_set_aud_global_bias(priv, false);\n\tmt6358_set_dcxo(priv, false);\n\n\tmt6358_mtkaif_tx_disable(priv);\n\tplayback_gpio_reset(priv);\n\tcapture_gpio_reset(priv);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt6358_mtkaif_calibration_disable);\n\nint mt6358_set_mtkaif_calibration_phase(struct snd_soc_component *cmpnt,\n\t\t\t\t\tint phase_1, int phase_2)\n{\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tregmap_update_bits(priv->regmap, MT6358_AUDIO_DIG_CFG,\n\t\t\t   RG_AUD_PAD_TOP_PHASE_MODE_MASK_SFT,\n\t\t\t   phase_1 << RG_AUD_PAD_TOP_PHASE_MODE_SFT);\n\tregmap_update_bits(priv->regmap, MT6358_AUDIO_DIG_CFG,\n\t\t\t   RG_AUD_PAD_TOP_PHASE_MODE2_MASK_SFT,\n\t\t\t   phase_2 << RG_AUD_PAD_TOP_PHASE_MODE2_SFT);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt6358_set_mtkaif_calibration_phase);\n\n \nenum {\n\tDL_GAIN_8DB = 0,\n\tDL_GAIN_0DB = 8,\n\tDL_GAIN_N_1DB = 9,\n\tDL_GAIN_N_10DB = 18,\n\tDL_GAIN_N_40DB = 0x1f,\n};\n\n#define DL_GAIN_N_10DB_REG (DL_GAIN_N_10DB << 7 | DL_GAIN_N_10DB)\n#define DL_GAIN_N_40DB_REG (DL_GAIN_N_40DB << 7 | DL_GAIN_N_40DB)\n#define DL_GAIN_REG_MASK 0x0f9f\n\nstatic void hp_zcd_disable(struct mt6358_priv *priv)\n{\n\tregmap_write(priv->regmap, MT6358_ZCD_CON0, 0x0000);\n}\n\nstatic void hp_main_output_ramp(struct mt6358_priv *priv, bool up)\n{\n\tint i, stage;\n\tint target = 7;\n\n\t \n\tfor (i = 0; i <= target; i++) {\n\t\tstage = up ? i : target - i;\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1,\n\t\t\t\t   0x7 << 8, stage << 8);\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1,\n\t\t\t\t   0x7 << 11, stage << 11);\n\t\tusleep_range(100, 150);\n\t}\n}\n\nstatic void hp_aux_feedback_loop_gain_ramp(struct mt6358_priv *priv, bool up)\n{\n\tint i, stage;\n\n\t \n\tfor (i = 0; i <= 0xf; i++) {\n\t\tstage = up ? i : 0xf - i;\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON9,\n\t\t\t\t   0xf << 12, stage << 12);\n\t\tusleep_range(100, 150);\n\t}\n}\n\nstatic void hp_pull_down(struct mt6358_priv *priv, bool enable)\n{\n\tint i;\n\n\tif (enable) {\n\t\tfor (i = 0x0; i <= 0x6; i++) {\n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON4,\n\t\t\t\t\t   0x7, i);\n\t\t\tusleep_range(600, 700);\n\t\t}\n\t} else {\n\t\tfor (i = 0x6; i >= 0x1; i--) {\n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON4,\n\t\t\t\t\t   0x7, i);\n\t\t\tusleep_range(600, 700);\n\t\t}\n\t}\n}\n\nstatic bool is_valid_hp_pga_idx(int reg_idx)\n{\n\treturn (reg_idx >= DL_GAIN_8DB && reg_idx <= DL_GAIN_N_10DB) ||\n\t       reg_idx == DL_GAIN_N_40DB;\n}\n\nstatic void headset_volume_ramp(struct mt6358_priv *priv, int from, int to)\n{\n\tint offset = 0, count = 0, reg_idx;\n\n\tif (!is_valid_hp_pga_idx(from) || !is_valid_hp_pga_idx(to))\n\t\tdev_warn(priv->dev, \"%s(), volume index is not valid, from %d, to %d\\n\",\n\t\t\t __func__, from, to);\n\n\tdev_info(priv->dev, \"%s(), from %d, to %d\\n\",\n\t\t __func__, from, to);\n\n\tif (to > from)\n\t\toffset = to - from;\n\telse\n\t\toffset = from - to;\n\n\twhile (offset >= 0) {\n\t\tif (to > from)\n\t\t\treg_idx = from + count;\n\t\telse\n\t\t\treg_idx = from - count;\n\n\t\tif (is_valid_hp_pga_idx(reg_idx)) {\n\t\t\tregmap_update_bits(priv->regmap,\n\t\t\t\t\t   MT6358_ZCD_CON2,\n\t\t\t\t\t   DL_GAIN_REG_MASK,\n\t\t\t\t\t   (reg_idx << 7) | reg_idx);\n\t\t\tusleep_range(200, 300);\n\t\t}\n\t\toffset--;\n\t\tcount++;\n\t}\n}\n\nstatic int mt6358_put_volsw(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component =\n\t\t\tsnd_soc_kcontrol_component(kcontrol);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct soc_mixer_control *mc =\n\t\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tunsigned int reg = 0;\n\tint ret;\n\n\tret = snd_soc_put_volsw(kcontrol, ucontrol);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (mc->reg) {\n\tcase MT6358_ZCD_CON2:\n\t\tregmap_read(priv->regmap, MT6358_ZCD_CON2, &reg);\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_HPOUTL] =\n\t\t\t(reg >> RG_AUDHPLGAIN_SFT) & RG_AUDHPLGAIN_MASK;\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_HPOUTR] =\n\t\t\t(reg >> RG_AUDHPRGAIN_SFT) & RG_AUDHPRGAIN_MASK;\n\t\tbreak;\n\tcase MT6358_ZCD_CON1:\n\t\tregmap_read(priv->regmap, MT6358_ZCD_CON1, &reg);\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_LINEOUTL] =\n\t\t\t(reg >> RG_AUDLOLGAIN_SFT) & RG_AUDLOLGAIN_MASK;\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_LINEOUTR] =\n\t\t\t(reg >> RG_AUDLORGAIN_SFT) & RG_AUDLORGAIN_MASK;\n\t\tbreak;\n\tcase MT6358_ZCD_CON3:\n\t\tregmap_read(priv->regmap, MT6358_ZCD_CON3, &reg);\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_HSOUTL] =\n\t\t\t(reg >> RG_AUDHSGAIN_SFT) & RG_AUDHSGAIN_MASK;\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_HSOUTR] =\n\t\t\t(reg >> RG_AUDHSGAIN_SFT) & RG_AUDHSGAIN_MASK;\n\t\tbreak;\n\tcase MT6358_AUDENC_ANA_CON0:\n\tcase MT6358_AUDENC_ANA_CON1:\n\t\tregmap_read(priv->regmap, MT6358_AUDENC_ANA_CON0, &reg);\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_MICAMP1] =\n\t\t\t(reg >> RG_AUDPREAMPLGAIN_SFT) & RG_AUDPREAMPLGAIN_MASK;\n\t\tregmap_read(priv->regmap, MT6358_AUDENC_ANA_CON1, &reg);\n\t\tpriv->ana_gain[AUDIO_ANALOG_VOLUME_MICAMP2] =\n\t\t\t(reg >> RG_AUDPREAMPRGAIN_SFT) & RG_AUDPREAMPRGAIN_MASK;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic void mt6358_restore_pga(struct mt6358_priv *priv);\n\nstatic int mt6358_enable_wov_phase2(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t   0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_DCXO_CW14, 0xffff, 0xa2b5);\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   0xffff, 0x0800);\n\tmt6358_restore_pga(priv);\n\n\tregmap_update_bits(priv->regmap, MT6358_DCXO_CW13, 0xffff, 0x9929);\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON9,\n\t\t\t   0xffff, 0x0025);\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON8,\n\t\t\t   0xffff, 0x0005);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t   0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3, 0xffff, 0x0120);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG0, 0xffff, 0xffff);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG1, 0xffff, 0x0200);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG2, 0xffff, 0x2424);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG3, 0xffff, 0xdbac);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG4, 0xffff, 0x029e);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG5, 0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_POSDIV_CFG0,\n\t\t\t   0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_HPF_CFG0,\n\t\t\t   0xffff, 0x0451);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_TOP, 0xffff, 0x68d1);\n\n\treturn 0;\n}\n\nstatic int mt6358_disable_wov_phase2(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_TOP, 0xffff, 0xc000);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_HPF_CFG0,\n\t\t\t   0xffff, 0x0450);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_POSDIV_CFG0,\n\t\t\t   0xffff, 0x0c00);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG5, 0xffff, 0x0100);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG4, 0xffff, 0x006c);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG3, 0xffff, 0xa879);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG2, 0xffff, 0x2323);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG1, 0xffff, 0x0400);\n\tregmap_update_bits(priv->regmap, MT6358_AFE_VOW_CFG0, 0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_GPIO_MODE3, 0xffff, 0x02d8);\n\tregmap_update_bits(priv->regmap, MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t   0xffff, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON8,\n\t\t\t   0xffff, 0x0004);\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON9,\n\t\t\t   0xffff, 0x0000);\n\tregmap_update_bits(priv->regmap, MT6358_DCXO_CW13, 0xffff, 0x9829);\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   0xffff, 0x0000);\n\tmt6358_restore_pga(priv);\n\tregmap_update_bits(priv->regmap, MT6358_DCXO_CW14, 0xffff, 0xa2b5);\n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t   0xffff, 0x0010);\n\n\treturn 0;\n}\n\nstatic int mt6358_get_wov(struct snd_kcontrol *kcontrol,\n\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *c = snd_soc_kcontrol_component(kcontrol);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(c);\n\n\tucontrol->value.integer.value[0] = priv->wov_enabled;\n\treturn 0;\n}\n\nstatic int mt6358_put_wov(struct snd_kcontrol *kcontrol,\n\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *c = snd_soc_kcontrol_component(kcontrol);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(c);\n\tint enabled = ucontrol->value.integer.value[0];\n\n\tif (enabled < 0 || enabled > 1)\n\t\treturn -EINVAL;\n\n\tif (priv->wov_enabled != enabled) {\n\t\tif (enabled)\n\t\t\tmt6358_enable_wov_phase2(priv);\n\t\telse\n\t\t\tmt6358_disable_wov_phase2(priv);\n\n\t\tpriv->wov_enabled = enabled;\n\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic const DECLARE_TLV_DB_SCALE(playback_tlv, -1000, 100, 0);\nstatic const DECLARE_TLV_DB_SCALE(pga_tlv, 0, 600, 0);\n\nstatic const struct snd_kcontrol_new mt6358_snd_controls[] = {\n\t \n\tSOC_DOUBLE_EXT_TLV(\"Headphone Volume\",\n\t\t\t   MT6358_ZCD_CON2, 0, 7, 0x12, 1,\n\t\t\t   snd_soc_get_volsw, mt6358_put_volsw, playback_tlv),\n\tSOC_DOUBLE_EXT_TLV(\"Lineout Volume\",\n\t\t\t   MT6358_ZCD_CON1, 0, 7, 0x12, 1,\n\t\t\t   snd_soc_get_volsw, mt6358_put_volsw, playback_tlv),\n\tSOC_SINGLE_EXT_TLV(\"Handset Volume\",\n\t\t\t   MT6358_ZCD_CON3, 0, 0x12, 1,\n\t\t\t   snd_soc_get_volsw, mt6358_put_volsw, playback_tlv),\n\t \n\tSOC_DOUBLE_R_EXT_TLV(\"PGA Volume\",\n\t\t\t     MT6358_AUDENC_ANA_CON0, MT6358_AUDENC_ANA_CON1,\n\t\t\t     8, 4, 0,\n\t\t\t     snd_soc_get_volsw, mt6358_put_volsw, pga_tlv),\n\n\tSOC_SINGLE_BOOL_EXT(\"Wake-on-Voice Phase2 Switch\", 0,\n\t\t\t    mt6358_get_wov, mt6358_put_wov),\n};\n\n \n \nstatic const char * const lo_in_mux_map[] = {\n\t\"Open\", \"Mute\", \"Playback\", \"Test Mode\"\n};\n\nstatic int lo_in_mux_map_value[] = {\n\t0x0, 0x1, 0x2, 0x3,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(lo_in_mux_map_enum,\n\t\t\t\t  MT6358_AUDDEC_ANA_CON7,\n\t\t\t\t  RG_AUDLOLMUXINPUTSEL_VAUDP15_SFT,\n\t\t\t\t  RG_AUDLOLMUXINPUTSEL_VAUDP15_MASK,\n\t\t\t\t  lo_in_mux_map,\n\t\t\t\t  lo_in_mux_map_value);\n\nstatic const struct snd_kcontrol_new lo_in_mux_control =\n\tSOC_DAPM_ENUM(\"In Select\", lo_in_mux_map_enum);\n\n \nenum {\n\tHP_MUX_OPEN = 0,\n\tHP_MUX_HPSPK,\n\tHP_MUX_HP,\n\tHP_MUX_TEST_MODE,\n\tHP_MUX_HP_IMPEDANCE,\n\tHP_MUX_MASK = 0x7,\n};\n\nstatic const char * const hp_in_mux_map[] = {\n\t\"Open\",\n\t\"LoudSPK Playback\",\n\t\"Audio Playback\",\n\t\"Test Mode\",\n\t\"HP Impedance\",\n};\n\nstatic int hp_in_mux_map_value[] = {\n\tHP_MUX_OPEN,\n\tHP_MUX_HPSPK,\n\tHP_MUX_HP,\n\tHP_MUX_TEST_MODE,\n\tHP_MUX_HP_IMPEDANCE,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(hpl_in_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  HP_MUX_MASK,\n\t\t\t\t  hp_in_mux_map,\n\t\t\t\t  hp_in_mux_map_value);\n\nstatic const struct snd_kcontrol_new hpl_in_mux_control =\n\tSOC_DAPM_ENUM(\"HPL Select\", hpl_in_mux_map_enum);\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(hpr_in_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  HP_MUX_MASK,\n\t\t\t\t  hp_in_mux_map,\n\t\t\t\t  hp_in_mux_map_value);\n\nstatic const struct snd_kcontrol_new hpr_in_mux_control =\n\tSOC_DAPM_ENUM(\"HPR Select\", hpr_in_mux_map_enum);\n\n \nenum {\n\tRCV_MUX_OPEN = 0,\n\tRCV_MUX_MUTE,\n\tRCV_MUX_VOICE_PLAYBACK,\n\tRCV_MUX_TEST_MODE,\n\tRCV_MUX_MASK = 0x3,\n};\n\nstatic const char * const rcv_in_mux_map[] = {\n\t\"Open\", \"Mute\", \"Voice Playback\", \"Test Mode\"\n};\n\nstatic int rcv_in_mux_map_value[] = {\n\tRCV_MUX_OPEN,\n\tRCV_MUX_MUTE,\n\tRCV_MUX_VOICE_PLAYBACK,\n\tRCV_MUX_TEST_MODE,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(rcv_in_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  RCV_MUX_MASK,\n\t\t\t\t  rcv_in_mux_map,\n\t\t\t\t  rcv_in_mux_map_value);\n\nstatic const struct snd_kcontrol_new rcv_in_mux_control =\n\tSOC_DAPM_ENUM(\"RCV Select\", rcv_in_mux_map_enum);\n\n \nstatic const char * const dac_in_mux_map[] = {\n\t\"Normal Path\", \"Sgen\"\n};\n\nstatic int dac_in_mux_map_value[] = {\n\t0x0, 0x1,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(dac_in_mux_map_enum,\n\t\t\t\t  MT6358_AFE_TOP_CON0,\n\t\t\t\t  DL_SINE_ON_SFT,\n\t\t\t\t  DL_SINE_ON_MASK,\n\t\t\t\t  dac_in_mux_map,\n\t\t\t\t  dac_in_mux_map_value);\n\nstatic const struct snd_kcontrol_new dac_in_mux_control =\n\tSOC_DAPM_ENUM(\"DAC Select\", dac_in_mux_map_enum);\n\n \nstatic SOC_VALUE_ENUM_SINGLE_DECL(aif_out_mux_map_enum,\n\t\t\t\t  MT6358_AFE_TOP_CON0,\n\t\t\t\t  UL_SINE_ON_SFT,\n\t\t\t\t  UL_SINE_ON_MASK,\n\t\t\t\t  dac_in_mux_map,\n\t\t\t\t  dac_in_mux_map_value);\n\nstatic const struct snd_kcontrol_new aif_out_mux_control =\n\tSOC_DAPM_ENUM(\"AIF Out Select\", aif_out_mux_map_enum);\n\n \nenum {\n\tMIC_TYPE_MUX_IDLE = 0,\n\tMIC_TYPE_MUX_ACC,\n\tMIC_TYPE_MUX_DMIC,\n\tMIC_TYPE_MUX_DCC,\n\tMIC_TYPE_MUX_DCC_ECM_DIFF,\n\tMIC_TYPE_MUX_DCC_ECM_SINGLE,\n\tMIC_TYPE_MUX_MASK = 0x7,\n};\n\n#define IS_DCC_BASE(type) ((type) == MIC_TYPE_MUX_DCC || \\\n\t\t\t(type) == MIC_TYPE_MUX_DCC_ECM_DIFF || \\\n\t\t\t(type) == MIC_TYPE_MUX_DCC_ECM_SINGLE)\n\nstatic const char * const mic_type_mux_map[] = {\n\t\"Idle\",\n\t\"ACC\",\n\t\"DMIC\",\n\t\"DCC\",\n\t\"DCC_ECM_DIFF\",\n\t\"DCC_ECM_SINGLE\",\n};\n\nstatic int mic_type_mux_map_value[] = {\n\tMIC_TYPE_MUX_IDLE,\n\tMIC_TYPE_MUX_ACC,\n\tMIC_TYPE_MUX_DMIC,\n\tMIC_TYPE_MUX_DCC,\n\tMIC_TYPE_MUX_DCC_ECM_DIFF,\n\tMIC_TYPE_MUX_DCC_ECM_SINGLE,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(mic_type_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  MIC_TYPE_MUX_MASK,\n\t\t\t\t  mic_type_mux_map,\n\t\t\t\t  mic_type_mux_map_value);\n\nstatic const struct snd_kcontrol_new mic_type_mux_control =\n\tSOC_DAPM_ENUM(\"Mic Type Select\", mic_type_mux_map_enum);\n\n \nenum {\n\tADC_MUX_IDLE = 0,\n\tADC_MUX_AIN0,\n\tADC_MUX_PREAMPLIFIER,\n\tADC_MUX_IDLE1,\n\tADC_MUX_MASK = 0x3,\n};\n\nstatic const char * const adc_left_mux_map[] = {\n\t\"Idle\", \"AIN0\", \"Left Preamplifier\", \"Idle_1\"\n};\n\nstatic int adc_mux_map_value[] = {\n\tADC_MUX_IDLE,\n\tADC_MUX_AIN0,\n\tADC_MUX_PREAMPLIFIER,\n\tADC_MUX_IDLE1,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(adc_left_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  ADC_MUX_MASK,\n\t\t\t\t  adc_left_mux_map,\n\t\t\t\t  adc_mux_map_value);\n\nstatic const struct snd_kcontrol_new adc_left_mux_control =\n\tSOC_DAPM_ENUM(\"ADC L Select\", adc_left_mux_map_enum);\n\n \nstatic const char * const adc_right_mux_map[] = {\n\t\"Idle\", \"AIN0\", \"Right Preamplifier\", \"Idle_1\"\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(adc_right_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  ADC_MUX_MASK,\n\t\t\t\t  adc_right_mux_map,\n\t\t\t\t  adc_mux_map_value);\n\nstatic const struct snd_kcontrol_new adc_right_mux_control =\n\tSOC_DAPM_ENUM(\"ADC R Select\", adc_right_mux_map_enum);\n\n \nenum {\n\tPGA_MUX_NONE = 0,\n\tPGA_MUX_AIN0,\n\tPGA_MUX_AIN1,\n\tPGA_MUX_AIN2,\n\tPGA_MUX_MASK = 0x3,\n};\n\nstatic const char * const pga_mux_map[] = {\n\t\"None\", \"AIN0\", \"AIN1\", \"AIN2\"\n};\n\nstatic int pga_mux_map_value[] = {\n\tPGA_MUX_NONE,\n\tPGA_MUX_AIN0,\n\tPGA_MUX_AIN1,\n\tPGA_MUX_AIN2,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_DECL(pga_left_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  PGA_MUX_MASK,\n\t\t\t\t  pga_mux_map,\n\t\t\t\t  pga_mux_map_value);\n\nstatic const struct snd_kcontrol_new pga_left_mux_control =\n\tSOC_DAPM_ENUM(\"PGA L Select\", pga_left_mux_map_enum);\n\n \nstatic SOC_VALUE_ENUM_SINGLE_DECL(pga_right_mux_map_enum,\n\t\t\t\t  SND_SOC_NOPM,\n\t\t\t\t  0,\n\t\t\t\t  PGA_MUX_MASK,\n\t\t\t\t  pga_mux_map,\n\t\t\t\t  pga_mux_map_value);\n\nstatic const struct snd_kcontrol_new pga_right_mux_control =\n\tSOC_DAPM_ENUM(\"PGA R Select\", pga_right_mux_map_enum);\n\nstatic int mt_clksq_event(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol,\n\t\t\t  int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(priv->dev, \"%s(), event = 0x%x\\n\", __func__, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON6,\n\t\t\t\t   RG_CLKSQ_IN_SEL_TEST_MASK_SFT,\n\t\t\t\t   0x0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt_sgen_event(struct snd_soc_dapm_widget *w,\n\t\t\t struct snd_kcontrol *kcontrol,\n\t\t\t int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(priv->dev, \"%s(), event = 0x%x\\n\", __func__, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x0006);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON0, 0xCBA1);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x0003);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x000B);\n\n\t\tregmap_update_bits(priv->regmap, MT6358_AFE_SGEN_CFG0,\n\t\t\t\t   0xff3f,\n\t\t\t\t   0x0000);\n\t\tregmap_update_bits(priv->regmap, MT6358_AFE_SGEN_CFG1,\n\t\t\t\t   0xffff,\n\t\t\t\t   0x0001);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x0000);\n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON0, 0xcba0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt_aif_in_event(struct snd_soc_dapm_widget *w,\n\t\t\t   struct snd_kcontrol *kcontrol,\n\t\t\t   int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_info(priv->dev, \"%s(), event 0x%x, rate %d\\n\",\n\t\t __func__, event, priv->dl_rate);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tplayback_gpio_set(priv);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x0006);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON0, 0xCBA1);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x0003);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x000B);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON2, 0x0000);\n\t\tregmap_write(priv->regmap, MT6358_AFUNC_AUD_CON0, 0xcba0);\n\n\t\tplayback_gpio_reset(priv);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_hp_enable(struct mt6358_priv *priv)\n{\n\t \n\thp_pull_down(priv, true);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON4,\n\t\t\t   0x1 << 6, 0x1 << 6);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON2, 0x4000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_ZCD_CON2, DL_GAIN_N_40DB_REG);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON1, 0x0001);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON0, 0x0001);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON4, 0x0003);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON3, 0x0000);\n\tusleep_range(250, 270);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t   0x1055, 0x1055);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON15, 0x0001);\n\tusleep_range(100, 120);\n\n\t \n\thp_zcd_disable(priv);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x3000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON12, 0x0055);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON11, 0x4900);\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON12, 0x0055);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON2, 0x4033);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x000c);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x003c);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0c00);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x30c0);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x30f0);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x00fc);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0e00);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0200);\n\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON10, 0x0000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x00ff);\n\t \n\thp_main_output_ramp(priv, true);\n\n\t \n\thp_aux_feedback_loop_gain_ramp(priv, true);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fcf);\n\n\t \n\theadset_volume_ramp(priv,\n\t\t\t    DL_GAIN_N_10DB,\n\t\t\t    priv->ana_gain[AUDIO_ANALOG_VOLUME_HPOUTL]);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fc3);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3f03);\n\tusleep_range(100, 120);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13, 0x1, 0x1);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x30ff);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0xf201);\n\tusleep_range(100, 120);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x32ff);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x3aff);\n\n\t \n\thp_pull_down(priv, false);\n\n\treturn 0;\n}\n\nstatic int mtk_hp_disable(struct mt6358_priv *priv)\n{\n\t \n\thp_pull_down(priv, true);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x0f00, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON9,\n\t\t\t   0x0001, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x000f, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13, 0x1, 0x0);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fc3);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fcf);\n\n\t \n\theadset_volume_ramp(priv,\n\t\t\t    priv->ana_gain[AUDIO_ANALOG_VOLUME_HPOUTL],\n\t\t\t    DL_GAIN_N_40DB);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fff);\n\n\t \n\thp_aux_feedback_loop_gain_ramp(priv, false);\n\n\t \n\thp_main_output_ramp(priv, false);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3, 0x0);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0e00);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0c00);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1,\n\t\t\t   0x3 << 6, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x3 << 4, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x3 << 6, 0x0);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1,\n\t\t\t   0x3 << 4, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1,\n\t\t\t   0x3 << 2, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON12,\n\t\t\t   0x1 << 8, 0x1 << 8);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON15, 0x1, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t   0x1055, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDNCP_CLKDIV_CON3,\n\t\t\t   0x1, 0x1);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON2,\n\t\t\t   0x1 << 14, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON4,\n\t\t\t   0x1 << 6, 0x0);\n\t \n\thp_pull_down(priv, false);\n\n\treturn 0;\n}\n\nstatic int mtk_hp_spk_enable(struct mt6358_priv *priv)\n{\n\t \n\thp_pull_down(priv, true);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON4,\n\t\t\t   0x1 << 6, 0x1 << 6);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON2, 0x4000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_ZCD_CON2, DL_GAIN_N_10DB_REG);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON1, 0x0001);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON0, 0x0001);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON4, 0x0003);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON3, 0x0000);\n\tusleep_range(250, 270);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t   0x1055, 0x1055);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON15, 0x0001);\n\tusleep_range(100, 120);\n\n\t \n\thp_zcd_disable(priv);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x3000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON12, 0x0055);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON11, 0x4900);\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON12, 0x0055);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON2, 0x4033);\n\n\t \n\thp_pull_down(priv, false);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x30c0);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x30f0);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0200);\n\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON10, 0x0000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x0003);\n\t \n\thp_main_output_ramp(priv, true);\n\n\t \n\tregmap_write(priv->regmap, MT6358_ZCD_CON1, DL_GAIN_N_40DB_REG);\n\t \n\theadset_volume_ramp(priv,\n\t\t\t    DL_GAIN_N_10DB,\n\t\t\t    priv->ana_gain[AUDIO_ANALOG_VOLUME_HPOUTL]);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON7, 0x0110);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON7, 0x0112);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON7, 0x0113);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_ZCD_CON1,\n\t\t\t   RG_AUDLOLGAIN_MASK_SFT,\n\t\t\t   priv->ana_gain[AUDIO_ANALOG_VOLUME_LINEOUTL] <<\n\t\t\t   RG_AUDLOLGAIN_SFT);\n\tregmap_update_bits(priv->regmap, MT6358_ZCD_CON1,\n\t\t\t   RG_AUDLORGAIN_MASK_SFT,\n\t\t\t   priv->ana_gain[AUDIO_ANALOG_VOLUME_LINEOUTR] <<\n\t\t\t   RG_AUDLORGAIN_SFT);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13, 0x1, 0x1);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x30f9);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0201);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON7, 0x011b);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x35f9);\n\n\treturn 0;\n}\n\nstatic int mtk_hp_spk_disable(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x0f00, 0x0000);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON7,\n\t\t\t   0x3 << 2, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x000f, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13, 0x1, 0x0);\n\n\t \n\theadset_volume_ramp(priv,\n\t\t\t    priv->ana_gain[AUDIO_ANALOG_VOLUME_HPOUTL],\n\t\t\t    DL_GAIN_N_40DB);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_ZCD_CON1,\n\t\t\t   DL_GAIN_REG_MASK, DL_GAIN_N_40DB_REG);\n\n\t \n\thp_main_output_ramp(priv, false);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3, 0x0);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fc3);\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fcf);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON1, 0x3fff);\n\n\t \n\thp_aux_feedback_loop_gain_ramp(priv, false);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x3 << 4, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON7,\n\t\t\t   0x1, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   0x3 << 6, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON7,\n\t\t\t   0x1 << 1, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON9,\n\t\t\t   0xff << 8, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON12,\n\t\t\t   0x1 << 8, 0x1 << 8);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON15, 0x1, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14, 0x1055, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDNCP_CLKDIV_CON3, 0x1, 0x1);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON4,\n\t\t\t   0x1 << 6, 0x0);\n\t \n\thp_pull_down(priv, false);\n\n\treturn 0;\n}\n\nstatic int mt_hp_event(struct snd_soc_dapm_widget *w,\n\t\t       struct snd_kcontrol *kcontrol,\n\t\t       int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mux = dapm_kcontrol_get_value(w->kcontrols[0]);\n\tint device = DEVICE_HP;\n\n\tdev_info(priv->dev, \"%s(), event 0x%x, dev_counter[DEV_HP] %d, mux %u\\n\",\n\t\t __func__,\n\t\t event,\n\t\t priv->dev_counter[device],\n\t\t mux);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tpriv->dev_counter[device]++;\n\t\tif (priv->dev_counter[device] > 1)\n\t\t\tbreak;\t \n\t\telse if (priv->dev_counter[device] <= 0)\n\t\t\tdev_warn(priv->dev, \"%s(), dev_counter[DEV_HP] %d <= 0\\n\",\n\t\t\t\t __func__,\n\t\t\t\t priv->dev_counter[device]);\n\n\t\tpriv->mux_select[MUX_HP_L] = mux;\n\n\t\tif (mux == HP_MUX_HP)\n\t\t\tmtk_hp_enable(priv);\n\t\telse if (mux == HP_MUX_HPSPK)\n\t\t\tmtk_hp_spk_enable(priv);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tpriv->dev_counter[device]--;\n\t\tif (priv->dev_counter[device] > 0) {\n\t\t\tbreak;\t \n\t\t} else if (priv->dev_counter[device] < 0) {\n\t\t\tdev_warn(priv->dev, \"%s(), dev_counter[DEV_HP] %d < 0\\n\",\n\t\t\t\t __func__,\n\t\t\t\t priv->dev_counter[device]);\n\t\t\tpriv->dev_counter[device] = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (priv->mux_select[MUX_HP_L] == HP_MUX_HP)\n\t\t\tmtk_hp_disable(priv);\n\t\telse if (priv->mux_select[MUX_HP_L] == HP_MUX_HPSPK)\n\t\t\tmtk_hp_spk_disable(priv);\n\n\t\tpriv->mux_select[MUX_HP_L] = mux;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt_rcv_event(struct snd_soc_dapm_widget *w,\n\t\t\tstruct snd_kcontrol *kcontrol,\n\t\t\tint event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_info(priv->dev, \"%s(), event 0x%x, mux %u\\n\",\n\t\t __func__,\n\t\t event,\n\t\t dapm_kcontrol_get_value(w->kcontrols[0]));\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON2, 0x4000);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON1, 0x0001);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON2, 0x002c);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON0, 0x0001);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON4, 0x0003);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDNCP_CLKDIV_CON3, 0x0000);\n\t\tusleep_range(250, 270);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t\t   0x1055, 0x1055);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON15, 0x0001);\n\t\tusleep_range(100, 120);\n\n\t\t \n\t\thp_zcd_disable(priv);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON6, 0x0010);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON12, 0x0055);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON11, 0x4900);\n\t\t \n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON12, 0x0055);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON6, 0x0090);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0000);\n\t\t \n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON10, 0x0000);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON6, 0x0092);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON6, 0x0093);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t\t   0x1, 0x1);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON0, 0x0009);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON9, 0x0001);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDDEC_ANA_CON6, 0x009b);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON6,\n\t\t\t\t   RG_AUDHSMUXINPUTSEL_VAUDP15_MASK_SFT,\n\t\t\t\t   RCV_MUX_OPEN);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t\t   0x000f, 0x0000);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t\t   0x1, 0x0);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_ZCD_CON3, DL_GAIN_N_40DB);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON6,\n\t\t\t\t   0x1, 0x0);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON6,\n\t\t\t\t   0x1 << 1, 0x0000);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON9,\n\t\t\t\t   0xff << 8, 0x0);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON9,\n\t\t\t\t   0xff << 8, 0x2 << 8);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON12,\n\t\t\t\t   0x1 << 8, 0x1 << 8);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON15,\n\t\t\t\t   0x1, 0x0);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t\t   0x1055, 0x0);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDNCP_CLKDIV_CON3,\n\t\t\t\t   0x1, 0x1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt_aif_out_event(struct snd_soc_dapm_widget *w,\n\t\t\t    struct snd_kcontrol *kcontrol,\n\t\t\t    int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(priv->dev, \"%s(), event 0x%x, rate %d\\n\",\n\t\t__func__, event, priv->ul_rate);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tcapture_gpio_set(priv);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tcapture_gpio_reset(priv);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt_adc_supply_event(struct snd_soc_dapm_widget *w,\n\t\t\t       struct snd_kcontrol *kcontrol,\n\t\t\t       int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(priv->dev, \"%s(), event 0x%x\\n\",\n\t\t__func__, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t\t   0x1 << 5, 0x1 << 5);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON3,\n\t\t\t     0x0000);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t\t   0x2500, 0x0100);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t\t   0x2500, 0x2500);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t\t   0x2500, 0x0100);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON14,\n\t\t\t\t   0x2500, 0x0000);\n\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON3, 0x0000);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON13,\n\t\t\t\t   0x1 << 5, 0x0 << 5);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt6358_amic_enable(struct mt6358_priv *priv)\n{\n\tunsigned int mic_type = priv->mux_select[MUX_MIC_TYPE];\n\tunsigned int mux_pga_l = priv->mux_select[MUX_PGA_L];\n\tunsigned int mux_pga_r = priv->mux_select[MUX_PGA_R];\n\n\tdev_info(priv->dev, \"%s(), mux, mic %u, pga l %u, pga r %u\\n\",\n\t\t __func__, mic_type, mux_pga_l, mux_pga_r);\n\n\tif (IS_DCC_BASE(mic_type)) {\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2062);\n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2062);\n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2060);\n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2061);\n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG1, 0x0100);\n\t}\n\n\t \n\tif (mux_pga_l == PGA_MUX_AIN0 || mux_pga_l == PGA_MUX_AIN2 ||\n\t    mux_pga_r == PGA_MUX_AIN0 || mux_pga_r == PGA_MUX_AIN2) {\n\t\tswitch (mic_type) {\n\t\tcase MIC_TYPE_MUX_DCC_ECM_DIFF:\n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON9,\n\t\t\t\t\t   0xff00, 0x7700);\n\t\t\tbreak;\n\t\tcase MIC_TYPE_MUX_DCC_ECM_SINGLE:\n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON9,\n\t\t\t\t\t   0xff00, 0x1100);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON9,\n\t\t\t\t\t   0xff00, 0x0000);\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON9,\n\t\t\t\t   0xff, 0x21);\n\t}\n\n\t \n\tif (mux_pga_l == PGA_MUX_AIN1 || mux_pga_r == PGA_MUX_AIN1) {\n\t\t \n\t\tif (mic_type == MIC_TYPE_MUX_DCC_ECM_SINGLE)\n\t\t\tregmap_write(priv->regmap,\n\t\t\t\t     MT6358_AUDENC_ANA_CON10, 0x0161);\n\t\telse\n\t\t\tregmap_write(priv->regmap,\n\t\t\t\t     MT6358_AUDENC_ANA_CON10, 0x0061);\n\t}\n\n\tif (IS_DCC_BASE(mic_type)) {\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   0xf8ff, 0x0004);\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   0xf8ff, 0x0004);\n\t} else {\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   0xf8ff, 0x0000);\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   0xf8ff, 0x0000);\n\t}\n\n\tif (mux_pga_l != PGA_MUX_NONE) {\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   RG_AUDPREAMPLINPUTSEL_MASK_SFT,\n\t\t\t\t   mux_pga_l << RG_AUDPREAMPLINPUTSEL_SFT);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   RG_AUDPREAMPLON_MASK_SFT,\n\t\t\t\t   0x1 << RG_AUDPREAMPLON_SFT);\n\n\t\tif (IS_DCC_BASE(mic_type)) {\n\t\t\t \n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t\t   RG_AUDPREAMPLDCCEN_MASK_SFT,\n\t\t\t\t\t   0x1 << RG_AUDPREAMPLDCCEN_SFT);\n\t\t}\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   RG_AUDADCLINPUTSEL_MASK_SFT,\n\t\t\t\t   ADC_MUX_PREAMPLIFIER <<\n\t\t\t\t   RG_AUDADCLINPUTSEL_SFT);\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   RG_AUDADCLPWRUP_MASK_SFT,\n\t\t\t\t   0x1 << RG_AUDADCLPWRUP_SFT);\n\t}\n\n\tif (mux_pga_r != PGA_MUX_NONE) {\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   RG_AUDPREAMPRINPUTSEL_MASK_SFT,\n\t\t\t\t   mux_pga_r << RG_AUDPREAMPRINPUTSEL_SFT);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   RG_AUDPREAMPRON_MASK_SFT,\n\t\t\t\t   0x1 << RG_AUDPREAMPRON_SFT);\n\n\t\tif (IS_DCC_BASE(mic_type)) {\n\t\t\t \n\t\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t\t   RG_AUDPREAMPRDCCEN_MASK_SFT,\n\t\t\t\t\t   0x1 << RG_AUDPREAMPRDCCEN_SFT);\n\t\t}\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   RG_AUDADCRINPUTSEL_MASK_SFT,\n\t\t\t\t   ADC_MUX_PREAMPLIFIER <<\n\t\t\t\t   RG_AUDADCRINPUTSEL_SFT);\n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   RG_AUDADCRPWRUP_MASK_SFT,\n\t\t\t\t   0x1 << RG_AUDADCRPWRUP_SFT);\n\t}\n\n\tif (IS_DCC_BASE(mic_type)) {\n\t\tusleep_range(100, 150);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t\t   RG_AUDPREAMPLDCPRECHARGE_MASK_SFT, 0x0);\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t\t   RG_AUDPREAMPRDCPRECHARGE_MASK_SFT, 0x0);\n\n\t\t \n\t\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON3,\n\t\t\t\t   0x1 << 12, 0x0);\n\t}\n\n\t \n\tmt6358_mtkaif_tx_enable(priv);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AFE_UL_SRC_CON0_H, 0x0000);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AFE_UL_SRC_CON0_L, 0x0001);\n\n\treturn 0;\n}\n\nstatic void mt6358_amic_disable(struct mt6358_priv *priv)\n{\n\tunsigned int mic_type = priv->mux_select[MUX_MIC_TYPE];\n\tunsigned int mux_pga_l = priv->mux_select[MUX_PGA_L];\n\tunsigned int mux_pga_r = priv->mux_select[MUX_PGA_R];\n\n\tdev_info(priv->dev, \"%s(), mux, mic %u, pga l %u, pga r %u\\n\",\n\t\t __func__, mic_type, mux_pga_l, mux_pga_r);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AFE_UL_SRC_CON0_L,\n\t\t\t   0x0001, 0x0000);\n\n\t \n\tmt6358_mtkaif_tx_disable(priv);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t   0xf000, 0x0000);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t   0x1 << 1, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t   0xfffb, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t   0x1 << 2, 0x0);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   0xf000, 0x0000);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   0x1 << 1, 0x0);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   0x0ffb, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   0x1 << 2, 0x0);\n\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON9, 0x0000);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON10,\n\t\t\t   0x0001, 0x0000);\n\n\tif (IS_DCC_BASE(mic_type)) {\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2060);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2062);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2062);\n\t\t \n\t\tregmap_write(priv->regmap, MT6358_AFE_DCCLK_CFG0, 0x2062);\n\t}\n}\n\nstatic int mt6358_dmic_enable(struct mt6358_priv *priv)\n{\n\tdev_info(priv->dev, \"%s()\\n\", __func__);\n\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON9, 0x0021);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON10,\n\t\t\t   0x1 << 12, 0x0);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON8, 0x0005);\n\n\t \n\tmt6358_mtkaif_tx_enable(priv);\n\n\t \n\tif (priv->dmic_one_wire_mode)\n\t\tregmap_write(priv->regmap, MT6358_AFE_UL_SRC_CON0_H, 0x0400);\n\telse\n\t\tregmap_write(priv->regmap, MT6358_AFE_UL_SRC_CON0_H, 0x0080);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AFE_UL_SRC_CON0_L, 0x0003);\n\n\t \n\tmsleep(100);\n\n\treturn 0;\n}\n\nstatic void mt6358_dmic_disable(struct mt6358_priv *priv)\n{\n\tdev_info(priv->dev, \"%s()\\n\", __func__);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AFE_UL_SRC_CON0_L,\n\t\t\t   0x0003, 0x0000);\n\n\t \n\tmt6358_mtkaif_tx_disable(priv);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON8, 0x0000);\n\n\t \n\t \n\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON9, 0x0001);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON10,\n\t\t\t   0x1 << 12, 0x0);\n\n\t \n\tregmap_write(priv->regmap, MT6358_AUDENC_ANA_CON9, 0x0000);\n}\n\nstatic void mt6358_restore_pga(struct mt6358_priv *priv)\n{\n\tunsigned int gain_l, gain_r;\n\n\tgain_l = priv->ana_gain[AUDIO_ANALOG_VOLUME_MICAMP1];\n\tgain_r = priv->ana_gain[AUDIO_ANALOG_VOLUME_MICAMP2];\n\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON0,\n\t\t\t   RG_AUDPREAMPLGAIN_MASK_SFT,\n\t\t\t   gain_l << RG_AUDPREAMPLGAIN_SFT);\n\tregmap_update_bits(priv->regmap, MT6358_AUDENC_ANA_CON1,\n\t\t\t   RG_AUDPREAMPRGAIN_MASK_SFT,\n\t\t\t   gain_r << RG_AUDPREAMPRGAIN_SFT);\n}\n\nstatic int mt_mic_type_event(struct snd_soc_dapm_widget *w,\n\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mux = dapm_kcontrol_get_value(w->kcontrols[0]);\n\n\tdev_dbg(priv->dev, \"%s(), event 0x%x, mux %u\\n\",\n\t\t__func__, event, mux);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_WILL_PMU:\n\t\tpriv->mux_select[MUX_MIC_TYPE] = mux;\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tswitch (mux) {\n\t\tcase MIC_TYPE_MUX_DMIC:\n\t\t\tmt6358_dmic_enable(priv);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tmt6358_amic_enable(priv);\n\t\t\tbreak;\n\t\t}\n\t\tmt6358_restore_pga(priv);\n\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tswitch (priv->mux_select[MUX_MIC_TYPE]) {\n\t\tcase MIC_TYPE_MUX_DMIC:\n\t\t\tmt6358_dmic_disable(priv);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tmt6358_amic_disable(priv);\n\t\t\tbreak;\n\t\t}\n\n\t\tpriv->mux_select[MUX_MIC_TYPE] = mux;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt_adc_l_event(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol,\n\t\t\t  int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mux = dapm_kcontrol_get_value(w->kcontrols[0]);\n\n\tdev_dbg(priv->dev, \"%s(), event = 0x%x, mux %u\\n\",\n\t\t__func__, event, mux);\n\n\tpriv->mux_select[MUX_ADC_L] = mux;\n\n\treturn 0;\n}\n\nstatic int mt_adc_r_event(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol,\n\t\t\t  int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mux = dapm_kcontrol_get_value(w->kcontrols[0]);\n\n\tdev_dbg(priv->dev, \"%s(), event = 0x%x, mux %u\\n\",\n\t\t__func__, event, mux);\n\n\tpriv->mux_select[MUX_ADC_R] = mux;\n\n\treturn 0;\n}\n\nstatic int mt_pga_left_event(struct snd_soc_dapm_widget *w,\n\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mux = dapm_kcontrol_get_value(w->kcontrols[0]);\n\n\tdev_dbg(priv->dev, \"%s(), event = 0x%x, mux %u\\n\",\n\t\t__func__, event, mux);\n\n\tpriv->mux_select[MUX_PGA_L] = mux;\n\n\treturn 0;\n}\n\nstatic int mt_pga_right_event(struct snd_soc_dapm_widget *w,\n\t\t\t      struct snd_kcontrol *kcontrol,\n\t\t\t      int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mux = dapm_kcontrol_get_value(w->kcontrols[0]);\n\n\tdev_dbg(priv->dev, \"%s(), event = 0x%x, mux %u\\n\",\n\t\t__func__, event, mux);\n\n\tpriv->mux_select[MUX_PGA_R] = mux;\n\n\treturn 0;\n}\n\nstatic int mt_delay_250_event(struct snd_soc_dapm_widget *w,\n\t\t\t      struct snd_kcontrol *kcontrol,\n\t\t\t      int event)\n{\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tusleep_range(250, 270);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tusleep_range(250, 270);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \nstatic const struct snd_soc_dapm_widget mt6358_dapm_widgets[] = {\n\t \n\tSND_SOC_DAPM_SUPPLY_S(\"CLK_BUF\", SUPPLY_SEQ_CLK_BUF,\n\t\t\t      MT6358_DCXO_CW14,\n\t\t\t      RG_XO_AUDIO_EN_M_SFT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDGLB\", SUPPLY_SEQ_AUD_GLB,\n\t\t\t      MT6358_AUDDEC_ANA_CON13,\n\t\t\t      RG_AUDGLB_PWRDN_VA28_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"CLKSQ Audio\", SUPPLY_SEQ_CLKSQ,\n\t\t\t      MT6358_AUDENC_ANA_CON6,\n\t\t\t      RG_CLKSQ_EN_SFT, 0,\n\t\t\t      mt_clksq_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDNCP_CK\", SUPPLY_SEQ_TOP_CK,\n\t\t\t      MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t      RG_AUDNCP_CK_PDN_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"ZCD13M_CK\", SUPPLY_SEQ_TOP_CK,\n\t\t\t      MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t      RG_ZCD13M_CK_PDN_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUD_CK\", SUPPLY_SEQ_TOP_CK_LAST,\n\t\t\t      MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t      RG_AUD_CK_PDN_SFT, 1,\n\t\t\t      mt_delay_250_event,\n\t\t\t      SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIF_CK\", SUPPLY_SEQ_TOP_CK,\n\t\t\t      MT6358_AUD_TOP_CKPDN_CON0,\n\t\t\t      RG_AUDIF_CK_PDN_SFT, 1, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_AFE_CTL\", SUPPLY_SEQ_AUD_TOP_LAST,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PDN_AFE_CTL_SFT, 1,\n\t\t\t      mt_delay_250_event,\n\t\t\t      SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_DAC_CTL\", SUPPLY_SEQ_AUD_TOP,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PDN_DAC_CTL_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_ADC_CTL\", SUPPLY_SEQ_AUD_TOP,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PDN_ADC_CTL_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_I2S_DL\", SUPPLY_SEQ_AUD_TOP,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PDN_I2S_DL_CTL_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_PWR_CLK\", SUPPLY_SEQ_AUD_TOP,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PWR_CLK_DIS_CTL_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_PDN_AFE_TESTMODEL\", SUPPLY_SEQ_AUD_TOP,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PDN_AFE_TESTMODEL_CTL_SFT, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_TOP_PDN_RESERVED\", SUPPLY_SEQ_AUD_TOP,\n\t\t\t      MT6358_AUDIO_TOP_CON0,\n\t\t\t      PDN_RESERVED_SFT, 1, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"DL Digital Clock\", SND_SOC_NOPM,\n\t\t\t    0, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_SUPPLY_S(\"AFE_ON\", SUPPLY_SEQ_AFE,\n\t\t\t      MT6358_AFE_UL_DL_CON0, AFE_ON_SFT, 0,\n\t\t\t      NULL, 0),\n\n\t \n\tSND_SOC_DAPM_AIF_IN_E(\"AIF_RX\", \"AIF1 Playback\", 0,\n\t\t\t      MT6358_AFE_DL_SRC2_CON0_L,\n\t\t\t      DL_2_SRC_ON_TMP_CTL_PRE_SFT, 0,\n\t\t\t      mt_aif_in_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"DL Power Supply\", SND_SOC_NOPM,\n\t\t\t    0, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_MUX(\"DAC In Mux\", SND_SOC_NOPM, 0, 0, &dac_in_mux_control),\n\n\tSND_SOC_DAPM_DAC(\"DACL\", NULL, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_DAC(\"DACR\", NULL, SND_SOC_NOPM, 0, 0),\n\n\t \n\tSND_SOC_DAPM_MUX(\"LOL Mux\", SND_SOC_NOPM, 0, 0, &lo_in_mux_control),\n\n\tSND_SOC_DAPM_SUPPLY(\"LO Stability Enh\", MT6358_AUDDEC_ANA_CON7,\n\t\t\t    RG_LOOUTPUTSTBENH_VAUDP15_SFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_OUT_DRV(\"LOL Buffer\", MT6358_AUDDEC_ANA_CON7,\n\t\t\t     RG_AUDLOLPWRUP_VAUDP15_SFT, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_MUX_E(\"HPL Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &hpl_in_mux_control,\n\t\t\t   mt_hp_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD),\n\n\tSND_SOC_DAPM_MUX_E(\"HPR Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &hpr_in_mux_control,\n\t\t\t   mt_hp_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD),\n\n\t \n\tSND_SOC_DAPM_MUX_E(\"RCV Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &rcv_in_mux_control,\n\t\t\t   mt_rcv_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD),\n\n\t \n\tSND_SOC_DAPM_OUTPUT(\"Receiver\"),\n\tSND_SOC_DAPM_OUTPUT(\"Headphone L\"),\n\tSND_SOC_DAPM_OUTPUT(\"Headphone R\"),\n\tSND_SOC_DAPM_OUTPUT(\"Headphone L Ext Spk Amp\"),\n\tSND_SOC_DAPM_OUTPUT(\"Headphone R Ext Spk Amp\"),\n\tSND_SOC_DAPM_OUTPUT(\"LINEOUT L\"),\n\tSND_SOC_DAPM_OUTPUT(\"LINEOUT L HSSPK\"),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"SGEN DL Enable\", MT6358_AFE_SGEN_CFG0,\n\t\t\t    SGEN_DAC_EN_CTL_SFT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"SGEN MUTE\", MT6358_AFE_SGEN_CFG0,\n\t\t\t    SGEN_MUTE_SW_CTL_SFT, 1,\n\t\t\t    mt_sgen_event,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"SGEN DL SRC\", MT6358_AFE_DL_SRC2_CON0_L,\n\t\t\t    DL_2_SRC_ON_TMP_CTL_PRE_SFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_INPUT(\"SGEN DL\"),\n\n\t \n\tSND_SOC_DAPM_AIF_OUT_E(\"AIF1TX\", \"AIF1 Capture\", 0,\n\t\t\t       SND_SOC_NOPM, 0, 0,\n\t\t\t       mt_aif_out_event,\n\t\t\t       SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADC Supply\", SUPPLY_SEQ_ADC_SUPPLY,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mt_adc_supply_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_MUX(\"AIF Out Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t &aif_out_mux_control),\n\n\tSND_SOC_DAPM_MUX_E(\"Mic Type Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &mic_type_mux_control,\n\t\t\t   mt_mic_type_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD |\n\t\t\t   SND_SOC_DAPM_WILL_PMU),\n\n\tSND_SOC_DAPM_MUX_E(\"ADC L Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &adc_left_mux_control,\n\t\t\t   mt_adc_l_event,\n\t\t\t   SND_SOC_DAPM_WILL_PMU),\n\tSND_SOC_DAPM_MUX_E(\"ADC R Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &adc_right_mux_control,\n\t\t\t   mt_adc_r_event,\n\t\t\t   SND_SOC_DAPM_WILL_PMU),\n\n\tSND_SOC_DAPM_ADC(\"ADC L\", NULL, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_ADC(\"ADC R\", NULL, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_MUX_E(\"PGA L Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &pga_left_mux_control,\n\t\t\t   mt_pga_left_event,\n\t\t\t   SND_SOC_DAPM_WILL_PMU),\n\tSND_SOC_DAPM_MUX_E(\"PGA R Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t   &pga_right_mux_control,\n\t\t\t   mt_pga_right_event,\n\t\t\t   SND_SOC_DAPM_WILL_PMU),\n\n\tSND_SOC_DAPM_PGA(\"PGA L\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"PGA R\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_INPUT(\"AIN0\"),\n\tSND_SOC_DAPM_INPUT(\"AIN1\"),\n\tSND_SOC_DAPM_INPUT(\"AIN2\"),\n};\n\nstatic const struct snd_soc_dapm_route mt6358_dapm_routes[] = {\n\t \n\t{\"AIF1TX\", NULL, \"AIF Out Mux\"},\n\t{\"AIF1TX\", NULL, \"CLK_BUF\"},\n\t{\"AIF1TX\", NULL, \"AUDGLB\"},\n\t{\"AIF1TX\", NULL, \"CLKSQ Audio\"},\n\n\t{\"AIF1TX\", NULL, \"AUD_CK\"},\n\t{\"AIF1TX\", NULL, \"AUDIF_CK\"},\n\n\t{\"AIF1TX\", NULL, \"AUDIO_TOP_AFE_CTL\"},\n\t{\"AIF1TX\", NULL, \"AUDIO_TOP_ADC_CTL\"},\n\t{\"AIF1TX\", NULL, \"AUDIO_TOP_PWR_CLK\"},\n\t{\"AIF1TX\", NULL, \"AUDIO_TOP_PDN_RESERVED\"},\n\t{\"AIF1TX\", NULL, \"AUDIO_TOP_I2S_DL\"},\n\n\t{\"AIF1TX\", NULL, \"AFE_ON\"},\n\n\t{\"AIF Out Mux\", NULL, \"Mic Type Mux\"},\n\n\t{\"Mic Type Mux\", \"ACC\", \"ADC L\"},\n\t{\"Mic Type Mux\", \"ACC\", \"ADC R\"},\n\t{\"Mic Type Mux\", \"DCC\", \"ADC L\"},\n\t{\"Mic Type Mux\", \"DCC\", \"ADC R\"},\n\t{\"Mic Type Mux\", \"DCC_ECM_DIFF\", \"ADC L\"},\n\t{\"Mic Type Mux\", \"DCC_ECM_DIFF\", \"ADC R\"},\n\t{\"Mic Type Mux\", \"DCC_ECM_SINGLE\", \"ADC L\"},\n\t{\"Mic Type Mux\", \"DCC_ECM_SINGLE\", \"ADC R\"},\n\t{\"Mic Type Mux\", \"DMIC\", \"AIN0\"},\n\t{\"Mic Type Mux\", \"DMIC\", \"AIN2\"},\n\n\t{\"ADC L\", NULL, \"ADC L Mux\"},\n\t{\"ADC L\", NULL, \"ADC Supply\"},\n\t{\"ADC R\", NULL, \"ADC R Mux\"},\n\t{\"ADC R\", NULL, \"ADC Supply\"},\n\n\t{\"ADC L Mux\", \"Left Preamplifier\", \"PGA L\"},\n\n\t{\"ADC R Mux\", \"Right Preamplifier\", \"PGA R\"},\n\n\t{\"PGA L\", NULL, \"PGA L Mux\"},\n\t{\"PGA R\", NULL, \"PGA R Mux\"},\n\n\t{\"PGA L Mux\", \"AIN0\", \"AIN0\"},\n\t{\"PGA L Mux\", \"AIN1\", \"AIN1\"},\n\t{\"PGA L Mux\", \"AIN2\", \"AIN2\"},\n\n\t{\"PGA R Mux\", \"AIN0\", \"AIN0\"},\n\t{\"PGA R Mux\", \"AIN1\", \"AIN1\"},\n\t{\"PGA R Mux\", \"AIN2\", \"AIN2\"},\n\n\t \n\t{\"DL Power Supply\", NULL, \"CLK_BUF\"},\n\t{\"DL Power Supply\", NULL, \"AUDGLB\"},\n\t{\"DL Power Supply\", NULL, \"CLKSQ Audio\"},\n\n\t{\"DL Power Supply\", NULL, \"AUDNCP_CK\"},\n\t{\"DL Power Supply\", NULL, \"ZCD13M_CK\"},\n\t{\"DL Power Supply\", NULL, \"AUD_CK\"},\n\t{\"DL Power Supply\", NULL, \"AUDIF_CK\"},\n\n\t \n\t{\"DL Digital Clock\", NULL, \"AUDIO_TOP_AFE_CTL\"},\n\t{\"DL Digital Clock\", NULL, \"AUDIO_TOP_DAC_CTL\"},\n\t{\"DL Digital Clock\", NULL, \"AUDIO_TOP_PWR_CLK\"},\n\n\t{\"DL Digital Clock\", NULL, \"AFE_ON\"},\n\n\t{\"AIF_RX\", NULL, \"DL Digital Clock\"},\n\n\t \n\t{\"DAC In Mux\", \"Normal Path\", \"AIF_RX\"},\n\n\t{\"DAC In Mux\", \"Sgen\", \"SGEN DL\"},\n\t{\"SGEN DL\", NULL, \"SGEN DL SRC\"},\n\t{\"SGEN DL\", NULL, \"SGEN MUTE\"},\n\t{\"SGEN DL\", NULL, \"SGEN DL Enable\"},\n\t{\"SGEN DL\", NULL, \"DL Digital Clock\"},\n\t{\"SGEN DL\", NULL, \"AUDIO_TOP_PDN_AFE_TESTMODEL\"},\n\n\t{\"DACL\", NULL, \"DAC In Mux\"},\n\t{\"DACL\", NULL, \"DL Power Supply\"},\n\n\t{\"DACR\", NULL, \"DAC In Mux\"},\n\t{\"DACR\", NULL, \"DL Power Supply\"},\n\n\t \n\t{\"LOL Mux\", \"Playback\", \"DACL\"},\n\n\t{\"LOL Buffer\", NULL, \"LOL Mux\"},\n\t{\"LOL Buffer\", NULL, \"LO Stability Enh\"},\n\n\t{\"LINEOUT L\", NULL, \"LOL Buffer\"},\n\n\t \n\t{\"HPL Mux\", \"Audio Playback\", \"DACL\"},\n\t{\"HPR Mux\", \"Audio Playback\", \"DACR\"},\n\t{\"HPL Mux\", \"HP Impedance\", \"DACL\"},\n\t{\"HPR Mux\", \"HP Impedance\", \"DACR\"},\n\t{\"HPL Mux\", \"LoudSPK Playback\", \"DACL\"},\n\t{\"HPR Mux\", \"LoudSPK Playback\", \"DACR\"},\n\n\t{\"Headphone L\", NULL, \"HPL Mux\"},\n\t{\"Headphone R\", NULL, \"HPR Mux\"},\n\t{\"Headphone L Ext Spk Amp\", NULL, \"HPL Mux\"},\n\t{\"Headphone R Ext Spk Amp\", NULL, \"HPR Mux\"},\n\t{\"LINEOUT L HSSPK\", NULL, \"HPL Mux\"},\n\n\t \n\t{\"RCV Mux\", \"Voice Playback\", \"DACL\"},\n\t{\"Receiver\", NULL, \"RCV Mux\"},\n};\n\nstatic int mt6358_codec_dai_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t      struct snd_pcm_hw_params *params,\n\t\t\t\t      struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *cmpnt = dai->component;\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int rate = params_rate(params);\n\n\tdev_info(priv->dev, \"%s(), substream->stream %d, rate %d, number %d\\n\",\n\t\t __func__,\n\t\t substream->stream,\n\t\t rate,\n\t\t substream->number);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tpriv->dl_rate = rate;\n\telse if (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\tpriv->ul_rate = rate;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops mt6358_codec_dai_ops = {\n\t.hw_params = mt6358_codec_dai_hw_params,\n};\n\n#define MT6358_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_U16_LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_U24_LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S32_LE | SNDRV_PCM_FMTBIT_U32_LE)\n\nstatic struct snd_soc_dai_driver mt6358_dai_driver[] = {\n\t{\n\t\t.name = \"mt6358-snd-codec-aif1\",\n\t\t.playback = {\n\t\t\t.stream_name = \"AIF1 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000 |\n\t\t\t\t SNDRV_PCM_RATE_96000 |\n\t\t\t\t SNDRV_PCM_RATE_192000,\n\t\t\t.formats = MT6358_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"AIF1 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000 |\n\t\t\t\t SNDRV_PCM_RATE_16000 |\n\t\t\t\t SNDRV_PCM_RATE_32000 |\n\t\t\t\t SNDRV_PCM_RATE_48000,\n\t\t\t.formats = MT6358_FORMATS,\n\t\t},\n\t\t.ops = &mt6358_codec_dai_ops,\n\t},\n};\n\nstatic void mt6358_codec_init_reg(struct mt6358_priv *priv)\n{\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   RG_AUDHPLSCDISABLE_VAUDP15_MASK_SFT,\n\t\t\t   0x1 << RG_AUDHPLSCDISABLE_VAUDP15_SFT);\n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON0,\n\t\t\t   RG_AUDHPRSCDISABLE_VAUDP15_MASK_SFT,\n\t\t\t   0x1 << RG_AUDHPRSCDISABLE_VAUDP15_SFT);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON6,\n\t\t\t   RG_AUDHSSCDISABLE_VAUDP15_MASK_SFT,\n\t\t\t   0x1 << RG_AUDHSSCDISABLE_VAUDP15_SFT);\n\t \n\tregmap_update_bits(priv->regmap, MT6358_AUDDEC_ANA_CON7,\n\t\t\t   RG_AUDLOLSCDISABLE_VAUDP15_MASK_SFT,\n\t\t\t   0x1 << RG_AUDLOLSCDISABLE_VAUDP15_SFT);\n\n\t \n\tregmap_update_bits(priv->regmap, MT6358_ACCDET_CON13,\n\t\t\t   0xFFFF, 0x700E);\n\n\t \n\tregmap_write(priv->regmap, MT6358_DRV_CON3, 0x8888);\n\n\t \n\tplayback_gpio_reset(priv);\n\tcapture_gpio_reset(priv);\n}\n\nstatic int mt6358_codec_probe(struct snd_soc_component *cmpnt)\n{\n\tstruct mt6358_priv *priv = snd_soc_component_get_drvdata(cmpnt);\n\tint ret;\n\n\tsnd_soc_component_init_regmap(cmpnt, priv->regmap);\n\n\tmt6358_codec_init_reg(priv);\n\n\tpriv->avdd_reg = devm_regulator_get(priv->dev, \"Avdd\");\n\tif (IS_ERR(priv->avdd_reg)) {\n\t\tdev_err(priv->dev, \"%s() have no Avdd supply\", __func__);\n\t\treturn PTR_ERR(priv->avdd_reg);\n\t}\n\n\tret = regulator_enable(priv->avdd_reg);\n\tif (ret)\n\t\treturn  ret;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver mt6358_soc_component_driver = {\n\t.probe = mt6358_codec_probe,\n\t.controls = mt6358_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt6358_snd_controls),\n\t.dapm_widgets = mt6358_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt6358_dapm_widgets),\n\t.dapm_routes = mt6358_dapm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt6358_dapm_routes),\n\t.endianness = 1,\n};\n\nstatic void mt6358_parse_dt(struct mt6358_priv *priv)\n{\n\tint ret;\n\tstruct device *dev = priv->dev;\n\n\tret = of_property_read_u32(dev->of_node, \"mediatek,dmic-mode\",\n\t\t\t\t   &priv->dmic_one_wire_mode);\n\tif (ret) {\n\t\tdev_warn(priv->dev, \"%s() failed to read dmic-mode\\n\",\n\t\t\t __func__);\n\t\tpriv->dmic_one_wire_mode = 0;\n\t}\n}\n\nstatic int mt6358_platform_driver_probe(struct platform_device *pdev)\n{\n\tstruct mt6358_priv *priv;\n\tstruct mt6397_chip *mt6397 = dev_get_drvdata(pdev->dev.parent);\n\n\tpriv = devm_kzalloc(&pdev->dev,\n\t\t\t    sizeof(struct mt6358_priv),\n\t\t\t    GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&pdev->dev, priv);\n\n\tpriv->dev = &pdev->dev;\n\n\tpriv->regmap = mt6397->regmap;\n\tif (IS_ERR(priv->regmap))\n\t\treturn PTR_ERR(priv->regmap);\n\n\tmt6358_parse_dt(priv);\n\n\tdev_info(priv->dev, \"%s(), dev name %s\\n\",\n\t\t __func__, dev_name(&pdev->dev));\n\n\treturn devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t      &mt6358_soc_component_driver,\n\t\t\t\t      mt6358_dai_driver,\n\t\t\t\t      ARRAY_SIZE(mt6358_dai_driver));\n}\n\nstatic const struct of_device_id mt6358_of_match[] = {\n\t{.compatible = \"mediatek,mt6358-sound\",},\n\t{.compatible = \"mediatek,mt6366-sound\",},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mt6358_of_match);\n\nstatic struct platform_driver mt6358_platform_driver = {\n\t.driver = {\n\t\t.name = \"mt6358-sound\",\n\t\t.of_match_table = mt6358_of_match,\n\t},\n\t.probe = mt6358_platform_driver_probe,\n};\n\nmodule_platform_driver(mt6358_platform_driver)\n\n \nMODULE_DESCRIPTION(\"MT6358 ALSA SoC codec driver\");\nMODULE_AUTHOR(\"KaiChieh Chuang <kaichieh.chuang@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}