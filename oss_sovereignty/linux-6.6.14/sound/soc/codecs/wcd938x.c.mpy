{
  "module_name": "wcd938x.c",
  "hash_id": "dc1471a8236b0e65a68bbfeec2b6db2819b027bd8d44684e57c5904248dcf7cb",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/wcd938x.c",
  "human_readable_source": "\n\n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/platform_device.h>\n#include <linux/device.h>\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/kernel.h>\n#include <linux/pm_runtime.h>\n#include <linux/component.h>\n#include <sound/tlv.h>\n#include <linux/of_gpio.h>\n#include <linux/of.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <linux/regmap.h>\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <linux/regulator/consumer.h>\n\n#include \"wcd-clsh-v2.h\"\n#include \"wcd-mbhc-v2.h\"\n#include \"wcd938x.h\"\n\n#define WCD938X_MAX_MICBIAS\t\t(4)\n#define WCD938X_MAX_SUPPLY\t\t(4)\n#define WCD938X_MBHC_MAX_BUTTONS\t(8)\n#define TX_ADC_MAX\t\t\t(4)\n#define WCD938X_TX_MAX_SWR_PORTS\t(5)\n\n#define WCD938X_RATES_MASK (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_16000 |\\\n\t\t\t    SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_48000 |\\\n\t\t\t    SNDRV_PCM_RATE_96000 | SNDRV_PCM_RATE_192000)\n \n#define WCD938X_FRAC_RATES_MASK (SNDRV_PCM_RATE_44100 | SNDRV_PCM_RATE_88200 |\\\n\t\t\t\t SNDRV_PCM_RATE_176400)\n#define WCD938X_FORMATS_S16_S24_LE (SNDRV_PCM_FMTBIT_S16_LE | \\\n\t\t\t\t    SNDRV_PCM_FMTBIT_S24_LE)\n \n#define  WCD_VOUT_CTL_TO_MICB(v)\t(1000 + v * 50)\n#define SWR_CLK_RATE_0P6MHZ\t\t(600000)\n#define SWR_CLK_RATE_1P2MHZ\t\t(1200000)\n#define SWR_CLK_RATE_2P4MHZ\t\t(2400000)\n#define SWR_CLK_RATE_4P8MHZ\t\t(4800000)\n#define SWR_CLK_RATE_9P6MHZ\t\t(9600000)\n#define SWR_CLK_RATE_11P2896MHZ\t\t(1128960)\n\n#define WCD938X_DRV_NAME \"wcd938x_codec\"\n#define WCD938X_VERSION_1_0\t\t(1)\n#define EAR_RX_PATH_AUX\t\t\t(1)\n\n#define ADC_MODE_VAL_HIFI\t\t0x01\n#define ADC_MODE_VAL_LO_HIF\t\t0x02\n#define ADC_MODE_VAL_NORMAL\t\t0x03\n#define ADC_MODE_VAL_LP\t\t\t0x05\n#define ADC_MODE_VAL_ULP1\t\t0x09\n#define ADC_MODE_VAL_ULP2\t\t0x0B\n\n \n#define WCD938X_ZDET_VAL_32             (32000)\n#define WCD938X_ZDET_VAL_400            (400000)\n#define WCD938X_ZDET_VAL_1200           (1200000)\n#define WCD938X_ZDET_VAL_100K           (100000000)\n \n#define WCD938X_ZDET_FLOATING_IMPEDANCE\t(0x0FFFFFFE)\n#define WCD938X_ZDET_NUM_MEASUREMENTS   (900)\n#define WCD938X_MBHC_GET_C1(c)          ((c & 0xC000) >> 14)\n#define WCD938X_MBHC_GET_X1(x)          (x & 0x3FFF)\n \n#define WCD938X_MBHC_IS_SECOND_RAMP_REQUIRED(z) ((z > 400000) || (z < 32000))\n#define WCD938X_MBHC_ZDET_CONST         (86 * 16384)\n#define WCD938X_MBHC_MOISTURE_RREF      R_24_KOHM\n#define WCD_MBHC_HS_V_MAX           1600\n\n#define WCD938X_EAR_PA_GAIN_TLV(xname, reg, shift, max, invert, tlv_array) \\\n{\t.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \\\n\t.access = SNDRV_CTL_ELEM_ACCESS_TLV_READ |\\\n\t\t SNDRV_CTL_ELEM_ACCESS_READWRITE,\\\n\t.tlv.p = (tlv_array), \\\n\t.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\\\n\t.put = wcd938x_ear_pa_put_gain, \\\n\t.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, 0) }\n\nenum {\n\tWCD9380 = 0,\n\tWCD9385 = 5,\n};\n\nenum {\n\tTX_HDR12 = 0,\n\tTX_HDR34,\n\tTX_HDR_MAX,\n};\n\nenum {\n\tWCD_RX1,\n\tWCD_RX2,\n\tWCD_RX3\n};\n\nenum {\n\t \n\tWCD938X_IRQ_MBHC_BUTTON_PRESS_DET = 0,\n\tWCD938X_IRQ_MBHC_BUTTON_RELEASE_DET,\n\tWCD938X_IRQ_MBHC_ELECT_INS_REM_DET,\n\tWCD938X_IRQ_MBHC_ELECT_INS_REM_LEG_DET,\n\tWCD938X_IRQ_MBHC_SW_DET,\n\tWCD938X_IRQ_HPHR_OCP_INT,\n\tWCD938X_IRQ_HPHR_CNP_INT,\n\tWCD938X_IRQ_HPHL_OCP_INT,\n\n\t \n\tWCD938X_IRQ_HPHL_CNP_INT,\n\tWCD938X_IRQ_EAR_CNP_INT,\n\tWCD938X_IRQ_EAR_SCD_INT,\n\tWCD938X_IRQ_AUX_CNP_INT,\n\tWCD938X_IRQ_AUX_SCD_INT,\n\tWCD938X_IRQ_HPHL_PDM_WD_INT,\n\tWCD938X_IRQ_HPHR_PDM_WD_INT,\n\tWCD938X_IRQ_AUX_PDM_WD_INT,\n\n\t \n\tWCD938X_IRQ_LDORT_SCD_INT,\n\tWCD938X_IRQ_MBHC_MOISTURE_INT,\n\tWCD938X_IRQ_HPHL_SURGE_DET_INT,\n\tWCD938X_IRQ_HPHR_SURGE_DET_INT,\n\tWCD938X_NUM_IRQS,\n};\n\nenum {\n\tWCD_ADC1 = 0,\n\tWCD_ADC2,\n\tWCD_ADC3,\n\tWCD_ADC4,\n\tALLOW_BUCK_DISABLE,\n\tHPH_COMP_DELAY,\n\tHPH_PA_DELAY,\n\tAMIC2_BCS_ENABLE,\n\tWCD_SUPPLIES_LPM_MODE,\n};\n\nenum {\n\tADC_MODE_INVALID = 0,\n\tADC_MODE_HIFI,\n\tADC_MODE_LO_HIF,\n\tADC_MODE_NORMAL,\n\tADC_MODE_LP,\n\tADC_MODE_ULP1,\n\tADC_MODE_ULP2,\n};\n\nenum {\n\tAIF1_PB = 0,\n\tAIF1_CAP,\n\tNUM_CODEC_DAIS,\n};\n\nstatic u8 tx_mode_bit[] = {\n\t[ADC_MODE_INVALID] = 0x00,\n\t[ADC_MODE_HIFI] = 0x01,\n\t[ADC_MODE_LO_HIF] = 0x02,\n\t[ADC_MODE_NORMAL] = 0x04,\n\t[ADC_MODE_LP] = 0x08,\n\t[ADC_MODE_ULP1] = 0x10,\n\t[ADC_MODE_ULP2] = 0x20,\n};\n\nstruct wcd938x_priv {\n\tstruct sdw_slave *tx_sdw_dev;\n\tstruct wcd938x_sdw_priv *sdw_priv[NUM_CODEC_DAIS];\n\tstruct device *txdev;\n\tstruct device *rxdev;\n\tstruct device_node *rxnode, *txnode;\n\tstruct regmap *regmap;\n\tstruct mutex micb_lock;\n\t \n\tstruct wcd_mbhc *wcd_mbhc;\n\tstruct wcd_mbhc_config mbhc_cfg;\n\tstruct wcd_mbhc_intr intr_ids;\n\tstruct wcd_clsh_ctrl *clsh_info;\n\tstruct irq_domain *virq;\n\tstruct regmap_irq_chip *wcd_regmap_irq_chip;\n\tstruct regmap_irq_chip_data *irq_chip;\n\tstruct regulator_bulk_data supplies[WCD938X_MAX_SUPPLY];\n\tstruct snd_soc_jack *jack;\n\tunsigned long status_mask;\n\ts32 micb_ref[WCD938X_MAX_MICBIAS];\n\ts32 pullup_ref[WCD938X_MAX_MICBIAS];\n\tu32 hph_mode;\n\tu32 tx_mode[TX_ADC_MAX];\n\tint flyback_cur_det_disable;\n\tint ear_rx_path;\n\tint variant;\n\tint reset_gpio;\n\tstruct gpio_desc *us_euro_gpio;\n\tu32 micb1_mv;\n\tu32 micb2_mv;\n\tu32 micb3_mv;\n\tu32 micb4_mv;\n\tint hphr_pdm_wd_int;\n\tint hphl_pdm_wd_int;\n\tint aux_pdm_wd_int;\n\tbool comp1_enable;\n\tbool comp2_enable;\n\tbool ldoh;\n\tbool bcs_dis;\n};\n\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_MINMAX(ear_pa_gain, 600, -1800);\nstatic const DECLARE_TLV_DB_SCALE(line_gain, -3000, 150, -3000);\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_MINMAX(analog_gain, 0, 3000);\n\nstruct wcd938x_mbhc_zdet_param {\n\tu16 ldo_ctl;\n\tu16 noff;\n\tu16 nshift;\n\tu16 btn5;\n\tu16 btn6;\n\tu16 btn7;\n};\n\nstatic struct wcd_mbhc_field wcd_mbhc_fields[WCD_MBHC_REG_FUNC_MAX] = {\n\tWCD_MBHC_FIELD(WCD_MBHC_L_DET_EN, WCD938X_ANA_MBHC_MECH, 0x80),\n\tWCD_MBHC_FIELD(WCD_MBHC_GND_DET_EN, WCD938X_ANA_MBHC_MECH, 0x40),\n\tWCD_MBHC_FIELD(WCD_MBHC_MECH_DETECTION_TYPE, WCD938X_ANA_MBHC_MECH, 0x20),\n\tWCD_MBHC_FIELD(WCD_MBHC_MIC_CLAMP_CTL, WCD938X_MBHC_NEW_PLUG_DETECT_CTL, 0x30),\n\tWCD_MBHC_FIELD(WCD_MBHC_ELECT_DETECTION_TYPE, WCD938X_ANA_MBHC_ELECT, 0x08),\n\tWCD_MBHC_FIELD(WCD_MBHC_HS_L_DET_PULL_UP_CTRL, WCD938X_MBHC_NEW_INT_MECH_DET_CURRENT, 0x1F),\n\tWCD_MBHC_FIELD(WCD_MBHC_HS_L_DET_PULL_UP_COMP_CTRL, WCD938X_ANA_MBHC_MECH, 0x04),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHL_PLUG_TYPE, WCD938X_ANA_MBHC_MECH, 0x10),\n\tWCD_MBHC_FIELD(WCD_MBHC_GND_PLUG_TYPE, WCD938X_ANA_MBHC_MECH, 0x08),\n\tWCD_MBHC_FIELD(WCD_MBHC_SW_HPH_LP_100K_TO_GND, WCD938X_ANA_MBHC_MECH, 0x01),\n\tWCD_MBHC_FIELD(WCD_MBHC_ELECT_SCHMT_ISRC, WCD938X_ANA_MBHC_ELECT, 0x06),\n\tWCD_MBHC_FIELD(WCD_MBHC_FSM_EN, WCD938X_ANA_MBHC_ELECT, 0x80),\n\tWCD_MBHC_FIELD(WCD_MBHC_INSREM_DBNC, WCD938X_MBHC_NEW_PLUG_DETECT_CTL, 0x0F),\n\tWCD_MBHC_FIELD(WCD_MBHC_BTN_DBNC, WCD938X_MBHC_NEW_CTL_1, 0x03),\n\tWCD_MBHC_FIELD(WCD_MBHC_HS_VREF, WCD938X_MBHC_NEW_CTL_2, 0x03),\n\tWCD_MBHC_FIELD(WCD_MBHC_HS_COMP_RESULT, WCD938X_ANA_MBHC_RESULT_3, 0x08),\n\tWCD_MBHC_FIELD(WCD_MBHC_IN2P_CLAMP_STATE, WCD938X_ANA_MBHC_RESULT_3, 0x10),\n\tWCD_MBHC_FIELD(WCD_MBHC_MIC_SCHMT_RESULT, WCD938X_ANA_MBHC_RESULT_3, 0x20),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHL_SCHMT_RESULT, WCD938X_ANA_MBHC_RESULT_3, 0x80),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHR_SCHMT_RESULT, WCD938X_ANA_MBHC_RESULT_3, 0x40),\n\tWCD_MBHC_FIELD(WCD_MBHC_OCP_FSM_EN, WCD938X_HPH_OCP_CTL, 0x10),\n\tWCD_MBHC_FIELD(WCD_MBHC_BTN_RESULT, WCD938X_ANA_MBHC_RESULT_3, 0x07),\n\tWCD_MBHC_FIELD(WCD_MBHC_BTN_ISRC_CTL, WCD938X_ANA_MBHC_ELECT, 0x70),\n\tWCD_MBHC_FIELD(WCD_MBHC_ELECT_RESULT, WCD938X_ANA_MBHC_RESULT_3, 0xFF),\n\tWCD_MBHC_FIELD(WCD_MBHC_MICB_CTRL, WCD938X_ANA_MICB2, 0xC0),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPH_CNP_WG_TIME, WCD938X_HPH_CNP_WG_TIME, 0xFF),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHR_PA_EN, WCD938X_ANA_HPH, 0x40),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHL_PA_EN, WCD938X_ANA_HPH, 0x80),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPH_PA_EN, WCD938X_ANA_HPH, 0xC0),\n\tWCD_MBHC_FIELD(WCD_MBHC_SWCH_LEVEL_REMOVE, WCD938X_ANA_MBHC_RESULT_3, 0x10),\n\tWCD_MBHC_FIELD(WCD_MBHC_ANC_DET_EN, WCD938X_MBHC_CTL_BCS, 0x02),\n\tWCD_MBHC_FIELD(WCD_MBHC_FSM_STATUS, WCD938X_MBHC_NEW_FSM_STATUS, 0x01),\n\tWCD_MBHC_FIELD(WCD_MBHC_MUX_CTL, WCD938X_MBHC_NEW_CTL_2, 0x70),\n\tWCD_MBHC_FIELD(WCD_MBHC_MOISTURE_STATUS, WCD938X_MBHC_NEW_FSM_STATUS, 0x20),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHR_GND, WCD938X_HPH_PA_CTL2, 0x40),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHL_GND, WCD938X_HPH_PA_CTL2, 0x10),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHL_OCP_DET_EN, WCD938X_HPH_L_TEST, 0x01),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHR_OCP_DET_EN, WCD938X_HPH_R_TEST, 0x01),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHL_OCP_STATUS, WCD938X_DIGITAL_INTR_STATUS_0, 0x80),\n\tWCD_MBHC_FIELD(WCD_MBHC_HPHR_OCP_STATUS, WCD938X_DIGITAL_INTR_STATUS_0, 0x20),\n\tWCD_MBHC_FIELD(WCD_MBHC_ADC_EN, WCD938X_MBHC_NEW_CTL_1, 0x08),\n\tWCD_MBHC_FIELD(WCD_MBHC_ADC_COMPLETE, WCD938X_MBHC_NEW_FSM_STATUS, 0x40),\n\tWCD_MBHC_FIELD(WCD_MBHC_ADC_TIMEOUT, WCD938X_MBHC_NEW_FSM_STATUS, 0x80),\n\tWCD_MBHC_FIELD(WCD_MBHC_ADC_RESULT, WCD938X_MBHC_NEW_ADC_RESULT, 0xFF),\n\tWCD_MBHC_FIELD(WCD_MBHC_MICB2_VOUT, WCD938X_ANA_MICB2, 0x3F),\n\tWCD_MBHC_FIELD(WCD_MBHC_ADC_MODE, WCD938X_MBHC_NEW_CTL_1, 0x10),\n\tWCD_MBHC_FIELD(WCD_MBHC_DETECTION_DONE, WCD938X_MBHC_NEW_CTL_1, 0x04),\n\tWCD_MBHC_FIELD(WCD_MBHC_ELECT_ISRC_EN, WCD938X_ANA_MBHC_ZDET, 0x02),\n};\n\nstatic const struct regmap_irq wcd938x_irqs[WCD938X_NUM_IRQS] = {\n\tREGMAP_IRQ_REG(WCD938X_IRQ_MBHC_BUTTON_PRESS_DET, 0, 0x01),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_MBHC_BUTTON_RELEASE_DET, 0, 0x02),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_MBHC_ELECT_INS_REM_DET, 0, 0x04),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_MBHC_ELECT_INS_REM_LEG_DET, 0, 0x08),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_MBHC_SW_DET, 0, 0x10),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHR_OCP_INT, 0, 0x20),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHR_CNP_INT, 0, 0x40),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHL_OCP_INT, 0, 0x80),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHL_CNP_INT, 1, 0x01),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_EAR_CNP_INT, 1, 0x02),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_EAR_SCD_INT, 1, 0x04),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_AUX_CNP_INT, 1, 0x08),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_AUX_SCD_INT, 1, 0x10),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHL_PDM_WD_INT, 1, 0x20),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHR_PDM_WD_INT, 1, 0x40),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_AUX_PDM_WD_INT, 1, 0x80),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_LDORT_SCD_INT, 2, 0x01),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_MBHC_MOISTURE_INT, 2, 0x02),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHL_SURGE_DET_INT, 2, 0x04),\n\tREGMAP_IRQ_REG(WCD938X_IRQ_HPHR_SURGE_DET_INT, 2, 0x08),\n};\n\nstatic struct regmap_irq_chip wcd938x_regmap_irq_chip = {\n\t.name = \"wcd938x\",\n\t.irqs = wcd938x_irqs,\n\t.num_irqs = ARRAY_SIZE(wcd938x_irqs),\n\t.num_regs = 3,\n\t.status_base = WCD938X_DIGITAL_INTR_STATUS_0,\n\t.mask_base = WCD938X_DIGITAL_INTR_MASK_0,\n\t.ack_base = WCD938X_DIGITAL_INTR_CLEAR_0,\n\t.use_ack = 1,\n\t.runtime_pm = true,\n\t.irq_drv_data = NULL,\n};\n\nstatic int wcd938x_get_clk_rate(int mode)\n{\n\tint rate;\n\n\tswitch (mode) {\n\tcase ADC_MODE_ULP2:\n\t\trate = SWR_CLK_RATE_0P6MHZ;\n\t\tbreak;\n\tcase ADC_MODE_ULP1:\n\t\trate = SWR_CLK_RATE_1P2MHZ;\n\t\tbreak;\n\tcase ADC_MODE_LP:\n\t\trate = SWR_CLK_RATE_4P8MHZ;\n\t\tbreak;\n\tcase ADC_MODE_NORMAL:\n\tcase ADC_MODE_LO_HIF:\n\tcase ADC_MODE_HIFI:\n\tcase ADC_MODE_INVALID:\n\tdefault:\n\t\trate = SWR_CLK_RATE_9P6MHZ;\n\t\tbreak;\n\t}\n\n\treturn rate;\n}\n\nstatic int wcd938x_set_swr_clk_rate(struct snd_soc_component *component, int rate, int bank)\n{\n\tu8 mask = (bank ? 0xF0 : 0x0F);\n\tu8 val = 0;\n\n\tswitch (rate) {\n\tcase SWR_CLK_RATE_0P6MHZ:\n\t\tval = (bank ? 0x60 : 0x06);\n\t\tbreak;\n\tcase SWR_CLK_RATE_1P2MHZ:\n\t\tval = (bank ? 0x50 : 0x05);\n\t\tbreak;\n\tcase SWR_CLK_RATE_2P4MHZ:\n\t\tval = (bank ? 0x30 : 0x03);\n\t\tbreak;\n\tcase SWR_CLK_RATE_4P8MHZ:\n\t\tval = (bank ? 0x10 : 0x01);\n\t\tbreak;\n\tcase SWR_CLK_RATE_9P6MHZ:\n\tdefault:\n\t\tval = 0x00;\n\t\tbreak;\n\t}\n\tsnd_soc_component_update_bits(component, WCD938X_DIGITAL_SWR_TX_CLK_RATE,\n\t\t\t\t      mask, val);\n\n\treturn 0;\n}\n\nstatic int wcd938x_io_init(struct wcd938x_priv *wcd938x)\n{\n\tstruct regmap *rm = wcd938x->regmap;\n\n\tregmap_update_bits(rm, WCD938X_SLEEP_CTL, 0x0E, 0x0E);\n\tregmap_update_bits(rm, WCD938X_SLEEP_CTL, 0x80, 0x80);\n\t \n\tusleep_range(1000, 1010);\n\tregmap_update_bits(rm, WCD938X_SLEEP_CTL, 0x40, 0x40);\n\t \n\tusleep_range(1000, 1010);\n\tregmap_update_bits(rm, WCD938X_LDORXTX_CONFIG, 0x10, 0x00);\n\tregmap_update_bits(rm, WCD938X_BIAS_VBG_FINE_ADJ,\n\t\t\t\t\t\t\t\t0xF0, 0x80);\n\tregmap_update_bits(rm, WCD938X_ANA_BIAS, 0x80, 0x80);\n\tregmap_update_bits(rm, WCD938X_ANA_BIAS, 0x40, 0x40);\n\t \n\tusleep_range(10000, 10010);\n\n\tregmap_update_bits(rm, WCD938X_ANA_BIAS, 0x40, 0x00);\n\tregmap_update_bits(rm, WCD938X_HPH_NEW_INT_RDAC_GAIN_CTL,\n\t\t\t\t      0xF0, 0x00);\n\tregmap_update_bits(rm, WCD938X_HPH_NEW_INT_RDAC_HD2_CTL_L_NEW,\n\t\t\t\t      0x1F, 0x15);\n\tregmap_update_bits(rm, WCD938X_HPH_NEW_INT_RDAC_HD2_CTL_R_NEW,\n\t\t\t\t      0x1F, 0x15);\n\tregmap_update_bits(rm, WCD938X_HPH_REFBUFF_UHQA_CTL,\n\t\t\t\t      0xC0, 0x80);\n\tregmap_update_bits(rm, WCD938X_DIGITAL_CDC_DMIC_CTL,\n\t\t\t\t      0x02, 0x02);\n\n\tregmap_update_bits(rm, WCD938X_TX_COM_NEW_INT_TXFE_ICTRL_STG2CASC_ULP,\n\t\t\t   0xFF, 0x14);\n\tregmap_update_bits(rm, WCD938X_TX_COM_NEW_INT_TXFE_ICTRL_STG2MAIN_ULP,\n\t\t\t   0x1F, 0x08);\n\n\tregmap_update_bits(rm, WCD938X_DIGITAL_TX_REQ_FB_CTL_0, 0xFF, 0x55);\n\tregmap_update_bits(rm, WCD938X_DIGITAL_TX_REQ_FB_CTL_1, 0xFF, 0x44);\n\tregmap_update_bits(rm, WCD938X_DIGITAL_TX_REQ_FB_CTL_2, 0xFF, 0x11);\n\tregmap_update_bits(rm, WCD938X_DIGITAL_TX_REQ_FB_CTL_3, 0xFF, 0x00);\n\tregmap_update_bits(rm, WCD938X_DIGITAL_TX_REQ_FB_CTL_4, 0xFF, 0x00);\n\n\t \n\tregmap_update_bits(rm, WCD938X_MICB1_TEST_CTL_1, 0xE0, 0xE0);\n\tregmap_update_bits(rm, WCD938X_MICB2_TEST_CTL_1, 0xE0, 0xE0);\n\tregmap_update_bits(rm, WCD938X_MICB3_TEST_CTL_1, 0xE0, 0xE0);\n\tregmap_update_bits(rm, WCD938X_MICB4_TEST_CTL_1, 0xE0, 0xE0);\n\n\tregmap_update_bits(rm, WCD938X_TX_3_4_TEST_BLK_EN2, 0x01, 0x00);\n\tregmap_update_bits(rm, WCD938X_HPH_SURGE_HPHLR_SURGE_EN, 0xC0, 0xC0);\n\n\treturn 0;\n\n}\n\nstatic int wcd938x_sdw_connect_port(struct wcd938x_sdw_ch_info *ch_info,\n\t\t\t\t    struct sdw_port_config *port_config,\n\t\t\t\t    u8 enable)\n{\n\tu8 ch_mask, port_num;\n\n\tport_num = ch_info->port_num;\n\tch_mask = ch_info->ch_mask;\n\n\tport_config->num = port_num;\n\n\tif (enable)\n\t\tport_config->ch_mask |= ch_mask;\n\telse\n\t\tport_config->ch_mask &= ~ch_mask;\n\n\treturn 0;\n}\n\nstatic int wcd938x_connect_port(struct wcd938x_sdw_priv *wcd, u8 port_num, u8 ch_id, u8 enable)\n{\n\treturn wcd938x_sdw_connect_port(&wcd->ch_info[ch_id],\n\t\t\t\t\t&wcd->port_config[port_num - 1],\n\t\t\t\t\tenable);\n}\n\nstatic int wcd938x_codec_enable_rxclk(struct snd_soc_dapm_widget *w,\n\t\t\t\t      struct snd_kcontrol *kcontrol,\n\t\t\t\t      int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_RX_CLK_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\tWCD938X_RX_BIAS_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_RX0_CTL,\n\t\t\t\tWCD938X_DEM_DITHER_ENABLE_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_RX1_CTL,\n\t\t\t\tWCD938X_DEM_DITHER_ENABLE_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_RX2_CTL,\n\t\t\t\tWCD938X_DEM_DITHER_ENABLE_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_RX_DIV2_CLK_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component, WCD938X_AUX_AUXPA,\n\t\t\t\t\t      WCD938X_AUXPA_CLK_EN_MASK, 1);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\tWCD938X_VNEG_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\tWCD938X_VPOS_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\tWCD938X_RX_BIAS_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_RX_DIV2_CLK_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_RX_CLK_EN_MASK, 0);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wcd938x_codec_hphl_dac_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t\tstruct snd_kcontrol *kcontrol,\n\t\t\t\t\tint event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD0_CLK_EN_MASK, 0x01);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_HPH_GAIN_CTL,\n\t\t\t\tWCD938X_HPHL_RX_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_HPH_RDAC_CLK_CTL1,\n\t\t\t\tWCD938X_CHOP_CLK_EN_MASK, 0);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_HPH_NEW_INT_RDAC_HD2_CTL_L,\n\t\t\t\tWCD938X_HPH_RES_DIV_MASK, 0x02);\n\t\tif (wcd938x->comp1_enable) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0,\n\t\t\t\tWCD938X_HPHL_COMP_EN_MASK, 1);\n\t\t\t \n\t\t\tif (!wcd938x->comp2_enable || (snd_soc_component_read(component,\n\t\t\t\t\t\t\t WCD938X_DIGITAL_CDC_COMP_CTL_0) & 0x01))\n\t\t\t\tusleep_range(5000, 5010);\n\t\t\tsnd_soc_component_write_field(component, WCD938X_HPH_NEW_INT_HPH_TIMER1,\n\t\t\t\t\t      WCD938X_AUTOCHOP_TIMER_EN, 0);\n\t\t} else {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0,\n\t\t\t\t\tWCD938X_HPHL_COMP_EN_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_HPH_L_EN,\n\t\t\t\t\tWCD938X_GAIN_SRC_SEL_MASK,\n\t\t\t\t\tWCD938X_GAIN_SRC_SEL_REGISTER);\n\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_write_field(component,\n\t\t\tWCD938X_HPH_NEW_INT_RDAC_HD2_CTL_R,\n\t\t\tWCD938X_HPH_RES_DIV_MASK, 0x1);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_hphr_dac_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t\tstruct snd_kcontrol *kcontrol,\n\t\t\t\t\tint event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD1_CLK_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_HPH_GAIN_CTL,\n\t\t\t\tWCD938X_HPHR_RX_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_HPH_RDAC_CLK_CTL1,\n\t\t\t\tWCD938X_CHOP_CLK_EN_MASK, 0);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_HPH_NEW_INT_RDAC_HD2_CTL_R,\n\t\t\t\tWCD938X_HPH_RES_DIV_MASK, 0x02);\n\t\tif (wcd938x->comp2_enable) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0,\n\t\t\t\tWCD938X_HPHR_COMP_EN_MASK, 1);\n\t\t\t \n\t\t\tif (!wcd938x->comp1_enable ||\n\t\t\t\t(snd_soc_component_read(component,\n\t\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0) & 0x02))\n\t\t\t\tusleep_range(5000, 5010);\n\t\t\tsnd_soc_component_write_field(component, WCD938X_HPH_NEW_INT_HPH_TIMER1,\n\t\t\t\t\t      WCD938X_AUTOCHOP_TIMER_EN, 0);\n\t\t} else {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0,\n\t\t\t\t\tWCD938X_HPHR_COMP_EN_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_HPH_R_EN,\n\t\t\t\t\tWCD938X_GAIN_SRC_SEL_MASK,\n\t\t\t\t\tWCD938X_GAIN_SRC_SEL_REGISTER);\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_write_field(component,\n\t\t\tWCD938X_HPH_NEW_INT_RDAC_HD2_CTL_R,\n\t\t\tWCD938X_HPH_RES_DIV_MASK, 0x01);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_ear_dac_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t       struct snd_kcontrol *kcontrol,\n\t\t\t\t       int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\twcd938x->ear_rx_path =\n\t\t\tsnd_soc_component_read(\n\t\t\t\tcomponent, WCD938X_DIGITAL_CDC_EAR_PATH_CTL);\n\t\tif (wcd938x->ear_rx_path & EAR_RX_PATH_AUX) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_EAR_EAR_DAC_CON,\n\t\t\t\tWCD938X_DAC_SAMPLE_EDGE_SEL_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_AUX_GAIN_CTL,\n\t\t\t\tWCD938X_AUX_EN_MASK, 1);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD2_CLK_EN_MASK, 1);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_ANA_EAR_COMPANDER_CTL,\n\t\t\t\tWCD938X_GAIN_OVRD_REG_MASK, 1);\n\t\t} else {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_HPH_GAIN_CTL,\n\t\t\t\tWCD938X_HPHL_RX_EN_MASK, 1);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD0_CLK_EN_MASK, 1);\n\t\t\tif (wcd938x->comp1_enable)\n\t\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0,\n\t\t\t\t\tWCD938X_HPHL_COMP_EN_MASK, 1);\n\t\t}\n\t\t \n\t\tusleep_range(5000, 5010);\n\t\tif (wcd938x->flyback_cur_det_disable == 0)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_FLYBACK_EN,\n\t\t\t\t\t\t      WCD938X_EN_CUR_DET_MASK, 0);\n\t\twcd938x->flyback_cur_det_disable++;\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info,\n\t\t\t     WCD_CLSH_EVENT_PRE_DAC,\n\t\t\t     WCD_CLSH_STATE_EAR,\n\t\t\t     wcd938x->hph_mode);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tif (wcd938x->ear_rx_path & EAR_RX_PATH_AUX) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_AUX_GAIN_CTL,\n\t\t\t\tWCD938X_AUX_EN_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD2_CLK_EN_MASK, 0);\n\t\t} else {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_HPH_GAIN_CTL,\n\t\t\t\tWCD938X_HPHL_RX_EN_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD0_CLK_EN_MASK, 0);\n\t\t\tif (wcd938x->comp1_enable)\n\t\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_DIGITAL_CDC_COMP_CTL_0,\n\t\t\t\t\tWCD938X_HPHL_COMP_EN_MASK, 0);\n\t\t}\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_EAR_COMPANDER_CTL,\n\t\t\t\t\t      WCD938X_GAIN_OVRD_REG_MASK, 0);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_EAR_EAR_DAC_CON,\n\t\t\t\tWCD938X_DAC_SAMPLE_EDGE_SEL_MASK, 1);\n\t\tbreak;\n\t}\n\treturn 0;\n\n}\n\nstatic int wcd938x_codec_aux_dac_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t       struct snd_kcontrol *kcontrol,\n\t\t\t\t       int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_RX_DIV4_CLK_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_RXD2_CLK_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_AUX_GAIN_CTL,\n\t\t\t\tWCD938X_AUX_EN_MASK, 1);\n\t\tif (wcd938x->flyback_cur_det_disable == 0)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_FLYBACK_EN,\n\t\t\t\t\t\t      WCD938X_EN_CUR_DET_MASK, 0);\n\t\twcd938x->flyback_cur_det_disable++;\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info,\n\t\t\t     WCD_CLSH_EVENT_PRE_DAC,\n\t\t\t     WCD_CLSH_STATE_AUX,\n\t\t\t     wcd938x->hph_mode);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_RX_DIV4_CLK_EN_MASK, 0);\n\t\tbreak;\n\t}\n\treturn 0;\n\n}\n\nstatic int wcd938x_codec_enable_hphr_pa(struct snd_soc_dapm_widget *w,\n\t\t\t\t\tstruct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint hph_mode = wcd938x->hph_mode;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (wcd938x->ldoh)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_LDOH_MODE,\n\t\t\t\t\t\t      WCD938X_LDOH_EN_MASK, 1);\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info, WCD_CLSH_EVENT_PRE_DAC,\n\t\t\t\t\tWCD_CLSH_STATE_HPHR, hph_mode);\n\t\twcd_clsh_set_hph_mode(wcd938x->clsh_info, CLS_H_HIFI);\n\n\t\tif (hph_mode == CLS_H_LP || hph_mode == CLS_H_LOHIFI ||\n\t\t    hph_mode == CLS_H_ULP) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_HPH_REFBUFF_LP_CTL,\n\t\t\t\tWCD938X_PREREF_FLIT_BYPASS_MASK, 1);\n\t\t}\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_HPH,\n\t\t\t\t\t      WCD938X_HPHR_REF_EN_MASK, 1);\n\t\twcd_clsh_set_hph_mode(wcd938x->clsh_info, hph_mode);\n\t\t \n\t\tusleep_range(100, 110);\n\t\tset_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t      WCD938X_DIGITAL_PDM_WD_CTL1,\n\t\t\t\t\t      WCD938X_PDM_WD_EN_MASK, 0x3);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tif (test_bit(HPH_PA_DELAY, &wcd938x->status_mask)) {\n\t\t\tif (!wcd938x->comp2_enable)\n\t\t\t\tusleep_range(20000, 20100);\n\t\t\telse\n\t\t\t\tusleep_range(7000, 7100);\n\n\t\t\tif (hph_mode == CLS_H_LP || hph_mode == CLS_H_LOHIFI ||\n\t\t\t    hph_mode == CLS_H_ULP)\n\t\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t\tWCD938X_HPH_REFBUFF_LP_CTL,\n\t\t\t\t\t\tWCD938X_PREREF_FLIT_BYPASS_MASK, 0);\n\t\t\tclear_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\t}\n\t\tsnd_soc_component_write_field(component, WCD938X_HPH_NEW_INT_HPH_TIMER1,\n\t\t\t\t\t      WCD938X_AUTOCHOP_TIMER_EN, 1);\n\t\tif (hph_mode == CLS_AB || hph_mode == CLS_AB_HIFI ||\n\t\t\thph_mode == CLS_AB_LP || hph_mode == CLS_AB_LOHIFI)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_MASK,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_CLASS_AB);\n\t\tenable_irq(wcd938x->hphr_pdm_wd_int);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tdisable_irq_nosync(wcd938x->hphr_pdm_wd_int);\n\t\t \n\t\tif (!wcd938x->comp2_enable)\n\t\t\tusleep_range(20000, 20100);\n\t\telse\n\t\t\tusleep_range(7000, 7100);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_HPH,\n\t\t\t\t\t      WCD938X_HPHR_EN_MASK, 0);\n\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t     WCD_EVENT_PRE_HPHR_PA_OFF);\n\t\tset_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tif (test_bit(HPH_PA_DELAY, &wcd938x->status_mask)) {\n\t\t\tif (!wcd938x->comp2_enable)\n\t\t\t\tusleep_range(20000, 20100);\n\t\t\telse\n\t\t\t\tusleep_range(7000, 7100);\n\t\t\tclear_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\t}\n\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t     WCD_EVENT_POST_HPHR_PA_OFF);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_HPH,\n\t\t\t\t\t      WCD938X_HPHR_REF_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL1,\n\t\t\t\t\t      WCD938X_PDM_WD_EN_MASK, 0);\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info, WCD_CLSH_EVENT_POST_PA,\n\t\t\t\t\tWCD_CLSH_STATE_HPHR, hph_mode);\n\t\tif (wcd938x->ldoh)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_LDOH_MODE,\n\t\t\t\t\t\t      WCD938X_LDOH_EN_MASK, 0);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_enable_hphl_pa(struct snd_soc_dapm_widget *w,\n\t\t\t\t\tstruct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint hph_mode = wcd938x->hph_mode;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (wcd938x->ldoh)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_LDOH_MODE,\n\t\t\t\t\t\t      WCD938X_LDOH_EN_MASK, 1);\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info, WCD_CLSH_EVENT_PRE_DAC,\n\t\t\t\t\tWCD_CLSH_STATE_HPHL, hph_mode);\n\t\twcd_clsh_set_hph_mode(wcd938x->clsh_info, CLS_H_HIFI);\n\t\tif (hph_mode == CLS_H_LP || hph_mode == CLS_H_LOHIFI ||\n\t\t    hph_mode == CLS_H_ULP) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_HPH_REFBUFF_LP_CTL,\n\t\t\t\t\tWCD938X_PREREF_FLIT_BYPASS_MASK, 1);\n\t\t}\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_HPH,\n\t\t\t\t\t      WCD938X_HPHL_REF_EN_MASK, 1);\n\t\twcd_clsh_set_hph_mode(wcd938x->clsh_info, hph_mode);\n\t\t \n\t\tusleep_range(100, 110);\n\t\tset_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_DIGITAL_PDM_WD_CTL0,\n\t\t\t\t\tWCD938X_PDM_WD_EN_MASK, 0x3);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tif (test_bit(HPH_PA_DELAY, &wcd938x->status_mask)) {\n\t\t\tif (!wcd938x->comp1_enable)\n\t\t\t\tusleep_range(20000, 20100);\n\t\t\telse\n\t\t\t\tusleep_range(7000, 7100);\n\t\t\tif (hph_mode == CLS_H_LP || hph_mode == CLS_H_LOHIFI ||\n\t\t\t    hph_mode == CLS_H_ULP)\n\t\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\tWCD938X_HPH_REFBUFF_LP_CTL,\n\t\t\t\t\tWCD938X_PREREF_FLIT_BYPASS_MASK, 0);\n\t\t\tclear_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\t}\n\n\t\tsnd_soc_component_write_field(component, WCD938X_HPH_NEW_INT_HPH_TIMER1,\n\t\t\t\t\t      WCD938X_AUTOCHOP_TIMER_EN, 1);\n\t\tif (hph_mode == CLS_AB || hph_mode == CLS_AB_HIFI ||\n\t\t\thph_mode == CLS_AB_LP || hph_mode == CLS_AB_LOHIFI)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_MASK,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_CLASS_AB);\n\t\tenable_irq(wcd938x->hphl_pdm_wd_int);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tdisable_irq_nosync(wcd938x->hphl_pdm_wd_int);\n\t\t \n\t\tif (!wcd938x->comp1_enable)\n\t\t\tusleep_range(20000, 20100);\n\t\telse\n\t\t\tusleep_range(7000, 7100);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_HPH,\n\t\t\t\t\t      WCD938X_HPHL_EN_MASK, 0);\n\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc, WCD_EVENT_PRE_HPHL_PA_OFF);\n\t\tset_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tif (test_bit(HPH_PA_DELAY, &wcd938x->status_mask)) {\n\t\t\tif (!wcd938x->comp1_enable)\n\t\t\t\tusleep_range(21000, 21100);\n\t\t\telse\n\t\t\t\tusleep_range(7000, 7100);\n\t\t\tclear_bit(HPH_PA_DELAY, &wcd938x->status_mask);\n\t\t}\n\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t     WCD_EVENT_POST_HPHL_PA_OFF);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_HPH,\n\t\t\t\t\t      WCD938X_HPHL_REF_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL0,\n\t\t\t\t\t      WCD938X_PDM_WD_EN_MASK, 0);\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info, WCD_CLSH_EVENT_POST_PA,\n\t\t\t\t\tWCD_CLSH_STATE_HPHL, hph_mode);\n\t\tif (wcd938x->ldoh)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_LDOH_MODE,\n\t\t\t\t\t\t      WCD938X_LDOH_EN_MASK, 0);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_enable_aux_pa(struct snd_soc_dapm_widget *w,\n\t\t\t\t       struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint hph_mode = wcd938x->hph_mode;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL2,\n\t\t\t\t\t      WCD938X_AUX_PDM_WD_EN_MASK, 1);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tusleep_range(1000, 1010);\n\t\tif (hph_mode == CLS_AB || hph_mode == CLS_AB_HIFI ||\n\t\t\thph_mode == CLS_AB_LP || hph_mode == CLS_AB_LOHIFI)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_MASK,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_CLASS_AB);\n\t\tenable_irq(wcd938x->aux_pdm_wd_int);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tdisable_irq_nosync(wcd938x->aux_pdm_wd_int);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tusleep_range(1000, 1010);\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL2,\n\t\t\t\t\t      WCD938X_AUX_PDM_WD_EN_MASK, 0);\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info,\n\t\t\t     WCD_CLSH_EVENT_POST_PA,\n\t\t\t     WCD_CLSH_STATE_AUX,\n\t\t\t     hph_mode);\n\n\t\twcd938x->flyback_cur_det_disable--;\n\t\tif (wcd938x->flyback_cur_det_disable == 0)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_FLYBACK_EN,\n\t\t\t\t\t\t      WCD938X_EN_CUR_DET_MASK, 1);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wcd938x_codec_enable_ear_pa(struct snd_soc_dapm_widget *w,\n\t\t\t\t       struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint hph_mode = wcd938x->hph_mode;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\twcd938x->ear_rx_path = snd_soc_component_read(component,\n\t\t\t\t\t\t\t      WCD938X_DIGITAL_CDC_EAR_PATH_CTL);\n\t\tif (wcd938x->ear_rx_path & EAR_RX_PATH_AUX)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL2,\n\t\t\t\t\t      WCD938X_AUX_PDM_WD_EN_MASK, 1);\n\t\telse\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t\t      WCD938X_DIGITAL_PDM_WD_CTL0,\n\t\t\t\t\t\t      WCD938X_PDM_WD_EN_MASK, 0x3);\n\t\tif (!wcd938x->comp1_enable)\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t\t      WCD938X_ANA_EAR_COMPANDER_CTL,\n\t\t\t\t\t\t      WCD938X_GAIN_OVRD_REG_MASK, 1);\n\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tusleep_range(6000, 6010);\n\t\tif (hph_mode == CLS_AB || hph_mode == CLS_AB_HIFI ||\n\t\t\thph_mode == CLS_AB_LP || hph_mode == CLS_AB_LOHIFI)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_ANA_RX_SUPPLIES,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_MASK,\n\t\t\t\t\tWCD938X_REGULATOR_MODE_CLASS_AB);\n\t\tif (wcd938x->ear_rx_path & EAR_RX_PATH_AUX)\n\t\t\tenable_irq(wcd938x->aux_pdm_wd_int);\n\t\telse\n\t\t\tenable_irq(wcd938x->hphl_pdm_wd_int);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tif (wcd938x->ear_rx_path & EAR_RX_PATH_AUX)\n\t\t\tdisable_irq_nosync(wcd938x->aux_pdm_wd_int);\n\t\telse\n\t\t\tdisable_irq_nosync(wcd938x->hphl_pdm_wd_int);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tif (!wcd938x->comp1_enable)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_ANA_EAR_COMPANDER_CTL,\n\t\t\t\t\t\t      WCD938X_GAIN_OVRD_REG_MASK, 0);\n\t\t \n\t\tusleep_range(7000, 7010);\n\t\tif (wcd938x->ear_rx_path & EAR_RX_PATH_AUX)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL2,\n\t\t\t\t\t      WCD938X_AUX_PDM_WD_EN_MASK, 0);\n\t\telse\n\t\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_PDM_WD_CTL0,\n\t\t\t\t\tWCD938X_PDM_WD_EN_MASK, 0);\n\n\t\twcd_clsh_ctrl_set_state(wcd938x->clsh_info, WCD_CLSH_EVENT_POST_PA,\n\t\t\t\t\tWCD_CLSH_STATE_EAR, hph_mode);\n\n\t\twcd938x->flyback_cur_det_disable--;\n\t\tif (wcd938x->flyback_cur_det_disable == 0)\n\t\t\tsnd_soc_component_write_field(component, WCD938X_FLYBACK_EN,\n\t\t\t\t\t\t      WCD938X_EN_CUR_DET_MASK, 1);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_enable_dmic(struct snd_soc_dapm_widget *w,\n\t\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t\t     int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tu16 dmic_clk_reg, dmic_clk_en_reg;\n\tu8 dmic_sel_mask, dmic_clk_mask;\n\n\tswitch (w->shift) {\n\tcase 0:\n\tcase 1:\n\t\tdmic_clk_reg = WCD938X_DIGITAL_CDC_DMIC_RATE_1_2;\n\t\tdmic_clk_en_reg = WCD938X_DIGITAL_CDC_DMIC1_CTL;\n\t\tdmic_clk_mask = WCD938X_DMIC1_RATE_MASK;\n\t\tdmic_sel_mask = WCD938X_AMIC1_IN_SEL_MASK;\n\t\tbreak;\n\tcase 2:\n\tcase 3:\n\t\tdmic_clk_reg = WCD938X_DIGITAL_CDC_DMIC_RATE_1_2;\n\t\tdmic_clk_en_reg = WCD938X_DIGITAL_CDC_DMIC2_CTL;\n\t\tdmic_clk_mask = WCD938X_DMIC2_RATE_MASK;\n\t\tdmic_sel_mask = WCD938X_AMIC3_IN_SEL_MASK;\n\t\tbreak;\n\tcase 4:\n\tcase 5:\n\t\tdmic_clk_reg = WCD938X_DIGITAL_CDC_DMIC_RATE_3_4;\n\t\tdmic_clk_en_reg = WCD938X_DIGITAL_CDC_DMIC3_CTL;\n\t\tdmic_clk_mask = WCD938X_DMIC3_RATE_MASK;\n\t\tdmic_sel_mask = WCD938X_AMIC4_IN_SEL_MASK;\n\t\tbreak;\n\tcase 6:\n\tcase 7:\n\t\tdmic_clk_reg = WCD938X_DIGITAL_CDC_DMIC_RATE_3_4;\n\t\tdmic_clk_en_reg = WCD938X_DIGITAL_CDC_DMIC4_CTL;\n\t\tdmic_clk_mask = WCD938X_DMIC4_RATE_MASK;\n\t\tdmic_sel_mask = WCD938X_AMIC5_IN_SEL_MASK;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"%s: Invalid DMIC Selection\\n\",\n\t\t\t__func__);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_AMIC_CTL,\n\t\t\t\tdmic_sel_mask,\n\t\t\t\tWCD938X_AMIC1_IN_SEL_DMIC);\n\t\t \n\t\tusleep_range(250, 260);\n\t\t \n\t\tsnd_soc_component_write_field(component, dmic_clk_reg,\n\t\t\t\t\t      dmic_clk_mask,\n\t\t\t\t\t      WCD938X_DMIC4_RATE_2P4MHZ);\n\t\tsnd_soc_component_write_field(component, dmic_clk_en_reg,\n\t\t\t\t\t      WCD938X_DMIC_CLK_EN_MASK, 1);\n\t\t \n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_DMIC_CTL,\n\t\t\t\t\t      WCD938X_DMIC_CLK_SCALING_EN_MASK, 0x3);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_AMIC_CTL,\n\t\t\t\tdmic_sel_mask, WCD938X_AMIC1_IN_SEL_AMIC);\n\t\tsnd_soc_component_write_field(component, dmic_clk_en_reg,\n\t\t\t\t\t      WCD938X_DMIC_CLK_EN_MASK, 0);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wcd938x_tx_swr_ctrl(struct snd_soc_dapm_widget *w,\n\t\t\t       struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint bank;\n\tint rate;\n\n\tbank = (wcd938x_swr_get_current_bank(wcd938x->sdw_priv[AIF1_CAP]->sdev)) ? 0 : 1;\n\tbank = bank ? 0 : 1;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (strnstr(w->name, \"ADC\", sizeof(\"ADC\"))) {\n\t\t\tint i = 0, mode = 0;\n\n\t\t\tif (test_bit(WCD_ADC1, &wcd938x->status_mask))\n\t\t\t\tmode |= tx_mode_bit[wcd938x->tx_mode[WCD_ADC1]];\n\t\t\tif (test_bit(WCD_ADC2, &wcd938x->status_mask))\n\t\t\t\tmode |= tx_mode_bit[wcd938x->tx_mode[WCD_ADC2]];\n\t\t\tif (test_bit(WCD_ADC3, &wcd938x->status_mask))\n\t\t\t\tmode |= tx_mode_bit[wcd938x->tx_mode[WCD_ADC3]];\n\t\t\tif (test_bit(WCD_ADC4, &wcd938x->status_mask))\n\t\t\t\tmode |= tx_mode_bit[wcd938x->tx_mode[WCD_ADC4]];\n\n\t\t\tif (mode != 0) {\n\t\t\t\tfor (i = 0; i < ADC_MODE_ULP2; i++) {\n\t\t\t\t\tif (mode & (1 << i)) {\n\t\t\t\t\t\ti++;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\trate = wcd938x_get_clk_rate(i);\n\t\t\twcd938x_set_swr_clk_rate(component, rate, bank);\n\t\t\t \n\t\t\twcd938x_set_swr_clk_rate(component, rate, !bank);\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tif (strnstr(w->name, \"ADC\", sizeof(\"ADC\"))) {\n\t\t\trate = wcd938x_get_clk_rate(ADC_MODE_INVALID);\n\t\t\twcd938x_set_swr_clk_rate(component, rate, !bank);\n\t\t\twcd938x_set_swr_clk_rate(component, rate, bank);\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_get_adc_mode(int val)\n{\n\tint ret = 0;\n\n\tswitch (val) {\n\tcase ADC_MODE_INVALID:\n\t\tret = ADC_MODE_VAL_NORMAL;\n\t\tbreak;\n\tcase ADC_MODE_HIFI:\n\t\tret = ADC_MODE_VAL_HIFI;\n\t\tbreak;\n\tcase ADC_MODE_LO_HIF:\n\t\tret = ADC_MODE_VAL_LO_HIF;\n\t\tbreak;\n\tcase ADC_MODE_NORMAL:\n\t\tret = ADC_MODE_VAL_NORMAL;\n\t\tbreak;\n\tcase ADC_MODE_LP:\n\t\tret = ADC_MODE_VAL_LP;\n\t\tbreak;\n\tcase ADC_MODE_ULP1:\n\t\tret = ADC_MODE_VAL_ULP1;\n\t\tbreak;\n\tcase ADC_MODE_ULP2:\n\t\tret = ADC_MODE_VAL_ULP2;\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int wcd938x_codec_enable_adc(struct snd_soc_dapm_widget *w,\n\t\t\t\t    struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t      WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\t\t      WCD938X_ANA_TX_CLK_EN_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t      WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\t\t      WCD938X_ANA_TX_DIV2_CLK_EN_MASK, 1);\n\t\tset_bit(w->shift, &wcd938x->status_mask);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_write_field(component, WCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\t\t      WCD938X_ANA_TX_CLK_EN_MASK, 0);\n\t\tclear_bit(w->shift, &wcd938x->status_mask);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void wcd938x_tx_channel_config(struct snd_soc_component *component,\n\t\t\t\t     int channel, int mode)\n{\n\tint reg, mask;\n\n\tswitch (channel) {\n\tcase 0:\n\t\treg = WCD938X_ANA_TX_CH2;\n\t\tmask = WCD938X_HPF1_INIT_MASK;\n\t\tbreak;\n\tcase 1:\n\t\treg = WCD938X_ANA_TX_CH2;\n\t\tmask = WCD938X_HPF2_INIT_MASK;\n\t\tbreak;\n\tcase 2:\n\t\treg = WCD938X_ANA_TX_CH4;\n\t\tmask = WCD938X_HPF3_INIT_MASK;\n\t\tbreak;\n\tcase 3:\n\t\treg = WCD938X_ANA_TX_CH4;\n\t\tmask = WCD938X_HPF4_INIT_MASK;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tsnd_soc_component_write_field(component, reg, mask, mode);\n}\n\nstatic int wcd938x_adc_enable_req(struct snd_soc_dapm_widget *w,\n\t\t\t\t  struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint mode;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_REQ_CTL,\n\t\t\t\tWCD938X_FS_RATE_4P8_MASK, 1);\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_REQ_CTL,\n\t\t\t\tWCD938X_NO_NOTCH_MASK, 0);\n\t\twcd938x_tx_channel_config(component, w->shift, 1);\n\t\tmode = wcd938x_get_adc_mode(wcd938x->tx_mode[w->shift]);\n\t\tif (mode < 0) {\n\t\t\tdev_info(component->dev, \"Invalid ADC mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tswitch (w->shift) {\n\t\tcase 0:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_0_1,\n\t\t\t\tWCD938X_TXD0_MODE_MASK, mode);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\t\t\tWCD938X_TXD0_CLK_EN_MASK, 1);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_0_1,\n\t\t\t\tWCD938X_TXD1_MODE_MASK, mode);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\t\t      WCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\t\t      WCD938X_TXD1_CLK_EN_MASK, 1);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_2_3,\n\t\t\t\tWCD938X_TXD2_MODE_MASK, mode);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TXD2_CLK_EN_MASK, 1);\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_2_3,\n\t\t\t\tWCD938X_TXD3_MODE_MASK, mode);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TXD3_CLK_EN_MASK, 1);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\twcd938x_tx_channel_config(component, w->shift, 0);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tswitch (w->shift) {\n\t\tcase 0:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_0_1,\n\t\t\t\tWCD938X_TXD0_MODE_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TXD0_CLK_EN_MASK, 0);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_0_1,\n\t\t\t\tWCD938X_TXD1_MODE_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TXD1_CLK_EN_MASK, 0);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_2_3,\n\t\t\t\tWCD938X_TXD2_MODE_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TXD2_CLK_EN_MASK, 0);\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_TX_ANA_MODE_2_3,\n\t\t\t\tWCD938X_TXD3_MODE_MASK, 0);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TXD3_CLK_EN_MASK, 0);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_TX_DIV2_CLK_EN_MASK, 0);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_micbias_control(struct snd_soc_component *component,\n\t\t\t\t   int micb_num, int req, bool is_dapm)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint micb_index = micb_num - 1;\n\tu16 micb_reg;\n\n\tswitch (micb_num) {\n\tcase MIC_BIAS_1:\n\t\tmicb_reg = WCD938X_ANA_MICB1;\n\t\tbreak;\n\tcase MIC_BIAS_2:\n\t\tmicb_reg = WCD938X_ANA_MICB2;\n\t\tbreak;\n\tcase MIC_BIAS_3:\n\t\tmicb_reg = WCD938X_ANA_MICB3;\n\t\tbreak;\n\tcase MIC_BIAS_4:\n\t\tmicb_reg = WCD938X_ANA_MICB4;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"%s: Invalid micbias number: %d\\n\",\n\t\t\t__func__, micb_num);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (req) {\n\tcase MICB_PULLUP_ENABLE:\n\t\twcd938x->pullup_ref[micb_index]++;\n\t\tif ((wcd938x->pullup_ref[micb_index] == 1) &&\n\t\t    (wcd938x->micb_ref[micb_index] == 0))\n\t\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t\t      WCD938X_MICB_EN_MASK,\n\t\t\t\t\t\t      WCD938X_MICB_PULL_UP);\n\t\tbreak;\n\tcase MICB_PULLUP_DISABLE:\n\t\tif (wcd938x->pullup_ref[micb_index] > 0)\n\t\t\twcd938x->pullup_ref[micb_index]--;\n\n\t\tif ((wcd938x->pullup_ref[micb_index] == 0) &&\n\t\t    (wcd938x->micb_ref[micb_index] == 0))\n\t\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t\t      WCD938X_MICB_EN_MASK, 0);\n\t\tbreak;\n\tcase MICB_ENABLE:\n\t\twcd938x->micb_ref[micb_index]++;\n\t\tif (wcd938x->micb_ref[micb_index] == 1) {\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_DIG_CLK_CTL,\n\t\t\t\tWCD938X_TX_CLK_EN_MASK, 0xF);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t\tWCD938X_DIGITAL_CDC_ANA_CLK_CTL,\n\t\t\t\tWCD938X_ANA_TX_DIV2_CLK_EN_MASK, 1);\n\t\t\tsnd_soc_component_write_field(component,\n\t\t\t       WCD938X_DIGITAL_CDC_ANA_TX_CLK_CTL,\n\t\t\t       WCD938X_TX_SC_CLK_EN_MASK, 1);\n\n\t\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t\t      WCD938X_MICB_EN_MASK,\n\t\t\t\t\t\t      WCD938X_MICB_ENABLE);\n\t\t\tif (micb_num  == MIC_BIAS_2)\n\t\t\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t\t      WCD_EVENT_POST_MICBIAS_2_ON);\n\t\t}\n\t\tif (micb_num  == MIC_BIAS_2 && is_dapm)\n\t\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t      WCD_EVENT_POST_DAPM_MICBIAS_2_ON);\n\n\n\t\tbreak;\n\tcase MICB_DISABLE:\n\t\tif (wcd938x->micb_ref[micb_index] > 0)\n\t\t\twcd938x->micb_ref[micb_index]--;\n\n\t\tif ((wcd938x->micb_ref[micb_index] == 0) &&\n\t\t    (wcd938x->pullup_ref[micb_index] > 0))\n\t\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t\t      WCD938X_MICB_EN_MASK,\n\t\t\t\t\t\t      WCD938X_MICB_PULL_UP);\n\t\telse if ((wcd938x->micb_ref[micb_index] == 0) &&\n\t\t\t (wcd938x->pullup_ref[micb_index] == 0)) {\n\t\t\tif (micb_num  == MIC_BIAS_2)\n\t\t\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t\t      WCD_EVENT_PRE_MICBIAS_2_OFF);\n\n\t\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t\t      WCD938X_MICB_EN_MASK, 0);\n\t\t\tif (micb_num  == MIC_BIAS_2)\n\t\t\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t\t      WCD_EVENT_POST_MICBIAS_2_OFF);\n\t\t}\n\t\tif (is_dapm && micb_num  == MIC_BIAS_2)\n\t\t\twcd_mbhc_event_notify(wcd938x->wcd_mbhc,\n\t\t\t\t\t      WCD_EVENT_POST_DAPM_MICBIAS_2_OFF);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_enable_micbias(struct snd_soc_dapm_widget *w,\n\t\t\t\t\tstruct snd_kcontrol *kcontrol,\n\t\t\t\t\tint event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tint micb_num = w->shift;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\twcd938x_micbias_control(component, micb_num, MICB_ENABLE, true);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tusleep_range(1000, 1100);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\twcd938x_micbias_control(component, micb_num, MICB_DISABLE, true);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_enable_micbias_pullup(struct snd_soc_dapm_widget *w,\n\t\t\t\t\t       struct snd_kcontrol *kcontrol,\n\t\t\t\t\t       int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tint micb_num = w->shift;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\twcd938x_micbias_control(component, micb_num,\n\t\t\t\t\tMICB_PULLUP_ENABLE, true);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tusleep_range(1000, 1100);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\twcd938x_micbias_control(component, micb_num,\n\t\t\t\t\tMICB_PULLUP_DISABLE, true);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd938x_tx_mode_get(struct snd_kcontrol *kcontrol,\n\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tint path = e->shift_l;\n\n\tucontrol->value.enumerated.item[0] = wcd938x->tx_mode[path];\n\n\treturn 0;\n}\n\nstatic int wcd938x_tx_mode_put(struct snd_kcontrol *kcontrol,\n\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tint path = e->shift_l;\n\n\tif (wcd938x->tx_mode[path] == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\twcd938x->tx_mode[path] = ucontrol->value.enumerated.item[0];\n\n\treturn 1;\n}\n\nstatic int wcd938x_rx_hph_mode_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.enumerated.item[0] = wcd938x->hph_mode;\n\n\treturn 0;\n}\n\nstatic int wcd938x_rx_hph_mode_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tif (wcd938x->hph_mode == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\twcd938x->hph_mode = ucontrol->value.enumerated.item[0];\n\n\treturn 1;\n}\n\nstatic int wcd938x_ear_pa_put_gain(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tif (wcd938x->comp1_enable) {\n\t\tdev_err(component->dev, \"Can not set EAR PA Gain, compander1 is enabled\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_write_field(component, WCD938X_ANA_EAR_COMPANDER_CTL,\n\t\t\t\t      WCD938X_EAR_GAIN_MASK,\n\t\t\t\t      ucontrol->value.integer.value[0]);\n\n\treturn 1;\n}\n\nstatic int wcd938x_get_compander(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tstruct soc_mixer_control *mc;\n\tbool hphr;\n\n\tmc = (struct soc_mixer_control *)(kcontrol->private_value);\n\thphr = mc->shift;\n\n\tif (hphr)\n\t\tucontrol->value.integer.value[0] = wcd938x->comp2_enable;\n\telse\n\t\tucontrol->value.integer.value[0] = wcd938x->comp1_enable;\n\n\treturn 0;\n}\n\nstatic int wcd938x_set_compander(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tstruct wcd938x_sdw_priv *wcd;\n\tint value = ucontrol->value.integer.value[0];\n\tint portidx;\n\tstruct soc_mixer_control *mc;\n\tbool hphr;\n\n\tmc = (struct soc_mixer_control *)(kcontrol->private_value);\n\thphr = mc->shift;\n\n\twcd = wcd938x->sdw_priv[AIF1_PB];\n\n\tif (hphr)\n\t\twcd938x->comp2_enable = value;\n\telse\n\t\twcd938x->comp1_enable = value;\n\n\tportidx = wcd->ch_info[mc->reg].port_num;\n\n\tif (value)\n\t\twcd938x_connect_port(wcd, portidx, mc->reg, true);\n\telse\n\t\twcd938x_connect_port(wcd, portidx, mc->reg, false);\n\n\treturn 1;\n}\n\nstatic int wcd938x_ldoh_get(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = wcd938x->ldoh;\n\n\treturn 0;\n}\n\nstatic int wcd938x_ldoh_put(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tif (wcd938x->ldoh == ucontrol->value.integer.value[0])\n\t\treturn 0;\n\n\twcd938x->ldoh = ucontrol->value.integer.value[0];\n\n\treturn 1;\n}\n\nstatic int wcd938x_bcs_get(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = wcd938x->bcs_dis;\n\n\treturn 0;\n}\n\nstatic int wcd938x_bcs_put(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tif (wcd938x->bcs_dis == ucontrol->value.integer.value[0])\n\t\treturn 0;\n\n\twcd938x->bcs_dis = ucontrol->value.integer.value[0];\n\n\treturn 1;\n}\n\nstatic const char * const tx_mode_mux_text_wcd9380[] = {\n\t\"ADC_INVALID\", \"ADC_HIFI\", \"ADC_LO_HIF\", \"ADC_NORMAL\", \"ADC_LP\",\n};\n\nstatic const char * const tx_mode_mux_text[] = {\n\t\"ADC_INVALID\", \"ADC_HIFI\", \"ADC_LO_HIF\", \"ADC_NORMAL\", \"ADC_LP\",\n\t\"ADC_ULP1\", \"ADC_ULP2\",\n};\n\nstatic const char * const rx_hph_mode_mux_text_wcd9380[] = {\n\t\"CLS_H_INVALID\", \"CLS_H_INVALID_1\", \"CLS_H_LP\", \"CLS_AB\",\n\t\"CLS_H_LOHIFI\", \"CLS_H_ULP\", \"CLS_H_INVALID_2\", \"CLS_AB_LP\",\n\t\"CLS_AB_LOHIFI\",\n};\n\nstatic const char * const rx_hph_mode_mux_text[] = {\n\t\"CLS_H_INVALID\", \"CLS_H_HIFI\", \"CLS_H_LP\", \"CLS_AB\", \"CLS_H_LOHIFI\",\n\t\"CLS_H_ULP\", \"CLS_AB_HIFI\", \"CLS_AB_LP\", \"CLS_AB_LOHIFI\",\n};\n\nstatic const char * const adc2_mux_text[] = {\n\t\"INP2\", \"INP3\"\n};\n\nstatic const char * const adc3_mux_text[] = {\n\t\"INP4\", \"INP6\"\n};\n\nstatic const char * const adc4_mux_text[] = {\n\t\"INP5\", \"INP7\"\n};\n\nstatic const char * const rdac3_mux_text[] = {\n\t\"RX1\", \"RX3\"\n};\n\nstatic const char * const hdr12_mux_text[] = {\n\t\"NO_HDR12\", \"HDR12\"\n};\n\nstatic const char * const hdr34_mux_text[] = {\n\t\"NO_HDR34\", \"HDR34\"\n};\n\nstatic const struct soc_enum tx0_mode_enum_wcd9380 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 0, ARRAY_SIZE(tx_mode_mux_text_wcd9380),\n\t\t\ttx_mode_mux_text_wcd9380);\n\nstatic const struct soc_enum tx1_mode_enum_wcd9380 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 1, ARRAY_SIZE(tx_mode_mux_text_wcd9380),\n\t\t\ttx_mode_mux_text_wcd9380);\n\nstatic const struct soc_enum tx2_mode_enum_wcd9380 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 2, ARRAY_SIZE(tx_mode_mux_text_wcd9380),\n\t\t\ttx_mode_mux_text_wcd9380);\n\nstatic const struct soc_enum tx3_mode_enum_wcd9380 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 3, ARRAY_SIZE(tx_mode_mux_text_wcd9380),\n\t\t\ttx_mode_mux_text_wcd9380);\n\nstatic const struct soc_enum tx0_mode_enum_wcd9385 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 0, ARRAY_SIZE(tx_mode_mux_text),\n\t\t\ttx_mode_mux_text);\n\nstatic const struct soc_enum tx1_mode_enum_wcd9385 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 1, ARRAY_SIZE(tx_mode_mux_text),\n\t\t\ttx_mode_mux_text);\n\nstatic const struct soc_enum tx2_mode_enum_wcd9385 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 2, ARRAY_SIZE(tx_mode_mux_text),\n\t\t\ttx_mode_mux_text);\n\nstatic const struct soc_enum tx3_mode_enum_wcd9385 =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 3, ARRAY_SIZE(tx_mode_mux_text),\n\t\t\ttx_mode_mux_text);\n\nstatic const struct soc_enum rx_hph_mode_mux_enum_wcd9380 =\n\t\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(rx_hph_mode_mux_text_wcd9380),\n\t\t\t\t    rx_hph_mode_mux_text_wcd9380);\n\nstatic const struct soc_enum rx_hph_mode_mux_enum =\n\t\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(rx_hph_mode_mux_text),\n\t\t\t\t    rx_hph_mode_mux_text);\n\nstatic const struct soc_enum adc2_enum =\n\t\tSOC_ENUM_SINGLE(WCD938X_TX_NEW_AMIC_MUX_CFG, 7,\n\t\t\t\tARRAY_SIZE(adc2_mux_text), adc2_mux_text);\n\nstatic const struct soc_enum adc3_enum =\n\t\tSOC_ENUM_SINGLE(WCD938X_TX_NEW_AMIC_MUX_CFG, 6,\n\t\t\t\tARRAY_SIZE(adc3_mux_text), adc3_mux_text);\n\nstatic const struct soc_enum adc4_enum =\n\t\tSOC_ENUM_SINGLE(WCD938X_TX_NEW_AMIC_MUX_CFG, 5,\n\t\t\t\tARRAY_SIZE(adc4_mux_text), adc4_mux_text);\n\nstatic const struct soc_enum hdr12_enum =\n\t\tSOC_ENUM_SINGLE(WCD938X_TX_NEW_AMIC_MUX_CFG, 4,\n\t\t\t\tARRAY_SIZE(hdr12_mux_text), hdr12_mux_text);\n\nstatic const struct soc_enum hdr34_enum =\n\t\tSOC_ENUM_SINGLE(WCD938X_TX_NEW_AMIC_MUX_CFG, 3,\n\t\t\t\tARRAY_SIZE(hdr34_mux_text), hdr34_mux_text);\n\nstatic const struct soc_enum rdac3_enum =\n\t\tSOC_ENUM_SINGLE(WCD938X_DIGITAL_CDC_EAR_PATH_CTL, 0,\n\t\t\t\tARRAY_SIZE(rdac3_mux_text), rdac3_mux_text);\n\nstatic const struct snd_kcontrol_new adc1_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new adc2_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new adc3_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new adc4_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic1_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic2_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic3_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic4_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic5_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic6_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic7_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new dmic8_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new ear_rdac_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new aux_rdac_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new hphl_rdac_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new hphr_rdac_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0)\n};\n\nstatic const struct snd_kcontrol_new tx_adc2_mux =\n\tSOC_DAPM_ENUM(\"ADC2 MUX Mux\", adc2_enum);\n\nstatic const struct snd_kcontrol_new tx_adc3_mux =\n\tSOC_DAPM_ENUM(\"ADC3 MUX Mux\", adc3_enum);\n\nstatic const struct snd_kcontrol_new tx_adc4_mux =\n\tSOC_DAPM_ENUM(\"ADC4 MUX Mux\", adc4_enum);\n\nstatic const struct snd_kcontrol_new tx_hdr12_mux =\n\tSOC_DAPM_ENUM(\"HDR12 MUX Mux\", hdr12_enum);\n\nstatic const struct snd_kcontrol_new tx_hdr34_mux =\n\tSOC_DAPM_ENUM(\"HDR34 MUX Mux\", hdr34_enum);\n\nstatic const struct snd_kcontrol_new rx_rdac3_mux =\n\tSOC_DAPM_ENUM(\"RDAC3_MUX Mux\", rdac3_enum);\n\nstatic const struct snd_kcontrol_new wcd9380_snd_controls[] = {\n\tSOC_ENUM_EXT(\"RX HPH Mode\", rx_hph_mode_mux_enum_wcd9380,\n\t\t     wcd938x_rx_hph_mode_get, wcd938x_rx_hph_mode_put),\n\tSOC_ENUM_EXT(\"TX0 MODE\", tx0_mode_enum_wcd9380,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n\tSOC_ENUM_EXT(\"TX1 MODE\", tx1_mode_enum_wcd9380,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n\tSOC_ENUM_EXT(\"TX2 MODE\", tx2_mode_enum_wcd9380,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n\tSOC_ENUM_EXT(\"TX3 MODE\", tx3_mode_enum_wcd9380,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n};\n\nstatic const struct snd_kcontrol_new wcd9385_snd_controls[] = {\n\tSOC_ENUM_EXT(\"RX HPH Mode\", rx_hph_mode_mux_enum,\n\t\t     wcd938x_rx_hph_mode_get, wcd938x_rx_hph_mode_put),\n\tSOC_ENUM_EXT(\"TX0 MODE\", tx0_mode_enum_wcd9385,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n\tSOC_ENUM_EXT(\"TX1 MODE\", tx1_mode_enum_wcd9385,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n\tSOC_ENUM_EXT(\"TX2 MODE\", tx2_mode_enum_wcd9385,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n\tSOC_ENUM_EXT(\"TX3 MODE\", tx3_mode_enum_wcd9385,\n\t\t     wcd938x_tx_mode_get, wcd938x_tx_mode_put),\n};\n\nstatic int wcd938x_get_swr_port(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *comp = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(comp);\n\tstruct wcd938x_sdw_priv *wcd;\n\tstruct soc_mixer_control *mixer = (struct soc_mixer_control *)kcontrol->private_value;\n\tint dai_id = mixer->shift;\n\tint portidx, ch_idx = mixer->reg;\n\n\n\twcd = wcd938x->sdw_priv[dai_id];\n\tportidx = wcd->ch_info[ch_idx].port_num;\n\n\tucontrol->value.integer.value[0] = wcd->port_enable[portidx];\n\n\treturn 0;\n}\n\nstatic int wcd938x_set_swr_port(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *comp = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(comp);\n\tstruct wcd938x_sdw_priv *wcd;\n\tstruct soc_mixer_control *mixer =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tint ch_idx = mixer->reg;\n\tint portidx;\n\tint dai_id = mixer->shift;\n\tbool enable;\n\n\twcd = wcd938x->sdw_priv[dai_id];\n\n\tportidx = wcd->ch_info[ch_idx].port_num;\n\tif (ucontrol->value.integer.value[0])\n\t\tenable = true;\n\telse\n\t\tenable = false;\n\n\twcd->port_enable[portidx] = enable;\n\n\twcd938x_connect_port(wcd, portidx, ch_idx, enable);\n\n\treturn 1;\n\n}\n\n \nstatic void wcd938x_mbhc_clk_setup(struct snd_soc_component *component,\n\t\t\t\t   bool enable)\n{\n\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_1,\n\t\t\t\t      WCD938X_MBHC_CTL_RCO_EN_MASK, enable);\n}\n\nstatic void wcd938x_mbhc_mbhc_bias_control(struct snd_soc_component *component,\n\t\t\t\t\t   bool enable)\n{\n\tsnd_soc_component_write_field(component, WCD938X_ANA_MBHC_ELECT,\n\t\t\t\t      WCD938X_ANA_MBHC_BIAS_EN, enable);\n}\n\nstatic void wcd938x_mbhc_program_btn_thr(struct snd_soc_component *component,\n\t\t\t\t\t int *btn_low, int *btn_high,\n\t\t\t\t\t int num_btn, bool is_micbias)\n{\n\tint i, vth;\n\n\tif (num_btn > WCD_MBHC_DEF_BUTTONS) {\n\t\tdev_err(component->dev, \"%s: invalid number of buttons: %d\\n\",\n\t\t\t__func__, num_btn);\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < num_btn; i++) {\n\t\tvth = ((btn_high[i] * 2) / 25) & 0x3F;\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MBHC_BTN0 + i,\n\t\t\t\t\t   WCD938X_MBHC_BTN_VTH_MASK, vth);\n\t\tdev_dbg(component->dev, \"%s: btn_high[%d]: %d, vth: %d\\n\",\n\t\t\t__func__, i, btn_high[i], vth);\n\t}\n}\n\nstatic bool wcd938x_mbhc_micb_en_status(struct snd_soc_component *component, int micb_num)\n{\n\tu8 val;\n\n\tif (micb_num == MIC_BIAS_2) {\n\t\tval = snd_soc_component_read_field(component,\n\t\t\t\t\t\t   WCD938X_ANA_MICB2,\n\t\t\t\t\t\t   WCD938X_ANA_MICB2_ENABLE_MASK);\n\t\tif (val == WCD938X_MICB_ENABLE)\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic void wcd938x_mbhc_hph_l_pull_up_control(struct snd_soc_component *component,\n\t\t\t\t\t\t\tint pull_up_cur)\n{\n\t \n\tif (pull_up_cur > HS_PULLUP_I_OFF || pull_up_cur < HS_PULLUP_I_3P0_UA)\n\t\tpull_up_cur = HS_PULLUP_I_2P0_UA;\n\n\tsnd_soc_component_write_field(component,\n\t\t\t\t      WCD938X_MBHC_NEW_INT_MECH_DET_CURRENT,\n\t\t\t\t      WCD938X_HSDET_PULLUP_C_MASK, pull_up_cur);\n}\n\nstatic int wcd938x_mbhc_request_micbias(struct snd_soc_component *component,\n\t\t\t\t\tint micb_num, int req)\n{\n\treturn wcd938x_micbias_control(component, micb_num, req, false);\n}\n\nstatic void wcd938x_mbhc_micb_ramp_control(struct snd_soc_component *component,\n\t\t\t\t\t   bool enable)\n{\n\tif (enable) {\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MICB2_RAMP,\n\t\t\t\t    WCD938X_RAMP_SHIFT_CTRL_MASK, 0x0C);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MICB2_RAMP,\n\t\t\t\t    WCD938X_RAMP_EN_MASK, 1);\n\t} else {\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MICB2_RAMP,\n\t\t\t\t    WCD938X_RAMP_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MICB2_RAMP,\n\t\t\t\t    WCD938X_RAMP_SHIFT_CTRL_MASK, 0);\n\t}\n}\n\nstatic int wcd938x_get_micb_vout_ctl_val(u32 micb_mv)\n{\n\t \n\tif (micb_mv < 1000 || micb_mv > 2850)\n\t\treturn -EINVAL;\n\n\treturn (micb_mv - 1000) / 50;\n}\n\nstatic int wcd938x_mbhc_micb_adjust_voltage(struct snd_soc_component *component,\n\t\t\t\t\t    int req_volt, int micb_num)\n{\n\tstruct wcd938x_priv *wcd938x =  snd_soc_component_get_drvdata(component);\n\tint cur_vout_ctl, req_vout_ctl, micb_reg, micb_en, ret = 0;\n\n\tswitch (micb_num) {\n\tcase MIC_BIAS_1:\n\t\tmicb_reg = WCD938X_ANA_MICB1;\n\t\tbreak;\n\tcase MIC_BIAS_2:\n\t\tmicb_reg = WCD938X_ANA_MICB2;\n\t\tbreak;\n\tcase MIC_BIAS_3:\n\t\tmicb_reg = WCD938X_ANA_MICB3;\n\t\tbreak;\n\tcase MIC_BIAS_4:\n\t\tmicb_reg = WCD938X_ANA_MICB4;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tmutex_lock(&wcd938x->micb_lock);\n\t \n\tmicb_en = snd_soc_component_read_field(component, micb_reg,\n\t\t\t\t\t\tWCD938X_MICB_EN_MASK);\n\tcur_vout_ctl = snd_soc_component_read_field(component, micb_reg,\n\t\t\t\t\t\t    WCD938X_MICB_VOUT_MASK);\n\n\treq_vout_ctl = wcd938x_get_micb_vout_ctl_val(req_volt);\n\tif (req_vout_ctl < 0) {\n\t\tret = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\tif (cur_vout_ctl == req_vout_ctl) {\n\t\tret = 0;\n\t\tgoto exit;\n\t}\n\n\tif (micb_en == WCD938X_MICB_ENABLE)\n\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t      WCD938X_MICB_EN_MASK,\n\t\t\t\t\t      WCD938X_MICB_PULL_UP);\n\n\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t      WCD938X_MICB_VOUT_MASK,\n\t\t\t\t      req_vout_ctl);\n\n\tif (micb_en == WCD938X_MICB_ENABLE) {\n\t\tsnd_soc_component_write_field(component, micb_reg,\n\t\t\t\t\t      WCD938X_MICB_EN_MASK,\n\t\t\t\t\t      WCD938X_MICB_ENABLE);\n\t\t \n\t\tusleep_range(2000, 2100);\n\t}\nexit:\n\tmutex_unlock(&wcd938x->micb_lock);\n\treturn ret;\n}\n\nstatic int wcd938x_mbhc_micb_ctrl_threshold_mic(struct snd_soc_component *component,\n\t\t\t\t\t\tint micb_num, bool req_en)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint micb_mv;\n\n\tif (micb_num != MIC_BIAS_2)\n\t\treturn -EINVAL;\n\t \n\tif (wcd938x->micb2_mv >= WCD_MBHC_THR_HS_MICB_MV)\n\t\treturn 0;\n\n\tmicb_mv = req_en ? WCD_MBHC_THR_HS_MICB_MV : wcd938x->micb2_mv;\n\n\treturn wcd938x_mbhc_micb_adjust_voltage(component, micb_mv, MIC_BIAS_2);\n}\n\nstatic void wcd938x_mbhc_get_result_params(struct snd_soc_component *component,\n\t\t\t\t\t\ts16 *d1_a, u16 noff,\n\t\t\t\t\t\tint32_t *zdet)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint i;\n\tint val, val1;\n\ts16 c1;\n\ts32 x1, d1;\n\tint32_t denom;\n\tstatic const int minCode_param[] = {\n\t\t3277, 1639, 820, 410, 205, 103, 52, 26\n\t};\n\n\tregmap_update_bits(wcd938x->regmap, WCD938X_ANA_MBHC_ZDET, 0x20, 0x20);\n\tfor (i = 0; i < WCD938X_ZDET_NUM_MEASUREMENTS; i++) {\n\t\tregmap_read(wcd938x->regmap, WCD938X_ANA_MBHC_RESULT_2, &val);\n\t\tif (val & 0x80)\n\t\t\tbreak;\n\t}\n\tval = val << 0x8;\n\tregmap_read(wcd938x->regmap, WCD938X_ANA_MBHC_RESULT_1, &val1);\n\tval |= val1;\n\tregmap_update_bits(wcd938x->regmap, WCD938X_ANA_MBHC_ZDET, 0x20, 0x00);\n\tx1 = WCD938X_MBHC_GET_X1(val);\n\tc1 = WCD938X_MBHC_GET_C1(val);\n\t \n\tif ((c1 < 2) && x1)\n\t\tusleep_range(5000, 5050);\n\n\tif (!c1 || !x1) {\n\t\tdev_err(component->dev, \"Impedance detect ramp error, c1=%d, x1=0x%x\\n\",\n\t\t\tc1, x1);\n\t\tgoto ramp_down;\n\t}\n\td1 = d1_a[c1];\n\tdenom = (x1 * d1) - (1 << (14 - noff));\n\tif (denom > 0)\n\t\t*zdet = (WCD938X_MBHC_ZDET_CONST * 1000) / denom;\n\telse if (x1 < minCode_param[noff])\n\t\t*zdet = WCD938X_ZDET_FLOATING_IMPEDANCE;\n\n\tdev_dbg(component->dev, \"%s: d1=%d, c1=%d, x1=0x%x, z_val=%d (milliohm)\\n\",\n\t\t__func__, d1, c1, x1, *zdet);\nramp_down:\n\ti = 0;\n\twhile (x1) {\n\t\tregmap_read(wcd938x->regmap,\n\t\t\t\t WCD938X_ANA_MBHC_RESULT_1, &val);\n\t\tregmap_read(wcd938x->regmap,\n\t\t\t\t WCD938X_ANA_MBHC_RESULT_2, &val1);\n\t\tval = val << 0x08;\n\t\tval |= val1;\n\t\tx1 = WCD938X_MBHC_GET_X1(val);\n\t\ti++;\n\t\tif (i == WCD938X_ZDET_NUM_MEASUREMENTS)\n\t\t\tbreak;\n\t}\n}\n\nstatic void wcd938x_mbhc_zdet_ramp(struct snd_soc_component *component,\n\t\t\t\t struct wcd938x_mbhc_zdet_param *zdet_param,\n\t\t\t\t int32_t *zl, int32_t *zr, s16 *d1_a)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tint32_t zdet = 0;\n\n\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_ZDET_ANA_CTL,\n\t\t\t\tWCD938X_ZDET_MAXV_CTL_MASK, zdet_param->ldo_ctl);\n\tsnd_soc_component_update_bits(component, WCD938X_ANA_MBHC_BTN5,\n\t\t\t\t    WCD938X_VTH_MASK, zdet_param->btn5);\n\tsnd_soc_component_update_bits(component, WCD938X_ANA_MBHC_BTN6,\n\t\t\t\t      WCD938X_VTH_MASK, zdet_param->btn6);\n\tsnd_soc_component_update_bits(component, WCD938X_ANA_MBHC_BTN7,\n\t\t\t\t     WCD938X_VTH_MASK, zdet_param->btn7);\n\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_ZDET_ANA_CTL,\n\t\t\t\tWCD938X_ZDET_RANGE_CTL_MASK, zdet_param->noff);\n\tsnd_soc_component_update_bits(component, WCD938X_MBHC_NEW_ZDET_RAMP_CTL,\n\t\t\t\t0x0F, zdet_param->nshift);\n\n\tif (!zl)\n\t\tgoto z_right;\n\t \n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_ANA_MBHC_ZDET, 0x80, 0x80);\n\tdev_dbg(component->dev, \"%s: ramp for HPH_L, noff = %d\\n\",\n\t\t__func__, zdet_param->noff);\n\twcd938x_mbhc_get_result_params(component, d1_a, zdet_param->noff, &zdet);\n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_ANA_MBHC_ZDET, 0x80, 0x00);\n\n\t*zl = zdet;\n\nz_right:\n\tif (!zr)\n\t\treturn;\n\t \n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_ANA_MBHC_ZDET, 0x40, 0x40);\n\tdev_dbg(component->dev, \"%s: ramp for HPH_R, noff = %d\\n\",\n\t\t__func__, zdet_param->noff);\n\twcd938x_mbhc_get_result_params(component, d1_a, zdet_param->noff, &zdet);\n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_ANA_MBHC_ZDET, 0x40, 0x00);\n\n\t*zr = zdet;\n}\n\nstatic void wcd938x_wcd_mbhc_qfuse_cal(struct snd_soc_component *component,\n\t\t\t\t\tint32_t *z_val, int flag_l_r)\n{\n\ts16 q1;\n\tint q1_cal;\n\n\tif (*z_val < (WCD938X_ZDET_VAL_400/1000))\n\t\tq1 = snd_soc_component_read(component,\n\t\t\tWCD938X_DIGITAL_EFUSE_REG_23 + (2 * flag_l_r));\n\telse\n\t\tq1 = snd_soc_component_read(component,\n\t\t\tWCD938X_DIGITAL_EFUSE_REG_24 + (2 * flag_l_r));\n\tif (q1 & 0x80)\n\t\tq1_cal = (10000 - ((q1 & 0x7F) * 25));\n\telse\n\t\tq1_cal = (10000 + (q1 * 25));\n\tif (q1_cal > 0)\n\t\t*z_val = ((*z_val) * 10000) / q1_cal;\n}\n\nstatic void wcd938x_wcd_mbhc_calc_impedance(struct snd_soc_component *component,\n\t\t\t\t\t    uint32_t *zl, uint32_t *zr)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\ts16 reg0, reg1, reg2, reg3, reg4;\n\tint32_t z1L, z1R, z1Ls;\n\tint zMono, z_diff1, z_diff2;\n\tbool is_fsm_disable = false;\n\tstruct wcd938x_mbhc_zdet_param zdet_param[] = {\n\t\t{4, 0, 4, 0x08, 0x14, 0x18},  \n\t\t{2, 0, 3, 0x18, 0x7C, 0x90},  \n\t\t{1, 4, 5, 0x18, 0x7C, 0x90},  \n\t\t{1, 6, 7, 0x18, 0x7C, 0x90},  \n\t};\n\tstruct wcd938x_mbhc_zdet_param *zdet_param_ptr = NULL;\n\ts16 d1_a[][4] = {\n\t\t{0, 30, 90, 30},\n\t\t{0, 30, 30, 5},\n\t\t{0, 30, 30, 5},\n\t\t{0, 30, 30, 5},\n\t};\n\ts16 *d1 = NULL;\n\n\treg0 = snd_soc_component_read(component, WCD938X_ANA_MBHC_BTN5);\n\treg1 = snd_soc_component_read(component, WCD938X_ANA_MBHC_BTN6);\n\treg2 = snd_soc_component_read(component, WCD938X_ANA_MBHC_BTN7);\n\treg3 = snd_soc_component_read(component, WCD938X_MBHC_CTL_CLK);\n\treg4 = snd_soc_component_read(component, WCD938X_MBHC_NEW_ZDET_ANA_CTL);\n\n\tif (snd_soc_component_read(component, WCD938X_ANA_MBHC_ELECT) & 0x80) {\n\t\tis_fsm_disable = true;\n\t\tregmap_update_bits(wcd938x->regmap,\n\t\t\t\t   WCD938X_ANA_MBHC_ELECT, 0x80, 0x00);\n\t}\n\n\t \n\tif (wcd938x->mbhc_cfg.hphl_swh)\n\t\tregmap_update_bits(wcd938x->regmap,\n\t\t\t\t   WCD938X_ANA_MBHC_MECH, 0x80, 0x00);\n\n\t \n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_ANA_MBHC_MECH, 0x01, 0x00);\n\n\t \n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_HPH_SURGE_HPHLR_SURGE_EN, 0xC0, 0x00);\n\t \n\tusleep_range(1000, 1010);\n\n\t \n\td1 = d1_a[1];\n\tzdet_param_ptr = &zdet_param[1];\n\twcd938x_mbhc_zdet_ramp(component, zdet_param_ptr, &z1L, NULL, d1);\n\n\tif (!WCD938X_MBHC_IS_SECOND_RAMP_REQUIRED(z1L))\n\t\tgoto left_ch_impedance;\n\n\t \n\tif (z1L < WCD938X_ZDET_VAL_32) {\n\t\tzdet_param_ptr = &zdet_param[0];\n\t\td1 = d1_a[0];\n\t} else if ((z1L > WCD938X_ZDET_VAL_400) &&\n\t\t  (z1L <= WCD938X_ZDET_VAL_1200)) {\n\t\tzdet_param_ptr = &zdet_param[2];\n\t\td1 = d1_a[2];\n\t} else if (z1L > WCD938X_ZDET_VAL_1200) {\n\t\tzdet_param_ptr = &zdet_param[3];\n\t\td1 = d1_a[3];\n\t}\n\twcd938x_mbhc_zdet_ramp(component, zdet_param_ptr, &z1L, NULL, d1);\n\nleft_ch_impedance:\n\tif ((z1L == WCD938X_ZDET_FLOATING_IMPEDANCE) ||\n\t\t(z1L > WCD938X_ZDET_VAL_100K)) {\n\t\t*zl = WCD938X_ZDET_FLOATING_IMPEDANCE;\n\t\tzdet_param_ptr = &zdet_param[1];\n\t\td1 = d1_a[1];\n\t} else {\n\t\t*zl = z1L/1000;\n\t\twcd938x_wcd_mbhc_qfuse_cal(component, zl, 0);\n\t}\n\tdev_dbg(component->dev, \"%s: impedance on HPH_L = %d(ohms)\\n\",\n\t\t__func__, *zl);\n\n\t \n\twcd938x_mbhc_zdet_ramp(component, zdet_param_ptr, NULL, &z1R, d1);\n\tif (WCD938X_MBHC_IS_SECOND_RAMP_REQUIRED(z1R)) {\n\t\tif (((z1R > WCD938X_ZDET_VAL_1200) &&\n\t\t\t(zdet_param_ptr->noff == 0x6)) ||\n\t\t\t((*zl) != WCD938X_ZDET_FLOATING_IMPEDANCE))\n\t\t\tgoto right_ch_impedance;\n\t\t \n\t\tif (z1R < WCD938X_ZDET_VAL_32) {\n\t\t\tzdet_param_ptr = &zdet_param[0];\n\t\t\td1 = d1_a[0];\n\t\t} else if ((z1R > WCD938X_ZDET_VAL_400) &&\n\t\t\t(z1R <= WCD938X_ZDET_VAL_1200)) {\n\t\t\tzdet_param_ptr = &zdet_param[2];\n\t\t\td1 = d1_a[2];\n\t\t} else if (z1R > WCD938X_ZDET_VAL_1200) {\n\t\t\tzdet_param_ptr = &zdet_param[3];\n\t\t\td1 = d1_a[3];\n\t\t}\n\t\twcd938x_mbhc_zdet_ramp(component, zdet_param_ptr, NULL, &z1R, d1);\n\t}\nright_ch_impedance:\n\tif ((z1R == WCD938X_ZDET_FLOATING_IMPEDANCE) ||\n\t\t(z1R > WCD938X_ZDET_VAL_100K)) {\n\t\t*zr = WCD938X_ZDET_FLOATING_IMPEDANCE;\n\t} else {\n\t\t*zr = z1R/1000;\n\t\twcd938x_wcd_mbhc_qfuse_cal(component, zr, 1);\n\t}\n\tdev_dbg(component->dev, \"%s: impedance on HPH_R = %d(ohms)\\n\",\n\t\t__func__, *zr);\n\n\t \n\tif ((*zl == WCD938X_ZDET_FLOATING_IMPEDANCE) &&\n\t\t(*zr == WCD938X_ZDET_FLOATING_IMPEDANCE)) {\n\t\tdev_dbg(component->dev,\n\t\t\t\"%s: plug type is invalid or extension cable\\n\",\n\t\t\t__func__);\n\t\tgoto zdet_complete;\n\t}\n\tif ((*zl == WCD938X_ZDET_FLOATING_IMPEDANCE) ||\n\t    (*zr == WCD938X_ZDET_FLOATING_IMPEDANCE) ||\n\t    ((*zl < WCD_MONO_HS_MIN_THR) && (*zr > WCD_MONO_HS_MIN_THR)) ||\n\t    ((*zl > WCD_MONO_HS_MIN_THR) && (*zr < WCD_MONO_HS_MIN_THR))) {\n\t\tdev_dbg(component->dev,\n\t\t\t\"%s: Mono plug type with one ch floating or shorted to GND\\n\",\n\t\t\t__func__);\n\t\twcd_mbhc_set_hph_type(wcd938x->wcd_mbhc, WCD_MBHC_HPH_MONO);\n\t\tgoto zdet_complete;\n\t}\n\tsnd_soc_component_write_field(component, WCD938X_HPH_R_ATEST,\n\t\t\t\t      WCD938X_HPHPA_GND_OVR_MASK, 1);\n\tsnd_soc_component_write_field(component, WCD938X_HPH_PA_CTL2,\n\t\t\t\t      WCD938X_HPHPA_GND_R_MASK, 1);\n\tif (*zl < (WCD938X_ZDET_VAL_32/1000))\n\t\twcd938x_mbhc_zdet_ramp(component, &zdet_param[0], &z1Ls, NULL, d1);\n\telse\n\t\twcd938x_mbhc_zdet_ramp(component, &zdet_param[1], &z1Ls, NULL, d1);\n\tsnd_soc_component_write_field(component, WCD938X_HPH_PA_CTL2,\n\t\t\t\t      WCD938X_HPHPA_GND_R_MASK, 0);\n\tsnd_soc_component_write_field(component, WCD938X_HPH_R_ATEST,\n\t\t\t\t      WCD938X_HPHPA_GND_OVR_MASK, 0);\n\tz1Ls /= 1000;\n\twcd938x_wcd_mbhc_qfuse_cal(component, &z1Ls, 0);\n\t \n\tzMono = ((*zl) * 9) / ((*zl) + 9);\n\tz_diff1 = (z1Ls > zMono) ? (z1Ls - zMono) : (zMono - z1Ls);\n\tz_diff2 = ((*zl) > z1Ls) ? ((*zl) - z1Ls) : (z1Ls - (*zl));\n\tif ((z_diff1 * (*zl + z1Ls)) > (z_diff2 * (z1Ls + zMono))) {\n\t\tdev_dbg(component->dev, \"%s: stereo plug type detected\\n\",\n\t\t\t__func__);\n\t\twcd_mbhc_set_hph_type(wcd938x->wcd_mbhc, WCD_MBHC_HPH_STEREO);\n\t} else {\n\t\tdev_dbg(component->dev, \"%s: MONO plug type detected\\n\",\n\t\t\t__func__);\n\t\twcd_mbhc_set_hph_type(wcd938x->wcd_mbhc, WCD_MBHC_HPH_MONO);\n\t}\n\n\t \n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_HPH_SURGE_HPHLR_SURGE_EN, 0xC0, 0xC0);\nzdet_complete:\n\tsnd_soc_component_write(component, WCD938X_ANA_MBHC_BTN5, reg0);\n\tsnd_soc_component_write(component, WCD938X_ANA_MBHC_BTN6, reg1);\n\tsnd_soc_component_write(component, WCD938X_ANA_MBHC_BTN7, reg2);\n\t \n\tregmap_update_bits(wcd938x->regmap,\n\t\t\t   WCD938X_ANA_MBHC_MECH, 0x01, 0x01);\n\n\t \n\tif (wcd938x->mbhc_cfg.hphl_swh)\n\t\tregmap_update_bits(wcd938x->regmap,\n\t\t\t\t   WCD938X_ANA_MBHC_MECH, 0x80, 0x80);\n\n\tsnd_soc_component_write(component, WCD938X_MBHC_NEW_ZDET_ANA_CTL, reg4);\n\tsnd_soc_component_write(component, WCD938X_MBHC_CTL_CLK, reg3);\n\tif (is_fsm_disable)\n\t\tregmap_update_bits(wcd938x->regmap,\n\t\t\t\t   WCD938X_ANA_MBHC_ELECT, 0x80, 0x80);\n}\n\nstatic void wcd938x_mbhc_gnd_det_ctrl(struct snd_soc_component *component,\n\t\t\tbool enable)\n{\n\tif (enable) {\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MBHC_MECH,\n\t\t\t\t\t      WCD938X_MBHC_HSG_PULLUP_COMP_EN, 1);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MBHC_MECH,\n\t\t\t\t\t      WCD938X_MBHC_GND_DET_EN_MASK, 1);\n\t} else {\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MBHC_MECH,\n\t\t\t\t\t      WCD938X_MBHC_GND_DET_EN_MASK, 0);\n\t\tsnd_soc_component_write_field(component, WCD938X_ANA_MBHC_MECH,\n\t\t\t\t\t      WCD938X_MBHC_HSG_PULLUP_COMP_EN, 0);\n\t}\n}\n\nstatic void wcd938x_mbhc_hph_pull_down_ctrl(struct snd_soc_component *component,\n\t\t\t\t\t  bool enable)\n{\n\tsnd_soc_component_write_field(component, WCD938X_HPH_PA_CTL2,\n\t\t\t\t      WCD938X_HPHPA_GND_R_MASK, enable);\n\tsnd_soc_component_write_field(component, WCD938X_HPH_PA_CTL2,\n\t\t\t\t      WCD938X_HPHPA_GND_L_MASK, enable);\n}\n\nstatic void wcd938x_mbhc_moisture_config(struct snd_soc_component *component)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tif (wcd938x->mbhc_cfg.moist_rref == R_OFF) {\n\t\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t\t    WCD938X_M_RTH_CTL_MASK, R_OFF);\n\t\treturn;\n\t}\n\n\t \n\tif (!wcd938x->mbhc_cfg.hphl_swh) {\n\t\tdev_dbg(component->dev, \"%s: disable moisture detection for NC\\n\",\n\t\t\t__func__);\n\t\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t\t    WCD938X_M_RTH_CTL_MASK, R_OFF);\n\t\treturn;\n\t}\n\n\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t    WCD938X_M_RTH_CTL_MASK, wcd938x->mbhc_cfg.moist_rref);\n}\n\nstatic void wcd938x_mbhc_moisture_detect_en(struct snd_soc_component *component, bool enable)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tif (enable)\n\t\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t\t\tWCD938X_M_RTH_CTL_MASK, wcd938x->mbhc_cfg.moist_rref);\n\telse\n\t\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t\t    WCD938X_M_RTH_CTL_MASK, R_OFF);\n}\n\nstatic bool wcd938x_mbhc_get_moisture_status(struct snd_soc_component *component)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tbool ret = false;\n\n\tif (wcd938x->mbhc_cfg.moist_rref == R_OFF) {\n\t\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t\t    WCD938X_M_RTH_CTL_MASK, R_OFF);\n\t\tgoto done;\n\t}\n\n\t \n\tif (!wcd938x->mbhc_cfg.hphl_swh) {\n\t\tdev_dbg(component->dev, \"%s: disable moisture detection for NC\\n\",\n\t\t\t__func__);\n\t\tsnd_soc_component_write_field(component, WCD938X_MBHC_NEW_CTL_2,\n\t\t\t\t    WCD938X_M_RTH_CTL_MASK, R_OFF);\n\t\tgoto done;\n\t}\n\n\t \n\tif (snd_soc_component_read_field(component, WCD938X_MBHC_NEW_CTL_2, WCD938X_M_RTH_CTL_MASK))\n\t\tgoto done;\n\n\twcd938x_mbhc_moisture_detect_en(component, true);\n\t \n\tret = ((snd_soc_component_read(component, WCD938X_MBHC_NEW_FSM_STATUS)\n\t\t\t\t& 0x20) ? 0 : 1);\n\ndone:\n\treturn ret;\n\n}\n\nstatic void wcd938x_mbhc_moisture_polling_ctrl(struct snd_soc_component *component,\n\t\t\t\t\t\tbool enable)\n{\n\tsnd_soc_component_write_field(component,\n\t\t\t      WCD938X_MBHC_NEW_INT_MOISTURE_DET_POLLING_CTRL,\n\t\t\t      WCD938X_MOISTURE_EN_POLLING_MASK, enable);\n}\n\nstatic const struct wcd_mbhc_cb mbhc_cb = {\n\t.clk_setup = wcd938x_mbhc_clk_setup,\n\t.mbhc_bias = wcd938x_mbhc_mbhc_bias_control,\n\t.set_btn_thr = wcd938x_mbhc_program_btn_thr,\n\t.micbias_enable_status = wcd938x_mbhc_micb_en_status,\n\t.hph_pull_up_control_v2 = wcd938x_mbhc_hph_l_pull_up_control,\n\t.mbhc_micbias_control = wcd938x_mbhc_request_micbias,\n\t.mbhc_micb_ramp_control = wcd938x_mbhc_micb_ramp_control,\n\t.mbhc_micb_ctrl_thr_mic = wcd938x_mbhc_micb_ctrl_threshold_mic,\n\t.compute_impedance = wcd938x_wcd_mbhc_calc_impedance,\n\t.mbhc_gnd_det_ctrl = wcd938x_mbhc_gnd_det_ctrl,\n\t.hph_pull_down_ctrl = wcd938x_mbhc_hph_pull_down_ctrl,\n\t.mbhc_moisture_config = wcd938x_mbhc_moisture_config,\n\t.mbhc_get_moisture_status = wcd938x_mbhc_get_moisture_status,\n\t.mbhc_moisture_polling_ctrl = wcd938x_mbhc_moisture_polling_ctrl,\n\t.mbhc_moisture_detect_en = wcd938x_mbhc_moisture_detect_en,\n};\n\nstatic int wcd938x_get_hph_type(struct snd_kcontrol *kcontrol,\n\t\t\t      struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = wcd_mbhc_get_hph_type(wcd938x->wcd_mbhc);\n\n\treturn 0;\n}\n\nstatic int wcd938x_hph_impedance_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tuint32_t zl, zr;\n\tbool hphr;\n\tstruct soc_mixer_control *mc;\n\tstruct snd_soc_component *component =\n\t\t\t\t\tsnd_soc_kcontrol_component(kcontrol);\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\tmc = (struct soc_mixer_control *)(kcontrol->private_value);\n\thphr = mc->shift;\n\twcd_mbhc_get_impedance(wcd938x->wcd_mbhc, &zl, &zr);\n\tdev_dbg(component->dev, \"%s: zl=%u(ohms), zr=%u(ohms)\\n\", __func__, zl, zr);\n\tucontrol->value.integer.value[0] = hphr ? zr : zl;\n\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new hph_type_detect_controls[] = {\n\tSOC_SINGLE_EXT(\"HPH Type\", 0, 0, WCD_MBHC_HPH_STEREO, 0,\n\t\t       wcd938x_get_hph_type, NULL),\n};\n\nstatic const struct snd_kcontrol_new impedance_detect_controls[] = {\n\tSOC_SINGLE_EXT(\"HPHL Impedance\", 0, 0, INT_MAX, 0,\n\t\t       wcd938x_hph_impedance_get, NULL),\n\tSOC_SINGLE_EXT(\"HPHR Impedance\", 0, 1, INT_MAX, 0,\n\t\t       wcd938x_hph_impedance_get, NULL),\n};\n\nstatic int wcd938x_mbhc_init(struct snd_soc_component *component)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tstruct wcd_mbhc_intr *intr_ids = &wcd938x->intr_ids;\n\n\tintr_ids->mbhc_sw_intr = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t    WCD938X_IRQ_MBHC_SW_DET);\n\tintr_ids->mbhc_btn_press_intr = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t\t   WCD938X_IRQ_MBHC_BUTTON_PRESS_DET);\n\tintr_ids->mbhc_btn_release_intr = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t\t     WCD938X_IRQ_MBHC_BUTTON_RELEASE_DET);\n\tintr_ids->mbhc_hs_ins_intr = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t\tWCD938X_IRQ_MBHC_ELECT_INS_REM_LEG_DET);\n\tintr_ids->mbhc_hs_rem_intr = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t\tWCD938X_IRQ_MBHC_ELECT_INS_REM_DET);\n\tintr_ids->hph_left_ocp = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t    WCD938X_IRQ_HPHL_OCP_INT);\n\tintr_ids->hph_right_ocp = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t     WCD938X_IRQ_HPHR_OCP_INT);\n\n\twcd938x->wcd_mbhc = wcd_mbhc_init(component, &mbhc_cb, intr_ids, wcd_mbhc_fields, true);\n\tif (IS_ERR(wcd938x->wcd_mbhc))\n\t\treturn PTR_ERR(wcd938x->wcd_mbhc);\n\n\tsnd_soc_add_component_controls(component, impedance_detect_controls,\n\t\t\t\t       ARRAY_SIZE(impedance_detect_controls));\n\tsnd_soc_add_component_controls(component, hph_type_detect_controls,\n\t\t\t\t       ARRAY_SIZE(hph_type_detect_controls));\n\n\treturn 0;\n}\n\nstatic void wcd938x_mbhc_deinit(struct snd_soc_component *component)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\twcd_mbhc_deinit(wcd938x->wcd_mbhc);\n}\n\n \n\nstatic const struct snd_kcontrol_new wcd938x_snd_controls[] = {\n\tSOC_SINGLE_EXT(\"HPHL_COMP Switch\", WCD938X_COMP_L, 0, 1, 0,\n\t\t       wcd938x_get_compander, wcd938x_set_compander),\n\tSOC_SINGLE_EXT(\"HPHR_COMP Switch\", WCD938X_COMP_R, 1, 1, 0,\n\t\t       wcd938x_get_compander, wcd938x_set_compander),\n\tSOC_SINGLE_EXT(\"HPHL Switch\", WCD938X_HPH_L, 0, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"HPHR Switch\", WCD938X_HPH_R, 0, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"CLSH Switch\", WCD938X_CLSH, 0, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"LO Switch\", WCD938X_LO, 0, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DSD_L Switch\", WCD938X_DSD_L, 0, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DSD_R Switch\", WCD938X_DSD_R, 0, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_TLV(\"HPHL Volume\", WCD938X_HPH_L_EN, 0, 0x18, 1, line_gain),\n\tSOC_SINGLE_TLV(\"HPHR Volume\", WCD938X_HPH_R_EN, 0, 0x18, 1, line_gain),\n\tWCD938X_EAR_PA_GAIN_TLV(\"EAR_PA Volume\", WCD938X_ANA_EAR_COMPANDER_CTL,\n\t\t\t\t2, 0x10, 0, ear_pa_gain),\n\tSOC_SINGLE_EXT(\"ADC1 Switch\", WCD938X_ADC1, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"ADC2 Switch\", WCD938X_ADC2, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"ADC3 Switch\", WCD938X_ADC3, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"ADC4 Switch\", WCD938X_ADC4, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC0 Switch\", WCD938X_DMIC0, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC1 Switch\", WCD938X_DMIC1, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"MBHC Switch\", WCD938X_MBHC, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC2 Switch\", WCD938X_DMIC2, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC3 Switch\", WCD938X_DMIC3, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC4 Switch\", WCD938X_DMIC4, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC5 Switch\", WCD938X_DMIC5, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC6 Switch\", WCD938X_DMIC6, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"DMIC7 Switch\", WCD938X_DMIC7, 1, 1, 0,\n\t\t       wcd938x_get_swr_port, wcd938x_set_swr_port),\n\tSOC_SINGLE_EXT(\"LDOH Enable Switch\", SND_SOC_NOPM, 0, 1, 0,\n\t\t       wcd938x_ldoh_get, wcd938x_ldoh_put),\n\tSOC_SINGLE_EXT(\"ADC2_BCS Disable Switch\", SND_SOC_NOPM, 0, 1, 0,\n\t\t       wcd938x_bcs_get, wcd938x_bcs_put),\n\n\tSOC_SINGLE_TLV(\"ADC1 Volume\", WCD938X_ANA_TX_CH1, 0, 20, 0, analog_gain),\n\tSOC_SINGLE_TLV(\"ADC2 Volume\", WCD938X_ANA_TX_CH2, 0, 20, 0, analog_gain),\n\tSOC_SINGLE_TLV(\"ADC3 Volume\", WCD938X_ANA_TX_CH3, 0, 20, 0, analog_gain),\n\tSOC_SINGLE_TLV(\"ADC4 Volume\", WCD938X_ANA_TX_CH4, 0, 20, 0, analog_gain),\n};\n\nstatic const struct snd_soc_dapm_widget wcd938x_dapm_widgets[] = {\n\n\t \n\tSND_SOC_DAPM_INPUT(\"AMIC1\"),\n\tSND_SOC_DAPM_INPUT(\"AMIC2\"),\n\tSND_SOC_DAPM_INPUT(\"AMIC3\"),\n\tSND_SOC_DAPM_INPUT(\"AMIC4\"),\n\tSND_SOC_DAPM_INPUT(\"AMIC5\"),\n\tSND_SOC_DAPM_INPUT(\"AMIC6\"),\n\tSND_SOC_DAPM_INPUT(\"AMIC7\"),\n\tSND_SOC_DAPM_MIC(\"Analog Mic1\", NULL),\n\tSND_SOC_DAPM_MIC(\"Analog Mic2\", NULL),\n\tSND_SOC_DAPM_MIC(\"Analog Mic3\", NULL),\n\tSND_SOC_DAPM_MIC(\"Analog Mic4\", NULL),\n\tSND_SOC_DAPM_MIC(\"Analog Mic5\", NULL),\n\n\t \n\tSND_SOC_DAPM_ADC_E(\"ADC1\", NULL, SND_SOC_NOPM, 0, 0,\n\t\t\t   wcd938x_codec_enable_adc,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"ADC2\", NULL, SND_SOC_NOPM, 1, 0,\n\t\t\t   wcd938x_codec_enable_adc,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"ADC3\", NULL, SND_SOC_NOPM, 2, 0,\n\t\t\t   wcd938x_codec_enable_adc,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"ADC4\", NULL, SND_SOC_NOPM, 3, 0,\n\t\t\t   wcd938x_codec_enable_adc,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC1\", NULL, SND_SOC_NOPM, 0, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC2\", NULL, SND_SOC_NOPM, 1, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC3\", NULL, SND_SOC_NOPM, 2, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC4\", NULL, SND_SOC_NOPM, 3, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC5\", NULL, SND_SOC_NOPM, 4, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC6\", NULL, SND_SOC_NOPM, 5, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC7\", NULL, SND_SOC_NOPM, 6, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"DMIC8\", NULL, SND_SOC_NOPM, 7, 0,\n\t\t\t   wcd938x_codec_enable_dmic,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MIXER_E(\"ADC1 REQ\", SND_SOC_NOPM, 0, 0,\n\t\t\t     NULL, 0, wcd938x_adc_enable_req,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"ADC2 REQ\", SND_SOC_NOPM, 1, 0,\n\t\t\t     NULL, 0, wcd938x_adc_enable_req,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"ADC3 REQ\", SND_SOC_NOPM, 2, 0,\n\t\t\t     NULL, 0, wcd938x_adc_enable_req,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"ADC4 REQ\", SND_SOC_NOPM, 3, 0, NULL, 0,\n\t\t\t     wcd938x_adc_enable_req,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MUX(\"ADC2 MUX\", SND_SOC_NOPM, 0, 0, &tx_adc2_mux),\n\tSND_SOC_DAPM_MUX(\"ADC3 MUX\", SND_SOC_NOPM, 0, 0, &tx_adc3_mux),\n\tSND_SOC_DAPM_MUX(\"ADC4 MUX\", SND_SOC_NOPM, 0, 0, &tx_adc4_mux),\n\tSND_SOC_DAPM_MUX(\"HDR12 MUX\", SND_SOC_NOPM, 0, 0, &tx_hdr12_mux),\n\tSND_SOC_DAPM_MUX(\"HDR34 MUX\", SND_SOC_NOPM, 0, 0, &tx_hdr34_mux),\n\n\t \n\tSND_SOC_DAPM_MIXER_E(\"ADC1_MIXER\", SND_SOC_NOPM, 0, 0, adc1_switch,\n\t\t\t     ARRAY_SIZE(adc1_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"ADC2_MIXER\", SND_SOC_NOPM, 0, 0, adc2_switch,\n\t\t\t     ARRAY_SIZE(adc2_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"ADC3_MIXER\", SND_SOC_NOPM, 0, 0, adc3_switch,\n\t\t\t     ARRAY_SIZE(adc3_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"ADC4_MIXER\", SND_SOC_NOPM, 0, 0, adc4_switch,\n\t\t\t     ARRAY_SIZE(adc4_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC1_MIXER\", SND_SOC_NOPM, 0, 0, dmic1_switch,\n\t\t\t     ARRAY_SIZE(dmic1_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC2_MIXER\", SND_SOC_NOPM, 0, 0, dmic2_switch,\n\t\t\t     ARRAY_SIZE(dmic2_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC3_MIXER\", SND_SOC_NOPM, 0, 0, dmic3_switch,\n\t\t\t     ARRAY_SIZE(dmic3_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC4_MIXER\", SND_SOC_NOPM, 0, 0, dmic4_switch,\n\t\t\t     ARRAY_SIZE(dmic4_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC5_MIXER\", SND_SOC_NOPM, 0, 0, dmic5_switch,\n\t\t\t     ARRAY_SIZE(dmic5_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC6_MIXER\", SND_SOC_NOPM, 0, 0, dmic6_switch,\n\t\t\t     ARRAY_SIZE(dmic6_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC7_MIXER\", SND_SOC_NOPM, 0, 0, dmic7_switch,\n\t\t\t     ARRAY_SIZE(dmic7_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MIXER_E(\"DMIC8_MIXER\", SND_SOC_NOPM, 0, 0, dmic8_switch,\n\t\t\t     ARRAY_SIZE(dmic8_switch), wcd938x_tx_swr_ctrl,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\t \n\tSND_SOC_DAPM_SUPPLY(\"MIC BIAS1\", SND_SOC_NOPM, MIC_BIAS_1, 0,\n\t\t\t    wcd938x_codec_enable_micbias,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"MIC BIAS2\", SND_SOC_NOPM, MIC_BIAS_2, 0,\n\t\t\t    wcd938x_codec_enable_micbias,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"MIC BIAS3\", SND_SOC_NOPM, MIC_BIAS_3, 0,\n\t\t\t    wcd938x_codec_enable_micbias,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"MIC BIAS4\", SND_SOC_NOPM, MIC_BIAS_4, 0,\n\t\t\t    wcd938x_codec_enable_micbias,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"VA MIC BIAS1\", SND_SOC_NOPM, MIC_BIAS_1, 0,\n\t\t\t\twcd938x_codec_enable_micbias_pullup,\n\t\t\t\tSND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t\tSND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"VA MIC BIAS2\", SND_SOC_NOPM, MIC_BIAS_2, 0,\n\t\t\t\twcd938x_codec_enable_micbias_pullup,\n\t\t\t\tSND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t\tSND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"VA MIC BIAS3\", SND_SOC_NOPM, MIC_BIAS_3, 0,\n\t\t\t\twcd938x_codec_enable_micbias_pullup,\n\t\t\t\tSND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t\tSND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY(\"VA MIC BIAS4\", SND_SOC_NOPM, MIC_BIAS_4, 0,\n\t\t\t\twcd938x_codec_enable_micbias_pullup,\n\t\t\t\tSND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t\tSND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_OUTPUT(\"ADC1_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ADC2_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ADC3_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ADC4_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC1_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC2_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC3_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC4_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC5_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC6_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC7_OUTPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"DMIC8_OUTPUT\"),\n\n\tSND_SOC_DAPM_INPUT(\"IN1_HPHL\"),\n\tSND_SOC_DAPM_INPUT(\"IN2_HPHR\"),\n\tSND_SOC_DAPM_INPUT(\"IN3_AUX\"),\n\n\t \n\tSND_SOC_DAPM_PGA_E(\"EAR PGA\", WCD938X_ANA_EAR, 7, 0, NULL, 0,\n\t\t\t   wcd938x_codec_enable_ear_pa,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_PGA_E(\"AUX PGA\", WCD938X_AUX_AUXPA, 7, 0, NULL, 0,\n\t\t\t   wcd938x_codec_enable_aux_pa,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_PGA_E(\"HPHL PGA\", WCD938X_ANA_HPH, 7, 0, NULL, 0,\n\t\t\t   wcd938x_codec_enable_hphl_pa,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_PGA_E(\"HPHR PGA\", WCD938X_ANA_HPH, 6, 0, NULL, 0,\n\t\t\t   wcd938x_codec_enable_hphr_pa,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_DAC_E(\"RDAC1\", NULL, SND_SOC_NOPM, 0, 0,\n\t\t\t   wcd938x_codec_hphl_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_DAC_E(\"RDAC2\", NULL, SND_SOC_NOPM, 0, 0,\n\t\t\t   wcd938x_codec_hphr_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_DAC_E(\"RDAC3\", NULL, SND_SOC_NOPM, 0, 0,\n\t\t\t   wcd938x_codec_ear_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_DAC_E(\"RDAC4\", NULL, SND_SOC_NOPM, 0, 0,\n\t\t\t   wcd938x_codec_aux_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MUX(\"RDAC3_MUX\", SND_SOC_NOPM, 0, 0, &rx_rdac3_mux),\n\n\tSND_SOC_DAPM_SUPPLY(\"VDD_BUCK\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"RXCLK\", SND_SOC_NOPM, 0, 0,\n\t\t\t    wcd938x_codec_enable_rxclk,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"CLS_H_PORT\", 1, SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MIXER_E(\"RX1\", SND_SOC_NOPM, 0, 0, NULL, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER_E(\"RX2\", SND_SOC_NOPM, 0, 0, NULL, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER_E(\"RX3\", SND_SOC_NOPM, 0, 0, NULL, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_MIXER(\"EAR_RDAC\", SND_SOC_NOPM, 0, 0,\n\t\t\t   ear_rdac_switch, ARRAY_SIZE(ear_rdac_switch)),\n\tSND_SOC_DAPM_MIXER(\"AUX_RDAC\", SND_SOC_NOPM, 0, 0,\n\t\t\t   aux_rdac_switch, ARRAY_SIZE(aux_rdac_switch)),\n\tSND_SOC_DAPM_MIXER(\"HPHL_RDAC\", SND_SOC_NOPM, 0, 0,\n\t\t\t   hphl_rdac_switch, ARRAY_SIZE(hphl_rdac_switch)),\n\tSND_SOC_DAPM_MIXER(\"HPHR_RDAC\", SND_SOC_NOPM, 0, 0,\n\t\t\t   hphr_rdac_switch, ARRAY_SIZE(hphr_rdac_switch)),\n\n\t \n\tSND_SOC_DAPM_OUTPUT(\"EAR\"),\n\tSND_SOC_DAPM_OUTPUT(\"AUX\"),\n\tSND_SOC_DAPM_OUTPUT(\"HPHL\"),\n\tSND_SOC_DAPM_OUTPUT(\"HPHR\"),\n\n};\n\nstatic const struct snd_soc_dapm_route wcd938x_audio_map[] = {\n\t{\"ADC1_OUTPUT\", NULL, \"ADC1_MIXER\"},\n\t{\"ADC1_MIXER\", \"Switch\", \"ADC1 REQ\"},\n\t{\"ADC1 REQ\", NULL, \"ADC1\"},\n\t{\"ADC1\", NULL, \"AMIC1\"},\n\n\t{\"ADC2_OUTPUT\", NULL, \"ADC2_MIXER\"},\n\t{\"ADC2_MIXER\", \"Switch\", \"ADC2 REQ\"},\n\t{\"ADC2 REQ\", NULL, \"ADC2\"},\n\t{\"ADC2\", NULL, \"HDR12 MUX\"},\n\t{\"HDR12 MUX\", \"NO_HDR12\", \"ADC2 MUX\"},\n\t{\"HDR12 MUX\", \"HDR12\", \"AMIC1\"},\n\t{\"ADC2 MUX\", \"INP3\", \"AMIC3\"},\n\t{\"ADC2 MUX\", \"INP2\", \"AMIC2\"},\n\n\t{\"ADC3_OUTPUT\", NULL, \"ADC3_MIXER\"},\n\t{\"ADC3_MIXER\", \"Switch\", \"ADC3 REQ\"},\n\t{\"ADC3 REQ\", NULL, \"ADC3\"},\n\t{\"ADC3\", NULL, \"HDR34 MUX\"},\n\t{\"HDR34 MUX\", \"NO_HDR34\", \"ADC3 MUX\"},\n\t{\"HDR34 MUX\", \"HDR34\", \"AMIC5\"},\n\t{\"ADC3 MUX\", \"INP4\", \"AMIC4\"},\n\t{\"ADC3 MUX\", \"INP6\", \"AMIC6\"},\n\n\t{\"ADC4_OUTPUT\", NULL, \"ADC4_MIXER\"},\n\t{\"ADC4_MIXER\", \"Switch\", \"ADC4 REQ\"},\n\t{\"ADC4 REQ\", NULL, \"ADC4\"},\n\t{\"ADC4\", NULL, \"ADC4 MUX\"},\n\t{\"ADC4 MUX\", \"INP5\", \"AMIC5\"},\n\t{\"ADC4 MUX\", \"INP7\", \"AMIC7\"},\n\n\t{\"DMIC1_OUTPUT\", NULL, \"DMIC1_MIXER\"},\n\t{\"DMIC1_MIXER\", \"Switch\", \"DMIC1\"},\n\n\t{\"DMIC2_OUTPUT\", NULL, \"DMIC2_MIXER\"},\n\t{\"DMIC2_MIXER\", \"Switch\", \"DMIC2\"},\n\n\t{\"DMIC3_OUTPUT\", NULL, \"DMIC3_MIXER\"},\n\t{\"DMIC3_MIXER\", \"Switch\", \"DMIC3\"},\n\n\t{\"DMIC4_OUTPUT\", NULL, \"DMIC4_MIXER\"},\n\t{\"DMIC4_MIXER\", \"Switch\", \"DMIC4\"},\n\n\t{\"DMIC5_OUTPUT\", NULL, \"DMIC5_MIXER\"},\n\t{\"DMIC5_MIXER\", \"Switch\", \"DMIC5\"},\n\n\t{\"DMIC6_OUTPUT\", NULL, \"DMIC6_MIXER\"},\n\t{\"DMIC6_MIXER\", \"Switch\", \"DMIC6\"},\n\n\t{\"DMIC7_OUTPUT\", NULL, \"DMIC7_MIXER\"},\n\t{\"DMIC7_MIXER\", \"Switch\", \"DMIC7\"},\n\n\t{\"DMIC8_OUTPUT\", NULL, \"DMIC8_MIXER\"},\n\t{\"DMIC8_MIXER\", \"Switch\", \"DMIC8\"},\n\n\t{\"IN1_HPHL\", NULL, \"VDD_BUCK\"},\n\t{\"IN1_HPHL\", NULL, \"CLS_H_PORT\"},\n\n\t{\"RX1\", NULL, \"IN1_HPHL\"},\n\t{\"RX1\", NULL, \"RXCLK\"},\n\t{\"RDAC1\", NULL, \"RX1\"},\n\t{\"HPHL_RDAC\", \"Switch\", \"RDAC1\"},\n\t{\"HPHL PGA\", NULL, \"HPHL_RDAC\"},\n\t{\"HPHL\", NULL, \"HPHL PGA\"},\n\n\t{\"IN2_HPHR\", NULL, \"VDD_BUCK\"},\n\t{\"IN2_HPHR\", NULL, \"CLS_H_PORT\"},\n\t{\"RX2\", NULL, \"IN2_HPHR\"},\n\t{\"RDAC2\", NULL, \"RX2\"},\n\t{\"RX2\", NULL, \"RXCLK\"},\n\t{\"HPHR_RDAC\", \"Switch\", \"RDAC2\"},\n\t{\"HPHR PGA\", NULL, \"HPHR_RDAC\"},\n\t{\"HPHR\", NULL, \"HPHR PGA\"},\n\n\t{\"IN3_AUX\", NULL, \"VDD_BUCK\"},\n\t{\"IN3_AUX\", NULL, \"CLS_H_PORT\"},\n\t{\"RX3\", NULL, \"IN3_AUX\"},\n\t{\"RDAC4\", NULL, \"RX3\"},\n\t{\"RX3\", NULL, \"RXCLK\"},\n\t{\"AUX_RDAC\", \"Switch\", \"RDAC4\"},\n\t{\"AUX PGA\", NULL, \"AUX_RDAC\"},\n\t{\"AUX\", NULL, \"AUX PGA\"},\n\n\t{\"RDAC3_MUX\", \"RX3\", \"RX3\"},\n\t{\"RDAC3_MUX\", \"RX1\", \"RX1\"},\n\t{\"RDAC3\", NULL, \"RDAC3_MUX\"},\n\t{\"EAR_RDAC\", \"Switch\", \"RDAC3\"},\n\t{\"EAR PGA\", NULL, \"EAR_RDAC\"},\n\t{\"EAR\", NULL, \"EAR PGA\"},\n};\n\nstatic int wcd938x_set_micbias_data(struct wcd938x_priv *wcd938x)\n{\n\tint vout_ctl_1, vout_ctl_2, vout_ctl_3, vout_ctl_4;\n\n\t \n\tvout_ctl_1 = wcd938x_get_micb_vout_ctl_val(wcd938x->micb1_mv);\n\tvout_ctl_2 = wcd938x_get_micb_vout_ctl_val(wcd938x->micb2_mv);\n\tvout_ctl_3 = wcd938x_get_micb_vout_ctl_val(wcd938x->micb3_mv);\n\tvout_ctl_4 = wcd938x_get_micb_vout_ctl_val(wcd938x->micb4_mv);\n\tif (vout_ctl_1 < 0 || vout_ctl_2 < 0 || vout_ctl_3 < 0 || vout_ctl_4 < 0)\n\t\treturn -EINVAL;\n\n\tregmap_update_bits(wcd938x->regmap, WCD938X_ANA_MICB1,\n\t\t\t   WCD938X_MICB_VOUT_MASK, vout_ctl_1);\n\tregmap_update_bits(wcd938x->regmap, WCD938X_ANA_MICB2,\n\t\t\t   WCD938X_MICB_VOUT_MASK, vout_ctl_2);\n\tregmap_update_bits(wcd938x->regmap, WCD938X_ANA_MICB3,\n\t\t\t   WCD938X_MICB_VOUT_MASK, vout_ctl_3);\n\tregmap_update_bits(wcd938x->regmap, WCD938X_ANA_MICB4,\n\t\t\t   WCD938X_MICB_VOUT_MASK, vout_ctl_4);\n\n\treturn 0;\n}\n\nstatic irqreturn_t wcd938x_wd_handle_irq(int irq, void *data)\n{\n\treturn IRQ_HANDLED;\n}\n\nstatic struct irq_chip wcd_irq_chip = {\n\t.name = \"WCD938x\",\n};\n\nstatic int wcd_irq_chip_map(struct irq_domain *irqd, unsigned int virq,\n\t\t\tirq_hw_number_t hw)\n{\n\tirq_set_chip_and_handler(virq, &wcd_irq_chip, handle_simple_irq);\n\tirq_set_nested_thread(virq, 1);\n\tirq_set_noprobe(virq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops wcd_domain_ops = {\n\t.map = wcd_irq_chip_map,\n};\n\nstatic int wcd938x_irq_init(struct wcd938x_priv *wcd, struct device *dev)\n{\n\n\twcd->virq = irq_domain_add_linear(NULL, 1, &wcd_domain_ops, NULL);\n\tif (!(wcd->virq)) {\n\t\tdev_err(dev, \"%s: Failed to add IRQ domain\\n\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\treturn devm_regmap_add_irq_chip(dev, wcd->regmap,\n\t\t\t\t\tirq_create_mapping(wcd->virq, 0),\n\t\t\t\t\tIRQF_ONESHOT, 0, &wcd938x_regmap_irq_chip,\n\t\t\t\t\t&wcd->irq_chip);\n}\n\nstatic int wcd938x_soc_codec_probe(struct snd_soc_component *component)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\tstruct sdw_slave *tx_sdw_dev = wcd938x->tx_sdw_dev;\n\tstruct device *dev = component->dev;\n\tunsigned long time_left;\n\tint ret, i;\n\n\ttime_left = wait_for_completion_timeout(&tx_sdw_dev->initialization_complete,\n\t\t\t\t\t\tmsecs_to_jiffies(2000));\n\tif (!time_left) {\n\t\tdev_err(dev, \"soundwire device init timeout\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tsnd_soc_component_init_regmap(component, wcd938x->regmap);\n\n\tret = pm_runtime_resume_and_get(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\twcd938x->variant = snd_soc_component_read_field(component,\n\t\t\t\t\t\t WCD938X_DIGITAL_EFUSE_REG_0,\n\t\t\t\t\t\t WCD938X_ID_MASK);\n\n\twcd938x->clsh_info = wcd_clsh_ctrl_alloc(component, WCD938X);\n\tif (IS_ERR(wcd938x->clsh_info)) {\n\t\tpm_runtime_put(dev);\n\t\treturn PTR_ERR(wcd938x->clsh_info);\n\t}\n\n\twcd938x_io_init(wcd938x);\n\t \n\tfor (i = 0; i < wcd938x_regmap_irq_chip.num_regs; i++) {\n\t\tregmap_write(wcd938x->regmap,\n\t\t\t     (WCD938X_DIGITAL_INTR_LEVEL_0 + i), 0);\n\t}\n\n\tpm_runtime_put(dev);\n\n\twcd938x->hphr_pdm_wd_int = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t       WCD938X_IRQ_HPHR_PDM_WD_INT);\n\twcd938x->hphl_pdm_wd_int = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t       WCD938X_IRQ_HPHL_PDM_WD_INT);\n\twcd938x->aux_pdm_wd_int = regmap_irq_get_virq(wcd938x->irq_chip,\n\t\t\t\t\t\t       WCD938X_IRQ_AUX_PDM_WD_INT);\n\n\t \n\tret = request_threaded_irq(wcd938x->hphr_pdm_wd_int, NULL, wcd938x_wd_handle_irq,\n\t\t\t\t   IRQF_ONESHOT | IRQF_TRIGGER_RISING,\n\t\t\t\t   \"HPHR PDM WD INT\", wcd938x);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to request HPHR WD interrupt (%d)\\n\", ret);\n\t\tgoto err_free_clsh_ctrl;\n\t}\n\n\tret = request_threaded_irq(wcd938x->hphl_pdm_wd_int, NULL, wcd938x_wd_handle_irq,\n\t\t\t\t   IRQF_ONESHOT | IRQF_TRIGGER_RISING,\n\t\t\t\t   \"HPHL PDM WD INT\", wcd938x);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to request HPHL WD interrupt (%d)\\n\", ret);\n\t\tgoto err_free_hphr_pdm_wd_int;\n\t}\n\n\tret = request_threaded_irq(wcd938x->aux_pdm_wd_int, NULL, wcd938x_wd_handle_irq,\n\t\t\t\t   IRQF_ONESHOT | IRQF_TRIGGER_RISING,\n\t\t\t\t   \"AUX PDM WD INT\", wcd938x);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to request Aux WD interrupt (%d)\\n\", ret);\n\t\tgoto err_free_hphl_pdm_wd_int;\n\t}\n\n\t \n\tdisable_irq_nosync(wcd938x->hphr_pdm_wd_int);\n\tdisable_irq_nosync(wcd938x->hphl_pdm_wd_int);\n\tdisable_irq_nosync(wcd938x->aux_pdm_wd_int);\n\n\tswitch (wcd938x->variant) {\n\tcase WCD9380:\n\t\tret = snd_soc_add_component_controls(component, wcd9380_snd_controls,\n\t\t\t\t\tARRAY_SIZE(wcd9380_snd_controls));\n\t\tif (ret < 0) {\n\t\t\tdev_err(component->dev,\n\t\t\t\t\"%s: Failed to add snd ctrls for variant: %d\\n\",\n\t\t\t\t__func__, wcd938x->variant);\n\t\t\tgoto err_free_aux_pdm_wd_int;\n\t\t}\n\t\tbreak;\n\tcase WCD9385:\n\t\tret = snd_soc_add_component_controls(component, wcd9385_snd_controls,\n\t\t\t\t\tARRAY_SIZE(wcd9385_snd_controls));\n\t\tif (ret < 0) {\n\t\t\tdev_err(component->dev,\n\t\t\t\t\"%s: Failed to add snd ctrls for variant: %d\\n\",\n\t\t\t\t__func__, wcd938x->variant);\n\t\t\tgoto err_free_aux_pdm_wd_int;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tret = wcd938x_mbhc_init(component);\n\tif (ret) {\n\t\tdev_err(component->dev,  \"mbhc initialization failed\\n\");\n\t\tgoto err_free_aux_pdm_wd_int;\n\t}\n\n\treturn 0;\n\nerr_free_aux_pdm_wd_int:\n\tfree_irq(wcd938x->aux_pdm_wd_int, wcd938x);\nerr_free_hphl_pdm_wd_int:\n\tfree_irq(wcd938x->hphl_pdm_wd_int, wcd938x);\nerr_free_hphr_pdm_wd_int:\n\tfree_irq(wcd938x->hphr_pdm_wd_int, wcd938x);\nerr_free_clsh_ctrl:\n\twcd_clsh_ctrl_free(wcd938x->clsh_info);\n\n\treturn ret;\n}\n\nstatic void wcd938x_soc_codec_remove(struct snd_soc_component *component)\n{\n\tstruct wcd938x_priv *wcd938x = snd_soc_component_get_drvdata(component);\n\n\twcd938x_mbhc_deinit(component);\n\n\tfree_irq(wcd938x->aux_pdm_wd_int, wcd938x);\n\tfree_irq(wcd938x->hphl_pdm_wd_int, wcd938x);\n\tfree_irq(wcd938x->hphr_pdm_wd_int, wcd938x);\n\n\twcd_clsh_ctrl_free(wcd938x->clsh_info);\n}\n\nstatic int wcd938x_codec_set_jack(struct snd_soc_component *comp,\n\t\t\t\t  struct snd_soc_jack *jack, void *data)\n{\n\tstruct wcd938x_priv *wcd = dev_get_drvdata(comp->dev);\n\n\tif (jack)\n\t\treturn wcd_mbhc_start(wcd->wcd_mbhc, &wcd->mbhc_cfg, jack);\n\telse\n\t\twcd_mbhc_stop(wcd->wcd_mbhc);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver soc_codec_dev_wcd938x = {\n\t.name = \"wcd938x_codec\",\n\t.probe = wcd938x_soc_codec_probe,\n\t.remove = wcd938x_soc_codec_remove,\n\t.controls = wcd938x_snd_controls,\n\t.num_controls = ARRAY_SIZE(wcd938x_snd_controls),\n\t.dapm_widgets = wcd938x_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(wcd938x_dapm_widgets),\n\t.dapm_routes = wcd938x_audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(wcd938x_audio_map),\n\t.set_jack = wcd938x_codec_set_jack,\n\t.endianness = 1,\n};\n\nstatic void wcd938x_dt_parse_micbias_info(struct device *dev, struct wcd938x_priv *wcd)\n{\n\tstruct device_node *np = dev->of_node;\n\tu32 prop_val = 0;\n\tint rc = 0;\n\n\trc = of_property_read_u32(np, \"qcom,micbias1-microvolt\",  &prop_val);\n\tif (!rc)\n\t\twcd->micb1_mv = prop_val/1000;\n\telse\n\t\tdev_info(dev, \"%s: Micbias1 DT property not found\\n\", __func__);\n\n\trc = of_property_read_u32(np, \"qcom,micbias2-microvolt\",  &prop_val);\n\tif (!rc)\n\t\twcd->micb2_mv = prop_val/1000;\n\telse\n\t\tdev_info(dev, \"%s: Micbias2 DT property not found\\n\", __func__);\n\n\trc = of_property_read_u32(np, \"qcom,micbias3-microvolt\", &prop_val);\n\tif (!rc)\n\t\twcd->micb3_mv = prop_val/1000;\n\telse\n\t\tdev_info(dev, \"%s: Micbias3 DT property not found\\n\", __func__);\n\n\trc = of_property_read_u32(np, \"qcom,micbias4-microvolt\",  &prop_val);\n\tif (!rc)\n\t\twcd->micb4_mv = prop_val/1000;\n\telse\n\t\tdev_info(dev, \"%s: Micbias4 DT property not found\\n\", __func__);\n}\n\nstatic bool wcd938x_swap_gnd_mic(struct snd_soc_component *component, bool active)\n{\n\tint value;\n\n\tstruct wcd938x_priv *wcd938x;\n\n\twcd938x = snd_soc_component_get_drvdata(component);\n\n\tvalue = gpiod_get_value(wcd938x->us_euro_gpio);\n\n\tgpiod_set_value(wcd938x->us_euro_gpio, !value);\n\n\treturn true;\n}\n\n\nstatic int wcd938x_populate_dt_data(struct wcd938x_priv *wcd938x, struct device *dev)\n{\n\tstruct wcd_mbhc_config *cfg = &wcd938x->mbhc_cfg;\n\tint ret;\n\n\twcd938x->reset_gpio = of_get_named_gpio(dev->of_node, \"reset-gpios\", 0);\n\tif (wcd938x->reset_gpio < 0)\n\t\treturn dev_err_probe(dev, wcd938x->reset_gpio,\n\t\t\t\t     \"Failed to get reset gpio\\n\");\n\n\twcd938x->us_euro_gpio = devm_gpiod_get_optional(dev, \"us-euro\",\n\t\t\t\t\t\tGPIOD_OUT_LOW);\n\tif (IS_ERR(wcd938x->us_euro_gpio))\n\t\treturn dev_err_probe(dev, PTR_ERR(wcd938x->us_euro_gpio),\n\t\t\t\t     \"us-euro swap Control GPIO not found\\n\");\n\n\tcfg->swap_gnd_mic = wcd938x_swap_gnd_mic;\n\n\twcd938x->supplies[0].supply = \"vdd-rxtx\";\n\twcd938x->supplies[1].supply = \"vdd-io\";\n\twcd938x->supplies[2].supply = \"vdd-buck\";\n\twcd938x->supplies[3].supply = \"vdd-mic-bias\";\n\n\tret = regulator_bulk_get(dev, WCD938X_MAX_SUPPLY, wcd938x->supplies);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get supplies\\n\");\n\n\tret = regulator_bulk_enable(WCD938X_MAX_SUPPLY, wcd938x->supplies);\n\tif (ret) {\n\t\tregulator_bulk_free(WCD938X_MAX_SUPPLY, wcd938x->supplies);\n\t\treturn dev_err_probe(dev, ret, \"Failed to enable supplies\\n\");\n\t}\n\n\twcd938x_dt_parse_micbias_info(dev, wcd938x);\n\n\tcfg->mbhc_micbias = MIC_BIAS_2;\n\tcfg->anc_micbias = MIC_BIAS_2;\n\tcfg->v_hs_max = WCD_MBHC_HS_V_MAX;\n\tcfg->num_btn = WCD938X_MBHC_MAX_BUTTONS;\n\tcfg->micb_mv = wcd938x->micb2_mv;\n\tcfg->linein_th = 5000;\n\tcfg->hs_thr = 1700;\n\tcfg->hph_thr = 50;\n\n\twcd_dt_parse_mbhc_data(dev, cfg);\n\n\treturn 0;\n}\n\nstatic int wcd938x_reset(struct wcd938x_priv *wcd938x)\n{\n\tgpio_direction_output(wcd938x->reset_gpio, 0);\n\t \n\tusleep_range(20, 30);\n\tgpio_set_value(wcd938x->reset_gpio, 1);\n\t \n\tusleep_range(20, 30);\n\n\treturn 0;\n}\n\nstatic int wcd938x_codec_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct wcd938x_priv *wcd938x = dev_get_drvdata(dai->dev);\n\tstruct wcd938x_sdw_priv *wcd = wcd938x->sdw_priv[dai->id];\n\n\treturn wcd938x_sdw_hw_params(wcd, substream, params, dai);\n}\n\nstatic int wcd938x_codec_free(struct snd_pcm_substream *substream,\n\t\t\t      struct snd_soc_dai *dai)\n{\n\tstruct wcd938x_priv *wcd938x = dev_get_drvdata(dai->dev);\n\tstruct wcd938x_sdw_priv *wcd = wcd938x->sdw_priv[dai->id];\n\n\treturn wcd938x_sdw_free(wcd, substream, dai);\n}\n\nstatic int wcd938x_codec_set_sdw_stream(struct snd_soc_dai *dai,\n\t\t\t\t  void *stream, int direction)\n{\n\tstruct wcd938x_priv *wcd938x = dev_get_drvdata(dai->dev);\n\tstruct wcd938x_sdw_priv *wcd = wcd938x->sdw_priv[dai->id];\n\n\treturn wcd938x_sdw_set_sdw_stream(wcd, dai, stream, direction);\n\n}\n\nstatic const struct snd_soc_dai_ops wcd938x_sdw_dai_ops = {\n\t.hw_params = wcd938x_codec_hw_params,\n\t.hw_free = wcd938x_codec_free,\n\t.set_stream = wcd938x_codec_set_sdw_stream,\n};\n\nstatic struct snd_soc_dai_driver wcd938x_dais[] = {\n\t[0] = {\n\t\t.name = \"wcd938x-sdw-rx\",\n\t\t.playback = {\n\t\t\t.stream_name = \"WCD AIF1 Playback\",\n\t\t\t.rates = WCD938X_RATES_MASK | WCD938X_FRAC_RATES_MASK,\n\t\t\t.formats = WCD938X_FORMATS_S16_S24_LE,\n\t\t\t.rate_max = 192000,\n\t\t\t.rate_min = 8000,\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t},\n\t\t.ops = &wcd938x_sdw_dai_ops,\n\t},\n\t[1] = {\n\t\t.name = \"wcd938x-sdw-tx\",\n\t\t.capture = {\n\t\t\t.stream_name = \"WCD AIF1 Capture\",\n\t\t\t.rates = WCD938X_RATES_MASK,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t\t.rate_min = 8000,\n\t\t\t.rate_max = 192000,\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 4,\n\t\t},\n\t\t.ops = &wcd938x_sdw_dai_ops,\n\t},\n};\n\nstatic int wcd938x_bind(struct device *dev)\n{\n\tstruct wcd938x_priv *wcd938x = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = component_bind_all(dev, wcd938x);\n\tif (ret) {\n\t\tdev_err(dev, \"%s: Slave bind failed, ret = %d\\n\",\n\t\t\t__func__, ret);\n\t\treturn ret;\n\t}\n\n\twcd938x->rxdev = wcd938x_sdw_device_get(wcd938x->rxnode);\n\tif (!wcd938x->rxdev) {\n\t\tdev_err(dev, \"could not find slave with matching of node\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_unbind;\n\t}\n\twcd938x->sdw_priv[AIF1_PB] = dev_get_drvdata(wcd938x->rxdev);\n\twcd938x->sdw_priv[AIF1_PB]->wcd938x = wcd938x;\n\n\twcd938x->txdev = wcd938x_sdw_device_get(wcd938x->txnode);\n\tif (!wcd938x->txdev) {\n\t\tdev_err(dev, \"could not find txslave with matching of node\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_put_rxdev;\n\t}\n\twcd938x->sdw_priv[AIF1_CAP] = dev_get_drvdata(wcd938x->txdev);\n\twcd938x->sdw_priv[AIF1_CAP]->wcd938x = wcd938x;\n\twcd938x->tx_sdw_dev = dev_to_sdw_dev(wcd938x->txdev);\n\n\t \n\tif (!device_link_add(wcd938x->rxdev, wcd938x->txdev, DL_FLAG_STATELESS |\n\t\t\t    DL_FLAG_PM_RUNTIME)) {\n\t\tdev_err(dev, \"could not devlink tx and rx\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_put_txdev;\n\t}\n\n\tif (!device_link_add(dev, wcd938x->txdev, DL_FLAG_STATELESS |\n\t\t\t\t\tDL_FLAG_PM_RUNTIME)) {\n\t\tdev_err(dev, \"could not devlink wcd and tx\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_remove_rxtx_link;\n\t}\n\n\tif (!device_link_add(dev, wcd938x->rxdev, DL_FLAG_STATELESS |\n\t\t\t\t\tDL_FLAG_PM_RUNTIME)) {\n\t\tdev_err(dev, \"could not devlink wcd and rx\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_remove_tx_link;\n\t}\n\n\twcd938x->regmap = dev_get_regmap(&wcd938x->tx_sdw_dev->dev, NULL);\n\tif (!wcd938x->regmap) {\n\t\tdev_err(dev, \"could not get TX device regmap\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_remove_rx_link;\n\t}\n\n\tret = wcd938x_irq_init(wcd938x, dev);\n\tif (ret) {\n\t\tdev_err(dev, \"%s: IRQ init failed: %d\\n\", __func__, ret);\n\t\tgoto err_remove_rx_link;\n\t}\n\n\twcd938x->sdw_priv[AIF1_PB]->slave_irq = wcd938x->virq;\n\twcd938x->sdw_priv[AIF1_CAP]->slave_irq = wcd938x->virq;\n\n\tret = wcd938x_set_micbias_data(wcd938x);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"%s: bad micbias pdata\\n\", __func__);\n\t\tgoto err_remove_rx_link;\n\t}\n\n\tret = snd_soc_register_component(dev, &soc_codec_dev_wcd938x,\n\t\t\t\t\t wcd938x_dais, ARRAY_SIZE(wcd938x_dais));\n\tif (ret) {\n\t\tdev_err(dev, \"%s: Codec registration failed\\n\",\n\t\t\t\t__func__);\n\t\tgoto err_remove_rx_link;\n\t}\n\n\treturn 0;\n\nerr_remove_rx_link:\n\tdevice_link_remove(dev, wcd938x->rxdev);\nerr_remove_tx_link:\n\tdevice_link_remove(dev, wcd938x->txdev);\nerr_remove_rxtx_link:\n\tdevice_link_remove(wcd938x->rxdev, wcd938x->txdev);\nerr_put_txdev:\n\tput_device(wcd938x->txdev);\nerr_put_rxdev:\n\tput_device(wcd938x->rxdev);\nerr_unbind:\n\tcomponent_unbind_all(dev, wcd938x);\n\n\treturn ret;\n}\n\nstatic void wcd938x_unbind(struct device *dev)\n{\n\tstruct wcd938x_priv *wcd938x = dev_get_drvdata(dev);\n\n\tsnd_soc_unregister_component(dev);\n\tdevice_link_remove(dev, wcd938x->txdev);\n\tdevice_link_remove(dev, wcd938x->rxdev);\n\tdevice_link_remove(wcd938x->rxdev, wcd938x->txdev);\n\tput_device(wcd938x->txdev);\n\tput_device(wcd938x->rxdev);\n\tcomponent_unbind_all(dev, wcd938x);\n}\n\nstatic const struct component_master_ops wcd938x_comp_ops = {\n\t.bind   = wcd938x_bind,\n\t.unbind = wcd938x_unbind,\n};\n\nstatic int wcd938x_add_slave_components(struct wcd938x_priv *wcd938x,\n\t\t\t\t\tstruct device *dev,\n\t\t\t\t\tstruct component_match **matchptr)\n{\n\tstruct device_node *np;\n\n\tnp = dev->of_node;\n\n\twcd938x->rxnode = of_parse_phandle(np, \"qcom,rx-device\", 0);\n\tif (!wcd938x->rxnode) {\n\t\tdev_err(dev, \"%s: Rx-device node not defined\\n\", __func__);\n\t\treturn -ENODEV;\n\t}\n\n\tof_node_get(wcd938x->rxnode);\n\tcomponent_match_add_release(dev, matchptr, component_release_of,\n\t\t\t\t    component_compare_of, wcd938x->rxnode);\n\n\twcd938x->txnode = of_parse_phandle(np, \"qcom,tx-device\", 0);\n\tif (!wcd938x->txnode) {\n\t\tdev_err(dev, \"%s: Tx-device node not defined\\n\", __func__);\n\t\treturn -ENODEV;\n\t}\n\tof_node_get(wcd938x->txnode);\n\tcomponent_match_add_release(dev, matchptr, component_release_of,\n\t\t\t\t    component_compare_of, wcd938x->txnode);\n\treturn 0;\n}\n\nstatic int wcd938x_probe(struct platform_device *pdev)\n{\n\tstruct component_match *match = NULL;\n\tstruct wcd938x_priv *wcd938x = NULL;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\twcd938x = devm_kzalloc(dev, sizeof(struct wcd938x_priv),\n\t\t\t\tGFP_KERNEL);\n\tif (!wcd938x)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(dev, wcd938x);\n\tmutex_init(&wcd938x->micb_lock);\n\n\tret = wcd938x_populate_dt_data(wcd938x, dev);\n\tif (ret) {\n\t\tdev_err(dev, \"%s: Fail to obtain platform data\\n\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\tret = wcd938x_add_slave_components(wcd938x, dev, &match);\n\tif (ret)\n\t\tgoto err_disable_regulators;\n\n\twcd938x_reset(wcd938x);\n\n\tret = component_master_add_with_match(dev, &wcd938x_comp_ops, match);\n\tif (ret)\n\t\tgoto err_disable_regulators;\n\n\tpm_runtime_set_autosuspend_delay(dev, 1000);\n\tpm_runtime_use_autosuspend(dev);\n\tpm_runtime_mark_last_busy(dev);\n\tpm_runtime_set_active(dev);\n\tpm_runtime_enable(dev);\n\tpm_runtime_idle(dev);\n\n\treturn 0;\n\nerr_disable_regulators:\n\tregulator_bulk_disable(WCD938X_MAX_SUPPLY, wcd938x->supplies);\n\tregulator_bulk_free(WCD938X_MAX_SUPPLY, wcd938x->supplies);\n\n\treturn ret;\n}\n\nstatic void wcd938x_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct wcd938x_priv *wcd938x = dev_get_drvdata(dev);\n\n\tcomponent_master_del(dev, &wcd938x_comp_ops);\n\n\tpm_runtime_disable(dev);\n\tpm_runtime_set_suspended(dev);\n\tpm_runtime_dont_use_autosuspend(dev);\n\n\tregulator_bulk_disable(WCD938X_MAX_SUPPLY, wcd938x->supplies);\n\tregulator_bulk_free(WCD938X_MAX_SUPPLY, wcd938x->supplies);\n}\n\n#if defined(CONFIG_OF)\nstatic const struct of_device_id wcd938x_dt_match[] = {\n\t{ .compatible = \"qcom,wcd9380-codec\" },\n\t{ .compatible = \"qcom,wcd9385-codec\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, wcd938x_dt_match);\n#endif\n\nstatic struct platform_driver wcd938x_codec_driver = {\n\t.probe = wcd938x_probe,\n\t.remove_new = wcd938x_remove,\n\t.driver = {\n\t\t.name = \"wcd938x_codec\",\n\t\t.of_match_table = of_match_ptr(wcd938x_dt_match),\n\t\t.suppress_bind_attrs = true,\n\t},\n};\n\nmodule_platform_driver(wcd938x_codec_driver);\nMODULE_DESCRIPTION(\"WCD938X Codec driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}