{
  "module_name": "wm9713.c",
  "hash_id": "86702f3c14ecffcff6af8c8aa0d8da6e75f48d47da304472af173276aad10f2d",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/wm9713.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/mfd/wm97xx.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/regmap.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/ac97_codec.h>\n#include <sound/ac97/codec.h>\n#include <sound/ac97/compat.h>\n#include <sound/initval.h>\n#include <sound/pcm_params.h>\n#include <sound/tlv.h>\n#include <sound/soc.h>\n\n#include \"wm9713.h\"\n\n#define WM9713_VENDOR_ID 0x574d4c13\n#define WM9713_VENDOR_ID_MASK 0xffffffff\n\nstruct wm9713_priv {\n\tstruct snd_ac97 *ac97;\n\tu32 pll_in;  \n\tunsigned int hp_mixer[2];\n\tstruct mutex lock;\n\tstruct wm97xx_platform_data *mfd_pdata;\n};\n\n#define HPL_MIXER 0\n#define HPR_MIXER 1\n\nstatic const char *wm9713_mic_mixer[] = {\"Stereo\", \"Mic 1\", \"Mic 2\", \"Mute\"};\nstatic const char *wm9713_rec_mux[] = {\"Stereo\", \"Left\", \"Right\", \"Mute\"};\nstatic const char *wm9713_rec_src[] =\n\t{\"Mic 1\", \"Mic 2\", \"Line\", \"Mono In\", \"Headphone\", \"Speaker\",\n\t\"Mono Out\", \"Zh\"};\nstatic const char *wm9713_rec_gain[] = {\"+1.5dB Steps\", \"+0.75dB Steps\"};\nstatic const char *wm9713_alc_select[] = {\"None\", \"Left\", \"Right\", \"Stereo\"};\nstatic const char *wm9713_mono_pga[] = {\"Vmid\", \"Zh\", \"Mono\", \"Inv\"};\nstatic const char *wm9713_spk_pga[] =\n\t{\"Vmid\", \"Zh\", \"Headphone\", \"Speaker\", \"Inv\", \"Headphone Vmid\",\n\t\"Speaker Vmid\", \"Inv Vmid\"};\nstatic const char *wm9713_hp_pga[] = {\"Vmid\", \"Zh\", \"Headphone\",\n\t\"Headphone Vmid\"};\nstatic const char *wm9713_out3_pga[] = {\"Vmid\", \"Zh\", \"Inv 1\", \"Inv 1 Vmid\"};\nstatic const char *wm9713_out4_pga[] = {\"Vmid\", \"Zh\", \"Inv 2\", \"Inv 2 Vmid\"};\nstatic const char *wm9713_dac_inv[] =\n\t{\"Off\", \"Mono\", \"Speaker\", \"Left Headphone\", \"Right Headphone\",\n\t\"Headphone Mono\", \"NC\", \"Vmid\"};\nstatic const char *wm9713_bass[] = {\"Linear Control\", \"Adaptive Boost\"};\nstatic const char *wm9713_ng_type[] = {\"Constant Gain\", \"Mute\"};\nstatic const char *wm9713_mic_select[] = {\"Mic 1\", \"Mic 2 A\", \"Mic 2 B\"};\nstatic const char *wm9713_micb_select[] = {\"MPB\", \"MPA\"};\n\nstatic const struct soc_enum wm9713_enum[] = {\nSOC_ENUM_SINGLE(AC97_LINE, 3, 4, wm9713_mic_mixer),  \nSOC_ENUM_SINGLE(AC97_VIDEO, 14, 4, wm9713_rec_mux),  \nSOC_ENUM_SINGLE(AC97_VIDEO, 9, 4, wm9713_rec_mux),   \nSOC_ENUM_SINGLE(AC97_VIDEO, 3, 8, wm9713_rec_src),   \nSOC_ENUM_SINGLE(AC97_VIDEO, 0, 8, wm9713_rec_src),   \nSOC_ENUM_DOUBLE(AC97_CD, 14, 6, 2, wm9713_rec_gain),  \nSOC_ENUM_SINGLE(AC97_PCI_SVID, 14, 4, wm9713_alc_select),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 14, 4, wm9713_mono_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 11, 8, wm9713_spk_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 8, 8, wm9713_spk_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 6, 3, wm9713_hp_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 4, 3, wm9713_hp_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 2, 4, wm9713_out3_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN, 0, 4, wm9713_out4_pga),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN_MIC, 13, 8, wm9713_dac_inv),  \nSOC_ENUM_SINGLE(AC97_REC_GAIN_MIC, 10, 8, wm9713_dac_inv),  \nSOC_ENUM_SINGLE(AC97_GENERAL_PURPOSE, 15, 2, wm9713_bass),  \nSOC_ENUM_SINGLE(AC97_PCI_SVID, 5, 2, wm9713_ng_type),  \nSOC_ENUM_SINGLE(AC97_3D_CONTROL, 12, 3, wm9713_mic_select),  \nSOC_ENUM_SINGLE_VIRT(2, wm9713_micb_select),  \n};\n\nstatic const DECLARE_TLV_DB_SCALE(out_tlv, -4650, 150, 0);\nstatic const DECLARE_TLV_DB_SCALE(main_tlv, -3450, 150, 0);\nstatic const DECLARE_TLV_DB_SCALE(misc_tlv, -1500, 300, 0);\nstatic const  DECLARE_TLV_DB_RANGE(mic_tlv,\n\t0, 2, TLV_DB_SCALE_ITEM(1200, 600, 0),\n\t3, 3, TLV_DB_SCALE_ITEM(3000, 0, 0)\n);\n\nstatic const struct snd_kcontrol_new wm9713_snd_ac97_controls[] = {\nSOC_DOUBLE_TLV(\"Speaker Playback Volume\", AC97_MASTER, 8, 0, 31, 1, out_tlv),\nSOC_DOUBLE(\"Speaker Playback Switch\", AC97_MASTER, 15, 7, 1, 1),\nSOC_DOUBLE_TLV(\"Headphone Playback Volume\", AC97_HEADPHONE, 8, 0, 31, 1,\n\t       out_tlv),\nSOC_DOUBLE(\"Headphone Playback Switch\", AC97_HEADPHONE, 15, 7, 1, 1),\nSOC_DOUBLE_TLV(\"Line In Volume\", AC97_PC_BEEP, 8, 0, 31, 1, main_tlv),\nSOC_DOUBLE_TLV(\"PCM Playback Volume\", AC97_PHONE, 8, 0, 31, 1, main_tlv),\nSOC_SINGLE_TLV(\"Mic 1 Volume\", AC97_MIC, 8, 31, 1, main_tlv),\nSOC_SINGLE_TLV(\"Mic 2 Volume\", AC97_MIC, 0, 31, 1, main_tlv),\nSOC_SINGLE_TLV(\"Mic 1 Preamp Volume\", AC97_3D_CONTROL, 10, 3, 0, mic_tlv),\nSOC_SINGLE_TLV(\"Mic 2 Preamp Volume\", AC97_3D_CONTROL, 12, 3, 0, mic_tlv),\n\nSOC_SINGLE(\"Mic Boost (+20dB) Switch\", AC97_LINE, 5, 1, 0),\nSOC_SINGLE(\"Mic Headphone Mixer Volume\", AC97_LINE, 0, 7, 1),\n\nSOC_SINGLE(\"Capture Switch\", AC97_CD, 15, 1, 1),\nSOC_ENUM(\"Capture Volume Steps\", wm9713_enum[5]),\nSOC_DOUBLE(\"Capture Volume\", AC97_CD, 8, 0, 31, 0),\nSOC_SINGLE(\"Capture ZC Switch\", AC97_CD, 7, 1, 0),\n\nSOC_SINGLE_TLV(\"Capture to Headphone Volume\", AC97_VIDEO, 11, 7, 1, misc_tlv),\nSOC_SINGLE(\"Capture to Mono Boost (+20dB) Switch\", AC97_VIDEO, 8, 1, 0),\nSOC_SINGLE(\"Capture ADC Boost (+20dB) Switch\", AC97_VIDEO, 6, 1, 0),\n\nSOC_SINGLE(\"ALC Target Volume\", AC97_CODEC_CLASS_REV, 12, 15, 0),\nSOC_SINGLE(\"ALC Hold Time\", AC97_CODEC_CLASS_REV, 8, 15, 0),\nSOC_SINGLE(\"ALC Decay Time\", AC97_CODEC_CLASS_REV, 4, 15, 0),\nSOC_SINGLE(\"ALC Attack Time\", AC97_CODEC_CLASS_REV, 0, 15, 0),\nSOC_ENUM(\"ALC Function\", wm9713_enum[6]),\nSOC_SINGLE(\"ALC Max Volume\", AC97_PCI_SVID, 11, 7, 0),\nSOC_SINGLE(\"ALC ZC Timeout\", AC97_PCI_SVID, 9, 3, 0),\nSOC_SINGLE(\"ALC ZC Switch\", AC97_PCI_SVID, 8, 1, 0),\nSOC_SINGLE(\"ALC NG Switch\", AC97_PCI_SVID, 7, 1, 0),\nSOC_ENUM(\"ALC NG Type\", wm9713_enum[17]),\nSOC_SINGLE(\"ALC NG Threshold\", AC97_PCI_SVID, 0, 31, 0),\n\nSOC_DOUBLE(\"Speaker Playback ZC Switch\", AC97_MASTER, 14, 6, 1, 0),\nSOC_DOUBLE(\"Headphone Playback ZC Switch\", AC97_HEADPHONE, 14, 6, 1, 0),\n\nSOC_SINGLE(\"Out4 Playback Switch\", AC97_MASTER_MONO, 15, 1, 1),\nSOC_SINGLE(\"Out4 Playback ZC Switch\", AC97_MASTER_MONO, 14, 1, 0),\nSOC_SINGLE_TLV(\"Out4 Playback Volume\", AC97_MASTER_MONO, 8, 31, 1, out_tlv),\n\nSOC_SINGLE(\"Out3 Playback Switch\", AC97_MASTER_MONO, 7, 1, 1),\nSOC_SINGLE(\"Out3 Playback ZC Switch\", AC97_MASTER_MONO, 6, 1, 0),\nSOC_SINGLE_TLV(\"Out3 Playback Volume\", AC97_MASTER_MONO, 0, 31, 1, out_tlv),\n\nSOC_SINGLE_TLV(\"Mono Capture Volume\", AC97_MASTER_TONE, 8, 31, 1, main_tlv),\nSOC_SINGLE(\"Mono Playback Switch\", AC97_MASTER_TONE, 7, 1, 1),\nSOC_SINGLE(\"Mono Playback ZC Switch\", AC97_MASTER_TONE, 6, 1, 0),\nSOC_SINGLE_TLV(\"Mono Playback Volume\", AC97_MASTER_TONE, 0, 31, 1, out_tlv),\n\nSOC_SINGLE_TLV(\"Headphone Mixer Beep Playback Volume\", AC97_AUX, 12, 7, 1,\n\t       misc_tlv),\nSOC_SINGLE_TLV(\"Speaker Mixer Beep Playback Volume\", AC97_AUX, 8, 7, 1,\n\t       misc_tlv),\nSOC_SINGLE_TLV(\"Mono Mixer Beep Playback Volume\", AC97_AUX, 4, 7, 1, misc_tlv),\n\nSOC_SINGLE_TLV(\"Voice Playback Headphone Volume\", AC97_PCM, 12, 7, 1,\n\t       misc_tlv),\nSOC_SINGLE(\"Voice Playback Master Volume\", AC97_PCM, 8, 7, 1),\nSOC_SINGLE(\"Voice Playback Mono Volume\", AC97_PCM, 4, 7, 1),\n\nSOC_SINGLE_TLV(\"Headphone Mixer Aux Playback Volume\", AC97_REC_SEL, 12, 7, 1,\n\t       misc_tlv),\n\nSOC_SINGLE_TLV(\"Speaker Mixer Voice Playback Volume\", AC97_PCM, 8, 7, 1,\n\t       misc_tlv),\nSOC_SINGLE_TLV(\"Speaker Mixer Aux Playback Volume\", AC97_REC_SEL, 8, 7, 1,\n\t       misc_tlv),\n\nSOC_SINGLE_TLV(\"Mono Mixer Voice Playback Volume\", AC97_PCM, 4, 7, 1,\n\t       misc_tlv),\nSOC_SINGLE_TLV(\"Mono Mixer Aux Playback Volume\", AC97_REC_SEL, 4, 7, 1,\n\t       misc_tlv),\n\nSOC_SINGLE(\"Aux Playback Headphone Volume\", AC97_REC_SEL, 12, 7, 1),\nSOC_SINGLE(\"Aux Playback Master Volume\", AC97_REC_SEL, 8, 7, 1),\n\nSOC_ENUM(\"Bass Control\", wm9713_enum[16]),\nSOC_SINGLE(\"Bass Cut-off Switch\", AC97_GENERAL_PURPOSE, 12, 1, 1),\nSOC_SINGLE(\"Tone Cut-off Switch\", AC97_GENERAL_PURPOSE, 4, 1, 1),\nSOC_SINGLE(\"Playback Attenuate (-6dB) Switch\", AC97_GENERAL_PURPOSE, 6, 1, 0),\nSOC_SINGLE(\"Bass Volume\", AC97_GENERAL_PURPOSE, 8, 15, 1),\nSOC_SINGLE(\"Tone Volume\", AC97_GENERAL_PURPOSE, 0, 15, 1),\n\nSOC_SINGLE(\"3D Upper Cut-off Switch\", AC97_REC_GAIN_MIC, 5, 1, 0),\nSOC_SINGLE(\"3D Lower Cut-off Switch\", AC97_REC_GAIN_MIC, 4, 1, 0),\nSOC_SINGLE(\"3D Depth\", AC97_REC_GAIN_MIC, 0, 15, 1),\n};\n\nstatic int wm9713_voice_shutdown(struct snd_soc_dapm_widget *w,\n\t\t\t\t struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\n\tif (WARN_ON(event != SND_SOC_DAPM_PRE_PMD))\n\t\treturn -EINVAL;\n\n\t \n\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0f00, 0x0200);\n\tschedule_timeout_interruptible(msecs_to_jiffies(1));\n\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0f00, 0x0f00);\n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_MID, 0x1000, 0x1000);\n\n\treturn 0;\n}\n\nstatic const unsigned int wm9713_mixer_mute_regs[] = {\n\tAC97_PC_BEEP,\n\tAC97_MASTER_TONE,\n\tAC97_PHONE,\n\tAC97_REC_SEL,\n\tAC97_PCM,\n\tAC97_AUX,\n};\n\n \nstatic int wm9713_hp_mixer_put(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_dapm_kcontrol_dapm(kcontrol);\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(dapm);\n\tstruct wm9713_priv *wm9713 = snd_soc_component_get_drvdata(component);\n\tunsigned int val = ucontrol->value.integer.value[0];\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tunsigned int mixer, mask, shift, old;\n\tstruct snd_soc_dapm_update update = {};\n\tbool change;\n\n\tmixer = mc->shift >> 8;\n\tshift = mc->shift & 0xff;\n\tmask = (1 << shift);\n\n\tmutex_lock(&wm9713->lock);\n\told = wm9713->hp_mixer[mixer];\n\tif (ucontrol->value.integer.value[0])\n\t\twm9713->hp_mixer[mixer] |= mask;\n\telse\n\t\twm9713->hp_mixer[mixer] &= ~mask;\n\n\tchange = old != wm9713->hp_mixer[mixer];\n\tif (change) {\n\t\tupdate.kcontrol = kcontrol;\n\t\tupdate.reg = wm9713_mixer_mute_regs[shift];\n\t\tupdate.mask = 0x8000;\n\t\tif ((wm9713->hp_mixer[0] & mask) ||\n\t\t    (wm9713->hp_mixer[1] & mask))\n\t\t\tupdate.val = 0x0;\n\t\telse\n\t\t\tupdate.val = 0x8000;\n\n\t\tsnd_soc_dapm_mixer_update_power(dapm, kcontrol, val,\n\t\t\t&update);\n\t}\n\n\tmutex_unlock(&wm9713->lock);\n\n\treturn change;\n}\n\nstatic int wm9713_hp_mixer_get(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_dapm_kcontrol_dapm(kcontrol);\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(dapm);\n\tstruct wm9713_priv *wm9713 = snd_soc_component_get_drvdata(component);\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tunsigned int mixer, shift;\n\n\tmixer = mc->shift >> 8;\n\tshift = mc->shift & 0xff;\n\n\tucontrol->value.integer.value[0] =\n\t\t(wm9713->hp_mixer[mixer] >> shift) & 1;\n\n\treturn 0;\n}\n\n#define WM9713_HP_MIXER_CTRL(xname, xmixer, xshift) { \\\n\t.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \\\n\t.info = snd_soc_info_volsw, \\\n\t.get = wm9713_hp_mixer_get, .put = wm9713_hp_mixer_put, \\\n\t.private_value = SOC_DOUBLE_VALUE(SND_SOC_NOPM, \\\n\t\txshift, xmixer, 1, 0, 0) \\\n}\n\n \nstatic const struct snd_kcontrol_new wm9713_hpl_mixer_controls[] = {\nWM9713_HP_MIXER_CTRL(\"Beep Playback Switch\", HPL_MIXER, 5),\nWM9713_HP_MIXER_CTRL(\"Voice Playback Switch\", HPL_MIXER, 4),\nWM9713_HP_MIXER_CTRL(\"Aux Playback Switch\", HPL_MIXER, 3),\nWM9713_HP_MIXER_CTRL(\"PCM Playback Switch\", HPL_MIXER, 2),\nWM9713_HP_MIXER_CTRL(\"MonoIn Playback Switch\", HPL_MIXER, 1),\nWM9713_HP_MIXER_CTRL(\"Bypass Playback Switch\", HPL_MIXER, 0),\n};\n\n \nstatic const struct snd_kcontrol_new wm9713_hpr_mixer_controls[] = {\nWM9713_HP_MIXER_CTRL(\"Beep Playback Switch\", HPR_MIXER, 5),\nWM9713_HP_MIXER_CTRL(\"Voice Playback Switch\", HPR_MIXER, 4),\nWM9713_HP_MIXER_CTRL(\"Aux Playback Switch\", HPR_MIXER, 3),\nWM9713_HP_MIXER_CTRL(\"PCM Playback Switch\", HPR_MIXER, 2),\nWM9713_HP_MIXER_CTRL(\"MonoIn Playback Switch\", HPR_MIXER, 1),\nWM9713_HP_MIXER_CTRL(\"Bypass Playback Switch\", HPR_MIXER, 0),\n};\n\n \nstatic const struct snd_kcontrol_new wm9713_hp_rec_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[1]);\n\n \nstatic const struct snd_kcontrol_new wm9713_hp_mic_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[0]);\n\n \nstatic const struct snd_kcontrol_new wm9713_speaker_mixer_controls[] = {\nSOC_DAPM_SINGLE(\"Beep Playback Switch\", AC97_AUX, 11, 1, 1),\nSOC_DAPM_SINGLE(\"Voice Playback Switch\", AC97_PCM, 11, 1, 1),\nSOC_DAPM_SINGLE(\"Aux Playback Switch\", AC97_REC_SEL, 11, 1, 1),\nSOC_DAPM_SINGLE(\"PCM Playback Switch\", AC97_PHONE, 14, 1, 1),\nSOC_DAPM_SINGLE(\"MonoIn Playback Switch\", AC97_MASTER_TONE, 14, 1, 1),\nSOC_DAPM_SINGLE(\"Bypass Playback Switch\", AC97_PC_BEEP, 14, 1, 1),\n};\n\n \nstatic const struct snd_kcontrol_new wm9713_mono_mixer_controls[] = {\nSOC_DAPM_SINGLE(\"Beep Playback Switch\", AC97_AUX, 7, 1, 1),\nSOC_DAPM_SINGLE(\"Voice Playback Switch\", AC97_PCM, 7, 1, 1),\nSOC_DAPM_SINGLE(\"Aux Playback Switch\", AC97_REC_SEL, 7, 1, 1),\nSOC_DAPM_SINGLE(\"PCM Playback Switch\", AC97_PHONE, 13, 1, 1),\nSOC_DAPM_SINGLE(\"MonoIn Playback Switch\", AC97_MASTER_TONE, 13, 1, 1),\nSOC_DAPM_SINGLE(\"Bypass Playback Switch\", AC97_PC_BEEP, 13, 1, 1),\nSOC_DAPM_SINGLE(\"Mic 1 Sidetone Switch\", AC97_LINE, 7, 1, 1),\nSOC_DAPM_SINGLE(\"Mic 2 Sidetone Switch\", AC97_LINE, 6, 1, 1),\n};\n\n \nstatic const struct snd_kcontrol_new wm9713_mono_mic_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[2]);\n\n \nstatic const struct snd_kcontrol_new wm9713_mono_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[7]);\n\n \nstatic const struct snd_kcontrol_new wm9713_hp_spkl_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[8]);\n\n \nstatic const struct snd_kcontrol_new wm9713_hp_spkr_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[9]);\n\n \nstatic const struct snd_kcontrol_new wm9713_hpl_out_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[10]);\n\n \nstatic const struct snd_kcontrol_new wm9713_hpr_out_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[11]);\n\n \nstatic const struct snd_kcontrol_new wm9713_out3_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[12]);\n\n \nstatic const struct snd_kcontrol_new wm9713_out4_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[13]);\n\n \nstatic const struct snd_kcontrol_new wm9713_dac_inv1_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[14]);\n\n \nstatic const struct snd_kcontrol_new wm9713_dac_inv2_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[15]);\n\n \nstatic const struct snd_kcontrol_new wm9713_rec_srcl_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[3]);\n\n \nstatic const struct snd_kcontrol_new wm9713_rec_srcr_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[4]);\n\n \nstatic const struct snd_kcontrol_new wm9713_mic_sel_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[18]);\n\n \nstatic const struct snd_kcontrol_new wm9713_micb_sel_mux_controls =\nSOC_DAPM_ENUM(\"Route\", wm9713_enum[19]);\n\nstatic const struct snd_soc_dapm_widget wm9713_dapm_widgets[] = {\nSND_SOC_DAPM_MUX(\"Capture Headphone Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_hp_rec_mux_controls),\nSND_SOC_DAPM_MUX(\"Sidetone Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_hp_mic_mux_controls),\nSND_SOC_DAPM_MUX(\"Capture Mono Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_mono_mic_mux_controls),\nSND_SOC_DAPM_MUX(\"Mono Out Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_mono_mux_controls),\nSND_SOC_DAPM_MUX(\"Left Speaker Out Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_hp_spkl_mux_controls),\nSND_SOC_DAPM_MUX(\"Right Speaker Out Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_hp_spkr_mux_controls),\nSND_SOC_DAPM_MUX(\"Left Headphone Out Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_hpl_out_mux_controls),\nSND_SOC_DAPM_MUX(\"Right Headphone Out Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_hpr_out_mux_controls),\nSND_SOC_DAPM_MUX(\"Out 3 Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_out3_mux_controls),\nSND_SOC_DAPM_MUX(\"Out 4 Mux\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_out4_mux_controls),\nSND_SOC_DAPM_MUX(\"DAC Inv Mux 1\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_dac_inv1_mux_controls),\nSND_SOC_DAPM_MUX(\"DAC Inv Mux 2\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_dac_inv2_mux_controls),\nSND_SOC_DAPM_MUX(\"Left Capture Source\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_rec_srcl_mux_controls),\nSND_SOC_DAPM_MUX(\"Right Capture Source\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_rec_srcr_mux_controls),\nSND_SOC_DAPM_MUX(\"Mic A Source\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_mic_sel_mux_controls),\nSND_SOC_DAPM_MUX(\"Mic B Source\", SND_SOC_NOPM, 0, 0,\n\t&wm9713_micb_sel_mux_controls),\nSND_SOC_DAPM_MIXER(\"Left HP Mixer\", AC97_EXTENDED_MID, 3, 1,\n\t&wm9713_hpl_mixer_controls[0], ARRAY_SIZE(wm9713_hpl_mixer_controls)),\nSND_SOC_DAPM_MIXER(\"Right HP Mixer\", AC97_EXTENDED_MID, 2, 1,\n\t&wm9713_hpr_mixer_controls[0], ARRAY_SIZE(wm9713_hpr_mixer_controls)),\nSND_SOC_DAPM_MIXER(\"Mono Mixer\", AC97_EXTENDED_MID, 0, 1,\n\t&wm9713_mono_mixer_controls[0], ARRAY_SIZE(wm9713_mono_mixer_controls)),\nSND_SOC_DAPM_MIXER(\"Speaker Mixer\", AC97_EXTENDED_MID, 1, 1,\n\t&wm9713_speaker_mixer_controls[0],\n\tARRAY_SIZE(wm9713_speaker_mixer_controls)),\nSND_SOC_DAPM_DAC(\"Left DAC\", \"Left HiFi Playback\", AC97_EXTENDED_MID, 7, 1),\nSND_SOC_DAPM_DAC(\"Right DAC\", \"Right HiFi Playback\", AC97_EXTENDED_MID, 6, 1),\nSND_SOC_DAPM_MIXER(\"AC97 Mixer\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_MIXER(\"HP Mixer\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_MIXER(\"Line Mixer\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_MIXER(\"Capture Mixer\", SND_SOC_NOPM, 0, 0, NULL, 0),\nSND_SOC_DAPM_DAC_E(\"Voice DAC\", \"Voice Playback\", AC97_EXTENDED_MID, 12, 1,\n\t\t   wm9713_voice_shutdown, SND_SOC_DAPM_PRE_PMD),\nSND_SOC_DAPM_DAC(\"Aux DAC\", \"Aux Playback\", AC97_EXTENDED_MID, 11, 1),\nSND_SOC_DAPM_PGA(\"Left ADC\", AC97_EXTENDED_MID, 5, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Right ADC\", AC97_EXTENDED_MID, 4, 1, NULL, 0),\nSND_SOC_DAPM_ADC(\"Left HiFi ADC\", \"Left HiFi Capture\", SND_SOC_NOPM, 0, 0),\nSND_SOC_DAPM_ADC(\"Right HiFi ADC\", \"Right HiFi Capture\", SND_SOC_NOPM, 0, 0),\nSND_SOC_DAPM_ADC(\"Left Voice ADC\", \"Left Voice Capture\", SND_SOC_NOPM, 0, 0),\nSND_SOC_DAPM_ADC(\"Right Voice ADC\", \"Right Voice Capture\", SND_SOC_NOPM, 0, 0),\nSND_SOC_DAPM_PGA(\"Left Headphone\", AC97_EXTENDED_MSTATUS, 10, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Right Headphone\", AC97_EXTENDED_MSTATUS, 9, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Left Speaker\", AC97_EXTENDED_MSTATUS, 8, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Right Speaker\", AC97_EXTENDED_MSTATUS, 7, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Out 3\", AC97_EXTENDED_MSTATUS, 11, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Out 4\", AC97_EXTENDED_MSTATUS, 12, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Mono Out\", AC97_EXTENDED_MSTATUS, 13, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Left Line In\", AC97_EXTENDED_MSTATUS, 6, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Right Line In\", AC97_EXTENDED_MSTATUS, 5, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Mono In\", AC97_EXTENDED_MSTATUS, 4, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Mic A PGA\", AC97_EXTENDED_MSTATUS, 3, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Mic B PGA\", AC97_EXTENDED_MSTATUS, 2, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Mic A Pre Amp\", AC97_EXTENDED_MSTATUS, 1, 1, NULL, 0),\nSND_SOC_DAPM_PGA(\"Mic B Pre Amp\", AC97_EXTENDED_MSTATUS, 0, 1, NULL, 0),\nSND_SOC_DAPM_MICBIAS(\"Mic Bias\", AC97_EXTENDED_MSTATUS, 14, 1),\nSND_SOC_DAPM_OUTPUT(\"MONO\"),\nSND_SOC_DAPM_OUTPUT(\"HPL\"),\nSND_SOC_DAPM_OUTPUT(\"HPR\"),\nSND_SOC_DAPM_OUTPUT(\"SPKL\"),\nSND_SOC_DAPM_OUTPUT(\"SPKR\"),\nSND_SOC_DAPM_OUTPUT(\"OUT3\"),\nSND_SOC_DAPM_OUTPUT(\"OUT4\"),\nSND_SOC_DAPM_INPUT(\"LINEL\"),\nSND_SOC_DAPM_INPUT(\"LINER\"),\nSND_SOC_DAPM_INPUT(\"MONOIN\"),\nSND_SOC_DAPM_INPUT(\"PCBEEP\"),\nSND_SOC_DAPM_INPUT(\"MIC1\"),\nSND_SOC_DAPM_INPUT(\"MIC2A\"),\nSND_SOC_DAPM_INPUT(\"MIC2B\"),\nSND_SOC_DAPM_VMID(\"VMID\"),\n};\n\nstatic const struct snd_soc_dapm_route wm9713_audio_map[] = {\n\t \n\t{\"Left HP Mixer\", \"Beep Playback Switch\",    \"PCBEEP\"},\n\t{\"Left HP Mixer\", \"Voice Playback Switch\",   \"Voice DAC\"},\n\t{\"Left HP Mixer\", \"Aux Playback Switch\",     \"Aux DAC\"},\n\t{\"Left HP Mixer\", \"Bypass Playback Switch\",  \"Left Line In\"},\n\t{\"Left HP Mixer\", \"PCM Playback Switch\",     \"Left DAC\"},\n\t{\"Left HP Mixer\", \"MonoIn Playback Switch\",  \"Mono In\"},\n\t{\"Left HP Mixer\", NULL,  \"Capture Headphone Mux\"},\n\n\t \n\t{\"Right HP Mixer\", \"Beep Playback Switch\",    \"PCBEEP\"},\n\t{\"Right HP Mixer\", \"Voice Playback Switch\",   \"Voice DAC\"},\n\t{\"Right HP Mixer\", \"Aux Playback Switch\",     \"Aux DAC\"},\n\t{\"Right HP Mixer\", \"Bypass Playback Switch\",  \"Right Line In\"},\n\t{\"Right HP Mixer\", \"PCM Playback Switch\",     \"Right DAC\"},\n\t{\"Right HP Mixer\", \"MonoIn Playback Switch\",  \"Mono In\"},\n\t{\"Right HP Mixer\", NULL,  \"Capture Headphone Mux\"},\n\n\t \n\t{\"AC97 Mixer\", NULL, \"Left DAC\"},\n\t{\"AC97 Mixer\", NULL, \"Right DAC\"},\n\t{\"Line Mixer\", NULL, \"Right Line In\"},\n\t{\"Line Mixer\", NULL, \"Left Line In\"},\n\t{\"HP Mixer\", NULL, \"Left HP Mixer\"},\n\t{\"HP Mixer\", NULL, \"Right HP Mixer\"},\n\t{\"Capture Mixer\", NULL, \"Left Capture Source\"},\n\t{\"Capture Mixer\", NULL, \"Right Capture Source\"},\n\n\t \n\t{\"Speaker Mixer\", \"Beep Playback Switch\",    \"PCBEEP\"},\n\t{\"Speaker Mixer\", \"Voice Playback Switch\",   \"Voice DAC\"},\n\t{\"Speaker Mixer\", \"Aux Playback Switch\",     \"Aux DAC\"},\n\t{\"Speaker Mixer\", \"Bypass Playback Switch\",  \"Line Mixer\"},\n\t{\"Speaker Mixer\", \"PCM Playback Switch\",     \"AC97 Mixer\"},\n\t{\"Speaker Mixer\", \"MonoIn Playback Switch\",  \"Mono In\"},\n\n\t \n\t{\"Mono Mixer\", \"Beep Playback Switch\",    \"PCBEEP\"},\n\t{\"Mono Mixer\", \"Voice Playback Switch\",   \"Voice DAC\"},\n\t{\"Mono Mixer\", \"Aux Playback Switch\",     \"Aux DAC\"},\n\t{\"Mono Mixer\", \"Bypass Playback Switch\",  \"Line Mixer\"},\n\t{\"Mono Mixer\", \"PCM Playback Switch\",     \"AC97 Mixer\"},\n\t{\"Mono Mixer\", \"Mic 1 Sidetone Switch\", \"Mic A PGA\"},\n\t{\"Mono Mixer\", \"Mic 2 Sidetone Switch\", \"Mic B PGA\"},\n\t{\"Mono Mixer\", NULL,  \"Capture Mono Mux\"},\n\n\t \n\t{\"DAC Inv Mux 1\", \"Mono\", \"Mono Mixer\"},\n\t{\"DAC Inv Mux 1\", \"Speaker\", \"Speaker Mixer\"},\n\t{\"DAC Inv Mux 1\", \"Left Headphone\", \"Left HP Mixer\"},\n\t{\"DAC Inv Mux 1\", \"Right Headphone\", \"Right HP Mixer\"},\n\t{\"DAC Inv Mux 1\", \"Headphone Mono\", \"HP Mixer\"},\n\n\t \n\t{\"DAC Inv Mux 2\", \"Mono\", \"Mono Mixer\"},\n\t{\"DAC Inv Mux 2\", \"Speaker\", \"Speaker Mixer\"},\n\t{\"DAC Inv Mux 2\", \"Left Headphone\", \"Left HP Mixer\"},\n\t{\"DAC Inv Mux 2\", \"Right Headphone\", \"Right HP Mixer\"},\n\t{\"DAC Inv Mux 2\", \"Headphone Mono\", \"HP Mixer\"},\n\n\t \n\t{\"Left Headphone Out Mux\", \"Headphone\", \"Left HP Mixer\"},\n\n\t \n\t{\"Right Headphone Out Mux\", \"Headphone\", \"Right HP Mixer\"},\n\n\t \n\t{\"Left Speaker Out Mux\", \"Headphone\", \"Left HP Mixer\"},\n\t{\"Left Speaker Out Mux\", \"Speaker\", \"Speaker Mixer\"},\n\t{\"Left Speaker Out Mux\", \"Inv\", \"DAC Inv Mux 1\"},\n\n\t \n\t{\"Right Speaker Out Mux\", \"Headphone\", \"Right HP Mixer\"},\n\t{\"Right Speaker Out Mux\", \"Speaker\", \"Speaker Mixer\"},\n\t{\"Right Speaker Out Mux\", \"Inv\", \"DAC Inv Mux 2\"},\n\n\t \n\t{\"Mono Out Mux\", \"Mono\", \"Mono Mixer\"},\n\t{\"Mono Out Mux\", \"Inv\", \"DAC Inv Mux 1\"},\n\n\t \n\t{\"Out 3 Mux\", \"Inv 1\", \"DAC Inv Mux 1\"},\n\n\t \n\t{\"Out 4 Mux\", \"Inv 2\", \"DAC Inv Mux 2\"},\n\n\t \n\t{\"HPL\", NULL, \"Left Headphone\"},\n\t{\"Left Headphone\", NULL, \"Left Headphone Out Mux\"},\n\t{\"HPR\", NULL, \"Right Headphone\"},\n\t{\"Right Headphone\", NULL, \"Right Headphone Out Mux\"},\n\t{\"OUT3\", NULL, \"Out 3\"},\n\t{\"Out 3\", NULL, \"Out 3 Mux\"},\n\t{\"OUT4\", NULL, \"Out 4\"},\n\t{\"Out 4\", NULL, \"Out 4 Mux\"},\n\t{\"SPKL\", NULL, \"Left Speaker\"},\n\t{\"Left Speaker\", NULL, \"Left Speaker Out Mux\"},\n\t{\"SPKR\", NULL, \"Right Speaker\"},\n\t{\"Right Speaker\", NULL, \"Right Speaker Out Mux\"},\n\t{\"MONO\", NULL, \"Mono Out\"},\n\t{\"Mono Out\", NULL, \"Mono Out Mux\"},\n\n\t \n\t{\"Left Line In\", NULL, \"LINEL\"},\n\t{\"Right Line In\", NULL, \"LINER\"},\n\t{\"Mono In\", NULL, \"MONOIN\"},\n\t{\"Mic A PGA\", NULL, \"Mic A Pre Amp\"},\n\t{\"Mic B PGA\", NULL, \"Mic B Pre Amp\"},\n\n\t \n\t{\"Left Capture Source\", \"Mic 1\", \"Mic A Pre Amp\"},\n\t{\"Left Capture Source\", \"Mic 2\", \"Mic B Pre Amp\"},\n\t{\"Left Capture Source\", \"Line\", \"LINEL\"},\n\t{\"Left Capture Source\", \"Mono In\", \"MONOIN\"},\n\t{\"Left Capture Source\", \"Headphone\", \"Left HP Mixer\"},\n\t{\"Left Capture Source\", \"Speaker\", \"Speaker Mixer\"},\n\t{\"Left Capture Source\", \"Mono Out\", \"Mono Mixer\"},\n\n\t \n\t{\"Right Capture Source\", \"Mic 1\", \"Mic A Pre Amp\"},\n\t{\"Right Capture Source\", \"Mic 2\", \"Mic B Pre Amp\"},\n\t{\"Right Capture Source\", \"Line\", \"LINER\"},\n\t{\"Right Capture Source\", \"Mono In\", \"MONOIN\"},\n\t{\"Right Capture Source\", \"Headphone\", \"Right HP Mixer\"},\n\t{\"Right Capture Source\", \"Speaker\", \"Speaker Mixer\"},\n\t{\"Right Capture Source\", \"Mono Out\", \"Mono Mixer\"},\n\n\t \n\t{\"Left ADC\", NULL, \"Left Capture Source\"},\n\t{\"Left Voice ADC\", NULL, \"Left ADC\"},\n\t{\"Left HiFi ADC\", NULL, \"Left ADC\"},\n\n\t \n\t{\"Right ADC\", NULL, \"Right Capture Source\"},\n\t{\"Right Voice ADC\", NULL, \"Right ADC\"},\n\t{\"Right HiFi ADC\", NULL, \"Right ADC\"},\n\n\t \n\t{\"Mic A Pre Amp\", NULL, \"Mic A Source\"},\n\t{\"Mic A Source\", \"Mic 1\", \"MIC1\"},\n\t{\"Mic A Source\", \"Mic 2 A\", \"MIC2A\"},\n\t{\"Mic A Source\", \"Mic 2 B\", \"Mic B Source\"},\n\t{\"Mic B Pre Amp\", \"MPB\", \"Mic B Source\"},\n\t{\"Mic B Source\", NULL, \"MIC2B\"},\n\n\t \n\t{\"Capture Headphone Mux\", \"Stereo\", \"Capture Mixer\"},\n\t{\"Capture Headphone Mux\", \"Left\", \"Left Capture Source\"},\n\t{\"Capture Headphone Mux\", \"Right\", \"Right Capture Source\"},\n\n\t \n\t{\"Capture Mono Mux\", \"Stereo\", \"Capture Mixer\"},\n\t{\"Capture Mono Mux\", \"Left\", \"Left Capture Source\"},\n\t{\"Capture Mono Mux\", \"Right\", \"Right Capture Source\"},\n};\n\nstatic bool wm9713_readable_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase AC97_RESET ... AC97_PCM_SURR_DAC_RATE:\n\tcase AC97_PCM_LR_ADC_RATE:\n\tcase AC97_CENTER_LFE_MASTER:\n\tcase AC97_SPDIF ... AC97_LINE1_LEVEL:\n\tcase AC97_GPIO_CFG ... 0x5c:\n\tcase AC97_CODEC_CLASS_REV ... AC97_PCI_SID:\n\tcase 0x74 ... AC97_VENDOR_ID2:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool wm9713_writeable_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase AC97_VENDOR_ID1:\n\tcase AC97_VENDOR_ID2:\n\t\treturn false;\n\tdefault:\n\t\treturn wm9713_readable_reg(dev, reg);\n\t}\n}\n\nstatic const struct reg_default wm9713_reg_defaults[] = {\n\t{ 0x02, 0x8080 },\t \n\t{ 0x04, 0x8080 },\t \n\t{ 0x06, 0x8080 },\t \n\t{ 0x08, 0xc880 },\t \n\t{ 0x0a, 0xe808 },\t \n\t{ 0x0c, 0xe808 },\t \n\t{ 0x0e, 0x0808 },\t \n\t{ 0x10, 0x00da },\t \n\t{ 0x12, 0x8000 },\t \n\t{ 0x14, 0xd600 },\t \n\t{ 0x16, 0xaaa0 },\t \n\t{ 0x18, 0xaaa0 },\t \n\t{ 0x1a, 0xaaa0 },\t \n\t{ 0x1c, 0x0000 },\t \n\t{ 0x1e, 0x0000 },\t \n\t{ 0x20, 0x0f0f },\t \n\t{ 0x22, 0x0040 },\t \n\t{ 0x24, 0x0000 },\t \n\t{ 0x26, 0x7f00 },\t \n\t{ 0x28, 0x0405 },\t \n\t{ 0x2a, 0x0410 },\t \n\t{ 0x2c, 0xbb80 },\t \n\t{ 0x2e, 0xbb80 },\t \n\t{ 0x32, 0xbb80 },\t \n\t{ 0x36, 0x4523 },\t \n\t{ 0x3a, 0x2000 },\t \n\t{ 0x3c, 0xfdff },\t \n\t{ 0x3e, 0xffff },\t \n\t{ 0x40, 0x0000 },\t \n\t{ 0x42, 0x0000 },\t \n\t{ 0x44, 0x0080 },\t \n\t{ 0x46, 0x0000 },\t \n\t{ 0x4c, 0xfffe },\t \n\t{ 0x4e, 0xffff },\t \n\t{ 0x50, 0x0000 },\t \n\t{ 0x52, 0x0000 },\t \n\t\t\t\t \n\t{ 0x56, 0xfffe },\t \n\t{ 0x58, 0x4000 },\t \n\t{ 0x5a, 0x0000 },\t \n\t{ 0x5c, 0x0000 },\t \n\t{ 0x60, 0xb032 },\t \n\t{ 0x62, 0x3e00 },\t \n\t{ 0x64, 0x0000 },\t \n\t{ 0x74, 0x0000 },\t \n\t{ 0x76, 0x0006 },\t \n\t{ 0x78, 0x0001 },\t \n\t{ 0x7a, 0x0000 },\t \n};\n\nstatic const struct regmap_config wm9713_regmap_config = {\n\t.reg_bits = 16,\n\t.reg_stride = 2,\n\t.val_bits = 16,\n\t.max_register = 0x7e,\n\t.cache_type = REGCACHE_MAPLE,\n\n\t.reg_defaults = wm9713_reg_defaults,\n\t.num_reg_defaults = ARRAY_SIZE(wm9713_reg_defaults),\n\t.volatile_reg = regmap_ac97_default_volatile,\n\t.readable_reg = wm9713_readable_reg,\n\t.writeable_reg = wm9713_writeable_reg,\n};\n\n \nstruct _pll_div {\n\tu32 divsel:1;\n\tu32 divctl:1;\n\tu32 lf:1;\n\tu32 n:4;\n\tu32 k:24;\n};\n\n \n#define FIXED_PLL_SIZE ((1 << 22) * 10)\n\nstatic void pll_factors(struct snd_soc_component *component,\n\tstruct _pll_div *pll_div, unsigned int source)\n{\n\tu64 Kpart;\n\tunsigned int K, Ndiv, Nmod, target;\n\n\t \n\ttarget = 98304000;\n\n\t \n\tif (source > 14400000) {\n\t\tsource >>= 1;\n\t\tpll_div->divsel = 1;\n\n\t\tif (source > 14400000) {\n\t\t\tsource >>= 1;\n\t\t\tpll_div->divctl = 1;\n\t\t} else\n\t\t\tpll_div->divctl = 0;\n\n\t} else {\n\t\tpll_div->divsel = 0;\n\t\tpll_div->divctl = 0;\n\t}\n\n\t \n\tif (source < 8192000) {\n\t\tpll_div->lf = 1;\n\t\ttarget >>= 2;\n\t} else\n\t\tpll_div->lf = 0;\n\n\tNdiv = target / source;\n\tif ((Ndiv < 5) || (Ndiv > 12))\n\t\tdev_warn(component->dev,\n\t\t\t\"WM9713 PLL N value %u out of recommended range!\\n\",\n\t\t\tNdiv);\n\n\tpll_div->n = Ndiv;\n\tNmod = target % source;\n\tKpart = FIXED_PLL_SIZE * (long long)Nmod;\n\n\tdo_div(Kpart, source);\n\n\tK = Kpart & 0xFFFFFFFF;\n\n\t \n\tif ((K % 10) >= 5)\n\t\tK += 5;\n\n\t \n\tK /= 10;\n\n\tpll_div->k = K;\n}\n\n \nstatic int wm9713_set_pll(struct snd_soc_component *component,\n\tint pll_id, unsigned int freq_in, unsigned int freq_out)\n{\n\tstruct wm9713_priv *wm9713 = snd_soc_component_get_drvdata(component);\n\tu16 reg, reg2;\n\tstruct _pll_div pll_div;\n\n\t \n\tif (freq_in == 0) {\n\t\t \n\t\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0080, 0x0080);\n\t\tsnd_soc_component_update_bits(component, AC97_EXTENDED_MID, 0x0200, 0x0200);\n\t\twm9713->pll_in = 0;\n\t\treturn 0;\n\t}\n\n\tpll_factors(component, &pll_div, freq_in);\n\n\tif (pll_div.k == 0) {\n\t\treg = (pll_div.n << 12) | (pll_div.lf << 11) |\n\t\t\t(pll_div.divsel << 9) | (pll_div.divctl << 8);\n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\t} else {\n\t\t \n\t\treg2 = (pll_div.n << 12) | (pll_div.lf << 11) | (1 << 10) |\n\t\t\t(pll_div.divsel << 9) | (pll_div.divctl << 8);\n\n\t\t \n\t\treg = reg2 | (0x5 << 4) | (pll_div.k >> 20);\n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\n\t\t \n\t\treg = reg2 | (0x4 << 4) | ((pll_div.k >> 16) & 0xf);\n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\n\t\t \n\t\treg = reg2 | (0x3 << 4) | ((pll_div.k >> 12) & 0xf);\n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\n\t\t \n\t\treg = reg2 | (0x2 << 4) | ((pll_div.k >> 8) & 0xf);\n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\n\t\t \n\t\treg = reg2 | (0x1 << 4) | ((pll_div.k >> 4) & 0xf);\n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\n\t\treg = reg2 | (0x0 << 4) | (pll_div.k & 0xf);  \n\t\tsnd_soc_component_write(component, AC97_LINE1_LEVEL, reg);\n\t}\n\n\t \n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_MID, 0x0200, 0x0000);\n\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0080, 0x0000);\n\twm9713->pll_in = freq_in;\n\n\t \n\tschedule_timeout_interruptible(msecs_to_jiffies(10));\n\treturn 0;\n}\n\nstatic int wm9713_set_dai_pll(struct snd_soc_dai *codec_dai, int pll_id,\n\t\tint source, unsigned int freq_in, unsigned int freq_out)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\treturn wm9713_set_pll(component, pll_id, freq_in, freq_out);\n}\n\n \nstatic int wm9713_set_dai_tristate(struct snd_soc_dai *codec_dai,\n\tint tristate)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\n\tif (tristate)\n\t\tsnd_soc_component_update_bits(component, AC97_CENTER_LFE_MASTER,\n\t\t\t\t    0x6000, 0x0000);\n\n\treturn 0;\n}\n\n \nstatic int wm9713_set_dai_clkdiv(struct snd_soc_dai *codec_dai,\n\t\tint div_id, int div)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\n\tswitch (div_id) {\n\tcase WM9713_PCMCLK_DIV:\n\t\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0f00, div);\n\t\tbreak;\n\tcase WM9713_CLKA_MULT:\n\t\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0002, div);\n\t\tbreak;\n\tcase WM9713_CLKB_MULT:\n\t\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x0004, div);\n\t\tbreak;\n\tcase WM9713_HIFI_DIV:\n\t\tsnd_soc_component_update_bits(component, AC97_HANDSET_RATE, 0x7000, div);\n\t\tbreak;\n\tcase WM9713_PCMBCLK_DIV:\n\t\tsnd_soc_component_update_bits(component, AC97_CENTER_LFE_MASTER, 0x0e00, div);\n\t\tbreak;\n\tcase WM9713_PCMCLK_PLL_DIV:\n\t\tsnd_soc_component_update_bits(component, AC97_LINE1_LEVEL,\n\t\t\t\t    0x007f, div | 0x60);\n\t\tbreak;\n\tcase WM9713_HIFI_PLL_DIV:\n\t\tsnd_soc_component_update_bits(component, AC97_LINE1_LEVEL,\n\t\t\t\t    0x007f, div | 0x70);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int wm9713_set_dai_fmt(struct snd_soc_dai *codec_dai,\n\t\tunsigned int fmt)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tu16 gpio = snd_soc_component_read(component, AC97_GPIO_CFG) & 0xffc5;\n\tu16 reg = 0x8000;\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\n\tcase SND_SOC_DAIFMT_CBM_CFM:\n\t\treg |= 0x4000;\n\t\tgpio |= 0x0010;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFS:\n\t\treg |= 0x6000;\n\t\tgpio |= 0x0018;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBS_CFS:\n\t\treg |= 0x2000;\n\t\tgpio |= 0x001a;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBS_CFM:\n\t\tgpio |= 0x0012;\n\t\tbreak;\n\t}\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\treg |= 0x00c0;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\treg |= 0x0080;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\treg |= 0x0040;\n\t\tbreak;\n\t}\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\t\treg |= 0x0002;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\treg |= 0x0001;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\treg |= 0x0003;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\treg |= 0x0043;\n\t\tbreak;\n\t}\n\n\tsnd_soc_component_write(component, AC97_GPIO_CFG, gpio);\n\tsnd_soc_component_write(component, AC97_CENTER_LFE_MASTER, reg);\n\treturn 0;\n}\n\nstatic int wm9713_pcm_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\n\t \n\tswitch (params_width(params)) {\n\tcase 16:\n\t\tbreak;\n\tcase 20:\n\t\tsnd_soc_component_update_bits(component, AC97_CENTER_LFE_MASTER,\n\t\t\t\t    0x000c, 0x0004);\n\t\tbreak;\n\tcase 24:\n\t\tsnd_soc_component_update_bits(component, AC97_CENTER_LFE_MASTER,\n\t\t\t\t    0x000c, 0x0008);\n\t\tbreak;\n\tcase 32:\n\t\tsnd_soc_component_update_bits(component, AC97_CENTER_LFE_MASTER,\n\t\t\t\t    0x000c, 0x000c);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int ac97_hifi_prepare(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tint reg;\n\n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_STATUS, 0x0001, 0x0001);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\treg = AC97_PCM_FRONT_DAC_RATE;\n\telse\n\t\treg = AC97_PCM_LR_ADC_RATE;\n\n\treturn snd_soc_component_write(component, reg, runtime->rate);\n}\n\nstatic int ac97_aux_prepare(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_STATUS, 0x0001, 0x0001);\n\tsnd_soc_component_update_bits(component, AC97_PCI_SID, 0x8000, 0x8000);\n\n\tif (substream->stream != SNDRV_PCM_STREAM_PLAYBACK)\n\t\treturn -ENODEV;\n\n\treturn snd_soc_component_write(component, AC97_PCM_SURR_DAC_RATE, runtime->rate);\n}\n\n#define WM9713_RATES (SNDRV_PCM_RATE_8000  |\t\\\n\t\t      SNDRV_PCM_RATE_11025 |\t\\\n\t\t      SNDRV_PCM_RATE_22050 |\t\\\n\t\t      SNDRV_PCM_RATE_44100 |\t\\\n\t\t      SNDRV_PCM_RATE_48000)\n\n#define WM9713_PCM_RATES (SNDRV_PCM_RATE_8000  |\t\\\n\t\t\t  SNDRV_PCM_RATE_11025 |\t\\\n\t\t\t  SNDRV_PCM_RATE_16000 |\t\\\n\t\t\t  SNDRV_PCM_RATE_22050 |\t\\\n\t\t\t  SNDRV_PCM_RATE_44100 |\t\\\n\t\t\t  SNDRV_PCM_RATE_48000)\n\n#define WM9713_PCM_FORMATS \\\n\t(SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S20_3LE | \\\n\t SNDRV_PCM_FMTBIT_S24_LE)\n\nstatic const struct snd_soc_dai_ops wm9713_dai_ops_hifi = {\n\t.prepare\t= ac97_hifi_prepare,\n\t.set_clkdiv\t= wm9713_set_dai_clkdiv,\n\t.set_pll\t= wm9713_set_dai_pll,\n};\n\nstatic const struct snd_soc_dai_ops wm9713_dai_ops_aux = {\n\t.prepare\t= ac97_aux_prepare,\n\t.set_clkdiv\t= wm9713_set_dai_clkdiv,\n\t.set_pll\t= wm9713_set_dai_pll,\n};\n\nstatic const struct snd_soc_dai_ops wm9713_dai_ops_voice = {\n\t.hw_params\t= wm9713_pcm_hw_params,\n\t.set_clkdiv\t= wm9713_set_dai_clkdiv,\n\t.set_pll\t= wm9713_set_dai_pll,\n\t.set_fmt\t= wm9713_set_dai_fmt,\n\t.set_tristate\t= wm9713_set_dai_tristate,\n};\n\nstatic struct snd_soc_dai_driver wm9713_dai[] = {\n{\n\t.name = \"wm9713-hifi\",\n\t.playback = {\n\t\t.stream_name = \"HiFi Playback\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = WM9713_RATES,\n\t\t.formats = SND_SOC_STD_AC97_FMTS,},\n\t.capture = {\n\t\t.stream_name = \"HiFi Capture\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = WM9713_RATES,\n\t\t.formats = SND_SOC_STD_AC97_FMTS,},\n\t.ops = &wm9713_dai_ops_hifi,\n\t},\n\t{\n\t.name = \"wm9713-aux\",\n\t.playback = {\n\t\t.stream_name = \"Aux Playback\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 1,\n\t\t.rates = WM9713_RATES,\n\t\t.formats = SND_SOC_STD_AC97_FMTS,},\n\t.ops = &wm9713_dai_ops_aux,\n\t},\n\t{\n\t.name = \"wm9713-voice\",\n\t.playback = {\n\t\t.stream_name = \"Voice Playback\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 1,\n\t\t.rates = WM9713_PCM_RATES,\n\t\t.formats = WM9713_PCM_FORMATS,},\n\t.capture = {\n\t\t.stream_name = \"Voice Capture\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = WM9713_PCM_RATES,\n\t\t.formats = WM9713_PCM_FORMATS,},\n\t.ops = &wm9713_dai_ops_voice,\n\t.symmetric_rate = 1,\n\t},\n};\n\nstatic int wm9713_set_bias_level(struct snd_soc_component *component,\n\t\t\t\t enum snd_soc_bias_level level)\n{\n\tswitch (level) {\n\tcase SND_SOC_BIAS_ON:\n\t\t \n\t\tsnd_soc_component_update_bits(component, AC97_EXTENDED_MID, 0xe400, 0x0000);\n\t\tbreak;\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tbreak;\n\tcase SND_SOC_BIAS_STANDBY:\n\t\t \n\t\tsnd_soc_component_update_bits(component, AC97_EXTENDED_MID, 0xc400, 0x0000);\n\t\tsnd_soc_component_write(component, AC97_POWERDOWN, 0x0000);\n\t\tbreak;\n\tcase SND_SOC_BIAS_OFF:\n\t\t \n\t\tsnd_soc_component_write(component, AC97_EXTENDED_MID, 0xffff);\n\t\tsnd_soc_component_write(component, AC97_EXTENDED_MSTATUS, 0xffff);\n\t\tsnd_soc_component_write(component, AC97_POWERDOWN, 0xffff);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wm9713_soc_suspend(struct snd_soc_component *component)\n{\n\t \n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_MID, 0x7fff,\n\t\t\t\t 0x7fff);\n\tsnd_soc_component_write(component, AC97_EXTENDED_MSTATUS, 0xffff);\n\tsnd_soc_component_write(component, AC97_POWERDOWN, 0x6f00);\n\tsnd_soc_component_write(component, AC97_POWERDOWN, 0xffff);\n\n\treturn 0;\n}\n\nstatic int wm9713_soc_resume(struct snd_soc_component *component)\n{\n\tstruct wm9713_priv *wm9713 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = snd_ac97_reset(wm9713->ac97, true, WM9713_VENDOR_ID,\n\t\tWM9713_VENDOR_ID_MASK);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tsnd_soc_component_force_bias_level(component, SND_SOC_BIAS_STANDBY);\n\n\t \n\tif (wm9713->pll_in)\n\t\twm9713_set_pll(component, 0, wm9713->pll_in, 0);\n\n\t \n\tif (ret == 0) {\n\t\tregcache_mark_dirty(component->regmap);\n\t\tsnd_soc_component_cache_sync(component);\n\t}\n\n\treturn ret;\n}\n\nstatic int wm9713_soc_probe(struct snd_soc_component *component)\n{\n\tstruct wm9713_priv *wm9713 = snd_soc_component_get_drvdata(component);\n\tstruct regmap *regmap = NULL;\n\n\tif (wm9713->mfd_pdata) {\n\t\twm9713->ac97 = wm9713->mfd_pdata->ac97;\n\t\tregmap = wm9713->mfd_pdata->regmap;\n\t} else if (IS_ENABLED(CONFIG_SND_SOC_AC97_BUS)) {\n\t\twm9713->ac97 = snd_soc_new_ac97_component(component, WM9713_VENDOR_ID,\n\t\t\t\t\t\t      WM9713_VENDOR_ID_MASK);\n\t\tif (IS_ERR(wm9713->ac97))\n\t\t\treturn PTR_ERR(wm9713->ac97);\n\t\tregmap = regmap_init_ac97(wm9713->ac97, &wm9713_regmap_config);\n\t\tif (IS_ERR(regmap)) {\n\t\t\tsnd_soc_free_ac97_component(wm9713->ac97);\n\t\t\treturn PTR_ERR(regmap);\n\t\t}\n\t} else {\n\t\treturn -ENXIO;\n\t}\n\n\tsnd_soc_component_init_regmap(component, regmap);\n\n\t \n\tsnd_soc_component_update_bits(component, AC97_CD, 0x7fff, 0x0000);\n\n\treturn 0;\n}\n\nstatic void wm9713_soc_remove(struct snd_soc_component *component)\n{\n\tstruct wm9713_priv *wm9713 = snd_soc_component_get_drvdata(component);\n\n\tif (IS_ENABLED(CONFIG_SND_SOC_AC97_BUS) && !wm9713->mfd_pdata) {\n\t\tsnd_soc_component_exit_regmap(component);\n\t\tsnd_soc_free_ac97_component(wm9713->ac97);\n\t}\n}\n\nstatic const struct snd_soc_component_driver soc_component_dev_wm9713 = {\n\t.probe\t\t\t= wm9713_soc_probe,\n\t.remove\t\t\t= wm9713_soc_remove,\n\t.suspend\t\t= wm9713_soc_suspend,\n\t.resume\t\t\t= wm9713_soc_resume,\n\t.set_bias_level\t\t= wm9713_set_bias_level,\n\t.controls\t\t= wm9713_snd_ac97_controls,\n\t.num_controls\t\t= ARRAY_SIZE(wm9713_snd_ac97_controls),\n\t.dapm_widgets\t\t= wm9713_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(wm9713_dapm_widgets),\n\t.dapm_routes\t\t= wm9713_audio_map,\n\t.num_dapm_routes\t= ARRAY_SIZE(wm9713_audio_map),\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic int wm9713_probe(struct platform_device *pdev)\n{\n\tstruct wm9713_priv *wm9713;\n\n\twm9713 = devm_kzalloc(&pdev->dev, sizeof(*wm9713), GFP_KERNEL);\n\tif (wm9713 == NULL)\n\t\treturn -ENOMEM;\n\n\tmutex_init(&wm9713->lock);\n\n\twm9713->mfd_pdata = dev_get_platdata(&pdev->dev);\n\tplatform_set_drvdata(pdev, wm9713);\n\n\treturn devm_snd_soc_register_component(&pdev->dev,\n\t\t\t&soc_component_dev_wm9713, wm9713_dai, ARRAY_SIZE(wm9713_dai));\n}\n\nstatic struct platform_driver wm9713_codec_driver = {\n\t.driver = {\n\t\t\t.name = \"wm9713-codec\",\n\t},\n\n\t.probe = wm9713_probe,\n};\n\nmodule_platform_driver(wm9713_codec_driver);\n\nMODULE_DESCRIPTION(\"ASoC WM9713/WM9714 driver\");\nMODULE_AUTHOR(\"Liam Girdwood\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}