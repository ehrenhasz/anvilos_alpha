{
  "module_name": "stac9766.c",
  "hash_id": "7f4bbd2be3f8459fbe16f6b47d1dc9c270636b68dff73086ebd4822e7424c5d0",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/stac9766.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/regmap.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/ac97_codec.h>\n#include <sound/initval.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/tlv.h>\n\n#define STAC9766_VENDOR_ID 0x83847666\n#define STAC9766_VENDOR_ID_MASK 0xffffffff\n\n#define AC97_STAC_DA_CONTROL 0x6A\n#define AC97_STAC_ANALOG_SPECIAL 0x6E\n#define AC97_STAC_STEREO_MIC 0x78\n\nstatic const struct reg_default stac9766_reg_defaults[] = {\n\t{ 0x02, 0x8000 },\n\t{ 0x04, 0x8000 },\n\t{ 0x06, 0x8000 },\n\t{ 0x0a, 0x0000 },\n\t{ 0x0c, 0x8008 },\n\t{ 0x0e, 0x8008 },\n\t{ 0x10, 0x8808 },\n\t{ 0x12, 0x8808 },\n\t{ 0x14, 0x8808 },\n\t{ 0x16, 0x8808 },\n\t{ 0x18, 0x8808 },\n\t{ 0x1a, 0x0000 },\n\t{ 0x1c, 0x8000 },\n\t{ 0x20, 0x0000 },\n\t{ 0x22, 0x0000 },\n\t{ 0x28, 0x0a05 },\n\t{ 0x2c, 0xbb80 },\n\t{ 0x32, 0xbb80 },\n\t{ 0x3a, 0x2000 },\n\t{ 0x3e, 0x0100 },\n\t{ 0x4c, 0x0300 },\n\t{ 0x4e, 0xffff },\n\t{ 0x50, 0x0000 },\n\t{ 0x52, 0x0000 },\n\t{ 0x54, 0x0000 },\n\t{ 0x6a, 0x0000 },\n\t{ 0x6e, 0x1000 },\n\t{ 0x72, 0x0000 },\n\t{ 0x78, 0x0000 },\n};\n\nstatic const struct regmap_config stac9766_regmap_config = {\n\t.reg_bits = 16,\n\t.reg_stride = 2,\n\t.val_bits = 16,\n\t.max_register = 0x78,\n\t.cache_type = REGCACHE_MAPLE,\n\n\t.volatile_reg = regmap_ac97_default_volatile,\n\n\t.reg_defaults = stac9766_reg_defaults,\n\t.num_reg_defaults = ARRAY_SIZE(stac9766_reg_defaults),\n};\n\nstatic const char *stac9766_record_mux[] = {\"Mic\", \"CD\", \"Video\", \"AUX\",\n\t\t\t\"Line\", \"Stereo Mix\", \"Mono Mix\", \"Phone\"};\nstatic const char *stac9766_mono_mux[] = {\"Mix\", \"Mic\"};\nstatic const char *stac9766_mic_mux[] = {\"Mic1\", \"Mic2\"};\nstatic const char *stac9766_SPDIF_mux[] = {\"PCM\", \"ADC Record\"};\nstatic const char *stac9766_popbypass_mux[] = {\"Normal\", \"Bypass Mixer\"};\nstatic const char *stac9766_record_all_mux[] = {\"All analog\",\n\t\"Analog plus DAC\"};\nstatic const char *stac9766_boost1[] = {\"0dB\", \"10dB\"};\nstatic const char *stac9766_boost2[] = {\"0dB\", \"20dB\"};\nstatic const char *stac9766_stereo_mic[] = {\"Off\", \"On\"};\n\nstatic SOC_ENUM_DOUBLE_DECL(stac9766_record_enum,\n\t\t\t    AC97_REC_SEL, 8, 0, stac9766_record_mux);\nstatic SOC_ENUM_SINGLE_DECL(stac9766_mono_enum,\n\t\t\t    AC97_GENERAL_PURPOSE, 9, stac9766_mono_mux);\nstatic SOC_ENUM_SINGLE_DECL(stac9766_mic_enum,\n\t\t\t    AC97_GENERAL_PURPOSE, 8, stac9766_mic_mux);\nstatic SOC_ENUM_SINGLE_DECL(stac9766_SPDIF_enum,\n\t\t\t    AC97_STAC_DA_CONTROL, 1, stac9766_SPDIF_mux);\nstatic SOC_ENUM_SINGLE_DECL(stac9766_popbypass_enum,\n\t\t\t    AC97_GENERAL_PURPOSE, 15, stac9766_popbypass_mux);\nstatic SOC_ENUM_SINGLE_DECL(stac9766_record_all_enum,\n\t\t\t    AC97_STAC_ANALOG_SPECIAL, 12,\n\t\t\t    stac9766_record_all_mux);\nstatic SOC_ENUM_SINGLE_DECL(stac9766_boost1_enum,\n\t\t\t    AC97_MIC, 6, stac9766_boost1);  \nstatic SOC_ENUM_SINGLE_DECL(stac9766_boost2_enum,\n\t\t\t    AC97_STAC_ANALOG_SPECIAL, 2, stac9766_boost2);  \nstatic SOC_ENUM_SINGLE_DECL(stac9766_stereo_mic_enum,\n\t\t\t    AC97_STAC_STEREO_MIC, 2, stac9766_stereo_mic);\n\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_SCALE(master_tlv, -4650, 150, 0);\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_SCALE(record_tlv,     0, 150, 0);\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_SCALE(beep_tlv,   -4500, 300, 0);\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_SCALE(mix_tlv,    -3450, 150, 0);\n\nstatic const struct snd_kcontrol_new stac9766_snd_ac97_controls[] = {\n\tSOC_DOUBLE_TLV(\"Speaker Volume\", AC97_MASTER, 8, 0, 31, 1, master_tlv),\n\tSOC_SINGLE(\"Speaker Switch\", AC97_MASTER, 15, 1, 1),\n\tSOC_DOUBLE_TLV(\"Headphone Volume\", AC97_HEADPHONE, 8, 0, 31, 1,\n\t\t       master_tlv),\n\tSOC_SINGLE(\"Headphone Switch\", AC97_HEADPHONE, 15, 1, 1),\n\tSOC_SINGLE_TLV(\"Mono Out Volume\", AC97_MASTER_MONO, 0, 31, 1,\n\t\t       master_tlv),\n\tSOC_SINGLE(\"Mono Out Switch\", AC97_MASTER_MONO, 15, 1, 1),\n\n\tSOC_DOUBLE_TLV(\"Record Volume\", AC97_REC_GAIN, 8, 0, 15, 0, record_tlv),\n\tSOC_SINGLE(\"Record Switch\", AC97_REC_GAIN, 15, 1, 1),\n\n\n\tSOC_SINGLE_TLV(\"Beep Volume\", AC97_PC_BEEP, 1, 15, 1, beep_tlv),\n\tSOC_SINGLE(\"Beep Switch\", AC97_PC_BEEP, 15, 1, 1),\n\tSOC_SINGLE(\"Beep Frequency\", AC97_PC_BEEP, 5, 127, 1),\n\tSOC_SINGLE_TLV(\"Phone Volume\", AC97_PHONE, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"Phone Switch\", AC97_PHONE, 15, 1, 1),\n\n\tSOC_ENUM(\"Mic Boost1\", stac9766_boost1_enum),\n\tSOC_ENUM(\"Mic Boost2\", stac9766_boost2_enum),\n\tSOC_SINGLE_TLV(\"Mic Volume\", AC97_MIC, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"Mic Switch\", AC97_MIC, 15, 1, 1),\n\tSOC_ENUM(\"Stereo Mic\", stac9766_stereo_mic_enum),\n\n\tSOC_DOUBLE_TLV(\"Line Volume\", AC97_LINE, 8, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"Line Switch\", AC97_LINE, 15, 1, 1),\n\tSOC_DOUBLE_TLV(\"CD Volume\", AC97_CD, 8, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"CD Switch\", AC97_CD, 15, 1, 1),\n\tSOC_DOUBLE_TLV(\"AUX Volume\", AC97_AUX, 8, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"AUX Switch\", AC97_AUX, 15, 1, 1),\n\tSOC_DOUBLE_TLV(\"Video Volume\", AC97_VIDEO, 8, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"Video Switch\", AC97_VIDEO, 15, 1, 1),\n\n\tSOC_DOUBLE_TLV(\"DAC Volume\", AC97_PCM, 8, 0, 31, 1, mix_tlv),\n\tSOC_SINGLE(\"DAC Switch\", AC97_PCM, 15, 1, 1),\n\tSOC_SINGLE(\"Loopback Test Switch\", AC97_GENERAL_PURPOSE, 7, 1, 0),\n\tSOC_SINGLE(\"3D Volume\", AC97_3D_CONTROL, 3, 2, 1),\n\tSOC_SINGLE(\"3D Switch\", AC97_GENERAL_PURPOSE, 13, 1, 0),\n\n\tSOC_ENUM(\"SPDIF Mux\", stac9766_SPDIF_enum),\n\tSOC_ENUM(\"Mic1/2 Mux\", stac9766_mic_enum),\n\tSOC_ENUM(\"Record All Mux\", stac9766_record_all_enum),\n\tSOC_ENUM(\"Record Mux\", stac9766_record_enum),\n\tSOC_ENUM(\"Mono Mux\", stac9766_mono_enum),\n\tSOC_ENUM(\"Pop Bypass Mux\", stac9766_popbypass_enum),\n};\n\nstatic int ac97_analog_prepare(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tunsigned short reg;\n\n\t \n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_STATUS, 0x5, 0x1);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\treg = AC97_PCM_FRONT_DAC_RATE;\n\telse\n\t\treg = AC97_PCM_LR_ADC_RATE;\n\n\treturn snd_soc_component_write(component, reg, runtime->rate);\n}\n\nstatic int ac97_digital_prepare(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tunsigned short reg;\n\n\tsnd_soc_component_write(component, AC97_SPDIF, 0x2002);\n\n\t \n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_STATUS, 0x5, 0x5);\n\n\treg = AC97_PCM_FRONT_DAC_RATE;\n\n\treturn snd_soc_component_write(component, reg, runtime->rate);\n}\n\nstatic int stac9766_set_bias_level(struct snd_soc_component *component,\n\t\t\t\t   enum snd_soc_bias_level level)\n{\n\tswitch (level) {\n\tcase SND_SOC_BIAS_ON:  \n\tcase SND_SOC_BIAS_PREPARE:  \n\tcase SND_SOC_BIAS_STANDBY:  \n\t\tsnd_soc_component_write(component, AC97_POWERDOWN, 0x0000);\n\t\tbreak;\n\tcase SND_SOC_BIAS_OFF:  \n\t\t \n\t\tsnd_soc_component_write(component, AC97_POWERDOWN, 0xffff);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int stac9766_component_resume(struct snd_soc_component *component)\n{\n\tstruct snd_ac97 *ac97 = snd_soc_component_get_drvdata(component);\n\n\treturn snd_ac97_reset(ac97, true, STAC9766_VENDOR_ID,\n\t\tSTAC9766_VENDOR_ID_MASK);\n}\n\nstatic const struct snd_soc_dai_ops stac9766_dai_ops_analog = {\n\t.prepare = ac97_analog_prepare,\n};\n\nstatic const struct snd_soc_dai_ops stac9766_dai_ops_digital = {\n\t.prepare = ac97_digital_prepare,\n};\n\nstatic struct snd_soc_dai_driver stac9766_dai[] = {\n{\n\t.name = \"stac9766-hifi-analog\",\n\n\t \n\t.playback = {\n\t\t.stream_name = \"stac9766 analog\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t.formats = SND_SOC_STD_AC97_FMTS,\n\t},\n\t.capture = {\n\t\t.stream_name = \"stac9766 analog\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t.formats = SND_SOC_STD_AC97_FMTS,\n\t},\n\t \n\t.ops = &stac9766_dai_ops_analog,\n},\n{\n\t.name = \"stac9766-hifi-IEC958\",\n\n\t \n\t.playback = {\n\t\t.stream_name = \"stac9766 IEC958\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_32000 | \\\n\t\t\tSNDRV_PCM_RATE_44100 | SNDRV_PCM_RATE_48000,\n\t\t.formats = SNDRV_PCM_FMTBIT_IEC958_SUBFRAME_BE,\n\t},\n\t \n\t.ops = &stac9766_dai_ops_digital,\n}\n};\n\nstatic int stac9766_component_probe(struct snd_soc_component *component)\n{\n\tstruct snd_ac97 *ac97;\n\tstruct regmap *regmap;\n\tint ret;\n\n\tac97 = snd_soc_new_ac97_component(component, STAC9766_VENDOR_ID,\n\t\t\tSTAC9766_VENDOR_ID_MASK);\n\tif (IS_ERR(ac97))\n\t\treturn PTR_ERR(ac97);\n\n\tregmap = regmap_init_ac97(ac97, &stac9766_regmap_config);\n\tif (IS_ERR(regmap)) {\n\t\tret = PTR_ERR(regmap);\n\t\tgoto err_free_ac97;\n\t}\n\n\tsnd_soc_component_init_regmap(component, regmap);\n\tsnd_soc_component_set_drvdata(component, ac97);\n\n\treturn 0;\nerr_free_ac97:\n\tsnd_soc_free_ac97_component(ac97);\n\treturn ret;\n}\n\nstatic void stac9766_component_remove(struct snd_soc_component *component)\n{\n\tstruct snd_ac97 *ac97 = snd_soc_component_get_drvdata(component);\n\n\tsnd_soc_component_exit_regmap(component);\n\tsnd_soc_free_ac97_component(ac97);\n}\n\nstatic const struct snd_soc_component_driver soc_component_dev_stac9766 = {\n\t.controls\t\t= stac9766_snd_ac97_controls,\n\t.num_controls\t\t= ARRAY_SIZE(stac9766_snd_ac97_controls),\n\t.set_bias_level\t\t= stac9766_set_bias_level,\n\t.probe\t\t\t= stac9766_component_probe,\n\t.remove\t\t\t= stac9766_component_remove,\n\t.resume\t\t\t= stac9766_component_resume,\n\t.suspend_bias_off\t= 1,\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic int stac9766_probe(struct platform_device *pdev)\n{\n\treturn devm_snd_soc_register_component(&pdev->dev,\n\t\t\t&soc_component_dev_stac9766, stac9766_dai, ARRAY_SIZE(stac9766_dai));\n}\n\nstatic struct platform_driver stac9766_codec_driver = {\n\t.driver = {\n\t\t\t.name = \"stac9766-codec\",\n\t},\n\n\t.probe = stac9766_probe,\n};\n\nmodule_platform_driver(stac9766_codec_driver);\n\nMODULE_DESCRIPTION(\"ASoC stac9766 driver\");\nMODULE_AUTHOR(\"Jon Smirl <jonsmirl@gmail.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}