{
  "module_name": "jz4740.c",
  "hash_id": "a86a027c70b5820acff44f767c6b606b5cdb1c14e721f25005fc8d8d50a548df",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/jz4740.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/regmap.h>\n\n#include <linux/delay.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/initval.h>\n#include <sound/soc.h>\n#include <sound/tlv.h>\n\n#define JZ4740_REG_CODEC_1 0x0\n#define JZ4740_REG_CODEC_2 0x4\n\n#define JZ4740_CODEC_1_LINE_ENABLE BIT(29)\n#define JZ4740_CODEC_1_MIC_ENABLE BIT(28)\n#define JZ4740_CODEC_1_SW1_ENABLE BIT(27)\n#define JZ4740_CODEC_1_ADC_ENABLE BIT(26)\n#define JZ4740_CODEC_1_SW2_ENABLE BIT(25)\n#define JZ4740_CODEC_1_DAC_ENABLE BIT(24)\n#define JZ4740_CODEC_1_VREF_DISABLE BIT(20)\n#define JZ4740_CODEC_1_VREF_AMP_DISABLE BIT(19)\n#define JZ4740_CODEC_1_VREF_PULLDOWN BIT(18)\n#define JZ4740_CODEC_1_VREF_LOW_CURRENT BIT(17)\n#define JZ4740_CODEC_1_VREF_HIGH_CURRENT BIT(16)\n#define JZ4740_CODEC_1_HEADPHONE_DISABLE BIT(14)\n#define JZ4740_CODEC_1_HEADPHONE_AMP_CHANGE_ANY BIT(13)\n#define JZ4740_CODEC_1_HEADPHONE_CHARGE BIT(12)\n#define JZ4740_CODEC_1_HEADPHONE_PULLDOWN (BIT(11) | BIT(10))\n#define JZ4740_CODEC_1_HEADPHONE_POWERDOWN_M BIT(9)\n#define JZ4740_CODEC_1_HEADPHONE_POWERDOWN BIT(8)\n#define JZ4740_CODEC_1_SUSPEND BIT(1)\n#define JZ4740_CODEC_1_RESET BIT(0)\n\n#define JZ4740_CODEC_1_LINE_ENABLE_OFFSET 29\n#define JZ4740_CODEC_1_MIC_ENABLE_OFFSET 28\n#define JZ4740_CODEC_1_SW1_ENABLE_OFFSET 27\n#define JZ4740_CODEC_1_ADC_ENABLE_OFFSET 26\n#define JZ4740_CODEC_1_SW2_ENABLE_OFFSET 25\n#define JZ4740_CODEC_1_DAC_ENABLE_OFFSET 24\n#define JZ4740_CODEC_1_HEADPHONE_DISABLE_OFFSET 14\n#define JZ4740_CODEC_1_HEADPHONE_POWERDOWN_OFFSET 8\n\n#define JZ4740_CODEC_2_INPUT_VOLUME_MASK\t\t0x1f0000\n#define JZ4740_CODEC_2_SAMPLE_RATE_MASK\t\t\t0x000f00\n#define JZ4740_CODEC_2_MIC_BOOST_GAIN_MASK\t\t0x000030\n#define JZ4740_CODEC_2_HEADPHONE_VOLUME_MASK\t0x000003\n\n#define JZ4740_CODEC_2_INPUT_VOLUME_OFFSET\t\t16\n#define JZ4740_CODEC_2_SAMPLE_RATE_OFFSET\t\t 8\n#define JZ4740_CODEC_2_MIC_BOOST_GAIN_OFFSET\t 4\n#define JZ4740_CODEC_2_HEADPHONE_VOLUME_OFFSET\t 0\n\nstatic const struct reg_default jz4740_codec_reg_defaults[] = {\n\t{ JZ4740_REG_CODEC_1, 0x021b2302 },\n\t{ JZ4740_REG_CODEC_2, 0x00170803 },\n};\n\nstruct jz4740_codec {\n\tstruct regmap *regmap;\n};\n\nstatic const DECLARE_TLV_DB_RANGE(jz4740_mic_tlv,\n\t0, 2, TLV_DB_SCALE_ITEM(0, 600, 0),\n\t3, 3, TLV_DB_SCALE_ITEM(2000, 0, 0)\n);\n\nstatic const DECLARE_TLV_DB_SCALE(jz4740_out_tlv, 0, 200, 0);\nstatic const DECLARE_TLV_DB_SCALE(jz4740_in_tlv, -3450, 150, 0);\n\nstatic const struct snd_kcontrol_new jz4740_codec_controls[] = {\n\tSOC_SINGLE_TLV(\"Master Playback Volume\", JZ4740_REG_CODEC_2,\n\t\t\tJZ4740_CODEC_2_HEADPHONE_VOLUME_OFFSET, 3, 0,\n\t\t\tjz4740_out_tlv),\n\tSOC_SINGLE_TLV(\"Master Capture Volume\", JZ4740_REG_CODEC_2,\n\t\t\tJZ4740_CODEC_2_INPUT_VOLUME_OFFSET, 31, 0,\n\t\t\tjz4740_in_tlv),\n\tSOC_SINGLE(\"Master Playback Switch\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_HEADPHONE_DISABLE_OFFSET, 1, 1),\n\tSOC_SINGLE_TLV(\"Mic Capture Volume\", JZ4740_REG_CODEC_2,\n\t\t\tJZ4740_CODEC_2_MIC_BOOST_GAIN_OFFSET, 3, 0,\n\t\t\tjz4740_mic_tlv),\n};\n\nstatic const struct snd_kcontrol_new jz4740_codec_output_controls[] = {\n\tSOC_DAPM_SINGLE(\"Bypass Switch\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_SW1_ENABLE_OFFSET, 1, 0),\n\tSOC_DAPM_SINGLE(\"DAC Switch\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_SW2_ENABLE_OFFSET, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new jz4740_codec_input_controls[] = {\n\tSOC_DAPM_SINGLE(\"Line Capture Switch\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_LINE_ENABLE_OFFSET, 1, 0),\n\tSOC_DAPM_SINGLE(\"Mic Capture Switch\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_MIC_ENABLE_OFFSET, 1, 0),\n};\n\nstatic const struct snd_soc_dapm_widget jz4740_codec_dapm_widgets[] = {\n\tSND_SOC_DAPM_ADC(\"ADC\", \"Capture\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_ADC_ENABLE_OFFSET, 0),\n\tSND_SOC_DAPM_DAC(\"DAC\", \"Playback\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_DAC_ENABLE_OFFSET, 0),\n\n\tSND_SOC_DAPM_MIXER(\"Output Mixer\", JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_HEADPHONE_POWERDOWN_OFFSET, 1,\n\t\t\tjz4740_codec_output_controls,\n\t\t\tARRAY_SIZE(jz4740_codec_output_controls)),\n\n\tSND_SOC_DAPM_MIXER_NAMED_CTL(\"Input Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t\tjz4740_codec_input_controls,\n\t\t\tARRAY_SIZE(jz4740_codec_input_controls)),\n\tSND_SOC_DAPM_MIXER(\"Line Input\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_OUTPUT(\"LOUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ROUT\"),\n\n\tSND_SOC_DAPM_INPUT(\"MIC\"),\n\tSND_SOC_DAPM_INPUT(\"LIN\"),\n\tSND_SOC_DAPM_INPUT(\"RIN\"),\n};\n\nstatic const struct snd_soc_dapm_route jz4740_codec_dapm_routes[] = {\n\t{\"Line Input\", NULL, \"LIN\"},\n\t{\"Line Input\", NULL, \"RIN\"},\n\n\t{\"Input Mixer\", \"Line Capture Switch\", \"Line Input\"},\n\t{\"Input Mixer\", \"Mic Capture Switch\", \"MIC\"},\n\n\t{\"ADC\", NULL, \"Input Mixer\"},\n\n\t{\"Output Mixer\", \"Bypass Switch\", \"Input Mixer\"},\n\t{\"Output Mixer\", \"DAC Switch\", \"DAC\"},\n\n\t{\"LOUT\", NULL, \"Output Mixer\"},\n\t{\"ROUT\", NULL, \"Output Mixer\"},\n};\n\nstatic int jz4740_codec_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\n{\n\tstruct jz4740_codec *jz4740_codec = snd_soc_component_get_drvdata(dai->component);\n\tuint32_t val;\n\n\tswitch (params_rate(params)) {\n\tcase 8000:\n\t\tval = 0;\n\t\tbreak;\n\tcase 11025:\n\t\tval = 1;\n\t\tbreak;\n\tcase 12000:\n\t\tval = 2;\n\t\tbreak;\n\tcase 16000:\n\t\tval = 3;\n\t\tbreak;\n\tcase 22050:\n\t\tval = 4;\n\t\tbreak;\n\tcase 24000:\n\t\tval = 5;\n\t\tbreak;\n\tcase 32000:\n\t\tval = 6;\n\t\tbreak;\n\tcase 44100:\n\t\tval = 7;\n\t\tbreak;\n\tcase 48000:\n\t\tval = 8;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tval <<= JZ4740_CODEC_2_SAMPLE_RATE_OFFSET;\n\n\tregmap_update_bits(jz4740_codec->regmap, JZ4740_REG_CODEC_2,\n\t\t\t\tJZ4740_CODEC_2_SAMPLE_RATE_MASK, val);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops jz4740_codec_dai_ops = {\n\t.hw_params = jz4740_codec_hw_params,\n};\n\nstatic struct snd_soc_dai_driver jz4740_codec_dai = {\n\t.name = \"jz4740-hifi\",\n\t.playback = {\n\t\t.stream_name = \"Playback\",\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S8,\n\t},\n\t.capture = {\n\t\t.stream_name = \"Capture\",\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S8,\n\t},\n\t.ops = &jz4740_codec_dai_ops,\n\t.symmetric_rate = 1,\n};\n\nstatic void jz4740_codec_wakeup(struct regmap *regmap)\n{\n\tregmap_set_bits(regmap, JZ4740_REG_CODEC_1, JZ4740_CODEC_1_RESET);\n\tudelay(2);\n\n\tregmap_clear_bits(regmap, JZ4740_REG_CODEC_1,\n\t\t\t  JZ4740_CODEC_1_SUSPEND | JZ4740_CODEC_1_RESET);\n\n\tregcache_sync(regmap);\n}\n\nstatic int jz4740_codec_set_bias_level(struct snd_soc_component *component,\n\tenum snd_soc_bias_level level)\n{\n\tstruct jz4740_codec *jz4740_codec = snd_soc_component_get_drvdata(component);\n\tstruct regmap *regmap = jz4740_codec->regmap;\n\tunsigned int mask;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_ON:\n\t\tbreak;\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tmask = JZ4740_CODEC_1_VREF_DISABLE |\n\t\t\t\tJZ4740_CODEC_1_VREF_AMP_DISABLE |\n\t\t\t\tJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\n\n\t\tregmap_clear_bits(regmap, JZ4740_REG_CODEC_1, mask);\n\t\tbreak;\n\tcase SND_SOC_BIAS_STANDBY:\n\t\t \n\t\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF)\n\t\t\tjz4740_codec_wakeup(regmap);\n\n\t\tmask = JZ4740_CODEC_1_VREF_DISABLE |\n\t\t\tJZ4740_CODEC_1_VREF_AMP_DISABLE |\n\t\t\tJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\n\n\t\tregmap_set_bits(regmap, JZ4740_REG_CODEC_1, mask);\n\t\tbreak;\n\tcase SND_SOC_BIAS_OFF:\n\t\tmask = JZ4740_CODEC_1_SUSPEND;\n\t\tregmap_set_bits(regmap, JZ4740_REG_CODEC_1, mask);\n\t\tregcache_mark_dirty(regmap);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int jz4740_codec_dev_probe(struct snd_soc_component *component)\n{\n\tstruct jz4740_codec *jz4740_codec = snd_soc_component_get_drvdata(component);\n\n\tregmap_update_bits(jz4740_codec->regmap, JZ4740_REG_CODEC_1,\n\t\t\tJZ4740_CODEC_1_SW2_ENABLE, JZ4740_CODEC_1_SW2_ENABLE);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver soc_codec_dev_jz4740_codec = {\n\t.probe\t\t\t= jz4740_codec_dev_probe,\n\t.set_bias_level\t\t= jz4740_codec_set_bias_level,\n\t.controls\t\t= jz4740_codec_controls,\n\t.num_controls\t\t= ARRAY_SIZE(jz4740_codec_controls),\n\t.dapm_widgets\t\t= jz4740_codec_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(jz4740_codec_dapm_widgets),\n\t.dapm_routes\t\t= jz4740_codec_dapm_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(jz4740_codec_dapm_routes),\n\t.suspend_bias_off\t= 1,\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic const struct regmap_config jz4740_codec_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.max_register = JZ4740_REG_CODEC_2,\n\n\t.reg_defaults = jz4740_codec_reg_defaults,\n\t.num_reg_defaults = ARRAY_SIZE(jz4740_codec_reg_defaults),\n\t.cache_type = REGCACHE_MAPLE,\n};\n\nstatic int jz4740_codec_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tstruct jz4740_codec *jz4740_codec;\n\tvoid __iomem *base;\n\n\tjz4740_codec = devm_kzalloc(&pdev->dev, sizeof(*jz4740_codec),\n\t\t\t\t    GFP_KERNEL);\n\tif (!jz4740_codec)\n\t\treturn -ENOMEM;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tjz4740_codec->regmap = devm_regmap_init_mmio(&pdev->dev, base,\n\t\t\t\t\t    &jz4740_codec_regmap_config);\n\tif (IS_ERR(jz4740_codec->regmap))\n\t\treturn PTR_ERR(jz4740_codec->regmap);\n\n\tplatform_set_drvdata(pdev, jz4740_codec);\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t&soc_codec_dev_jz4740_codec, &jz4740_codec_dai, 1);\n\tif (ret)\n\t\tdev_err(&pdev->dev, \"Failed to register codec\\n\");\n\n\treturn ret;\n}\n\nstatic const struct of_device_id jz4740_codec_of_matches[] = {\n\t{ .compatible = \"ingenic,jz4740-codec\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, jz4740_codec_of_matches);\n\nstatic struct platform_driver jz4740_codec_driver = {\n\t.probe = jz4740_codec_probe,\n\t.driver = {\n\t\t.name = \"jz4740-codec\",\n\t\t.of_match_table = jz4740_codec_of_matches,\n\t},\n};\n\nmodule_platform_driver(jz4740_codec_driver);\n\nMODULE_DESCRIPTION(\"JZ4740 SoC internal codec driver\");\nMODULE_AUTHOR(\"Lars-Peter Clausen <lars@metafoo.de>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:jz4740-codec\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}