{
  "module_name": "lpass-wsa-macro.c",
  "hash_id": "415f9625429ac0d3a1dacfa5f08f2c7c36f85d1106fec27774eb8fe8cde35b9c",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/lpass-wsa-macro.c",
  "human_readable_source": "\n\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/clk.h>\n#include <linux/of_clk.h>\n#include <linux/clk-provider.h>\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <linux/pm_runtime.h>\n#include <linux/of_platform.h>\n#include <sound/tlv.h>\n\n#include \"lpass-macro-common.h\"\n#include \"lpass-wsa-macro.h\"\n\n#define CDC_WSA_CLK_RST_CTRL_MCLK_CONTROL\t(0x0000)\n#define CDC_WSA_MCLK_EN_MASK\t\t\tBIT(0)\n#define CDC_WSA_MCLK_ENABLE\t\t\tBIT(0)\n#define CDC_WSA_MCLK_DISABLE\t\t\t0\n#define CDC_WSA_CLK_RST_CTRL_FS_CNT_CONTROL\t(0x0004)\n#define CDC_WSA_FS_CNT_EN_MASK\t\t\tBIT(0)\n#define CDC_WSA_FS_CNT_ENABLE\t\t\tBIT(0)\n#define CDC_WSA_FS_CNT_DISABLE\t\t\t0\n#define CDC_WSA_CLK_RST_CTRL_SWR_CONTROL\t(0x0008)\n#define CDC_WSA_SWR_CLK_EN_MASK\t\t\tBIT(0)\n#define CDC_WSA_SWR_CLK_ENABLE\t\t\tBIT(0)\n#define CDC_WSA_SWR_RST_EN_MASK\t\t\tBIT(1)\n#define CDC_WSA_SWR_RST_ENABLE\t\t\tBIT(1)\n#define CDC_WSA_SWR_RST_DISABLE\t\t\t0\n#define CDC_WSA_TOP_TOP_CFG0\t\t\t(0x0080)\n#define CDC_WSA_TOP_TOP_CFG1\t\t\t(0x0084)\n#define CDC_WSA_TOP_FREQ_MCLK\t\t\t(0x0088)\n#define CDC_WSA_TOP_DEBUG_BUS_SEL\t\t(0x008C)\n#define CDC_WSA_TOP_DEBUG_EN0\t\t\t(0x0090)\n#define CDC_WSA_TOP_DEBUG_EN1\t\t\t(0x0094)\n#define CDC_WSA_TOP_DEBUG_DSM_LB\t\t(0x0098)\n#define CDC_WSA_TOP_RX_I2S_CTL\t\t\t(0x009C)\n#define CDC_WSA_TOP_TX_I2S_CTL\t\t\t(0x00A0)\n#define CDC_WSA_TOP_I2S_CLK\t\t\t(0x00A4)\n#define CDC_WSA_TOP_I2S_RESET\t\t\t(0x00A8)\n#define CDC_WSA_RX_INP_MUX_RX_INT0_CFG0\t\t(0x0100)\n#define CDC_WSA_RX_INTX_1_MIX_INP0_SEL_MASK\tGENMASK(2, 0)\n#define CDC_WSA_RX_INTX_1_MIX_INP1_SEL_MASK\tGENMASK(5, 3)\n#define CDC_WSA_RX_INP_MUX_RX_INT0_CFG1\t\t(0x0104)\n#define CDC_WSA_RX_INTX_2_SEL_MASK\t\tGENMASK(2, 0)\n#define CDC_WSA_RX_INTX_1_MIX_INP2_SEL_MASK\tGENMASK(5, 3)\n#define CDC_WSA_RX_INP_MUX_RX_INT1_CFG0\t\t(0x0108)\n#define CDC_WSA_RX_INP_MUX_RX_INT1_CFG1\t\t(0x010C)\n#define CDC_WSA_RX_INP_MUX_RX_MIX_CFG0\t\t(0x0110)\n#define CDC_WSA_RX_MIX_TX1_SEL_MASK\t\tGENMASK(5, 3)\n#define CDC_WSA_RX_MIX_TX1_SEL_SHFT\t\t3\n#define CDC_WSA_RX_MIX_TX0_SEL_MASK\t\tGENMASK(2, 0)\n#define CDC_WSA_RX_INP_MUX_RX_EC_CFG0\t\t(0x0114)\n#define CDC_WSA_RX_INP_MUX_SOFTCLIP_CFG0\t(0x0118)\n#define CDC_WSA_TX0_SPKR_PROT_PATH_CTL\t\t(0x0244)\n#define CDC_WSA_TX_SPKR_PROT_RESET_MASK\t\tBIT(5)\n#define CDC_WSA_TX_SPKR_PROT_RESET\t\tBIT(5)\n#define CDC_WSA_TX_SPKR_PROT_NO_RESET\t\t0\n#define CDC_WSA_TX_SPKR_PROT_CLK_EN_MASK\tBIT(4)\n#define CDC_WSA_TX_SPKR_PROT_CLK_ENABLE\t\tBIT(4)\n#define CDC_WSA_TX_SPKR_PROT_CLK_DISABLE\t0\n#define CDC_WSA_TX_SPKR_PROT_PCM_RATE_MASK\tGENMASK(3, 0)\n#define CDC_WSA_TX_SPKR_PROT_PCM_RATE_8K\t0\n#define CDC_WSA_TX0_SPKR_PROT_PATH_CFG0\t\t(0x0248)\n#define CDC_WSA_TX1_SPKR_PROT_PATH_CTL\t\t(0x0264)\n#define CDC_WSA_TX1_SPKR_PROT_PATH_CFG0\t\t(0x0268)\n#define CDC_WSA_TX2_SPKR_PROT_PATH_CTL\t\t(0x0284)\n#define CDC_WSA_TX2_SPKR_PROT_PATH_CFG0\t\t(0x0288)\n#define CDC_WSA_TX3_SPKR_PROT_PATH_CTL\t\t(0x02A4)\n#define CDC_WSA_TX3_SPKR_PROT_PATH_CFG0\t\t(0x02A8)\n#define CDC_WSA_INTR_CTRL_CFG\t\t\t(0x0340)\n#define CDC_WSA_INTR_CTRL_CLR_COMMIT\t\t(0x0344)\n#define CDC_WSA_INTR_CTRL_PIN1_MASK0\t\t(0x0360)\n#define CDC_WSA_INTR_CTRL_PIN1_STATUS0\t\t(0x0368)\n#define CDC_WSA_INTR_CTRL_PIN1_CLEAR0\t\t(0x0370)\n#define CDC_WSA_INTR_CTRL_PIN2_MASK0\t\t(0x0380)\n#define CDC_WSA_INTR_CTRL_PIN2_STATUS0\t\t(0x0388)\n#define CDC_WSA_INTR_CTRL_PIN2_CLEAR0\t\t(0x0390)\n#define CDC_WSA_INTR_CTRL_LEVEL0\t\t(0x03C0)\n#define CDC_WSA_INTR_CTRL_BYPASS0\t\t(0x03C8)\n#define CDC_WSA_INTR_CTRL_SET0\t\t\t(0x03D0)\n#define CDC_WSA_RX0_RX_PATH_CTL\t\t\t(0x0400)\n#define CDC_WSA_RX_PATH_CLK_EN_MASK\t\tBIT(5)\n#define CDC_WSA_RX_PATH_CLK_ENABLE\t\tBIT(5)\n#define CDC_WSA_RX_PATH_CLK_DISABLE\t\t0\n#define CDC_WSA_RX_PATH_PGA_MUTE_EN_MASK\tBIT(4)\n#define CDC_WSA_RX_PATH_PGA_MUTE_ENABLE\t\tBIT(4)\n#define CDC_WSA_RX_PATH_PGA_MUTE_DISABLE\t0\n#define CDC_WSA_RX0_RX_PATH_CFG0\t\t(0x0404)\n#define CDC_WSA_RX_PATH_COMP_EN_MASK\t\tBIT(1)\n#define CDC_WSA_RX_PATH_COMP_ENABLE\t\tBIT(1)\n#define CDC_WSA_RX_PATH_HD2_EN_MASK\t\tBIT(2)\n#define CDC_WSA_RX_PATH_HD2_ENABLE\t\tBIT(2)\n#define CDC_WSA_RX_PATH_SPKR_RATE_MASK\t\tBIT(3)\n#define CDC_WSA_RX_PATH_SPKR_RATE_FS_2P4_3P072\tBIT(3)\n#define CDC_WSA_RX0_RX_PATH_CFG1\t\t(0x0408)\n#define CDC_WSA_RX_PATH_SMART_BST_EN_MASK\tBIT(0)\n#define CDC_WSA_RX_PATH_SMART_BST_ENABLE\tBIT(0)\n#define CDC_WSA_RX_PATH_SMART_BST_DISABLE\t0\n#define CDC_WSA_RX0_RX_PATH_CFG2\t\t(0x040C)\n#define CDC_WSA_RX0_RX_PATH_CFG3\t\t(0x0410)\n#define CDC_WSA_RX_DC_DCOEFF_MASK\t\tGENMASK(1, 0)\n#define CDC_WSA_RX0_RX_VOL_CTL\t\t\t(0x0414)\n#define CDC_WSA_RX0_RX_PATH_MIX_CTL\t\t(0x0418)\n#define CDC_WSA_RX_PATH_MIX_CLK_EN_MASK\t\tBIT(5)\n#define CDC_WSA_RX_PATH_MIX_CLK_ENABLE\t\tBIT(5)\n#define CDC_WSA_RX_PATH_MIX_CLK_DISABLE\t\t0\n#define CDC_WSA_RX0_RX_PATH_MIX_CFG\t\t(0x041C)\n#define CDC_WSA_RX0_RX_VOL_MIX_CTL\t\t(0x0420)\n#define CDC_WSA_RX0_RX_PATH_SEC0\t\t(0x0424)\n#define CDC_WSA_RX0_RX_PATH_SEC1\t\t(0x0428)\n#define CDC_WSA_RX_PGA_HALF_DB_MASK\t\tBIT(0)\n#define CDC_WSA_RX_PGA_HALF_DB_ENABLE\t\tBIT(0)\n#define CDC_WSA_RX_PGA_HALF_DB_DISABLE\t\t0\n#define CDC_WSA_RX0_RX_PATH_SEC2\t\t(0x042C)\n#define CDC_WSA_RX0_RX_PATH_SEC3\t\t(0x0430)\n#define CDC_WSA_RX_PATH_HD2_SCALE_MASK\t\tGENMASK(1, 0)\n#define CDC_WSA_RX_PATH_HD2_ALPHA_MASK\t\tGENMASK(5, 2)\n#define CDC_WSA_RX0_RX_PATH_SEC5\t\t(0x0438)\n#define CDC_WSA_RX0_RX_PATH_SEC6\t\t(0x043C)\n#define CDC_WSA_RX0_RX_PATH_SEC7\t\t(0x0440)\n#define CDC_WSA_RX0_RX_PATH_MIX_SEC0\t\t(0x0444)\n#define CDC_WSA_RX0_RX_PATH_MIX_SEC1\t\t(0x0448)\n#define CDC_WSA_RX0_RX_PATH_DSMDEM_CTL\t\t(0x044C)\n#define CDC_WSA_RX_DSMDEM_CLK_EN_MASK\t\tBIT(0)\n#define CDC_WSA_RX_DSMDEM_CLK_ENABLE\t\tBIT(0)\n#define CDC_WSA_RX1_RX_PATH_CTL\t\t\t(0x0480)\n#define CDC_WSA_RX1_RX_PATH_CFG0\t\t(0x0484)\n#define CDC_WSA_RX1_RX_PATH_CFG1\t\t(0x0488)\n#define CDC_WSA_RX1_RX_PATH_CFG2\t\t(0x048C)\n#define CDC_WSA_RX1_RX_PATH_CFG3\t\t(0x0490)\n#define CDC_WSA_RX1_RX_VOL_CTL\t\t\t(0x0494)\n#define CDC_WSA_RX1_RX_PATH_MIX_CTL\t\t(0x0498)\n#define CDC_WSA_RX1_RX_PATH_MIX_CFG\t\t(0x049C)\n#define CDC_WSA_RX1_RX_VOL_MIX_CTL\t\t(0x04A0)\n#define CDC_WSA_RX1_RX_PATH_SEC0\t\t(0x04A4)\n#define CDC_WSA_RX1_RX_PATH_SEC1\t\t(0x04A8)\n#define CDC_WSA_RX1_RX_PATH_SEC2\t\t(0x04AC)\n#define CDC_WSA_RX1_RX_PATH_SEC3\t\t(0x04B0)\n#define CDC_WSA_RX1_RX_PATH_SEC5\t\t(0x04B8)\n#define CDC_WSA_RX1_RX_PATH_SEC6\t\t(0x04BC)\n#define CDC_WSA_RX1_RX_PATH_SEC7\t\t(0x04C0)\n#define CDC_WSA_RX1_RX_PATH_MIX_SEC0\t\t(0x04C4)\n#define CDC_WSA_RX1_RX_PATH_MIX_SEC1\t\t(0x04C8)\n#define CDC_WSA_RX1_RX_PATH_DSMDEM_CTL\t\t(0x04CC)\n#define CDC_WSA_BOOST0_BOOST_PATH_CTL\t\t(0x0500)\n#define CDC_WSA_BOOST_PATH_CLK_EN_MASK\t\tBIT(4)\n#define CDC_WSA_BOOST_PATH_CLK_ENABLE\t\tBIT(4)\n#define CDC_WSA_BOOST_PATH_CLK_DISABLE\t\t0\n#define CDC_WSA_BOOST0_BOOST_CTL\t\t(0x0504)\n#define CDC_WSA_BOOST0_BOOST_CFG1\t\t(0x0508)\n#define CDC_WSA_BOOST0_BOOST_CFG2\t\t(0x050C)\n#define CDC_WSA_BOOST1_BOOST_PATH_CTL\t\t(0x0540)\n#define CDC_WSA_BOOST1_BOOST_CTL\t\t(0x0544)\n#define CDC_WSA_BOOST1_BOOST_CFG1\t\t(0x0548)\n#define CDC_WSA_BOOST1_BOOST_CFG2\t\t(0x054C)\n#define CDC_WSA_COMPANDER0_CTL0\t\t\t(0x0580)\n#define CDC_WSA_COMPANDER_CLK_EN_MASK\t\tBIT(0)\n#define CDC_WSA_COMPANDER_CLK_ENABLE\t\tBIT(0)\n#define CDC_WSA_COMPANDER_SOFT_RST_MASK\t\tBIT(1)\n#define CDC_WSA_COMPANDER_SOFT_RST_ENABLE\tBIT(1)\n#define CDC_WSA_COMPANDER_HALT_MASK\t\tBIT(2)\n#define CDC_WSA_COMPANDER_HALT\t\t\tBIT(2)\n#define CDC_WSA_COMPANDER0_CTL1\t\t\t(0x0584)\n#define CDC_WSA_COMPANDER0_CTL2\t\t\t(0x0588)\n#define CDC_WSA_COMPANDER0_CTL3\t\t\t(0x058C)\n#define CDC_WSA_COMPANDER0_CTL4\t\t\t(0x0590)\n#define CDC_WSA_COMPANDER0_CTL5\t\t\t(0x0594)\n#define CDC_WSA_COMPANDER0_CTL6\t\t\t(0x0598)\n#define CDC_WSA_COMPANDER0_CTL7\t\t\t(0x059C)\n#define CDC_WSA_COMPANDER1_CTL0\t\t\t(0x05C0)\n#define CDC_WSA_COMPANDER1_CTL1\t\t\t(0x05C4)\n#define CDC_WSA_COMPANDER1_CTL2\t\t\t(0x05C8)\n#define CDC_WSA_COMPANDER1_CTL3\t\t\t(0x05CC)\n#define CDC_WSA_COMPANDER1_CTL4\t\t\t(0x05D0)\n#define CDC_WSA_COMPANDER1_CTL5\t\t\t(0x05D4)\n#define CDC_WSA_COMPANDER1_CTL6\t\t\t(0x05D8)\n#define CDC_WSA_COMPANDER1_CTL7\t\t\t(0x05DC)\n#define CDC_WSA_SOFTCLIP0_CRC\t\t\t(0x0600)\n#define CDC_WSA_SOFTCLIP_CLK_EN_MASK\t\tBIT(0)\n#define CDC_WSA_SOFTCLIP_CLK_ENABLE\t\tBIT(0)\n#define CDC_WSA_SOFTCLIP0_SOFTCLIP_CTRL\t\t(0x0604)\n#define CDC_WSA_SOFTCLIP_EN_MASK\t\tBIT(0)\n#define CDC_WSA_SOFTCLIP_ENABLE\t\t\tBIT(0)\n#define CDC_WSA_SOFTCLIP1_CRC\t\t\t(0x0640)\n#define CDC_WSA_SOFTCLIP1_SOFTCLIP_CTRL\t\t(0x0644)\n#define CDC_WSA_EC_HQ0_EC_REF_HQ_PATH_CTL\t(0x0680)\n#define CDC_WSA_EC_HQ_EC_CLK_EN_MASK\t\tBIT(0)\n#define CDC_WSA_EC_HQ_EC_CLK_ENABLE\t\tBIT(0)\n#define CDC_WSA_EC_HQ0_EC_REF_HQ_CFG0\t\t(0x0684)\n#define CDC_WSA_EC_HQ_EC_REF_PCM_RATE_MASK\tGENMASK(4, 1)\n#define CDC_WSA_EC_HQ_EC_REF_PCM_RATE_48K\tBIT(3)\n#define CDC_WSA_EC_HQ1_EC_REF_HQ_PATH_CTL\t(0x06C0)\n#define CDC_WSA_EC_HQ1_EC_REF_HQ_CFG0\t\t(0x06C4)\n#define CDC_WSA_SPLINE_ASRC0_CLK_RST_CTL\t(0x0700)\n#define CDC_WSA_SPLINE_ASRC0_CTL0\t\t(0x0704)\n#define CDC_WSA_SPLINE_ASRC0_CTL1\t\t(0x0708)\n#define CDC_WSA_SPLINE_ASRC0_FIFO_CTL\t\t(0x070C)\n#define CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_LSB\t(0x0710)\n#define CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_MSB\t(0x0714)\n#define CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_LSB\t(0x0718)\n#define CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_MSB\t(0x071C)\n#define CDC_WSA_SPLINE_ASRC0_STATUS_FIFO\t\t(0x0720)\n#define CDC_WSA_SPLINE_ASRC1_CLK_RST_CTL\t\t(0x0740)\n#define CDC_WSA_SPLINE_ASRC1_CTL0\t\t(0x0744)\n#define CDC_WSA_SPLINE_ASRC1_CTL1\t\t(0x0748)\n#define CDC_WSA_SPLINE_ASRC1_FIFO_CTL\t\t(0x074C)\n#define CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_LSB (0x0750)\n#define CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_MSB (0x0754)\n#define CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_LSB (0x0758)\n#define CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_MSB (0x075C)\n#define CDC_WSA_SPLINE_ASRC1_STATUS_FIFO\t(0x0760)\n#define WSA_MAX_OFFSET\t\t\t\t(0x0760)\n\n#define WSA_MACRO_RX_RATES (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_16000 |\\\n\t\t\tSNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_48000 |\\\n\t\t\tSNDRV_PCM_RATE_96000 | SNDRV_PCM_RATE_192000)\n#define WSA_MACRO_RX_MIX_RATES (SNDRV_PCM_RATE_48000 |\\\n\t\t\tSNDRV_PCM_RATE_96000 | SNDRV_PCM_RATE_192000)\n#define WSA_MACRO_RX_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\tSNDRV_PCM_FMTBIT_S24_LE |\\\n\t\tSNDRV_PCM_FMTBIT_S24_3LE | SNDRV_PCM_FMTBIT_S32_LE)\n\n#define WSA_MACRO_ECHO_RATES (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_16000 |\\\n\t\t\tSNDRV_PCM_RATE_48000)\n#define WSA_MACRO_ECHO_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\tSNDRV_PCM_FMTBIT_S24_LE |\\\n\t\tSNDRV_PCM_FMTBIT_S24_3LE)\n\n#define NUM_INTERPOLATORS 2\n#define WSA_NUM_CLKS_MAX\t5\n#define WSA_MACRO_MCLK_FREQ 19200000\n#define WSA_MACRO_MUX_INP_MASK2 0x38\n#define WSA_MACRO_MUX_CFG_OFFSET 0x8\n#define WSA_MACRO_MUX_CFG1_OFFSET 0x4\n#define WSA_MACRO_RX_COMP_OFFSET 0x40\n#define WSA_MACRO_RX_SOFTCLIP_OFFSET 0x40\n#define WSA_MACRO_RX_PATH_OFFSET 0x80\n#define WSA_MACRO_RX_PATH_CFG3_OFFSET 0x10\n#define WSA_MACRO_RX_PATH_DSMDEM_OFFSET 0x4C\n#define WSA_MACRO_FS_RATE_MASK 0x0F\n#define WSA_MACRO_EC_MIX_TX0_MASK 0x03\n#define WSA_MACRO_EC_MIX_TX1_MASK 0x18\n#define WSA_MACRO_MAX_DMA_CH_PER_PORT 0x2\n\nenum {\n\tWSA_MACRO_GAIN_OFFSET_M1P5_DB,\n\tWSA_MACRO_GAIN_OFFSET_0_DB,\n};\nenum {\n\tWSA_MACRO_RX0 = 0,\n\tWSA_MACRO_RX1,\n\tWSA_MACRO_RX_MIX,\n\tWSA_MACRO_RX_MIX0 = WSA_MACRO_RX_MIX,\n\tWSA_MACRO_RX_MIX1,\n\tWSA_MACRO_RX_MAX,\n};\n\nenum {\n\tWSA_MACRO_TX0 = 0,\n\tWSA_MACRO_TX1,\n\tWSA_MACRO_TX_MAX,\n};\n\nenum {\n\tWSA_MACRO_EC0_MUX = 0,\n\tWSA_MACRO_EC1_MUX,\n\tWSA_MACRO_EC_MUX_MAX,\n};\n\nenum {\n\tWSA_MACRO_COMP1,  \n\tWSA_MACRO_COMP2,  \n\tWSA_MACRO_COMP_MAX\n};\n\nenum {\n\tWSA_MACRO_SOFTCLIP0,  \n\tWSA_MACRO_SOFTCLIP1,  \n\tWSA_MACRO_SOFTCLIP_MAX\n};\n\nenum {\n\tINTn_1_INP_SEL_ZERO = 0,\n\tINTn_1_INP_SEL_RX0,\n\tINTn_1_INP_SEL_RX1,\n\tINTn_1_INP_SEL_RX2,\n\tINTn_1_INP_SEL_RX3,\n\tINTn_1_INP_SEL_DEC0,\n\tINTn_1_INP_SEL_DEC1,\n};\n\nenum {\n\tINTn_2_INP_SEL_ZERO = 0,\n\tINTn_2_INP_SEL_RX0,\n\tINTn_2_INP_SEL_RX1,\n\tINTn_2_INP_SEL_RX2,\n\tINTn_2_INP_SEL_RX3,\n};\n\nstruct interp_sample_rate {\n\tint sample_rate;\n\tint rate_val;\n};\n\nstatic struct interp_sample_rate int_prim_sample_rate_val[] = {\n\t{8000, 0x0},\t \n\t{16000, 0x1},\t \n\t{24000, -EINVAL}, \n\t{32000, 0x3},\t \n\t{48000, 0x4},\t \n\t{96000, 0x5},\t \n\t{192000, 0x6},\t \n\t{384000, 0x7},\t \n\t{44100, 0x8},  \n};\n\nstatic struct interp_sample_rate int_mix_sample_rate_val[] = {\n\t{48000, 0x4},\t \n\t{96000, 0x5},\t \n\t{192000, 0x6},\t \n};\n\nenum {\n\tWSA_MACRO_AIF_INVALID = 0,\n\tWSA_MACRO_AIF1_PB,\n\tWSA_MACRO_AIF_MIX1_PB,\n\tWSA_MACRO_AIF_VI,\n\tWSA_MACRO_AIF_ECHO,\n\tWSA_MACRO_MAX_DAIS,\n};\n\nstruct wsa_macro {\n\tstruct device *dev;\n\tint comp_enabled[WSA_MACRO_COMP_MAX];\n\tint ec_hq[WSA_MACRO_RX1 + 1];\n\tu16 prim_int_users[WSA_MACRO_RX1 + 1];\n\tu16 wsa_mclk_users;\n\tunsigned long active_ch_mask[WSA_MACRO_MAX_DAIS];\n\tunsigned long active_ch_cnt[WSA_MACRO_MAX_DAIS];\n\tint rx_port_value[WSA_MACRO_RX_MAX];\n\tint ear_spkr_gain;\n\tint spkr_gain_offset;\n\tint spkr_mode;\n\tint is_softclip_on[WSA_MACRO_SOFTCLIP_MAX];\n\tint softclip_clk_users[WSA_MACRO_SOFTCLIP_MAX];\n\tstruct regmap *regmap;\n\tstruct clk *mclk;\n\tstruct clk *npl;\n\tstruct clk *macro;\n\tstruct clk *dcodec;\n\tstruct clk *fsgen;\n\tstruct clk_hw hw;\n};\n#define to_wsa_macro(_hw) container_of(_hw, struct wsa_macro, hw)\n\nstatic const DECLARE_TLV_DB_SCALE(digital_gain, -8400, 100, -8400);\n\nstatic const char *const rx_text[] = {\n\t\"ZERO\", \"RX0\", \"RX1\", \"RX_MIX0\", \"RX_MIX1\", \"DEC0\", \"DEC1\"\n};\n\nstatic const char *const rx_mix_text[] = {\n\t\"ZERO\", \"RX0\", \"RX1\", \"RX_MIX0\", \"RX_MIX1\"\n};\n\nstatic const char *const rx_mix_ec_text[] = {\n\t\"ZERO\", \"RX_MIX_TX0\", \"RX_MIX_TX1\"\n};\n\nstatic const char *const rx_mux_text[] = {\n\t\"ZERO\", \"AIF1_PB\", \"AIF_MIX1_PB\"\n};\n\nstatic const char *const rx_sidetone_mix_text[] = {\n\t\"ZERO\", \"SRC0\"\n};\n\nstatic const char * const wsa_macro_ear_spkr_pa_gain_text[] = {\n\t\"G_DEFAULT\", \"G_0_DB\", \"G_1_DB\", \"G_2_DB\", \"G_3_DB\",\n\t\"G_4_DB\", \"G_5_DB\", \"G_6_DB\"\n};\n\nstatic SOC_ENUM_SINGLE_EXT_DECL(wsa_macro_ear_spkr_pa_gain_enum,\n\t\t\t\twsa_macro_ear_spkr_pa_gain_text);\n\n \nstatic const struct soc_enum rx0_prim_inp0_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT0_CFG0,\n\t\t0, 7, rx_text);\n\nstatic const struct soc_enum rx0_prim_inp1_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT0_CFG0,\n\t\t3, 7, rx_text);\n\nstatic const struct soc_enum rx0_prim_inp2_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT0_CFG1,\n\t\t3, 7, rx_text);\n\nstatic const struct soc_enum rx0_mix_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT0_CFG1,\n\t\t0, 5, rx_mix_text);\n\nstatic const struct soc_enum rx0_sidetone_mix_enum =\n\tSOC_ENUM_SINGLE(SND_SOC_NOPM, 0, 2, rx_sidetone_mix_text);\n\nstatic const struct snd_kcontrol_new rx0_prim_inp0_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX0 INP0 Mux\", rx0_prim_inp0_chain_enum);\n\nstatic const struct snd_kcontrol_new rx0_prim_inp1_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX0 INP1 Mux\", rx0_prim_inp1_chain_enum);\n\nstatic const struct snd_kcontrol_new rx0_prim_inp2_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX0 INP2 Mux\", rx0_prim_inp2_chain_enum);\n\nstatic const struct snd_kcontrol_new rx0_mix_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX0 MIX Mux\", rx0_mix_chain_enum);\n\nstatic const struct snd_kcontrol_new rx0_sidetone_mix_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX0 SIDETONE MIX Mux\", rx0_sidetone_mix_enum);\n\n \nstatic const struct soc_enum rx1_prim_inp0_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT1_CFG0,\n\t\t0, 7, rx_text);\n\nstatic const struct soc_enum rx1_prim_inp1_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT1_CFG0,\n\t\t3, 7, rx_text);\n\nstatic const struct soc_enum rx1_prim_inp2_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT1_CFG1,\n\t\t3, 7, rx_text);\n\nstatic const struct soc_enum rx1_mix_chain_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_INT1_CFG1,\n\t\t0, 5, rx_mix_text);\n\nstatic const struct snd_kcontrol_new rx1_prim_inp0_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX1 INP0 Mux\", rx1_prim_inp0_chain_enum);\n\nstatic const struct snd_kcontrol_new rx1_prim_inp1_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX1 INP1 Mux\", rx1_prim_inp1_chain_enum);\n\nstatic const struct snd_kcontrol_new rx1_prim_inp2_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX1 INP2 Mux\", rx1_prim_inp2_chain_enum);\n\nstatic const struct snd_kcontrol_new rx1_mix_mux =\n\tSOC_DAPM_ENUM(\"WSA_RX1 MIX Mux\", rx1_mix_chain_enum);\n\nstatic const struct soc_enum rx_mix_ec0_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_MIX_CFG0,\n\t\t0, 3, rx_mix_ec_text);\n\nstatic const struct soc_enum rx_mix_ec1_enum =\n\tSOC_ENUM_SINGLE(CDC_WSA_RX_INP_MUX_RX_MIX_CFG0,\n\t\t3, 3, rx_mix_ec_text);\n\nstatic const struct snd_kcontrol_new rx_mix_ec0_mux =\n\tSOC_DAPM_ENUM(\"WSA RX_MIX EC0_Mux\", rx_mix_ec0_enum);\n\nstatic const struct snd_kcontrol_new rx_mix_ec1_mux =\n\tSOC_DAPM_ENUM(\"WSA RX_MIX EC1_Mux\", rx_mix_ec1_enum);\n\nstatic const struct reg_default wsa_defaults[] = {\n\t \n\t{ CDC_WSA_CLK_RST_CTRL_MCLK_CONTROL, 0x00},\n\t{ CDC_WSA_CLK_RST_CTRL_FS_CNT_CONTROL, 0x00},\n\t{ CDC_WSA_CLK_RST_CTRL_SWR_CONTROL, 0x00},\n\t{ CDC_WSA_TOP_TOP_CFG0, 0x00},\n\t{ CDC_WSA_TOP_TOP_CFG1, 0x00},\n\t{ CDC_WSA_TOP_FREQ_MCLK, 0x00},\n\t{ CDC_WSA_TOP_DEBUG_BUS_SEL, 0x00},\n\t{ CDC_WSA_TOP_DEBUG_EN0, 0x00},\n\t{ CDC_WSA_TOP_DEBUG_EN1, 0x00},\n\t{ CDC_WSA_TOP_DEBUG_DSM_LB, 0x88},\n\t{ CDC_WSA_TOP_RX_I2S_CTL, 0x0C},\n\t{ CDC_WSA_TOP_TX_I2S_CTL, 0x0C},\n\t{ CDC_WSA_TOP_I2S_CLK, 0x02},\n\t{ CDC_WSA_TOP_I2S_RESET, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_RX_INT0_CFG0, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_RX_INT0_CFG1, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_RX_INT1_CFG0, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_RX_INT1_CFG1, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_RX_MIX_CFG0, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_RX_EC_CFG0, 0x00},\n\t{ CDC_WSA_RX_INP_MUX_SOFTCLIP_CFG0, 0x00},\n\t{ CDC_WSA_TX0_SPKR_PROT_PATH_CTL, 0x02},\n\t{ CDC_WSA_TX0_SPKR_PROT_PATH_CFG0, 0x00},\n\t{ CDC_WSA_TX1_SPKR_PROT_PATH_CTL, 0x02},\n\t{ CDC_WSA_TX1_SPKR_PROT_PATH_CFG0, 0x00},\n\t{ CDC_WSA_TX2_SPKR_PROT_PATH_CTL, 0x02},\n\t{ CDC_WSA_TX2_SPKR_PROT_PATH_CFG0, 0x00},\n\t{ CDC_WSA_TX3_SPKR_PROT_PATH_CTL, 0x02},\n\t{ CDC_WSA_TX3_SPKR_PROT_PATH_CFG0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_CFG, 0x00},\n\t{ CDC_WSA_INTR_CTRL_CLR_COMMIT, 0x00},\n\t{ CDC_WSA_INTR_CTRL_PIN1_MASK0, 0xFF},\n\t{ CDC_WSA_INTR_CTRL_PIN1_STATUS0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_PIN1_CLEAR0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_PIN2_MASK0, 0xFF},\n\t{ CDC_WSA_INTR_CTRL_PIN2_STATUS0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_PIN2_CLEAR0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_LEVEL0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_BYPASS0, 0x00},\n\t{ CDC_WSA_INTR_CTRL_SET0, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_CTL, 0x04},\n\t{ CDC_WSA_RX0_RX_PATH_CFG0, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_CFG1, 0x64},\n\t{ CDC_WSA_RX0_RX_PATH_CFG2, 0x8F},\n\t{ CDC_WSA_RX0_RX_PATH_CFG3, 0x00},\n\t{ CDC_WSA_RX0_RX_VOL_CTL, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_MIX_CTL, 0x04},\n\t{ CDC_WSA_RX0_RX_PATH_MIX_CFG, 0x7E},\n\t{ CDC_WSA_RX0_RX_VOL_MIX_CTL, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_SEC0, 0x04},\n\t{ CDC_WSA_RX0_RX_PATH_SEC1, 0x08},\n\t{ CDC_WSA_RX0_RX_PATH_SEC2, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_SEC3, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_SEC5, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_SEC6, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_SEC7, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_MIX_SEC0, 0x08},\n\t{ CDC_WSA_RX0_RX_PATH_MIX_SEC1, 0x00},\n\t{ CDC_WSA_RX0_RX_PATH_DSMDEM_CTL, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_CFG0, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_CFG1, 0x64},\n\t{ CDC_WSA_RX1_RX_PATH_CFG2, 0x8F},\n\t{ CDC_WSA_RX1_RX_PATH_CFG3, 0x00},\n\t{ CDC_WSA_RX1_RX_VOL_CTL, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_MIX_CTL, 0x04},\n\t{ CDC_WSA_RX1_RX_PATH_MIX_CFG, 0x7E},\n\t{ CDC_WSA_RX1_RX_VOL_MIX_CTL, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_SEC0, 0x04},\n\t{ CDC_WSA_RX1_RX_PATH_SEC1, 0x08},\n\t{ CDC_WSA_RX1_RX_PATH_SEC2, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_SEC3, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_SEC5, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_SEC6, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_SEC7, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_MIX_SEC0, 0x08},\n\t{ CDC_WSA_RX1_RX_PATH_MIX_SEC1, 0x00},\n\t{ CDC_WSA_RX1_RX_PATH_DSMDEM_CTL, 0x00},\n\t{ CDC_WSA_BOOST0_BOOST_PATH_CTL, 0x00},\n\t{ CDC_WSA_BOOST0_BOOST_CTL, 0xD0},\n\t{ CDC_WSA_BOOST0_BOOST_CFG1, 0x89},\n\t{ CDC_WSA_BOOST0_BOOST_CFG2, 0x04},\n\t{ CDC_WSA_BOOST1_BOOST_PATH_CTL, 0x00},\n\t{ CDC_WSA_BOOST1_BOOST_CTL, 0xD0},\n\t{ CDC_WSA_BOOST1_BOOST_CFG1, 0x89},\n\t{ CDC_WSA_BOOST1_BOOST_CFG2, 0x04},\n\t{ CDC_WSA_COMPANDER0_CTL0, 0x60},\n\t{ CDC_WSA_COMPANDER0_CTL1, 0xDB},\n\t{ CDC_WSA_COMPANDER0_CTL2, 0xFF},\n\t{ CDC_WSA_COMPANDER0_CTL3, 0x35},\n\t{ CDC_WSA_COMPANDER0_CTL4, 0xFF},\n\t{ CDC_WSA_COMPANDER0_CTL5, 0x00},\n\t{ CDC_WSA_COMPANDER0_CTL6, 0x01},\n\t{ CDC_WSA_COMPANDER0_CTL7, 0x28},\n\t{ CDC_WSA_COMPANDER1_CTL0, 0x60},\n\t{ CDC_WSA_COMPANDER1_CTL1, 0xDB},\n\t{ CDC_WSA_COMPANDER1_CTL2, 0xFF},\n\t{ CDC_WSA_COMPANDER1_CTL3, 0x35},\n\t{ CDC_WSA_COMPANDER1_CTL4, 0xFF},\n\t{ CDC_WSA_COMPANDER1_CTL5, 0x00},\n\t{ CDC_WSA_COMPANDER1_CTL6, 0x01},\n\t{ CDC_WSA_COMPANDER1_CTL7, 0x28},\n\t{ CDC_WSA_SOFTCLIP0_CRC, 0x00},\n\t{ CDC_WSA_SOFTCLIP0_SOFTCLIP_CTRL, 0x38},\n\t{ CDC_WSA_SOFTCLIP1_CRC, 0x00},\n\t{ CDC_WSA_SOFTCLIP1_SOFTCLIP_CTRL, 0x38},\n\t{ CDC_WSA_EC_HQ0_EC_REF_HQ_PATH_CTL, 0x00},\n\t{ CDC_WSA_EC_HQ0_EC_REF_HQ_CFG0, 0x01},\n\t{ CDC_WSA_EC_HQ1_EC_REF_HQ_PATH_CTL, 0x00},\n\t{ CDC_WSA_EC_HQ1_EC_REF_HQ_CFG0, 0x01},\n\t{ CDC_WSA_SPLINE_ASRC0_CLK_RST_CTL, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_CTL0, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_CTL1, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_FIFO_CTL, 0xA8},\n\t{ CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_LSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_MSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_LSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_MSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC0_STATUS_FIFO, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_CLK_RST_CTL, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_CTL0, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_CTL1, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_FIFO_CTL, 0xA8},\n\t{ CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_LSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_MSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_LSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_MSB, 0x00},\n\t{ CDC_WSA_SPLINE_ASRC1_STATUS_FIFO, 0x00},\n};\n\nstatic bool wsa_is_wronly_register(struct device *dev,\n\t\t\t\t\tunsigned int reg)\n{\n\tswitch (reg) {\n\tcase CDC_WSA_INTR_CTRL_CLR_COMMIT:\n\tcase CDC_WSA_INTR_CTRL_PIN1_CLEAR0:\n\tcase CDC_WSA_INTR_CTRL_PIN2_CLEAR0:\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic bool wsa_is_rw_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase CDC_WSA_CLK_RST_CTRL_MCLK_CONTROL:\n\tcase CDC_WSA_CLK_RST_CTRL_FS_CNT_CONTROL:\n\tcase CDC_WSA_CLK_RST_CTRL_SWR_CONTROL:\n\tcase CDC_WSA_TOP_TOP_CFG0:\n\tcase CDC_WSA_TOP_TOP_CFG1:\n\tcase CDC_WSA_TOP_FREQ_MCLK:\n\tcase CDC_WSA_TOP_DEBUG_BUS_SEL:\n\tcase CDC_WSA_TOP_DEBUG_EN0:\n\tcase CDC_WSA_TOP_DEBUG_EN1:\n\tcase CDC_WSA_TOP_DEBUG_DSM_LB:\n\tcase CDC_WSA_TOP_RX_I2S_CTL:\n\tcase CDC_WSA_TOP_TX_I2S_CTL:\n\tcase CDC_WSA_TOP_I2S_CLK:\n\tcase CDC_WSA_TOP_I2S_RESET:\n\tcase CDC_WSA_RX_INP_MUX_RX_INT0_CFG0:\n\tcase CDC_WSA_RX_INP_MUX_RX_INT0_CFG1:\n\tcase CDC_WSA_RX_INP_MUX_RX_INT1_CFG0:\n\tcase CDC_WSA_RX_INP_MUX_RX_INT1_CFG1:\n\tcase CDC_WSA_RX_INP_MUX_RX_MIX_CFG0:\n\tcase CDC_WSA_RX_INP_MUX_RX_EC_CFG0:\n\tcase CDC_WSA_RX_INP_MUX_SOFTCLIP_CFG0:\n\tcase CDC_WSA_TX0_SPKR_PROT_PATH_CTL:\n\tcase CDC_WSA_TX0_SPKR_PROT_PATH_CFG0:\n\tcase CDC_WSA_TX1_SPKR_PROT_PATH_CTL:\n\tcase CDC_WSA_TX1_SPKR_PROT_PATH_CFG0:\n\tcase CDC_WSA_TX2_SPKR_PROT_PATH_CTL:\n\tcase CDC_WSA_TX2_SPKR_PROT_PATH_CFG0:\n\tcase CDC_WSA_TX3_SPKR_PROT_PATH_CTL:\n\tcase CDC_WSA_TX3_SPKR_PROT_PATH_CFG0:\n\tcase CDC_WSA_INTR_CTRL_CFG:\n\tcase CDC_WSA_INTR_CTRL_PIN1_MASK0:\n\tcase CDC_WSA_INTR_CTRL_PIN2_MASK0:\n\tcase CDC_WSA_INTR_CTRL_LEVEL0:\n\tcase CDC_WSA_INTR_CTRL_BYPASS0:\n\tcase CDC_WSA_INTR_CTRL_SET0:\n\tcase CDC_WSA_RX0_RX_PATH_CTL:\n\tcase CDC_WSA_RX0_RX_PATH_CFG0:\n\tcase CDC_WSA_RX0_RX_PATH_CFG1:\n\tcase CDC_WSA_RX0_RX_PATH_CFG2:\n\tcase CDC_WSA_RX0_RX_PATH_CFG3:\n\tcase CDC_WSA_RX0_RX_VOL_CTL:\n\tcase CDC_WSA_RX0_RX_PATH_MIX_CTL:\n\tcase CDC_WSA_RX0_RX_PATH_MIX_CFG:\n\tcase CDC_WSA_RX0_RX_VOL_MIX_CTL:\n\tcase CDC_WSA_RX0_RX_PATH_SEC0:\n\tcase CDC_WSA_RX0_RX_PATH_SEC1:\n\tcase CDC_WSA_RX0_RX_PATH_SEC2:\n\tcase CDC_WSA_RX0_RX_PATH_SEC3:\n\tcase CDC_WSA_RX0_RX_PATH_SEC5:\n\tcase CDC_WSA_RX0_RX_PATH_SEC6:\n\tcase CDC_WSA_RX0_RX_PATH_SEC7:\n\tcase CDC_WSA_RX0_RX_PATH_MIX_SEC0:\n\tcase CDC_WSA_RX0_RX_PATH_MIX_SEC1:\n\tcase CDC_WSA_RX0_RX_PATH_DSMDEM_CTL:\n\tcase CDC_WSA_RX1_RX_PATH_CTL:\n\tcase CDC_WSA_RX1_RX_PATH_CFG0:\n\tcase CDC_WSA_RX1_RX_PATH_CFG1:\n\tcase CDC_WSA_RX1_RX_PATH_CFG2:\n\tcase CDC_WSA_RX1_RX_PATH_CFG3:\n\tcase CDC_WSA_RX1_RX_VOL_CTL:\n\tcase CDC_WSA_RX1_RX_PATH_MIX_CTL:\n\tcase CDC_WSA_RX1_RX_PATH_MIX_CFG:\n\tcase CDC_WSA_RX1_RX_VOL_MIX_CTL:\n\tcase CDC_WSA_RX1_RX_PATH_SEC0:\n\tcase CDC_WSA_RX1_RX_PATH_SEC1:\n\tcase CDC_WSA_RX1_RX_PATH_SEC2:\n\tcase CDC_WSA_RX1_RX_PATH_SEC3:\n\tcase CDC_WSA_RX1_RX_PATH_SEC5:\n\tcase CDC_WSA_RX1_RX_PATH_SEC6:\n\tcase CDC_WSA_RX1_RX_PATH_SEC7:\n\tcase CDC_WSA_RX1_RX_PATH_MIX_SEC0:\n\tcase CDC_WSA_RX1_RX_PATH_MIX_SEC1:\n\tcase CDC_WSA_RX1_RX_PATH_DSMDEM_CTL:\n\tcase CDC_WSA_BOOST0_BOOST_PATH_CTL:\n\tcase CDC_WSA_BOOST0_BOOST_CTL:\n\tcase CDC_WSA_BOOST0_BOOST_CFG1:\n\tcase CDC_WSA_BOOST0_BOOST_CFG2:\n\tcase CDC_WSA_BOOST1_BOOST_PATH_CTL:\n\tcase CDC_WSA_BOOST1_BOOST_CTL:\n\tcase CDC_WSA_BOOST1_BOOST_CFG1:\n\tcase CDC_WSA_BOOST1_BOOST_CFG2:\n\tcase CDC_WSA_COMPANDER0_CTL0:\n\tcase CDC_WSA_COMPANDER0_CTL1:\n\tcase CDC_WSA_COMPANDER0_CTL2:\n\tcase CDC_WSA_COMPANDER0_CTL3:\n\tcase CDC_WSA_COMPANDER0_CTL4:\n\tcase CDC_WSA_COMPANDER0_CTL5:\n\tcase CDC_WSA_COMPANDER0_CTL7:\n\tcase CDC_WSA_COMPANDER1_CTL0:\n\tcase CDC_WSA_COMPANDER1_CTL1:\n\tcase CDC_WSA_COMPANDER1_CTL2:\n\tcase CDC_WSA_COMPANDER1_CTL3:\n\tcase CDC_WSA_COMPANDER1_CTL4:\n\tcase CDC_WSA_COMPANDER1_CTL5:\n\tcase CDC_WSA_COMPANDER1_CTL7:\n\tcase CDC_WSA_SOFTCLIP0_CRC:\n\tcase CDC_WSA_SOFTCLIP0_SOFTCLIP_CTRL:\n\tcase CDC_WSA_SOFTCLIP1_CRC:\n\tcase CDC_WSA_SOFTCLIP1_SOFTCLIP_CTRL:\n\tcase CDC_WSA_EC_HQ0_EC_REF_HQ_PATH_CTL:\n\tcase CDC_WSA_EC_HQ0_EC_REF_HQ_CFG0:\n\tcase CDC_WSA_EC_HQ1_EC_REF_HQ_PATH_CTL:\n\tcase CDC_WSA_EC_HQ1_EC_REF_HQ_CFG0:\n\tcase CDC_WSA_SPLINE_ASRC0_CLK_RST_CTL:\n\tcase CDC_WSA_SPLINE_ASRC0_CTL0:\n\tcase CDC_WSA_SPLINE_ASRC0_CTL1:\n\tcase CDC_WSA_SPLINE_ASRC0_FIFO_CTL:\n\tcase CDC_WSA_SPLINE_ASRC1_CLK_RST_CTL:\n\tcase CDC_WSA_SPLINE_ASRC1_CTL0:\n\tcase CDC_WSA_SPLINE_ASRC1_CTL1:\n\tcase CDC_WSA_SPLINE_ASRC1_FIFO_CTL:\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic bool wsa_is_writeable_register(struct device *dev, unsigned int reg)\n{\n\tbool ret;\n\n\tret = wsa_is_rw_register(dev, reg);\n\tif (!ret)\n\t\treturn wsa_is_wronly_register(dev, reg);\n\n\treturn ret;\n}\n\nstatic bool wsa_is_readable_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase CDC_WSA_INTR_CTRL_CLR_COMMIT:\n\tcase CDC_WSA_INTR_CTRL_PIN1_CLEAR0:\n\tcase CDC_WSA_INTR_CTRL_PIN2_CLEAR0:\n\tcase CDC_WSA_INTR_CTRL_PIN1_STATUS0:\n\tcase CDC_WSA_INTR_CTRL_PIN2_STATUS0:\n\tcase CDC_WSA_COMPANDER0_CTL6:\n\tcase CDC_WSA_COMPANDER1_CTL6:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FIFO:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FIFO:\n\t\treturn true;\n\t}\n\n\treturn wsa_is_rw_register(dev, reg);\n}\n\nstatic bool wsa_is_volatile_register(struct device *dev, unsigned int reg)\n{\n\t \n\tswitch (reg) {\n\tcase CDC_WSA_INTR_CTRL_PIN1_STATUS0:\n\tcase CDC_WSA_INTR_CTRL_PIN2_STATUS0:\n\tcase CDC_WSA_COMPANDER0_CTL6:\n\tcase CDC_WSA_COMPANDER1_CTL6:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMIN_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FMAX_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC0_STATUS_FIFO:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMIN_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_LSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FMAX_CNTR_MSB:\n\tcase CDC_WSA_SPLINE_ASRC1_STATUS_FIFO:\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic const struct regmap_config wsa_regmap_config = {\n\t.name = \"wsa_macro\",\n\t.reg_bits = 16,\n\t.val_bits = 32,  \n\t.reg_stride = 4,\n\t.cache_type = REGCACHE_FLAT,\n\t.reg_defaults = wsa_defaults,\n\t.num_reg_defaults = ARRAY_SIZE(wsa_defaults),\n\t.max_register = WSA_MAX_OFFSET,\n\t.writeable_reg = wsa_is_writeable_register,\n\t.volatile_reg = wsa_is_volatile_register,\n\t.readable_reg = wsa_is_readable_register,\n};\n\n \nint wsa_macro_set_spkr_mode(struct snd_soc_component *component, int mode)\n{\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\twsa->spkr_mode = mode;\n\n\tswitch (mode) {\n\tcase WSA_MACRO_SPKR_MODE_1:\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER0_CTL3, 0x80, 0x00);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER1_CTL3, 0x80, 0x00);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER0_CTL7, 0x01, 0x00);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER1_CTL7, 0x01, 0x00);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_BOOST0_BOOST_CTL, 0x7C, 0x44);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_BOOST1_BOOST_CTL, 0x7C, 0x44);\n\t\tbreak;\n\tdefault:\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER0_CTL3, 0x80, 0x80);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER1_CTL3, 0x80, 0x80);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER0_CTL7, 0x01, 0x01);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_COMPANDER1_CTL7, 0x01, 0x01);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_BOOST0_BOOST_CTL, 0x7C, 0x58);\n\t\tsnd_soc_component_update_bits(component, CDC_WSA_BOOST1_BOOST_CTL, 0x7C, 0x58);\n\t\tbreak;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL(wsa_macro_set_spkr_mode);\n\nstatic int wsa_macro_set_prim_interpolator_rate(struct snd_soc_dai *dai,\n\t\t\t\t\t\tu8 int_prim_fs_rate_reg_val,\n\t\t\t\t\t\tu32 sample_rate)\n{\n\tu8 int_1_mix1_inp;\n\tu32 j, port;\n\tu16 int_mux_cfg0, int_mux_cfg1;\n\tu16 int_fs_reg;\n\tu8 inp0_sel, inp1_sel, inp2_sel;\n\tstruct snd_soc_component *component = dai->component;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tfor_each_set_bit(port, &wsa->active_ch_mask[dai->id], WSA_MACRO_RX_MAX) {\n\t\tint_1_mix1_inp = port;\n\t\tif ((int_1_mix1_inp < WSA_MACRO_RX0) || (int_1_mix1_inp > WSA_MACRO_RX_MIX1)) {\n\t\t\tdev_err(component->dev,\t\"%s: Invalid RX port, Dai ID is %d\\n\",\n\t\t\t\t__func__, dai->id);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tint_mux_cfg0 = CDC_WSA_RX_INP_MUX_RX_INT0_CFG0;\n\n\t\t \n\t\tfor (j = 0; j < NUM_INTERPOLATORS; j++) {\n\t\t\tint_mux_cfg1 = int_mux_cfg0 + WSA_MACRO_MUX_CFG1_OFFSET;\n\t\t\tinp0_sel = snd_soc_component_read_field(component, int_mux_cfg0, \n\t\t\t\t\t\t\t\tCDC_WSA_RX_INTX_1_MIX_INP0_SEL_MASK);\n\t\t\tinp1_sel = snd_soc_component_read_field(component, int_mux_cfg0, \n\t\t\t\t\t\t\t\tCDC_WSA_RX_INTX_1_MIX_INP1_SEL_MASK);\n\t\t\tinp2_sel = snd_soc_component_read_field(component, int_mux_cfg1,\n\t\t\t\t\t\t\t\tCDC_WSA_RX_INTX_1_MIX_INP2_SEL_MASK);\n\n\t\t\tif ((inp0_sel == int_1_mix1_inp + INTn_1_INP_SEL_RX0) ||\n\t\t\t    (inp1_sel == int_1_mix1_inp + INTn_1_INP_SEL_RX0) ||\n\t\t\t    (inp2_sel == int_1_mix1_inp + INTn_1_INP_SEL_RX0)) {\n\t\t\t\tint_fs_reg = CDC_WSA_RX0_RX_PATH_CTL +\n\t\t\t\t\t     WSA_MACRO_RX_PATH_OFFSET * j;\n\t\t\t\t \n\t\t\t\tsnd_soc_component_update_bits(component, int_fs_reg,\n\t\t\t\t\t\t\t      WSA_MACRO_FS_RATE_MASK,\n\t\t\t\t\t\t\t      int_prim_fs_rate_reg_val);\n\t\t\t}\n\t\t\tint_mux_cfg0 += WSA_MACRO_MUX_CFG_OFFSET;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_set_mix_interpolator_rate(struct snd_soc_dai *dai,\n\t\t\t\t\t       u8 int_mix_fs_rate_reg_val,\n\t\t\t\t\t       u32 sample_rate)\n{\n\tu8 int_2_inp;\n\tu32 j, port;\n\tu16 int_mux_cfg1, int_fs_reg;\n\tu8 int_mux_cfg1_val;\n\tstruct snd_soc_component *component = dai->component;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tfor_each_set_bit(port, &wsa->active_ch_mask[dai->id], WSA_MACRO_RX_MAX) {\n\t\tint_2_inp = port;\n\t\tif ((int_2_inp < WSA_MACRO_RX0) || (int_2_inp > WSA_MACRO_RX_MIX1)) {\n\t\t\tdev_err(component->dev,\t\"%s: Invalid RX port, Dai ID is %d\\n\",\n\t\t\t\t__func__, dai->id);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tint_mux_cfg1 = CDC_WSA_RX_INP_MUX_RX_INT0_CFG1;\n\t\tfor (j = 0; j < NUM_INTERPOLATORS; j++) {\n\t\t\tint_mux_cfg1_val = snd_soc_component_read_field(component, int_mux_cfg1,\n\t\t\t\t\t\t\t\t\tCDC_WSA_RX_INTX_2_SEL_MASK);\n\n\t\t\tif (int_mux_cfg1_val == int_2_inp + INTn_2_INP_SEL_RX0) {\n\t\t\t\tint_fs_reg = CDC_WSA_RX0_RX_PATH_MIX_CTL +\n\t\t\t\t\tWSA_MACRO_RX_PATH_OFFSET * j;\n\n\t\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t\t      int_fs_reg,\n\t\t\t\t\t\t      WSA_MACRO_FS_RATE_MASK,\n\t\t\t\t\t\t      int_mix_fs_rate_reg_val);\n\t\t\t}\n\t\t\tint_mux_cfg1 += WSA_MACRO_MUX_CFG_OFFSET;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int wsa_macro_set_interpolator_rate(struct snd_soc_dai *dai,\n\t\t\t\t\t   u32 sample_rate)\n{\n\tint rate_val = 0;\n\tint i, ret;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(int_mix_sample_rate_val); i++) {\n\t\tif (sample_rate == int_mix_sample_rate_val[i].sample_rate) {\n\t\t\trate_val = int_mix_sample_rate_val[i].rate_val;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif ((i == ARRAY_SIZE(int_mix_sample_rate_val)) || (rate_val < 0))\n\t\tgoto prim_rate;\n\n\tret = wsa_macro_set_mix_interpolator_rate(dai, (u8) rate_val, sample_rate);\n\tif (ret < 0)\n\t\treturn ret;\nprim_rate:\n\t \n\tfor (i = 0; i < ARRAY_SIZE(int_prim_sample_rate_val); i++) {\n\t\tif (sample_rate == int_prim_sample_rate_val[i].sample_rate) {\n\t\t\trate_val = int_prim_sample_rate_val[i].rate_val;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif ((i == ARRAY_SIZE(int_prim_sample_rate_val)) || (rate_val < 0))\n\t\treturn -EINVAL;\n\n\tret = wsa_macro_set_prim_interpolator_rate(dai, (u8) rate_val, sample_rate);\n\n\treturn ret;\n}\n\nstatic int wsa_macro_hw_params(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_pcm_hw_params *params,\n\t\t\t       struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint ret;\n\n\tswitch (substream->stream) {\n\tcase SNDRV_PCM_STREAM_PLAYBACK:\n\t\tret = wsa_macro_set_interpolator_rate(dai, params_rate(params));\n\t\tif (ret) {\n\t\t\tdev_err(component->dev,\n\t\t\t\t\"%s: cannot set sample rate: %u\\n\",\n\t\t\t\t__func__, params_rate(params));\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wsa_macro_get_channel_map(struct snd_soc_dai *dai,\n\t\t\t\t     unsigned int *tx_num, unsigned int *tx_slot,\n\t\t\t\t     unsigned int *rx_num, unsigned int *rx_slot)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tu16 val, mask = 0, cnt = 0, temp;\n\n\tswitch (dai->id) {\n\tcase WSA_MACRO_AIF_VI:\n\t\t*tx_slot = wsa->active_ch_mask[dai->id];\n\t\t*tx_num = wsa->active_ch_cnt[dai->id];\n\t\tbreak;\n\tcase WSA_MACRO_AIF1_PB:\n\tcase WSA_MACRO_AIF_MIX1_PB:\n\t\tfor_each_set_bit(temp, &wsa->active_ch_mask[dai->id],\n\t\t\t\t\tWSA_MACRO_RX_MAX) {\n\t\t\tmask |= (1 << temp);\n\t\t\tif (++cnt == WSA_MACRO_MAX_DMA_CH_PER_PORT)\n\t\t\t\tbreak;\n\t\t}\n\t\tif (mask & 0x0C)\n\t\t\tmask = mask >> 0x2;\n\t\t*rx_slot = mask;\n\t\t*rx_num = cnt;\n\t\tbreak;\n\tcase WSA_MACRO_AIF_ECHO:\n\t\tval = snd_soc_component_read(component, CDC_WSA_RX_INP_MUX_RX_MIX_CFG0);\n\t\tif (val & WSA_MACRO_EC_MIX_TX1_MASK) {\n\t\t\tmask |= 0x2;\n\t\t\tcnt++;\n\t\t}\n\t\tif (val & WSA_MACRO_EC_MIX_TX0_MASK) {\n\t\t\tmask |= 0x1;\n\t\t\tcnt++;\n\t\t}\n\t\t*tx_slot = mask;\n\t\t*tx_num = cnt;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"%s: Invalid AIF\\n\", __func__);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops wsa_macro_dai_ops = {\n\t.hw_params = wsa_macro_hw_params,\n\t.get_channel_map = wsa_macro_get_channel_map,\n};\n\nstatic struct snd_soc_dai_driver wsa_macro_dai[] = {\n\t{\n\t\t.name = \"wsa_macro_rx1\",\n\t\t.id = WSA_MACRO_AIF1_PB,\n\t\t.playback = {\n\t\t\t.stream_name = \"WSA_AIF1 Playback\",\n\t\t\t.rates = WSA_MACRO_RX_RATES,\n\t\t\t.formats = WSA_MACRO_RX_FORMATS,\n\t\t\t.rate_max = 384000,\n\t\t\t.rate_min = 8000,\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t},\n\t\t.ops = &wsa_macro_dai_ops,\n\t},\n\t{\n\t\t.name = \"wsa_macro_rx_mix\",\n\t\t.id = WSA_MACRO_AIF_MIX1_PB,\n\t\t.playback = {\n\t\t\t.stream_name = \"WSA_AIF_MIX1 Playback\",\n\t\t\t.rates = WSA_MACRO_RX_MIX_RATES,\n\t\t\t.formats = WSA_MACRO_RX_FORMATS,\n\t\t\t.rate_max = 192000,\n\t\t\t.rate_min = 48000,\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t},\n\t\t.ops = &wsa_macro_dai_ops,\n\t},\n\t{\n\t\t.name = \"wsa_macro_vifeedback\",\n\t\t.id = WSA_MACRO_AIF_VI,\n\t\t.capture = {\n\t\t\t.stream_name = \"WSA_AIF_VI Capture\",\n\t\t\t.rates = SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_48000,\n\t\t\t.formats = WSA_MACRO_RX_FORMATS,\n\t\t\t.rate_max = 48000,\n\t\t\t.rate_min = 8000,\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 4,\n\t\t},\n\t\t.ops = &wsa_macro_dai_ops,\n\t},\n\t{\n\t\t.name = \"wsa_macro_echo\",\n\t\t.id = WSA_MACRO_AIF_ECHO,\n\t\t.capture = {\n\t\t\t.stream_name = \"WSA_AIF_ECHO Capture\",\n\t\t\t.rates = WSA_MACRO_ECHO_RATES,\n\t\t\t.formats = WSA_MACRO_ECHO_FORMATS,\n\t\t\t.rate_max = 48000,\n\t\t\t.rate_min = 8000,\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t},\n\t\t.ops = &wsa_macro_dai_ops,\n\t},\n};\n\nstatic void wsa_macro_mclk_enable(struct wsa_macro *wsa, bool mclk_enable)\n{\n\tstruct regmap *regmap = wsa->regmap;\n\n\tif (mclk_enable) {\n\t\tif (wsa->wsa_mclk_users == 0) {\n\t\t\tregcache_mark_dirty(regmap);\n\t\t\tregcache_sync(regmap);\n\t\t\t \n\t\t\tregmap_update_bits(regmap, CDC_WSA_TOP_FREQ_MCLK, 0x01, 0x01);\n\t\t\tregmap_update_bits(regmap,\n\t\t\t\t\t   CDC_WSA_CLK_RST_CTRL_MCLK_CONTROL,\n\t\t\t\t\t   CDC_WSA_MCLK_EN_MASK,\n\t\t\t\t\t   CDC_WSA_MCLK_ENABLE);\n\t\t\tregmap_update_bits(regmap,\n\t\t\t\t\t   CDC_WSA_CLK_RST_CTRL_FS_CNT_CONTROL,\n\t\t\t\t\t   CDC_WSA_FS_CNT_EN_MASK,\n\t\t\t\t\t   CDC_WSA_FS_CNT_ENABLE);\n\t\t}\n\t\twsa->wsa_mclk_users++;\n\t} else {\n\t\tif (wsa->wsa_mclk_users <= 0) {\n\t\t\tdev_err(wsa->dev, \"clock already disabled\\n\");\n\t\t\twsa->wsa_mclk_users = 0;\n\t\t\treturn;\n\t\t}\n\t\twsa->wsa_mclk_users--;\n\t\tif (wsa->wsa_mclk_users == 0) {\n\t\t\tregmap_update_bits(regmap,\n\t\t\t\t\t   CDC_WSA_CLK_RST_CTRL_FS_CNT_CONTROL,\n\t\t\t\t\t   CDC_WSA_FS_CNT_EN_MASK,\n\t\t\t\t\t   CDC_WSA_FS_CNT_DISABLE);\n\t\t\tregmap_update_bits(regmap,\n\t\t\t\t\t   CDC_WSA_CLK_RST_CTRL_MCLK_CONTROL,\n\t\t\t\t\t   CDC_WSA_MCLK_EN_MASK,\n\t\t\t\t\t   CDC_WSA_MCLK_DISABLE);\n\t\t}\n\t}\n}\n\nstatic int wsa_macro_mclk_event(struct snd_soc_dapm_widget *w,\n\t\t\t\tstruct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\twsa_macro_mclk_enable(wsa, event == SND_SOC_DAPM_PRE_PMU);\n\treturn 0;\n}\n\nstatic int wsa_macro_enable_vi_feedback(struct snd_soc_dapm_widget *w,\n\t\t\t\t\tstruct snd_kcontrol *kcontrol,\n\t\t\t\t\tint event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tu32 tx_reg0, tx_reg1;\n\n\tif (test_bit(WSA_MACRO_TX0, &wsa->active_ch_mask[WSA_MACRO_AIF_VI])) {\n\t\ttx_reg0 = CDC_WSA_TX0_SPKR_PROT_PATH_CTL;\n\t\ttx_reg1 = CDC_WSA_TX1_SPKR_PROT_PATH_CTL;\n\t} else if (test_bit(WSA_MACRO_TX1, &wsa->active_ch_mask[WSA_MACRO_AIF_VI])) {\n\t\ttx_reg0 = CDC_WSA_TX2_SPKR_PROT_PATH_CTL;\n\t\ttx_reg1 = CDC_WSA_TX3_SPKR_PROT_PATH_CTL;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t\t \n\t\tsnd_soc_component_update_bits(component, tx_reg0,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET);\n\t\tsnd_soc_component_update_bits(component, tx_reg1,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET);\n\t\tsnd_soc_component_update_bits(component, tx_reg0,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_PCM_RATE_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_PCM_RATE_8K);\n\t\tsnd_soc_component_update_bits(component, tx_reg1,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_PCM_RATE_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_PCM_RATE_8K);\n\t\tsnd_soc_component_update_bits(component, tx_reg0,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_ENABLE);\n\t\tsnd_soc_component_update_bits(component, tx_reg1,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_ENABLE);\n\t\tsnd_soc_component_update_bits(component, tx_reg0,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_NO_RESET);\n\t\tsnd_soc_component_update_bits(component, tx_reg1,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_NO_RESET);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tsnd_soc_component_update_bits(component, tx_reg0,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET);\n\t\tsnd_soc_component_update_bits(component, tx_reg1,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_RESET);\n\t\tsnd_soc_component_update_bits(component, tx_reg0,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_DISABLE);\n\t\tsnd_soc_component_update_bits(component, tx_reg1,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_TX_SPKR_PROT_CLK_DISABLE);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_enable_mix_path(struct snd_soc_dapm_widget *w,\n\t\t\t\t     struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tu16 path_reg, gain_reg;\n\tint val;\n\n\tswitch (w->shift) {\n\tcase WSA_MACRO_RX_MIX0:\n\t\tpath_reg = CDC_WSA_RX0_RX_PATH_MIX_CTL;\n\t\tgain_reg = CDC_WSA_RX0_RX_VOL_MIX_CTL;\n\t\tbreak;\n\tcase WSA_MACRO_RX_MIX1:\n\t\tpath_reg = CDC_WSA_RX1_RX_PATH_MIX_CTL;\n\t\tgain_reg = CDC_WSA_RX1_RX_VOL_MIX_CTL;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tval = snd_soc_component_read(component, gain_reg);\n\t\tsnd_soc_component_write(component, gain_reg, val);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_update_bits(component, path_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_MIX_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_RX_PATH_MIX_CLK_DISABLE);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void wsa_macro_hd2_control(struct snd_soc_component *component,\n\t\t\t\t  u16 reg, int event)\n{\n\tu16 hd2_scale_reg;\n\tu16 hd2_enable_reg;\n\n\tif (reg == CDC_WSA_RX0_RX_PATH_CTL) {\n\t\thd2_scale_reg = CDC_WSA_RX0_RX_PATH_SEC3;\n\t\thd2_enable_reg = CDC_WSA_RX0_RX_PATH_CFG0;\n\t}\n\tif (reg == CDC_WSA_RX1_RX_PATH_CTL) {\n\t\thd2_scale_reg = CDC_WSA_RX1_RX_PATH_SEC3;\n\t\thd2_enable_reg = CDC_WSA_RX1_RX_PATH_CFG0;\n\t}\n\n\tif (hd2_enable_reg && SND_SOC_DAPM_EVENT_ON(event)) {\n\t\tsnd_soc_component_update_bits(component, hd2_scale_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_ALPHA_MASK,\n\t\t\t\t\t      0x10);\n\t\tsnd_soc_component_update_bits(component, hd2_scale_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_SCALE_MASK,\n\t\t\t\t\t      0x1);\n\t\tsnd_soc_component_update_bits(component, hd2_enable_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_EN_MASK,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_ENABLE);\n\t}\n\n\tif (hd2_enable_reg && SND_SOC_DAPM_EVENT_OFF(event)) {\n\t\tsnd_soc_component_update_bits(component, hd2_enable_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_EN_MASK, 0);\n\t\tsnd_soc_component_update_bits(component, hd2_scale_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_SCALE_MASK,\n\t\t\t\t\t      0);\n\t\tsnd_soc_component_update_bits(component, hd2_scale_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_HD2_ALPHA_MASK,\n\t\t\t\t\t      0);\n\t}\n}\n\nstatic int wsa_macro_config_compander(struct snd_soc_component *component,\n\t\t\t\t      int comp, int event)\n{\n\tu16 comp_ctl0_reg, rx_path_cfg0_reg;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tif (!wsa->comp_enabled[comp])\n\t\treturn 0;\n\n\tcomp_ctl0_reg = CDC_WSA_COMPANDER0_CTL0 +\n\t\t\t\t\t(comp * WSA_MACRO_RX_COMP_OFFSET);\n\trx_path_cfg0_reg = CDC_WSA_RX0_RX_PATH_CFG0 +\n\t\t\t\t\t(comp * WSA_MACRO_RX_PATH_OFFSET);\n\n\tif (SND_SOC_DAPM_EVENT_ON(event)) {\n\t\t \n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_COMPANDER_CLK_ENABLE);\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_SOFT_RST_MASK,\n\t\t\t\t\t      CDC_WSA_COMPANDER_SOFT_RST_ENABLE);\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_SOFT_RST_MASK,\n\t\t\t\t\t      0);\n\t\tsnd_soc_component_update_bits(component, rx_path_cfg0_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_COMP_EN_MASK,\n\t\t\t\t\t      CDC_WSA_RX_PATH_COMP_ENABLE);\n\t}\n\n\tif (SND_SOC_DAPM_EVENT_OFF(event)) {\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_HALT_MASK,\n\t\t\t\t\t      CDC_WSA_COMPANDER_HALT);\n\t\tsnd_soc_component_update_bits(component, rx_path_cfg0_reg,\n\t\t\t\t\t      CDC_WSA_RX_PATH_COMP_EN_MASK, 0);\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_SOFT_RST_MASK,\n\t\t\t\t\t      CDC_WSA_COMPANDER_SOFT_RST_ENABLE);\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_SOFT_RST_MASK,\n\t\t\t\t\t      0);\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_CLK_EN_MASK, 0);\n\t\tsnd_soc_component_update_bits(component, comp_ctl0_reg,\n\t\t\t\t\t      CDC_WSA_COMPANDER_HALT_MASK, 0);\n\t}\n\n\treturn 0;\n}\n\nstatic void wsa_macro_enable_softclip_clk(struct snd_soc_component *component,\n\t\t\t\t\t struct wsa_macro *wsa,\n\t\t\t\t\t int path,\n\t\t\t\t\t bool enable)\n{\n\tu16 softclip_clk_reg = CDC_WSA_SOFTCLIP0_CRC +\n\t\t\t(path * WSA_MACRO_RX_SOFTCLIP_OFFSET);\n\tu8 softclip_mux_mask = (1 << path);\n\tu8 softclip_mux_value = (1 << path);\n\n\tif (enable) {\n\t\tif (wsa->softclip_clk_users[path] == 0) {\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t\tsoftclip_clk_reg,\n\t\t\t\t\t\tCDC_WSA_SOFTCLIP_CLK_EN_MASK,\n\t\t\t\t\t\tCDC_WSA_SOFTCLIP_CLK_ENABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\tCDC_WSA_RX_INP_MUX_SOFTCLIP_CFG0,\n\t\t\t\tsoftclip_mux_mask, softclip_mux_value);\n\t\t}\n\t\twsa->softclip_clk_users[path]++;\n\t} else {\n\t\twsa->softclip_clk_users[path]--;\n\t\tif (wsa->softclip_clk_users[path] == 0) {\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t\tsoftclip_clk_reg,\n\t\t\t\t\t\tCDC_WSA_SOFTCLIP_CLK_EN_MASK,\n\t\t\t\t\t\t0);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\tCDC_WSA_RX_INP_MUX_SOFTCLIP_CFG0,\n\t\t\t\tsoftclip_mux_mask, 0x00);\n\t\t}\n\t}\n}\n\nstatic int wsa_macro_config_softclip(struct snd_soc_component *component,\n\t\t\t\t     int path, int event)\n{\n\tu16 softclip_ctrl_reg;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tint softclip_path = 0;\n\n\tif (path == WSA_MACRO_COMP1)\n\t\tsoftclip_path = WSA_MACRO_SOFTCLIP0;\n\telse if (path == WSA_MACRO_COMP2)\n\t\tsoftclip_path = WSA_MACRO_SOFTCLIP1;\n\n\tif (!wsa->is_softclip_on[softclip_path])\n\t\treturn 0;\n\n\tsoftclip_ctrl_reg = CDC_WSA_SOFTCLIP0_SOFTCLIP_CTRL +\n\t\t\t\t(softclip_path * WSA_MACRO_RX_SOFTCLIP_OFFSET);\n\n\tif (SND_SOC_DAPM_EVENT_ON(event)) {\n\t\t \n\t\twsa_macro_enable_softclip_clk(component, wsa, softclip_path,\n\t\t\t\t\t      true);\n\t\t \n\t\tsnd_soc_component_update_bits(component, softclip_ctrl_reg,\n\t\t\t\t\t      CDC_WSA_SOFTCLIP_EN_MASK,\n\t\t\t\t\t      CDC_WSA_SOFTCLIP_ENABLE);\n\t}\n\n\tif (SND_SOC_DAPM_EVENT_OFF(event)) {\n\t\tsnd_soc_component_update_bits(component, softclip_ctrl_reg,\n\t\t\t\t\t      CDC_WSA_SOFTCLIP_EN_MASK, 0);\n\t\twsa_macro_enable_softclip_clk(component, wsa, softclip_path,\n\t\t\t\t\t      false);\n\t}\n\n\treturn 0;\n}\n\nstatic bool wsa_macro_adie_lb(struct snd_soc_component *component,\n\t\t\t      int interp_idx)\n{\n\tu16 int_mux_cfg0,  int_mux_cfg1;\n\tu8 int_n_inp0, int_n_inp1, int_n_inp2;\n\n\tint_mux_cfg0 = CDC_WSA_RX_INP_MUX_RX_INT0_CFG0 + interp_idx * 8;\n\tint_mux_cfg1 = int_mux_cfg0 + 4;\n\n\tint_n_inp0 = snd_soc_component_read_field(component, int_mux_cfg0,\n\t\t\t\t\t\t  CDC_WSA_RX_INTX_1_MIX_INP0_SEL_MASK);\n\tif (int_n_inp0 == INTn_1_INP_SEL_DEC0 ||\n\t\tint_n_inp0 == INTn_1_INP_SEL_DEC1)\n\t\treturn true;\n\n\tint_n_inp1 = snd_soc_component_read_field(component, int_mux_cfg0,\n\t\t\t\t\t\t  CDC_WSA_RX_INTX_1_MIX_INP1_SEL_MASK);\n\tif (int_n_inp1 == INTn_1_INP_SEL_DEC0 ||\n\t\tint_n_inp1 == INTn_1_INP_SEL_DEC1)\n\t\treturn true;\n\n\tint_n_inp2 = snd_soc_component_read_field(component, int_mux_cfg1,\n\t\t\t\t\t\t  CDC_WSA_RX_INTX_1_MIX_INP2_SEL_MASK);\n\tif (int_n_inp2 == INTn_1_INP_SEL_DEC0 ||\n\t\tint_n_inp2 == INTn_1_INP_SEL_DEC1)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic int wsa_macro_enable_main_path(struct snd_soc_dapm_widget *w,\n\t\t\t\t      struct snd_kcontrol *kcontrol,\n\t\t\t\t      int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tu16 reg;\n\n\treg = CDC_WSA_RX0_RX_PATH_CTL + WSA_MACRO_RX_PATH_OFFSET * w->shift;\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (wsa_macro_adie_lb(component, w->shift)) {\n\t\t\tsnd_soc_component_update_bits(component, reg,\n\t\t\t\t\t     CDC_WSA_RX_PATH_CLK_EN_MASK,\n\t\t\t\t\t     CDC_WSA_RX_PATH_CLK_ENABLE);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wsa_macro_interp_get_primary_reg(u16 reg, u16 *ind)\n{\n\tu16 prim_int_reg = 0;\n\n\tswitch (reg) {\n\tcase CDC_WSA_RX0_RX_PATH_CTL:\n\tcase CDC_WSA_RX0_RX_PATH_MIX_CTL:\n\t\tprim_int_reg = CDC_WSA_RX0_RX_PATH_CTL;\n\t\t*ind = 0;\n\t\tbreak;\n\tcase CDC_WSA_RX1_RX_PATH_CTL:\n\tcase CDC_WSA_RX1_RX_PATH_MIX_CTL:\n\t\tprim_int_reg = CDC_WSA_RX1_RX_PATH_CTL;\n\t\t*ind = 1;\n\t\tbreak;\n\t}\n\n\treturn prim_int_reg;\n}\n\nstatic int wsa_macro_enable_prim_interpolator(struct snd_soc_component *component,\n\t\t\t\t\t      u16 reg, int event)\n{\n\tu16 prim_int_reg;\n\tu16 ind = 0;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tprim_int_reg = wsa_macro_interp_get_primary_reg(reg, &ind);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\twsa->prim_int_users[ind]++;\n\t\tif (wsa->prim_int_users[ind] == 1) {\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t\t      prim_int_reg + WSA_MACRO_RX_PATH_CFG3_OFFSET,\n\t\t\t\t\t\t      CDC_WSA_RX_DC_DCOEFF_MASK,\n\t\t\t\t\t\t      0x3);\n\t\t\tsnd_soc_component_update_bits(component, prim_int_reg,\n\t\t\t\t\tCDC_WSA_RX_PATH_PGA_MUTE_EN_MASK,\n\t\t\t\t\tCDC_WSA_RX_PATH_PGA_MUTE_ENABLE);\n\t\t\twsa_macro_hd2_control(component, prim_int_reg, event);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\tprim_int_reg + WSA_MACRO_RX_PATH_DSMDEM_OFFSET,\n\t\t\t\tCDC_WSA_RX_DSMDEM_CLK_EN_MASK,\n\t\t\t\tCDC_WSA_RX_DSMDEM_CLK_ENABLE);\n\t\t}\n\t\tif ((reg != prim_int_reg) &&\n\t\t    ((snd_soc_component_read(\n\t\t\t\tcomponent, prim_int_reg)) & 0x10))\n\t\t\tsnd_soc_component_update_bits(component, reg,\n\t\t\t\t\t0x10, 0x10);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\twsa->prim_int_users[ind]--;\n\t\tif (wsa->prim_int_users[ind] == 0) {\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\tprim_int_reg + WSA_MACRO_RX_PATH_DSMDEM_OFFSET,\n\t\t\t\tCDC_WSA_RX_DSMDEM_CLK_EN_MASK, 0);\n\t\t\twsa_macro_hd2_control(component, prim_int_reg, event);\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_config_ear_spkr_gain(struct snd_soc_component *component,\n\t\t\t\t\t  struct wsa_macro *wsa,\n\t\t\t\t\t  int event, int gain_reg)\n{\n\tint comp_gain_offset, val;\n\n\tswitch (wsa->spkr_mode) {\n\t \n\tcase WSA_MACRO_SPKR_MODE_1:\n\t\tcomp_gain_offset = -12;\n\t\tbreak;\n\t \n\tdefault:\n\t\tcomp_gain_offset = -15;\n\t\tbreak;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\tif (wsa->comp_enabled[WSA_MACRO_COMP1] &&\n\t\t    (gain_reg == CDC_WSA_RX0_RX_VOL_CTL) &&\n\t\t    (wsa->ear_spkr_gain != 0)) {\n\t\t\t \n\t\t\tval = comp_gain_offset + wsa->ear_spkr_gain - 1;\n\t\t\tsnd_soc_component_write(component, gain_reg, val);\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tif (wsa->comp_enabled[WSA_MACRO_COMP1] &&\n\t\t    (gain_reg == CDC_WSA_RX0_RX_VOL_CTL) &&\n\t\t    (wsa->ear_spkr_gain != 0)) {\n\t\t\tsnd_soc_component_write(component, gain_reg, 0x0);\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_enable_interpolator(struct snd_soc_dapm_widget *w,\n\t\t\t\t\t struct snd_kcontrol *kcontrol,\n\t\t\t\t\t int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tu16 gain_reg;\n\tu16 reg;\n\tint val;\n\tint offset_val = 0;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tif (w->shift == WSA_MACRO_COMP1) {\n\t\treg = CDC_WSA_RX0_RX_PATH_CTL;\n\t\tgain_reg = CDC_WSA_RX0_RX_VOL_CTL;\n\t} else if (w->shift == WSA_MACRO_COMP2) {\n\t\treg = CDC_WSA_RX1_RX_PATH_CTL;\n\t\tgain_reg = CDC_WSA_RX1_RX_VOL_CTL;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\twsa_macro_enable_prim_interpolator(component, reg, event);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\twsa_macro_config_compander(component, w->shift, event);\n\t\twsa_macro_config_softclip(component, w->shift, event);\n\t\t \n\t\tif ((wsa->spkr_gain_offset == WSA_MACRO_GAIN_OFFSET_M1P5_DB) &&\n\t\t    (wsa->comp_enabled[WSA_MACRO_COMP1] ||\n\t\t     wsa->comp_enabled[WSA_MACRO_COMP2])) {\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX0_RX_PATH_SEC1,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_ENABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX0_RX_PATH_MIX_SEC0,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_ENABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX1_RX_PATH_SEC1,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_ENABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX1_RX_PATH_MIX_SEC0,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_ENABLE);\n\t\t\toffset_val = -2;\n\t\t}\n\t\tval = snd_soc_component_read(component, gain_reg);\n\t\tval += offset_val;\n\t\tsnd_soc_component_write(component, gain_reg, val);\n\t\twsa_macro_config_ear_spkr_gain(component, wsa,\n\t\t\t\t\t\tevent, gain_reg);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\twsa_macro_config_compander(component, w->shift, event);\n\t\twsa_macro_config_softclip(component, w->shift, event);\n\t\twsa_macro_enable_prim_interpolator(component, reg, event);\n\t\tif ((wsa->spkr_gain_offset == WSA_MACRO_GAIN_OFFSET_M1P5_DB) &&\n\t\t    (wsa->comp_enabled[WSA_MACRO_COMP1] ||\n\t\t     wsa->comp_enabled[WSA_MACRO_COMP2])) {\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX0_RX_PATH_SEC1,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_DISABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX0_RX_PATH_MIX_SEC0,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_DISABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX1_RX_PATH_SEC1,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_DISABLE);\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tCDC_WSA_RX1_RX_PATH_MIX_SEC0,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_MASK,\n\t\t\t\t\tCDC_WSA_RX_PGA_HALF_DB_DISABLE);\n\t\t\toffset_val = 2;\n\t\t\tval = snd_soc_component_read(component, gain_reg);\n\t\t\tval += offset_val;\n\t\t\tsnd_soc_component_write(component, gain_reg, val);\n\t\t}\n\t\twsa_macro_config_ear_spkr_gain(component, wsa,\n\t\t\t\t\t\tevent, gain_reg);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_spk_boost_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t\t     int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tu16 boost_path_ctl, boost_path_cfg1;\n\tu16 reg, reg_mix;\n\n\tif (!snd_soc_dapm_widget_name_cmp(w, \"WSA_RX INT0 CHAIN\")) {\n\t\tboost_path_ctl = CDC_WSA_BOOST0_BOOST_PATH_CTL;\n\t\tboost_path_cfg1 = CDC_WSA_RX0_RX_PATH_CFG1;\n\t\treg = CDC_WSA_RX0_RX_PATH_CTL;\n\t\treg_mix = CDC_WSA_RX0_RX_PATH_MIX_CTL;\n\t} else if (!snd_soc_dapm_widget_name_cmp(w, \"WSA_RX INT1 CHAIN\")) {\n\t\tboost_path_ctl = CDC_WSA_BOOST1_BOOST_PATH_CTL;\n\t\tboost_path_cfg1 = CDC_WSA_RX1_RX_PATH_CFG1;\n\t\treg = CDC_WSA_RX1_RX_PATH_CTL;\n\t\treg_mix = CDC_WSA_RX1_RX_PATH_MIX_CTL;\n\t} else {\n\t\tdev_warn(component->dev, \"Incorrect widget name in the driver\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tsnd_soc_component_update_bits(component, boost_path_cfg1,\n\t\t\t\t\t      CDC_WSA_RX_PATH_SMART_BST_EN_MASK,\n\t\t\t\t\t      CDC_WSA_RX_PATH_SMART_BST_ENABLE);\n\t\tsnd_soc_component_update_bits(component, boost_path_ctl,\n\t\t\t\t\t      CDC_WSA_BOOST_PATH_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_BOOST_PATH_CLK_ENABLE);\n\t\tif ((snd_soc_component_read(component, reg_mix)) & 0x10)\n\t\t\tsnd_soc_component_update_bits(component, reg_mix,\n\t\t\t\t\t\t0x10, 0x00);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tsnd_soc_component_update_bits(component, reg, 0x10, 0x00);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tsnd_soc_component_update_bits(component, boost_path_ctl,\n\t\t\t\t\t      CDC_WSA_BOOST_PATH_CLK_EN_MASK,\n\t\t\t\t\t      CDC_WSA_BOOST_PATH_CLK_DISABLE);\n\t\tsnd_soc_component_update_bits(component, boost_path_cfg1,\n\t\t\t\t\t      CDC_WSA_RX_PATH_SMART_BST_EN_MASK,\n\t\t\t\t\t      CDC_WSA_RX_PATH_SMART_BST_DISABLE);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_enable_echo(struct snd_soc_dapm_widget *w,\n\t\t\t\t struct snd_kcontrol *kcontrol,\n\t\t\t\t int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tu16 val, ec_tx, ec_hq_reg;\n\n\tval = snd_soc_component_read(component, CDC_WSA_RX_INP_MUX_RX_MIX_CFG0);\n\n\tswitch (w->shift) {\n\tcase WSA_MACRO_EC0_MUX:\n\t\tval = val & CDC_WSA_RX_MIX_TX0_SEL_MASK;\n\t\tec_tx = val - 1;\n\t\tbreak;\n\tcase WSA_MACRO_EC1_MUX:\n\t\tval = val & CDC_WSA_RX_MIX_TX1_SEL_MASK;\n\t\tec_tx = (val >> CDC_WSA_RX_MIX_TX1_SEL_SHFT) - 1;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev,\t\"%s: Invalid shift %u\\n\",\n\t\t\t__func__, w->shift);\n\t\treturn -EINVAL;\n\t}\n\n\tif (wsa->ec_hq[ec_tx]) {\n\t\tec_hq_reg = CDC_WSA_EC_HQ0_EC_REF_HQ_PATH_CTL +\t0x40 * ec_tx;\n\t\tsnd_soc_component_update_bits(component, ec_hq_reg,\n\t\t\t\t\t     CDC_WSA_EC_HQ_EC_CLK_EN_MASK,\n\t\t\t\t\t     CDC_WSA_EC_HQ_EC_CLK_ENABLE);\n\t\tec_hq_reg = CDC_WSA_EC_HQ0_EC_REF_HQ_CFG0 + 0x40 * ec_tx;\n\t\t \n\t\tsnd_soc_component_update_bits(component, ec_hq_reg,\n\t\t\t\t      CDC_WSA_EC_HQ_EC_REF_PCM_RATE_MASK,\n\t\t\t\t      CDC_WSA_EC_HQ_EC_REF_PCM_RATE_48K);\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_get_ec_hq(struct snd_kcontrol *kcontrol,\n\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tint ec_tx = ((struct soc_mixer_control *) kcontrol->private_value)->shift;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = wsa->ec_hq[ec_tx];\n\n\treturn 0;\n}\n\nstatic int wsa_macro_set_ec_hq(struct snd_kcontrol *kcontrol,\n\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tint ec_tx = ((struct soc_mixer_control *) kcontrol->private_value)->shift;\n\tint value = ucontrol->value.integer.value[0];\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\twsa->ec_hq[ec_tx] = value;\n\n\treturn 0;\n}\n\nstatic int wsa_macro_get_compander(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tint comp = ((struct soc_mixer_control *) kcontrol->private_value)->shift;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = wsa->comp_enabled[comp];\n\treturn 0;\n}\n\nstatic int wsa_macro_set_compander(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tint comp = ((struct soc_mixer_control *) kcontrol->private_value)->shift;\n\tint value = ucontrol->value.integer.value[0];\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\twsa->comp_enabled[comp] = value;\n\n\treturn 0;\n}\n\nstatic int wsa_macro_ear_spkr_pa_gain_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = wsa->ear_spkr_gain;\n\n\treturn 0;\n}\n\nstatic int wsa_macro_ear_spkr_pa_gain_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\twsa->ear_spkr_gain =  ucontrol->value.integer.value[0];\n\n\treturn 0;\n}\n\nstatic int wsa_macro_rx_mux_get(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dapm_widget *widget =\n\t\tsnd_soc_dapm_kcontrol_widget(kcontrol);\n\tstruct snd_soc_component *component =\n\t\t\t\tsnd_soc_dapm_to_component(widget->dapm);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] =\n\t\t\twsa->rx_port_value[widget->shift];\n\treturn 0;\n}\n\nstatic int wsa_macro_rx_mux_put(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dapm_widget *widget =\n\t\tsnd_soc_dapm_kcontrol_widget(kcontrol);\n\tstruct snd_soc_component *component =\n\t\t\t\tsnd_soc_dapm_to_component(widget->dapm);\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tstruct snd_soc_dapm_update *update = NULL;\n\tu32 rx_port_value = ucontrol->value.integer.value[0];\n\tu32 bit_input;\n\tu32 aif_rst;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\n\taif_rst = wsa->rx_port_value[widget->shift];\n\tif (!rx_port_value) {\n\t\tif (aif_rst == 0)\n\t\t\treturn 0;\n\t\tif (aif_rst >= WSA_MACRO_RX_MAX) {\n\t\t\tdev_err(component->dev, \"%s: Invalid AIF reset\\n\", __func__);\n\t\t\treturn 0;\n\t\t}\n\t}\n\twsa->rx_port_value[widget->shift] = rx_port_value;\n\n\tbit_input = widget->shift;\n\n\tswitch (rx_port_value) {\n\tcase 0:\n\t\tif (wsa->active_ch_cnt[aif_rst]) {\n\t\t\tclear_bit(bit_input,\n\t\t\t\t  &wsa->active_ch_mask[aif_rst]);\n\t\t\twsa->active_ch_cnt[aif_rst]--;\n\t\t}\n\t\tbreak;\n\tcase 1:\n\tcase 2:\n\t\tset_bit(bit_input,\n\t\t\t&wsa->active_ch_mask[rx_port_value]);\n\t\twsa->active_ch_cnt[rx_port_value]++;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev,\n\t\t\t\"%s: Invalid AIF_ID for WSA RX MUX %d\\n\",\n\t\t\t__func__, rx_port_value);\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_dapm_mux_update_power(widget->dapm, kcontrol,\n\t\t\t\t\trx_port_value, e, update);\n\treturn 0;\n}\n\nstatic int wsa_macro_soft_clip_enable_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tint path = ((struct soc_mixer_control *)kcontrol->private_value)->shift;\n\n\tucontrol->value.integer.value[0] = wsa->is_softclip_on[path];\n\n\treturn 0;\n}\n\nstatic int wsa_macro_soft_clip_enable_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tint path = ((struct soc_mixer_control *) kcontrol->private_value)->shift;\n\n\twsa->is_softclip_on[path] =  ucontrol->value.integer.value[0];\n\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new wsa_macro_snd_controls[] = {\n\tSOC_ENUM_EXT(\"EAR SPKR PA Gain\", wsa_macro_ear_spkr_pa_gain_enum,\n\t\t     wsa_macro_ear_spkr_pa_gain_get,\n\t\t     wsa_macro_ear_spkr_pa_gain_put),\n\tSOC_SINGLE_EXT(\"WSA_Softclip0 Enable\", SND_SOC_NOPM,\n\t\t\tWSA_MACRO_SOFTCLIP0, 1, 0,\n\t\t\twsa_macro_soft_clip_enable_get,\n\t\t\twsa_macro_soft_clip_enable_put),\n\tSOC_SINGLE_EXT(\"WSA_Softclip1 Enable\", SND_SOC_NOPM,\n\t\t\tWSA_MACRO_SOFTCLIP1, 1, 0,\n\t\t\twsa_macro_soft_clip_enable_get,\n\t\t\twsa_macro_soft_clip_enable_put),\n\n\tSOC_SINGLE_S8_TLV(\"WSA_RX0 Digital Volume\", CDC_WSA_RX0_RX_VOL_CTL,\n\t\t\t  -84, 40, digital_gain),\n\tSOC_SINGLE_S8_TLV(\"WSA_RX1 Digital Volume\", CDC_WSA_RX1_RX_VOL_CTL,\n\t\t\t  -84, 40, digital_gain),\n\n\tSOC_SINGLE(\"WSA_RX0 Digital Mute\", CDC_WSA_RX0_RX_PATH_CTL, 4, 1, 0),\n\tSOC_SINGLE(\"WSA_RX1 Digital Mute\", CDC_WSA_RX1_RX_PATH_CTL, 4, 1, 0),\n\tSOC_SINGLE(\"WSA_RX0_MIX Digital Mute\", CDC_WSA_RX0_RX_PATH_MIX_CTL, 4,\n\t\t   1, 0),\n\tSOC_SINGLE(\"WSA_RX1_MIX Digital Mute\", CDC_WSA_RX1_RX_PATH_MIX_CTL, 4,\n\t\t   1, 0),\n\tSOC_SINGLE_EXT(\"WSA_COMP1 Switch\", SND_SOC_NOPM, WSA_MACRO_COMP1, 1, 0,\n\t\t       wsa_macro_get_compander, wsa_macro_set_compander),\n\tSOC_SINGLE_EXT(\"WSA_COMP2 Switch\", SND_SOC_NOPM, WSA_MACRO_COMP2, 1, 0,\n\t\t       wsa_macro_get_compander, wsa_macro_set_compander),\n\tSOC_SINGLE_EXT(\"WSA_RX0 EC_HQ Switch\", SND_SOC_NOPM, WSA_MACRO_RX0, 1, 0,\n\t\t       wsa_macro_get_ec_hq, wsa_macro_set_ec_hq),\n\tSOC_SINGLE_EXT(\"WSA_RX1 EC_HQ Switch\", SND_SOC_NOPM, WSA_MACRO_RX1, 1, 0,\n\t\t       wsa_macro_get_ec_hq, wsa_macro_set_ec_hq),\n};\n\nstatic const struct soc_enum rx_mux_enum =\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(rx_mux_text), rx_mux_text);\n\nstatic const struct snd_kcontrol_new rx_mux[WSA_MACRO_RX_MAX] = {\n\tSOC_DAPM_ENUM_EXT(\"WSA RX0 Mux\", rx_mux_enum,\n\t\t\t  wsa_macro_rx_mux_get, wsa_macro_rx_mux_put),\n\tSOC_DAPM_ENUM_EXT(\"WSA RX1 Mux\", rx_mux_enum,\n\t\t\t  wsa_macro_rx_mux_get, wsa_macro_rx_mux_put),\n\tSOC_DAPM_ENUM_EXT(\"WSA RX_MIX0 Mux\", rx_mux_enum,\n\t\t\t  wsa_macro_rx_mux_get, wsa_macro_rx_mux_put),\n\tSOC_DAPM_ENUM_EXT(\"WSA RX_MIX1 Mux\", rx_mux_enum,\n\t\t\t  wsa_macro_rx_mux_get, wsa_macro_rx_mux_put),\n};\n\nstatic int wsa_macro_vi_feed_mixer_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dapm_widget *widget = snd_soc_dapm_kcontrol_widget(kcontrol);\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(widget->dapm);\n\tstruct soc_mixer_control *mixer = (struct soc_mixer_control *)kcontrol->private_value;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tu32 spk_tx_id = mixer->shift;\n\tu32 dai_id = widget->shift;\n\n\tif (test_bit(spk_tx_id, &wsa->active_ch_mask[dai_id]))\n\t\tucontrol->value.integer.value[0] = 1;\n\telse\n\t\tucontrol->value.integer.value[0] = 0;\n\n\treturn 0;\n}\n\nstatic int wsa_macro_vi_feed_mixer_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_dapm_widget *widget = snd_soc_dapm_kcontrol_widget(kcontrol);\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(widget->dapm);\n\tstruct soc_mixer_control *mixer = (struct soc_mixer_control *)kcontrol->private_value;\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(component);\n\tu32 enable = ucontrol->value.integer.value[0];\n\tu32 spk_tx_id = mixer->shift;\n\n\tif (enable) {\n\t\tif (spk_tx_id == WSA_MACRO_TX0 &&\n\t\t\t!test_bit(WSA_MACRO_TX0,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI])) {\n\t\t\tset_bit(WSA_MACRO_TX0,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI]);\n\t\t\twsa->active_ch_cnt[WSA_MACRO_AIF_VI]++;\n\t\t}\n\t\tif (spk_tx_id == WSA_MACRO_TX1 &&\n\t\t\t!test_bit(WSA_MACRO_TX1,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI])) {\n\t\t\tset_bit(WSA_MACRO_TX1,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI]);\n\t\t\twsa->active_ch_cnt[WSA_MACRO_AIF_VI]++;\n\t\t}\n\t} else {\n\t\tif (spk_tx_id == WSA_MACRO_TX0 &&\n\t\t\ttest_bit(WSA_MACRO_TX0,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI])) {\n\t\t\tclear_bit(WSA_MACRO_TX0,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI]);\n\t\t\twsa->active_ch_cnt[WSA_MACRO_AIF_VI]--;\n\t\t}\n\t\tif (spk_tx_id == WSA_MACRO_TX1 &&\n\t\t\ttest_bit(WSA_MACRO_TX1,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI])) {\n\t\t\tclear_bit(WSA_MACRO_TX1,\n\t\t\t\t&wsa->active_ch_mask[WSA_MACRO_AIF_VI]);\n\t\t\twsa->active_ch_cnt[WSA_MACRO_AIF_VI]--;\n\t\t}\n\t}\n\tsnd_soc_dapm_mixer_update_power(widget->dapm, kcontrol, enable, NULL);\n\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new aif_vi_mixer[] = {\n\tSOC_SINGLE_EXT(\"WSA_SPKR_VI_1\", SND_SOC_NOPM, WSA_MACRO_TX0, 1, 0,\n\t\t\twsa_macro_vi_feed_mixer_get,\n\t\t\twsa_macro_vi_feed_mixer_put),\n\tSOC_SINGLE_EXT(\"WSA_SPKR_VI_2\", SND_SOC_NOPM, WSA_MACRO_TX1, 1, 0,\n\t\t\twsa_macro_vi_feed_mixer_get,\n\t\t\twsa_macro_vi_feed_mixer_put),\n};\n\nstatic const struct snd_soc_dapm_widget wsa_macro_dapm_widgets[] = {\n\tSND_SOC_DAPM_AIF_IN(\"WSA AIF1 PB\", \"WSA_AIF1 Playback\", 0,\n\t\t\t    SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_IN(\"WSA AIF_MIX1 PB\", \"WSA_AIF_MIX1 Playback\", 0,\n\t\t\t    SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_OUT_E(\"WSA AIF_VI\", \"WSA_AIF_VI Capture\", 0,\n\t\t\t       SND_SOC_NOPM, WSA_MACRO_AIF_VI, 0,\n\t\t\t       wsa_macro_enable_vi_feedback,\n\t\t\t       SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_AIF_OUT(\"WSA AIF_ECHO\", \"WSA_AIF_ECHO Capture\", 0,\n\t\t\t     SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_MIXER(\"WSA_AIF_VI Mixer\", SND_SOC_NOPM, WSA_MACRO_AIF_VI,\n\t\t\t   0, aif_vi_mixer, ARRAY_SIZE(aif_vi_mixer)),\n\tSND_SOC_DAPM_MUX_E(\"WSA RX_MIX EC0_MUX\", SND_SOC_NOPM,\n\t\t\t   WSA_MACRO_EC0_MUX, 0,\n\t\t\t   &rx_mix_ec0_mux, wsa_macro_enable_echo,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MUX_E(\"WSA RX_MIX EC1_MUX\", SND_SOC_NOPM,\n\t\t\t   WSA_MACRO_EC1_MUX, 0,\n\t\t\t   &rx_mix_ec1_mux, wsa_macro_enable_echo,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MUX(\"WSA RX0 MUX\", SND_SOC_NOPM, WSA_MACRO_RX0, 0,\n\t\t\t &rx_mux[WSA_MACRO_RX0]),\n\tSND_SOC_DAPM_MUX(\"WSA RX1 MUX\", SND_SOC_NOPM, WSA_MACRO_RX1, 0,\n\t\t\t &rx_mux[WSA_MACRO_RX1]),\n\tSND_SOC_DAPM_MUX(\"WSA RX_MIX0 MUX\", SND_SOC_NOPM, WSA_MACRO_RX_MIX0, 0,\n\t\t\t &rx_mux[WSA_MACRO_RX_MIX0]),\n\tSND_SOC_DAPM_MUX(\"WSA RX_MIX1 MUX\", SND_SOC_NOPM, WSA_MACRO_RX_MIX1, 0,\n\t\t\t &rx_mux[WSA_MACRO_RX_MIX1]),\n\n\tSND_SOC_DAPM_MIXER(\"WSA RX0\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"WSA RX1\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"WSA RX_MIX0\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"WSA RX_MIX1\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MUX(\"WSA_RX0 INP0\", SND_SOC_NOPM, 0, 0, &rx0_prim_inp0_mux),\n\tSND_SOC_DAPM_MUX(\"WSA_RX0 INP1\", SND_SOC_NOPM, 0, 0, &rx0_prim_inp1_mux),\n\tSND_SOC_DAPM_MUX(\"WSA_RX0 INP2\", SND_SOC_NOPM, 0, 0, &rx0_prim_inp2_mux),\n\tSND_SOC_DAPM_MUX_E(\"WSA_RX0 MIX INP\", SND_SOC_NOPM, WSA_MACRO_RX_MIX0,\n\t\t\t   0, &rx0_mix_mux, wsa_macro_enable_mix_path,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_MUX(\"WSA_RX1 INP0\", SND_SOC_NOPM, 0, 0, &rx1_prim_inp0_mux),\n\tSND_SOC_DAPM_MUX(\"WSA_RX1 INP1\", SND_SOC_NOPM, 0, 0, &rx1_prim_inp1_mux),\n\tSND_SOC_DAPM_MUX(\"WSA_RX1 INP2\", SND_SOC_NOPM, 0, 0, &rx1_prim_inp2_mux),\n\tSND_SOC_DAPM_MUX_E(\"WSA_RX1 MIX INP\", SND_SOC_NOPM, WSA_MACRO_RX_MIX1,\n\t\t\t   0, &rx1_mix_mux, wsa_macro_enable_mix_path,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MIXER_E(\"WSA_RX INT0 MIX\", SND_SOC_NOPM, 0, 0, NULL, 0,\n\t\t\t     wsa_macro_enable_main_path, SND_SOC_DAPM_PRE_PMU),\n\tSND_SOC_DAPM_MIXER_E(\"WSA_RX INT1 MIX\", SND_SOC_NOPM, 1, 0, NULL, 0,\n\t\t\t     wsa_macro_enable_main_path, SND_SOC_DAPM_PRE_PMU),\n\n\tSND_SOC_DAPM_MIXER(\"WSA_RX INT0 SEC MIX\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"WSA_RX INT1 SEC MIX\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MUX(\"WSA_RX0 INT0 SIDETONE MIX\", CDC_WSA_RX0_RX_PATH_CFG1,\n\t\t\t 4, 0, &rx0_sidetone_mix_mux),\n\n\tSND_SOC_DAPM_INPUT(\"WSA SRC0_INP\"),\n\tSND_SOC_DAPM_INPUT(\"WSA_TX DEC0_INP\"),\n\tSND_SOC_DAPM_INPUT(\"WSA_TX DEC1_INP\"),\n\n\tSND_SOC_DAPM_MIXER_E(\"WSA_RX INT0 INTERP\", SND_SOC_NOPM,\n\t\t\t     WSA_MACRO_COMP1, 0, NULL, 0,\n\t\t\t     wsa_macro_enable_interpolator,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t     SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MIXER_E(\"WSA_RX INT1 INTERP\", SND_SOC_NOPM,\n\t\t\t     WSA_MACRO_COMP2, 0, NULL, 0,\n\t\t\t     wsa_macro_enable_interpolator,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t     SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MIXER_E(\"WSA_RX INT0 CHAIN\", SND_SOC_NOPM, 0, 0,\n\t\t\t     NULL, 0, wsa_macro_spk_boost_event,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t     SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MIXER_E(\"WSA_RX INT1 CHAIN\", SND_SOC_NOPM, 0, 0,\n\t\t\t     NULL, 0, wsa_macro_spk_boost_event,\n\t\t\t     SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t     SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_INPUT(\"VIINPUT_WSA\"),\n\tSND_SOC_DAPM_OUTPUT(\"WSA_SPK1 OUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"WSA_SPK2 OUT\"),\n\n\tSND_SOC_DAPM_SUPPLY(\"WSA_RX0_CLK\", CDC_WSA_RX0_RX_PATH_CTL, 5, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"WSA_RX1_CLK\", CDC_WSA_RX1_RX_PATH_CTL, 5, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"WSA_RX_MIX0_CLK\", CDC_WSA_RX0_RX_PATH_MIX_CTL, 5, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"WSA_RX_MIX1_CLK\", CDC_WSA_RX1_RX_PATH_MIX_CTL, 5, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"WSA_MCLK\", 0, SND_SOC_NOPM, 0, 0,\n\t\t\t      wsa_macro_mclk_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n};\n\nstatic const struct snd_soc_dapm_route wsa_audio_map[] = {\n\t \n\t{\"WSA_AIF_VI Mixer\", \"WSA_SPKR_VI_1\", \"VIINPUT_WSA\"},\n\t{\"WSA_AIF_VI Mixer\", \"WSA_SPKR_VI_2\", \"VIINPUT_WSA\"},\n\t{\"WSA AIF_VI\", NULL, \"WSA_AIF_VI Mixer\"},\n\t{\"WSA AIF_VI\", NULL, \"WSA_MCLK\"},\n\n\t{\"WSA RX_MIX EC0_MUX\", \"RX_MIX_TX0\", \"WSA_RX INT0 SEC MIX\"},\n\t{\"WSA RX_MIX EC1_MUX\", \"RX_MIX_TX0\", \"WSA_RX INT0 SEC MIX\"},\n\t{\"WSA RX_MIX EC0_MUX\", \"RX_MIX_TX1\", \"WSA_RX INT1 SEC MIX\"},\n\t{\"WSA RX_MIX EC1_MUX\", \"RX_MIX_TX1\", \"WSA_RX INT1 SEC MIX\"},\n\t{\"WSA AIF_ECHO\", NULL, \"WSA RX_MIX EC0_MUX\"},\n\t{\"WSA AIF_ECHO\", NULL, \"WSA RX_MIX EC1_MUX\"},\n\t{\"WSA AIF_ECHO\", NULL, \"WSA_MCLK\"},\n\n\t{\"WSA AIF1 PB\", NULL, \"WSA_MCLK\"},\n\t{\"WSA AIF_MIX1 PB\", NULL, \"WSA_MCLK\"},\n\n\t{\"WSA RX0 MUX\", \"AIF1_PB\", \"WSA AIF1 PB\"},\n\t{\"WSA RX1 MUX\", \"AIF1_PB\", \"WSA AIF1 PB\"},\n\t{\"WSA RX_MIX0 MUX\", \"AIF1_PB\", \"WSA AIF1 PB\"},\n\t{\"WSA RX_MIX1 MUX\", \"AIF1_PB\", \"WSA AIF1 PB\"},\n\n\t{\"WSA RX0 MUX\", \"AIF_MIX1_PB\", \"WSA AIF_MIX1 PB\"},\n\t{\"WSA RX1 MUX\", \"AIF_MIX1_PB\", \"WSA AIF_MIX1 PB\"},\n\t{\"WSA RX_MIX0 MUX\", \"AIF_MIX1_PB\", \"WSA AIF_MIX1 PB\"},\n\t{\"WSA RX_MIX1 MUX\", \"AIF_MIX1_PB\", \"WSA AIF_MIX1 PB\"},\n\n\t{\"WSA RX0\", NULL, \"WSA RX0 MUX\"},\n\t{\"WSA RX1\", NULL, \"WSA RX1 MUX\"},\n\t{\"WSA RX_MIX0\", NULL, \"WSA RX_MIX0 MUX\"},\n\t{\"WSA RX_MIX1\", NULL, \"WSA RX_MIX1 MUX\"},\n\n\t{\"WSA RX0\", NULL, \"WSA_RX0_CLK\"},\n\t{\"WSA RX1\", NULL, \"WSA_RX1_CLK\"},\n\t{\"WSA RX_MIX0\", NULL, \"WSA_RX_MIX0_CLK\"},\n\t{\"WSA RX_MIX1\", NULL, \"WSA_RX_MIX1_CLK\"},\n\n\t{\"WSA_RX0 INP0\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX0 INP0\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX0 INP0\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX0 INP0\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX0 INP0\", \"DEC0\", \"WSA_TX DEC0_INP\"},\n\t{\"WSA_RX0 INP0\", \"DEC1\", \"WSA_TX DEC1_INP\"},\n\t{\"WSA_RX INT0 MIX\", NULL, \"WSA_RX0 INP0\"},\n\n\t{\"WSA_RX0 INP1\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX0 INP1\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX0 INP1\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX0 INP1\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX0 INP1\", \"DEC0\", \"WSA_TX DEC0_INP\"},\n\t{\"WSA_RX0 INP1\", \"DEC1\", \"WSA_TX DEC1_INP\"},\n\t{\"WSA_RX INT0 MIX\", NULL, \"WSA_RX0 INP1\"},\n\n\t{\"WSA_RX0 INP2\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX0 INP2\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX0 INP2\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX0 INP2\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX0 INP2\", \"DEC0\", \"WSA_TX DEC0_INP\"},\n\t{\"WSA_RX0 INP2\", \"DEC1\", \"WSA_TX DEC1_INP\"},\n\t{\"WSA_RX INT0 MIX\", NULL, \"WSA_RX0 INP2\"},\n\n\t{\"WSA_RX0 MIX INP\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX0 MIX INP\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX0 MIX INP\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX0 MIX INP\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX INT0 SEC MIX\", NULL, \"WSA_RX0 MIX INP\"},\n\n\t{\"WSA_RX INT0 SEC MIX\", NULL, \"WSA_RX INT0 MIX\"},\n\t{\"WSA_RX INT0 INTERP\", NULL, \"WSA_RX INT0 SEC MIX\"},\n\t{\"WSA_RX0 INT0 SIDETONE MIX\", \"SRC0\", \"WSA SRC0_INP\"},\n\t{\"WSA_RX INT0 INTERP\", NULL, \"WSA_RX0 INT0 SIDETONE MIX\"},\n\t{\"WSA_RX INT0 CHAIN\", NULL, \"WSA_RX INT0 INTERP\"},\n\n\t{\"WSA_SPK1 OUT\", NULL, \"WSA_RX INT0 CHAIN\"},\n\t{\"WSA_SPK1 OUT\", NULL, \"WSA_MCLK\"},\n\n\t{\"WSA_RX1 INP0\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX1 INP0\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX1 INP0\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX1 INP0\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX1 INP0\", \"DEC0\", \"WSA_TX DEC0_INP\"},\n\t{\"WSA_RX1 INP0\", \"DEC1\", \"WSA_TX DEC1_INP\"},\n\t{\"WSA_RX INT1 MIX\", NULL, \"WSA_RX1 INP0\"},\n\n\t{\"WSA_RX1 INP1\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX1 INP1\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX1 INP1\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX1 INP1\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX1 INP1\", \"DEC0\", \"WSA_TX DEC0_INP\"},\n\t{\"WSA_RX1 INP1\", \"DEC1\", \"WSA_TX DEC1_INP\"},\n\t{\"WSA_RX INT1 MIX\", NULL, \"WSA_RX1 INP1\"},\n\n\t{\"WSA_RX1 INP2\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX1 INP2\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX1 INP2\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX1 INP2\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX1 INP2\", \"DEC0\", \"WSA_TX DEC0_INP\"},\n\t{\"WSA_RX1 INP2\", \"DEC1\", \"WSA_TX DEC1_INP\"},\n\t{\"WSA_RX INT1 MIX\", NULL, \"WSA_RX1 INP2\"},\n\n\t{\"WSA_RX1 MIX INP\", \"RX0\", \"WSA RX0\"},\n\t{\"WSA_RX1 MIX INP\", \"RX1\", \"WSA RX1\"},\n\t{\"WSA_RX1 MIX INP\", \"RX_MIX0\", \"WSA RX_MIX0\"},\n\t{\"WSA_RX1 MIX INP\", \"RX_MIX1\", \"WSA RX_MIX1\"},\n\t{\"WSA_RX INT1 SEC MIX\", NULL, \"WSA_RX1 MIX INP\"},\n\n\t{\"WSA_RX INT1 SEC MIX\", NULL, \"WSA_RX INT1 MIX\"},\n\t{\"WSA_RX INT1 INTERP\", NULL, \"WSA_RX INT1 SEC MIX\"},\n\n\t{\"WSA_RX INT1 CHAIN\", NULL, \"WSA_RX INT1 INTERP\"},\n\t{\"WSA_SPK2 OUT\", NULL, \"WSA_RX INT1 CHAIN\"},\n\t{\"WSA_SPK2 OUT\", NULL, \"WSA_MCLK\"},\n};\n\nstatic int wsa_swrm_clock(struct wsa_macro *wsa, bool enable)\n{\n\tstruct regmap *regmap = wsa->regmap;\n\n\tif (enable) {\n\t\tint ret;\n\n\t\tret = clk_prepare_enable(wsa->mclk);\n\t\tif (ret) {\n\t\t\tdev_err(wsa->dev, \"failed to enable mclk\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\twsa_macro_mclk_enable(wsa, true);\n\n\t\tregmap_update_bits(regmap, CDC_WSA_CLK_RST_CTRL_SWR_CONTROL,\n\t\t\t\t   CDC_WSA_SWR_CLK_EN_MASK,\n\t\t\t\t   CDC_WSA_SWR_CLK_ENABLE);\n\n\t} else {\n\t\tregmap_update_bits(regmap, CDC_WSA_CLK_RST_CTRL_SWR_CONTROL,\n\t\t\t\t   CDC_WSA_SWR_CLK_EN_MASK, 0);\n\t\twsa_macro_mclk_enable(wsa, false);\n\t\tclk_disable_unprepare(wsa->mclk);\n\t}\n\n\treturn 0;\n}\n\nstatic int wsa_macro_component_probe(struct snd_soc_component *comp)\n{\n\tstruct wsa_macro *wsa = snd_soc_component_get_drvdata(comp);\n\n\tsnd_soc_component_init_regmap(comp, wsa->regmap);\n\n\twsa->spkr_gain_offset = WSA_MACRO_GAIN_OFFSET_M1P5_DB;\n\n\t \n\tsnd_soc_component_update_bits(comp, CDC_WSA_RX0_RX_PATH_CFG1,\n\t\t\t\tCDC_WSA_RX_PATH_SPKR_RATE_MASK,\n\t\t\t\tCDC_WSA_RX_PATH_SPKR_RATE_FS_2P4_3P072);\n\n\tsnd_soc_component_update_bits(comp, CDC_WSA_RX1_RX_PATH_CFG1,\n\t\t\t\tCDC_WSA_RX_PATH_SPKR_RATE_MASK,\n\t\t\t\tCDC_WSA_RX_PATH_SPKR_RATE_FS_2P4_3P072);\n\n\twsa_macro_set_spkr_mode(comp, WSA_MACRO_SPKR_MODE_1);\n\n\treturn 0;\n}\n\nstatic int swclk_gate_enable(struct clk_hw *hw)\n{\n\treturn wsa_swrm_clock(to_wsa_macro(hw), true);\n}\n\nstatic void swclk_gate_disable(struct clk_hw *hw)\n{\n\twsa_swrm_clock(to_wsa_macro(hw), false);\n}\n\nstatic int swclk_gate_is_enabled(struct clk_hw *hw)\n{\n\tstruct wsa_macro *wsa = to_wsa_macro(hw);\n\tint ret, val;\n\n\tregmap_read(wsa->regmap, CDC_WSA_CLK_RST_CTRL_SWR_CONTROL, &val);\n\tret = val & BIT(0);\n\n\treturn ret;\n}\n\nstatic unsigned long swclk_recalc_rate(struct clk_hw *hw,\n\t\t\t\t       unsigned long parent_rate)\n{\n\treturn parent_rate / 2;\n}\n\nstatic const struct clk_ops swclk_gate_ops = {\n\t.prepare = swclk_gate_enable,\n\t.unprepare = swclk_gate_disable,\n\t.is_enabled = swclk_gate_is_enabled,\n\t.recalc_rate = swclk_recalc_rate,\n};\n\nstatic int wsa_macro_register_mclk_output(struct wsa_macro *wsa)\n{\n\tstruct device *dev = wsa->dev;\n\tconst char *parent_clk_name;\n\tstruct clk_hw *hw;\n\tstruct clk_init_data init;\n\tint ret;\n\n\tif (wsa->npl)\n\t\tparent_clk_name = __clk_get_name(wsa->npl);\n\telse\n\t\tparent_clk_name = __clk_get_name(wsa->mclk);\n\n\tinit.name = \"mclk\";\n\tof_property_read_string(dev_of_node(dev), \"clock-output-names\",\n\t\t\t\t&init.name);\n\tinit.ops = &swclk_gate_ops;\n\tinit.flags = 0;\n\tinit.parent_names = &parent_clk_name;\n\tinit.num_parents = 1;\n\twsa->hw.init = &init;\n\thw = &wsa->hw;\n\tret = clk_hw_register(wsa->dev, hw);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_of_clk_add_hw_provider(dev, of_clk_hw_simple_get, hw);\n}\n\nstatic const struct snd_soc_component_driver wsa_macro_component_drv = {\n\t.name = \"WSA MACRO\",\n\t.probe = wsa_macro_component_probe,\n\t.controls = wsa_macro_snd_controls,\n\t.num_controls = ARRAY_SIZE(wsa_macro_snd_controls),\n\t.dapm_widgets = wsa_macro_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(wsa_macro_dapm_widgets),\n\t.dapm_routes = wsa_audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(wsa_audio_map),\n};\n\nstatic int wsa_macro_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct wsa_macro *wsa;\n\tkernel_ulong_t flags;\n\tvoid __iomem *base;\n\tint ret;\n\n\tflags = (kernel_ulong_t)device_get_match_data(dev);\n\n\twsa = devm_kzalloc(dev, sizeof(*wsa), GFP_KERNEL);\n\tif (!wsa)\n\t\treturn -ENOMEM;\n\n\twsa->macro = devm_clk_get_optional(dev, \"macro\");\n\tif (IS_ERR(wsa->macro))\n\t\treturn dev_err_probe(dev, PTR_ERR(wsa->macro), \"unable to get macro clock\\n\");\n\n\twsa->dcodec = devm_clk_get_optional(dev, \"dcodec\");\n\tif (IS_ERR(wsa->dcodec))\n\t\treturn dev_err_probe(dev, PTR_ERR(wsa->dcodec), \"unable to get dcodec clock\\n\");\n\n\twsa->mclk = devm_clk_get(dev, \"mclk\");\n\tif (IS_ERR(wsa->mclk))\n\t\treturn dev_err_probe(dev, PTR_ERR(wsa->mclk), \"unable to get mclk clock\\n\");\n\n\tif (flags & LPASS_MACRO_FLAG_HAS_NPL_CLOCK) {\n\t\twsa->npl = devm_clk_get(dev, \"npl\");\n\t\tif (IS_ERR(wsa->npl))\n\t\t\treturn dev_err_probe(dev, PTR_ERR(wsa->npl), \"unable to get npl clock\\n\");\n\t}\n\n\twsa->fsgen = devm_clk_get(dev, \"fsgen\");\n\tif (IS_ERR(wsa->fsgen))\n\t\treturn dev_err_probe(dev, PTR_ERR(wsa->fsgen), \"unable to get fsgen clock\\n\");\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\twsa->regmap = devm_regmap_init_mmio(dev, base, &wsa_regmap_config);\n\tif (IS_ERR(wsa->regmap))\n\t\treturn PTR_ERR(wsa->regmap);\n\n\tdev_set_drvdata(dev, wsa);\n\n\twsa->dev = dev;\n\n\t \n\tclk_set_rate(wsa->mclk, WSA_MACRO_MCLK_FREQ);\n\tclk_set_rate(wsa->npl, WSA_MACRO_MCLK_FREQ);\n\n\tret = clk_prepare_enable(wsa->macro);\n\tif (ret)\n\t\tgoto err;\n\n\tret = clk_prepare_enable(wsa->dcodec);\n\tif (ret)\n\t\tgoto err_dcodec;\n\n\tret = clk_prepare_enable(wsa->mclk);\n\tif (ret)\n\t\tgoto err_mclk;\n\n\tret = clk_prepare_enable(wsa->npl);\n\tif (ret)\n\t\tgoto err_npl;\n\n\tret = clk_prepare_enable(wsa->fsgen);\n\tif (ret)\n\t\tgoto err_fsgen;\n\n\t \n\tregmap_update_bits(wsa->regmap, CDC_WSA_CLK_RST_CTRL_SWR_CONTROL,\n\t\t\t   CDC_WSA_SWR_RST_EN_MASK, CDC_WSA_SWR_RST_ENABLE);\n\n\tregmap_update_bits(wsa->regmap, CDC_WSA_CLK_RST_CTRL_SWR_CONTROL,\n\t\t\t   CDC_WSA_SWR_CLK_EN_MASK, CDC_WSA_SWR_CLK_ENABLE);\n\n\t \n\tregmap_update_bits(wsa->regmap, CDC_WSA_CLK_RST_CTRL_SWR_CONTROL,\n\t\t\t   CDC_WSA_SWR_RST_EN_MASK, CDC_WSA_SWR_RST_DISABLE);\n\n\tret = devm_snd_soc_register_component(dev, &wsa_macro_component_drv,\n\t\t\t\t\t      wsa_macro_dai,\n\t\t\t\t\t      ARRAY_SIZE(wsa_macro_dai));\n\tif (ret)\n\t\tgoto err_clkout;\n\n\tpm_runtime_set_autosuspend_delay(dev, 3000);\n\tpm_runtime_use_autosuspend(dev);\n\tpm_runtime_mark_last_busy(dev);\n\tpm_runtime_set_active(dev);\n\tpm_runtime_enable(dev);\n\n\tret = wsa_macro_register_mclk_output(wsa);\n\tif (ret)\n\t\tgoto err_clkout;\n\n\treturn 0;\n\nerr_clkout:\n\tclk_disable_unprepare(wsa->fsgen);\nerr_fsgen:\n\tclk_disable_unprepare(wsa->npl);\nerr_npl:\n\tclk_disable_unprepare(wsa->mclk);\nerr_mclk:\n\tclk_disable_unprepare(wsa->dcodec);\nerr_dcodec:\n\tclk_disable_unprepare(wsa->macro);\nerr:\n\treturn ret;\n\n}\n\nstatic void wsa_macro_remove(struct platform_device *pdev)\n{\n\tstruct wsa_macro *wsa = dev_get_drvdata(&pdev->dev);\n\n\tclk_disable_unprepare(wsa->macro);\n\tclk_disable_unprepare(wsa->dcodec);\n\tclk_disable_unprepare(wsa->mclk);\n\tclk_disable_unprepare(wsa->npl);\n\tclk_disable_unprepare(wsa->fsgen);\n}\n\nstatic int __maybe_unused wsa_macro_runtime_suspend(struct device *dev)\n{\n\tstruct wsa_macro *wsa = dev_get_drvdata(dev);\n\n\tregcache_cache_only(wsa->regmap, true);\n\tregcache_mark_dirty(wsa->regmap);\n\n\tclk_disable_unprepare(wsa->fsgen);\n\tclk_disable_unprepare(wsa->npl);\n\tclk_disable_unprepare(wsa->mclk);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused wsa_macro_runtime_resume(struct device *dev)\n{\n\tstruct wsa_macro *wsa = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = clk_prepare_enable(wsa->mclk);\n\tif (ret) {\n\t\tdev_err(dev, \"unable to prepare mclk\\n\");\n\t\treturn ret;\n\t}\n\n\tret = clk_prepare_enable(wsa->npl);\n\tif (ret) {\n\t\tdev_err(dev, \"unable to prepare mclkx2\\n\");\n\t\tgoto err_npl;\n\t}\n\n\tret = clk_prepare_enable(wsa->fsgen);\n\tif (ret) {\n\t\tdev_err(dev, \"unable to prepare fsgen\\n\");\n\t\tgoto err_fsgen;\n\t}\n\n\tregcache_cache_only(wsa->regmap, false);\n\tregcache_sync(wsa->regmap);\n\n\treturn 0;\nerr_fsgen:\n\tclk_disable_unprepare(wsa->npl);\nerr_npl:\n\tclk_disable_unprepare(wsa->mclk);\n\n\treturn ret;\n}\n\nstatic const struct dev_pm_ops wsa_macro_pm_ops = {\n\tSET_RUNTIME_PM_OPS(wsa_macro_runtime_suspend, wsa_macro_runtime_resume, NULL)\n};\n\nstatic const struct of_device_id wsa_macro_dt_match[] = {\n\t{\n\t\t.compatible = \"qcom,sc7280-lpass-wsa-macro\",\n\t\t.data = (void *)LPASS_MACRO_FLAG_HAS_NPL_CLOCK,\n\t}, {\n\t\t.compatible = \"qcom,sm8250-lpass-wsa-macro\",\n\t\t.data = (void *)LPASS_MACRO_FLAG_HAS_NPL_CLOCK,\n\t}, {\n\t\t.compatible = \"qcom,sm8450-lpass-wsa-macro\",\n\t\t.data = (void *)LPASS_MACRO_FLAG_HAS_NPL_CLOCK,\n\t}, {\n\t\t.compatible = \"qcom,sm8550-lpass-wsa-macro\",\n\t}, {\n\t\t.compatible = \"qcom,sc8280xp-lpass-wsa-macro\",\n\t\t.data = (void *)LPASS_MACRO_FLAG_HAS_NPL_CLOCK,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, wsa_macro_dt_match);\n\nstatic struct platform_driver wsa_macro_driver = {\n\t.driver = {\n\t\t.name = \"wsa_macro\",\n\t\t.of_match_table = wsa_macro_dt_match,\n\t\t.pm = &wsa_macro_pm_ops,\n\t},\n\t.probe = wsa_macro_probe,\n\t.remove_new = wsa_macro_remove,\n};\n\nmodule_platform_driver(wsa_macro_driver);\nMODULE_DESCRIPTION(\"WSA macro driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}