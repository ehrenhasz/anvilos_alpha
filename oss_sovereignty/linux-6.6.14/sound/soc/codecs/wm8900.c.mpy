{
  "module_name": "wm8900.c",
  "hash_id": "f729f503e400738ca141d2faf456ac4b03f22d9585875869cb7c796f14b8444b",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/wm8900.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/pm.h>\n#include <linux/i2c.h>\n#include <linux/regmap.h>\n#include <linux/spi/spi.h>\n#include <linux/slab.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/initval.h>\n#include <sound/tlv.h>\n\n#include \"wm8900.h\"\n\n \n#define WM8900_REG_RESET\t0x0\n#define WM8900_REG_ID\t\t0x0\n#define WM8900_REG_POWER1\t0x1\n#define WM8900_REG_POWER2\t0x2\n#define WM8900_REG_POWER3\t0x3\n#define WM8900_REG_AUDIO1\t0x4\n#define WM8900_REG_AUDIO2\t0x5\n#define WM8900_REG_CLOCKING1    0x6\n#define WM8900_REG_CLOCKING2    0x7\n#define WM8900_REG_AUDIO3       0x8\n#define WM8900_REG_AUDIO4       0x9\n#define WM8900_REG_DACCTRL      0xa\n#define WM8900_REG_LDAC_DV      0xb\n#define WM8900_REG_RDAC_DV      0xc\n#define WM8900_REG_SIDETONE     0xd\n#define WM8900_REG_ADCCTRL      0xe\n#define WM8900_REG_LADC_DV\t0xf\n#define WM8900_REG_RADC_DV      0x10\n#define WM8900_REG_GPIO         0x12\n#define WM8900_REG_INCTL\t0x15\n#define WM8900_REG_LINVOL\t0x16\n#define WM8900_REG_RINVOL\t0x17\n#define WM8900_REG_INBOOSTMIX1  0x18\n#define WM8900_REG_INBOOSTMIX2  0x19\n#define WM8900_REG_ADCPATH\t0x1a\n#define WM8900_REG_AUXBOOST\t0x1b\n#define WM8900_REG_ADDCTL       0x1e\n#define WM8900_REG_FLLCTL1      0x24\n#define WM8900_REG_FLLCTL2      0x25\n#define WM8900_REG_FLLCTL3      0x26\n#define WM8900_REG_FLLCTL4      0x27\n#define WM8900_REG_FLLCTL5      0x28\n#define WM8900_REG_FLLCTL6      0x29\n#define WM8900_REG_LOUTMIXCTL1  0x2c\n#define WM8900_REG_ROUTMIXCTL1  0x2d\n#define WM8900_REG_BYPASS1\t0x2e\n#define WM8900_REG_BYPASS2\t0x2f\n#define WM8900_REG_AUXOUT_CTL   0x30\n#define WM8900_REG_LOUT1CTL     0x33\n#define WM8900_REG_ROUT1CTL     0x34\n#define WM8900_REG_LOUT2CTL\t0x35\n#define WM8900_REG_ROUT2CTL\t0x36\n#define WM8900_REG_HPCTL1\t0x3a\n#define WM8900_REG_OUTBIASCTL   0x73\n\n#define WM8900_MAXREG\t\t0x80\n\n#define WM8900_REG_ADDCTL_OUT1_DIS    0x80\n#define WM8900_REG_ADDCTL_OUT2_DIS    0x40\n#define WM8900_REG_ADDCTL_VMID_DIS    0x20\n#define WM8900_REG_ADDCTL_BIAS_SRC    0x10\n#define WM8900_REG_ADDCTL_VMID_SOFTST 0x04\n#define WM8900_REG_ADDCTL_TEMP_SD     0x02\n\n#define WM8900_REG_GPIO_TEMP_ENA   0x2\n\n#define WM8900_REG_POWER1_STARTUP_BIAS_ENA 0x0100\n#define WM8900_REG_POWER1_BIAS_ENA         0x0008\n#define WM8900_REG_POWER1_VMID_BUF_ENA     0x0004\n#define WM8900_REG_POWER1_FLL_ENA          0x0040\n\n#define WM8900_REG_POWER2_SYSCLK_ENA  0x8000\n#define WM8900_REG_POWER2_ADCL_ENA    0x0002\n#define WM8900_REG_POWER2_ADCR_ENA    0x0001\n\n#define WM8900_REG_POWER3_DACL_ENA    0x0002\n#define WM8900_REG_POWER3_DACR_ENA    0x0001\n\n#define WM8900_REG_AUDIO1_AIF_FMT_MASK 0x0018\n#define WM8900_REG_AUDIO1_LRCLK_INV    0x0080\n#define WM8900_REG_AUDIO1_BCLK_INV     0x0100\n\n#define WM8900_REG_CLOCKING1_BCLK_DIR   0x1\n#define WM8900_REG_CLOCKING1_MCLK_SRC   0x100\n#define WM8900_REG_CLOCKING1_BCLK_MASK  0x01e\n#define WM8900_REG_CLOCKING1_OPCLK_MASK 0x7000\n\n#define WM8900_REG_CLOCKING2_ADC_CLKDIV 0xe0\n#define WM8900_REG_CLOCKING2_DAC_CLKDIV 0x1c\n\n#define WM8900_REG_DACCTRL_MUTE          0x004\n#define WM8900_REG_DACCTRL_DAC_SB_FILT   0x100\n#define WM8900_REG_DACCTRL_AIF_LRCLKRATE 0x400\n\n#define WM8900_REG_AUDIO3_ADCLRC_DIR    0x0800\n\n#define WM8900_REG_AUDIO4_DACLRC_DIR    0x0800\n\n#define WM8900_REG_FLLCTL1_OSC_ENA    0x100\n\n#define WM8900_REG_FLLCTL6_FLL_SLOW_LOCK_REF 0x100\n\n#define WM8900_REG_HPCTL1_HP_IPSTAGE_ENA 0x80\n#define WM8900_REG_HPCTL1_HP_OPSTAGE_ENA 0x40\n#define WM8900_REG_HPCTL1_HP_CLAMP_IP    0x20\n#define WM8900_REG_HPCTL1_HP_CLAMP_OP    0x10\n#define WM8900_REG_HPCTL1_HP_SHORT       0x08\n#define WM8900_REG_HPCTL1_HP_SHORT2      0x04\n\n#define WM8900_LRC_MASK 0x03ff\n\nstruct wm8900_priv {\n\tstruct regmap *regmap;\n\n\tu32 fll_in;  \n\tu32 fll_out;  \n};\n\n \nstatic const struct reg_default wm8900_reg_defaults[] = {\n\t{  1, 0x0000 },\n\t{  2, 0xc000 },\n\t{  3, 0x0000 },\n\t{  4, 0x4050 },\n\t{  5, 0x4000 },\n\t{  6, 0x0008 },\n\t{  7, 0x0000 },\n\t{  8, 0x0040 },\n\t{  9, 0x0040 },\n\t{ 10, 0x1004 },\n\t{ 11, 0x00c0 },\n\t{ 12, 0x00c0 },\n\t{ 13, 0x0000 },\n\t{ 14, 0x0100 },\n\t{ 15, 0x00c0 },\n\t{ 16, 0x00c0 },\n\t{ 17, 0x0000 },\n\t{ 18, 0xb001 },\n\t{ 19, 0x0000 },\n\t{ 20, 0x0000 },\n\t{ 21, 0x0044 },\n\t{ 22, 0x004c },\n\t{ 23, 0x004c },\n\t{ 24, 0x0044 },\n\t{ 25, 0x0044 },\n\t{ 26, 0x0000 },\n\t{ 27, 0x0044 },\n\t{ 28, 0x0000 },\n\t{ 29, 0x0000 },\n\t{ 30, 0x0002 },\n\t{ 31, 0x0000 },\n\t{ 32, 0x0000 },\n\t{ 33, 0x0000 },\n\t{ 34, 0x0000 },\n\t{ 35, 0x0000 },\n\t{ 36, 0x0008 },\n\t{ 37, 0x0000 },\n\t{ 38, 0x0000 },\n\t{ 39, 0x0008 },\n\t{ 40, 0x0097 },\n\t{ 41, 0x0100 },\n\t{ 42, 0x0000 },\n\t{ 43, 0x0000 },\n\t{ 44, 0x0050 },\n\t{ 45, 0x0050 },\n\t{ 46, 0x0055 },\n\t{ 47, 0x0055 },\n\t{ 48, 0x0055 },\n\t{ 49, 0x0000 },\n\t{ 50, 0x0000 },\n\t{ 51, 0x0079 },\n\t{ 52, 0x0079 },\n\t{ 53, 0x0079 },\n\t{ 54, 0x0079 },\n\t{ 55, 0x0000 },\n};\n\nstatic bool wm8900_volatile_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase WM8900_REG_ID:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic void wm8900_reset(struct snd_soc_component *component)\n{\n\tsnd_soc_component_write(component, WM8900_REG_RESET, 0);\n}\n\nstatic int wm8900_hp_event(struct snd_soc_dapm_widget *w,\n\t\t\t   struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tu16 hpctl1 = snd_soc_component_read(component, WM8900_REG_HPCTL1);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\t \n\t\thpctl1 = WM8900_REG_HPCTL1_HP_CLAMP_IP |\n\t\t\tWM8900_REG_HPCTL1_HP_CLAMP_OP;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\t\tbreak;\n\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\t \n\t\thpctl1 &= ~WM8900_REG_HPCTL1_HP_CLAMP_IP;\n\t\thpctl1 |= WM8900_REG_HPCTL1_HP_SHORT |\n\t\t\tWM8900_REG_HPCTL1_HP_SHORT2 |\n\t\t\tWM8900_REG_HPCTL1_HP_IPSTAGE_ENA;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\n\t\tmsleep(400);\n\n\t\t \n\t\thpctl1 &= ~WM8900_REG_HPCTL1_HP_CLAMP_OP;\n\t\thpctl1 |= WM8900_REG_HPCTL1_HP_OPSTAGE_ENA;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\n\t\t \n\t\thpctl1 &= ~WM8900_REG_HPCTL1_HP_SHORT2;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\t\thpctl1 &= ~WM8900_REG_HPCTL1_HP_SHORT;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\t\tbreak;\n\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\t \n\t\thpctl1 |= WM8900_REG_HPCTL1_HP_SHORT;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\n\t\t \n\t\thpctl1 &= ~WM8900_REG_HPCTL1_HP_OPSTAGE_ENA;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\n\t\t \n\t\thpctl1 |= WM8900_REG_HPCTL1_HP_CLAMP_IP |\n\t\t\tWM8900_REG_HPCTL1_HP_CLAMP_OP;\n\t\thpctl1 &= ~WM8900_REG_HPCTL1_HP_IPSTAGE_ENA;\n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, hpctl1);\n\t\tbreak;\n\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, 0);\n\t\tbreak;\n\n\tdefault:\n\t\tWARN(1, \"Invalid event %d\\n\", event);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic const DECLARE_TLV_DB_SCALE(out_pga_tlv, -5700, 100, 0);\n\nstatic const DECLARE_TLV_DB_SCALE(out_mix_tlv, -1500, 300, 0);\n\nstatic const DECLARE_TLV_DB_SCALE(in_boost_tlv, -1200, 600, 0);\n\nstatic const DECLARE_TLV_DB_SCALE(in_pga_tlv, -1200, 100, 0);\n\nstatic const DECLARE_TLV_DB_SCALE(dac_boost_tlv, 0, 600, 0);\n\nstatic const DECLARE_TLV_DB_SCALE(dac_tlv, -7200, 75, 1);\n\nstatic const DECLARE_TLV_DB_SCALE(adc_svol_tlv, -3600, 300, 0);\n\nstatic const DECLARE_TLV_DB_SCALE(adc_tlv, -7200, 75, 1);\n\nstatic const char *mic_bias_level_txt[] = { \"0.9*AVDD\", \"0.65*AVDD\" };\n\nstatic SOC_ENUM_SINGLE_DECL(mic_bias_level,\n\t\t\t    WM8900_REG_INCTL, 8, mic_bias_level_txt);\n\nstatic const char *dac_mute_rate_txt[] = { \"Fast\", \"Slow\" };\n\nstatic SOC_ENUM_SINGLE_DECL(dac_mute_rate,\n\t\t\t    WM8900_REG_DACCTRL, 7, dac_mute_rate_txt);\n\nstatic const char *dac_deemphasis_txt[] = {\n\t\"Disabled\", \"32kHz\", \"44.1kHz\", \"48kHz\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(dac_deemphasis,\n\t\t\t    WM8900_REG_DACCTRL, 4, dac_deemphasis_txt);\n\nstatic const char *adc_hpf_cut_txt[] = {\n\t\"Hi-fi mode\", \"Voice mode 1\", \"Voice mode 2\", \"Voice mode 3\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(adc_hpf_cut,\n\t\t\t    WM8900_REG_ADCCTRL, 5, adc_hpf_cut_txt);\n\nstatic const char *lr_txt[] = {\n\t\"Left\", \"Right\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(aifl_src,\n\t\t\t    WM8900_REG_AUDIO1, 15, lr_txt);\n\nstatic SOC_ENUM_SINGLE_DECL(aifr_src,\n\t\t\t    WM8900_REG_AUDIO1, 14, lr_txt);\n\nstatic SOC_ENUM_SINGLE_DECL(dacl_src,\n\t\t\t    WM8900_REG_AUDIO2, 15, lr_txt);\n\nstatic SOC_ENUM_SINGLE_DECL(dacr_src,\n\t\t\t    WM8900_REG_AUDIO2, 14, lr_txt);\n\nstatic const char *sidetone_txt[] = {\n\t\"Disabled\", \"Left ADC\", \"Right ADC\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(dacl_sidetone,\n\t\t\t    WM8900_REG_SIDETONE, 2, sidetone_txt);\n\nstatic SOC_ENUM_SINGLE_DECL(dacr_sidetone,\n\t\t\t    WM8900_REG_SIDETONE, 0, sidetone_txt);\n\nstatic const struct snd_kcontrol_new wm8900_snd_controls[] = {\nSOC_ENUM(\"Mic Bias Level\", mic_bias_level),\n\nSOC_SINGLE_TLV(\"Left Input PGA Volume\", WM8900_REG_LINVOL, 0, 31, 0,\n\t       in_pga_tlv),\nSOC_SINGLE(\"Left Input PGA Switch\", WM8900_REG_LINVOL, 6, 1, 1),\nSOC_SINGLE(\"Left Input PGA ZC Switch\", WM8900_REG_LINVOL, 7, 1, 0),\n\nSOC_SINGLE_TLV(\"Right Input PGA Volume\", WM8900_REG_RINVOL, 0, 31, 0,\n\t       in_pga_tlv),\nSOC_SINGLE(\"Right Input PGA Switch\", WM8900_REG_RINVOL, 6, 1, 1),\nSOC_SINGLE(\"Right Input PGA ZC Switch\", WM8900_REG_RINVOL, 7, 1, 0),\n\nSOC_SINGLE(\"DAC Soft Mute Switch\", WM8900_REG_DACCTRL, 6, 1, 1),\nSOC_ENUM(\"DAC Mute Rate\", dac_mute_rate),\nSOC_SINGLE(\"DAC Mono Switch\", WM8900_REG_DACCTRL, 9, 1, 0),\nSOC_ENUM(\"DAC Deemphasis\", dac_deemphasis),\nSOC_SINGLE(\"DAC Sigma-Delta Modulator Clock Switch\", WM8900_REG_DACCTRL,\n\t   12, 1, 0),\n\nSOC_SINGLE(\"ADC HPF Switch\", WM8900_REG_ADCCTRL, 8, 1, 0),\nSOC_ENUM(\"ADC HPF Cut-Off\", adc_hpf_cut),\nSOC_DOUBLE(\"ADC Invert Switch\", WM8900_REG_ADCCTRL, 1, 0, 1, 0),\nSOC_SINGLE_TLV(\"Left ADC Sidetone Volume\", WM8900_REG_SIDETONE, 9, 12, 0,\n\t       adc_svol_tlv),\nSOC_SINGLE_TLV(\"Right ADC Sidetone Volume\", WM8900_REG_SIDETONE, 5, 12, 0,\n\t       adc_svol_tlv),\nSOC_ENUM(\"Left Digital Audio Source\", aifl_src),\nSOC_ENUM(\"Right Digital Audio Source\", aifr_src),\n\nSOC_SINGLE_TLV(\"DAC Input Boost Volume\", WM8900_REG_AUDIO2, 10, 4, 0,\n\t       dac_boost_tlv),\nSOC_ENUM(\"Left DAC Source\", dacl_src),\nSOC_ENUM(\"Right DAC Source\", dacr_src),\nSOC_ENUM(\"Left DAC Sidetone\", dacl_sidetone),\nSOC_ENUM(\"Right DAC Sidetone\", dacr_sidetone),\nSOC_DOUBLE(\"DAC Invert Switch\", WM8900_REG_DACCTRL, 1, 0, 1, 0),\n\nSOC_DOUBLE_R_TLV(\"Digital Playback Volume\",\n\t\t WM8900_REG_LDAC_DV, WM8900_REG_RDAC_DV,\n\t\t 1, 96, 0, dac_tlv),\nSOC_DOUBLE_R_TLV(\"Digital Capture Volume\",\n\t\t WM8900_REG_LADC_DV, WM8900_REG_RADC_DV, 1, 119, 0, adc_tlv),\n\nSOC_SINGLE_TLV(\"LINPUT3 Bypass Volume\", WM8900_REG_LOUTMIXCTL1, 4, 7, 0,\n\t       out_mix_tlv),\nSOC_SINGLE_TLV(\"RINPUT3 Bypass Volume\", WM8900_REG_ROUTMIXCTL1, 4, 7, 0,\n\t       out_mix_tlv),\nSOC_SINGLE_TLV(\"Left AUX Bypass Volume\", WM8900_REG_AUXOUT_CTL, 4, 7, 0,\n\t       out_mix_tlv),\nSOC_SINGLE_TLV(\"Right AUX Bypass Volume\", WM8900_REG_AUXOUT_CTL, 0, 7, 0,\n\t       out_mix_tlv),\n\nSOC_SINGLE_TLV(\"LeftIn to RightOut Mixer Volume\", WM8900_REG_BYPASS1, 0, 7, 0,\n\t       out_mix_tlv),\nSOC_SINGLE_TLV(\"LeftIn to LeftOut Mixer Volume\", WM8900_REG_BYPASS1, 4, 7, 0,\n\t       out_mix_tlv),\nSOC_SINGLE_TLV(\"RightIn to LeftOut Mixer Volume\", WM8900_REG_BYPASS2, 0, 7, 0,\n\t       out_mix_tlv),\nSOC_SINGLE_TLV(\"RightIn to RightOut Mixer Volume\", WM8900_REG_BYPASS2, 4, 7, 0,\n\t       out_mix_tlv),\n\nSOC_SINGLE_TLV(\"IN2L Boost Volume\", WM8900_REG_INBOOSTMIX1, 0, 3, 0,\n\t       in_boost_tlv),\nSOC_SINGLE_TLV(\"IN3L Boost Volume\", WM8900_REG_INBOOSTMIX1, 4, 3, 0,\n\t       in_boost_tlv),\nSOC_SINGLE_TLV(\"IN2R Boost Volume\", WM8900_REG_INBOOSTMIX2, 0, 3, 0,\n\t       in_boost_tlv),\nSOC_SINGLE_TLV(\"IN3R Boost Volume\", WM8900_REG_INBOOSTMIX2, 4, 3, 0,\n\t       in_boost_tlv),\nSOC_SINGLE_TLV(\"Left AUX Boost Volume\", WM8900_REG_AUXBOOST, 4, 3, 0,\n\t       in_boost_tlv),\nSOC_SINGLE_TLV(\"Right AUX Boost Volume\", WM8900_REG_AUXBOOST, 0, 3, 0,\n\t       in_boost_tlv),\n\nSOC_DOUBLE_R_TLV(\"LINEOUT1 Volume\", WM8900_REG_LOUT1CTL, WM8900_REG_ROUT1CTL,\n\t       0, 63, 0, out_pga_tlv),\nSOC_DOUBLE_R(\"LINEOUT1 Switch\", WM8900_REG_LOUT1CTL, WM8900_REG_ROUT1CTL,\n\t     6, 1, 1),\nSOC_DOUBLE_R(\"LINEOUT1 ZC Switch\", WM8900_REG_LOUT1CTL, WM8900_REG_ROUT1CTL,\n\t     7, 1, 0),\n\nSOC_DOUBLE_R_TLV(\"LINEOUT2 Volume\",\n\t\t WM8900_REG_LOUT2CTL, WM8900_REG_ROUT2CTL,\n\t\t 0, 63, 0, out_pga_tlv),\nSOC_DOUBLE_R(\"LINEOUT2 Switch\",\n\t     WM8900_REG_LOUT2CTL, WM8900_REG_ROUT2CTL, 6, 1, 1),\nSOC_DOUBLE_R(\"LINEOUT2 ZC Switch\",\n\t     WM8900_REG_LOUT2CTL, WM8900_REG_ROUT2CTL, 7, 1, 0),\nSOC_SINGLE(\"LINEOUT2 LP -12dB\", WM8900_REG_LOUTMIXCTL1,\n\t   0, 1, 1),\n\n};\n\nstatic const struct snd_kcontrol_new wm8900_loutmix_controls[] = {\nSOC_DAPM_SINGLE(\"LINPUT3 Bypass Switch\", WM8900_REG_LOUTMIXCTL1, 7, 1, 0),\nSOC_DAPM_SINGLE(\"AUX Bypass Switch\", WM8900_REG_AUXOUT_CTL, 7, 1, 0),\nSOC_DAPM_SINGLE(\"Left Input Mixer Switch\", WM8900_REG_BYPASS1, 7, 1, 0),\nSOC_DAPM_SINGLE(\"Right Input Mixer Switch\", WM8900_REG_BYPASS2, 3, 1, 0),\nSOC_DAPM_SINGLE(\"DACL Switch\", WM8900_REG_LOUTMIXCTL1, 8, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new wm8900_routmix_controls[] = {\nSOC_DAPM_SINGLE(\"RINPUT3 Bypass Switch\", WM8900_REG_ROUTMIXCTL1, 7, 1, 0),\nSOC_DAPM_SINGLE(\"AUX Bypass Switch\", WM8900_REG_AUXOUT_CTL, 3, 1, 0),\nSOC_DAPM_SINGLE(\"Left Input Mixer Switch\", WM8900_REG_BYPASS1, 3, 1, 0),\nSOC_DAPM_SINGLE(\"Right Input Mixer Switch\", WM8900_REG_BYPASS2, 7, 1, 0),\nSOC_DAPM_SINGLE(\"DACR Switch\", WM8900_REG_ROUTMIXCTL1, 8, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new wm8900_linmix_controls[] = {\nSOC_DAPM_SINGLE(\"LINPUT2 Switch\", WM8900_REG_INBOOSTMIX1, 2, 1, 1),\nSOC_DAPM_SINGLE(\"LINPUT3 Switch\", WM8900_REG_INBOOSTMIX1, 6, 1, 1),\nSOC_DAPM_SINGLE(\"AUX Switch\", WM8900_REG_AUXBOOST, 6, 1, 1),\nSOC_DAPM_SINGLE(\"Input PGA Switch\", WM8900_REG_ADCPATH, 6, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new wm8900_rinmix_controls[] = {\nSOC_DAPM_SINGLE(\"RINPUT2 Switch\", WM8900_REG_INBOOSTMIX2, 2, 1, 1),\nSOC_DAPM_SINGLE(\"RINPUT3 Switch\", WM8900_REG_INBOOSTMIX2, 6, 1, 1),\nSOC_DAPM_SINGLE(\"AUX Switch\", WM8900_REG_AUXBOOST, 2, 1, 1),\nSOC_DAPM_SINGLE(\"Input PGA Switch\", WM8900_REG_ADCPATH, 2, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new wm8900_linpga_controls[] = {\nSOC_DAPM_SINGLE(\"LINPUT1 Switch\", WM8900_REG_INCTL, 6, 1, 0),\nSOC_DAPM_SINGLE(\"LINPUT2 Switch\", WM8900_REG_INCTL, 5, 1, 0),\nSOC_DAPM_SINGLE(\"LINPUT3 Switch\", WM8900_REG_INCTL, 4, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new wm8900_rinpga_controls[] = {\nSOC_DAPM_SINGLE(\"RINPUT1 Switch\", WM8900_REG_INCTL, 2, 1, 0),\nSOC_DAPM_SINGLE(\"RINPUT2 Switch\", WM8900_REG_INCTL, 1, 1, 0),\nSOC_DAPM_SINGLE(\"RINPUT3 Switch\", WM8900_REG_INCTL, 0, 1, 0),\n};\n\nstatic const char *wm8900_lp_mux[] = { \"Disabled\", \"Enabled\" };\n\nstatic SOC_ENUM_SINGLE_DECL(wm8900_lineout2_lp_mux,\n\t\t\t    WM8900_REG_LOUTMIXCTL1, 1, wm8900_lp_mux);\n\nstatic const struct snd_kcontrol_new wm8900_lineout2_lp =\nSOC_DAPM_ENUM(\"Route\", wm8900_lineout2_lp_mux);\n\nstatic const struct snd_soc_dapm_widget wm8900_dapm_widgets[] = {\n\n \nSND_SOC_DAPM_OUTPUT(\"LINEOUT1L\"),\nSND_SOC_DAPM_OUTPUT(\"LINEOUT1R\"),\nSND_SOC_DAPM_OUTPUT(\"LINEOUT2L\"),\nSND_SOC_DAPM_OUTPUT(\"LINEOUT2R\"),\nSND_SOC_DAPM_OUTPUT(\"HP_L\"),\nSND_SOC_DAPM_OUTPUT(\"HP_R\"),\n\nSND_SOC_DAPM_INPUT(\"RINPUT1\"),\nSND_SOC_DAPM_INPUT(\"LINPUT1\"),\nSND_SOC_DAPM_INPUT(\"RINPUT2\"),\nSND_SOC_DAPM_INPUT(\"LINPUT2\"),\nSND_SOC_DAPM_INPUT(\"RINPUT3\"),\nSND_SOC_DAPM_INPUT(\"LINPUT3\"),\nSND_SOC_DAPM_INPUT(\"AUX\"),\n\nSND_SOC_DAPM_VMID(\"VMID\"),\n\n \nSND_SOC_DAPM_MIXER(\"Left Input PGA\", WM8900_REG_POWER2, 3, 0,\n\t\t   wm8900_linpga_controls,\n\t\t   ARRAY_SIZE(wm8900_linpga_controls)),\nSND_SOC_DAPM_MIXER(\"Right Input PGA\", WM8900_REG_POWER2, 2, 0,\n\t\t   wm8900_rinpga_controls,\n\t\t   ARRAY_SIZE(wm8900_rinpga_controls)),\n\nSND_SOC_DAPM_MIXER(\"Left Input Mixer\", WM8900_REG_POWER2, 5, 0,\n\t\t   wm8900_linmix_controls,\n\t\t   ARRAY_SIZE(wm8900_linmix_controls)),\nSND_SOC_DAPM_MIXER(\"Right Input Mixer\", WM8900_REG_POWER2, 4, 0,\n\t\t   wm8900_rinmix_controls,\n\t\t   ARRAY_SIZE(wm8900_rinmix_controls)),\n\nSND_SOC_DAPM_SUPPLY(\"Mic Bias\", WM8900_REG_POWER1, 4, 0, NULL, 0),\n\nSND_SOC_DAPM_ADC(\"ADCL\", \"Left HiFi Capture\", WM8900_REG_POWER2, 1, 0),\nSND_SOC_DAPM_ADC(\"ADCR\", \"Right HiFi Capture\", WM8900_REG_POWER2, 0, 0),\n\n \nSND_SOC_DAPM_DAC(\"DACL\", \"Left HiFi Playback\", WM8900_REG_POWER3, 1, 0),\nSND_SOC_DAPM_DAC(\"DACR\", \"Right HiFi Playback\", WM8900_REG_POWER3, 0, 0),\n\nSND_SOC_DAPM_PGA_E(\"Headphone Amplifier\", WM8900_REG_POWER3, 7, 0, NULL, 0,\n\t\t   wm8900_hp_event,\n\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\nSND_SOC_DAPM_PGA(\"LINEOUT1L PGA\", WM8900_REG_POWER2, 8, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"LINEOUT1R PGA\", WM8900_REG_POWER2, 7, 0, NULL, 0),\n\nSND_SOC_DAPM_MUX(\"LINEOUT2 LP\", SND_SOC_NOPM, 0, 0, &wm8900_lineout2_lp),\nSND_SOC_DAPM_PGA(\"LINEOUT2L PGA\", WM8900_REG_POWER3, 6, 0, NULL, 0),\nSND_SOC_DAPM_PGA(\"LINEOUT2R PGA\", WM8900_REG_POWER3, 5, 0, NULL, 0),\n\nSND_SOC_DAPM_MIXER(\"Left Output Mixer\", WM8900_REG_POWER3, 3, 0,\n\t\t   wm8900_loutmix_controls,\n\t\t   ARRAY_SIZE(wm8900_loutmix_controls)),\nSND_SOC_DAPM_MIXER(\"Right Output Mixer\", WM8900_REG_POWER3, 2, 0,\n\t\t   wm8900_routmix_controls,\n\t\t   ARRAY_SIZE(wm8900_routmix_controls)),\n};\n\n \nstatic const struct snd_soc_dapm_route wm8900_dapm_routes[] = {\n \n{\"Left Input PGA\", \"LINPUT1 Switch\", \"LINPUT1\"},\n{\"Left Input PGA\", \"LINPUT2 Switch\", \"LINPUT2\"},\n{\"Left Input PGA\", \"LINPUT3 Switch\", \"LINPUT3\"},\n\n{\"Right Input PGA\", \"RINPUT1 Switch\", \"RINPUT1\"},\n{\"Right Input PGA\", \"RINPUT2 Switch\", \"RINPUT2\"},\n{\"Right Input PGA\", \"RINPUT3 Switch\", \"RINPUT3\"},\n\n{\"Left Input Mixer\", \"LINPUT2 Switch\", \"LINPUT2\"},\n{\"Left Input Mixer\", \"LINPUT3 Switch\", \"LINPUT3\"},\n{\"Left Input Mixer\", \"AUX Switch\", \"AUX\"},\n{\"Left Input Mixer\", \"Input PGA Switch\", \"Left Input PGA\"},\n\n{\"Right Input Mixer\", \"RINPUT2 Switch\", \"RINPUT2\"},\n{\"Right Input Mixer\", \"RINPUT3 Switch\", \"RINPUT3\"},\n{\"Right Input Mixer\", \"AUX Switch\", \"AUX\"},\n{\"Right Input Mixer\", \"Input PGA Switch\", \"Right Input PGA\"},\n\n{\"ADCL\", NULL, \"Left Input Mixer\"},\n{\"ADCR\", NULL, \"Right Input Mixer\"},\n\n \n{\"LINEOUT1L\", NULL, \"LINEOUT1L PGA\"},\n{\"LINEOUT1L PGA\", NULL, \"Left Output Mixer\"},\n{\"LINEOUT1R\", NULL, \"LINEOUT1R PGA\"},\n{\"LINEOUT1R PGA\", NULL, \"Right Output Mixer\"},\n\n{\"LINEOUT2L PGA\", NULL, \"Left Output Mixer\"},\n{\"LINEOUT2 LP\", \"Disabled\", \"LINEOUT2L PGA\"},\n{\"LINEOUT2 LP\", \"Enabled\", \"Left Output Mixer\"},\n{\"LINEOUT2L\", NULL, \"LINEOUT2 LP\"},\n\n{\"LINEOUT2R PGA\", NULL, \"Right Output Mixer\"},\n{\"LINEOUT2 LP\", \"Disabled\", \"LINEOUT2R PGA\"},\n{\"LINEOUT2 LP\", \"Enabled\", \"Right Output Mixer\"},\n{\"LINEOUT2R\", NULL, \"LINEOUT2 LP\"},\n\n{\"Left Output Mixer\", \"LINPUT3 Bypass Switch\", \"LINPUT3\"},\n{\"Left Output Mixer\", \"AUX Bypass Switch\", \"AUX\"},\n{\"Left Output Mixer\", \"Left Input Mixer Switch\", \"Left Input Mixer\"},\n{\"Left Output Mixer\", \"Right Input Mixer Switch\", \"Right Input Mixer\"},\n{\"Left Output Mixer\", \"DACL Switch\", \"DACL\"},\n\n{\"Right Output Mixer\", \"RINPUT3 Bypass Switch\", \"RINPUT3\"},\n{\"Right Output Mixer\", \"AUX Bypass Switch\", \"AUX\"},\n{\"Right Output Mixer\", \"Left Input Mixer Switch\", \"Left Input Mixer\"},\n{\"Right Output Mixer\", \"Right Input Mixer Switch\", \"Right Input Mixer\"},\n{\"Right Output Mixer\", \"DACR Switch\", \"DACR\"},\n\n \n{\"Headphone Amplifier\", NULL, \"LINEOUT2 LP\"},\n{\"Headphone Amplifier\", NULL, \"LINEOUT2 LP\"},\n{\"HP_L\", NULL, \"Headphone Amplifier\"},\n{\"HP_R\", NULL, \"Headphone Amplifier\"},\n};\n\nstatic int wm8900_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params,\n\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tu16 reg;\n\n\treg = snd_soc_component_read(component, WM8900_REG_AUDIO1) & ~0x60;\n\n\tswitch (params_width(params)) {\n\tcase 16:\n\t\tbreak;\n\tcase 20:\n\t\treg |= 0x20;\n\t\tbreak;\n\tcase 24:\n\t\treg |= 0x40;\n\t\tbreak;\n\tcase 32:\n\t\treg |= 0x60;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_write(component, WM8900_REG_AUDIO1, reg);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\n\t\treg = snd_soc_component_read(component, WM8900_REG_DACCTRL);\n\n\t\tif (params_rate(params) <= 24000)\n\t\t\treg |= WM8900_REG_DACCTRL_DAC_SB_FILT;\n\t\telse\n\t\t\treg &= ~WM8900_REG_DACCTRL_DAC_SB_FILT;\n\n\t\tsnd_soc_component_write(component, WM8900_REG_DACCTRL, reg);\n\t}\n\n\treturn 0;\n}\n\n \nstruct _fll_div {\n\tu16 fll_ratio;\n\tu16 fllclk_div;\n\tu16 fll_slow_lock_ref;\n\tu16 n;\n\tu16 k;\n};\n\n \n#define FIXED_FLL_SIZE ((1 << 16) * 10)\n\nstatic int fll_factors(struct _fll_div *fll_div, unsigned int Fref,\n\t\t       unsigned int Fout)\n{\n\tu64 Kpart;\n\tunsigned int K, Ndiv, Nmod, target;\n\tunsigned int div;\n\n\tif (WARN_ON(!Fout))\n\t\treturn -EINVAL;\n\n\t \n\ttarget = Fout;\n\tdiv = 1;\n\twhile (target < 90000000) {\n\t\tdiv *= 2;\n\t\ttarget *= 2;\n\t}\n\n\tif (target > 100000000)\n\t\tprintk(KERN_WARNING \"wm8900: FLL rate %u out of range, Fref=%u\"\n\t\t       \" Fout=%u\\n\", target, Fref, Fout);\n\tif (div > 32) {\n\t\tprintk(KERN_ERR \"wm8900: Invalid FLL division rate %u, \"\n\t\t       \"Fref=%u, Fout=%u, target=%u\\n\",\n\t\t       div, Fref, Fout, target);\n\t\treturn -EINVAL;\n\t}\n\n\tfll_div->fllclk_div = div >> 2;\n\n\tif (Fref < 48000)\n\t\tfll_div->fll_slow_lock_ref = 1;\n\telse\n\t\tfll_div->fll_slow_lock_ref = 0;\n\n\tNdiv = target / Fref;\n\n\tif (Fref < 1000000)\n\t\tfll_div->fll_ratio = 8;\n\telse\n\t\tfll_div->fll_ratio = 1;\n\n\tfll_div->n = Ndiv / fll_div->fll_ratio;\n\tNmod = (target / fll_div->fll_ratio) % Fref;\n\n\t \n\tKpart = FIXED_FLL_SIZE * (long long)Nmod;\n\n\tdo_div(Kpart, Fref);\n\n\tK = Kpart & 0xFFFFFFFF;\n\n\tif ((K % 10) >= 5)\n\t\tK += 5;\n\n\t \n\tfll_div->k = K / 10;\n\n\tif (WARN_ON(target != Fout * (fll_div->fllclk_div << 2)) ||\n\t    WARN_ON(!K && target != Fref * fll_div->fll_ratio * fll_div->n))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int wm8900_set_fll(struct snd_soc_component *component,\n\tint fll_id, unsigned int freq_in, unsigned int freq_out)\n{\n\tstruct wm8900_priv *wm8900 = snd_soc_component_get_drvdata(component);\n\tstruct _fll_div fll_div;\n\n\tif (wm8900->fll_in == freq_in && wm8900->fll_out == freq_out)\n\t\treturn 0;\n\n\t \n\tsnd_soc_component_update_bits(component, WM8900_REG_POWER1,\n\t\t\t    WM8900_REG_POWER1_FLL_ENA, 0);\n\n\t \n\tif (!freq_in || !freq_out) {\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_CLOCKING1,\n\t\t\t\t    WM8900_REG_CLOCKING1_MCLK_SRC, 0);\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_FLLCTL1,\n\t\t\t\t    WM8900_REG_FLLCTL1_OSC_ENA, 0);\n\t\twm8900->fll_in = freq_in;\n\t\twm8900->fll_out = freq_out;\n\n\t\treturn 0;\n\t}\n\n\tif (fll_factors(&fll_div, freq_in, freq_out) != 0)\n\t\tgoto reenable;\n\n\twm8900->fll_in = freq_in;\n\twm8900->fll_out = freq_out;\n\n\t \n\tsnd_soc_component_write(component, WM8900_REG_FLLCTL1,\n\t\t     fll_div.fll_ratio | WM8900_REG_FLLCTL1_OSC_ENA);\n\n\tsnd_soc_component_write(component, WM8900_REG_FLLCTL4, fll_div.n >> 5);\n\tsnd_soc_component_write(component, WM8900_REG_FLLCTL5,\n\t\t     (fll_div.fllclk_div << 6) | (fll_div.n & 0x1f));\n\n\tif (fll_div.k) {\n\t\tsnd_soc_component_write(component, WM8900_REG_FLLCTL2,\n\t\t\t     (fll_div.k >> 8) | 0x100);\n\t\tsnd_soc_component_write(component, WM8900_REG_FLLCTL3, fll_div.k & 0xff);\n\t} else\n\t\tsnd_soc_component_write(component, WM8900_REG_FLLCTL2, 0);\n\n\tif (fll_div.fll_slow_lock_ref)\n\t\tsnd_soc_component_write(component, WM8900_REG_FLLCTL6,\n\t\t\t     WM8900_REG_FLLCTL6_FLL_SLOW_LOCK_REF);\n\telse\n\t\tsnd_soc_component_write(component, WM8900_REG_FLLCTL6, 0);\n\n\tsnd_soc_component_update_bits(component, WM8900_REG_POWER1,\n\t\t\t    WM8900_REG_POWER1_FLL_ENA,\n\t\t\t    WM8900_REG_POWER1_FLL_ENA);\n\nreenable:\n\tsnd_soc_component_update_bits(component, WM8900_REG_CLOCKING1,\n\t\t\t    WM8900_REG_CLOCKING1_MCLK_SRC,\n\t\t\t    WM8900_REG_CLOCKING1_MCLK_SRC);\n\treturn 0;\n}\n\nstatic int wm8900_set_dai_pll(struct snd_soc_dai *codec_dai, int pll_id,\n\t\tint source, unsigned int freq_in, unsigned int freq_out)\n{\n\treturn wm8900_set_fll(codec_dai->component, pll_id, freq_in, freq_out);\n}\n\nstatic int wm8900_set_dai_clkdiv(struct snd_soc_dai *codec_dai,\n\t\t\t\t int div_id, int div)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\n\tswitch (div_id) {\n\tcase WM8900_BCLK_DIV:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_CLOCKING1,\n\t\t\t\t    WM8900_REG_CLOCKING1_BCLK_MASK, div);\n\t\tbreak;\n\tcase WM8900_OPCLK_DIV:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_CLOCKING1,\n\t\t\t\t    WM8900_REG_CLOCKING1_OPCLK_MASK, div);\n\t\tbreak;\n\tcase WM8900_DAC_LRCLK:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_AUDIO4,\n\t\t\t\t    WM8900_LRC_MASK, div);\n\t\tbreak;\n\tcase WM8900_ADC_LRCLK:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_AUDIO3,\n\t\t\t\t    WM8900_LRC_MASK, div);\n\t\tbreak;\n\tcase WM8900_DAC_CLKDIV:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_CLOCKING2,\n\t\t\t\t    WM8900_REG_CLOCKING2_DAC_CLKDIV, div);\n\t\tbreak;\n\tcase WM8900_ADC_CLKDIV:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_CLOCKING2,\n\t\t\t\t    WM8900_REG_CLOCKING2_ADC_CLKDIV, div);\n\t\tbreak;\n\tcase WM8900_LRCLK_MODE:\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_DACCTRL,\n\t\t\t\t    WM8900_REG_DACCTRL_AIF_LRCLKRATE, div);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n\nstatic int wm8900_set_dai_fmt(struct snd_soc_dai *codec_dai,\n\t\t\t      unsigned int fmt)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tunsigned int clocking1, aif1, aif3, aif4;\n\n\tclocking1 = snd_soc_component_read(component, WM8900_REG_CLOCKING1);\n\taif1 = snd_soc_component_read(component, WM8900_REG_AUDIO1);\n\taif3 = snd_soc_component_read(component, WM8900_REG_AUDIO3);\n\taif4 = snd_soc_component_read(component, WM8900_REG_AUDIO4);\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\n\tcase SND_SOC_DAIFMT_CBS_CFS:\n\t\tclocking1 &= ~WM8900_REG_CLOCKING1_BCLK_DIR;\n\t\taif3 &= ~WM8900_REG_AUDIO3_ADCLRC_DIR;\n\t\taif4 &= ~WM8900_REG_AUDIO4_DACLRC_DIR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBS_CFM:\n\t\tclocking1 &= ~WM8900_REG_CLOCKING1_BCLK_DIR;\n\t\taif3 |= WM8900_REG_AUDIO3_ADCLRC_DIR;\n\t\taif4 |= WM8900_REG_AUDIO4_DACLRC_DIR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFM:\n\t\tclocking1 |= WM8900_REG_CLOCKING1_BCLK_DIR;\n\t\taif3 |= WM8900_REG_AUDIO3_ADCLRC_DIR;\n\t\taif4 |= WM8900_REG_AUDIO4_DACLRC_DIR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFS:\n\t\tclocking1 |= WM8900_REG_CLOCKING1_BCLK_DIR;\n\t\taif3 &= ~WM8900_REG_AUDIO3_ADCLRC_DIR;\n\t\taif4 &= ~WM8900_REG_AUDIO4_DACLRC_DIR;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\taif1 |= WM8900_REG_AUDIO1_AIF_FMT_MASK;\n\t\taif1 &= ~WM8900_REG_AUDIO1_LRCLK_INV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\taif1 |= WM8900_REG_AUDIO1_AIF_FMT_MASK;\n\t\taif1 |= WM8900_REG_AUDIO1_LRCLK_INV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_I2S:\n\t\taif1 &= ~WM8900_REG_AUDIO1_AIF_FMT_MASK;\n\t\taif1 |= 0x10;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\taif1 &= ~WM8900_REG_AUDIO1_AIF_FMT_MASK;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\taif1 &= ~WM8900_REG_AUDIO1_AIF_FMT_MASK;\n\t\taif1 |= 0x8;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\t \n\t\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\t\tcase SND_SOC_DAIFMT_NB_NF:\n\t\t\taif1 &= ~WM8900_REG_AUDIO1_BCLK_INV;\n\t\t\tbreak;\n\t\tcase SND_SOC_DAIFMT_IB_NF:\n\t\t\taif1 |= WM8900_REG_AUDIO1_BCLK_INV;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_I2S:\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\t\tcase SND_SOC_DAIFMT_NB_NF:\n\t\t\taif1 &= ~WM8900_REG_AUDIO1_BCLK_INV;\n\t\t\taif1 &= ~WM8900_REG_AUDIO1_LRCLK_INV;\n\t\t\tbreak;\n\t\tcase SND_SOC_DAIFMT_IB_IF:\n\t\t\taif1 |= WM8900_REG_AUDIO1_BCLK_INV;\n\t\t\taif1 |= WM8900_REG_AUDIO1_LRCLK_INV;\n\t\t\tbreak;\n\t\tcase SND_SOC_DAIFMT_IB_NF:\n\t\t\taif1 |= WM8900_REG_AUDIO1_BCLK_INV;\n\t\t\taif1 &= ~WM8900_REG_AUDIO1_LRCLK_INV;\n\t\t\tbreak;\n\t\tcase SND_SOC_DAIFMT_NB_IF:\n\t\t\taif1 &= ~WM8900_REG_AUDIO1_BCLK_INV;\n\t\t\taif1 |= WM8900_REG_AUDIO1_LRCLK_INV;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_write(component, WM8900_REG_CLOCKING1, clocking1);\n\tsnd_soc_component_write(component, WM8900_REG_AUDIO1, aif1);\n\tsnd_soc_component_write(component, WM8900_REG_AUDIO3, aif3);\n\tsnd_soc_component_write(component, WM8900_REG_AUDIO4, aif4);\n\n\treturn 0;\n}\n\nstatic int wm8900_mute(struct snd_soc_dai *codec_dai, int mute, int direction)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tu16 reg;\n\n\treg = snd_soc_component_read(component, WM8900_REG_DACCTRL);\n\n\tif (mute)\n\t\treg |= WM8900_REG_DACCTRL_MUTE;\n\telse\n\t\treg &= ~WM8900_REG_DACCTRL_MUTE;\n\n\tsnd_soc_component_write(component, WM8900_REG_DACCTRL, reg);\n\n\treturn 0;\n}\n\n#define WM8900_RATES (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_11025 |\\\n\t\t      SNDRV_PCM_RATE_16000 | SNDRV_PCM_RATE_22050 |\\\n\t\t      SNDRV_PCM_RATE_44100 | SNDRV_PCM_RATE_48000)\n\n#define WM8900_PCM_FORMATS \\\n\t(SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S20_3LE | \\\n\t SNDRV_PCM_FMTBIT_S24_LE)\n\nstatic const struct snd_soc_dai_ops wm8900_dai_ops = {\n\t.hw_params\t= wm8900_hw_params,\n\t.set_clkdiv\t= wm8900_set_dai_clkdiv,\n\t.set_pll\t= wm8900_set_dai_pll,\n\t.set_fmt\t= wm8900_set_dai_fmt,\n\t.mute_stream\t= wm8900_mute,\n\t.no_capture_mute = 1,\n};\n\nstatic struct snd_soc_dai_driver wm8900_dai = {\n\t.name = \"wm8900-hifi\",\n\t.playback = {\n\t\t.stream_name = \"HiFi Playback\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = WM8900_RATES,\n\t\t.formats = WM8900_PCM_FORMATS,\n\t},\n\t.capture = {\n\t\t.stream_name = \"HiFi Capture\",\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = WM8900_RATES,\n\t\t.formats = WM8900_PCM_FORMATS,\n\t },\n\t.ops = &wm8900_dai_ops,\n};\n\nstatic int wm8900_set_bias_level(struct snd_soc_component *component,\n\t\t\t\t enum snd_soc_bias_level level)\n{\n\tu16 reg;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_ON:\n\t\t \n\t\tsnd_soc_component_update_bits(component, WM8900_REG_GPIO,\n\t\t\t\t    WM8900_REG_GPIO_TEMP_ENA,\n\t\t\t\t    WM8900_REG_GPIO_TEMP_ENA);\n\t\tsnd_soc_component_update_bits(component, WM8900_REG_ADDCTL,\n\t\t\t\t    WM8900_REG_ADDCTL_TEMP_SD,\n\t\t\t\t    WM8900_REG_ADDCTL_TEMP_SD);\n\t\tbreak;\n\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tbreak;\n\n\tcase SND_SOC_BIAS_STANDBY:\n\t\t \n\t\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF) {\n\t\t\t \n\t\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t\t     WM8900_REG_POWER1_STARTUP_BIAS_ENA);\n\n\t\t\t \n\t\t\tsnd_soc_component_write(component, WM8900_REG_ADDCTL,\n\t\t\t\t     WM8900_REG_ADDCTL_BIAS_SRC |\n\t\t\t\t     WM8900_REG_ADDCTL_VMID_SOFTST);\n\n\t\t\t \n\t\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t\t     WM8900_REG_POWER1_STARTUP_BIAS_ENA | 0x1);\n\n\t\t\t \n\t\t\tschedule_timeout_interruptible(msecs_to_jiffies(400));\n\n\t\t\t \n\t\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t\t     WM8900_REG_POWER1_STARTUP_BIAS_ENA |\n\t\t\t\t     WM8900_REG_POWER1_BIAS_ENA | 0x1);\n\n\t\t\tsnd_soc_component_write(component, WM8900_REG_ADDCTL, 0);\n\n\t\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t\t     WM8900_REG_POWER1_BIAS_ENA | 0x1);\n\t\t}\n\n\t\treg = snd_soc_component_read(component, WM8900_REG_POWER1);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t     (reg & WM8900_REG_POWER1_FLL_ENA) |\n\t\t\t     WM8900_REG_POWER1_BIAS_ENA | 0x1);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER2,\n\t\t\t     WM8900_REG_POWER2_SYSCLK_ENA);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER3, 0);\n\t\tbreak;\n\n\tcase SND_SOC_BIAS_OFF:\n\t\t \n\t\treg = snd_soc_component_read(component, WM8900_REG_POWER1);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t     reg & WM8900_REG_POWER1_STARTUP_BIAS_ENA);\n\t\tsnd_soc_component_write(component, WM8900_REG_ADDCTL,\n\t\t\t     WM8900_REG_ADDCTL_BIAS_SRC |\n\t\t\t     WM8900_REG_ADDCTL_VMID_SOFTST);\n\n\t\t \n\t\tsnd_soc_component_write(component, WM8900_REG_POWER1,\n\t\t\t     WM8900_REG_POWER1_STARTUP_BIAS_ENA);\n\t\tschedule_timeout_interruptible(msecs_to_jiffies(500));\n\n\t\t \n\t\tsnd_soc_component_write(component, WM8900_REG_HPCTL1, 0);\n\n\t\t \n\t\tsnd_soc_component_write(component, WM8900_REG_ADDCTL, 0);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER1, 0);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER2, 0);\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER3, 0);\n\n\t\t \n\t\tschedule_timeout_interruptible(msecs_to_jiffies(1));\n\t\tsnd_soc_component_write(component, WM8900_REG_POWER2,\n\t\t\t     WM8900_REG_POWER2_SYSCLK_ENA);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int wm8900_suspend(struct snd_soc_component *component)\n{\n\tstruct wm8900_priv *wm8900 = snd_soc_component_get_drvdata(component);\n\tint fll_out = wm8900->fll_out;\n\tint fll_in  = wm8900->fll_in;\n\tint ret;\n\n\t \n\tret = wm8900_set_fll(component, 0, 0, 0);\n\tif (ret != 0) {\n\t\tdev_err(component->dev, \"Failed to stop FLL\\n\");\n\t\treturn ret;\n\t}\n\n\twm8900->fll_out = fll_out;\n\twm8900->fll_in = fll_in;\n\n\tsnd_soc_component_force_bias_level(component, SND_SOC_BIAS_OFF);\n\n\treturn 0;\n}\n\nstatic int wm8900_resume(struct snd_soc_component *component)\n{\n\tstruct wm8900_priv *wm8900 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\twm8900_reset(component);\n\n\tret = regcache_sync(wm8900->regmap);\n\tif (ret != 0) {\n\t\tdev_err(component->dev, \"Failed to restore cache: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tsnd_soc_component_force_bias_level(component, SND_SOC_BIAS_STANDBY);\n\n\t \n\tif (wm8900->fll_out) {\n\t\tint fll_out = wm8900->fll_out;\n\t\tint fll_in  = wm8900->fll_in;\n\n\t\twm8900->fll_in = 0;\n\t\twm8900->fll_out = 0;\n\n\t\tret = wm8900_set_fll(component, 0, fll_in, fll_out);\n\t\tif (ret != 0) {\n\t\t\tdev_err(component->dev, \"Failed to restart FLL\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int wm8900_probe(struct snd_soc_component *component)\n{\n\tint reg;\n\n\treg = snd_soc_component_read(component, WM8900_REG_ID);\n\tif (reg != 0x8900) {\n\t\tdev_err(component->dev, \"Device is not a WM8900 - ID %x\\n\", reg);\n\t\treturn -ENODEV;\n\t}\n\n\twm8900_reset(component);\n\n\t \n\tsnd_soc_component_force_bias_level(component, SND_SOC_BIAS_STANDBY);\n\n\t \n\tsnd_soc_component_update_bits(component, WM8900_REG_LINVOL, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_RINVOL, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_LOUT1CTL, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_ROUT1CTL, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_LOUT2CTL, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_ROUT2CTL, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_LDAC_DV, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_RDAC_DV, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_LADC_DV, 0x100, 0x100);\n\tsnd_soc_component_update_bits(component, WM8900_REG_RADC_DV, 0x100, 0x100);\n\n\t \n\tsnd_soc_component_write(component, WM8900_REG_OUTBIASCTL, 0x81);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver soc_component_dev_wm8900 = {\n\t.probe\t\t\t= wm8900_probe,\n\t.suspend\t\t= wm8900_suspend,\n\t.resume\t\t\t= wm8900_resume,\n\t.set_bias_level\t\t= wm8900_set_bias_level,\n\t.controls\t\t= wm8900_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(wm8900_snd_controls),\n\t.dapm_widgets\t\t= wm8900_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(wm8900_dapm_widgets),\n\t.dapm_routes\t\t= wm8900_dapm_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(wm8900_dapm_routes),\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic const struct regmap_config wm8900_regmap = {\n\t.reg_bits = 8,\n\t.val_bits = 16,\n\t.max_register = WM8900_MAXREG,\n\n\t.reg_defaults = wm8900_reg_defaults,\n\t.num_reg_defaults = ARRAY_SIZE(wm8900_reg_defaults),\n\t.cache_type = REGCACHE_MAPLE,\n\n\t.volatile_reg = wm8900_volatile_register,\n};\n\n#if defined(CONFIG_SPI_MASTER)\nstatic int wm8900_spi_probe(struct spi_device *spi)\n{\n\tstruct wm8900_priv *wm8900;\n\tint ret;\n\n\twm8900 = devm_kzalloc(&spi->dev, sizeof(struct wm8900_priv),\n\t\t\t      GFP_KERNEL);\n\tif (wm8900 == NULL)\n\t\treturn -ENOMEM;\n\n\twm8900->regmap = devm_regmap_init_spi(spi, &wm8900_regmap);\n\tif (IS_ERR(wm8900->regmap))\n\t\treturn PTR_ERR(wm8900->regmap);\n\n\tspi_set_drvdata(spi, wm8900);\n\n\tret = devm_snd_soc_register_component(&spi->dev,\n\t\t\t&soc_component_dev_wm8900, &wm8900_dai, 1);\n\n\treturn ret;\n}\n\nstatic struct spi_driver wm8900_spi_driver = {\n\t.driver = {\n\t\t.name\t= \"wm8900\",\n\t},\n\t.probe\t\t= wm8900_spi_probe,\n};\n#endif  \n\n#if IS_ENABLED(CONFIG_I2C)\nstatic int wm8900_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct wm8900_priv *wm8900;\n\tint ret;\n\n\twm8900 = devm_kzalloc(&i2c->dev, sizeof(struct wm8900_priv),\n\t\t\t      GFP_KERNEL);\n\tif (wm8900 == NULL)\n\t\treturn -ENOMEM;\n\n\twm8900->regmap = devm_regmap_init_i2c(i2c, &wm8900_regmap);\n\tif (IS_ERR(wm8900->regmap))\n\t\treturn PTR_ERR(wm8900->regmap);\n\n\ti2c_set_clientdata(i2c, wm8900);\n\n\tret = devm_snd_soc_register_component(&i2c->dev,\n\t\t\t&soc_component_dev_wm8900, &wm8900_dai, 1);\n\n\treturn ret;\n}\n\nstatic void wm8900_i2c_remove(struct i2c_client *client)\n{}\n\nstatic const struct i2c_device_id wm8900_i2c_id[] = {\n\t{ \"wm8900\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, wm8900_i2c_id);\n\nstatic struct i2c_driver wm8900_i2c_driver = {\n\t.driver = {\n\t\t.name = \"wm8900\",\n\t},\n\t.probe =    wm8900_i2c_probe,\n\t.remove =   wm8900_i2c_remove,\n\t.id_table = wm8900_i2c_id,\n};\n#endif\n\nstatic int __init wm8900_modinit(void)\n{\n\tint ret = 0;\n#if IS_ENABLED(CONFIG_I2C)\n\tret = i2c_add_driver(&wm8900_i2c_driver);\n\tif (ret != 0) {\n\t\tprintk(KERN_ERR \"Failed to register wm8900 I2C driver: %d\\n\",\n\t\t       ret);\n\t}\n#endif\n#if defined(CONFIG_SPI_MASTER)\n\tret = spi_register_driver(&wm8900_spi_driver);\n\tif (ret != 0) {\n\t\tprintk(KERN_ERR \"Failed to register wm8900 SPI driver: %d\\n\",\n\t\t       ret);\n\t}\n#endif\n\treturn ret;\n}\nmodule_init(wm8900_modinit);\n\nstatic void __exit wm8900_exit(void)\n{\n#if IS_ENABLED(CONFIG_I2C)\n\ti2c_del_driver(&wm8900_i2c_driver);\n#endif\n#if defined(CONFIG_SPI_MASTER)\n\tspi_unregister_driver(&wm8900_spi_driver);\n#endif\n}\nmodule_exit(wm8900_exit);\n\nMODULE_DESCRIPTION(\"ASoC WM8900 driver\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}