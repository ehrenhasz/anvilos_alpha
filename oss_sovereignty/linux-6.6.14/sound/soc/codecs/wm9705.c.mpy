{
  "module_name": "wm9705.c",
  "hash_id": "fa468bf32c447e86cd8f62ed8851b63465f111689278efc20afabb9894862e8a",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/wm9705.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/mfd/wm97xx.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/device.h>\n#include <linux/regmap.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/ac97_codec.h>\n#include <sound/ac97/codec.h>\n#include <sound/ac97/compat.h>\n#include <sound/initval.h>\n#include <sound/soc.h>\n\n#define WM9705_VENDOR_ID 0x574d4c05\n#define WM9705_VENDOR_ID_MASK 0xffffffff\n\nstruct wm9705_priv {\n\tstruct snd_ac97 *ac97;\n\tstruct wm97xx_platform_data *mfd_pdata;\n};\n\nstatic const struct reg_default wm9705_reg_defaults[] = {\n\t{ 0x02, 0x8000 },\n\t{ 0x04, 0x8000 },\n\t{ 0x06, 0x8000 },\n\t{ 0x0a, 0x8000 },\n\t{ 0x0c, 0x8008 },\n\t{ 0x0e, 0x8008 },\n\t{ 0x10, 0x8808 },\n\t{ 0x12, 0x8808 },\n\t{ 0x14, 0x8808 },\n\t{ 0x16, 0x8808 },\n\t{ 0x18, 0x8808 },\n\t{ 0x1a, 0x0000 },\n\t{ 0x1c, 0x8000 },\n\t{ 0x20, 0x0000 },\n\t{ 0x22, 0x0000 },\n\t{ 0x26, 0x000f },\n\t{ 0x28, 0x0605 },\n\t{ 0x2a, 0x0000 },\n\t{ 0x2c, 0xbb80 },\n\t{ 0x32, 0xbb80 },\n\t{ 0x34, 0x2000 },\n\t{ 0x5a, 0x0000 },\n\t{ 0x5c, 0x0000 },\n\t{ 0x72, 0x0808 },\n\t{ 0x74, 0x0000 },\n\t{ 0x76, 0x0006 },\n\t{ 0x78, 0x0000 },\n\t{ 0x7a, 0x0000 },\n};\n\nstatic const struct regmap_config wm9705_regmap_config = {\n\t.reg_bits = 16,\n\t.reg_stride = 2,\n\t.val_bits = 16,\n\t.max_register = 0x7e,\n\t.cache_type = REGCACHE_MAPLE,\n\n\t.volatile_reg = regmap_ac97_default_volatile,\n\n\t.reg_defaults = wm9705_reg_defaults,\n\t.num_reg_defaults = ARRAY_SIZE(wm9705_reg_defaults),\n};\n\nstatic const struct snd_kcontrol_new wm9705_snd_ac97_controls[] = {\n\tSOC_DOUBLE(\"Master Playback Volume\", AC97_MASTER, 8, 0, 31, 1),\n\tSOC_SINGLE(\"Master Playback Switch\", AC97_MASTER, 15, 1, 1),\n\tSOC_DOUBLE(\"Headphone Playback Volume\", AC97_HEADPHONE, 8, 0, 31, 1),\n\tSOC_SINGLE(\"Headphone Playback Switch\", AC97_HEADPHONE, 15, 1, 1),\n\tSOC_DOUBLE(\"PCM Playback Volume\", AC97_PCM, 8, 0, 31, 1),\n\tSOC_SINGLE(\"PCM Playback Switch\", AC97_PCM, 15, 1, 1),\n\tSOC_SINGLE(\"Mono Playback Volume\", AC97_MASTER_MONO, 0, 31, 1),\n\tSOC_SINGLE(\"Mono Playback Switch\", AC97_MASTER_MONO, 15, 1, 1),\n\tSOC_SINGLE(\"PCBeep Playback Volume\", AC97_PC_BEEP, 1, 15, 1),\n\tSOC_SINGLE(\"Phone Playback Volume\", AC97_PHONE, 0, 31, 1),\n\tSOC_DOUBLE(\"Line Playback Volume\", AC97_LINE, 8, 0, 31, 1),\n\tSOC_DOUBLE(\"CD Playback Volume\", AC97_CD, 8, 0, 31, 1),\n\tSOC_SINGLE(\"Mic Playback Volume\", AC97_MIC, 0, 31, 1),\n\tSOC_SINGLE(\"Mic 20dB Boost Switch\", AC97_MIC, 6, 1, 0),\n\tSOC_DOUBLE(\"Capture Volume\", AC97_REC_GAIN, 8, 0, 15, 0),\n\tSOC_SINGLE(\"Capture Switch\", AC97_REC_GAIN, 15, 1, 1),\n};\n\nstatic const char *wm9705_mic[] = {\"Mic 1\", \"Mic 2\"};\nstatic const char *wm9705_rec_sel[] = {\"Mic\", \"CD\", \"NC\", \"NC\",\n\t\"Line\", \"Stereo Mix\", \"Mono Mix\", \"Phone\"};\n\nstatic SOC_ENUM_SINGLE_DECL(wm9705_enum_mic,\n\t\t\t    AC97_GENERAL_PURPOSE, 8, wm9705_mic);\nstatic SOC_ENUM_SINGLE_DECL(wm9705_enum_rec_l,\n\t\t\t    AC97_REC_SEL, 8, wm9705_rec_sel);\nstatic SOC_ENUM_SINGLE_DECL(wm9705_enum_rec_r,\n\t\t\t    AC97_REC_SEL, 0, wm9705_rec_sel);\n\n \nstatic const struct snd_kcontrol_new wm9705_hp_mixer_controls[] = {\n\tSOC_DAPM_SINGLE(\"PCBeep Playback Switch\", AC97_PC_BEEP, 15, 1, 1),\n\tSOC_DAPM_SINGLE(\"CD Playback Switch\", AC97_CD, 15, 1, 1),\n\tSOC_DAPM_SINGLE(\"Mic Playback Switch\", AC97_MIC, 15, 1, 1),\n\tSOC_DAPM_SINGLE(\"Phone Playback Switch\", AC97_PHONE, 15, 1, 1),\n\tSOC_DAPM_SINGLE(\"Line Playback Switch\", AC97_LINE, 15, 1, 1),\n};\n\n \nstatic const struct snd_kcontrol_new wm9705_mic_src_controls =\n\tSOC_DAPM_ENUM(\"Route\", wm9705_enum_mic);\n\n \nstatic const struct snd_kcontrol_new wm9705_capture_selectl_controls =\n\tSOC_DAPM_ENUM(\"Route\", wm9705_enum_rec_l);\nstatic const struct snd_kcontrol_new wm9705_capture_selectr_controls =\n\tSOC_DAPM_ENUM(\"Route\", wm9705_enum_rec_r);\n\n \nstatic const struct snd_soc_dapm_widget wm9705_dapm_widgets[] = {\n\tSND_SOC_DAPM_MUX(\"Mic Source\", SND_SOC_NOPM, 0, 0,\n\t\t&wm9705_mic_src_controls),\n\tSND_SOC_DAPM_MUX(\"Left Capture Source\", SND_SOC_NOPM, 0, 0,\n\t\t&wm9705_capture_selectl_controls),\n\tSND_SOC_DAPM_MUX(\"Right Capture Source\", SND_SOC_NOPM, 0, 0,\n\t\t&wm9705_capture_selectr_controls),\n\tSND_SOC_DAPM_DAC(\"Left DAC\", \"Left HiFi Playback\",\n\t\tSND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_DAC(\"Right DAC\", \"Right HiFi Playback\",\n\t\tSND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_MIXER_NAMED_CTL(\"HP Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t&wm9705_hp_mixer_controls[0],\n\t\tARRAY_SIZE(wm9705_hp_mixer_controls)),\n\tSND_SOC_DAPM_MIXER(\"Mono Mixer\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_ADC(\"Left ADC\", \"Left HiFi Capture\", SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_ADC(\"Right ADC\", \"Right HiFi Capture\", SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_PGA(\"Headphone PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Speaker PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Line PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Line out PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Mono PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Phone PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Mic PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"PCBEEP PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"CD PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ADC PGA\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_OUTPUT(\"HPOUTL\"),\n\tSND_SOC_DAPM_OUTPUT(\"HPOUTR\"),\n\tSND_SOC_DAPM_OUTPUT(\"LOUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ROUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"MONOOUT\"),\n\tSND_SOC_DAPM_INPUT(\"PHONE\"),\n\tSND_SOC_DAPM_INPUT(\"LINEINL\"),\n\tSND_SOC_DAPM_INPUT(\"LINEINR\"),\n\tSND_SOC_DAPM_INPUT(\"CDINL\"),\n\tSND_SOC_DAPM_INPUT(\"CDINR\"),\n\tSND_SOC_DAPM_INPUT(\"PCBEEP\"),\n\tSND_SOC_DAPM_INPUT(\"MIC1\"),\n\tSND_SOC_DAPM_INPUT(\"MIC2\"),\n};\n\n \nstatic const struct snd_soc_dapm_route wm9705_audio_map[] = {\n\t \n\t{\"HP Mixer\", \"PCBeep Playback Switch\", \"PCBEEP PGA\"},\n\t{\"HP Mixer\", \"CD Playback Switch\", \"CD PGA\"},\n\t{\"HP Mixer\", \"Mic Playback Switch\", \"Mic PGA\"},\n\t{\"HP Mixer\", \"Phone Playback Switch\", \"Phone PGA\"},\n\t{\"HP Mixer\", \"Line Playback Switch\", \"Line PGA\"},\n\t{\"HP Mixer\", NULL, \"Left DAC\"},\n\t{\"HP Mixer\", NULL, \"Right DAC\"},\n\n\t \n\t{\"Mono Mixer\", NULL, \"HP Mixer\"},\n\n\t \n\t{\"Headphone PGA\", NULL, \"HP Mixer\"},\n\t{\"HPOUTL\", NULL, \"Headphone PGA\"},\n\t{\"HPOUTR\", NULL, \"Headphone PGA\"},\n\t{\"Line out PGA\", NULL, \"HP Mixer\"},\n\t{\"LOUT\", NULL, \"Line out PGA\"},\n\t{\"ROUT\", NULL, \"Line out PGA\"},\n\t{\"Mono PGA\", NULL, \"Mono Mixer\"},\n\t{\"MONOOUT\", NULL, \"Mono PGA\"},\n\n\t \n\t{\"CD PGA\", NULL, \"CDINL\"},\n\t{\"CD PGA\", NULL, \"CDINR\"},\n\t{\"Line PGA\", NULL, \"LINEINL\"},\n\t{\"Line PGA\", NULL, \"LINEINR\"},\n\t{\"Phone PGA\", NULL, \"PHONE\"},\n\t{\"Mic Source\", \"Mic 1\", \"MIC1\"},\n\t{\"Mic Source\", \"Mic 2\", \"MIC2\"},\n\t{\"Mic PGA\", NULL, \"Mic Source\"},\n\t{\"PCBEEP PGA\", NULL, \"PCBEEP\"},\n\n\t \n\t{\"Left Capture Source\", \"Mic\", \"Mic Source\"},\n\t{\"Left Capture Source\", \"CD\", \"CDINL\"},\n\t{\"Left Capture Source\", \"Line\", \"LINEINL\"},\n\t{\"Left Capture Source\", \"Stereo Mix\", \"HP Mixer\"},\n\t{\"Left Capture Source\", \"Mono Mix\", \"HP Mixer\"},\n\t{\"Left Capture Source\", \"Phone\", \"PHONE\"},\n\n\t \n\t{\"Right Capture Source\", \"Mic\", \"Mic Source\"},\n\t{\"Right Capture Source\", \"CD\", \"CDINR\"},\n\t{\"Right Capture Source\", \"Line\", \"LINEINR\"},\n\t{\"Right Capture Source\", \"Stereo Mix\", \"HP Mixer\"},\n\t{\"Right Capture Source\", \"Mono Mix\", \"HP Mixer\"},\n\t{\"Right Capture Source\", \"Phone\", \"PHONE\"},\n\n\t{\"ADC PGA\", NULL, \"Left Capture Source\"},\n\t{\"ADC PGA\", NULL, \"Right Capture Source\"},\n\n\t \n\t{\"Left ADC\",  NULL, \"ADC PGA\"},\n\t{\"Right ADC\", NULL, \"ADC PGA\"},\n};\n\nstatic int ac97_prepare(struct snd_pcm_substream *substream,\n\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint reg;\n\n\tsnd_soc_component_update_bits(component, AC97_EXTENDED_STATUS, 0x1, 0x1);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\treg = AC97_PCM_FRONT_DAC_RATE;\n\telse\n\t\treg = AC97_PCM_LR_ADC_RATE;\n\n\treturn snd_soc_component_write(component, reg, substream->runtime->rate);\n}\n\n#define WM9705_AC97_RATES (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_11025 | \\\n\t\t\tSNDRV_PCM_RATE_16000 | SNDRV_PCM_RATE_22050 | \\\n\t\t\tSNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 | \\\n\t\t\tSNDRV_PCM_RATE_48000)\n\nstatic const struct snd_soc_dai_ops wm9705_dai_ops = {\n\t.prepare\t= ac97_prepare,\n};\n\nstatic struct snd_soc_dai_driver wm9705_dai[] = {\n\t{\n\t\t.name = \"wm9705-hifi\",\n\t\t.playback = {\n\t\t\t.stream_name = \"HiFi Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = WM9705_AC97_RATES,\n\t\t\t.formats = SND_SOC_STD_AC97_FMTS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"HiFi Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = WM9705_AC97_RATES,\n\t\t\t.formats = SND_SOC_STD_AC97_FMTS,\n\t\t},\n\t\t.ops = &wm9705_dai_ops,\n\t},\n\t{\n\t\t.name = \"wm9705-aux\",\n\t\t.playback = {\n\t\t\t.stream_name = \"Aux Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 1,\n\t\t\t.rates = WM9705_AC97_RATES,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t}\n};\n\n#ifdef CONFIG_PM\nstatic int wm9705_soc_suspend(struct snd_soc_component *component)\n{\n\tregcache_cache_bypass(component->regmap, true);\n\tsnd_soc_component_write(component, AC97_POWERDOWN, 0xffff);\n\tregcache_cache_bypass(component->regmap, false);\n\n\treturn 0;\n}\n\nstatic int wm9705_soc_resume(struct snd_soc_component *component)\n{\n\tstruct wm9705_priv *wm9705 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = snd_ac97_reset(wm9705->ac97, true, WM9705_VENDOR_ID,\n\t\tWM9705_VENDOR_ID_MASK);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tsnd_soc_component_cache_sync(component);\n\n\treturn 0;\n}\n#else\n#define wm9705_soc_suspend NULL\n#define wm9705_soc_resume NULL\n#endif\n\nstatic int wm9705_soc_probe(struct snd_soc_component *component)\n{\n\tstruct wm9705_priv *wm9705 = snd_soc_component_get_drvdata(component);\n\tstruct regmap *regmap;\n\n\tif (wm9705->mfd_pdata) {\n\t\twm9705->ac97 = wm9705->mfd_pdata->ac97;\n\t\tregmap = wm9705->mfd_pdata->regmap;\n\t} else if (IS_ENABLED(CONFIG_SND_SOC_AC97_BUS)) {\n\t\twm9705->ac97 = snd_soc_new_ac97_component(component, WM9705_VENDOR_ID,\n\t\t\t\t\t\t      WM9705_VENDOR_ID_MASK);\n\t\tif (IS_ERR(wm9705->ac97)) {\n\t\t\tdev_err(component->dev, \"Failed to register AC97 codec\\n\");\n\t\t\treturn PTR_ERR(wm9705->ac97);\n\t\t}\n\n\t\tregmap = regmap_init_ac97(wm9705->ac97, &wm9705_regmap_config);\n\t\tif (IS_ERR(regmap)) {\n\t\t\tsnd_soc_free_ac97_component(wm9705->ac97);\n\t\t\treturn PTR_ERR(regmap);\n\t\t}\n\t} else {\n\t\treturn -ENXIO;\n\t}\n\n\tsnd_soc_component_set_drvdata(component, wm9705->ac97);\n\tsnd_soc_component_init_regmap(component, regmap);\n\n\treturn 0;\n}\n\nstatic void wm9705_soc_remove(struct snd_soc_component *component)\n{\n\tstruct wm9705_priv *wm9705 = snd_soc_component_get_drvdata(component);\n\n\tif (IS_ENABLED(CONFIG_SND_SOC_AC97_BUS) && !wm9705->mfd_pdata) {\n\t\tsnd_soc_component_exit_regmap(component);\n\t\tsnd_soc_free_ac97_component(wm9705->ac97);\n\t}\n}\n\nstatic const struct snd_soc_component_driver soc_component_dev_wm9705 = {\n\t.probe\t\t\t= wm9705_soc_probe,\n\t.remove\t\t\t= wm9705_soc_remove,\n\t.suspend\t\t= wm9705_soc_suspend,\n\t.resume\t\t\t= wm9705_soc_resume,\n\t.controls\t\t= wm9705_snd_ac97_controls,\n\t.num_controls\t\t= ARRAY_SIZE(wm9705_snd_ac97_controls),\n\t.dapm_widgets\t\t= wm9705_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(wm9705_dapm_widgets),\n\t.dapm_routes\t\t= wm9705_audio_map,\n\t.num_dapm_routes\t= ARRAY_SIZE(wm9705_audio_map),\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic int wm9705_probe(struct platform_device *pdev)\n{\n\tstruct wm9705_priv *wm9705;\n\n\twm9705 = devm_kzalloc(&pdev->dev, sizeof(*wm9705), GFP_KERNEL);\n\tif (wm9705 == NULL)\n\t\treturn -ENOMEM;\n\n\twm9705->mfd_pdata = dev_get_platdata(&pdev->dev);\n\tplatform_set_drvdata(pdev, wm9705);\n\n\treturn devm_snd_soc_register_component(&pdev->dev,\n\t\t\t&soc_component_dev_wm9705, wm9705_dai, ARRAY_SIZE(wm9705_dai));\n}\n\nstatic struct platform_driver wm9705_codec_driver = {\n\t.driver = {\n\t\t\t.name = \"wm9705-codec\",\n\t},\n\n\t.probe = wm9705_probe,\n};\n\nmodule_platform_driver(wm9705_codec_driver);\n\nMODULE_DESCRIPTION(\"ASoC WM9705 driver\");\nMODULE_AUTHOR(\"Ian Molton\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}