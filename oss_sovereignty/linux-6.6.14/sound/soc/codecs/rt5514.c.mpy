{
  "module_name": "rt5514.c",
  "hash_id": "31d4d39d6bf046a6c94cb9f817184dd7449826440484d7ce3d7c076f6c09aa58",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/rt5514.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/fs.h>\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/pm.h>\n#include <linux/regmap.h>\n#include <linux/i2c.h>\n#include <linux/platform_device.h>\n#include <linux/firmware.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n#include <sound/initval.h>\n#include <sound/tlv.h>\n\n#include \"rl6231.h\"\n#include \"rt5514.h\"\n#if IS_ENABLED(CONFIG_SND_SOC_RT5514_SPI)\n#include \"rt5514-spi.h\"\n#endif\n\nstatic const struct reg_sequence rt5514_i2c_patch[] = {\n\t{0x1800101c, 0x00000000},\n\t{0x18001100, 0x0000031f},\n\t{0x18001104, 0x00000007},\n\t{0x18001108, 0x00000000},\n\t{0x1800110c, 0x00000000},\n\t{0x18001110, 0x00000000},\n\t{0x18001114, 0x00000001},\n\t{0x18001118, 0x00000000},\n\t{0x18002f08, 0x00000006},\n\t{0x18002f00, 0x00055149},\n\t{0x18002f00, 0x0005514b},\n\t{0x18002f00, 0x00055149},\n\t{0xfafafafa, 0x00000001},\n\t{0x18002f10, 0x00000001},\n\t{0x18002f10, 0x00000000},\n\t{0x18002f10, 0x00000001},\n\t{0xfafafafa, 0x00000001},\n\t{0x18002000, 0x000010ec},\n\t{0xfafafafa, 0x00000000},\n};\n\nstatic const struct reg_sequence rt5514_patch[] = {\n\t{RT5514_DIG_IO_CTRL,\t\t0x00000040},\n\t{RT5514_CLK_CTRL1,\t\t0x38020041},\n\t{RT5514_SRC_CTRL,\t\t0x44000eee},\n\t{RT5514_ANA_CTRL_LDO10,\t\t0x00028604},\n\t{RT5514_ANA_CTRL_ADCFED,\t0x00000800},\n\t{RT5514_ASRC_IN_CTRL1,\t\t0x00000003},\n\t{RT5514_DOWNFILTER0_CTRL3,\t0x10000342},\n\t{RT5514_DOWNFILTER1_CTRL3,\t0x10000342},\n};\n\nstatic const struct reg_default rt5514_reg[] = {\n\t{RT5514_RESET,\t\t\t0x00000000},\n\t{RT5514_PWR_ANA1,\t\t0x00808880},\n\t{RT5514_PWR_ANA2,\t\t0x00220000},\n\t{RT5514_I2S_CTRL1,\t\t0x00000330},\n\t{RT5514_I2S_CTRL2,\t\t0x20000000},\n\t{RT5514_VAD_CTRL6,\t\t0xc00007d2},\n\t{RT5514_EXT_VAD_CTRL,\t\t0x80000080},\n\t{RT5514_DIG_IO_CTRL,\t\t0x00000040},\n\t{RT5514_PAD_CTRL1,\t\t0x00804000},\n\t{RT5514_DMIC_DATA_CTRL,\t\t0x00000005},\n\t{RT5514_DIG_SOURCE_CTRL,\t0x00000002},\n\t{RT5514_SRC_CTRL,\t\t0x44000eee},\n\t{RT5514_DOWNFILTER2_CTRL1,\t0x0000882f},\n\t{RT5514_PLL_SOURCE_CTRL,\t0x00000004},\n\t{RT5514_CLK_CTRL1,\t\t0x38020041},\n\t{RT5514_CLK_CTRL2,\t\t0x00000000},\n\t{RT5514_PLL3_CALIB_CTRL1,\t0x00400200},\n\t{RT5514_PLL3_CALIB_CTRL5,\t0x40220012},\n\t{RT5514_DELAY_BUF_CTRL1,\t0x7fff006a},\n\t{RT5514_DELAY_BUF_CTRL3,\t0x00000000},\n\t{RT5514_ASRC_IN_CTRL1,\t\t0x00000003},\n\t{RT5514_DOWNFILTER0_CTRL1,\t0x00020c2f},\n\t{RT5514_DOWNFILTER0_CTRL2,\t0x00020c2f},\n\t{RT5514_DOWNFILTER0_CTRL3,\t0x10000342},\n\t{RT5514_DOWNFILTER1_CTRL1,\t0x00020c2f},\n\t{RT5514_DOWNFILTER1_CTRL2,\t0x00020c2f},\n\t{RT5514_DOWNFILTER1_CTRL3,\t0x10000342},\n\t{RT5514_ANA_CTRL_LDO10,\t\t0x00028604},\n\t{RT5514_ANA_CTRL_LDO18_16,\t0x02000345},\n\t{RT5514_ANA_CTRL_ADC12,\t\t0x0000a2a8},\n\t{RT5514_ANA_CTRL_ADC21,\t\t0x00001180},\n\t{RT5514_ANA_CTRL_ADC22,\t\t0x0000aaa8},\n\t{RT5514_ANA_CTRL_ADC23,\t\t0x00151427},\n\t{RT5514_ANA_CTRL_MICBST,\t0x00002000},\n\t{RT5514_ANA_CTRL_ADCFED,\t0x00000800},\n\t{RT5514_ANA_CTRL_INBUF,\t\t0x00000143},\n\t{RT5514_ANA_CTRL_VREF,\t\t0x00008d50},\n\t{RT5514_ANA_CTRL_PLL3,\t\t0x0000000e},\n\t{RT5514_ANA_CTRL_PLL1_1,\t0x00000000},\n\t{RT5514_ANA_CTRL_PLL1_2,\t0x00030220},\n\t{RT5514_DMIC_LP_CTRL,\t\t0x00000000},\n\t{RT5514_MISC_CTRL_DSP,\t\t0x00000000},\n\t{RT5514_DSP_CTRL1,\t\t0x00055149},\n\t{RT5514_DSP_CTRL3,\t\t0x00000006},\n\t{RT5514_DSP_CTRL4,\t\t0x00000001},\n\t{RT5514_VENDOR_ID1,\t\t0x00000001},\n\t{RT5514_VENDOR_ID2,\t\t0x10ec5514},\n};\n\nstatic void rt5514_enable_dsp_prepare(struct rt5514_priv *rt5514)\n{\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002000, 0x000010ec);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002200, 0x00028604);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0xfafafafa, 0x00000001);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002f00, 0x0005514b);\n\tregmap_write(rt5514->i2c_regmap, 0x18002f00, 0x00055149);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0xfafafafa, 0x00000000);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002070, 0x00000040);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002240, 0x0000000a);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002100, 0x0000000b);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002004, 0x00808b81);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18002f08, 0x00000005);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18001114, 0x00000001);\n\t \n\tregmap_write(rt5514->i2c_regmap, 0x18001118, 0x00000001);\n}\n\nstatic bool rt5514_volatile_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase RT5514_VENDOR_ID1:\n\tcase RT5514_VENDOR_ID2:\n\t\treturn true;\n\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool rt5514_readable_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase RT5514_RESET:\n\tcase RT5514_PWR_ANA1:\n\tcase RT5514_PWR_ANA2:\n\tcase RT5514_I2S_CTRL1:\n\tcase RT5514_I2S_CTRL2:\n\tcase RT5514_VAD_CTRL6:\n\tcase RT5514_EXT_VAD_CTRL:\n\tcase RT5514_DIG_IO_CTRL:\n\tcase RT5514_PAD_CTRL1:\n\tcase RT5514_DMIC_DATA_CTRL:\n\tcase RT5514_DIG_SOURCE_CTRL:\n\tcase RT5514_SRC_CTRL:\n\tcase RT5514_DOWNFILTER2_CTRL1:\n\tcase RT5514_PLL_SOURCE_CTRL:\n\tcase RT5514_CLK_CTRL1:\n\tcase RT5514_CLK_CTRL2:\n\tcase RT5514_PLL3_CALIB_CTRL1:\n\tcase RT5514_PLL3_CALIB_CTRL5:\n\tcase RT5514_DELAY_BUF_CTRL1:\n\tcase RT5514_DELAY_BUF_CTRL3:\n\tcase RT5514_ASRC_IN_CTRL1:\n\tcase RT5514_DOWNFILTER0_CTRL1:\n\tcase RT5514_DOWNFILTER0_CTRL2:\n\tcase RT5514_DOWNFILTER0_CTRL3:\n\tcase RT5514_DOWNFILTER1_CTRL1:\n\tcase RT5514_DOWNFILTER1_CTRL2:\n\tcase RT5514_DOWNFILTER1_CTRL3:\n\tcase RT5514_ANA_CTRL_LDO10:\n\tcase RT5514_ANA_CTRL_LDO18_16:\n\tcase RT5514_ANA_CTRL_ADC12:\n\tcase RT5514_ANA_CTRL_ADC21:\n\tcase RT5514_ANA_CTRL_ADC22:\n\tcase RT5514_ANA_CTRL_ADC23:\n\tcase RT5514_ANA_CTRL_MICBST:\n\tcase RT5514_ANA_CTRL_ADCFED:\n\tcase RT5514_ANA_CTRL_INBUF:\n\tcase RT5514_ANA_CTRL_VREF:\n\tcase RT5514_ANA_CTRL_PLL3:\n\tcase RT5514_ANA_CTRL_PLL1_1:\n\tcase RT5514_ANA_CTRL_PLL1_2:\n\tcase RT5514_DMIC_LP_CTRL:\n\tcase RT5514_MISC_CTRL_DSP:\n\tcase RT5514_DSP_CTRL1:\n\tcase RT5514_DSP_CTRL3:\n\tcase RT5514_DSP_CTRL4:\n\tcase RT5514_VENDOR_ID1:\n\tcase RT5514_VENDOR_ID2:\n\t\treturn true;\n\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool rt5514_i2c_readable_register(struct device *dev,\n\tunsigned int reg)\n{\n\tswitch (reg) {\n\tcase RT5514_DSP_MAPPING | RT5514_RESET:\n\tcase RT5514_DSP_MAPPING | RT5514_PWR_ANA1:\n\tcase RT5514_DSP_MAPPING | RT5514_PWR_ANA2:\n\tcase RT5514_DSP_MAPPING | RT5514_I2S_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_I2S_CTRL2:\n\tcase RT5514_DSP_MAPPING | RT5514_VAD_CTRL6:\n\tcase RT5514_DSP_MAPPING | RT5514_EXT_VAD_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_DIG_IO_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_PAD_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_DMIC_DATA_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_DIG_SOURCE_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_SRC_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER2_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_PLL_SOURCE_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_CLK_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_CLK_CTRL2:\n\tcase RT5514_DSP_MAPPING | RT5514_PLL3_CALIB_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_PLL3_CALIB_CTRL5:\n\tcase RT5514_DSP_MAPPING | RT5514_DELAY_BUF_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_DELAY_BUF_CTRL3:\n\tcase RT5514_DSP_MAPPING | RT5514_ASRC_IN_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER0_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER0_CTRL2:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER0_CTRL3:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER1_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER1_CTRL2:\n\tcase RT5514_DSP_MAPPING | RT5514_DOWNFILTER1_CTRL3:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_LDO10:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_LDO18_16:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_ADC12:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_ADC21:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_ADC22:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_ADC23:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_MICBST:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_ADCFED:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_INBUF:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_VREF:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_PLL3:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_PLL1_1:\n\tcase RT5514_DSP_MAPPING | RT5514_ANA_CTRL_PLL1_2:\n\tcase RT5514_DSP_MAPPING | RT5514_DMIC_LP_CTRL:\n\tcase RT5514_DSP_MAPPING | RT5514_MISC_CTRL_DSP:\n\tcase RT5514_DSP_MAPPING | RT5514_DSP_CTRL1:\n\tcase RT5514_DSP_MAPPING | RT5514_DSP_CTRL3:\n\tcase RT5514_DSP_MAPPING | RT5514_DSP_CTRL4:\n\tcase RT5514_DSP_MAPPING | RT5514_VENDOR_ID1:\n\tcase RT5514_DSP_MAPPING | RT5514_VENDOR_ID2:\n\t\treturn true;\n\n\tdefault:\n\t\treturn false;\n\t}\n}\n\n \nstatic const DECLARE_TLV_DB_RANGE(bst_tlv,\n\t0, 2, TLV_DB_SCALE_ITEM(-300, 300, 0),\n\t3, 3, TLV_DB_SCALE_ITEM(450, 0, 0),\n\t4, 4, TLV_DB_SCALE_ITEM(750, 0, 0),\n\t5, 5, TLV_DB_SCALE_ITEM(950, 0, 0),\n\t6, 6, TLV_DB_SCALE_ITEM(1200, 0, 0),\n\t7, 7, TLV_DB_SCALE_ITEM(1400, 0, 0),\n\t8, 8, TLV_DB_SCALE_ITEM(1700, 0, 0)\n);\n\nstatic const DECLARE_TLV_DB_SCALE(adc_vol_tlv, -1725, 75, 0);\n\nstatic int rt5514_dsp_voice_wake_up_get(struct snd_kcontrol *kcontrol,\n\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\n\tucontrol->value.integer.value[0] = rt5514->dsp_enabled;\n\n\treturn 0;\n}\n\nstatic int rt5514_calibration(struct rt5514_priv *rt5514, bool on)\n{\n\tif (on) {\n\t\tregmap_write(rt5514->regmap, RT5514_ANA_CTRL_PLL3, 0x0000000a);\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL_SOURCE_CTRL, 0xf,\n\t\t\t0xa);\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PWR_ANA1, 0x301,\n\t\t\t0x301);\n\t\tregmap_write(rt5514->regmap, RT5514_PLL3_CALIB_CTRL4,\n\t\t\t0x80000000 | rt5514->pll3_cal_value);\n\t\tregmap_write(rt5514->regmap, RT5514_PLL3_CALIB_CTRL1,\n\t\t\t0x8bb80800);\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL3_CALIB_CTRL5,\n\t\t\t0xc0000000, 0x80000000);\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL3_CALIB_CTRL5,\n\t\t\t0xc0000000, 0xc0000000);\n\t} else {\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL3_CALIB_CTRL5,\n\t\t\t0xc0000000, 0x40000000);\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PWR_ANA1, 0x301, 0);\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL_SOURCE_CTRL, 0xf,\n\t\t\t0x4);\n\t}\n\n\treturn 0;\n}\n\nstatic int rt5514_dsp_voice_wake_up_put(struct snd_kcontrol *kcontrol,\n\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tconst struct firmware *fw = NULL;\n\tu8 buf[8];\n\n\tif (ucontrol->value.integer.value[0] == rt5514->dsp_enabled)\n\t\treturn 0;\n\n\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF) {\n\t\trt5514->dsp_enabled = ucontrol->value.integer.value[0];\n\n\t\tif (rt5514->dsp_enabled) {\n\t\t\tif (rt5514->pdata.dsp_calib_clk_name &&\n\t\t\t\t!IS_ERR(rt5514->dsp_calib_clk)) {\n\t\t\t\tif (clk_set_rate(rt5514->dsp_calib_clk,\n\t\t\t\t\trt5514->pdata.dsp_calib_clk_rate))\n\t\t\t\t\tdev_err(component->dev,\n\t\t\t\t\t\t\"Can't set rate for mclk\");\n\n\t\t\t\tif (clk_prepare_enable(rt5514->dsp_calib_clk))\n\t\t\t\t\tdev_err(component->dev,\n\t\t\t\t\t\t\"Can't enable dsp_calib_clk\");\n\n\t\t\t\trt5514_calibration(rt5514, true);\n\n\t\t\t\tmsleep(20);\n#if IS_ENABLED(CONFIG_SND_SOC_RT5514_SPI)\n\t\t\t\trt5514_spi_burst_read(RT5514_PLL3_CALIB_CTRL6 |\n\t\t\t\t\tRT5514_DSP_MAPPING, buf, sizeof(buf));\n#else\n\t\t\t\tdev_err(component->dev, \"There is no SPI driver for\"\n\t\t\t\t\t\" loading the firmware\\n\");\n\t\t\t\tmemset(buf, 0, sizeof(buf));\n#endif\n\t\t\t\trt5514->pll3_cal_value = buf[0] | buf[1] << 8 |\n\t\t\t\t\tbuf[2] << 16 | buf[3] << 24;\n\n\t\t\t\trt5514_calibration(rt5514, false);\n\t\t\t\tclk_disable_unprepare(rt5514->dsp_calib_clk);\n\t\t\t}\n\n\t\t\trt5514_enable_dsp_prepare(rt5514);\n\n\t\t\trequest_firmware(&fw, RT5514_FIRMWARE1, component->dev);\n\t\t\tif (fw) {\n#if IS_ENABLED(CONFIG_SND_SOC_RT5514_SPI)\n\t\t\t\trt5514_spi_burst_write(0x4ff60000, fw->data,\n\t\t\t\t\t((fw->size/8)+1)*8);\n#else\n\t\t\t\tdev_err(component->dev, \"There is no SPI driver for\"\n\t\t\t\t\t\" loading the firmware\\n\");\n#endif\n\t\t\t\trelease_firmware(fw);\n\t\t\t\tfw = NULL;\n\t\t\t}\n\n\t\t\trequest_firmware(&fw, RT5514_FIRMWARE2, component->dev);\n\t\t\tif (fw) {\n#if IS_ENABLED(CONFIG_SND_SOC_RT5514_SPI)\n\t\t\t\trt5514_spi_burst_write(0x4ffc0000, fw->data,\n\t\t\t\t\t((fw->size/8)+1)*8);\n#else\n\t\t\t\tdev_err(component->dev, \"There is no SPI driver for\"\n\t\t\t\t\t\" loading the firmware\\n\");\n#endif\n\t\t\t\trelease_firmware(fw);\n\t\t\t\tfw = NULL;\n\t\t\t}\n\n\t\t\t \n\t\t\tregmap_write(rt5514->i2c_regmap, 0x18002f00,\n\t\t\t\t0x00055148);\n\n\t\t\tif (rt5514->pdata.dsp_calib_clk_name &&\n\t\t\t\t!IS_ERR(rt5514->dsp_calib_clk)) {\n\t\t\t\tmsleep(20);\n\n\t\t\t\tregmap_write(rt5514->i2c_regmap, 0x1800211c,\n\t\t\t\t\trt5514->pll3_cal_value);\n\t\t\t\tregmap_write(rt5514->i2c_regmap, 0x18002124,\n\t\t\t\t\t0x00220012);\n\t\t\t\tregmap_write(rt5514->i2c_regmap, 0x18002124,\n\t\t\t\t\t0x80220042);\n\t\t\t\tregmap_write(rt5514->i2c_regmap, 0x18002124,\n\t\t\t\t\t0xe0220042);\n\t\t\t}\n\t\t} else {\n\t\t\tregmap_multi_reg_write(rt5514->i2c_regmap,\n\t\t\t\trt5514_i2c_patch, ARRAY_SIZE(rt5514_i2c_patch));\n\t\t\tregcache_mark_dirty(rt5514->regmap);\n\t\t\tregcache_sync(rt5514->regmap);\n\t\t}\n\t}\n\n\treturn 1;\n}\n\nstatic const struct snd_kcontrol_new rt5514_snd_controls[] = {\n\tSOC_DOUBLE_TLV(\"MIC Boost Volume\", RT5514_ANA_CTRL_MICBST,\n\t\tRT5514_SEL_BSTL_SFT, RT5514_SEL_BSTR_SFT, 8, 0, bst_tlv),\n\tSOC_DOUBLE_R_TLV(\"ADC1 Capture Volume\", RT5514_DOWNFILTER0_CTRL1,\n\t\tRT5514_DOWNFILTER0_CTRL2, RT5514_AD_GAIN_SFT, 63, 0,\n\t\tadc_vol_tlv),\n\tSOC_DOUBLE_R_TLV(\"ADC2 Capture Volume\", RT5514_DOWNFILTER1_CTRL1,\n\t\tRT5514_DOWNFILTER1_CTRL2, RT5514_AD_GAIN_SFT, 63, 0,\n\t\tadc_vol_tlv),\n\tSOC_SINGLE_EXT(\"DSP Voice Wake Up\", SND_SOC_NOPM, 0, 1, 0,\n\t\trt5514_dsp_voice_wake_up_get, rt5514_dsp_voice_wake_up_put),\n};\n\n \nstatic const struct snd_kcontrol_new rt5514_sto1_adc_l_mix[] = {\n\tSOC_DAPM_SINGLE(\"DMIC Switch\", RT5514_DOWNFILTER0_CTRL1,\n\t\tRT5514_AD_DMIC_MIX_BIT, 1, 1),\n\tSOC_DAPM_SINGLE(\"ADC Switch\", RT5514_DOWNFILTER0_CTRL1,\n\t\tRT5514_AD_AD_MIX_BIT, 1, 1),\n};\n\nstatic const struct snd_kcontrol_new rt5514_sto1_adc_r_mix[] = {\n\tSOC_DAPM_SINGLE(\"DMIC Switch\", RT5514_DOWNFILTER0_CTRL2,\n\t\tRT5514_AD_DMIC_MIX_BIT, 1, 1),\n\tSOC_DAPM_SINGLE(\"ADC Switch\", RT5514_DOWNFILTER0_CTRL2,\n\t\tRT5514_AD_AD_MIX_BIT, 1, 1),\n};\n\nstatic const struct snd_kcontrol_new rt5514_sto2_adc_l_mix[] = {\n\tSOC_DAPM_SINGLE(\"DMIC Switch\", RT5514_DOWNFILTER1_CTRL1,\n\t\tRT5514_AD_DMIC_MIX_BIT, 1, 1),\n\tSOC_DAPM_SINGLE(\"ADC Switch\", RT5514_DOWNFILTER1_CTRL1,\n\t\tRT5514_AD_AD_MIX_BIT, 1, 1),\n};\n\nstatic const struct snd_kcontrol_new rt5514_sto2_adc_r_mix[] = {\n\tSOC_DAPM_SINGLE(\"DMIC Switch\", RT5514_DOWNFILTER1_CTRL2,\n\t\tRT5514_AD_DMIC_MIX_BIT, 1, 1),\n\tSOC_DAPM_SINGLE(\"ADC Switch\", RT5514_DOWNFILTER1_CTRL2,\n\t\tRT5514_AD_AD_MIX_BIT, 1, 1),\n};\n\n \nstatic const char * const rt5514_dmic_src[] = {\n\t\"DMIC1\", \"DMIC2\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(\n\trt5514_stereo1_dmic_enum, RT5514_DIG_SOURCE_CTRL,\n\tRT5514_AD0_DMIC_INPUT_SEL_SFT, rt5514_dmic_src);\n\nstatic const struct snd_kcontrol_new rt5514_sto1_dmic_mux =\n\tSOC_DAPM_ENUM(\"Stereo1 DMIC Source\", rt5514_stereo1_dmic_enum);\n\nstatic SOC_ENUM_SINGLE_DECL(\n\trt5514_stereo2_dmic_enum, RT5514_DIG_SOURCE_CTRL,\n\tRT5514_AD1_DMIC_INPUT_SEL_SFT, rt5514_dmic_src);\n\nstatic const struct snd_kcontrol_new rt5514_sto2_dmic_mux =\n\tSOC_DAPM_ENUM(\"Stereo2 DMIC Source\", rt5514_stereo2_dmic_enum);\n\n \nstatic int rt5514_calc_dmic_clk(struct snd_soc_component *component, int rate)\n{\n\tstatic const int div[] = {2, 3, 4, 8, 12, 16, 24, 32};\n\tint i;\n\n\tif (rate < 1000000 * div[0]) {\n\t\tpr_warn(\"Base clock rate %d is too low\\n\", rate);\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(div); i++) {\n\t\t \n\t\tif (3072000 * div[i] >= rate)\n\t\t\treturn i;\n\t}\n\n\tdev_warn(component->dev, \"Base clock rate %d is too high\\n\", rate);\n\treturn -EINVAL;\n}\n\nstatic int rt5514_set_dmic_clk(struct snd_soc_dapm_widget *w,\n\tstruct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tint idx;\n\n\tidx = rt5514_calc_dmic_clk(component, rt5514->sysclk);\n\tif (idx < 0)\n\t\tdev_err(component->dev, \"Failed to set DMIC clock\\n\");\n\telse\n\t\tregmap_update_bits(rt5514->regmap, RT5514_CLK_CTRL1,\n\t\t\tRT5514_CLK_DMIC_OUT_SEL_MASK,\n\t\t\tidx << RT5514_CLK_DMIC_OUT_SEL_SFT);\n\n\tif (rt5514->pdata.dmic_init_delay)\n\t\tmsleep(rt5514->pdata.dmic_init_delay);\n\n\treturn idx;\n}\n\nstatic int rt5514_is_sys_clk_from_pll(struct snd_soc_dapm_widget *source,\n\t\t\t struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(source->dapm);\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\n\tif (rt5514->sysclk_src == RT5514_SCLK_S_PLL1)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nstatic int rt5514_i2s_use_asrc(struct snd_soc_dapm_widget *source,\n\tstruct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(source->dapm);\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\n\treturn (rt5514->sysclk > rt5514->lrck * 384);\n}\n\nstatic const struct snd_soc_dapm_widget rt5514_dapm_widgets[] = {\n\t \n\tSND_SOC_DAPM_INPUT(\"DMIC1L\"),\n\tSND_SOC_DAPM_INPUT(\"DMIC1R\"),\n\tSND_SOC_DAPM_INPUT(\"DMIC2L\"),\n\tSND_SOC_DAPM_INPUT(\"DMIC2R\"),\n\n\tSND_SOC_DAPM_INPUT(\"AMICL\"),\n\tSND_SOC_DAPM_INPUT(\"AMICR\"),\n\n\tSND_SOC_DAPM_PGA(\"DMIC1\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"DMIC2\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"DMIC CLK\", 1, SND_SOC_NOPM, 0, 0,\n\t\trt5514_set_dmic_clk, SND_SOC_DAPM_PRE_PMU),\n\n\tSND_SOC_DAPM_SUPPLY(\"ADC CLK\", RT5514_CLK_CTRL1,\n\t\tRT5514_CLK_AD_ANA1_EN_BIT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"LDO18 IN\", RT5514_PWR_ANA1,\n\t\tRT5514_POW_LDO18_IN_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"LDO18 ADC\", RT5514_PWR_ANA1,\n\t\tRT5514_POW_LDO18_ADC_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"LDO21\", RT5514_PWR_ANA1, RT5514_POW_LDO21_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BG LDO18 IN\", RT5514_PWR_ANA1,\n\t\tRT5514_POW_BG_LDO18_IN_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BG LDO21\", RT5514_PWR_ANA1,\n\t\tRT5514_POW_BG_LDO21_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BG MBIAS\", RT5514_PWR_ANA2,\n\t\tRT5514_POW_BG_MBIAS_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"MBIAS\", RT5514_PWR_ANA2, RT5514_POW_MBIAS_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"VREF2\", RT5514_PWR_ANA2, RT5514_POW_VREF2_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"VREF1\", RT5514_PWR_ANA2, RT5514_POW_VREF1_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADC Power\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\n\tSND_SOC_DAPM_SUPPLY(\"LDO16L\", RT5514_PWR_ANA2, RT5514_POWL_LDO16_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADC1L\", RT5514_PWR_ANA2, RT5514_POW_ADC1_L_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BSTL2\", RT5514_PWR_ANA2, RT5514_POW2_BSTL_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BSTL\", RT5514_PWR_ANA2, RT5514_POW_BSTL_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADCFEDL\", RT5514_PWR_ANA2, RT5514_POW_ADCFEDL_BIT,\n\t\t0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADCL Power\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"LDO16R\", RT5514_PWR_ANA2, RT5514_POWR_LDO16_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADC1R\", RT5514_PWR_ANA2, RT5514_POW_ADC1_R_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BSTR2\", RT5514_PWR_ANA2, RT5514_POW2_BSTR_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"BSTR\", RT5514_PWR_ANA2, RT5514_POW_BSTR_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADCFEDR\", RT5514_PWR_ANA2, RT5514_POW_ADCFEDR_BIT,\n\t\t0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADCR Power\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"PLL1 LDO ENABLE\", RT5514_ANA_CTRL_PLL1_2,\n\t\tRT5514_EN_LDO_PLL1_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"PLL1 LDO\", RT5514_PWR_ANA2,\n\t\tRT5514_POW_PLL1_LDO_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"PLL1\", RT5514_PWR_ANA2, RT5514_POW_PLL1_BIT, 0,\n\t\tNULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"ASRC AD1\", 1, RT5514_CLK_CTRL2,\n\t\tRT5514_CLK_AD0_ASRC_EN_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"ASRC AD2\", 1, RT5514_CLK_CTRL2,\n\t\tRT5514_CLK_AD1_ASRC_EN_BIT, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_MUX(\"Stereo1 DMIC Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t\t&rt5514_sto1_dmic_mux),\n\tSND_SOC_DAPM_MUX(\"Stereo2 DMIC Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t\t&rt5514_sto2_dmic_mux),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"adc stereo1 filter\", RT5514_CLK_CTRL1,\n\t\tRT5514_CLK_AD0_EN_BIT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"adc stereo2 filter\", RT5514_CLK_CTRL1,\n\t\tRT5514_CLK_AD1_EN_BIT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MIXER(\"Sto1 ADC MIXL\", SND_SOC_NOPM, 0, 0,\n\t\trt5514_sto1_adc_l_mix, ARRAY_SIZE(rt5514_sto1_adc_l_mix)),\n\tSND_SOC_DAPM_MIXER(\"Sto1 ADC MIXR\", SND_SOC_NOPM, 0, 0,\n\t\trt5514_sto1_adc_r_mix, ARRAY_SIZE(rt5514_sto1_adc_r_mix)),\n\tSND_SOC_DAPM_MIXER(\"Sto2 ADC MIXL\", SND_SOC_NOPM, 0, 0,\n\t\trt5514_sto2_adc_l_mix, ARRAY_SIZE(rt5514_sto2_adc_l_mix)),\n\tSND_SOC_DAPM_MIXER(\"Sto2 ADC MIXR\", SND_SOC_NOPM, 0, 0,\n\t\trt5514_sto2_adc_r_mix, ARRAY_SIZE(rt5514_sto2_adc_r_mix)),\n\n\tSND_SOC_DAPM_ADC(\"Stereo1 ADC MIXL\", NULL, RT5514_DOWNFILTER0_CTRL1,\n\t\tRT5514_AD_AD_MUTE_BIT, 1),\n\tSND_SOC_DAPM_ADC(\"Stereo1 ADC MIXR\", NULL, RT5514_DOWNFILTER0_CTRL2,\n\t\tRT5514_AD_AD_MUTE_BIT, 1),\n\tSND_SOC_DAPM_ADC(\"Stereo2 ADC MIXL\", NULL, RT5514_DOWNFILTER1_CTRL1,\n\t\tRT5514_AD_AD_MUTE_BIT, 1),\n\tSND_SOC_DAPM_ADC(\"Stereo2 ADC MIXR\", NULL, RT5514_DOWNFILTER1_CTRL2,\n\t\tRT5514_AD_AD_MUTE_BIT, 1),\n\n\t \n\tSND_SOC_DAPM_PGA(\"Stereo1 ADC MIX\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Stereo2 ADC MIX\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_AIF_OUT(\"AIF1TX\", \"AIF1 Capture\", 0, SND_SOC_NOPM, 0, 0),\n};\n\nstatic const struct snd_soc_dapm_route rt5514_dapm_routes[] = {\n\t{ \"DMIC1\", NULL, \"DMIC1L\" },\n\t{ \"DMIC1\", NULL, \"DMIC1R\" },\n\t{ \"DMIC2\", NULL, \"DMIC2L\" },\n\t{ \"DMIC2\", NULL, \"DMIC2R\" },\n\n\t{ \"DMIC1L\", NULL, \"DMIC CLK\" },\n\t{ \"DMIC1R\", NULL, \"DMIC CLK\" },\n\t{ \"DMIC2L\", NULL, \"DMIC CLK\" },\n\t{ \"DMIC2R\", NULL, \"DMIC CLK\" },\n\n\t{ \"Stereo1 DMIC Mux\", \"DMIC1\", \"DMIC1\" },\n\t{ \"Stereo1 DMIC Mux\", \"DMIC2\", \"DMIC2\" },\n\n\t{ \"Sto1 ADC MIXL\", \"DMIC Switch\", \"Stereo1 DMIC Mux\" },\n\t{ \"Sto1 ADC MIXL\", \"ADC Switch\", \"AMICL\" },\n\t{ \"Sto1 ADC MIXR\", \"DMIC Switch\", \"Stereo1 DMIC Mux\" },\n\t{ \"Sto1 ADC MIXR\", \"ADC Switch\", \"AMICR\" },\n\n\t{ \"ADC Power\", NULL, \"LDO18 IN\" },\n\t{ \"ADC Power\", NULL, \"LDO18 ADC\" },\n\t{ \"ADC Power\", NULL, \"LDO21\" },\n\t{ \"ADC Power\", NULL, \"BG LDO18 IN\" },\n\t{ \"ADC Power\", NULL, \"BG LDO21\" },\n\t{ \"ADC Power\", NULL, \"BG MBIAS\" },\n\t{ \"ADC Power\", NULL, \"MBIAS\" },\n\t{ \"ADC Power\", NULL, \"VREF2\" },\n\t{ \"ADC Power\", NULL, \"VREF1\" },\n\n\t{ \"ADCL Power\", NULL, \"LDO16L\" },\n\t{ \"ADCL Power\", NULL, \"ADC1L\" },\n\t{ \"ADCL Power\", NULL, \"BSTL2\" },\n\t{ \"ADCL Power\", NULL, \"BSTL\" },\n\t{ \"ADCL Power\", NULL, \"ADCFEDL\" },\n\n\t{ \"ADCR Power\", NULL, \"LDO16R\" },\n\t{ \"ADCR Power\", NULL, \"ADC1R\" },\n\t{ \"ADCR Power\", NULL, \"BSTR2\" },\n\t{ \"ADCR Power\", NULL, \"BSTR\" },\n\t{ \"ADCR Power\", NULL, \"ADCFEDR\" },\n\n\t{ \"AMICL\", NULL, \"ADC CLK\" },\n\t{ \"AMICL\", NULL, \"ADC Power\" },\n\t{ \"AMICL\", NULL, \"ADCL Power\" },\n\t{ \"AMICR\", NULL, \"ADC CLK\" },\n\t{ \"AMICR\", NULL, \"ADC Power\" },\n\t{ \"AMICR\", NULL, \"ADCR Power\" },\n\n\t{ \"PLL1 LDO\", NULL, \"PLL1 LDO ENABLE\" },\n\t{ \"PLL1\", NULL, \"PLL1 LDO\" },\n\n\t{ \"Stereo1 ADC MIXL\", NULL, \"Sto1 ADC MIXL\" },\n\t{ \"Stereo1 ADC MIXR\", NULL, \"Sto1 ADC MIXR\" },\n\n\t{ \"Stereo1 ADC MIX\", NULL, \"Stereo1 ADC MIXL\" },\n\t{ \"Stereo1 ADC MIX\", NULL, \"Stereo1 ADC MIXR\" },\n\t{ \"Stereo1 ADC MIX\", NULL, \"adc stereo1 filter\" },\n\t{ \"adc stereo1 filter\", NULL, \"PLL1\", rt5514_is_sys_clk_from_pll },\n\t{ \"adc stereo1 filter\", NULL, \"ASRC AD1\", rt5514_i2s_use_asrc },\n\n\t{ \"Stereo2 DMIC Mux\", \"DMIC1\", \"DMIC1\" },\n\t{ \"Stereo2 DMIC Mux\", \"DMIC2\", \"DMIC2\" },\n\n\t{ \"Sto2 ADC MIXL\", \"DMIC Switch\", \"Stereo2 DMIC Mux\" },\n\t{ \"Sto2 ADC MIXL\", \"ADC Switch\", \"AMICL\" },\n\t{ \"Sto2 ADC MIXR\", \"DMIC Switch\", \"Stereo2 DMIC Mux\" },\n\t{ \"Sto2 ADC MIXR\", \"ADC Switch\", \"AMICR\" },\n\n\t{ \"Stereo2 ADC MIXL\", NULL, \"Sto2 ADC MIXL\" },\n\t{ \"Stereo2 ADC MIXR\", NULL, \"Sto2 ADC MIXR\" },\n\n\t{ \"Stereo2 ADC MIX\", NULL, \"Stereo2 ADC MIXL\" },\n\t{ \"Stereo2 ADC MIX\", NULL, \"Stereo2 ADC MIXR\" },\n\t{ \"Stereo2 ADC MIX\", NULL, \"adc stereo2 filter\" },\n\t{ \"adc stereo2 filter\", NULL, \"PLL1\", rt5514_is_sys_clk_from_pll },\n\t{ \"adc stereo2 filter\", NULL, \"ASRC AD2\", rt5514_i2s_use_asrc },\n\n\t{ \"AIF1TX\", NULL, \"Stereo1 ADC MIX\"},\n\t{ \"AIF1TX\", NULL, \"Stereo2 ADC MIX\"},\n};\n\nstatic int rt5514_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tint pre_div, bclk_ms, frame_size;\n\tunsigned int val_len = 0;\n\n\trt5514->lrck = params_rate(params);\n\tpre_div = rl6231_get_clk_info(rt5514->sysclk, rt5514->lrck);\n\tif (pre_div < 0) {\n\t\tdev_err(component->dev, \"Unsupported clock setting\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tframe_size = snd_soc_params_to_frame_size(params);\n\tif (frame_size < 0) {\n\t\tdev_err(component->dev, \"Unsupported frame size: %d\\n\", frame_size);\n\t\treturn -EINVAL;\n\t}\n\n\tbclk_ms = frame_size > 32;\n\trt5514->bclk = rt5514->lrck * (32 << bclk_ms);\n\n\tdev_dbg(dai->dev, \"bclk is %dHz and lrck is %dHz\\n\",\n\t\trt5514->bclk, rt5514->lrck);\n\tdev_dbg(dai->dev, \"bclk_ms is %d and pre_div is %d for iis %d\\n\",\n\t\t\t\tbclk_ms, pre_div, dai->id);\n\n\tswitch (params_format(params)) {\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S20_3LE:\n\t\tval_len = RT5514_I2S_DL_20;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S24_LE:\n\t\tval_len = RT5514_I2S_DL_24;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S8:\n\t\tval_len = RT5514_I2S_DL_8;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(rt5514->regmap, RT5514_I2S_CTRL1, RT5514_I2S_DL_MASK,\n\t\tval_len);\n\tregmap_update_bits(rt5514->regmap, RT5514_CLK_CTRL1,\n\t\tRT5514_CLK_AD_ANA1_SEL_MASK,\n\t\t(pre_div + 1) << RT5514_CLK_AD_ANA1_SEL_SFT);\n\tregmap_update_bits(rt5514->regmap, RT5514_CLK_CTRL2,\n\t\tRT5514_CLK_SYS_DIV_OUT_MASK | RT5514_SEL_ADC_OSR_MASK,\n\t\tpre_div << RT5514_CLK_SYS_DIV_OUT_SFT |\n\t\tpre_div << RT5514_SEL_ADC_OSR_SFT);\n\n\treturn 0;\n}\n\nstatic int rt5514_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tunsigned int reg_val = 0;\n\n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\treg_val |= RT5514_I2S_LR_INV;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\treg_val |= RT5514_I2S_BP_INV;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\treg_val |= RT5514_I2S_BP_INV | RT5514_I2S_LR_INV;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\treg_val |= RT5514_I2S_DF_LEFT;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\treg_val |= RT5514_I2S_DF_PCM_A;\n\t\tbreak;\n\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\treg_val |= RT5514_I2S_DF_PCM_B;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(rt5514->regmap, RT5514_I2S_CTRL1,\n\t\tRT5514_I2S_DF_MASK | RT5514_I2S_BP_MASK | RT5514_I2S_LR_MASK,\n\t\treg_val);\n\n\treturn 0;\n}\n\nstatic int rt5514_set_dai_sysclk(struct snd_soc_dai *dai,\n\t\tint clk_id, unsigned int freq, int dir)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tunsigned int reg_val = 0;\n\n\tif (freq == rt5514->sysclk && clk_id == rt5514->sysclk_src)\n\t\treturn 0;\n\n\tswitch (clk_id) {\n\tcase RT5514_SCLK_S_MCLK:\n\t\treg_val |= RT5514_CLK_SYS_PRE_SEL_MCLK;\n\t\tbreak;\n\n\tcase RT5514_SCLK_S_PLL1:\n\t\treg_val |= RT5514_CLK_SYS_PRE_SEL_PLL;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(component->dev, \"Invalid clock id (%d)\\n\", clk_id);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(rt5514->regmap, RT5514_CLK_CTRL2,\n\t\tRT5514_CLK_SYS_PRE_SEL_MASK, reg_val);\n\n\trt5514->sysclk = freq;\n\trt5514->sysclk_src = clk_id;\n\n\tdev_dbg(dai->dev, \"Sysclk is %dHz and clock id is %d\\n\", freq, clk_id);\n\n\treturn 0;\n}\n\nstatic int rt5514_set_dai_pll(struct snd_soc_dai *dai, int pll_id, int source,\n\t\t\tunsigned int freq_in, unsigned int freq_out)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tstruct rl6231_pll_code pll_code;\n\tint ret;\n\n\tif (!freq_in || !freq_out) {\n\t\tdev_dbg(component->dev, \"PLL disabled\\n\");\n\n\t\trt5514->pll_in = 0;\n\t\trt5514->pll_out = 0;\n\t\tregmap_update_bits(rt5514->regmap, RT5514_CLK_CTRL2,\n\t\t\tRT5514_CLK_SYS_PRE_SEL_MASK,\n\t\t\tRT5514_CLK_SYS_PRE_SEL_MCLK);\n\n\t\treturn 0;\n\t}\n\n\tif (source == rt5514->pll_src && freq_in == rt5514->pll_in &&\n\t    freq_out == rt5514->pll_out)\n\t\treturn 0;\n\n\tswitch (source) {\n\tcase RT5514_PLL1_S_MCLK:\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL_SOURCE_CTRL,\n\t\t\tRT5514_PLL_1_SEL_MASK, RT5514_PLL_1_SEL_MCLK);\n\t\tbreak;\n\n\tcase RT5514_PLL1_S_BCLK:\n\t\tregmap_update_bits(rt5514->regmap, RT5514_PLL_SOURCE_CTRL,\n\t\t\tRT5514_PLL_1_SEL_MASK, RT5514_PLL_1_SEL_SCLK);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(component->dev, \"Unknown PLL source %d\\n\", source);\n\t\treturn -EINVAL;\n\t}\n\n\tret = rl6231_pll_calc(freq_in, freq_out, &pll_code);\n\tif (ret < 0) {\n\t\tdev_err(component->dev, \"Unsupported input clock %d\\n\", freq_in);\n\t\treturn ret;\n\t}\n\n\tdev_dbg(component->dev, \"bypass=%d m=%d n=%d k=%d\\n\",\n\t\tpll_code.m_bp, (pll_code.m_bp ? 0 : pll_code.m_code),\n\t\tpll_code.n_code, pll_code.k_code);\n\n\tregmap_write(rt5514->regmap, RT5514_ANA_CTRL_PLL1_1,\n\t\tpll_code.k_code << RT5514_PLL_K_SFT |\n\t\tpll_code.n_code << RT5514_PLL_N_SFT |\n\t\t(pll_code.m_bp ? 0 : pll_code.m_code) << RT5514_PLL_M_SFT);\n\tregmap_update_bits(rt5514->regmap, RT5514_ANA_CTRL_PLL1_2,\n\t\tRT5514_PLL_M_BP, pll_code.m_bp << RT5514_PLL_M_BP_SFT);\n\n\trt5514->pll_in = freq_in;\n\trt5514->pll_out = freq_out;\n\trt5514->pll_src = source;\n\n\treturn 0;\n}\n\nstatic int rt5514_set_tdm_slot(struct snd_soc_dai *dai, unsigned int tx_mask,\n\t\t\tunsigned int rx_mask, int slots, int slot_width)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tunsigned int val = 0, val2 = 0;\n\n\tif (rx_mask || tx_mask)\n\t\tval |= RT5514_TDM_MODE;\n\n\tswitch (tx_mask) {\n\tcase 0x3:\n\t\tval2 |= RT5514_TDM_DOCKING_MODE | RT5514_TDM_DOCKING_VALID_CH2 |\n\t\t\tRT5514_TDM_DOCKING_START_SLOT0;\n\t\tbreak;\n\n\tcase 0x30:\n\t\tval2 |= RT5514_TDM_DOCKING_MODE | RT5514_TDM_DOCKING_VALID_CH2 |\n\t\t\tRT5514_TDM_DOCKING_START_SLOT4;\n\t\tbreak;\n\n\tcase 0xf:\n\t\tval2 |= RT5514_TDM_DOCKING_MODE | RT5514_TDM_DOCKING_VALID_CH4 |\n\t\t\tRT5514_TDM_DOCKING_START_SLOT0;\n\t\tbreak;\n\n\tcase 0xf0:\n\t\tval2 |= RT5514_TDM_DOCKING_MODE | RT5514_TDM_DOCKING_VALID_CH4 |\n\t\t\tRT5514_TDM_DOCKING_START_SLOT4;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\n\n\tswitch (slots) {\n\tcase 4:\n\t\tval |= RT5514_TDMSLOT_SEL_RX_4CH | RT5514_TDMSLOT_SEL_TX_4CH;\n\t\tbreak;\n\n\tcase 6:\n\t\tval |= RT5514_TDMSLOT_SEL_RX_6CH | RT5514_TDMSLOT_SEL_TX_6CH;\n\t\tbreak;\n\n\tcase 8:\n\t\tval |= RT5514_TDMSLOT_SEL_RX_8CH | RT5514_TDMSLOT_SEL_TX_8CH;\n\t\tbreak;\n\n\tcase 2:\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (slot_width) {\n\tcase 20:\n\t\tval |= RT5514_CH_LEN_RX_20 | RT5514_CH_LEN_TX_20;\n\t\tbreak;\n\n\tcase 24:\n\t\tval |= RT5514_CH_LEN_RX_24 | RT5514_CH_LEN_TX_24;\n\t\tbreak;\n\n\tcase 25:\n\t\tval |= RT5514_TDM_MODE2;\n\t\tbreak;\n\n\tcase 32:\n\t\tval |= RT5514_CH_LEN_RX_32 | RT5514_CH_LEN_TX_32;\n\t\tbreak;\n\n\tcase 16:\n\tdefault:\n\t\tbreak;\n\t}\n\n\tregmap_update_bits(rt5514->regmap, RT5514_I2S_CTRL1, RT5514_TDM_MODE |\n\t\tRT5514_TDMSLOT_SEL_RX_MASK | RT5514_TDMSLOT_SEL_TX_MASK |\n\t\tRT5514_CH_LEN_RX_MASK | RT5514_CH_LEN_TX_MASK |\n\t\tRT5514_TDM_MODE2, val);\n\n\tregmap_update_bits(rt5514->regmap, RT5514_I2S_CTRL2,\n\t\tRT5514_TDM_DOCKING_MODE | RT5514_TDM_DOCKING_VALID_CH_MASK |\n\t\tRT5514_TDM_DOCKING_START_MASK, val2);\n\n\treturn 0;\n}\n\nstatic int rt5514_set_bias_level(struct snd_soc_component *component,\n\t\t\tenum snd_soc_bias_level level)\n{\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_PREPARE:\n\t\tif (IS_ERR(rt5514->mclk))\n\t\t\tbreak;\n\n\t\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_ON) {\n\t\t\tclk_disable_unprepare(rt5514->mclk);\n\t\t} else {\n\t\t\tret = clk_prepare_enable(rt5514->mclk);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\n\tcase SND_SOC_BIAS_STANDBY:\n\t\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF) {\n\t\t\t \n\t\t\tif (rt5514->dsp_enabled) {\n\t\t\t\trt5514->dsp_enabled = 0;\n\t\t\t\tregmap_multi_reg_write(rt5514->i2c_regmap,\n\t\t\t\t\trt5514_i2c_patch,\n\t\t\t\t\tARRAY_SIZE(rt5514_i2c_patch));\n\t\t\t\tregcache_mark_dirty(rt5514->regmap);\n\t\t\t\tregcache_sync(rt5514->regmap);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int rt5514_probe(struct snd_soc_component *component)\n{\n\tstruct rt5514_priv *rt5514 = snd_soc_component_get_drvdata(component);\n\tstruct platform_device *pdev = container_of(component->dev,\n\t\t\t\t\t\t   struct platform_device, dev);\n\n\trt5514->mclk = devm_clk_get(component->dev, \"mclk\");\n\tif (PTR_ERR(rt5514->mclk) == -EPROBE_DEFER)\n\t\treturn -EPROBE_DEFER;\n\n\tif (rt5514->pdata.dsp_calib_clk_name) {\n\t\trt5514->dsp_calib_clk = devm_clk_get(&pdev->dev,\n\t\t\t\trt5514->pdata.dsp_calib_clk_name);\n\t\tif (PTR_ERR(rt5514->dsp_calib_clk) == -EPROBE_DEFER)\n\t\t\treturn -EPROBE_DEFER;\n\t}\n\n\trt5514->component = component;\n\trt5514->pll3_cal_value = 0x0078b000;\n\n\treturn 0;\n}\n\nstatic int rt5514_i2c_read(void *context, unsigned int reg, unsigned int *val)\n{\n\tstruct i2c_client *client = context;\n\tstruct rt5514_priv *rt5514 = i2c_get_clientdata(client);\n\n\tregmap_read(rt5514->i2c_regmap, reg | RT5514_DSP_MAPPING, val);\n\n\treturn 0;\n}\n\nstatic int rt5514_i2c_write(void *context, unsigned int reg, unsigned int val)\n{\n\tstruct i2c_client *client = context;\n\tstruct rt5514_priv *rt5514 = i2c_get_clientdata(client);\n\n\tregmap_write(rt5514->i2c_regmap, reg | RT5514_DSP_MAPPING, val);\n\n\treturn 0;\n}\n\n#define RT5514_STEREO_RATES SNDRV_PCM_RATE_8000_192000\n#define RT5514_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S20_3LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_S8)\n\nstatic const struct snd_soc_dai_ops rt5514_aif_dai_ops = {\n\t.hw_params = rt5514_hw_params,\n\t.set_fmt = rt5514_set_dai_fmt,\n\t.set_sysclk = rt5514_set_dai_sysclk,\n\t.set_pll = rt5514_set_dai_pll,\n\t.set_tdm_slot = rt5514_set_tdm_slot,\n};\n\nstatic struct snd_soc_dai_driver rt5514_dai[] = {\n\t{\n\t\t.name = \"rt5514-aif1\",\n\t\t.id = 0,\n\t\t.capture = {\n\t\t\t.stream_name = \"AIF1 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 4,\n\t\t\t.rates = RT5514_STEREO_RATES,\n\t\t\t.formats = RT5514_FORMATS,\n\t\t},\n\t\t.ops = &rt5514_aif_dai_ops,\n\t}\n};\n\nstatic const struct snd_soc_component_driver soc_component_dev_rt5514 = {\n\t.probe\t\t\t= rt5514_probe,\n\t.set_bias_level\t\t= rt5514_set_bias_level,\n\t.controls\t\t= rt5514_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(rt5514_snd_controls),\n\t.dapm_widgets\t\t= rt5514_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(rt5514_dapm_widgets),\n\t.dapm_routes\t\t= rt5514_dapm_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(rt5514_dapm_routes),\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic const struct regmap_config rt5514_i2c_regmap = {\n\t.name = \"i2c\",\n\t.reg_bits = 32,\n\t.val_bits = 32,\n\n\t.readable_reg = rt5514_i2c_readable_register,\n\n\t.cache_type = REGCACHE_NONE,\n};\n\nstatic const struct regmap_config rt5514_regmap = {\n\t.reg_bits = 16,\n\t.val_bits = 32,\n\n\t.max_register = RT5514_VENDOR_ID2,\n\t.volatile_reg = rt5514_volatile_register,\n\t.readable_reg = rt5514_readable_register,\n\t.reg_read = rt5514_i2c_read,\n\t.reg_write = rt5514_i2c_write,\n\n\t.cache_type = REGCACHE_MAPLE,\n\t.reg_defaults = rt5514_reg,\n\t.num_reg_defaults = ARRAY_SIZE(rt5514_reg),\n\t.use_single_read = true,\n\t.use_single_write = true,\n};\n\nstatic const struct i2c_device_id rt5514_i2c_id[] = {\n\t{ \"rt5514\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, rt5514_i2c_id);\n\n#if defined(CONFIG_OF)\nstatic const struct of_device_id rt5514_of_match[] = {\n\t{ .compatible = \"realtek,rt5514\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, rt5514_of_match);\n#endif\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id rt5514_acpi_match[] = {\n\t{ \"10EC5514\", 0},\n\t{},\n};\nMODULE_DEVICE_TABLE(acpi, rt5514_acpi_match);\n#endif\n\nstatic int rt5514_parse_dp(struct rt5514_priv *rt5514, struct device *dev)\n{\n\tdevice_property_read_u32(dev, \"realtek,dmic-init-delay-ms\",\n\t\t&rt5514->pdata.dmic_init_delay);\n\tdevice_property_read_string(dev, \"realtek,dsp-calib-clk-name\",\n\t\t&rt5514->pdata.dsp_calib_clk_name);\n\tdevice_property_read_u32(dev, \"realtek,dsp-calib-clk-rate\",\n\t\t&rt5514->pdata.dsp_calib_clk_rate);\n\n\treturn 0;\n}\n\nstatic __maybe_unused int rt5514_i2c_resume(struct device *dev)\n{\n\tstruct rt5514_priv *rt5514 = dev_get_drvdata(dev);\n\tunsigned int val;\n\n\t \n\tregmap_read(rt5514->regmap, RT5514_VENDOR_ID2, &val);\n\n\treturn 0;\n}\n\nstatic int rt5514_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct rt5514_platform_data *pdata = dev_get_platdata(&i2c->dev);\n\tstruct rt5514_priv *rt5514;\n\tint ret;\n\tunsigned int val = ~0;\n\n\trt5514 = devm_kzalloc(&i2c->dev, sizeof(struct rt5514_priv),\n\t\t\t\tGFP_KERNEL);\n\tif (rt5514 == NULL)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(i2c, rt5514);\n\n\tif (pdata)\n\t\trt5514->pdata = *pdata;\n\telse\n\t\trt5514_parse_dp(rt5514, &i2c->dev);\n\n\trt5514->i2c_regmap = devm_regmap_init_i2c(i2c, &rt5514_i2c_regmap);\n\tif (IS_ERR(rt5514->i2c_regmap)) {\n\t\tret = PTR_ERR(rt5514->i2c_regmap);\n\t\tdev_err(&i2c->dev, \"Failed to allocate register map: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\trt5514->regmap = devm_regmap_init(&i2c->dev, NULL, i2c, &rt5514_regmap);\n\tif (IS_ERR(rt5514->regmap)) {\n\t\tret = PTR_ERR(rt5514->regmap);\n\t\tdev_err(&i2c->dev, \"Failed to allocate register map: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_read(rt5514->regmap, RT5514_VENDOR_ID2, &val);\n\tif (ret || val != RT5514_DEVICE_ID)\n\t\tret = regmap_read(rt5514->regmap, RT5514_VENDOR_ID2, &val);\n\tif (ret || val != RT5514_DEVICE_ID) {\n\t\tdev_err(&i2c->dev,\n\t\t\t\"Device with ID register %x is not rt5514\\n\", val);\n\t\treturn -ENODEV;\n\t}\n\n\tret = regmap_multi_reg_write(rt5514->i2c_regmap, rt5514_i2c_patch,\n\t\t\t\t    ARRAY_SIZE(rt5514_i2c_patch));\n\tif (ret != 0)\n\t\tdev_warn(&i2c->dev, \"Failed to apply i2c_regmap patch: %d\\n\",\n\t\t\tret);\n\n\tret = regmap_register_patch(rt5514->regmap, rt5514_patch,\n\t\t\t\t    ARRAY_SIZE(rt5514_patch));\n\tif (ret != 0)\n\t\tdev_warn(&i2c->dev, \"Failed to apply regmap patch: %d\\n\", ret);\n\n\treturn devm_snd_soc_register_component(&i2c->dev,\n\t\t\t&soc_component_dev_rt5514,\n\t\t\trt5514_dai, ARRAY_SIZE(rt5514_dai));\n}\n\nstatic const struct dev_pm_ops rt5514_i2_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(NULL, rt5514_i2c_resume)\n};\n\nstatic struct i2c_driver rt5514_i2c_driver = {\n\t.driver = {\n\t\t.name = \"rt5514\",\n\t\t.acpi_match_table = ACPI_PTR(rt5514_acpi_match),\n\t\t.of_match_table = of_match_ptr(rt5514_of_match),\n\t\t.pm = &rt5514_i2_pm_ops,\n\t},\n\t.probe = rt5514_i2c_probe,\n\t.id_table = rt5514_i2c_id,\n};\nmodule_i2c_driver(rt5514_i2c_driver);\n\nMODULE_DESCRIPTION(\"ASoC RT5514 driver\");\nMODULE_AUTHOR(\"Oder Chiou <oder_chiou@realtek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}