{
  "module_name": "arizona.c",
  "hash_id": "3de69296923c19d2156a2f7218e45dc70b34b6785316c5c73596c72718b794e3",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/arizona.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gcd.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/pm_runtime.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/tlv.h>\n\n#include <linux/mfd/arizona/core.h>\n#include <linux/mfd/arizona/registers.h>\n\n#include \"arizona.h\"\n\n#define ARIZONA_AIF_BCLK_CTRL                   0x00\n#define ARIZONA_AIF_TX_PIN_CTRL                 0x01\n#define ARIZONA_AIF_RX_PIN_CTRL                 0x02\n#define ARIZONA_AIF_RATE_CTRL                   0x03\n#define ARIZONA_AIF_FORMAT                      0x04\n#define ARIZONA_AIF_TX_BCLK_RATE                0x05\n#define ARIZONA_AIF_RX_BCLK_RATE                0x06\n#define ARIZONA_AIF_FRAME_CTRL_1                0x07\n#define ARIZONA_AIF_FRAME_CTRL_2                0x08\n#define ARIZONA_AIF_FRAME_CTRL_3                0x09\n#define ARIZONA_AIF_FRAME_CTRL_4                0x0A\n#define ARIZONA_AIF_FRAME_CTRL_5                0x0B\n#define ARIZONA_AIF_FRAME_CTRL_6                0x0C\n#define ARIZONA_AIF_FRAME_CTRL_7                0x0D\n#define ARIZONA_AIF_FRAME_CTRL_8                0x0E\n#define ARIZONA_AIF_FRAME_CTRL_9                0x0F\n#define ARIZONA_AIF_FRAME_CTRL_10               0x10\n#define ARIZONA_AIF_FRAME_CTRL_11               0x11\n#define ARIZONA_AIF_FRAME_CTRL_12               0x12\n#define ARIZONA_AIF_FRAME_CTRL_13               0x13\n#define ARIZONA_AIF_FRAME_CTRL_14               0x14\n#define ARIZONA_AIF_FRAME_CTRL_15               0x15\n#define ARIZONA_AIF_FRAME_CTRL_16               0x16\n#define ARIZONA_AIF_FRAME_CTRL_17               0x17\n#define ARIZONA_AIF_FRAME_CTRL_18               0x18\n#define ARIZONA_AIF_TX_ENABLES                  0x19\n#define ARIZONA_AIF_RX_ENABLES                  0x1A\n#define ARIZONA_AIF_FORCE_WRITE                 0x1B\n\n#define ARIZONA_FLL_VCO_CORNER 141900000\n#define ARIZONA_FLL_MAX_FREF   13500000\n#define ARIZONA_FLL_MIN_FVCO   90000000\n#define ARIZONA_FLL_MAX_FRATIO 16\n#define ARIZONA_FLL_MAX_REFDIV 8\n#define ARIZONA_FLL_MIN_OUTDIV 2\n#define ARIZONA_FLL_MAX_OUTDIV 7\n\n#define ARIZONA_FMT_DSP_MODE_A          0\n#define ARIZONA_FMT_DSP_MODE_B          1\n#define ARIZONA_FMT_I2S_MODE            2\n#define ARIZONA_FMT_LEFT_JUSTIFIED_MODE 3\n\n#define arizona_fll_err(_fll, fmt, ...) \\\n\tdev_err(_fll->arizona->dev, \"FLL%d: \" fmt, _fll->id, ##__VA_ARGS__)\n#define arizona_fll_warn(_fll, fmt, ...) \\\n\tdev_warn(_fll->arizona->dev, \"FLL%d: \" fmt, _fll->id, ##__VA_ARGS__)\n#define arizona_fll_dbg(_fll, fmt, ...) \\\n\tdev_dbg(_fll->arizona->dev, \"FLL%d: \" fmt, _fll->id, ##__VA_ARGS__)\n\n#define arizona_aif_err(_dai, fmt, ...) \\\n\tdev_err(_dai->dev, \"AIF%d: \" fmt, _dai->id, ##__VA_ARGS__)\n#define arizona_aif_warn(_dai, fmt, ...) \\\n\tdev_warn(_dai->dev, \"AIF%d: \" fmt, _dai->id, ##__VA_ARGS__)\n#define arizona_aif_dbg(_dai, fmt, ...) \\\n\tdev_dbg(_dai->dev, \"AIF%d: \" fmt, _dai->id, ##__VA_ARGS__)\n\nstatic int arizona_spk_ev(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol,\n\t\t\t  int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct arizona *arizona = dev_get_drvdata(component->dev->parent);\n\tint val;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tval = snd_soc_component_read(component,\n\t\t\t\t\t       ARIZONA_INTERRUPT_RAW_STATUS_3);\n\t\tif (val & ARIZONA_SPK_OVERHEAT_STS) {\n\t\t\tdev_crit(arizona->dev,\n\t\t\t\t \"Speaker not enabled due to temperature\\n\");\n\t\t\treturn -EBUSY;\n\t\t}\n\n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t ARIZONA_OUTPUT_ENABLES_1,\n\t\t\t\t\t 1 << w->shift, 1 << w->shift);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t ARIZONA_OUTPUT_ENABLES_1,\n\t\t\t\t\t 1 << w->shift, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn arizona_out_ev(w, kcontrol, event);\n}\n\nstatic irqreturn_t arizona_thermal_warn(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, ARIZONA_INTERRUPT_RAW_STATUS_3,\n\t\t\t  &val);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to read thermal status: %d\\n\",\n\t\t\tret);\n\t} else if (val & ARIZONA_SPK_OVERHEAT_WARN_STS) {\n\t\tdev_crit(arizona->dev, \"Thermal warning\\n\");\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t arizona_thermal_shutdown(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, ARIZONA_INTERRUPT_RAW_STATUS_3,\n\t\t\t  &val);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to read thermal status: %d\\n\",\n\t\t\tret);\n\t} else if (val & ARIZONA_SPK_OVERHEAT_STS) {\n\t\tdev_crit(arizona->dev, \"Thermal shutdown\\n\");\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_OUTPUT_ENABLES_1,\n\t\t\t\t\t ARIZONA_OUT4L_ENA |\n\t\t\t\t\t ARIZONA_OUT4R_ENA, 0);\n\t\tif (ret != 0)\n\t\t\tdev_crit(arizona->dev,\n\t\t\t\t \"Failed to disable speaker outputs: %d\\n\",\n\t\t\t\t ret);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic const struct snd_soc_dapm_widget arizona_spkl =\n\tSND_SOC_DAPM_PGA_E(\"OUT4L\", SND_SOC_NOPM,\n\t\t\t   ARIZONA_OUT4L_ENA_SHIFT, 0, NULL, 0, arizona_spk_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD);\n\nstatic const struct snd_soc_dapm_widget arizona_spkr =\n\tSND_SOC_DAPM_PGA_E(\"OUT4R\", SND_SOC_NOPM,\n\t\t\t   ARIZONA_OUT4R_ENA_SHIFT, 0, NULL, 0, arizona_spk_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD);\n\nint arizona_init_spk(struct snd_soc_component *component)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(dapm, &arizona_spkl, 1);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tswitch (arizona->type) {\n\tcase WM8997:\n\tcase CS47L24:\n\tcase WM1831:\n\t\tbreak;\n\tdefault:\n\t\tret = snd_soc_dapm_new_controls(dapm, &arizona_spkr, 1);\n\t\tif (ret != 0)\n\t\t\treturn ret;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_spk);\n\nint arizona_init_spk_irqs(struct arizona *arizona)\n{\n\tint ret;\n\n\tret = arizona_request_irq(arizona, ARIZONA_IRQ_SPK_OVERHEAT_WARN,\n\t\t\t\t  \"Thermal warning\", arizona_thermal_warn,\n\t\t\t\t  arizona);\n\tif (ret != 0)\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to get thermal warning IRQ: %d\\n\",\n\t\t\tret);\n\n\tret = arizona_request_irq(arizona, ARIZONA_IRQ_SPK_OVERHEAT,\n\t\t\t\t  \"Thermal shutdown\", arizona_thermal_shutdown,\n\t\t\t\t  arizona);\n\tif (ret != 0)\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to get thermal shutdown IRQ: %d\\n\",\n\t\t\tret);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_spk_irqs);\n\nint arizona_free_spk_irqs(struct arizona *arizona)\n{\n\tarizona_free_irq(arizona, ARIZONA_IRQ_SPK_OVERHEAT_WARN, arizona);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_SPK_OVERHEAT, arizona);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_free_spk_irqs);\n\nstatic const struct snd_soc_dapm_route arizona_mono_routes[] = {\n\t{ \"OUT1R\", NULL, \"OUT1L\" },\n\t{ \"OUT2R\", NULL, \"OUT2L\" },\n\t{ \"OUT3R\", NULL, \"OUT3L\" },\n\t{ \"OUT4R\", NULL, \"OUT4L\" },\n\t{ \"OUT5R\", NULL, \"OUT5L\" },\n\t{ \"OUT6R\", NULL, \"OUT6L\" },\n};\n\nint arizona_init_mono(struct snd_soc_component *component)\n{\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint i;\n\n\tfor (i = 0; i < ARIZONA_MAX_OUTPUT; ++i) {\n\t\tif (arizona->pdata.out_mono[i])\n\t\t\tsnd_soc_dapm_add_routes(dapm,\n\t\t\t\t\t\t&arizona_mono_routes[i], 1);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_mono);\n\nint arizona_init_gpio(struct snd_soc_component *component)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint i;\n\n\tswitch (arizona->type) {\n\tcase WM5110:\n\tcase WM8280:\n\t\tsnd_soc_component_disable_pin(component,\n\t\t\t\t\t      \"DRC2 Signal Activity\");\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tsnd_soc_component_disable_pin(component, \"DRC1 Signal Activity\");\n\n\tfor (i = 0; i < ARRAY_SIZE(arizona->pdata.gpio_defaults); i++) {\n\t\tswitch (arizona->pdata.gpio_defaults[i] & ARIZONA_GPN_FN_MASK) {\n\t\tcase ARIZONA_GP_FN_DRC1_SIGNAL_DETECT:\n\t\t\tsnd_soc_component_enable_pin(component,\n\t\t\t\t\t\t     \"DRC1 Signal Activity\");\n\t\t\tbreak;\n\t\tcase ARIZONA_GP_FN_DRC2_SIGNAL_DETECT:\n\t\t\tsnd_soc_component_enable_pin(component,\n\t\t\t\t\t\t     \"DRC2 Signal Activity\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_gpio);\n\nint arizona_init_common(struct arizona *arizona)\n{\n\tstruct arizona_pdata *pdata = &arizona->pdata;\n\tunsigned int val, mask;\n\tint i;\n\n\tBLOCKING_INIT_NOTIFIER_HEAD(&arizona->notifier);\n\n\tfor (i = 0; i < ARIZONA_MAX_OUTPUT; ++i) {\n\t\t \n\t\tif (pdata->out_mono[i])\n\t\t\tval = ARIZONA_OUT1_MONO;\n\t\telse\n\t\t\tval = 0;\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_OUTPUT_PATH_CONFIG_1L + (i * 8),\n\t\t\t\t   ARIZONA_OUT1_MONO, val);\n\t}\n\n\tfor (i = 0; i < ARIZONA_MAX_PDM_SPK; i++) {\n\t\tif (pdata->spk_mute[i])\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t   ARIZONA_PDM_SPK1_CTRL_1 + (i * 2),\n\t\t\t\t\t   ARIZONA_SPK1_MUTE_ENDIAN_MASK |\n\t\t\t\t\t   ARIZONA_SPK1_MUTE_SEQ1_MASK,\n\t\t\t\t\t   pdata->spk_mute[i]);\n\n\t\tif (pdata->spk_fmt[i])\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t   ARIZONA_PDM_SPK1_CTRL_2 + (i * 2),\n\t\t\t\t\t   ARIZONA_SPK1_FMT_MASK,\n\t\t\t\t\t   pdata->spk_fmt[i]);\n\t}\n\n\tfor (i = 0; i < ARIZONA_MAX_INPUT; i++) {\n\t\t \n\t\tval = pdata->dmic_ref[i] << ARIZONA_IN1_DMIC_SUP_SHIFT;\n\t\tif (pdata->inmode[i] & ARIZONA_INMODE_DMIC)\n\t\t\tval |= 1 << ARIZONA_IN1_MODE_SHIFT;\n\n\t\tswitch (arizona->type) {\n\t\tcase WM8998:\n\t\tcase WM1814:\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\tARIZONA_ADC_DIGITAL_VOLUME_1L + (i * 8),\n\t\t\t\tARIZONA_IN1L_SRC_SE_MASK,\n\t\t\t\t(pdata->inmode[i] & ARIZONA_INMODE_SE)\n\t\t\t\t\t<< ARIZONA_IN1L_SRC_SE_SHIFT);\n\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\tARIZONA_ADC_DIGITAL_VOLUME_1R + (i * 8),\n\t\t\t\tARIZONA_IN1R_SRC_SE_MASK,\n\t\t\t\t(pdata->inmode[i] & ARIZONA_INMODE_SE)\n\t\t\t\t\t<< ARIZONA_IN1R_SRC_SE_SHIFT);\n\n\t\t\tmask = ARIZONA_IN1_DMIC_SUP_MASK |\n\t\t\t       ARIZONA_IN1_MODE_MASK;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif (pdata->inmode[i] & ARIZONA_INMODE_SE)\n\t\t\t\tval |= 1 << ARIZONA_IN1_SINGLE_ENDED_SHIFT;\n\n\t\t\tmask = ARIZONA_IN1_DMIC_SUP_MASK |\n\t\t\t       ARIZONA_IN1_MODE_MASK |\n\t\t\t       ARIZONA_IN1_SINGLE_ENDED_MASK;\n\t\t\tbreak;\n\t\t}\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_IN1L_CONTROL + (i * 8),\n\t\t\t\t   mask, val);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_common);\n\nint arizona_init_vol_limit(struct arizona *arizona)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(arizona->pdata.out_vol_limit); ++i) {\n\t\tif (arizona->pdata.out_vol_limit[i])\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t   ARIZONA_DAC_VOLUME_LIMIT_1L + i * 4,\n\t\t\t\t\t   ARIZONA_OUT1L_VOL_LIM_MASK,\n\t\t\t\t\t   arizona->pdata.out_vol_limit[i]);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_vol_limit);\n\nconst char * const arizona_mixer_texts[ARIZONA_NUM_MIXER_INPUTS] = {\n\t\"None\",\n\t\"Tone Generator 1\",\n\t\"Tone Generator 2\",\n\t\"Haptics\",\n\t\"AEC\",\n\t\"AEC2\",\n\t\"Mic Mute Mixer\",\n\t\"Noise Generator\",\n\t\"IN1L\",\n\t\"IN1R\",\n\t\"IN2L\",\n\t\"IN2R\",\n\t\"IN3L\",\n\t\"IN3R\",\n\t\"IN4L\",\n\t\"IN4R\",\n\t\"AIF1RX1\",\n\t\"AIF1RX2\",\n\t\"AIF1RX3\",\n\t\"AIF1RX4\",\n\t\"AIF1RX5\",\n\t\"AIF1RX6\",\n\t\"AIF1RX7\",\n\t\"AIF1RX8\",\n\t\"AIF2RX1\",\n\t\"AIF2RX2\",\n\t\"AIF2RX3\",\n\t\"AIF2RX4\",\n\t\"AIF2RX5\",\n\t\"AIF2RX6\",\n\t\"AIF3RX1\",\n\t\"AIF3RX2\",\n\t\"SLIMRX1\",\n\t\"SLIMRX2\",\n\t\"SLIMRX3\",\n\t\"SLIMRX4\",\n\t\"SLIMRX5\",\n\t\"SLIMRX6\",\n\t\"SLIMRX7\",\n\t\"SLIMRX8\",\n\t\"EQ1\",\n\t\"EQ2\",\n\t\"EQ3\",\n\t\"EQ4\",\n\t\"DRC1L\",\n\t\"DRC1R\",\n\t\"DRC2L\",\n\t\"DRC2R\",\n\t\"LHPF1\",\n\t\"LHPF2\",\n\t\"LHPF3\",\n\t\"LHPF4\",\n\t\"DSP1.1\",\n\t\"DSP1.2\",\n\t\"DSP1.3\",\n\t\"DSP1.4\",\n\t\"DSP1.5\",\n\t\"DSP1.6\",\n\t\"DSP2.1\",\n\t\"DSP2.2\",\n\t\"DSP2.3\",\n\t\"DSP2.4\",\n\t\"DSP2.5\",\n\t\"DSP2.6\",\n\t\"DSP3.1\",\n\t\"DSP3.2\",\n\t\"DSP3.3\",\n\t\"DSP3.4\",\n\t\"DSP3.5\",\n\t\"DSP3.6\",\n\t\"DSP4.1\",\n\t\"DSP4.2\",\n\t\"DSP4.3\",\n\t\"DSP4.4\",\n\t\"DSP4.5\",\n\t\"DSP4.6\",\n\t\"ASRC1L\",\n\t\"ASRC1R\",\n\t\"ASRC2L\",\n\t\"ASRC2R\",\n\t\"ISRC1INT1\",\n\t\"ISRC1INT2\",\n\t\"ISRC1INT3\",\n\t\"ISRC1INT4\",\n\t\"ISRC1DEC1\",\n\t\"ISRC1DEC2\",\n\t\"ISRC1DEC3\",\n\t\"ISRC1DEC4\",\n\t\"ISRC2INT1\",\n\t\"ISRC2INT2\",\n\t\"ISRC2INT3\",\n\t\"ISRC2INT4\",\n\t\"ISRC2DEC1\",\n\t\"ISRC2DEC2\",\n\t\"ISRC2DEC3\",\n\t\"ISRC2DEC4\",\n\t\"ISRC3INT1\",\n\t\"ISRC3INT2\",\n\t\"ISRC3INT3\",\n\t\"ISRC3INT4\",\n\t\"ISRC3DEC1\",\n\t\"ISRC3DEC2\",\n\t\"ISRC3DEC3\",\n\t\"ISRC3DEC4\",\n};\nEXPORT_SYMBOL_GPL(arizona_mixer_texts);\n\nunsigned int arizona_mixer_values[ARIZONA_NUM_MIXER_INPUTS] = {\n\t0x00,   \n\t0x04,   \n\t0x05,\n\t0x06,   \n\t0x08,   \n\t0x09,   \n\t0x0c,   \n\t0x0d,   \n\t0x10,   \n\t0x11,\n\t0x12,\n\t0x13,\n\t0x14,\n\t0x15,\n\t0x16,\n\t0x17,\n\t0x20,   \n\t0x21,\n\t0x22,\n\t0x23,\n\t0x24,\n\t0x25,\n\t0x26,\n\t0x27,\n\t0x28,   \n\t0x29,\n\t0x2a,\n\t0x2b,\n\t0x2c,\n\t0x2d,\n\t0x30,   \n\t0x31,\n\t0x38,   \n\t0x39,\n\t0x3a,\n\t0x3b,\n\t0x3c,\n\t0x3d,\n\t0x3e,\n\t0x3f,\n\t0x50,   \n\t0x51,\n\t0x52,\n\t0x53,\n\t0x58,   \n\t0x59,\n\t0x5a,\n\t0x5b,\n\t0x60,   \n\t0x61,\n\t0x62,\n\t0x63,\n\t0x68,   \n\t0x69,\n\t0x6a,\n\t0x6b,\n\t0x6c,\n\t0x6d,\n\t0x70,   \n\t0x71,\n\t0x72,\n\t0x73,\n\t0x74,\n\t0x75,\n\t0x78,   \n\t0x79,\n\t0x7a,\n\t0x7b,\n\t0x7c,\n\t0x7d,\n\t0x80,   \n\t0x81,\n\t0x82,\n\t0x83,\n\t0x84,\n\t0x85,\n\t0x90,   \n\t0x91,\n\t0x92,\n\t0x93,\n\t0xa0,   \n\t0xa1,\n\t0xa2,\n\t0xa3,\n\t0xa4,   \n\t0xa5,\n\t0xa6,\n\t0xa7,\n\t0xa8,   \n\t0xa9,\n\t0xaa,\n\t0xab,\n\t0xac,   \n\t0xad,\n\t0xae,\n\t0xaf,\n\t0xb0,   \n\t0xb1,\n\t0xb2,\n\t0xb3,\n\t0xb4,   \n\t0xb5,\n\t0xb6,\n\t0xb7,\n};\nEXPORT_SYMBOL_GPL(arizona_mixer_values);\n\nconst DECLARE_TLV_DB_SCALE(arizona_mixer_tlv, -3200, 100, 0);\nEXPORT_SYMBOL_GPL(arizona_mixer_tlv);\n\nconst char * const arizona_sample_rate_text[ARIZONA_SAMPLE_RATE_ENUM_SIZE] = {\n\t\"12kHz\", \"24kHz\", \"48kHz\", \"96kHz\", \"192kHz\",\n\t\"11.025kHz\", \"22.05kHz\", \"44.1kHz\", \"88.2kHz\", \"176.4kHz\",\n\t\"4kHz\", \"8kHz\", \"16kHz\", \"32kHz\",\n};\nEXPORT_SYMBOL_GPL(arizona_sample_rate_text);\n\nconst unsigned int arizona_sample_rate_val[ARIZONA_SAMPLE_RATE_ENUM_SIZE] = {\n\t0x01, 0x02, 0x03, 0x04, 0x05, 0x09, 0x0A, 0x0B, 0x0C, 0x0D,\n\t0x10, 0x11, 0x12, 0x13,\n};\nEXPORT_SYMBOL_GPL(arizona_sample_rate_val);\n\nconst char *arizona_sample_rate_val_to_name(unsigned int rate_val)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(arizona_sample_rate_val); ++i) {\n\t\tif (arizona_sample_rate_val[i] == rate_val)\n\t\t\treturn arizona_sample_rate_text[i];\n\t}\n\n\treturn \"Illegal\";\n}\nEXPORT_SYMBOL_GPL(arizona_sample_rate_val_to_name);\n\nconst char * const arizona_rate_text[ARIZONA_RATE_ENUM_SIZE] = {\n\t\"SYNCCLK rate\", \"8kHz\", \"16kHz\", \"ASYNCCLK rate\",\n};\nEXPORT_SYMBOL_GPL(arizona_rate_text);\n\nconst unsigned int arizona_rate_val[ARIZONA_RATE_ENUM_SIZE] = {\n\t0, 1, 2, 8,\n};\nEXPORT_SYMBOL_GPL(arizona_rate_val);\n\nconst struct soc_enum arizona_isrc_fsh[] = {\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ISRC_1_CTRL_1,\n\t\t\t      ARIZONA_ISRC1_FSH_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ISRC_2_CTRL_1,\n\t\t\t      ARIZONA_ISRC2_FSH_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ISRC_3_CTRL_1,\n\t\t\t      ARIZONA_ISRC3_FSH_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n};\nEXPORT_SYMBOL_GPL(arizona_isrc_fsh);\n\nconst struct soc_enum arizona_isrc_fsl[] = {\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ISRC_1_CTRL_2,\n\t\t\t      ARIZONA_ISRC1_FSL_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ISRC_2_CTRL_2,\n\t\t\t      ARIZONA_ISRC2_FSL_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ISRC_3_CTRL_2,\n\t\t\t      ARIZONA_ISRC3_FSL_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n};\nEXPORT_SYMBOL_GPL(arizona_isrc_fsl);\n\nconst struct soc_enum arizona_asrc_rate1 =\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_ASRC_RATE1,\n\t\t\t      ARIZONA_ASRC_RATE1_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE - 1,\n\t\t\t      arizona_rate_text, arizona_rate_val);\nEXPORT_SYMBOL_GPL(arizona_asrc_rate1);\n\nstatic const char * const arizona_vol_ramp_text[] = {\n\t\"0ms/6dB\", \"0.5ms/6dB\", \"1ms/6dB\", \"2ms/6dB\", \"4ms/6dB\", \"8ms/6dB\",\n\t\"15ms/6dB\", \"30ms/6dB\",\n};\n\nSOC_ENUM_SINGLE_DECL(arizona_in_vd_ramp,\n\t\t     ARIZONA_INPUT_VOLUME_RAMP,\n\t\t     ARIZONA_IN_VD_RAMP_SHIFT,\n\t\t     arizona_vol_ramp_text);\nEXPORT_SYMBOL_GPL(arizona_in_vd_ramp);\n\nSOC_ENUM_SINGLE_DECL(arizona_in_vi_ramp,\n\t\t     ARIZONA_INPUT_VOLUME_RAMP,\n\t\t     ARIZONA_IN_VI_RAMP_SHIFT,\n\t\t     arizona_vol_ramp_text);\nEXPORT_SYMBOL_GPL(arizona_in_vi_ramp);\n\nSOC_ENUM_SINGLE_DECL(arizona_out_vd_ramp,\n\t\t     ARIZONA_OUTPUT_VOLUME_RAMP,\n\t\t     ARIZONA_OUT_VD_RAMP_SHIFT,\n\t\t     arizona_vol_ramp_text);\nEXPORT_SYMBOL_GPL(arizona_out_vd_ramp);\n\nSOC_ENUM_SINGLE_DECL(arizona_out_vi_ramp,\n\t\t     ARIZONA_OUTPUT_VOLUME_RAMP,\n\t\t     ARIZONA_OUT_VI_RAMP_SHIFT,\n\t\t     arizona_vol_ramp_text);\nEXPORT_SYMBOL_GPL(arizona_out_vi_ramp);\n\nstatic const char * const arizona_lhpf_mode_text[] = {\n\t\"Low-pass\", \"High-pass\"\n};\n\nSOC_ENUM_SINGLE_DECL(arizona_lhpf1_mode,\n\t\t     ARIZONA_HPLPF1_1,\n\t\t     ARIZONA_LHPF1_MODE_SHIFT,\n\t\t     arizona_lhpf_mode_text);\nEXPORT_SYMBOL_GPL(arizona_lhpf1_mode);\n\nSOC_ENUM_SINGLE_DECL(arizona_lhpf2_mode,\n\t\t     ARIZONA_HPLPF2_1,\n\t\t     ARIZONA_LHPF2_MODE_SHIFT,\n\t\t     arizona_lhpf_mode_text);\nEXPORT_SYMBOL_GPL(arizona_lhpf2_mode);\n\nSOC_ENUM_SINGLE_DECL(arizona_lhpf3_mode,\n\t\t     ARIZONA_HPLPF3_1,\n\t\t     ARIZONA_LHPF3_MODE_SHIFT,\n\t\t     arizona_lhpf_mode_text);\nEXPORT_SYMBOL_GPL(arizona_lhpf3_mode);\n\nSOC_ENUM_SINGLE_DECL(arizona_lhpf4_mode,\n\t\t     ARIZONA_HPLPF4_1,\n\t\t     ARIZONA_LHPF4_MODE_SHIFT,\n\t\t     arizona_lhpf_mode_text);\nEXPORT_SYMBOL_GPL(arizona_lhpf4_mode);\n\nstatic const char * const arizona_ng_hold_text[] = {\n\t\"30ms\", \"120ms\", \"250ms\", \"500ms\",\n};\n\nSOC_ENUM_SINGLE_DECL(arizona_ng_hold,\n\t\t     ARIZONA_NOISE_GATE_CONTROL,\n\t\t     ARIZONA_NGATE_HOLD_SHIFT,\n\t\t     arizona_ng_hold_text);\nEXPORT_SYMBOL_GPL(arizona_ng_hold);\n\nstatic const char * const arizona_in_hpf_cut_text[] = {\n\t\"2.5Hz\", \"5Hz\", \"10Hz\", \"20Hz\", \"40Hz\"\n};\n\nSOC_ENUM_SINGLE_DECL(arizona_in_hpf_cut_enum,\n\t\t     ARIZONA_HPF_CONTROL,\n\t\t     ARIZONA_IN_HPF_CUT_SHIFT,\n\t\t     arizona_in_hpf_cut_text);\nEXPORT_SYMBOL_GPL(arizona_in_hpf_cut_enum);\n\nstatic const char * const arizona_in_dmic_osr_text[] = {\n\t\"1.536MHz\", \"3.072MHz\", \"6.144MHz\", \"768kHz\",\n};\n\nconst struct soc_enum arizona_in_dmic_osr[] = {\n\tSOC_ENUM_SINGLE(ARIZONA_IN1L_CONTROL, ARIZONA_IN1_OSR_SHIFT,\n\t\t\tARRAY_SIZE(arizona_in_dmic_osr_text),\n\t\t\tarizona_in_dmic_osr_text),\n\tSOC_ENUM_SINGLE(ARIZONA_IN2L_CONTROL, ARIZONA_IN2_OSR_SHIFT,\n\t\t\tARRAY_SIZE(arizona_in_dmic_osr_text),\n\t\t\tarizona_in_dmic_osr_text),\n\tSOC_ENUM_SINGLE(ARIZONA_IN3L_CONTROL, ARIZONA_IN3_OSR_SHIFT,\n\t\t\tARRAY_SIZE(arizona_in_dmic_osr_text),\n\t\t\tarizona_in_dmic_osr_text),\n\tSOC_ENUM_SINGLE(ARIZONA_IN4L_CONTROL, ARIZONA_IN4_OSR_SHIFT,\n\t\t\tARRAY_SIZE(arizona_in_dmic_osr_text),\n\t\t\tarizona_in_dmic_osr_text),\n};\nEXPORT_SYMBOL_GPL(arizona_in_dmic_osr);\n\nstatic const char * const arizona_anc_input_src_text[] = {\n\t\"None\", \"IN1\", \"IN2\", \"IN3\", \"IN4\",\n};\n\nstatic const char * const arizona_anc_channel_src_text[] = {\n\t\"None\", \"Left\", \"Right\", \"Combine\",\n};\n\nconst struct soc_enum arizona_anc_input_src[] = {\n\tSOC_ENUM_SINGLE(ARIZONA_ANC_SRC,\n\t\t\tARIZONA_IN_RXANCL_SEL_SHIFT,\n\t\t\tARRAY_SIZE(arizona_anc_input_src_text),\n\t\t\tarizona_anc_input_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_FCL_ADC_REFORMATTER_CONTROL,\n\t\t\tARIZONA_FCL_MIC_MODE_SEL_SHIFT,\n\t\t\tARRAY_SIZE(arizona_anc_channel_src_text),\n\t\t\tarizona_anc_channel_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_ANC_SRC,\n\t\t\tARIZONA_IN_RXANCR_SEL_SHIFT,\n\t\t\tARRAY_SIZE(arizona_anc_input_src_text),\n\t\t\tarizona_anc_input_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_FCR_ADC_REFORMATTER_CONTROL,\n\t\t\tARIZONA_FCR_MIC_MODE_SEL_SHIFT,\n\t\t\tARRAY_SIZE(arizona_anc_channel_src_text),\n\t\t\tarizona_anc_channel_src_text),\n};\nEXPORT_SYMBOL_GPL(arizona_anc_input_src);\n\nstatic const char * const arizona_anc_ng_texts[] = {\n\t\"None\",\n\t\"Internal\",\n\t\"External\",\n};\n\nSOC_ENUM_SINGLE_DECL(arizona_anc_ng_enum, SND_SOC_NOPM, 0,\n\t\t     arizona_anc_ng_texts);\nEXPORT_SYMBOL_GPL(arizona_anc_ng_enum);\n\nstatic const char * const arizona_output_anc_src_text[] = {\n\t\"None\", \"RXANCL\", \"RXANCR\",\n};\n\nconst struct soc_enum arizona_output_anc_src[] = {\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_1L,\n\t\t\tARIZONA_OUT1L_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_1R,\n\t\t\tARIZONA_OUT1R_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_2L,\n\t\t\tARIZONA_OUT2L_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_2R,\n\t\t\tARIZONA_OUT2R_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_3L,\n\t\t\tARIZONA_OUT3L_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_DAC_VOLUME_LIMIT_3R,\n\t\t\tARIZONA_OUT3R_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_4L,\n\t\t\tARIZONA_OUT4L_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_4R,\n\t\t\tARIZONA_OUT4R_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_5L,\n\t\t\tARIZONA_OUT5L_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_5R,\n\t\t\tARIZONA_OUT5R_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_6L,\n\t\t\tARIZONA_OUT6L_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n\tSOC_ENUM_SINGLE(ARIZONA_OUTPUT_PATH_CONFIG_6R,\n\t\t\tARIZONA_OUT6R_ANC_SRC_SHIFT,\n\t\t\tARRAY_SIZE(arizona_output_anc_src_text),\n\t\t\tarizona_output_anc_src_text),\n};\nEXPORT_SYMBOL_GPL(arizona_output_anc_src);\n\nconst struct snd_kcontrol_new arizona_voice_trigger_switch[] = {\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 0, 1, 0),\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 1, 1, 0),\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 2, 1, 0),\n\tSOC_DAPM_SINGLE(\"Switch\", SND_SOC_NOPM, 3, 1, 0),\n};\nEXPORT_SYMBOL_GPL(arizona_voice_trigger_switch);\n\nstatic void arizona_in_set_vu(struct snd_soc_component *component, int ena)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tunsigned int val;\n\tint i;\n\n\tif (ena)\n\t\tval = ARIZONA_IN_VU;\n\telse\n\t\tval = 0;\n\n\tfor (i = 0; i < priv->num_inputs; i++)\n\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t    ARIZONA_ADC_DIGITAL_VOLUME_1L + (i * 4),\n\t\t\t\t    ARIZONA_IN_VU, val);\n}\n\nbool arizona_input_analog(struct snd_soc_component *component, int shift)\n{\n\tunsigned int reg = ARIZONA_IN1L_CONTROL + ((shift / 2) * 8);\n\tunsigned int val = snd_soc_component_read(component, reg);\n\n\treturn !(val & ARIZONA_IN1_MODE_MASK);\n}\nEXPORT_SYMBOL_GPL(arizona_input_analog);\n\nint arizona_in_ev(struct snd_soc_dapm_widget *w, struct snd_kcontrol *kcontrol,\n\t\t  int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tunsigned int reg;\n\n\tif (w->shift % 2)\n\t\treg = ARIZONA_ADC_DIGITAL_VOLUME_1L + ((w->shift / 2) * 8);\n\telse\n\t\treg = ARIZONA_ADC_DIGITAL_VOLUME_1R + ((w->shift / 2) * 8);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tpriv->in_pending++;\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tsnd_soc_component_update_bits(component, reg,\n\t\t\t\t\t      ARIZONA_IN1L_MUTE, 0);\n\n\t\t \n\t\tpriv->in_pending--;\n\t\tif (priv->in_pending == 0) {\n\t\t\tmsleep(1);\n\t\t\tarizona_in_set_vu(component, 1);\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tsnd_soc_component_update_bits(component, reg,\n\t\t\t\t    ARIZONA_IN1L_MUTE | ARIZONA_IN_VU,\n\t\t\t\t    ARIZONA_IN1L_MUTE | ARIZONA_IN_VU);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\treg = snd_soc_component_read(component, ARIZONA_INPUT_ENABLES);\n\t\tif (reg == 0)\n\t\t\tarizona_in_set_vu(component, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_in_ev);\n\nint arizona_out_ev(struct snd_soc_dapm_widget *w,\n\t\t   struct snd_kcontrol *kcontrol,\n\t\t   int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tswitch (w->shift) {\n\t\tcase ARIZONA_OUT1L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT1R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3R_ENA_SHIFT:\n\t\t\tpriv->out_up_pending++;\n\t\t\tpriv->out_up_delay += 17;\n\t\t\tbreak;\n\t\tcase ARIZONA_OUT4L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT4R_ENA_SHIFT:\n\t\t\tpriv->out_up_pending++;\n\t\t\tswitch (arizona->type) {\n\t\t\tcase WM5102:\n\t\t\tcase WM8997:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpriv->out_up_delay += 10;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tswitch (w->shift) {\n\t\tcase ARIZONA_OUT1L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT1R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT4L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT4R_ENA_SHIFT:\n\t\t\tpriv->out_up_pending--;\n\t\t\tif (!priv->out_up_pending && priv->out_up_delay) {\n\t\t\t\tdev_dbg(component->dev, \"Power up delay: %d\\n\",\n\t\t\t\t\tpriv->out_up_delay);\n\t\t\t\tmsleep(priv->out_up_delay);\n\t\t\t\tpriv->out_up_delay = 0;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tswitch (w->shift) {\n\t\tcase ARIZONA_OUT1L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT1R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3R_ENA_SHIFT:\n\t\t\tpriv->out_down_pending++;\n\t\t\tpriv->out_down_delay++;\n\t\t\tbreak;\n\t\tcase ARIZONA_OUT4L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT4R_ENA_SHIFT:\n\t\t\tpriv->out_down_pending++;\n\t\t\tswitch (arizona->type) {\n\t\t\tcase WM5102:\n\t\t\tcase WM8997:\n\t\t\t\tbreak;\n\t\t\tcase WM8998:\n\t\t\tcase WM1814:\n\t\t\t\tpriv->out_down_delay += 5;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpriv->out_down_delay++;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tswitch (w->shift) {\n\t\tcase ARIZONA_OUT1L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT1R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT2R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT3R_ENA_SHIFT:\n\t\tcase ARIZONA_OUT4L_ENA_SHIFT:\n\t\tcase ARIZONA_OUT4R_ENA_SHIFT:\n\t\t\tpriv->out_down_pending--;\n\t\t\tif (!priv->out_down_pending && priv->out_down_delay) {\n\t\t\t\tdev_dbg(component->dev, \"Power down delay: %d\\n\",\n\t\t\t\t\tpriv->out_down_delay);\n\t\t\t\tmsleep(priv->out_down_delay);\n\t\t\t\tpriv->out_down_delay = 0;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_out_ev);\n\nint arizona_hp_ev(struct snd_soc_dapm_widget *w, struct snd_kcontrol *kcontrol,\n\t\t  int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tunsigned int mask = 1 << w->shift;\n\tunsigned int val;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tval = mask;\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tval = 0;\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMU:\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\treturn arizona_out_ev(w, kcontrol, event);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tpriv->arizona->hp_ena &= ~mask;\n\tpriv->arizona->hp_ena |= val;\n\n\t \n\tif (priv->arizona->hpdet_clamp)\n\t\tval = 0;\n\n\tregmap_update_bits_async(arizona->regmap, ARIZONA_OUTPUT_ENABLES_1,\n\t\t\t\t mask, val);\n\n\treturn arizona_out_ev(w, kcontrol, event);\n}\nEXPORT_SYMBOL_GPL(arizona_hp_ev);\n\nstatic int arizona_dvfs_enable(struct snd_soc_component *component)\n{\n\tconst struct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint ret;\n\n\tret = regulator_set_voltage(arizona->dcvdd, 1800000, 1800000);\n\tif (ret) {\n\t\tdev_err(component->dev, \"Failed to boost DCVDD: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t ARIZONA_DYNAMIC_FREQUENCY_SCALING_1,\n\t\t\t\t ARIZONA_SUBSYS_MAX_FREQ,\n\t\t\t\t ARIZONA_SUBSYS_MAX_FREQ);\n\tif (ret) {\n\t\tdev_err(component->dev, \"Failed to enable subsys max: %d\\n\", ret);\n\t\tregulator_set_voltage(arizona->dcvdd, 1200000, 1800000);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int arizona_dvfs_disable(struct snd_soc_component *component)\n{\n\tconst struct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint ret;\n\n\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t ARIZONA_DYNAMIC_FREQUENCY_SCALING_1,\n\t\t\t\t ARIZONA_SUBSYS_MAX_FREQ, 0);\n\tif (ret) {\n\t\tdev_err(component->dev, \"Failed to disable subsys max: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = regulator_set_voltage(arizona->dcvdd, 1200000, 1800000);\n\tif (ret) {\n\t\tdev_err(component->dev, \"Failed to unboost DCVDD: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nint arizona_dvfs_up(struct snd_soc_component *component, unsigned int flags)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tint ret = 0;\n\n\tmutex_lock(&priv->dvfs_lock);\n\n\tif (!priv->dvfs_cached && !priv->dvfs_reqs) {\n\t\tret = arizona_dvfs_enable(component);\n\t\tif (ret)\n\t\t\tgoto err;\n\t}\n\n\tpriv->dvfs_reqs |= flags;\nerr:\n\tmutex_unlock(&priv->dvfs_lock);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_dvfs_up);\n\nint arizona_dvfs_down(struct snd_soc_component *component, unsigned int flags)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tunsigned int old_reqs;\n\tint ret = 0;\n\n\tmutex_lock(&priv->dvfs_lock);\n\n\told_reqs = priv->dvfs_reqs;\n\tpriv->dvfs_reqs &= ~flags;\n\n\tif (!priv->dvfs_cached && old_reqs && !priv->dvfs_reqs)\n\t\tret = arizona_dvfs_disable(component);\n\n\tmutex_unlock(&priv->dvfs_lock);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_dvfs_down);\n\nint arizona_dvfs_sysclk_ev(struct snd_soc_dapm_widget *w,\n\t\t\t   struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tint ret = 0;\n\n\tmutex_lock(&priv->dvfs_lock);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tif (priv->dvfs_reqs)\n\t\t\tret = arizona_dvfs_enable(component);\n\n\t\tpriv->dvfs_cached = false;\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\t \n\t\tpriv->dvfs_cached = true;\n\n\t\tif (priv->dvfs_reqs)\n\t\t\tret = arizona_dvfs_disable(component);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&priv->dvfs_lock);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_dvfs_sysclk_ev);\n\nvoid arizona_init_dvfs(struct arizona_priv *priv)\n{\n\tmutex_init(&priv->dvfs_lock);\n}\nEXPORT_SYMBOL_GPL(arizona_init_dvfs);\n\nint arizona_anc_ev(struct snd_soc_dapm_widget *w,\n\t\t   struct snd_kcontrol *kcontrol,\n\t\t   int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tunsigned int val;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tval = 1 << w->shift;\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tval = 1 << (w->shift + 1);\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tsnd_soc_component_write(component, ARIZONA_CLOCK_CONTROL, val);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_anc_ev);\n\nstatic unsigned int arizona_opclk_ref_48k_rates[] = {\n\t6144000,\n\t12288000,\n\t24576000,\n\t49152000,\n};\n\nstatic unsigned int arizona_opclk_ref_44k1_rates[] = {\n\t5644800,\n\t11289600,\n\t22579200,\n\t45158400,\n};\n\nstatic int arizona_set_opclk(struct snd_soc_component *component,\n\t\t\t     unsigned int clk, unsigned int freq)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tunsigned int reg;\n\tunsigned int *rates;\n\tint ref, div, refclk;\n\n\tswitch (clk) {\n\tcase ARIZONA_CLK_OPCLK:\n\t\treg = ARIZONA_OUTPUT_SYSTEM_CLOCK;\n\t\trefclk = priv->sysclk;\n\t\tbreak;\n\tcase ARIZONA_CLK_ASYNC_OPCLK:\n\t\treg = ARIZONA_OUTPUT_ASYNC_CLOCK;\n\t\trefclk = priv->asyncclk;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (refclk % 8000)\n\t\trates = arizona_opclk_ref_44k1_rates;\n\telse\n\t\trates = arizona_opclk_ref_48k_rates;\n\n\tfor (ref = 0; ref < ARRAY_SIZE(arizona_opclk_ref_48k_rates) &&\n\t     rates[ref] <= refclk; ref++) {\n\t\tdiv = 1;\n\t\twhile (rates[ref] / div >= freq && div < 32) {\n\t\t\tif (rates[ref] / div == freq) {\n\t\t\t\tdev_dbg(component->dev, \"Configured %dHz OPCLK\\n\",\n\t\t\t\t\tfreq);\n\t\t\t\tsnd_soc_component_update_bits(component, reg,\n\t\t\t\t\t\t    ARIZONA_OPCLK_DIV_MASK |\n\t\t\t\t\t\t    ARIZONA_OPCLK_SEL_MASK,\n\t\t\t\t\t\t    (div <<\n\t\t\t\t\t\t     ARIZONA_OPCLK_DIV_SHIFT) |\n\t\t\t\t\t\t    ref);\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tdiv++;\n\t\t}\n\t}\n\n\tdev_err(component->dev, \"Unable to generate %dHz OPCLK\\n\", freq);\n\treturn -EINVAL;\n}\n\nint arizona_clk_ev(struct snd_soc_dapm_widget *w,\n\t\t   struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct arizona *arizona = dev_get_drvdata(component->dev->parent);\n\tunsigned int val;\n\tint clk_idx;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, w->reg, &val);\n\tif (ret) {\n\t\tdev_err(component->dev, \"Failed to check clock source: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tval = (val & ARIZONA_SYSCLK_SRC_MASK) >> ARIZONA_SYSCLK_SRC_SHIFT;\n\n\tswitch (val) {\n\tcase ARIZONA_CLK_SRC_MCLK1:\n\t\tclk_idx = ARIZONA_MCLK1;\n\t\tbreak;\n\tcase ARIZONA_CLK_SRC_MCLK2:\n\t\tclk_idx = ARIZONA_MCLK2;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\treturn clk_prepare_enable(arizona->mclk[clk_idx]);\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tclk_disable_unprepare(arizona->mclk[clk_idx]);\n\t\treturn 0;\n\tdefault:\n\t\treturn 0;\n\t}\n}\nEXPORT_SYMBOL_GPL(arizona_clk_ev);\n\nint arizona_set_sysclk(struct snd_soc_component *component, int clk_id,\n\t\t       int source, unsigned int freq, int dir)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tchar *name;\n\tunsigned int reg;\n\tunsigned int mask = ARIZONA_SYSCLK_FREQ_MASK | ARIZONA_SYSCLK_SRC_MASK;\n\tunsigned int val = source << ARIZONA_SYSCLK_SRC_SHIFT;\n\tint *clk;\n\n\tswitch (clk_id) {\n\tcase ARIZONA_CLK_SYSCLK:\n\t\tname = \"SYSCLK\";\n\t\treg = ARIZONA_SYSTEM_CLOCK_1;\n\t\tclk = &priv->sysclk;\n\t\tmask |= ARIZONA_SYSCLK_FRAC;\n\t\tbreak;\n\tcase ARIZONA_CLK_ASYNCCLK:\n\t\tname = \"ASYNCCLK\";\n\t\treg = ARIZONA_ASYNC_CLOCK_1;\n\t\tclk = &priv->asyncclk;\n\t\tbreak;\n\tcase ARIZONA_CLK_OPCLK:\n\tcase ARIZONA_CLK_ASYNC_OPCLK:\n\t\treturn arizona_set_opclk(component, clk_id, freq);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (freq) {\n\tcase  5644800:\n\tcase  6144000:\n\t\tbreak;\n\tcase 11289600:\n\tcase 12288000:\n\t\tval |= ARIZONA_CLK_12MHZ << ARIZONA_SYSCLK_FREQ_SHIFT;\n\t\tbreak;\n\tcase 22579200:\n\tcase 24576000:\n\t\tval |= ARIZONA_CLK_24MHZ << ARIZONA_SYSCLK_FREQ_SHIFT;\n\t\tbreak;\n\tcase 45158400:\n\tcase 49152000:\n\t\tval |= ARIZONA_CLK_49MHZ << ARIZONA_SYSCLK_FREQ_SHIFT;\n\t\tbreak;\n\tcase 67737600:\n\tcase 73728000:\n\t\tval |= ARIZONA_CLK_73MHZ << ARIZONA_SYSCLK_FREQ_SHIFT;\n\t\tbreak;\n\tcase 90316800:\n\tcase 98304000:\n\t\tval |= ARIZONA_CLK_98MHZ << ARIZONA_SYSCLK_FREQ_SHIFT;\n\t\tbreak;\n\tcase 135475200:\n\tcase 147456000:\n\t\tval |= ARIZONA_CLK_147MHZ << ARIZONA_SYSCLK_FREQ_SHIFT;\n\t\tbreak;\n\tcase 0:\n\t\tdev_dbg(arizona->dev, \"%s cleared\\n\", name);\n\t\t*clk = freq;\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t*clk = freq;\n\n\tif (freq % 6144000)\n\t\tval |= ARIZONA_SYSCLK_FRAC;\n\n\tdev_dbg(arizona->dev, \"%s set to %uHz\", name, freq);\n\n\treturn regmap_update_bits(arizona->regmap, reg, mask, val);\n}\nEXPORT_SYMBOL_GPL(arizona_set_sysclk);\n\nstatic int arizona_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint lrclk, bclk, mode, base;\n\n\tbase = dai->driver->base;\n\n\tlrclk = 0;\n\tbclk = 0;\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tmode = ARIZONA_FMT_DSP_MODE_A;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tif ((fmt & SND_SOC_DAIFMT_MASTER_MASK)\n\t\t\t\t!= SND_SOC_DAIFMT_CBM_CFM) {\n\t\t\tarizona_aif_err(dai, \"DSP_B not valid in slave mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tmode = ARIZONA_FMT_DSP_MODE_B;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tmode = ARIZONA_FMT_I2S_MODE;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tif ((fmt & SND_SOC_DAIFMT_MASTER_MASK)\n\t\t\t\t!= SND_SOC_DAIFMT_CBM_CFM) {\n\t\t\tarizona_aif_err(dai, \"LEFT_J not valid in slave mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tmode = ARIZONA_FMT_LEFT_JUSTIFIED_MODE;\n\t\tbreak;\n\tdefault:\n\t\tarizona_aif_err(dai, \"Unsupported DAI format %d\\n\",\n\t\t\t\tfmt & SND_SOC_DAIFMT_FORMAT_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\n\tcase SND_SOC_DAIFMT_CBS_CFS:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBS_CFM:\n\t\tlrclk |= ARIZONA_AIF1TX_LRCLK_MSTR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFS:\n\t\tbclk |= ARIZONA_AIF1_BCLK_MSTR;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFM:\n\t\tbclk |= ARIZONA_AIF1_BCLK_MSTR;\n\t\tlrclk |= ARIZONA_AIF1TX_LRCLK_MSTR;\n\t\tbreak;\n\tdefault:\n\t\tarizona_aif_err(dai, \"Unsupported master mode %d\\n\",\n\t\t\t\tfmt & SND_SOC_DAIFMT_MASTER_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\tbclk |= ARIZONA_AIF1_BCLK_INV;\n\t\tlrclk |= ARIZONA_AIF1TX_LRCLK_INV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\tbclk |= ARIZONA_AIF1_BCLK_INV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\tlrclk |= ARIZONA_AIF1TX_LRCLK_INV;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits_async(arizona->regmap, base + ARIZONA_AIF_BCLK_CTRL,\n\t\t\t\t ARIZONA_AIF1_BCLK_INV |\n\t\t\t\t ARIZONA_AIF1_BCLK_MSTR,\n\t\t\t\t bclk);\n\tregmap_update_bits_async(arizona->regmap, base + ARIZONA_AIF_TX_PIN_CTRL,\n\t\t\t\t ARIZONA_AIF1TX_LRCLK_INV |\n\t\t\t\t ARIZONA_AIF1TX_LRCLK_MSTR, lrclk);\n\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t base + ARIZONA_AIF_RX_PIN_CTRL,\n\t\t\t\t ARIZONA_AIF1RX_LRCLK_INV |\n\t\t\t\t ARIZONA_AIF1RX_LRCLK_MSTR, lrclk);\n\tregmap_update_bits(arizona->regmap, base + ARIZONA_AIF_FORMAT,\n\t\t\t   ARIZONA_AIF1_FMT_MASK, mode);\n\n\treturn 0;\n}\n\nstatic const int arizona_48k_bclk_rates[] = {\n\t-1,\n\t48000,\n\t64000,\n\t96000,\n\t128000,\n\t192000,\n\t256000,\n\t384000,\n\t512000,\n\t768000,\n\t1024000,\n\t1536000,\n\t2048000,\n\t3072000,\n\t4096000,\n\t6144000,\n\t8192000,\n\t12288000,\n\t24576000,\n};\n\nstatic const int arizona_44k1_bclk_rates[] = {\n\t-1,\n\t44100,\n\t58800,\n\t88200,\n\t117600,\n\t177640,\n\t235200,\n\t352800,\n\t470400,\n\t705600,\n\t940800,\n\t1411200,\n\t1881600,\n\t2822400,\n\t3763200,\n\t5644800,\n\t7526400,\n\t11289600,\n\t22579200,\n};\n\nstatic const unsigned int arizona_sr_vals[] = {\n\t0,\n\t12000,\n\t24000,\n\t48000,\n\t96000,\n\t192000,\n\t384000,\n\t768000,\n\t0,\n\t11025,\n\t22050,\n\t44100,\n\t88200,\n\t176400,\n\t352800,\n\t705600,\n\t4000,\n\t8000,\n\t16000,\n\t32000,\n\t64000,\n\t128000,\n\t256000,\n\t512000,\n};\n\n#define ARIZONA_48K_RATE_MASK\t0x0F003E\n#define ARIZONA_44K1_RATE_MASK\t0x003E00\n#define ARIZONA_RATE_MASK\t(ARIZONA_48K_RATE_MASK | ARIZONA_44K1_RATE_MASK)\n\nstatic const struct snd_pcm_hw_constraint_list arizona_constraint = {\n\t.count\t= ARRAY_SIZE(arizona_sr_vals),\n\t.list\t= arizona_sr_vals,\n};\n\nstatic int arizona_startup(struct snd_pcm_substream *substream,\n\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona_dai_priv *dai_priv = &priv->dai[dai->id - 1];\n\tunsigned int base_rate;\n\n\tif (!substream->runtime)\n\t\treturn 0;\n\n\tswitch (dai_priv->clk) {\n\tcase ARIZONA_CLK_SYSCLK:\n\t\tbase_rate = priv->sysclk;\n\t\tbreak;\n\tcase ARIZONA_CLK_ASYNCCLK:\n\t\tbase_rate = priv->asyncclk;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tif (base_rate == 0)\n\t\tdai_priv->constraint.mask = ARIZONA_RATE_MASK;\n\telse if (base_rate % 8000)\n\t\tdai_priv->constraint.mask = ARIZONA_44K1_RATE_MASK;\n\telse\n\t\tdai_priv->constraint.mask = ARIZONA_48K_RATE_MASK;\n\n\treturn snd_pcm_hw_constraint_list(substream->runtime, 0,\n\t\t\t\t\t  SNDRV_PCM_HW_PARAM_RATE,\n\t\t\t\t\t  &dai_priv->constraint);\n}\n\nstatic void arizona_wm5102_set_dac_comp(struct snd_soc_component *component,\n\t\t\t\t\tunsigned int rate)\n{\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tstruct reg_sequence dac_comp[] = {\n\t\t{ 0x80, 0x3 },\n\t\t{ ARIZONA_DAC_COMP_1, 0 },\n\t\t{ ARIZONA_DAC_COMP_2, 0 },\n\t\t{ 0x80, 0x0 },\n\t};\n\n\tmutex_lock(&arizona->dac_comp_lock);\n\n\tdac_comp[1].def = arizona->dac_comp_coeff;\n\tif (rate >= 176400)\n\t\tdac_comp[2].def = arizona->dac_comp_enabled;\n\n\tmutex_unlock(&arizona->dac_comp_lock);\n\n\tregmap_multi_reg_write(arizona->regmap,\n\t\t\t       dac_comp,\n\t\t\t       ARRAY_SIZE(dac_comp));\n}\n\nstatic int arizona_hw_params_rate(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_pcm_hw_params *params,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona_dai_priv *dai_priv = &priv->dai[dai->id - 1];\n\tint base = dai->driver->base;\n\tint i, sr_val, ret;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(arizona_sr_vals); i++)\n\t\tif (arizona_sr_vals[i] == params_rate(params))\n\t\t\tbreak;\n\tif (i == ARRAY_SIZE(arizona_sr_vals)) {\n\t\tarizona_aif_err(dai, \"Unsupported sample rate %dHz\\n\",\n\t\t\t\tparams_rate(params));\n\t\treturn -EINVAL;\n\t}\n\tsr_val = i;\n\n\tswitch (priv->arizona->type) {\n\tcase WM5102:\n\tcase WM8997:\n\t\tif (arizona_sr_vals[sr_val] >= 88200)\n\t\t\tret = arizona_dvfs_up(component, ARIZONA_DVFS_SR1_RQ);\n\t\telse\n\t\t\tret = arizona_dvfs_down(component, ARIZONA_DVFS_SR1_RQ);\n\n\t\tif (ret) {\n\t\t\tarizona_aif_err(dai, \"Failed to change DVFS %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (dai_priv->clk) {\n\tcase ARIZONA_CLK_SYSCLK:\n\t\tswitch (priv->arizona->type) {\n\t\tcase WM5102:\n\t\t\tarizona_wm5102_set_dac_comp(component,\n\t\t\t\t\t\t    params_rate(params));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tsnd_soc_component_update_bits(component, ARIZONA_SAMPLE_RATE_1,\n\t\t\t\t\t      ARIZONA_SAMPLE_RATE_1_MASK,\n\t\t\t\t\t      sr_val);\n\t\tif (base)\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tbase + ARIZONA_AIF_RATE_CTRL,\n\t\t\t\t\tARIZONA_AIF1_RATE_MASK, 0);\n\t\tbreak;\n\tcase ARIZONA_CLK_ASYNCCLK:\n\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t      ARIZONA_ASYNC_SAMPLE_RATE_1,\n\t\t\t\t\t      ARIZONA_ASYNC_SAMPLE_RATE_1_MASK,\n\t\t\t\t\t      sr_val);\n\t\tif (base)\n\t\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\tbase + ARIZONA_AIF_RATE_CTRL,\n\t\t\t\t\tARIZONA_AIF1_RATE_MASK,\n\t\t\t\t\t8 << ARIZONA_AIF1_RATE_SHIFT);\n\t\tbreak;\n\tdefault:\n\t\tarizona_aif_err(dai, \"Invalid clock %d\\n\", dai_priv->clk);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic bool arizona_aif_cfg_changed(struct snd_soc_component *component,\n\t\t\t\t    int base, int bclk, int lrclk, int frame)\n{\n\tint val;\n\n\tval = snd_soc_component_read(component, base + ARIZONA_AIF_BCLK_CTRL);\n\tif (bclk != (val & ARIZONA_AIF1_BCLK_FREQ_MASK))\n\t\treturn true;\n\n\tval = snd_soc_component_read(component, base + ARIZONA_AIF_RX_BCLK_RATE);\n\tif (lrclk != (val & ARIZONA_AIF1RX_BCPF_MASK))\n\t\treturn true;\n\n\tval = snd_soc_component_read(component, base + ARIZONA_AIF_FRAME_CTRL_1);\n\tif (frame != (val & (ARIZONA_AIF1TX_WL_MASK |\n\t\t\t     ARIZONA_AIF1TX_SLOT_LEN_MASK)))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic int arizona_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params,\n\t\t\t     struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint base = dai->driver->base;\n\tconst int *rates;\n\tint i, ret, val;\n\tint channels = params_channels(params);\n\tint chan_limit = arizona->pdata.max_channels_clocked[dai->id - 1];\n\tint tdm_width = arizona->tdm_width[dai->id - 1];\n\tint tdm_slots = arizona->tdm_slots[dai->id - 1];\n\tint bclk, lrclk, wl, frame, bclk_target;\n\tbool reconfig;\n\tunsigned int aif_tx_state, aif_rx_state;\n\n\tif (params_rate(params) % 4000)\n\t\trates = &arizona_44k1_bclk_rates[0];\n\telse\n\t\trates = &arizona_48k_bclk_rates[0];\n\n\twl = params_width(params);\n\n\tif (tdm_slots) {\n\t\tarizona_aif_dbg(dai, \"Configuring for %d %d bit TDM slots\\n\",\n\t\t\t\ttdm_slots, tdm_width);\n\t\tbclk_target = tdm_slots * tdm_width * params_rate(params);\n\t\tchannels = tdm_slots;\n\t} else {\n\t\tbclk_target = snd_soc_params_to_bclk(params);\n\t\ttdm_width = wl;\n\t}\n\n\tif (chan_limit && chan_limit < channels) {\n\t\tarizona_aif_dbg(dai, \"Limiting to %d channels\\n\", chan_limit);\n\t\tbclk_target /= channels;\n\t\tbclk_target *= chan_limit;\n\t}\n\n\t \n\tval = snd_soc_component_read(component, base + ARIZONA_AIF_FORMAT);\n\tval &= ARIZONA_AIF1_FMT_MASK;\n\tif ((channels & 1) && (val == ARIZONA_FMT_I2S_MODE)) {\n\t\tarizona_aif_dbg(dai, \"Forcing stereo mode\\n\");\n\t\tbclk_target /= channels;\n\t\tbclk_target *= channels + 1;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(arizona_44k1_bclk_rates); i++) {\n\t\tif (rates[i] >= bclk_target &&\n\t\t    rates[i] % params_rate(params) == 0) {\n\t\t\tbclk = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (i == ARRAY_SIZE(arizona_44k1_bclk_rates)) {\n\t\tarizona_aif_err(dai, \"Unsupported sample rate %dHz\\n\",\n\t\t\t\tparams_rate(params));\n\t\treturn -EINVAL;\n\t}\n\n\tlrclk = rates[bclk] / params_rate(params);\n\n\tarizona_aif_dbg(dai, \"BCLK %dHz LRCLK %dHz\\n\",\n\t\t\trates[bclk], rates[bclk] / lrclk);\n\n\tframe = wl << ARIZONA_AIF1TX_WL_SHIFT | tdm_width;\n\n\treconfig = arizona_aif_cfg_changed(component, base, bclk, lrclk, frame);\n\n\tif (reconfig) {\n\t\t \n\t\taif_tx_state = snd_soc_component_read(component,\n\t\t\t\t\t    base + ARIZONA_AIF_TX_ENABLES);\n\t\taif_rx_state = snd_soc_component_read(component,\n\t\t\t\t\t    base + ARIZONA_AIF_RX_ENABLES);\n\t\t \n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t base + ARIZONA_AIF_TX_ENABLES,\n\t\t\t\t\t 0xff, 0x0);\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   base + ARIZONA_AIF_RX_ENABLES, 0xff, 0x0);\n\t}\n\n\tret = arizona_hw_params_rate(substream, params, dai);\n\tif (ret != 0)\n\t\tgoto restore_aif;\n\n\tif (reconfig) {\n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t base + ARIZONA_AIF_BCLK_CTRL,\n\t\t\t\t\t ARIZONA_AIF1_BCLK_FREQ_MASK, bclk);\n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t base + ARIZONA_AIF_TX_BCLK_RATE,\n\t\t\t\t\t ARIZONA_AIF1TX_BCPF_MASK, lrclk);\n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t base + ARIZONA_AIF_RX_BCLK_RATE,\n\t\t\t\t\t ARIZONA_AIF1RX_BCPF_MASK, lrclk);\n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t base + ARIZONA_AIF_FRAME_CTRL_1,\n\t\t\t\t\t ARIZONA_AIF1TX_WL_MASK |\n\t\t\t\t\t ARIZONA_AIF1TX_SLOT_LEN_MASK, frame);\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   base + ARIZONA_AIF_FRAME_CTRL_2,\n\t\t\t\t   ARIZONA_AIF1RX_WL_MASK |\n\t\t\t\t   ARIZONA_AIF1RX_SLOT_LEN_MASK, frame);\n\t}\n\nrestore_aif:\n\tif (reconfig) {\n\t\t \n\t\tregmap_update_bits_async(arizona->regmap,\n\t\t\t\t\t base + ARIZONA_AIF_TX_ENABLES,\n\t\t\t\t\t 0xff, aif_tx_state);\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   base + ARIZONA_AIF_RX_ENABLES,\n\t\t\t\t   0xff, aif_rx_state);\n\t}\n\treturn ret;\n}\n\nstatic const char *arizona_dai_clk_str(int clk_id)\n{\n\tswitch (clk_id) {\n\tcase ARIZONA_CLK_SYSCLK:\n\t\treturn \"SYSCLK\";\n\tcase ARIZONA_CLK_ASYNCCLK:\n\t\treturn \"ASYNCCLK\";\n\tdefault:\n\t\treturn \"Unknown clock\";\n\t}\n}\n\nstatic int arizona_dai_set_sysclk(struct snd_soc_dai *dai,\n\t\t\t\t  int clk_id, unsigned int freq, int dir)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona_dai_priv *dai_priv = &priv->dai[dai->id - 1];\n\tstruct snd_soc_dapm_route routes[2];\n\n\tswitch (clk_id) {\n\tcase ARIZONA_CLK_SYSCLK:\n\tcase ARIZONA_CLK_ASYNCCLK:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (clk_id == dai_priv->clk)\n\t\treturn 0;\n\n\tif (snd_soc_dai_active(dai)) {\n\t\tdev_err(component->dev, \"Can't change clock on active DAI %d\\n\",\n\t\t\tdai->id);\n\t\treturn -EBUSY;\n\t}\n\n\tdev_dbg(component->dev, \"Setting AIF%d to %s\\n\", dai->id + 1,\n\t\tarizona_dai_clk_str(clk_id));\n\n\tmemset(&routes, 0, sizeof(routes));\n\troutes[0].sink = dai->driver->capture.stream_name;\n\troutes[1].sink = dai->driver->playback.stream_name;\n\n\troutes[0].source = arizona_dai_clk_str(dai_priv->clk);\n\troutes[1].source = arizona_dai_clk_str(dai_priv->clk);\n\tsnd_soc_dapm_del_routes(dapm, routes, ARRAY_SIZE(routes));\n\n\troutes[0].source = arizona_dai_clk_str(clk_id);\n\troutes[1].source = arizona_dai_clk_str(clk_id);\n\tsnd_soc_dapm_add_routes(dapm, routes, ARRAY_SIZE(routes));\n\n\tdai_priv->clk = clk_id;\n\n\treturn snd_soc_dapm_sync(dapm);\n}\n\nstatic int arizona_set_tristate(struct snd_soc_dai *dai, int tristate)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint base = dai->driver->base;\n\tunsigned int reg;\n\n\tif (tristate)\n\t\treg = ARIZONA_AIF1_TRI;\n\telse\n\t\treg = 0;\n\n\treturn snd_soc_component_update_bits(component,\n\t\t\t\t\t     base + ARIZONA_AIF_RATE_CTRL,\n\t\t\t\t\t     ARIZONA_AIF1_TRI, reg);\n}\n\nstatic void arizona_set_channels_to_mask(struct snd_soc_dai *dai,\n\t\t\t\t\t unsigned int base,\n\t\t\t\t\t int channels, unsigned int mask)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint slot, i;\n\n\tfor (i = 0; i < channels; ++i) {\n\t\tslot = ffs(mask) - 1;\n\t\tif (slot < 0)\n\t\t\treturn;\n\n\t\tregmap_write(arizona->regmap, base + i, slot);\n\n\t\tmask &= ~(1 << slot);\n\t}\n\n\tif (mask)\n\t\tarizona_aif_warn(dai, \"Too many channels in TDM mask\\n\");\n}\n\nstatic int arizona_set_tdm_slot(struct snd_soc_dai *dai, unsigned int tx_mask,\n\t\t\t\tunsigned int rx_mask, int slots, int slot_width)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct arizona_priv *priv = snd_soc_component_get_drvdata(component);\n\tstruct arizona *arizona = priv->arizona;\n\tint base = dai->driver->base;\n\tint rx_max_chan = dai->driver->playback.channels_max;\n\tint tx_max_chan = dai->driver->capture.channels_max;\n\n\t \n\tif (dai->id > ARIZONA_MAX_AIF)\n\t\treturn -ENOTSUPP;\n\n\tif (slots == 0) {\n\t\ttx_mask = (1 << tx_max_chan) - 1;\n\t\trx_mask = (1 << rx_max_chan) - 1;\n\t}\n\n\tarizona_set_channels_to_mask(dai, base + ARIZONA_AIF_FRAME_CTRL_3,\n\t\t\t\t     tx_max_chan, tx_mask);\n\tarizona_set_channels_to_mask(dai, base + ARIZONA_AIF_FRAME_CTRL_11,\n\t\t\t\t     rx_max_chan, rx_mask);\n\n\tarizona->tdm_width[dai->id - 1] = slot_width;\n\tarizona->tdm_slots[dai->id - 1] = slots;\n\n\treturn 0;\n}\n\nconst struct snd_soc_dai_ops arizona_dai_ops = {\n\t.startup = arizona_startup,\n\t.set_fmt = arizona_set_fmt,\n\t.set_tdm_slot = arizona_set_tdm_slot,\n\t.hw_params = arizona_hw_params,\n\t.set_sysclk = arizona_dai_set_sysclk,\n\t.set_tristate = arizona_set_tristate,\n};\nEXPORT_SYMBOL_GPL(arizona_dai_ops);\n\nconst struct snd_soc_dai_ops arizona_simple_dai_ops = {\n\t.startup = arizona_startup,\n\t.hw_params = arizona_hw_params_rate,\n\t.set_sysclk = arizona_dai_set_sysclk,\n};\nEXPORT_SYMBOL_GPL(arizona_simple_dai_ops);\n\nint arizona_init_dai(struct arizona_priv *priv, int id)\n{\n\tstruct arizona_dai_priv *dai_priv = &priv->dai[id];\n\n\tdai_priv->clk = ARIZONA_CLK_SYSCLK;\n\tdai_priv->constraint = arizona_constraint;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_dai);\n\nstatic struct {\n\tunsigned int min;\n\tunsigned int max;\n\tu16 fratio;\n\tint ratio;\n} fll_fratios[] = {\n\t{       0,    64000, 4, 16 },\n\t{   64000,   128000, 3,  8 },\n\t{  128000,   256000, 2,  4 },\n\t{  256000,  1000000, 1,  2 },\n\t{ 1000000, 13500000, 0,  1 },\n};\n\nstatic const unsigned int pseudo_fref_max[ARIZONA_FLL_MAX_FRATIO] = {\n\t13500000,\n\t 6144000,\n\t 6144000,\n\t 3072000,\n\t 3072000,\n\t 2822400,\n\t 2822400,\n\t 1536000,\n\t 1536000,\n\t 1536000,\n\t 1536000,\n\t 1536000,\n\t 1536000,\n\t 1536000,\n\t 1536000,\n\t  768000,\n};\n\nstatic struct {\n\tunsigned int min;\n\tunsigned int max;\n\tu16 gain;\n} fll_gains[] = {\n\t{       0,   256000, 0 },\n\t{  256000,  1000000, 2 },\n\t{ 1000000, 13500000, 4 },\n};\n\nstruct arizona_fll_cfg {\n\tint n;\n\tunsigned int theta;\n\tunsigned int lambda;\n\tint refdiv;\n\tint outdiv;\n\tint fratio;\n\tint gain;\n};\n\nstatic int arizona_validate_fll(struct arizona_fll *fll,\n\t\t\t\tunsigned int Fref,\n\t\t\t\tunsigned int Fout)\n{\n\tunsigned int Fvco_min;\n\n\tif (fll->fout && Fout != fll->fout) {\n\t\tarizona_fll_err(fll,\n\t\t\t\t\"Can't change output on active FLL\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (Fref / ARIZONA_FLL_MAX_REFDIV > ARIZONA_FLL_MAX_FREF) {\n\t\tarizona_fll_err(fll,\n\t\t\t\t\"Can't scale %dMHz in to <=13.5MHz\\n\",\n\t\t\t\tFref);\n\t\treturn -EINVAL;\n\t}\n\n\tFvco_min = ARIZONA_FLL_MIN_FVCO * fll->vco_mult;\n\tif (Fout * ARIZONA_FLL_MAX_OUTDIV < Fvco_min) {\n\t\tarizona_fll_err(fll, \"No FLL_OUTDIV for Fout=%uHz\\n\",\n\t\t\t\tFout);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int arizona_find_fratio(unsigned int Fref, int *fratio)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(fll_fratios); i++) {\n\t\tif (fll_fratios[i].min <= Fref && Fref <= fll_fratios[i].max) {\n\t\t\tif (fratio)\n\t\t\t\t*fratio = fll_fratios[i].fratio;\n\t\t\treturn fll_fratios[i].ratio;\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int arizona_calc_fratio(struct arizona_fll *fll,\n\t\t\t       struct arizona_fll_cfg *cfg,\n\t\t\t       unsigned int target,\n\t\t\t       unsigned int Fref, bool sync)\n{\n\tint init_ratio, ratio;\n\tint refdiv, div;\n\n\t \n\tdiv = 1;\n\tcfg->refdiv = 0;\n\twhile (Fref > ARIZONA_FLL_MAX_FREF) {\n\t\tdiv *= 2;\n\t\tFref /= 2;\n\t\tcfg->refdiv++;\n\n\t\tif (div > ARIZONA_FLL_MAX_REFDIV)\n\t\t\treturn -EINVAL;\n\t}\n\n\t \n\tinit_ratio = arizona_find_fratio(Fref, &cfg->fratio);\n\tif (init_ratio < 0) {\n\t\tarizona_fll_err(fll, \"Unable to find FRATIO for Fref=%uHz\\n\",\n\t\t\t\tFref);\n\t\treturn init_ratio;\n\t}\n\n\tswitch (fll->arizona->type) {\n\tcase WM5102:\n\tcase WM8997:\n\t\treturn init_ratio;\n\tcase WM5110:\n\tcase WM8280:\n\t\tif (fll->arizona->rev < 3 || sync)\n\t\t\treturn init_ratio;\n\t\tbreak;\n\tdefault:\n\t\tif (sync)\n\t\t\treturn init_ratio;\n\t\tbreak;\n\t}\n\n\tcfg->fratio = init_ratio - 1;\n\n\t \n\trefdiv = cfg->refdiv;\n\n\tarizona_fll_dbg(fll, \"pseudo: initial ratio=%u fref=%u refdiv=%u\\n\",\n\t\t\tinit_ratio, Fref, refdiv);\n\n\twhile (div <= ARIZONA_FLL_MAX_REFDIV) {\n\t\t \n\t\tfor (ratio = init_ratio; ratio > 0; ratio--) {\n\t\t\tif (target % (ratio * Fref)) {\n\t\t\t\tcfg->refdiv = refdiv;\n\t\t\t\tcfg->fratio = ratio - 1;\n\t\t\t\tarizona_fll_dbg(fll,\n\t\t\t\t\t\"pseudo: found fref=%u refdiv=%d(%d) ratio=%d\\n\",\n\t\t\t\t\tFref, refdiv, div, ratio);\n\t\t\t\treturn ratio;\n\t\t\t}\n\t\t}\n\n\t\tfor (ratio = init_ratio + 1; ratio <= ARIZONA_FLL_MAX_FRATIO;\n\t\t     ratio++) {\n\t\t\tif ((ARIZONA_FLL_VCO_CORNER / 2) /\n\t\t\t    (fll->vco_mult * ratio) < Fref) {\n\t\t\t\tarizona_fll_dbg(fll, \"pseudo: hit VCO corner\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (Fref > pseudo_fref_max[ratio - 1]) {\n\t\t\t\tarizona_fll_dbg(fll,\n\t\t\t\t\t\"pseudo: exceeded max fref(%u) for ratio=%u\\n\",\n\t\t\t\t\tpseudo_fref_max[ratio - 1],\n\t\t\t\t\tratio);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (target % (ratio * Fref)) {\n\t\t\t\tcfg->refdiv = refdiv;\n\t\t\t\tcfg->fratio = ratio - 1;\n\t\t\t\tarizona_fll_dbg(fll,\n\t\t\t\t\t\"pseudo: found fref=%u refdiv=%d(%d) ratio=%d\\n\",\n\t\t\t\t\tFref, refdiv, div, ratio);\n\t\t\t\treturn ratio;\n\t\t\t}\n\t\t}\n\n\t\tdiv *= 2;\n\t\tFref /= 2;\n\t\trefdiv++;\n\t\tinit_ratio = arizona_find_fratio(Fref, NULL);\n\t\tarizona_fll_dbg(fll,\n\t\t\t\t\"pseudo: change fref=%u refdiv=%d(%d) ratio=%u\\n\",\n\t\t\t\tFref, refdiv, div, init_ratio);\n\t}\n\n\tarizona_fll_warn(fll, \"Falling back to integer mode operation\\n\");\n\treturn cfg->fratio + 1;\n}\n\nstatic int arizona_calc_fll(struct arizona_fll *fll,\n\t\t\t    struct arizona_fll_cfg *cfg,\n\t\t\t    unsigned int Fref, bool sync)\n{\n\tunsigned int target, div, gcd_fll;\n\tint i, ratio;\n\n\tarizona_fll_dbg(fll, \"Fref=%u Fout=%u\\n\", Fref, fll->fout);\n\n\t \n\tdiv = ARIZONA_FLL_MIN_OUTDIV;\n\twhile (fll->fout * div < ARIZONA_FLL_MIN_FVCO * fll->vco_mult) {\n\t\tdiv++;\n\t\tif (div > ARIZONA_FLL_MAX_OUTDIV)\n\t\t\treturn -EINVAL;\n\t}\n\ttarget = fll->fout * div / fll->vco_mult;\n\tcfg->outdiv = div;\n\n\tarizona_fll_dbg(fll, \"Fvco=%dHz\\n\", target);\n\n\t \n\tratio = arizona_calc_fratio(fll, cfg, target, Fref, sync);\n\tif (ratio < 0)\n\t\treturn ratio;\n\n\t \n\tFref = Fref / (1 << cfg->refdiv);\n\n\tcfg->n = target / (ratio * Fref);\n\n\tif (target % (ratio * Fref)) {\n\t\tgcd_fll = gcd(target, ratio * Fref);\n\t\tarizona_fll_dbg(fll, \"GCD=%u\\n\", gcd_fll);\n\n\t\tcfg->theta = (target - (cfg->n * ratio * Fref))\n\t\t\t/ gcd_fll;\n\t\tcfg->lambda = (ratio * Fref) / gcd_fll;\n\t} else {\n\t\tcfg->theta = 0;\n\t\tcfg->lambda = 0;\n\t}\n\n\t \n\twhile (cfg->lambda >= (1 << 16)) {\n\t\tcfg->theta >>= 1;\n\t\tcfg->lambda >>= 1;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(fll_gains); i++) {\n\t\tif (fll_gains[i].min <= Fref && Fref <= fll_gains[i].max) {\n\t\t\tcfg->gain = fll_gains[i].gain;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (i == ARRAY_SIZE(fll_gains)) {\n\t\tarizona_fll_err(fll, \"Unable to find gain for Fref=%uHz\\n\",\n\t\t\t\tFref);\n\t\treturn -EINVAL;\n\t}\n\n\tarizona_fll_dbg(fll, \"N=%d THETA=%d LAMBDA=%d\\n\",\n\t\t\tcfg->n, cfg->theta, cfg->lambda);\n\tarizona_fll_dbg(fll, \"FRATIO=0x%x(%d) OUTDIV=%d REFCLK_DIV=0x%x(%d)\\n\",\n\t\t\tcfg->fratio, ratio, cfg->outdiv,\n\t\t\tcfg->refdiv, 1 << cfg->refdiv);\n\tarizona_fll_dbg(fll, \"GAIN=0x%x(%d)\\n\", cfg->gain, 1 << cfg->gain);\n\n\treturn 0;\n}\n\nstatic void arizona_apply_fll(struct arizona *arizona, unsigned int base,\n\t\t\t      struct arizona_fll_cfg *cfg, int source,\n\t\t\t      bool sync)\n{\n\tregmap_update_bits_async(arizona->regmap, base + 3,\n\t\t\t\t ARIZONA_FLL1_THETA_MASK, cfg->theta);\n\tregmap_update_bits_async(arizona->regmap, base + 4,\n\t\t\t\t ARIZONA_FLL1_LAMBDA_MASK, cfg->lambda);\n\tregmap_update_bits_async(arizona->regmap, base + 5,\n\t\t\t\t ARIZONA_FLL1_FRATIO_MASK,\n\t\t\t\t cfg->fratio << ARIZONA_FLL1_FRATIO_SHIFT);\n\tregmap_update_bits_async(arizona->regmap, base + 6,\n\t\t\t\t ARIZONA_FLL1_CLK_REF_DIV_MASK |\n\t\t\t\t ARIZONA_FLL1_CLK_REF_SRC_MASK,\n\t\t\t\t cfg->refdiv << ARIZONA_FLL1_CLK_REF_DIV_SHIFT |\n\t\t\t\t source << ARIZONA_FLL1_CLK_REF_SRC_SHIFT);\n\n\tif (sync) {\n\t\tregmap_update_bits(arizona->regmap, base + 0x7,\n\t\t\t\t   ARIZONA_FLL1_GAIN_MASK,\n\t\t\t\t   cfg->gain << ARIZONA_FLL1_GAIN_SHIFT);\n\t} else {\n\t\tregmap_update_bits(arizona->regmap, base + 0x5,\n\t\t\t\t   ARIZONA_FLL1_OUTDIV_MASK,\n\t\t\t\t   cfg->outdiv << ARIZONA_FLL1_OUTDIV_SHIFT);\n\t\tregmap_update_bits(arizona->regmap, base + 0x9,\n\t\t\t\t   ARIZONA_FLL1_GAIN_MASK,\n\t\t\t\t   cfg->gain << ARIZONA_FLL1_GAIN_SHIFT);\n\t}\n\n\tregmap_update_bits_async(arizona->regmap, base + 2,\n\t\t\t\t ARIZONA_FLL1_CTRL_UPD | ARIZONA_FLL1_N_MASK,\n\t\t\t\t ARIZONA_FLL1_CTRL_UPD | cfg->n);\n}\n\nstatic int arizona_is_enabled_fll(struct arizona_fll *fll, int base)\n{\n\tstruct arizona *arizona = fll->arizona;\n\tunsigned int reg;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, base + 1, &reg);\n\tif (ret != 0) {\n\t\tarizona_fll_err(fll, \"Failed to read current state: %d\\n\",\n\t\t\t\tret);\n\t\treturn ret;\n\t}\n\n\treturn reg & ARIZONA_FLL1_ENA;\n}\n\nstatic int arizona_set_fll_clks(struct arizona_fll *fll, int base, bool ena)\n{\n\tstruct arizona *arizona = fll->arizona;\n\tunsigned int val;\n\tstruct clk *clk;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, base + 6, &val);\n\tif (ret != 0) {\n\t\tarizona_fll_err(fll, \"Failed to read current source: %d\\n\",\n\t\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tval &= ARIZONA_FLL1_CLK_REF_SRC_MASK;\n\tval >>= ARIZONA_FLL1_CLK_REF_SRC_SHIFT;\n\n\tswitch (val) {\n\tcase ARIZONA_FLL_SRC_MCLK1:\n\t\tclk = arizona->mclk[ARIZONA_MCLK1];\n\t\tbreak;\n\tcase ARIZONA_FLL_SRC_MCLK2:\n\t\tclk = arizona->mclk[ARIZONA_MCLK2];\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tif (ena) {\n\t\treturn clk_prepare_enable(clk);\n\t} else {\n\t\tclk_disable_unprepare(clk);\n\t\treturn 0;\n\t}\n}\n\nstatic int arizona_enable_fll(struct arizona_fll *fll)\n{\n\tstruct arizona *arizona = fll->arizona;\n\tbool use_sync = false;\n\tint already_enabled = arizona_is_enabled_fll(fll, fll->base);\n\tint sync_enabled = arizona_is_enabled_fll(fll, fll->base + 0x10);\n\tstruct arizona_fll_cfg cfg;\n\tint i;\n\tunsigned int val;\n\n\tif (already_enabled < 0)\n\t\treturn already_enabled;\n\tif (sync_enabled < 0)\n\t\treturn sync_enabled;\n\n\tif (already_enabled) {\n\t\t \n\t\tregmap_update_bits(fll->arizona->regmap, fll->base + 1,\n\t\t\t\t   ARIZONA_FLL1_FREERUN, ARIZONA_FLL1_FREERUN);\n\t\tudelay(32);\n\t\tregmap_update_bits_async(fll->arizona->regmap, fll->base + 0x9,\n\t\t\t\t\t ARIZONA_FLL1_GAIN_MASK, 0);\n\n\t\tif (arizona_is_enabled_fll(fll, fll->base + 0x10) > 0)\n\t\t\tarizona_set_fll_clks(fll, fll->base + 0x10, false);\n\t\tarizona_set_fll_clks(fll, fll->base, false);\n\t}\n\n\t \n\tif (fll->ref_src >= 0 && fll->ref_freq &&\n\t    fll->ref_src != fll->sync_src) {\n\t\tarizona_calc_fll(fll, &cfg, fll->ref_freq, false);\n\n\t\t \n\t\tif (fll->sync_src >= 0 && cfg.lambda)\n\t\t\tcfg.theta = (cfg.theta * (1 << 16)) / cfg.lambda;\n\n\t\tarizona_apply_fll(arizona, fll->base, &cfg, fll->ref_src,\n\t\t\t\t  false);\n\t\tif (fll->sync_src >= 0) {\n\t\t\tarizona_calc_fll(fll, &cfg, fll->sync_freq, true);\n\n\t\t\tarizona_apply_fll(arizona, fll->base + 0x10, &cfg,\n\t\t\t\t\t  fll->sync_src, true);\n\t\t\tuse_sync = true;\n\t\t}\n\t} else if (fll->sync_src >= 0) {\n\t\tarizona_calc_fll(fll, &cfg, fll->sync_freq, false);\n\n\t\tarizona_apply_fll(arizona, fll->base, &cfg,\n\t\t\t\t  fll->sync_src, false);\n\n\t\tregmap_update_bits_async(arizona->regmap, fll->base + 0x11,\n\t\t\t\t\t ARIZONA_FLL1_SYNC_ENA, 0);\n\t} else {\n\t\tarizona_fll_err(fll, \"No clocks provided\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (already_enabled && !!sync_enabled != use_sync)\n\t\tarizona_fll_warn(fll, \"Synchroniser changed on active FLL\\n\");\n\n\t \n\tif (use_sync && fll->sync_freq > 100000)\n\t\tregmap_update_bits_async(arizona->regmap, fll->base + 0x17,\n\t\t\t\t\t ARIZONA_FLL1_SYNC_BW, 0);\n\telse\n\t\tregmap_update_bits_async(arizona->regmap, fll->base + 0x17,\n\t\t\t\t\t ARIZONA_FLL1_SYNC_BW,\n\t\t\t\t\t ARIZONA_FLL1_SYNC_BW);\n\n\tif (!already_enabled)\n\t\tpm_runtime_get_sync(arizona->dev);\n\n\tif (use_sync) {\n\t\tarizona_set_fll_clks(fll, fll->base + 0x10, true);\n\t\tregmap_update_bits_async(arizona->regmap, fll->base + 0x11,\n\t\t\t\t\t ARIZONA_FLL1_SYNC_ENA,\n\t\t\t\t\t ARIZONA_FLL1_SYNC_ENA);\n\t}\n\tarizona_set_fll_clks(fll, fll->base, true);\n\tregmap_update_bits_async(arizona->regmap, fll->base + 1,\n\t\t\t\t ARIZONA_FLL1_ENA, ARIZONA_FLL1_ENA);\n\n\tif (already_enabled)\n\t\tregmap_update_bits_async(arizona->regmap, fll->base + 1,\n\t\t\t\t\t ARIZONA_FLL1_FREERUN, 0);\n\n\tarizona_fll_dbg(fll, \"Waiting for FLL lock...\\n\");\n\tval = 0;\n\tfor (i = 0; i < 15; i++) {\n\t\tif (i < 5)\n\t\t\tusleep_range(200, 400);\n\t\telse\n\t\t\tmsleep(20);\n\n\t\tregmap_read(arizona->regmap,\n\t\t\t    ARIZONA_INTERRUPT_RAW_STATUS_5,\n\t\t\t    &val);\n\t\tif (val & (ARIZONA_FLL1_CLOCK_OK_STS << (fll->id - 1)))\n\t\t\tbreak;\n\t}\n\tif (i == 15)\n\t\tarizona_fll_warn(fll, \"Timed out waiting for lock\\n\");\n\telse\n\t\tarizona_fll_dbg(fll, \"FLL locked (%d polls)\\n\", i);\n\n\treturn 0;\n}\n\nstatic void arizona_disable_fll(struct arizona_fll *fll)\n{\n\tstruct arizona *arizona = fll->arizona;\n\tbool ref_change, sync_change;\n\n\tregmap_update_bits_async(arizona->regmap, fll->base + 1,\n\t\t\t\t ARIZONA_FLL1_FREERUN, ARIZONA_FLL1_FREERUN);\n\tregmap_update_bits_check(arizona->regmap, fll->base + 1,\n\t\t\t\t ARIZONA_FLL1_ENA, 0, &ref_change);\n\tregmap_update_bits_check(arizona->regmap, fll->base + 0x11,\n\t\t\t\t ARIZONA_FLL1_SYNC_ENA, 0, &sync_change);\n\tregmap_update_bits_async(arizona->regmap, fll->base + 1,\n\t\t\t\t ARIZONA_FLL1_FREERUN, 0);\n\n\tif (sync_change)\n\t\tarizona_set_fll_clks(fll, fll->base + 0x10, false);\n\n\tif (ref_change) {\n\t\tarizona_set_fll_clks(fll, fll->base, false);\n\t\tpm_runtime_put_autosuspend(arizona->dev);\n\t}\n}\n\nint arizona_set_fll_refclk(struct arizona_fll *fll, int source,\n\t\t\t   unsigned int Fref, unsigned int Fout)\n{\n\tint ret = 0;\n\n\tif (fll->ref_src == source && fll->ref_freq == Fref)\n\t\treturn 0;\n\n\tif (fll->fout && Fref > 0) {\n\t\tret = arizona_validate_fll(fll, Fref, fll->fout);\n\t\tif (ret != 0)\n\t\t\treturn ret;\n\t}\n\n\tfll->ref_src = source;\n\tfll->ref_freq = Fref;\n\n\tif (fll->fout && Fref > 0)\n\t\tret = arizona_enable_fll(fll);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_set_fll_refclk);\n\nint arizona_set_fll(struct arizona_fll *fll, int source,\n\t\t    unsigned int Fref, unsigned int Fout)\n{\n\tint ret = 0;\n\n\tif (fll->sync_src == source &&\n\t    fll->sync_freq == Fref && fll->fout == Fout)\n\t\treturn 0;\n\n\tif (Fout) {\n\t\tif (fll->ref_src >= 0) {\n\t\t\tret = arizona_validate_fll(fll, fll->ref_freq, Fout);\n\t\t\tif (ret != 0)\n\t\t\t\treturn ret;\n\t\t}\n\n\t\tret = arizona_validate_fll(fll, Fref, Fout);\n\t\tif (ret != 0)\n\t\t\treturn ret;\n\t}\n\n\tfll->sync_src = source;\n\tfll->sync_freq = Fref;\n\tfll->fout = Fout;\n\n\tif (Fout)\n\t\tret = arizona_enable_fll(fll);\n\telse\n\t\tarizona_disable_fll(fll);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_set_fll);\n\nint arizona_init_fll(struct arizona *arizona, int id, int base, int lock_irq,\n\t\t     int ok_irq, struct arizona_fll *fll)\n{\n\tunsigned int val;\n\n\tfll->id = id;\n\tfll->base = base;\n\tfll->arizona = arizona;\n\tfll->sync_src = ARIZONA_FLL_SRC_NONE;\n\n\t \n\tregmap_read(arizona->regmap, ARIZONA_CLOCK_32K_1, &val);\n\tswitch (val & ARIZONA_CLK_32K_SRC_MASK) {\n\tcase ARIZONA_CLK_SRC_MCLK1:\n\tcase ARIZONA_CLK_SRC_MCLK2:\n\t\tfll->ref_src = val & ARIZONA_CLK_32K_SRC_MASK;\n\t\tbreak;\n\tdefault:\n\t\tfll->ref_src = ARIZONA_FLL_SRC_NONE;\n\t}\n\tfll->ref_freq = 32768;\n\n\tsnprintf(fll->lock_name, sizeof(fll->lock_name), \"FLL%d lock\", id);\n\tsnprintf(fll->clock_ok_name, sizeof(fll->clock_ok_name),\n\t\t \"FLL%d clock OK\", id);\n\n\tregmap_update_bits(arizona->regmap, fll->base + 1,\n\t\t\t   ARIZONA_FLL1_FREERUN, 0);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_init_fll);\n\n \nint arizona_set_output_mode(struct snd_soc_component *component, int output,\n\t\t\t    bool diff)\n{\n\tunsigned int reg, val;\n\n\tif (output < 1 || output > 6)\n\t\treturn -EINVAL;\n\n\treg = ARIZONA_OUTPUT_PATH_CONFIG_1L + (output - 1) * 8;\n\n\tif (diff)\n\t\tval = ARIZONA_OUT1_MONO;\n\telse\n\t\tval = 0;\n\n\treturn snd_soc_component_update_bits(component, reg,\n\t\t\t\t\t     ARIZONA_OUT1_MONO, val);\n}\nEXPORT_SYMBOL_GPL(arizona_set_output_mode);\n\nstatic const struct soc_enum arizona_adsp2_rate_enum[] = {\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_DSP1_CONTROL_1,\n\t\t\t      ARIZONA_DSP1_RATE_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_DSP2_CONTROL_1,\n\t\t\t      ARIZONA_DSP1_RATE_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_DSP3_CONTROL_1,\n\t\t\t      ARIZONA_DSP1_RATE_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n\tSOC_VALUE_ENUM_SINGLE(ARIZONA_DSP4_CONTROL_1,\n\t\t\t      ARIZONA_DSP1_RATE_SHIFT, 0xf,\n\t\t\t      ARIZONA_RATE_ENUM_SIZE,\n\t\t\t      arizona_rate_text, arizona_rate_val),\n};\n\nconst struct snd_kcontrol_new arizona_adsp2_rate_controls[] = {\n\tSOC_ENUM(\"DSP1 Rate\", arizona_adsp2_rate_enum[0]),\n\tSOC_ENUM(\"DSP2 Rate\", arizona_adsp2_rate_enum[1]),\n\tSOC_ENUM(\"DSP3 Rate\", arizona_adsp2_rate_enum[2]),\n\tSOC_ENUM(\"DSP4 Rate\", arizona_adsp2_rate_enum[3]),\n};\nEXPORT_SYMBOL_GPL(arizona_adsp2_rate_controls);\n\nstatic bool arizona_eq_filter_unstable(bool mode, __be16 _a, __be16 _b)\n{\n\ts16 a = be16_to_cpu(_a);\n\ts16 b = be16_to_cpu(_b);\n\n\tif (!mode) {\n\t\treturn abs(a) >= 4096;\n\t} else {\n\t\tif (abs(b) >= 4096)\n\t\t\treturn true;\n\n\t\treturn (abs((a << 16) / (4096 - b)) >= 4096 << 4);\n\t}\n}\n\nint arizona_eq_coeff_put(struct snd_kcontrol *kcontrol,\n\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct arizona *arizona = dev_get_drvdata(component->dev->parent);\n\tstruct soc_bytes *params = (void *)kcontrol->private_value;\n\tunsigned int val;\n\t__be16 *data;\n\tint len;\n\tint ret;\n\n\tlen = params->num_regs * regmap_get_val_bytes(arizona->regmap);\n\n\tdata = kmemdup(ucontrol->value.bytes.data, len, GFP_KERNEL | GFP_DMA);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata[0] &= cpu_to_be16(ARIZONA_EQ1_B1_MODE);\n\n\tif (arizona_eq_filter_unstable(!!data[0], data[1], data[2]) ||\n\t    arizona_eq_filter_unstable(true, data[4], data[5]) ||\n\t    arizona_eq_filter_unstable(true, data[8], data[9]) ||\n\t    arizona_eq_filter_unstable(true, data[12], data[13]) ||\n\t    arizona_eq_filter_unstable(false, data[16], data[17])) {\n\t\tdev_err(arizona->dev, \"Rejecting unstable EQ coefficients\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tret = regmap_read(arizona->regmap, params->base, &val);\n\tif (ret != 0)\n\t\tgoto out;\n\n\tval &= ~ARIZONA_EQ1_B1_MODE;\n\tdata[0] |= cpu_to_be16(val);\n\n\tret = regmap_raw_write(arizona->regmap, params->base, data, len);\n\nout:\n\tkfree(data);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_eq_coeff_put);\n\nint arizona_lhpf_coeff_put(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct arizona *arizona = dev_get_drvdata(component->dev->parent);\n\t__be16 *data = (__be16 *)ucontrol->value.bytes.data;\n\ts16 val = be16_to_cpu(*data);\n\n\tif (abs(val) >= 4096) {\n\t\tdev_err(arizona->dev, \"Rejecting unstable LHPF coefficients\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn snd_soc_bytes_put(kcontrol, ucontrol);\n}\nEXPORT_SYMBOL_GPL(arizona_lhpf_coeff_put);\n\nint arizona_of_get_audio_pdata(struct arizona *arizona)\n{\n\tstruct arizona_pdata *pdata = &arizona->pdata;\n\tstruct device_node *np = arizona->dev->of_node;\n\tstruct property *prop;\n\tconst __be32 *cur;\n\tu32 val;\n\tu32 pdm_val[ARIZONA_MAX_PDM_SPK];\n\tint ret;\n\tint count = 0;\n\n\tcount = 0;\n\tof_property_for_each_u32(np, \"wlf,inmode\", prop, cur, val) {\n\t\tif (count == ARRAY_SIZE(pdata->inmode))\n\t\t\tbreak;\n\n\t\tpdata->inmode[count] = val;\n\t\tcount++;\n\t}\n\n\tcount = 0;\n\tof_property_for_each_u32(np, \"wlf,dmic-ref\", prop, cur, val) {\n\t\tif (count == ARRAY_SIZE(pdata->dmic_ref))\n\t\t\tbreak;\n\n\t\tpdata->dmic_ref[count] = val;\n\t\tcount++;\n\t}\n\n\tcount = 0;\n\tof_property_for_each_u32(np, \"wlf,out-mono\", prop, cur, val) {\n\t\tif (count == ARRAY_SIZE(pdata->out_mono))\n\t\t\tbreak;\n\n\t\tpdata->out_mono[count] = !!val;\n\t\tcount++;\n\t}\n\n\tcount = 0;\n\tof_property_for_each_u32(np, \"wlf,max-channels-clocked\", prop, cur, val) {\n\t\tif (count == ARRAY_SIZE(pdata->max_channels_clocked))\n\t\t\tbreak;\n\n\t\tpdata->max_channels_clocked[count] = val;\n\t\tcount++;\n\t}\n\n\tcount = 0;\n\tof_property_for_each_u32(np, \"wlf,out-volume-limit\", prop, cur, val) {\n\t\tif (count == ARRAY_SIZE(pdata->out_vol_limit))\n\t\t\tbreak;\n\n\t\tpdata->out_vol_limit[count] = val;\n\t\tcount++;\n\t}\n\n\tret = of_property_read_u32_array(np, \"wlf,spk-fmt\",\n\t\t\t\t\t pdm_val, ARRAY_SIZE(pdm_val));\n\n\tif (ret >= 0)\n\t\tfor (count = 0; count < ARRAY_SIZE(pdata->spk_fmt); ++count)\n\t\t\tpdata->spk_fmt[count] = pdm_val[count];\n\n\tret = of_property_read_u32_array(np, \"wlf,spk-mute\",\n\t\t\t\t\t pdm_val, ARRAY_SIZE(pdm_val));\n\n\tif (ret >= 0)\n\t\tfor (count = 0; count < ARRAY_SIZE(pdata->spk_mute); ++count)\n\t\t\tpdata->spk_mute[count] = pdm_val[count];\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_of_get_audio_pdata);\n\nMODULE_DESCRIPTION(\"ASoC Wolfson Arizona class device support\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}