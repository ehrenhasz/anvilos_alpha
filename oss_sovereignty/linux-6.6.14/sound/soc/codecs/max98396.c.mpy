{
  "module_name": "max98396.c",
  "hash_id": "9bfa89e49717dfdf8c1f78607a01b3fcf6e5188c3570cab19736a5b6f23c3e53",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/max98396.c",
  "human_readable_source": "\n\n\n#include <linux/gpio/consumer.h>\n#include <linux/i2c.h>\n#include <linux/module.h>\n#include <sound/pcm_params.h>\n#include <linux/regulator/consumer.h>\n#include <sound/soc.h>\n#include <linux/gpio.h>\n#include <sound/tlv.h>\n#include \"max98396.h\"\n\nstatic const char * const max98396_core_supplies[MAX98396_NUM_CORE_SUPPLIES] = {\n\t\"avdd\",\n\t\"dvdd\",\n\t\"dvddio\",\n};\n\nstatic struct reg_default max98396_reg[] = {\n\t{MAX98396_R2000_SW_RESET, 0x00},\n\t{MAX98396_R2001_INT_RAW1, 0x00},\n\t{MAX98396_R2002_INT_RAW2, 0x00},\n\t{MAX98396_R2003_INT_RAW3, 0x00},\n\t{MAX98396_R2004_INT_RAW4, 0x00},\n\t{MAX98396_R2006_INT_STATE1, 0x00},\n\t{MAX98396_R2007_INT_STATE2, 0x00},\n\t{MAX98396_R2008_INT_STATE3, 0x00},\n\t{MAX98396_R2009_INT_STATE4, 0x00},\n\t{MAX98396_R200B_INT_FLAG1, 0x00},\n\t{MAX98396_R200C_INT_FLAG2, 0x00},\n\t{MAX98396_R200D_INT_FLAG3, 0x00},\n\t{MAX98396_R200E_INT_FLAG4, 0x00},\n\t{MAX98396_R2010_INT_EN1, 0x02},\n\t{MAX98396_R2011_INT_EN2, 0x00},\n\t{MAX98396_R2012_INT_EN3, 0x00},\n\t{MAX98396_R2013_INT_EN4, 0x00},\n\t{MAX98396_R2015_INT_FLAG_CLR1, 0x00},\n\t{MAX98396_R2016_INT_FLAG_CLR2, 0x00},\n\t{MAX98396_R2017_INT_FLAG_CLR3, 0x00},\n\t{MAX98396_R2018_INT_FLAG_CLR4, 0x00},\n\t{MAX98396_R201F_IRQ_CTRL, 0x00},\n\t{MAX98396_R2020_THERM_WARN_THRESH, 0x46},\n\t{MAX98396_R2021_THERM_WARN_THRESH2, 0x46},\n\t{MAX98396_R2022_THERM_SHDN_THRESH, 0x64},\n\t{MAX98396_R2023_THERM_HYSTERESIS, 0x02},\n\t{MAX98396_R2024_THERM_FOLDBACK_SET, 0xC5},\n\t{MAX98396_R2027_THERM_FOLDBACK_EN, 0x01},\n\t{MAX98396_R2030_NOISEGATE_MODE_CTRL, 0x32},\n\t{MAX98396_R2033_NOISEGATE_MODE_EN, 0x00},\n\t{MAX98396_R2038_CLK_MON_CTRL, 0x00},\n\t{MAX98396_R2039_DATA_MON_CTRL, 0x00},\n\t{MAX98396_R203F_ENABLE_CTRLS, 0x0F},\n\t{MAX98396_R2040_PIN_CFG, 0x55},\n\t{MAX98396_R2041_PCM_MODE_CFG, 0xC0},\n\t{MAX98396_R2042_PCM_CLK_SETUP, 0x04},\n\t{MAX98396_R2043_PCM_SR_SETUP, 0x88},\n\t{MAX98396_R2044_PCM_TX_CTRL_1, 0x00},\n\t{MAX98396_R2045_PCM_TX_CTRL_2, 0x00},\n\t{MAX98396_R2046_PCM_TX_CTRL_3, 0x00},\n\t{MAX98396_R2047_PCM_TX_CTRL_4, 0x00},\n\t{MAX98396_R2048_PCM_TX_CTRL_5, 0x00},\n\t{MAX98396_R2049_PCM_TX_CTRL_6, 0x00},\n\t{MAX98396_R204A_PCM_TX_CTRL_7, 0x00},\n\t{MAX98396_R204B_PCM_TX_CTRL_8, 0x00},\n\t{MAX98396_R204C_PCM_TX_HIZ_CTRL_1, 0xFF},\n\t{MAX98396_R204D_PCM_TX_HIZ_CTRL_2, 0xFF},\n\t{MAX98396_R204E_PCM_TX_HIZ_CTRL_3, 0xFF},\n\t{MAX98396_R204F_PCM_TX_HIZ_CTRL_4, 0xFF},\n\t{MAX98396_R2050_PCM_TX_HIZ_CTRL_5, 0xFF},\n\t{MAX98396_R2051_PCM_TX_HIZ_CTRL_6, 0xFF},\n\t{MAX98396_R2052_PCM_TX_HIZ_CTRL_7, 0xFF},\n\t{MAX98396_R2053_PCM_TX_HIZ_CTRL_8, 0xFF},\n\t{MAX98396_R2055_PCM_RX_SRC1, 0x00},\n\t{MAX98396_R2056_PCM_RX_SRC2, 0x00},\n\t{MAX98396_R2058_PCM_BYPASS_SRC, 0x00},\n\t{MAX98396_R205D_PCM_TX_SRC_EN, 0x00},\n\t{MAX98396_R205E_PCM_RX_EN, 0x00},\n\t{MAX98396_R205F_PCM_TX_EN, 0x00},\n\t{MAX98396_R2070_ICC_RX_EN_A, 0x00},\n\t{MAX98396_R2071_ICC_RX_EN_B, 0x00},\n\t{MAX98396_R2072_ICC_TX_CTRL, 0x00},\n\t{MAX98396_R207F_ICC_EN, 0x00},\n\t{MAX98396_R2083_TONE_GEN_DC_CFG, 0x04},\n\t{MAX98396_R2084_TONE_GEN_DC_LVL1, 0x00},\n\t{MAX98396_R2085_TONE_GEN_DC_LVL2, 0x00},\n\t{MAX98396_R2086_TONE_GEN_DC_LVL3, 0x00},\n\t{MAX98396_R208F_TONE_GEN_EN, 0x00},\n\t{MAX98396_R2090_AMP_VOL_CTRL, 0x00},\n\t{MAX98396_R2091_AMP_PATH_GAIN, 0x0B},\n\t{MAX98396_R2092_AMP_DSP_CFG, 0x23},\n\t{MAX98396_R2093_SSM_CFG, 0x0D},\n\t{MAX98396_R2094_SPK_CLS_DG_THRESH, 0x12},\n\t{MAX98396_R2095_SPK_CLS_DG_HDR, 0x17},\n\t{MAX98396_R2096_SPK_CLS_DG_HOLD_TIME, 0x17},\n\t{MAX98396_R2097_SPK_CLS_DG_DELAY, 0x00},\n\t{MAX98396_R2098_SPK_CLS_DG_MODE, 0x00},\n\t{MAX98396_R2099_SPK_CLS_DG_VBAT_LVL, 0x03},\n\t{MAX98396_R209A_SPK_EDGE_CTRL, 0x00},\n\t{MAX98396_R209C_SPK_EDGE_CTRL1, 0x0A},\n\t{MAX98396_R209D_SPK_EDGE_CTRL2, 0xAA},\n\t{MAX98396_R209E_AMP_CLIP_GAIN, 0x00},\n\t{MAX98396_R209F_BYPASS_PATH_CFG, 0x00},\n\t{MAX98396_R20A0_AMP_SUPPLY_CTL, 0x00},\n\t{MAX98396_R20AF_AMP_EN, 0x00},\n\t{MAX98396_R20B0_ADC_SR, 0x30},\n\t{MAX98396_R20B1_ADC_PVDD_CFG, 0x00},\n\t{MAX98396_R20B2_ADC_VBAT_CFG, 0x00},\n\t{MAX98396_R20B3_ADC_THERMAL_CFG, 0x00},\n\t{MAX98396_R20B4_ADC_READBACK_CTRL1, 0x00},\n\t{MAX98396_R20B5_ADC_READBACK_CTRL2, 0x00},\n\t{MAX98396_R20B6_ADC_PVDD_READBACK_MSB, 0x00},\n\t{MAX98396_R20B7_ADC_PVDD_READBACK_LSB, 0x00},\n\t{MAX98396_R20B8_ADC_VBAT_READBACK_MSB, 0x00},\n\t{MAX98396_R20B9_ADC_VBAT_READBACK_LSB, 0x00},\n\t{MAX98396_R20BA_ADC_TEMP_READBACK_MSB, 0x00},\n\t{MAX98396_R20BB_ADC_TEMP_READBACK_LSB, 0x00},\n\t{MAX98396_R20BC_ADC_LO_PVDD_READBACK_MSB, 0x00},\n\t{MAX98396_R20BD_ADC_LO_PVDD_READBACK_LSB, 0x00},\n\t{MAX98396_R20BE_ADC_LO_VBAT_READBACK_MSB, 0x00},\n\t{MAX98396_R20BF_ADC_LO_VBAT_READBACK_LSB, 0x00},\n\t{MAX98396_R20C7_ADC_CFG, 0x00},\n\t{MAX98396_R20D0_DHT_CFG1, 0x00},\n\t{MAX98396_R20D1_LIMITER_CFG1, 0x08},\n\t{MAX98396_R20D2_LIMITER_CFG2, 0x00},\n\t{MAX98396_R20D3_DHT_CFG2, 0x14},\n\t{MAX98396_R20D4_DHT_CFG3, 0x02},\n\t{MAX98396_R20D5_DHT_CFG4, 0x04},\n\t{MAX98396_R20D6_DHT_HYSTERESIS_CFG, 0x07},\n\t{MAX98396_R20DF_DHT_EN, 0x00},\n\t{MAX98396_R20E0_IV_SENSE_PATH_CFG, 0x04},\n\t{MAX98396_R20E4_IV_SENSE_PATH_EN, 0x00},\n\t{MAX98396_R20E5_BPE_STATE, 0x00},\n\t{MAX98396_R20E6_BPE_L3_THRESH_MSB, 0x00},\n\t{MAX98396_R20E7_BPE_L3_THRESH_LSB, 0x00},\n\t{MAX98396_R20E8_BPE_L2_THRESH_MSB, 0x00},\n\t{MAX98396_R20E9_BPE_L2_THRESH_LSB, 0x00},\n\t{MAX98396_R20EA_BPE_L1_THRESH_MSB, 0x00},\n\t{MAX98396_R20EB_BPE_L1_THRESH_LSB, 0x00},\n\t{MAX98396_R20EC_BPE_L0_THRESH_MSB, 0x00},\n\t{MAX98396_R20ED_BPE_L0_THRESH_LSB, 0x00},\n\t{MAX98396_R20EE_BPE_L3_DWELL_HOLD_TIME, 0x00},\n\t{MAX98396_R20EF_BPE_L2_DWELL_HOLD_TIME, 0x00},\n\t{MAX98396_R20F0_BPE_L1_DWELL_HOLD_TIME, 0x00},\n\t{MAX98396_R20F1_BPE_L0_HOLD_TIME, 0x00},\n\t{MAX98396_R20F2_BPE_L3_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F3_BPE_L2_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F4_BPE_L1_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F5_BPE_L0_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F6_BPE_L3_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20F7_BPE_L2_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20F8_BPE_L1_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20F9_BPE_L0_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20FA_BPE_L3_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FB_BPE_L2_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FC_BPE_L1_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FD_BPE_L0_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FE_BPE_L3_LIMITER_CFG, 0x00},\n\t{MAX98396_R20FF_BPE_L2_LIMITER_CFG, 0x00},\n\t{MAX98396_R2100_BPE_L1_LIMITER_CFG, 0x00},\n\t{MAX98396_R2101_BPE_L0_LIMITER_CFG, 0x00},\n\t{MAX98396_R2102_BPE_L3_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2103_BPE_L2_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2104_BPE_L1_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2105_BPE_L0_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2106_BPE_THRESH_HYSTERESIS, 0x00},\n\t{MAX98396_R2107_BPE_INFINITE_HOLD_CLR, 0x00},\n\t{MAX98396_R2108_BPE_SUPPLY_SRC, 0x00},\n\t{MAX98396_R2109_BPE_LOW_STATE, 0x00},\n\t{MAX98396_R210A_BPE_LOW_GAIN, 0x00},\n\t{MAX98396_R210B_BPE_LOW_LIMITER, 0x00},\n\t{MAX98396_R210D_BPE_EN, 0x00},\n\t{MAX98396_R210E_AUTO_RESTART, 0x00},\n\t{MAX98396_R210F_GLOBAL_EN, 0x00},\n\t{MAX98396_R21FF_REVISION_ID, 0x00},\n};\n\nstatic struct reg_default max98397_reg[] = {\n\t{MAX98396_R2000_SW_RESET, 0x00},\n\t{MAX98396_R2001_INT_RAW1, 0x00},\n\t{MAX98396_R2002_INT_RAW2, 0x00},\n\t{MAX98396_R2003_INT_RAW3, 0x00},\n\t{MAX98396_R2004_INT_RAW4, 0x00},\n\t{MAX98396_R2006_INT_STATE1, 0x00},\n\t{MAX98396_R2007_INT_STATE2, 0x00},\n\t{MAX98396_R2008_INT_STATE3, 0x00},\n\t{MAX98396_R2009_INT_STATE4, 0x00},\n\t{MAX98396_R200B_INT_FLAG1, 0x00},\n\t{MAX98396_R200C_INT_FLAG2, 0x00},\n\t{MAX98396_R200D_INT_FLAG3, 0x00},\n\t{MAX98396_R200E_INT_FLAG4, 0x00},\n\t{MAX98396_R2010_INT_EN1, 0x02},\n\t{MAX98396_R2011_INT_EN2, 0x00},\n\t{MAX98396_R2012_INT_EN3, 0x00},\n\t{MAX98396_R2013_INT_EN4, 0x00},\n\t{MAX98396_R2015_INT_FLAG_CLR1, 0x00},\n\t{MAX98396_R2016_INT_FLAG_CLR2, 0x00},\n\t{MAX98396_R2017_INT_FLAG_CLR3, 0x00},\n\t{MAX98396_R2018_INT_FLAG_CLR4, 0x00},\n\t{MAX98396_R201F_IRQ_CTRL, 0x00},\n\t{MAX98396_R2020_THERM_WARN_THRESH, 0x46},\n\t{MAX98396_R2021_THERM_WARN_THRESH2, 0x46},\n\t{MAX98396_R2022_THERM_SHDN_THRESH, 0x64},\n\t{MAX98396_R2023_THERM_HYSTERESIS, 0x02},\n\t{MAX98396_R2024_THERM_FOLDBACK_SET, 0xC5},\n\t{MAX98396_R2027_THERM_FOLDBACK_EN, 0x01},\n\t{MAX98396_R2030_NOISEGATE_MODE_CTRL, 0x32},\n\t{MAX98396_R2033_NOISEGATE_MODE_EN, 0x00},\n\t{MAX98396_R2038_CLK_MON_CTRL, 0x00},\n\t{MAX98396_R2039_DATA_MON_CTRL, 0x00},\n\t{MAX98397_R203A_SPK_MON_THRESH, 0x03},\n\t{MAX98396_R203F_ENABLE_CTRLS, 0x0F},\n\t{MAX98396_R2040_PIN_CFG, 0x55},\n\t{MAX98396_R2041_PCM_MODE_CFG, 0xC0},\n\t{MAX98396_R2042_PCM_CLK_SETUP, 0x04},\n\t{MAX98396_R2043_PCM_SR_SETUP, 0x88},\n\t{MAX98396_R2044_PCM_TX_CTRL_1, 0x00},\n\t{MAX98396_R2045_PCM_TX_CTRL_2, 0x00},\n\t{MAX98396_R2046_PCM_TX_CTRL_3, 0x00},\n\t{MAX98396_R2047_PCM_TX_CTRL_4, 0x00},\n\t{MAX98396_R2048_PCM_TX_CTRL_5, 0x00},\n\t{MAX98396_R2049_PCM_TX_CTRL_6, 0x00},\n\t{MAX98396_R204A_PCM_TX_CTRL_7, 0x00},\n\t{MAX98396_R204B_PCM_TX_CTRL_8, 0x00},\n\t{MAX98397_R204C_PCM_TX_CTRL_9, 0x00},\n\t{MAX98397_R204D_PCM_TX_HIZ_CTRL_1, 0xFF},\n\t{MAX98397_R204E_PCM_TX_HIZ_CTRL_2, 0xFF},\n\t{MAX98397_R204F_PCM_TX_HIZ_CTRL_3, 0xFF},\n\t{MAX98397_R2050_PCM_TX_HIZ_CTRL_4, 0xFF},\n\t{MAX98397_R2051_PCM_TX_HIZ_CTRL_5, 0xFF},\n\t{MAX98397_R2052_PCM_TX_HIZ_CTRL_6, 0xFF},\n\t{MAX98397_R2053_PCM_TX_HIZ_CTRL_7, 0xFF},\n\t{MAX98397_R2054_PCM_TX_HIZ_CTRL_8, 0xFF},\n\t{MAX98397_R2056_PCM_RX_SRC1, 0x00},\n\t{MAX98397_R2057_PCM_RX_SRC2, 0x00},\n\t{MAX98396_R2058_PCM_BYPASS_SRC, 0x00},\n\t{MAX98396_R205D_PCM_TX_SRC_EN, 0x00},\n\t{MAX98396_R205E_PCM_RX_EN, 0x00},\n\t{MAX98396_R205F_PCM_TX_EN, 0x00},\n\t{MAX98397_R2060_PCM_TX_SUPPLY_SEL, 0x00},\n\t{MAX98396_R2070_ICC_RX_EN_A, 0x00},\n\t{MAX98396_R2071_ICC_RX_EN_B, 0x00},\n\t{MAX98396_R2072_ICC_TX_CTRL, 0x00},\n\t{MAX98396_R207F_ICC_EN, 0x00},\n\t{MAX98396_R2083_TONE_GEN_DC_CFG, 0x04},\n\t{MAX98396_R2084_TONE_GEN_DC_LVL1, 0x00},\n\t{MAX98396_R2085_TONE_GEN_DC_LVL2, 0x00},\n\t{MAX98396_R2086_TONE_GEN_DC_LVL3, 0x00},\n\t{MAX98396_R208F_TONE_GEN_EN, 0x00},\n\t{MAX98396_R2090_AMP_VOL_CTRL, 0x00},\n\t{MAX98396_R2091_AMP_PATH_GAIN, 0x12},\n\t{MAX98396_R2092_AMP_DSP_CFG, 0x22},\n\t{MAX98396_R2093_SSM_CFG, 0x08},\n\t{MAX98396_R2094_SPK_CLS_DG_THRESH, 0x12},\n\t{MAX98396_R2095_SPK_CLS_DG_HDR, 0x17},\n\t{MAX98396_R2096_SPK_CLS_DG_HOLD_TIME, 0x17},\n\t{MAX98396_R2097_SPK_CLS_DG_DELAY, 0x00},\n\t{MAX98396_R2098_SPK_CLS_DG_MODE, 0x00},\n\t{MAX98396_R2099_SPK_CLS_DG_VBAT_LVL, 0x03},\n\t{MAX98396_R209A_SPK_EDGE_CTRL, 0x00},\n\t{MAX98397_R209B_SPK_PATH_WB_ONLY, 0x00},\n\t{MAX98396_R209C_SPK_EDGE_CTRL1, 0x03},\n\t{MAX98396_R209D_SPK_EDGE_CTRL2, 0xFC},\n\t{MAX98396_R209E_AMP_CLIP_GAIN, 0x00},\n\t{MAX98396_R209F_BYPASS_PATH_CFG, 0x00},\n\t{MAX98396_R20AF_AMP_EN, 0x00},\n\t{MAX98396_R20B0_ADC_SR, 0x30},\n\t{MAX98396_R20B1_ADC_PVDD_CFG, 0x00},\n\t{MAX98396_R20B2_ADC_VBAT_CFG, 0x00},\n\t{MAX98396_R20B3_ADC_THERMAL_CFG, 0x00},\n\t{MAX98397_R20B4_ADC_VDDH_CFG, 0x00},\n\t{MAX98397_R20B5_ADC_READBACK_CTRL1, 0x00},\n\t{MAX98397_R20B6_ADC_READBACK_CTRL2, 0x00},\n\t{MAX98397_R20B7_ADC_PVDD_READBACK_MSB, 0x00},\n\t{MAX98397_R20B8_ADC_PVDD_READBACK_LSB, 0x00},\n\t{MAX98397_R20B9_ADC_VBAT_READBACK_MSB, 0x00},\n\t{MAX98397_R20BA_ADC_VBAT_READBACK_LSB, 0x00},\n\t{MAX98397_R20BB_ADC_TEMP_READBACK_MSB, 0x00},\n\t{MAX98397_R20BC_ADC_TEMP_READBACK_LSB, 0x00},\n\t{MAX98397_R20BD_ADC_VDDH__READBACK_MSB, 0x00},\n\t{MAX98397_R20BE_ADC_VDDH_READBACK_LSB, 0x00},\n\t{MAX98396_R20BF_ADC_LO_VBAT_READBACK_LSB, 0x00},\n\t{MAX98397_R20C3_ADC_LO_VDDH_READBACK_MSB, 0x00},\n\t{MAX98397_R20C4_ADC_LO_VDDH_READBACK_LSB, 0x00},\n\t{MAX98397_R20C5_MEAS_ADC_OPTIMAL_MODE, 0x04},\n\t{MAX98396_R20C7_ADC_CFG, 0x00},\n\t{MAX98396_R20D0_DHT_CFG1, 0x00},\n\t{MAX98396_R20D1_LIMITER_CFG1, 0x08},\n\t{MAX98396_R20D2_LIMITER_CFG2, 0x00},\n\t{MAX98396_R20D3_DHT_CFG2, 0x14},\n\t{MAX98396_R20D4_DHT_CFG3, 0x02},\n\t{MAX98396_R20D5_DHT_CFG4, 0x04},\n\t{MAX98396_R20D6_DHT_HYSTERESIS_CFG, 0x07},\n\t{MAX98396_R20DF_DHT_EN, 0x00},\n\t{MAX98396_R20E0_IV_SENSE_PATH_CFG, 0x04},\n\t{MAX98396_R20E4_IV_SENSE_PATH_EN, 0x00},\n\t{MAX98396_R20E5_BPE_STATE, 0x00},\n\t{MAX98396_R20E6_BPE_L3_THRESH_MSB, 0x00},\n\t{MAX98396_R20E7_BPE_L3_THRESH_LSB, 0x00},\n\t{MAX98396_R20E8_BPE_L2_THRESH_MSB, 0x00},\n\t{MAX98396_R20E9_BPE_L2_THRESH_LSB, 0x00},\n\t{MAX98396_R20EA_BPE_L1_THRESH_MSB, 0x00},\n\t{MAX98396_R20EB_BPE_L1_THRESH_LSB, 0x00},\n\t{MAX98396_R20EC_BPE_L0_THRESH_MSB, 0x00},\n\t{MAX98396_R20ED_BPE_L0_THRESH_LSB, 0x00},\n\t{MAX98396_R20EE_BPE_L3_DWELL_HOLD_TIME, 0x00},\n\t{MAX98396_R20EF_BPE_L2_DWELL_HOLD_TIME, 0x00},\n\t{MAX98396_R20F0_BPE_L1_DWELL_HOLD_TIME, 0x00},\n\t{MAX98396_R20F1_BPE_L0_HOLD_TIME, 0x00},\n\t{MAX98396_R20F2_BPE_L3_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F3_BPE_L2_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F4_BPE_L1_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F5_BPE_L0_ATTACK_REL_STEP, 0x00},\n\t{MAX98396_R20F6_BPE_L3_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20F7_BPE_L2_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20F8_BPE_L1_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20F9_BPE_L0_MAX_GAIN_ATTN, 0x00},\n\t{MAX98396_R20FA_BPE_L3_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FB_BPE_L2_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FC_BPE_L1_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FD_BPE_L0_ATT_REL_RATE, 0x00},\n\t{MAX98396_R20FE_BPE_L3_LIMITER_CFG, 0x00},\n\t{MAX98396_R20FF_BPE_L2_LIMITER_CFG, 0x00},\n\t{MAX98396_R2100_BPE_L1_LIMITER_CFG, 0x00},\n\t{MAX98396_R2101_BPE_L0_LIMITER_CFG, 0x00},\n\t{MAX98396_R2102_BPE_L3_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2103_BPE_L2_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2104_BPE_L1_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2105_BPE_L0_LIM_ATT_REL_RATE, 0x00},\n\t{MAX98396_R2106_BPE_THRESH_HYSTERESIS, 0x00},\n\t{MAX98396_R2107_BPE_INFINITE_HOLD_CLR, 0x00},\n\t{MAX98396_R2108_BPE_SUPPLY_SRC, 0x00},\n\t{MAX98396_R2109_BPE_LOW_STATE, 0x00},\n\t{MAX98396_R210A_BPE_LOW_GAIN, 0x00},\n\t{MAX98396_R210B_BPE_LOW_LIMITER, 0x00},\n\t{MAX98396_R210D_BPE_EN, 0x00},\n\t{MAX98396_R210E_AUTO_RESTART, 0x00},\n\t{MAX98396_R210F_GLOBAL_EN, 0x00},\n\t{MAX98397_R22FF_REVISION_ID, 0x00},\n};\n\nstatic void max98396_global_enable_onoff(struct regmap *regmap, bool onoff)\n{\n\tregmap_write(regmap, MAX98396_R210F_GLOBAL_EN, onoff ? 1 : 0);\n\tusleep_range(11000, 12000);\n}\n\nstatic int max98396_dai_set_fmt(struct snd_soc_dai *codec_dai, unsigned int fmt)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tstruct max98396_priv *max98396 = snd_soc_component_get_drvdata(component);\n\tunsigned int format_mask, format = 0;\n\tunsigned int bclk_pol = 0;\n\tint ret, status;\n\tint reg;\n\tbool update = false;\n\n\tformat_mask = MAX98396_PCM_MODE_CFG_FORMAT_MASK |\n\t\t      MAX98396_PCM_MODE_CFG_LRCLKEDGE;\n\n\tdev_dbg(component->dev, \"%s: fmt 0x%08X\\n\", __func__, fmt);\n\n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\tformat = MAX98396_PCM_MODE_CFG_LRCLKEDGE;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\tbclk_pol = MAX98396_PCM_MODE_CFG_BCLKEDGE;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\tbclk_pol = MAX98396_PCM_MODE_CFG_BCLKEDGE;\n\t\tformat = MAX98396_PCM_MODE_CFG_LRCLKEDGE;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(component->dev, \"DAI invert mode %d unsupported\\n\",\n\t\t\tfmt & SND_SOC_DAIFMT_INV_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tformat |= MAX98396_PCM_FORMAT_I2S;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tformat |= MAX98396_PCM_FORMAT_LJ;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tformat |= MAX98396_PCM_FORMAT_TDM_MODE1;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tformat |= MAX98396_PCM_FORMAT_TDM_MODE0;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"DAI format %d unsupported\\n\",\n\t\t\tfmt & SND_SOC_DAIFMT_FORMAT_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\tret = regmap_read(max98396->regmap, MAX98396_R210F_GLOBAL_EN, &status);\n\tif (ret < 0)\n\t\treturn -EINVAL;\n\n\tif (status) {\n\t\tret = regmap_read(max98396->regmap, MAX98396_R2041_PCM_MODE_CFG, &reg);\n\t\tif (ret < 0)\n\t\t\treturn -EINVAL;\n\t\tif (format != (reg & format_mask)) {\n\t\t\tupdate = true;\n\t\t} else {\n\t\t\tret = regmap_read(max98396->regmap,\n\t\t\t\t\t  MAX98396_R2042_PCM_CLK_SETUP, &reg);\n\t\t\tif (ret < 0)\n\t\t\t\treturn -EINVAL;\n\t\t\tif (bclk_pol != (reg & MAX98396_PCM_MODE_CFG_BCLKEDGE))\n\t\t\t\tupdate = true;\n\t\t}\n\t\t \n\t\tif (update)\n\t\t\tmax98396_global_enable_onoff(max98396->regmap, false);\n\t}\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2041_PCM_MODE_CFG,\n\t\t\t   format_mask, format);\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2042_PCM_CLK_SETUP,\n\t\t\t   MAX98396_PCM_MODE_CFG_BCLKEDGE,\n\t\t\t   bclk_pol);\n\n\tif (status && update)\n\t\tmax98396_global_enable_onoff(max98396->regmap, true);\n\n\treturn 0;\n}\n\n#define MAX98396_BSEL_32\t0x2\n#define MAX98396_BSEL_48\t0x3\n#define MAX98396_BSEL_64\t0x4\n#define MAX98396_BSEL_96\t0x5\n#define MAX98396_BSEL_128\t0x6\n#define MAX98396_BSEL_192\t0x7\n#define MAX98396_BSEL_256\t0x8\n#define MAX98396_BSEL_384\t0x9\n#define MAX98396_BSEL_512\t0xa\n#define MAX98396_BSEL_320\t0xb\n#define MAX98396_BSEL_250\t0xc\n#define MAX98396_BSEL_125\t0xd\n\n \nstatic const struct max98396_pcm_config {\n\tint in, out, width, bsel, max_sr;\n} max98396_pcm_configs[] = {\n\t{ .in = 2,  .out = 4,  .width = 16, .bsel = MAX98396_BSEL_32,  .max_sr = 192000 },\n\t{ .in = 2,  .out = 6,  .width = 24, .bsel = MAX98396_BSEL_48,  .max_sr = 192000 },\n\t{ .in = 2,  .out = 8,  .width = 32, .bsel = MAX98396_BSEL_64,  .max_sr = 192000 },\n\t{ .in = 3,  .out = 15, .width = 32, .bsel = MAX98396_BSEL_125, .max_sr = 192000 },\n\t{ .in = 4,  .out = 8,  .width = 16, .bsel = MAX98396_BSEL_64,  .max_sr = 192000 },\n\t{ .in = 4,  .out = 12, .width = 24, .bsel = MAX98396_BSEL_96,  .max_sr = 192000 },\n\t{ .in = 4,  .out = 16, .width = 32, .bsel = MAX98396_BSEL_128, .max_sr = 192000 },\n\t{ .in = 5,  .out = 15, .width = 24, .bsel = MAX98396_BSEL_125, .max_sr = 192000 },\n\t{ .in = 7,  .out = 15, .width = 16, .bsel = MAX98396_BSEL_125, .max_sr = 192000 },\n\t{ .in = 2,  .out = 4,  .width = 16, .bsel = MAX98396_BSEL_32,  .max_sr = 96000  },\n\t{ .in = 2,  .out = 6,  .width = 24, .bsel = MAX98396_BSEL_48,  .max_sr = 96000  },\n\t{ .in = 2,  .out = 8,  .width = 32, .bsel = MAX98396_BSEL_64,  .max_sr = 96000  },\n\t{ .in = 3,  .out = 15, .width = 32, .bsel = MAX98396_BSEL_125, .max_sr = 96000  },\n\t{ .in = 4,  .out = 8,  .width = 16, .bsel = MAX98396_BSEL_64,  .max_sr = 96000  },\n\t{ .in = 4,  .out = 12, .width = 24, .bsel = MAX98396_BSEL_96,  .max_sr = 96000  },\n\t{ .in = 4,  .out = 16, .width = 32, .bsel = MAX98396_BSEL_128, .max_sr = 96000  },\n\t{ .in = 5,  .out = 15, .width = 24, .bsel = MAX98396_BSEL_125, .max_sr = 96000  },\n\t{ .in = 7,  .out = 15, .width = 16, .bsel = MAX98396_BSEL_125, .max_sr = 96000  },\n\t{ .in = 7,  .out = 31, .width = 32, .bsel = MAX98396_BSEL_250, .max_sr = 96000  },\n\t{ .in = 8,  .out = 16, .width = 16, .bsel = MAX98396_BSEL_128, .max_sr = 96000  },\n\t{ .in = 8,  .out = 24, .width = 24, .bsel = MAX98396_BSEL_192, .max_sr = 96000  },\n\t{ .in = 8,  .out = 32, .width = 32, .bsel = MAX98396_BSEL_256, .max_sr = 96000  },\n\t{ .in = 10, .out = 31, .width = 24, .bsel = MAX98396_BSEL_250, .max_sr = 96000  },\n\t{ .in = 15, .out = 31, .width = 16, .bsel = MAX98396_BSEL_250, .max_sr = 96000  },\n\t{ .in = 16, .out = 32, .width = 16, .bsel = MAX98396_BSEL_256, .max_sr = 96000  },\n\t{ .in = 7,  .out = 31, .width = 32, .bsel = MAX98396_BSEL_250, .max_sr = 48000  },\n\t{ .in = 10, .out = 31, .width = 24, .bsel = MAX98396_BSEL_250, .max_sr = 48000  },\n\t{ .in = 10, .out = 40, .width = 32, .bsel = MAX98396_BSEL_320, .max_sr = 48000  },\n\t{ .in = 15, .out = 31, .width = 16, .bsel = MAX98396_BSEL_250, .max_sr = 48000  },\n\t{ .in = 16, .out = 48, .width = 24, .bsel = MAX98396_BSEL_384, .max_sr = 48000  },\n\t{ .in = 16, .out = 64, .width = 32, .bsel = MAX98396_BSEL_512, .max_sr = 48000  },\n};\n\nstatic int max98396_pcm_config_index(int in_slots, int out_slots, int width)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max98396_pcm_configs); i++) {\n\t\tconst struct max98396_pcm_config *c = &max98396_pcm_configs[i];\n\n\t\tif (in_slots == c->in && out_slots <= c->out && width == c->width)\n\t\t\treturn i;\n\t}\n\n\treturn -1;\n}\n\nstatic int max98396_dai_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_pcm_hw_params *params,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct max98396_priv *max98396 = snd_soc_component_get_drvdata(component);\n\tunsigned int sampling_rate = 0;\n\tunsigned int chan_sz = 0;\n\tint ret, reg, status, bsel = 0;\n\tbool update = false;\n\n\t \n\tswitch (snd_pcm_format_width(params_format(params))) {\n\tcase 16:\n\t\tchan_sz = MAX98396_PCM_MODE_CFG_CHANSZ_16;\n\t\tbreak;\n\tcase 24:\n\t\tchan_sz = MAX98396_PCM_MODE_CFG_CHANSZ_24;\n\t\tbreak;\n\tcase 32:\n\t\tchan_sz = MAX98396_PCM_MODE_CFG_CHANSZ_32;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"format unsupported %d\\n\",\n\t\t\tparams_format(params));\n\t\tgoto err;\n\t}\n\n\tdev_dbg(component->dev, \"format supported %d\",\n\t\tparams_format(params));\n\n\t \n\tswitch (params_rate(params)) {\n\tcase 8000:\n\t\tsampling_rate = MAX98396_PCM_SR_8000;\n\t\tbreak;\n\tcase 11025:\n\t\tsampling_rate = MAX98396_PCM_SR_11025;\n\t\tbreak;\n\tcase 12000:\n\t\tsampling_rate = MAX98396_PCM_SR_12000;\n\t\tbreak;\n\tcase 16000:\n\t\tsampling_rate = MAX98396_PCM_SR_16000;\n\t\tbreak;\n\tcase 22050:\n\t\tsampling_rate = MAX98396_PCM_SR_22050;\n\t\tbreak;\n\tcase 24000:\n\t\tsampling_rate = MAX98396_PCM_SR_24000;\n\t\tbreak;\n\tcase 32000:\n\t\tsampling_rate = MAX98396_PCM_SR_32000;\n\t\tbreak;\n\tcase 44100:\n\t\tsampling_rate = MAX98396_PCM_SR_44100;\n\t\tbreak;\n\tcase 48000:\n\t\tsampling_rate = MAX98396_PCM_SR_48000;\n\t\tbreak;\n\tcase 88200:\n\t\tsampling_rate = MAX98396_PCM_SR_88200;\n\t\tbreak;\n\tcase 96000:\n\t\tsampling_rate = MAX98396_PCM_SR_96000;\n\t\tbreak;\n\tcase 192000:\n\t\tsampling_rate = MAX98396_PCM_SR_192000;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"rate %d not supported\\n\",\n\t\t\tparams_rate(params));\n\t\tgoto err;\n\t}\n\n\tif (max98396->tdm_mode) {\n\t\tif (params_rate(params) > max98396->tdm_max_samplerate) {\n\t\t\tdev_err(component->dev, \"TDM sample rate %d too high\",\n\t\t\t\tparams_rate(params));\n\t\t\tgoto err;\n\t\t}\n\t} else {\n\t\t \n\t\tret = max98396_pcm_config_index(params_channels(params),\n\t\t\t\t\t\tparams_channels(params),\n\t\t\t\t\t\tsnd_pcm_format_width(params_format(params)));\n\t\tif (ret < 0) {\n\t\t\tdev_err(component->dev,\n\t\t\t\t\"no PCM config for %d channels, format %d\\n\",\n\t\t\t\tparams_channels(params), params_format(params));\n\t\t\tgoto err;\n\t\t}\n\n\t\tbsel = max98396_pcm_configs[ret].bsel;\n\n\t\tif (params_rate(params) > max98396_pcm_configs[ret].max_sr) {\n\t\t\tdev_err(component->dev, \"sample rate %d too high\",\n\t\t\t\tparams_rate(params));\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tret = regmap_read(max98396->regmap, MAX98396_R210F_GLOBAL_EN, &status);\n\tif (ret < 0)\n\t\tgoto err;\n\n\tif (status) {\n\t\tret = regmap_read(max98396->regmap, MAX98396_R2041_PCM_MODE_CFG, &reg);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\t\tif (chan_sz != (reg & MAX98396_PCM_MODE_CFG_CHANSZ_MASK)) {\n\t\t\tupdate = true;\n\t\t} else {\n\t\t\tret = regmap_read(max98396->regmap, MAX98396_R2043_PCM_SR_SETUP, &reg);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto err;\n\t\t\tif (sampling_rate != (reg & MAX98396_PCM_SR_MASK))\n\t\t\t\tupdate = true;\n\t\t}\n\n\t\t \n\t\tif (update)\n\t\t\tmax98396_global_enable_onoff(max98396->regmap, false);\n\t}\n\n\t \n\tregmap_update_bits(max98396->regmap, MAX98396_R2041_PCM_MODE_CFG,\n\t\t\t   MAX98396_PCM_MODE_CFG_CHANSZ_MASK, chan_sz);\n\n\t \n\tregmap_update_bits(max98396->regmap, MAX98396_R2043_PCM_SR_SETUP,\n\t\t\t   MAX98396_PCM_SR_MASK, sampling_rate);\n\n\t \n\tif (max98396->interleave_mode &&\n\t    sampling_rate > MAX98396_PCM_SR_16000)\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2043_PCM_SR_SETUP,\n\t\t\t\t   MAX98396_IVADC_SR_MASK,\n\t\t\t\t   (sampling_rate - 3)\n\t\t\t\t   << MAX98396_IVADC_SR_SHIFT);\n\telse\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2043_PCM_SR_SETUP,\n\t\t\t\t   MAX98396_IVADC_SR_MASK,\n\t\t\t\t   sampling_rate << MAX98396_IVADC_SR_SHIFT);\n\n\tif (bsel)\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\tMAX98396_R2042_PCM_CLK_SETUP,\n\t\t\t\tMAX98396_PCM_CLK_SETUP_BSEL_MASK,\n\t\t\t\tbsel);\n\n\tif (status && update)\n\t\tmax98396_global_enable_onoff(max98396->regmap, true);\n\n\treturn 0;\n\nerr:\n\treturn -EINVAL;\n}\n\nstatic int max98396_dai_tdm_slot(struct snd_soc_dai *dai,\n\t\t\t\t unsigned int tx_mask, unsigned int rx_mask,\n\t\t\t\t int slots, int slot_width)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct max98396_priv *max98396 =\n\t\tsnd_soc_component_get_drvdata(component);\n\tint bsel;\n\tunsigned int chan_sz = 0;\n\tint ret, status;\n\tint reg;\n\tbool update = false;\n\n\tif (!tx_mask && !rx_mask && !slots && !slot_width)\n\t\tmax98396->tdm_mode = false;\n\telse\n\t\tmax98396->tdm_mode = true;\n\n\t \n\tret = max98396_pcm_config_index(slots, slots, slot_width);\n\tif (ret < 0) {\n\t\tdev_err(component->dev, \"no TDM config for %d slots %d bits\\n\",\n\t\t\tslots, slot_width);\n\t\treturn -EINVAL;\n\t}\n\n\tbsel = max98396_pcm_configs[ret].bsel;\n\tmax98396->tdm_max_samplerate = max98396_pcm_configs[ret].max_sr;\n\n\t \n\tswitch (slot_width) {\n\tcase 16:\n\t\tchan_sz = MAX98396_PCM_MODE_CFG_CHANSZ_16;\n\t\tbreak;\n\tcase 24:\n\t\tchan_sz = MAX98396_PCM_MODE_CFG_CHANSZ_24;\n\t\tbreak;\n\tcase 32:\n\t\tchan_sz = MAX98396_PCM_MODE_CFG_CHANSZ_32;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"slot width %d unsupported\\n\",\n\t\t\tslot_width);\n\t\treturn -EINVAL;\n\t}\n\n\tret = regmap_read(max98396->regmap, MAX98396_R210F_GLOBAL_EN, &status);\n\tif (ret < 0)\n\t\treturn -EINVAL;\n\n\tif (status) {\n\t\tret = regmap_read(max98396->regmap, MAX98396_R2042_PCM_CLK_SETUP, &reg);\n\t\tif (ret < 0)\n\t\t\treturn -EINVAL;\n\t\tif (bsel != (reg & MAX98396_PCM_CLK_SETUP_BSEL_MASK)) {\n\t\t\tupdate = true;\n\t\t} else {\n\t\t\tret = regmap_read(max98396->regmap, MAX98396_R2041_PCM_MODE_CFG, &reg);\n\t\t\tif (ret < 0)\n\t\t\t\treturn -EINVAL;\n\t\t\tif (chan_sz != (reg & MAX98396_PCM_MODE_CFG_CHANSZ_MASK))\n\t\t\t\tupdate = true;\n\t\t}\n\n\t\t \n\t\tif (update)\n\t\t\tmax98396_global_enable_onoff(max98396->regmap, false);\n\t}\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2042_PCM_CLK_SETUP,\n\t\t\t   MAX98396_PCM_CLK_SETUP_BSEL_MASK,\n\t\t\t   bsel);\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2041_PCM_MODE_CFG,\n\t\t\t   MAX98396_PCM_MODE_CFG_CHANSZ_MASK, chan_sz);\n\n\t \n\tif (max98396->device_id == CODEC_TYPE_MAX98396) {\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2056_PCM_RX_SRC2,\n\t\t\t\t   MAX98396_PCM_DMIX_CH0_SRC_MASK,\n\t\t\t\t   rx_mask);\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2056_PCM_RX_SRC2,\n\t\t\t\t   MAX98396_PCM_DMIX_CH1_SRC_MASK,\n\t\t\t\t   rx_mask << MAX98396_PCM_DMIX_CH1_SHIFT);\n\t} else {\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98397_R2057_PCM_RX_SRC2,\n\t\t\t\t   MAX98396_PCM_DMIX_CH0_SRC_MASK,\n\t\t\t\t   rx_mask);\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98397_R2057_PCM_RX_SRC2,\n\t\t\t\t   MAX98396_PCM_DMIX_CH1_SRC_MASK,\n\t\t\t\t   rx_mask << MAX98396_PCM_DMIX_CH1_SHIFT);\n\t}\n\n\t \n\tif (max98396->device_id == CODEC_TYPE_MAX98396) {\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98396_R2053_PCM_TX_HIZ_CTRL_8,\n\t\t\t     ~tx_mask & 0xFF);\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98396_R2052_PCM_TX_HIZ_CTRL_7,\n\t\t\t     (~tx_mask & 0xFF00) >> 8);\n\t} else {\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98397_R2054_PCM_TX_HIZ_CTRL_8,\n\t\t\t     ~tx_mask & 0xFF);\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98397_R2053_PCM_TX_HIZ_CTRL_7,\n\t\t\t     (~tx_mask & 0xFF00) >> 8);\n\t}\n\n\tif (status && update)\n\t\tmax98396_global_enable_onoff(max98396->regmap, true);\n\n\treturn 0;\n}\n\n#define MAX98396_RATES SNDRV_PCM_RATE_8000_192000\n\n#define MAX98396_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | \\\n\tSNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_S32_LE)\n\nstatic const struct snd_soc_dai_ops max98396_dai_ops = {\n\t.set_fmt = max98396_dai_set_fmt,\n\t.hw_params = max98396_dai_hw_params,\n\t.set_tdm_slot = max98396_dai_tdm_slot,\n};\n\nstatic int max98396_dac_event(struct snd_soc_dapm_widget *w,\n\t\t\t      struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component =\n\t\tsnd_soc_dapm_to_component(w->dapm);\n\tstruct max98396_priv *max98396 =\n\t\tsnd_soc_component_get_drvdata(component);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tmax98396_global_enable_onoff(max98396->regmap, true);\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tmax98396_global_enable_onoff(max98396->regmap, false);\n\n\t\tmax98396->tdm_mode = false;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn 0;\n}\n\nstatic bool max98396_readable_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX98396_R2001_INT_RAW1 ... MAX98396_R2004_INT_RAW4:\n\tcase MAX98396_R2006_INT_STATE1 ... MAX98396_R2009_INT_STATE4:\n\tcase MAX98396_R200B_INT_FLAG1 ... MAX98396_R200E_INT_FLAG4:\n\tcase MAX98396_R2010_INT_EN1 ... MAX98396_R2013_INT_EN4:\n\tcase MAX98396_R2015_INT_FLAG_CLR1 ... MAX98396_R2018_INT_FLAG_CLR4:\n\tcase MAX98396_R201F_IRQ_CTRL ... MAX98396_R2024_THERM_FOLDBACK_SET:\n\tcase MAX98396_R2027_THERM_FOLDBACK_EN:\n\tcase MAX98396_R2030_NOISEGATE_MODE_CTRL:\n\tcase MAX98396_R2033_NOISEGATE_MODE_EN:\n\tcase MAX98396_R2038_CLK_MON_CTRL ... MAX98396_R2039_DATA_MON_CTRL:\n\tcase MAX98396_R203F_ENABLE_CTRLS ... MAX98396_R2053_PCM_TX_HIZ_CTRL_8:\n\tcase MAX98396_R2055_PCM_RX_SRC1 ... MAX98396_R2056_PCM_RX_SRC2:\n\tcase MAX98396_R2058_PCM_BYPASS_SRC:\n\tcase MAX98396_R205D_PCM_TX_SRC_EN ... MAX98396_R205F_PCM_TX_EN:\n\tcase MAX98396_R2070_ICC_RX_EN_A... MAX98396_R2072_ICC_TX_CTRL:\n\tcase MAX98396_R207F_ICC_EN:\n\tcase MAX98396_R2083_TONE_GEN_DC_CFG ... MAX98396_R2086_TONE_GEN_DC_LVL3:\n\tcase MAX98396_R208F_TONE_GEN_EN ... MAX98396_R209A_SPK_EDGE_CTRL:\n\tcase MAX98396_R209C_SPK_EDGE_CTRL1 ... MAX98396_R20A0_AMP_SUPPLY_CTL:\n\tcase MAX98396_R20AF_AMP_EN ... MAX98396_R20BF_ADC_LO_VBAT_READBACK_LSB:\n\tcase MAX98396_R20C7_ADC_CFG:\n\tcase MAX98396_R20D0_DHT_CFG1 ... MAX98396_R20D6_DHT_HYSTERESIS_CFG:\n\tcase MAX98396_R20DF_DHT_EN:\n\tcase MAX98396_R20E0_IV_SENSE_PATH_CFG:\n\tcase MAX98396_R20E4_IV_SENSE_PATH_EN\n\t\t... MAX98396_R2106_BPE_THRESH_HYSTERESIS:\n\tcase MAX98396_R2108_BPE_SUPPLY_SRC ... MAX98396_R210B_BPE_LOW_LIMITER:\n\tcase MAX98396_R210D_BPE_EN ... MAX98396_R210F_GLOBAL_EN:\n\tcase MAX98396_R21FF_REVISION_ID:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n};\n\nstatic bool max98396_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX98396_R2000_SW_RESET:\n\tcase MAX98396_R2001_INT_RAW1 ... MAX98396_R200E_INT_FLAG4:\n\tcase MAX98396_R2041_PCM_MODE_CFG:\n\tcase MAX98396_R20B6_ADC_PVDD_READBACK_MSB\n\t\t... MAX98396_R20BF_ADC_LO_VBAT_READBACK_LSB:\n\tcase MAX98396_R20E5_BPE_STATE:\n\tcase MAX98396_R2109_BPE_LOW_STATE\n\t\t... MAX98396_R210B_BPE_LOW_LIMITER:\n\tcase MAX98396_R210F_GLOBAL_EN:\n\tcase MAX98396_R21FF_REVISION_ID:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool max98397_readable_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX98396_R2001_INT_RAW1 ... MAX98396_R2004_INT_RAW4:\n\tcase MAX98396_R2006_INT_STATE1 ... MAX98396_R2009_INT_STATE4:\n\tcase MAX98396_R200B_INT_FLAG1 ... MAX98396_R200E_INT_FLAG4:\n\tcase MAX98396_R2010_INT_EN1 ... MAX98396_R2013_INT_EN4:\n\tcase MAX98396_R2015_INT_FLAG_CLR1 ... MAX98396_R2018_INT_FLAG_CLR4:\n\tcase MAX98396_R201F_IRQ_CTRL ... MAX98396_R2024_THERM_FOLDBACK_SET:\n\tcase MAX98396_R2027_THERM_FOLDBACK_EN:\n\tcase MAX98396_R2030_NOISEGATE_MODE_CTRL:\n\tcase MAX98396_R2033_NOISEGATE_MODE_EN:\n\tcase MAX98396_R2038_CLK_MON_CTRL ... MAX98397_R203A_SPK_MON_THRESH:\n\tcase MAX98396_R203F_ENABLE_CTRLS ... MAX98397_R2054_PCM_TX_HIZ_CTRL_8:\n\tcase MAX98397_R2056_PCM_RX_SRC1... MAX98396_R2058_PCM_BYPASS_SRC:\n\tcase MAX98396_R205D_PCM_TX_SRC_EN ... MAX98397_R2060_PCM_TX_SUPPLY_SEL:\n\tcase MAX98396_R2070_ICC_RX_EN_A... MAX98396_R2072_ICC_TX_CTRL:\n\tcase MAX98396_R207F_ICC_EN:\n\tcase MAX98396_R2083_TONE_GEN_DC_CFG ... MAX98396_R2086_TONE_GEN_DC_LVL3:\n\tcase MAX98396_R208F_TONE_GEN_EN ... MAX98396_R209F_BYPASS_PATH_CFG:\n\tcase MAX98396_R20AF_AMP_EN ... MAX98397_R20C5_MEAS_ADC_OPTIMAL_MODE:\n\tcase MAX98396_R20C7_ADC_CFG:\n\tcase MAX98396_R20D0_DHT_CFG1 ... MAX98396_R20D6_DHT_HYSTERESIS_CFG:\n\tcase MAX98396_R20DF_DHT_EN:\n\tcase MAX98396_R20E0_IV_SENSE_PATH_CFG:\n\tcase MAX98396_R20E4_IV_SENSE_PATH_EN\n\t\t... MAX98396_R2106_BPE_THRESH_HYSTERESIS:\n\tcase MAX98396_R2108_BPE_SUPPLY_SRC ... MAX98396_R210B_BPE_LOW_LIMITER:\n\tcase MAX98396_R210D_BPE_EN ... MAX98396_R210F_GLOBAL_EN:\n\tcase MAX98397_R22FF_REVISION_ID:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n};\n\nstatic bool max98397_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX98396_R2001_INT_RAW1 ... MAX98396_R200E_INT_FLAG4:\n\tcase MAX98396_R2041_PCM_MODE_CFG:\n\tcase MAX98397_R20B7_ADC_PVDD_READBACK_MSB\n\t\t... MAX98397_R20C4_ADC_LO_VDDH_READBACK_LSB:\n\tcase MAX98396_R20E5_BPE_STATE:\n\tcase MAX98396_R2109_BPE_LOW_STATE\n\t\t... MAX98396_R210B_BPE_LOW_LIMITER:\n\tcase MAX98396_R210F_GLOBAL_EN:\n\tcase MAX98397_R22FF_REVISION_ID:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const char * const max98396_op_mod_text[] = {\n\t\"DG\", \"PVDD\", \"VBAT\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_op_mod_enum,\n\t\t\t    MAX98396_R2098_SPK_CLS_DG_MODE,\n\t\t\t    0, max98396_op_mod_text);\n\nstatic DECLARE_TLV_DB_SCALE(max98396_digital_tlv, -6350, 50, 1);\nstatic const DECLARE_TLV_DB_RANGE(max98396_spk_tlv,\n\t0, 0x11, TLV_DB_SCALE_ITEM(400, 100, 0),\n);\nstatic DECLARE_TLV_DB_RANGE(max98397_digital_tlv,\n\t0, 0x4A, TLV_DB_SCALE_ITEM(TLV_DB_GAIN_MUTE, 0, 1),\n\t0x4B, 0xFF, TLV_DB_SCALE_ITEM(-9000, 50, 0),\n);\nstatic const DECLARE_TLV_DB_RANGE(max98397_spk_tlv,\n\t0, 0x15, TLV_DB_SCALE_ITEM(600, 100, 0),\n);\n\nstatic int max98396_mux_get(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component =\n\t\tsnd_soc_dapm_kcontrol_component(kcontrol);\n\tstruct max98396_priv *max98396 = snd_soc_component_get_drvdata(component);\n\tint reg, val;\n\n\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\treg = MAX98396_R2055_PCM_RX_SRC1;\n\telse\n\t\treg = MAX98397_R2056_PCM_RX_SRC1;\n\n\tregmap_read(max98396->regmap, reg, &val);\n\n\tucontrol->value.enumerated.item[0] = val;\n\n\treturn 0;\n}\n\nstatic int max98396_mux_put(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component =\n\t\tsnd_soc_dapm_kcontrol_component(kcontrol);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_dapm_kcontrol_dapm(kcontrol);\n\tstruct max98396_priv *max98396 = snd_soc_component_get_drvdata(component);\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tunsigned int *item = ucontrol->value.enumerated.item;\n\tint reg, val;\n\tint change;\n\n\tif (item[0] >= e->items)\n\t\treturn -EINVAL;\n\n\tval = snd_soc_enum_item_to_val(e, item[0]) << e->shift_l;\n\n\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\treg = MAX98396_R2055_PCM_RX_SRC1;\n\telse\n\t\treg = MAX98397_R2056_PCM_RX_SRC1;\n\n\tchange = snd_soc_component_test_bits(component, reg,\n\t\t\t\t\t     MAX98396_PCM_RX_MASK, val);\n\n\tif (change)\n\t\tregmap_update_bits(max98396->regmap, reg,\n\t\t\t\t   MAX98396_PCM_RX_MASK, val);\n\n\tsnd_soc_dapm_mux_update_power(dapm, kcontrol, item[0], e, NULL);\n\n\treturn change;\n}\n\nstatic const char * const max98396_switch_text[] = {\n\t\"Left\", \"Right\", \"LeftRight\"};\n\nstatic SOC_ENUM_SINGLE_DECL(dai_sel_enum, SND_SOC_NOPM, 0,\n\t\t\t    max98396_switch_text);\n\nstatic const struct snd_kcontrol_new max98396_dai_mux =\n\tSOC_DAPM_ENUM_EXT(\"DAI Sel Mux\", dai_sel_enum,\n\t\t\t  max98396_mux_get, max98396_mux_put);\n\nstatic const struct snd_kcontrol_new max98396_vi_control =\n\tSOC_DAPM_SINGLE(\"Switch\", MAX98396_R205F_PCM_TX_EN, 0, 1, 0);\n\nstatic const struct snd_soc_dapm_widget max98396_dapm_widgets[] = {\n\tSND_SOC_DAPM_DAC_E(\"Amp Enable\", \"HiFi Playback\",\n\t\t\t   MAX98396_R20AF_AMP_EN, 0, 0, max98396_dac_event,\n\t\t\t   SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_MUX(\"DAI Sel Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t &max98396_dai_mux),\n\tSND_SOC_DAPM_OUTPUT(\"BE_OUT\"),\n\tSND_SOC_DAPM_AIF_OUT(\"Voltage Sense\", \"HiFi Capture\", 0,\n\t\t\t     MAX98396_R20E4_IV_SENSE_PATH_EN, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"Current Sense\", \"HiFi Capture\", 0,\n\t\t\t     MAX98396_R20E4_IV_SENSE_PATH_EN, 1, 0),\n\tSND_SOC_DAPM_SWITCH(\"VI Sense\", SND_SOC_NOPM, 0, 0,\n\t\t\t    &max98396_vi_control),\n\tSND_SOC_DAPM_SIGGEN(\"VMON\"),\n\tSND_SOC_DAPM_SIGGEN(\"IMON\"),\n\tSND_SOC_DAPM_SIGGEN(\"FBMON\"),\n};\n\nstatic const char * const max98396_thermal_thresh_text[] = {\n\t\"50C\", \"51C\", \"52C\", \"53C\", \"54C\", \"55C\", \"56C\", \"57C\",\n\t\"58C\", \"59C\", \"60C\", \"61C\", \"62C\", \"63C\", \"64C\", \"65C\",\n\t\"66C\", \"67C\", \"68C\", \"69C\", \"70C\", \"71C\", \"72C\", \"73C\",\n\t\"74C\", \"75C\", \"76C\", \"77C\", \"78C\", \"79C\", \"80C\", \"81C\",\n\t\"82C\", \"83C\", \"84C\", \"85C\", \"86C\", \"87C\", \"88C\", \"89C\",\n\t\"90C\", \"91C\", \"92C\", \"93C\", \"94C\", \"95C\", \"96C\", \"97C\",\n\t\"98C\", \"99C\", \"100C\", \"101C\", \"102C\", \"103C\", \"104C\", \"105C\",\n\t\"106C\", \"107C\", \"108C\", \"109C\", \"110C\", \"111C\", \"112C\", \"113C\",\n\t\"114C\", \"115C\", \"116C\", \"117C\", \"118C\", \"119C\", \"120C\", \"121C\",\n\t\"122C\", \"123C\", \"124C\", \"125C\", \"126C\", \"127C\", \"128C\", \"129C\",\n\t\"130C\", \"131C\", \"132C\", \"133C\", \"134C\", \"135C\", \"136C\", \"137C\",\n\t\"138C\", \"139C\", \"140C\", \"141C\", \"142C\", \"143C\", \"144C\", \"145C\",\n\t\"146C\", \"147C\", \"148C\", \"149C\", \"150C\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_warn_thresh1_enum,\n\t\t\t    MAX98396_R2020_THERM_WARN_THRESH, 0,\n\t\t\t    max98396_thermal_thresh_text);\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_warn_thresh2_enum,\n\t\t\t    MAX98396_R2021_THERM_WARN_THRESH2, 0,\n\t\t\t    max98396_thermal_thresh_text);\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_shdn_thresh_enum,\n\t\t\t    MAX98396_R2022_THERM_SHDN_THRESH, 0,\n\t\t\t    max98396_thermal_thresh_text);\n\nstatic const char * const max98396_thermal_hyteresis_text[] = {\n\t\"2C\", \"5C\", \"7C\", \"10C\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_hysteresis_enum,\n\t\t\t    MAX98396_R2023_THERM_HYSTERESIS, 0,\n\t\t\t    max98396_thermal_hyteresis_text);\n\nstatic const char * const max98396_foldback_slope_text[] = {\n\t\"0.25\", \"0.5\", \"1.0\", \"2.0\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_fb_slope1_enum,\n\t\t\t    MAX98396_R2024_THERM_FOLDBACK_SET,\n\t\t\t    MAX98396_THERM_FB_SLOPE1_SHIFT,\n\t\t\t    max98396_foldback_slope_text);\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_fb_slope2_enum,\n\t\t\t    MAX98396_R2024_THERM_FOLDBACK_SET,\n\t\t\t    MAX98396_THERM_FB_SLOPE2_SHIFT,\n\t\t\t    max98396_foldback_slope_text);\n\nstatic const char * const max98396_foldback_reltime_text[] = {\n\t\"3ms\", \"10ms\", \"100ms\", \"300ms\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_fb_reltime_enum,\n\t\t\t    MAX98396_R2024_THERM_FOLDBACK_SET,\n\t\t\t    MAX98396_THERM_FB_REL_SHIFT,\n\t\t\t    max98396_foldback_reltime_text);\n\nstatic const char * const max98396_foldback_holdtime_text[] = {\n\t\"0ms\", \"20ms\", \"40ms\", \"80ms\"\n};\n\nstatic SOC_ENUM_SINGLE_DECL(max98396_thermal_fb_holdtime_enum,\n\t\t\t    MAX98396_R2024_THERM_FOLDBACK_SET,\n\t\t\t    MAX98396_THERM_FB_HOLD_SHIFT,\n\t\t\t    max98396_foldback_holdtime_text);\n\nstatic int max98396_adc_value_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct max98396_priv *max98396 = snd_soc_component_get_drvdata(component);\n\tint ret;\n\tu8 val[2];\n\tint reg = mc->reg;\n\n\t \n\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF)\n\t\tgoto exit;\n\n\tif (max98396->device_id == CODEC_TYPE_MAX98397) {\n\t\tswitch (mc->reg) {\n\t\tcase MAX98396_R20B6_ADC_PVDD_READBACK_MSB:\n\t\t\treg = MAX98397_R20B7_ADC_PVDD_READBACK_MSB;\n\t\t\tbreak;\n\t\tcase MAX98396_R20B8_ADC_VBAT_READBACK_MSB:\n\t\t\treg = MAX98397_R20B9_ADC_VBAT_READBACK_MSB;\n\t\t\tbreak;\n\t\tcase MAX98396_R20BA_ADC_TEMP_READBACK_MSB:\n\t\t\treg = MAX98397_R20BB_ADC_TEMP_READBACK_MSB;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoto exit;\n\t\t}\n\t}\n\n\tret = regmap_raw_read(max98396->regmap, reg, &val, 2);\n\tif (ret)\n\t\tgoto exit;\n\n\t \n\tucontrol->value.integer.value[0] = (val[0] << 1) | (val[1] & 1);\n\treturn 0;\n\nexit:\n\tucontrol->value.integer.value[0] = 0;\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new max98396_snd_controls[] = {\n\t \n\tSOC_SINGLE_TLV(\"Digital Volume\", MAX98396_R2090_AMP_VOL_CTRL,\n\t\t       0, 0x7F, 1, max98396_digital_tlv),\n\tSOC_SINGLE_TLV(\"Speaker Volume\", MAX98396_R2091_AMP_PATH_GAIN,\n\t\t       0, 0x11, 0, max98396_spk_tlv),\n\t \n\tSOC_SINGLE(\"Ramp Up Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_VOL_RMPUP_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Ramp Down Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_VOL_RMPDN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"CLK Monitor Switch\", MAX98396_R203F_ENABLE_CTRLS,\n\t\t   MAX98396_CTRL_CMON_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"Dither Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_DITH_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"IV Dither Switch\", MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t   MAX98396_IV_SENSE_DITH_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"DC Blocker Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_DCBLK_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"IV DC Blocker Switch\", MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t   MAX98396_IV_SENSE_DCBLK_EN_SHIFT, 3, 0),\n\t \n\tSOC_SINGLE(\"Safe Mode Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_SAFE_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"WB Filter Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_WB_FLT_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"IV WB Filter Switch\", MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t   MAX98396_IV_SENSE_WB_FLT_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"DHT Switch\", MAX98396_R20DF_DHT_EN, 0, 1, 0),\n\t \n\tSOC_SINGLE(\"BPE Switch\", MAX98396_R210D_BPE_EN, 0, 1, 0),\n\tSOC_SINGLE(\"BPE Limiter Switch\", MAX98396_R210D_BPE_EN, 1, 1, 0),\n\t \n\tSOC_SINGLE(\"Bypass Path Switch\",\n\t\t   MAX98396_R205E_PCM_RX_EN, 1, 1, 0),\n\t \n\tSOC_ENUM(\"OP Mode\", max98396_op_mod_enum),\n\t \n\tSOC_SINGLE(\"CMON Auto Restart Switch\", MAX98396_R2038_CLK_MON_CTRL,\n\t\t   MAX98396_CLK_MON_AUTO_RESTART_SHIFT, 1, 0),\n\tSOC_SINGLE(\"PVDD Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_PVDD_UVLO_RESTART_SHFT, 1, 0),\n\tSOC_SINGLE(\"VBAT Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_VBAT_UVLO_RESTART_SHFT, 1, 0),\n\tSOC_SINGLE(\"THERM Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_THEM_SHDN_RESTART_SHFT, 1, 0),\n\tSOC_SINGLE(\"OVC Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_OVC_RESTART_SHFT, 1, 0),\n\t \n\tSOC_ENUM(\"THERM Thresh1\", max98396_thermal_warn_thresh1_enum),\n\tSOC_ENUM(\"THERM Thresh2\", max98396_thermal_warn_thresh2_enum),\n\tSOC_ENUM(\"THERM SHDN Thresh\", max98396_thermal_shdn_thresh_enum),\n\tSOC_ENUM(\"THERM Hysteresis\", max98396_thermal_hysteresis_enum),\n\tSOC_SINGLE(\"THERM Foldback Switch\",\n\t\t   MAX98396_R2027_THERM_FOLDBACK_EN, 0, 1, 0),\n\tSOC_ENUM(\"THERM Slope1\", max98396_thermal_fb_slope1_enum),\n\tSOC_ENUM(\"THERM Slope2\", max98396_thermal_fb_slope2_enum),\n\tSOC_ENUM(\"THERM Release\", max98396_thermal_fb_reltime_enum),\n\tSOC_ENUM(\"THERM Hold\", max98396_thermal_fb_holdtime_enum),\n\t \n\tSOC_SINGLE_EXT(\"ADC PVDD\", MAX98396_R20B6_ADC_PVDD_READBACK_MSB, 0, 0x1FF, 0,\n\t\t       max98396_adc_value_get, NULL),\n\tSOC_SINGLE_EXT(\"ADC VBAT\", MAX98396_R20B8_ADC_VBAT_READBACK_MSB, 0, 0x1FF, 0,\n\t\t       max98396_adc_value_get, NULL),\n\tSOC_SINGLE_EXT(\"ADC TEMP\", MAX98396_R20BA_ADC_TEMP_READBACK_MSB, 0, 0x1FF, 0,\n\t\t       max98396_adc_value_get, NULL),\n};\n\nstatic const struct snd_kcontrol_new max98397_snd_controls[] = {\n\t \n\tSOC_SINGLE_TLV(\"Digital Volume\", MAX98396_R2090_AMP_VOL_CTRL,\n\t\t       0, 0xFF, 1, max98397_digital_tlv),\n\tSOC_SINGLE_TLV(\"Speaker Volume\", MAX98396_R2091_AMP_PATH_GAIN,\n\t\t       0, 0x15, 0, max98397_spk_tlv),\n\t \n\tSOC_SINGLE(\"Ramp Up Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_VOL_RMPUP_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Ramp Down Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_VOL_RMPDN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"CLK Monitor Switch\", MAX98396_R203F_ENABLE_CTRLS,\n\t\t   MAX98396_CTRL_CMON_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"Dither Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_DITH_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"IV Dither Switch\", MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t   MAX98396_IV_SENSE_DITH_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"DC Blocker Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_DCBLK_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"IV DC Blocker Switch\", MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t   MAX98396_IV_SENSE_DCBLK_EN_SHIFT, 3, 0),\n\t \n\tSOC_SINGLE(\"Safe Mode Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_SAFE_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"WB Filter Switch\", MAX98396_R2092_AMP_DSP_CFG,\n\t\t   MAX98396_DSP_SPK_WB_FLT_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"IV WB Filter Switch\", MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t   MAX98396_IV_SENSE_WB_FLT_EN_SHIFT, 1, 0),\n\t \n\tSOC_SINGLE(\"DHT Switch\", MAX98396_R20DF_DHT_EN, 0, 1, 0),\n\t \n\tSOC_SINGLE(\"BPE Switch\", MAX98396_R210D_BPE_EN, 0, 1, 0),\n\tSOC_SINGLE(\"BPE Limiter Switch\", MAX98396_R210D_BPE_EN, 1, 1, 0),\n\t \n\tSOC_SINGLE(\"Bypass Path Switch\",\n\t\t   MAX98396_R205E_PCM_RX_EN, 1, 1, 0),\n\t \n\tSOC_ENUM(\"OP Mode\", max98396_op_mod_enum),\n\t \n\tSOC_SINGLE(\"CMON Auto Restart Switch\", MAX98396_R2038_CLK_MON_CTRL,\n\t\t   MAX98396_CLK_MON_AUTO_RESTART_SHIFT, 1, 0),\n\tSOC_SINGLE(\"PVDD Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_PVDD_UVLO_RESTART_SHFT, 1, 0),\n\tSOC_SINGLE(\"VBAT Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_VBAT_UVLO_RESTART_SHFT, 1, 0),\n\tSOC_SINGLE(\"THERM Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_THEM_SHDN_RESTART_SHFT, 1, 0),\n\tSOC_SINGLE(\"OVC Auto Restart Switch\", MAX98396_R210E_AUTO_RESTART,\n\t\t   MAX98396_OVC_RESTART_SHFT, 1, 0),\n\t \n\tSOC_ENUM(\"THERM Thresh1\", max98396_thermal_warn_thresh1_enum),\n\tSOC_ENUM(\"THERM Thresh2\", max98396_thermal_warn_thresh2_enum),\n\tSOC_ENUM(\"THERM SHDN Thresh\", max98396_thermal_shdn_thresh_enum),\n\tSOC_ENUM(\"THERM Hysteresis\", max98396_thermal_hysteresis_enum),\n\tSOC_SINGLE(\"THERM Foldback Switch\",\n\t\t   MAX98396_R2027_THERM_FOLDBACK_EN, 0, 1, 0),\n\tSOC_ENUM(\"THERM Slope1\", max98396_thermal_fb_slope1_enum),\n\tSOC_ENUM(\"THERM Slope2\", max98396_thermal_fb_slope2_enum),\n\tSOC_ENUM(\"THERM Release\", max98396_thermal_fb_reltime_enum),\n\tSOC_ENUM(\"THERM Hold\", max98396_thermal_fb_holdtime_enum),\n\t \n\tSOC_SINGLE_EXT(\"ADC PVDD\", MAX98396_R20B6_ADC_PVDD_READBACK_MSB, 0, 0x1FF, 0,\n\t\t       max98396_adc_value_get, NULL),\n\tSOC_SINGLE_EXT(\"ADC VBAT\", MAX98396_R20B8_ADC_VBAT_READBACK_MSB, 0, 0x1FF, 0,\n\t\t       max98396_adc_value_get, NULL),\n\tSOC_SINGLE_EXT(\"ADC TEMP\", MAX98396_R20BA_ADC_TEMP_READBACK_MSB, 0, 0x1FF, 0,\n\t\t       max98396_adc_value_get, NULL),\n};\n\nstatic const struct snd_soc_dapm_route max98396_audio_map[] = {\n\t \n\t{\"DAI Sel Mux\", \"Left\", \"Amp Enable\"},\n\t{\"DAI Sel Mux\", \"Right\", \"Amp Enable\"},\n\t{\"DAI Sel Mux\", \"LeftRight\", \"Amp Enable\"},\n\t{\"BE_OUT\", NULL, \"DAI Sel Mux\"},\n\t \n\t{ \"VI Sense\", \"Switch\", \"VMON\" },\n\t{ \"VI Sense\", \"Switch\", \"IMON\" },\n\t{ \"Voltage Sense\", NULL, \"VI Sense\" },\n\t{ \"Current Sense\", NULL, \"VI Sense\" },\n};\n\nstatic struct snd_soc_dai_driver max98396_dai[] = {\n\t{\n\t\t.name = \"max98396-aif1\",\n\t\t.playback = {\n\t\t\t.stream_name = \"HiFi Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MAX98396_RATES,\n\t\t\t.formats = MAX98396_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"HiFi Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MAX98396_RATES,\n\t\t\t.formats = MAX98396_FORMATS,\n\t\t},\n\t\t.ops = &max98396_dai_ops,\n\t}\n};\n\nstatic struct snd_soc_dai_driver max98397_dai[] = {\n\t{\n\t\t.name = \"max98397-aif1\",\n\t\t.playback = {\n\t\t\t.stream_name = \"HiFi Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MAX98396_RATES,\n\t\t\t.formats = MAX98396_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"HiFi Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MAX98396_RATES,\n\t\t\t.formats = MAX98396_FORMATS,\n\t\t},\n\t\t.ops = &max98396_dai_ops,\n\t}\n};\n\nstatic void max98396_reset(struct max98396_priv *max98396, struct device *dev)\n{\n\tint ret, reg, count;\n\n\t \n\tret = regmap_write(max98396->regmap,\n\t\t\t   MAX98396_R2000_SW_RESET, 1);\n\tif (ret)\n\t\tdev_err(dev, \"Reset command failed. (ret:%d)\\n\", ret);\n\n\tcount = 0;\n\twhile (count < 3) {\n\t\tusleep_range(5000, 6000);\n\t\t \n\t\tret = regmap_read(max98396->regmap,\n\t\t\t\t  GET_REG_ADDR_REV_ID(max98396->device_id), &reg);\n\t\tif (!ret) {\n\t\t\tdev_info(dev, \"Reset completed (retry:%d)\\n\", count);\n\t\t\treturn;\n\t\t}\n\t\tcount++;\n\t}\n\tdev_err(dev, \"Reset failed. (ret:%d)\\n\", ret);\n}\n\nstatic int max98396_probe(struct snd_soc_component *component)\n{\n\tstruct max98396_priv *max98396 =\n\t\tsnd_soc_component_get_drvdata(component);\n\n\t \n\tmax98396_reset(max98396, component->dev);\n\n\t \n\tif (max98396->device_id == CODEC_TYPE_MAX98396) {\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98396_R2055_PCM_RX_SRC1, 0x02);\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98396_R2056_PCM_RX_SRC2, 0x10);\n\t} else {\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98397_R2056_PCM_RX_SRC1, 0x02);\n\t\tregmap_write(max98396->regmap,\n\t\t\t     MAX98397_R2057_PCM_RX_SRC2, 0x10);\n\t}\n\t \n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R20A0_AMP_SUPPLY_CTL,\n\t\t\t   MAX98396_AMP_SUPPLY_NOVBAT,\n\t\t\t   (max98396->vbat == NULL) ?\n\t\t\t\tMAX98396_AMP_SUPPLY_NOVBAT : 0);\n\t \n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2092_AMP_DSP_CFG, 1, 1);\n\t \n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R20E0_IV_SENSE_PATH_CFG,\n\t\t\t   MAX98396_IV_SENSE_DCBLK_EN_MASK,\n\t\t\t   MAX98396_IV_SENSE_DCBLK_EN_MASK);\n\t \n\tregmap_write(max98396->regmap,\n\t\t     MAX98396_R205D_PCM_TX_SRC_EN, 3);\n\t \n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2092_AMP_DSP_CFG, 0x40, 0x40);\n\t \n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R20E0_IV_SENSE_PATH_CFG, 8, 8);\n\n\t \n\tregmap_write(max98396->regmap,\n\t\t     MAX98396_R2058_PCM_BYPASS_SRC,\n\t\t     max98396->bypass_slot);\n\t \n\tregmap_write(max98396->regmap,\n\t\t     MAX98396_R2044_PCM_TX_CTRL_1,\n\t\t     max98396->v_slot);\n\tregmap_write(max98396->regmap,\n\t\t     MAX98396_R2045_PCM_TX_CTRL_2,\n\t\t     max98396->i_slot);\n\tregmap_write(max98396->regmap,\n\t\t     MAX98396_R204A_PCM_TX_CTRL_7,\n\t\t     max98396->spkfb_slot);\n\n\tif (max98396->v_slot < 8)\n\t\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98396_R2053_PCM_TX_HIZ_CTRL_8,\n\t\t\t\t\t   1 << max98396->v_slot, 0);\n\t\telse\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98397_R2054_PCM_TX_HIZ_CTRL_8,\n\t\t\t\t\t   1 << max98396->v_slot, 0);\n\telse\n\t\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98396_R2052_PCM_TX_HIZ_CTRL_7,\n\t\t\t\t\t   1 << (max98396->v_slot - 8), 0);\n\t\telse\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98397_R2053_PCM_TX_HIZ_CTRL_7,\n\t\t\t\t\t   1 << (max98396->v_slot - 8), 0);\n\n\tif (max98396->i_slot < 8)\n\t\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98396_R2053_PCM_TX_HIZ_CTRL_8,\n\t\t\t\t\t   1 << max98396->i_slot, 0);\n\t\telse\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98397_R2054_PCM_TX_HIZ_CTRL_8,\n\t\t\t\t\t   1 << max98396->i_slot, 0);\n\telse\n\t\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98396_R2052_PCM_TX_HIZ_CTRL_7,\n\t\t\t\t\t   1 << (max98396->i_slot - 8), 0);\n\t\telse\n\t\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t\t   MAX98397_R2053_PCM_TX_HIZ_CTRL_7,\n\t\t\t\t\t   1 << (max98396->i_slot - 8), 0);\n\n\t \n\tif (max98396->interleave_mode)\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2041_PCM_MODE_CFG,\n\t\t\t\t   MAX98396_PCM_TX_CH_INTERLEAVE_MASK,\n\t\t\t\t   MAX98396_PCM_TX_CH_INTERLEAVE_MASK);\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R2038_CLK_MON_CTRL,\n\t\t\t   MAX98396_CLK_MON_AUTO_RESTART_MASK,\n\t\t\t   MAX98396_CLK_MON_AUTO_RESTART_MASK);\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R203F_ENABLE_CTRLS,\n\t\t\t   MAX98396_CTRL_DMON_STUCK_EN_MASK,\n\t\t\t   max98396->dmon_stuck_enable ?\n\t\t\t\tMAX98396_CTRL_DMON_STUCK_EN_MASK : 0);\n\n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R203F_ENABLE_CTRLS,\n\t\t\t   MAX98396_CTRL_DMON_MAG_EN_MASK,\n\t\t\t   max98396->dmon_mag_enable ?\n\t\t\t\tMAX98396_CTRL_DMON_MAG_EN_MASK : 0);\n\n\tswitch (max98396->dmon_duration) {\n\tcase 64:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_DURATION_MASK, 0);\n\t\tbreak;\n\tcase 256:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_DURATION_MASK, 1);\n\t\tbreak;\n\tcase 1024:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_DURATION_MASK, 2);\n\t\tbreak;\n\tcase 4096:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_DURATION_MASK, 3);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"Invalid DMON duration %d\\n\",\n\t\t\tmax98396->dmon_duration);\n\t}\n\n\tswitch (max98396->dmon_stuck_threshold) {\n\tcase 15:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_STUCK_THRESH_MASK,\n\t\t\t\t   0 << MAX98396_DMON_STUCK_THRESH_SHIFT);\n\t\tbreak;\n\tcase 13:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_STUCK_THRESH_MASK,\n\t\t\t\t   1 << MAX98396_DMON_STUCK_THRESH_SHIFT);\n\t\tbreak;\n\tcase 22:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_STUCK_THRESH_MASK,\n\t\t\t\t   2 << MAX98396_DMON_STUCK_THRESH_SHIFT);\n\t\tbreak;\n\tcase 9:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_STUCK_THRESH_MASK,\n\t\t\t\t   3 << MAX98396_DMON_STUCK_THRESH_SHIFT);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"Invalid DMON stuck threshold %d\\n\",\n\t\t\tmax98396->dmon_stuck_threshold);\n\t}\n\n\tswitch (max98396->dmon_mag_threshold) {\n\tcase 2 ... 5:\n\t\tregmap_update_bits(max98396->regmap,\n\t\t\t\t   MAX98396_R2039_DATA_MON_CTRL,\n\t\t\t\t   MAX98396_DMON_STUCK_THRESH_MASK,\n\t\t\t\t   (5 - max98396->dmon_mag_threshold)\n\t\t\t\t\t<< MAX98396_DMON_MAG_THRESH_SHIFT);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"Invalid DMON magnitude threshold %d\\n\",\n\t\t\tmax98396->dmon_mag_threshold);\n\t}\n\n\t \n\tregmap_update_bits(max98396->regmap,\n\t\t\t   MAX98396_R205E_PCM_RX_EN,\n\t\t\t   MAX98396_PCM_RX_EN_MASK, 1);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int max98396_suspend(struct device *dev)\n{\n\tstruct max98396_priv *max98396 = dev_get_drvdata(dev);\n\n\tregcache_cache_only(max98396->regmap, true);\n\tregcache_mark_dirty(max98396->regmap);\n\tregulator_bulk_disable(MAX98396_NUM_CORE_SUPPLIES,\n\t\t\t       max98396->core_supplies);\n\tif (max98396->pvdd)\n\t\tregulator_disable(max98396->pvdd);\n\n\tif (max98396->vbat)\n\t\tregulator_disable(max98396->vbat);\n\n\treturn 0;\n}\n\nstatic int max98396_resume(struct device *dev)\n{\n\tstruct max98396_priv *max98396 = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = regulator_bulk_enable(MAX98396_NUM_CORE_SUPPLIES,\n\t\t\t\t    max98396->core_supplies);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (max98396->pvdd) {\n\t\tret = regulator_enable(max98396->pvdd);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (max98396->vbat) {\n\t\tret = regulator_enable(max98396->vbat);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tregcache_cache_only(max98396->regmap, false);\n\tmax98396_reset(max98396, dev);\n\tregcache_sync(max98396->regmap);\n\treturn 0;\n}\n#endif\n\nstatic const struct dev_pm_ops max98396_pm = {\n\tSET_SYSTEM_SLEEP_PM_OPS(max98396_suspend, max98396_resume)\n};\n\nstatic const struct snd_soc_component_driver soc_codec_dev_max98396 = {\n\t.probe\t\t\t= max98396_probe,\n\t.controls\t\t= max98396_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(max98396_snd_controls),\n\t.dapm_widgets\t\t= max98396_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(max98396_dapm_widgets),\n\t.dapm_routes\t\t= max98396_audio_map,\n\t.num_dapm_routes\t= ARRAY_SIZE(max98396_audio_map),\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic const struct snd_soc_component_driver soc_codec_dev_max98397 = {\n\t.probe\t\t\t= max98396_probe,\n\t.controls\t\t= max98397_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(max98397_snd_controls),\n\t.dapm_widgets\t\t= max98396_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(max98396_dapm_widgets),\n\t.dapm_routes\t\t= max98396_audio_map,\n\t.num_dapm_routes\t= ARRAY_SIZE(max98396_audio_map),\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic const struct regmap_config max98396_regmap = {\n\t.reg_bits = 16,\n\t.val_bits = 8,\n\t.max_register = MAX98396_R21FF_REVISION_ID,\n\t.reg_defaults  = max98396_reg,\n\t.num_reg_defaults = ARRAY_SIZE(max98396_reg),\n\t.readable_reg = max98396_readable_register,\n\t.volatile_reg = max98396_volatile_reg,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\nstatic const struct regmap_config max98397_regmap = {\n\t.reg_bits = 16,\n\t.val_bits = 8,\n\t.max_register = MAX98397_R22FF_REVISION_ID,\n\t.reg_defaults  = max98397_reg,\n\t.num_reg_defaults = ARRAY_SIZE(max98397_reg),\n\t.readable_reg = max98397_readable_register,\n\t.volatile_reg = max98397_volatile_reg,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\nstatic void max98396_read_device_property(struct device *dev,\n\t\t\t\t\t  struct max98396_priv *max98396)\n{\n\tint value;\n\n\tif (!device_property_read_u32(dev, \"adi,vmon-slot-no\", &value))\n\t\tmax98396->v_slot = value & 0xF;\n\telse\n\t\tmax98396->v_slot = 0;\n\n\tif (!device_property_read_u32(dev, \"adi,imon-slot-no\", &value))\n\t\tmax98396->i_slot = value & 0xF;\n\telse\n\t\tmax98396->i_slot = 1;\n\n\tif (!device_property_read_u32(dev, \"adi,spkfb-slot-no\", &value))\n\t\tmax98396->spkfb_slot = value & 0xF;\n\telse\n\t\tmax98396->spkfb_slot = 2;\n\n\tif (!device_property_read_u32(dev, \"adi,bypass-slot-no\", &value))\n\t\tmax98396->bypass_slot = value & 0xF;\n\telse\n\t\tmax98396->bypass_slot = 0;\n\n\tmax98396->dmon_stuck_enable =\n\t\tdevice_property_read_bool(dev, \"adi,dmon-stuck-enable\");\n\n\tif (!device_property_read_u32(dev, \"adi,dmon-stuck-threshold-bits\", &value))\n\t\tmax98396->dmon_stuck_threshold = value;\n\telse\n\t\tmax98396->dmon_stuck_threshold = 15;\n\n\tmax98396->dmon_mag_enable =\n\t\tdevice_property_read_bool(dev, \"adi,dmon-magnitude-enable\");\n\n\tif (!device_property_read_u32(dev, \"adi,dmon-magnitude-threshold-bits\", &value))\n\t\tmax98396->dmon_mag_threshold = value;\n\telse\n\t\tmax98396->dmon_mag_threshold = 5;\n\n\tif (!device_property_read_u32(dev, \"adi,dmon-duration-ms\", &value))\n\t\tmax98396->dmon_duration = value;\n\telse\n\t\tmax98396->dmon_duration = 64;\n}\n\nstatic void max98396_core_supplies_disable(void *priv)\n{\n\tstruct max98396_priv *max98396 = priv;\n\n\tregulator_bulk_disable(MAX98396_NUM_CORE_SUPPLIES,\n\t\t\t       max98396->core_supplies);\n}\n\nstatic void max98396_supply_disable(void *r)\n{\n\tregulator_disable((struct regulator *) r);\n}\n\nstatic int max98396_i2c_probe(struct i2c_client *i2c)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(i2c);\n\tstruct max98396_priv *max98396 = NULL;\n\tint i, ret, reg;\n\n\tmax98396 = devm_kzalloc(&i2c->dev, sizeof(*max98396), GFP_KERNEL);\n\n\tif (!max98396) {\n\t\tret = -ENOMEM;\n\t\treturn ret;\n\t}\n\ti2c_set_clientdata(i2c, max98396);\n\n\tmax98396->device_id =  id->driver_data;\n\n\t \n\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\tmax98396->regmap = devm_regmap_init_i2c(i2c, &max98396_regmap);\n\n\telse\n\t\tmax98396->regmap = devm_regmap_init_i2c(i2c, &max98397_regmap);\n\n\tif (IS_ERR(max98396->regmap)) {\n\t\tret = PTR_ERR(max98396->regmap);\n\t\tdev_err(&i2c->dev,\n\t\t\t\"Failed to allocate regmap: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tfor (i = 0; i < MAX98396_NUM_CORE_SUPPLIES; i++)\n\t\tmax98396->core_supplies[i].supply = max98396_core_supplies[i];\n\n\tret = devm_regulator_bulk_get(&i2c->dev, MAX98396_NUM_CORE_SUPPLIES,\n\t\t\t\t      max98396->core_supplies);\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"Failed to request core supplies: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tmax98396->vbat = devm_regulator_get_optional(&i2c->dev, \"vbat\");\n\tif (IS_ERR(max98396->vbat)) {\n\t\tif (PTR_ERR(max98396->vbat) == -EPROBE_DEFER)\n\t\t\treturn -EPROBE_DEFER;\n\n\t\tmax98396->vbat = NULL;\n\t}\n\n\tmax98396->pvdd = devm_regulator_get_optional(&i2c->dev, \"pvdd\");\n\tif (IS_ERR(max98396->pvdd)) {\n\t\tif (PTR_ERR(max98396->pvdd) == -EPROBE_DEFER)\n\t\t\treturn -EPROBE_DEFER;\n\n\t\tmax98396->pvdd = NULL;\n\t}\n\n\tret = regulator_bulk_enable(MAX98396_NUM_CORE_SUPPLIES,\n\t\t\t\t    max98396->core_supplies);\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"Unable to enable core supplies: %d\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_add_action_or_reset(&i2c->dev, max98396_core_supplies_disable,\n\t\t\t\t       max98396);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (max98396->pvdd) {\n\t\tret = regulator_enable(max98396->pvdd);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = devm_add_action_or_reset(&i2c->dev,\n\t\t\t\t\t       max98396_supply_disable,\n\t\t\t\t\t       max98396->pvdd);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (max98396->vbat) {\n\t\tret = regulator_enable(max98396->vbat);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = devm_add_action_or_reset(&i2c->dev,\n\t\t\t\t\t       max98396_supply_disable,\n\t\t\t\t\t       max98396->vbat);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (device_property_read_bool(&i2c->dev, \"adi,interleave_mode\"))\n\t\tmax98396->interleave_mode = true;\n\telse\n\t\tmax98396->interleave_mode = false;\n\n\t \n\tmax98396_read_device_property(&i2c->dev, max98396);\n\n\t \n\tmax98396->reset_gpio = devm_gpiod_get_optional(&i2c->dev,\n\t\t\t\t\t\t       \"reset\", GPIOD_OUT_HIGH);\n\tif (IS_ERR(max98396->reset_gpio)) {\n\t\tret = PTR_ERR(max98396->reset_gpio);\n\t\tdev_err(&i2c->dev, \"Unable to request GPIO pin: %d.\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (max98396->reset_gpio) {\n\t\tusleep_range(5000, 6000);\n\t\tgpiod_set_value_cansleep(max98396->reset_gpio, 0);\n\t\t \n\t\tusleep_range(5000, 6000);\n\t}\n\n\tret = regmap_read(max98396->regmap,\n\t\t\t  GET_REG_ADDR_REV_ID(max98396->device_id), &reg);\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"%s: failed to read revision of the device.\\n\",  id->name);\n\t\treturn ret;\n\t}\n\tdev_info(&i2c->dev, \"%s revision ID: 0x%02X\\n\", id->name, reg);\n\n\t \n\tif (max98396->device_id == CODEC_TYPE_MAX98396)\n\t\tret = devm_snd_soc_register_component(&i2c->dev,\n\t\t\t\t\t\t      &soc_codec_dev_max98396,\n\t\t\t\t\t\t      max98396_dai,\n\t\t\t\t\t\t      ARRAY_SIZE(max98396_dai));\n\telse\n\t\tret = devm_snd_soc_register_component(&i2c->dev,\n\t\t\t\t\t\t      &soc_codec_dev_max98397,\n\t\t\t\t\t\t      max98397_dai,\n\t\t\t\t\t\t      ARRAY_SIZE(max98397_dai));\n\tif (ret < 0)\n\t\tdev_err(&i2c->dev, \"Failed to register codec: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic const struct i2c_device_id max98396_i2c_id[] = {\n\t{ \"max98396\", CODEC_TYPE_MAX98396},\n\t{ \"max98397\", CODEC_TYPE_MAX98397},\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(i2c, max98396_i2c_id);\n\n#if defined(CONFIG_OF)\nstatic const struct of_device_id max98396_of_match[] = {\n\t{ .compatible = \"adi,max98396\", },\n\t{ .compatible = \"adi,max98397\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max98396_of_match);\n#endif\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id max98396_acpi_match[] = {\n\t{ \"ADS8396\", 0 },\n\t{ \"ADS8397\", 0 },\n\t{},\n};\nMODULE_DEVICE_TABLE(acpi, max98396_acpi_match);\n#endif\n\nstatic struct i2c_driver max98396_i2c_driver = {\n\t.driver = {\n\t\t.name = \"max98396\",\n\t\t.of_match_table = of_match_ptr(max98396_of_match),\n\t\t.acpi_match_table = ACPI_PTR(max98396_acpi_match),\n\t\t.pm = &max98396_pm,\n\t},\n\t.probe = max98396_i2c_probe,\n\t.id_table = max98396_i2c_id,\n};\n\nmodule_i2c_driver(max98396_i2c_driver)\n\nMODULE_DESCRIPTION(\"ALSA SoC MAX98396 driver\");\nMODULE_AUTHOR(\"Ryan Lee <ryans.lee@analog.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}