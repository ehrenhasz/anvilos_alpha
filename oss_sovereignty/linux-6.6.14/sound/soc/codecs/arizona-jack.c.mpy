{
  "module_name": "arizona-jack.c",
  "hash_id": "144d86fcdc829b46792fad8fb1048ed9c88d5952cc0b000bdb77d2a4a521da70",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/arizona-jack.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/interrupt.h>\n#include <linux/err.h>\n#include <linux/gpio/consumer.h>\n#include <linux/gpio.h>\n#include <linux/input.h>\n#include <linux/pm_runtime.h>\n#include <linux/property.h>\n#include <linux/regulator/consumer.h>\n\n#include <sound/jack.h>\n#include <sound/soc.h>\n\n#include <linux/mfd/arizona/core.h>\n#include <linux/mfd/arizona/pdata.h>\n#include <linux/mfd/arizona/registers.h>\n#include <dt-bindings/mfd/arizona.h>\n\n#include \"arizona.h\"\n\n#define ARIZONA_MAX_MICD_RANGE 8\n\n \n#define ARIZONA_MAX_MICD_BUTTONS 6\n\n#define ARIZONA_MICD_CLAMP_MODE_JDL      0x4\n#define ARIZONA_MICD_CLAMP_MODE_JDH      0x5\n#define ARIZONA_MICD_CLAMP_MODE_JDL_GP5H 0x9\n#define ARIZONA_MICD_CLAMP_MODE_JDH_GP5H 0xb\n\n#define ARIZONA_TST_CAP_DEFAULT 0x3\n#define ARIZONA_TST_CAP_CLAMP   0x1\n\n#define ARIZONA_HPDET_MAX 10000\n\n#define HPDET_DEBOUNCE 500\n#define DEFAULT_MICD_TIMEOUT 2000\n\n#define ARIZONA_HPDET_WAIT_COUNT 15\n#define ARIZONA_HPDET_WAIT_DELAY_MS 20\n\n#define QUICK_HEADPHONE_MAX_OHM 3\n#define MICROPHONE_MIN_OHM      1257\n#define MICROPHONE_MAX_OHM      30000\n\n#define MICD_DBTIME_TWO_READINGS 2\n#define MICD_DBTIME_FOUR_READINGS 4\n\n#define MICD_LVL_1_TO_7 (ARIZONA_MICD_LVL_1 | ARIZONA_MICD_LVL_2 | \\\n\t\t\t ARIZONA_MICD_LVL_3 | ARIZONA_MICD_LVL_4 | \\\n\t\t\t ARIZONA_MICD_LVL_5 | ARIZONA_MICD_LVL_6 | \\\n\t\t\t ARIZONA_MICD_LVL_7)\n\n#define MICD_LVL_0_TO_7 (ARIZONA_MICD_LVL_0 | MICD_LVL_1_TO_7)\n\n#define MICD_LVL_0_TO_8 (MICD_LVL_0_TO_7 | ARIZONA_MICD_LVL_8)\n\nstatic const struct arizona_micd_config micd_default_modes[] = {\n\t{ ARIZONA_ACCDET_SRC, 1, 0 },\n\t{ 0,                  2, 1 },\n};\n\nstatic const struct arizona_micd_range micd_default_ranges[] = {\n\t{ .max =  11, .key = BTN_0 },\n\t{ .max =  28, .key = BTN_1 },\n\t{ .max =  54, .key = BTN_2 },\n\t{ .max = 100, .key = BTN_3 },\n\t{ .max = 186, .key = BTN_4 },\n\t{ .max = 430, .key = BTN_5 },\n};\n\n \n#define ARIZONA_NUM_MICD_BUTTON_LEVELS 64\n\nstatic const int arizona_micd_levels[] = {\n\t3, 6, 8, 11, 13, 16, 18, 21, 23, 26, 28, 31, 34, 36, 39, 41, 44, 46,\n\t49, 52, 54, 57, 60, 62, 65, 67, 70, 73, 75, 78, 81, 83, 89, 94, 100,\n\t105, 111, 116, 122, 127, 139, 150, 161, 173, 186, 196, 209, 220, 245,\n\t270, 295, 321, 348, 375, 402, 430, 489, 550, 614, 681, 752, 903, 1071,\n\t1257, 30000,\n};\n\nstatic void arizona_start_hpdet_acc_id(struct arizona_priv *info);\n\nstatic void arizona_extcon_hp_clamp(struct arizona_priv *info,\n\t\t\t\t    bool clamp)\n{\n\tstruct arizona *arizona = info->arizona;\n\tunsigned int mask = 0, val = 0;\n\tunsigned int cap_sel = 0;\n\tint ret;\n\n\tswitch (arizona->type) {\n\tcase WM8998:\n\tcase WM1814:\n\t\tmask = 0;\n\t\tbreak;\n\tcase WM5110:\n\tcase WM8280:\n\t\tmask = ARIZONA_HP1L_SHRTO | ARIZONA_HP1L_FLWR |\n\t\t       ARIZONA_HP1L_SHRTI;\n\t\tif (clamp) {\n\t\t\tval = ARIZONA_HP1L_SHRTO;\n\t\t\tcap_sel = ARIZONA_TST_CAP_CLAMP;\n\t\t} else {\n\t\t\tval = ARIZONA_HP1L_FLWR | ARIZONA_HP1L_SHRTI;\n\t\t\tcap_sel = ARIZONA_TST_CAP_DEFAULT;\n\t\t}\n\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_HP_TEST_CTRL_1,\n\t\t\t\t\t ARIZONA_HP1_TST_CAP_SEL_MASK,\n\t\t\t\t\t cap_sel);\n\t\tif (ret)\n\t\t\tdev_warn(arizona->dev, \"Failed to set TST_CAP_SEL: %d\\n\", ret);\n\t\tbreak;\n\tdefault:\n\t\tmask = ARIZONA_RMV_SHRT_HP1L;\n\t\tif (clamp)\n\t\t\tval = ARIZONA_RMV_SHRT_HP1L;\n\t\tbreak;\n\t}\n\n\tsnd_soc_dapm_mutex_lock(arizona->dapm);\n\n\tarizona->hpdet_clamp = clamp;\n\n\t \n\tif (clamp) {\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_OUTPUT_ENABLES_1,\n\t\t\t\t\t ARIZONA_OUT1L_ENA |\n\t\t\t\t\t ARIZONA_OUT1R_ENA, 0);\n\t\tif (ret)\n\t\t\tdev_warn(arizona->dev, \"Failed to disable headphone outputs: %d\\n\", ret);\n\t}\n\n\tif (mask) {\n\t\tret = regmap_update_bits(arizona->regmap, ARIZONA_HP_CTRL_1L,\n\t\t\t\t\t mask, val);\n\t\tif (ret)\n\t\t\tdev_warn(arizona->dev, \"Failed to do clamp: %d\\n\", ret);\n\n\t\tret = regmap_update_bits(arizona->regmap, ARIZONA_HP_CTRL_1R,\n\t\t\t\t\t mask, val);\n\t\tif (ret)\n\t\t\tdev_warn(arizona->dev, \"Failed to do clamp: %d\\n\", ret);\n\t}\n\n\t \n\tif (!clamp) {\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_OUTPUT_ENABLES_1,\n\t\t\t\t\t ARIZONA_OUT1L_ENA |\n\t\t\t\t\t ARIZONA_OUT1R_ENA, arizona->hp_ena);\n\t\tif (ret)\n\t\t\tdev_warn(arizona->dev, \"Failed to restore headphone outputs: %d\\n\", ret);\n\t}\n\n\tsnd_soc_dapm_mutex_unlock(arizona->dapm);\n}\n\nstatic void arizona_extcon_set_mode(struct arizona_priv *info, int mode)\n{\n\tstruct arizona *arizona = info->arizona;\n\n\tmode %= info->micd_num_modes;\n\n\tgpiod_set_value_cansleep(info->micd_pol_gpio,\n\t\t\t\t info->micd_modes[mode].gpio);\n\n\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t   ARIZONA_MICD_BIAS_SRC_MASK,\n\t\t\t   info->micd_modes[mode].bias <<\n\t\t\t   ARIZONA_MICD_BIAS_SRC_SHIFT);\n\tregmap_update_bits(arizona->regmap, ARIZONA_ACCESSORY_DETECT_MODE_1,\n\t\t\t   ARIZONA_ACCDET_SRC, info->micd_modes[mode].src);\n\n\tinfo->micd_mode = mode;\n\n\tdev_dbg(arizona->dev, \"Set jack polarity to %d\\n\", mode);\n}\n\nstatic const char *arizona_extcon_get_micbias(struct arizona_priv *info)\n{\n\tswitch (info->micd_modes[0].bias) {\n\tcase 1:\n\t\treturn \"MICBIAS1\";\n\tcase 2:\n\t\treturn \"MICBIAS2\";\n\tcase 3:\n\t\treturn \"MICBIAS3\";\n\tdefault:\n\t\treturn \"MICVDD\";\n\t}\n}\n\nstatic void arizona_extcon_pulse_micbias(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tconst char *widget = arizona_extcon_get_micbias(info);\n\tstruct snd_soc_dapm_context *dapm = arizona->dapm;\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(dapm);\n\tint ret;\n\n\tret = snd_soc_component_force_enable_pin(component, widget);\n\tif (ret)\n\t\tdev_warn(arizona->dev, \"Failed to enable %s: %d\\n\", widget, ret);\n\n\tsnd_soc_dapm_sync(dapm);\n\n\tif (!arizona->pdata.micd_force_micbias) {\n\t\tret = snd_soc_component_disable_pin(component, widget);\n\t\tif (ret)\n\t\t\tdev_warn(arizona->dev, \"Failed to disable %s: %d\\n\", widget, ret);\n\n\t\tsnd_soc_dapm_sync(dapm);\n\t}\n}\n\nstatic void arizona_start_mic(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tbool change;\n\tint ret;\n\tunsigned int mode;\n\n\t \n\tpm_runtime_get_sync(arizona->dev);\n\n\tif (info->detecting) {\n\t\tret = regulator_allow_bypass(info->micvdd, false);\n\t\tif (ret)\n\t\t\tdev_err(arizona->dev, \"Failed to regulate MICVDD: %d\\n\", ret);\n\t}\n\n\tret = regulator_enable(info->micvdd);\n\tif (ret)\n\t\tdev_err(arizona->dev, \"Failed to enable MICVDD: %d\\n\", ret);\n\n\tif (info->micd_reva) {\n\t\tconst struct reg_sequence reva[] = {\n\t\t\t{ 0x80,  0x3 },\n\t\t\t{ 0x294, 0x0 },\n\t\t\t{ 0x80,  0x0 },\n\t\t};\n\n\t\tregmap_multi_reg_write(arizona->regmap, reva, ARRAY_SIZE(reva));\n\t}\n\n\tif (info->detecting && arizona->pdata.micd_software_compare)\n\t\tmode = ARIZONA_ACCDET_MODE_ADC;\n\telse\n\t\tmode = ARIZONA_ACCDET_MODE_MIC;\n\n\tregmap_update_bits(arizona->regmap,\n\t\t\t   ARIZONA_ACCESSORY_DETECT_MODE_1,\n\t\t\t   ARIZONA_ACCDET_MODE_MASK, mode);\n\n\tarizona_extcon_pulse_micbias(info);\n\n\tret = regmap_update_bits_check(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t       ARIZONA_MICD_ENA, ARIZONA_MICD_ENA,\n\t\t\t\t       &change);\n\tif (ret < 0) {\n\t\tdev_err(arizona->dev, \"Failed to enable micd: %d\\n\", ret);\n\t} else if (!change) {\n\t\tregulator_disable(info->micvdd);\n\t\tpm_runtime_put_autosuspend(arizona->dev);\n\t}\n}\n\nstatic void arizona_stop_mic(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tconst char *widget = arizona_extcon_get_micbias(info);\n\tstruct snd_soc_dapm_context *dapm = arizona->dapm;\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(dapm);\n\tbool change = false;\n\tint ret;\n\n\tret = regmap_update_bits_check(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t       ARIZONA_MICD_ENA, 0,\n\t\t\t\t       &change);\n\tif (ret < 0)\n\t\tdev_err(arizona->dev, \"Failed to disable micd: %d\\n\", ret);\n\n\tret = snd_soc_component_disable_pin(component, widget);\n\tif (ret)\n\t\tdev_warn(arizona->dev, \"Failed to disable %s: %d\\n\", widget, ret);\n\n\tsnd_soc_dapm_sync(dapm);\n\n\tif (info->micd_reva) {\n\t\tconst struct reg_sequence reva[] = {\n\t\t\t{ 0x80,  0x3 },\n\t\t\t{ 0x294, 0x2 },\n\t\t\t{ 0x80,  0x0 },\n\t\t};\n\n\t\tregmap_multi_reg_write(arizona->regmap, reva, ARRAY_SIZE(reva));\n\t}\n\n\tret = regulator_allow_bypass(info->micvdd, true);\n\tif (ret)\n\t\tdev_err(arizona->dev, \"Failed to bypass MICVDD: %d\\n\", ret);\n\n\tif (change) {\n\t\tregulator_disable(info->micvdd);\n\t\tpm_runtime_mark_last_busy(arizona->dev);\n\t\tpm_runtime_put_autosuspend(arizona->dev);\n\t}\n}\n\nstatic struct {\n\tunsigned int threshold;\n\tunsigned int factor_a;\n\tunsigned int factor_b;\n} arizona_hpdet_b_ranges[] = {\n\t{ 100,  5528,   362464 },\n\t{ 169, 11084,  6186851 },\n\t{ 169, 11065, 65460395 },\n};\n\n#define ARIZONA_HPDET_B_RANGE_MAX 0x3fb\n\nstatic struct {\n\tint min;\n\tint max;\n} arizona_hpdet_c_ranges[] = {\n\t{ 0,       30 },\n\t{ 8,      100 },\n\t{ 100,   1000 },\n\t{ 1000, 10000 },\n};\n\nstatic int arizona_hpdet_read(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tunsigned int val, range;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, ARIZONA_HEADPHONE_DETECT_2, &val);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to read HPDET status: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tswitch (info->hpdet_ip_version) {\n\tcase 0:\n\t\tif (!(val & ARIZONA_HP_DONE)) {\n\t\t\tdev_err(arizona->dev, \"HPDET did not complete: %x\\n\", val);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tval &= ARIZONA_HP_LVL_MASK;\n\t\tbreak;\n\n\tcase 1:\n\t\tif (!(val & ARIZONA_HP_DONE_B)) {\n\t\t\tdev_err(arizona->dev, \"HPDET did not complete: %x\\n\", val);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tret = regmap_read(arizona->regmap, ARIZONA_HP_DACVAL, &val);\n\t\tif (ret) {\n\t\t\tdev_err(arizona->dev, \"Failed to read HP value: %d\\n\", ret);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tregmap_read(arizona->regmap, ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t    &range);\n\t\trange = (range & ARIZONA_HP_IMPEDANCE_RANGE_MASK)\n\t\t\t   >> ARIZONA_HP_IMPEDANCE_RANGE_SHIFT;\n\n\t\tif (range < ARRAY_SIZE(arizona_hpdet_b_ranges) - 1 &&\n\t\t    (val < arizona_hpdet_b_ranges[range].threshold ||\n\t\t     val >= ARIZONA_HPDET_B_RANGE_MAX)) {\n\t\t\trange++;\n\t\t\tdev_dbg(arizona->dev, \"Moving to HPDET range %d\\n\", range);\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t   ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t\t\t   ARIZONA_HP_IMPEDANCE_RANGE_MASK,\n\t\t\t\t\t   range <<\n\t\t\t\t\t   ARIZONA_HP_IMPEDANCE_RANGE_SHIFT);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\t \n\t\tif (val < arizona_hpdet_b_ranges[range].threshold ||\n\t\t    val >= ARIZONA_HPDET_B_RANGE_MAX) {\n\t\t\tdev_dbg(arizona->dev, \"Measurement out of range\\n\");\n\t\t\treturn ARIZONA_HPDET_MAX;\n\t\t}\n\n\t\tdev_dbg(arizona->dev, \"HPDET read %d in range %d\\n\", val, range);\n\n\t\tval = arizona_hpdet_b_ranges[range].factor_b\n\t\t\t/ ((val * 100) -\n\t\t\t   arizona_hpdet_b_ranges[range].factor_a);\n\t\tbreak;\n\n\tcase 2:\n\t\tif (!(val & ARIZONA_HP_DONE_B)) {\n\t\t\tdev_err(arizona->dev, \"HPDET did not complete: %x\\n\", val);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tval &= ARIZONA_HP_LVL_B_MASK;\n\t\t \n\t\tval /= 2;\n\n\t\tregmap_read(arizona->regmap, ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t    &range);\n\t\trange = (range & ARIZONA_HP_IMPEDANCE_RANGE_MASK)\n\t\t\t   >> ARIZONA_HP_IMPEDANCE_RANGE_SHIFT;\n\n\t\t \n\t\tif (range < ARRAY_SIZE(arizona_hpdet_c_ranges) - 1 &&\n\t\t    (val >= arizona_hpdet_c_ranges[range].max)) {\n\t\t\trange++;\n\t\t\tdev_dbg(arizona->dev, \"Moving to HPDET range %d-%d\\n\",\n\t\t\t\tarizona_hpdet_c_ranges[range].min,\n\t\t\t\tarizona_hpdet_c_ranges[range].max);\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t   ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t\t\t   ARIZONA_HP_IMPEDANCE_RANGE_MASK,\n\t\t\t\t\t   range <<\n\t\t\t\t\t   ARIZONA_HP_IMPEDANCE_RANGE_SHIFT);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tif (range && (val < arizona_hpdet_c_ranges[range].min)) {\n\t\t\tdev_dbg(arizona->dev, \"Reporting range boundary %d\\n\",\n\t\t\t\tarizona_hpdet_c_ranges[range].min);\n\t\t\tval = arizona_hpdet_c_ranges[range].min;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tdev_warn(arizona->dev, \"Unknown HPDET IP revision %d\\n\", info->hpdet_ip_version);\n\t\treturn -EINVAL;\n\t}\n\n\tdev_dbg(arizona->dev, \"HP impedance %d ohms\\n\", val);\n\treturn val;\n}\n\nstatic int arizona_hpdet_do_id(struct arizona_priv *info, int *reading,\n\t\t\t       bool *mic)\n{\n\tstruct arizona *arizona = info->arizona;\n\tint id_gpio = arizona->pdata.hpdet_id_gpio;\n\n\tif (!arizona->pdata.hpdet_acc_id)\n\t\treturn 0;\n\n\t \n\tinfo->hpdet_res[info->num_hpdet_res++] = *reading;\n\n\t \n\tif (id_gpio && info->num_hpdet_res == 1) {\n\t\tdev_dbg(arizona->dev, \"Measuring mic\\n\");\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_ACCESSORY_DETECT_MODE_1,\n\t\t\t\t   ARIZONA_ACCDET_MODE_MASK |\n\t\t\t\t   ARIZONA_ACCDET_SRC,\n\t\t\t\t   ARIZONA_ACCDET_MODE_HPR |\n\t\t\t\t   info->micd_modes[0].src);\n\n\t\tgpio_set_value_cansleep(id_gpio, 1);\n\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t\t   ARIZONA_HP_POLL, ARIZONA_HP_POLL);\n\t\treturn -EAGAIN;\n\t}\n\n\t \n\tdev_dbg(arizona->dev, \"HPDET measured %d %d\\n\",\n\t\tinfo->hpdet_res[0], info->hpdet_res[1]);\n\n\t \n\t*reading = info->hpdet_res[0];\n\n\t \n\tif (*reading >= ARIZONA_HPDET_MAX && !info->hpdet_retried) {\n\t\tdev_dbg(arizona->dev, \"Retrying high impedance\\n\");\n\t\tinfo->num_hpdet_res = 0;\n\t\tinfo->hpdet_retried = true;\n\t\tarizona_start_hpdet_acc_id(info);\n\t\tpm_runtime_put(arizona->dev);\n\t\treturn -EAGAIN;\n\t}\n\n\t \n\tif (!id_gpio || info->hpdet_res[1] > 50) {\n\t\tdev_dbg(arizona->dev, \"Detected mic\\n\");\n\t\t*mic = true;\n\t\tinfo->detecting = true;\n\t} else {\n\t\tdev_dbg(arizona->dev, \"Detected headphone\\n\");\n\t}\n\n\t \n\tregmap_update_bits(arizona->regmap, ARIZONA_ACCESSORY_DETECT_MODE_1,\n\t\t\t   ARIZONA_ACCDET_SRC, info->micd_modes[0].src);\n\n\treturn 0;\n}\n\nstatic irqreturn_t arizona_hpdet_irq(int irq, void *data)\n{\n\tstruct arizona_priv *info = data;\n\tstruct arizona *arizona = info->arizona;\n\tint id_gpio = arizona->pdata.hpdet_id_gpio;\n\tint ret, reading, state, report;\n\tbool mic = false;\n\n\tmutex_lock(&info->lock);\n\n\t \n\tif (!info->hpdet_active) {\n\t\tdev_warn(arizona->dev, \"Spurious HPDET IRQ\\n\");\n\t\tmutex_unlock(&info->lock);\n\t\treturn IRQ_NONE;\n\t}\n\n\t \n\tstate = info->jack->status & SND_JACK_MECHANICAL;\n\tif (!state) {\n\t\tdev_dbg(arizona->dev, \"Ignoring HPDET for removed cable\\n\");\n\t\tgoto done;\n\t}\n\n\tret = arizona_hpdet_read(info);\n\tif (ret == -EAGAIN)\n\t\tgoto out;\n\telse if (ret < 0)\n\t\tgoto done;\n\treading = ret;\n\n\t \n\tregmap_update_bits(arizona->regmap,\n\t\t\t   ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t   ARIZONA_HP_IMPEDANCE_RANGE_MASK | ARIZONA_HP_POLL,\n\t\t\t   0);\n\n\tret = arizona_hpdet_do_id(info, &reading, &mic);\n\tif (ret == -EAGAIN)\n\t\tgoto out;\n\telse if (ret < 0)\n\t\tgoto done;\n\n\t \n\tif (reading >= 5000)\n\t\treport = SND_JACK_LINEOUT;\n\telse\n\t\treport = SND_JACK_HEADPHONE;\n\n\tsnd_soc_jack_report(info->jack, report, SND_JACK_LINEOUT | SND_JACK_HEADPHONE);\n\ndone:\n\t \n\tregmap_update_bits(arizona->regmap,\n\t\t\t   ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t   ARIZONA_HP_IMPEDANCE_RANGE_MASK | ARIZONA_HP_POLL,\n\t\t\t   0);\n\n\tarizona_extcon_hp_clamp(info, false);\n\n\tif (id_gpio)\n\t\tgpio_set_value_cansleep(id_gpio, 0);\n\n\t \n\tif (state && (mic || info->mic))\n\t\tarizona_start_mic(info);\n\n\tif (info->hpdet_active) {\n\t\tpm_runtime_put_autosuspend(arizona->dev);\n\t\tinfo->hpdet_active = false;\n\t}\n\n\t \n\tif (state)\n\t\tinfo->hpdet_done = true;\n\nout:\n\tmutex_unlock(&info->lock);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void arizona_identify_headphone(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tint ret;\n\n\tif (info->hpdet_done)\n\t\treturn;\n\n\tdev_dbg(arizona->dev, \"Starting HPDET\\n\");\n\n\t \n\tpm_runtime_get_sync(arizona->dev);\n\n\tinfo->hpdet_active = true;\n\n\tarizona_stop_mic(info);\n\n\tarizona_extcon_hp_clamp(info, true);\n\n\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t ARIZONA_ACCESSORY_DETECT_MODE_1,\n\t\t\t\t ARIZONA_ACCDET_MODE_MASK,\n\t\t\t\t arizona->pdata.hpdet_channel);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to set HPDET mode: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tret = regmap_update_bits(arizona->regmap, ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t\t ARIZONA_HP_POLL, ARIZONA_HP_POLL);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Can't start HPDETL measurement: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\treturn;\n\nerr:\n\tarizona_extcon_hp_clamp(info, false);\n\tpm_runtime_put_autosuspend(arizona->dev);\n\n\t \n\tsnd_soc_jack_report(info->jack, SND_JACK_HEADPHONE,\n\t\t\t    SND_JACK_LINEOUT | SND_JACK_HEADPHONE);\n\n\tif (info->mic)\n\t\tarizona_start_mic(info);\n\n\tinfo->hpdet_active = false;\n}\n\nstatic void arizona_start_hpdet_acc_id(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tint hp_reading = 32;\n\tbool mic;\n\tint ret;\n\n\tdev_dbg(arizona->dev, \"Starting identification via HPDET\\n\");\n\n\t \n\tpm_runtime_get_sync(arizona->dev);\n\n\tinfo->hpdet_active = true;\n\n\tarizona_extcon_hp_clamp(info, true);\n\n\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t ARIZONA_ACCESSORY_DETECT_MODE_1,\n\t\t\t\t ARIZONA_ACCDET_SRC | ARIZONA_ACCDET_MODE_MASK,\n\t\t\t\t info->micd_modes[0].src |\n\t\t\t\t arizona->pdata.hpdet_channel);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to set HPDET mode: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tif (arizona->pdata.hpdet_acc_id_line) {\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_HEADPHONE_DETECT_1,\n\t\t\t\t\t ARIZONA_HP_POLL, ARIZONA_HP_POLL);\n\t\tif (ret) {\n\t\t\tdev_err(arizona->dev, \"Can't start HPDETL measurement: %d\\n\", ret);\n\t\t\tgoto err;\n\t\t}\n\t} else {\n\t\tarizona_hpdet_do_id(info, &hp_reading, &mic);\n\t}\n\n\treturn;\n\nerr:\n\t \n\tsnd_soc_jack_report(info->jack, SND_JACK_HEADPHONE,\n\t\t\t    SND_JACK_LINEOUT | SND_JACK_HEADPHONE);\n\n\tinfo->hpdet_active = false;\n}\n\nstatic void arizona_micd_timeout_work(struct work_struct *work)\n{\n\tstruct arizona_priv *info = container_of(work,\n\t\t\t\t\t\tstruct arizona_priv,\n\t\t\t\t\t\tmicd_timeout_work.work);\n\n\tmutex_lock(&info->lock);\n\n\tdev_dbg(info->arizona->dev, \"MICD timed out, reporting HP\\n\");\n\n\tinfo->detecting = false;\n\n\tarizona_identify_headphone(info);\n\n\tmutex_unlock(&info->lock);\n}\n\nstatic int arizona_micd_adc_read(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tunsigned int val;\n\tint ret;\n\n\t \n\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t   ARIZONA_MICD_ENA, 0);\n\n\tret = regmap_read(arizona->regmap, ARIZONA_MIC_DETECT_4, &val);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to read MICDET_ADCVAL: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tdev_dbg(arizona->dev, \"MICDET_ADCVAL: %x\\n\", val);\n\n\tval &= ARIZONA_MICDET_ADCVAL_MASK;\n\tif (val < ARRAY_SIZE(arizona_micd_levels))\n\t\tval = arizona_micd_levels[val];\n\telse\n\t\tval = INT_MAX;\n\n\tif (val <= QUICK_HEADPHONE_MAX_OHM)\n\t\tval = ARIZONA_MICD_STS | ARIZONA_MICD_LVL_0;\n\telse if (val <= MICROPHONE_MIN_OHM)\n\t\tval = ARIZONA_MICD_STS | ARIZONA_MICD_LVL_1;\n\telse if (val <= MICROPHONE_MAX_OHM)\n\t\tval = ARIZONA_MICD_STS | ARIZONA_MICD_LVL_8;\n\telse\n\t\tval = ARIZONA_MICD_LVL_8;\n\n\treturn val;\n}\n\nstatic int arizona_micd_read(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tunsigned int val = 0;\n\tint ret, i;\n\n\tfor (i = 0; i < 10 && !(val & MICD_LVL_0_TO_8); i++) {\n\t\tret = regmap_read(arizona->regmap, ARIZONA_MIC_DETECT_3, &val);\n\t\tif (ret) {\n\t\t\tdev_err(arizona->dev, \"Failed to read MICDET: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tdev_dbg(arizona->dev, \"MICDET: %x\\n\", val);\n\n\t\tif (!(val & ARIZONA_MICD_VALID)) {\n\t\t\tdev_warn(arizona->dev, \"Microphone detection state invalid\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (i == 10 && !(val & MICD_LVL_0_TO_8)) {\n\t\tdev_err(arizona->dev, \"Failed to get valid MICDET value\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn val;\n}\n\nstatic int arizona_micdet_reading(void *priv)\n{\n\tstruct arizona_priv *info = priv;\n\tstruct arizona *arizona = info->arizona;\n\tint ret, val;\n\n\tif (info->detecting && arizona->pdata.micd_software_compare)\n\t\tret = arizona_micd_adc_read(info);\n\telse\n\t\tret = arizona_micd_read(info);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tval = ret;\n\n\t \n\tif (!(val & ARIZONA_MICD_STS)) {\n\t\tdev_warn(arizona->dev, \"Detected open circuit\\n\");\n\t\tinfo->mic = false;\n\t\tinfo->detecting = false;\n\t\tarizona_identify_headphone(info);\n\t\treturn 0;\n\t}\n\n\t \n\tif (val & ARIZONA_MICD_LVL_8) {\n\t\tinfo->mic = true;\n\t\tinfo->detecting = false;\n\n\t\tarizona_identify_headphone(info);\n\n\t\tsnd_soc_jack_report(info->jack, SND_JACK_MICROPHONE, SND_JACK_MICROPHONE);\n\n\t\t \n\t\tret = regulator_allow_bypass(info->micvdd, true);\n\t\tif (ret)\n\t\t\tdev_err(arizona->dev, \"Failed to bypass MICVDD: %d\\n\", ret);\n\n\t\treturn 0;\n\t}\n\n\t \n\tif (val & MICD_LVL_1_TO_7) {\n\t\tif (info->jack_flips >= info->micd_num_modes * 10) {\n\t\t\tdev_dbg(arizona->dev, \"Detected HP/line\\n\");\n\n\t\t\tinfo->detecting = false;\n\n\t\t\tarizona_identify_headphone(info);\n\t\t} else {\n\t\t\tinfo->micd_mode++;\n\t\t\tif (info->micd_mode == info->micd_num_modes)\n\t\t\t\tinfo->micd_mode = 0;\n\t\t\tarizona_extcon_set_mode(info, info->micd_mode);\n\n\t\t\tinfo->jack_flips++;\n\n\t\t\tif (arizona->pdata.micd_software_compare)\n\t\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t\t   ARIZONA_MIC_DETECT_1,\n\t\t\t\t\t\t   ARIZONA_MICD_ENA,\n\t\t\t\t\t\t   ARIZONA_MICD_ENA);\n\n\t\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t\t   &info->micd_timeout_work,\n\t\t\t\t\t   msecs_to_jiffies(arizona->pdata.micd_timeout));\n\t\t}\n\n\t\treturn 0;\n\t}\n\n\t \n\tdev_dbg(arizona->dev, \"Headphone detected\\n\");\n\tinfo->detecting = false;\n\n\tarizona_identify_headphone(info);\n\n\treturn 0;\n}\n\nstatic int arizona_button_reading(void *priv)\n{\n\tstruct arizona_priv *info = priv;\n\tstruct arizona *arizona = info->arizona;\n\tint val, key, lvl;\n\n\tval = arizona_micd_read(info);\n\tif (val < 0)\n\t\treturn val;\n\n\t \n\tif (val & MICD_LVL_0_TO_7) {\n\t\tif (info->mic) {\n\t\t\tdev_dbg(arizona->dev, \"Mic button detected\\n\");\n\n\t\t\tlvl = val & ARIZONA_MICD_LVL_MASK;\n\t\t\tlvl >>= ARIZONA_MICD_LVL_SHIFT;\n\n\t\t\tif (lvl && ffs(lvl) - 1 < info->num_micd_ranges) {\n\t\t\t\tkey = ffs(lvl) - 1;\n\t\t\t\tsnd_soc_jack_report(info->jack,\n\t\t\t\t\t\t    SND_JACK_BTN_0 >> key,\n\t\t\t\t\t\t    info->micd_button_mask);\n\t\t\t} else {\n\t\t\t\tdev_err(arizona->dev, \"Button out of range\\n\");\n\t\t\t}\n\t\t} else {\n\t\t\tdev_warn(arizona->dev, \"Button with no mic: %x\\n\", val);\n\t\t}\n\t} else {\n\t\tdev_dbg(arizona->dev, \"Mic button released\\n\");\n\t\tsnd_soc_jack_report(info->jack, 0, info->micd_button_mask);\n\t\tarizona_extcon_pulse_micbias(info);\n\t}\n\n\treturn 0;\n}\n\nstatic void arizona_micd_detect(struct work_struct *work)\n{\n\tstruct arizona_priv *info = container_of(work,\n\t\t\t\t\t\tstruct arizona_priv,\n\t\t\t\t\t\tmicd_detect_work.work);\n\tstruct arizona *arizona = info->arizona;\n\n\tcancel_delayed_work_sync(&info->micd_timeout_work);\n\n\tmutex_lock(&info->lock);\n\n\t \n\tif (!(info->jack->status & SND_JACK_MECHANICAL)) {\n\t\tdev_dbg(arizona->dev, \"Ignoring MICDET for removed cable\\n\");\n\t\tmutex_unlock(&info->lock);\n\t\treturn;\n\t}\n\n\tif (info->detecting)\n\t\tarizona_micdet_reading(info);\n\telse\n\t\tarizona_button_reading(info);\n\n\tpm_runtime_mark_last_busy(arizona->dev);\n\tmutex_unlock(&info->lock);\n}\n\nstatic irqreturn_t arizona_micdet(int irq, void *data)\n{\n\tstruct arizona_priv *info = data;\n\tstruct arizona *arizona = info->arizona;\n\tint debounce = arizona->pdata.micd_detect_debounce;\n\n\tcancel_delayed_work_sync(&info->micd_detect_work);\n\tcancel_delayed_work_sync(&info->micd_timeout_work);\n\n\tmutex_lock(&info->lock);\n\tif (!info->detecting)\n\t\tdebounce = 0;\n\tmutex_unlock(&info->lock);\n\n\tif (debounce)\n\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t   &info->micd_detect_work,\n\t\t\t\t   msecs_to_jiffies(debounce));\n\telse\n\t\tarizona_micd_detect(&info->micd_detect_work.work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void arizona_hpdet_work(struct work_struct *work)\n{\n\tstruct arizona_priv *info = container_of(work,\n\t\t\t\t\t\tstruct arizona_priv,\n\t\t\t\t\t\thpdet_work.work);\n\n\tmutex_lock(&info->lock);\n\tarizona_start_hpdet_acc_id(info);\n\tmutex_unlock(&info->lock);\n}\n\nstatic int arizona_hpdet_wait(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tunsigned int val;\n\tint i, ret;\n\n\tfor (i = 0; i < ARIZONA_HPDET_WAIT_COUNT; i++) {\n\t\tret = regmap_read(arizona->regmap, ARIZONA_HEADPHONE_DETECT_2,\n\t\t\t\t&val);\n\t\tif (ret) {\n\t\t\tdev_err(arizona->dev, \"Failed to read HPDET state: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tswitch (info->hpdet_ip_version) {\n\t\tcase 0:\n\t\t\tif (val & ARIZONA_HP_DONE)\n\t\t\t\treturn 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif (val & ARIZONA_HP_DONE_B)\n\t\t\t\treturn 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tmsleep(ARIZONA_HPDET_WAIT_DELAY_MS);\n\t}\n\n\tdev_warn(arizona->dev, \"HPDET did not appear to complete\\n\");\n\n\treturn -ETIMEDOUT;\n}\n\nstatic irqreturn_t arizona_jackdet(int irq, void *data)\n{\n\tstruct arizona_priv *info = data;\n\tstruct arizona *arizona = info->arizona;\n\tunsigned int val, present, mask;\n\tbool cancelled_hp, cancelled_mic;\n\tint ret, i;\n\n\tcancelled_hp = cancel_delayed_work_sync(&info->hpdet_work);\n\tcancelled_mic = cancel_delayed_work_sync(&info->micd_timeout_work);\n\n\tpm_runtime_get_sync(arizona->dev);\n\n\tmutex_lock(&info->lock);\n\n\tif (info->micd_clamp) {\n\t\tmask = ARIZONA_MICD_CLAMP_STS;\n\t\tpresent = 0;\n\t} else {\n\t\tmask = ARIZONA_JD1_STS;\n\t\tif (arizona->pdata.jd_invert)\n\t\t\tpresent = 0;\n\t\telse\n\t\t\tpresent = ARIZONA_JD1_STS;\n\t}\n\n\tret = regmap_read(arizona->regmap, ARIZONA_AOD_IRQ_RAW_STATUS, &val);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to read jackdet status: %d\\n\", ret);\n\t\tmutex_unlock(&info->lock);\n\t\tpm_runtime_put_autosuspend(arizona->dev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tval &= mask;\n\tif (val == info->last_jackdet) {\n\t\tdev_dbg(arizona->dev, \"Suppressing duplicate JACKDET\\n\");\n\t\tif (cancelled_hp)\n\t\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t\t   &info->hpdet_work,\n\t\t\t\t\t   msecs_to_jiffies(HPDET_DEBOUNCE));\n\n\t\tif (cancelled_mic) {\n\t\t\tint micd_timeout = arizona->pdata.micd_timeout;\n\n\t\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t\t   &info->micd_timeout_work,\n\t\t\t\t\t   msecs_to_jiffies(micd_timeout));\n\t\t}\n\n\t\tgoto out;\n\t}\n\tinfo->last_jackdet = val;\n\n\tif (info->last_jackdet == present) {\n\t\tdev_dbg(arizona->dev, \"Detected jack\\n\");\n\t\tsnd_soc_jack_report(info->jack, SND_JACK_MECHANICAL, SND_JACK_MECHANICAL);\n\n\t\tinfo->detecting = true;\n\t\tinfo->mic = false;\n\t\tinfo->jack_flips = 0;\n\n\t\tif (!arizona->pdata.hpdet_acc_id) {\n\t\t\tarizona_start_mic(info);\n\t\t} else {\n\t\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t\t   &info->hpdet_work,\n\t\t\t\t\t   msecs_to_jiffies(HPDET_DEBOUNCE));\n\t\t}\n\n\t\tif (info->micd_clamp || !arizona->pdata.jd_invert)\n\t\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t\t   ARIZONA_JACK_DETECT_DEBOUNCE,\n\t\t\t\t\t   ARIZONA_MICD_CLAMP_DB |\n\t\t\t\t\t   ARIZONA_JD1_DB, 0);\n\t} else {\n\t\tdev_dbg(arizona->dev, \"Detected jack removal\\n\");\n\n\t\tarizona_stop_mic(info);\n\n\t\tinfo->num_hpdet_res = 0;\n\t\tfor (i = 0; i < ARRAY_SIZE(info->hpdet_res); i++)\n\t\t\tinfo->hpdet_res[i] = 0;\n\t\tinfo->mic = false;\n\t\tinfo->hpdet_done = false;\n\t\tinfo->hpdet_retried = false;\n\n\t\tsnd_soc_jack_report(info->jack, 0, ARIZONA_JACK_MASK | info->micd_button_mask);\n\n\t\t \n\t\tarizona_hpdet_wait(info);\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_JACK_DETECT_DEBOUNCE,\n\t\t\t\t   ARIZONA_MICD_CLAMP_DB | ARIZONA_JD1_DB,\n\t\t\t\t   ARIZONA_MICD_CLAMP_DB | ARIZONA_JD1_DB);\n\t}\n\nout:\n\t \n\tregmap_write(arizona->regmap, ARIZONA_AOD_WKUP_AND_TRIG,\n\t\t     ARIZONA_MICD_CLAMP_FALL_TRIG_STS |\n\t\t     ARIZONA_MICD_CLAMP_RISE_TRIG_STS |\n\t\t     ARIZONA_JD1_FALL_TRIG_STS |\n\t\t     ARIZONA_JD1_RISE_TRIG_STS);\n\n\tmutex_unlock(&info->lock);\n\n\tpm_runtime_mark_last_busy(arizona->dev);\n\tpm_runtime_put_autosuspend(arizona->dev);\n\n\treturn IRQ_HANDLED;\n}\n\n \nstatic void arizona_micd_set_level(struct arizona *arizona, int index,\n\t\t\t\t   unsigned int level)\n{\n\tint reg;\n\tunsigned int mask;\n\n\treg = ARIZONA_MIC_DETECT_LEVEL_4 - (index / 2);\n\n\tif (!(index % 2)) {\n\t\tmask = 0x3f00;\n\t\tlevel <<= 8;\n\t} else {\n\t\tmask = 0x3f;\n\t}\n\n\t \n\tregmap_update_bits(arizona->regmap, reg, mask, level);\n}\n\nstatic int arizona_extcon_get_micd_configs(struct device *dev,\n\t\t\t\t\t   struct arizona *arizona)\n{\n\tconst char * const prop = \"wlf,micd-configs\";\n\tconst int entries_per_config = 3;\n\tstruct arizona_micd_config *micd_configs;\n\tint nconfs, ret;\n\tint i, j;\n\tu32 *vals;\n\n\tnconfs = device_property_count_u32(arizona->dev, prop);\n\tif (nconfs <= 0)\n\t\treturn 0;\n\n\tvals = kcalloc(nconfs, sizeof(u32), GFP_KERNEL);\n\tif (!vals)\n\t\treturn -ENOMEM;\n\n\tret = device_property_read_u32_array(arizona->dev, prop, vals, nconfs);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tnconfs /= entries_per_config;\n\tmicd_configs = devm_kcalloc(dev, nconfs, sizeof(*micd_configs),\n\t\t\t\t    GFP_KERNEL);\n\tif (!micd_configs) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tfor (i = 0, j = 0; i < nconfs; ++i) {\n\t\tmicd_configs[i].src = vals[j++] ? ARIZONA_ACCDET_SRC : 0;\n\t\tmicd_configs[i].bias = vals[j++];\n\t\tmicd_configs[i].gpio = vals[j++];\n\t}\n\n\tarizona->pdata.micd_configs = micd_configs;\n\tarizona->pdata.num_micd_configs = nconfs;\n\nout:\n\tkfree(vals);\n\treturn ret;\n}\n\nstatic int arizona_extcon_device_get_pdata(struct device *dev,\n\t\t\t\t\t   struct arizona *arizona)\n{\n\tstruct arizona_pdata *pdata = &arizona->pdata;\n\tunsigned int val = ARIZONA_ACCDET_MODE_HPL;\n\tint ret;\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,hpdet-channel\", &val);\n\tswitch (val) {\n\tcase ARIZONA_ACCDET_MODE_HPL:\n\tcase ARIZONA_ACCDET_MODE_HPR:\n\t\tpdata->hpdet_channel = val;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(arizona->dev, \"Wrong wlf,hpdet-channel DT value %d\\n\", val);\n\t\tpdata->hpdet_channel = ARIZONA_ACCDET_MODE_HPL;\n\t}\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,micd-detect-debounce\",\n\t\t\t\t &pdata->micd_detect_debounce);\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,micd-bias-start-time\",\n\t\t\t\t &pdata->micd_bias_start_time);\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,micd-rate\",\n\t\t\t\t &pdata->micd_rate);\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,micd-dbtime\",\n\t\t\t\t &pdata->micd_dbtime);\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,micd-timeout-ms\",\n\t\t\t\t &pdata->micd_timeout);\n\n\tpdata->micd_force_micbias = device_property_read_bool(arizona->dev,\n\t\t\t\t\t\t\"wlf,micd-force-micbias\");\n\n\tpdata->micd_software_compare = device_property_read_bool(arizona->dev,\n\t\t\t\t\t\t\"wlf,micd-software-compare\");\n\n\tpdata->jd_invert = device_property_read_bool(arizona->dev,\n\t\t\t\t\t\t     \"wlf,jd-invert\");\n\n\tdevice_property_read_u32(arizona->dev, \"wlf,gpsw\", &pdata->gpsw);\n\n\tpdata->jd_gpio5 = device_property_read_bool(arizona->dev,\n\t\t\t\t\t\t    \"wlf,use-jd2\");\n\tpdata->jd_gpio5_nopull = device_property_read_bool(arizona->dev,\n\t\t\t\t\t\t\"wlf,use-jd2-nopull\");\n\n\tret = arizona_extcon_get_micd_configs(dev, arizona);\n\tif (ret < 0)\n\t\tdev_err(arizona->dev, \"Failed to read micd configs: %d\\n\", ret);\n\n\treturn 0;\n}\n\nint arizona_jack_codec_dev_probe(struct arizona_priv *info, struct device *dev)\n{\n\tstruct arizona *arizona = info->arizona;\n\tstruct arizona_pdata *pdata = &arizona->pdata;\n\tint ret, mode;\n\n\tif (!dev_get_platdata(arizona->dev))\n\t\tarizona_extcon_device_get_pdata(dev, arizona);\n\n\tinfo->micvdd = devm_regulator_get(dev, \"MICVDD\");\n\tif (IS_ERR(info->micvdd))\n\t\treturn dev_err_probe(arizona->dev, PTR_ERR(info->micvdd), \"getting MICVDD\\n\");\n\n\tmutex_init(&info->lock);\n\tinfo->last_jackdet = ~(ARIZONA_MICD_CLAMP_STS | ARIZONA_JD1_STS);\n\tINIT_DELAYED_WORK(&info->hpdet_work, arizona_hpdet_work);\n\tINIT_DELAYED_WORK(&info->micd_detect_work, arizona_micd_detect);\n\tINIT_DELAYED_WORK(&info->micd_timeout_work, arizona_micd_timeout_work);\n\n\tswitch (arizona->type) {\n\tcase WM5102:\n\t\tswitch (arizona->rev) {\n\t\tcase 0:\n\t\t\tinfo->micd_reva = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tinfo->micd_clamp = true;\n\t\t\tinfo->hpdet_ip_version = 1;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase WM5110:\n\tcase WM8280:\n\t\tswitch (arizona->rev) {\n\t\tcase 0 ... 2:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tinfo->micd_clamp = true;\n\t\t\tinfo->hpdet_ip_version = 2;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase WM8998:\n\tcase WM1814:\n\t\tinfo->micd_clamp = true;\n\t\tinfo->hpdet_ip_version = 2;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (!pdata->micd_timeout)\n\t\tpdata->micd_timeout = DEFAULT_MICD_TIMEOUT;\n\n\tif (pdata->num_micd_configs) {\n\t\tinfo->micd_modes = pdata->micd_configs;\n\t\tinfo->micd_num_modes = pdata->num_micd_configs;\n\t} else {\n\t\tinfo->micd_modes = micd_default_modes;\n\t\tinfo->micd_num_modes = ARRAY_SIZE(micd_default_modes);\n\t}\n\n\tif (arizona->pdata.gpsw > 0)\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_GP_SWITCH_1,\n\t\t\t\tARIZONA_SW1_MODE_MASK, arizona->pdata.gpsw);\n\n\tif (pdata->micd_pol_gpio > 0) {\n\t\tif (info->micd_modes[0].gpio)\n\t\t\tmode = GPIOF_OUT_INIT_HIGH;\n\t\telse\n\t\t\tmode = GPIOF_OUT_INIT_LOW;\n\n\t\tret = devm_gpio_request_one(dev, pdata->micd_pol_gpio,\n\t\t\t\t\t    mode, \"MICD polarity\");\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to request GPIO%d: %d\\n\",\n\t\t\t\tpdata->micd_pol_gpio, ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tinfo->micd_pol_gpio = gpio_to_desc(pdata->micd_pol_gpio);\n\t} else {\n\t\tif (info->micd_modes[0].gpio)\n\t\t\tmode = GPIOD_OUT_HIGH;\n\t\telse\n\t\t\tmode = GPIOD_OUT_LOW;\n\n\t\t \n\t\tinfo->micd_pol_gpio = gpiod_get_optional(arizona->dev,\n\t\t\t\t\t\t\t \"wlf,micd-pol\",\n\t\t\t\t\t\t\t mode);\n\t\tif (IS_ERR(info->micd_pol_gpio)) {\n\t\t\tret = PTR_ERR(info->micd_pol_gpio);\n\t\t\tdev_err_probe(arizona->dev, ret, \"getting microphone polarity GPIO\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (arizona->pdata.hpdet_id_gpio > 0) {\n\t\tret = devm_gpio_request_one(dev, arizona->pdata.hpdet_id_gpio,\n\t\t\t\t\t    GPIOF_OUT_INIT_LOW,\n\t\t\t\t\t    \"HPDET\");\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to request GPIO%d: %d\\n\",\n\t\t\t\tarizona->pdata.hpdet_id_gpio, ret);\n\t\t\tgpiod_put(info->micd_pol_gpio);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_jack_codec_dev_probe);\n\nint arizona_jack_codec_dev_remove(struct arizona_priv *info)\n{\n\tgpiod_put(info->micd_pol_gpio);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_jack_codec_dev_remove);\n\nstatic int arizona_jack_enable_jack_detect(struct arizona_priv *info,\n\t\t\t\t\t   struct snd_soc_jack *jack)\n{\n\tstruct arizona *arizona = info->arizona;\n\tstruct arizona_pdata *pdata = &arizona->pdata;\n\tunsigned int val;\n\tunsigned int clamp_mode;\n\tint jack_irq_fall, jack_irq_rise;\n\tint ret, i, j;\n\n\tif (arizona->pdata.micd_bias_start_time)\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t   ARIZONA_MICD_BIAS_STARTTIME_MASK,\n\t\t\t\t   arizona->pdata.micd_bias_start_time\n\t\t\t\t   << ARIZONA_MICD_BIAS_STARTTIME_SHIFT);\n\n\tif (arizona->pdata.micd_rate)\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t   ARIZONA_MICD_RATE_MASK,\n\t\t\t\t   arizona->pdata.micd_rate\n\t\t\t\t   << ARIZONA_MICD_RATE_SHIFT);\n\n\tswitch (arizona->pdata.micd_dbtime) {\n\tcase MICD_DBTIME_FOUR_READINGS:\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t   ARIZONA_MICD_DBTIME_MASK,\n\t\t\t\t   ARIZONA_MICD_DBTIME);\n\t\tbreak;\n\tcase MICD_DBTIME_TWO_READINGS:\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t   ARIZONA_MICD_DBTIME_MASK, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tBUILD_BUG_ON(ARRAY_SIZE(arizona_micd_levels) <\n\t\t     ARIZONA_NUM_MICD_BUTTON_LEVELS);\n\n\tif (arizona->pdata.num_micd_ranges) {\n\t\tinfo->micd_ranges = pdata->micd_ranges;\n\t\tinfo->num_micd_ranges = pdata->num_micd_ranges;\n\t} else {\n\t\tinfo->micd_ranges = micd_default_ranges;\n\t\tinfo->num_micd_ranges = ARRAY_SIZE(micd_default_ranges);\n\t}\n\n\tif (arizona->pdata.num_micd_ranges > ARIZONA_MAX_MICD_BUTTONS) {\n\t\tdev_err(arizona->dev, \"Too many MICD ranges: %d > %d\\n\",\n\t\t\tarizona->pdata.num_micd_ranges, ARIZONA_MAX_MICD_BUTTONS);\n\t\treturn -EINVAL;\n\t}\n\n\tif (info->num_micd_ranges > 1) {\n\t\tfor (i = 1; i < info->num_micd_ranges; i++) {\n\t\t\tif (info->micd_ranges[i - 1].max >\n\t\t\t    info->micd_ranges[i].max) {\n\t\t\t\tdev_err(arizona->dev, \"MICD ranges must be sorted\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_2,\n\t\t\t   ARIZONA_MICD_LVL_SEL_MASK, 0x81);\n\n\t \n\tfor (i = 0; i < info->num_micd_ranges; i++) {\n\t\tfor (j = 0; j < ARIZONA_NUM_MICD_BUTTON_LEVELS; j++)\n\t\t\tif (arizona_micd_levels[j] >= info->micd_ranges[i].max)\n\t\t\t\tbreak;\n\n\t\tif (j == ARIZONA_NUM_MICD_BUTTON_LEVELS) {\n\t\t\tdev_err(arizona->dev, \"Unsupported MICD level %d\\n\",\n\t\t\t\tinfo->micd_ranges[i].max);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tdev_dbg(arizona->dev, \"%d ohms for MICD threshold %d\\n\",\n\t\t\tarizona_micd_levels[j], i);\n\n\t\tarizona_micd_set_level(arizona, i, j);\n\n\t\t \n\t\tinfo->micd_button_mask |= SND_JACK_BTN_0 >> i;\n\t\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0 >> i,\n\t\t\t\t info->micd_ranges[i].key);\n\n\t\t \n\t\tregmap_update_bits(arizona->regmap, ARIZONA_MIC_DETECT_2,\n\t\t\t\t   1 << i, 1 << i);\n\t}\n\n\t \n\tfor (; i < ARIZONA_MAX_MICD_RANGE; i++)\n\t\tarizona_micd_set_level(arizona, i, 0x3f);\n\n\t \n\tif (info->micd_clamp) {\n\t\tif (arizona->pdata.jd_gpio5) {\n\t\t\t \n\t\t\tval = 0xc101;\n\t\t\tif (arizona->pdata.jd_gpio5_nopull)\n\t\t\t\tval &= ~ARIZONA_GPN_PU;\n\n\t\t\tregmap_write(arizona->regmap, ARIZONA_GPIO5_CTRL,\n\t\t\t\t     val);\n\n\t\t\tif (arizona->pdata.jd_invert)\n\t\t\t\tclamp_mode = ARIZONA_MICD_CLAMP_MODE_JDH_GP5H;\n\t\t\telse\n\t\t\t\tclamp_mode = ARIZONA_MICD_CLAMP_MODE_JDL_GP5H;\n\t\t} else {\n\t\t\tif (arizona->pdata.jd_invert)\n\t\t\t\tclamp_mode = ARIZONA_MICD_CLAMP_MODE_JDH;\n\t\t\telse\n\t\t\t\tclamp_mode = ARIZONA_MICD_CLAMP_MODE_JDL;\n\t\t}\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_MICD_CLAMP_CONTROL,\n\t\t\t\t   ARIZONA_MICD_CLAMP_MODE_MASK, clamp_mode);\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_JACK_DETECT_DEBOUNCE,\n\t\t\t\t   ARIZONA_MICD_CLAMP_DB,\n\t\t\t\t   ARIZONA_MICD_CLAMP_DB);\n\t}\n\n\tarizona_extcon_set_mode(info, 0);\n\n\tinfo->jack = jack;\n\n\tpm_runtime_get_sync(arizona->dev);\n\n\tif (info->micd_clamp) {\n\t\tjack_irq_rise = ARIZONA_IRQ_MICD_CLAMP_RISE;\n\t\tjack_irq_fall = ARIZONA_IRQ_MICD_CLAMP_FALL;\n\t} else {\n\t\tjack_irq_rise = ARIZONA_IRQ_JD_RISE;\n\t\tjack_irq_fall = ARIZONA_IRQ_JD_FALL;\n\t}\n\n\tret = arizona_request_irq(arizona, jack_irq_rise,\n\t\t\t\t  \"JACKDET rise\", arizona_jackdet, info);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to get JACKDET rise IRQ: %d\\n\", ret);\n\t\tgoto err_pm;\n\t}\n\n\tret = arizona_set_irq_wake(arizona, jack_irq_rise, 1);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to set JD rise IRQ wake: %d\\n\", ret);\n\t\tgoto err_rise;\n\t}\n\n\tret = arizona_request_irq(arizona, jack_irq_fall,\n\t\t\t\t  \"JACKDET fall\", arizona_jackdet, info);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to get JD fall IRQ: %d\\n\", ret);\n\t\tgoto err_rise_wake;\n\t}\n\n\tret = arizona_set_irq_wake(arizona, jack_irq_fall, 1);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to set JD fall IRQ wake: %d\\n\", ret);\n\t\tgoto err_fall;\n\t}\n\n\tret = arizona_request_irq(arizona, ARIZONA_IRQ_MICDET,\n\t\t\t\t  \"MICDET\", arizona_micdet, info);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to get MICDET IRQ: %d\\n\", ret);\n\t\tgoto err_fall_wake;\n\t}\n\n\tret = arizona_request_irq(arizona, ARIZONA_IRQ_HPDET,\n\t\t\t\t  \"HPDET\", arizona_hpdet_irq, info);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to get HPDET IRQ: %d\\n\", ret);\n\t\tgoto err_micdet;\n\t}\n\n\tarizona_clk32k_enable(arizona);\n\tregmap_update_bits(arizona->regmap, ARIZONA_JACK_DETECT_DEBOUNCE,\n\t\t\t   ARIZONA_JD1_DB, ARIZONA_JD1_DB);\n\tregmap_update_bits(arizona->regmap, ARIZONA_JACK_DETECT_ANALOGUE,\n\t\t\t   ARIZONA_JD1_ENA, ARIZONA_JD1_ENA);\n\n\tret = regulator_allow_bypass(info->micvdd, true);\n\tif (ret != 0)\n\t\tdev_warn(arizona->dev, \"Failed to set MICVDD to bypass: %d\\n\", ret);\n\n\tpm_runtime_put(arizona->dev);\n\n\treturn 0;\n\nerr_micdet:\n\tarizona_free_irq(arizona, ARIZONA_IRQ_MICDET, info);\nerr_fall_wake:\n\tarizona_set_irq_wake(arizona, jack_irq_fall, 0);\nerr_fall:\n\tarizona_free_irq(arizona, jack_irq_fall, info);\nerr_rise_wake:\n\tarizona_set_irq_wake(arizona, jack_irq_rise, 0);\nerr_rise:\n\tarizona_free_irq(arizona, jack_irq_rise, info);\nerr_pm:\n\tpm_runtime_put(arizona->dev);\n\tinfo->jack = NULL;\n\treturn ret;\n}\n\nstatic int arizona_jack_disable_jack_detect(struct arizona_priv *info)\n{\n\tstruct arizona *arizona = info->arizona;\n\tint jack_irq_rise, jack_irq_fall;\n\tbool change;\n\tint ret;\n\n\tif (!info->jack)\n\t\treturn 0;\n\n\tif (info->micd_clamp) {\n\t\tjack_irq_rise = ARIZONA_IRQ_MICD_CLAMP_RISE;\n\t\tjack_irq_fall = ARIZONA_IRQ_MICD_CLAMP_FALL;\n\t} else {\n\t\tjack_irq_rise = ARIZONA_IRQ_JD_RISE;\n\t\tjack_irq_fall = ARIZONA_IRQ_JD_FALL;\n\t}\n\n\tarizona_set_irq_wake(arizona, jack_irq_rise, 0);\n\tarizona_set_irq_wake(arizona, jack_irq_fall, 0);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_HPDET, info);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_MICDET, info);\n\tarizona_free_irq(arizona, jack_irq_rise, info);\n\tarizona_free_irq(arizona, jack_irq_fall, info);\n\tcancel_delayed_work_sync(&info->hpdet_work);\n\tcancel_delayed_work_sync(&info->micd_detect_work);\n\tcancel_delayed_work_sync(&info->micd_timeout_work);\n\n\tret = regmap_update_bits_check(arizona->regmap, ARIZONA_MIC_DETECT_1,\n\t\t\t\t       ARIZONA_MICD_ENA, 0,\n\t\t\t\t       &change);\n\tif (ret < 0) {\n\t\tdev_err(arizona->dev, \"Failed to disable micd on remove: %d\\n\", ret);\n\t} else if (change) {\n\t\tregulator_disable(info->micvdd);\n\t\tpm_runtime_put(arizona->dev);\n\t}\n\n\tregmap_update_bits(arizona->regmap,\n\t\t\t   ARIZONA_MICD_CLAMP_CONTROL,\n\t\t\t   ARIZONA_MICD_CLAMP_MODE_MASK, 0);\n\tregmap_update_bits(arizona->regmap, ARIZONA_JACK_DETECT_ANALOGUE,\n\t\t\t   ARIZONA_JD1_ENA, 0);\n\tarizona_clk32k_disable(arizona);\n\tinfo->jack = NULL;\n\n\treturn 0;\n}\n\nint arizona_jack_set_jack(struct snd_soc_component *component,\n\t\t\t  struct snd_soc_jack *jack, void *data)\n{\n\tstruct arizona_priv *info = snd_soc_component_get_drvdata(component);\n\n\tif (jack)\n\t\treturn arizona_jack_enable_jack_detect(info, jack);\n\telse\n\t\treturn arizona_jack_disable_jack_detect(info);\n}\nEXPORT_SYMBOL_GPL(arizona_jack_set_jack);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}