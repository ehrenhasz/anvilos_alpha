{
  "module_name": "cs42l43.c",
  "hash_id": "aa299d49eda0f093a948500580433289cac415b646462ad868b84878c940b47d",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/cs42l43.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/bitops.h>\n#include <linux/err.h>\n#include <linux/errno.h>\n#include <linux/gcd.h>\n#include <linux/irq.h>\n#include <linux/jiffies.h>\n#include <linux/mfd/cs42l43.h>\n#include <linux/mfd/cs42l43-regs.h>\n#include <linux/module.h>\n#include <linux/pm_runtime.h>\n#include <linux/string.h>\n#include <sound/control.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc-component.h>\n#include <sound/soc-dapm.h>\n#include <sound/soc-dai.h>\n#include <sound/soc.h>\n#include <sound/tlv.h>\n\n#include \"cs42l43.h\"\n\n#define CS42L43_DECL_MUX(name, reg) \\\nstatic SOC_VALUE_ENUM_SINGLE_DECL(cs42l43_##name##_enum, reg, \\\n\t\t\t\t  0, CS42L43_MIXER_SRC_MASK, \\\n\t\t\t\t  cs42l43_mixer_texts, cs42l43_mixer_values); \\\nstatic const struct snd_kcontrol_new cs42l43_##name##_mux = \\\n\t\tSOC_DAPM_ENUM(\"Route\", cs42l43_##name##_enum)\n\n#define CS42L43_DECL_MIXER(name, reg) \\\n\tCS42L43_DECL_MUX(name##_in1, reg); \\\n\tCS42L43_DECL_MUX(name##_in2, reg + 0x4); \\\n\tCS42L43_DECL_MUX(name##_in3, reg + 0x8); \\\n\tCS42L43_DECL_MUX(name##_in4, reg + 0xC)\n\n#define CS42L43_DAPM_MUX(name_str, name) \\\n\tSND_SOC_DAPM_MUX(name_str \" Input\", SND_SOC_NOPM, 0, 0, &cs42l43_##name##_mux)\n\n#define CS42L43_DAPM_MIXER(name_str, name) \\\n\tSND_SOC_DAPM_MUX(name_str \" Input 1\", SND_SOC_NOPM, 0, 0, &cs42l43_##name##_in1_mux), \\\n\tSND_SOC_DAPM_MUX(name_str \" Input 2\", SND_SOC_NOPM, 0, 0, &cs42l43_##name##_in2_mux), \\\n\tSND_SOC_DAPM_MUX(name_str \" Input 3\", SND_SOC_NOPM, 0, 0, &cs42l43_##name##_in3_mux), \\\n\tSND_SOC_DAPM_MUX(name_str \" Input 4\", SND_SOC_NOPM, 0, 0, &cs42l43_##name##_in4_mux), \\\n\tSND_SOC_DAPM_MIXER(name_str \" Mixer\", SND_SOC_NOPM, 0, 0, NULL, 0)\n\n#define CS42L43_BASE_ROUTES(name_str) \\\n\t{ name_str,\t\t\"Tone Generator 1\",\t\"Tone 1\" }, \\\n\t{ name_str,\t\t\"Tone Generator 2\",\t\"Tone 2\" }, \\\n\t{ name_str,\t\t\"Decimator 1\",\t\t\"Decimator 1\" }, \\\n\t{ name_str,\t\t\"Decimator 2\",\t\t\"Decimator 2\" }, \\\n\t{ name_str,\t\t\"Decimator 3\",\t\t\"Decimator 3\" }, \\\n\t{ name_str,\t\t\"Decimator 4\",\t\t\"Decimator 4\" }, \\\n\t{ name_str,\t\t\"ASPRX1\",\t\t\"ASPRX1\" }, \\\n\t{ name_str,\t\t\"ASPRX2\",\t\t\"ASPRX2\" }, \\\n\t{ name_str,\t\t\"ASPRX3\",\t\t\"ASPRX3\" }, \\\n\t{ name_str,\t\t\"ASPRX4\",\t\t\"ASPRX4\" }, \\\n\t{ name_str,\t\t\"ASPRX5\",\t\t\"ASPRX5\" }, \\\n\t{ name_str,\t\t\"ASPRX6\",\t\t\"ASPRX6\" }, \\\n\t{ name_str,\t\t\"DP5RX1\",\t\t\"DP5RX1\" }, \\\n\t{ name_str,\t\t\"DP5RX2\",\t\t\"DP5RX2\" }, \\\n\t{ name_str,\t\t\"DP6RX1\",\t\t\"DP6RX1\" }, \\\n\t{ name_str,\t\t\"DP6RX2\",\t\t\"DP6RX2\" }, \\\n\t{ name_str,\t\t\"DP7RX1\",\t\t\"DP7RX1\" }, \\\n\t{ name_str,\t\t\"DP7RX2\",\t\t\"DP7RX2\" }, \\\n\t{ name_str,\t\t\"ASRC INT1\",\t\t\"ASRC_INT1\" }, \\\n\t{ name_str,\t\t\"ASRC INT2\",\t\t\"ASRC_INT2\" }, \\\n\t{ name_str,\t\t\"ASRC INT3\",\t\t\"ASRC_INT3\" }, \\\n\t{ name_str,\t\t\"ASRC INT4\",\t\t\"ASRC_INT4\" }, \\\n\t{ name_str,\t\t\"ASRC DEC1\",\t\t\"ASRC_DEC1\" }, \\\n\t{ name_str,\t\t\"ASRC DEC2\",\t\t\"ASRC_DEC2\" }, \\\n\t{ name_str,\t\t\"ASRC DEC3\",\t\t\"ASRC_DEC3\" }, \\\n\t{ name_str,\t\t\"ASRC DEC4\",\t\t\"ASRC_DEC4\" }, \\\n\t{ name_str,\t\t\"ISRC1 INT1\",\t\t\"ISRC1INT1\" }, \\\n\t{ name_str,\t\t\"ISRC1 INT2\",\t\t\"ISRC1INT2\" }, \\\n\t{ name_str,\t\t\"ISRC1 DEC1\",\t\t\"ISRC1DEC1\" }, \\\n\t{ name_str,\t\t\"ISRC1 DEC2\",\t\t\"ISRC1DEC2\" }, \\\n\t{ name_str,\t\t\"ISRC2 INT1\",\t\t\"ISRC2INT1\" }, \\\n\t{ name_str,\t\t\"ISRC2 INT2\",\t\t\"ISRC2INT2\" }, \\\n\t{ name_str,\t\t\"ISRC2 DEC1\",\t\t\"ISRC2DEC1\" }, \\\n\t{ name_str,\t\t\"ISRC2 DEC2\",\t\t\"ISRC2DEC2\" }, \\\n\t{ name_str,\t\t\"EQ1\",\t\t\t\"EQ\" }, \\\n\t{ name_str,\t\t\"EQ2\",\t\t\t\"EQ\" }\n\n#define CS42L43_MUX_ROUTES(name_str, widget) \\\n\t{ widget,\t\tNULL,\t\t\tname_str \" Input\" }, \\\n\t{ name_str \" Input\",\tNULL,\t\t\t\"Mixer Core\" }, \\\n\tCS42L43_BASE_ROUTES(name_str \" Input\")\n\n#define CS42L43_MIXER_ROUTES(name_str, widget) \\\n\t{ name_str \" Mixer\",\tNULL,\t\t\tname_str \" Input 1\" }, \\\n\t{ name_str \" Mixer\",\tNULL,\t\t\tname_str \" Input 2\" }, \\\n\t{ name_str \" Mixer\",\tNULL,\t\t\tname_str \" Input 3\" }, \\\n\t{ name_str \" Mixer\",\tNULL,\t\t\tname_str \" Input 4\" }, \\\n\t{ widget,\t\tNULL,\t\t\tname_str \" Mixer\" }, \\\n\t{ name_str \" Mixer\",\tNULL,\t\t\t\"Mixer Core\" }, \\\n\tCS42L43_BASE_ROUTES(name_str \" Input 1\"), \\\n\tCS42L43_BASE_ROUTES(name_str \" Input 2\"), \\\n\tCS42L43_BASE_ROUTES(name_str \" Input 3\"), \\\n\tCS42L43_BASE_ROUTES(name_str \" Input 4\")\n\n#define CS42L43_MIXER_VOLUMES(name_str, base) \\\n\tSOC_SINGLE_RANGE_TLV(name_str \" Input 1 Volume\", base, \\\n\t\t\t     CS42L43_MIXER_VOL_SHIFT, 0x20, 0x50, 0, \\\n\t\t\t     cs42l43_mixer_tlv), \\\n\tSOC_SINGLE_RANGE_TLV(name_str \" Input 2 Volume\", base + 4, \\\n\t\t\t     CS42L43_MIXER_VOL_SHIFT, 0x20, 0x50, 0, \\\n\t\t\t     cs42l43_mixer_tlv), \\\n\tSOC_SINGLE_RANGE_TLV(name_str \" Input 3 Volume\", base + 8, \\\n\t\t\t     CS42L43_MIXER_VOL_SHIFT, 0x20, 0x50, 0, \\\n\t\t\t     cs42l43_mixer_tlv), \\\n\tSOC_SINGLE_RANGE_TLV(name_str \" Input 4 Volume\", base + 12, \\\n\t\t\t     CS42L43_MIXER_VOL_SHIFT, 0x20, 0x50, 0, \\\n\t\t\t     cs42l43_mixer_tlv)\n\n#define CS42L43_IRQ_ERROR(name) \\\nstatic irqreturn_t cs42l43_##name(int irq, void *data) \\\n{ \\\n\tstruct cs42l43_codec *priv = data; \\\n\tdev_err(priv->dev, \"Error \" #name \" IRQ\\n\"); \\\n\treturn IRQ_HANDLED; \\\n}\n\nCS42L43_IRQ_ERROR(pll_lost_lock)\nCS42L43_IRQ_ERROR(spkr_clock_stop)\nCS42L43_IRQ_ERROR(spkl_clock_stop)\nCS42L43_IRQ_ERROR(spkr_brown_out)\nCS42L43_IRQ_ERROR(spkl_brown_out)\nCS42L43_IRQ_ERROR(spkr_therm_shutdown)\nCS42L43_IRQ_ERROR(spkl_therm_shutdown)\nCS42L43_IRQ_ERROR(spkr_therm_warm)\nCS42L43_IRQ_ERROR(spkl_therm_warm)\nCS42L43_IRQ_ERROR(spkr_sc_detect)\nCS42L43_IRQ_ERROR(spkl_sc_detect)\nCS42L43_IRQ_ERROR(hp_ilimit)\n\n#define CS42L43_IRQ_COMPLETE(name) \\\nstatic irqreturn_t cs42l43_##name(int irq, void *data) \\\n{ \\\n\tstruct cs42l43_codec *priv = data; \\\n\tdev_dbg(priv->dev, #name \" completed\\n\"); \\\n\tcomplete(&priv->name); \\\n\treturn IRQ_HANDLED; \\\n}\n\nCS42L43_IRQ_COMPLETE(pll_ready)\nCS42L43_IRQ_COMPLETE(hp_startup)\nCS42L43_IRQ_COMPLETE(hp_shutdown)\nCS42L43_IRQ_COMPLETE(type_detect)\nCS42L43_IRQ_COMPLETE(spkr_shutdown)\nCS42L43_IRQ_COMPLETE(spkl_shutdown)\nCS42L43_IRQ_COMPLETE(spkr_startup)\nCS42L43_IRQ_COMPLETE(spkl_startup)\nCS42L43_IRQ_COMPLETE(load_detect)\n\nstatic irqreturn_t cs42l43_mic_shutter(int irq, void *data)\n{\n\tstruct cs42l43_codec *priv = data;\n\tconst char * const controls[] = {\n\t\t\"Decimator 1 Switch\",\n\t\t\"Decimator 2 Switch\",\n\t\t\"Decimator 3 Switch\",\n\t\t\"Decimator 4 Switch\",\n\t};\n\tint i, ret;\n\n\tdev_dbg(priv->dev, \"Microphone shutter changed\\n\");\n\n\tif (!priv->component)\n\t\treturn IRQ_NONE;\n\n\tfor (i = 0; i < ARRAY_SIZE(controls); i++) {\n\t\tret = snd_soc_component_notify_control(priv->component,\n\t\t\t\t\t\t       controls[i]);\n\t\tif (ret)\n\t\t\treturn IRQ_NONE;\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t cs42l43_spk_shutter(int irq, void *data)\n{\n\tstruct cs42l43_codec *priv = data;\n\tint ret;\n\n\tdev_dbg(priv->dev, \"Speaker shutter changed\\n\");\n\n\tif (!priv->component)\n\t\treturn IRQ_NONE;\n\n\tret = snd_soc_component_notify_control(priv->component,\n\t\t\t\t\t       \"Speaker Digital Switch\");\n\tif (ret)\n\t\treturn IRQ_NONE;\n\n\treturn IRQ_HANDLED;\n}\n\nstatic const unsigned int cs42l43_sample_rates[] = {\n\t8000, 16000, 24000, 32000, 44100, 48000, 96000, 192000,\n};\n\n#define CS42L43_CONSUMER_RATE_MASK 0xFF\n#define CS42L43_PROVIDER_RATE_MASK 0xEF \n\nstatic const struct snd_pcm_hw_constraint_list cs42l43_constraint = {\n\t.count\t\t= ARRAY_SIZE(cs42l43_sample_rates),\n\t.list\t\t= cs42l43_sample_rates,\n};\n\nstatic int cs42l43_startup(struct snd_pcm_substream *substream, struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tint provider = !!regmap_test_bits(cs42l43->regmap, CS42L43_ASP_CLK_CONFIG2,\n\t\t\t\t\t  CS42L43_ASP_MASTER_MODE_MASK);\n\n\tif (provider)\n\t\tpriv->constraint.mask = CS42L43_PROVIDER_RATE_MASK;\n\telse\n\t\tpriv->constraint.mask = CS42L43_CONSUMER_RATE_MASK;\n\n\treturn snd_pcm_hw_constraint_list(substream->runtime, 0,\n\t\t\t\t\t  SNDRV_PCM_HW_PARAM_RATE,\n\t\t\t\t\t  &priv->constraint);\n}\n\nstatic int cs42l43_convert_sample_rate(unsigned int rate)\n{\n\tswitch (rate) {\n\tcase 8000:\n\t\treturn 0x11;\n\tcase 16000:\n\t\treturn 0x12;\n\tcase 24000:\n\t\treturn 0x02;\n\tcase 32000:\n\t\treturn 0x13;\n\tcase 44100:\n\t\treturn 0x0B;\n\tcase 48000:\n\t\treturn 0x03;\n\tcase 96000:\n\t\treturn 0x04;\n\tcase 192000:\n\t\treturn 0x05;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int cs42l43_set_sample_rate(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_pcm_hw_params *params,\n\t\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(dai->component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tint ret;\n\n\tret = cs42l43_convert_sample_rate(params_rate(params));\n\tif (ret < 0) {\n\t\tdev_err(priv->dev, \"Failed to convert sample rate: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t\n\tregmap_update_bits(cs42l43->regmap, CS42L43_SAMPLE_RATE1,\n\t\t\t   CS42L43_SAMPLE_RATE_MASK, ret);\n\n\treturn 0;\n}\n\nstatic int cs42l43_asp_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t\t struct snd_soc_dai *dai)\n{\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(dai->component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tint dsp_mode = !!regmap_test_bits(cs42l43->regmap, CS42L43_ASP_CTRL,\n\t\t\t\t\t  CS42L43_ASP_FSYNC_MODE_MASK);\n\tint provider = !!regmap_test_bits(cs42l43->regmap, CS42L43_ASP_CLK_CONFIG2,\n\t\t\t\t\t  CS42L43_ASP_MASTER_MODE_MASK);\n\tint n_chans = params_channels(params);\n\tint data_width = params_width(params);\n\tint n_slots = n_chans;\n\tint slot_width = data_width;\n\tint frame, bclk_target, i;\n\tunsigned int reg;\n\tint *slots;\n\n\tif (priv->n_slots) {\n\t\tn_slots = priv->n_slots;\n\t\tslot_width = priv->slot_width;\n\t}\n\n\tif (!dsp_mode && (n_slots & 0x1)) {\n\t\tdev_dbg(priv->dev, \"Forcing balanced channels on ASP\\n\");\n\t\tn_slots++;\n\t}\n\n\tframe = n_slots * slot_width;\n\tbclk_target = params_rate(params) * frame;\n\n\tif (provider) {\n\t\tunsigned int gcd_nm = gcd(bclk_target, CS42L43_INTERNAL_SYSCLK);\n\t\tint n = bclk_target / gcd_nm;\n\t\tint m = CS42L43_INTERNAL_SYSCLK / gcd_nm;\n\n\t\tif (n > (CS42L43_ASP_BCLK_N_MASK >> CS42L43_ASP_BCLK_N_SHIFT) ||\n\t\t    m > CS42L43_ASP_BCLK_M_MASK) {\n\t\t\tdev_err(priv->dev, \"Can't produce %dHz bclk\\n\", bclk_target);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tdev_dbg(priv->dev, \"bclk %d/%d = %dHz, with %dx%d frame\\n\",\n\t\t\tn, m, bclk_target, n_slots, slot_width);\n\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_CLK_CONFIG1,\n\t\t\t\t   CS42L43_ASP_BCLK_N_MASK | CS42L43_ASP_BCLK_M_MASK,\n\t\t\t\t   n << CS42L43_ASP_BCLK_N_SHIFT |\n\t\t\t\t   m << CS42L43_ASP_BCLK_M_SHIFT);\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_FSYNC_CTRL1,\n\t\t\t\t   CS42L43_ASP_FSYNC_M_MASK, frame);\n\t}\n\n\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_FSYNC_CTRL4,\n\t\t\t   CS42L43_ASP_NUM_BCLKS_PER_FSYNC_MASK,\n\t\t\t   frame << CS42L43_ASP_NUM_BCLKS_PER_FSYNC_SHIFT);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {\n\t\treg = CS42L43_ASP_TX_CH1_CTRL;\n\t\tslots = priv->tx_slots;\n\t} else {\n\t\treg = CS42L43_ASP_RX_CH1_CTRL;\n\t\tslots = priv->rx_slots;\n\t}\n\n\tfor (i = 0; i < n_chans; i++, reg += 4) {\n\t\tint slot_phase = dsp_mode | (i & CS42L43_ASP_CH_SLOT_PHASE_MASK);\n\t\tint slot_pos;\n\n\t\tif (dsp_mode)\n\t\t\tslot_pos = slots[i] * slot_width;\n\t\telse\n\t\t\tslot_pos = (slots[i] / 2) * slot_width;\n\n\t\tdev_dbg(priv->dev, \"Configure channel %d at slot %d (%d,%d)\\n\",\n\t\t\ti, slots[i], slot_pos, slot_phase);\n\n\t\tregmap_update_bits(cs42l43->regmap, reg,\n\t\t\t\t   CS42L43_ASP_CH_WIDTH_MASK |\n\t\t\t\t   CS42L43_ASP_CH_SLOT_MASK |\n\t\t\t\t   CS42L43_ASP_CH_SLOT_PHASE_MASK,\n\t\t\t\t   ((data_width - 1) << CS42L43_ASP_CH_WIDTH_SHIFT) |\n\t\t\t\t   (slot_pos << CS42L43_ASP_CH_SLOT_SHIFT) |\n\t\t\t\t   slot_phase);\n\t}\n\n\treturn cs42l43_set_sample_rate(substream, params, dai);\n}\n\nstatic int cs42l43_asp_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tint provider = regmap_test_bits(cs42l43->regmap, CS42L43_ASP_CLK_CONFIG2,\n\t\t\t\t\tCS42L43_ASP_MASTER_MODE_MASK);\n\tstruct snd_soc_dapm_route routes[] = {\n\t\t{ \"BCLK\", NULL, \"FSYNC\" },\n\t};\n\tunsigned int asp_ctrl = 0;\n\tunsigned int data_ctrl = 0;\n\tunsigned int fsync_ctrl = 0;\n\tunsigned int clk_config = 0;\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tdata_ctrl |= 2 << CS42L43_ASP_FSYNC_FRAME_START_DLY_SHIFT;\n\t\tfallthrough;\n\tcase SND_SOC_DAIFMT_DSP_B:\n\t\tasp_ctrl |= CS42L43_ASP_FSYNC_MODE_MASK;\n\t\tdata_ctrl |= CS42L43_ASP_FSYNC_FRAME_START_PHASE_MASK;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tdata_ctrl |= 2 << CS42L43_ASP_FSYNC_FRAME_START_DLY_SHIFT;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tdata_ctrl |= CS42L43_ASP_FSYNC_FRAME_START_PHASE_MASK;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(priv->dev, \"Unsupported DAI format 0x%x\\n\",\n\t\t\tfmt & SND_SOC_DAIFMT_FORMAT_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_CBC_CFC:\n\t\tif (provider)\n\t\t\tsnd_soc_dapm_del_routes(dapm, routes, ARRAY_SIZE(routes));\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBP_CFP:\n\t\tif (!provider)\n\t\t\tsnd_soc_dapm_add_routes(dapm, routes, ARRAY_SIZE(routes));\n\t\tclk_config |= CS42L43_ASP_MASTER_MODE_MASK;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(priv->dev, \"Unsupported ASP mode 0x%x\\n\",\n\t\t\tfmt & SND_SOC_DAIFMT_MASTER_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tclk_config |= CS42L43_ASP_BCLK_INV_MASK;  \n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\tclk_config |= CS42L43_ASP_BCLK_INV_MASK;\n\t\tfsync_ctrl |= CS42L43_ASP_FSYNC_IN_INV_MASK |\n\t\t\t      CS42L43_ASP_FSYNC_OUT_INV_MASK;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\tfsync_ctrl |= CS42L43_ASP_FSYNC_IN_INV_MASK |\n\t\t\t      CS42L43_ASP_FSYNC_OUT_INV_MASK;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(priv->dev, \"Unsupported invert mode 0x%x\\n\",\n\t\t\tfmt & SND_SOC_DAIFMT_INV_MASK);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_CTRL,\n\t\t\t   CS42L43_ASP_FSYNC_MODE_MASK,\n\t\t\t   asp_ctrl);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_DATA_CTRL,\n\t\t\t   CS42L43_ASP_FSYNC_FRAME_START_DLY_MASK |\n\t\t\t   CS42L43_ASP_FSYNC_FRAME_START_PHASE_MASK,\n\t\t\t   data_ctrl);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_CLK_CONFIG2,\n\t\t\t   CS42L43_ASP_MASTER_MODE_MASK |\n\t\t\t   CS42L43_ASP_BCLK_INV_MASK,\n\t\t\t   clk_config);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_ASP_FSYNC_CTRL3,\n\t\t\t   CS42L43_ASP_FSYNC_IN_INV_MASK |\n\t\t\t   CS42L43_ASP_FSYNC_OUT_INV_MASK,\n\t\t\t   fsync_ctrl);\n\n\treturn 0;\n}\n\nstatic void cs42l43_mask_to_slots(struct cs42l43_codec *priv, unsigned int mask, int *slots)\n{\n\tint i;\n\n\tfor (i = 0; i < CS42L43_ASP_MAX_CHANNELS; ++i) {\n\t\tint slot = ffs(mask) - 1;\n\n\t\tif (slot < 0)\n\t\t\treturn;\n\n\t\tslots[i] = slot;\n\n\t\tmask &= ~(1 << slot);\n\t}\n\n\tif (mask)\n\t\tdev_warn(priv->dev, \"Too many channels in TDM mask\\n\");\n}\n\nstatic int cs42l43_asp_set_tdm_slot(struct snd_soc_dai *dai, unsigned int tx_mask,\n\t\t\t\t    unsigned int rx_mask, int slots, int slot_width)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\n\tpriv->n_slots = slots;\n\tpriv->slot_width = slot_width;\n\n\tif (!slots) {\n\t\ttx_mask = CS42L43_DEFAULT_SLOTS;\n\t\trx_mask = CS42L43_DEFAULT_SLOTS;\n\t}\n\n\tcs42l43_mask_to_slots(priv, tx_mask, priv->tx_slots);\n\tcs42l43_mask_to_slots(priv, rx_mask, priv->rx_slots);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops cs42l43_asp_ops = {\n\t.startup\t= cs42l43_startup,\n\t.hw_params\t= cs42l43_asp_hw_params,\n\t.set_fmt\t= cs42l43_asp_set_fmt,\n\t.set_tdm_slot\t= cs42l43_asp_set_tdm_slot,\n};\n\nstatic int cs42l43_sdw_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t\t struct snd_soc_dai *dai)\n{\n\tint ret;\n\n\tret = cs42l43_sdw_add_peripheral(substream, params, dai);\n\tif (ret)\n\t\treturn ret;\n\n\treturn cs42l43_set_sample_rate(substream, params, dai);\n};\n\nstatic const struct snd_soc_dai_ops cs42l43_sdw_ops = {\n\t.startup\t= cs42l43_startup,\n\t.set_stream\t= cs42l43_sdw_set_stream,\n\t.hw_params\t= cs42l43_sdw_hw_params,\n\t.hw_free\t= cs42l43_sdw_remove_peripheral,\n};\n\n#define CS42L43_ASP_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S24_LE | \\\n\t\t\t     SNDRV_PCM_FMTBIT_S32_LE)\n#define CS42L43_SDW_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S24_LE)\n\nstatic struct snd_soc_dai_driver cs42l43_dais[] = {\n\t{\n\t\t.name\t\t\t= \"cs42l43-asp\",\n\t\t.ops\t\t\t= &cs42l43_asp_ops,\n\t\t.symmetric_rate\t\t= 1,\n\t\t.capture = {\n\t\t\t.stream_name\t= \"ASP Capture\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= CS42L43_ASP_MAX_CHANNELS,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_ASP_FORMATS,\n\t\t},\n\t\t.playback = {\n\t\t\t.stream_name\t= \"ASP Playback\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= CS42L43_ASP_MAX_CHANNELS,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_ASP_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp1\",\n\t\t.id\t\t\t= 1,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.capture = {\n\t\t\t.stream_name\t= \"DP1 Capture\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 4,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp2\",\n\t\t.id\t\t\t= 2,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.capture = {\n\t\t\t.stream_name\t= \"DP2 Capture\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 2,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp3\",\n\t\t.id\t\t\t= 3,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.capture = {\n\t\t\t.stream_name\t= \"DP3 Capture\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 2,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp4\",\n\t\t.id\t\t\t= 4,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.capture = {\n\t\t\t.stream_name\t= \"DP4 Capture\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 2,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp5\",\n\t\t.id\t\t\t= 5,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.playback = {\n\t\t\t.stream_name\t= \"DP5 Playback\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 2,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp6\",\n\t\t.id\t\t\t= 6,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.playback = {\n\t\t\t.stream_name\t= \"DP6 Playback\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 2,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n\t{\n\t\t.name\t\t\t= \"cs42l43-dp7\",\n\t\t.id\t\t\t= 7,\n\t\t.ops\t\t\t= &cs42l43_sdw_ops,\n\t\t.playback = {\n\t\t\t.stream_name\t= \"DP7 Playback\",\n\t\t\t.channels_min\t= 1,\n\t\t\t.channels_max\t= 2,\n\t\t\t.rates\t\t= SNDRV_PCM_RATE_KNOT,\n\t\t\t.formats\t= CS42L43_SDW_FORMATS,\n\t\t},\n\t},\n};\n\nstatic const DECLARE_TLV_DB_SCALE(cs42l43_mixer_tlv, -3200, 100, 0);\n\nstatic const char * const cs42l43_ramp_text[] = {\n\t\"0ms/6dB\", \"0.5ms/6dB\", \"1ms/6dB\", \"2ms/6dB\", \"4ms/6dB\", \"8ms/6dB\",\n\t\"15ms/6dB\", \"30ms/6dB\",\n};\n\nstatic const char * const cs42l43_adc1_input_text[] = { \"IN1\", \"IN2\" };\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_adc1_input, CS42L43_ADC_B_CTRL1,\n\t\t\t    CS42L43_ADC_AIN_SEL_SHIFT,\n\t\t\t    cs42l43_adc1_input_text);\n\nstatic const struct snd_kcontrol_new cs42l43_adc1_input_ctl =\n\tSOC_DAPM_ENUM(\"ADC1 Input\", cs42l43_adc1_input);\n\nstatic const char * const cs42l43_dec_mode_text[] = { \"ADC\", \"PDM\" };\n\nstatic SOC_ENUM_SINGLE_VIRT_DECL(cs42l43_dec1_mode, cs42l43_dec_mode_text);\nstatic SOC_ENUM_SINGLE_VIRT_DECL(cs42l43_dec2_mode, cs42l43_dec_mode_text);\n\nstatic const struct snd_kcontrol_new cs42l43_dec_mode_ctl[] = {\n\tSOC_DAPM_ENUM(\"Decimator 1 Mode\", cs42l43_dec1_mode),\n\tSOC_DAPM_ENUM(\"Decimator 2 Mode\", cs42l43_dec2_mode),\n};\n\nstatic const char * const cs42l43_pdm_clk_text[] = {\n\t\"3.072MHz\", \"1.536MHz\", \"768kHz\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_pdm1_clk, CS42L43_PDM_CONTROL,\n\t\t\t    CS42L43_PDM1_CLK_DIV_SHIFT, cs42l43_pdm_clk_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_pdm2_clk, CS42L43_PDM_CONTROL,\n\t\t\t    CS42L43_PDM2_CLK_DIV_SHIFT, cs42l43_pdm_clk_text);\n\nstatic DECLARE_TLV_DB_SCALE(cs42l43_adc_tlv, -600, 600, 0);\nstatic DECLARE_TLV_DB_SCALE(cs42l43_dec_tlv, -6400, 50, 0);\n\nstatic const char * const cs42l43_wnf_corner_text[] = {\n\t\"160Hz\", \"180Hz\", \"200Hz\", \"220Hz\", \"240Hz\", \"260Hz\", \"280Hz\", \"300Hz\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec1_wnf_corner, CS42L43_DECIM_HPF_WNF_CTRL1,\n\t\t\t    CS42L43_DECIM_WNF_CF_SHIFT, cs42l43_wnf_corner_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec2_wnf_corner, CS42L43_DECIM_HPF_WNF_CTRL2,\n\t\t\t    CS42L43_DECIM_WNF_CF_SHIFT, cs42l43_wnf_corner_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec3_wnf_corner, CS42L43_DECIM_HPF_WNF_CTRL3,\n\t\t\t    CS42L43_DECIM_WNF_CF_SHIFT, cs42l43_wnf_corner_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec4_wnf_corner, CS42L43_DECIM_HPF_WNF_CTRL4,\n\t\t\t    CS42L43_DECIM_WNF_CF_SHIFT, cs42l43_wnf_corner_text);\n\nstatic const char * const cs42l43_hpf_corner_text[] = {\n\t\"3Hz\", \"12Hz\", \"48Hz\", \"96Hz\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec1_hpf_corner, CS42L43_DECIM_HPF_WNF_CTRL1,\n\t\t\t    CS42L43_DECIM_HPF_CF_SHIFT, cs42l43_hpf_corner_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec2_hpf_corner, CS42L43_DECIM_HPF_WNF_CTRL2,\n\t\t\t    CS42L43_DECIM_HPF_CF_SHIFT, cs42l43_hpf_corner_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec3_hpf_corner, CS42L43_DECIM_HPF_WNF_CTRL3,\n\t\t\t    CS42L43_DECIM_HPF_CF_SHIFT, cs42l43_hpf_corner_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec4_hpf_corner, CS42L43_DECIM_HPF_WNF_CTRL4,\n\t\t\t    CS42L43_DECIM_HPF_CF_SHIFT, cs42l43_hpf_corner_text);\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec1_ramp_up, CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t\t    CS42L43_DECIM1_VI_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec1_ramp_down, CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t\t    CS42L43_DECIM1_VD_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec2_ramp_up, CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t\t    CS42L43_DECIM2_VI_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec2_ramp_down, CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t\t    CS42L43_DECIM2_VD_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec3_ramp_up, CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t\t    CS42L43_DECIM3_VI_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec3_ramp_down, CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t\t    CS42L43_DECIM3_VD_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec4_ramp_up, CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t\t    CS42L43_DECIM4_VI_RAMP_SHIFT, cs42l43_ramp_text);\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_dec4_ramp_down, CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t\t    CS42L43_DECIM4_VD_RAMP_SHIFT, cs42l43_ramp_text);\n\nstatic DECLARE_TLV_DB_SCALE(cs42l43_speaker_tlv, -6400, 50, 0);\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_speaker_ramp_up, CS42L43_AMP1_2_VOL_RAMP,\n\t\t\t    CS42L43_AMP1_2_VI_RAMP_SHIFT, cs42l43_ramp_text);\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_speaker_ramp_down, CS42L43_AMP1_2_VOL_RAMP,\n\t\t\t    CS42L43_AMP1_2_VD_RAMP_SHIFT, cs42l43_ramp_text);\n\nstatic DECLARE_TLV_DB_SCALE(cs42l43_headphone_tlv, -11450, 50, 1);\n\nstatic const char * const cs42l43_headphone_ramp_text[] = {\n\t\"1\", \"2\", \"4\", \"6\", \"8\", \"11\", \"12\", \"16\", \"22\", \"24\", \"33\", \"36\", \"44\",\n\t\"48\", \"66\", \"72\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_headphone_ramp, CS42L43_PGAVOL,\n\t\t\t    CS42L43_HP_PATH_VOL_RAMP_SHIFT,\n\t\t\t    cs42l43_headphone_ramp_text);\n\nstatic const char * const cs42l43_tone_freq_text[] = {\n\t\"1kHz\", \"2kHz\", \"4kHz\", \"6kHz\", \"8kHz\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_tone1_freq, CS42L43_TONE_CH1_CTRL,\n\t\t\t    CS42L43_TONE_FREQ_SHIFT, cs42l43_tone_freq_text);\n\nstatic SOC_ENUM_SINGLE_DECL(cs42l43_tone2_freq, CS42L43_TONE_CH2_CTRL,\n\t\t\t    CS42L43_TONE_FREQ_SHIFT, cs42l43_tone_freq_text);\n\nstatic const char * const cs42l43_mixer_texts[] = {\n\t\"None\",\n\t\"Tone Generator 1\", \"Tone Generator 2\",\n\t\"Decimator 1\", \"Decimator 2\", \"Decimator 3\", \"Decimator 4\",\n\t\"ASPRX1\", \"ASPRX2\", \"ASPRX3\", \"ASPRX4\", \"ASPRX5\", \"ASPRX6\",\n\t\"DP5RX1\", \"DP5RX2\", \"DP6RX1\", \"DP6RX2\", \"DP7RX1\", \"DP7RX2\",\n\t\"ASRC INT1\", \"ASRC INT2\", \"ASRC INT3\", \"ASRC INT4\",\n\t\"ASRC DEC1\", \"ASRC DEC2\", \"ASRC DEC3\", \"ASRC DEC4\",\n\t\"ISRC1 INT1\", \"ISRC1 INT2\",\n\t\"ISRC1 DEC1\", \"ISRC1 DEC2\",\n\t\"ISRC2 INT1\", \"ISRC2 INT2\",\n\t\"ISRC2 DEC1\", \"ISRC2 DEC2\",\n\t\"EQ1\", \"EQ2\",\n};\n\nstatic const unsigned int cs42l43_mixer_values[] = {\n\t0x00, \n\t0x04, 0x05, \n\t0x10, 0x11, 0x12, 0x13, \n\t0x20, 0x21, 0x22, 0x23, 0x24, 0x25, \n\t0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, \n\t0x40, 0x41, 0x42, 0x43, \n\t0x44, 0x45, 0x46, 0x47, \n\t0x50, 0x51, \n\t0x52, 0x53, \n\t0x54, 0x55, \n\t0x56, 0x57, \n\t0x58, 0x59, \n};\n\nCS42L43_DECL_MUX(asptx1, CS42L43_ASPTX1_INPUT);\nCS42L43_DECL_MUX(asptx2, CS42L43_ASPTX2_INPUT);\nCS42L43_DECL_MUX(asptx3, CS42L43_ASPTX3_INPUT);\nCS42L43_DECL_MUX(asptx4, CS42L43_ASPTX4_INPUT);\nCS42L43_DECL_MUX(asptx5, CS42L43_ASPTX5_INPUT);\nCS42L43_DECL_MUX(asptx6, CS42L43_ASPTX6_INPUT);\n\nCS42L43_DECL_MUX(dp1tx1, CS42L43_SWIRE_DP1_CH1_INPUT);\nCS42L43_DECL_MUX(dp1tx2, CS42L43_SWIRE_DP1_CH2_INPUT);\nCS42L43_DECL_MUX(dp1tx3, CS42L43_SWIRE_DP1_CH3_INPUT);\nCS42L43_DECL_MUX(dp1tx4, CS42L43_SWIRE_DP1_CH4_INPUT);\nCS42L43_DECL_MUX(dp2tx1, CS42L43_SWIRE_DP2_CH1_INPUT);\nCS42L43_DECL_MUX(dp2tx2, CS42L43_SWIRE_DP2_CH2_INPUT);\nCS42L43_DECL_MUX(dp3tx1, CS42L43_SWIRE_DP3_CH1_INPUT);\nCS42L43_DECL_MUX(dp3tx2, CS42L43_SWIRE_DP3_CH2_INPUT);\nCS42L43_DECL_MUX(dp4tx1, CS42L43_SWIRE_DP4_CH1_INPUT);\nCS42L43_DECL_MUX(dp4tx2, CS42L43_SWIRE_DP4_CH2_INPUT);\n\nCS42L43_DECL_MUX(asrcint1, CS42L43_ASRC_INT1_INPUT1);\nCS42L43_DECL_MUX(asrcint2, CS42L43_ASRC_INT2_INPUT1);\nCS42L43_DECL_MUX(asrcint3, CS42L43_ASRC_INT3_INPUT1);\nCS42L43_DECL_MUX(asrcint4, CS42L43_ASRC_INT4_INPUT1);\nCS42L43_DECL_MUX(asrcdec1, CS42L43_ASRC_DEC1_INPUT1);\nCS42L43_DECL_MUX(asrcdec2, CS42L43_ASRC_DEC2_INPUT1);\nCS42L43_DECL_MUX(asrcdec3, CS42L43_ASRC_DEC3_INPUT1);\nCS42L43_DECL_MUX(asrcdec4, CS42L43_ASRC_DEC4_INPUT1);\n\nCS42L43_DECL_MUX(isrc1int1, CS42L43_ISRC1INT1_INPUT1);\nCS42L43_DECL_MUX(isrc1int2, CS42L43_ISRC1INT2_INPUT1);\nCS42L43_DECL_MUX(isrc1dec1, CS42L43_ISRC1DEC1_INPUT1);\nCS42L43_DECL_MUX(isrc1dec2, CS42L43_ISRC1DEC2_INPUT1);\nCS42L43_DECL_MUX(isrc2int1, CS42L43_ISRC2INT1_INPUT1);\nCS42L43_DECL_MUX(isrc2int2, CS42L43_ISRC2INT2_INPUT1);\nCS42L43_DECL_MUX(isrc2dec1, CS42L43_ISRC2DEC1_INPUT1);\nCS42L43_DECL_MUX(isrc2dec2, CS42L43_ISRC2DEC2_INPUT1);\n\nCS42L43_DECL_MUX(spdif1, CS42L43_SPDIF1_INPUT1);\nCS42L43_DECL_MUX(spdif2, CS42L43_SPDIF2_INPUT1);\n\nCS42L43_DECL_MIXER(eq1, CS42L43_EQ1MIX_INPUT1);\nCS42L43_DECL_MIXER(eq2, CS42L43_EQ2MIX_INPUT1);\n\nCS42L43_DECL_MIXER(amp1, CS42L43_AMP1MIX_INPUT1);\nCS42L43_DECL_MIXER(amp2, CS42L43_AMP2MIX_INPUT1);\n\nCS42L43_DECL_MIXER(amp3, CS42L43_AMP3MIX_INPUT1);\nCS42L43_DECL_MIXER(amp4, CS42L43_AMP4MIX_INPUT1);\n\nstatic int cs42l43_dapm_get_volsw(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tint ret;\n\n\tsnd_soc_dapm_mutex_lock(dapm);\n\tret = snd_soc_get_volsw(kcontrol, ucontrol);\n\tsnd_soc_dapm_mutex_unlock(dapm);\n\n\treturn ret;\n}\n\nstatic int cs42l43_dapm_put_volsw(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tint ret;\n\n\tsnd_soc_dapm_mutex_lock(dapm);\n\tret = snd_soc_put_volsw(kcontrol, ucontrol);\n\tsnd_soc_dapm_mutex_unlock(dapm);\n\n\treturn ret;\n}\n\nstatic int cs42l43_dapm_get_enum(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tint ret;\n\n\tsnd_soc_dapm_mutex_lock(dapm);\n\tret = snd_soc_get_enum_double(kcontrol, ucontrol);\n\tsnd_soc_dapm_mutex_unlock(dapm);\n\n\treturn ret;\n}\n\nstatic int cs42l43_dapm_put_enum(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tint ret;\n\n\tsnd_soc_dapm_mutex_lock(dapm);\n\tret = snd_soc_put_enum_double(kcontrol, ucontrol);\n\tsnd_soc_dapm_mutex_unlock(dapm);\n\n\treturn ret;\n}\n\nstatic int cs42l43_eq_get(struct snd_kcontrol *kcontrol,\n\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\n\tmemcpy(ucontrol->value.integer.value, priv->eq_coeffs, sizeof(priv->eq_coeffs));\n\n\treturn 0;\n}\n\nstatic int cs42l43_eq_put(struct snd_kcontrol *kcontrol,\n\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(component);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\n\tsnd_soc_dapm_mutex_lock(dapm);\n\n\tmemcpy(priv->eq_coeffs, ucontrol->value.integer.value, sizeof(priv->eq_coeffs));\n\n\tsnd_soc_dapm_mutex_unlock(dapm);\n\n\treturn 0;\n}\n\nstatic void cs42l43_spk_vu_sync(struct cs42l43_codec *priv)\n{\n\tstruct cs42l43 *cs42l43 = priv->core;\n\n\tmutex_lock(&priv->spk_vu_lock);\n\n\tregmap_update_bits(cs42l43->regmap, CS42L43_INTP_VOLUME_CTRL1,\n\t\t\t   CS42L43_AMP1_2_VU_MASK, CS42L43_AMP1_2_VU_MASK);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_INTP_VOLUME_CTRL1,\n\t\t\t   CS42L43_AMP1_2_VU_MASK, 0);\n\n\tmutex_unlock(&priv->spk_vu_lock);\n}\n\nstatic int cs42l43_shutter_get(struct cs42l43_codec *priv, unsigned int shift)\n{\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tunsigned int val;\n\tint ret;\n\n\tret = pm_runtime_resume_and_get(priv->dev);\n\tif (ret) {\n\t\tdev_err(priv->dev, \"Failed to resume for shutters: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = regcache_drop_region(cs42l43->regmap, CS42L43_SHUTTER_CONTROL,\n\t\t\t\t   CS42L43_SHUTTER_CONTROL);\n\tif (ret) {\n\t\tdev_err(priv->dev, \"Failed to drop shutter from cache: %d\\n\", ret);\n\t\tgoto error;\n\t}\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_SHUTTER_CONTROL, &val);\n\tif (ret) {\n\t\tdev_err(priv->dev, \"Failed to check shutter status: %d\\n\", ret);\n\t\tgoto error;\n\t}\n\n\tret = !(val & BIT(shift));\n\n\tdev_dbg(priv->dev, \"%s shutter is %s\\n\",\n\t\tBIT(shift) == CS42L43_STATUS_MIC_SHUTTER_MUTE_MASK ? \"Mic\" : \"Speaker\",\n\t\tret ? \"open\" : \"closed\");\n\nerror:\n\tpm_runtime_mark_last_busy(priv->dev);\n\tpm_runtime_put_autosuspend(priv->dev);\n\n\treturn ret;\n}\n\nstatic int cs42l43_decim_get(struct snd_kcontrol *kcontrol,\n\t\t\t     struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = cs42l43_shutter_get(priv, CS42L43_STATUS_MIC_SHUTTER_MUTE_SHIFT);\n\tif (ret < 0)\n\t\treturn ret;\n\telse if (!ret)\n\t\tucontrol->value.integer.value[0] = ret;\n\telse\n\t\tret = cs42l43_dapm_get_volsw(kcontrol, ucontrol);\n\n\treturn ret;\n}\n\nstatic int cs42l43_spk_get(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = cs42l43_shutter_get(priv, CS42L43_STATUS_SPK_SHUTTER_MUTE_SHIFT);\n\tif (ret < 0)\n\t\treturn ret;\n\telse if (!ret)\n\t\tucontrol->value.integer.value[0] = ret;\n\telse\n\t\tret = snd_soc_get_volsw(kcontrol, ucontrol);\n\n\treturn ret;\n}\n\nstatic int cs42l43_spk_put(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = snd_soc_put_volsw(kcontrol, ucontrol);\n\tif (ret > 0)\n\t\tcs42l43_spk_vu_sync(priv);\n\n\treturn ret;\n}\n\nstatic const struct snd_kcontrol_new cs42l43_controls[] = {\n\tSOC_ENUM_EXT(\"Jack Override\", cs42l43_jack_enum,\n\t\t     cs42l43_jack_get, cs42l43_jack_put),\n\n\tSOC_DOUBLE_R_SX_TLV(\"ADC Volume\", CS42L43_ADC_B_CTRL1, CS42L43_ADC_B_CTRL2,\n\t\t\t    CS42L43_ADC_PGA_GAIN_SHIFT,\n\t\t\t    0xF, 5, cs42l43_adc_tlv),\n\n\tSOC_DOUBLE(\"PDM1 Invert Switch\", CS42L43_DMIC_PDM_CTRL,\n\t\t   CS42L43_PDM1L_INV_SHIFT, CS42L43_PDM1R_INV_SHIFT, 1, 0),\n\tSOC_DOUBLE(\"PDM2 Invert Switch\", CS42L43_DMIC_PDM_CTRL,\n\t\t   CS42L43_PDM2L_INV_SHIFT, CS42L43_PDM2R_INV_SHIFT, 1, 0),\n\tSOC_ENUM(\"PDM1 Clock\", cs42l43_pdm1_clk),\n\tSOC_ENUM(\"PDM2 Clock\", cs42l43_pdm2_clk),\n\n\tSOC_SINGLE(\"Decimator 1 WNF Switch\", CS42L43_DECIM_HPF_WNF_CTRL1,\n\t\t   CS42L43_DECIM_WNF_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Decimator 2 WNF Switch\", CS42L43_DECIM_HPF_WNF_CTRL2,\n\t\t   CS42L43_DECIM_WNF_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Decimator 3 WNF Switch\", CS42L43_DECIM_HPF_WNF_CTRL3,\n\t\t   CS42L43_DECIM_WNF_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Decimator 4 WNF Switch\", CS42L43_DECIM_HPF_WNF_CTRL4,\n\t\t   CS42L43_DECIM_WNF_EN_SHIFT, 1, 0),\n\n\tSOC_ENUM(\"Decimator 1 WNF Corner Frequency\", cs42l43_dec1_wnf_corner),\n\tSOC_ENUM(\"Decimator 2 WNF Corner Frequency\", cs42l43_dec2_wnf_corner),\n\tSOC_ENUM(\"Decimator 3 WNF Corner Frequency\", cs42l43_dec3_wnf_corner),\n\tSOC_ENUM(\"Decimator 4 WNF Corner Frequency\", cs42l43_dec4_wnf_corner),\n\n\tSOC_SINGLE(\"Decimator 1 HPF Switch\", CS42L43_DECIM_HPF_WNF_CTRL1,\n\t\t   CS42L43_DECIM_HPF_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Decimator 2 HPF Switch\", CS42L43_DECIM_HPF_WNF_CTRL2,\n\t\t   CS42L43_DECIM_HPF_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Decimator 3 HPF Switch\", CS42L43_DECIM_HPF_WNF_CTRL3,\n\t\t   CS42L43_DECIM_HPF_EN_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Decimator 4 HPF Switch\", CS42L43_DECIM_HPF_WNF_CTRL4,\n\t\t   CS42L43_DECIM_HPF_EN_SHIFT, 1, 0),\n\n\tSOC_ENUM(\"Decimator 1 HPF Corner Frequency\", cs42l43_dec1_hpf_corner),\n\tSOC_ENUM(\"Decimator 2 HPF Corner Frequency\", cs42l43_dec2_hpf_corner),\n\tSOC_ENUM(\"Decimator 3 HPF Corner Frequency\", cs42l43_dec3_hpf_corner),\n\tSOC_ENUM(\"Decimator 4 HPF Corner Frequency\", cs42l43_dec4_hpf_corner),\n\n\tSOC_SINGLE_TLV(\"Decimator 1 Volume\", CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t       CS42L43_DECIM1_VOL_SHIFT, 0xBF, 0, cs42l43_dec_tlv),\n\tSOC_SINGLE_EXT(\"Decimator 1 Switch\", CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t       CS42L43_DECIM1_MUTE_SHIFT, 1, 1,\n\t\t       cs42l43_decim_get, cs42l43_dapm_put_volsw),\n\tSOC_SINGLE_TLV(\"Decimator 2 Volume\", CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t       CS42L43_DECIM2_VOL_SHIFT, 0xBF, 0, cs42l43_dec_tlv),\n\tSOC_SINGLE_EXT(\"Decimator 2 Switch\", CS42L43_DECIM_VOL_CTRL_CH1_CH2,\n\t\t       CS42L43_DECIM2_MUTE_SHIFT, 1, 1,\n\t\t       cs42l43_decim_get, cs42l43_dapm_put_volsw),\n\tSOC_SINGLE_TLV(\"Decimator 3 Volume\", CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t       CS42L43_DECIM3_VOL_SHIFT, 0xBF, 0, cs42l43_dec_tlv),\n\tSOC_SINGLE_EXT(\"Decimator 3 Switch\", CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t       CS42L43_DECIM3_MUTE_SHIFT, 1, 1,\n\t\t       cs42l43_decim_get, cs42l43_dapm_put_volsw),\n\tSOC_SINGLE_TLV(\"Decimator 4 Volume\", CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t       CS42L43_DECIM4_VOL_SHIFT, 0xBF, 0, cs42l43_dec_tlv),\n\tSOC_SINGLE_EXT(\"Decimator 4 Switch\", CS42L43_DECIM_VOL_CTRL_CH3_CH4,\n\t\t       CS42L43_DECIM4_MUTE_SHIFT, 1, 1,\n\t\t       cs42l43_decim_get, cs42l43_dapm_put_volsw),\n\n\tSOC_ENUM_EXT(\"Decimator 1 Ramp Up\", cs42l43_dec1_ramp_up,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 1 Ramp Down\", cs42l43_dec1_ramp_down,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 2 Ramp Up\", cs42l43_dec2_ramp_up,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 2 Ramp Down\", cs42l43_dec2_ramp_down,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 3 Ramp Up\", cs42l43_dec3_ramp_up,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 3 Ramp Down\", cs42l43_dec3_ramp_down,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 4 Ramp Up\", cs42l43_dec4_ramp_up,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\tSOC_ENUM_EXT(\"Decimator 4 Ramp Down\", cs42l43_dec4_ramp_down,\n\t\t     cs42l43_dapm_get_enum, cs42l43_dapm_put_enum),\n\n\tSOC_DOUBLE_R_EXT(\"Speaker Digital Switch\",\n\t\t\t CS42L43_INTP_VOLUME_CTRL1, CS42L43_INTP_VOLUME_CTRL2,\n\t\t\t CS42L43_AMP_MUTE_SHIFT, 1, 1,\n\t\t\t cs42l43_spk_get, cs42l43_spk_put),\n\n\tSOC_DOUBLE_R_EXT_TLV(\"Speaker Digital Volume\",\n\t\t\t     CS42L43_INTP_VOLUME_CTRL1, CS42L43_INTP_VOLUME_CTRL2,\n\t\t\t     CS42L43_AMP_VOL_SHIFT,\n\t\t\t     0xBF, 0, snd_soc_get_volsw, cs42l43_spk_put,\n\t\t\t     cs42l43_speaker_tlv),\n\n\tSOC_ENUM(\"Speaker Ramp Up\", cs42l43_speaker_ramp_up),\n\tSOC_ENUM(\"Speaker Ramp Down\", cs42l43_speaker_ramp_down),\n\n\tCS42L43_MIXER_VOLUMES(\"Speaker L\", CS42L43_AMP1MIX_INPUT1),\n\tCS42L43_MIXER_VOLUMES(\"Speaker R\", CS42L43_AMP2MIX_INPUT1),\n\n\tSOC_DOUBLE_SX_TLV(\"Headphone Digital Volume\", CS42L43_HPPATHVOL,\n\t\t\t  CS42L43_AMP3_PATH_VOL_SHIFT, CS42L43_AMP4_PATH_VOL_SHIFT,\n\t\t\t  0x11B, 229, cs42l43_headphone_tlv),\n\n\tSOC_DOUBLE(\"Headphone Invert Switch\", CS42L43_DACCNFG1,\n\t\t   CS42L43_AMP3_INV_SHIFT, CS42L43_AMP4_INV_SHIFT, 1, 0),\n\n\tSOC_SINGLE(\"Headphone Zero Cross Switch\", CS42L43_PGAVOL,\n\t\t   CS42L43_HP_PATH_VOL_ZC_SHIFT, 1, 0),\n\tSOC_SINGLE(\"Headphone Ramp Switch\", CS42L43_PGAVOL,\n\t\t   CS42L43_HP_PATH_VOL_SFT_SHIFT, 1, 0),\n\tSOC_ENUM(\"Headphone Ramp Rate\", cs42l43_headphone_ramp),\n\n\tCS42L43_MIXER_VOLUMES(\"Headphone L\", CS42L43_AMP3MIX_INPUT1),\n\tCS42L43_MIXER_VOLUMES(\"Headphone R\", CS42L43_AMP4MIX_INPUT1),\n\n\tSOC_ENUM(\"Tone 1 Frequency\", cs42l43_tone1_freq),\n\tSOC_ENUM(\"Tone 2 Frequency\", cs42l43_tone2_freq),\n\n\tSOC_DOUBLE_EXT(\"EQ Switch\",\n\t\t       CS42L43_MUTE_EQ_IN0, CS42L43_MUTE_EQ_CH1_SHIFT,\n\t\t       CS42L43_MUTE_EQ_CH2_SHIFT, 1, 1,\n\t\t       cs42l43_dapm_get_volsw, cs42l43_dapm_put_volsw),\n\n\tSND_SOC_BYTES_E(\"EQ Coefficients\", 0, CS42L43_N_EQ_COEFFS,\n\t\t\tcs42l43_eq_get, cs42l43_eq_put),\n\n\tCS42L43_MIXER_VOLUMES(\"EQ1\", CS42L43_EQ1MIX_INPUT1),\n\tCS42L43_MIXER_VOLUMES(\"EQ2\", CS42L43_EQ2MIX_INPUT1),\n};\n\nstatic int cs42l43_eq_ev(struct snd_soc_dapm_widget *w,\n\t\t\t struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tunsigned int val;\n\tint i, ret;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_MUTE_EQ_IN0,\n\t\t\t\t   CS42L43_MUTE_EQ_CH1_MASK | CS42L43_MUTE_EQ_CH2_MASK,\n\t\t\t\t   CS42L43_MUTE_EQ_CH1_MASK | CS42L43_MUTE_EQ_CH2_MASK);\n\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_COEFF_RD_WR0,\n\t\t\t\t   CS42L43_WRITE_MODE_MASK, CS42L43_WRITE_MODE_MASK);\n\n\t\tfor (i = 0; i < CS42L43_N_EQ_COEFFS; i++)\n\t\t\tregmap_write(cs42l43->regmap, CS42L43_COEFF_DATA_IN0,\n\t\t\t\t     priv->eq_coeffs[i]);\n\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_COEFF_RD_WR0,\n\t\t\t\t   CS42L43_WRITE_MODE_MASK, 0);\n\n\t\treturn 0;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tret = regmap_read_poll_timeout(cs42l43->regmap, CS42L43_INIT_DONE0,\n\t\t\t\t\t       val, (val & CS42L43_INITIALIZE_DONE_MASK),\n\t\t\t\t\t       2000, 10000);\n\t\tif (ret)\n\t\t\tdev_err(priv->dev, \"Failed to start EQs: %d\\n\", ret);\n\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_MUTE_EQ_IN0,\n\t\t\t\t   CS42L43_MUTE_EQ_CH1_MASK | CS42L43_MUTE_EQ_CH2_MASK, 0);\n\t\treturn ret;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstruct cs42l43_pll_config {\n\tunsigned int freq;\n\n\tunsigned int div;\n\tunsigned int mode;\n\tunsigned int cal;\n};\n\nstatic const struct cs42l43_pll_config cs42l43_pll_configs[] = {\n\t{ 2400000, 0x50000000, 0x1, 0xA4 },\n\t{ 3000000, 0x40000000, 0x1, 0x83 },\n\t{ 3072000, 0x40000000, 0x3, 0x80 },\n};\n\nstatic int cs42l43_set_pll(struct cs42l43_codec *priv, unsigned int src,\n\t\t\t   unsigned int freq)\n{\n\tstruct cs42l43 *cs42l43 = priv->core;\n\n\tlockdep_assert_held(&cs42l43->pll_lock);\n\n\tif (priv->refclk_src == src && priv->refclk_freq == freq)\n\t\treturn 0;\n\n\tif (regmap_test_bits(cs42l43->regmap, CS42L43_CTRL_REG, CS42L43_PLL_EN_MASK)) {\n\t\tdev_err(priv->dev, \"PLL active, can't change configuration\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tswitch (src) {\n\tcase CS42L43_SYSCLK_MCLK:\n\tcase CS42L43_SYSCLK_SDW:\n\t\tdev_dbg(priv->dev, \"Source PLL from %s at %uHz\\n\",\n\t\t\tsrc ? \"SoundWire\" : \"MCLK\", freq);\n\n\t\tpriv->refclk_src = src;\n\t\tpriv->refclk_freq = freq;\n\n\t\treturn 0;\n\tdefault:\n\t\tdev_err(priv->dev, \"Invalid PLL source: 0x%x\\n\", src);\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int cs42l43_enable_pll(struct cs42l43_codec *priv)\n{\n\tstatic const struct reg_sequence enable_seq[] = {\n\t\t{ CS42L43_OSC_DIV_SEL, 0x0, },\n\t\t{ CS42L43_MCLK_SRC_SEL, CS42L43_OSC_PLL_MCLK_SEL_MASK, 5, },\n\t};\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tconst struct cs42l43_pll_config *config = NULL;\n\tunsigned int div = 0;\n\tunsigned int freq = priv->refclk_freq;\n\tunsigned long time_left;\n\n\tlockdep_assert_held(&cs42l43->pll_lock);\n\n\tif (priv->refclk_src == CS42L43_SYSCLK_SDW) {\n\t\tif (!freq)\n\t\t\tfreq = cs42l43->sdw_freq;\n\t\telse if (!cs42l43->sdw_freq)\n\t\t\tcs42l43->sdw_freq = freq;\n\t}\n\n\tdev_dbg(priv->dev, \"Enabling PLL at %uHz\\n\", freq);\n\n\twhile (freq > cs42l43_pll_configs[ARRAY_SIZE(cs42l43_pll_configs) - 1].freq) {\n\t\tdiv++;\n\t\tfreq /= 2;\n\t}\n\n\tif (div <= CS42L43_PLL_REFCLK_DIV_MASK) {\n\t\tint i;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(cs42l43_pll_configs); i++) {\n\t\t\tif (freq == cs42l43_pll_configs[i].freq) {\n\t\t\t\tconfig = &cs42l43_pll_configs[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!config) {\n\t\tdev_err(priv->dev, \"No suitable PLL config: 0x%x, %uHz\\n\", div, freq);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(cs42l43->regmap, CS42L43_PLL_CONTROL,\n\t\t\t   CS42L43_PLL_REFCLK_DIV_MASK | CS42L43_PLL_REFCLK_SRC_MASK,\n\t\t\t   div << CS42L43_PLL_REFCLK_DIV_SHIFT |\n\t\t\t   priv->refclk_src << CS42L43_PLL_REFCLK_SRC_SHIFT);\n\tregmap_write(cs42l43->regmap, CS42L43_FDIV_FRAC, config->div);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_CTRL_REG,\n\t\t\t   CS42L43_PLL_MODE_BYPASS_500_MASK |\n\t\t\t   CS42L43_PLL_MODE_BYPASS_1029_MASK,\n\t\t\t   config->mode << CS42L43_PLL_MODE_BYPASS_1029_SHIFT);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_CAL_RATIO,\n\t\t\t   CS42L43_PLL_CAL_RATIO_MASK, config->cal);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_PLL_CONTROL,\n\t\t\t   CS42L43_PLL_REFCLK_EN_MASK, CS42L43_PLL_REFCLK_EN_MASK);\n\n\treinit_completion(&priv->pll_ready);\n\n\tregmap_update_bits(cs42l43->regmap, CS42L43_CTRL_REG,\n\t\t\t   CS42L43_PLL_EN_MASK, CS42L43_PLL_EN_MASK);\n\n\ttime_left = wait_for_completion_timeout(&priv->pll_ready,\n\t\t\t\t\t\tmsecs_to_jiffies(CS42L43_PLL_TIMEOUT_MS));\n\tif (!time_left) {\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_CTRL_REG,\n\t\t\t\t   CS42L43_PLL_EN_MASK, 0);\n\t\tregmap_update_bits(cs42l43->regmap, CS42L43_PLL_CONTROL,\n\t\t\t\t   CS42L43_PLL_REFCLK_EN_MASK, 0);\n\n\t\tdev_err(priv->dev, \"Timeout out waiting for PLL\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tif (priv->refclk_src == CS42L43_SYSCLK_SDW)\n\t\tcs42l43->sdw_pll_active = true;\n\n\tdev_dbg(priv->dev, \"PLL locked in %ums\\n\", 200 - jiffies_to_msecs(time_left));\n\n\t \n\tregmap_multi_reg_write(cs42l43->regmap, enable_seq, ARRAY_SIZE(enable_seq));\n\n\treturn 0;\n}\n\nstatic int cs42l43_disable_pll(struct cs42l43_codec *priv)\n{\n\tstatic const struct reg_sequence disable_seq[] = {\n\t\t{ CS42L43_MCLK_SRC_SEL, 0x0, 5, },\n\t\t{ CS42L43_OSC_DIV_SEL, CS42L43_OSC_DIV2_EN_MASK, },\n\t};\n\tstruct cs42l43 *cs42l43 = priv->core;\n\n\tdev_dbg(priv->dev, \"Disabling PLL\\n\");\n\n\tlockdep_assert_held(&cs42l43->pll_lock);\n\n\tregmap_multi_reg_write(cs42l43->regmap, disable_seq, ARRAY_SIZE(disable_seq));\n\tregmap_update_bits(cs42l43->regmap, CS42L43_CTRL_REG, CS42L43_PLL_EN_MASK, 0);\n\tregmap_update_bits(cs42l43->regmap, CS42L43_PLL_CONTROL,\n\t\t\t   CS42L43_PLL_REFCLK_EN_MASK, 0);\n\n\tcs42l43->sdw_pll_active = false;\n\n\treturn 0;\n}\n\nstatic int cs42l43_pll_ev(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tint ret;\n\n\tmutex_lock(&cs42l43->pll_lock);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (priv->refclk_src == CS42L43_SYSCLK_MCLK) {\n\t\t\tret = clk_prepare_enable(priv->mclk);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(priv->dev, \"Failed to enable MCLK: %d\\n\", ret);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tret = cs42l43_enable_pll(priv);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tret = cs42l43_disable_pll(priv);\n\n\t\tif (priv->refclk_src == CS42L43_SYSCLK_MCLK)\n\t\t\tclk_disable_unprepare(priv->mclk);\n\t\tbreak;\n\tdefault:\n\t\tret = 0;\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&cs42l43->pll_lock);\n\n\treturn ret;\n}\n\nstatic int cs42l43_dapm_wait_completion(struct completion *pmu, struct completion *pmd,\n\t\t\t\t\tint event, int timeout_ms)\n{\n\tunsigned long time_left;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\treinit_completion(pmu);\n\t\treturn 0;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\treinit_completion(pmd);\n\t\treturn 0;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\ttime_left = wait_for_completion_timeout(pmu, msecs_to_jiffies(timeout_ms));\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\ttime_left = wait_for_completion_timeout(pmd, msecs_to_jiffies(timeout_ms));\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tif (!time_left)\n\t\treturn -ETIMEDOUT;\n\telse\n\t\treturn 0;\n}\n\nstatic int cs42l43_spkr_ev(struct snd_soc_dapm_widget *w,\n\t\t\t   struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\n\treturn cs42l43_dapm_wait_completion(&priv->spkr_startup,\n\t\t\t\t\t    &priv->spkr_shutdown, event,\n\t\t\t\t\t    CS42L43_SPK_TIMEOUT_MS);\n}\n\nstatic int cs42l43_spkl_ev(struct snd_soc_dapm_widget *w,\n\t\t\t   struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\n\treturn cs42l43_dapm_wait_completion(&priv->spkl_startup,\n\t\t\t\t\t    &priv->spkl_shutdown, event,\n\t\t\t\t\t    CS42L43_SPK_TIMEOUT_MS);\n}\n\nstatic int cs42l43_hp_ev(struct snd_soc_dapm_widget *w,\n\t\t\t struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tunsigned int mask = 1 << w->shift;\n\tunsigned int val = 0;\n\tint ret;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tval = mask;\n\t\tfallthrough;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tpriv->hp_ena &= ~mask;\n\t\tpriv->hp_ena |= val;\n\n\t\tret = cs42l43_dapm_wait_completion(&priv->hp_startup,\n\t\t\t\t\t\t   &priv->hp_shutdown, event,\n\t\t\t\t\t\t   CS42L43_HP_TIMEOUT_MS);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (!priv->load_detect_running)\n\t\t\tregmap_update_bits(cs42l43->regmap, CS42L43_BLOCK_EN8,\n\t\t\t\t\t   mask, val);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tif (priv->load_detect_running)\n\t\t\tbreak;\n\n\t\tret = cs42l43_dapm_wait_completion(&priv->hp_startup,\n\t\t\t\t\t\t   &priv->hp_shutdown, event,\n\t\t\t\t\t\t   CS42L43_HP_TIMEOUT_MS);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int cs42l43_mic_ev(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tunsigned int reg, ramp, mute;\n\tunsigned int *val;\n\tint ret;\n\n\tswitch (w->shift) {\n\tcase CS42L43_ADC1_EN_SHIFT:\n\tcase CS42L43_PDM1_DIN_L_EN_SHIFT:\n\t\treg = CS42L43_DECIM_VOL_CTRL_CH1_CH2;\n\t\tramp = CS42L43_DECIM1_VD_RAMP_MASK;\n\t\tmute = CS42L43_DECIM1_MUTE_MASK;\n\t\tval = &priv->decim_cache[0];\n\t\tbreak;\n\tcase CS42L43_ADC2_EN_SHIFT:\n\tcase CS42L43_PDM1_DIN_R_EN_SHIFT:\n\t\treg = CS42L43_DECIM_VOL_CTRL_CH1_CH2;\n\t\tramp = CS42L43_DECIM2_VD_RAMP_MASK;\n\t\tmute = CS42L43_DECIM2_MUTE_MASK;\n\t\tval = &priv->decim_cache[1];\n\t\tbreak;\n\tcase CS42L43_PDM2_DIN_L_EN_SHIFT:\n\t\treg = CS42L43_DECIM_VOL_CTRL_CH3_CH4;\n\t\tramp  = CS42L43_DECIM3_VD_RAMP_MASK;\n\t\tmute = CS42L43_DECIM3_MUTE_MASK;\n\t\tval = &priv->decim_cache[2];\n\t\tbreak;\n\tcase CS42L43_PDM2_DIN_R_EN_SHIFT:\n\t\treg = CS42L43_DECIM_VOL_CTRL_CH3_CH4;\n\t\tramp = CS42L43_DECIM4_VD_RAMP_MASK;\n\t\tmute = CS42L43_DECIM4_MUTE_MASK;\n\t\tval = &priv->decim_cache[3];\n\t\tbreak;\n\tdefault:\n\t\tdev_err(priv->dev, \"Invalid microphone shift: %d\\n\", w->shift);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tret = regmap_read(cs42l43->regmap, reg, val);\n\t\tif (ret) {\n\t\t\tdev_err(priv->dev,\n\t\t\t\t\"Failed to cache decimator settings: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tregmap_update_bits(cs42l43->regmap, reg, mute | ramp, mute);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\tregmap_update_bits(cs42l43->regmap, reg, mute | ramp, *val);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int cs42l43_adc_ev(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tunsigned int mask = 1 << w->shift;\n\tunsigned int val = 0;\n\tint ret;\n\n\tret = cs42l43_mic_ev(w, kcontrol, event);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tval = mask;\n\t\tfallthrough;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\tpriv->adc_ena &= ~mask;\n\t\tpriv->adc_ena |= val;\n\n\t\tif (!priv->load_detect_running)\n\t\t\tregmap_update_bits(cs42l43->regmap, CS42L43_BLOCK_EN3,\n\t\t\t\t\t   mask, val);\n\t\tfallthrough;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic const struct snd_soc_dapm_widget cs42l43_widgets[] = {\n\tSND_SOC_DAPM_SUPPLY(\"PLL\", SND_SOC_NOPM, 0, 0, cs42l43_pll_ev,\n\t\t\t    SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_INPUT(\"ADC1_IN1_P\"),\n\tSND_SOC_DAPM_INPUT(\"ADC1_IN1_N\"),\n\tSND_SOC_DAPM_INPUT(\"ADC1_IN2_P\"),\n\tSND_SOC_DAPM_INPUT(\"ADC1_IN2_N\"),\n\tSND_SOC_DAPM_INPUT(\"ADC2_IN_P\"),\n\tSND_SOC_DAPM_INPUT(\"ADC2_IN_N\"),\n\n\tSND_SOC_DAPM_INPUT(\"PDM1_DIN\"),\n\tSND_SOC_DAPM_INPUT(\"PDM2_DIN\"),\n\n\tSND_SOC_DAPM_MUX(\"ADC1 Input\", SND_SOC_NOPM, 0, 0, &cs42l43_adc1_input_ctl),\n\n\tSND_SOC_DAPM_PGA_E(\"ADC1\", SND_SOC_NOPM, CS42L43_ADC1_EN_SHIFT, 0, NULL, 0,\n\t\t\t   cs42l43_adc_ev, SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_PGA_E(\"ADC2\", SND_SOC_NOPM, CS42L43_ADC2_EN_SHIFT, 0, NULL, 0,\n\t\t\t   cs42l43_adc_ev, SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD),\n\n\tSND_SOC_DAPM_PGA_E(\"PDM1L\", CS42L43_BLOCK_EN3, CS42L43_PDM1_DIN_L_EN_SHIFT,\n\t\t\t   0, NULL, 0, cs42l43_mic_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU),\n\tSND_SOC_DAPM_PGA_E(\"PDM1R\", CS42L43_BLOCK_EN3, CS42L43_PDM1_DIN_R_EN_SHIFT,\n\t\t\t   0, NULL, 0, cs42l43_mic_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU),\n\tSND_SOC_DAPM_PGA_E(\"PDM2L\", CS42L43_BLOCK_EN3, CS42L43_PDM2_DIN_L_EN_SHIFT,\n\t\t\t   0, NULL, 0, cs42l43_mic_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU),\n\tSND_SOC_DAPM_PGA_E(\"PDM2R\", CS42L43_BLOCK_EN3, CS42L43_PDM2_DIN_R_EN_SHIFT,\n\t\t\t   0, NULL, 0, cs42l43_mic_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU),\n\n\tSND_SOC_DAPM_MUX(\"Decimator 1 Mode\", SND_SOC_NOPM, 0, 0,\n\t\t\t &cs42l43_dec_mode_ctl[0]),\n\tSND_SOC_DAPM_MUX(\"Decimator 2 Mode\", SND_SOC_NOPM, 0, 0,\n\t\t\t &cs42l43_dec_mode_ctl[1]),\n\n\tSND_SOC_DAPM_PGA(\"Decimator 1\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Decimator 2\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Decimator 3\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Decimator 4\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"FSYNC\", 0, CS42L43_ASP_CTRL, CS42L43_ASP_FSYNC_EN_SHIFT,\n\t\t\t      0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"BCLK\", 1, CS42L43_ASP_CTRL, CS42L43_ASP_BCLK_EN_SHIFT,\n\t\t\t      0, NULL, 0),\n\n\tSND_SOC_DAPM_AIF_OUT(\"ASPTX1\", NULL, 0,\n\t\t\t     CS42L43_ASP_TX_EN, CS42L43_ASP_TX_CH1_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"ASPTX2\", NULL, 1,\n\t\t\t     CS42L43_ASP_TX_EN, CS42L43_ASP_TX_CH2_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"ASPTX3\", NULL, 2,\n\t\t\t     CS42L43_ASP_TX_EN, CS42L43_ASP_TX_CH3_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"ASPTX4\", NULL, 3,\n\t\t\t     CS42L43_ASP_TX_EN, CS42L43_ASP_TX_CH4_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"ASPTX5\", NULL, 4,\n\t\t\t     CS42L43_ASP_TX_EN, CS42L43_ASP_TX_CH5_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"ASPTX6\", NULL, 5,\n\t\t\t     CS42L43_ASP_TX_EN, CS42L43_ASP_TX_CH6_EN_SHIFT, 0),\n\n\tSND_SOC_DAPM_AIF_IN(\"ASPRX1\", NULL, 0,\n\t\t\t    CS42L43_ASP_RX_EN, CS42L43_ASP_RX_CH1_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_IN(\"ASPRX2\", NULL, 1,\n\t\t\t    CS42L43_ASP_RX_EN, CS42L43_ASP_RX_CH2_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_IN(\"ASPRX3\", NULL, 2,\n\t\t\t    CS42L43_ASP_RX_EN, CS42L43_ASP_RX_CH3_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_IN(\"ASPRX4\", NULL, 3,\n\t\t\t    CS42L43_ASP_RX_EN, CS42L43_ASP_RX_CH4_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_IN(\"ASPRX5\", NULL, 4,\n\t\t\t    CS42L43_ASP_RX_EN, CS42L43_ASP_RX_CH5_EN_SHIFT, 0),\n\tSND_SOC_DAPM_AIF_IN(\"ASPRX6\", NULL, 5,\n\t\t\t    CS42L43_ASP_RX_EN, CS42L43_ASP_RX_CH6_EN_SHIFT, 0),\n\n\tSND_SOC_DAPM_AIF_OUT(\"DP1TX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"DP1TX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"DP1TX3\", NULL, 2, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"DP1TX4\", NULL, 3, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_OUT(\"DP2TX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"DP2TX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_OUT(\"DP3TX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"DP3TX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_OUT(\"DP4TX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_OUT(\"DP4TX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_IN(\"DP5RX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_IN(\"DP5RX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_IN(\"DP6RX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_IN(\"DP6RX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_AIF_IN(\"DP7RX1\", NULL, 0, SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_AIF_IN(\"DP7RX2\", NULL, 1, SND_SOC_NOPM, 0, 0),\n\n\tSND_SOC_DAPM_REGULATOR_SUPPLY(\"vdd-amp\", 0, 0),\n\n\tSND_SOC_DAPM_PGA_E(\"AMP1\", CS42L43_BLOCK_EN10, CS42L43_AMP1_EN_SHIFT, 0, NULL, 0,\n\t\t\t   cs42l43_spkl_ev, SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_PGA_E(\"AMP2\", CS42L43_BLOCK_EN10, CS42L43_AMP2_EN_SHIFT, 0, NULL, 0,\n\t\t\t   cs42l43_spkr_ev, SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_OUTPUT(\"AMP1_OUT_P\"),\n\tSND_SOC_DAPM_OUTPUT(\"AMP1_OUT_N\"),\n\tSND_SOC_DAPM_OUTPUT(\"AMP2_OUT_P\"),\n\tSND_SOC_DAPM_OUTPUT(\"AMP2_OUT_N\"),\n\n\tSND_SOC_DAPM_PGA(\"SPDIF\", CS42L43_BLOCK_EN11, CS42L43_SPDIF_EN_SHIFT,\n\t\t\t 0, NULL, 0),\n\tSND_SOC_DAPM_OUTPUT(\"SPDIF_TX\"),\n\n\tSND_SOC_DAPM_PGA_E(\"HP\", SND_SOC_NOPM, CS42L43_HP_EN_SHIFT, 0, NULL, 0,\n\t\t\t   cs42l43_hp_ev, SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU |\n\t\t\t   SND_SOC_DAPM_PRE_PMD | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_OUTPUT(\"AMP3_OUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"AMP4_OUT\"),\n\n\tSND_SOC_DAPM_SIGGEN(\"Tone\"),\n\tSND_SOC_DAPM_SUPPLY(\"Tone Generator\", CS42L43_BLOCK_EN9, CS42L43_TONE_EN_SHIFT,\n\t\t\t    0, NULL, 0),\n\tSND_SOC_DAPM_REG(snd_soc_dapm_pga, \"Tone 1\", CS42L43_TONE_CH1_CTRL,\n\t\t\t CS42L43_TONE_SEL_SHIFT, CS42L43_TONE_SEL_MASK, 0xA, 0),\n\tSND_SOC_DAPM_REG(snd_soc_dapm_pga, \"Tone 2\", CS42L43_TONE_CH2_CTRL,\n\t\t\t CS42L43_TONE_SEL_SHIFT, CS42L43_TONE_SEL_MASK, 0xA, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"ISRC1\", CS42L43_BLOCK_EN5, CS42L43_ISRC1_BANK_EN_SHIFT,\n\t\t\t    0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ISRC2\", CS42L43_BLOCK_EN5, CS42L43_ISRC2_BANK_EN_SHIFT,\n\t\t\t    0, NULL, 0),\n\n\tSND_SOC_DAPM_PGA(\"ISRC1INT2\", CS42L43_ISRC1_CTRL,\n\t\t\t CS42L43_ISRC_INT2_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ISRC1INT1\", CS42L43_ISRC1_CTRL,\n\t\t\t CS42L43_ISRC_INT1_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ISRC1DEC2\", CS42L43_ISRC1_CTRL,\n\t\t\t CS42L43_ISRC_DEC2_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ISRC1DEC1\", CS42L43_ISRC1_CTRL,\n\t\t\t CS42L43_ISRC_DEC1_EN_SHIFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_PGA(\"ISRC2INT2\", CS42L43_ISRC2_CTRL,\n\t\t\t CS42L43_ISRC_INT2_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ISRC2INT1\", CS42L43_ISRC2_CTRL,\n\t\t\t CS42L43_ISRC_INT1_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ISRC2DEC2\", CS42L43_ISRC2_CTRL,\n\t\t\t CS42L43_ISRC_DEC2_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ISRC2DEC1\", CS42L43_ISRC2_CTRL,\n\t\t\t CS42L43_ISRC_DEC1_EN_SHIFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"ASRC_INT\", CS42L43_BLOCK_EN4,\n\t\t\t    CS42L43_ASRC_INT_BANK_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ASRC_DEC\", CS42L43_BLOCK_EN4,\n\t\t\t    CS42L43_ASRC_DEC_BANK_EN_SHIFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_PGA(\"ASRC_INT1\", CS42L43_ASRC_INT_ENABLES,\n\t\t\t CS42L43_ASRC_INT1_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_INT2\", CS42L43_ASRC_INT_ENABLES,\n\t\t\t CS42L43_ASRC_INT2_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_INT3\", CS42L43_ASRC_INT_ENABLES,\n\t\t\t CS42L43_ASRC_INT3_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_INT4\", CS42L43_ASRC_INT_ENABLES,\n\t\t\t CS42L43_ASRC_INT4_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_DEC1\", CS42L43_ASRC_DEC_ENABLES,\n\t\t\t CS42L43_ASRC_DEC1_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_DEC2\", CS42L43_ASRC_DEC_ENABLES,\n\t\t\t CS42L43_ASRC_DEC2_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_DEC3\", CS42L43_ASRC_DEC_ENABLES,\n\t\t\t CS42L43_ASRC_DEC3_EN_SHIFT, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"ASRC_DEC4\", CS42L43_ASRC_DEC_ENABLES,\n\t\t\t CS42L43_ASRC_DEC4_EN_SHIFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY(\"EQ Clock\", CS42L43_BLOCK_EN7, CS42L43_EQ_EN_SHIFT,\n\t\t\t    0, NULL, 0),\n\tSND_SOC_DAPM_PGA_E(\"EQ\", CS42L43_START_EQZ0, CS42L43_START_FILTER_SHIFT,\n\t\t\t   0, NULL, 0, cs42l43_eq_ev,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMU),\n\n\tSND_SOC_DAPM_SUPPLY(\"Mixer Core\", CS42L43_BLOCK_EN6, CS42L43_MIXER_EN_SHIFT,\n\t\t\t    0, NULL, 0),\n\tCS42L43_DAPM_MUX(\"ASPTX1\", asptx1),\n\tCS42L43_DAPM_MUX(\"ASPTX2\", asptx2),\n\tCS42L43_DAPM_MUX(\"ASPTX3\", asptx3),\n\tCS42L43_DAPM_MUX(\"ASPTX4\", asptx4),\n\tCS42L43_DAPM_MUX(\"ASPTX5\", asptx5),\n\tCS42L43_DAPM_MUX(\"ASPTX6\", asptx6),\n\n\tCS42L43_DAPM_MUX(\"DP1TX1\", dp1tx1),\n\tCS42L43_DAPM_MUX(\"DP1TX2\", dp1tx2),\n\tCS42L43_DAPM_MUX(\"DP1TX3\", dp1tx3),\n\tCS42L43_DAPM_MUX(\"DP1TX4\", dp1tx4),\n\tCS42L43_DAPM_MUX(\"DP2TX1\", dp2tx1),\n\tCS42L43_DAPM_MUX(\"DP2TX2\", dp2tx2),\n\tCS42L43_DAPM_MUX(\"DP3TX1\", dp3tx1),\n\tCS42L43_DAPM_MUX(\"DP3TX2\", dp3tx2),\n\tCS42L43_DAPM_MUX(\"DP4TX1\", dp4tx1),\n\tCS42L43_DAPM_MUX(\"DP4TX2\", dp4tx2),\n\n\tCS42L43_DAPM_MUX(\"ASRC INT1\", asrcint1),\n\tCS42L43_DAPM_MUX(\"ASRC INT2\", asrcint2),\n\tCS42L43_DAPM_MUX(\"ASRC INT3\", asrcint3),\n\tCS42L43_DAPM_MUX(\"ASRC INT4\", asrcint4),\n\tCS42L43_DAPM_MUX(\"ASRC DEC1\", asrcdec1),\n\tCS42L43_DAPM_MUX(\"ASRC DEC2\", asrcdec2),\n\tCS42L43_DAPM_MUX(\"ASRC DEC3\", asrcdec3),\n\tCS42L43_DAPM_MUX(\"ASRC DEC4\", asrcdec4),\n\n\tCS42L43_DAPM_MUX(\"ISRC1INT1\", isrc1int1),\n\tCS42L43_DAPM_MUX(\"ISRC1INT2\", isrc1int2),\n\tCS42L43_DAPM_MUX(\"ISRC1DEC1\", isrc1dec1),\n\tCS42L43_DAPM_MUX(\"ISRC1DEC2\", isrc1dec2),\n\tCS42L43_DAPM_MUX(\"ISRC2INT1\", isrc2int1),\n\tCS42L43_DAPM_MUX(\"ISRC2INT2\", isrc2int2),\n\tCS42L43_DAPM_MUX(\"ISRC2DEC1\", isrc2dec1),\n\tCS42L43_DAPM_MUX(\"ISRC2DEC2\", isrc2dec2),\n\n\tCS42L43_DAPM_MUX(\"SPDIF1\", spdif1),\n\tCS42L43_DAPM_MUX(\"SPDIF2\", spdif2),\n\n\tCS42L43_DAPM_MIXER(\"EQ1\", eq1),\n\tCS42L43_DAPM_MIXER(\"EQ2\", eq2),\n\n\tCS42L43_DAPM_MIXER(\"Speaker L\", amp1),\n\tCS42L43_DAPM_MIXER(\"Speaker R\", amp2),\n\n\tCS42L43_DAPM_MIXER(\"Headphone L\", amp3),\n\tCS42L43_DAPM_MIXER(\"Headphone R\", amp4),\n};\n\nstatic const struct snd_soc_dapm_route cs42l43_routes[] = {\n\t{ \"ADC1_IN1_P\",\t\tNULL,\t\"PLL\" },\n\t{ \"ADC1_IN1_N\",\t\tNULL,\t\"PLL\" },\n\t{ \"ADC1_IN2_P\",\t\tNULL,\t\"PLL\" },\n\t{ \"ADC1_IN2_N\",\t\tNULL,\t\"PLL\" },\n\t{ \"ADC2_IN_P\",\t\tNULL,\t\"PLL\" },\n\t{ \"ADC2_IN_N\",\t\tNULL,\t\"PLL\" },\n\t{ \"PDM1_DIN\",\t\tNULL,\t\"PLL\" },\n\t{ \"PDM2_DIN\",\t\tNULL,\t\"PLL\" },\n\t{ \"AMP1_OUT_P\",\t\tNULL,\t\"PLL\" },\n\t{ \"AMP1_OUT_N\",\t\tNULL,\t\"PLL\" },\n\t{ \"AMP2_OUT_P\",\t\tNULL,\t\"PLL\" },\n\t{ \"AMP2_OUT_N\",\t\tNULL,\t\"PLL\" },\n\t{ \"SPDIF_TX\",\t\tNULL,\t\"PLL\" },\n\t{ \"HP\",\t\t\tNULL,\t\"PLL\" },\n\t{ \"AMP3_OUT\",\t\tNULL,\t\"PLL\" },\n\t{ \"AMP4_OUT\",\t\tNULL,\t\"PLL\" },\n\t{ \"Tone 1\",\t\tNULL,\t\"PLL\" },\n\t{ \"Tone 2\",\t\tNULL,\t\"PLL\" },\n\t{ \"ASP Playback\",\tNULL,\t\"PLL\" },\n\t{ \"ASP Capture\",\tNULL,\t\"PLL\" },\n\t{ \"DP1 Capture\",\tNULL,\t\"PLL\" },\n\t{ \"DP2 Capture\",\tNULL,\t\"PLL\" },\n\t{ \"DP3 Capture\",\tNULL,\t\"PLL\" },\n\t{ \"DP4 Capture\",\tNULL,\t\"PLL\" },\n\t{ \"DP5 Playback\",\tNULL,\t\"PLL\" },\n\t{ \"DP6 Playback\",\tNULL,\t\"PLL\" },\n\t{ \"DP7 Playback\",\tNULL,\t\"PLL\" },\n\n\t{ \"ADC1 Input\",\t\t\"IN1\",\t\"ADC1_IN1_P\" },\n\t{ \"ADC1 Input\",\t\t\"IN1\",\t\"ADC1_IN1_N\" },\n\t{ \"ADC1 Input\",\t\t\"IN2\",\t\"ADC1_IN2_P\" },\n\t{ \"ADC1 Input\",\t\t\"IN2\",\t\"ADC1_IN2_N\" },\n\n\t{ \"ADC1\",\t\tNULL,\t\"ADC1 Input\" },\n\t{ \"ADC2\",\t\tNULL,\t\"ADC2_IN_P\" },\n\t{ \"ADC2\",\t\tNULL,\t\"ADC2_IN_N\" },\n\n\t{ \"PDM1L\",\t\tNULL,\t\"PDM1_DIN\" },\n\t{ \"PDM1R\",\t\tNULL,\t\"PDM1_DIN\" },\n\t{ \"PDM2L\",\t\tNULL,\t\"PDM2_DIN\" },\n\t{ \"PDM2R\",\t\tNULL,\t\"PDM2_DIN\" },\n\n\t{ \"Decimator 1 Mode\",\t\"PDM\",\t\"PDM1L\" },\n\t{ \"Decimator 1 Mode\",\t\"ADC\",\t\"ADC1\" },\n\t{ \"Decimator 2 Mode\",\t\"PDM\",\t\"PDM1R\" },\n\t{ \"Decimator 2 Mode\",\t\"ADC\",\t\"ADC2\" },\n\n\t{ \"Decimator 1\",\tNULL,\t\"Decimator 1 Mode\" },\n\t{ \"Decimator 2\",\tNULL,\t\"Decimator 2 Mode\" },\n\t{ \"Decimator 3\",\tNULL,\t\"PDM2L\" },\n\t{ \"Decimator 4\",\tNULL,\t\"PDM2R\" },\n\n\t{ \"ASP Capture\",\tNULL,\t\"ASPTX1\" },\n\t{ \"ASP Capture\",\tNULL,\t\"ASPTX2\" },\n\t{ \"ASP Capture\",\tNULL,\t\"ASPTX3\" },\n\t{ \"ASP Capture\",\tNULL,\t\"ASPTX4\" },\n\t{ \"ASP Capture\",\tNULL,\t\"ASPTX5\" },\n\t{ \"ASP Capture\",\tNULL,\t\"ASPTX6\" },\n\t{ \"ASPTX1\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPTX2\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPTX3\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPTX4\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPTX5\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPTX6\",\t\tNULL,\t\"BCLK\" },\n\n\t{ \"ASPRX1\",\t\tNULL,\t\"ASP Playback\" },\n\t{ \"ASPRX2\",\t\tNULL,\t\"ASP Playback\" },\n\t{ \"ASPRX3\",\t\tNULL,\t\"ASP Playback\" },\n\t{ \"ASPRX4\",\t\tNULL,\t\"ASP Playback\" },\n\t{ \"ASPRX5\",\t\tNULL,\t\"ASP Playback\" },\n\t{ \"ASPRX6\",\t\tNULL,\t\"ASP Playback\" },\n\t{ \"ASPRX1\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPRX2\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPRX3\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPRX4\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPRX5\",\t\tNULL,\t\"BCLK\" },\n\t{ \"ASPRX6\",\t\tNULL,\t\"BCLK\" },\n\n\t{ \"DP1 Capture\",\tNULL, \"DP1TX1\" },\n\t{ \"DP1 Capture\",\tNULL, \"DP1TX2\" },\n\t{ \"DP1 Capture\",\tNULL, \"DP1TX3\" },\n\t{ \"DP1 Capture\",\tNULL, \"DP1TX4\" },\n\n\t{ \"DP2 Capture\",\tNULL, \"DP2TX1\" },\n\t{ \"DP2 Capture\",\tNULL, \"DP2TX2\" },\n\n\t{ \"DP3 Capture\",\tNULL, \"DP3TX1\" },\n\t{ \"DP3 Capture\",\tNULL, \"DP3TX2\" },\n\n\t{ \"DP4 Capture\",\tNULL, \"DP4TX1\" },\n\t{ \"DP4 Capture\",\tNULL, \"DP4TX2\" },\n\n\t{ \"DP5RX1\",\t\tNULL, \"DP5 Playback\" },\n\t{ \"DP5RX2\",\t\tNULL, \"DP5 Playback\" },\n\n\t{ \"DP6RX1\",\t\tNULL, \"DP6 Playback\" },\n\t{ \"DP6RX2\",\t\tNULL, \"DP6 Playback\" },\n\n\t{ \"DP7RX1\",\t\tNULL, \"DP7 Playback\" },\n\t{ \"DP7RX2\",\t\tNULL, \"DP7 Playback\" },\n\n\t{ \"AMP1\",\t\tNULL,\t\"vdd-amp\" },\n\t{ \"AMP2\",\t\tNULL,\t\"vdd-amp\" },\n\n\t{ \"AMP1_OUT_P\",\t\tNULL,\t\"AMP1\" },\n\t{ \"AMP1_OUT_N\",\t\tNULL,\t\"AMP1\" },\n\t{ \"AMP2_OUT_P\",\t\tNULL,\t\"AMP2\" },\n\t{ \"AMP2_OUT_N\",\t\tNULL,\t\"AMP2\" },\n\n\t{ \"SPDIF_TX\",\t\tNULL,\t\"SPDIF\" },\n\n\t{ \"AMP3_OUT\",\t\tNULL,\t\"HP\" },\n\t{ \"AMP4_OUT\",\t\tNULL,\t\"HP\" },\n\n\t{ \"Tone 1\",\t\tNULL,\t\"Tone\" },\n\t{ \"Tone 1\",\t\tNULL,\t\"Tone Generator\" },\n\t{ \"Tone 2\",\t\tNULL,\t\"Tone\" },\n\t{ \"Tone 2\",\t\tNULL,\t\"Tone Generator\" },\n\n\t{ \"ISRC1INT2\",\t\tNULL,\t\"ISRC1\" },\n\t{ \"ISRC1INT1\",\t\tNULL,\t\"ISRC1\" },\n\t{ \"ISRC1DEC2\",\t\tNULL,\t\"ISRC1\" },\n\t{ \"ISRC1DEC1\",\t\tNULL,\t\"ISRC1\" },\n\n\t{ \"ISRC2INT2\",\t\tNULL,\t\"ISRC2\" },\n\t{ \"ISRC2INT1\",\t\tNULL,\t\"ISRC2\" },\n\t{ \"ISRC2DEC2\",\t\tNULL,\t\"ISRC2\" },\n\t{ \"ISRC2DEC1\",\t\tNULL,\t\"ISRC2\" },\n\n\t{ \"ASRC_INT1\",\t\tNULL,\t\"ASRC_INT\" },\n\t{ \"ASRC_INT2\",\t\tNULL,\t\"ASRC_INT\" },\n\t{ \"ASRC_INT3\",\t\tNULL,\t\"ASRC_INT\" },\n\t{ \"ASRC_INT4\",\t\tNULL,\t\"ASRC_INT\" },\n\t{ \"ASRC_DEC1\",\t\tNULL,\t\"ASRC_DEC\" },\n\t{ \"ASRC_DEC2\",\t\tNULL,\t\"ASRC_DEC\" },\n\t{ \"ASRC_DEC3\",\t\tNULL,\t\"ASRC_DEC\" },\n\t{ \"ASRC_DEC4\",\t\tNULL,\t\"ASRC_DEC\" },\n\n\t{ \"EQ\",\t\t\tNULL,\t\"EQ Clock\" },\n\n\tCS42L43_MUX_ROUTES(\"ASPTX1\", \"ASPTX1\"),\n\tCS42L43_MUX_ROUTES(\"ASPTX2\", \"ASPTX2\"),\n\tCS42L43_MUX_ROUTES(\"ASPTX3\", \"ASPTX3\"),\n\tCS42L43_MUX_ROUTES(\"ASPTX4\", \"ASPTX4\"),\n\tCS42L43_MUX_ROUTES(\"ASPTX5\", \"ASPTX5\"),\n\tCS42L43_MUX_ROUTES(\"ASPTX6\", \"ASPTX6\"),\n\n\tCS42L43_MUX_ROUTES(\"DP1TX1\", \"DP1TX1\"),\n\tCS42L43_MUX_ROUTES(\"DP1TX2\", \"DP1TX2\"),\n\tCS42L43_MUX_ROUTES(\"DP1TX3\", \"DP1TX3\"),\n\tCS42L43_MUX_ROUTES(\"DP1TX4\", \"DP1TX4\"),\n\tCS42L43_MUX_ROUTES(\"DP2TX1\", \"DP2TX1\"),\n\tCS42L43_MUX_ROUTES(\"DP2TX2\", \"DP2TX2\"),\n\tCS42L43_MUX_ROUTES(\"DP3TX1\", \"DP3TX1\"),\n\tCS42L43_MUX_ROUTES(\"DP3TX2\", \"DP3TX2\"),\n\tCS42L43_MUX_ROUTES(\"DP4TX1\", \"DP4TX1\"),\n\tCS42L43_MUX_ROUTES(\"DP4TX2\", \"DP4TX2\"),\n\n\tCS42L43_MUX_ROUTES(\"ASRC INT1\", \"ASRC_INT1\"),\n\tCS42L43_MUX_ROUTES(\"ASRC INT2\", \"ASRC_INT2\"),\n\tCS42L43_MUX_ROUTES(\"ASRC INT3\", \"ASRC_INT3\"),\n\tCS42L43_MUX_ROUTES(\"ASRC INT4\", \"ASRC_INT4\"),\n\tCS42L43_MUX_ROUTES(\"ASRC DEC1\", \"ASRC_DEC1\"),\n\tCS42L43_MUX_ROUTES(\"ASRC DEC2\", \"ASRC_DEC2\"),\n\tCS42L43_MUX_ROUTES(\"ASRC DEC3\", \"ASRC_DEC3\"),\n\tCS42L43_MUX_ROUTES(\"ASRC DEC4\", \"ASRC_DEC4\"),\n\n\tCS42L43_MUX_ROUTES(\"ISRC1INT1\", \"ISRC1INT1\"),\n\tCS42L43_MUX_ROUTES(\"ISRC1INT2\", \"ISRC1INT2\"),\n\tCS42L43_MUX_ROUTES(\"ISRC1DEC1\", \"ISRC1DEC1\"),\n\tCS42L43_MUX_ROUTES(\"ISRC1DEC2\", \"ISRC1DEC2\"),\n\tCS42L43_MUX_ROUTES(\"ISRC2INT1\", \"ISRC2INT1\"),\n\tCS42L43_MUX_ROUTES(\"ISRC2INT2\", \"ISRC2INT2\"),\n\tCS42L43_MUX_ROUTES(\"ISRC2DEC1\", \"ISRC2DEC1\"),\n\tCS42L43_MUX_ROUTES(\"ISRC2DEC2\", \"ISRC2DEC2\"),\n\n\tCS42L43_MUX_ROUTES(\"SPDIF1\", \"SPDIF\"),\n\tCS42L43_MUX_ROUTES(\"SPDIF2\", \"SPDIF\"),\n\n\tCS42L43_MIXER_ROUTES(\"EQ1\", \"EQ\"),\n\tCS42L43_MIXER_ROUTES(\"EQ2\", \"EQ\"),\n\n\tCS42L43_MIXER_ROUTES(\"Speaker L\", \"AMP1\"),\n\tCS42L43_MIXER_ROUTES(\"Speaker R\", \"AMP2\"),\n\n\tCS42L43_MIXER_ROUTES(\"Headphone L\", \"HP\"),\n\tCS42L43_MIXER_ROUTES(\"Headphone R\", \"HP\"),\n};\n\nstatic int cs42l43_set_sysclk(struct snd_soc_component *component, int clk_id,\n\t\t\t      int src, unsigned int freq, int dir)\n{\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\tint ret;\n\n\tmutex_lock(&cs42l43->pll_lock);\n\tret = cs42l43_set_pll(priv, src, freq);\n\tmutex_unlock(&cs42l43->pll_lock);\n\n\treturn ret;\n}\n\nstatic int cs42l43_component_probe(struct snd_soc_component *component)\n{\n\tstruct cs42l43_codec *priv = snd_soc_component_get_drvdata(component);\n\tstruct cs42l43 *cs42l43 = priv->core;\n\n\tsnd_soc_component_init_regmap(component, cs42l43->regmap);\n\n\tcs42l43_mask_to_slots(priv, CS42L43_DEFAULT_SLOTS, priv->tx_slots);\n\tcs42l43_mask_to_slots(priv, CS42L43_DEFAULT_SLOTS, priv->rx_slots);\n\n\tpriv->component = component;\n\tpriv->constraint = cs42l43_constraint;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver cs42l43_component_drv = {\n\t.name\t\t\t= \"cs42l43-codec\",\n\n\t.probe\t\t\t= cs42l43_component_probe,\n\t.set_sysclk\t\t= cs42l43_set_sysclk,\n\t.set_jack\t\t= cs42l43_set_jack,\n\n\t.endianness\t\t= 1,\n\n\t.controls\t\t= cs42l43_controls,\n\t.num_controls\t\t= ARRAY_SIZE(cs42l43_controls),\n\t.dapm_widgets\t\t= cs42l43_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(cs42l43_widgets),\n\t.dapm_routes\t\t= cs42l43_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(cs42l43_routes),\n};\n\nstruct cs42l43_irq {\n\tunsigned int irq;\n\tconst char *name;\n\tirq_handler_t handler;\n};\n\nstatic const struct cs42l43_irq cs42l43_irqs[] = {\n\t{ CS42L43_PLL_LOST_LOCK, \"pll lost lock\", cs42l43_pll_lost_lock },\n\t{ CS42L43_PLL_READY, \"pll ready\", cs42l43_pll_ready },\n\t{ CS42L43_HP_STARTUP_DONE, \"hp startup\", cs42l43_hp_startup },\n\t{ CS42L43_HP_SHUTDOWN_DONE, \"hp shutdown\", cs42l43_hp_shutdown },\n\t{ CS42L43_HSDET_DONE, \"type detect\", cs42l43_type_detect },\n\t{ CS42L43_TIPSENSE_UNPLUG_PDET, \"tip sense unplug\", cs42l43_tip_sense },\n\t{ CS42L43_TIPSENSE_PLUG_PDET, \"tip sense plug\", cs42l43_tip_sense },\n\t{ CS42L43_DC_DETECT1_TRUE, \"button press\", cs42l43_button_press },\n\t{ CS42L43_DC_DETECT1_FALSE, \"button release\", cs42l43_button_release },\n\t{ CS42L43_HSBIAS_CLAMPED, \"hsbias detect clamp\", cs42l43_bias_detect_clamp },\n\t{ CS42L43_AMP2_CLK_STOP_FAULT, \"spkr clock stop\", cs42l43_spkr_clock_stop },\n\t{ CS42L43_AMP1_CLK_STOP_FAULT, \"spkl clock stop\", cs42l43_spkl_clock_stop },\n\t{ CS42L43_AMP2_VDDSPK_FAULT, \"spkr brown out\", cs42l43_spkr_brown_out },\n\t{ CS42L43_AMP1_VDDSPK_FAULT, \"spkl brown out\", cs42l43_spkl_brown_out },\n\t{ CS42L43_AMP2_SHUTDOWN_DONE, \"spkr shutdown\", cs42l43_spkr_shutdown },\n\t{ CS42L43_AMP1_SHUTDOWN_DONE, \"spkl shutdown\", cs42l43_spkl_shutdown },\n\t{ CS42L43_AMP2_STARTUP_DONE, \"spkr startup\", cs42l43_spkr_startup },\n\t{ CS42L43_AMP1_STARTUP_DONE, \"spkl startup\", cs42l43_spkl_startup },\n\t{ CS42L43_AMP2_THERM_SHDN, \"spkr thermal shutdown\", cs42l43_spkr_therm_shutdown },\n\t{ CS42L43_AMP1_THERM_SHDN, \"spkl thermal shutdown\", cs42l43_spkl_therm_shutdown },\n\t{ CS42L43_AMP2_THERM_WARN, \"spkr thermal warning\", cs42l43_spkr_therm_warm },\n\t{ CS42L43_AMP1_THERM_WARN, \"spkl thermal warning\", cs42l43_spkl_therm_warm },\n\t{ CS42L43_AMP2_SCDET, \"spkr short circuit\", cs42l43_spkr_sc_detect },\n\t{ CS42L43_AMP1_SCDET, \"spkl short circuit\", cs42l43_spkl_sc_detect },\n\t{ CS42L43_HP_ILIMIT, \"hp ilimit\", cs42l43_hp_ilimit },\n\t{ CS42L43_HP_LOADDET_DONE, \"load detect done\", cs42l43_load_detect },\n};\n\nstatic int cs42l43_request_irq(struct cs42l43_codec *priv,\n\t\t\t       struct irq_domain *dom, const char * const name,\n\t\t\t       unsigned int irq, irq_handler_t handler,\n\t\t\t       unsigned long flags)\n{\n\tint ret;\n\n\tret = irq_create_mapping(dom, irq);\n\tif (ret < 0)\n\t\treturn dev_err_probe(priv->dev, ret, \"Failed to map IRQ %s\\n\", name);\n\n\tdev_dbg(priv->dev, \"Request IRQ %d for %s\\n\", ret, name);\n\n\tret = devm_request_threaded_irq(priv->dev, ret, NULL, handler,\n\t\t\t\t\tIRQF_ONESHOT | flags, name, priv);\n\tif (ret)\n\t\treturn dev_err_probe(priv->dev, ret, \"Failed to request IRQ %s\\n\", name);\n\n\treturn 0;\n}\n\nstatic int cs42l43_shutter_irq(struct cs42l43_codec *priv,\n\t\t\t       struct irq_domain *dom, unsigned int shutter,\n\t\t\t       const char * const open_name,\n\t\t\t       const char * const close_name,\n\t\t\t       irq_handler_t handler)\n{\n\tunsigned int open_irq, close_irq;\n\tint ret;\n\n\tswitch (shutter) {\n\tcase 0x1:\n\t\tdev_warn(priv->dev, \"Manual shutters, notifications not available\\n\");\n\t\treturn 0;\n\tcase 0x2:\n\t\topen_irq = CS42L43_GPIO1_RISE;\n\t\tclose_irq = CS42L43_GPIO1_FALL;\n\t\tbreak;\n\tcase 0x4:\n\t\topen_irq = CS42L43_GPIO2_RISE;\n\t\tclose_irq = CS42L43_GPIO2_FALL;\n\t\tbreak;\n\tcase 0x8:\n\t\topen_irq = CS42L43_GPIO3_RISE;\n\t\tclose_irq = CS42L43_GPIO3_FALL;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tret = cs42l43_request_irq(priv, dom, close_name, close_irq, handler, IRQF_SHARED);\n\tif (ret)\n\t\treturn ret;\n\n\treturn cs42l43_request_irq(priv, dom, open_name, open_irq, handler, IRQF_SHARED);\n}\n\nstatic int cs42l43_codec_probe(struct platform_device *pdev)\n{\n\tstruct cs42l43 *cs42l43 = dev_get_drvdata(pdev->dev.parent);\n\tstruct cs42l43_codec *priv;\n\tstruct irq_domain *dom;\n\tunsigned int val;\n\tint i, ret;\n\n\tdom = irq_find_matching_fwnode(dev_fwnode(cs42l43->dev), DOMAIN_BUS_ANY);\n\tif (!dom)\n\t\treturn -EPROBE_DEFER;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = &pdev->dev;\n\tpriv->core = cs42l43;\n\n\tplatform_set_drvdata(pdev, priv);\n\n\tmutex_init(&priv->jack_lock);\n\tmutex_init(&priv->spk_vu_lock);\n\n\tinit_completion(&priv->hp_startup);\n\tinit_completion(&priv->hp_shutdown);\n\tinit_completion(&priv->spkr_shutdown);\n\tinit_completion(&priv->spkl_shutdown);\n\tinit_completion(&priv->spkr_startup);\n\tinit_completion(&priv->spkl_startup);\n\tinit_completion(&priv->pll_ready);\n\tinit_completion(&priv->type_detect);\n\tinit_completion(&priv->load_detect);\n\n\tINIT_DELAYED_WORK(&priv->tip_sense_work, cs42l43_tip_sense_work);\n\tINIT_DELAYED_WORK(&priv->bias_sense_timeout, cs42l43_bias_sense_timeout);\n\tINIT_DELAYED_WORK(&priv->button_press_work, cs42l43_button_press_work);\n\tINIT_WORK(&priv->button_release_work, cs42l43_button_release_work);\n\n\tpm_runtime_set_autosuspend_delay(priv->dev, 100);\n\tpm_runtime_use_autosuspend(priv->dev);\n\tpm_runtime_set_active(priv->dev);\n\tpm_runtime_get_noresume(priv->dev);\n\tdevm_pm_runtime_enable(priv->dev);\n\n\tfor (i = 0; i < ARRAY_SIZE(cs42l43_irqs); i++) {\n\t\tret = cs42l43_request_irq(priv, dom, cs42l43_irqs[i].name,\n\t\t\t\t\t  cs42l43_irqs[i].irq,\n\t\t\t\t\t  cs42l43_irqs[i].handler, 0);\n\t\tif (ret)\n\t\t\tgoto err_pm;\n\t}\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_SHUTTER_CONTROL, &val);\n\tif (ret) {\n\t\tdev_err(priv->dev, \"Failed to check shutter source: %d\\n\", ret);\n\t\tgoto err_pm;\n\t}\n\n\tret = cs42l43_shutter_irq(priv, dom, val & CS42L43_MIC_SHUTTER_CFG_MASK,\n\t\t\t\t  \"mic shutter open\", \"mic shutter close\",\n\t\t\t\t  cs42l43_mic_shutter);\n\tif (ret)\n\t\tgoto err_pm;\n\n\tret = cs42l43_shutter_irq(priv, dom, (val & CS42L43_SPK_SHUTTER_CFG_MASK) >>\n\t\t\t\t  CS42L43_SPK_SHUTTER_CFG_SHIFT,\n\t\t\t\t  \"spk shutter open\", \"spk shutter close\",\n\t\t\t\t  cs42l43_spk_shutter);\n\tif (ret)\n\t\tgoto err_pm;\n\n\t\n\tpriv->mclk = clk_get_optional(cs42l43->dev, \"mclk\");\n\tif (IS_ERR(priv->mclk)) {\n\t\tret = PTR_ERR(priv->mclk);\n\t\tdev_err_probe(priv->dev, ret, \"Failed to get mclk\\n\");\n\t\tgoto err_pm;\n\t}\n\n\tret = devm_snd_soc_register_component(priv->dev, &cs42l43_component_drv,\n\t\t\t\t\t      cs42l43_dais, ARRAY_SIZE(cs42l43_dais));\n\tif (ret) {\n\t\tdev_err_probe(priv->dev, ret, \"Failed to register component\\n\");\n\t\tgoto err_clk;\n\t}\n\n\tpm_runtime_mark_last_busy(priv->dev);\n\tpm_runtime_put_autosuspend(priv->dev);\n\n\treturn 0;\n\nerr_clk:\n\tclk_put(priv->mclk);\nerr_pm:\n\tpm_runtime_put_sync(priv->dev);\n\n\treturn ret;\n}\n\nstatic int cs42l43_codec_remove(struct platform_device *pdev)\n{\n\tstruct cs42l43_codec *priv = platform_get_drvdata(pdev);\n\n\tclk_put(priv->mclk);\n\n\treturn 0;\n}\n\nstatic int cs42l43_codec_runtime_resume(struct device *dev)\n{\n\tstruct cs42l43_codec *priv = dev_get_drvdata(dev);\n\n\tdev_dbg(priv->dev, \"Runtime resume\\n\");\n\n\t\n\tcs42l43_spk_vu_sync(priv);\n\n\treturn 0;\n}\n\nDEFINE_RUNTIME_DEV_PM_OPS(cs42l43_codec_pm_ops, NULL,\n\t\t\t  cs42l43_codec_runtime_resume, NULL);\n\nstatic const struct platform_device_id cs42l43_codec_id_table[] = {\n\t{ \"cs42l43-codec\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(platform, cs42l43_codec_id_table);\n\nstatic struct platform_driver cs42l43_codec_driver = {\n\t.driver = {\n\t\t.name\t= \"cs42l43-codec\",\n\t\t.pm\t= &cs42l43_codec_pm_ops,\n\t},\n\n\t.probe\t\t= cs42l43_codec_probe,\n\t.remove\t\t= cs42l43_codec_remove,\n\t.id_table\t= cs42l43_codec_id_table,\n};\nmodule_platform_driver(cs42l43_codec_driver);\n\nMODULE_IMPORT_NS(SND_SOC_CS42L43);\n\nMODULE_DESCRIPTION(\"CS42L43 CODEC Driver\");\nMODULE_AUTHOR(\"Charles Keepax <ckeepax@opensource.cirrus.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}