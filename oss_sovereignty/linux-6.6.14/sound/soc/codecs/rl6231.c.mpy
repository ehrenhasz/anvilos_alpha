{
  "module_name": "rl6231.c",
  "hash_id": "517205627523dcb612e2350563fd53ad4b0b6f85510ed5774817a41195da597e",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/rl6231.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/regmap.h>\n\n#include <linux/gcd.h>\n#include \"rl6231.h\"\n\n \nint rl6231_get_pre_div(struct regmap *map, unsigned int reg, int sft)\n{\n\tint pd, val;\n\n\tregmap_read(map, reg, &val);\n\n\tval = (val >> sft) & 0x7;\n\n\tswitch (val) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\tcase 3:\n\t\tpd = val + 1;\n\t\tbreak;\n\tcase 4:\n\t\tpd = 6;\n\t\tbreak;\n\tcase 5:\n\t\tpd = 8;\n\t\tbreak;\n\tcase 6:\n\t\tpd = 12;\n\t\tbreak;\n\tcase 7:\n\t\tpd = 16;\n\t\tbreak;\n\tdefault:\n\t\tpd = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn pd;\n}\nEXPORT_SYMBOL_GPL(rl6231_get_pre_div);\n\n \nint rl6231_calc_dmic_clk(int rate)\n{\n\tstatic const int div[] = {2, 3, 4, 6, 8, 12};\n\tint i;\n\n\tif (rate < 1000000 * div[0]) {\n\t\tpr_warn(\"Base clock rate %d is too low\\n\", rate);\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(div); i++) {\n\t\tif ((div[i] % 3) == 0)\n\t\t\tcontinue;\n\t\t \n\t\tif (1536000 * div[i] >= rate)\n\t\t\treturn i;\n\t}\n\n\tpr_warn(\"Base clock rate %d is too high\\n\", rate);\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL_GPL(rl6231_calc_dmic_clk);\n\nstruct pll_calc_map {\n\tunsigned int pll_in;\n\tunsigned int pll_out;\n\tint k;\n\tint n;\n\tint m;\n\tbool m_bp;\n\tbool k_bp;\n};\n\nstatic const struct pll_calc_map pll_preset_table[] = {\n\t{19200000,  4096000,  23, 14, 1, false, false},\n\t{19200000,  24576000,  3, 30, 3, false, false},\n\t{48000000,  3840000,  23,  2, 0, false, false},\n\t{3840000,   24576000,  3, 30, 0, true, false},\n\t{3840000,   22579200,  3,  5, 0, true, false},\n};\n\nstatic unsigned int find_best_div(unsigned int in,\n\tunsigned int max, unsigned int div)\n{\n\tunsigned int d;\n\n\tif (in <= max)\n\t\treturn 1;\n\n\td = in / max;\n\tif (in % max)\n\t\td++;\n\n\twhile (div % d != 0)\n\t\td++;\n\n\n\treturn d;\n}\n\n \nint rl6231_pll_calc(const unsigned int freq_in,\n\tconst unsigned int freq_out, struct rl6231_pll_code *pll_code)\n{\n\tint max_n = RL6231_PLL_N_MAX, max_m = RL6231_PLL_M_MAX;\n\tint i, k, n_t;\n\tint k_t, min_k, max_k, n = 0, m = 0, m_t = 0;\n\tunsigned int red, pll_out, in_t, out_t, div, div_t;\n\tunsigned int red_t = abs(freq_out - freq_in);\n\tunsigned int f_in, f_out, f_max;\n\tbool m_bypass = false, k_bypass = false;\n\n\tif (RL6231_PLL_INP_MAX < freq_in || RL6231_PLL_INP_MIN > freq_in)\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < ARRAY_SIZE(pll_preset_table); i++) {\n\t\tif (freq_in == pll_preset_table[i].pll_in &&\n\t\t\tfreq_out == pll_preset_table[i].pll_out) {\n\t\t\tk = pll_preset_table[i].k;\n\t\t\tm = pll_preset_table[i].m;\n\t\t\tn = pll_preset_table[i].n;\n\t\t\tm_bypass = pll_preset_table[i].m_bp;\n\t\t\tk_bypass = pll_preset_table[i].k_bp;\n\t\t\tpr_debug(\"Use preset PLL parameter table\\n\");\n\t\t\tgoto code_find;\n\t\t}\n\t}\n\n\tmin_k = 80000000 / freq_out - 2;\n\tmax_k = 150000000 / freq_out - 2;\n\tif (max_k > RL6231_PLL_K_MAX)\n\t\tmax_k = RL6231_PLL_K_MAX;\n\tif (min_k > RL6231_PLL_K_MAX)\n\t\tmin_k = max_k = RL6231_PLL_K_MAX;\n\tdiv_t = gcd(freq_in, freq_out);\n\tf_max = 0xffffffff / RL6231_PLL_N_MAX;\n\tdiv = find_best_div(freq_in, f_max, div_t);\n\tf_in = freq_in / div;\n\tf_out = freq_out / div;\n\tk = min_k;\n\tif (min_k < -1)\n\t\tmin_k = -1;\n\tfor (k_t = min_k; k_t <= max_k; k_t++) {\n\t\tfor (n_t = 0; n_t <= max_n; n_t++) {\n\t\t\tin_t = f_in * (n_t + 2);\n\t\t\tpll_out = f_out * (k_t + 2);\n\t\t\tif (in_t == pll_out) {\n\t\t\t\tm_bypass = true;\n\t\t\t\tn = n_t;\n\t\t\t\tk = k_t;\n\t\t\t\tgoto code_find;\n\t\t\t}\n\t\t\tout_t = in_t / (k_t + 2);\n\t\t\tred = abs(f_out - out_t);\n\t\t\tif (red < red_t) {\n\t\t\t\tm_bypass = true;\n\t\t\t\tn = n_t;\n\t\t\t\tm = 0;\n\t\t\t\tk = k_t;\n\t\t\t\tif (red == 0)\n\t\t\t\t\tgoto code_find;\n\t\t\t\tred_t = red;\n\t\t\t}\n\t\t\tfor (m_t = 0; m_t <= max_m; m_t++) {\n\t\t\t\tout_t = in_t / ((m_t + 2) * (k_t + 2));\n\t\t\t\tred = abs(f_out - out_t);\n\t\t\t\tif (red < red_t) {\n\t\t\t\t\tm_bypass = false;\n\t\t\t\t\tn = n_t;\n\t\t\t\t\tm = m_t;\n\t\t\t\t\tk = k_t;\n\t\t\t\t\tif (red == 0)\n\t\t\t\t\t\tgoto code_find;\n\t\t\t\t\tred_t = red;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tpr_debug(\"Only get approximation about PLL\\n\");\n\ncode_find:\n\tif (k == -1) {\n\t\tk_bypass = true;\n\t\tk = 0;\n\t}\n\n\tpll_code->m_bp = m_bypass;\n\tpll_code->k_bp = k_bypass;\n\tpll_code->m_code = m;\n\tpll_code->n_code = n;\n\tpll_code->k_code = k;\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rl6231_pll_calc);\n\nint rl6231_get_clk_info(int sclk, int rate)\n{\n\tint i;\n\tstatic const int pd[] = {1, 2, 3, 4, 6, 8, 12, 16};\n\n\tif (sclk <= 0 || rate <= 0)\n\t\treturn -EINVAL;\n\n\trate = rate << 8;\n\tfor (i = 0; i < ARRAY_SIZE(pd); i++)\n\t\tif (sclk == rate * pd[i])\n\t\t\treturn i;\n\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL_GPL(rl6231_get_clk_info);\n\nMODULE_DESCRIPTION(\"RL6231 class device shared support\");\nMODULE_AUTHOR(\"Oder Chiou <oder_chiou@realtek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}