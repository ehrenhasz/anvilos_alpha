{
  "module_name": "max9867.c",
  "hash_id": "35492f122522cee21dddbd7834b5e93efb6a5d6c311e00edacac8825b7c902ab",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/max9867.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/tlv.h>\n#include \"max9867.h\"\n\nstruct max9867_priv {\n\tstruct clk *mclk;\n\tstruct regmap *regmap;\n\tconst struct snd_pcm_hw_constraint_list *constraints;\n\tunsigned int sysclk, pclk;\n\tbool provider, dsp_a;\n\tunsigned int adc_dac_active;\n};\n\nstatic const char *const max9867_spmode[] = {\n\t\"Stereo Diff\", \"Mono Diff\",\n\t\"Stereo Cap\", \"Mono Cap\",\n\t\"Stereo Single\", \"Mono Single\",\n\t\"Stereo Single Fast\", \"Mono Single Fast\"\n};\nstatic const char *const max9867_filter_text[] = {\"IIR\", \"FIR\"};\n\nstatic const char *const max9867_adc_dac_filter_text[] = {\n\t\"Disabled\",\n\t\"Elliptical/16/256\",\n\t\"Butterworth/16/500\",\n\t\"Elliptical/8/256\",\n\t\"Butterworth/8/500\",\n\t\"Butterworth/8-24\"\n};\n\nenum max9867_adc_dac {\n\tMAX9867_ADC_LEFT,\n\tMAX9867_ADC_RIGHT,\n\tMAX9867_DAC_LEFT,\n\tMAX9867_DAC_RIGHT,\n};\n\nstatic int max9867_adc_dac_event(struct snd_soc_dapm_widget *w,\n\tstruct snd_kcontrol *kcontrol, int event)\n{\n\tstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\tenum max9867_adc_dac adc_dac;\n\n\tif (!strcmp(w->name, \"ADCL\"))\n\t\tadc_dac = MAX9867_ADC_LEFT;\n\telse if (!strcmp(w->name, \"ADCR\"))\n\t\tadc_dac = MAX9867_ADC_RIGHT;\n\telse if (!strcmp(w->name, \"DACL\"))\n\t\tadc_dac = MAX9867_DAC_LEFT;\n\telse if (!strcmp(w->name, \"DACR\"))\n\t\tadc_dac = MAX9867_DAC_RIGHT;\n\telse\n\t\treturn 0;\n\n\tif (SND_SOC_DAPM_EVENT_ON(event))\n\t\tmax9867->adc_dac_active |= BIT(adc_dac);\n\telse if (SND_SOC_DAPM_EVENT_OFF(event))\n\t\tmax9867->adc_dac_active &= ~BIT(adc_dac);\n\n\treturn 0;\n}\n\nstatic int max9867_filter_get(struct snd_kcontrol *kcontrol,\n\t\t\t      struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\tunsigned int reg;\n\tint ret;\n\n\tret = regmap_read(max9867->regmap, MAX9867_CODECFLTR, &reg);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tif (reg & MAX9867_CODECFLTR_MODE)\n\t\tucontrol->value.enumerated.item[0] = 1;\n\telse\n\t\tucontrol->value.enumerated.item[0] = 0;\n\n\treturn 0;\n}\n\nstatic int max9867_filter_set(struct snd_kcontrol *kcontrol,\n\t\t\t      struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_soc_kcontrol_component(kcontrol);\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\tunsigned int reg, mode = ucontrol->value.enumerated.item[0];\n\tint ret;\n\n\tif (mode > 1)\n\t\treturn -EINVAL;\n\n\t \n\tif (max9867->adc_dac_active)\n\t\treturn -EBUSY;\n\n\t \n\tret = regmap_read(max9867->regmap, MAX9867_CODECFLTR, &reg);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tif (mode)\n\t\tmode = MAX9867_CODECFLTR_MODE;\n\n\t \n\tif ((reg & MAX9867_CODECFLTR_MODE) == mode)\n\t\treturn 0;\n\n\t \n\tregmap_update_bits(max9867->regmap, MAX9867_PWRMAN,\n\t\tMAX9867_PWRMAN_SHDN, 0);\n\n\t \n\tregmap_update_bits(max9867->regmap, MAX9867_CODECFLTR,\n\t\tMAX9867_CODECFLTR_MODE, mode);\n\n\t \n\tregmap_update_bits(max9867->regmap, MAX9867_PWRMAN,\n\t\tMAX9867_PWRMAN_SHDN, MAX9867_PWRMAN_SHDN);\n\n\treturn 0;\n}\n\nstatic SOC_ENUM_SINGLE_EXT_DECL(max9867_filter, max9867_filter_text);\nstatic SOC_ENUM_SINGLE_DECL(max9867_dac_filter, MAX9867_CODECFLTR, 0,\n\tmax9867_adc_dac_filter_text);\nstatic SOC_ENUM_SINGLE_DECL(max9867_adc_filter, MAX9867_CODECFLTR, 4,\n\tmax9867_adc_dac_filter_text);\nstatic SOC_ENUM_SINGLE_DECL(max9867_spkmode, MAX9867_MODECONFIG, 0,\n\tmax9867_spmode);\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_RANGE(max9867_master_tlv,\n\t 0,  2, TLV_DB_SCALE_ITEM(-8600, 200, 1),\n\t 3, 17, TLV_DB_SCALE_ITEM(-7800, 400, 0),\n\t18, 25, TLV_DB_SCALE_ITEM(-2000, 200, 0),\n\t26, 34, TLV_DB_SCALE_ITEM( -500, 100, 0),\n\t35, 40, TLV_DB_SCALE_ITEM(  350,  50, 0),\n);\nstatic DECLARE_TLV_DB_SCALE(max9867_mic_tlv, 0, 100, 0);\nstatic DECLARE_TLV_DB_SCALE(max9867_line_tlv, -600, 200, 0);\nstatic DECLARE_TLV_DB_SCALE(max9867_adc_tlv, -1200, 100, 0);\nstatic DECLARE_TLV_DB_SCALE(max9867_dac_tlv, -1500, 100, 0);\nstatic DECLARE_TLV_DB_SCALE(max9867_dacboost_tlv, 0, 600, 0);\nstatic const SNDRV_CTL_TLVD_DECLARE_DB_RANGE(max9867_micboost_tlv,\n\t0, 2, TLV_DB_SCALE_ITEM(-2000, 2000, 1),\n\t3, 3, TLV_DB_SCALE_ITEM(3000, 0, 0),\n);\n\nstatic const struct snd_kcontrol_new max9867_snd_controls[] = {\n\tSOC_DOUBLE_R_TLV(\"Master Playback Volume\", MAX9867_LEFTVOL,\n\t\t\tMAX9867_RIGHTVOL, 0, 40, 1, max9867_master_tlv),\n\tSOC_DOUBLE_R_TLV(\"Line Capture Volume\", MAX9867_LEFTLINELVL,\n\t\t\tMAX9867_RIGHTLINELVL, 0, 15, 1, max9867_line_tlv),\n\tSOC_DOUBLE_R_TLV(\"Mic Capture Volume\", MAX9867_LEFTMICGAIN,\n\t\t\tMAX9867_RIGHTMICGAIN, 0, 20, 1, max9867_mic_tlv),\n\tSOC_DOUBLE_R_TLV(\"Mic Boost Capture Volume\", MAX9867_LEFTMICGAIN,\n\t\t\tMAX9867_RIGHTMICGAIN, 5, 3, 0, max9867_micboost_tlv),\n\tSOC_SINGLE(\"Digital Sidetone Volume\", MAX9867_SIDETONE, 0, 31, 1),\n\tSOC_SINGLE_TLV(\"Digital Playback Volume\", MAX9867_DACLEVEL, 0, 15, 1,\n\t\t\tmax9867_dac_tlv),\n\tSOC_SINGLE_TLV(\"Digital Boost Playback Volume\", MAX9867_DACLEVEL, 4, 3, 0,\n\t\t\tmax9867_dacboost_tlv),\n\tSOC_DOUBLE_TLV(\"Digital Capture Volume\", MAX9867_ADCLEVEL, 4, 0, 15, 1,\n\t\t\tmax9867_adc_tlv),\n\tSOC_ENUM(\"Speaker Mode\", max9867_spkmode),\n\tSOC_SINGLE(\"Volume Smoothing Switch\", MAX9867_MODECONFIG, 6, 1, 0),\n\tSOC_SINGLE(\"Line ZC Switch\", MAX9867_MODECONFIG, 5, 1, 0),\n\tSOC_ENUM_EXT(\"DSP Filter\", max9867_filter, max9867_filter_get, max9867_filter_set),\n\tSOC_ENUM(\"ADC Filter\", max9867_adc_filter),\n\tSOC_ENUM(\"DAC Filter\", max9867_dac_filter),\n\tSOC_SINGLE(\"Mono Playback Switch\", MAX9867_IFC1B, 3, 1, 0),\n};\n\n \nstatic const struct snd_kcontrol_new max9867_input_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE(\"Line Capture Switch\", MAX9867_INPUTCONFIG, 7, 5, 1, 0),\n\tSOC_DAPM_DOUBLE(\"Mic Capture Switch\", MAX9867_INPUTCONFIG, 6, 4, 1, 0),\n};\n\n \nstatic const struct snd_kcontrol_new max9867_output_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE_R(\"Line Bypass Switch\",\n\t\t\t  MAX9867_LEFTLINELVL, MAX9867_RIGHTLINELVL, 6, 1, 1),\n};\n\n \nstatic const struct snd_kcontrol_new max9867_sidetone_mixer_controls[] = {\n\tSOC_DAPM_DOUBLE(\"Sidetone Switch\", MAX9867_SIDETONE, 6, 7, 1, 0),\n};\n\n \nstatic const struct snd_kcontrol_new max9867_line_out_control =\n\tSOC_DAPM_DOUBLE_R(\"Switch\",\n\t\t\t  MAX9867_LEFTVOL, MAX9867_RIGHTVOL, 6, 1, 1);\n\n \nstatic const char *const dmic_mux_text[] = {\n\t\"ADC\", \"DMIC\"\n};\nstatic SOC_ENUM_SINGLE_DECL(left_dmic_mux_enum,\n\t\t\t    MAX9867_MICCONFIG, 5, dmic_mux_text);\nstatic SOC_ENUM_SINGLE_DECL(right_dmic_mux_enum,\n\t\t\t    MAX9867_MICCONFIG, 4, dmic_mux_text);\nstatic const struct snd_kcontrol_new max9867_left_dmic_mux =\n\tSOC_DAPM_ENUM(\"DMICL Mux\", left_dmic_mux_enum);\nstatic const struct snd_kcontrol_new max9867_right_dmic_mux =\n\tSOC_DAPM_ENUM(\"DMICR Mux\", right_dmic_mux_enum);\n\nstatic const struct snd_soc_dapm_widget max9867_dapm_widgets[] = {\n\tSND_SOC_DAPM_INPUT(\"MICL\"),\n\tSND_SOC_DAPM_INPUT(\"MICR\"),\n\tSND_SOC_DAPM_INPUT(\"DMICL\"),\n\tSND_SOC_DAPM_INPUT(\"DMICR\"),\n\tSND_SOC_DAPM_INPUT(\"LINL\"),\n\tSND_SOC_DAPM_INPUT(\"LINR\"),\n\n\tSND_SOC_DAPM_PGA(\"Left Line Input\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_PGA(\"Right Line Input\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER_NAMED_CTL(\"Input Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t\t\t     max9867_input_mixer_controls,\n\t\t\t\t     ARRAY_SIZE(max9867_input_mixer_controls)),\n\tSND_SOC_DAPM_MUX(\"DMICL Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t &max9867_left_dmic_mux),\n\tSND_SOC_DAPM_MUX(\"DMICR Mux\", SND_SOC_NOPM, 0, 0,\n\t\t\t &max9867_right_dmic_mux),\n\tSND_SOC_DAPM_ADC_E(\"ADCL\", \"HiFi Capture\", SND_SOC_NOPM, 0, 0,\n\t\t\t   max9867_adc_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_ADC_E(\"ADCR\", \"HiFi Capture\", SND_SOC_NOPM, 0, 0,\n\t\t\t   max9867_adc_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_MIXER(\"Digital\", SND_SOC_NOPM, 0, 0,\n\t\t\t   max9867_sidetone_mixer_controls,\n\t\t\t   ARRAY_SIZE(max9867_sidetone_mixer_controls)),\n\tSND_SOC_DAPM_MIXER_NAMED_CTL(\"Output Mixer\", SND_SOC_NOPM, 0, 0,\n\t\t\t\t     max9867_output_mixer_controls,\n\t\t\t\t     ARRAY_SIZE(max9867_output_mixer_controls)),\n\tSND_SOC_DAPM_DAC_E(\"DACL\", \"HiFi Playback\", SND_SOC_NOPM, 0, 0,\n\t\t\t   max9867_adc_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_DAC_E(\"DACR\", \"HiFi Playback\", SND_SOC_NOPM, 0, 0,\n\t\t\t   max9867_adc_dac_event,\n\t\t\t   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SWITCH(\"Master Playback\", SND_SOC_NOPM, 0, 0,\n\t\t\t    &max9867_line_out_control),\n\tSND_SOC_DAPM_OUTPUT(\"LOUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ROUT\"),\n};\n\nstatic const struct snd_soc_dapm_route max9867_audio_map[] = {\n\t{\"Left Line Input\", NULL, \"LINL\"},\n\t{\"Right Line Input\", NULL, \"LINR\"},\n\t{\"Input Mixer\", \"Mic Capture Switch\", \"MICL\"},\n\t{\"Input Mixer\", \"Mic Capture Switch\", \"MICR\"},\n\t{\"Input Mixer\", \"Line Capture Switch\", \"Left Line Input\"},\n\t{\"Input Mixer\", \"Line Capture Switch\", \"Right Line Input\"},\n\t{\"DMICL Mux\", \"DMIC\", \"DMICL\"},\n\t{\"DMICR Mux\", \"DMIC\", \"DMICR\"},\n\t{\"DMICL Mux\", \"ADC\", \"Input Mixer\"},\n\t{\"DMICR Mux\", \"ADC\", \"Input Mixer\"},\n\t{\"ADCL\", NULL, \"DMICL Mux\"},\n\t{\"ADCR\", NULL, \"DMICR Mux\"},\n\n\t{\"Digital\", \"Sidetone Switch\", \"ADCL\"},\n\t{\"Digital\", \"Sidetone Switch\", \"ADCR\"},\n\t{\"DACL\", NULL, \"Digital\"},\n\t{\"DACR\", NULL, \"Digital\"},\n\n\t{\"Output Mixer\", \"Line Bypass Switch\", \"Left Line Input\"},\n\t{\"Output Mixer\", \"Line Bypass Switch\", \"Right Line Input\"},\n\t{\"Output Mixer\", NULL, \"DACL\"},\n\t{\"Output Mixer\", NULL, \"DACR\"},\n\t{\"Master Playback\", \"Switch\", \"Output Mixer\"},\n\t{\"LOUT\", NULL, \"Master Playback\"},\n\t{\"ROUT\", NULL, \"Master Playback\"},\n};\n\nstatic const unsigned int max9867_rates_44k1[] = {\n\t11025, 22050, 44100,\n};\n\nstatic const struct snd_pcm_hw_constraint_list max9867_constraints_44k1 = {\n\t.list = max9867_rates_44k1,\n\t.count = ARRAY_SIZE(max9867_rates_44k1),\n};\n\nstatic const unsigned int max9867_rates_48k[] = {\n\t8000, 16000, 32000, 48000,\n};\n\nstatic const struct snd_pcm_hw_constraint_list max9867_constraints_48k = {\n\t.list = max9867_rates_48k,\n\t.count = ARRAY_SIZE(max9867_rates_48k),\n};\n\nstatic int max9867_startup(struct snd_pcm_substream *substream,\n\t\t\t   struct snd_soc_dai *dai)\n{\n        struct max9867_priv *max9867 =\n\t\tsnd_soc_component_get_drvdata(dai->component);\n\n\tif (max9867->constraints)\n\t\tsnd_pcm_hw_constraint_list(substream->runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_RATE, max9867->constraints);\n\n\treturn 0;\n}\n\nstatic int max9867_dai_hw_params(struct snd_pcm_substream *substream,\n\t\tstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\n{\n\tint value, freq = 0;\n\tunsigned long int rate, ratio;\n\tstruct snd_soc_component *component = dai->component;\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\tunsigned int ni = DIV_ROUND_CLOSEST_ULL(96ULL * 0x10000 * params_rate(params),\n\t\t\t\t\t\tmax9867->pclk);\n\n\t \n\tregmap_update_bits(max9867->regmap, MAX9867_AUDIOCLKHIGH,\n\t\tMAX9867_NI_HIGH_MASK, (0xFF00 & ni) >> 8);\n\tregmap_update_bits(max9867->regmap, MAX9867_AUDIOCLKLOW,\n\t\tMAX9867_NI_LOW_MASK, 0x00FF & ni);\n\tif (max9867->provider) {\n\t\tif (max9867->dsp_a) {\n\t\t\tvalue = MAX9867_IFC1B_48X;\n\t\t} else {\n\t\t\trate = params_rate(params) * 2 * params_width(params);\n\t\t\tratio = max9867->pclk / rate;\n\t\t\tswitch (params_width(params)) {\n\t\t\tcase 8:\n\t\t\tcase 16:\n\t\t\t\tswitch (ratio) {\n\t\t\t\tcase 2:\n\t\t\t\t\tvalue = MAX9867_IFC1B_PCLK_2;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\tvalue = MAX9867_IFC1B_PCLK_4;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 8:\n\t\t\t\t\tvalue = MAX9867_IFC1B_PCLK_8;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 16:\n\t\t\t\t\tvalue = MAX9867_IFC1B_PCLK_16;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 24:\n\t\t\t\tvalue = MAX9867_IFC1B_48X;\n\t\t\t\tbreak;\n\t\t\tcase 32:\n\t\t\t\tvalue = MAX9867_IFC1B_64X;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t\tregmap_update_bits(max9867->regmap, MAX9867_IFC1B,\n\t\t\tMAX9867_IFC1B_BCLK_MASK, value);\n\n\t\t \n\t\tif (params_rate(params) == 8000 ||\n\t\t    params_rate(params) == 16000) {\n\t\t\tswitch (max9867->pclk) {\n\t\t\tcase 12000000:\n\t\t\t\tfreq = 0x08;\n\t\t\t\tbreak;\n\t\t\tcase 13000000:\n\t\t\t\tfreq = 0x0A;\n\t\t\t\tbreak;\n\t\t\tcase 16000000:\n\t\t\t\tfreq = 0x0C;\n\t\t\t\tbreak;\n\t\t\tcase 19200000:\n\t\t\t\tfreq = 0x0E;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (freq && params_rate(params) == 16000)\n\t\t\tfreq++;\n\n\t\t \n\t\tregmap_update_bits(max9867->regmap, MAX9867_SYSCLK,\n\t\t\t\t   MAX9867_FREQ_MASK, freq);\n\t} else {\n\t\t \n\t\tregmap_update_bits(max9867->regmap, MAX9867_AUDIOCLKLOW,\n\t\t\tMAX9867_RAPID_LOCK, MAX9867_RAPID_LOCK);\n\t\tregmap_update_bits(max9867->regmap, MAX9867_AUDIOCLKHIGH,\n\t\t\tMAX9867_PLL, MAX9867_PLL);\n\t}\n\treturn 0;\n}\n\nstatic int max9867_mute(struct snd_soc_dai *dai, int mute, int direction)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\n\treturn regmap_update_bits(max9867->regmap, MAX9867_DACLEVEL,\n\t\t\t\t  1 << 6, !!mute << 6);\n}\n\nstatic int max9867_set_dai_sysclk(struct snd_soc_dai *codec_dai,\n\t\tint clk_id, unsigned int freq, int dir)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\tint value = 0;\n\n\t \n\tif (freq >= 10000000 && freq <= 20000000) {\n\t\tvalue |= MAX9867_PSCLK_10_20;\n\t\tmax9867->pclk = freq;\n\t} else if (freq >= 20000000 && freq <= 40000000) {\n\t\tvalue |= MAX9867_PSCLK_20_40;\n\t\tmax9867->pclk = freq / 2;\n\t} else if (freq >= 40000000 && freq <= 60000000) {\n\t\tvalue |= MAX9867_PSCLK_40_60;\n\t\tmax9867->pclk = freq / 4;\n\t} else {\n\t\tdev_err(component->dev,\n\t\t\t\"Invalid clock frequency %uHz (required 10-60MHz)\\n\",\n\t\t\tfreq);\n\t\treturn -EINVAL;\n\t}\n\tif (freq % 48000 == 0)\n\t\tmax9867->constraints = &max9867_constraints_48k;\n\telse if (freq % 44100 == 0)\n\t\tmax9867->constraints = &max9867_constraints_44k1;\n\telse\n\t\tdev_warn(component->dev,\n\t\t\t \"Unable to set exact rate with %uHz clock frequency\\n\",\n\t\t\t freq);\n\tmax9867->sysclk = freq;\n\tvalue = value << MAX9867_PSCLK_SHIFT;\n\tregmap_update_bits(max9867->regmap, MAX9867_SYSCLK,\n\t\t\tMAX9867_PSCLK_MASK, value);\n\treturn 0;\n}\n\nstatic int max9867_dai_set_fmt(struct snd_soc_dai *codec_dai,\n\t\tunsigned int fmt)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\tu8 iface1A, iface1B;\n\n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_CBP_CFP:\n\t\tmax9867->provider = true;\n\t\tiface1A = MAX9867_MASTER;\n\t\tiface1B = MAX9867_IFC1B_48X;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBC_CFC:\n\t\tmax9867->provider = false;\n\t\tiface1A = iface1B = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tmax9867->dsp_a = false;\n\t\tiface1A |= MAX9867_I2S_DLY;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_DSP_A:\n\t\tmax9867->dsp_a = true;\n\t\tiface1A |= MAX9867_TDM_MODE | MAX9867_SDOUT_HIZ;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_IF:\n\t\tiface1A |= MAX9867_WCI_MODE | MAX9867_BCI_MODE;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_IB_NF:\n\t\tiface1A |= MAX9867_BCI_MODE;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_NB_IF:\n\t\tiface1A |= MAX9867_WCI_MODE;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_write(max9867->regmap, MAX9867_IFC1A, iface1A);\n\tregmap_update_bits(max9867->regmap, MAX9867_IFC1B,\n\t\t\t   MAX9867_IFC1B_BCLK_MASK, iface1B);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops max9867_dai_ops = {\n\t.set_sysclk\t= max9867_set_dai_sysclk,\n\t.set_fmt\t= max9867_dai_set_fmt,\n\t.mute_stream\t= max9867_mute,\n\t.startup\t= max9867_startup,\n\t.hw_params\t= max9867_dai_hw_params,\n\t.no_capture_mute = 1,\n};\n\nstatic struct snd_soc_dai_driver max9867_dai[] = {\n\t{\n\t.name = \"max9867-aif1\",\n\t.playback = {\n\t\t.stream_name = \"HiFi Playback\",\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t},\n\t.capture = {\n\t\t.stream_name = \"HiFi Capture\",\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t},\n\t.ops = &max9867_dai_ops,\n\t.symmetric_rate = 1,\n\t}\n};\n\n#ifdef CONFIG_PM\nstatic int max9867_suspend(struct snd_soc_component *component)\n{\n\tsnd_soc_component_force_bias_level(component, SND_SOC_BIAS_OFF);\n\n\treturn 0;\n}\n\nstatic int max9867_resume(struct snd_soc_component *component)\n{\n\tsnd_soc_component_force_bias_level(component, SND_SOC_BIAS_STANDBY);\n\n\treturn 0;\n}\n#else\n#define max9867_suspend\tNULL\n#define max9867_resume\tNULL\n#endif\n\nstatic int max9867_set_bias_level(struct snd_soc_component *component,\n\t\t\t\t  enum snd_soc_bias_level level)\n{\n\tint err;\n\tstruct max9867_priv *max9867 = snd_soc_component_get_drvdata(component);\n\n\tswitch (level) {\n\tcase SND_SOC_BIAS_ON:\n\t\terr = clk_prepare_enable(max9867->mclk);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase SND_SOC_BIAS_STANDBY:\n\t\tif (snd_soc_component_get_bias_level(component) == SND_SOC_BIAS_OFF) {\n\t\t\terr = regcache_sync(max9867->regmap);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\n\t\t\terr = regmap_write(max9867->regmap,\n\t\t\t\t\t   MAX9867_PWRMAN, 0xff);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tbreak;\n\tcase SND_SOC_BIAS_OFF:\n\t\terr = regmap_write(max9867->regmap, MAX9867_PWRMAN, 0);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tregcache_mark_dirty(max9867->regmap);\n\t\tclk_disable_unprepare(max9867->mclk);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver max9867_component = {\n\t.controls\t\t= max9867_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(max9867_snd_controls),\n\t.dapm_routes\t\t= max9867_audio_map,\n\t.num_dapm_routes\t= ARRAY_SIZE(max9867_audio_map),\n\t.dapm_widgets\t\t= max9867_dapm_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(max9867_dapm_widgets),\n\t.suspend\t\t= max9867_suspend,\n\t.resume\t\t\t= max9867_resume,\n\t.set_bias_level\t\t= max9867_set_bias_level,\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic bool max9867_volatile_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX9867_STATUS:\n\tcase MAX9867_JACKSTATUS:\n\tcase MAX9867_AUXHIGH:\n\tcase MAX9867_AUXLOW:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct regmap_config max9867_regmap = {\n\t.reg_bits\t= 8,\n\t.val_bits\t= 8,\n\t.max_register\t= MAX9867_REVISION,\n\t.volatile_reg\t= max9867_volatile_register,\n\t.cache_type\t= REGCACHE_RBTREE,\n};\n\nstatic int max9867_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct max9867_priv *max9867;\n\tint ret, reg;\n\n\tmax9867 = devm_kzalloc(&i2c->dev, sizeof(*max9867), GFP_KERNEL);\n\tif (!max9867)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(i2c, max9867);\n\tmax9867->regmap = devm_regmap_init_i2c(i2c, &max9867_regmap);\n\tif (IS_ERR(max9867->regmap)) {\n\t\tret = PTR_ERR(max9867->regmap);\n\t\tdev_err(&i2c->dev, \"Failed to allocate regmap: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tret = regmap_read(max9867->regmap, MAX9867_REVISION, &reg);\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"Failed to read: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tdev_info(&i2c->dev, \"device revision: %x\\n\", reg);\n\tret = devm_snd_soc_register_component(&i2c->dev, &max9867_component,\n\t\t\tmax9867_dai, ARRAY_SIZE(max9867_dai));\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"Failed to register component: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tmax9867->mclk = devm_clk_get(&i2c->dev, NULL);\n\tif (IS_ERR(max9867->mclk))\n\t\treturn PTR_ERR(max9867->mclk);\n\n\treturn 0;\n}\n\nstatic const struct i2c_device_id max9867_i2c_id[] = {\n\t{ \"max9867\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, max9867_i2c_id);\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id max9867_of_match[] = {\n\t{ .compatible = \"maxim,max9867\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max9867_of_match);\n#endif\n\nstatic struct i2c_driver max9867_i2c_driver = {\n\t.driver = {\n\t\t.name = \"max9867\",\n\t\t.of_match_table = of_match_ptr(max9867_of_match),\n\t},\n\t.probe = max9867_i2c_probe,\n\t.id_table = max9867_i2c_id,\n};\n\nmodule_i2c_driver(max9867_i2c_driver);\n\nMODULE_AUTHOR(\"Ladislav Michl <ladis@linux-mips.org>\");\nMODULE_DESCRIPTION(\"ASoC MAX9867 driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}