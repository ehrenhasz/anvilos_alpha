{
  "module_name": "rk817_codec.c",
  "hash_id": "1d8268eb7446f5d799f16167cfc3dfb73b4b2a0c5edca9ff42dbbbf8df281672",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/codecs/rk817_codec.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/delay.h>\n#include <linux/mfd/rk808.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_gpio.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <sound/core.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/tlv.h>\n\nstruct rk817_codec_priv {\n\tstruct snd_soc_component *component;\n\tstruct rk808 *rk808;\n\tstruct clk *mclk;\n\tunsigned int stereo_sysclk;\n\tbool mic_in_differential;\n};\n\n \n\nstatic int rk817_init(struct snd_soc_component *component)\n{\n\tstruct rk817_codec_priv *rk817 = snd_soc_component_get_drvdata(component);\n\n\tsnd_soc_component_write(component, RK817_CODEC_DDAC_POPD_DACST, 0x02);\n\tsnd_soc_component_write(component, RK817_CODEC_DDAC_SR_LMT0, 0x02);\n\tsnd_soc_component_write(component, RK817_CODEC_DADC_SR_ACL0, 0x02);\n\tsnd_soc_component_write(component, RK817_CODEC_DTOP_VUCTIME, 0xf4);\n\tif (rk817->mic_in_differential) {\n\t\tsnd_soc_component_update_bits(component, RK817_CODEC_AMIC_CFG0, MIC_DIFF_MASK,\n\t\t\tMIC_DIFF_EN);\n\t}\n\n\treturn 0;\n}\n\nstatic int rk817_set_component_pll(struct snd_soc_component *component,\n\t\tint pll_id, int source, unsigned int freq_in,\n\t\tunsigned int freq_out)\n{\n\t \n\tsnd_soc_component_write(component, RK817_CODEC_APLL_CFG1, 0x58);\n\t \n\tsnd_soc_component_write(component, RK817_CODEC_APLL_CFG2, 0x2d);\n\t \n\tsnd_soc_component_write(component, RK817_CODEC_APLL_CFG3, 0x0c);\n\t \n\tsnd_soc_component_write(component, RK817_CODEC_APLL_CFG4, 0xa5);\n\n\treturn 0;\n}\n\n \n\nstatic const DECLARE_TLV_DB_MINMAX(rk817_vol_tlv, -9500, 0);\n\n \n\nstatic const DECLARE_TLV_DB_MINMAX(rk817_gain_tlv, -1800, 2700);\n\nstatic const struct snd_kcontrol_new rk817_volume_controls[] = {\n\tSOC_DOUBLE_R_RANGE_TLV(\"Master Playback Volume\", RK817_CODEC_DDAC_VOLL,\n\t\tRK817_CODEC_DDAC_VOLR, 0, 0x00, 0xff, 1, rk817_vol_tlv),\n\tSOC_DOUBLE_R_RANGE_TLV(\"Master Capture Volume\", RK817_CODEC_DADC_VOLL,\n\t\tRK817_CODEC_DADC_VOLR, 0, 0x00, 0xff, 1, rk817_vol_tlv),\n\tSOC_DOUBLE_TLV(\"Mic Capture Gain\", RK817_CODEC_DMIC_PGA_GAIN, 4, 0, 0xf, 0,\n\t\trk817_gain_tlv),\n};\n\n \n\nstatic const char *dac_mux_text[] = {\n\t\"HP\",\n\t\"SPK\",\n};\n\nstatic SOC_ENUM_SINGLE_VIRT_DECL(dac_enum, dac_mux_text);\n\nstatic const struct snd_kcontrol_new dac_mux =\n\tSOC_DAPM_ENUM(\"Playback Mux\", dac_enum);\n\nstatic const struct snd_soc_dapm_widget rk817_dapm_widgets[] = {\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"LDO Regulator\", RK817_CODEC_AREF_RTCFG1, 6, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"IBIAS Block\", RK817_CODEC_AREF_RTCFG1, 2, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"VAvg Buffer\", RK817_CODEC_AREF_RTCFG1, 1, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"PLL Power\", RK817_CODEC_APLL_CFG5, 0, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S TX1 Transfer Start\", RK817_CODEC_DI2S_RXCMD_TSD, 5, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"ADC Clock\", RK817_CODEC_DTOP_DIGEN_CLKE, 7, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S TX Clock\", RK817_CODEC_DTOP_DIGEN_CLKE, 6, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"ADC Channel Enable\", RK817_CODEC_DTOP_DIGEN_CLKE, 5, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S TX Channel Enable\", RK817_CODEC_DTOP_DIGEN_CLKE, 4, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"MIC Power On\", RK817_CODEC_AMIC_CFG0, 6, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S TX3 Transfer Start\", RK817_CODEC_DI2S_TXCR3_TXCMD, 7, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S TX3 Right Justified\", RK817_CODEC_DI2S_TXCR3_TXCMD, 3, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_ADC(\"ADC L\", \"Capture\", RK817_CODEC_AADC_CFG0, 7, 1),\n\tSND_SOC_DAPM_SUPPLY(\"PGA L Power On\", RK817_CODEC_AMIC_CFG0, 5, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Mic Boost L1\", RK817_CODEC_AMIC_CFG0, 3, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Mic Boost L2\", RK817_CODEC_AMIC_CFG0, 2, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_ADC(\"ADC R\", \"Capture\", RK817_CODEC_AADC_CFG0, 6, 1),\n\tSND_SOC_DAPM_SUPPLY(\"PGA R Power On\", RK817_CODEC_AMIC_CFG0, 4, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Mic Boost R1\", RK817_CODEC_AMIC_CFG0, 3, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Mic Boost R2\", RK817_CODEC_AMIC_CFG0, 3, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"DAC Clock\", RK817_CODEC_DTOP_DIGEN_CLKE, 3, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S RX Clock\", RK817_CODEC_DTOP_DIGEN_CLKE, 2, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"DAC Channel Enable\", RK817_CODEC_DTOP_DIGEN_CLKE, 1, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"I2S RX Channel Enable\", RK817_CODEC_DTOP_DIGEN_CLKE, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"DAC Bias\", RK817_CODEC_ADAC_CFG1, 3, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"DAC Mute Off\", RK817_CODEC_DDAC_MUTE_MIXCTL, 0, 1, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"Class D Mode\", RK817_CODEC_DDAC_MUTE_MIXCTL, 4, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"High Pass Filter\", RK817_CODEC_DDAC_MUTE_MIXCTL, 7, 0, NULL, 0),\n\tSND_SOC_DAPM_DAC(\"SPK DAC\", \"Playback\", RK817_CODEC_ADAC_CFG1, 2, 1),\n\tSND_SOC_DAPM_SUPPLY(\"Enable Class D\", RK817_CODEC_ACLASSD_CFG1, 7, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Disable Class D Mute Ramp\", RK817_CODEC_ACLASSD_CFG1, 6, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Class D Mute Rate 1\", RK817_CODEC_ACLASSD_CFG1, 3, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Class D Mute Rate 2\", RK817_CODEC_ACLASSD_CFG1, 2, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Class D OCPP 2\", RK817_CODEC_ACLASSD_CFG2, 5, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Class D OCPP 3\", RK817_CODEC_ACLASSD_CFG2, 4, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Class D OCPN 2\", RK817_CODEC_ACLASSD_CFG2, 1, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Class D OCPN 3\", RK817_CODEC_ACLASSD_CFG2, 0, 0, NULL, 0),\n\n\t \n\tSND_SOC_DAPM_SUPPLY(\"Headphone Charge Pump\", RK817_CODEC_AHP_CP, 4, 0, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Headphone CP Discharge LDO\", RK817_CODEC_AHP_CP, 3, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Headphone OStage\", RK817_CODEC_AHP_CFG0, 6, 1, NULL, 0),\n\tSND_SOC_DAPM_SUPPLY(\"Headphone Pre Amp\", RK817_CODEC_AHP_CFG0, 5, 1, NULL, 0),\n\tSND_SOC_DAPM_DAC(\"DAC L\", \"Playback\", RK817_CODEC_ADAC_CFG1, 1, 1),\n\tSND_SOC_DAPM_DAC(\"DAC R\", \"Playback\", RK817_CODEC_ADAC_CFG1, 0, 1),\n\n\t \n\tSND_SOC_DAPM_MUX(\"Playback Mux\", SND_SOC_NOPM, 1, 0, &dac_mux),\n\n\t \n\tSND_SOC_DAPM_INPUT(\"MICL\"),\n\tSND_SOC_DAPM_INPUT(\"MICR\"),\n\tSND_SOC_DAPM_OUTPUT(\"HPOL\"),\n\tSND_SOC_DAPM_OUTPUT(\"HPOR\"),\n\tSND_SOC_DAPM_OUTPUT(\"SPKO\"),\n};\n\nstatic const struct snd_soc_dapm_route rk817_dapm_routes[] = {\n\n\t \n\t \n\t{\"ADC L\", NULL, \"LDO Regulator\"},\n\t{\"ADC L\", NULL, \"IBIAS Block\"},\n\t{\"ADC L\", NULL, \"VAvg Buffer\"},\n\t{\"ADC L\", NULL, \"PLL Power\"},\n\t{\"ADC L\", NULL, \"ADC Clock\"},\n\t{\"ADC L\", NULL, \"I2S TX Clock\"},\n\t{\"ADC L\", NULL, \"ADC Channel Enable\"},\n\t{\"ADC L\", NULL, \"I2S TX Channel Enable\"},\n\t{\"ADC L\", NULL, \"I2S TX1 Transfer Start\"},\n\t{\"MICL\", NULL, \"MIC Power On\"},\n\t{\"MICL\", NULL, \"PGA L Power On\"},\n\t{\"MICL\", NULL, \"Mic Boost L1\"},\n\t{\"MICL\", NULL, \"Mic Boost L2\"},\n\t{\"MICL\", NULL, \"I2S TX3 Transfer Start\"},\n\t{\"MICL\", NULL, \"I2S TX3 Right Justified\"},\n\t{\"ADC L\", NULL, \"MICL\"},\n\n\t \n\t{\"ADC R\", NULL, \"LDO Regulator\"},\n\t{\"ADC R\", NULL, \"IBIAS Block\"},\n\t{\"ADC R\", NULL, \"VAvg Buffer\"},\n\t{\"ADC R\", NULL, \"PLL Power\"},\n\t{\"ADC R\", NULL, \"ADC Clock\"},\n\t{\"ADC R\", NULL, \"I2S TX Clock\"},\n\t{\"ADC R\", NULL, \"ADC Channel Enable\"},\n\t{\"ADC R\", NULL, \"I2S TX Channel Enable\"},\n\t{\"ADC R\", NULL, \"I2S TX1 Transfer Start\"},\n\t{\"MICR\", NULL, \"MIC Power On\"},\n\t{\"MICR\", NULL, \"PGA R Power On\"},\n\t{\"MICR\", NULL, \"Mic Boost R1\"},\n\t{\"MICR\", NULL, \"Mic Boost R2\"},\n\t{\"MICR\", NULL, \"I2S TX3 Transfer Start\"},\n\t{\"MICR\", NULL, \"I2S TX3 Right Justified\"},\n\t{\"ADC R\", NULL, \"MICR\"},\n\n\t \n\t \n\t{\"SPK DAC\", NULL, \"LDO Regulator\"},\n\t{\"SPK DAC\", NULL, \"IBIAS Block\"},\n\t{\"SPK DAC\", NULL, \"VAvg Buffer\"},\n\t{\"SPK DAC\", NULL, \"PLL Power\"},\n\t{\"SPK DAC\", NULL, \"I2S TX1 Transfer Start\"},\n\t{\"SPK DAC\", NULL, \"DAC Clock\"},\n\t{\"SPK DAC\", NULL, \"I2S RX Clock\"},\n\t{\"SPK DAC\", NULL, \"DAC Channel Enable\"},\n\t{\"SPK DAC\", NULL, \"I2S RX Channel Enable\"},\n\t{\"SPK DAC\", NULL, \"Class D Mode\"},\n\t{\"SPK DAC\", NULL, \"DAC Bias\"},\n\t{\"SPK DAC\", NULL, \"DAC Mute Off\"},\n\t{\"SPK DAC\", NULL, \"Enable Class D\"},\n\t{\"SPK DAC\", NULL, \"Disable Class D Mute Ramp\"},\n\t{\"SPK DAC\", NULL, \"Class D Mute Rate 1\"},\n\t{\"SPK DAC\", NULL, \"Class D Mute Rate 2\"},\n\t{\"SPK DAC\", NULL, \"Class D OCPP 2\"},\n\t{\"SPK DAC\", NULL, \"Class D OCPP 3\"},\n\t{\"SPK DAC\", NULL, \"Class D OCPN 2\"},\n\t{\"SPK DAC\", NULL, \"Class D OCPN 3\"},\n\t{\"SPK DAC\", NULL, \"High Pass Filter\"},\n\n\t \n\t{\"DAC L\", NULL, \"LDO Regulator\"},\n\t{\"DAC L\", NULL, \"IBIAS Block\"},\n\t{\"DAC L\", NULL, \"VAvg Buffer\"},\n\t{\"DAC L\", NULL, \"PLL Power\"},\n\t{\"DAC L\", NULL, \"I2S TX1 Transfer Start\"},\n\t{\"DAC L\", NULL, \"DAC Clock\"},\n\t{\"DAC L\", NULL, \"I2S RX Clock\"},\n\t{\"DAC L\", NULL, \"DAC Channel Enable\"},\n\t{\"DAC L\", NULL, \"I2S RX Channel Enable\"},\n\t{\"DAC L\", NULL, \"DAC Bias\"},\n\t{\"DAC L\", NULL, \"DAC Mute Off\"},\n\t{\"DAC L\", NULL, \"Headphone Charge Pump\"},\n\t{\"DAC L\", NULL, \"Headphone CP Discharge LDO\"},\n\t{\"DAC L\", NULL, \"Headphone OStage\"},\n\t{\"DAC L\", NULL, \"Headphone Pre Amp\"},\n\n\t \n\t{\"DAC R\", NULL, \"LDO Regulator\"},\n\t{\"DAC R\", NULL, \"IBIAS Block\"},\n\t{\"DAC R\", NULL, \"VAvg Buffer\"},\n\t{\"DAC R\", NULL, \"PLL Power\"},\n\t{\"DAC R\", NULL, \"I2S TX1 Transfer Start\"},\n\t{\"DAC R\", NULL, \"DAC Clock\"},\n\t{\"DAC R\", NULL, \"I2S RX Clock\"},\n\t{\"DAC R\", NULL, \"DAC Channel Enable\"},\n\t{\"DAC R\", NULL, \"I2S RX Channel Enable\"},\n\t{\"DAC R\", NULL, \"DAC Bias\"},\n\t{\"DAC R\", NULL, \"DAC Mute Off\"},\n\t{\"DAC R\", NULL, \"Headphone Charge Pump\"},\n\t{\"DAC R\", NULL, \"Headphone CP Discharge LDO\"},\n\t{\"DAC R\", NULL, \"Headphone OStage\"},\n\t{\"DAC R\", NULL, \"Headphone Pre Amp\"},\n\n\t \n\t{\"Playback Mux\", \"HP\", \"DAC L\"},\n\t{\"Playback Mux\", \"HP\", \"DAC R\"},\n\t{\"Playback Mux\", \"SPK\", \"SPK DAC\"},\n\t{\"SPKO\", NULL, \"Playback Mux\"},\n\t{\"HPOL\", NULL, \"Playback Mux\"},\n\t{\"HPOR\", NULL, \"Playback Mux\"},\n};\n\nstatic int rk817_set_dai_sysclk(struct snd_soc_dai *codec_dai,\n\t\t\t\tint clk_id, unsigned int freq, int dir)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tstruct rk817_codec_priv *rk817 = snd_soc_component_get_drvdata(component);\n\n\trk817->stereo_sysclk = freq;\n\n\treturn 0;\n}\n\nstatic int rk817_set_dai_fmt(struct snd_soc_dai *codec_dai,\n\t\t\t     unsigned int fmt)\n{\n\tstruct snd_soc_component *component = codec_dai->component;\n\tunsigned int i2s_mst = 0;\n\n\tswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\n\tcase SND_SOC_DAIFMT_CBS_CFS:\n\t\ti2s_mst |= RK817_I2S_MODE_SLV;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_CBM_CFM:\n\t\ti2s_mst |= RK817_I2S_MODE_MST;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(component->dev, \"%s : set master mask failed!\\n\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_update_bits(component, RK817_CODEC_DI2S_CKM,\n\t\t\t\t      RK817_I2S_MODE_MASK, i2s_mst);\n\n\treturn 0;\n}\n\nstatic int rk817_hw_params(struct snd_pcm_substream *substream,\n\t\t\t   struct snd_pcm_hw_params *params,\n\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\n\tswitch (params_format(params)) {\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tsnd_soc_component_write(component, RK817_CODEC_DI2S_RXCR2,\n\t\t\t\t\tVDW_RX_16BITS);\n\t\tsnd_soc_component_write(component, RK817_CODEC_DI2S_TXCR2,\n\t\t\t\t\tVDW_TX_16BITS);\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S24_LE:\n\tcase SNDRV_PCM_FORMAT_S32_LE:\n\t\tsnd_soc_component_write(component, RK817_CODEC_DI2S_RXCR2,\n\t\t\t\t\tVDW_RX_24BITS);\n\t\tsnd_soc_component_write(component, RK817_CODEC_DI2S_TXCR2,\n\t\t\t\t\tVDW_TX_24BITS);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rk817_digital_mute(struct snd_soc_dai *dai, int mute, int stream)\n{\n\tstruct snd_soc_component *component = dai->component;\n\n\tif (mute)\n\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t      RK817_CODEC_DDAC_MUTE_MIXCTL,\n\t\t\t\t\t      DACMT_MASK, DACMT_ENABLE);\n\telse\n\t\tsnd_soc_component_update_bits(component,\n\t\t\t\t\t      RK817_CODEC_DDAC_MUTE_MIXCTL,\n\t\t\t\t\t      DACMT_MASK, DACMT_DISABLE);\n\n\treturn 0;\n}\n\n#define RK817_PLAYBACK_RATES (SNDRV_PCM_RATE_8000 |\\\n\t\t\t      SNDRV_PCM_RATE_16000 |\t\\\n\t\t\t      SNDRV_PCM_RATE_32000 |\t\\\n\t\t\t      SNDRV_PCM_RATE_44100 |\t\\\n\t\t\t      SNDRV_PCM_RATE_48000 |\t\\\n\t\t\t      SNDRV_PCM_RATE_96000)\n\n#define RK817_CAPTURE_RATES (SNDRV_PCM_RATE_8000 |\\\n\t\t\t      SNDRV_PCM_RATE_16000 |\t\\\n\t\t\t      SNDRV_PCM_RATE_32000 |\t\\\n\t\t\t      SNDRV_PCM_RATE_44100 |\t\\\n\t\t\t      SNDRV_PCM_RATE_48000 |\t\\\n\t\t\t      SNDRV_PCM_RATE_96000)\n\n#define RK817_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S20_3LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S24_LE |\\\n\t\t\tSNDRV_PCM_FMTBIT_S32_LE)\n\nstatic const struct snd_soc_dai_ops rk817_dai_ops = {\n\t.hw_params\t= rk817_hw_params,\n\t.set_fmt\t= rk817_set_dai_fmt,\n\t.set_sysclk\t= rk817_set_dai_sysclk,\n\t.mute_stream\t= rk817_digital_mute,\n\t.no_capture_mute\t= 1,\n};\n\nstatic struct snd_soc_dai_driver rk817_dai[] = {\n\t{\n\t\t.name = \"rk817-hifi\",\n\t\t.playback = {\n\t\t\t.stream_name = \"Playback\",\n\t\t\t.channels_min = 2,\n\t\t\t.channels_max = 8,\n\t\t\t.rates = RK817_PLAYBACK_RATES,\n\t\t\t.formats = RK817_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = RK817_CAPTURE_RATES,\n\t\t\t.formats = RK817_FORMATS,\n\t\t},\n\t\t.ops = &rk817_dai_ops,\n\t},\n};\n\nstatic int rk817_probe(struct snd_soc_component *component)\n{\n\tstruct rk817_codec_priv *rk817 = snd_soc_component_get_drvdata(component);\n\tstruct rk808 *rk808 = dev_get_drvdata(component->dev->parent);\n\n\tsnd_soc_component_init_regmap(component, rk808->regmap);\n\trk817->component = component;\n\n\tsnd_soc_component_write(component, RK817_CODEC_DTOP_LPT_SRST, 0x40);\n\n\trk817_init(component);\n\n\t \n\n\tsnd_soc_component_set_pll(component, 0, 0, 0, 0);\n\n\treturn 0;\n}\n\nstatic void rk817_remove(struct snd_soc_component *component)\n{\n\tsnd_soc_component_exit_regmap(component);\n}\n\nstatic const struct snd_soc_component_driver soc_codec_dev_rk817 = {\n\t.probe = rk817_probe,\n\t.remove = rk817_remove,\n\t.idle_bias_on = 1,\n\t.use_pmdown_time = 1,\n\t.endianness = 1,\n\t.controls = rk817_volume_controls,\n\t.num_controls = ARRAY_SIZE(rk817_volume_controls),\n\t.dapm_routes = rk817_dapm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(rk817_dapm_routes),\n\t.dapm_widgets = rk817_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(rk817_dapm_widgets),\n\t.set_pll = rk817_set_component_pll,\n};\n\nstatic void rk817_codec_parse_dt_property(struct device *dev,\n\t\t\t\t\t struct rk817_codec_priv *rk817)\n{\n\tstruct device_node *node;\n\n\tnode = of_get_child_by_name(dev->parent->of_node, \"codec\");\n\tif (!node) {\n\t\tdev_dbg(dev, \"%s() Can not get child: codec\\n\",\n\t\t\t__func__);\n\t}\n\n\trk817->mic_in_differential =\n\t\t\tof_property_read_bool(node, \"rockchip,mic-in-differential\");\n\n\tof_node_put(node);\n}\n\nstatic int rk817_platform_probe(struct platform_device *pdev)\n{\n\tstruct rk808 *rk808 = dev_get_drvdata(pdev->dev.parent);\n\tstruct rk817_codec_priv *rk817_codec_data;\n\tint ret;\n\n\trk817_codec_data = devm_kzalloc(&pdev->dev,\n\t\t\t\t\tsizeof(struct rk817_codec_priv),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!rk817_codec_data)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, rk817_codec_data);\n\n\trk817_codec_data->rk808 = rk808;\n\n\trk817_codec_parse_dt_property(&pdev->dev, rk817_codec_data);\n\n\trk817_codec_data->mclk = devm_clk_get(pdev->dev.parent, \"mclk\");\n\tif (IS_ERR(rk817_codec_data->mclk)) {\n\t\tdev_dbg(&pdev->dev, \"Unable to get mclk\\n\");\n\t\tret = -ENXIO;\n\t\tgoto err_;\n\t}\n\n\tret = clk_prepare_enable(rk817_codec_data->mclk);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"%s() clock prepare error %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto err_;\n\t}\n\n\tret = devm_snd_soc_register_component(&pdev->dev, &soc_codec_dev_rk817,\n\t\t\t\t\t      rk817_dai, ARRAY_SIZE(rk817_dai));\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"%s() register codec error %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto err_clk;\n\t}\n\n\treturn 0;\n\nerr_clk:\n\tclk_disable_unprepare(rk817_codec_data->mclk);\nerr_:\n\treturn ret;\n}\n\nstatic void rk817_platform_remove(struct platform_device *pdev)\n{\n\tstruct rk817_codec_priv *rk817 = platform_get_drvdata(pdev);\n\n\tclk_disable_unprepare(rk817->mclk);\n}\n\nstatic struct platform_driver rk817_codec_driver = {\n\t.driver = {\n\t\t   .name = \"rk817-codec\",\n\t\t   },\n\t.probe = rk817_platform_probe,\n\t.remove_new = rk817_platform_remove,\n};\n\nmodule_platform_driver(rk817_codec_driver);\n\nMODULE_DESCRIPTION(\"ASoC RK817 codec driver\");\nMODULE_AUTHOR(\"binyuan <kevan.lan@rock-chips.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:rk817-codec\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}