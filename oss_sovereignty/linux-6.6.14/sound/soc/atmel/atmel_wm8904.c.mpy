{
  "module_name": "atmel_wm8904.c",
  "hash_id": "0fa63ffee89c3516d2c6567863bdd67fc20232e16f93383d0c6a3a27864701b0",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/atmel/atmel_wm8904.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n\n#include <sound/soc.h>\n\n#include \"../codecs/wm8904.h\"\n#include \"atmel_ssc_dai.h\"\n\nstatic const struct snd_soc_dapm_widget atmel_asoc_wm8904_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line In Jack\", NULL),\n};\n\nstatic int atmel_asoc_wm8904_hw_params(struct snd_pcm_substream *substream,\n\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\tret = snd_soc_dai_set_pll(codec_dai, WM8904_FLL_MCLK, WM8904_FLL_MCLK,\n\t\t32768, params_rate(params) * 256);\n\tif (ret < 0) {\n\t\tpr_err(\"%s - failed to set wm8904 codec PLL.\", __func__);\n\t\treturn ret;\n\t}\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8904_CLK_FLL,\n\t\t\t0, SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tpr_err(\"%s -failed to set wm8904 SYSCLK\\n\", __func__);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops atmel_asoc_wm8904_ops = {\n\t.hw_params = atmel_asoc_wm8904_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(pcm,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"wm8904-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link atmel_asoc_wm8904_dailink = {\n\t.name = \"WM8904\",\n\t.stream_name = \"WM8904 PCM\",\n\t.dai_fmt = SND_SOC_DAIFMT_I2S\n\t\t| SND_SOC_DAIFMT_NB_NF\n\t\t| SND_SOC_DAIFMT_CBP_CFP,\n\t.ops = &atmel_asoc_wm8904_ops,\n\tSND_SOC_DAILINK_REG(pcm),\n};\n\nstatic struct snd_soc_card atmel_asoc_wm8904_card = {\n\t.name = \"atmel_asoc_wm8904\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &atmel_asoc_wm8904_dailink,\n\t.num_links = 1,\n\t.dapm_widgets = atmel_asoc_wm8904_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(atmel_asoc_wm8904_dapm_widgets),\n\t.fully_routed = true,\n};\n\nstatic int atmel_asoc_wm8904_dt_init(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct device_node *codec_np, *cpu_np;\n\tstruct snd_soc_card *card = &atmel_asoc_wm8904_card;\n\tstruct snd_soc_dai_link *dailink = &atmel_asoc_wm8904_dailink;\n\tint ret;\n\n\tif (!np) {\n\t\tdev_err(&pdev->dev, \"only device tree supported\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = snd_soc_of_parse_card_name(card, \"atmel,model\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to parse card name\\n\");\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_of_parse_audio_routing(card, \"atmel,audio-routing\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to parse audio routing\\n\");\n\t\treturn ret;\n\t}\n\n\tcpu_np = of_parse_phandle(np, \"atmel,ssc-controller\", 0);\n\tif (!cpu_np) {\n\t\tdev_err(&pdev->dev, \"failed to get dai and pcm info\\n\");\n\t\tret = -EINVAL;\n\t\treturn ret;\n\t}\n\tdailink->cpus->of_node = cpu_np;\n\tdailink->platforms->of_node = cpu_np;\n\tof_node_put(cpu_np);\n\n\tcodec_np = of_parse_phandle(np, \"atmel,audio-codec\", 0);\n\tif (!codec_np) {\n\t\tdev_err(&pdev->dev, \"failed to get codec info\\n\");\n\t\tret = -EINVAL;\n\t\treturn ret;\n\t}\n\tdailink->codecs->of_node = codec_np;\n\tof_node_put(codec_np);\n\n\treturn 0;\n}\n\nstatic int atmel_asoc_wm8904_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &atmel_asoc_wm8904_card;\n\tstruct snd_soc_dai_link *dailink = &atmel_asoc_wm8904_dailink;\n\tint id, ret;\n\n\tcard->dev = &pdev->dev;\n\tret = atmel_asoc_wm8904_dt_init(pdev);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to init dt info\\n\");\n\t\treturn ret;\n\t}\n\n\tid = of_alias_get_id((struct device_node *)dailink->cpus->of_node, \"ssc\");\n\tret = atmel_ssc_set_audio(id);\n\tif (ret != 0) {\n\t\tdev_err(&pdev->dev, \"failed to set SSC %d for audio\\n\", id);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_register_card(card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"snd_soc_register_card failed\\n\");\n\t\tgoto err_set_audio;\n\t}\n\n\treturn 0;\n\nerr_set_audio:\n\tatmel_ssc_put_audio(id);\n\treturn ret;\n}\n\nstatic void atmel_asoc_wm8904_remove(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = platform_get_drvdata(pdev);\n\tstruct snd_soc_dai_link *dailink = &atmel_asoc_wm8904_dailink;\n\tint id;\n\n\tid = of_alias_get_id((struct device_node *)dailink->cpus->of_node, \"ssc\");\n\n\tsnd_soc_unregister_card(card);\n\tatmel_ssc_put_audio(id);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id atmel_asoc_wm8904_dt_ids[] = {\n\t{ .compatible = \"atmel,asoc-wm8904\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, atmel_asoc_wm8904_dt_ids);\n#endif\n\nstatic struct platform_driver atmel_asoc_wm8904_driver = {\n\t.driver = {\n\t\t.name = \"atmel-wm8904-audio\",\n\t\t.of_match_table = of_match_ptr(atmel_asoc_wm8904_dt_ids),\n\t\t.pm\t\t= &snd_soc_pm_ops,\n\t},\n\t.probe = atmel_asoc_wm8904_probe,\n\t.remove_new = atmel_asoc_wm8904_remove,\n};\n\nmodule_platform_driver(atmel_asoc_wm8904_driver);\n\n \nMODULE_AUTHOR(\"Bo Shen <voice.shen@atmel.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC machine driver for Atmel EK with WM8904 codec\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}