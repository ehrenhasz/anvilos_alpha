{
  "module_name": "sam9x5_wm8731.c",
  "hash_id": "54309931b6eaba100fad86587e82971ee9af45940211944111b76b2f2a14c874",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/atmel/sam9x5_wm8731.c",
  "human_readable_source": "\n \n#include <linux/of.h>\n#include <linux/export.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/device.h>\n\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n#include <sound/soc-dapm.h>\n\n#include \"../codecs/wm8731.h\"\n#include \"atmel_ssc_dai.h\"\n\n\n#define MCLK_RATE 12288000\n\n#define DRV_NAME \"sam9x5-snd-wm8731\"\n\nstruct sam9x5_drvdata {\n\tint ssc_id;\n};\n\n \nstatic int sam9x5_wm8731_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct device *dev = rtd->dev;\n\tint ret;\n\n\tdev_dbg(dev, \"%s called\\n\", __func__);\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_XTAL,\n\t\t\t\t     MCLK_RATE, SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to set WM8731 SYSCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\n \nstatic const struct snd_soc_dapm_widget sam9x5_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line In Jack\", NULL),\n};\n\nstatic int sam9x5_wm8731_driver_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct device_node *codec_np, *cpu_np;\n\tstruct snd_soc_card *card;\n\tstruct snd_soc_dai_link *dai;\n\tstruct sam9x5_drvdata *priv;\n\tstruct snd_soc_dai_link_component *comp;\n\tint ret;\n\n\tif (!np) {\n\t\tdev_err(&pdev->dev, \"No device node supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tcard = devm_kzalloc(&pdev->dev, sizeof(*card), GFP_KERNEL);\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tdai = devm_kzalloc(&pdev->dev, sizeof(*dai), GFP_KERNEL);\n\tcomp = devm_kzalloc(&pdev->dev, 3 * sizeof(*comp), GFP_KERNEL);\n\tif (!dai || !card || !priv || !comp) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tcard->dev = &pdev->dev;\n\tcard->owner = THIS_MODULE;\n\tcard->dai_link = dai;\n\tcard->num_links = 1;\n\tcard->dapm_widgets = sam9x5_dapm_widgets;\n\tcard->num_dapm_widgets = ARRAY_SIZE(sam9x5_dapm_widgets);\n\n\tdai->cpus = &comp[0];\n\tdai->num_cpus = 1;\n\tdai->codecs = &comp[1];\n\tdai->num_codecs = 1;\n\tdai->platforms = &comp[2];\n\tdai->num_platforms = 1;\n\n\tdai->name = \"WM8731\";\n\tdai->stream_name = \"WM8731 PCM\";\n\tdai->codecs->dai_name = \"wm8731-hifi\";\n\tdai->init = sam9x5_wm8731_init;\n\tdai->dai_fmt = SND_SOC_DAIFMT_DSP_A | SND_SOC_DAIFMT_NB_NF\n\t\t| SND_SOC_DAIFMT_CBP_CFP;\n\n\tret = snd_soc_of_parse_card_name(card, \"atmel,model\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"atmel,model node missing\\n\");\n\t\tgoto out;\n\t}\n\n\tret = snd_soc_of_parse_audio_routing(card, \"atmel,audio-routing\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"atmel,audio-routing node missing\\n\");\n\t\tgoto out;\n\t}\n\n\tcodec_np = of_parse_phandle(np, \"atmel,audio-codec\", 0);\n\tif (!codec_np) {\n\t\tdev_err(&pdev->dev, \"atmel,audio-codec node missing\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tdai->codecs->of_node = codec_np;\n\n\tcpu_np = of_parse_phandle(np, \"atmel,ssc-controller\", 0);\n\tif (!cpu_np) {\n\t\tdev_err(&pdev->dev, \"atmel,ssc-controller node missing\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out_put_codec_np;\n\t}\n\tdai->cpus->of_node = cpu_np;\n\tdai->platforms->of_node = cpu_np;\n\n\tpriv->ssc_id = of_alias_get_id(cpu_np, \"ssc\");\n\n\tret = atmel_ssc_set_audio(priv->ssc_id);\n\tif (ret != 0) {\n\t\tdev_err(&pdev->dev, \"Failed to set SSC %d for audio: %d\\n\",\n\t\t\tret, priv->ssc_id);\n\t\tgoto out_put_cpu_np;\n\t}\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Platform device allocation failed\\n\");\n\t\tgoto out_put_audio;\n\t}\n\n\tdev_dbg(&pdev->dev, \"%s ok\\n\", __func__);\n\n\tgoto out_put_cpu_np;\n\nout_put_audio:\n\tatmel_ssc_put_audio(priv->ssc_id);\nout_put_cpu_np:\n\tof_node_put(cpu_np);\nout_put_codec_np:\n\tof_node_put(codec_np);\nout:\n\treturn ret;\n}\n\nstatic void sam9x5_wm8731_driver_remove(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = platform_get_drvdata(pdev);\n\tstruct sam9x5_drvdata *priv = card->drvdata;\n\n\tatmel_ssc_put_audio(priv->ssc_id);\n}\n\nstatic const struct of_device_id sam9x5_wm8731_of_match[] = {\n\t{ .compatible = \"atmel,sam9x5-wm8731-audio\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, sam9x5_wm8731_of_match);\n\nstatic struct platform_driver sam9x5_wm8731_driver = {\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.of_match_table = of_match_ptr(sam9x5_wm8731_of_match),\n\t},\n\t.probe = sam9x5_wm8731_driver_probe,\n\t.remove_new = sam9x5_wm8731_driver_remove,\n};\nmodule_platform_driver(sam9x5_wm8731_driver);\n\n \nMODULE_AUTHOR(\"Nicolas Ferre <nicolas.ferre@atmel.com>\");\nMODULE_AUTHOR(\"Richard Genoud <richard.genoud@gmail.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC machine driver for AT91SAM9x5 - WM8731\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:\" DRV_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}