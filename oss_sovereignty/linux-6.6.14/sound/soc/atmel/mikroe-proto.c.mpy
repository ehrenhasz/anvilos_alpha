{
  "module_name": "mikroe-proto.c",
  "hash_id": "512981fb15fbf339b4833f66fe5602527b844eb57d90144d06727608e3544b80",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/atmel/mikroe-proto.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n#include <sound/jack.h>\n\n#include \"../codecs/wm8731.h\"\n\n#define XTAL_RATE 12288000\t \n\nstatic int snd_proto_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\t \n\tint ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_XTAL,\n\t\t\t\t\t XTAL_RATE, SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(card->dev, \"Failed to set WM8731 SYSCLK: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dapm_widget snd_proto_widget[] = {\n\tSND_SOC_DAPM_MIC(\"Microphone Jack\", NULL),\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route snd_proto_route[] = {\n\t \n\t{\"Headphone Jack\", NULL, \"LHPOUT\"},\n\t{\"Headphone Jack\", NULL, \"RHPOUT\"},\n\n\t \n\t{\"MICIN\", NULL, \"Mic Bias\"},\n\t{\"Mic Bias\", NULL, \"Microphone Jack\"},\n};\n\n \nstatic struct snd_soc_card snd_proto = {\n\t.name\t\t= \"snd_mikroe_proto\",\n\t.owner\t\t= THIS_MODULE,\n\t.dapm_widgets\t= snd_proto_widget,\n\t.num_dapm_widgets = ARRAY_SIZE(snd_proto_widget),\n\t.dapm_routes\t= snd_proto_route,\n\t.num_dapm_routes = ARRAY_SIZE(snd_proto_route),\n};\n\nstatic int snd_proto_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_dai_link *dai;\n\tstruct snd_soc_dai_link_component *comp;\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct device_node *codec_np, *cpu_np;\n\tstruct device_node *bitclkmaster = NULL;\n\tstruct device_node *framemaster = NULL;\n\tunsigned int dai_fmt;\n\tint ret = 0;\n\n\tif (!np) {\n\t\tdev_err(&pdev->dev, \"No device node supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_proto.dev = &pdev->dev;\n\tret = snd_soc_of_parse_card_name(&snd_proto, \"model\");\n\tif (ret)\n\t\treturn ret;\n\n\tdai = devm_kzalloc(&pdev->dev, sizeof(*dai), GFP_KERNEL);\n\tif (!dai)\n\t\treturn -ENOMEM;\n\n\t \n\tcomp = devm_kzalloc(&pdev->dev, 3 * sizeof(*comp), GFP_KERNEL);\n\tif (!comp)\n\t\treturn -ENOMEM;\n\n\tsnd_proto.dai_link = dai;\n\tsnd_proto.num_links = 1;\n\n\tdai->cpus = &comp[0];\n\tdai->num_cpus = 1;\n\tdai->codecs = &comp[1];\n\tdai->num_codecs = 1;\n\tdai->platforms = &comp[2];\n\tdai->num_platforms = 1;\n\n\tdai->name = \"WM8731\";\n\tdai->stream_name = \"WM8731 HiFi\";\n\tdai->codecs->dai_name = \"wm8731-hifi\";\n\tdai->init = &snd_proto_init;\n\n\tcodec_np = of_parse_phandle(np, \"audio-codec\", 0);\n\tif (!codec_np) {\n\t\tdev_err(&pdev->dev, \"audio-codec node missing\\n\");\n\t\treturn -EINVAL;\n\t}\n\tdai->codecs->of_node = codec_np;\n\n\tcpu_np = of_parse_phandle(np, \"i2s-controller\", 0);\n\tif (!cpu_np) {\n\t\tdev_err(&pdev->dev, \"i2s-controller missing\\n\");\n\t\tret = -EINVAL;\n\t\tgoto put_codec_node;\n\t}\n\tdai->cpus->of_node = cpu_np;\n\tdai->platforms->of_node = cpu_np;\n\n\tdai_fmt = snd_soc_daifmt_parse_format(np, NULL);\n\tsnd_soc_daifmt_parse_clock_provider_as_phandle(np, NULL,\n\t\t\t\t\t\t       &bitclkmaster, &framemaster);\n\tif (bitclkmaster != framemaster) {\n\t\tdev_err(&pdev->dev, \"Must be the same bitclock and frame master\\n\");\n\t\tret = -EINVAL;\n\t\tgoto put_cpu_node;\n\t}\n\tif (bitclkmaster) {\n\t\tif (codec_np == bitclkmaster)\n\t\t\tdai_fmt |= SND_SOC_DAIFMT_CBP_CFP;\n\t\telse\n\t\t\tdai_fmt |= SND_SOC_DAIFMT_CBC_CFC;\n\t} else {\n\t\tdai_fmt |= snd_soc_daifmt_parse_clock_provider_as_flag(np, NULL);\n\t}\n\n\n\tdai->dai_fmt = dai_fmt;\n\tret = snd_soc_register_card(&snd_proto);\n\tif (ret)\n\t\tdev_err_probe(&pdev->dev, ret,\n\t\t\t\"snd_soc_register_card() failed\\n\");\n\n\nput_cpu_node:\n\tof_node_put(bitclkmaster);\n\tof_node_put(framemaster);\n\tof_node_put(cpu_np);\nput_codec_node:\n\tof_node_put(codec_np);\n\treturn ret;\n}\n\nstatic void snd_proto_remove(struct platform_device *pdev)\n{\n\tsnd_soc_unregister_card(&snd_proto);\n}\n\nstatic const struct of_device_id snd_proto_of_match[] = {\n\t{ .compatible = \"mikroe,mikroe-proto\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, snd_proto_of_match);\n\nstatic struct platform_driver snd_proto_driver = {\n\t.driver = {\n\t\t.name   = \"snd-mikroe-proto\",\n\t\t.of_match_table = snd_proto_of_match,\n\t},\n\t.probe\t  = snd_proto_probe,\n\t.remove_new\t = snd_proto_remove,\n};\n\nmodule_platform_driver(snd_proto_driver);\n\nMODULE_AUTHOR(\"Florian Meier\");\nMODULE_DESCRIPTION(\"ASoC Driver for PROTO board (WM8731)\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}