{
  "module_name": "sam9g20_wm8731.c",
  "hash_id": "cf3cfde9f1f620be3df1c8a3827986268c2929d3f152ca93642b6f0fe67fa7eb",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/atmel/sam9g20_wm8731.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/kernel.h>\n#include <linux/clk.h>\n#include <linux/timer.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/of.h>\n\n#include <linux/atmel-ssc.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#include \"../codecs/wm8731.h\"\n#include \"atmel-pcm.h\"\n#include \"atmel_ssc_dai.h\"\n\n#define MCLK_RATE 12000000\n\n \n#undef ENABLE_MIC_INPUT\n\nstatic const struct snd_soc_dapm_widget at91sam9g20ek_dapm_widgets[] = {\n\tSND_SOC_DAPM_MIC(\"Int Mic\", NULL),\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route intercon[] = {\n\n\t \n\t{\"Ext Spk\", NULL, \"LHPOUT\"},\n\t{\"Ext Spk\", NULL, \"RHPOUT\"},\n\n\t \n\t{\"MICIN\", NULL, \"Mic Bias\"},\n\t{\"Mic Bias\", NULL, \"Int Mic\"},\n};\n\n \nstatic int at91sam9g20ek_wm8731_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct device *dev = rtd->dev;\n\tint ret;\n\n\tdev_dbg(dev, \"%s called\\n\", __func__);\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,\n\t\t\t\t     MCLK_RATE, SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to set WM8731 SYSCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n#ifndef ENABLE_MIC_INPUT\n\tsnd_soc_dapm_nc_pin(&rtd->card->dapm, \"Int Mic\");\n#endif\n\n\treturn 0;\n}\n\nSND_SOC_DAILINK_DEFS(pcm,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"at91rm9200_ssc.0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8731.0-001b\", \"wm8731-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"at91rm9200_ssc.0\")));\n\nstatic struct snd_soc_dai_link at91sam9g20ek_dai = {\n\t.name = \"WM8731\",\n\t.stream_name = \"WM8731 PCM\",\n\t.init = at91sam9g20ek_wm8731_init,\n\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t   SND_SOC_DAIFMT_CBP_CFP,\n#ifndef ENABLE_MIC_INPUT\n\t.playback_only = true,\n#endif\n\tSND_SOC_DAILINK_REG(pcm),\n};\n\nstatic struct snd_soc_card snd_soc_at91sam9g20ek = {\n\t.name = \"AT91SAMG20-EK\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &at91sam9g20ek_dai,\n\t.num_links = 1,\n\n\t.dapm_widgets = at91sam9g20ek_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(at91sam9g20ek_dapm_widgets),\n\t.dapm_routes = intercon,\n\t.num_dapm_routes = ARRAY_SIZE(intercon),\n\t.fully_routed = true,\n};\n\nstatic int at91sam9g20ek_audio_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct device_node *codec_np, *cpu_np;\n\tstruct snd_soc_card *card = &snd_soc_at91sam9g20ek;\n\tint ret;\n\n\tif (!np) {\n\t\treturn -ENODEV;\n\t}\n\n\tret = atmel_ssc_set_audio(0);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"ssc channel is not valid: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tcard->dev = &pdev->dev;\n\n\t \n\tret = snd_soc_of_parse_card_name(card, \"atmel,model\");\n\tif (ret)\n\t\tgoto err;\n\n\tret = snd_soc_of_parse_audio_routing(card,\n\t\t\"atmel,audio-routing\");\n\tif (ret)\n\t\tgoto err;\n\n\t \n\tat91sam9g20ek_dai.codecs->name = NULL;\n\tcodec_np = of_parse_phandle(np, \"atmel,audio-codec\", 0);\n\tif (!codec_np) {\n\t\tdev_err(&pdev->dev, \"codec info missing\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\tat91sam9g20ek_dai.codecs->of_node = codec_np;\n\n\t \n\tat91sam9g20ek_dai.cpus->dai_name = NULL;\n\tat91sam9g20ek_dai.platforms->name = NULL;\n\tcpu_np = of_parse_phandle(np, \"atmel,ssc-controller\", 0);\n\tif (!cpu_np) {\n\t\tdev_err(&pdev->dev, \"dai and pcm info missing\\n\");\n\t\tof_node_put(codec_np);\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\tat91sam9g20ek_dai.cpus->of_node = cpu_np;\n\tat91sam9g20ek_dai.platforms->of_node = cpu_np;\n\n\tof_node_put(codec_np);\n\tof_node_put(cpu_np);\n\n\tret = snd_soc_register_card(card);\n\tif (ret) {\n\t\tdev_err_probe(&pdev->dev, ret,\n\t\t\t      \"snd_soc_register_card() failed\\n\");\n\t\tgoto err;\n\t}\n\n\treturn 0;\n\nerr:\n\tatmel_ssc_put_audio(0);\n\treturn ret;\n}\n\nstatic void at91sam9g20ek_audio_remove(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = platform_get_drvdata(pdev);\n\n\tsnd_soc_unregister_card(card);\n\tatmel_ssc_put_audio(0);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id at91sam9g20ek_wm8731_dt_ids[] = {\n\t{ .compatible = \"atmel,at91sam9g20ek-wm8731-audio\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, at91sam9g20ek_wm8731_dt_ids);\n#endif\n\nstatic struct platform_driver at91sam9g20ek_audio_driver = {\n\t.driver = {\n\t\t.name\t= \"at91sam9g20ek-audio\",\n\t\t.of_match_table = of_match_ptr(at91sam9g20ek_wm8731_dt_ids),\n\t},\n\t.probe\t= at91sam9g20ek_audio_probe,\n\t.remove_new = at91sam9g20ek_audio_remove,\n};\n\nmodule_platform_driver(at91sam9g20ek_audio_driver);\n\n \nMODULE_AUTHOR(\"Sedji Gaouaou <sedji.gaouaou@atmel.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC AT91SAM9G20EK_WM8731\");\nMODULE_ALIAS(\"platform:at91sam9g20ek-audio\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}