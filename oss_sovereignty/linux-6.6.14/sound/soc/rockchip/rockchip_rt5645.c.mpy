{
  "module_name": "rockchip_rt5645.c",
  "hash_id": "67e0b35766a689b2a6f553cef0aa79c492cf743882f8cd8677c6028b27cab024",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/rockchip/rockchip_rt5645.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/gpio.h>\n#include <linux/of_gpio.h>\n#include <linux/delay.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include \"rockchip_i2s.h\"\n#include \"../codecs/rt5645.h\"\n\n#define DRV_NAME \"rockchip-snd-rt5645\"\n\nstatic struct snd_soc_jack headset_jack;\nstatic struct snd_soc_jack_pin headset_jack_pins[] = {\n\t{\n\t\t.pin = \"Headphones\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic const struct snd_soc_dapm_widget rk_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphones\", NULL),\n\tSND_SOC_DAPM_SPK(\"Speakers\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Int Mic\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route rk_audio_map[] = {\n\t \n\t{\"DMIC L2\", NULL, \"Int Mic\"},\n\t{\"DMIC R2\", NULL, \"Int Mic\"},\n\t{\"RECMIXL\", NULL, \"Headset Mic\"},\n\t{\"RECMIXR\", NULL, \"Headset Mic\"},\n\n\t \n\t{\"Headphones\", NULL, \"HPOR\"},\n\t{\"Headphones\", NULL, \"HPOL\"},\n\t{\"Speakers\", NULL, \"SPOL\"},\n\t{\"Speakers\", NULL, \"SPOR\"},\n};\n\nstatic const struct snd_kcontrol_new rk_mc_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphones\"),\n\tSOC_DAPM_PIN_SWITCH(\"Speakers\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Int Mic\"),\n};\n\nstatic int rk_aif1_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tint ret = 0;\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint mclk;\n\n\tswitch (params_rate(params)) {\n\tcase 8000:\n\tcase 16000:\n\tcase 24000:\n\tcase 32000:\n\tcase 48000:\n\tcase 64000:\n\tcase 96000:\n\t\tmclk = 12288000;\n\t\tbreak;\n\tcase 11025:\n\tcase 22050:\n\tcase 44100:\n\tcase 88200:\n\t\tmclk = 11289600;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, 0, mclk,\n\t\t\t\t     SND_SOC_CLOCK_OUT);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Can't set codec clock %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, 0, mclk,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Can't set codec clock %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic int rk_init(struct snd_soc_pcm_runtime *runtime)\n{\n\tstruct snd_soc_card *card = runtime->card;\n\tint ret;\n\n\t \n\tret = snd_soc_card_jack_new_pins(card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADPHONE | SND_JACK_MICROPHONE |\n\t\t\t\t\t SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t SND_JACK_BTN_2 | SND_JACK_BTN_3,\n\t\t\t\t\t &headset_jack,\n\t\t\t\t\t headset_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(headset_jack_pins));\n\tif (ret) {\n\t\tdev_err(card->dev, \"New Headset Jack failed! (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn rt5645_set_jack_detect(asoc_rtd_to_codec(runtime, 0)->component,\n\t\t\t\t     &headset_jack,\n\t\t\t\t     &headset_jack,\n\t\t\t\t     &headset_jack);\n}\n\nstatic const struct snd_soc_ops rk_aif1_ops = {\n\t.hw_params = rk_aif1_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(pcm,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"rt5645-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link rk_dailink = {\n\t.name = \"rt5645\",\n\t.stream_name = \"rt5645 PCM\",\n\t.init = rk_init,\n\t.ops = &rk_aif1_ops,\n\t \n\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\tSND_SOC_DAIFMT_CBS_CFS,\n\tSND_SOC_DAILINK_REG(pcm),\n};\n\nstatic struct snd_soc_card snd_soc_card_rk = {\n\t.name = \"I2S-RT5650\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &rk_dailink,\n\t.num_links = 1,\n\t.dapm_widgets = rk_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(rk_dapm_widgets),\n\t.dapm_routes = rk_audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(rk_audio_map),\n\t.controls = rk_mc_controls,\n\t.num_controls = ARRAY_SIZE(rk_mc_controls),\n};\n\nstatic int snd_rk_mc_probe(struct platform_device *pdev)\n{\n\tint ret = 0;\n\tstruct snd_soc_card *card = &snd_soc_card_rk;\n\tstruct device_node *np = pdev->dev.of_node;\n\n\t \n\tcard->dev = &pdev->dev;\n\n\trk_dailink.codecs->of_node = of_parse_phandle(np,\n\t\t\t\"rockchip,audio-codec\", 0);\n\tif (!rk_dailink.codecs->of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'rockchip,audio-codec' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\trk_dailink.cpus->of_node = of_parse_phandle(np,\n\t\t\t\"rockchip,i2s-controller\", 0);\n\tif (!rk_dailink.cpus->of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'rockchip,i2s-controller' missing or invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto put_codec_of_node;\n\t}\n\n\trk_dailink.platforms->of_node = rk_dailink.cpus->of_node;\n\n\tret = snd_soc_of_parse_card_name(card, \"rockchip,model\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Soc parse card name failed %d\\n\", ret);\n\t\tgoto put_cpu_of_node;\n\t}\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Soc register card failed %d\\n\", ret);\n\t\tgoto put_cpu_of_node;\n\t}\n\n\treturn ret;\n\nput_cpu_of_node:\n\tof_node_put(rk_dailink.cpus->of_node);\n\trk_dailink.cpus->of_node = NULL;\nput_codec_of_node:\n\tof_node_put(rk_dailink.codecs->of_node);\n\trk_dailink.codecs->of_node = NULL;\n\n\treturn ret;\n}\n\nstatic void snd_rk_mc_remove(struct platform_device *pdev)\n{\n\tof_node_put(rk_dailink.cpus->of_node);\n\trk_dailink.cpus->of_node = NULL;\n\tof_node_put(rk_dailink.codecs->of_node);\n\trk_dailink.codecs->of_node = NULL;\n}\n\nstatic const struct of_device_id rockchip_rt5645_of_match[] = {\n\t{ .compatible = \"rockchip,rockchip-audio-rt5645\", },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(of, rockchip_rt5645_of_match);\n\nstatic struct platform_driver snd_rk_mc_driver = {\n\t.probe = snd_rk_mc_probe,\n\t.remove_new = snd_rk_mc_remove,\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = rockchip_rt5645_of_match,\n\t},\n};\n\nmodule_platform_driver(snd_rk_mc_driver);\n\nMODULE_AUTHOR(\"Xing Zheng <zhengxing@rock-chips.com>\");\nMODULE_DESCRIPTION(\"Rockchip rt5645 machine ASoC driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:\" DRV_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}