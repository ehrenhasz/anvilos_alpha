{
  "module_name": "rk3399_gru_sound.c",
  "hash_id": "c1a4e5976eff2465f6d9b8f8bd2c3fd76453572f9341ecc5e36355e984e1e72a",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/rockchip/rk3399_gru_sound.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/gpio.h>\n#include <linux/of_gpio.h>\n#include <linux/delay.h>\n#include <linux/spi/spi.h>\n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include \"rockchip_i2s.h\"\n#include \"../codecs/da7219.h\"\n#include \"../codecs/rt5514.h\"\n\n#define DRV_NAME \"rk3399-gru-sound\"\n\n#define SOUND_FS\t256\n\nstatic unsigned int dmic_wakeup_delay;\n\nstatic struct snd_soc_jack rockchip_sound_jack;\n\n \nstatic struct snd_soc_jack_pin rockchip_sound_jack_pins[] = {\n\t{\n\t\t.pin = \"Headphones\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Line Out\",\n\t\t.mask = SND_JACK_LINEOUT,\n\t},\n};\n\nstatic const struct snd_soc_dapm_widget rockchip_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphones\", NULL),\n\tSND_SOC_DAPM_SPK(\"Speakers\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line Out\", NULL),\n\tSND_SOC_DAPM_MIC(\"Int Mic\", NULL),\n\tSND_SOC_DAPM_LINE(\"HDMI\", NULL),\n};\n\nstatic const struct snd_kcontrol_new rockchip_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphones\"),\n\tSOC_DAPM_PIN_SWITCH(\"Speakers\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Line Out\"),\n\tSOC_DAPM_PIN_SWITCH(\"Int Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"HDMI\"),\n};\n\nstatic int rockchip_sound_max98357a_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int mclk;\n\tint ret;\n\n\tmclk = params_rate(params) * SOUND_FS;\n\n\tret = snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0), 0, mclk, 0);\n\tif (ret) {\n\t\tdev_err(rtd->card->dev, \"%s() error setting sysclk to %u: %d\\n\",\n\t\t\t\t__func__, mclk, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int rockchip_sound_rt5514_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tunsigned int mclk;\n\tint ret;\n\n\tmclk = params_rate(params) * SOUND_FS;\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, 0, mclk,\n\t\t\t\t     SND_SOC_CLOCK_OUT);\n\tif (ret < 0) {\n\t\tdev_err(rtd->card->dev, \"Can't set cpu clock out %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, RT5514_SCLK_S_MCLK,\n\t\t\t\t     mclk, SND_SOC_CLOCK_IN);\n\tif (ret) {\n\t\tdev_err(rtd->card->dev, \"%s() error setting sysclk to %u: %d\\n\",\n\t\t\t\t__func__, params_rate(params) * 512, ret);\n\t\treturn ret;\n\t}\n\n\t \n\tmsleep(dmic_wakeup_delay);\n\n\treturn 0;\n}\n\nstatic int rockchip_sound_da7219_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint mclk, ret;\n\n\t \n\tswitch (params_rate(params)) {\n\tcase 8000:\n\tcase 16000:\n\tcase 24000:\n\tcase 32000:\n\tcase 48000:\n\tcase 64000:\n\tcase 96000:\n\t\tmclk = 12288000;\n\t\tbreak;\n\tcase 11025:\n\tcase 22050:\n\tcase 44100:\n\tcase 88200:\n\t\tmclk = 11289600;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, 0, mclk,\n\t\t\t\t     SND_SOC_CLOCK_OUT);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Can't set cpu clock out %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, 0, mclk,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Can't set codec clock in %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_pll(codec_dai, 0, DA7219_SYSCLK_MCLK, 0, 0);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Can't set pll sysclk mclk %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct snd_soc_jack cdn_dp_card_jack;\n\nstatic int rockchip_sound_cdndp_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\t \n\tret = snd_soc_card_jack_new(card, \"DP Jack\", SND_JACK_LINEOUT,\n\t\t\t\t    &cdn_dp_card_jack);\n\tif (ret) {\n\t\tdev_err(card->dev, \"Can't create DP Jack %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn snd_soc_component_set_jack(component, &cdn_dp_card_jack, NULL);\n}\n\nstatic int rockchip_sound_da7219_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, 0, 12288000,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Init can't set codec clock in %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_pll(codec_dai, 0, DA7219_SYSCLK_MCLK, 0, 0);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"Init can't set pll sysclk mclk %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_LINEOUT |\n\t\t\t\t\t SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t SND_JACK_BTN_2 | SND_JACK_BTN_3,\n\t\t\t\t\t &rockchip_sound_jack,\n\t\t\t\t\t rockchip_sound_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(rockchip_sound_jack_pins));\n\n\tif (ret) {\n\t\tdev_err(rtd->card->dev, \"New Headset Jack failed! (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tsnd_jack_set_key(\n\t\trockchip_sound_jack.jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(\n\t\trockchip_sound_jack.jack, SND_JACK_BTN_1, KEY_VOLUMEUP);\n\tsnd_jack_set_key(\n\t\trockchip_sound_jack.jack, SND_JACK_BTN_2, KEY_VOLUMEDOWN);\n\tsnd_jack_set_key(\n\t\trockchip_sound_jack.jack, SND_JACK_BTN_3, KEY_VOICECOMMAND);\n\n\tsnd_soc_component_set_jack(component, &rockchip_sound_jack, NULL);\n\n\treturn 0;\n}\n\nstatic int rockchip_sound_dmic_hw_params(struct snd_pcm_substream *substream,\n\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int mclk;\n\tint ret;\n\n\tmclk = params_rate(params) * SOUND_FS;\n\n\tret = snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0), 0, mclk, 0);\n\tif (ret) {\n\t\tdev_err(rtd->card->dev, \"%s() error setting sysclk to %u: %d\\n\",\n\t\t\t\t__func__, mclk, ret);\n\t\treturn ret;\n\t}\n\n\t \n\tmsleep(dmic_wakeup_delay);\n\n\treturn 0;\n}\n\nstatic int rockchip_sound_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\truntime->hw.formats = SNDRV_PCM_FMTBIT_S16_LE;\n\treturn snd_pcm_hw_constraint_minmax(runtime, SNDRV_PCM_HW_PARAM_RATE,\n\t\t\t8000, 96000);\n}\n\nstatic const struct snd_soc_ops rockchip_sound_max98357a_ops = {\n\t.startup = rockchip_sound_startup,\n\t.hw_params = rockchip_sound_max98357a_hw_params,\n};\n\nstatic const struct snd_soc_ops rockchip_sound_rt5514_ops = {\n\t.startup = rockchip_sound_startup,\n\t.hw_params = rockchip_sound_rt5514_hw_params,\n};\n\nstatic const struct snd_soc_ops rockchip_sound_da7219_ops = {\n\t.startup = rockchip_sound_startup,\n\t.hw_params = rockchip_sound_da7219_hw_params,\n};\n\nstatic const struct snd_soc_ops rockchip_sound_dmic_ops = {\n\t.startup = rockchip_sound_startup,\n\t.hw_params = rockchip_sound_dmic_hw_params,\n};\n\nstatic struct snd_soc_card rockchip_sound_card = {\n\t.name = \"rk3399-gru-sound\",\n\t.owner = THIS_MODULE,\n\t.dapm_widgets = rockchip_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(rockchip_dapm_widgets),\n\t.controls = rockchip_controls,\n\t.num_controls = ARRAY_SIZE(rockchip_controls),\n};\n\nenum {\n\tDAILINK_CDNDP,\n\tDAILINK_DA7219,\n\tDAILINK_DMIC,\n\tDAILINK_MAX98357A,\n\tDAILINK_RT5514,\n\tDAILINK_RT5514_DSP,\n};\n\nSND_SOC_DAILINK_DEFS(cdndp,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"spdif-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(da7219,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"da7219-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(dmic,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"dmic-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(max98357a,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"HiFi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(rt5514,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"rt5514-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(rt5514_dsp,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic const struct snd_soc_dai_link rockchip_dais[] = {\n\t[DAILINK_CDNDP] = {\n\t\t.name = \"DP\",\n\t\t.stream_name = \"DP PCM\",\n\t\t.init = rockchip_sound_cdndp_init,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS,\n\t\tSND_SOC_DAILINK_REG(cdndp),\n\t},\n\t[DAILINK_DA7219] = {\n\t\t.name = \"DA7219\",\n\t\t.stream_name = \"DA7219 PCM\",\n\t\t.init = rockchip_sound_da7219_init,\n\t\t.ops = &rockchip_sound_da7219_ops,\n\t\t \n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS,\n\t\tSND_SOC_DAILINK_REG(da7219),\n\t},\n\t[DAILINK_DMIC] = {\n\t\t.name = \"DMIC\",\n\t\t.stream_name = \"DMIC PCM\",\n\t\t.ops = &rockchip_sound_dmic_ops,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS,\n\t\tSND_SOC_DAILINK_REG(dmic),\n\t},\n\t[DAILINK_MAX98357A] = {\n\t\t.name = \"MAX98357A\",\n\t\t.stream_name = \"MAX98357A PCM\",\n\t\t.ops = &rockchip_sound_max98357a_ops,\n\t\t \n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS,\n\t\tSND_SOC_DAILINK_REG(max98357a),\n\t},\n\t[DAILINK_RT5514] = {\n\t\t.name = \"RT5514\",\n\t\t.stream_name = \"RT5514 PCM\",\n\t\t.ops = &rockchip_sound_rt5514_ops,\n\t\t \n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS,\n\t\tSND_SOC_DAILINK_REG(rt5514),\n\t},\n\t \n\t[DAILINK_RT5514_DSP] = {\n\t\t.name = \"RT5514 DSP\",\n\t\t.stream_name = \"Wake on Voice\",\n\t\tSND_SOC_DAILINK_REG(rt5514_dsp),\n\t},\n};\n\nstatic const struct snd_soc_dapm_route rockchip_sound_cdndp_routes[] = {\n\t \n\t{\"HDMI\", NULL, \"TX\"},\n};\n\nstatic const struct snd_soc_dapm_route rockchip_sound_da7219_routes[] = {\n\t \n\t{\"Headphones\", NULL, \"HPL\"},\n\t{\"Headphones\", NULL, \"HPR\"},\n\n\t \n\t{\"MIC\", NULL, \"Headset Mic\"},\n};\n\nstatic const struct snd_soc_dapm_route rockchip_sound_dmic_routes[] = {\n\t \n\t{\"DMic\", NULL, \"Int Mic\"},\n};\n\nstatic const struct snd_soc_dapm_route rockchip_sound_max98357a_routes[] = {\n\t \n\t{\"Speakers\", NULL, \"Speaker\"},\n};\n\nstatic const struct snd_soc_dapm_route rockchip_sound_rt5514_routes[] = {\n\t \n\t{\"DMIC1L\", NULL, \"Int Mic\"},\n\t{\"DMIC1R\", NULL, \"Int Mic\"},\n};\n\nstruct rockchip_sound_route {\n\tconst struct snd_soc_dapm_route *routes;\n\tint num_routes;\n};\n\nstatic const struct rockchip_sound_route rockchip_routes[] = {\n\t[DAILINK_CDNDP] = {\n\t\t.routes = rockchip_sound_cdndp_routes,\n\t\t.num_routes = ARRAY_SIZE(rockchip_sound_cdndp_routes),\n\t},\n\t[DAILINK_DA7219] = {\n\t\t.routes = rockchip_sound_da7219_routes,\n\t\t.num_routes = ARRAY_SIZE(rockchip_sound_da7219_routes),\n\t},\n\t[DAILINK_DMIC] = {\n\t\t.routes = rockchip_sound_dmic_routes,\n\t\t.num_routes = ARRAY_SIZE(rockchip_sound_dmic_routes),\n\t},\n\t[DAILINK_MAX98357A] = {\n\t\t.routes = rockchip_sound_max98357a_routes,\n\t\t.num_routes = ARRAY_SIZE(rockchip_sound_max98357a_routes),\n\t},\n\t[DAILINK_RT5514] = {\n\t\t.routes = rockchip_sound_rt5514_routes,\n\t\t.num_routes = ARRAY_SIZE(rockchip_sound_rt5514_routes),\n\t},\n\t[DAILINK_RT5514_DSP] = {},\n};\n\nstruct dailink_match_data {\n\tconst char *compatible;\n\tstruct bus_type *bus_type;\n};\n\nstatic const struct dailink_match_data dailink_match[] = {\n\t[DAILINK_CDNDP] = {\n\t\t.compatible = \"rockchip,rk3399-cdn-dp\",\n\t},\n\t[DAILINK_DA7219] = {\n\t\t.compatible = \"dlg,da7219\",\n\t},\n\t[DAILINK_DMIC] = {\n\t\t.compatible = \"dmic-codec\",\n\t},\n\t[DAILINK_MAX98357A] = {\n\t\t.compatible = \"maxim,max98357a\",\n\t},\n\t[DAILINK_RT5514] = {\n\t\t.compatible = \"realtek,rt5514\",\n\t\t.bus_type = &i2c_bus_type,\n\t},\n\t[DAILINK_RT5514_DSP] = {\n\t\t.compatible = \"realtek,rt5514\",\n\t\t.bus_type = &spi_bus_type,\n\t},\n};\n\nstatic int rockchip_sound_codec_node_match(struct device_node *np_codec)\n{\n\tstruct device *dev;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(dailink_match); i++) {\n\t\tif (!of_device_is_compatible(np_codec,\n\t\t\t\t\t     dailink_match[i].compatible))\n\t\t\tcontinue;\n\n\t\tif (dailink_match[i].bus_type) {\n\t\t\tdev = bus_find_device_by_of_node(dailink_match[i].bus_type,\n\t\t\t\t\t\t\t np_codec);\n\t\t\tif (!dev)\n\t\t\t\tcontinue;\n\t\t\tput_device(dev);\n\t\t}\n\n\t\treturn i;\n\t}\n\treturn -1;\n}\n\nstatic int rockchip_sound_of_parse_dais(struct device *dev,\n\t\t\t\t\tstruct snd_soc_card *card)\n{\n\tstruct device_node *np_cpu, *np_cpu0, *np_cpu1;\n\tstruct device_node *np_codec;\n\tstruct snd_soc_dai_link *dai;\n\tstruct snd_soc_dapm_route *routes;\n\tint i, index;\n\tint num_routes;\n\n\tcard->dai_link = devm_kzalloc(dev, sizeof(rockchip_dais),\n\t\t\t\t      GFP_KERNEL);\n\tif (!card->dai_link)\n\t\treturn -ENOMEM;\n\n\tnum_routes = 0;\n\tfor (i = 0; i < ARRAY_SIZE(rockchip_routes); i++)\n\t\tnum_routes += rockchip_routes[i].num_routes;\n\troutes = devm_kcalloc(dev, num_routes, sizeof(*routes),\n\t\t\t      GFP_KERNEL);\n\tif (!routes)\n\t\treturn -ENOMEM;\n\tcard->dapm_routes = routes;\n\n\tnp_cpu0 = of_parse_phandle(dev->of_node, \"rockchip,cpu\", 0);\n\tnp_cpu1 = of_parse_phandle(dev->of_node, \"rockchip,cpu\", 1);\n\n\tcard->num_dapm_routes = 0;\n\tcard->num_links = 0;\n\tfor (i = 0; i < ARRAY_SIZE(rockchip_dais); i++) {\n\t\tnp_codec = of_parse_phandle(dev->of_node,\n\t\t\t\t\t    \"rockchip,codec\", i);\n\t\tif (!np_codec)\n\t\t\tbreak;\n\n\t\tif (!of_device_is_available(np_codec))\n\t\t\tcontinue;\n\n\t\tindex = rockchip_sound_codec_node_match(np_codec);\n\t\tif (index < 0)\n\t\t\tcontinue;\n\n\t\tswitch (index) {\n\t\tcase DAILINK_CDNDP:\n\t\t\tnp_cpu = np_cpu1;\n\t\t\tbreak;\n\t\tcase DAILINK_RT5514_DSP:\n\t\t\tnp_cpu = np_codec;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tnp_cpu = np_cpu0;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!np_cpu) {\n\t\t\tdev_err(dev, \"Missing 'rockchip,cpu' for %s\\n\",\n\t\t\t\trockchip_dais[index].name);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tdai = &card->dai_link[card->num_links++];\n\t\t*dai = rockchip_dais[index];\n\n\t\tif (!dai->codecs->name)\n\t\t\tdai->codecs->of_node = np_codec;\n\t\tdai->platforms->of_node = np_cpu;\n\t\tdai->cpus->of_node = np_cpu;\n\n\t\tif (card->num_dapm_routes + rockchip_routes[index].num_routes >\n\t\t    num_routes) {\n\t\t\tdev_err(dev, \"Too many routes\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tmemcpy(routes + card->num_dapm_routes,\n\t\t       rockchip_routes[index].routes,\n\t\t       rockchip_routes[index].num_routes * sizeof(*routes));\n\t\tcard->num_dapm_routes += rockchip_routes[index].num_routes;\n\t}\n\n\treturn 0;\n}\n\nstatic int rockchip_sound_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &rockchip_sound_card;\n\tint ret;\n\n\tret = rockchip_sound_of_parse_dais(&pdev->dev, card);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Failed to parse dais: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = device_property_read_u32(&pdev->dev, \"dmic-wakeup-delay-ms\",\n\t\t\t\t\t&dmic_wakeup_delay);\n\tif (ret) {\n\t\tdmic_wakeup_delay = 0;\n\t\tdev_dbg(&pdev->dev,\n\t\t\t\"no optional property 'dmic-wakeup-delay-ms' found, default: no delay\\n\");\n\t}\n\n\tcard->dev = &pdev->dev;\n\treturn devm_snd_soc_register_card(&pdev->dev, card);\n}\n\nstatic const struct of_device_id rockchip_sound_of_match[] = {\n\t{ .compatible = \"rockchip,rk3399-gru-sound\", },\n\t{},\n};\n\nstatic struct platform_driver rockchip_sound_driver = {\n\t.probe = rockchip_sound_probe,\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.of_match_table = rockchip_sound_of_match,\n#ifdef CONFIG_PM\n\t\t.pm = &snd_soc_pm_ops,\n#endif\n\t},\n};\n\nmodule_platform_driver(rockchip_sound_driver);\n\nMODULE_AUTHOR(\"Xing Zheng <zhengxing@rock-chips.com>\");\nMODULE_DESCRIPTION(\"Rockchip ASoC Machine Driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:\" DRV_NAME);\nMODULE_DEVICE_TABLE(of, rockchip_sound_of_match);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}