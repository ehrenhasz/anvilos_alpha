{
  "module_name": "acp-common.c",
  "hash_id": "5b958382ddd23d772526ae56cac2ffd96b09a9178bd3383e0c48ee544603a2db",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/amd/acp-common.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n \n\n#include \"../sof-priv.h\"\n#include \"../sof-audio.h\"\n#include \"../ops.h\"\n#include \"../sof-audio.h\"\n#include \"acp.h\"\n#include \"acp-dsp-offset.h\"\n#include <sound/sof/xtensa.h>\n\n \nvoid amd_sof_ipc_dump(struct snd_sof_dev *sdev)\n{\n\tconst struct sof_amd_acp_desc *desc = get_chip_info(sdev->pdata);\n\tu32 base = desc->dsp_intr_base;\n\tu32 dsp_msg_write = sdev->debug_box.offset +\n\t\t\t    offsetof(struct scratch_ipc_conf, sof_dsp_msg_write);\n\tu32 dsp_ack_write = sdev->debug_box.offset +\n\t\t\t    offsetof(struct scratch_ipc_conf, sof_dsp_ack_write);\n\tu32 host_msg_write = sdev->debug_box.offset +\n\t\t\t     offsetof(struct scratch_ipc_conf, sof_host_msg_write);\n\tu32 host_ack_write = sdev->debug_box.offset +\n\t\t\t     offsetof(struct scratch_ipc_conf, sof_host_ack_write);\n\tu32 dsp_msg, dsp_ack, host_msg, host_ack, irq_stat;\n\n\tdsp_msg = snd_sof_dsp_read(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + dsp_msg_write);\n\tdsp_ack = snd_sof_dsp_read(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + dsp_ack_write);\n\thost_msg = snd_sof_dsp_read(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + host_msg_write);\n\thost_ack = snd_sof_dsp_read(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + host_ack_write);\n\tirq_stat = snd_sof_dsp_read(sdev, ACP_DSP_BAR, base + DSP_SW_INTR_STAT_OFFSET);\n\n\tdev_err(sdev->dev,\n\t\t\"dsp_msg = %#x dsp_ack = %#x host_msg = %#x host_ack = %#x irq_stat = %#x\\n\",\n\t\tdsp_msg, dsp_ack, host_msg, host_ack, irq_stat);\n}\n\n \nstatic void amd_get_registers(struct snd_sof_dev *sdev,\n\t\t\t      struct sof_ipc_dsp_oops_xtensa *xoops,\n\t\t\t      struct sof_ipc_panic_info *panic_info,\n\t\t\t      u32 *stack, size_t stack_words)\n{\n\tu32 offset = sdev->dsp_oops_offset;\n\n\t \n\tacp_mailbox_read(sdev, offset, xoops, sizeof(*xoops));\n\n\t \n\tif (xoops->arch_hdr.totalsize > EXCEPT_MAX_HDR_SIZE) {\n\t\tdev_err(sdev->dev, \"invalid header size 0x%x. FW oops is bogus\\n\",\n\t\t\txoops->arch_hdr.totalsize);\n\t\treturn;\n\t}\n\n\toffset += xoops->arch_hdr.totalsize;\n\tacp_mailbox_read(sdev, offset, panic_info, sizeof(*panic_info));\n\n\t \n\toffset += sizeof(*panic_info);\n\tacp_mailbox_read(sdev, offset, stack, stack_words * sizeof(u32));\n}\n\n \nvoid amd_sof_dump(struct snd_sof_dev *sdev, u32 flags)\n{\n\tstruct sof_ipc_dsp_oops_xtensa xoops;\n\tstruct sof_ipc_panic_info panic_info;\n\tu32 stack[AMD_STACK_DUMP_SIZE];\n\tu32 status;\n\n\t \n\tif (sdev->dsp_oops_offset > sdev->debug_box.offset) {\n\t\tacp_mailbox_read(sdev, sdev->debug_box.offset, &status, sizeof(u32));\n\t} else {\n\t\t \n\t\tacp_mailbox_read(sdev, sdev->dsp_box.offset, &status, sizeof(u32));\n\t\tsdev->dsp_oops_offset = sdev->dsp_box.offset + sizeof(status);\n\t}\n\n\t \n\tamd_get_registers(sdev, &xoops, &panic_info, stack, AMD_STACK_DUMP_SIZE);\n\n\t \n\tsof_print_oops_and_stack(sdev, KERN_ERR, status, status, &xoops,\n\t\t\t\t &panic_info, stack, AMD_STACK_DUMP_SIZE);\n}\n\nstruct snd_soc_acpi_mach *amd_sof_machine_select(struct snd_sof_dev *sdev)\n{\n\tstruct snd_sof_pdata *sof_pdata = sdev->pdata;\n\tconst struct sof_dev_desc *desc = sof_pdata->desc;\n\tstruct snd_soc_acpi_mach *mach;\n\n\tmach = snd_soc_acpi_find_machine(desc->machines);\n\tif (!mach) {\n\t\tdev_warn(sdev->dev, \"No matching ASoC machine driver found\\n\");\n\t\treturn NULL;\n\t}\n\n\tsof_pdata->tplg_filename = mach->sof_tplg_filename;\n\tsof_pdata->fw_filename = mach->fw_filename;\n\n\treturn mach;\n}\n\n \nstruct snd_sof_dsp_ops sof_acp_common_ops = {\n\t \n\t.probe\t\t\t= amd_sof_acp_probe,\n\t.remove\t\t\t= amd_sof_acp_remove,\n\n\t \n\t.write\t\t\t= sof_io_write,\n\t.read\t\t\t= sof_io_read,\n\n\t \n\t.block_read\t\t= acp_dsp_block_read,\n\t.block_write\t\t= acp_dsp_block_write,\n\n\t \n\t.load_firmware\t\t= snd_sof_load_firmware_memcpy,\n\t.pre_fw_run\t\t= acp_dsp_pre_fw_run,\n\t.get_bar_index\t\t= acp_get_bar_index,\n\n\t \n\t.run\t\t\t= acp_sof_dsp_run,\n\n\t \n\t.send_msg\t\t= acp_sof_ipc_send_msg,\n\t.ipc_msg_data\t\t= acp_sof_ipc_msg_data,\n\t.set_stream_data_offset = acp_set_stream_data_offset,\n\t.get_mailbox_offset\t= acp_sof_ipc_get_mailbox_offset,\n\t.get_window_offset      = acp_sof_ipc_get_window_offset,\n\t.irq_thread\t\t= acp_sof_ipc_irq_thread,\n\n\t \n\t.pcm_open\t\t= acp_pcm_open,\n\t.pcm_close\t\t= acp_pcm_close,\n\t.pcm_hw_params\t\t= acp_pcm_hw_params,\n\t.pcm_pointer\t\t= acp_pcm_pointer,\n\n\t.hw_info\t\t= SNDRV_PCM_INFO_MMAP |\n\t\t\t\t  SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t\t  SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t\t  SNDRV_PCM_INFO_PAUSE |\n\t\t\t\t  SNDRV_PCM_INFO_NO_PERIOD_WAKEUP,\n\n\t \n\t.machine_select\t\t= amd_sof_machine_select,\n\t.machine_register\t= sof_machine_register,\n\t.machine_unregister\t= sof_machine_unregister,\n\n\t \n\t.trace_init\t\t= acp_sof_trace_init,\n\t.trace_release\t\t= acp_sof_trace_release,\n\n\t \n\t.suspend                = amd_sof_acp_suspend,\n\t.resume                 = amd_sof_acp_resume,\n\n\t.ipc_dump\t\t= amd_sof_ipc_dump,\n\t.dbg_dump\t\t= amd_sof_dump,\n\t.debugfs_add_region_item = snd_sof_debugfs_add_region_item_iomem,\n\t.dsp_arch_ops = &sof_xtensa_arch_ops,\n\n\t \n\t.register_ipc_clients = acp_probes_register,\n\t.unregister_ipc_clients = acp_probes_unregister,\n};\nEXPORT_SYMBOL_NS(sof_acp_common_ops, SND_SOC_SOF_AMD_COMMON);\n\nMODULE_IMPORT_NS(SND_SOC_SOF_AMD_COMMON);\nMODULE_IMPORT_NS(SND_SOC_SOF_XTENSA);\nMODULE_DESCRIPTION(\"ACP SOF COMMON Driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}