{
  "module_name": "acp-probes.c",
  "hash_id": "f887ceeb126f6df877e7eb7b5fdb782faa956cc313e8d74d1c0ce31d392c028a",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/amd/acp-probes.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n \n\n#include <linux/module.h>\n#include <sound/soc.h>\n#include \"../sof-priv.h\"\n#include \"../sof-client-probes.h\"\n#include \"../sof-client.h\"\n#include \"../ops.h\"\n#include \"acp.h\"\n#include \"acp-dsp-offset.h\"\n\nstatic int acp_probes_compr_startup(struct sof_client_dev *cdev,\n\t\t\t\t    struct snd_compr_stream *cstream,\n\t\t\t\t    struct snd_soc_dai *dai, u32 *stream_id)\n{\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\tstruct acp_dsp_stream *stream;\n\tstruct acp_dev_data *adata;\n\n\tadata = sdev->pdata->hw_pdata;\n\tstream = acp_dsp_stream_get(sdev, 0);\n\tif (!stream)\n\t\treturn -ENODEV;\n\n\tstream->cstream = cstream;\n\tcstream->runtime->private_data = stream;\n\n\tadata->probe_stream = stream;\n\t*stream_id = stream->stream_tag;\n\n\treturn 0;\n}\n\nstatic int acp_probes_compr_shutdown(struct sof_client_dev *cdev,\n\t\t\t\t     struct snd_compr_stream *cstream,\n\t\t\t\t     struct snd_soc_dai *dai)\n{\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\tstruct acp_dsp_stream *stream = cstream->runtime->private_data;\n\tstruct acp_dev_data *adata;\n\tint ret;\n\n\tret = acp_dsp_stream_put(sdev, stream);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"Failed to release probe compress stream\\n\");\n\t\treturn ret;\n\t}\n\n\tadata = sdev->pdata->hw_pdata;\n\tstream->cstream = NULL;\n\tcstream->runtime->private_data = NULL;\n\tadata->probe_stream = NULL;\n\n\treturn 0;\n}\n\nstatic int acp_probes_compr_set_params(struct sof_client_dev *cdev,\n\t\t\t\t       struct snd_compr_stream *cstream,\n\t\t\t\t       struct snd_compr_params *params,\n\t\t\t\t       struct snd_soc_dai *dai)\n{\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\tstruct acp_dsp_stream *stream = cstream->runtime->private_data;\n\tunsigned int buf_offset, index;\n\tu32 size;\n\tint ret;\n\n\tstream->dmab = cstream->runtime->dma_buffer_p;\n\tstream->num_pages = PFN_UP(cstream->runtime->dma_bytes);\n\tsize = cstream->runtime->buffer_size;\n\n\tret = acp_dsp_stream_config(sdev, stream);\n\tif (ret < 0) {\n\t\tacp_dsp_stream_put(sdev, stream);\n\t\treturn ret;\n\t}\n\n\t \n\n\tbuf_offset = sdev->debug_box.offset +\n\t\t     offsetof(struct scratch_reg_conf, buf_size);\n\tindex = stream->stream_tag - 1;\n\tbuf_offset = buf_offset + index * 4;\n\n\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + buf_offset, size);\n\n\treturn 0;\n}\n\nstatic int acp_probes_compr_trigger(struct sof_client_dev *cdev,\n\t\t\t\t    struct snd_compr_stream *cstream,\n\t\t\t\t    int cmd, struct snd_soc_dai *dai)\n{\n\t \n\treturn 0;\n}\n\nstatic int acp_probes_compr_pointer(struct sof_client_dev *cdev,\n\t\t\t\t    struct snd_compr_stream *cstream,\n\t\t\t\t    struct snd_compr_tstamp *tstamp,\n\t\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct acp_dsp_stream *stream = cstream->runtime->private_data;\n\tstruct snd_soc_pcm_stream *pstream;\n\n\tpstream = &dai->driver->capture;\n\ttstamp->copied_total = stream->cstream_posn;\n\ttstamp->sampling_rate = snd_pcm_rate_bit_to_rate(pstream->rates);\n\n\treturn 0;\n}\n\n \nstatic const struct sof_probes_host_ops acp_probes_ops = {\n\t.startup = acp_probes_compr_startup,\n\t.shutdown = acp_probes_compr_shutdown,\n\t.set_params = acp_probes_compr_set_params,\n\t.trigger = acp_probes_compr_trigger,\n\t.pointer = acp_probes_compr_pointer,\n};\n\nint acp_probes_register(struct snd_sof_dev *sdev)\n{\n\treturn sof_client_dev_register(sdev, \"acp-probes\", 0, &acp_probes_ops,\n\t\t\t\t       sizeof(acp_probes_ops));\n}\nEXPORT_SYMBOL_NS(acp_probes_register, SND_SOC_SOF_AMD_COMMON);\n\nvoid acp_probes_unregister(struct snd_sof_dev *sdev)\n{\n\tsof_client_dev_unregister(sdev, \"acp-probes\", 0);\n}\nEXPORT_SYMBOL_NS(acp_probes_unregister, SND_SOC_SOF_AMD_COMMON);\n\nMODULE_IMPORT_NS(SND_SOC_SOF_CLIENT);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}