{
  "module_name": "acp-stream.c",
  "hash_id": "0bea3fe9150fdd030efc94fee06ab7412a74a83a67fb563be2c49d59da057e85",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/amd/acp-stream.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n \n\n#include \"../ops.h\"\n#include \"acp-dsp-offset.h\"\n#include \"acp.h\"\n\n#define PTE_GRP1_OFFSET\t\t0x00000000\n#define PTE_GRP2_OFFSET\t\t0x00800000\n#define PTE_GRP3_OFFSET\t\t0x01000000\n#define PTE_GRP4_OFFSET\t\t0x01800000\n#define PTE_GRP5_OFFSET\t\t0x02000000\n#define PTE_GRP6_OFFSET\t\t0x02800000\n#define PTE_GRP7_OFFSET\t\t0x03000000\n#define PTE_GRP8_OFFSET\t\t0x03800000\n\nint acp_dsp_stream_config(struct snd_sof_dev *sdev, struct acp_dsp_stream *stream)\n{\n\tconst struct sof_amd_acp_desc *desc = get_chip_info(sdev->pdata);\n\tunsigned int pte_reg, pte_size, phy_addr_offset, index;\n\tint stream_tag = stream->stream_tag;\n\tu32 low, high, offset, reg_val;\n\tdma_addr_t addr;\n\tint page_idx;\n\n\tswitch (stream_tag) {\n\tcase 1:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_1;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_1;\n\t\toffset = offsetof(struct scratch_reg_conf, grp1_pte);\n\t\tstream->reg_offset = PTE_GRP1_OFFSET;\n\t\tbreak;\n\tcase 2:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_2;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_2;\n\t\toffset = offsetof(struct scratch_reg_conf, grp2_pte);\n\t\tstream->reg_offset = PTE_GRP2_OFFSET;\n\t\tbreak;\n\tcase 3:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_3;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_3;\n\t\toffset = offsetof(struct scratch_reg_conf, grp3_pte);\n\t\tstream->reg_offset = PTE_GRP3_OFFSET;\n\t\tbreak;\n\tcase 4:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_4;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_4;\n\t\toffset = offsetof(struct scratch_reg_conf, grp4_pte);\n\t\tstream->reg_offset = PTE_GRP4_OFFSET;\n\t\tbreak;\n\tcase 5:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_5;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_5;\n\t\toffset = offsetof(struct scratch_reg_conf, grp5_pte);\n\t\tstream->reg_offset = PTE_GRP5_OFFSET;\n\t\tbreak;\n\tcase 6:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_6;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_6;\n\t\toffset = offsetof(struct scratch_reg_conf, grp6_pte);\n\t\tstream->reg_offset = PTE_GRP6_OFFSET;\n\t\tbreak;\n\tcase 7:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_7;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_7;\n\t\toffset = offsetof(struct scratch_reg_conf, grp7_pte);\n\t\tstream->reg_offset = PTE_GRP7_OFFSET;\n\t\tbreak;\n\tcase 8:\n\t\tpte_reg = ACPAXI2AXI_ATU_BASE_ADDR_GRP_8;\n\t\tpte_size = ACPAXI2AXI_ATU_PAGE_SIZE_GRP_8;\n\t\toffset = offsetof(struct scratch_reg_conf, grp8_pte);\n\t\tstream->reg_offset = PTE_GRP8_OFFSET;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(sdev->dev, \"Invalid stream tag %d\\n\", stream_tag);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\n\tphy_addr_offset = sdev->debug_box.offset +\n\t\t\t  offsetof(struct scratch_reg_conf, reg_offset);\n\tindex = stream_tag - 1;\n\tphy_addr_offset = phy_addr_offset + index * 4;\n\n\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 +\n\t\t\t  phy_addr_offset, stream->reg_offset);\n\n\t \n\toffset = offset + sdev->debug_box.offset;\n\treg_val = desc->sram_pte_offset + offset;\n\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, pte_reg, reg_val | BIT(31));\n\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, pte_size, PAGE_SIZE_4K_ENABLE);\n\n\tfor (page_idx = 0; page_idx < stream->num_pages; page_idx++) {\n\t\taddr = snd_sgbuf_get_addr(stream->dmab, page_idx * PAGE_SIZE);\n\n\t\t \n\t\tlow = lower_32_bits(addr);\n\t\thigh = upper_32_bits(addr);\n\n\t\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + offset, low);\n\n\t\thigh |= BIT(31);\n\t\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + offset + 4, high);\n\t\t \n\t\toffset += 8;\n\t}\n\n\t \n\tsnd_sof_dsp_write(sdev, ACP_DSP_BAR, ACPAXI2AXI_ATU_CTRL, ACP_ATU_CACHE_INVALID);\n\n\treturn 0;\n}\n\nstruct acp_dsp_stream *acp_dsp_stream_get(struct snd_sof_dev *sdev, int tag)\n{\n\tstruct acp_dev_data *adata = sdev->pdata->hw_pdata;\n\tstruct acp_dsp_stream *stream = adata->stream_buf;\n\tint i;\n\n\tfor (i = 0; i < ACP_MAX_STREAM; i++, stream++) {\n\t\tif (stream->active)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (!tag) {\n\t\t\tstream->active = 1;\n\t\t\treturn stream;\n\t\t}\n\n\t\t \n\t\tif (stream->stream_tag == tag) {\n\t\t\tstream->active = 1;\n\t\t\treturn stream;\n\t\t}\n\t}\n\n\tdev_err(sdev->dev, \"stream %d active or no inactive stream\\n\", tag);\n\treturn NULL;\n}\nEXPORT_SYMBOL_NS(acp_dsp_stream_get, SND_SOC_SOF_AMD_COMMON);\n\nint acp_dsp_stream_put(struct snd_sof_dev *sdev,\n\t\t       struct acp_dsp_stream *acp_stream)\n{\n\tstruct acp_dev_data *adata = sdev->pdata->hw_pdata;\n\tstruct acp_dsp_stream *stream = adata->stream_buf;\n\tint i;\n\n\t \n\tfor (i = 0; i < ACP_MAX_STREAM; i++, stream++) {\n\t\tif (stream == acp_stream) {\n\t\t\tstream->active = 0;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tdev_err(sdev->dev, \"Cannot find active stream tag %d\\n\", acp_stream->stream_tag);\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL_NS(acp_dsp_stream_put, SND_SOC_SOF_AMD_COMMON);\n\nint acp_dsp_stream_init(struct snd_sof_dev *sdev)\n{\n\tstruct acp_dev_data *adata = sdev->pdata->hw_pdata;\n\tint i;\n\n\tfor (i = 0; i < ACP_MAX_STREAM; i++) {\n\t\tadata->stream_buf[i].sdev = sdev;\n\t\tadata->stream_buf[i].active = 0;\n\t\tadata->stream_buf[i].stream_tag = i + 1;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL_NS(acp_dsp_stream_init, SND_SOC_SOF_AMD_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}