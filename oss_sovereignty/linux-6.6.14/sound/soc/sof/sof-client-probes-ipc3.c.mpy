{
  "module_name": "sof-client-probes-ipc3.c",
  "hash_id": "f685fbb63583e7fd518f8c8627abc7d298c05f8f952153f82e6533d83e9eefbc",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/sof-client-probes-ipc3.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n#include <linux/stddef.h>\n#include <sound/soc.h>\n#include <sound/sof/header.h>\n#include \"sof-client.h\"\n#include \"sof-client-probes.h\"\n\nstruct sof_probe_dma {\n\tunsigned int stream_tag;\n\tunsigned int dma_buffer_size;\n} __packed;\n\nstruct sof_ipc_probe_dma_add_params {\n\tstruct sof_ipc_cmd_hdr hdr;\n\tunsigned int num_elems;\n\tstruct sof_probe_dma dma[];\n} __packed;\n\nstruct sof_ipc_probe_info_params {\n\tstruct sof_ipc_reply rhdr;\n\tunsigned int num_elems;\n\tunion {\n\t\tDECLARE_FLEX_ARRAY(struct sof_probe_dma, dma);\n\t\tDECLARE_FLEX_ARRAY(struct sof_probe_point_desc, desc);\n\t};\n} __packed;\n\nstruct sof_ipc_probe_point_add_params {\n\tstruct sof_ipc_cmd_hdr hdr;\n\tunsigned int num_elems;\n\tstruct sof_probe_point_desc desc[];\n} __packed;\n\nstruct sof_ipc_probe_point_remove_params {\n\tstruct sof_ipc_cmd_hdr hdr;\n\tunsigned int num_elems;\n\tunsigned int buffer_id[];\n} __packed;\n\n \nstatic int ipc3_probes_init(struct sof_client_dev *cdev, u32 stream_tag,\n\t\t\t    size_t buffer_size)\n{\n\tstruct sof_ipc_probe_dma_add_params *msg;\n\tsize_t size = struct_size(msg, dma, 1);\n\tint ret;\n\n\tmsg = kmalloc(size, GFP_KERNEL);\n\tif (!msg)\n\t\treturn -ENOMEM;\n\tmsg->hdr.size = size;\n\tmsg->hdr.cmd = SOF_IPC_GLB_PROBE | SOF_IPC_PROBE_INIT;\n\tmsg->num_elems = 1;\n\tmsg->dma[0].stream_tag = stream_tag;\n\tmsg->dma[0].dma_buffer_size = buffer_size;\n\n\tret = sof_client_ipc_tx_message_no_reply(cdev, msg);\n\tkfree(msg);\n\treturn ret;\n}\n\n \nstatic int ipc3_probes_deinit(struct sof_client_dev *cdev)\n{\n\tstruct sof_ipc_cmd_hdr msg;\n\n\tmsg.size = sizeof(msg);\n\tmsg.cmd = SOF_IPC_GLB_PROBE | SOF_IPC_PROBE_DEINIT;\n\n\treturn sof_client_ipc_tx_message_no_reply(cdev, &msg);\n}\n\nstatic int ipc3_probes_info(struct sof_client_dev *cdev, unsigned int cmd,\n\t\t\t    void **params, size_t *num_params)\n{\n\tsize_t max_msg_size = sof_client_get_ipc_max_payload_size(cdev);\n\tstruct sof_ipc_probe_info_params msg = {{{0}}};\n\tstruct sof_ipc_probe_info_params *reply;\n\tsize_t bytes;\n\tint ret;\n\n\t*params = NULL;\n\t*num_params = 0;\n\n\treply = kzalloc(max_msg_size, GFP_KERNEL);\n\tif (!reply)\n\t\treturn -ENOMEM;\n\tmsg.rhdr.hdr.size = sizeof(msg);\n\tmsg.rhdr.hdr.cmd = SOF_IPC_GLB_PROBE | cmd;\n\n\tret = sof_client_ipc_tx_message(cdev, &msg, reply, max_msg_size);\n\tif (ret < 0 || reply->rhdr.error < 0)\n\t\tgoto exit;\n\n\tif (!reply->num_elems)\n\t\tgoto exit;\n\n\tif (cmd == SOF_IPC_PROBE_DMA_INFO)\n\t\tbytes = sizeof(reply->dma[0]);\n\telse\n\t\tbytes = sizeof(reply->desc[0]);\n\tbytes *= reply->num_elems;\n\t*params = kmemdup(&reply->dma[0], bytes, GFP_KERNEL);\n\tif (!*params) {\n\t\tret = -ENOMEM;\n\t\tgoto exit;\n\t}\n\t*num_params = reply->num_elems;\n\nexit:\n\tkfree(reply);\n\treturn ret;\n}\n\n \nstatic int ipc3_probes_points_info(struct sof_client_dev *cdev,\n\t\t\t\t   struct sof_probe_point_desc **desc,\n\t\t\t\t   size_t *num_desc)\n{\n\treturn ipc3_probes_info(cdev, SOF_IPC_PROBE_POINT_INFO,\n\t\t\t       (void **)desc, num_desc);\n}\n\n \nstatic int ipc3_probes_points_add(struct sof_client_dev *cdev,\n\t\t\t\t  struct sof_probe_point_desc *desc,\n\t\t\t\t  size_t num_desc)\n{\n\tstruct sof_ipc_probe_point_add_params *msg;\n\tsize_t size = struct_size(msg, desc, num_desc);\n\tint ret;\n\n\tmsg = kmalloc(size, GFP_KERNEL);\n\tif (!msg)\n\t\treturn -ENOMEM;\n\tmsg->hdr.size = size;\n\tmsg->num_elems = num_desc;\n\tmsg->hdr.cmd = SOF_IPC_GLB_PROBE | SOF_IPC_PROBE_POINT_ADD;\n\tmemcpy(&msg->desc[0], desc, size - sizeof(*msg));\n\n\tret = sof_client_ipc_tx_message_no_reply(cdev, msg);\n\tkfree(msg);\n\treturn ret;\n}\n\n \nstatic int ipc3_probes_points_remove(struct sof_client_dev *cdev,\n\t\t\t\t     unsigned int *buffer_id,\n\t\t\t\t     size_t num_buffer_id)\n{\n\tstruct sof_ipc_probe_point_remove_params *msg;\n\tsize_t size = struct_size(msg, buffer_id, num_buffer_id);\n\tint ret;\n\n\tmsg = kmalloc(size, GFP_KERNEL);\n\tif (!msg)\n\t\treturn -ENOMEM;\n\tmsg->hdr.size = size;\n\tmsg->num_elems = num_buffer_id;\n\tmsg->hdr.cmd = SOF_IPC_GLB_PROBE | SOF_IPC_PROBE_POINT_REMOVE;\n\tmemcpy(&msg->buffer_id[0], buffer_id, size - sizeof(*msg));\n\n\tret = sof_client_ipc_tx_message_no_reply(cdev, msg);\n\tkfree(msg);\n\treturn ret;\n}\n\nconst struct sof_probes_ipc_ops ipc3_probe_ops =  {\n\t.init = ipc3_probes_init,\n\t.deinit = ipc3_probes_deinit,\n\t.points_info = ipc3_probes_points_info,\n\t.points_add = ipc3_probes_points_add,\n\t.points_remove = ipc3_probes_points_remove,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}