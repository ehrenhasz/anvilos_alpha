{
  "module_name": "loader.c",
  "hash_id": "1c02bdfa8df1fee2e59b4052c3a232c2c65b5b45eb31940c2ec2ff961eac2660",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/loader.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n#include <linux/firmware.h>\n#include \"sof-priv.h\"\n#include \"ops.h\"\n\nint snd_sof_load_firmware_raw(struct snd_sof_dev *sdev)\n{\n\tstruct snd_sof_pdata *plat_data = sdev->pdata;\n\tconst char *fw_filename;\n\tssize_t ext_man_size;\n\tint ret;\n\n\t \n\tif (sdev->basefw.fw)\n\t\treturn 0;\n\n\tfw_filename = kasprintf(GFP_KERNEL, \"%s/%s\",\n\t\t\t\tplat_data->fw_filename_prefix,\n\t\t\t\tplat_data->fw_filename);\n\tif (!fw_filename)\n\t\treturn -ENOMEM;\n\n\tret = request_firmware(&sdev->basefw.fw, fw_filename, sdev->dev);\n\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev,\n\t\t\t\"error: sof firmware file is missing, you might need to\\n\");\n\t\tdev_err(sdev->dev,\n\t\t\t\"       download it from https://github.com/thesofproject/sof-bin/\\n\");\n\t\tgoto err;\n\t} else {\n\t\tdev_dbg(sdev->dev, \"request_firmware %s successful\\n\",\n\t\t\tfw_filename);\n\t}\n\n\t \n\text_man_size = sdev->ipc->ops->fw_loader->parse_ext_manifest(sdev);\n\tif (ext_man_size > 0) {\n\t\t \n\t\tsdev->basefw.payload_offset = ext_man_size;\n\t} else if (!ext_man_size) {\n\t\t \n\t\tdev_dbg(sdev->dev, \"firmware doesn't contain extended manifest\\n\");\n\t} else {\n\t\tret = ext_man_size;\n\t\tdev_err(sdev->dev, \"error: firmware %s contains unsupported or invalid extended manifest: %d\\n\",\n\t\t\tfw_filename, ret);\n\t}\n\nerr:\n\tkfree(fw_filename);\n\n\treturn ret;\n}\nEXPORT_SYMBOL(snd_sof_load_firmware_raw);\n\nint snd_sof_load_firmware_memcpy(struct snd_sof_dev *sdev)\n{\n\tint ret;\n\n\tret = snd_sof_load_firmware_raw(sdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = sdev->ipc->ops->fw_loader->validate(sdev);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"error: invalid FW header\\n\");\n\t\tgoto error;\n\t}\n\n\t \n\tret = snd_sof_dsp_reset(sdev);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"error: failed to reset DSP\\n\");\n\t\tgoto error;\n\t}\n\n\t \n\tif (sdev->ipc->ops->fw_loader->load_fw_to_dsp) {\n\t\tret = sdev->ipc->ops->fw_loader->load_fw_to_dsp(sdev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(sdev->dev, \"Firmware loading failed\\n\");\n\t\t\tgoto error;\n\t\t}\n\t}\n\n\treturn 0;\n\nerror:\n\trelease_firmware(sdev->basefw.fw);\n\tsdev->basefw.fw = NULL;\n\treturn ret;\n\n}\nEXPORT_SYMBOL(snd_sof_load_firmware_memcpy);\n\nint snd_sof_run_firmware(struct snd_sof_dev *sdev)\n{\n\tint ret;\n\n\tinit_waitqueue_head(&sdev->boot_wait);\n\n\t \n\tsdev->dbg_dump_printed = false;\n\tsdev->ipc_dump_printed = false;\n\n\t \n\tif (sdev->first_boot) {\n\t\tret = snd_sof_debugfs_buf_item(sdev, &sdev->fw_version,\n\t\t\t\t\t       sizeof(sdev->fw_version),\n\t\t\t\t\t       \"fw_version\", 0444);\n\t\t \n\t\tif (ret < 0) {\n\t\t\tdev_err(sdev->dev, \"snd_sof_debugfs_buf_item failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tret = snd_sof_dsp_pre_fw_run(sdev);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"failed pre fw run op\\n\");\n\t\treturn ret;\n\t}\n\n\tdev_dbg(sdev->dev, \"booting DSP firmware\\n\");\n\n\t \n\tret = snd_sof_dsp_run(sdev);\n\tif (ret < 0) {\n\t\tsnd_sof_dsp_dbg_dump(sdev, \"Failed to start DSP\",\n\t\t\t\t     SOF_DBG_DUMP_MBOX | SOF_DBG_DUMP_PCI);\n\t\treturn ret;\n\t}\n\n\t \n\tret = wait_event_timeout(sdev->boot_wait,\n\t\t\t\t sdev->fw_state > SOF_FW_BOOT_IN_PROGRESS,\n\t\t\t\t msecs_to_jiffies(sdev->boot_timeout));\n\tif (ret == 0) {\n\t\tsnd_sof_dsp_dbg_dump(sdev, \"Firmware boot failure due to timeout\",\n\t\t\t\t     SOF_DBG_DUMP_REGS | SOF_DBG_DUMP_MBOX |\n\t\t\t\t     SOF_DBG_DUMP_TEXT | SOF_DBG_DUMP_PCI);\n\t\treturn -EIO;\n\t}\n\n\tif (sdev->fw_state == SOF_FW_BOOT_READY_FAILED)\n\t\treturn -EIO;  \n\n\tdev_dbg(sdev->dev, \"firmware boot complete\\n\");\n\tsof_set_fw_state(sdev, SOF_FW_BOOT_COMPLETE);\n\n\t \n\tret = snd_sof_dsp_post_fw_run(sdev);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"error: failed post fw run op\\n\");\n\t\treturn ret;\n\t}\n\n\tif (sdev->ipc->ops->post_fw_boot)\n\t\treturn sdev->ipc->ops->post_fw_boot(sdev);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(snd_sof_run_firmware);\n\nvoid snd_sof_fw_unload(struct snd_sof_dev *sdev)\n{\n\t \n\trelease_firmware(sdev->basefw.fw);\n\tsdev->basefw.fw = NULL;\n}\nEXPORT_SYMBOL(snd_sof_fw_unload);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}