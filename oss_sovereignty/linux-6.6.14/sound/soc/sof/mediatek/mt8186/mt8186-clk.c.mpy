{
  "module_name": "mt8186-clk.c",
  "hash_id": "7656ec135eb64f230fa48ef35601cbb61bc99044fe6fd226abab99ddf92d9d68",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/mediatek/mt8186/mt8186-clk.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/io.h>\n\n#include \"../../sof-audio.h\"\n#include \"../../ops.h\"\n#include \"../adsp_helper.h\"\n#include \"mt8186.h\"\n#include \"mt8186-clk.h\"\n\nstatic const char *adsp_clks[ADSP_CLK_MAX] = {\n\t[CLK_TOP_AUDIODSP] = \"audiodsp\",\n\t[CLK_TOP_ADSP_BUS] = \"adsp_bus\",\n};\n\nint mt8186_adsp_init_clock(struct snd_sof_dev *sdev)\n{\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\tstruct device *dev = sdev->dev;\n\tint i;\n\n\tpriv->clk = devm_kcalloc(dev, ADSP_CLK_MAX, sizeof(*priv->clk), GFP_KERNEL);\n\tif (!priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < ADSP_CLK_MAX; i++) {\n\t\tpriv->clk[i] = devm_clk_get(dev, adsp_clks[i]);\n\n\t\tif (IS_ERR(priv->clk[i]))\n\t\t\treturn PTR_ERR(priv->clk[i]);\n\t}\n\n\treturn 0;\n}\n\nstatic int adsp_enable_all_clock(struct snd_sof_dev *sdev)\n{\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\tstruct device *dev = sdev->dev;\n\tint ret;\n\n\tret = clk_prepare_enable(priv->clk[CLK_TOP_AUDIODSP]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(audiodsp) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\treturn ret;\n\t}\n\n\tret = clk_prepare_enable(priv->clk[CLK_TOP_ADSP_BUS]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(adsp_bus) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\tclk_disable_unprepare(priv->clk[CLK_TOP_AUDIODSP]);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void adsp_disable_all_clock(struct snd_sof_dev *sdev)\n{\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\n\tclk_disable_unprepare(priv->clk[CLK_TOP_ADSP_BUS]);\n\tclk_disable_unprepare(priv->clk[CLK_TOP_AUDIODSP]);\n}\n\nint mt8186_adsp_clock_on(struct snd_sof_dev *sdev)\n{\n\tstruct device *dev = sdev->dev;\n\tint ret;\n\n\tret = adsp_enable_all_clock(sdev);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to adsp_enable_clock: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tsnd_sof_dsp_write(sdev, DSP_REG_BAR, ADSP_CK_EN,\n\t\t\t  UART_EN | DMA_EN | TIMER_EN | COREDBG_EN | CORE_CLK_EN);\n\tsnd_sof_dsp_write(sdev, DSP_REG_BAR, ADSP_UART_CTRL,\n\t\t\t  UART_BCLK_CG | UART_RSTN);\n\n\treturn 0;\n}\n\nvoid mt8186_adsp_clock_off(struct snd_sof_dev *sdev)\n{\n\tsnd_sof_dsp_write(sdev, DSP_REG_BAR, ADSP_CK_EN, 0);\n\tsnd_sof_dsp_write(sdev, DSP_REG_BAR, ADSP_UART_CTRL, 0);\n\tadsp_disable_all_clock(sdev);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}