{
  "module_name": "mt8195-clk.c",
  "hash_id": "eab6b6b5974fb3232d3ab23578161c057ba34f475b6db69de64a2554445e2681",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/mediatek/mt8195/mt8195-clk.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/io.h>\n#include \"mt8195.h\"\n#include \"mt8195-clk.h\"\n#include \"../adsp_helper.h\"\n#include \"../../sof-audio.h\"\n\nstatic const char *adsp_clks[ADSP_CLK_MAX] = {\n\t[CLK_TOP_ADSP] = \"adsp_sel\",\n\t[CLK_TOP_CLK26M] = \"clk26m_ck\",\n\t[CLK_TOP_AUDIO_LOCAL_BUS] = \"audio_local_bus\",\n\t[CLK_TOP_MAINPLL_D7_D2] = \"mainpll_d7_d2\",\n\t[CLK_SCP_ADSP_AUDIODSP] = \"scp_adsp_audiodsp\",\n\t[CLK_TOP_AUDIO_H] = \"audio_h\",\n};\n\nint mt8195_adsp_init_clock(struct snd_sof_dev *sdev)\n{\n\tstruct device *dev = sdev->dev;\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\tint i;\n\n\tpriv->clk = devm_kcalloc(dev, ADSP_CLK_MAX, sizeof(*priv->clk), GFP_KERNEL);\n\n\tif (!priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < ADSP_CLK_MAX; i++) {\n\t\tpriv->clk[i] = devm_clk_get(dev, adsp_clks[i]);\n\t\tif (IS_ERR(priv->clk[i]))\n\t\t\treturn PTR_ERR(priv->clk[i]);\n\t}\n\n\treturn 0;\n}\n\nstatic int adsp_enable_all_clock(struct snd_sof_dev *sdev)\n{\n\tstruct device *dev = sdev->dev;\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\tint ret;\n\n\tret = clk_prepare_enable(priv->clk[CLK_TOP_MAINPLL_D7_D2]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(mainpll_d7_d2) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\treturn ret;\n\t}\n\n\tret = clk_prepare_enable(priv->clk[CLK_TOP_ADSP]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(adsp_sel) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto disable_mainpll_d7_d2_clk;\n\t}\n\n\tret = clk_prepare_enable(priv->clk[CLK_TOP_AUDIO_LOCAL_BUS]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(audio_local_bus) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto disable_dsp_sel_clk;\n\t}\n\n\tret = clk_prepare_enable(priv->clk[CLK_SCP_ADSP_AUDIODSP]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(scp_adsp_audiodsp) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto disable_audio_local_bus_clk;\n\t}\n\n\tret = clk_prepare_enable(priv->clk[CLK_TOP_AUDIO_H]);\n\tif (ret) {\n\t\tdev_err(dev, \"%s clk_prepare_enable(audio_h) fail %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto disable_scp_adsp_audiodsp_clk;\n\t}\n\n\treturn 0;\n\ndisable_scp_adsp_audiodsp_clk:\n\tclk_disable_unprepare(priv->clk[CLK_SCP_ADSP_AUDIODSP]);\ndisable_audio_local_bus_clk:\n\tclk_disable_unprepare(priv->clk[CLK_TOP_AUDIO_LOCAL_BUS]);\ndisable_dsp_sel_clk:\n\tclk_disable_unprepare(priv->clk[CLK_TOP_ADSP]);\ndisable_mainpll_d7_d2_clk:\n\tclk_disable_unprepare(priv->clk[CLK_TOP_MAINPLL_D7_D2]);\n\n\treturn ret;\n}\n\nstatic void adsp_disable_all_clock(struct snd_sof_dev *sdev)\n{\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\n\tclk_disable_unprepare(priv->clk[CLK_TOP_AUDIO_H]);\n\tclk_disable_unprepare(priv->clk[CLK_SCP_ADSP_AUDIODSP]);\n\tclk_disable_unprepare(priv->clk[CLK_TOP_AUDIO_LOCAL_BUS]);\n\tclk_disable_unprepare(priv->clk[CLK_TOP_ADSP]);\n\tclk_disable_unprepare(priv->clk[CLK_TOP_MAINPLL_D7_D2]);\n}\n\nstatic int adsp_default_clk_init(struct snd_sof_dev *sdev, bool enable)\n{\n\tstruct device *dev = sdev->dev;\n\tstruct adsp_priv *priv = sdev->pdata->hw_pdata;\n\tint ret;\n\n\tdev_dbg(dev, \"%s: %s\\n\", __func__, enable ? \"on\" : \"off\");\n\n\tif (enable) {\n\t\tret = clk_set_parent(priv->clk[CLK_TOP_ADSP],\n\t\t\t\t     priv->clk[CLK_TOP_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"failed to set dsp_sel to clk26m: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = clk_set_parent(priv->clk[CLK_TOP_AUDIO_LOCAL_BUS],\n\t\t\t\t     priv->clk[CLK_TOP_MAINPLL_D7_D2]);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"set audio_local_bus failed %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = clk_set_parent(priv->clk[CLK_TOP_AUDIO_H],\n\t\t\t\t     priv->clk[CLK_TOP_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"set audio_h_sel failed %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = adsp_enable_all_clock(sdev);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"failed to adsp_enable_clock: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tadsp_disable_all_clock(sdev);\n\t}\n\n\treturn 0;\n}\n\nint adsp_clock_on(struct snd_sof_dev *sdev)\n{\n\t \n\treturn adsp_default_clk_init(sdev, 1);\n}\n\nint adsp_clock_off(struct snd_sof_dev *sdev)\n{\n\t \n\treturn adsp_default_clk_init(sdev, 0);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}