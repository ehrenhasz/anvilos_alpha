{
  "module_name": "stream-ipc.c",
  "hash_id": "44f343dcd5e04999fe9aa47b590e918afff763e0534719b6a761a2b473ec5a37",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/stream-ipc.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n \n\n#include <linux/device.h>\n#include <linux/export.h>\n#include <linux/module.h>\n#include <linux/types.h>\n\n#include <sound/pcm.h>\n#include <sound/sof/stream.h>\n\n#include \"ops.h\"\n#include \"sof-priv.h\"\n#include \"sof-audio.h\"\n\nstruct sof_stream {\n\tsize_t posn_offset;\n};\n\n \nint sof_ipc_msg_data(struct snd_sof_dev *sdev,\n\t\t     struct snd_sof_pcm_stream *sps,\n\t\t     void *p, size_t sz)\n{\n\tif (!sps || !sdev->stream_box.size) {\n\t\tsnd_sof_dsp_mailbox_read(sdev, sdev->dsp_box.offset, p, sz);\n\t} else {\n\t\tsize_t posn_offset;\n\n\t\tif (sps->substream) {\n\t\t\tstruct sof_stream *stream = sps->substream->runtime->private_data;\n\n\t\t\t \n\t\t\tif (!stream)\n\t\t\t\treturn -ESTRPIPE;\n\n\t\t\tposn_offset = stream->posn_offset;\n\t\t} else {\n\n\t\t\tstruct sof_compr_stream *sstream = sps->cstream->runtime->private_data;\n\n\t\t\tif (!sstream)\n\t\t\t\treturn -ESTRPIPE;\n\n\t\t\tposn_offset = sstream->posn_offset;\n\t\t}\n\n\t\tsnd_sof_dsp_mailbox_read(sdev, posn_offset, p, sz);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sof_ipc_msg_data);\n\nint sof_set_stream_data_offset(struct snd_sof_dev *sdev,\n\t\t\t       struct snd_sof_pcm_stream *sps,\n\t\t\t       size_t posn_offset)\n{\n\t \n\tif (posn_offset > sdev->stream_box.size ||\n\t    posn_offset % sizeof(struct sof_ipc_stream_posn) != 0)\n\t\treturn -EINVAL;\n\n\tposn_offset += sdev->stream_box.offset;\n\n\tif (sps->substream) {\n\t\tstruct sof_stream *stream = sps->substream->runtime->private_data;\n\n\t\tstream->posn_offset = posn_offset;\n\t\tdev_dbg(sdev->dev, \"pcm: stream dir %d, posn mailbox offset is %zu\",\n\t\t\tsps->substream->stream, posn_offset);\n\t} else if (sps->cstream) {\n\t\tstruct sof_compr_stream *sstream = sps->cstream->runtime->private_data;\n\n\t\tsstream->posn_offset = posn_offset;\n\t\tdev_dbg(sdev->dev, \"compr: stream dir %d, posn mailbox offset is %zu\",\n\t\t\tsps->cstream->direction, posn_offset);\n\t} else {\n\t\tdev_err(sdev->dev, \"No stream opened\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sof_set_stream_data_offset);\n\nint sof_stream_pcm_open(struct snd_sof_dev *sdev,\n\t\t\tstruct snd_pcm_substream *substream)\n{\n\tstruct sof_stream *stream = kmalloc(sizeof(*stream), GFP_KERNEL);\n\n\tif (!stream)\n\t\treturn -ENOMEM;\n\n\t \n\tsubstream->runtime->private_data = stream;\n\n\t \n\tsnd_pcm_hw_constraint_step(substream->runtime, 0, SNDRV_PCM_HW_PARAM_PERIOD_BYTES, 4);\n\n\t \n\tsnd_pcm_hw_constraint_integer(substream->runtime,\n\t\t\t\t      SNDRV_PCM_HW_PARAM_PERIODS);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sof_stream_pcm_open);\n\nint sof_stream_pcm_close(struct snd_sof_dev *sdev,\n\t\t\t struct snd_pcm_substream *substream)\n{\n\tstruct sof_stream *stream = substream->runtime->private_data;\n\n\tsubstream->runtime->private_data = NULL;\n\tkfree(stream);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sof_stream_pcm_close);\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}