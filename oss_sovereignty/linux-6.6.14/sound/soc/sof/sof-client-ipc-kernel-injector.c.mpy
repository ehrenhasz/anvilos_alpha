{
  "module_name": "sof-client-ipc-kernel-injector.c",
  "hash_id": "75e1e6703d5c9bdd063c668eebc97efd96867b15c6875d07a5bf5cddfef2fc06",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/sof-client-ipc-kernel-injector.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/auxiliary_bus.h>\n#include <linux/debugfs.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/pm_runtime.h>\n#include <sound/sof/header.h>\n\n#include \"sof-client.h\"\n\n#define SOF_IPC_CLIENT_SUSPEND_DELAY_MS\t3000\n\nstruct sof_msg_inject_priv {\n\tstruct dentry *kernel_dfs_file;\n\tsize_t max_msg_size;\n\n\tvoid *kernel_buffer;\n};\n\nstatic int sof_msg_inject_dfs_open(struct inode *inode, struct file *file)\n{\n\tint ret = debugfs_file_get(file->f_path.dentry);\n\n\tif (unlikely(ret))\n\t\treturn ret;\n\n\tret = simple_open(inode, file);\n\tif (ret)\n\t\tdebugfs_file_put(file->f_path.dentry);\n\n\treturn ret;\n}\n\nstatic ssize_t sof_kernel_msg_inject_dfs_write(struct file *file, const char __user *buffer,\n\t\t\t\t\t       size_t count, loff_t *ppos)\n{\n\tstruct sof_client_dev *cdev = file->private_data;\n\tstruct sof_msg_inject_priv *priv = cdev->data;\n\tstruct sof_ipc_cmd_hdr *hdr = priv->kernel_buffer;\n\tstruct device *dev = &cdev->auxdev.dev;\n\tssize_t size;\n\tint ret;\n\n\tif (*ppos)\n\t\treturn 0;\n\n\tsize = simple_write_to_buffer(priv->kernel_buffer, priv->max_msg_size,\n\t\t\t\t      ppos, buffer, count);\n\tif (size < 0)\n\t\treturn size;\n\tif (size != count)\n\t\treturn -EFAULT;\n\n\tret = pm_runtime_resume_and_get(dev);\n\tif (ret < 0 && ret != -EACCES) {\n\t\tdev_err_ratelimited(dev, \"debugfs write failed to resume %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tsof_client_ipc_rx_message(cdev, hdr, priv->kernel_buffer);\n\n\tpm_runtime_mark_last_busy(dev);\n\tret = pm_runtime_put_autosuspend(dev);\n\tif (ret < 0)\n\t\tdev_err_ratelimited(dev, \"debugfs write failed to idle %d\\n\", ret);\n\n\treturn count;\n};\n\nstatic int sof_msg_inject_dfs_release(struct inode *inode, struct file *file)\n{\n\tdebugfs_file_put(file->f_path.dentry);\n\n\treturn 0;\n}\n\nstatic const struct file_operations sof_kernel_msg_inject_fops = {\n\t.open = sof_msg_inject_dfs_open,\n\t.write = sof_kernel_msg_inject_dfs_write,\n\t.release = sof_msg_inject_dfs_release,\n\n\t.owner = THIS_MODULE,\n};\n\nstatic int sof_msg_inject_probe(struct auxiliary_device *auxdev,\n\t\t\t\tconst struct auxiliary_device_id *id)\n{\n\tstruct sof_client_dev *cdev = auxiliary_dev_to_sof_client_dev(auxdev);\n\tstruct dentry *debugfs_root = sof_client_get_debugfs_root(cdev);\n\tstruct device *dev = &auxdev->dev;\n\tstruct sof_msg_inject_priv *priv;\n\tsize_t alloc_size;\n\n\t \n\tpriv = devm_kzalloc(&auxdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->max_msg_size = sof_client_get_ipc_max_payload_size(cdev);\n\talloc_size = priv->max_msg_size;\n\tpriv->kernel_buffer = devm_kmalloc(dev, alloc_size, GFP_KERNEL);\n\n\tif (!priv->kernel_buffer)\n\t\treturn -ENOMEM;\n\n\tcdev->data = priv;\n\n\tpriv->kernel_dfs_file = debugfs_create_file(\"kernel_ipc_msg_inject\", 0644,\n\t\t\t\t\t\t    debugfs_root, cdev,\n\t\t\t\t\t\t    &sof_kernel_msg_inject_fops);\n\n\t \n\tpm_runtime_set_autosuspend_delay(dev, SOF_IPC_CLIENT_SUSPEND_DELAY_MS);\n\tpm_runtime_use_autosuspend(dev);\n\tpm_runtime_set_active(dev);\n\tpm_runtime_enable(dev);\n\tpm_runtime_mark_last_busy(dev);\n\tpm_runtime_idle(dev);\n\n\treturn 0;\n}\n\nstatic void sof_msg_inject_remove(struct auxiliary_device *auxdev)\n{\n\tstruct sof_client_dev *cdev = auxiliary_dev_to_sof_client_dev(auxdev);\n\tstruct sof_msg_inject_priv *priv = cdev->data;\n\n\tpm_runtime_disable(&auxdev->dev);\n\n\tdebugfs_remove(priv->kernel_dfs_file);\n}\n\nstatic const struct auxiliary_device_id sof_msg_inject_client_id_table[] = {\n\t{ .name = \"snd_sof.kernel_injector\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(auxiliary, sof_msg_inject_client_id_table);\n\n \nstatic struct auxiliary_driver sof_msg_inject_client_drv = {\n\t.probe = sof_msg_inject_probe,\n\t.remove = sof_msg_inject_remove,\n\n\t.id_table = sof_msg_inject_client_id_table,\n};\n\nmodule_auxiliary_driver(sof_msg_inject_client_drv);\n\nMODULE_DESCRIPTION(\"SOF IPC Kernel Injector Client Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(SND_SOC_SOF_CLIENT);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}