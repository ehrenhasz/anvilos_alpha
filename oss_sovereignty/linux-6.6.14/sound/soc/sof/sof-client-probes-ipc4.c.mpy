{
  "module_name": "sof-client-probes-ipc4.c",
  "hash_id": "879e767d220acd9edee6f1823a821a34a538514925206d21bd0100e4cccaa864",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/sof-client-probes-ipc4.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <sound/soc.h>\n#include <sound/sof/ipc4/header.h>\n#include <uapi/sound/sof/header.h>\n#include \"sof-priv.h\"\n#include \"ipc4-priv.h\"\n#include \"sof-client.h\"\n#include \"sof-client-probes.h\"\n\nenum sof_ipc4_dma_type {\n\tSOF_IPC4_DMA_HDA_HOST_OUTPUT = 0,\n\tSOF_IPC4_DMA_HDA_HOST_INPUT = 1,\n\tSOF_IPC4_DMA_HDA_LINK_OUTPUT = 8,\n\tSOF_IPC4_DMA_HDA_LINK_INPUT = 9,\n\tSOF_IPC4_DMA_DMIC_LINK_INPUT = 11,\n\tSOF_IPC4_DMA_I2S_LINK_OUTPUT = 12,\n\tSOF_IPC4_DMA_I2S_LINK_INPUT = 13,\n};\n\nenum sof_ipc4_probe_runtime_param {\n\tSOF_IPC4_PROBE_INJECTION_DMA = 1,\n\tSOF_IPC4_PROBE_INJECTION_DMA_DETACH,\n\tSOF_IPC4_PROBE_POINTS,\n\tSOF_IPC4_PROBE_POINTS_DISCONNECT,\n};\n\nstruct sof_ipc4_probe_gtw_cfg {\n\tu32 node_id;\n\tu32 dma_buffer_size;\n} __packed __aligned(4);\n\n#define SOF_IPC4_PROBE_NODE_ID_INDEX(x)\t\t((x) & GENMASK(7, 0))\n#define SOF_IPC4_PROBE_NODE_ID_TYPE(x)\t\t(((x) << 8) & GENMASK(12, 8))\n\nstruct sof_ipc4_probe_cfg {\n\tstruct sof_ipc4_base_module_cfg base;\n\tstruct sof_ipc4_probe_gtw_cfg gtw_cfg;\n} __packed __aligned(4);\n\nenum sof_ipc4_probe_type {\n\tSOF_IPC4_PROBE_TYPE_INPUT = 0,\n\tSOF_IPC4_PROBE_TYPE_OUTPUT,\n\tSOF_IPC4_PROBE_TYPE_INTERNAL\n};\n\nstruct sof_ipc4_probe_point {\n\tu32 point_id;\n\tu32 purpose;\n\tu32 stream_tag;\n} __packed __aligned(4);\n\n#define INVALID_PIPELINE_ID      0xFF\n\n \nstatic struct sof_man4_module *sof_ipc4_probe_get_module_info(struct sof_client_dev *cdev)\n{\n\tstruct sof_probes_priv *priv = cdev->data;\n\tstruct device *dev = &cdev->auxdev.dev;\n\tstatic const guid_t probe_uuid =\n\t\tGUID_INIT(0x7CAD0808, 0xAB10, 0xCD23,\n\t\t\t  0xEF, 0x45, 0x12, 0xAB, 0x34, 0xCD, 0x56, 0xEF);\n\n\tif (!priv->ipc_priv) {\n\t\tstruct sof_ipc4_fw_module *fw_module =\n\t\t\tsof_client_ipc4_find_module(cdev, &probe_uuid);\n\n\t\tif (!fw_module) {\n\t\t\tdev_err(dev, \"%s: no matching uuid found\", __func__);\n\t\t\treturn NULL;\n\t\t}\n\n\t\tpriv->ipc_priv = &fw_module->man4_module_entry;\n\t}\n\n\treturn (struct sof_man4_module *)priv->ipc_priv;\n}\n\n \nstatic int ipc4_probes_init(struct sof_client_dev *cdev, u32 stream_tag,\n\t\t\t    size_t buffer_size)\n{\n\tstruct sof_man4_module *mentry = sof_ipc4_probe_get_module_info(cdev);\n\tstruct sof_ipc4_msg msg;\n\tstruct sof_ipc4_probe_cfg cfg;\n\n\tif (!mentry)\n\t\treturn -ENODEV;\n\n\tmemset(&cfg, '\\0', sizeof(cfg));\n\tcfg.gtw_cfg.node_id = SOF_IPC4_PROBE_NODE_ID_INDEX(stream_tag - 1) |\n\t\tSOF_IPC4_PROBE_NODE_ID_TYPE(SOF_IPC4_DMA_HDA_HOST_INPUT);\n\n\tcfg.gtw_cfg.dma_buffer_size = buffer_size;\n\n\tmsg.primary = mentry->id;\n\tmsg.primary |= SOF_IPC4_MSG_TYPE_SET(SOF_IPC4_MOD_INIT_INSTANCE);\n\tmsg.primary |= SOF_IPC4_MSG_DIR(SOF_IPC4_MSG_REQUEST);\n\tmsg.primary |= SOF_IPC4_MSG_TARGET(SOF_IPC4_MODULE_MSG);\n\tmsg.extension = SOF_IPC4_MOD_EXT_DST_MOD_INSTANCE(INVALID_PIPELINE_ID);\n\tmsg.extension |= SOF_IPC4_MOD_EXT_CORE_ID(0);\n\n\tmsg.data_size = sizeof(cfg);\n\tmsg.data_ptr = &cfg;\n\n\treturn sof_client_ipc_tx_message_no_reply(cdev, &msg);\n}\n\n \nstatic int ipc4_probes_deinit(struct sof_client_dev *cdev)\n{\n\tstruct sof_man4_module *mentry = sof_ipc4_probe_get_module_info(cdev);\n\tstruct sof_ipc4_msg msg;\n\n\tif (!mentry)\n\t\treturn -ENODEV;\n\n\tmsg.primary = mentry->id;\n\tmsg.primary |= SOF_IPC4_MSG_TYPE_SET(SOF_IPC4_MOD_DELETE_INSTANCE);\n\tmsg.primary |= SOF_IPC4_MSG_DIR(SOF_IPC4_MSG_REQUEST);\n\tmsg.primary |= SOF_IPC4_MSG_TARGET(SOF_IPC4_MODULE_MSG);\n\tmsg.extension = SOF_IPC4_MOD_EXT_DST_MOD_INSTANCE(INVALID_PIPELINE_ID);\n\tmsg.extension |= SOF_IPC4_MOD_EXT_CORE_ID(0);\n\n\tmsg.data_size = 0;\n\tmsg.data_ptr = NULL;\n\n\treturn sof_client_ipc_tx_message_no_reply(cdev, &msg);\n}\n\n \nstatic int ipc4_probes_points_info(struct sof_client_dev *cdev,\n\t\t\t\t   struct sof_probe_point_desc **desc,\n\t\t\t\t   size_t *num_desc)\n{\n\t \n\t*desc = NULL;\n\t*num_desc = 0;\n\treturn 0;\n}\n\n \nstatic int ipc4_probes_points_add(struct sof_client_dev *cdev,\n\t\t\t\t  struct sof_probe_point_desc *desc,\n\t\t\t\t  size_t num_desc)\n{\n\tstruct sof_man4_module *mentry = sof_ipc4_probe_get_module_info(cdev);\n\tstruct sof_ipc4_probe_point *points;\n\tstruct sof_ipc4_msg msg;\n\tint i, ret;\n\n\tif (!mentry)\n\t\treturn -ENODEV;\n\n\t \n\tpoints = kcalloc(num_desc, sizeof(*points), GFP_KERNEL);\n\tif (!points)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < num_desc; i++) {\n\t\tpoints[i].point_id = desc[i].buffer_id;\n\t\tpoints[i].purpose = desc[i].purpose;\n\t\tpoints[i].stream_tag = desc[i].stream_tag;\n\t}\n\n\tmsg.primary = mentry->id;\n\tmsg.primary |= SOF_IPC4_MSG_DIR(SOF_IPC4_MSG_REQUEST);\n\tmsg.primary |= SOF_IPC4_MSG_TARGET(SOF_IPC4_MODULE_MSG);\n\n\tmsg.extension = SOF_IPC4_MOD_EXT_MSG_PARAM_ID(SOF_IPC4_PROBE_POINTS);\n\n\tmsg.data_size = sizeof(*points) * num_desc;\n\tmsg.data_ptr = points;\n\n\tret = sof_client_ipc_set_get_data(cdev, &msg, true);\n\n\tkfree(points);\n\n\treturn ret;\n}\n\n \nstatic int ipc4_probes_points_remove(struct sof_client_dev *cdev,\n\t\t\t\t     unsigned int *buffer_id, size_t num_buffer_id)\n{\n\tstruct sof_man4_module *mentry = sof_ipc4_probe_get_module_info(cdev);\n\tstruct sof_ipc4_msg msg;\n\tu32 *probe_point_ids;\n\tint i, ret;\n\n\tif (!mentry)\n\t\treturn -ENODEV;\n\n\tprobe_point_ids = kcalloc(num_buffer_id, sizeof(*probe_point_ids),\n\t\t\t\t  GFP_KERNEL);\n\tif (!probe_point_ids)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < num_buffer_id; i++)\n\t\tprobe_point_ids[i] = buffer_id[i];\n\n\tmsg.primary = mentry->id;\n\tmsg.primary |= SOF_IPC4_MSG_DIR(SOF_IPC4_MSG_REQUEST);\n\tmsg.primary |= SOF_IPC4_MSG_TARGET(SOF_IPC4_MODULE_MSG);\n\n\tmsg.extension =\n\t\tSOF_IPC4_MOD_EXT_MSG_PARAM_ID(SOF_IPC4_PROBE_POINTS_DISCONNECT);\n\n\tmsg.data_size = num_buffer_id * sizeof(*probe_point_ids);\n\tmsg.data_ptr = probe_point_ids;\n\n\tret = sof_client_ipc_set_get_data(cdev, &msg, true);\n\n\tkfree(probe_point_ids);\n\n\treturn ret;\n}\n\nconst struct sof_probes_ipc_ops ipc4_probe_ops =  {\n\t.init = ipc4_probes_init,\n\t.deinit = ipc4_probes_deinit,\n\t.points_info = ipc4_probes_points_info,\n\t.points_add = ipc4_probes_points_add,\n\t.points_remove = ipc4_probes_points_remove,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}