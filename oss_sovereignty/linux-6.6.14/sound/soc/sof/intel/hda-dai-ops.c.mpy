{
  "module_name": "hda-dai-ops.c",
  "hash_id": "8ccab07375f35de79cfbfc37d709618efef3bfe4570f77c6e3fb2eeb2e952342",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/intel/hda-dai-ops.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <sound/pcm_params.h>\n#include <sound/hdaudio_ext.h>\n#include <sound/hda-mlink.h>\n#include <sound/sof/ipc4/header.h>\n#include <uapi/sound/sof/header.h>\n#include \"../ipc4-priv.h\"\n#include \"../ipc4-topology.h\"\n#include \"../sof-priv.h\"\n#include \"../sof-audio.h\"\n#include \"hda.h\"\n\n \n#if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA_LINK)\n \nstatic bool hda_check_fes(struct snd_soc_pcm_runtime *rtd,\n\t\t\t  int dir, int stream_tag)\n{\n\tstruct snd_pcm_substream *fe_substream;\n\tstruct hdac_stream *fe_hstream;\n\tstruct snd_soc_dpcm *dpcm;\n\n\tfor_each_dpcm_fe(rtd, dir, dpcm) {\n\t\tfe_substream = snd_soc_dpcm_get_substream(dpcm->fe, dir);\n\t\tfe_hstream = fe_substream->runtime->private_data;\n\t\tif (fe_hstream->stream_tag == stream_tag)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic struct hdac_ext_stream *\nhda_link_stream_assign(struct hdac_bus *bus, struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct sof_intel_hda_stream *hda_stream;\n\tconst struct sof_intel_dsp_desc *chip;\n\tstruct snd_sof_dev *sdev;\n\tstruct hdac_ext_stream *res = NULL;\n\tstruct hdac_stream *hstream = NULL;\n\n\tint stream_dir = substream->stream;\n\n\tif (!bus->ppcap) {\n\t\tdev_err(bus->dev, \"stream type not supported\\n\");\n\t\treturn NULL;\n\t}\n\n\tspin_lock_irq(&bus->reg_lock);\n\tlist_for_each_entry(hstream, &bus->stream_list, list) {\n\t\tstruct hdac_ext_stream *hext_stream =\n\t\t\tstream_to_hdac_ext_stream(hstream);\n\t\tif (hstream->direction != substream->stream)\n\t\t\tcontinue;\n\n\t\thda_stream = hstream_to_sof_hda_stream(hext_stream);\n\t\tsdev = hda_stream->sdev;\n\t\tchip = get_chip_info(sdev->pdata);\n\n\t\t \n\t\tif (!hext_stream->link_locked) {\n\t\t\t \n\t\t\tif (!(chip->quirks & SOF_INTEL_PROCEN_FMT_QUIRK)) {\n\t\t\t\tres = hext_stream;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (hstream->opened) {\n\t\t\t\t \n\t\t\t\tif (hda_check_fes(rtd, stream_dir,\n\t\t\t\t\t\t  hstream->stream_tag)) {\n\t\t\t\t\tres = hext_stream;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tres = hext_stream;\n\n\t\t\t\t \n\t\t\t\thda_stream->host_reserved = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (res) {\n\t\t \n\t\tsnd_hdac_ext_stream_decouple_locked(bus, res, true);\n\n\t\tres->link_locked = 1;\n\t\tres->link_substream = substream;\n\t}\n\tspin_unlock_irq(&bus->reg_lock);\n\n\treturn res;\n}\n\nstatic struct hdac_ext_stream *hda_get_hext_stream(struct snd_sof_dev *sdev,\n\t\t\t\t\t\t   struct snd_soc_dai *cpu_dai,\n\t\t\t\t\t\t   struct snd_pcm_substream *substream)\n{\n\treturn snd_soc_dai_get_dma_data(cpu_dai, substream);\n}\n\nstatic struct hdac_ext_stream *hda_ipc4_get_hext_stream(struct snd_sof_dev *sdev,\n\t\t\t\t\t\t\tstruct snd_soc_dai *cpu_dai,\n\t\t\t\t\t\t\tstruct snd_pcm_substream *substream)\n{\n\tstruct snd_sof_widget *pipe_widget;\n\tstruct sof_ipc4_pipeline *pipeline;\n\tstruct snd_sof_widget *swidget;\n\tstruct snd_soc_dapm_widget *w;\n\n\tw = snd_soc_dai_get_widget(cpu_dai, substream->stream);\n\tswidget = w->dobj.private;\n\tpipe_widget = swidget->spipe->pipe_widget;\n\tpipeline = pipe_widget->private;\n\n\t \n\tpipeline->skip_during_fe_trigger = true;\n\n\treturn snd_soc_dai_get_dma_data(cpu_dai, substream);\n}\n\nstatic struct hdac_ext_stream *hda_assign_hext_stream(struct snd_sof_dev *sdev,\n\t\t\t\t\t\t      struct snd_soc_dai *cpu_dai,\n\t\t\t\t\t\t      struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *dai;\n\tstruct hdac_ext_stream *hext_stream;\n\n\t \n\tdai = asoc_rtd_to_cpu(rtd, 0);\n\tif (dai == cpu_dai)\n\t\thext_stream = hda_link_stream_assign(sof_to_bus(sdev), substream);\n\telse\n\t\thext_stream = snd_soc_dai_get_dma_data(dai, substream);\n\n\tif (!hext_stream)\n\t\treturn NULL;\n\n\tsnd_soc_dai_set_dma_data(cpu_dai, substream, (void *)hext_stream);\n\n\treturn hext_stream;\n}\n\nstatic void hda_release_hext_stream(struct snd_sof_dev *sdev, struct snd_soc_dai *cpu_dai,\n\t\t\t\t    struct snd_pcm_substream *substream)\n{\n\tstruct hdac_ext_stream *hext_stream = hda_get_hext_stream(sdev, cpu_dai, substream);\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *dai;\n\n\t \n\tdai = asoc_rtd_to_cpu(rtd, 0);\n\tif (dai == cpu_dai)\n\t\tsnd_hdac_ext_stream_release(hext_stream, HDAC_EXT_STREAM_TYPE_LINK);\n\tsnd_soc_dai_set_dma_data(cpu_dai, substream, NULL);\n}\n\nstatic void hda_setup_hext_stream(struct snd_sof_dev *sdev, struct hdac_ext_stream *hext_stream,\n\t\t\t\t  unsigned int format_val)\n{\n\tsnd_hdac_ext_stream_setup(hext_stream, format_val);\n}\n\nstatic void hda_reset_hext_stream(struct snd_sof_dev *sdev, struct hdac_ext_stream *hext_stream)\n{\n\tsnd_hdac_ext_stream_reset(hext_stream);\n}\n\nstatic void hda_codec_dai_set_stream(struct snd_sof_dev *sdev,\n\t\t\t\t     struct snd_pcm_substream *substream,\n\t\t\t\t     struct hdac_stream *hstream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\t \n\tsnd_soc_dai_set_stream(codec_dai, hstream, substream->stream);\n}\n\nstatic unsigned int hda_calc_stream_format(struct snd_sof_dev *sdev,\n\t\t\t\t\t   struct snd_pcm_substream *substream,\n\t\t\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tunsigned int link_bps;\n\tunsigned int format_val;\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tlink_bps = codec_dai->driver->playback.sig_bits;\n\telse\n\t\tlink_bps = codec_dai->driver->capture.sig_bits;\n\n\tformat_val = snd_hdac_calc_stream_format(params_rate(params), params_channels(params),\n\t\t\t\t\t\t params_format(params), link_bps, 0);\n\n\tdev_dbg(sdev->dev, \"format_val=%#x, rate=%d, ch=%d, format=%d\\n\", format_val,\n\t\tparams_rate(params), params_channels(params), params_format(params));\n\n\treturn format_val;\n}\n\nstatic struct hdac_ext_link *hda_get_hlink(struct snd_sof_dev *sdev,\n\t\t\t\t\t   struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct hdac_bus *bus = sof_to_bus(sdev);\n\n\treturn snd_hdac_ext_bus_get_hlink_by_name(bus, codec_dai->component->name);\n}\n\nstatic unsigned int generic_calc_stream_format(struct snd_sof_dev *sdev,\n\t\t\t\t\t       struct snd_pcm_substream *substream,\n\t\t\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tunsigned int format_val;\n\n\tformat_val = snd_hdac_calc_stream_format(params_rate(params), params_channels(params),\n\t\t\t\t\t\t params_format(params),\n\t\t\t\t\t\t params_physical_width(params),\n\t\t\t\t\t\t 0);\n\n\tdev_dbg(sdev->dev, \"format_val=%#x, rate=%d, ch=%d, format=%d\\n\", format_val,\n\t\tparams_rate(params), params_channels(params), params_format(params));\n\n\treturn format_val;\n}\n\nstatic unsigned int dmic_calc_stream_format(struct snd_sof_dev *sdev,\n\t\t\t\t\t    struct snd_pcm_substream *substream,\n\t\t\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tunsigned int format_val;\n\tsnd_pcm_format_t format;\n\tunsigned int channels;\n\tunsigned int width;\n\n\tchannels = params_channels(params);\n\tformat = params_format(params);\n\twidth = params_physical_width(params);\n\n\tif (format == SNDRV_PCM_FORMAT_S16_LE) {\n\t\tformat = SNDRV_PCM_FORMAT_S32_LE;\n\t\tchannels /= 2;\n\t\twidth = 32;\n\t}\n\n\tformat_val = snd_hdac_calc_stream_format(params_rate(params), channels,\n\t\t\t\t\t\t format,\n\t\t\t\t\t\t width,\n\t\t\t\t\t\t 0);\n\n\tdev_dbg(sdev->dev, \"format_val=%#x, rate=%d, ch=%d, format=%d\\n\", format_val,\n\t\tparams_rate(params), channels, format);\n\n\treturn format_val;\n}\n\nstatic struct hdac_ext_link *ssp_get_hlink(struct snd_sof_dev *sdev,\n\t\t\t\t\t   struct snd_pcm_substream *substream)\n{\n\tstruct hdac_bus *bus = sof_to_bus(sdev);\n\n\treturn hdac_bus_eml_ssp_get_hlink(bus);\n}\n\nstatic struct hdac_ext_link *dmic_get_hlink(struct snd_sof_dev *sdev,\n\t\t\t\t\t    struct snd_pcm_substream *substream)\n{\n\tstruct hdac_bus *bus = sof_to_bus(sdev);\n\n\treturn hdac_bus_eml_dmic_get_hlink(bus);\n}\n\nstatic struct hdac_ext_link *sdw_get_hlink(struct snd_sof_dev *sdev,\n\t\t\t\t\t   struct snd_pcm_substream *substream)\n{\n\tstruct hdac_bus *bus = sof_to_bus(sdev);\n\n\treturn hdac_bus_eml_sdw_get_hlink(bus);\n}\n\nstatic int hda_ipc4_pre_trigger(struct snd_sof_dev *sdev, struct snd_soc_dai *cpu_dai,\n\t\t\t\tstruct snd_pcm_substream *substream, int cmd)\n{\n\tstruct sof_ipc4_fw_data *ipc4_data = sdev->private;\n\tstruct snd_sof_widget *pipe_widget;\n\tstruct sof_ipc4_pipeline *pipeline;\n\tstruct snd_sof_widget *swidget;\n\tstruct snd_soc_dapm_widget *w;\n\tint ret = 0;\n\n\tw = snd_soc_dai_get_widget(cpu_dai, substream->stream);\n\tswidget = w->dobj.private;\n\tpipe_widget = swidget->spipe->pipe_widget;\n\tpipeline = pipe_widget->private;\n\n\tif (pipe_widget->instance_id < 0)\n\t\treturn 0;\n\n\tmutex_lock(&ipc4_data->pipeline_state_mutex);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\t\tret = sof_ipc4_set_pipeline_state(sdev, pipe_widget->instance_id,\n\t\t\t\t\t\t  SOF_IPC4_PIPE_PAUSED);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\n\t\tpipeline->state = SOF_IPC4_PIPE_PAUSED;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(sdev->dev, \"unknown trigger command %d\\n\", cmd);\n\t\tret = -EINVAL;\n\t}\nout:\n\tmutex_unlock(&ipc4_data->pipeline_state_mutex);\n\treturn ret;\n}\n\nstatic int hda_trigger(struct snd_sof_dev *sdev, struct snd_soc_dai *cpu_dai,\n\t\t       struct snd_pcm_substream *substream, int cmd)\n{\n\tstruct hdac_ext_stream *hext_stream = snd_soc_dai_get_dma_data(cpu_dai, substream);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tsnd_hdac_ext_stream_start(hext_stream);\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tsnd_hdac_ext_stream_clear(hext_stream);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(sdev->dev, \"unknown trigger command %d\\n\", cmd);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int hda_ipc4_post_trigger(struct snd_sof_dev *sdev, struct snd_soc_dai *cpu_dai,\n\t\t\t\t struct snd_pcm_substream *substream, int cmd)\n{\n\tstruct sof_ipc4_fw_data *ipc4_data = sdev->private;\n\tstruct snd_sof_widget *pipe_widget;\n\tstruct sof_ipc4_pipeline *pipeline;\n\tstruct snd_sof_widget *swidget;\n\tstruct snd_soc_dapm_widget *w;\n\tint ret = 0;\n\n\tw = snd_soc_dai_get_widget(cpu_dai, substream->stream);\n\tswidget = w->dobj.private;\n\tpipe_widget = swidget->spipe->pipe_widget;\n\tpipeline = pipe_widget->private;\n\n\tif (pipe_widget->instance_id < 0)\n\t\treturn 0;\n\n\tmutex_lock(&ipc4_data->pipeline_state_mutex);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\t\tif (pipeline->state != SOF_IPC4_PIPE_PAUSED) {\n\t\t\tret = sof_ipc4_set_pipeline_state(sdev, pipe_widget->instance_id,\n\t\t\t\t\t\t\t  SOF_IPC4_PIPE_PAUSED);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto out;\n\t\t\tpipeline->state = SOF_IPC4_PIPE_PAUSED;\n\t\t}\n\n\t\tret = sof_ipc4_set_pipeline_state(sdev, pipe_widget->instance_id,\n\t\t\t\t\t\t  SOF_IPC4_PIPE_RUNNING);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\t\tpipeline->state = SOF_IPC4_PIPE_RUNNING;\n\t\tswidget->spipe->started_count++;\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tret = sof_ipc4_set_pipeline_state(sdev, pipe_widget->instance_id,\n\t\t\t\t\t\t  SOF_IPC4_PIPE_RUNNING);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\t\tpipeline->state = SOF_IPC4_PIPE_RUNNING;\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\t\t \n\t\tswidget->spipe->started_count = 0;\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(sdev->dev, \"unknown trigger command %d\\n\", cmd);\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\nout:\n\tmutex_unlock(&ipc4_data->pipeline_state_mutex);\n\treturn ret;\n}\n\nstatic struct hdac_ext_stream *sdw_hda_ipc4_get_hext_stream(struct snd_sof_dev *sdev,\n\t\t\t\t\t\t\t    struct snd_soc_dai *cpu_dai,\n\t\t\t\t\t\t\t    struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_dapm_widget *w = snd_soc_dai_get_widget(cpu_dai, substream->stream);\n\tstruct snd_sof_widget *swidget = w->dobj.private;\n\tstruct snd_sof_dai *dai = swidget->private;\n\tstruct sof_ipc4_copier *ipc4_copier = dai->private;\n\tstruct sof_ipc4_alh_configuration_blob *blob;\n\n\tblob = (struct sof_ipc4_alh_configuration_blob *)ipc4_copier->copier_config;\n\n\t \n\tblob->alh_cfg.device_count = 1;\n\n\treturn hda_ipc4_get_hext_stream(sdev, cpu_dai, substream);\n}\n\nstatic const struct hda_dai_widget_dma_ops hda_ipc4_dma_ops = {\n\t.get_hext_stream = hda_ipc4_get_hext_stream,\n\t.assign_hext_stream = hda_assign_hext_stream,\n\t.release_hext_stream = hda_release_hext_stream,\n\t.setup_hext_stream = hda_setup_hext_stream,\n\t.reset_hext_stream = hda_reset_hext_stream,\n\t.pre_trigger = hda_ipc4_pre_trigger,\n\t.trigger = hda_trigger,\n\t.post_trigger = hda_ipc4_post_trigger,\n\t.codec_dai_set_stream = hda_codec_dai_set_stream,\n\t.calc_stream_format = hda_calc_stream_format,\n\t.get_hlink = hda_get_hlink,\n};\n\nstatic const struct hda_dai_widget_dma_ops ssp_ipc4_dma_ops = {\n\t.get_hext_stream = hda_ipc4_get_hext_stream,\n\t.assign_hext_stream = hda_assign_hext_stream,\n\t.release_hext_stream = hda_release_hext_stream,\n\t.setup_hext_stream = hda_setup_hext_stream,\n\t.reset_hext_stream = hda_reset_hext_stream,\n\t.pre_trigger = hda_ipc4_pre_trigger,\n\t.trigger = hda_trigger,\n\t.post_trigger = hda_ipc4_post_trigger,\n\t.calc_stream_format = generic_calc_stream_format,\n\t.get_hlink = ssp_get_hlink,\n};\n\nstatic const struct hda_dai_widget_dma_ops dmic_ipc4_dma_ops = {\n\t.get_hext_stream = hda_ipc4_get_hext_stream,\n\t.assign_hext_stream = hda_assign_hext_stream,\n\t.release_hext_stream = hda_release_hext_stream,\n\t.setup_hext_stream = hda_setup_hext_stream,\n\t.reset_hext_stream = hda_reset_hext_stream,\n\t.pre_trigger = hda_ipc4_pre_trigger,\n\t.trigger = hda_trigger,\n\t.post_trigger = hda_ipc4_post_trigger,\n\t.calc_stream_format = dmic_calc_stream_format,\n\t.get_hlink = dmic_get_hlink,\n};\n\nstatic const struct hda_dai_widget_dma_ops sdw_ipc4_dma_ops = {\n\t.get_hext_stream = sdw_hda_ipc4_get_hext_stream,\n\t.assign_hext_stream = hda_assign_hext_stream,\n\t.release_hext_stream = hda_release_hext_stream,\n\t.setup_hext_stream = hda_setup_hext_stream,\n\t.reset_hext_stream = hda_reset_hext_stream,\n\t.pre_trigger = hda_ipc4_pre_trigger,\n\t.trigger = hda_trigger,\n\t.post_trigger = hda_ipc4_post_trigger,\n\t.calc_stream_format = generic_calc_stream_format,\n\t.get_hlink = sdw_get_hlink,\n};\n\nstatic const struct hda_dai_widget_dma_ops hda_ipc4_chain_dma_ops = {\n\t.get_hext_stream = hda_get_hext_stream,\n\t.assign_hext_stream = hda_assign_hext_stream,\n\t.release_hext_stream = hda_release_hext_stream,\n\t.setup_hext_stream = hda_setup_hext_stream,\n\t.reset_hext_stream = hda_reset_hext_stream,\n\t.trigger = hda_trigger,\n\t.codec_dai_set_stream = hda_codec_dai_set_stream,\n\t.calc_stream_format = hda_calc_stream_format,\n\t.get_hlink = hda_get_hlink,\n};\n\nstatic int hda_ipc3_post_trigger(struct snd_sof_dev *sdev, struct snd_soc_dai *cpu_dai,\n\t\t\t\t struct snd_pcm_substream *substream, int cmd)\n{\n\tstruct hdac_ext_stream *hext_stream = hda_get_hext_stream(sdev, cpu_dai, substream);\n\tstruct snd_soc_dapm_widget *w = snd_soc_dai_get_widget(cpu_dai, substream->stream);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\t{\n\t\tstruct snd_sof_dai_config_data data = { 0 };\n\t\tint ret;\n\n\t\tdata.dai_data = DMA_CHAN_INVALID;\n\t\tret = hda_dai_config(w, SOF_DAI_CONFIG_FLAGS_HW_FREE, &data);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (cmd == SNDRV_PCM_TRIGGER_STOP)\n\t\t\treturn hda_link_dma_cleanup(substream, hext_stream, cpu_dai);\n\n\t\tbreak;\n\t}\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\treturn hda_dai_config(w, SOF_DAI_CONFIG_FLAGS_PAUSE, NULL);\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct hda_dai_widget_dma_ops hda_ipc3_dma_ops = {\n\t.get_hext_stream = hda_get_hext_stream,\n\t.assign_hext_stream = hda_assign_hext_stream,\n\t.release_hext_stream = hda_release_hext_stream,\n\t.setup_hext_stream = hda_setup_hext_stream,\n\t.reset_hext_stream = hda_reset_hext_stream,\n\t.trigger = hda_trigger,\n\t.post_trigger = hda_ipc3_post_trigger,\n\t.codec_dai_set_stream = hda_codec_dai_set_stream,\n\t.calc_stream_format = hda_calc_stream_format,\n\t.get_hlink = hda_get_hlink,\n};\n\nstatic struct hdac_ext_stream *\nhda_dspless_get_hext_stream(struct snd_sof_dev *sdev, struct snd_soc_dai *cpu_dai,\n\t\t\t    struct snd_pcm_substream *substream)\n{\n\tstruct hdac_stream *hstream = substream->runtime->private_data;\n\n\treturn stream_to_hdac_ext_stream(hstream);\n}\n\nstatic void hda_dspless_setup_hext_stream(struct snd_sof_dev *sdev,\n\t\t\t\t\t  struct hdac_ext_stream *hext_stream,\n\t\t\t\t\t  unsigned int format_val)\n{\n\t \n\thext_stream->hstream.format_val = format_val;\n}\n\nstatic const struct hda_dai_widget_dma_ops hda_dspless_dma_ops = {\n\t.get_hext_stream = hda_dspless_get_hext_stream,\n\t.setup_hext_stream = hda_dspless_setup_hext_stream,\n\t.codec_dai_set_stream = hda_codec_dai_set_stream,\n\t.calc_stream_format = hda_calc_stream_format,\n\t.get_hlink = hda_get_hlink,\n};\n\n#endif\n\nconst struct hda_dai_widget_dma_ops *\nhda_select_dai_widget_ops(struct snd_sof_dev *sdev, struct snd_sof_widget *swidget)\n{\n#if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA_LINK)\n\tstruct snd_sof_dai *sdai;\n\n\tif (sdev->dspless_mode_selected)\n\t\treturn &hda_dspless_dma_ops;\n\n\tsdai = swidget->private;\n\n\tswitch (sdev->pdata->ipc_type) {\n\tcase SOF_IPC:\n\t{\n\t\tstruct sof_dai_private_data *private = sdai->private;\n\n\t\tif (private->dai_config->type == SOF_DAI_INTEL_HDA)\n\t\t\treturn &hda_ipc3_dma_ops;\n\t\tbreak;\n\t}\n\tcase SOF_INTEL_IPC4:\n\t{\n\t\tstruct sof_ipc4_copier *ipc4_copier = sdai->private;\n\t\tconst struct sof_intel_dsp_desc *chip;\n\n\t\tchip = get_chip_info(sdev->pdata);\n\n\t\tswitch (ipc4_copier->dai_type) {\n\t\tcase SOF_DAI_INTEL_HDA:\n\t\t{\n\t\t\tstruct snd_sof_widget *pipe_widget = swidget->spipe->pipe_widget;\n\t\t\tstruct sof_ipc4_pipeline *pipeline = pipe_widget->private;\n\n\t\t\tif (pipeline->use_chain_dma)\n\t\t\t\treturn &hda_ipc4_chain_dma_ops;\n\n\t\t\treturn &hda_ipc4_dma_ops;\n\t\t}\n\t\tcase SOF_DAI_INTEL_SSP:\n\t\t\tif (chip->hw_ip_version < SOF_INTEL_ACE_2_0)\n\t\t\t\treturn NULL;\n\t\t\treturn &ssp_ipc4_dma_ops;\n\t\tcase SOF_DAI_INTEL_DMIC:\n\t\t\tif (chip->hw_ip_version < SOF_INTEL_ACE_2_0)\n\t\t\t\treturn NULL;\n\t\t\treturn &dmic_ipc4_dma_ops;\n\t\tcase SOF_DAI_INTEL_ALH:\n\t\t\tif (chip->hw_ip_version < SOF_INTEL_ACE_2_0)\n\t\t\t\treturn NULL;\n\t\t\treturn &sdw_ipc4_dma_ops;\n\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\tdefault:\n\t\tbreak;\n\t}\n#endif\n\treturn NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}