{
  "module_name": "hda-probes.c",
  "hash_id": "712c1935e8abdf2568a9b8d891a84dade56f6cbe391ee26342a15a645aa3a9ca",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/intel/hda-probes.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <sound/hdaudio_ext.h>\n#include <sound/soc.h>\n#include \"../sof-priv.h\"\n#include \"../sof-client-probes.h\"\n#include \"../sof-client.h\"\n#include \"hda.h\"\n\nstatic inline struct hdac_ext_stream *\nhda_compr_get_stream(struct snd_compr_stream *cstream)\n{\n\treturn cstream->runtime->private_data;\n}\n\nstatic int hda_probes_compr_startup(struct sof_client_dev *cdev,\n\t\t\t\t    struct snd_compr_stream *cstream,\n\t\t\t\t    struct snd_soc_dai *dai, u32 *stream_id)\n{\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\tstruct hdac_ext_stream *hext_stream;\n\n\thext_stream = hda_dsp_stream_get(sdev, cstream->direction, 0);\n\tif (!hext_stream)\n\t\treturn -EBUSY;\n\n\thdac_stream(hext_stream)->curr_pos = 0;\n\thdac_stream(hext_stream)->cstream = cstream;\n\tcstream->runtime->private_data = hext_stream;\n\n\t*stream_id = hdac_stream(hext_stream)->stream_tag;\n\n\treturn 0;\n}\n\nstatic int hda_probes_compr_shutdown(struct sof_client_dev *cdev,\n\t\t\t\t     struct snd_compr_stream *cstream,\n\t\t\t\t     struct snd_soc_dai *dai)\n{\n\tstruct hdac_ext_stream *hext_stream = hda_compr_get_stream(cstream);\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\tint ret;\n\n\tret = hda_dsp_stream_put(sdev, cstream->direction,\n\t\t\t\t hdac_stream(hext_stream)->stream_tag);\n\tif (ret < 0) {\n\t\tdev_dbg(sdev->dev, \"stream put failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\thdac_stream(hext_stream)->cstream = NULL;\n\tcstream->runtime->private_data = NULL;\n\n\treturn 0;\n}\n\nstatic int hda_probes_compr_set_params(struct sof_client_dev *cdev,\n\t\t\t\t       struct snd_compr_stream *cstream,\n\t\t\t\t       struct snd_compr_params *params,\n\t\t\t\t       struct snd_soc_dai *dai)\n{\n\tstruct hdac_ext_stream *hext_stream = hda_compr_get_stream(cstream);\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\tstruct hdac_stream *hstream = hdac_stream(hext_stream);\n\tstruct snd_dma_buffer *dmab;\n\tu32 bits, rate;\n\tint bps, ret;\n\n\tdmab = cstream->runtime->dma_buffer_p;\n\t \n\tbps = snd_pcm_format_physical_width(SNDRV_PCM_FORMAT_S32_LE);\n\tif (bps < 0)\n\t\treturn bps;\n\tbits = hda_dsp_get_bits(sdev, bps);\n\trate = hda_dsp_get_mult_div(sdev, params->codec.sample_rate);\n\n\thstream->format_val = rate | bits | (params->codec.ch_out - 1);\n\thstream->bufsize = cstream->runtime->buffer_size;\n\thstream->period_bytes = cstream->runtime->fragment_size;\n\thstream->no_period_wakeup = 0;\n\n\tret = hda_dsp_stream_hw_params(sdev, hext_stream, dmab, NULL);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"error: hdac prepare failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int hda_probes_compr_trigger(struct sof_client_dev *cdev,\n\t\t\t\t    struct snd_compr_stream *cstream,\n\t\t\t\t    int cmd, struct snd_soc_dai *dai)\n{\n\tstruct hdac_ext_stream *hext_stream = hda_compr_get_stream(cstream);\n\tstruct snd_sof_dev *sdev = sof_client_dev_to_sof_dev(cdev);\n\n\treturn hda_dsp_stream_trigger(sdev, hext_stream, cmd);\n}\n\nstatic int hda_probes_compr_pointer(struct sof_client_dev *cdev,\n\t\t\t\t    struct snd_compr_stream *cstream,\n\t\t\t\t    struct snd_compr_tstamp *tstamp,\n\t\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct hdac_ext_stream *hext_stream = hda_compr_get_stream(cstream);\n\tstruct snd_soc_pcm_stream *pstream;\n\n\tpstream = &dai->driver->capture;\n\ttstamp->copied_total = hdac_stream(hext_stream)->curr_pos;\n\ttstamp->sampling_rate = snd_pcm_rate_bit_to_rate(pstream->rates);\n\n\treturn 0;\n}\n\n \nstatic const struct sof_probes_host_ops hda_probes_ops = {\n\t.startup = hda_probes_compr_startup,\n\t.shutdown = hda_probes_compr_shutdown,\n\t.set_params = hda_probes_compr_set_params,\n\t.trigger = hda_probes_compr_trigger,\n\t.pointer = hda_probes_compr_pointer,\n};\n\nint hda_probes_register(struct snd_sof_dev *sdev)\n{\n\treturn sof_client_dev_register(sdev, \"hda-probes\", 0, &hda_probes_ops,\n\t\t\t\t       sizeof(hda_probes_ops));\n}\n\nvoid hda_probes_unregister(struct snd_sof_dev *sdev)\n{\n\tsof_client_dev_unregister(sdev, \"hda-probes\", 0);\n}\n\nMODULE_IMPORT_NS(SND_SOC_SOF_CLIENT);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}