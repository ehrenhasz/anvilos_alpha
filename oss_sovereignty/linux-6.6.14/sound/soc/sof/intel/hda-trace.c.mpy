{
  "module_name": "hda-trace.c",
  "hash_id": "73a8005703c17df9715cb3ba57a2121040cfe8b42ead1988aafffed261699dc5",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/intel/hda-trace.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n#include <sound/hdaudio_ext.h>\n#include \"../ops.h\"\n#include \"hda.h\"\n\nstatic int hda_dsp_trace_prepare(struct snd_sof_dev *sdev, struct snd_dma_buffer *dmab)\n{\n\tstruct sof_intel_hda_dev *hda = sdev->pdata->hw_pdata;\n\tstruct hdac_ext_stream *hext_stream = hda->dtrace_stream;\n\tstruct hdac_stream *hstream = &hext_stream->hstream;\n\tint ret;\n\n\thstream->period_bytes = 0; \n\thstream->bufsize = dmab->bytes;\n\n\tret = hda_dsp_stream_hw_params(sdev, hext_stream, dmab, NULL);\n\tif (ret < 0)\n\t\tdev_err(sdev->dev, \"error: hdac prepare failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\nint hda_dsp_trace_init(struct snd_sof_dev *sdev, struct snd_dma_buffer *dmab,\n\t\t       struct sof_ipc_dma_trace_params_ext *dtrace_params)\n{\n\tstruct sof_intel_hda_dev *hda = sdev->pdata->hw_pdata;\n\tint ret;\n\n\thda->dtrace_stream = hda_dsp_stream_get(sdev, SNDRV_PCM_STREAM_CAPTURE,\n\t\t\t\t\t\tSOF_HDA_STREAM_DMI_L1_COMPATIBLE);\n\n\tif (!hda->dtrace_stream) {\n\t\tdev_err(sdev->dev,\n\t\t\t\"error: no available capture stream for DMA trace\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tdtrace_params->stream_tag = hda->dtrace_stream->hstream.stream_tag;\n\n\t \n\tret = hda_dsp_trace_prepare(sdev, dmab);\n\tif (ret < 0) {\n\t\tdev_err(sdev->dev, \"error: hdac trace init failed: %d\\n\", ret);\n\t\thda_dsp_stream_put(sdev, SNDRV_PCM_STREAM_CAPTURE,\n\t\t\t\t   dtrace_params->stream_tag);\n\t\thda->dtrace_stream = NULL;\n\t\tdtrace_params->stream_tag = 0;\n\t}\n\n\treturn ret;\n}\n\nint hda_dsp_trace_release(struct snd_sof_dev *sdev)\n{\n\tstruct sof_intel_hda_dev *hda = sdev->pdata->hw_pdata;\n\tstruct hdac_stream *hstream;\n\n\tif (hda->dtrace_stream) {\n\t\thstream = &hda->dtrace_stream->hstream;\n\t\thda_dsp_stream_put(sdev,\n\t\t\t\t   SNDRV_PCM_STREAM_CAPTURE,\n\t\t\t\t   hstream->stream_tag);\n\t\thda->dtrace_stream = NULL;\n\t\treturn 0;\n\t}\n\n\tdev_dbg(sdev->dev, \"DMA trace stream is not opened!\\n\");\n\treturn -ENODEV;\n}\n\nint hda_dsp_trace_trigger(struct snd_sof_dev *sdev, int cmd)\n{\n\tstruct sof_intel_hda_dev *hda = sdev->pdata->hw_pdata;\n\n\treturn hda_dsp_stream_trigger(sdev, hda->dtrace_stream, cmd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}