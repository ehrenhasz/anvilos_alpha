{
  "module_name": "cnl.c",
  "hash_id": "19168644c3d9c43013a7abe84b710a690a62ef5b84b7ea4fdd1d15557c1ef662",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/intel/cnl.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n#include <sound/sof/ext_manifest4.h>\n#include <sound/sof/ipc4/header.h>\n#include <trace/events/sof_intel.h>\n#include \"../ipc4-priv.h\"\n#include \"../ops.h\"\n#include \"hda.h\"\n#include \"hda-ipc.h\"\n#include \"../sof-audio.h\"\n\nstatic const struct snd_sof_debugfs_map cnl_dsp_debugfs[] = {\n\t{\"hda\", HDA_DSP_HDA_BAR, 0, 0x4000, SOF_DEBUGFS_ACCESS_ALWAYS},\n\t{\"pp\", HDA_DSP_PP_BAR,  0, 0x1000, SOF_DEBUGFS_ACCESS_ALWAYS},\n\t{\"dsp\", HDA_DSP_BAR,  0, 0x10000, SOF_DEBUGFS_ACCESS_ALWAYS},\n};\n\nstatic void cnl_ipc_host_done(struct snd_sof_dev *sdev);\nstatic void cnl_ipc_dsp_done(struct snd_sof_dev *sdev);\n\nirqreturn_t cnl_ipc4_irq_thread(int irq, void *context)\n{\n\tstruct sof_ipc4_msg notification_data = {{ 0 }};\n\tstruct snd_sof_dev *sdev = context;\n\tbool ack_received = false;\n\tbool ipc_irq = false;\n\tu32 hipcida, hipctdr;\n\n\thipcida = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDA);\n\thipctdr = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDR);\n\tif (hipcida & CNL_DSP_REG_HIPCIDA_DONE) {\n\t\t \n\t\tsnd_sof_dsp_update_bits(sdev, HDA_DSP_BAR,\n\t\t\t\t\tCNL_DSP_REG_HIPCCTL,\n\t\t\t\t\tCNL_DSP_REG_HIPCCTL_DONE, 0);\n\t\tcnl_ipc_dsp_done(sdev);\n\n\t\tipc_irq = true;\n\t\tack_received = true;\n\t}\n\n\tif (hipctdr & CNL_DSP_REG_HIPCTDR_BUSY) {\n\t\t \n\t\tu32 hipctdd = snd_sof_dsp_read(sdev, HDA_DSP_BAR,\n\t\t\t\t\t       CNL_DSP_REG_HIPCTDD);\n\t\tu32 primary = hipctdr & CNL_DSP_REG_HIPCTDR_MSG_MASK;\n\t\tu32 extension = hipctdd & CNL_DSP_REG_HIPCTDD_MSG_MASK;\n\n\t\tif (primary & SOF_IPC4_MSG_DIR_MASK) {\n\t\t\t \n\t\t\tif (likely(sdev->fw_state == SOF_FW_BOOT_COMPLETE)) {\n\t\t\t\tstruct sof_ipc4_msg *data = sdev->ipc->msg.reply_data;\n\n\t\t\t\tdata->primary = primary;\n\t\t\t\tdata->extension = extension;\n\n\t\t\t\tspin_lock_irq(&sdev->ipc_lock);\n\n\t\t\t\tsnd_sof_ipc_get_reply(sdev);\n\t\t\t\tcnl_ipc_host_done(sdev);\n\t\t\t\tsnd_sof_ipc_reply(sdev, data->primary);\n\n\t\t\t\tspin_unlock_irq(&sdev->ipc_lock);\n\t\t\t} else {\n\t\t\t\tdev_dbg_ratelimited(sdev->dev,\n\t\t\t\t\t\t    \"IPC reply before FW_READY: %#x|%#x\\n\",\n\t\t\t\t\t\t    primary, extension);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tnotification_data.primary = primary;\n\t\t\tnotification_data.extension = extension;\n\n\t\t\tsdev->ipc->msg.rx_data = &notification_data;\n\t\t\tsnd_sof_ipc_msgs_rx(sdev);\n\t\t\tsdev->ipc->msg.rx_data = NULL;\n\n\t\t\t \n\t\t\tcnl_ipc_host_done(sdev);\n\t\t}\n\n\t\tipc_irq = true;\n\t}\n\n\tif (!ipc_irq)\n\t\t \n\t\tdev_dbg_ratelimited(sdev->dev, \"nothing to do in IPC IRQ thread\\n\");\n\n\tif (ack_received) {\n\t\tstruct sof_intel_hda_dev *hdev = sdev->pdata->hw_pdata;\n\n\t\tif (hdev->delayed_ipc_tx_msg)\n\t\t\tcnl_ipc4_send_msg(sdev, hdev->delayed_ipc_tx_msg);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nirqreturn_t cnl_ipc_irq_thread(int irq, void *context)\n{\n\tstruct snd_sof_dev *sdev = context;\n\tu32 hipci;\n\tu32 hipcida;\n\tu32 hipctdr;\n\tu32 hipctdd;\n\tu32 msg;\n\tu32 msg_ext;\n\tbool ipc_irq = false;\n\n\thipcida = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDA);\n\thipctdr = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDR);\n\thipctdd = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDD);\n\thipci = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDR);\n\n\t \n\tif (hipcida & CNL_DSP_REG_HIPCIDA_DONE) {\n\t\tmsg_ext = hipci & CNL_DSP_REG_HIPCIDR_MSG_MASK;\n\t\tmsg = hipcida & CNL_DSP_REG_HIPCIDA_MSG_MASK;\n\n\t\ttrace_sof_intel_ipc_firmware_response(sdev, msg, msg_ext);\n\n\t\t \n\t\tsnd_sof_dsp_update_bits(sdev, HDA_DSP_BAR,\n\t\t\t\t\tCNL_DSP_REG_HIPCCTL,\n\t\t\t\t\tCNL_DSP_REG_HIPCCTL_DONE, 0);\n\n\t\tif (likely(sdev->fw_state == SOF_FW_BOOT_COMPLETE)) {\n\t\t\tspin_lock_irq(&sdev->ipc_lock);\n\n\t\t\t \n\t\t\thda_dsp_ipc_get_reply(sdev);\n\t\t\tsnd_sof_ipc_reply(sdev, msg);\n\n\t\t\tcnl_ipc_dsp_done(sdev);\n\n\t\t\tspin_unlock_irq(&sdev->ipc_lock);\n\t\t} else {\n\t\t\tdev_dbg_ratelimited(sdev->dev, \"IPC reply before FW_READY: %#x\\n\",\n\t\t\t\t\t    msg);\n\t\t}\n\n\t\tipc_irq = true;\n\t}\n\n\t \n\tif (hipctdr & CNL_DSP_REG_HIPCTDR_BUSY) {\n\t\tmsg = hipctdr & CNL_DSP_REG_HIPCTDR_MSG_MASK;\n\t\tmsg_ext = hipctdd & CNL_DSP_REG_HIPCTDD_MSG_MASK;\n\n\t\ttrace_sof_intel_ipc_firmware_initiated(sdev, msg, msg_ext);\n\n\t\t \n\t\tif ((hipctdr & SOF_IPC_PANIC_MAGIC_MASK) == SOF_IPC_PANIC_MAGIC) {\n\t\t\tstruct sof_intel_hda_dev *hda = sdev->pdata->hw_pdata;\n\t\t\tbool non_recoverable = true;\n\n\t\t\t \n\t\t\tif (sdev->fw_state == SOF_FW_BOOT_IN_PROGRESS &&\n\t\t\t    hda->boot_iteration < HDA_FW_BOOT_ATTEMPTS)\n\t\t\t\tnon_recoverable = false;\n\n\t\t\tsnd_sof_dsp_panic(sdev, HDA_DSP_PANIC_OFFSET(msg_ext),\n\t\t\t\t\t  non_recoverable);\n\t\t} else {\n\t\t\tsnd_sof_ipc_msgs_rx(sdev);\n\t\t}\n\n\t\tcnl_ipc_host_done(sdev);\n\n\t\tipc_irq = true;\n\t}\n\n\tif (!ipc_irq) {\n\t\t \n\t\tdev_dbg_ratelimited(sdev->dev,\n\t\t\t\t    \"nothing to do in IPC IRQ thread\\n\");\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void cnl_ipc_host_done(struct snd_sof_dev *sdev)\n{\n\t \n\tsnd_sof_dsp_update_bits_forced(sdev, HDA_DSP_BAR,\n\t\t\t\t       CNL_DSP_REG_HIPCTDR,\n\t\t\t\t       CNL_DSP_REG_HIPCTDR_BUSY,\n\t\t\t\t       CNL_DSP_REG_HIPCTDR_BUSY);\n\t \n\tsnd_sof_dsp_update_bits_forced(sdev, HDA_DSP_BAR,\n\t\t\t\t       CNL_DSP_REG_HIPCTDA,\n\t\t\t\t       CNL_DSP_REG_HIPCTDA_DONE,\n\t\t\t\t       CNL_DSP_REG_HIPCTDA_DONE);\n}\n\nstatic void cnl_ipc_dsp_done(struct snd_sof_dev *sdev)\n{\n\t \n\tsnd_sof_dsp_update_bits_forced(sdev, HDA_DSP_BAR,\n\t\t\t\t       CNL_DSP_REG_HIPCIDA,\n\t\t\t\t       CNL_DSP_REG_HIPCIDA_DONE,\n\t\t\t\t       CNL_DSP_REG_HIPCIDA_DONE);\n\n\t \n\tsnd_sof_dsp_update_bits(sdev, HDA_DSP_BAR,\n\t\t\t\tCNL_DSP_REG_HIPCCTL,\n\t\t\t\tCNL_DSP_REG_HIPCCTL_DONE,\n\t\t\t\tCNL_DSP_REG_HIPCCTL_DONE);\n}\n\nstatic bool cnl_compact_ipc_compress(struct snd_sof_ipc_msg *msg,\n\t\t\t\t     u32 *dr, u32 *dd)\n{\n\tstruct sof_ipc_pm_gate *pm_gate = msg->msg_data;\n\n\tif (pm_gate->hdr.cmd == (SOF_IPC_GLB_PM_MSG | SOF_IPC_PM_GATE)) {\n\t\t \n\t\t*dr = HDA_IPC_MSG_COMPACT | HDA_IPC_PM_GATE;\n\n\t\t \n\t\t*dd = pm_gate->flags;\n\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nint cnl_ipc4_send_msg(struct snd_sof_dev *sdev, struct snd_sof_ipc_msg *msg)\n{\n\tstruct sof_intel_hda_dev *hdev = sdev->pdata->hw_pdata;\n\tstruct sof_ipc4_msg *msg_data = msg->msg_data;\n\n\tif (hda_ipc4_tx_is_busy(sdev)) {\n\t\thdev->delayed_ipc_tx_msg = msg;\n\t\treturn 0;\n\t}\n\n\thdev->delayed_ipc_tx_msg = NULL;\n\n\t \n\tif (msg_data->data_size)\n\t\tsof_mailbox_write(sdev, sdev->host_box.offset, msg_data->data_ptr,\n\t\t\t\t  msg_data->data_size);\n\n\tsnd_sof_dsp_write(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDD, msg_data->extension);\n\tsnd_sof_dsp_write(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDR,\n\t\t\t  msg_data->primary | CNL_DSP_REG_HIPCIDR_BUSY);\n\n\thda_dsp_ipc4_schedule_d0i3_work(hdev, msg);\n\n\treturn 0;\n}\n\nint cnl_ipc_send_msg(struct snd_sof_dev *sdev, struct snd_sof_ipc_msg *msg)\n{\n\tstruct sof_intel_hda_dev *hdev = sdev->pdata->hw_pdata;\n\tstruct sof_ipc_cmd_hdr *hdr;\n\tu32 dr = 0;\n\tu32 dd = 0;\n\n\t \n\tif (cnl_compact_ipc_compress(msg, &dr, &dd)) {\n\t\t \n\t\tsnd_sof_dsp_write(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDD,\n\t\t\t\t  dd);\n\t\tsnd_sof_dsp_write(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDR,\n\t\t\t\t  CNL_DSP_REG_HIPCIDR_BUSY | dr);\n\t\treturn 0;\n\t}\n\n\t \n\tsof_mailbox_write(sdev, sdev->host_box.offset, msg->msg_data,\n\t\t\t  msg->msg_size);\n\tsnd_sof_dsp_write(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDR,\n\t\t\t  CNL_DSP_REG_HIPCIDR_BUSY);\n\n\thdr = msg->msg_data;\n\n\t \n\tif (hdr->cmd != (SOF_IPC_GLB_PM_MSG | SOF_IPC_PM_CTX_SAVE))\n\t\tmod_delayed_work(system_wq, &hdev->d0i3_work,\n\t\t\t\t msecs_to_jiffies(SOF_HDA_D0I3_WORK_DELAY_MS));\n\n\treturn 0;\n}\n\nvoid cnl_ipc_dump(struct snd_sof_dev *sdev)\n{\n\tu32 hipcctl;\n\tu32 hipcida;\n\tu32 hipctdr;\n\n\thda_ipc_irq_dump(sdev);\n\n\t \n\thipcida = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDA);\n\thipcctl = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCCTL);\n\thipctdr = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDR);\n\n\t \n\t \n\tdev_err(sdev->dev,\n\t\t\"error: host status 0x%8.8x dsp status 0x%8.8x mask 0x%8.8x\\n\",\n\t\thipcida, hipctdr, hipcctl);\n}\n\nvoid cnl_ipc4_dump(struct snd_sof_dev *sdev)\n{\n\tu32 hipcidr, hipcidd, hipcida, hipctdr, hipctdd, hipctda, hipcctl;\n\n\thda_ipc_irq_dump(sdev);\n\n\thipcidr = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDR);\n\thipcidd = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDD);\n\thipcida = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCIDA);\n\thipctdr = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDR);\n\thipctdd = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDD);\n\thipctda = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCTDA);\n\thipcctl = snd_sof_dsp_read(sdev, HDA_DSP_BAR, CNL_DSP_REG_HIPCCTL);\n\n\t \n\t \n\tdev_err(sdev->dev,\n\t\t\"Host IPC initiator: %#x|%#x|%#x, target: %#x|%#x|%#x, ctl: %#x\\n\",\n\t\thipcidr, hipcidd, hipcida, hipctdr, hipctdd, hipctda, hipcctl);\n}\n\n \nstruct snd_sof_dsp_ops sof_cnl_ops;\nEXPORT_SYMBOL_NS(sof_cnl_ops, SND_SOC_SOF_INTEL_HDA_COMMON);\n\nint sof_cnl_ops_init(struct snd_sof_dev *sdev)\n{\n\t \n\tmemcpy(&sof_cnl_ops, &sof_hda_common_ops, sizeof(struct snd_sof_dsp_ops));\n\n\t \n\tsof_cnl_ops.shutdown\t= hda_dsp_shutdown;\n\n\t \n\tif (sdev->pdata->ipc_type == SOF_IPC) {\n\t\t \n\t\tsof_cnl_ops.irq_thread\t= cnl_ipc_irq_thread;\n\n\t\t \n\t\tsof_cnl_ops.send_msg\t= cnl_ipc_send_msg;\n\n\t\t \n\t\tsof_cnl_ops.ipc_dump\t= cnl_ipc_dump;\n\n\t\tsof_cnl_ops.set_power_state = hda_dsp_set_power_state_ipc3;\n\t}\n\n\tif (sdev->pdata->ipc_type == SOF_INTEL_IPC4) {\n\t\tstruct sof_ipc4_fw_data *ipc4_data;\n\n\t\tsdev->private = devm_kzalloc(sdev->dev, sizeof(*ipc4_data), GFP_KERNEL);\n\t\tif (!sdev->private)\n\t\t\treturn -ENOMEM;\n\n\t\tipc4_data = sdev->private;\n\t\tipc4_data->manifest_fw_hdr_offset = SOF_MAN4_FW_HDR_OFFSET;\n\n\t\tipc4_data->mtrace_type = SOF_IPC4_MTRACE_INTEL_CAVS_1_8;\n\n\t\t \n\t\tipc4_data->load_library = hda_dsp_ipc4_load_library;\n\n\t\t \n\t\tsof_cnl_ops.irq_thread\t= cnl_ipc4_irq_thread;\n\n\t\t \n\t\tsof_cnl_ops.send_msg\t= cnl_ipc4_send_msg;\n\n\t\t \n\t\tsof_cnl_ops.ipc_dump\t= cnl_ipc4_dump;\n\n\t\tsof_cnl_ops.set_power_state = hda_dsp_set_power_state_ipc4;\n\t}\n\n\t \n\thda_set_dai_drv_ops(sdev, &sof_cnl_ops);\n\n\t \n\tsof_cnl_ops.debug_map\t= cnl_dsp_debugfs;\n\tsof_cnl_ops.debug_map_count\t= ARRAY_SIZE(cnl_dsp_debugfs);\n\n\t \n\tsof_cnl_ops.post_fw_run = hda_dsp_post_fw_run;\n\n\t \n\tsof_cnl_ops.run = hda_dsp_cl_boot_firmware;\n\n\t \n\tsof_cnl_ops.core_get = hda_dsp_core_get;\n\n\treturn 0;\n};\nEXPORT_SYMBOL_NS(sof_cnl_ops_init, SND_SOC_SOF_INTEL_HDA_COMMON);\n\nconst struct sof_intel_dsp_desc cnl_chip_info = {\n\t \n\t.cores_num = 4,\n\t.init_core_mask = 1,\n\t.host_managed_cores_mask = GENMASK(3, 0),\n\t.ipc_req = CNL_DSP_REG_HIPCIDR,\n\t.ipc_req_mask = CNL_DSP_REG_HIPCIDR_BUSY,\n\t.ipc_ack = CNL_DSP_REG_HIPCIDA,\n\t.ipc_ack_mask = CNL_DSP_REG_HIPCIDA_DONE,\n\t.ipc_ctl = CNL_DSP_REG_HIPCCTL,\n\t.rom_status_reg = HDA_DSP_SRAM_REG_ROM_STATUS,\n\t.rom_init_timeout\t= 300,\n\t.ssp_count = CNL_SSP_COUNT,\n\t.ssp_base_offset = CNL_SSP_BASE_OFFSET,\n\t.sdw_shim_base = SDW_SHIM_BASE,\n\t.sdw_alh_base = SDW_ALH_BASE,\n\t.d0i3_offset = SOF_HDA_VS_D0I3C,\n\t.read_sdw_lcount =  hda_sdw_check_lcount_common,\n\t.enable_sdw_irq\t= hda_common_enable_sdw_irq,\n\t.check_sdw_irq\t= hda_common_check_sdw_irq,\n\t.check_sdw_wakeen_irq = hda_sdw_check_wakeen_irq_common,\n\t.check_ipc_irq\t= hda_dsp_check_ipc_irq,\n\t.cl_init = cl_dsp_init,\n\t.power_down_dsp = hda_power_down_dsp,\n\t.disable_interrupts = hda_dsp_disable_interrupts,\n\t.hw_ip_version = SOF_INTEL_CAVS_1_8,\n};\nEXPORT_SYMBOL_NS(cnl_chip_info, SND_SOC_SOF_INTEL_HDA_COMMON);\n\n \nconst struct sof_intel_dsp_desc jsl_chip_info = {\n\t \n\t.cores_num = 2,\n\t.init_core_mask = 1,\n\t.host_managed_cores_mask = GENMASK(1, 0),\n\t.ipc_req = CNL_DSP_REG_HIPCIDR,\n\t.ipc_req_mask = CNL_DSP_REG_HIPCIDR_BUSY,\n\t.ipc_ack = CNL_DSP_REG_HIPCIDA,\n\t.ipc_ack_mask = CNL_DSP_REG_HIPCIDA_DONE,\n\t.ipc_ctl = CNL_DSP_REG_HIPCCTL,\n\t.rom_status_reg = HDA_DSP_SRAM_REG_ROM_STATUS,\n\t.rom_init_timeout\t= 300,\n\t.ssp_count = ICL_SSP_COUNT,\n\t.ssp_base_offset = CNL_SSP_BASE_OFFSET,\n\t.sdw_shim_base = SDW_SHIM_BASE,\n\t.sdw_alh_base = SDW_ALH_BASE,\n\t.d0i3_offset = SOF_HDA_VS_D0I3C,\n\t.read_sdw_lcount =  hda_sdw_check_lcount_common,\n\t.enable_sdw_irq\t= hda_common_enable_sdw_irq,\n\t.check_sdw_irq\t= hda_common_check_sdw_irq,\n\t.check_sdw_wakeen_irq = hda_sdw_check_wakeen_irq_common,\n\t.check_ipc_irq\t= hda_dsp_check_ipc_irq,\n\t.cl_init = cl_dsp_init,\n\t.power_down_dsp = hda_power_down_dsp,\n\t.disable_interrupts = hda_dsp_disable_interrupts,\n\t.hw_ip_version = SOF_INTEL_CAVS_2_0,\n};\nEXPORT_SYMBOL_NS(jsl_chip_info, SND_SOC_SOF_INTEL_HDA_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}