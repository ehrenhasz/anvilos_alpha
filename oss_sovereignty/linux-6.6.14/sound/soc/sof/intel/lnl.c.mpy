{
  "module_name": "lnl.c",
  "hash_id": "213307bed92d44c0daccab3c0c95c2999c8488da442d4f08acbdb9a0725137a1",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sof/intel/lnl.c",
  "human_readable_source": "\n\n\n\n \n\n#include <linux/firmware.h>\n#include <sound/hda_register.h>\n#include <sound/sof/ipc4/header.h>\n#include <trace/events/sof_intel.h>\n#include \"../ipc4-priv.h\"\n#include \"../ops.h\"\n#include \"hda.h\"\n#include \"hda-ipc.h\"\n#include \"../sof-audio.h\"\n#include \"mtl.h\"\n#include <sound/hda-mlink.h>\n\n \nstruct snd_sof_dsp_ops sof_lnl_ops;\nEXPORT_SYMBOL_NS(sof_lnl_ops, SND_SOC_SOF_INTEL_HDA_COMMON);\n\nstatic const struct snd_sof_debugfs_map lnl_dsp_debugfs[] = {\n\t{\"hda\", HDA_DSP_HDA_BAR, 0, 0x4000, SOF_DEBUGFS_ACCESS_ALWAYS},\n\t{\"pp\", HDA_DSP_PP_BAR,  0, 0x1000, SOF_DEBUGFS_ACCESS_ALWAYS},\n\t{\"dsp\", HDA_DSP_BAR,  0, 0x10000, SOF_DEBUGFS_ACCESS_ALWAYS},\n};\n\n \nstatic int hdac_bus_offload_dmic_ssp(struct hdac_bus *bus)\n{\n\tint ret;\n\n\tret = hdac_bus_eml_enable_offload(bus, true,  AZX_REG_ML_LEPTR_ID_INTEL_SSP, true);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hdac_bus_eml_enable_offload(bus, true,  AZX_REG_ML_LEPTR_ID_INTEL_DMIC, true);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int lnl_hda_dsp_probe(struct snd_sof_dev *sdev)\n{\n\tint ret;\n\n\tret = hda_dsp_probe(sdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn hdac_bus_offload_dmic_ssp(sof_to_bus(sdev));\n}\n\nstatic int lnl_hda_dsp_resume(struct snd_sof_dev *sdev)\n{\n\tint ret;\n\n\tret = hda_dsp_resume(sdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn hdac_bus_offload_dmic_ssp(sof_to_bus(sdev));\n}\n\nstatic int lnl_hda_dsp_runtime_resume(struct snd_sof_dev *sdev)\n{\n\tint ret;\n\n\tret = hda_dsp_runtime_resume(sdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn hdac_bus_offload_dmic_ssp(sof_to_bus(sdev));\n}\n\nint sof_lnl_ops_init(struct snd_sof_dev *sdev)\n{\n\tstruct sof_ipc4_fw_data *ipc4_data;\n\n\t \n\tmemcpy(&sof_lnl_ops, &sof_hda_common_ops, sizeof(struct snd_sof_dsp_ops));\n\n\t \n\tsof_lnl_ops.probe = lnl_hda_dsp_probe;\n\n\t \n\tsof_lnl_ops.shutdown = hda_dsp_shutdown;\n\n\t \n\tsof_lnl_ops.irq_thread = mtl_ipc_irq_thread;\n\n\t \n\tsof_lnl_ops.send_msg = mtl_ipc_send_msg;\n\tsof_lnl_ops.get_mailbox_offset = mtl_dsp_ipc_get_mailbox_offset;\n\tsof_lnl_ops.get_window_offset = mtl_dsp_ipc_get_window_offset;\n\n\t \n\tsof_lnl_ops.debug_map = lnl_dsp_debugfs;\n\tsof_lnl_ops.debug_map_count = ARRAY_SIZE(lnl_dsp_debugfs);\n\tsof_lnl_ops.dbg_dump = mtl_dsp_dump;\n\tsof_lnl_ops.ipc_dump = mtl_ipc_dump;\n\n\t \n\tsof_lnl_ops.pre_fw_run = mtl_dsp_pre_fw_run;\n\tsof_lnl_ops.post_fw_run = mtl_dsp_post_fw_run;\n\n\t \n\tsof_lnl_ops.parse_platform_ext_manifest = NULL;\n\n\t \n\t \n\n\t \n\tsof_lnl_ops.resume\t\t\t= lnl_hda_dsp_resume;\n\tsof_lnl_ops.runtime_resume\t\t= lnl_hda_dsp_runtime_resume;\n\n\tsof_lnl_ops.get_stream_position = mtl_dsp_get_stream_hda_link_position;\n\n\tsdev->private = devm_kzalloc(sdev->dev, sizeof(struct sof_ipc4_fw_data), GFP_KERNEL);\n\tif (!sdev->private)\n\t\treturn -ENOMEM;\n\n\tipc4_data = sdev->private;\n\tipc4_data->manifest_fw_hdr_offset = SOF_MAN4_FW_HDR_OFFSET;\n\n\tipc4_data->mtrace_type = SOF_IPC4_MTRACE_INTEL_CAVS_2;\n\n\t \n\tipc4_data->load_library = hda_dsp_ipc4_load_library;\n\n\t \n\thda_set_dai_drv_ops(sdev, &sof_lnl_ops);\n\n\tsof_lnl_ops.set_power_state = hda_dsp_set_power_state_ipc4;\n\n\treturn 0;\n};\nEXPORT_SYMBOL_NS(sof_lnl_ops_init, SND_SOC_SOF_INTEL_HDA_COMMON);\n\n \nstatic bool lnl_dsp_check_sdw_irq(struct snd_sof_dev *sdev)\n{\n\tstruct hdac_bus *bus = sof_to_bus(sdev);\n\n\treturn hdac_bus_eml_check_interrupt(bus, true,  AZX_REG_ML_LEPTR_ID_SDW);\n}\n\nstatic void lnl_enable_sdw_irq(struct snd_sof_dev *sdev, bool enable)\n{\n\tstruct hdac_bus *bus = sof_to_bus(sdev);\n\n\thdac_bus_eml_enable_interrupt(bus, true,  AZX_REG_ML_LEPTR_ID_SDW, enable);\n}\n\nstatic int lnl_dsp_disable_interrupts(struct snd_sof_dev *sdev)\n{\n\tlnl_enable_sdw_irq(sdev, false);\n\tmtl_disable_ipc_interrupts(sdev);\n\treturn mtl_enable_interrupts(sdev, false);\n}\n\nconst struct sof_intel_dsp_desc lnl_chip_info = {\n\t.cores_num = 5,\n\t.init_core_mask = BIT(0),\n\t.host_managed_cores_mask = BIT(0),\n\t.ipc_req = MTL_DSP_REG_HFIPCXIDR,\n\t.ipc_req_mask = MTL_DSP_REG_HFIPCXIDR_BUSY,\n\t.ipc_ack = MTL_DSP_REG_HFIPCXIDA,\n\t.ipc_ack_mask = MTL_DSP_REG_HFIPCXIDA_DONE,\n\t.ipc_ctl = MTL_DSP_REG_HFIPCXCTL,\n\t.rom_status_reg = MTL_DSP_ROM_STS,\n\t.rom_init_timeout = 300,\n\t.ssp_count = MTL_SSP_COUNT,\n\t.d0i3_offset = MTL_HDA_VS_D0I3C,\n\t.read_sdw_lcount =  hda_sdw_check_lcount_ext,\n\t.enable_sdw_irq = lnl_enable_sdw_irq,\n\t.check_sdw_irq = lnl_dsp_check_sdw_irq,\n\t.check_ipc_irq = mtl_dsp_check_ipc_irq,\n\t.cl_init = mtl_dsp_cl_init,\n\t.power_down_dsp = mtl_power_down_dsp,\n\t.disable_interrupts = lnl_dsp_disable_interrupts,\n\t.hw_ip_version = SOF_INTEL_ACE_2_0,\n};\nEXPORT_SYMBOL_NS(lnl_chip_info, SND_SOC_SOF_INTEL_HDA_COMMON);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}