{
  "module_name": "migor.c",
  "hash_id": "92af633bc17224634023925344e9113715442a8036bf8a8f2cdce22586b84f46",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sh/migor.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/clkdev.h>\n#include <linux/device.h>\n#include <linux/firmware.h>\n#include <linux/module.h>\n\n#include <asm/clock.h>\n\n#include <cpu/sh7722.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n\n#include \"../codecs/wm8978.h\"\n#include \"siu.h\"\n\n \nstatic unsigned long codec_freq = 8000 * 512;\n\nstatic unsigned int use_count;\n\n \nstatic unsigned long siumckb_recalc(struct clk *clk)\n{\n\treturn codec_freq;\n}\n\nstatic struct sh_clk_ops siumckb_clk_ops = {\n\t.recalc = siumckb_recalc,\n};\n\nstatic struct clk siumckb_clk = {\n\t.ops\t\t= &siumckb_clk_ops,\n\t.rate\t\t= 0,  \n};\n\nstatic struct clk_lookup *siumckb_lookup;\n\nstatic int migor_hw_params(struct snd_pcm_substream *substream,\n\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint ret;\n\tunsigned int rate = params_rate(params);\n\n\tret = snd_soc_dai_set_sysclk(codec_dai, WM8978_PLL, 13000000,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = snd_soc_dai_set_clkdiv(codec_dai, WM8978_OPCLKRATE, rate * 512);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tcodec_freq = rate * 512;\n\t \n\tclk_set_rate(&siumckb_clk, codec_freq);\n\tdev_dbg(codec_dai->dev, \"%s: configure %luHz\\n\", __func__, codec_freq);\n\n\tret = snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0), SIU_CLKB_EXT,\n\t\t\t\t     codec_freq / 2, SND_SOC_CLOCK_IN);\n\n\tif (!ret)\n\t\tuse_count++;\n\n\treturn ret;\n}\n\nstatic int migor_hw_free(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\tif (use_count) {\n\t\tuse_count--;\n\n\t\tif (!use_count)\n\t\t\tsnd_soc_dai_set_sysclk(codec_dai, WM8978_PLL, 0,\n\t\t\t\t\t       SND_SOC_CLOCK_IN);\n\t} else {\n\t\tdev_dbg(codec_dai->dev, \"Unbalanced hw_free!\\n\");\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops migor_dai_ops = {\n\t.hw_params = migor_hw_params,\n\t.hw_free = migor_hw_free,\n};\n\nstatic const struct snd_soc_dapm_widget migor_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Onboard Microphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"External Microphone\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route audio_map[] = {\n\t \n\t{ \"Headphone\", NULL,  \"OUT4 VMID\" },\n\t{ \"OUT4 VMID\", NULL,  \"LHP\" },\n\t{ \"OUT4 VMID\", NULL,  \"RHP\" },\n\n\t \n\t{ \"RMICN\", NULL, \"Mic Bias\" },\n\t{ \"RMICP\", NULL, \"Mic Bias\" },\n\t{ \"Mic Bias\", NULL, \"Onboard Microphone\" },\n\n\t \n\t{ \"LMICN\", NULL, \"Mic Bias\" },\n\t{ \"LMICP\", NULL, \"Mic Bias\" },\n\t{ \"Mic Bias\", NULL, \"External Microphone\" },\n};\n\n \nSND_SOC_DAILINK_DEFS(wm8978,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"siu-pcm-audio\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"wm8978.0-001a\", \"wm8978-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"siu-pcm-audio\")));\n\nstatic struct snd_soc_dai_link migor_dai = {\n\t.name = \"wm8978\",\n\t.stream_name = \"WM8978\",\n\t.dai_fmt = SND_SOC_DAIFMT_NB_IF | SND_SOC_DAIFMT_I2S |\n\t\t   SND_SOC_DAIFMT_CBS_CFS,\n\t.ops = &migor_dai_ops,\n\tSND_SOC_DAILINK_REG(wm8978),\n};\n\n \nstatic struct snd_soc_card snd_soc_migor = {\n\t.name = \"Migo-R\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &migor_dai,\n\t.num_links = 1,\n\n\t.dapm_widgets = migor_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(migor_dapm_widgets),\n\t.dapm_routes = audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(audio_map),\n};\n\nstatic struct platform_device *migor_snd_device;\n\nstatic int __init migor_init(void)\n{\n\tint ret;\n\n\tret = clk_register(&siumckb_clk);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tsiumckb_lookup = clkdev_create(&siumckb_clk, \"siumckb_clk\", NULL);\n\tif (!siumckb_lookup) {\n\t\tret = -ENOMEM;\n\t\tgoto eclkdevalloc;\n\t}\n\n\t \n\tmigor_snd_device = platform_device_alloc(\"soc-audio\", 1);\n\tif (!migor_snd_device) {\n\t\tret = -ENOMEM;\n\t\tgoto epdevalloc;\n\t}\n\n\tplatform_set_drvdata(migor_snd_device, &snd_soc_migor);\n\n\tret = platform_device_add(migor_snd_device);\n\tif (ret)\n\t\tgoto epdevadd;\n\n\treturn 0;\n\nepdevadd:\n\tplatform_device_put(migor_snd_device);\nepdevalloc:\n\tclkdev_drop(siumckb_lookup);\neclkdevalloc:\n\tclk_unregister(&siumckb_clk);\n\treturn ret;\n}\n\nstatic void __exit migor_exit(void)\n{\n\tclkdev_drop(siumckb_lookup);\n\tclk_unregister(&siumckb_clk);\n\tplatform_device_unregister(migor_snd_device);\n}\n\nmodule_init(migor_init);\nmodule_exit(migor_exit);\n\nMODULE_AUTHOR(\"Guennadi Liakhovetski <g.liakhovetski@gmx.de>\");\nMODULE_DESCRIPTION(\"ALSA SoC Migor\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}