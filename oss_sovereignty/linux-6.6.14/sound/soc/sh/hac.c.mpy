{
  "module_name": "hac.c",
  "hash_id": "c123dc04fe734c55620543010dcf7ff6415a1c297965e96e8caee24a3eb9b3bf",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/sh/hac.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/interrupt.h>\n#include <linux/wait.h>\n#include <linux/delay.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/ac97_codec.h>\n#include <sound/initval.h>\n#include <sound/soc.h>\n\n \n#define HACCR\t\t0x08\n#define HACCSAR\t\t0x20\n#define HACCSDR\t\t0x24\n#define HACPCML\t\t0x28\n#define HACPCMR\t\t0x2C\n#define HACTIER\t\t0x50\n#define\tHACTSR\t\t0x54\n#define HACRIER\t\t0x58\n#define HACRSR\t\t0x5C\n#define HACACR\t\t0x60\n\n#define CR_CR\t\t(1 << 15)\t \n#define CR_CDRT\t\t(1 << 11)\t \n#define CR_WMRT\t\t(1 << 10)\t \n#define CR_B9\t\t(1 << 9)\t \n#define CR_ST\t\t(1 << 5)\t \n\n#define CSAR_RD\t\t(1 << 19)\t \n#define CSAR_WR\t\t(0)\n\n#define TSR_CMDAMT\t(1 << 31)\n#define TSR_CMDDMT\t(1 << 30)\n\n#define RSR_STARY\t(1 << 22)\n#define RSR_STDRY\t(1 << 21)\n\n#define ACR_DMARX16\t(1 << 30)\n#define ACR_DMATX16\t(1 << 29)\n#define ACR_TX12ATOM\t(1 << 26)\n#define ACR_DMARX20\t((1 << 24) | (1 << 22))\n#define ACR_DMATX20\t((1 << 23) | (1 << 21))\n\n#define CSDR_SHIFT\t4\n#define CSDR_MASK\t(0xffff << CSDR_SHIFT)\n#define CSAR_SHIFT\t12\n#define CSAR_MASK\t(0x7f << CSAR_SHIFT)\n\n#define AC97_WRITE_RETRY\t1\n#define AC97_READ_RETRY\t\t5\n\n \n#define TMO_E1\t500\t \n#define TMO_E2\t13\t \n#define TMO_E3\t21\t \n#define TMO_E4\t500\t \n\nstruct hac_priv {\n\tunsigned long mmio;\t \n} hac_cpu_data[] = {\n#if defined(CONFIG_CPU_SUBTYPE_SH7760)\n\t{\n\t\t.mmio\t= 0xFE240000,\n\t},\n\t{\n\t\t.mmio\t= 0xFE250000,\n\t},\n#elif defined(CONFIG_CPU_SUBTYPE_SH7780)\n\t{\n\t\t.mmio\t= 0xFFE40000,\n\t},\n#else\n#error \"Unsupported SuperH SoC\"\n#endif\n};\n\n#define HACREG(reg)\t(*(unsigned long *)(hac->mmio + (reg)))\n\n \nstatic int hac_get_codec_data(struct hac_priv *hac, unsigned short r,\n\t\t\t      unsigned short *v)\n{\n\tunsigned int to1, to2, i;\n\tunsigned short adr;\n\n\tfor (i = AC97_READ_RETRY; i; i--) {\n\t\t*v = 0;\n\t\t \n\t\tfor (to1 = TMO_E4;\n\t\t     to1 && !(HACREG(HACRSR) & RSR_STARY);\n\t\t     --to1)\n\t\t\tudelay(1);\n\t\tfor (to2 = TMO_E4; \n\t\t     to2 && !(HACREG(HACRSR) & RSR_STDRY);\n\t\t     --to2)\n\t\t\tudelay(1);\n\n\t\tif (!to1 && !to2)\n\t\t\treturn 0;\t \n\n\t\tadr = ((HACREG(HACCSAR) & CSAR_MASK) >> CSAR_SHIFT);\n\t\t*v  = ((HACREG(HACCSDR) & CSDR_MASK) >> CSDR_SHIFT);\n\n\t\tHACREG(HACRSR) &= ~(RSR_STDRY | RSR_STARY);\n\n\t\tif (r == adr)\n\t\t\tbreak;\n\n\t\t \n\t\tudelay(21);\n\t}\n\tHACREG(HACRSR) &= ~(RSR_STDRY | RSR_STARY);\n\treturn i;\n}\n\nstatic unsigned short hac_read_codec_aux(struct hac_priv *hac,\n\t\t\t\t\t unsigned short reg)\n{\n\tunsigned short val;\n\tunsigned int i, to;\n\n\tfor (i = AC97_READ_RETRY; i; i--) {\n\t\t \n\t\tlocal_irq_disable();\n\t\tHACREG(HACTSR) &= ~(TSR_CMDAMT);\n\t\tHACREG(HACCSAR) = (reg << CSAR_SHIFT) | CSAR_RD;\n\t\tlocal_irq_enable();\n\n\t\tfor (to = TMO_E3;\n\t\t     to && !(HACREG(HACTSR) & TSR_CMDAMT);\n\t\t     --to)\n\t\t\tudelay(1);\n\n\t\tHACREG(HACTSR) &= ~TSR_CMDAMT;\n\t\tval = 0;\n\t\tif (hac_get_codec_data(hac, reg, &val) != 0)\n\t\t\tbreak;\n\t}\n\n\treturn i ? val : ~0;\n}\n\nstatic void hac_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\n\t\t\t   unsigned short val)\n{\n\tint unit_id = 0  ;\n\tstruct hac_priv *hac = &hac_cpu_data[unit_id];\n\tunsigned int i, to;\n\t \n\tfor (i = AC97_WRITE_RETRY; i; i--) {\n\t\t \n\t\tlocal_irq_disable();\n\t\tHACREG(HACTSR) &= ~(TSR_CMDDMT | TSR_CMDAMT);\n\t\tHACREG(HACCSDR) = (val << CSDR_SHIFT);\n\t\tHACREG(HACCSAR) = (reg << CSAR_SHIFT) & (~CSAR_RD);\n\t\tlocal_irq_enable();\n\n\t\t \n\t\tfor (to = TMO_E1;\n\t\t     to && !(HACREG(HACTSR) & (TSR_CMDAMT|TSR_CMDDMT));\n\t\t     --to)\n\t\t\tudelay(1);\n\n\t\tHACREG(HACTSR) &= ~(TSR_CMDAMT | TSR_CMDDMT);\n\t\tif (to)\n\t\t\tbreak;\n\t\t \n\t}\n}\n\nstatic unsigned short hac_ac97_read(struct snd_ac97 *ac97,\n\t\t\t\t    unsigned short reg)\n{\n\tint unit_id = 0  ;\n\tstruct hac_priv *hac = &hac_cpu_data[unit_id];\n\treturn hac_read_codec_aux(hac, reg);\n}\n\nstatic void hac_ac97_warmrst(struct snd_ac97 *ac97)\n{\n\tint unit_id = 0  ;\n\tstruct hac_priv *hac = &hac_cpu_data[unit_id];\n\tunsigned int tmo;\n\n\tHACREG(HACCR) = CR_WMRT | CR_ST | CR_B9;\n\tmsleep(10);\n\tHACREG(HACCR) = CR_ST | CR_B9;\n\tfor (tmo = 1000; (tmo > 0) && !(HACREG(HACCR) & CR_CR); tmo--)\n\t\tudelay(1);\n\n\tif (!tmo)\n\t\tprintk(KERN_INFO \"hac: reset: AC97 link down!\\n\");\n\t \n\tHACREG(HACACR) |= ACR_TX12ATOM;\n}\n\nstatic void hac_ac97_coldrst(struct snd_ac97 *ac97)\n{\n\tint unit_id = 0  ;\n\tstruct hac_priv *hac;\n\thac = &hac_cpu_data[unit_id];\n\n\tHACREG(HACCR) = 0;\n\tHACREG(HACCR) = CR_CDRT | CR_ST | CR_B9;\n\tmsleep(10);\n\thac_ac97_warmrst(ac97);\n}\n\nstatic struct snd_ac97_bus_ops hac_ac97_ops = {\n\t.read\t= hac_ac97_read,\n\t.write\t= hac_ac97_write,\n\t.reset\t= hac_ac97_coldrst,\n\t.warm_reset = hac_ac97_warmrst,\n};\n\nstatic int hac_hw_params(struct snd_pcm_substream *substream,\n\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t struct snd_soc_dai *dai)\n{\n\tstruct hac_priv *hac = &hac_cpu_data[dai->id];\n\tint d = substream->stream == SNDRV_PCM_STREAM_PLAYBACK ? 0 : 1;\n\n\tswitch (params->msbits) {\n\tcase 16:\n\t\tHACREG(HACACR) |= d ?  ACR_DMARX16 :  ACR_DMATX16;\n\t\tHACREG(HACACR) &= d ? ~ACR_DMARX20 : ~ACR_DMATX20;\n\t\tbreak;\n\tcase 20:\n\t\tHACREG(HACACR) &= d ? ~ACR_DMARX16 : ~ACR_DMATX16;\n\t\tHACREG(HACACR) |= d ?  ACR_DMARX20 :  ACR_DMATX20;\n\t\tbreak;\n\tdefault:\n\t\tpr_debug(\"hac: invalid depth %d bit\\n\", params->msbits);\n\t\treturn -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n#define AC97_RATES\t\\\n\tSNDRV_PCM_RATE_8000_192000\n\n#define AC97_FMTS\t\\\n\tSNDRV_PCM_FMTBIT_S16_LE\n\nstatic const struct snd_soc_dai_ops hac_dai_ops = {\n\t.hw_params\t= hac_hw_params,\n};\n\nstatic struct snd_soc_dai_driver sh4_hac_dai[] = {\n{\n\t.name\t\t\t= \"hac-dai.0\",\n\t.playback = {\n\t\t.rates\t\t= AC97_RATES,\n\t\t.formats\t= AC97_FMTS,\n\t\t.channels_min\t= 2,\n\t\t.channels_max\t= 2,\n\t},\n\t.capture = {\n\t\t.rates\t\t= AC97_RATES,\n\t\t.formats\t= AC97_FMTS,\n\t\t.channels_min\t= 2,\n\t\t.channels_max\t= 2,\n\t},\n\t.ops = &hac_dai_ops,\n},\n#ifdef CONFIG_CPU_SUBTYPE_SH7760\n{\n\t.name\t\t\t= \"hac-dai.1\",\n\t.id\t\t\t= 1,\n\t.playback = {\n\t\t.rates\t\t= AC97_RATES,\n\t\t.formats\t= AC97_FMTS,\n\t\t.channels_min\t= 2,\n\t\t.channels_max\t= 2,\n\t},\n\t.capture = {\n\t\t.rates\t\t= AC97_RATES,\n\t\t.formats\t= AC97_FMTS,\n\t\t.channels_min\t= 2,\n\t\t.channels_max\t= 2,\n\t},\n\t.ops = &hac_dai_ops,\n\n},\n#endif\n};\n\nstatic const struct snd_soc_component_driver sh4_hac_component = {\n\t.name\t\t\t= \"sh4-hac\",\n\t.legacy_dai_naming\t= 1,\n};\n\nstatic int hac_soc_platform_probe(struct platform_device *pdev)\n{\n\tint ret;\n\n\tret = snd_soc_set_ac97_ops(&hac_ac97_ops);\n\tif (ret != 0)\n\t\treturn ret;\n\n\treturn devm_snd_soc_register_component(&pdev->dev, &sh4_hac_component,\n\t\t\t\t\t  sh4_hac_dai, ARRAY_SIZE(sh4_hac_dai));\n}\n\nstatic void hac_soc_platform_remove(struct platform_device *pdev)\n{\n\tsnd_soc_set_ac97_ops(NULL);\n}\n\nstatic struct platform_driver hac_pcm_driver = {\n\t.driver = {\n\t\t\t.name = \"hac-pcm-audio\",\n\t},\n\n\t.probe = hac_soc_platform_probe,\n\t.remove_new = hac_soc_platform_remove,\n};\n\nmodule_platform_driver(hac_pcm_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"SuperH onchip HAC (AC97) audio driver\");\nMODULE_AUTHOR(\"Manuel Lauss <mano@roarinelk.homelinux.net>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}