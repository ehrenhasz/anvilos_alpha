{
  "module_name": "pistachio-internal-dac.c",
  "hash_id": "142e9cb3e553ddeade699c22b5655d53020b2bce65492c20b6f49fa742dd13b2",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/img/pistachio-internal-dac.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n#include <linux/regulator/consumer.h>\n\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#define PISTACHIO_INTERNAL_DAC_CTRL\t\t\t0x40\n#define PISTACHIO_INTERNAL_DAC_CTRL_PWR_SEL_MASK\t0x2\n#define PISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK\t\t0x1\n\n#define PISTACHIO_INTERNAL_DAC_SRST\t\t\t0x44\n#define PISTACHIO_INTERNAL_DAC_SRST_MASK\t\t0x1\n\n#define PISTACHIO_INTERNAL_DAC_GTI_CTRL\t\t\t0x48\n#define PISTACHIO_INTERNAL_DAC_GTI_CTRL_ADDR_SHIFT\t0\n#define PISTACHIO_INTERNAL_DAC_GTI_CTRL_ADDR_MASK\t0xFFF\n#define PISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK\t\t0x1000\n#define PISTACHIO_INTERNAL_DAC_GTI_CTRL_WDATA_SHIFT\t13\n#define PISTACHIO_INTERNAL_DAC_GTI_CTRL_WDATA_MASK\t0x1FE000\n\n#define PISTACHIO_INTERNAL_DAC_PWR\t\t\t0x1\n#define PISTACHIO_INTERNAL_DAC_PWR_MASK\t\t\t0x1\n\n#define PISTACHIO_INTERNAL_DAC_FORMATS (SNDRV_PCM_FMTBIT_S24_LE |  \\\n\t\t\t\t\tSNDRV_PCM_FMTBIT_S32_LE)\n\n \nstruct pistachio_internal_dac {\n\tstruct regmap *regmap;\n\tstruct regulator *supply;\n\tbool mute;\n};\n\nstatic const struct snd_kcontrol_new pistachio_internal_dac_snd_controls[] = {\n\tSOC_SINGLE(\"Playback Switch\", PISTACHIO_INTERNAL_DAC_CTRL, 2, 1, 1)\n};\n\nstatic const struct snd_soc_dapm_widget pistachio_internal_dac_widgets[] = {\n\tSND_SOC_DAPM_DAC(\"DAC\", \"Playback\", SND_SOC_NOPM, 0, 0),\n\tSND_SOC_DAPM_OUTPUT(\"AOUTL\"),\n\tSND_SOC_DAPM_OUTPUT(\"AOUTR\"),\n};\n\nstatic const struct snd_soc_dapm_route pistachio_internal_dac_routes[] = {\n\t{ \"AOUTL\", NULL, \"DAC\" },\n\t{ \"AOUTR\", NULL, \"DAC\" },\n};\n\nstatic void pistachio_internal_dac_reg_writel(struct regmap *top_regs,\n\t\t\t\t\t\tu32 val, u32 reg)\n{\n\tregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\n\t\t\tPISTACHIO_INTERNAL_DAC_GTI_CTRL_ADDR_MASK,\n\t\t\treg << PISTACHIO_INTERNAL_DAC_GTI_CTRL_ADDR_SHIFT);\n\n\tregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\n\t\t\tPISTACHIO_INTERNAL_DAC_GTI_CTRL_WDATA_MASK,\n\t\t\tval << PISTACHIO_INTERNAL_DAC_GTI_CTRL_WDATA_SHIFT);\n\n\tregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\n\t\t\tPISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK,\n\t\t\tPISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK);\n\n\tregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\n\t\t\tPISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK, 0);\n}\n\nstatic void pistachio_internal_dac_pwr_off(struct pistachio_internal_dac *dac)\n{\n\tregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_CTRL,\n\t\tPISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK,\n\t\tPISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK);\n\n\tpistachio_internal_dac_reg_writel(dac->regmap, 0,\n\t\t\t\t\tPISTACHIO_INTERNAL_DAC_PWR);\n}\n\nstatic void pistachio_internal_dac_pwr_on(struct pistachio_internal_dac *dac)\n{\n\tregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_SRST,\n\t\t\tPISTACHIO_INTERNAL_DAC_SRST_MASK,\n\t\t\tPISTACHIO_INTERNAL_DAC_SRST_MASK);\n\n\tregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_SRST,\n\t\t\tPISTACHIO_INTERNAL_DAC_SRST_MASK, 0);\n\n\tpistachio_internal_dac_reg_writel(dac->regmap,\n\t\t\t\t\tPISTACHIO_INTERNAL_DAC_PWR_MASK,\n\t\t\t\t\tPISTACHIO_INTERNAL_DAC_PWR);\n\n\tregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_CTRL,\n\t\t\tPISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK, 0);\n}\n\nstatic struct snd_soc_dai_driver pistachio_internal_dac_dais[] = {\n\t{\n\t\t.name = \"pistachio_internal_dac\",\n\t\t.playback = {\n\t\t\t.stream_name = \"Playback\",\n\t\t\t.channels_min = 2,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t\t.formats = PISTACHIO_INTERNAL_DAC_FORMATS,\n\t\t}\n\t},\n};\n\nstatic int pistachio_internal_dac_codec_probe(struct snd_soc_component *component)\n{\n\tstruct pistachio_internal_dac *dac = snd_soc_component_get_drvdata(component);\n\n\tsnd_soc_component_init_regmap(component, dac->regmap);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver pistachio_internal_dac_driver = {\n\t.probe\t\t\t= pistachio_internal_dac_codec_probe,\n\t.controls\t\t= pistachio_internal_dac_snd_controls,\n\t.num_controls\t\t= ARRAY_SIZE(pistachio_internal_dac_snd_controls),\n\t.dapm_widgets\t\t= pistachio_internal_dac_widgets,\n\t.num_dapm_widgets\t= ARRAY_SIZE(pistachio_internal_dac_widgets),\n\t.dapm_routes\t\t= pistachio_internal_dac_routes,\n\t.num_dapm_routes\t= ARRAY_SIZE(pistachio_internal_dac_routes),\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\nstatic int pistachio_internal_dac_probe(struct platform_device *pdev)\n{\n\tstruct pistachio_internal_dac *dac;\n\tint ret, voltage;\n\tstruct device *dev = &pdev->dev;\n\tu32 reg;\n\n\tdac = devm_kzalloc(dev, sizeof(*dac), GFP_KERNEL);\n\n\tif (!dac)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, dac);\n\n\tdac->regmap = syscon_regmap_lookup_by_phandle(pdev->dev.of_node,\n\t\t\t\t\t\t\t    \"img,cr-top\");\n\tif (IS_ERR(dac->regmap))\n\t\treturn PTR_ERR(dac->regmap);\n\n\tdac->supply = devm_regulator_get(dev, \"VDD\");\n\tif (IS_ERR(dac->supply))\n\t\treturn dev_err_probe(dev, PTR_ERR(dac->supply),\n\t\t\t\t     \"failed to acquire supply 'VDD-supply'\\n\");\n\n\tret = regulator_enable(dac->supply);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to enable supply: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tvoltage = regulator_get_voltage(dac->supply);\n\n\tswitch (voltage) {\n\tcase 1800000:\n\t\treg = 0;\n\t\tbreak;\n\tcase 3300000:\n\t\treg = PISTACHIO_INTERNAL_DAC_CTRL_PWR_SEL_MASK;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"invalid voltage: %d\\n\", voltage);\n\t\tret = -EINVAL;\n\t\tgoto err_regulator;\n\t}\n\n\tregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_CTRL,\n\t\t\tPISTACHIO_INTERNAL_DAC_CTRL_PWR_SEL_MASK, reg);\n\n\tpistachio_internal_dac_pwr_off(dac);\n\tpistachio_internal_dac_pwr_on(dac);\n\n\tpm_runtime_set_active(dev);\n\tpm_runtime_enable(dev);\n\tpm_runtime_idle(dev);\n\n\tret = devm_snd_soc_register_component(dev,\n\t\t\t&pistachio_internal_dac_driver,\n\t\t\tpistachio_internal_dac_dais,\n\t\t\tARRAY_SIZE(pistachio_internal_dac_dais));\n\tif (ret) {\n\t\tdev_err(dev, \"failed to register component: %d\\n\", ret);\n\t\tgoto err_pwr;\n\t}\n\n\treturn 0;\n\nerr_pwr:\n\tpm_runtime_disable(&pdev->dev);\n\tpistachio_internal_dac_pwr_off(dac);\nerr_regulator:\n\tregulator_disable(dac->supply);\n\n\treturn ret;\n}\n\nstatic void pistachio_internal_dac_remove(struct platform_device *pdev)\n{\n\tstruct pistachio_internal_dac *dac = dev_get_drvdata(&pdev->dev);\n\n\tpm_runtime_disable(&pdev->dev);\n\tpistachio_internal_dac_pwr_off(dac);\n\tregulator_disable(dac->supply);\n}\n\n#ifdef CONFIG_PM\nstatic int pistachio_internal_dac_rt_resume(struct device *dev)\n{\n\tstruct pistachio_internal_dac *dac = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = regulator_enable(dac->supply);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to enable supply: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpistachio_internal_dac_pwr_on(dac);\n\n\treturn 0;\n}\n\nstatic int pistachio_internal_dac_rt_suspend(struct device *dev)\n{\n\tstruct pistachio_internal_dac *dac = dev_get_drvdata(dev);\n\n\tpistachio_internal_dac_pwr_off(dac);\n\n\tregulator_disable(dac->supply);\n\n\treturn 0;\n}\n#endif\n\nstatic const struct dev_pm_ops pistachio_internal_dac_pm_ops = {\n\tSET_RUNTIME_PM_OPS(pistachio_internal_dac_rt_suspend,\n\t\t\tpistachio_internal_dac_rt_resume, NULL)\n};\n\nstatic const struct of_device_id pistachio_internal_dac_of_match[] = {\n\t{ .compatible = \"img,pistachio-internal-dac\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, pistachio_internal_dac_of_match);\n\nstatic struct platform_driver pistachio_internal_dac_plat_driver = {\n\t.driver = {\n\t\t.name = \"img-pistachio-internal-dac\",\n\t\t.of_match_table = pistachio_internal_dac_of_match,\n\t\t.pm = &pistachio_internal_dac_pm_ops\n\t},\n\t.probe = pistachio_internal_dac_probe,\n\t.remove_new = pistachio_internal_dac_remove\n};\nmodule_platform_driver(pistachio_internal_dac_plat_driver);\n\nMODULE_DESCRIPTION(\"Pistachio Internal DAC driver\");\nMODULE_AUTHOR(\"Damien Horsley <Damien.Horsley@imgtec.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}