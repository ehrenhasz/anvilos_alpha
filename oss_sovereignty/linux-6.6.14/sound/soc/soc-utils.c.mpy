{
  "module_name": "soc-utils.c",
  "hash_id": "6a18695ff16c87cf592235b5be61e81b31c07ce1a32cf1c309d12e9386e279b4",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/soc-utils.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n#include <linux/platform_device.h>\n#include <linux/export.h>\n#include <linux/math.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\nint snd_soc_calc_frame_size(int sample_size, int channels, int tdm_slots)\n{\n\treturn sample_size * channels * tdm_slots;\n}\nEXPORT_SYMBOL_GPL(snd_soc_calc_frame_size);\n\nint snd_soc_params_to_frame_size(struct snd_pcm_hw_params *params)\n{\n\tint sample_size;\n\n\tsample_size = snd_pcm_format_width(params_format(params));\n\tif (sample_size < 0)\n\t\treturn sample_size;\n\n\treturn snd_soc_calc_frame_size(sample_size, params_channels(params),\n\t\t\t\t       1);\n}\nEXPORT_SYMBOL_GPL(snd_soc_params_to_frame_size);\n\nint snd_soc_calc_bclk(int fs, int sample_size, int channels, int tdm_slots)\n{\n\treturn fs * snd_soc_calc_frame_size(sample_size, channels, tdm_slots);\n}\nEXPORT_SYMBOL_GPL(snd_soc_calc_bclk);\n\nint snd_soc_params_to_bclk(struct snd_pcm_hw_params *params)\n{\n\tint ret;\n\n\tret = snd_soc_params_to_frame_size(params);\n\n\tif (ret > 0)\n\t\treturn ret * params_rate(params);\n\telse\n\t\treturn ret;\n}\nEXPORT_SYMBOL_GPL(snd_soc_params_to_bclk);\n\n \nint snd_soc_tdm_params_to_bclk(struct snd_pcm_hw_params *params,\n\t\t\t       int tdm_width, int tdm_slots, int slot_multiple)\n{\n\tif (!tdm_slots)\n\t\ttdm_slots = params_channels(params);\n\n\tif (slot_multiple > 1)\n\t\ttdm_slots = roundup(tdm_slots, slot_multiple);\n\n\tif (!tdm_width) {\n\t\ttdm_width = snd_pcm_format_width(params_format(params));\n\t\tif (tdm_width < 0)\n\t\t\treturn tdm_width;\n\t}\n\n\treturn snd_soc_calc_bclk(params_rate(params), tdm_width, 1, tdm_slots);\n}\nEXPORT_SYMBOL_GPL(snd_soc_tdm_params_to_bclk);\n\nstatic const struct snd_pcm_hardware dummy_dma_hardware = {\n\t \n\t.info\t\t\t= SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t\t  SNDRV_PCM_INFO_BLOCK_TRANSFER,\n\t.buffer_bytes_max\t= 128*1024,\n\t.period_bytes_min\t= PAGE_SIZE,\n\t.period_bytes_max\t= PAGE_SIZE*2,\n\t.periods_min\t\t= 2,\n\t.periods_max\t\t= 128,\n};\n\n\nstatic const struct snd_soc_component_driver dummy_platform;\n\nstatic int dummy_dma_open(struct snd_soc_component *component,\n\t\t\t  struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tint i;\n\n\t \n\tfor_each_rtd_components(rtd, i, component) {\n\t\tif (component->driver == &dummy_platform)\n\t\t\treturn 0;\n\t}\n\n\t \n\tif (!rtd->dai_link->no_pcm)\n\t\tsnd_soc_set_runtime_hwparams(substream, &dummy_dma_hardware);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver dummy_platform = {\n\t.open\t\t= dummy_dma_open,\n};\n\nstatic const struct snd_soc_component_driver dummy_codec = {\n\t.idle_bias_on\t\t= 1,\n\t.use_pmdown_time\t= 1,\n\t.endianness\t\t= 1,\n};\n\n#define STUB_RATES\tSNDRV_PCM_RATE_8000_384000\n#define STUB_FORMATS\t(SNDRV_PCM_FMTBIT_S8 | \\\n\t\t\tSNDRV_PCM_FMTBIT_U8 | \\\n\t\t\tSNDRV_PCM_FMTBIT_S16_LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_U16_LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_S24_LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_S24_3LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_U24_LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_S32_LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_U32_LE | \\\n\t\t\tSNDRV_PCM_FMTBIT_IEC958_SUBFRAME_LE)\n\n \nstatic u64 dummy_dai_formats =\n\tSND_SOC_POSSIBLE_DAIFMT_I2S\t|\n\tSND_SOC_POSSIBLE_DAIFMT_RIGHT_J\t|\n\tSND_SOC_POSSIBLE_DAIFMT_LEFT_J\t|\n\tSND_SOC_POSSIBLE_DAIFMT_DSP_A\t|\n\tSND_SOC_POSSIBLE_DAIFMT_DSP_B\t|\n\tSND_SOC_POSSIBLE_DAIFMT_AC97\t|\n\tSND_SOC_POSSIBLE_DAIFMT_PDM\t|\n\tSND_SOC_POSSIBLE_DAIFMT_GATED\t|\n\tSND_SOC_POSSIBLE_DAIFMT_CONT\t|\n\tSND_SOC_POSSIBLE_DAIFMT_NB_NF\t|\n\tSND_SOC_POSSIBLE_DAIFMT_NB_IF\t|\n\tSND_SOC_POSSIBLE_DAIFMT_IB_NF\t|\n\tSND_SOC_POSSIBLE_DAIFMT_IB_IF;\n\nstatic const struct snd_soc_dai_ops dummy_dai_ops = {\n\t.auto_selectable_formats\t= &dummy_dai_formats,\n\t.num_auto_selectable_formats\t= 1,\n};\n\n \nstatic struct snd_soc_dai_driver dummy_dai = {\n\t.name = \"snd-soc-dummy-dai\",\n\t.playback = {\n\t\t.stream_name\t= \"Playback\",\n\t\t.channels_min\t= 1,\n\t\t.channels_max\t= 384,\n\t\t.rates\t\t= STUB_RATES,\n\t\t.formats\t= STUB_FORMATS,\n\t},\n\t.capture = {\n\t\t.stream_name\t= \"Capture\",\n\t\t.channels_min\t= 1,\n\t\t.channels_max\t= 384,\n\t\t.rates = STUB_RATES,\n\t\t.formats = STUB_FORMATS,\n\t },\n\t.ops = &dummy_dai_ops,\n};\n\nint snd_soc_dai_is_dummy(struct snd_soc_dai *dai)\n{\n\tif (dai->driver == &dummy_dai)\n\t\treturn 1;\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(snd_soc_dai_is_dummy);\n\nint snd_soc_component_is_dummy(struct snd_soc_component *component)\n{\n\treturn ((component->driver == &dummy_platform) ||\n\t\t(component->driver == &dummy_codec));\n}\n\nstruct snd_soc_dai_link_component asoc_dummy_dlc = {\n\t.of_node\t= NULL,\n\t.dai_name\t= \"snd-soc-dummy-dai\",\n\t.name\t\t= \"snd-soc-dummy\",\n};\nEXPORT_SYMBOL_GPL(asoc_dummy_dlc);\n\nstatic int snd_soc_dummy_probe(struct platform_device *pdev)\n{\n\tint ret;\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t\t      &dummy_codec, &dummy_dai, 1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = devm_snd_soc_register_component(&pdev->dev, &dummy_platform,\n\t\t\t\t\t      NULL, 0);\n\n\treturn ret;\n}\n\nstatic struct platform_driver soc_dummy_driver = {\n\t.driver = {\n\t\t.name = \"snd-soc-dummy\",\n\t},\n\t.probe = snd_soc_dummy_probe,\n};\n\nstatic struct platform_device *soc_dummy_dev;\n\nint __init snd_soc_util_init(void)\n{\n\tint ret;\n\n\tsoc_dummy_dev =\n\t\tplatform_device_register_simple(\"snd-soc-dummy\", -1, NULL, 0);\n\tif (IS_ERR(soc_dummy_dev))\n\t\treturn PTR_ERR(soc_dummy_dev);\n\n\tret = platform_driver_register(&soc_dummy_driver);\n\tif (ret != 0)\n\t\tplatform_device_unregister(soc_dummy_dev);\n\n\treturn ret;\n}\n\nvoid snd_soc_util_exit(void)\n{\n\tplatform_driver_unregister(&soc_dummy_driver);\n\tplatform_device_unregister(soc_dummy_dev);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}