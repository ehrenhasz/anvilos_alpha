{
  "module_name": "aiu-fifo-spdif.c",
  "hash_id": "5afc4e62c40e963dbe7471040a6d2cd3472bd8ac2c3a84726e1d63b2af658407",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/meson/aiu-fifo-spdif.c",
  "human_readable_source": "\n\n\n\n\n#include <linux/clk.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n\n#include \"aiu.h\"\n#include \"aiu-fifo.h\"\n\n#define AIU_IEC958_DCU_FF_CTRL_EN\t\tBIT(0)\n#define AIU_IEC958_DCU_FF_CTRL_AUTO_DISABLE\tBIT(1)\n#define AIU_IEC958_DCU_FF_CTRL_IRQ_MODE\t\tGENMASK(3, 2)\n#define AIU_IEC958_DCU_FF_CTRL_IRQ_OUT_THD\tBIT(2)\n#define AIU_IEC958_DCU_FF_CTRL_IRQ_FRAME_READ\tBIT(3)\n#define AIU_IEC958_DCU_FF_CTRL_SYNC_HEAD_EN\tBIT(4)\n#define AIU_IEC958_DCU_FF_CTRL_BYTE_SEEK\tBIT(5)\n#define AIU_IEC958_DCU_FF_CTRL_CONTINUE\t\tBIT(6)\n#define AIU_MEM_IEC958_CONTROL_ENDIAN\t\tGENMASK(5, 3)\n#define AIU_MEM_IEC958_CONTROL_RD_DDR\t\tBIT(6)\n#define AIU_MEM_IEC958_CONTROL_MODE_16BIT\tBIT(7)\n#define AIU_MEM_IEC958_CONTROL_MODE_LINEAR\tBIT(8)\n#define AIU_MEM_IEC958_BUF_CNTL_INIT\t\tBIT(0)\n\n#define AIU_FIFO_SPDIF_BLOCK\t\t\t8\n\nstatic struct snd_pcm_hardware fifo_spdif_pcm = {\n\t.info = (SNDRV_PCM_INFO_INTERLEAVED |\n\t\t SNDRV_PCM_INFO_MMAP |\n\t\t SNDRV_PCM_INFO_MMAP_VALID |\n\t\t SNDRV_PCM_INFO_PAUSE),\n\t.formats = AIU_FORMATS,\n\t.rate_min = 5512,\n\t.rate_max = 192000,\n\t.channels_min = 2,\n\t.channels_max = 2,\n\t.period_bytes_min = AIU_FIFO_SPDIF_BLOCK,\n\t.period_bytes_max = AIU_FIFO_SPDIF_BLOCK * USHRT_MAX,\n\t.periods_min = 2,\n\t.periods_max = UINT_MAX,\n\n\t \n\t.buffer_bytes_max = 1 * 1024 * 1024,\n};\n\nstatic void fifo_spdif_dcu_enable(struct snd_soc_component *component,\n\t\t\t\t  bool enable)\n{\n\tsnd_soc_component_update_bits(component, AIU_IEC958_DCU_FF_CTRL,\n\t\t\t\t      AIU_IEC958_DCU_FF_CTRL_EN,\n\t\t\t\t      enable ? AIU_IEC958_DCU_FF_CTRL_EN : 0);\n}\n\nstatic int fifo_spdif_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t\t      struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint ret;\n\n\tret = aiu_fifo_trigger(substream, cmd, dai);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tfifo_spdif_dcu_enable(component, true);\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\t\tfifo_spdif_dcu_enable(component, false);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int fifo_spdif_prepare(struct snd_pcm_substream *substream,\n\t\t\t      struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint ret;\n\n\tret = aiu_fifo_prepare(substream, dai);\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      AIU_MEM_IEC958_BUF_CNTL,\n\t\t\t\t      AIU_MEM_IEC958_BUF_CNTL_INIT,\n\t\t\t\t      AIU_MEM_IEC958_BUF_CNTL_INIT);\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      AIU_MEM_IEC958_BUF_CNTL,\n\t\t\t\t      AIU_MEM_IEC958_BUF_CNTL_INIT, 0);\n\n\treturn 0;\n}\n\nstatic int fifo_spdif_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *params,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tunsigned int val;\n\tint ret;\n\n\tret = aiu_fifo_hw_params(substream, params, dai);\n\tif (ret)\n\t\treturn ret;\n\n\tval = AIU_MEM_IEC958_CONTROL_RD_DDR |\n\t      AIU_MEM_IEC958_CONTROL_MODE_LINEAR;\n\n\tswitch (params_physical_width(params)) {\n\tcase 16:\n\t\tval |= AIU_MEM_IEC958_CONTROL_MODE_16BIT;\n\t\tbreak;\n\tcase 32:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dai->dev, \"Unsupported physical width %u\\n\",\n\t\t\tparams_physical_width(params));\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_update_bits(component, AIU_MEM_IEC958_CONTROL,\n\t\t\t\t      AIU_MEM_IEC958_CONTROL_ENDIAN |\n\t\t\t\t      AIU_MEM_IEC958_CONTROL_RD_DDR |\n\t\t\t\t      AIU_MEM_IEC958_CONTROL_MODE_LINEAR |\n\t\t\t\t      AIU_MEM_IEC958_CONTROL_MODE_16BIT,\n\t\t\t\t      val);\n\n\t \n\tsnd_soc_component_write(component, AIU_IEC958_BPF,\n\t\t\t\tparams_period_bytes(params));\n\n\t \n\tsnd_soc_component_update_bits(component, AIU_IEC958_DCU_FF_CTRL,\n\t\t\t\t      AIU_IEC958_DCU_FF_CTRL_AUTO_DISABLE |\n\t\t\t\t      AIU_IEC958_DCU_FF_CTRL_IRQ_MODE |\n\t\t\t\t      AIU_IEC958_DCU_FF_CTRL_SYNC_HEAD_EN,\n\t\t\t\t      AIU_IEC958_DCU_FF_CTRL_IRQ_FRAME_READ);\n\n\treturn 0;\n}\n\nconst struct snd_soc_dai_ops aiu_fifo_spdif_dai_ops = {\n\t.pcm_new\t= aiu_fifo_pcm_new,\n\t.probe\t\t= aiu_fifo_spdif_dai_probe,\n\t.remove\t\t= aiu_fifo_dai_remove,\n\t.trigger\t= fifo_spdif_trigger,\n\t.prepare\t= fifo_spdif_prepare,\n\t.hw_params\t= fifo_spdif_hw_params,\n\t.startup\t= aiu_fifo_startup,\n\t.shutdown\t= aiu_fifo_shutdown,\n};\n\nint aiu_fifo_spdif_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct aiu *aiu = snd_soc_component_get_drvdata(component);\n\tstruct aiu_fifo *fifo;\n\tint ret;\n\n\tret = aiu_fifo_dai_probe(dai);\n\tif (ret)\n\t\treturn ret;\n\n\tfifo = snd_soc_dai_dma_data_get_playback(dai);\n\n\tfifo->pcm = &fifo_spdif_pcm;\n\tfifo->mem_offset = AIU_MEM_IEC958_START;\n\tfifo->fifo_block = 1;\n\tfifo->pclk = aiu->spdif.clks[PCLK].clk;\n\tfifo->irq = aiu->spdif.irq;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}