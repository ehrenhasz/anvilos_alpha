{
  "module_name": "aiu-fifo-i2s.c",
  "hash_id": "38e5a7cf063ea1fcd61e676ed1a303694629f999ce909734c92336627cbcf0b7",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/meson/aiu-fifo-i2s.c",
  "human_readable_source": "\n\n\n\n\n#include <linux/bitfield.h>\n#include <linux/clk.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n\n#include \"aiu.h\"\n#include \"aiu-fifo.h\"\n\n#define AIU_I2S_SOURCE_DESC_MODE_8CH\tBIT(0)\n#define AIU_I2S_SOURCE_DESC_MODE_24BIT\tBIT(5)\n#define AIU_I2S_SOURCE_DESC_MODE_32BIT\tBIT(9)\n#define AIU_I2S_SOURCE_DESC_MODE_SPLIT\tBIT(11)\n#define AIU_MEM_I2S_MASKS_IRQ_BLOCK\tGENMASK(31, 16)\n#define AIU_MEM_I2S_CONTROL_MODE_16BIT\tBIT(6)\n#define AIU_MEM_I2S_BUF_CNTL_INIT\tBIT(0)\n#define AIU_RST_SOFT_I2S_FAST\t\tBIT(0)\n#define AIU_I2S_MISC_HOLD_EN\t\tBIT(2)\n#define AIU_I2S_MISC_FORCE_LEFT_RIGHT\tBIT(4)\n\n#define AIU_FIFO_I2S_BLOCK\t\t256\n\nstatic struct snd_pcm_hardware fifo_i2s_pcm = {\n\t.info = (SNDRV_PCM_INFO_INTERLEAVED |\n\t\t SNDRV_PCM_INFO_MMAP |\n\t\t SNDRV_PCM_INFO_MMAP_VALID |\n\t\t SNDRV_PCM_INFO_PAUSE),\n\t.formats = AIU_FORMATS,\n\t.rate_min = 5512,\n\t.rate_max = 192000,\n\t.channels_min = 2,\n\t.channels_max = 8,\n\t.period_bytes_min = AIU_FIFO_I2S_BLOCK,\n\t.period_bytes_max = AIU_FIFO_I2S_BLOCK * USHRT_MAX,\n\t.periods_min = 2,\n\t.periods_max = UINT_MAX,\n\n\t \n\t.buffer_bytes_max = 1 * 1024 * 1024,\n};\n\nstatic int aiu_fifo_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tsnd_soc_component_write(component, AIU_RST_SOFT,\n\t\t\t\t\tAIU_RST_SOFT_I2S_FAST);\n\t\tsnd_soc_component_read(component, AIU_I2S_SYNC);\n\t\tbreak;\n\t}\n\n\treturn aiu_fifo_trigger(substream, cmd, dai);\n}\n\nstatic int aiu_fifo_i2s_prepare(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tint ret;\n\n\tret = aiu_fifo_prepare(substream, dai);\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      AIU_MEM_I2S_BUF_CNTL,\n\t\t\t\t      AIU_MEM_I2S_BUF_CNTL_INIT,\n\t\t\t\t      AIU_MEM_I2S_BUF_CNTL_INIT);\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      AIU_MEM_I2S_BUF_CNTL,\n\t\t\t\t      AIU_MEM_I2S_BUF_CNTL_INIT, 0);\n\n\treturn 0;\n}\n\nstatic int aiu_fifo_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_pcm_hw_params *params,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\tunsigned int val;\n\tint ret;\n\n\tsnd_soc_component_update_bits(component, AIU_I2S_MISC,\n\t\t\t\t      AIU_I2S_MISC_HOLD_EN,\n\t\t\t\t      AIU_I2S_MISC_HOLD_EN);\n\n\tret = aiu_fifo_hw_params(substream, params, dai);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (params_physical_width(params)) {\n\tcase 16:\n\t\tval = AIU_MEM_I2S_CONTROL_MODE_16BIT;\n\t\tbreak;\n\tcase 32:\n\t\tval = 0;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dai->dev, \"Unsupported physical width %u\\n\",\n\t\t\tparams_physical_width(params));\n\t\treturn -EINVAL;\n\t}\n\n\tsnd_soc_component_update_bits(component, AIU_MEM_I2S_CONTROL,\n\t\t\t\t      AIU_MEM_I2S_CONTROL_MODE_16BIT,\n\t\t\t\t      val);\n\n\t \n\tval = params_period_bytes(params) / fifo->fifo_block;\n\tval = FIELD_PREP(AIU_MEM_I2S_MASKS_IRQ_BLOCK, val);\n\tsnd_soc_component_update_bits(component, AIU_MEM_I2S_MASKS,\n\t\t\t\t      AIU_MEM_I2S_MASKS_IRQ_BLOCK, val);\n\n\t \n\tsnd_soc_component_update_bits(component, AIU_I2S_MISC,\n\t\t\t\t      AIU_I2S_MISC_FORCE_LEFT_RIGHT,\n\t\t\t\t      AIU_I2S_MISC_FORCE_LEFT_RIGHT);\n\n\tsnd_soc_component_update_bits(component, AIU_I2S_MISC,\n\t\t\t\t      AIU_I2S_MISC_HOLD_EN, 0);\n\n\treturn 0;\n}\n\nconst struct snd_soc_dai_ops aiu_fifo_i2s_dai_ops = {\n\t.pcm_new\t= aiu_fifo_pcm_new,\n\t.probe\t\t= aiu_fifo_i2s_dai_probe,\n\t.remove\t\t= aiu_fifo_dai_remove,\n\t.trigger\t= aiu_fifo_i2s_trigger,\n\t.prepare\t= aiu_fifo_i2s_prepare,\n\t.hw_params\t= aiu_fifo_i2s_hw_params,\n\t.startup\t= aiu_fifo_startup,\n\t.shutdown\t= aiu_fifo_shutdown,\n};\n\nint aiu_fifo_i2s_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct aiu *aiu = snd_soc_component_get_drvdata(component);\n\tstruct aiu_fifo *fifo;\n\tint ret;\n\n\tret = aiu_fifo_dai_probe(dai);\n\tif (ret)\n\t\treturn ret;\n\n\tfifo = snd_soc_dai_dma_data_get_playback(dai);\n\n\tfifo->pcm = &fifo_i2s_pcm;\n\tfifo->mem_offset = AIU_MEM_I2S_START;\n\tfifo->fifo_block = AIU_FIFO_I2S_BLOCK;\n\tfifo->pclk = aiu->i2s.clks[PCLK].clk;\n\tfifo->irq = aiu->i2s.irq;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}