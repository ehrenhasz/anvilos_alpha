{
  "module_name": "aiu-fifo.c",
  "hash_id": "e287884adb3ee87ae94aabce0c050161171b7c6611eddaf9367d1f00db15921e",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/meson/aiu-fifo.c",
  "human_readable_source": "\n\n\n\n\n#include <linux/bitfield.h>\n#include <linux/clk.h>\n#include <linux/dma-mapping.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n\n#include \"aiu-fifo.h\"\n\n#define AIU_MEM_START\t0x00\n#define AIU_MEM_RD\t0x04\n#define AIU_MEM_END\t0x08\n#define AIU_MEM_MASKS\t0x0c\n#define  AIU_MEM_MASK_CH_RD GENMASK(7, 0)\n#define  AIU_MEM_MASK_CH_MEM GENMASK(15, 8)\n#define AIU_MEM_CONTROL\t0x10\n#define  AIU_MEM_CONTROL_INIT BIT(0)\n#define  AIU_MEM_CONTROL_FILL_EN BIT(1)\n#define  AIU_MEM_CONTROL_EMPTY_EN BIT(2)\n\nstatic struct snd_soc_dai *aiu_fifo_dai(struct snd_pcm_substream *ss)\n{\n\tstruct snd_soc_pcm_runtime *rtd = ss->private_data;\n\n\treturn asoc_rtd_to_cpu(rtd, 0);\n}\n\nsnd_pcm_uframes_t aiu_fifo_pointer(struct snd_soc_component *component,\n\t\t\t\t   struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_dai *dai = aiu_fifo_dai(substream);\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tunsigned int addr;\n\n\taddr = snd_soc_component_read(component, fifo->mem_offset + AIU_MEM_RD);\n\n\treturn bytes_to_frames(runtime, addr - (unsigned int)runtime->dma_addr);\n}\n\nstatic void aiu_fifo_enable(struct snd_soc_dai *dai, bool enable)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\tunsigned int en_mask = (AIU_MEM_CONTROL_FILL_EN |\n\t\t\t\tAIU_MEM_CONTROL_EMPTY_EN);\n\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      fifo->mem_offset + AIU_MEM_CONTROL,\n\t\t\t\t      en_mask, enable ? en_mask : 0);\n}\n\nint aiu_fifo_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t     struct snd_soc_dai *dai)\n{\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\taiu_fifo_enable(dai, true);\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\t\taiu_fifo_enable(dai, false);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nint aiu_fifo_prepare(struct snd_pcm_substream *substream,\n\t\t     struct snd_soc_dai *dai)\n{\n\tstruct snd_soc_component *component = dai->component;\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      fifo->mem_offset + AIU_MEM_CONTROL,\n\t\t\t\t      AIU_MEM_CONTROL_INIT,\n\t\t\t\t      AIU_MEM_CONTROL_INIT);\n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      fifo->mem_offset + AIU_MEM_CONTROL,\n\t\t\t\t      AIU_MEM_CONTROL_INIT, 0);\n\treturn 0;\n}\n\nint aiu_fifo_hw_params(struct snd_pcm_substream *substream,\n\t\t       struct snd_pcm_hw_params *params,\n\t\t       struct snd_soc_dai *dai)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_soc_component *component = dai->component;\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\tdma_addr_t end;\n\n\t \n\tend = runtime->dma_addr + runtime->dma_bytes - fifo->fifo_block;\n\tsnd_soc_component_write(component, fifo->mem_offset + AIU_MEM_START,\n\t\t\t\truntime->dma_addr);\n\tsnd_soc_component_write(component, fifo->mem_offset + AIU_MEM_RD,\n\t\t\t\truntime->dma_addr);\n\tsnd_soc_component_write(component, fifo->mem_offset + AIU_MEM_END,\n\t\t\t\tend);\n\n\t \n\tsnd_soc_component_update_bits(component,\n\t\t\t\t      fifo->mem_offset + AIU_MEM_MASKS,\n\t\t\t\t      AIU_MEM_MASK_CH_RD | AIU_MEM_MASK_CH_MEM,\n\t\t\t\t      FIELD_PREP(AIU_MEM_MASK_CH_RD, 0xff) |\n\t\t\t\t      FIELD_PREP(AIU_MEM_MASK_CH_MEM, 0xff));\n\n\treturn 0;\n}\n\nstatic irqreturn_t aiu_fifo_isr(int irq, void *dev_id)\n{\n\tstruct snd_pcm_substream *playback = dev_id;\n\n\tsnd_pcm_period_elapsed(playback);\n\n\treturn IRQ_HANDLED;\n}\n\nint aiu_fifo_startup(struct snd_pcm_substream *substream,\n\t\t     struct snd_soc_dai *dai)\n{\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\tint ret;\n\n\tsnd_soc_set_runtime_hwparams(substream, fifo->pcm);\n\n\t \n\tret = snd_pcm_hw_constraint_step(substream->runtime, 0,\n\t\t\t\t\t SNDRV_PCM_HW_PARAM_BUFFER_BYTES,\n\t\t\t\t\t fifo->fifo_block);\n\tif (ret)\n\t\treturn ret;\n\n\tret = snd_pcm_hw_constraint_step(substream->runtime, 0,\n\t\t\t\t\t SNDRV_PCM_HW_PARAM_PERIOD_BYTES,\n\t\t\t\t\t fifo->fifo_block);\n\tif (ret)\n\t\treturn ret;\n\n\tret = clk_prepare_enable(fifo->pclk);\n\tif (ret)\n\t\treturn ret;\n\n\tret = request_irq(fifo->irq, aiu_fifo_isr, 0, dev_name(dai->dev),\n\t\t\t  substream);\n\tif (ret)\n\t\tclk_disable_unprepare(fifo->pclk);\n\n\treturn ret;\n}\n\nvoid aiu_fifo_shutdown(struct snd_pcm_substream *substream,\n\t\t       struct snd_soc_dai *dai)\n{\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\n\tfree_irq(fifo->irq, substream);\n\tclk_disable_unprepare(fifo->pclk);\n}\n\nint aiu_fifo_pcm_new(struct snd_soc_pcm_runtime *rtd,\n\t\t     struct snd_soc_dai *dai)\n{\n\tstruct snd_card *card = rtd->card->snd_card;\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\tsize_t size = fifo->pcm->buffer_bytes_max;\n\tint ret;\n\n\tret = dma_coerce_mask_and_coherent(card->dev, DMA_BIT_MASK(32));\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_pcm_set_managed_buffer_all(rtd->pcm, SNDRV_DMA_TYPE_DEV,\n\t\t\t\t       card->dev, size, size);\n\n\treturn 0;\n}\n\nint aiu_fifo_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct aiu_fifo *fifo;\n\n\tfifo = kzalloc(sizeof(*fifo), GFP_KERNEL);\n\tif (!fifo)\n\t\treturn -ENOMEM;\n\n\tsnd_soc_dai_dma_data_set_playback(dai, fifo);\n\n\treturn 0;\n}\n\nint aiu_fifo_dai_remove(struct snd_soc_dai *dai)\n{\n\tstruct aiu_fifo *fifo = snd_soc_dai_dma_data_get_playback(dai);\n\n\tkfree(fifo);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}