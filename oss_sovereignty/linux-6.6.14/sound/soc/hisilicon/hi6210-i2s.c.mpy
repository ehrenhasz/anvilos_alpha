{
  "module_name": "hi6210-i2s.c",
  "hash_id": "59cddb6729e0b47e6fcfe937294a8d767c1dc074f0dd50649d1e1cfa20fdd720",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/hisilicon/hi6210-i2s.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/delay.h>\n#include <linux/clk.h>\n#include <linux/jiffies.h>\n#include <linux/io.h>\n#include <linux/gpio.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/dmaengine_pcm.h>\n#include <sound/initval.h>\n#include <sound/soc.h>\n#include <linux/interrupt.h>\n#include <linux/reset.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/mfd/syscon.h>\n#include <linux/reset-controller.h>\n\n#include \"hi6210-i2s.h\"\n\nstruct hi6210_i2s {\n\tstruct device *dev;\n\tstruct reset_control *rc;\n\tstruct clk *clk[8];\n\tint clocks;\n\tstruct snd_soc_dai_driver dai;\n\tvoid __iomem *base;\n\tstruct regmap *sysctrl;\n\tphys_addr_t base_phys;\n\tstruct snd_dmaengine_dai_dma_data dma_data[2];\n\tint clk_rate;\n\tspinlock_t lock;\n\tint rate;\n\tint format;\n\tu8 bits;\n\tu8 channels;\n\tu8 id;\n\tu8 channel_length;\n\tu8 use;\n\tu32 master:1;\n\tu32 status:1;\n};\n\n#define SC_PERIPH_CLKEN1\t0x210\n#define SC_PERIPH_CLKDIS1\t0x214\n\n#define SC_PERIPH_CLKEN3\t0x230\n#define SC_PERIPH_CLKDIS3\t0x234\n\n#define SC_PERIPH_CLKEN12\t0x270\n#define SC_PERIPH_CLKDIS12\t0x274\n\n#define SC_PERIPH_RSTEN1\t0x310\n#define SC_PERIPH_RSTDIS1\t0x314\n#define SC_PERIPH_RSTSTAT1\t0x318\n\n#define SC_PERIPH_RSTEN2\t0x320\n#define SC_PERIPH_RSTDIS2\t0x324\n#define SC_PERIPH_RSTSTAT2\t0x328\n\n#define SOC_PMCTRL_BBPPLLALIAS\t0x48\n\nenum {\n\tCLK_DACODEC,\n\tCLK_I2S_BASE,\n};\n\nstatic inline void hi6210_write_reg(struct hi6210_i2s *i2s, int reg, u32 val)\n{\n\twritel(val, i2s->base + reg);\n}\n\nstatic inline u32 hi6210_read_reg(struct hi6210_i2s *i2s, int reg)\n{\n\treturn readl(i2s->base + reg);\n}\n\nstatic int hi6210_i2s_startup(struct snd_pcm_substream *substream,\n\t\t\t      struct snd_soc_dai *cpu_dai)\n{\n\tstruct hi6210_i2s *i2s = dev_get_drvdata(cpu_dai->dev);\n\tint ret, n;\n\tu32 val;\n\n\t \n\tregmap_read(i2s->sysctrl, SC_PERIPH_RSTSTAT2, &val);\n\tif (val & BIT(4))\n\t\tregmap_write(i2s->sysctrl, SC_PERIPH_RSTDIS2, BIT(4));\n\n\tfor (n = 0; n < i2s->clocks; n++) {\n\t\tret = clk_prepare_enable(i2s->clk[n]);\n\t\tif (ret)\n\t\t\tgoto err_unprepare_clk;\n\t}\n\n\tret = clk_set_rate(i2s->clk[CLK_I2S_BASE], 49152000);\n\tif (ret) {\n\t\tdev_err(i2s->dev, \"%s: setting 49.152MHz base rate failed %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto err_unprepare_clk;\n\t}\n\n\t \n\tregmap_write(i2s->sysctrl, SC_PERIPH_CLKEN12, BIT(9));\n\n\t \n\tregmap_write(i2s->sysctrl, SC_PERIPH_CLKEN1, BIT(5));\n\n\t \n\tregmap_write(i2s->sysctrl, SC_PERIPH_RSTEN1, BIT(5));\n\tregmap_write(i2s->sysctrl, SC_PERIPH_RSTDIS1, BIT(5));\n\n\t \n\tval = hi6210_read_reg(i2s, HII2S_CODEC_IRQ_MASK);\n\tval |= 0x3f;\n\thi6210_write_reg(i2s, HII2S_CODEC_IRQ_MASK, val);\n\n\n\t \n\tval = hi6210_read_reg(i2s, HII2S_APB_AFIFO_CFG_1);\n\tval |= (BIT(5) | BIT(4));\n\thi6210_write_reg(i2s, HII2S_APB_AFIFO_CFG_1, val);\n\n\tval = hi6210_read_reg(i2s, HII2S_APB_AFIFO_CFG_1);\n\tval &= ~(BIT(5) | BIT(4));\n\thi6210_write_reg(i2s, HII2S_APB_AFIFO_CFG_1, val);\n\n\n\tval = hi6210_read_reg(i2s, HII2S_SW_RST_N);\n\tval &= ~(HII2S_SW_RST_N__ST_DL_WORDLEN_MASK <<\n\t\t\tHII2S_SW_RST_N__ST_DL_WORDLEN_SHIFT);\n\tval |= (HII2S_BITS_16 << HII2S_SW_RST_N__ST_DL_WORDLEN_SHIFT);\n\thi6210_write_reg(i2s, HII2S_SW_RST_N, val);\n\n\tval = hi6210_read_reg(i2s, HII2S_MISC_CFG);\n\t \n\tval &= ~HII2S_MISC_CFG__ST_DL_TEST_SEL;\n\t \n\tval &= ~HII2S_MISC_CFG__S2_DOUT_RIGHT_SEL;\n\tval &= ~HII2S_MISC_CFG__S2_DOUT_TEST_SEL;\n\n\tval |= HII2S_MISC_CFG__S2_DOUT_RIGHT_SEL;\n\t \n\tval |= HII2S_MISC_CFG__S2_DOUT_TEST_SEL;\n\thi6210_write_reg(i2s, HII2S_MISC_CFG, val);\n\n\tval = hi6210_read_reg(i2s, HII2S_SW_RST_N);\n\tval |= HII2S_SW_RST_N__SW_RST_N;\n\thi6210_write_reg(i2s, HII2S_SW_RST_N, val);\n\n\treturn 0;\n\nerr_unprepare_clk:\n\twhile (n--)\n\t\tclk_disable_unprepare(i2s->clk[n]);\n\treturn ret;\n}\n\nstatic void hi6210_i2s_shutdown(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_soc_dai *cpu_dai)\n{\n\tstruct hi6210_i2s *i2s = dev_get_drvdata(cpu_dai->dev);\n\tint n;\n\n\tfor (n = 0; n < i2s->clocks; n++)\n\t\tclk_disable_unprepare(i2s->clk[n]);\n\n\tregmap_write(i2s->sysctrl, SC_PERIPH_RSTEN1, BIT(5));\n}\n\nstatic void hi6210_i2s_txctrl(struct snd_soc_dai *cpu_dai, int on)\n{\n\tstruct hi6210_i2s *i2s = dev_get_drvdata(cpu_dai->dev);\n\tu32 val;\n\n\tspin_lock(&i2s->lock);\n\tif (on) {\n\t\t \n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval |= HII2S_I2S_CFG__S2_IF_TX_EN;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t} else {\n\t\t \n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval &= ~HII2S_I2S_CFG__S2_IF_TX_EN;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t}\n\tspin_unlock(&i2s->lock);\n}\n\nstatic void hi6210_i2s_rxctrl(struct snd_soc_dai *cpu_dai, int on)\n{\n\tstruct hi6210_i2s *i2s = dev_get_drvdata(cpu_dai->dev);\n\tu32 val;\n\n\tspin_lock(&i2s->lock);\n\tif (on) {\n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval |= HII2S_I2S_CFG__S2_IF_RX_EN;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t} else {\n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval &= ~HII2S_I2S_CFG__S2_IF_RX_EN;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t}\n\tspin_unlock(&i2s->lock);\n}\n\nstatic int hi6210_i2s_set_fmt(struct snd_soc_dai *cpu_dai, unsigned int fmt)\n{\n\tstruct hi6210_i2s *i2s = dev_get_drvdata(cpu_dai->dev);\n\n\t \n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BC_FC:\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\ti2s->format = fmt;\n\ti2s->master = (i2s->format & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) ==\n\t\t      SND_SOC_DAIFMT_BP_FP;\n\n\treturn 0;\n}\n\nstatic int hi6210_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t    struct snd_pcm_hw_params *params,\n\t\t\t    struct snd_soc_dai *cpu_dai)\n{\n\tstruct hi6210_i2s *i2s = dev_get_drvdata(cpu_dai->dev);\n\tu32 bits = 0, rate = 0, signed_data = 0, fmt = 0;\n\tu32 val;\n\tstruct snd_dmaengine_dai_dma_data *dma_data;\n\n\tswitch (params_format(params)) {\n\tcase SNDRV_PCM_FORMAT_U16_LE:\n\t\tsigned_data = HII2S_I2S_CFG__S2_CODEC_DATA_FORMAT;\n\t\tfallthrough;\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tbits = HII2S_BITS_16;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_U24_LE:\n\t\tsigned_data = HII2S_I2S_CFG__S2_CODEC_DATA_FORMAT;\n\t\tfallthrough;\n\tcase SNDRV_PCM_FORMAT_S24_LE:\n\t\tbits = HII2S_BITS_24;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(cpu_dai->dev, \"Bad format\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\n\tswitch (params_rate(params)) {\n\tcase 8000:\n\t\trate = HII2S_FS_RATE_8KHZ;\n\t\tbreak;\n\tcase 16000:\n\t\trate = HII2S_FS_RATE_16KHZ;\n\t\tbreak;\n\tcase 32000:\n\t\trate = HII2S_FS_RATE_32KHZ;\n\t\tbreak;\n\tcase 48000:\n\t\trate = HII2S_FS_RATE_48KHZ;\n\t\tbreak;\n\tcase 96000:\n\t\trate = HII2S_FS_RATE_96KHZ;\n\t\tbreak;\n\tcase 192000:\n\t\trate = HII2S_FS_RATE_192KHZ;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(cpu_dai->dev, \"Bad rate: %d\\n\", params_rate(params));\n\t\treturn -EINVAL;\n\t}\n\n\tif (!(params_channels(params))) {\n\t\tdev_err(cpu_dai->dev, \"Bad channels\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdma_data = snd_soc_dai_get_dma_data(cpu_dai, substream);\n\n\tswitch (bits) {\n\tcase HII2S_BITS_24:\n\t\ti2s->bits = 32;\n\t\tdma_data->addr_width = 3;\n\t\tbreak;\n\tdefault:\n\t\ti2s->bits = 16;\n\t\tdma_data->addr_width = 2;\n\t\tbreak;\n\t}\n\ti2s->rate = params_rate(params);\n\ti2s->channels = params_channels(params);\n\ti2s->channel_length = i2s->channels * i2s->bits;\n\n\tval = hi6210_read_reg(i2s, HII2S_ST_DL_FIFO_TH_CFG);\n\tval &= ~((HII2S_ST_DL_FIFO_TH_CFG__ST_DL_R_AEMPTY_MASK <<\n\t\t\tHII2S_ST_DL_FIFO_TH_CFG__ST_DL_R_AEMPTY_SHIFT) |\n\t\t(HII2S_ST_DL_FIFO_TH_CFG__ST_DL_R_AFULL_MASK <<\n\t\t\tHII2S_ST_DL_FIFO_TH_CFG__ST_DL_R_AFULL_SHIFT) |\n\t\t(HII2S_ST_DL_FIFO_TH_CFG__ST_DL_L_AEMPTY_MASK <<\n\t\t\tHII2S_ST_DL_FIFO_TH_CFG__ST_DL_L_AEMPTY_SHIFT) |\n\t\t(HII2S_ST_DL_FIFO_TH_CFG__ST_DL_L_AFULL_MASK <<\n\t\t\tHII2S_ST_DL_FIFO_TH_CFG__ST_DL_L_AFULL_SHIFT));\n\tval |= ((16 << HII2S_ST_DL_FIFO_TH_CFG__ST_DL_R_AEMPTY_SHIFT) |\n\t\t(30 << HII2S_ST_DL_FIFO_TH_CFG__ST_DL_R_AFULL_SHIFT) |\n\t\t(16 << HII2S_ST_DL_FIFO_TH_CFG__ST_DL_L_AEMPTY_SHIFT) |\n\t\t(30 << HII2S_ST_DL_FIFO_TH_CFG__ST_DL_L_AFULL_SHIFT));\n\thi6210_write_reg(i2s, HII2S_ST_DL_FIFO_TH_CFG, val);\n\n\n\tval = hi6210_read_reg(i2s, HII2S_IF_CLK_EN_CFG);\n\tval |= (BIT(19) | BIT(18) | BIT(17) |\n\t\tHII2S_IF_CLK_EN_CFG__S2_IF_CLK_EN |\n\t\tHII2S_IF_CLK_EN_CFG__S2_OL_MIXER_EN |\n\t\tHII2S_IF_CLK_EN_CFG__S2_OL_SRC_EN |\n\t\tHII2S_IF_CLK_EN_CFG__ST_DL_R_EN |\n\t\tHII2S_IF_CLK_EN_CFG__ST_DL_L_EN);\n\thi6210_write_reg(i2s, HII2S_IF_CLK_EN_CFG, val);\n\n\n\tval = hi6210_read_reg(i2s, HII2S_DIG_FILTER_CLK_EN_CFG);\n\tval &= ~(HII2S_DIG_FILTER_CLK_EN_CFG__DACR_SDM_EN |\n\t\t HII2S_DIG_FILTER_CLK_EN_CFG__DACR_HBF2I_EN |\n\t\t HII2S_DIG_FILTER_CLK_EN_CFG__DACR_AGC_EN |\n\t\t HII2S_DIG_FILTER_CLK_EN_CFG__DACL_SDM_EN |\n\t\t HII2S_DIG_FILTER_CLK_EN_CFG__DACL_HBF2I_EN |\n\t\t HII2S_DIG_FILTER_CLK_EN_CFG__DACL_AGC_EN);\n\tval |= (HII2S_DIG_FILTER_CLK_EN_CFG__DACR_MIXER_EN |\n\t\tHII2S_DIG_FILTER_CLK_EN_CFG__DACL_MIXER_EN);\n\thi6210_write_reg(i2s, HII2S_DIG_FILTER_CLK_EN_CFG, val);\n\n\n\tval = hi6210_read_reg(i2s, HII2S_DIG_FILTER_MODULE_CFG);\n\tval &= ~(HII2S_DIG_FILTER_MODULE_CFG__DACR_MIXER_IN2_MUTE |\n\t\t HII2S_DIG_FILTER_MODULE_CFG__DACL_MIXER_IN2_MUTE);\n\thi6210_write_reg(i2s, HII2S_DIG_FILTER_MODULE_CFG, val);\n\n\tval = hi6210_read_reg(i2s, HII2S_MUX_TOP_MODULE_CFG);\n\tval &= ~(HII2S_MUX_TOP_MODULE_CFG__S2_OL_MIXER_IN1_MUTE |\n\t\t HII2S_MUX_TOP_MODULE_CFG__S2_OL_MIXER_IN2_MUTE |\n\t\t HII2S_MUX_TOP_MODULE_CFG__VOICE_DLINK_MIXER_IN1_MUTE |\n\t\t HII2S_MUX_TOP_MODULE_CFG__VOICE_DLINK_MIXER_IN2_MUTE);\n\thi6210_write_reg(i2s, HII2S_MUX_TOP_MODULE_CFG, val);\n\n\n\tswitch (i2s->format & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BC_FC:\n\t\ti2s->master = false;\n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval |= HII2S_I2S_CFG__S2_MST_SLV;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\ti2s->master = true;\n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval &= ~HII2S_I2S_CFG__S2_MST_SLV;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ONCE(1, \"Invalid i2s->fmt CLOCK_PROVIDER_MASK. This shouldn't happen\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (i2s->format & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tfmt = HII2S_FORMAT_I2S;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_LEFT_J:\n\t\tfmt = HII2S_FORMAT_LEFT_JUST;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_RIGHT_J:\n\t\tfmt = HII2S_FORMAT_RIGHT_JUST;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ONCE(1, \"Invalid i2s->fmt FORMAT_MASK. This shouldn't happen\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\tval &= ~(HII2S_I2S_CFG__S2_FUNC_MODE_MASK <<\n\t\t\tHII2S_I2S_CFG__S2_FUNC_MODE_SHIFT);\n\tval |= fmt << HII2S_I2S_CFG__S2_FUNC_MODE_SHIFT;\n\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\n\n\tval = hi6210_read_reg(i2s, HII2S_CLK_SEL);\n\tval &= ~(HII2S_CLK_SEL__I2S_BT_FM_SEL |  \n\t\t\tHII2S_CLK_SEL__EXT_12_288MHZ_SEL);\n\thi6210_write_reg(i2s, HII2S_CLK_SEL, val);\n\n\tdma_data->maxburst = 2;\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tdma_data->addr = i2s->base_phys + HII2S_ST_DL_CHANNEL;\n\telse\n\t\tdma_data->addr = i2s->base_phys + HII2S_STEREO_UPLINK_CHANNEL;\n\n\tswitch (i2s->channels) {\n\tcase 1:\n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval |= HII2S_I2S_CFG__S2_FRAME_MODE;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t\tbreak;\n\tdefault:\n\t\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\t\tval &= ~HII2S_I2S_CFG__S2_FRAME_MODE;\n\t\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\t\tbreak;\n\t}\n\n\t \n\tval = hi6210_read_reg(i2s, HII2S_I2S_CFG);\n\tval &= ~HII2S_I2S_CFG__S2_CODEC_DATA_FORMAT;\n\tval &= ~(HII2S_I2S_CFG__S2_CODEC_IO_WORDLENGTH_MASK <<\n\t\t\tHII2S_I2S_CFG__S2_CODEC_IO_WORDLENGTH_SHIFT);\n\tval &= ~(HII2S_I2S_CFG__S2_DIRECT_LOOP_MASK <<\n\t\t\tHII2S_I2S_CFG__S2_DIRECT_LOOP_SHIFT);\n\tval |= signed_data;\n\tval |= (bits << HII2S_I2S_CFG__S2_CODEC_IO_WORDLENGTH_SHIFT);\n\thi6210_write_reg(i2s, HII2S_I2S_CFG, val);\n\n\n\tif (!i2s->master)\n\t\treturn 0;\n\n\t \n\tval = hi6210_read_reg(i2s, HII2S_FS_CFG);\n\tval &= ~(HII2S_FS_CFG__FS_S2_MASK << HII2S_FS_CFG__FS_S2_SHIFT);\n\tval &= ~(HII2S_FS_CFG__FS_DACLR_MASK << HII2S_FS_CFG__FS_DACLR_SHIFT);\n\tval &= ~(HII2S_FS_CFG__FS_ST_DL_R_MASK <<\n\t\t\t\t\tHII2S_FS_CFG__FS_ST_DL_R_SHIFT);\n\tval &= ~(HII2S_FS_CFG__FS_ST_DL_L_MASK <<\n\t\t\t\t\tHII2S_FS_CFG__FS_ST_DL_L_SHIFT);\n\tval |= (rate << HII2S_FS_CFG__FS_S2_SHIFT);\n\tval |= (rate << HII2S_FS_CFG__FS_DACLR_SHIFT);\n\tval |= (rate << HII2S_FS_CFG__FS_ST_DL_R_SHIFT);\n\tval |= (rate << HII2S_FS_CFG__FS_ST_DL_L_SHIFT);\n\thi6210_write_reg(i2s, HII2S_FS_CFG, val);\n\n\treturn 0;\n}\n\nstatic int hi6210_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t\t  struct snd_soc_dai *cpu_dai)\n{\n\tpr_debug(\"%s\\n\", __func__);\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\t\thi6210_i2s_rxctrl(cpu_dai, 1);\n\t\telse\n\t\t\thi6210_i2s_txctrl(cpu_dai, 1);\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\t\thi6210_i2s_rxctrl(cpu_dai, 0);\n\t\telse\n\t\t\thi6210_i2s_txctrl(cpu_dai, 0);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(cpu_dai->dev, \"unknown cmd\\n\");\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int hi6210_i2s_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct hi6210_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tsnd_soc_dai_init_dma_data(dai,\n\t\t\t\t  &i2s->dma_data[SNDRV_PCM_STREAM_PLAYBACK],\n\t\t\t\t  &i2s->dma_data[SNDRV_PCM_STREAM_CAPTURE]);\n\n\treturn 0;\n}\n\n\nstatic const struct snd_soc_dai_ops hi6210_i2s_dai_ops = {\n\t.probe\t\t= hi6210_i2s_dai_probe,\n\t.trigger\t= hi6210_i2s_trigger,\n\t.hw_params\t= hi6210_i2s_hw_params,\n\t.set_fmt\t= hi6210_i2s_set_fmt,\n\t.startup\t= hi6210_i2s_startup,\n\t.shutdown\t= hi6210_i2s_shutdown,\n};\n\nstatic const struct snd_soc_dai_driver hi6210_i2s_dai_init = {\n\t.playback = {\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE |\n\t\t\t   SNDRV_PCM_FMTBIT_U16_LE,\n\t\t.rates = SNDRV_PCM_RATE_48000,\n\t},\n\t.capture = {\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE |\n\t\t\t   SNDRV_PCM_FMTBIT_U16_LE,\n\t\t.rates = SNDRV_PCM_RATE_48000,\n\t},\n\t.ops = &hi6210_i2s_dai_ops,\n};\n\nstatic const struct snd_soc_component_driver hi6210_i2s_i2s_comp = {\n\t.name = \"hi6210_i2s-i2s\",\n\t.legacy_dai_naming = 1,\n};\n\nstatic int hi6210_i2s_probe(struct platform_device *pdev)\n{\n\tstruct device_node *node = pdev->dev.of_node;\n\tstruct device *dev = &pdev->dev;\n\tstruct hi6210_i2s *i2s;\n\tstruct resource *res;\n\tint ret;\n\n\ti2s = devm_kzalloc(dev, sizeof(*i2s), GFP_KERNEL);\n\tif (!i2s)\n\t\treturn -ENOMEM;\n\n\ti2s->dev = dev;\n\tspin_lock_init(&i2s->lock);\n\n\ti2s->base = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(i2s->base))\n\t\treturn PTR_ERR(i2s->base);\n\n\ti2s->base_phys = (phys_addr_t)res->start;\n\ti2s->dai = hi6210_i2s_dai_init;\n\n\tdev_set_drvdata(dev, i2s);\n\n\ti2s->sysctrl = syscon_regmap_lookup_by_phandle(node,\n\t\t\t\t\t\t\"hisilicon,sysctrl-syscon\");\n\tif (IS_ERR(i2s->sysctrl))\n\t\treturn PTR_ERR(i2s->sysctrl);\n\n\ti2s->clk[CLK_DACODEC] = devm_clk_get(dev, \"dacodec\");\n\tif (IS_ERR(i2s->clk[CLK_DACODEC]))\n\t\treturn PTR_ERR(i2s->clk[CLK_DACODEC]);\n\ti2s->clocks++;\n\n\ti2s->clk[CLK_I2S_BASE] = devm_clk_get(dev, \"i2s-base\");\n\tif (IS_ERR(i2s->clk[CLK_I2S_BASE]))\n\t\treturn PTR_ERR(i2s->clk[CLK_I2S_BASE]);\n\ti2s->clocks++;\n\n\tret = devm_snd_dmaengine_pcm_register(dev, NULL, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_snd_soc_register_component(dev, &hi6210_i2s_i2s_comp,\n\t\t\t\t\t &i2s->dai, 1);\n\treturn ret;\n}\n\nstatic const struct of_device_id hi6210_i2s_dt_ids[] = {\n\t{ .compatible = \"hisilicon,hi6210-i2s\" },\n\t{   }\n};\n\nMODULE_DEVICE_TABLE(of, hi6210_i2s_dt_ids);\n\nstatic struct platform_driver hi6210_i2s_driver = {\n\t.probe = hi6210_i2s_probe,\n\t.driver = {\n\t\t.name = \"hi6210_i2s\",\n\t\t.of_match_table = hi6210_i2s_dt_ids,\n\t},\n};\n\nmodule_platform_driver(hi6210_i2s_driver);\n\nMODULE_DESCRIPTION(\"Hisilicon HI6210 I2S driver\");\nMODULE_AUTHOR(\"Andy Green <andy.green@linaro.org>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}