{
  "module_name": "jz4740-i2s.c",
  "hash_id": "8be577bb7b5497bd40980d99538098d3694f3b19b3f6f3a1319fbd56baa6eaba",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/jz4740/jz4740-i2s.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/dma-mapping.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/initval.h>\n#include <sound/dmaengine_pcm.h>\n\n#define JZ_REG_AIC_CONF\t\t0x00\n#define JZ_REG_AIC_CTRL\t\t0x04\n#define JZ_REG_AIC_I2S_FMT\t0x10\n#define JZ_REG_AIC_FIFO_STATUS\t0x14\n#define JZ_REG_AIC_I2S_STATUS\t0x1c\n#define JZ_REG_AIC_CLK_DIV\t0x30\n#define JZ_REG_AIC_FIFO\t\t0x34\n\n#define JZ_AIC_CONF_OVERFLOW_PLAY_LAST\tBIT(6)\n#define JZ_AIC_CONF_INTERNAL_CODEC\tBIT(5)\n#define JZ_AIC_CONF_I2S\t\t\tBIT(4)\n#define JZ_AIC_CONF_RESET\t\tBIT(3)\n#define JZ_AIC_CONF_BIT_CLK_MASTER\tBIT(2)\n#define JZ_AIC_CONF_SYNC_CLK_MASTER\tBIT(1)\n#define JZ_AIC_CONF_ENABLE\t\tBIT(0)\n\n#define JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE\tGENMASK(21, 19)\n#define JZ_AIC_CTRL_INPUT_SAMPLE_SIZE\tGENMASK(18, 16)\n#define JZ_AIC_CTRL_ENABLE_RX_DMA\tBIT(15)\n#define JZ_AIC_CTRL_ENABLE_TX_DMA\tBIT(14)\n#define JZ_AIC_CTRL_MONO_TO_STEREO\tBIT(11)\n#define JZ_AIC_CTRL_SWITCH_ENDIANNESS\tBIT(10)\n#define JZ_AIC_CTRL_SIGNED_TO_UNSIGNED\tBIT(9)\n#define JZ_AIC_CTRL_TFLUSH\t\tBIT(8)\n#define JZ_AIC_CTRL_RFLUSH\t\tBIT(7)\n#define JZ_AIC_CTRL_ENABLE_ROR_INT\tBIT(6)\n#define JZ_AIC_CTRL_ENABLE_TUR_INT\tBIT(5)\n#define JZ_AIC_CTRL_ENABLE_RFS_INT\tBIT(4)\n#define JZ_AIC_CTRL_ENABLE_TFS_INT\tBIT(3)\n#define JZ_AIC_CTRL_ENABLE_LOOPBACK\tBIT(2)\n#define JZ_AIC_CTRL_ENABLE_PLAYBACK\tBIT(1)\n#define JZ_AIC_CTRL_ENABLE_CAPTURE\tBIT(0)\n\n#define JZ_AIC_I2S_FMT_DISABLE_BIT_CLK\tBIT(12)\n#define JZ_AIC_I2S_FMT_DISABLE_BIT_ICLK\tBIT(13)\n#define JZ_AIC_I2S_FMT_ENABLE_SYS_CLK\tBIT(4)\n#define JZ_AIC_I2S_FMT_MSB\t\tBIT(0)\n\n#define JZ_AIC_I2S_STATUS_BUSY\t\tBIT(2)\n\nstruct i2s_soc_info {\n\tstruct snd_soc_dai_driver *dai;\n\n\tstruct reg_field field_rx_fifo_thresh;\n\tstruct reg_field field_tx_fifo_thresh;\n\tstruct reg_field field_i2sdiv_capture;\n\tstruct reg_field field_i2sdiv_playback;\n\n\tbool shared_fifo_flush;\n};\n\nstruct jz4740_i2s {\n\tstruct regmap *regmap;\n\n\tstruct regmap_field *field_rx_fifo_thresh;\n\tstruct regmap_field *field_tx_fifo_thresh;\n\tstruct regmap_field *field_i2sdiv_capture;\n\tstruct regmap_field *field_i2sdiv_playback;\n\n\tstruct clk *clk_aic;\n\tstruct clk *clk_i2s;\n\n\tstruct snd_dmaengine_dai_dma_data playback_dma_data;\n\tstruct snd_dmaengine_dai_dma_data capture_dma_data;\n\n\tconst struct i2s_soc_info *soc_info;\n};\n\nstatic int jz4740_i2s_startup(struct snd_pcm_substream *substream,\n\tstruct snd_soc_dai *dai)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tint ret;\n\n\t \n\tif (!i2s->soc_info->shared_fifo_flush) {\n\t\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\t\tregmap_set_bits(i2s->regmap, JZ_REG_AIC_CTRL, JZ_AIC_CTRL_TFLUSH);\n\t\telse\n\t\t\tregmap_set_bits(i2s->regmap, JZ_REG_AIC_CTRL, JZ_AIC_CTRL_RFLUSH);\n\t}\n\n\tif (snd_soc_dai_active(dai))\n\t\treturn 0;\n\n\t \n\tif (i2s->soc_info->shared_fifo_flush)\n\t\tregmap_set_bits(i2s->regmap, JZ_REG_AIC_CTRL, JZ_AIC_CTRL_TFLUSH);\n\n\tret = clk_prepare_enable(i2s->clk_i2s);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_set_bits(i2s->regmap, JZ_REG_AIC_CONF, JZ_AIC_CONF_ENABLE);\n\treturn 0;\n}\n\nstatic void jz4740_i2s_shutdown(struct snd_pcm_substream *substream,\n\tstruct snd_soc_dai *dai)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tif (snd_soc_dai_active(dai))\n\t\treturn;\n\n\tregmap_clear_bits(i2s->regmap, JZ_REG_AIC_CONF, JZ_AIC_CONF_ENABLE);\n\n\tclk_disable_unprepare(i2s->clk_i2s);\n}\n\nstatic int jz4740_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\n\tstruct snd_soc_dai *dai)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tuint32_t mask;\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tmask = JZ_AIC_CTRL_ENABLE_PLAYBACK | JZ_AIC_CTRL_ENABLE_TX_DMA;\n\telse\n\t\tmask = JZ_AIC_CTRL_ENABLE_CAPTURE | JZ_AIC_CTRL_ENABLE_RX_DMA;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tregmap_set_bits(i2s->regmap, JZ_REG_AIC_CTRL, mask);\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tregmap_clear_bits(i2s->regmap, JZ_REG_AIC_CTRL, mask);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int jz4740_i2s_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tconst unsigned int conf_mask = JZ_AIC_CONF_BIT_CLK_MASTER |\n\t\t\t\t       JZ_AIC_CONF_SYNC_CLK_MASTER;\n\tunsigned int conf = 0, format = 0;\n\n\tswitch (fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\tconf |= JZ_AIC_CONF_BIT_CLK_MASTER | JZ_AIC_CONF_SYNC_CLK_MASTER;\n\t\tformat |= JZ_AIC_I2S_FMT_ENABLE_SYS_CLK;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_BC_FP:\n\t\tconf |= JZ_AIC_CONF_SYNC_CLK_MASTER;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_BP_FC:\n\t\tconf |= JZ_AIC_CONF_BIT_CLK_MASTER;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_BC_FC:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\n\tcase SND_SOC_DAIFMT_MSB:\n\t\tformat |= JZ_AIC_I2S_FMT_MSB;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_I2S:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\n\tcase SND_SOC_DAIFMT_NB_NF:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(i2s->regmap, JZ_REG_AIC_CONF, conf_mask, conf);\n\tregmap_write(i2s->regmap, JZ_REG_AIC_I2S_FMT, format);\n\n\treturn 0;\n}\n\nstatic int jz4740_i2s_get_i2sdiv(unsigned long mclk, unsigned long rate,\n\t\t\t\t unsigned long i2sdiv_max)\n{\n\tunsigned long div, rate1, rate2, err1, err2;\n\n\tdiv = mclk / (64 * rate);\n\tif (div == 0)\n\t\tdiv = 1;\n\n\trate1 = mclk / (64 * div);\n\trate2 = mclk / (64 * (div + 1));\n\n\terr1 = abs(rate1 - rate);\n\terr2 = abs(rate2 - rate);\n\n\t \n\tif (div <= i2sdiv_max && err1 <= err2 && err1 < rate/20)\n\t\treturn div;\n\tif (div < i2sdiv_max && err2 < rate/20)\n\t\treturn div + 1;\n\n\treturn -EINVAL;\n}\n\nstatic int jz4740_i2s_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\tstruct regmap_field *div_field;\n\tunsigned long i2sdiv_max;\n\tunsigned int sample_size;\n\tuint32_t ctrl, conf;\n\tint div = 1;\n\n\tregmap_read(i2s->regmap, JZ_REG_AIC_CTRL, &ctrl);\n\tregmap_read(i2s->regmap, JZ_REG_AIC_CONF, &conf);\n\n\tswitch (params_format(params)) {\n\tcase SNDRV_PCM_FORMAT_S8:\n\t\tsample_size = 0;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tsample_size = 1;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S20_LE:\n\t\tsample_size = 3;\n\t\tbreak;\n\tcase SNDRV_PCM_FORMAT_S24_LE:\n\t\tsample_size = 4;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\n\t\tctrl &= ~JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE;\n\t\tctrl |= FIELD_PREP(JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE, sample_size);\n\n\t\tif (params_channels(params) == 1)\n\t\t\tctrl |= JZ_AIC_CTRL_MONO_TO_STEREO;\n\t\telse\n\t\t\tctrl &= ~JZ_AIC_CTRL_MONO_TO_STEREO;\n\n\t\tdiv_field = i2s->field_i2sdiv_playback;\n\t\ti2sdiv_max = GENMASK(i2s->soc_info->field_i2sdiv_playback.msb,\n\t\t\t\t     i2s->soc_info->field_i2sdiv_playback.lsb);\n\t} else {\n\t\tctrl &= ~JZ_AIC_CTRL_INPUT_SAMPLE_SIZE;\n\t\tctrl |= FIELD_PREP(JZ_AIC_CTRL_INPUT_SAMPLE_SIZE, sample_size);\n\n\t\tdiv_field = i2s->field_i2sdiv_capture;\n\t\ti2sdiv_max = GENMASK(i2s->soc_info->field_i2sdiv_capture.msb,\n\t\t\t\t     i2s->soc_info->field_i2sdiv_capture.lsb);\n\t}\n\n\t \n\tif (conf & (JZ_AIC_CONF_BIT_CLK_MASTER | JZ_AIC_CONF_SYNC_CLK_MASTER)) {\n\t\tdiv = jz4740_i2s_get_i2sdiv(clk_get_rate(i2s->clk_i2s),\n\t\t\t\t\t    params_rate(params), i2sdiv_max);\n\t\tif (div < 0)\n\t\t\treturn div;\n\t}\n\n\tregmap_write(i2s->regmap, JZ_REG_AIC_CTRL, ctrl);\n\tregmap_field_write(div_field, div - 1);\n\n\treturn 0;\n}\n\nstatic int jz4740_i2s_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\n\n\tsnd_soc_dai_init_dma_data(dai, &i2s->playback_dma_data,\n\t\t&i2s->capture_dma_data);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops jz4740_i2s_dai_ops = {\n\t.probe = jz4740_i2s_dai_probe,\n\t.startup = jz4740_i2s_startup,\n\t.shutdown = jz4740_i2s_shutdown,\n\t.trigger = jz4740_i2s_trigger,\n\t.hw_params = jz4740_i2s_hw_params,\n\t.set_fmt = jz4740_i2s_set_fmt,\n};\n\n#define JZ4740_I2S_FMTS (SNDRV_PCM_FMTBIT_S8 | \\\n\t\t\t SNDRV_PCM_FMTBIT_S16_LE | \\\n\t\t\t SNDRV_PCM_FMTBIT_S20_LE | \\\n\t\t\t SNDRV_PCM_FMTBIT_S24_LE)\n\nstatic struct snd_soc_dai_driver jz4740_i2s_dai = {\n\t.playback = {\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_CONTINUOUS,\n\t\t.formats = JZ4740_I2S_FMTS,\n\t},\n\t.capture = {\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_CONTINUOUS,\n\t\t.formats = JZ4740_I2S_FMTS,\n\t},\n\t.symmetric_rate = 1,\n\t.ops = &jz4740_i2s_dai_ops,\n};\n\nstatic const struct i2s_soc_info jz4740_i2s_soc_info = {\n\t.dai\t\t\t= &jz4740_i2s_dai,\n\t.field_rx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 12, 15),\n\t.field_tx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 8, 11),\n\t.field_i2sdiv_capture\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 3),\n\t.field_i2sdiv_playback\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 3),\n\t.shared_fifo_flush\t= true,\n};\n\nstatic const struct i2s_soc_info jz4760_i2s_soc_info = {\n\t.dai\t\t\t= &jz4740_i2s_dai,\n\t.field_rx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 24, 27),\n\t.field_tx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 16, 20),\n\t.field_i2sdiv_capture\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 3),\n\t.field_i2sdiv_playback\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 3),\n};\n\nstatic const struct i2s_soc_info x1000_i2s_soc_info = {\n\t.dai = &jz4740_i2s_dai,\n\t.field_rx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 24, 27),\n\t.field_tx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 16, 20),\n\t.field_i2sdiv_capture\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 8),\n\t.field_i2sdiv_playback\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 8),\n};\n\nstatic struct snd_soc_dai_driver jz4770_i2s_dai = {\n\t.playback = {\n\t\t.channels_min = 1,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_CONTINUOUS,\n\t\t.formats = JZ4740_I2S_FMTS,\n\t},\n\t.capture = {\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = SNDRV_PCM_RATE_CONTINUOUS,\n\t\t.formats = JZ4740_I2S_FMTS,\n\t},\n\t.ops = &jz4740_i2s_dai_ops,\n};\n\nstatic const struct i2s_soc_info jz4770_i2s_soc_info = {\n\t.dai\t\t\t= &jz4770_i2s_dai,\n\t.field_rx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 24, 27),\n\t.field_tx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 16, 20),\n\t.field_i2sdiv_capture\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 8, 11),\n\t.field_i2sdiv_playback\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 3),\n};\n\nstatic const struct i2s_soc_info jz4780_i2s_soc_info = {\n\t.dai\t\t\t= &jz4770_i2s_dai,\n\t.field_rx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 24, 27),\n\t.field_tx_fifo_thresh\t= REG_FIELD(JZ_REG_AIC_CONF, 16, 20),\n\t.field_i2sdiv_capture\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 8, 11),\n\t.field_i2sdiv_playback\t= REG_FIELD(JZ_REG_AIC_CLK_DIV, 0, 3),\n};\n\nstatic int jz4740_i2s_suspend(struct snd_soc_component *component)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_component_get_drvdata(component);\n\n\tif (snd_soc_component_active(component)) {\n\t\tregmap_clear_bits(i2s->regmap, JZ_REG_AIC_CONF, JZ_AIC_CONF_ENABLE);\n\t\tclk_disable_unprepare(i2s->clk_i2s);\n\t}\n\n\tclk_disable_unprepare(i2s->clk_aic);\n\n\treturn 0;\n}\n\nstatic int jz4740_i2s_resume(struct snd_soc_component *component)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = clk_prepare_enable(i2s->clk_aic);\n\tif (ret)\n\t\treturn ret;\n\n\tif (snd_soc_component_active(component)) {\n\t\tret = clk_prepare_enable(i2s->clk_i2s);\n\t\tif (ret) {\n\t\t\tclk_disable_unprepare(i2s->clk_aic);\n\t\t\treturn ret;\n\t\t}\n\n\t\tregmap_set_bits(i2s->regmap, JZ_REG_AIC_CONF, JZ_AIC_CONF_ENABLE);\n\t}\n\n\treturn 0;\n}\n\nstatic int jz4740_i2s_probe(struct snd_soc_component *component)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_component_get_drvdata(component);\n\tint ret;\n\n\tret = clk_prepare_enable(i2s->clk_aic);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_write(i2s->regmap, JZ_REG_AIC_CONF, JZ_AIC_CONF_RESET);\n\n\tregmap_write(i2s->regmap, JZ_REG_AIC_CONF,\n\t\t     JZ_AIC_CONF_OVERFLOW_PLAY_LAST |\n\t\t     JZ_AIC_CONF_I2S | JZ_AIC_CONF_INTERNAL_CODEC);\n\n\tregmap_field_write(i2s->field_rx_fifo_thresh, 7);\n\tregmap_field_write(i2s->field_tx_fifo_thresh, 8);\n\n\treturn 0;\n}\n\nstatic void jz4740_i2s_remove(struct snd_soc_component *component)\n{\n\tstruct jz4740_i2s *i2s = snd_soc_component_get_drvdata(component);\n\n\tclk_disable_unprepare(i2s->clk_aic);\n}\n\nstatic const struct snd_soc_component_driver jz4740_i2s_component = {\n\t.name\t\t\t= \"jz4740-i2s\",\n\t.probe\t\t\t= jz4740_i2s_probe,\n\t.remove\t\t\t= jz4740_i2s_remove,\n\t.suspend\t\t= jz4740_i2s_suspend,\n\t.resume\t\t\t= jz4740_i2s_resume,\n\t.legacy_dai_naming\t= 1,\n};\n\nstatic const struct of_device_id jz4740_of_matches[] = {\n\t{ .compatible = \"ingenic,jz4740-i2s\", .data = &jz4740_i2s_soc_info },\n\t{ .compatible = \"ingenic,jz4760-i2s\", .data = &jz4760_i2s_soc_info },\n\t{ .compatible = \"ingenic,jz4770-i2s\", .data = &jz4770_i2s_soc_info },\n\t{ .compatible = \"ingenic,jz4780-i2s\", .data = &jz4780_i2s_soc_info },\n\t{ .compatible = \"ingenic,x1000-i2s\", .data = &x1000_i2s_soc_info },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, jz4740_of_matches);\n\nstatic int jz4740_i2s_init_regmap_fields(struct device *dev,\n\t\t\t\t\t struct jz4740_i2s *i2s)\n{\n\ti2s->field_rx_fifo_thresh =\n\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\ti2s->soc_info->field_rx_fifo_thresh);\n\tif (IS_ERR(i2s->field_rx_fifo_thresh))\n\t\treturn PTR_ERR(i2s->field_rx_fifo_thresh);\n\n\ti2s->field_tx_fifo_thresh =\n\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\ti2s->soc_info->field_tx_fifo_thresh);\n\tif (IS_ERR(i2s->field_tx_fifo_thresh))\n\t\treturn PTR_ERR(i2s->field_tx_fifo_thresh);\n\n\ti2s->field_i2sdiv_capture =\n\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\ti2s->soc_info->field_i2sdiv_capture);\n\tif (IS_ERR(i2s->field_i2sdiv_capture))\n\t\treturn PTR_ERR(i2s->field_i2sdiv_capture);\n\n\ti2s->field_i2sdiv_playback =\n\t\tdevm_regmap_field_alloc(dev, i2s->regmap,\n\t\t\t\t\ti2s->soc_info->field_i2sdiv_playback);\n\tif (IS_ERR(i2s->field_i2sdiv_playback))\n\t\treturn PTR_ERR(i2s->field_i2sdiv_playback);\n\n\treturn 0;\n}\n\nstatic const struct regmap_config jz4740_i2s_regmap_config = {\n\t.reg_bits\t= 32,\n\t.reg_stride\t= 4,\n\t.val_bits\t= 32,\n\t.max_register\t= JZ_REG_AIC_FIFO,\n};\n\nstatic int jz4740_i2s_dev_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct jz4740_i2s *i2s;\n\tstruct resource *mem;\n\tvoid __iomem *regs;\n\tint ret;\n\n\ti2s = devm_kzalloc(dev, sizeof(*i2s), GFP_KERNEL);\n\tif (!i2s)\n\t\treturn -ENOMEM;\n\n\ti2s->soc_info = device_get_match_data(dev);\n\n\tregs = devm_platform_get_and_ioremap_resource(pdev, 0, &mem);\n\tif (IS_ERR(regs))\n\t\treturn PTR_ERR(regs);\n\n\ti2s->playback_dma_data.maxburst = 16;\n\ti2s->playback_dma_data.addr = mem->start + JZ_REG_AIC_FIFO;\n\n\ti2s->capture_dma_data.maxburst = 16;\n\ti2s->capture_dma_data.addr = mem->start + JZ_REG_AIC_FIFO;\n\n\ti2s->clk_aic = devm_clk_get(dev, \"aic\");\n\tif (IS_ERR(i2s->clk_aic))\n\t\treturn PTR_ERR(i2s->clk_aic);\n\n\ti2s->clk_i2s = devm_clk_get(dev, \"i2s\");\n\tif (IS_ERR(i2s->clk_i2s))\n\t\treturn PTR_ERR(i2s->clk_i2s);\n\n\ti2s->regmap = devm_regmap_init_mmio(&pdev->dev, regs,\n\t\t\t\t\t    &jz4740_i2s_regmap_config);\n\tif (IS_ERR(i2s->regmap))\n\t\treturn PTR_ERR(i2s->regmap);\n\n\tret = jz4740_i2s_init_regmap_fields(dev, i2s);\n\tif (ret)\n\t\treturn ret;\n\n\tplatform_set_drvdata(pdev, i2s);\n\n\tret = devm_snd_soc_register_component(dev, &jz4740_i2s_component,\n\t\t\t\t\t      i2s->soc_info->dai, 1);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_snd_dmaengine_pcm_register(dev, NULL,\n\t\tSND_DMAENGINE_PCM_FLAG_COMPAT);\n}\n\nstatic struct platform_driver jz4740_i2s_driver = {\n\t.probe = jz4740_i2s_dev_probe,\n\t.driver = {\n\t\t.name = \"jz4740-i2s\",\n\t\t.of_match_table = jz4740_of_matches,\n\t},\n};\n\nmodule_platform_driver(jz4740_i2s_driver);\n\nMODULE_AUTHOR(\"Lars-Peter Clausen, <lars@metafoo.de>\");\nMODULE_DESCRIPTION(\"Ingenic JZ4740 SoC I2S driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:jz4740-i2s\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}