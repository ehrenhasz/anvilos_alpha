{
  "module_name": "rx51.c",
  "hash_id": "fb9c1a630c0b9cd00346f2d2c0af1e082a08857b7d22f8d40ae34b16d648eac9",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/ti/rx51.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gpio.h>\n#include <linux/platform_device.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n#include <linux/platform_data/asoc-ti-mcbsp.h>\n\n#include <asm/mach-types.h>\n\n#include \"omap-mcbsp.h\"\n\nenum {\n\tRX51_JACK_DISABLED,\n\tRX51_JACK_TVOUT,\t\t \n\tRX51_JACK_HP,\t\t\t \n\tRX51_JACK_HS,\t\t\t \n};\n\nstruct rx51_audio_pdata {\n\tstruct gpio_desc *tvout_selection_gpio;\n\tstruct gpio_desc *jack_detection_gpio;\n\tstruct gpio_desc *eci_sw_gpio;\n\tstruct gpio_desc *speaker_amp_gpio;\n};\n\nstatic int rx51_spk_func;\nstatic int rx51_dmic_func;\nstatic int rx51_jack_func;\n\nstatic void rx51_ext_control(struct snd_soc_dapm_context *dapm)\n{\n\tstruct snd_soc_card *card = dapm->card;\n\tstruct rx51_audio_pdata *pdata = snd_soc_card_get_drvdata(card);\n\tint hp = 0, hs = 0, tvout = 0;\n\n\tswitch (rx51_jack_func) {\n\tcase RX51_JACK_TVOUT:\n\t\ttvout = 1;\n\t\thp = 1;\n\t\tbreak;\n\tcase RX51_JACK_HS:\n\t\ths = 1;\n\t\tfallthrough;\n\tcase RX51_JACK_HP:\n\t\thp = 1;\n\t\tbreak;\n\t}\n\n\tsnd_soc_dapm_mutex_lock(dapm);\n\n\tif (rx51_spk_func)\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Ext Spk\");\n\telse\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Ext Spk\");\n\tif (rx51_dmic_func)\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"DMic\");\n\telse\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"DMic\");\n\tif (hp)\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"Headphone Jack\");\n\telse\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"Headphone Jack\");\n\tif (hs)\n\t\tsnd_soc_dapm_enable_pin_unlocked(dapm, \"HS Mic\");\n\telse\n\t\tsnd_soc_dapm_disable_pin_unlocked(dapm, \"HS Mic\");\n\n\tgpiod_set_value(pdata->tvout_selection_gpio, tvout);\n\n\tsnd_soc_dapm_sync_unlocked(dapm);\n\n\tsnd_soc_dapm_mutex_unlock(dapm);\n}\n\nstatic int rx51_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_card *card = rtd->card;\n\n\tsnd_pcm_hw_constraint_single(runtime, SNDRV_PCM_HW_PARAM_CHANNELS, 2);\n\trx51_ext_control(&card->dapm);\n\n\treturn 0;\n}\n\nstatic int rx51_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\n\t \n\treturn snd_soc_dai_set_sysclk(codec_dai, 0, 19200000,\n\t\t\t\t      SND_SOC_CLOCK_IN);\n}\n\nstatic const struct snd_soc_ops rx51_ops = {\n\t.startup = rx51_startup,\n\t.hw_params = rx51_hw_params,\n};\n\nstatic int rx51_get_spk(struct snd_kcontrol *kcontrol,\n\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tucontrol->value.enumerated.item[0] = rx51_spk_func;\n\n\treturn 0;\n}\n\nstatic int rx51_set_spk(struct snd_kcontrol *kcontrol,\n\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\n\tif (rx51_spk_func == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\trx51_spk_func = ucontrol->value.enumerated.item[0];\n\trx51_ext_control(&card->dapm);\n\n\treturn 1;\n}\n\nstatic int rx51_spk_event(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *k, int event)\n{\n\tstruct snd_soc_dapm_context *dapm = w->dapm;\n\tstruct snd_soc_card *card = dapm->card;\n\tstruct rx51_audio_pdata *pdata = snd_soc_card_get_drvdata(card);\n\n\tgpiod_set_raw_value_cansleep(pdata->speaker_amp_gpio,\n\t\t\t\t     !!SND_SOC_DAPM_EVENT_ON(event));\n\n\treturn 0;\n}\n\nstatic int rx51_get_input(struct snd_kcontrol *kcontrol,\n\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tucontrol->value.enumerated.item[0] = rx51_dmic_func;\n\n\treturn 0;\n}\n\nstatic int rx51_set_input(struct snd_kcontrol *kcontrol,\n\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\n\tif (rx51_dmic_func == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\trx51_dmic_func = ucontrol->value.enumerated.item[0];\n\trx51_ext_control(&card->dapm);\n\n\treturn 1;\n}\n\nstatic int rx51_get_jack(struct snd_kcontrol *kcontrol,\n\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tucontrol->value.enumerated.item[0] = rx51_jack_func;\n\n\treturn 0;\n}\n\nstatic int rx51_set_jack(struct snd_kcontrol *kcontrol,\n\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\n\tif (rx51_jack_func == ucontrol->value.enumerated.item[0])\n\t\treturn 0;\n\n\trx51_jack_func = ucontrol->value.enumerated.item[0];\n\trx51_ext_control(&card->dapm);\n\n\treturn 1;\n}\n\nstatic struct snd_soc_jack rx51_av_jack;\n\nstatic struct snd_soc_jack_gpio rx51_av_jack_gpios[] = {\n\t{\n\t\t.name = \"avdet-gpio\",\n\t\t.report = SND_JACK_HEADSET,\n\t\t.invert = 1,\n\t\t.debounce_time = 200,\n\t},\n};\n\nstatic const struct snd_soc_dapm_widget aic34_dapm_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", rx51_spk_event),\n\tSND_SOC_DAPM_MIC(\"DMic\", NULL),\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"HS Mic\", NULL),\n\tSND_SOC_DAPM_LINE(\"FM Transmitter\", NULL),\n\tSND_SOC_DAPM_SPK(\"Earphone\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route audio_map[] = {\n\t{\"Ext Spk\", NULL, \"HPLOUT\"},\n\t{\"Ext Spk\", NULL, \"HPROUT\"},\n\t{\"Ext Spk\", NULL, \"HPLCOM\"},\n\t{\"Ext Spk\", NULL, \"HPRCOM\"},\n\t{\"FM Transmitter\", NULL, \"LLOUT\"},\n\t{\"FM Transmitter\", NULL, \"RLOUT\"},\n\n\t{\"Headphone Jack\", NULL, \"TPA6130A2 HPLEFT\"},\n\t{\"Headphone Jack\", NULL, \"TPA6130A2 HPRIGHT\"},\n\t{\"TPA6130A2 LEFTIN\", NULL, \"LLOUT\"},\n\t{\"TPA6130A2 RIGHTIN\", NULL, \"RLOUT\"},\n\n\t{\"DMic Rate 64\", NULL, \"DMic\"},\n\t{\"DMic\", NULL, \"Mic Bias\"},\n\n\t{\"b LINE2R\", NULL, \"MONO_LOUT\"},\n\t{\"Earphone\", NULL, \"b HPLOUT\"},\n\n\t{\"LINE1L\", NULL, \"HS Mic\"},\n\t{\"HS Mic\", NULL, \"b Mic Bias\"},\n};\n\nstatic const char * const spk_function[] = {\"Off\", \"On\"};\nstatic const char * const input_function[] = {\"ADC\", \"Digital Mic\"};\nstatic const char * const jack_function[] = {\n\t\"Off\", \"TV-OUT\", \"Headphone\", \"Headset\"\n};\n\nstatic const struct soc_enum rx51_enum[] = {\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(spk_function), spk_function),\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(input_function), input_function),\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(jack_function), jack_function),\n};\n\nstatic const struct snd_kcontrol_new aic34_rx51_controls[] = {\n\tSOC_ENUM_EXT(\"Speaker Function\", rx51_enum[0],\n\t\t     rx51_get_spk, rx51_set_spk),\n\tSOC_ENUM_EXT(\"Input Select\",  rx51_enum[1],\n\t\t     rx51_get_input, rx51_set_input),\n\tSOC_ENUM_EXT(\"Jack Function\", rx51_enum[2],\n\t\t     rx51_get_jack, rx51_set_jack),\n\tSOC_DAPM_PIN_SWITCH(\"FM Transmitter\"),\n\tSOC_DAPM_PIN_SWITCH(\"Earphone\"),\n};\n\nstatic int rx51_aic34_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct rx51_audio_pdata *pdata = snd_soc_card_get_drvdata(card);\n\tint err;\n\n\tsnd_soc_limit_volume(card, \"TPA6130A2 Headphone Playback Volume\", 42);\n\n\terr = omap_mcbsp_st_add_controls(rtd, 2);\n\tif (err < 0) {\n\t\tdev_err(card->dev, \"Failed to add MCBSP controls\\n\");\n\t\treturn err;\n\t}\n\n\t \n\terr = snd_soc_card_jack_new(rtd->card, \"AV Jack\",\n\t\t\t\t    SND_JACK_HEADSET | SND_JACK_VIDEOOUT,\n\t\t\t\t    &rx51_av_jack);\n\tif (err) {\n\t\tdev_err(card->dev, \"Failed to add AV Jack\\n\");\n\t\treturn err;\n\t}\n\n\t \n\trx51_av_jack_gpios[0].gpio = desc_to_gpio(pdata->jack_detection_gpio);\n\tdevm_gpiod_put(card->dev, pdata->jack_detection_gpio);\n\n\terr = snd_soc_jack_add_gpios(&rx51_av_jack,\n\t\t\t\t     ARRAY_SIZE(rx51_av_jack_gpios),\n\t\t\t\t     rx51_av_jack_gpios);\n\tif (err) {\n\t\tdev_err(card->dev, \"Failed to add GPIOs\\n\");\n\t\treturn err;\n\t}\n\n\treturn err;\n}\n\n \nSND_SOC_DAILINK_DEFS(aic34,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"omap-mcbsp.2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"tlv320aic3x-codec.2-0018\",\n\t\t\t\t      \"tlv320aic3x-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"omap-mcbsp.2\")));\n\nstatic struct snd_soc_dai_link rx51_dai[] = {\n\t{\n\t\t.name = \"TLV320AIC34\",\n\t\t.stream_name = \"AIC34\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_DSP_A | SND_SOC_DAIFMT_IB_NF |\n\t\t\t   SND_SOC_DAIFMT_CBM_CFM,\n\t\t.init = rx51_aic34_init,\n\t\t.ops = &rx51_ops,\n\t\tSND_SOC_DAILINK_REG(aic34),\n\t},\n};\n\nstatic struct snd_soc_aux_dev rx51_aux_dev[] = {\n\t{\n\t\t.dlc = COMP_AUX(\"tlv320aic3x-codec.2-0019\"),\n\t},\n\t{\n\t\t.dlc = COMP_AUX(\"tpa6130a2.2-0060\"),\n\t},\n};\n\nstatic struct snd_soc_codec_conf rx51_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"tlv320aic3x-codec.2-0019\"),\n\t\t.name_prefix = \"b\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"tpa6130a2.2-0060\"),\n\t\t.name_prefix = \"TPA6130A2\",\n\t},\n};\n\n \nstatic struct snd_soc_card rx51_sound_card = {\n\t.name = \"RX-51\",\n\t.owner = THIS_MODULE,\n\t.dai_link = rx51_dai,\n\t.num_links = ARRAY_SIZE(rx51_dai),\n\t.aux_dev = rx51_aux_dev,\n\t.num_aux_devs = ARRAY_SIZE(rx51_aux_dev),\n\t.codec_conf = rx51_codec_conf,\n\t.num_configs = ARRAY_SIZE(rx51_codec_conf),\n\t.fully_routed = true,\n\n\t.controls = aic34_rx51_controls,\n\t.num_controls = ARRAY_SIZE(aic34_rx51_controls),\n\t.dapm_widgets = aic34_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(aic34_dapm_widgets),\n\t.dapm_routes = audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(audio_map),\n};\n\nstatic int rx51_soc_probe(struct platform_device *pdev)\n{\n\tstruct rx51_audio_pdata *pdata;\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct snd_soc_card *card = &rx51_sound_card;\n\tint err;\n\n\tif (!machine_is_nokia_rx51() && !of_machine_is_compatible(\"nokia,omap3-n900\"))\n\t\treturn -ENODEV;\n\n\tcard->dev = &pdev->dev;\n\n\tif (np) {\n\t\tstruct device_node *dai_node;\n\n\t\tdai_node = of_parse_phandle(np, \"nokia,cpu-dai\", 0);\n\t\tif (!dai_node) {\n\t\t\tdev_err(&pdev->dev, \"McBSP node is not provided\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\trx51_dai[0].cpus->dai_name = NULL;\n\t\trx51_dai[0].platforms->name = NULL;\n\t\trx51_dai[0].cpus->of_node = dai_node;\n\t\trx51_dai[0].platforms->of_node = dai_node;\n\n\t\tdai_node = of_parse_phandle(np, \"nokia,audio-codec\", 0);\n\t\tif (!dai_node) {\n\t\t\tdev_err(&pdev->dev, \"Codec node is not provided\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\trx51_dai[0].codecs->name = NULL;\n\t\trx51_dai[0].codecs->of_node = dai_node;\n\n\t\tdai_node = of_parse_phandle(np, \"nokia,audio-codec\", 1);\n\t\tif (!dai_node) {\n\t\t\tdev_err(&pdev->dev, \"Auxiliary Codec node is not provided\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\trx51_aux_dev[0].dlc.name = NULL;\n\t\trx51_aux_dev[0].dlc.of_node = dai_node;\n\t\trx51_codec_conf[0].dlc.name = NULL;\n\t\trx51_codec_conf[0].dlc.of_node = dai_node;\n\n\t\tdai_node = of_parse_phandle(np, \"nokia,headphone-amplifier\", 0);\n\t\tif (!dai_node) {\n\t\t\tdev_err(&pdev->dev, \"Headphone amplifier node is not provided\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\trx51_aux_dev[1].dlc.name = NULL;\n\t\trx51_aux_dev[1].dlc.of_node = dai_node;\n\t\trx51_codec_conf[1].dlc.name = NULL;\n\t\trx51_codec_conf[1].dlc.of_node = dai_node;\n\t}\n\n\tpdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\n\tif (pdata == NULL)\n\t\treturn -ENOMEM;\n\n\tsnd_soc_card_set_drvdata(card, pdata);\n\n\tpdata->tvout_selection_gpio = devm_gpiod_get(card->dev,\n\t\t\t\t\t\t     \"tvout-selection\",\n\t\t\t\t\t\t     GPIOD_OUT_LOW);\n\tif (IS_ERR(pdata->tvout_selection_gpio)) {\n\t\tdev_err(card->dev, \"could not get tvout selection gpio\\n\");\n\t\treturn PTR_ERR(pdata->tvout_selection_gpio);\n\t}\n\n\tpdata->jack_detection_gpio = devm_gpiod_get(card->dev,\n\t\t\t\t\t\t    \"jack-detection\",\n\t\t\t\t\t\t    GPIOD_ASIS);\n\tif (IS_ERR(pdata->jack_detection_gpio)) {\n\t\tdev_err(card->dev, \"could not get jack detection gpio\\n\");\n\t\treturn PTR_ERR(pdata->jack_detection_gpio);\n\t}\n\n\tpdata->eci_sw_gpio = devm_gpiod_get(card->dev, \"eci-switch\",\n\t\t\t\t\t    GPIOD_OUT_HIGH);\n\tif (IS_ERR(pdata->eci_sw_gpio)) {\n\t\tdev_err(card->dev, \"could not get eci switch gpio\\n\");\n\t\treturn PTR_ERR(pdata->eci_sw_gpio);\n\t}\n\n\tpdata->speaker_amp_gpio = devm_gpiod_get(card->dev,\n\t\t\t\t\t\t \"speaker-amplifier\",\n\t\t\t\t\t\t GPIOD_OUT_LOW);\n\tif (IS_ERR(pdata->speaker_amp_gpio)) {\n\t\tdev_err(card->dev, \"could not get speaker enable gpio\\n\");\n\t\treturn PTR_ERR(pdata->speaker_amp_gpio);\n\t}\n\n\terr = devm_snd_soc_register_card(card->dev, card);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"snd_soc_register_card failed (%d)\\n\", err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n#if defined(CONFIG_OF)\nstatic const struct of_device_id rx51_audio_of_match[] = {\n\t{ .compatible = \"nokia,n900-audio\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, rx51_audio_of_match);\n#endif\n\nstatic struct platform_driver rx51_soc_driver = {\n\t.driver = {\n\t\t.name = \"rx51-audio\",\n\t\t.of_match_table = of_match_ptr(rx51_audio_of_match),\n\t},\n\t.probe = rx51_soc_probe,\n};\n\nmodule_platform_driver(rx51_soc_driver);\n\nMODULE_AUTHOR(\"Nokia Corporation\");\nMODULE_DESCRIPTION(\"ALSA SoC Nokia RX-51\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:rx51-audio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}