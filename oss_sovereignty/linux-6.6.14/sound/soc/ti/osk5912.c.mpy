{
  "module_name": "osk5912.c",
  "hash_id": "cc6f57c3f81dd6d4f16ccd5d3f118e5e6939a27ea80316ee49d4b88c92c48f0f",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/ti/osk5912.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/platform_device.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n\n#include <asm/mach-types.h>\n#include <linux/gpio.h>\n#include <linux/module.h>\n#include <linux/platform_data/asoc-ti-mcbsp.h>\n\n#include \"omap-mcbsp.h\"\n#include \"../codecs/tlv320aic23.h\"\n\n#define CODEC_CLOCK \t12000000\n\nstatic struct clk *tlv320aic23_mclk;\n\nstatic int osk_startup(struct snd_pcm_substream *substream)\n{\n\treturn clk_prepare_enable(tlv320aic23_mclk);\n}\n\nstatic void osk_shutdown(struct snd_pcm_substream *substream)\n{\n\tclk_disable_unprepare(tlv320aic23_mclk);\n}\n\nstatic int osk_hw_params(struct snd_pcm_substream *substream,\n\t\t\t struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tint err;\n\n\t \n\terr =\n\t    snd_soc_dai_set_sysclk(codec_dai, 0, CODEC_CLOCK, SND_SOC_CLOCK_IN);\n\n\tif (err < 0) {\n\t\tprintk(KERN_ERR \"can't set codec system clock\\n\");\n\t\treturn err;\n\t}\n\n\treturn err;\n}\n\nstatic const struct snd_soc_ops osk_ops = {\n\t.startup = osk_startup,\n\t.hw_params = osk_hw_params,\n\t.shutdown = osk_shutdown,\n};\n\nstatic const struct snd_soc_dapm_widget tlv320aic23_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line In\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic Jack\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route audio_map[] = {\n\t{\"Headphone Jack\", NULL, \"LHPOUT\"},\n\t{\"Headphone Jack\", NULL, \"RHPOUT\"},\n\n\t{\"LLINEIN\", NULL, \"Line In\"},\n\t{\"RLINEIN\", NULL, \"Line In\"},\n\n\t{\"MICIN\", NULL, \"Mic Jack\"},\n};\n\n \nSND_SOC_DAILINK_DEFS(aic23,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"omap-mcbsp.1\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"tlv320aic23-codec\",\n\t\t\t\t      \"tlv320aic23-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"omap-mcbsp.1\")));\n\nstatic struct snd_soc_dai_link osk_dai = {\n\t.name = \"TLV320AIC23\",\n\t.stream_name = \"AIC23\",\n\t.dai_fmt = SND_SOC_DAIFMT_DSP_B | SND_SOC_DAIFMT_NB_NF |\n\t\t   SND_SOC_DAIFMT_CBM_CFM,\n\t.ops = &osk_ops,\n\tSND_SOC_DAILINK_REG(aic23),\n};\n\n \nstatic struct snd_soc_card snd_soc_card_osk = {\n\t.name = \"OSK5912\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &osk_dai,\n\t.num_links = 1,\n\n\t.dapm_widgets = tlv320aic23_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(tlv320aic23_dapm_widgets),\n\t.dapm_routes = audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(audio_map),\n};\n\nstatic struct platform_device *osk_snd_device;\n\nstatic int __init osk_soc_init(void)\n{\n\tint err;\n\tu32 curRate;\n\tstruct device *dev;\n\n\tif (!(machine_is_omap_osk()))\n\t\treturn -ENODEV;\n\n\tosk_snd_device = platform_device_alloc(\"soc-audio\", -1);\n\tif (!osk_snd_device)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(osk_snd_device, &snd_soc_card_osk);\n\terr = platform_device_add(osk_snd_device);\n\tif (err)\n\t\tgoto err1;\n\n\tdev = &osk_snd_device->dev;\n\n\ttlv320aic23_mclk = clk_get(dev, \"mclk\");\n\tif (IS_ERR(tlv320aic23_mclk)) {\n\t\tprintk(KERN_ERR \"Could not get mclk clock\\n\");\n\t\terr = PTR_ERR(tlv320aic23_mclk);\n\t\tgoto err2;\n\t}\n\n\t \n\tcurRate = (uint) clk_get_rate(tlv320aic23_mclk);\n\tif (curRate != CODEC_CLOCK) {\n\t\tif (clk_set_rate(tlv320aic23_mclk, CODEC_CLOCK)) {\n\t\t\tprintk(KERN_ERR \"Cannot set MCLK for AIC23 CODEC\\n\");\n\t\t\terr = -ECANCELED;\n\t\t\tgoto err3;\n\t\t}\n\t}\n\n\tprintk(KERN_INFO \"MCLK = %d [%d]\\n\",\n\t       (uint) clk_get_rate(tlv320aic23_mclk), CODEC_CLOCK);\n\n\treturn 0;\n\nerr3:\n\tclk_put(tlv320aic23_mclk);\nerr2:\n\tplatform_device_del(osk_snd_device);\nerr1:\n\tplatform_device_put(osk_snd_device);\n\n\treturn err;\n\n}\n\nstatic void __exit osk_soc_exit(void)\n{\n\tclk_put(tlv320aic23_mclk);\n\tplatform_device_unregister(osk_snd_device);\n}\n\nmodule_init(osk_soc_init);\nmodule_exit(osk_soc_exit);\n\nMODULE_AUTHOR(\"Arun KS <arunks@mistralsolutions.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC OSK 5912\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}