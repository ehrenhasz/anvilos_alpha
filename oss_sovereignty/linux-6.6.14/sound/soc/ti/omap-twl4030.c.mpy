{
  "module_name": "omap-twl4030.c",
  "hash_id": "15c21b47547e530c133f4010030184fdebf80cc3e5415d56849cf8373d7083f6",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/ti/omap-twl4030.c",
  "human_readable_source": "\n \n\n#include <linux/platform_device.h>\n#include <linux/platform_data/omap-twl4030.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/gpio.h>\n#include <linux/of_gpio.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n#include <sound/jack.h>\n\n#include \"omap-mcbsp.h\"\n\nstruct omap_twl4030 {\n\tint jack_detect;\t \n\tstruct snd_soc_jack hs_jack;\n};\n\nstatic int omap_twl4030_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int fmt;\n\n\tswitch (params_channels(params)) {\n\tcase 2:  \n\t\tfmt =\tSND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBM_CFM;\n\t\tbreak;\n\tcase 4:  \n\t\tfmt =\tSND_SOC_DAIFMT_DSP_A |\n\t\t\tSND_SOC_DAIFMT_IB_NF |\n\t\t\tSND_SOC_DAIFMT_CBM_CFM;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn snd_soc_runtime_set_dai_fmt(rtd, fmt);\n}\n\nstatic const struct snd_soc_ops omap_twl4030_ops = {\n\t.hw_params = omap_twl4030_hw_params,\n};\n\nstatic const struct snd_soc_dapm_widget dapm_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Earpiece Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Handsfree Spk\", NULL),\n\tSND_SOC_DAPM_HP(\"Headset Stereophone\", NULL),\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Carkit Spk\", NULL),\n\n\tSND_SOC_DAPM_MIC(\"Main Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Sub Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Carkit Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Digital0 Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Digital1 Mic\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line In\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route audio_map[] = {\n\t \n\t{\"Headset Stereophone\", NULL, \"HSOL\"},\n\t{\"Headset Stereophone\", NULL, \"HSOR\"},\n\t \n\t{\"Handsfree Spk\", NULL, \"HFL\"},\n\t{\"Handsfree Spk\", NULL, \"HFR\"},\n\t \n\t{\"Ext Spk\", NULL, \"PREDRIVEL\"},\n\t{\"Ext Spk\", NULL, \"PREDRIVER\"},\n\t \n\t{\"Carkit Spk\", NULL, \"CARKITL\"},\n\t{\"Carkit Spk\", NULL, \"CARKITR\"},\n\t \n\t{\"Earpiece Spk\", NULL, \"EARPIECE\"},\n\n\t \n\t{\"MAINMIC\", NULL, \"Main Mic\"},\n\t{\"Main Mic\", NULL, \"Mic Bias 1\"},\n\t{\"SUBMIC\", NULL, \"Sub Mic\"},\n\t{\"Sub Mic\", NULL, \"Mic Bias 2\"},\n\t \n\t{\"HSMIC\", NULL, \"Headset Mic\"},\n\t{\"Headset Mic\", NULL, \"Headset Mic Bias\"},\n\t \n\t{\"DIGIMIC0\", NULL, \"Digital0 Mic\"},\n\t{\"Digital0 Mic\", NULL, \"Mic Bias 1\"},\n\t{\"DIGIMIC1\", NULL, \"Digital1 Mic\"},\n\t{\"Digital1 Mic\", NULL, \"Mic Bias 2\"},\n\t \n\t{\"CARKITMIC\", NULL, \"Carkit Mic\"},\n\t \n\t{\"AUXL\", NULL, \"Line In\"},\n\t{\"AUXR\", NULL, \"Line In\"},\n};\n\n \nstatic struct snd_soc_jack_pin hs_jack_pins[] = {\n\t{\n\t\t.pin = \"Headset Mic\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Headset Stereophone\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n};\n\n \nstatic struct snd_soc_jack_gpio hs_jack_gpios[] = {\n\t{\n\t\t.name = \"hsdet-gpio\",\n\t\t.report = SND_JACK_HEADSET,\n\t\t.debounce_time = 200,\n\t},\n};\n\nstatic inline void twl4030_disconnect_pin(struct snd_soc_dapm_context *dapm,\n\t\t\t\t\t  int connected, char *pin)\n{\n\tif (!connected)\n\t\tsnd_soc_dapm_disable_pin(dapm, pin);\n}\n\nstatic int omap_twl4030_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct snd_soc_dapm_context *dapm = &card->dapm;\n\tstruct omap_tw4030_pdata *pdata = dev_get_platdata(card->dev);\n\tstruct omap_twl4030 *priv = snd_soc_card_get_drvdata(card);\n\tint ret = 0;\n\n\t \n\tif (priv->jack_detect > 0) {\n\t\ths_jack_gpios[0].gpio = priv->jack_detect;\n\n\t\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t\t SND_JACK_HEADSET,\n\t\t\t\t\t\t &priv->hs_jack, hs_jack_pins,\n\t\t\t\t\t\t ARRAY_SIZE(hs_jack_pins));\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = snd_soc_jack_add_gpios(&priv->hs_jack,\n\t\t\t\t\t     ARRAY_SIZE(hs_jack_gpios),\n\t\t\t\t\t     hs_jack_gpios);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (!pdata || !pdata->custom_routing)\n\t\treturn ret;\n\n\t \n\ttwl4030_disconnect_pin(dapm, pdata->has_ear, \"Earpiece Spk\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_hf, \"Handsfree Spk\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_hs, \"Headset Stereophone\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_predriv, \"Ext Spk\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_carkit, \"Carkit Spk\");\n\n\ttwl4030_disconnect_pin(dapm, pdata->has_mainmic, \"Main Mic\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_submic, \"Sub Mic\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_hsmic, \"Headset Mic\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_carkitmic, \"Carkit Mic\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_digimic0, \"Digital0 Mic\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_digimic1, \"Digital1 Mic\");\n\ttwl4030_disconnect_pin(dapm, pdata->has_linein, \"Line In\");\n\n\treturn ret;\n}\n\n \nSND_SOC_DAILINK_DEFS(hifi,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"omap-mcbsp.2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"twl4030-codec\", \"twl4030-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"omap-mcbsp.2\")));\n\nSND_SOC_DAILINK_DEFS(voice,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"omap-mcbsp.3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"twl4030-codec\", \"twl4030-voice\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"omap-mcbsp.3\")));\n\nstatic struct snd_soc_dai_link omap_twl4030_dai_links[] = {\n\t{\n\t\t.name = \"TWL4030 HiFi\",\n\t\t.stream_name = \"TWL4030 HiFi\",\n\t\t.init = omap_twl4030_init,\n\t\t.ops = &omap_twl4030_ops,\n\t\tSND_SOC_DAILINK_REG(hifi),\n\t},\n\t{\n\t\t.name = \"TWL4030 Voice\",\n\t\t.stream_name = \"TWL4030 Voice\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_DSP_A | SND_SOC_DAIFMT_IB_NF |\n\t\t\t   SND_SOC_DAIFMT_CBM_CFM,\n\t\tSND_SOC_DAILINK_REG(voice),\n\t},\n};\n\n \nstatic struct snd_soc_card omap_twl4030_card = {\n\t.owner = THIS_MODULE,\n\t.dai_link = omap_twl4030_dai_links,\n\t.num_links = ARRAY_SIZE(omap_twl4030_dai_links),\n\n\t.dapm_widgets = dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(dapm_widgets),\n\t.dapm_routes = audio_map,\n\t.num_dapm_routes = ARRAY_SIZE(audio_map),\n};\n\nstatic int omap_twl4030_probe(struct platform_device *pdev)\n{\n\tstruct omap_tw4030_pdata *pdata = dev_get_platdata(&pdev->dev);\n\tstruct device_node *node = pdev->dev.of_node;\n\tstruct snd_soc_card *card = &omap_twl4030_card;\n\tstruct omap_twl4030 *priv;\n\tint ret = 0;\n\n\tcard->dev = &pdev->dev;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(struct omap_twl4030), GFP_KERNEL);\n\tif (priv == NULL)\n\t\treturn -ENOMEM;\n\n\tif (node) {\n\t\tstruct device_node *dai_node;\n\t\tstruct property *prop;\n\n\t\tif (snd_soc_of_parse_card_name(card, \"ti,model\")) {\n\t\t\tdev_err(&pdev->dev, \"Card name is not provided\\n\");\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tdai_node = of_parse_phandle(node, \"ti,mcbsp\", 0);\n\t\tif (!dai_node) {\n\t\t\tdev_err(&pdev->dev, \"McBSP node is not provided\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tomap_twl4030_dai_links[0].cpus->dai_name  = NULL;\n\t\tomap_twl4030_dai_links[0].cpus->of_node = dai_node;\n\n\t\tomap_twl4030_dai_links[0].platforms->name  = NULL;\n\t\tomap_twl4030_dai_links[0].platforms->of_node = dai_node;\n\n\t\tdai_node = of_parse_phandle(node, \"ti,mcbsp-voice\", 0);\n\t\tif (!dai_node) {\n\t\t\tcard->num_links = 1;\n\t\t} else {\n\t\t\tomap_twl4030_dai_links[1].cpus->dai_name  = NULL;\n\t\t\tomap_twl4030_dai_links[1].cpus->of_node = dai_node;\n\n\t\t\tomap_twl4030_dai_links[1].platforms->name  = NULL;\n\t\t\tomap_twl4030_dai_links[1].platforms->of_node = dai_node;\n\t\t}\n\n\t\tpriv->jack_detect = of_get_named_gpio(node,\n\t\t\t\t\t\t      \"ti,jack-det-gpio\", 0);\n\n\t\t \n\t\tprop = of_find_property(node, \"ti,audio-routing\", NULL);\n\t\tif (prop) {\n\t\t\tret = snd_soc_of_parse_audio_routing(card,\n\t\t\t\t\t\t\t    \"ti,audio-routing\");\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tcard->fully_routed = 1;\n\t\t}\n\t} else if (pdata) {\n\t\tif (pdata->card_name) {\n\t\t\tcard->name = pdata->card_name;\n\t\t} else {\n\t\t\tdev_err(&pdev->dev, \"Card name is not provided\\n\");\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tif (!pdata->voice_connected)\n\t\t\tcard->num_links = 1;\n\n\t\tpriv->jack_detect = pdata->jack_detect;\n\t} else {\n\t\tdev_err(&pdev->dev, \"Missing pdata\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tsnd_soc_card_set_drvdata(card, priv);\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"devm_snd_soc_register_card() failed: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id omap_twl4030_of_match[] = {\n\t{.compatible = \"ti,omap-twl4030\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, omap_twl4030_of_match);\n\nstatic struct platform_driver omap_twl4030_driver = {\n\t.driver = {\n\t\t.name = \"omap-twl4030\",\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = omap_twl4030_of_match,\n\t},\n\t.probe = omap_twl4030_probe,\n};\n\nmodule_platform_driver(omap_twl4030_driver);\n\nMODULE_AUTHOR(\"Peter Ujfalusi <peter.ujfalusi@ti.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC for TI SoC based boards with twl4030 codec\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:omap-twl4030\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}