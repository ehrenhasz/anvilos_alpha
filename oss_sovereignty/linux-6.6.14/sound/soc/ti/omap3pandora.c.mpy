{
  "module_name": "omap3pandora.c",
  "hash_id": "6146ac360f15cb6db1d49140e40329737ba255f44db3a97e7ebd7d91a5609987",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/ti/omap3pandora.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/platform_device.h>\n#include <linux/gpio.h>\n#include <linux/delay.h>\n#include <linux/regulator/consumer.h>\n#include <linux/module.h>\n\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/soc.h>\n\n#include <asm/mach-types.h>\n#include <linux/platform_data/asoc-ti-mcbsp.h>\n\n#include \"omap-mcbsp.h\"\n\n#define OMAP3_PANDORA_DAC_POWER_GPIO\t118\n#define OMAP3_PANDORA_AMP_POWER_GPIO\t14\n\n#define PREFIX \"ASoC omap3pandora: \"\n\nstatic struct regulator *omap3pandora_dac_reg;\n\nstatic int omap3pandora_hw_params(struct snd_pcm_substream *substream,\n\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tint ret;\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, 0, 26000000,\n\t\t\t\t\t    SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tpr_err(PREFIX \"can't set codec system clock\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = snd_soc_dai_set_sysclk(cpu_dai, OMAP_MCBSP_SYSCLK_CLKS_EXT,\n\t\t\t\t     256 * params_rate(params),\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tpr_err(PREFIX \"can't set cpu system clock\\n\");\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_dai_set_clkdiv(cpu_dai, OMAP_MCBSP_CLKGDV, 8);\n\tif (ret < 0) {\n\t\tpr_err(PREFIX \"can't set SRG clock divider\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int omap3pandora_dac_event(struct snd_soc_dapm_widget *w,\n\tstruct snd_kcontrol *k, int event)\n{\n\tint ret;\n\n\t \n\tif (SND_SOC_DAPM_EVENT_ON(event)) {\n\t\tret = regulator_enable(omap3pandora_dac_reg);\n\t\tif (ret) {\n\t\t\tdev_err(w->dapm->dev, \"Failed to power DAC: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t\tmdelay(1);\n\t\tgpio_set_value(OMAP3_PANDORA_DAC_POWER_GPIO, 1);\n\t} else {\n\t\tgpio_set_value(OMAP3_PANDORA_DAC_POWER_GPIO, 0);\n\t\tmdelay(1);\n\t\tregulator_disable(omap3pandora_dac_reg);\n\t}\n\n\treturn 0;\n}\n\nstatic int omap3pandora_hp_event(struct snd_soc_dapm_widget *w,\n\tstruct snd_kcontrol *k, int event)\n{\n\tif (SND_SOC_DAPM_EVENT_ON(event))\n\t\tgpio_set_value(OMAP3_PANDORA_AMP_POWER_GPIO, 1);\n\telse\n\t\tgpio_set_value(OMAP3_PANDORA_AMP_POWER_GPIO, 0);\n\n\treturn 0;\n}\n\n \nstatic const struct snd_soc_dapm_widget omap3pandora_dapm_widgets[] = {\n\tSND_SOC_DAPM_DAC_E(\"PCM DAC\", \"HiFi Playback\", SND_SOC_NOPM,\n\t\t\t   0, 0, omap3pandora_dac_event,\n\t\t\t   SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_PGA_E(\"Headphone Amplifier\", SND_SOC_NOPM,\n\t\t\t   0, 0, NULL, 0, omap3pandora_hp_event,\n\t\t\t   SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD),\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line Out\", NULL),\n\n\tSND_SOC_DAPM_MIC(\"Mic (internal)\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic (external)\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line In\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route omap3pandora_map[] = {\n\t{\"PCM DAC\", NULL, \"APLL Enable\"},\n\t{\"Headphone Amplifier\", NULL, \"PCM DAC\"},\n\t{\"Line Out\", NULL, \"PCM DAC\"},\n\t{\"Headphone Jack\", NULL, \"Headphone Amplifier\"},\n\n\t{\"AUXL\", NULL, \"Line In\"},\n\t{\"AUXR\", NULL, \"Line In\"},\n\n\t{\"MAINMIC\", NULL, \"Mic (internal)\"},\n\t{\"Mic (internal)\", NULL, \"Mic Bias 1\"},\n\n\t{\"SUBMIC\", NULL, \"Mic (external)\"},\n\t{\"Mic (external)\", NULL, \"Mic Bias 2\"},\n};\n\nstatic int omap3pandora_out_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dapm_context *dapm = &rtd->card->dapm;\n\n\t \n\tsnd_soc_dapm_nc_pin(dapm, \"EARPIECE\");\n\tsnd_soc_dapm_nc_pin(dapm, \"PREDRIVEL\");\n\tsnd_soc_dapm_nc_pin(dapm, \"PREDRIVER\");\n\tsnd_soc_dapm_nc_pin(dapm, \"HSOL\");\n\tsnd_soc_dapm_nc_pin(dapm, \"HSOR\");\n\tsnd_soc_dapm_nc_pin(dapm, \"CARKITL\");\n\tsnd_soc_dapm_nc_pin(dapm, \"CARKITR\");\n\tsnd_soc_dapm_nc_pin(dapm, \"HFL\");\n\tsnd_soc_dapm_nc_pin(dapm, \"HFR\");\n\tsnd_soc_dapm_nc_pin(dapm, \"VIBRA\");\n\n\treturn 0;\n}\n\nstatic int omap3pandora_in_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dapm_context *dapm = &rtd->card->dapm;\n\n\t \n\tsnd_soc_dapm_nc_pin(dapm, \"HSMIC\");\n\tsnd_soc_dapm_nc_pin(dapm, \"CARKITMIC\");\n\tsnd_soc_dapm_nc_pin(dapm, \"DIGIMIC0\");\n\tsnd_soc_dapm_nc_pin(dapm, \"DIGIMIC1\");\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops omap3pandora_ops = {\n\t.hw_params = omap3pandora_hw_params,\n};\n\n \nSND_SOC_DAILINK_DEFS(out,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"omap-mcbsp.2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"twl4030-codec\", \"twl4030-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"omap-mcbsp.2\")));\n\nSND_SOC_DAILINK_DEFS(in,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"omap-mcbsp.4\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"twl4030-codec\", \"twl4030-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_PLATFORM(\"omap-mcbsp.4\")));\n\nstatic struct snd_soc_dai_link omap3pandora_dai[] = {\n\t{\n\t\t.name = \"PCM1773\",\n\t\t.stream_name = \"HiFi Out\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\t   SND_SOC_DAIFMT_CBS_CFS,\n\t\t.ops = &omap3pandora_ops,\n\t\t.init = omap3pandora_out_init,\n\t\tSND_SOC_DAILINK_REG(out),\n\t}, {\n\t\t.name = \"TWL4030\",\n\t\t.stream_name = \"Line/Mic In\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\t   SND_SOC_DAIFMT_CBS_CFS,\n\t\t.ops = &omap3pandora_ops,\n\t\t.init = omap3pandora_in_init,\n\t\tSND_SOC_DAILINK_REG(in),\n\t}\n};\n\n \nstatic struct snd_soc_card snd_soc_card_omap3pandora = {\n\t.name = \"omap3pandora\",\n\t.owner = THIS_MODULE,\n\t.dai_link = omap3pandora_dai,\n\t.num_links = ARRAY_SIZE(omap3pandora_dai),\n\n\t.dapm_widgets = omap3pandora_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(omap3pandora_dapm_widgets),\n\t.dapm_routes = omap3pandora_map,\n\t.num_dapm_routes = ARRAY_SIZE(omap3pandora_map),\n};\n\nstatic struct platform_device *omap3pandora_snd_device;\n\nstatic int __init omap3pandora_soc_init(void)\n{\n\tint ret;\n\n\tif (!machine_is_omap3_pandora())\n\t\treturn -ENODEV;\n\n\tpr_info(\"OMAP3 Pandora SoC init\\n\");\n\n\tret = gpio_request(OMAP3_PANDORA_DAC_POWER_GPIO, \"dac_power\");\n\tif (ret) {\n\t\tpr_err(PREFIX \"Failed to get DAC power GPIO\\n\");\n\t\treturn ret;\n\t}\n\n\tret = gpio_direction_output(OMAP3_PANDORA_DAC_POWER_GPIO, 0);\n\tif (ret) {\n\t\tpr_err(PREFIX \"Failed to set DAC power GPIO direction\\n\");\n\t\tgoto fail0;\n\t}\n\n\tret = gpio_request(OMAP3_PANDORA_AMP_POWER_GPIO, \"amp_power\");\n\tif (ret) {\n\t\tpr_err(PREFIX \"Failed to get amp power GPIO\\n\");\n\t\tgoto fail0;\n\t}\n\n\tret = gpio_direction_output(OMAP3_PANDORA_AMP_POWER_GPIO, 0);\n\tif (ret) {\n\t\tpr_err(PREFIX \"Failed to set amp power GPIO direction\\n\");\n\t\tgoto fail1;\n\t}\n\n\tomap3pandora_snd_device = platform_device_alloc(\"soc-audio\", -1);\n\tif (omap3pandora_snd_device == NULL) {\n\t\tpr_err(PREFIX \"Platform device allocation failed\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto fail1;\n\t}\n\n\tplatform_set_drvdata(omap3pandora_snd_device, &snd_soc_card_omap3pandora);\n\n\tret = platform_device_add(omap3pandora_snd_device);\n\tif (ret) {\n\t\tpr_err(PREFIX \"Unable to add platform device\\n\");\n\t\tgoto fail2;\n\t}\n\n\tomap3pandora_dac_reg = regulator_get(&omap3pandora_snd_device->dev, \"vcc\");\n\tif (IS_ERR(omap3pandora_dac_reg)) {\n\t\tpr_err(PREFIX \"Failed to get DAC regulator from %s: %ld\\n\",\n\t\t\tdev_name(&omap3pandora_snd_device->dev),\n\t\t\tPTR_ERR(omap3pandora_dac_reg));\n\t\tret = PTR_ERR(omap3pandora_dac_reg);\n\t\tgoto fail3;\n\t}\n\n\treturn 0;\n\nfail3:\n\tplatform_device_del(omap3pandora_snd_device);\nfail2:\n\tplatform_device_put(omap3pandora_snd_device);\nfail1:\n\tgpio_free(OMAP3_PANDORA_AMP_POWER_GPIO);\nfail0:\n\tgpio_free(OMAP3_PANDORA_DAC_POWER_GPIO);\n\treturn ret;\n}\nmodule_init(omap3pandora_soc_init);\n\nstatic void __exit omap3pandora_soc_exit(void)\n{\n\tregulator_put(omap3pandora_dac_reg);\n\tplatform_device_unregister(omap3pandora_snd_device);\n\tgpio_free(OMAP3_PANDORA_AMP_POWER_GPIO);\n\tgpio_free(OMAP3_PANDORA_DAC_POWER_GPIO);\n}\nmodule_exit(omap3pandora_soc_exit);\n\nMODULE_AUTHOR(\"Grazvydas Ignotas <notasas@gmail.com>\");\nMODULE_DESCRIPTION(\"ALSA SoC OMAP3 Pandora\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}