{
  "module_name": "mt2701-cs42448.c",
  "hash_id": "18cc2405b125070c6b528052d4a649b96ff0cedd99808df657cc2e0c9db26d68",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt2701/mt2701-cs42448.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <sound/soc.h>\n#include <linux/delay.h>\n#include <linux/gpio.h>\n#include <linux/pinctrl/consumer.h>\n#include <linux/of_gpio.h>\n\n#include \"mt2701-afe-common.h\"\n\nstruct mt2701_cs42448_private {\n\tint i2s1_in_mux;\n\tint i2s1_in_mux_gpio_sel_1;\n\tint i2s1_in_mux_gpio_sel_2;\n};\n\nstatic const char * const i2sin_mux_switch_text[] = {\n\t\"ADC_SDOUT2\",\n\t\"ADC_SDOUT3\",\n\t\"I2S_IN_1\",\n\t\"I2S_IN_2\",\n};\n\nstatic const struct soc_enum i2sin_mux_enum =\n\tSOC_ENUM_SINGLE_EXT(4, i2sin_mux_switch_text);\n\nstatic int mt2701_cs42448_i2sin1_mux_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\tstruct mt2701_cs42448_private *priv = snd_soc_card_get_drvdata(card);\n\n\tucontrol->value.integer.value[0] = priv->i2s1_in_mux;\n\treturn 0;\n}\n\nstatic int mt2701_cs42448_i2sin1_mux_set(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\n\tstruct mt2701_cs42448_private *priv = snd_soc_card_get_drvdata(card);\n\n\tif (ucontrol->value.integer.value[0] == priv->i2s1_in_mux)\n\t\treturn 0;\n\n\tswitch (ucontrol->value.integer.value[0]) {\n\tcase 0:\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_1, 0);\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_2, 0);\n\t\tbreak;\n\tcase 1:\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_1, 1);\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_2, 0);\n\t\tbreak;\n\tcase 2:\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_1, 0);\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_2, 1);\n\t\tbreak;\n\tcase 3:\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_1, 1);\n\t\tgpio_set_value(priv->i2s1_in_mux_gpio_sel_2, 1);\n\t\tbreak;\n\tdefault:\n\t\tdev_warn(card->dev, \"%s invalid setting\\n\", __func__);\n\t}\n\n\tpriv->i2s1_in_mux = ucontrol->value.integer.value[0];\n\treturn 0;\n}\n\nstatic const struct snd_soc_dapm_widget\n\t\t\tmt2701_cs42448_asoc_card_dapm_widgets[] = {\n\tSND_SOC_DAPM_LINE(\"Line Out Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"AMIC\", NULL),\n\tSND_SOC_DAPM_LINE(\"Tuner In\", NULL),\n\tSND_SOC_DAPM_LINE(\"Satellite Tuner In\", NULL),\n\tSND_SOC_DAPM_LINE(\"AUX In\", NULL),\n};\n\nstatic const struct snd_kcontrol_new mt2701_cs42448_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Line Out Jack\"),\n\tSOC_DAPM_PIN_SWITCH(\"AMIC\"),\n\tSOC_DAPM_PIN_SWITCH(\"Tuner In\"),\n\tSOC_DAPM_PIN_SWITCH(\"Satellite Tuner In\"),\n\tSOC_DAPM_PIN_SWITCH(\"AUX In\"),\n\tSOC_ENUM_EXT(\"I2SIN1_MUX_Switch\", i2sin_mux_enum,\n\t\t     mt2701_cs42448_i2sin1_mux_get,\n\t\t     mt2701_cs42448_i2sin1_mux_set),\n};\n\nstatic const unsigned int mt2701_cs42448_sampling_rates[] = {48000};\n\nstatic const struct snd_pcm_hw_constraint_list mt2701_cs42448_constraints_rates = {\n\t\t.count = ARRAY_SIZE(mt2701_cs42448_sampling_rates),\n\t\t.list = mt2701_cs42448_sampling_rates,\n\t\t.mask = 0,\n};\n\nstatic int mt2701_cs42448_fe_ops_startup(struct snd_pcm_substream *substream)\n{\n\tint err;\n\n\terr = snd_pcm_hw_constraint_list(substream->runtime, 0,\n\t\t\t\t\t SNDRV_PCM_HW_PARAM_RATE,\n\t\t\t\t\t &mt2701_cs42448_constraints_rates);\n\tif (err < 0) {\n\t\tdev_err(substream->pcm->card->dev,\n\t\t\t\"%s snd_pcm_hw_constraint_list failed: 0x%x\\n\",\n\t\t\t__func__, err);\n\t\treturn err;\n\t}\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt2701_cs42448_48k_fe_ops = {\n\t.startup = mt2701_cs42448_fe_ops_startup,\n};\n\nstatic int mt2701_cs42448_be_ops_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tunsigned int mclk_rate;\n\tunsigned int rate = params_rate(params);\n\tunsigned int div_mclk_over_bck = rate > 192000 ? 2 : 4;\n\tunsigned int div_bck_over_lrck = 64;\n\n\tmclk_rate = rate * div_bck_over_lrck * div_mclk_over_bck;\n\n\t \n\tsnd_soc_dai_set_sysclk(cpu_dai, 0, mclk_rate, SND_SOC_CLOCK_OUT);\n\n\t \n\tsnd_soc_dai_set_sysclk(codec_dai, 0, mclk_rate, SND_SOC_CLOCK_IN);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt2701_cs42448_be_ops = {\n\t.hw_params = mt2701_cs42448_be_ops_hw_params\n};\n\nenum {\n\tDAI_LINK_FE_MULTI_CH_OUT,\n\tDAI_LINK_FE_PCM0_IN,\n\tDAI_LINK_FE_PCM1_IN,\n\tDAI_LINK_FE_BT_OUT,\n\tDAI_LINK_FE_BT_IN,\n\tDAI_LINK_BE_I2S0,\n\tDAI_LINK_BE_I2S1,\n\tDAI_LINK_BE_I2S2,\n\tDAI_LINK_BE_I2S3,\n\tDAI_LINK_BE_MRG_BT,\n};\n\nSND_SOC_DAILINK_DEFS(fe_multi_ch_out,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM_multi\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(fe_pcm0_in,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM0\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(fe_pcm1_in,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(fe_bt_out,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM_BT_DL\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(fe_bt_in,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM_BT_UL\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(be_i2s0,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"cs42448\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(be_i2s1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S1\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"cs42448\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(be_i2s2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"cs42448\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(be_i2s3,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"cs42448\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(be_mrg_bt,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"MRG BT\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"bt-sco-pcm-wb\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link mt2701_cs42448_dai_links[] = {\n\t \n\t[DAI_LINK_FE_MULTI_CH_OUT] = {\n\t\t.name = \"mt2701-cs42448-multi-ch-out\",\n\t\t.stream_name = \"mt2701-cs42448-multi-ch-out\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.ops = &mt2701_cs42448_48k_fe_ops,\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(fe_multi_ch_out),\n\t},\n\t[DAI_LINK_FE_PCM0_IN] = {\n\t\t.name = \"mt2701-cs42448-pcm0\",\n\t\t.stream_name = \"mt2701-cs42448-pcm0-data-UL\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.ops = &mt2701_cs42448_48k_fe_ops,\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(fe_pcm0_in),\n\t},\n\t[DAI_LINK_FE_PCM1_IN] = {\n\t\t.name = \"mt2701-cs42448-pcm1-data-UL\",\n\t\t.stream_name = \"mt2701-cs42448-pcm1-data-UL\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.ops = &mt2701_cs42448_48k_fe_ops,\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(fe_pcm1_in),\n\t},\n\t[DAI_LINK_FE_BT_OUT] = {\n\t\t.name = \"mt2701-cs42448-pcm-BT-out\",\n\t\t.stream_name = \"mt2701-cs42448-pcm-BT\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(fe_bt_out),\n\t},\n\t[DAI_LINK_FE_BT_IN] = {\n\t\t.name = \"mt2701-cs42448-pcm-BT-in\",\n\t\t.stream_name = \"mt2701-cs42448-pcm-BT\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(fe_bt_in),\n\t},\n\t \n\t[DAI_LINK_BE_I2S0] = {\n\t\t.name = \"mt2701-cs42448-I2S0\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS\n\t\t\t | SND_SOC_DAIFMT_GATED,\n\t\t.ops = &mt2701_cs42448_be_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(be_i2s0),\n\t},\n\t[DAI_LINK_BE_I2S1] = {\n\t\t.name = \"mt2701-cs42448-I2S1\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS\n\t\t\t | SND_SOC_DAIFMT_GATED,\n\t\t.ops = &mt2701_cs42448_be_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(be_i2s1),\n\t},\n\t[DAI_LINK_BE_I2S2] = {\n\t\t.name = \"mt2701-cs42448-I2S2\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS\n\t\t\t | SND_SOC_DAIFMT_GATED,\n\t\t.ops = &mt2701_cs42448_be_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(be_i2s2),\n\t},\n\t[DAI_LINK_BE_I2S3] = {\n\t\t.name = \"mt2701-cs42448-I2S3\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS\n\t\t\t | SND_SOC_DAIFMT_GATED,\n\t\t.ops = &mt2701_cs42448_be_ops,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(be_i2s3),\n\t},\n\t[DAI_LINK_BE_MRG_BT] = {\n\t\t.name = \"mt2701-cs42448-MRG-BT\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(be_mrg_bt),\n\t},\n};\n\nstatic struct snd_soc_card mt2701_cs42448_soc_card = {\n\t.name = \"mt2701-cs42448\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt2701_cs42448_dai_links,\n\t.num_links = ARRAY_SIZE(mt2701_cs42448_dai_links),\n\t.controls = mt2701_cs42448_controls,\n\t.num_controls = ARRAY_SIZE(mt2701_cs42448_controls),\n\t.dapm_widgets = mt2701_cs42448_asoc_card_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt2701_cs42448_asoc_card_dapm_widgets),\n};\n\nstatic int mt2701_cs42448_machine_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &mt2701_cs42448_soc_card;\n\tint ret;\n\tint i;\n\tstruct device_node *platform_node, *codec_node, *codec_node_bt_mrg;\n\tstruct mt2701_cs42448_private *priv =\n\t\tdevm_kzalloc(&pdev->dev, sizeof(struct mt2701_cs42448_private),\n\t\t\t     GFP_KERNEL);\n\tstruct device *dev = &pdev->dev;\n\tstruct snd_soc_dai_link *dai_link;\n\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tplatform_node = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t\t \"mediatek,platform\", 0);\n\tif (!platform_node) {\n\t\tdev_err(&pdev->dev, \"Property 'platform' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (dai_link->platforms->name)\n\t\t\tcontinue;\n\t\tdai_link->platforms->of_node = platform_node;\n\t}\n\n\tcard->dev = dev;\n\n\tcodec_node = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t      \"mediatek,audio-codec\", 0);\n\tif (!codec_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'audio-codec' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (dai_link->codecs->name)\n\t\t\tcontinue;\n\t\tdai_link->codecs->of_node = codec_node;\n\t}\n\n\tcodec_node_bt_mrg = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t\t     \"mediatek,audio-codec-bt-mrg\", 0);\n\tif (!codec_node_bt_mrg) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'audio-codec-bt-mrg' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\tmt2701_cs42448_dai_links[DAI_LINK_BE_MRG_BT].codecs->of_node\n\t\t\t\t\t\t\t= codec_node_bt_mrg;\n\n\tret = snd_soc_of_parse_audio_routing(card, \"audio-routing\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to parse audio-routing: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpriv->i2s1_in_mux_gpio_sel_1 =\n\t\tof_get_named_gpio(dev->of_node, \"i2s1-in-sel-gpio1\", 0);\n\tif (gpio_is_valid(priv->i2s1_in_mux_gpio_sel_1)) {\n\t\tret = devm_gpio_request(dev, priv->i2s1_in_mux_gpio_sel_1,\n\t\t\t\t\t\"i2s1_in_mux_gpio_sel_1\");\n\t\tif (ret)\n\t\t\tdev_warn(&pdev->dev, \"%s devm_gpio_request fail %d\\n\",\n\t\t\t\t __func__, ret);\n\t\tgpio_direction_output(priv->i2s1_in_mux_gpio_sel_1, 0);\n\t}\n\n\tpriv->i2s1_in_mux_gpio_sel_2 =\n\t\tof_get_named_gpio(dev->of_node, \"i2s1-in-sel-gpio2\", 0);\n\tif (gpio_is_valid(priv->i2s1_in_mux_gpio_sel_2)) {\n\t\tret = devm_gpio_request(dev, priv->i2s1_in_mux_gpio_sel_2,\n\t\t\t\t\t\"i2s1_in_mux_gpio_sel_2\");\n\t\tif (ret)\n\t\t\tdev_warn(&pdev->dev, \"%s devm_gpio_request fail2 %d\\n\",\n\t\t\t\t __func__, ret);\n\t\tgpio_direction_output(priv->i2s1_in_mux_gpio_sel_2, 0);\n\t}\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\n\tif (ret)\n\t\tdev_err(&pdev->dev, \"%s snd_soc_register_card fail %d\\n\",\n\t\t\t__func__, ret);\n\treturn ret;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id mt2701_cs42448_machine_dt_match[] = {\n\t{.compatible = \"mediatek,mt2701-cs42448-machine\",},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mt2701_cs42448_machine_dt_match);\n#endif\n\nstatic struct platform_driver mt2701_cs42448_machine = {\n\t.driver = {\n\t\t.name = \"mt2701-cs42448\",\n\t\t   #ifdef CONFIG_OF\n\t\t   .of_match_table = mt2701_cs42448_machine_dt_match,\n\t\t   #endif\n\t},\n\t.probe = mt2701_cs42448_machine_probe,\n};\n\nmodule_platform_driver(mt2701_cs42448_machine);\n\n \nMODULE_DESCRIPTION(\"MT2701 CS42448 ALSA SoC machine driver\");\nMODULE_AUTHOR(\"Ir Lian <ir.lian@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"mt2701 cs42448 soc card\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}