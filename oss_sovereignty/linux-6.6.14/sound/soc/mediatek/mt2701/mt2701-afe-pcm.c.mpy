{
  "module_name": "mt2701-afe-pcm.c",
  "hash_id": "111b8baccaeb914adf1babcc70f069babe6e421f525518277867db10f348abd7",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt2701/mt2701-afe-pcm.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/module.h>\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_device.h>\n#include <linux/pm_runtime.h>\n\n#include \"mt2701-afe-common.h\"\n#include \"mt2701-afe-clock-ctrl.h\"\n#include \"../common/mtk-afe-platform-driver.h\"\n#include \"../common/mtk-afe-fe-dai.h\"\n\nstatic const struct snd_pcm_hardware mt2701_afe_hardware = {\n\t.info = SNDRV_PCM_INFO_MMAP | SNDRV_PCM_INFO_INTERLEAVED\n\t\t| SNDRV_PCM_INFO_RESUME | SNDRV_PCM_INFO_MMAP_VALID,\n\t.formats = SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S24_LE\n\t\t   | SNDRV_PCM_FMTBIT_S32_LE,\n\t.period_bytes_min = 1024,\n\t.period_bytes_max = 1024 * 256,\n\t.periods_min = 4,\n\t.periods_max = 1024,\n\t.buffer_bytes_max = 1024 * 1024,\n\t.fifo_size = 0,\n};\n\nstruct mt2701_afe_rate {\n\tunsigned int rate;\n\tunsigned int regvalue;\n};\n\nstatic const struct mt2701_afe_rate mt2701_afe_i2s_rates[] = {\n\t{ .rate = 8000, .regvalue = 0 },\n\t{ .rate = 12000, .regvalue = 1 },\n\t{ .rate = 16000, .regvalue = 2 },\n\t{ .rate = 24000, .regvalue = 3 },\n\t{ .rate = 32000, .regvalue = 4 },\n\t{ .rate = 48000, .regvalue = 5 },\n\t{ .rate = 96000, .regvalue = 6 },\n\t{ .rate = 192000, .regvalue = 7 },\n\t{ .rate = 384000, .regvalue = 8 },\n\t{ .rate = 7350, .regvalue = 16 },\n\t{ .rate = 11025, .regvalue = 17 },\n\t{ .rate = 14700, .regvalue = 18 },\n\t{ .rate = 22050, .regvalue = 19 },\n\t{ .rate = 29400, .regvalue = 20 },\n\t{ .rate = 44100, .regvalue = 21 },\n\t{ .rate = 88200, .regvalue = 22 },\n\t{ .rate = 176400, .regvalue = 23 },\n\t{ .rate = 352800, .regvalue = 24 },\n};\n\nstatic const unsigned int mt2701_afe_backup_list[] = {\n\tAUDIO_TOP_CON0,\n\tAUDIO_TOP_CON4,\n\tAUDIO_TOP_CON5,\n\tASYS_TOP_CON,\n\tAFE_CONN0,\n\tAFE_CONN1,\n\tAFE_CONN2,\n\tAFE_CONN3,\n\tAFE_CONN15,\n\tAFE_CONN16,\n\tAFE_CONN17,\n\tAFE_CONN18,\n\tAFE_CONN19,\n\tAFE_CONN20,\n\tAFE_CONN21,\n\tAFE_CONN22,\n\tAFE_DAC_CON0,\n\tAFE_MEMIF_PBUF_SIZE,\n};\n\nstatic int mt2701_dai_num_to_i2s(struct mtk_base_afe *afe, int num)\n{\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint val = num - MT2701_IO_I2S;\n\n\tif (val < 0 || val >= afe_priv->soc->i2s_num) {\n\t\tdev_err(afe->dev, \"%s, num not available, num %d, val %d\\n\",\n\t\t\t__func__, num, val);\n\t\treturn -EINVAL;\n\t}\n\treturn val;\n}\n\nstatic int mt2701_afe_i2s_fs(unsigned int sample_rate)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(mt2701_afe_i2s_rates); i++)\n\t\tif (mt2701_afe_i2s_rates[i].rate == sample_rate)\n\t\t\treturn mt2701_afe_i2s_rates[i].regvalue;\n\n\treturn -EINVAL;\n}\n\nstatic int mt2701_afe_i2s_startup(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint i2s_num = mt2701_dai_num_to_i2s(afe, dai->id);\n\tbool mode = afe_priv->soc->has_one_heart_mode;\n\n\tif (i2s_num < 0)\n\t\treturn i2s_num;\n\n\treturn mt2701_afe_enable_mclk(afe, mode ? 1 : i2s_num);\n}\n\nstatic int mt2701_afe_i2s_path_disable(struct mtk_base_afe *afe,\n\t\t\t\t       struct mt2701_i2s_path *i2s_path,\n\t\t\t\t       int stream_dir)\n{\n\tconst struct mt2701_i2s_data *i2s_data = i2s_path->i2s_data[stream_dir];\n\n\tif (--i2s_path->on[stream_dir] < 0)\n\t\ti2s_path->on[stream_dir] = 0;\n\n\tif (i2s_path->on[stream_dir])\n\t\treturn 0;\n\n\t \n\tregmap_update_bits(afe->regmap, i2s_data->i2s_ctrl_reg,\n\t\t\t   ASYS_I2S_CON_I2S_EN, 0);\n\n\tmt2701_afe_disable_i2s(afe, i2s_path, stream_dir);\n\n\treturn 0;\n}\n\nstatic void mt2701_afe_i2s_shutdown(struct snd_pcm_substream *substream,\n\t\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint i2s_num = mt2701_dai_num_to_i2s(afe, dai->id);\n\tstruct mt2701_i2s_path *i2s_path;\n\tbool mode = afe_priv->soc->has_one_heart_mode;\n\n\tif (i2s_num < 0)\n\t\treturn;\n\n\ti2s_path = &afe_priv->i2s_path[i2s_num];\n\n\tif (i2s_path->occupied[substream->stream])\n\t\ti2s_path->occupied[substream->stream] = 0;\n\telse\n\t\tgoto exit;\n\n\tmt2701_afe_i2s_path_disable(afe, i2s_path, substream->stream);\n\n\t \n\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\tmt2701_afe_i2s_path_disable(afe, i2s_path, !substream->stream);\n\nexit:\n\t \n\tmt2701_afe_disable_mclk(afe, mode ? 1 : i2s_num);\n}\n\nstatic int mt2701_i2s_path_enable(struct mtk_base_afe *afe,\n\t\t\t\t  struct mt2701_i2s_path *i2s_path,\n\t\t\t\t  int stream_dir, int rate)\n{\n\tconst struct mt2701_i2s_data *i2s_data = i2s_path->i2s_data[stream_dir];\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint reg, fs, w_len = 1;  \n\tunsigned int mask, val;\n\n\t \n\tif (++i2s_path->on[stream_dir] != 1)\n\t\treturn 0;\n\n\tfs = mt2701_afe_i2s_fs(rate);\n\n\tmask = ASYS_I2S_CON_FS |\n\t       ASYS_I2S_CON_I2S_COUPLE_MODE |  \n\t       ASYS_I2S_CON_I2S_MODE |\n\t       ASYS_I2S_CON_WIDE_MODE;\n\n\tval = ASYS_I2S_CON_FS_SET(fs) |\n\t      ASYS_I2S_CON_I2S_MODE |\n\t      ASYS_I2S_CON_WIDE_MODE_SET(w_len);\n\n\tif (stream_dir == SNDRV_PCM_STREAM_CAPTURE) {\n\t\tmask |= ASYS_I2S_IN_PHASE_FIX;\n\t\tval |= ASYS_I2S_IN_PHASE_FIX;\n\t\treg = ASMI_TIMING_CON1;\n\t} else {\n\t\tif (afe_priv->soc->has_one_heart_mode) {\n\t\t\tmask |= ASYS_I2S_CON_ONE_HEART_MODE;\n\t\t\tval |= ASYS_I2S_CON_ONE_HEART_MODE;\n\t\t}\n\t\treg = ASMO_TIMING_CON1;\n\t}\n\n\tregmap_update_bits(afe->regmap, i2s_data->i2s_ctrl_reg, mask, val);\n\n\tregmap_update_bits(afe->regmap, reg,\n\t\t\t   i2s_data->i2s_asrc_fs_mask\n\t\t\t   << i2s_data->i2s_asrc_fs_shift,\n\t\t\t   fs << i2s_data->i2s_asrc_fs_shift);\n\n\t \n\tmt2701_afe_enable_i2s(afe, i2s_path, stream_dir);\n\n\t \n\tregmap_update_bits(afe->regmap, i2s_data->i2s_ctrl_reg,\n\t\t\t   ASYS_I2S_CON_RESET, ASYS_I2S_CON_RESET);\n\tudelay(1);\n\tregmap_update_bits(afe->regmap, i2s_data->i2s_ctrl_reg,\n\t\t\t   ASYS_I2S_CON_RESET, 0);\n\tudelay(1);\n\tregmap_update_bits(afe->regmap, i2s_data->i2s_ctrl_reg,\n\t\t\t   ASYS_I2S_CON_I2S_EN, ASYS_I2S_CON_I2S_EN);\n\treturn 0;\n}\n\nstatic int mt2701_afe_i2s_prepare(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint ret, i2s_num = mt2701_dai_num_to_i2s(afe, dai->id);\n\tstruct mt2701_i2s_path *i2s_path;\n\tbool mode = afe_priv->soc->has_one_heart_mode;\n\n\tif (i2s_num < 0)\n\t\treturn i2s_num;\n\n\ti2s_path = &afe_priv->i2s_path[i2s_num];\n\n\tif (i2s_path->occupied[substream->stream])\n\t\treturn -EBUSY;\n\n\tret = mt2701_mclk_configuration(afe, mode ? 1 : i2s_num);\n\tif (ret)\n\t\treturn ret;\n\n\ti2s_path->occupied[substream->stream] = 1;\n\n\t \n\tif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\n\t\tmt2701_i2s_path_enable(afe, i2s_path, !substream->stream,\n\t\t\t\t       substream->runtime->rate);\n\n\tmt2701_i2s_path_enable(afe, i2s_path, substream->stream,\n\t\t\t       substream->runtime->rate);\n\n\treturn 0;\n}\n\nstatic int mt2701_afe_i2s_set_sysclk(struct snd_soc_dai *dai, int clk_id,\n\t\t\t\t     unsigned int freq, int dir)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint i2s_num = mt2701_dai_num_to_i2s(afe, dai->id);\n\tbool mode = afe_priv->soc->has_one_heart_mode;\n\n\tif (i2s_num < 0)\n\t\treturn i2s_num;\n\n\t \n\tif (dir == SND_SOC_CLOCK_IN) {\n\t\tdev_warn(dai->dev, \"The SoCs doesn't support mclk input\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tafe_priv->i2s_path[mode ? 1 : i2s_num].mclk_rate = freq;\n\n\treturn 0;\n}\n\nstatic int mt2701_btmrg_startup(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = mt2701_enable_btmrg_clk(afe);\n\tif (ret)\n\t\treturn ret;\n\n\tafe_priv->mrg_enable[substream->stream] = 1;\n\n\treturn 0;\n}\n\nstatic int mt2701_btmrg_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_pcm_hw_params *params,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tint stream_fs;\n\tu32 val, msk;\n\n\tstream_fs = params_rate(params);\n\n\tif (stream_fs != 8000 && stream_fs != 16000) {\n\t\tdev_err(afe->dev, \"unsupported rate %d\\n\", stream_fs);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_MRGIF_CON,\n\t\t\t   AFE_MRGIF_CON_I2S_MODE_MASK,\n\t\t\t   AFE_MRGIF_CON_I2S_MODE_32K);\n\n\tval = AFE_DAIBT_CON0_BT_FUNC_EN | AFE_DAIBT_CON0_BT_FUNC_RDY\n\t      | AFE_DAIBT_CON0_MRG_USE;\n\tmsk = val;\n\n\tif (stream_fs == 16000)\n\t\tval |= AFE_DAIBT_CON0_BT_WIDE_MODE_EN;\n\n\tmsk |= AFE_DAIBT_CON0_BT_WIDE_MODE_EN;\n\n\tregmap_update_bits(afe->regmap, AFE_DAIBT_CON0, msk, val);\n\n\tregmap_update_bits(afe->regmap, AFE_DAIBT_CON0,\n\t\t\t   AFE_DAIBT_CON0_DAIBT_EN,\n\t\t\t   AFE_DAIBT_CON0_DAIBT_EN);\n\tregmap_update_bits(afe->regmap, AFE_MRGIF_CON,\n\t\t\t   AFE_MRGIF_CON_MRG_I2S_EN,\n\t\t\t   AFE_MRGIF_CON_MRG_I2S_EN);\n\tregmap_update_bits(afe->regmap, AFE_MRGIF_CON,\n\t\t\t   AFE_MRGIF_CON_MRG_EN,\n\t\t\t   AFE_MRGIF_CON_MRG_EN);\n\treturn 0;\n}\n\nstatic void mt2701_btmrg_shutdown(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt2701_afe_private *afe_priv = afe->platform_priv;\n\n\t \n\tif (!afe_priv->mrg_enable[!substream->stream]) {\n\t\tregmap_update_bits(afe->regmap, AFE_DAIBT_CON0,\n\t\t\t\t   AFE_DAIBT_CON0_DAIBT_EN, 0);\n\t\tregmap_update_bits(afe->regmap, AFE_MRGIF_CON,\n\t\t\t\t   AFE_MRGIF_CON_MRG_EN, 0);\n\t\tregmap_update_bits(afe->regmap, AFE_MRGIF_CON,\n\t\t\t\t   AFE_MRGIF_CON_MRG_I2S_EN, 0);\n\t\tmt2701_disable_btmrg_clk(afe);\n\t}\n\n\tafe_priv->mrg_enable[substream->stream] = 0;\n}\n\nstatic int mt2701_simple_fe_startup(struct snd_pcm_substream *substream,\n\t\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mtk_base_afe_memif *memif_tmp;\n\tint stream_dir = substream->stream;\n\n\t \n\tif (stream_dir == SNDRV_PCM_STREAM_PLAYBACK) {\n\t\tmemif_tmp = &afe->memif[MT2701_MEMIF_DLM];\n\t\tif (memif_tmp->substream) {\n\t\t\tdev_warn(afe->dev, \"memif is not available\");\n\t\t\treturn -EBUSY;\n\t\t}\n\t}\n\n\treturn mtk_afe_fe_startup(substream, dai);\n}\n\nstatic int mt2701_simple_fe_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t      struct snd_pcm_hw_params *params,\n\t\t\t\t      struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tint stream_dir = substream->stream;\n\n\t \n\tif (stream_dir == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_MEMIF_PBUF_SIZE,\n\t\t\t\t   AFE_MEMIF_PBUF_SIZE_DLM_MASK,\n\t\t\t\t   AFE_MEMIF_PBUF_SIZE_PAIR_INTERLEAVE);\n\n\treturn mtk_afe_fe_hw_params(substream, params, dai);\n}\n\nstatic int mt2701_dlm_fe_startup(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mtk_base_afe_memif *memif_tmp;\n\tconst struct mtk_base_memif_data *memif_data;\n\tint i;\n\n\tfor (i = MT2701_MEMIF_DL1; i < MT2701_MEMIF_DL_SINGLE_NUM; ++i) {\n\t\tmemif_tmp = &afe->memif[i];\n\t\tif (memif_tmp->substream)\n\t\t\treturn -EBUSY;\n\t}\n\n\t \n\tfor (i = MT2701_MEMIF_DL1; i < MT2701_MEMIF_DL_SINGLE_NUM; ++i) {\n\t\tmemif_data = afe->memif[i].data;\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   memif_data->agent_disable_reg,\n\t\t\t\t   1 << memif_data->agent_disable_shift,\n\t\t\t\t   0 << memif_data->agent_disable_shift);\n\t}\n\n\treturn mtk_afe_fe_startup(substream, dai);\n}\n\nstatic void mt2701_dlm_fe_shutdown(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tconst struct mtk_base_memif_data *memif_data;\n\tint i;\n\n\tfor (i = MT2701_MEMIF_DL1; i < MT2701_MEMIF_DL_SINGLE_NUM; ++i) {\n\t\tmemif_data = afe->memif[i].data;\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   memif_data->agent_disable_reg,\n\t\t\t\t   1 << memif_data->agent_disable_shift,\n\t\t\t\t   1 << memif_data->agent_disable_shift);\n\t}\n\n\treturn mtk_afe_fe_shutdown(substream, dai);\n}\n\nstatic int mt2701_dlm_fe_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_pcm_hw_params *params,\n\t\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tint channels = params_channels(params);\n\n\tregmap_update_bits(afe->regmap,\n\t\t\t   AFE_MEMIF_PBUF_SIZE,\n\t\t\t   AFE_MEMIF_PBUF_SIZE_DLM_MASK,\n\t\t\t   AFE_MEMIF_PBUF_SIZE_FULL_INTERLEAVE);\n\tregmap_update_bits(afe->regmap,\n\t\t\t   AFE_MEMIF_PBUF_SIZE,\n\t\t\t   AFE_MEMIF_PBUF_SIZE_DLM_BYTE_MASK,\n\t\t\t   AFE_MEMIF_PBUF_SIZE_DLM_32BYTES);\n\tregmap_update_bits(afe->regmap,\n\t\t\t   AFE_MEMIF_PBUF_SIZE,\n\t\t\t   AFE_MEMIF_PBUF_SIZE_DLM_CH_MASK,\n\t\t\t   AFE_MEMIF_PBUF_SIZE_DLM_CH(channels));\n\n\treturn mtk_afe_fe_hw_params(substream, params, dai);\n}\n\nstatic int mt2701_dlm_fe_trigger(struct snd_pcm_substream *substream,\n\t\t\t\t int cmd, struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mtk_base_afe_memif *memif_tmp = &afe->memif[MT2701_MEMIF_DL1];\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\t\tregmap_update_bits(afe->regmap, memif_tmp->data->enable_reg,\n\t\t\t\t   1 << memif_tmp->data->enable_shift,\n\t\t\t\t   1 << memif_tmp->data->enable_shift);\n\t\tmtk_afe_fe_trigger(substream, cmd, dai);\n\t\treturn 0;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\t\tmtk_afe_fe_trigger(substream, cmd, dai);\n\t\tregmap_update_bits(afe->regmap, memif_tmp->data->enable_reg,\n\t\t\t\t   1 << memif_tmp->data->enable_shift, 0);\n\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int mt2701_memif_fs(struct snd_pcm_substream *substream,\n\t\t\t   unsigned int rate)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tint fs;\n\n\tif (asoc_rtd_to_cpu(rtd, 0)->id != MT2701_MEMIF_ULBT)\n\t\tfs = mt2701_afe_i2s_fs(rate);\n\telse\n\t\tfs = (rate == 16000 ? 1 : 0);\n\n\treturn fs;\n}\n\nstatic int mt2701_irq_fs(struct snd_pcm_substream *substream, unsigned int rate)\n{\n\treturn mt2701_afe_i2s_fs(rate);\n}\n\n \nstatic const struct snd_soc_dai_ops mt2701_single_memif_dai_ops = {\n\t.startup\t= mt2701_simple_fe_startup,\n\t.shutdown\t= mtk_afe_fe_shutdown,\n\t.hw_params\t= mt2701_simple_fe_hw_params,\n\t.hw_free\t= mtk_afe_fe_hw_free,\n\t.prepare\t= mtk_afe_fe_prepare,\n\t.trigger\t= mtk_afe_fe_trigger,\n};\n\nstatic const struct snd_soc_dai_ops mt2701_dlm_memif_dai_ops = {\n\t.startup\t= mt2701_dlm_fe_startup,\n\t.shutdown\t= mt2701_dlm_fe_shutdown,\n\t.hw_params\t= mt2701_dlm_fe_hw_params,\n\t.hw_free\t= mtk_afe_fe_hw_free,\n\t.prepare\t= mtk_afe_fe_prepare,\n\t.trigger\t= mt2701_dlm_fe_trigger,\n};\n\n \nstatic const struct snd_soc_dai_ops mt2701_afe_i2s_ops = {\n\t.startup\t= mt2701_afe_i2s_startup,\n\t.shutdown\t= mt2701_afe_i2s_shutdown,\n\t.prepare\t= mt2701_afe_i2s_prepare,\n\t.set_sysclk\t= mt2701_afe_i2s_set_sysclk,\n};\n\n \nstatic const struct snd_soc_dai_ops mt2701_btmrg_ops = {\n\t.startup = mt2701_btmrg_startup,\n\t.shutdown = mt2701_btmrg_shutdown,\n\t.hw_params = mt2701_btmrg_hw_params,\n};\n\nstatic struct snd_soc_dai_driver mt2701_afe_pcm_dais[] = {\n\t \n\t{\n\t\t.name = \"PCMO0\",\n\t\t.id = MT2701_MEMIF_DL1,\n\t\t.playback = {\n\t\t\t.stream_name = \"DL1\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t},\n\t\t.ops = &mt2701_single_memif_dai_ops,\n\t},\n\t{\n\t\t.name = \"PCM_multi\",\n\t\t.id = MT2701_MEMIF_DLM,\n\t\t.playback = {\n\t\t\t.stream_name = \"DLM\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 8,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\n\t\t},\n\t\t.ops = &mt2701_dlm_memif_dai_ops,\n\t},\n\t{\n\t\t.name = \"PCM0\",\n\t\t.id = MT2701_MEMIF_UL1,\n\t\t.capture = {\n\t\t\t.stream_name = \"UL1\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t},\n\t\t.ops = &mt2701_single_memif_dai_ops,\n\t},\n\t{\n\t\t.name = \"PCM1\",\n\t\t.id = MT2701_MEMIF_UL2,\n\t\t.capture = {\n\t\t\t.stream_name = \"UL2\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\n\t\t},\n\t\t.ops = &mt2701_single_memif_dai_ops,\n\t},\n\t{\n\t\t.name = \"PCM_BT_DL\",\n\t\t.id = MT2701_MEMIF_DLBT,\n\t\t.playback = {\n\t\t\t.stream_name = \"DLBT\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 1,\n\t\t\t.rates = (SNDRV_PCM_RATE_8000\n\t\t\t\t| SNDRV_PCM_RATE_16000),\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mt2701_single_memif_dai_ops,\n\t},\n\t{\n\t\t.name = \"PCM_BT_UL\",\n\t\t.id = MT2701_MEMIF_ULBT,\n\t\t.capture = {\n\t\t\t.stream_name = \"ULBT\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 1,\n\t\t\t.rates = (SNDRV_PCM_RATE_8000\n\t\t\t\t| SNDRV_PCM_RATE_16000),\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mt2701_single_memif_dai_ops,\n\t},\n\t \n\t{\n\t\t.name = \"I2S0\",\n\t\t.id = MT2701_IO_I2S,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S0 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S0 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\n\t\t},\n\t\t.ops = &mt2701_afe_i2s_ops,\n\t\t.symmetric_rate = 1,\n\t},\n\t{\n\t\t.name = \"I2S1\",\n\t\t.id = MT2701_IO_2ND_I2S,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S1 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S1 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t\t},\n\t\t.ops = &mt2701_afe_i2s_ops,\n\t\t.symmetric_rate = 1,\n\t},\n\t{\n\t\t.name = \"I2S2\",\n\t\t.id = MT2701_IO_3RD_I2S,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S2 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S2 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t\t},\n\t\t.ops = &mt2701_afe_i2s_ops,\n\t\t.symmetric_rate = 1,\n\t},\n\t{\n\t\t.name = \"I2S3\",\n\t\t.id = MT2701_IO_4TH_I2S,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S3 Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S3 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_192000,\n\t\t\t.formats = (SNDRV_PCM_FMTBIT_S16_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S24_LE\n\t\t\t\t| SNDRV_PCM_FMTBIT_S32_LE)\n\t\t\t},\n\t\t.ops = &mt2701_afe_i2s_ops,\n\t\t.symmetric_rate = 1,\n\t},\n\t{\n\t\t.name = \"MRG BT\",\n\t\t.id = MT2701_IO_MRG,\n\t\t.playback = {\n\t\t\t.stream_name = \"BT Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 1,\n\t\t\t.rates = (SNDRV_PCM_RATE_8000\n\t\t\t\t| SNDRV_PCM_RATE_16000),\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"BT Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 1,\n\t\t\t.rates = (SNDRV_PCM_RATE_8000\n\t\t\t\t| SNDRV_PCM_RATE_16000),\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mt2701_btmrg_ops,\n\t\t.symmetric_rate = 1,\n\t}\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o00_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I00 Switch\", AFE_CONN0, 0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o01_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I01 Switch\", AFE_CONN1, 1, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o02_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I02 Switch\", AFE_CONN2, 2, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o03_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I03 Switch\", AFE_CONN3, 3, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o14_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I26 Switch\", AFE_CONN14, 26, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o15_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I12 Switch\", AFE_CONN15, 12, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o16_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I13 Switch\", AFE_CONN16, 13, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o17_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I14 Switch\", AFE_CONN17, 14, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o18_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I15 Switch\", AFE_CONN18, 15, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o19_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I16 Switch\", AFE_CONN19, 16, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o20_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I17 Switch\", AFE_CONN20, 17, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o21_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I18 Switch\", AFE_CONN21, 18, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o22_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I19 Switch\", AFE_CONN22, 19, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_o31_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I35 Switch\", AFE_CONN41, 9, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_i02_mix[] = {\n\tSOC_DAPM_SINGLE(\"I2S0 Switch\", SND_SOC_NOPM, 0, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_multi_ch_out_i2s0[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"Multich I2S0 Out Switch\",\n\t\t\t\t    ASYS_I2SO1_CON, 26, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_multi_ch_out_i2s1[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"Multich I2S1 Out Switch\",\n\t\t\t\t    ASYS_I2SO2_CON, 26, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_multi_ch_out_i2s2[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"Multich I2S2 Out Switch\",\n\t\t\t\t    PWR2_TOP_CON, 17, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt2701_afe_multi_ch_out_i2s3[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"Multich I2S3 Out Switch\",\n\t\t\t\t    PWR2_TOP_CON, 18, 1, 0),\n};\n\nstatic const struct snd_soc_dapm_widget mt2701_afe_pcm_widgets[] = {\n\t \n\tSND_SOC_DAPM_MIXER(\"I00\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I01\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I02\", SND_SOC_NOPM, 0, 0, mt2701_afe_i02_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_i02_mix)),\n\tSND_SOC_DAPM_MIXER(\"I03\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I12\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I13\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I14\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I15\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I16\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I17\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I18\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I19\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I26\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I35\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MIXER(\"O00\", SND_SOC_NOPM, 0, 0, mt2701_afe_o00_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o00_mix)),\n\tSND_SOC_DAPM_MIXER(\"O01\", SND_SOC_NOPM, 0, 0, mt2701_afe_o01_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o01_mix)),\n\tSND_SOC_DAPM_MIXER(\"O02\", SND_SOC_NOPM, 0, 0, mt2701_afe_o02_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o02_mix)),\n\tSND_SOC_DAPM_MIXER(\"O03\", SND_SOC_NOPM, 0, 0, mt2701_afe_o03_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o03_mix)),\n\tSND_SOC_DAPM_MIXER(\"O14\", SND_SOC_NOPM, 0, 0, mt2701_afe_o14_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o14_mix)),\n\tSND_SOC_DAPM_MIXER(\"O15\", SND_SOC_NOPM, 0, 0, mt2701_afe_o15_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o15_mix)),\n\tSND_SOC_DAPM_MIXER(\"O16\", SND_SOC_NOPM, 0, 0, mt2701_afe_o16_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o16_mix)),\n\tSND_SOC_DAPM_MIXER(\"O17\", SND_SOC_NOPM, 0, 0, mt2701_afe_o17_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o17_mix)),\n\tSND_SOC_DAPM_MIXER(\"O18\", SND_SOC_NOPM, 0, 0, mt2701_afe_o18_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o18_mix)),\n\tSND_SOC_DAPM_MIXER(\"O19\", SND_SOC_NOPM, 0, 0, mt2701_afe_o19_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o19_mix)),\n\tSND_SOC_DAPM_MIXER(\"O20\", SND_SOC_NOPM, 0, 0, mt2701_afe_o20_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o20_mix)),\n\tSND_SOC_DAPM_MIXER(\"O21\", SND_SOC_NOPM, 0, 0, mt2701_afe_o21_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o21_mix)),\n\tSND_SOC_DAPM_MIXER(\"O22\", SND_SOC_NOPM, 0, 0, mt2701_afe_o22_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o22_mix)),\n\tSND_SOC_DAPM_MIXER(\"O31\", SND_SOC_NOPM, 0, 0, mt2701_afe_o31_mix,\n\t\t\t   ARRAY_SIZE(mt2701_afe_o31_mix)),\n\n\tSND_SOC_DAPM_MIXER(\"I12I13\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt2701_afe_multi_ch_out_i2s0,\n\t\t\t   ARRAY_SIZE(mt2701_afe_multi_ch_out_i2s0)),\n\tSND_SOC_DAPM_MIXER(\"I14I15\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt2701_afe_multi_ch_out_i2s1,\n\t\t\t   ARRAY_SIZE(mt2701_afe_multi_ch_out_i2s1)),\n\tSND_SOC_DAPM_MIXER(\"I16I17\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt2701_afe_multi_ch_out_i2s2,\n\t\t\t   ARRAY_SIZE(mt2701_afe_multi_ch_out_i2s2)),\n\tSND_SOC_DAPM_MIXER(\"I18I19\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt2701_afe_multi_ch_out_i2s3,\n\t\t\t   ARRAY_SIZE(mt2701_afe_multi_ch_out_i2s3)),\n};\n\nstatic const struct snd_soc_dapm_route mt2701_afe_pcm_routes[] = {\n\t{\"I12\", NULL, \"DL1\"},\n\t{\"I13\", NULL, \"DL1\"},\n\t{\"I35\", NULL, \"DLBT\"},\n\n\t{\"I2S0 Playback\", NULL, \"O15\"},\n\t{\"I2S0 Playback\", NULL, \"O16\"},\n\t{\"I2S1 Playback\", NULL, \"O17\"},\n\t{\"I2S1 Playback\", NULL, \"O18\"},\n\t{\"I2S2 Playback\", NULL, \"O19\"},\n\t{\"I2S2 Playback\", NULL, \"O20\"},\n\t{\"I2S3 Playback\", NULL, \"O21\"},\n\t{\"I2S3 Playback\", NULL, \"O22\"},\n\t{\"BT Playback\", NULL, \"O31\"},\n\n\t{\"UL1\", NULL, \"O00\"},\n\t{\"UL1\", NULL, \"O01\"},\n\t{\"UL2\", NULL, \"O02\"},\n\t{\"UL2\", NULL, \"O03\"},\n\t{\"ULBT\", NULL, \"O14\"},\n\n\t{\"I00\", NULL, \"I2S0 Capture\"},\n\t{\"I01\", NULL, \"I2S0 Capture\"},\n\t{\"I02\", NULL, \"I2S1 Capture\"},\n\t{\"I03\", NULL, \"I2S1 Capture\"},\n\t \n\t{\"I02\", \"I2S0 Switch\", \"I2S0 Capture\"},\n\n\t{\"I26\", NULL, \"BT Capture\"},\n\n\t{\"I12I13\", \"Multich I2S0 Out Switch\", \"DLM\"},\n\t{\"I14I15\", \"Multich I2S1 Out Switch\", \"DLM\"},\n\t{\"I16I17\", \"Multich I2S2 Out Switch\", \"DLM\"},\n\t{\"I18I19\", \"Multich I2S3 Out Switch\", \"DLM\"},\n\n\t{ \"I12\", NULL, \"I12I13\" },\n\t{ \"I13\", NULL, \"I12I13\" },\n\t{ \"I14\", NULL, \"I14I15\" },\n\t{ \"I15\", NULL, \"I14I15\" },\n\t{ \"I16\", NULL, \"I16I17\" },\n\t{ \"I17\", NULL, \"I16I17\" },\n\t{ \"I18\", NULL, \"I18I19\" },\n\t{ \"I19\", NULL, \"I18I19\" },\n\n\t{ \"O00\", \"I00 Switch\", \"I00\" },\n\t{ \"O01\", \"I01 Switch\", \"I01\" },\n\t{ \"O02\", \"I02 Switch\", \"I02\" },\n\t{ \"O03\", \"I03 Switch\", \"I03\" },\n\t{ \"O14\", \"I26 Switch\", \"I26\" },\n\t{ \"O15\", \"I12 Switch\", \"I12\" },\n\t{ \"O16\", \"I13 Switch\", \"I13\" },\n\t{ \"O17\", \"I14 Switch\", \"I14\" },\n\t{ \"O18\", \"I15 Switch\", \"I15\" },\n\t{ \"O19\", \"I16 Switch\", \"I16\" },\n\t{ \"O20\", \"I17 Switch\", \"I17\" },\n\t{ \"O21\", \"I18 Switch\", \"I18\" },\n\t{ \"O22\", \"I19 Switch\", \"I19\" },\n\t{ \"O31\", \"I35 Switch\", \"I35\" },\n};\n\nstatic int mt2701_afe_pcm_probe(struct snd_soc_component *component)\n{\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\n\tsnd_soc_component_init_regmap(component, afe->regmap);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_component_driver mt2701_afe_pcm_dai_component = {\n\t.probe = mt2701_afe_pcm_probe,\n\t.name = \"mt2701-afe-pcm-dai\",\n\t.dapm_widgets = mt2701_afe_pcm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt2701_afe_pcm_widgets),\n\t.dapm_routes = mt2701_afe_pcm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt2701_afe_pcm_routes),\n\t.suspend = mtk_afe_suspend,\n\t.resume = mtk_afe_resume,\n};\n\nstatic const struct mtk_base_memif_data memif_data_array[MT2701_MEMIF_NUM] = {\n\t{\n\t\t.name = \"DL1\",\n\t\t.id = MT2701_MEMIF_DL1,\n\t\t.reg_ofs_base = AFE_DL1_BASE,\n\t\t.reg_ofs_cur = AFE_DL1_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 0,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON3,\n\t\t.mono_shift = 16,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 1,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 0,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 6,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"DL2\",\n\t\t.id = MT2701_MEMIF_DL2,\n\t\t.reg_ofs_base = AFE_DL2_BASE,\n\t\t.reg_ofs_cur = AFE_DL2_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 5,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON3,\n\t\t.mono_shift = 17,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 2,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 2,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 7,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"DL3\",\n\t\t.id = MT2701_MEMIF_DL3,\n\t\t.reg_ofs_base = AFE_DL3_BASE,\n\t\t.reg_ofs_cur = AFE_DL3_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 10,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON3,\n\t\t.mono_shift = 18,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 3,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 4,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 8,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"DL4\",\n\t\t.id = MT2701_MEMIF_DL4,\n\t\t.reg_ofs_base = AFE_DL4_BASE,\n\t\t.reg_ofs_cur = AFE_DL4_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 15,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON3,\n\t\t.mono_shift = 19,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 4,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 6,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 9,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"DL5\",\n\t\t.id = MT2701_MEMIF_DL5,\n\t\t.reg_ofs_base = AFE_DL5_BASE,\n\t\t.reg_ofs_cur = AFE_DL5_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 20,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON3,\n\t\t.mono_shift = 20,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 5,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 8,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 10,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"DLM\",\n\t\t.id = MT2701_MEMIF_DLM,\n\t\t.reg_ofs_base = AFE_DLMCH_BASE,\n\t\t.reg_ofs_cur = AFE_DLMCH_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 0,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = -1,\n\t\t.mono_shift = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 7,\n\t\t.hd_reg = AFE_MEMIF_PBUF_SIZE,\n\t\t.hd_shift = 28,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 12,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"UL1\",\n\t\t.id = MT2701_MEMIF_UL1,\n\t\t.reg_ofs_base = AFE_VUL_BASE,\n\t\t.reg_ofs_cur = AFE_VUL_CUR,\n\t\t.fs_reg = AFE_DAC_CON2,\n\t\t.fs_shift = 0,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON4,\n\t\t.mono_shift = 0,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 10,\n\t\t.hd_reg = AFE_MEMIF_HD_CON1,\n\t\t.hd_shift = 0,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 0,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"UL2\",\n\t\t.id = MT2701_MEMIF_UL2,\n\t\t.reg_ofs_base = AFE_UL2_BASE,\n\t\t.reg_ofs_cur = AFE_UL2_CUR,\n\t\t.fs_reg = AFE_DAC_CON2,\n\t\t.fs_shift = 5,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON4,\n\t\t.mono_shift = 2,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 11,\n\t\t.hd_reg = AFE_MEMIF_HD_CON1,\n\t\t.hd_shift = 2,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 1,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"UL3\",\n\t\t.id = MT2701_MEMIF_UL3,\n\t\t.reg_ofs_base = AFE_UL3_BASE,\n\t\t.reg_ofs_cur = AFE_UL3_CUR,\n\t\t.fs_reg = AFE_DAC_CON2,\n\t\t.fs_shift = 10,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON4,\n\t\t.mono_shift = 4,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 12,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 0,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 2,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"UL4\",\n\t\t.id = MT2701_MEMIF_UL4,\n\t\t.reg_ofs_base = AFE_UL4_BASE,\n\t\t.reg_ofs_cur = AFE_UL4_CUR,\n\t\t.fs_reg = AFE_DAC_CON2,\n\t\t.fs_shift = 15,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON4,\n\t\t.mono_shift = 6,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 13,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 6,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 3,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"UL5\",\n\t\t.id = MT2701_MEMIF_UL5,\n\t\t.reg_ofs_base = AFE_UL5_BASE,\n\t\t.reg_ofs_cur = AFE_UL5_CUR,\n\t\t.fs_reg = AFE_DAC_CON2,\n\t\t.fs_shift = 20,\n\t\t.mono_reg = AFE_DAC_CON4,\n\t\t.mono_shift = 8,\n\t\t.fs_maskbit = 0x1f,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 14,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 8,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 4,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"DLBT\",\n\t\t.id = MT2701_MEMIF_DLBT,\n\t\t.reg_ofs_base = AFE_ARB1_BASE,\n\t\t.reg_ofs_cur = AFE_ARB1_CUR,\n\t\t.fs_reg = AFE_DAC_CON3,\n\t\t.fs_shift = 10,\n\t\t.fs_maskbit = 0x1f,\n\t\t.mono_reg = AFE_DAC_CON3,\n\t\t.mono_shift = 22,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 8,\n\t\t.hd_reg = AFE_MEMIF_HD_CON0,\n\t\t.hd_shift = 14,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 13,\n\t\t.msb_reg = -1,\n\t},\n\t{\n\t\t.name = \"ULBT\",\n\t\t.id = MT2701_MEMIF_ULBT,\n\t\t.reg_ofs_base = AFE_DAI_BASE,\n\t\t.reg_ofs_cur = AFE_DAI_CUR,\n\t\t.fs_reg = AFE_DAC_CON2,\n\t\t.fs_shift = 30,\n\t\t.fs_maskbit = 0x1,\n\t\t.mono_reg = -1,\n\t\t.mono_shift = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 17,\n\t\t.hd_reg = AFE_MEMIF_HD_CON1,\n\t\t.hd_shift = 20,\n\t\t.agent_disable_reg = AUDIO_TOP_CON5,\n\t\t.agent_disable_shift = 16,\n\t\t.msb_reg = -1,\n\t},\n};\n\nstatic const struct mtk_base_irq_data irq_data[MT2701_IRQ_ASYS_END] = {\n\t{\n\t\t.id = MT2701_IRQ_ASYS_IRQ1,\n\t\t.irq_cnt_reg = ASYS_IRQ1_CON,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0xffffff,\n\t\t.irq_fs_reg = ASYS_IRQ1_CON,\n\t\t.irq_fs_shift = 24,\n\t\t.irq_fs_maskbit = 0x1f,\n\t\t.irq_en_reg = ASYS_IRQ1_CON,\n\t\t.irq_en_shift = 31,\n\t\t.irq_clr_reg = ASYS_IRQ_CLR,\n\t\t.irq_clr_shift = 0,\n\t},\n\t{\n\t\t.id = MT2701_IRQ_ASYS_IRQ2,\n\t\t.irq_cnt_reg = ASYS_IRQ2_CON,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0xffffff,\n\t\t.irq_fs_reg = ASYS_IRQ2_CON,\n\t\t.irq_fs_shift = 24,\n\t\t.irq_fs_maskbit = 0x1f,\n\t\t.irq_en_reg = ASYS_IRQ2_CON,\n\t\t.irq_en_shift = 31,\n\t\t.irq_clr_reg = ASYS_IRQ_CLR,\n\t\t.irq_clr_shift = 1,\n\t},\n\t{\n\t\t.id = MT2701_IRQ_ASYS_IRQ3,\n\t\t.irq_cnt_reg = ASYS_IRQ3_CON,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0xffffff,\n\t\t.irq_fs_reg = ASYS_IRQ3_CON,\n\t\t.irq_fs_shift = 24,\n\t\t.irq_fs_maskbit = 0x1f,\n\t\t.irq_en_reg = ASYS_IRQ3_CON,\n\t\t.irq_en_shift = 31,\n\t\t.irq_clr_reg = ASYS_IRQ_CLR,\n\t\t.irq_clr_shift = 2,\n\t}\n};\n\nstatic const struct mt2701_i2s_data mt2701_i2s_data[][2] = {\n\t{\n\t\t{ ASYS_I2SO1_CON, 0, 0x1f },\n\t\t{ ASYS_I2SIN1_CON, 0, 0x1f },\n\t},\n\t{\n\t\t{ ASYS_I2SO2_CON, 5, 0x1f },\n\t\t{ ASYS_I2SIN2_CON, 5, 0x1f },\n\t},\n\t{\n\t\t{ ASYS_I2SO3_CON, 10, 0x1f },\n\t\t{ ASYS_I2SIN3_CON, 10, 0x1f },\n\t},\n\t{\n\t\t{ ASYS_I2SO4_CON, 15, 0x1f },\n\t\t{ ASYS_I2SIN4_CON, 15, 0x1f },\n\t},\n\t \n};\n\nstatic irqreturn_t mt2701_asys_isr(int irq_id, void *dev)\n{\n\tint id;\n\tstruct mtk_base_afe *afe = dev;\n\tstruct mtk_base_afe_memif *memif;\n\tstruct mtk_base_afe_irq *irq;\n\tu32 status;\n\n\tregmap_read(afe->regmap, ASYS_IRQ_STATUS, &status);\n\tregmap_write(afe->regmap, ASYS_IRQ_CLR, status);\n\n\tfor (id = 0; id < MT2701_MEMIF_NUM; ++id) {\n\t\tmemif = &afe->memif[id];\n\t\tif (memif->irq_usage < 0)\n\t\t\tcontinue;\n\n\t\tirq = &afe->irqs[memif->irq_usage];\n\t\tif (status & 1 << irq->irq_data->irq_clr_shift)\n\t\t\tsnd_pcm_period_elapsed(memif->substream);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int mt2701_afe_runtime_suspend(struct device *dev)\n{\n\tstruct mtk_base_afe *afe = dev_get_drvdata(dev);\n\n\treturn mt2701_afe_disable_clock(afe);\n}\n\nstatic int mt2701_afe_runtime_resume(struct device *dev)\n{\n\tstruct mtk_base_afe *afe = dev_get_drvdata(dev);\n\n\treturn mt2701_afe_enable_clock(afe);\n}\n\nstatic int mt2701_afe_pcm_dev_probe(struct platform_device *pdev)\n{\n\tstruct mtk_base_afe *afe;\n\tstruct mt2701_afe_private *afe_priv;\n\tstruct device *dev;\n\tint i, irq_id, ret;\n\n\tafe = devm_kzalloc(&pdev->dev, sizeof(*afe), GFP_KERNEL);\n\tif (!afe)\n\t\treturn -ENOMEM;\n\n\tafe->platform_priv = devm_kzalloc(&pdev->dev, sizeof(*afe_priv),\n\t\t\t\t\t  GFP_KERNEL);\n\tif (!afe->platform_priv)\n\t\treturn -ENOMEM;\n\n\tafe_priv = afe->platform_priv;\n\tafe_priv->soc = of_device_get_match_data(&pdev->dev);\n\tafe->dev = &pdev->dev;\n\tdev = afe->dev;\n\n\tafe_priv->i2s_path = devm_kcalloc(dev,\n\t\t\t\t\t  afe_priv->soc->i2s_num,\n\t\t\t\t\t  sizeof(struct mt2701_i2s_path),\n\t\t\t\t\t  GFP_KERNEL);\n\tif (!afe_priv->i2s_path)\n\t\treturn -ENOMEM;\n\n\tirq_id = platform_get_irq_byname(pdev, \"asys\");\n\tif (irq_id < 0)\n\t\treturn irq_id;\n\n\tret = devm_request_irq(dev, irq_id, mt2701_asys_isr,\n\t\t\t       IRQF_TRIGGER_NONE, \"asys-isr\", (void *)afe);\n\tif (ret) {\n\t\tdev_err(dev, \"could not request_irq for asys-isr\\n\");\n\t\treturn ret;\n\t}\n\n\tafe->regmap = syscon_node_to_regmap(dev->parent->of_node);\n\tif (IS_ERR(afe->regmap)) {\n\t\tdev_err(dev, \"could not get regmap from parent\\n\");\n\t\treturn PTR_ERR(afe->regmap);\n\t}\n\n\tmutex_init(&afe->irq_alloc_lock);\n\n\t \n\tafe->memif_size = MT2701_MEMIF_NUM;\n\tafe->memif = devm_kcalloc(dev, afe->memif_size, sizeof(*afe->memif),\n\t\t\t\t  GFP_KERNEL);\n\tif (!afe->memif)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < afe->memif_size; i++) {\n\t\tafe->memif[i].data = &memif_data_array[i];\n\t\tafe->memif[i].irq_usage = -1;\n\t}\n\n\t \n\tafe->irqs_size = MT2701_IRQ_ASYS_END;\n\tafe->irqs = devm_kcalloc(dev, afe->irqs_size, sizeof(*afe->irqs),\n\t\t\t\t GFP_KERNEL);\n\tif (!afe->irqs)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < afe->irqs_size; i++)\n\t\tafe->irqs[i].irq_data = &irq_data[i];\n\n\t \n\tfor (i = 0; i < afe_priv->soc->i2s_num; i++) {\n\t\tafe_priv->i2s_path[i].i2s_data[SNDRV_PCM_STREAM_PLAYBACK] =\n\t\t\t&mt2701_i2s_data[i][SNDRV_PCM_STREAM_PLAYBACK];\n\t\tafe_priv->i2s_path[i].i2s_data[SNDRV_PCM_STREAM_CAPTURE] =\n\t\t\t&mt2701_i2s_data[i][SNDRV_PCM_STREAM_CAPTURE];\n\t}\n\n\tafe->mtk_afe_hardware = &mt2701_afe_hardware;\n\tafe->memif_fs = mt2701_memif_fs;\n\tafe->irq_fs = mt2701_irq_fs;\n\tafe->reg_back_up_list = mt2701_afe_backup_list;\n\tafe->reg_back_up_list_num = ARRAY_SIZE(mt2701_afe_backup_list);\n\tafe->runtime_resume = mt2701_afe_runtime_resume;\n\tafe->runtime_suspend = mt2701_afe_runtime_suspend;\n\n\t \n\tret = mt2701_init_clock(afe);\n\tif (ret) {\n\t\tdev_err(dev, \"init clock error\\n\");\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, afe);\n\n\tpm_runtime_enable(dev);\n\tif (!pm_runtime_enabled(dev)) {\n\t\tret = mt2701_afe_runtime_resume(dev);\n\t\tif (ret)\n\t\t\tgoto err_pm_disable;\n\t}\n\tpm_runtime_get_sync(dev);\n\n\tret = devm_snd_soc_register_component(&pdev->dev, &mtk_afe_pcm_platform,\n\t\t\t\t\t      NULL, 0);\n\tif (ret) {\n\t\tdev_warn(dev, \"err_platform\\n\");\n\t\tgoto err_platform;\n\t}\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t\t &mt2701_afe_pcm_dai_component,\n\t\t\t\t\t mt2701_afe_pcm_dais,\n\t\t\t\t\t ARRAY_SIZE(mt2701_afe_pcm_dais));\n\tif (ret) {\n\t\tdev_warn(dev, \"err_dai_component\\n\");\n\t\tgoto err_platform;\n\t}\n\n\treturn 0;\n\nerr_platform:\n\tpm_runtime_put_sync(dev);\nerr_pm_disable:\n\tpm_runtime_disable(dev);\n\n\treturn ret;\n}\n\nstatic void mt2701_afe_pcm_dev_remove(struct platform_device *pdev)\n{\n\tpm_runtime_put_sync(&pdev->dev);\n\tpm_runtime_disable(&pdev->dev);\n\tif (!pm_runtime_status_suspended(&pdev->dev))\n\t\tmt2701_afe_runtime_suspend(&pdev->dev);\n}\n\nstatic const struct mt2701_soc_variants mt2701_soc_v1 = {\n\t.i2s_num = 4,\n};\n\nstatic const struct mt2701_soc_variants mt2701_soc_v2 = {\n\t.has_one_heart_mode = true,\n\t.i2s_num = 4,\n};\n\nstatic const struct of_device_id mt2701_afe_pcm_dt_match[] = {\n\t{ .compatible = \"mediatek,mt2701-audio\", .data = &mt2701_soc_v1 },\n\t{ .compatible = \"mediatek,mt7622-audio\", .data = &mt2701_soc_v2 },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mt2701_afe_pcm_dt_match);\n\nstatic const struct dev_pm_ops mt2701_afe_pm_ops = {\n\tSET_RUNTIME_PM_OPS(mt2701_afe_runtime_suspend,\n\t\t\t   mt2701_afe_runtime_resume, NULL)\n};\n\nstatic struct platform_driver mt2701_afe_pcm_driver = {\n\t.driver = {\n\t\t   .name = \"mt2701-audio\",\n\t\t   .of_match_table = mt2701_afe_pcm_dt_match,\n\t\t   .pm = &mt2701_afe_pm_ops,\n\t},\n\t.probe = mt2701_afe_pcm_dev_probe,\n\t.remove_new = mt2701_afe_pcm_dev_remove,\n};\n\nmodule_platform_driver(mt2701_afe_pcm_driver);\n\nMODULE_DESCRIPTION(\"Mediatek ALSA SoC AFE platform driver for 2701\");\nMODULE_AUTHOR(\"Garlic Tseng <garlic.tseng@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}