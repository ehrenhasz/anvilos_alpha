{
  "module_name": "mt6797-dai-adda.c",
  "hash_id": "98048471776251c8ccea10fa81958aa7ebad1787b0ef053b4213ba2840f09337",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt6797/mt6797-dai-adda.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/regmap.h>\n#include <linux/delay.h>\n#include \"mt6797-afe-common.h\"\n#include \"mt6797-interconnection.h\"\n#include \"mt6797-reg.h\"\n\nenum {\n\tMTK_AFE_ADDA_DL_RATE_8K = 0,\n\tMTK_AFE_ADDA_DL_RATE_11K = 1,\n\tMTK_AFE_ADDA_DL_RATE_12K = 2,\n\tMTK_AFE_ADDA_DL_RATE_16K = 3,\n\tMTK_AFE_ADDA_DL_RATE_22K = 4,\n\tMTK_AFE_ADDA_DL_RATE_24K = 5,\n\tMTK_AFE_ADDA_DL_RATE_32K = 6,\n\tMTK_AFE_ADDA_DL_RATE_44K = 7,\n\tMTK_AFE_ADDA_DL_RATE_48K = 8,\n\tMTK_AFE_ADDA_DL_RATE_96K = 9,\n\tMTK_AFE_ADDA_DL_RATE_192K = 10,\n};\n\nenum {\n\tMTK_AFE_ADDA_UL_RATE_8K = 0,\n\tMTK_AFE_ADDA_UL_RATE_16K = 1,\n\tMTK_AFE_ADDA_UL_RATE_32K = 2,\n\tMTK_AFE_ADDA_UL_RATE_48K = 3,\n\tMTK_AFE_ADDA_UL_RATE_96K = 4,\n\tMTK_AFE_ADDA_UL_RATE_192K = 5,\n\tMTK_AFE_ADDA_UL_RATE_48K_HD = 6,\n};\n\nstatic unsigned int adda_dl_rate_transform(struct mtk_base_afe *afe,\n\t\t\t\t\t   unsigned int rate)\n{\n\tswitch (rate) {\n\tcase 8000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_8K;\n\tcase 11025:\n\t\treturn MTK_AFE_ADDA_DL_RATE_11K;\n\tcase 12000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_12K;\n\tcase 16000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_16K;\n\tcase 22050:\n\t\treturn MTK_AFE_ADDA_DL_RATE_22K;\n\tcase 24000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_24K;\n\tcase 32000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_32K;\n\tcase 44100:\n\t\treturn MTK_AFE_ADDA_DL_RATE_44K;\n\tcase 48000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_48K;\n\tcase 96000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_96K;\n\tcase 192000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_192K;\n\tdefault:\n\t\tdev_warn(afe->dev, \"%s(), rate %d invalid, use 48kHz!!!\\n\",\n\t\t\t __func__, rate);\n\t\treturn MTK_AFE_ADDA_DL_RATE_48K;\n\t}\n}\n\nstatic unsigned int adda_ul_rate_transform(struct mtk_base_afe *afe,\n\t\t\t\t\t   unsigned int rate)\n{\n\tswitch (rate) {\n\tcase 8000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_8K;\n\tcase 16000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_16K;\n\tcase 32000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_32K;\n\tcase 48000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_48K;\n\tcase 96000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_96K;\n\tcase 192000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_192K;\n\tdefault:\n\t\tdev_warn(afe->dev, \"%s(), rate %d invalid, use 48kHz!!!\\n\",\n\t\t\t __func__, rate);\n\t\treturn MTK_AFE_ADDA_UL_RATE_48K;\n\t}\n}\n\n \nstatic const struct snd_kcontrol_new mtk_adda_dl_ch1_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH1\", AFE_CONN3, I_DL1_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH1\", AFE_CONN3, I_DL2_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH1\", AFE_CONN3, I_DL3_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH2\", AFE_CONN3,\n\t\t\t\t    I_ADDA_UL_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH1\", AFE_CONN3,\n\t\t\t\t    I_ADDA_UL_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH1\", AFE_CONN3,\n\t\t\t\t    I_PCM_1_CAP_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_2_CAP_CH1\", AFE_CONN3,\n\t\t\t\t    I_PCM_2_CAP_CH1, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_adda_dl_ch2_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH1\", AFE_CONN4, I_DL1_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH2\", AFE_CONN4, I_DL1_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH1\", AFE_CONN4, I_DL2_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH2\", AFE_CONN4, I_DL2_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH1\", AFE_CONN4, I_DL3_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH2\", AFE_CONN4, I_DL3_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH2\", AFE_CONN4,\n\t\t\t\t    I_ADDA_UL_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH1\", AFE_CONN4,\n\t\t\t\t    I_ADDA_UL_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH1\", AFE_CONN4,\n\t\t\t\t    I_PCM_1_CAP_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_2_CAP_CH1\", AFE_CONN4,\n\t\t\t\t    I_PCM_2_CAP_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH2\", AFE_CONN4,\n\t\t\t\t    I_PCM_1_CAP_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_2_CAP_CH2\", AFE_CONN4,\n\t\t\t\t    I_PCM_2_CAP_CH2, 1, 0),\n};\n\nstatic int mtk_adda_ul_event(struct snd_soc_dapm_widget *w,\n\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(afe->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tusleep_range(125, 135);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nenum {\n\tSUPPLY_SEQ_AUD_TOP_PDN,\n\tSUPPLY_SEQ_ADDA_AFE_ON,\n\tSUPPLY_SEQ_ADDA_DL_ON,\n\tSUPPLY_SEQ_ADDA_UL_ON,\n};\n\nstatic const struct snd_soc_dapm_widget mtk_dai_adda_widgets[] = {\n\t \n\tSND_SOC_DAPM_MIXER(\"ADDA_DL_CH1\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_adda_dl_ch1_mix,\n\t\t\t   ARRAY_SIZE(mtk_adda_dl_ch1_mix)),\n\tSND_SOC_DAPM_MIXER(\"ADDA_DL_CH2\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_adda_dl_ch2_mix,\n\t\t\t   ARRAY_SIZE(mtk_adda_dl_ch2_mix)),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA Enable\", SUPPLY_SEQ_ADDA_AFE_ON,\n\t\t\t      AFE_ADDA_UL_DL_CON0, ADDA_AFE_ON_SFT, 0,\n\t\t\t      NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA Playback Enable\", SUPPLY_SEQ_ADDA_DL_ON,\n\t\t\t      AFE_ADDA_DL_SRC2_CON0,\n\t\t\t      DL_2_SRC_ON_TMP_CTL_PRE_SFT, 0,\n\t\t\t      NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA Capture Enable\", SUPPLY_SEQ_ADDA_UL_ON,\n\t\t\t      AFE_ADDA_UL_SRC_CON0,\n\t\t\t      UL_SRC_ON_TMP_CTL_SFT, 0,\n\t\t\t      mtk_adda_ul_event,\n\t\t\t      SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"aud_dac_clk\", SUPPLY_SEQ_AUD_TOP_PDN,\n\t\t\t      AUDIO_TOP_CON0, PDN_DAC_SFT, 1,\n\t\t\t      NULL, 0),\n\tSND_SOC_DAPM_SUPPLY_S(\"aud_dac_predis_clk\", SUPPLY_SEQ_AUD_TOP_PDN,\n\t\t\t      AUDIO_TOP_CON0, PDN_DAC_PREDIS_SFT, 1,\n\t\t\t      NULL, 0),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"aud_adc_clk\", SUPPLY_SEQ_AUD_TOP_PDN,\n\t\t\t      AUDIO_TOP_CON0, PDN_ADC_SFT, 1,\n\t\t\t      NULL, 0),\n\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"mtkaif_26m_clk\"),\n};\n\nstatic const struct snd_soc_dapm_route mtk_dai_adda_routes[] = {\n\t \n\t{\"ADDA_DL_CH1\", \"DL1_CH1\", \"DL1\"},\n\t{\"ADDA_DL_CH2\", \"DL1_CH1\", \"DL1\"},\n\t{\"ADDA_DL_CH2\", \"DL1_CH2\", \"DL1\"},\n\n\t{\"ADDA_DL_CH1\", \"DL2_CH1\", \"DL2\"},\n\t{\"ADDA_DL_CH2\", \"DL2_CH1\", \"DL2\"},\n\t{\"ADDA_DL_CH2\", \"DL2_CH2\", \"DL2\"},\n\n\t{\"ADDA_DL_CH1\", \"DL3_CH1\", \"DL3\"},\n\t{\"ADDA_DL_CH2\", \"DL3_CH1\", \"DL3\"},\n\t{\"ADDA_DL_CH2\", \"DL3_CH2\", \"DL3\"},\n\n\t{\"ADDA Playback\", NULL, \"ADDA_DL_CH1\"},\n\t{\"ADDA Playback\", NULL, \"ADDA_DL_CH2\"},\n\n\t \n\t{\"ADDA Playback\", NULL, \"ADDA Enable\"},\n\t{\"ADDA Playback\", NULL, \"ADDA Playback Enable\"},\n\t{\"ADDA Capture\", NULL, \"ADDA Enable\"},\n\t{\"ADDA Capture\", NULL, \"ADDA Capture Enable\"},\n\n\t \n\t{\"ADDA Playback\", NULL, \"mtkaif_26m_clk\"},\n\t{\"ADDA Playback\", NULL, \"aud_dac_clk\"},\n\t{\"ADDA Playback\", NULL, \"aud_dac_predis_clk\"},\n\n\t{\"ADDA Capture\", NULL, \"mtkaif_26m_clk\"},\n\t{\"ADDA Capture\", NULL, \"aud_adc_clk\"},\n};\n\n \nstatic int mtk_dai_adda_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_pcm_hw_params *params,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tunsigned int rate = params_rate(params);\n\n\tdev_dbg(afe->dev, \"%s(), id %d, stream %d, rate %d\\n\",\n\t\t__func__, dai->id, substream->stream, rate);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\n\t\tunsigned int dl_src2_con0 = 0;\n\t\tunsigned int dl_src2_con1 = 0;\n\n\t\t \n\t\tregmap_write(afe->regmap, AFE_ADDA_PREDIS_CON0, 0);\n\t\tregmap_write(afe->regmap, AFE_ADDA_PREDIS_CON1, 0);\n\n\t\t \n\t\tdl_src2_con0 = adda_dl_rate_transform(afe, rate) << 28;\n\n\t\t \n\t\tswitch (rate) {\n\t\tcase 192000:\n\t\t\tdl_src2_con0 |= (0x1 << 24);  \n\t\t\tdl_src2_con0 |= 1 << 14;\n\t\t\tbreak;\n\t\tcase 96000:\n\t\t\tdl_src2_con0 |= (0x2 << 24);  \n\t\t\tdl_src2_con0 |= 1 << 14;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdl_src2_con0 |= (0x3 << 24);  \n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tdl_src2_con0 |= (0x03 << 11);\n\n\t\t \n\t\tif (rate == 8000 || rate == 16000)\n\t\t\tdl_src2_con0 |= 0x01 << 5;\n\n\t\tif (rate < 96000) {\n\t\t\t \n\t\t\tdl_src2_con1 = 0xf74f0000;\n\t\t} else {\n\t\t\t \n\t\t\tdl_src2_con1 = 0x7ba70000;\n\t\t}\n\n\t\t \n\t\tdl_src2_con0 = dl_src2_con0 | (0x01 << 1);\n\n\t\tregmap_write(afe->regmap, AFE_ADDA_DL_SRC2_CON0, dl_src2_con0);\n\t\tregmap_write(afe->regmap, AFE_ADDA_DL_SRC2_CON1, dl_src2_con1);\n\t} else {\n\t\tunsigned int voice_mode = 0;\n\t\tunsigned int ul_src_con0 = 0;\t \n\n\t\t \n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ADDA_TOP_CON0,\n\t\t\t\t   0x1 << 0,\n\t\t\t\t   0x0 << 0);\n\n\t\tvoice_mode = adda_ul_rate_transform(afe, rate);\n\n\t\tul_src_con0 |= (voice_mode << 17) & (0x7 << 17);\n\n\t\t \n\t\tregmap_write(afe->regmap, AFE_ADDA_NEWIF_CFG0, 0x03F87201);\n\n\t\tif (rate >= 96000) {\t \n\t\t\t \n\t\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t\t   AFE_ADDA_NEWIF_CFG0,\n\t\t\t\t\t   0x1 << 5,\n\t\t\t\t\t   0x1 << 5);\n\n\t\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t\t   AFE_ADDA_NEWIF_CFG2,\n\t\t\t\t\t   0xf << 28,\n\t\t\t\t\t   voice_mode << 28);\n\t\t} else {\t \n\t\t\t \n\t\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t\t   AFE_ADDA_NEWIF_CFG2,\n\t\t\t\t\t   0xf << 28,\n\t\t\t\t\t   8 << 28);\n\n\t\t\t \n\t\t\tul_src_con0 |= 0x1 << 20;\n\t\t}\n\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ADDA_NEWIF_CFG2,\n\t\t\t\t   0xf << 28,\n\t\t\t\t   8 << 28);\n\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ADDA_UL_SRC_CON0,\n\t\t\t\t   0xfffffffe,\n\t\t\t\t   ul_src_con0);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops mtk_dai_adda_ops = {\n\t.hw_params = mtk_dai_adda_hw_params,\n};\n\n \n#define MTK_ADDA_PLAYBACK_RATES (SNDRV_PCM_RATE_8000_48000 |\\\n\t\t\t\t SNDRV_PCM_RATE_96000 |\\\n\t\t\t\t SNDRV_PCM_RATE_192000)\n\n#define MTK_ADDA_CAPTURE_RATES (SNDRV_PCM_RATE_8000 |\\\n\t\t\t\tSNDRV_PCM_RATE_16000 |\\\n\t\t\t\tSNDRV_PCM_RATE_32000 |\\\n\t\t\t\tSNDRV_PCM_RATE_48000 |\\\n\t\t\t\tSNDRV_PCM_RATE_96000 |\\\n\t\t\t\tSNDRV_PCM_RATE_192000)\n\n#define MTK_ADDA_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\t\t  SNDRV_PCM_FMTBIT_S24_LE |\\\n\t\t\t  SNDRV_PCM_FMTBIT_S32_LE)\n\nstatic struct snd_soc_dai_driver mtk_dai_adda_driver[] = {\n\t{\n\t\t.name = \"ADDA\",\n\t\t.id = MT6797_DAI_ADDA,\n\t\t.playback = {\n\t\t\t.stream_name = \"ADDA Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_ADDA_PLAYBACK_RATES,\n\t\t\t.formats = MTK_ADDA_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"ADDA Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_ADDA_CAPTURE_RATES,\n\t\t\t.formats = MTK_ADDA_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_adda_ops,\n\t},\n};\n\nint mt6797_dai_adda_register(struct mtk_base_afe *afe)\n{\n\tstruct mtk_base_afe_dai *dai;\n\n\tdai = devm_kzalloc(afe->dev, sizeof(*dai), GFP_KERNEL);\n\tif (!dai)\n\t\treturn -ENOMEM;\n\n\tlist_add(&dai->list, &afe->sub_dais);\n\n\tdai->dai_drivers = mtk_dai_adda_driver;\n\tdai->num_dai_drivers = ARRAY_SIZE(mtk_dai_adda_driver);\n\n\tdai->dapm_widgets = mtk_dai_adda_widgets;\n\tdai->num_dapm_widgets = ARRAY_SIZE(mtk_dai_adda_widgets);\n\tdai->dapm_routes = mtk_dai_adda_routes;\n\tdai->num_dapm_routes = ARRAY_SIZE(mtk_dai_adda_routes);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}