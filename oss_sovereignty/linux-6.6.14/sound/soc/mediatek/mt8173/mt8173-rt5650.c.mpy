{
  "module_name": "mt8173-rt5650.c",
  "hash_id": "eacbdb82fc2ae02568e976911d61882ca890694c16250c28b37db38ef91d9fd2",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8173/mt8173-rt5650.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/gpio.h>\n#include <linux/of_gpio.h>\n#include <sound/soc.h>\n#include <sound/jack.h>\n#include \"../../codecs/rt5645.h\"\n\n#define MCLK_FOR_CODECS\t\t12288000\n\nenum mt8173_rt5650_mclk {\n\tMT8173_RT5650_MCLK_EXTERNAL = 0,\n\tMT8173_RT5650_MCLK_INTERNAL,\n};\n\nstruct mt8173_rt5650_platform_data {\n\tenum mt8173_rt5650_mclk pll_from;\n\t \n};\n\nstatic struct mt8173_rt5650_platform_data mt8173_rt5650_priv = {\n\t.pll_from = MT8173_RT5650_MCLK_EXTERNAL,\n};\n\nstatic const struct snd_soc_dapm_widget mt8173_rt5650_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n\tSND_SOC_DAPM_MIC(\"Int Mic\", NULL),\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n};\n\nstatic const struct snd_soc_dapm_route mt8173_rt5650_routes[] = {\n\t{\"Ext Spk\", NULL, \"SPOL\"},\n\t{\"Ext Spk\", NULL, \"SPOR\"},\n\t{\"DMIC L1\", NULL, \"Int Mic\"},\n\t{\"DMIC R1\", NULL, \"Int Mic\"},\n\t{\"Headphone\", NULL, \"HPOL\"},\n\t{\"Headphone\", NULL, \"HPOR\"},\n\t{\"IN1P\", NULL, \"Headset Mic\"},\n\t{\"IN1N\", NULL, \"Headset Mic\"},\n};\n\nstatic const struct snd_kcontrol_new mt8173_rt5650_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Ext Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Int Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n};\n\nstatic struct snd_soc_jack_pin mt8173_rt5650_jack_pins[] = {\n\t{\n\t\t.pin\t= \"Headphone\",\n\t\t.mask\t= SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin\t= \"Headset Mic\",\n\t\t.mask\t= SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic int mt8173_rt5650_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int mclk_clock;\n\tstruct snd_soc_dai *codec_dai;\n\tint i, ret;\n\n\tswitch (mt8173_rt5650_priv.pll_from) {\n\tcase MT8173_RT5650_MCLK_EXTERNAL:\n\t\t \n\t\tmclk_clock = MCLK_FOR_CODECS;\n\t\tbreak;\n\tcase MT8173_RT5650_MCLK_INTERNAL:\n\t\t \n\t\tmclk_clock = params_rate(params) * 256;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tmclk_clock = MCLK_FOR_CODECS;\n\t\tbreak;\n\t}\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\t \n\t\tret = snd_soc_dai_set_pll(codec_dai, 0, 0, mclk_clock,\n\t\t\t\t\t  params_rate(params) * 512);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tret = snd_soc_dai_set_sysclk(codec_dai, 1,\n\t\t\t\t\t     params_rate(params) * 512,\n\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8173_rt5650_ops = {\n\t.hw_params = mt8173_rt5650_hw_params,\n};\n\nstatic struct snd_soc_jack mt8173_rt5650_jack, mt8173_rt5650_hdmi_jack;\n\nstatic int mt8173_rt5650_init(struct snd_soc_pcm_runtime *runtime)\n{\n\tstruct snd_soc_card *card = runtime->card;\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(runtime, 0)->component;\n\tconst char *codec_capture_dai = asoc_rtd_to_codec(runtime, 1)->name;\n\tint ret;\n\n\trt5645_sel_asrc_clk_src(component,\n\t\t\t\tRT5645_DA_STEREO_FILTER,\n\t\t\t\tRT5645_CLK_SEL_I2S1_ASRC);\n\n\tif (!strcmp(codec_capture_dai, \"rt5645-aif1\")) {\n\t\trt5645_sel_asrc_clk_src(component,\n\t\t\t\t\tRT5645_AD_STEREO_FILTER,\n\t\t\t\t\tRT5645_CLK_SEL_I2S1_ASRC);\n\t} else if (!strcmp(codec_capture_dai, \"rt5645-aif2\")) {\n\t\trt5645_sel_asrc_clk_src(component,\n\t\t\t\t\tRT5645_AD_STEREO_FILTER,\n\t\t\t\t\tRT5645_CLK_SEL_I2S2_ASRC);\n\t} else {\n\t\tdev_warn(card->dev,\n\t\t\t \"Only one dai codec found in DTS, enabled rt5645 AD filter\\n\");\n\t\trt5645_sel_asrc_clk_src(component,\n\t\t\t\t\tRT5645_AD_STEREO_FILTER,\n\t\t\t\t\tRT5645_CLK_SEL_I2S1_ASRC);\n\t}\n\n\t \n\tret = snd_soc_card_jack_new_pins(card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADPHONE | SND_JACK_MICROPHONE |\n\t\t\t\t\t SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t SND_JACK_BTN_2 | SND_JACK_BTN_3,\n\t\t\t\t\t &mt8173_rt5650_jack,\n\t\t\t\t\t mt8173_rt5650_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(mt8173_rt5650_jack_pins));\n\tif (ret) {\n\t\tdev_err(card->dev, \"Can't new Headset Jack %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn rt5645_set_jack_detect(component,\n\t\t\t\t      &mt8173_rt5650_jack,\n\t\t\t\t      &mt8173_rt5650_jack,\n\t\t\t\t      &mt8173_rt5650_jack);\n}\n\nstatic int mt8173_rt5650_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tint ret;\n\n\tret = snd_soc_card_jack_new(rtd->card, \"HDMI Jack\", SND_JACK_LINEOUT,\n\t\t\t\t    &mt8173_rt5650_hdmi_jack);\n\tif (ret)\n\t\treturn ret;\n\n\treturn snd_soc_component_set_jack(asoc_rtd_to_codec(rtd, 0)->component,\n\t\t\t\t\t  &mt8173_rt5650_hdmi_jack, NULL);\n}\n\nenum {\n\tDAI_LINK_PLAYBACK,\n\tDAI_LINK_CAPTURE,\n\tDAI_LINK_HDMI,\n\tDAI_LINK_CODEC_I2S,\n\tDAI_LINK_HDMI_I2S,\n};\n\nSND_SOC_DAILINK_DEFS(playback,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"VUL\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(hdmi_pcm,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"HDMI\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"rt5645-aif1\"),  \n\t\t\t   COMP_CODEC(NULL, \"rt5645-aif1\")), \n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(hdmi_be,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"HDMIO\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"i2s-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\n \nstatic struct snd_soc_dai_link mt8173_rt5650_dais[] = {\n\t \n\t[DAI_LINK_PLAYBACK] = {\n\t\t.name = \"rt5650 Playback\",\n\t\t.stream_name = \"rt5650 Playback\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback),\n\t},\n\t[DAI_LINK_CAPTURE] = {\n\t\t.name = \"rt5650 Capture\",\n\t\t.stream_name = \"rt5650 Capture\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture),\n\t},\n\t[DAI_LINK_HDMI] = {\n\t\t.name = \"HDMI\",\n\t\t.stream_name = \"HDMI PCM\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(hdmi_pcm),\n\t},\n\t \n\t[DAI_LINK_CODEC_I2S] = {\n\t\t.name = \"Codec\",\n\t\t.no_pcm = 1,\n\t\t.init = mt8173_rt5650_init,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\n\t\t\t   SND_SOC_DAIFMT_CBS_CFS,\n\t\t.ops = &mt8173_rt5650_ops,\n\t\t.ignore_pmdown_time = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(codec),\n\t},\n\t[DAI_LINK_HDMI_I2S] = {\n\t\t.name = \"HDMI BE\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.init = mt8173_rt5650_hdmi_init,\n\t\tSND_SOC_DAILINK_REG(hdmi_be),\n\t},\n};\n\nstatic struct snd_soc_card mt8173_rt5650_card = {\n\t.name = \"mtk-rt5650\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt8173_rt5650_dais,\n\t.num_links = ARRAY_SIZE(mt8173_rt5650_dais),\n\t.controls = mt8173_rt5650_controls,\n\t.num_controls = ARRAY_SIZE(mt8173_rt5650_controls),\n\t.dapm_widgets = mt8173_rt5650_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8173_rt5650_widgets),\n\t.dapm_routes = mt8173_rt5650_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt8173_rt5650_routes),\n};\n\nstatic int mt8173_rt5650_dev_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &mt8173_rt5650_card;\n\tstruct device_node *platform_node;\n\tstruct device_node *np;\n\tconst char *codec_capture_dai;\n\tstruct snd_soc_dai_link *dai_link;\n\tint i, ret;\n\n\tplatform_node = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t\t \"mediatek,platform\", 0);\n\tif (!platform_node) {\n\t\tdev_err(&pdev->dev, \"Property 'platform' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (dai_link->platforms->name)\n\t\t\tcontinue;\n\t\tdai_link->platforms->of_node = platform_node;\n\t}\n\n\tmt8173_rt5650_dais[DAI_LINK_CODEC_I2S].codecs[0].of_node =\n\t\tof_parse_phandle(pdev->dev.of_node, \"mediatek,audio-codec\", 0);\n\tif (!mt8173_rt5650_dais[DAI_LINK_CODEC_I2S].codecs[0].of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'audio-codec' missing or invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto put_platform_node;\n\t}\n\tmt8173_rt5650_dais[DAI_LINK_CODEC_I2S].codecs[1].of_node =\n\t\tmt8173_rt5650_dais[DAI_LINK_CODEC_I2S].codecs[0].of_node;\n\n\tnp = of_get_child_by_name(pdev->dev.of_node, \"codec-capture\");\n\tif (np) {\n\t\tret = snd_soc_of_get_dai_name(np, &codec_capture_dai, 0);\n\t\tof_node_put(np);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"%s codec_capture_dai name fail %d\\n\",\n\t\t\t\t__func__, ret);\n\t\t\tgoto put_platform_node;\n\t\t}\n\t\tmt8173_rt5650_dais[DAI_LINK_CODEC_I2S].codecs[1].dai_name =\n\t\t\tcodec_capture_dai;\n\t}\n\n\tif (device_property_present(&pdev->dev, \"mediatek,mclk\")) {\n\t\tret = device_property_read_u32(&pdev->dev,\n\t\t\t\t\t       \"mediatek,mclk\",\n\t\t\t\t\t       &mt8173_rt5650_priv.pll_from);\n\t\tif (ret) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"%s snd_soc_register_card fail %d\\n\",\n\t\t\t\t__func__, ret);\n\t\t}\n\t}\n\n\tmt8173_rt5650_dais[DAI_LINK_HDMI_I2S].codecs->of_node =\n\t\tof_parse_phandle(pdev->dev.of_node, \"mediatek,audio-codec\", 1);\n\tif (!mt8173_rt5650_dais[DAI_LINK_HDMI_I2S].codecs->of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'audio-codec' missing or invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto put_platform_node;\n\t}\n\tcard->dev = &pdev->dev;\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\nput_platform_node:\n\tof_node_put(platform_node);\n\treturn ret;\n}\n\nstatic const struct of_device_id mt8173_rt5650_dt_match[] = {\n\t{ .compatible = \"mediatek,mt8173-rt5650\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, mt8173_rt5650_dt_match);\n\nstatic struct platform_driver mt8173_rt5650_driver = {\n\t.driver = {\n\t\t   .name = \"mtk-rt5650\",\n\t\t   .of_match_table = mt8173_rt5650_dt_match,\n\t\t   .pm = &snd_soc_pm_ops,\n\t},\n\t.probe = mt8173_rt5650_dev_probe,\n};\n\nmodule_platform_driver(mt8173_rt5650_driver);\n\n \nMODULE_DESCRIPTION(\"MT8173 RT5650 SoC machine driver\");\nMODULE_AUTHOR(\"Koro Chen <koro.chen@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:mtk-rt5650\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}