{
  "module_name": "mt8173-afe-pcm.c",
  "hash_id": "2b6f1c2dcef0b28bf566e202da4cd647bdc2022e6abdffb89ffd5534e4d73012",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8173/mt8173-afe-pcm.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/dma-mapping.h>\n#include <linux/pm_runtime.h>\n#include <sound/soc.h>\n#include \"mt8173-afe-common.h\"\n#include \"../common/mtk-base-afe.h\"\n#include \"../common/mtk-afe-platform-driver.h\"\n#include \"../common/mtk-afe-fe-dai.h\"\n\n \n#define AUDIO_TOP_CON0\t\t0x0000\n#define AUDIO_TOP_CON1\t\t0x0004\n#define AFE_DAC_CON0\t\t0x0010\n#define AFE_DAC_CON1\t\t0x0014\n#define AFE_I2S_CON1\t\t0x0034\n#define AFE_I2S_CON2\t\t0x0038\n#define AFE_CONN_24BIT\t\t0x006c\n#define AFE_MEMIF_MSB\t\t0x00cc\n\n#define AFE_CONN1\t\t0x0024\n#define AFE_CONN2\t\t0x0028\n#define AFE_CONN3\t\t0x002c\n#define AFE_CONN7\t\t0x0460\n#define AFE_CONN8\t\t0x0464\n#define AFE_HDMI_CONN0\t\t0x0390\n\n \n#define AFE_DL1_BASE\t\t0x0040\n#define AFE_DL1_CUR\t\t0x0044\n#define AFE_DL1_END\t\t0x0048\n#define AFE_DL2_BASE\t\t0x0050\n#define AFE_DL2_CUR\t\t0x0054\n#define AFE_AWB_BASE\t\t0x0070\n#define AFE_AWB_CUR\t\t0x007c\n#define AFE_VUL_BASE\t\t0x0080\n#define AFE_VUL_CUR\t\t0x008c\n#define AFE_VUL_END\t\t0x0088\n#define AFE_DAI_BASE\t\t0x0090\n#define AFE_DAI_CUR\t\t0x009c\n#define AFE_MOD_PCM_BASE\t0x0330\n#define AFE_MOD_PCM_CUR\t\t0x033c\n#define AFE_HDMI_OUT_BASE\t0x0374\n#define AFE_HDMI_OUT_CUR\t0x0378\n#define AFE_HDMI_OUT_END\t0x037c\n\n#define AFE_ADDA_TOP_CON0\t0x0120\n#define AFE_ADDA2_TOP_CON0\t0x0600\n\n#define AFE_HDMI_OUT_CON0\t0x0370\n\n#define AFE_IRQ_MCU_CON\t\t0x03a0\n#define AFE_IRQ_STATUS\t\t0x03a4\n#define AFE_IRQ_CLR\t\t0x03a8\n#define AFE_IRQ_CNT1\t\t0x03ac\n#define AFE_IRQ_CNT2\t\t0x03b0\n#define AFE_IRQ_MCU_EN\t\t0x03b4\n#define AFE_IRQ_CNT5\t\t0x03bc\n#define AFE_IRQ_CNT7\t\t0x03dc\n\n#define AFE_TDM_CON1\t\t0x0548\n#define AFE_TDM_CON2\t\t0x054c\n\n#define AFE_IRQ_STATUS_BITS\t0xff\n\n \n#define AUD_TCON0_PDN_SPDF\t\t(0x1 << 21)\n#define AUD_TCON0_PDN_HDMI\t\t(0x1 << 20)\n#define AUD_TCON0_PDN_24M\t\t(0x1 << 9)\n#define AUD_TCON0_PDN_22M\t\t(0x1 << 8)\n#define AUD_TCON0_PDN_AFE\t\t(0x1 << 2)\n\n \n#define AFE_I2S_CON1_LOW_JITTER_CLK\t(0x1 << 12)\n#define AFE_I2S_CON1_RATE(x)\t\t(((x) & 0xf) << 8)\n#define AFE_I2S_CON1_FORMAT_I2S\t\t(0x1 << 3)\n#define AFE_I2S_CON1_EN\t\t\t(0x1 << 0)\n\n \n#define AFE_I2S_CON2_LOW_JITTER_CLK\t(0x1 << 12)\n#define AFE_I2S_CON2_RATE(x)\t\t(((x) & 0xf) << 8)\n#define AFE_I2S_CON2_FORMAT_I2S\t\t(0x1 << 3)\n#define AFE_I2S_CON2_EN\t\t\t(0x1 << 0)\n\n \n#define AFE_CONN_24BIT_O04\t\t(0x1 << 4)\n#define AFE_CONN_24BIT_O03\t\t(0x1 << 3)\n\n \n#define AFE_HDMI_CONN0_O37_I37\t\t(0x7 << 21)\n#define AFE_HDMI_CONN0_O36_I36\t\t(0x6 << 18)\n#define AFE_HDMI_CONN0_O35_I33\t\t(0x3 << 15)\n#define AFE_HDMI_CONN0_O34_I32\t\t(0x2 << 12)\n#define AFE_HDMI_CONN0_O33_I35\t\t(0x5 << 9)\n#define AFE_HDMI_CONN0_O32_I34\t\t(0x4 << 6)\n#define AFE_HDMI_CONN0_O31_I31\t\t(0x1 << 3)\n#define AFE_HDMI_CONN0_O30_I30\t\t(0x0 << 0)\n\n \n#define AFE_TDM_CON1_LRCK_WIDTH(x)\t(((x) - 1) << 24)\n#define AFE_TDM_CON1_32_BCK_CYCLES\t(0x2 << 12)\n#define AFE_TDM_CON1_WLEN_32BIT\t\t(0x2 << 8)\n#define AFE_TDM_CON1_MSB_ALIGNED\t(0x1 << 4)\n#define AFE_TDM_CON1_1_BCK_DELAY\t(0x1 << 3)\n#define AFE_TDM_CON1_LRCK_INV\t\t(0x1 << 2)\n#define AFE_TDM_CON1_BCK_INV\t\t(0x1 << 1)\n#define AFE_TDM_CON1_EN\t\t\t(0x1 << 0)\n\nenum afe_tdm_ch_start {\n\tAFE_TDM_CH_START_O30_O31 = 0,\n\tAFE_TDM_CH_START_O32_O33,\n\tAFE_TDM_CH_START_O34_O35,\n\tAFE_TDM_CH_START_O36_O37,\n\tAFE_TDM_CH_ZERO,\n};\n\nstatic const unsigned int mt8173_afe_backup_list[] = {\n\tAUDIO_TOP_CON0,\n\tAFE_CONN1,\n\tAFE_CONN2,\n\tAFE_CONN7,\n\tAFE_CONN8,\n\tAFE_DAC_CON1,\n\tAFE_DL1_BASE,\n\tAFE_DL1_END,\n\tAFE_VUL_BASE,\n\tAFE_VUL_END,\n\tAFE_HDMI_OUT_BASE,\n\tAFE_HDMI_OUT_END,\n\tAFE_HDMI_CONN0,\n\tAFE_DAC_CON0,\n};\n\nstruct mt8173_afe_private {\n\tstruct clk *clocks[MT8173_CLK_NUM];\n};\n\nstatic const struct snd_pcm_hardware mt8173_afe_hardware = {\n\t.info = (SNDRV_PCM_INFO_MMAP | SNDRV_PCM_INFO_INTERLEAVED |\n\t\t SNDRV_PCM_INFO_MMAP_VALID),\n\t.buffer_bytes_max = 256 * 1024,\n\t.period_bytes_min = 512,\n\t.period_bytes_max = 128 * 1024,\n\t.periods_min = 2,\n\t.periods_max = 256,\n\t.fifo_size = 0,\n};\n\nstruct mt8173_afe_rate {\n\tunsigned int rate;\n\tunsigned int regvalue;\n};\n\nstatic const struct mt8173_afe_rate mt8173_afe_i2s_rates[] = {\n\t{ .rate = 8000, .regvalue = 0 },\n\t{ .rate = 11025, .regvalue = 1 },\n\t{ .rate = 12000, .regvalue = 2 },\n\t{ .rate = 16000, .regvalue = 4 },\n\t{ .rate = 22050, .regvalue = 5 },\n\t{ .rate = 24000, .regvalue = 6 },\n\t{ .rate = 32000, .regvalue = 8 },\n\t{ .rate = 44100, .regvalue = 9 },\n\t{ .rate = 48000, .regvalue = 10 },\n\t{ .rate = 88000, .regvalue = 11 },\n\t{ .rate = 96000, .regvalue = 12 },\n\t{ .rate = 174000, .regvalue = 13 },\n\t{ .rate = 192000, .regvalue = 14 },\n};\n\nstatic int mt8173_afe_i2s_fs(unsigned int sample_rate)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(mt8173_afe_i2s_rates); i++)\n\t\tif (mt8173_afe_i2s_rates[i].rate == sample_rate)\n\t\t\treturn mt8173_afe_i2s_rates[i].regvalue;\n\n\treturn -EINVAL;\n}\n\nstatic int mt8173_afe_set_i2s(struct mtk_base_afe *afe, unsigned int rate)\n{\n\tunsigned int val;\n\tint fs = mt8173_afe_i2s_fs(rate);\n\n\tif (fs < 0)\n\t\treturn -EINVAL;\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_ADDA_TOP_CON0, 0x1, 0x1);\n\tregmap_update_bits(afe->regmap, AFE_ADDA2_TOP_CON0, 0x1, 0x1);\n\n\t \n\tval = AFE_I2S_CON2_LOW_JITTER_CLK |\n\t      AFE_I2S_CON2_RATE(fs) |\n\t      AFE_I2S_CON2_FORMAT_I2S;\n\n\tregmap_update_bits(afe->regmap, AFE_I2S_CON2, ~AFE_I2S_CON2_EN, val);\n\n\t \n\tval = AFE_I2S_CON1_LOW_JITTER_CLK |\n\t      AFE_I2S_CON1_RATE(fs) |\n\t      AFE_I2S_CON1_FORMAT_I2S;\n\n\tregmap_update_bits(afe->regmap, AFE_I2S_CON1, ~AFE_I2S_CON1_EN, val);\n\treturn 0;\n}\n\nstatic void mt8173_afe_set_i2s_enable(struct mtk_base_afe *afe, bool enable)\n{\n\tunsigned int val;\n\n\tregmap_read(afe->regmap, AFE_I2S_CON2, &val);\n\tif (!!(val & AFE_I2S_CON2_EN) == enable)\n\t\treturn;\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_I2S_CON2, 0x1, enable);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_I2S_CON1, 0x1, enable);\n}\n\nstatic int mt8173_afe_dais_enable_clks(struct mtk_base_afe *afe,\n\t\t\t\t       struct clk *m_ck, struct clk *b_ck)\n{\n\tint ret;\n\n\tif (m_ck) {\n\t\tret = clk_prepare_enable(m_ck);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"Failed to enable m_ck\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (b_ck) {\n\t\tret = clk_prepare_enable(b_ck);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"Failed to enable b_ck\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int mt8173_afe_dais_set_clks(struct mtk_base_afe *afe,\n\t\t\t\t    struct clk *m_ck, unsigned int mck_rate,\n\t\t\t\t    struct clk *b_ck, unsigned int bck_rate)\n{\n\tint ret;\n\n\tif (m_ck) {\n\t\tret = clk_set_rate(m_ck, mck_rate);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"Failed to set m_ck rate\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (b_ck) {\n\t\tret = clk_set_rate(b_ck, bck_rate);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"Failed to set b_ck rate\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic void mt8173_afe_dais_disable_clks(struct mtk_base_afe *afe,\n\t\t\t\t\t struct clk *m_ck, struct clk *b_ck)\n{\n\tclk_disable_unprepare(m_ck);\n\tclk_disable_unprepare(b_ck);\n}\n\nstatic int mt8173_afe_i2s_startup(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\n\tif (snd_soc_dai_active(dai))\n\t\treturn 0;\n\n\tregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\n\t\t\t   AUD_TCON0_PDN_22M | AUD_TCON0_PDN_24M, 0);\n\treturn 0;\n}\n\nstatic void mt8173_afe_i2s_shutdown(struct snd_pcm_substream *substream,\n\t\t\t\t    struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\n\tif (snd_soc_dai_active(dai))\n\t\treturn;\n\n\tmt8173_afe_set_i2s_enable(afe, false);\n\tregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\n\t\t\t   AUD_TCON0_PDN_22M | AUD_TCON0_PDN_24M,\n\t\t\t   AUD_TCON0_PDN_22M | AUD_TCON0_PDN_24M);\n}\n\nstatic int mt8173_afe_i2s_prepare(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct snd_pcm_runtime * const runtime = substream->runtime;\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tmt8173_afe_dais_set_clks(afe, afe_priv->clocks[MT8173_CLK_I2S1_M],\n\t\t\t\t runtime->rate * 256, NULL, 0);\n\tmt8173_afe_dais_set_clks(afe, afe_priv->clocks[MT8173_CLK_I2S2_M],\n\t\t\t\t runtime->rate * 256, NULL, 0);\n\t \n\tret = mt8173_afe_set_i2s(afe, substream->runtime->rate);\n\tif (ret)\n\t\treturn ret;\n\n\tmt8173_afe_set_i2s_enable(afe, true);\n\n\treturn 0;\n}\n\nstatic int mt8173_afe_hdmi_startup(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\n\tif (snd_soc_dai_active(dai))\n\t\treturn 0;\n\n\tmt8173_afe_dais_enable_clks(afe, afe_priv->clocks[MT8173_CLK_I2S3_M],\n\t\t\t\t    afe_priv->clocks[MT8173_CLK_I2S3_B]);\n\treturn 0;\n}\n\nstatic void mt8173_afe_hdmi_shutdown(struct snd_pcm_substream *substream,\n\t\t\t\t     struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\n\tif (snd_soc_dai_active(dai))\n\t\treturn;\n\n\tmt8173_afe_dais_disable_clks(afe, afe_priv->clocks[MT8173_CLK_I2S3_M],\n\t\t\t\t     afe_priv->clocks[MT8173_CLK_I2S3_B]);\n}\n\nstatic int mt8173_afe_hdmi_prepare(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct snd_pcm_runtime * const runtime = substream->runtime;\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\n\tunsigned int val;\n\n\tmt8173_afe_dais_set_clks(afe, afe_priv->clocks[MT8173_CLK_I2S3_M],\n\t\t\t\t runtime->rate * 128,\n\t\t\t\t afe_priv->clocks[MT8173_CLK_I2S3_B],\n\t\t\t\t runtime->rate * runtime->channels * 32);\n\n\tval = AFE_TDM_CON1_BCK_INV |\n\t      AFE_TDM_CON1_LRCK_INV |\n\t      AFE_TDM_CON1_1_BCK_DELAY |\n\t      AFE_TDM_CON1_MSB_ALIGNED |  \n\t      AFE_TDM_CON1_WLEN_32BIT |\n\t      AFE_TDM_CON1_32_BCK_CYCLES |\n\t      AFE_TDM_CON1_LRCK_WIDTH(32);\n\tregmap_update_bits(afe->regmap, AFE_TDM_CON1, ~AFE_TDM_CON1_EN, val);\n\n\t \n\tswitch (runtime->channels) {\n\tcase 1:\n\tcase 2:\n\t\tval = AFE_TDM_CH_START_O30_O31;\n\t\tval |= (AFE_TDM_CH_ZERO << 4);\n\t\tval |= (AFE_TDM_CH_ZERO << 8);\n\t\tval |= (AFE_TDM_CH_ZERO << 12);\n\t\tbreak;\n\tcase 3:\n\tcase 4:\n\t\tval = AFE_TDM_CH_START_O30_O31;\n\t\tval |= (AFE_TDM_CH_START_O32_O33 << 4);\n\t\tval |= (AFE_TDM_CH_ZERO << 8);\n\t\tval |= (AFE_TDM_CH_ZERO << 12);\n\t\tbreak;\n\tcase 5:\n\tcase 6:\n\t\tval = AFE_TDM_CH_START_O30_O31;\n\t\tval |= (AFE_TDM_CH_START_O32_O33 << 4);\n\t\tval |= (AFE_TDM_CH_START_O34_O35 << 8);\n\t\tval |= (AFE_TDM_CH_ZERO << 12);\n\t\tbreak;\n\tcase 7:\n\tcase 8:\n\t\tval = AFE_TDM_CH_START_O30_O31;\n\t\tval |= (AFE_TDM_CH_START_O32_O33 << 4);\n\t\tval |= (AFE_TDM_CH_START_O34_O35 << 8);\n\t\tval |= (AFE_TDM_CH_START_O36_O37 << 12);\n\t\tbreak;\n\tdefault:\n\t\tval = 0;\n\t}\n\tregmap_update_bits(afe->regmap, AFE_TDM_CON2, 0x0000ffff, val);\n\n\tregmap_update_bits(afe->regmap, AFE_HDMI_OUT_CON0,\n\t\t\t   0x000000f0, runtime->channels << 4);\n\treturn 0;\n}\n\nstatic int mt8173_afe_hdmi_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\t\t\t   struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\n\tdev_info(afe->dev, \"%s cmd=%d %s\\n\", __func__, cmd, dai->name);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\t\tregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\n\t\t\t\t   AUD_TCON0_PDN_HDMI | AUD_TCON0_PDN_SPDF, 0);\n\n\t\t \n\t\tregmap_write(afe->regmap, AFE_HDMI_CONN0,\n\t\t\t\t AFE_HDMI_CONN0_O30_I30 |\n\t\t\t\t AFE_HDMI_CONN0_O31_I31 |\n\t\t\t\t AFE_HDMI_CONN0_O32_I34 |\n\t\t\t\t AFE_HDMI_CONN0_O33_I35 |\n\t\t\t\t AFE_HDMI_CONN0_O34_I32 |\n\t\t\t\t AFE_HDMI_CONN0_O35_I33 |\n\t\t\t\t AFE_HDMI_CONN0_O36_I36 |\n\t\t\t\t AFE_HDMI_CONN0_O37_I37);\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_HDMI_OUT_CON0, 0x1, 0x1);\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_TDM_CON1, 0x1, 0x1);\n\n\t\treturn 0;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_TDM_CON1, 0x1, 0);\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_HDMI_OUT_CON0, 0x1, 0);\n\n\t\tregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\n\t\t\t\t   AUD_TCON0_PDN_HDMI | AUD_TCON0_PDN_SPDF,\n\t\t\t\t   AUD_TCON0_PDN_HDMI | AUD_TCON0_PDN_SPDF);\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int mt8173_memif_fs(struct snd_pcm_substream *substream,\n\t\t\t   unsigned int rate)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_component *component = snd_soc_rtdcom_lookup(rtd, AFE_PCM_NAME);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\tstruct mtk_base_afe_memif *memif = &afe->memif[asoc_rtd_to_cpu(rtd, 0)->id];\n\tint fs;\n\n\tif (memif->data->id == MT8173_AFE_MEMIF_DAI ||\n\t    memif->data->id == MT8173_AFE_MEMIF_MOD_DAI) {\n\t\tswitch (rate) {\n\t\tcase 8000:\n\t\t\tfs = 0;\n\t\t\tbreak;\n\t\tcase 16000:\n\t\t\tfs = 1;\n\t\t\tbreak;\n\t\tcase 32000:\n\t\t\tfs = 2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\tfs = mt8173_afe_i2s_fs(rate);\n\t}\n\treturn fs;\n}\n\nstatic int mt8173_irq_fs(struct snd_pcm_substream *substream, unsigned int rate)\n{\n\treturn mt8173_afe_i2s_fs(rate);\n}\n\n \nstatic const struct snd_soc_dai_ops mt8173_afe_i2s_ops = {\n\t.startup\t= mt8173_afe_i2s_startup,\n\t.shutdown\t= mt8173_afe_i2s_shutdown,\n\t.prepare\t= mt8173_afe_i2s_prepare,\n};\n\nstatic const struct snd_soc_dai_ops mt8173_afe_hdmi_ops = {\n\t.startup\t= mt8173_afe_hdmi_startup,\n\t.shutdown\t= mt8173_afe_hdmi_shutdown,\n\t.prepare\t= mt8173_afe_hdmi_prepare,\n\t.trigger\t= mt8173_afe_hdmi_trigger,\n};\n\nstatic struct snd_soc_dai_driver mt8173_afe_pcm_dais[] = {\n\t \n\t{\n\t\t.name = \"DL1\",  \n\t\t.id = MT8173_AFE_MEMIF_DL1,\n\t\t.playback = {\n\t\t\t.stream_name = \"DL1\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mtk_afe_fe_ops,\n\t}, {\n\t\t.name = \"VUL\",  \n\t\t.id = MT8173_AFE_MEMIF_VUL,\n\t\t.capture = {\n\t\t\t.stream_name = \"VUL\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mtk_afe_fe_ops,\n\t}, {\n\t \n\t\t.name = \"I2S\",\n\t\t.id = MT8173_AFE_IO_I2S,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = SNDRV_PCM_RATE_8000_48000,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mt8173_afe_i2s_ops,\n\t\t.symmetric_rate = 1,\n\t},\n};\n\nstatic struct snd_soc_dai_driver mt8173_afe_hdmi_dais[] = {\n\t \n\t{\n\t\t.name = \"HDMI\",\n\t\t.id = MT8173_AFE_MEMIF_HDMI,\n\t\t.playback = {\n\t\t\t.stream_name = \"HDMI\",\n\t\t\t.channels_min = 2,\n\t\t\t.channels_max = 8,\n\t\t\t.rates = SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 |\n\t\t\t\tSNDRV_PCM_RATE_48000 | SNDRV_PCM_RATE_88200 |\n\t\t\t\tSNDRV_PCM_RATE_96000 | SNDRV_PCM_RATE_176400 |\n\t\t\t\tSNDRV_PCM_RATE_192000,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mtk_afe_fe_ops,\n\t}, {\n\t \n\t\t.name = \"HDMIO\",\n\t\t.id = MT8173_AFE_IO_HDMI,\n\t\t.playback = {\n\t\t\t.stream_name = \"HDMIO Playback\",\n\t\t\t.channels_min = 2,\n\t\t\t.channels_max = 8,\n\t\t\t.rates = SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 |\n\t\t\t\tSNDRV_PCM_RATE_48000 | SNDRV_PCM_RATE_88200 |\n\t\t\t\tSNDRV_PCM_RATE_96000 | SNDRV_PCM_RATE_176400 |\n\t\t\t\tSNDRV_PCM_RATE_192000,\n\t\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE,\n\t\t},\n\t\t.ops = &mt8173_afe_hdmi_ops,\n\t},\n};\n\nstatic const struct snd_kcontrol_new mt8173_afe_o03_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I05 Switch\", AFE_CONN1, 21, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt8173_afe_o04_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I06 Switch\", AFE_CONN2, 6, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt8173_afe_o09_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I03 Switch\", AFE_CONN3, 0, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I17 Switch\", AFE_CONN7, 30, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mt8173_afe_o10_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I04 Switch\", AFE_CONN3, 3, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I18 Switch\", AFE_CONN8, 0, 1, 0),\n};\n\nstatic const struct snd_soc_dapm_widget mt8173_afe_pcm_widgets[] = {\n\t \n\tSND_SOC_DAPM_MIXER(\"I03\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I04\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I05\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I06\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I17\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I18\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MIXER(\"O03\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt8173_afe_o03_mix, ARRAY_SIZE(mt8173_afe_o03_mix)),\n\tSND_SOC_DAPM_MIXER(\"O04\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt8173_afe_o04_mix, ARRAY_SIZE(mt8173_afe_o04_mix)),\n\tSND_SOC_DAPM_MIXER(\"O09\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt8173_afe_o09_mix, ARRAY_SIZE(mt8173_afe_o09_mix)),\n\tSND_SOC_DAPM_MIXER(\"O10\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mt8173_afe_o10_mix, ARRAY_SIZE(mt8173_afe_o10_mix)),\n};\n\nstatic const struct snd_soc_dapm_route mt8173_afe_pcm_routes[] = {\n\t{\"I05\", NULL, \"DL1\"},\n\t{\"I06\", NULL, \"DL1\"},\n\t{\"I2S Playback\", NULL, \"O03\"},\n\t{\"I2S Playback\", NULL, \"O04\"},\n\t{\"VUL\", NULL, \"O09\"},\n\t{\"VUL\", NULL, \"O10\"},\n\t{\"I03\", NULL, \"I2S Capture\"},\n\t{\"I04\", NULL, \"I2S Capture\"},\n\t{\"I17\", NULL, \"I2S Capture\"},\n\t{\"I18\", NULL, \"I2S Capture\"},\n\t{ \"O03\", \"I05 Switch\", \"I05\" },\n\t{ \"O04\", \"I06 Switch\", \"I06\" },\n\t{ \"O09\", \"I17 Switch\", \"I17\" },\n\t{ \"O09\", \"I03 Switch\", \"I03\" },\n\t{ \"O10\", \"I18 Switch\", \"I18\" },\n\t{ \"O10\", \"I04 Switch\", \"I04\" },\n};\n\nstatic const struct snd_soc_dapm_route mt8173_afe_hdmi_routes[] = {\n\t{\"HDMIO Playback\", NULL, \"HDMI\"},\n};\n\nstatic const struct snd_soc_component_driver mt8173_afe_pcm_dai_component = {\n\t.name = \"mt8173-afe-pcm-dai\",\n\t.dapm_widgets = mt8173_afe_pcm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8173_afe_pcm_widgets),\n\t.dapm_routes = mt8173_afe_pcm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt8173_afe_pcm_routes),\n\t.suspend = mtk_afe_suspend,\n\t.resume = mtk_afe_resume,\n};\n\nstatic const struct snd_soc_component_driver mt8173_afe_hdmi_dai_component = {\n\t.name = \"mt8173-afe-hdmi-dai\",\n\t.dapm_routes = mt8173_afe_hdmi_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt8173_afe_hdmi_routes),\n\t.suspend = mtk_afe_suspend,\n\t.resume = mtk_afe_resume,\n};\n\nstatic const char *aud_clks[MT8173_CLK_NUM] = {\n\t[MT8173_CLK_INFRASYS_AUD] = \"infra_sys_audio_clk\",\n\t[MT8173_CLK_TOP_PDN_AUD] = \"top_pdn_audio\",\n\t[MT8173_CLK_TOP_PDN_AUD_BUS] = \"top_pdn_aud_intbus\",\n\t[MT8173_CLK_I2S0_M] =  \"i2s0_m\",\n\t[MT8173_CLK_I2S1_M] =  \"i2s1_m\",\n\t[MT8173_CLK_I2S2_M] =  \"i2s2_m\",\n\t[MT8173_CLK_I2S3_M] =  \"i2s3_m\",\n\t[MT8173_CLK_I2S3_B] =  \"i2s3_b\",\n\t[MT8173_CLK_BCK0] =  \"bck0\",\n\t[MT8173_CLK_BCK1] =  \"bck1\",\n};\n\nstatic const struct mtk_base_memif_data memif_data[MT8173_AFE_MEMIF_NUM] = {\n\t{\n\t\t.name = \"DL1\",\n\t\t.id = MT8173_AFE_MEMIF_DL1,\n\t\t.reg_ofs_base = AFE_DL1_BASE,\n\t\t.reg_ofs_cur = AFE_DL1_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 0,\n\t\t.fs_maskbit = 0xf,\n\t\t.mono_reg = AFE_DAC_CON1,\n\t\t.mono_shift = 21,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 1,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 0,\n\t\t.agent_disable_reg = -1,\n\t}, {\n\t\t.name = \"DL2\",\n\t\t.id = MT8173_AFE_MEMIF_DL2,\n\t\t.reg_ofs_base = AFE_DL2_BASE,\n\t\t.reg_ofs_cur = AFE_DL2_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 4,\n\t\t.fs_maskbit = 0xf,\n\t\t.mono_reg = AFE_DAC_CON1,\n\t\t.mono_shift = 22,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 2,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 1,\n\t\t.agent_disable_reg = -1,\n\t}, {\n\t\t.name = \"VUL\",\n\t\t.id = MT8173_AFE_MEMIF_VUL,\n\t\t.reg_ofs_base = AFE_VUL_BASE,\n\t\t.reg_ofs_cur = AFE_VUL_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 16,\n\t\t.fs_maskbit = 0xf,\n\t\t.mono_reg = AFE_DAC_CON1,\n\t\t.mono_shift = 27,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 3,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 6,\n\t\t.agent_disable_reg = -1,\n\t}, {\n\t\t.name = \"DAI\",\n\t\t.id = MT8173_AFE_MEMIF_DAI,\n\t\t.reg_ofs_base = AFE_DAI_BASE,\n\t\t.reg_ofs_cur = AFE_DAI_CUR,\n\t\t.fs_reg = AFE_DAC_CON0,\n\t\t.fs_shift = 24,\n\t\t.fs_maskbit = 0x3,\n\t\t.mono_reg = -1,\n\t\t.mono_shift = -1,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 4,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 5,\n\t\t.agent_disable_reg = -1,\n\t}, {\n\t\t.name = \"AWB\",\n\t\t.id = MT8173_AFE_MEMIF_AWB,\n\t\t.reg_ofs_base = AFE_AWB_BASE,\n\t\t.reg_ofs_cur = AFE_AWB_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 12,\n\t\t.fs_maskbit = 0xf,\n\t\t.mono_reg = AFE_DAC_CON1,\n\t\t.mono_shift = 24,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 6,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 3,\n\t\t.agent_disable_reg = -1,\n\t}, {\n\t\t.name = \"MOD_DAI\",\n\t\t.id = MT8173_AFE_MEMIF_MOD_DAI,\n\t\t.reg_ofs_base = AFE_MOD_PCM_BASE,\n\t\t.reg_ofs_cur = AFE_MOD_PCM_CUR,\n\t\t.fs_reg = AFE_DAC_CON1,\n\t\t.fs_shift = 30,\n\t\t.fs_maskbit = 0x3,\n\t\t.mono_reg = AFE_DAC_CON1,\n\t\t.mono_shift = 30,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = AFE_DAC_CON0,\n\t\t.enable_shift = 7,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 4,\n\t\t.agent_disable_reg = -1,\n\t}, {\n\t\t.name = \"HDMI\",\n\t\t.id = MT8173_AFE_MEMIF_HDMI,\n\t\t.reg_ofs_base = AFE_HDMI_OUT_BASE,\n\t\t.reg_ofs_cur = AFE_HDMI_OUT_CUR,\n\t\t.fs_reg = -1,\n\t\t.fs_shift = -1,\n\t\t.fs_maskbit = -1,\n\t\t.mono_reg = -1,\n\t\t.mono_shift = -1,\n\t\t.hd_reg = -1,\n\t\t.enable_reg = -1,\n\t\t.msb_reg = AFE_MEMIF_MSB,\n\t\t.msb_shift = 8,\n\t\t.agent_disable_reg = -1,\n\t},\n};\n\nstatic const struct mtk_base_irq_data irq_data[MT8173_AFE_IRQ_NUM] = {\n\t{\n\t\t.id = MT8173_AFE_IRQ_DL1,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT1,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 0,\n\t\t.irq_fs_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_fs_shift = 4,\n\t\t.irq_fs_maskbit = 0xf,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 0,\n\t}, {\n\t\t.id = MT8173_AFE_IRQ_DL2,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT1,\n\t\t.irq_cnt_shift = 20,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 2,\n\t\t.irq_fs_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_fs_shift = 16,\n\t\t.irq_fs_maskbit = 0xf,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 2,\n\n\t}, {\n\t\t.id = MT8173_AFE_IRQ_VUL,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT2,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 1,\n\t\t.irq_fs_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_fs_shift = 8,\n\t\t.irq_fs_maskbit = 0xf,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 1,\n\t}, {\n\t\t.id = MT8173_AFE_IRQ_DAI,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT2,\n\t\t.irq_cnt_shift = 20,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 3,\n\t\t.irq_fs_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_fs_shift = 20,\n\t\t.irq_fs_maskbit = 0xf,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 3,\n\t}, {\n\t\t.id = MT8173_AFE_IRQ_AWB,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT7,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 14,\n\t\t.irq_fs_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_fs_shift = 24,\n\t\t.irq_fs_maskbit = 0xf,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 6,\n\t}, {\n\t\t.id = MT8173_AFE_IRQ_DAI,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT2,\n\t\t.irq_cnt_shift = 20,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 3,\n\t\t.irq_fs_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_fs_shift = 20,\n\t\t.irq_fs_maskbit = 0xf,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 3,\n\t}, {\n\t\t.id = MT8173_AFE_IRQ_HDMI,\n\t\t.irq_cnt_reg = AFE_IRQ_CNT5,\n\t\t.irq_cnt_shift = 0,\n\t\t.irq_cnt_maskbit = 0x3ffff,\n\t\t.irq_en_reg = AFE_IRQ_MCU_CON,\n\t\t.irq_en_shift = 12,\n\t\t.irq_fs_reg = -1,\n\t\t.irq_fs_maskbit = -1,\n\t\t.irq_clr_reg = AFE_IRQ_CLR,\n\t\t.irq_clr_shift = 4,\n\t},\n};\n\nstatic const struct regmap_config mt8173_afe_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.max_register = AFE_ADDA2_TOP_CON0,\n\t.cache_type = REGCACHE_NONE,\n};\n\nstatic irqreturn_t mt8173_afe_irq_handler(int irq, void *dev_id)\n{\n\tstruct mtk_base_afe *afe = dev_id;\n\tunsigned int reg_value;\n\tint i, ret;\n\n\tret = regmap_read(afe->regmap, AFE_IRQ_STATUS, &reg_value);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s irq status err\\n\", __func__);\n\t\treg_value = AFE_IRQ_STATUS_BITS;\n\t\tgoto err_irq;\n\t}\n\n\tfor (i = 0; i < MT8173_AFE_MEMIF_NUM; i++) {\n\t\tstruct mtk_base_afe_memif *memif = &afe->memif[i];\n\t\tstruct mtk_base_afe_irq *irq_p;\n\n\t\tif (memif->irq_usage < 0)\n\t\t\tcontinue;\n\n\t\tirq_p = &afe->irqs[memif->irq_usage];\n\n\t\tif (!(reg_value & (1 << irq_p->irq_data->irq_clr_shift)))\n\t\t\tcontinue;\n\n\t\tsnd_pcm_period_elapsed(memif->substream);\n\t}\n\nerr_irq:\n\t \n\tregmap_write(afe->regmap, AFE_IRQ_CLR,\n\t\t     reg_value & AFE_IRQ_STATUS_BITS);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int mt8173_afe_runtime_suspend(struct device *dev)\n{\n\tstruct mtk_base_afe *afe = dev_get_drvdata(dev);\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_DAC_CON0, 0x1, 0);\n\n\t \n\tregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\n\t\t\t   AUD_TCON0_PDN_AFE, AUD_TCON0_PDN_AFE);\n\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_I2S1_M]);\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_I2S2_M]);\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_BCK0]);\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_BCK1]);\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_TOP_PDN_AUD]);\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_TOP_PDN_AUD_BUS]);\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_INFRASYS_AUD]);\n\treturn 0;\n}\n\nstatic int mt8173_afe_runtime_resume(struct device *dev)\n{\n\tstruct mtk_base_afe *afe = dev_get_drvdata(dev);\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_INFRASYS_AUD]);\n\tif (ret)\n\t\treturn ret;\n\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_TOP_PDN_AUD_BUS]);\n\tif (ret)\n\t\tgoto err_infra;\n\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_TOP_PDN_AUD]);\n\tif (ret)\n\t\tgoto err_top_aud_bus;\n\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_BCK0]);\n\tif (ret)\n\t\tgoto err_top_aud;\n\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_BCK1]);\n\tif (ret)\n\t\tgoto err_bck0;\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_I2S1_M]);\n\tif (ret)\n\t\tgoto err_i2s1_m;\n\tret = clk_prepare_enable(afe_priv->clocks[MT8173_CLK_I2S2_M]);\n\tif (ret)\n\t\tgoto err_i2s2_m;\n\n\t \n\tregmap_update_bits(afe->regmap, AUDIO_TOP_CON0, AUD_TCON0_PDN_AFE, 0);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_CONN_24BIT,\n\t\t\t   AFE_CONN_24BIT_O03 | AFE_CONN_24BIT_O04, 0);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_IRQ_MCU_EN, 0xff, 0xff);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_DAC_CON0, 0x1, 0x1);\n\treturn 0;\n\nerr_i2s1_m:\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_I2S1_M]);\nerr_i2s2_m:\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_I2S2_M]);\nerr_bck0:\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_BCK0]);\nerr_top_aud:\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_TOP_PDN_AUD]);\nerr_top_aud_bus:\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_TOP_PDN_AUD_BUS]);\nerr_infra:\n\tclk_disable_unprepare(afe_priv->clocks[MT8173_CLK_INFRASYS_AUD]);\n\treturn ret;\n}\n\nstatic int mt8173_afe_init_audio_clk(struct mtk_base_afe *afe)\n{\n\tsize_t i;\n\tstruct mt8173_afe_private *afe_priv = afe->platform_priv;\n\n\tfor (i = 0; i < ARRAY_SIZE(aud_clks); i++) {\n\t\tafe_priv->clocks[i] = devm_clk_get(afe->dev, aud_clks[i]);\n\t\tif (IS_ERR(afe_priv->clocks[i])) {\n\t\t\tdev_err(afe->dev, \"%s devm_clk_get %s fail\\n\",\n\t\t\t\t__func__, aud_clks[i]);\n\t\t\treturn PTR_ERR(afe_priv->clocks[i]);\n\t\t}\n\t}\n\tclk_set_rate(afe_priv->clocks[MT8173_CLK_BCK0], 22579200);  \n\tclk_set_rate(afe_priv->clocks[MT8173_CLK_BCK1], 24576000);  \n\treturn 0;\n}\n\nstatic int mt8173_afe_pcm_dev_probe(struct platform_device *pdev)\n{\n\tint ret, i;\n\tint irq_id;\n\tstruct mtk_base_afe *afe;\n\tstruct mt8173_afe_private *afe_priv;\n\tstruct snd_soc_component *comp_pcm, *comp_hdmi;\n\n\tret = dma_set_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(33));\n\tif (ret)\n\t\treturn ret;\n\n\tafe = devm_kzalloc(&pdev->dev, sizeof(*afe), GFP_KERNEL);\n\tif (!afe)\n\t\treturn -ENOMEM;\n\n\tafe->platform_priv = devm_kzalloc(&pdev->dev, sizeof(*afe_priv),\n\t\t\t\t\t  GFP_KERNEL);\n\tafe_priv = afe->platform_priv;\n\tif (!afe_priv)\n\t\treturn -ENOMEM;\n\n\tafe->dev = &pdev->dev;\n\n\tirq_id = platform_get_irq(pdev, 0);\n\tif (irq_id <= 0)\n\t\treturn irq_id < 0 ? irq_id : -ENXIO;\n\n\tafe->base_addr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(afe->base_addr))\n\t\treturn PTR_ERR(afe->base_addr);\n\n\tafe->regmap = devm_regmap_init_mmio(&pdev->dev, afe->base_addr,\n\t\t&mt8173_afe_regmap_config);\n\tif (IS_ERR(afe->regmap))\n\t\treturn PTR_ERR(afe->regmap);\n\n\t \n\tret = mt8173_afe_init_audio_clk(afe);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"mt8173_afe_init_audio_clk fail\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tafe->memif_size = MT8173_AFE_MEMIF_NUM;\n\tafe->memif = devm_kcalloc(afe->dev, afe->memif_size,\n\t\t\t\t  sizeof(*afe->memif), GFP_KERNEL);\n\tif (!afe->memif)\n\t\treturn -ENOMEM;\n\n\tafe->irqs_size = MT8173_AFE_IRQ_NUM;\n\tafe->irqs = devm_kcalloc(afe->dev, afe->irqs_size,\n\t\t\t\t sizeof(*afe->irqs), GFP_KERNEL);\n\tif (!afe->irqs)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < afe->irqs_size; i++) {\n\t\tafe->memif[i].data = &memif_data[i];\n\t\tafe->irqs[i].irq_data = &irq_data[i];\n\t\tafe->irqs[i].irq_occupyed = true;\n\t\tafe->memif[i].irq_usage = i;\n\t\tafe->memif[i].const_irq = 1;\n\t}\n\n\tafe->mtk_afe_hardware = &mt8173_afe_hardware;\n\tafe->memif_fs = mt8173_memif_fs;\n\tafe->irq_fs = mt8173_irq_fs;\n\n\tplatform_set_drvdata(pdev, afe);\n\n\tpm_runtime_enable(&pdev->dev);\n\tif (!pm_runtime_enabled(&pdev->dev)) {\n\t\tret = mt8173_afe_runtime_resume(&pdev->dev);\n\t\tif (ret)\n\t\t\tgoto err_pm_disable;\n\t}\n\n\tafe->reg_back_up_list = mt8173_afe_backup_list;\n\tafe->reg_back_up_list_num = ARRAY_SIZE(mt8173_afe_backup_list);\n\tafe->runtime_resume = mt8173_afe_runtime_resume;\n\tafe->runtime_suspend = mt8173_afe_runtime_suspend;\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t\t &mtk_afe_pcm_platform,\n\t\t\t\t\t NULL, 0);\n\tif (ret)\n\t\tgoto err_pm_disable;\n\n\tcomp_pcm = devm_kzalloc(&pdev->dev, sizeof(*comp_pcm), GFP_KERNEL);\n\tif (!comp_pcm) {\n\t\tret = -ENOMEM;\n\t\tgoto err_pm_disable;\n\t}\n\n\tret = snd_soc_component_initialize(comp_pcm,\n\t\t\t\t\t   &mt8173_afe_pcm_dai_component,\n\t\t\t\t\t   &pdev->dev);\n\tif (ret)\n\t\tgoto err_pm_disable;\n\n#ifdef CONFIG_DEBUG_FS\n\tcomp_pcm->debugfs_prefix = \"pcm\";\n#endif\n\n\tret = snd_soc_add_component(comp_pcm,\n\t\t\t\t    mt8173_afe_pcm_dais,\n\t\t\t\t    ARRAY_SIZE(mt8173_afe_pcm_dais));\n\tif (ret)\n\t\tgoto err_pm_disable;\n\n\tcomp_hdmi = devm_kzalloc(&pdev->dev, sizeof(*comp_hdmi), GFP_KERNEL);\n\tif (!comp_hdmi) {\n\t\tret = -ENOMEM;\n\t\tgoto err_cleanup_components;\n\t}\n\n\tret = snd_soc_component_initialize(comp_hdmi,\n\t\t\t\t\t   &mt8173_afe_hdmi_dai_component,\n\t\t\t\t\t   &pdev->dev);\n\tif (ret)\n\t\tgoto err_cleanup_components;\n\n#ifdef CONFIG_DEBUG_FS\n\tcomp_hdmi->debugfs_prefix = \"hdmi\";\n#endif\n\n\tret = snd_soc_add_component(comp_hdmi,\n\t\t\t\t    mt8173_afe_hdmi_dais,\n\t\t\t\t    ARRAY_SIZE(mt8173_afe_hdmi_dais));\n\tif (ret)\n\t\tgoto err_cleanup_components;\n\n\tret = devm_request_irq(afe->dev, irq_id, mt8173_afe_irq_handler,\n\t\t\t       0, \"Afe_ISR_Handle\", (void *)afe);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"could not request_irq\\n\");\n\t\tgoto err_cleanup_components;\n\t}\n\n\tdev_info(&pdev->dev, \"MT8173 AFE driver initialized.\\n\");\n\treturn 0;\n\nerr_cleanup_components:\n\tsnd_soc_unregister_component(&pdev->dev);\nerr_pm_disable:\n\tpm_runtime_disable(&pdev->dev);\n\treturn ret;\n}\n\nstatic void mt8173_afe_pcm_dev_remove(struct platform_device *pdev)\n{\n\tsnd_soc_unregister_component(&pdev->dev);\n\n\tpm_runtime_disable(&pdev->dev);\n\tif (!pm_runtime_status_suspended(&pdev->dev))\n\t\tmt8173_afe_runtime_suspend(&pdev->dev);\n}\n\nstatic const struct of_device_id mt8173_afe_pcm_dt_match[] = {\n\t{ .compatible = \"mediatek,mt8173-afe-pcm\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, mt8173_afe_pcm_dt_match);\n\nstatic const struct dev_pm_ops mt8173_afe_pm_ops = {\n\tSET_RUNTIME_PM_OPS(mt8173_afe_runtime_suspend,\n\t\t\t   mt8173_afe_runtime_resume, NULL)\n};\n\nstatic struct platform_driver mt8173_afe_pcm_driver = {\n\t.driver = {\n\t\t   .name = \"mt8173-afe-pcm\",\n\t\t   .of_match_table = mt8173_afe_pcm_dt_match,\n\t\t   .pm = &mt8173_afe_pm_ops,\n\t},\n\t.probe = mt8173_afe_pcm_dev_probe,\n\t.remove_new = mt8173_afe_pcm_dev_remove,\n};\n\nmodule_platform_driver(mt8173_afe_pcm_driver);\n\nMODULE_DESCRIPTION(\"Mediatek ALSA SoC AFE platform driver\");\nMODULE_AUTHOR(\"Koro Chen <koro.chen@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}