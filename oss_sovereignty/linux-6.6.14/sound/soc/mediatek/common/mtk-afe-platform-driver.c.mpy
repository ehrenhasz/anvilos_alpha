{
  "module_name": "mtk-afe-platform-driver.c",
  "hash_id": "7f5a7e61a7dff962c339b969262bdfd3ef9afe649357da0986ceeca2fb9f5cf7",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/common/mtk-afe-platform-driver.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/dma-mapping.h>\n#include <sound/soc.h>\n\n#include \"mtk-afe-platform-driver.h\"\n#include \"mtk-base-afe.h\"\n\nint mtk_afe_combine_sub_dai(struct mtk_base_afe *afe)\n{\n\tstruct mtk_base_afe_dai *dai;\n\tsize_t num_dai_drivers = 0, dai_idx = 0;\n\n\t \n\tlist_for_each_entry(dai, &afe->sub_dais, list) {\n\t\tnum_dai_drivers += dai->num_dai_drivers;\n\t}\n\n\tdev_info(afe->dev, \"%s(), num of dai %zd\\n\", __func__, num_dai_drivers);\n\n\t \n\tafe->num_dai_drivers = num_dai_drivers;\n\tafe->dai_drivers = devm_kcalloc(afe->dev,\n\t\t\t\t\tnum_dai_drivers,\n\t\t\t\t\tsizeof(struct snd_soc_dai_driver),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!afe->dai_drivers)\n\t\treturn -ENOMEM;\n\n\tlist_for_each_entry(dai, &afe->sub_dais, list) {\n\t\t \n\t\tmemcpy(&afe->dai_drivers[dai_idx],\n\t\t       dai->dai_drivers,\n\t\t       dai->num_dai_drivers *\n\t\t       sizeof(struct snd_soc_dai_driver));\n\t\tdai_idx += dai->num_dai_drivers;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mtk_afe_combine_sub_dai);\n\nint mtk_afe_add_sub_dai_control(struct snd_soc_component *component)\n{\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\tstruct mtk_base_afe_dai *dai;\n\n\tlist_for_each_entry(dai, &afe->sub_dais, list) {\n\t\tif (dai->controls)\n\t\t\tsnd_soc_add_component_controls(component,\n\t\t\t\t\t\t       dai->controls,\n\t\t\t\t\t\t       dai->num_controls);\n\n\t\tif (dai->dapm_widgets)\n\t\t\tsnd_soc_dapm_new_controls(&component->dapm,\n\t\t\t\t\t\t  dai->dapm_widgets,\n\t\t\t\t\t\t  dai->num_dapm_widgets);\n\t}\n\t \n\tlist_for_each_entry(dai, &afe->sub_dais, list) {\n\t\tif (dai->dapm_routes)\n\t\t\tsnd_soc_dapm_add_routes(&component->dapm,\n\t\t\t\t\t\tdai->dapm_routes,\n\t\t\t\t\t\tdai->num_dapm_routes);\n\t}\n\n\tsnd_soc_dapm_new_widgets(component->dapm.card);\n\n\treturn 0;\n\n}\nEXPORT_SYMBOL_GPL(mtk_afe_add_sub_dai_control);\n\nsnd_pcm_uframes_t mtk_afe_pcm_pointer(struct snd_soc_component *component,\n\t\t\t\t      struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\tstruct mtk_base_afe_memif *memif = &afe->memif[asoc_rtd_to_cpu(rtd, 0)->id];\n\tconst struct mtk_base_memif_data *memif_data = memif->data;\n\tstruct regmap *regmap = afe->regmap;\n\tstruct device *dev = afe->dev;\n\tint reg_ofs_base = memif_data->reg_ofs_base;\n\tint reg_ofs_cur = memif_data->reg_ofs_cur;\n\tunsigned int hw_ptr = 0, hw_base = 0;\n\tint ret, pcm_ptr_bytes;\n\n\tret = regmap_read(regmap, reg_ofs_cur, &hw_ptr);\n\tif (ret || hw_ptr == 0) {\n\t\tdev_err(dev, \"%s hw_ptr err\\n\", __func__);\n\t\tpcm_ptr_bytes = 0;\n\t\tgoto POINTER_RETURN_FRAMES;\n\t}\n\n\tret = regmap_read(regmap, reg_ofs_base, &hw_base);\n\tif (ret || hw_base == 0) {\n\t\tdev_err(dev, \"%s hw_ptr err\\n\", __func__);\n\t\tpcm_ptr_bytes = 0;\n\t\tgoto POINTER_RETURN_FRAMES;\n\t}\n\n\tpcm_ptr_bytes = hw_ptr - hw_base;\n\nPOINTER_RETURN_FRAMES:\n\treturn bytes_to_frames(substream->runtime, pcm_ptr_bytes);\n}\nEXPORT_SYMBOL_GPL(mtk_afe_pcm_pointer);\n\nint mtk_afe_pcm_new(struct snd_soc_component *component,\n\t\t    struct snd_soc_pcm_runtime *rtd)\n{\n\tsize_t size;\n\tstruct snd_pcm *pcm = rtd->pcm;\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\n\tsize = afe->mtk_afe_hardware->buffer_bytes_max;\n\tsnd_pcm_set_managed_buffer_all(pcm, SNDRV_DMA_TYPE_DEV,\n\t\t\t\t       afe->dev, size, size);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mtk_afe_pcm_new);\n\nconst struct snd_soc_component_driver mtk_afe_pcm_platform = {\n\t.name\t\t= AFE_PCM_NAME,\n\t.pointer\t= mtk_afe_pcm_pointer,\n\t.pcm_construct\t= mtk_afe_pcm_new,\n};\nEXPORT_SYMBOL_GPL(mtk_afe_pcm_platform);\n\nMODULE_DESCRIPTION(\"Mediatek simple platform driver\");\nMODULE_AUTHOR(\"Garlic Tseng <garlic.tseng@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}