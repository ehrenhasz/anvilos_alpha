{
  "module_name": "mt8192-afe-clk.c",
  "hash_id": "af717222ba4102f5221ff3408ada0d0e7780ca65b7ab20d37d0a8c220cfdb85e",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8192/mt8192-afe-clk.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/arm-smccc.h>\n#include <linux/clk.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n\n#include \"mt8192-afe-clk.h\"\n#include \"mt8192-afe-common.h\"\n\nstatic const char *aud_clks[CLK_NUM] = {\n\t[CLK_AFE] = \"aud_afe_clk\",\n\t[CLK_TML] = \"aud_tml_clk\",\n\t[CLK_APLL22M] = \"aud_apll22m_clk\",\n\t[CLK_APLL24M] = \"aud_apll24m_clk\",\n\t[CLK_APLL1_TUNER] = \"aud_apll1_tuner_clk\",\n\t[CLK_APLL2_TUNER] = \"aud_apll2_tuner_clk\",\n\t[CLK_NLE] = \"aud_nle\",\n\t[CLK_INFRA_SYS_AUDIO] = \"aud_infra_clk\",\n\t[CLK_INFRA_AUDIO_26M] = \"aud_infra_26m_clk\",\n\t[CLK_MUX_AUDIO] = \"top_mux_audio\",\n\t[CLK_MUX_AUDIOINTBUS] = \"top_mux_audio_int\",\n\t[CLK_TOP_MAINPLL_D4_D4] = \"top_mainpll_d4_d4\",\n\t[CLK_TOP_MUX_AUD_1] = \"top_mux_aud_1\",\n\t[CLK_TOP_APLL1_CK] = \"top_apll1_ck\",\n\t[CLK_TOP_MUX_AUD_2] = \"top_mux_aud_2\",\n\t[CLK_TOP_APLL2_CK] = \"top_apll2_ck\",\n\t[CLK_TOP_MUX_AUD_ENG1] = \"top_mux_aud_eng1\",\n\t[CLK_TOP_APLL1_D4] = \"top_apll1_d4\",\n\t[CLK_TOP_MUX_AUD_ENG2] = \"top_mux_aud_eng2\",\n\t[CLK_TOP_APLL2_D4] = \"top_apll2_d4\",\n\t[CLK_TOP_MUX_AUDIO_H] = \"top_mux_audio_h\",\n\t[CLK_TOP_I2S0_M_SEL] = \"top_i2s0_m_sel\",\n\t[CLK_TOP_I2S1_M_SEL] = \"top_i2s1_m_sel\",\n\t[CLK_TOP_I2S2_M_SEL] = \"top_i2s2_m_sel\",\n\t[CLK_TOP_I2S3_M_SEL] = \"top_i2s3_m_sel\",\n\t[CLK_TOP_I2S4_M_SEL] = \"top_i2s4_m_sel\",\n\t[CLK_TOP_I2S5_M_SEL] = \"top_i2s5_m_sel\",\n\t[CLK_TOP_I2S6_M_SEL] = \"top_i2s6_m_sel\",\n\t[CLK_TOP_I2S7_M_SEL] = \"top_i2s7_m_sel\",\n\t[CLK_TOP_I2S8_M_SEL] = \"top_i2s8_m_sel\",\n\t[CLK_TOP_I2S9_M_SEL] = \"top_i2s9_m_sel\",\n\t[CLK_TOP_APLL12_DIV0] = \"top_apll12_div0\",\n\t[CLK_TOP_APLL12_DIV1] = \"top_apll12_div1\",\n\t[CLK_TOP_APLL12_DIV2] = \"top_apll12_div2\",\n\t[CLK_TOP_APLL12_DIV3] = \"top_apll12_div3\",\n\t[CLK_TOP_APLL12_DIV4] = \"top_apll12_div4\",\n\t[CLK_TOP_APLL12_DIVB] = \"top_apll12_divb\",\n\t[CLK_TOP_APLL12_DIV5] = \"top_apll12_div5\",\n\t[CLK_TOP_APLL12_DIV6] = \"top_apll12_div6\",\n\t[CLK_TOP_APLL12_DIV7] = \"top_apll12_div7\",\n\t[CLK_TOP_APLL12_DIV8] = \"top_apll12_div8\",\n\t[CLK_TOP_APLL12_DIV9] = \"top_apll12_div9\",\n\t[CLK_CLK26M] = \"top_clk26m_clk\",\n};\n\nint mt8192_set_audio_int_bus_parent(struct mtk_base_afe *afe,\n\t\t\t\t    int clk_id)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = clk_set_parent(afe_priv->clk[CLK_MUX_AUDIOINTBUS],\n\t\t\t     afe_priv->clk[clk_id]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS],\n\t\t\taud_clks[clk_id], ret);\n\t}\n\n\treturn ret;\n}\n\nstatic int apll1_mux_setting(struct mtk_base_afe *afe, bool enable)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tif (enable) {\n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL1_CK]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1],\n\t\t\t\taud_clks[CLK_TOP_APLL1_CK], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\n\t\t \n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL1_D4]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\taud_clks[CLK_TOP_APLL1_D4], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t} else {\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\n\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\n\t}\n\nEXIT:\n\treturn ret;\n}\n\nstatic int apll2_mux_setting(struct mtk_base_afe *afe, bool enable)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tif (enable) {\n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL2_CK]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2],\n\t\t\t\taud_clks[CLK_TOP_APLL2_CK], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\n\t\t \n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL2_D4]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\taud_clks[CLK_TOP_APLL2_D4], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t} else {\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\n\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\n\t}\n\nEXIT:\n\treturn ret;\n}\n\nint mt8192_afe_enable_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_INFRA_SYS_AUDIO], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_INFRA_AUDIO_26M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_INFRA_AUDIO_26M], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIO]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIO], ret);\n\t\tgoto EXIT;\n\t}\n\tret = clk_set_parent(afe_priv->clk[CLK_MUX_AUDIO],\n\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIO],\n\t\t\taud_clks[CLK_CLK26M], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = mt8192_set_audio_int_bus_parent(afe, CLK_CLK26M);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS],\n\t\t\taud_clks[CLK_CLK26M], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUDIO_H],\n\t\t\t     afe_priv->clk[CLK_TOP_APLL2_CK]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUDIO_H],\n\t\t\taud_clks[CLK_TOP_APLL2_CK], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_AFE]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_AFE], ret);\n\t\tgoto EXIT;\n\t}\n\nEXIT:\n\treturn ret;\n}\n\nvoid mt8192_afe_disable_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_AFE]);\n\tmt8192_set_audio_int_bus_parent(afe, CLK_CLK26M);\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIO]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_AUDIO_26M]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\n}\n\nint mt8192_apll1_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tapll1_mux_setting(afe, true);\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL22M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL22M], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL1_TUNER]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL1_TUNER], ret);\n\t\tgoto EXIT;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG,\n\t\t\t   0x0000FFF7, 0x00000832);\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0x1, 0x1);\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_22M_ON_MASK_SFT,\n\t\t\t   0x1 << AFE_22M_ON_SFT);\n\nEXIT:\n\treturn ret;\n}\n\nvoid mt8192_apll1_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_22M_ON_MASK_SFT,\n\t\t\t   0x0 << AFE_22M_ON_SFT);\n\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0x1, 0x0);\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL1_TUNER]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL22M]);\n\n\tapll1_mux_setting(afe, false);\n}\n\nint mt8192_apll2_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tapll2_mux_setting(afe, true);\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL24M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL24M], ret);\n\t\tgoto EXIT;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL2_TUNER]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL2_TUNER], ret);\n\t\tgoto EXIT;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG,\n\t\t\t   0x0000FFF7, 0x00000634);\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0x1, 0x1);\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_24M_ON_MASK_SFT,\n\t\t\t   0x1 << AFE_24M_ON_SFT);\n\nEXIT:\n\treturn ret;\n}\n\nvoid mt8192_apll2_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_24M_ON_MASK_SFT,\n\t\t\t   0x0 << AFE_24M_ON_SFT);\n\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0x1, 0x0);\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL2_TUNER]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL24M]);\n\n\tapll2_mux_setting(afe, false);\n}\n\nint mt8192_get_apll_rate(struct mtk_base_afe *afe, int apll)\n{\n\treturn (apll == MT8192_APLL1) ? 180633600 : 196608000;\n}\n\nint mt8192_get_apll_by_rate(struct mtk_base_afe *afe, int rate)\n{\n\treturn ((rate % 8000) == 0) ? MT8192_APLL2 : MT8192_APLL1;\n}\n\nint mt8192_get_apll_by_name(struct mtk_base_afe *afe, const char *name)\n{\n\tif (strcmp(name, APLL1_W_NAME) == 0)\n\t\treturn MT8192_APLL1;\n\telse\n\t\treturn MT8192_APLL2;\n}\n\n \nstruct mt8192_mck_div {\n\tint m_sel_id;\n\tint div_clk_id;\n\t \n\tint div_pdn_reg;\n\tint div_pdn_mask_sft;\n\tint div_reg;\n\tint div_mask_sft;\n\tint div_mask;\n\tint div_sft;\n\tint div_apll_sel_reg;\n\tint div_apll_sel_mask_sft;\n\tint div_apll_sel_sft;\n};\n\nstatic const struct mt8192_mck_div mck_div[MT8192_MCK_NUM] = {\n\t[MT8192_I2S0_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S0_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV0,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV0_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_2,\n\t\t.div_mask_sft = APLL12_CK_DIV0_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV0_MASK,\n\t\t.div_sft = APLL12_CK_DIV0_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S0_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S0_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S1_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S1_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV1,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV1_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_2,\n\t\t.div_mask_sft = APLL12_CK_DIV1_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV1_MASK,\n\t\t.div_sft = APLL12_CK_DIV1_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S1_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S1_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S2_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S2_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV2,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV2_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_2,\n\t\t.div_mask_sft = APLL12_CK_DIV2_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV2_MASK,\n\t\t.div_sft = APLL12_CK_DIV2_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S2_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S2_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S3_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S3_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV3,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV3_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_2,\n\t\t.div_mask_sft = APLL12_CK_DIV3_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV3_MASK,\n\t\t.div_sft = APLL12_CK_DIV3_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S3_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S3_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S4_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S4_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV4,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV4_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_3,\n\t\t.div_mask_sft = APLL12_CK_DIV4_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV4_MASK,\n\t\t.div_sft = APLL12_CK_DIV4_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S4_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S4_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S4_BCK] = {\n\t\t.m_sel_id = -1,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIVB,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIVB_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_2,\n\t\t.div_mask_sft = APLL12_CK_DIVB_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIVB_MASK,\n\t\t.div_sft = APLL12_CK_DIVB_SFT,\n\t},\n\t[MT8192_I2S5_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S5_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV5,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV5_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_3,\n\t\t.div_mask_sft = APLL12_CK_DIV5_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV5_MASK,\n\t\t.div_sft = APLL12_CK_DIV5_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S5_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S5_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S6_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S6_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV6,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV6_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_3,\n\t\t.div_mask_sft = APLL12_CK_DIV6_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV6_MASK,\n\t\t.div_sft = APLL12_CK_DIV6_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S6_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S6_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S7_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S7_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV7,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV7_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_4,\n\t\t.div_mask_sft = APLL12_CK_DIV7_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV7_MASK,\n\t\t.div_sft = APLL12_CK_DIV7_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S7_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S7_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S8_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S8_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV8,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV8_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_4,\n\t\t.div_mask_sft = APLL12_CK_DIV8_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV8_MASK,\n\t\t.div_sft = APLL12_CK_DIV8_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S8_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S8_MCK_SEL_SFT,\n\t},\n\t[MT8192_I2S9_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S9_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV9,\n\t\t.div_pdn_reg = CLK_AUDDIV_0,\n\t\t.div_pdn_mask_sft = APLL12_DIV9_PDN_MASK_SFT,\n\t\t.div_reg = CLK_AUDDIV_4,\n\t\t.div_mask_sft = APLL12_CK_DIV9_MASK_SFT,\n\t\t.div_mask = APLL12_CK_DIV9_MASK,\n\t\t.div_sft = APLL12_CK_DIV9_SFT,\n\t\t.div_apll_sel_reg = CLK_AUDDIV_0,\n\t\t.div_apll_sel_mask_sft = APLL_I2S9_MCK_SEL_MASK_SFT,\n\t\t.div_apll_sel_sft = APLL_I2S9_MCK_SEL_SFT,\n\t},\n};\n\nint mt8192_mck_enable(struct mtk_base_afe *afe, int mck_id, int rate)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint apll = mt8192_get_apll_by_rate(afe, rate);\n\tint apll_clk_id = apll == MT8192_APLL1 ?\n\t\t\t  CLK_TOP_MUX_AUD_1 : CLK_TOP_MUX_AUD_2;\n\tint m_sel_id = mck_div[mck_id].m_sel_id;\n\tint div_clk_id = mck_div[mck_id].div_clk_id;\n\tint ret;\n\n\t \n\tif (m_sel_id >= 0) {\n\t\tret = clk_prepare_enable(afe_priv->clk[m_sel_id]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[m_sel_id], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[m_sel_id],\n\t\t\t\t     afe_priv->clk[apll_clk_id]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s(), clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[m_sel_id],\n\t\t\t\taud_clks[apll_clk_id], ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tret = clk_prepare_enable(afe_priv->clk[div_clk_id]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[div_clk_id], ret);\n\t\treturn ret;\n\t}\n\tret = clk_set_rate(afe_priv->clk[div_clk_id], rate);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_set_rate %s, rate %d, fail %d\\n\",\n\t\t\t__func__, aud_clks[div_clk_id],\n\t\t\trate, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nvoid mt8192_mck_disable(struct mtk_base_afe *afe, int mck_id)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tint m_sel_id = mck_div[mck_id].m_sel_id;\n\tint div_clk_id = mck_div[mck_id].div_clk_id;\n\n\tclk_disable_unprepare(afe_priv->clk[div_clk_id]);\n\tif (m_sel_id >= 0)\n\t\tclk_disable_unprepare(afe_priv->clk[m_sel_id]);\n}\n\nint mt8192_init_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8192_afe_private *afe_priv = afe->platform_priv;\n\tstruct device_node *of_node = afe->dev->of_node;\n\tint i = 0;\n\n\tafe_priv->clk = devm_kcalloc(afe->dev, CLK_NUM, sizeof(*afe_priv->clk),\n\t\t\t\t     GFP_KERNEL);\n\tif (!afe_priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < CLK_NUM; i++) {\n\t\tafe_priv->clk[i] = devm_clk_get(afe->dev, aud_clks[i]);\n\t\tif (IS_ERR(afe_priv->clk[i])) {\n\t\t\tdev_warn(afe->dev, \"%s devm_clk_get %s fail, ret %ld\\n\",\n\t\t\t\t __func__,\n\t\t\t\t aud_clks[i], PTR_ERR(afe_priv->clk[i]));\n\t\t\tafe_priv->clk[i] = NULL;\n\t\t}\n\t}\n\n\tafe_priv->apmixedsys = syscon_regmap_lookup_by_phandle(of_node,\n\t\t\t\t\t\t\t       \"mediatek,apmixedsys\");\n\tif (IS_ERR(afe_priv->apmixedsys)) {\n\t\tdev_err(afe->dev, \"%s() Cannot find apmixedsys controller: %ld\\n\",\n\t\t\t__func__, PTR_ERR(afe_priv->apmixedsys));\n\t\treturn PTR_ERR(afe_priv->apmixedsys);\n\t}\n\n\tafe_priv->topckgen = syscon_regmap_lookup_by_phandle(of_node,\n\t\t\t\t\t\t\t     \"mediatek,topckgen\");\n\tif (IS_ERR(afe_priv->topckgen)) {\n\t\tdev_err(afe->dev, \"%s() Cannot find topckgen controller: %ld\\n\",\n\t\t\t__func__, PTR_ERR(afe_priv->topckgen));\n\t\treturn PTR_ERR(afe_priv->topckgen);\n\t}\n\n\tafe_priv->infracfg = syscon_regmap_lookup_by_phandle(of_node,\n\t\t\t\t\t\t\t     \"mediatek,infracfg\");\n\tif (IS_ERR(afe_priv->infracfg)) {\n\t\tdev_err(afe->dev, \"%s() Cannot find infracfg: %ld\\n\",\n\t\t\t__func__, PTR_ERR(afe_priv->infracfg));\n\t\treturn PTR_ERR(afe_priv->infracfg);\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}