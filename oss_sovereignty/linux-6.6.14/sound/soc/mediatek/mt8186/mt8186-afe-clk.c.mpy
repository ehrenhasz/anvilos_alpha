{
  "module_name": "mt8186-afe-clk.c",
  "hash_id": "f25f6b4fe16ef44234e75bf717465f03d8bb0cac7bb38c67631f8ca89f636b53",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8186/mt8186-afe-clk.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/regmap.h>\n#include <linux/mfd/syscon.h>\n\n#include \"mt8186-afe-common.h\"\n#include \"mt8186-afe-clk.h\"\n#include \"mt8186-audsys-clk.h\"\n\nstatic const char *aud_clks[CLK_NUM] = {\n\t[CLK_AFE] = \"aud_afe_clk\",\n\t[CLK_DAC] = \"aud_dac_clk\",\n\t[CLK_DAC_PREDIS] = \"aud_dac_predis_clk\",\n\t[CLK_ADC] = \"aud_adc_clk\",\n\t[CLK_TML] = \"aud_tml_clk\",\n\t[CLK_APLL22M] = \"aud_apll22m_clk\",\n\t[CLK_APLL24M] = \"aud_apll24m_clk\",\n\t[CLK_APLL1_TUNER] = \"aud_apll_tuner_clk\",\n\t[CLK_APLL2_TUNER] = \"aud_apll2_tuner_clk\",\n\t[CLK_TDM] = \"aud_tdm_clk\",\n\t[CLK_NLE] = \"aud_nle_clk\",\n\t[CLK_DAC_HIRES] = \"aud_dac_hires_clk\",\n\t[CLK_ADC_HIRES] = \"aud_adc_hires_clk\",\n\t[CLK_I2S1_BCLK] = \"aud_i2s1_bclk\",\n\t[CLK_I2S2_BCLK] = \"aud_i2s2_bclk\",\n\t[CLK_I2S3_BCLK] = \"aud_i2s3_bclk\",\n\t[CLK_I2S4_BCLK] = \"aud_i2s4_bclk\",\n\t[CLK_CONNSYS_I2S_ASRC] = \"aud_connsys_i2s_asrc\",\n\t[CLK_GENERAL1_ASRC] = \"aud_general1_asrc\",\n\t[CLK_GENERAL2_ASRC] = \"aud_general2_asrc\",\n\t[CLK_ADC_HIRES_TML] = \"aud_adc_hires_tml\",\n\t[CLK_ADDA6_ADC] = \"aud_adda6_adc\",\n\t[CLK_ADDA6_ADC_HIRES] = \"aud_adda6_adc_hires\",\n\t[CLK_3RD_DAC] = \"aud_3rd_dac\",\n\t[CLK_3RD_DAC_PREDIS] = \"aud_3rd_dac_predis\",\n\t[CLK_3RD_DAC_TML] = \"aud_3rd_dac_tml\",\n\t[CLK_3RD_DAC_HIRES] = \"aud_3rd_dac_hires\",\n\t[CLK_ETDM_IN1_BCLK] = \"aud_etdm_in1_bclk\",\n\t[CLK_ETDM_OUT1_BCLK] = \"aud_etdm_out1_bclk\",\n\t[CLK_INFRA_SYS_AUDIO] = \"aud_infra_clk\",\n\t[CLK_INFRA_AUDIO_26M] = \"mtkaif_26m_clk\",\n\t[CLK_MUX_AUDIO] = \"top_mux_audio\",\n\t[CLK_MUX_AUDIOINTBUS] = \"top_mux_audio_int\",\n\t[CLK_TOP_MAINPLL_D2_D4] = \"top_mainpll_d2_d4\",\n\t[CLK_TOP_MUX_AUD_1] = \"top_mux_aud_1\",\n\t[CLK_TOP_APLL1_CK] = \"top_apll1_ck\",\n\t[CLK_TOP_MUX_AUD_2] = \"top_mux_aud_2\",\n\t[CLK_TOP_APLL2_CK] = \"top_apll2_ck\",\n\t[CLK_TOP_MUX_AUD_ENG1] = \"top_mux_aud_eng1\",\n\t[CLK_TOP_APLL1_D8] = \"top_apll1_d8\",\n\t[CLK_TOP_MUX_AUD_ENG2] = \"top_mux_aud_eng2\",\n\t[CLK_TOP_APLL2_D8] = \"top_apll2_d8\",\n\t[CLK_TOP_MUX_AUDIO_H] = \"top_mux_audio_h\",\n\t[CLK_TOP_I2S0_M_SEL] = \"top_i2s0_m_sel\",\n\t[CLK_TOP_I2S1_M_SEL] = \"top_i2s1_m_sel\",\n\t[CLK_TOP_I2S2_M_SEL] = \"top_i2s2_m_sel\",\n\t[CLK_TOP_I2S4_M_SEL] = \"top_i2s4_m_sel\",\n\t[CLK_TOP_TDM_M_SEL] = \"top_tdm_m_sel\",\n\t[CLK_TOP_APLL12_DIV0] = \"top_apll12_div0\",\n\t[CLK_TOP_APLL12_DIV1] = \"top_apll12_div1\",\n\t[CLK_TOP_APLL12_DIV2] = \"top_apll12_div2\",\n\t[CLK_TOP_APLL12_DIV4] = \"top_apll12_div4\",\n\t[CLK_TOP_APLL12_DIV_TDM] = \"top_apll12_div_tdm\",\n\t[CLK_CLK26M] = \"top_clk26m_clk\",\n};\n\nint mt8186_set_audio_int_bus_parent(struct mtk_base_afe *afe,\n\t\t\t\t    int clk_id)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = clk_set_parent(afe_priv->clk[CLK_MUX_AUDIOINTBUS],\n\t\t\t     afe_priv->clk[clk_id]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS],\n\t\t\taud_clks[clk_id], ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int apll1_mux_setting(struct mtk_base_afe *afe, bool enable)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tif (enable) {\n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL1_CK]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1],\n\t\t\t\taud_clks[CLK_TOP_APLL1_CK], ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL1_D8]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\taud_clks[CLK_TOP_APLL1_D8], ret);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\n\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\n\t}\n\n\treturn 0;\n}\n\nstatic int apll2_mux_setting(struct mtk_base_afe *afe, bool enable)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tif (enable) {\n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL2_CK]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2],\n\t\t\t\taud_clks[CLK_TOP_APLL2_CK], ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL2_D8]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\taud_clks[CLK_TOP_APLL2_D8], ret);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\n\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\n\t}\n\n\treturn 0;\n}\n\nint mt8186_afe_enable_cgs(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret = 0;\n\tint i;\n\n\tfor (i = CLK_I2S1_BCLK; i <= CLK_ETDM_OUT1_BCLK; i++) {\n\t\tret = clk_prepare_enable(afe_priv->clk[i]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[i], ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nvoid mt8186_afe_disable_cgs(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint i;\n\n\tfor (i = CLK_I2S1_BCLK; i <= CLK_ETDM_OUT1_BCLK; i++)\n\t\tclk_disable_unprepare(afe_priv->clk[i]);\n}\n\nint mt8186_afe_enable_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret = 0;\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_INFRA_SYS_AUDIO], ret);\n\t\tgoto clk_infra_sys_audio_err;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_INFRA_AUDIO_26M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_INFRA_AUDIO_26M], ret);\n\t\tgoto clk_infra_audio_26m_err;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIO]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIO], ret);\n\t\tgoto clk_mux_audio_err;\n\t}\n\tret = clk_set_parent(afe_priv->clk[CLK_MUX_AUDIO],\n\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIO],\n\t\t\taud_clks[CLK_CLK26M], ret);\n\t\tgoto clk_mux_audio_err;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS], ret);\n\t\tgoto clk_mux_audio_intbus_err;\n\t}\n\tret = mt8186_set_audio_int_bus_parent(afe,\n\t\t\t\t\t      CLK_TOP_MAINPLL_D2_D4);\n\tif (ret)\n\t\tgoto clk_mux_audio_intbus_parent_err;\n\n\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUDIO_H],\n\t\t\t     afe_priv->clk[CLK_TOP_APLL2_CK]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUDIO_H],\n\t\t\taud_clks[CLK_TOP_APLL2_CK], ret);\n\t\tgoto clk_mux_audio_h_parent_err;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_AFE]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_AFE], ret);\n\t\tgoto clk_afe_err;\n\t}\n\n\treturn 0;\n\nclk_afe_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_AFE]);\nclk_mux_audio_h_parent_err:\nclk_mux_audio_intbus_parent_err:\n\tmt8186_set_audio_int_bus_parent(afe, CLK_CLK26M);\nclk_mux_audio_intbus_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\nclk_mux_audio_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIO]);\nclk_infra_sys_audio_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\nclk_infra_audio_26m_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_AUDIO_26M]);\n\n\treturn ret;\n}\n\nvoid mt8186_afe_disable_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_AFE]);\n\tmt8186_set_audio_int_bus_parent(afe, CLK_CLK26M);\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIO]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_AUDIO_26M]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\n}\n\nint mt8186_afe_suspend_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tif (ret) {\n\t\tdev_info(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t __func__, aud_clks[CLK_MUX_AUDIOINTBUS], ret);\n\t\tgoto clk_mux_audio_intbus_err;\n\t}\n\tret = mt8186_set_audio_int_bus_parent(afe, CLK_CLK26M);\n\tif (ret)\n\t\tgoto clk_mux_audio_intbus_parent_err;\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\n\treturn 0;\n\nclk_mux_audio_intbus_parent_err:\n\tmt8186_set_audio_int_bus_parent(afe, CLK_TOP_MAINPLL_D2_D4);\nclk_mux_audio_intbus_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\treturn ret;\n}\n\nint mt8186_afe_resume_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tif (ret) {\n\t\tdev_info(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t __func__, aud_clks[CLK_MUX_AUDIOINTBUS], ret);\n\t\tgoto clk_mux_audio_intbus_err;\n\t}\n\tret = mt8186_set_audio_int_bus_parent(afe,\n\t\t\t\t\t      CLK_TOP_MAINPLL_D2_D4);\n\tif (ret)\n\t\tgoto clk_mux_audio_intbus_parent_err;\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\n\treturn 0;\n\nclk_mux_audio_intbus_parent_err:\n\tmt8186_set_audio_int_bus_parent(afe, CLK_CLK26M);\nclk_mux_audio_intbus_err:\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\treturn ret;\n}\n\nint mt8186_apll1_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tapll1_mux_setting(afe, true);\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL22M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL22M], ret);\n\t\tgoto err_clk_apll22m;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL1_TUNER]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL1_TUNER], ret);\n\t\tgoto err_clk_apll1_tuner;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0xfff7, 0x832);\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0x1, 0x1);\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_22M_ON_MASK_SFT, BIT(AFE_22M_ON_SFT));\n\n\treturn 0;\n\nerr_clk_apll1_tuner:\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL1_TUNER]);\nerr_clk_apll22m:\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL22M]);\n\n\treturn ret;\n}\n\nvoid mt8186_apll1_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_22M_ON_MASK_SFT, 0);\n\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0x1, 0);\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL1_TUNER]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL22M]);\n\n\tapll1_mux_setting(afe, false);\n}\n\nint mt8186_apll2_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tapll2_mux_setting(afe, true);\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL24M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL24M], ret);\n\t\tgoto err_clk_apll24m;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL2_TUNER]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL2_TUNER], ret);\n\t\tgoto err_clk_apll2_tuner;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0xfff7, 0x634);\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0x1, 0x1);\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_24M_ON_MASK_SFT, BIT(AFE_24M_ON_SFT));\n\n\treturn 0;\n\nerr_clk_apll2_tuner:\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL2_TUNER]);\nerr_clk_apll24m:\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL24M]);\n\n\treturn ret;\n}\n\nvoid mt8186_apll2_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_24M_ON_MASK_SFT, 0);\n\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0x1, 0);\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL2_TUNER]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL24M]);\n\n\tapll2_mux_setting(afe, false);\n}\n\nint mt8186_get_apll_rate(struct mtk_base_afe *afe, int apll)\n{\n\treturn (apll == MT8186_APLL1) ? 180633600 : 196608000;\n}\n\nint mt8186_get_apll_by_rate(struct mtk_base_afe *afe, int rate)\n{\n\treturn ((rate % 8000) == 0) ? MT8186_APLL2 : MT8186_APLL1;\n}\n\nint mt8186_get_apll_by_name(struct mtk_base_afe *afe, const char *name)\n{\n\tif (strcmp(name, APLL1_W_NAME) == 0)\n\t\treturn MT8186_APLL1;\n\n\treturn MT8186_APLL2;\n}\n\n \nstruct mt8186_mck_div {\n\tu32 m_sel_id;\n\tu32 div_clk_id;\n};\n\nstatic const struct mt8186_mck_div mck_div[MT8186_MCK_NUM] = {\n\t[MT8186_I2S0_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S0_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV0,\n\t},\n\t[MT8186_I2S1_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S1_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV1,\n\t},\n\t[MT8186_I2S2_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S2_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV2,\n\t},\n\t[MT8186_I2S4_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S4_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV4,\n\t},\n\t[MT8186_TDM_MCK] = {\n\t\t.m_sel_id = CLK_TOP_TDM_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV_TDM,\n\t},\n};\n\nint mt8186_mck_enable(struct mtk_base_afe *afe, int mck_id, int rate)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint apll = mt8186_get_apll_by_rate(afe, rate);\n\tint apll_clk_id = apll == MT8186_APLL1 ?\n\t\t\t  CLK_TOP_MUX_AUD_1 : CLK_TOP_MUX_AUD_2;\n\tint m_sel_id = mck_div[mck_id].m_sel_id;\n\tint div_clk_id = mck_div[mck_id].div_clk_id;\n\tint ret;\n\n\t \n\tif (m_sel_id >= 0) {\n\t\tret = clk_prepare_enable(afe_priv->clk[m_sel_id]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[m_sel_id], ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[m_sel_id],\n\t\t\t\t     afe_priv->clk[apll_clk_id]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s(), clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[m_sel_id],\n\t\t\t\taud_clks[apll_clk_id], ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tret = clk_prepare_enable(afe_priv->clk[div_clk_id]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[div_clk_id], ret);\n\t\treturn ret;\n\t}\n\tret = clk_set_rate(afe_priv->clk[div_clk_id], rate);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_set_rate %s, rate %d, fail %d\\n\",\n\t\t\t__func__, aud_clks[div_clk_id], rate, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nvoid mt8186_mck_disable(struct mtk_base_afe *afe, int mck_id)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint m_sel_id = mck_div[mck_id].m_sel_id;\n\tint div_clk_id = mck_div[mck_id].div_clk_id;\n\n\tclk_disable_unprepare(afe_priv->clk[div_clk_id]);\n\tif (m_sel_id >= 0)\n\t\tclk_disable_unprepare(afe_priv->clk[m_sel_id]);\n}\n\nint mt8186_init_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct device_node *of_node = afe->dev->of_node;\n\tint i = 0;\n\n\tmt8186_audsys_clk_register(afe);\n\n\tafe_priv->clk = devm_kcalloc(afe->dev, CLK_NUM, sizeof(*afe_priv->clk),\n\t\t\t\t     GFP_KERNEL);\n\tif (!afe_priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < CLK_NUM; i++) {\n\t\tafe_priv->clk[i] = devm_clk_get(afe->dev, aud_clks[i]);\n\t\tif (IS_ERR(afe_priv->clk[i])) {\n\t\t\tdev_err(afe->dev, \"%s devm_clk_get %s fail, ret %ld\\n\",\n\t\t\t\t__func__,\n\t\t\t\taud_clks[i], PTR_ERR(afe_priv->clk[i]));\n\t\t\tafe_priv->clk[i] = NULL;\n\t\t}\n\t}\n\n\tafe_priv->apmixedsys = syscon_regmap_lookup_by_phandle(of_node,\n\t\t\t\t\t\t\t       \"mediatek,apmixedsys\");\n\tif (IS_ERR(afe_priv->apmixedsys)) {\n\t\tdev_err(afe->dev, \"%s() Cannot find apmixedsys controller: %ld\\n\",\n\t\t\t__func__, PTR_ERR(afe_priv->apmixedsys));\n\t\treturn PTR_ERR(afe_priv->apmixedsys);\n\t}\n\n\tafe_priv->topckgen = syscon_regmap_lookup_by_phandle(of_node,\n\t\t\t\t\t\t\t     \"mediatek,topckgen\");\n\tif (IS_ERR(afe_priv->topckgen)) {\n\t\tdev_err(afe->dev, \"%s() Cannot find topckgen controller: %ld\\n\",\n\t\t\t__func__, PTR_ERR(afe_priv->topckgen));\n\t\treturn PTR_ERR(afe_priv->topckgen);\n\t}\n\n\tafe_priv->infracfg = syscon_regmap_lookup_by_phandle(of_node,\n\t\t\t\t\t\t\t     \"mediatek,infracfg\");\n\tif (IS_ERR(afe_priv->infracfg)) {\n\t\tdev_err(afe->dev, \"%s() Cannot find infracfg: %ld\\n\",\n\t\t\t__func__, PTR_ERR(afe_priv->infracfg));\n\t\treturn PTR_ERR(afe_priv->infracfg);\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}