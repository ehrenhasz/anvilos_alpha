{
  "module_name": "mt8186-dai-src.c",
  "hash_id": "4bffa876701c884296b6c05b474f9575bd97b8a73206d0dac61226d43d675a79",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8186/mt8186-dai-src.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/regmap.h>\n#include \"mt8186-afe-common.h\"\n#include \"mt8186-interconnection.h\"\n\nstruct mtk_afe_src_priv {\n\tint dl_rate;\n\tint ul_rate;\n};\n\nstatic const unsigned int src_iir_coeff_32_to_16[] = {\n\t0x0dbae6, 0xff9b0a, 0x0dbae6, 0x05e488, 0xe072b9, 0x000002,\n\t0x0dbae6, 0x000f3b, 0x0dbae6, 0x06a537, 0xe17d79, 0x000002,\n\t0x0dbae6, 0x01246a, 0x0dbae6, 0x087261, 0xe306be, 0x000002,\n\t0x0dbae6, 0x03437d, 0x0dbae6, 0x0bc16f, 0xe57c87, 0x000002,\n\t0x0dbae6, 0x072981, 0x0dbae6, 0x111dd3, 0xe94f2a, 0x000002,\n\t0x0dbae6, 0x0dc4a6, 0x0dbae6, 0x188611, 0xee85a0, 0x000002,\n\t0x0dbae6, 0x168b9a, 0x0dbae6, 0x200e8f, 0xf3ccf1, 0x000002,\n\t0x000000, 0x1b75cb, 0x1b75cb, 0x2374a2, 0x000000, 0x000001\n};\n\nstatic const unsigned int src_iir_coeff_44_to_16[] = {\n\t0x09ae28, 0xf7d97d, 0x09ae28, 0x212a3d, 0xe0ac3a, 0x000002,\n\t0x09ae28, 0xf8525a, 0x09ae28, 0x216d72, 0xe234be, 0x000002,\n\t0x09ae28, 0xf980f5, 0x09ae28, 0x22a057, 0xe45a81, 0x000002,\n\t0x09ae28, 0xfc0a08, 0x09ae28, 0x24d3bd, 0xe7752d, 0x000002,\n\t0x09ae28, 0x016162, 0x09ae28, 0x27da01, 0xeb6ea8, 0x000002,\n\t0x09ae28, 0x0b67df, 0x09ae28, 0x2aca4a, 0xef34c4, 0x000002,\n\t0x000000, 0x135c50, 0x135c50, 0x2c1079, 0x000000, 0x000001\n};\n\nstatic const unsigned int src_iir_coeff_44_to_32[] = {\n\t0x096966, 0x0c4d35, 0x096966, 0xedee81, 0xf05070, 0x000003,\n\t0x12d2cc, 0x193910, 0x12d2cc, 0xddbf4f, 0xe21e1d, 0x000002,\n\t0x12d2cc, 0x1a9e60, 0x12d2cc, 0xe18916, 0xe470fd, 0x000002,\n\t0x12d2cc, 0x1d06e0, 0x12d2cc, 0xe8a4a6, 0xe87b24, 0x000002,\n\t0x12d2cc, 0x207578, 0x12d2cc, 0xf4fe62, 0xef5917, 0x000002,\n\t0x12d2cc, 0x24055f, 0x12d2cc, 0x05ee2b, 0xf8b502, 0x000002,\n\t0x000000, 0x25a599, 0x25a599, 0x0fabe2, 0x000000, 0x000001\n};\n\nstatic const unsigned int src_iir_coeff_48_to_16[] = {\n\t0x0296a4, 0xfd69dd, 0x0296a4, 0x209439, 0xe01ff9, 0x000002,\n\t0x0f4ff3, 0xf0d6d4, 0x0f4ff3, 0x209bc9, 0xe076c3, 0x000002,\n\t0x0e8490, 0xf1fe63, 0x0e8490, 0x20cfd6, 0xe12124, 0x000002,\n\t0x14852f, 0xed794a, 0x14852f, 0x21503d, 0xe28b32, 0x000002,\n\t0x136222, 0xf17677, 0x136222, 0x225be1, 0xe56964, 0x000002,\n\t0x0a8d85, 0xfc4a97, 0x0a8d85, 0x24310c, 0xea6952, 0x000002,\n\t0x05eff5, 0x043455, 0x05eff5, 0x4ced8f, 0xe134d6, 0x000001,\n\t0x000000, 0x3aebe6, 0x3aebe6, 0x04f3b0, 0x000000, 0x000004\n};\n\nstatic const unsigned int src_iir_coeff_48_to_32[] = {\n\t0x10c1b8, 0x10a7df, 0x10c1b8, 0xe7514e, 0xe0b41f, 0x000002,\n\t0x10c1b8, 0x116257, 0x10c1b8, 0xe9402f, 0xe25aaa, 0x000002,\n\t0x10c1b8, 0x130c89, 0x10c1b8, 0xed3cc3, 0xe4dddb, 0x000002,\n\t0x10c1b8, 0x1600dd, 0x10c1b8, 0xf48000, 0xe90c55, 0x000002,\n\t0x10c1b8, 0x1a672e, 0x10c1b8, 0x00494c, 0xefa807, 0x000002,\n\t0x10c1b8, 0x1f38e6, 0x10c1b8, 0x0ee076, 0xf7c5f3, 0x000002,\n\t0x000000, 0x218370, 0x218370, 0x168b40, 0x000000, 0x000001\n};\n\nstatic const unsigned int src_iir_coeff_48_to_44[] = {\n\t0x0bf71c, 0x170f3f, 0x0bf71c, 0xe3a4c8, 0xf096cb, 0x000003,\n\t0x0bf71c, 0x17395e, 0x0bf71c, 0xe58085, 0xf210c8, 0x000003,\n\t0x0bf71c, 0x1782bd, 0x0bf71c, 0xe95ef6, 0xf4c899, 0x000003,\n\t0x0bf71c, 0x17cd97, 0x0bf71c, 0xf1608a, 0xfa3b18, 0x000003,\n\t0x000000, 0x2fdc6f, 0x2fdc6f, 0xf15663, 0x000000, 0x000001\n};\n\nstatic const unsigned int src_iir_coeff_96_to_16[] = {\n\t0x0805a1, 0xf21ae3, 0x0805a1, 0x3840bb, 0xe02a2e, 0x000002,\n\t0x0d5dd8, 0xe8f259, 0x0d5dd8, 0x1c0af6, 0xf04700, 0x000003,\n\t0x0bb422, 0xec08d9, 0x0bb422, 0x1bfccc, 0xf09216, 0x000003,\n\t0x08fde6, 0xf108be, 0x08fde6, 0x1bf096, 0xf10ae0, 0x000003,\n\t0x0ae311, 0xeeeda3, 0x0ae311, 0x37c646, 0xe385f5, 0x000002,\n\t0x044089, 0xfa7242, 0x044089, 0x37a785, 0xe56526, 0x000002,\n\t0x00c75c, 0xffb947, 0x00c75c, 0x378ba3, 0xe72c5f, 0x000002,\n\t0x000000, 0x0ef76e, 0x0ef76e, 0x377fda, 0x000000, 0x000001,\n};\n\nstatic const unsigned int src_iir_coeff_96_to_44[] = {\n\t0x08b543, 0xfd80f4, 0x08b543, 0x0e2332, 0xe06ed0, 0x000002,\n\t0x1b6038, 0xf90e7e, 0x1b6038, 0x0ec1ac, 0xe16f66, 0x000002,\n\t0x188478, 0xfbb921, 0x188478, 0x105859, 0xe2e596, 0x000002,\n\t0x13eff3, 0xffa707, 0x13eff3, 0x13455c, 0xe533b7, 0x000002,\n\t0x0dc239, 0x03d458, 0x0dc239, 0x17f120, 0xe8b617, 0x000002,\n\t0x0745f1, 0x05d790, 0x0745f1, 0x1e3d75, 0xed5f18, 0x000002,\n\t0x05641f, 0x085e2b, 0x05641f, 0x48efd0, 0xe3e9c8, 0x000001,\n\t0x000000, 0x28f632, 0x28f632, 0x273905, 0x000000, 0x000001,\n};\n\nstatic unsigned int mtk_get_src_freq_mode(struct mtk_base_afe *afe, int rate)\n{\n\tswitch (rate) {\n\tcase 8000:\n\t\treturn 0x50000;\n\tcase 11025:\n\t\treturn 0x6e400;\n\tcase 12000:\n\t\treturn 0x78000;\n\tcase 16000:\n\t\treturn 0xa0000;\n\tcase 22050:\n\t\treturn 0xdc800;\n\tcase 24000:\n\t\treturn 0xf0000;\n\tcase 32000:\n\t\treturn 0x140000;\n\tcase 44100:\n\t\treturn 0x1b9000;\n\tcase 48000:\n\t\treturn 0x1e0000;\n\tcase 88200:\n\t\treturn 0x372000;\n\tcase 96000:\n\t\treturn 0x3c0000;\n\tcase 176400:\n\t\treturn 0x6e4000;\n\tcase 192000:\n\t\treturn 0x780000;\n\tdefault:\n\t\tdev_err(afe->dev, \"%s(), rate %d invalid!!!\\n\",\n\t\t\t__func__, rate);\n\t\treturn 0;\n\t}\n}\n\nstatic const unsigned int *get_iir_coeff(unsigned int rate_in,\n\t\t\t\t\t unsigned int rate_out,\n\t\t\t\t\t unsigned int *param_num)\n{\n\tif (rate_in == 32000 && rate_out == 16000) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_32_to_16);\n\t\treturn src_iir_coeff_32_to_16;\n\t} else if (rate_in == 44100 && rate_out == 16000) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_44_to_16);\n\t\treturn src_iir_coeff_44_to_16;\n\t} else if (rate_in == 44100 && rate_out == 32000) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_44_to_32);\n\t\treturn src_iir_coeff_44_to_32;\n\t} else if ((rate_in == 48000 && rate_out == 16000) ||\n\t\t   (rate_in == 96000 && rate_out == 32000)) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_48_to_16);\n\t\treturn src_iir_coeff_48_to_16;\n\t} else if (rate_in == 48000 && rate_out == 32000) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_48_to_32);\n\t\treturn src_iir_coeff_48_to_32;\n\t} else if (rate_in == 48000 && rate_out == 44100) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_48_to_44);\n\t\treturn src_iir_coeff_48_to_44;\n\t} else if (rate_in == 96000 && rate_out == 16000) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_96_to_16);\n\t\treturn src_iir_coeff_96_to_16;\n\t} else if ((rate_in == 96000 && rate_out == 44100) ||\n\t\t   (rate_in == 48000 && rate_out == 22050)) {\n\t\t*param_num = ARRAY_SIZE(src_iir_coeff_96_to_44);\n\t\treturn src_iir_coeff_96_to_44;\n\t}\n\n\t*param_num = 0;\n\treturn NULL;\n}\n\nstatic int mtk_set_src_1_param(struct mtk_base_afe *afe, int id)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_afe_src_priv *src_priv = afe_priv->dai_priv[id];\n\tunsigned int iir_coeff_num;\n\tunsigned int iir_stage;\n\tint rate_in = src_priv->dl_rate;\n\tint rate_out = src_priv->ul_rate;\n\tunsigned int out_freq_mode = mtk_get_src_freq_mode(afe, rate_out);\n\tunsigned int in_freq_mode = mtk_get_src_freq_mode(afe, rate_in);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON3,\n\t\t\t   G_SRC_ASM_FREQ_4_MASK_SFT,\n\t\t\t   out_freq_mode << G_SRC_ASM_FREQ_4_SFT);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON4,\n\t\t\t   G_SRC_ASM_FREQ_5_MASK_SFT,\n\t\t\t   in_freq_mode << G_SRC_ASM_FREQ_5_SFT);\n\n\tregmap_write(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON5, 0x3f5986);\n\tregmap_write(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON5, 0x3f5987);\n\tregmap_write(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON6, 0x1fbd);\n\tregmap_write(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON2, 0);\n\n\t \n\tif (rate_in > rate_out) {\n\t\tint i;\n\t\tconst unsigned int *iir_coeff = get_iir_coeff(rate_in, rate_out,\n\t\t\t\t\t\t\t      &iir_coeff_num);\n\n\t\tif (iir_coeff_num == 0 || !iir_coeff) {\n\t\t\tdev_err(afe->dev, \"%s(), iir coeff error, num %d, coeff %p\\n\",\n\t\t\t\t__func__, iir_coeff_num, iir_coeff);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON0,\n\t\t\t\t   G_SRC_COEFF_SRAM_CTRL_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_COEFF_SRAM_CTRL_SFT));\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON13,\n\t\t\t\t   G_SRC_COEFF_SRAM_ADR_MASK_SFT, 0);\n\t\t \n\t\tfor (i = 0; i < iir_coeff_num; i++)\n\t\t\tregmap_write(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON12,\n\t\t\t\t     iir_coeff[i]);\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON0,\n\t\t\t\t   G_SRC_COEFF_SRAM_CTRL_MASK_SFT, 0);\n\t\t \n\t\tiir_stage = (iir_coeff_num / 6) - 1;\n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON2,\n\t\t\t\t   G_SRC_CHSET_IIR_STAGE_MASK_SFT,\n\t\t\t\t   iir_stage << G_SRC_CHSET_IIR_STAGE_SFT);\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON2,\n\t\t\t\t   G_SRC_CHSET_IIR_EN_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_CHSET_IIR_EN_SFT));\n\t} else {\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL1_ASRC_2CH_CON2,\n\t\t\t\t   G_SRC_CHSET_IIR_EN_MASK_SFT, 0);\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_set_src_2_param(struct mtk_base_afe *afe, int id)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_afe_src_priv *src_priv = afe_priv->dai_priv[id];\n\tunsigned int iir_coeff_num;\n\tunsigned int iir_stage;\n\tint rate_in = src_priv->dl_rate;\n\tint rate_out = src_priv->ul_rate;\n\tunsigned int out_freq_mode = mtk_get_src_freq_mode(afe, rate_out);\n\tunsigned int in_freq_mode = mtk_get_src_freq_mode(afe, rate_in);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON3,\n\t\t\t   G_SRC_ASM_FREQ_4_MASK_SFT,\n\t\t\t   out_freq_mode << G_SRC_ASM_FREQ_4_SFT);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON4,\n\t\t\t   G_SRC_ASM_FREQ_5_MASK_SFT,\n\t\t\t   in_freq_mode << G_SRC_ASM_FREQ_5_SFT);\n\n\tregmap_write(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON5, 0x3f5986);\n\tregmap_write(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON5, 0x3f5987);\n\tregmap_write(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON6, 0x1fbd);\n\tregmap_write(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON2, 0);\n\n\t \n\tif (rate_in > rate_out) {\n\t\tint i;\n\t\tconst unsigned int *iir_coeff = get_iir_coeff(rate_in, rate_out,\n\t\t\t\t\t\t\t      &iir_coeff_num);\n\n\t\tif (iir_coeff_num == 0 || !iir_coeff) {\n\t\t\tdev_err(afe->dev, \"%s(), iir coeff error, num %d, coeff %p\\n\",\n\t\t\t\t __func__, iir_coeff_num, iir_coeff);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON0,\n\t\t\t\t   G_SRC_COEFF_SRAM_CTRL_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_COEFF_SRAM_CTRL_SFT));\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON13,\n\t\t\t\t   G_SRC_COEFF_SRAM_ADR_MASK_SFT, 0);\n\t\t \n\t\tfor (i = 0; i < iir_coeff_num; i++)\n\t\t\tregmap_write(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON12,\n\t\t\t\t     iir_coeff[i]);\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON0,\n\t\t\t\t   G_SRC_COEFF_SRAM_CTRL_MASK_SFT, 0);\n\t\t \n\t\tiir_stage = (iir_coeff_num / 6) - 1;\n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON2,\n\t\t\t\t   G_SRC_CHSET_IIR_STAGE_MASK_SFT,\n\t\t\t\t   iir_stage << G_SRC_CHSET_IIR_STAGE_SFT);\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON2,\n\t\t\t\t   G_SRC_CHSET_IIR_EN_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_CHSET_IIR_EN_SFT));\n\t} else {\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_GENERAL2_ASRC_2CH_CON2,\n\t\t\t\t   G_SRC_CHSET_IIR_EN_MASK_SFT, 0);\n\t}\n\n\treturn 0;\n}\n\n#define HW_SRC_1_EN_W_NAME \"HW_SRC_1_Enable\"\n#define HW_SRC_2_EN_W_NAME \"HW_SRC_2_Enable\"\n\nstatic int mtk_hw_src_event(struct snd_soc_dapm_widget *w,\n\t\t\t    struct snd_kcontrol *kcontrol,\n\t\t\t    int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint id;\n\tstruct mtk_afe_src_priv *src_priv;\n\tunsigned int reg;\n\n\tif (strcmp(w->name, HW_SRC_1_EN_W_NAME) == 0)\n\t\tid = MT8186_DAI_SRC_1;\n\telse\n\t\tid = MT8186_DAI_SRC_2;\n\n\tsrc_priv = afe_priv->dai_priv[id];\n\n\tdev_dbg(afe->dev,\n\t\t\"%s(), name %s, event 0x%x, id %d, src_priv %p, dl_rate %d, ul_rate %d\\n\",\n\t\t__func__, w->name, event, id, src_priv,\n\t\tsrc_priv->dl_rate, src_priv->ul_rate);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (id == MT8186_DAI_SRC_1)\n\t\t\tmtk_set_src_1_param(afe, id);\n\t\telse\n\t\t\tmtk_set_src_2_param(afe, id);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMU:\n\t\treg = (id == MT8186_DAI_SRC_1) ?\n\t\t      AFE_GENERAL1_ASRC_2CH_CON0 : AFE_GENERAL2_ASRC_2CH_CON0;\n\t\t \n\t\tregmap_update_bits(afe->regmap, reg,\n\t\t\t\t   G_SRC_ASM_ON_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_ASM_ON_SFT));\n\t\t \n\t\tregmap_update_bits(afe->regmap, reg,\n\t\t\t\t   G_SRC_CHSET_ON_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_CHSET_ON_SFT));\n\t\t \n\t\tregmap_update_bits(afe->regmap, reg,\n\t\t\t\t   G_SRC_CHSET_STR_CLR_MASK_SFT,\n\t\t\t\t   BIT(G_SRC_CHSET_STR_CLR_SFT));\n\t\tbreak;\n\tcase SND_SOC_DAPM_PRE_PMD:\n\t\treg = (id == MT8186_DAI_SRC_1) ?\n\t\t      AFE_GENERAL1_ASRC_2CH_CON0 : AFE_GENERAL2_ASRC_2CH_CON0;\n\t\t \n\t\tregmap_update_bits(afe->regmap, reg, G_SRC_ASM_ON_MASK_SFT, 0);\n\t\t \n\t\tregmap_update_bits(afe->regmap, reg, G_SRC_CHSET_ON_MASK_SFT, 0);\n\t\t \n\t\tregmap_update_bits(afe->regmap, reg, G_SRC_CHSET_STR_CLR_MASK_SFT, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \nstatic const struct snd_kcontrol_new mtk_hw_src_1_in_ch1_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH1 Switch\", AFE_CONN40,\n\t\t\t\t    I_DL1_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH1 Switch\", AFE_CONN40,\n\t\t\t\t    I_DL2_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH1 Switch\", AFE_CONN40,\n\t\t\t\t    I_DL3_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH1 Switch\", AFE_CONN40_1,\n\t\t\t\t    I_DL4_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH1 Switch\", AFE_CONN40_1,\n\t\t\t\t    I_DL6_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I2S0_CH1 Switch\", AFE_CONN40,\n\t\t\t\t    I_I2S0_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH1 Switch\", AFE_CONN40_1,\n\t\t\t\t    I_DL5_CH1, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_hw_src_1_in_ch2_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH2 Switch\", AFE_CONN41,\n\t\t\t\t    I_DL1_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH2 Switch\", AFE_CONN41,\n\t\t\t\t    I_DL2_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH2 Switch\", AFE_CONN41,\n\t\t\t\t    I_DL3_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH2 Switch\", AFE_CONN41_1,\n\t\t\t\t    I_DL4_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH2 Switch\", AFE_CONN41_1,\n\t\t\t\t    I_DL6_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I2S0_CH2 Switch\", AFE_CONN41,\n\t\t\t\t    I_I2S0_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH2 Switch\", AFE_CONN41_1,\n\t\t\t\t    I_DL5_CH2, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_hw_src_2_in_ch1_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH1 Switch\", AFE_CONN42,\n\t\t\t\t    I_DL1_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH1 Switch\", AFE_CONN42,\n\t\t\t\t    I_DL2_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH1 Switch\", AFE_CONN42,\n\t\t\t\t    I_DL3_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH1 Switch\", AFE_CONN42,\n\t\t\t\t    I_DL4_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH1 Switch\", AFE_CONN42_1,\n\t\t\t\t    I_DL5_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH1 Switch\", AFE_CONN42_1,\n\t\t\t\t    I_DL6_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"HW_GAIN2_OUT_CH1 Switch\", AFE_CONN42,\n\t\t\t\t    I_GAIN2_OUT_CH1, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_hw_src_2_in_ch2_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH2 Switch\", AFE_CONN43,\n\t\t\t\t    I_DL1_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH2 Switch\", AFE_CONN43,\n\t\t\t\t    I_DL2_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH2 Switch\", AFE_CONN43,\n\t\t\t\t    I_DL3_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH2 Switch\", AFE_CONN43,\n\t\t\t\t    I_DL4_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH2 Switch\", AFE_CONN43_1,\n\t\t\t\t    I_DL5_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH2 Switch\", AFE_CONN43_1,\n\t\t\t\t    I_DL6_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"HW_GAIN2_OUT_CH2 Switch\", AFE_CONN43,\n\t\t\t\t    I_GAIN2_OUT_CH2, 1, 0),\n};\n\nstatic const struct snd_soc_dapm_widget mtk_dai_src_widgets[] = {\n\t \n\tSND_SOC_DAPM_MIXER(\"HW_SRC_1_IN_CH1\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_hw_src_1_in_ch1_mix,\n\t\t\t   ARRAY_SIZE(mtk_hw_src_1_in_ch1_mix)),\n\tSND_SOC_DAPM_MIXER(\"HW_SRC_1_IN_CH2\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_hw_src_1_in_ch2_mix,\n\t\t\t   ARRAY_SIZE(mtk_hw_src_1_in_ch2_mix)),\n\tSND_SOC_DAPM_MIXER(\"HW_SRC_2_IN_CH1\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_hw_src_2_in_ch1_mix,\n\t\t\t   ARRAY_SIZE(mtk_hw_src_2_in_ch1_mix)),\n\tSND_SOC_DAPM_MIXER(\"HW_SRC_2_IN_CH2\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_hw_src_2_in_ch2_mix,\n\t\t\t   ARRAY_SIZE(mtk_hw_src_2_in_ch2_mix)),\n\n\tSND_SOC_DAPM_SUPPLY(HW_SRC_1_EN_W_NAME,\n\t\t\t    GENERAL_ASRC_EN_ON, GENERAL1_ASRC_EN_ON_SFT, 0,\n\t\t\t    mtk_hw_src_event,\n\t\t\t    SND_SOC_DAPM_PRE_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_PRE_PMD),\n\n\tSND_SOC_DAPM_SUPPLY(HW_SRC_2_EN_W_NAME,\n\t\t\t    GENERAL_ASRC_EN_ON, GENERAL2_ASRC_EN_ON_SFT, 0,\n\t\t\t    mtk_hw_src_event,\n\t\t\t    SND_SOC_DAPM_PRE_PMU |\n\t\t\t    SND_SOC_DAPM_POST_PMU |\n\t\t\t    SND_SOC_DAPM_PRE_PMD),\n\n\tSND_SOC_DAPM_INPUT(\"HW SRC 1 Out Endpoint\"),\n\tSND_SOC_DAPM_INPUT(\"HW SRC 2 Out Endpoint\"),\n\tSND_SOC_DAPM_OUTPUT(\"HW SRC 1 In Endpoint\"),\n\tSND_SOC_DAPM_OUTPUT(\"HW SRC 2 In Endpoint\"),\n};\n\nstatic int mtk_afe_src_en_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t  struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = source;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_afe_src_priv *src_priv;\n\n\tif (strcmp(w->name, HW_SRC_1_EN_W_NAME) == 0)\n\t\tsrc_priv = afe_priv->dai_priv[MT8186_DAI_SRC_1];\n\telse\n\t\tsrc_priv = afe_priv->dai_priv[MT8186_DAI_SRC_2];\n\n\tdev_dbg(afe->dev,\n\t\t\"%s(), source %s, sink %s, dl_rate %d, ul_rate %d\\n\",\n\t\t__func__, source->name, sink->name,\n\t\tsrc_priv->dl_rate, src_priv->ul_rate);\n\n\treturn (src_priv->dl_rate > 0 && src_priv->ul_rate > 0) ? 1 : 0;\n}\n\nstatic const struct snd_soc_dapm_route mtk_dai_src_routes[] = {\n\t{\"HW_SRC_1_IN_CH1\", \"DL1_CH1 Switch\", \"DL1\"},\n\t{\"HW_SRC_1_IN_CH2\", \"DL1_CH2 Switch\", \"DL1\"},\n\t{\"HW_SRC_2_IN_CH1\", \"DL1_CH1 Switch\", \"DL1\"},\n\t{\"HW_SRC_2_IN_CH2\", \"DL1_CH2 Switch\", \"DL1\"},\n\t{\"HW_SRC_1_IN_CH1\", \"DL2_CH1 Switch\", \"DL2\"},\n\t{\"HW_SRC_1_IN_CH2\", \"DL2_CH2 Switch\", \"DL2\"},\n\t{\"HW_SRC_2_IN_CH1\", \"DL2_CH1 Switch\", \"DL2\"},\n\t{\"HW_SRC_2_IN_CH2\", \"DL2_CH2 Switch\", \"DL2\"},\n\t{\"HW_SRC_1_IN_CH1\", \"DL3_CH1 Switch\", \"DL3\"},\n\t{\"HW_SRC_1_IN_CH2\", \"DL3_CH2 Switch\", \"DL3\"},\n\t{\"HW_SRC_2_IN_CH1\", \"DL3_CH1 Switch\", \"DL3\"},\n\t{\"HW_SRC_2_IN_CH2\", \"DL3_CH2 Switch\", \"DL3\"},\n\t{\"HW_SRC_1_IN_CH1\", \"DL6_CH1 Switch\", \"DL6\"},\n\t{\"HW_SRC_1_IN_CH2\", \"DL6_CH2 Switch\", \"DL6\"},\n\t{\"HW_SRC_2_IN_CH1\", \"DL6_CH1 Switch\", \"DL6\"},\n\t{\"HW_SRC_2_IN_CH2\", \"DL6_CH2 Switch\", \"DL6\"},\n\t{\"HW_SRC_1_IN_CH1\", \"DL5_CH1 Switch\", \"DL5\"},\n\t{\"HW_SRC_1_IN_CH2\", \"DL5_CH2 Switch\", \"DL5\"},\n\t{\"HW_SRC_2_IN_CH1\", \"DL5_CH1 Switch\", \"DL5\"},\n\t{\"HW_SRC_2_IN_CH2\", \"DL5_CH2 Switch\", \"DL5\"},\n\t{\"HW_SRC_1_IN_CH1\", \"DL4_CH1 Switch\", \"DL4\"},\n\t{\"HW_SRC_1_IN_CH2\", \"DL4_CH2 Switch\", \"DL4\"},\n\t{\"HW_SRC_2_IN_CH1\", \"DL4_CH1 Switch\", \"DL4\"},\n\t{\"HW_SRC_2_IN_CH2\", \"DL4_CH2 Switch\", \"DL4\"},\n\n\t{\"HW_SRC_1_In\", NULL, \"HW_SRC_1_IN_CH1\"},\n\t{\"HW_SRC_1_In\", NULL, \"HW_SRC_1_IN_CH2\"},\n\n\t{\"HW_SRC_2_In\", NULL, \"HW_SRC_2_IN_CH1\"},\n\t{\"HW_SRC_2_In\", NULL, \"HW_SRC_2_IN_CH2\"},\n\n\t{\"HW_SRC_1_In\", NULL, HW_SRC_1_EN_W_NAME, mtk_afe_src_en_connect},\n\t{\"HW_SRC_1_Out\", NULL, HW_SRC_1_EN_W_NAME, mtk_afe_src_en_connect},\n\t{\"HW_SRC_2_In\", NULL, HW_SRC_2_EN_W_NAME, mtk_afe_src_en_connect},\n\t{\"HW_SRC_2_Out\", NULL, HW_SRC_2_EN_W_NAME, mtk_afe_src_en_connect},\n\n\t{\"HW SRC 1 In Endpoint\", NULL, \"HW_SRC_1_In\"},\n\t{\"HW SRC 2 In Endpoint\", NULL, \"HW_SRC_2_In\"},\n\t{\"HW_SRC_1_Out\", NULL, \"HW SRC 1 Out Endpoint\"},\n\t{\"HW_SRC_2_Out\", NULL, \"HW SRC 2 Out Endpoint\"},\n};\n\n \nstatic int mtk_dai_src_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t\t struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint id = dai->id;\n\tstruct mtk_afe_src_priv *src_priv = afe_priv->dai_priv[id];\n\tunsigned int sft, mask;\n\tunsigned int rate = params_rate(params);\n\tunsigned int rate_reg = mt8186_rate_transform(afe->dev, rate, id);\n\n\tdev_dbg(afe->dev, \"%s(), id %d, stream %d, rate %d\\n\",\n\t\t__func__, id, substream->stream, rate);\n\n\t \n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\n\t\tsrc_priv->dl_rate = rate;\n\t\tif (id == MT8186_DAI_SRC_1) {\n\t\t\tsft = GENERAL1_ASRCIN_MODE_SFT;\n\t\t\tmask = GENERAL1_ASRCIN_MODE_MASK;\n\t\t} else {\n\t\t\tsft = GENERAL2_ASRCIN_MODE_SFT;\n\t\t\tmask = GENERAL2_ASRCIN_MODE_MASK;\n\t\t}\n\t} else {\n\t\tsrc_priv->ul_rate = rate;\n\t\tif (id == MT8186_DAI_SRC_1) {\n\t\t\tsft = GENERAL1_ASRCOUT_MODE_SFT;\n\t\t\tmask = GENERAL1_ASRCOUT_MODE_MASK;\n\t\t} else {\n\t\t\tsft = GENERAL2_ASRCOUT_MODE_SFT;\n\t\t\tmask = GENERAL2_ASRCOUT_MODE_MASK;\n\t\t}\n\t}\n\n\tregmap_update_bits(afe->regmap, GENERAL_ASRC_MODE, mask << sft, rate_reg << sft);\n\n\treturn 0;\n}\n\nstatic int mtk_dai_src_hw_free(struct snd_pcm_substream *substream,\n\t\t\t       struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint id = dai->id;\n\tstruct mtk_afe_src_priv *src_priv = afe_priv->dai_priv[id];\n\n\tdev_dbg(afe->dev, \"%s(), id %d, stream %d\\n\",\n\t\t__func__, id, substream->stream);\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tsrc_priv->dl_rate = 0;\n\telse\n\t\tsrc_priv->ul_rate = 0;\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops mtk_dai_src_ops = {\n\t.hw_params = mtk_dai_src_hw_params,\n\t.hw_free = mtk_dai_src_hw_free,\n};\n\n \n#define MTK_SRC_RATES (SNDRV_PCM_RATE_8000_48000 |\\\n\t\t       SNDRV_PCM_RATE_88200 |\\\n\t\t       SNDRV_PCM_RATE_96000 |\\\n\t\t       SNDRV_PCM_RATE_176400 |\\\n\t\t       SNDRV_PCM_RATE_192000)\n\n#define MTK_SRC_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\t\t SNDRV_PCM_FMTBIT_S24_LE |\\\n\t\t\t SNDRV_PCM_FMTBIT_S32_LE)\n\nstatic struct snd_soc_dai_driver mtk_dai_src_driver[] = {\n\t{\n\t\t.name = \"HW_SRC_1\",\n\t\t.id = MT8186_DAI_SRC_1,\n\t\t.playback = {\n\t\t\t.stream_name = \"HW_SRC_1_In\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_SRC_RATES,\n\t\t\t.formats = MTK_SRC_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"HW_SRC_1_Out\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_SRC_RATES,\n\t\t\t.formats = MTK_SRC_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_src_ops,\n\t},\n\t{\n\t\t.name = \"HW_SRC_2\",\n\t\t.id = MT8186_DAI_SRC_2,\n\t\t.playback = {\n\t\t\t.stream_name = \"HW_SRC_2_In\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_SRC_RATES,\n\t\t\t.formats = MTK_SRC_FORMATS,\n\t\t},\n\t\t.capture = {\n\t\t\t.stream_name = \"HW_SRC_2_Out\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_SRC_RATES,\n\t\t\t.formats = MTK_SRC_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_src_ops,\n\t},\n};\n\nint mt8186_dai_src_register(struct mtk_base_afe *afe)\n{\n\tstruct mtk_base_afe_dai *dai;\n\tint ret;\n\n\tdai = devm_kzalloc(afe->dev, sizeof(*dai), GFP_KERNEL);\n\tif (!dai)\n\t\treturn -ENOMEM;\n\n\tlist_add(&dai->list, &afe->sub_dais);\n\n\tdai->dai_drivers = mtk_dai_src_driver;\n\tdai->num_dai_drivers = ARRAY_SIZE(mtk_dai_src_driver);\n\n\tdai->dapm_widgets = mtk_dai_src_widgets;\n\tdai->num_dapm_widgets = ARRAY_SIZE(mtk_dai_src_widgets);\n\tdai->dapm_routes = mtk_dai_src_routes;\n\tdai->num_dapm_routes = ARRAY_SIZE(mtk_dai_src_routes);\n\n\t \n\tret = mt8186_dai_set_priv(afe, MT8186_DAI_SRC_1,\n\t\t\t\t  sizeof(struct mtk_afe_src_priv), NULL);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt8186_dai_set_priv(afe, MT8186_DAI_SRC_2,\n\t\t\t\t  sizeof(struct mtk_afe_src_priv), NULL);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}