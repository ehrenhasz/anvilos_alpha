{
  "module_name": "mt8186-misc-control.c",
  "hash_id": "718eb8277105e6a6455dc4a62c873cb1daf5807004c1a65114dd7ef118ecd9f6",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8186/mt8186-misc-control.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/delay.h>\n#include <linux/dma-mapping.h>\n#include <linux/io.h>\n#include <linux/regmap.h>\n#include <sound/soc.h>\n\n#include \"../common/mtk-afe-fe-dai.h\"\n#include \"../common/mtk-afe-platform-driver.h\"\n#include \"mt8186-afe-common.h\"\n\nstatic const char * const mt8186_sgen_mode_str[] = {\n\t\"I0I1\",   \"I2\",     \"I3I4\",   \"I5I6\",\n\t\"I7I8\",   \"I9I22\",  \"I10I11\", \"I12I13\",\n\t\"I14I21\", \"I15I16\", \"I17I18\", \"I19I20\",\n\t\"I23I24\", \"I25I26\", \"I27I28\", \"I33\",\n\t\"I34I35\", \"I36I37\", \"I38I39\", \"I40I41\",\n\t\"I42I43\", \"I44I45\", \"I46I47\", \"I48I49\",\n\t\"I56I57\", \"I58I59\", \"I60I61\", \"I62I63\",\n\t\"O0O1\",   \"O2\",     \"O3O4\",   \"O5O6\",\n\t\"O7O8\",   \"O9O10\",  \"O11\",    \"O12\",\n\t\"O13O14\", \"O15O16\", \"O17O18\", \"O19O20\",\n\t\"O21O22\", \"O23O24\", \"O25\",    \"O28O29\",\n\t\"O34\",    \"O35\",    \"O32O33\", \"O36O37\",\n\t\"O38O39\", \"O30O31\", \"O40O41\", \"O42O43\",\n\t\"O44O45\", \"O46O47\", \"O48O49\", \"O50O51\",\n\t\"O58O59\", \"O60O61\", \"O62O63\", \"O64O65\",\n\t\"O66O67\", \"O68O69\", \"O26O27\", \"OFF\",\n};\n\nstatic const int mt8186_sgen_mode_idx[] = {\n\t0, 2, 4, 6,\n\t8, 22, 10, 12,\n\t14, -1, 18, 20,\n\t24, 26, 28, 33,\n\t34, 36, 38, 40,\n\t42, 44, 46, 48,\n\t56, 58, 60, 62,\n\t128, 130, 132, 134,\n\t135, 138, 139, 140,\n\t142, 144, 166, 148,\n\t150, 152, 153, 156,\n\t162, 163, 160, 164,\n\t166, -1, 168, 170,\n\t172, 174, 176, 178,\n\t186, 188, 190, 192,\n\t194, 196, -1, -1,\n};\n\nstatic const char * const mt8186_sgen_rate_str[] = {\n\t\"8K\", \"11K\", \"12K\", \"16K\",\n\t\"22K\", \"24K\", \"32K\", \"44K\",\n\t\"48K\", \"88k\", \"96k\", \"176k\",\n\t\"192k\"\n};\n\nstatic const int mt8186_sgen_rate_idx[] = {\n\t0, 1, 2, 4,\n\t5, 6, 8, 9,\n\t10, 11, 12, 13,\n\t14\n};\n\n \nstatic const char * const mt8186_sgen_amp_str[] = {\n\t\"1/128\", \"1/64\", \"1/32\", \"1/16\", \"1/8\", \"1/4\", \"1/2\", \"1\" };\n\nstatic int mt8186_sgen_get(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tucontrol->value.integer.value[0] = afe_priv->sgen_mode;\n\n\treturn 0;\n}\n\nstatic int mt8186_sgen_set(struct snd_kcontrol *kcontrol,\n\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tint mode;\n\tint mode_idx;\n\n\tif (ucontrol->value.enumerated.item[0] >= e->items)\n\t\treturn -EINVAL;\n\n\tmode = ucontrol->value.integer.value[0];\n\tmode_idx = mt8186_sgen_mode_idx[mode];\n\n\tdev_dbg(afe->dev, \"%s(), mode %d, mode_idx %d\\n\",\n\t\t__func__, mode, mode_idx);\n\n\tif (mode == afe_priv->sgen_mode)\n\t\treturn 0;\n\n\tif (mode_idx >= 0) {\n\t\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON2,\n\t\t\t\t   INNER_LOOP_BACK_MODE_MASK_SFT,\n\t\t\t\t   mode_idx << INNER_LOOP_BACK_MODE_SFT);\n\t\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON0,\n\t\t\t\t   DAC_EN_MASK_SFT, BIT(DAC_EN_SFT));\n\t} else {\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON0,\n\t\t\t\t   DAC_EN_MASK_SFT, 0);\n\t\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON2,\n\t\t\t\t   INNER_LOOP_BACK_MODE_MASK_SFT,\n\t\t\t\t   0x3f << INNER_LOOP_BACK_MODE_SFT);\n\t}\n\n\tafe_priv->sgen_mode = mode;\n\n\treturn 1;\n}\n\nstatic int mt8186_sgen_rate_get(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tucontrol->value.integer.value[0] = afe_priv->sgen_rate;\n\n\treturn 0;\n}\n\nstatic int mt8186_sgen_rate_set(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tint rate;\n\n\tif (ucontrol->value.enumerated.item[0] >= e->items)\n\t\treturn -EINVAL;\n\n\trate = ucontrol->value.integer.value[0];\n\n\tdev_dbg(afe->dev, \"%s(), rate %d\\n\", __func__, rate);\n\n\tif (rate == afe_priv->sgen_rate)\n\t\treturn 0;\n\n\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON0,\n\t\t\t   SINE_MODE_CH1_MASK_SFT,\n\t\t\t   mt8186_sgen_rate_idx[rate] << SINE_MODE_CH1_SFT);\n\n\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON0,\n\t\t\t   SINE_MODE_CH2_MASK_SFT,\n\t\t\t   mt8186_sgen_rate_idx[rate] << SINE_MODE_CH2_SFT);\n\n\tafe_priv->sgen_rate = rate;\n\n\treturn 1;\n}\n\nstatic int mt8186_sgen_amplitude_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t     struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tucontrol->value.integer.value[0] = afe_priv->sgen_amplitude;\n\treturn 0;\n}\n\nstatic int mt8186_sgen_amplitude_set(struct snd_kcontrol *kcontrol,\n\t\t\t\t     struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tint amplitude;\n\n\tif (ucontrol->value.enumerated.item[0] >= e->items)\n\t\treturn -EINVAL;\n\n\tamplitude = ucontrol->value.integer.value[0];\n\tif (amplitude > AMP_DIV_CH1_MASK) {\n\t\tdev_err(afe->dev, \"%s(), amplitude %d invalid\\n\",\n\t\t\t__func__, amplitude);\n\t\treturn -EINVAL;\n\t}\n\n\tdev_dbg(afe->dev, \"%s(), amplitude %d\\n\", __func__, amplitude);\n\n\tif (amplitude == afe_priv->sgen_amplitude)\n\t\treturn 0;\n\n\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON0,\n\t\t\t   AMP_DIV_CH1_MASK_SFT,\n\t\t\t   amplitude << AMP_DIV_CH1_SFT);\n\tregmap_update_bits(afe->regmap, AFE_SINEGEN_CON0,\n\t\t\t   AMP_DIV_CH2_MASK_SFT,\n\t\t\t   amplitude << AMP_DIV_CH2_SFT);\n\n\tafe_priv->sgen_amplitude = amplitude;\n\n\treturn 1;\n}\n\nstatic const struct soc_enum mt8186_afe_sgen_enum[] = {\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(mt8186_sgen_mode_str),\n\t\t\t    mt8186_sgen_mode_str),\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(mt8186_sgen_rate_str),\n\t\t\t    mt8186_sgen_rate_str),\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(mt8186_sgen_amp_str),\n\t\t\t    mt8186_sgen_amp_str),\n};\n\nstatic const struct snd_kcontrol_new mt8186_afe_sgen_controls[] = {\n\tSOC_ENUM_EXT(\"Audio_SineGen_Switch\", mt8186_afe_sgen_enum[0],\n\t\t     mt8186_sgen_get, mt8186_sgen_set),\n\tSOC_ENUM_EXT(\"Audio_SineGen_SampleRate\", mt8186_afe_sgen_enum[1],\n\t\t     mt8186_sgen_rate_get, mt8186_sgen_rate_set),\n\tSOC_ENUM_EXT(\"Audio_SineGen_Amplitude\", mt8186_afe_sgen_enum[2],\n\t\t     mt8186_sgen_amplitude_get, mt8186_sgen_amplitude_set),\n\tSOC_SINGLE(\"Audio_SineGen_Mute_Ch1\", AFE_SINEGEN_CON0,\n\t\t   MUTE_SW_CH1_MASK_SFT, MUTE_SW_CH1_MASK, 0),\n\tSOC_SINGLE(\"Audio_SineGen_Mute_Ch2\", AFE_SINEGEN_CON0,\n\t\t   MUTE_SW_CH2_MASK_SFT, MUTE_SW_CH2_MASK, 0),\n\tSOC_SINGLE(\"Audio_SineGen_Freq_Div_Ch1\", AFE_SINEGEN_CON0,\n\t\t   FREQ_DIV_CH1_SFT, FREQ_DIV_CH1_MASK, 0),\n\tSOC_SINGLE(\"Audio_SineGen_Freq_Div_Ch2\", AFE_SINEGEN_CON0,\n\t\t   FREQ_DIV_CH2_SFT, FREQ_DIV_CH2_MASK, 0),\n};\n\nint mt8186_add_misc_control(struct snd_soc_component *component)\n{\n\tsnd_soc_add_component_controls(component,\n\t\t\t\t       mt8186_afe_sgen_controls,\n\t\t\t\t       ARRAY_SIZE(mt8186_afe_sgen_controls));\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}