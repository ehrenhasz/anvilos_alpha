{
  "module_name": "mt8186-dai-i2s.c",
  "hash_id": "75a5b3e769fe695921101a9f0aee597e2ccb1637c3284ef4a868819d396d589f",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8186/mt8186-dai-i2s.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/bitops.h>\n#include <linux/regmap.h>\n#include <sound/pcm_params.h>\n#include \"mt8186-afe-clk.h\"\n#include \"mt8186-afe-common.h\"\n#include \"mt8186-afe-gpio.h\"\n#include \"mt8186-interconnection.h\"\n\nenum {\n\tI2S_FMT_EIAJ = 0,\n\tI2S_FMT_I2S = 1,\n};\n\nenum {\n\tI2S_WLEN_16_BIT = 0,\n\tI2S_WLEN_32_BIT = 1,\n};\n\nenum {\n\tI2S_HD_NORMAL = 0,\n\tI2S_HD_LOW_JITTER = 1,\n};\n\nenum {\n\tI2S1_SEL_O28_O29 = 0,\n\tI2S1_SEL_O03_O04 = 1,\n};\n\nenum {\n\tI2S_IN_PAD_CONNSYS = 0,\n\tI2S_IN_PAD_IO_MUX = 1,\n};\n\nstruct mtk_afe_i2s_priv {\n\tint id;\n\tint rate;  \n\tint low_jitter_en;\n\tint master;  \n\n\tint share_i2s_id;\n\n\tint mclk_id;\n\tint mclk_rate;\n\tint mclk_apll;\n};\n\nstatic unsigned int get_i2s_wlen(snd_pcm_format_t format)\n{\n\treturn snd_pcm_format_physical_width(format) <= 16 ?\n\t       I2S_WLEN_16_BIT : I2S_WLEN_32_BIT;\n}\n\n#define MTK_AFE_I2S0_KCONTROL_NAME \"I2S0_HD_Mux\"\n#define MTK_AFE_I2S1_KCONTROL_NAME \"I2S1_HD_Mux\"\n#define MTK_AFE_I2S2_KCONTROL_NAME \"I2S2_HD_Mux\"\n#define MTK_AFE_I2S3_KCONTROL_NAME \"I2S3_HD_Mux\"\n#define MTK_AFE_I2S0_SRC_KCONTROL_NAME \"I2S0_SRC_Mux\"\n\n#define I2S0_HD_EN_W_NAME \"I2S0_HD_EN\"\n#define I2S1_HD_EN_W_NAME \"I2S1_HD_EN\"\n#define I2S2_HD_EN_W_NAME \"I2S2_HD_EN\"\n#define I2S3_HD_EN_W_NAME \"I2S3_HD_EN\"\n\n#define I2S0_MCLK_EN_W_NAME \"I2S0_MCLK_EN\"\n#define I2S1_MCLK_EN_W_NAME \"I2S1_MCLK_EN\"\n#define I2S2_MCLK_EN_W_NAME \"I2S2_MCLK_EN\"\n#define I2S3_MCLK_EN_W_NAME \"I2S3_MCLK_EN\"\n\nstatic int get_i2s_id_by_name(struct mtk_base_afe *afe,\n\t\t\t      const char *name)\n{\n\tif (strncmp(name, \"I2S0\", 4) == 0)\n\t\treturn MT8186_DAI_I2S_0;\n\telse if (strncmp(name, \"I2S1\", 4) == 0)\n\t\treturn MT8186_DAI_I2S_1;\n\telse if (strncmp(name, \"I2S2\", 4) == 0)\n\t\treturn MT8186_DAI_I2S_2;\n\telse if (strncmp(name, \"I2S3\", 4) == 0)\n\t\treturn MT8186_DAI_I2S_3;\n\n\treturn -EINVAL;\n}\n\nstatic struct mtk_afe_i2s_priv *get_i2s_priv_by_name(struct mtk_base_afe *afe,\n\t\t\t\t\t\t     const char *name)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tint dai_id = get_i2s_id_by_name(afe, name);\n\n\tif (dai_id < 0)\n\t\treturn NULL;\n\n\treturn afe_priv->dai_priv[dai_id];\n}\n\n \nstatic const char * const mt8186_i2s_hd_str[] = {\n\t\"Normal\", \"Low_Jitter\"\n};\n\nstatic const struct soc_enum mt8186_i2s_enum[] = {\n\tSOC_ENUM_SINGLE_EXT(ARRAY_SIZE(mt8186_i2s_hd_str),\n\t\t\t    mt8186_i2s_hd_str),\n};\n\nstatic int mt8186_i2s_hd_get(struct snd_kcontrol *kcontrol,\n\t\t\t     struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, kcontrol->id.name);\n\tucontrol->value.integer.value[0] = i2s_priv->low_jitter_en;\n\n\treturn 0;\n}\n\nstatic int mt8186_i2s_hd_set(struct snd_kcontrol *kcontrol,\n\t\t\t     struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tint hd_en;\n\n\tif (ucontrol->value.enumerated.item[0] >= e->items)\n\t\treturn -EINVAL;\n\n\thd_en = ucontrol->value.integer.value[0];\n\n\tdev_dbg(afe->dev, \"%s(), kcontrol name %s, hd_en %d\\n\",\n\t\t__func__, kcontrol->id.name, hd_en);\n\n\ti2s_priv = get_i2s_priv_by_name(afe, kcontrol->id.name);\n\tif (i2s_priv->low_jitter_en == hd_en)\n\t\treturn 0;\n\n\ti2s_priv->low_jitter_en = hd_en;\n\n\treturn 1;\n}\n\nstatic const struct snd_kcontrol_new mtk_dai_i2s_controls[] = {\n\tSOC_ENUM_EXT(MTK_AFE_I2S0_KCONTROL_NAME, mt8186_i2s_enum[0],\n\t\t     mt8186_i2s_hd_get, mt8186_i2s_hd_set),\n\tSOC_ENUM_EXT(MTK_AFE_I2S1_KCONTROL_NAME, mt8186_i2s_enum[0],\n\t\t     mt8186_i2s_hd_get, mt8186_i2s_hd_set),\n\tSOC_ENUM_EXT(MTK_AFE_I2S2_KCONTROL_NAME, mt8186_i2s_enum[0],\n\t\t     mt8186_i2s_hd_get, mt8186_i2s_hd_set),\n\tSOC_ENUM_EXT(MTK_AFE_I2S3_KCONTROL_NAME, mt8186_i2s_enum[0],\n\t\t     mt8186_i2s_hd_get, mt8186_i2s_hd_set),\n};\n\n \n \nstatic const char * const i2s_mux_map[] = {\n\t\"Normal\", \"Dummy_Widget\",\n};\n\nstatic int i2s_mux_map_value[] = {\n\t0, 1,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_AUTODISABLE_DECL(i2s_mux_map_enum,\n\t\t\t\t\t      SND_SOC_NOPM,\n\t\t\t\t\t      0,\n\t\t\t\t\t      1,\n\t\t\t\t\t      i2s_mux_map,\n\t\t\t\t\t      i2s_mux_map_value);\n\nstatic const struct snd_kcontrol_new i2s0_in_mux_control =\n\tSOC_DAPM_ENUM(\"I2S0 In Select\", i2s_mux_map_enum);\n\nstatic const struct snd_kcontrol_new i2s1_out_mux_control =\n\tSOC_DAPM_ENUM(\"I2S1 Out Select\", i2s_mux_map_enum);\n\nstatic const struct snd_kcontrol_new i2s2_in_mux_control =\n\tSOC_DAPM_ENUM(\"I2S2 In Select\", i2s_mux_map_enum);\n\nstatic const struct snd_kcontrol_new i2s3_out_mux_control =\n\tSOC_DAPM_ENUM(\"I2S3 Out Select\", i2s_mux_map_enum);\n\n \nstatic const char * const i2s_lpbk_mux_map[] = {\n\t\"Normal\", \"Lpbk\",\n};\n\nstatic int i2s_lpbk_mux_map_value[] = {\n\t0, 1,\n};\n\nstatic SOC_VALUE_ENUM_SINGLE_AUTODISABLE_DECL(i2s0_lpbk_mux_map_enum,\n\t\t\t\t\t      AFE_I2S_CON,\n\t\t\t\t\t      I2S_LOOPBACK_SFT,\n\t\t\t\t\t      1,\n\t\t\t\t\t      i2s_lpbk_mux_map,\n\t\t\t\t\t      i2s_lpbk_mux_map_value);\n\nstatic const struct snd_kcontrol_new i2s0_lpbk_mux_control =\n\tSOC_DAPM_ENUM(\"I2S Lpbk Select\", i2s0_lpbk_mux_map_enum);\n\nstatic SOC_VALUE_ENUM_SINGLE_AUTODISABLE_DECL(i2s2_lpbk_mux_map_enum,\n\t\t\t\t\t      AFE_I2S_CON2,\n\t\t\t\t\t      I2S3_LOOPBACK_SFT,\n\t\t\t\t\t      1,\n\t\t\t\t\t      i2s_lpbk_mux_map,\n\t\t\t\t\t      i2s_lpbk_mux_map_value);\n\nstatic const struct snd_kcontrol_new i2s2_lpbk_mux_control =\n\tSOC_DAPM_ENUM(\"I2S Lpbk Select\", i2s2_lpbk_mux_map_enum);\n\n \nstatic const struct snd_kcontrol_new mtk_i2s3_ch1_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_DL1_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_DL2_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_DL3_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_DL12_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH3 Switch\", AFE_CONN0,\n\t\t\t\t    I_DL12_CH3, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH1 Switch\", AFE_CONN0_1,\n\t\t\t\t    I_DL6_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH1 Switch\", AFE_CONN0_1,\n\t\t\t\t    I_DL4_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH1 Switch\", AFE_CONN0_1,\n\t\t\t\t    I_DL5_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL8_CH1 Switch\", AFE_CONN0_1,\n\t\t\t\t    I_DL8_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"GAIN1_OUT_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_GAIN1_OUT_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_ADDA_UL_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH2 Switch\", AFE_CONN0,\n\t\t\t\t    I_ADDA_UL_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH3 Switch\", AFE_CONN0,\n\t\t\t\t    I_ADDA_UL_CH3, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH1 Switch\", AFE_CONN0,\n\t\t\t\t    I_PCM_1_CAP_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"SRC_1_OUT_CH1 Switch\", AFE_CONN0_1,\n\t\t\t\t    I_SRC_1_OUT_CH1, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_i2s3_ch2_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_DL1_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_DL2_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_DL3_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_DL12_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH4 Switch\", AFE_CONN1,\n\t\t\t\t    I_DL12_CH4, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH2 Switch\", AFE_CONN1_1,\n\t\t\t\t    I_DL6_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH2 Switch\", AFE_CONN1_1,\n\t\t\t\t    I_DL4_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH2 Switch\", AFE_CONN1_1,\n\t\t\t\t    I_DL5_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL8_CH2 Switch\", AFE_CONN1_1,\n\t\t\t\t    I_DL8_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"GAIN1_OUT_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_GAIN1_OUT_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH1 Switch\", AFE_CONN1,\n\t\t\t\t    I_ADDA_UL_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_ADDA_UL_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH3 Switch\", AFE_CONN1,\n\t\t\t\t    I_ADDA_UL_CH3, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_PCM_1_CAP_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_2_CAP_CH2 Switch\", AFE_CONN1,\n\t\t\t\t    I_PCM_2_CAP_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"SRC_1_OUT_CH2 Switch\", AFE_CONN1_1,\n\t\t\t\t    I_SRC_1_OUT_CH2, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_i2s1_ch1_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_DL1_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_DL2_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_DL3_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_DL12_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH3 Switch\", AFE_CONN28,\n\t\t\t\t    I_DL12_CH3, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH1 Switch\", AFE_CONN28_1,\n\t\t\t\t    I_DL6_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH1 Switch\", AFE_CONN28_1,\n\t\t\t\t    I_DL4_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH1 Switch\", AFE_CONN28_1,\n\t\t\t\t    I_DL5_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL8_CH1 Switch\", AFE_CONN28_1,\n\t\t\t\t    I_DL8_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"GAIN1_OUT_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_GAIN1_OUT_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_ADDA_UL_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH1 Switch\", AFE_CONN28,\n\t\t\t\t    I_PCM_1_CAP_CH1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"SRC_1_OUT_CH1 Switch\", AFE_CONN28_1,\n\t\t\t\t    I_SRC_1_OUT_CH1, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_i2s1_ch2_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL1_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_DL1_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL2_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_DL2_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL3_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_DL3_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_DL12_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL12_CH4 Switch\", AFE_CONN29,\n\t\t\t\t    I_DL12_CH4, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL6_CH2 Switch\", AFE_CONN29_1,\n\t\t\t\t    I_DL6_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL4_CH2 Switch\", AFE_CONN29_1,\n\t\t\t\t    I_DL4_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL5_CH2 Switch\", AFE_CONN29_1,\n\t\t\t\t    I_DL5_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"DL8_CH2 Switch\", AFE_CONN29_1,\n\t\t\t\t    I_DL8_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"GAIN1_OUT_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_GAIN1_OUT_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"ADDA_UL_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_ADDA_UL_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_1_CAP_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_PCM_1_CAP_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"PCM_2_CAP_CH2 Switch\", AFE_CONN29,\n\t\t\t\t    I_PCM_2_CAP_CH2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"SRC_1_OUT_CH2 Switch\", AFE_CONN29_1,\n\t\t\t\t    I_SRC_1_OUT_CH2, 1, 0),\n};\n\nenum {\n\tSUPPLY_SEQ_APLL,\n\tSUPPLY_SEQ_I2S_MCLK_EN,\n\tSUPPLY_SEQ_I2S_HD_EN,\n\tSUPPLY_SEQ_I2S_EN,\n};\n\nstatic int mtk_i2s_en_event(struct snd_soc_dapm_widget *w,\n\t\t\t    struct snd_kcontrol *kcontrol,\n\t\t\t    int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, w->name);\n\n\tdev_dbg(cmpnt->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tmt8186_afe_gpio_request(afe->dev, true, i2s_priv->id, 0);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tmt8186_afe_gpio_request(afe->dev, false, i2s_priv->id, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_apll_event(struct snd_soc_dapm_widget *w,\n\t\t\t  struct snd_kcontrol *kcontrol,\n\t\t\t  int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(cmpnt->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tif (strcmp(w->name, APLL1_W_NAME) == 0)\n\t\t\tmt8186_apll1_enable(afe);\n\t\telse\n\t\t\tmt8186_apll2_enable(afe);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tif (strcmp(w->name, APLL1_W_NAME) == 0)\n\t\t\tmt8186_apll1_disable(afe);\n\t\telse\n\t\t\tmt8186_apll2_disable(afe);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_mclk_en_event(struct snd_soc_dapm_widget *w,\n\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\n\tdev_dbg(cmpnt->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\ti2s_priv = get_i2s_priv_by_name(afe, w->name);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tmt8186_mck_enable(afe, i2s_priv->mclk_id, i2s_priv->mclk_rate);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\ti2s_priv->mclk_rate = 0;\n\t\tmt8186_mck_disable(afe, i2s_priv->mclk_id);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dapm_widget mtk_dai_i2s_widgets[] = {\n\tSND_SOC_DAPM_INPUT(\"CONNSYS\"),\n\n\tSND_SOC_DAPM_MIXER(\"I2S1_CH1\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_i2s1_ch1_mix,\n\t\t\t   ARRAY_SIZE(mtk_i2s1_ch1_mix)),\n\tSND_SOC_DAPM_MIXER(\"I2S1_CH2\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_i2s1_ch2_mix,\n\t\t\t   ARRAY_SIZE(mtk_i2s1_ch2_mix)),\n\n\tSND_SOC_DAPM_MIXER(\"I2S3_CH1\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_i2s3_ch1_mix,\n\t\t\t   ARRAY_SIZE(mtk_i2s3_ch1_mix)),\n\tSND_SOC_DAPM_MIXER(\"I2S3_CH2\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_i2s3_ch2_mix,\n\t\t\t   ARRAY_SIZE(mtk_i2s3_ch2_mix)),\n\n\t \n\tSND_SOC_DAPM_SUPPLY_S(\"I2S0_EN\", SUPPLY_SEQ_I2S_EN,\n\t\t\t      AFE_I2S_CON, I2S_EN_SFT, 0,\n\t\t\t      mtk_i2s_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(\"I2S1_EN\", SUPPLY_SEQ_I2S_EN,\n\t\t\t      AFE_I2S_CON1, I2S_EN_SFT, 0,\n\t\t\t      mtk_i2s_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(\"I2S2_EN\", SUPPLY_SEQ_I2S_EN,\n\t\t\t      AFE_I2S_CON2, I2S_EN_SFT, 0,\n\t\t\t      mtk_i2s_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(\"I2S3_EN\", SUPPLY_SEQ_I2S_EN,\n\t\t\t      AFE_I2S_CON3, I2S_EN_SFT, 0,\n\t\t\t      mtk_i2s_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\t \n\tSND_SOC_DAPM_SUPPLY_S(I2S0_HD_EN_W_NAME, SUPPLY_SEQ_I2S_HD_EN,\n\t\t\t      AFE_I2S_CON, I2S1_HD_EN_SFT, 0, NULL,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(I2S1_HD_EN_W_NAME, SUPPLY_SEQ_I2S_HD_EN,\n\t\t\t      AFE_I2S_CON1, I2S2_HD_EN_SFT, 0, NULL,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(I2S2_HD_EN_W_NAME, SUPPLY_SEQ_I2S_HD_EN,\n\t\t\t      AFE_I2S_CON2, I2S3_HD_EN_SFT, 0, NULL,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(I2S3_HD_EN_W_NAME, SUPPLY_SEQ_I2S_HD_EN,\n\t\t\t      AFE_I2S_CON3, I2S4_HD_EN_SFT, 0, NULL,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_SUPPLY_S(I2S0_MCLK_EN_W_NAME, SUPPLY_SEQ_I2S_MCLK_EN,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mtk_mclk_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(I2S1_MCLK_EN_W_NAME, SUPPLY_SEQ_I2S_MCLK_EN,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mtk_mclk_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(I2S2_MCLK_EN_W_NAME, SUPPLY_SEQ_I2S_MCLK_EN,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mtk_mclk_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(I2S3_MCLK_EN_W_NAME, SUPPLY_SEQ_I2S_MCLK_EN,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mtk_mclk_en_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_SUPPLY_S(APLL1_W_NAME, SUPPLY_SEQ_APLL,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mtk_apll_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\tSND_SOC_DAPM_SUPPLY_S(APLL2_W_NAME, SUPPLY_SEQ_APLL,\n\t\t\t      SND_SOC_NOPM, 0, 0,\n\t\t\t      mtk_apll_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\t \n\tSND_SOC_DAPM_OUTPUT(\"I2S_DUMMY_OUT\"),\n\tSND_SOC_DAPM_MUX(\"I2S1_Out_Mux\",\n\t\t\t SND_SOC_NOPM, 0, 0, &i2s1_out_mux_control),\n\tSND_SOC_DAPM_MUX(\"I2S3_Out_Mux\",\n\t\t\t SND_SOC_NOPM, 0, 0, &i2s3_out_mux_control),\n\tSND_SOC_DAPM_INPUT(\"I2S_DUMMY_IN\"),\n\tSND_SOC_DAPM_MUX(\"I2S0_In_Mux\",\n\t\t\t SND_SOC_NOPM, 0, 0, &i2s0_in_mux_control),\n\tSND_SOC_DAPM_MUX(\"I2S2_In_Mux\",\n\t\t\t SND_SOC_NOPM, 0, 0, &i2s2_in_mux_control),\n\n\t \n\tSND_SOC_DAPM_MUX(\"I2S0_Lpbk_Mux\",\n\t\t\t SND_SOC_NOPM, 0, 0, &i2s0_lpbk_mux_control),\n\tSND_SOC_DAPM_MUX(\"I2S2_Lpbk_Mux\",\n\t\t\t SND_SOC_NOPM, 0, 0, &i2s2_lpbk_mux_control),\n};\n\nstatic int mtk_afe_i2s_share_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t     struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = sink;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, sink->name);\n\tif (i2s_priv->share_i2s_id < 0)\n\t\treturn 0;\n\n\treturn i2s_priv->share_i2s_id == get_i2s_id_by_name(afe, source->name);\n}\n\nstatic int mtk_afe_i2s_hd_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t  struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = sink;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, sink->name);\n\tif (get_i2s_id_by_name(afe, sink->name) ==\n\t    get_i2s_id_by_name(afe, source->name))\n\t\treturn i2s_priv->low_jitter_en;\n\n\t \n\tif (i2s_priv->share_i2s_id < 0)\n\t\treturn 0;\n\n\tif (i2s_priv->share_i2s_id == get_i2s_id_by_name(afe, source->name))\n\t\treturn i2s_priv->low_jitter_en;\n\n\treturn 0;\n}\n\nstatic int mtk_afe_i2s_apll_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t    struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = sink;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\tint cur_apll;\n\tint i2s_need_apll;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, w->name);\n\t \n\tcur_apll = mt8186_get_apll_by_name(afe, source->name);\n\t \n\ti2s_need_apll = mt8186_get_apll_by_rate(afe, i2s_priv->rate);\n\n\treturn (i2s_need_apll == cur_apll) ? 1 : 0;\n}\n\nstatic int mtk_afe_i2s_mclk_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t    struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = sink;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, sink->name);\n\tif (get_i2s_id_by_name(afe, sink->name) ==\n\t    get_i2s_id_by_name(afe, source->name))\n\t\treturn (i2s_priv->mclk_rate > 0) ? 1 : 0;\n\n\t \n\tif (i2s_priv->share_i2s_id < 0)\n\t\treturn 0;\n\n\tif (i2s_priv->share_i2s_id == get_i2s_id_by_name(afe, source->name))\n\t\treturn (i2s_priv->mclk_rate > 0) ? 1 : 0;\n\n\treturn 0;\n}\n\nstatic int mtk_afe_mclk_apll_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t     struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = sink;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_afe_i2s_priv *i2s_priv;\n\tint cur_apll;\n\n\ti2s_priv = get_i2s_priv_by_name(afe, w->name);\n\t \n\tcur_apll = mt8186_get_apll_by_name(afe, source->name);\n\n\treturn (i2s_priv->mclk_apll == cur_apll) ? 1 : 0;\n}\n\nstatic const struct snd_soc_dapm_route mtk_dai_i2s_routes[] = {\n\t{\"Connsys I2S\", NULL, \"CONNSYS\"},\n\n\t \n\t{\"I2S0\", NULL, \"I2S0_EN\"},\n\t{\"I2S0\", NULL, \"I2S1_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S0\", NULL, \"I2S2_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S0\", NULL, \"I2S3_EN\", mtk_afe_i2s_share_connect},\n\n\t{\"I2S0\", NULL, I2S0_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S0\", NULL, I2S1_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S0\", NULL, I2S2_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S0\", NULL, I2S3_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{I2S0_HD_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_i2s_apll_connect},\n\t{I2S0_HD_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_i2s_apll_connect},\n\n\t{\"I2S0\", NULL, I2S0_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S0\", NULL, I2S1_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S0\", NULL, I2S2_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S0\", NULL, I2S3_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{I2S0_MCLK_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_mclk_apll_connect},\n\t{I2S0_MCLK_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_mclk_apll_connect},\n\n\t \n\t{\"I2S1_CH1\", \"DL1_CH1 Switch\", \"DL1\"},\n\t{\"I2S1_CH2\", \"DL1_CH2 Switch\", \"DL1\"},\n\n\t{\"I2S1_CH1\", \"DL1_CH1 Switch\", \"DSP_DL1_VIRT\"},\n\t{\"I2S1_CH2\", \"DL1_CH2 Switch\", \"DSP_DL1_VIRT\"},\n\n\t{\"I2S1_CH1\", \"DL2_CH1 Switch\", \"DL2\"},\n\t{\"I2S1_CH2\", \"DL2_CH2 Switch\", \"DL2\"},\n\n\t{\"I2S1_CH1\", \"DL2_CH1 Switch\", \"DSP_DL2_VIRT\"},\n\t{\"I2S1_CH2\", \"DL2_CH2 Switch\", \"DSP_DL2_VIRT\"},\n\n\t{\"I2S1_CH1\", \"DL3_CH1 Switch\", \"DL3\"},\n\t{\"I2S1_CH2\", \"DL3_CH2 Switch\", \"DL3\"},\n\n\t{\"I2S1_CH1\", \"DL12_CH1 Switch\", \"DL12\"},\n\t{\"I2S1_CH2\", \"DL12_CH2 Switch\", \"DL12\"},\n\n\t{\"I2S1_CH1\", \"DL12_CH3 Switch\", \"DL12\"},\n\t{\"I2S1_CH2\", \"DL12_CH4 Switch\", \"DL12\"},\n\n\t{\"I2S1_CH1\", \"DL6_CH1 Switch\", \"DL6\"},\n\t{\"I2S1_CH2\", \"DL6_CH2 Switch\", \"DL6\"},\n\n\t{\"I2S1_CH1\", \"DL4_CH1 Switch\", \"DL4\"},\n\t{\"I2S1_CH2\", \"DL4_CH2 Switch\", \"DL4\"},\n\n\t{\"I2S1_CH1\", \"DL5_CH1 Switch\", \"DL5\"},\n\t{\"I2S1_CH2\", \"DL5_CH2 Switch\", \"DL5\"},\n\n\t{\"I2S1_CH1\", \"DL8_CH1 Switch\", \"DL8\"},\n\t{\"I2S1_CH2\", \"DL8_CH2 Switch\", \"DL8\"},\n\n\t{\"I2S1\", NULL, \"I2S1_CH1\"},\n\t{\"I2S1\", NULL, \"I2S1_CH2\"},\n\n\t{\"I2S1\", NULL, \"I2S0_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S1\", NULL, \"I2S1_EN\"},\n\t{\"I2S1\", NULL, \"I2S2_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S1\", NULL, \"I2S3_EN\", mtk_afe_i2s_share_connect},\n\n\t{\"I2S1\", NULL, I2S0_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S1\", NULL, I2S1_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S1\", NULL, I2S2_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S1\", NULL, I2S3_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{I2S1_HD_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_i2s_apll_connect},\n\t{I2S1_HD_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_i2s_apll_connect},\n\n\t{\"I2S1\", NULL, I2S0_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S1\", NULL, I2S1_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S1\", NULL, I2S2_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S1\", NULL, I2S3_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{I2S1_MCLK_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_mclk_apll_connect},\n\t{I2S1_MCLK_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_mclk_apll_connect},\n\n\t \n\t{\"I2S2\", NULL, \"I2S0_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S2\", NULL, \"I2S1_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S2\", NULL, \"I2S2_EN\"},\n\t{\"I2S2\", NULL, \"I2S3_EN\", mtk_afe_i2s_share_connect},\n\n\t{\"I2S2\", NULL, I2S0_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S2\", NULL, I2S1_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S2\", NULL, I2S2_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S2\", NULL, I2S3_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{I2S2_HD_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_i2s_apll_connect},\n\t{I2S2_HD_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_i2s_apll_connect},\n\n\t{\"I2S2\", NULL, I2S0_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S2\", NULL, I2S1_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S2\", NULL, I2S2_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S2\", NULL, I2S3_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{I2S2_MCLK_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_mclk_apll_connect},\n\t{I2S2_MCLK_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_mclk_apll_connect},\n\n\t \n\t{\"I2S3_CH1\", \"DL1_CH1 Switch\", \"DL1\"},\n\t{\"I2S3_CH2\", \"DL1_CH2 Switch\", \"DL1\"},\n\n\t{\"I2S3_CH1\", \"DL1_CH1 Switch\", \"DSP_DL1_VIRT\"},\n\t{\"I2S3_CH2\", \"DL1_CH2 Switch\", \"DSP_DL1_VIRT\"},\n\n\t{\"I2S3_CH1\", \"DL2_CH1 Switch\", \"DL2\"},\n\t{\"I2S3_CH2\", \"DL2_CH2 Switch\", \"DL2\"},\n\n\t{\"I2S3_CH1\", \"DL2_CH1 Switch\", \"DSP_DL2_VIRT\"},\n\t{\"I2S3_CH2\", \"DL2_CH2 Switch\", \"DSP_DL2_VIRT\"},\n\n\t{\"I2S3_CH1\", \"DL3_CH1 Switch\", \"DL3\"},\n\t{\"I2S3_CH2\", \"DL3_CH2 Switch\", \"DL3\"},\n\n\t{\"I2S3_CH1\", \"DL12_CH1 Switch\", \"DL12\"},\n\t{\"I2S3_CH2\", \"DL12_CH2 Switch\", \"DL12\"},\n\n\t{\"I2S3_CH1\", \"DL12_CH3 Switch\", \"DL12\"},\n\t{\"I2S3_CH2\", \"DL12_CH4 Switch\", \"DL12\"},\n\n\t{\"I2S3_CH1\", \"DL6_CH1 Switch\", \"DL6\"},\n\t{\"I2S3_CH2\", \"DL6_CH2 Switch\", \"DL6\"},\n\n\t{\"I2S3_CH1\", \"DL4_CH1 Switch\", \"DL4\"},\n\t{\"I2S3_CH2\", \"DL4_CH2 Switch\", \"DL4\"},\n\n\t{\"I2S3_CH1\", \"DL5_CH1 Switch\", \"DL5\"},\n\t{\"I2S3_CH2\", \"DL5_CH2 Switch\", \"DL5\"},\n\n\t{\"I2S3_CH1\", \"DL8_CH1 Switch\", \"DL8\"},\n\t{\"I2S3_CH2\", \"DL8_CH2 Switch\", \"DL8\"},\n\n\t{\"I2S3\", NULL, \"I2S3_CH1\"},\n\t{\"I2S3\", NULL, \"I2S3_CH2\"},\n\n\t{\"I2S3\", NULL, \"I2S0_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S3\", NULL, \"I2S1_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S3\", NULL, \"I2S2_EN\", mtk_afe_i2s_share_connect},\n\t{\"I2S3\", NULL, \"I2S3_EN\"},\n\n\t{\"I2S3\", NULL, I2S0_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S3\", NULL, I2S1_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S3\", NULL, I2S2_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{\"I2S3\", NULL, I2S3_HD_EN_W_NAME, mtk_afe_i2s_hd_connect},\n\t{I2S3_HD_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_i2s_apll_connect},\n\t{I2S3_HD_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_i2s_apll_connect},\n\n\t{\"I2S3\", NULL, I2S0_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S3\", NULL, I2S1_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S3\", NULL, I2S2_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{\"I2S3\", NULL, I2S3_MCLK_EN_W_NAME, mtk_afe_i2s_mclk_connect},\n\t{I2S3_MCLK_EN_W_NAME, NULL, APLL1_W_NAME, mtk_afe_mclk_apll_connect},\n\t{I2S3_MCLK_EN_W_NAME, NULL, APLL2_W_NAME, mtk_afe_mclk_apll_connect},\n\n\t \n\t{\"I2S0\", NULL, \"I2S0_In_Mux\"},\n\t{\"I2S0_In_Mux\", \"Dummy_Widget\", \"I2S_DUMMY_IN\"},\n\n\t{\"I2S1_Out_Mux\", \"Dummy_Widget\", \"I2S1\"},\n\t{\"I2S_DUMMY_OUT\", NULL, \"I2S1_Out_Mux\"},\n\n\t{\"I2S2\", NULL, \"I2S2_In_Mux\"},\n\t{\"I2S2_In_Mux\", \"Dummy_Widget\", \"I2S_DUMMY_IN\"},\n\n\t{\"I2S3_Out_Mux\", \"Dummy_Widget\", \"I2S3\"},\n\t{\"I2S_DUMMY_OUT\", NULL, \"I2S3_Out_Mux\"},\n\n\t \n\t{\"I2S0_Lpbk_Mux\", \"Lpbk\", \"I2S3\"},\n\t{\"I2S2_Lpbk_Mux\", \"Lpbk\", \"I2S1\"},\n\t{\"I2S0\", NULL, \"I2S0_Lpbk_Mux\"},\n\t{\"I2S2\", NULL, \"I2S2_Lpbk_Mux\"},\n};\n\n \nstatic int mtk_dai_connsys_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t\t\t struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tunsigned int rate = params_rate(params);\n\tunsigned int rate_reg = mt8186_rate_transform(afe->dev,\n\t\t\t\t\t\t      rate, dai->id);\n\tunsigned int i2s_con = 0;\n\n\tdev_dbg(afe->dev, \"%s(), id %d, stream %d, rate %d\\n\",\n\t\t__func__, dai->id, substream->stream, rate);\n\n\t \n\ti2s_con |= 0 << INV_PAD_CTRL_SFT;\n\ti2s_con |= I2S_FMT_I2S << I2S_FMT_SFT;\n\ti2s_con |= 1 << I2S_SRC_SFT;\n\ti2s_con |= get_i2s_wlen(SNDRV_PCM_FORMAT_S16_LE) << I2S_WLEN_SFT;\n\ti2s_con |= 0 << I2SIN_PAD_SEL_SFT;\n\tregmap_write(afe->regmap, AFE_CONNSYS_I2S_CON, i2s_con);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_CONNSYS_I2S_CON,\n\t\t\t   I2S_BYPSRC_MASK_SFT, 0);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_CONNSYS_I2S_CON,\n\t\t\t   I2S_MODE_MASK_SFT, rate_reg << I2S_MODE_SFT);\n\n\tif (rate == 44100)\n\t\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON3, 0x1b9000);\n\telse if (rate == 32000)\n\t\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON3, 0x140000);\n\telse\n\t\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON3, 0x1e0000);\n\n\t \n\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON4, 0x140000);\n\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON9, 0x36000);\n\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON10, 0x2fc00);\n\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON6, 0x7ef4);\n\tregmap_write(afe->regmap, AFE_ASRC_2CH_CON5, 0xff5986);\n\n\t \n\tregmap_update_bits(afe->regmap, AFE_ASRC_2CH_CON2,\n\t\t\t   CHSET_IS_MONO_MASK_SFT, 0);\n\n\treturn 0;\n}\n\nstatic int mtk_dai_connsys_i2s_trigger(struct snd_pcm_substream *substream,\n\t\t\t\t       int cmd, struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\n\tdev_dbg(afe->dev, \"%s(), cmd %d, stream %d\\n\",\n\t\t__func__, cmd, substream->stream);\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\t\t \n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_CONNSYS_I2S_CON,\n\t\t\t\t   I2S_EN_MASK_SFT,\n\t\t\t\t   BIT(I2S_EN_SFT));\n\n\t\t \n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ASRC_2CH_CON5,\n\t\t\t\t   CALI_EN_MASK_SFT,\n\t\t\t\t   BIT(CALI_EN_SFT));\n\n\t\t \n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ASRC_2CH_CON0,\n\t\t\t\t   CON0_CHSET_STR_CLR_MASK_SFT,\n\t\t\t\t   BIT(CON0_CHSET_STR_CLR_SFT));\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ASRC_2CH_CON0,\n\t\t\t\t   CON0_ASM_ON_MASK_SFT,\n\t\t\t\t   BIT(CON0_ASM_ON_SFT));\n\n\t\tafe_priv->dai_on[dai->id] = true;\n\t\treturn 0;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\t\tregmap_update_bits(afe->regmap, AFE_ASRC_2CH_CON0,\n\t\t\t\t   CON0_ASM_ON_MASK_SFT, 0);\n\t\tregmap_update_bits(afe->regmap, AFE_ASRC_2CH_CON5,\n\t\t\t\t   CALI_EN_MASK_SFT, 0);\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_CONNSYS_I2S_CON,\n\t\t\t\t   I2S_EN_MASK_SFT, 0);\n\n\t\t \n\t\tregmap_update_bits(afe->regmap, AFE_CONNSYS_I2S_CON,\n\t\t\t\t   I2S_BYPSRC_MASK_SFT, BIT(I2S_BYPSRC_SFT));\n\n\t\tafe_priv->dai_on[dai->id] = false;\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops mtk_dai_connsys_i2s_ops = {\n\t.hw_params = mtk_dai_connsys_i2s_hw_params,\n\t.trigger = mtk_dai_connsys_i2s_trigger,\n};\n\n \nstatic int mtk_dai_i2s_config(struct mtk_base_afe *afe,\n\t\t\t      struct snd_pcm_hw_params *params,\n\t\t\t      int i2s_id)\n{\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_afe_i2s_priv *i2s_priv = afe_priv->dai_priv[i2s_id];\n\n\tunsigned int rate = params_rate(params);\n\tunsigned int rate_reg = mt8186_rate_transform(afe->dev,\n\t\t\t\t\t\t      rate, i2s_id);\n\tsnd_pcm_format_t format = params_format(params);\n\tunsigned int i2s_con = 0;\n\tint ret;\n\n\tdev_dbg(afe->dev, \"%s(), id %d, rate %d, format %d\\n\",\n\t\t__func__, i2s_id, rate, format);\n\n\ti2s_priv->rate = rate;\n\n\tswitch (i2s_id) {\n\tcase MT8186_DAI_I2S_0:\n\t\ti2s_con = I2S_IN_PAD_IO_MUX << I2SIN_PAD_SEL_SFT;\n\t\ti2s_con |= rate_reg << I2S_OUT_MODE_SFT;\n\t\ti2s_con |= I2S_FMT_I2S << I2S_FMT_SFT;\n\t\ti2s_con |= get_i2s_wlen(format) << I2S_WLEN_SFT;\n\t\tregmap_update_bits(afe->regmap, AFE_I2S_CON,\n\t\t\t\t   0xffffeffa, i2s_con);\n\t\tbreak;\n\tcase MT8186_DAI_I2S_1:\n\t\ti2s_con = I2S1_SEL_O28_O29 << I2S2_SEL_O03_O04_SFT;\n\t\ti2s_con |= rate_reg << I2S2_OUT_MODE_SFT;\n\t\ti2s_con |= I2S_FMT_I2S << I2S2_FMT_SFT;\n\t\ti2s_con |= get_i2s_wlen(format) << I2S2_WLEN_SFT;\n\t\tregmap_update_bits(afe->regmap, AFE_I2S_CON1,\n\t\t\t\t   0xffffeffa, i2s_con);\n\t\tbreak;\n\tcase MT8186_DAI_I2S_2:\n\t\ti2s_con = 8 << I2S3_UPDATE_WORD_SFT;\n\t\ti2s_con |= rate_reg << I2S3_OUT_MODE_SFT;\n\t\ti2s_con |= I2S_FMT_I2S << I2S3_FMT_SFT;\n\t\ti2s_con |= get_i2s_wlen(format) << I2S3_WLEN_SFT;\n\t\tregmap_update_bits(afe->regmap, AFE_I2S_CON2,\n\t\t\t\t   0xffffeffa, i2s_con);\n\t\tbreak;\n\tcase MT8186_DAI_I2S_3:\n\t\ti2s_con = rate_reg << I2S4_OUT_MODE_SFT;\n\t\ti2s_con |= I2S_FMT_I2S << I2S4_FMT_SFT;\n\t\ti2s_con |= get_i2s_wlen(format) << I2S4_WLEN_SFT;\n\t\tregmap_update_bits(afe->regmap, AFE_I2S_CON3,\n\t\t\t\t   0xffffeffa, i2s_con);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(afe->dev, \"%s(), id %d not support\\n\",\n\t\t\t__func__, i2s_id);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (i2s_priv->share_i2s_id >= 0) {\n\t\tret = mtk_dai_i2s_config(afe, params, i2s_priv->share_i2s_id);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_dai_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params,\n\t\t\t\t struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\n\treturn mtk_dai_i2s_config(afe, params, dai->id);\n}\n\nstatic int mtk_dai_i2s_set_sysclk(struct snd_soc_dai *dai,\n\t\t\t\t  int clk_id, unsigned int freq, int dir)\n{\n\tstruct mtk_base_afe *afe = dev_get_drvdata(dai->dev);\n\tstruct mt8186_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_afe_i2s_priv *i2s_priv = afe_priv->dai_priv[dai->id];\n\tint apll;\n\tint apll_rate;\n\n\tif (dir != SND_SOC_CLOCK_OUT) {\n\t\tdev_err(afe->dev, \"%s(), dir != SND_SOC_CLOCK_OUT\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\tdev_dbg(afe->dev, \"%s(), freq %d\\n\", __func__, freq);\n\n\tapll = mt8186_get_apll_by_rate(afe, freq);\n\tapll_rate = mt8186_get_apll_rate(afe, apll);\n\n\tif (freq > apll_rate) {\n\t\tdev_err(afe->dev, \"%s(), freq > apll rate\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\tif (apll_rate % freq != 0) {\n\t\tdev_err(afe->dev, \"%s(), APLL cannot generate freq Hz\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\ti2s_priv->mclk_rate = freq;\n\ti2s_priv->mclk_apll = apll;\n\n\tif (i2s_priv->share_i2s_id > 0) {\n\t\tstruct mtk_afe_i2s_priv *share_i2s_priv;\n\n\t\tshare_i2s_priv = afe_priv->dai_priv[i2s_priv->share_i2s_id];\n\t\tif (!share_i2s_priv) {\n\t\t\tdev_err(afe->dev, \"%s(), share_i2s_priv == NULL\", __func__);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tshare_i2s_priv->mclk_rate = i2s_priv->mclk_rate;\n\t\tshare_i2s_priv->mclk_apll = i2s_priv->mclk_apll;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_dai_ops mtk_dai_i2s_ops = {\n\t.hw_params = mtk_dai_i2s_hw_params,\n\t.set_sysclk = mtk_dai_i2s_set_sysclk,\n};\n\n \n#define MTK_CONNSYS_I2S_RATES (SNDRV_PCM_RATE_44100 | SNDRV_PCM_RATE_48000)\n\n#define MTK_I2S_RATES (SNDRV_PCM_RATE_8000_48000 |\\\n\t\t       SNDRV_PCM_RATE_88200 |\\\n\t\t       SNDRV_PCM_RATE_96000 |\\\n\t\t       SNDRV_PCM_RATE_176400 |\\\n\t\t       SNDRV_PCM_RATE_192000)\n\n#define MTK_I2S_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\t\t SNDRV_PCM_FMTBIT_S24_LE |\\\n\t\t\t SNDRV_PCM_FMTBIT_S32_LE)\n\nstatic struct snd_soc_dai_driver mtk_dai_i2s_driver[] = {\n\t{\n\t\t.name = \"CONNSYS_I2S\",\n\t\t.id = MT8186_DAI_CONNSYS_I2S,\n\t\t.capture = {\n\t\t\t.stream_name = \"Connsys I2S\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_CONNSYS_I2S_RATES,\n\t\t\t.formats = MTK_I2S_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_connsys_i2s_ops,\n\t},\n\t{\n\t\t.name = \"I2S0\",\n\t\t.id = MT8186_DAI_I2S_0,\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S0\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_I2S_RATES,\n\t\t\t.formats = MTK_I2S_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_i2s_ops,\n\t},\n\t{\n\t\t.name = \"I2S1\",\n\t\t.id = MT8186_DAI_I2S_1,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S1\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_I2S_RATES,\n\t\t\t.formats = MTK_I2S_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_i2s_ops,\n\t},\n\t{\n\t\t.name = \"I2S2\",\n\t\t.id = MT8186_DAI_I2S_2,\n\t\t.capture = {\n\t\t\t.stream_name = \"I2S2\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_I2S_RATES,\n\t\t\t.formats = MTK_I2S_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_i2s_ops,\n\t},\n\t{\n\t\t.name = \"I2S3\",\n\t\t.id = MT8186_DAI_I2S_3,\n\t\t.playback = {\n\t\t\t.stream_name = \"I2S3\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_I2S_RATES,\n\t\t\t.formats = MTK_I2S_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_i2s_ops,\n\t}\n};\n\n \nenum {\n\tDAI_I2S0 = 0,\n\tDAI_I2S1,\n\tDAI_I2S2,\n\tDAI_I2S3,\n\tDAI_I2S_NUM,\n};\n\nstatic const struct mtk_afe_i2s_priv mt8186_i2s_priv[DAI_I2S_NUM] = {\n\t[DAI_I2S0] = {\n\t\t.id = MT8186_DAI_I2S_0,\n\t\t.mclk_id = MT8186_I2S0_MCK,\n\t\t.share_i2s_id = -1,\n\t},\n\t[DAI_I2S1] = {\n\t\t.id = MT8186_DAI_I2S_1,\n\t\t.mclk_id = MT8186_I2S1_MCK,\n\t\t.share_i2s_id = -1,\n\t},\n\t[DAI_I2S2] = {\n\t\t.id = MT8186_DAI_I2S_2,\n\t\t.mclk_id = MT8186_I2S2_MCK,\n\t\t.share_i2s_id = -1,\n\t},\n\t[DAI_I2S3] = {\n\t\t.id = MT8186_DAI_I2S_3,\n\t\t \n\t\t.mclk_id = MT8186_I2S4_MCK,\n\t\t.share_i2s_id = -1,\n\t}\n};\n\n \nint mt8186_dai_i2s_set_share(struct mtk_base_afe *afe, const char *main_i2s_name,\n\t\t\t     const char *secondary_i2s_name)\n{\n\tstruct mtk_afe_i2s_priv *secondary_i2s_priv;\n\tint main_i2s_id;\n\n\tsecondary_i2s_priv = get_i2s_priv_by_name(afe, secondary_i2s_name);\n\tif (!secondary_i2s_priv)\n\t\treturn -EINVAL;\n\n\tmain_i2s_id = get_i2s_id_by_name(afe, main_i2s_name);\n\tif (main_i2s_id < 0)\n\t\treturn main_i2s_id;\n\n\tsecondary_i2s_priv->share_i2s_id = main_i2s_id;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt8186_dai_i2s_set_share);\n\nstatic int mt8186_dai_i2s_set_priv(struct mtk_base_afe *afe)\n{\n\tint i;\n\tint ret;\n\n\tfor (i = 0; i < DAI_I2S_NUM; i++) {\n\t\tret = mt8186_dai_set_priv(afe, mt8186_i2s_priv[i].id,\n\t\t\t\t\t  sizeof(struct mtk_afe_i2s_priv),\n\t\t\t\t\t  &mt8186_i2s_priv[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nint mt8186_dai_i2s_register(struct mtk_base_afe *afe)\n{\n\tstruct mtk_base_afe_dai *dai;\n\tint ret;\n\n\tdai = devm_kzalloc(afe->dev, sizeof(*dai), GFP_KERNEL);\n\tif (!dai)\n\t\treturn -ENOMEM;\n\n\tlist_add(&dai->list, &afe->sub_dais);\n\n\tdai->dai_drivers = mtk_dai_i2s_driver;\n\tdai->num_dai_drivers = ARRAY_SIZE(mtk_dai_i2s_driver);\n\n\tdai->controls = mtk_dai_i2s_controls;\n\tdai->num_controls = ARRAY_SIZE(mtk_dai_i2s_controls);\n\tdai->dapm_widgets = mtk_dai_i2s_widgets;\n\tdai->num_dapm_widgets = ARRAY_SIZE(mtk_dai_i2s_widgets);\n\tdai->dapm_routes = mtk_dai_i2s_routes;\n\tdai->num_dapm_routes = ARRAY_SIZE(mtk_dai_i2s_routes);\n\n\t \n\tret = mt8186_dai_i2s_set_priv(afe);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}