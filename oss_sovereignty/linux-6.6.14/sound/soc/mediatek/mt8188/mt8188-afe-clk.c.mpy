{
  "module_name": "mt8188-afe-clk.c",
  "hash_id": "5f759ad22e960fd9426579653358ba4ddf4b73bb26c9b9e66679b7430a59449f",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8188/mt8188-afe-clk.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n\n#include \"mt8188-afe-common.h\"\n#include \"mt8188-afe-clk.h\"\n#include \"mt8188-audsys-clk.h\"\n#include \"mt8188-reg.h\"\n\nstatic const char *aud_clks[MT8188_CLK_NUM] = {\n\t \n\t[MT8188_CLK_XTAL_26M] = \"clk26m\",\n\n\t \n\t[MT8188_CLK_APMIXED_APLL1] = \"apll1\",\n\t[MT8188_CLK_APMIXED_APLL2] = \"apll2\",\n\n\t \n\t[MT8188_CLK_TOP_APLL1_D4] = \"apll1_d4\",\n\t[MT8188_CLK_TOP_APLL2_D4] = \"apll2_d4\",\n\t[MT8188_CLK_TOP_APLL12_DIV0] = \"apll12_div0\",\n\t[MT8188_CLK_TOP_APLL12_DIV1] = \"apll12_div1\",\n\t[MT8188_CLK_TOP_APLL12_DIV2] = \"apll12_div2\",\n\t[MT8188_CLK_TOP_APLL12_DIV3] = \"apll12_div3\",\n\t[MT8188_CLK_TOP_APLL12_DIV4] = \"apll12_div4\",\n\t[MT8188_CLK_TOP_APLL12_DIV9] = \"apll12_div9\",\n\n\t \n\t[MT8188_CLK_TOP_A1SYS_HP_SEL] = \"top_a1sys_hp\",\n\t[MT8188_CLK_TOP_A2SYS_SEL] = \"top_a2sys\",\n\t[MT8188_CLK_TOP_AUD_IEC_SEL] = \"top_aud_iec\",\n\t[MT8188_CLK_TOP_AUD_INTBUS_SEL] = \"top_aud_intbus\",\n\t[MT8188_CLK_TOP_AUDIO_H_SEL] = \"top_audio_h\",\n\t[MT8188_CLK_TOP_AUDIO_LOCAL_BUS_SEL] = \"top_audio_local_bus\",\n\t[MT8188_CLK_TOP_DPTX_M_SEL] = \"top_dptx\",\n\t[MT8188_CLK_TOP_I2SO1_M_SEL] = \"top_i2so1\",\n\t[MT8188_CLK_TOP_I2SO2_M_SEL] = \"top_i2so2\",\n\t[MT8188_CLK_TOP_I2SI1_M_SEL] = \"top_i2si1\",\n\t[MT8188_CLK_TOP_I2SI2_M_SEL] = \"top_i2si2\",\n\n\t \n\t[MT8188_CLK_ADSP_AUDIO_26M] = \"adsp_audio_26m\",\n\t \n\t[MT8188_CLK_AUD_AFE] = \"aud_afe\",\n\t[MT8188_CLK_AUD_APLL1_TUNER] = \"aud_apll1_tuner\",\n\t[MT8188_CLK_AUD_APLL2_TUNER] = \"aud_apll2_tuner\",\n\t[MT8188_CLK_AUD_APLL] = \"aud_apll\",\n\t[MT8188_CLK_AUD_APLL2] = \"aud_apll2\",\n\t[MT8188_CLK_AUD_DAC] = \"aud_dac\",\n\t[MT8188_CLK_AUD_ADC] = \"aud_adc\",\n\t[MT8188_CLK_AUD_DAC_HIRES] = \"aud_dac_hires\",\n\t[MT8188_CLK_AUD_A1SYS_HP] = \"aud_a1sys_hp\",\n\t[MT8188_CLK_AUD_ADC_HIRES] = \"aud_adc_hires\",\n\t[MT8188_CLK_AUD_I2SIN] = \"aud_i2sin\",\n\t[MT8188_CLK_AUD_TDM_IN] = \"aud_tdm_in\",\n\t[MT8188_CLK_AUD_I2S_OUT] = \"aud_i2s_out\",\n\t[MT8188_CLK_AUD_TDM_OUT] = \"aud_tdm_out\",\n\t[MT8188_CLK_AUD_HDMI_OUT] = \"aud_hdmi_out\",\n\t[MT8188_CLK_AUD_ASRC11] = \"aud_asrc11\",\n\t[MT8188_CLK_AUD_ASRC12] = \"aud_asrc12\",\n\t[MT8188_CLK_AUD_A1SYS] = \"aud_a1sys\",\n\t[MT8188_CLK_AUD_A2SYS] = \"aud_a2sys\",\n\t[MT8188_CLK_AUD_PCMIF] = \"aud_pcmif\",\n\t[MT8188_CLK_AUD_MEMIF_UL1] = \"aud_memif_ul1\",\n\t[MT8188_CLK_AUD_MEMIF_UL2] = \"aud_memif_ul2\",\n\t[MT8188_CLK_AUD_MEMIF_UL3] = \"aud_memif_ul3\",\n\t[MT8188_CLK_AUD_MEMIF_UL4] = \"aud_memif_ul4\",\n\t[MT8188_CLK_AUD_MEMIF_UL5] = \"aud_memif_ul5\",\n\t[MT8188_CLK_AUD_MEMIF_UL6] = \"aud_memif_ul6\",\n\t[MT8188_CLK_AUD_MEMIF_UL8] = \"aud_memif_ul8\",\n\t[MT8188_CLK_AUD_MEMIF_UL9] = \"aud_memif_ul9\",\n\t[MT8188_CLK_AUD_MEMIF_UL10] = \"aud_memif_ul10\",\n\t[MT8188_CLK_AUD_MEMIF_DL2] = \"aud_memif_dl2\",\n\t[MT8188_CLK_AUD_MEMIF_DL3] = \"aud_memif_dl3\",\n\t[MT8188_CLK_AUD_MEMIF_DL6] = \"aud_memif_dl6\",\n\t[MT8188_CLK_AUD_MEMIF_DL7] = \"aud_memif_dl7\",\n\t[MT8188_CLK_AUD_MEMIF_DL8] = \"aud_memif_dl8\",\n\t[MT8188_CLK_AUD_MEMIF_DL10] = \"aud_memif_dl10\",\n\t[MT8188_CLK_AUD_MEMIF_DL11] = \"aud_memif_dl11\",\n};\n\nstruct mt8188_afe_tuner_cfg {\n\tunsigned int id;\n\tint apll_div_reg;\n\tunsigned int apll_div_shift;\n\tunsigned int apll_div_maskbit;\n\tunsigned int apll_div_default;\n\tint ref_ck_sel_reg;\n\tunsigned int ref_ck_sel_shift;\n\tunsigned int ref_ck_sel_maskbit;\n\tunsigned int ref_ck_sel_default;\n\tint tuner_en_reg;\n\tunsigned int tuner_en_shift;\n\tunsigned int tuner_en_maskbit;\n\tint upper_bound_reg;\n\tunsigned int upper_bound_shift;\n\tunsigned int upper_bound_maskbit;\n\tunsigned int upper_bound_default;\n\tspinlock_t ctrl_lock;  \n\tint ref_cnt;\n};\n\nstatic struct mt8188_afe_tuner_cfg\n\tmt8188_afe_tuner_cfgs[MT8188_AUD_PLL_NUM] = {\n\t[MT8188_AUD_PLL1] = {\n\t\t.id = MT8188_AUD_PLL1,\n\t\t.apll_div_reg = AFE_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0xf,\n\t\t.apll_div_default = 0x7,\n\t\t.ref_ck_sel_reg = AFE_APLL_TUNER_CFG,\n\t\t.ref_ck_sel_shift = 1,\n\t\t.ref_ck_sel_maskbit = 0x3,\n\t\t.ref_ck_sel_default = 0x2,\n\t\t.tuner_en_reg = AFE_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 8,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x3,\n\t},\n\t[MT8188_AUD_PLL2] = {\n\t\t.id = MT8188_AUD_PLL2,\n\t\t.apll_div_reg = AFE_APLL_TUNER_CFG1,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0xf,\n\t\t.apll_div_default = 0x7,\n\t\t.ref_ck_sel_reg = AFE_APLL_TUNER_CFG1,\n\t\t.ref_ck_sel_shift = 1,\n\t\t.ref_ck_sel_maskbit = 0x3,\n\t\t.ref_ck_sel_default = 0x1,\n\t\t.tuner_en_reg = AFE_APLL_TUNER_CFG1,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_APLL_TUNER_CFG1,\n\t\t.upper_bound_shift = 8,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x3,\n\t},\n\t[MT8188_AUD_PLL3] = {\n\t\t.id = MT8188_AUD_PLL3,\n\t\t.apll_div_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0x3f,\n\t\t.apll_div_default = 0x3,\n\t\t.ref_ck_sel_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.ref_ck_sel_shift = 24,\n\t\t.ref_ck_sel_maskbit = 0x3,\n\t\t.ref_ck_sel_default = 0x0,\n\t\t.tuner_en_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 12,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x4,\n\t},\n\t[MT8188_AUD_PLL4] = {\n\t\t.id = MT8188_AUD_PLL4,\n\t\t.apll_div_reg = AFE_SPDIFIN_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0x3f,\n\t\t.apll_div_default = 0x7,\n\t\t.ref_ck_sel_reg = AFE_SPDIFIN_APLL_TUNER_CFG1,\n\t\t.ref_ck_sel_shift = 8,\n\t\t.ref_ck_sel_maskbit = 0x1,\n\t\t.ref_ck_sel_default = 0,\n\t\t.tuner_en_reg = AFE_SPDIFIN_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_SPDIFIN_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 12,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x4,\n\t},\n\t[MT8188_AUD_PLL5] = {\n\t\t.id = MT8188_AUD_PLL5,\n\t\t.apll_div_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0x3f,\n\t\t.apll_div_default = 0x3,\n\t\t.ref_ck_sel_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.ref_ck_sel_shift = 24,\n\t\t.ref_ck_sel_maskbit = 0x1,\n\t\t.ref_ck_sel_default = 0,\n\t\t.tuner_en_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 12,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x4,\n\t},\n};\n\nstatic struct mt8188_afe_tuner_cfg *mt8188_afe_found_apll_tuner(unsigned int id)\n{\n\tif (id >= MT8188_AUD_PLL_NUM)\n\t\treturn NULL;\n\n\treturn &mt8188_afe_tuner_cfgs[id];\n}\n\nstatic int mt8188_afe_init_apll_tuner(unsigned int id)\n{\n\tstruct mt8188_afe_tuner_cfg *cfg = mt8188_afe_found_apll_tuner(id);\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tcfg->ref_cnt = 0;\n\tspin_lock_init(&cfg->ctrl_lock);\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_setup_apll_tuner(struct mtk_base_afe *afe, unsigned int id)\n{\n\tconst struct mt8188_afe_tuner_cfg *cfg = mt8188_afe_found_apll_tuner(id);\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tregmap_update_bits(afe->regmap,\n\t\t\t   cfg->apll_div_reg,\n\t\t\t   cfg->apll_div_maskbit << cfg->apll_div_shift,\n\t\t\t   cfg->apll_div_default << cfg->apll_div_shift);\n\n\tregmap_update_bits(afe->regmap,\n\t\t\t   cfg->ref_ck_sel_reg,\n\t\t\t   cfg->ref_ck_sel_maskbit << cfg->ref_ck_sel_shift,\n\t\t\t   cfg->ref_ck_sel_default << cfg->ref_ck_sel_shift);\n\n\tregmap_update_bits(afe->regmap,\n\t\t\t   cfg->upper_bound_reg,\n\t\t\t   cfg->upper_bound_maskbit << cfg->upper_bound_shift,\n\t\t\t   cfg->upper_bound_default << cfg->upper_bound_shift);\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_enable_tuner_clk(struct mtk_base_afe *afe,\n\t\t\t\t       unsigned int id)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\tswitch (id) {\n\tcase MT8188_AUD_PLL1:\n\t\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL]);\n\t\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL1_TUNER]);\n\t\tbreak;\n\tcase MT8188_AUD_PLL2:\n\t\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL2]);\n\t\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL2_TUNER]);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_disable_tuner_clk(struct mtk_base_afe *afe,\n\t\t\t\t\tunsigned int id)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\tswitch (id) {\n\tcase MT8188_AUD_PLL1:\n\t\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL1_TUNER]);\n\t\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL]);\n\t\tbreak;\n\tcase MT8188_AUD_PLL2:\n\t\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL2_TUNER]);\n\t\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_APLL2]);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_enable_apll_tuner(struct mtk_base_afe *afe, unsigned int id)\n{\n\tstruct mt8188_afe_tuner_cfg *cfg = mt8188_afe_found_apll_tuner(id);\n\tunsigned long flags;\n\tint ret;\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tret = mt8188_afe_setup_apll_tuner(afe, id);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt8188_afe_enable_tuner_clk(afe, id);\n\tif (ret)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&cfg->ctrl_lock, flags);\n\n\tcfg->ref_cnt++;\n\tif (cfg->ref_cnt == 1)\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   cfg->tuner_en_reg,\n\t\t\t\t   cfg->tuner_en_maskbit << cfg->tuner_en_shift,\n\t\t\t\t   BIT(cfg->tuner_en_shift));\n\n\tspin_unlock_irqrestore(&cfg->ctrl_lock, flags);\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_disable_apll_tuner(struct mtk_base_afe *afe, unsigned int id)\n{\n\tstruct mt8188_afe_tuner_cfg *cfg = mt8188_afe_found_apll_tuner(id);\n\tunsigned long flags;\n\tint ret;\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tspin_lock_irqsave(&cfg->ctrl_lock, flags);\n\n\tcfg->ref_cnt--;\n\tif (cfg->ref_cnt == 0)\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   cfg->tuner_en_reg,\n\t\t\t\t   cfg->tuner_en_maskbit << cfg->tuner_en_shift,\n\t\t\t\t   0 << cfg->tuner_en_shift);\n\telse if (cfg->ref_cnt < 0)\n\t\tcfg->ref_cnt = 0;\n\n\tspin_unlock_irqrestore(&cfg->ctrl_lock, flags);\n\n\tret = mt8188_afe_disable_tuner_clk(afe, id);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nint mt8188_afe_get_mclk_source_clk_id(int sel)\n{\n\tswitch (sel) {\n\tcase MT8188_MCK_SEL_26M:\n\t\treturn MT8188_CLK_XTAL_26M;\n\tcase MT8188_MCK_SEL_APLL1:\n\t\treturn MT8188_CLK_APMIXED_APLL1;\n\tcase MT8188_MCK_SEL_APLL2:\n\t\treturn MT8188_CLK_APMIXED_APLL2;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nint mt8188_afe_get_mclk_source_rate(struct mtk_base_afe *afe, int apll)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\tint clk_id = mt8188_afe_get_mclk_source_clk_id(apll);\n\n\tif (clk_id < 0) {\n\t\tdev_dbg(afe->dev, \"invalid clk id\\n\");\n\t\treturn 0;\n\t}\n\n\treturn clk_get_rate(afe_priv->clk[clk_id]);\n}\n\nint mt8188_afe_get_default_mclk_source_by_rate(int rate)\n{\n\treturn ((rate % 8000) == 0) ?\n\t\tMT8188_MCK_SEL_APLL1 : MT8188_MCK_SEL_APLL2;\n}\n\nint mt8188_get_apll_by_rate(struct mtk_base_afe *afe, int rate)\n{\n\treturn ((rate % 8000) == 0) ? MT8188_AUD_PLL1 : MT8188_AUD_PLL2;\n}\n\nint mt8188_get_apll_by_name(struct mtk_base_afe *afe, const char *name)\n{\n\tif (strcmp(name, APLL1_W_NAME) == 0)\n\t\treturn MT8188_AUD_PLL1;\n\n\treturn MT8188_AUD_PLL2;\n}\n\nint mt8188_afe_init_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\tint i, ret;\n\n\tret = mt8188_audsys_clk_register(afe);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"register audsys clk fail %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tafe_priv->clk =\n\t\tdevm_kcalloc(afe->dev, MT8188_CLK_NUM, sizeof(*afe_priv->clk),\n\t\t\t     GFP_KERNEL);\n\tif (!afe_priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < MT8188_CLK_NUM; i++) {\n\t\tafe_priv->clk[i] = devm_clk_get(afe->dev, aud_clks[i]);\n\t\tif (IS_ERR(afe_priv->clk[i])) {\n\t\t\tdev_err(afe->dev, \"%s(), devm_clk_get %s fail, ret %ld\\n\",\n\t\t\t\t__func__, aud_clks[i],\n\t\t\t\tPTR_ERR(afe_priv->clk[i]));\n\t\t\treturn PTR_ERR(afe_priv->clk[i]);\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < MT8188_AUD_PLL_NUM; i++) {\n\t\tret = mt8188_afe_init_apll_tuner(i);\n\t\tif (ret) {\n\t\t\tdev_info(afe->dev, \"%s(), init apll_tuner%d failed\",\n\t\t\t\t __func__, (i + 1));\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint mt8188_afe_enable_clk(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tint ret;\n\n\tif (clk) {\n\t\tret = clk_prepare_enable(clk);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to enable clk\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt8188_afe_enable_clk);\n\nvoid mt8188_afe_disable_clk(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tif (clk)\n\t\tclk_disable_unprepare(clk);\n\telse\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n}\nEXPORT_SYMBOL_GPL(mt8188_afe_disable_clk);\n\nint mt8188_afe_set_clk_rate(struct mtk_base_afe *afe, struct clk *clk,\n\t\t\t    unsigned int rate)\n{\n\tint ret;\n\n\tif (clk) {\n\t\tret = clk_set_rate(clk, rate);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to set clk rate\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint mt8188_afe_set_clk_parent(struct mtk_base_afe *afe, struct clk *clk,\n\t\t\t      struct clk *parent)\n{\n\tint ret;\n\n\tif (clk && parent) {\n\t\tret = clk_set_parent(clk, parent);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to set clk parent %d\\n\",\n\t\t\t\t__func__, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic unsigned int get_top_cg_reg(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8188_TOP_CG_A1SYS_TIMING:\n\tcase MT8188_TOP_CG_A2SYS_TIMING:\n\tcase MT8188_TOP_CG_26M_TIMING:\n\t\treturn ASYS_TOP_CON;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic unsigned int get_top_cg_mask(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8188_TOP_CG_A1SYS_TIMING:\n\t\treturn ASYS_TOP_CON_A1SYS_TIMING_ON;\n\tcase MT8188_TOP_CG_A2SYS_TIMING:\n\t\treturn ASYS_TOP_CON_A2SYS_TIMING_ON;\n\tcase MT8188_TOP_CG_26M_TIMING:\n\t\treturn ASYS_TOP_CON_26M_TIMING_ON;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic unsigned int get_top_cg_on_val(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8188_TOP_CG_A1SYS_TIMING:\n\tcase MT8188_TOP_CG_A2SYS_TIMING:\n\tcase MT8188_TOP_CG_26M_TIMING:\n\t\treturn get_top_cg_mask(cg_type);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic unsigned int get_top_cg_off_val(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8188_TOP_CG_A1SYS_TIMING:\n\tcase MT8188_TOP_CG_A2SYS_TIMING:\n\tcase MT8188_TOP_CG_26M_TIMING:\n\t\treturn 0;\n\tdefault:\n\t\treturn get_top_cg_mask(cg_type);\n\t}\n}\n\nstatic int mt8188_afe_enable_top_cg(struct mtk_base_afe *afe, unsigned int cg_type)\n{\n\tunsigned int reg = get_top_cg_reg(cg_type);\n\tunsigned int mask = get_top_cg_mask(cg_type);\n\tunsigned int val = get_top_cg_on_val(cg_type);\n\n\tregmap_update_bits(afe->regmap, reg, mask, val);\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_disable_top_cg(struct mtk_base_afe *afe, unsigned int cg_type)\n{\n\tunsigned int reg = get_top_cg_reg(cg_type);\n\tunsigned int mask = get_top_cg_mask(cg_type);\n\tunsigned int val = get_top_cg_off_val(cg_type);\n\n\tregmap_update_bits(afe->regmap, reg, mask, val);\n\n\treturn 0;\n}\n\nint mt8188_afe_enable_reg_rw_clk(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\t \n\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_AUDIO_LOCAL_BUS_SEL]);\n\n\t \n\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_AUD_INTBUS_SEL]);\n\n\t \n\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_ADSP_AUDIO_26M]);\n\n\t \n\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_AFE]);\n\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A1SYS_HP]);\n\tmt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A1SYS]);\n\n\treturn 0;\n}\n\nint mt8188_afe_disable_reg_rw_clk(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A1SYS]);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A1SYS_HP]);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_AFE]);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_ADSP_AUDIO_26M]);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_AUD_INTBUS_SEL]);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_AUDIO_LOCAL_BUS_SEL]);\n\n\treturn 0;\n}\n\nstatic int mt8188_afe_enable_afe_on(struct mtk_base_afe *afe)\n{\n\tregmap_update_bits(afe->regmap, AFE_DAC_CON0, 0x1, 0x1);\n\treturn 0;\n}\n\nstatic int mt8188_afe_disable_afe_on(struct mtk_base_afe *afe)\n{\n\tregmap_update_bits(afe->regmap, AFE_DAC_CON0, 0x1, 0x0);\n\treturn 0;\n}\n\nstatic int mt8188_afe_enable_a1sys(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = mt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A1SYS]);\n\tif (ret)\n\t\treturn ret;\n\n\treturn mt8188_afe_enable_top_cg(afe, MT8188_TOP_CG_A1SYS_TIMING);\n}\n\nstatic int mt8188_afe_disable_a1sys(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\tmt8188_afe_disable_top_cg(afe, MT8188_TOP_CG_A1SYS_TIMING);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A1SYS]);\n\treturn 0;\n}\n\nstatic int mt8188_afe_enable_a2sys(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = mt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A2SYS]);\n\tif (ret)\n\t\treturn ret;\n\n\treturn mt8188_afe_enable_top_cg(afe, MT8188_TOP_CG_A2SYS_TIMING);\n}\n\nstatic int mt8188_afe_disable_a2sys(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\tmt8188_afe_disable_top_cg(afe, MT8188_TOP_CG_A2SYS_TIMING);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_AUD_A2SYS]);\n\treturn 0;\n}\n\nint mt8188_apll1_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = mt8188_afe_enable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_APLL1_D4]);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt8188_afe_set_clk_parent(afe, afe_priv->clk[MT8188_CLK_TOP_A1SYS_HP_SEL],\n\t\t\t\t\tafe_priv->clk[MT8188_CLK_TOP_APLL1_D4]);\n\tif (ret)\n\t\tgoto err_clk_parent;\n\n\tret = mt8188_afe_enable_apll_tuner(afe, MT8188_AUD_PLL1);\n\tif (ret)\n\t\tgoto err_apll_tuner;\n\n\tret = mt8188_afe_enable_a1sys(afe);\n\tif (ret)\n\t\tgoto err_a1sys;\n\n\treturn 0;\n\nerr_a1sys:\n\tmt8188_afe_disable_apll_tuner(afe, MT8188_AUD_PLL1);\nerr_apll_tuner:\n\tmt8188_afe_set_clk_parent(afe, afe_priv->clk[MT8188_CLK_TOP_A1SYS_HP_SEL],\n\t\t\t\t  afe_priv->clk[MT8188_CLK_XTAL_26M]);\nerr_clk_parent:\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_APLL1_D4]);\n\n\treturn ret;\n}\n\nint mt8188_apll1_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8188_afe_private *afe_priv = afe->platform_priv;\n\n\tmt8188_afe_disable_a1sys(afe);\n\tmt8188_afe_disable_apll_tuner(afe, MT8188_AUD_PLL1);\n\tmt8188_afe_set_clk_parent(afe, afe_priv->clk[MT8188_CLK_TOP_A1SYS_HP_SEL],\n\t\t\t\t  afe_priv->clk[MT8188_CLK_XTAL_26M]);\n\tmt8188_afe_disable_clk(afe, afe_priv->clk[MT8188_CLK_TOP_APLL1_D4]);\n\n\treturn 0;\n}\n\nint mt8188_apll2_enable(struct mtk_base_afe *afe)\n{\n\tint ret;\n\n\tret = mt8188_afe_enable_apll_tuner(afe, MT8188_AUD_PLL2);\n\tif (ret)\n\t\treturn ret;\n\n\tret =  mt8188_afe_enable_a2sys(afe);\n\tif (ret)\n\t\tgoto err_a2sys;\n\n\treturn 0;\nerr_a2sys:\n\tmt8188_afe_disable_apll_tuner(afe, MT8188_AUD_PLL2);\n\n\treturn ret;\n}\n\nint mt8188_apll2_disable(struct mtk_base_afe *afe)\n{\n\tmt8188_afe_disable_a2sys(afe);\n\tmt8188_afe_disable_apll_tuner(afe, MT8188_AUD_PLL2);\n\treturn 0;\n}\n\nint mt8188_afe_enable_main_clock(struct mtk_base_afe *afe)\n{\n\tmt8188_afe_enable_top_cg(afe, MT8188_TOP_CG_26M_TIMING);\n\tmt8188_afe_enable_afe_on(afe);\n\treturn 0;\n}\n\nint mt8188_afe_disable_main_clock(struct mtk_base_afe *afe)\n{\n\tmt8188_afe_disable_afe_on(afe);\n\tmt8188_afe_disable_top_cg(afe, MT8188_TOP_CG_26M_TIMING);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}