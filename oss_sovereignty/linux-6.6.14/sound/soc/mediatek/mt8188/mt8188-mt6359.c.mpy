{
  "module_name": "mt8188-mt6359.c",
  "hash_id": "01f2f38eb3bc4a59773e69100bfa3a7680b548d2a5cbf2f6e29f03b67162ec9a",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8188/mt8188-mt6359.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/pm_runtime.h>\n#include <sound/jack.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include \"mt8188-afe-common.h\"\n#include \"../../codecs/nau8825.h\"\n#include \"../../codecs/mt6359.h\"\n#include \"../common/mtk-afe-platform-driver.h\"\n#include \"../common/mtk-soundcard-driver.h\"\n\n#define CKSYS_AUD_TOP_CFG\t0x032c\n #define RG_TEST_ON\t\tBIT(0)\n #define RG_TEST_TYPE\t\tBIT(2)\n#define CKSYS_AUD_TOP_MON\t0x0330\n #define TEST_MISO_COUNT_1\tGENMASK(3, 0)\n #define TEST_MISO_COUNT_2\tGENMASK(7, 4)\n #define TEST_MISO_DONE_1\tBIT(28)\n #define TEST_MISO_DONE_2\tBIT(29)\n\n#define NAU8825_HS_PRESENT\tBIT(0)\n\n \n#define MAX98390_CODEC_DAI     \"max98390-aif1\"\n#define MAX98390_DEV0_NAME     \"max98390.0-0038\"  \n#define MAX98390_DEV1_NAME     \"max98390.0-0039\"  \n#define MAX98390_DEV2_NAME     \"max98390.0-003a\"  \n#define MAX98390_DEV3_NAME     \"max98390.0-003b\"  \n\n \n#define NAU8825_CODEC_DAI  \"nau8825-hifi\"\n\n \nSND_SOC_DAILINK_DEFS(playback2,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL2\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback3,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL3\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback6,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL6\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback7,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL7\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback8,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL8\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback10,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL10\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback11,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL11\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture1,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL1\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture2,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL2\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture3,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL3\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture4,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL4\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture5,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL5\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture6,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL6\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture8,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL8\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture9,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL9\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture10,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL10\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\n \nSND_SOC_DAILINK_DEFS(dl_src,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DL_SRC\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_CODEC(\"mt6359-sound\",\n\t\t\t\t\t\t   \"mt6359-snd-codec-aif1\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(dptx,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"DPTX\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(etdm1_in,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"ETDM1_IN\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(etdm2_in,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"ETDM2_IN\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(etdm1_out,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"ETDM1_OUT\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(etdm2_out,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"ETDM2_OUT\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(etdm3_out,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"ETDM3_OUT\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(pcm1,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"PCM1\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_DUMMY()),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(ul_src,\n\t\t     DAILINK_COMP_ARRAY(COMP_CPU(\"UL_SRC\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_CODEC(\"mt6359-sound\",\n\t\t\t\t\t\t   \"mt6359-snd-codec-aif1\"),\n\t\t\t\t\tCOMP_CODEC(\"dmic-codec\",\n\t\t\t\t\t\t   \"dmic-hifi\")),\n\t\t     DAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstruct mt8188_mt6359_priv {\n\tstruct snd_soc_jack dp_jack;\n\tstruct snd_soc_jack hdmi_jack;\n\tstruct snd_soc_jack headset_jack;\n\tvoid *private_data;\n};\n\nstatic struct snd_soc_jack_pin mt8188_hdmi_jack_pins[] = {\n\t{\n\t\t.pin = \"HDMI\",\n\t\t.mask = SND_JACK_LINEOUT,\n\t},\n};\n\nstatic struct snd_soc_jack_pin mt8188_dp_jack_pins[] = {\n\t{\n\t\t.pin = \"DP\",\n\t\t.mask = SND_JACK_LINEOUT,\n\t},\n};\n\nstatic struct snd_soc_jack_pin nau8825_jack_pins[] = {\n\t{\n\t\t.pin    = \"Headphone Jack\",\n\t\t.mask   = SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin    = \"Headset Mic\",\n\t\t.mask   = SND_JACK_MICROPHONE,\n\t},\n};\n\nstruct mt8188_card_data {\n\tconst char *name;\n\tunsigned long quirk;\n};\n\nstatic const struct snd_kcontrol_new mt8188_dumb_spk_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Ext Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget mt8188_dumb_spk_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Ext Spk\", NULL),\n};\n\nstatic const struct snd_kcontrol_new mt8188_dual_spk_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Left Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Right Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget mt8188_dual_spk_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Left Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Right Spk\", NULL),\n};\n\nstatic const struct snd_kcontrol_new mt8188_rear_spk_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Rear Left Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Rear Right Spk\"),\n};\n\nstatic const struct snd_soc_dapm_widget mt8188_rear_spk_widgets[] = {\n\tSND_SOC_DAPM_SPK(\"Rear Left Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Rear Right Spk\", NULL),\n};\n\nstatic const struct snd_soc_dapm_widget mt8188_mt6359_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_SINK(\"HDMI\"),\n\tSND_SOC_DAPM_SINK(\"DP\"),\n\n\t \n\tSND_SOC_DAPM_PINCTRL(\"ETDM_SPK_PIN\", \"aud_etdm_spk_on\", \"aud_etdm_spk_off\"),\n\tSND_SOC_DAPM_PINCTRL(\"ETDM_HP_PIN\", \"aud_etdm_hp_on\", \"aud_etdm_hp_off\"),\n\tSND_SOC_DAPM_PINCTRL(\"MTKAIF_PIN\", \"aud_mtkaif_on\", \"aud_mtkaif_off\"),\n};\n\nstatic const struct snd_kcontrol_new mt8188_mt6359_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n};\n\nstatic const struct snd_soc_dapm_widget mt8188_nau8825_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n};\n\nstatic const struct snd_kcontrol_new mt8188_nau8825_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone Jack\"),\n};\n\nstatic int mt8188_mt6359_mtkaif_calibration(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *cmpnt_afe =\n\t\tsnd_soc_rtdcom_lookup(rtd, AFE_PCM_NAME);\n\tstruct snd_soc_component *cmpnt_codec =\n\t\tasoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_dapm_widget *pin_w = NULL, *w;\n\tstruct mtk_base_afe *afe;\n\tstruct mt8188_afe_private *afe_priv;\n\tstruct mtkaif_param *param;\n\tint chosen_phase_1, chosen_phase_2;\n\tint prev_cycle_1, prev_cycle_2;\n\tu8 test_done_1, test_done_2;\n\tint cycle_1, cycle_2;\n\tint mtkaif_chosen_phase[MT8188_MTKAIF_MISO_NUM];\n\tint mtkaif_phase_cycle[MT8188_MTKAIF_MISO_NUM];\n\tint mtkaif_calibration_num_phase;\n\tbool mtkaif_calibration_ok;\n\tu32 monitor = 0;\n\tint counter;\n\tint phase;\n\tint i;\n\n\tif (!cmpnt_afe)\n\t\treturn -EINVAL;\n\n\tafe = snd_soc_component_get_drvdata(cmpnt_afe);\n\tafe_priv = afe->platform_priv;\n\tparam = &afe_priv->mtkaif_params;\n\n\tdev_dbg(afe->dev, \"%s(), start\\n\", __func__);\n\n\tparam->mtkaif_calibration_ok = false;\n\tfor (i = 0; i < MT8188_MTKAIF_MISO_NUM; i++) {\n\t\tparam->mtkaif_chosen_phase[i] = -1;\n\t\tparam->mtkaif_phase_cycle[i] = 0;\n\t\tmtkaif_chosen_phase[i] = -1;\n\t\tmtkaif_phase_cycle[i] = 0;\n\t}\n\n\tif (IS_ERR(afe_priv->topckgen)) {\n\t\tdev_info(afe->dev, \"%s() Cannot find topckgen controller\\n\",\n\t\t\t __func__);\n\t\treturn 0;\n\t}\n\n\tfor_each_card_widgets(rtd->card, w) {\n\t\tif (!strcmp(w->name, \"MTKAIF_PIN\")) {\n\t\t\tpin_w = w;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (pin_w)\n\t\tdapm_pinctrl_event(pin_w, NULL, SND_SOC_DAPM_PRE_PMU);\n\telse\n\t\tdev_dbg(afe->dev, \"%s(), no pinmux widget, please check if default on\\n\", __func__);\n\n\tpm_runtime_get_sync(afe->dev);\n\tmt6359_mtkaif_calibration_enable(cmpnt_codec);\n\n\t \n\tregmap_write(afe_priv->topckgen, CKSYS_AUD_TOP_CFG, RG_TEST_TYPE);\n\tmtkaif_calibration_num_phase = 42;\t \n\tmtkaif_calibration_ok = true;\n\n\tfor (phase = 0;\n\t     phase <= mtkaif_calibration_num_phase && mtkaif_calibration_ok;\n\t     phase++) {\n\t\tmt6359_set_mtkaif_calibration_phase(cmpnt_codec,\n\t\t\t\t\t\t    phase, phase, phase);\n\n\t\tregmap_set_bits(afe_priv->topckgen, CKSYS_AUD_TOP_CFG, RG_TEST_ON);\n\n\t\ttest_done_1 = 0;\n\t\ttest_done_2 = 0;\n\n\t\tcycle_1 = -1;\n\t\tcycle_2 = -1;\n\n\t\tcounter = 0;\n\t\twhile (!(test_done_1 & test_done_2)) {\n\t\t\tregmap_read(afe_priv->topckgen,\n\t\t\t\t    CKSYS_AUD_TOP_MON, &monitor);\n\t\t\ttest_done_1 = FIELD_GET(TEST_MISO_DONE_1, monitor);\n\t\t\ttest_done_2 = FIELD_GET(TEST_MISO_DONE_2, monitor);\n\n\t\t\tif (test_done_1 == 1)\n\t\t\t\tcycle_1 = FIELD_GET(TEST_MISO_COUNT_1, monitor);\n\n\t\t\tif (test_done_2 == 1)\n\t\t\t\tcycle_2 = FIELD_GET(TEST_MISO_COUNT_2, monitor);\n\n\t\t\t \n\t\t\tif (++counter > 10000) {\n\t\t\t\tdev_err(afe->dev, \"%s(), test fail, cycle_1 %d, cycle_2 %d, monitor 0x%x\\n\",\n\t\t\t\t\t__func__, cycle_1, cycle_2, monitor);\n\t\t\t\tmtkaif_calibration_ok = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (phase == 0) {\n\t\t\tprev_cycle_1 = cycle_1;\n\t\t\tprev_cycle_2 = cycle_2;\n\t\t}\n\n\t\tif (cycle_1 != prev_cycle_1 &&\n\t\t    mtkaif_chosen_phase[MT8188_MTKAIF_MISO_0] < 0) {\n\t\t\tmtkaif_chosen_phase[MT8188_MTKAIF_MISO_0] = phase - 1;\n\t\t\tmtkaif_phase_cycle[MT8188_MTKAIF_MISO_0] = prev_cycle_1;\n\t\t}\n\n\t\tif (cycle_2 != prev_cycle_2 &&\n\t\t    mtkaif_chosen_phase[MT8188_MTKAIF_MISO_1] < 0) {\n\t\t\tmtkaif_chosen_phase[MT8188_MTKAIF_MISO_1] = phase - 1;\n\t\t\tmtkaif_phase_cycle[MT8188_MTKAIF_MISO_1] = prev_cycle_2;\n\t\t}\n\n\t\tregmap_clear_bits(afe_priv->topckgen, CKSYS_AUD_TOP_CFG, RG_TEST_ON);\n\n\t\tif (mtkaif_chosen_phase[MT8188_MTKAIF_MISO_0] >= 0 &&\n\t\t    mtkaif_chosen_phase[MT8188_MTKAIF_MISO_1] >= 0)\n\t\t\tbreak;\n\t}\n\n\tif (mtkaif_chosen_phase[MT8188_MTKAIF_MISO_0] < 0) {\n\t\tmtkaif_calibration_ok = false;\n\t\tchosen_phase_1 = 0;\n\t} else {\n\t\tchosen_phase_1 = mtkaif_chosen_phase[MT8188_MTKAIF_MISO_0];\n\t}\n\n\tif (mtkaif_chosen_phase[MT8188_MTKAIF_MISO_1] < 0) {\n\t\tmtkaif_calibration_ok = false;\n\t\tchosen_phase_2 = 0;\n\t} else {\n\t\tchosen_phase_2 = mtkaif_chosen_phase[MT8188_MTKAIF_MISO_1];\n\t}\n\n\tmt6359_set_mtkaif_calibration_phase(cmpnt_codec,\n\t\t\t\t\t    chosen_phase_1,\n\t\t\t\t\t    chosen_phase_2,\n\t\t\t\t\t    0);\n\n\tmt6359_mtkaif_calibration_disable(cmpnt_codec);\n\tpm_runtime_put(afe->dev);\n\n\tparam->mtkaif_calibration_ok = mtkaif_calibration_ok;\n\tparam->mtkaif_chosen_phase[MT8188_MTKAIF_MISO_0] = chosen_phase_1;\n\tparam->mtkaif_chosen_phase[MT8188_MTKAIF_MISO_1] = chosen_phase_2;\n\n\tfor (i = 0; i < MT8188_MTKAIF_MISO_NUM; i++)\n\t\tparam->mtkaif_phase_cycle[i] = mtkaif_phase_cycle[i];\n\n\tif (pin_w)\n\t\tdapm_pinctrl_event(pin_w, NULL, SND_SOC_DAPM_POST_PMD);\n\n\tdev_dbg(afe->dev, \"%s(), end, calibration ok %d\\n\",\n\t\t__func__, param->mtkaif_calibration_ok);\n\n\treturn 0;\n}\n\nstatic int mt8188_mt6359_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *cmpnt_codec =\n\t\tasoc_rtd_to_codec(rtd, 0)->component;\n\n\t \n\tmt6359_set_mtkaif_protocol(cmpnt_codec,\n\t\t\t\t   MT6359_MTKAIF_PROTOCOL_2_CLK_P2);\n\n\t \n\tmt8188_mt6359_mtkaif_calibration(rtd);\n\n\treturn 0;\n}\n\nenum {\n\tDAI_LINK_DL2_FE,\n\tDAI_LINK_DL3_FE,\n\tDAI_LINK_DL6_FE,\n\tDAI_LINK_DL7_FE,\n\tDAI_LINK_DL8_FE,\n\tDAI_LINK_DL10_FE,\n\tDAI_LINK_DL11_FE,\n\tDAI_LINK_UL1_FE,\n\tDAI_LINK_UL2_FE,\n\tDAI_LINK_UL3_FE,\n\tDAI_LINK_UL4_FE,\n\tDAI_LINK_UL5_FE,\n\tDAI_LINK_UL6_FE,\n\tDAI_LINK_UL8_FE,\n\tDAI_LINK_UL9_FE,\n\tDAI_LINK_UL10_FE,\n\tDAI_LINK_DL_SRC_BE,\n\tDAI_LINK_DPTX_BE,\n\tDAI_LINK_ETDM1_IN_BE,\n\tDAI_LINK_ETDM2_IN_BE,\n\tDAI_LINK_ETDM1_OUT_BE,\n\tDAI_LINK_ETDM2_OUT_BE,\n\tDAI_LINK_ETDM3_OUT_BE,\n\tDAI_LINK_PCM1_BE,\n\tDAI_LINK_UL_SRC_BE,\n};\n\nstatic int mt8188_dptx_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tunsigned int rate = params_rate(params);\n\tunsigned int mclk_fs_ratio = 256;\n\tunsigned int mclk_fs = rate * mclk_fs_ratio;\n\tstruct snd_soc_dai *dai = asoc_rtd_to_cpu(rtd, 0);\n\n\treturn snd_soc_dai_set_sysclk(dai, 0, mclk_fs, SND_SOC_CLOCK_OUT);\n}\n\nstatic const struct snd_soc_ops mt8188_dptx_ops = {\n\t.hw_params = mt8188_dptx_hw_params,\n};\n\nstatic int mt8188_dptx_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t       struct snd_pcm_hw_params *params)\n{\n\t \n\tsnd_mask_reset_range(hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT),\n\t\t\t     0, (__force unsigned int)SNDRV_PCM_FORMAT_LAST);\n\n\tparams_set_format(params, SNDRV_PCM_FORMAT_S32_LE);\n\n\treturn 0;\n}\n\nstatic int mt8188_hdmi_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct mt8188_mt6359_priv *priv = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tint ret = 0;\n\n\tret = snd_soc_card_jack_new_pins(rtd->card, \"HDMI Jack\",\n\t\t\t\t\t SND_JACK_LINEOUT, &priv->hdmi_jack,\n\t\t\t\t\t mt8188_hdmi_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(mt8188_hdmi_jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"%s, new jack failed: %d\\n\", __func__, ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_component_set_jack(component, &priv->hdmi_jack, NULL);\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"%s, set jack failed on %s (ret=%d)\\n\",\n\t\t\t__func__, component->name, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8188_dptx_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct mt8188_mt6359_priv *priv = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tint ret = 0;\n\n\tret = snd_soc_card_jack_new_pins(rtd->card, \"DP Jack\", SND_JACK_LINEOUT,\n\t\t\t\t\t &priv->dp_jack, mt8188_dp_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(mt8188_dp_jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"%s, new jack failed: %d\\n\", __func__, ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_component_set_jack(component, &priv->dp_jack, NULL);\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"%s, set jack failed on %s (ret=%d)\\n\",\n\t\t\t__func__, component->name, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8188_dumb_amp_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret = 0;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, mt8188_dumb_spk_widgets,\n\t\t\t\t\tARRAY_SIZE(mt8188_dumb_spk_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add Dumb Speaker dapm, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, mt8188_dumb_spk_controls,\n\t\t\t\t\tARRAY_SIZE(mt8188_dumb_spk_controls));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add Dumb card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8188_max98390_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tunsigned int bit_width = params_width(params);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai;\n\tint i;\n\n\tsnd_soc_dai_set_tdm_slot(cpu_dai, 0xf, 0xf, 4, bit_width);\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\tif (!strcmp(codec_dai->component->name, MAX98390_DEV0_NAME))\n\t\t\tsnd_soc_dai_set_tdm_slot(codec_dai, 0x8, 0x3, 4, bit_width);\n\n\t\tif (!strcmp(codec_dai->component->name, MAX98390_DEV1_NAME))\n\t\t\tsnd_soc_dai_set_tdm_slot(codec_dai, 0x4, 0x3, 4, bit_width);\n\n\t\tif (!strcmp(codec_dai->component->name, MAX98390_DEV2_NAME))\n\t\t\tsnd_soc_dai_set_tdm_slot(codec_dai, 0x2, 0x3, 4, bit_width);\n\n\t\tif (!strcmp(codec_dai->component->name, MAX98390_DEV3_NAME))\n\t\t\tsnd_soc_dai_set_tdm_slot(codec_dai, 0x1, 0x3, 4, bit_width);\n\t}\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8188_max98390_ops = {\n\t.hw_params = mt8188_max98390_hw_params,\n};\n\nstatic int mt8188_max98390_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tint ret;\n\n\t \n\tret = snd_soc_dapm_new_controls(&card->dapm, mt8188_dual_spk_widgets,\n\t\t\t\t\tARRAY_SIZE(mt8188_dual_spk_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add Left/Right Speaker widget, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, mt8188_dual_spk_controls,\n\t\t\t\t\tARRAY_SIZE(mt8188_dual_spk_controls));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add Left/Right card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (rtd->dai_link->num_codecs <= 2)\n\t\treturn 0;\n\n\t \n\tret = snd_soc_dapm_new_controls(&card->dapm, mt8188_rear_spk_widgets,\n\t\t\t\t\tARRAY_SIZE(mt8188_rear_spk_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add Rear Speaker widget, ret %d\\n\", ret);\n\t\t \n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, mt8188_rear_spk_controls,\n\t\t\t\t\tARRAY_SIZE(mt8188_rear_spk_controls));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add Rear card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8188_nau8825_codec_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct mt8188_mt6359_priv *priv = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\tstruct snd_soc_jack *jack = &priv->headset_jack;\n\tint ret;\n\n\tret = snd_soc_dapm_new_controls(&card->dapm, mt8188_nau8825_widgets,\n\t\t\t\t\tARRAY_SIZE(mt8188_nau8825_widgets));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add nau8825 card widget, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_add_card_controls(card, mt8188_nau8825_controls,\n\t\t\t\t\tARRAY_SIZE(mt8188_nau8825_controls));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"unable to add nau8825 card controls, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = snd_soc_card_jack_new_pins(rtd->card, \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET | SND_JACK_BTN_0 |\n\t\t\t\t\t SND_JACK_BTN_1 | SND_JACK_BTN_2 |\n\t\t\t\t\t SND_JACK_BTN_3,\n\t\t\t\t\t jack,\n\t\t\t\t\t nau8825_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(nau8825_jack_pins));\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack creation failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\tret = snd_soc_component_set_jack(component, jack, NULL);\n\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Headset Jack call-back failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n};\n\nstatic void mt8188_nau8825_codec_exit(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *component = asoc_rtd_to_codec(rtd, 0)->component;\n\n\tsnd_soc_component_set_jack(component, NULL, NULL);\n}\n\nstatic int mt8188_nau8825_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tunsigned int rate = params_rate(params);\n\tunsigned int bit_width = params_width(params);\n\tint clk_freq, ret;\n\n\tclk_freq = rate * 2 * bit_width;\n\n\t \n\tret = snd_soc_dai_set_sysclk(codec_dai, NAU8825_CLK_FLL_BLK, 0,\n\t\t\t\t     SND_SOC_CLOCK_IN);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"can't set BCLK clock %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = snd_soc_dai_set_pll(codec_dai, 0, 0, clk_freq,\n\t\t\t\t  params_rate(params) * 256);\n\tif (ret < 0) {\n\t\tdev_err(codec_dai->dev, \"can't set BCLK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8188_nau8825_ops = {\n\t.hw_params = mt8188_nau8825_hw_params,\n};\nstatic struct snd_soc_dai_link mt8188_mt6359_dai_links[] = {\n\t \n\t[DAI_LINK_DL2_FE] = {\n\t\t.name = \"DL2_FE\",\n\t\t.stream_name = \"DL2 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_merged_chan = 1,\n\t\t.dpcm_merged_rate = 1,\n\t\t.dpcm_merged_format = 1,\n\t\tSND_SOC_DAILINK_REG(playback2),\n\t},\n\t[DAI_LINK_DL3_FE] = {\n\t\t.name = \"DL3_FE\",\n\t\t.stream_name = \"DL3 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_merged_chan = 1,\n\t\t.dpcm_merged_rate = 1,\n\t\t.dpcm_merged_format = 1,\n\t\tSND_SOC_DAILINK_REG(playback3),\n\t},\n\t[DAI_LINK_DL6_FE] = {\n\t\t.name = \"DL6_FE\",\n\t\t.stream_name = \"DL6 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_merged_chan = 1,\n\t\t.dpcm_merged_rate = 1,\n\t\t.dpcm_merged_format = 1,\n\t\tSND_SOC_DAILINK_REG(playback6),\n\t},\n\t[DAI_LINK_DL7_FE] = {\n\t\t.name = \"DL7_FE\",\n\t\t.stream_name = \"DL7 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_PRE,\n\t\t\tSND_SOC_DPCM_TRIGGER_PRE,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback7),\n\t},\n\t[DAI_LINK_DL8_FE] = {\n\t\t.name = \"DL8_FE\",\n\t\t.stream_name = \"DL8 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback8),\n\t},\n\t[DAI_LINK_DL10_FE] = {\n\t\t.name = \"DL10_FE\",\n\t\t.stream_name = \"DL10 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback10),\n\t},\n\t[DAI_LINK_DL11_FE] = {\n\t\t.name = \"DL11_FE\",\n\t\t.stream_name = \"DL11 Playback\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback11),\n\t},\n\t[DAI_LINK_UL1_FE] = {\n\t\t.name = \"UL1_FE\",\n\t\t.stream_name = \"UL1 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_PRE,\n\t\t\tSND_SOC_DPCM_TRIGGER_PRE,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture1),\n\t},\n\t[DAI_LINK_UL2_FE] = {\n\t\t.name = \"UL2_FE\",\n\t\t.stream_name = \"UL2 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture2),\n\t},\n\t[DAI_LINK_UL3_FE] = {\n\t\t.name = \"UL3_FE\",\n\t\t.stream_name = \"UL3 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture3),\n\t},\n\t[DAI_LINK_UL4_FE] = {\n\t\t.name = \"UL4_FE\",\n\t\t.stream_name = \"UL4 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\t.dpcm_merged_chan = 1,\n\t\t.dpcm_merged_rate = 1,\n\t\t.dpcm_merged_format = 1,\n\t\tSND_SOC_DAILINK_REG(capture4),\n\t},\n\t[DAI_LINK_UL5_FE] = {\n\t\t.name = \"UL5_FE\",\n\t\t.stream_name = \"UL5 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\t.dpcm_merged_chan = 1,\n\t\t.dpcm_merged_rate = 1,\n\t\t.dpcm_merged_format = 1,\n\t\tSND_SOC_DAILINK_REG(capture5),\n\t},\n\t[DAI_LINK_UL6_FE] = {\n\t\t.name = \"UL6_FE\",\n\t\t.stream_name = \"UL6 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_PRE,\n\t\t\tSND_SOC_DPCM_TRIGGER_PRE,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture6),\n\t},\n\t[DAI_LINK_UL8_FE] = {\n\t\t.name = \"UL8_FE\",\n\t\t.stream_name = \"UL8 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture8),\n\t},\n\t[DAI_LINK_UL9_FE] = {\n\t\t.name = \"UL9_FE\",\n\t\t.stream_name = \"UL9 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture9),\n\t},\n\t[DAI_LINK_UL10_FE] = {\n\t\t.name = \"UL10_FE\",\n\t\t.stream_name = \"UL10 Capture\",\n\t\t.trigger = {\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t\tSND_SOC_DPCM_TRIGGER_POST,\n\t\t},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture10),\n\t},\n\t \n\t[DAI_LINK_DL_SRC_BE] = {\n\t\t.name = \"DL_SRC_BE\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(dl_src),\n\t},\n\t[DAI_LINK_DPTX_BE] = {\n\t\t.name = \"DPTX_BE\",\n\t\t.ops = &mt8188_dptx_ops,\n\t\t.be_hw_params_fixup = mt8188_dptx_hw_params_fixup,\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(dptx),\n\t},\n\t[DAI_LINK_ETDM1_IN_BE] = {\n\t\t.name = \"ETDM1_IN_BE\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBP_CFP,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(etdm1_in),\n\t},\n\t[DAI_LINK_ETDM2_IN_BE] = {\n\t\t.name = \"ETDM2_IN_BE\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBP_CFP,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(etdm2_in),\n\t},\n\t[DAI_LINK_ETDM1_OUT_BE] = {\n\t\t.name = \"ETDM1_OUT_BE\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBC_CFC,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(etdm1_out),\n\t},\n\t[DAI_LINK_ETDM2_OUT_BE] = {\n\t\t.name = \"ETDM2_OUT_BE\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBC_CFC,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(etdm2_out),\n\t},\n\t[DAI_LINK_ETDM3_OUT_BE] = {\n\t\t.name = \"ETDM3_OUT_BE\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBC_CFC,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(etdm3_out),\n\t},\n\t[DAI_LINK_PCM1_BE] = {\n\t\t.name = \"PCM1_BE\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBC_CFC,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(pcm1),\n\t},\n\t[DAI_LINK_UL_SRC_BE] = {\n\t\t.name = \"UL_SRC_BE\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(ul_src),\n\t},\n};\n\nstatic void mt8188_fixup_controls(struct snd_soc_card *card)\n{\n\tstruct mt8188_mt6359_priv *priv = snd_soc_card_get_drvdata(card);\n\tstruct mt8188_card_data *card_data = (struct mt8188_card_data *)priv->private_data;\n\tstruct snd_kcontrol *kctl;\n\n\tif (card_data->quirk & NAU8825_HS_PRESENT) {\n\t\tstruct snd_soc_dapm_widget *w, *next_w;\n\n\t\tfor_each_card_widgets_safe(card, w, next_w) {\n\t\t\tif (strcmp(w->name, \"Headphone\"))\n\t\t\t\tcontinue;\n\n\t\t\tsnd_soc_dapm_free_widget(w);\n\t\t}\n\n\t\tkctl = snd_ctl_find_id_mixer(card->snd_card, \"Headphone Switch\");\n\t\tif (kctl)\n\t\t\tsnd_ctl_remove(card->snd_card, kctl);\n\t\telse\n\t\t\tdev_warn(card->dev, \"Cannot find ctl : Headphone Switch\\n\");\n\t}\n}\n\nstatic struct snd_soc_card mt8188_mt6359_soc_card = {\n\t.owner = THIS_MODULE,\n\t.dai_link = mt8188_mt6359_dai_links,\n\t.num_links = ARRAY_SIZE(mt8188_mt6359_dai_links),\n\t.dapm_widgets = mt8188_mt6359_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8188_mt6359_widgets),\n\t.controls = mt8188_mt6359_controls,\n\t.num_controls = ARRAY_SIZE(mt8188_mt6359_controls),\n\t.fixup_controls = mt8188_fixup_controls,\n};\n\nstatic int mt8188_mt6359_dev_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &mt8188_mt6359_soc_card;\n\tstruct device_node *platform_node;\n\tstruct mt8188_mt6359_priv *priv;\n\tstruct mt8188_card_data *card_data;\n\tstruct snd_soc_dai_link *dai_link;\n\tbool init_mt6359 = false;\n\tbool init_nau8825 = false;\n\tbool init_max98390 = false;\n\tbool init_dumb = false;\n\tint ret, i;\n\n\tcard_data = (struct mt8188_card_data *)of_device_get_match_data(&pdev->dev);\n\tcard->dev = &pdev->dev;\n\n\tret = snd_soc_of_parse_card_name(card, \"model\");\n\tif (ret)\n\t\treturn dev_err_probe(&pdev->dev, ret, \"%s new card name parsing error\\n\",\n\t\t\t\t     __func__);\n\n\tif (!card->name)\n\t\tcard->name = card_data->name;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn  -ENOMEM;\n\n\tif (of_property_read_bool(pdev->dev.of_node, \"audio-routing\")) {\n\t\tret = snd_soc_of_parse_audio_routing(card, \"audio-routing\");\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tplatform_node = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t\t \"mediatek,platform\", 0);\n\tif (!platform_node) {\n\t\tret = -EINVAL;\n\t\treturn dev_err_probe(&pdev->dev, ret, \"Property 'platform' missing or invalid\\n\");\n\t}\n\n\tret = parse_dai_link_info(card);\n\tif (ret)\n\t\tgoto err;\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (!dai_link->platforms->name)\n\t\t\tdai_link->platforms->of_node = platform_node;\n\n\t\tif (strcmp(dai_link->name, \"DPTX_BE\") == 0) {\n\t\t\tif (strcmp(dai_link->codecs->dai_name, \"snd-soc-dummy-dai\"))\n\t\t\t\tdai_link->init = mt8188_dptx_codec_init;\n\t\t} else if (strcmp(dai_link->name, \"ETDM3_OUT_BE\") == 0) {\n\t\t\tif (strcmp(dai_link->codecs->dai_name, \"snd-soc-dummy-dai\"))\n\t\t\t\tdai_link->init = mt8188_hdmi_codec_init;\n\t\t} else if (strcmp(dai_link->name, \"DL_SRC_BE\") == 0 ||\n\t\t\t   strcmp(dai_link->name, \"UL_SRC_BE\") == 0) {\n\t\t\tif (!init_mt6359) {\n\t\t\t\tdai_link->init = mt8188_mt6359_init;\n\t\t\t\tinit_mt6359 = true;\n\t\t\t}\n\t\t} else if (strcmp(dai_link->name, \"ETDM1_OUT_BE\") == 0 ||\n\t\t\t   strcmp(dai_link->name, \"ETDM2_OUT_BE\") == 0 ||\n\t\t\t   strcmp(dai_link->name, \"ETDM1_IN_BE\") == 0 ||\n\t\t\t   strcmp(dai_link->name, \"ETDM2_IN_BE\") == 0) {\n\t\t\tif (!strcmp(dai_link->codecs->dai_name, MAX98390_CODEC_DAI)) {\n\t\t\t\tdai_link->ops = &mt8188_max98390_ops;\n\t\t\t\tif (!init_max98390) {\n\t\t\t\t\tdai_link->init = mt8188_max98390_codec_init;\n\t\t\t\t\tinit_max98390 = true;\n\t\t\t\t}\n\t\t\t} else if (!strcmp(dai_link->codecs->dai_name, NAU8825_CODEC_DAI)) {\n\t\t\t\tdai_link->ops = &mt8188_nau8825_ops;\n\t\t\t\tif (!init_nau8825) {\n\t\t\t\t\tdai_link->init = mt8188_nau8825_codec_init;\n\t\t\t\t\tdai_link->exit = mt8188_nau8825_codec_exit;\n\t\t\t\t\tinit_nau8825 = true;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (strcmp(dai_link->codecs->dai_name, \"snd-soc-dummy-dai\")) {\n\t\t\t\t\tif (!init_dumb) {\n\t\t\t\t\t\tdai_link->init = mt8188_dumb_amp_init;\n\t\t\t\t\t\tinit_dumb = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tpriv->private_data = card_data;\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret)\n\t\tdev_err_probe(&pdev->dev, ret, \"%s snd_soc_register_card fail\\n\",\n\t\t\t      __func__);\nerr:\n\tof_node_put(platform_node);\n\tclean_card_reference(card);\n\treturn ret;\n}\n\nstatic struct mt8188_card_data mt8188_evb_card = {\n\t.name = \"mt8188_mt6359\",\n};\n\nstatic struct mt8188_card_data mt8188_nau8825_card = {\n\t.name = \"mt8188_nau8825\",\n\t.quirk = NAU8825_HS_PRESENT,\n};\n\nstatic const struct of_device_id mt8188_mt6359_dt_match[] = {\n\t{ .compatible = \"mediatek,mt8188-mt6359-evb\", .data = &mt8188_evb_card, },\n\t{ .compatible = \"mediatek,mt8188-nau8825\", .data = &mt8188_nau8825_card, },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, mt8188_mt6359_dt_match);\n\nstatic struct platform_driver mt8188_mt6359_driver = {\n\t.driver = {\n\t\t.name = \"mt8188_mt6359\",\n\t\t.of_match_table = mt8188_mt6359_dt_match,\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = mt8188_mt6359_dev_probe,\n};\n\nmodule_platform_driver(mt8188_mt6359_driver);\n\n \nMODULE_DESCRIPTION(\"MT8188-MT6359 ALSA SoC machine driver\");\nMODULE_AUTHOR(\"Trevor Wu <trevor.wu@mediatek.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"mt8188 mt6359 soc card\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}