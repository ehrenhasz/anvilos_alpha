{
  "module_name": "mt8195-dai-adda.c",
  "hash_id": "77fe7d700a88e0894c2d9ac4d7eecd940f2d3d6472f32e5cb64b51a72a964a81",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8195/mt8195-dai-adda.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/regmap.h>\n#include \"mt8195-afe-clk.h\"\n#include \"mt8195-afe-common.h\"\n#include \"mt8195-reg.h\"\n\n#define ADDA_DL_GAIN_LOOPBACK 0x1800\n#define ADDA_HIRES_THRES 48000\n\nenum {\n\tSUPPLY_SEQ_CLOCK_SEL,\n\tSUPPLY_SEQ_CLOCK_ON,\n\tSUPPLY_SEQ_ADDA_DL_ON,\n\tSUPPLY_SEQ_ADDA_MTKAIF_CFG,\n\tSUPPLY_SEQ_ADDA_UL_ON,\n\tSUPPLY_SEQ_ADDA_AFE_ON,\n};\n\nenum {\n\tMTK_AFE_ADDA_DL_RATE_8K = 0,\n\tMTK_AFE_ADDA_DL_RATE_11K = 1,\n\tMTK_AFE_ADDA_DL_RATE_12K = 2,\n\tMTK_AFE_ADDA_DL_RATE_16K = 3,\n\tMTK_AFE_ADDA_DL_RATE_22K = 4,\n\tMTK_AFE_ADDA_DL_RATE_24K = 5,\n\tMTK_AFE_ADDA_DL_RATE_32K = 6,\n\tMTK_AFE_ADDA_DL_RATE_44K = 7,\n\tMTK_AFE_ADDA_DL_RATE_48K = 8,\n\tMTK_AFE_ADDA_DL_RATE_96K = 9,\n\tMTK_AFE_ADDA_DL_RATE_192K = 10,\n};\n\nenum {\n\tMTK_AFE_ADDA_UL_RATE_8K = 0,\n\tMTK_AFE_ADDA_UL_RATE_16K = 1,\n\tMTK_AFE_ADDA_UL_RATE_32K = 2,\n\tMTK_AFE_ADDA_UL_RATE_48K = 3,\n\tMTK_AFE_ADDA_UL_RATE_96K = 4,\n\tMTK_AFE_ADDA_UL_RATE_192K = 5,\n};\n\nenum {\n\tDELAY_DATA_MISO1 = 0,\n\tDELAY_DATA_MISO0 = 1,\n\tDELAY_DATA_MISO2 = 1,\n};\n\nenum {\n\tMTK_AFE_ADDA,\n\tMTK_AFE_ADDA6,\n};\n\nstruct mtk_dai_adda_priv {\n\tbool hires_required;\n};\n\nstatic unsigned int afe_adda_dl_rate_transform(struct mtk_base_afe *afe,\n\t\t\t\t\t       unsigned int rate)\n{\n\tswitch (rate) {\n\tcase 8000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_8K;\n\tcase 11025:\n\t\treturn MTK_AFE_ADDA_DL_RATE_11K;\n\tcase 12000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_12K;\n\tcase 16000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_16K;\n\tcase 22050:\n\t\treturn MTK_AFE_ADDA_DL_RATE_22K;\n\tcase 24000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_24K;\n\tcase 32000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_32K;\n\tcase 44100:\n\t\treturn MTK_AFE_ADDA_DL_RATE_44K;\n\tcase 48000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_48K;\n\tcase 96000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_96K;\n\tcase 192000:\n\t\treturn MTK_AFE_ADDA_DL_RATE_192K;\n\tdefault:\n\t\tdev_info(afe->dev, \"%s(), rate %d invalid, use 48kHz!!!\\n\",\n\t\t\t __func__, rate);\n\t\treturn MTK_AFE_ADDA_DL_RATE_48K;\n\t}\n}\n\nstatic unsigned int afe_adda_ul_rate_transform(struct mtk_base_afe *afe,\n\t\t\t\t\t       unsigned int rate)\n{\n\tswitch (rate) {\n\tcase 8000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_8K;\n\tcase 16000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_16K;\n\tcase 32000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_32K;\n\tcase 48000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_48K;\n\tcase 96000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_96K;\n\tcase 192000:\n\t\treturn MTK_AFE_ADDA_UL_RATE_192K;\n\tdefault:\n\t\tdev_info(afe->dev, \"%s(), rate %d invalid, use 48kHz!!!\\n\",\n\t\t\t __func__, rate);\n\t\treturn MTK_AFE_ADDA_UL_RATE_48K;\n\t}\n}\n\nstatic int mt8195_adda_mtkaif_init(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\tint delay_data;\n\tint delay_cycle;\n\tunsigned int mask = 0;\n\tunsigned int val = 0;\n\n\t \n\tmask = (MTKAIF_RXIF_CLKINV_ADC | MTKAIF_RXIF_PROTOCOL2);\n\tval = (MTKAIF_RXIF_CLKINV_ADC | MTKAIF_RXIF_PROTOCOL2);\n\n\tregmap_update_bits(afe->regmap, AFE_ADDA_MTKAIF_CFG0, mask, val);\n\tregmap_update_bits(afe->regmap, AFE_ADDA6_MTKAIF_CFG0, mask, val);\n\n\tmask = RG_RX_PROTOCOL2;\n\tval = RG_RX_PROTOCOL2;\n\tregmap_update_bits(afe->regmap, AFE_AUD_PAD_TOP, mask, val);\n\n\tif (!param->mtkaif_calibration_ok) {\n\t\tdev_info(afe->dev, \"%s(), calibration fail\\n\",  __func__);\n\t\treturn 0;\n\t}\n\n\t \n\tif (param->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_0] >=\n\t    param->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_1]) {\n\t\tdelay_data = DELAY_DATA_MISO1;\n\t\tdelay_cycle =\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_0] -\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_1];\n\t} else {\n\t\tdelay_data = DELAY_DATA_MISO0;\n\t\tdelay_cycle =\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_1] -\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_0];\n\t}\n\n\tval = 0;\n\tmask = (MTKAIF_RXIF_DELAY_DATA | MTKAIF_RXIF_DELAY_CYCLE_MASK);\n\tval |= MTKAIF_RXIF_DELAY_CYCLE(delay_cycle) &\n\t       MTKAIF_RXIF_DELAY_CYCLE_MASK;\n\tval |= delay_data << MTKAIF_RXIF_DELAY_DATA_SHIFT;\n\tregmap_update_bits(afe->regmap, AFE_ADDA_MTKAIF_RX_CFG2, mask, val);\n\n\t \n\tif (param->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_2] >=\n\t    param->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_1]) {\n\t\tdelay_data = DELAY_DATA_MISO1;\n\t\tdelay_cycle =\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_2] -\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_1];\n\t} else {\n\t\tdelay_data = DELAY_DATA_MISO2;\n\t\tdelay_cycle =\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_1] -\n\t\t\tparam->mtkaif_phase_cycle[MT8195_MTKAIF_MISO_2];\n\t}\n\n\tval = 0;\n\tmask = (MTKAIF_RXIF_DELAY_DATA | MTKAIF_RXIF_DELAY_CYCLE_MASK);\n\tval |= MTKAIF_RXIF_DELAY_CYCLE(delay_cycle) &\n\t       MTKAIF_RXIF_DELAY_CYCLE_MASK;\n\tval |= delay_data << MTKAIF_RXIF_DELAY_DATA_SHIFT;\n\tregmap_update_bits(afe->regmap, AFE_ADDA6_MTKAIF_RX_CFG2, mask, val);\n\n\treturn 0;\n}\n\nstatic int mtk_adda_mtkaif_cfg_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(afe->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tmt8195_adda_mtkaif_init(afe);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_adda_dl_event(struct snd_soc_dapm_widget *w,\n\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\n\tdev_dbg(afe->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tusleep_range(125, 135);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void mtk_adda_ul_mictype(struct mtk_base_afe *afe, int adda, bool dmic)\n{\n\tunsigned int reg = 0;\n\tunsigned int mask = 0;\n\tunsigned int val = 0;\n\n\tswitch (adda) {\n\tcase MTK_AFE_ADDA:\n\t\treg = AFE_ADDA_UL_SRC_CON0;\n\t\tbreak;\n\tcase MTK_AFE_ADDA6:\n\t\treg = AFE_ADDA6_UL_SRC_CON0;\n\t\tbreak;\n\tdefault:\n\t\tdev_info(afe->dev, \"%s(), wrong parameter\\n\",  __func__);\n\t\treturn;\n\t}\n\n\tmask = (UL_SDM3_LEVEL_CTL | UL_MODE_3P25M_CH1_CTL |\n\t\tUL_MODE_3P25M_CH2_CTL);\n\n\t \n\tif (dmic)\n\t\tval = mask;\n\n\tregmap_update_bits(afe->regmap, reg, mask, val);\n}\n\nstatic int mtk_adda_ul_event(struct snd_soc_dapm_widget *w,\n\t\t\t     struct snd_kcontrol *kcontrol,\n\t\t\t     int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\n\tdev_dbg(afe->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tmtk_adda_ul_mictype(afe, MTK_AFE_ADDA, param->mtkaif_dmic_on);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tusleep_range(125, 135);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_adda6_ul_event(struct snd_soc_dapm_widget *w,\n\t\t\t      struct snd_kcontrol *kcontrol,\n\t\t\t      int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\tunsigned int val;\n\n\tdev_dbg(afe->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tmtk_adda_ul_mictype(afe, MTK_AFE_ADDA6, param->mtkaif_dmic_on);\n\n\t\tval = (param->mtkaif_adda6_only ?\n\t\t\tADDA6_MTKAIF_RX_SYNC_WORD2_DISABLE : 0);\n\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   AFE_ADDA_MTKAIF_SYNCWORD_CFG,\n\t\t\t\t   ADDA6_MTKAIF_RX_SYNC_WORD2_DISABLE,\n\t\t\t\t   val);\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\t \n\t\tusleep_range(125, 135);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mtk_audio_hires_event(struct snd_soc_dapm_widget *w,\n\t\t\t\t struct snd_kcontrol *kcontrol,\n\t\t\t\t int event)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct clk *clk = afe_priv->clk[MT8195_CLK_TOP_AUDIO_H_SEL];\n\tstruct clk *clk_parent;\n\n\tdev_dbg(afe->dev, \"%s(), name %s, event 0x%x\\n\",\n\t\t__func__, w->name, event);\n\n\tswitch (event) {\n\tcase SND_SOC_DAPM_PRE_PMU:\n\t\tclk_parent = afe_priv->clk[MT8195_CLK_TOP_APLL1];\n\t\tbreak;\n\tcase SND_SOC_DAPM_POST_PMD:\n\t\tclk_parent = afe_priv->clk[MT8195_CLK_XTAL_26M];\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\tmt8195_afe_set_clk_parent(afe, clk, clk_parent);\n\n\treturn 0;\n}\n\nstatic struct mtk_dai_adda_priv *get_adda_priv_by_name(struct mtk_base_afe *afe,\n\t\t\t\t\t\t       const char *name)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint dai_id;\n\n\tif (strstr(name, \"aud_adc_hires\"))\n\t\tdai_id = MT8195_AFE_IO_UL_SRC1;\n\telse if (strstr(name, \"aud_adda6_adc_hires\"))\n\t\tdai_id = MT8195_AFE_IO_UL_SRC2;\n\telse if (strstr(name, \"aud_dac_hires\"))\n\t\tdai_id = MT8195_AFE_IO_DL_SRC;\n\telse\n\t\treturn NULL;\n\n\treturn afe_priv->dai_priv[dai_id];\n}\n\nstatic int mtk_afe_adda_hires_connect(struct snd_soc_dapm_widget *source,\n\t\t\t\t      struct snd_soc_dapm_widget *sink)\n{\n\tstruct snd_soc_dapm_widget *w = source;\n\tstruct snd_soc_component *cmpnt = snd_soc_dapm_to_component(w->dapm);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mtk_dai_adda_priv *adda_priv;\n\n\tadda_priv = get_adda_priv_by_name(afe, w->name);\n\n\tif (!adda_priv) {\n\t\tdev_info(afe->dev, \"adda_priv == NULL\");\n\t\treturn 0;\n\t}\n\n\treturn (adda_priv->hires_required) ? 1 : 0;\n}\n\nstatic const struct snd_kcontrol_new mtk_dai_adda_o176_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I000 Switch\", AFE_CONN176, 0, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I002 Switch\", AFE_CONN176, 2, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I020 Switch\", AFE_CONN176, 20, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I022 Switch\", AFE_CONN176, 22, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I070 Switch\", AFE_CONN176_2, 6, 1, 0),\n};\n\nstatic const struct snd_kcontrol_new mtk_dai_adda_o177_mix[] = {\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I001 Switch\", AFE_CONN177, 1, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I003 Switch\", AFE_CONN177, 3, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I021 Switch\", AFE_CONN177, 21, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I023 Switch\", AFE_CONN177, 23, 1, 0),\n\tSOC_DAPM_SINGLE_AUTODISABLE(\"I071 Switch\", AFE_CONN177_2, 7, 1, 0),\n};\n\nstatic const char * const adda_dlgain_mux_map[] = {\n\t\"Bypass\", \"Connect\",\n};\n\nstatic SOC_ENUM_SINGLE_DECL(adda_dlgain_mux_map_enum,\n\t\t\t    SND_SOC_NOPM, 0,\n\t\t\t    adda_dlgain_mux_map);\n\nstatic const struct snd_kcontrol_new adda_dlgain_mux_control =\n\tSOC_DAPM_ENUM(\"DL_GAIN_MUX\", adda_dlgain_mux_map_enum);\n\nstatic const struct snd_soc_dapm_widget mtk_dai_adda_widgets[] = {\n\tSND_SOC_DAPM_MIXER(\"I168\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I169\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I170\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\tSND_SOC_DAPM_MIXER(\"I171\", SND_SOC_NOPM, 0, 0, NULL, 0),\n\n\tSND_SOC_DAPM_MIXER(\"O176\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_dai_adda_o176_mix,\n\t\t\t   ARRAY_SIZE(mtk_dai_adda_o176_mix)),\n\tSND_SOC_DAPM_MIXER(\"O177\", SND_SOC_NOPM, 0, 0,\n\t\t\t   mtk_dai_adda_o177_mix,\n\t\t\t   ARRAY_SIZE(mtk_dai_adda_o177_mix)),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA Enable\", SUPPLY_SEQ_ADDA_AFE_ON,\n\t\t\t      AFE_ADDA_UL_DL_CON0,\n\t\t\t      ADDA_AFE_ON_SHIFT, 0,\n\t\t\t      NULL,\n\t\t\t      0),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA Playback Enable\", SUPPLY_SEQ_ADDA_DL_ON,\n\t\t\t      AFE_ADDA_DL_SRC2_CON0,\n\t\t\t      DL_2_SRC_ON_TMP_CTRL_PRE_SHIFT, 0,\n\t\t\t      mtk_adda_dl_event,\n\t\t\t      SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA Capture Enable\", SUPPLY_SEQ_ADDA_UL_ON,\n\t\t\t      AFE_ADDA_UL_SRC_CON0,\n\t\t\t      UL_SRC_ON_TMP_CTL_SHIFT, 0,\n\t\t\t      mtk_adda_ul_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA6 Capture Enable\", SUPPLY_SEQ_ADDA_UL_ON,\n\t\t\t      AFE_ADDA6_UL_SRC_CON0,\n\t\t\t      UL_SRC_ON_TMP_CTL_SHIFT, 0,\n\t\t\t      mtk_adda6_ul_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"AUDIO_HIRES\", SUPPLY_SEQ_CLOCK_SEL,\n\t\t\t      SND_SOC_NOPM,\n\t\t\t      0, 0,\n\t\t\t      mtk_audio_hires_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD),\n\n\tSND_SOC_DAPM_SUPPLY_S(\"ADDA_MTKAIF_CFG\", SUPPLY_SEQ_ADDA_MTKAIF_CFG,\n\t\t\t      SND_SOC_NOPM,\n\t\t\t      0, 0,\n\t\t\t      mtk_adda_mtkaif_cfg_event,\n\t\t\t      SND_SOC_DAPM_PRE_PMU),\n\n\tSND_SOC_DAPM_MUX(\"DL_GAIN_MUX\", SND_SOC_NOPM, 0, 0,\n\t\t\t &adda_dlgain_mux_control),\n\n\tSND_SOC_DAPM_PGA(\"DL_GAIN\", AFE_ADDA_DL_SRC2_CON0,\n\t\t\t DL_2_GAIN_ON_CTL_PRE_SHIFT, 0, NULL, 0),\n\n\tSND_SOC_DAPM_INPUT(\"ADDA_INPUT\"),\n\tSND_SOC_DAPM_OUTPUT(\"ADDA_OUTPUT\"),\n\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"aud_dac\"),\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"aud_adc\"),\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"aud_adda6_adc\"),\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"aud_dac_hires\"),\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"aud_adc_hires\"),\n\tSND_SOC_DAPM_CLOCK_SUPPLY(\"aud_adda6_adc_hires\"),\n};\n\nstatic const struct snd_soc_dapm_route mtk_dai_adda_routes[] = {\n\t{\"ADDA Capture\", NULL, \"ADDA Enable\"},\n\t{\"ADDA Capture\", NULL, \"ADDA Capture Enable\"},\n\t{\"ADDA Capture\", NULL, \"ADDA_MTKAIF_CFG\"},\n\t{\"ADDA Capture\", NULL, \"aud_adc\"},\n\t{\"ADDA Capture\", NULL, \"aud_adc_hires\", mtk_afe_adda_hires_connect},\n\t{\"aud_adc_hires\", NULL, \"AUDIO_HIRES\"},\n\n\t{\"ADDA6 Capture\", NULL, \"ADDA Enable\"},\n\t{\"ADDA6 Capture\", NULL, \"ADDA6 Capture Enable\"},\n\t{\"ADDA6 Capture\", NULL, \"ADDA_MTKAIF_CFG\"},\n\t{\"ADDA6 Capture\", NULL, \"aud_adda6_adc\"},\n\t{\"ADDA6 Capture\", NULL, \"aud_adda6_adc_hires\",\n\tmtk_afe_adda_hires_connect},\n\t{\"aud_adda6_adc_hires\", NULL, \"AUDIO_HIRES\"},\n\n\t{\"I168\", NULL, \"ADDA Capture\"},\n\t{\"I169\", NULL, \"ADDA Capture\"},\n\t{\"I170\", NULL, \"ADDA6 Capture\"},\n\t{\"I171\", NULL, \"ADDA6 Capture\"},\n\n\t{\"ADDA Playback\", NULL, \"ADDA Enable\"},\n\t{\"ADDA Playback\", NULL, \"ADDA Playback Enable\"},\n\t{\"ADDA Playback\", NULL, \"aud_dac\"},\n\t{\"ADDA Playback\", NULL, \"aud_dac_hires\", mtk_afe_adda_hires_connect},\n\t{\"aud_dac_hires\", NULL, \"AUDIO_HIRES\"},\n\n\t{\"DL_GAIN\", NULL, \"O176\"},\n\t{\"DL_GAIN\", NULL, \"O177\"},\n\n\t{\"DL_GAIN_MUX\", \"Bypass\", \"O176\"},\n\t{\"DL_GAIN_MUX\", \"Bypass\", \"O177\"},\n\t{\"DL_GAIN_MUX\", \"Connect\", \"DL_GAIN\"},\n\n\t{\"ADDA Playback\", NULL, \"DL_GAIN_MUX\"},\n\n\t{\"O176\", \"I000 Switch\", \"I000\"},\n\t{\"O177\", \"I001 Switch\", \"I001\"},\n\n\t{\"O176\", \"I002 Switch\", \"I002\"},\n\t{\"O177\", \"I003 Switch\", \"I003\"},\n\n\t{\"O176\", \"I020 Switch\", \"I020\"},\n\t{\"O177\", \"I021 Switch\", \"I021\"},\n\n\t{\"O176\", \"I022 Switch\", \"I022\"},\n\t{\"O177\", \"I023 Switch\", \"I023\"},\n\n\t{\"O176\", \"I070 Switch\", \"I070\"},\n\t{\"O177\", \"I071 Switch\", \"I071\"},\n\n\t{\"ADDA Capture\", NULL, \"ADDA_INPUT\"},\n\t{\"ADDA6 Capture\", NULL, \"ADDA_INPUT\"},\n\t{\"ADDA_OUTPUT\", NULL, \"ADDA Playback\"},\n};\n\nstatic int mt8195_adda_dl_gain_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\tunsigned int reg = AFE_ADDA_DL_SRC2_CON1;\n\tunsigned int mask = DL_2_GAIN_CTL_PRE_MASK;\n\tunsigned int value = (unsigned int)(ucontrol->value.integer.value[0]);\n\n\tregmap_update_bits(afe->regmap, reg, mask, DL_2_GAIN_CTL_PRE(value));\n\treturn 0;\n}\n\nstatic int mt8195_adda_dl_gain_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(component);\n\tunsigned int reg = AFE_ADDA_DL_SRC2_CON1;\n\tunsigned int mask = DL_2_GAIN_CTL_PRE_MASK;\n\tunsigned int value = 0;\n\n\tregmap_read(afe->regmap, reg, &value);\n\n\tucontrol->value.integer.value[0] = ((value & mask) >>\n\t\t\t\t\t    DL_2_GAIN_CTL_PRE_SHIFT);\n\treturn 0;\n}\n\nstatic int mt8195_adda6_only_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\n\tucontrol->value.integer.value[0] = param->mtkaif_adda6_only;\n\treturn 0;\n}\n\nstatic int mt8195_adda6_only_set(struct snd_kcontrol *kcontrol,\n\t\t\t\t struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\tint mtkaif_adda6_only;\n\n\tmtkaif_adda6_only = ucontrol->value.integer.value[0];\n\n\tdev_info(afe->dev, \"%s(), kcontrol name %s, mtkaif_adda6_only %d\\n\",\n\t\t __func__, kcontrol->id.name, mtkaif_adda6_only);\n\n\tparam->mtkaif_adda6_only = mtkaif_adda6_only;\n\n\treturn 0;\n}\n\nstatic int mt8195_adda_dmic_get(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\n\tucontrol->value.integer.value[0] = param->mtkaif_dmic_on;\n\treturn 0;\n}\n\nstatic int mt8195_adda_dmic_set(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtkaif_param *param = &afe_priv->mtkaif_params;\n\tint dmic_on;\n\n\tdmic_on = ucontrol->value.integer.value[0];\n\n\tdev_dbg(afe->dev, \"%s(), kcontrol name %s, dmic_on %d\\n\",\n\t\t__func__, kcontrol->id.name, dmic_on);\n\n\tparam->mtkaif_dmic_on = dmic_on;\n\treturn 0;\n}\n\nstatic const struct snd_kcontrol_new mtk_dai_adda_controls[] = {\n\tSOC_SINGLE_EXT(\"ADDA_DL_Gain\", SND_SOC_NOPM, 0, 65535, 0,\n\t\t       mt8195_adda_dl_gain_get, mt8195_adda_dl_gain_put),\n\tSOC_SINGLE_BOOL_EXT(\"MTKAIF_DMIC\", 0,\n\t\t\t    mt8195_adda_dmic_get, mt8195_adda_dmic_set),\n\tSOC_SINGLE_BOOL_EXT(\"MTKAIF_ADDA6_ONLY\", 0,\n\t\t\t    mt8195_adda6_only_get,\n\t\t\t    mt8195_adda6_only_set),\n};\n\nstatic int mtk_dai_da_configure(struct mtk_base_afe *afe,\n\t\t\t\tunsigned int rate, int id)\n{\n\tunsigned int val = 0;\n\tunsigned int mask = 0;\n\n\t \n\tmask |= DL_2_INPUT_MODE_CTL_MASK;\n\tval |= DL_2_INPUT_MODE_CTL(afe_adda_dl_rate_transform(afe, rate));\n\n\t \n\tmask |= DL_2_CH1_SATURATION_EN_CTL;\n\tmask |= DL_2_CH2_SATURATION_EN_CTL;\n\n\t \n\tmask |= DL_2_MUTE_CH1_OFF_CTL_PRE;\n\tmask |= DL_2_MUTE_CH2_OFF_CTL_PRE;\n\tval |= DL_2_MUTE_CH1_OFF_CTL_PRE;\n\tval |= DL_2_MUTE_CH2_OFF_CTL_PRE;\n\n\t \n\tmask |= DL_2_VOICE_MODE_CTL_PRE;\n\tif (rate == 8000 || rate == 16000)\n\t\tval |= DL_2_VOICE_MODE_CTL_PRE;\n\n\tregmap_update_bits(afe->regmap, AFE_ADDA_DL_SRC2_CON0, mask, val);\n\n\tmask = 0;\n\tval = 0;\n\n\t \n\tmask |= DL_USE_NEW_2ND_SDM;\n\tval |= DL_USE_NEW_2ND_SDM;\n\tregmap_update_bits(afe->regmap, AFE_ADDA_DL_SDM_DCCOMP_CON, mask, val);\n\n\treturn 0;\n}\n\nstatic int mtk_dai_ad_configure(struct mtk_base_afe *afe,\n\t\t\t\tunsigned int rate, int id)\n{\n\tunsigned int val = 0;\n\tunsigned int mask = 0;\n\n\tmask |= UL_VOICE_MODE_CTL_MASK;\n\tval |= UL_VOICE_MODE_CTL(afe_adda_ul_rate_transform(afe, rate));\n\n\tswitch (id) {\n\tcase MT8195_AFE_IO_UL_SRC1:\n\t\tregmap_update_bits(afe->regmap, AFE_ADDA_UL_SRC_CON0,\n\t\t\t\t   mask, val);\n\t\tbreak;\n\tcase MT8195_AFE_IO_UL_SRC2:\n\t\tregmap_update_bits(afe->regmap, AFE_ADDA6_UL_SRC_CON0,\n\t\t\t\t   mask, val);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int mtk_dai_adda_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t  struct snd_pcm_hw_params *params,\n\t\t\t\t  struct snd_soc_dai *dai)\n{\n\tstruct mtk_base_afe *afe = snd_soc_dai_get_drvdata(dai);\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_dai_adda_priv *adda_priv;\n\tunsigned int rate = params_rate(params);\n\tint ret;\n\n\tif (dai->id != MT8195_AFE_IO_DL_SRC &&\n\t    dai->id != MT8195_AFE_IO_UL_SRC1 &&\n\t    dai->id != MT8195_AFE_IO_UL_SRC2)\n\t\treturn -EINVAL;\n\tadda_priv = afe_priv->dai_priv[dai->id];\n\n\tdev_dbg(afe->dev, \"%s(), id %d, stream %d, rate %d\\n\",\n\t\t__func__, dai->id, substream->stream, rate);\n\n\tif (rate > ADDA_HIRES_THRES)\n\t\tadda_priv->hires_required = 1;\n\telse\n\t\tadda_priv->hires_required = 0;\n\n\tif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\n\t\tret = mtk_dai_da_configure(afe, rate, dai->id);\n\telse\n\t\tret = mtk_dai_ad_configure(afe, rate, dai->id);\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_dai_ops mtk_dai_adda_ops = {\n\t.hw_params = mtk_dai_adda_hw_params,\n};\n\n \n#define MTK_ADDA_PLAYBACK_RATES (SNDRV_PCM_RATE_8000_48000 |\\\n\t\t\t\t SNDRV_PCM_RATE_96000 |\\\n\t\t\t\t SNDRV_PCM_RATE_192000)\n\n#define MTK_ADDA_CAPTURE_RATES (SNDRV_PCM_RATE_8000 |\\\n\t\t\t\tSNDRV_PCM_RATE_16000 |\\\n\t\t\t\tSNDRV_PCM_RATE_32000 |\\\n\t\t\t\tSNDRV_PCM_RATE_48000 |\\\n\t\t\t\tSNDRV_PCM_RATE_96000 |\\\n\t\t\t\tSNDRV_PCM_RATE_192000)\n\n#define MTK_ADDA_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\\\n\t\t\t  SNDRV_PCM_FMTBIT_S24_LE |\\\n\t\t\t  SNDRV_PCM_FMTBIT_S32_LE)\n\nstatic struct snd_soc_dai_driver mtk_dai_adda_driver[] = {\n\t{\n\t\t.name = \"DL_SRC\",\n\t\t.id = MT8195_AFE_IO_DL_SRC,\n\t\t.playback = {\n\t\t\t.stream_name = \"ADDA Playback\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_ADDA_PLAYBACK_RATES,\n\t\t\t.formats = MTK_ADDA_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_adda_ops,\n\t},\n\t{\n\t\t.name = \"UL_SRC1\",\n\t\t.id = MT8195_AFE_IO_UL_SRC1,\n\t\t.capture = {\n\t\t\t.stream_name = \"ADDA Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_ADDA_CAPTURE_RATES,\n\t\t\t.formats = MTK_ADDA_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_adda_ops,\n\t},\n\t{\n\t\t.name = \"UL_SRC2\",\n\t\t.id = MT8195_AFE_IO_UL_SRC2,\n\t\t.capture = {\n\t\t\t.stream_name = \"ADDA6 Capture\",\n\t\t\t.channels_min = 1,\n\t\t\t.channels_max = 2,\n\t\t\t.rates = MTK_ADDA_CAPTURE_RATES,\n\t\t\t.formats = MTK_ADDA_FORMATS,\n\t\t},\n\t\t.ops = &mtk_dai_adda_ops,\n\t},\n};\n\nstatic int init_adda_priv_data(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct mtk_dai_adda_priv *adda_priv;\n\tstatic const int adda_dai_list[] = {\n\t\tMT8195_AFE_IO_DL_SRC,\n\t\tMT8195_AFE_IO_UL_SRC1,\n\t\tMT8195_AFE_IO_UL_SRC2\n\t};\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(adda_dai_list); i++) {\n\t\tadda_priv = devm_kzalloc(afe->dev,\n\t\t\t\t\t sizeof(struct mtk_dai_adda_priv),\n\t\t\t\t\t GFP_KERNEL);\n\t\tif (!adda_priv)\n\t\t\treturn -ENOMEM;\n\n\t\tafe_priv->dai_priv[adda_dai_list[i]] = adda_priv;\n\t}\n\n\treturn 0;\n}\n\nint mt8195_dai_adda_register(struct mtk_base_afe *afe)\n{\n\tstruct mtk_base_afe_dai *dai;\n\n\tdai = devm_kzalloc(afe->dev, sizeof(*dai), GFP_KERNEL);\n\tif (!dai)\n\t\treturn -ENOMEM;\n\n\tlist_add(&dai->list, &afe->sub_dais);\n\n\tdai->dai_drivers = mtk_dai_adda_driver;\n\tdai->num_dai_drivers = ARRAY_SIZE(mtk_dai_adda_driver);\n\n\tdai->dapm_widgets = mtk_dai_adda_widgets;\n\tdai->num_dapm_widgets = ARRAY_SIZE(mtk_dai_adda_widgets);\n\tdai->dapm_routes = mtk_dai_adda_routes;\n\tdai->num_dapm_routes = ARRAY_SIZE(mtk_dai_adda_routes);\n\tdai->controls = mtk_dai_adda_controls;\n\tdai->num_controls = ARRAY_SIZE(mtk_dai_adda_controls);\n\n\treturn init_adda_priv_data(afe);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}