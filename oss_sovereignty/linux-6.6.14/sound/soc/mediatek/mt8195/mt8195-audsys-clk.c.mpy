{
  "module_name": "mt8195-audsys-clk.c",
  "hash_id": "8406b74dd50f4a7c9c00e1f7570c5dd78f53fce795e9132226f604b5b83655eb",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8195/mt8195-audsys-clk.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/clkdev.h>\n#include \"mt8195-afe-common.h\"\n#include \"mt8195-audsys-clk.h\"\n#include \"mt8195-audsys-clkid.h\"\n#include \"mt8195-reg.h\"\n\nstruct afe_gate {\n\tint id;\n\tconst char *name;\n\tconst char *parent_name;\n\tint reg;\n\tu8 bit;\n\tconst struct clk_ops *ops;\n\tunsigned long flags;\n\tu8 cg_flags;\n};\n\n#define GATE_AFE_FLAGS(_id, _name, _parent, _reg, _bit, _flags, _cgflags) {\\\n\t\t.id = _id,\t\t\t\t\t\\\n\t\t.name = _name,\t\t\t\t\t\\\n\t\t.parent_name = _parent,\t\t\t\t\\\n\t\t.reg = _reg,\t\t\t\t\t\\\n\t\t.bit = _bit,\t\t\t\t\t\\\n\t\t.flags = _flags,\t\t\t\t\\\n\t\t.cg_flags = _cgflags,\t\t\t\t\\\n\t}\n\n#define GATE_AFE(_id, _name, _parent, _reg, _bit)\t\t\\\n\tGATE_AFE_FLAGS(_id, _name, _parent, _reg, _bit,\t\t\\\n\t\t       CLK_SET_RATE_PARENT, CLK_GATE_SET_TO_DISABLE)\n\n#define GATE_AUD0(_id, _name, _parent, _bit)\t\t\t\\\n\tGATE_AFE(_id, _name, _parent, AUDIO_TOP_CON0, _bit)\n\n#define GATE_AUD1(_id, _name, _parent, _bit)\t\t\t\\\n\tGATE_AFE(_id, _name, _parent, AUDIO_TOP_CON1, _bit)\n\n#define GATE_AUD3(_id, _name, _parent, _bit)\t\t\t\\\n\tGATE_AFE(_id, _name, _parent, AUDIO_TOP_CON3, _bit)\n\n#define GATE_AUD4(_id, _name, _parent, _bit)\t\t\t\\\n\tGATE_AFE(_id, _name, _parent, AUDIO_TOP_CON4, _bit)\n\n#define GATE_AUD5(_id, _name, _parent, _bit)\t\t\t\\\n\tGATE_AFE(_id, _name, _parent, AUDIO_TOP_CON5, _bit)\n\n#define GATE_AUD6(_id, _name, _parent, _bit)\t\t\t\\\n\tGATE_AFE(_id, _name, _parent, AUDIO_TOP_CON6, _bit)\n\nstatic const struct afe_gate aud_clks[CLK_AUD_NR_CLK] = {\n\t \n\tGATE_AUD0(CLK_AUD_AFE, \"aud_afe\", \"top_a1sys_hp\", 2),\n\tGATE_AUD0(CLK_AUD_LRCK_CNT, \"aud_lrck_cnt\", \"top_a1sys_hp\", 4),\n\tGATE_AUD0(CLK_AUD_SPDIFIN_TUNER_APLL, \"aud_spdifin_tuner_apll\", \"top_apll4\", 10),\n\tGATE_AUD0(CLK_AUD_SPDIFIN_TUNER_DBG, \"aud_spdifin_tuner_dbg\", \"top_apll4\", 11),\n\tGATE_AUD0(CLK_AUD_UL_TML, \"aud_ul_tml\", \"top_a1sys_hp\", 18),\n\tGATE_AUD0(CLK_AUD_APLL1_TUNER, \"aud_apll1_tuner\", \"top_apll1\", 19),\n\tGATE_AUD0(CLK_AUD_APLL2_TUNER, \"aud_apll2_tuner\", \"top_apll2\", 20),\n\tGATE_AUD0(CLK_AUD_TOP0_SPDF, \"aud_top0_spdf\", \"top_aud_iec_clk\", 21),\n\tGATE_AUD0(CLK_AUD_APLL, \"aud_apll\", \"top_apll1\", 23),\n\tGATE_AUD0(CLK_AUD_APLL2, \"aud_apll2\", \"top_apll2\", 24),\n\tGATE_AUD0(CLK_AUD_DAC, \"aud_dac\", \"top_a1sys_hp\", 25),\n\tGATE_AUD0(CLK_AUD_DAC_PREDIS, \"aud_dac_predis\", \"top_a1sys_hp\", 26),\n\tGATE_AUD0(CLK_AUD_TML, \"aud_tml\", \"top_a1sys_hp\", 27),\n\tGATE_AUD0(CLK_AUD_ADC, \"aud_adc\", \"top_a1sys_hp\", 28),\n\tGATE_AUD0(CLK_AUD_DAC_HIRES, \"aud_dac_hires\", \"top_audio_h\", 31),\n\n\t \n\tGATE_AUD1(CLK_AUD_A1SYS_HP, \"aud_a1sys_hp\", \"top_a1sys_hp\", 2),\n\tGATE_AUD1(CLK_AUD_AFE_DMIC1, \"aud_afe_dmic1\", \"top_a1sys_hp\", 10),\n\tGATE_AUD1(CLK_AUD_AFE_DMIC2, \"aud_afe_dmic2\", \"top_a1sys_hp\", 11),\n\tGATE_AUD1(CLK_AUD_AFE_DMIC3, \"aud_afe_dmic3\", \"top_a1sys_hp\", 12),\n\tGATE_AUD1(CLK_AUD_AFE_DMIC4, \"aud_afe_dmic4\", \"top_a1sys_hp\", 13),\n\tGATE_AUD1(CLK_AUD_AFE_26M_DMIC_TM, \"aud_afe_26m_dmic_tm\", \"top_a1sys_hp\", 14),\n\tGATE_AUD1(CLK_AUD_UL_TML_HIRES, \"aud_ul_tml_hires\", \"top_audio_h\", 16),\n\tGATE_AUD1(CLK_AUD_ADC_HIRES, \"aud_adc_hires\", \"top_audio_h\", 17),\n\tGATE_AUD1(CLK_AUD_ADDA6_ADC, \"aud_adda6_adc\", \"top_a1sys_hp\", 18),\n\tGATE_AUD1(CLK_AUD_ADDA6_ADC_HIRES, \"aud_adda6_adc_hires\", \"top_audio_h\", 19),\n\n\t \n\tGATE_AUD3(CLK_AUD_LINEIN_TUNER, \"aud_linein_tuner\", \"top_apll5\", 5),\n\tGATE_AUD3(CLK_AUD_EARC_TUNER, \"aud_earc_tuner\", \"top_apll3\", 7),\n\n\t \n\tGATE_AUD4(CLK_AUD_I2SIN, \"aud_i2sin\", \"top_a1sys_hp\", 0),\n\tGATE_AUD4(CLK_AUD_TDM_IN, \"aud_tdm_in\", \"top_a1sys_hp\", 1),\n\tGATE_AUD4(CLK_AUD_I2S_OUT, \"aud_i2s_out\", \"top_a1sys_hp\", 6),\n\tGATE_AUD4(CLK_AUD_TDM_OUT, \"aud_tdm_out\", \"top_a1sys_hp\", 7),\n\tGATE_AUD4(CLK_AUD_HDMI_OUT, \"aud_hdmi_out\", \"top_a1sys_hp\", 8),\n\tGATE_AUD4(CLK_AUD_ASRC11, \"aud_asrc11\", \"top_a1sys_hp\", 16),\n\tGATE_AUD4(CLK_AUD_ASRC12, \"aud_asrc12\", \"top_a1sys_hp\", 17),\n\tGATE_AUD4(CLK_AUD_MULTI_IN, \"aud_multi_in\", \"mphone_slave_b\", 19),\n\tGATE_AUD4(CLK_AUD_INTDIR, \"aud_intdir\", \"top_intdir\", 20),\n\tGATE_AUD4(CLK_AUD_A1SYS, \"aud_a1sys\", \"top_a1sys_hp\", 21),\n\tGATE_AUD4(CLK_AUD_A2SYS, \"aud_a2sys\", \"top_a2sys_hf\", 22),\n\tGATE_AUD4(CLK_AUD_PCMIF, \"aud_pcmif\", \"top_a1sys_hp\", 24),\n\tGATE_AUD4(CLK_AUD_A3SYS, \"aud_a3sys\", \"top_a3sys_hf\", 30),\n\tGATE_AUD4(CLK_AUD_A4SYS, \"aud_a4sys\", \"top_a4sys_hf\", 31),\n\n\t \n\tGATE_AUD5(CLK_AUD_MEMIF_UL1, \"aud_memif_ul1\", \"top_a1sys_hp\", 0),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL2, \"aud_memif_ul2\", \"top_a1sys_hp\", 1),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL3, \"aud_memif_ul3\", \"top_a1sys_hp\", 2),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL4, \"aud_memif_ul4\", \"top_a1sys_hp\", 3),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL5, \"aud_memif_ul5\", \"top_a1sys_hp\", 4),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL6, \"aud_memif_ul6\", \"top_a1sys_hp\", 5),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL8, \"aud_memif_ul8\", \"top_a1sys_hp\", 7),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL9, \"aud_memif_ul9\", \"top_a1sys_hp\", 8),\n\tGATE_AUD5(CLK_AUD_MEMIF_UL10, \"aud_memif_ul10\", \"top_a1sys_hp\", 9),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL2, \"aud_memif_dl2\", \"top_a1sys_hp\", 18),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL3, \"aud_memif_dl3\", \"top_a1sys_hp\", 19),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL6, \"aud_memif_dl6\", \"top_a1sys_hp\", 22),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL7, \"aud_memif_dl7\", \"top_a1sys_hp\", 23),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL8, \"aud_memif_dl8\", \"top_a1sys_hp\", 24),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL10, \"aud_memif_dl10\", \"top_a1sys_hp\", 26),\n\tGATE_AUD5(CLK_AUD_MEMIF_DL11, \"aud_memif_dl11\", \"top_a1sys_hp\", 27),\n\n\t \n\tGATE_AUD6(CLK_AUD_GASRC0, \"aud_gasrc0\", \"top_asm_h\", 0),\n\tGATE_AUD6(CLK_AUD_GASRC1, \"aud_gasrc1\", \"top_asm_h\", 1),\n\tGATE_AUD6(CLK_AUD_GASRC2, \"aud_gasrc2\", \"top_asm_h\", 2),\n\tGATE_AUD6(CLK_AUD_GASRC3, \"aud_gasrc3\", \"top_asm_h\", 3),\n\tGATE_AUD6(CLK_AUD_GASRC4, \"aud_gasrc4\", \"top_asm_h\", 4),\n\tGATE_AUD6(CLK_AUD_GASRC5, \"aud_gasrc5\", \"top_asm_h\", 5),\n\tGATE_AUD6(CLK_AUD_GASRC6, \"aud_gasrc6\", \"top_asm_h\", 6),\n\tGATE_AUD6(CLK_AUD_GASRC7, \"aud_gasrc7\", \"top_asm_h\", 7),\n\tGATE_AUD6(CLK_AUD_GASRC8, \"aud_gasrc8\", \"top_asm_h\", 8),\n\tGATE_AUD6(CLK_AUD_GASRC9, \"aud_gasrc9\", \"top_asm_h\", 9),\n\tGATE_AUD6(CLK_AUD_GASRC10, \"aud_gasrc10\", \"top_asm_h\", 10),\n\tGATE_AUD6(CLK_AUD_GASRC11, \"aud_gasrc11\", \"top_asm_h\", 11),\n\tGATE_AUD6(CLK_AUD_GASRC12, \"aud_gasrc12\", \"top_asm_h\", 12),\n\tGATE_AUD6(CLK_AUD_GASRC13, \"aud_gasrc13\", \"top_asm_h\", 13),\n\tGATE_AUD6(CLK_AUD_GASRC14, \"aud_gasrc14\", \"top_asm_h\", 14),\n\tGATE_AUD6(CLK_AUD_GASRC15, \"aud_gasrc15\", \"top_asm_h\", 15),\n\tGATE_AUD6(CLK_AUD_GASRC16, \"aud_gasrc16\", \"top_asm_h\", 16),\n\tGATE_AUD6(CLK_AUD_GASRC17, \"aud_gasrc17\", \"top_asm_h\", 17),\n\tGATE_AUD6(CLK_AUD_GASRC18, \"aud_gasrc18\", \"top_asm_h\", 18),\n\tGATE_AUD6(CLK_AUD_GASRC19, \"aud_gasrc19\", \"top_asm_h\", 19),\n};\n\nstatic void mt8195_audsys_clk_unregister(void *data)\n{\n\tstruct mtk_base_afe *afe = data;\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct clk *clk;\n\tstruct clk_lookup *cl;\n\tint i;\n\n\tif (!afe_priv)\n\t\treturn;\n\n\tfor (i = 0; i < CLK_AUD_NR_CLK; i++) {\n\t\tcl = afe_priv->lookup[i];\n\t\tif (!cl)\n\t\t\tcontinue;\n\n\t\tclk = cl->clk;\n\t\tclk_unregister_gate(clk);\n\n\t\tclkdev_drop(cl);\n\t}\n}\n\nint mt8195_audsys_clk_register(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tstruct clk *clk;\n\tstruct clk_lookup *cl;\n\tint i;\n\n\tafe_priv->lookup = devm_kcalloc(afe->dev, CLK_AUD_NR_CLK,\n\t\t\t\t\tsizeof(*afe_priv->lookup),\n\t\t\t\t\tGFP_KERNEL);\n\n\tif (!afe_priv->lookup)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < ARRAY_SIZE(aud_clks); i++) {\n\t\tconst struct afe_gate *gate = &aud_clks[i];\n\n\t\tclk = clk_register_gate(afe->dev, gate->name, gate->parent_name,\n\t\t\t\t\tgate->flags, afe->base_addr + gate->reg,\n\t\t\t\t\tgate->bit, gate->cg_flags, NULL);\n\n\t\tif (IS_ERR(clk)) {\n\t\t\tdev_err(afe->dev, \"Failed to register clk %s: %ld\\n\",\n\t\t\t\tgate->name, PTR_ERR(clk));\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tcl = kzalloc(sizeof(*cl), GFP_KERNEL);\n\t\tif (!cl)\n\t\t\treturn -ENOMEM;\n\n\t\tcl->clk = clk;\n\t\tcl->con_id = gate->name;\n\t\tcl->dev_id = dev_name(afe->dev);\n\t\tclkdev_add(cl);\n\n\t\tafe_priv->lookup[i] = cl;\n\t}\n\n\treturn devm_add_action_or_reset(afe->dev, mt8195_audsys_clk_unregister, afe);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}