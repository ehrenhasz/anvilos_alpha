{
  "module_name": "mt8195-afe-clk.c",
  "hash_id": "58e2a830458609bfe0b9b9fd5e017f61918cacba5b55a4506d7a2c875bcba79e",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8195/mt8195-afe-clk.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n\n#include \"mt8195-afe-common.h\"\n#include \"mt8195-afe-clk.h\"\n#include \"mt8195-reg.h\"\n#include \"mt8195-audsys-clk.h\"\n\nstatic const char *aud_clks[MT8195_CLK_NUM] = {\n\t \n\t[MT8195_CLK_XTAL_26M] = \"clk26m\",\n\t \n\t[MT8195_CLK_TOP_APLL1] = \"apll1_ck\",\n\t[MT8195_CLK_TOP_APLL2] = \"apll2_ck\",\n\t[MT8195_CLK_TOP_APLL12_DIV0] = \"apll12_div0\",\n\t[MT8195_CLK_TOP_APLL12_DIV1] = \"apll12_div1\",\n\t[MT8195_CLK_TOP_APLL12_DIV2] = \"apll12_div2\",\n\t[MT8195_CLK_TOP_APLL12_DIV3] = \"apll12_div3\",\n\t[MT8195_CLK_TOP_APLL12_DIV9] = \"apll12_div9\",\n\t \n\t[MT8195_CLK_TOP_A1SYS_HP_SEL] = \"a1sys_hp_sel\",\n\t[MT8195_CLK_TOP_AUD_INTBUS_SEL] = \"aud_intbus_sel\",\n\t[MT8195_CLK_TOP_AUDIO_H_SEL] = \"audio_h_sel\",\n\t[MT8195_CLK_TOP_AUDIO_LOCAL_BUS_SEL] = \"audio_local_bus_sel\",\n\t[MT8195_CLK_TOP_DPTX_M_SEL] = \"dptx_m_sel\",\n\t[MT8195_CLK_TOP_I2SO1_M_SEL] = \"i2so1_m_sel\",\n\t[MT8195_CLK_TOP_I2SO2_M_SEL] = \"i2so2_m_sel\",\n\t[MT8195_CLK_TOP_I2SI1_M_SEL] = \"i2si1_m_sel\",\n\t[MT8195_CLK_TOP_I2SI2_M_SEL] = \"i2si2_m_sel\",\n\t \n\t[MT8195_CLK_INFRA_AO_AUDIO_26M_B] = \"infra_ao_audio_26m_b\",\n\t[MT8195_CLK_SCP_ADSP_AUDIODSP] = \"scp_adsp_audiodsp\",\n\t \n\t[MT8195_CLK_AUD_AFE] = \"aud_afe\",\n\t[MT8195_CLK_AUD_APLL1_TUNER] = \"aud_apll1_tuner\",\n\t[MT8195_CLK_AUD_APLL2_TUNER] = \"aud_apll2_tuner\",\n\t[MT8195_CLK_AUD_APLL] = \"aud_apll\",\n\t[MT8195_CLK_AUD_APLL2] = \"aud_apll2\",\n\t[MT8195_CLK_AUD_DAC] = \"aud_dac\",\n\t[MT8195_CLK_AUD_ADC] = \"aud_adc\",\n\t[MT8195_CLK_AUD_DAC_HIRES] = \"aud_dac_hires\",\n\t[MT8195_CLK_AUD_A1SYS_HP] = \"aud_a1sys_hp\",\n\t[MT8195_CLK_AUD_ADC_HIRES] = \"aud_adc_hires\",\n\t[MT8195_CLK_AUD_ADDA6_ADC] = \"aud_adda6_adc\",\n\t[MT8195_CLK_AUD_ADDA6_ADC_HIRES] = \"aud_adda6_adc_hires\",\n\t[MT8195_CLK_AUD_I2SIN] = \"aud_i2sin\",\n\t[MT8195_CLK_AUD_TDM_IN] = \"aud_tdm_in\",\n\t[MT8195_CLK_AUD_I2S_OUT] = \"aud_i2s_out\",\n\t[MT8195_CLK_AUD_TDM_OUT] = \"aud_tdm_out\",\n\t[MT8195_CLK_AUD_HDMI_OUT] = \"aud_hdmi_out\",\n\t[MT8195_CLK_AUD_ASRC11] = \"aud_asrc11\",\n\t[MT8195_CLK_AUD_ASRC12] = \"aud_asrc12\",\n\t[MT8195_CLK_AUD_A1SYS] = \"aud_a1sys\",\n\t[MT8195_CLK_AUD_A2SYS] = \"aud_a2sys\",\n\t[MT8195_CLK_AUD_PCMIF] = \"aud_pcmif\",\n\t[MT8195_CLK_AUD_MEMIF_UL1] = \"aud_memif_ul1\",\n\t[MT8195_CLK_AUD_MEMIF_UL2] = \"aud_memif_ul2\",\n\t[MT8195_CLK_AUD_MEMIF_UL3] = \"aud_memif_ul3\",\n\t[MT8195_CLK_AUD_MEMIF_UL4] = \"aud_memif_ul4\",\n\t[MT8195_CLK_AUD_MEMIF_UL5] = \"aud_memif_ul5\",\n\t[MT8195_CLK_AUD_MEMIF_UL6] = \"aud_memif_ul6\",\n\t[MT8195_CLK_AUD_MEMIF_UL8] = \"aud_memif_ul8\",\n\t[MT8195_CLK_AUD_MEMIF_UL9] = \"aud_memif_ul9\",\n\t[MT8195_CLK_AUD_MEMIF_UL10] = \"aud_memif_ul10\",\n\t[MT8195_CLK_AUD_MEMIF_DL2] = \"aud_memif_dl2\",\n\t[MT8195_CLK_AUD_MEMIF_DL3] = \"aud_memif_dl3\",\n\t[MT8195_CLK_AUD_MEMIF_DL6] = \"aud_memif_dl6\",\n\t[MT8195_CLK_AUD_MEMIF_DL7] = \"aud_memif_dl7\",\n\t[MT8195_CLK_AUD_MEMIF_DL8] = \"aud_memif_dl8\",\n\t[MT8195_CLK_AUD_MEMIF_DL10] = \"aud_memif_dl10\",\n\t[MT8195_CLK_AUD_MEMIF_DL11] = \"aud_memif_dl11\",\n};\n\nstruct mt8195_afe_tuner_cfg {\n\tunsigned int id;\n\tint apll_div_reg;\n\tunsigned int apll_div_shift;\n\tunsigned int apll_div_maskbit;\n\tunsigned int apll_div_default;\n\tint ref_ck_sel_reg;\n\tunsigned int ref_ck_sel_shift;\n\tunsigned int ref_ck_sel_maskbit;\n\tunsigned int ref_ck_sel_default;\n\tint tuner_en_reg;\n\tunsigned int tuner_en_shift;\n\tunsigned int tuner_en_maskbit;\n\tint upper_bound_reg;\n\tunsigned int upper_bound_shift;\n\tunsigned int upper_bound_maskbit;\n\tunsigned int upper_bound_default;\n\tspinlock_t ctrl_lock;  \n\tint ref_cnt;\n};\n\nstatic struct mt8195_afe_tuner_cfg mt8195_afe_tuner_cfgs[MT8195_AUD_PLL_NUM] = {\n\t[MT8195_AUD_PLL1] = {\n\t\t.id = MT8195_AUD_PLL1,\n\t\t.apll_div_reg = AFE_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0xf,\n\t\t.apll_div_default = 0x7,\n\t\t.ref_ck_sel_reg = AFE_APLL_TUNER_CFG,\n\t\t.ref_ck_sel_shift = 1,\n\t\t.ref_ck_sel_maskbit = 0x3,\n\t\t.ref_ck_sel_default = 0x2,\n\t\t.tuner_en_reg = AFE_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 8,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x3,\n\t},\n\t[MT8195_AUD_PLL2] = {\n\t\t.id = MT8195_AUD_PLL2,\n\t\t.apll_div_reg = AFE_APLL_TUNER_CFG1,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0xf,\n\t\t.apll_div_default = 0x7,\n\t\t.ref_ck_sel_reg = AFE_APLL_TUNER_CFG1,\n\t\t.ref_ck_sel_shift = 1,\n\t\t.ref_ck_sel_maskbit = 0x3,\n\t\t.ref_ck_sel_default = 0x1,\n\t\t.tuner_en_reg = AFE_APLL_TUNER_CFG1,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_APLL_TUNER_CFG1,\n\t\t.upper_bound_shift = 8,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x3,\n\t},\n\t[MT8195_AUD_PLL3] = {\n\t\t.id = MT8195_AUD_PLL3,\n\t\t.apll_div_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0x3f,\n\t\t.apll_div_default = 0x3,\n\t\t.ref_ck_sel_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.ref_ck_sel_shift = 24,\n\t\t.ref_ck_sel_maskbit = 0x3,\n\t\t.ref_ck_sel_default = 0x0,\n\t\t.tuner_en_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_EARC_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 12,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x4,\n\t},\n\t[MT8195_AUD_PLL4] = {\n\t\t.id = MT8195_AUD_PLL4,\n\t\t.apll_div_reg = AFE_SPDIFIN_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0x3f,\n\t\t.apll_div_default = 0x7,\n\t\t.ref_ck_sel_reg = AFE_SPDIFIN_APLL_TUNER_CFG1,\n\t\t.ref_ck_sel_shift = 8,\n\t\t.ref_ck_sel_maskbit = 0x1,\n\t\t.ref_ck_sel_default = 0,\n\t\t.tuner_en_reg = AFE_SPDIFIN_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_SPDIFIN_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 12,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x4,\n\t},\n\t[MT8195_AUD_PLL5] = {\n\t\t.id = MT8195_AUD_PLL5,\n\t\t.apll_div_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.apll_div_shift = 4,\n\t\t.apll_div_maskbit = 0x3f,\n\t\t.apll_div_default = 0x3,\n\t\t.ref_ck_sel_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.ref_ck_sel_shift = 24,\n\t\t.ref_ck_sel_maskbit = 0x1,\n\t\t.ref_ck_sel_default = 0,\n\t\t.tuner_en_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.tuner_en_shift = 0,\n\t\t.tuner_en_maskbit = 0x1,\n\t\t.upper_bound_reg = AFE_LINEIN_APLL_TUNER_CFG,\n\t\t.upper_bound_shift = 12,\n\t\t.upper_bound_maskbit = 0xff,\n\t\t.upper_bound_default = 0x4,\n\t},\n};\n\nstatic struct mt8195_afe_tuner_cfg *mt8195_afe_found_apll_tuner(unsigned int id)\n{\n\tif (id >= MT8195_AUD_PLL_NUM)\n\t\treturn NULL;\n\n\treturn &mt8195_afe_tuner_cfgs[id];\n}\n\nstatic int mt8195_afe_init_apll_tuner(unsigned int id)\n{\n\tstruct mt8195_afe_tuner_cfg *cfg = mt8195_afe_found_apll_tuner(id);\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tcfg->ref_cnt = 0;\n\tspin_lock_init(&cfg->ctrl_lock);\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_setup_apll_tuner(struct mtk_base_afe *afe,\n\t\t\t\t       unsigned int id)\n{\n\tconst struct mt8195_afe_tuner_cfg *cfg = mt8195_afe_found_apll_tuner(id);\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tregmap_update_bits(afe->regmap, cfg->apll_div_reg,\n\t\t\t   cfg->apll_div_maskbit << cfg->apll_div_shift,\n\t\t\t   cfg->apll_div_default << cfg->apll_div_shift);\n\n\tregmap_update_bits(afe->regmap, cfg->ref_ck_sel_reg,\n\t\t\t   cfg->ref_ck_sel_maskbit << cfg->ref_ck_sel_shift,\n\t\t\t   cfg->ref_ck_sel_default << cfg->ref_ck_sel_shift);\n\n\tregmap_update_bits(afe->regmap, cfg->upper_bound_reg,\n\t\t\t   cfg->upper_bound_maskbit << cfg->upper_bound_shift,\n\t\t\t   cfg->upper_bound_default << cfg->upper_bound_shift);\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_enable_tuner_clk(struct mtk_base_afe *afe,\n\t\t\t\t       unsigned int id)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\n\tswitch (id) {\n\tcase MT8195_AUD_PLL1:\n\t\tmt8195_afe_enable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL]);\n\t\tmt8195_afe_enable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL1_TUNER]);\n\t\tbreak;\n\tcase MT8195_AUD_PLL2:\n\t\tmt8195_afe_enable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL2]);\n\t\tmt8195_afe_enable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL2_TUNER]);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_disable_tuner_clk(struct mtk_base_afe *afe,\n\t\t\t\t\tunsigned int id)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\n\tswitch (id) {\n\tcase MT8195_AUD_PLL1:\n\t\tmt8195_afe_disable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL1_TUNER]);\n\t\tmt8195_afe_disable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL]);\n\t\tbreak;\n\tcase MT8195_AUD_PLL2:\n\t\tmt8195_afe_disable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL2_TUNER]);\n\t\tmt8195_afe_disable_clk(afe, afe_priv->clk[MT8195_CLK_AUD_APLL2]);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_enable_apll_tuner(struct mtk_base_afe *afe,\n\t\t\t\t\tunsigned int id)\n{\n\tstruct mt8195_afe_tuner_cfg *cfg = mt8195_afe_found_apll_tuner(id);\n\tunsigned long flags;\n\tint ret;\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tret = mt8195_afe_setup_apll_tuner(afe, id);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt8195_afe_enable_tuner_clk(afe, id);\n\tif (ret)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&cfg->ctrl_lock, flags);\n\n\tcfg->ref_cnt++;\n\tif (cfg->ref_cnt == 1)\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   cfg->tuner_en_reg,\n\t\t\t\t   cfg->tuner_en_maskbit << cfg->tuner_en_shift,\n\t\t\t\t   1 << cfg->tuner_en_shift);\n\n\tspin_unlock_irqrestore(&cfg->ctrl_lock, flags);\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_disable_apll_tuner(struct mtk_base_afe *afe,\n\t\t\t\t\t unsigned int id)\n{\n\tstruct mt8195_afe_tuner_cfg *cfg = mt8195_afe_found_apll_tuner(id);\n\tunsigned long flags;\n\tint ret;\n\n\tif (!cfg)\n\t\treturn -EINVAL;\n\n\tspin_lock_irqsave(&cfg->ctrl_lock, flags);\n\n\tcfg->ref_cnt--;\n\tif (cfg->ref_cnt == 0)\n\t\tregmap_update_bits(afe->regmap,\n\t\t\t\t   cfg->tuner_en_reg,\n\t\t\t\t   cfg->tuner_en_maskbit << cfg->tuner_en_shift,\n\t\t\t\t   0 << cfg->tuner_en_shift);\n\telse if (cfg->ref_cnt < 0)\n\t\tcfg->ref_cnt = 0;\n\n\tspin_unlock_irqrestore(&cfg->ctrl_lock, flags);\n\n\tret = mt8195_afe_disable_tuner_clk(afe, id);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nint mt8195_afe_get_mclk_source_clk_id(int sel)\n{\n\tswitch (sel) {\n\tcase MT8195_MCK_SEL_26M:\n\t\treturn MT8195_CLK_XTAL_26M;\n\tcase MT8195_MCK_SEL_APLL1:\n\t\treturn MT8195_CLK_TOP_APLL1;\n\tcase MT8195_MCK_SEL_APLL2:\n\t\treturn MT8195_CLK_TOP_APLL2;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nint mt8195_afe_get_mclk_source_rate(struct mtk_base_afe *afe, int apll)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint clk_id = mt8195_afe_get_mclk_source_clk_id(apll);\n\n\tif (clk_id < 0) {\n\t\tdev_dbg(afe->dev, \"invalid clk id\\n\");\n\t\treturn 0;\n\t}\n\n\treturn clk_get_rate(afe_priv->clk[clk_id]);\n}\n\nint mt8195_afe_get_default_mclk_source_by_rate(int rate)\n{\n\treturn ((rate % 8000) == 0) ?\n\t\tMT8195_MCK_SEL_APLL1 : MT8195_MCK_SEL_APLL2;\n}\n\nint mt8195_afe_init_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint i, ret;\n\n\tmt8195_audsys_clk_register(afe);\n\n\tafe_priv->clk =\n\t\tdevm_kcalloc(afe->dev, MT8195_CLK_NUM, sizeof(*afe_priv->clk),\n\t\t\t     GFP_KERNEL);\n\tif (!afe_priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < MT8195_CLK_NUM; i++) {\n\t\tafe_priv->clk[i] = devm_clk_get(afe->dev, aud_clks[i]);\n\t\tif (IS_ERR(afe_priv->clk[i])) {\n\t\t\tdev_dbg(afe->dev, \"%s(), devm_clk_get %s fail, ret %ld\\n\",\n\t\t\t\t__func__, aud_clks[i],\n\t\t\t\tPTR_ERR(afe_priv->clk[i]));\n\t\t\treturn PTR_ERR(afe_priv->clk[i]);\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < MT8195_AUD_PLL_NUM; i++) {\n\t\tret = mt8195_afe_init_apll_tuner(i);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), init apll_tuner%d failed\",\n\t\t\t\t__func__, (i + 1));\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint mt8195_afe_enable_clk(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tint ret;\n\n\tif (clk) {\n\t\tret = clk_prepare_enable(clk);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to enable clk\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt8195_afe_enable_clk);\n\nvoid mt8195_afe_disable_clk(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tif (clk)\n\t\tclk_disable_unprepare(clk);\n\telse\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n}\nEXPORT_SYMBOL_GPL(mt8195_afe_disable_clk);\n\nint mt8195_afe_prepare_clk(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tint ret;\n\n\tif (clk) {\n\t\tret = clk_prepare(clk);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to prepare clk\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n\t}\n\treturn 0;\n}\n\nvoid mt8195_afe_unprepare_clk(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tif (clk)\n\t\tclk_unprepare(clk);\n\telse\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n}\n\nint mt8195_afe_enable_clk_atomic(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tint ret;\n\n\tif (clk) {\n\t\tret = clk_enable(clk);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to clk enable\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n\t}\n\treturn 0;\n}\n\nvoid mt8195_afe_disable_clk_atomic(struct mtk_base_afe *afe, struct clk *clk)\n{\n\tif (clk)\n\t\tclk_disable(clk);\n\telse\n\t\tdev_dbg(afe->dev, \"NULL clk\\n\");\n}\n\nint mt8195_afe_set_clk_rate(struct mtk_base_afe *afe, struct clk *clk,\n\t\t\t    unsigned int rate)\n{\n\tint ret;\n\n\tif (clk) {\n\t\tret = clk_set_rate(clk, rate);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to set clk rate\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint mt8195_afe_set_clk_parent(struct mtk_base_afe *afe, struct clk *clk,\n\t\t\t      struct clk *parent)\n{\n\tint ret;\n\n\tif (clk && parent) {\n\t\tret = clk_set_parent(clk, parent);\n\t\tif (ret) {\n\t\t\tdev_dbg(afe->dev, \"%s(), failed to set clk parent\\n\",\n\t\t\t\t__func__);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic unsigned int get_top_cg_reg(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8195_TOP_CG_A1SYS_TIMING:\n\tcase MT8195_TOP_CG_A2SYS_TIMING:\n\tcase MT8195_TOP_CG_26M_TIMING:\n\t\treturn ASYS_TOP_CON;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic unsigned int get_top_cg_mask(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8195_TOP_CG_A1SYS_TIMING:\n\t\treturn ASYS_TOP_CON_A1SYS_TIMING_ON;\n\tcase MT8195_TOP_CG_A2SYS_TIMING:\n\t\treturn ASYS_TOP_CON_A2SYS_TIMING_ON;\n\tcase MT8195_TOP_CG_26M_TIMING:\n\t\treturn ASYS_TOP_CON_26M_TIMING_ON;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic unsigned int get_top_cg_on_val(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8195_TOP_CG_A1SYS_TIMING:\n\tcase MT8195_TOP_CG_A2SYS_TIMING:\n\tcase MT8195_TOP_CG_26M_TIMING:\n\t\treturn get_top_cg_mask(cg_type);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic unsigned int get_top_cg_off_val(unsigned int cg_type)\n{\n\tswitch (cg_type) {\n\tcase MT8195_TOP_CG_A1SYS_TIMING:\n\tcase MT8195_TOP_CG_A2SYS_TIMING:\n\tcase MT8195_TOP_CG_26M_TIMING:\n\t\treturn 0;\n\tdefault:\n\t\treturn get_top_cg_mask(cg_type);\n\t}\n}\n\nstatic int mt8195_afe_enable_top_cg(struct mtk_base_afe *afe, unsigned int cg_type)\n{\n\tunsigned int reg = get_top_cg_reg(cg_type);\n\tunsigned int mask = get_top_cg_mask(cg_type);\n\tunsigned int val = get_top_cg_on_val(cg_type);\n\n\tregmap_update_bits(afe->regmap, reg, mask, val);\n\treturn 0;\n}\n\nstatic int mt8195_afe_disable_top_cg(struct mtk_base_afe *afe, unsigned int cg_type)\n{\n\tunsigned int reg = get_top_cg_reg(cg_type);\n\tunsigned int mask = get_top_cg_mask(cg_type);\n\tunsigned int val = get_top_cg_off_val(cg_type);\n\n\tregmap_update_bits(afe->regmap, reg, mask, val);\n\treturn 0;\n}\n\nint mt8195_afe_enable_reg_rw_clk(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint i;\n\tstatic const unsigned int clk_array[] = {\n\t\tMT8195_CLK_SCP_ADSP_AUDIODSP,  \n\t\tMT8195_CLK_TOP_AUDIO_H_SEL,  \n\t\tMT8195_CLK_TOP_AUDIO_LOCAL_BUS_SEL,  \n\t\tMT8195_CLK_TOP_AUD_INTBUS_SEL,  \n\t\tMT8195_CLK_INFRA_AO_AUDIO_26M_B,  \n\t\tMT8195_CLK_AUD_AFE,  \n\t\tMT8195_CLK_AUD_A1SYS_HP,  \n\t\tMT8195_CLK_AUD_A1SYS,  \n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(clk_array); i++)\n\t\tmt8195_afe_enable_clk(afe, afe_priv->clk[clk_array[i]]);\n\n\treturn 0;\n}\n\nint mt8195_afe_disable_reg_rw_clk(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint i;\n\tstatic const unsigned int clk_array[] = {\n\t\tMT8195_CLK_AUD_A1SYS,\n\t\tMT8195_CLK_AUD_A1SYS_HP,\n\t\tMT8195_CLK_AUD_AFE,\n\t\tMT8195_CLK_INFRA_AO_AUDIO_26M_B,\n\t\tMT8195_CLK_TOP_AUD_INTBUS_SEL,\n\t\tMT8195_CLK_TOP_AUDIO_LOCAL_BUS_SEL,\n\t\tMT8195_CLK_TOP_AUDIO_H_SEL,\n\t\tMT8195_CLK_SCP_ADSP_AUDIODSP,\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(clk_array); i++)\n\t\tmt8195_afe_disable_clk(afe, afe_priv->clk[clk_array[i]]);\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_enable_afe_on(struct mtk_base_afe *afe)\n{\n\tregmap_update_bits(afe->regmap, AFE_DAC_CON0, 0x1, 0x1);\n\treturn 0;\n}\n\nstatic int mt8195_afe_disable_afe_on(struct mtk_base_afe *afe)\n{\n\tregmap_update_bits(afe->regmap, AFE_DAC_CON0, 0x1, 0x0);\n\treturn 0;\n}\n\nstatic int mt8195_afe_enable_timing_sys(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint i;\n\tstatic const unsigned int clk_array[] = {\n\t\tMT8195_CLK_AUD_A1SYS,\n\t\tMT8195_CLK_AUD_A2SYS,\n\t};\n\tstatic const unsigned int cg_array[] = {\n\t\tMT8195_TOP_CG_A1SYS_TIMING,\n\t\tMT8195_TOP_CG_A2SYS_TIMING,\n\t\tMT8195_TOP_CG_26M_TIMING,\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(clk_array); i++)\n\t\tmt8195_afe_enable_clk(afe, afe_priv->clk[clk_array[i]]);\n\n\tfor (i = 0; i < ARRAY_SIZE(cg_array); i++)\n\t\tmt8195_afe_enable_top_cg(afe, cg_array[i]);\n\n\treturn 0;\n}\n\nstatic int mt8195_afe_disable_timing_sys(struct mtk_base_afe *afe)\n{\n\tstruct mt8195_afe_private *afe_priv = afe->platform_priv;\n\tint i;\n\tstatic const unsigned int clk_array[] = {\n\t\tMT8195_CLK_AUD_A2SYS,\n\t\tMT8195_CLK_AUD_A1SYS,\n\t};\n\tstatic const unsigned int cg_array[] = {\n\t\tMT8195_TOP_CG_26M_TIMING,\n\t\tMT8195_TOP_CG_A2SYS_TIMING,\n\t\tMT8195_TOP_CG_A1SYS_TIMING,\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(cg_array); i++)\n\t\tmt8195_afe_disable_top_cg(afe, cg_array[i]);\n\n\tfor (i = 0; i < ARRAY_SIZE(clk_array); i++)\n\t\tmt8195_afe_disable_clk(afe, afe_priv->clk[clk_array[i]]);\n\n\treturn 0;\n}\n\nint mt8195_afe_enable_main_clock(struct mtk_base_afe *afe)\n{\n\tmt8195_afe_enable_timing_sys(afe);\n\n\tmt8195_afe_enable_afe_on(afe);\n\n\tmt8195_afe_enable_apll_tuner(afe, MT8195_AUD_PLL1);\n\tmt8195_afe_enable_apll_tuner(afe, MT8195_AUD_PLL2);\n\n\treturn 0;\n}\n\nint mt8195_afe_disable_main_clock(struct mtk_base_afe *afe)\n{\n\tmt8195_afe_disable_apll_tuner(afe, MT8195_AUD_PLL2);\n\tmt8195_afe_disable_apll_tuner(afe, MT8195_AUD_PLL1);\n\n\tmt8195_afe_disable_afe_on(afe);\n\n\tmt8195_afe_disable_timing_sys(afe);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}