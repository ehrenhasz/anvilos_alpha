{
  "module_name": "mt8183-da7219-max98357.c",
  "hash_id": "9fdc916861df2699b7b4ae6f03780ac4d49085bd050994b68028578fdb5024dd",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8183/mt8183-da7219-max98357.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/pinctrl/consumer.h>\n#include <sound/jack.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#include \"../../codecs/da7219.h\"\n#include \"../../codecs/rt1015.h\"\n#include \"../common/mtk-afe-platform-driver.h\"\n#include \"mt8183-afe-common.h\"\n\n#define DA7219_CODEC_DAI \"da7219-hifi\"\n#define DA7219_DEV_NAME \"da7219.5-001a\"\n#define RT1015_CODEC_DAI \"rt1015-aif\"\n#define RT1015_DEV0_NAME \"rt1015.6-0028\"\n#define RT1015_DEV1_NAME \"rt1015.6-0029\"\n\nstruct mt8183_da7219_max98357_priv {\n\tstruct snd_soc_jack headset_jack, hdmi_jack;\n};\n\nstatic struct snd_soc_jack_pin mt8183_da7219_max98357_jack_pins[] = {\n\t{\n\t\t.pin\t= \"Headphone\",\n\t\t.mask\t= SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin\t= \"Headset Mic\",\n\t\t.mask\t= SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin\t= \"Line Out\",\n\t\t.mask\t= SND_JACK_LINEOUT,\n\t},\n};\n\nstatic int mt8183_mt6358_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int rate = params_rate(params);\n\tunsigned int mclk_fs_ratio = 128;\n\tunsigned int mclk_fs = rate * mclk_fs_ratio;\n\n\treturn snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0),\n\t\t\t\t      0, mclk_fs, SND_SOC_CLOCK_OUT);\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_i2s_ops = {\n\t.hw_params = mt8183_mt6358_i2s_hw_params,\n};\n\nstatic int mt8183_da7219_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tunsigned int rate = params_rate(params);\n\tunsigned int mclk_fs_ratio = 256;\n\tunsigned int mclk_fs = rate * mclk_fs_ratio;\n\tunsigned int freq;\n\tint ret = 0, j;\n\n\tret = snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0), 0,\n\t\t\t\t     mclk_fs, SND_SOC_CLOCK_OUT);\n\tif (ret < 0)\n\t\tdev_err(rtd->dev, \"failed to set cpu dai sysclk\\n\");\n\n\tfor_each_rtd_codec_dais(rtd, j, codec_dai) {\n\t\tif (!strcmp(codec_dai->component->name, DA7219_DEV_NAME)) {\n\t\t\tret = snd_soc_dai_set_sysclk(codec_dai,\n\t\t\t\t\t\t     DA7219_CLKSRC_MCLK,\n\t\t\t\t\t\t     mclk_fs,\n\t\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\t\tif (ret < 0)\n\t\t\t\tdev_err(rtd->dev, \"failed to set sysclk\\n\");\n\n\t\t\tif ((rate % 8000) == 0)\n\t\t\t\tfreq = DA7219_PLL_FREQ_OUT_98304;\n\t\t\telse\n\t\t\t\tfreq = DA7219_PLL_FREQ_OUT_90316;\n\n\t\t\tret = snd_soc_dai_set_pll(codec_dai, 0,\n\t\t\t\t\t\t  DA7219_SYSCLK_PLL_SRM,\n\t\t\t\t\t\t  0, freq);\n\t\t\tif (ret)\n\t\t\t\tdev_err(rtd->dev, \"failed to start PLL: %d\\n\",\n\t\t\t\t\tret);\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int mt8183_da7219_hw_free(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *codec_dai;\n\tint ret = 0, j;\n\n\tfor_each_rtd_codec_dais(rtd, j, codec_dai) {\n\t\tif (!strcmp(codec_dai->component->name, DA7219_DEV_NAME)) {\n\t\t\tret = snd_soc_dai_set_pll(codec_dai,\n\t\t\t\t\t\t  0, DA7219_SYSCLK_MCLK, 0, 0);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(rtd->dev, \"failed to stop PLL: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic const struct snd_soc_ops mt8183_da7219_i2s_ops = {\n\t.hw_params = mt8183_da7219_i2s_hw_params,\n\t.hw_free = mt8183_da7219_hw_free,\n};\n\nstatic int\nmt8183_da7219_rt1015_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int rate = params_rate(params);\n\tstruct snd_soc_dai *codec_dai;\n\tint ret = 0, i;\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\tif (!strcmp(codec_dai->component->name, RT1015_DEV0_NAME) ||\n\t\t    !strcmp(codec_dai->component->name, RT1015_DEV1_NAME)) {\n\t\t\tret = snd_soc_dai_set_pll(codec_dai, 0,\n\t\t\t\t\t\t  RT1015_PLL_S_BCLK,\n\t\t\t\t\t\t  rate * 64, rate * 256);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(rtd->dev, \"failed to set pll\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tret = snd_soc_dai_set_sysclk(codec_dai,\n\t\t\t\t\t\t     RT1015_SCLK_S_PLL,\n\t\t\t\t\t\t     rate * 256,\n\t\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(rtd->dev, \"failed to set sysclk\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn mt8183_da7219_i2s_hw_params(substream, params);\n}\n\nstatic const struct snd_soc_ops mt8183_da7219_rt1015_i2s_ops = {\n\t.hw_params = mt8183_da7219_rt1015_i2s_hw_params,\n\t.hw_free = mt8183_da7219_hw_free,\n};\n\nstatic int mt8183_i2s_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\t \n\tsnd_mask_reset_range(hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT),\n\t\t\t     0, (__force unsigned int)SNDRV_PCM_FORMAT_LAST);\n\n\tparams_set_format(params, SNDRV_PCM_FORMAT_S32_LE);\n\n\treturn 0;\n}\n\nstatic int mt8183_rt1015_i2s_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t\t     struct snd_pcm_hw_params *params)\n{\n\t \n\tsnd_mask_reset_range(hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT),\n\t\t\t     0, (__force unsigned int)SNDRV_PCM_FORMAT_LAST);\n\n\tparams_set_format(params, SNDRV_PCM_FORMAT_S24_LE);\n\n\treturn 0;\n}\n\nstatic int\nmt8183_da7219_max98357_startup(\n\tstruct snd_pcm_substream *substream)\n{\n\tstatic const unsigned int rates[] = {\n\t\t48000,\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_rates = {\n\t\t.count = ARRAY_SIZE(rates),\n\t\t.list  = rates,\n\t\t.mask = 0,\n\t};\n\tstatic const unsigned int channels[] = {\n\t\t2,\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_channels = {\n\t\t.count = ARRAY_SIZE(channels),\n\t\t.list = channels,\n\t\t.mask = 0,\n\t};\n\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_RATE, &constraints_rates);\n\truntime->hw.channels_max = 2;\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_CHANNELS,\n\t\t\t&constraints_channels);\n\n\truntime->hw.formats = SNDRV_PCM_FMTBIT_S16_LE;\n\tsnd_pcm_hw_constraint_msbits(runtime, 0, 16, 16);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8183_da7219_max98357_ops = {\n\t.startup = mt8183_da7219_max98357_startup,\n};\n\nstatic int\nmt8183_da7219_max98357_bt_sco_startup(\n\tstruct snd_pcm_substream *substream)\n{\n\tstatic const unsigned int rates[] = {\n\t\t8000, 16000\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_rates = {\n\t\t.count = ARRAY_SIZE(rates),\n\t\t.list  = rates,\n\t\t.mask = 0,\n\t};\n\tstatic const unsigned int channels[] = {\n\t\t1,\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_channels = {\n\t\t.count = ARRAY_SIZE(channels),\n\t\t.list = channels,\n\t\t.mask = 0,\n\t};\n\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_RATE, &constraints_rates);\n\truntime->hw.channels_max = 1;\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_CHANNELS,\n\t\t\t&constraints_channels);\n\n\truntime->hw.formats = SNDRV_PCM_FMTBIT_S16_LE;\n\tsnd_pcm_hw_constraint_msbits(runtime, 0, 16, 16);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8183_da7219_max98357_bt_sco_ops = {\n\t.startup = mt8183_da7219_max98357_bt_sco_startup,\n};\n\n \nSND_SOC_DAILINK_DEFS(playback1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback3,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL3\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture3,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL3\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture_mono,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL_MONO_1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback_hdmi,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"HDMI\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\n \nSND_SOC_DAILINK_DEFS(primary_codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"ADDA\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"mt6358-sound\", \"mt6358-snd-codec-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(pcm1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM 1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(pcm2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM 2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s0,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"bt-sco\", \"bt-sco-pcm\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S2\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(DA7219_DEV_NAME, DA7219_CODEC_DAI)),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s3_max98357a,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"max98357a\", \"HiFi\"),\n\t\t\t   COMP_CODEC(DA7219_DEV_NAME, DA7219_CODEC_DAI)),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s3_rt1015,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(RT1015_DEV0_NAME, RT1015_CODEC_DAI),\n\t\t\t   COMP_CODEC(RT1015_DEV1_NAME, RT1015_CODEC_DAI),\n\t\t\t   COMP_CODEC(DA7219_DEV_NAME, DA7219_CODEC_DAI)),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s3_rt1015p,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"rt1015p\", \"HiFi\"),\n\t\t\t   COMP_CODEC(DA7219_DEV_NAME, DA7219_CODEC_DAI)),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s5,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S5\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"bt-sco\", \"bt-sco-pcm\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(tdm,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"TDM\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"i2s-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic int mt8183_da7219_max98357_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct mt8183_da7219_max98357_priv *priv =\n\t\tsnd_soc_card_get_drvdata(rtd->card);\n\tint ret;\n\n\tret = snd_soc_card_jack_new(rtd->card, \"HDMI Jack\", SND_JACK_LINEOUT,\n\t\t\t\t    &priv->hdmi_jack);\n\tif (ret)\n\t\treturn ret;\n\n\treturn snd_soc_component_set_jack(asoc_rtd_to_codec(rtd, 0)->component,\n\t\t\t\t\t  &priv->hdmi_jack, NULL);\n}\n\nstatic int mt8183_bt_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *cmpnt_afe =\n\t\tsnd_soc_rtdcom_lookup(rtd, AFE_PCM_NAME);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt_afe);\n\tint ret;\n\n\tret = mt8183_dai_i2s_set_share(afe, \"I2S5\", \"I2S0\");\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Failed to set up shared clocks\\n\");\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int mt8183_da7219_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *cmpnt_afe =\n\t\tsnd_soc_rtdcom_lookup(rtd, AFE_PCM_NAME);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt_afe);\n\tint ret;\n\n\tret = mt8183_dai_i2s_set_share(afe, \"I2S2\", \"I2S3\");\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Failed to set up shared clocks\\n\");\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic struct snd_soc_dai_link mt8183_da7219_dai_links[] = {\n\t \n\t{\n\t\t.name = \"Playback_1\",\n\t\t.stream_name = \"Playback_1\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ops = &mt8183_da7219_max98357_ops,\n\t\tSND_SOC_DAILINK_REG(playback1),\n\t},\n\t{\n\t\t.name = \"Playback_2\",\n\t\t.stream_name = \"Playback_2\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ops = &mt8183_da7219_max98357_bt_sco_ops,\n\t\tSND_SOC_DAILINK_REG(playback2),\n\t},\n\t{\n\t\t.name = \"Playback_3\",\n\t\t.stream_name = \"Playback_3\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback3),\n\t},\n\t{\n\t\t.name = \"Capture_1\",\n\t\t.stream_name = \"Capture_1\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ops = &mt8183_da7219_max98357_bt_sco_ops,\n\t\tSND_SOC_DAILINK_REG(capture1),\n\t},\n\t{\n\t\t.name = \"Capture_2\",\n\t\t.stream_name = \"Capture_2\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture2),\n\t},\n\t{\n\t\t.name = \"Capture_3\",\n\t\t.stream_name = \"Capture_3\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ops = &mt8183_da7219_max98357_ops,\n\t\tSND_SOC_DAILINK_REG(capture3),\n\t},\n\t{\n\t\t.name = \"Capture_Mono_1\",\n\t\t.stream_name = \"Capture_Mono_1\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture_mono),\n\t},\n\t{\n\t\t.name = \"Playback_HDMI\",\n\t\t.stream_name = \"Playback_HDMI\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback_hdmi),\n\t},\n\t \n\t{\n\t\t.name = \"Primary Codec\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(primary_codec),\n\t},\n\t{\n\t\t.name = \"PCM 1\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(pcm1),\n\t},\n\t{\n\t\t.name = \"PCM 2\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(pcm2),\n\t},\n\t{\n\t\t.name = \"I2S0\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\tSND_SOC_DAILINK_REG(i2s0),\n\t},\n\t{\n\t\t.name = \"I2S1\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\tSND_SOC_DAILINK_REG(i2s1),\n\t},\n\t{\n\t\t.name = \"I2S2\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_da7219_i2s_ops,\n\t\t.init = &mt8183_da7219_init,\n\t\tSND_SOC_DAILINK_REG(i2s2),\n\t},\n\t{\n\t\t.name = \"I2S3\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t},\n\t{\n\t\t.name = \"I2S5\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\t.init = &mt8183_bt_init,\n\t\tSND_SOC_DAILINK_REG(i2s5),\n\t},\n\t{\n\t\t.name = \"TDM\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\t   SND_SOC_DAIFMT_IB_IF |\n\t\t\t   SND_SOC_DAIFMT_CBM_CFM,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ignore = 1,\n\t\t.init = mt8183_da7219_max98357_hdmi_init,\n\t\tSND_SOC_DAILINK_REG(tdm),\n\t},\n};\n\nstatic int\nmt8183_da7219_max98357_headset_init(struct snd_soc_component *component)\n{\n\tint ret;\n\tstruct mt8183_da7219_max98357_priv *priv =\n\t\t\tsnd_soc_card_get_drvdata(component->card);\n\n\t \n\tret = snd_soc_card_jack_new_pins(component->card,\n\t\t\t\t\t \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET |\n\t\t\t\t\t SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t SND_JACK_BTN_2 | SND_JACK_BTN_3 |\n\t\t\t\t\t SND_JACK_LINEOUT,\n\t\t\t\t\t &priv->headset_jack,\n\t\t\t\t\t mt8183_da7219_max98357_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(mt8183_da7219_max98357_jack_pins));\n\tif (ret)\n\t\treturn ret;\n\n\tsnd_jack_set_key(\n\t\tpriv->headset_jack.jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\tsnd_jack_set_key(\n\t\tpriv->headset_jack.jack, SND_JACK_BTN_1, KEY_VOLUMEUP);\n\tsnd_jack_set_key(\n\t\tpriv->headset_jack.jack, SND_JACK_BTN_2, KEY_VOLUMEDOWN);\n\tsnd_jack_set_key(\n\t\tpriv->headset_jack.jack, SND_JACK_BTN_3, KEY_VOICECOMMAND);\n\n\tsnd_soc_component_set_jack(component, &priv->headset_jack, NULL);\n\n\treturn 0;\n}\n\nstatic struct snd_soc_aux_dev mt8183_da7219_max98357_headset_dev = {\n\t.dlc = COMP_EMPTY(),\n\t.init = mt8183_da7219_max98357_headset_init,\n};\n\nstatic struct snd_soc_codec_conf mt6358_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"mt6358-sound\"),\n\t\t.name_prefix = \"Mt6358\",\n\t},\n};\n\nstatic const struct snd_kcontrol_new mt8183_da7219_max98357_snd_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Speakers\"),\n\tSOC_DAPM_PIN_SWITCH(\"Line Out\"),\n};\n\nstatic const\nstruct snd_soc_dapm_widget mt8183_da7219_max98357_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_SPK(\"Speakers\", NULL),\n\tSND_SOC_DAPM_SPK(\"Line Out\", NULL),\n\tSND_SOC_DAPM_PINCTRL(\"TDM_OUT_PINCTRL\",\n\t\t\t     \"aud_tdm_out_on\", \"aud_tdm_out_off\"),\n};\n\nstatic const struct snd_soc_dapm_route mt8183_da7219_max98357_dapm_routes[] = {\n\t{\"Speakers\", NULL, \"Speaker\"},\n\t{\"I2S Playback\", NULL, \"TDM_OUT_PINCTRL\"},\n};\n\nstatic struct snd_soc_card mt8183_da7219_max98357_card = {\n\t.name = \"mt8183_da7219_max98357\",\n\t.owner = THIS_MODULE,\n\t.controls = mt8183_da7219_max98357_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_da7219_max98357_snd_controls),\n\t.dapm_widgets = mt8183_da7219_max98357_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_da7219_max98357_dapm_widgets),\n\t.dapm_routes = mt8183_da7219_max98357_dapm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt8183_da7219_max98357_dapm_routes),\n\t.dai_link = mt8183_da7219_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_da7219_dai_links),\n\t.aux_dev = &mt8183_da7219_max98357_headset_dev,\n\t.num_aux_devs = 1,\n\t.codec_conf = mt6358_codec_conf,\n\t.num_configs = ARRAY_SIZE(mt6358_codec_conf),\n};\n\nstatic struct snd_soc_codec_conf mt8183_da7219_rt1015_codec_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(\"mt6358-sound\"),\n\t\t.name_prefix = \"Mt6358\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015_DEV0_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015_DEV1_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n};\n\nstatic const struct snd_kcontrol_new mt8183_da7219_rt1015_snd_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n\tSOC_DAPM_PIN_SWITCH(\"Left Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Right Spk\"),\n\tSOC_DAPM_PIN_SWITCH(\"Line Out\"),\n};\n\nstatic const\nstruct snd_soc_dapm_widget mt8183_da7219_rt1015_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_SPK(\"Left Spk\", NULL),\n\tSND_SOC_DAPM_SPK(\"Right Spk\", NULL),\n\tSND_SOC_DAPM_LINE(\"Line Out\", NULL),\n\tSND_SOC_DAPM_PINCTRL(\"TDM_OUT_PINCTRL\",\n\t\t\t     \"aud_tdm_out_on\", \"aud_tdm_out_off\"),\n};\n\nstatic const struct snd_soc_dapm_route mt8183_da7219_rt1015_dapm_routes[] = {\n\t{\"Left Spk\", NULL, \"Left SPO\"},\n\t{\"Right Spk\", NULL, \"Right SPO\"},\n\t{\"I2S Playback\", NULL, \"TDM_OUT_PINCTRL\"},\n};\n\nstatic struct snd_soc_card mt8183_da7219_rt1015_card = {\n\t.name = \"mt8183_da7219_rt1015\",\n\t.owner = THIS_MODULE,\n\t.controls = mt8183_da7219_rt1015_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_da7219_rt1015_snd_controls),\n\t.dapm_widgets = mt8183_da7219_rt1015_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_da7219_rt1015_dapm_widgets),\n\t.dapm_routes = mt8183_da7219_rt1015_dapm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt8183_da7219_rt1015_dapm_routes),\n\t.dai_link = mt8183_da7219_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_da7219_dai_links),\n\t.aux_dev = &mt8183_da7219_max98357_headset_dev,\n\t.num_aux_devs = 1,\n\t.codec_conf = mt8183_da7219_rt1015_codec_conf,\n\t.num_configs = ARRAY_SIZE(mt8183_da7219_rt1015_codec_conf),\n};\n\nstatic struct snd_soc_card mt8183_da7219_rt1015p_card = {\n\t.name = \"mt8183_da7219_rt1015p\",\n\t.owner = THIS_MODULE,\n\t.controls = mt8183_da7219_max98357_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_da7219_max98357_snd_controls),\n\t.dapm_widgets = mt8183_da7219_max98357_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_da7219_max98357_dapm_widgets),\n\t.dapm_routes = mt8183_da7219_max98357_dapm_routes,\n\t.num_dapm_routes = ARRAY_SIZE(mt8183_da7219_max98357_dapm_routes),\n\t.dai_link = mt8183_da7219_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_da7219_dai_links),\n\t.aux_dev = &mt8183_da7219_max98357_headset_dev,\n\t.num_aux_devs = 1,\n\t.codec_conf = mt6358_codec_conf,\n\t.num_configs = ARRAY_SIZE(mt6358_codec_conf),\n};\n\nstatic int mt8183_da7219_max98357_dev_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card;\n\tstruct device_node *platform_node, *hdmi_codec;\n\tstruct snd_soc_dai_link *dai_link;\n\tstruct mt8183_da7219_max98357_priv *priv;\n\tstruct pinctrl *pinctrl;\n\tint ret, i;\n\n\tplatform_node = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t\t \"mediatek,platform\", 0);\n\tif (!platform_node) {\n\t\tdev_err(&pdev->dev, \"Property 'platform' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tcard = (struct snd_soc_card *)of_device_get_match_data(&pdev->dev);\n\tif (!card) {\n\t\tret = -EINVAL;\n\t\tgoto put_platform_node;\n\t}\n\n\tcard->dev = &pdev->dev;\n\n\thdmi_codec = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t      \"mediatek,hdmi-codec\", 0);\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (strcmp(dai_link->name, \"I2S3\") == 0) {\n\t\t\tif (card == &mt8183_da7219_max98357_card) {\n\t\t\t\tdai_link->be_hw_params_fixup =\n\t\t\t\t\tmt8183_i2s_hw_params_fixup;\n\t\t\t\tdai_link->ops = &mt8183_da7219_i2s_ops;\n\t\t\t\tdai_link->cpus = i2s3_max98357a_cpus;\n\t\t\t\tdai_link->num_cpus =\n\t\t\t\t\tARRAY_SIZE(i2s3_max98357a_cpus);\n\t\t\t\tdai_link->codecs = i2s3_max98357a_codecs;\n\t\t\t\tdai_link->num_codecs =\n\t\t\t\t\tARRAY_SIZE(i2s3_max98357a_codecs);\n\t\t\t\tdai_link->platforms = i2s3_max98357a_platforms;\n\t\t\t\tdai_link->num_platforms =\n\t\t\t\t\tARRAY_SIZE(i2s3_max98357a_platforms);\n\t\t\t} else if (card == &mt8183_da7219_rt1015_card) {\n\t\t\t\tdai_link->be_hw_params_fixup =\n\t\t\t\t\tmt8183_rt1015_i2s_hw_params_fixup;\n\t\t\t\tdai_link->ops = &mt8183_da7219_rt1015_i2s_ops;\n\t\t\t\tdai_link->cpus = i2s3_rt1015_cpus;\n\t\t\t\tdai_link->num_cpus =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015_cpus);\n\t\t\t\tdai_link->codecs = i2s3_rt1015_codecs;\n\t\t\t\tdai_link->num_codecs =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015_codecs);\n\t\t\t\tdai_link->platforms = i2s3_rt1015_platforms;\n\t\t\t\tdai_link->num_platforms =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015_platforms);\n\t\t\t} else if (card == &mt8183_da7219_rt1015p_card) {\n\t\t\t\tdai_link->be_hw_params_fixup =\n\t\t\t\t\tmt8183_rt1015_i2s_hw_params_fixup;\n\t\t\t\tdai_link->ops = &mt8183_da7219_i2s_ops;\n\t\t\t\tdai_link->cpus = i2s3_rt1015p_cpus;\n\t\t\t\tdai_link->num_cpus =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015p_cpus);\n\t\t\t\tdai_link->codecs = i2s3_rt1015p_codecs;\n\t\t\t\tdai_link->num_codecs =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015p_codecs);\n\t\t\t\tdai_link->platforms = i2s3_rt1015p_platforms;\n\t\t\t\tdai_link->num_platforms =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015p_platforms);\n\t\t\t}\n\t\t}\n\n\t\tif (hdmi_codec && strcmp(dai_link->name, \"TDM\") == 0) {\n\t\t\tdai_link->codecs->of_node = hdmi_codec;\n\t\t\tdai_link->ignore = 0;\n\t\t}\n\n\t\tif (!dai_link->platforms->name)\n\t\t\tdai_link->platforms->of_node = platform_node;\n\t}\n\n\tmt8183_da7219_max98357_headset_dev.dlc.of_node =\n\t\tof_parse_phandle(pdev->dev.of_node,\n\t\t\t\t \"mediatek,headset-codec\", 0);\n\tif (!mt8183_da7219_max98357_headset_dev.dlc.of_node) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Property 'mediatek,headset-codec' missing/invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto put_hdmi_codec;\n\t}\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv) {\n\t\tret = -ENOMEM;\n\t\tgoto put_hdmi_codec;\n\t}\n\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tpinctrl = devm_pinctrl_get_select(&pdev->dev, PINCTRL_STATE_DEFAULT);\n\tif (IS_ERR(pinctrl)) {\n\t\tret = PTR_ERR(pinctrl);\n\t\tdev_err(&pdev->dev, \"%s failed to select default state %d\\n\",\n\t\t\t__func__, ret);\n\t\tgoto put_hdmi_codec;\n\t}\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\n\nput_hdmi_codec:\n\tof_node_put(hdmi_codec);\nput_platform_node:\n\tof_node_put(platform_node);\n\treturn ret;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id mt8183_da7219_max98357_dt_match[] = {\n\t{\n\t\t.compatible = \"mediatek,mt8183_da7219_max98357\",\n\t\t.data = &mt8183_da7219_max98357_card,\n\t},\n\t{\n\t\t.compatible = \"mediatek,mt8183_da7219_rt1015\",\n\t\t.data = &mt8183_da7219_rt1015_card,\n\t},\n\t{\n\t\t.compatible = \"mediatek,mt8183_da7219_rt1015p\",\n\t\t.data = &mt8183_da7219_rt1015p_card,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mt8183_da7219_max98357_dt_match);\n#endif\n\nstatic struct platform_driver mt8183_da7219_max98357_driver = {\n\t.driver = {\n\t\t.name = \"mt8183_da7219\",\n#ifdef CONFIG_OF\n\t\t.of_match_table = mt8183_da7219_max98357_dt_match,\n#endif\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = mt8183_da7219_max98357_dev_probe,\n};\n\nmodule_platform_driver(mt8183_da7219_max98357_driver);\n\n \nMODULE_DESCRIPTION(\"MT8183-DA7219-MAX98357 ALSA SoC machine driver\");\nMODULE_AUTHOR(\"Shunli Wang <shunli.wang@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"mt8183_da7219_max98357 soc card\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}