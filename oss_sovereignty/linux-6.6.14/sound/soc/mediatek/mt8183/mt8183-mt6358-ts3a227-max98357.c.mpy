{
  "module_name": "mt8183-mt6358-ts3a227-max98357.c",
  "hash_id": "f65d7781ef7b2a3ab451b1ad45529f77847f9eb4accaaca018133da425a0b7c1",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8183/mt8183-mt6358-ts3a227-max98357.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/pinctrl/consumer.h>\n#include <sound/jack.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#include \"../../codecs/rt1015.h\"\n#include \"../../codecs/ts3a227e.h\"\n#include \"../common/mtk-afe-platform-driver.h\"\n#include \"mt8183-afe-common.h\"\n\n#define RT1015_CODEC_DAI \"rt1015-aif\"\n#define RT1015_DEV0_NAME \"rt1015.6-0028\"\n#define RT1015_DEV1_NAME \"rt1015.6-0029\"\n\nenum PINCTRL_PIN_STATE {\n\tPIN_STATE_DEFAULT = 0,\n\tPIN_TDM_OUT_ON,\n\tPIN_TDM_OUT_OFF,\n\tPIN_WOV,\n\tPIN_STATE_MAX\n};\n\nstatic const char * const mt8183_pin_str[PIN_STATE_MAX] = {\n\t\"default\", \"aud_tdm_out_on\", \"aud_tdm_out_off\", \"wov\",\n};\n\nstruct mt8183_mt6358_ts3a227_max98357_priv {\n\tstruct pinctrl *pinctrl;\n\tstruct pinctrl_state *pin_states[PIN_STATE_MAX];\n\tstruct snd_soc_jack headset_jack, hdmi_jack;\n};\n\nstatic int mt8183_mt6358_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int rate = params_rate(params);\n\tunsigned int mclk_fs_ratio = 128;\n\tunsigned int mclk_fs = rate * mclk_fs_ratio;\n\n\treturn snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0),\n\t\t\t\t      0, mclk_fs, SND_SOC_CLOCK_OUT);\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_i2s_ops = {\n\t.hw_params = mt8183_mt6358_i2s_hw_params,\n};\n\nstatic int\nmt8183_mt6358_rt1015_i2s_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tunsigned int rate = params_rate(params);\n\tunsigned int mclk_fs_ratio = 128;\n\tunsigned int mclk_fs = rate * mclk_fs_ratio;\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct snd_soc_dai *codec_dai;\n\tint ret, i;\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\tret = snd_soc_dai_set_pll(codec_dai, 0, RT1015_PLL_S_BCLK,\n\t\t\t\trate * 64, rate * 256);\n\t\tif (ret < 0) {\n\t\t\tdev_err(card->dev, \"failed to set pll\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, RT1015_SCLK_S_PLL,\n\t\t\t\trate * 256, SND_SOC_CLOCK_IN);\n\t\tif (ret < 0) {\n\t\t\tdev_err(card->dev, \"failed to set sysclk\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(rtd, 0),\n\t\t\t\t      0, mclk_fs, SND_SOC_CLOCK_OUT);\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_rt1015_i2s_ops = {\n\t.hw_params = mt8183_mt6358_rt1015_i2s_hw_params,\n};\n\nstatic int mt8183_i2s_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t      struct snd_pcm_hw_params *params)\n{\n\tdev_dbg(rtd->dev, \"%s(), fix format to S32_LE\\n\", __func__);\n\n\t \n\tsnd_mask_reset_range(hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT),\n\t\t\t     0, (__force unsigned int)SNDRV_PCM_FORMAT_LAST);\n\n\tparams_set_format(params, SNDRV_PCM_FORMAT_S32_LE);\n\treturn 0;\n}\n\nstatic int mt8183_rt1015_i2s_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t\t     struct snd_pcm_hw_params *params)\n{\n\tdev_dbg(rtd->dev, \"%s(), fix format to S24_LE\\n\", __func__);\n\n\t \n\tsnd_mask_reset_range(hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT),\n\t\t\t     0, (__force unsigned int)SNDRV_PCM_FORMAT_LAST);\n\n\tparams_set_format(params, SNDRV_PCM_FORMAT_S24_LE);\n\treturn 0;\n}\n\nstatic int\nmt8183_mt6358_startup(struct snd_pcm_substream *substream)\n{\n\tstatic const unsigned int rates[] = {\n\t\t48000,\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_rates = {\n\t\t.count = ARRAY_SIZE(rates),\n\t\t.list  = rates,\n\t\t.mask = 0,\n\t};\n\tstatic const unsigned int channels[] = {\n\t\t2,\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_channels = {\n\t\t.count = ARRAY_SIZE(channels),\n\t\t.list = channels,\n\t\t.mask = 0,\n\t};\n\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\t\t   SNDRV_PCM_HW_PARAM_RATE, &constraints_rates);\n\truntime->hw.channels_max = 2;\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\t\t   SNDRV_PCM_HW_PARAM_CHANNELS,\n\t\t\t\t   &constraints_channels);\n\n\truntime->hw.formats = SNDRV_PCM_FMTBIT_S16_LE;\n\tsnd_pcm_hw_constraint_msbits(runtime, 0, 16, 16);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_ops = {\n\t.startup = mt8183_mt6358_startup,\n};\n\nstatic int\nmt8183_mt6358_ts3a227_max98357_bt_sco_startup(\n\tstruct snd_pcm_substream *substream)\n{\n\tstatic const unsigned int rates[] = {\n\t\t8000, 16000\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_rates = {\n\t\t.count = ARRAY_SIZE(rates),\n\t\t.list  = rates,\n\t\t.mask = 0,\n\t};\n\tstatic const unsigned int channels[] = {\n\t\t1,\n\t};\n\tstatic const struct snd_pcm_hw_constraint_list constraints_channels = {\n\t\t.count = ARRAY_SIZE(channels),\n\t\t.list = channels,\n\t\t.mask = 0,\n\t};\n\n\tstruct snd_pcm_runtime *runtime = substream->runtime;\n\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_RATE, &constraints_rates);\n\truntime->hw.channels_max = 1;\n\tsnd_pcm_hw_constraint_list(runtime, 0,\n\t\t\tSNDRV_PCM_HW_PARAM_CHANNELS,\n\t\t\t&constraints_channels);\n\n\truntime->hw.formats = SNDRV_PCM_FMTBIT_S16_LE;\n\tsnd_pcm_hw_constraint_msbits(runtime, 0, 16, 16);\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_ts3a227_max98357_bt_sco_ops = {\n\t.startup = mt8183_mt6358_ts3a227_max98357_bt_sco_startup,\n};\n\n \nSND_SOC_DAILINK_DEFS(playback1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback3,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL3\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture3,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL3\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture_mono,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL_MONO_1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(playback_hdmi,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"HDMI\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(wake_on_voice,\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\n \nSND_SOC_DAILINK_DEFS(primary_codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"ADDA\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"mt6358-sound\", \"mt6358-snd-codec-aif1\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(pcm1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM 1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(pcm2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"PCM 2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s0,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S0\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"bt-sco\", \"bt-sco-pcm-wb\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s1,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s2,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S2\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s3_max98357a,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"max98357a\", \"HiFi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s3_rt1015,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(RT1015_DEV0_NAME, RT1015_CODEC_DAI),\n\t\t\t   COMP_CODEC(RT1015_DEV1_NAME, RT1015_CODEC_DAI)),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s3_rt1015p,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S3\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"rt1015p\", \"HiFi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(i2s5,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"I2S5\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(\"bt-sco\", \"bt-sco-pcm-wb\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(tdm,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"TDM\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"i2s-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic int mt8183_mt6358_tdm_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv =\n\t\tsnd_soc_card_get_drvdata(rtd->card);\n\tint ret;\n\n\tif (IS_ERR(priv->pin_states[PIN_TDM_OUT_ON]))\n\t\treturn PTR_ERR(priv->pin_states[PIN_TDM_OUT_ON]);\n\n\tret = pinctrl_select_state(priv->pinctrl,\n\t\t\t\t   priv->pin_states[PIN_TDM_OUT_ON]);\n\tif (ret)\n\t\tdev_err(rtd->card->dev, \"%s failed to select state %d\\n\",\n\t\t\t__func__, ret);\n\n\treturn ret;\n}\n\nstatic void mt8183_mt6358_tdm_shutdown(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv =\n\t\tsnd_soc_card_get_drvdata(rtd->card);\n\tint ret;\n\n\tif (IS_ERR(priv->pin_states[PIN_TDM_OUT_OFF]))\n\t\treturn;\n\n\tret = pinctrl_select_state(priv->pinctrl,\n\t\t\t\t   priv->pin_states[PIN_TDM_OUT_OFF]);\n\tif (ret)\n\t\tdev_err(rtd->card->dev, \"%s failed to select state %d\\n\",\n\t\t\t__func__, ret);\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_tdm_ops = {\n\t.startup = mt8183_mt6358_tdm_startup,\n\t.shutdown = mt8183_mt6358_tdm_shutdown,\n};\n\nstatic int\nmt8183_mt6358_ts3a227_max98357_wov_startup(\n\tstruct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv =\n\t\t\tsnd_soc_card_get_drvdata(card);\n\n\treturn pinctrl_select_state(priv->pinctrl,\n\t\t\t\t    priv->pin_states[PIN_WOV]);\n}\n\nstatic void\nmt8183_mt6358_ts3a227_max98357_wov_shutdown(\n\tstruct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv =\n\t\t\tsnd_soc_card_get_drvdata(card);\n\tint ret;\n\n\tret = pinctrl_select_state(priv->pinctrl,\n\t\t\t\t   priv->pin_states[PIN_STATE_DEFAULT]);\n\tif (ret)\n\t\tdev_err(card->dev, \"%s failed to select state %d\\n\",\n\t\t\t__func__, ret);\n}\n\nstatic const struct snd_soc_ops mt8183_mt6358_ts3a227_max98357_wov_ops = {\n\t.startup = mt8183_mt6358_ts3a227_max98357_wov_startup,\n\t.shutdown = mt8183_mt6358_ts3a227_max98357_wov_shutdown,\n};\n\nstatic int\nmt8183_mt6358_ts3a227_max98357_hdmi_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv =\n\t\tsnd_soc_card_get_drvdata(rtd->card);\n\tint ret;\n\n\tret = snd_soc_card_jack_new(rtd->card, \"HDMI Jack\", SND_JACK_LINEOUT,\n\t\t\t\t    &priv->hdmi_jack);\n\tif (ret)\n\t\treturn ret;\n\n\treturn snd_soc_component_set_jack(asoc_rtd_to_codec(rtd, 0)->component,\n\t\t\t\t\t  &priv->hdmi_jack, NULL);\n}\n\nstatic int mt8183_bt_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *cmpnt_afe =\n\t\tsnd_soc_rtdcom_lookup(rtd, AFE_PCM_NAME);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt_afe);\n\tint ret;\n\n\tret = mt8183_dai_i2s_set_share(afe, \"I2S5\", \"I2S0\");\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Failed to set up shared clocks\\n\");\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int mt8183_i2s2_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_component *cmpnt_afe =\n\t\tsnd_soc_rtdcom_lookup(rtd, AFE_PCM_NAME);\n\tstruct mtk_base_afe *afe = snd_soc_component_get_drvdata(cmpnt_afe);\n\tint ret;\n\n\tret = mt8183_dai_i2s_set_share(afe, \"I2S2\", \"I2S3\");\n\tif (ret) {\n\t\tdev_err(rtd->dev, \"Failed to set up shared clocks\\n\");\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic struct snd_soc_dai_link mt8183_mt6358_ts3a227_dai_links[] = {\n\t \n\t{\n\t\t.name = \"Playback_1\",\n\t\t.stream_name = \"Playback_1\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ops = &mt8183_mt6358_ops,\n\t\tSND_SOC_DAILINK_REG(playback1),\n\t},\n\t{\n\t\t.name = \"Playback_2\",\n\t\t.stream_name = \"Playback_2\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ops = &mt8183_mt6358_ts3a227_max98357_bt_sco_ops,\n\t\tSND_SOC_DAILINK_REG(playback2),\n\t},\n\t{\n\t\t.name = \"Playback_3\",\n\t\t.stream_name = \"Playback_3\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback3),\n\t},\n\t{\n\t\t.name = \"Capture_1\",\n\t\t.stream_name = \"Capture_1\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ops = &mt8183_mt6358_ts3a227_max98357_bt_sco_ops,\n\t\tSND_SOC_DAILINK_REG(capture1),\n\t},\n\t{\n\t\t.name = \"Capture_2\",\n\t\t.stream_name = \"Capture_2\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture2),\n\t},\n\t{\n\t\t.name = \"Capture_3\",\n\t\t.stream_name = \"Capture_3\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ops = &mt8183_mt6358_ops,\n\t\tSND_SOC_DAILINK_REG(capture3),\n\t},\n\t{\n\t\t.name = \"Capture_Mono_1\",\n\t\t.stream_name = \"Capture_Mono_1\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture_mono),\n\t},\n\t{\n\t\t.name = \"Playback_HDMI\",\n\t\t.stream_name = \"Playback_HDMI\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_PRE,\n\t\t\t    SND_SOC_DPCM_TRIGGER_PRE},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback_hdmi),\n\t},\n\t{\n\t\t.name = \"Wake on Voice\",\n\t\t.stream_name = \"Wake on Voice\",\n\t\t.ignore_suspend = 1,\n\t\t.ignore = 1,\n\t\tSND_SOC_DAILINK_REG(wake_on_voice),\n\t\t.ops = &mt8183_mt6358_ts3a227_max98357_wov_ops,\n\t},\n\n\t \n\t{\n\t\t.name = \"Primary Codec\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(primary_codec),\n\t},\n\t{\n\t\t.name = \"PCM 1\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(pcm1),\n\t},\n\t{\n\t\t.name = \"PCM 2\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\tSND_SOC_DAILINK_REG(pcm2),\n\t},\n\t{\n\t\t.name = \"I2S0\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\tSND_SOC_DAILINK_REG(i2s0),\n\t},\n\t{\n\t\t.name = \"I2S1\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\tSND_SOC_DAILINK_REG(i2s1),\n\t},\n\t{\n\t\t.name = \"I2S2\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_capture = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\t.init = &mt8183_i2s2_init,\n\t\tSND_SOC_DAILINK_REG(i2s2),\n\t},\n\t{\n\t\t.name = \"I2S3\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t},\n\t{\n\t\t.name = \"I2S5\",\n\t\t.no_pcm = 1,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t\t.ops = &mt8183_mt6358_i2s_ops,\n\t\t.init = &mt8183_bt_init,\n\t\tSND_SOC_DAILINK_REG(i2s5),\n\t},\n\t{\n\t\t.name = \"TDM\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\t   SND_SOC_DAIFMT_IB_IF |\n\t\t\t   SND_SOC_DAIFMT_CBM_CFM,\n\t\t.dpcm_playback = 1,\n\t\t.ignore_suspend = 1,\n\t\t.be_hw_params_fixup = mt8183_i2s_hw_params_fixup,\n\t\t.ops = &mt8183_mt6358_tdm_ops,\n\t\t.ignore = 1,\n\t\t.init = mt8183_mt6358_ts3a227_max98357_hdmi_init,\n\t\tSND_SOC_DAILINK_REG(tdm),\n\t},\n};\n\nstatic const\nstruct snd_kcontrol_new mt8183_mt6358_ts3a227_max98357_snd_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"Headset Mic\"),\n};\n\nstatic const\nstruct snd_soc_dapm_widget mt8183_mt6358_ts3a227_max98357_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n};\n\nstatic struct snd_soc_jack_pin mt8183_mt6358_ts3a227_max98357_jack_pins[] = {\n\t{\n\t\t.pin\t= \"Headphone\",\n\t\t.mask\t= SND_JACK_HEADPHONE,\n\t},\n\t{\n\t\t.pin\t= \"Headset Mic\",\n\t\t.mask\t= SND_JACK_MICROPHONE,\n\t},\n};\n\nstatic struct snd_soc_card mt8183_mt6358_ts3a227_max98357_card = {\n\t.name = \"mt8183_mt6358_ts3a227_max98357\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt8183_mt6358_ts3a227_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_mt6358_ts3a227_dai_links),\n\t.controls = mt8183_mt6358_ts3a227_max98357_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_snd_controls),\n\t.dapm_widgets = mt8183_mt6358_ts3a227_max98357_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_dapm_widgets),\n};\n\nstatic struct snd_soc_card mt8183_mt6358_ts3a227_max98357b_card = {\n\t.name = \"mt8183_mt6358_ts3a227_max98357b\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt8183_mt6358_ts3a227_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_mt6358_ts3a227_dai_links),\n\t.controls = mt8183_mt6358_ts3a227_max98357_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_snd_controls),\n\t.dapm_widgets = mt8183_mt6358_ts3a227_max98357_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_dapm_widgets),\n};\n\nstatic struct snd_soc_codec_conf mt8183_mt6358_ts3a227_rt1015_amp_conf[] = {\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015_DEV0_NAME),\n\t\t.name_prefix = \"Left\",\n\t},\n\t{\n\t\t.dlc = COMP_CODEC_CONF(RT1015_DEV1_NAME),\n\t\t.name_prefix = \"Right\",\n\t},\n};\n\nstatic struct snd_soc_card mt8183_mt6358_ts3a227_rt1015_card = {\n\t.name = \"mt8183_mt6358_ts3a227_rt1015\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt8183_mt6358_ts3a227_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_mt6358_ts3a227_dai_links),\n\t.codec_conf = mt8183_mt6358_ts3a227_rt1015_amp_conf,\n\t.num_configs = ARRAY_SIZE(mt8183_mt6358_ts3a227_rt1015_amp_conf),\n\t.controls = mt8183_mt6358_ts3a227_max98357_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_snd_controls),\n\t.dapm_widgets = mt8183_mt6358_ts3a227_max98357_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_dapm_widgets),\n};\n\nstatic struct snd_soc_card mt8183_mt6358_ts3a227_rt1015p_card = {\n\t.name = \"mt8183_mt6358_ts3a227_rt1015p\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt8183_mt6358_ts3a227_dai_links,\n\t.num_links = ARRAY_SIZE(mt8183_mt6358_ts3a227_dai_links),\n\t.controls = mt8183_mt6358_ts3a227_max98357_snd_controls,\n\t.num_controls = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_snd_controls),\n\t.dapm_widgets = mt8183_mt6358_ts3a227_max98357_dapm_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_dapm_widgets),\n};\n\nstatic int\nmt8183_mt6358_ts3a227_max98357_headset_init(struct snd_soc_component *component)\n{\n\tint ret;\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv =\n\t\t\tsnd_soc_card_get_drvdata(component->card);\n\n\t \n\tret = snd_soc_card_jack_new_pins(component->card,\n\t\t\t\t\t \"Headset Jack\",\n\t\t\t\t\t SND_JACK_HEADSET |\n\t\t\t\t\t SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t SND_JACK_BTN_2 | SND_JACK_BTN_3,\n\t\t\t\t\t &priv->headset_jack,\n\t\t\t\t\t mt8183_mt6358_ts3a227_max98357_jack_pins,\n\t\t\t\t\t ARRAY_SIZE(mt8183_mt6358_ts3a227_max98357_jack_pins));\n\tif (ret)\n\t\treturn ret;\n\n\tret = ts3a227e_enable_jack_detect(component, &priv->headset_jack);\n\n\treturn ret;\n}\n\nstatic struct snd_soc_aux_dev mt8183_mt6358_ts3a227_max98357_headset_dev = {\n\t.dlc = COMP_EMPTY(),\n\t.init = mt8183_mt6358_ts3a227_max98357_headset_init,\n};\n\nstatic int\nmt8183_mt6358_ts3a227_max98357_dev_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card;\n\tstruct device_node *platform_node, *ec_codec, *hdmi_codec;\n\tstruct snd_soc_dai_link *dai_link;\n\tstruct mt8183_mt6358_ts3a227_max98357_priv *priv;\n\tint ret, i;\n\n\tplatform_node = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t\t \"mediatek,platform\", 0);\n\tif (!platform_node) {\n\t\tdev_err(&pdev->dev, \"Property 'platform' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tcard = (struct snd_soc_card *)of_device_get_match_data(&pdev->dev);\n\tif (!card) {\n\t\tof_node_put(platform_node);\n\t\treturn -EINVAL;\n\t}\n\tcard->dev = &pdev->dev;\n\n\tec_codec = of_parse_phandle(pdev->dev.of_node, \"mediatek,ec-codec\", 0);\n\thdmi_codec = of_parse_phandle(pdev->dev.of_node,\n\t\t\t\t      \"mediatek,hdmi-codec\", 0);\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (ec_codec && strcmp(dai_link->name, \"Wake on Voice\") == 0) {\n\t\t\tdai_link->cpus[0].name = NULL;\n\t\t\tdai_link->cpus[0].of_node = ec_codec;\n\t\t\tdai_link->cpus[0].dai_name = NULL;\n\t\t\tdai_link->codecs[0].name = NULL;\n\t\t\tdai_link->codecs[0].of_node = ec_codec;\n\t\t\tdai_link->codecs[0].dai_name = \"Wake on Voice\";\n\t\t\tdai_link->platforms[0].of_node = ec_codec;\n\t\t\tdai_link->ignore = 0;\n\t\t}\n\n\t\tif (strcmp(dai_link->name, \"I2S3\") == 0) {\n\t\t\tif (card == &mt8183_mt6358_ts3a227_max98357_card ||\n\t\t\t    card == &mt8183_mt6358_ts3a227_max98357b_card) {\n\t\t\t\tdai_link->be_hw_params_fixup =\n\t\t\t\t\tmt8183_i2s_hw_params_fixup;\n\t\t\t\tdai_link->ops = &mt8183_mt6358_i2s_ops;\n\t\t\t\tdai_link->cpus = i2s3_max98357a_cpus;\n\t\t\t\tdai_link->num_cpus =\n\t\t\t\t\tARRAY_SIZE(i2s3_max98357a_cpus);\n\t\t\t\tdai_link->codecs = i2s3_max98357a_codecs;\n\t\t\t\tdai_link->num_codecs =\n\t\t\t\t\tARRAY_SIZE(i2s3_max98357a_codecs);\n\t\t\t\tdai_link->platforms = i2s3_max98357a_platforms;\n\t\t\t\tdai_link->num_platforms =\n\t\t\t\t\tARRAY_SIZE(i2s3_max98357a_platforms);\n\t\t\t} else if (card == &mt8183_mt6358_ts3a227_rt1015_card) {\n\t\t\t\tdai_link->be_hw_params_fixup =\n\t\t\t\t\tmt8183_rt1015_i2s_hw_params_fixup;\n\t\t\t\tdai_link->ops = &mt8183_mt6358_rt1015_i2s_ops;\n\t\t\t\tdai_link->cpus = i2s3_rt1015_cpus;\n\t\t\t\tdai_link->num_cpus =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015_cpus);\n\t\t\t\tdai_link->codecs = i2s3_rt1015_codecs;\n\t\t\t\tdai_link->num_codecs =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015_codecs);\n\t\t\t\tdai_link->platforms = i2s3_rt1015_platforms;\n\t\t\t\tdai_link->num_platforms =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015_platforms);\n\t\t\t} else if (card == &mt8183_mt6358_ts3a227_rt1015p_card) {\n\t\t\t\tdai_link->be_hw_params_fixup =\n\t\t\t\t\tmt8183_rt1015_i2s_hw_params_fixup;\n\t\t\t\tdai_link->ops = &mt8183_mt6358_i2s_ops;\n\t\t\t\tdai_link->cpus = i2s3_rt1015p_cpus;\n\t\t\t\tdai_link->num_cpus =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015p_cpus);\n\t\t\t\tdai_link->codecs = i2s3_rt1015p_codecs;\n\t\t\t\tdai_link->num_codecs =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015p_codecs);\n\t\t\t\tdai_link->platforms = i2s3_rt1015p_platforms;\n\t\t\t\tdai_link->num_platforms =\n\t\t\t\t\tARRAY_SIZE(i2s3_rt1015p_platforms);\n\t\t\t}\n\t\t}\n\n\t\tif (card == &mt8183_mt6358_ts3a227_max98357b_card) {\n\t\t\tif (strcmp(dai_link->name, \"I2S2\") == 0 ||\n\t\t\t    strcmp(dai_link->name, \"I2S3\") == 0)\n\t\t\t\tdai_link->dai_fmt = SND_SOC_DAIFMT_LEFT_J |\n\t\t\t\t\t\t    SND_SOC_DAIFMT_NB_NF |\n\t\t\t\t\t\t    SND_SOC_DAIFMT_CBM_CFM;\n\t\t}\n\n\t\tif (hdmi_codec && strcmp(dai_link->name, \"TDM\") == 0) {\n\t\t\tdai_link->codecs->of_node = hdmi_codec;\n\t\t\tdai_link->ignore = 0;\n\t\t}\n\n\t\tif (!dai_link->platforms->name)\n\t\t\tdai_link->platforms->of_node = platform_node;\n\t}\n\n\tmt8183_mt6358_ts3a227_max98357_headset_dev.dlc.of_node =\n\t\tof_parse_phandle(pdev->dev.of_node,\n\t\t\t\t \"mediatek,headset-codec\", 0);\n\tif (mt8183_mt6358_ts3a227_max98357_headset_dev.dlc.of_node) {\n\t\tcard->aux_dev = &mt8183_mt6358_ts3a227_max98357_headset_dev;\n\t\tcard->num_aux_devs = 1;\n\t}\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tsnd_soc_card_set_drvdata(card, priv);\n\n\tpriv->pinctrl = devm_pinctrl_get(&pdev->dev);\n\tif (IS_ERR(priv->pinctrl)) {\n\t\tdev_err(&pdev->dev, \"%s devm_pinctrl_get failed\\n\",\n\t\t\t__func__);\n\t\tret = PTR_ERR(priv->pinctrl);\n\t\tgoto out;\n\t}\n\n\tfor (i = 0; i < PIN_STATE_MAX; i++) {\n\t\tpriv->pin_states[i] = pinctrl_lookup_state(priv->pinctrl,\n\t\t\t\t\t\t\t   mt8183_pin_str[i]);\n\t\tif (IS_ERR(priv->pin_states[i])) {\n\t\t\tret = PTR_ERR(priv->pin_states[i]);\n\t\t\tdev_info(&pdev->dev, \"%s Can't find pin state %s %d\\n\",\n\t\t\t\t __func__, mt8183_pin_str[i], ret);\n\t\t}\n\t}\n\n\tif (!IS_ERR(priv->pin_states[PIN_TDM_OUT_OFF])) {\n\t\tret = pinctrl_select_state(priv->pinctrl,\n\t\t\t\t\t   priv->pin_states[PIN_TDM_OUT_OFF]);\n\t\tif (ret)\n\t\t\tdev_info(&pdev->dev,\n\t\t\t\t \"%s failed to select state %d\\n\",\n\t\t\t\t __func__, ret);\n\t}\n\n\tif (!IS_ERR(priv->pin_states[PIN_STATE_DEFAULT])) {\n\t\tret = pinctrl_select_state(priv->pinctrl,\n\t\t\t\t\t   priv->pin_states[PIN_STATE_DEFAULT]);\n\t\tif (ret)\n\t\t\tdev_info(&pdev->dev,\n\t\t\t\t \"%s failed to select state %d\\n\",\n\t\t\t\t __func__, ret);\n\t}\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\nout:\n\tof_node_put(platform_node);\n\tof_node_put(ec_codec);\n\tof_node_put(hdmi_codec);\n\treturn ret;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id mt8183_mt6358_ts3a227_max98357_dt_match[] = {\n\t{\n\t\t.compatible = \"mediatek,mt8183_mt6358_ts3a227_max98357\",\n\t\t.data = &mt8183_mt6358_ts3a227_max98357_card,\n\t},\n\t{\n\t\t.compatible = \"mediatek,mt8183_mt6358_ts3a227_max98357b\",\n\t\t.data = &mt8183_mt6358_ts3a227_max98357b_card,\n\t},\n\t{\n\t\t.compatible = \"mediatek,mt8183_mt6358_ts3a227_rt1015\",\n\t\t.data = &mt8183_mt6358_ts3a227_rt1015_card,\n\t},\n\t{\n\t\t.compatible = \"mediatek,mt8183_mt6358_ts3a227_rt1015p\",\n\t\t.data = &mt8183_mt6358_ts3a227_rt1015p_card,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mt8183_mt6358_ts3a227_max98357_dt_match);\n#endif\n\nstatic struct platform_driver mt8183_mt6358_ts3a227_max98357_driver = {\n\t.driver = {\n\t\t.name = \"mt8183_mt6358_ts3a227\",\n#ifdef CONFIG_OF\n\t\t.of_match_table = mt8183_mt6358_ts3a227_max98357_dt_match,\n#endif\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = mt8183_mt6358_ts3a227_max98357_dev_probe,\n};\n\nmodule_platform_driver(mt8183_mt6358_ts3a227_max98357_driver);\n\n \nMODULE_DESCRIPTION(\"MT8183-MT6358-TS3A227-MAX98357 ALSA SoC machine driver\");\nMODULE_AUTHOR(\"Shunli Wang <shunli.wang@mediatek.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"mt8183_mt6358_ts3a227_max98357 soc card\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}