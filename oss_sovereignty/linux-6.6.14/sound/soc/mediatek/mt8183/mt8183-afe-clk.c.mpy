{
  "module_name": "mt8183-afe-clk.c",
  "hash_id": "6d2562285e849bf3ff2ce602d7c3c7df4eaa3bdcd7931f2b51bdbdd3862c69c9",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt8183/mt8183-afe-clk.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/clk.h>\n\n#include \"mt8183-afe-common.h\"\n#include \"mt8183-afe-clk.h\"\n#include \"mt8183-reg.h\"\n\nenum {\n\tCLK_AFE = 0,\n\tCLK_TML,\n\tCLK_APLL22M,\n\tCLK_APLL24M,\n\tCLK_APLL1_TUNER,\n\tCLK_APLL2_TUNER,\n\tCLK_I2S1_BCLK_SW,\n\tCLK_I2S2_BCLK_SW,\n\tCLK_I2S3_BCLK_SW,\n\tCLK_I2S4_BCLK_SW,\n\tCLK_INFRA_SYS_AUDIO,\n\tCLK_MUX_AUDIO,\n\tCLK_MUX_AUDIOINTBUS,\n\tCLK_TOP_SYSPLL_D2_D4,\n\t \n\tCLK_TOP_MUX_AUD_1,\n\tCLK_TOP_APLL1_CK,\n\tCLK_TOP_MUX_AUD_2,\n\tCLK_TOP_APLL2_CK,\n\tCLK_TOP_MUX_AUD_ENG1,\n\tCLK_TOP_APLL1_D8,\n\tCLK_TOP_MUX_AUD_ENG2,\n\tCLK_TOP_APLL2_D8,\n\tCLK_TOP_I2S0_M_SEL,\n\tCLK_TOP_I2S1_M_SEL,\n\tCLK_TOP_I2S2_M_SEL,\n\tCLK_TOP_I2S3_M_SEL,\n\tCLK_TOP_I2S4_M_SEL,\n\tCLK_TOP_I2S5_M_SEL,\n\tCLK_TOP_APLL12_DIV0,\n\tCLK_TOP_APLL12_DIV1,\n\tCLK_TOP_APLL12_DIV2,\n\tCLK_TOP_APLL12_DIV3,\n\tCLK_TOP_APLL12_DIV4,\n\tCLK_TOP_APLL12_DIVB,\n\tCLK_CLK26M,\n\tCLK_NUM\n};\n\nstatic const char *aud_clks[CLK_NUM] = {\n\t[CLK_AFE] = \"aud_afe_clk\",\n\t[CLK_TML] = \"aud_tml_clk\",\n\t[CLK_APLL22M] = \"aud_apll22m_clk\",\n\t[CLK_APLL24M] = \"aud_apll24m_clk\",\n\t[CLK_APLL1_TUNER] = \"aud_apll1_tuner_clk\",\n\t[CLK_APLL2_TUNER] = \"aud_apll2_tuner_clk\",\n\t[CLK_I2S1_BCLK_SW] = \"aud_i2s1_bclk_sw\",\n\t[CLK_I2S2_BCLK_SW] = \"aud_i2s2_bclk_sw\",\n\t[CLK_I2S3_BCLK_SW] = \"aud_i2s3_bclk_sw\",\n\t[CLK_I2S4_BCLK_SW] = \"aud_i2s4_bclk_sw\",\n\t[CLK_INFRA_SYS_AUDIO] = \"aud_infra_clk\",\n\t[CLK_MUX_AUDIO] = \"top_mux_audio\",\n\t[CLK_MUX_AUDIOINTBUS] = \"top_mux_aud_intbus\",\n\t[CLK_TOP_SYSPLL_D2_D4] = \"top_syspll_d2_d4\",\n\t[CLK_TOP_MUX_AUD_1] = \"top_mux_aud_1\",\n\t[CLK_TOP_APLL1_CK] = \"top_apll1_ck\",\n\t[CLK_TOP_MUX_AUD_2] = \"top_mux_aud_2\",\n\t[CLK_TOP_APLL2_CK] = \"top_apll2_ck\",\n\t[CLK_TOP_MUX_AUD_ENG1] = \"top_mux_aud_eng1\",\n\t[CLK_TOP_APLL1_D8] = \"top_apll1_d8\",\n\t[CLK_TOP_MUX_AUD_ENG2] = \"top_mux_aud_eng2\",\n\t[CLK_TOP_APLL2_D8] = \"top_apll2_d8\",\n\t[CLK_TOP_I2S0_M_SEL] = \"top_i2s0_m_sel\",\n\t[CLK_TOP_I2S1_M_SEL] = \"top_i2s1_m_sel\",\n\t[CLK_TOP_I2S2_M_SEL] = \"top_i2s2_m_sel\",\n\t[CLK_TOP_I2S3_M_SEL] = \"top_i2s3_m_sel\",\n\t[CLK_TOP_I2S4_M_SEL] = \"top_i2s4_m_sel\",\n\t[CLK_TOP_I2S5_M_SEL] = \"top_i2s5_m_sel\",\n\t[CLK_TOP_APLL12_DIV0] = \"top_apll12_div0\",\n\t[CLK_TOP_APLL12_DIV1] = \"top_apll12_div1\",\n\t[CLK_TOP_APLL12_DIV2] = \"top_apll12_div2\",\n\t[CLK_TOP_APLL12_DIV3] = \"top_apll12_div3\",\n\t[CLK_TOP_APLL12_DIV4] = \"top_apll12_div4\",\n\t[CLK_TOP_APLL12_DIVB] = \"top_apll12_divb\",\n\t[CLK_CLK26M] = \"top_clk26m_clk\",\n};\n\nint mt8183_init_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint i;\n\n\tafe_priv->clk = devm_kcalloc(afe->dev, CLK_NUM, sizeof(*afe_priv->clk),\n\t\t\t\t     GFP_KERNEL);\n\tif (!afe_priv->clk)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < CLK_NUM; i++) {\n\t\tafe_priv->clk[i] = devm_clk_get(afe->dev, aud_clks[i]);\n\t\tif (IS_ERR(afe_priv->clk[i])) {\n\t\t\tdev_err(afe->dev, \"%s(), devm_clk_get %s fail, ret %ld\\n\",\n\t\t\t\t__func__, aud_clks[i],\n\t\t\t\tPTR_ERR(afe_priv->clk[i]));\n\t\t\treturn PTR_ERR(afe_priv->clk[i]);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint mt8183_afe_enable_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_INFRA_SYS_AUDIO], ret);\n\t\tgoto CLK_INFRA_SYS_AUDIO_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIO]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIO], ret);\n\t\tgoto CLK_MUX_AUDIO_ERR;\n\t}\n\n\tret = clk_set_parent(afe_priv->clk[CLK_MUX_AUDIO],\n\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIO],\n\t\t\taud_clks[CLK_CLK26M], ret);\n\t\tgoto CLK_MUX_AUDIO_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS], ret);\n\t\tgoto CLK_MUX_AUDIO_INTBUS_ERR;\n\t}\n\n\tret = clk_set_parent(afe_priv->clk[CLK_MUX_AUDIOINTBUS],\n\t\t\t     afe_priv->clk[CLK_TOP_SYSPLL_D2_D4]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_set_parent %s-%s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_MUX_AUDIOINTBUS],\n\t\t\taud_clks[CLK_TOP_SYSPLL_D2_D4], ret);\n\t\tgoto CLK_MUX_AUDIO_INTBUS_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_AFE]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_AFE], ret);\n\t\tgoto CLK_AFE_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_I2S1_BCLK_SW]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_I2S1_BCLK_SW], ret);\n\t\tgoto CLK_I2S1_BCLK_SW_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_I2S2_BCLK_SW]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_I2S2_BCLK_SW], ret);\n\t\tgoto CLK_I2S2_BCLK_SW_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_I2S3_BCLK_SW]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_I2S3_BCLK_SW], ret);\n\t\tgoto CLK_I2S3_BCLK_SW_ERR;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_I2S4_BCLK_SW]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_I2S4_BCLK_SW], ret);\n\t\tgoto CLK_I2S4_BCLK_SW_ERR;\n\t}\n\n\treturn 0;\n\nCLK_I2S4_BCLK_SW_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S3_BCLK_SW]);\nCLK_I2S3_BCLK_SW_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S2_BCLK_SW]);\nCLK_I2S2_BCLK_SW_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S1_BCLK_SW]);\nCLK_I2S1_BCLK_SW_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_AFE]);\nCLK_AFE_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\nCLK_MUX_AUDIO_INTBUS_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIO]);\nCLK_MUX_AUDIO_ERR:\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\nCLK_INFRA_SYS_AUDIO_ERR:\n\treturn ret;\n}\n\nint mt8183_afe_disable_clock(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S4_BCLK_SW]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S3_BCLK_SW]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S2_BCLK_SW]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_I2S1_BCLK_SW]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_AFE]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIOINTBUS]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_MUX_AUDIO]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_INFRA_SYS_AUDIO]);\n\n\treturn 0;\n}\n\n \nstatic int apll1_mux_setting(struct mtk_base_afe *afe, bool enable)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tif (enable) {\n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1], ret);\n\t\t\tgoto ERR_ENABLE_CLK_TOP_MUX_AUD_1;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL1_CK]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1],\n\t\t\t\taud_clks[CLK_TOP_APLL1_CK], ret);\n\t\t\tgoto ERR_SELECT_CLK_TOP_MUX_AUD_1;\n\t\t}\n\n\t\t \n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1], ret);\n\t\t\tgoto ERR_ENABLE_CLK_TOP_MUX_AUD_ENG1;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL1_D8]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\taud_clks[CLK_TOP_APLL1_D8], ret);\n\t\t\tgoto ERR_SELECT_CLK_TOP_MUX_AUD_ENG1;\n\t\t}\n\t} else {\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG1],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\n\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_1],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\n\t}\n\n\treturn 0;\n\nERR_SELECT_CLK_TOP_MUX_AUD_ENG1:\n\tclk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1],\n\t\t       afe_priv->clk[CLK_CLK26M]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG1]);\nERR_ENABLE_CLK_TOP_MUX_AUD_ENG1:\nERR_SELECT_CLK_TOP_MUX_AUD_1:\n\tclk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_1],\n\t\t       afe_priv->clk[CLK_CLK26M]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_1]);\nERR_ENABLE_CLK_TOP_MUX_AUD_1:\nEXIT:\n\treturn ret;\n}\n\nstatic int apll2_mux_setting(struct mtk_base_afe *afe, bool enable)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\tif (enable) {\n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2], ret);\n\t\t\tgoto ERR_ENABLE_CLK_TOP_MUX_AUD_2;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL2_CK]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2],\n\t\t\t\taud_clks[CLK_TOP_APLL2_CK], ret);\n\t\t\tgoto ERR_SELECT_CLK_TOP_MUX_AUD_2;\n\t\t}\n\n\t\t \n\t\tret = clk_prepare_enable(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2], ret);\n\t\t\tgoto ERR_ENABLE_CLK_TOP_MUX_AUD_ENG2;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\t     afe_priv->clk[CLK_TOP_APLL2_D8]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\taud_clks[CLK_TOP_APLL2_D8], ret);\n\t\t\tgoto ERR_SELECT_CLK_TOP_MUX_AUD_ENG2;\n\t\t}\n\t} else {\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_ENG2],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\n\n\t\tret = clk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t\t\t     afe_priv->clk[CLK_CLK26M]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[CLK_TOP_MUX_AUD_2],\n\t\t\t\taud_clks[CLK_CLK26M], ret);\n\t\t\tgoto EXIT;\n\t\t}\n\t\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\n\t}\n\n\treturn 0;\n\nERR_SELECT_CLK_TOP_MUX_AUD_ENG2:\n\tclk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2],\n\t\t       afe_priv->clk[CLK_CLK26M]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_ENG2]);\nERR_ENABLE_CLK_TOP_MUX_AUD_ENG2:\nERR_SELECT_CLK_TOP_MUX_AUD_2:\n\tclk_set_parent(afe_priv->clk[CLK_TOP_MUX_AUD_2],\n\t\t       afe_priv->clk[CLK_CLK26M]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_TOP_MUX_AUD_2]);\nERR_ENABLE_CLK_TOP_MUX_AUD_2:\nEXIT:\n\treturn ret;\n}\n\nint mt8183_apll1_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tapll1_mux_setting(afe, true);\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL22M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL22M], ret);\n\t\tgoto ERR_CLK_APLL22M;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL1_TUNER]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL1_TUNER], ret);\n\t\tgoto ERR_CLK_APLL1_TUNER;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG,\n\t\t\t   0x0000FFF7, 0x00000832);\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0x1, 0x1);\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_22M_ON_MASK_SFT,\n\t\t\t   0x1 << AFE_22M_ON_SFT);\n\n\treturn 0;\n\nERR_CLK_APLL1_TUNER:\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL22M]);\nERR_CLK_APLL22M:\n\treturn ret;\n}\n\nvoid mt8183_apll1_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_22M_ON_MASK_SFT,\n\t\t\t   0x0 << AFE_22M_ON_SFT);\n\n\tregmap_update_bits(afe->regmap, AFE_APLL1_TUNER_CFG, 0x1, 0x0);\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL1_TUNER]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL22M]);\n\n\tapll1_mux_setting(afe, false);\n}\n\nint mt8183_apll2_enable(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint ret;\n\n\t \n\tapll2_mux_setting(afe, true);\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL24M]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL24M], ret);\n\t\tgoto ERR_CLK_APLL24M;\n\t}\n\n\tret = clk_prepare_enable(afe_priv->clk[CLK_APLL2_TUNER]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[CLK_APLL2_TUNER], ret);\n\t\tgoto ERR_CLK_APLL2_TUNER;\n\t}\n\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG,\n\t\t\t   0x0000FFF7, 0x00000634);\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0x1, 0x1);\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_24M_ON_MASK_SFT,\n\t\t\t   0x1 << AFE_24M_ON_SFT);\n\n\treturn 0;\n\nERR_CLK_APLL2_TUNER:\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL24M]);\nERR_CLK_APLL24M:\n\treturn ret;\n}\n\nvoid mt8183_apll2_disable(struct mtk_base_afe *afe)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\n\tregmap_update_bits(afe->regmap, AFE_HD_ENGEN_ENABLE,\n\t\t\t   AFE_24M_ON_MASK_SFT,\n\t\t\t   0x0 << AFE_24M_ON_SFT);\n\n\tregmap_update_bits(afe->regmap, AFE_APLL2_TUNER_CFG, 0x1, 0x0);\n\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL2_TUNER]);\n\tclk_disable_unprepare(afe_priv->clk[CLK_APLL24M]);\n\n\tapll2_mux_setting(afe, false);\n}\n\nint mt8183_get_apll_rate(struct mtk_base_afe *afe, int apll)\n{\n\treturn (apll == MT8183_APLL1) ? 180633600 : 196608000;\n}\n\nint mt8183_get_apll_by_rate(struct mtk_base_afe *afe, int rate)\n{\n\treturn ((rate % 8000) == 0) ? MT8183_APLL2 : MT8183_APLL1;\n}\n\nint mt8183_get_apll_by_name(struct mtk_base_afe *afe, const char *name)\n{\n\tif (strcmp(name, APLL1_W_NAME) == 0)\n\t\treturn MT8183_APLL1;\n\telse\n\t\treturn MT8183_APLL2;\n}\n\n \nstruct mt8183_mck_div {\n\tint m_sel_id;\n\tint div_clk_id;\n};\n\nstatic const struct mt8183_mck_div mck_div[MT8183_MCK_NUM] = {\n\t[MT8183_I2S0_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S0_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV0,\n\t},\n\t[MT8183_I2S1_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S1_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV1,\n\t},\n\t[MT8183_I2S2_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S2_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV2,\n\t},\n\t[MT8183_I2S3_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S3_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV3,\n\t},\n\t[MT8183_I2S4_MCK] = {\n\t\t.m_sel_id = CLK_TOP_I2S4_M_SEL,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIV4,\n\t},\n\t[MT8183_I2S4_BCK] = {\n\t\t.m_sel_id = -1,\n\t\t.div_clk_id = CLK_TOP_APLL12_DIVB,\n\t},\n\t[MT8183_I2S5_MCK] = {\n\t\t.m_sel_id = -1,\n\t\t.div_clk_id = -1,\n\t},\n};\n\nint mt8183_mck_enable(struct mtk_base_afe *afe, int mck_id, int rate)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint apll = mt8183_get_apll_by_rate(afe, rate);\n\tint apll_clk_id = apll == MT8183_APLL1 ?\n\t\t\t  CLK_TOP_MUX_AUD_1 : CLK_TOP_MUX_AUD_2;\n\tint m_sel_id = mck_div[mck_id].m_sel_id;\n\tint div_clk_id = mck_div[mck_id].div_clk_id;\n\tint ret;\n\n\t \n\tif (mck_id == MT8183_I2S5_MCK)\n\t\treturn 0;\n\n\t \n\tif (m_sel_id >= 0) {\n\t\tret = clk_prepare_enable(afe_priv->clk[m_sel_id]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[m_sel_id], ret);\n\t\t\tgoto ERR_ENABLE_MCLK;\n\t\t}\n\t\tret = clk_set_parent(afe_priv->clk[m_sel_id],\n\t\t\t\t     afe_priv->clk[apll_clk_id]);\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"%s(), clk_set_parent %s-%s fail %d\\n\",\n\t\t\t\t__func__, aud_clks[m_sel_id],\n\t\t\t\taud_clks[apll_clk_id], ret);\n\t\t\tgoto ERR_SELECT_MCLK;\n\t\t}\n\t}\n\n\t \n\tret = clk_prepare_enable(afe_priv->clk[div_clk_id]);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_prepare_enable %s fail %d\\n\",\n\t\t\t__func__, aud_clks[div_clk_id], ret);\n\t\tgoto ERR_ENABLE_MCLK_DIV;\n\t}\n\tret = clk_set_rate(afe_priv->clk[div_clk_id], rate);\n\tif (ret) {\n\t\tdev_err(afe->dev, \"%s(), clk_set_rate %s, rate %d, fail %d\\n\",\n\t\t\t__func__, aud_clks[div_clk_id],\n\t\t\trate, ret);\n\t\tgoto ERR_SET_MCLK_RATE;\n\t}\n\n\treturn 0;\n\nERR_SET_MCLK_RATE:\n\tclk_disable_unprepare(afe_priv->clk[div_clk_id]);\nERR_ENABLE_MCLK_DIV:\nERR_SELECT_MCLK:\n\tif (m_sel_id >= 0)\n\t\tclk_disable_unprepare(afe_priv->clk[m_sel_id]);\nERR_ENABLE_MCLK:\n\treturn ret;\n}\n\nvoid mt8183_mck_disable(struct mtk_base_afe *afe, int mck_id)\n{\n\tstruct mt8183_afe_private *afe_priv = afe->platform_priv;\n\tint m_sel_id = mck_div[mck_id].m_sel_id;\n\tint div_clk_id = mck_div[mck_id].div_clk_id;\n\n\t \n\tif (mck_id == MT8183_I2S5_MCK)\n\t\treturn;\n\n\tclk_disable_unprepare(afe_priv->clk[div_clk_id]);\n\tif (m_sel_id >= 0)\n\t\tclk_disable_unprepare(afe_priv->clk[m_sel_id]);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}