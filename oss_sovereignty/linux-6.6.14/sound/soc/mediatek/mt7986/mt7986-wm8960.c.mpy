{
  "module_name": "mt7986-wm8960.c",
  "hash_id": "38b317a97d2b32694a720aea351de1af517c5b25a9d7bf8cd72e356635a71057",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/mediatek/mt7986/mt7986-wm8960.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <sound/soc.h>\n\n#include \"mt7986-afe-common.h\"\n\nstruct mt7986_wm8960_priv {\n\tstruct device_node *platform_node;\n\tstruct device_node *codec_node;\n};\n\nstatic const struct snd_soc_dapm_widget mt7986_wm8960_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone\", NULL),\n\tSND_SOC_DAPM_MIC(\"AMIC\", NULL),\n};\n\nstatic const struct snd_kcontrol_new mt7986_wm8960_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone\"),\n\tSOC_DAPM_PIN_SWITCH(\"AMIC\"),\n};\n\nSND_SOC_DAILINK_DEFS(playback,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"DL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(capture,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"UL1\")),\n\tDAILINK_COMP_ARRAY(COMP_DUMMY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nSND_SOC_DAILINK_DEFS(codec,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"ETDM\")),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"wm8960-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link mt7986_wm8960_dai_links[] = {\n\t \n\t{\n\t\t.name = \"wm8960-playback\",\n\t\t.stream_name = \"wm8960-playback\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_playback = 1,\n\t\tSND_SOC_DAILINK_REG(playback),\n\t},\n\t{\n\t\t.name = \"wm8960-capture\",\n\t\t.stream_name = \"wm8960-capture\",\n\t\t.trigger = {SND_SOC_DPCM_TRIGGER_POST,\n\t\t\t    SND_SOC_DPCM_TRIGGER_POST},\n\t\t.dynamic = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(capture),\n\t},\n\t \n\t{\n\t\t.name = \"wm8960-codec\",\n\t\t.no_pcm = 1,\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t\tSND_SOC_DAIFMT_NB_NF |\n\t\t\tSND_SOC_DAIFMT_CBS_CFS |\n\t\t\tSND_SOC_DAIFMT_GATED,\n\t\t.dpcm_playback = 1,\n\t\t.dpcm_capture = 1,\n\t\tSND_SOC_DAILINK_REG(codec),\n\t},\n};\n\nstatic struct snd_soc_card mt7986_wm8960_card = {\n\t.name = \"mt7986-wm8960\",\n\t.owner = THIS_MODULE,\n\t.dai_link = mt7986_wm8960_dai_links,\n\t.num_links = ARRAY_SIZE(mt7986_wm8960_dai_links),\n\t.controls = mt7986_wm8960_controls,\n\t.num_controls = ARRAY_SIZE(mt7986_wm8960_controls),\n\t.dapm_widgets = mt7986_wm8960_widgets,\n\t.num_dapm_widgets = ARRAY_SIZE(mt7986_wm8960_widgets),\n};\n\nstatic int mt7986_wm8960_machine_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = &mt7986_wm8960_card;\n\tstruct snd_soc_dai_link *dai_link;\n\tstruct device_node *platform, *codec;\n\tstruct mt7986_wm8960_priv *priv;\n\tint ret, i;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tplatform = of_get_child_by_name(pdev->dev.of_node, \"platform\");\n\n\tif (platform) {\n\t\tpriv->platform_node = of_parse_phandle(platform, \"sound-dai\", 0);\n\t\tof_node_put(platform);\n\n\t\tif (!priv->platform_node) {\n\t\t\tdev_err(&pdev->dev, \"Failed to parse platform/sound-dai property\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\tdev_err(&pdev->dev, \"Property 'platform' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (dai_link->platforms->name)\n\t\t\tcontinue;\n\t\tdai_link->platforms->of_node = priv->platform_node;\n\t}\n\n\tcard->dev = &pdev->dev;\n\n\tcodec = of_get_child_by_name(pdev->dev.of_node, \"codec\");\n\n\tif (codec) {\n\t\tpriv->codec_node = of_parse_phandle(codec, \"sound-dai\", 0);\n\t\tof_node_put(codec);\n\n\t\tif (!priv->codec_node) {\n\t\t\tof_node_put(priv->platform_node);\n\t\t\tdev_err(&pdev->dev, \"Failed to parse codec/sound-dai property\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\tof_node_put(priv->platform_node);\n\t\tdev_err(&pdev->dev, \"Property 'codec' missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfor_each_card_prelinks(card, i, dai_link) {\n\t\tif (dai_link->codecs->name)\n\t\t\tcontinue;\n\t\tdai_link->codecs->of_node = priv->codec_node;\n\t}\n\n\tret = snd_soc_of_parse_audio_routing(card, \"audio-routing\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to parse audio-routing: %d\\n\", ret);\n\t\tgoto err_of_node_put;\n\t}\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"%s snd_soc_register_card fail: %d\\n\", __func__, ret);\n\t\tgoto err_of_node_put;\n\t}\n\nerr_of_node_put:\n\tof_node_put(priv->codec_node);\n\tof_node_put(priv->platform_node);\n\treturn ret;\n}\n\nstatic void mt7986_wm8960_machine_remove(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card = platform_get_drvdata(pdev);\n\tstruct mt7986_wm8960_priv *priv = snd_soc_card_get_drvdata(card);\n\n\tof_node_put(priv->codec_node);\n\tof_node_put(priv->platform_node);\n}\n\nstatic const struct of_device_id mt7986_wm8960_machine_dt_match[] = {\n\t{.compatible = \"mediatek,mt7986-wm8960-sound\"},\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, mt7986_wm8960_machine_dt_match);\n\nstatic struct platform_driver mt7986_wm8960_machine = {\n\t.driver = {\n\t\t.name = \"mt7986-wm8960\",\n\t\t.of_match_table = mt7986_wm8960_machine_dt_match,\n\t},\n\t.probe = mt7986_wm8960_machine_probe,\n\t.remove_new = mt7986_wm8960_machine_remove,\n};\n\nmodule_platform_driver(mt7986_wm8960_machine);\n\n \nMODULE_DESCRIPTION(\"MT7986 WM8960 ALSA SoC machine driver\");\nMODULE_AUTHOR(\"Vic Wu <vic.wu@mediatek.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"mt7986 wm8960 soc card\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}