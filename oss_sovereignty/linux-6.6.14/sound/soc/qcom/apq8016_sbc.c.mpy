{
  "module_name": "apq8016_sbc.c",
  "hash_id": "54a748fed65aba9f2361729c13b47db9f653bdb9ffc66fe1c397b5bef513c3f6",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/qcom/apq8016_sbc.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/clk.h>\n#include <linux/platform_device.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/jack.h>\n#include <sound/soc.h>\n#include <uapi/linux/input-event-codes.h>\n#include <dt-bindings/sound/apq8016-lpass.h>\n#include \"common.h\"\n#include \"qdsp6/q6afe.h\"\n\n#define MI2S_COUNT  (MI2S_QUATERNARY + 1)\n\nstruct apq8016_sbc_data {\n\tstruct snd_soc_card card;\n\tvoid __iomem *mic_iomux;\n\tvoid __iomem *spkr_iomux;\n\tstruct snd_soc_jack jack;\n\tbool jack_setup;\n\tint mi2s_clk_count[MI2S_COUNT];\n};\n\n#define MIC_CTRL_TER_WS_SLAVE_SEL\tBIT(21)\n#define MIC_CTRL_QUA_WS_SLAVE_SEL_10\tBIT(17)\n#define MIC_CTRL_TLMM_SCLK_EN\t\tBIT(1)\n#define\tSPKR_CTL_PRI_WS_SLAVE_SEL_11\t(BIT(17) | BIT(16))\n#define SPKR_CTL_TLMM_MCLK_EN\t\tBIT(1)\n#define SPKR_CTL_TLMM_SCLK_EN\t\tBIT(2)\n#define SPKR_CTL_TLMM_DATA1_EN\t\tBIT(3)\n#define SPKR_CTL_TLMM_WS_OUT_SEL_MASK\tGENMASK(7, 6)\n#define SPKR_CTL_TLMM_WS_OUT_SEL_SEC\tBIT(6)\n#define SPKR_CTL_TLMM_WS_EN_SEL_MASK\tGENMASK(19, 18)\n#define SPKR_CTL_TLMM_WS_EN_SEL_SEC\tBIT(18)\n#define DEFAULT_MCLK_RATE\t\t9600000\n#define MI2S_BCLK_RATE\t\t\t1536000\n\nstatic struct snd_soc_jack_pin apq8016_sbc_jack_pins[] = {\n\t{\n\t\t.pin = \"Mic Jack\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Headphone Jack\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n};\n\nstatic int apq8016_dai_init(struct snd_soc_pcm_runtime *rtd, int mi2s)\n{\n\tstruct snd_soc_dai *codec_dai;\n\tstruct snd_soc_component *component;\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct apq8016_sbc_data *pdata = snd_soc_card_get_drvdata(card);\n\tint i, rval;\n\tu32 value;\n\n\tswitch (mi2s) {\n\tcase MI2S_PRIMARY:\n\t\twritel(readl(pdata->spkr_iomux) | SPKR_CTL_PRI_WS_SLAVE_SEL_11,\n\t\t\tpdata->spkr_iomux);\n\t\tbreak;\n\n\tcase MI2S_QUATERNARY:\n\t\t \n\t\twritel(readl(pdata->mic_iomux) | MIC_CTRL_QUA_WS_SLAVE_SEL_10 |\n\t\t\tMIC_CTRL_TLMM_SCLK_EN,\n\t\t\tpdata->mic_iomux);\n\t\tbreak;\n\tcase MI2S_SECONDARY:\n\t\t \n\t\tvalue = readl(pdata->spkr_iomux) &\n\t\t\t~(SPKR_CTL_TLMM_WS_OUT_SEL_MASK | SPKR_CTL_TLMM_WS_EN_SEL_MASK);\n\t\t \n\t\twritel(value | SPKR_CTL_TLMM_MCLK_EN | SPKR_CTL_TLMM_SCLK_EN |\n\t\t\tSPKR_CTL_TLMM_DATA1_EN | SPKR_CTL_TLMM_WS_OUT_SEL_SEC |\n\t\t\tSPKR_CTL_TLMM_WS_EN_SEL_SEC, pdata->spkr_iomux);\n\t\tbreak;\n\tcase MI2S_TERTIARY:\n\t\twritel(readl(pdata->mic_iomux) | MIC_CTRL_TER_WS_SLAVE_SEL |\n\t\t\tMIC_CTRL_TLMM_SCLK_EN,\n\t\t\tpdata->mic_iomux);\n\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(card->dev, \"unsupported cpu dai configuration\\n\");\n\t\treturn -EINVAL;\n\n\t}\n\n\tif (!pdata->jack_setup) {\n\t\tstruct snd_jack *jack;\n\n\t\trval = snd_soc_card_jack_new_pins(card, \"Headset Jack\",\n\t\t\t\t\t\t  SND_JACK_HEADSET |\n\t\t\t\t\t\t  SND_JACK_HEADPHONE |\n\t\t\t\t\t\t  SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t\t  SND_JACK_BTN_2 | SND_JACK_BTN_3 |\n\t\t\t\t\t\t  SND_JACK_BTN_4,\n\t\t\t\t\t\t  &pdata->jack,\n\t\t\t\t\t\t  apq8016_sbc_jack_pins,\n\t\t\t\t\t\t  ARRAY_SIZE(apq8016_sbc_jack_pins));\n\n\t\tif (rval < 0) {\n\t\t\tdev_err(card->dev, \"Unable to add Headphone Jack\\n\");\n\t\t\treturn rval;\n\t\t}\n\n\t\tjack = pdata->jack.jack;\n\n\t\tsnd_jack_set_key(jack, SND_JACK_BTN_0, KEY_PLAYPAUSE);\n\t\tsnd_jack_set_key(jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\t\tsnd_jack_set_key(jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\t\tsnd_jack_set_key(jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\t\tpdata->jack_setup = true;\n\t}\n\n\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\n\t\tcomponent = codec_dai->component;\n\t\t \n\t\trval = snd_soc_component_set_sysclk(component, 0, 0, DEFAULT_MCLK_RATE,\n\t\t\t\t       SND_SOC_CLOCK_IN);\n\t\tif (rval != 0 && rval != -ENOTSUPP) {\n\t\t\tdev_warn(card->dev, \"Failed to set mclk: %d\\n\", rval);\n\t\t\treturn rval;\n\t\t}\n\t\trval = snd_soc_component_set_jack(component, &pdata->jack, NULL);\n\t\tif (rval != 0 && rval != -ENOTSUPP) {\n\t\t\tdev_warn(card->dev, \"Failed to set jack: %d\\n\", rval);\n\t\t\treturn rval;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int apq8016_sbc_dai_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\n\treturn apq8016_dai_init(rtd, cpu_dai->id);\n}\n\nstatic void apq8016_sbc_add_ops(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai_link *link;\n\tint i;\n\n\tfor_each_card_prelinks(card, i, link)\n\t\tlink->init = apq8016_sbc_dai_init;\n}\n\nstatic int qdsp6_dai_get_lpass_id(struct snd_soc_dai *cpu_dai)\n{\n\tswitch (cpu_dai->id) {\n\tcase PRIMARY_MI2S_RX:\n\tcase PRIMARY_MI2S_TX:\n\t\treturn MI2S_PRIMARY;\n\tcase SECONDARY_MI2S_RX:\n\tcase SECONDARY_MI2S_TX:\n\t\treturn MI2S_SECONDARY;\n\tcase TERTIARY_MI2S_RX:\n\tcase TERTIARY_MI2S_TX:\n\t\treturn MI2S_TERTIARY;\n\tcase QUATERNARY_MI2S_RX:\n\tcase QUATERNARY_MI2S_TX:\n\t\treturn MI2S_QUATERNARY;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int msm8916_qdsp6_dai_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\n\tsnd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_BP_FP);\n\treturn apq8016_dai_init(rtd, qdsp6_dai_get_lpass_id(cpu_dai));\n}\n\nstatic int msm8916_qdsp6_startup(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct apq8016_sbc_data *data = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tint mi2s, ret;\n\n\tmi2s = qdsp6_dai_get_lpass_id(cpu_dai);\n\tif (mi2s < 0)\n\t\treturn mi2s;\n\n\tif (++data->mi2s_clk_count[mi2s] > 1)\n\t\treturn 0;\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, LPAIF_BIT_CLK, MI2S_BCLK_RATE, 0);\n\tif (ret)\n\t\tdev_err(card->dev, \"Failed to enable LPAIF bit clk: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic void msm8916_qdsp6_shutdown(struct snd_pcm_substream *substream)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tstruct snd_soc_card *card = rtd->card;\n\tstruct apq8016_sbc_data *data = snd_soc_card_get_drvdata(card);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tint mi2s, ret;\n\n\tmi2s = qdsp6_dai_get_lpass_id(cpu_dai);\n\tif (mi2s < 0)\n\t\treturn;\n\n\tif (--data->mi2s_clk_count[mi2s] > 0)\n\t\treturn;\n\n\tret = snd_soc_dai_set_sysclk(cpu_dai, LPAIF_BIT_CLK, 0, 0);\n\tif (ret)\n\t\tdev_err(card->dev, \"Failed to disable LPAIF bit clk: %d\\n\", ret);\n}\n\nstatic const struct snd_soc_ops msm8916_qdsp6_be_ops = {\n\t.startup = msm8916_qdsp6_startup,\n\t.shutdown = msm8916_qdsp6_shutdown,\n};\n\nstatic int msm8916_qdsp6_be_hw_params_fixup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t\t\t    struct snd_pcm_hw_params *params)\n{\n\tstruct snd_interval *rate = hw_param_interval(params,\n\t\t\t\t\tSNDRV_PCM_HW_PARAM_RATE);\n\tstruct snd_interval *channels = hw_param_interval(params,\n\t\t\t\t\tSNDRV_PCM_HW_PARAM_CHANNELS);\n\tstruct snd_mask *fmt = hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT);\n\n\trate->min = rate->max = 48000;\n\tchannels->min = channels->max = 2;\n\tsnd_mask_set_format(fmt, SNDRV_PCM_FORMAT_S16_LE);\n\n\treturn 0;\n}\n\nstatic void msm8916_qdsp6_add_ops(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai_link *link;\n\tint i;\n\n\t \n\tcard->components = \"qdsp6\";\n\n\tfor_each_card_prelinks(card, i, link) {\n\t\tif (link->no_pcm) {\n\t\t\tlink->init = msm8916_qdsp6_dai_init;\n\t\t\tlink->ops = &msm8916_qdsp6_be_ops;\n\t\t\tlink->be_hw_params_fixup = msm8916_qdsp6_be_hw_params_fixup;\n\t\t}\n\t}\n}\n\nstatic const struct snd_kcontrol_new apq8016_sbc_snd_controls[] = {\n\tSOC_DAPM_PIN_SWITCH(\"Headphone Jack\"),\n\tSOC_DAPM_PIN_SWITCH(\"Mic Jack\"),\n};\n\nstatic const struct snd_soc_dapm_widget apq8016_sbc_dapm_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Handset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Headset Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Secondary Mic\", NULL),\n\tSND_SOC_DAPM_MIC(\"Digital Mic1\", NULL),\n\tSND_SOC_DAPM_MIC(\"Digital Mic2\", NULL),\n};\n\nstatic int apq8016_sbc_platform_probe(struct platform_device *pdev)\n{\n\tvoid (*add_ops)(struct snd_soc_card *card);\n\tstruct device *dev = &pdev->dev;\n\tstruct snd_soc_card *card;\n\tstruct apq8016_sbc_data *data;\n\tint ret;\n\n\tadd_ops = device_get_match_data(&pdev->dev);\n\tif (!add_ops)\n\t\treturn -EINVAL;\n\n\tdata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tcard = &data->card;\n\tcard->dev = dev;\n\tcard->owner = THIS_MODULE;\n\tcard->dapm_widgets = apq8016_sbc_dapm_widgets;\n\tcard->num_dapm_widgets = ARRAY_SIZE(apq8016_sbc_dapm_widgets);\n\tcard->controls = apq8016_sbc_snd_controls;\n\tcard->num_controls = ARRAY_SIZE(apq8016_sbc_snd_controls);\n\n\tret = qcom_snd_parse_of(card);\n\tif (ret)\n\t\treturn ret;\n\n\tdata->mic_iomux = devm_platform_ioremap_resource_byname(pdev, \"mic-iomux\");\n\tif (IS_ERR(data->mic_iomux))\n\t\treturn PTR_ERR(data->mic_iomux);\n\n\tdata->spkr_iomux = devm_platform_ioremap_resource_byname(pdev, \"spkr-iomux\");\n\tif (IS_ERR(data->spkr_iomux))\n\t\treturn PTR_ERR(data->spkr_iomux);\n\n\tsnd_soc_card_set_drvdata(card, data);\n\n\tadd_ops(card);\n\treturn devm_snd_soc_register_card(&pdev->dev, card);\n}\n\nstatic const struct of_device_id apq8016_sbc_device_id[] __maybe_unused = {\n\t{ .compatible = \"qcom,apq8016-sbc-sndcard\", .data = apq8016_sbc_add_ops },\n\t{ .compatible = \"qcom,msm8916-qdsp6-sndcard\", .data = msm8916_qdsp6_add_ops },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, apq8016_sbc_device_id);\n\nstatic struct platform_driver apq8016_sbc_platform_driver = {\n\t.driver = {\n\t\t.name = \"qcom-apq8016-sbc\",\n\t\t.of_match_table = of_match_ptr(apq8016_sbc_device_id),\n\t},\n\t.probe = apq8016_sbc_platform_probe,\n};\nmodule_platform_driver(apq8016_sbc_platform_driver);\n\nMODULE_AUTHOR(\"Srinivas Kandagatla <srinivas.kandagatla@linaro.org\");\nMODULE_DESCRIPTION(\"APQ8016 ASoC Machine Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}