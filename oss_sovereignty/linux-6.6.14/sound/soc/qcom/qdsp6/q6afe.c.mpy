{
  "module_name": "q6afe.c",
  "hash_id": "916dc1c9fd83f1ee654cd8e0eca896532f6e8e5c71852e8198f765710d42ed99",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/qcom/qdsp6/q6afe.c",
  "human_readable_source": "\n\n\n\n#include <linux/slab.h>\n#include <linux/kernel.h>\n#include <linux/uaccess.h>\n#include <linux/wait.h>\n#include <linux/jiffies.h>\n#include <linux/sched.h>\n#include <linux/module.h>\n#include <linux/kref.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/spinlock.h>\n#include <linux/delay.h>\n#include <linux/soc/qcom/apr.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include \"q6dsp-errno.h\"\n#include \"q6core.h\"\n#include \"q6afe.h\"\n\n \n#define AFE_PORT_CMD_DEVICE_START\t0x000100E5\n#define AFE_PORT_CMD_DEVICE_STOP\t0x000100E6\n#define AFE_PORT_CMD_SET_PARAM_V2\t0x000100EF\n#define AFE_SVC_CMD_SET_PARAM\t\t0x000100f3\n#define AFE_PORT_CMDRSP_GET_PARAM_V2\t0x00010106\n#define AFE_PARAM_ID_HDMI_CONFIG\t0x00010210\n#define AFE_MODULE_AUDIO_DEV_INTERFACE\t0x0001020C\n#define AFE_MODULE_TDM\t\t\t0x0001028A\n\n#define AFE_PARAM_ID_CDC_SLIMBUS_SLAVE_CFG 0x00010235\n\n#define AFE_PARAM_ID_LPAIF_CLK_CONFIG\t0x00010238\n#define AFE_PARAM_ID_INT_DIGITAL_CDC_CLK_CONFIG\t0x00010239\n\n#define AFE_PARAM_ID_SLIMBUS_CONFIG    0x00010212\n#define AFE_PARAM_ID_I2S_CONFIG\t0x0001020D\n#define AFE_PARAM_ID_TDM_CONFIG\t0x0001029D\n#define AFE_PARAM_ID_PORT_SLOT_MAPPING_CONFIG\t0x00010297\n#define AFE_PARAM_ID_CODEC_DMA_CONFIG\t0x000102B8\n#define AFE_CMD_REMOTE_LPASS_CORE_HW_VOTE_REQUEST\t0x000100f4\n#define AFE_CMD_RSP_REMOTE_LPASS_CORE_HW_VOTE_REQUEST   0x000100f5\n#define AFE_CMD_REMOTE_LPASS_CORE_HW_DEVOTE_REQUEST\t0x000100f6\n\n \n#define AFE_API_VERSION_I2S_CONFIG\t0x1\n#define AFE_PORT_I2S_SD0\t\t0x1\n#define AFE_PORT_I2S_SD1\t\t0x2\n#define AFE_PORT_I2S_SD2\t\t0x3\n#define AFE_PORT_I2S_SD3\t\t0x4\n#define AFE_PORT_I2S_SD0_MASK\t\tBIT(0x0)\n#define AFE_PORT_I2S_SD1_MASK\t\tBIT(0x1)\n#define AFE_PORT_I2S_SD2_MASK\t\tBIT(0x2)\n#define AFE_PORT_I2S_SD3_MASK\t\tBIT(0x3)\n#define AFE_PORT_I2S_SD0_1_MASK\t\tGENMASK(1, 0)\n#define AFE_PORT_I2S_SD2_3_MASK\t\tGENMASK(3, 2)\n#define AFE_PORT_I2S_SD0_1_2_MASK\tGENMASK(2, 0)\n#define AFE_PORT_I2S_SD0_1_2_3_MASK\tGENMASK(3, 0)\n#define AFE_PORT_I2S_QUAD01\t\t0x5\n#define AFE_PORT_I2S_QUAD23\t\t0x6\n#define AFE_PORT_I2S_6CHS\t\t0x7\n#define AFE_PORT_I2S_8CHS\t\t0x8\n#define AFE_PORT_I2S_MONO\t\t0x0\n#define AFE_PORT_I2S_STEREO\t\t0x1\n#define AFE_PORT_CONFIG_I2S_WS_SRC_EXTERNAL\t0x0\n#define AFE_PORT_CONFIG_I2S_WS_SRC_INTERNAL\t0x1\n#define AFE_LINEAR_PCM_DATA\t\t\t\t0x0\n\n\n \n#define AFE_API_VERSION_HDMI_CONFIG\t0x1\n#define AFE_PORT_ID_MULTICHAN_HDMI_RX\t0x100E\n#define AFE_PORT_ID_HDMI_OVER_DP_RX\t0x6020\n\n#define AFE_API_VERSION_SLIMBUS_CONFIG 0x1\n \n#define AFE_API_VERSION_CLOCK_SET 1\n#define Q6AFE_LPASS_CLK_CONFIG_API_VERSION\t0x1\n#define AFE_MODULE_CLOCK_SET\t\t0x0001028F\n#define AFE_PARAM_ID_CLOCK_SET\t\t0x00010290\n\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_0_RX      0x4000\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_0_TX      0x4001\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_1_RX      0x4002\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_1_TX      0x4003\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_2_RX      0x4004\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_2_TX      0x4005\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_3_RX      0x4006\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_3_TX      0x4007\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_4_RX      0x4008\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_4_TX      0x4009\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_5_RX      0x400a\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_5_TX      0x400b\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_6_RX      0x400c\n \n#define AFE_PORT_ID_SLIMBUS_MULTI_CHAN_6_TX      0x400d\n#define AFE_PORT_ID_PRIMARY_MI2S_RX         0x1000\n#define AFE_PORT_ID_PRIMARY_MI2S_TX         0x1001\n#define AFE_PORT_ID_SECONDARY_MI2S_RX       0x1002\n#define AFE_PORT_ID_SECONDARY_MI2S_TX       0x1003\n#define AFE_PORT_ID_TERTIARY_MI2S_RX        0x1004\n#define AFE_PORT_ID_TERTIARY_MI2S_TX        0x1005\n#define AFE_PORT_ID_QUATERNARY_MI2S_RX      0x1006\n#define AFE_PORT_ID_QUATERNARY_MI2S_TX      0x1007\n#define AFE_PORT_ID_QUINARY_MI2S_RX\t    0x1016\n#define AFE_PORT_ID_QUINARY_MI2S_TX\t    0x1017\n\n \n#define AFE_PORT_ID_TDM_PORT_RANGE_START\t0x9000\n\n \n#define AFE_PORT_ID_TDM_PORT_RANGE_END \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START+0x50-1)\n\n \n#define AFE_PORT_ID_TDM_PORT_RANGE_SIZE \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_END - \\\n\tAFE_PORT_ID_TDM_PORT_RANGE_START+1)\n\n#define AFE_PORT_ID_PRIMARY_TDM_RX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x00)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_1 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x02)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_2 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x04)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_3 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x06)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_4 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x08)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_5 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x0A)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_6 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x0C)\n#define AFE_PORT_ID_PRIMARY_TDM_RX_7 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_RX + 0x0E)\n\n#define AFE_PORT_ID_PRIMARY_TDM_TX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x01)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_1 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x02)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_2 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x04)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_3 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x06)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_4 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x08)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_5 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x0A)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_6 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x0C)\n#define AFE_PORT_ID_PRIMARY_TDM_TX_7 \\\n\t(AFE_PORT_ID_PRIMARY_TDM_TX + 0x0E)\n\n#define AFE_PORT_ID_SECONDARY_TDM_RX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x10)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_1 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x02)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_2 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x04)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_3 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x06)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_4 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x08)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_5 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x0A)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_6 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x0C)\n#define AFE_PORT_ID_SECONDARY_TDM_RX_7 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_RX + 0x0E)\n\n#define AFE_PORT_ID_SECONDARY_TDM_TX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x11)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_1 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x02)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_2 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x04)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_3 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x06)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_4 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x08)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_5 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x0A)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_6 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x0C)\n#define AFE_PORT_ID_SECONDARY_TDM_TX_7 \\\n\t(AFE_PORT_ID_SECONDARY_TDM_TX + 0x0E)\n\n#define AFE_PORT_ID_TERTIARY_TDM_RX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x20)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_1 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x02)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_2 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x04)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_3 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x06)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_4 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x08)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_5 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x0A)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_6 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x0C)\n#define AFE_PORT_ID_TERTIARY_TDM_RX_7 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_RX + 0x0E)\n\n#define AFE_PORT_ID_TERTIARY_TDM_TX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x21)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_1 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x02)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_2 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x04)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_3 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x06)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_4 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x08)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_5 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x0A)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_6 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x0C)\n#define AFE_PORT_ID_TERTIARY_TDM_TX_7 \\\n\t(AFE_PORT_ID_TERTIARY_TDM_TX + 0x0E)\n\n#define AFE_PORT_ID_QUATERNARY_TDM_RX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x30)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_1 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x02)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_2 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x04)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_3 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x06)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_4 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x08)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_5 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x0A)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_6 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x0C)\n#define AFE_PORT_ID_QUATERNARY_TDM_RX_7 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_RX + 0x0E)\n\n#define AFE_PORT_ID_QUATERNARY_TDM_TX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x31)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_1 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x02)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_2 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x04)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_3 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x06)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_4 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x08)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_5 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x0A)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_6 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x0C)\n#define AFE_PORT_ID_QUATERNARY_TDM_TX_7 \\\n\t(AFE_PORT_ID_QUATERNARY_TDM_TX + 0x0E)\n\n#define AFE_PORT_ID_QUINARY_TDM_RX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x40)\n#define AFE_PORT_ID_QUINARY_TDM_RX_1 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x02)\n#define AFE_PORT_ID_QUINARY_TDM_RX_2 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x04)\n#define AFE_PORT_ID_QUINARY_TDM_RX_3 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x06)\n#define AFE_PORT_ID_QUINARY_TDM_RX_4 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x08)\n#define AFE_PORT_ID_QUINARY_TDM_RX_5 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x0A)\n#define AFE_PORT_ID_QUINARY_TDM_RX_6 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x0C)\n#define AFE_PORT_ID_QUINARY_TDM_RX_7 \\\n\t(AFE_PORT_ID_QUINARY_TDM_RX + 0x0E)\n\n#define AFE_PORT_ID_QUINARY_TDM_TX \\\n\t(AFE_PORT_ID_TDM_PORT_RANGE_START + 0x41)\n#define AFE_PORT_ID_QUINARY_TDM_TX_1 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x02)\n#define AFE_PORT_ID_QUINARY_TDM_TX_2 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x04)\n#define AFE_PORT_ID_QUINARY_TDM_TX_3 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x06)\n#define AFE_PORT_ID_QUINARY_TDM_TX_4 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x08)\n#define AFE_PORT_ID_QUINARY_TDM_TX_5 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x0A)\n#define AFE_PORT_ID_QUINARY_TDM_TX_6 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x0C)\n#define AFE_PORT_ID_QUINARY_TDM_TX_7 \\\n\t(AFE_PORT_ID_QUINARY_TDM_TX + 0x0E)\n\n \n#define AFE_PORT_ID_WSA_CODEC_DMA_RX_0\t0xB000\n \n#define AFE_PORT_ID_WSA_CODEC_DMA_TX_0\t0xB001\n \n#define AFE_PORT_ID_WSA_CODEC_DMA_RX_1\t0xB002\n \n#define AFE_PORT_ID_WSA_CODEC_DMA_TX_1\t0xB003\n \n#define AFE_PORT_ID_WSA_CODEC_DMA_TX_2\t0xB005\n \n#define AFE_PORT_ID_VA_CODEC_DMA_TX_0\t0xB021\n \n#define AFE_PORT_ID_VA_CODEC_DMA_TX_1\t0xB023\n \n#define AFE_PORT_ID_VA_CODEC_DMA_TX_2\t0xB025\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_0\t0xB030\n \n#define AFE_PORT_ID_TX_CODEC_DMA_TX_0\t0xB031\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_1\t0xB032\n \n#define AFE_PORT_ID_TX_CODEC_DMA_TX_1\t0xB033\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_2\t0xB034\n \n#define AFE_PORT_ID_TX_CODEC_DMA_TX_2\t0xB035\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_3\t0xB036\n \n#define AFE_PORT_ID_TX_CODEC_DMA_TX_3\t0xB037\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_4\t0xB038\n \n#define AFE_PORT_ID_TX_CODEC_DMA_TX_4\t0xB039\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_5\t0xB03A\n \n#define AFE_PORT_ID_TX_CODEC_DMA_TX_5\t0xB03B\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_6\t0xB03C\n \n#define AFE_PORT_ID_RX_CODEC_DMA_RX_7\t0xB03E\n\n#define Q6AFE_LPASS_MODE_CLK1_VALID 1\n#define Q6AFE_LPASS_MODE_CLK2_VALID 2\n#define Q6AFE_LPASS_CLK_SRC_INTERNAL 1\n#define Q6AFE_LPASS_CLK_ROOT_DEFAULT 0\n#define AFE_API_VERSION_TDM_CONFIG              1\n#define AFE_API_VERSION_SLOT_MAPPING_CONFIG\t1\n#define AFE_API_VERSION_CODEC_DMA_CONFIG\t1\n\n#define TIMEOUT_MS 1000\n#define AFE_CMD_RESP_AVAIL\t0\n#define AFE_CMD_RESP_NONE\t1\n#define AFE_CLK_TOKEN\t\t1024\n\nstruct q6afe {\n\tstruct apr_device *apr;\n\tstruct device *dev;\n\tstruct q6core_svc_api_info ainfo;\n\tstruct mutex lock;\n\tstruct aprv2_ibasic_rsp_result_t result;\n\twait_queue_head_t wait;\n\tstruct list_head port_list;\n\tspinlock_t port_list_lock;\n};\n\nstruct afe_port_cmd_device_start {\n\tu16 port_id;\n\tu16 reserved;\n} __packed;\n\nstruct afe_port_cmd_device_stop {\n\tu16 port_id;\n\tu16 reserved;\n \n} __packed;\n\nstruct afe_port_param_data_v2 {\n\tu32 module_id;\n\tu32 param_id;\n\tu16 param_size;\n\tu16 reserved;\n} __packed;\n\nstruct afe_svc_cmd_set_param {\n\tuint32_t payload_size;\n\tuint32_t payload_address_lsw;\n\tuint32_t payload_address_msw;\n\tuint32_t mem_map_handle;\n} __packed;\n\nstruct afe_port_cmd_set_param_v2 {\n\tu16 port_id;\n\tu16 payload_size;\n\tu32 payload_address_lsw;\n\tu32 payload_address_msw;\n\tu32 mem_map_handle;\n} __packed;\n\nstruct afe_param_id_hdmi_multi_chan_audio_cfg {\n\tu32 hdmi_cfg_minor_version;\n\tu16 datatype;\n\tu16 channel_allocation;\n\tu32 sample_rate;\n\tu16 bit_width;\n\tu16 reserved;\n} __packed;\n\nstruct afe_param_id_slimbus_cfg {\n\tu32                  sb_cfg_minor_version;\n \n\n\tu16                  slimbus_dev_id;\n \n\tu16                  bit_width;\n \n\tu16                  data_format;\n \n\tu16                  num_channels;\n \n\tu8  shared_ch_mapping[AFE_PORT_MAX_AUDIO_CHAN_CNT];\n \n\tu32              sample_rate;\n \n} __packed;\n\nstruct afe_clk_cfg {\n\tu32                  i2s_cfg_minor_version;\n\tu32                  clk_val1;\n\tu32                  clk_val2;\n\tu16                  clk_src;\n\tu16                  clk_root;\n\tu16                  clk_set_mode;\n\tu16                  reserved;\n} __packed;\n\nstruct afe_digital_clk_cfg {\n\tu32                  i2s_cfg_minor_version;\n\tu32                  clk_val;\n\tu16                  clk_root;\n\tu16                  reserved;\n} __packed;\n\nstruct afe_param_id_i2s_cfg {\n\tu32\ti2s_cfg_minor_version;\n\tu16\tbit_width;\n\tu16\tchannel_mode;\n\tu16\tmono_stereo;\n\tu16\tws_src;\n\tu32\tsample_rate;\n\tu16\tdata_format;\n\tu16\treserved;\n} __packed;\n\nstruct afe_param_id_tdm_cfg {\n\tu32\ttdm_cfg_minor_version;\n\tu32\tnum_channels;\n\tu32\tsample_rate;\n\tu32\tbit_width;\n\tu16\tdata_format;\n\tu16\tsync_mode;\n\tu16\tsync_src;\n\tu16\tnslots_per_frame;\n\tu16\tctrl_data_out_enable;\n\tu16\tctrl_invert_sync_pulse;\n\tu16\tctrl_sync_data_delay;\n\tu16\tslot_width;\n\tu32\tslot_mask;\n} __packed;\n\nstruct afe_param_id_cdc_dma_cfg {\n\tu32\tcdc_dma_cfg_minor_version;\n\tu32\tsample_rate;\n\tu16\tbit_width;\n\tu16\tdata_format;\n\tu16\tnum_channels;\n\tu16\tactive_channels_mask;\n} __packed;\n\nunion afe_port_config {\n\tstruct afe_param_id_hdmi_multi_chan_audio_cfg hdmi_multi_ch;\n\tstruct afe_param_id_slimbus_cfg           slim_cfg;\n\tstruct afe_param_id_i2s_cfg\ti2s_cfg;\n\tstruct afe_param_id_tdm_cfg\ttdm_cfg;\n\tstruct afe_param_id_cdc_dma_cfg\tdma_cfg;\n} __packed;\n\n\nstruct afe_clk_set {\n\tuint32_t clk_set_minor_version;\n\tuint32_t clk_id;\n\tuint32_t clk_freq_in_hz;\n\tuint16_t clk_attri;\n\tuint16_t clk_root;\n\tuint32_t enable;\n};\n\nstruct afe_param_id_slot_mapping_cfg {\n\tu32\tminor_version;\n\tu16\tnum_channels;\n\tu16\tbitwidth;\n\tu32\tdata_align_type;\n\tu16\tch_mapping[AFE_PORT_MAX_AUDIO_CHAN_CNT];\n} __packed;\n\nstruct q6afe_port {\n\twait_queue_head_t wait;\n\tunion afe_port_config port_cfg;\n\tstruct afe_param_id_slot_mapping_cfg *scfg;\n\tstruct aprv2_ibasic_rsp_result_t result;\n\tint token;\n\tint id;\n\tint cfg_type;\n\tstruct q6afe *afe;\n\tstruct kref refcount;\n\tstruct list_head node;\n};\n\nstruct afe_cmd_remote_lpass_core_hw_vote_request {\n        uint32_t  hw_block_id;\n        char client_name[8];\n} __packed;\n\nstruct afe_cmd_remote_lpass_core_hw_devote_request {\n        uint32_t  hw_block_id;\n        uint32_t client_handle;\n} __packed;\n\n\n\nstruct afe_port_map {\n\tint port_id;\n\tint token;\n\tint is_rx;\n\tint is_dig_pcm;\n};\n\n \n\nstatic struct afe_port_map port_maps[AFE_PORT_MAX] = {\n\t[HDMI_RX] = { AFE_PORT_ID_MULTICHAN_HDMI_RX, HDMI_RX, 1, 1},\n\t[SLIMBUS_0_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_0_RX,\n\t\t\t\tSLIMBUS_0_RX, 1, 1},\n\t[SLIMBUS_1_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_1_RX,\n\t\t\t\tSLIMBUS_1_RX, 1, 1},\n\t[SLIMBUS_2_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_2_RX,\n\t\t\t\tSLIMBUS_2_RX, 1, 1},\n\t[SLIMBUS_3_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_3_RX,\n\t\t\t\tSLIMBUS_3_RX, 1, 1},\n\t[SLIMBUS_4_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_4_RX,\n\t\t\t\tSLIMBUS_4_RX, 1, 1},\n\t[SLIMBUS_5_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_5_RX,\n\t\t\t\tSLIMBUS_5_RX, 1, 1},\n\t[SLIMBUS_6_RX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_6_RX,\n\t\t\t\tSLIMBUS_6_RX, 1, 1},\n\t[SLIMBUS_0_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_0_TX,\n\t\t\t\tSLIMBUS_0_TX, 0, 1},\n\t[SLIMBUS_1_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_1_TX,\n\t\t\t\tSLIMBUS_1_TX, 0, 1},\n\t[SLIMBUS_2_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_2_TX,\n\t\t\t\tSLIMBUS_2_TX, 0, 1},\n\t[SLIMBUS_3_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_3_TX,\n\t\t\t\tSLIMBUS_3_TX, 0, 1},\n\t[SLIMBUS_4_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_4_TX,\n\t\t\t\tSLIMBUS_4_TX, 0, 1},\n\t[SLIMBUS_5_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_5_TX,\n\t\t\t\tSLIMBUS_5_TX, 0, 1},\n\t[SLIMBUS_6_TX] = { AFE_PORT_ID_SLIMBUS_MULTI_CHAN_6_TX,\n\t\t\t\tSLIMBUS_6_TX, 0, 1},\n\t[PRIMARY_MI2S_RX] = { AFE_PORT_ID_PRIMARY_MI2S_RX,\n\t\t\t\tPRIMARY_MI2S_RX, 1, 1},\n\t[PRIMARY_MI2S_TX] = { AFE_PORT_ID_PRIMARY_MI2S_TX,\n\t\t\t\tPRIMARY_MI2S_RX, 0, 1},\n\t[SECONDARY_MI2S_RX] = { AFE_PORT_ID_SECONDARY_MI2S_RX,\n\t\t\t\tSECONDARY_MI2S_RX, 1, 1},\n\t[SECONDARY_MI2S_TX] = { AFE_PORT_ID_SECONDARY_MI2S_TX,\n\t\t\t\tSECONDARY_MI2S_TX, 0, 1},\n\t[TERTIARY_MI2S_RX] = { AFE_PORT_ID_TERTIARY_MI2S_RX,\n\t\t\t\tTERTIARY_MI2S_RX, 1, 1},\n\t[TERTIARY_MI2S_TX] = { AFE_PORT_ID_TERTIARY_MI2S_TX,\n\t\t\t\tTERTIARY_MI2S_TX, 0, 1},\n\t[QUATERNARY_MI2S_RX] = { AFE_PORT_ID_QUATERNARY_MI2S_RX,\n\t\t\t\tQUATERNARY_MI2S_RX, 1, 1},\n\t[QUATERNARY_MI2S_TX] = { AFE_PORT_ID_QUATERNARY_MI2S_TX,\n\t\t\t\tQUATERNARY_MI2S_TX, 0, 1},\n\t[QUINARY_MI2S_RX]  =  { AFE_PORT_ID_QUINARY_MI2S_RX,\n\t\t\t\tQUINARY_MI2S_RX, 1, 1},\n\t[QUINARY_MI2S_TX] =   { AFE_PORT_ID_QUINARY_MI2S_TX,\n\t\t\t\tQUINARY_MI2S_TX, 0, 1},\n\t[PRIMARY_TDM_RX_0] =  { AFE_PORT_ID_PRIMARY_TDM_RX,\n\t\t\t\tPRIMARY_TDM_RX_0, 1, 1},\n\t[PRIMARY_TDM_TX_0] =  { AFE_PORT_ID_PRIMARY_TDM_TX,\n\t\t\t\tPRIMARY_TDM_TX_0, 0, 1},\n\t[PRIMARY_TDM_RX_1] =  { AFE_PORT_ID_PRIMARY_TDM_RX_1,\n\t\t\t\tPRIMARY_TDM_RX_1, 1, 1},\n\t[PRIMARY_TDM_TX_1] =  { AFE_PORT_ID_PRIMARY_TDM_TX_1,\n\t\t\t\tPRIMARY_TDM_TX_1, 0, 1},\n\t[PRIMARY_TDM_RX_2] =  { AFE_PORT_ID_PRIMARY_TDM_RX_2,\n\t\t\t\tPRIMARY_TDM_RX_2, 1, 1},\n\t[PRIMARY_TDM_TX_2] =  { AFE_PORT_ID_PRIMARY_TDM_TX_2,\n\t\t\t\tPRIMARY_TDM_TX_2, 0, 1},\n\t[PRIMARY_TDM_RX_3] =  { AFE_PORT_ID_PRIMARY_TDM_RX_3,\n\t\t\t\tPRIMARY_TDM_RX_3, 1, 1},\n\t[PRIMARY_TDM_TX_3] =  { AFE_PORT_ID_PRIMARY_TDM_TX_3,\n\t\t\t\tPRIMARY_TDM_TX_3, 0, 1},\n\t[PRIMARY_TDM_RX_4] =  { AFE_PORT_ID_PRIMARY_TDM_RX_4,\n\t\t\t\tPRIMARY_TDM_RX_4, 1, 1},\n\t[PRIMARY_TDM_TX_4] =  { AFE_PORT_ID_PRIMARY_TDM_TX_4,\n\t\t\t\tPRIMARY_TDM_TX_4, 0, 1},\n\t[PRIMARY_TDM_RX_5] =  { AFE_PORT_ID_PRIMARY_TDM_RX_5,\n\t\t\t\tPRIMARY_TDM_RX_5, 1, 1},\n\t[PRIMARY_TDM_TX_5] =  { AFE_PORT_ID_PRIMARY_TDM_TX_5,\n\t\t\t\tPRIMARY_TDM_TX_5, 0, 1},\n\t[PRIMARY_TDM_RX_6] =  { AFE_PORT_ID_PRIMARY_TDM_RX_6,\n\t\t\t\tPRIMARY_TDM_RX_6, 1, 1},\n\t[PRIMARY_TDM_TX_6] =  { AFE_PORT_ID_PRIMARY_TDM_TX_6,\n\t\t\t\tPRIMARY_TDM_TX_6, 0, 1},\n\t[PRIMARY_TDM_RX_7] =  { AFE_PORT_ID_PRIMARY_TDM_RX_7,\n\t\t\t\tPRIMARY_TDM_RX_7, 1, 1},\n\t[PRIMARY_TDM_TX_7] =  { AFE_PORT_ID_PRIMARY_TDM_TX_7,\n\t\t\t\tPRIMARY_TDM_TX_7, 0, 1},\n\t[SECONDARY_TDM_RX_0] =  { AFE_PORT_ID_SECONDARY_TDM_RX,\n\t\t\t\tSECONDARY_TDM_RX_0, 1, 1},\n\t[SECONDARY_TDM_TX_0] =  { AFE_PORT_ID_SECONDARY_TDM_TX,\n\t\t\t\tSECONDARY_TDM_TX_0, 0, 1},\n\t[SECONDARY_TDM_RX_1] =  { AFE_PORT_ID_SECONDARY_TDM_RX_1,\n\t\t\t\tSECONDARY_TDM_RX_1, 1, 1},\n\t[SECONDARY_TDM_TX_1] =  { AFE_PORT_ID_SECONDARY_TDM_TX_1,\n\t\t\t\tSECONDARY_TDM_TX_1, 0, 1},\n\t[SECONDARY_TDM_RX_2] =  { AFE_PORT_ID_SECONDARY_TDM_RX_2,\n\t\t\t\tSECONDARY_TDM_RX_2, 1, 1},\n\t[SECONDARY_TDM_TX_2] =  { AFE_PORT_ID_SECONDARY_TDM_TX_2,\n\t\t\t\tSECONDARY_TDM_TX_2, 0, 1},\n\t[SECONDARY_TDM_RX_3] =  { AFE_PORT_ID_SECONDARY_TDM_RX_3,\n\t\t\t\tSECONDARY_TDM_RX_3, 1, 1},\n\t[SECONDARY_TDM_TX_3] =  { AFE_PORT_ID_SECONDARY_TDM_TX_3,\n\t\t\t\tSECONDARY_TDM_TX_3, 0, 1},\n\t[SECONDARY_TDM_RX_4] =  { AFE_PORT_ID_SECONDARY_TDM_RX_4,\n\t\t\t\tSECONDARY_TDM_RX_4, 1, 1},\n\t[SECONDARY_TDM_TX_4] =  { AFE_PORT_ID_SECONDARY_TDM_TX_4,\n\t\t\t\tSECONDARY_TDM_TX_4, 0, 1},\n\t[SECONDARY_TDM_RX_5] =  { AFE_PORT_ID_SECONDARY_TDM_RX_5,\n\t\t\t\tSECONDARY_TDM_RX_5, 1, 1},\n\t[SECONDARY_TDM_TX_5] =  { AFE_PORT_ID_SECONDARY_TDM_TX_5,\n\t\t\t\tSECONDARY_TDM_TX_5, 0, 1},\n\t[SECONDARY_TDM_RX_6] =  { AFE_PORT_ID_SECONDARY_TDM_RX_6,\n\t\t\t\tSECONDARY_TDM_RX_6, 1, 1},\n\t[SECONDARY_TDM_TX_6] =  { AFE_PORT_ID_SECONDARY_TDM_TX_6,\n\t\t\t\tSECONDARY_TDM_TX_6, 0, 1},\n\t[SECONDARY_TDM_RX_7] =  { AFE_PORT_ID_SECONDARY_TDM_RX_7,\n\t\t\t\tSECONDARY_TDM_RX_7, 1, 1},\n\t[SECONDARY_TDM_TX_7] =  { AFE_PORT_ID_SECONDARY_TDM_TX_7,\n\t\t\t\tSECONDARY_TDM_TX_7, 0, 1},\n\t[TERTIARY_TDM_RX_0] =  { AFE_PORT_ID_TERTIARY_TDM_RX,\n\t\t\t\tTERTIARY_TDM_RX_0, 1, 1},\n\t[TERTIARY_TDM_TX_0] =  { AFE_PORT_ID_TERTIARY_TDM_TX,\n\t\t\t\tTERTIARY_TDM_TX_0, 0, 1},\n\t[TERTIARY_TDM_RX_1] =  { AFE_PORT_ID_TERTIARY_TDM_RX_1,\n\t\t\t\tTERTIARY_TDM_RX_1, 1, 1},\n\t[TERTIARY_TDM_TX_1] =  { AFE_PORT_ID_TERTIARY_TDM_TX_1,\n\t\t\t\tTERTIARY_TDM_TX_1, 0, 1},\n\t[TERTIARY_TDM_RX_2] =  { AFE_PORT_ID_TERTIARY_TDM_RX_2,\n\t\t\t\tTERTIARY_TDM_RX_2, 1, 1},\n\t[TERTIARY_TDM_TX_2] =  { AFE_PORT_ID_TERTIARY_TDM_TX_2,\n\t\t\t\tTERTIARY_TDM_TX_2, 0, 1},\n\t[TERTIARY_TDM_RX_3] =  { AFE_PORT_ID_TERTIARY_TDM_RX_3,\n\t\t\t\tTERTIARY_TDM_RX_3, 1, 1},\n\t[TERTIARY_TDM_TX_3] =  { AFE_PORT_ID_TERTIARY_TDM_TX_3,\n\t\t\t\tTERTIARY_TDM_TX_3, 0, 1},\n\t[TERTIARY_TDM_RX_4] =  { AFE_PORT_ID_TERTIARY_TDM_RX_4,\n\t\t\t\tTERTIARY_TDM_RX_4, 1, 1},\n\t[TERTIARY_TDM_TX_4] =  { AFE_PORT_ID_TERTIARY_TDM_TX_4,\n\t\t\t\tTERTIARY_TDM_TX_4, 0, 1},\n\t[TERTIARY_TDM_RX_5] =  { AFE_PORT_ID_TERTIARY_TDM_RX_5,\n\t\t\t\tTERTIARY_TDM_RX_5, 1, 1},\n\t[TERTIARY_TDM_TX_5] =  { AFE_PORT_ID_TERTIARY_TDM_TX_5,\n\t\t\t\tTERTIARY_TDM_TX_5, 0, 1},\n\t[TERTIARY_TDM_RX_6] =  { AFE_PORT_ID_TERTIARY_TDM_RX_6,\n\t\t\t\tTERTIARY_TDM_RX_6, 1, 1},\n\t[TERTIARY_TDM_TX_6] =  { AFE_PORT_ID_TERTIARY_TDM_TX_6,\n\t\t\t\tTERTIARY_TDM_TX_6, 0, 1},\n\t[TERTIARY_TDM_RX_7] =  { AFE_PORT_ID_TERTIARY_TDM_RX_7,\n\t\t\t\tTERTIARY_TDM_RX_7, 1, 1},\n\t[TERTIARY_TDM_TX_7] =  { AFE_PORT_ID_TERTIARY_TDM_TX_7,\n\t\t\t\tTERTIARY_TDM_TX_7, 0, 1},\n\t[QUATERNARY_TDM_RX_0] =  { AFE_PORT_ID_QUATERNARY_TDM_RX,\n\t\t\t\tQUATERNARY_TDM_RX_0, 1, 1},\n\t[QUATERNARY_TDM_TX_0] =  { AFE_PORT_ID_QUATERNARY_TDM_TX,\n\t\t\t\tQUATERNARY_TDM_TX_0, 0, 1},\n\t[QUATERNARY_TDM_RX_1] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_1,\n\t\t\t\tQUATERNARY_TDM_RX_1, 1, 1},\n\t[QUATERNARY_TDM_TX_1] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_1,\n\t\t\t\tQUATERNARY_TDM_TX_1, 0, 1},\n\t[QUATERNARY_TDM_RX_2] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_2,\n\t\t\t\tQUATERNARY_TDM_RX_2, 1, 1},\n\t[QUATERNARY_TDM_TX_2] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_2,\n\t\t\t\tQUATERNARY_TDM_TX_2, 0, 1},\n\t[QUATERNARY_TDM_RX_3] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_3,\n\t\t\t\tQUATERNARY_TDM_RX_3, 1, 1},\n\t[QUATERNARY_TDM_TX_3] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_3,\n\t\t\t\tQUATERNARY_TDM_TX_3, 0, 1},\n\t[QUATERNARY_TDM_RX_4] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_4,\n\t\t\t\tQUATERNARY_TDM_RX_4, 1, 1},\n\t[QUATERNARY_TDM_TX_4] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_4,\n\t\t\t\tQUATERNARY_TDM_TX_4, 0, 1},\n\t[QUATERNARY_TDM_RX_5] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_5,\n\t\t\t\tQUATERNARY_TDM_RX_5, 1, 1},\n\t[QUATERNARY_TDM_TX_5] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_5,\n\t\t\t\tQUATERNARY_TDM_TX_5, 0, 1},\n\t[QUATERNARY_TDM_RX_6] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_6,\n\t\t\t\tQUATERNARY_TDM_RX_6, 1, 1},\n\t[QUATERNARY_TDM_TX_6] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_6,\n\t\t\t\tQUATERNARY_TDM_TX_6, 0, 1},\n\t[QUATERNARY_TDM_RX_7] =  { AFE_PORT_ID_QUATERNARY_TDM_RX_7,\n\t\t\t\tQUATERNARY_TDM_RX_7, 1, 1},\n\t[QUATERNARY_TDM_TX_7] =  { AFE_PORT_ID_QUATERNARY_TDM_TX_7,\n\t\t\t\tQUATERNARY_TDM_TX_7, 0, 1},\n\t[QUINARY_TDM_RX_0] =  { AFE_PORT_ID_QUINARY_TDM_RX,\n\t\t\t\tQUINARY_TDM_RX_0, 1, 1},\n\t[QUINARY_TDM_TX_0] =  { AFE_PORT_ID_QUINARY_TDM_TX,\n\t\t\t\tQUINARY_TDM_TX_0, 0, 1},\n\t[QUINARY_TDM_RX_1] =  { AFE_PORT_ID_QUINARY_TDM_RX_1,\n\t\t\t\tQUINARY_TDM_RX_1, 1, 1},\n\t[QUINARY_TDM_TX_1] =  { AFE_PORT_ID_QUINARY_TDM_TX_1,\n\t\t\t\tQUINARY_TDM_TX_1, 0, 1},\n\t[QUINARY_TDM_RX_2] =  { AFE_PORT_ID_QUINARY_TDM_RX_2,\n\t\t\t\tQUINARY_TDM_RX_2, 1, 1},\n\t[QUINARY_TDM_TX_2] =  { AFE_PORT_ID_QUINARY_TDM_TX_2,\n\t\t\t\tQUINARY_TDM_TX_2, 0, 1},\n\t[QUINARY_TDM_RX_3] =  { AFE_PORT_ID_QUINARY_TDM_RX_3,\n\t\t\t\tQUINARY_TDM_RX_3, 1, 1},\n\t[QUINARY_TDM_TX_3] =  { AFE_PORT_ID_QUINARY_TDM_TX_3,\n\t\t\t\tQUINARY_TDM_TX_3, 0, 1},\n\t[QUINARY_TDM_RX_4] =  { AFE_PORT_ID_QUINARY_TDM_RX_4,\n\t\t\t\tQUINARY_TDM_RX_4, 1, 1},\n\t[QUINARY_TDM_TX_4] =  { AFE_PORT_ID_QUINARY_TDM_TX_4,\n\t\t\t\tQUINARY_TDM_TX_4, 0, 1},\n\t[QUINARY_TDM_RX_5] =  { AFE_PORT_ID_QUINARY_TDM_RX_5,\n\t\t\t\tQUINARY_TDM_RX_5, 1, 1},\n\t[QUINARY_TDM_TX_5] =  { AFE_PORT_ID_QUINARY_TDM_TX_5,\n\t\t\t\tQUINARY_TDM_TX_5, 0, 1},\n\t[QUINARY_TDM_RX_6] =  { AFE_PORT_ID_QUINARY_TDM_RX_6,\n\t\t\t\tQUINARY_TDM_RX_6, 1, 1},\n\t[QUINARY_TDM_TX_6] =  { AFE_PORT_ID_QUINARY_TDM_TX_6,\n\t\t\t\tQUINARY_TDM_TX_6, 0, 1},\n\t[QUINARY_TDM_RX_7] =  { AFE_PORT_ID_QUINARY_TDM_RX_7,\n\t\t\t\tQUINARY_TDM_RX_7, 1, 1},\n\t[QUINARY_TDM_TX_7] =  { AFE_PORT_ID_QUINARY_TDM_TX_7,\n\t\t\t\tQUINARY_TDM_TX_7, 0, 1},\n\t[DISPLAY_PORT_RX] = { AFE_PORT_ID_HDMI_OVER_DP_RX,\n\t\t\t\tDISPLAY_PORT_RX, 1, 1},\n\t[WSA_CODEC_DMA_RX_0] = { AFE_PORT_ID_WSA_CODEC_DMA_RX_0,\n\t\t\t\tWSA_CODEC_DMA_RX_0, 1, 1},\n\t[WSA_CODEC_DMA_TX_0] = { AFE_PORT_ID_WSA_CODEC_DMA_TX_0,\n\t\t\t\tWSA_CODEC_DMA_TX_0, 0, 1},\n\t[WSA_CODEC_DMA_RX_1] = { AFE_PORT_ID_WSA_CODEC_DMA_RX_1,\n\t\t\t\tWSA_CODEC_DMA_RX_1, 1, 1},\n\t[WSA_CODEC_DMA_TX_1] = { AFE_PORT_ID_WSA_CODEC_DMA_TX_1,\n\t\t\t\tWSA_CODEC_DMA_TX_1, 0, 1},\n\t[WSA_CODEC_DMA_TX_2] = { AFE_PORT_ID_WSA_CODEC_DMA_TX_2,\n\t\t\t\tWSA_CODEC_DMA_TX_2, 0, 1},\n\t[VA_CODEC_DMA_TX_0] = { AFE_PORT_ID_VA_CODEC_DMA_TX_0,\n\t\t\t\tVA_CODEC_DMA_TX_0, 0, 1},\n\t[VA_CODEC_DMA_TX_1] = { AFE_PORT_ID_VA_CODEC_DMA_TX_1,\n\t\t\t\tVA_CODEC_DMA_TX_1, 0, 1},\n\t[VA_CODEC_DMA_TX_2] = { AFE_PORT_ID_VA_CODEC_DMA_TX_2,\n\t\t\t\tVA_CODEC_DMA_TX_2, 0, 1},\n\t[RX_CODEC_DMA_RX_0] = { AFE_PORT_ID_RX_CODEC_DMA_RX_0,\n\t\t\t\tRX_CODEC_DMA_RX_0, 1, 1},\n\t[TX_CODEC_DMA_TX_0] = { AFE_PORT_ID_TX_CODEC_DMA_TX_0,\n\t\t\t\tTX_CODEC_DMA_TX_0, 0, 1},\n\t[RX_CODEC_DMA_RX_1] = { AFE_PORT_ID_RX_CODEC_DMA_RX_1,\n\t\t\t\tRX_CODEC_DMA_RX_1, 1, 1},\n\t[TX_CODEC_DMA_TX_1] = { AFE_PORT_ID_TX_CODEC_DMA_TX_1,\n\t\t\t\tTX_CODEC_DMA_TX_1, 0, 1},\n\t[RX_CODEC_DMA_RX_2] = { AFE_PORT_ID_RX_CODEC_DMA_RX_2,\n\t\t\t\tRX_CODEC_DMA_RX_2, 1, 1},\n\t[TX_CODEC_DMA_TX_2] = { AFE_PORT_ID_TX_CODEC_DMA_TX_2,\n\t\t\t\tTX_CODEC_DMA_TX_2, 0, 1},\n\t[RX_CODEC_DMA_RX_3] = { AFE_PORT_ID_RX_CODEC_DMA_RX_3,\n\t\t\t\tRX_CODEC_DMA_RX_3, 1, 1},\n\t[TX_CODEC_DMA_TX_3] = { AFE_PORT_ID_TX_CODEC_DMA_TX_3,\n\t\t\t\tTX_CODEC_DMA_TX_3, 0, 1},\n\t[RX_CODEC_DMA_RX_4] = { AFE_PORT_ID_RX_CODEC_DMA_RX_4,\n\t\t\t\tRX_CODEC_DMA_RX_4, 1, 1},\n\t[TX_CODEC_DMA_TX_4] = { AFE_PORT_ID_TX_CODEC_DMA_TX_4,\n\t\t\t\tTX_CODEC_DMA_TX_4, 0, 1},\n\t[RX_CODEC_DMA_RX_5] = { AFE_PORT_ID_RX_CODEC_DMA_RX_5,\n\t\t\t\tRX_CODEC_DMA_RX_5, 1, 1},\n\t[TX_CODEC_DMA_TX_5] = { AFE_PORT_ID_TX_CODEC_DMA_TX_5,\n\t\t\t\tTX_CODEC_DMA_TX_5, 0, 1},\n\t[RX_CODEC_DMA_RX_6] = { AFE_PORT_ID_RX_CODEC_DMA_RX_6,\n\t\t\t\tRX_CODEC_DMA_RX_6, 1, 1},\n\t[RX_CODEC_DMA_RX_7] = { AFE_PORT_ID_RX_CODEC_DMA_RX_7,\n\t\t\t\tRX_CODEC_DMA_RX_7, 1, 1},\n};\n\nstatic void q6afe_port_free(struct kref *ref)\n{\n\tstruct q6afe_port *port;\n\tstruct q6afe *afe;\n\tunsigned long flags;\n\n\tport = container_of(ref, struct q6afe_port, refcount);\n\tafe = port->afe;\n\tspin_lock_irqsave(&afe->port_list_lock, flags);\n\tlist_del(&port->node);\n\tspin_unlock_irqrestore(&afe->port_list_lock, flags);\n\tkfree(port->scfg);\n\tkfree(port);\n}\n\nstatic struct q6afe_port *q6afe_find_port(struct q6afe *afe, int token)\n{\n\tstruct q6afe_port *p;\n\tstruct q6afe_port *ret = NULL;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&afe->port_list_lock, flags);\n\tlist_for_each_entry(p, &afe->port_list, node)\n\t\tif (p->token == token) {\n\t\t\tret = p;\n\t\t\tkref_get(&p->refcount);\n\t\t\tbreak;\n\t\t}\n\n\tspin_unlock_irqrestore(&afe->port_list_lock, flags);\n\treturn ret;\n}\n\nstatic int q6afe_callback(struct apr_device *adev, struct apr_resp_pkt *data)\n{\n\tstruct q6afe *afe = dev_get_drvdata(&adev->dev);\n\tstruct aprv2_ibasic_rsp_result_t *res;\n\tstruct apr_hdr *hdr = &data->hdr;\n\tstruct q6afe_port *port;\n\n\tif (!data->payload_size)\n\t\treturn 0;\n\n\tres = data->payload;\n\tswitch (hdr->opcode) {\n\tcase APR_BASIC_RSP_RESULT: {\n\t\tif (res->status) {\n\t\t\tdev_err(afe->dev, \"cmd = 0x%x returned error = 0x%x\\n\",\n\t\t\t\tres->opcode, res->status);\n\t\t}\n\t\tswitch (res->opcode) {\n\t\tcase AFE_PORT_CMD_SET_PARAM_V2:\n\t\tcase AFE_PORT_CMD_DEVICE_STOP:\n\t\tcase AFE_PORT_CMD_DEVICE_START:\n\t\tcase AFE_SVC_CMD_SET_PARAM:\n\t\t\tport = q6afe_find_port(afe, hdr->token);\n\t\t\tif (port) {\n\t\t\t\tport->result = *res;\n\t\t\t\twake_up(&port->wait);\n\t\t\t\tkref_put(&port->refcount, q6afe_port_free);\n\t\t\t} else if (hdr->token == AFE_CLK_TOKEN) {\n\t\t\t\tafe->result = *res;\n\t\t\t\twake_up(&afe->wait);\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(afe->dev, \"Unknown cmd 0x%x\\n\",\tres->opcode);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\tbreak;\n\tcase AFE_CMD_RSP_REMOTE_LPASS_CORE_HW_VOTE_REQUEST:\n\t\tafe->result.opcode = hdr->opcode;\n\t\tafe->result.status = res->status;\n\t\twake_up(&afe->wait);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \nint q6afe_get_port_id(int index)\n{\n\tif (index < 0 || index >= AFE_PORT_MAX)\n\t\treturn -EINVAL;\n\n\treturn port_maps[index].port_id;\n}\nEXPORT_SYMBOL_GPL(q6afe_get_port_id);\n\nstatic int afe_apr_send_pkt(struct q6afe *afe, struct apr_pkt *pkt,\n\t\t\t    struct q6afe_port *port, uint32_t rsp_opcode)\n{\n\twait_queue_head_t *wait;\n\tstruct aprv2_ibasic_rsp_result_t *result;\n\tint ret;\n\n\tmutex_lock(&afe->lock);\n\tif (port) {\n\t\twait = &port->wait;\n\t\tresult = &port->result;\n\t} else {\n\t\tresult = &afe->result;\n\t\twait = &afe->wait;\n\t}\n\n\tresult->opcode = 0;\n\tresult->status = 0;\n\n\tret = apr_send_pkt(afe->apr, pkt);\n\tif (ret < 0) {\n\t\tdev_err(afe->dev, \"packet not transmitted (%d)\\n\", ret);\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\n\tret = wait_event_timeout(*wait, (result->opcode == rsp_opcode),\n\t\t\t\t msecs_to_jiffies(TIMEOUT_MS));\n\tif (!ret) {\n\t\tret = -ETIMEDOUT;\n\t} else if (result->status > 0) {\n\t\tdev_err(afe->dev, \"DSP returned error[%x]\\n\",\n\t\t\tresult->status);\n\t\tret = -EINVAL;\n\t} else {\n\t\tret = 0;\n\t}\n\nerr:\n\tmutex_unlock(&afe->lock);\n\n\treturn ret;\n}\n\nstatic int q6afe_set_param(struct q6afe *afe, struct q6afe_port *port,\n\t\t\t   void *data, int param_id, int module_id, int psize,\n\t\t\t   int token)\n{\n\tstruct afe_svc_cmd_set_param *param;\n\tstruct afe_port_param_data_v2 *pdata;\n\tstruct apr_pkt *pkt;\n\tint ret, pkt_size;\n\tvoid *p, *pl;\n\n\tpkt_size = APR_HDR_SIZE + sizeof(*param) + sizeof(*pdata) + psize;\n\tp = kzalloc(pkt_size, GFP_KERNEL);\n\tif (!p)\n\t\treturn -ENOMEM;\n\n\tpkt = p;\n\tparam = p + APR_HDR_SIZE;\n\tpdata = p + APR_HDR_SIZE + sizeof(*param);\n\tpl = p + APR_HDR_SIZE + sizeof(*param) + sizeof(*pdata);\n\tmemcpy(pl, data, psize);\n\n\tpkt->hdr.hdr_field = APR_HDR_FIELD(APR_MSG_TYPE_SEQ_CMD,\n\t\t\t\t\t   APR_HDR_LEN(APR_HDR_SIZE),\n\t\t\t\t\t   APR_PKT_VER);\n\tpkt->hdr.pkt_size = pkt_size;\n\tpkt->hdr.src_port = 0;\n\tpkt->hdr.dest_port = 0;\n\tpkt->hdr.token = token;\n\tpkt->hdr.opcode = AFE_SVC_CMD_SET_PARAM;\n\n\tparam->payload_size = sizeof(*pdata) + psize;\n\tparam->payload_address_lsw = 0x00;\n\tparam->payload_address_msw = 0x00;\n\tparam->mem_map_handle = 0x00;\n\tpdata->module_id = module_id;\n\tpdata->param_id = param_id;\n\tpdata->param_size = psize;\n\n\tret = afe_apr_send_pkt(afe, pkt, port, AFE_SVC_CMD_SET_PARAM);\n\tif (ret)\n\t\tdev_err(afe->dev, \"AFE set params failed %d\\n\", ret);\n\n\tkfree(pkt);\n\treturn ret;\n}\n\nstatic int q6afe_port_set_param(struct q6afe_port *port, void *data,\n\t\t\t\tint param_id, int module_id, int psize)\n{\n\treturn q6afe_set_param(port->afe, port, data, param_id, module_id,\n\t\t\t       psize, port->token);\n}\n\nstatic int q6afe_port_set_param_v2(struct q6afe_port *port, void *data,\n\t\t\t\t   int param_id, int module_id, int psize)\n{\n\tstruct afe_port_cmd_set_param_v2 *param;\n\tstruct afe_port_param_data_v2 *pdata;\n\tstruct q6afe *afe = port->afe;\n\tstruct apr_pkt *pkt;\n\tu16 port_id = port->id;\n\tint ret, pkt_size;\n\tvoid *p, *pl;\n\n\tpkt_size = APR_HDR_SIZE + sizeof(*param) + sizeof(*pdata) + psize;\n\tp = kzalloc(pkt_size, GFP_KERNEL);\n\tif (!p)\n\t\treturn -ENOMEM;\n\n\tpkt = p;\n\tparam = p + APR_HDR_SIZE;\n\tpdata = p + APR_HDR_SIZE + sizeof(*param);\n\tpl = p + APR_HDR_SIZE + sizeof(*param) + sizeof(*pdata);\n\tmemcpy(pl, data, psize);\n\n\tpkt->hdr.hdr_field = APR_HDR_FIELD(APR_MSG_TYPE_SEQ_CMD,\n\t\t\t\t\t   APR_HDR_LEN(APR_HDR_SIZE),\n\t\t\t\t\t   APR_PKT_VER);\n\tpkt->hdr.pkt_size = pkt_size;\n\tpkt->hdr.src_port = 0;\n\tpkt->hdr.dest_port = 0;\n\tpkt->hdr.token = port->token;\n\tpkt->hdr.opcode = AFE_PORT_CMD_SET_PARAM_V2;\n\n\tparam->port_id = port_id;\n\tparam->payload_size = sizeof(*pdata) + psize;\n\tparam->payload_address_lsw = 0x00;\n\tparam->payload_address_msw = 0x00;\n\tparam->mem_map_handle = 0x00;\n\tpdata->module_id = module_id;\n\tpdata->param_id = param_id;\n\tpdata->param_size = psize;\n\n\tret = afe_apr_send_pkt(afe, pkt, port, AFE_PORT_CMD_SET_PARAM_V2);\n\tif (ret)\n\t\tdev_err(afe->dev, \"AFE enable for port 0x%x failed %d\\n\",\n\t\t       port_id, ret);\n\n\tkfree(pkt);\n\treturn ret;\n}\n\nstatic int q6afe_port_set_lpass_clock(struct q6afe_port *port,\n\t\t\t\t struct afe_clk_cfg *cfg)\n{\n\treturn q6afe_port_set_param_v2(port, cfg,\n\t\t\t\t       AFE_PARAM_ID_LPAIF_CLK_CONFIG,\n\t\t\t\t       AFE_MODULE_AUDIO_DEV_INTERFACE,\n\t\t\t\t       sizeof(*cfg));\n}\n\nstatic int q6afe_set_lpass_clock_v2(struct q6afe_port *port,\n\t\t\t\t struct afe_clk_set *cfg)\n{\n\treturn q6afe_port_set_param(port, cfg, AFE_PARAM_ID_CLOCK_SET,\n\t\t\t\t    AFE_MODULE_CLOCK_SET, sizeof(*cfg));\n}\n\nstatic int q6afe_set_digital_codec_core_clock(struct q6afe_port *port,\n\t\t\t\t\t      struct afe_digital_clk_cfg *cfg)\n{\n\treturn q6afe_port_set_param_v2(port, cfg,\n\t\t\t\t       AFE_PARAM_ID_INT_DIGITAL_CDC_CLK_CONFIG,\n\t\t\t\t       AFE_MODULE_AUDIO_DEV_INTERFACE,\n\t\t\t\t       sizeof(*cfg));\n}\n\nint q6afe_set_lpass_clock(struct device *dev, int clk_id, int attri,\n\t\t\t  int clk_root, unsigned int freq)\n{\n\tstruct q6afe *afe = dev_get_drvdata(dev->parent);\n\tstruct afe_clk_set cset = {0,};\n\n\tcset.clk_set_minor_version = AFE_API_VERSION_CLOCK_SET;\n\tcset.clk_id = clk_id;\n\tcset.clk_freq_in_hz = freq;\n\tcset.clk_attri = attri;\n\tcset.clk_root = clk_root;\n\tcset.enable = !!freq;\n\n\treturn q6afe_set_param(afe, NULL, &cset, AFE_PARAM_ID_CLOCK_SET,\n\t\t\t       AFE_MODULE_CLOCK_SET, sizeof(cset),\n\t\t\t       AFE_CLK_TOKEN);\n}\nEXPORT_SYMBOL_GPL(q6afe_set_lpass_clock);\n\nint q6afe_port_set_sysclk(struct q6afe_port *port, int clk_id,\n\t\t\t  int clk_src, int clk_root,\n\t\t\t  unsigned int freq, int dir)\n{\n\tstruct afe_clk_cfg ccfg = {0,};\n\tstruct afe_clk_set cset = {0,};\n\tstruct afe_digital_clk_cfg dcfg = {0,};\n\tint ret;\n\n\tswitch (clk_id) {\n\tcase LPAIF_DIG_CLK:\n\t\tdcfg.i2s_cfg_minor_version = AFE_API_VERSION_I2S_CONFIG;\n\t\tdcfg.clk_val = freq;\n\t\tdcfg.clk_root = clk_root;\n\t\tret = q6afe_set_digital_codec_core_clock(port, &dcfg);\n\t\tbreak;\n\tcase LPAIF_BIT_CLK:\n\t\tccfg.i2s_cfg_minor_version = AFE_API_VERSION_I2S_CONFIG;\n\t\tccfg.clk_val1 = freq;\n\t\tccfg.clk_src = clk_src;\n\t\tccfg.clk_root = clk_root;\n\t\tccfg.clk_set_mode = Q6AFE_LPASS_MODE_CLK1_VALID;\n\t\tret = q6afe_port_set_lpass_clock(port, &ccfg);\n\t\tbreak;\n\n\tcase LPAIF_OSR_CLK:\n\t\tccfg.i2s_cfg_minor_version = AFE_API_VERSION_I2S_CONFIG;\n\t\tccfg.clk_val2 = freq;\n\t\tccfg.clk_src = clk_src;\n\t\tccfg.clk_root = clk_root;\n\t\tccfg.clk_set_mode = Q6AFE_LPASS_MODE_CLK2_VALID;\n\t\tret = q6afe_port_set_lpass_clock(port, &ccfg);\n\t\tbreak;\n\tcase Q6AFE_LPASS_CLK_ID_PRI_MI2S_IBIT ... Q6AFE_LPASS_CLK_ID_QUI_MI2S_OSR:\n\tcase Q6AFE_LPASS_CLK_ID_MCLK_1 ... Q6AFE_LPASS_CLK_ID_INT_MCLK_1:\n\tcase Q6AFE_LPASS_CLK_ID_PRI_TDM_IBIT ... Q6AFE_LPASS_CLK_ID_QUIN_TDM_EBIT:\n\tcase Q6AFE_LPASS_CLK_ID_WSA_CORE_MCLK ... Q6AFE_LPASS_CLK_ID_VA_CORE_2X_MCLK:\n\t\tcset.clk_set_minor_version = AFE_API_VERSION_CLOCK_SET;\n\t\tcset.clk_id = clk_id;\n\t\tcset.clk_freq_in_hz = freq;\n\t\tcset.clk_attri = clk_src;\n\t\tcset.clk_root = clk_root;\n\t\tcset.enable = !!freq;\n\t\tret = q6afe_set_lpass_clock_v2(port, &cset);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(q6afe_port_set_sysclk);\n\n \nint q6afe_port_stop(struct q6afe_port *port)\n{\n\tstruct afe_port_cmd_device_stop *stop;\n\tstruct q6afe *afe = port->afe;\n\tstruct apr_pkt *pkt;\n\tint port_id = port->id;\n\tint ret = 0;\n\tint index, pkt_size;\n\tvoid *p;\n\n\tindex = port->token;\n\tif (index < 0 || index >= AFE_PORT_MAX) {\n\t\tdev_err(afe->dev, \"AFE port index[%d] invalid!\\n\", index);\n\t\treturn -EINVAL;\n\t}\n\n\tpkt_size = APR_HDR_SIZE + sizeof(*stop);\n\tp = kzalloc(pkt_size, GFP_KERNEL);\n\tif (!p)\n\t\treturn -ENOMEM;\n\n\tpkt = p;\n\tstop = p + APR_HDR_SIZE;\n\n\tpkt->hdr.hdr_field = APR_HDR_FIELD(APR_MSG_TYPE_SEQ_CMD,\n\t\t\t\t\t   APR_HDR_LEN(APR_HDR_SIZE),\n\t\t\t\t\t   APR_PKT_VER);\n\tpkt->hdr.pkt_size = pkt_size;\n\tpkt->hdr.src_port = 0;\n\tpkt->hdr.dest_port = 0;\n\tpkt->hdr.token = index;\n\tpkt->hdr.opcode = AFE_PORT_CMD_DEVICE_STOP;\n\tstop->port_id = port_id;\n\tstop->reserved = 0;\n\n\tret = afe_apr_send_pkt(afe, pkt, port, AFE_PORT_CMD_DEVICE_STOP);\n\tif (ret)\n\t\tdev_err(afe->dev, \"AFE close failed %d\\n\", ret);\n\n\tkfree(pkt);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(q6afe_port_stop);\n\n \nvoid q6afe_slim_port_prepare(struct q6afe_port *port,\n\t\t\t     struct q6afe_slim_cfg *cfg)\n{\n\tunion afe_port_config *pcfg = &port->port_cfg;\n\n\tpcfg->slim_cfg.sb_cfg_minor_version = AFE_API_VERSION_SLIMBUS_CONFIG;\n\tpcfg->slim_cfg.sample_rate = cfg->sample_rate;\n\tpcfg->slim_cfg.bit_width = cfg->bit_width;\n\tpcfg->slim_cfg.num_channels = cfg->num_channels;\n\tpcfg->slim_cfg.data_format = cfg->data_format;\n\tpcfg->slim_cfg.shared_ch_mapping[0] = cfg->ch_mapping[0];\n\tpcfg->slim_cfg.shared_ch_mapping[1] = cfg->ch_mapping[1];\n\tpcfg->slim_cfg.shared_ch_mapping[2] = cfg->ch_mapping[2];\n\tpcfg->slim_cfg.shared_ch_mapping[3] = cfg->ch_mapping[3];\n\n}\nEXPORT_SYMBOL_GPL(q6afe_slim_port_prepare);\n\n \nvoid q6afe_tdm_port_prepare(struct q6afe_port *port,\n\t\t\t     struct q6afe_tdm_cfg *cfg)\n{\n\tunion afe_port_config *pcfg = &port->port_cfg;\n\n\tpcfg->tdm_cfg.tdm_cfg_minor_version = AFE_API_VERSION_TDM_CONFIG;\n\tpcfg->tdm_cfg.num_channels = cfg->num_channels;\n\tpcfg->tdm_cfg.sample_rate = cfg->sample_rate;\n\tpcfg->tdm_cfg.bit_width = cfg->bit_width;\n\tpcfg->tdm_cfg.data_format = cfg->data_format;\n\tpcfg->tdm_cfg.sync_mode = cfg->sync_mode;\n\tpcfg->tdm_cfg.sync_src = cfg->sync_src;\n\tpcfg->tdm_cfg.nslots_per_frame = cfg->nslots_per_frame;\n\n\tpcfg->tdm_cfg.slot_width = cfg->slot_width;\n\tpcfg->tdm_cfg.slot_mask = cfg->slot_mask;\n\tport->scfg = kzalloc(sizeof(*port->scfg), GFP_KERNEL);\n\tif (!port->scfg)\n\t\treturn;\n\n\tport->scfg->minor_version = AFE_API_VERSION_SLOT_MAPPING_CONFIG;\n\tport->scfg->num_channels = cfg->num_channels;\n\tport->scfg->bitwidth = cfg->bit_width;\n\tport->scfg->data_align_type = cfg->data_align_type;\n\tmemcpy(port->scfg->ch_mapping, cfg->ch_mapping,\n\t\t\tsizeof(u16) * AFE_PORT_MAX_AUDIO_CHAN_CNT);\n}\nEXPORT_SYMBOL_GPL(q6afe_tdm_port_prepare);\n\n \nvoid q6afe_hdmi_port_prepare(struct q6afe_port *port,\n\t\t\t     struct q6afe_hdmi_cfg *cfg)\n{\n\tunion afe_port_config *pcfg = &port->port_cfg;\n\n\tpcfg->hdmi_multi_ch.hdmi_cfg_minor_version =\n\t\t\t\t\tAFE_API_VERSION_HDMI_CONFIG;\n\tpcfg->hdmi_multi_ch.datatype = cfg->datatype;\n\tpcfg->hdmi_multi_ch.channel_allocation = cfg->channel_allocation;\n\tpcfg->hdmi_multi_ch.sample_rate = cfg->sample_rate;\n\tpcfg->hdmi_multi_ch.bit_width = cfg->bit_width;\n}\nEXPORT_SYMBOL_GPL(q6afe_hdmi_port_prepare);\n\n \nint q6afe_i2s_port_prepare(struct q6afe_port *port, struct q6afe_i2s_cfg *cfg)\n{\n\tunion afe_port_config *pcfg = &port->port_cfg;\n\tstruct device *dev = port->afe->dev;\n\tint num_sd_lines;\n\n\tpcfg->i2s_cfg.i2s_cfg_minor_version = AFE_API_VERSION_I2S_CONFIG;\n\tpcfg->i2s_cfg.sample_rate = cfg->sample_rate;\n\tpcfg->i2s_cfg.bit_width = cfg->bit_width;\n\tpcfg->i2s_cfg.data_format = AFE_LINEAR_PCM_DATA;\n\n\tswitch (cfg->fmt & SND_SOC_DAIFMT_CLOCK_PROVIDER_MASK) {\n\tcase SND_SOC_DAIFMT_BP_FP:\n\t\tpcfg->i2s_cfg.ws_src = AFE_PORT_CONFIG_I2S_WS_SRC_INTERNAL;\n\t\tbreak;\n\tcase SND_SOC_DAIFMT_BC_FC:\n\t\t \n\t\tpcfg->i2s_cfg.ws_src = AFE_PORT_CONFIG_I2S_WS_SRC_EXTERNAL;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tnum_sd_lines = hweight_long(cfg->sd_line_mask);\n\n\tswitch (num_sd_lines) {\n\tcase 0:\n\t\tdev_err(dev, \"no line is assigned\\n\");\n\t\treturn -EINVAL;\n\tcase 1:\n\t\tswitch (cfg->sd_line_mask) {\n\t\tcase AFE_PORT_I2S_SD0_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_SD0;\n\t\t\tbreak;\n\t\tcase AFE_PORT_I2S_SD1_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_SD1;\n\t\t\tbreak;\n\t\tcase AFE_PORT_I2S_SD2_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_SD2;\n\t\t\tbreak;\n\t\tcase AFE_PORT_I2S_SD3_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_SD3;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(dev, \"Invalid SD lines\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tswitch (cfg->sd_line_mask) {\n\t\tcase AFE_PORT_I2S_SD0_1_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_QUAD01;\n\t\t\tbreak;\n\t\tcase AFE_PORT_I2S_SD2_3_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_QUAD23;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(dev, \"Invalid SD lines\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\tswitch (cfg->sd_line_mask) {\n\t\tcase AFE_PORT_I2S_SD0_1_2_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_6CHS;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(dev, \"Invalid SD lines\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\tswitch (cfg->sd_line_mask) {\n\t\tcase AFE_PORT_I2S_SD0_1_2_3_MASK:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_8CHS;\n\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(dev, \"Invalid SD lines\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"Invalid SD lines\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (cfg->num_channels) {\n\tcase 1:\n\tcase 2:\n\t\tswitch (pcfg->i2s_cfg.channel_mode) {\n\t\tcase AFE_PORT_I2S_QUAD01:\n\t\tcase AFE_PORT_I2S_6CHS:\n\t\tcase AFE_PORT_I2S_8CHS:\n\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_SD0;\n\t\t\tbreak;\n\t\tcase AFE_PORT_I2S_QUAD23:\n\t\t\t\tpcfg->i2s_cfg.channel_mode = AFE_PORT_I2S_SD2;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (cfg->num_channels == 2)\n\t\t\tpcfg->i2s_cfg.mono_stereo = AFE_PORT_I2S_STEREO;\n\t\telse\n\t\t\tpcfg->i2s_cfg.mono_stereo = AFE_PORT_I2S_MONO;\n\n\t\tbreak;\n\tcase 3:\n\tcase 4:\n\t\tif (pcfg->i2s_cfg.channel_mode < AFE_PORT_I2S_QUAD01) {\n\t\t\tdev_err(dev, \"Invalid Channel mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase 5:\n\tcase 6:\n\t\tif (pcfg->i2s_cfg.channel_mode < AFE_PORT_I2S_6CHS) {\n\t\t\tdev_err(dev, \"Invalid Channel mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase 7:\n\tcase 8:\n\t\tif (pcfg->i2s_cfg.channel_mode < AFE_PORT_I2S_8CHS) {\n\t\t\tdev_err(dev, \"Invalid Channel mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(q6afe_i2s_port_prepare);\n\n \nvoid q6afe_cdc_dma_port_prepare(struct q6afe_port *port,\n\t\t\t\tstruct q6afe_cdc_dma_cfg *cfg)\n{\n\tunion afe_port_config *pcfg = &port->port_cfg;\n\tstruct afe_param_id_cdc_dma_cfg *dma_cfg = &pcfg->dma_cfg;\n\n\tdma_cfg->cdc_dma_cfg_minor_version = AFE_API_VERSION_CODEC_DMA_CONFIG;\n\tdma_cfg->sample_rate = cfg->sample_rate;\n\tdma_cfg->bit_width = cfg->bit_width;\n\tdma_cfg->data_format = cfg->data_format;\n\tdma_cfg->num_channels = cfg->num_channels;\n\tif (!cfg->active_channels_mask)\n\t\tdma_cfg->active_channels_mask = (1 << cfg->num_channels) - 1;\n}\nEXPORT_SYMBOL_GPL(q6afe_cdc_dma_port_prepare);\n \nint q6afe_port_start(struct q6afe_port *port)\n{\n\tstruct afe_port_cmd_device_start *start;\n\tstruct q6afe *afe = port->afe;\n\tint port_id = port->id;\n\tint ret, param_id = port->cfg_type;\n\tstruct apr_pkt *pkt;\n\tint pkt_size;\n\tvoid *p;\n\n\tret  = q6afe_port_set_param_v2(port, &port->port_cfg, param_id,\n\t\t\t\t       AFE_MODULE_AUDIO_DEV_INTERFACE,\n\t\t\t\t       sizeof(port->port_cfg));\n\tif (ret) {\n\t\tdev_err(afe->dev, \"AFE enable for port 0x%x failed %d\\n\",\n\t\t\tport_id, ret);\n\t\treturn ret;\n\t}\n\n\tif (port->scfg) {\n\t\tret  = q6afe_port_set_param_v2(port, port->scfg,\n\t\t\t\t\tAFE_PARAM_ID_PORT_SLOT_MAPPING_CONFIG,\n\t\t\t\t\tAFE_MODULE_TDM, sizeof(*port->scfg));\n\t\tif (ret) {\n\t\t\tdev_err(afe->dev, \"AFE enable for port 0x%x failed %d\\n\",\n\t\t\tport_id, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tpkt_size = APR_HDR_SIZE + sizeof(*start);\n\tp = kzalloc(pkt_size, GFP_KERNEL);\n\tif (!p)\n\t\treturn -ENOMEM;\n\n\tpkt = p;\n\tstart = p + APR_HDR_SIZE;\n\n\tpkt->hdr.hdr_field = APR_HDR_FIELD(APR_MSG_TYPE_SEQ_CMD,\n\t\t\t\t\t    APR_HDR_LEN(APR_HDR_SIZE),\n\t\t\t\t\t    APR_PKT_VER);\n\tpkt->hdr.pkt_size = pkt_size;\n\tpkt->hdr.src_port = 0;\n\tpkt->hdr.dest_port = 0;\n\tpkt->hdr.token = port->token;\n\tpkt->hdr.opcode = AFE_PORT_CMD_DEVICE_START;\n\n\tstart->port_id = port_id;\n\n\tret = afe_apr_send_pkt(afe, pkt, port, AFE_PORT_CMD_DEVICE_START);\n\tif (ret)\n\t\tdev_err(afe->dev, \"AFE enable for port 0x%x failed %d\\n\",\n\t\t\tport_id, ret);\n\n\tkfree(pkt);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(q6afe_port_start);\n\n \nstruct q6afe_port *q6afe_port_get_from_id(struct device *dev, int id)\n{\n\tint port_id;\n\tstruct q6afe *afe = dev_get_drvdata(dev->parent);\n\tstruct q6afe_port *port;\n\tunsigned long flags;\n\tint cfg_type;\n\n\tif (id < 0 || id >= AFE_PORT_MAX) {\n\t\tdev_err(dev, \"AFE port token[%d] invalid!\\n\", id);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\t \n\tport = q6afe_find_port(afe, id);\n\tif (port) {\n\t\tdev_err(dev, \"AFE Port already open\\n\");\n\t\treturn port;\n\t}\n\n\tport_id = port_maps[id].port_id;\n\n\tswitch (port_id) {\n\tcase AFE_PORT_ID_MULTICHAN_HDMI_RX:\n\tcase AFE_PORT_ID_HDMI_OVER_DP_RX:\n\t\tcfg_type = AFE_PARAM_ID_HDMI_CONFIG;\n\t\tbreak;\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_0_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_1_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_2_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_3_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_4_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_5_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_6_TX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_0_RX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_1_RX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_2_RX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_3_RX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_4_RX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_5_RX:\n\tcase AFE_PORT_ID_SLIMBUS_MULTI_CHAN_6_RX:\n\t\tcfg_type = AFE_PARAM_ID_SLIMBUS_CONFIG;\n\t\tbreak;\n\n\tcase AFE_PORT_ID_PRIMARY_MI2S_RX:\n\tcase AFE_PORT_ID_PRIMARY_MI2S_TX:\n\tcase AFE_PORT_ID_SECONDARY_MI2S_RX:\n\tcase AFE_PORT_ID_SECONDARY_MI2S_TX:\n\tcase AFE_PORT_ID_TERTIARY_MI2S_RX:\n\tcase AFE_PORT_ID_TERTIARY_MI2S_TX:\n\tcase AFE_PORT_ID_QUATERNARY_MI2S_RX:\n\tcase AFE_PORT_ID_QUATERNARY_MI2S_TX:\n\tcase AFE_PORT_ID_QUINARY_MI2S_RX:\n\tcase AFE_PORT_ID_QUINARY_MI2S_TX:\n\t\tcfg_type = AFE_PARAM_ID_I2S_CONFIG;\n\t\tbreak;\n\tcase AFE_PORT_ID_PRIMARY_TDM_RX ... AFE_PORT_ID_QUINARY_TDM_TX_7:\n\t\tcfg_type = AFE_PARAM_ID_TDM_CONFIG;\n\t\tbreak;\n\tcase AFE_PORT_ID_WSA_CODEC_DMA_RX_0 ... AFE_PORT_ID_RX_CODEC_DMA_RX_7:\n\t\tcfg_type = AFE_PARAM_ID_CODEC_DMA_CONFIG;\n\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"Invalid port id 0x%x\\n\", port_id);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tport = kzalloc(sizeof(*port), GFP_KERNEL);\n\tif (!port)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit_waitqueue_head(&port->wait);\n\n\tport->token = id;\n\tport->id = port_id;\n\tport->afe = afe;\n\tport->cfg_type = cfg_type;\n\tkref_init(&port->refcount);\n\n\tspin_lock_irqsave(&afe->port_list_lock, flags);\n\tlist_add_tail(&port->node, &afe->port_list);\n\tspin_unlock_irqrestore(&afe->port_list_lock, flags);\n\n\treturn port;\n\n}\nEXPORT_SYMBOL_GPL(q6afe_port_get_from_id);\n\n \nvoid q6afe_port_put(struct q6afe_port *port)\n{\n\tkref_put(&port->refcount, q6afe_port_free);\n}\nEXPORT_SYMBOL_GPL(q6afe_port_put);\n\nint q6afe_unvote_lpass_core_hw(struct device *dev, uint32_t hw_block_id,\n\t\t\t       uint32_t client_handle)\n{\n\tstruct q6afe *afe = dev_get_drvdata(dev->parent);\n\tstruct afe_cmd_remote_lpass_core_hw_devote_request *vote_cfg;\n\tstruct apr_pkt *pkt;\n\tint ret = 0;\n\tint pkt_size;\n\tvoid *p;\n\n\tpkt_size = APR_HDR_SIZE + sizeof(*vote_cfg);\n\tp = kzalloc(pkt_size, GFP_KERNEL);\n\tif (!p)\n\t\treturn -ENOMEM;\n\n\tpkt = p;\n\tvote_cfg = p + APR_HDR_SIZE;\n\n\tpkt->hdr.hdr_field = APR_HDR_FIELD(APR_MSG_TYPE_SEQ_CMD,\n\t\t\t\t\t   APR_HDR_LEN(APR_HDR_SIZE),\n\t\t\t\t\t   APR_PKT_VER);\n\tpkt->hdr.pkt_size = pkt_size;\n\tpkt->hdr.src_port = 0;\n\tpkt->hdr.dest_port = 0;\n\tpkt->hdr.token = hw_block_id;\n\tpkt->hdr.opcode = AFE_CMD_REMOTE_LPASS_CORE_HW_DEVOTE_REQUEST;\n\tvote_cfg->hw_block_id = hw_block_id;\n\tvote_cfg->client_handle = client_handle;\n\n\tret = apr_send_pkt(afe->apr, pkt);\n\tif (ret < 0)\n\t\tdev_err(afe->dev, \"AFE failed to unvote (%d)\\n\", hw_block_id);\n\n\tkfree(pkt);\n\treturn ret;\n}\nEXPORT_SYMBOL(q6afe_unvote_lpass_core_hw);\n\nint q6afe_vote_lpass_core_hw(struct device *dev, uint32_t hw_block_id,\n\t\t\t     const char *client_name, uint32_t *client_handle)\n{\n\tstruct q6afe *afe = dev_get_drvdata(dev->parent);\n\tstruct afe_cmd_remote_lpass_core_hw_vote_request *vote_cfg;\n\tstruct apr_pkt *pkt;\n\tint ret = 0;\n\tint pkt_size;\n\tvoid *p;\n\n\tpkt_size = APR_HDR_SIZE + sizeof(*vote_cfg);\n\tp = kzalloc(pkt_size, GFP_KERNEL);\n\tif (!p)\n\t\treturn -ENOMEM;\n\n\tpkt = p;\n\tvote_cfg = p + APR_HDR_SIZE;\n\n\tpkt->hdr.hdr_field = APR_HDR_FIELD(APR_MSG_TYPE_SEQ_CMD,\n\t\t\t\t\t   APR_HDR_LEN(APR_HDR_SIZE),\n\t\t\t\t\t   APR_PKT_VER);\n\tpkt->hdr.pkt_size = pkt_size;\n\tpkt->hdr.src_port = 0;\n\tpkt->hdr.dest_port = 0;\n\tpkt->hdr.token = hw_block_id;\n\tpkt->hdr.opcode = AFE_CMD_REMOTE_LPASS_CORE_HW_VOTE_REQUEST;\n\tvote_cfg->hw_block_id = hw_block_id;\n\tstrscpy(vote_cfg->client_name, client_name,\n\t\t\tsizeof(vote_cfg->client_name));\n\n\tret = afe_apr_send_pkt(afe, pkt, NULL,\n\t\t\t       AFE_CMD_RSP_REMOTE_LPASS_CORE_HW_VOTE_REQUEST);\n\tif (ret)\n\t\tdev_err(afe->dev, \"AFE failed to vote (%d)\\n\", hw_block_id);\n\n\n\tkfree(pkt);\n\treturn ret;\n}\nEXPORT_SYMBOL(q6afe_vote_lpass_core_hw);\n\nstatic int q6afe_probe(struct apr_device *adev)\n{\n\tstruct q6afe *afe;\n\tstruct device *dev = &adev->dev;\n\n\tafe = devm_kzalloc(dev, sizeof(*afe), GFP_KERNEL);\n\tif (!afe)\n\t\treturn -ENOMEM;\n\n\tq6core_get_svc_api_info(adev->svc_id, &afe->ainfo);\n\tafe->apr = adev;\n\tmutex_init(&afe->lock);\n\tinit_waitqueue_head(&afe->wait);\n\tafe->dev = dev;\n\tINIT_LIST_HEAD(&afe->port_list);\n\tspin_lock_init(&afe->port_list_lock);\n\n\tdev_set_drvdata(dev, afe);\n\n\treturn devm_of_platform_populate(dev);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id q6afe_device_id[]  = {\n\t{ .compatible = \"qcom,q6afe\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, q6afe_device_id);\n#endif\n\nstatic struct apr_driver qcom_q6afe_driver = {\n\t.probe = q6afe_probe,\n\t.callback = q6afe_callback,\n\t.driver = {\n\t\t.name = \"qcom-q6afe\",\n\t\t.of_match_table = of_match_ptr(q6afe_device_id),\n\n\t},\n};\n\nmodule_apr_driver(qcom_q6afe_driver);\nMODULE_DESCRIPTION(\"Q6 Audio Front End\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}