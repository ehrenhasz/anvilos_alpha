{
  "module_name": "lpass-hdmi.c",
  "hash_id": "a13ead8375fe2648291a28ebd96096ce09fd908070abcf321a3fb49afa20c398",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/qcom/lpass-hdmi.c",
  "human_readable_source": "\n \n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <sound/pcm_params.h>\n#include <linux/regmap.h>\n#include <sound/soc.h>\n#include <sound/soc-dai.h>\n#include <dt-bindings/sound/sc7180-lpass.h>\n#include \"lpass-lpaif-reg.h\"\n#include \"lpass.h\"\n\nstatic int lpass_hdmi_daiops_hw_params(struct snd_pcm_substream *substream,\n\t\tstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\n{\n\tstruct lpass_data *drvdata = snd_soc_dai_get_drvdata(dai);\n\tsnd_pcm_format_t format = params_format(params);\n\tunsigned int rate = params_rate(params);\n\tunsigned int channels = params_channels(params);\n\tunsigned int ret;\n\tint bitwidth;\n\tunsigned int word_length;\n\tunsigned int ch_sts_buf0;\n\tunsigned int ch_sts_buf1;\n\tunsigned int data_format;\n\tunsigned int sampling_freq;\n\tunsigned int ch = 0;\n\tstruct lpass_dp_metadata_ctl *meta_ctl = drvdata->meta_ctl;\n\tstruct lpass_sstream_ctl *sstream_ctl = drvdata->sstream_ctl;\n\n\tbitwidth = snd_pcm_format_width(format);\n\tif (bitwidth < 0) {\n\t\tdev_err(dai->dev, \"%s invalid bit width given : %d\\n\",\n\t\t\t\t\t__func__, bitwidth);\n\t\treturn bitwidth;\n\t}\n\n\tswitch (bitwidth) {\n\tcase 16:\n\t\tword_length = LPASS_DP_AUDIO_BITWIDTH16;\n\t\tbreak;\n\tcase 24:\n\t\tword_length = LPASS_DP_AUDIO_BITWIDTH24;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dai->dev, \"%s invalid bit width given : %d\\n\",\n\t\t\t\t\t__func__, bitwidth);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (rate) {\n\tcase 32000:\n\t\tsampling_freq = LPASS_SAMPLING_FREQ32;\n\t\tbreak;\n\tcase 44100:\n\t\tsampling_freq = LPASS_SAMPLING_FREQ44;\n\t\tbreak;\n\tcase 48000:\n\t\tsampling_freq = LPASS_SAMPLING_FREQ48;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dai->dev, \"%s invalid bit width given : %d\\n\",\n\t\t\t\t\t__func__, bitwidth);\n\t\treturn -EINVAL;\n\t}\n\tdata_format = LPASS_DATA_FORMAT_LINEAR;\n\tch_sts_buf0 = (((data_format << LPASS_DATA_FORMAT_SHIFT) & LPASS_DATA_FORMAT_MASK)\n\t\t\t\t| ((sampling_freq << LPASS_FREQ_BIT_SHIFT) & LPASS_FREQ_BIT_MASK));\n\tch_sts_buf1 = (word_length) & LPASS_WORDLENGTH_MASK;\n\n\tret = regmap_field_write(drvdata->tx_ctl->soft_reset, LPASS_TX_CTL_RESET);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->tx_ctl->soft_reset, LPASS_TX_CTL_CLEAR);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmitx_legacy_en, LPASS_HDMITX_LEGACY_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmitx_parity_calc_en, HDMITX_PARITY_CALC_EN);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->vbit_ctl->replace_vbit, REPLACE_VBIT);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->vbit_ctl->vbit_stream, LINEAR_PCM_DATA);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmitx_ch_msb[0], ch_sts_buf1);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmitx_ch_lsb[0], ch_sts_buf0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmi_tx_dmactl[0]->use_hw_chs, HW_MODE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmi_tx_dmactl[0]->hw_chs_sel, SW_MODE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmi_tx_dmactl[0]->use_hw_usr, HW_MODE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->hdmi_tx_dmactl[0]->hw_usr_sel, SW_MODE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->mute, LPASS_MUTE_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->as_sdp_cc, channels - 1);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->as_sdp_ct, LPASS_META_DEFAULT_VAL);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->aif_db4, LPASS_META_DEFAULT_VAL);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->frequency, sampling_freq);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->mst_index, LPASS_META_DEFAULT_VAL);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(meta_ctl->dptx_index, LPASS_META_DEFAULT_VAL);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->sstream_en, LPASS_SSTREAM_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->dma_sel, ch);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->auto_bbit_en, LPASS_SSTREAM_DEFAULT_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->layout, LPASS_SSTREAM_DEFAULT_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->layout_sp, LPASS_LAYOUT_SP_DEFAULT);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->dp_audio, LPASS_SSTREAM_DEFAULT_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->set_sp_on_en, LPASS_SSTREAM_DEFAULT_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->dp_sp_b_hw_en, LPASS_SSTREAM_DEFAULT_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(sstream_ctl->dp_staffing_en, LPASS_SSTREAM_DEFAULT_ENABLE);\n\n\treturn ret;\n}\n\nstatic int lpass_hdmi_daiops_prepare(struct snd_pcm_substream *substream,\n\t\tstruct snd_soc_dai *dai)\n{\n\tint ret;\n\tstruct lpass_data *drvdata = snd_soc_dai_get_drvdata(dai);\n\n\tret = regmap_field_write(drvdata->sstream_ctl->sstream_en, LPASS_SSTREAM_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_field_write(drvdata->meta_ctl->mute, LPASS_MUTE_DISABLE);\n\n\treturn ret;\n}\n\nstatic int lpass_hdmi_daiops_trigger(struct snd_pcm_substream *substream,\n\t\tint cmd, struct snd_soc_dai *dai)\n{\n\tstruct lpass_data *drvdata = snd_soc_dai_get_drvdata(dai);\n\tstruct lpass_dp_metadata_ctl *meta_ctl = drvdata->meta_ctl;\n\tstruct lpass_sstream_ctl *sstream_ctl = drvdata->sstream_ctl;\n\tint ret = -EINVAL;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tret = regmap_field_write(sstream_ctl->sstream_en, LPASS_SSTREAM_ENABLE);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = regmap_field_write(meta_ctl->mute, LPASS_MUTE_DISABLE);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tret = regmap_field_write(sstream_ctl->sstream_en, LPASS_SSTREAM_DISABLE);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = regmap_field_write(meta_ctl->mute, LPASS_MUTE_ENABLE);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = regmap_field_write(sstream_ctl->dp_audio, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nconst struct snd_soc_dai_ops asoc_qcom_lpass_hdmi_dai_ops = {\n\t.hw_params\t= lpass_hdmi_daiops_hw_params,\n\t.prepare\t= lpass_hdmi_daiops_prepare,\n\t.trigger\t= lpass_hdmi_daiops_trigger,\n};\nEXPORT_SYMBOL_GPL(asoc_qcom_lpass_hdmi_dai_ops);\n\nMODULE_DESCRIPTION(\"QTi LPASS HDMI Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}