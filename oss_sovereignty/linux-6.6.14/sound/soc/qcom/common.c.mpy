{
  "module_name": "common.c",
  "hash_id": "ef8b446d25a47ffa8532b17846f5291b0a4bc48c1cafeb518d6790963d3cc83d",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/qcom/common.c",
  "human_readable_source": "\n\n\n\n#include <linux/module.h>\n#include <sound/jack.h>\n#include <linux/input-event-codes.h>\n#include \"qdsp6/q6afe.h\"\n#include \"common.h\"\n\nstatic const struct snd_soc_dapm_widget qcom_jack_snd_widgets[] = {\n\tSND_SOC_DAPM_HP(\"Headphone Jack\", NULL),\n\tSND_SOC_DAPM_MIC(\"Mic Jack\", NULL),\n};\n\nint qcom_snd_parse_of(struct snd_soc_card *card)\n{\n\tstruct device_node *np;\n\tstruct device_node *codec = NULL;\n\tstruct device_node *platform = NULL;\n\tstruct device_node *cpu = NULL;\n\tstruct device *dev = card->dev;\n\tstruct snd_soc_dai_link *link;\n\tstruct of_phandle_args args;\n\tstruct snd_soc_dai_link_component *dlc;\n\tint ret, num_links;\n\n\tret = snd_soc_of_parse_card_name(card, \"model\");\n\tif (ret == 0 && !card->name)\n\t\t \n\t\tret = snd_soc_of_parse_card_name(card, \"qcom,model\");\n\tif (ret) {\n\t\tdev_err(dev, \"Error parsing card name: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (of_property_read_bool(dev->of_node, \"widgets\")) {\n\t\tret = snd_soc_of_parse_audio_simple_widgets(card, \"widgets\");\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (of_property_read_bool(dev->of_node, \"audio-routing\")) {\n\t\tret = snd_soc_of_parse_audio_routing(card, \"audio-routing\");\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\t \n\tif (of_property_read_bool(dev->of_node, \"qcom,audio-routing\")) {\n\t\tret = snd_soc_of_parse_audio_routing(card, \"qcom,audio-routing\");\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = snd_soc_of_parse_pin_switches(card, \"pin-switches\");\n\tif (ret)\n\t\treturn ret;\n\n\tret = snd_soc_of_parse_aux_devs(card, \"aux-devs\");\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tnum_links = of_get_available_child_count(dev->of_node);\n\n\t \n\tcard->dai_link = devm_kcalloc(dev, num_links, sizeof(*link), GFP_KERNEL);\n\tif (!card->dai_link)\n\t\treturn -ENOMEM;\n\n\tcard->num_links = num_links;\n\tlink = card->dai_link;\n\n\tfor_each_available_child_of_node(dev->of_node, np) {\n\t\tdlc = devm_kzalloc(dev, 2 * sizeof(*dlc), GFP_KERNEL);\n\t\tif (!dlc) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto err_put_np;\n\t\t}\n\n\t\tlink->cpus\t= &dlc[0];\n\t\tlink->platforms\t= &dlc[1];\n\n\t\tlink->num_cpus\t\t= 1;\n\t\tlink->num_platforms\t= 1;\n\n\t\tret = of_property_read_string(np, \"link-name\", &link->name);\n\t\tif (ret) {\n\t\t\tdev_err(card->dev, \"error getting codec dai_link name\\n\");\n\t\t\tgoto err_put_np;\n\t\t}\n\n\t\tcpu = of_get_child_by_name(np, \"cpu\");\n\t\tplatform = of_get_child_by_name(np, \"platform\");\n\t\tcodec = of_get_child_by_name(np, \"codec\");\n\n\t\tif (!cpu) {\n\t\t\tdev_err(dev, \"%s: Can't find cpu DT node\\n\", link->name);\n\t\t\tret = -EINVAL;\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = snd_soc_of_get_dlc(cpu, &args, link->cpus, 0);\n\t\tif (ret) {\n\t\t\tdev_err_probe(card->dev, ret,\n\t\t\t\t      \"%s: error getting cpu dai name\\n\", link->name);\n\t\t\tgoto err;\n\t\t}\n\n\t\tlink->id = args.args[0];\n\n\t\tif (platform) {\n\t\t\tlink->platforms->of_node = of_parse_phandle(platform,\n\t\t\t\t\t\"sound-dai\",\n\t\t\t\t\t0);\n\t\t\tif (!link->platforms->of_node) {\n\t\t\t\tdev_err(card->dev, \"%s: platform dai not found\\n\", link->name);\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto err;\n\t\t\t}\n\t\t} else {\n\t\t\tlink->platforms->of_node = link->cpus->of_node;\n\t\t}\n\n\t\tif (codec) {\n\t\t\tret = snd_soc_of_get_dai_link_codecs(dev, codec, link);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err_probe(card->dev, ret,\n\t\t\t\t\t      \"%s: codec dai not found\\n\", link->name);\n\t\t\t\tgoto err;\n\t\t\t}\n\n\t\t\tif (platform) {\n\t\t\t\t \n\t\t\t\tlink->no_pcm = 1;\n\t\t\t\tlink->ignore_pmdown_time = 1;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tlink->codecs\t = &asoc_dummy_dlc;\n\t\t\tlink->num_codecs = 1;\n\t\t\tlink->dynamic = 1;\n\t\t}\n\n\t\tif (platform || !codec) {\n\t\t\t \n\t\t\tsnd_soc_dai_link_set_capabilities(link);\n\t\t\tlink->ignore_suspend = 1;\n\t\t\tlink->nonatomic = 1;\n\t\t}\n\n\t\tlink->stream_name = link->name;\n\t\tlink++;\n\n\t\tof_node_put(cpu);\n\t\tof_node_put(codec);\n\t\tof_node_put(platform);\n\t}\n\n\tif (!card->dapm_widgets) {\n\t\tcard->dapm_widgets = qcom_jack_snd_widgets;\n\t\tcard->num_dapm_widgets = ARRAY_SIZE(qcom_jack_snd_widgets);\n\t}\n\n\treturn 0;\nerr:\n\tof_node_put(cpu);\n\tof_node_put(codec);\n\tof_node_put(platform);\nerr_put_np:\n\tof_node_put(np);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(qcom_snd_parse_of);\n\nstatic struct snd_soc_jack_pin qcom_headset_jack_pins[] = {\n\t \n\t{\n\t\t.pin = \"Mic Jack\",\n\t\t.mask = SND_JACK_MICROPHONE,\n\t},\n\t{\n\t\t.pin = \"Headphone Jack\",\n\t\t.mask = SND_JACK_HEADPHONE,\n\t},\n};\n\nint qcom_snd_wcd_jack_setup(struct snd_soc_pcm_runtime *rtd,\n\t\t\t    struct snd_soc_jack *jack, bool *jack_setup)\n{\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_card *card = rtd->card;\n\tint rval, i;\n\n\tif (!*jack_setup) {\n\t\trval = snd_soc_card_jack_new_pins(card, \"Headset Jack\",\n\t\t\t\t\t     SND_JACK_HEADSET | SND_JACK_LINEOUT |\n\t\t\t\t\t     SND_JACK_MECHANICAL |\n\t\t\t\t\t     SND_JACK_BTN_0 | SND_JACK_BTN_1 |\n\t\t\t\t\t     SND_JACK_BTN_2 | SND_JACK_BTN_3 |\n\t\t\t\t\t     SND_JACK_BTN_4 | SND_JACK_BTN_5,\n\t\t\t\t\t     jack, qcom_headset_jack_pins,\n\t\t\t\t\t     ARRAY_SIZE(qcom_headset_jack_pins));\n\n\t\tif (rval < 0) {\n\t\t\tdev_err(card->dev, \"Unable to add Headphone Jack\\n\");\n\t\t\treturn rval;\n\t\t}\n\n\t\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_MEDIA);\n\t\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\n\t\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\n\t\tsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\n\t\t*jack_setup = true;\n\t}\n\n\tswitch (cpu_dai->id) {\n\tcase TX_CODEC_DMA_TX_0:\n\tcase TX_CODEC_DMA_TX_1:\n\tcase TX_CODEC_DMA_TX_2:\n\tcase TX_CODEC_DMA_TX_3:\n\t\tfor_each_rtd_codec_dais(rtd, i, codec_dai) {\n\t\t\trval = snd_soc_component_set_jack(codec_dai->component,\n\t\t\t\t\t\t\t  jack, NULL);\n\t\t\tif (rval != 0 && rval != -ENOTSUPP) {\n\t\t\t\tdev_warn(card->dev, \"Failed to set jack: %d\\n\", rval);\n\t\t\t\treturn rval;\n\t\t\t}\n\t\t}\n\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(qcom_snd_wcd_jack_setup);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}