{
  "module_name": "storm.c",
  "hash_id": "fa4399d25354da5f5b3885c4f4dace7ef33311ae9e21bc33a3aaeb0a71ff1229",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/qcom/storm.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#define STORM_SYSCLK_MULT\t\t\t4\n\nstatic int storm_ops_hw_params(struct snd_pcm_substream *substream,\n\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *soc_runtime = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_card *card = soc_runtime->card;\n\tsnd_pcm_format_t format = params_format(params);\n\tunsigned int rate = params_rate(params);\n\tunsigned int sysclk_freq;\n\tint bitwidth, ret;\n\n\tbitwidth = snd_pcm_format_width(format);\n\tif (bitwidth < 0) {\n\t\tdev_err(card->dev, \"invalid bit width given: %d\\n\", bitwidth);\n\t\treturn bitwidth;\n\t}\n\n\t \n\tsysclk_freq = rate * bitwidth * 2 * STORM_SYSCLK_MULT;\n\n\tret = snd_soc_dai_set_sysclk(asoc_rtd_to_cpu(soc_runtime, 0), 0, sysclk_freq, 0);\n\tif (ret) {\n\t\tdev_err(card->dev, \"error setting sysclk to %u: %d\\n\",\n\t\t\tsysclk_freq, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops storm_soc_ops = {\n\t.hw_params\t= storm_ops_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(hifi,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"HiFi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link storm_dai_link = {\n\t.name\t\t= \"Primary\",\n\t.stream_name\t= \"Primary\",\n\t.ops\t\t= &storm_soc_ops,\n\tSND_SOC_DAILINK_REG(hifi),\n};\n\nstatic int storm_parse_of(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai_link *dai_link = card->dai_link;\n\tstruct device_node *np = card->dev->of_node;\n\n\tdai_link->cpus->of_node = of_parse_phandle(np, \"cpu\", 0);\n\tif (!dai_link->cpus->of_node) {\n\t\tdev_err(card->dev, \"error getting cpu phandle\\n\");\n\t\treturn -EINVAL;\n\t}\n\tdai_link->platforms->of_node = dai_link->cpus->of_node;\n\n\tdai_link->codecs->of_node = of_parse_phandle(np, \"codec\", 0);\n\tif (!dai_link->codecs->of_node) {\n\t\tdev_err(card->dev, \"error getting codec phandle\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int storm_platform_probe(struct platform_device *pdev)\n{\n\tstruct snd_soc_card *card;\n\tint ret;\n\n\tcard = devm_kzalloc(&pdev->dev, sizeof(*card), GFP_KERNEL);\n\tif (!card)\n\t\treturn -ENOMEM;\n\n\tcard->dev = &pdev->dev;\n\tcard->owner = THIS_MODULE;\n\n\tret = snd_soc_of_parse_card_name(card, \"qcom,model\");\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"error parsing card name: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tcard->dai_link\t= &storm_dai_link;\n\tcard->num_links\t= 1;\n\n\tret = storm_parse_of(card);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"error resolving dai links: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\tif (ret)\n\t\tdev_err(&pdev->dev, \"error registering soundcard: %d\\n\", ret);\n\n\treturn ret;\n\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id storm_device_id[]  = {\n\t{ .compatible = \"google,storm-audio\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, storm_device_id);\n#endif\n\nstatic struct platform_driver storm_platform_driver = {\n\t.driver = {\n\t\t.name = \"storm-audio\",\n\t\t.of_match_table =\n\t\t\tof_match_ptr(storm_device_id),\n\t},\n\t.probe = storm_platform_probe,\n};\nmodule_platform_driver(storm_platform_driver);\n\nMODULE_DESCRIPTION(\"QTi IPQ806x-based Storm Machine Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}