{
  "module_name": "spdif_in.c",
  "hash_id": "bd0dc061b47968ddbaf6c08fc45e602e7d880044b4a9e23b5ae38142120df5be",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/spear/spdif_in.c",
  "human_readable_source": " \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <sound/dmaengine_pcm.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n#include <sound/spear_dma.h>\n#include <sound/spear_spdif.h>\n#include \"spdif_in_regs.h\"\n#include \"spear_pcm.h\"\n\nstruct spdif_in_params {\n\tu32 format;\n};\n\nstruct spdif_in_dev {\n\tstruct clk *clk;\n\tstruct spear_dma_data dma_params;\n\tstruct spdif_in_params saved_params;\n\tvoid *io_base;\n\tstruct device *dev;\n\tvoid (*reset_perip)(void);\n\tint irq;\n\tstruct snd_dmaengine_dai_dma_data dma_params_rx;\n\tstruct snd_dmaengine_pcm_config config;\n};\n\nstatic void spdif_in_configure(struct spdif_in_dev *host)\n{\n\tu32 ctrl = SPDIF_IN_PRTYEN | SPDIF_IN_STATEN | SPDIF_IN_USREN |\n\t\tSPDIF_IN_VALEN | SPDIF_IN_BLKEN;\n\tctrl |= SPDIF_MODE_16BIT | SPDIF_FIFO_THRES_16;\n\n\twritel(ctrl, host->io_base + SPDIF_IN_CTRL);\n\twritel(0xF, host->io_base + SPDIF_IN_IRQ_MASK);\n}\n\nstatic int spdif_in_dai_probe(struct snd_soc_dai *dai)\n{\n\tstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\n\n\thost->dma_params_rx.filter_data = &host->dma_params;\n\tdai->capture_dma_data = &host->dma_params_rx;\n\n\treturn 0;\n}\n\nstatic void spdif_in_shutdown(struct snd_pcm_substream *substream,\n\t\tstruct snd_soc_dai *dai)\n{\n\tstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\n\n\tif (substream->stream != SNDRV_PCM_STREAM_CAPTURE)\n\t\treturn;\n\n\twritel(0x0, host->io_base + SPDIF_IN_IRQ_MASK);\n}\n\nstatic void spdif_in_format(struct spdif_in_dev *host, u32 format)\n{\n\tu32 ctrl = readl(host->io_base + SPDIF_IN_CTRL);\n\n\tswitch (format) {\n\tcase SNDRV_PCM_FORMAT_S16_LE:\n\t\tctrl |= SPDIF_XTRACT_16BIT;\n\t\tbreak;\n\n\tcase SNDRV_PCM_FORMAT_IEC958_SUBFRAME_LE:\n\t\tctrl &= ~SPDIF_XTRACT_16BIT;\n\t\tbreak;\n\t}\n\n\twritel(ctrl, host->io_base + SPDIF_IN_CTRL);\n}\n\nstatic int spdif_in_hw_params(struct snd_pcm_substream *substream,\n\t\tstruct snd_pcm_hw_params *params,\n\t\tstruct snd_soc_dai *dai)\n{\n\tstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\n\tu32 format;\n\n\tif (substream->stream != SNDRV_PCM_STREAM_CAPTURE)\n\t\treturn -EINVAL;\n\n\tformat = params_format(params);\n\thost->saved_params.format = format;\n\n\treturn 0;\n}\n\nstatic int spdif_in_trigger(struct snd_pcm_substream *substream, int cmd,\n\t\tstruct snd_soc_dai *dai)\n{\n\tstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\n\tu32 ctrl;\n\tint ret = 0;\n\n\tif (substream->stream != SNDRV_PCM_STREAM_CAPTURE)\n\t\treturn -EINVAL;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\tcase SNDRV_PCM_TRIGGER_RESUME:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\n\t\tclk_enable(host->clk);\n\t\tspdif_in_configure(host);\n\t\tspdif_in_format(host, host->saved_params.format);\n\n\t\tctrl = readl(host->io_base + SPDIF_IN_CTRL);\n\t\tctrl |= SPDIF_IN_SAMPLE | SPDIF_IN_ENB;\n\t\twritel(ctrl, host->io_base + SPDIF_IN_CTRL);\n\t\twritel(0xF, host->io_base + SPDIF_IN_IRQ_MASK);\n\t\tbreak;\n\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\tcase SNDRV_PCM_TRIGGER_SUSPEND:\n\tcase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\n\t\tctrl = readl(host->io_base + SPDIF_IN_CTRL);\n\t\tctrl &= ~(SPDIF_IN_SAMPLE | SPDIF_IN_ENB);\n\t\twritel(ctrl, host->io_base + SPDIF_IN_CTRL);\n\t\twritel(0x0, host->io_base + SPDIF_IN_IRQ_MASK);\n\n\t\tif (host->reset_perip)\n\t\t\thost->reset_perip();\n\t\tclk_disable(host->clk);\n\t\tbreak;\n\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic const struct snd_soc_dai_ops spdif_in_dai_ops = {\n\t.shutdown\t= spdif_in_shutdown,\n\t.trigger\t= spdif_in_trigger,\n\t.hw_params\t= spdif_in_hw_params,\n};\n\nstatic struct snd_soc_dai_driver spdif_in_dai = {\n\t.probe = spdif_in_dai_probe,\n\t.capture = {\n\t\t.channels_min = 2,\n\t\t.channels_max = 2,\n\t\t.rates = (SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 | \\\n\t\t\t\t SNDRV_PCM_RATE_48000 | SNDRV_PCM_RATE_96000 | \\\n\t\t\t\t SNDRV_PCM_RATE_192000),\n\t\t.formats = SNDRV_PCM_FMTBIT_S16_LE | \\\n\t\t\t   SNDRV_PCM_FMTBIT_IEC958_SUBFRAME_LE,\n\t},\n\t.ops = &spdif_in_dai_ops,\n};\n\nstatic const struct snd_soc_component_driver spdif_in_component = {\n\t.name\t\t\t= \"spdif-in\",\n\t.legacy_dai_naming\t= 1,\n};\n\nstatic irqreturn_t spdif_in_irq(int irq, void *arg)\n{\n\tstruct spdif_in_dev *host = (struct spdif_in_dev *)arg;\n\n\tu32 irq_status = readl(host->io_base + SPDIF_IN_IRQ);\n\n\tif (!irq_status)\n\t\treturn IRQ_NONE;\n\n\tif (irq_status & SPDIF_IRQ_FIFOWRITE)\n\t\tdev_err(host->dev, \"spdif in: fifo write error\");\n\tif (irq_status & SPDIF_IRQ_EMPTYFIFOREAD)\n\t\tdev_err(host->dev, \"spdif in: empty fifo read error\");\n\tif (irq_status & SPDIF_IRQ_FIFOFULL)\n\t\tdev_err(host->dev, \"spdif in: fifo full error\");\n\tif (irq_status & SPDIF_IRQ_OUTOFRANGE)\n\t\tdev_err(host->dev, \"spdif in: out of range error\");\n\n\twritel(0, host->io_base + SPDIF_IN_IRQ);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int spdif_in_probe(struct platform_device *pdev)\n{\n\tstruct spdif_in_dev *host;\n\tstruct spear_spdif_platform_data *pdata;\n\tstruct resource *res_fifo;\n\tvoid __iomem *io_base;\n\tint ret;\n\n\tio_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(io_base))\n\t\treturn PTR_ERR(io_base);\n\n\tres_fifo = platform_get_resource(pdev, IORESOURCE_IO, 0);\n\tif (!res_fifo)\n\t\treturn -EINVAL;\n\n\thost = devm_kzalloc(&pdev->dev, sizeof(*host), GFP_KERNEL);\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\thost->io_base = io_base;\n\thost->irq = platform_get_irq(pdev, 0);\n\tif (host->irq < 0) {\n\t\tdev_warn(&pdev->dev, \"failed to get IRQ: %d\\n\", host->irq);\n\t\treturn host->irq;\n\t}\n\n\thost->clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(host->clk))\n\t\treturn PTR_ERR(host->clk);\n\n\tpdata = dev_get_platdata(&pdev->dev);\n\n\tif (!pdata)\n\t\treturn -EINVAL;\n\n\thost->dma_params.data = pdata->dma_params;\n\thost->dma_params.addr = res_fifo->start;\n\thost->dma_params.max_burst = 16;\n\thost->dma_params.addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES;\n\thost->reset_perip = pdata->reset_perip;\n\n\thost->dev = &pdev->dev;\n\tdev_set_drvdata(&pdev->dev, host);\n\n\tret = devm_request_irq(&pdev->dev, host->irq, spdif_in_irq, 0,\n\t\t\t\"spdif-in\", host);\n\tif (ret) {\n\t\tdev_warn(&pdev->dev, \"request_irq failed\\n\");\n\t\treturn ret;\n\t}\n\n\tret = devm_snd_soc_register_component(&pdev->dev, &spdif_in_component,\n\t\t\t\t\t      &spdif_in_dai, 1);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_spear_pcm_platform_register(&pdev->dev, &host->config,\n\t\t\t\t\t\tpdata->filter);\n}\n\nstatic struct platform_driver spdif_in_driver = {\n\t.probe\t\t= spdif_in_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"spdif-in\",\n\t},\n};\n\nmodule_platform_driver(spdif_in_driver);\n\nMODULE_AUTHOR(\"Vipin Kumar <vipin.kumar@st.com>\");\nMODULE_DESCRIPTION(\"SPEAr SPDIF IN SoC Interface\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:spdif_in\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}