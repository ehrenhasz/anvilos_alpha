{
  "module_name": "tegra_audio_graph_card.c",
  "hash_id": "ed4a7d04a95ec988e7cdb67d4d4df632788ace1e623192560a038b653a9258ff",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/tegra/tegra_audio_graph_card.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/math64.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <sound/graph_card.h>\n#include <sound/pcm_params.h>\n#include <sound/soc-dai.h>\n\n#define MAX_PLLA_OUT0_DIV 128\n\n#define simple_to_tegra_priv(simple) \\\n\t\tcontainer_of(simple, struct tegra_audio_priv, simple)\n\nenum srate_type {\n\t \n\tx8_RATE,\n\n\t \n\tx11_RATE,\n\n\tNUM_RATE_TYPE,\n};\n\nstruct tegra_audio_priv {\n\tstruct asoc_simple_priv simple;\n\tstruct clk *clk_plla_out0;\n\tstruct clk *clk_plla;\n};\n\n \nstruct tegra_audio_cdata {\n\tunsigned int plla_rates[NUM_RATE_TYPE];\n\tunsigned int plla_out0_rates[NUM_RATE_TYPE];\n};\n\nstatic bool need_clk_update(struct snd_soc_dai *dai)\n{\n\tif (snd_soc_dai_is_dummy(dai) ||\n\t    !dai->driver->ops ||\n\t    !dai->driver->name)\n\t\treturn false;\n\n\tif (strstr(dai->driver->name, \"I2S\") ||\n\t    strstr(dai->driver->name, \"DMIC\") ||\n\t    strstr(dai->driver->name, \"DSPK\"))\n\t\treturn true;\n\n\treturn false;\n}\n\n \nstatic int tegra_audio_graph_update_pll(struct snd_pcm_substream *substream,\n\t\t\t\t\tstruct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct asoc_simple_priv *simple = snd_soc_card_get_drvdata(rtd->card);\n\tstruct tegra_audio_priv *priv = simple_to_tegra_priv(simple);\n\tstruct device *dev = rtd->card->dev;\n\tconst struct tegra_audio_cdata *data = of_device_get_match_data(dev);\n\tunsigned int plla_rate, plla_out0_rate, bclk;\n\tunsigned int srate = params_rate(params);\n\tint err;\n\n\tswitch (srate) {\n\tcase 11025:\n\tcase 22050:\n\tcase 44100:\n\tcase 88200:\n\tcase 176400:\n\t\tplla_out0_rate = data->plla_out0_rates[x11_RATE];\n\t\tplla_rate = data->plla_rates[x11_RATE];\n\t\tbreak;\n\tcase 8000:\n\tcase 16000:\n\tcase 32000:\n\tcase 48000:\n\tcase 96000:\n\tcase 192000:\n\t\tplla_out0_rate = data->plla_out0_rates[x8_RATE];\n\t\tplla_rate = data->plla_rates[x8_RATE];\n\t\tbreak;\n\tdefault:\n\t\tdev_err(rtd->card->dev, \"Unsupported sample rate %u\\n\",\n\t\t\tsrate);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tbclk = srate * params_channels(params) * params_width(params);\n\tif (div_u64(plla_out0_rate, bclk) > MAX_PLLA_OUT0_DIV)\n\t\tplla_out0_rate >>= 1;\n\n\tdev_dbg(rtd->card->dev,\n\t\t\"Update clock rates: PLLA(= %u Hz) and PLLA_OUT0(= %u Hz)\\n\",\n\t\tplla_rate, plla_out0_rate);\n\n\t \n\terr = clk_set_rate(priv->clk_plla, plla_rate);\n\tif (err) {\n\t\tdev_err(rtd->card->dev,\n\t\t\t\"Can't set plla rate for %u, err: %d\\n\",\n\t\t\tplla_rate, err);\n\t\treturn err;\n\t}\n\n\t \n\terr = clk_set_rate(priv->clk_plla_out0, plla_out0_rate);\n\tif (err) {\n\t\tdev_err(rtd->card->dev,\n\t\t\t\"Can't set plla_out0 rate %u, err: %d\\n\",\n\t\t\tplla_out0_rate, err);\n\t\treturn err;\n\t}\n\n\treturn err;\n}\n\nstatic int tegra_audio_graph_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t       struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = asoc_substream_to_rtd(substream);\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tint err;\n\n\tif (need_clk_update(cpu_dai)) {\n\t\terr = tegra_audio_graph_update_pll(substream, params);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn asoc_simple_hw_params(substream, params);\n}\n\nstatic const struct snd_soc_ops tegra_audio_graph_ops = {\n\t.startup\t= asoc_simple_startup,\n\t.shutdown\t= asoc_simple_shutdown,\n\t.hw_params\t= tegra_audio_graph_hw_params,\n};\n\nstatic int tegra_audio_graph_card_probe(struct snd_soc_card *card)\n{\n\tstruct asoc_simple_priv *simple = snd_soc_card_get_drvdata(card);\n\tstruct tegra_audio_priv *priv = simple_to_tegra_priv(simple);\n\n\tpriv->clk_plla = devm_clk_get(card->dev, \"pll_a\");\n\tif (IS_ERR(priv->clk_plla)) {\n\t\tdev_err(card->dev, \"Can't retrieve clk pll_a\\n\");\n\t\treturn PTR_ERR(priv->clk_plla);\n\t}\n\n\tpriv->clk_plla_out0 = devm_clk_get(card->dev, \"plla_out0\");\n\tif (IS_ERR(priv->clk_plla_out0)) {\n\t\tdev_err(card->dev, \"Can't retrieve clk plla_out0\\n\");\n\t\treturn PTR_ERR(priv->clk_plla_out0);\n\t}\n\n\treturn asoc_graph_card_probe(card);\n}\n\nstatic int tegra_audio_graph_probe(struct platform_device *pdev)\n{\n\tstruct tegra_audio_priv *priv;\n\tstruct device *dev = &pdev->dev;\n\tstruct snd_soc_card *card;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tcard = simple_priv_to_card(&priv->simple);\n\tcard->driver_name = \"tegra-ape\";\n\n\tcard->probe = tegra_audio_graph_card_probe;\n\n\t \n\tcard->component_chaining = 1;\n\tpriv->simple.ops = &tegra_audio_graph_ops;\n\tpriv->simple.force_dpcm = 1;\n\n\treturn audio_graph_parse_of(&priv->simple, dev);\n}\n\nstatic const struct tegra_audio_cdata tegra210_data = {\n\t \n\t.plla_rates[x8_RATE] = 368640000,\n\t.plla_rates[x11_RATE] = 338688000,\n\t \n\t.plla_out0_rates[x8_RATE] = 49152000,\n\t.plla_out0_rates[x11_RATE] = 45158400,\n};\n\nstatic const struct tegra_audio_cdata tegra186_data = {\n\t \n\t.plla_rates[x8_RATE] = 245760000,\n\t.plla_rates[x11_RATE] = 270950400,\n\t \n\t.plla_out0_rates[x8_RATE] = 49152000,\n\t.plla_out0_rates[x11_RATE] = 45158400,\n};\n\nstatic const struct of_device_id graph_of_tegra_match[] = {\n\t{ .compatible = \"nvidia,tegra210-audio-graph-card\",\n\t  .data = &tegra210_data },\n\t{ .compatible = \"nvidia,tegra186-audio-graph-card\",\n\t  .data = &tegra186_data },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, graph_of_tegra_match);\n\nstatic struct platform_driver tegra_audio_graph_card = {\n\t.driver = {\n\t\t.name = \"tegra-audio-graph-card\",\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = graph_of_tegra_match,\n\t},\n\t.probe = tegra_audio_graph_probe,\n\t.remove = asoc_simple_remove,\n};\nmodule_platform_driver(tegra_audio_graph_card);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"ASoC Tegra Audio Graph Sound Card\");\nMODULE_AUTHOR(\"Sameer Pujar <spujar@nvidia.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}