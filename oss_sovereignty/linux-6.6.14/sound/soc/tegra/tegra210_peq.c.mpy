{
  "module_name": "tegra210_peq.c",
  "hash_id": "d23c3a682f85cc99691ffaf87e3c241300612d2f1707f68ef7510d661cb4dcc8",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/tegra/tegra210_peq.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/pcm_params.h>\n#include <sound/soc.h>\n\n#include \"tegra210_ope.h\"\n#include \"tegra210_peq.h\"\n\nstatic const struct reg_default tegra210_peq_reg_defaults[] = {\n\t{ TEGRA210_PEQ_CFG, 0x00000013},\n\t{ TEGRA210_PEQ_CFG_RAM_CTRL, 0x00004000},\n\t{ TEGRA210_PEQ_CFG_RAM_SHIFT_CTRL, 0x00004000},\n};\n\nstatic const u32 biquad_init_gains[TEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH] = {\n\t1495012349,  \n\n\t \n\t536870912, -1073741824, 536870912, 2143508246, -1069773768,  \n\t134217728, -265414508, 131766272, 2140402222, -1071252997,   \n\t268435456, -233515765, -33935948, 1839817267, -773826124,    \n\t536870912, -672537913, 139851540, 1886437554, -824433167,    \n\t268435456, -114439279, 173723964, 205743566, 278809729,      \n\t1, 0, 0, 0, 0,  \n\t1, 0, 0, 0, 0,  \n\t1, 0, 0, 0, 0,  \n\t1, 0, 0, 0, 0,  \n\t1, 0, 0, 0, 0,  \n\t1, 0, 0, 0, 0,  \n\t1, 0, 0, 0, 0,  \n\n\t963423114,  \n};\n\nstatic const u32 biquad_init_shifts[TEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH] = {\n\t23,  \n\t30, 30, 30, 30, 30, 0, 0, 0, 0, 0, 0, 0,  \n\t28,  \n};\n\nstatic s32 biquad_coeff_buffer[TEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH];\n\nstatic void tegra210_peq_read_ram(struct regmap *regmap, unsigned int reg_ctrl,\n\t\t\t\t  unsigned int reg_data, unsigned int ram_offset,\n\t\t\t\t  unsigned int *data, size_t size)\n{\n\tunsigned int val;\n\tunsigned int i;\n\n\tval = ram_offset & TEGRA210_PEQ_RAM_CTRL_RAM_ADDR_MASK;\n\tval |= TEGRA210_PEQ_RAM_CTRL_ADDR_INIT_EN;\n\tval |= TEGRA210_PEQ_RAM_CTRL_SEQ_ACCESS_EN;\n\tval |= TEGRA210_PEQ_RAM_CTRL_RW_READ;\n\n\tregmap_write(regmap, reg_ctrl, val);\n\n\t \n\tfor (i = 0; i < size; i++)\n\t\tregmap_read(regmap, reg_data, &data[i]);\n}\n\nstatic void tegra210_peq_write_ram(struct regmap *regmap, unsigned int reg_ctrl,\n\t\t\t\t   unsigned int reg_data, unsigned int ram_offset,\n\t\t\t\t   unsigned int *data, size_t size)\n{\n\tunsigned int val;\n\tunsigned int i;\n\n\tval = ram_offset & TEGRA210_PEQ_RAM_CTRL_RAM_ADDR_MASK;\n\tval |= TEGRA210_PEQ_RAM_CTRL_ADDR_INIT_EN;\n\tval |= TEGRA210_PEQ_RAM_CTRL_SEQ_ACCESS_EN;\n\tval |= TEGRA210_PEQ_RAM_CTRL_RW_WRITE;\n\n\tregmap_write(regmap, reg_ctrl, val);\n\n\tfor (i = 0; i < size; i++)\n\t\tregmap_write(regmap, reg_data, data[i]);\n}\n\nstatic int tegra210_peq_get(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mask = (1 << fls(mc->max)) - 1;\n\tunsigned int val;\n\n\tregmap_read(ope->peq_regmap, mc->reg, &val);\n\n\tucontrol->value.integer.value[0] = (val >> mc->shift) & mask;\n\n\tif (!mc->invert)\n\t\treturn 0;\n\n\tucontrol->value.integer.value[0] =\n\t\tmc->max - ucontrol->value.integer.value[0];\n\n\treturn 0;\n}\n\nstatic int tegra210_peq_put(struct snd_kcontrol *kcontrol,\n\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int mask = (1 << fls(mc->max)) - 1;\n\tbool change = false;\n\tunsigned int val;\n\n\tval = (ucontrol->value.integer.value[0] & mask);\n\n\tif (mc->invert)\n\t\tval = mc->max - val;\n\n\tval = val << mc->shift;\n\n\tregmap_update_bits_check(ope->peq_regmap, mc->reg, (mask << mc->shift),\n\t\t\t\t val, &change);\n\n\treturn change ? 1 : 0;\n}\n\nstatic int tegra210_peq_ram_get(struct snd_kcontrol *kcontrol,\n\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 i, reg_ctrl = params->soc.base;\n\tu32 reg_data = reg_ctrl + cmpnt->val_bytes;\n\ts32 *data = (s32 *)biquad_coeff_buffer;\n\n\tpm_runtime_get_sync(cmpnt->dev);\n\n\ttegra210_peq_read_ram(ope->peq_regmap, reg_ctrl, reg_data,\n\t\t\t      params->shift, data, params->soc.num_regs);\n\n\tpm_runtime_put_sync(cmpnt->dev);\n\n\tfor (i = 0; i < params->soc.num_regs; i++)\n\t\tucontrol->value.integer.value[i] = (long)data[i];\n\n\treturn 0;\n}\n\nstatic int tegra210_peq_ram_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t     struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 i, reg_ctrl = params->soc.base;\n\tu32 reg_data = reg_ctrl + cmpnt->val_bytes;\n\ts32 *data = (s32 *)biquad_coeff_buffer;\n\n\tfor (i = 0; i < params->soc.num_regs; i++)\n\t\tdata[i] = (s32)ucontrol->value.integer.value[i];\n\n\tpm_runtime_get_sync(cmpnt->dev);\n\n\ttegra210_peq_write_ram(ope->peq_regmap, reg_ctrl, reg_data,\n\t\t\t       params->shift, data, params->soc.num_regs);\n\n\tpm_runtime_put_sync(cmpnt->dev);\n\n\treturn 1;\n}\n\nstatic int tegra210_peq_param_info(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_info *uinfo)\n{\n\tstruct soc_bytes *params = (void *)kcontrol->private_value;\n\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\n\tuinfo->value.integer.min = INT_MIN;\n\tuinfo->value.integer.max = INT_MAX;\n\tuinfo->count = params->num_regs;\n\n\treturn 0;\n}\n\n#define TEGRA210_PEQ_GAIN_PARAMS_CTRL(chan)\t\t\t\t  \\\n\tTEGRA_SOC_BYTES_EXT(\"PEQ Channel-\" #chan \" Biquad Gain Params\",\t  \\\n\t\tTEGRA210_PEQ_CFG_RAM_CTRL,\t\t\t\t  \\\n\t\tTEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH,\t\t\t  \\\n\t\t(TEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH * chan), 0xffffffff, \\\n\t\ttegra210_peq_ram_get, tegra210_peq_ram_put,\t\t  \\\n\t\ttegra210_peq_param_info)\n\n#define TEGRA210_PEQ_SHIFT_PARAMS_CTRL(chan)\t\t\t\t  \\\n\tTEGRA_SOC_BYTES_EXT(\"PEQ Channel-\" #chan \" Biquad Shift Params\",  \\\n\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_CTRL,\t\t\t  \\\n\t\tTEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH,\t\t\t  \\\n\t\t(TEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH * chan), 0x1f,\t  \\\n\t\ttegra210_peq_ram_get, tegra210_peq_ram_put,\t\t  \\\n\t\ttegra210_peq_param_info)\n\nstatic const struct snd_kcontrol_new tegra210_peq_controls[] = {\n\tSOC_SINGLE_EXT(\"PEQ Active\", TEGRA210_PEQ_CFG,\n\t\t       TEGRA210_PEQ_CFG_MODE_SHIFT, 1, 0,\n\t\t       tegra210_peq_get, tegra210_peq_put),\n\n\tSOC_SINGLE_EXT(\"PEQ Biquad Stages\", TEGRA210_PEQ_CFG,\n\t\t       TEGRA210_PEQ_CFG_BIQUAD_STAGES_SHIFT,\n\t\t       TEGRA210_PEQ_MAX_BIQUAD_STAGES - 1, 0,\n\t\t       tegra210_peq_get, tegra210_peq_put),\n\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(0),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(1),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(2),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(3),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(4),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(5),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(6),\n\tTEGRA210_PEQ_GAIN_PARAMS_CTRL(7),\n\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(0),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(1),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(2),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(3),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(4),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(5),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(6),\n\tTEGRA210_PEQ_SHIFT_PARAMS_CTRL(7),\n};\n\nstatic bool tegra210_peq_wr_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase TEGRA210_PEQ_SOFT_RESET:\n\tcase TEGRA210_PEQ_CG:\n\tcase TEGRA210_PEQ_CFG ... TEGRA210_PEQ_CFG_RAM_SHIFT_DATA:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool tegra210_peq_rd_reg(struct device *dev, unsigned int reg)\n{\n\tif (tegra210_peq_wr_reg(dev, reg))\n\t\treturn true;\n\n\tswitch (reg) {\n\tcase TEGRA210_PEQ_STATUS:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool tegra210_peq_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase TEGRA210_PEQ_SOFT_RESET:\n\tcase TEGRA210_PEQ_STATUS:\n\tcase TEGRA210_PEQ_CFG_RAM_CTRL ... TEGRA210_PEQ_CFG_RAM_SHIFT_DATA:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool tegra210_peq_precious_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase TEGRA210_PEQ_CFG_RAM_DATA:\n\tcase TEGRA210_PEQ_CFG_RAM_SHIFT_DATA:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct regmap_config tegra210_peq_regmap_config = {\n\t.name\t\t\t= \"peq\",\n\t.reg_bits\t\t= 32,\n\t.reg_stride\t\t= 4,\n\t.val_bits\t\t= 32,\n\t.max_register\t\t= TEGRA210_PEQ_CFG_RAM_SHIFT_DATA,\n\t.writeable_reg\t\t= tegra210_peq_wr_reg,\n\t.readable_reg\t\t= tegra210_peq_rd_reg,\n\t.volatile_reg\t\t= tegra210_peq_volatile_reg,\n\t.precious_reg\t\t= tegra210_peq_precious_reg,\n\t.reg_defaults\t\t= tegra210_peq_reg_defaults,\n\t.num_reg_defaults\t= ARRAY_SIZE(tegra210_peq_reg_defaults),\n\t.cache_type\t\t= REGCACHE_FLAT,\n};\n\nvoid tegra210_peq_restore(struct regmap *regmap, u32 *biquad_gains,\n\t\t\t  u32 *biquad_shifts)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < TEGRA210_PEQ_MAX_CHANNELS; i++) {\n\t\ttegra210_peq_write_ram(regmap, TEGRA210_PEQ_CFG_RAM_CTRL,\n\t\t\tTEGRA210_PEQ_CFG_RAM_DATA,\n\t\t\t(i * TEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH),\n\t\t\tbiquad_gains,\n\t\t\tTEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH);\n\n\t\ttegra210_peq_write_ram(regmap,\n\t\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_CTRL,\n\t\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_DATA,\n\t\t\t(i * TEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH),\n\t\t\tbiquad_shifts,\n\t\t\tTEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH);\n\n\t}\n}\n\nvoid tegra210_peq_save(struct regmap *regmap, u32 *biquad_gains,\n\t\t       u32 *biquad_shifts)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < TEGRA210_PEQ_MAX_CHANNELS; i++) {\n\t\ttegra210_peq_read_ram(regmap,\n\t\t\tTEGRA210_PEQ_CFG_RAM_CTRL,\n\t\t\tTEGRA210_PEQ_CFG_RAM_DATA,\n\t\t\t(i * TEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH),\n\t\t\tbiquad_gains,\n\t\t\tTEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH);\n\n\t\ttegra210_peq_read_ram(regmap,\n\t\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_CTRL,\n\t\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_DATA,\n\t\t\t(i * TEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH),\n\t\t\tbiquad_shifts,\n\t\t\tTEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH);\n\t}\n}\n\nint tegra210_peq_component_init(struct snd_soc_component *cmpnt)\n{\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int i;\n\n\tpm_runtime_get_sync(cmpnt->dev);\n\tregmap_update_bits(ope->peq_regmap, TEGRA210_PEQ_CFG,\n\t\tTEGRA210_PEQ_CFG_MODE_MASK,\n\t\t0 << TEGRA210_PEQ_CFG_MODE_SHIFT);\n\tregmap_update_bits(ope->peq_regmap, TEGRA210_PEQ_CFG,\n\t\tTEGRA210_PEQ_CFG_BIQUAD_STAGES_MASK,\n\t\t(TEGRA210_PEQ_BIQUAD_INIT_STAGE - 1) <<\n\t\tTEGRA210_PEQ_CFG_BIQUAD_STAGES_SHIFT);\n\n\t \n\tfor (i = 0; i < TEGRA210_PEQ_MAX_CHANNELS; i++) {\n\n\t\t \n\t\ttegra210_peq_write_ram(ope->peq_regmap,\n\t\t\tTEGRA210_PEQ_CFG_RAM_CTRL,\n\t\t\tTEGRA210_PEQ_CFG_RAM_DATA,\n\t\t\t(i * TEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH),\n\t\t\t(u32 *)&biquad_init_gains,\n\t\t\tTEGRA210_PEQ_GAIN_PARAM_SIZE_PER_CH);\n\n\t\t \n\t\ttegra210_peq_write_ram(ope->peq_regmap,\n\t\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_CTRL,\n\t\t\tTEGRA210_PEQ_CFG_RAM_SHIFT_DATA,\n\t\t\t(i * TEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH),\n\t\t\t(u32 *)&biquad_init_shifts,\n\t\t\tTEGRA210_PEQ_SHIFT_PARAM_SIZE_PER_CH);\n\n\t}\n\n\tpm_runtime_put_sync(cmpnt->dev);\n\n\tsnd_soc_add_component_controls(cmpnt, tegra210_peq_controls,\n\t\t\t\t       ARRAY_SIZE(tegra210_peq_controls));\n\n\treturn 0;\n}\n\nint tegra210_peq_regmap_init(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct tegra210_ope *ope = dev_get_drvdata(dev);\n\tstruct device_node *child;\n\tstruct resource mem;\n\tvoid __iomem *regs;\n\tint err;\n\n\tchild = of_get_child_by_name(dev->of_node, \"equalizer\");\n\tif (!child)\n\t\treturn -ENODEV;\n\n\terr = of_address_to_resource(child, 0, &mem);\n\tof_node_put(child);\n\tif (err < 0) {\n\t\tdev_err(dev, \"fail to get PEQ resource\\n\");\n\t\treturn err;\n\t}\n\n\tmem.flags = IORESOURCE_MEM;\n\tregs = devm_ioremap_resource(dev, &mem);\n\tif (IS_ERR(regs))\n\t\treturn PTR_ERR(regs);\n\tope->peq_regmap = devm_regmap_init_mmio(dev, regs,\n\t\t\t\t\t\t&tegra210_peq_regmap_config);\n\tif (IS_ERR(ope->peq_regmap)) {\n\t\tdev_err(dev, \"regmap init failed\\n\");\n\t\treturn PTR_ERR(ope->peq_regmap);\n\t}\n\n\tregcache_cache_only(ope->peq_regmap, true);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}