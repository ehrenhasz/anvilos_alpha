{
  "module_name": "tegra20_das.c",
  "hash_id": "bf6f2a7b62823199b437a31bf692d83093069de62587eae77fe1703239b76bee",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/tegra/tegra20_das.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <sound/soc.h>\n\n#define DRV_NAME \"tegra20-das\"\n\n \n#define TEGRA20_DAS_DAP_CTRL_SEL\t\t\t0x00\n#define TEGRA20_DAS_DAP_CTRL_SEL_COUNT\t\t\t5\n#define TEGRA20_DAS_DAP_CTRL_SEL_STRIDE\t\t\t4\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_MS_SEL_P\t\t31\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_MS_SEL_S\t\t1\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_SDATA1_TX_RX_P\t30\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_SDATA1_TX_RX_S\t1\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_SDATA2_TX_RX_P\t29\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_SDATA2_TX_RX_S\t1\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_CTRL_SEL_P\t\t0\n#define TEGRA20_DAS_DAP_CTRL_SEL_DAP_CTRL_SEL_S\t\t5\n\n \n#define TEGRA20_DAS_DAP_SEL_DAC1\t0\n#define TEGRA20_DAS_DAP_SEL_DAC2\t1\n#define TEGRA20_DAS_DAP_SEL_DAC3\t2\n#define TEGRA20_DAS_DAP_SEL_DAP1\t16\n#define TEGRA20_DAS_DAP_SEL_DAP2\t17\n#define TEGRA20_DAS_DAP_SEL_DAP3\t18\n#define TEGRA20_DAS_DAP_SEL_DAP4\t19\n#define TEGRA20_DAS_DAP_SEL_DAP5\t20\n\n \n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL\t\t\t0x40\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_COUNT\t\t3\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_STRIDE\t\t4\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_SDATA2_SEL_P\t28\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_SDATA2_SEL_S\t4\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_SDATA1_SEL_P\t24\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_SDATA1_SEL_S\t4\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_CLK_SEL_P\t0\n#define TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_CLK_SEL_S\t4\n\n \n#define TEGRA20_DAS_DAC_SEL_DAP1\t0\n#define TEGRA20_DAS_DAC_SEL_DAP2\t1\n#define TEGRA20_DAS_DAC_SEL_DAP3\t2\n#define TEGRA20_DAS_DAC_SEL_DAP4\t3\n#define TEGRA20_DAS_DAC_SEL_DAP5\t4\n\n \n\n#define TEGRA20_DAS_DAP_ID_1 0\n#define TEGRA20_DAS_DAP_ID_2 1\n#define TEGRA20_DAS_DAP_ID_3 2\n#define TEGRA20_DAS_DAP_ID_4 3\n#define TEGRA20_DAS_DAP_ID_5 4\n\n#define TEGRA20_DAS_DAC_ID_1 0\n#define TEGRA20_DAS_DAC_ID_2 1\n#define TEGRA20_DAS_DAC_ID_3 2\n\nstruct tegra20_das {\n\tstruct regmap *regmap;\n};\n\n \n\nstatic inline void tegra20_das_write(struct tegra20_das *das, u32 reg, u32 val)\n{\n\tregmap_write(das->regmap, reg, val);\n}\n\nstatic void tegra20_das_connect_dap_to_dac(struct tegra20_das *das, int dap, int dac)\n{\n\tu32 addr;\n\tu32 reg;\n\n\taddr = TEGRA20_DAS_DAP_CTRL_SEL +\n\t\t(dap * TEGRA20_DAS_DAP_CTRL_SEL_STRIDE);\n\treg = dac << TEGRA20_DAS_DAP_CTRL_SEL_DAP_CTRL_SEL_P;\n\n\ttegra20_das_write(das, addr, reg);\n}\n\nstatic void tegra20_das_connect_dac_to_dap(struct tegra20_das *das, int dac, int dap)\n{\n\tu32 addr;\n\tu32 reg;\n\n\taddr = TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL +\n\t\t(dac * TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_STRIDE);\n\treg = dap << TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_CLK_SEL_P |\n\t\tdap << TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_SDATA1_SEL_P |\n\t\tdap << TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL_DAC_SDATA2_SEL_P;\n\n\ttegra20_das_write(das, addr, reg);\n}\n\n#define LAST_REG(name) \\\n\t(TEGRA20_DAS_##name + \\\n\t (TEGRA20_DAS_##name##_STRIDE * (TEGRA20_DAS_##name##_COUNT - 1)))\n\nstatic bool tegra20_das_wr_rd_reg(struct device *dev, unsigned int reg)\n{\n\tif (reg <= LAST_REG(DAP_CTRL_SEL))\n\t\treturn true;\n\tif ((reg >= TEGRA20_DAS_DAC_INPUT_DATA_CLK_SEL) &&\n\t    (reg <= LAST_REG(DAC_INPUT_DATA_CLK_SEL)))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic const struct regmap_config tegra20_das_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.max_register = LAST_REG(DAC_INPUT_DATA_CLK_SEL),\n\t.writeable_reg = tegra20_das_wr_rd_reg,\n\t.readable_reg = tegra20_das_wr_rd_reg,\n\t.cache_type = REGCACHE_FLAT,\n};\n\nstatic int tegra20_das_probe(struct platform_device *pdev)\n{\n\tvoid __iomem *regs;\n\tstruct tegra20_das *das;\n\n\tdas = devm_kzalloc(&pdev->dev, sizeof(struct tegra20_das), GFP_KERNEL);\n\tif (!das)\n\t\treturn -ENOMEM;\n\n\tregs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(regs))\n\t\treturn PTR_ERR(regs);\n\n\tdas->regmap = devm_regmap_init_mmio(&pdev->dev, regs,\n\t\t\t\t\t    &tegra20_das_regmap_config);\n\tif (IS_ERR(das->regmap)) {\n\t\tdev_err(&pdev->dev, \"regmap init failed\\n\");\n\t\treturn PTR_ERR(das->regmap);\n\t}\n\n\ttegra20_das_connect_dap_to_dac(das, TEGRA20_DAS_DAP_ID_1,\n\t\t\t\t       TEGRA20_DAS_DAP_SEL_DAC1);\n\ttegra20_das_connect_dac_to_dap(das, TEGRA20_DAS_DAC_ID_1,\n\t\t\t\t       TEGRA20_DAS_DAC_SEL_DAP1);\n\ttegra20_das_connect_dap_to_dac(das, TEGRA20_DAS_DAP_ID_3,\n\t\t\t\t       TEGRA20_DAS_DAP_SEL_DAC3);\n\ttegra20_das_connect_dac_to_dap(das, TEGRA20_DAS_DAC_ID_3,\n\t\t\t\t       TEGRA20_DAS_DAC_SEL_DAP3);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id tegra20_das_of_match[] = {\n\t{ .compatible = \"nvidia,tegra20-das\", },\n\t{},\n};\n\nstatic struct platform_driver tegra20_das_driver = {\n\t.probe = tegra20_das_probe,\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.of_match_table = tegra20_das_of_match,\n\t},\n};\nmodule_platform_driver(tegra20_das_driver);\n\nMODULE_AUTHOR(\"Stephen Warren <swarren@nvidia.com>\");\nMODULE_DESCRIPTION(\"Tegra20 DAS driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:\" DRV_NAME);\nMODULE_DEVICE_TABLE(of, tegra20_das_of_match);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}