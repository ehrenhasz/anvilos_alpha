{
  "module_name": "tegra_wm8903.c",
  "hash_id": "b1ff7825ec2355d7b98e309422eda43a51a6eef2bd4945bc1c839e65ca4f1ff7",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/tegra/tegra_wm8903.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/of.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <sound/core.h>\n#include <sound/jack.h>\n#include <sound/soc.h>\n\n#include \"../codecs/wm8903.h\"\n\n#include \"tegra_asoc_machine.h\"\n\nstatic struct snd_soc_jack_pin tegra_wm8903_mic_jack_pins[] = {\n\t{ .pin = \"Mic Jack\", .mask = SND_JACK_MICROPHONE },\n};\n\nstatic unsigned int tegra_wm8903_mclk_rate(unsigned int srate)\n{\n\tunsigned int mclk;\n\n\tswitch (srate) {\n\tcase 64000:\n\tcase 88200:\n\tcase 96000:\n\t\tmclk = 128 * srate;\n\t\tbreak;\n\tdefault:\n\t\tmclk = 256 * srate;\n\t\tbreak;\n\t}\n\t \n\twhile (mclk < 6000000)\n\t\tmclk *= 2;\n\n\treturn mclk;\n}\n\nstatic int tegra_wm8903_init(struct snd_soc_pcm_runtime *rtd)\n{\n\tstruct tegra_machine *machine = snd_soc_card_get_drvdata(rtd->card);\n\tstruct snd_soc_card *card = rtd->card;\n\tint err;\n\n\t \n\tif (machine->asoc->hp_jack_gpio_active_low) {\n\t\tbool active_low = gpiod_is_active_low(machine->gpiod_hp_det);\n\n\t\tmachine->hp_jack_gpio->invert = !active_low;\n\t}\n\n\terr = tegra_asoc_machine_init(rtd);\n\tif (err)\n\t\treturn err;\n\n\tif (!machine->gpiod_mic_det && machine->asoc->add_mic_jack) {\n\t\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\t\tstruct snd_soc_component *component = codec_dai->component;\n\t\tint shrt = 0;\n\n\t\terr = snd_soc_card_jack_new_pins(rtd->card, \"Mic Jack\",\n\t\t\t\t\t\t SND_JACK_MICROPHONE,\n\t\t\t\t\t\t machine->mic_jack,\n\t\t\t\t\t\t tegra_wm8903_mic_jack_pins,\n\t\t\t\t\t\t ARRAY_SIZE(tegra_wm8903_mic_jack_pins));\n\t\tif (err) {\n\t\t\tdev_err(rtd->dev, \"Mic Jack creation failed: %d\\n\", err);\n\t\t\treturn err;\n\t\t}\n\n\t\tif (of_property_read_bool(card->dev->of_node, \"nvidia,headset\"))\n\t\t\tshrt = SND_JACK_MICROPHONE;\n\n\t\twm8903_mic_detect(component, machine->mic_jack,\n\t\t\t\t  SND_JACK_MICROPHONE, shrt);\n\t}\n\n\tsnd_soc_dapm_force_enable_pin(&card->dapm, \"MICBIAS\");\n\n\treturn 0;\n}\n\nstatic int tegra_wm8903_remove(struct snd_soc_card *card)\n{\n\tstruct snd_soc_dai_link *link = &card->dai_link[0];\n\tstruct snd_soc_pcm_runtime *rtd = snd_soc_get_pcm_runtime(card, link);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct snd_soc_component *component = codec_dai->component;\n\n\twm8903_mic_detect(component, NULL, 0, 0);\n\n\treturn 0;\n}\n\nSND_SOC_DAILINK_DEFS(hifi,\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_CODEC(NULL, \"wm8903-hifi\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link tegra_wm8903_dai = {\n\t.name = \"WM8903\",\n\t.stream_name = \"WM8903 PCM\",\n\t.init = tegra_wm8903_init,\n\t.dai_fmt = SND_SOC_DAIFMT_I2S |\n\t\t   SND_SOC_DAIFMT_NB_NF |\n\t\t   SND_SOC_DAIFMT_CBS_CFS,\n\tSND_SOC_DAILINK_REG(hifi),\n};\n\nstatic struct snd_soc_card snd_soc_tegra_wm8903 = {\n\t.components = \"codec:wm8903\",\n\t.owner = THIS_MODULE,\n\t.dai_link = &tegra_wm8903_dai,\n\t.num_links = 1,\n\t.remove = tegra_wm8903_remove,\n\t.fully_routed = true,\n};\n\n \nstatic const struct tegra_asoc_data tegra_wm8903_data_legacy = {\n\t.mclk_rate = tegra_wm8903_mclk_rate,\n\t.card = &snd_soc_tegra_wm8903,\n\t.hp_jack_gpio_active_low = true,\n\t.add_common_dapm_widgets = true,\n\t.add_common_controls = true,\n\t.add_common_snd_ops = true,\n\t.add_mic_jack = true,\n\t.add_hp_jack = true,\n};\n\nstatic const struct tegra_asoc_data tegra_wm8903_data = {\n\t.mclk_rate = tegra_wm8903_mclk_rate,\n\t.card = &snd_soc_tegra_wm8903,\n\t.add_common_dapm_widgets = true,\n\t.add_common_controls = true,\n\t.add_common_snd_ops = true,\n\t.add_mic_jack = true,\n\t.add_hp_jack = true,\n};\n\nstatic const struct of_device_id tegra_wm8903_of_match[] = {\n\t{ .compatible = \"ad,tegra-audio-plutux\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"ad,tegra-audio-wm8903-medcom-wide\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"ad,tegra-audio-wm8903-tec\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"nvidia,tegra-audio-wm8903-cardhu\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"nvidia,tegra-audio-wm8903-harmony\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"nvidia,tegra-audio-wm8903-picasso\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"nvidia,tegra-audio-wm8903-seaboard\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"nvidia,tegra-audio-wm8903-ventana\", .data = &tegra_wm8903_data_legacy },\n\t{ .compatible = \"nvidia,tegra-audio-wm8903\", .data = &tegra_wm8903_data },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, tegra_wm8903_of_match);\n\nstatic struct platform_driver tegra_wm8903_driver = {\n\t.driver = {\n\t\t.name = \"tegra-wm8903\",\n\t\t.of_match_table = tegra_wm8903_of_match,\n\t\t.pm = &snd_soc_pm_ops,\n\t},\n\t.probe = tegra_asoc_machine_probe,\n};\nmodule_platform_driver(tegra_wm8903_driver);\n\nMODULE_AUTHOR(\"Stephen Warren <swarren@nvidia.com>\");\nMODULE_DESCRIPTION(\"Tegra+WM8903 machine ASoC driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}