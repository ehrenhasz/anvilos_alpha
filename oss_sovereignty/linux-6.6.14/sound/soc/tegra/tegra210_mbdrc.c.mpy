{
  "module_name": "tegra210_mbdrc.c",
  "hash_id": "dc5ee02f69ce5207fa33c836db5f6a8dc2151f8644912aef935a252b38f22178",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/tegra/tegra210_mbdrc.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/device.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n#include <sound/core.h>\n#include <sound/soc.h>\n#include <sound/tlv.h>\n\n#include \"tegra210_mbdrc.h\"\n#include \"tegra210_ope.h\"\n\n#define MBDRC_FILTER_REG(reg, id)\t\t\t\t\t    \\\n\t((reg) + ((id) * TEGRA210_MBDRC_FILTER_PARAM_STRIDE))\n\n#define MBDRC_FILTER_REG_DEFAULTS(id)\t\t\t\t\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_IIR_CFG, id), 0x00000005},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_IN_ATTACK, id), 0x3e48590c},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_IN_RELEASE, id), 0x08414e9f},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_FAST_ATTACK, id), 0x7fffffff},    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_IN_THRESHOLD, id), 0x06145082},   \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_OUT_THRESHOLD, id), 0x060d379b},  \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_RATIO_1ST, id), 0x0000a000},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_RATIO_2ND, id), 0x00002000},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_RATIO_3RD, id), 0x00000b33},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_RATIO_4TH, id), 0x00000800},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_RATIO_5TH, id), 0x0000019a},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_MAKEUP_GAIN, id), 0x00000002},    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_INIT_GAIN, id), 0x00066666},\t    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_GAIN_ATTACK, id), 0x00d9ba0e},    \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_GAIN_RELEASE, id), 0x3e48590c},   \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_FAST_RELEASE, id), 0x7ffff26a},   \\\n\t{ MBDRC_FILTER_REG(TEGRA210_MBDRC_CFG_RAM_CTRL, id), 0x4000}\n\nstatic const struct reg_default tegra210_mbdrc_reg_defaults[] = {\n\t{ TEGRA210_MBDRC_CFG, 0x0030de51},\n\t{ TEGRA210_MBDRC_CHANNEL_MASK, 0x00000003},\n\t{ TEGRA210_MBDRC_FAST_FACTOR, 0x30000800},\n\n\tMBDRC_FILTER_REG_DEFAULTS(0),\n\tMBDRC_FILTER_REG_DEFAULTS(1),\n\tMBDRC_FILTER_REG_DEFAULTS(2),\n};\n\n \nstatic const struct tegra210_mbdrc_config mbdrc_init_config = {\n\t.mode\t\t\t= 0,  \n\t.rms_off\t\t= 48,\n\t.peak_rms_mode\t\t= 1,  \n\t.filter_structure\t= 0,  \n\t.shift_ctrl\t\t= 30,\n\t.frame_size\t\t= 32,\n\t.channel_mask\t\t= 0x3,\n\t.fa_factor\t\t= 2048,\n\t.fr_factor\t\t= 14747,\n\n\t.band_params[MBDRC_LOW_BAND] = {\n\t\t.band\t\t\t= MBDRC_LOW_BAND,\n\t\t.iir_stages\t\t= 5,\n\t\t.in_attack_tc\t\t= 1044928780,\n\t\t.in_release_tc\t\t= 138497695,\n\t\t.fast_attack_tc\t\t= 2147483647,\n\t\t.in_threshold\t\t= {130, 80, 20, 6},\n\t\t.out_threshold\t\t= {155, 55, 13, 6},\n\t\t.ratio\t\t\t= {40960, 8192, 2867, 2048, 410},\n\t\t.makeup_gain\t\t= 4,\n\t\t.gain_init\t\t= 419430,\n\t\t.gain_attack_tc\t\t= 14268942,\n\t\t.gain_release_tc\t= 1440547090,\n\t\t.fast_release_tc\t= 2147480170,\n\n\t\t.biquad_params\t= {\n\t\t\t \n\n\t\t\t \n\t\t\t961046798, -2030431983, 1073741824,\n\t\t\t2030431983, -961046798,\n\t\t\t \n\t\t\t1030244425, -2099481453, 1073741824,\n\t\t\t2099481453, -1030244425,\n\t\t\t \n\t\t\t1067169294, -2136327263, 1073741824,\n\t\t\t2136327263, -1067169294,\n\t\t\t \n\t\t\t434951949, -1306567134, 1073741824,\n\t\t\t1306567134, -434951949,\n\t\t\t \n\t\t\t780656019, -1605955641, 1073741824,\n\t\t\t1605955641, -780656019,\n\t\t\t \n\t\t\t1024497031, -1817128152, 1073741824,\n\t\t\t1817128152, -1024497031,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t}\n\t},\n\n\t.band_params[MBDRC_MID_BAND] = {\n\t\t.band\t\t\t= MBDRC_MID_BAND,\n\t\t.iir_stages\t\t= 5,\n\t\t.in_attack_tc\t\t= 1581413104,\n\t\t.in_release_tc\t\t= 35494783,\n\t\t.fast_attack_tc\t\t= 2147483647,\n\t\t.in_threshold\t\t= {130, 50, 30, 6},\n\t\t.out_threshold\t\t= {106, 50, 30, 13},\n\t\t.ratio\t\t\t= {40960, 2867, 4096, 2867, 410},\n\t\t.makeup_gain\t\t= 6,\n\t\t.gain_init\t\t= 419430,\n\t\t.gain_attack_tc\t\t= 4766887,\n\t\t.gain_release_tc\t= 1044928780,\n\t\t.fast_release_tc\t= 2147480170,\n\n\t\t.biquad_params = {\n\t\t\t \n\n\t\t\t \n\t\t\t-1005668963, 1073741824, 0,\n\t\t\t1005668963, 0,\n\t\t\t \n\t\t\t998437058, -2067742187, 1073741824,\n\t\t\t2067742187, -998437058,\n\t\t\t \n\t\t\t1051963422, -2121153948, 1073741824,\n\t\t\t2121153948, -1051963422,\n\t\t\t \n\t\t\t434951949, -1306567134, 1073741824,\n\t\t\t1306567134, -434951949,\n\t\t\t \n\t\t\t780656019, -1605955641, 1073741824,\n\t\t\t1605955641, -780656019,\n\t\t\t \n\t\t\t1024497031, -1817128152, 1073741824,\n\t\t\t1817128152, -1024497031,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t}\n\t},\n\n\t.band_params[MBDRC_HIGH_BAND] = {\n\t\t.band\t\t\t= MBDRC_HIGH_BAND,\n\t\t.iir_stages\t\t= 5,\n\t\t.in_attack_tc\t\t= 2144750688,\n\t\t.in_release_tc\t\t= 70402888,\n\t\t.fast_attack_tc\t\t= 2147483647,\n\t\t.in_threshold\t\t= {130, 50, 30, 6},\n\t\t.out_threshold\t\t= {106, 50, 30, 13},\n\t\t.ratio\t\t\t= {40960, 2867, 4096, 2867, 410},\n\t\t.makeup_gain\t\t= 6,\n\t\t.gain_init\t\t= 419430,\n\t\t.gain_attack_tc\t\t= 4766887,\n\t\t.gain_release_tc\t= 1044928780,\n\t\t.fast_release_tc\t= 2147480170,\n\n\t\t.biquad_params = {\n\t\t\t \n\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t\t \n\t\t\t-619925131, 1073741824, 0,\n\t\t\t619925131, 0,\n\t\t\t \n\t\t\t606839335, -1455425976, 1073741824,\n\t\t\t1455425976, -606839335,\n\t\t\t \n\t\t\t917759617, -1724690840, 1073741824,\n\t\t\t1724690840, -917759617,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t\t \n\t\t\t1073741824, 0, 0,\n\t\t\t0, 0,\n\t\t}\n\t}\n};\n\nstatic void tegra210_mbdrc_write_ram(struct regmap *regmap, unsigned int reg_ctrl,\n\t\t\t\t     unsigned int reg_data, unsigned int ram_offset,\n\t\t\t\t     unsigned int *data, size_t size)\n{\n\tunsigned int val;\n\tunsigned int i;\n\n\tval = ram_offset & TEGRA210_MBDRC_RAM_CTRL_RAM_ADDR_MASK;\n\tval |= TEGRA210_MBDRC_RAM_CTRL_ADDR_INIT_EN;\n\tval |= TEGRA210_MBDRC_RAM_CTRL_SEQ_ACCESS_EN;\n\tval |= TEGRA210_MBDRC_RAM_CTRL_RW_WRITE;\n\n\tregmap_write(regmap, reg_ctrl, val);\n\n\tfor (i = 0; i < size; i++)\n\t\tregmap_write(regmap, reg_data, data[i]);\n}\n\nstatic int tegra210_mbdrc_get(struct snd_kcontrol *kcontrol,\n\t\t\t      struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int val;\n\n\tregmap_read(ope->mbdrc_regmap, mc->reg, &val);\n\n\tucontrol->value.integer.value[0] = (val >> mc->shift) & mc->max;\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_put(struct snd_kcontrol *kcontrol,\n\t\t\t      struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tunsigned int val = ucontrol->value.integer.value[0];\n\tbool change = false;\n\n\tval = val << mc->shift;\n\n\tregmap_update_bits_check(ope->mbdrc_regmap, mc->reg,\n\t\t\t\t (mc->max << mc->shift), val, &change);\n\n\treturn change ? 1 : 0;\n}\n\nstatic int tegra210_mbdrc_get_enum(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tunsigned int val;\n\n\tregmap_read(ope->mbdrc_regmap, e->reg, &val);\n\n\tucontrol->value.enumerated.item[0] = (val >> e->shift_l) & e->mask;\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_put_enum(struct snd_kcontrol *kcontrol,\n\t\t\t\t   struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\n\tbool change = false;\n\tunsigned int val;\n\tunsigned int mask;\n\n\tif (ucontrol->value.enumerated.item[0] > e->items - 1)\n\t\treturn -EINVAL;\n\n\tval = ucontrol->value.enumerated.item[0] << e->shift_l;\n\tmask = e->mask << e->shift_l;\n\n\tregmap_update_bits_check(ope->mbdrc_regmap, e->reg, mask, val,\n\t\t\t\t &change);\n\n\treturn change ? 1 : 0;\n}\n\nstatic int tegra210_mbdrc_band_params_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 *data = (u32 *)ucontrol->value.bytes.data;\n\tu32 regs = params->soc.base;\n\tu32 mask = params->soc.mask;\n\tu32 shift = params->shift;\n\tunsigned int i;\n\n\tfor (i = 0; i < params->soc.num_regs; i++, regs += cmpnt->val_bytes) {\n\t\tregmap_read(ope->mbdrc_regmap, regs, &data[i]);\n\n\t\tdata[i] = ((data[i] & mask) >> shift);\n\t}\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_band_params_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 *data = (u32 *)ucontrol->value.bytes.data;\n\tu32 regs = params->soc.base;\n\tu32 mask = params->soc.mask;\n\tu32 shift = params->shift;\n\tbool change = false;\n\tunsigned int i;\n\n\tfor (i = 0; i < params->soc.num_regs; i++, regs += cmpnt->val_bytes) {\n\t\tbool update = false;\n\n\t\tregmap_update_bits_check(ope->mbdrc_regmap, regs, mask,\n\t\t\t\t\t data[i] << shift, &update);\n\n\t\tchange |= update;\n\t}\n\n\treturn change ? 1 : 0;\n}\n\nstatic int tegra210_mbdrc_threshold_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 *data = (u32 *)ucontrol->value.bytes.data;\n\tu32 regs = params->soc.base;\n\tu32 num_regs = params->soc.num_regs;\n\tu32 val;\n\tunsigned int i;\n\n\tfor (i = 0; i < num_regs; i += 4, regs += cmpnt->val_bytes) {\n\t\tregmap_read(ope->mbdrc_regmap, regs, &val);\n\n\t\tdata[i] = (val & TEGRA210_MBDRC_THRESH_1ST_MASK) >>\n\t\t\t  TEGRA210_MBDRC_THRESH_1ST_SHIFT;\n\t\tdata[i + 1] = (val & TEGRA210_MBDRC_THRESH_2ND_MASK) >>\n\t\t\t      TEGRA210_MBDRC_THRESH_2ND_SHIFT;\n\t\tdata[i + 2] = (val & TEGRA210_MBDRC_THRESH_3RD_MASK) >>\n\t\t\t      TEGRA210_MBDRC_THRESH_3RD_SHIFT;\n\t\tdata[i + 3] = (val & TEGRA210_MBDRC_THRESH_4TH_MASK) >>\n\t\t\t      TEGRA210_MBDRC_THRESH_4TH_SHIFT;\n\t}\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_threshold_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 *data = (u32 *)ucontrol->value.bytes.data;\n\tu32 regs = params->soc.base;\n\tu32 num_regs = params->soc.num_regs;\n\tbool change = false;\n\tunsigned int i;\n\n\tfor (i = 0; i < num_regs; i += 4, regs += cmpnt->val_bytes) {\n\t\tbool update = false;\n\n\t\tdata[i] = (((data[i] >> TEGRA210_MBDRC_THRESH_1ST_SHIFT) &\n\t\t\t    TEGRA210_MBDRC_THRESH_1ST_MASK) |\n\t\t\t   ((data[i + 1] >> TEGRA210_MBDRC_THRESH_2ND_SHIFT) &\n\t\t\t    TEGRA210_MBDRC_THRESH_2ND_MASK) |\n\t\t\t   ((data[i + 2] >> TEGRA210_MBDRC_THRESH_3RD_SHIFT) &\n\t\t\t    TEGRA210_MBDRC_THRESH_3RD_MASK) |\n\t\t\t   ((data[i + 3] >> TEGRA210_MBDRC_THRESH_4TH_SHIFT) &\n\t\t\t    TEGRA210_MBDRC_THRESH_4TH_MASK));\n\n\t\tregmap_update_bits_check(ope->mbdrc_regmap, regs, 0xffffffff,\n\t\t\t\t\t data[i], &update);\n\n\t\tchange |= update;\n\t}\n\n\treturn change ? 1 : 0;\n}\n\nstatic int tegra210_mbdrc_biquad_coeffs_get(struct snd_kcontrol *kcontrol,\n\tstruct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tu32 *data = (u32 *)ucontrol->value.bytes.data;\n\n\tmemset(data, 0, params->soc.num_regs * cmpnt->val_bytes);\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_biquad_coeffs_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t\t    struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct tegra_soc_bytes *params = (void *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tu32 reg_ctrl = params->soc.base;\n\tu32 reg_data = reg_ctrl + cmpnt->val_bytes;\n\tu32 *data = (u32 *)ucontrol->value.bytes.data;\n\n\ttegra210_mbdrc_write_ram(ope->mbdrc_regmap, reg_ctrl, reg_data,\n\t\t\t\t params->shift, data, params->soc.num_regs);\n\n\treturn 1;\n}\n\nstatic int tegra210_mbdrc_param_info(struct snd_kcontrol *kcontrol,\n\t\t\t\t     struct snd_ctl_elem_info *uinfo)\n{\n\tstruct soc_bytes *params = (void *)kcontrol->private_value;\n\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_BYTES;\n\tuinfo->count = params->num_regs * sizeof(u32);\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_vol_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tint val;\n\n\tregmap_read(ope->mbdrc_regmap, mc->reg, &val);\n\n\tucontrol->value.integer.value[0] =\n\t\t((val >> mc->shift) - TEGRA210_MBDRC_MASTER_VOL_MIN);\n\n\treturn 0;\n}\n\nstatic int tegra210_mbdrc_vol_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t  struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct soc_mixer_control *mc =\n\t\t(struct soc_mixer_control *)kcontrol->private_value;\n\tstruct snd_soc_component *cmpnt = snd_soc_kcontrol_component(kcontrol);\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tint val = ucontrol->value.integer.value[0];\n\tbool change = false;\n\n\tval += TEGRA210_MBDRC_MASTER_VOL_MIN;\n\n\tregmap_update_bits_check(ope->mbdrc_regmap, mc->reg,\n\t\t\t\t mc->max << mc->shift, val << mc->shift,\n\t\t\t\t &change);\n\n\tregmap_read(ope->mbdrc_regmap, mc->reg, &val);\n\n\treturn change ? 1 : 0;\n}\n\nstatic const char * const tegra210_mbdrc_mode_text[] = {\n\t\"Bypass\", \"Fullband\", \"Dualband\", \"Multiband\"\n};\n\nstatic const struct soc_enum tegra210_mbdrc_mode_enum =\n\tSOC_ENUM_SINGLE(TEGRA210_MBDRC_CFG, TEGRA210_MBDRC_CFG_MBDRC_MODE_SHIFT,\n\t\t\t4, tegra210_mbdrc_mode_text);\n\nstatic const char * const tegra210_mbdrc_peak_rms_text[] = {\n\t\"Peak\", \"RMS\"\n};\n\nstatic const struct soc_enum tegra210_mbdrc_peak_rms_enum =\n\tSOC_ENUM_SINGLE(TEGRA210_MBDRC_CFG, TEGRA210_MBDRC_CFG_PEAK_RMS_SHIFT,\n\t\t\t2, tegra210_mbdrc_peak_rms_text);\n\nstatic const char * const tegra210_mbdrc_filter_structure_text[] = {\n\t\"All-pass-tree\", \"Flexible\"\n};\n\nstatic const struct soc_enum tegra210_mbdrc_filter_structure_enum =\n\tSOC_ENUM_SINGLE(TEGRA210_MBDRC_CFG,\n\t\t\tTEGRA210_MBDRC_CFG_FILTER_STRUCTURE_SHIFT, 2,\n\t\t\ttegra210_mbdrc_filter_structure_text);\n\nstatic const char * const tegra210_mbdrc_frame_size_text[] = {\n\t\"N1\", \"N2\", \"N4\", \"N8\", \"N16\", \"N32\", \"N64\"\n};\n\nstatic const struct soc_enum tegra210_mbdrc_frame_size_enum =\n\tSOC_ENUM_SINGLE(TEGRA210_MBDRC_CFG, TEGRA210_MBDRC_CFG_FRAME_SIZE_SHIFT,\n\t\t\t7, tegra210_mbdrc_frame_size_text);\n\n#define TEGRA_MBDRC_BYTES_EXT(xname, xbase, xregs, xshift, xmask, xinfo)    \\\n\tTEGRA_SOC_BYTES_EXT(xname, xbase, xregs, xshift, xmask,\t\t    \\\n\t\t\t    tegra210_mbdrc_band_params_get,\t\t    \\\n\t\t\t    tegra210_mbdrc_band_params_put,\t\t    \\\n\t\t\t    tegra210_mbdrc_param_info)\n\n#define TEGRA_MBDRC_BAND_BYTES_EXT(xname, xbase, xshift, xmask, xinfo)\t    \\\n\tTEGRA_MBDRC_BYTES_EXT(xname, xbase, TEGRA210_MBDRC_FILTER_COUNT,    \\\n\t\t\t      xshift, xmask, xinfo)\n\nstatic const DECLARE_TLV_DB_MINMAX(mdbrc_vol_tlv, -25600, 25500);\n\nstatic const struct snd_kcontrol_new tegra210_mbdrc_controls[] = {\n\tSOC_ENUM_EXT(\"MBDRC Peak RMS Mode\", tegra210_mbdrc_peak_rms_enum,\n\t\t     tegra210_mbdrc_get_enum, tegra210_mbdrc_put_enum),\n\n\tSOC_ENUM_EXT(\"MBDRC Filter Structure\",\n\t\t     tegra210_mbdrc_filter_structure_enum,\n\t\t     tegra210_mbdrc_get_enum, tegra210_mbdrc_put_enum),\n\n\tSOC_ENUM_EXT(\"MBDRC Frame Size\", tegra210_mbdrc_frame_size_enum,\n\t\t     tegra210_mbdrc_get_enum, tegra210_mbdrc_put_enum),\n\n\tSOC_ENUM_EXT(\"MBDRC Mode\", tegra210_mbdrc_mode_enum,\n\t\t     tegra210_mbdrc_get_enum, tegra210_mbdrc_put_enum),\n\n\tSOC_SINGLE_EXT(\"MBDRC RMS Offset\", TEGRA210_MBDRC_CFG,\n\t\t       TEGRA210_MBDRC_CFG_RMS_OFFSET_SHIFT, 0x1ff, 0,\n\t\t       tegra210_mbdrc_get, tegra210_mbdrc_put),\n\n\tSOC_SINGLE_EXT(\"MBDRC Shift Control\", TEGRA210_MBDRC_CFG,\n\t\t       TEGRA210_MBDRC_CFG_SHIFT_CTRL_SHIFT, 0x1f, 0,\n\t\t       tegra210_mbdrc_get, tegra210_mbdrc_put),\n\n\tSOC_SINGLE_EXT(\"MBDRC Fast Attack Factor\", TEGRA210_MBDRC_FAST_FACTOR,\n\t\t       TEGRA210_MBDRC_FAST_FACTOR_ATTACK_SHIFT, 0xffff, 0,\n\t\t       tegra210_mbdrc_get, tegra210_mbdrc_put),\n\n\tSOC_SINGLE_EXT(\"MBDRC Fast Release Factor\", TEGRA210_MBDRC_FAST_FACTOR,\n\t\t       TEGRA210_MBDRC_FAST_FACTOR_RELEASE_SHIFT, 0xffff, 0,\n\t\t       tegra210_mbdrc_get, tegra210_mbdrc_put),\n\n\tSOC_SINGLE_RANGE_EXT_TLV(\"MBDRC Master Volume\",\n\t\t\t\t TEGRA210_MBDRC_MASTER_VOL,\n\t\t\t\t TEGRA210_MBDRC_MASTER_VOL_SHIFT,\n\t\t\t\t 0, 0x1ff, 0,\n\t\t\t\t tegra210_mbdrc_vol_get, tegra210_mbdrc_vol_put,\n\t\t\t\t mdbrc_vol_tlv),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC IIR Stages\", TEGRA210_MBDRC_IIR_CFG,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_IIR_CFG_NUM_STAGES_SHIFT,\n\t\t\t    TEGRA210_MBDRC_IIR_CFG_NUM_STAGES_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC In Attack Time Const\", TEGRA210_MBDRC_IN_ATTACK,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_IN_ATTACK_TC_SHIFT,\n\t\t\t    TEGRA210_MBDRC_IN_ATTACK_TC_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC In Release Time Const\", TEGRA210_MBDRC_IN_RELEASE,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_IN_RELEASE_TC_SHIFT,\n\t\t\t    TEGRA210_MBDRC_IN_RELEASE_TC_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Fast Attack Time Const\", TEGRA210_MBDRC_FAST_ATTACK,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_FAST_ATTACK_TC_SHIFT,\n\t\t\t    TEGRA210_MBDRC_FAST_ATTACK_TC_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC In Threshold\", TEGRA210_MBDRC_IN_THRESHOLD,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT * 4, 0, 0xffffffff,\n\t\t\t    tegra210_mbdrc_threshold_get,\n\t\t\t    tegra210_mbdrc_threshold_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Out Threshold\", TEGRA210_MBDRC_OUT_THRESHOLD,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT * 4, 0, 0xffffffff,\n\t\t\t    tegra210_mbdrc_threshold_get,\n\t\t\t    tegra210_mbdrc_threshold_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Ratio\", TEGRA210_MBDRC_RATIO_1ST,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT * 5,\n\t\t\t    TEGRA210_MBDRC_RATIO_1ST_SHIFT, TEGRA210_MBDRC_RATIO_1ST_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Makeup Gain\", TEGRA210_MBDRC_MAKEUP_GAIN,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_MAKEUP_GAIN_SHIFT,\n\t\t\t    TEGRA210_MBDRC_MAKEUP_GAIN_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Init Gain\", TEGRA210_MBDRC_INIT_GAIN,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_INIT_GAIN_SHIFT,\n\t\t\t    TEGRA210_MBDRC_INIT_GAIN_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Attack Gain\", TEGRA210_MBDRC_GAIN_ATTACK,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_GAIN_ATTACK_SHIFT,\n\t\t\t    TEGRA210_MBDRC_GAIN_ATTACK_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Release Gain\", TEGRA210_MBDRC_GAIN_RELEASE,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_GAIN_RELEASE_SHIFT,\n\t\t\t    TEGRA210_MBDRC_GAIN_RELEASE_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Fast Release Gain\",\n\t\t\t    TEGRA210_MBDRC_FAST_RELEASE,\n\t\t\t    TEGRA210_MBDRC_FILTER_COUNT,\n\t\t\t    TEGRA210_MBDRC_FAST_RELEASE_SHIFT,\n\t\t\t    TEGRA210_MBDRC_FAST_RELEASE_MASK,\n\t\t\t    tegra210_mbdrc_band_params_get,\n\t\t\t    tegra210_mbdrc_band_params_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Low Band Biquad Coeffs\",\n\t\t\t    TEGRA210_MBDRC_CFG_RAM_CTRL,\n\t\t\t    TEGRA210_MBDRC_MAX_BIQUAD_STAGES * 5, 0, 0xffffffff,\n\t\t\t    tegra210_mbdrc_biquad_coeffs_get,\n\t\t\t    tegra210_mbdrc_biquad_coeffs_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC Mid Band Biquad Coeffs\",\n\t\t\t    TEGRA210_MBDRC_CFG_RAM_CTRL +\n\t\t\t\tTEGRA210_MBDRC_FILTER_PARAM_STRIDE,\n\t\t\t    TEGRA210_MBDRC_MAX_BIQUAD_STAGES * 5, 0, 0xffffffff,\n\t\t\t    tegra210_mbdrc_biquad_coeffs_get,\n\t\t\t    tegra210_mbdrc_biquad_coeffs_put,\n\t\t\t    tegra210_mbdrc_param_info),\n\n\tTEGRA_SOC_BYTES_EXT(\"MBDRC High Band Biquad Coeffs\",\n\t\t\t    TEGRA210_MBDRC_CFG_RAM_CTRL +\n\t\t\t\t(TEGRA210_MBDRC_FILTER_PARAM_STRIDE * 2),\n\t\t\t    TEGRA210_MBDRC_MAX_BIQUAD_STAGES * 5, 0, 0xffffffff,\n\t\t\t    tegra210_mbdrc_biquad_coeffs_get,\n\t\t\t    tegra210_mbdrc_biquad_coeffs_put,\n\t\t\t    tegra210_mbdrc_param_info),\n};\n\nstatic bool tegra210_mbdrc_wr_reg(struct device *dev, unsigned int reg)\n{\n\tif (reg >= TEGRA210_MBDRC_IIR_CFG)\n\t\treg -= ((reg - TEGRA210_MBDRC_IIR_CFG) %\n\t\t\t(TEGRA210_MBDRC_FILTER_PARAM_STRIDE *\n\t\t\t TEGRA210_MBDRC_FILTER_COUNT));\n\n\tswitch (reg) {\n\tcase TEGRA210_MBDRC_SOFT_RESET:\n\tcase TEGRA210_MBDRC_CG:\n\tcase TEGRA210_MBDRC_CFG ... TEGRA210_MBDRC_CFG_RAM_DATA:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool tegra210_mbdrc_rd_reg(struct device *dev, unsigned int reg)\n{\n\tif (tegra210_mbdrc_wr_reg(dev, reg))\n\t\treturn true;\n\n\tif (reg >= TEGRA210_MBDRC_IIR_CFG)\n\t\treg -= ((reg - TEGRA210_MBDRC_IIR_CFG) %\n\t\t\t(TEGRA210_MBDRC_FILTER_PARAM_STRIDE *\n\t\t\t TEGRA210_MBDRC_FILTER_COUNT));\n\n\tswitch (reg) {\n\tcase TEGRA210_MBDRC_STATUS:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool tegra210_mbdrc_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tif (reg >= TEGRA210_MBDRC_IIR_CFG)\n\t\treg -= ((reg - TEGRA210_MBDRC_IIR_CFG) %\n\t\t\t(TEGRA210_MBDRC_FILTER_PARAM_STRIDE *\n\t\t\t TEGRA210_MBDRC_FILTER_COUNT));\n\n\tswitch (reg) {\n\tcase TEGRA210_MBDRC_SOFT_RESET:\n\tcase TEGRA210_MBDRC_STATUS:\n\tcase TEGRA210_MBDRC_CFG_RAM_CTRL:\n\tcase TEGRA210_MBDRC_CFG_RAM_DATA:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool tegra210_mbdrc_precious_reg(struct device *dev, unsigned int reg)\n{\n\tif (reg >= TEGRA210_MBDRC_IIR_CFG)\n\t\treg -= ((reg - TEGRA210_MBDRC_IIR_CFG) %\n\t\t\t(TEGRA210_MBDRC_FILTER_PARAM_STRIDE *\n\t\t\t TEGRA210_MBDRC_FILTER_COUNT));\n\n\tswitch (reg) {\n\tcase TEGRA210_MBDRC_CFG_RAM_DATA:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct regmap_config tegra210_mbdrc_regmap_cfg = {\n\t.name\t\t\t= \"mbdrc\",\n\t.reg_bits\t\t= 32,\n\t.reg_stride\t\t= 4,\n\t.val_bits\t\t= 32,\n\t.max_register\t\t= TEGRA210_MBDRC_MAX_REG,\n\t.writeable_reg\t\t= tegra210_mbdrc_wr_reg,\n\t.readable_reg\t\t= tegra210_mbdrc_rd_reg,\n\t.volatile_reg\t\t= tegra210_mbdrc_volatile_reg,\n\t.precious_reg\t\t= tegra210_mbdrc_precious_reg,\n\t.reg_defaults\t\t= tegra210_mbdrc_reg_defaults,\n\t.num_reg_defaults\t= ARRAY_SIZE(tegra210_mbdrc_reg_defaults),\n\t.cache_type\t\t= REGCACHE_FLAT,\n};\n\nint tegra210_mbdrc_hw_params(struct snd_soc_component *cmpnt)\n{\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tconst struct tegra210_mbdrc_config *conf = &mbdrc_init_config;\n\tu32 val = 0;\n\tunsigned int i;\n\n\tregmap_read(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG, &val);\n\n\tval &= TEGRA210_MBDRC_CFG_MBDRC_MODE_MASK;\n\n\tif (val == TEGRA210_MBDRC_CFG_MBDRC_MODE_BYPASS)\n\t\treturn 0;\n\n\tfor (i = 0; i < MBDRC_NUM_BAND; i++) {\n\t\tconst struct tegra210_mbdrc_band_params *params =\n\t\t\t&conf->band_params[i];\n\n\t\tu32 reg_off = i * TEGRA210_MBDRC_FILTER_PARAM_STRIDE;\n\n\t\ttegra210_mbdrc_write_ram(ope->mbdrc_regmap,\n\t\t\t\t\t reg_off + TEGRA210_MBDRC_CFG_RAM_CTRL,\n\t\t\t\t\t reg_off + TEGRA210_MBDRC_CFG_RAM_DATA,\n\t\t\t\t\t 0, (u32 *)&params->biquad_params[0],\n\t\t\t\t\t TEGRA210_MBDRC_MAX_BIQUAD_STAGES * 5);\n\t}\n\treturn 0;\n}\n\nint tegra210_mbdrc_component_init(struct snd_soc_component *cmpnt)\n{\n\tstruct tegra210_ope *ope = snd_soc_component_get_drvdata(cmpnt);\n\tconst struct tegra210_mbdrc_config *conf = &mbdrc_init_config;\n\tunsigned int i;\n\tu32 val;\n\n\tpm_runtime_get_sync(cmpnt->dev);\n\n\t \n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG,\n\t\tTEGRA210_MBDRC_CFG_MBDRC_MODE_MASK,\n\t\tconf->mode << TEGRA210_MBDRC_CFG_MBDRC_MODE_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG,\n\t\tTEGRA210_MBDRC_CFG_RMS_OFFSET_MASK,\n\t\tconf->rms_off << TEGRA210_MBDRC_CFG_RMS_OFFSET_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG,\n\t\tTEGRA210_MBDRC_CFG_PEAK_RMS_MASK,\n\t\tconf->peak_rms_mode << TEGRA210_MBDRC_CFG_PEAK_RMS_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG,\n\t\tTEGRA210_MBDRC_CFG_FILTER_STRUCTURE_MASK,\n\t\tconf->filter_structure <<\n\t\tTEGRA210_MBDRC_CFG_FILTER_STRUCTURE_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG,\n\t\tTEGRA210_MBDRC_CFG_SHIFT_CTRL_MASK,\n\t\tconf->shift_ctrl << TEGRA210_MBDRC_CFG_SHIFT_CTRL_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CFG,\n\t\tTEGRA210_MBDRC_CFG_FRAME_SIZE_MASK,\n\t\t__ffs(conf->frame_size) <<\n\t\tTEGRA210_MBDRC_CFG_FRAME_SIZE_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_CHANNEL_MASK,\n\t\tTEGRA210_MBDRC_CHANNEL_MASK_MASK,\n\t\tconf->channel_mask << TEGRA210_MBDRC_CHANNEL_MASK_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_FAST_FACTOR,\n\t\tTEGRA210_MBDRC_FAST_FACTOR_ATTACK_MASK,\n\t\tconf->fa_factor << TEGRA210_MBDRC_FAST_FACTOR_ATTACK_SHIFT);\n\n\tregmap_update_bits(ope->mbdrc_regmap, TEGRA210_MBDRC_FAST_FACTOR,\n\t\tTEGRA210_MBDRC_FAST_FACTOR_ATTACK_MASK,\n\t\tconf->fr_factor << TEGRA210_MBDRC_FAST_FACTOR_ATTACK_SHIFT);\n\n\tfor (i = 0; i < MBDRC_NUM_BAND; i++) {\n\t\tconst struct tegra210_mbdrc_band_params *params =\n\t\t\t\t\t\t&conf->band_params[i];\n\t\tu32 reg_off = i * TEGRA210_MBDRC_FILTER_PARAM_STRIDE;\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_IIR_CFG,\n\t\t\tTEGRA210_MBDRC_IIR_CFG_NUM_STAGES_MASK,\n\t\t\tparams->iir_stages <<\n\t\t\t\tTEGRA210_MBDRC_IIR_CFG_NUM_STAGES_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_IN_ATTACK,\n\t\t\tTEGRA210_MBDRC_IN_ATTACK_TC_MASK,\n\t\t\tparams->in_attack_tc <<\n\t\t\t\tTEGRA210_MBDRC_IN_ATTACK_TC_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_IN_RELEASE,\n\t\t\tTEGRA210_MBDRC_IN_RELEASE_TC_MASK,\n\t\t\tparams->in_release_tc <<\n\t\t\t\tTEGRA210_MBDRC_IN_RELEASE_TC_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_FAST_ATTACK,\n\t\t\tTEGRA210_MBDRC_FAST_ATTACK_TC_MASK,\n\t\t\tparams->fast_attack_tc <<\n\t\t\t\tTEGRA210_MBDRC_FAST_ATTACK_TC_SHIFT);\n\n\t\tval = (((params->in_threshold[0] >>\n\t\t\t TEGRA210_MBDRC_THRESH_1ST_SHIFT) &\n\t\t\tTEGRA210_MBDRC_THRESH_1ST_MASK) |\n\t\t\t((params->in_threshold[1] >>\n\t\t\t  TEGRA210_MBDRC_THRESH_2ND_SHIFT) &\n\t\t\t TEGRA210_MBDRC_THRESH_2ND_MASK) |\n\t\t\t((params->in_threshold[2] >>\n\t\t\t  TEGRA210_MBDRC_THRESH_3RD_SHIFT) &\n\t\t\t TEGRA210_MBDRC_THRESH_3RD_MASK) |\n\t\t\t((params->in_threshold[3] >>\n\t\t\t  TEGRA210_MBDRC_THRESH_4TH_SHIFT) &\n\t\t\t TEGRA210_MBDRC_THRESH_4TH_MASK));\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\t\t   reg_off + TEGRA210_MBDRC_IN_THRESHOLD,\n\t\t\t\t   0xffffffff, val);\n\n\t\tval = (((params->out_threshold[0] >>\n\t\t\t TEGRA210_MBDRC_THRESH_1ST_SHIFT) &\n\t\t\tTEGRA210_MBDRC_THRESH_1ST_MASK) |\n\t\t\t((params->out_threshold[1] >>\n\t\t\t  TEGRA210_MBDRC_THRESH_2ND_SHIFT) &\n\t\t\t TEGRA210_MBDRC_THRESH_2ND_MASK) |\n\t\t\t((params->out_threshold[2] >>\n\t\t\t  TEGRA210_MBDRC_THRESH_3RD_SHIFT) &\n\t\t\t TEGRA210_MBDRC_THRESH_3RD_MASK) |\n\t\t\t((params->out_threshold[3] >>\n\t\t\t  TEGRA210_MBDRC_THRESH_4TH_SHIFT) &\n\t\t\t TEGRA210_MBDRC_THRESH_4TH_MASK));\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_OUT_THRESHOLD,\n\t\t\t0xffffffff, val);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_RATIO_1ST,\n\t\t\tTEGRA210_MBDRC_RATIO_1ST_MASK,\n\t\t\tparams->ratio[0] << TEGRA210_MBDRC_RATIO_1ST_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_RATIO_2ND,\n\t\t\tTEGRA210_MBDRC_RATIO_2ND_MASK,\n\t\t\tparams->ratio[1] << TEGRA210_MBDRC_RATIO_2ND_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_RATIO_3RD,\n\t\t\tTEGRA210_MBDRC_RATIO_3RD_MASK,\n\t\t\tparams->ratio[2] << TEGRA210_MBDRC_RATIO_3RD_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_RATIO_4TH,\n\t\t\tTEGRA210_MBDRC_RATIO_4TH_MASK,\n\t\t\tparams->ratio[3] << TEGRA210_MBDRC_RATIO_4TH_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_RATIO_5TH,\n\t\t\tTEGRA210_MBDRC_RATIO_5TH_MASK,\n\t\t\tparams->ratio[4] << TEGRA210_MBDRC_RATIO_5TH_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_MAKEUP_GAIN,\n\t\t\tTEGRA210_MBDRC_MAKEUP_GAIN_MASK,\n\t\t\tparams->makeup_gain <<\n\t\t\t\tTEGRA210_MBDRC_MAKEUP_GAIN_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_INIT_GAIN,\n\t\t\tTEGRA210_MBDRC_INIT_GAIN_MASK,\n\t\t\tparams->gain_init <<\n\t\t\t\tTEGRA210_MBDRC_INIT_GAIN_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_GAIN_ATTACK,\n\t\t\tTEGRA210_MBDRC_GAIN_ATTACK_MASK,\n\t\t\tparams->gain_attack_tc <<\n\t\t\t\tTEGRA210_MBDRC_GAIN_ATTACK_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_GAIN_RELEASE,\n\t\t\tTEGRA210_MBDRC_GAIN_RELEASE_MASK,\n\t\t\tparams->gain_release_tc <<\n\t\t\t\tTEGRA210_MBDRC_GAIN_RELEASE_SHIFT);\n\n\t\tregmap_update_bits(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_FAST_RELEASE,\n\t\t\tTEGRA210_MBDRC_FAST_RELEASE_MASK,\n\t\t\tparams->fast_release_tc <<\n\t\t\t\tTEGRA210_MBDRC_FAST_RELEASE_SHIFT);\n\n\t\ttegra210_mbdrc_write_ram(ope->mbdrc_regmap,\n\t\t\treg_off + TEGRA210_MBDRC_CFG_RAM_CTRL,\n\t\t\treg_off + TEGRA210_MBDRC_CFG_RAM_DATA, 0,\n\t\t\t(u32 *)&params->biquad_params[0],\n\t\t\tTEGRA210_MBDRC_MAX_BIQUAD_STAGES * 5);\n\t}\n\n\tpm_runtime_put_sync(cmpnt->dev);\n\n\tsnd_soc_add_component_controls(cmpnt, tegra210_mbdrc_controls,\n\t\t\t\t       ARRAY_SIZE(tegra210_mbdrc_controls));\n\n\treturn 0;\n}\n\nint tegra210_mbdrc_regmap_init(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct tegra210_ope *ope = dev_get_drvdata(dev);\n\tstruct device_node *child;\n\tstruct resource mem;\n\tvoid __iomem *regs;\n\tint err;\n\n\tchild = of_get_child_by_name(dev->of_node, \"dynamic-range-compressor\");\n\tif (!child)\n\t\treturn -ENODEV;\n\n\terr = of_address_to_resource(child, 0, &mem);\n\tof_node_put(child);\n\tif (err < 0) {\n\t\tdev_err(dev, \"fail to get MBDRC resource\\n\");\n\t\treturn err;\n\t}\n\n\tmem.flags = IORESOURCE_MEM;\n\tregs = devm_ioremap_resource(dev, &mem);\n\tif (IS_ERR(regs))\n\t\treturn PTR_ERR(regs);\n\n\tope->mbdrc_regmap = devm_regmap_init_mmio(dev, regs,\n\t\t\t\t\t\t  &tegra210_mbdrc_regmap_cfg);\n\tif (IS_ERR(ope->mbdrc_regmap)) {\n\t\tdev_err(dev, \"regmap init failed\\n\");\n\t\treturn PTR_ERR(ope->mbdrc_regmap);\n\t}\n\n\tregcache_cache_only(ope->mbdrc_regmap, true);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}