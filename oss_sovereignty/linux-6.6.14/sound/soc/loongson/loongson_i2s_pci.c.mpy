{
  "module_name": "loongson_i2s_pci.c",
  "hash_id": "0e33308259469e3acec4fc43b851c197356d3f59b4430fd48e7d819920516f4c",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/loongson/loongson_i2s_pci.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/pm_runtime.h>\n#include <linux/dma-mapping.h>\n#include <linux/acpi.h>\n#include <linux/pci.h>\n#include <sound/soc.h>\n#include \"loongson_i2s.h\"\n#include \"loongson_dma.h\"\n\nstatic bool loongson_i2s_wr_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase LS_I2S_CFG:\n\tcase LS_I2S_CTRL:\n\tcase LS_I2S_RX_DATA:\n\tcase LS_I2S_TX_DATA:\n\tcase LS_I2S_CFG1:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t};\n}\n\nstatic bool loongson_i2s_rd_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase LS_I2S_VER:\n\tcase LS_I2S_CFG:\n\tcase LS_I2S_CTRL:\n\tcase LS_I2S_RX_DATA:\n\tcase LS_I2S_TX_DATA:\n\tcase LS_I2S_CFG1:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t};\n}\n\nstatic bool loongson_i2s_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase LS_I2S_CFG:\n\tcase LS_I2S_CTRL:\n\tcase LS_I2S_RX_DATA:\n\tcase LS_I2S_TX_DATA:\n\tcase LS_I2S_CFG1:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t};\n}\n\nstatic const struct regmap_config loongson_i2s_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.max_register = LS_I2S_CFG1,\n\t.writeable_reg = loongson_i2s_wr_reg,\n\t.readable_reg = loongson_i2s_rd_reg,\n\t.volatile_reg = loongson_i2s_volatile_reg,\n\t.cache_type = REGCACHE_FLAT,\n};\n\nstatic int loongson_i2s_pci_probe(struct pci_dev *pdev,\n\t\t\t\t  const struct pci_device_id *pid)\n{\n\tconst struct fwnode_handle *fwnode = pdev->dev.fwnode;\n\tstruct loongson_dma_data *tx_data, *rx_data;\n\tstruct loongson_i2s *i2s;\n\tint ret;\n\n\tif (pcim_enable_device(pdev)) {\n\t\tdev_err(&pdev->dev, \"pci_enable_device failed\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\ti2s = devm_kzalloc(&pdev->dev, sizeof(*i2s), GFP_KERNEL);\n\tif (!i2s)\n\t\treturn -ENOMEM;\n\n\ti2s->rev_id = pdev->revision;\n\ti2s->dev = &pdev->dev;\n\tpci_set_drvdata(pdev, i2s);\n\n\tret = pcim_iomap_regions(pdev, 1 << 0, dev_name(&pdev->dev));\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"iomap_regions failed\\n\");\n\t\treturn ret;\n\t}\n\ti2s->reg_base = pcim_iomap_table(pdev)[0];\n\ti2s->regmap = devm_regmap_init_mmio(&pdev->dev, i2s->reg_base,\n\t\t\t\t\t    &loongson_i2s_regmap_config);\n\tif (IS_ERR(i2s->regmap)) {\n\t\tdev_err(&pdev->dev, \"regmap_init_mmio failed\\n\");\n\t\treturn PTR_ERR(i2s->regmap);\n\t}\n\n\ttx_data = &i2s->tx_dma_data;\n\trx_data = &i2s->rx_dma_data;\n\n\ttx_data->dev_addr = pci_resource_start(pdev, 0) + LS_I2S_TX_DATA;\n\ttx_data->order_addr = i2s->reg_base + LS_I2S_TX_ORDER;\n\n\trx_data->dev_addr = pci_resource_start(pdev, 0) + LS_I2S_RX_DATA;\n\trx_data->order_addr = i2s->reg_base + LS_I2S_RX_ORDER;\n\n\ttx_data->irq = fwnode_irq_get_byname(fwnode, \"tx\");\n\tif (tx_data->irq < 0) {\n\t\tdev_err(&pdev->dev, \"dma tx irq invalid\\n\");\n\t\treturn tx_data->irq;\n\t}\n\n\trx_data->irq = fwnode_irq_get_byname(fwnode, \"rx\");\n\tif (rx_data->irq < 0) {\n\t\tdev_err(&pdev->dev, \"dma rx irq invalid\\n\");\n\t\treturn rx_data->irq;\n\t}\n\n\tdevice_property_read_u32(&pdev->dev, \"clock-frequency\", &i2s->clk_rate);\n\tif (!i2s->clk_rate) {\n\t\tdev_err(&pdev->dev, \"clock-frequency property invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdma_set_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(64));\n\n\tif (i2s->rev_id == 1) {\n\t\tregmap_write(i2s->regmap, LS_I2S_CTRL, I2S_CTRL_RESET);\n\t\tudelay(200);\n\t}\n\n\tret = devm_snd_soc_register_component(&pdev->dev,\n\t\t\t\t\t      &loongson_i2s_component,\n\t\t\t\t\t      &loongson_i2s_dai, 1);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"register DAI failed %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct pci_device_id loongson_i2s_ids[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_LOONGSON, 0x7a27) },\n\t{ },\n};\nMODULE_DEVICE_TABLE(pci, loongson_i2s_ids);\n\nstatic struct pci_driver loongson_i2s_driver = {\n\t.name = \"loongson-i2s-pci\",\n\t.id_table = loongson_i2s_ids,\n\t.probe = loongson_i2s_pci_probe,\n\t.driver = {\n\t\t.owner = THIS_MODULE,\n\t\t.pm = pm_sleep_ptr(&loongson_i2s_pm),\n\t},\n};\nmodule_pci_driver(loongson_i2s_driver);\n\nMODULE_DESCRIPTION(\"Loongson I2S Master Mode ASoC Driver\");\nMODULE_AUTHOR(\"Loongson Technology Corporation Limited\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}