{
  "module_name": "loongson_card.c",
  "hash_id": "7efba0988d131a3676491e5a164edc8f71be07627502e18d9062ef6b54886c03",
  "original_prompt": "Ingested from linux-6.6.14/sound/soc/loongson/loongson_card.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <sound/soc.h>\n#include <sound/soc-acpi.h>\n#include <linux/acpi.h>\n#include <linux/pci.h>\n#include <sound/pcm_params.h>\n\nstatic char codec_name[SND_ACPI_I2C_ID_LEN];\n\nstruct loongson_card_data {\n\tstruct snd_soc_card snd_card;\n\tunsigned int mclk_fs;\n};\n\nstatic int loongson_card_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\t   struct snd_pcm_hw_params *params)\n{\n\tstruct snd_soc_pcm_runtime *rtd = substream->private_data;\n\tstruct snd_soc_dai *cpu_dai = asoc_rtd_to_cpu(rtd, 0);\n\tstruct snd_soc_dai *codec_dai = asoc_rtd_to_codec(rtd, 0);\n\tstruct loongson_card_data *ls_card = snd_soc_card_get_drvdata(rtd->card);\n\tint ret, mclk;\n\n\tif (ls_card->mclk_fs) {\n\t\tmclk = ls_card->mclk_fs * params_rate(params);\n\t\tret = snd_soc_dai_set_sysclk(cpu_dai, 0, mclk,\n\t\t\t\t\t     SND_SOC_CLOCK_OUT);\n\t\tif (ret < 0) {\n\t\t\tdev_err(codec_dai->dev, \"cpu_dai clock not set\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = snd_soc_dai_set_sysclk(codec_dai, 0, mclk,\n\t\t\t\t\t     SND_SOC_CLOCK_IN);\n\t\tif (ret < 0) {\n\t\t\tdev_err(codec_dai->dev, \"codec_dai clock not set\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic const struct snd_soc_ops loongson_ops = {\n\t.hw_params = loongson_card_hw_params,\n};\n\nSND_SOC_DAILINK_DEFS(analog,\n\tDAILINK_COMP_ARRAY(COMP_CPU(\"loongson-i2s\")),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()),\n\tDAILINK_COMP_ARRAY(COMP_EMPTY()));\n\nstatic struct snd_soc_dai_link loongson_dai_links[] = {\n\t{\n\t\t.name = \"Loongson Audio Port\",\n\t\t.stream_name = \"Loongson Audio\",\n\t\t.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_IB_NF\n\t\t\t| SND_SOC_DAIFMT_CBC_CFC,\n\t\tSND_SOC_DAILINK_REG(analog),\n\t\t.ops = &loongson_ops,\n\t},\n};\n\nstatic int loongson_card_parse_acpi(struct loongson_card_data *data)\n{\n\tstruct snd_soc_card *card = &data->snd_card;\n\tstruct fwnode_handle *fwnode = card->dev->fwnode;\n\tstruct fwnode_reference_args args;\n\tconst char *codec_dai_name;\n\tstruct acpi_device *adev;\n\tstruct device *phy_dev;\n\tint ret, i;\n\n\t \n\tmemset(&args, 0, sizeof(args));\n\tret = acpi_node_get_property_reference(fwnode, \"cpu\", 0, &args);\n\tif (ret || !is_acpi_device_node(args.fwnode)) {\n\t\tdev_err(card->dev, \"No matching phy in ACPI table\\n\");\n\t\treturn ret ?: -ENOENT;\n\t}\n\tadev = to_acpi_device_node(args.fwnode);\n\tphy_dev = acpi_get_first_physical_node(adev);\n\tif (!phy_dev)\n\t\treturn -EPROBE_DEFER;\n\tfor (i = 0; i < card->num_links; i++)\n\t\tloongson_dai_links[i].platforms->name = dev_name(phy_dev);\n\n\t \n\tmemset(&args, 0, sizeof(args));\n\tret = acpi_node_get_property_reference(fwnode, \"codec\", 0, &args);\n\tif (ret || !is_acpi_device_node(args.fwnode)) {\n\t\tdev_err(card->dev, \"No matching phy in ACPI table\\n\");\n\t\treturn ret ?: -ENOENT;\n\t}\n\tadev = to_acpi_device_node(args.fwnode);\n\tsnprintf(codec_name, sizeof(codec_name), \"i2c-%s\", acpi_dev_name(adev));\n\tfor (i = 0; i < card->num_links; i++)\n\t\tloongson_dai_links[i].codecs->name = codec_name;\n\n\tdevice_property_read_string(card->dev, \"codec-dai-name\",\n\t\t\t\t    &codec_dai_name);\n\tfor (i = 0; i < card->num_links; i++)\n\t\tloongson_dai_links[i].codecs->dai_name = codec_dai_name;\n\n\treturn 0;\n}\n\nstatic int loongson_card_parse_of(struct loongson_card_data *data)\n{\n\tstruct device_node *cpu, *codec;\n\tstruct snd_soc_card *card = &data->snd_card;\n\tstruct device *dev = card->dev;\n\tint ret, i;\n\n\tcpu = of_get_child_by_name(dev->of_node, \"cpu\");\n\tif (!cpu) {\n\t\tdev_err(dev, \"platform property missing or invalid\\n\");\n\t\treturn -EINVAL;\n\t}\n\tcodec = of_get_child_by_name(dev->of_node, \"codec\");\n\tif (!codec) {\n\t\tdev_err(dev, \"audio-codec property missing or invalid\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\n\tfor (i = 0; i < card->num_links; i++) {\n\t\tret = snd_soc_of_get_dlc(cpu, NULL, loongson_dai_links[i].cpus, 0);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"getting cpu dlc error (%d)\\n\", ret);\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = snd_soc_of_get_dlc(codec, NULL, loongson_dai_links[i].codecs, 0);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"getting codec dlc error (%d)\\n\", ret);\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tof_node_put(cpu);\n\tof_node_put(codec);\n\n\treturn 0;\n\nerr:\n\tof_node_put(cpu);\n\tof_node_put(codec);\n\treturn ret;\n}\n\nstatic int loongson_asoc_card_probe(struct platform_device *pdev)\n{\n\tstruct loongson_card_data *ls_priv;\n\tstruct snd_soc_card *card;\n\tint ret;\n\n\tls_priv = devm_kzalloc(&pdev->dev, sizeof(*ls_priv), GFP_KERNEL);\n\tif (!ls_priv)\n\t\treturn -ENOMEM;\n\n\tcard = &ls_priv->snd_card;\n\n\tcard->dev = &pdev->dev;\n\tcard->owner = THIS_MODULE;\n\tcard->dai_link = loongson_dai_links;\n\tcard->num_links = ARRAY_SIZE(loongson_dai_links);\n\tsnd_soc_card_set_drvdata(card, ls_priv);\n\n\tret = device_property_read_string(&pdev->dev, \"model\", &card->name);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Error parsing card name: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tret = device_property_read_u32(&pdev->dev, \"mclk-fs\", &ls_priv->mclk_fs);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Error parsing mclk-fs: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (has_acpi_companion(&pdev->dev))\n\t\tret = loongson_card_parse_acpi(ls_priv);\n\telse\n\t\tret = loongson_card_parse_of(ls_priv);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = devm_snd_soc_register_card(&pdev->dev, card);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id loongson_asoc_dt_ids[] = {\n\t{ .compatible = \"loongson,ls-audio-card\" },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, loongson_asoc_dt_ids);\n\nstatic struct platform_driver loongson_audio_driver = {\n\t.probe = loongson_asoc_card_probe,\n\t.driver = {\n\t\t.name = \"loongson-asoc-card\",\n\t\t.pm = &snd_soc_pm_ops,\n\t\t.of_match_table = loongson_asoc_dt_ids,\n\t},\n};\nmodule_platform_driver(loongson_audio_driver);\n\nMODULE_DESCRIPTION(\"Loongson ASoc Sound Card driver\");\nMODULE_AUTHOR(\"Loongson Technology Corporation Limited\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}