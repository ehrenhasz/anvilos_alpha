{
  "module_name": "msnd_midi.c",
  "hash_id": "3120269b8622d3620c76712433abfa7d6aa176c239b3741f324917aed765273f",
  "original_prompt": "Ingested from linux-6.6.14/sound/isa/msnd/msnd_midi.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/delay.h>\n#include <linux/ioport.h>\n#include <linux/errno.h>\n#include <linux/export.h>\n#include <sound/core.h>\n#include <sound/rawmidi.h>\n\n#include \"msnd.h\"\n\n#define MSNDMIDI_MODE_BIT_INPUT\t\t0\n#define MSNDMIDI_MODE_BIT_OUTPUT\t\t1\n#define MSNDMIDI_MODE_BIT_INPUT_TRIGGER\t2\n#define MSNDMIDI_MODE_BIT_OUTPUT_TRIGGER\t3\n\nstruct snd_msndmidi {\n\tstruct snd_msnd *dev;\n\n\tunsigned long mode;\t\t \n\n\tstruct snd_rawmidi_substream *substream_input;\n\n\tspinlock_t input_lock;\n};\n\n \nstatic int snd_msndmidi_input_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_msndmidi *mpu;\n\n\tsnd_printdd(\"snd_msndmidi_input_open()\\n\");\n\n\tmpu = substream->rmidi->private_data;\n\n\tmpu->substream_input = substream;\n\n\tsnd_msnd_enable_irq(mpu->dev);\n\n\tsnd_msnd_send_dsp_cmd(mpu->dev, HDEX_MIDI_IN_START);\n\tset_bit(MSNDMIDI_MODE_BIT_INPUT, &mpu->mode);\n\treturn 0;\n}\n\nstatic int snd_msndmidi_input_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_msndmidi *mpu;\n\n\tmpu = substream->rmidi->private_data;\n\tsnd_msnd_send_dsp_cmd(mpu->dev, HDEX_MIDI_IN_STOP);\n\tclear_bit(MSNDMIDI_MODE_BIT_INPUT, &mpu->mode);\n\tmpu->substream_input = NULL;\n\tsnd_msnd_disable_irq(mpu->dev);\n\treturn 0;\n}\n\nstatic void snd_msndmidi_input_drop(struct snd_msndmidi *mpu)\n{\n\tu16 tail;\n\n\ttail = readw(mpu->dev->MIDQ + JQS_wTail);\n\twritew(tail, mpu->dev->MIDQ + JQS_wHead);\n}\n\n \nstatic void snd_msndmidi_input_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t\tint up)\n{\n\tunsigned long flags;\n\tstruct snd_msndmidi *mpu;\n\n\tsnd_printdd(\"snd_msndmidi_input_trigger(, %i)\\n\", up);\n\n\tmpu = substream->rmidi->private_data;\n\tspin_lock_irqsave(&mpu->input_lock, flags);\n\tif (up) {\n\t\tif (!test_and_set_bit(MSNDMIDI_MODE_BIT_INPUT_TRIGGER,\n\t\t\t\t      &mpu->mode))\n\t\t\tsnd_msndmidi_input_drop(mpu);\n\t} else {\n\t\tclear_bit(MSNDMIDI_MODE_BIT_INPUT_TRIGGER, &mpu->mode);\n\t}\n\tspin_unlock_irqrestore(&mpu->input_lock, flags);\n\tif (up)\n\t\tsnd_msndmidi_input_read(mpu);\n}\n\nvoid snd_msndmidi_input_read(void *mpuv)\n{\n\tunsigned long flags;\n\tstruct snd_msndmidi *mpu = mpuv;\n\tvoid __iomem *pwMIDQData = mpu->dev->mappedbase + MIDQ_DATA_BUFF;\n\tu16 head, tail, size;\n\n\tspin_lock_irqsave(&mpu->input_lock, flags);\n\thead = readw(mpu->dev->MIDQ + JQS_wHead);\n\ttail = readw(mpu->dev->MIDQ + JQS_wTail);\n\tsize = readw(mpu->dev->MIDQ + JQS_wSize);\n\tif (head > size || tail > size)\n\t\tgoto out;\n\twhile (head != tail) {\n\t\tunsigned char val = readw(pwMIDQData + 2 * head);\n\n\t\tif (test_bit(MSNDMIDI_MODE_BIT_INPUT_TRIGGER, &mpu->mode))\n\t\t\tsnd_rawmidi_receive(mpu->substream_input, &val, 1);\n\t\tif (++head > size)\n\t\t\thead = 0;\n\t\twritew(head, mpu->dev->MIDQ + JQS_wHead);\n\t}\n out:\n\tspin_unlock_irqrestore(&mpu->input_lock, flags);\n}\nEXPORT_SYMBOL(snd_msndmidi_input_read);\n\nstatic const struct snd_rawmidi_ops snd_msndmidi_input = {\n\t.open =\t\tsnd_msndmidi_input_open,\n\t.close =\tsnd_msndmidi_input_close,\n\t.trigger =\tsnd_msndmidi_input_trigger,\n};\n\nstatic void snd_msndmidi_free(struct snd_rawmidi *rmidi)\n{\n\tstruct snd_msndmidi *mpu = rmidi->private_data;\n\tkfree(mpu);\n}\n\nint snd_msndmidi_new(struct snd_card *card, int device)\n{\n\tstruct snd_msnd *chip = card->private_data;\n\tstruct snd_msndmidi *mpu;\n\tstruct snd_rawmidi *rmidi;\n\tint err;\n\n\terr = snd_rawmidi_new(card, \"MSND-MIDI\", device, 1, 1, &rmidi);\n\tif (err < 0)\n\t\treturn err;\n\tmpu = kzalloc(sizeof(*mpu), GFP_KERNEL);\n\tif (mpu == NULL) {\n\t\tsnd_device_free(card, rmidi);\n\t\treturn -ENOMEM;\n\t}\n\tmpu->dev = chip;\n\tchip->msndmidi_mpu = mpu;\n\trmidi->private_data = mpu;\n\trmidi->private_free = snd_msndmidi_free;\n\tspin_lock_init(&mpu->input_lock);\n\tstrcpy(rmidi->name, \"MSND MIDI\");\n\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\n\t\t\t    &snd_msndmidi_input);\n\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}