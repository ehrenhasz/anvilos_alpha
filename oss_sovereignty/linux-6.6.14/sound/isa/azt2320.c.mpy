{
  "module_name": "azt2320.c",
  "hash_id": "a978e561acb0a51724b2b39793fa567a88d104ac99122616f99d36b8532eff9b",
  "original_prompt": "Ingested from linux-6.6.14/sound/isa/azt2320.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/io.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/time.h>\n#include <linux/wait.h>\n#include <linux/pnp.h>\n#include <linux/module.h>\n#include <sound/core.h>\n#include <sound/initval.h>\n#include <sound/wss.h>\n#include <sound/mpu401.h>\n#include <sound/opl3.h>\n\n#define PFX \"azt2320: \"\n\nMODULE_AUTHOR(\"Massimo Piccioni <dafastidio@libero.it>\");\nMODULE_DESCRIPTION(\"Aztech Systems AZT2320\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int index[SNDRV_CARDS] = SNDRV_DEFAULT_IDX;\t \nstatic char *id[SNDRV_CARDS] = SNDRV_DEFAULT_STR;\t \nstatic bool enable[SNDRV_CARDS] = SNDRV_DEFAULT_ENABLE_ISAPNP;  \nstatic long port[SNDRV_CARDS] = SNDRV_DEFAULT_PORT;\t \nstatic long wss_port[SNDRV_CARDS] = SNDRV_DEFAULT_PORT;\t \nstatic long mpu_port[SNDRV_CARDS] = SNDRV_DEFAULT_PORT;\t \nstatic long fm_port[SNDRV_CARDS] = SNDRV_DEFAULT_PORT;\t \nstatic int irq[SNDRV_CARDS] = SNDRV_DEFAULT_IRQ;\t \nstatic int mpu_irq[SNDRV_CARDS] = SNDRV_DEFAULT_IRQ;\t \nstatic int dma1[SNDRV_CARDS] = SNDRV_DEFAULT_DMA;\t \nstatic int dma2[SNDRV_CARDS] = SNDRV_DEFAULT_DMA;\t \n\nmodule_param_array(index, int, NULL, 0444);\nMODULE_PARM_DESC(index, \"Index value for azt2320 based soundcard.\");\nmodule_param_array(id, charp, NULL, 0444);\nMODULE_PARM_DESC(id, \"ID string for azt2320 based soundcard.\");\nmodule_param_array(enable, bool, NULL, 0444);\nMODULE_PARM_DESC(enable, \"Enable azt2320 based soundcard.\");\n\nstruct snd_card_azt2320 {\n\tint dev_no;\n\tstruct pnp_dev *dev;\n\tstruct pnp_dev *devmpu;\n\tstruct snd_wss *chip;\n};\n\nstatic const struct pnp_card_device_id snd_azt2320_pnpids[] = {\n\t \n\t{ .id = \"AZT1008\", .devs = { { \"AZT1008\" }, { \"AZT2001\" }, } },\n\t \n\t{ .id = \"AZT2320\", .devs = { { \"AZT0001\" }, { \"AZT0002\" }, } },\n\t \n\t{ .id = \"AZT3000\", .devs = { { \"AZT1003\" }, { \"AZT2001\" }, } },\n\t \n\t{ .id = \"AZT3002\", .devs = { { \"AZT1004\" }, { \"AZT2001\" }, } },\n\t \n\t{ .id = \"AZT3005\", .devs = { { \"AZT1003\" }, { \"AZT2001\" }, } },\n\t \n\t{ .id = \"AZT3011\", .devs = { { \"AZT1003\" }, { \"AZT2001\" }, } },\n\t{ .id = \"\" }\t \n};\n\nMODULE_DEVICE_TABLE(pnp_card, snd_azt2320_pnpids);\n\n#define\tDRIVER_NAME\t\"snd-card-azt2320\"\n\nstatic int snd_card_azt2320_pnp(int dev, struct snd_card_azt2320 *acard,\n\t\t\t\tstruct pnp_card_link *card,\n\t\t\t\tconst struct pnp_card_device_id *id)\n{\n\tstruct pnp_dev *pdev;\n\tint err;\n\n\tacard->dev = pnp_request_card_device(card, id->devs[0].id, NULL);\n\tif (acard->dev == NULL)\n\t\treturn -ENODEV;\n\n\tacard->devmpu = pnp_request_card_device(card, id->devs[1].id, NULL);\n\n\tpdev = acard->dev;\n\n\terr = pnp_activate_dev(pdev);\n\tif (err < 0) {\n\t\tsnd_printk(KERN_ERR PFX \"AUDIO pnp configure failure\\n\");\n\t\treturn err;\n\t}\n\tport[dev] = pnp_port_start(pdev, 0);\n\tfm_port[dev] = pnp_port_start(pdev, 1);\n\twss_port[dev] = pnp_port_start(pdev, 2);\n\tdma1[dev] = pnp_dma(pdev, 0);\n\tdma2[dev] = pnp_dma(pdev, 1);\n\tirq[dev] = pnp_irq(pdev, 0);\n\n\tpdev = acard->devmpu;\n\tif (pdev != NULL) {\n\t\terr = pnp_activate_dev(pdev);\n\t\tif (err < 0)\n\t\t\tgoto __mpu_error;\n\t\tmpu_port[dev] = pnp_port_start(pdev, 0);\n\t\tmpu_irq[dev] = pnp_irq(pdev, 0);\n\t} else {\n\t     __mpu_error:\n\t     \tif (pdev) {\n\t\t     \tpnp_release_card_device(pdev);\n\t     \t\tsnd_printk(KERN_ERR PFX \"MPU401 pnp configure failure, skipping\\n\");\n\t     \t}\n\t     \tacard->devmpu = NULL;\n\t     \tmpu_port[dev] = -1;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int snd_card_azt2320_command(unsigned long port, unsigned char val)\n{\n\tint i;\n\tunsigned long limit;\n\n\tlimit = jiffies + HZ / 10;\n\tfor (i = 50000; i && time_after(limit, jiffies); i--)\n\t\tif (!(inb(port + 0x0c) & 0x80)) {\n\t\t\toutb(val, port + 0x0c);\n\t\t\treturn 0;\n\t\t}\n\treturn -EBUSY;\n}\n\nstatic int snd_card_azt2320_enable_wss(unsigned long port)\n{\n\tint error;\n\n\terror = snd_card_azt2320_command(port, 0x09);\n\tif (error)\n\t\treturn error;\n\terror = snd_card_azt2320_command(port, 0x00);\n\tif (error)\n\t\treturn error;\n\n\tmdelay(5);\n\treturn 0;\n}\n\nstatic int snd_card_azt2320_probe(int dev,\n\t\t\t\t  struct pnp_card_link *pcard,\n\t\t\t\t  const struct pnp_card_device_id *pid)\n{\n\tint error;\n\tstruct snd_card *card;\n\tstruct snd_card_azt2320 *acard;\n\tstruct snd_wss *chip;\n\tstruct snd_opl3 *opl3;\n\n\terror = snd_devm_card_new(&pcard->card->dev,\n\t\t\t\t  index[dev], id[dev], THIS_MODULE,\n\t\t\t\t  sizeof(struct snd_card_azt2320), &card);\n\tif (error < 0)\n\t\treturn error;\n\tacard = card->private_data;\n\n\terror = snd_card_azt2320_pnp(dev, acard, pcard, pid);\n\tif (error)\n\t\treturn error;\n\n\terror = snd_card_azt2320_enable_wss(port[dev]);\n\tif (error)\n\t\treturn error;\n\n\terror = snd_wss_create(card, wss_port[dev], -1,\n\t\t\t       irq[dev],\n\t\t\t       dma1[dev], dma2[dev],\n\t\t\t       WSS_HW_DETECT, 0, &chip);\n\tif (error < 0)\n\t\treturn error;\n\n\tstrcpy(card->driver, \"AZT2320\");\n\tstrcpy(card->shortname, \"Aztech AZT2320\");\n\tsprintf(card->longname, \"%s, WSS at 0x%lx, irq %i, dma %i&%i\",\n\t\tcard->shortname, chip->port, irq[dev], dma1[dev], dma2[dev]);\n\n\terror = snd_wss_pcm(chip, 0);\n\tif (error < 0)\n\t\treturn error;\n\terror = snd_wss_mixer(chip);\n\tif (error < 0)\n\t\treturn error;\n\terror = snd_wss_timer(chip, 0);\n\tif (error < 0)\n\t\treturn error;\n\n\tif (mpu_port[dev] > 0 && mpu_port[dev] != SNDRV_AUTO_PORT) {\n\t\tif (snd_mpu401_uart_new(card, 0, MPU401_HW_AZT2320,\n\t\t\t\tmpu_port[dev], 0,\n\t\t\t\tmpu_irq[dev], NULL) < 0)\n\t\t\tsnd_printk(KERN_ERR PFX \"no MPU-401 device at 0x%lx\\n\", mpu_port[dev]);\n\t}\n\n\tif (fm_port[dev] > 0 && fm_port[dev] != SNDRV_AUTO_PORT) {\n\t\tif (snd_opl3_create(card,\n\t\t\t\t    fm_port[dev], fm_port[dev] + 2,\n\t\t\t\t    OPL3_HW_AUTO, 0, &opl3) < 0) {\n\t\t\tsnd_printk(KERN_ERR PFX \"no OPL device at 0x%lx-0x%lx\\n\",\n\t\t\t\t   fm_port[dev], fm_port[dev] + 2);\n\t\t} else {\n\t\t\terror = snd_opl3_timer_new(opl3, 1, 2);\n\t\t\tif (error < 0)\n\t\t\t\treturn error;\n\t\t\terror = snd_opl3_hwdep_new(opl3, 0, 1, NULL);\n\t\t\tif (error < 0)\n\t\t\t\treturn error;\n\t\t}\n\t}\n\n\terror = snd_card_register(card);\n\tif (error < 0)\n\t\treturn error;\n\tpnp_set_card_drvdata(pcard, card);\n\treturn 0;\n}\n\nstatic unsigned int azt2320_devices;\n\nstatic int snd_azt2320_pnp_detect(struct pnp_card_link *card,\n\t\t\t\t  const struct pnp_card_device_id *id)\n{\n\tstatic int dev;\n\tint res;\n\n\tfor ( ; dev < SNDRV_CARDS; dev++) {\n\t\tif (!enable[dev])\n\t\t\tcontinue;\n\t\tres = snd_card_azt2320_probe(dev, card, id);\n\t\tif (res < 0)\n\t\t\treturn res;\n\t\tdev++;\n\t\tazt2320_devices++;\n\t\treturn 0;\n\t}\n        return -ENODEV;\n}\n\n#ifdef CONFIG_PM\nstatic int snd_azt2320_pnp_suspend(struct pnp_card_link *pcard, pm_message_t state)\n{\n\tstruct snd_card *card = pnp_get_card_drvdata(pcard);\n\tstruct snd_card_azt2320 *acard = card->private_data;\n\tstruct snd_wss *chip = acard->chip;\n\n\tsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\n\tchip->suspend(chip);\n\treturn 0;\n}\n\nstatic int snd_azt2320_pnp_resume(struct pnp_card_link *pcard)\n{\n\tstruct snd_card *card = pnp_get_card_drvdata(pcard);\n\tstruct snd_card_azt2320 *acard = card->private_data;\n\tstruct snd_wss *chip = acard->chip;\n\n\tchip->resume(chip);\n\tsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\n\treturn 0;\n}\n#endif\n\nstatic struct pnp_card_driver azt2320_pnpc_driver = {\n\t.flags          = PNP_DRIVER_RES_DISABLE,\n\t.name           = \"azt2320\",\n\t.id_table       = snd_azt2320_pnpids,\n\t.probe          = snd_azt2320_pnp_detect,\n#ifdef CONFIG_PM\n\t.suspend\t= snd_azt2320_pnp_suspend,\n\t.resume\t\t= snd_azt2320_pnp_resume,\n#endif\n};\n\nstatic int __init alsa_card_azt2320_init(void)\n{\n\tint err;\n\n\terr = pnp_register_card_driver(&azt2320_pnpc_driver);\n\tif (err)\n\t\treturn err;\n\n\tif (!azt2320_devices) {\n\t\tpnp_unregister_card_driver(&azt2320_pnpc_driver);\n#ifdef MODULE\n\t\tsnd_printk(KERN_ERR \"no AZT2320 based soundcards found\\n\");\n#endif\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\n\nstatic void __exit alsa_card_azt2320_exit(void)\n{\n\tpnp_unregister_card_driver(&azt2320_pnpc_driver);\n}\n\nmodule_init(alsa_card_azt2320_init)\nmodule_exit(alsa_card_azt2320_exit)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}