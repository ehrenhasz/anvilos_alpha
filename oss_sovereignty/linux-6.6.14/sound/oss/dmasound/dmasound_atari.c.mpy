{
  "module_name": "dmasound_atari.c",
  "hash_id": "cc26ed47708b8a561fdcb03ee9922f96ca53c8d9520af294ede75e77ce3dc4eb",
  "original_prompt": "Ingested from linux-6.6.14/sound/oss/dmasound/dmasound_atari.c",
  "human_readable_source": "\n \n\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/soundcard.h>\n#include <linux/mm.h>\n#include <linux/spinlock.h>\n#include <linux/interrupt.h>\n\n#include <linux/uaccess.h>\n#include <asm/atariints.h>\n#include <asm/atari_stram.h>\n\n#include \"dmasound.h\"\n\n#define DMASOUND_ATARI_REVISION 0\n#define DMASOUND_ATARI_EDITION 3\n\nextern void atari_microwire_cmd(int cmd);\n\nstatic int is_falcon;\nstatic int write_sq_ignore_int;\t \n\nstatic int expand_bal;\t \nstatic int expand_data;\t \n\n\n \n\n\n \n\nstatic ssize_t ata_ct_law(const u_char __user *userPtr, size_t userCount,\n\t\t\t  u_char frame[], ssize_t *frameUsed,\n\t\t\t  ssize_t frameLeft);\nstatic ssize_t ata_ct_s8(const u_char __user *userPtr, size_t userCount,\n\t\t\t u_char frame[], ssize_t *frameUsed,\n\t\t\t ssize_t frameLeft);\nstatic ssize_t ata_ct_u8(const u_char __user *userPtr, size_t userCount,\n\t\t\t u_char frame[], ssize_t *frameUsed,\n\t\t\t ssize_t frameLeft);\nstatic ssize_t ata_ct_s16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft);\nstatic ssize_t ata_ct_u16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft);\nstatic ssize_t ata_ct_s16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft);\nstatic ssize_t ata_ct_u16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft);\nstatic ssize_t ata_ctx_law(const u_char __user *userPtr, size_t userCount,\n\t\t\t   u_char frame[], ssize_t *frameUsed,\n\t\t\t   ssize_t frameLeft);\nstatic ssize_t ata_ctx_s8(const u_char __user *userPtr, size_t userCount,\n\t\t\t  u_char frame[], ssize_t *frameUsed,\n\t\t\t  ssize_t frameLeft);\nstatic ssize_t ata_ctx_u8(const u_char __user *userPtr, size_t userCount,\n\t\t\t  u_char frame[], ssize_t *frameUsed,\n\t\t\t  ssize_t frameLeft);\nstatic ssize_t ata_ctx_s16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft);\nstatic ssize_t ata_ctx_u16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft);\nstatic ssize_t ata_ctx_s16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft);\nstatic ssize_t ata_ctx_u16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft);\n\n\n \n\n\nstatic void *AtaAlloc(unsigned int size, gfp_t flags);\nstatic void AtaFree(void *, unsigned int size);\nstatic int AtaIrqInit(void);\n#ifdef MODULE\nstatic void AtaIrqCleanUp(void);\n#endif  \nstatic int AtaSetBass(int bass);\nstatic int AtaSetTreble(int treble);\nstatic void TTSilence(void);\nstatic void TTInit(void);\nstatic int TTSetFormat(int format);\nstatic int TTSetVolume(int volume);\nstatic int TTSetGain(int gain);\nstatic void FalconSilence(void);\nstatic void FalconInit(void);\nstatic int FalconSetFormat(int format);\nstatic int FalconSetVolume(int volume);\nstatic void AtaPlayNextFrame(int index);\nstatic void AtaPlay(void);\nstatic irqreturn_t AtaInterrupt(int irq, void *dummy);\n\n \n\nstatic void TTMixerInit(void);\nstatic void FalconMixerInit(void);\nstatic int AtaMixerIoctl(u_int cmd, u_long arg);\nstatic int TTMixerIoctl(u_int cmd, u_long arg);\nstatic int FalconMixerIoctl(u_int cmd, u_long arg);\nstatic int AtaWriteSqSetup(void);\nstatic int AtaSqOpen(fmode_t mode);\nstatic int TTStateInfo(char *buffer, size_t space);\nstatic int FalconStateInfo(char *buffer, size_t space);\n\n\n \n\n\nstatic ssize_t ata_ct_law(const u_char __user *userPtr, size_t userCount,\n\t\t\t  u_char frame[], ssize_t *frameUsed,\n\t\t\t  ssize_t frameLeft)\n{\n\tchar *table = dmasound.soft.format == AFMT_MU_LAW ? dmasound_ulaw2dma8\n\t\t\t\t\t\t\t  : dmasound_alaw2dma8;\n\tssize_t count, used;\n\tu_char *p = &frame[*frameUsed];\n\n\tcount = min_t(unsigned long, userCount, frameLeft);\n\tif (dmasound.soft.stereo)\n\t\tcount &= ~1;\n\tused = count;\n\twhile (count > 0) {\n\t\tu_char data;\n\t\tif (get_user(data, userPtr++))\n\t\t\treturn -EFAULT;\n\t\t*p++ = table[data];\n\t\tcount--;\n\t}\n\t*frameUsed += used;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ct_s8(const u_char __user *userPtr, size_t userCount,\n\t\t\t u_char frame[], ssize_t *frameUsed,\n\t\t\t ssize_t frameLeft)\n{\n\tssize_t count, used;\n\tvoid *p = &frame[*frameUsed];\n\n\tcount = min_t(unsigned long, userCount, frameLeft);\n\tif (dmasound.soft.stereo)\n\t\tcount &= ~1;\n\tused = count;\n\tif (copy_from_user(p, userPtr, count))\n\t\treturn -EFAULT;\n\t*frameUsed += used;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ct_u8(const u_char __user *userPtr, size_t userCount,\n\t\t\t u_char frame[], ssize_t *frameUsed,\n\t\t\t ssize_t frameLeft)\n{\n\tssize_t count, used;\n\n\tif (!dmasound.soft.stereo) {\n\t\tu_char *p = &frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft);\n\t\tused = count;\n\t\twhile (count > 0) {\n\t\t\tu_char data;\n\t\t\tif (get_user(data, userPtr++))\n\t\t\t\treturn -EFAULT;\n\t\t\t*p++ = data ^ 0x80;\n\t\t\tcount--;\n\t\t}\n\t} else {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>1;\n\t\tused = count*2;\n\t\twhile (count > 0) {\n\t\t\tu_short data;\n\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 2;\n\t\t\t*p++ = data ^ 0x8080;\n\t\t\tcount--;\n\t\t}\n\t}\n\t*frameUsed += used;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ct_s16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft)\n{\n\tssize_t count, used;\n\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>1;\n\t\tused = count*2;\n\t\twhile (count > 0) {\n\t\t\tu_short data;\n\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 2;\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tcount--;\n\t\t}\n\t\t*frameUsed += used*2;\n\t} else {\n\t\tvoid *p = (u_short *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft) & ~3;\n\t\tused = count;\n\t\tif (copy_from_user(p, userPtr, count))\n\t\t\treturn -EFAULT;\n\t\t*frameUsed += used;\n\t}\n\treturn used;\n}\n\n\nstatic ssize_t ata_ct_u16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft)\n{\n\tssize_t count, used;\n\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>1;\n\t\tused = count*2;\n\t\twhile (count > 0) {\n\t\t\tu_short data;\n\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 2;\n\t\t\tdata ^= 0x8000;\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tcount--;\n\t\t}\n\t\t*frameUsed += used*2;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>2;\n\t\tused = count*4;\n\t\twhile (count > 0) {\n\t\t\tu_int data;\n\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 4;\n\t\t\t*p++ = data ^ 0x80008000;\n\t\t\tcount--;\n\t\t}\n\t\t*frameUsed += used;\n\t}\n\treturn used;\n}\n\n\nstatic ssize_t ata_ct_s16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft)\n{\n\tssize_t count, used;\n\n\tcount = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>1;\n\t\tused = count*2;\n\t\twhile (count > 0) {\n\t\t\tu_short data;\n\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 2;\n\t\t\tdata = le2be16(data);\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tcount--;\n\t\t}\n\t\t*frameUsed += used*2;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>2;\n\t\tused = count*4;\n\t\twhile (count > 0) {\n\t\t\tu_long data;\n\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 4;\n\t\t\tdata = le2be16dbl(data);\n\t\t\t*p++ = data;\n\t\t\tcount--;\n\t\t}\n\t\t*frameUsed += used;\n\t}\n\treturn used;\n}\n\n\nstatic ssize_t ata_ct_u16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t    u_char frame[], ssize_t *frameUsed,\n\t\t\t    ssize_t frameLeft)\n{\n\tssize_t count, used;\n\n\tcount = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>1;\n\t\tused = count*2;\n\t\twhile (count > 0) {\n\t\t\tu_short data;\n\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 2;\n\t\t\tdata = le2be16(data) ^ 0x8000;\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t}\n\t\t*frameUsed += used*2;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tcount = min_t(unsigned long, userCount, frameLeft)>>2;\n\t\tused = count;\n\t\twhile (count > 0) {\n\t\t\tu_long data;\n\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\treturn -EFAULT;\n\t\t\tuserPtr += 4;\n\t\t\tdata = le2be16dbl(data) ^ 0x80008000;\n\t\t\t*p++ = data;\n\t\t\tcount--;\n\t\t}\n\t\t*frameUsed += used;\n\t}\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_law(const u_char __user *userPtr, size_t userCount,\n\t\t\t   u_char frame[], ssize_t *frameUsed,\n\t\t\t   ssize_t frameLeft)\n{\n\tchar *table = dmasound.soft.format == AFMT_MU_LAW ? dmasound_ulaw2dma8\n\t\t\t\t\t\t\t  : dmasound_alaw2dma8;\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_char *p = &frame[*frameUsed];\n\t\tu_char data = expand_data;\n\t\twhile (frameLeft) {\n\t\t\tu_char c;\n\t\t\tif (bal < 0) {\n\t\t\t\tif (!userCount)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(c, userPtr++))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tdata = table[c];\n\t\t\t\tuserCount--;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft--;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 2) {\n\t\t\tu_char c;\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(c, userPtr++))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tdata = table[c] << 8;\n\t\t\t\tif (get_user(c, userPtr++))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tdata |= table[c];\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 2;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_s8(const u_char __user *userPtr, size_t userCount,\n\t\t\t  u_char frame[], ssize_t *frameUsed,\n\t\t\t  ssize_t frameLeft)\n{\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_char *p = &frame[*frameUsed];\n\t\tu_char data = expand_data;\n\t\twhile (frameLeft) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (!userCount)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, userPtr++))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserCount--;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft--;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 2) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 2;\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 2;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_u8(const u_char __user *userPtr, size_t userCount,\n\t\t\t  u_char frame[], ssize_t *frameUsed,\n\t\t\t  ssize_t frameLeft)\n{\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_char *p = &frame[*frameUsed];\n\t\tu_char data = expand_data;\n\t\twhile (frameLeft) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (!userCount)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, userPtr++))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tdata ^= 0x80;\n\t\t\t\tuserCount--;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft--;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 2) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 2;\n\t\t\t\tdata ^= 0x8080;\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 2;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_s16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft)\n{\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 2;\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tu_long data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 4)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 4;\n\t\t\t\tuserCount -= 4;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_u16be(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft)\n{\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 2;\n\t\t\t\tdata ^= 0x8000;\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tu_long data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 4)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 4;\n\t\t\t\tdata ^= 0x80008000;\n\t\t\t\tuserCount -= 4;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_s16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft)\n{\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 2;\n\t\t\t\tdata = le2be16(data);\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tu_long data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 4)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 4;\n\t\t\t\tdata = le2be16dbl(data);\n\t\t\t\tuserCount -= 4;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic ssize_t ata_ctx_u16le(const u_char __user *userPtr, size_t userCount,\n\t\t\t     u_char frame[], ssize_t *frameUsed,\n\t\t\t     ssize_t frameLeft)\n{\n\t \n\tlong bal = expand_bal;\n\tlong hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\n\tssize_t used, usedf;\n\n\tused = userCount;\n\tusedf = frameLeft;\n\tif (!dmasound.soft.stereo) {\n\t\tu_short *p = (u_short *)&frame[*frameUsed];\n\t\tu_short data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 2)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_short __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 2;\n\t\t\t\tdata = le2be16(data) ^ 0x8000;\n\t\t\t\tuserCount -= 2;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t} else {\n\t\tu_long *p = (u_long *)&frame[*frameUsed];\n\t\tu_long data = expand_data;\n\t\twhile (frameLeft >= 4) {\n\t\t\tif (bal < 0) {\n\t\t\t\tif (userCount < 4)\n\t\t\t\t\tbreak;\n\t\t\t\tif (get_user(data, (u_int __user *)userPtr))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tuserPtr += 4;\n\t\t\t\tdata = le2be16dbl(data) ^ 0x80008000;\n\t\t\t\tuserCount -= 4;\n\t\t\t\tbal += hSpeed;\n\t\t\t}\n\t\t\t*p++ = data;\n\t\t\tframeLeft -= 4;\n\t\t\tbal -= sSpeed;\n\t\t}\n\t\texpand_data = data;\n\t}\n\texpand_bal = bal;\n\tused -= userCount;\n\t*frameUsed += usedf-frameLeft;\n\treturn used;\n}\n\n\nstatic TRANS transTTNormal = {\n\t.ct_ulaw\t= ata_ct_law,\n\t.ct_alaw\t= ata_ct_law,\n\t.ct_s8\t\t= ata_ct_s8,\n\t.ct_u8\t\t= ata_ct_u8,\n};\n\nstatic TRANS transTTExpanding = {\n\t.ct_ulaw\t= ata_ctx_law,\n\t.ct_alaw\t= ata_ctx_law,\n\t.ct_s8\t\t= ata_ctx_s8,\n\t.ct_u8\t\t= ata_ctx_u8,\n};\n\nstatic TRANS transFalconNormal = {\n\t.ct_ulaw\t= ata_ct_law,\n\t.ct_alaw\t= ata_ct_law,\n\t.ct_s8\t\t= ata_ct_s8,\n\t.ct_u8\t\t= ata_ct_u8,\n\t.ct_s16be\t= ata_ct_s16be,\n\t.ct_u16be\t= ata_ct_u16be,\n\t.ct_s16le\t= ata_ct_s16le,\n\t.ct_u16le\t= ata_ct_u16le\n};\n\nstatic TRANS transFalconExpanding = {\n\t.ct_ulaw\t= ata_ctx_law,\n\t.ct_alaw\t= ata_ctx_law,\n\t.ct_s8\t\t= ata_ctx_s8,\n\t.ct_u8\t\t= ata_ctx_u8,\n\t.ct_s16be\t= ata_ctx_s16be,\n\t.ct_u16be\t= ata_ctx_u16be,\n\t.ct_s16le\t= ata_ctx_s16le,\n\t.ct_u16le\t= ata_ctx_u16le,\n};\n\n\n \n\n\n\n \n\nstatic void *AtaAlloc(unsigned int size, gfp_t flags)\n{\n\treturn atari_stram_alloc(size, \"dmasound\");\n}\n\nstatic void AtaFree(void *obj, unsigned int size)\n{\n\tatari_stram_free( obj );\n}\n\nstatic int __init AtaIrqInit(void)\n{\n\t \n\tst_mfp.tim_ct_a = 0;\t \n\tst_mfp.tim_dt_a = 1;\t \n\tst_mfp.tim_ct_a = 8;\t \n\t \n\tif (request_irq(IRQ_MFP_TIMA, AtaInterrupt, 0, \"DMA sound\",\n\t\t\tAtaInterrupt))\n\t\treturn 0;\n\tst_mfp.int_en_a |= 0x20;\t \n\tst_mfp.int_mk_a |= 0x20;\n\treturn 1;\n}\n\n#ifdef MODULE\nstatic void AtaIrqCleanUp(void)\n{\n\tst_mfp.tim_ct_a = 0;\t\t \n\tst_mfp.int_en_a &= ~0x20;\t \n\tfree_irq(IRQ_MFP_TIMA, AtaInterrupt);\n}\n#endif  \n\n\n#define TONE_VOXWARE_TO_DB(v) \\\n\t(((v) < 0) ? -12 : ((v) > 100) ? 12 : ((v) - 50) * 6 / 25)\n#define TONE_DB_TO_VOXWARE(v) (((v) * 25 + ((v) > 0 ? 5 : -5)) / 6 + 50)\n\n\nstatic int AtaSetBass(int bass)\n{\n\tdmasound.bass = TONE_VOXWARE_TO_DB(bass);\n\tatari_microwire_cmd(MW_LM1992_BASS(dmasound.bass));\n\treturn TONE_DB_TO_VOXWARE(dmasound.bass);\n}\n\n\nstatic int AtaSetTreble(int treble)\n{\n\tdmasound.treble = TONE_VOXWARE_TO_DB(treble);\n\tatari_microwire_cmd(MW_LM1992_TREBLE(dmasound.treble));\n\treturn TONE_DB_TO_VOXWARE(dmasound.treble);\n}\n\n\n\n \n\n\nstatic void TTSilence(void)\n{\n\ttt_dmasnd.ctrl = DMASND_CTRL_OFF;\n\tatari_microwire_cmd(MW_LM1992_PSG_HIGH);  \n}\n\n\nstatic void TTInit(void)\n{\n\tint mode, i, idx;\n\tconst int freq[4] = {50066, 25033, 12517, 6258};\n\n\t \n\n\tidx = -1;\n\tfor (i = 0; i < ARRAY_SIZE(freq); i++)\n\t\t \n\t\tif ((100 * abs(dmasound.soft.speed - freq[i]) / freq[i]) < catchRadius)\n\t\t\tidx = i;\n\tif (idx > -1) {\n\t\tdmasound.soft.speed = freq[idx];\n\t\tdmasound.trans_write = &transTTNormal;\n\t} else\n\t\tdmasound.trans_write = &transTTExpanding;\n\n\tTTSilence();\n\tdmasound.hard = dmasound.soft;\n\n\tif (dmasound.hard.speed > 50066) {\n\t\t \n\t\tdmasound.hard.speed = 50066;\n\t\tmode = DMASND_MODE_50KHZ;\n\t\tdmasound.trans_write = &transTTNormal;\n\t} else if (dmasound.hard.speed > 25033) {\n\t\tdmasound.hard.speed = 50066;\n\t\tmode = DMASND_MODE_50KHZ;\n\t} else if (dmasound.hard.speed > 12517) {\n\t\tdmasound.hard.speed = 25033;\n\t\tmode = DMASND_MODE_25KHZ;\n\t} else if (dmasound.hard.speed > 6258) {\n\t\tdmasound.hard.speed = 12517;\n\t\tmode = DMASND_MODE_12KHZ;\n\t} else {\n\t\tdmasound.hard.speed = 6258;\n\t\tmode = DMASND_MODE_6KHZ;\n\t}\n\n\ttt_dmasnd.mode = (dmasound.hard.stereo ?\n\t\t\t  DMASND_MODE_STEREO : DMASND_MODE_MONO) |\n\t\tDMASND_MODE_8BIT | mode;\n\n\texpand_bal = -dmasound.soft.speed;\n}\n\n\nstatic int TTSetFormat(int format)\n{\n\t \n\n\tswitch (format) {\n\tcase AFMT_QUERY:\n\t\treturn dmasound.soft.format;\n\tcase AFMT_MU_LAW:\n\tcase AFMT_A_LAW:\n\tcase AFMT_S8:\n\tcase AFMT_U8:\n\t\tbreak;\n\tdefault:\n\t\tformat = AFMT_S8;\n\t}\n\n\tdmasound.soft.format = format;\n\tdmasound.soft.size = 8;\n\tif (dmasound.minDev == SND_DEV_DSP) {\n\t\tdmasound.dsp.format = format;\n\t\tdmasound.dsp.size = 8;\n\t}\n\tTTInit();\n\n\treturn format;\n}\n\n\n#define VOLUME_VOXWARE_TO_DB(v) \\\n\t(((v) < 0) ? -40 : ((v) > 100) ? 0 : ((v) * 2) / 5 - 40)\n#define VOLUME_DB_TO_VOXWARE(v) ((((v) + 40) * 5 + 1) / 2)\n\n\nstatic int TTSetVolume(int volume)\n{\n\tdmasound.volume_left = VOLUME_VOXWARE_TO_DB(volume & 0xff);\n\tatari_microwire_cmd(MW_LM1992_BALLEFT(dmasound.volume_left));\n\tdmasound.volume_right = VOLUME_VOXWARE_TO_DB((volume & 0xff00) >> 8);\n\tatari_microwire_cmd(MW_LM1992_BALRIGHT(dmasound.volume_right));\n\treturn VOLUME_DB_TO_VOXWARE(dmasound.volume_left) |\n\t       (VOLUME_DB_TO_VOXWARE(dmasound.volume_right) << 8);\n}\n\n\n#define GAIN_VOXWARE_TO_DB(v) \\\n\t(((v) < 0) ? -80 : ((v) > 100) ? 0 : ((v) * 4) / 5 - 80)\n#define GAIN_DB_TO_VOXWARE(v) ((((v) + 80) * 5 + 1) / 4)\n\nstatic int TTSetGain(int gain)\n{\n\tdmasound.gain = GAIN_VOXWARE_TO_DB(gain);\n\tatari_microwire_cmd(MW_LM1992_VOLUME(dmasound.gain));\n\treturn GAIN_DB_TO_VOXWARE(dmasound.gain);\n}\n\n\n\n \n\n\nstatic void FalconSilence(void)\n{\n\t \n\ttt_dmasnd.ctrl = DMASND_CTRL_OFF;\n\ttt_dmasnd.mode = DMASND_MODE_50KHZ | DMASND_MODE_STEREO | DMASND_MODE_8BIT;\n\ttt_dmasnd.int_div = 0;  \n\ttt_dmasnd.int_ctrl = 0x0;\n\ttt_dmasnd.cbar_src = 0x0000;  \n\ttt_dmasnd.cbar_dst = 0x0000;  \n\ttt_dmasnd.dac_src = 1;  \n\ttt_dmasnd.adc_src = 3;  \n}\n\n\nstatic void FalconInit(void)\n{\n\tint divider, i, idx;\n\tconst int freq[8] = {49170, 32780, 24585, 19668, 16390, 12292, 9834, 8195};\n\n\t \n\n\tidx = -1;\n\tfor (i = 0; i < ARRAY_SIZE(freq); i++)\n\t\t \n\t\tif ((100 * abs(dmasound.soft.speed - freq[i]) / freq[i]) < catchRadius)\n\t\t\tidx = i;\n\tif (idx > -1) {\n\t\tdmasound.soft.speed = freq[idx];\n\t\tdmasound.trans_write = &transFalconNormal;\n\t} else\n\t\tdmasound.trans_write = &transFalconExpanding;\n\n\tFalconSilence();\n\tdmasound.hard = dmasound.soft;\n\n\tif (dmasound.hard.size == 16) {\n\t\t \n\t\tdmasound.hard.stereo = 1;\n\t}\n\n\tif (dmasound.hard.speed > 49170) {\n\t\t \n\t\tdmasound.hard.speed = 49170;\n\t\tdivider = 1;\n\t\tdmasound.trans_write = &transFalconNormal;\n\t} else if (dmasound.hard.speed > 32780) {\n\t\tdmasound.hard.speed = 49170;\n\t\tdivider = 1;\n\t} else if (dmasound.hard.speed > 24585) {\n\t\tdmasound.hard.speed = 32780;\n\t\tdivider = 2;\n\t} else if (dmasound.hard.speed > 19668) {\n\t\tdmasound.hard.speed = 24585;\n\t\tdivider = 3;\n\t} else if (dmasound.hard.speed > 16390) {\n\t\tdmasound.hard.speed = 19668;\n\t\tdivider = 4;\n\t} else if (dmasound.hard.speed > 12292) {\n\t\tdmasound.hard.speed = 16390;\n\t\tdivider = 5;\n\t} else if (dmasound.hard.speed > 9834) {\n\t\tdmasound.hard.speed = 12292;\n\t\tdivider = 7;\n\t} else if (dmasound.hard.speed > 8195) {\n\t\tdmasound.hard.speed = 9834;\n\t\tdivider = 9;\n\t} else {\n\t\tdmasound.hard.speed = 8195;\n\t\tdivider = 11;\n\t}\n\ttt_dmasnd.int_div = divider;\n\n\t \n\ttt_dmasnd.int_ctrl = 0x4;  \n\ttt_dmasnd.track_select = 0x0;  \n\ttt_dmasnd.cbar_src = 0x0001;  \n\ttt_dmasnd.cbar_dst = 0x0000;\n\ttt_dmasnd.rec_track_select = 0;\n\ttt_dmasnd.dac_src = 2;  \n\ttt_dmasnd.adc_src = 0;  \n\n\ttt_dmasnd.mode = (dmasound.hard.stereo ?\n\t\t\t  DMASND_MODE_STEREO : DMASND_MODE_MONO) |\n\t\t((dmasound.hard.size == 8) ?\n\t\t DMASND_MODE_8BIT : DMASND_MODE_16BIT) |\n\t\tDMASND_MODE_6KHZ;\n\n\texpand_bal = -dmasound.soft.speed;\n}\n\n\nstatic int FalconSetFormat(int format)\n{\n\tint size;\n\t \n\n\tswitch (format) {\n\tcase AFMT_QUERY:\n\t\treturn dmasound.soft.format;\n\tcase AFMT_MU_LAW:\n\tcase AFMT_A_LAW:\n\tcase AFMT_U8:\n\tcase AFMT_S8:\n\t\tsize = 8;\n\t\tbreak;\n\tcase AFMT_S16_BE:\n\tcase AFMT_U16_BE:\n\tcase AFMT_S16_LE:\n\tcase AFMT_U16_LE:\n\t\tsize = 16;\n\t\tbreak;\n\tdefault:  \n\t\tsize = 8;\n\t\tformat = AFMT_S8;\n\t}\n\n\tdmasound.soft.format = format;\n\tdmasound.soft.size = size;\n\tif (dmasound.minDev == SND_DEV_DSP) {\n\t\tdmasound.dsp.format = format;\n\t\tdmasound.dsp.size = dmasound.soft.size;\n\t}\n\n\tFalconInit();\n\n\treturn format;\n}\n\n\n \n#define VOLUME_VOXWARE_TO_ATT(v) \\\n\t((v) < 0 ? 15 : (v) > 100 ? 0 : 15 - (v) * 3 / 20)\n#define VOLUME_ATT_TO_VOXWARE(v) (100 - (v) * 20 / 3)\n\n\nstatic int FalconSetVolume(int volume)\n{\n\tdmasound.volume_left = VOLUME_VOXWARE_TO_ATT(volume & 0xff);\n\tdmasound.volume_right = VOLUME_VOXWARE_TO_ATT((volume & 0xff00) >> 8);\n\ttt_dmasnd.output_atten = dmasound.volume_left << 8 | dmasound.volume_right << 4;\n\treturn VOLUME_ATT_TO_VOXWARE(dmasound.volume_left) |\n\t       VOLUME_ATT_TO_VOXWARE(dmasound.volume_right) << 8;\n}\n\n\nstatic void AtaPlayNextFrame(int index)\n{\n\tchar *start, *end;\n\n\t \n\tstart = write_sq.buffers[write_sq.front];\n\tend = start+((write_sq.count == index) ? write_sq.rear_size\n\t\t\t\t\t       : write_sq.block_size);\n\t \n\tDMASNDSetEnd(virt_to_phys(end - 1) + 1);\n\tDMASNDSetBase(virt_to_phys(start));\n\t \n\twrite_sq.front = (write_sq.front+1) % write_sq.max_count;\n\twrite_sq.active++;\n\ttt_dmasnd.ctrl = DMASND_CTRL_ON | DMASND_CTRL_REPEAT;\n}\n\n\nstatic void AtaPlay(void)\n{\n\t \n\tatari_disable_irq(IRQ_MFP_TIMA);\n\n\tif (write_sq.active == 2 ||\t \n\t    write_sq.count <= 0) {\t \n\t\tatari_enable_irq(IRQ_MFP_TIMA);\n\t\treturn;\n\t}\n\n\tif (write_sq.active == 0) {\n\t\t \n\t\tif (write_sq.count == 1 &&\n\t\t    write_sq.rear_size < write_sq.block_size &&\n\t\t    !write_sq.syncing) {\n\t\t\t \n\t\t\tatari_enable_irq(IRQ_MFP_TIMA);\n\t\t\treturn;\n\t\t}\n\t\tAtaPlayNextFrame(1);\n\t\tif (write_sq.count == 1) {\n\t\t\t \n\t\t\tatari_enable_irq(IRQ_MFP_TIMA);\n\t\t\treturn;\n\t\t}\n\t\tif (write_sq.count == 2 &&\n\t\t    write_sq.rear_size < write_sq.block_size &&\n\t\t    !write_sq.syncing) {\n\t\t\t \n\t\t\tatari_enable_irq(IRQ_MFP_TIMA);\n\t\t\treturn;\n\t\t}\n\t\tAtaPlayNextFrame(2);\n\t} else {\n\t\t \n\t\tif (write_sq.count == 2 &&\n\t\t    write_sq.rear_size < write_sq.block_size &&\n\t\t    !write_sq.syncing) {\n\t\t\t \n\t\t\tatari_enable_irq(IRQ_MFP_TIMA);\n\t\t\treturn;\n\t\t}\n\t\tAtaPlayNextFrame(2);\n\t}\n\tatari_enable_irq(IRQ_MFP_TIMA);\n}\n\n\nstatic irqreturn_t AtaInterrupt(int irq, void *dummy)\n{\n#if 0\n\t \n\tstatic int cnt;\n\tif (write_sq.active == 2)\n\t\tif (++cnt == 10) {\n\t\t\t \n\t\t\tcnt = 0;\n\t\t\treturn IRQ_HANDLED;\n\t\t}\n#endif\n\tspin_lock(&dmasound.lock);\n\tif (write_sq_ignore_int && is_falcon) {\n\t\t \n\t\twrite_sq_ignore_int = 0;\n\t\tgoto out;\n\t}\n\n\tif (!write_sq.active) {\n\t\t \n\t\tWAKE_UP(write_sq.sync_queue);\n\t\tgoto out;\n\t}\n\n\t \n\twrite_sq.count--;\n\twrite_sq.active--;\n\n\tif (!write_sq.active) {\n\t\ttt_dmasnd.ctrl = DMASND_CTRL_OFF;\n\t\twrite_sq_ignore_int = 1;\n\t}\n\n\tWAKE_UP(write_sq.action_queue);\n\t \n\n\tif ((write_sq.active != 1) || (write_sq.count != 1))\n\t\t \n\t\tAtaPlay();\n\n\tif (!write_sq.active) WAKE_UP(write_sq.sync_queue);\n\t \nout:\n\tspin_unlock(&dmasound.lock);\n\treturn IRQ_HANDLED;\n}\n\n\n \n\n\n \n\n#define RECLEVEL_VOXWARE_TO_GAIN(v)\t\\\n\t((v) < 0 ? 0 : (v) > 100 ? 15 : (v) * 3 / 20)\n#define RECLEVEL_GAIN_TO_VOXWARE(v)\t(((v) * 20 + 2) / 3)\n\n\nstatic void __init TTMixerInit(void)\n{\n\tatari_microwire_cmd(MW_LM1992_VOLUME(0));\n\tdmasound.volume_left = 0;\n\tatari_microwire_cmd(MW_LM1992_BALLEFT(0));\n\tdmasound.volume_right = 0;\n\tatari_microwire_cmd(MW_LM1992_BALRIGHT(0));\n\tatari_microwire_cmd(MW_LM1992_TREBLE(0));\n\tatari_microwire_cmd(MW_LM1992_BASS(0));\n}\n\nstatic void __init FalconMixerInit(void)\n{\n\tdmasound.volume_left = (tt_dmasnd.output_atten & 0xf00) >> 8;\n\tdmasound.volume_right = (tt_dmasnd.output_atten & 0xf0) >> 4;\n}\n\nstatic int AtaMixerIoctl(u_int cmd, u_long arg)\n{\n\tint data;\n\tunsigned long flags;\n\tswitch (cmd) {\n\t    case SOUND_MIXER_READ_SPEAKER:\n\t\t    if (is_falcon || MACH_IS_TT) {\n\t\t\t    int porta;\n\t\t\t    spin_lock_irqsave(&dmasound.lock, flags);\n\t\t\t    sound_ym.rd_data_reg_sel = 14;\n\t\t\t    porta = sound_ym.rd_data_reg_sel;\n\t\t\t    spin_unlock_irqrestore(&dmasound.lock, flags);\n\t\t\t    return IOCTL_OUT(arg, porta & 0x40 ? 0 : 100);\n\t\t    }\n\t\t    break;\n\t    case SOUND_MIXER_WRITE_VOLUME:\n\t\t    IOCTL_IN(arg, data);\n\t\t    return IOCTL_OUT(arg, dmasound_set_volume(data));\n\t    case SOUND_MIXER_WRITE_SPEAKER:\n\t\t    if (is_falcon || MACH_IS_TT) {\n\t\t\t    int porta;\n\t\t\t    IOCTL_IN(arg, data);\n\t\t\t    spin_lock_irqsave(&dmasound.lock, flags);\n\t\t\t    sound_ym.rd_data_reg_sel = 14;\n\t\t\t    porta = (sound_ym.rd_data_reg_sel & ~0x40) |\n\t\t\t\t    (data < 50 ? 0x40 : 0);\n\t\t\t    sound_ym.wd_data = porta;\n\t\t\t    spin_unlock_irqrestore(&dmasound.lock, flags);\n\t\t\t    return IOCTL_OUT(arg, porta & 0x40 ? 0 : 100);\n\t\t    }\n\t}\n\treturn -EINVAL;\n}\n\n\nstatic int TTMixerIoctl(u_int cmd, u_long arg)\n{\n\tint data;\n\tswitch (cmd) {\n\t    case SOUND_MIXER_READ_RECMASK:\n\t\treturn IOCTL_OUT(arg, 0);\n\t    case SOUND_MIXER_READ_DEVMASK:\n\t\treturn IOCTL_OUT(arg,\n\t\t\t\t SOUND_MASK_VOLUME | SOUND_MASK_TREBLE | SOUND_MASK_BASS |\n\t\t\t\t (MACH_IS_TT ? SOUND_MASK_SPEAKER : 0));\n\t    case SOUND_MIXER_READ_STEREODEVS:\n\t\treturn IOCTL_OUT(arg, SOUND_MASK_VOLUME);\n\t    case SOUND_MIXER_READ_VOLUME:\n\t\treturn IOCTL_OUT(arg,\n\t\t\t\t VOLUME_DB_TO_VOXWARE(dmasound.volume_left) |\n\t\t\t\t (VOLUME_DB_TO_VOXWARE(dmasound.volume_right) << 8));\n\t    case SOUND_MIXER_READ_BASS:\n\t\treturn IOCTL_OUT(arg, TONE_DB_TO_VOXWARE(dmasound.bass));\n\t    case SOUND_MIXER_READ_TREBLE:\n\t\treturn IOCTL_OUT(arg, TONE_DB_TO_VOXWARE(dmasound.treble));\n\t    case SOUND_MIXER_READ_OGAIN:\n\t\treturn IOCTL_OUT(arg, GAIN_DB_TO_VOXWARE(dmasound.gain));\n\t    case SOUND_MIXER_WRITE_BASS:\n\t\tIOCTL_IN(arg, data);\n\t\treturn IOCTL_OUT(arg, dmasound_set_bass(data));\n\t    case SOUND_MIXER_WRITE_TREBLE:\n\t\tIOCTL_IN(arg, data);\n\t\treturn IOCTL_OUT(arg, dmasound_set_treble(data));\n\t    case SOUND_MIXER_WRITE_OGAIN:\n\t\tIOCTL_IN(arg, data);\n\t\treturn IOCTL_OUT(arg, dmasound_set_gain(data));\n\t}\n\treturn AtaMixerIoctl(cmd, arg);\n}\n\nstatic int FalconMixerIoctl(u_int cmd, u_long arg)\n{\n\tint data;\n\tswitch (cmd) {\n\tcase SOUND_MIXER_READ_RECMASK:\n\t\treturn IOCTL_OUT(arg, SOUND_MASK_MIC);\n\tcase SOUND_MIXER_READ_DEVMASK:\n\t\treturn IOCTL_OUT(arg, SOUND_MASK_VOLUME | SOUND_MASK_MIC | SOUND_MASK_SPEAKER);\n\tcase SOUND_MIXER_READ_STEREODEVS:\n\t\treturn IOCTL_OUT(arg, SOUND_MASK_VOLUME | SOUND_MASK_MIC);\n\tcase SOUND_MIXER_READ_VOLUME:\n\t\treturn IOCTL_OUT(arg,\n\t\t\tVOLUME_ATT_TO_VOXWARE(dmasound.volume_left) |\n\t\t\tVOLUME_ATT_TO_VOXWARE(dmasound.volume_right) << 8);\n\tcase SOUND_MIXER_READ_CAPS:\n\t\treturn IOCTL_OUT(arg, SOUND_CAP_EXCL_INPUT);\n\tcase SOUND_MIXER_WRITE_MIC:\n\t\tIOCTL_IN(arg, data);\n\t\ttt_dmasnd.input_gain =\n\t\t\tRECLEVEL_VOXWARE_TO_GAIN(data & 0xff) << 4 |\n\t\t\tRECLEVEL_VOXWARE_TO_GAIN(data >> 8 & 0xff);\n\t\tfallthrough;\t \n\tcase SOUND_MIXER_READ_MIC:\n\t\treturn IOCTL_OUT(arg,\n\t\t\tRECLEVEL_GAIN_TO_VOXWARE(tt_dmasnd.input_gain >> 4 & 0xf) |\n\t\t\tRECLEVEL_GAIN_TO_VOXWARE(tt_dmasnd.input_gain & 0xf) << 8);\n\t}\n\treturn AtaMixerIoctl(cmd, arg);\n}\n\nstatic int AtaWriteSqSetup(void)\n{\n\twrite_sq_ignore_int = 0;\n\treturn 0 ;\n}\n\nstatic int AtaSqOpen(fmode_t mode)\n{\n\twrite_sq_ignore_int = 1;\n\treturn 0 ;\n}\n\nstatic int TTStateInfo(char *buffer, size_t space)\n{\n\tint len = 0;\n\tlen += sprintf(buffer+len, \"\\tvol left  %ddB [-40...  0]\\n\",\n\t\t       dmasound.volume_left);\n\tlen += sprintf(buffer+len, \"\\tvol right %ddB [-40...  0]\\n\",\n\t\t       dmasound.volume_right);\n\tlen += sprintf(buffer+len, \"\\tbass      %ddB [-12...+12]\\n\",\n\t\t       dmasound.bass);\n\tlen += sprintf(buffer+len, \"\\ttreble    %ddB [-12...+12]\\n\",\n\t\t       dmasound.treble);\n\tif (len >= space) {\n\t\tprintk(KERN_ERR \"dmasound_atari: overflowed state buffer alloc.\\n\") ;\n\t\tlen = space ;\n\t}\n\treturn len;\n}\n\nstatic int FalconStateInfo(char *buffer, size_t space)\n{\n\tint len = 0;\n\tlen += sprintf(buffer+len, \"\\tvol left  %ddB [-22.5 ... 0]\\n\",\n\t\t       dmasound.volume_left);\n\tlen += sprintf(buffer+len, \"\\tvol right %ddB [-22.5 ... 0]\\n\",\n\t\t       dmasound.volume_right);\n\tif (len >= space) {\n\t\tprintk(KERN_ERR \"dmasound_atari: overflowed state buffer alloc.\\n\") ;\n\t\tlen = space ;\n\t}\n\treturn len;\n}\n\n\n \n\nstatic SETTINGS def_hard_falcon = {\n\t.format\t\t= AFMT_S8,\n\t.stereo\t\t= 0,\n\t.size\t\t= 8,\n\t.speed\t\t= 8195\n} ;\n\nstatic SETTINGS def_hard_tt = {\n\t.format\t= AFMT_S8,\n\t.stereo\t= 0,\n\t.size\t= 8,\n\t.speed\t= 12517\n} ;\n\nstatic SETTINGS def_soft = {\n\t.format\t= AFMT_U8,\n\t.stereo\t= 0,\n\t.size\t= 8,\n\t.speed\t= 8000\n} ;\n\nstatic __initdata MACHINE machTT = {\n\t.name\t\t= \"Atari\",\n\t.name2\t\t= \"TT\",\n\t.owner\t\t= THIS_MODULE,\n\t.dma_alloc\t= AtaAlloc,\n\t.dma_free\t= AtaFree,\n\t.irqinit\t= AtaIrqInit,\n#ifdef MODULE\n\t.irqcleanup\t= AtaIrqCleanUp,\n#endif  \n\t.init\t\t= TTInit,\n\t.silence\t= TTSilence,\n\t.setFormat\t= TTSetFormat,\n\t.setVolume\t= TTSetVolume,\n\t.setBass\t= AtaSetBass,\n\t.setTreble\t= AtaSetTreble,\n\t.setGain\t= TTSetGain,\n\t.play\t\t= AtaPlay,\n\t.mixer_init\t= TTMixerInit,\n\t.mixer_ioctl\t= TTMixerIoctl,\n\t.write_sq_setup\t= AtaWriteSqSetup,\n\t.sq_open\t= AtaSqOpen,\n\t.state_info\t= TTStateInfo,\n\t.min_dsp_speed\t= 6258,\n\t.version\t= ((DMASOUND_ATARI_REVISION<<8) | DMASOUND_ATARI_EDITION),\n\t.hardware_afmts\t= AFMT_S8,   \n\t.capabilities\t=  DSP_CAP_BATCH\t \n};\n\nstatic __initdata MACHINE machFalcon = {\n\t.name\t\t= \"Atari\",\n\t.name2\t\t= \"FALCON\",\n\t.dma_alloc\t= AtaAlloc,\n\t.dma_free\t= AtaFree,\n\t.irqinit\t= AtaIrqInit,\n#ifdef MODULE\n\t.irqcleanup\t= AtaIrqCleanUp,\n#endif  \n\t.init\t\t= FalconInit,\n\t.silence\t= FalconSilence,\n\t.setFormat\t= FalconSetFormat,\n\t.setVolume\t= FalconSetVolume,\n\t.setBass\t= AtaSetBass,\n\t.setTreble\t= AtaSetTreble,\n\t.play\t\t= AtaPlay,\n\t.mixer_init\t= FalconMixerInit,\n\t.mixer_ioctl\t= FalconMixerIoctl,\n\t.write_sq_setup\t= AtaWriteSqSetup,\n\t.sq_open\t= AtaSqOpen,\n\t.state_info\t= FalconStateInfo,\n\t.min_dsp_speed\t= 8195,\n\t.version\t= ((DMASOUND_ATARI_REVISION<<8) | DMASOUND_ATARI_EDITION),\n\t.hardware_afmts\t= (AFMT_S8 | AFMT_S16_BE),  \n\t.capabilities\t=  DSP_CAP_BATCH\t \n};\n\n\n \n\n\nstatic int __init dmasound_atari_init(void)\n{\n\tif (MACH_IS_ATARI && ATARIHW_PRESENT(PCM_8BIT)) {\n\t    if (ATARIHW_PRESENT(CODEC)) {\n\t\tdmasound.mach = machFalcon;\n\t\tdmasound.mach.default_soft = def_soft ;\n\t\tdmasound.mach.default_hard = def_hard_falcon ;\n\t\tis_falcon = 1;\n\t    } else if (ATARIHW_PRESENT(MICROWIRE)) {\n\t\tdmasound.mach = machTT;\n\t\tdmasound.mach.default_soft = def_soft ;\n\t\tdmasound.mach.default_hard = def_hard_tt ;\n\t\tis_falcon = 0;\n\t    } else\n\t\treturn -ENODEV;\n\t    if ((st_mfp.int_en_a & st_mfp.int_mk_a & 0x20) == 0)\n\t\treturn dmasound_init();\n\t    else {\n\t\tprintk(\"DMA sound driver: Timer A interrupt already in use\\n\");\n\t\treturn -EBUSY;\n\t    }\n\t}\n\treturn -ENODEV;\n}\n\nstatic void __exit dmasound_atari_cleanup(void)\n{\n\tdmasound_deinit();\n}\n\nmodule_init(dmasound_atari_init);\nmodule_exit(dmasound_atari_cleanup);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}