{
  "module_name": "virmidi.c",
  "hash_id": "e264f6699df8dc1dc18488b7b71f969af4cccb1e34997439efb220b7e454b037",
  "original_prompt": "Ingested from linux-6.6.14/sound/drivers/virmidi.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/init.h>\n#include <linux/wait.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/module.h>\n#include <sound/core.h>\n#include <sound/seq_kernel.h>\n#include <sound/seq_virmidi.h>\n#include <sound/initval.h>\n\n \n#undef midi_devs\n\nMODULE_AUTHOR(\"Takashi Iwai <tiwai@suse.de>\");\nMODULE_DESCRIPTION(\"Dummy soundcard for virtual rawmidi devices\");\nMODULE_LICENSE(\"GPL\");\n\n#define MAX_MIDI_DEVICES\t4\n\nstatic int index[SNDRV_CARDS] = SNDRV_DEFAULT_IDX;\t \nstatic char *id[SNDRV_CARDS] = SNDRV_DEFAULT_STR;\t \nstatic bool enable[SNDRV_CARDS] = {1, [1 ... (SNDRV_CARDS - 1)] = 0};\nstatic int midi_devs[SNDRV_CARDS] = {[0 ... (SNDRV_CARDS - 1)] = 4};\n\nmodule_param_array(index, int, NULL, 0444);\nMODULE_PARM_DESC(index, \"Index value for virmidi soundcard.\");\nmodule_param_array(id, charp, NULL, 0444);\nMODULE_PARM_DESC(id, \"ID string for virmidi soundcard.\");\nmodule_param_array(enable, bool, NULL, 0444);\nMODULE_PARM_DESC(enable, \"Enable this soundcard.\");\nmodule_param_array(midi_devs, int, NULL, 0444);\nMODULE_PARM_DESC(midi_devs, \"MIDI devices # (1-4)\");\n\nstruct snd_card_virmidi {\n\tstruct snd_card *card;\n\tstruct snd_rawmidi *midi[MAX_MIDI_DEVICES];\n};\n\nstatic struct platform_device *devices[SNDRV_CARDS];\n\n\nstatic int snd_virmidi_probe(struct platform_device *devptr)\n{\n\tstruct snd_card *card;\n\tstruct snd_card_virmidi *vmidi;\n\tint idx, err;\n\tint dev = devptr->id;\n\n\terr = snd_devm_card_new(&devptr->dev, index[dev], id[dev], THIS_MODULE,\n\t\t\t\tsizeof(struct snd_card_virmidi), &card);\n\tif (err < 0)\n\t\treturn err;\n\tvmidi = card->private_data;\n\tvmidi->card = card;\n\n\tif (midi_devs[dev] > MAX_MIDI_DEVICES) {\n\t\tsnd_printk(KERN_WARNING\n\t\t\t   \"too much midi devices for virmidi %d: force to use %d\\n\",\n\t\t\t   dev, MAX_MIDI_DEVICES);\n\t\tmidi_devs[dev] = MAX_MIDI_DEVICES;\n\t}\n\tfor (idx = 0; idx < midi_devs[dev]; idx++) {\n\t\tstruct snd_rawmidi *rmidi;\n\n\t\terr = snd_virmidi_new(card, idx, &rmidi);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tvmidi->midi[idx] = rmidi;\n\t\tstrcpy(rmidi->name, \"Virtual Raw MIDI\");\n\t}\n\n\tstrcpy(card->driver, \"VirMIDI\");\n\tstrcpy(card->shortname, \"VirMIDI\");\n\tsprintf(card->longname, \"Virtual MIDI Card %i\", dev + 1);\n\n\terr = snd_card_register(card);\n\tif (err)\n\t\treturn err;\n\n\tplatform_set_drvdata(devptr, card);\n\treturn 0;\n}\n\n#define SND_VIRMIDI_DRIVER\t\"snd_virmidi\"\n\nstatic struct platform_driver snd_virmidi_driver = {\n\t.probe\t\t= snd_virmidi_probe,\n\t.driver\t\t= {\n\t\t.name\t= SND_VIRMIDI_DRIVER,\n\t},\n};\n\nstatic void snd_virmidi_unregister_all(void)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(devices); ++i)\n\t\tplatform_device_unregister(devices[i]);\n\tplatform_driver_unregister(&snd_virmidi_driver);\n}\n\nstatic int __init alsa_card_virmidi_init(void)\n{\n\tint i, cards, err;\n\n\terr = platform_driver_register(&snd_virmidi_driver);\n\tif (err < 0)\n\t\treturn err;\n\n\tcards = 0;\n\tfor (i = 0; i < SNDRV_CARDS; i++) {\n\t\tstruct platform_device *device;\n\n\t\tif (!enable[i])\n\t\t\tcontinue;\n\t\tdevice = platform_device_register_simple(SND_VIRMIDI_DRIVER,\n\t\t\t\t\t\t\t i, NULL, 0);\n\t\tif (IS_ERR(device))\n\t\t\tcontinue;\n\t\tif (!platform_get_drvdata(device)) {\n\t\t\tplatform_device_unregister(device);\n\t\t\tcontinue;\n\t\t}\n\t\tdevices[i] = device;\n\t\tcards++;\n\t}\n\tif (!cards) {\n#ifdef MODULE\n\t\tprintk(KERN_ERR \"Card-VirMIDI soundcard not found or device busy\\n\");\n#endif\n\t\tsnd_virmidi_unregister_all();\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\n\nstatic void __exit alsa_card_virmidi_exit(void)\n{\n\tsnd_virmidi_unregister_all();\n}\n\nmodule_init(alsa_card_virmidi_init)\nmodule_exit(alsa_card_virmidi_exit)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}