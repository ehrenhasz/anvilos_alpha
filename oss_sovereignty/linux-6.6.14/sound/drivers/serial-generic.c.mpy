{
  "module_name": "serial-generic.c",
  "hash_id": "f65bc190e77c87298f635ec33aa5b293d178c8020db07016d9457460e9862426",
  "original_prompt": "Ingested from linux-6.6.14/sound/drivers/serial-generic.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/serdev.h>\n#include <linux/serial_reg.h>\n#include <linux/slab.h>\n#include <linux/dev_printk.h>\n\n#include <sound/core.h>\n#include <sound/rawmidi.h>\n#include <sound/initval.h>\n\nMODULE_DESCRIPTION(\"Generic serial MIDI driver\");\nMODULE_LICENSE(\"GPL\");\n\n#define SERIAL_MODE_INPUT_OPEN\t\t1\n#define SERIAL_MODE_OUTPUT_OPEN\t2\n#define SERIAL_MODE_INPUT_TRIGGERED\t3\n#define SERIAL_MODE_OUTPUT_TRIGGERED\t4\n\n#define SERIAL_TX_STATE_ACTIVE\t1\n#define SERIAL_TX_STATE_WAKEUP\t2\n\nstruct snd_serial_generic {\n\tstruct serdev_device *serdev;\n\n\tstruct snd_card *card;\n\tstruct snd_rawmidi *rmidi;\n\tstruct snd_rawmidi_substream *midi_output;\n\tstruct snd_rawmidi_substream *midi_input;\n\n\tunsigned int baudrate;\n\n\tunsigned long filemode;\t\t \n\tstruct work_struct tx_work;\n\tunsigned long tx_state;\n\n};\n\nstatic void snd_serial_generic_tx_wakeup(struct snd_serial_generic *drvdata)\n{\n\tif (test_and_set_bit(SERIAL_TX_STATE_ACTIVE, &drvdata->tx_state))\n\t\tset_bit(SERIAL_TX_STATE_WAKEUP, &drvdata->tx_state);\n\n\tschedule_work(&drvdata->tx_work);\n}\n\n#define INTERNAL_BUF_SIZE 256\n\nstatic void snd_serial_generic_tx_work(struct work_struct *work)\n{\n\tstatic char buf[INTERNAL_BUF_SIZE];\n\tint num_bytes;\n\tstruct snd_serial_generic *drvdata = container_of(work, struct snd_serial_generic,\n\t\t\t\t\t\t   tx_work);\n\tstruct snd_rawmidi_substream *substream = drvdata->midi_output;\n\n\tclear_bit(SERIAL_TX_STATE_WAKEUP, &drvdata->tx_state);\n\n\twhile (!snd_rawmidi_transmit_empty(substream)) {\n\n\t\tif (!test_bit(SERIAL_MODE_OUTPUT_OPEN, &drvdata->filemode))\n\t\t\tbreak;\n\n\t\tnum_bytes = snd_rawmidi_transmit_peek(substream, buf, INTERNAL_BUF_SIZE);\n\t\tnum_bytes = serdev_device_write_buf(drvdata->serdev, buf, num_bytes);\n\n\t\tif (!num_bytes)\n\t\t\tbreak;\n\n\t\tsnd_rawmidi_transmit_ack(substream, num_bytes);\n\n\t\tif (!test_bit(SERIAL_TX_STATE_WAKEUP, &drvdata->tx_state))\n\t\t\tbreak;\n\t}\n\n\tclear_bit(SERIAL_TX_STATE_ACTIVE, &drvdata->tx_state);\n}\n\nstatic void snd_serial_generic_write_wakeup(struct serdev_device *serdev)\n{\n\tstruct snd_serial_generic *drvdata = serdev_device_get_drvdata(serdev);\n\n\tsnd_serial_generic_tx_wakeup(drvdata);\n}\n\nstatic int snd_serial_generic_receive_buf(struct serdev_device *serdev,\n\t\t\t\tconst unsigned char *buf, size_t count)\n{\n\tint ret;\n\tstruct snd_serial_generic *drvdata = serdev_device_get_drvdata(serdev);\n\n\tif (!test_bit(SERIAL_MODE_INPUT_OPEN, &drvdata->filemode))\n\t\treturn 0;\n\n\tret = snd_rawmidi_receive(drvdata->midi_input, buf, count);\n\treturn ret < 0 ? 0 : ret;\n}\n\nstatic const struct serdev_device_ops snd_serial_generic_serdev_device_ops = {\n\t.receive_buf = snd_serial_generic_receive_buf,\n\t.write_wakeup = snd_serial_generic_write_wakeup\n};\n\nstatic int snd_serial_generic_ensure_serdev_open(struct snd_serial_generic *drvdata)\n{\n\tint err;\n\tunsigned int actual_baud;\n\n\tif (drvdata->filemode)\n\t\treturn 0;\n\n\tdev_dbg(drvdata->card->dev, \"Opening serial port for card %s\\n\",\n\t\tdrvdata->card->shortname);\n\terr = serdev_device_open(drvdata->serdev);\n\tif (err < 0)\n\t\treturn err;\n\n\tactual_baud = serdev_device_set_baudrate(drvdata->serdev,\n\t\tdrvdata->baudrate);\n\tif (actual_baud != drvdata->baudrate) {\n\t\tdev_warn(drvdata->card->dev, \"requested %d baud for card %s but it was actually set to %d\\n\",\n\t\t\tdrvdata->baudrate, drvdata->card->shortname, actual_baud);\n\t}\n\n\treturn 0;\n}\n\nstatic int snd_serial_generic_input_open(struct snd_rawmidi_substream *substream)\n{\n\tint err;\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\n\tdev_dbg(drvdata->card->dev, \"Opening input for card %s\\n\",\n\t\tdrvdata->card->shortname);\n\n\terr = snd_serial_generic_ensure_serdev_open(drvdata);\n\tif (err < 0)\n\t\treturn err;\n\n\tset_bit(SERIAL_MODE_INPUT_OPEN, &drvdata->filemode);\n\tdrvdata->midi_input = substream;\n\treturn 0;\n}\n\nstatic int snd_serial_generic_input_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\n\tdev_dbg(drvdata->card->dev, \"Closing input for card %s\\n\",\n\t\tdrvdata->card->shortname);\n\n\tclear_bit(SERIAL_MODE_INPUT_OPEN, &drvdata->filemode);\n\tclear_bit(SERIAL_MODE_INPUT_TRIGGERED, &drvdata->filemode);\n\n\tdrvdata->midi_input = NULL;\n\n\tif (!drvdata->filemode)\n\t\tserdev_device_close(drvdata->serdev);\n\treturn 0;\n}\n\nstatic void snd_serial_generic_input_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t\tint up)\n{\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\n\tif (up)\n\t\tset_bit(SERIAL_MODE_INPUT_TRIGGERED, &drvdata->filemode);\n\telse\n\t\tclear_bit(SERIAL_MODE_INPUT_TRIGGERED, &drvdata->filemode);\n}\n\nstatic int snd_serial_generic_output_open(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\tint err;\n\n\tdev_dbg(drvdata->card->dev, \"Opening output for card %s\\n\",\n\t\tdrvdata->card->shortname);\n\n\terr = snd_serial_generic_ensure_serdev_open(drvdata);\n\tif (err < 0)\n\t\treturn err;\n\n\tset_bit(SERIAL_MODE_OUTPUT_OPEN, &drvdata->filemode);\n\n\tdrvdata->midi_output = substream;\n\treturn 0;\n};\n\nstatic int snd_serial_generic_output_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\n\tdev_dbg(drvdata->card->dev, \"Closing output for card %s\\n\",\n\t\tdrvdata->card->shortname);\n\n\tclear_bit(SERIAL_MODE_OUTPUT_OPEN, &drvdata->filemode);\n\tclear_bit(SERIAL_MODE_OUTPUT_TRIGGERED, &drvdata->filemode);\n\n\tif (!drvdata->filemode)\n\t\tserdev_device_close(drvdata->serdev);\n\n\tdrvdata->midi_output = NULL;\n\n\treturn 0;\n};\n\nstatic void snd_serial_generic_output_trigger(struct snd_rawmidi_substream *substream,\n\t\t\t\t\t int up)\n{\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\n\tif (up)\n\t\tset_bit(SERIAL_MODE_OUTPUT_TRIGGERED, &drvdata->filemode);\n\telse\n\t\tclear_bit(SERIAL_MODE_OUTPUT_TRIGGERED, &drvdata->filemode);\n\n\tif (up)\n\t\tsnd_serial_generic_tx_wakeup(drvdata);\n}\n\nstatic void snd_serial_generic_output_drain(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_serial_generic *drvdata = substream->rmidi->card->private_data;\n\n\t \n\tserdev_device_write_flush(drvdata->serdev);\n\tcancel_work_sync(&drvdata->tx_work);\n}\n\nstatic const struct snd_rawmidi_ops snd_serial_generic_output = {\n\t.open =\t\tsnd_serial_generic_output_open,\n\t.close =\tsnd_serial_generic_output_close,\n\t.trigger =\tsnd_serial_generic_output_trigger,\n\t.drain =\tsnd_serial_generic_output_drain,\n};\n\nstatic const struct snd_rawmidi_ops snd_serial_generic_input = {\n\t.open =\t\tsnd_serial_generic_input_open,\n\t.close =\tsnd_serial_generic_input_close,\n\t.trigger =\tsnd_serial_generic_input_trigger,\n};\n\nstatic void snd_serial_generic_parse_dt(struct serdev_device *serdev,\n\t\t\t\tstruct snd_serial_generic *drvdata)\n{\n\tint err;\n\n\terr = of_property_read_u32(serdev->dev.of_node, \"current-speed\",\n\t\t&drvdata->baudrate);\n\tif (err < 0) {\n\t\tdev_dbg(drvdata->card->dev,\n\t\t\t\"MIDI device reading of current-speed DT param failed with error %d, using default of 38400\\n\",\n\t\t\terr);\n\t\tdrvdata->baudrate = 38400;\n\t}\n\n}\n\nstatic void snd_serial_generic_substreams(struct snd_rawmidi_str *stream, int dev_num)\n{\n\tstruct snd_rawmidi_substream *substream;\n\n\tlist_for_each_entry(substream, &stream->substreams, list) {\n\t\tsprintf(substream->name, \"Serial MIDI %d-%d\", dev_num, substream->number);\n\t}\n}\n\nstatic int snd_serial_generic_rmidi(struct snd_serial_generic *drvdata,\n\t\t\t\tint outs, int ins, struct snd_rawmidi **rmidi)\n{\n\tstruct snd_rawmidi *rrawmidi;\n\tint err;\n\n\terr = snd_rawmidi_new(drvdata->card, drvdata->card->driver, 0,\n\t\t\t\touts, ins, &rrawmidi);\n\n\tif (err < 0)\n\t\treturn err;\n\n\tsnd_rawmidi_set_ops(rrawmidi, SNDRV_RAWMIDI_STREAM_INPUT,\n\t\t\t\t&snd_serial_generic_input);\n\tsnd_rawmidi_set_ops(rrawmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\n\t\t\t\t&snd_serial_generic_output);\n\tstrcpy(rrawmidi->name, drvdata->card->shortname);\n\n\tsnd_serial_generic_substreams(&rrawmidi->streams[SNDRV_RAWMIDI_STREAM_OUTPUT],\n\t\t\t\t\tdrvdata->serdev->ctrl->nr);\n\tsnd_serial_generic_substreams(&rrawmidi->streams[SNDRV_RAWMIDI_STREAM_INPUT],\n\t\t\t\t\tdrvdata->serdev->ctrl->nr);\n\n\trrawmidi->info_flags = SNDRV_RAWMIDI_INFO_OUTPUT |\n\t\t\t       SNDRV_RAWMIDI_INFO_INPUT |\n\t\t\t       SNDRV_RAWMIDI_INFO_DUPLEX;\n\n\tif (rmidi)\n\t\t*rmidi = rrawmidi;\n\treturn 0;\n}\n\nstatic int snd_serial_generic_probe(struct serdev_device *serdev)\n{\n\tstruct snd_card *card;\n\tstruct snd_serial_generic *drvdata;\n\tint err;\n\n\terr  = snd_devm_card_new(&serdev->dev, SNDRV_DEFAULT_IDX1,\n\t\t\t\tSNDRV_DEFAULT_STR1, THIS_MODULE,\n\t\t\t\tsizeof(struct snd_serial_generic), &card);\n\n\tif (err < 0)\n\t\treturn err;\n\n\tstrcpy(card->driver, \"SerialMIDI\");\n\tsprintf(card->shortname, \"SerialMIDI-%d\", serdev->ctrl->nr);\n\tsprintf(card->longname, \"Serial MIDI device at serial%d\", serdev->ctrl->nr);\n\n\tdrvdata = card->private_data;\n\n\tdrvdata->serdev = serdev;\n\tdrvdata->card = card;\n\n\tsnd_serial_generic_parse_dt(serdev, drvdata);\n\n\tINIT_WORK(&drvdata->tx_work, snd_serial_generic_tx_work);\n\n\terr = snd_serial_generic_rmidi(drvdata, 1, 1, &drvdata->rmidi);\n\tif (err < 0)\n\t\treturn err;\n\n\tserdev_device_set_client_ops(serdev, &snd_serial_generic_serdev_device_ops);\n\tserdev_device_set_drvdata(drvdata->serdev, drvdata);\n\n\terr = snd_card_register(card);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic const struct of_device_id snd_serial_generic_dt_ids[] = {\n\t{ .compatible = \"serial-midi\" },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(of, snd_serial_generic_dt_ids);\n\nstatic struct serdev_device_driver snd_serial_generic_driver = {\n\t.driver\t= {\n\t\t.name\t\t= \"snd-serial-generic\",\n\t\t.of_match_table\t= snd_serial_generic_dt_ids,\n\t},\n\t.probe\t= snd_serial_generic_probe,\n};\n\nmodule_serdev_device_driver(snd_serial_generic_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}