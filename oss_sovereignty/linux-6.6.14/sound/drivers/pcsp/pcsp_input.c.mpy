{
  "module_name": "pcsp_input.c",
  "hash_id": "a2ccd28a18e65bb9613f7066b28d94d8fe72a10f2e6551f2c05f604e86afeb55",
  "original_prompt": "Ingested from linux-6.6.14/sound/drivers/pcsp/pcsp_input.c",
  "human_readable_source": "\n \n\n\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/io.h>\n#include \"pcsp.h\"\n#include \"pcsp_input.h\"\n\nstatic void pcspkr_do_sound(unsigned int count)\n{\n\tunsigned long flags;\n\n\traw_spin_lock_irqsave(&i8253_lock, flags);\n\n\tif (count) {\n\t\t \n\t\toutb_p(0xB6, 0x43);\n\t\t \n\t\toutb_p(count & 0xff, 0x42);\n\t\toutb((count >> 8) & 0xff, 0x42);\n\t\t \n\t\toutb_p(inb_p(0x61) | 3, 0x61);\n\t} else {\n\t\t \n\t\toutb(inb_p(0x61) & 0xFC, 0x61);\n\t}\n\n\traw_spin_unlock_irqrestore(&i8253_lock, flags);\n}\n\nvoid pcspkr_stop_sound(void)\n{\n\tpcspkr_do_sound(0);\n}\n\nstatic int pcspkr_input_event(struct input_dev *dev, unsigned int type,\n\t\t\t      unsigned int code, int value)\n{\n\tunsigned int count = 0;\n\n\tif (atomic_read(&pcsp_chip.timer_active) || !pcsp_chip.pcspkr)\n\t\treturn 0;\n\n\tswitch (type) {\n\tcase EV_SND:\n\t\tswitch (code) {\n\t\tcase SND_BELL:\n\t\t\tif (value)\n\t\t\t\tvalue = 1000;\n\t\t\tbreak;\n\t\tcase SND_TONE:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -1;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\treturn -1;\n\t}\n\n\tif (value > 20 && value < 32767)\n\t\tcount = PIT_TICK_RATE / value;\n\n\tpcspkr_do_sound(count);\n\n\treturn 0;\n}\n\nint pcspkr_input_init(struct input_dev **rdev, struct device *dev)\n{\n\tint err;\n\n\tstruct input_dev *input_dev = devm_input_allocate_device(dev);\n\tif (!input_dev)\n\t\treturn -ENOMEM;\n\n\tinput_dev->name = \"PC Speaker\";\n\tinput_dev->phys = \"isa0061/input0\";\n\tinput_dev->id.bustype = BUS_ISA;\n\tinput_dev->id.vendor = 0x001f;\n\tinput_dev->id.product = 0x0001;\n\tinput_dev->id.version = 0x0100;\n\tinput_dev->dev.parent = dev;\n\n\tinput_dev->evbit[0] = BIT(EV_SND);\n\tinput_dev->sndbit[0] = BIT(SND_BELL) | BIT(SND_TONE);\n\tinput_dev->event = pcspkr_input_event;\n\n\terr = input_register_device(input_dev);\n\tif (err)\n\t\treturn err;\n\n\t*rdev = input_dev;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}