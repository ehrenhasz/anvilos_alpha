{
  "module_name": "rawmidi_compat.c",
  "hash_id": "c38464076419722e72ab2c6c021fda23889becc058f22f24f8f4076da96d367d",
  "original_prompt": "Ingested from linux-6.6.14/sound/core/rawmidi_compat.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/compat.h>\n\nstruct snd_rawmidi_params32 {\n\ts32 stream;\n\tu32 buffer_size;\n\tu32 avail_min;\n\tunsigned int no_active_sensing;  \n\tunsigned int mode;\n\tunsigned char reserved[12];\n} __attribute__((packed));\n\nstatic int snd_rawmidi_ioctl_params_compat(struct snd_rawmidi_file *rfile,\n\t\t\t\t\t   struct snd_rawmidi_params32 __user *src)\n{\n\tstruct snd_rawmidi_params params;\n\tunsigned int val;\n\n\tif (get_user(params.stream, &src->stream) ||\n\t    get_user(params.buffer_size, &src->buffer_size) ||\n\t    get_user(params.avail_min, &src->avail_min) ||\n\t    get_user(params.mode, &src->mode) ||\n\t    get_user(val, &src->no_active_sensing))\n\t\treturn -EFAULT;\n\tparams.no_active_sensing = val;\n\tswitch (params.stream) {\n\tcase SNDRV_RAWMIDI_STREAM_OUTPUT:\n\t\tif (!rfile->output)\n\t\t\treturn -EINVAL;\n\t\treturn snd_rawmidi_output_params(rfile->output, &params);\n\tcase SNDRV_RAWMIDI_STREAM_INPUT:\n\t\tif (!rfile->input)\n\t\t\treturn -EINVAL;\n\t\treturn snd_rawmidi_input_params(rfile->input, &params);\n\t}\n\treturn -EINVAL;\n}\n\nstruct compat_snd_rawmidi_status64 {\n\ts32 stream;\n\tu8 rsvd[4];  \n\ts64 tstamp_sec;\n\ts64 tstamp_nsec;\n\tu32 avail;\n\tu32 xruns;\n\tunsigned char reserved[16];\n} __attribute__((packed));\n\nstatic int snd_rawmidi_ioctl_status_compat64(struct snd_rawmidi_file *rfile,\n\t\t\t\t\t     struct compat_snd_rawmidi_status64 __user *src)\n{\n\tint err;\n\tstruct snd_rawmidi_status64 status;\n\tstruct compat_snd_rawmidi_status64 compat_status;\n\n\tif (get_user(status.stream, &src->stream))\n\t\treturn -EFAULT;\n\n\tswitch (status.stream) {\n\tcase SNDRV_RAWMIDI_STREAM_OUTPUT:\n\t\tif (!rfile->output)\n\t\t\treturn -EINVAL;\n\t\terr = snd_rawmidi_output_status(rfile->output, &status);\n\t\tbreak;\n\tcase SNDRV_RAWMIDI_STREAM_INPUT:\n\t\tif (!rfile->input)\n\t\t\treturn -EINVAL;\n\t\terr = snd_rawmidi_input_status(rfile->input, &status);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tif (err < 0)\n\t\treturn err;\n\n\tcompat_status = (struct compat_snd_rawmidi_status64) {\n\t\t.stream = status.stream,\n\t\t.tstamp_sec = status.tstamp_sec,\n\t\t.tstamp_nsec = status.tstamp_nsec,\n\t\t.avail = status.avail,\n\t\t.xruns = status.xruns,\n\t};\n\n\tif (copy_to_user(src, &compat_status, sizeof(*src)))\n\t\treturn -EFAULT;\n\n\treturn 0;\n}\n\nenum {\n\tSNDRV_RAWMIDI_IOCTL_PARAMS32 = _IOWR('W', 0x10, struct snd_rawmidi_params32),\n\tSNDRV_RAWMIDI_IOCTL_STATUS_COMPAT32 = _IOWR('W', 0x20, struct snd_rawmidi_status32),\n\tSNDRV_RAWMIDI_IOCTL_STATUS_COMPAT64 = _IOWR('W', 0x20, struct compat_snd_rawmidi_status64),\n};\n\nstatic long snd_rawmidi_ioctl_compat(struct file *file, unsigned int cmd, unsigned long arg)\n{\n\tstruct snd_rawmidi_file *rfile;\n\tvoid __user *argp = compat_ptr(arg);\n\n\trfile = file->private_data;\n\tswitch (cmd) {\n\tcase SNDRV_RAWMIDI_IOCTL_PVERSION:\n\tcase SNDRV_RAWMIDI_IOCTL_INFO:\n\tcase SNDRV_RAWMIDI_IOCTL_DROP:\n\tcase SNDRV_RAWMIDI_IOCTL_DRAIN:\n#if IS_ENABLED(CONFIG_SND_UMP)\n\tcase SNDRV_UMP_IOCTL_ENDPOINT_INFO:\n\tcase SNDRV_UMP_IOCTL_BLOCK_INFO:\n#endif\n\t\treturn snd_rawmidi_ioctl(file, cmd, (unsigned long)argp);\n\tcase SNDRV_RAWMIDI_IOCTL_PARAMS32:\n\t\treturn snd_rawmidi_ioctl_params_compat(rfile, argp);\n\tcase SNDRV_RAWMIDI_IOCTL_STATUS_COMPAT32:\n\t\treturn snd_rawmidi_ioctl_status32(rfile, argp);\n\tcase SNDRV_RAWMIDI_IOCTL_STATUS_COMPAT64:\n\t\treturn snd_rawmidi_ioctl_status_compat64(rfile, argp);\n\t}\n\treturn -ENOIOCTLCMD;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}