{
  "module_name": "seq_oss_event.c",
  "hash_id": "345ac0c3bc6649c618b85eec95c6b3c8fb852698d6c62eb1be0ecfbd7b1947bf",
  "original_prompt": "Ingested from linux-6.6.14/sound/core/seq/oss/seq_oss_event.c",
  "human_readable_source": "\n \n\n#include \"seq_oss_device.h\"\n#include \"seq_oss_synth.h\"\n#include \"seq_oss_midi.h\"\n#include \"seq_oss_event.h\"\n#include \"seq_oss_timer.h\"\n#include <sound/seq_oss_legacy.h>\n#include \"seq_oss_readq.h\"\n#include \"seq_oss_writeq.h\"\n#include <linux/nospec.h>\n\n\n \nstatic int extended_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev);\nstatic int chn_voice_event(struct seq_oss_devinfo *dp, union evrec *event_rec, struct snd_seq_event *ev);\nstatic int chn_common_event(struct seq_oss_devinfo *dp, union evrec *event_rec, struct snd_seq_event *ev);\nstatic int timing_event(struct seq_oss_devinfo *dp, union evrec *event_rec, struct snd_seq_event *ev);\nstatic int local_event(struct seq_oss_devinfo *dp, union evrec *event_rec, struct snd_seq_event *ev);\nstatic int old_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev);\nstatic int note_on_event(struct seq_oss_devinfo *dp, int dev, int ch, int note, int vel, struct snd_seq_event *ev);\nstatic int note_off_event(struct seq_oss_devinfo *dp, int dev, int ch, int note, int vel, struct snd_seq_event *ev);\nstatic int set_note_event(struct seq_oss_devinfo *dp, int dev, int type, int ch, int note, int vel, struct snd_seq_event *ev);\nstatic int set_control_event(struct seq_oss_devinfo *dp, int dev, int type, int ch, int param, int val, struct snd_seq_event *ev);\nstatic int set_echo_event(struct seq_oss_devinfo *dp, union evrec *rec, struct snd_seq_event *ev);\n\n\n \n\nint\nsnd_seq_oss_process_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\tswitch (q->s.code) {\n\tcase SEQ_EXTENDED:\n\t\treturn extended_event(dp, q, ev);\n\n\tcase EV_CHN_VOICE:\n\t\treturn chn_voice_event(dp, q, ev);\n\n\tcase EV_CHN_COMMON:\n\t\treturn chn_common_event(dp, q, ev);\n\n\tcase EV_TIMING:\n\t\treturn timing_event(dp, q, ev);\n\n\tcase EV_SEQ_LOCAL:\n\t\treturn local_event(dp, q, ev);\n\n\tcase EV_SYSEX:\n\t\treturn snd_seq_oss_synth_sysex(dp, q->x.dev, q->x.buf, ev);\n\n\tcase SEQ_MIDIPUTC:\n\t\tif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\n\t\t\treturn -EINVAL;\n\t\t \n\t\tif (! is_write_mode(dp->file_mode))\n\t\t\tbreak;\n\t\tif (snd_seq_oss_midi_open(dp, q->s.dev, SNDRV_SEQ_OSS_FILE_WRITE))\n\t\t\tbreak;\n\t\tif (snd_seq_oss_midi_filemode(dp, q->s.dev) & SNDRV_SEQ_OSS_FILE_WRITE)\n\t\t\treturn snd_seq_oss_midi_putc(dp, q->s.dev, q->s.parm1, ev);\n\t\tbreak;\n\n\tcase SEQ_ECHO:\n\t\tif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\n\t\t\treturn -EINVAL;\n\t\treturn set_echo_event(dp, q, ev);\n\n\tcase SEQ_PRIVATE:\n\t\tif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\n\t\t\treturn -EINVAL;\n\t\treturn snd_seq_oss_synth_raw_event(dp, q->c[1], q->c, ev);\n\n\tdefault:\n\t\tif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\n\t\t\treturn -EINVAL;\n\t\treturn old_event(dp, q, ev);\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int\nold_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\tswitch (q->s.code) {\n\tcase SEQ_NOTEOFF:\n\t\treturn note_off_event(dp, 0, q->n.chn, q->n.note, q->n.vel, ev);\n\n\tcase SEQ_NOTEON:\n\t\treturn note_on_event(dp, 0, q->n.chn, q->n.note, q->n.vel, ev);\n\n\tcase SEQ_WAIT:\n\t\t \n\t\tbreak;\n\n\tcase SEQ_PGMCHANGE:\n\t\treturn set_control_event(dp, 0, SNDRV_SEQ_EVENT_PGMCHANGE,\n\t\t\t\t\t q->n.chn, 0, q->n.note, ev);\n\n\tcase SEQ_SYNCTIMER:\n\t\treturn snd_seq_oss_timer_reset(dp->timer);\n\t}\n\n\treturn -EINVAL;\n}\n\n \nstatic int\nextended_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\tint val;\n\n\tswitch (q->e.cmd) {\n\tcase SEQ_NOTEOFF:\n\t\treturn note_off_event(dp, q->e.dev, q->e.chn, q->e.p1, q->e.p2, ev);\n\n\tcase SEQ_NOTEON:\n\t\treturn note_on_event(dp, q->e.dev, q->e.chn, q->e.p1, q->e.p2, ev);\n\n\tcase SEQ_PGMCHANGE:\n\t\treturn set_control_event(dp, q->e.dev, SNDRV_SEQ_EVENT_PGMCHANGE,\n\t\t\t\t\t q->e.chn, 0, q->e.p1, ev);\n\n\tcase SEQ_AFTERTOUCH:\n\t\treturn set_control_event(dp, q->e.dev, SNDRV_SEQ_EVENT_CHANPRESS,\n\t\t\t\t\t q->e.chn, 0, q->e.p1, ev);\n\n\tcase SEQ_BALANCE:\n\t\t \n\t\tval = (char)q->e.p1;\n\t\tval = (val + 128) / 2;\n\t\treturn set_control_event(dp, q->e.dev, SNDRV_SEQ_EVENT_CONTROLLER,\n\t\t\t\t\t q->e.chn, CTL_PAN, val, ev);\n\n\tcase SEQ_CONTROLLER:\n\t\tval = ((short)q->e.p3 << 8) | (short)q->e.p2;\n\t\tswitch (q->e.p1) {\n\t\tcase CTRL_PITCH_BENDER:  \n\t\t\t \n\t\t\treturn set_control_event(dp, q->e.dev,\n\t\t\t\t\t\t SNDRV_SEQ_EVENT_PITCHBEND,\n\t\t\t\t\t\t q->e.chn, 0, val, ev);\n\t\tcase CTRL_PITCH_BENDER_RANGE:\n\t\t\t \n\t\t\treturn set_control_event(dp, q->e.dev,\n\t\t\t\t\t\t SNDRV_SEQ_EVENT_REGPARAM,\n\t\t\t\t\t\t q->e.chn, 0, val*128/100, ev);\n\t\tdefault:\n\t\t\treturn set_control_event(dp, q->e.dev,\n\t\t\t\t\t\t  SNDRV_SEQ_EVENT_CONTROL14,\n\t\t\t\t\t\t  q->e.chn, q->e.p1, val, ev);\n\t\t}\n\n\tcase SEQ_VOLMODE:\n\t\treturn snd_seq_oss_synth_raw_event(dp, q->e.dev, q->c, ev);\n\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int\nchn_voice_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\tif (q->v.chn >= 32)\n\t\treturn -EINVAL;\n\tswitch (q->v.cmd) {\n\tcase MIDI_NOTEON:\n\t\treturn note_on_event(dp, q->v.dev, q->v.chn, q->v.note, q->v.parm, ev);\n\n\tcase MIDI_NOTEOFF:\n\t\treturn note_off_event(dp, q->v.dev, q->v.chn, q->v.note, q->v.parm, ev);\n\n\tcase MIDI_KEY_PRESSURE:\n\t\treturn set_note_event(dp, q->v.dev, SNDRV_SEQ_EVENT_KEYPRESS,\n\t\t\t\t       q->v.chn, q->v.note, q->v.parm, ev);\n\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int\nchn_common_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\tif (q->l.chn >= 32)\n\t\treturn -EINVAL;\n\tswitch (q->l.cmd) {\n\tcase MIDI_PGM_CHANGE:\n\t\treturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_PGMCHANGE,\n\t\t\t\t\t  q->l.chn, 0, q->l.p1, ev);\n\n\tcase MIDI_CTL_CHANGE:\n\t\treturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_CONTROLLER,\n\t\t\t\t\t  q->l.chn, q->l.p1, q->l.val, ev);\n\n\tcase MIDI_PITCH_BEND:\n\t\t \n\t\treturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_PITCHBEND,\n\t\t\t\t\t  q->l.chn, 0, q->l.val - 8192, ev);\n\t\t\n\tcase MIDI_CHN_PRESSURE:\n\t\treturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_CHANPRESS,\n\t\t\t\t\t  q->l.chn, 0, q->l.val, ev);\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int\ntiming_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\tswitch (q->t.cmd) {\n\tcase TMR_ECHO:\n\t\tif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\n\t\t\treturn set_echo_event(dp, q, ev);\n\t\telse {\n\t\t\tunion evrec tmp;\n\t\t\tmemset(&tmp, 0, sizeof(tmp));\n\t\t\t \n\t\t\ttmp.echo = (q->t.time << 8) | SEQ_ECHO;\n\t\t\treturn set_echo_event(dp, &tmp, ev);\n\t\t} \n\n\tcase TMR_STOP:\n\t\tif (dp->seq_mode)\n\t\t\treturn snd_seq_oss_timer_stop(dp->timer);\n\t\treturn 0;\n\n\tcase TMR_CONTINUE:\n\t\tif (dp->seq_mode)\n\t\t\treturn snd_seq_oss_timer_continue(dp->timer);\n\t\treturn 0;\n\n\tcase TMR_TEMPO:\n\t\tif (dp->seq_mode)\n\t\t\treturn snd_seq_oss_timer_tempo(dp->timer, q->t.time);\n\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\n \nstatic int\nlocal_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\n{\n\treturn -EINVAL;\n}\n\n \nstatic int\nnote_on_event(struct seq_oss_devinfo *dp, int dev, int ch, int note, int vel, struct snd_seq_event *ev)\n{\n\tstruct seq_oss_synthinfo *info;\n\n\tinfo = snd_seq_oss_synth_info(dp, dev);\n\tif (!info)\n\t\treturn -ENXIO;\n\n\tswitch (info->arg.event_passing) {\n\tcase SNDRV_SEQ_OSS_PROCESS_EVENTS:\n\t\tif (! info->ch || ch < 0 || ch >= info->nr_voices) {\n\t\t\t \n\t\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\n\t\t}\n\n\t\tch = array_index_nospec(ch, info->nr_voices);\n\t\tif (note == 255 && info->ch[ch].note >= 0) {\n\t\t\t \n\t\t\tint type;\n\t\t\t\n\t\t\t\t \n\t\t\t\n\t\t\t\n\t\t\t\tif (info->ch[ch].vel)\n\t\t\t\t \n\t\t\t\ttype = SNDRV_SEQ_EVENT_KEYPRESS;\n\t\t\telse\n\t\t\t\t \n\t\t\t\ttype = SNDRV_SEQ_EVENT_NOTEON;\n\t\t\tinfo->ch[ch].vel = vel;\n\t\t\treturn set_note_event(dp, dev, type, ch, info->ch[ch].note, vel, ev);\n\t\t} else if (note >= 128)\n\t\t\treturn -EINVAL;  \n\n\t\tif (note != info->ch[ch].note && info->ch[ch].note >= 0)\n\t\t\t \n\t\t\tset_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEOFF, ch, info->ch[ch].note, 0, ev);\n\t\t \n\t\tinfo->ch[ch].note = note;\n\t\tinfo->ch[ch].vel = vel;\n\t\tif (vel)  \n\t\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\n\t\treturn -EINVAL;\n\t\t\n\tcase SNDRV_SEQ_OSS_PASS_EVENTS:\n\t\t \n\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\n\n\tcase SNDRV_SEQ_OSS_PROCESS_KEYPRESS:\n\t\tif (note >= 128)  \n\t\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_KEYPRESS, ch, note - 128, vel, ev);\n\t\telse  \n\t\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int\nnote_off_event(struct seq_oss_devinfo *dp, int dev, int ch, int note, int vel, struct snd_seq_event *ev)\n{\n\tstruct seq_oss_synthinfo *info;\n\n\tinfo = snd_seq_oss_synth_info(dp, dev);\n\tif (!info)\n\t\treturn -ENXIO;\n\n\tswitch (info->arg.event_passing) {\n\tcase SNDRV_SEQ_OSS_PROCESS_EVENTS:\n\t\tif (! info->ch || ch < 0 || ch >= info->nr_voices) {\n\t\t\t \n\t\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\n\t\t}\n\n\t\tch = array_index_nospec(ch, info->nr_voices);\n\t\tif (info->ch[ch].note >= 0) {\n\t\t\tnote = info->ch[ch].note;\n\t\t\tinfo->ch[ch].vel = 0;\n\t\t\tinfo->ch[ch].note = -1;\n\t\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEOFF, ch, note, vel, ev);\n\t\t}\n\t\treturn -EINVAL;  \n\n\tcase SNDRV_SEQ_OSS_PASS_EVENTS:\n\tcase SNDRV_SEQ_OSS_PROCESS_KEYPRESS:\n\t\t \n\t\treturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEOFF, ch, note, vel, ev);\n\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int\nset_note_event(struct seq_oss_devinfo *dp, int dev, int type, int ch, int note, int vel, struct snd_seq_event *ev)\n{\n\tif (!snd_seq_oss_synth_info(dp, dev))\n\t\treturn -ENXIO;\n\t\n\tev->type = type;\n\tsnd_seq_oss_synth_addr(dp, dev, ev);\n\tev->data.note.channel = ch;\n\tev->data.note.note = note;\n\tev->data.note.velocity = vel;\n\n\treturn 0;\n}\n\n \nstatic int\nset_control_event(struct seq_oss_devinfo *dp, int dev, int type, int ch, int param, int val, struct snd_seq_event *ev)\n{\n\tif (!snd_seq_oss_synth_info(dp, dev))\n\t\treturn -ENXIO;\n\t\n\tev->type = type;\n\tsnd_seq_oss_synth_addr(dp, dev, ev);\n\tev->data.control.channel = ch;\n\tev->data.control.param = param;\n\tev->data.control.value = val;\n\n\treturn 0;\n}\n\n \nstatic int\nset_echo_event(struct seq_oss_devinfo *dp, union evrec *rec, struct snd_seq_event *ev)\n{\n\tev->type = SNDRV_SEQ_EVENT_ECHO;\n\t \n\tsnd_seq_oss_fill_addr(dp, ev, dp->addr.client, dp->addr.port);\n\tmemcpy(&ev->data, rec, LONG_EVENT_SIZE);\n\treturn 0;\n}\n\n \nint\nsnd_seq_oss_event_input(struct snd_seq_event *ev, int direct, void *private_data,\n\t\t\tint atomic, int hop)\n{\n\tstruct seq_oss_devinfo *dp = (struct seq_oss_devinfo *)private_data;\n\tunion evrec *rec;\n\n\tif (ev->type != SNDRV_SEQ_EVENT_ECHO)\n\t\treturn snd_seq_oss_midi_input(ev, direct, private_data);\n\n\tif (ev->source.client != dp->cseq)\n\t\treturn 0;  \n\n\trec = (union evrec*)&ev->data;\n\tif (rec->s.code == SEQ_SYNCTIMER) {\n\t\t \n\t\tsnd_seq_oss_writeq_wakeup(dp->writeq, rec->t.time);\n\t\t\n\t} else {\n\t\t \n\t\tif (dp->readq == NULL)\n\t\t\treturn 0;\n\t\tsnd_seq_oss_readq_put_event(dp->readq, rec);\n\t}\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}