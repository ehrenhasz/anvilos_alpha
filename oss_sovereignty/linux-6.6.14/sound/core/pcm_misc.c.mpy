{
  "module_name": "pcm_misc.c",
  "hash_id": "033de9b75d47e3b78b162ed18da0bf35cfe65949b01ab1a85974c522fe7d6961",
  "original_prompt": "Ingested from linux-6.6.14/sound/core/pcm_misc.c",
  "human_readable_source": " \n  \n#include <linux/time.h>\n#include <linux/export.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n\n#include \"pcm_local.h\"\n\n#define SND_PCM_FORMAT_UNKNOWN (-1)\n\n \nstruct pcm_format_data {\n\tunsigned char width;\t \n\tunsigned char phys;\t \n\tsigned char le;\t \n\tsigned char signd;\t \n\tunsigned char silence[8];\t \n};\n\n \n#define INT\t__force int\n\nstatic bool valid_format(snd_pcm_format_t format)\n{\n\treturn (INT)format >= 0 && (INT)format <= (INT)SNDRV_PCM_FORMAT_LAST;\n}\n\nstatic const struct pcm_format_data pcm_formats[(INT)SNDRV_PCM_FORMAT_LAST+1] = {\n\t[SNDRV_PCM_FORMAT_S8] = {\n\t\t.width = 8, .phys = 8, .le = -1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U8] = {\n\t\t.width = 8, .phys = 8, .le = -1, .signd = 0,\n\t\t.silence = { 0x80 },\n\t},\n\t[SNDRV_PCM_FORMAT_S16_LE] = {\n\t\t.width = 16, .phys = 16, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S16_BE] = {\n\t\t.width = 16, .phys = 16, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U16_LE] = {\n\t\t.width = 16, .phys = 16, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x80 },\n\t},\n\t[SNDRV_PCM_FORMAT_U16_BE] = {\n\t\t.width = 16, .phys = 16, .le = 0, .signd = 0,\n\t\t.silence = { 0x80, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_S24_LE] = {\n\t\t.width = 24, .phys = 32, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S24_BE] = {\n\t\t.width = 24, .phys = 32, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U24_LE] = {\n\t\t.width = 24, .phys = 32, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x00, 0x80 },\n\t},\n\t[SNDRV_PCM_FORMAT_U24_BE] = {\n\t\t.width = 24, .phys = 32, .le = 0, .signd = 0,\n\t\t.silence = { 0x00, 0x80, 0x00, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_S32_LE] = {\n\t\t.width = 32, .phys = 32, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S32_BE] = {\n\t\t.width = 32, .phys = 32, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U32_LE] = {\n\t\t.width = 32, .phys = 32, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x00, 0x00, 0x80 },\n\t},\n\t[SNDRV_PCM_FORMAT_U32_BE] = {\n\t\t.width = 32, .phys = 32, .le = 0, .signd = 0,\n\t\t.silence = { 0x80, 0x00, 0x00, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_FLOAT_LE] = {\n\t\t.width = 32, .phys = 32, .le = 1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_FLOAT_BE] = {\n\t\t.width = 32, .phys = 32, .le = 0, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_FLOAT64_LE] = {\n\t\t.width = 64, .phys = 64, .le = 1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_FLOAT64_BE] = {\n\t\t.width = 64, .phys = 64, .le = 0, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_IEC958_SUBFRAME_LE] = {\n\t\t.width = 32, .phys = 32, .le = 1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_IEC958_SUBFRAME_BE] = {\n\t\t.width = 32, .phys = 32, .le = 0, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_MU_LAW] = {\n\t\t.width = 8, .phys = 8, .le = -1, .signd = -1,\n\t\t.silence = { 0x7f },\n\t},\n\t[SNDRV_PCM_FORMAT_A_LAW] = {\n\t\t.width = 8, .phys = 8, .le = -1, .signd = -1,\n\t\t.silence = { 0x55 },\n\t},\n\t[SNDRV_PCM_FORMAT_IMA_ADPCM] = {\n\t\t.width = 4, .phys = 4, .le = -1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_G723_24] = {\n\t\t.width = 3, .phys = 3, .le = -1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_G723_40] = {\n\t\t.width = 5, .phys = 5, .le = -1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_DSD_U8] = {\n\t\t.width = 8, .phys = 8, .le = 1, .signd = 0,\n\t\t.silence = { 0x69 },\n\t},\n\t[SNDRV_PCM_FORMAT_DSD_U16_LE] = {\n\t\t.width = 16, .phys = 16, .le = 1, .signd = 0,\n\t\t.silence = { 0x69, 0x69 },\n\t},\n\t[SNDRV_PCM_FORMAT_DSD_U32_LE] = {\n\t\t.width = 32, .phys = 32, .le = 1, .signd = 0,\n\t\t.silence = { 0x69, 0x69, 0x69, 0x69 },\n\t},\n\t[SNDRV_PCM_FORMAT_DSD_U16_BE] = {\n\t\t.width = 16, .phys = 16, .le = 0, .signd = 0,\n\t\t.silence = { 0x69, 0x69 },\n\t},\n\t[SNDRV_PCM_FORMAT_DSD_U32_BE] = {\n\t\t.width = 32, .phys = 32, .le = 0, .signd = 0,\n\t\t.silence = { 0x69, 0x69, 0x69, 0x69 },\n\t},\n\t \n\t[SNDRV_PCM_FORMAT_MPEG] = {\n\t\t.le = -1, .signd = -1,\n\t},\n\t[SNDRV_PCM_FORMAT_GSM] = {\n\t\t.le = -1, .signd = -1,\n\t},\n\t[SNDRV_PCM_FORMAT_S20_LE] = {\n\t\t.width = 20, .phys = 32, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S20_BE] = {\n\t\t.width = 20, .phys = 32, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U20_LE] = {\n\t\t.width = 20, .phys = 32, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x00, 0x08, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_U20_BE] = {\n\t\t.width = 20, .phys = 32, .le = 0, .signd = 0,\n\t\t.silence = { 0x00, 0x08, 0x00, 0x00 },\n\t},\n\t \n\t[SNDRV_PCM_FORMAT_SPECIAL] = {\n\t\t.le = -1, .signd = -1,\n\t},\n\t[SNDRV_PCM_FORMAT_S24_3LE] = {\n\t\t.width = 24, .phys = 24, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S24_3BE] = {\n\t\t.width = 24, .phys = 24, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U24_3LE] = {\n\t\t.width = 24, .phys = 24, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x00, 0x80 },\n\t},\n\t[SNDRV_PCM_FORMAT_U24_3BE] = {\n\t\t.width = 24, .phys = 24, .le = 0, .signd = 0,\n\t\t.silence = { 0x80, 0x00, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_S20_3LE] = {\n\t\t.width = 20, .phys = 24, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S20_3BE] = {\n\t\t.width = 20, .phys = 24, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U20_3LE] = {\n\t\t.width = 20, .phys = 24, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x00, 0x08 },\n\t},\n\t[SNDRV_PCM_FORMAT_U20_3BE] = {\n\t\t.width = 20, .phys = 24, .le = 0, .signd = 0,\n\t\t.silence = { 0x08, 0x00, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_S18_3LE] = {\n\t\t.width = 18, .phys = 24, .le = 1, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_S18_3BE] = {\n\t\t.width = 18, .phys = 24, .le = 0, .signd = 1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_U18_3LE] = {\n\t\t.width = 18, .phys = 24, .le = 1, .signd = 0,\n\t\t.silence = { 0x00, 0x00, 0x02 },\n\t},\n\t[SNDRV_PCM_FORMAT_U18_3BE] = {\n\t\t.width = 18, .phys = 24, .le = 0, .signd = 0,\n\t\t.silence = { 0x02, 0x00, 0x00 },\n\t},\n\t[SNDRV_PCM_FORMAT_G723_24_1B] = {\n\t\t.width = 3, .phys = 8, .le = -1, .signd = -1,\n\t\t.silence = {},\n\t},\n\t[SNDRV_PCM_FORMAT_G723_40_1B] = {\n\t\t.width = 5, .phys = 8, .le = -1, .signd = -1,\n\t\t.silence = {},\n\t},\n};\n\n\n \nint snd_pcm_format_signed(snd_pcm_format_t format)\n{\n\tint val;\n\tif (!valid_format(format))\n\t\treturn -EINVAL;\n\tval = pcm_formats[(INT)format].signd;\n\tif (val < 0)\n\t\treturn -EINVAL;\n\treturn val;\n}\nEXPORT_SYMBOL(snd_pcm_format_signed);\n\n \nint snd_pcm_format_unsigned(snd_pcm_format_t format)\n{\n\tint val;\n\n\tval = snd_pcm_format_signed(format);\n\tif (val < 0)\n\t\treturn val;\n\treturn !val;\n}\nEXPORT_SYMBOL(snd_pcm_format_unsigned);\n\n \nint snd_pcm_format_linear(snd_pcm_format_t format)\n{\n\treturn snd_pcm_format_signed(format) >= 0;\n}\nEXPORT_SYMBOL(snd_pcm_format_linear);\n\n \nint snd_pcm_format_little_endian(snd_pcm_format_t format)\n{\n\tint val;\n\tif (!valid_format(format))\n\t\treturn -EINVAL;\n\tval = pcm_formats[(INT)format].le;\n\tif (val < 0)\n\t\treturn -EINVAL;\n\treturn val;\n}\nEXPORT_SYMBOL(snd_pcm_format_little_endian);\n\n \nint snd_pcm_format_big_endian(snd_pcm_format_t format)\n{\n\tint val;\n\n\tval = snd_pcm_format_little_endian(format);\n\tif (val < 0)\n\t\treturn val;\n\treturn !val;\n}\nEXPORT_SYMBOL(snd_pcm_format_big_endian);\n\n \nint snd_pcm_format_width(snd_pcm_format_t format)\n{\n\tint val;\n\tif (!valid_format(format))\n\t\treturn -EINVAL;\n\tval = pcm_formats[(INT)format].width;\n\tif (!val)\n\t\treturn -EINVAL;\n\treturn val;\n}\nEXPORT_SYMBOL(snd_pcm_format_width);\n\n \nint snd_pcm_format_physical_width(snd_pcm_format_t format)\n{\n\tint val;\n\tif (!valid_format(format))\n\t\treturn -EINVAL;\n\tval = pcm_formats[(INT)format].phys;\n\tif (!val)\n\t\treturn -EINVAL;\n\treturn val;\n}\nEXPORT_SYMBOL(snd_pcm_format_physical_width);\n\n \nssize_t snd_pcm_format_size(snd_pcm_format_t format, size_t samples)\n{\n\tint phys_width = snd_pcm_format_physical_width(format);\n\tif (phys_width < 0)\n\t\treturn -EINVAL;\n\treturn samples * phys_width / 8;\n}\nEXPORT_SYMBOL(snd_pcm_format_size);\n\n \nconst unsigned char *snd_pcm_format_silence_64(snd_pcm_format_t format)\n{\n\tif (!valid_format(format))\n\t\treturn NULL;\n\tif (! pcm_formats[(INT)format].phys)\n\t\treturn NULL;\n\treturn pcm_formats[(INT)format].silence;\n}\nEXPORT_SYMBOL(snd_pcm_format_silence_64);\n\n \nint snd_pcm_format_set_silence(snd_pcm_format_t format, void *data, unsigned int samples)\n{\n\tint width;\n\tunsigned char *dst;\n\tconst unsigned char *pat;\n\n\tif (!valid_format(format))\n\t\treturn -EINVAL;\n\tif (samples == 0)\n\t\treturn 0;\n\twidth = pcm_formats[(INT)format].phys;  \n\tpat = pcm_formats[(INT)format].silence;\n\tif (!width || !pat)\n\t\treturn -EINVAL;\n\t \n\tif (pcm_formats[(INT)format].signd == 1 || width <= 8) {\n\t\tunsigned int bytes = samples * width / 8;\n\t\tmemset(data, *pat, bytes);\n\t\treturn 0;\n\t}\n\t \n\twidth /= 8;\n\tdst = data;\n#if 0\n\twhile (samples--) {\n\t\tmemcpy(dst, pat, width);\n\t\tdst += width;\n\t}\n#else\n\t \n\tswitch (width) {\n\tcase 2:\n\t\twhile (samples--) {\n\t\t\tmemcpy(dst, pat, 2);\n\t\t\tdst += 2;\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\twhile (samples--) {\n\t\t\tmemcpy(dst, pat, 3);\n\t\t\tdst += 3;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\twhile (samples--) {\n\t\t\tmemcpy(dst, pat, 4);\n\t\t\tdst += 4;\n\t\t}\n\t\tbreak;\n\tcase 8:\n\t\twhile (samples--) {\n\t\t\tmemcpy(dst, pat, 8);\n\t\t\tdst += 8;\n\t\t}\n\t\tbreak;\n\t}\n#endif\n\treturn 0;\n}\nEXPORT_SYMBOL(snd_pcm_format_set_silence);\n\n \nint snd_pcm_hw_limit_rates(struct snd_pcm_hardware *hw)\n{\n\tint i;\n\tfor (i = 0; i < (int)snd_pcm_known_rates.count; i++) {\n\t\tif (hw->rates & (1 << i)) {\n\t\t\thw->rate_min = snd_pcm_known_rates.list[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor (i = (int)snd_pcm_known_rates.count - 1; i >= 0; i--) {\n\t\tif (hw->rates & (1 << i)) {\n\t\t\thw->rate_max = snd_pcm_known_rates.list[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL(snd_pcm_hw_limit_rates);\n\n \nunsigned int snd_pcm_rate_to_rate_bit(unsigned int rate)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < snd_pcm_known_rates.count; i++)\n\t\tif (snd_pcm_known_rates.list[i] == rate)\n\t\t\treturn 1u << i;\n\treturn SNDRV_PCM_RATE_KNOT;\n}\nEXPORT_SYMBOL(snd_pcm_rate_to_rate_bit);\n\n \nunsigned int snd_pcm_rate_bit_to_rate(unsigned int rate_bit)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < snd_pcm_known_rates.count; i++)\n\t\tif ((1u << i) == rate_bit)\n\t\t\treturn snd_pcm_known_rates.list[i];\n\treturn 0;\n}\nEXPORT_SYMBOL(snd_pcm_rate_bit_to_rate);\n\nstatic unsigned int snd_pcm_rate_mask_sanitize(unsigned int rates)\n{\n\tif (rates & SNDRV_PCM_RATE_CONTINUOUS)\n\t\treturn SNDRV_PCM_RATE_CONTINUOUS;\n\telse if (rates & SNDRV_PCM_RATE_KNOT)\n\t\treturn SNDRV_PCM_RATE_KNOT;\n\treturn rates;\n}\n\n \nunsigned int snd_pcm_rate_mask_intersect(unsigned int rates_a,\n\tunsigned int rates_b)\n{\n\trates_a = snd_pcm_rate_mask_sanitize(rates_a);\n\trates_b = snd_pcm_rate_mask_sanitize(rates_b);\n\n\tif (rates_a & SNDRV_PCM_RATE_CONTINUOUS)\n\t\treturn rates_b;\n\telse if (rates_b & SNDRV_PCM_RATE_CONTINUOUS)\n\t\treturn rates_a;\n\telse if (rates_a & SNDRV_PCM_RATE_KNOT)\n\t\treturn rates_b;\n\telse if (rates_b & SNDRV_PCM_RATE_KNOT)\n\t\treturn rates_a;\n\treturn rates_a & rates_b;\n}\nEXPORT_SYMBOL_GPL(snd_pcm_rate_mask_intersect);\n\n \nunsigned int snd_pcm_rate_range_to_bits(unsigned int rate_min,\n\tunsigned int rate_max)\n{\n\tunsigned int rates = 0;\n\tint i;\n\n\tfor (i = 0; i < snd_pcm_known_rates.count; i++) {\n\t\tif (snd_pcm_known_rates.list[i] >= rate_min\n\t\t\t&& snd_pcm_known_rates.list[i] <= rate_max)\n\t\t\trates |= 1 << i;\n\t}\n\n\tif (!rates)\n\t\trates = SNDRV_PCM_RATE_KNOT;\n\n\treturn rates;\n}\nEXPORT_SYMBOL_GPL(snd_pcm_rate_range_to_bits);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}