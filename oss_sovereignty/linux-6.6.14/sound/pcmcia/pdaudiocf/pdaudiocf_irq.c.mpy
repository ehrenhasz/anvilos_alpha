{
  "module_name": "pdaudiocf_irq.c",
  "hash_id": "08506a4c4db88031baba26ca55fa9f8b9a27cc03663ad7b3fc74745ad0f19b62",
  "original_prompt": "Ingested from linux-6.6.14/sound/pcmcia/pdaudiocf/pdaudiocf_irq.c",
  "human_readable_source": "\n \n\n#include <sound/core.h>\n#include \"pdaudiocf.h\"\n#include <sound/initval.h>\n#include <asm/irq_regs.h>\n\n \nirqreturn_t pdacf_interrupt(int irq, void *dev)\n{\n\tstruct snd_pdacf *chip = dev;\n\tunsigned short stat;\n\tbool wake_thread = false;\n\n\tif ((chip->chip_status & (PDAUDIOCF_STAT_IS_STALE|\n\t\t\t\t  PDAUDIOCF_STAT_IS_CONFIGURED|\n\t\t\t\t  PDAUDIOCF_STAT_IS_SUSPENDED)) != PDAUDIOCF_STAT_IS_CONFIGURED)\n\t\treturn IRQ_HANDLED;\t \n\n\tstat = inw(chip->port + PDAUDIOCF_REG_ISR);\n\tif (stat & (PDAUDIOCF_IRQLVL|PDAUDIOCF_IRQOVR)) {\n\t\tif (stat & PDAUDIOCF_IRQOVR)\t \n\t\t\tsnd_printk(KERN_ERR \"PDAUDIOCF SRAM buffer overrun detected!\\n\");\n\t\tif (chip->pcm_substream)\n\t\t\twake_thread = true;\n\t\tif (!(stat & PDAUDIOCF_IRQAKM))\n\t\t\tstat |= PDAUDIOCF_IRQAKM;\t \n\t}\n\tif (get_irq_regs() != NULL)\n\t\tsnd_ak4117_check_rate_and_errors(chip->ak4117, 0);\n\treturn wake_thread ? IRQ_WAKE_THREAD : IRQ_HANDLED;\n}\n\nstatic inline void pdacf_transfer_mono16(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\n{\n\twhile (size-- > 0) {\n\t\t*dst++ = inw(rdp_port) ^ xor;\n\t\tinw(rdp_port);\n\t}\n}\n\nstatic inline void pdacf_transfer_mono32(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tinw(rdp_port);\n\t\t*dst++ = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\n\t}\n}\n\nstatic inline void pdacf_transfer_stereo16(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\n{\n\twhile (size-- > 0) {\n\t\t*dst++ = inw(rdp_port) ^ xor;\n\t\t*dst++ = inw(rdp_port) ^ xor;\n\t}\n}\n\nstatic inline void pdacf_transfer_stereo32(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2, val3;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tval3 = inw(rdp_port);\n\t\t*dst++ = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\n\t\t*dst++ = (((u32)val3 << 16) | (val2 & 0xff00)) ^ xor;\n\t}\n}\n\nstatic inline void pdacf_transfer_mono16sw(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\n{\n\twhile (size-- > 0) {\n\t\t*dst++ = swab16(inw(rdp_port) ^ xor);\n\t\tinw(rdp_port);\n\t}\n}\n\nstatic inline void pdacf_transfer_mono32sw(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tinw(rdp_port);\n\t\t*dst++ = swab32((((val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor);\n\t}\n}\n\nstatic inline void pdacf_transfer_stereo16sw(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\n{\n\twhile (size-- > 0) {\n\t\t*dst++ = swab16(inw(rdp_port) ^ xor);\n\t\t*dst++ = swab16(inw(rdp_port) ^ xor);\n\t}\n}\n\nstatic inline void pdacf_transfer_stereo32sw(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2, val3;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tval3 = inw(rdp_port);\n\t\t*dst++ = swab32((((val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor);\n\t\t*dst++ = swab32((((u32)val3 << 16) | (val2 & 0xff00)) ^ xor);\n\t}\n}\n\nstatic inline void pdacf_transfer_mono24le(u8 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2;\n\tregister u32 xval1;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tinw(rdp_port);\n\t\txval1 = (((val2 & 0xff) << 8) | (val1 << 16)) ^ xor;\n\t\t*dst++ = (u8)(xval1 >> 8);\n\t\t*dst++ = (u8)(xval1 >> 16);\n\t\t*dst++ = (u8)(xval1 >> 24);\n\t}\n}\n\nstatic inline void pdacf_transfer_mono24be(u8 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2;\n\tregister u32 xval1;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tinw(rdp_port);\n\t\txval1 = (((val2 & 0xff) << 8) | (val1 << 16)) ^ xor;\n\t\t*dst++ = (u8)(xval1 >> 24);\n\t\t*dst++ = (u8)(xval1 >> 16);\n\t\t*dst++ = (u8)(xval1 >> 8);\n\t}\n}\n\nstatic inline void pdacf_transfer_stereo24le(u8 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2, val3;\n\tregister u32 xval1, xval2;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tval3 = inw(rdp_port);\n\t\txval1 = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\n\t\txval2 = (((u32)val3 << 16) | (val2 & 0xff00)) ^ xor;\n\t\t*dst++ = (u8)(xval1 >> 8);\n\t\t*dst++ = (u8)(xval1 >> 16);\n\t\t*dst++ = (u8)(xval1 >> 24);\n\t\t*dst++ = (u8)(xval2 >> 8);\n\t\t*dst++ = (u8)(xval2 >> 16);\n\t\t*dst++ = (u8)(xval2 >> 24);\n\t}\n}\n\nstatic inline void pdacf_transfer_stereo24be(u8 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\n{\n\tregister u16 val1, val2, val3;\n\tregister u32 xval1, xval2;\n\n\twhile (size-- > 0) {\n\t\tval1 = inw(rdp_port);\n\t\tval2 = inw(rdp_port);\n\t\tval3 = inw(rdp_port);\n\t\txval1 = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\n\t\txval2 = (((u32)val3 << 16) | (val2 & 0xff00)) ^ xor;\n\t\t*dst++ = (u8)(xval1 >> 24);\n\t\t*dst++ = (u8)(xval1 >> 16);\n\t\t*dst++ = (u8)(xval1 >> 8);\n\t\t*dst++ = (u8)(xval2 >> 24);\n\t\t*dst++ = (u8)(xval2 >> 16);\n\t\t*dst++ = (u8)(xval2 >> 8);\n\t}\n}\n\nstatic void pdacf_transfer(struct snd_pdacf *chip, unsigned int size, unsigned int off)\n{\n\tunsigned long rdp_port = chip->port + PDAUDIOCF_REG_MD;\n\tunsigned int xor = chip->pcm_xor;\n\n\tif (chip->pcm_sample == 3) {\n\t\tif (chip->pcm_little) {\n\t\t\tif (chip->pcm_channels == 1) {\n\t\t\t\tpdacf_transfer_mono24le((char *)chip->pcm_area + (off * 3), xor, size, rdp_port);\n\t\t\t} else {\n\t\t\t\tpdacf_transfer_stereo24le((char *)chip->pcm_area + (off * 6), xor, size, rdp_port);\n\t\t\t}\n\t\t} else {\n\t\t\tif (chip->pcm_channels == 1) {\n\t\t\t\tpdacf_transfer_mono24be((char *)chip->pcm_area + (off * 3), xor, size, rdp_port);\n\t\t\t} else {\n\t\t\t\tpdacf_transfer_stereo24be((char *)chip->pcm_area + (off * 6), xor, size, rdp_port);\n\t\t\t}\t\t\t\n\t\t}\n\t\treturn;\n\t}\n\tif (chip->pcm_swab == 0) {\n\t\tif (chip->pcm_channels == 1) {\n\t\t\tif (chip->pcm_frame == 2) {\n\t\t\t\tpdacf_transfer_mono16((u16 *)chip->pcm_area + off, xor, size, rdp_port);\n\t\t\t} else {\n\t\t\t\tpdacf_transfer_mono32((u32 *)chip->pcm_area + off, xor, size, rdp_port);\n\t\t\t}\n\t\t} else {\n\t\t\tif (chip->pcm_frame == 2) {\n\t\t\t\tpdacf_transfer_stereo16((u16 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\n\t\t\t} else {\n\t\t\t\tpdacf_transfer_stereo32((u32 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (chip->pcm_channels == 1) {\n\t\t\tif (chip->pcm_frame == 2) {\n\t\t\t\tpdacf_transfer_mono16sw((u16 *)chip->pcm_area + off, xor, size, rdp_port);\n\t\t\t} else {\n\t\t\t\tpdacf_transfer_mono32sw((u32 *)chip->pcm_area + off, xor, size, rdp_port);\n\t\t\t}\n\t\t} else {\n\t\t\tif (chip->pcm_frame == 2) {\n\t\t\t\tpdacf_transfer_stereo16sw((u16 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\n\t\t\t} else {\n\t\t\t\tpdacf_transfer_stereo32sw((u32 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\n\t\t\t}\n\t\t}\n\t}\n}\n\nirqreturn_t pdacf_threaded_irq(int irq, void *dev)\n{\n\tstruct snd_pdacf *chip = dev;\n\tint size, off, cont, rdp, wdp;\n\n\tif ((chip->chip_status & (PDAUDIOCF_STAT_IS_STALE|PDAUDIOCF_STAT_IS_CONFIGURED)) != PDAUDIOCF_STAT_IS_CONFIGURED)\n\t\treturn IRQ_HANDLED;\n\t\n\tif (chip->pcm_substream == NULL || chip->pcm_substream->runtime == NULL || !snd_pcm_running(chip->pcm_substream))\n\t\treturn IRQ_HANDLED;\n\n\trdp = inw(chip->port + PDAUDIOCF_REG_RDP);\n\twdp = inw(chip->port + PDAUDIOCF_REG_WDP);\n\t \n\tsize = wdp - rdp;\n\tif (size < 0)\n\t\tsize += 0x10000;\n\tif (size == 0)\n\t\tsize = 0x10000;\n\tsize /= chip->pcm_frame;\n\tif (size > 64)\n\t\tsize -= 32;\n\n#if 0\n\tchip->pcm_hwptr += size;\n\tchip->pcm_hwptr %= chip->pcm_size;\n\tchip->pcm_tdone += size;\n\tif (chip->pcm_frame == 2) {\n\t\tunsigned long rdp_port = chip->port + PDAUDIOCF_REG_MD;\n\t\twhile (size-- > 0) {\n\t\t\tinw(rdp_port);\n\t\t\tinw(rdp_port);\n\t\t}\n\t} else {\n\t\tunsigned long rdp_port = chip->port + PDAUDIOCF_REG_MD;\n\t\twhile (size-- > 0) {\n\t\t\tinw(rdp_port);\n\t\t\tinw(rdp_port);\n\t\t\tinw(rdp_port);\n\t\t}\n\t}\n#else\n\toff = chip->pcm_hwptr + chip->pcm_tdone;\n\toff %= chip->pcm_size;\n\tchip->pcm_tdone += size;\n\twhile (size > 0) {\n\t\tcont = chip->pcm_size - off;\n\t\tif (cont > size)\n\t\t\tcont = size;\n\t\tpdacf_transfer(chip, cont, off);\n\t\toff += cont;\n\t\toff %= chip->pcm_size;\n\t\tsize -= cont;\n\t}\n#endif\n\tmutex_lock(&chip->reg_lock);\n\twhile (chip->pcm_tdone >= chip->pcm_period) {\n\t\tchip->pcm_hwptr += chip->pcm_period;\n\t\tchip->pcm_hwptr %= chip->pcm_size;\n\t\tchip->pcm_tdone -= chip->pcm_period;\n\t\tmutex_unlock(&chip->reg_lock);\n\t\tsnd_pcm_period_elapsed(chip->pcm_substream);\n\t\tmutex_lock(&chip->reg_lock);\n\t}\n\tmutex_unlock(&chip->reg_lock);\n\treturn IRQ_HANDLED;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}