{
  "module_name": "pdaudiocf.c",
  "hash_id": "533183e327f8d03c2f056bf76019d93588af8502ff785026562cd5fc645a941e",
  "original_prompt": "Ingested from linux-6.6.14/sound/pcmcia/pdaudiocf/pdaudiocf.c",
  "human_readable_source": "\n \n\n#include <sound/core.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <pcmcia/ciscode.h>\n#include <pcmcia/cisreg.h>\n#include \"pdaudiocf.h\"\n#include <sound/initval.h>\n#include <linux/init.h>\n\n \n\n#define CARD_NAME\t\"PDAudio-CF\"\n\nMODULE_AUTHOR(\"Jaroslav Kysela <perex@perex.cz>\");\nMODULE_DESCRIPTION(\"Sound Core \" CARD_NAME);\nMODULE_LICENSE(\"GPL\");\n\nstatic int index[SNDRV_CARDS] = SNDRV_DEFAULT_IDX;\t \nstatic char *id[SNDRV_CARDS] = SNDRV_DEFAULT_STR;\t \nstatic bool enable[SNDRV_CARDS] = SNDRV_DEFAULT_ENABLE_PNP;\t \n\nmodule_param_array(index, int, NULL, 0444);\nMODULE_PARM_DESC(index, \"Index value for \" CARD_NAME \" soundcard.\");\nmodule_param_array(id, charp, NULL, 0444);\nMODULE_PARM_DESC(id, \"ID string for \" CARD_NAME \" soundcard.\");\nmodule_param_array(enable, bool, NULL, 0444);\nMODULE_PARM_DESC(enable, \"Enable \" CARD_NAME \" soundcard.\");\n\n \n\nstatic struct snd_card *card_list[SNDRV_CARDS];\n\n \nstatic int pdacf_config(struct pcmcia_device *link);\nstatic void snd_pdacf_detach(struct pcmcia_device *p_dev);\n\nstatic void pdacf_release(struct pcmcia_device *link)\n{\n\tfree_irq(link->irq, link->priv);\n\tpcmcia_disable_device(link);\n}\n\n \nstatic int snd_pdacf_free(struct snd_pdacf *pdacf)\n{\n\tstruct pcmcia_device *link = pdacf->p_dev;\n\n\tpdacf_release(link);\n\n\tcard_list[pdacf->index] = NULL;\n\tpdacf->card = NULL;\n\n\tkfree(pdacf);\n\treturn 0;\n}\n\nstatic int snd_pdacf_dev_free(struct snd_device *device)\n{\n\tstruct snd_pdacf *chip = device->device_data;\n\treturn snd_pdacf_free(chip);\n}\n\n \nstatic int snd_pdacf_probe(struct pcmcia_device *link)\n{\n\tint i, err;\n\tstruct snd_pdacf *pdacf;\n\tstruct snd_card *card;\n\tstatic const struct snd_device_ops ops = {\n\t\t.dev_free =\tsnd_pdacf_dev_free,\n\t};\n\n\tsnd_printdd(KERN_DEBUG \"pdacf_attach called\\n\");\n\t \n\tfor (i = 0; i < SNDRV_CARDS; i++) {\n\t\tif (! card_list[i])\n\t\t\tbreak;\n\t}\n\tif (i >= SNDRV_CARDS) {\n\t\tsnd_printk(KERN_ERR \"pdacf: too many cards found\\n\");\n\t\treturn -EINVAL;\n\t}\n\tif (! enable[i])\n\t\treturn -ENODEV;  \n\n\t \n\terr = snd_card_new(&link->dev, index[i], id[i], THIS_MODULE,\n\t\t\t   0, &card);\n\tif (err < 0) {\n\t\tsnd_printk(KERN_ERR \"pdacf: cannot create a card instance\\n\");\n\t\treturn err;\n\t}\n\n\tpdacf = snd_pdacf_create(card);\n\tif (!pdacf) {\n\t\tsnd_card_free(card);\n\t\treturn -ENOMEM;\n\t}\n\n\terr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, pdacf, &ops);\n\tif (err < 0) {\n\t\tkfree(pdacf);\n\t\tsnd_card_free(card);\n\t\treturn err;\n\t}\n\n\tpdacf->index = i;\n\tcard_list[i] = card;\n\n\tpdacf->p_dev = link;\n\tlink->priv = pdacf;\n\n\tlink->resource[0]->flags |= IO_DATA_PATH_WIDTH_AUTO;\n\tlink->resource[0]->end = 16;\n\n\tlink->config_flags = CONF_ENABLE_IRQ | CONF_ENABLE_PULSE_IRQ;\n\tlink->config_index = 1;\n\tlink->config_regs = PRESENT_OPTION;\n\n\treturn pdacf_config(link);\n}\n\n\n \nstatic int snd_pdacf_assign_resources(struct snd_pdacf *pdacf, int port, int irq)\n{\n\tint err;\n\tstruct snd_card *card = pdacf->card;\n\n\tsnd_printdd(KERN_DEBUG \"pdacf assign resources: port = 0x%x, irq = %d\\n\", port, irq);\n\tpdacf->port = port;\n\tpdacf->irq = irq;\n\tpdacf->chip_status |= PDAUDIOCF_STAT_IS_CONFIGURED;\n\n\terr = snd_pdacf_ak4117_create(pdacf);\n\tif (err < 0)\n\t\treturn err;\t\n\n\tstrcpy(card->driver, \"PDAudio-CF\");\n\tsprintf(card->shortname, \"Core Sound %s\", card->driver);\n\tsprintf(card->longname, \"%s at 0x%x, irq %i\",\n\t\tcard->shortname, port, irq);\n\n\terr = snd_pdacf_pcm_new(pdacf);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = snd_card_register(card);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\n\n \nstatic void snd_pdacf_detach(struct pcmcia_device *link)\n{\n\tstruct snd_pdacf *chip = link->priv;\n\n\tsnd_printdd(KERN_DEBUG \"pdacf_detach called\\n\");\n\n\tif (chip->chip_status & PDAUDIOCF_STAT_IS_CONFIGURED)\n\t\tsnd_pdacf_powerdown(chip);\n\tchip->chip_status |= PDAUDIOCF_STAT_IS_STALE;  \n\tsnd_card_disconnect(chip->card);\n\tsnd_card_free_when_closed(chip->card);\n}\n\n \n\nstatic int pdacf_config(struct pcmcia_device *link)\n{\n\tstruct snd_pdacf *pdacf = link->priv;\n\tint ret;\n\n\tsnd_printdd(KERN_DEBUG \"pdacf_config called\\n\");\n\tlink->config_index = 0x5;\n\tlink->config_flags |= CONF_ENABLE_IRQ | CONF_ENABLE_PULSE_IRQ;\n\n\tret = pcmcia_request_io(link);\n\tif (ret)\n\t\tgoto failed_preirq;\n\n\tret = request_threaded_irq(link->irq, pdacf_interrupt,\n\t\t\t\t   pdacf_threaded_irq,\n\t\t\t\t   IRQF_SHARED, link->devname, link->priv);\n\tif (ret)\n\t\tgoto failed_preirq;\n\n\tret = pcmcia_enable_device(link);\n\tif (ret)\n\t\tgoto failed;\n\n\tif (snd_pdacf_assign_resources(pdacf, link->resource[0]->start,\n\t\t\t\t\tlink->irq) < 0)\n\t\tgoto failed;\n\n\tpdacf->card->sync_irq = link->irq;\n\treturn 0;\n\n failed:\n\tfree_irq(link->irq, link->priv);\nfailed_preirq:\n\tpcmcia_disable_device(link);\n\treturn -ENODEV;\n}\n\n#ifdef CONFIG_PM\n\nstatic int pdacf_suspend(struct pcmcia_device *link)\n{\n\tstruct snd_pdacf *chip = link->priv;\n\n\tsnd_printdd(KERN_DEBUG \"SUSPEND\\n\");\n\tif (chip) {\n\t\tsnd_printdd(KERN_DEBUG \"snd_pdacf_suspend calling\\n\");\n\t\tsnd_pdacf_suspend(chip);\n\t}\n\n\treturn 0;\n}\n\nstatic int pdacf_resume(struct pcmcia_device *link)\n{\n\tstruct snd_pdacf *chip = link->priv;\n\n\tsnd_printdd(KERN_DEBUG \"RESUME\\n\");\n\tif (pcmcia_dev_present(link)) {\n\t\tif (chip) {\n\t\t\tsnd_printdd(KERN_DEBUG \"calling snd_pdacf_resume\\n\");\n\t\t\tsnd_pdacf_resume(chip);\n\t\t}\n\t}\n\tsnd_printdd(KERN_DEBUG \"resume done!\\n\");\n\n\treturn 0;\n}\n\n#endif\n\n \nstatic const struct pcmcia_device_id snd_pdacf_ids[] = {\n\t \n\tPCMCIA_DEVICE_PROD_ID12(\"Core Sound\",\"PDAudio-CF\",0x396d19d2,0x71717b49),\n\tPCMCIA_DEVICE_NULL\n};\nMODULE_DEVICE_TABLE(pcmcia, snd_pdacf_ids);\n\nstatic struct pcmcia_driver pdacf_cs_driver = {\n\t.owner\t\t= THIS_MODULE,\n\t.name\t\t= \"snd-pdaudiocf\",\n\t.probe\t\t= snd_pdacf_probe,\n\t.remove\t\t= snd_pdacf_detach,\n\t.id_table\t= snd_pdacf_ids,\n#ifdef CONFIG_PM\n\t.suspend\t= pdacf_suspend,\n\t.resume\t\t= pdacf_resume,\n#endif\n};\nmodule_pcmcia_driver(pdacf_cs_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}