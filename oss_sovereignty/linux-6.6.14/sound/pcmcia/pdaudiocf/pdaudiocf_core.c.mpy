{
  "module_name": "pdaudiocf_core.c",
  "hash_id": "d8497f54ff7907fa3674b0416caa6a7393e09b25e29669fa5ae606e361383f42",
  "original_prompt": "Ingested from linux-6.6.14/sound/pcmcia/pdaudiocf/pdaudiocf_core.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <sound/core.h>\n#include <sound/info.h>\n#include \"pdaudiocf.h\"\n#include <sound/initval.h>\n\n \nstatic unsigned char pdacf_ak4117_read(void *private_data, unsigned char reg)\n{\n\tstruct snd_pdacf *chip = private_data;\n\tunsigned long timeout;\n\tunsigned long flags;\n\tunsigned char res;\n\n\tspin_lock_irqsave(&chip->ak4117_lock, flags);\n\ttimeout = 1000;\n\twhile (pdacf_reg_read(chip, PDAUDIOCF_REG_SCR) & PDAUDIOCF_AK_SBP) {\n\t\tudelay(5);\n\t\tif (--timeout == 0) {\n\t\t\tspin_unlock_irqrestore(&chip->ak4117_lock, flags);\n\t\t\tsnd_printk(KERN_ERR \"AK4117 ready timeout (read)\\n\");\n\t\t\treturn 0;\n\t\t}\n\t}\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_AK_IFR, (u16)reg << 8);\n\ttimeout = 1000;\n\twhile (pdacf_reg_read(chip, PDAUDIOCF_REG_SCR) & PDAUDIOCF_AK_SBP) {\n\t\tudelay(5);\n\t\tif (--timeout == 0) {\n\t\t\tspin_unlock_irqrestore(&chip->ak4117_lock, flags);\n\t\t\tsnd_printk(KERN_ERR \"AK4117 read timeout (read2)\\n\");\n\t\t\treturn 0;\n\t\t}\n\t}\n\tres = (unsigned char)pdacf_reg_read(chip, PDAUDIOCF_REG_AK_IFR);\n\tspin_unlock_irqrestore(&chip->ak4117_lock, flags);\n\treturn res;\n}\n\nstatic void pdacf_ak4117_write(void *private_data, unsigned char reg, unsigned char val)\n{\n\tstruct snd_pdacf *chip = private_data;\n\tunsigned long timeout;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&chip->ak4117_lock, flags);\n\ttimeout = 1000;\n\twhile (inw(chip->port + PDAUDIOCF_REG_SCR) & PDAUDIOCF_AK_SBP) {\n\t\tudelay(5);\n\t\tif (--timeout == 0) {\n\t\t\tspin_unlock_irqrestore(&chip->ak4117_lock, flags);\n\t\t\tsnd_printk(KERN_ERR \"AK4117 ready timeout (write)\\n\");\n\t\t\treturn;\n\t\t}\n\t}\n\toutw((u16)reg << 8 | val | (1<<13), chip->port + PDAUDIOCF_REG_AK_IFR);\n\tspin_unlock_irqrestore(&chip->ak4117_lock, flags);\n}\n\n#if 0\nvoid pdacf_dump(struct snd_pdacf *chip)\n{\n\tprintk(KERN_DEBUG \"PDAUDIOCF DUMP (0x%lx):\\n\", chip->port);\n\tprintk(KERN_DEBUG \"WPD         : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_WDP));\n\tprintk(KERN_DEBUG \"RDP         : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_RDP));\n\tprintk(KERN_DEBUG \"TCR         : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_TCR));\n\tprintk(KERN_DEBUG \"SCR         : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_SCR));\n\tprintk(KERN_DEBUG \"ISR         : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_ISR));\n\tprintk(KERN_DEBUG \"IER         : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_IER));\n\tprintk(KERN_DEBUG \"AK_IFR      : 0x%x\\n\",\n\t       inw(chip->port + PDAUDIOCF_REG_AK_IFR));\n}\n#endif\n\nstatic int pdacf_reset(struct snd_pdacf *chip, int powerdown)\n{\n\tu16 val;\n\t\n\tval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\n\tval |= PDAUDIOCF_PDN;\n\tval &= ~PDAUDIOCF_RECORD;\t\t \n\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\tudelay(5);\n\tval |= PDAUDIOCF_RST;\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\tudelay(200);\n\tval &= ~PDAUDIOCF_RST;\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\tudelay(5);\n\tif (!powerdown) {\n\t\tval &= ~PDAUDIOCF_PDN;\n\t\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\t\tudelay(200);\n\t}\n\treturn 0;\n}\n\nvoid pdacf_reinit(struct snd_pdacf *chip, int resume)\n{\n\tpdacf_reset(chip, 0);\n\tif (resume)\n\t\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, chip->suspend_reg_scr);\n\tsnd_ak4117_reinit(chip->ak4117);\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_TCR, chip->regmap[PDAUDIOCF_REG_TCR>>1]);\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_IER, chip->regmap[PDAUDIOCF_REG_IER>>1]);\n}\n\nstatic void pdacf_proc_read(struct snd_info_entry * entry,\n                            struct snd_info_buffer *buffer)\n{\n\tstruct snd_pdacf *chip = entry->private_data;\n\tu16 tmp;\n\n\tsnd_iprintf(buffer, \"PDAudioCF\\n\\n\");\n\ttmp = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\n\tsnd_iprintf(buffer, \"FPGA revision      : 0x%x\\n\", PDAUDIOCF_FPGAREV(tmp));\n\t                                   \n}\n\nstatic void pdacf_proc_init(struct snd_pdacf *chip)\n{\n\tsnd_card_ro_proc_new(chip->card, \"pdaudiocf\", chip, pdacf_proc_read);\n}\n\nstruct snd_pdacf *snd_pdacf_create(struct snd_card *card)\n{\n\tstruct snd_pdacf *chip;\n\n\tchip = kzalloc(sizeof(*chip), GFP_KERNEL);\n\tif (chip == NULL)\n\t\treturn NULL;\n\tchip->card = card;\n\tmutex_init(&chip->reg_lock);\n\tspin_lock_init(&chip->ak4117_lock);\n\tcard->private_data = chip;\n\n\tpdacf_proc_init(chip);\n\treturn chip;\n}\n\nstatic void snd_pdacf_ak4117_change(struct ak4117 *ak4117, unsigned char c0, unsigned char c1)\n{\n\tstruct snd_pdacf *chip = ak4117->change_callback_private;\n\tu16 val;\n\n\tif (!(c0 & AK4117_UNLCK))\n\t\treturn;\n\tmutex_lock(&chip->reg_lock);\n\tval = chip->regmap[PDAUDIOCF_REG_SCR>>1];\n\tif (ak4117->rcs0 & AK4117_UNLCK)\n\t\tval |= PDAUDIOCF_BLUE_LED_OFF;\n\telse\n\t\tval &= ~PDAUDIOCF_BLUE_LED_OFF;\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\tmutex_unlock(&chip->reg_lock);\n}\n\nint snd_pdacf_ak4117_create(struct snd_pdacf *chip)\n{\n\tint err;\n\tu16 val;\n\t \n\t \n\t \n\t \n\tstatic const unsigned char pgm[5] = {\n\t\tAK4117_XTL_24_576M | AK4117_EXCT,\t\t\t\t \n\t\tAK4117_CM_PLL_XTAL | AK4117_PKCS_128fs | AK4117_XCKS_128fs,\t \n\t\tAK4117_EFH_1024LRCLK | AK4117_DIF_24R | AK4117_IPS,\t\t \n\t\t0xff,\t\t\t\t\t\t\t\t \n\t\tAK4117_MAUTO | AK4117_MAUD | AK4117_MULK | AK4117_MPAR | AK4117_MV,  \n\t};\n\n\terr = pdacf_reset(chip, 0);\n\tif (err < 0)\n\t\treturn err;\n\terr = snd_ak4117_create(chip->card, pdacf_ak4117_read, pdacf_ak4117_write, pgm, chip, &chip->ak4117);\n\tif (err < 0)\n\t\treturn err;\n\n\tval = pdacf_reg_read(chip, PDAUDIOCF_REG_TCR);\n#if 1  \n\tval &= ~(PDAUDIOCF_ELIMAKMBIT|PDAUDIOCF_TESTDATASEL);\n#else  \n\tval |= PDAUDIOCF_ELIMAKMBIT;\n\tval &= ~PDAUDIOCF_TESTDATASEL;\n#endif\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_TCR, val);\n\t\n\t \n\tval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\n\tval &= ~(PDAUDIOCF_CLKDIV0 | PDAUDIOCF_CLKDIV1);\t\t \n\tval &= ~(PDAUDIOCF_RED_LED_OFF|PDAUDIOCF_BLUE_LED_OFF);\n\tval |= PDAUDIOCF_DATAFMT0 | PDAUDIOCF_DATAFMT1;\t\t\t \n\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\n\t \n\tval = pdacf_reg_read(chip, PDAUDIOCF_REG_IER);\n\tval &= ~(PDAUDIOCF_IRQLVLEN0 | PDAUDIOCF_IRQLVLEN1);\n\tval &= ~(PDAUDIOCF_BLUEDUTY0 | PDAUDIOCF_REDDUTY0 | PDAUDIOCF_REDDUTY1);\n\tval |= PDAUDIOCF_BLUEDUTY1 | PDAUDIOCF_HALFRATE;\n\tval |= PDAUDIOCF_IRQOVREN | PDAUDIOCF_IRQAKMEN;\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_IER, val);\n\n\tchip->ak4117->change_callback_private = chip;\n\tchip->ak4117->change_callback = snd_pdacf_ak4117_change;\n\n\t \n\tsnd_pdacf_ak4117_change(chip->ak4117, AK4117_UNLCK, 0);\n\n\treturn 0;\n}\n\nvoid snd_pdacf_powerdown(struct snd_pdacf *chip)\n{\n\tu16 val;\n\n\tval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\n\tchip->suspend_reg_scr = val;\n\tval |= PDAUDIOCF_RED_LED_OFF | PDAUDIOCF_BLUE_LED_OFF;\n\tpdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\n\t \n\tval = inw(chip->port + PDAUDIOCF_REG_IER);\n\tval &= ~(PDAUDIOCF_IRQOVREN|PDAUDIOCF_IRQAKMEN|PDAUDIOCF_IRQLVLEN0|PDAUDIOCF_IRQLVLEN1);\n\toutw(val, chip->port + PDAUDIOCF_REG_IER);\n\tpdacf_reset(chip, 1);\n}\n\n#ifdef CONFIG_PM\n\nint snd_pdacf_suspend(struct snd_pdacf *chip)\n{\n\tu16 val;\n\t\n\tsnd_power_change_state(chip->card, SNDRV_CTL_POWER_D3hot);\n\t \n\tval = inw(chip->port + PDAUDIOCF_REG_IER);\n\tval &= ~(PDAUDIOCF_IRQOVREN|PDAUDIOCF_IRQAKMEN|PDAUDIOCF_IRQLVLEN0|PDAUDIOCF_IRQLVLEN1);\n\toutw(val, chip->port + PDAUDIOCF_REG_IER);\n\tchip->chip_status |= PDAUDIOCF_STAT_IS_SUSPENDED;\t \n\tsnd_pdacf_powerdown(chip);\n\treturn 0;\n}\n\nstatic inline int check_signal(struct snd_pdacf *chip)\n{\n\treturn (chip->ak4117->rcs0 & AK4117_UNLCK) == 0;\n}\n\nint snd_pdacf_resume(struct snd_pdacf *chip)\n{\n\tint timeout = 40;\n\n\tpdacf_reinit(chip, 1);\n\t \n\twhile (timeout-- > 0 &&\n\t       (snd_ak4117_external_rate(chip->ak4117) <= 0 || !check_signal(chip)))\n\t\tmdelay(1);\n\tchip->chip_status &= ~PDAUDIOCF_STAT_IS_SUSPENDED;\n\tsnd_power_change_state(chip->card, SNDRV_CTL_POWER_D0);\n\treturn 0;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}