{
  "module_name": "midi.c",
  "hash_id": "0d3f626a0f9ab9f5f13a8157ba9b6dee6bdb78d5426a9a0f94bba195eb737463",
  "original_prompt": "Ingested from linux-6.6.14/sound/usb/caiaq/midi.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/usb.h>\n#include <linux/gfp.h>\n#include <sound/rawmidi.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n\n#include \"device.h\"\n#include \"midi.h\"\n\nstatic int snd_usb_caiaq_midi_input_open(struct snd_rawmidi_substream *substream)\n{\n\treturn 0;\n}\n\nstatic int snd_usb_caiaq_midi_input_close(struct snd_rawmidi_substream *substream)\n{\n\treturn 0;\n}\n\nstatic void snd_usb_caiaq_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\n{\n\tstruct snd_usb_caiaqdev *cdev = substream->rmidi->private_data;\n\n\tif (!cdev)\n\t\treturn;\n\n\tcdev->midi_receive_substream = up ? substream : NULL;\n}\n\n\nstatic int snd_usb_caiaq_midi_output_open(struct snd_rawmidi_substream *substream)\n{\n\treturn 0;\n}\n\nstatic int snd_usb_caiaq_midi_output_close(struct snd_rawmidi_substream *substream)\n{\n\tstruct snd_usb_caiaqdev *cdev = substream->rmidi->private_data;\n\tif (cdev->midi_out_active) {\n\t\tusb_kill_urb(&cdev->midi_out_urb);\n\t\tcdev->midi_out_active = 0;\n\t}\n\treturn 0;\n}\n\nstatic void snd_usb_caiaq_midi_send(struct snd_usb_caiaqdev *cdev,\n\t\t\t\t    struct snd_rawmidi_substream *substream)\n{\n\tint len, ret;\n\tstruct device *dev = caiaqdev_to_dev(cdev);\n\n\tcdev->midi_out_buf[0] = EP1_CMD_MIDI_WRITE;\n\tcdev->midi_out_buf[1] = 0;  \n\tlen = snd_rawmidi_transmit(substream, cdev->midi_out_buf + 3,\n\t\t\t\t   EP1_BUFSIZE - 3);\n\n\tif (len <= 0)\n\t\treturn;\n\n\tcdev->midi_out_buf[2] = len;\n\tcdev->midi_out_urb.transfer_buffer_length = len+3;\n\n\tret = usb_submit_urb(&cdev->midi_out_urb, GFP_ATOMIC);\n\tif (ret < 0)\n\t\tdev_err(dev,\n\t\t\t\"snd_usb_caiaq_midi_send(%p): usb_submit_urb() failed,\"\n\t\t\t\"ret=%d, len=%d\\n\", substream, ret, len);\n\telse\n\t\tcdev->midi_out_active = 1;\n}\n\nstatic void snd_usb_caiaq_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\n{\n\tstruct snd_usb_caiaqdev *cdev = substream->rmidi->private_data;\n\n\tif (up) {\n\t\tcdev->midi_out_substream = substream;\n\t\tif (!cdev->midi_out_active)\n\t\t\tsnd_usb_caiaq_midi_send(cdev, substream);\n\t} else {\n\t\tcdev->midi_out_substream = NULL;\n\t}\n}\n\n\nstatic const struct snd_rawmidi_ops snd_usb_caiaq_midi_output =\n{\n\t.open =\t\tsnd_usb_caiaq_midi_output_open,\n\t.close =\tsnd_usb_caiaq_midi_output_close,\n\t.trigger =      snd_usb_caiaq_midi_output_trigger,\n};\n\nstatic const struct snd_rawmidi_ops snd_usb_caiaq_midi_input =\n{\n\t.open =\t\tsnd_usb_caiaq_midi_input_open,\n\t.close =\tsnd_usb_caiaq_midi_input_close,\n\t.trigger =      snd_usb_caiaq_midi_input_trigger,\n};\n\nvoid snd_usb_caiaq_midi_handle_input(struct snd_usb_caiaqdev *cdev,\n\t\t\t\t     int port, const char *buf, int len)\n{\n\tif (!cdev->midi_receive_substream)\n\t\treturn;\n\n\tsnd_rawmidi_receive(cdev->midi_receive_substream, buf, len);\n}\n\nint snd_usb_caiaq_midi_init(struct snd_usb_caiaqdev *device)\n{\n\tint ret;\n\tstruct snd_rawmidi *rmidi;\n\n\tret = snd_rawmidi_new(device->chip.card, device->product_name, 0,\n\t\t\t\t\tdevice->spec.num_midi_out,\n\t\t\t\t\tdevice->spec.num_midi_in,\n\t\t\t\t\t&rmidi);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\tstrscpy(rmidi->name, device->product_name, sizeof(rmidi->name));\n\n\trmidi->info_flags = SNDRV_RAWMIDI_INFO_DUPLEX;\n\trmidi->private_data = device;\n\n\tif (device->spec.num_midi_out > 0) {\n\t\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\n\t\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\n\t\t\t\t    &snd_usb_caiaq_midi_output);\n\t}\n\n\tif (device->spec.num_midi_in > 0) {\n\t\trmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\n\t\tsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\n\t\t\t\t    &snd_usb_caiaq_midi_input);\n\t}\n\n\tdevice->rmidi = rmidi;\n\n\treturn 0;\n}\n\nvoid snd_usb_caiaq_midi_output_done(struct urb* urb)\n{\n\tstruct snd_usb_caiaqdev *cdev = urb->context;\n\n\tcdev->midi_out_active = 0;\n\tif (urb->status != 0)\n\t\treturn;\n\n\tif (!cdev->midi_out_substream)\n\t\treturn;\n\n\tsnd_usb_caiaq_midi_send(cdev, cdev->midi_out_substream);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}