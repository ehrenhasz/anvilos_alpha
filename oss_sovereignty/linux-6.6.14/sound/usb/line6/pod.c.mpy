{
  "module_name": "pod.c",
  "hash_id": "0ab1b5e69d43b9e057ede4ab000be3ecb3338f9300b42061fd2f473202f6ba48",
  "original_prompt": "Ingested from linux-6.6.14/sound/usb/line6/pod.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include <linux/wait.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/usb.h>\n\n#include <sound/core.h>\n#include <sound/control.h>\n\n#include \"capture.h\"\n#include \"driver.h\"\n#include \"playback.h\"\n\n \n#define\tPOD_NAME_OFFSET 0\n#define\tPOD_NAME_LENGTH 16\n\n \n#define POD_CONTROL_SIZE 0x80\n#define POD_BUFSIZE_DUMPREQ 7\n#define POD_STARTUP_DELAY 1000\n\n \nenum {\n\tPOD_STARTUP_VERSIONREQ,\n\tPOD_STARTUP_SETUP,\n\tPOD_STARTUP_DONE,\n};\n\nenum {\n\tLINE6_BASSPODXT,\n\tLINE6_BASSPODXTLIVE,\n\tLINE6_BASSPODXTPRO,\n\tLINE6_POCKETPOD,\n\tLINE6_PODXT,\n\tLINE6_PODXTLIVE_POD,\n\tLINE6_PODXTPRO,\n};\n\nstruct usb_line6_pod {\n\t \n\tstruct usb_line6 line6;\n\n\t \n\tint monitor_level;\n\n\t \n\tint startup_progress;\n\n\t \n\tu32 serial_number;\n\n\t \n\tint firmware_version;\n\n\t \n\tint device_id;\n};\n\n#define line6_to_pod(x)\t\tcontainer_of(x, struct usb_line6_pod, line6)\n\n#define POD_SYSEX_CODE 3\n\n \n\nenum {\n\tPOD_SYSEX_SAVE      = 0x24,\n\tPOD_SYSEX_SYSTEM    = 0x56,\n\tPOD_SYSEX_SYSTEMREQ = 0x57,\n\t    \n\tPOD_SYSEX_STORE     = 0x71,\n\tPOD_SYSEX_FINISH    = 0x72,\n\tPOD_SYSEX_DUMPMEM   = 0x73,\n\tPOD_SYSEX_DUMP      = 0x74,\n\tPOD_SYSEX_DUMPREQ   = 0x75\n\n\t \n\t \n};\n\nenum {\n\tPOD_MONITOR_LEVEL  = 0x04,\n\tPOD_SYSTEM_INVALID = 0x10000\n};\n\n \n\nenum {\n\tPOD_DUMP_MEMORY = 2\n};\n\nenum {\n\tPOD_BUSY_READ,\n\tPOD_BUSY_WRITE,\n\tPOD_CHANNEL_DIRTY,\n\tPOD_SAVE_PRESSED,\n\tPOD_BUSY_MIDISEND\n};\n\nstatic const struct snd_ratden pod_ratden = {\n\t.num_min = 78125,\n\t.num_max = 78125,\n\t.num_step = 1,\n\t.den = 2\n};\n\nstatic struct line6_pcm_properties pod_pcm_properties = {\n\t.playback_hw = {\n\t\t\t\t  .info = (SNDRV_PCM_INFO_MMAP |\n\t\t\t\t\t   SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t\t\t   SNDRV_PCM_INFO_BLOCK_TRANSFER |\n\t\t\t\t\t   SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t\t\t   SNDRV_PCM_INFO_PAUSE |\n\t\t\t\t\t   SNDRV_PCM_INFO_SYNC_START),\n\t\t\t\t  .formats = SNDRV_PCM_FMTBIT_S24_3LE,\n\t\t\t\t  .rates = SNDRV_PCM_RATE_KNOT,\n\t\t\t\t  .rate_min = 39062,\n\t\t\t\t  .rate_max = 39063,\n\t\t\t\t  .channels_min = 2,\n\t\t\t\t  .channels_max = 2,\n\t\t\t\t  .buffer_bytes_max = 60000,\n\t\t\t\t  .period_bytes_min = 64,\n\t\t\t\t  .period_bytes_max = 8192,\n\t\t\t\t  .periods_min = 1,\n\t\t\t\t  .periods_max = 1024},\n\t.capture_hw = {\n\t\t\t\t .info = (SNDRV_PCM_INFO_MMAP |\n\t\t\t\t\t  SNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t\t\t  SNDRV_PCM_INFO_BLOCK_TRANSFER |\n\t\t\t\t\t  SNDRV_PCM_INFO_MMAP_VALID |\n\t\t\t\t\t  SNDRV_PCM_INFO_SYNC_START),\n\t\t\t\t .formats = SNDRV_PCM_FMTBIT_S24_3LE,\n\t\t\t\t .rates = SNDRV_PCM_RATE_KNOT,\n\t\t\t\t .rate_min = 39062,\n\t\t\t\t .rate_max = 39063,\n\t\t\t\t .channels_min = 2,\n\t\t\t\t .channels_max = 2,\n\t\t\t\t .buffer_bytes_max = 60000,\n\t\t\t\t .period_bytes_min = 64,\n\t\t\t\t .period_bytes_max = 8192,\n\t\t\t\t .periods_min = 1,\n\t\t\t\t .periods_max = 1024},\n\t.rates = {\n\t\t\t    .nrats = 1,\n\t\t\t    .rats = &pod_ratden},\n\t.bytes_per_channel = 3  \n};\n\n\nstatic const char pod_version_header[] = {\n\t0xf0, 0x7e, 0x7f, 0x06, 0x02\n};\n\nstatic char *pod_alloc_sysex_buffer(struct usb_line6_pod *pod, int code,\n\t\t\t\t    int size)\n{\n\treturn line6_alloc_sysex_buffer(&pod->line6, POD_SYSEX_CODE, code,\n\t\t\t\t\tsize);\n}\n\n \nstatic void line6_pod_process_message(struct usb_line6 *line6)\n{\n\tstruct usb_line6_pod *pod = line6_to_pod(line6);\n\tconst unsigned char *buf = pod->line6.buffer_message;\n\n\tif (memcmp(buf, pod_version_header, sizeof(pod_version_header)) == 0) {\n\t\tpod->firmware_version = buf[13] * 100 + buf[14] * 10 + buf[15];\n\t\tpod->device_id = ((int)buf[8] << 16) | ((int)buf[9] << 8) |\n\t\t\t\t (int) buf[10];\n\t\tif (pod->startup_progress == POD_STARTUP_VERSIONREQ) {\n\t\t\tpod->startup_progress = POD_STARTUP_SETUP;\n\t\t\tschedule_delayed_work(&line6->startup_work, 0);\n\t\t}\n\t\treturn;\n\t}\n\n\t \n\tif (buf[0] != (LINE6_SYSEX_BEGIN | LINE6_CHANNEL_DEVICE) &&\n\t    buf[0] != (LINE6_SYSEX_BEGIN | LINE6_CHANNEL_UNKNOWN)) {\n\t\treturn;\n\t}\n\tif (memcmp(buf + 1, line6_midi_id, sizeof(line6_midi_id)) != 0)\n\t\treturn;\n\n\tif (buf[5] == POD_SYSEX_SYSTEM && buf[6] == POD_MONITOR_LEVEL) {\n\t\tshort value = ((int)buf[7] << 12) | ((int)buf[8] << 8) |\n\t\t\t      ((int)buf[9] << 4) | (int)buf[10];\n\t\tpod->monitor_level = value;\n\t}\n}\n\n \nstatic int pod_set_system_param_int(struct usb_line6_pod *pod, int value,\n\t\t\t\t    int code)\n{\n\tchar *sysex;\n\tstatic const int size = 5;\n\n\tsysex = pod_alloc_sysex_buffer(pod, POD_SYSEX_SYSTEM, size);\n\tif (!sysex)\n\t\treturn -ENOMEM;\n\tsysex[SYSEX_DATA_OFS] = code;\n\tsysex[SYSEX_DATA_OFS + 1] = (value >> 12) & 0x0f;\n\tsysex[SYSEX_DATA_OFS + 2] = (value >> 8) & 0x0f;\n\tsysex[SYSEX_DATA_OFS + 3] = (value >> 4) & 0x0f;\n\tsysex[SYSEX_DATA_OFS + 4] = (value) & 0x0f;\n\tline6_send_sysex_message(&pod->line6, sysex, size);\n\tkfree(sysex);\n\treturn 0;\n}\n\n \nstatic ssize_t serial_number_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct snd_card *card = dev_to_snd_card(dev);\n\tstruct usb_line6_pod *pod = card->private_data;\n\n\treturn sysfs_emit(buf, \"%u\\n\", pod->serial_number);\n}\n\n \nstatic ssize_t firmware_version_show(struct device *dev,\n\t\t\t\t     struct device_attribute *attr, char *buf)\n{\n\tstruct snd_card *card = dev_to_snd_card(dev);\n\tstruct usb_line6_pod *pod = card->private_data;\n\n\treturn sysfs_emit(buf, \"%d.%02d\\n\", pod->firmware_version / 100,\n\t\t\t  pod->firmware_version % 100);\n}\n\n \nstatic ssize_t device_id_show(struct device *dev,\n\t\t\t      struct device_attribute *attr, char *buf)\n{\n\tstruct snd_card *card = dev_to_snd_card(dev);\n\tstruct usb_line6_pod *pod = card->private_data;\n\n\treturn sysfs_emit(buf, \"%d\\n\", pod->device_id);\n}\n\n \n\nstatic void pod_startup(struct usb_line6 *line6)\n{\n\tstruct usb_line6_pod *pod = line6_to_pod(line6);\n\n\tswitch (pod->startup_progress) {\n\tcase POD_STARTUP_VERSIONREQ:\n\t\t \n\t\tline6_version_request_async(line6);\n\t\tbreak;\n\tcase POD_STARTUP_SETUP:\n\t\t \n\t\tline6_read_serial_number(&pod->line6, &pod->serial_number);\n\n\t\t \n\t\tif (snd_card_register(line6->card))\n\t\t\tdev_err(line6->ifcdev, \"Failed to register POD card.\\n\");\n\t\tpod->startup_progress = POD_STARTUP_DONE;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n \nstatic DEVICE_ATTR_RO(device_id);\nstatic DEVICE_ATTR_RO(firmware_version);\nstatic DEVICE_ATTR_RO(serial_number);\n\nstatic struct attribute *pod_dev_attrs[] = {\n\t&dev_attr_device_id.attr,\n\t&dev_attr_firmware_version.attr,\n\t&dev_attr_serial_number.attr,\n\tNULL\n};\n\nstatic const struct attribute_group pod_dev_attr_group = {\n\t.name = \"pod\",\n\t.attrs = pod_dev_attrs,\n};\n\n \nstatic int snd_pod_control_monitor_info(struct snd_kcontrol *kcontrol,\n\t\t\t\t\tstruct snd_ctl_elem_info *uinfo)\n{\n\tuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\n\tuinfo->count = 1;\n\tuinfo->value.integer.min = 0;\n\tuinfo->value.integer.max = 65535;\n\treturn 0;\n}\n\n \nstatic int snd_pod_control_monitor_get(struct snd_kcontrol *kcontrol,\n\t\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\n\tstruct usb_line6_pod *pod = line6_to_pod(line6pcm->line6);\n\n\tucontrol->value.integer.value[0] = pod->monitor_level;\n\treturn 0;\n}\n\n \nstatic int snd_pod_control_monitor_put(struct snd_kcontrol *kcontrol,\n\t\t\t\t       struct snd_ctl_elem_value *ucontrol)\n{\n\tstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\n\tstruct usb_line6_pod *pod = line6_to_pod(line6pcm->line6);\n\n\tif (ucontrol->value.integer.value[0] == pod->monitor_level)\n\t\treturn 0;\n\n\tpod->monitor_level = ucontrol->value.integer.value[0];\n\tpod_set_system_param_int(pod, ucontrol->value.integer.value[0],\n\t\t\t\t POD_MONITOR_LEVEL);\n\treturn 1;\n}\n\n \nstatic const struct snd_kcontrol_new pod_control_monitor = {\n\t.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\n\t.name = \"Monitor Playback Volume\",\n\t.index = 0,\n\t.access = SNDRV_CTL_ELEM_ACCESS_READWRITE,\n\t.info = snd_pod_control_monitor_info,\n\t.get = snd_pod_control_monitor_get,\n\t.put = snd_pod_control_monitor_put\n};\n\n \nstatic int pod_init(struct usb_line6 *line6,\n\t\t    const struct usb_device_id *id)\n{\n\tint err;\n\tstruct usb_line6_pod *pod = line6_to_pod(line6);\n\n\tline6->process_message = line6_pod_process_message;\n\tline6->startup = pod_startup;\n\n\t \n\terr = snd_card_add_dev_attr(line6->card, &pod_dev_attr_group);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = line6_init_pcm(line6, &pod_pcm_properties);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = snd_ctl_add(line6->card,\n\t\t\t  snd_ctl_new1(&pod_control_monitor, line6->line6pcm));\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\n\tif (pod->line6.properties->capabilities & LINE6_CAP_CONTROL) {\n\t\tpod->monitor_level = POD_SYSTEM_INVALID;\n\n\t\t \n\t\tschedule_delayed_work(&line6->startup_work,\n\t\t\t\t      msecs_to_jiffies(POD_STARTUP_DELAY));\n\t}\n\n\treturn 0;\n}\n\n#define LINE6_DEVICE(prod) USB_DEVICE(0x0e41, prod)\n#define LINE6_IF_NUM(prod, n) USB_DEVICE_INTERFACE_NUMBER(0x0e41, prod, n)\n\n \nstatic const struct usb_device_id pod_id_table[] = {\n\t{ LINE6_DEVICE(0x4250),    .driver_info = LINE6_BASSPODXT },\n\t{ LINE6_DEVICE(0x4642),    .driver_info = LINE6_BASSPODXTLIVE },\n\t{ LINE6_DEVICE(0x4252),    .driver_info = LINE6_BASSPODXTPRO },\n\t{ LINE6_IF_NUM(0x5051, 1), .driver_info = LINE6_POCKETPOD },\n\t{ LINE6_DEVICE(0x5044),    .driver_info = LINE6_PODXT },\n\t{ LINE6_IF_NUM(0x4650, 0), .driver_info = LINE6_PODXTLIVE_POD },\n\t{ LINE6_DEVICE(0x5050),    .driver_info = LINE6_PODXTPRO },\n\t{}\n};\n\nMODULE_DEVICE_TABLE(usb, pod_id_table);\n\nstatic const struct line6_properties pod_properties_table[] = {\n\t[LINE6_BASSPODXT] = {\n\t\t.id = \"BassPODxt\",\n\t\t.name = \"BassPODxt\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI\n\t\t\t\t| LINE6_CAP_PCM\n\t\t\t\t| LINE6_CAP_HWMON,\n\t\t.altsetting = 5,\n\t\t.ep_ctrl_r = 0x84,\n\t\t.ep_ctrl_w = 0x03,\n\t\t.ep_audio_r = 0x82,\n\t\t.ep_audio_w = 0x01,\n\t},\n\t[LINE6_BASSPODXTLIVE] = {\n\t\t.id = \"BassPODxtLive\",\n\t\t.name = \"BassPODxt Live\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI\n\t\t\t\t| LINE6_CAP_PCM\n\t\t\t\t| LINE6_CAP_HWMON,\n\t\t.altsetting = 1,\n\t\t.ep_ctrl_r = 0x84,\n\t\t.ep_ctrl_w = 0x03,\n\t\t.ep_audio_r = 0x82,\n\t\t.ep_audio_w = 0x01,\n\t},\n\t[LINE6_BASSPODXTPRO] = {\n\t\t.id = \"BassPODxtPro\",\n\t\t.name = \"BassPODxt Pro\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI\n\t\t\t\t| LINE6_CAP_PCM\n\t\t\t\t| LINE6_CAP_HWMON,\n\t\t.altsetting = 5,\n\t\t.ep_ctrl_r = 0x84,\n\t\t.ep_ctrl_w = 0x03,\n\t\t.ep_audio_r = 0x82,\n\t\t.ep_audio_w = 0x01,\n\t},\n\t[LINE6_POCKETPOD] = {\n\t\t.id = \"PocketPOD\",\n\t\t.name = \"Pocket POD\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI,\n\t\t.altsetting = 0,\n\t\t.ep_ctrl_r = 0x82,\n\t\t.ep_ctrl_w = 0x02,\n\t\t \n\t},\n\t[LINE6_PODXT] = {\n\t\t.id = \"PODxt\",\n\t\t.name = \"PODxt\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI\n\t\t\t\t| LINE6_CAP_PCM\n\t\t\t\t| LINE6_CAP_HWMON,\n\t\t.altsetting = 5,\n\t\t.ep_ctrl_r = 0x84,\n\t\t.ep_ctrl_w = 0x03,\n\t\t.ep_audio_r = 0x82,\n\t\t.ep_audio_w = 0x01,\n\t},\n\t[LINE6_PODXTLIVE_POD] = {\n\t\t.id = \"PODxtLive\",\n\t\t.name = \"PODxt Live\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI\n\t\t\t\t| LINE6_CAP_PCM\n\t\t\t\t| LINE6_CAP_HWMON,\n\t\t.altsetting = 1,\n\t\t.ep_ctrl_r = 0x84,\n\t\t.ep_ctrl_w = 0x03,\n\t\t.ep_audio_r = 0x82,\n\t\t.ep_audio_w = 0x01,\n\t},\n\t[LINE6_PODXTPRO] = {\n\t\t.id = \"PODxtPro\",\n\t\t.name = \"PODxt Pro\",\n\t\t.capabilities\t= LINE6_CAP_CONTROL\n\t\t\t\t| LINE6_CAP_CONTROL_MIDI\n\t\t\t\t| LINE6_CAP_PCM\n\t\t\t\t| LINE6_CAP_HWMON,\n\t\t.altsetting = 5,\n\t\t.ep_ctrl_r = 0x84,\n\t\t.ep_ctrl_w = 0x03,\n\t\t.ep_audio_r = 0x82,\n\t\t.ep_audio_w = 0x01,\n\t},\n};\n\n \nstatic int pod_probe(struct usb_interface *interface,\n\t\t     const struct usb_device_id *id)\n{\n\treturn line6_probe(interface, id, \"Line6-POD\",\n\t\t\t   &pod_properties_table[id->driver_info],\n\t\t\t   pod_init, sizeof(struct usb_line6_pod));\n}\n\nstatic struct usb_driver pod_driver = {\n\t.name = KBUILD_MODNAME,\n\t.probe = pod_probe,\n\t.disconnect = line6_disconnect,\n#ifdef CONFIG_PM\n\t.suspend = line6_suspend,\n\t.resume = line6_resume,\n\t.reset_resume = line6_resume,\n#endif\n\t.id_table = pod_id_table,\n};\n\nmodule_usb_driver(pod_driver);\n\nMODULE_DESCRIPTION(\"Line 6 POD USB driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}