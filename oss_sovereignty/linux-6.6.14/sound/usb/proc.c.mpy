{
  "module_name": "proc.c",
  "hash_id": "c51520d14ca7a84287646d2e1fc5c607800f7bbd7692a4ed1187128620daf075",
  "original_prompt": "Ingested from linux-6.6.14/sound/usb/proc.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/usb.h>\n\n#include <sound/core.h>\n#include <sound/info.h>\n#include <sound/pcm.h>\n\n#include \"usbaudio.h\"\n#include \"helper.h\"\n#include \"card.h\"\n#include \"endpoint.h\"\n#include \"proc.h\"\n\n \nstatic inline unsigned get_full_speed_hz(unsigned int usb_rate)\n{\n\treturn (usb_rate * 125 + (1 << 12)) >> 13;\n}\n\n \nstatic inline unsigned get_high_speed_hz(unsigned int usb_rate)\n{\n\treturn (usb_rate * 125 + (1 << 9)) >> 10;\n}\n\n \nstatic void proc_audio_usbbus_read(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\n{\n\tstruct snd_usb_audio *chip = entry->private_data;\n\tif (!atomic_read(&chip->shutdown))\n\t\tsnd_iprintf(buffer, \"%03d/%03d\\n\", chip->dev->bus->busnum, chip->dev->devnum);\n}\n\nstatic void proc_audio_usbid_read(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\n{\n\tstruct snd_usb_audio *chip = entry->private_data;\n\tif (!atomic_read(&chip->shutdown))\n\t\tsnd_iprintf(buffer, \"%04x:%04x\\n\", \n\t\t\t    USB_ID_VENDOR(chip->usb_id),\n\t\t\t    USB_ID_PRODUCT(chip->usb_id));\n}\n\nvoid snd_usb_audio_create_proc(struct snd_usb_audio *chip)\n{\n\tsnd_card_ro_proc_new(chip->card, \"usbbus\", chip,\n\t\t\t     proc_audio_usbbus_read);\n\tsnd_card_ro_proc_new(chip->card, \"usbid\", chip,\n\t\t\t     proc_audio_usbid_read);\n}\n\nstatic const char * const channel_labels[] = {\n\t[SNDRV_CHMAP_NA]\t= \"N/A\",\n\t[SNDRV_CHMAP_MONO]\t= \"MONO\",\n\t[SNDRV_CHMAP_FL]\t= \"FL\",\n\t[SNDRV_CHMAP_FR]\t= \"FR\",\n\t[SNDRV_CHMAP_FC]\t= \"FC\",\n\t[SNDRV_CHMAP_LFE]\t= \"LFE\",\n\t[SNDRV_CHMAP_RL]\t= \"RL\",\n\t[SNDRV_CHMAP_RR]\t= \"RR\",\n\t[SNDRV_CHMAP_FLC]\t= \"FLC\",\n\t[SNDRV_CHMAP_FRC]\t= \"FRC\",\n\t[SNDRV_CHMAP_RC]\t= \"RC\",\n\t[SNDRV_CHMAP_SL]\t= \"SL\",\n\t[SNDRV_CHMAP_SR]\t= \"SR\",\n\t[SNDRV_CHMAP_TC]\t= \"TC\",\n\t[SNDRV_CHMAP_TFL]\t= \"TFL\",\n\t[SNDRV_CHMAP_TFC]\t= \"TFC\",\n\t[SNDRV_CHMAP_TFR]\t= \"TFR\",\n\t[SNDRV_CHMAP_TRL]\t= \"TRL\",\n\t[SNDRV_CHMAP_TRC]\t= \"TRC\",\n\t[SNDRV_CHMAP_TRR]\t= \"TRR\",\n\t[SNDRV_CHMAP_TFLC]\t= \"TFLC\",\n\t[SNDRV_CHMAP_TFRC]\t= \"TFRC\",\n\t[SNDRV_CHMAP_LLFE]\t= \"LLFE\",\n\t[SNDRV_CHMAP_RLFE]\t= \"RLFE\",\n\t[SNDRV_CHMAP_TSL]\t= \"TSL\",\n\t[SNDRV_CHMAP_TSR]\t= \"TSR\",\n\t[SNDRV_CHMAP_BC]\t= \"BC\",\n\t[SNDRV_CHMAP_RLC]\t= \"RLC\",\n\t[SNDRV_CHMAP_RRC]\t= \"RRC\",\n};\n\n \nstatic void proc_dump_substream_formats(struct snd_usb_substream *subs, struct snd_info_buffer *buffer)\n{\n\tstruct audioformat *fp;\n\tstatic const char * const sync_types[4] = {\n\t\t\"NONE\", \"ASYNC\", \"ADAPTIVE\", \"SYNC\"\n\t};\n\n\tlist_for_each_entry(fp, &subs->fmt_list, list) {\n\t\tsnd_pcm_format_t fmt;\n\n\t\tsnd_iprintf(buffer, \"  Interface %d\\n\", fp->iface);\n\t\tsnd_iprintf(buffer, \"    Altset %d\\n\", fp->altsetting);\n\t\tsnd_iprintf(buffer, \"    Format:\");\n\t\tpcm_for_each_format(fmt)\n\t\t\tif (fp->formats & pcm_format_to_bits(fmt))\n\t\t\t\tsnd_iprintf(buffer, \" %s\",\n\t\t\t\t\t    snd_pcm_format_name(fmt));\n\t\tsnd_iprintf(buffer, \"\\n\");\n\t\tsnd_iprintf(buffer, \"    Channels: %d\\n\", fp->channels);\n\t\tsnd_iprintf(buffer, \"    Endpoint: 0x%02x (%d %s) (%s)\\n\",\n\t\t\t    fp->endpoint,\n\t\t\t    fp->endpoint & USB_ENDPOINT_NUMBER_MASK,\n\t\t\t    fp->endpoint & USB_DIR_IN ? \"IN\" : \"OUT\",\n\t\t\t    sync_types[(fp->ep_attr & USB_ENDPOINT_SYNCTYPE) >> 2]);\n\t\tif (fp->rates & SNDRV_PCM_RATE_CONTINUOUS) {\n\t\t\tsnd_iprintf(buffer, \"    Rates: %d - %d (continuous)\\n\",\n\t\t\t\t    fp->rate_min, fp->rate_max);\n\t\t} else {\n\t\t\tunsigned int i;\n\t\t\tsnd_iprintf(buffer, \"    Rates: \");\n\t\t\tfor (i = 0; i < fp->nr_rates; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tsnd_iprintf(buffer, \", \");\n\t\t\t\tsnd_iprintf(buffer, \"%d\", fp->rate_table[i]);\n\t\t\t}\n\t\t\tsnd_iprintf(buffer, \"\\n\");\n\t\t}\n\t\tif (subs->speed != USB_SPEED_FULL)\n\t\t\tsnd_iprintf(buffer, \"    Data packet interval: %d us\\n\",\n\t\t\t\t    125 * (1 << fp->datainterval));\n\t\tsnd_iprintf(buffer, \"    Bits: %d\\n\", fp->fmt_bits);\n\n\t\tif (fp->dsd_raw)\n\t\t\tsnd_iprintf(buffer, \"    DSD raw: DOP=%d, bitrev=%d\\n\",\n\t\t\t\t    fp->dsd_dop, fp->dsd_bitrev);\n\n\t\tif (fp->chmap) {\n\t\t\tconst struct snd_pcm_chmap_elem *map = fp->chmap;\n\t\t\tint c;\n\n\t\t\tsnd_iprintf(buffer, \"    Channel map:\");\n\t\t\tfor (c = 0; c < map->channels; c++) {\n\t\t\t\tif (map->map[c] >= ARRAY_SIZE(channel_labels) ||\n\t\t\t\t    !channel_labels[map->map[c]])\n\t\t\t\t\tsnd_iprintf(buffer, \" --\");\n\t\t\t\telse\n\t\t\t\t\tsnd_iprintf(buffer, \" %s\",\n\t\t\t\t\t\t    channel_labels[map->map[c]]);\n\t\t\t}\n\t\t\tsnd_iprintf(buffer, \"\\n\");\n\t\t}\n\n\t\tif (fp->sync_ep) {\n\t\t\tsnd_iprintf(buffer, \"    Sync Endpoint: 0x%02x (%d %s)\\n\",\n\t\t\t\t    fp->sync_ep,\n\t\t\t\t    fp->sync_ep & USB_ENDPOINT_NUMBER_MASK,\n\t\t\t\t    fp->sync_ep & USB_DIR_IN ? \"IN\" : \"OUT\");\n\t\t\tsnd_iprintf(buffer, \"    Sync EP Interface: %d\\n\",\n\t\t\t\t    fp->sync_iface);\n\t\t\tsnd_iprintf(buffer, \"    Sync EP Altset: %d\\n\",\n\t\t\t\t    fp->sync_altsetting);\n\t\t\tsnd_iprintf(buffer, \"    Implicit Feedback Mode: %s\\n\",\n\t\t\t\t    fp->implicit_fb ? \"Yes\" : \"No\");\n\t\t}\n\n\t\t\n\t\t\n\t}\n}\n\nstatic void proc_dump_ep_status(struct snd_usb_substream *subs,\n\t\t\t\tstruct snd_usb_endpoint *data_ep,\n\t\t\t\tstruct snd_usb_endpoint *sync_ep,\n\t\t\t\tstruct snd_info_buffer *buffer)\n{\n\tif (!data_ep)\n\t\treturn;\n\tsnd_iprintf(buffer, \"    Packet Size = %d\\n\", data_ep->curpacksize);\n\tsnd_iprintf(buffer, \"    Momentary freq = %u Hz (%#x.%04x)\\n\",\n\t\t    subs->speed == USB_SPEED_FULL\n\t\t    ? get_full_speed_hz(data_ep->freqm)\n\t\t    : get_high_speed_hz(data_ep->freqm),\n\t\t    data_ep->freqm >> 16, data_ep->freqm & 0xffff);\n\tif (sync_ep && data_ep->freqshift != INT_MIN) {\n\t\tint res = 16 - data_ep->freqshift;\n\t\tsnd_iprintf(buffer, \"    Feedback Format = %d.%d\\n\",\n\t\t\t    (sync_ep->syncmaxsize > 3 ? 32 : 24) - res, res);\n\t}\n}\n\nstatic void proc_dump_substream_status(struct snd_usb_audio *chip,\n\t\t\t\t       struct snd_usb_substream *subs,\n\t\t\t\t       struct snd_info_buffer *buffer)\n{\n\tmutex_lock(&chip->mutex);\n\tif (subs->running) {\n\t\tsnd_iprintf(buffer, \"  Status: Running\\n\");\n\t\tif (subs->cur_audiofmt) {\n\t\t\tsnd_iprintf(buffer, \"    Interface = %d\\n\", subs->cur_audiofmt->iface);\n\t\t\tsnd_iprintf(buffer, \"    Altset = %d\\n\", subs->cur_audiofmt->altsetting);\n\t\t}\n\t\tproc_dump_ep_status(subs, subs->data_endpoint, subs->sync_endpoint, buffer);\n\t} else {\n\t\tsnd_iprintf(buffer, \"  Status: Stop\\n\");\n\t}\n\tmutex_unlock(&chip->mutex);\n}\n\nstatic void proc_pcm_format_read(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\n{\n\tstruct snd_usb_stream *stream = entry->private_data;\n\tstruct snd_usb_audio *chip = stream->chip;\n\n\tsnd_iprintf(buffer, \"%s : %s\\n\", chip->card->longname, stream->pcm->name);\n\n\tif (stream->substream[SNDRV_PCM_STREAM_PLAYBACK].num_formats) {\n\t\tsnd_iprintf(buffer, \"\\nPlayback:\\n\");\n\t\tproc_dump_substream_status(chip, &stream->substream[SNDRV_PCM_STREAM_PLAYBACK], buffer);\n\t\tproc_dump_substream_formats(&stream->substream[SNDRV_PCM_STREAM_PLAYBACK], buffer);\n\t}\n\tif (stream->substream[SNDRV_PCM_STREAM_CAPTURE].num_formats) {\n\t\tsnd_iprintf(buffer, \"\\nCapture:\\n\");\n\t\tproc_dump_substream_status(chip, &stream->substream[SNDRV_PCM_STREAM_CAPTURE], buffer);\n\t\tproc_dump_substream_formats(&stream->substream[SNDRV_PCM_STREAM_CAPTURE], buffer);\n\t}\n}\n\nvoid snd_usb_proc_pcm_format_add(struct snd_usb_stream *stream)\n{\n\tchar name[32];\n\tstruct snd_card *card = stream->chip->card;\n\n\tsprintf(name, \"stream%d\", stream->pcm_index);\n\tsnd_card_ro_proc_new(card, name, stream, proc_pcm_format_read);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}