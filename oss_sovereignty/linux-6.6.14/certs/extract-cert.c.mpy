{
  "module_name": "extract-cert.c",
  "hash_id": "d84cbb274f7dd1423bc1106789a664cdd58472047a13dee754be1bba1ace8b5b",
  "original_prompt": "Ingested from linux-6.6.14/certs/extract-cert.c",
  "human_readable_source": " \n#define _GNU_SOURCE\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdint.h>\n#include <stdbool.h>\n#include <string.h>\n#include <err.h>\n#include <openssl/bio.h>\n#include <openssl/pem.h>\n#include <openssl/err.h>\n#include <openssl/engine.h>\n\n \n#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n\n#define PKEY_ID_PKCS7 2\n\nstatic __attribute__((noreturn))\nvoid format(void)\n{\n\tfprintf(stderr,\n\t\t\"Usage: extract-cert <source> <dest>\\n\");\n\texit(2);\n}\n\nstatic void display_openssl_errors(int l)\n{\n\tconst char *file;\n\tchar buf[120];\n\tint e, line;\n\n\tif (ERR_peek_error() == 0)\n\t\treturn;\n\tfprintf(stderr, \"At main.c:%d:\\n\", l);\n\n\twhile ((e = ERR_get_error_line(&file, &line))) {\n\t\tERR_error_string(e, buf);\n\t\tfprintf(stderr, \"- SSL %s: %s:%d\\n\", buf, file, line);\n\t}\n}\n\nstatic void drain_openssl_errors(void)\n{\n\tconst char *file;\n\tint line;\n\n\tif (ERR_peek_error() == 0)\n\t\treturn;\n\twhile (ERR_get_error_line(&file, &line)) {}\n}\n\n#define ERR(cond, fmt, ...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tbool __cond = (cond);\t\t\t\\\n\t\tdisplay_openssl_errors(__LINE__);\t\\\n\t\tif (__cond) {\t\t\t\t\\\n\t\t\terr(1, fmt, ## __VA_ARGS__);\t\\\n\t\t}\t\t\t\t\t\\\n\t} while(0)\n\nstatic const char *key_pass;\nstatic BIO *wb;\nstatic char *cert_dst;\nstatic bool verbose;\n\nstatic void write_cert(X509 *x509)\n{\n\tchar buf[200];\n\n\tif (!wb) {\n\t\twb = BIO_new_file(cert_dst, \"wb\");\n\t\tERR(!wb, \"%s\", cert_dst);\n\t}\n\tX509_NAME_oneline(X509_get_subject_name(x509), buf, sizeof(buf));\n\tERR(!i2d_X509_bio(wb, x509), \"%s\", cert_dst);\n\tif (verbose)\n\t\tfprintf(stderr, \"Extracted cert: %s\\n\", buf);\n}\n\nint main(int argc, char **argv)\n{\n\tchar *cert_src;\n\tchar *verbose_env;\n\n\tOpenSSL_add_all_algorithms();\n\tERR_load_crypto_strings();\n\tERR_clear_error();\n\n\tverbose_env = getenv(\"KBUILD_VERBOSE\");\n\tif (verbose_env && strchr(verbose_env, '1'))\n\t\tverbose = true;\n\n        key_pass = getenv(\"KBUILD_SIGN_PIN\");\n\n\tif (argc != 3)\n\t\tformat();\n\n\tcert_src = argv[1];\n\tcert_dst = argv[2];\n\n\tif (!cert_src[0]) {\n\t\t \n\t\tFILE *f = fopen(cert_dst, \"wb\");\n\t\tERR(!f, \"%s\", cert_dst);\n\t\tfclose(f);\n\t\texit(0);\n\t} else if (!strncmp(cert_src, \"pkcs11:\", 7)) {\n\t\tENGINE *e;\n\t\tstruct {\n\t\t\tconst char *cert_id;\n\t\t\tX509 *cert;\n\t\t} parms;\n\n\t\tparms.cert_id = cert_src;\n\t\tparms.cert = NULL;\n\n\t\tENGINE_load_builtin_engines();\n\t\tdrain_openssl_errors();\n\t\te = ENGINE_by_id(\"pkcs11\");\n\t\tERR(!e, \"Load PKCS#11 ENGINE\");\n\t\tif (ENGINE_init(e))\n\t\t\tdrain_openssl_errors();\n\t\telse\n\t\t\tERR(1, \"ENGINE_init\");\n\t\tif (key_pass)\n\t\t\tERR(!ENGINE_ctrl_cmd_string(e, \"PIN\", key_pass, 0), \"Set PKCS#11 PIN\");\n\t\tENGINE_ctrl_cmd(e, \"LOAD_CERT_CTRL\", 0, &parms, NULL, 1);\n\t\tERR(!parms.cert, \"Get X.509 from PKCS#11\");\n\t\twrite_cert(parms.cert);\n\t} else {\n\t\tBIO *b;\n\t\tX509 *x509;\n\n\t\tb = BIO_new_file(cert_src, \"rb\");\n\t\tERR(!b, \"%s\", cert_src);\n\n\t\twhile (1) {\n\t\t\tx509 = PEM_read_bio_X509(b, NULL, NULL, NULL);\n\t\t\tif (wb && !x509) {\n\t\t\t\tunsigned long err = ERR_peek_last_error();\n\t\t\t\tif (ERR_GET_LIB(err) == ERR_LIB_PEM &&\n\t\t\t\t    ERR_GET_REASON(err) == PEM_R_NO_START_LINE) {\n\t\t\t\t\tERR_clear_error();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tERR(!x509, \"%s\", cert_src);\n\t\t\twrite_cert(x509);\n\t\t}\n\t}\n\n\tBIO_free(wb);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}