{
  "module_name": "crypto.c",
  "hash_id": "001fb092536e7903970bf83bba368fd9369bb2690d48a99028a0ce8b85112a52",
  "original_prompt": "Ingested from linux-6.6.14/security/apparmor/crypto.c",
  "human_readable_source": "\n \n\n#include <crypto/hash.h>\n\n#include \"include/apparmor.h\"\n#include \"include/crypto.h\"\n\nstatic unsigned int apparmor_hash_size;\n\nstatic struct crypto_shash *apparmor_tfm;\n\nunsigned int aa_hash_size(void)\n{\n\treturn apparmor_hash_size;\n}\n\nchar *aa_calc_hash(void *data, size_t len)\n{\n\tSHASH_DESC_ON_STACK(desc, apparmor_tfm);\n\tchar *hash;\n\tint error;\n\n\tif (!apparmor_tfm)\n\t\treturn NULL;\n\n\thash = kzalloc(apparmor_hash_size, GFP_KERNEL);\n\tif (!hash)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tdesc->tfm = apparmor_tfm;\n\n\terror = crypto_shash_init(desc);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) data, len);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_final(desc, hash);\n\tif (error)\n\t\tgoto fail;\n\n\treturn hash;\n\nfail:\n\tkfree(hash);\n\n\treturn ERR_PTR(error);\n}\n\nint aa_calc_profile_hash(struct aa_profile *profile, u32 version, void *start,\n\t\t\t size_t len)\n{\n\tSHASH_DESC_ON_STACK(desc, apparmor_tfm);\n\tint error;\n\t__le32 le32_version = cpu_to_le32(version);\n\n\tif (!aa_g_hash_policy)\n\t\treturn 0;\n\n\tif (!apparmor_tfm)\n\t\treturn 0;\n\n\tprofile->hash = kzalloc(apparmor_hash_size, GFP_KERNEL);\n\tif (!profile->hash)\n\t\treturn -ENOMEM;\n\n\tdesc->tfm = apparmor_tfm;\n\n\terror = crypto_shash_init(desc);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) &le32_version, 4);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) start, len);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_final(desc, profile->hash);\n\tif (error)\n\t\tgoto fail;\n\n\treturn 0;\n\nfail:\n\tkfree(profile->hash);\n\tprofile->hash = NULL;\n\n\treturn error;\n}\n\nstatic int __init init_profile_hash(void)\n{\n\tstruct crypto_shash *tfm;\n\n\tif (!apparmor_initialized)\n\t\treturn 0;\n\n\ttfm = crypto_alloc_shash(\"sha1\", 0, 0);\n\tif (IS_ERR(tfm)) {\n\t\tint error = PTR_ERR(tfm);\n\t\tAA_ERROR(\"failed to setup profile sha1 hashing: %d\\n\", error);\n\t\treturn error;\n\t}\n\tapparmor_tfm = tfm;\n\tapparmor_hash_size = crypto_shash_digestsize(apparmor_tfm);\n\n\taa_info_message(\"AppArmor sha1 policy hashing enabled\");\n\n\treturn 0;\n}\n\nlate_initcall(init_profile_hash);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}