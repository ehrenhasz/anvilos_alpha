{
  "module_name": "load_powerpc.c",
  "hash_id": "9270f5110bd97341356292f42485bfb51fd84ea574f7974591c50880e51c653e",
  "original_prompt": "Ingested from linux-6.6.14/security/integrity/platform_certs/load_powerpc.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/sched.h>\n#include <linux/cred.h>\n#include <linux/err.h>\n#include <linux/slab.h>\n#include <asm/secure_boot.h>\n#include <asm/secvar.h>\n#include \"keyring_handler.h\"\n#include \"../integrity.h\"\n\n#define extract_esl(db, data, size, offset)\t\\\n\tdo { db = data + offset; size = size - offset; } while (0)\n\n \nstatic __init void *get_cert_list(u8 *key, unsigned long keylen, u64 *size)\n{\n\tint rc;\n\tvoid *db;\n\n\trc = secvar_ops->get(key, keylen, NULL, size);\n\tif (rc) {\n\t\tif (rc == -ENOENT)\n\t\t\treturn NULL;\n\t\treturn ERR_PTR(rc);\n\t}\n\n\tdb = kmalloc(*size, GFP_KERNEL);\n\tif (!db)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\trc = secvar_ops->get(key, keylen, db, size);\n\tif (rc) {\n\t\tkfree(db);\n\t\treturn ERR_PTR(rc);\n\t}\n\n\treturn db;\n}\n\n \nstatic int __init load_powerpc_certs(void)\n{\n\tvoid *db = NULL, *dbx = NULL, *data = NULL;\n\tvoid *trustedca;\n\tvoid *moduledb;\n\tu64 dsize = 0;\n\tu64 offset = 0;\n\tint rc = 0;\n\tssize_t len;\n\tchar buf[32];\n\n\tif (!secvar_ops)\n\t\treturn -ENODEV;\n\n\tlen = secvar_ops->format(buf, sizeof(buf));\n\tif (len <= 0)\n\t\treturn -ENODEV;\n\n\t \n\tif (strcmp(\"ibm,edk2-compat-v1\", buf) && strcmp(\"ibm,plpks-sb-v1\", buf)) {\n\t\tpr_err(\"Unsupported secvar implementation \\\"%s\\\", not loading certs\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\tif (strcmp(\"ibm,plpks-sb-v1\", buf) == 0)\n\t\t \n\t\toffset = 8;\n\n\t \n\tdata = get_cert_list(\"db\", 3, &dsize);\n\tif (!data) {\n\t\tpr_info(\"Couldn't get db list from firmware\\n\");\n\t} else if (IS_ERR(data)) {\n\t\trc = PTR_ERR(data);\n\t\tpr_err(\"Error reading db from firmware: %d\\n\", rc);\n\t\treturn rc;\n\t} else {\n\t\textract_esl(db, data, dsize, offset);\n\n\t\trc = parse_efi_signature_list(\"powerpc:db\", db, dsize,\n\t\t\t\t\t      get_handler_for_db);\n\t\tif (rc)\n\t\t\tpr_err(\"Couldn't parse db signatures: %d\\n\", rc);\n\t\tkfree(data);\n\t}\n\n\tdata = get_cert_list(\"dbx\", 4,  &dsize);\n\tif (!data) {\n\t\tpr_info(\"Couldn't get dbx list from firmware\\n\");\n\t} else if (IS_ERR(data)) {\n\t\trc = PTR_ERR(data);\n\t\tpr_err(\"Error reading dbx from firmware: %d\\n\", rc);\n\t\treturn rc;\n\t} else {\n\t\textract_esl(dbx, data, dsize, offset);\n\n\t\trc = parse_efi_signature_list(\"powerpc:dbx\", dbx, dsize,\n\t\t\t\t\t      get_handler_for_dbx);\n\t\tif (rc)\n\t\t\tpr_err(\"Couldn't parse dbx signatures: %d\\n\", rc);\n\t\tkfree(data);\n\t}\n\n\tdata = get_cert_list(\"trustedcadb\", 12,  &dsize);\n\tif (!data) {\n\t\tpr_info(\"Couldn't get trustedcadb list from firmware\\n\");\n\t} else if (IS_ERR(data)) {\n\t\trc = PTR_ERR(data);\n\t\tpr_err(\"Error reading trustedcadb from firmware: %d\\n\", rc);\n\t} else {\n\t\textract_esl(trustedca, data, dsize, offset);\n\n\t\trc = parse_efi_signature_list(\"powerpc:trustedca\", trustedca, dsize,\n\t\t\t\t\t      get_handler_for_ca_keys);\n\t\tif (rc)\n\t\t\tpr_err(\"Couldn't parse trustedcadb signatures: %d\\n\", rc);\n\t\tkfree(data);\n\t}\n\n\tdata = get_cert_list(\"moduledb\", 9,  &dsize);\n\tif (!data) {\n\t\tpr_info(\"Couldn't get moduledb list from firmware\\n\");\n\t} else if (IS_ERR(data)) {\n\t\trc = PTR_ERR(data);\n\t\tpr_err(\"Error reading moduledb from firmware: %d\\n\", rc);\n\t} else {\n\t\textract_esl(moduledb, data, dsize, offset);\n\n\t\trc = parse_efi_signature_list(\"powerpc:moduledb\", moduledb, dsize,\n\t\t\t\t\t      get_handler_for_code_signing_keys);\n\t\tif (rc)\n\t\t\tpr_err(\"Couldn't parse moduledb signatures: %d\\n\", rc);\n\t\tkfree(data);\n\t}\n\n\treturn rc;\n}\nlate_initcall(load_powerpc_certs);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}