{
  "module_name": "ima_efi.c",
  "hash_id": "ff7a03e9438deef95607a27d6bf537d583239e8bbba0eeced192c6f7bc4aa2ef",
  "original_prompt": "Ingested from linux-6.6.14/security/integrity/ima/ima_efi.c",
  "human_readable_source": " \n \n#include <linux/efi.h>\n#include <linux/module.h>\n#include <linux/ima.h>\n#include <asm/efi.h>\n\n#ifndef arch_ima_efi_boot_mode\n#define arch_ima_efi_boot_mode efi_secureboot_mode_unset\n#endif\n\nstatic enum efi_secureboot_mode get_sb_mode(void)\n{\n\tenum efi_secureboot_mode mode;\n\n\tif (!efi_rt_services_supported(EFI_RT_SUPPORTED_GET_VARIABLE)) {\n\t\tpr_info(\"ima: secureboot mode unknown, no efi\\n\");\n\t\treturn efi_secureboot_mode_unknown;\n\t}\n\n\tmode = efi_get_secureboot_mode(efi.get_variable);\n\tif (mode == efi_secureboot_mode_disabled)\n\t\tpr_info(\"ima: secureboot mode disabled\\n\");\n\telse if (mode == efi_secureboot_mode_unknown)\n\t\tpr_info(\"ima: secureboot mode unknown\\n\");\n\telse\n\t\tpr_info(\"ima: secureboot mode enabled\\n\");\n\treturn mode;\n}\n\nbool arch_ima_get_secureboot(void)\n{\n\tstatic enum efi_secureboot_mode sb_mode;\n\tstatic bool initialized;\n\n\tif (!initialized && efi_enabled(EFI_BOOT)) {\n\t\tsb_mode = arch_ima_efi_boot_mode;\n\n\t\tif (sb_mode == efi_secureboot_mode_unset)\n\t\t\tsb_mode = get_sb_mode();\n\t\tinitialized = true;\n\t}\n\n\tif (sb_mode == efi_secureboot_mode_enabled)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n \nstatic const char * const sb_arch_rules[] = {\n#if !IS_ENABLED(CONFIG_KEXEC_SIG)\n\t\"appraise func=KEXEC_KERNEL_CHECK appraise_type=imasig\",\n#endif  \n\t\"measure func=KEXEC_KERNEL_CHECK\",\n#if !IS_ENABLED(CONFIG_MODULE_SIG)\n\t\"appraise func=MODULE_CHECK appraise_type=imasig\",\n#endif\n#if IS_ENABLED(CONFIG_INTEGRITY_MACHINE_KEYRING) && IS_ENABLED(CONFIG_IMA_KEYRINGS_PERMIT_SIGNED_BY_BUILTIN_OR_SECONDARY)\n\t\"appraise func=POLICY_CHECK appraise_type=imasig\",\n#endif\n\t\"measure func=MODULE_CHECK\",\n\tNULL\n};\n\nconst char * const *arch_get_ima_policy(void)\n{\n\tif (IS_ENABLED(CONFIG_IMA_ARCH_POLICY) && arch_ima_get_secureboot()) {\n\t\tif (IS_ENABLED(CONFIG_MODULE_SIG))\n\t\t\tset_module_sig_enforced();\n\t\tif (IS_ENABLED(CONFIG_KEXEC_SIG))\n\t\t\tset_kexec_sig_enforced();\n\t\treturn sb_arch_rules;\n\t}\n\treturn NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}