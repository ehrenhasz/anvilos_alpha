{
  "module_name": "ptrace.c",
  "hash_id": "40694b7563622a13dedbc67ce6166eef83932fbbadab589ebbf798dbad3e9779",
  "original_prompt": "Ingested from linux-6.6.14/security/landlock/ptrace.c",
  "human_readable_source": "\n \n\n#include <asm/current.h>\n#include <linux/cred.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/lsm_hooks.h>\n#include <linux/rcupdate.h>\n#include <linux/sched.h>\n\n#include \"common.h\"\n#include \"cred.h\"\n#include \"ptrace.h\"\n#include \"ruleset.h\"\n#include \"setup.h\"\n\n \nstatic bool domain_scope_le(const struct landlock_ruleset *const parent,\n\t\t\t    const struct landlock_ruleset *const child)\n{\n\tconst struct landlock_hierarchy *walker;\n\n\tif (!parent)\n\t\treturn true;\n\tif (!child)\n\t\treturn false;\n\tfor (walker = child->hierarchy; walker; walker = walker->parent) {\n\t\tif (walker == parent->hierarchy)\n\t\t\t \n\t\t\treturn true;\n\t}\n\t \n\treturn false;\n}\n\nstatic bool task_is_scoped(const struct task_struct *const parent,\n\t\t\t   const struct task_struct *const child)\n{\n\tbool is_scoped;\n\tconst struct landlock_ruleset *dom_parent, *dom_child;\n\n\trcu_read_lock();\n\tdom_parent = landlock_get_task_domain(parent);\n\tdom_child = landlock_get_task_domain(child);\n\tis_scoped = domain_scope_le(dom_parent, dom_child);\n\trcu_read_unlock();\n\treturn is_scoped;\n}\n\nstatic int task_ptrace(const struct task_struct *const parent,\n\t\t       const struct task_struct *const child)\n{\n\t \n\tif (!landlocked(parent))\n\t\treturn 0;\n\tif (task_is_scoped(parent, child))\n\t\treturn 0;\n\treturn -EPERM;\n}\n\n \nstatic int hook_ptrace_access_check(struct task_struct *const child,\n\t\t\t\t    const unsigned int mode)\n{\n\treturn task_ptrace(current, child);\n}\n\n \nstatic int hook_ptrace_traceme(struct task_struct *const parent)\n{\n\treturn task_ptrace(parent, current);\n}\n\nstatic struct security_hook_list landlock_hooks[] __ro_after_init = {\n\tLSM_HOOK_INIT(ptrace_access_check, hook_ptrace_access_check),\n\tLSM_HOOK_INIT(ptrace_traceme, hook_ptrace_traceme),\n};\n\n__init void landlock_add_ptrace_hooks(void)\n{\n\tsecurity_add_hooks(landlock_hooks, ARRAY_SIZE(landlock_hooks),\n\t\t\t   LANDLOCK_NAME);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}