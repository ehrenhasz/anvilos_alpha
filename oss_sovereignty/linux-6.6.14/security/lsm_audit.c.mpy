{
  "module_name": "lsm_audit.c",
  "hash_id": "9dc01064716ed22c5f1c0fef230547a4f95c0201ae57b93dc8e8702a9164119d",
  "original_prompt": "Ingested from linux-6.6.14/security/lsm_audit.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/stddef.h>\n#include <linux/kernel.h>\n#include <linux/gfp.h>\n#include <linux/fs.h>\n#include <linux/init.h>\n#include <net/sock.h>\n#include <linux/un.h>\n#include <net/af_unix.h>\n#include <linux/audit.h>\n#include <linux/ipv6.h>\n#include <linux/ip.h>\n#include <net/ip.h>\n#include <net/ipv6.h>\n#include <linux/tcp.h>\n#include <linux/udp.h>\n#include <linux/dccp.h>\n#include <linux/sctp.h>\n#include <linux/lsm_audit.h>\n#include <linux/security.h>\n\n \nint ipv4_skb_to_auditdata(struct sk_buff *skb,\n\t\tstruct common_audit_data *ad, u8 *proto)\n{\n\tint ret = 0;\n\tstruct iphdr *ih;\n\n\tih = ip_hdr(skb);\n\tad->u.net->v4info.saddr = ih->saddr;\n\tad->u.net->v4info.daddr = ih->daddr;\n\n\tif (proto)\n\t\t*proto = ih->protocol;\n\t \n\tif (ntohs(ih->frag_off) & IP_OFFSET)\n\t\treturn 0;\n\n\tswitch (ih->protocol) {\n\tcase IPPROTO_TCP: {\n\t\tstruct tcphdr *th = tcp_hdr(skb);\n\n\t\tad->u.net->sport = th->source;\n\t\tad->u.net->dport = th->dest;\n\t\tbreak;\n\t}\n\tcase IPPROTO_UDP: {\n\t\tstruct udphdr *uh = udp_hdr(skb);\n\n\t\tad->u.net->sport = uh->source;\n\t\tad->u.net->dport = uh->dest;\n\t\tbreak;\n\t}\n\tcase IPPROTO_DCCP: {\n\t\tstruct dccp_hdr *dh = dccp_hdr(skb);\n\n\t\tad->u.net->sport = dh->dccph_sport;\n\t\tad->u.net->dport = dh->dccph_dport;\n\t\tbreak;\n\t}\n\tcase IPPROTO_SCTP: {\n\t\tstruct sctphdr *sh = sctp_hdr(skb);\n\n\t\tad->u.net->sport = sh->source;\n\t\tad->u.net->dport = sh->dest;\n\t\tbreak;\n\t}\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\treturn ret;\n}\n#if IS_ENABLED(CONFIG_IPV6)\n \nint ipv6_skb_to_auditdata(struct sk_buff *skb,\n\t\tstruct common_audit_data *ad, u8 *proto)\n{\n\tint offset, ret = 0;\n\tstruct ipv6hdr *ip6;\n\tu8 nexthdr;\n\t__be16 frag_off;\n\n\tip6 = ipv6_hdr(skb);\n\tad->u.net->v6info.saddr = ip6->saddr;\n\tad->u.net->v6info.daddr = ip6->daddr;\n\t \n\toffset = skb_network_offset(skb);\n\toffset += sizeof(*ip6);\n\tnexthdr = ip6->nexthdr;\n\toffset = ipv6_skip_exthdr(skb, offset, &nexthdr, &frag_off);\n\tif (offset < 0)\n\t\treturn 0;\n\tif (proto)\n\t\t*proto = nexthdr;\n\tswitch (nexthdr) {\n\tcase IPPROTO_TCP: {\n\t\tstruct tcphdr _tcph, *th;\n\n\t\tth = skb_header_pointer(skb, offset, sizeof(_tcph), &_tcph);\n\t\tif (th == NULL)\n\t\t\tbreak;\n\n\t\tad->u.net->sport = th->source;\n\t\tad->u.net->dport = th->dest;\n\t\tbreak;\n\t}\n\tcase IPPROTO_UDP: {\n\t\tstruct udphdr _udph, *uh;\n\n\t\tuh = skb_header_pointer(skb, offset, sizeof(_udph), &_udph);\n\t\tif (uh == NULL)\n\t\t\tbreak;\n\n\t\tad->u.net->sport = uh->source;\n\t\tad->u.net->dport = uh->dest;\n\t\tbreak;\n\t}\n\tcase IPPROTO_DCCP: {\n\t\tstruct dccp_hdr _dccph, *dh;\n\n\t\tdh = skb_header_pointer(skb, offset, sizeof(_dccph), &_dccph);\n\t\tif (dh == NULL)\n\t\t\tbreak;\n\n\t\tad->u.net->sport = dh->dccph_sport;\n\t\tad->u.net->dport = dh->dccph_dport;\n\t\tbreak;\n\t}\n\tcase IPPROTO_SCTP: {\n\t\tstruct sctphdr _sctph, *sh;\n\n\t\tsh = skb_header_pointer(skb, offset, sizeof(_sctph), &_sctph);\n\t\tif (sh == NULL)\n\t\t\tbreak;\n\t\tad->u.net->sport = sh->source;\n\t\tad->u.net->dport = sh->dest;\n\t\tbreak;\n\t}\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\treturn ret;\n}\n#endif\n\n\nstatic inline void print_ipv6_addr(struct audit_buffer *ab,\n\t\t\t\t   const struct in6_addr *addr, __be16 port,\n\t\t\t\t   char *name1, char *name2)\n{\n\tif (!ipv6_addr_any(addr))\n\t\taudit_log_format(ab, \" %s=%pI6c\", name1, addr);\n\tif (port)\n\t\taudit_log_format(ab, \" %s=%d\", name2, ntohs(port));\n}\n\nstatic inline void print_ipv4_addr(struct audit_buffer *ab, __be32 addr,\n\t\t\t\t   __be16 port, char *name1, char *name2)\n{\n\tif (addr)\n\t\taudit_log_format(ab, \" %s=%pI4\", name1, &addr);\n\tif (port)\n\t\taudit_log_format(ab, \" %s=%d\", name2, ntohs(port));\n}\n\n \nstatic void dump_common_audit_data(struct audit_buffer *ab,\n\t\t\t\t   struct common_audit_data *a)\n{\n\tchar comm[sizeof(current->comm)];\n\n\t \n\tBUILD_BUG_ON(sizeof(a->u) > sizeof(void *)*2);\n\n\taudit_log_format(ab, \" pid=%d comm=\", task_tgid_nr(current));\n\taudit_log_untrustedstring(ab, memcpy(comm, current->comm, sizeof(comm)));\n\n\tswitch (a->type) {\n\tcase LSM_AUDIT_DATA_NONE:\n\t\treturn;\n\tcase LSM_AUDIT_DATA_IPC:\n\t\taudit_log_format(ab, \" ipc_key=%d \", a->u.ipc_id);\n\t\tbreak;\n\tcase LSM_AUDIT_DATA_CAP:\n\t\taudit_log_format(ab, \" capability=%d \", a->u.cap);\n\t\tbreak;\n\tcase LSM_AUDIT_DATA_PATH: {\n\t\tstruct inode *inode;\n\n\t\taudit_log_d_path(ab, \" path=\", &a->u.path);\n\n\t\tinode = d_backing_inode(a->u.path.dentry);\n\t\tif (inode) {\n\t\t\taudit_log_format(ab, \" dev=\");\n\t\t\taudit_log_untrustedstring(ab, inode->i_sb->s_id);\n\t\t\taudit_log_format(ab, \" ino=%lu\", inode->i_ino);\n\t\t}\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_FILE: {\n\t\tstruct inode *inode;\n\n\t\taudit_log_d_path(ab, \" path=\", &a->u.file->f_path);\n\n\t\tinode = file_inode(a->u.file);\n\t\tif (inode) {\n\t\t\taudit_log_format(ab, \" dev=\");\n\t\t\taudit_log_untrustedstring(ab, inode->i_sb->s_id);\n\t\t\taudit_log_format(ab, \" ino=%lu\", inode->i_ino);\n\t\t}\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_IOCTL_OP: {\n\t\tstruct inode *inode;\n\n\t\taudit_log_d_path(ab, \" path=\", &a->u.op->path);\n\n\t\tinode = a->u.op->path.dentry->d_inode;\n\t\tif (inode) {\n\t\t\taudit_log_format(ab, \" dev=\");\n\t\t\taudit_log_untrustedstring(ab, inode->i_sb->s_id);\n\t\t\taudit_log_format(ab, \" ino=%lu\", inode->i_ino);\n\t\t}\n\n\t\taudit_log_format(ab, \" ioctlcmd=0x%hx\", a->u.op->cmd);\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_DENTRY: {\n\t\tstruct inode *inode;\n\n\t\taudit_log_format(ab, \" name=\");\n\t\tspin_lock(&a->u.dentry->d_lock);\n\t\taudit_log_untrustedstring(ab, a->u.dentry->d_name.name);\n\t\tspin_unlock(&a->u.dentry->d_lock);\n\n\t\tinode = d_backing_inode(a->u.dentry);\n\t\tif (inode) {\n\t\t\taudit_log_format(ab, \" dev=\");\n\t\t\taudit_log_untrustedstring(ab, inode->i_sb->s_id);\n\t\t\taudit_log_format(ab, \" ino=%lu\", inode->i_ino);\n\t\t}\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_INODE: {\n\t\tstruct dentry *dentry;\n\t\tstruct inode *inode;\n\n\t\trcu_read_lock();\n\t\tinode = a->u.inode;\n\t\tdentry = d_find_alias_rcu(inode);\n\t\tif (dentry) {\n\t\t\taudit_log_format(ab, \" name=\");\n\t\t\tspin_lock(&dentry->d_lock);\n\t\t\taudit_log_untrustedstring(ab, dentry->d_name.name);\n\t\t\tspin_unlock(&dentry->d_lock);\n\t\t}\n\t\taudit_log_format(ab, \" dev=\");\n\t\taudit_log_untrustedstring(ab, inode->i_sb->s_id);\n\t\taudit_log_format(ab, \" ino=%lu\", inode->i_ino);\n\t\trcu_read_unlock();\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_TASK: {\n\t\tstruct task_struct *tsk = a->u.tsk;\n\t\tif (tsk) {\n\t\t\tpid_t pid = task_tgid_nr(tsk);\n\t\t\tif (pid) {\n\t\t\t\tchar comm[sizeof(tsk->comm)];\n\t\t\t\taudit_log_format(ab, \" opid=%d ocomm=\", pid);\n\t\t\t\taudit_log_untrustedstring(ab,\n\t\t\t\t    memcpy(comm, tsk->comm, sizeof(comm)));\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_NET:\n\t\tif (a->u.net->sk) {\n\t\t\tconst struct sock *sk = a->u.net->sk;\n\t\t\tconst struct unix_sock *u;\n\t\t\tstruct unix_address *addr;\n\t\t\tint len = 0;\n\t\t\tchar *p = NULL;\n\n\t\t\tswitch (sk->sk_family) {\n\t\t\tcase AF_INET: {\n\t\t\t\tconst struct inet_sock *inet = inet_sk(sk);\n\n\t\t\t\tprint_ipv4_addr(ab, inet->inet_rcv_saddr,\n\t\t\t\t\t\tinet->inet_sport,\n\t\t\t\t\t\t\"laddr\", \"lport\");\n\t\t\t\tprint_ipv4_addr(ab, inet->inet_daddr,\n\t\t\t\t\t\tinet->inet_dport,\n\t\t\t\t\t\t\"faddr\", \"fport\");\n\t\t\t\tbreak;\n\t\t\t}\n#if IS_ENABLED(CONFIG_IPV6)\n\t\t\tcase AF_INET6: {\n\t\t\t\tconst struct inet_sock *inet = inet_sk(sk);\n\n\t\t\t\tprint_ipv6_addr(ab, &sk->sk_v6_rcv_saddr,\n\t\t\t\t\t\tinet->inet_sport,\n\t\t\t\t\t\t\"laddr\", \"lport\");\n\t\t\t\tprint_ipv6_addr(ab, &sk->sk_v6_daddr,\n\t\t\t\t\t\tinet->inet_dport,\n\t\t\t\t\t\t\"faddr\", \"fport\");\n\t\t\t\tbreak;\n\t\t\t}\n#endif\n\t\t\tcase AF_UNIX:\n\t\t\t\tu = unix_sk(sk);\n\t\t\t\taddr = smp_load_acquire(&u->addr);\n\t\t\t\tif (!addr)\n\t\t\t\t\tbreak;\n\t\t\t\tif (u->path.dentry) {\n\t\t\t\t\taudit_log_d_path(ab, \" path=\", &u->path);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tlen = addr->len-sizeof(short);\n\t\t\t\tp = &addr->name->sun_path[0];\n\t\t\t\taudit_log_format(ab, \" path=\");\n\t\t\t\tif (*p)\n\t\t\t\t\taudit_log_untrustedstring(ab, p);\n\t\t\t\telse\n\t\t\t\t\taudit_log_n_hex(ab, p, len);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tswitch (a->u.net->family) {\n\t\tcase AF_INET:\n\t\t\tprint_ipv4_addr(ab, a->u.net->v4info.saddr,\n\t\t\t\t\ta->u.net->sport,\n\t\t\t\t\t\"saddr\", \"src\");\n\t\t\tprint_ipv4_addr(ab, a->u.net->v4info.daddr,\n\t\t\t\t\ta->u.net->dport,\n\t\t\t\t\t\"daddr\", \"dest\");\n\t\t\tbreak;\n\t\tcase AF_INET6:\n\t\t\tprint_ipv6_addr(ab, &a->u.net->v6info.saddr,\n\t\t\t\t\ta->u.net->sport,\n\t\t\t\t\t\"saddr\", \"src\");\n\t\t\tprint_ipv6_addr(ab, &a->u.net->v6info.daddr,\n\t\t\t\t\ta->u.net->dport,\n\t\t\t\t\t\"daddr\", \"dest\");\n\t\t\tbreak;\n\t\t}\n\t\tif (a->u.net->netif > 0) {\n\t\t\tstruct net_device *dev;\n\n\t\t\t \n\t\t\tdev = dev_get_by_index(&init_net, a->u.net->netif);\n\t\t\tif (dev) {\n\t\t\t\taudit_log_format(ab, \" netif=%s\", dev->name);\n\t\t\t\tdev_put(dev);\n\t\t\t}\n\t\t}\n\t\tbreak;\n#ifdef CONFIG_KEYS\n\tcase LSM_AUDIT_DATA_KEY:\n\t\taudit_log_format(ab, \" key_serial=%u\", a->u.key_struct.key);\n\t\tif (a->u.key_struct.key_desc) {\n\t\t\taudit_log_format(ab, \" key_desc=\");\n\t\t\taudit_log_untrustedstring(ab, a->u.key_struct.key_desc);\n\t\t}\n\t\tbreak;\n#endif\n\tcase LSM_AUDIT_DATA_KMOD:\n\t\taudit_log_format(ab, \" kmod=\");\n\t\taudit_log_untrustedstring(ab, a->u.kmod_name);\n\t\tbreak;\n\tcase LSM_AUDIT_DATA_IBPKEY: {\n\t\tstruct in6_addr sbn_pfx;\n\n\t\tmemset(&sbn_pfx.s6_addr, 0,\n\t\t       sizeof(sbn_pfx.s6_addr));\n\t\tmemcpy(&sbn_pfx.s6_addr, &a->u.ibpkey->subnet_prefix,\n\t\t       sizeof(a->u.ibpkey->subnet_prefix));\n\t\taudit_log_format(ab, \" pkey=0x%x subnet_prefix=%pI6c\",\n\t\t\t\t a->u.ibpkey->pkey, &sbn_pfx);\n\t\tbreak;\n\t}\n\tcase LSM_AUDIT_DATA_IBENDPORT:\n\t\taudit_log_format(ab, \" device=%s port_num=%u\",\n\t\t\t\t a->u.ibendport->dev_name,\n\t\t\t\t a->u.ibendport->port);\n\t\tbreak;\n\tcase LSM_AUDIT_DATA_LOCKDOWN:\n\t\taudit_log_format(ab, \" lockdown_reason=\\\"%s\\\"\",\n\t\t\t\t lockdown_reasons[a->u.reason]);\n\t\tbreak;\n\tcase LSM_AUDIT_DATA_ANONINODE:\n\t\taudit_log_format(ab, \" anonclass=%s\", a->u.anonclass);\n\t\tbreak;\n\t}  \n}\n\n \nvoid common_lsm_audit(struct common_audit_data *a,\n\tvoid (*pre_audit)(struct audit_buffer *, void *),\n\tvoid (*post_audit)(struct audit_buffer *, void *))\n{\n\tstruct audit_buffer *ab;\n\n\tif (a == NULL)\n\t\treturn;\n\t \n\tab = audit_log_start(audit_context(), GFP_ATOMIC | __GFP_NOWARN,\n\t\t\t     AUDIT_AVC);\n\n\tif (ab == NULL)\n\t\treturn;\n\n\tif (pre_audit)\n\t\tpre_audit(ab, a);\n\n\tdump_common_audit_data(ab, a);\n\n\tif (post_audit)\n\t\tpost_audit(ab, a);\n\n\taudit_log_end(ab);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}