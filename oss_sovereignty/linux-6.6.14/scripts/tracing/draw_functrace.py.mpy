{
  "module_name": "draw_functrace.py",
  "hash_id": "0eaeb12a76dfa80e16224f3251fbece0f43e0e159aca6cb3b09d7a32c5df5afc",
  "original_prompt": "Ingested from linux-6.6.14/scripts/tracing/draw_functrace.py",
  "human_readable_source": "#!/usr/bin/env python\n# SPDX-License-Identifier: GPL-2.0-only\n\n\"\"\"\nCopyright 2008 (c) Frederic Weisbecker <fweisbec@gmail.com>\n\nThis script parses a trace provided by the function tracer in\nkernel/trace/trace_functions.c\nThe resulted trace is processed into a tree to produce a more human\nview of the call stack by drawing textual but hierarchical tree of\ncalls. Only the functions's names and the call time are provided.\n\nUsage:\n\tBe sure that you have CONFIG_FUNCTION_TRACER\n\t# mount -t tracefs nodev /sys/kernel/tracing\n\t# echo function > /sys/kernel/tracing/current_tracer\n\t$ cat /sys/kernel/tracing/trace_pipe > ~/raw_trace_func\n\tWait some times but not too much, the script is a bit slow.\n\tBreak the pipe (Ctrl + Z)\n\t$ scripts/tracing/draw_functrace.py < ~/raw_trace_func > draw_functrace\n\tThen you have your drawn trace in draw_functrace\n\"\"\"\n\n\nimport sys, re\n\nclass CallTree:\n\t\"\"\" This class provides a tree representation of the functions\n\t\tcall stack. If a function has no parent in the kernel (interrupt,\n\t\tsyscall, kernel thread...) then it is attached to a virtual parent\n\t\tcalled ROOT.\n\t\"\"\"\n\tROOT = None\n\n\tdef __init__(self, func, time = None, parent = None):\n\t\tself._func = func\n\t\tself._time = time\n\t\tif parent is None:\n\t\t\tself._parent = CallTree.ROOT\n\t\telse:\n\t\t\tself._parent = parent\n\t\tself._children = []\n\n\tdef calls(self, func, calltime):\n\t\t\"\"\" If a function calls another one, call this method to insert it\n\t\t\tinto the tree at the appropriate place.\n\t\t\t@return: A reference to the newly created child node.\n\t\t\"\"\"\n\t\tchild = CallTree(func, calltime, self)\n\t\tself._children.append(child)\n\t\treturn child\n\n\tdef getParent(self, func):\n\t\t\"\"\" Retrieve the last parent of the current node that\n\t\t\thas the name given by func. If this function is not\n\t\t\ton a parent, then create it as new child of root\n\t\t\t@return: A reference to the parent.\n\t\t\"\"\"\n\t\ttree = self\n\t\twhile tree != CallTree.ROOT and tree._func != func:\n\t\t\ttree = tree._parent\n\t\tif tree == CallTree.ROOT:\n\t\t\tchild = CallTree.ROOT.calls(func, None)\n\t\t\treturn child\n\t\treturn tree\n\n\tdef __repr__(self):\n\t\treturn self.__toString(\"\", True)\n\n\tdef __toString(self, branch, lastChild):\n\t\tif self._time is not None:\n\t\t\ts = \"%s----%s (%s)\\n\" % (branch, self._func, self._time)\n\t\telse:\n\t\t\ts = \"%s----%s\\n\" % (branch, self._func)\n\n\t\ti = 0\n\t\tif lastChild:\n\t\t\tbranch = branch[:-1] + \" \"\n\t\twhile i < len(self._children):\n\t\t\tif i != len(self._children) - 1:\n\t\t\t\ts += \"%s\" % self._children[i].__toString(branch +\\\n\t\t\t\t\t\t\t\t\"    |\", False)\n\t\t\telse:\n\t\t\t\ts += \"%s\" % self._children[i].__toString(branch +\\\n\t\t\t\t\t\t\t\t\"    |\", True)\n\t\t\ti += 1\n\t\treturn s\n\nclass BrokenLineException(Exception):\n\t\"\"\"If the last line is not complete because of the pipe breakage,\n\t   we want to stop the processing and ignore this line.\n\t\"\"\"\n\tpass\n\nclass CommentLineException(Exception):\n\t\"\"\" If the line is a comment (as in the beginning of the trace file),\n\t    just ignore it.\n\t\"\"\"\n\tpass\n\n\ndef parseLine(line):\n\tline = line.strip()\n\tif line.startswith(\"#\"):\n\t\traise CommentLineException\n\tm = re.match(\"[^]]+?\\\\] +([a-z.]+) +([0-9.]+): (\\\\w+) <-(\\\\w+)\", line)\n\tif m is None:\n\t\traise BrokenLineException\n\treturn (m.group(2), m.group(3), m.group(4))\n\n\ndef main():\n\tCallTree.ROOT = CallTree(\"Root (Nowhere)\", None, None)\n\ttree = CallTree.ROOT\n\n\tfor line in sys.stdin:\n\t\ttry:\n\t\t\tcalltime, callee, caller = parseLine(line)\n\t\texcept BrokenLineException:\n\t\t\tbreak\n\t\texcept CommentLineException:\n\t\t\tcontinue\n\t\ttree = tree.getParent(caller)\n\t\ttree = tree.calls(callee, calltime)\n\n\tprint(CallTree.ROOT)\n\nif __name__ == \"__main__\":\n\tmain()\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}