{
  "module_name": "device.py",
  "hash_id": "9139ba47f09862844544472bfbfa6268208d92a9b1ddc4fa89ebf17e6bfa907f",
  "original_prompt": "Ingested from linux-6.6.14/scripts/gdb/linux/device.py",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n#\n# Copyright (c) NXP 2019\n\nimport gdb\n\nfrom linux.utils import CachedType\nfrom linux.utils import container_of\nfrom linux.lists import list_for_each_entry\n\n\ndevice_private_type = CachedType('struct device_private')\ndevice_type = CachedType('struct device')\n\nsubsys_private_type = CachedType('struct subsys_private')\nkobject_type = CachedType('struct kobject')\nkset_type = CachedType('struct kset')\n\nbus_type = CachedType('struct bus_type')\nclass_type = CachedType('struct class')\n\n\ndef dev_name(dev):\n    dev_init_name = dev['init_name']\n    if dev_init_name:\n        return dev_init_name.string()\n    return dev['kobj']['name'].string()\n\n\ndef kset_for_each_object(kset):\n    return list_for_each_entry(kset['list'],\n            kobject_type.get_type().pointer(), \"entry\")\n\n\ndef for_each_bus():\n    for kobj in kset_for_each_object(gdb.parse_and_eval('bus_kset')):\n        subsys = container_of(kobj, kset_type.get_type().pointer(), 'kobj')\n        subsys_priv = container_of(subsys, subsys_private_type.get_type().pointer(), 'subsys')\n        yield subsys_priv\n\n\ndef for_each_class():\n    for kobj in kset_for_each_object(gdb.parse_and_eval('class_kset')):\n        subsys = container_of(kobj, kset_type.get_type().pointer(), 'kobj')\n        subsys_priv = container_of(subsys, subsys_private_type.get_type().pointer(), 'subsys')\n        yield subsys_priv\n\n\ndef get_bus_by_name(name):\n    for item in for_each_bus():\n        if item['bus']['name'].string() == name:\n            return item\n    raise gdb.GdbError(\"Can't find bus type {!r}\".format(name))\n\n\ndef get_class_by_name(name):\n    for item in for_each_class():\n        if item['class']['name'].string() == name:\n            return item\n    raise gdb.GdbError(\"Can't find device class {!r}\".format(name))\n\n\nklist_type = CachedType('struct klist')\nklist_node_type = CachedType('struct klist_node')\n\n\ndef klist_for_each(klist):\n    return list_for_each_entry(klist['k_list'],\n                klist_node_type.get_type().pointer(), 'n_node')\n\n\ndef bus_for_each_device(bus):\n    for kn in klist_for_each(bus['klist_devices']):\n        dp = container_of(kn, device_private_type.get_type().pointer(), 'knode_bus')\n        yield dp['device']\n\n\ndef class_for_each_device(cls):\n    for kn in klist_for_each(cls['klist_devices']):\n        dp = container_of(kn, device_private_type.get_type().pointer(), 'knode_class')\n        yield dp['device']\n\n\ndef device_for_each_child(dev):\n    for kn in klist_for_each(dev['p']['klist_children']):\n        dp = container_of(kn, device_private_type.get_type().pointer(), 'knode_parent')\n        yield dp['device']\n\n\ndef _show_device(dev, level=0, recursive=False):\n    gdb.write('{}dev {}:\\t{}\\n'.format('\\t' * level, dev_name(dev), dev))\n    if recursive:\n        for child in device_for_each_child(dev):\n            _show_device(child, level + 1, recursive)\n\n\nclass LxDeviceListBus(gdb.Command):\n    '''Print devices on a bus (or all buses if not specified)'''\n\n    def __init__(self):\n        super(LxDeviceListBus, self).__init__('lx-device-list-bus', gdb.COMMAND_DATA)\n\n    def invoke(self, arg, from_tty):\n        if not arg:\n            for bus in for_each_bus():\n                gdb.write('bus {}:\\t{}\\n'.format(bus['bus']['name'].string(), bus))\n                for dev in bus_for_each_device(bus):\n                    _show_device(dev, level=1)\n        else:\n            bus = get_bus_by_name(arg)\n            if not bus:\n                raise gdb.GdbError(\"Can't find bus {!r}\".format(arg))\n            for dev in bus_for_each_device(bus):\n                _show_device(dev)\n\n\nclass LxDeviceListClass(gdb.Command):\n    '''Print devices in a class (or all classes if not specified)'''\n\n    def __init__(self):\n        super(LxDeviceListClass, self).__init__('lx-device-list-class', gdb.COMMAND_DATA)\n\n    def invoke(self, arg, from_tty):\n        if not arg:\n            for cls in for_each_class():\n                gdb.write(\"class {}:\\t{}\\n\".format(cls['class']['name'].string(), cls))\n                for dev in class_for_each_device(cls):\n                    _show_device(dev, level=1)\n        else:\n            cls = get_class_by_name(arg)\n            for dev in class_for_each_device(cls):\n                _show_device(dev)\n\n\nclass LxDeviceListTree(gdb.Command):\n    '''Print a device and its children recursively'''\n\n    def __init__(self):\n        super(LxDeviceListTree, self).__init__('lx-device-list-tree', gdb.COMMAND_DATA)\n\n    def invoke(self, arg, from_tty):\n        if not arg:\n            raise gdb.GdbError('Please provide pointer to struct device')\n        dev = gdb.parse_and_eval(arg)\n        if dev.type != device_type.get_type().pointer():\n            raise gdb.GdbError('Please provide pointer to struct device')\n        _show_device(dev, level=0, recursive=True)\n\n\nclass LxDeviceFindByBusName(gdb.Function):\n    '''Find struct device by bus and name (both strings)'''\n\n    def __init__(self):\n        super(LxDeviceFindByBusName, self).__init__('lx_device_find_by_bus_name')\n\n    def invoke(self, bus, name):\n        name = name.string()\n        bus = get_bus_by_name(bus.string())\n        for dev in bus_for_each_device(bus):\n            if dev_name(dev) == name:\n                return dev\n\n\nclass LxDeviceFindByClassName(gdb.Function):\n    '''Find struct device by class and name (both strings)'''\n\n    def __init__(self):\n        super(LxDeviceFindByClassName, self).__init__('lx_device_find_by_class_name')\n\n    def invoke(self, cls, name):\n        name = name.string()\n        cls = get_class_by_name(cls.string())\n        for dev in class_for_each_device(cls):\n            if dev_name(dev) == name:\n                return dev\n\n\nLxDeviceListBus()\nLxDeviceListClass()\nLxDeviceListTree()\nLxDeviceFindByBusName()\nLxDeviceFindByClassName()\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}