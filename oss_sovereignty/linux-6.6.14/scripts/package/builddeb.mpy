{
  "module_name": "builddeb",
  "hash_id": "21d6fe90571ebd5a296ac6b264fc5231c7ae3a8b502dac642b1e8fe838529932",
  "original_prompt": "Ingested from linux-6.6.14/scripts/package/builddeb",
  "human_readable_source": "#!/bin/sh\n#\n# builddeb 1.3\n# Copyright 2003 Wichert Akkerman <wichert@wiggy.net>\n#\n# Simple script to generate a deb package for a Linux kernel. All the\n# complexity of what to do with a kernel after it is installed or removed\n# is left to other scripts and packages: they can install scripts in the\n# /etc/kernel/{pre,post}{inst,rm}.d/ directories (or an alternative location\n# specified in KDEB_HOOKDIR) that will be called on package install and\n# removal.\n\nset -e\n\nis_enabled() {\n\tgrep -q \"^$1=y\" include/config/auto.conf\n}\n\nif_enabled_echo() {\n\tif is_enabled \"$1\"; then\n\t\techo -n \"$2\"\n\telif [ $# -ge 3 ]; then\n\t\techo -n \"$3\"\n\tfi\n}\n\ncreate_package() {\n\tlocal pname=\"$1\" pdir=\"$2\"\n\tlocal dpkg_deb_opts\n\n\tmkdir -m 755 -p \"$pdir/DEBIAN\"\n\tmkdir -p \"$pdir/usr/share/doc/$pname\"\n\tcp debian/copyright \"$pdir/usr/share/doc/$pname/\"\n\tcp debian/changelog \"$pdir/usr/share/doc/$pname/changelog.Debian\"\n\tgzip -n -9 \"$pdir/usr/share/doc/$pname/changelog.Debian\"\n\tsh -c \"cd '$pdir'; find . -type f ! -path './DEBIAN/*' -printf '%P\\0' \\\n\t\t| xargs -r0 md5sum > DEBIAN/md5sums\"\n\n\t# Fix ownership and permissions\n\tif [ \"$DEB_RULES_REQUIRES_ROOT\" = \"no\" ]; then\n\t\tdpkg_deb_opts=\"--root-owner-group\"\n\telse\n\t\tchown -R root:root \"$pdir\"\n\tfi\n\t# a+rX in case we are in a restrictive umask environment like 0077\n\t# ug-s in case we build in a setuid/setgid directory\n\tchmod -R go-w,a+rX,ug-s \"$pdir\"\n\n\t# Create the package\n\tdpkg-gencontrol -p$pname -P\"$pdir\"\n\tdpkg-deb $dpkg_deb_opts ${KDEB_COMPRESS:+-Z$KDEB_COMPRESS} --build \"$pdir\" ..\n}\n\ninstall_linux_image () {\n\tpdir=$1\n\tpname=$2\n\n\trm -rf ${pdir}\n\n\t# Only some architectures with OF support have this target\n\tif is_enabled CONFIG_OF_EARLY_FLATTREE && [ -d \"${srctree}/arch/${SRCARCH}/boot/dts\" ]; then\n\t\t${MAKE} -f ${srctree}/Makefile INSTALL_DTBS_PATH=\"${pdir}/usr/lib/linux-image-${KERNELRELEASE}\" dtbs_install\n\tfi\n\n\t${MAKE} -f ${srctree}/Makefile INSTALL_MOD_PATH=\"${pdir}\" modules_install\n\trm -f \"${pdir}/lib/modules/${KERNELRELEASE}/build\"\n\n\t# Install the kernel\n\tif [ \"${ARCH}\" = um ] ; then\n\t\tmkdir -p \"${pdir}/usr/lib/uml/modules\"\n\t\tmv \"${pdir}/lib/modules/${KERNELRELEASE}\" \"${pdir}/usr/lib/uml/modules/${KERNELRELEASE}\"\n\t\tmkdir -p \"${pdir}/usr/bin\" \"${pdir}/usr/share/doc/${pname}\"\n\t\tcp System.map \"${pdir}/usr/lib/uml/modules/${KERNELRELEASE}/System.map\"\n\t\tcp ${KCONFIG_CONFIG} \"${pdir}/usr/share/doc/${pname}/config\"\n\t\tgzip \"${pdir}/usr/share/doc/${pname}/config\"\n\telse\n\t\tmkdir -p \"${pdir}/boot\"\n\t\tcp System.map \"${pdir}/boot/System.map-${KERNELRELEASE}\"\n\t\tcp ${KCONFIG_CONFIG} \"${pdir}/boot/config-${KERNELRELEASE}\"\n\tfi\n\n\t# Not all arches have the same installed path in debian\n\t# XXX: have each arch Makefile export a variable of the canonical image install\n\t# path instead\n\tcase \"${SRCARCH}\" in\n\tum)\n\t\tinstalled_image_path=\"usr/bin/linux-${KERNELRELEASE}\";;\n\tparisc|mips|powerpc)\n\t\tinstalled_image_path=\"boot/vmlinux-${KERNELRELEASE}\";;\n\t*)\n\t\tinstalled_image_path=\"boot/vmlinuz-${KERNELRELEASE}\";;\n\tesac\n\tcp \"$(${MAKE} -s -f ${srctree}/Makefile image_name)\" \"${pdir}/${installed_image_path}\"\n\n\t# Install the maintainer scripts\n\t# Note: hook scripts under /etc/kernel are also executed by official Debian\n\t# kernel packages, as well as kernel packages built using make-kpkg.\n\t# make-kpkg sets $INITRD to indicate whether an initramfs is wanted, and\n\t# so do we; recent versions of dracut and initramfs-tools will obey this.\n\tdebhookdir=${KDEB_HOOKDIR:-/etc/kernel}\n\tfor script in postinst postrm preinst prerm; do\n\t\tmkdir -p \"${pdir}${debhookdir}/${script}.d\"\n\n\t\tmkdir -p \"${pdir}/DEBIAN\"\n\t\tcat <<-EOF > \"${pdir}/DEBIAN/${script}\"\n\n\t\t#!/bin/sh\n\n\t\tset -e\n\n\t\t# Pass maintainer script parameters to hook scripts\n\t\texport DEB_MAINT_PARAMS=\"\\$*\"\n\n\t\t# Tell initramfs builder whether it's wanted\n\t\texport INITRD=$(if_enabled_echo CONFIG_BLK_DEV_INITRD Yes No)\n\n\t\ttest -d ${debhookdir}/${script}.d && run-parts --arg=\"${KERNELRELEASE}\" --arg=\"/${installed_image_path}\" ${debhookdir}/${script}.d\n\t\texit 0\n\t\tEOF\n\t\tchmod 755 \"${pdir}/DEBIAN/${script}\"\n\tdone\n}\n\ninstall_linux_image_dbg () {\n\tpdir=$1\n\timage_pdir=$2\n\n\trm -rf ${pdir}\n\n\tfor module in $(find ${image_pdir}/lib/modules/ -name *.ko -printf '%P\\n'); do\n\t\tmodule=lib/modules/${module}\n\t\tmkdir -p $(dirname ${pdir}/usr/lib/debug/${module})\n\t\t# only keep debug symbols in the debug file\n\t\t${OBJCOPY} --only-keep-debug ${image_pdir}/${module} ${pdir}/usr/lib/debug/${module}\n\t\t# strip original module from debug symbols\n\t\t${OBJCOPY} --strip-debug ${image_pdir}/${module}\n\t\t# then add a link to those\n\t\t${OBJCOPY} --add-gnu-debuglink=${pdir}/usr/lib/debug/${module} ${image_pdir}/${module}\n\tdone\n\n\t# re-sign stripped modules\n\tif is_enabled CONFIG_MODULE_SIG_ALL; then\n\t\t${MAKE} -f ${srctree}/Makefile INSTALL_MOD_PATH=\"${image_pdir}\" modules_sign\n\tfi\n\n\t# Build debug package\n\t# Different tools want the image in different locations\n\t# perf\n\tmkdir -p ${pdir}/usr/lib/debug/lib/modules/${KERNELRELEASE}/\n\tcp vmlinux ${pdir}/usr/lib/debug/lib/modules/${KERNELRELEASE}/\n\t# systemtap\n\tmkdir -p ${pdir}/usr/lib/debug/boot/\n\tln -s ../lib/modules/${KERNELRELEASE}/vmlinux ${pdir}/usr/lib/debug/boot/vmlinux-${KERNELRELEASE}\n\t# kdump-tools\n\tln -s lib/modules/${KERNELRELEASE}/vmlinux ${pdir}/usr/lib/debug/vmlinux-${KERNELRELEASE}\n}\n\ninstall_kernel_headers () {\n\tpdir=$1\n\tversion=$2\n\n\trm -rf $pdir\n\n\t\"${srctree}/scripts/package/install-extmod-build\" \"${pdir}/usr/src/linux-headers-${version}\"\n\n\tmkdir -p $pdir/lib/modules/$version/\n\tln -s /usr/src/linux-headers-$version $pdir/lib/modules/$version/build\n}\n\ninstall_libc_headers () {\n\tpdir=$1\n\n\trm -rf $pdir\n\n\t$MAKE -f $srctree/Makefile headers\n\t$MAKE -f $srctree/Makefile headers_install INSTALL_HDR_PATH=$pdir/usr\n\n\t# move asm headers to /usr/include/<libc-machine>/asm to match the structure\n\t# used by Debian-based distros (to support multi-arch)\n\thost_arch=$(dpkg-architecture -a$DEB_HOST_ARCH -qDEB_HOST_MULTIARCH)\n\tmkdir $pdir/usr/include/$host_arch\n\tmv $pdir/usr/include/asm $pdir/usr/include/$host_arch/\n}\n\nrm -f debian/files\n\npackages_enabled=$(dh_listpackages)\n\nfor package in ${packages_enabled}\ndo\n\tcase ${package} in\n\t*-dbg)\n\t\t# This must be done after linux-image, that is, we expect the\n\t\t# debug package appears after linux-image in debian/control.\n\t\tinstall_linux_image_dbg debian/linux-image-dbg debian/linux-image;;\n\tlinux-image-*|user-mode-linux-*)\n\t\tinstall_linux_image debian/linux-image ${package};;\n\tlinux-libc-dev)\n\t\tinstall_libc_headers debian/linux-libc-dev;;\n\tlinux-headers-*)\n\t\tinstall_kernel_headers debian/linux-headers ${package#linux-headers-};;\n\tesac\ndone\n\nfor package in ${packages_enabled}\ndo\n\tcase ${package} in\n\t*-dbg)\n\t\tcreate_package ${package} debian/linux-image-dbg;;\n\tlinux-image-*|user-mode-linux-*)\n\t\tcreate_package ${package} debian/linux-image;;\n\tlinux-libc-dev)\n\t\tcreate_package ${package} debian/linux-libc-dev;;\n\tlinux-headers-*)\n\t\tcreate_package ${package} debian/linux-headers;;\n\tesac\ndone\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}