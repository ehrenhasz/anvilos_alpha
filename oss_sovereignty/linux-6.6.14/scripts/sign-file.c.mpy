{
  "module_name": "sign-file.c",
  "hash_id": "73bfe76d55d725a54472d5fd1482e30a00103de89beec53547cbf0710349d797",
  "original_prompt": "Ingested from linux-6.6.14/scripts/sign-file.c",
  "human_readable_source": " \n#define _GNU_SOURCE\n#include <stdio.h>\n#include <stdlib.h>\n#include <stdint.h>\n#include <stdbool.h>\n#include <string.h>\n#include <getopt.h>\n#include <err.h>\n#include <arpa/inet.h>\n#include <openssl/opensslv.h>\n#include <openssl/bio.h>\n#include <openssl/evp.h>\n#include <openssl/pem.h>\n#include <openssl/err.h>\n#include <openssl/engine.h>\n\n \n#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n\n \n#if defined(LIBRESSL_VERSION_NUMBER) || \\\n\tOPENSSL_VERSION_NUMBER < 0x10000000L || \\\n\tdefined(OPENSSL_NO_CMS)\n#define USE_PKCS7\n#endif\n#ifndef USE_PKCS7\n#include <openssl/cms.h>\n#else\n#include <openssl/pkcs7.h>\n#endif\n\nstruct module_signature {\n\tuint8_t\t\talgo;\t\t \n\tuint8_t\t\thash;\t\t \n\tuint8_t\t\tid_type;\t \n\tuint8_t\t\tsigner_len;\t \n\tuint8_t\t\tkey_id_len;\t \n\tuint8_t\t\t__pad[3];\n\tuint32_t\tsig_len;\t \n};\n\n#define PKEY_ID_PKCS7 2\n\nstatic char magic_number[] = \"~Module signature appended~\\n\";\n\nstatic __attribute__((noreturn))\nvoid format(void)\n{\n\tfprintf(stderr,\n\t\t\"Usage: scripts/sign-file [-dp] <hash algo> <key> <x509> <module> [<dest>]\\n\");\n\tfprintf(stderr,\n\t\t\"       scripts/sign-file -s <raw sig> <hash algo> <x509> <module> [<dest>]\\n\");\n\texit(2);\n}\n\nstatic void display_openssl_errors(int l)\n{\n\tconst char *file;\n\tchar buf[120];\n\tint e, line;\n\n\tif (ERR_peek_error() == 0)\n\t\treturn;\n\tfprintf(stderr, \"At main.c:%d:\\n\", l);\n\n\twhile ((e = ERR_get_error_line(&file, &line))) {\n\t\tERR_error_string(e, buf);\n\t\tfprintf(stderr, \"- SSL %s: %s:%d\\n\", buf, file, line);\n\t}\n}\n\nstatic void drain_openssl_errors(void)\n{\n\tconst char *file;\n\tint line;\n\n\tif (ERR_peek_error() == 0)\n\t\treturn;\n\twhile (ERR_get_error_line(&file, &line)) {}\n}\n\n#define ERR(cond, fmt, ...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tbool __cond = (cond);\t\t\t\\\n\t\tdisplay_openssl_errors(__LINE__);\t\\\n\t\tif (__cond) {\t\t\t\t\\\n\t\t\terrx(1, fmt, ## __VA_ARGS__);\t\\\n\t\t}\t\t\t\t\t\\\n\t} while(0)\n\nstatic const char *key_pass;\n\nstatic int pem_pw_cb(char *buf, int len, int w, void *v)\n{\n\tint pwlen;\n\n\tif (!key_pass)\n\t\treturn -1;\n\n\tpwlen = strlen(key_pass);\n\tif (pwlen >= len)\n\t\treturn -1;\n\n\tstrcpy(buf, key_pass);\n\n\t \n\tkey_pass = NULL;\n\n\treturn pwlen;\n}\n\nstatic EVP_PKEY *read_private_key(const char *private_key_name)\n{\n\tEVP_PKEY *private_key;\n\n\tif (!strncmp(private_key_name, \"pkcs11:\", 7)) {\n\t\tENGINE *e;\n\n\t\tENGINE_load_builtin_engines();\n\t\tdrain_openssl_errors();\n\t\te = ENGINE_by_id(\"pkcs11\");\n\t\tERR(!e, \"Load PKCS#11 ENGINE\");\n\t\tif (ENGINE_init(e))\n\t\t\tdrain_openssl_errors();\n\t\telse\n\t\t\tERR(1, \"ENGINE_init\");\n\t\tif (key_pass)\n\t\t\tERR(!ENGINE_ctrl_cmd_string(e, \"PIN\", key_pass, 0),\n\t\t\t    \"Set PKCS#11 PIN\");\n\t\tprivate_key = ENGINE_load_private_key(e, private_key_name,\n\t\t\t\t\t\t      NULL, NULL);\n\t\tERR(!private_key, \"%s\", private_key_name);\n\t} else {\n\t\tBIO *b;\n\n\t\tb = BIO_new_file(private_key_name, \"rb\");\n\t\tERR(!b, \"%s\", private_key_name);\n\t\tprivate_key = PEM_read_bio_PrivateKey(b, NULL, pem_pw_cb,\n\t\t\t\t\t\t      NULL);\n\t\tERR(!private_key, \"%s\", private_key_name);\n\t\tBIO_free(b);\n\t}\n\n\treturn private_key;\n}\n\nstatic X509 *read_x509(const char *x509_name)\n{\n\tunsigned char buf[2];\n\tX509 *x509;\n\tBIO *b;\n\tint n;\n\n\tb = BIO_new_file(x509_name, \"rb\");\n\tERR(!b, \"%s\", x509_name);\n\n\t \n\tn = BIO_read(b, buf, 2);\n\tif (n != 2) {\n\t\tif (BIO_should_retry(b)) {\n\t\t\tfprintf(stderr, \"%s: Read wanted retry\\n\", x509_name);\n\t\t\texit(1);\n\t\t}\n\t\tif (n >= 0) {\n\t\t\tfprintf(stderr, \"%s: Short read\\n\", x509_name);\n\t\t\texit(1);\n\t\t}\n\t\tERR(1, \"%s\", x509_name);\n\t}\n\n\tERR(BIO_reset(b) != 0, \"%s\", x509_name);\n\n\tif (buf[0] == 0x30 && buf[1] >= 0x81 && buf[1] <= 0x84)\n\t\t \n\t\tx509 = d2i_X509_bio(b, NULL);\n\telse\n\t\t \n\t\tx509 = PEM_read_bio_X509(b, NULL, NULL, NULL);\n\n\tBIO_free(b);\n\tERR(!x509, \"%s\", x509_name);\n\n\treturn x509;\n}\n\nint main(int argc, char **argv)\n{\n\tstruct module_signature sig_info = { .id_type = PKEY_ID_PKCS7 };\n\tchar *hash_algo = NULL;\n\tchar *private_key_name = NULL, *raw_sig_name = NULL;\n\tchar *x509_name, *module_name, *dest_name;\n\tbool save_sig = false, replace_orig;\n\tbool sign_only = false;\n\tbool raw_sig = false;\n\tunsigned char buf[4096];\n\tunsigned long module_size, sig_size;\n\tunsigned int use_signed_attrs;\n\tconst EVP_MD *digest_algo;\n\tEVP_PKEY *private_key;\n#ifndef USE_PKCS7\n\tCMS_ContentInfo *cms = NULL;\n\tunsigned int use_keyid = 0;\n#else\n\tPKCS7 *pkcs7 = NULL;\n#endif\n\tX509 *x509;\n\tBIO *bd, *bm;\n\tint opt, n;\n\tOpenSSL_add_all_algorithms();\n\tERR_load_crypto_strings();\n\tERR_clear_error();\n\n\tkey_pass = getenv(\"KBUILD_SIGN_PIN\");\n\n#ifndef USE_PKCS7\n\tuse_signed_attrs = CMS_NOATTR;\n#else\n\tuse_signed_attrs = PKCS7_NOATTR;\n#endif\n\n\tdo {\n\t\topt = getopt(argc, argv, \"sdpk\");\n\t\tswitch (opt) {\n\t\tcase 's': raw_sig = true; break;\n\t\tcase 'p': save_sig = true; break;\n\t\tcase 'd': sign_only = true; save_sig = true; break;\n#ifndef USE_PKCS7\n\t\tcase 'k': use_keyid = CMS_USE_KEYID; break;\n#endif\n\t\tcase -1: break;\n\t\tdefault: format();\n\t\t}\n\t} while (opt != -1);\n\n\targc -= optind;\n\targv += optind;\n\tif (argc < 4 || argc > 5)\n\t\tformat();\n\n\tif (raw_sig) {\n\t\traw_sig_name = argv[0];\n\t\thash_algo = argv[1];\n\t} else {\n\t\thash_algo = argv[0];\n\t\tprivate_key_name = argv[1];\n\t}\n\tx509_name = argv[2];\n\tmodule_name = argv[3];\n\tif (argc == 5 && strcmp(argv[3], argv[4]) != 0) {\n\t\tdest_name = argv[4];\n\t\treplace_orig = false;\n\t} else {\n\t\tERR(asprintf(&dest_name, \"%s.~signed~\", module_name) < 0,\n\t\t    \"asprintf\");\n\t\treplace_orig = true;\n\t}\n\n#ifdef USE_PKCS7\n\tif (strcmp(hash_algo, \"sha1\") != 0) {\n\t\tfprintf(stderr, \"sign-file: %s only supports SHA1 signing\\n\",\n\t\t\tOPENSSL_VERSION_TEXT);\n\t\texit(3);\n\t}\n#endif\n\n\t \n\tbm = BIO_new_file(module_name, \"rb\");\n\tERR(!bm, \"%s\", module_name);\n\n\tif (!raw_sig) {\n\t\t \n\t\tprivate_key = read_private_key(private_key_name);\n\t\tx509 = read_x509(x509_name);\n\n\t\t \n\t\tOpenSSL_add_all_digests();\n\t\tdisplay_openssl_errors(__LINE__);\n\t\tdigest_algo = EVP_get_digestbyname(hash_algo);\n\t\tERR(!digest_algo, \"EVP_get_digestbyname\");\n\n#ifndef USE_PKCS7\n\t\t \n\t\tcms = CMS_sign(NULL, NULL, NULL, NULL,\n\t\t\t       CMS_NOCERTS | CMS_PARTIAL | CMS_BINARY |\n\t\t\t       CMS_DETACHED | CMS_STREAM);\n\t\tERR(!cms, \"CMS_sign\");\n\n\t\tERR(!CMS_add1_signer(cms, x509, private_key, digest_algo,\n\t\t\t\t     CMS_NOCERTS | CMS_BINARY |\n\t\t\t\t     CMS_NOSMIMECAP | use_keyid |\n\t\t\t\t     use_signed_attrs),\n\t\t    \"CMS_add1_signer\");\n\t\tERR(CMS_final(cms, bm, NULL, CMS_NOCERTS | CMS_BINARY) != 1,\n\t\t    \"CMS_final\");\n\n#else\n\t\tpkcs7 = PKCS7_sign(x509, private_key, NULL, bm,\n\t\t\t\t   PKCS7_NOCERTS | PKCS7_BINARY |\n\t\t\t\t   PKCS7_DETACHED | use_signed_attrs);\n\t\tERR(!pkcs7, \"PKCS7_sign\");\n#endif\n\n\t\tif (save_sig) {\n\t\t\tchar *sig_file_name;\n\t\t\tBIO *b;\n\n\t\t\tERR(asprintf(&sig_file_name, \"%s.p7s\", module_name) < 0,\n\t\t\t    \"asprintf\");\n\t\t\tb = BIO_new_file(sig_file_name, \"wb\");\n\t\t\tERR(!b, \"%s\", sig_file_name);\n#ifndef USE_PKCS7\n\t\t\tERR(i2d_CMS_bio_stream(b, cms, NULL, 0) != 1,\n\t\t\t    \"%s\", sig_file_name);\n#else\n\t\t\tERR(i2d_PKCS7_bio(b, pkcs7) != 1,\n\t\t\t    \"%s\", sig_file_name);\n#endif\n\t\t\tBIO_free(b);\n\t\t}\n\n\t\tif (sign_only) {\n\t\t\tBIO_free(bm);\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\t \n\tbd = BIO_new_file(dest_name, \"wb\");\n\tERR(!bd, \"%s\", dest_name);\n\n\t \n\tERR(BIO_reset(bm) < 0, \"%s\", module_name);\n\twhile ((n = BIO_read(bm, buf, sizeof(buf))),\n\t       n > 0) {\n\t\tERR(BIO_write(bd, buf, n) < 0, \"%s\", dest_name);\n\t}\n\tBIO_free(bm);\n\tERR(n < 0, \"%s\", module_name);\n\tmodule_size = BIO_number_written(bd);\n\n\tif (!raw_sig) {\n#ifndef USE_PKCS7\n\t\tERR(i2d_CMS_bio_stream(bd, cms, NULL, 0) != 1, \"%s\", dest_name);\n#else\n\t\tERR(i2d_PKCS7_bio(bd, pkcs7) != 1, \"%s\", dest_name);\n#endif\n\t} else {\n\t\tBIO *b;\n\n\t\t \n\t\tb = BIO_new_file(raw_sig_name, \"rb\");\n\t\tERR(!b, \"%s\", raw_sig_name);\n\t\twhile ((n = BIO_read(b, buf, sizeof(buf))), n > 0)\n\t\t\tERR(BIO_write(bd, buf, n) < 0, \"%s\", dest_name);\n\t\tBIO_free(b);\n\t}\n\n\tsig_size = BIO_number_written(bd) - module_size;\n\tsig_info.sig_len = htonl(sig_size);\n\tERR(BIO_write(bd, &sig_info, sizeof(sig_info)) < 0, \"%s\", dest_name);\n\tERR(BIO_write(bd, magic_number, sizeof(magic_number) - 1) < 0, \"%s\", dest_name);\n\n\tERR(BIO_free(bd) != 1, \"%s\", dest_name);\n\n\t \n\tif (replace_orig)\n\t\tERR(rename(dest_name, module_name) < 0, \"%s\", dest_name);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}