{
  "module_name": "export_report.pl",
  "hash_id": "21b1f60f304315853a20756b2f5d0a29fd8427f859a22635cd2e109de4b47f8a",
  "original_prompt": "Ingested from linux-6.6.14/scripts/export_report.pl",
  "human_readable_source": "#!/usr/bin/env perl\n# SPDX-License-Identifier: GPL-2.0-only\n#\n# (C) Copyright IBM Corporation 2006.\n#\tAuthor : Ram Pai (linuxram@us.ibm.com)\n#\n# Usage: export_report.pl -k Module.symvers [-o report_file ] -f *.mod.c\n#\n\nuse warnings;\nuse Getopt::Std;\nuse strict;\n\nsub numerically {\n\tmy $no1 = (split /\\s+/, $a)[1];\n\tmy $no2 = (split /\\s+/, $b)[1];\n\treturn $no1 <=> $no2;\n}\n\nsub alphabetically {\n\tmy ($module1, $value1) = @{$a};\n\tmy ($module2, $value2) = @{$b};\n\treturn $value1 <=> $value2 || $module2 cmp $module1;\n}\n\nsub print_depends_on {\n\tmy ($href) = @_;\n\tprint \"\\n\";\n\tfor my $mod (sort keys %$href) {\n\t\tmy $list = $href->{$mod};\n\t\tprint \"\\t$mod:\\n\";\n\t\tforeach my $sym (sort numerically @{$list}) {\n\t\t\tmy ($symbol, $no) = split /\\s+/, $sym;\n\t\t\tprintf(\"\\t\\t%-25s\\n\", $symbol);\n\t\t}\n\t\tprint \"\\n\";\n\t}\n\tprint \"\\n\";\n\tprint \"~\"x80 , \"\\n\";\n}\n\nsub usage {\n        print \"Usage: @_ -h -k Module.symvers  [ -o outputfile ] \\n\",\n\t      \"\\t-f: treat all the non-option argument as .mod.c files. \",\n\t      \"Recommend using this as the last option\\n\",\n\t      \"\\t-h: print detailed help\\n\",\n\t      \"\\t-k: the path to Module.symvers file. By default uses \",\n\t      \"the file from the current directory\\n\",\n\t      \"\\t-o outputfile: output the report to outputfile\\n\";\n\texit 0;\n}\n\nsub collectcfiles {\n    my @file;\n    open my $fh, '< modules.order' or die \"cannot open modules.order: $!\\n\";\n    while (<$fh>) {\n\ts/\\.ko$/.mod.c/;\n\tpush (@file, $_)\n    }\n    close($fh);\n    chomp @file;\n    return @file;\n}\n\nmy (%SYMBOL, %MODULE, %opt, @allcfiles);\n\nif (not getopts('hk:o:f',\\%opt) or defined $opt{'h'}) {\n        usage($0);\n}\n\nif (defined $opt{'f'}) {\n\t@allcfiles = @ARGV;\n} else {\n\t@allcfiles = collectcfiles();\n}\n\nif (not defined $opt{'k'}) {\n\t$opt{'k'} = \"Module.symvers\";\n}\n\nopen (my $module_symvers, '<', $opt{'k'})\n    or die \"Sorry, cannot open $opt{'k'}: $!\\n\";\n\nif (defined $opt{'o'}) {\n    open (my $out, '>', $opt{'o'})\n\tor die \"Sorry, cannot open $opt{'o'} $!\\n\";\n\n    select $out;\n}\n\n#\n# collect all the symbols and their attributes from the\n# Module.symvers file\n#\nwhile ( <$module_symvers> ) {\n\tchomp;\n\tmy (undef, $symbol, $module, $gpl, $namespace) = split('\\t');\n\t$SYMBOL { $symbol } =  [ $module , \"0\" , $symbol, $gpl];\n}\nclose($module_symvers);\n\n#\n# collect the usage count of each symbol.\n#\nmy $modversion_warnings = 0;\n\nforeach my $thismod (@allcfiles) {\n\tmy $module;\n\n\tunless (open ($module, '<', $thismod)) {\n\t\twarn \"Sorry, cannot open $thismod: $!\\n\";\n\t\tnext;\n\t}\n\n\tmy $state=0;\n\twhile ( <$module> ) {\n\t\tchomp;\n\t\tif ($state == 0) {\n\t\t\t$state = 1 if ($_ =~ /static const struct modversion_info/);\n\t\t\tnext;\n\t\t}\n\t\tif ($state == 1) {\n\t\t\t$state = 2 if ($_ =~ /__attribute__\\(\\(section\\(\"__versions\"\\)\\)\\)/);\n\t\t\tnext;\n\t\t}\n\t\tif ($state == 2) {\n\t\t\tif ( $_ !~ /0x[0-9a-f]+,/ ) {\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tmy $sym = (split /([,\"])/,)[4];\n\t\t\tmy ($module, $value, $symbol, $gpl) = @{$SYMBOL{$sym}};\n\t\t\t$SYMBOL{ $sym } =  [ $module, $value+1, $symbol, $gpl];\n\t\t\tpush(@{$MODULE{$thismod}} , $sym);\n\t\t}\n\t}\n\tif ($state != 2) {\n\t\twarn \"WARNING:$thismod is not built with CONFIG_MODVERSIONS enabled\\n\";\n\t\t$modversion_warnings++;\n\t}\n\tclose($module);\n}\n\nprint \"\\tThis file reports the exported symbols usage patterns by in-tree\\n\",\n\t\"\\t\\t\\t\\tmodules\\n\";\nprintf(\"%s\\n\\n\\n\",\"x\"x80);\nprintf(\"\\t\\t\\t\\tINDEX\\n\\n\\n\");\nprintf(\"SECTION 1: Usage counts of all exported symbols\\n\");\nprintf(\"SECTION 2: List of modules and the exported symbols they use\\n\");\nprintf(\"%s\\n\\n\\n\",\"x\"x80);\nprintf(\"SECTION 1:\\tThe exported symbols and their usage count\\n\\n\");\nprintf(\"%-25s\\t%-25s\\t%-5s\\t%-25s\\n\", \"Symbol\", \"Module\", \"Usage count\",\n\t\"export type\");\n\n#\n# print the list of unused exported symbols\n#\nforeach my $list (sort alphabetically values(%SYMBOL)) {\n\tmy ($module, $value, $symbol, $gpl) = @{$list};\n\tprintf(\"%-25s\\t%-25s\\t%-10s\\t\", $symbol, $module, $value);\n\tif (defined $gpl) {\n\t\tprintf(\"%-25s\\n\",$gpl);\n\t} else {\n\t\tprintf(\"\\n\");\n\t}\n}\nprintf(\"%s\\n\\n\\n\",\"x\"x80);\n\nprintf(\"SECTION 2:\\n\\tThis section reports export-symbol-usage of in-kernel\nmodules. Each module lists the modules, and the symbols from that module that\nit uses.  Each listed symbol reports the number of modules using it\\n\");\n\nprint \"\\nNOTE: Got $modversion_warnings CONFIG_MODVERSIONS warnings\\n\\n\"\n    if $modversion_warnings;\n\nprint \"~\"x80 , \"\\n\";\nfor my $thismod (sort keys %MODULE) {\n\tmy $list = $MODULE{$thismod};\n\tmy %depends;\n\t$thismod =~ s/\\.mod\\.c/.ko/;\n\tprint \"\\t\\t\\t$thismod\\n\";\n\tforeach my $symbol (@{$list}) {\n\t\tmy ($module, $value, undef, $gpl) = @{$SYMBOL{$symbol}};\n\t\tpush (@{$depends{\"$module\"}}, \"$symbol $value\");\n\t}\n\tprint_depends_on(\\%depends);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}