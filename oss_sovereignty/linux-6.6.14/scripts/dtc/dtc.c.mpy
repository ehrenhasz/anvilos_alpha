{
  "module_name": "dtc.c",
  "hash_id": "fce14b84415789822ab6db762a94d2fb14e856c84ca139200366f0f3781b3581",
  "original_prompt": "Ingested from linux-6.6.14/scripts/dtc/dtc.c",
  "human_readable_source": "\n \n\n#include <sys/stat.h>\n\n#include \"dtc.h\"\n#include \"srcpos.h\"\n\n \nint quiet;\t\t \nunsigned int reservenum; \nint minsize;\t\t \nint padsize;\t\t \nint alignsize;\t\t \nint phandle_format = PHANDLE_EPAPR;\t \nint generate_symbols;\t \nint generate_fixups;\t\t \nint auto_label_aliases;\t\t \nint annotate;\t\t \n\nstatic int is_power_of_2(int x)\n{\n\treturn (x > 0) && ((x & (x - 1)) == 0);\n}\n\nstatic void fill_fullpaths(struct node *tree, const char *prefix)\n{\n\tstruct node *child;\n\tconst char *unit;\n\n\ttree->fullpath = join_path(prefix, tree->name);\n\n\tunit = strchr(tree->name, '@');\n\tif (unit)\n\t\ttree->basenamelen = unit - tree->name;\n\telse\n\t\ttree->basenamelen = strlen(tree->name);\n\n\tfor_each_child(tree, child)\n\t\tfill_fullpaths(child, tree->fullpath);\n}\n\n \nstatic const char usage_synopsis[] = \"dtc [options] <input file>\";\nstatic const char usage_short_opts[] = \"qI:O:o:V:d:R:S:p:a:fb:i:H:sW:E:@AThv\";\nstatic struct option const usage_long_opts[] = {\n\t{\"quiet\",            no_argument, NULL, 'q'},\n\t{\"in-format\",         a_argument, NULL, 'I'},\n\t{\"out\",               a_argument, NULL, 'o'},\n\t{\"out-format\",        a_argument, NULL, 'O'},\n\t{\"out-version\",       a_argument, NULL, 'V'},\n\t{\"out-dependency\",    a_argument, NULL, 'd'},\n\t{\"reserve\",           a_argument, NULL, 'R'},\n\t{\"space\",             a_argument, NULL, 'S'},\n\t{\"pad\",               a_argument, NULL, 'p'},\n\t{\"align\",             a_argument, NULL, 'a'},\n\t{\"boot-cpu\",          a_argument, NULL, 'b'},\n\t{\"force\",            no_argument, NULL, 'f'},\n\t{\"include\",           a_argument, NULL, 'i'},\n\t{\"sort\",             no_argument, NULL, 's'},\n\t{\"phandle\",           a_argument, NULL, 'H'},\n\t{\"warning\",           a_argument, NULL, 'W'},\n\t{\"error\",             a_argument, NULL, 'E'},\n\t{\"symbols\",\t     no_argument, NULL, '@'},\n\t{\"auto-alias\",       no_argument, NULL, 'A'},\n\t{\"annotate\",         no_argument, NULL, 'T'},\n\t{\"help\",             no_argument, NULL, 'h'},\n\t{\"version\",          no_argument, NULL, 'v'},\n\t{NULL,               no_argument, NULL, 0x0},\n};\nstatic const char * const usage_opts_help[] = {\n\t\"\\n\\tQuiet: -q suppress warnings, -qq errors, -qqq all\",\n\t\"\\n\\tInput formats are:\\n\"\n\t \"\\t\\tdts - device tree source text\\n\"\n\t \"\\t\\tdtb - device tree blob\\n\"\n\t \"\\t\\tfs  - /proc/device-tree style directory\",\n\t\"\\n\\tOutput file\",\n\t\"\\n\\tOutput formats are:\\n\"\n\t \"\\t\\tdts - device tree source text\\n\"\n\t \"\\t\\tdtb - device tree blob\\n\"\n#ifndef NO_YAML\n\t \"\\t\\tyaml - device tree encoded as YAML\\n\"\n#endif\n\t \"\\t\\tasm - assembler source\",\n\t\"\\n\\tBlob version to produce, defaults to \"stringify(DEFAULT_FDT_VERSION)\" (for dtb and asm output)\",\n\t\"\\n\\tOutput dependency file\",\n\t\"\\n\\tMake space for <number> reserve map entries (for dtb and asm output)\",\n\t\"\\n\\tMake the blob at least <bytes> long (extra space)\",\n\t\"\\n\\tAdd padding to the blob of <bytes> long (extra space)\",\n\t\"\\n\\tMake the blob align to the <bytes> (extra space)\",\n\t\"\\n\\tSet the physical boot cpu\",\n\t\"\\n\\tTry to produce output even if the input tree has errors\",\n\t\"\\n\\tAdd a path to search for include files\",\n\t\"\\n\\tSort nodes and properties before outputting (useful for comparing trees)\",\n\t\"\\n\\tValid phandle formats are:\\n\"\n\t \"\\t\\tlegacy - \\\"linux,phandle\\\" properties only\\n\"\n\t \"\\t\\tepapr  - \\\"phandle\\\" properties only\\n\"\n\t \"\\t\\tboth   - Both \\\"linux,phandle\\\" and \\\"phandle\\\" properties\",\n\t\"\\n\\tEnable/disable warnings (prefix with \\\"no-\\\")\",\n\t\"\\n\\tEnable/disable errors (prefix with \\\"no-\\\")\",\n\t\"\\n\\tEnable generation of symbols\",\n\t\"\\n\\tEnable auto-alias of labels\",\n\t\"\\n\\tAnnotate output .dts with input source file and line (-T -T for more details)\",\n\t\"\\n\\tPrint this help and exit\",\n\t\"\\n\\tPrint version and exit\",\n\tNULL,\n};\n\nstatic const char *guess_type_by_name(const char *fname, const char *fallback)\n{\n\tconst char *s;\n\n\ts = strrchr(fname, '.');\n\tif (s == NULL)\n\t\treturn fallback;\n\tif (!strcasecmp(s, \".dts\"))\n\t\treturn \"dts\";\n\tif (!strcasecmp(s, \".yaml\"))\n\t\treturn \"yaml\";\n\tif (!strcasecmp(s, \".dtbo\"))\n\t\treturn \"dtb\";\n\tif (!strcasecmp(s, \".dtb\"))\n\t\treturn \"dtb\";\n\treturn fallback;\n}\n\nstatic const char *guess_input_format(const char *fname, const char *fallback)\n{\n\tstruct stat statbuf;\n\tfdt32_t magic;\n\tFILE *f;\n\n\tif (stat(fname, &statbuf) != 0)\n\t\treturn fallback;\n\n\tif (S_ISDIR(statbuf.st_mode))\n\t\treturn \"fs\";\n\n\tif (!S_ISREG(statbuf.st_mode))\n\t\treturn fallback;\n\n\tf = fopen(fname, \"r\");\n\tif (f == NULL)\n\t\treturn fallback;\n\tif (fread(&magic, 4, 1, f) != 1) {\n\t\tfclose(f);\n\t\treturn fallback;\n\t}\n\tfclose(f);\n\n\tif (fdt32_to_cpu(magic) == FDT_MAGIC)\n\t\treturn \"dtb\";\n\n\treturn guess_type_by_name(fname, fallback);\n}\n\nint main(int argc, char *argv[])\n{\n\tstruct dt_info *dti;\n\tconst char *inform = NULL;\n\tconst char *outform = NULL;\n\tconst char *outname = \"-\";\n\tconst char *depname = NULL;\n\tbool force = false, sort = false;\n\tconst char *arg;\n\tint opt;\n\tFILE *outf = NULL;\n\tint outversion = DEFAULT_FDT_VERSION;\n\tlong long cmdline_boot_cpuid = -1;\n\n\tquiet      = 0;\n\treservenum = 0;\n\tminsize    = 0;\n\tpadsize    = 0;\n\talignsize  = 0;\n\n\twhile ((opt = util_getopt_long()) != EOF) {\n\t\tswitch (opt) {\n\t\tcase 'I':\n\t\t\tinform = optarg;\n\t\t\tbreak;\n\t\tcase 'O':\n\t\t\toutform = optarg;\n\t\t\tbreak;\n\t\tcase 'o':\n\t\t\toutname = optarg;\n\t\t\tbreak;\n\t\tcase 'V':\n\t\t\toutversion = strtol(optarg, NULL, 0);\n\t\t\tbreak;\n\t\tcase 'd':\n\t\t\tdepname = optarg;\n\t\t\tbreak;\n\t\tcase 'R':\n\t\t\treservenum = strtoul(optarg, NULL, 0);\n\t\t\tbreak;\n\t\tcase 'S':\n\t\t\tminsize = strtol(optarg, NULL, 0);\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\tpadsize = strtol(optarg, NULL, 0);\n\t\t\tbreak;\n\t\tcase 'a':\n\t\t\talignsize = strtol(optarg, NULL, 0);\n\t\t\tif (!is_power_of_2(alignsize))\n\t\t\t\tdie(\"Invalid argument \\\"%d\\\" to -a option\\n\",\n\t\t\t\t    alignsize);\n\t\t\tbreak;\n\t\tcase 'f':\n\t\t\tforce = true;\n\t\t\tbreak;\n\t\tcase 'q':\n\t\t\tquiet++;\n\t\t\tbreak;\n\t\tcase 'b':\n\t\t\tcmdline_boot_cpuid = strtoll(optarg, NULL, 0);\n\t\t\tbreak;\n\t\tcase 'i':\n\t\t\tsrcfile_add_search_path(optarg);\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\tutil_version();\n\t\tcase 'H':\n\t\t\tif (streq(optarg, \"legacy\"))\n\t\t\t\tphandle_format = PHANDLE_LEGACY;\n\t\t\telse if (streq(optarg, \"epapr\"))\n\t\t\t\tphandle_format = PHANDLE_EPAPR;\n\t\t\telse if (streq(optarg, \"both\"))\n\t\t\t\tphandle_format = PHANDLE_BOTH;\n\t\t\telse\n\t\t\t\tdie(\"Invalid argument \\\"%s\\\" to -H option\\n\",\n\t\t\t\t    optarg);\n\t\t\tbreak;\n\n\t\tcase 's':\n\t\t\tsort = true;\n\t\t\tbreak;\n\n\t\tcase 'W':\n\t\t\tparse_checks_option(true, false, optarg);\n\t\t\tbreak;\n\n\t\tcase 'E':\n\t\t\tparse_checks_option(false, true, optarg);\n\t\t\tbreak;\n\n\t\tcase '@':\n\t\t\tgenerate_symbols = 1;\n\t\t\tbreak;\n\t\tcase 'A':\n\t\t\tauto_label_aliases = 1;\n\t\t\tbreak;\n\t\tcase 'T':\n\t\t\tannotate++;\n\t\t\tbreak;\n\n\t\tcase 'h':\n\t\t\tusage(NULL);\n\t\tdefault:\n\t\t\tusage(\"unknown option\");\n\t\t}\n\t}\n\n\tif (argc > (optind+1))\n\t\tusage(\"missing files\");\n\telse if (argc < (optind+1))\n\t\targ = \"-\";\n\telse\n\t\targ = argv[optind];\n\n\t \n\tif (minsize && padsize)\n\t\tdie(\"Can't set both -p and -S\\n\");\n\n\tif (depname) {\n\t\tdepfile = fopen(depname, \"w\");\n\t\tif (!depfile)\n\t\t\tdie(\"Couldn't open dependency file %s: %s\\n\", depname,\n\t\t\t    strerror(errno));\n\t\tfprintf(depfile, \"%s:\", outname);\n\t}\n\n\tif (inform == NULL)\n\t\tinform = guess_input_format(arg, \"dts\");\n\tif (outform == NULL) {\n\t\toutform = guess_type_by_name(outname, NULL);\n\t\tif (outform == NULL) {\n\t\t\tif (streq(inform, \"dts\"))\n\t\t\t\toutform = \"dtb\";\n\t\t\telse\n\t\t\t\toutform = \"dts\";\n\t\t}\n\t}\n\tif (annotate && (!streq(inform, \"dts\") || !streq(outform, \"dts\")))\n\t\tdie(\"--annotate requires -I dts -O dts\\n\");\n\tif (streq(inform, \"dts\"))\n\t\tdti = dt_from_source(arg);\n\telse if (streq(inform, \"fs\"))\n\t\tdti = dt_from_fs(arg);\n\telse if(streq(inform, \"dtb\"))\n\t\tdti = dt_from_blob(arg);\n\telse\n\t\tdie(\"Unknown input format \\\"%s\\\"\\n\", inform);\n\n\tdti->outname = outname;\n\n\tif (depfile) {\n\t\tfputc('\\n', depfile);\n\t\tfclose(depfile);\n\t}\n\n\tif (cmdline_boot_cpuid != -1)\n\t\tdti->boot_cpuid_phys = cmdline_boot_cpuid;\n\n\tfill_fullpaths(dti->dt, \"\");\n\n\t \n\tif (dti->dtsflags & DTSF_PLUGIN) {\n\t\tgenerate_fixups = 1;\n\t}\n\n\tprocess_checks(force, dti);\n\n\tif (auto_label_aliases)\n\t\tgenerate_label_tree(dti, \"aliases\", false);\n\n\tif (generate_symbols)\n\t\tgenerate_label_tree(dti, \"__symbols__\", true);\n\n\tif (generate_fixups) {\n\t\tgenerate_fixups_tree(dti, \"__fixups__\");\n\t\tgenerate_local_fixups_tree(dti, \"__local_fixups__\");\n\t}\n\n\tif (sort)\n\t\tsort_tree(dti);\n\n\tif (streq(outname, \"-\")) {\n\t\toutf = stdout;\n\t} else {\n\t\toutf = fopen(outname, \"wb\");\n\t\tif (! outf)\n\t\t\tdie(\"Couldn't open output file %s: %s\\n\",\n\t\t\t    outname, strerror(errno));\n\t}\n\n\tif (streq(outform, \"dts\")) {\n\t\tdt_to_source(outf, dti);\n#ifndef NO_YAML\n\t} else if (streq(outform, \"yaml\")) {\n\t\tif (!streq(inform, \"dts\"))\n\t\t\tdie(\"YAML output format requires dts input format\\n\");\n\t\tdt_to_yaml(outf, dti);\n#endif\n\t} else if (streq(outform, \"dtb\")) {\n\t\tdt_to_blob(outf, dti, outversion);\n\t} else if (streq(outform, \"asm\")) {\n\t\tdt_to_asm(outf, dti, outversion);\n\t} else if (streq(outform, \"null\")) {\n\t\t \n\t} else {\n\t\tdie(\"Unknown output format \\\"%s\\\"\\n\", outform);\n\t}\n\n\texit(0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}