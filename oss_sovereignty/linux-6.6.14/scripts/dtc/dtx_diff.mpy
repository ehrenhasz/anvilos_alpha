{
  "module_name": "dtx_diff",
  "hash_id": "e1d2f9a02dfa0272d4c1c72dbaa853c0e6eee814a9aaae484a637a7e47b02fb7",
  "original_prompt": "Ingested from linux-6.6.14/scripts/dtc/dtx_diff",
  "human_readable_source": "#! /bin/bash\n# SPDX-License-Identifier: GPL-2.0-only\n\n# Copyright (C) 2015 Frank Rowand\n#\n\n\nusage() {\n\n\t# use spaces instead of tabs in the usage message\n\tcat >&2 <<eod\n\nUsage:\n\n   `basename $0` DTx\n        decompile DTx\n\n   `basename $0` DTx_1 DTx_2\n        diff DTx_1 and DTx_2\n\n\n      --annotate    synonym for -T\n      --color       synonym for -c (requires diff with --color support)\n       -c           enable colored output\n       -f           print full dts in diff (--unified=99999)\n       -h           synonym for --help\n       -help        synonym for --help\n      --help        print this message and exit\n       -s SRCTREE   linux kernel source tree is at path SRCTREE\n                        (default is current directory)\n       -S           linux kernel source tree is at root of current git repo\n       -T           annotate output .dts with input source file and line\n                        (-T -T for more details)\n       -u           unsorted, do not sort DTx\n\n\nEach DTx is processed by the dtc compiler to produce a sorted dts source\nfile.  If DTx is a dts source file then it is pre-processed in the same\nmanner as done for the compile of the dts source file in the Linux kernel\nbuild system ('#include' and '/include/' directives are processed).\n\nIf two DTx are provided, the resulting dts source files are diffed.\n\nIf DTx is a directory, it is treated as a DT subtree, such as\n  /proc/device-tree.\n\nIf DTx contains the binary blob magic value in the first four bytes,\n  it is treated as a binary blob (aka .dtb or FDT).\n\nOtherwise DTx is treated as a dts source file (aka .dts).\n\n   If this script is not run from the root of the linux source tree,\n   and DTx utilizes '#include' or '/include/' then the path of the\n   linux source tree can be provided by '-s SRCTREE' or '-S' so that\n   include paths will be set properly.\n\n   The shell variable \\${ARCH} must provide the architecture containing\n   the dts source file for include paths to be set properly for '#include'\n   or '/include/' to be processed.\n\n   If DTx_1 and DTx_2 are in different architectures, then this script\n   may not work since \\${ARCH} is part of the include path.  The following\n   workaround can be used:\n\n      `basename $0` ARCH=arch_of_dtx_1 DTx_1 >tmp_dtx_1.dts\n      `basename $0` ARCH=arch_of_dtx_2 DTx_2 >tmp_dtx_2.dts\n      `basename $0` tmp_dtx_1.dts tmp_dtx_2.dts\n      rm tmp_dtx_1.dts tmp_dtx_2.dts\n\n   If DTx_1 and DTx_2 are in different directories, then this script will\n   add the path of DTx_1 and DTx_2 to the include paths.  If DTx_2 includes\n   a local file that exists in both the path of DTx_1 and DTx_2 then the\n   file in the path of DTx_1 will incorrectly be included.  Possible\n   workaround:\n\n      `basename $0` DTx_1 >tmp_dtx_1.dts\n      `basename $0` DTx_2 >tmp_dtx_2.dts\n      `basename $0` tmp_dtx_1.dts tmp_dtx_2.dts\n      rm tmp_dtx_1.dts tmp_dtx_2.dts\n\neod\n}\n\n\ncompile_to_dts() {\n\n\tdtx=\"$1\"\n\tdtc_include=\"$2\"\n\n\tif [ -d \"${dtx}\" ] ; then\n\n\t\t# -----  input is file tree\n\n\t\tif ( ! ${DTC} -I fs ${dtx} ) ; then\n\t\t\texit 3\n\t\tfi\n\n\telif [ -f \"${dtx}\" ] && [ -r \"${dtx}\" ] ; then\n\n\t\tmagic=`hexdump -n 4 -e '/1 \"%02x\"' ${dtx}`\n\t\tif [ \"${magic}\" = \"d00dfeed\" ] ; then\n\n\t\t\t# -----  input is FDT (binary blob)\n\n\t\t\tif ( ! ${DTC} -I dtb ${dtx} ) ; then\n\t\t\t\texit 3\n\t\t\tfi\n\n\t\t\treturn\n\n\t\tfi\n\n\t\t# -----  input is DTS (source)\n\n\t\tif ( cpp ${cpp_flags} -x assembler-with-cpp ${dtx} \\\n\t\t\t| ${DTC} ${dtc_include} -I dts ) ; then\n\t\t\treturn\n\t\tfi\n\n\t\techo \"\"                                                      >&2\n\t\techo \"Possible hints to resolve the above error:\"            >&2\n\t\techo \"  (hints might not fix the problem)\"                   >&2\n\n\t\thint_given=0\n\n\t\tif [ \"${ARCH}\" = \"\" ] ; then\n\t\t\thint_given=1\n\t\t\techo \"\"                                              >&2\n\t\t\techo \"  shell variable \\$ARCH not set\"               >&2\n\t\tfi\n\n\t\tdtx_arch=`echo \"/${dtx}\" | sed -e 's|.*/arch/||' -e 's|/.*||'`\n\n\t\tif [ \"${dtx_arch}\" != \"\"  -a \"${dtx_arch}\" != \"${ARCH}\" ] ; then\n\t\t\thint_given=1\n\t\t\techo \"\"                                              >&2\n\t\t\techo \"  architecture ${dtx_arch} is in file path,\"   >&2\n\t\t\techo \"  but does not match shell variable \\$ARCH\"    >&2\n\t\t\techo \"  >>\\$ARCH<< is: >>${ARCH}<<\"                  >&2\n\t\tfi\n\n\t\tif [ ! -d ${srctree}/arch/${ARCH} ] ; then\n\t\t\thint_given=1\n\t\t\techo \"\"                                              >&2\n\t\t\techo \"  ${srctree}/arch/${ARCH}/ does not exist\"     >&2\n\t\t\techo \"  Is \\$ARCH='${ARCH}' correct?\"                >&2\n\t\t\techo \"  Possible fix: use '-s' option\"               >&2\n\n\t\t\tgit_root=`git rev-parse --show-toplevel 2>/dev/null`\n\t\t\tif [ -d ${git_root}/arch/ ] ; then\n\t\t\t\techo \"  Possible fix: use '-S' option\"       >&2\n\t\t\tfi\n\t\tfi\n\n\t\tif [ $hint_given = 0 ] ; then\n\t\t\techo \"\"                                              >&2\n\t\t\techo \"  No hints available.\"                         >&2\n\t\tfi\n\n\t\techo \"\"                                                      >&2\n\n\t\texit 3\n\n\telse\n\t\techo \"\"                                                     >&2\n\t\techo \"ERROR: ${dtx} does not exist or is not readable\"      >&2\n\t\techo \"\"                                                     >&2\n\t\texit 2\n\tfi\n\n}\n\n\n# -----  start of script\n\nannotate=\"\"\ncmd_diff=0\ndiff_flags=\"-u\"\ndiff_color=\"\"\ndtx_file_1=\"\"\ndtx_file_2=\"\"\ndtc_sort=\"-s\"\nhelp=0\nsrctree=\"\"\n\n\nwhile [ $# -gt 0 ] ; do\n\n\tcase $1 in\n\n\t-c | --color )\n\t\tif diff --color /dev/null /dev/null 2>/dev/null ; then\n\t\t\tdiff_color=\"--color=always\"\n\t\tfi\n\t\tshift\n\t\t;;\n\n\t-f )\n\t\tdiff_flags=\"--unified=999999\"\n\t\tshift\n\t\t;;\n\n\t-h | -help | --help )\n\t\thelp=1\n\t\tshift\n\t\t;;\n\n\t-s )\n\t\tsrctree=\"$2\"\n\t\tshift 2\n\t\t;;\n\n\t-S )\n\t\tgit_root=`git rev-parse --show-toplevel 2>/dev/null`\n\t\tsrctree=\"${git_root}\"\n\t\tshift\n\t\t;;\n\n\t-T | --annotate )\n\t\tif [ \"${annotate}\"  = \"\" ] ; then\n\t\t\tannotate=\"-T\"\n\t\telif [ \"${annotate}\"  = \"-T\" ] ; then\n\t\t\tannotate=\"-T -T\"\n\t\tfi\n\t\tshift\n\t\t;;\n\t-u )\n\t\tdtc_sort=\"\"\n\t\tshift\n\t\t;;\n\n\t*)\n\t\tif [ \"${dtx_file_1}\"  = \"\" ] ; then\n\t\t\tdtx_file_1=\"$1\"\n\t\telif [ \"${dtx_file_2}\" = \"\" ] ; then\n\t\t\tdtx_file_2=\"$1\"\n\t\telse\n\t\t\techo \"\"                                             >&2\n\t\t\techo \"ERROR: Unexpected parameter: $1\"              >&2\n\t\t\techo \"\"                                             >&2\n\t\t\texit 2\n\t\tfi\n\t\tshift\n\t\t;;\n\n\tesac\n\ndone\n\nif [ \"${srctree}\" = \"\" ] ; then\n\tsrctree=\".\"\nfi\n\nif [ \"${dtx_file_2}\" != \"\" ]; then\n\tcmd_diff=1\nfi\n\nif (( ${help} )) ; then\n\tusage\n\texit 1\nfi\n\n# this must follow check for ${help}\nif [ \"${dtx_file_1}\" = \"\" ]; then\n\techo \"\"                                                             >&2\n\techo \"ERROR: parameter DTx required\"                                >&2\n\techo \"\"                                                             >&2\n\texit 2\nfi\n\n\n# -----  prefer dtc from linux kernel, allow fallback to dtc in $PATH\n\nif [ \"${KBUILD_OUTPUT:0:2}\" = \"..\" ] ; then\n\t__KBUILD_OUTPUT=\"${srctree}/${KBUILD_OUTPUT}\"\nelif [ \"${KBUILD_OUTPUT}\" = \"\" ] ; then\n\t__KBUILD_OUTPUT=\".\"\nelse\n\t__KBUILD_OUTPUT=\"${KBUILD_OUTPUT}\"\nfi\n\nDTC=\"${__KBUILD_OUTPUT}/scripts/dtc/dtc\"\n\nif [ ! -x ${DTC} ] ; then\n\t__DTC=\"dtc\"\n\tif grep -q \"^CONFIG_DTC=y\" ${__KBUILD_OUTPUT}/.config 2>/dev/null; then\n\t\tmake_command='\n         make scripts'\n\telse\n\t\tmake_command='\n         Enable CONFIG_DTC in the kernel configuration\n         make scripts'\n\tfi\n\tif ( ! which ${__DTC} >/dev/null ) ; then\n\n\t\t# use spaces instead of tabs in the error message\n\t\tcat >&2 <<eod\n\nERROR: unable to find a 'dtc' program\n\n   Preferred 'dtc' (built from Linux kernel source tree) was not found or\n   is not executable.\n\n      'dtc' is: ${DTC}\n\n      If it does not exist, create it from the root of the Linux source tree:\n${make_command}\n\n      If not at the root of the Linux kernel source tree -s SRCTREE or -S\n      may need to be specified to find 'dtc'.\n\n      If 'O=\\${dir}' is specified in your Linux builds, this script requires\n      'export KBUILD_OUTPUT=\\${dir}' or add \\${dir}/scripts/dtc to \\$PATH\n      before running.\n\n      If \\${KBUILD_OUTPUT} is a relative path, then '-s SRCDIR', -S, or run\n      this script from the root of the Linux kernel source tree is required.\n\n   Fallback '${__DTC}' was also not in \\${PATH} or is not executable.\n\neod\n\t\texit 2\n\tfi\n\tDTC=${__DTC}\nfi\n\n\n# -----  cpp and dtc flags same as for linux source tree build of .dtb files,\n#        plus directories of the dtx file(s)\n\ndtx_path_1_dtc_include=\"-i `dirname ${dtx_file_1}`\"\n\ndtx_path_2_dtc_include=\"\"\nif (( ${cmd_diff} )) ; then\n\tdtx_path_2_dtc_include=\"-i `dirname ${dtx_file_2}`\"\nfi\n\ncpp_flags=\"\\\n\t-nostdinc                                  \\\n\t-I${srctree}/scripts/dtc/include-prefixes  \\\n\t-undef -D__DTS__\"\n\nDTC=\"\\\n\t${DTC}                                     \\\n\t-i ${srctree}/scripts/dtc/include-prefixes \\\n\t-O dts -qq -f ${dtc_sort} ${annotate} -o -\"\n\n\n# -----  do the diff or decompile\n\nif (( ${cmd_diff} )) ; then\n\n\tdiff ${diff_flags} ${diff_color} --label \"${dtx_file_1}\" --label \"${dtx_file_2}\" \\\n\t\t<(compile_to_dts \"${dtx_file_1}\" \"${dtx_path_1_dtc_include}\") \\\n\t\t<(compile_to_dts \"${dtx_file_2}\" \"${dtx_path_2_dtc_include}\")\n\nelse\n\n\tcompile_to_dts \"${dtx_file_1}\" \"${dtx_path_1_dtc_include}\"\n\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}