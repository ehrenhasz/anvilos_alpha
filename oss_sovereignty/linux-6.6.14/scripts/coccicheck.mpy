{
  "module_name": "coccicheck",
  "hash_id": "e4a8ebd8f48bea28b198b194341dbdf7d1252d768a54eef2317f80a8e07eb9b4",
  "original_prompt": "Ingested from linux-6.6.14/scripts/coccicheck",
  "human_readable_source": "#!/usr/bin/env bash\n# SPDX-License-Identifier: GPL-2.0\n# Linux kernel coccicheck\n#\n# Read Documentation/dev-tools/coccinelle.rst\n#\n# This script requires at least spatch\n# version 1.0.0-rc11.\n\nDIR=\"$(dirname $(readlink -f $0))/..\"\nSPATCH=\"`which ${SPATCH:=spatch}`\"\n\nif [ ! -x \"$SPATCH\" ]; then\n    echo 'spatch is part of the Coccinelle project and is available at http://coccinelle.lip6.fr/'\n    exit 1\nfi\n\nSPATCH_VERSION=$($SPATCH --version | head -1 | awk '{print $3}')\n\nUSE_JOBS=\"no\"\n$SPATCH --help | grep -e \"--jobs\" > /dev/null && USE_JOBS=\"yes\"\n\n# The verbosity may be set by the environmental parameter V=\n# as for example with 'make V=1 coccicheck'\n\nif [ -n \"$V\" -a \"$V\" != \"0\" ]; then\n\tVERBOSE=\"$V\"\nelse\n\tVERBOSE=0\nfi\n\nFLAGS=\"--very-quiet\"\n\n# You can use SPFLAGS to append extra arguments to coccicheck or override any\n# heuristics done in this file as Coccinelle accepts the last options when\n# options conflict.\n#\n# A good example for use of SPFLAGS is if you want to debug your cocci script,\n# you can for instance use the following:\n#\n# $ export COCCI=scripts/coccinelle/misc/irqf_oneshot.cocci\n# $ make coccicheck MODE=report DEBUG_FILE=\"all.err\" SPFLAGS=\"--profile --show-trying\" M=./drivers/mfd/arizona-irq.c\n#\n# \"--show-trying\" should show you what rule is being processed as it goes to\n# stdout, you do not need a debug file for that. The profile output will be\n# be sent to stdout, if you provide a DEBUG_FILE the profiling data can be\n# inspected there.\n#\n# --profile will not output if --very-quiet is used, so avoid it.\necho $SPFLAGS | grep -E -e \"--profile|--show-trying\" 2>&1 > /dev/null\nif [ $? -eq 0 ]; then\n\tFLAGS=\"--quiet\"\nfi\n\n# spatch only allows include directories with the syntax \"-I include\"\n# while gcc also allows \"-Iinclude\" and \"-include include\"\nCOCCIINCLUDE=${LINUXINCLUDE//-I/-I }\nCOCCIINCLUDE=${COCCIINCLUDE// -include/ --include}\n\nif [ \"$C\" = \"1\" -o \"$C\" = \"2\" ]; then\n    ONLINE=1\n\n    if [[ $# -le 0 ]]; then\n\t    echo ''\n\t    echo 'Specifying both the variable \"C\" and rule \"coccicheck\" in the make\ncommand results in a shift count error.'\n\t    echo ''\n\t    echo 'Try specifying \"scripts/coccicheck\" as a value for the CHECK variable instead.'\n\t    echo ''\n\t    echo 'Example:\tmake C=2 CHECK=scripts/coccicheck drivers/net/ethernet/ethoc.o'\n\t    echo ''\n\t    exit 1\n    fi\n\n    # Take only the last argument, which is the C file to test\n    shift $(( $# - 1 ))\n    OPTIONS=\"$COCCIINCLUDE $1\"\n\n    # No need to parallelize Coccinelle since this mode takes one input file.\n    NPROC=1\nelse\n    ONLINE=0\n    if [ \"$KBUILD_EXTMOD\" = \"\" ] ; then\n        OPTIONS=\"--dir $srctree $COCCIINCLUDE\"\n    else\n        OPTIONS=\"--dir $KBUILD_EXTMOD $COCCIINCLUDE\"\n    fi\n\n    # Use only one thread per core by default if hyperthreading is enabled\n    THREADS_PER_CORE=$(LANG=C lscpu | grep \"Thread(s) per core: \" | tr -cd \"[:digit:]\")\n    if [ -z \"$J\" ]; then\n        NPROC=$(getconf _NPROCESSORS_ONLN)\n\tif [ $THREADS_PER_CORE -gt 1 -a $NPROC -gt 4 ] ; then\n\t\tNPROC=$((NPROC/2))\n\tfi\n    else\n        NPROC=\"$J\"\n    fi\nfi\n\nif [ \"$KBUILD_EXTMOD\" != \"\" ] ; then\n    OPTIONS=\"--patch $srctree $OPTIONS\"\nfi\n\n# You can override by using SPFLAGS\nif [ \"$USE_JOBS\" = \"no\" ]; then\n\ttrap kill_running SIGTERM SIGINT\n\tdeclare -a SPATCH_PID\nelif [ \"$NPROC\" != \"1\" ]; then\n\t# Using 0 should work as well, refer to _SC_NPROCESSORS_ONLN use on\n\t# https://github.com/rdicosmo/parmap/blob/master/setcore_stubs.c\n\tOPTIONS=\"$OPTIONS --jobs $NPROC --chunksize 1\"\nfi\n\nif [ \"$MODE\" = \"\" ] ; then\n    if [ \"$ONLINE\" = \"0\" ] ; then\n\techo 'You have not explicitly specified the mode to use. Using default \"report\" mode.'\n\techo 'Available modes are the following: patch, report, context, org, chain'\n\techo 'You can specify the mode with \"make coccicheck MODE=<mode>\"'\n\techo 'Note however that some modes are not implemented by some semantic patches.'\n    fi\n    MODE=\"report\"\nfi\n\nif [ \"$MODE\" = \"chain\" ] ; then\n    if [ \"$ONLINE\" = \"0\" ] ; then\n\techo 'You have selected the \"chain\" mode.'\n\techo 'All available modes will be tried (in that order): patch, report, context, org'\n    fi\nelif [ \"$MODE\" = \"report\" -o \"$MODE\" = \"org\" ] ; then\n    FLAGS=\"--no-show-diff $FLAGS\"\nfi\n\nif [ \"$ONLINE\" = \"0\" ] ; then\n    echo ''\n    echo 'Please check for false positives in the output before submitting a patch.'\n    echo 'When using \"patch\" mode, carefully review the patch before submitting it.'\n    echo ''\nfi\n\nrun_cmd_parmap() {\n\tif [ $VERBOSE -ne 0 ] ; then\n\t\techo \"Running ($NPROC in parallel): $@\"\n\tfi\n\tif [ \"$DEBUG_FILE\" != \"/dev/null\" -a \"$DEBUG_FILE\" != \"\" ]; then\n                echo $@>>$DEBUG_FILE\n                $@ 2>>$DEBUG_FILE\n        else\n                echo $@\n                $@ 2>&1\n\tfi\n\n\terr=$?\n\tif [[ $err -ne 0 ]]; then\n\t\techo \"coccicheck failed\"\n\t\texit $err\n\tfi\n}\n\nrun_cmd_old() {\n\tlocal i\n\tif [ $VERBOSE -ne 0 ] ; then\n\t\techo \"Running ($NPROC in parallel): $@\"\n\tfi\n\tfor i in $(seq 0 $(( NPROC - 1)) ); do\n\t\teval \"$@ --max $NPROC --index $i &\"\n\t\tSPATCH_PID[$i]=$!\n\t\tif [ $VERBOSE -eq 2 ] ; then\n\t\t\techo \"${SPATCH_PID[$i]} running\"\n\t\tfi\n\tdone\n\twait\n}\n\nrun_cmd() {\n\tif [ \"$USE_JOBS\" = \"yes\" ]; then\n\t\trun_cmd_parmap $@\n\telse\n\t\trun_cmd_old $@\n\tfi\n}\n\nkill_running() {\n\tfor i in $(seq 0 $(( NPROC - 1 )) ); do\n\t\tif [ $VERBOSE -eq 2 ] ; then\n\t\t\techo \"Killing ${SPATCH_PID[$i]}\"\n\t\tfi\n\t\tkill ${SPATCH_PID[$i]} 2>/dev/null\n\tdone\n}\n\n# You can override heuristics with SPFLAGS, these must always go last\nOPTIONS=\"$OPTIONS $SPFLAGS\"\n\ncoccinelle () {\n    COCCI=\"$1\"\n\n    OPT=`grep \"Options:\" $COCCI | cut -d':' -f2`\n    REQ=`grep \"Requires:\" $COCCI | cut -d':' -f2 | sed \"s| ||\"`\n    if [ -n \"$REQ\" ] && ! { echo \"$REQ\"; echo \"$SPATCH_VERSION\"; } | sort -CV ; then\n\t    echo \"Skipping coccinelle SmPL patch: $COCCI\"\n\t    echo \"You have coccinelle:           $SPATCH_VERSION\"\n\t    echo \"This SmPL patch requires:      $REQ\"\n\t    return\n    fi\n\n#   The option '--parse-cocci' can be used to syntactically check the SmPL files.\n#\n#    $SPATCH -D $MODE $FLAGS -parse_cocci $COCCI $OPT > /dev/null\n\n    if [ $VERBOSE -ne 0 -a $ONLINE -eq 0 ] ; then\n\n\tFILE=${COCCI#$srctree/}\n\n\techo \"Processing `basename $COCCI`\"\n\techo \"with option(s) \\\"$OPT\\\"\"\n\techo ''\n\techo 'Message example to submit a patch:'\n\n\tsed -ne 's|^///||p' $COCCI\n\n\tif [ \"$MODE\" = \"patch\" ] ; then\n\t    echo ' The semantic patch that makes this change is available'\n\telif [ \"$MODE\" = \"report\" ] ; then\n\t    echo ' The semantic patch that makes this report is available'\n\telif [ \"$MODE\" = \"context\" ] ; then\n\t    echo ' The semantic patch that spots this code is available'\n\telif [ \"$MODE\" = \"org\" ] ; then\n\t    echo ' The semantic patch that makes this Org report is available'\n\telse\n\t    echo ' The semantic patch that makes this output is available'\n\tfi\n\techo \" in $FILE.\"\n\techo ''\n\techo ' More information about semantic patching is available at'\n\techo ' http://coccinelle.lip6.fr/'\n\techo ''\n\n\tif [ \"`sed -ne 's|^//#||p' $COCCI`\" ] ; then\n\t    echo 'Semantic patch information:'\n\t    sed -ne 's|^//#||p' $COCCI\n\t    echo ''\n\tfi\n    fi\n\n    if [ \"$MODE\" = \"chain\" ] ; then\n\trun_cmd $SPATCH -D patch   \\\n\t\t$FLAGS --cocci-file $COCCI $OPT $OPTIONS               || \\\n\trun_cmd $SPATCH -D report  \\\n\t\t$FLAGS --cocci-file $COCCI $OPT $OPTIONS --no-show-diff || \\\n\trun_cmd $SPATCH -D context \\\n\t\t$FLAGS --cocci-file $COCCI $OPT $OPTIONS               || \\\n\trun_cmd $SPATCH -D org     \\\n\t\t$FLAGS --cocci-file $COCCI $OPT $OPTIONS --no-show-diff || exit 1\n    elif [ \"$MODE\" = \"rep+ctxt\" ] ; then\n\trun_cmd $SPATCH -D report  \\\n\t\t$FLAGS --cocci-file $COCCI $OPT $OPTIONS --no-show-diff && \\\n\trun_cmd $SPATCH -D context \\\n\t\t$FLAGS --cocci-file $COCCI $OPT $OPTIONS || exit 1\n    else\n\trun_cmd $SPATCH -D $MODE   $FLAGS --cocci-file $COCCI $OPT $OPTIONS || exit 1\n    fi\n\n}\n\nif [ \"$DEBUG_FILE\" != \"/dev/null\" -a \"$DEBUG_FILE\" != \"\" ]; then\n\tif [ -f $DEBUG_FILE ]; then\n\t\techo \"Debug file $DEBUG_FILE exists, bailing\"\n\t\texit\n\tfi\nelse\n\tDEBUG_FILE=\"/dev/null\"\nfi\n\nif [ \"$COCCI\" = \"\" ] ; then\n    for f in `find $srctree/scripts/coccinelle/ -name '*.cocci' -type f | sort`; do\n\tcoccinelle $f\n    done\nelse\n    coccinelle $COCCI\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}