{
  "module_name": "sphinx-pre-install",
  "hash_id": "9fb685cf7aadea594d1b8846ce6c74966ca905689fff511ba29cfb779a910d20",
  "original_prompt": "Ingested from linux-6.6.14/scripts/sphinx-pre-install",
  "human_readable_source": "#!/usr/bin/env perl\n# SPDX-License-Identifier: GPL-2.0-or-later\nuse strict;\n\n# Copyright (c) 2017-2020 Mauro Carvalho Chehab <mchehab@kernel.org>\n#\n\nmy $prefix = \"./\";\n$prefix = \"$ENV{'srctree'}/\" if ($ENV{'srctree'});\n\nmy $conf = $prefix . \"Documentation/conf.py\";\nmy $requirement_file = $prefix . \"Documentation/sphinx/requirements.txt\";\nmy $virtenv_prefix = \"sphinx_\";\n\n#\n# Static vars\n#\n\nmy %missing;\nmy $system_release;\nmy $need = 0;\nmy $optional = 0;\nmy $need_symlink = 0;\nmy $need_sphinx = 0;\nmy $need_pip = 0;\nmy $need_virtualenv = 0;\nmy $rec_sphinx_upgrade = 0;\nmy $verbose_warn_install = 1;\nmy $install = \"\";\nmy $virtenv_dir = \"\";\nmy $python_cmd = \"\";\nmy $activate_cmd;\nmy $min_version;\nmy $cur_version;\nmy $rec_version = \"1.7.9\";\t# PDF won't build here\nmy $min_pdf_version = \"2.4.4\";\t# Min version where pdf builds\nmy $latest_avail_ver;\n\n#\n# Command line arguments\n#\n\nmy $pdf = 1;\nmy $virtualenv = 1;\nmy $version_check = 0;\n\n#\n# List of required texlive packages on Fedora and OpenSuse\n#\n\nmy %texlive = (\n\t'amsfonts.sty'       => 'texlive-amsfonts',\n\t'amsmath.sty'        => 'texlive-amsmath',\n\t'amssymb.sty'        => 'texlive-amsfonts',\n\t'amsthm.sty'         => 'texlive-amscls',\n\t'anyfontsize.sty'    => 'texlive-anyfontsize',\n\t'atbegshi.sty'       => 'texlive-oberdiek',\n\t'bm.sty'             => 'texlive-tools',\n\t'capt-of.sty'        => 'texlive-capt-of',\n\t'cmap.sty'           => 'texlive-cmap',\n\t'ecrm1000.tfm'       => 'texlive-ec',\n\t'eqparbox.sty'       => 'texlive-eqparbox',\n\t'eu1enc.def'         => 'texlive-euenc',\n\t'fancybox.sty'       => 'texlive-fancybox',\n\t'fancyvrb.sty'       => 'texlive-fancyvrb',\n\t'float.sty'          => 'texlive-float',\n\t'fncychap.sty'       => 'texlive-fncychap',\n\t'footnote.sty'       => 'texlive-mdwtools',\n\t'framed.sty'         => 'texlive-framed',\n\t'luatex85.sty'       => 'texlive-luatex85',\n\t'multirow.sty'       => 'texlive-multirow',\n\t'needspace.sty'      => 'texlive-needspace',\n\t'palatino.sty'       => 'texlive-psnfss',\n\t'parskip.sty'        => 'texlive-parskip',\n\t'polyglossia.sty'    => 'texlive-polyglossia',\n\t'tabulary.sty'       => 'texlive-tabulary',\n\t'threeparttable.sty' => 'texlive-threeparttable',\n\t'titlesec.sty'       => 'texlive-titlesec',\n\t'ucs.sty'            => 'texlive-ucs',\n\t'upquote.sty'        => 'texlive-upquote',\n\t'wrapfig.sty'        => 'texlive-wrapfig',\n\t'ctexhook.sty'       => 'texlive-ctex',\n);\n\n#\n# Subroutines that checks if a feature exists\n#\n\nsub check_missing(%)\n{\n\tmy %map = %{$_[0]};\n\n\tforeach my $prog (sort keys %missing) {\n\t\tmy $is_optional = $missing{$prog};\n\n\t\t# At least on some LTS distros like CentOS 7, texlive doesn't\n\t\t# provide all packages we need. When such distros are\n\t\t# detected, we have to disable PDF output.\n\t\t#\n\t\t# So, we need to ignore the packages that distros would\n\t\t# need for LaTeX to work\n\t\tif ($is_optional == 2 && !$pdf) {\n\t\t\t$optional--;\n\t\t\tnext;\n\t\t}\n\n\t\tif ($verbose_warn_install) {\n\t\t\tif ($is_optional) {\n\t\t\t\tprint \"Warning: better to also install \\\"$prog\\\".\\n\";\n\t\t\t} else {\n\t\t\t\tprint \"ERROR: please install \\\"$prog\\\", otherwise, build won't work.\\n\";\n\t\t\t}\n\t\t}\n\t\tif (defined($map{$prog})) {\n\t\t\t$install .= \" \" . $map{$prog};\n\t\t} else {\n\t\t\t$install .= \" \" . $prog;\n\t\t}\n\t}\n\n\t$install =~ s/^\\s//;\n}\n\nsub add_package($$)\n{\n\tmy $package = shift;\n\tmy $is_optional = shift;\n\n\t$missing{$package} = $is_optional;\n\tif ($is_optional) {\n\t\t$optional++;\n\t} else {\n\t\t$need++;\n\t}\n}\n\nsub check_missing_file($$$)\n{\n\tmy $files = shift;\n\tmy $package = shift;\n\tmy $is_optional = shift;\n\n\tfor (@$files) {\n\t\treturn if(-e $_);\n\t}\n\n\tadd_package($package, $is_optional);\n}\n\nsub findprog($)\n{\n\tforeach(split(/:/, $ENV{PATH})) {\n\t\treturn \"$_/$_[0]\" if(-x \"$_/$_[0]\");\n\t}\n}\n\nsub find_python_no_venv()\n{\n\tmy $prog = shift;\n\n\tmy $cur_dir = qx(pwd);\n\t$cur_dir =~ s/\\s+$//;\n\n\tforeach my $dir (split(/:/, $ENV{PATH})) {\n\t\tnext if ($dir =~ m,($cur_dir)/sphinx,);\n\t\treturn \"$dir/python3\" if(-x \"$dir/python3\");\n\t}\n\tforeach my $dir (split(/:/, $ENV{PATH})) {\n\t\tnext if ($dir =~ m,($cur_dir)/sphinx,);\n\t\treturn \"$dir/python\" if(-x \"$dir/python\");\n\t}\n\treturn \"python\";\n}\n\nsub check_program($$)\n{\n\tmy $prog = shift;\n\tmy $is_optional = shift;\n\n\treturn $prog if findprog($prog);\n\n\tadd_package($prog, $is_optional);\n}\n\nsub check_perl_module($$)\n{\n\tmy $prog = shift;\n\tmy $is_optional = shift;\n\n\tmy $err = system(\"perl -M$prog -e 1 2>/dev/null /dev/null\");\n\treturn if ($err == 0);\n\n\tadd_package($prog, $is_optional);\n}\n\nsub check_python_module($$)\n{\n\tmy $prog = shift;\n\tmy $is_optional = shift;\n\n\treturn if (!$python_cmd);\n\n\tmy $err = system(\"$python_cmd -c 'import $prog' 2>/dev/null /dev/null\");\n\treturn if ($err == 0);\n\n\tadd_package($prog, $is_optional);\n}\n\nsub check_rpm_missing($$)\n{\n\tmy @pkgs = @{$_[0]};\n\tmy $is_optional = $_[1];\n\n\tforeach my $prog(@pkgs) {\n\t\tmy $err = system(\"rpm -q '$prog' 2>/dev/null >/dev/null\");\n\t\tadd_package($prog, $is_optional) if ($err);\n\t}\n}\n\nsub check_pacman_missing($$)\n{\n\tmy @pkgs = @{$_[0]};\n\tmy $is_optional = $_[1];\n\n\tforeach my $prog(@pkgs) {\n\t\tmy $err = system(\"pacman -Q '$prog' 2>/dev/null >/dev/null\");\n\t\tadd_package($prog, $is_optional) if ($err);\n\t}\n}\n\nsub check_missing_tex($)\n{\n\tmy $is_optional = shift;\n\tmy $kpsewhich = findprog(\"kpsewhich\");\n\n\tforeach my $prog(keys %texlive) {\n\t\tmy $package = $texlive{$prog};\n\t\tif (!$kpsewhich) {\n\t\t\tadd_package($package, $is_optional);\n\t\t\tnext;\n\t\t}\n\t\tmy $file = qx($kpsewhich $prog);\n\t\tadd_package($package, $is_optional) if ($file =~ /^\\s*$/);\n\t}\n}\n\nsub get_sphinx_fname()\n{\n\tmy $fname = \"sphinx-build\";\n\treturn $fname if findprog($fname);\n\n\t$fname = \"sphinx-build-3\";\n\tif (findprog($fname)) {\n\t\t$need_symlink = 1;\n\t\treturn $fname;\n\t}\n\n\treturn \"\";\n}\n\nsub get_sphinx_version($)\n{\n\tmy $cmd = shift;\n\tmy $ver;\n\n\topen IN, \"$cmd --version 2>&1 |\";\n\twhile (<IN>) {\n\t\tif (m/^\\s*sphinx-build\\s+([\\d\\.]+)((\\+\\/[\\da-f]+)|(b\\d+))?$/) {\n\t\t\t$ver=$1;\n\t\t\tlast;\n\t\t}\n\t\t# Sphinx 1.2.x uses a different format\n\t\tif (m/^\\s*Sphinx.*\\s+([\\d\\.]+)$/) {\n\t\t\t$ver=$1;\n\t\t\tlast;\n\t\t}\n\t}\n\tclose IN;\n\treturn $ver;\n}\n\nsub check_sphinx()\n{\n\tmy $default_version;\n\n\topen IN, $conf or die \"Can't open $conf\";\n\twhile (<IN>) {\n\t\tif (m/^\\s*needs_sphinx\\s*=\\s*[\\'\\\"]([\\d\\.]+)[\\'\\\"]/) {\n\t\t\t$min_version=$1;\n\t\t\tlast;\n\t\t}\n\t}\n\tclose IN;\n\n\tdie \"Can't get needs_sphinx version from $conf\" if (!$min_version);\n\n\topen IN, $requirement_file or die \"Can't open $requirement_file\";\n\twhile (<IN>) {\n\t\tif (m/^\\s*Sphinx\\s*==\\s*([\\d\\.]+)$/) {\n\t\t\t$default_version=$1;\n\t\t\tlast;\n\t\t}\n\t}\n\tclose IN;\n\n\tdie \"Can't get default sphinx version from $requirement_file\" if (!$default_version);\n\n\t$virtenv_dir = $virtenv_prefix . $default_version;\n\n\tmy $sphinx = get_sphinx_fname();\n\tif ($sphinx eq \"\") {\n\t\t$need_sphinx = 1;\n\t\treturn;\n\t}\n\n\t$cur_version = get_sphinx_version($sphinx);\n\tdie (\"$sphinx returned an error\") if (!$cur_version);\n\n\tdie \"$sphinx didn't return its version\" if (!$cur_version);\n\n\tif ($cur_version lt $min_version) {\n\t\tprintf \"ERROR: Sphinx version is %s. It should be >= %s (recommended >= %s)\\n\",\n\t\t       $cur_version, $min_version, $default_version;\n\t\t$need_sphinx = 1;\n\t\treturn;\n\t}\n\n\treturn if ($cur_version lt $rec_version);\n\n\t# On version check mode, just assume Sphinx has all mandatory deps\n\texit (0) if ($version_check);\n}\n\n#\n# Ancillary subroutines\n#\n\nsub catcheck($)\n{\n  my $res = \"\";\n  $res = qx(cat $_[0]) if (-r $_[0]);\n  return $res;\n}\n\nsub which($)\n{\n\tmy $file = shift;\n\tmy @path = split \":\", $ENV{PATH};\n\n\tforeach my $dir(@path) {\n\t\tmy $name = $dir.'/'.$file;\n\t\treturn $name if (-x $name );\n\t}\n\treturn undef;\n}\n\n#\n# Subroutines that check distro-specific hints\n#\n\nsub give_debian_hints()\n{\n\tmy %map = (\n\t\t\"python-sphinx\"\t\t=> \"python3-sphinx\",\n\t\t\"ensurepip\"\t\t=> \"python3-venv\",\n\t\t\"virtualenv\"\t\t=> \"virtualenv\",\n\t\t\"dot\"\t\t\t=> \"graphviz\",\n\t\t\"convert\"\t\t=> \"imagemagick\",\n\t\t\"Pod::Usage\"\t\t=> \"perl-modules\",\n\t\t\"xelatex\"\t\t=> \"texlive-xetex\",\n\t\t\"rsvg-convert\"\t\t=> \"librsvg2-bin\",\n\t);\n\n\tif ($pdf) {\n\t\tcheck_missing_file([\"/usr/share/texlive/texmf-dist/tex/latex/ctex/ctexhook.sty\"],\n\t\t\t\t   \"texlive-lang-chinese\", 2);\n\n\t\tcheck_missing_file([\"/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf\"],\n\t\t\t\t   \"fonts-dejavu\", 2);\n\n\t\tcheck_missing_file([\"/usr/share/fonts/noto-cjk/NotoSansCJK-Regular.ttc\",\n\t\t\t\t    \"/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc\",\n\t\t\t\t    \"/usr/share/fonts/opentype/noto/NotoSerifCJK-Regular.ttc\"],\n\t\t\t\t   \"fonts-noto-cjk\", 2);\n\t}\n\n\tcheck_program(\"dvipng\", 2) if ($pdf);\n\tcheck_missing(\\%map);\n\n\treturn if (!$need && !$optional);\n\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\tprintf(\"\\n\\tsudo apt-get install $install\\n\");\n}\n\nsub give_redhat_hints()\n{\n\tmy %map = (\n\t\t\"python-sphinx\"\t\t=> \"python3-sphinx\",\n\t\t\"virtualenv\"\t\t=> \"python3-virtualenv\",\n\t\t\"dot\"\t\t\t=> \"graphviz\",\n\t\t\"convert\"\t\t=> \"ImageMagick\",\n\t\t\"Pod::Usage\"\t\t=> \"perl-Pod-Usage\",\n\t\t\"xelatex\"\t\t=> \"texlive-xetex-bin\",\n\t\t\"rsvg-convert\"\t\t=> \"librsvg2-tools\",\n\t);\n\n\tmy @fedora26_opt_pkgs = (\n\t\t\"graphviz-gd\",\t\t# Fedora 26: needed for PDF support\n\t);\n\n\tmy @fedora_tex_pkgs = (\n\t\t\"texlive-collection-fontsrecommended\",\n\t\t\"texlive-collection-latex\",\n\t\t\"texlive-xecjk\",\n\t\t\"dejavu-sans-fonts\",\n\t\t\"dejavu-serif-fonts\",\n\t\t\"dejavu-sans-mono-fonts\",\n\t);\n\n\t#\n\t# Checks valid for RHEL/CentOS version 7.x.\n\t#\n\tmy $old = 0;\n\tmy $rel;\n\t$rel = $1 if ($system_release =~ /release\\s+(\\d+)/);\n\n\tif (!($system_release =~ /Fedora/)) {\n\t\t$map{\"virtualenv\"} = \"python-virtualenv\";\n\n\t\tif ($rel && $rel < 8) {\n\t\t\t$old = 1;\n\t\t\t$pdf = 0;\n\n\t\t\tprintf(\"Note: texlive packages on RHEL/CENTOS <= 7 are incomplete. Can't support PDF output\\n\");\n\t\t\tprintf(\"If you want to build PDF, please read:\\n\");\n\t\t\tprintf(\"\\thttps://www.systutorials.com/241660/how-to-install-tex-live-on-centos-7-linux/\\n\");\n\t\t}\n\t} else {\n\t\tif ($rel && $rel < 26) {\n\t\t\t$old = 1;\n\t\t}\n\t}\n\tif (!$rel) {\n\t\tprintf(\"Couldn't identify release number\\n\");\n\t\t$old = 1;\n\t\t$pdf = 0;\n\t}\n\n\tif ($pdf) {\n\t\tcheck_missing_file([\"/usr/share/fonts/google-noto-cjk/NotoSansCJK-Regular.ttc\"],\n\t\t\t\t   \"google-noto-sans-cjk-ttc-fonts\", 2);\n\t}\n\n\tcheck_rpm_missing(\\@fedora26_opt_pkgs, 2) if ($pdf && !$old);\n\tcheck_rpm_missing(\\@fedora_tex_pkgs, 2) if ($pdf);\n\tcheck_missing_tex(2) if ($pdf);\n\tcheck_missing(\\%map);\n\n\treturn if (!$need && !$optional);\n\n\tif (!$old) {\n\t\t# dnf, for Fedora 18+\n\t\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\t\tprintf(\"\\n\\tsudo dnf install -y $install\\n\");\n\t} else {\n\t\t# yum, for RHEL (and clones) or Fedora version < 18\n\t\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\t\tprintf(\"\\n\\tsudo yum install -y $install\\n\");\n\t}\n}\n\nsub give_opensuse_hints()\n{\n\tmy %map = (\n\t\t\"python-sphinx\"\t\t=> \"python3-sphinx\",\n\t\t\"virtualenv\"\t\t=> \"python3-virtualenv\",\n\t\t\"dot\"\t\t\t=> \"graphviz\",\n\t\t\"convert\"\t\t=> \"ImageMagick\",\n\t\t\"Pod::Usage\"\t\t=> \"perl-Pod-Usage\",\n\t\t\"xelatex\"\t\t=> \"texlive-xetex-bin\",\n\t);\n\n\t# On Tumbleweed, this package is also named rsvg-convert\n\t$map{\"rsvg-convert\"} = \"rsvg-view\" if (!($system_release =~ /Tumbleweed/));\n\n\tmy @suse_tex_pkgs = (\n\t\t\"texlive-babel-english\",\n\t\t\"texlive-caption\",\n\t\t\"texlive-colortbl\",\n\t\t\"texlive-courier\",\n\t\t\"texlive-dvips\",\n\t\t\"texlive-helvetic\",\n\t\t\"texlive-makeindex\",\n\t\t\"texlive-metafont\",\n\t\t\"texlive-metapost\",\n\t\t\"texlive-palatino\",\n\t\t\"texlive-preview\",\n\t\t\"texlive-times\",\n\t\t\"texlive-zapfchan\",\n\t\t\"texlive-zapfding\",\n\t);\n\n\t$map{\"latexmk\"} = \"texlive-latexmk-bin\";\n\n\t# FIXME: add support for installing CJK fonts\n\t#\n\t# I tried hard, but was unable to find a way to install\n\t# \"Noto Sans CJK SC\" on openSUSE\n\n\tcheck_rpm_missing(\\@suse_tex_pkgs, 2) if ($pdf);\n\tcheck_missing_tex(2) if ($pdf);\n\tcheck_missing(\\%map);\n\n\treturn if (!$need && !$optional);\n\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\tprintf(\"\\n\\tsudo zypper install --no-recommends $install\\n\");\n}\n\nsub give_mageia_hints()\n{\n\tmy %map = (\n\t\t\"python-sphinx\"\t\t=> \"python3-sphinx\",\n\t\t\"virtualenv\"\t\t=> \"python3-virtualenv\",\n\t\t\"dot\"\t\t\t=> \"graphviz\",\n\t\t\"convert\"\t\t=> \"ImageMagick\",\n\t\t\"Pod::Usage\"\t\t=> \"perl-Pod-Usage\",\n\t\t\"xelatex\"\t\t=> \"texlive\",\n\t\t\"rsvg-convert\"\t\t=> \"librsvg2\",\n\t);\n\n\tmy @tex_pkgs = (\n\t\t\"texlive-fontsextra\",\n\t);\n\n\t$map{\"latexmk\"} = \"texlive-collection-basic\";\n\n\tmy $packager_cmd;\n\tmy $noto_sans;\n\tif ($system_release =~ /OpenMandriva/) {\n\t\t$packager_cmd = \"dnf install\";\n\t\t$noto_sans = \"noto-sans-cjk-fonts\";\n\t\t@tex_pkgs = ( \"texlive-collection-fontsextra\" );\n\t} else {\n\t\t$packager_cmd = \"urpmi\";\n\t\t$noto_sans = \"google-noto-sans-cjk-ttc-fonts\";\n\t}\n\n\n\tif ($pdf) {\n\t\tcheck_missing_file([\"/usr/share/fonts/google-noto-cjk/NotoSansCJK-Regular.ttc\",\n\t\t\t\t    \"/usr/share/fonts/TTF/NotoSans-Regular.ttf\"],\n\t\t\t\t   $noto_sans, 2);\n\t}\n\n\tcheck_rpm_missing(\\@tex_pkgs, 2) if ($pdf);\n\tcheck_missing(\\%map);\n\n\treturn if (!$need && !$optional);\n\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\tprintf(\"\\n\\tsudo $packager_cmd $install\\n\");\n}\n\nsub give_arch_linux_hints()\n{\n\tmy %map = (\n\t\t\"virtualenv\"\t\t=> \"python-virtualenv\",\n\t\t\"dot\"\t\t\t=> \"graphviz\",\n\t\t\"convert\"\t\t=> \"imagemagick\",\n\t\t\"xelatex\"\t\t=> \"texlive-bin\",\n\t\t\"latexmk\"\t\t=> \"texlive-core\",\n\t\t\"rsvg-convert\"\t\t=> \"extra/librsvg\",\n\t);\n\n\tmy @archlinux_tex_pkgs = (\n\t\t\"texlive-core\",\n\t\t\"texlive-latexextra\",\n\t\t\"ttf-dejavu\",\n\t);\n\tcheck_pacman_missing(\\@archlinux_tex_pkgs, 2) if ($pdf);\n\n\tif ($pdf) {\n\t\tcheck_missing_file([\"/usr/share/fonts/noto-cjk/NotoSansCJK-Regular.ttc\"],\n\t\t\t\t   \"noto-fonts-cjk\", 2);\n\t}\n\n\tcheck_missing(\\%map);\n\n\treturn if (!$need && !$optional);\n\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\tprintf(\"\\n\\tsudo pacman -S $install\\n\");\n}\n\nsub give_gentoo_hints()\n{\n\tmy %map = (\n\t\t\"virtualenv\"\t\t=> \"dev-python/virtualenv\",\n\t\t\"dot\"\t\t\t=> \"media-gfx/graphviz\",\n\t\t\"convert\"\t\t=> \"media-gfx/imagemagick\",\n\t\t\"xelatex\"\t\t=> \"dev-texlive/texlive-xetex media-fonts/dejavu\",\n\t\t\"rsvg-convert\"\t\t=> \"gnome-base/librsvg\",\n\t);\n\n\tcheck_missing_file([\"/usr/share/fonts/dejavu/DejaVuSans.ttf\"],\n\t\t\t   \"media-fonts/dejavu\", 2) if ($pdf);\n\n\tif ($pdf) {\n\t\tcheck_missing_file([\"/usr/share/fonts/noto-cjk/NotoSansCJKsc-Regular.otf\",\n\t\t\t\t    \"/usr/share/fonts/noto-cjk/NotoSerifCJK-Regular.ttc\"],\n\t\t\t\t   \"media-fonts/noto-cjk\", 2);\n\t}\n\n\tcheck_missing(\\%map);\n\n\treturn if (!$need && !$optional);\n\n\tprintf(\"You should run:\\n\") if ($verbose_warn_install);\n\tprintf(\"\\n\");\n\n\tmy $imagemagick = \"media-gfx/imagemagick svg png\";\n\tmy $cairo = \"media-gfx/graphviz cairo pdf\";\n\tmy $portage_imagemagick = \"/etc/portage/package.use/imagemagick\";\n\tmy $portage_cairo = \"/etc/portage/package.use/graphviz\";\n\n\tif (qx(grep imagemagick $portage_imagemagick 2>/dev/null) eq \"\") {\n\t\tprintf(\"\\tsudo su -c 'echo \\\"$imagemagick\\\" > $portage_imagemagick'\\n\")\n\t}\n\tif (qx(grep graphviz $portage_cairo 2>/dev/null) eq  \"\") {\n\t\tprintf(\"\\tsudo su -c 'echo \\\"$cairo\\\" > $portage_cairo'\\n\");\n\t}\n\n\tprintf(\"\\tsudo emerge --ask $install\\n\");\n\n}\n\nsub check_distros()\n{\n\t# Distro-specific hints\n\tif ($system_release =~ /Red Hat Enterprise Linux/) {\n\t\tgive_redhat_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /CentOS/) {\n\t\tgive_redhat_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Scientific Linux/) {\n\t\tgive_redhat_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Oracle Linux Server/) {\n\t\tgive_redhat_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Fedora/) {\n\t\tgive_redhat_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Ubuntu/) {\n\t\tgive_debian_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Debian/) {\n\t\tgive_debian_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /openSUSE/) {\n\t\tgive_opensuse_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Mageia/) {\n\t\tgive_mageia_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /OpenMandriva/) {\n\t\tgive_mageia_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Arch Linux/) {\n\t\tgive_arch_linux_hints;\n\t\treturn;\n\t}\n\tif ($system_release =~ /Gentoo/) {\n\t\tgive_gentoo_hints;\n\t\treturn;\n\t}\n\n\t#\n\t# Fall-back to generic hint code for other distros\n\t# That's far from ideal, specially for LaTeX dependencies.\n\t#\n\tmy %map = (\n\t\t\"sphinx-build\" => \"sphinx\"\n\t);\n\tcheck_missing_tex(2) if ($pdf);\n\tcheck_missing(\\%map);\n\tprint \"I don't know distro $system_release.\\n\";\n\tprint \"So, I can't provide you a hint with the install procedure.\\n\";\n\tprint \"There are likely missing dependencies.\\n\";\n}\n\n#\n# Common dependencies\n#\n\nsub deactivate_help()\n{\n\tprintf \"\\n    If you want to exit the virtualenv, you can use:\\n\";\n\tprintf \"\\tdeactivate\\n\";\n}\n\nsub get_virtenv()\n{\n\tmy $ver;\n\tmy $min_activate = \"$ENV{'PWD'}/${virtenv_prefix}${min_version}/bin/activate\";\n\tmy @activates = glob \"$ENV{'PWD'}/${virtenv_prefix}*/bin/activate\";\n\n\t@activates = sort {$b cmp $a} @activates;\n\n\tforeach my $f (@activates) {\n\t\tnext if ($f lt $min_activate);\n\n\t\tmy $sphinx_cmd = $f;\n\t\t$sphinx_cmd =~ s/activate/sphinx-build/;\n\t\tnext if (! -f $sphinx_cmd);\n\n\t\tmy $ver = get_sphinx_version($sphinx_cmd);\n\n\t\tif (!$ver) {\n\t\t\t$f =~ s#/bin/activate##;\n\t\t\tprint(\"Warning: virtual environment $f is not working.\\nPython version upgrade? Remove it with:\\n\\n\\trm -rf $f\\n\\n\");\n\t\t}\n\n\t\tif ($need_sphinx && ($ver ge $min_version)) {\n\t\t\treturn ($f, $ver);\n\t\t} elsif ($ver gt $cur_version) {\n\t\t\treturn ($f, $ver);\n\t\t}\n\t}\n\treturn (\"\", \"\");\n}\n\nsub recommend_sphinx_upgrade()\n{\n\tmy $venv_ver;\n\n\t# Avoid running sphinx-builds from venv if $cur_version is good\n\tif ($cur_version && ($cur_version ge $rec_version)) {\n\t\t$latest_avail_ver = $cur_version;\n\t\treturn;\n\t}\n\n\t# Get the highest version from sphinx_*/bin/sphinx-build and the\n\t# corresponding command to activate the venv/virtenv\n\t($activate_cmd, $venv_ver) = get_virtenv();\n\n\t# Store the highest version from Sphinx existing virtualenvs\n\tif (($activate_cmd ne \"\") && ($venv_ver gt $cur_version)) {\n\t\t$latest_avail_ver = $venv_ver;\n\t} else {\n\t\t$latest_avail_ver = $cur_version if ($cur_version);\n\t}\n\n\t# As we don't know package version of Sphinx, and there's no\n\t# virtual environments, don't check if upgrades are needed\n\tif (!$virtualenv) {\n\t\treturn if (!$latest_avail_ver);\n\t}\n\n\t# Either there are already a virtual env or a new one should be created\n\t$need_pip = 1;\n\n\treturn if (!$latest_avail_ver);\n\n\t# Return if the reason is due to an upgrade or not\n\tif ($latest_avail_ver lt $rec_version) {\n\t\t$rec_sphinx_upgrade = 1;\n\t}\n\n\treturn $latest_avail_ver;\n}\n\n#\n# The logic here is complex, as it have to deal with different versions:\n#\t- minimal supported version;\n#\t- minimal PDF version;\n#\t- recommended version.\n# It also needs to work fine with both distro's package and venv/virtualenv\nsub recommend_sphinx_version($)\n{\n\tmy $virtualenv_cmd = shift;\n\n\t# Version is OK. Nothing to do.\n\tif ($cur_version && ($cur_version ge $rec_version)) {\n\t\tif ($cur_version lt $min_pdf_version) {\n\t\t\tprint \"note: If you want pdf, you need at least Sphinx $min_pdf_version.\\n\";\n\t\t}\n\t\treturn;\n\t};\n\n\tif (!$need_sphinx) {\n\t\t# sphinx-build is present and its version is >= $min_version\n\n\t\t#only recommend enabling a newer virtenv version if makes sense.\n\t\tif ($latest_avail_ver gt $cur_version) {\n\t\t\tprintf \"\\nYou may also use the newer Sphinx version $latest_avail_ver with:\\n\";\n\t\t\tprintf \"\\tdeactivate\\n\"  if ($ENV{'PWD'} =~ /${virtenv_prefix}/);\n\t\t\tprintf \"\\t. $activate_cmd\\n\";\n\t\t\tdeactivate_help();\n\n\t\t\treturn;\n\t\t}\n\t\treturn if ($latest_avail_ver ge $rec_version);\n\t}\n\n\tif (!$virtualenv) {\n\t\t# No sphinx either via package or via virtenv. As we can't\n\t\t# Compare the versions here, just return, recommending the\n\t\t# user to install it from the package distro.\n\t\treturn if (!$latest_avail_ver);\n\n\t\t# User doesn't want a virtenv recommendation, but he already\n\t\t# installed one via virtenv with a newer version.\n\t\t# So, print commands to enable it\n\t\tif ($latest_avail_ver gt $cur_version) {\n\t\t\tprintf \"\\nYou may also use the Sphinx virtualenv version $latest_avail_ver with:\\n\";\n\t\t\tprintf \"\\tdeactivate\\n\"  if ($ENV{'PWD'} =~ /${virtenv_prefix}/);\n\t\t\tprintf \"\\t. $activate_cmd\\n\";\n\t\t\tdeactivate_help();\n\n\t\t\treturn;\n\t\t}\n\t\tprint \"\\n\";\n\t} else {\n\t\t$need++ if ($need_sphinx);\n\t}\n\n\t# Suggest newer versions if current ones are too old\n\tif ($latest_avail_ver && $latest_avail_ver ge $min_version) {\n\t\t# If there's a good enough version, ask the user to enable it\n\t\tif ($latest_avail_ver ge $rec_version) {\n\t\t\tprintf \"\\nNeed to activate Sphinx (version $latest_avail_ver) on virtualenv with:\\n\";\n\t\t\tprintf \"\\t. $activate_cmd\\n\";\n\t\t\tdeactivate_help();\n\n\t\t\tif ($latest_avail_ver lt $min_pdf_version) {\n\t\t\t\tprint \"note: If you want pdf, you need at least Sphinx $min_pdf_version.\\n\";\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\t# Version is above the minimal required one, but may be\n\t\t# below the recommended one. So, print warnings/notes\n\n\t\tif ($latest_avail_ver lt $rec_version) {\n\t\t\tprint \"Warning: It is recommended at least Sphinx version $rec_version.\\n\";\n\t\t}\n\t}\n\n\t# At this point, either it needs Sphinx or upgrade is recommended,\n\t# both via pip\n\n\tif ($rec_sphinx_upgrade) {\n\t\tif (!$virtualenv) {\n\t\t\tprint \"Instead of install/upgrade Python Sphinx pkg, you could use pip/pypi with:\\n\\n\";\n\t\t} else {\n\t\t\tprint \"To upgrade Sphinx, use:\\n\\n\";\n\t\t}\n\t} else {\n\t\tprint \"\\nSphinx needs to be installed either:\\n1) via pip/pypi with:\\n\\n\";\n\t}\n\n\t$python_cmd = find_python_no_venv();\n\n\tprintf \"\\t$virtualenv_cmd $virtenv_dir\\n\";\n\n\tprintf \"\\t. $virtenv_dir/bin/activate\\n\";\n\tprintf \"\\tpip install -r $requirement_file\\n\";\n\tdeactivate_help();\n\n\tprintf \"\\n2) As a package with:\\n\";\n\n\tmy $old_need = $need;\n\tmy $old_optional = $optional;\n\t%missing = ();\n\t$pdf = 0;\n\t$optional = 0;\n\t$install = \"\";\n\t$verbose_warn_install = 0;\n\n\tadd_package(\"python-sphinx\", 0);\n\n\tcheck_distros();\n\n\t$need = $old_need;\n\t$optional = $old_optional;\n\n\tprintf \"\\n    Please note that Sphinx >= 3.0 will currently produce false-positive\\n\";\n\tprintf \"   warning when the same name is used for more than one type (functions,\\n\";\n\tprintf \"   structs, enums,...). This is known Sphinx bug. For more details, see:\\n\";\n\tprintf \"\\thttps://github.com/sphinx-doc/sphinx/pull/8313\\n\";\n}\n\nsub check_needs()\n{\n\t# Check if Sphinx is already accessible from current environment\n\tcheck_sphinx();\n\n\tif ($system_release) {\n\t\tprint \"Detected OS: $system_release.\\n\";\n\t} else {\n\t\tprint \"Unknown OS\\n\";\n\t}\n\tprintf \"Sphinx version: %s\\n\\n\", $cur_version if ($cur_version);\n\n\t# Check python command line, trying first python3\n\t$python_cmd = findprog(\"python3\");\n\t$python_cmd = check_program(\"python\", 0) if (!$python_cmd);\n\n\t# Check the type of virtual env, depending on Python version\n\tif ($python_cmd) {\n\t\tif ($virtualenv) {\n\t\t\tmy $tmp = qx($python_cmd --version 2>&1);\n\t\t\tif ($tmp =~ m/(\\d+\\.)(\\d+\\.)/) {\n\t\t\t\tif ($1 < 3) {\n\t\t\t\t\t# Fail if it finds python2 (or worse)\n\t\t\t\t\tdie \"Python 3 is required to build the kernel docs\\n\";\n\t\t\t\t}\n\t\t\t\tif ($1 == 3 && $2 < 3) {\n\t\t\t\t\t# Need Python 3.3 or upper for venv\n\t\t\t\t\t$need_virtualenv = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdie \"Warning: couldn't identify $python_cmd version!\";\n\t\t\t}\n\t\t} else {\n\t\t\tadd_package(\"python-sphinx\", 0);\n\t\t}\n\t}\n\n\tmy $venv_ver = recommend_sphinx_upgrade();\n\n\tmy $virtualenv_cmd;\n\n\tif ($need_pip) {\n\t\t# Set virtualenv command line, if python < 3.3\n\t\tif ($need_virtualenv) {\n\t\t\t$virtualenv_cmd = findprog(\"virtualenv-3\");\n\t\t\t$virtualenv_cmd = findprog(\"virtualenv-3.5\") if (!$virtualenv_cmd);\n\t\t\tif (!$virtualenv_cmd) {\n\t\t\t\tcheck_program(\"virtualenv\", 0);\n\t\t\t\t$virtualenv_cmd = \"virtualenv\";\n\t\t\t}\n\t\t} else {\n\t\t\t$virtualenv_cmd = \"$python_cmd -m venv\";\n\t\t\tcheck_python_module(\"ensurepip\", 0);\n\t\t}\n\t}\n\n\t# Check for needed programs/tools\n\tcheck_perl_module(\"Pod::Usage\", 0);\n\tcheck_program(\"make\", 0);\n\tcheck_program(\"gcc\", 0);\n\tcheck_program(\"dot\", 1);\n\tcheck_program(\"convert\", 1);\n\n\t# Extra PDF files - should use 2 for is_optional\n\tcheck_program(\"xelatex\", 2) if ($pdf);\n\tcheck_program(\"rsvg-convert\", 2) if ($pdf);\n\tcheck_program(\"latexmk\", 2) if ($pdf);\n\n\t# Do distro-specific checks and output distro-install commands\n\tcheck_distros();\n\n\tif (!$python_cmd) {\n\t\tif ($need == 1) {\n\t\t\tdie \"Can't build as $need mandatory dependency is missing\";\n\t\t} elsif ($need) {\n\t\t\tdie \"Can't build as $need mandatory dependencies are missing\";\n\t\t}\n\t}\n\n\t# Check if sphinx-build is called sphinx-build-3\n\tif ($need_symlink) {\n\t\tprintf \"\\tsudo ln -sf %s /usr/bin/sphinx-build\\n\\n\",\n\t\t       which(\"sphinx-build-3\");\n\t}\n\n\trecommend_sphinx_version($virtualenv_cmd);\n\tprintf \"\\n\";\n\n\tprint \"All optional dependencies are met.\\n\" if (!$optional);\n\n\tif ($need == 1) {\n\t\tdie \"Can't build as $need mandatory dependency is missing\";\n\t} elsif ($need) {\n\t\tdie \"Can't build as $need mandatory dependencies are missing\";\n\t}\n\n\tprint \"Needed package dependencies are met.\\n\";\n}\n\n#\n# Main\n#\n\nwhile (@ARGV) {\n\tmy $arg = shift(@ARGV);\n\n\tif ($arg eq \"--no-virtualenv\") {\n\t\t$virtualenv = 0;\n\t} elsif ($arg eq \"--no-pdf\"){\n\t\t$pdf = 0;\n\t} elsif ($arg eq \"--version-check\"){\n\t\t$version_check = 1;\n\t} else {\n\t\tprint \"Usage:\\n\\t$0 <--no-virtualenv> <--no-pdf> <--version-check>\\n\\n\";\n\t\tprint \"Where:\\n\";\n\t\tprint \"\\t--no-virtualenv\\t- Recommend installing Sphinx instead of using a virtualenv\\n\";\n\t\tprint \"\\t--version-check\\t- if version is compatible, don't check for missing dependencies\\n\";\n\t\tprint \"\\t--no-pdf\\t- don't check for dependencies required to build PDF docs\\n\\n\";\n\t\texit -1;\n\t}\n}\n\n#\n# Determine the system type. There's no standard unique way that would\n# work with all distros with a minimal package install. So, several\n# methods are used here.\n#\n# By default, it will use lsb_release function. If not available, it will\n# fail back to reading the known different places where the distro name\n# is stored\n#\n\n$system_release = qx(lsb_release -d) if which(\"lsb_release\");\n$system_release =~ s/Description:\\s*// if ($system_release);\n$system_release = catcheck(\"/etc/system-release\") if !$system_release;\n$system_release = catcheck(\"/etc/redhat-release\") if !$system_release;\n$system_release = catcheck(\"/etc/lsb-release\") if !$system_release;\n$system_release = catcheck(\"/etc/gentoo-release\") if !$system_release;\n\n# This seems more common than LSB these days\nif (!$system_release) {\n\tmy %os_var;\n\tif (open IN, \"cat /etc/os-release|\") {\n\t\twhile (<IN>) {\n\t\t\tif (m/^([\\w\\d\\_]+)=\\\"?([^\\\"]*)\\\"?\\n/) {\n\t\t\t\t$os_var{$1}=$2;\n\t\t\t}\n\t\t}\n\t\t$system_release = $os_var{\"NAME\"};\n\t\tif (defined($os_var{\"VERSION_ID\"})) {\n\t\t\t$system_release .= \" \" . $os_var{\"VERSION_ID\"} if (defined($os_var{\"VERSION_ID\"}));\n\t\t} else {\n\t\t\t$system_release .= \" \" . $os_var{\"VERSION\"};\n\t\t}\n\t}\n}\n$system_release = catcheck(\"/etc/issue\") if !$system_release;\n$system_release =~ s/\\s+$//;\n\ncheck_needs;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}