{
  "module_name": "kvmalloc.cocci",
  "hash_id": "1a8dc1fc31f13b74eddefacd275e10d432a22b6da24dd03b30fe6be3d6185f4c",
  "original_prompt": "Ingested from linux-6.6.14/scripts/coccinelle/api/kvmalloc.cocci",
  "human_readable_source": "// SPDX-License-Identifier: GPL-2.0-only\n///\n/// Find if/else condition with kmalloc/vmalloc calls.\n/// Suggest to use kvmalloc instead. Same for kvfree.\n///\n// Confidence: High\n// Copyright: (C) 2020 Denis Efremov ISPRAS\n// Options: --no-includes --include-headers\n//\n\nvirtual patch\nvirtual report\nvirtual org\nvirtual context\n\n@initialize:python@\n@@\nfilter = frozenset(['kvfree'])\n\ndef relevant(p):\n    return not (filter & {el.current_element for el in p})\n\n@kvmalloc depends on !patch@\nexpression E, E1, size;\nidentifier flags;\nbinary operator cmp = {<=, <, ==, >, >=};\nidentifier x;\ntype T;\nposition p;\n@@\n\n(\n* if (size cmp E1 || ...)@p {\n    ...\n*    E = \\(kmalloc\\|kzalloc\\|kcalloc\\|kmalloc_node\\|kzalloc_node\\|\n*          kmalloc_array\\|kmalloc_array_node\\|kcalloc_node\\)\n*          (..., size, \\(flags\\|GFP_KERNEL\\|\\(GFP_KERNEL\\|flags\\)|__GFP_NOWARN\\), ...)\n    ...\n  } else {\n    ...\n*    E = \\(vmalloc\\|vzalloc\\|vmalloc_node\\|vzalloc_node\\)(..., size, ...)\n    ...\n  }\n|\n* E = \\(kmalloc\\|kzalloc\\|kcalloc\\|kmalloc_node\\|kzalloc_node\\|\n*       kmalloc_array\\|kmalloc_array_node\\|kcalloc_node\\)\n*       (..., size, \\(flags\\|GFP_KERNEL\\|\\(GFP_KERNEL\\|flags\\)|__GFP_NOWARN\\), ...)\n  ... when != E = E1\n      when != size = E1\n      when any\n* if (E == NULL)@p {\n    ...\n*   E = \\(vmalloc\\|vzalloc\\|vmalloc_node\\|vzalloc_node\\)(..., size, ...)\n    ...\n  }\n|\n* T x = \\(kmalloc\\|kzalloc\\|kcalloc\\|kmalloc_node\\|kzalloc_node\\|\n*         kmalloc_array\\|kmalloc_array_node\\|kcalloc_node\\)\n*         (..., size, \\(flags\\|GFP_KERNEL\\|\\(GFP_KERNEL\\|flags\\)|__GFP_NOWARN\\), ...);\n  ... when != x = E1\n      when != size = E1\n      when any\n* if (x == NULL)@p {\n    ...\n*   x = \\(vmalloc\\|vzalloc\\|vmalloc_node\\|vzalloc_node\\)(..., size, ...)\n    ...\n  }\n)\n\n@kvfree depends on !patch@\nexpression E;\nposition p : script:python() { relevant(p) };\n@@\n\n* if (is_vmalloc_addr(E))@p {\n    ...\n*   vfree(E)\n    ...\n  } else {\n    ... when != krealloc(E, ...)\n        when any\n*   \\(kfree\\|kfree_sensitive\\)(E)\n    ...\n  }\n\n@depends on patch@\nexpression E, E1, size, node;\nbinary operator cmp = {<=, <, ==, >, >=};\nidentifier flags, x;\ntype T;\n@@\n\n(\n- if (size cmp E1)\n-    E = kmalloc(size, flags);\n- else\n-    E = vmalloc(size);\n+ E = kvmalloc(size, flags);\n|\n- if (size cmp E1)\n-    E = kmalloc(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\));\n- else\n-    E = vmalloc(size);\n+ E = kvmalloc(size, GFP_KERNEL);\n|\n- E = kmalloc(size, flags | __GFP_NOWARN);\n- if (E == NULL)\n-   E = vmalloc(size);\n+ E = kvmalloc(size, flags);\n|\n- E = kmalloc(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\));\n- if (E == NULL)\n-   E = vmalloc(size);\n+ E = kvmalloc(size, GFP_KERNEL);\n|\n- T x = kmalloc(size, flags | __GFP_NOWARN);\n- if (x == NULL)\n-   x = vmalloc(size);\n+ T x = kvmalloc(size, flags);\n|\n- T x = kmalloc(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\));\n- if (x == NULL)\n-   x = vmalloc(size);\n+ T x = kvmalloc(size, GFP_KERNEL);\n|\n- if (size cmp E1)\n-    E = kzalloc(size, flags);\n- else\n-    E = vzalloc(size);\n+ E = kvzalloc(size, flags);\n|\n- if (size cmp E1)\n-    E = kzalloc(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\));\n- else\n-    E = vzalloc(size);\n+ E = kvzalloc(size, GFP_KERNEL);\n|\n- E = kzalloc(size, flags | __GFP_NOWARN);\n- if (E == NULL)\n-   E = vzalloc(size);\n+ E = kvzalloc(size, flags);\n|\n- E = kzalloc(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\));\n- if (E == NULL)\n-   E = vzalloc(size);\n+ E = kvzalloc(size, GFP_KERNEL);\n|\n- T x = kzalloc(size, flags | __GFP_NOWARN);\n- if (x == NULL)\n-   x = vzalloc(size);\n+ T x = kvzalloc(size, flags);\n|\n- T x = kzalloc(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\));\n- if (x == NULL)\n-   x = vzalloc(size);\n+ T x = kvzalloc(size, GFP_KERNEL);\n|\n- if (size cmp E1)\n-    E = kmalloc_node(size, flags, node);\n- else\n-    E = vmalloc_node(size, node);\n+ E = kvmalloc_node(size, flags, node);\n|\n- if (size cmp E1)\n-    E = kmalloc_node(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\), node);\n- else\n-    E = vmalloc_node(size, node);\n+ E = kvmalloc_node(size, GFP_KERNEL, node);\n|\n- E = kmalloc_node(size, flags | __GFP_NOWARN, node);\n- if (E == NULL)\n-   E = vmalloc_node(size, node);\n+ E = kvmalloc_node(size, flags, node);\n|\n- E = kmalloc_node(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\), node);\n- if (E == NULL)\n-   E = vmalloc_node(size, node);\n+ E = kvmalloc_node(size, GFP_KERNEL, node);\n|\n- T x = kmalloc_node(size, flags | __GFP_NOWARN, node);\n- if (x == NULL)\n-   x = vmalloc_node(size, node);\n+ T x = kvmalloc_node(size, flags, node);\n|\n- T x = kmalloc_node(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\), node);\n- if (x == NULL)\n-   x = vmalloc_node(size, node);\n+ T x = kvmalloc_node(size, GFP_KERNEL, node);\n|\n- if (size cmp E1)\n-    E = kvzalloc_node(size, flags, node);\n- else\n-    E = vzalloc_node(size, node);\n+ E = kvzalloc_node(size, flags, node);\n|\n- if (size cmp E1)\n-    E = kvzalloc_node(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\), node);\n- else\n-    E = vzalloc_node(size, node);\n+ E = kvzalloc_node(size, GFP_KERNEL, node);\n|\n- E = kvzalloc_node(size, flags | __GFP_NOWARN, node);\n- if (E == NULL)\n-   E = vzalloc_node(size, node);\n+ E = kvzalloc_node(size, flags, node);\n|\n- E = kvzalloc_node(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\), node);\n- if (E == NULL)\n-   E = vzalloc_node(size, node);\n+ E = kvzalloc_node(size, GFP_KERNEL, node);\n|\n- T x = kvzalloc_node(size, flags | __GFP_NOWARN, node);\n- if (x == NULL)\n-   x = vzalloc_node(size, node);\n+ T x = kvzalloc_node(size, flags, node);\n|\n- T x = kvzalloc_node(size, \\(GFP_KERNEL\\|GFP_KERNEL|__GFP_NOWARN\\), node);\n- if (x == NULL)\n-   x = vzalloc_node(size, node);\n+ T x = kvzalloc_node(size, GFP_KERNEL, node);\n)\n\n@depends on patch@\nexpression E;\nposition p : script:python() { relevant(p) };\n@@\n\n- if (is_vmalloc_addr(E))@p\n-   vfree(E);\n- else\n-   kfree(E);\n+ kvfree(E);\n\n@script: python depends on report@\np << kvmalloc.p;\n@@\n\ncoccilib.report.print_report(p[0], \"WARNING opportunity for kvmalloc\")\n\n@script: python depends on org@\np << kvmalloc.p;\n@@\n\ncoccilib.org.print_todo(p[0], \"WARNING opportunity for kvmalloc\")\n\n@script: python depends on report@\np << kvfree.p;\n@@\n\ncoccilib.report.print_report(p[0], \"WARNING opportunity for kvfree\")\n\n@script: python depends on org@\np << kvfree.p;\n@@\n\ncoccilib.org.print_todo(p[0], \"WARNING opportunity for kvfree\")\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}