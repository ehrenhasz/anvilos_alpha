{
  "module_name": "rust_is_available.sh",
  "hash_id": "c2404845cb70082e5c250c1b63d2070b1ca796b747623fd29e8ee9749e98b16a",
  "original_prompt": "Ingested from linux-6.6.14/scripts/rust_is_available.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n#\n# Tests whether a suitable Rust toolchain is available.\n\nset -e\n\nmin_tool_version=$(dirname $0)/min-tool-version.sh\n\n# Convert the version string x.y.z to a canonical up-to-7-digits form.\n#\n# Note that this function uses one more digit (compared to other\n# instances in other version scripts) to give a bit more space to\n# `rustc` since it will reach 1.100.0 in late 2026.\nget_canonical_version()\n{\n\tIFS=.\n\tset -- $1\n\techo $((100000 * $1 + 100 * $2 + $3))\n}\n\n# Print a reference to the Quick Start guide in the documentation.\nprint_docs_reference()\n{\n\techo >&2 \"***\"\n\techo >&2 \"*** Please see Documentation/rust/quick-start.rst for details\"\n\techo >&2 \"*** on how to set up the Rust support.\"\n\techo >&2 \"***\"\n}\n\n# Print an explanation about the fact that the script is meant to be called from Kbuild.\nprint_kbuild_explanation()\n{\n\techo >&2 \"***\"\n\techo >&2 \"*** This script is intended to be called from Kbuild.\"\n\techo >&2 \"*** Please use the 'rustavailable' target to call it instead.\"\n\techo >&2 \"*** Otherwise, the results may not be meaningful.\"\n\texit 1\n}\n\n# If the script fails for any reason, or if there was any warning, then\n# print a reference to the documentation on exit.\nwarning=0\ntrap 'if [ $? -ne 0 ] || [ $warning -ne 0 ]; then print_docs_reference; fi' EXIT\n\n# Check that the expected environment variables are set.\nif [ -z \"${RUSTC+x}\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Environment variable 'RUSTC' is not set.\"\n\tprint_kbuild_explanation\nfi\n\nif [ -z \"${BINDGEN+x}\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Environment variable 'BINDGEN' is not set.\"\n\tprint_kbuild_explanation\nfi\n\nif [ -z \"${CC+x}\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Environment variable 'CC' is not set.\"\n\tprint_kbuild_explanation\nfi\n\n# Check that the Rust compiler exists.\nif ! command -v \"$RUSTC\" >/dev/null; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Rust compiler '$RUSTC' could not be found.\"\n\techo >&2 \"***\"\n\texit 1\nfi\n\n# Check that the Rust bindings generator exists.\nif ! command -v \"$BINDGEN\" >/dev/null; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Rust bindings generator '$BINDGEN' could not be found.\"\n\techo >&2 \"***\"\n\texit 1\nfi\n\n# Check that the Rust compiler version is suitable.\n#\n# Non-stable and distributions' versions may have a version suffix, e.g. `-dev`.\nrust_compiler_output=$( \\\n\tLC_ALL=C \"$RUSTC\" --version 2>/dev/null\n) || rust_compiler_code=$?\nif [ -n \"$rust_compiler_code\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Running '$RUSTC' to check the Rust compiler version failed with\"\n\techo >&2 \"*** code $rust_compiler_code. See output and docs below for details:\"\n\techo >&2 \"***\"\n\techo >&2 \"$rust_compiler_output\"\n\techo >&2 \"***\"\n\texit 1\nfi\nrust_compiler_version=$( \\\n\techo \"$rust_compiler_output\" \\\n\t\t| sed -nE '1s:.*rustc ([0-9]+\\.[0-9]+\\.[0-9]+).*:\\1:p'\n)\nif [ -z \"$rust_compiler_version\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Running '$RUSTC' to check the Rust compiler version did not return\"\n\techo >&2 \"*** an expected output. See output and docs below for details:\"\n\techo >&2 \"***\"\n\techo >&2 \"$rust_compiler_output\"\n\techo >&2 \"***\"\n\texit 1\nfi\nrust_compiler_min_version=$($min_tool_version rustc)\nrust_compiler_cversion=$(get_canonical_version $rust_compiler_version)\nrust_compiler_min_cversion=$(get_canonical_version $rust_compiler_min_version)\nif [ \"$rust_compiler_cversion\" -lt \"$rust_compiler_min_cversion\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Rust compiler '$RUSTC' is too old.\"\n\techo >&2 \"***   Your version:    $rust_compiler_version\"\n\techo >&2 \"***   Minimum version: $rust_compiler_min_version\"\n\techo >&2 \"***\"\n\texit 1\nfi\nif [ \"$rust_compiler_cversion\" -gt \"$rust_compiler_min_cversion\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Rust compiler '$RUSTC' is too new. This may or may not work.\"\n\techo >&2 \"***   Your version:     $rust_compiler_version\"\n\techo >&2 \"***   Expected version: $rust_compiler_min_version\"\n\techo >&2 \"***\"\n\twarning=1\nfi\n\n# Check that the Rust bindings generator is suitable.\n#\n# Non-stable and distributions' versions may have a version suffix, e.g. `-dev`.\nrust_bindings_generator_output=$( \\\n\tLC_ALL=C \"$BINDGEN\" --version 2>/dev/null\n) || rust_bindings_generator_code=$?\nif [ -n \"$rust_bindings_generator_code\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Running '$BINDGEN' to check the Rust bindings generator version failed with\"\n\techo >&2 \"*** code $rust_bindings_generator_code. See output and docs below for details:\"\n\techo >&2 \"***\"\n\techo >&2 \"$rust_bindings_generator_output\"\n\techo >&2 \"***\"\n\texit 1\nfi\nrust_bindings_generator_version=$( \\\n\techo \"$rust_bindings_generator_output\" \\\n\t\t| sed -nE '1s:.*bindgen ([0-9]+\\.[0-9]+\\.[0-9]+).*:\\1:p'\n)\nif [ -z \"$rust_bindings_generator_version\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Running '$BINDGEN' to check the bindings generator version did not return\"\n\techo >&2 \"*** an expected output. See output and docs below for details:\"\n\techo >&2 \"***\"\n\techo >&2 \"$rust_bindings_generator_output\"\n\techo >&2 \"***\"\n\texit 1\nfi\nrust_bindings_generator_min_version=$($min_tool_version bindgen)\nrust_bindings_generator_cversion=$(get_canonical_version $rust_bindings_generator_version)\nrust_bindings_generator_min_cversion=$(get_canonical_version $rust_bindings_generator_min_version)\nif [ \"$rust_bindings_generator_cversion\" -lt \"$rust_bindings_generator_min_cversion\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Rust bindings generator '$BINDGEN' is too old.\"\n\techo >&2 \"***   Your version:    $rust_bindings_generator_version\"\n\techo >&2 \"***   Minimum version: $rust_bindings_generator_min_version\"\n\techo >&2 \"***\"\n\texit 1\nfi\nif [ \"$rust_bindings_generator_cversion\" -gt \"$rust_bindings_generator_min_cversion\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Rust bindings generator '$BINDGEN' is too new. This may or may not work.\"\n\techo >&2 \"***   Your version:     $rust_bindings_generator_version\"\n\techo >&2 \"***   Expected version: $rust_bindings_generator_min_version\"\n\techo >&2 \"***\"\n\twarning=1\nfi\n\n# Check that the `libclang` used by the Rust bindings generator is suitable.\n#\n# In order to do that, first invoke `bindgen` to get the `libclang` version\n# found by `bindgen`. This step may already fail if, for instance, `libclang`\n# is not found, thus inform the user in such a case.\nbindgen_libclang_output=$( \\\n\tLC_ALL=C \"$BINDGEN\" $(dirname $0)/rust_is_available_bindgen_libclang.h 2>&1 >/dev/null\n) || bindgen_libclang_code=$?\nif [ -n \"$bindgen_libclang_code\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Running '$BINDGEN' to check the libclang version (used by the Rust\"\n\techo >&2 \"*** bindings generator) failed with code $bindgen_libclang_code. This may be caused by\"\n\techo >&2 \"*** a failure to locate libclang. See output and docs below for details:\"\n\techo >&2 \"***\"\n\techo >&2 \"$bindgen_libclang_output\"\n\techo >&2 \"***\"\n\texit 1\nfi\n\n# `bindgen` returned successfully, thus use the output to check that the version\n# of the `libclang` found by the Rust bindings generator is suitable.\n#\n# Unlike other version checks, note that this one does not necessarily appear\n# in the first line of the output, thus no `sed` address is provided.\nbindgen_libclang_version=$( \\\n\techo \"$bindgen_libclang_output\" \\\n\t\t| sed -nE 's:.*clang version ([0-9]+\\.[0-9]+\\.[0-9]+).*:\\1:p'\n)\nif [ -z \"$bindgen_libclang_version\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Running '$BINDGEN' to check the libclang version (used by the Rust\"\n\techo >&2 \"*** bindings generator) did not return an expected output. See output\"\n\techo >&2 \"*** and docs below for details:\"\n\techo >&2 \"***\"\n\techo >&2 \"$bindgen_libclang_output\"\n\techo >&2 \"***\"\n\texit 1\nfi\nbindgen_libclang_min_version=$($min_tool_version llvm)\nbindgen_libclang_cversion=$(get_canonical_version $bindgen_libclang_version)\nbindgen_libclang_min_cversion=$(get_canonical_version $bindgen_libclang_min_version)\nif [ \"$bindgen_libclang_cversion\" -lt \"$bindgen_libclang_min_cversion\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** libclang (used by the Rust bindings generator '$BINDGEN') is too old.\"\n\techo >&2 \"***   Your version:    $bindgen_libclang_version\"\n\techo >&2 \"***   Minimum version: $bindgen_libclang_min_version\"\n\techo >&2 \"***\"\n\texit 1\nfi\n\n# If the C compiler is Clang, then we can also check whether its version\n# matches the `libclang` version used by the Rust bindings generator.\n#\n# In the future, we might be able to perform a full version check, see\n# https://github.com/rust-lang/rust-bindgen/issues/2138.\ncc_name=$($(dirname $0)/cc-version.sh $CC | cut -f1 -d' ')\nif [ \"$cc_name\" = Clang ]; then\n\tclang_version=$( \\\n\t\tLC_ALL=C $CC --version 2>/dev/null \\\n\t\t\t| sed -nE '1s:.*version ([0-9]+\\.[0-9]+\\.[0-9]+).*:\\1:p'\n\t)\n\tif [ \"$clang_version\" != \"$bindgen_libclang_version\" ]; then\n\t\techo >&2 \"***\"\n\t\techo >&2 \"*** libclang (used by the Rust bindings generator '$BINDGEN')\"\n\t\techo >&2 \"*** version does not match Clang's. This may be a problem.\"\n\t\techo >&2 \"***   libclang version: $bindgen_libclang_version\"\n\t\techo >&2 \"***   Clang version:    $clang_version\"\n\t\techo >&2 \"***\"\n\t\twarning=1\n\tfi\nfi\n\n# Check that the source code for the `core` standard library exists.\n#\n# `$KRUSTFLAGS` is passed in case the user added `--sysroot`.\nrustc_sysroot=$(\"$RUSTC\" $KRUSTFLAGS --print sysroot)\nrustc_src=${RUST_LIB_SRC:-\"$rustc_sysroot/lib/rustlib/src/rust/library\"}\nrustc_src_core=\"$rustc_src/core/src/lib.rs\"\nif [ ! -e \"$rustc_src_core\" ]; then\n\techo >&2 \"***\"\n\techo >&2 \"*** Source code for the 'core' standard library could not be found\"\n\techo >&2 \"*** at '$rustc_src_core'.\"\n\techo >&2 \"***\"\n\texit 1\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}