{
  "module_name": "patch-kernel",
  "hash_id": "20d2e1cd39366f175b4dc6a094263433475d527ba65bc97de62c6e27ab90c35c",
  "original_prompt": "Ingested from linux-6.6.14/scripts/patch-kernel",
  "human_readable_source": "#! /bin/sh\n# SPDX-License-Identifier: GPL-2.0\n# Script to apply kernel patches.\n#   usage: patch-kernel [ sourcedir [ patchdir [ stopversion ] [ -acxx ] ] ]\n#     The source directory defaults to /usr/src/linux, and the patch\n#     directory defaults to the current directory.\n# e.g.\n#   scripts/patch-kernel . ..\n#      Update the kernel tree in the current directory using patches in the\n#      directory above to the latest Linus kernel\n#   scripts/patch-kernel . .. -ac\n#      Get the latest Linux kernel and patch it with the latest ac patch\n#   scripts/patch-kernel . .. 2.4.9\n#      Gets standard kernel 2.4.9\n#   scripts/patch-kernel . .. 2.4.9 -ac\n#      Gets 2.4.9 with latest ac patches\n#   scripts/patch-kernel . .. 2.4.9 -ac11\n#      Gets 2.4.9 with ac patch ac11\n#   Note: It uses the patches relative to the Linus kernels, not the\n#   ac to ac relative patches\n#\n# It determines the current kernel version from the top-level Makefile.\n# It then looks for patches for the next sublevel in the patch directory.\n# This is applied using \"patch -p1 -s\" from within the kernel directory.\n# A check is then made for \"*.rej\" files to see if the patch was\n# successful.  If it is, then all of the \"*.orig\" files are removed.\n#\n#       Nick Holloway <Nick.Holloway@alfie.demon.co.uk>, 2nd January 1995.\n#\n# Added support for handling multiple types of compression. What includes\n# gzip, bzip, bzip2, zip, compress, and plaintext.\n#\n#       Adam Sulmicki <adam@cfar.umd.edu>, 1st January 1997.\n#\n# Added ability to stop at a given version number\n# Put the full version number (i.e. 2.3.31) as the last parameter\n#       Dave Gilbert <linux@treblig.org>, 11th December 1999.\n\n# Fixed previous patch so that if we are already at the correct version\n# not to patch up.\n#\n# Added -ac option, use -ac or -ac9 (say) to stop at a particular version\n#       Dave Gilbert <linux@treblig.org>, 29th September 2001.\n#\n# Add support for (use of) EXTRAVERSION (to support 2.6.8.x, e.g.);\n# update usage message;\n# fix some whitespace damage;\n# be smarter about stopping when current version is larger than requested;\n#\tRandy Dunlap <rdunlap@xenotime.net>, 2004-AUG-18.\n#\n# Add better support for (non-incremental) 2.6.x.y patches;\n# If an ending version number if not specified, the script automatically\n# increments the SUBLEVEL (x in 2.6.x.y) until no more patch files are found;\n# however, EXTRAVERSION (y in 2.6.x.y) is never automatically incremented\n# but must be specified fully.\n#\n# patch-kernel does not normally support reverse patching, but does so when\n# applying EXTRAVERSION (x.y) patches, so that moving from 2.6.11.y to 2.6.11.z\n# is easy and handled by the script (reverse 2.6.11.y and apply 2.6.11.z).\n#\tRandy Dunlap <rdunlap@xenotime.net>, 2005-APR-08.\n\nPNAME=patch-kernel\n\n# Set directories from arguments, or use defaults.\nsourcedir=${1-/usr/src/linux}\npatchdir=${2-.}\nstopvers=${3-default}\n\nif [ \"$1\" = -h -o \"$1\" = --help -o ! -r \"$sourcedir/Makefile\" ]; then\ncat << USAGE\nusage: $PNAME [-h] [ sourcedir [ patchdir [ stopversion ] [ -acxx ] ] ]\n  source directory defaults to /usr/src/linux,\n  patch directory defaults to the current directory,\n  stopversion defaults to <all in patchdir>.\nUSAGE\nexit 1\nfi\n\n# See if we have any -ac options\nfor PARM in $*\ndo\n  case $PARM in\n\t  -ac*)\n\t\t  gotac=$PARM;\n\n\tesac;\ndone\n\n# ---------------------------------------------------------------------------\n# arg1 is filename\nnoFile () {\n\techo \"cannot find patch file: ${patch}\"\n\texit 1\n}\n\n# ---------------------------------------------------------------------------\nbackwards () {\n\techo \"$PNAME does not support reverse patching\"\n\texit 1\n}\n\n# ---------------------------------------------------------------------------\n# Find a file, first parameter is basename of file\n# it tries many compression mechanisms and sets variables to say how to get it\nfindFile () {\n  filebase=$1;\n\n  if [ -r ${filebase}.gz ]; then\n\t\text=\".gz\"\n\t\tname=\"gzip\"\n\t\tuncomp=\"gunzip -dc\"\n  elif [ -r ${filebase}.bz  ]; then\n\t\text=\".bz\"\n\t\tname=\"bzip\"\n\t\tuncomp=\"bunzip -dc\"\n  elif [ -r ${filebase}.bz2 ]; then\n\t\text=\".bz2\"\n\t\tname=\"bzip2\"\n\t\tuncomp=\"bunzip2 -dc\"\n  elif [ -r ${filebase}.xz ]; then\n                ext=\".xz\"\n                name=\"xz\"\n                uncomp=\"xz -dc\"\n  elif [ -r ${filebase}.zip ]; then\n\t\text=\".zip\"\n\t\tname=\"zip\"\n\t\tuncomp=\"unzip -d\"\n  elif [ -r ${filebase}.Z ]; then\n\t\text=\".Z\"\n\t\tname=\"uncompress\"\n\t\tuncomp=\"uncompress -c\"\n  elif [ -r ${filebase} ]; then\n\t\text=\"\"\n\t\tname=\"plaintext\"\n\t\tuncomp=\"cat\"\n  else\n\treturn 1;\n  fi\n\n  return 0;\n}\n\n# ---------------------------------------------------------------------------\n# Apply a patch and check it goes in cleanly\n# First param is patch name (e.g. patch-2.4.9-ac5) - without path or extension\n\napplyPatch () {\n  echo -n \"Applying $1 (${name})... \"\n  if $uncomp ${patchdir}/$1${ext} | patch -p1 -s -N -E -d $sourcedir\n  then\n    echo \"done.\"\n  else\n    echo \"failed.  Clean up yourself.\"\n    return 1;\n  fi\n  if [ \"`find $sourcedir/ '(' -name '*.rej' -o -name '.*.rej' ')' -print`\" ]\n  then\n    echo \"Aborting.  Reject files found.\"\n    return 1;\n  fi\n  # Remove backup files\n  find $sourcedir/ '(' -name '*.orig' -o -name '.*.orig' ')' -exec rm -f {} \\;\n\n  return 0;\n}\n\n# ---------------------------------------------------------------------------\n# arg1 is patch filename\nreversePatch () {\n\techo -n \"Reversing $1 (${name}) ... \"\n\tif $uncomp ${patchdir}/\"$1\"${ext} | patch -p1 -Rs -N -E -d $sourcedir\n\tthen\n\t\techo \"done.\"\n\telse\n\t\techo \"failed.  Clean it up.\"\n\t\texit 1\n\tfi\n\tif [ \"`find $sourcedir/ '(' -name '*.rej' -o -name '.*.rej' ')' -print`\" ]\n\tthen\n\t\techo \"Aborting.  Reject files found.\"\n\t\treturn 1\n\tfi\n\t# Remove backup files\n\tfind $sourcedir/ '(' -name '*.orig' -o -name '.*.orig' ')' -exec rm -f {} \\;\n\n\treturn 0\n}\n\n# set current VERSION, PATCHLEVEL, SUBLEVEL, EXTRAVERSION\n# force $TMPFILEs below to be in local directory: a slash character prevents\n# the dot command from using the search path.\nTMPFILE=`mktemp ./.tmpver.XXXXXX` || { echo \"cannot make temp file\" ; exit 1; }\ngrep -E \"^(VERSION|PATCHLEVEL|SUBLEVEL|EXTRAVERSION)\" $sourcedir/Makefile > $TMPFILE\ntr -d [:blank:] < $TMPFILE > $TMPFILE.1\n. $TMPFILE.1\nrm -f $TMPFILE*\nif [ -z \"$VERSION\" -o -z \"$PATCHLEVEL\" -o -z \"$SUBLEVEL\" ]\nthen\n    echo \"unable to determine current kernel version\" >&2\n    exit 1\nfi\n\nNAME=`grep ^NAME $sourcedir/Makefile`\nNAME=${NAME##*=}\n\necho \"Current kernel version is $VERSION.$PATCHLEVEL.$SUBLEVEL${EXTRAVERSION} ($NAME)\"\n\n# strip EXTRAVERSION to just a number (drop leading '.' and trailing additions)\nEXTRAVER=\nif [ x$EXTRAVERSION != \"x\" ]\nthen\n\tEXTRAVER=${EXTRAVERSION#.}\n\tEXTRAVER=${EXTRAVER%%[[:punct:]]*}\n\t#echo \"$PNAME: changing EXTRAVERSION from $EXTRAVERSION to $EXTRAVER\"\nfi\n\n#echo \"stopvers=$stopvers\"\nif [ $stopvers != \"default\" ]; then\n\tSTOPSUBLEVEL=`echo $stopvers | cut -d. -f3`\n\tSTOPEXTRA=`echo $stopvers | cut -d. -f4`\n\tSTOPFULLVERSION=${stopvers%%.$STOPEXTRA}\n\t#echo \"#___STOPSUBLEVEL=/$STOPSUBLEVEL/, STOPEXTRA=/$STOPEXTRA/\"\nelse\n\tSTOPSUBLEVEL=9999\n\tSTOPEXTRA=9999\nfi\n\n# This all assumes a 2.6.x[.y] kernel tree.\n# Don't allow backwards/reverse patching.\nif [ $STOPSUBLEVEL -lt $SUBLEVEL ]; then\n\tbackwards\nfi\n\nif [ x$EXTRAVER != \"x\" ]; then\n\tCURRENTFULLVERSION=\"$VERSION.$PATCHLEVEL.$SUBLEVEL.$EXTRAVER\"\nelse\n\tCURRENTFULLVERSION=\"$VERSION.$PATCHLEVEL.$SUBLEVEL\"\nfi\n\nif [ x$EXTRAVER != \"x\" ]; then\n\techo \"backing up to: $VERSION.$PATCHLEVEL.$SUBLEVEL\"\n\tpatch=\"patch-${CURRENTFULLVERSION}\"\n\tfindFile $patchdir/${patch} || noFile ${patch}\n\treversePatch ${patch} || exit 1\nfi\n\n# now current is 2.6.x, with no EXTRA applied,\n# so update to target SUBLEVEL (2.6.SUBLEVEL)\n# and then to target EXTRAVER (2.6.SUB.EXTRAVER) if requested.\n# If not ending sublevel is specified, it is incremented until\n# no further sublevels are found.\n\nif [ $STOPSUBLEVEL -gt $SUBLEVEL ]; then\nwhile :\t\t\t\t# incrementing SUBLEVEL (s in v.p.s)\ndo\n    CURRENTFULLVERSION=\"$VERSION.$PATCHLEVEL.$SUBLEVEL\"\n    EXTRAVER=\n    if [ x$STOPFULLVERSION = x$CURRENTFULLVERSION ]; then\n        echo \"Stopping at $CURRENTFULLVERSION base as requested.\"\n        break\n    fi\n\n    SUBLEVEL=$(($SUBLEVEL + 1))\n    FULLVERSION=\"$VERSION.$PATCHLEVEL.$SUBLEVEL\"\n    #echo \"#___ trying $FULLVERSION ___\"\n\n    if [ $(($SUBLEVEL)) -gt $(($STOPSUBLEVEL)) ]; then\n\techo \"Stopping since sublevel ($SUBLEVEL) is beyond stop-sublevel ($STOPSUBLEVEL)\"\n\texit 1\n    fi\n\n    patch=patch-$FULLVERSION\n    # See if the file exists and find extension\n    findFile $patchdir/${patch} || noFile ${patch}\n\n    # Apply the patch and check all is OK\n    applyPatch $patch || break\ndone\n#echo \"#___sublevel all done\"\nfi\n\n# There is no incremental searching for extraversion...\nif [ \"$STOPEXTRA\" != \"\" ]; then\nwhile :\t\t\t\t# just to allow break\ndo\n# apply STOPEXTRA directly (not incrementally) (x in v.p.s.x)\n\tFULLVERSION=\"$VERSION.$PATCHLEVEL.$SUBLEVEL.$STOPEXTRA\"\n\t#echo \"#... trying $FULLVERSION ...\"\n\tpatch=patch-$FULLVERSION\n\n\t# See if the file exists and find extension\n\tfindFile $patchdir/${patch} || noFile ${patch}\n\n\t# Apply the patch and check all is OK\n\tapplyPatch $patch || break\n\t#echo \"#___extraver all done\"\n\tbreak\ndone\nfi\n\nif [ x$gotac != x ]; then\n  # Out great user wants the -ac patches\n\t# They could have done -ac (get latest) or -acxx where xx=version they want\n\tif [ $gotac = \"-ac\" ]; then\n\t  # They want the latest version\n\t\tHIGHESTPATCH=0\n\t\tfor PATCHNAMES in $patchdir/patch-${CURRENTFULLVERSION}-ac*\\.*\n\t\tdo\n\t\t\tACVALUE=`echo $PATCHNAMES | sed -e 's/^.*patch-[0-9.]*-ac\\([0-9]*\\).*/\\1/'`\n\t\t\t# Check it is actually a recognised patch type\n\t\t\tfindFile $patchdir/patch-${CURRENTFULLVERSION}-ac${ACVALUE} || break\n\n\t\t  if [ $ACVALUE -gt $HIGHESTPATCH ]; then\n\t\t\t  HIGHESTPATCH=$ACVALUE\n\t\t  fi\n\t\tdone\n\n\t\tif [ $HIGHESTPATCH -ne 0 ]; then\n\t\t\tfindFile $patchdir/patch-${CURRENTFULLVERSION}-ac${HIGHESTPATCH} || break\n\t\t\tapplyPatch patch-${CURRENTFULLVERSION}-ac${HIGHESTPATCH}\n\t\telse\n\t\t  echo \"No -ac patches found\"\n\t\tfi\n\telse\n\t  # They want an exact version\n\t\tfindFile $patchdir/patch-${CURRENTFULLVERSION}${gotac} || {\n\t\t  echo \"Sorry, I couldn't find the $gotac patch for $CURRENTFULLVERSION.  Hohum.\"\n\t\t\texit 1\n\t\t}\n\t\tapplyPatch patch-${CURRENTFULLVERSION}${gotac}\n\tfi\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}