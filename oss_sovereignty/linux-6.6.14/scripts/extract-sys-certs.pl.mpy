{
  "module_name": "extract-sys-certs.pl",
  "hash_id": "e426c8585c95e14cf7d8c64d1e3c25fcce837e25f3e09275a3ccb766f3248fd1",
  "original_prompt": "Ingested from linux-6.6.14/scripts/extract-sys-certs.pl",
  "human_readable_source": "#!/usr/bin/env perl\n# SPDX-License-Identifier: GPL-2.0\n#\nuse warnings;\nuse strict;\nuse Math::BigInt;\nuse Fcntl \"SEEK_SET\";\n\ndie \"Format: $0 [-s <systemmap-file>] <vmlinux-file> <keyring-file>\\n\"\n    if ($#ARGV != 1 && $#ARGV != 3 ||\n\t$#ARGV == 3 && $ARGV[0] ne \"-s\");\n\nmy $sysmap = \"\";\nif ($#ARGV == 3) {\n    shift;\n    $sysmap = $ARGV[0];\n    shift;\n}\n\nmy $vmlinux = $ARGV[0];\nmy $keyring = $ARGV[1];\n\n#\n# Parse the vmlinux section table\n#\nopen FD, \"objdump -h $vmlinux |\" || die $vmlinux;\nmy @lines = <FD>;\nclose(FD) || die $vmlinux;\n\nmy @sections = ();\n\nforeach my $line (@lines) {\n    chomp($line);\n    if ($line =~ /\\s*([0-9]+)\\s+(\\S+)\\s+([0-9a-f]+)\\s+([0-9a-f]+)\\s+([0-9a-f]+)\\s+([0-9a-f]+)\\s+2[*][*]([0-9]+)/\n\t) {\n\tmy $seg  = $1;\n\tmy $name = $2;\n\tmy $len  = Math::BigInt->new(\"0x\" . $3);\n\tmy $vma  = Math::BigInt->new(\"0x\" . $4);\n\tmy $lma  = Math::BigInt->new(\"0x\" . $5);\n\tmy $foff = Math::BigInt->new(\"0x\" . $6);\n\tmy $align = 2 ** $7;\n\n\tpush @sections, { name => $name,\n\t\t\t  vma => $vma,\n\t\t\t  len => $len,\n\t\t\t  foff => $foff };\n    }\n}\n\nprint \"Have $#sections sections\\n\";\n\n#\n# Try and parse the vmlinux symbol table.  If the vmlinux file has been created\n# from a vmlinuz file with extract-vmlinux then the symbol table will be empty.\n#\nopen FD, \"nm $vmlinux 2>/dev/null |\" || die $vmlinux;\n@lines = <FD>;\nclose(FD) || die $vmlinux;\n\nmy %symbols = ();\nmy $nr_symbols = 0;\n\nsub parse_symbols(@) {\n    foreach my $line (@_) {\n\tchomp($line);\n\tif ($line =~ /([0-9a-f]+)\\s([a-zA-Z])\\s(\\S+)/\n\t    ) {\n\t    my $addr = \"0x\" . $1;\n\t    my $type = $2;\n\t    my $name = $3;\n\n\t    $symbols{$name} = $addr;\n\t    $nr_symbols++;\n\t}\n    }\n}\nparse_symbols(@lines);\n\nif ($nr_symbols == 0 && $sysmap ne \"\") {\n    print \"No symbols in vmlinux, trying $sysmap\\n\";\n\n    open FD, \"<$sysmap\" || die $sysmap;\n    @lines = <FD>;\n    close(FD) || die $sysmap;\n    parse_symbols(@lines);\n}\n\ndie \"No symbols available\\n\"\n    if ($nr_symbols == 0);\n\nprint \"Have $nr_symbols symbols\\n\";\n\ndie \"Can't find system certificate list\"\n    unless (exists($symbols{\"__cert_list_start\"}) &&\n\t    exists($symbols{\"system_certificate_list_size\"}));\n\nmy $start = Math::BigInt->new($symbols{\"__cert_list_start\"});\nmy $end;\nmy $size;\nmy $size_sym = Math::BigInt->new($symbols{\"system_certificate_list_size\"});\n\nopen FD, \"<$vmlinux\" || die $vmlinux;\nbinmode(FD);\n\nmy $s = undef;\nforeach my $sec (@sections) {\n    my $s_name = $sec->{name};\n    my $s_vma = $sec->{vma};\n    my $s_len = $sec->{len};\n    my $s_foff = $sec->{foff};\n    my $s_vend = $s_vma + $s_len;\n\n    next unless ($start >= $s_vma);\n    next if ($start >= $s_vend);\n\n    die \"Certificate list size was not found on the same section\\n\"\n\tif ($size_sym < $s_vma || $size_sym > $s_vend);\n\n    die \"Cert object in multiple sections: \", $s_name, \" and \", $s->{name}, \"\\n\"\n\tif ($s);\n\n    my $size_off = $size_sym -$s_vma + $s_foff;\n    my $packed;\n    die $vmlinux if (!defined(sysseek(FD, $size_off, SEEK_SET)));\n    sysread(FD, $packed, 8);\n    $size = unpack 'L!', $packed;\n    $end = $start + $size;\n\n    printf \"Have %u bytes of certs at VMA 0x%x\\n\", $size, $start;\n\n    die \"Cert object partially overflows section $s_name\\n\"\n\tif ($end > $s_vend);\n\n    $s = $sec;\n}\n\ndie \"Cert object not inside a section\\n\"\n    unless ($s);\n\nprint \"Certificate list in section \", $s->{name}, \"\\n\";\n\nmy $foff = $start - $s->{vma} + $s->{foff};\n\nprintf \"Certificate list at file offset 0x%x\\n\", $foff;\n\ndie $vmlinux if (!defined(sysseek(FD, $foff, SEEK_SET)));\nmy $buf = \"\";\nmy $len = sysread(FD, $buf, $size);\ndie \"$vmlinux\" if (!defined($len));\ndie \"Short read on $vmlinux\\n\" if ($len != $size);\nclose(FD) || die $vmlinux;\n\nopen FD, \">$keyring\" || die $keyring;\nbinmode(FD);\n$len = syswrite(FD, $buf, $size);\ndie \"$keyring\" if (!defined($len));\ndie \"Short write on $keyring\\n\" if ($len != $size);\nclose(FD) || die $keyring;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}