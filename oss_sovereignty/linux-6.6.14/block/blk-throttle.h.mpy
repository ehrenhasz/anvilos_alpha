{
  "module_name": "blk-throttle.h",
  "hash_id": "83e7953d38486e0eb9e563b38e7c1ac44b7addac4022b85e0c9d37c41dd60040",
  "original_prompt": "Ingested from linux-6.6.14/block/blk-throttle.h",
  "human_readable_source": "#ifndef BLK_THROTTLE_H\n#define BLK_THROTTLE_H\n\n#include \"blk-cgroup-rwstat.h\"\n\n \nstruct throtl_qnode {\n\tstruct list_head\tnode;\t\t \n\tstruct bio_list\t\tbios;\t\t \n\tstruct throtl_grp\t*tg;\t\t \n};\n\nstruct throtl_service_queue {\n\tstruct throtl_service_queue *parent_sq;\t \n\n\t \n\tstruct list_head\tqueued[2];\t \n\tunsigned int\t\tnr_queued[2];\t \n\n\t \n\tstruct rb_root_cached\tpending_tree;\t \n\tunsigned int\t\tnr_pending;\t \n\tunsigned long\t\tfirst_pending_disptime;\t \n\tstruct timer_list\tpending_timer;\t \n};\n\nenum tg_state_flags {\n\tTHROTL_TG_PENDING\t= 1 << 0,\t \n\tTHROTL_TG_WAS_EMPTY\t= 1 << 1,\t \n\tTHROTL_TG_CANCELING\t= 1 << 2,\t \n};\n\nenum {\n\tLIMIT_LOW,\n\tLIMIT_MAX,\n\tLIMIT_CNT,\n};\n\nstruct throtl_grp {\n\t \n\tstruct blkg_policy_data pd;\n\n\t \n\tstruct rb_node rb_node;\n\n\t \n\tstruct throtl_data *td;\n\n\t \n\tstruct throtl_service_queue service_queue;\n\n\t \n\tstruct throtl_qnode qnode_on_self[2];\n\tstruct throtl_qnode qnode_on_parent[2];\n\n\t \n\tunsigned long disptime;\n\n\tunsigned int flags;\n\n\t \n\tbool has_rules_bps[2];\n\tbool has_rules_iops[2];\n\n\t \n\tuint64_t bps[2][LIMIT_CNT];\n\t \n\tuint64_t bps_conf[2][LIMIT_CNT];\n\n\t \n\tunsigned int iops[2][LIMIT_CNT];\n\t \n\tunsigned int iops_conf[2][LIMIT_CNT];\n\n\t \n\tuint64_t bytes_disp[2];\n\t \n\tunsigned int io_disp[2];\n\n\tunsigned long last_low_overflow_time[2];\n\n\tuint64_t last_bytes_disp[2];\n\tunsigned int last_io_disp[2];\n\n\t \n\tlong long carryover_bytes[2];\n\tint carryover_ios[2];\n\n\tunsigned long last_check_time;\n\n\tunsigned long latency_target;  \n\tunsigned long latency_target_conf;  \n\t \n\tunsigned long slice_start[2];\n\tunsigned long slice_end[2];\n\n\tunsigned long last_finish_time;  \n\tunsigned long checked_last_finish_time;  \n\tunsigned long avg_idletime;  \n\tunsigned long idletime_threshold;  \n\tunsigned long idletime_threshold_conf;  \n\n\tunsigned int bio_cnt;  \n\tunsigned int bad_bio_cnt;  \n\tunsigned long bio_cnt_reset_time;\n\n\tstruct blkg_rwstat stat_bytes;\n\tstruct blkg_rwstat stat_ios;\n};\n\nextern struct blkcg_policy blkcg_policy_throtl;\n\nstatic inline struct throtl_grp *pd_to_tg(struct blkg_policy_data *pd)\n{\n\treturn pd ? container_of(pd, struct throtl_grp, pd) : NULL;\n}\n\nstatic inline struct throtl_grp *blkg_to_tg(struct blkcg_gq *blkg)\n{\n\treturn pd_to_tg(blkg_to_pd(blkg, &blkcg_policy_throtl));\n}\n\n \n#ifndef CONFIG_BLK_DEV_THROTTLING\nstatic inline int blk_throtl_init(struct gendisk *disk) { return 0; }\nstatic inline void blk_throtl_exit(struct gendisk *disk) { }\nstatic inline void blk_throtl_register(struct gendisk *disk) { }\nstatic inline bool blk_throtl_bio(struct bio *bio) { return false; }\nstatic inline void blk_throtl_cancel_bios(struct gendisk *disk) { }\n#else  \nint blk_throtl_init(struct gendisk *disk);\nvoid blk_throtl_exit(struct gendisk *disk);\nvoid blk_throtl_register(struct gendisk *disk);\nbool __blk_throtl_bio(struct bio *bio);\nvoid blk_throtl_cancel_bios(struct gendisk *disk);\n\nstatic inline bool blk_should_throtl(struct bio *bio)\n{\n\tstruct throtl_grp *tg = blkg_to_tg(bio->bi_blkg);\n\tint rw = bio_data_dir(bio);\n\n\tif (!cgroup_subsys_on_dfl(io_cgrp_subsys)) {\n\t\tif (!bio_flagged(bio, BIO_CGROUP_ACCT)) {\n\t\t\tbio_set_flag(bio, BIO_CGROUP_ACCT);\n\t\t\tblkg_rwstat_add(&tg->stat_bytes, bio->bi_opf,\n\t\t\t\t\tbio->bi_iter.bi_size);\n\t\t}\n\t\tblkg_rwstat_add(&tg->stat_ios, bio->bi_opf, 1);\n\t}\n\n\t \n\tif (tg->has_rules_iops[rw])\n\t\treturn true;\n\n\tif (tg->has_rules_bps[rw] && !bio_flagged(bio, BIO_BPS_THROTTLED))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic inline bool blk_throtl_bio(struct bio *bio)\n{\n\n\tif (!blk_should_throtl(bio))\n\t\treturn false;\n\n\treturn __blk_throtl_bio(bio);\n}\n#endif  \n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}