{
  "module_name": "blk-ioprio.c",
  "hash_id": "cec3f3933aa0a29160c771e49568c2f6cf12c5385e23242100d4e6bff8b27f00",
  "original_prompt": "Ingested from linux-6.6.14/block/blk-ioprio.c",
  "human_readable_source": "\n \n\n#include <linux/blk-mq.h>\n#include <linux/blk_types.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include \"blk-cgroup.h\"\n#include \"blk-ioprio.h\"\n#include \"blk-rq-qos.h\"\n\n \nenum prio_policy {\n\tPOLICY_NO_CHANGE\t= 0,\n\tPOLICY_PROMOTE_TO_RT\t= 1,\n\tPOLICY_RESTRICT_TO_BE\t= 2,\n\tPOLICY_ALL_TO_IDLE\t= 3,\n\tPOLICY_NONE_TO_RT\t= 4,\n};\n\nstatic const char *policy_name[] = {\n\t[POLICY_NO_CHANGE]\t= \"no-change\",\n\t[POLICY_PROMOTE_TO_RT]\t= \"promote-to-rt\",\n\t[POLICY_RESTRICT_TO_BE]\t= \"restrict-to-be\",\n\t[POLICY_ALL_TO_IDLE]\t= \"idle\",\n\t[POLICY_NONE_TO_RT]\t= \"none-to-rt\",\n};\n\nstatic struct blkcg_policy ioprio_policy;\n\n \nstruct ioprio_blkg {\n\tstruct blkg_policy_data pd;\n};\n\n \nstruct ioprio_blkcg {\n\tstruct blkcg_policy_data cpd;\n\tenum prio_policy\t prio_policy;\n};\n\nstatic inline struct ioprio_blkg *pd_to_ioprio(struct blkg_policy_data *pd)\n{\n\treturn pd ? container_of(pd, struct ioprio_blkg, pd) : NULL;\n}\n\nstatic struct ioprio_blkcg *blkcg_to_ioprio_blkcg(struct blkcg *blkcg)\n{\n\treturn container_of(blkcg_to_cpd(blkcg, &ioprio_policy),\n\t\t\t    struct ioprio_blkcg, cpd);\n}\n\nstatic struct ioprio_blkcg *\nioprio_blkcg_from_css(struct cgroup_subsys_state *css)\n{\n\treturn blkcg_to_ioprio_blkcg(css_to_blkcg(css));\n}\n\nstatic struct ioprio_blkcg *ioprio_blkcg_from_bio(struct bio *bio)\n{\n\tstruct blkg_policy_data *pd = blkg_to_pd(bio->bi_blkg, &ioprio_policy);\n\n\tif (!pd)\n\t\treturn NULL;\n\n\treturn blkcg_to_ioprio_blkcg(pd->blkg->blkcg);\n}\n\nstatic int ioprio_show_prio_policy(struct seq_file *sf, void *v)\n{\n\tstruct ioprio_blkcg *blkcg = ioprio_blkcg_from_css(seq_css(sf));\n\n\tseq_printf(sf, \"%s\\n\", policy_name[blkcg->prio_policy]);\n\treturn 0;\n}\n\nstatic ssize_t ioprio_set_prio_policy(struct kernfs_open_file *of, char *buf,\n\t\t\t\t      size_t nbytes, loff_t off)\n{\n\tstruct ioprio_blkcg *blkcg = ioprio_blkcg_from_css(of_css(of));\n\tint ret;\n\n\tif (off != 0)\n\t\treturn -EIO;\n\t \n\tret = sysfs_match_string(policy_name, buf);\n\tif (ret < 0)\n\t\treturn ret;\n\tblkcg->prio_policy = ret;\n\treturn nbytes;\n}\n\nstatic struct blkg_policy_data *\nioprio_alloc_pd(struct gendisk *disk, struct blkcg *blkcg, gfp_t gfp)\n{\n\tstruct ioprio_blkg *ioprio_blkg;\n\n\tioprio_blkg = kzalloc(sizeof(*ioprio_blkg), gfp);\n\tif (!ioprio_blkg)\n\t\treturn NULL;\n\n\treturn &ioprio_blkg->pd;\n}\n\nstatic void ioprio_free_pd(struct blkg_policy_data *pd)\n{\n\tstruct ioprio_blkg *ioprio_blkg = pd_to_ioprio(pd);\n\n\tkfree(ioprio_blkg);\n}\n\nstatic struct blkcg_policy_data *ioprio_alloc_cpd(gfp_t gfp)\n{\n\tstruct ioprio_blkcg *blkcg;\n\n\tblkcg = kzalloc(sizeof(*blkcg), gfp);\n\tif (!blkcg)\n\t\treturn NULL;\n\tblkcg->prio_policy = POLICY_NO_CHANGE;\n\treturn &blkcg->cpd;\n}\n\nstatic void ioprio_free_cpd(struct blkcg_policy_data *cpd)\n{\n\tstruct ioprio_blkcg *blkcg = container_of(cpd, typeof(*blkcg), cpd);\n\n\tkfree(blkcg);\n}\n\n#define IOPRIO_ATTRS\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.name\t\t= \"prio.class\",\t\t\t\\\n\t\t.seq_show\t= ioprio_show_prio_policy,\t\\\n\t\t.write\t\t= ioprio_set_prio_policy,\t\\\n\t},\t\t\t\t\t\t\t\\\n\t{ }  \n\n \nstatic struct cftype ioprio_files[] = {\n\tIOPRIO_ATTRS\n};\n\n \nstatic struct cftype ioprio_legacy_files[] = {\n\tIOPRIO_ATTRS\n};\n\nstatic struct blkcg_policy ioprio_policy = {\n\t.dfl_cftypes\t= ioprio_files,\n\t.legacy_cftypes = ioprio_legacy_files,\n\n\t.cpd_alloc_fn\t= ioprio_alloc_cpd,\n\t.cpd_free_fn\t= ioprio_free_cpd,\n\n\t.pd_alloc_fn\t= ioprio_alloc_pd,\n\t.pd_free_fn\t= ioprio_free_pd,\n};\n\nvoid blkcg_set_ioprio(struct bio *bio)\n{\n\tstruct ioprio_blkcg *blkcg = ioprio_blkcg_from_bio(bio);\n\tu16 prio;\n\n\tif (!blkcg || blkcg->prio_policy == POLICY_NO_CHANGE)\n\t\treturn;\n\n\tif (blkcg->prio_policy == POLICY_PROMOTE_TO_RT ||\n\t    blkcg->prio_policy == POLICY_NONE_TO_RT) {\n\t\t \n\t\tif (IOPRIO_PRIO_CLASS(bio->bi_ioprio) != IOPRIO_CLASS_RT)\n\t\t\tbio->bi_ioprio = IOPRIO_PRIO_VALUE(IOPRIO_CLASS_RT, 4);\n\t\treturn;\n\t}\n\n\t \n\tprio = max_t(u16, bio->bi_ioprio,\n\t\t\tIOPRIO_PRIO_VALUE(blkcg->prio_policy, 0));\n\tif (prio > bio->bi_ioprio)\n\t\tbio->bi_ioprio = prio;\n}\n\nvoid blk_ioprio_exit(struct gendisk *disk)\n{\n\tblkcg_deactivate_policy(disk, &ioprio_policy);\n}\n\nint blk_ioprio_init(struct gendisk *disk)\n{\n\treturn blkcg_activate_policy(disk, &ioprio_policy);\n}\n\nstatic int __init ioprio_init(void)\n{\n\treturn blkcg_policy_register(&ioprio_policy);\n}\n\nstatic void __exit ioprio_exit(void)\n{\n\tblkcg_policy_unregister(&ioprio_policy);\n}\n\nmodule_init(ioprio_init);\nmodule_exit(ioprio_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}