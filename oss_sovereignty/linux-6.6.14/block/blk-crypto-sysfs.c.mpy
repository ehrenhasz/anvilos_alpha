{
  "module_name": "blk-crypto-sysfs.c",
  "hash_id": "5de7a3baf2aa4a39ca97ec83c155116117f6164cb23df7b2d57983231451fe12",
  "original_prompt": "Ingested from linux-6.6.14/block/blk-crypto-sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/blk-crypto-profile.h>\n\n#include \"blk-crypto-internal.h\"\n\nstruct blk_crypto_kobj {\n\tstruct kobject kobj;\n\tstruct blk_crypto_profile *profile;\n};\n\nstruct blk_crypto_attr {\n\tstruct attribute attr;\n\tssize_t (*show)(struct blk_crypto_profile *profile,\n\t\t\tstruct blk_crypto_attr *attr, char *page);\n};\n\nstatic struct blk_crypto_profile *kobj_to_crypto_profile(struct kobject *kobj)\n{\n\treturn container_of(kobj, struct blk_crypto_kobj, kobj)->profile;\n}\n\nstatic struct blk_crypto_attr *attr_to_crypto_attr(struct attribute *attr)\n{\n\treturn container_of(attr, struct blk_crypto_attr, attr);\n}\n\nstatic ssize_t max_dun_bits_show(struct blk_crypto_profile *profile,\n\t\t\t\t struct blk_crypto_attr *attr, char *page)\n{\n\treturn sysfs_emit(page, \"%u\\n\", 8 * profile->max_dun_bytes_supported);\n}\n\nstatic ssize_t num_keyslots_show(struct blk_crypto_profile *profile,\n\t\t\t\t struct blk_crypto_attr *attr, char *page)\n{\n\treturn sysfs_emit(page, \"%u\\n\", profile->num_slots);\n}\n\n#define BLK_CRYPTO_RO_ATTR(_name) \\\n\tstatic struct blk_crypto_attr _name##_attr = __ATTR_RO(_name)\n\nBLK_CRYPTO_RO_ATTR(max_dun_bits);\nBLK_CRYPTO_RO_ATTR(num_keyslots);\n\nstatic struct attribute *blk_crypto_attrs[] = {\n\t&max_dun_bits_attr.attr,\n\t&num_keyslots_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group blk_crypto_attr_group = {\n\t.attrs = blk_crypto_attrs,\n};\n\n \nstatic struct blk_crypto_attr __blk_crypto_mode_attrs[BLK_ENCRYPTION_MODE_MAX];\nstatic struct attribute *blk_crypto_mode_attrs[BLK_ENCRYPTION_MODE_MAX + 1];\n\nstatic umode_t blk_crypto_mode_is_visible(struct kobject *kobj,\n\t\t\t\t\t  struct attribute *attr, int n)\n{\n\tstruct blk_crypto_profile *profile = kobj_to_crypto_profile(kobj);\n\tstruct blk_crypto_attr *a = attr_to_crypto_attr(attr);\n\tint mode_num = a - __blk_crypto_mode_attrs;\n\n\tif (profile->modes_supported[mode_num])\n\t\treturn 0444;\n\treturn 0;\n}\n\nstatic ssize_t blk_crypto_mode_show(struct blk_crypto_profile *profile,\n\t\t\t\t    struct blk_crypto_attr *attr, char *page)\n{\n\tint mode_num = attr - __blk_crypto_mode_attrs;\n\n\treturn sysfs_emit(page, \"0x%x\\n\", profile->modes_supported[mode_num]);\n}\n\nstatic const struct attribute_group blk_crypto_modes_attr_group = {\n\t.name = \"modes\",\n\t.attrs = blk_crypto_mode_attrs,\n\t.is_visible = blk_crypto_mode_is_visible,\n};\n\nstatic const struct attribute_group *blk_crypto_attr_groups[] = {\n\t&blk_crypto_attr_group,\n\t&blk_crypto_modes_attr_group,\n\tNULL,\n};\n\nstatic ssize_t blk_crypto_attr_show(struct kobject *kobj,\n\t\t\t\t    struct attribute *attr, char *page)\n{\n\tstruct blk_crypto_profile *profile = kobj_to_crypto_profile(kobj);\n\tstruct blk_crypto_attr *a = attr_to_crypto_attr(attr);\n\n\treturn a->show(profile, a, page);\n}\n\nstatic const struct sysfs_ops blk_crypto_attr_ops = {\n\t.show = blk_crypto_attr_show,\n};\n\nstatic void blk_crypto_release(struct kobject *kobj)\n{\n\tkfree(container_of(kobj, struct blk_crypto_kobj, kobj));\n}\n\nstatic const struct kobj_type blk_crypto_ktype = {\n\t.default_groups = blk_crypto_attr_groups,\n\t.sysfs_ops\t= &blk_crypto_attr_ops,\n\t.release\t= blk_crypto_release,\n};\n\n \nint blk_crypto_sysfs_register(struct gendisk *disk)\n{\n\tstruct request_queue *q = disk->queue;\n\tstruct blk_crypto_kobj *obj;\n\tint err;\n\n\tif (!q->crypto_profile)\n\t\treturn 0;\n\n\tobj = kzalloc(sizeof(*obj), GFP_KERNEL);\n\tif (!obj)\n\t\treturn -ENOMEM;\n\tobj->profile = q->crypto_profile;\n\n\terr = kobject_init_and_add(&obj->kobj, &blk_crypto_ktype,\n\t\t\t\t   &disk->queue_kobj, \"crypto\");\n\tif (err) {\n\t\tkobject_put(&obj->kobj);\n\t\treturn err;\n\t}\n\tq->crypto_kobject = &obj->kobj;\n\treturn 0;\n}\n\nvoid blk_crypto_sysfs_unregister(struct gendisk *disk)\n{\n\tkobject_put(disk->queue->crypto_kobject);\n}\n\nstatic int __init blk_crypto_sysfs_init(void)\n{\n\tint i;\n\n\tBUILD_BUG_ON(BLK_ENCRYPTION_MODE_INVALID != 0);\n\tfor (i = 1; i < BLK_ENCRYPTION_MODE_MAX; i++) {\n\t\tstruct blk_crypto_attr *attr = &__blk_crypto_mode_attrs[i];\n\n\t\tattr->attr.name = blk_crypto_modes[i].name;\n\t\tattr->attr.mode = 0444;\n\t\tattr->show = blk_crypto_mode_show;\n\t\tblk_crypto_mode_attrs[i - 1] = &attr->attr;\n\t}\n\treturn 0;\n}\nsubsys_initcall(blk_crypto_sysfs_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}