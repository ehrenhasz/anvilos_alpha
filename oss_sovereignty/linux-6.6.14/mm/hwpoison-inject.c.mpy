{
  "module_name": "hwpoison-inject.c",
  "hash_id": "4ba1fe8fb06c0aa0271dd8920400a84aa8f8f0f10581d8015328d37efac69065",
  "original_prompt": "Ingested from linux-6.6.14/mm/hwpoison-inject.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/debugfs.h>\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/swap.h>\n#include <linux/pagemap.h>\n#include <linux/hugetlb.h>\n#include \"internal.h\"\n\nstatic struct dentry *hwpoison_dir;\n\nstatic int hwpoison_inject(void *data, u64 val)\n{\n\tunsigned long pfn = val;\n\tstruct page *p;\n\tstruct page *hpage;\n\tint err;\n\n\tif (!capable(CAP_SYS_ADMIN))\n\t\treturn -EPERM;\n\n\tif (!pfn_valid(pfn))\n\t\treturn -ENXIO;\n\n\tp = pfn_to_page(pfn);\n\thpage = compound_head(p);\n\n\tif (!hwpoison_filter_enable)\n\t\tgoto inject;\n\n\tshake_page(hpage);\n\t \n\tif (!PageLRU(hpage) && !PageHuge(p) && !is_free_buddy_page(p))\n\t\treturn 0;\n\n\t \n\terr = hwpoison_filter(hpage);\n\tif (err)\n\t\treturn 0;\n\ninject:\n\tpr_info(\"Injecting memory failure at pfn %#lx\\n\", pfn);\n\terr = memory_failure(pfn, MF_SW_SIMULATED);\n\treturn (err == -EOPNOTSUPP) ? 0 : err;\n}\n\nstatic int hwpoison_unpoison(void *data, u64 val)\n{\n\tif (!capable(CAP_SYS_ADMIN))\n\t\treturn -EPERM;\n\n\treturn unpoison_memory(val);\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(hwpoison_fops, NULL, hwpoison_inject, \"%lli\\n\");\nDEFINE_DEBUGFS_ATTRIBUTE(unpoison_fops, NULL, hwpoison_unpoison, \"%lli\\n\");\n\nstatic void __exit pfn_inject_exit(void)\n{\n\thwpoison_filter_enable = 0;\n\tdebugfs_remove_recursive(hwpoison_dir);\n}\n\nstatic int __init pfn_inject_init(void)\n{\n\thwpoison_dir = debugfs_create_dir(\"hwpoison\", NULL);\n\n\t \n\tdebugfs_create_file(\"corrupt-pfn\", 0200, hwpoison_dir, NULL,\n\t\t\t    &hwpoison_fops);\n\n\tdebugfs_create_file(\"unpoison-pfn\", 0200, hwpoison_dir, NULL,\n\t\t\t    &unpoison_fops);\n\n\tdebugfs_create_u32(\"corrupt-filter-enable\", 0600, hwpoison_dir,\n\t\t\t   &hwpoison_filter_enable);\n\n\tdebugfs_create_u32(\"corrupt-filter-dev-major\", 0600, hwpoison_dir,\n\t\t\t   &hwpoison_filter_dev_major);\n\n\tdebugfs_create_u32(\"corrupt-filter-dev-minor\", 0600, hwpoison_dir,\n\t\t\t   &hwpoison_filter_dev_minor);\n\n\tdebugfs_create_u64(\"corrupt-filter-flags-mask\", 0600, hwpoison_dir,\n\t\t\t   &hwpoison_filter_flags_mask);\n\n\tdebugfs_create_u64(\"corrupt-filter-flags-value\", 0600, hwpoison_dir,\n\t\t\t   &hwpoison_filter_flags_value);\n\n#ifdef CONFIG_MEMCG\n\tdebugfs_create_u64(\"corrupt-filter-memcg\", 0600, hwpoison_dir,\n\t\t\t   &hwpoison_filter_memcg);\n#endif\n\n\treturn 0;\n}\n\nmodule_init(pfn_inject_init);\nmodule_exit(pfn_inject_exit);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}