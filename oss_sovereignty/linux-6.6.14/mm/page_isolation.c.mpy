{
  "module_name": "page_isolation.c",
  "hash_id": "a1575456840a542f79136543b1b0baefa7ce6753f10da71a5b1bf9e71427b911",
  "original_prompt": "Ingested from linux-6.6.14/mm/page_isolation.c",
  "human_readable_source": "\n \n\n#include <linux/mm.h>\n#include <linux/page-isolation.h>\n#include <linux/pageblock-flags.h>\n#include <linux/memory.h>\n#include <linux/hugetlb.h>\n#include <linux/page_owner.h>\n#include <linux/migrate.h>\n#include \"internal.h\"\n\n#define CREATE_TRACE_POINTS\n#include <trace/events/page_isolation.h>\n\n \nstatic struct page *has_unmovable_pages(unsigned long start_pfn, unsigned long end_pfn,\n\t\t\t\tint migratetype, int flags)\n{\n\tstruct page *page = pfn_to_page(start_pfn);\n\tstruct zone *zone = page_zone(page);\n\tunsigned long pfn;\n\n\tVM_BUG_ON(pageblock_start_pfn(start_pfn) !=\n\t\t  pageblock_start_pfn(end_pfn - 1));\n\n\tif (is_migrate_cma_page(page)) {\n\t\t \n\t\tif (is_migrate_cma(migratetype))\n\t\t\treturn NULL;\n\n\t\treturn page;\n\t}\n\n\tfor (pfn = start_pfn; pfn < end_pfn; pfn++) {\n\t\tpage = pfn_to_page(pfn);\n\n\t\t \n\t\tif (PageReserved(page))\n\t\t\treturn page;\n\n\t\t \n\t\tif (zone_idx(zone) == ZONE_MOVABLE)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (PageHuge(page) || PageTransCompound(page)) {\n\t\t\tstruct folio *folio = page_folio(page);\n\t\t\tunsigned int skip_pages;\n\n\t\t\tif (PageHuge(page)) {\n\t\t\t\tif (!hugepage_migration_supported(folio_hstate(folio)))\n\t\t\t\t\treturn page;\n\t\t\t} else if (!folio_test_lru(folio) && !__folio_test_movable(folio)) {\n\t\t\t\treturn page;\n\t\t\t}\n\n\t\t\tskip_pages = folio_nr_pages(folio) - folio_page_idx(folio, page);\n\t\t\tpfn += skip_pages - 1;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (!page_ref_count(page)) {\n\t\t\tif (PageBuddy(page))\n\t\t\t\tpfn += (1 << buddy_order(page)) - 1;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif ((flags & MEMORY_OFFLINE) && PageHWPoison(page))\n\t\t\tcontinue;\n\n\t\t \n\t\tif ((flags & MEMORY_OFFLINE) && PageOffline(page))\n\t\t\tcontinue;\n\n\t\tif (__PageMovable(page) || PageLRU(page))\n\t\t\tcontinue;\n\n\t\t \n\t\treturn page;\n\t}\n\treturn NULL;\n}\n\n \nstatic int set_migratetype_isolate(struct page *page, int migratetype, int isol_flags,\n\t\t\tunsigned long start_pfn, unsigned long end_pfn)\n{\n\tstruct zone *zone = page_zone(page);\n\tstruct page *unmovable;\n\tunsigned long flags;\n\tunsigned long check_unmovable_start, check_unmovable_end;\n\n\tspin_lock_irqsave(&zone->lock, flags);\n\n\t \n\tif (is_migrate_isolate_page(page)) {\n\t\tspin_unlock_irqrestore(&zone->lock, flags);\n\t\treturn -EBUSY;\n\t}\n\n\t \n\tcheck_unmovable_start = max(page_to_pfn(page), start_pfn);\n\tcheck_unmovable_end = min(pageblock_end_pfn(page_to_pfn(page)),\n\t\t\t\t  end_pfn);\n\n\tunmovable = has_unmovable_pages(check_unmovable_start, check_unmovable_end,\n\t\t\tmigratetype, isol_flags);\n\tif (!unmovable) {\n\t\tunsigned long nr_pages;\n\t\tint mt = get_pageblock_migratetype(page);\n\n\t\tset_pageblock_migratetype(page, MIGRATE_ISOLATE);\n\t\tzone->nr_isolate_pageblock++;\n\t\tnr_pages = move_freepages_block(zone, page, MIGRATE_ISOLATE,\n\t\t\t\t\t\t\t\t\tNULL);\n\n\t\t__mod_zone_freepage_state(zone, -nr_pages, mt);\n\t\tspin_unlock_irqrestore(&zone->lock, flags);\n\t\treturn 0;\n\t}\n\n\tspin_unlock_irqrestore(&zone->lock, flags);\n\tif (isol_flags & REPORT_FAILURE) {\n\t\t \n\t\tdump_page(unmovable, \"unmovable page\");\n\t}\n\n\treturn -EBUSY;\n}\n\nstatic void unset_migratetype_isolate(struct page *page, int migratetype)\n{\n\tstruct zone *zone;\n\tunsigned long flags, nr_pages;\n\tbool isolated_page = false;\n\tunsigned int order;\n\tstruct page *buddy;\n\n\tzone = page_zone(page);\n\tspin_lock_irqsave(&zone->lock, flags);\n\tif (!is_migrate_isolate_page(page))\n\t\tgoto out;\n\n\t \n\tif (PageBuddy(page)) {\n\t\torder = buddy_order(page);\n\t\tif (order >= pageblock_order && order < MAX_ORDER) {\n\t\t\tbuddy = find_buddy_page_pfn(page, page_to_pfn(page),\n\t\t\t\t\t\t    order, NULL);\n\t\t\tif (buddy && !is_migrate_isolate_page(buddy)) {\n\t\t\t\tisolated_page = !!__isolate_free_page(page, order);\n\t\t\t\t \n\t\t\t\tVM_WARN_ON(!isolated_page);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tif (!isolated_page) {\n\t\tnr_pages = move_freepages_block(zone, page, migratetype, NULL);\n\t\t__mod_zone_freepage_state(zone, nr_pages, migratetype);\n\t}\n\tset_pageblock_migratetype(page, migratetype);\n\tif (isolated_page)\n\t\t__putback_isolated_page(page, order, migratetype);\n\tzone->nr_isolate_pageblock--;\nout:\n\tspin_unlock_irqrestore(&zone->lock, flags);\n}\n\nstatic inline struct page *\n__first_valid_page(unsigned long pfn, unsigned long nr_pages)\n{\n\tint i;\n\n\tfor (i = 0; i < nr_pages; i++) {\n\t\tstruct page *page;\n\n\t\tpage = pfn_to_online_page(pfn + i);\n\t\tif (!page)\n\t\t\tcontinue;\n\t\treturn page;\n\t}\n\treturn NULL;\n}\n\n \nstatic int isolate_single_pageblock(unsigned long boundary_pfn, int flags,\n\t\t\tgfp_t gfp_flags, bool isolate_before, bool skip_isolation,\n\t\t\tint migratetype)\n{\n\tunsigned long start_pfn;\n\tunsigned long isolate_pageblock;\n\tunsigned long pfn;\n\tstruct zone *zone;\n\tint ret;\n\n\tVM_BUG_ON(!pageblock_aligned(boundary_pfn));\n\n\tif (isolate_before)\n\t\tisolate_pageblock = boundary_pfn - pageblock_nr_pages;\n\telse\n\t\tisolate_pageblock = boundary_pfn;\n\n\t \n\tzone  = page_zone(pfn_to_page(isolate_pageblock));\n\tstart_pfn  = max(ALIGN_DOWN(isolate_pageblock, MAX_ORDER_NR_PAGES),\n\t\t\t\t      zone->zone_start_pfn);\n\n\tif (skip_isolation) {\n\t\tint mt __maybe_unused = get_pageblock_migratetype(pfn_to_page(isolate_pageblock));\n\n\t\tVM_BUG_ON(!is_migrate_isolate(mt));\n\t} else {\n\t\tret = set_migratetype_isolate(pfn_to_page(isolate_pageblock), migratetype,\n\t\t\t\tflags, isolate_pageblock, isolate_pageblock + pageblock_nr_pages);\n\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (isolate_before) {\n\t\tif (!pfn_to_online_page(boundary_pfn))\n\t\t\treturn 0;\n\t} else {\n\t\tif (!pfn_to_online_page(boundary_pfn - 1))\n\t\t\treturn 0;\n\t}\n\n\tfor (pfn = start_pfn; pfn < boundary_pfn;) {\n\t\tstruct page *page = __first_valid_page(pfn, boundary_pfn - pfn);\n\n\t\tVM_BUG_ON(!page);\n\t\tpfn = page_to_pfn(page);\n\t\t \n\t\tif (PageBuddy(page)) {\n\t\t\tint order = buddy_order(page);\n\n\t\t\tif (pfn + (1UL << order) > boundary_pfn) {\n\t\t\t\t \n\t\t\t\tif (split_free_page(page, order, boundary_pfn - pfn))\n\t\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tpfn += 1UL << order;\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (PageCompound(page)) {\n\t\t\tstruct page *head = compound_head(page);\n\t\t\tunsigned long head_pfn = page_to_pfn(head);\n\t\t\tunsigned long nr_pages = compound_nr(head);\n\n\t\t\tif (head_pfn + nr_pages <= boundary_pfn) {\n\t\t\t\tpfn = head_pfn + nr_pages;\n\t\t\t\tcontinue;\n\t\t\t}\n#if defined CONFIG_COMPACTION || defined CONFIG_CMA\n\t\t\t \n\t\t\tif (PageHuge(page) || PageLRU(page) || __PageMovable(page)) {\n\t\t\t\tint order;\n\t\t\t\tunsigned long outer_pfn;\n\t\t\t\tint page_mt = get_pageblock_migratetype(page);\n\t\t\t\tbool isolate_page = !is_migrate_isolate_page(page);\n\t\t\t\tstruct compact_control cc = {\n\t\t\t\t\t.nr_migratepages = 0,\n\t\t\t\t\t.order = -1,\n\t\t\t\t\t.zone = page_zone(pfn_to_page(head_pfn)),\n\t\t\t\t\t.mode = MIGRATE_SYNC,\n\t\t\t\t\t.ignore_skip_hint = true,\n\t\t\t\t\t.no_set_skip_hint = true,\n\t\t\t\t\t.gfp_mask = gfp_flags,\n\t\t\t\t\t.alloc_contig = true,\n\t\t\t\t};\n\t\t\t\tINIT_LIST_HEAD(&cc.migratepages);\n\n\t\t\t\t \n\t\t\t\tif (isolate_page) {\n\t\t\t\t\tret = set_migratetype_isolate(page, page_mt,\n\t\t\t\t\t\tflags, head_pfn, head_pfn + nr_pages);\n\t\t\t\t\tif (ret)\n\t\t\t\t\t\tgoto failed;\n\t\t\t\t}\n\n\t\t\t\tret = __alloc_contig_migrate_range(&cc, head_pfn,\n\t\t\t\t\t\t\thead_pfn + nr_pages);\n\n\t\t\t\t \n\t\t\t\tif (isolate_page)\n\t\t\t\t\tunset_migratetype_isolate(page, page_mt);\n\n\t\t\t\tif (ret)\n\t\t\t\t\tgoto failed;\n\t\t\t\t \n\t\t\t\torder = 0;\n\t\t\t\touter_pfn = pfn;\n\t\t\t\twhile (!PageBuddy(pfn_to_page(outer_pfn))) {\n\t\t\t\t\t \n\t\t\t\t\tif (++order > MAX_ORDER)\n\t\t\t\t\t\tgoto failed;\n\t\t\t\t\touter_pfn &= ~0UL << order;\n\t\t\t\t}\n\t\t\t\tpfn = outer_pfn;\n\t\t\t\tcontinue;\n\t\t\t} else\n#endif\n\t\t\t\tgoto failed;\n\t\t}\n\n\t\tpfn++;\n\t}\n\treturn 0;\nfailed:\n\t \n\tif (!skip_isolation)\n\t\tunset_migratetype_isolate(pfn_to_page(isolate_pageblock), migratetype);\n\treturn -EBUSY;\n}\n\n \nint start_isolate_page_range(unsigned long start_pfn, unsigned long end_pfn,\n\t\t\t     int migratetype, int flags, gfp_t gfp_flags)\n{\n\tunsigned long pfn;\n\tstruct page *page;\n\t \n\tunsigned long isolate_start = pageblock_start_pfn(start_pfn);\n\tunsigned long isolate_end = pageblock_align(end_pfn);\n\tint ret;\n\tbool skip_isolation = false;\n\n\t \n\tret = isolate_single_pageblock(isolate_start, flags, gfp_flags, false,\n\t\t\tskip_isolation, migratetype);\n\tif (ret)\n\t\treturn ret;\n\n\tif (isolate_start == isolate_end - pageblock_nr_pages)\n\t\tskip_isolation = true;\n\n\t \n\tret = isolate_single_pageblock(isolate_end, flags, gfp_flags, true,\n\t\t\tskip_isolation, migratetype);\n\tif (ret) {\n\t\tunset_migratetype_isolate(pfn_to_page(isolate_start), migratetype);\n\t\treturn ret;\n\t}\n\n\t \n\tfor (pfn = isolate_start + pageblock_nr_pages;\n\t     pfn < isolate_end - pageblock_nr_pages;\n\t     pfn += pageblock_nr_pages) {\n\t\tpage = __first_valid_page(pfn, pageblock_nr_pages);\n\t\tif (page && set_migratetype_isolate(page, migratetype, flags,\n\t\t\t\t\tstart_pfn, end_pfn)) {\n\t\t\tundo_isolate_page_range(isolate_start, pfn, migratetype);\n\t\t\tunset_migratetype_isolate(\n\t\t\t\tpfn_to_page(isolate_end - pageblock_nr_pages),\n\t\t\t\tmigratetype);\n\t\t\treturn -EBUSY;\n\t\t}\n\t}\n\treturn 0;\n}\n\n \nvoid undo_isolate_page_range(unsigned long start_pfn, unsigned long end_pfn,\n\t\t\t    int migratetype)\n{\n\tunsigned long pfn;\n\tstruct page *page;\n\tunsigned long isolate_start = pageblock_start_pfn(start_pfn);\n\tunsigned long isolate_end = pageblock_align(end_pfn);\n\n\tfor (pfn = isolate_start;\n\t     pfn < isolate_end;\n\t     pfn += pageblock_nr_pages) {\n\t\tpage = __first_valid_page(pfn, pageblock_nr_pages);\n\t\tif (!page || !is_migrate_isolate_page(page))\n\t\t\tcontinue;\n\t\tunset_migratetype_isolate(page, migratetype);\n\t}\n}\n \nstatic unsigned long\n__test_page_isolated_in_pageblock(unsigned long pfn, unsigned long end_pfn,\n\t\t\t\t  int flags)\n{\n\tstruct page *page;\n\n\twhile (pfn < end_pfn) {\n\t\tpage = pfn_to_page(pfn);\n\t\tif (PageBuddy(page))\n\t\t\t \n\t\t\tpfn += 1 << buddy_order(page);\n\t\telse if ((flags & MEMORY_OFFLINE) && PageHWPoison(page))\n\t\t\t \n\t\t\tpfn++;\n\t\telse if ((flags & MEMORY_OFFLINE) && PageOffline(page) &&\n\t\t\t !page_count(page))\n\t\t\t \n\t\t\tpfn++;\n\t\telse\n\t\t\tbreak;\n\t}\n\n\treturn pfn;\n}\n\n \nint test_pages_isolated(unsigned long start_pfn, unsigned long end_pfn,\n\t\t\tint isol_flags)\n{\n\tunsigned long pfn, flags;\n\tstruct page *page;\n\tstruct zone *zone;\n\tint ret;\n\n\t \n\tfor (pfn = start_pfn; pfn < end_pfn; pfn += pageblock_nr_pages) {\n\t\tpage = __first_valid_page(pfn, pageblock_nr_pages);\n\t\tif (page && !is_migrate_isolate_page(page))\n\t\t\tbreak;\n\t}\n\tpage = __first_valid_page(start_pfn, end_pfn - start_pfn);\n\tif ((pfn < end_pfn) || !page) {\n\t\tret = -EBUSY;\n\t\tgoto out;\n\t}\n\n\t \n\tzone = page_zone(page);\n\tspin_lock_irqsave(&zone->lock, flags);\n\tpfn = __test_page_isolated_in_pageblock(start_pfn, end_pfn, isol_flags);\n\tspin_unlock_irqrestore(&zone->lock, flags);\n\n\tret = pfn < end_pfn ? -EBUSY : 0;\n\nout:\n\ttrace_test_pages_isolated(start_pfn, end_pfn, pfn);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}