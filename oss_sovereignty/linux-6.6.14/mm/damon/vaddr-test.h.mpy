{
  "module_name": "vaddr-test.h",
  "hash_id": "f8edf6db305700f6a98c02e685df9ba938d60f99fdc488d59eb8652e9681a670",
  "original_prompt": "Ingested from linux-6.6.14/mm/damon/vaddr-test.h",
  "human_readable_source": " \n \n\n#ifdef CONFIG_DAMON_VADDR_KUNIT_TEST\n\n#ifndef _DAMON_VADDR_TEST_H\n#define _DAMON_VADDR_TEST_H\n\n#include <kunit/test.h>\n\nstatic int __link_vmas(struct maple_tree *mt, struct vm_area_struct *vmas,\n\t\t\tssize_t nr_vmas)\n{\n\tint i, ret = -ENOMEM;\n\tMA_STATE(mas, mt, 0, 0);\n\n\tif (!nr_vmas)\n\t\treturn 0;\n\n\tmas_lock(&mas);\n\tfor (i = 0; i < nr_vmas; i++) {\n\t\tmas_set_range(&mas, vmas[i].vm_start, vmas[i].vm_end - 1);\n\t\tif (mas_store_gfp(&mas, &vmas[i], GFP_KERNEL))\n\t\t\tgoto failed;\n\t}\n\n\tret = 0;\nfailed:\n\tmas_unlock(&mas);\n\treturn ret;\n}\n\n \nstatic void damon_test_three_regions_in_vmas(struct kunit *test)\n{\n\tstatic struct mm_struct mm;\n\tstruct damon_addr_range regions[3] = {0,};\n\t \n\tstruct vm_area_struct vmas[] = {\n\t\t(struct vm_area_struct) {.vm_start = 10, .vm_end = 20},\n\t\t(struct vm_area_struct) {.vm_start = 20, .vm_end = 25},\n\t\t(struct vm_area_struct) {.vm_start = 200, .vm_end = 210},\n\t\t(struct vm_area_struct) {.vm_start = 210, .vm_end = 220},\n\t\t(struct vm_area_struct) {.vm_start = 300, .vm_end = 305},\n\t\t(struct vm_area_struct) {.vm_start = 307, .vm_end = 330},\n\t};\n\n\tmt_init_flags(&mm.mm_mt, MM_MT_FLAGS);\n\tif (__link_vmas(&mm.mm_mt, vmas, ARRAY_SIZE(vmas)))\n\t\tkunit_skip(test, \"Failed to create VMA tree\");\n\n\t__damon_va_three_regions(&mm, regions);\n\n\tKUNIT_EXPECT_EQ(test, 10ul, regions[0].start);\n\tKUNIT_EXPECT_EQ(test, 25ul, regions[0].end);\n\tKUNIT_EXPECT_EQ(test, 200ul, regions[1].start);\n\tKUNIT_EXPECT_EQ(test, 220ul, regions[1].end);\n\tKUNIT_EXPECT_EQ(test, 300ul, regions[2].start);\n\tKUNIT_EXPECT_EQ(test, 330ul, regions[2].end);\n}\n\nstatic struct damon_region *__nth_region_of(struct damon_target *t, int idx)\n{\n\tstruct damon_region *r;\n\tunsigned int i = 0;\n\n\tdamon_for_each_region(r, t) {\n\t\tif (i++ == idx)\n\t\t\treturn r;\n\t}\n\n\treturn NULL;\n}\n\n \nstatic void damon_do_test_apply_three_regions(struct kunit *test,\n\t\t\t\tunsigned long *regions, int nr_regions,\n\t\t\t\tstruct damon_addr_range *three_regions,\n\t\t\t\tunsigned long *expected, int nr_expected)\n{\n\tstruct damon_target *t;\n\tstruct damon_region *r;\n\tint i;\n\n\tt = damon_new_target();\n\tfor (i = 0; i < nr_regions / 2; i++) {\n\t\tr = damon_new_region(regions[i * 2], regions[i * 2 + 1]);\n\t\tdamon_add_region(r, t);\n\t}\n\n\tdamon_set_regions(t, three_regions, 3);\n\n\tfor (i = 0; i < nr_expected / 2; i++) {\n\t\tr = __nth_region_of(t, i);\n\t\tKUNIT_EXPECT_EQ(test, r->ar.start, expected[i * 2]);\n\t\tKUNIT_EXPECT_EQ(test, r->ar.end, expected[i * 2 + 1]);\n\t}\n\n\tdamon_destroy_target(t);\n}\n\n \nstatic void damon_test_apply_three_regions1(struct kunit *test)\n{\n\t \n\tunsigned long regions[] = {10, 20, 20, 30, 50, 55, 55, 57, 57, 59,\n\t\t\t\t70, 80, 80, 90, 90, 100};\n\t \n\tstruct damon_addr_range new_three_regions[3] = {\n\t\t(struct damon_addr_range){.start = 5, .end = 27},\n\t\t(struct damon_addr_range){.start = 45, .end = 55},\n\t\t(struct damon_addr_range){.start = 73, .end = 104} };\n\t \n\tunsigned long expected[] = {5, 20, 20, 27, 45, 55,\n\t\t\t\t73, 80, 80, 90, 90, 104};\n\n\tdamon_do_test_apply_three_regions(test, regions, ARRAY_SIZE(regions),\n\t\t\tnew_three_regions, expected, ARRAY_SIZE(expected));\n}\n\n \nstatic void damon_test_apply_three_regions2(struct kunit *test)\n{\n\t \n\tunsigned long regions[] = {10, 20, 20, 30, 50, 55, 55, 57, 57, 59,\n\t\t\t\t70, 80, 80, 90, 90, 100};\n\t \n\tstruct damon_addr_range new_three_regions[3] = {\n\t\t(struct damon_addr_range){.start = 5, .end = 27},\n\t\t(struct damon_addr_range){.start = 56, .end = 57},\n\t\t(struct damon_addr_range){.start = 65, .end = 104} };\n\t \n\tunsigned long expected[] = {5, 20, 20, 27, 56, 57,\n\t\t\t\t65, 80, 80, 90, 90, 104};\n\n\tdamon_do_test_apply_three_regions(test, regions, ARRAY_SIZE(regions),\n\t\t\tnew_three_regions, expected, ARRAY_SIZE(expected));\n}\n\n \nstatic void damon_test_apply_three_regions3(struct kunit *test)\n{\n\t \n\tunsigned long regions[] = {10, 20, 20, 30, 50, 55, 55, 57, 57, 59,\n\t\t\t\t70, 80, 80, 90, 90, 100};\n\t \n\tstruct damon_addr_range new_three_regions[3] = {\n\t\t(struct damon_addr_range){.start = 5, .end = 27},\n\t\t(struct damon_addr_range){.start = 61, .end = 63},\n\t\t(struct damon_addr_range){.start = 65, .end = 104} };\n\t \n\tunsigned long expected[] = {5, 20, 20, 27, 61, 63,\n\t\t\t\t65, 80, 80, 90, 90, 104};\n\n\tdamon_do_test_apply_three_regions(test, regions, ARRAY_SIZE(regions),\n\t\t\tnew_three_regions, expected, ARRAY_SIZE(expected));\n}\n\n \nstatic void damon_test_apply_three_regions4(struct kunit *test)\n{\n\t \n\tunsigned long regions[] = {10, 20, 20, 30, 50, 55, 55, 57, 57, 59,\n\t\t\t\t70, 80, 80, 90, 90, 100};\n\t \n\tstruct damon_addr_range new_three_regions[3] = {\n\t\t(struct damon_addr_range){.start = 5, .end = 7},\n\t\t(struct damon_addr_range){.start = 30, .end = 32},\n\t\t(struct damon_addr_range){.start = 65, .end = 68} };\n\t \n\tunsigned long expected[] = {5, 7, 30, 32, 65, 68};\n\n\tdamon_do_test_apply_three_regions(test, regions, ARRAY_SIZE(regions),\n\t\t\tnew_three_regions, expected, ARRAY_SIZE(expected));\n}\n\nstatic void damon_test_split_evenly_fail(struct kunit *test,\n\t\tunsigned long start, unsigned long end, unsigned int nr_pieces)\n{\n\tstruct damon_target *t = damon_new_target();\n\tstruct damon_region *r = damon_new_region(start, end);\n\n\tdamon_add_region(r, t);\n\tKUNIT_EXPECT_EQ(test,\n\t\t\tdamon_va_evenly_split_region(t, r, nr_pieces), -EINVAL);\n\tKUNIT_EXPECT_EQ(test, damon_nr_regions(t), 1u);\n\n\tdamon_for_each_region(r, t) {\n\t\tKUNIT_EXPECT_EQ(test, r->ar.start, start);\n\t\tKUNIT_EXPECT_EQ(test, r->ar.end, end);\n\t}\n\n\tdamon_free_target(t);\n}\n\nstatic void damon_test_split_evenly_succ(struct kunit *test,\n\tunsigned long start, unsigned long end, unsigned int nr_pieces)\n{\n\tstruct damon_target *t = damon_new_target();\n\tstruct damon_region *r = damon_new_region(start, end);\n\tunsigned long expected_width = (end - start) / nr_pieces;\n\tunsigned long i = 0;\n\n\tdamon_add_region(r, t);\n\tKUNIT_EXPECT_EQ(test,\n\t\t\tdamon_va_evenly_split_region(t, r, nr_pieces), 0);\n\tKUNIT_EXPECT_EQ(test, damon_nr_regions(t), nr_pieces);\n\n\tdamon_for_each_region(r, t) {\n\t\tif (i == nr_pieces - 1) {\n\t\t\tKUNIT_EXPECT_EQ(test,\n\t\t\t\tr->ar.start, start + i * expected_width);\n\t\t\tKUNIT_EXPECT_EQ(test, r->ar.end, end);\n\t\t\tbreak;\n\t\t}\n\t\tKUNIT_EXPECT_EQ(test,\n\t\t\t\tr->ar.start, start + i++ * expected_width);\n\t\tKUNIT_EXPECT_EQ(test, r->ar.end, start + i * expected_width);\n\t}\n\tdamon_free_target(t);\n}\n\nstatic void damon_test_split_evenly(struct kunit *test)\n{\n\tKUNIT_EXPECT_EQ(test, damon_va_evenly_split_region(NULL, NULL, 5),\n\t\t\t-EINVAL);\n\n\tdamon_test_split_evenly_fail(test, 0, 100, 0);\n\tdamon_test_split_evenly_succ(test, 0, 100, 10);\n\tdamon_test_split_evenly_succ(test, 5, 59, 5);\n\tdamon_test_split_evenly_fail(test, 5, 6, 2);\n}\n\nstatic struct kunit_case damon_test_cases[] = {\n\tKUNIT_CASE(damon_test_three_regions_in_vmas),\n\tKUNIT_CASE(damon_test_apply_three_regions1),\n\tKUNIT_CASE(damon_test_apply_three_regions2),\n\tKUNIT_CASE(damon_test_apply_three_regions3),\n\tKUNIT_CASE(damon_test_apply_three_regions4),\n\tKUNIT_CASE(damon_test_split_evenly),\n\t{},\n};\n\nstatic struct kunit_suite damon_test_suite = {\n\t.name = \"damon-operations\",\n\t.test_cases = damon_test_cases,\n};\nkunit_test_suite(damon_test_suite);\n\n#endif  \n\n#endif\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}