{
  "module_name": "ops-common.c",
  "hash_id": "c806e0000b3343b861071dd6fde6c7c08a43f0077a150bd57aa08100d9b1d20b",
  "original_prompt": "Ingested from linux-6.6.14/mm/damon/ops-common.c",
  "human_readable_source": "\n \n\n#include <linux/mmu_notifier.h>\n#include <linux/page_idle.h>\n#include <linux/pagemap.h>\n#include <linux/rmap.h>\n\n#include \"ops-common.h\"\n\n \nstruct folio *damon_get_folio(unsigned long pfn)\n{\n\tstruct page *page = pfn_to_online_page(pfn);\n\tstruct folio *folio;\n\n\tif (!page || PageTail(page))\n\t\treturn NULL;\n\n\tfolio = page_folio(page);\n\tif (!folio_test_lru(folio) || !folio_try_get(folio))\n\t\treturn NULL;\n\tif (unlikely(page_folio(page) != folio || !folio_test_lru(folio))) {\n\t\tfolio_put(folio);\n\t\tfolio = NULL;\n\t}\n\treturn folio;\n}\n\nvoid damon_ptep_mkold(pte_t *pte, struct vm_area_struct *vma, unsigned long addr)\n{\n\tstruct folio *folio = damon_get_folio(pte_pfn(ptep_get(pte)));\n\n\tif (!folio)\n\t\treturn;\n\n\tif (ptep_clear_young_notify(vma, addr, pte))\n\t\tfolio_set_young(folio);\n\n\tfolio_set_idle(folio);\n\tfolio_put(folio);\n}\n\nvoid damon_pmdp_mkold(pmd_t *pmd, struct vm_area_struct *vma, unsigned long addr)\n{\n#ifdef CONFIG_TRANSPARENT_HUGEPAGE\n\tstruct folio *folio = damon_get_folio(pmd_pfn(pmdp_get(pmd)));\n\n\tif (!folio)\n\t\treturn;\n\n\tif (pmdp_clear_young_notify(vma, addr, pmd))\n\t\tfolio_set_young(folio);\n\n\tfolio_set_idle(folio);\n\tfolio_put(folio);\n#endif  \n}\n\n#define DAMON_MAX_SUBSCORE\t(100)\n#define DAMON_MAX_AGE_IN_LOG\t(32)\n\nint damon_hot_score(struct damon_ctx *c, struct damon_region *r,\n\t\t\tstruct damos *s)\n{\n\tint freq_subscore;\n\tunsigned int age_in_sec;\n\tint age_in_log, age_subscore;\n\tunsigned int freq_weight = s->quota.weight_nr_accesses;\n\tunsigned int age_weight = s->quota.weight_age;\n\tint hotness;\n\n\tfreq_subscore = r->nr_accesses * DAMON_MAX_SUBSCORE /\n\t\tdamon_max_nr_accesses(&c->attrs);\n\n\tage_in_sec = (unsigned long)r->age * c->attrs.aggr_interval / 1000000;\n\tfor (age_in_log = 0; age_in_log < DAMON_MAX_AGE_IN_LOG && age_in_sec;\n\t\t\tage_in_log++, age_in_sec >>= 1)\n\t\t;\n\n\t \n\tif (freq_subscore == 0)\n\t\tage_in_log *= -1;\n\n\t \n\tage_in_log += DAMON_MAX_AGE_IN_LOG;\n\tage_subscore = age_in_log * DAMON_MAX_SUBSCORE /\n\t\tDAMON_MAX_AGE_IN_LOG / 2;\n\n\thotness = (freq_weight * freq_subscore + age_weight * age_subscore);\n\tif (freq_weight + age_weight)\n\t\thotness /= freq_weight + age_weight;\n\t \n\thotness = hotness * DAMOS_MAX_SCORE / DAMON_MAX_SUBSCORE;\n\n\treturn hotness;\n}\n\nint damon_cold_score(struct damon_ctx *c, struct damon_region *r,\n\t\t\tstruct damos *s)\n{\n\tint hotness = damon_hot_score(c, r, s);\n\n\t \n\treturn DAMOS_MAX_SCORE - hotness;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}