{
  "module_name": "8250_hp300.c",
  "hash_id": "341be0c7408d33839add02aea0362b67116811deb26e0c764ce598a8092f12b5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/tty/serial/8250/8250_hp300.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/string.h>\n#include <linux/kernel.h>\n#include <linux/serial.h>\n#include <linux/serial_8250.h>\n#include <linux/delay.h>\n#include <linux/dio.h>\n#include <linux/console.h>\n#include <linux/slab.h>\n#include <asm/io.h>\n\n#include \"8250.h\"\n\n#if !defined(CONFIG_HPDCA) && !defined(CONFIG_HPAPCI) && !defined(CONFIG_COMPILE_TEST)\n#warning CONFIG_SERIAL_8250 defined but neither CONFIG_HPDCA nor CONFIG_HPAPCI defined, are you sure?\n#endif\n\n#ifdef CONFIG_HPAPCI\nstruct hp300_port {\n\tstruct hp300_port *next;\t \n\tint line;\t\t\t \n};\n\nstatic struct hp300_port *hp300_ports;\n#endif\n\n#ifdef CONFIG_HPDCA\n\nstatic int hpdca_init_one(struct dio_dev *d,\n\t\t\t\t\tconst struct dio_device_id *ent);\nstatic void hpdca_remove_one(struct dio_dev *d);\n\nstatic struct dio_device_id hpdca_dio_tbl[] = {\n\t{ DIO_ID_DCA0 },\n\t{ DIO_ID_DCA0REM },\n\t{ DIO_ID_DCA1 },\n\t{ DIO_ID_DCA1REM },\n\t{ 0 }\n};\n\nstatic struct dio_driver hpdca_driver = {\n\t.name      = \"hpdca\",\n\t.id_table  = hpdca_dio_tbl,\n\t.probe     = hpdca_init_one,\n\t.remove    = hpdca_remove_one,\n};\n\n#endif\n\nstatic unsigned int num_ports;\n\nextern int hp300_uart_scode;\n\n \n#define UART_OFFSET\t17\n\n#define DCA_ID\t\t0x01\t \n#define DCA_IC\t\t0x03\t \n\n \n#define DCA_IC_IE\t0x80\t \n\n#define HPDCA_BAUD_BASE 153600\n\n \n#define FRODO_BASE\t(0x41c000)\n\n \n#define FRODO_APCIBASE\t\t0x0\n#define FRODO_APCISPACE\t\t0x20\n#define FRODO_APCI_OFFSET(x)\t(FRODO_APCIBASE + ((x) * FRODO_APCISPACE))\n\n#define HPAPCI_BAUD_BASE 500400\n\n#ifdef CONFIG_SERIAL_8250_CONSOLE\n \nint __init hp300_setup_serial_console(void)\n{\n\tint scode;\n\tstruct uart_port port;\n\n\tmemset(&port, 0, sizeof(port));\n\n\tif (hp300_uart_scode < 0 || hp300_uart_scode > DIO_SCMAX)\n\t\treturn 0;\n\n\tif (DIO_SCINHOLE(hp300_uart_scode))\n\t\treturn 0;\n\n\tscode = hp300_uart_scode;\n\n\t \n\tport.iotype = UPIO_MEM;\n\tport.flags = UPF_SKIP_TEST | UPF_SHARE_IRQ | UPF_BOOT_AUTOCONF;\n\tport.type = PORT_UNKNOWN;\n\n\t \n\tif (scode == 256) {\n#ifdef CONFIG_HPAPCI\n\t\tpr_info(\"Serial console is HP APCI 1\\n\");\n\n\t\tport.uartclk = HPAPCI_BAUD_BASE * 16;\n\t\tport.mapbase = (FRODO_BASE + FRODO_APCI_OFFSET(1));\n\t\tport.membase = (char *)(port.mapbase + DIO_VIRADDRBASE);\n\t\tport.regshift = 2;\n\t\tadd_preferred_console(\"ttyS\", port.line, \"9600n8\");\n#else\n\t\tpr_warn(\"Serial console is APCI but support is disabled (CONFIG_HPAPCI)!\\n\");\n\t\treturn 0;\n#endif\n\t} else {\n#ifdef CONFIG_HPDCA\n\t\tunsigned long pa = dio_scodetophysaddr(scode);\n\t\tif (!pa)\n\t\t\treturn 0;\n\n\t\tpr_info(\"Serial console is HP DCA at select code %d\\n\", scode);\n\n\t\tport.uartclk = HPDCA_BAUD_BASE * 16;\n\t\tport.mapbase = (pa + UART_OFFSET);\n\t\tport.membase = (char *)(port.mapbase + DIO_VIRADDRBASE);\n\t\tport.regshift = 1;\n\t\tport.irq = DIO_IPL(pa + DIO_VIRADDRBASE);\n\n\t\t \n\t\tout_8(pa + DIO_VIRADDRBASE + DCA_IC, DCA_IC_IE);\n\n\t\tif (DIO_ID(pa + DIO_VIRADDRBASE) & 0x80)\n\t\t\tadd_preferred_console(\"ttyS\", port.line, \"9600n8\");\n#else\n\t\tpr_warn(\"Serial console is DCA but support is disabled (CONFIG_HPDCA)!\\n\");\n\t\treturn 0;\n#endif\n\t}\n\n\tif (early_serial_setup(&port) < 0)\n\t\tpr_warn(\"%s: early_serial_setup() failed.\\n\", __func__);\n\treturn 0;\n}\n#endif  \n\n#ifdef CONFIG_HPDCA\nstatic int hpdca_init_one(struct dio_dev *d,\n\t\t\t\tconst struct dio_device_id *ent)\n{\n\tstruct uart_8250_port uart;\n\tint line;\n\n#ifdef CONFIG_SERIAL_8250_CONSOLE\n\tif (hp300_uart_scode == d->scode) {\n\t\t \n\t\treturn 0;\n\t}\n#endif\n\tmemset(&uart, 0, sizeof(uart));\n\n\t \n\tuart.port.iotype = UPIO_MEM;\n\tuart.port.flags = UPF_SKIP_TEST | UPF_SHARE_IRQ | UPF_BOOT_AUTOCONF;\n\tuart.port.irq = d->ipl;\n\tuart.port.uartclk = HPDCA_BAUD_BASE * 16;\n\tuart.port.mapbase = (d->resource.start + UART_OFFSET);\n\tuart.port.membase = (char *)(uart.port.mapbase + DIO_VIRADDRBASE);\n\tuart.port.regshift = 1;\n\tuart.port.dev = &d->dev;\n\tline = serial8250_register_8250_port(&uart);\n\n\tif (line < 0) {\n\t\tdev_notice(&d->dev,\n\t\t\t  \"8250_hp300: register_serial() DCA scode %d irq %d failed\\n\",\n\t\t\t  d->scode, uart.port.irq);\n\t\treturn -ENOMEM;\n\t}\n\n\t \n\tout_8(d->resource.start + DIO_VIRADDRBASE + DCA_IC, DCA_IC_IE);\n\tdio_set_drvdata(d, (void *)line);\n\n\t \n\tout_8(d->resource.start + DIO_VIRADDRBASE + DCA_ID, 0xff);\n\tudelay(100);\n\n\tnum_ports++;\n\n\treturn 0;\n}\n#endif\n\nstatic int __init hp300_8250_init(void)\n{\n\tstatic int called;\n#ifdef CONFIG_HPAPCI\n\tint line;\n\tunsigned long base;\n\tstruct uart_8250_port uart;\n\tstruct hp300_port *port;\n\tint i;\n#endif\n\tif (called)\n\t\treturn -ENODEV;\n\tcalled = 1;\n\n\tif (!MACH_IS_HP300)\n\t\treturn -ENODEV;\n\n#ifdef CONFIG_HPDCA\n\tdio_register_driver(&hpdca_driver);\n#endif\n#ifdef CONFIG_HPAPCI\n\tif (hp300_model < HP_400) {\n\t\tif (!num_ports)\n\t\t\treturn -ENODEV;\n\t\treturn 0;\n\t}\n\t \n\tfor (i = 1; i < 4; i++) {\n\t\t \n#ifdef CONFIG_SERIAL_8250_CONSOLE\n\t\tif (i == 1)\n\t\t\tcontinue;\n#endif\n\n\t\t \n\t\tport = kmalloc(sizeof(struct hp300_port), GFP_KERNEL);\n\t\tif (!port)\n\t\t\treturn -ENOMEM;\n\n\t\tmemset(&uart, 0, sizeof(uart));\n\n\t\tbase = (FRODO_BASE + FRODO_APCI_OFFSET(i));\n\n\t\t \n\t\tuart.port.iotype = UPIO_MEM;\n\t\tuart.port.flags = UPF_SKIP_TEST | UPF_SHARE_IRQ\n\t\t\t\t| UPF_BOOT_AUTOCONF;\n\t\t \n\t\tuart.port.irq = 0;\n\t\tuart.port.uartclk = HPAPCI_BAUD_BASE * 16;\n\t\tuart.port.mapbase = base;\n\t\tuart.port.membase = (char *)(base + DIO_VIRADDRBASE);\n\t\tuart.port.regshift = 2;\n\n\t\tline = serial8250_register_8250_port(&uart);\n\n\t\tif (line < 0) {\n\t\t\tdev_notice(uart.port.dev,\n\t\t\t\t   \"8250_hp300: register_serial() APCI %d irq %d failed\\n\",\n\t\t\t\t   i, uart.port.irq);\n\t\t\tkfree(port);\n\t\t\tcontinue;\n\t\t}\n\n\t\tport->line = line;\n\t\tport->next = hp300_ports;\n\t\thp300_ports = port;\n\n\t\tnum_ports++;\n\t}\n#endif\n\n\t \n\tif (!num_ports)\n\t\treturn -ENODEV;\n\n\treturn 0;\n}\n\n#ifdef CONFIG_HPDCA\nstatic void hpdca_remove_one(struct dio_dev *d)\n{\n\tint line;\n\n\tline = (int) dio_get_drvdata(d);\n\tif (d->resource.start) {\n\t\t \n\t\tout_8(d->resource.start + DIO_VIRADDRBASE + DCA_IC, 0);\n\t}\n\tserial8250_unregister_port(line);\n}\n#endif\n\nstatic void __exit hp300_8250_exit(void)\n{\n#ifdef CONFIG_HPAPCI\n\tstruct hp300_port *port, *to_free;\n\n\tfor (port = hp300_ports; port; ) {\n\t\tserial8250_unregister_port(port->line);\n\t\tto_free = port;\n\t\tport = port->next;\n\t\tkfree(to_free);\n\t}\n\n\thp300_ports = NULL;\n#endif\n#ifdef CONFIG_HPDCA\n\tdio_unregister_driver(&hpdca_driver);\n#endif\n}\n\nmodule_init(hp300_8250_init);\nmodule_exit(hp300_8250_exit);\nMODULE_DESCRIPTION(\"HP DCA/APCI serial driver\");\nMODULE_AUTHOR(\"Kars de Jong <jongk@linux-m68k.org>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}