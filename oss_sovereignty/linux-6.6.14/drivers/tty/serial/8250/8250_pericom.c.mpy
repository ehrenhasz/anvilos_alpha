{
  "module_name": "8250_pericom.c",
  "hash_id": "d773dba70eb012b0e0e7f9caf8995a0baee94b2dd8ddcbf8a4c75fee4683bba3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/tty/serial/8250/8250_pericom.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/module.h>\n#include <linux/overflow.h>\n#include <linux/pci.h>\n\n#include \"8250.h\"\n\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM_2SDB\t0x1051\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_2S\t0x1053\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM422_4\t0x105a\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM485_4\t0x105b\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM_4SDB\t0x105c\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_4S\t0x105e\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM422_8\t0x106a\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM485_8\t0x106b\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_2DB\t0x1091\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_COM232_2\t0x1093\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_4\t0x1098\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_4DB\t0x1099\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_COM232_4\t0x109b\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_8\t0x10a9\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM_2SMDB\t0x10d1\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_2SM\t0x10d3\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM_4SM\t0x10d9\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM_4SMDB\t0x10da\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_4SM\t0x10dc\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_COM_8SM\t0x10e9\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM485_1\t0x1108\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM422_2\t0x1110\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM485_2\t0x1111\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM422_4\t0x1118\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM485_4\t0x1119\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_2S\t0x1152\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_4S\t0x115a\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_ICM232_2\t0x1190\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM232_2\t0x1191\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_ICM232_4\t0x1198\n#define PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM232_4\t0x1199\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_2SM\t0x11d0\n#define PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_4SM\t0x11d8\n\nstruct pericom8250 {\n\tvoid __iomem *virt;\n\tunsigned int nr;\n\tint line[];\n};\n\nstatic void pericom_do_set_divisor(struct uart_port *port, unsigned int baud,\n\t\t\t\t   unsigned int quot, unsigned int quot_frac)\n{\n\tint scr;\n\n\tfor (scr = 16; scr > 4; scr--) {\n\t\tunsigned int maxrate = port->uartclk / scr;\n\t\tunsigned int divisor = max(maxrate / baud, 1U);\n\t\tint delta = maxrate / divisor - baud;\n\n\t\tif (baud > maxrate + baud / 50)\n\t\t\tcontinue;\n\n\t\tif (delta > baud / 50)\n\t\t\tdivisor++;\n\n\t\tif (divisor > 0xffff)\n\t\t\tcontinue;\n\n\t\t \n\t\tdelta = maxrate / divisor - baud;\n\t\tif (abs(delta) < baud / 50) {\n\t\t\tstruct uart_8250_port *up = up_to_u8250p(port);\n\t\t\tint lcr = serial_port_in(port, UART_LCR);\n\n\t\t\tserial_port_out(port, UART_LCR, lcr | UART_LCR_DLAB);\n\t\t\tserial_dl_write(up, divisor);\n\t\t\tserial_port_out(port, 2, 16 - scr);\n\t\t\tserial_port_out(port, UART_LCR, lcr);\n\t\t\treturn;\n\t\t}\n\t}\n}\n\nstatic int pericom8250_probe(struct pci_dev *pdev, const struct pci_device_id *id)\n{\n\tunsigned int nr, i, bar = 0, maxnr;\n\tstruct pericom8250 *pericom;\n\tstruct uart_8250_port uart;\n\tint ret;\n\n\tret = pcim_enable_device(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tmaxnr = pci_resource_len(pdev, bar) >> 3;\n\n\tif (pdev->vendor == PCI_VENDOR_ID_PERICOM)\n\t\tnr = pdev->device & 0x0f;\n\telse if (pdev->vendor == PCI_VENDOR_ID_ACCESSIO)\n\t\tnr = BIT(((pdev->device & 0x38) >> 3) - 1);\n\telse\n\t\tnr = 1;\n\n\tpericom = devm_kzalloc(&pdev->dev, struct_size(pericom, line, nr), GFP_KERNEL);\n\tif (!pericom)\n\t\treturn -ENOMEM;\n\n\tpericom->virt = pcim_iomap(pdev, bar, 0);\n\tif (!pericom->virt)\n\t\treturn -ENOMEM;\n\n\tmemset(&uart, 0, sizeof(uart));\n\n\tuart.port.dev = &pdev->dev;\n\tuart.port.irq = pdev->irq;\n\tuart.port.private_data = pericom;\n\tuart.port.iotype = UPIO_PORT;\n\tuart.port.uartclk = 921600 * 16;\n\tuart.port.flags = UPF_SKIP_TEST | UPF_BOOT_AUTOCONF | UPF_SHARE_IRQ;\n\tuart.port.set_divisor = pericom_do_set_divisor;\n\tfor (i = 0; i < nr && i < maxnr; i++) {\n\t\tunsigned int offset = (i == 3 && nr == 4) ? 0x38 : i * 0x8;\n\n\t\tuart.port.iobase = pci_resource_start(pdev, bar) + offset;\n\n\t\tdev_dbg(&pdev->dev, \"Setup PCI port: port %lx, irq %d, type %d\\n\",\n\t\t\tuart.port.iobase, uart.port.irq, uart.port.iotype);\n\n\t\tpericom->line[i] = serial8250_register_8250_port(&uart);\n\t\tif (pericom->line[i] < 0) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Couldn't register serial port %lx, irq %d, type %d, error %d\\n\",\n\t\t\t\tuart.port.iobase, uart.port.irq,\n\t\t\t\tuart.port.iotype, pericom->line[i]);\n\t\t\tbreak;\n\t\t}\n\t}\n\tpericom->nr = i;\n\n\tpci_set_drvdata(pdev, pericom);\n\treturn 0;\n}\n\nstatic void pericom8250_remove(struct pci_dev *pdev)\n{\n\tstruct pericom8250 *pericom = pci_get_drvdata(pdev);\n\tunsigned int i;\n\n\tfor (i = 0; i < pericom->nr; i++)\n\t\tserial8250_unregister_port(pericom->line[i]);\n}\n\nstatic const struct pci_device_id pericom8250_pci_ids[] = {\n\t \n\t{ PCI_VDEVICE(PERICOM, PCI_DEVICE_ID_PERICOM_PI7C9X7951) },\n\t{ PCI_VDEVICE(PERICOM, PCI_DEVICE_ID_PERICOM_PI7C9X7952) },\n\t{ PCI_VDEVICE(PERICOM, PCI_DEVICE_ID_PERICOM_PI7C9X7954) },\n\t{ PCI_VDEVICE(PERICOM, PCI_DEVICE_ID_PERICOM_PI7C9X7958) },\n\n\t \n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM_2SDB) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_2S) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM422_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM485_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM_4SDB) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_4S) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM422_8) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM485_8) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_2DB) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_COM232_2) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_4DB) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_COM232_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM232_8) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM_2SMDB) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_2SM) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM_4SM) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM_4SMDB) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_COM_4SM) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_COM_8SM) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM485_1) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM422_2) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM485_2) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM422_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM485_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_2S) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_4S) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_ICM232_2) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM232_2) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_ICM232_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_MPCIE_ICM232_4) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_2SM) },\n\t{ PCI_VDEVICE(ACCESSIO, PCI_DEVICE_ID_ACCESSIO_PCIE_ICM_4SM) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(pci, pericom8250_pci_ids);\n\nstatic struct pci_driver pericom8250_pci_driver = {\n\t.name           = \"8250_pericom\",\n\t.id_table       = pericom8250_pci_ids,\n\t.probe          = pericom8250_probe,\n\t.remove         = pericom8250_remove,\n};\nmodule_pci_driver(pericom8250_pci_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Pericom UART driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}