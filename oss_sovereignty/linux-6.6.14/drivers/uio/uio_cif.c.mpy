{
  "module_name": "uio_cif.c",
  "hash_id": "94b182d085b7b13d86450f86141fa67125c086fa101fd0f6b44859af80613333",
  "original_prompt": "Ingested from linux-6.6.14/drivers/uio/uio_cif.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include <linux/uio_driver.h>\n\n#include <asm/io.h>\n\n#define PLX9030_INTCSR\t\t0x4C\n#define INTSCR_INT1_ENABLE\t0x01\n#define INTSCR_INT1_STATUS\t0x04\n#define INT1_ENABLED_AND_ACTIVE\t(INTSCR_INT1_ENABLE | INTSCR_INT1_STATUS)\n\n#define PCI_SUBVENDOR_ID_PEP\t0x1518\n#define CIF_SUBDEVICE_PROFIBUS\t0x430\n#define CIF_SUBDEVICE_DEVICENET\t0x432\n\n\nstatic irqreturn_t hilscher_handler(int irq, struct uio_info *dev_info)\n{\n\tvoid __iomem *plx_intscr = dev_info->mem[0].internal_addr\n\t\t\t\t\t+ PLX9030_INTCSR;\n\n\tif ((ioread8(plx_intscr) & INT1_ENABLED_AND_ACTIVE)\n\t    != INT1_ENABLED_AND_ACTIVE)\n\t\treturn IRQ_NONE;\n\n\t \n\tiowrite8(ioread8(plx_intscr) & ~INTSCR_INT1_ENABLE, plx_intscr);\n\treturn IRQ_HANDLED;\n}\n\nstatic int hilscher_pci_probe(struct pci_dev *dev,\n\t\t\t\t\tconst struct pci_device_id *id)\n{\n\tstruct uio_info *info;\n\n\tinfo = devm_kzalloc(&dev->dev, sizeof(struct uio_info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tif (pci_enable_device(dev))\n\t\treturn -ENODEV;\n\n\tif (pci_request_regions(dev, \"hilscher\"))\n\t\tgoto out_disable;\n\n\tinfo->mem[0].addr = pci_resource_start(dev, 0);\n\tif (!info->mem[0].addr)\n\t\tgoto out_release;\n\tinfo->mem[0].internal_addr = pci_ioremap_bar(dev, 0);\n\tif (!info->mem[0].internal_addr)\n\t\tgoto out_release;\n\n\tinfo->mem[0].size = pci_resource_len(dev, 0);\n\tinfo->mem[0].memtype = UIO_MEM_PHYS;\n\tinfo->mem[1].addr = pci_resource_start(dev, 2);\n\tinfo->mem[1].size = pci_resource_len(dev, 2);\n\tinfo->mem[1].memtype = UIO_MEM_PHYS;\n\tswitch (id->subdevice) {\n\t\tcase CIF_SUBDEVICE_PROFIBUS:\n\t\t\tinfo->name = \"CIF_Profibus\";\n\t\t\tbreak;\n\t\tcase CIF_SUBDEVICE_DEVICENET:\n\t\t\tinfo->name = \"CIF_Devicenet\";\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tinfo->name = \"CIF_???\";\n\t}\n\tinfo->version = \"0.0.1\";\n\tinfo->irq = dev->irq;\n\tinfo->irq_flags = IRQF_SHARED;\n\tinfo->handler = hilscher_handler;\n\n\tif (uio_register_device(&dev->dev, info))\n\t\tgoto out_unmap;\n\n\tpci_set_drvdata(dev, info);\n\n\treturn 0;\nout_unmap:\n\tiounmap(info->mem[0].internal_addr);\nout_release:\n\tpci_release_regions(dev);\nout_disable:\n\tpci_disable_device(dev);\n\treturn -ENODEV;\n}\n\nstatic void hilscher_pci_remove(struct pci_dev *dev)\n{\n\tstruct uio_info *info = pci_get_drvdata(dev);\n\n\tuio_unregister_device(info);\n\tpci_release_regions(dev);\n\tpci_disable_device(dev);\n\tiounmap(info->mem[0].internal_addr);\n}\n\nstatic struct pci_device_id hilscher_pci_ids[] = {\n\t{\n\t\t.vendor =\tPCI_VENDOR_ID_PLX,\n\t\t.device =\tPCI_DEVICE_ID_PLX_9030,\n\t\t.subvendor =\tPCI_SUBVENDOR_ID_PEP,\n\t\t.subdevice =\tCIF_SUBDEVICE_PROFIBUS,\n\t},\n\t{\n\t\t.vendor =\tPCI_VENDOR_ID_PLX,\n\t\t.device =\tPCI_DEVICE_ID_PLX_9030,\n\t\t.subvendor =\tPCI_SUBVENDOR_ID_PEP,\n\t\t.subdevice =\tCIF_SUBDEVICE_DEVICENET,\n\t},\n\t{ 0, }\n};\n\nstatic struct pci_driver hilscher_pci_driver = {\n\t.name = \"hilscher\",\n\t.id_table = hilscher_pci_ids,\n\t.probe = hilscher_pci_probe,\n\t.remove = hilscher_pci_remove,\n};\n\nmodule_pci_driver(hilscher_pci_driver);\nMODULE_DEVICE_TABLE(pci, hilscher_pci_ids);\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Hans J. Koch, Benedikt Spranger\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}