{
  "module_name": "siox-bus-gpio.c",
  "hash_id": "a2b1da2cf20abb69b3587319e52610a9dbb42989a7cf87d9aa8eb2c0e25770cb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/siox/siox-bus-gpio.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n\n#include <linux/delay.h>\n\n#include \"siox.h\"\n\n#define DRIVER_NAME \"siox-gpio\"\n\nstruct siox_gpio_ddata {\n\tstruct gpio_desc *din;\n\tstruct gpio_desc *dout;\n\tstruct gpio_desc *dclk;\n\tstruct gpio_desc *dld;\n};\n\nstatic unsigned int siox_clkhigh_ns = 1000;\nstatic unsigned int siox_loadhigh_ns;\nstatic unsigned int siox_bytegap_ns;\n\nstatic int siox_gpio_pushpull(struct siox_master *smaster,\n\t\t\t      size_t setbuf_len, const u8 setbuf[],\n\t\t\t      size_t getbuf_len, u8 getbuf[])\n{\n\tstruct siox_gpio_ddata *ddata = siox_master_get_devdata(smaster);\n\tsize_t i;\n\tsize_t cycles = max(setbuf_len, getbuf_len);\n\n\t \n\tgpiod_set_value_cansleep(ddata->dout, 0);\n\tgpiod_set_value_cansleep(ddata->dclk, 0);\n\n\tgpiod_set_value_cansleep(ddata->dld, 1);\n\tndelay(siox_loadhigh_ns);\n\tgpiod_set_value_cansleep(ddata->dld, 0);\n\n\tfor (i = 0; i < cycles; ++i) {\n\t\tu8 set = 0, get = 0;\n\t\tsize_t j;\n\n\t\tif (i >= cycles - setbuf_len)\n\t\t\tset = setbuf[i - (cycles - setbuf_len)];\n\n\t\tfor (j = 0; j < 8; ++j) {\n\t\t\tget <<= 1;\n\t\t\tif (gpiod_get_value_cansleep(ddata->din))\n\t\t\t\tget |= 1;\n\n\t\t\t \n\t\t\tgpiod_set_value_cansleep(ddata->dout, !(set & 0x80));\n\t\t\tset <<= 1;\n\n\t\t\tgpiod_set_value_cansleep(ddata->dclk, 1);\n\t\t\tndelay(siox_clkhigh_ns);\n\t\t\tgpiod_set_value_cansleep(ddata->dclk, 0);\n\t\t}\n\n\t\tif (i < getbuf_len)\n\t\t\tgetbuf[i] = get;\n\n\t\tndelay(siox_bytegap_ns);\n\t}\n\n\tgpiod_set_value_cansleep(ddata->dld, 1);\n\tndelay(siox_loadhigh_ns);\n\tgpiod_set_value_cansleep(ddata->dld, 0);\n\n\t \n\tgpiod_set_value_cansleep(ddata->dout, 0);\n\n\treturn 0;\n}\n\nstatic int siox_gpio_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct siox_gpio_ddata *ddata;\n\tint ret;\n\tstruct siox_master *smaster;\n\n\tsmaster = siox_master_alloc(&pdev->dev, sizeof(*ddata));\n\tif (!smaster) {\n\t\tdev_err(dev, \"failed to allocate siox master\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tplatform_set_drvdata(pdev, smaster);\n\tddata = siox_master_get_devdata(smaster);\n\n\tddata->din = devm_gpiod_get(dev, \"din\", GPIOD_IN);\n\tif (IS_ERR(ddata->din)) {\n\t\tret = dev_err_probe(dev, PTR_ERR(ddata->din),\n\t\t\t\t    \"Failed to get din GPIO\\n\");\n\t\tgoto err;\n\t}\n\n\tddata->dout = devm_gpiod_get(dev, \"dout\", GPIOD_OUT_LOW);\n\tif (IS_ERR(ddata->dout)) {\n\t\tret = dev_err_probe(dev, PTR_ERR(ddata->dout),\n\t\t\t\t    \"Failed to get dout GPIO\\n\");\n\t\tgoto err;\n\t}\n\n\tddata->dclk = devm_gpiod_get(dev, \"dclk\", GPIOD_OUT_LOW);\n\tif (IS_ERR(ddata->dclk)) {\n\t\tret = dev_err_probe(dev, PTR_ERR(ddata->dclk),\n\t\t\t\t    \"Failed to get dclk GPIO\\n\");\n\t\tgoto err;\n\t}\n\n\tddata->dld = devm_gpiod_get(dev, \"dld\", GPIOD_OUT_LOW);\n\tif (IS_ERR(ddata->dld)) {\n\t\tret = dev_err_probe(dev, PTR_ERR(ddata->dld),\n\t\t\t\t    \"Failed to get dld GPIO\\n\");\n\t\tgoto err;\n\t}\n\n\tsmaster->pushpull = siox_gpio_pushpull;\n\t \n\tsmaster->busno = 0;\n\n\tret = siox_master_register(smaster);\n\tif (ret) {\n\t\tdev_err_probe(dev, ret,\n\t\t\t      \"Failed to register siox master\\n\");\nerr:\n\t\tsiox_master_put(smaster);\n\t}\n\n\treturn ret;\n}\n\nstatic int siox_gpio_remove(struct platform_device *pdev)\n{\n\tstruct siox_master *master = platform_get_drvdata(pdev);\n\n\tsiox_master_unregister(master);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id siox_gpio_dt_ids[] = {\n\t{ .compatible = \"eckelmann,siox-gpio\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, siox_gpio_dt_ids);\n\nstatic struct platform_driver siox_gpio_driver = {\n\t.probe = siox_gpio_probe,\n\t.remove = siox_gpio_remove,\n\n\t.driver = {\n\t\t.name = DRIVER_NAME,\n\t\t.of_match_table = siox_gpio_dt_ids,\n\t},\n};\nmodule_platform_driver(siox_gpio_driver);\n\nMODULE_AUTHOR(\"Uwe Kleine-Koenig <u.kleine-koenig@pengutronix.de>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:\" DRIVER_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}