{
  "module_name": "egalax_ts_serial.c",
  "hash_id": "871e5031c148dc98adf0798fff0be7fab0be82bbcf88443eef135bc4ca2ea666",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/touchscreen/egalax_ts_serial.c",
  "human_readable_source": "\n \n\n\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/serio.h>\n\n#define DRIVER_DESC\t\"EETI Egalax serial touchscreen driver\"\n\n \n\n#define EGALAX_FORMAT_MAX_LENGTH\t6\n#define EGALAX_FORMAT_START_BIT\t\tBIT(7)\n#define EGALAX_FORMAT_PRESSURE_BIT\tBIT(6)\n#define EGALAX_FORMAT_TOUCH_BIT\t\tBIT(0)\n#define EGALAX_FORMAT_RESOLUTION_MASK\t0x06\n\n#define EGALAX_MIN_XC\t\t\t0\n#define EGALAX_MAX_XC\t\t\t0x4000\n#define EGALAX_MIN_YC\t\t\t0\n#define EGALAX_MAX_YC\t\t\t0x4000\n\n \nstruct egalax {\n\tstruct input_dev *input;\n\tstruct serio *serio;\n\tint idx;\n\tu8 data[EGALAX_FORMAT_MAX_LENGTH];\n\tchar phys[32];\n};\n\nstatic void egalax_process_data(struct egalax *egalax)\n{\n\tstruct input_dev *dev = egalax->input;\n\tu8 *data = egalax->data;\n\tu16 x, y;\n\tu8 shift;\n\tu8 mask;\n\n\tshift = 3 - ((data[0] & EGALAX_FORMAT_RESOLUTION_MASK) >> 1);\n\tmask = 0xff >> (shift + 1);\n\n\tx = (((u16)(data[1] & mask) << 7) | (data[2] & 0x7f)) << shift;\n\ty = (((u16)(data[3] & mask) << 7) | (data[4] & 0x7f)) << shift;\n\n\tinput_report_key(dev, BTN_TOUCH, data[0] & EGALAX_FORMAT_TOUCH_BIT);\n\tinput_report_abs(dev, ABS_X, x);\n\tinput_report_abs(dev, ABS_Y, y);\n\tinput_sync(dev);\n}\n\nstatic irqreturn_t egalax_interrupt(struct serio *serio,\n\t\t\t\t    unsigned char data, unsigned int flags)\n{\n\tstruct egalax *egalax = serio_get_drvdata(serio);\n\tint pkt_len;\n\n\tegalax->data[egalax->idx++] = data;\n\n\tif (likely(egalax->data[0] & EGALAX_FORMAT_START_BIT)) {\n\t\tpkt_len = egalax->data[0] & EGALAX_FORMAT_PRESSURE_BIT ? 6 : 5;\n\t\tif (pkt_len == egalax->idx) {\n\t\t\tegalax_process_data(egalax);\n\t\t\tegalax->idx = 0;\n\t\t}\n\t} else {\n\t\tdev_dbg(&serio->dev, \"unknown/unsynchronized data: %x\\n\",\n\t\t\tegalax->data[0]);\n\t\tegalax->idx = 0;\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\n \nstatic int egalax_connect(struct serio *serio, struct serio_driver *drv)\n{\n\tstruct egalax *egalax;\n\tstruct input_dev *input_dev;\n\tint error;\n\n\tegalax = kzalloc(sizeof(struct egalax), GFP_KERNEL);\n\tinput_dev = input_allocate_device();\n\tif (!egalax || !input_dev) {\n\t\terror = -ENOMEM;\n\t\tgoto err_free_mem;\n\t}\n\n\tegalax->serio = serio;\n\tegalax->input = input_dev;\n\tsnprintf(egalax->phys, sizeof(egalax->phys),\n\t\t \"%s/input0\", serio->phys);\n\n\tinput_dev->name = \"EETI eGalaxTouch Serial TouchScreen\";\n\tinput_dev->phys = egalax->phys;\n\tinput_dev->id.bustype = BUS_RS232;\n\tinput_dev->id.vendor = SERIO_EGALAX;\n\tinput_dev->id.product = 0;\n\tinput_dev->id.version = 0x0001;\n\tinput_dev->dev.parent = &serio->dev;\n\n\tinput_set_capability(input_dev, EV_KEY, BTN_TOUCH);\n\tinput_set_abs_params(input_dev, ABS_X,\n\t\t\t     EGALAX_MIN_XC, EGALAX_MAX_XC, 0, 0);\n\tinput_set_abs_params(input_dev, ABS_Y,\n\t\t\t     EGALAX_MIN_YC, EGALAX_MAX_YC, 0, 0);\n\n\tserio_set_drvdata(serio, egalax);\n\n\terror = serio_open(serio, drv);\n\tif (error)\n\t\tgoto err_reset_drvdata;\n\n\terror = input_register_device(input_dev);\n\tif (error)\n\t\tgoto err_close_serio;\n\n\treturn 0;\n\nerr_close_serio:\n\tserio_close(serio);\nerr_reset_drvdata:\n\tserio_set_drvdata(serio, NULL);\nerr_free_mem:\n\tinput_free_device(input_dev);\n\tkfree(egalax);\n\treturn error;\n}\n\nstatic void egalax_disconnect(struct serio *serio)\n{\n\tstruct egalax *egalax = serio_get_drvdata(serio);\n\n\tserio_close(serio);\n\tserio_set_drvdata(serio, NULL);\n\tinput_unregister_device(egalax->input);\n\tkfree(egalax);\n}\n\n \n\nstatic const struct serio_device_id egalax_serio_ids[] = {\n\t{\n\t\t.type\t= SERIO_RS232,\n\t\t.proto\t= SERIO_EGALAX,\n\t\t.id\t= SERIO_ANY,\n\t\t.extra\t= SERIO_ANY,\n\t},\n\t{ 0 }\n};\n\nMODULE_DEVICE_TABLE(serio, egalax_serio_ids);\n\nstatic struct serio_driver egalax_drv = {\n\t.driver\t\t= {\n\t\t.name\t= \"egalax\",\n\t},\n\t.description\t= DRIVER_DESC,\n\t.id_table\t= egalax_serio_ids,\n\t.interrupt\t= egalax_interrupt,\n\t.connect\t= egalax_connect,\n\t.disconnect\t= egalax_disconnect,\n};\nmodule_serio_driver(egalax_drv);\n\nMODULE_AUTHOR(\"Zolt\u00e1n B\u00f6sz\u00f6rm\u00e9nyi <zboszor@pr.hu>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}