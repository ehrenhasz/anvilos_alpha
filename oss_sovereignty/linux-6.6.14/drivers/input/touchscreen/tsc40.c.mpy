{
  "module_name": "tsc40.c",
  "hash_id": "484b77c6c62ea7769c39c887726d06229797d9899d794e8e5199b297dff4d0ed",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/touchscreen/tsc40.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/serio.h>\n\n#define PACKET_LENGTH  5\nstruct tsc_ser {\n\tstruct input_dev *dev;\n\tstruct serio *serio;\n\tu32 idx;\n\tunsigned char data[PACKET_LENGTH];\n\tchar phys[32];\n};\n\nstatic void tsc_process_data(struct tsc_ser *ptsc)\n{\n\tstruct input_dev *dev = ptsc->dev;\n\tu8 *data = ptsc->data;\n\tu32 x;\n\tu32 y;\n\n\tx = ((data[1] & 0x03) << 8) | data[2];\n\ty = ((data[3] & 0x03) << 8) | data[4];\n\n\tinput_report_abs(dev, ABS_X, x);\n\tinput_report_abs(dev, ABS_Y, y);\n\tinput_report_key(dev, BTN_TOUCH, 1);\n\n\tinput_sync(dev);\n}\n\nstatic irqreturn_t tsc_interrupt(struct serio *serio,\n\t\tunsigned char data, unsigned int flags)\n{\n\tstruct tsc_ser *ptsc = serio_get_drvdata(serio);\n\tstruct input_dev *dev = ptsc->dev;\n\n\tptsc->data[ptsc->idx] = data;\n\tswitch (ptsc->idx++) {\n\tcase 0:\n\t\tif (unlikely((data & 0x3e) != 0x10)) {\n\t\t\tdev_dbg(&serio->dev,\n\t\t\t\t\"unsynchronized packet start (0x%02x)\\n\", data);\n\t\t\tptsc->idx = 0;\n\t\t} else if (!(data & 0x01)) {\n\t\t\tinput_report_key(dev, BTN_TOUCH, 0);\n\t\t\tinput_sync(dev);\n\t\t\tptsc->idx = 0;\n\t\t}\n\t\tbreak;\n\n\tcase 1:\n\tcase 3:\n\t\tif (unlikely(data & 0xfc)) {\n\t\t\tdev_dbg(&serio->dev,\n\t\t\t\t\"unsynchronized data 0x%02x at offset %d\\n\",\n\t\t\t\tdata, ptsc->idx - 1);\n\t\t\tptsc->idx = 0;\n\t\t}\n\t\tbreak;\n\n\tcase 4:\n\t\ttsc_process_data(ptsc);\n\t\tptsc->idx = 0;\n\t\tbreak;\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int tsc_connect(struct serio *serio, struct serio_driver *drv)\n{\n\tstruct tsc_ser *ptsc;\n\tstruct input_dev *input_dev;\n\tint error;\n\n\tptsc = kzalloc(sizeof(struct tsc_ser), GFP_KERNEL);\n\tinput_dev = input_allocate_device();\n\tif (!ptsc || !input_dev) {\n\t\terror = -ENOMEM;\n\t\tgoto fail1;\n\t}\n\n\tptsc->serio = serio;\n\tptsc->dev = input_dev;\n\tsnprintf(ptsc->phys, sizeof(ptsc->phys), \"%s/input0\", serio->phys);\n\n\tinput_dev->name = \"TSC-10/25/40 Serial TouchScreen\";\n\tinput_dev->phys = ptsc->phys;\n\tinput_dev->id.bustype = BUS_RS232;\n\tinput_dev->id.vendor = SERIO_TSC40;\n\tinput_dev->id.product = 40;\n\tinput_dev->id.version = 0x0001;\n\tinput_dev->dev.parent = &serio->dev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\n\t__set_bit(BTN_TOUCH, input_dev->keybit);\n\tinput_set_abs_params(ptsc->dev, ABS_X, 0, 0x3ff, 0, 0);\n\tinput_set_abs_params(ptsc->dev, ABS_Y, 0, 0x3ff, 0, 0);\n\n\tserio_set_drvdata(serio, ptsc);\n\n\terror = serio_open(serio, drv);\n\tif (error)\n\t\tgoto fail2;\n\n\terror = input_register_device(ptsc->dev);\n\tif (error)\n\t\tgoto fail3;\n\n\treturn 0;\n\nfail3:\n\tserio_close(serio);\nfail2:\n\tserio_set_drvdata(serio, NULL);\nfail1:\n\tinput_free_device(input_dev);\n\tkfree(ptsc);\n\treturn error;\n}\n\nstatic void tsc_disconnect(struct serio *serio)\n{\n\tstruct tsc_ser *ptsc = serio_get_drvdata(serio);\n\n\tserio_close(serio);\n\n\tinput_unregister_device(ptsc->dev);\n\tkfree(ptsc);\n\n\tserio_set_drvdata(serio, NULL);\n}\n\nstatic const struct serio_device_id tsc_serio_ids[] = {\n\t{\n\t\t.type   = SERIO_RS232,\n\t\t.proto  = SERIO_TSC40,\n\t\t.id     = SERIO_ANY,\n\t\t.extra  = SERIO_ANY,\n\t},\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(serio, tsc_serio_ids);\n\n#define DRIVER_DESC    \"TSC-10/25/40 serial touchscreen driver\"\n\nstatic struct serio_driver tsc_drv = {\n\t.driver\t= {\n\t\t.name   = \"tsc40\",\n\t},\n\t.description    = DRIVER_DESC,\n\t.id_table\t= tsc_serio_ids,\n\t.interrupt      = tsc_interrupt,\n\t.connect\t= tsc_connect,\n\t.disconnect     = tsc_disconnect,\n};\n\nmodule_serio_driver(tsc_drv);\n\nMODULE_AUTHOR(\"Sebastian Andrzej Siewior <bigeasy@linutronix.de>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}