{
  "module_name": "ipaq-micro-ts.c",
  "hash_id": "0d23cec38a75e0b51f71f066e23e85fced572e127550a066db74f2810ba8627e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/touchscreen/ipaq-micro-ts.c",
  "human_readable_source": "\n \n\n#include <asm/byteorder.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/pm.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/input.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/mfd/ipaq-micro.h>\n\nstruct touchscreen_data {\n\tstruct input_dev *input;\n\tstruct ipaq_micro *micro;\n};\n\nstatic void micro_ts_receive(void *data, int len, unsigned char *msg)\n{\n\tstruct touchscreen_data *ts = data;\n\n\tif (len == 4) {\n\t\tinput_report_abs(ts->input, ABS_X,\n\t\t\t\t be16_to_cpup((__be16 *) &msg[2]));\n\t\tinput_report_abs(ts->input, ABS_Y,\n\t\t\t\t be16_to_cpup((__be16 *) &msg[0]));\n\t\tinput_report_key(ts->input, BTN_TOUCH, 1);\n\t\tinput_sync(ts->input);\n\t} else if (len == 0) {\n\t\tinput_report_abs(ts->input, ABS_X, 0);\n\t\tinput_report_abs(ts->input, ABS_Y, 0);\n\t\tinput_report_key(ts->input, BTN_TOUCH, 0);\n\t\tinput_sync(ts->input);\n\t}\n}\n\nstatic void micro_ts_toggle_receive(struct touchscreen_data *ts, bool enable)\n{\n\tstruct ipaq_micro *micro = ts->micro;\n\n\tspin_lock_irq(&micro->lock);\n\n\tif (enable) {\n\t\tmicro->ts = micro_ts_receive;\n\t\tmicro->ts_data = ts;\n\t} else {\n\t\tmicro->ts = NULL;\n\t\tmicro->ts_data = NULL;\n\t}\n\n\tspin_unlock_irq(&ts->micro->lock);\n}\n\nstatic int micro_ts_open(struct input_dev *input)\n{\n\tstruct touchscreen_data *ts = input_get_drvdata(input);\n\n\tmicro_ts_toggle_receive(ts, true);\n\n\treturn 0;\n}\n\nstatic void micro_ts_close(struct input_dev *input)\n{\n\tstruct touchscreen_data *ts = input_get_drvdata(input);\n\n\tmicro_ts_toggle_receive(ts, false);\n}\n\nstatic int micro_ts_probe(struct platform_device *pdev)\n{\n\tstruct ipaq_micro *micro = dev_get_drvdata(pdev->dev.parent);\n\tstruct touchscreen_data *ts;\n\tint error;\n\n\tts = devm_kzalloc(&pdev->dev, sizeof(*ts), GFP_KERNEL);\n\tif (!ts)\n\t\treturn -ENOMEM;\n\n\tts->micro = micro;\n\n\tts->input = devm_input_allocate_device(&pdev->dev);\n\tif (!ts->input) {\n\t\tdev_err(&pdev->dev, \"failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tts->input->name = \"ipaq micro ts\";\n\tts->input->open = micro_ts_open;\n\tts->input->close = micro_ts_close;\n\n\tinput_set_drvdata(ts->input, ts);\n\n\tinput_set_capability(ts->input, EV_KEY, BTN_TOUCH);\n\tinput_set_capability(ts->input, EV_ABS, ABS_X);\n\tinput_set_capability(ts->input, EV_ABS, ABS_Y);\n\tinput_set_abs_params(ts->input, ABS_X, 0, 1023, 0, 0);\n\tinput_set_abs_params(ts->input, ABS_Y, 0, 1023, 0, 0);\n\n\terror = input_register_device(ts->input);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"error registering touch input\\n\");\n\t\treturn error;\n\t}\n\n\tplatform_set_drvdata(pdev, ts);\n\n\tdev_info(&pdev->dev, \"iPAQ micro touchscreen\\n\");\n\n\treturn 0;\n}\n\nstatic int micro_ts_suspend(struct device *dev)\n{\n\tstruct touchscreen_data *ts = dev_get_drvdata(dev);\n\n\tmicro_ts_toggle_receive(ts, false);\n\n\treturn 0;\n}\n\nstatic int micro_ts_resume(struct device *dev)\n{\n\tstruct touchscreen_data *ts = dev_get_drvdata(dev);\n\tstruct input_dev *input = ts->input;\n\n\tmutex_lock(&input->mutex);\n\n\tif (input_device_enabled(input))\n\t\tmicro_ts_toggle_receive(ts, true);\n\n\tmutex_unlock(&input->mutex);\n\n\treturn 0;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(micro_ts_dev_pm_ops,\n\t\t\t\tmicro_ts_suspend, micro_ts_resume);\n\nstatic struct platform_driver micro_ts_device_driver = {\n\t.driver\t= {\n\t\t.name\t= \"ipaq-micro-ts\",\n\t\t.pm\t= pm_sleep_ptr(&micro_ts_dev_pm_ops),\n\t},\n\t.probe\t= micro_ts_probe,\n};\nmodule_platform_driver(micro_ts_device_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"driver for iPAQ Atmel micro touchscreen\");\nMODULE_ALIAS(\"platform:ipaq-micro-ts\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}