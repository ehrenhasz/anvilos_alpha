{
  "module_name": "jornada720_ts.c",
  "hash_id": "66315f2863af0545a26839ac726e1ce925cd13230878e4745412152bfe53a103",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/touchscreen/jornada720_ts.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/platform_device.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n\n#include <mach/jornada720.h>\n\nMODULE_AUTHOR(\"Kristoffer Ericson <kristoffer.ericson@gmail.com>\");\nMODULE_DESCRIPTION(\"HP Jornada 710/720/728 touchscreen driver\");\nMODULE_LICENSE(\"GPL v2\");\n\nstruct jornada_ts {\n\tstruct input_dev *dev;\n\tstruct gpio_desc *gpio;\n\tint x_data[4];\t\t \n\tint y_data[4];\t\t \n};\n\nstatic void jornada720_ts_collect_data(struct jornada_ts *jornada_ts)\n{\n\t \n\tjornada_ts->x_data[0] = jornada_ssp_byte(TXDUMMY);\n\tjornada_ts->x_data[1] = jornada_ssp_byte(TXDUMMY);\n\tjornada_ts->x_data[2] = jornada_ssp_byte(TXDUMMY);\n\n\t \n\tjornada_ts->y_data[0] = jornada_ssp_byte(TXDUMMY);\n\tjornada_ts->y_data[1] = jornada_ssp_byte(TXDUMMY);\n\tjornada_ts->y_data[2] = jornada_ssp_byte(TXDUMMY);\n\n\t \n\tjornada_ts->x_data[3] = jornada_ssp_byte(TXDUMMY);\n\n\t \n\tjornada_ts->y_data[3] = jornada_ssp_byte(TXDUMMY);\n}\n\nstatic int jornada720_ts_average(int coords[4])\n{\n\tint coord, high_bits = coords[3];\n\n\tcoord  = coords[0] | ((high_bits & 0x03) << 8);\n\tcoord += coords[1] | ((high_bits & 0x0c) << 6);\n\tcoord += coords[2] | ((high_bits & 0x30) << 4);\n\n\treturn coord / 3;\n}\n\nstatic irqreturn_t jornada720_ts_interrupt(int irq, void *dev_id)\n{\n\tstruct platform_device *pdev = dev_id;\n\tstruct jornada_ts *jornada_ts = platform_get_drvdata(pdev);\n\tstruct input_dev *input = jornada_ts->dev;\n\tint x, y;\n\n\t \n\tif (gpiod_get_value(jornada_ts->gpio)) {\n\t\tinput_report_key(input, BTN_TOUCH, 0);\n\t\tinput_sync(input);\n\t} else {\n\t\tjornada_ssp_start();\n\n\t\t \n\t\tif (jornada_ssp_inout(GETTOUCHSAMPLES) == TXDUMMY) {\n\t\t\tjornada720_ts_collect_data(jornada_ts);\n\n\t\t\tx = jornada720_ts_average(jornada_ts->x_data);\n\t\t\ty = jornada720_ts_average(jornada_ts->y_data);\n\n\t\t\tinput_report_key(input, BTN_TOUCH, 1);\n\t\t\tinput_report_abs(input, ABS_X, x);\n\t\t\tinput_report_abs(input, ABS_Y, y);\n\t\t\tinput_sync(input);\n\t\t}\n\n\t\tjornada_ssp_end();\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int jornada720_ts_probe(struct platform_device *pdev)\n{\n\tstruct jornada_ts *jornada_ts;\n\tstruct input_dev *input_dev;\n\tint error, irq;\n\n\tjornada_ts = devm_kzalloc(&pdev->dev, sizeof(*jornada_ts), GFP_KERNEL);\n\tif (!jornada_ts)\n\t\treturn -ENOMEM;\n\n\tinput_dev = devm_input_allocate_device(&pdev->dev);\n\tif (!input_dev)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, jornada_ts);\n\n\tjornada_ts->gpio = devm_gpiod_get(&pdev->dev, \"penup\", GPIOD_IN);\n\tif (IS_ERR(jornada_ts->gpio))\n\t\treturn PTR_ERR(jornada_ts->gpio);\n\n\tirq = gpiod_to_irq(jornada_ts->gpio);\n\tif (irq <= 0)\n\t\treturn irq < 0 ? irq : -EINVAL;\n\n\tjornada_ts->dev = input_dev;\n\n\tinput_dev->name = \"HP Jornada 7xx Touchscreen\";\n\tinput_dev->phys = \"jornadats/input0\";\n\tinput_dev->id.bustype = BUS_HOST;\n\tinput_dev->dev.parent = &pdev->dev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\n\tinput_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\n\tinput_set_abs_params(input_dev, ABS_X, 270, 3900, 0, 0);\n\tinput_set_abs_params(input_dev, ABS_Y, 180, 3700, 0, 0);\n\n\terror = devm_request_irq(&pdev->dev, irq, jornada720_ts_interrupt,\n\t\t\t\t IRQF_TRIGGER_RISING,\n\t\t\t\t \"HP7XX Touchscreen driver\", pdev);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"HP7XX TS : Unable to acquire irq!\\n\");\n\t\treturn error;\n\t}\n\n\terror = input_register_device(jornada_ts->dev);\n\tif (error)\n\t\treturn error;\n\n\treturn 0;\n}\n\n \nMODULE_ALIAS(\"platform:jornada_ts\");\n\nstatic struct platform_driver jornada720_ts_driver = {\n\t.probe\t\t= jornada720_ts_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"jornada_ts\",\n\t},\n};\nmodule_platform_driver(jornada720_ts_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}