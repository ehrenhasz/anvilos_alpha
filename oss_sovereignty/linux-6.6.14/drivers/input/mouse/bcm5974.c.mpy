{
  "module_name": "bcm5974.c",
  "hash_id": "7edb693e26e9cfa346f9f23fd6fbf6ae8f36e6289e96c8b6636e00de57987507",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/bcm5974.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/usb/input.h>\n#include <linux/hid.h>\n#include <linux/mutex.h>\n#include <linux/input/mt.h>\n\n#define USB_VENDOR_ID_APPLE\t\t0x05ac\n\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING_ANSI\t0x0223\n#define USB_DEVICE_ID_APPLE_WELLSPRING_ISO\t0x0224\n#define USB_DEVICE_ID_APPLE_WELLSPRING_JIS\t0x0225\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING2_ANSI\t0x0230\n#define USB_DEVICE_ID_APPLE_WELLSPRING2_ISO\t0x0231\n#define USB_DEVICE_ID_APPLE_WELLSPRING2_JIS\t0x0232\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING3_ANSI\t0x0236\n#define USB_DEVICE_ID_APPLE_WELLSPRING3_ISO\t0x0237\n#define USB_DEVICE_ID_APPLE_WELLSPRING3_JIS\t0x0238\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI\t0x023f\n#define USB_DEVICE_ID_APPLE_WELLSPRING4_ISO\t0x0240\n#define USB_DEVICE_ID_APPLE_WELLSPRING4_JIS\t0x0241\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI\t0x0242\n#define USB_DEVICE_ID_APPLE_WELLSPRING4A_ISO\t0x0243\n#define USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS\t0x0244\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING5_ANSI\t0x0245\n#define USB_DEVICE_ID_APPLE_WELLSPRING5_ISO\t0x0246\n#define USB_DEVICE_ID_APPLE_WELLSPRING5_JIS\t0x0247\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI\t0x0249\n#define USB_DEVICE_ID_APPLE_WELLSPRING6A_ISO\t0x024a\n#define USB_DEVICE_ID_APPLE_WELLSPRING6A_JIS\t0x024b\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING6_ANSI\t0x024c\n#define USB_DEVICE_ID_APPLE_WELLSPRING6_ISO\t0x024d\n#define USB_DEVICE_ID_APPLE_WELLSPRING6_JIS\t0x024e\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI\t0x0252\n#define USB_DEVICE_ID_APPLE_WELLSPRING5A_ISO\t0x0253\n#define USB_DEVICE_ID_APPLE_WELLSPRING5A_JIS\t0x0254\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING7_ANSI\t0x0262\n#define USB_DEVICE_ID_APPLE_WELLSPRING7_ISO\t0x0263\n#define USB_DEVICE_ID_APPLE_WELLSPRING7_JIS\t0x0264\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING7A_ANSI\t0x0259\n#define USB_DEVICE_ID_APPLE_WELLSPRING7A_ISO\t0x025a\n#define USB_DEVICE_ID_APPLE_WELLSPRING7A_JIS\t0x025b\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING8_ANSI\t0x0290\n#define USB_DEVICE_ID_APPLE_WELLSPRING8_ISO\t0x0291\n#define USB_DEVICE_ID_APPLE_WELLSPRING8_JIS\t0x0292\n \n#define USB_DEVICE_ID_APPLE_WELLSPRING9_ANSI\t0x0272\n#define USB_DEVICE_ID_APPLE_WELLSPRING9_ISO\t0x0273\n#define USB_DEVICE_ID_APPLE_WELLSPRING9_JIS\t0x0274\n\n#define BCM5974_DEVICE(prod) {\t\t\t\t\t\\\n\t.match_flags = (USB_DEVICE_ID_MATCH_DEVICE |\t\t\\\n\t\t\tUSB_DEVICE_ID_MATCH_INT_CLASS |\t\t\\\n\t\t\tUSB_DEVICE_ID_MATCH_INT_PROTOCOL),\t\\\n\t.idVendor = USB_VENDOR_ID_APPLE,\t\t\t\\\n\t.idProduct = (prod),\t\t\t\t\t\\\n\t.bInterfaceClass = USB_INTERFACE_CLASS_HID,\t\t\\\n\t.bInterfaceProtocol = USB_INTERFACE_PROTOCOL_MOUSE\t\\\n}\n\n \nstatic const struct usb_device_id bcm5974_table[] = {\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING2_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING2_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING2_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING3_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING3_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING3_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING4_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING4_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING4A_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING5_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING5_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING5_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING6A_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING6A_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING6_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING6_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING6_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING5A_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING5A_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING7_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING7_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING7_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING7A_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING7A_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING7A_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING8_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING8_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING8_JIS),\n\t \n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING9_ANSI),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING9_ISO),\n\tBCM5974_DEVICE(USB_DEVICE_ID_APPLE_WELLSPRING9_JIS),\n\t \n\t{}\n};\nMODULE_DEVICE_TABLE(usb, bcm5974_table);\n\nMODULE_AUTHOR(\"Henrik Rydberg\");\nMODULE_DESCRIPTION(\"Apple USB BCM5974 multitouch driver\");\nMODULE_LICENSE(\"GPL\");\n\n#define dprintk(level, format, a...)\\\n\t{ if (debug >= level) printk(KERN_DEBUG format, ##a); }\n\nstatic int debug = 1;\nmodule_param(debug, int, 0644);\nMODULE_PARM_DESC(debug, \"Activate debugging output\");\n\n \nstruct bt_data {\n\tu8 unknown1;\t\t \n\tu8 button;\t\t \n\tu8 rel_x;\t\t \n\tu8 rel_y;\t\t \n};\n\n \nenum tp_type {\n\tTYPE1,\t\t\t \n\tTYPE2,\t\t\t \n\tTYPE3,\t\t\t \n\tTYPE4\t\t\t \n};\n\n \n#define HEADER_TYPE1\t\t(13 * sizeof(__le16))\n#define HEADER_TYPE2\t\t(15 * sizeof(__le16))\n#define HEADER_TYPE3\t\t(19 * sizeof(__le16))\n#define HEADER_TYPE4\t\t(23 * sizeof(__le16))\n\n \n#define BUTTON_TYPE1\t\t0\n#define BUTTON_TYPE2\t\t15\n#define BUTTON_TYPE3\t\t23\n#define BUTTON_TYPE4\t\t31\n\n \n#define HAS_INTEGRATED_BUTTON\t1\n\n \n#define FSIZE_TYPE1\t\t(14 * sizeof(__le16))\n#define FSIZE_TYPE2\t\t(14 * sizeof(__le16))\n#define FSIZE_TYPE3\t\t(14 * sizeof(__le16))\n#define FSIZE_TYPE4\t\t(15 * sizeof(__le16))\n\n \n#define DELTA_TYPE1\t\t(0 * sizeof(__le16))\n#define DELTA_TYPE2\t\t(0 * sizeof(__le16))\n#define DELTA_TYPE3\t\t(0 * sizeof(__le16))\n#define DELTA_TYPE4\t\t(1 * sizeof(__le16))\n\n \n#define USBMSG_TYPE1\t\t8, 0x300, 0, 0, 0x1, 0x8\n#define USBMSG_TYPE2\t\t8, 0x300, 0, 0, 0x1, 0x8\n#define USBMSG_TYPE3\t\t8, 0x300, 0, 0, 0x1, 0x8\n#define USBMSG_TYPE4\t\t2, 0x302, 2, 1, 0x1, 0x0\n\n \n#define BCM5974_WELLSPRING_MODE_READ_REQUEST_ID\t\t1\n#define BCM5974_WELLSPRING_MODE_WRITE_REQUEST_ID\t9\n\n \nstruct tp_finger {\n\t__le16 origin;\t\t \n\t__le16 abs_x;\t\t \n\t__le16 abs_y;\t\t \n\t__le16 rel_x;\t\t \n\t__le16 rel_y;\t\t \n\t__le16 tool_major;\t \n\t__le16 tool_minor;\t \n\t__le16 orientation;\t \n\t__le16 touch_major;\t \n\t__le16 touch_minor;\t \n\t__le16 unused[2];\t \n\t__le16 pressure;\t \n\t__le16 multi;\t\t \n} __attribute__((packed,aligned(2)));\n\n \n#define MAX_FINGERS\t\t16\n#define MAX_FINGER_ORIENTATION\t16384\n\n \nstruct bcm5974_param {\n\tint snratio;\t\t \n\tint min;\t\t \n\tint max;\t\t \n};\n\n \nstruct bcm5974_config {\n\tint ansi, iso, jis;\t \n\tint caps;\t\t \n\tint bt_ep;\t\t \n\tint bt_datalen;\t\t \n\tint tp_ep;\t\t \n\tenum tp_type tp_type;\t \n\tint tp_header;\t\t \n\tint tp_datalen;\t\t \n\tint tp_button;\t\t \n\tint tp_fsize;\t\t \n\tint tp_delta;\t\t \n\tint um_size;\t\t \n\tint um_req_val;\t\t \n\tint um_req_idx;\t\t \n\tint um_switch_idx;\t \n\tint um_switch_on;\t \n\tint um_switch_off;\t \n\tstruct bcm5974_param p;\t \n\tstruct bcm5974_param w;\t \n\tstruct bcm5974_param x;\t \n\tstruct bcm5974_param y;\t \n\tstruct bcm5974_param o;\t \n};\n\n \nstruct bcm5974 {\n\tchar phys[64];\n\tstruct usb_device *udev;\t \n\tstruct usb_interface *intf;\t \n\tstruct input_dev *input;\t \n\tstruct bcm5974_config cfg;\t \n\tstruct mutex pm_mutex;\t\t \n\tint opened;\t\t\t \n\tstruct urb *bt_urb;\t\t \n\tstruct bt_data *bt_data;\t \n\tstruct urb *tp_urb;\t\t \n\tu8 *tp_data;\t\t\t \n\tconst struct tp_finger *index[MAX_FINGERS];\t \n\tstruct input_mt_pos pos[MAX_FINGERS];\t\t \n\tint slots[MAX_FINGERS];\t\t\t\t \n};\n\n \nstatic const struct tp_finger *get_tp_finger(const struct bcm5974 *dev, int i)\n{\n\tconst struct bcm5974_config *c = &dev->cfg;\n\tu8 *f_base = dev->tp_data + c->tp_header + c->tp_delta;\n\n\treturn (const struct tp_finger *)(f_base + i * c->tp_fsize);\n}\n\n#define DATAFORMAT(type)\t\t\t\t\\\n\ttype,\t\t\t\t\t\t\\\n\tHEADER_##type,\t\t\t\t\t\\\n\tHEADER_##type + (MAX_FINGERS) * (FSIZE_##type),\t\\\n\tBUTTON_##type,\t\t\t\t\t\\\n\tFSIZE_##type,\t\t\t\t\t\\\n\tDELTA_##type,\t\t\t\t\t\\\n\tUSBMSG_##type\n\n \n#define SN_PRESSURE\t45\t\t \n#define SN_WIDTH\t25\t\t \n#define SN_COORD\t250\t\t \n#define SN_ORIENT\t10\t\t \n\n \nstatic const struct bcm5974_config bcm5974_config_table[] = {\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING_JIS,\n\t\t0,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE1),\n\t\t{ SN_PRESSURE, 0, 256 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4824, 5342 },\n\t\t{ SN_COORD, -172, 5820 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING2_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING2_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING2_JIS,\n\t\t0,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE1),\n\t\t{ SN_PRESSURE, 0, 256 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4824, 4824 },\n\t\t{ SN_COORD, -172, 4290 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING3_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING3_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING3_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4460, 5166 },\n\t\t{ SN_COORD, -75, 6700 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING4_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING4_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING4_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4620, 5140 },\n\t\t{ SN_COORD, -150, 6600 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING4A_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING4A_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4616, 5112 },\n\t\t{ SN_COORD, -142, 5234 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING5_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING5_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING5_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4415, 5050 },\n\t\t{ SN_COORD, -55, 6680 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING6_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING6_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING6_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4620, 5140 },\n\t\t{ SN_COORD, -150, 6600 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING5A_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING5A_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4750, 5280 },\n\t\t{ SN_COORD, -150, 6730 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING6A_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING6A_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4620, 5140 },\n\t\t{ SN_COORD, -150, 6600 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING7_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING7_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING7_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4750, 5280 },\n\t\t{ SN_COORD, -150, 6730 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING7A_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING7A_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING7A_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0x84, sizeof(struct bt_data),\n\t\t0x81, DATAFORMAT(TYPE2),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4750, 5280 },\n\t\t{ SN_COORD, -150, 6730 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING8_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING8_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING8_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0, sizeof(struct bt_data),\n\t\t0x83, DATAFORMAT(TYPE3),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4620, 5140 },\n\t\t{ SN_COORD, -150, 6600 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING9_ANSI,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING9_ISO,\n\t\tUSB_DEVICE_ID_APPLE_WELLSPRING9_JIS,\n\t\tHAS_INTEGRATED_BUTTON,\n\t\t0, sizeof(struct bt_data),\n\t\t0x83, DATAFORMAT(TYPE4),\n\t\t{ SN_PRESSURE, 0, 300 },\n\t\t{ SN_WIDTH, 0, 2048 },\n\t\t{ SN_COORD, -4828, 5345 },\n\t\t{ SN_COORD, -203, 6803 },\n\t\t{ SN_ORIENT, -MAX_FINGER_ORIENTATION, MAX_FINGER_ORIENTATION }\n\t},\n\t{}\n};\n\n \nstatic const struct bcm5974_config *bcm5974_get_config(struct usb_device *udev)\n{\n\tu16 id = le16_to_cpu(udev->descriptor.idProduct);\n\tconst struct bcm5974_config *cfg;\n\n\tfor (cfg = bcm5974_config_table; cfg->ansi; ++cfg)\n\t\tif (cfg->ansi == id || cfg->iso == id || cfg->jis == id)\n\t\t\treturn cfg;\n\n\treturn bcm5974_config_table;\n}\n\n \nstatic inline int raw2int(__le16 x)\n{\n\treturn (signed short)le16_to_cpu(x);\n}\n\nstatic void set_abs(struct input_dev *input, unsigned int code,\n\t\t    const struct bcm5974_param *p)\n{\n\tint fuzz = p->snratio ? (p->max - p->min) / p->snratio : 0;\n\tinput_set_abs_params(input, code, p->min, p->max, fuzz, 0);\n}\n\n \nstatic void setup_events_to_report(struct input_dev *input_dev,\n\t\t\t\t   const struct bcm5974_config *cfg)\n{\n\t__set_bit(EV_ABS, input_dev->evbit);\n\n\t \n\tinput_set_abs_params(input_dev, ABS_PRESSURE, 0, 256, 5, 0);\n\tinput_set_abs_params(input_dev, ABS_TOOL_WIDTH, 0, 16, 0, 0);\n\n\t \n\tset_abs(input_dev, ABS_MT_TOUCH_MAJOR, &cfg->w);\n\tset_abs(input_dev, ABS_MT_TOUCH_MINOR, &cfg->w);\n\t \n\tset_abs(input_dev, ABS_MT_WIDTH_MAJOR, &cfg->w);\n\tset_abs(input_dev, ABS_MT_WIDTH_MINOR, &cfg->w);\n\t \n\tset_abs(input_dev, ABS_MT_ORIENTATION, &cfg->o);\n\t \n\tset_abs(input_dev, ABS_MT_POSITION_X, &cfg->x);\n\tset_abs(input_dev, ABS_MT_POSITION_Y, &cfg->y);\n\n\t__set_bit(EV_KEY, input_dev->evbit);\n\t__set_bit(BTN_LEFT, input_dev->keybit);\n\n\tif (cfg->caps & HAS_INTEGRATED_BUTTON)\n\t\t__set_bit(INPUT_PROP_BUTTONPAD, input_dev->propbit);\n\n\tinput_mt_init_slots(input_dev, MAX_FINGERS,\n\t\tINPUT_MT_POINTER | INPUT_MT_DROP_UNUSED | INPUT_MT_TRACK);\n}\n\n \nstatic int report_bt_state(struct bcm5974 *dev, int size)\n{\n\tif (size != sizeof(struct bt_data))\n\t\treturn -EIO;\n\n\tdprintk(7,\n\t\t\"bcm5974: button data: %x %x %x %x\\n\",\n\t\tdev->bt_data->unknown1, dev->bt_data->button,\n\t\tdev->bt_data->rel_x, dev->bt_data->rel_y);\n\n\tinput_report_key(dev->input, BTN_LEFT, dev->bt_data->button);\n\tinput_sync(dev->input);\n\n\treturn 0;\n}\n\nstatic void report_finger_data(struct input_dev *input, int slot,\n\t\t\t       const struct input_mt_pos *pos,\n\t\t\t       const struct tp_finger *f)\n{\n\tinput_mt_slot(input, slot);\n\tinput_mt_report_slot_state(input, MT_TOOL_FINGER, true);\n\n\tinput_report_abs(input, ABS_MT_TOUCH_MAJOR,\n\t\t\t raw2int(f->touch_major) << 1);\n\tinput_report_abs(input, ABS_MT_TOUCH_MINOR,\n\t\t\t raw2int(f->touch_minor) << 1);\n\tinput_report_abs(input, ABS_MT_WIDTH_MAJOR,\n\t\t\t raw2int(f->tool_major) << 1);\n\tinput_report_abs(input, ABS_MT_WIDTH_MINOR,\n\t\t\t raw2int(f->tool_minor) << 1);\n\tinput_report_abs(input, ABS_MT_ORIENTATION,\n\t\t\t MAX_FINGER_ORIENTATION - raw2int(f->orientation));\n\tinput_report_abs(input, ABS_MT_POSITION_X, pos->x);\n\tinput_report_abs(input, ABS_MT_POSITION_Y, pos->y);\n}\n\nstatic void report_synaptics_data(struct input_dev *input,\n\t\t\t\t  const struct bcm5974_config *cfg,\n\t\t\t\t  const struct tp_finger *f, int raw_n)\n{\n\tint abs_p = 0, abs_w = 0;\n\n\tif (raw_n) {\n\t\tint p = raw2int(f->touch_major);\n\t\tint w = raw2int(f->tool_major);\n\t\tif (p > 0 && raw2int(f->origin)) {\n\t\t\tabs_p = clamp_val(256 * p / cfg->p.max, 0, 255);\n\t\t\tabs_w = clamp_val(16 * w / cfg->w.max, 0, 15);\n\t\t}\n\t}\n\n\tinput_report_abs(input, ABS_PRESSURE, abs_p);\n\tinput_report_abs(input, ABS_TOOL_WIDTH, abs_w);\n}\n\n \nstatic int report_tp_state(struct bcm5974 *dev, int size)\n{\n\tconst struct bcm5974_config *c = &dev->cfg;\n\tconst struct tp_finger *f;\n\tstruct input_dev *input = dev->input;\n\tint raw_n, i, n = 0;\n\n\tif (size < c->tp_header || (size - c->tp_header) % c->tp_fsize != 0)\n\t\treturn -EIO;\n\n\traw_n = (size - c->tp_header) / c->tp_fsize;\n\n\tfor (i = 0; i < raw_n; i++) {\n\t\tf = get_tp_finger(dev, i);\n\t\tif (raw2int(f->touch_major) == 0)\n\t\t\tcontinue;\n\t\tdev->pos[n].x = raw2int(f->abs_x);\n\t\tdev->pos[n].y = c->y.min + c->y.max - raw2int(f->abs_y);\n\t\tdev->index[n++] = f;\n\t}\n\n\tinput_mt_assign_slots(input, dev->slots, dev->pos, n, 0);\n\n\tfor (i = 0; i < n; i++)\n\t\treport_finger_data(input, dev->slots[i],\n\t\t\t\t   &dev->pos[i], dev->index[i]);\n\n\tinput_mt_sync_frame(input);\n\n\treport_synaptics_data(input, c, get_tp_finger(dev, 0), raw_n);\n\n\t \n\tif (c->caps & HAS_INTEGRATED_BUTTON) {\n\t\tint ibt = raw2int(dev->tp_data[c->tp_button]);\n\t\tinput_report_key(input, BTN_LEFT, ibt);\n\t}\n\n\tinput_sync(input);\n\n\treturn 0;\n}\n\nstatic int bcm5974_wellspring_mode(struct bcm5974 *dev, bool on)\n{\n\tconst struct bcm5974_config *c = &dev->cfg;\n\tint retval = 0, size;\n\tchar *data;\n\n\t \n\tif (c->tp_type == TYPE3)\n\t\treturn 0;\n\n\tdata = kmalloc(c->um_size, GFP_KERNEL);\n\tif (!data) {\n\t\tdev_err(&dev->intf->dev, \"out of memory\\n\");\n\t\tretval = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\t \n\tsize = usb_control_msg(dev->udev, usb_rcvctrlpipe(dev->udev, 0),\n\t\t\tBCM5974_WELLSPRING_MODE_READ_REQUEST_ID,\n\t\t\tUSB_DIR_IN | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\n\t\t\tc->um_req_val, c->um_req_idx, data, c->um_size, 5000);\n\n\tif (size != c->um_size) {\n\t\tdev_err(&dev->intf->dev, \"could not read from device\\n\");\n\t\tretval = -EIO;\n\t\tgoto out;\n\t}\n\n\t \n\tdata[c->um_switch_idx] = on ? c->um_switch_on : c->um_switch_off;\n\n\t \n\tsize = usb_control_msg(dev->udev, usb_sndctrlpipe(dev->udev, 0),\n\t\t\tBCM5974_WELLSPRING_MODE_WRITE_REQUEST_ID,\n\t\t\tUSB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\n\t\t\tc->um_req_val, c->um_req_idx, data, c->um_size, 5000);\n\n\tif (size != c->um_size) {\n\t\tdev_err(&dev->intf->dev, \"could not write to device\\n\");\n\t\tretval = -EIO;\n\t\tgoto out;\n\t}\n\n\tdprintk(2, \"bcm5974: switched to %s mode.\\n\",\n\t\ton ? \"wellspring\" : \"normal\");\n\n out:\n\tkfree(data);\n\treturn retval;\n}\n\nstatic void bcm5974_irq_button(struct urb *urb)\n{\n\tstruct bcm5974 *dev = urb->context;\n\tstruct usb_interface *intf = dev->intf;\n\tint error;\n\n\tswitch (urb->status) {\n\tcase 0:\n\t\tbreak;\n\tcase -EOVERFLOW:\n\tcase -ECONNRESET:\n\tcase -ENOENT:\n\tcase -ESHUTDOWN:\n\t\tdev_dbg(&intf->dev, \"button urb shutting down: %d\\n\",\n\t\t\turb->status);\n\t\treturn;\n\tdefault:\n\t\tdev_dbg(&intf->dev, \"button urb status: %d\\n\", urb->status);\n\t\tgoto exit;\n\t}\n\n\tif (report_bt_state(dev, dev->bt_urb->actual_length))\n\t\tdprintk(1, \"bcm5974: bad button package, length: %d\\n\",\n\t\t\tdev->bt_urb->actual_length);\n\nexit:\n\terror = usb_submit_urb(dev->bt_urb, GFP_ATOMIC);\n\tif (error)\n\t\tdev_err(&intf->dev, \"button urb failed: %d\\n\", error);\n}\n\nstatic void bcm5974_irq_trackpad(struct urb *urb)\n{\n\tstruct bcm5974 *dev = urb->context;\n\tstruct usb_interface *intf = dev->intf;\n\tint error;\n\n\tswitch (urb->status) {\n\tcase 0:\n\t\tbreak;\n\tcase -EOVERFLOW:\n\tcase -ECONNRESET:\n\tcase -ENOENT:\n\tcase -ESHUTDOWN:\n\t\tdev_dbg(&intf->dev, \"trackpad urb shutting down: %d\\n\",\n\t\t\turb->status);\n\t\treturn;\n\tdefault:\n\t\tdev_dbg(&intf->dev, \"trackpad urb status: %d\\n\", urb->status);\n\t\tgoto exit;\n\t}\n\n\t \n\tif (dev->tp_urb->actual_length == 2)\n\t\tgoto exit;\n\n\tif (report_tp_state(dev, dev->tp_urb->actual_length))\n\t\tdprintk(1, \"bcm5974: bad trackpad package, length: %d\\n\",\n\t\t\tdev->tp_urb->actual_length);\n\nexit:\n\terror = usb_submit_urb(dev->tp_urb, GFP_ATOMIC);\n\tif (error)\n\t\tdev_err(&intf->dev, \"trackpad urb failed: %d\\n\", error);\n}\n\n \nstatic int bcm5974_start_traffic(struct bcm5974 *dev)\n{\n\tint error;\n\n\terror = bcm5974_wellspring_mode(dev, true);\n\tif (error) {\n\t\tdprintk(1, \"bcm5974: mode switch failed\\n\");\n\t\tgoto err_out;\n\t}\n\n\tif (dev->bt_urb) {\n\t\terror = usb_submit_urb(dev->bt_urb, GFP_KERNEL);\n\t\tif (error)\n\t\t\tgoto err_reset_mode;\n\t}\n\n\terror = usb_submit_urb(dev->tp_urb, GFP_KERNEL);\n\tif (error)\n\t\tgoto err_kill_bt;\n\n\treturn 0;\n\nerr_kill_bt:\n\tusb_kill_urb(dev->bt_urb);\nerr_reset_mode:\n\tbcm5974_wellspring_mode(dev, false);\nerr_out:\n\treturn error;\n}\n\nstatic void bcm5974_pause_traffic(struct bcm5974 *dev)\n{\n\tusb_kill_urb(dev->tp_urb);\n\tusb_kill_urb(dev->bt_urb);\n\tbcm5974_wellspring_mode(dev, false);\n}\n\n \nstatic int bcm5974_open(struct input_dev *input)\n{\n\tstruct bcm5974 *dev = input_get_drvdata(input);\n\tint error;\n\n\terror = usb_autopm_get_interface(dev->intf);\n\tif (error)\n\t\treturn error;\n\n\tmutex_lock(&dev->pm_mutex);\n\n\terror = bcm5974_start_traffic(dev);\n\tif (!error)\n\t\tdev->opened = 1;\n\n\tmutex_unlock(&dev->pm_mutex);\n\n\tif (error)\n\t\tusb_autopm_put_interface(dev->intf);\n\n\treturn error;\n}\n\nstatic void bcm5974_close(struct input_dev *input)\n{\n\tstruct bcm5974 *dev = input_get_drvdata(input);\n\n\tmutex_lock(&dev->pm_mutex);\n\n\tbcm5974_pause_traffic(dev);\n\tdev->opened = 0;\n\n\tmutex_unlock(&dev->pm_mutex);\n\n\tusb_autopm_put_interface(dev->intf);\n}\n\nstatic int bcm5974_suspend(struct usb_interface *iface, pm_message_t message)\n{\n\tstruct bcm5974 *dev = usb_get_intfdata(iface);\n\n\tmutex_lock(&dev->pm_mutex);\n\n\tif (dev->opened)\n\t\tbcm5974_pause_traffic(dev);\n\n\tmutex_unlock(&dev->pm_mutex);\n\n\treturn 0;\n}\n\nstatic int bcm5974_resume(struct usb_interface *iface)\n{\n\tstruct bcm5974 *dev = usb_get_intfdata(iface);\n\tint error = 0;\n\n\tmutex_lock(&dev->pm_mutex);\n\n\tif (dev->opened)\n\t\terror = bcm5974_start_traffic(dev);\n\n\tmutex_unlock(&dev->pm_mutex);\n\n\treturn error;\n}\n\nstatic int bcm5974_probe(struct usb_interface *iface,\n\t\t\t const struct usb_device_id *id)\n{\n\tstruct usb_device *udev = interface_to_usbdev(iface);\n\tconst struct bcm5974_config *cfg;\n\tstruct bcm5974 *dev;\n\tstruct input_dev *input_dev;\n\tint error = -ENOMEM;\n\n\t \n\tcfg = bcm5974_get_config(udev);\n\n\t \n\tdev = kzalloc(sizeof(struct bcm5974), GFP_KERNEL);\n\tinput_dev = input_allocate_device();\n\tif (!dev || !input_dev) {\n\t\tdev_err(&iface->dev, \"out of memory\\n\");\n\t\tgoto err_free_devs;\n\t}\n\n\tdev->udev = udev;\n\tdev->intf = iface;\n\tdev->input = input_dev;\n\tdev->cfg = *cfg;\n\tmutex_init(&dev->pm_mutex);\n\n\t \n\tif (cfg->tp_type == TYPE1) {\n\t\tdev->bt_urb = usb_alloc_urb(0, GFP_KERNEL);\n\t\tif (!dev->bt_urb)\n\t\t\tgoto err_free_devs;\n\t}\n\n\tdev->tp_urb = usb_alloc_urb(0, GFP_KERNEL);\n\tif (!dev->tp_urb)\n\t\tgoto err_free_bt_urb;\n\n\tif (dev->bt_urb) {\n\t\tdev->bt_data = usb_alloc_coherent(dev->udev,\n\t\t\t\t\t  dev->cfg.bt_datalen, GFP_KERNEL,\n\t\t\t\t\t  &dev->bt_urb->transfer_dma);\n\t\tif (!dev->bt_data)\n\t\t\tgoto err_free_urb;\n\t}\n\n\tdev->tp_data = usb_alloc_coherent(dev->udev,\n\t\t\t\t\t  dev->cfg.tp_datalen, GFP_KERNEL,\n\t\t\t\t\t  &dev->tp_urb->transfer_dma);\n\tif (!dev->tp_data)\n\t\tgoto err_free_bt_buffer;\n\n\tif (dev->bt_urb) {\n\t\tusb_fill_int_urb(dev->bt_urb, udev,\n\t\t\t\t usb_rcvintpipe(udev, cfg->bt_ep),\n\t\t\t\t dev->bt_data, dev->cfg.bt_datalen,\n\t\t\t\t bcm5974_irq_button, dev, 1);\n\n\t\tdev->bt_urb->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\n\t}\n\n\tusb_fill_int_urb(dev->tp_urb, udev,\n\t\t\t usb_rcvintpipe(udev, cfg->tp_ep),\n\t\t\t dev->tp_data, dev->cfg.tp_datalen,\n\t\t\t bcm5974_irq_trackpad, dev, 1);\n\n\tdev->tp_urb->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\n\n\t \n\tusb_make_path(udev, dev->phys, sizeof(dev->phys));\n\tstrlcat(dev->phys, \"/input0\", sizeof(dev->phys));\n\n\tinput_dev->name = \"bcm5974\";\n\tinput_dev->phys = dev->phys;\n\tusb_to_input_id(dev->udev, &input_dev->id);\n\t \n\tinput_dev->id.version = cfg->caps;\n\tinput_dev->dev.parent = &iface->dev;\n\n\tinput_set_drvdata(input_dev, dev);\n\n\tinput_dev->open = bcm5974_open;\n\tinput_dev->close = bcm5974_close;\n\n\tsetup_events_to_report(input_dev, cfg);\n\n\terror = input_register_device(dev->input);\n\tif (error)\n\t\tgoto err_free_buffer;\n\n\t \n\tusb_set_intfdata(iface, dev);\n\n\treturn 0;\n\nerr_free_buffer:\n\tusb_free_coherent(dev->udev, dev->cfg.tp_datalen,\n\t\tdev->tp_data, dev->tp_urb->transfer_dma);\nerr_free_bt_buffer:\n\tif (dev->bt_urb)\n\t\tusb_free_coherent(dev->udev, dev->cfg.bt_datalen,\n\t\t\t\t  dev->bt_data, dev->bt_urb->transfer_dma);\nerr_free_urb:\n\tusb_free_urb(dev->tp_urb);\nerr_free_bt_urb:\n\tusb_free_urb(dev->bt_urb);\nerr_free_devs:\n\tusb_set_intfdata(iface, NULL);\n\tinput_free_device(input_dev);\n\tkfree(dev);\n\treturn error;\n}\n\nstatic void bcm5974_disconnect(struct usb_interface *iface)\n{\n\tstruct bcm5974 *dev = usb_get_intfdata(iface);\n\n\tusb_set_intfdata(iface, NULL);\n\n\tinput_unregister_device(dev->input);\n\tusb_free_coherent(dev->udev, dev->cfg.tp_datalen,\n\t\t\t  dev->tp_data, dev->tp_urb->transfer_dma);\n\tif (dev->bt_urb)\n\t\tusb_free_coherent(dev->udev, dev->cfg.bt_datalen,\n\t\t\t\t  dev->bt_data, dev->bt_urb->transfer_dma);\n\tusb_free_urb(dev->tp_urb);\n\tusb_free_urb(dev->bt_urb);\n\tkfree(dev);\n}\n\nstatic struct usb_driver bcm5974_driver = {\n\t.name\t\t\t= \"bcm5974\",\n\t.probe\t\t\t= bcm5974_probe,\n\t.disconnect\t\t= bcm5974_disconnect,\n\t.suspend\t\t= bcm5974_suspend,\n\t.resume\t\t\t= bcm5974_resume,\n\t.id_table\t\t= bcm5974_table,\n\t.supports_autosuspend\t= 1,\n};\n\nmodule_usb_driver(bcm5974_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}