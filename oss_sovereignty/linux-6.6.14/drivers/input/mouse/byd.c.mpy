{
  "module_name": "byd.c",
  "hash_id": "eedb5254a1277e58ddbf973eb376a98613c780b1cf66224ccedbad4f609edbfe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/byd.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/input.h>\n#include <linux/libps2.h>\n#include <linux/serio.h>\n#include <linux/slab.h>\n\n#include \"psmouse.h\"\n#include \"byd.h\"\n\n \n#define PS2_Y_OVERFLOW\tBIT_MASK(7)\n#define PS2_X_OVERFLOW\tBIT_MASK(6)\n#define PS2_Y_SIGN\tBIT_MASK(5)\n#define PS2_X_SIGN\tBIT_MASK(4)\n#define PS2_ALWAYS_1\tBIT_MASK(3)\n#define PS2_MIDDLE\tBIT_MASK(2)\n#define PS2_RIGHT\tBIT_MASK(1)\n#define PS2_LEFT\tBIT_MASK(0)\n\n \n\n \n#define BYD_PAD_WIDTH\t\t11264\n#define BYD_PAD_HEIGHT\t\t6656\n#define BYD_PAD_RESOLUTION\t111\n\n \n#define BYD_DT\t\t\t11\n \n#define BYD_TOUCH_TIMEOUT\tmsecs_to_jiffies(64)\n\n \n\n \n#define BYD_CMD_SET_OFFSCREEN_SWIPE\t\t0x10cc\n \n#define BYD_CMD_SET_TAP_DRAG_DELAY_TIME\t\t0x10cf\n \n#define BYD_CMD_SET_PHYSICAL_BUTTONS\t\t0x10d0\n \n#define BYD_CMD_SET_ABSOLUTE_MODE\t\t0x10d1\n \n#define BYD_CMD_SET_TWO_FINGER_SCROLL\t\t0x10d2\n \n#define BYD_CMD_SET_HANDEDNESS\t\t\t0x10d3\n \n#define BYD_CMD_SET_TAP\t\t\t\t0x10d4\n \n#define BYD_CMD_SET_TAP_DRAG\t\t\t0x10d5\n \n#define BYD_CMD_SET_TOUCH_SENSITIVITY\t\t0x10d6\n \n#define BYD_CMD_SET_ONE_FINGER_SCROLL\t\t0x10d7\n \n#define BYD_CMD_SET_ONE_FINGER_SCROLL_FUNC\t0x10d8\n \n#define BYD_CMD_SET_SLIDING_SPEED\t\t0x10da\n \n#define BYD_CMD_SET_EDGE_MOTION\t\t\t0x10db\n \n#define BYD_CMD_SET_LEFT_EDGE_REGION\t\t0x10dc\n \n#define BYD_CMD_SET_TOP_EDGE_REGION\t\t0x10dd\n \n#define BYD_CMD_SET_PALM_CHECK\t\t\t0x10de\n \n#define BYD_CMD_SET_RIGHT_EDGE_REGION\t\t0x10df\n \n#define BYD_CMD_SET_BOTTOM_EDGE_REGION\t\t0x10e1\n \n#define BYD_CMD_SET_MULTITOUCH\t\t\t0x10e3\n \n#define BYD_CMD_SET_EDGE_MOTION_SPEED\t\t0x10e4\n \n#define BYD_CMD_SET_TWO_FINGER_SCROLL_FUNC\t0x10e5\n\n \n#define BYD_PACKET_ABSOLUTE\t\t\t0xf8\n#define BYD_PACKET_RELATIVE\t\t\t0x00\n \n#define BYD_PACKET_PINCH_IN\t\t\t0xd8\n#define BYD_PACKET_PINCH_OUT\t\t\t0x28\n#define BYD_PACKET_ROTATE_CLOCKWISE\t\t0x29\n#define BYD_PACKET_ROTATE_ANTICLOCKWISE\t\t0xd7\n#define BYD_PACKET_TWO_FINGER_SCROLL_RIGHT\t0x2a\n#define BYD_PACKET_TWO_FINGER_SCROLL_DOWN\t0x2b\n#define BYD_PACKET_TWO_FINGER_SCROLL_UP\t\t0xd5\n#define BYD_PACKET_TWO_FINGER_SCROLL_LEFT\t0xd6\n#define BYD_PACKET_THREE_FINGER_SWIPE_RIGHT\t0x2c\n#define BYD_PACKET_THREE_FINGER_SWIPE_DOWN\t0x2d\n#define BYD_PACKET_THREE_FINGER_SWIPE_UP\t0xd3\n#define BYD_PACKET_THREE_FINGER_SWIPE_LEFT\t0xd4\n#define BYD_PACKET_FOUR_FINGER_DOWN\t\t0x33\n#define BYD_PACKET_FOUR_FINGER_UP\t\t0xcd\n#define BYD_PACKET_REGION_SCROLL_RIGHT\t\t0x35\n#define BYD_PACKET_REGION_SCROLL_DOWN\t\t0x36\n#define BYD_PACKET_REGION_SCROLL_UP\t\t0xca\n#define BYD_PACKET_REGION_SCROLL_LEFT\t\t0xcb\n#define BYD_PACKET_RIGHT_CORNER_CLICK\t\t0xd2\n#define BYD_PACKET_LEFT_CORNER_CLICK\t\t0x2e\n#define BYD_PACKET_LEFT_AND_RIGHT_CORNER_CLICK\t0x2f\n#define BYD_PACKET_ONTO_PAD_SWIPE_RIGHT\t\t0x37\n#define BYD_PACKET_ONTO_PAD_SWIPE_DOWN\t\t0x30\n#define BYD_PACKET_ONTO_PAD_SWIPE_UP\t\t0xd0\n#define BYD_PACKET_ONTO_PAD_SWIPE_LEFT\t\t0xc9\n\nstruct byd_data {\n\tstruct timer_list timer;\n\tstruct psmouse *psmouse;\n\ts32 abs_x;\n\ts32 abs_y;\n\ttypeof(jiffies) last_touch_time;\n\tbool btn_left;\n\tbool btn_right;\n\tbool touch;\n};\n\nstatic void byd_report_input(struct psmouse *psmouse)\n{\n\tstruct byd_data *priv = psmouse->private;\n\tstruct input_dev *dev = psmouse->dev;\n\n\tinput_report_key(dev, BTN_TOUCH, priv->touch);\n\tinput_report_key(dev, BTN_TOOL_FINGER, priv->touch);\n\n\tinput_report_abs(dev, ABS_X, priv->abs_x);\n\tinput_report_abs(dev, ABS_Y, priv->abs_y);\n\tinput_report_key(dev, BTN_LEFT, priv->btn_left);\n\tinput_report_key(dev, BTN_RIGHT, priv->btn_right);\n\n\tinput_sync(dev);\n}\n\nstatic void byd_clear_touch(struct timer_list *t)\n{\n\tstruct byd_data *priv = from_timer(priv, t, timer);\n\tstruct psmouse *psmouse = priv->psmouse;\n\n\tserio_pause_rx(psmouse->ps2dev.serio);\n\tpriv->touch = false;\n\n\tbyd_report_input(psmouse);\n\n\tserio_continue_rx(psmouse->ps2dev.serio);\n\n\t \n\tpriv->abs_x = BYD_PAD_WIDTH / 2;\n\tpriv->abs_y = BYD_PAD_HEIGHT / 2;\n}\n\nstatic psmouse_ret_t byd_process_byte(struct psmouse *psmouse)\n{\n\tstruct byd_data *priv = psmouse->private;\n\tu8 *pkt = psmouse->packet;\n\n\tif (psmouse->pktcnt > 0 && !(pkt[0] & PS2_ALWAYS_1)) {\n\t\tpsmouse_warn(psmouse, \"Always_1 bit not 1. pkt[0] = %02x\\n\",\n\t\t\t     pkt[0]);\n\t\treturn PSMOUSE_BAD_DATA;\n\t}\n\n\tif (psmouse->pktcnt < psmouse->pktsize)\n\t\treturn PSMOUSE_GOOD_DATA;\n\n\t \n\tswitch (pkt[3]) {\n\tcase BYD_PACKET_ABSOLUTE:\n\t\t \n\t\tif (!priv->touch) {\n\t\t\t \n\t\t\ttypeof(jiffies) tap_time =\n\t\t\t\tpriv->last_touch_time + BYD_TOUCH_TIMEOUT;\n\t\t\tpriv->touch = time_after(jiffies, tap_time);\n\n\t\t\t \n\t\t\tpriv->abs_x = pkt[1] * (BYD_PAD_WIDTH / 256);\n\t\t\tpriv->abs_y = (255 - pkt[2]) * (BYD_PAD_HEIGHT / 256);\n\t\t}\n\t\tbreak;\n\tcase BYD_PACKET_RELATIVE: {\n\t\t \n\t\t \n\t\tu32 signx = pkt[0] & PS2_X_SIGN ? ~0xFF : 0;\n\t\tu32 signy = pkt[0] & PS2_Y_SIGN ? ~0xFF : 0;\n\t\ts32 dx = signx | (int) pkt[1];\n\t\ts32 dy = signy | (int) pkt[2];\n\n\t\t \n\t\tpriv->abs_x += dx * BYD_DT;\n\t\tpriv->abs_y -= dy * BYD_DT;\n\n\t\tpriv->touch = true;\n\t\tbreak;\n\t}\n\tdefault:\n\t\tpsmouse_warn(psmouse,\n\t\t\t     \"Unrecognized Z: pkt = %02x %02x %02x %02x\\n\",\n\t\t\t     psmouse->packet[0], psmouse->packet[1],\n\t\t\t     psmouse->packet[2], psmouse->packet[3]);\n\t\treturn PSMOUSE_BAD_DATA;\n\t}\n\n\tpriv->btn_left = pkt[0] & PS2_LEFT;\n\tpriv->btn_right = pkt[0] & PS2_RIGHT;\n\n\tbyd_report_input(psmouse);\n\n\t \n\tif (priv->touch) {\n\t\tpriv->last_touch_time = jiffies;\n\t\tmod_timer(&priv->timer, jiffies + BYD_TOUCH_TIMEOUT);\n\t}\n\n\treturn PSMOUSE_FULL_PACKET;\n}\n\nstatic int byd_reset_touchpad(struct psmouse *psmouse)\n{\n\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\tu8 param[4];\n\tsize_t i;\n\n\tstatic const struct {\n\t\tu16 command;\n\t\tu8 arg;\n\t} seq[] = {\n\t\t \n\t\t{ PSMOUSE_CMD_SETRATE, 0xC8 },\n\t\t{ PSMOUSE_CMD_SETRATE, 0x64 },\n\t\t{ PSMOUSE_CMD_SETRATE, 0x50 },\n\t\t{ PSMOUSE_CMD_GETID, 0 },\n\t\t{ PSMOUSE_CMD_ENABLE, 0 },\n\t\t \n\t\t{ 0x10E2, 0x00 },\n\t\t{ 0x10E0, 0x02 },\n\t\t \n\t\t{ 0x14E0, 0x01 },\n\t\t \n\t\t{ BYD_CMD_SET_HANDEDNESS, 0x01 },\n\t\t{ BYD_CMD_SET_PHYSICAL_BUTTONS, 0x04 },\n\t\t{ BYD_CMD_SET_TAP, 0x02 },\n\t\t{ BYD_CMD_SET_ONE_FINGER_SCROLL, 0x04 },\n\t\t{ BYD_CMD_SET_ONE_FINGER_SCROLL_FUNC, 0x04 },\n\t\t{ BYD_CMD_SET_EDGE_MOTION, 0x01 },\n\t\t{ BYD_CMD_SET_PALM_CHECK, 0x00 },\n\t\t{ BYD_CMD_SET_MULTITOUCH, 0x02 },\n\t\t{ BYD_CMD_SET_TWO_FINGER_SCROLL, 0x04 },\n\t\t{ BYD_CMD_SET_TWO_FINGER_SCROLL_FUNC, 0x04 },\n\t\t{ BYD_CMD_SET_LEFT_EDGE_REGION, 0x00 },\n\t\t{ BYD_CMD_SET_TOP_EDGE_REGION, 0x00 },\n\t\t{ BYD_CMD_SET_RIGHT_EDGE_REGION, 0x00 },\n\t\t{ BYD_CMD_SET_BOTTOM_EDGE_REGION, 0x00 },\n\t\t{ BYD_CMD_SET_ABSOLUTE_MODE, 0x02 },\n\t\t \n\t\t{ 0x10E0, 0x00 },\n\t\t{ 0x10E2, 0x01 },\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(seq); ++i) {\n\t\tmemset(param, 0, sizeof(param));\n\t\tparam[0] = seq[i].arg;\n\t\tif (ps2_command(ps2dev, param, seq[i].command))\n\t\t\treturn -EIO;\n\t}\n\n\tpsmouse_set_state(psmouse, PSMOUSE_ACTIVATED);\n\treturn 0;\n}\n\nstatic int byd_reconnect(struct psmouse *psmouse)\n{\n\tint retry = 0, error = 0;\n\n\tpsmouse_dbg(psmouse, \"Reconnect\\n\");\n\tdo {\n\t\tpsmouse_reset(psmouse);\n\t\tif (retry)\n\t\t\tssleep(1);\n\t\terror = byd_detect(psmouse, 0);\n\t} while (error && ++retry < 3);\n\n\tif (error)\n\t\treturn error;\n\n\tpsmouse_dbg(psmouse, \"Reconnected after %d attempts\\n\", retry);\n\n\terror = byd_reset_touchpad(psmouse);\n\tif (error) {\n\t\tpsmouse_err(psmouse, \"Unable to initialize device\\n\");\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic void byd_disconnect(struct psmouse *psmouse)\n{\n\tstruct byd_data *priv = psmouse->private;\n\n\tif (priv) {\n\t\tdel_timer(&priv->timer);\n\t\tkfree(psmouse->private);\n\t\tpsmouse->private = NULL;\n\t}\n}\n\nint byd_detect(struct psmouse *psmouse, bool set_properties)\n{\n\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\tu8 param[4] = {0x03, 0x00, 0x00, 0x00};\n\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -1;\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -1;\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -1;\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -1;\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_GETINFO))\n\t\treturn -1;\n\n\tif (param[1] != 0x03 || param[2] != 0x64)\n\t\treturn -ENODEV;\n\n\tpsmouse_dbg(psmouse, \"BYD touchpad detected\\n\");\n\n\tif (set_properties) {\n\t\tpsmouse->vendor = \"BYD\";\n\t\tpsmouse->name = \"TouchPad\";\n\t}\n\n\treturn 0;\n}\n\nint byd_init(struct psmouse *psmouse)\n{\n\tstruct input_dev *dev = psmouse->dev;\n\tstruct byd_data *priv;\n\n\tif (psmouse_reset(psmouse))\n\t\treturn -EIO;\n\n\tif (byd_reset_touchpad(psmouse))\n\t\treturn -EIO;\n\n\tpriv = kzalloc(sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->psmouse = psmouse;\n\ttimer_setup(&priv->timer, byd_clear_touch, 0);\n\n\tpsmouse->private = priv;\n\tpsmouse->disconnect = byd_disconnect;\n\tpsmouse->reconnect = byd_reconnect;\n\tpsmouse->protocol_handler = byd_process_byte;\n\tpsmouse->pktsize = 4;\n\tpsmouse->resync_time = 0;\n\n\t__set_bit(INPUT_PROP_POINTER, dev->propbit);\n\t \n\t__set_bit(BTN_TOUCH, dev->keybit);\n\t__set_bit(BTN_TOOL_FINGER, dev->keybit);\n\t \n\t__set_bit(BTN_LEFT, dev->keybit);\n\t__set_bit(BTN_RIGHT, dev->keybit);\n\t__clear_bit(BTN_MIDDLE, dev->keybit);\n\n\t \n\t__set_bit(EV_ABS, dev->evbit);\n\tinput_set_abs_params(dev, ABS_X, 0, BYD_PAD_WIDTH, 0, 0);\n\tinput_set_abs_params(dev, ABS_Y, 0, BYD_PAD_HEIGHT, 0, 0);\n\tinput_abs_set_res(dev, ABS_X, BYD_PAD_RESOLUTION);\n\tinput_abs_set_res(dev, ABS_Y, BYD_PAD_RESOLUTION);\n\t \n\t__clear_bit(EV_REL, dev->evbit);\n\t__clear_bit(REL_X, dev->relbit);\n\t__clear_bit(REL_Y, dev->relbit);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}