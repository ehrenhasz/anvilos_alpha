{
  "module_name": "maplemouse.c",
  "hash_id": "8d883e68bfc2b8bede4b5a525ddfdf0bd4576c910557d0a919264bc2dca1772d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/maplemouse.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/timer.h>\n#include <linux/maple.h>\n\nMODULE_AUTHOR(\"Adrian McMenamin <adrian@mcmen.demon.co.uk>\");\nMODULE_DESCRIPTION(\"SEGA Dreamcast mouse driver\");\nMODULE_LICENSE(\"GPL\");\n\nstruct dc_mouse {\n\tstruct input_dev *dev;\n\tstruct maple_device *mdev;\n};\n\nstatic void dc_mouse_callback(struct mapleq *mq)\n{\n\tint buttons, relx, rely, relz;\n\tstruct maple_device *mapledev = mq->dev;\n\tstruct dc_mouse *mse = maple_get_drvdata(mapledev);\n\tstruct input_dev *dev = mse->dev;\n\tunsigned char *res = mq->recvbuf->buf;\n\n\tbuttons = ~res[8];\n\trelx = *(unsigned short *)(res + 12) - 512;\n\trely = *(unsigned short *)(res + 14) - 512;\n\trelz = *(unsigned short *)(res + 16) - 512;\n\n\tinput_report_key(dev, BTN_LEFT,   buttons & 4);\n\tinput_report_key(dev, BTN_MIDDLE, buttons & 9);\n\tinput_report_key(dev, BTN_RIGHT,  buttons & 2);\n\tinput_report_rel(dev, REL_X,      relx);\n\tinput_report_rel(dev, REL_Y,      rely);\n\tinput_report_rel(dev, REL_WHEEL,  relz);\n\tinput_sync(dev);\n}\n\nstatic int dc_mouse_open(struct input_dev *dev)\n{\n\tstruct dc_mouse *mse = maple_get_drvdata(to_maple_dev(&dev->dev));\n\n\tmaple_getcond_callback(mse->mdev, dc_mouse_callback, HZ/50,\n\t\tMAPLE_FUNC_MOUSE);\n\n\treturn 0;\n}\n\nstatic void dc_mouse_close(struct input_dev *dev)\n{\n\tstruct dc_mouse *mse = maple_get_drvdata(to_maple_dev(&dev->dev));\n\n\tmaple_getcond_callback(mse->mdev, dc_mouse_callback, 0,\n\t\tMAPLE_FUNC_MOUSE);\n}\n\n \nstatic int probe_maple_mouse(struct device *dev)\n{\n\tstruct maple_device *mdev = to_maple_dev(dev);\n\tstruct maple_driver *mdrv = to_maple_driver(dev->driver);\n\tint error;\n\tstruct input_dev *input_dev;\n\tstruct dc_mouse *mse;\n\n\tmse = kzalloc(sizeof(struct dc_mouse), GFP_KERNEL);\n\tif (!mse) {\n\t\terror = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\tinput_dev = input_allocate_device();\n\tif (!input_dev) {\n\t\terror = -ENOMEM;\n\t\tgoto fail_nomem;\n\t}\n\n\tmse->dev = input_dev;\n\tmse->mdev = mdev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\n\tinput_dev->keybit[BIT_WORD(BTN_MOUSE)] = BIT_MASK(BTN_LEFT) |\n\t\tBIT_MASK(BTN_RIGHT) | BIT_MASK(BTN_MIDDLE);\n\tinput_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y) |\n\t\tBIT_MASK(REL_WHEEL);\n\tinput_dev->open = dc_mouse_open;\n\tinput_dev->close = dc_mouse_close;\n\tinput_dev->name = mdev->product_name;\n\tinput_dev->id.bustype = BUS_HOST;\n\terror =\tinput_register_device(input_dev);\n\tif (error)\n\t\tgoto fail_register;\n\n\tmdev->driver = mdrv;\n\tmaple_set_drvdata(mdev, mse);\n\n\treturn error;\n\nfail_register:\n\tinput_free_device(input_dev);\nfail_nomem:\n\tkfree(mse);\nfail:\n\treturn error;\n}\n\nstatic int remove_maple_mouse(struct device *dev)\n{\n\tstruct maple_device *mdev = to_maple_dev(dev);\n\tstruct dc_mouse *mse = maple_get_drvdata(mdev);\n\n\tmdev->callback = NULL;\n\tinput_unregister_device(mse->dev);\n\tmaple_set_drvdata(mdev, NULL);\n\tkfree(mse);\n\n\treturn 0;\n}\n\nstatic struct maple_driver dc_mouse_driver = {\n\t.function =\tMAPLE_FUNC_MOUSE,\n\t.drv = {\n\t\t.name = \"Dreamcast_mouse\",\n\t\t.probe = probe_maple_mouse,\n\t\t.remove = remove_maple_mouse,\n\t},\n};\n\nstatic int __init dc_mouse_init(void)\n{\n\treturn maple_driver_register(&dc_mouse_driver);\n}\n\nstatic void __exit dc_mouse_exit(void)\n{\n\tmaple_driver_unregister(&dc_mouse_driver);\n}\n\nmodule_init(dc_mouse_init);\nmodule_exit(dc_mouse_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}