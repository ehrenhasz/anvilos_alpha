{
  "module_name": "focaltech.c",
  "hash_id": "17a8ec1d6ea0da4e6486e5a806462d6daea43601206851a1f0ca6644bf277a4e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/focaltech.c",
  "human_readable_source": "\n \n\n\n#include <linux/device.h>\n#include <linux/libps2.h>\n#include <linux/input/mt.h>\n#include <linux/serio.h>\n#include <linux/slab.h>\n#include \"psmouse.h\"\n#include \"focaltech.h\"\n\nstatic const char * const focaltech_pnp_ids[] = {\n\t\"FLT0101\",\n\t\"FLT0102\",\n\t\"FLT0103\",\n\tNULL\n};\n\n \nint focaltech_detect(struct psmouse *psmouse, bool set_properties)\n{\n\tif (!psmouse_matches_pnp_id(psmouse, focaltech_pnp_ids))\n\t\treturn -ENODEV;\n\n\tif (set_properties) {\n\t\tpsmouse->vendor = \"FocalTech\";\n\t\tpsmouse->name = \"Touchpad\";\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_MOUSE_PS2_FOCALTECH\n\n \n#define FOC_TOUCH 0x3  \n#define FOC_ABS 0x6  \n#define FOC_REL 0x9  \n\n#define FOC_MAX_FINGERS 5\n\n \nstruct focaltech_finger_state {\n\t \n\tbool active;\n\n\t \n\tbool valid;\n\n\t \n\tunsigned int x;\n\tunsigned int y;\n};\n\n \nstruct focaltech_hw_state {\n\t \n\tstruct focaltech_finger_state fingers[FOC_MAX_FINGERS];\n\n\t \n\tunsigned int width;\n\n\t \n\tbool pressed;\n};\n\nstruct focaltech_data {\n\tunsigned int x_max, y_max;\n\tstruct focaltech_hw_state state;\n};\n\nstatic void focaltech_report_state(struct psmouse *psmouse)\n{\n\tstruct focaltech_data *priv = psmouse->private;\n\tstruct focaltech_hw_state *state = &priv->state;\n\tstruct input_dev *dev = psmouse->dev;\n\tint i;\n\n\tfor (i = 0; i < FOC_MAX_FINGERS; i++) {\n\t\tstruct focaltech_finger_state *finger = &state->fingers[i];\n\t\tbool active = finger->active && finger->valid;\n\n\t\tinput_mt_slot(dev, i);\n\t\tinput_mt_report_slot_state(dev, MT_TOOL_FINGER, active);\n\t\tif (active) {\n\t\t\tunsigned int clamped_x, clamped_y;\n\t\t\t \n\t\t\tclamped_x = clamp(finger->x, 0U, priv->x_max);\n\t\t\tclamped_y = clamp(finger->y, 0U, priv->y_max);\n\t\t\tinput_report_abs(dev, ABS_MT_POSITION_X, clamped_x);\n\t\t\tinput_report_abs(dev, ABS_MT_POSITION_Y,\n\t\t\t\t\t priv->y_max - clamped_y);\n\t\t\tinput_report_abs(dev, ABS_TOOL_WIDTH, state->width);\n\t\t}\n\t}\n\tinput_mt_report_pointer_emulation(dev, true);\n\n\tinput_report_key(dev, BTN_LEFT, state->pressed);\n\tinput_sync(dev);\n}\n\nstatic void focaltech_process_touch_packet(struct psmouse *psmouse,\n\t\t\t\t\t   unsigned char *packet)\n{\n\tstruct focaltech_data *priv = psmouse->private;\n\tstruct focaltech_hw_state *state = &priv->state;\n\tunsigned char fingers = packet[1];\n\tint i;\n\n\tstate->pressed = (packet[0] >> 4) & 1;\n\n\t \n\tfor (i = 0; i < FOC_MAX_FINGERS; i++) {\n\t\tstate->fingers[i].active = fingers & 0x1;\n\t\tif (!state->fingers[i].active) {\n\t\t\t \n\t\t\tstate->fingers[i].valid = false;\n\t\t}\n\t\tfingers >>= 1;\n\t}\n}\n\nstatic void focaltech_process_abs_packet(struct psmouse *psmouse,\n\t\t\t\t\t unsigned char *packet)\n{\n\tstruct focaltech_data *priv = psmouse->private;\n\tstruct focaltech_hw_state *state = &priv->state;\n\tunsigned int finger;\n\n\tfinger = (packet[1] >> 4) - 1;\n\tif (finger >= FOC_MAX_FINGERS) {\n\t\tpsmouse_err(psmouse, \"Invalid finger in abs packet: %d\\n\",\n\t\t\t    finger);\n\t\treturn;\n\t}\n\n\tstate->pressed = (packet[0] >> 4) & 1;\n\n\tstate->fingers[finger].x = ((packet[1] & 0xf) << 8) | packet[2];\n\tstate->fingers[finger].y = (packet[3] << 8) | packet[4];\n\tstate->width = packet[5] >> 4;\n\tstate->fingers[finger].valid = true;\n}\n\nstatic void focaltech_process_rel_packet(struct psmouse *psmouse,\n\t\t\t\t\t unsigned char *packet)\n{\n\tstruct focaltech_data *priv = psmouse->private;\n\tstruct focaltech_hw_state *state = &priv->state;\n\tint finger1, finger2;\n\n\tstate->pressed = packet[0] >> 7;\n\tfinger1 = ((packet[0] >> 4) & 0x7) - 1;\n\tif (finger1 < FOC_MAX_FINGERS) {\n\t\tstate->fingers[finger1].x += (s8)packet[1];\n\t\tstate->fingers[finger1].y += (s8)packet[2];\n\t} else {\n\t\tpsmouse_err(psmouse, \"First finger in rel packet invalid: %d\\n\",\n\t\t\t    finger1);\n\t}\n\n\t \n\tfinger2 = ((packet[3] >> 4) & 0x7) - 1;\n\tif (finger2 < FOC_MAX_FINGERS) {\n\t\tstate->fingers[finger2].x += (s8)packet[4];\n\t\tstate->fingers[finger2].y += (s8)packet[5];\n\t}\n}\n\nstatic void focaltech_process_packet(struct psmouse *psmouse)\n{\n\tunsigned char *packet = psmouse->packet;\n\n\tswitch (packet[0] & 0xf) {\n\tcase FOC_TOUCH:\n\t\tfocaltech_process_touch_packet(psmouse, packet);\n\t\tbreak;\n\n\tcase FOC_ABS:\n\t\tfocaltech_process_abs_packet(psmouse, packet);\n\t\tbreak;\n\n\tcase FOC_REL:\n\t\tfocaltech_process_rel_packet(psmouse, packet);\n\t\tbreak;\n\n\tdefault:\n\t\tpsmouse_err(psmouse, \"Unknown packet type: %02x\\n\", packet[0]);\n\t\tbreak;\n\t}\n\n\tfocaltech_report_state(psmouse);\n}\n\nstatic psmouse_ret_t focaltech_process_byte(struct psmouse *psmouse)\n{\n\tif (psmouse->pktcnt >= 6) {  \n\t\tfocaltech_process_packet(psmouse);\n\t\treturn PSMOUSE_FULL_PACKET;\n\t}\n\n\t \n\treturn PSMOUSE_GOOD_DATA;\n}\n\nstatic int focaltech_switch_protocol(struct psmouse *psmouse)\n{\n\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\tunsigned char param[3];\n\n\tparam[0] = 0;\n\tif (ps2_command(ps2dev, param, 0x10f8))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, 0x10f8))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, 0x10f8))\n\t\treturn -EIO;\n\n\tparam[0] = 1;\n\tif (ps2_command(ps2dev, param, 0x10f8))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETSCALE11))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_ENABLE))\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\nstatic void focaltech_reset(struct psmouse *psmouse)\n{\n\tps2_command(&psmouse->ps2dev, NULL, PSMOUSE_CMD_RESET_DIS);\n\tpsmouse_reset(psmouse);\n}\n\nstatic void focaltech_disconnect(struct psmouse *psmouse)\n{\n\tfocaltech_reset(psmouse);\n\tkfree(psmouse->private);\n\tpsmouse->private = NULL;\n}\n\nstatic int focaltech_reconnect(struct psmouse *psmouse)\n{\n\tint error;\n\n\tfocaltech_reset(psmouse);\n\n\terror = focaltech_switch_protocol(psmouse);\n\tif (error) {\n\t\tpsmouse_err(psmouse, \"Unable to initialize the device\\n\");\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic void focaltech_set_input_params(struct psmouse *psmouse)\n{\n\tstruct input_dev *dev = psmouse->dev;\n\tstruct focaltech_data *priv = psmouse->private;\n\n\t \n\t__clear_bit(EV_REL, dev->evbit);\n\t__clear_bit(REL_X, dev->relbit);\n\t__clear_bit(REL_Y, dev->relbit);\n\t__clear_bit(BTN_RIGHT, dev->keybit);\n\t__clear_bit(BTN_MIDDLE, dev->keybit);\n\n\t \n\t__set_bit(EV_ABS, dev->evbit);\n\tinput_set_abs_params(dev, ABS_MT_POSITION_X, 0, priv->x_max, 0, 0);\n\tinput_set_abs_params(dev, ABS_MT_POSITION_Y, 0, priv->y_max, 0, 0);\n\tinput_set_abs_params(dev, ABS_TOOL_WIDTH, 0, 15, 0, 0);\n\tinput_mt_init_slots(dev, 5, INPUT_MT_POINTER);\n\t__set_bit(INPUT_PROP_BUTTONPAD, dev->propbit);\n}\n\nstatic int focaltech_read_register(struct ps2dev *ps2dev, int reg,\n\t\t\t\t   unsigned char *param)\n{\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETSCALE11))\n\t\treturn -EIO;\n\n\tparam[0] = 0;\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -EIO;\n\n\tparam[0] = reg;\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\n\t\treturn -EIO;\n\n\tif (ps2_command(ps2dev, param, PSMOUSE_CMD_GETINFO))\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\nstatic int focaltech_read_size(struct psmouse *psmouse)\n{\n\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\tstruct focaltech_data *priv = psmouse->private;\n\tchar param[3];\n\n\tif (focaltech_read_register(ps2dev, 2, param))\n\t\treturn -EIO;\n\n\t \n\tpriv->x_max = (unsigned char)param[1] * 128;\n\tpriv->y_max = (unsigned char)param[2] * 128;\n\n\treturn 0;\n}\n\nstatic void focaltech_set_resolution(struct psmouse *psmouse,\n\t\t\t\t     unsigned int resolution)\n{\n\t \n}\n\nstatic void focaltech_set_rate(struct psmouse *psmouse, unsigned int rate)\n{\n\t \n}\n\nstatic void focaltech_set_scale(struct psmouse *psmouse,\n\t\t\t\tenum psmouse_scale scale)\n{\n\t \n}\n\nint focaltech_init(struct psmouse *psmouse)\n{\n\tstruct focaltech_data *priv;\n\tint error;\n\n\tpsmouse->private = priv = kzalloc(sizeof(struct focaltech_data),\n\t\t\t\t\t  GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tfocaltech_reset(psmouse);\n\n\terror = focaltech_read_size(psmouse);\n\tif (error) {\n\t\tpsmouse_err(psmouse,\n\t\t\t    \"Unable to read the size of the touchpad\\n\");\n\t\tgoto fail;\n\t}\n\n\terror = focaltech_switch_protocol(psmouse);\n\tif (error) {\n\t\tpsmouse_err(psmouse, \"Unable to initialize the device\\n\");\n\t\tgoto fail;\n\t}\n\n\tfocaltech_set_input_params(psmouse);\n\n\tpsmouse->protocol_handler = focaltech_process_byte;\n\tpsmouse->pktsize = 6;\n\tpsmouse->disconnect = focaltech_disconnect;\n\tpsmouse->reconnect = focaltech_reconnect;\n\tpsmouse->cleanup = focaltech_reset;\n\t \n\tpsmouse->resync_time = 0;\n\t \n\tpsmouse->set_resolution = focaltech_set_resolution;\n\tpsmouse->set_rate = focaltech_set_rate;\n\tpsmouse->set_scale = focaltech_set_scale;\n\n\treturn 0;\n\nfail:\n\tfocaltech_reset(psmouse);\n\tkfree(priv);\n\treturn error;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}