{
  "module_name": "touchkit_ps2.c",
  "hash_id": "aa25fcf2fd84c32aab6056c0a1883048f852badcb1c98100f3312a9ba1f66fcc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/touchkit_ps2.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n\n#include <linux/input.h>\n#include <linux/serio.h>\n#include <linux/libps2.h>\n\n#include \"psmouse.h\"\n#include \"touchkit_ps2.h\"\n\n#define TOUCHKIT_MAX_XC\t\t\t0x07ff\n#define TOUCHKIT_MAX_YC\t\t\t0x07ff\n\n#define TOUCHKIT_CMD\t\t\t0x0a\n#define TOUCHKIT_CMD_LENGTH\t\t1\n\n#define TOUCHKIT_CMD_ACTIVE\t\t'A'\n#define TOUCHKIT_CMD_FIRMWARE_VERSION\t'D'\n#define TOUCHKIT_CMD_CONTROLLER_TYPE\t'E'\n\n#define TOUCHKIT_SEND_PARMS(s, r, c)\t((s) << 12 | (r) << 8 | (c))\n\n#define TOUCHKIT_GET_TOUCHED(packet)\t(((packet)[0]) & 0x01)\n#define TOUCHKIT_GET_X(packet)\t\t(((packet)[1] << 7) | (packet)[2])\n#define TOUCHKIT_GET_Y(packet)\t\t(((packet)[3] << 7) | (packet)[4])\n\nstatic psmouse_ret_t touchkit_ps2_process_byte(struct psmouse *psmouse)\n{\n\tunsigned char *packet = psmouse->packet;\n\tstruct input_dev *dev = psmouse->dev;\n\n\tif (psmouse->pktcnt != 5)\n\t\treturn PSMOUSE_GOOD_DATA;\n\n\tinput_report_abs(dev, ABS_X, TOUCHKIT_GET_X(packet));\n\tinput_report_abs(dev, ABS_Y, TOUCHKIT_GET_Y(packet));\n\tinput_report_key(dev, BTN_TOUCH, TOUCHKIT_GET_TOUCHED(packet));\n\tinput_sync(dev);\n\n\treturn PSMOUSE_FULL_PACKET;\n}\n\nint touchkit_ps2_detect(struct psmouse *psmouse, bool set_properties)\n{\n\tstruct input_dev *dev = psmouse->dev;\n\tunsigned char param[3];\n\tint command;\n\n\tparam[0] = TOUCHKIT_CMD_LENGTH;\n\tparam[1] = TOUCHKIT_CMD_ACTIVE;\n\tcommand = TOUCHKIT_SEND_PARMS(2, 3, TOUCHKIT_CMD);\n\n\tif (ps2_command(&psmouse->ps2dev, param, command))\n\t\treturn -ENODEV;\n\n\tif (param[0] != TOUCHKIT_CMD || param[1] != 0x01 ||\n\t    param[2] != TOUCHKIT_CMD_ACTIVE)\n\t\treturn -ENODEV;\n\n\tif (set_properties) {\n\t\tdev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\n\t\tdev->keybit[BIT_WORD(BTN_MOUSE)] = 0;\n\t\tdev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\n\t\tinput_set_abs_params(dev, ABS_X, 0, TOUCHKIT_MAX_XC, 0, 0);\n\t\tinput_set_abs_params(dev, ABS_Y, 0, TOUCHKIT_MAX_YC, 0, 0);\n\n\t\tpsmouse->vendor = \"eGalax\";\n\t\tpsmouse->name = \"Touchscreen\";\n\t\tpsmouse->protocol_handler = touchkit_ps2_process_byte;\n\t\tpsmouse->pktsize = 5;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}