{
  "module_name": "gpio_mouse.c",
  "hash_id": "fd98a733d80d7a984786d02a0de8c2ff426bb5f912347870eff56cd70dde6cdb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/gpio_mouse.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/input.h>\n#include <linux/gpio/consumer.h>\n#include <linux/property.h>\n#include <linux/of.h>\n\n \nstruct gpio_mouse {\n\tu32 scan_ms;\n\tstruct gpio_desc *up;\n\tstruct gpio_desc *down;\n\tstruct gpio_desc *left;\n\tstruct gpio_desc *right;\n\tstruct gpio_desc *bleft;\n\tstruct gpio_desc *bmiddle;\n\tstruct gpio_desc *bright;\n};\n\n \nstatic void gpio_mouse_scan(struct input_dev *input)\n{\n\tstruct gpio_mouse *gpio = input_get_drvdata(input);\n\tint x, y;\n\n\tif (gpio->bleft)\n\t\tinput_report_key(input, BTN_LEFT,\n\t\t\t\t gpiod_get_value(gpio->bleft));\n\tif (gpio->bmiddle)\n\t\tinput_report_key(input, BTN_MIDDLE,\n\t\t\t\t gpiod_get_value(gpio->bmiddle));\n\tif (gpio->bright)\n\t\tinput_report_key(input, BTN_RIGHT,\n\t\t\t\t gpiod_get_value(gpio->bright));\n\n\tx = gpiod_get_value(gpio->right) - gpiod_get_value(gpio->left);\n\ty = gpiod_get_value(gpio->down) - gpiod_get_value(gpio->up);\n\n\tinput_report_rel(input, REL_X, x);\n\tinput_report_rel(input, REL_Y, y);\n\tinput_sync(input);\n}\n\nstatic int gpio_mouse_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct gpio_mouse *gmouse;\n\tstruct input_dev *input;\n\tint error;\n\n\tgmouse = devm_kzalloc(dev, sizeof(*gmouse), GFP_KERNEL);\n\tif (!gmouse)\n\t\treturn -ENOMEM;\n\n\t \n\terror = device_property_read_u32(dev, \"scan-interval-ms\",\n\t\t\t\t\t &gmouse->scan_ms);\n\tif (error || gmouse->scan_ms == 0) {\n\t\tdev_warn(dev, \"invalid scan time, set to 50 ms\\n\");\n\t\tgmouse->scan_ms = 50;\n\t}\n\n\tgmouse->up = devm_gpiod_get(dev, \"up\", GPIOD_IN);\n\tif (IS_ERR(gmouse->up))\n\t\treturn PTR_ERR(gmouse->up);\n\tgmouse->down = devm_gpiod_get(dev, \"down\", GPIOD_IN);\n\tif (IS_ERR(gmouse->down))\n\t\treturn PTR_ERR(gmouse->down);\n\tgmouse->left = devm_gpiod_get(dev, \"left\", GPIOD_IN);\n\tif (IS_ERR(gmouse->left))\n\t\treturn PTR_ERR(gmouse->left);\n\tgmouse->right = devm_gpiod_get(dev, \"right\", GPIOD_IN);\n\tif (IS_ERR(gmouse->right))\n\t\treturn PTR_ERR(gmouse->right);\n\n\tgmouse->bleft = devm_gpiod_get_optional(dev, \"button-left\", GPIOD_IN);\n\tif (IS_ERR(gmouse->bleft))\n\t\treturn PTR_ERR(gmouse->bleft);\n\tgmouse->bmiddle = devm_gpiod_get_optional(dev, \"button-middle\",\n\t\t\t\t\t\t  GPIOD_IN);\n\tif (IS_ERR(gmouse->bmiddle))\n\t\treturn PTR_ERR(gmouse->bmiddle);\n\tgmouse->bright = devm_gpiod_get_optional(dev, \"button-right\",\n\t\t\t\t\t\t GPIOD_IN);\n\tif (IS_ERR(gmouse->bright))\n\t\treturn PTR_ERR(gmouse->bright);\n\n\tinput = devm_input_allocate_device(dev);\n\tif (!input)\n\t\treturn -ENOMEM;\n\n\tinput->name = pdev->name;\n\tinput->id.bustype = BUS_HOST;\n\n\tinput_set_drvdata(input, gmouse);\n\n\tinput_set_capability(input, EV_REL, REL_X);\n\tinput_set_capability(input, EV_REL, REL_Y);\n\tif (gmouse->bleft)\n\t\tinput_set_capability(input, EV_KEY, BTN_LEFT);\n\tif (gmouse->bmiddle)\n\t\tinput_set_capability(input, EV_KEY, BTN_MIDDLE);\n\tif (gmouse->bright)\n\t\tinput_set_capability(input, EV_KEY, BTN_RIGHT);\n\n\terror = input_setup_polling(input, gpio_mouse_scan);\n\tif (error)\n\t\treturn error;\n\n\tinput_set_poll_interval(input, gmouse->scan_ms);\n\n\terror = input_register_device(input);\n\tif (error) {\n\t\tdev_err(dev, \"could not register input device\\n\");\n\t\treturn error;\n\t}\n\n\tdev_dbg(dev, \"%d ms scan time, buttons: %s%s%s\\n\",\n\t\tgmouse->scan_ms,\n\t\tgmouse->bleft ? \"\" : \"left \",\n\t\tgmouse->bmiddle ? \"\" : \"middle \",\n\t\tgmouse->bright ? \"\" : \"right\");\n\n\treturn 0;\n}\n\nstatic const struct of_device_id gpio_mouse_of_match[] = {\n\t{ .compatible = \"gpio-mouse\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, gpio_mouse_of_match);\n\nstatic struct platform_driver gpio_mouse_device_driver = {\n\t.probe\t\t= gpio_mouse_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"gpio_mouse\",\n\t\t.of_match_table = gpio_mouse_of_match,\n\t}\n};\nmodule_platform_driver(gpio_mouse_device_driver);\n\nMODULE_AUTHOR(\"Hans-Christian Egtvedt <egtvedt@samfundet.no>\");\nMODULE_DESCRIPTION(\"GPIO mouse driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:gpio_mouse\");  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}