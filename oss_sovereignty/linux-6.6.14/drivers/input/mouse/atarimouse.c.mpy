{
  "module_name": "atarimouse.c",
  "hash_id": "5e648fbbff620f03ccf7be99c785a6f2da606ef005cfe279374ff59d5f7f86fc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/atarimouse.c",
  "human_readable_source": "\n \n \n\n\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n\n#include <asm/irq.h>\n#include <asm/setup.h>\n#include <linux/uaccess.h>\n#include <asm/atarihw.h>\n#include <asm/atarikb.h>\n#include <asm/atariints.h>\n\nMODULE_AUTHOR(\"Michael Schmitz <schmitz@biophys.uni-duesseldorf.de>\");\nMODULE_DESCRIPTION(\"Atari mouse driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int mouse_threshold[2] = {2, 2};\nmodule_param_array(mouse_threshold, int, NULL, 0);\n\n#ifdef FIXED_ATARI_JOYSTICK\nextern int atari_mouse_buttons;\n#endif\n\nstatic struct input_dev *atamouse_dev;\n\nstatic void atamouse_interrupt(char *buf)\n{\n\tint buttons, dx, dy;\n\n\tbuttons = (buf[0] & 1) | ((buf[0] & 2) << 1);\n#ifdef FIXED_ATARI_JOYSTICK\n\tbuttons |= atari_mouse_buttons & 2;\n\tatari_mouse_buttons = buttons;\n#endif\n\n\t \n\tdx = buf[1];\n\tdy = buf[2];\n\n\tinput_report_rel(atamouse_dev, REL_X, dx);\n\tinput_report_rel(atamouse_dev, REL_Y, dy);\n\n\tinput_report_key(atamouse_dev, BTN_LEFT,   buttons & 0x4);\n\tinput_report_key(atamouse_dev, BTN_MIDDLE, buttons & 0x2);\n\tinput_report_key(atamouse_dev, BTN_RIGHT,  buttons & 0x1);\n\n\tinput_sync(atamouse_dev);\n\n\treturn;\n}\n\nstatic int atamouse_open(struct input_dev *dev)\n{\n#ifdef FIXED_ATARI_JOYSTICK\n\tatari_mouse_buttons = 0;\n#endif\n\tikbd_mouse_y0_top();\n\tikbd_mouse_thresh(mouse_threshold[0], mouse_threshold[1]);\n\tikbd_mouse_rel_pos();\n\tatari_input_mouse_interrupt_hook = atamouse_interrupt;\n\n\treturn 0;\n}\n\nstatic void atamouse_close(struct input_dev *dev)\n{\n\tikbd_mouse_disable();\n\tatari_input_mouse_interrupt_hook = NULL;\n}\n\nstatic int __init atamouse_init(void)\n{\n\tint error;\n\n\tif (!MACH_IS_ATARI || !ATARIHW_PRESENT(ST_MFP))\n\t\treturn -ENODEV;\n\n\terror = atari_keyb_init();\n\tif (error)\n\t\treturn error;\n\n\tatamouse_dev = input_allocate_device();\n\tif (!atamouse_dev)\n\t\treturn -ENOMEM;\n\n\tatamouse_dev->name = \"Atari mouse\";\n\tatamouse_dev->phys = \"atamouse/input0\";\n\tatamouse_dev->id.bustype = BUS_HOST;\n\tatamouse_dev->id.vendor = 0x0001;\n\tatamouse_dev->id.product = 0x0002;\n\tatamouse_dev->id.version = 0x0100;\n\n\tatamouse_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\n\tatamouse_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\n\tatamouse_dev->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\n\t\tBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\n\n\tatamouse_dev->open = atamouse_open;\n\tatamouse_dev->close = atamouse_close;\n\n\terror = input_register_device(atamouse_dev);\n\tif (error) {\n\t\tinput_free_device(atamouse_dev);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic void __exit atamouse_exit(void)\n{\n\tinput_unregister_device(atamouse_dev);\n}\n\nmodule_init(atamouse_init);\nmodule_exit(atamouse_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}