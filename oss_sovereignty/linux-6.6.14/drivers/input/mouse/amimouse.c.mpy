{
  "module_name": "amimouse.c",
  "hash_id": "c541c8a9f1b852edc6ef69cf2abd60907f265ba077b05926e2719284383e2bac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/amimouse.c",
  "human_readable_source": "\n \n\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n\n#include <asm/irq.h>\n#include <asm/setup.h>\n#include <linux/uaccess.h>\n#include <asm/amigahw.h>\n#include <asm/amigaints.h>\n\nMODULE_AUTHOR(\"Vojtech Pavlik <vojtech@ucw.cz>\");\nMODULE_DESCRIPTION(\"Amiga mouse driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int amimouse_lastx, amimouse_lasty;\n\nstatic irqreturn_t amimouse_interrupt(int irq, void *data)\n{\n\tstruct input_dev *dev = data;\n\tunsigned short joy0dat, potgor;\n\tint nx, ny, dx, dy;\n\n\tjoy0dat = amiga_custom.joy0dat;\n\n\tnx = joy0dat & 0xff;\n\tny = joy0dat >> 8;\n\n\tdx = nx - amimouse_lastx;\n\tdy = ny - amimouse_lasty;\n\n\tif (dx < -127) dx = (256 + nx) - amimouse_lastx;\n\tif (dx >  127) dx = (nx - 256) - amimouse_lastx;\n\tif (dy < -127) dy = (256 + ny) - amimouse_lasty;\n\tif (dy >  127) dy = (ny - 256) - amimouse_lasty;\n\n\tamimouse_lastx = nx;\n\tamimouse_lasty = ny;\n\n\tpotgor = amiga_custom.potgor;\n\n\tinput_report_rel(dev, REL_X, dx);\n\tinput_report_rel(dev, REL_Y, dy);\n\n\tinput_report_key(dev, BTN_LEFT,   ciaa.pra & 0x40);\n\tinput_report_key(dev, BTN_MIDDLE, potgor & 0x0100);\n\tinput_report_key(dev, BTN_RIGHT,  potgor & 0x0400);\n\n\tinput_sync(dev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int amimouse_open(struct input_dev *dev)\n{\n\tunsigned short joy0dat;\n\tint error;\n\n\tjoy0dat = amiga_custom.joy0dat;\n\n\tamimouse_lastx = joy0dat & 0xff;\n\tamimouse_lasty = joy0dat >> 8;\n\n\terror = request_irq(IRQ_AMIGA_VERTB, amimouse_interrupt, 0, \"amimouse\",\n\t\t\t    dev);\n\tif (error)\n\t\tdev_err(&dev->dev, \"Can't allocate irq %d\\n\", IRQ_AMIGA_VERTB);\n\n\treturn error;\n}\n\nstatic void amimouse_close(struct input_dev *dev)\n{\n\tfree_irq(IRQ_AMIGA_VERTB, dev);\n}\n\nstatic int __init amimouse_probe(struct platform_device *pdev)\n{\n\tint err;\n\tstruct input_dev *dev;\n\n\tdev = input_allocate_device();\n\tif (!dev)\n\t\treturn -ENOMEM;\n\n\tdev->name = pdev->name;\n\tdev->phys = \"amimouse/input0\";\n\tdev->id.bustype = BUS_AMIGA;\n\tdev->id.vendor = 0x0001;\n\tdev->id.product = 0x0002;\n\tdev->id.version = 0x0100;\n\n\tdev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\n\tdev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\n\tdev->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\n\t\tBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\n\tdev->open = amimouse_open;\n\tdev->close = amimouse_close;\n\tdev->dev.parent = &pdev->dev;\n\n\terr = input_register_device(dev);\n\tif (err) {\n\t\tinput_free_device(dev);\n\t\treturn err;\n\t}\n\n\tplatform_set_drvdata(pdev, dev);\n\n\treturn 0;\n}\n\nstatic int __exit amimouse_remove(struct platform_device *pdev)\n{\n\tstruct input_dev *dev = platform_get_drvdata(pdev);\n\n\tinput_unregister_device(dev);\n\treturn 0;\n}\n\nstatic struct platform_driver amimouse_driver = {\n\t.remove = __exit_p(amimouse_remove),\n\t.driver   = {\n\t\t.name\t= \"amiga-mouse\",\n\t},\n};\n\nmodule_platform_driver_probe(amimouse_driver, amimouse_probe);\n\nMODULE_ALIAS(\"platform:amiga-mouse\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}