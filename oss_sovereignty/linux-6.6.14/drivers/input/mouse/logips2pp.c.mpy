{
  "module_name": "logips2pp.c",
  "hash_id": "49d28bb553ff7ecde2aef56aa13757e4cf74693f51d36488f830a1eae4728a94",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/mouse/logips2pp.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/input.h>\n#include <linux/serio.h>\n#include <linux/libps2.h>\n#include <linux/types.h>\n#include \"psmouse.h\"\n#include \"logips2pp.h\"\n\n \n#define PS2PP_KIND_WHEEL\t1\n#define PS2PP_KIND_MX\t\t2\n#define PS2PP_KIND_TP3\t\t3\n#define PS2PP_KIND_TRACKMAN\t4\n\n \n#define PS2PP_WHEEL\t\tBIT(0)\n#define PS2PP_HWHEEL\t\tBIT(1)\n#define PS2PP_SIDE_BTN\t\tBIT(2)\n#define PS2PP_EXTRA_BTN\t\tBIT(3)\n#define PS2PP_TASK_BTN\t\tBIT(4)\n#define PS2PP_NAV_BTN\t\tBIT(5)\n\nstruct ps2pp_info {\n\tu8 model;\n\tu8 kind;\n\tu16 features;\n};\n\n \n\nstatic psmouse_ret_t ps2pp_process_byte(struct psmouse *psmouse)\n{\n\tstruct input_dev *dev = psmouse->dev;\n\tu8 *packet = psmouse->packet;\n\n\tif (psmouse->pktcnt < 3)\n\t\treturn PSMOUSE_GOOD_DATA;\n\n \n\n\tif ((packet[0] & 0x48) == 0x48 && (packet[1] & 0x02) == 0x02) {\n\n\t\t \n\t\tswitch ((packet[1] >> 4) | (packet[0] & 0x30)) {\n\n\t\tcase 0x0d:  \n\n\t\t\tinput_report_rel(dev,\n\t\t\t\tpacket[2] & 0x80 ? REL_HWHEEL : REL_WHEEL,\n\t\t\t\t-sign_extend32(packet[2], 3));\n\t\t\tinput_report_key(dev, BTN_SIDE,  packet[2] & BIT(4));\n\t\t\tinput_report_key(dev, BTN_EXTRA, packet[2] & BIT(5));\n\n\t\t\tbreak;\n\n\t\tcase 0x0e:  \n\n\t\t\tinput_report_key(dev, BTN_SIDE,    packet[2] & BIT(0));\n\t\t\tinput_report_key(dev, BTN_EXTRA,   packet[2] & BIT(1));\n\t\t\tinput_report_key(dev, BTN_TASK,    packet[2] & BIT(2));\n\t\t\tinput_report_key(dev, BTN_BACK,    packet[2] & BIT(3));\n\t\t\tinput_report_key(dev, BTN_FORWARD, packet[2] & BIT(4));\n\n\t\t\tbreak;\n\n\t\tcase 0x0f:  \n\n\t\t\tinput_report_rel(dev,\n\t\t\t\tpacket[2] & 0x08 ? REL_HWHEEL : REL_WHEEL,\n\t\t\t\t-sign_extend32(packet[2] >> 4, 3));\n\t\t\tpacket[0] = packet[2] | BIT(3);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tpsmouse_dbg(psmouse,\n\t\t\t\t    \"Received PS2++ packet #%x, but don't know how to handle.\\n\",\n\t\t\t\t    (packet[1] >> 4) | (packet[0] & 0x30));\n\t\t\tbreak;\n\t\t}\n\n\t\tpsmouse_report_standard_buttons(dev, packet[0]);\n\n\t} else {\n\t\t \n\t\tpsmouse_report_standard_packet(dev, packet);\n\t}\n\n\tinput_sync(dev);\n\n\treturn PSMOUSE_FULL_PACKET;\n\n}\n\n \n\nstatic int ps2pp_cmd(struct psmouse *psmouse, u8 *param, u8 command)\n{\n\tint error;\n\n\terror = ps2_sliced_command(&psmouse->ps2dev, command);\n\tif (error)\n\t\treturn error;\n\n\terror = ps2_command(&psmouse->ps2dev, param, PSMOUSE_CMD_POLL | 0x0300);\n\tif (error)\n\t\treturn error;\n\n\treturn 0;\n}\n\n \n\nstatic void ps2pp_set_smartscroll(struct psmouse *psmouse, bool smartscroll)\n{\n\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\tu8 param[4];\n\n\tps2pp_cmd(psmouse, param, 0x32);\n\n\tparam[0] = 0;\n\tps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\n\tps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\n\tps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\n\n\tparam[0] = smartscroll;\n\tps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\n}\n\nstatic ssize_t ps2pp_attr_show_smartscroll(struct psmouse *psmouse,\n\t\t\t\t\t   void *data, char *buf)\n{\n\treturn sprintf(buf, \"%d\\n\", psmouse->smartscroll);\n}\n\nstatic ssize_t ps2pp_attr_set_smartscroll(struct psmouse *psmouse, void *data,\n\t\t\t\t\t  const char *buf, size_t count)\n{\n\tunsigned int value;\n\tint err;\n\n\terr = kstrtouint(buf, 10, &value);\n\tif (err)\n\t\treturn err;\n\n\tif (value > 1)\n\t\treturn -EINVAL;\n\n\tps2pp_set_smartscroll(psmouse, value);\n\tpsmouse->smartscroll = value;\n\treturn count;\n}\n\nPSMOUSE_DEFINE_ATTR(smartscroll, S_IWUSR | S_IRUGO, NULL,\n\t\t    ps2pp_attr_show_smartscroll, ps2pp_attr_set_smartscroll);\n\n \n\nstatic void ps2pp_set_resolution(struct psmouse *psmouse,\n\t\t\t\t unsigned int resolution)\n{\n\tif (resolution > 400) {\n\t\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\t\tu8 param = 3;\n\n\t\tps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\n\t\tps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\n\t\tps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\n\t\tps2_command(ps2dev, &param, PSMOUSE_CMD_SETRES);\n\t\tpsmouse->resolution = 800;\n\t} else\n\t\tpsmouse_set_resolution(psmouse, resolution);\n}\n\nstatic void ps2pp_disconnect(struct psmouse *psmouse)\n{\n\tdevice_remove_file(&psmouse->ps2dev.serio->dev,\n\t\t\t   &psmouse_attr_smartscroll.dattr);\n}\n\nstatic const struct ps2pp_info *get_model_info(unsigned char model)\n{\n\tstatic const struct ps2pp_info ps2pp_list[] = {\n\t\t{  1,\t0,\t\t\t0 },\t \n\t\t{ 12,\t0,\t\t\tPS2PP_SIDE_BTN},\n\t\t{ 13,\t0,\t\t\t0 },\n\t\t{ 15,\tPS2PP_KIND_MX,\t\t\t\t\t \n\t\t\t\tPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\n\t\t\t\tPS2PP_EXTRA_BTN | PS2PP_NAV_BTN | PS2PP_HWHEEL },\n\t\t{ 40,\t0,\t\t\tPS2PP_SIDE_BTN },\n\t\t{ 41,\t0,\t\t\tPS2PP_SIDE_BTN },\n\t\t{ 42,\t0,\t\t\tPS2PP_SIDE_BTN },\n\t\t{ 43,\t0,\t\t\tPS2PP_SIDE_BTN },\n\t\t{ 50,\t0,\t\t\t0 },\n\t\t{ 51,\t0,\t\t\t0 },\n\t\t{ 52,\tPS2PP_KIND_WHEEL,\tPS2PP_SIDE_BTN | PS2PP_WHEEL },\n\t\t{ 53,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 56,\tPS2PP_KIND_WHEEL,\tPS2PP_SIDE_BTN | PS2PP_WHEEL },  \n\t\t{ 61,\tPS2PP_KIND_MX,\t\t\t\t\t \n\t\t\t\tPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\n\t\t\t\tPS2PP_EXTRA_BTN | PS2PP_NAV_BTN },\n\t\t{ 66,\tPS2PP_KIND_MX,\t\t\t\t\t \n\t\t\t\tPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\n\t\t\t\tPS2PP_EXTRA_BTN | PS2PP_NAV_BTN | PS2PP_HWHEEL },\n\t\t{ 72,\tPS2PP_KIND_TRACKMAN,\t0 },\t\t\t \n\t\t{ 73,\tPS2PP_KIND_TRACKMAN,\tPS2PP_SIDE_BTN },\t \n\t\t{ 75,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 76,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 79,\tPS2PP_KIND_TRACKMAN,\tPS2PP_WHEEL },\t\t \n\t\t{ 80,\tPS2PP_KIND_WHEEL,\tPS2PP_SIDE_BTN | PS2PP_WHEEL },\n\t\t{ 81,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 83,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 85,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 86,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 87,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 88,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 96,\t0,\t\t\t0 },\n\t\t{ 97,\tPS2PP_KIND_TP3,\t\tPS2PP_WHEEL | PS2PP_HWHEEL },\n\t\t{ 99,\tPS2PP_KIND_WHEEL,\tPS2PP_WHEEL },\n\t\t{ 100,\tPS2PP_KIND_MX,\t\t\t\t\t \n\t\t\t\tPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\n\t\t\t\tPS2PP_EXTRA_BTN | PS2PP_NAV_BTN },\n\t\t{ 111,  PS2PP_KIND_MX,\tPS2PP_WHEEL | PS2PP_SIDE_BTN },\t \n\t\t{ 112,\tPS2PP_KIND_MX,\t\t\t\t\t \n\t\t\t\tPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\n\t\t\t\tPS2PP_EXTRA_BTN | PS2PP_NAV_BTN },\n\t\t{ 114,\tPS2PP_KIND_MX,\t\t\t\t\t \n\t\t\t\tPS2PP_WHEEL | PS2PP_SIDE_BTN |\n\t\t\t\tPS2PP_TASK_BTN | PS2PP_EXTRA_BTN }\n\t};\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ps2pp_list); i++)\n\t\tif (model == ps2pp_list[i].model)\n\t\t\treturn &ps2pp_list[i];\n\n\treturn NULL;\n}\n\n \n\nstatic void ps2pp_set_model_properties(struct psmouse *psmouse,\n\t\t\t\t       const struct ps2pp_info *model_info,\n\t\t\t\t       bool using_ps2pp)\n{\n\tstruct input_dev *input_dev = psmouse->dev;\n\n\tif (model_info->features & PS2PP_SIDE_BTN)\n\t\tinput_set_capability(input_dev, EV_KEY, BTN_SIDE);\n\n\tif (model_info->features & PS2PP_EXTRA_BTN)\n\t\tinput_set_capability(input_dev, EV_KEY, BTN_EXTRA);\n\n\tif (model_info->features & PS2PP_TASK_BTN)\n\t\tinput_set_capability(input_dev, EV_KEY, BTN_TASK);\n\n\tif (model_info->features & PS2PP_NAV_BTN) {\n\t\tinput_set_capability(input_dev, EV_KEY, BTN_FORWARD);\n\t\tinput_set_capability(input_dev, EV_KEY, BTN_BACK);\n\t}\n\n\tif (model_info->features & PS2PP_WHEEL)\n\t\tinput_set_capability(input_dev, EV_REL, REL_WHEEL);\n\n\tif (model_info->features & PS2PP_HWHEEL)\n\t\tinput_set_capability(input_dev, EV_REL, REL_HWHEEL);\n\n\tswitch (model_info->kind) {\n\n\tcase PS2PP_KIND_WHEEL:\n\t\tpsmouse->name = \"Wheel Mouse\";\n\t\tbreak;\n\n\tcase PS2PP_KIND_MX:\n\t\tpsmouse->name = \"MX Mouse\";\n\t\tbreak;\n\n\tcase PS2PP_KIND_TP3:\n\t\tpsmouse->name = \"TouchPad 3\";\n\t\tbreak;\n\n\tcase PS2PP_KIND_TRACKMAN:\n\t\tpsmouse->name = \"TrackMan\";\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\tif (using_ps2pp)\n\t\t\tpsmouse->name = \"Mouse\";\n\t\tbreak;\n\t}\n}\n\nstatic int ps2pp_setup_protocol(struct psmouse *psmouse,\n\t\t\t\tconst struct ps2pp_info *model_info)\n{\n\tint error;\n\n\tpsmouse->protocol_handler = ps2pp_process_byte;\n\tpsmouse->pktsize = 3;\n\n\tif (model_info->kind != PS2PP_KIND_TP3) {\n\t\tpsmouse->set_resolution = ps2pp_set_resolution;\n\t\tpsmouse->disconnect = ps2pp_disconnect;\n\n\t\terror = device_create_file(&psmouse->ps2dev.serio->dev,\n\t\t\t\t\t   &psmouse_attr_smartscroll.dattr);\n\t\tif (error) {\n\t\t\tpsmouse_err(psmouse,\n\t\t\t\t    \"failed to create smartscroll sysfs attribute, error: %d\\n\",\n\t\t\t\t    error);\n\t\t\treturn error;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \n\nint ps2pp_detect(struct psmouse *psmouse, bool set_properties)\n{\n\tstruct ps2dev *ps2dev = &psmouse->ps2dev;\n\tconst struct ps2pp_info *model_info;\n\tu8 param[4];\n\tu8 model, buttons;\n\tbool use_ps2pp = false;\n\tint error;\n\n\tparam[0] = 0;\n\tps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\n\tps2_command(ps2dev,  NULL, PSMOUSE_CMD_SETSCALE11);\n\tps2_command(ps2dev,  NULL, PSMOUSE_CMD_SETSCALE11);\n\tps2_command(ps2dev,  NULL, PSMOUSE_CMD_SETSCALE11);\n\tparam[1] = 0;\n\tps2_command(ps2dev, param, PSMOUSE_CMD_GETINFO);\n\n\tmodel = ((param[0] >> 4) & 0x07) | ((param[0] << 3) & 0x78);\n\tbuttons = param[1];\n\n\tif (!model || !buttons)\n\t\treturn -ENXIO;\n\n\tmodel_info = get_model_info(model);\n\tif (model_info) {\n\n \n\t\tif (model_info->kind == PS2PP_KIND_TP3) {  \n\n\t\t\t \n\t\t\tparam[0] = 0x11; param[1] = 0x04; param[2] = 0x68;\n\t\t\tps2_command(ps2dev, param, 0x30d1);\n\t\t\t \n\t\t\tparam[0] = 0x11; param[1] = 0x05; param[2] = 0x0b;\n\t\t\tps2_command(ps2dev, param, 0x30d1);\n\t\t\t \n\t\t\tparam[0] = 0x11; param[1] = 0x09; param[2] = 0xc3;\n\t\t\tps2_command(ps2dev, param, 0x30d1);\n\n\t\t\tparam[0] = 0;\n\t\t\tif (!ps2_command(ps2dev, param, 0x13d1) &&\n\t\t\t    param[0] == 0x06 && param[1] == 0x00 &&\n\t\t\t    param[2] == 0x14) {\n\t\t\t\tuse_ps2pp = true;\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tparam[0] = param[1] = param[2] = 0;\n\t\t\tps2pp_cmd(psmouse, param, 0x39);  \n\t\t\tps2pp_cmd(psmouse, param, 0xDB);\n\n\t\t\tif ((param[0] & 0x78) == 0x48 &&\n\t\t\t    (param[1] & 0xf3) == 0xc2 &&\n\t\t\t    (param[2] & 0x03) == ((param[1] >> 2) & 3)) {\n\t\t\t\tps2pp_set_smartscroll(psmouse, false);\n\t\t\t\tuse_ps2pp = true;\n\t\t\t}\n\t\t}\n\n\t} else {\n\t\tpsmouse_warn(psmouse,\n\t\t\t     \"Detected unknown Logitech mouse model %d\\n\",\n\t\t\t     model);\n\t}\n\n\tif (set_properties) {\n\t\tpsmouse->vendor = \"Logitech\";\n\t\tpsmouse->model = model;\n\n\t\tif (use_ps2pp) {\n\t\t\terror = ps2pp_setup_protocol(psmouse, model_info);\n\t\t\tif (error)\n\t\t\t\treturn error;\n\t\t}\n\n\t\tif (buttons >= 3)\n\t\t\tinput_set_capability(psmouse->dev, EV_KEY, BTN_MIDDLE);\n\n\t\tif (model_info)\n\t\t\tps2pp_set_model_properties(psmouse, model_info, use_ps2pp);\n\t}\n\n\treturn use_ps2pp ? 0 : -ENXIO;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}