{
  "module_name": "gpio-beeper.c",
  "hash_id": "2f3fed89bee91e71c196e8a2f8abafc63c4cc427a2a124cce393ac255caa9e26",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/gpio-beeper.c",
  "human_readable_source": "\n \n\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/gpio/consumer.h>\n#include <linux/of.h>\n#include <linux/workqueue.h>\n#include <linux/platform_device.h>\n\n#define BEEPER_MODNAME\t\t\"gpio-beeper\"\n\nstruct gpio_beeper {\n\tstruct work_struct\twork;\n\tstruct gpio_desc\t*desc;\n\tbool\t\t\tbeeping;\n};\n\nstatic void gpio_beeper_toggle(struct gpio_beeper *beep, bool on)\n{\n\tgpiod_set_value_cansleep(beep->desc, on);\n}\n\nstatic void gpio_beeper_work(struct work_struct *work)\n{\n\tstruct gpio_beeper *beep = container_of(work, struct gpio_beeper, work);\n\n\tgpio_beeper_toggle(beep, beep->beeping);\n}\n\nstatic int gpio_beeper_event(struct input_dev *dev, unsigned int type,\n\t\t\t     unsigned int code, int value)\n{\n\tstruct gpio_beeper *beep = input_get_drvdata(dev);\n\n\tif (type != EV_SND || code != SND_BELL)\n\t\treturn -ENOTSUPP;\n\n\tif (value < 0)\n\t\treturn -EINVAL;\n\n\tbeep->beeping = value;\n\t \n\tschedule_work(&beep->work);\n\n\treturn 0;\n}\n\nstatic void gpio_beeper_close(struct input_dev *input)\n{\n\tstruct gpio_beeper *beep = input_get_drvdata(input);\n\n\tcancel_work_sync(&beep->work);\n\tgpio_beeper_toggle(beep, false);\n}\n\nstatic int gpio_beeper_probe(struct platform_device *pdev)\n{\n\tstruct gpio_beeper *beep;\n\tstruct input_dev *input;\n\n\tbeep = devm_kzalloc(&pdev->dev, sizeof(*beep), GFP_KERNEL);\n\tif (!beep)\n\t\treturn -ENOMEM;\n\n\tbeep->desc = devm_gpiod_get(&pdev->dev, NULL, GPIOD_OUT_LOW);\n\tif (IS_ERR(beep->desc))\n\t\treturn PTR_ERR(beep->desc);\n\n\tinput = devm_input_allocate_device(&pdev->dev);\n\tif (!input)\n\t\treturn -ENOMEM;\n\n\tINIT_WORK(&beep->work, gpio_beeper_work);\n\n\tinput->name\t\t= pdev->name;\n\tinput->id.bustype\t= BUS_HOST;\n\tinput->id.vendor\t= 0x0001;\n\tinput->id.product\t= 0x0001;\n\tinput->id.version\t= 0x0100;\n\tinput->close\t\t= gpio_beeper_close;\n\tinput->event\t\t= gpio_beeper_event;\n\n\tinput_set_capability(input, EV_SND, SND_BELL);\n\n\tinput_set_drvdata(input, beep);\n\n\treturn input_register_device(input);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id gpio_beeper_of_match[] = {\n\t{ .compatible = BEEPER_MODNAME, },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, gpio_beeper_of_match);\n#endif\n\nstatic struct platform_driver gpio_beeper_platform_driver = {\n\t.driver\t= {\n\t\t.name\t\t= BEEPER_MODNAME,\n\t\t.of_match_table\t= of_match_ptr(gpio_beeper_of_match),\n\t},\n\t.probe\t= gpio_beeper_probe,\n};\nmodule_platform_driver(gpio_beeper_platform_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Alexander Shiyan <shc_work@mail.ru>\");\nMODULE_DESCRIPTION(\"Generic GPIO beeper driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}