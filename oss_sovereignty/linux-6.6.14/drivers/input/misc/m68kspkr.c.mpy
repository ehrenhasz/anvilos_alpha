{
  "module_name": "m68kspkr.c",
  "hash_id": "d662311e38c06147de418cb6f744997cb1cd85850b03b478d964ca307c701876",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/m68kspkr.c",
  "human_readable_source": "\n \n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/platform_device.h>\n#include <asm/machdep.h>\n#include <asm/io.h>\n\nMODULE_AUTHOR(\"Richard Zidlicky <rz@linux-m68k.org>\");\nMODULE_DESCRIPTION(\"m68k beeper driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic struct platform_device *m68kspkr_platform_device;\n\nstatic int m68kspkr_event(struct input_dev *dev, unsigned int type, unsigned int code, int value)\n{\n\tunsigned int count = 0;\n\n\tif (type != EV_SND)\n\t\treturn -1;\n\n\tswitch (code) {\n\t\tcase SND_BELL: if (value) value = 1000;\n\t\tcase SND_TONE: break;\n\t\tdefault: return -1;\n\t}\n\n\tif (value > 20 && value < 32767)\n\t\tcount = 1193182 / value;\n\n\tmach_beep(count, -1);\n\n\treturn 0;\n}\n\nstatic int m68kspkr_probe(struct platform_device *dev)\n{\n\tstruct input_dev *input_dev;\n\tint err;\n\n\tinput_dev = input_allocate_device();\n\tif (!input_dev)\n\t\treturn -ENOMEM;\n\n\tinput_dev->name = \"m68k beeper\";\n\tinput_dev->phys = \"m68k/generic\";\n\tinput_dev->id.bustype = BUS_HOST;\n\tinput_dev->id.vendor  = 0x001f;\n\tinput_dev->id.product = 0x0001;\n\tinput_dev->id.version = 0x0100;\n\tinput_dev->dev.parent = &dev->dev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_SND);\n\tinput_dev->sndbit[0] = BIT_MASK(SND_BELL) | BIT_MASK(SND_TONE);\n\tinput_dev->event = m68kspkr_event;\n\n\terr = input_register_device(input_dev);\n\tif (err) {\n\t\tinput_free_device(input_dev);\n\t\treturn err;\n\t}\n\n\tplatform_set_drvdata(dev, input_dev);\n\n\treturn 0;\n}\n\nstatic int m68kspkr_remove(struct platform_device *dev)\n{\n\tstruct input_dev *input_dev = platform_get_drvdata(dev);\n\n\tinput_unregister_device(input_dev);\n\t \n\tm68kspkr_event(NULL, EV_SND, SND_BELL, 0);\n\n\treturn 0;\n}\n\nstatic void m68kspkr_shutdown(struct platform_device *dev)\n{\n\t \n\tm68kspkr_event(NULL, EV_SND, SND_BELL, 0);\n}\n\nstatic struct platform_driver m68kspkr_platform_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"m68kspkr\",\n\t},\n\t.probe\t\t= m68kspkr_probe,\n\t.remove\t\t= m68kspkr_remove,\n\t.shutdown\t= m68kspkr_shutdown,\n};\n\nstatic int __init m68kspkr_init(void)\n{\n\tint err;\n\n\tif (!mach_beep) {\n\t\tprintk(KERN_INFO \"m68kspkr: no lowlevel beep support\\n\");\n\t\treturn -ENODEV;\n        }\n\n\terr = platform_driver_register(&m68kspkr_platform_driver);\n\tif (err)\n\t\treturn err;\n\n\tm68kspkr_platform_device = platform_device_alloc(\"m68kspkr\", -1);\n\tif (!m68kspkr_platform_device) {\n\t\terr = -ENOMEM;\n\t\tgoto err_unregister_driver;\n\t}\n\n\terr = platform_device_add(m68kspkr_platform_device);\n\tif (err)\n\t\tgoto err_free_device;\n\n\treturn 0;\n\n err_free_device:\n\tplatform_device_put(m68kspkr_platform_device);\n err_unregister_driver:\n\tplatform_driver_unregister(&m68kspkr_platform_driver);\n\n\treturn err;\n}\n\nstatic void __exit m68kspkr_exit(void)\n{\n\tplatform_device_unregister(m68kspkr_platform_device);\n\tplatform_driver_unregister(&m68kspkr_platform_driver);\n}\n\nmodule_init(m68kspkr_init);\nmodule_exit(m68kspkr_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}