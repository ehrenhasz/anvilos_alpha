{
  "module_name": "arizona-haptics.c",
  "hash_id": "df2051a431bb8f4e6fe8216e04f87d0433ef562bc96688a1128f50acc9a397fb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/arizona-haptics.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/input.h>\n#include <linux/slab.h>\n\n#include <sound/soc.h>\n#include <sound/soc-dapm.h>\n\n#include <linux/mfd/arizona/core.h>\n#include <linux/mfd/arizona/pdata.h>\n#include <linux/mfd/arizona/registers.h>\n\nstruct arizona_haptics {\n\tstruct arizona *arizona;\n\tstruct input_dev *input_dev;\n\tstruct work_struct work;\n\n\tstruct mutex mutex;\n\tu8 intensity;\n};\n\nstatic void arizona_haptics_work(struct work_struct *work)\n{\n\tstruct arizona_haptics *haptics = container_of(work,\n\t\t\t\t\t\t       struct arizona_haptics,\n\t\t\t\t\t\t       work);\n\tstruct arizona *arizona = haptics->arizona;\n\tstruct snd_soc_component *component =\n\t\tsnd_soc_dapm_to_component(arizona->dapm);\n\tint ret;\n\n\tif (!haptics->arizona->dapm) {\n\t\tdev_err(arizona->dev, \"No DAPM context\\n\");\n\t\treturn;\n\t}\n\n\tif (haptics->intensity) {\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_HAPTICS_PHASE_2_INTENSITY,\n\t\t\t\t\t ARIZONA_PHASE2_INTENSITY_MASK,\n\t\t\t\t\t haptics->intensity);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to set intensity: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\n\t\t \n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_HAPTICS_CONTROL_1,\n\t\t\t\t\t ARIZONA_HAP_CTRL_MASK,\n\t\t\t\t\t 1 << ARIZONA_HAP_CTRL_SHIFT);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to start haptics: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\n\t\tret = snd_soc_component_enable_pin(component, \"HAPTICS\");\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to start HAPTICS: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\n\t\tret = snd_soc_dapm_sync(arizona->dapm);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to sync DAPM: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\t} else {\n\t\t \n\t\tret = snd_soc_component_disable_pin(component, \"HAPTICS\");\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to disable HAPTICS: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\n\t\tret = snd_soc_dapm_sync(arizona->dapm);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to sync DAPM: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\n\t\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t\t ARIZONA_HAPTICS_CONTROL_1,\n\t\t\t\t\t ARIZONA_HAP_CTRL_MASK, 0);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to stop haptics: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn;\n\t\t}\n\t}\n}\n\nstatic int arizona_haptics_play(struct input_dev *input, void *data,\n\t\t\t\tstruct ff_effect *effect)\n{\n\tstruct arizona_haptics *haptics = input_get_drvdata(input);\n\tstruct arizona *arizona = haptics->arizona;\n\n\tif (!arizona->dapm) {\n\t\tdev_err(arizona->dev, \"No DAPM context\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tif (effect->u.rumble.strong_magnitude) {\n\t\t \n\t\tif (arizona->pdata.hap_act) {\n\t\t\thaptics->intensity =\n\t\t\t\teffect->u.rumble.strong_magnitude >> 9;\n\t\t\tif (effect->direction < 0x8000)\n\t\t\t\thaptics->intensity += 0x7f;\n\t\t} else {\n\t\t\thaptics->intensity =\n\t\t\t\teffect->u.rumble.strong_magnitude >> 8;\n\t\t}\n\t} else {\n\t\thaptics->intensity = 0;\n\t}\n\n\tschedule_work(&haptics->work);\n\n\treturn 0;\n}\n\nstatic void arizona_haptics_close(struct input_dev *input)\n{\n\tstruct arizona_haptics *haptics = input_get_drvdata(input);\n\tstruct snd_soc_component *component;\n\n\tcancel_work_sync(&haptics->work);\n\n\tif (haptics->arizona->dapm) {\n\t\tcomponent = snd_soc_dapm_to_component(haptics->arizona->dapm);\n\t\tsnd_soc_component_disable_pin(component, \"HAPTICS\");\n\t}\n}\n\nstatic int arizona_haptics_probe(struct platform_device *pdev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\n\tstruct arizona_haptics *haptics;\n\tint ret;\n\n\thaptics = devm_kzalloc(&pdev->dev, sizeof(*haptics), GFP_KERNEL);\n\tif (!haptics)\n\t\treturn -ENOMEM;\n\n\thaptics->arizona = arizona;\n\n\tret = regmap_update_bits(arizona->regmap, ARIZONA_HAPTICS_CONTROL_1,\n\t\t\t\t ARIZONA_HAP_ACT, arizona->pdata.hap_act);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to set haptics actuator: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tINIT_WORK(&haptics->work, arizona_haptics_work);\n\n\thaptics->input_dev = devm_input_allocate_device(&pdev->dev);\n\tif (!haptics->input_dev) {\n\t\tdev_err(arizona->dev, \"Failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tinput_set_drvdata(haptics->input_dev, haptics);\n\n\thaptics->input_dev->name = \"arizona:haptics\";\n\thaptics->input_dev->close = arizona_haptics_close;\n\t__set_bit(FF_RUMBLE, haptics->input_dev->ffbit);\n\n\tret = input_ff_create_memless(haptics->input_dev, NULL,\n\t\t\t\t      arizona_haptics_play);\n\tif (ret < 0) {\n\t\tdev_err(arizona->dev, \"input_ff_create_memless() failed: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tret = input_register_device(haptics->input_dev);\n\tif (ret < 0) {\n\t\tdev_err(arizona->dev, \"couldn't register input device: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver arizona_haptics_driver = {\n\t.probe\t\t= arizona_haptics_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"arizona-haptics\",\n\t},\n};\nmodule_platform_driver(arizona_haptics_driver);\n\nMODULE_ALIAS(\"platform:arizona-haptics\");\nMODULE_DESCRIPTION(\"Arizona haptics driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}