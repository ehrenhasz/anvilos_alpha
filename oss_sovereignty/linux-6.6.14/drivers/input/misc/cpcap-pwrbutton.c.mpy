{
  "module_name": "cpcap-pwrbutton.c",
  "hash_id": "cd8528bdd1515e56f162b8ee001aee4b59a9f996131672424f8fd678cadbefde",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/cpcap-pwrbutton.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/regmap.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/motorola-cpcap.h>\n\n#define CPCAP_IRQ_ON 23\n#define CPCAP_IRQ_ON_BITMASK (1 << (CPCAP_IRQ_ON % 16))\n\nstruct cpcap_power_button {\n\tstruct regmap *regmap;\n\tstruct input_dev *idev;\n\tstruct device *dev;\n};\n\nstatic irqreturn_t powerbutton_irq(int irq, void *_button)\n{\n\tstruct cpcap_power_button *button = _button;\n\tint val;\n\n\tval = cpcap_sense_virq(button->regmap, irq);\n\tif (val < 0) {\n\t\tdev_err(button->dev, \"irq read failed: %d\", val);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tpm_wakeup_event(button->dev, 0);\n\tinput_report_key(button->idev, KEY_POWER, val);\n\tinput_sync(button->idev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int cpcap_power_button_probe(struct platform_device *pdev)\n{\n\tstruct cpcap_power_button *button;\n\tint irq;\n\tint err;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tbutton = devm_kmalloc(&pdev->dev, sizeof(*button), GFP_KERNEL);\n\tif (!button)\n\t\treturn -ENOMEM;\n\n\tbutton->idev = devm_input_allocate_device(&pdev->dev);\n\tif (!button->idev)\n\t\treturn -ENOMEM;\n\n\tbutton->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!button->regmap)\n\t\treturn -ENODEV;\n\n\tbutton->dev = &pdev->dev;\n\n\tbutton->idev->name = \"cpcap-pwrbutton\";\n\tbutton->idev->phys = \"cpcap-pwrbutton/input0\";\n\tinput_set_capability(button->idev, EV_KEY, KEY_POWER);\n\n\terr = devm_request_threaded_irq(&pdev->dev, irq, NULL,\n\t\tpowerbutton_irq, IRQF_ONESHOT, \"cpcap_pwrbutton\", button);\n\tif (err < 0) {\n\t\tdev_err(&pdev->dev, \"IRQ request failed: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\terr = input_register_device(button->idev);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Input register failed: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tdevice_init_wakeup(&pdev->dev, true);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id cpcap_pwrbutton_dt_match_table[] = {\n\t{ .compatible = \"motorola,cpcap-pwrbutton\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, cpcap_pwrbutton_dt_match_table);\n#endif\n\nstatic struct platform_driver cpcap_power_button_driver = {\n\t.probe\t\t= cpcap_power_button_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"cpcap-pwrbutton\",\n\t\t.of_match_table = of_match_ptr(cpcap_pwrbutton_dt_match_table),\n\t},\n};\nmodule_platform_driver(cpcap_power_button_driver);\n\nMODULE_ALIAS(\"platform:cpcap-pwrbutton\");\nMODULE_DESCRIPTION(\"CPCAP Power Button\");\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Sebastian Reichel <sre@kernel.org>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}