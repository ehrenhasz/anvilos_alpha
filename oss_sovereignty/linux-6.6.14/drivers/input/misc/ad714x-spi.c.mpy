{
  "module_name": "ad714x-spi.c",
  "hash_id": "74a58c796ba93221b06a6a154b08b659cdc897694ca405576416f7113e9afa95",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/ad714x-spi.c",
  "human_readable_source": "\n \n\n#include <linux/input.h>\t \n#include <linux/module.h>\n#include <linux/spi/spi.h>\n#include <linux/pm.h>\n#include <linux/types.h>\n#include \"ad714x.h\"\n\n#define AD714x_SPI_CMD_PREFIX      0xE000    \n#define AD714x_SPI_READ            BIT(10)\n\nstatic int ad714x_spi_read(struct ad714x_chip *chip,\n\t\t\t   unsigned short reg, unsigned short *data, size_t len)\n{\n\tstruct spi_device *spi = to_spi_device(chip->dev);\n\tstruct spi_message message;\n\tstruct spi_transfer xfer[2];\n\tint i;\n\tint error;\n\n\tspi_message_init(&message);\n\tmemset(xfer, 0, sizeof(xfer));\n\n\tchip->xfer_buf[0] = cpu_to_be16(AD714x_SPI_CMD_PREFIX |\n\t\t\t\t\tAD714x_SPI_READ | reg);\n\txfer[0].tx_buf = &chip->xfer_buf[0];\n\txfer[0].len = sizeof(chip->xfer_buf[0]);\n\tspi_message_add_tail(&xfer[0], &message);\n\n\txfer[1].rx_buf = &chip->xfer_buf[1];\n\txfer[1].len = sizeof(chip->xfer_buf[1]) * len;\n\tspi_message_add_tail(&xfer[1], &message);\n\n\terror = spi_sync(spi, &message);\n\tif (unlikely(error)) {\n\t\tdev_err(chip->dev, \"SPI read error: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\tfor (i = 0; i < len; i++)\n\t\tdata[i] = be16_to_cpu(chip->xfer_buf[i + 1]);\n\n\treturn 0;\n}\n\nstatic int ad714x_spi_write(struct ad714x_chip *chip,\n\t\t\t    unsigned short reg, unsigned short data)\n{\n\tstruct spi_device *spi = to_spi_device(chip->dev);\n\tint error;\n\n\tchip->xfer_buf[0] = cpu_to_be16(AD714x_SPI_CMD_PREFIX | reg);\n\tchip->xfer_buf[1] = cpu_to_be16(data);\n\n\terror = spi_write(spi, (u8 *)chip->xfer_buf,\n\t\t\t  2 * sizeof(*chip->xfer_buf));\n\tif (unlikely(error)) {\n\t\tdev_err(chip->dev, \"SPI write error: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic int ad714x_spi_probe(struct spi_device *spi)\n{\n\tstruct ad714x_chip *chip;\n\tint err;\n\n\tspi->bits_per_word = 8;\n\terr = spi_setup(spi);\n\tif (err < 0)\n\t\treturn err;\n\n\tchip = ad714x_probe(&spi->dev, BUS_SPI, spi->irq,\n\t\t\t    ad714x_spi_read, ad714x_spi_write);\n\tif (IS_ERR(chip))\n\t\treturn PTR_ERR(chip);\n\n\tspi_set_drvdata(spi, chip);\n\n\treturn 0;\n}\n\nstatic struct spi_driver ad714x_spi_driver = {\n\t.driver = {\n\t\t.name\t= \"ad714x_captouch\",\n\t\t.pm\t= pm_sleep_ptr(&ad714x_pm),\n\t},\n\t.probe\t\t= ad714x_spi_probe,\n};\n\nmodule_spi_driver(ad714x_spi_driver);\n\nMODULE_DESCRIPTION(\"Analog Devices AD714X Capacitance Touch Sensor SPI Bus Driver\");\nMODULE_AUTHOR(\"Barry Song <21cnbao@gmail.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}