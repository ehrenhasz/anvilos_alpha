{
  "module_name": "tps65218-pwrbutton.c",
  "hash_id": "812e9bd85090d36e19734b6ffb6c71602030435d4ed35a6d5c3b0cdf25fced54",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/tps65218-pwrbutton.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/tps65217.h>\n#include <linux/mfd/tps65218.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\nstruct tps6521x_data {\n\tunsigned int reg_status;\n\tunsigned int pb_mask;\n\tconst char *name;\n};\n\nstatic const struct tps6521x_data tps65217_data = {\n\t.reg_status = TPS65217_REG_STATUS,\n\t.pb_mask = TPS65217_STATUS_PB,\n\t.name = \"tps65217_pwrbutton\",\n};\n\nstatic const struct tps6521x_data tps65218_data = {\n\t.reg_status = TPS65218_REG_STATUS,\n\t.pb_mask = TPS65218_STATUS_PB_STATE,\n\t.name = \"tps65218_pwrbutton\",\n};\n\nstruct tps6521x_pwrbutton {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tstruct input_dev *idev;\n\tconst struct tps6521x_data *data;\n\tchar phys[32];\n};\n\nstatic const struct of_device_id of_tps6521x_pb_match[] = {\n\t{ .compatible = \"ti,tps65217-pwrbutton\", .data = &tps65217_data },\n\t{ .compatible = \"ti,tps65218-pwrbutton\", .data = &tps65218_data },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, of_tps6521x_pb_match);\n\nstatic irqreturn_t tps6521x_pb_irq(int irq, void *_pwr)\n{\n\tstruct tps6521x_pwrbutton *pwr = _pwr;\n\tconst struct tps6521x_data *tps_data = pwr->data;\n\tunsigned int reg;\n\tint error;\n\n\terror = regmap_read(pwr->regmap, tps_data->reg_status, &reg);\n\tif (error) {\n\t\tdev_err(pwr->dev, \"can't read register: %d\\n\", error);\n\t\tgoto out;\n\t}\n\n\tif (reg & tps_data->pb_mask) {\n\t\tinput_report_key(pwr->idev, KEY_POWER, 1);\n\t\tpm_wakeup_event(pwr->dev, 0);\n\t} else {\n\t\tinput_report_key(pwr->idev, KEY_POWER, 0);\n\t}\n\n\tinput_sync(pwr->idev);\n\nout:\n\treturn IRQ_HANDLED;\n}\n\nstatic int tps6521x_pb_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct tps6521x_pwrbutton *pwr;\n\tstruct input_dev *idev;\n\tconst struct of_device_id *match;\n\tint error;\n\tint irq;\n\n\tmatch = of_match_node(of_tps6521x_pb_match, dev->of_node);\n\tif (!match)\n\t\treturn -ENXIO;\n\n\tpwr = devm_kzalloc(dev, sizeof(*pwr), GFP_KERNEL);\n\tif (!pwr)\n\t\treturn -ENOMEM;\n\n\tpwr->data = match->data;\n\n\tidev = devm_input_allocate_device(dev);\n\tif (!idev)\n\t\treturn -ENOMEM;\n\n\tidev->name = pwr->data->name;\n\tsnprintf(pwr->phys, sizeof(pwr->phys), \"%s/input0\",\n\t\tpwr->data->name);\n\tidev->phys = pwr->phys;\n\tidev->dev.parent = dev;\n\tidev->id.bustype = BUS_I2C;\n\n\tinput_set_capability(idev, EV_KEY, KEY_POWER);\n\n\tpwr->regmap = dev_get_regmap(dev->parent, NULL);\n\tpwr->dev = dev;\n\tpwr->idev = idev;\n\tdevice_init_wakeup(dev, true);\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn -EINVAL;\n\n\terror = devm_request_threaded_irq(dev, irq, NULL, tps6521x_pb_irq,\n\t\t\t\t\t  IRQF_TRIGGER_RISING |\n\t\t\t\t\t\tIRQF_TRIGGER_FALLING |\n\t\t\t\t\t\tIRQF_ONESHOT,\n\t\t\t\t\t  pwr->data->name, pwr);\n\tif (error) {\n\t\tdev_err(dev, \"failed to request IRQ #%d: %d\\n\", irq, error);\n\t\treturn error;\n\t}\n\n\terror= input_register_device(idev);\n\tif (error) {\n\t\tdev_err(dev, \"Can't register power button: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id tps6521x_pwrbtn_id_table[] = {\n\t{ \"tps65218-pwrbutton\", },\n\t{ \"tps65217-pwrbutton\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, tps6521x_pwrbtn_id_table);\n\nstatic struct platform_driver tps6521x_pb_driver = {\n\t.probe\t= tps6521x_pb_probe,\n\t.driver\t= {\n\t\t.name\t= \"tps6521x_pwrbutton\",\n\t\t.of_match_table = of_tps6521x_pb_match,\n\t},\n\t.id_table = tps6521x_pwrbtn_id_table,\n};\nmodule_platform_driver(tps6521x_pb_driver);\n\nMODULE_DESCRIPTION(\"TPS6521X Power Button\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Felipe Balbi <balbi@ti.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}