{
  "module_name": "ariel-pwrbutton.c",
  "hash_id": "922bb56ceb7ad4a8f031096ef0b2e251b4bd1e49f512e64243349dbdf9f2151c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/ariel-pwrbutton.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/gfp.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/spi/spi.h>\n\n#define RESP_COUNTER(response)\t(response.header & 0x3)\n#define RESP_SIZE(response)\t((response.header >> 2) & 0x3)\n#define RESP_TYPE(response)\t((response.header >> 4) & 0xf)\n\nstruct ec_input_response {\n\tu8 reserved;\n\tu8 header;\n\tu8 data[3];\n} __packed;\n\nstruct ariel_pwrbutton {\n\tstruct spi_device *client;\n\tstruct input_dev *input;\n\tu8 msg_counter;\n};\n\nstatic int ec_input_read(struct ariel_pwrbutton *priv,\n\t\t\t struct ec_input_response *response)\n{\n\tu8 read_request[] = { 0x00, 0x5a, 0xa5, 0x00, 0x00 };\n\tstruct spi_device *spi = priv->client;\n\tstruct spi_transfer t = {\n\t\t.tx_buf = read_request,\n\t\t.rx_buf = response,\n\t\t.len = sizeof(read_request),\n\t};\n\n\tcompiletime_assert(sizeof(read_request) == sizeof(*response),\n\t\t\t   \"SPI xfer request/response size mismatch\");\n\n\treturn spi_sync_transfer(spi, &t, 1);\n}\n\nstatic irqreturn_t ec_input_interrupt(int irq, void *dev_id)\n{\n\tstruct ariel_pwrbutton *priv = dev_id;\n\tstruct spi_device *spi = priv->client;\n\tstruct ec_input_response response;\n\tint error;\n\tint i;\n\n\terror = ec_input_read(priv, &response);\n\tif (error < 0) {\n\t\tdev_err(&spi->dev, \"EC read failed: %d\\n\", error);\n\t\tgoto out;\n\t}\n\n\tif (priv->msg_counter == RESP_COUNTER(response)) {\n\t\tdev_warn(&spi->dev, \"No new data to read?\\n\");\n\t\tgoto out;\n\t}\n\n\tpriv->msg_counter = RESP_COUNTER(response);\n\n\tif (RESP_TYPE(response) != 0x3 && RESP_TYPE(response) != 0xc) {\n\t\tdev_dbg(&spi->dev, \"Ignoring message that's not kbd data\\n\");\n\t\tgoto out;\n\t}\n\n\tfor (i = 0; i < RESP_SIZE(response); i++) {\n\t\tswitch (response.data[i]) {\n\t\tcase 0x74:\n\t\t\tinput_report_key(priv->input, KEY_POWER, 1);\n\t\t\tinput_sync(priv->input);\n\t\t\tbreak;\n\t\tcase 0xf4:\n\t\t\tinput_report_key(priv->input, KEY_POWER, 0);\n\t\t\tinput_sync(priv->input);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_dbg(&spi->dev, \"Unknown scan code: %02x\\n\",\n\t\t\t\tresponse.data[i]);\n\t\t}\n\t}\n\nout:\n\treturn IRQ_HANDLED;\n}\n\nstatic int ariel_pwrbutton_probe(struct spi_device *spi)\n{\n\tstruct ec_input_response response;\n\tstruct ariel_pwrbutton *priv;\n\tint error;\n\n\tif (!spi->irq) {\n\t\tdev_err(&spi->dev, \"Missing IRQ.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tpriv = devm_kzalloc(&spi->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->client = spi;\n\tspi_set_drvdata(spi, priv);\n\n\tpriv->input = devm_input_allocate_device(&spi->dev);\n\tif (!priv->input)\n\t\treturn -ENOMEM;\n\tpriv->input->name = \"Power Button\";\n\tpriv->input->dev.parent = &spi->dev;\n\tinput_set_capability(priv->input, EV_KEY, KEY_POWER);\n\terror = input_register_device(priv->input);\n\tif (error) {\n\t\tdev_err(&spi->dev, \"error registering input device: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\terror = ec_input_read(priv, &response);\n\tif (error < 0) {\n\t\tdev_err(&spi->dev, \"EC read failed: %d\\n\", error);\n\t\treturn error;\n\t}\n\tpriv->msg_counter = RESP_COUNTER(response);\n\n\terror = devm_request_threaded_irq(&spi->dev, spi->irq, NULL,\n\t\t\t\t\t  ec_input_interrupt,\n\t\t\t\t\t  IRQF_ONESHOT,\n\t\t\t\t\t  \"Ariel EC Input\", priv);\n\n\tif (error) {\n\t\tdev_err(&spi->dev, \"Failed to request IRQ %d: %d\\n\",\n\t\t\tspi->irq, error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id ariel_pwrbutton_of_match[] = {\n\t{ .compatible = \"dell,wyse-ariel-ec-input\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, ariel_pwrbutton_of_match);\n\nstatic const struct spi_device_id ariel_pwrbutton_spi_ids[] = {\n\t{ .name = \"wyse-ariel-ec-input\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, ariel_pwrbutton_spi_ids);\n\nstatic struct spi_driver ariel_pwrbutton_driver = {\n\t.driver = {\n\t\t.name = \"dell-wyse-ariel-ec-input\",\n\t\t.of_match_table = ariel_pwrbutton_of_match,\n\t},\n\t.probe = ariel_pwrbutton_probe,\n\t.id_table = ariel_pwrbutton_spi_ids,\n};\nmodule_spi_driver(ariel_pwrbutton_driver);\n\nMODULE_AUTHOR(\"Lubomir Rintel <lkundrak@v3.sk>\");\nMODULE_DESCRIPTION(\"Dell Wyse 3020 Power Button Input Driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}