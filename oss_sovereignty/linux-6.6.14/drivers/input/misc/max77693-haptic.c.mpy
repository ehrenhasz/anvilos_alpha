{
  "module_name": "max77693-haptic.c",
  "hash_id": "a919cd0d7e0d904ff22100ae53f40c4ade8c21e6b75a022ef427bea3073cb658",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/max77693-haptic.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/i2c.h>\n#include <linux/regmap.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/pwm.h>\n#include <linux/slab.h>\n#include <linux/workqueue.h>\n#include <linux/regulator/consumer.h>\n#include <linux/mfd/max77693.h>\n#include <linux/mfd/max77693-common.h>\n#include <linux/mfd/max77693-private.h>\n#include <linux/mfd/max77843-private.h>\n\n#define MAX_MAGNITUDE_SHIFT\t16\n\nenum max77693_haptic_motor_type {\n\tMAX77693_HAPTIC_ERM = 0,\n\tMAX77693_HAPTIC_LRA,\n};\n\nenum max77693_haptic_pulse_mode {\n\tMAX77693_HAPTIC_EXTERNAL_MODE = 0,\n\tMAX77693_HAPTIC_INTERNAL_MODE,\n};\n\nenum max77693_haptic_pwm_divisor {\n\tMAX77693_HAPTIC_PWM_DIVISOR_32 = 0,\n\tMAX77693_HAPTIC_PWM_DIVISOR_64,\n\tMAX77693_HAPTIC_PWM_DIVISOR_128,\n\tMAX77693_HAPTIC_PWM_DIVISOR_256,\n};\n\nstruct max77693_haptic {\n\tenum max77693_types dev_type;\n\n\tstruct regmap *regmap_pmic;\n\tstruct regmap *regmap_haptic;\n\tstruct device *dev;\n\tstruct input_dev *input_dev;\n\tstruct pwm_device *pwm_dev;\n\tstruct regulator *motor_reg;\n\n\tbool enabled;\n\tbool suspend_state;\n\tunsigned int magnitude;\n\tunsigned int pwm_duty;\n\tenum max77693_haptic_motor_type type;\n\tenum max77693_haptic_pulse_mode mode;\n\n\tstruct work_struct work;\n};\n\nstatic int max77693_haptic_set_duty_cycle(struct max77693_haptic *haptic)\n{\n\tstruct pwm_args pargs;\n\tint delta;\n\tint error;\n\n\tpwm_get_args(haptic->pwm_dev, &pargs);\n\tdelta = (pargs.period + haptic->pwm_duty) / 2;\n\terror = pwm_config(haptic->pwm_dev, delta, pargs.period);\n\tif (error) {\n\t\tdev_err(haptic->dev, \"failed to configure pwm: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77843_haptic_bias(struct max77693_haptic *haptic, bool on)\n{\n\tint error;\n\n\tif (haptic->dev_type != TYPE_MAX77843)\n\t\treturn 0;\n\n\terror = regmap_update_bits(haptic->regmap_haptic,\n\t\t\t\t   MAX77843_SYS_REG_MAINCTRL1,\n\t\t\t\t   MAX77843_MAINCTRL1_BIASEN_MASK,\n\t\t\t\t   on << MAINCTRL1_BIASEN_SHIFT);\n\tif (error) {\n\t\tdev_err(haptic->dev, \"failed to %s bias: %d\\n\",\n\t\t\ton ? \"enable\" : \"disable\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_haptic_configure(struct max77693_haptic *haptic,\n\t\t\t\t     bool enable)\n{\n\tunsigned int value, config_reg;\n\tint error;\n\n\tswitch (haptic->dev_type) {\n\tcase TYPE_MAX77693:\n\t\tvalue = ((haptic->type << MAX77693_CONFIG2_MODE) |\n\t\t\t(enable << MAX77693_CONFIG2_MEN) |\n\t\t\t(haptic->mode << MAX77693_CONFIG2_HTYP) |\n\t\t\tMAX77693_HAPTIC_PWM_DIVISOR_128);\n\t\tconfig_reg = MAX77693_HAPTIC_REG_CONFIG2;\n\t\tbreak;\n\tcase TYPE_MAX77843:\n\t\tvalue = (haptic->type << MCONFIG_MODE_SHIFT) |\n\t\t\t(enable << MCONFIG_MEN_SHIFT) |\n\t\t\tMAX77693_HAPTIC_PWM_DIVISOR_128;\n\t\tconfig_reg = MAX77843_HAP_REG_MCONFIG;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\terror = regmap_write(haptic->regmap_haptic,\n\t\t\t     config_reg, value);\n\tif (error) {\n\t\tdev_err(haptic->dev,\n\t\t\t\"failed to update haptic config: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_haptic_lowsys(struct max77693_haptic *haptic, bool enable)\n{\n\tint error;\n\n\tif (haptic->dev_type != TYPE_MAX77693)\n\t\treturn 0;\n\n\terror = regmap_update_bits(haptic->regmap_pmic,\n\t\t\t\t   MAX77693_PMIC_REG_LSCNFG,\n\t\t\t\t   MAX77693_PMIC_LOW_SYS_MASK,\n\t\t\t\t   enable << MAX77693_PMIC_LOW_SYS_SHIFT);\n\tif (error) {\n\t\tdev_err(haptic->dev, \"cannot update pmic regmap: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic void max77693_haptic_enable(struct max77693_haptic *haptic)\n{\n\tint error;\n\n\tif (haptic->enabled)\n\t\treturn;\n\n\terror = pwm_enable(haptic->pwm_dev);\n\tif (error) {\n\t\tdev_err(haptic->dev,\n\t\t\t\"failed to enable haptic pwm device: %d\\n\", error);\n\t\treturn;\n\t}\n\n\terror = max77693_haptic_lowsys(haptic, true);\n\tif (error)\n\t\tgoto err_enable_lowsys;\n\n\terror = max77693_haptic_configure(haptic, true);\n\tif (error)\n\t\tgoto err_enable_config;\n\n\thaptic->enabled = true;\n\n\treturn;\n\nerr_enable_config:\n\tmax77693_haptic_lowsys(haptic, false);\nerr_enable_lowsys:\n\tpwm_disable(haptic->pwm_dev);\n}\n\nstatic void max77693_haptic_disable(struct max77693_haptic *haptic)\n{\n\tint error;\n\n\tif (!haptic->enabled)\n\t\treturn;\n\n\terror = max77693_haptic_configure(haptic, false);\n\tif (error)\n\t\treturn;\n\n\terror = max77693_haptic_lowsys(haptic, false);\n\tif (error)\n\t\tgoto err_disable_lowsys;\n\n\tpwm_disable(haptic->pwm_dev);\n\thaptic->enabled = false;\n\n\treturn;\n\nerr_disable_lowsys:\n\tmax77693_haptic_configure(haptic, true);\n}\n\nstatic void max77693_haptic_play_work(struct work_struct *work)\n{\n\tstruct max77693_haptic *haptic =\n\t\t\tcontainer_of(work, struct max77693_haptic, work);\n\tint error;\n\n\terror = max77693_haptic_set_duty_cycle(haptic);\n\tif (error) {\n\t\tdev_err(haptic->dev, \"failed to set duty cycle: %d\\n\", error);\n\t\treturn;\n\t}\n\n\tif (haptic->magnitude)\n\t\tmax77693_haptic_enable(haptic);\n\telse\n\t\tmax77693_haptic_disable(haptic);\n}\n\nstatic int max77693_haptic_play_effect(struct input_dev *dev, void *data,\n\t\t\t\t       struct ff_effect *effect)\n{\n\tstruct max77693_haptic *haptic = input_get_drvdata(dev);\n\tstruct pwm_args pargs;\n\tu64 period_mag_multi;\n\n\thaptic->magnitude = effect->u.rumble.strong_magnitude;\n\tif (!haptic->magnitude)\n\t\thaptic->magnitude = effect->u.rumble.weak_magnitude;\n\n\t \n\tpwm_get_args(haptic->pwm_dev, &pargs);\n\tperiod_mag_multi = (u64)pargs.period * haptic->magnitude;\n\thaptic->pwm_duty = (unsigned int)(period_mag_multi >>\n\t\t\t\t\t\tMAX_MAGNITUDE_SHIFT);\n\n\tschedule_work(&haptic->work);\n\n\treturn 0;\n}\n\nstatic int max77693_haptic_open(struct input_dev *dev)\n{\n\tstruct max77693_haptic *haptic = input_get_drvdata(dev);\n\tint error;\n\n\terror = max77843_haptic_bias(haptic, true);\n\tif (error)\n\t\treturn error;\n\n\terror = regulator_enable(haptic->motor_reg);\n\tif (error) {\n\t\tdev_err(haptic->dev,\n\t\t\t\"failed to enable regulator: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic void max77693_haptic_close(struct input_dev *dev)\n{\n\tstruct max77693_haptic *haptic = input_get_drvdata(dev);\n\tint error;\n\n\tcancel_work_sync(&haptic->work);\n\tmax77693_haptic_disable(haptic);\n\n\terror = regulator_disable(haptic->motor_reg);\n\tif (error)\n\t\tdev_err(haptic->dev,\n\t\t\t\"failed to disable regulator: %d\\n\", error);\n\n\tmax77843_haptic_bias(haptic, false);\n}\n\nstatic int max77693_haptic_probe(struct platform_device *pdev)\n{\n\tstruct max77693_dev *max77693 = dev_get_drvdata(pdev->dev.parent);\n\tstruct max77693_haptic *haptic;\n\tint error;\n\n\thaptic = devm_kzalloc(&pdev->dev, sizeof(*haptic), GFP_KERNEL);\n\tif (!haptic)\n\t\treturn -ENOMEM;\n\n\thaptic->regmap_pmic = max77693->regmap;\n\thaptic->dev = &pdev->dev;\n\thaptic->type = MAX77693_HAPTIC_LRA;\n\thaptic->mode = MAX77693_HAPTIC_EXTERNAL_MODE;\n\thaptic->suspend_state = false;\n\n\t \n\thaptic->dev_type = platform_get_device_id(pdev)->driver_data;\n\tswitch (haptic->dev_type) {\n\tcase TYPE_MAX77693:\n\t\thaptic->regmap_haptic = max77693->regmap_haptic;\n\t\tbreak;\n\tcase TYPE_MAX77843:\n\t\thaptic->regmap_haptic = max77693->regmap;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"unsupported device type: %u\\n\",\n\t\t\thaptic->dev_type);\n\t\treturn -EINVAL;\n\t}\n\n\tINIT_WORK(&haptic->work, max77693_haptic_play_work);\n\n\t \n\thaptic->pwm_dev = devm_pwm_get(&pdev->dev, NULL);\n\tif (IS_ERR(haptic->pwm_dev)) {\n\t\tdev_err(&pdev->dev, \"failed to get pwm device\\n\");\n\t\treturn PTR_ERR(haptic->pwm_dev);\n\t}\n\n\t \n\tpwm_apply_args(haptic->pwm_dev);\n\n\thaptic->motor_reg = devm_regulator_get(&pdev->dev, \"haptic\");\n\tif (IS_ERR(haptic->motor_reg)) {\n\t\tdev_err(&pdev->dev, \"failed to get regulator\\n\");\n\t\treturn PTR_ERR(haptic->motor_reg);\n\t}\n\n\t \n\thaptic->input_dev = devm_input_allocate_device(&pdev->dev);\n\tif (!haptic->input_dev) {\n\t\tdev_err(&pdev->dev, \"failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\thaptic->input_dev->name = \"max77693-haptic\";\n\thaptic->input_dev->id.version = 1;\n\thaptic->input_dev->dev.parent = &pdev->dev;\n\thaptic->input_dev->open = max77693_haptic_open;\n\thaptic->input_dev->close = max77693_haptic_close;\n\tinput_set_drvdata(haptic->input_dev, haptic);\n\tinput_set_capability(haptic->input_dev, EV_FF, FF_RUMBLE);\n\n\terror = input_ff_create_memless(haptic->input_dev, NULL,\n\t\t\t\tmax77693_haptic_play_effect);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"failed to create force-feedback\\n\");\n\t\treturn error;\n\t}\n\n\terror = input_register_device(haptic->input_dev);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"failed to register input device\\n\");\n\t\treturn error;\n\t}\n\n\tplatform_set_drvdata(pdev, haptic);\n\n\treturn 0;\n}\n\nstatic int max77693_haptic_suspend(struct device *dev)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\tstruct max77693_haptic *haptic = platform_get_drvdata(pdev);\n\n\tif (haptic->enabled) {\n\t\tmax77693_haptic_disable(haptic);\n\t\thaptic->suspend_state = true;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_haptic_resume(struct device *dev)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\tstruct max77693_haptic *haptic = platform_get_drvdata(pdev);\n\n\tif (haptic->suspend_state) {\n\t\tmax77693_haptic_enable(haptic);\n\t\thaptic->suspend_state = false;\n\t}\n\n\treturn 0;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(max77693_haptic_pm_ops,\n\t\t\t\tmax77693_haptic_suspend,\n\t\t\t\tmax77693_haptic_resume);\n\nstatic const struct platform_device_id max77693_haptic_id[] = {\n\t{ \"max77693-haptic\", TYPE_MAX77693 },\n\t{ \"max77843-haptic\", TYPE_MAX77843 },\n\t{},\n};\nMODULE_DEVICE_TABLE(platform, max77693_haptic_id);\n\nstatic struct platform_driver max77693_haptic_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"max77693-haptic\",\n\t\t.pm\t= pm_sleep_ptr(&max77693_haptic_pm_ops),\n\t},\n\t.probe\t\t= max77693_haptic_probe,\n\t.id_table\t= max77693_haptic_id,\n};\nmodule_platform_driver(max77693_haptic_driver);\n\nMODULE_AUTHOR(\"Jaewon Kim <jaewon02.kim@samsung.com>\");\nMODULE_AUTHOR(\"Krzysztof Kozlowski <krzk@kernel.org>\");\nMODULE_DESCRIPTION(\"MAXIM 77693/77843 Haptic driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}