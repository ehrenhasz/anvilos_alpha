{
  "module_name": "rt5120-pwrkey.c",
  "hash_id": "7a6db73cd44e61d754cdeb313f63459e9287c127c60f1207957e2cbff0c28ba6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/rt5120-pwrkey.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define RT5120_REG_INTSTAT\t0x1E\n#define RT5120_PWRKEYSTAT_MASK\tBIT(7)\n\nstruct rt5120_priv {\n\tstruct regmap *regmap;\n\tstruct input_dev *input;\n};\n\nstatic irqreturn_t rt5120_pwrkey_handler(int irq, void *devid)\n{\n\tstruct rt5120_priv *priv = devid;\n\tunsigned int stat;\n\tint error;\n\n\terror = regmap_read(priv->regmap, RT5120_REG_INTSTAT, &stat);\n\tif (error)\n\t\treturn IRQ_NONE;\n\n\tinput_report_key(priv->input, KEY_POWER,\n\t\t\t !(stat & RT5120_PWRKEYSTAT_MASK));\n\tinput_sync(priv->input);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int rt5120_pwrkey_probe(struct platform_device *pdev)\n{\n\tstruct rt5120_priv *priv;\n\tstruct device *dev = &pdev->dev;\n\tint press_irq, release_irq;\n\tint error;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->regmap = dev_get_regmap(dev->parent, NULL);\n\tif (!priv->regmap) {\n\t\tdev_err(dev, \"Failed to init regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tpress_irq = platform_get_irq_byname(pdev, \"pwrkey-press\");\n\tif (press_irq < 0)\n\t\treturn press_irq;\n\n\trelease_irq = platform_get_irq_byname(pdev, \"pwrkey-release\");\n\tif (release_irq < 0)\n\t\treturn release_irq;\n\n\t \n\tpriv->input = devm_input_allocate_device(dev);\n\tif (!priv->input)\n\t\treturn -ENOMEM;\n\n\tpriv->input->name = \"rt5120_pwrkey\";\n\tpriv->input->phys = \"rt5120_pwrkey/input0\";\n\tpriv->input->id.bustype = BUS_I2C;\n\tinput_set_capability(priv->input, EV_KEY, KEY_POWER);\n\n\terror = input_register_device(priv->input);\n\tif (error) {\n\t\tdev_err(dev, \"Failed to register input device: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\terror = devm_request_threaded_irq(dev, press_irq,\n\t\t\t\t\t  NULL, rt5120_pwrkey_handler,\n\t\t\t\t\t  0, \"pwrkey-press\", priv);\n\tif (error) {\n\t\tdev_err(dev,\n\t\t\t\"Failed to register pwrkey press irq: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\terror = devm_request_threaded_irq(dev, release_irq,\n\t\t\t\t\t  NULL, rt5120_pwrkey_handler,\n\t\t\t\t\t  0, \"pwrkey-release\", priv);\n\tif (error) {\n\t\tdev_err(dev,\n\t\t\t\"Failed to register pwrkey release irq: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id r5120_pwrkey_match_table[] = {\n\t{ .compatible = \"richtek,rt5120-pwrkey\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, r5120_pwrkey_match_table);\n\nstatic struct platform_driver rt5120_pwrkey_driver = {\n\t.driver = {\n\t\t.name = \"rt5120-pwrkey\",\n\t\t.of_match_table = r5120_pwrkey_match_table,\n\t},\n\t.probe = rt5120_pwrkey_probe,\n};\nmodule_platform_driver(rt5120_pwrkey_driver);\n\nMODULE_AUTHOR(\"ChiYuan Huang <cy_huang@richtek.com>\");\nMODULE_DESCRIPTION(\"Richtek RT5120 power key driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}