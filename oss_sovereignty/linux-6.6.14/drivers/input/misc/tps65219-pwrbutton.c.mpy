{
  "module_name": "tps65219-pwrbutton.c",
  "hash_id": "ec4ac66679bd37bb7a4c39f0c698300a12680635f1e22a8190e404daced7148e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/tps65219-pwrbutton.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/tps65219.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\nstruct tps65219_pwrbutton {\n\tstruct device *dev;\n\tstruct input_dev *idev;\n\tchar phys[32];\n};\n\nstatic irqreturn_t tps65219_pb_push_irq(int irq, void *_pwr)\n{\n\tstruct tps65219_pwrbutton *pwr = _pwr;\n\n\tinput_report_key(pwr->idev, KEY_POWER, 1);\n\tpm_wakeup_event(pwr->dev, 0);\n\tinput_sync(pwr->idev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t tps65219_pb_release_irq(int irq, void *_pwr)\n{\n\tstruct tps65219_pwrbutton *pwr = _pwr;\n\n\tinput_report_key(pwr->idev, KEY_POWER, 0);\n\tinput_sync(pwr->idev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int tps65219_pb_probe(struct platform_device *pdev)\n{\n\tstruct tps65219 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct device *dev = &pdev->dev;\n\tstruct tps65219_pwrbutton *pwr;\n\tstruct input_dev *idev;\n\tint error;\n\tint push_irq;\n\tint release_irq;\n\n\tpwr = devm_kzalloc(dev, sizeof(*pwr), GFP_KERNEL);\n\tif (!pwr)\n\t\treturn -ENOMEM;\n\n\tidev = devm_input_allocate_device(dev);\n\tif (!idev)\n\t\treturn -ENOMEM;\n\n\tidev->name = pdev->name;\n\tsnprintf(pwr->phys, sizeof(pwr->phys), \"%s/input0\",\n\t\t pdev->name);\n\tidev->phys = pwr->phys;\n\tidev->id.bustype = BUS_I2C;\n\n\tinput_set_capability(idev, EV_KEY, KEY_POWER);\n\n\tpwr->dev = dev;\n\tpwr->idev = idev;\n\tdevice_init_wakeup(dev, true);\n\n\tpush_irq = platform_get_irq(pdev, 0);\n\tif (push_irq < 0)\n\t\treturn -EINVAL;\n\n\trelease_irq = platform_get_irq(pdev, 1);\n\tif (release_irq < 0)\n\t\treturn -EINVAL;\n\n\terror = devm_request_threaded_irq(dev, push_irq, NULL,\n\t\t\t\t\t  tps65219_pb_push_irq,\n\t\t\t\t\t  IRQF_ONESHOT,\n\t\t\t\t\t  dev->init_name, pwr);\n\tif (error) {\n\t\tdev_err(dev, \"failed to request push IRQ #%d: %d\\n\", push_irq,\n\t\t\terror);\n\t\treturn error;\n\t}\n\n\terror = devm_request_threaded_irq(dev, release_irq, NULL,\n\t\t\t\t\t  tps65219_pb_release_irq,\n\t\t\t\t\t  IRQF_ONESHOT,\n\t\t\t\t\t  dev->init_name, pwr);\n\tif (error) {\n\t\tdev_err(dev, \"failed to request release IRQ #%d: %d\\n\",\n\t\t\trelease_irq, error);\n\t\treturn error;\n\t}\n\n\terror = input_register_device(idev);\n\tif (error) {\n\t\tdev_err(dev, \"Can't register power button: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\t \n\tregmap_clear_bits(tps->regmap, TPS65219_REG_MASK_CONFIG,\n\t\t\t  TPS65219_REG_MASK_INT_FOR_PB_MASK);\n\n\t \n\tregmap_update_bits(tps->regmap, TPS65219_REG_MFP_2_CONFIG,\n\t\t\t   TPS65219_MFP_2_EN_PB_VSENSE_MASK, TPS65219_MFP_2_PB);\n\n\treturn 0;\n}\n\nstatic void tps65219_pb_remove(struct platform_device *pdev)\n{\n\tstruct tps65219 *tps = dev_get_drvdata(pdev->dev.parent);\n\tint ret;\n\n\t \n\tret = regmap_set_bits(tps->regmap, TPS65219_REG_MASK_CONFIG,\n\t\t\t      TPS65219_REG_MASK_INT_FOR_PB_MASK);\n\tif (ret)\n\t\tdev_warn(&pdev->dev, \"Failed to disable irq (%pe)\\n\", ERR_PTR(ret));\n}\n\nstatic const struct platform_device_id tps65219_pwrbtn_id_table[] = {\n\t{ \"tps65219-pwrbutton\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, tps65219_pwrbtn_id_table);\n\nstatic struct platform_driver tps65219_pb_driver = {\n\t.probe = tps65219_pb_probe,\n\t.remove_new = tps65219_pb_remove,\n\t.driver = {\n\t\t.name = \"tps65219_pwrbutton\",\n\t},\n\t.id_table = tps65219_pwrbtn_id_table,\n};\nmodule_platform_driver(tps65219_pb_driver);\n\nMODULE_DESCRIPTION(\"TPS65219 Power Button\");\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Markus Schneider-Pargmann <msp@baylibre.com\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}