{
  "module_name": "max77650-onkey.c",
  "hash_id": "3c7a2633d5c34d1fc36c1595418fd5339212af3e093e5475f1aa6c45eef1f08b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/max77650-onkey.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/max77650.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define MAX77650_ONKEY_MODE_MASK\tBIT(3)\n#define MAX77650_ONKEY_MODE_PUSH\t0x00\n#define MAX77650_ONKEY_MODE_SLIDE\tBIT(3)\n\nstruct max77650_onkey {\n\tstruct input_dev *input;\n\tunsigned int code;\n};\n\nstatic irqreturn_t max77650_onkey_falling(int irq, void *data)\n{\n\tstruct max77650_onkey *onkey = data;\n\n\tinput_report_key(onkey->input, onkey->code, 0);\n\tinput_sync(onkey->input);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t max77650_onkey_rising(int irq, void *data)\n{\n\tstruct max77650_onkey *onkey = data;\n\n\tinput_report_key(onkey->input, onkey->code, 1);\n\tinput_sync(onkey->input);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int max77650_onkey_probe(struct platform_device *pdev)\n{\n\tint irq_r, irq_f, error, mode;\n\tstruct max77650_onkey *onkey;\n\tstruct device *dev, *parent;\n\tstruct regmap *map;\n\tunsigned int type;\n\n\tdev = &pdev->dev;\n\tparent = dev->parent;\n\n\tmap = dev_get_regmap(parent, NULL);\n\tif (!map)\n\t\treturn -ENODEV;\n\n\tonkey = devm_kzalloc(dev, sizeof(*onkey), GFP_KERNEL);\n\tif (!onkey)\n\t\treturn -ENOMEM;\n\n\terror = device_property_read_u32(dev, \"linux,code\", &onkey->code);\n\tif (error)\n\t\tonkey->code = KEY_POWER;\n\n\tif (device_property_read_bool(dev, \"maxim,onkey-slide\")) {\n\t\tmode = MAX77650_ONKEY_MODE_SLIDE;\n\t\ttype = EV_SW;\n\t} else {\n\t\tmode = MAX77650_ONKEY_MODE_PUSH;\n\t\ttype = EV_KEY;\n\t}\n\n\terror = regmap_update_bits(map, MAX77650_REG_CNFG_GLBL,\n\t\t\t\t   MAX77650_ONKEY_MODE_MASK, mode);\n\tif (error)\n\t\treturn error;\n\n\tirq_f = platform_get_irq_byname(pdev, \"nEN_F\");\n\tif (irq_f < 0)\n\t\treturn irq_f;\n\n\tirq_r = platform_get_irq_byname(pdev, \"nEN_R\");\n\tif (irq_r < 0)\n\t\treturn irq_r;\n\n\tonkey->input = devm_input_allocate_device(dev);\n\tif (!onkey->input)\n\t\treturn -ENOMEM;\n\n\tonkey->input->name = \"max77650_onkey\";\n\tonkey->input->phys = \"max77650_onkey/input0\";\n\tonkey->input->id.bustype = BUS_I2C;\n\tinput_set_capability(onkey->input, type, onkey->code);\n\n\terror = devm_request_any_context_irq(dev, irq_f, max77650_onkey_falling,\n\t\t\t\t\t     IRQF_ONESHOT, \"onkey-down\", onkey);\n\tif (error < 0)\n\t\treturn error;\n\n\terror = devm_request_any_context_irq(dev, irq_r, max77650_onkey_rising,\n\t\t\t\t\t     IRQF_ONESHOT, \"onkey-up\", onkey);\n\tif (error < 0)\n\t\treturn error;\n\n\treturn input_register_device(onkey->input);\n}\n\nstatic const struct of_device_id max77650_onkey_of_match[] = {\n\t{ .compatible = \"maxim,max77650-onkey\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max77650_onkey_of_match);\n\nstatic struct platform_driver max77650_onkey_driver = {\n\t.driver = {\n\t\t.name = \"max77650-onkey\",\n\t\t.of_match_table = max77650_onkey_of_match,\n\t},\n\t.probe = max77650_onkey_probe,\n};\nmodule_platform_driver(max77650_onkey_driver);\n\nMODULE_DESCRIPTION(\"MAXIM 77650/77651 ONKEY driver\");\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:max77650-onkey\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}