{
  "module_name": "pcap_keys.c",
  "hash_id": "4a6267553200f949d77a7d8b3bd7311fabac9746a3e28b14f208800ee33419e6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/pcap_keys.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/input.h>\n#include <linux/mfd/ezx-pcap.h>\n#include <linux/slab.h>\n\nstruct pcap_keys {\n\tstruct pcap_chip *pcap;\n\tstruct input_dev *input;\n};\n\n \nstatic irqreturn_t pcap_keys_handler(int irq, void *_pcap_keys)\n{\n\tstruct pcap_keys *pcap_keys = _pcap_keys;\n\tint pirq = irq_to_pcap(pcap_keys->pcap, irq);\n\tu32 pstat;\n\n\tezx_pcap_read(pcap_keys->pcap, PCAP_REG_PSTAT, &pstat);\n\tpstat &= 1 << pirq;\n\n\tswitch (pirq) {\n\tcase PCAP_IRQ_ONOFF:\n\t\tinput_report_key(pcap_keys->input, KEY_POWER, !pstat);\n\t\tbreak;\n\tcase PCAP_IRQ_MIC:\n\t\tinput_report_key(pcap_keys->input, KEY_HP, !pstat);\n\t\tbreak;\n\t}\n\n\tinput_sync(pcap_keys->input);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int pcap_keys_probe(struct platform_device *pdev)\n{\n\tint err = -ENOMEM;\n\tstruct pcap_keys *pcap_keys;\n\tstruct input_dev *input_dev;\n\n\tpcap_keys = kmalloc(sizeof(struct pcap_keys), GFP_KERNEL);\n\tif (!pcap_keys)\n\t\treturn err;\n\n\tpcap_keys->pcap = dev_get_drvdata(pdev->dev.parent);\n\n\tinput_dev = input_allocate_device();\n\tif (!input_dev)\n\t\tgoto fail;\n\n\tpcap_keys->input = input_dev;\n\n\tplatform_set_drvdata(pdev, pcap_keys);\n\tinput_dev->name = pdev->name;\n\tinput_dev->phys = \"pcap-keys/input0\";\n\tinput_dev->id.bustype = BUS_HOST;\n\tinput_dev->dev.parent = &pdev->dev;\n\n\t__set_bit(EV_KEY, input_dev->evbit);\n\t__set_bit(KEY_POWER, input_dev->keybit);\n\t__set_bit(KEY_HP, input_dev->keybit);\n\n\terr = input_register_device(input_dev);\n\tif (err)\n\t\tgoto fail_allocate;\n\n\terr = request_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_ONOFF),\n\t\t\tpcap_keys_handler, 0, \"Power key\", pcap_keys);\n\tif (err)\n\t\tgoto fail_register;\n\n\terr = request_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_MIC),\n\t\t\tpcap_keys_handler, 0, \"Headphone button\", pcap_keys);\n\tif (err)\n\t\tgoto fail_pwrkey;\n\n\treturn 0;\n\nfail_pwrkey:\n\tfree_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_ONOFF), pcap_keys);\nfail_register:\n\tinput_unregister_device(input_dev);\n\tgoto fail;\nfail_allocate:\n\tinput_free_device(input_dev);\nfail:\n\tkfree(pcap_keys);\n\treturn err;\n}\n\nstatic int pcap_keys_remove(struct platform_device *pdev)\n{\n\tstruct pcap_keys *pcap_keys = platform_get_drvdata(pdev);\n\n\tfree_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_ONOFF), pcap_keys);\n\tfree_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_MIC), pcap_keys);\n\n\tinput_unregister_device(pcap_keys->input);\n\tkfree(pcap_keys);\n\n\treturn 0;\n}\n\nstatic struct platform_driver pcap_keys_device_driver = {\n\t.probe\t\t= pcap_keys_probe,\n\t.remove\t\t= pcap_keys_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"pcap-keys\",\n\t}\n};\nmodule_platform_driver(pcap_keys_device_driver);\n\nMODULE_DESCRIPTION(\"Motorola PCAP2 input events driver\");\nMODULE_AUTHOR(\"Ilya Petrov <ilya.muromec@gmail.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:pcap_keys\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}