{
  "module_name": "pwm-beeper.c",
  "hash_id": "fe38ff4d24d5289bd42d23d27c906db82e0672ede70362d2efbc4114b848f5ca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/misc/pwm-beeper.c",
  "human_readable_source": "\n \n\n#include <linux/input.h>\n#include <linux/regulator/consumer.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/pwm.h>\n#include <linux/slab.h>\n#include <linux/workqueue.h>\n\nstruct pwm_beeper {\n\tstruct input_dev *input;\n\tstruct pwm_device *pwm;\n\tstruct regulator *amplifier;\n\tstruct work_struct work;\n\tunsigned long period;\n\tunsigned int bell_frequency;\n\tbool suspended;\n\tbool amplifier_on;\n};\n\n#define HZ_TO_NANOSECONDS(x) (1000000000UL/(x))\n\nstatic int pwm_beeper_on(struct pwm_beeper *beeper, unsigned long period)\n{\n\tstruct pwm_state state;\n\tint error;\n\n\tpwm_get_state(beeper->pwm, &state);\n\n\tstate.enabled = true;\n\tstate.period = period;\n\tpwm_set_relative_duty_cycle(&state, 50, 100);\n\n\terror = pwm_apply_state(beeper->pwm, &state);\n\tif (error)\n\t\treturn error;\n\n\tif (!beeper->amplifier_on) {\n\t\terror = regulator_enable(beeper->amplifier);\n\t\tif (error) {\n\t\t\tpwm_disable(beeper->pwm);\n\t\t\treturn error;\n\t\t}\n\n\t\tbeeper->amplifier_on = true;\n\t}\n\n\treturn 0;\n}\n\nstatic void pwm_beeper_off(struct pwm_beeper *beeper)\n{\n\tif (beeper->amplifier_on) {\n\t\tregulator_disable(beeper->amplifier);\n\t\tbeeper->amplifier_on = false;\n\t}\n\n\tpwm_disable(beeper->pwm);\n}\n\nstatic void pwm_beeper_work(struct work_struct *work)\n{\n\tstruct pwm_beeper *beeper = container_of(work, struct pwm_beeper, work);\n\tunsigned long period = READ_ONCE(beeper->period);\n\n\tif (period)\n\t\tpwm_beeper_on(beeper, period);\n\telse\n\t\tpwm_beeper_off(beeper);\n}\n\nstatic int pwm_beeper_event(struct input_dev *input,\n\t\t\t    unsigned int type, unsigned int code, int value)\n{\n\tstruct pwm_beeper *beeper = input_get_drvdata(input);\n\n\tif (type != EV_SND || value < 0)\n\t\treturn -EINVAL;\n\n\tswitch (code) {\n\tcase SND_BELL:\n\t\tvalue = value ? beeper->bell_frequency : 0;\n\t\tbreak;\n\tcase SND_TONE:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (value == 0)\n\t\tbeeper->period = 0;\n\telse\n\t\tbeeper->period = HZ_TO_NANOSECONDS(value);\n\n\tif (!beeper->suspended)\n\t\tschedule_work(&beeper->work);\n\n\treturn 0;\n}\n\nstatic void pwm_beeper_stop(struct pwm_beeper *beeper)\n{\n\tcancel_work_sync(&beeper->work);\n\tpwm_beeper_off(beeper);\n}\n\nstatic void pwm_beeper_close(struct input_dev *input)\n{\n\tstruct pwm_beeper *beeper = input_get_drvdata(input);\n\n\tpwm_beeper_stop(beeper);\n}\n\nstatic int pwm_beeper_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct pwm_beeper *beeper;\n\tstruct pwm_state state;\n\tu32 bell_frequency;\n\tint error;\n\n\tbeeper = devm_kzalloc(dev, sizeof(*beeper), GFP_KERNEL);\n\tif (!beeper)\n\t\treturn -ENOMEM;\n\n\tbeeper->pwm = devm_pwm_get(dev, NULL);\n\tif (IS_ERR(beeper->pwm))\n\t\treturn dev_err_probe(dev, PTR_ERR(beeper->pwm), \"Failed to request PWM device\\n\");\n\n\t \n\tpwm_init_state(beeper->pwm, &state);\n\tstate.enabled = false;\n\terror = pwm_apply_state(beeper->pwm, &state);\n\tif (error) {\n\t\tdev_err(dev, \"failed to apply initial PWM state: %d\\n\",\n\t\t\terror);\n\t\treturn error;\n\t}\n\n\tbeeper->amplifier = devm_regulator_get(dev, \"amp\");\n\tif (IS_ERR(beeper->amplifier))\n\t\treturn dev_err_probe(dev, PTR_ERR(beeper->amplifier),\n\t\t\t\t     \"Failed to get 'amp' regulator\\n\");\n\n\tINIT_WORK(&beeper->work, pwm_beeper_work);\n\n\terror = device_property_read_u32(dev, \"beeper-hz\", &bell_frequency);\n\tif (error) {\n\t\tbell_frequency = 1000;\n\t\tdev_dbg(dev,\n\t\t\t\"failed to parse 'beeper-hz' property, using default: %uHz\\n\",\n\t\t\tbell_frequency);\n\t}\n\n\tbeeper->bell_frequency = bell_frequency;\n\n\tbeeper->input = devm_input_allocate_device(dev);\n\tif (!beeper->input) {\n\t\tdev_err(dev, \"Failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tbeeper->input->name = \"pwm-beeper\";\n\tbeeper->input->phys = \"pwm/input0\";\n\tbeeper->input->id.bustype = BUS_HOST;\n\tbeeper->input->id.vendor = 0x001f;\n\tbeeper->input->id.product = 0x0001;\n\tbeeper->input->id.version = 0x0100;\n\n\tinput_set_capability(beeper->input, EV_SND, SND_TONE);\n\tinput_set_capability(beeper->input, EV_SND, SND_BELL);\n\n\tbeeper->input->event = pwm_beeper_event;\n\tbeeper->input->close = pwm_beeper_close;\n\n\tinput_set_drvdata(beeper->input, beeper);\n\n\terror = input_register_device(beeper->input);\n\tif (error) {\n\t\tdev_err(dev, \"Failed to register input device: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\tplatform_set_drvdata(pdev, beeper);\n\n\treturn 0;\n}\n\nstatic int pwm_beeper_suspend(struct device *dev)\n{\n\tstruct pwm_beeper *beeper = dev_get_drvdata(dev);\n\n\t \n\tspin_lock_irq(&beeper->input->event_lock);\n\tbeeper->suspended = true;\n\tspin_unlock_irq(&beeper->input->event_lock);\n\n\tpwm_beeper_stop(beeper);\n\n\treturn 0;\n}\n\nstatic int pwm_beeper_resume(struct device *dev)\n{\n\tstruct pwm_beeper *beeper = dev_get_drvdata(dev);\n\n\tspin_lock_irq(&beeper->input->event_lock);\n\tbeeper->suspended = false;\n\tspin_unlock_irq(&beeper->input->event_lock);\n\n\t \n\tschedule_work(&beeper->work);\n\n\treturn 0;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(pwm_beeper_pm_ops,\n\t\t\t\tpwm_beeper_suspend, pwm_beeper_resume);\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id pwm_beeper_match[] = {\n\t{ .compatible = \"pwm-beeper\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, pwm_beeper_match);\n#endif\n\nstatic struct platform_driver pwm_beeper_driver = {\n\t.probe\t= pwm_beeper_probe,\n\t.driver = {\n\t\t.name\t= \"pwm-beeper\",\n\t\t.pm\t= pm_sleep_ptr(&pwm_beeper_pm_ops),\n\t\t.of_match_table = of_match_ptr(pwm_beeper_match),\n\t},\n};\nmodule_platform_driver(pwm_beeper_driver);\n\nMODULE_AUTHOR(\"Lars-Peter Clausen <lars@metafoo.de>\");\nMODULE_DESCRIPTION(\"PWM beeper driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:pwm-beeper\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}