{
  "module_name": "stowaway.c",
  "hash_id": "e30e0d8ed3540f45041786205b5d5bd172a5d3e34070e9acf2e471784b3927a5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/stowaway.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/input.h>\n#include <linux/serio.h>\n\n#define DRIVER_DESC\t\"Stowaway keyboard driver\"\n\nMODULE_AUTHOR(\"Marek Vasut <marek.vasut@gmail.com>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\n\n#define SKBD_KEY_MASK\t0x7f\n#define SKBD_RELEASE\t0x80\n\nstatic unsigned char skbd_keycode[128] = {\n\tKEY_1, KEY_2, KEY_3, KEY_Z, KEY_4, KEY_5, KEY_6, KEY_7,\n\t0, KEY_Q, KEY_W, KEY_E, KEY_R, KEY_T, KEY_Y, KEY_GRAVE,\n\tKEY_X, KEY_A, KEY_S, KEY_D, KEY_F, KEY_G, KEY_H, KEY_SPACE,\n\tKEY_CAPSLOCK, KEY_TAB, KEY_LEFTCTRL, 0, 0, 0, 0, 0,\n\t0, 0, 0, KEY_LEFTALT, 0, 0, 0, 0,\n\t0, 0, 0, 0, KEY_C, KEY_V, KEY_B, KEY_N,\n\tKEY_MINUS, KEY_EQUAL, KEY_BACKSPACE, KEY_HOME, KEY_8, KEY_9, KEY_0, KEY_ESC,\n\tKEY_LEFTBRACE, KEY_RIGHTBRACE, KEY_BACKSLASH, KEY_END, KEY_U, KEY_I, KEY_O, KEY_P,\n\tKEY_APOSTROPHE, KEY_ENTER, KEY_PAGEUP,0, KEY_J, KEY_K, KEY_L, KEY_SEMICOLON,\n\tKEY_SLASH, KEY_UP, KEY_PAGEDOWN, 0,KEY_M, KEY_COMMA, KEY_DOT, KEY_INSERT,\n\tKEY_DELETE, KEY_LEFT, KEY_DOWN, KEY_RIGHT,  0, 0, 0,\n\tKEY_LEFTSHIFT, KEY_RIGHTSHIFT, 0, 0, 0, 0, 0,\n\t0, 0, 0, 0, 0, 0, 0, 0,\n\t0, 0, 0, 0, 0, 0, 0, 0,\n\t0, KEY_F1, KEY_F2, KEY_F3, KEY_F4, KEY_F5, KEY_F6, KEY_F7,\n\tKEY_F8, KEY_F9, KEY_F10, KEY_F11, KEY_F12, 0, 0, 0\n};\n\nstruct skbd {\n\tunsigned char keycode[128];\n\tstruct input_dev *dev;\n\tstruct serio *serio;\n\tchar phys[32];\n};\n\nstatic irqreturn_t skbd_interrupt(struct serio *serio, unsigned char data,\n\t\t\t\t  unsigned int flags)\n{\n\tstruct skbd *skbd = serio_get_drvdata(serio);\n\tstruct input_dev *dev = skbd->dev;\n\n\tif (skbd->keycode[data & SKBD_KEY_MASK]) {\n\t\tinput_report_key(dev, skbd->keycode[data & SKBD_KEY_MASK],\n\t\t\t\t !(data & SKBD_RELEASE));\n\t\tinput_sync(dev);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int skbd_connect(struct serio *serio, struct serio_driver *drv)\n{\n\tstruct skbd *skbd;\n\tstruct input_dev *input_dev;\n\tint err = -ENOMEM;\n\tint i;\n\n\tskbd = kzalloc(sizeof(struct skbd), GFP_KERNEL);\n\tinput_dev = input_allocate_device();\n\tif (!skbd || !input_dev)\n\t\tgoto fail1;\n\n\tskbd->serio = serio;\n\tskbd->dev = input_dev;\n\tsnprintf(skbd->phys, sizeof(skbd->phys), \"%s/input0\", serio->phys);\n\tmemcpy(skbd->keycode, skbd_keycode, sizeof(skbd->keycode));\n\n\tinput_dev->name = \"Stowaway Keyboard\";\n\tinput_dev->phys = skbd->phys;\n\tinput_dev->id.bustype = BUS_RS232;\n\tinput_dev->id.vendor = SERIO_STOWAWAY;\n\tinput_dev->id.product = 0x0001;\n\tinput_dev->id.version = 0x0100;\n\tinput_dev->dev.parent = &serio->dev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);\n\tinput_dev->keycode = skbd->keycode;\n\tinput_dev->keycodesize = sizeof(unsigned char);\n\tinput_dev->keycodemax = ARRAY_SIZE(skbd_keycode);\n\tfor (i = 0; i < ARRAY_SIZE(skbd_keycode); i++)\n\t\tset_bit(skbd_keycode[i], input_dev->keybit);\n\tclear_bit(0, input_dev->keybit);\n\n\tserio_set_drvdata(serio, skbd);\n\n\terr = serio_open(serio, drv);\n\tif (err)\n\t\tgoto fail2;\n\n\terr = input_register_device(skbd->dev);\n\tif (err)\n\t\tgoto fail3;\n\n\treturn 0;\n\n fail3: serio_close(serio);\n fail2:\tserio_set_drvdata(serio, NULL);\n fail1:\tinput_free_device(input_dev);\n\tkfree(skbd);\n\treturn err;\n}\n\nstatic void skbd_disconnect(struct serio *serio)\n{\n\tstruct skbd *skbd = serio_get_drvdata(serio);\n\n\tserio_close(serio);\n\tserio_set_drvdata(serio, NULL);\n\tinput_unregister_device(skbd->dev);\n\tkfree(skbd);\n}\n\nstatic const struct serio_device_id skbd_serio_ids[] = {\n\t{\n\t\t.type\t= SERIO_RS232,\n\t\t.proto\t= SERIO_STOWAWAY,\n\t\t.id\t= SERIO_ANY,\n\t\t.extra\t= SERIO_ANY,\n\t},\n\t{ 0 }\n};\n\nMODULE_DEVICE_TABLE(serio, skbd_serio_ids);\n\nstatic struct serio_driver skbd_drv = {\n\t.driver\t\t= {\n\t\t.name\t= \"stowaway\",\n\t},\n\t.description\t= DRIVER_DESC,\n\t.id_table\t= skbd_serio_ids,\n\t.interrupt\t= skbd_interrupt,\n\t.connect\t= skbd_connect,\n\t.disconnect\t= skbd_disconnect,\n};\n\nmodule_serio_driver(skbd_drv);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}