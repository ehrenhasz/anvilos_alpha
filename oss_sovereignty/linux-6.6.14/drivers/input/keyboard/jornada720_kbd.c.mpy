{
  "module_name": "jornada720_kbd.c",
  "hash_id": "00acee6ea71e66fe8e25c6d2328b0e2e5d25c75d1430f0f8b32e2b3a136877fe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/jornada720_kbd.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include <linux/errno.h>\n#include <linux/interrupt.h>\n#include <linux/input.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n#include <mach/jornada720.h>\n\nMODULE_AUTHOR(\"Kristoffer Ericson <Kristoffer.Ericson@gmail.com>\");\nMODULE_DESCRIPTION(\"HP Jornada 710/720/728 keyboard driver\");\nMODULE_LICENSE(\"GPL v2\");\n\nstatic unsigned short jornada_std_keymap[128] = {\t\t\t\t\t \n\t0, KEY_ESC, KEY_F1, KEY_F2, KEY_F3, KEY_F4, KEY_F5, KEY_F6, KEY_F7,\t\t \n\tKEY_F8, KEY_F9, KEY_F10, KEY_F11, KEY_VOLUMEUP, KEY_VOLUMEDOWN, KEY_MUTE,\t \n\t0, KEY_1, KEY_2, KEY_3, KEY_4, KEY_5, KEY_6, KEY_7, KEY_8, KEY_9,\t\t \n\tKEY_0, KEY_MINUS, KEY_EQUAL,0, 0, 0,\t\t\t\t\t\t \n\t0, KEY_Q, KEY_W, KEY_E, KEY_R, KEY_T, KEY_Y, KEY_U, KEY_I, KEY_O,\t\t \n\tKEY_P, KEY_BACKSLASH, KEY_BACKSPACE, 0, 0, 0,\t\t\t\t\t \n\t0, KEY_A, KEY_S, KEY_D, KEY_F, KEY_G, KEY_H, KEY_J, KEY_K, KEY_L,\t\t \n\tKEY_SEMICOLON, KEY_LEFTBRACE, KEY_RIGHTBRACE, 0, 0, 0,\t\t\t\t \n\t0, KEY_Z, KEY_X, KEY_C, KEY_V, KEY_B, KEY_N, KEY_M, KEY_COMMA,\t\t\t \n\tKEY_DOT, KEY_KPMINUS, KEY_APOSTROPHE, KEY_ENTER, 0, 0,0,\t\t\t \n\t0, KEY_TAB, 0, KEY_LEFTSHIFT, 0, KEY_APOSTROPHE, 0, 0, 0, 0,\t\t\t \n\tKEY_UP, 0, KEY_RIGHTSHIFT, 0, 0, 0,0, 0, 0, 0, 0, KEY_LEFTALT, KEY_GRAVE,\t \n\t0, 0, KEY_LEFT, KEY_DOWN, KEY_RIGHT, 0, 0, 0, 0,0, KEY_KPASTERISK,\t\t \n\tKEY_LEFTCTRL, 0, KEY_SPACE, 0, 0, 0, KEY_SLASH, KEY_DELETE, 0, 0,\t\t \n\t0, 0, 0, KEY_POWER,\t\t\t\t\t\t\t\t \n};\n\nstruct jornadakbd {\n\tunsigned short keymap[ARRAY_SIZE(jornada_std_keymap)];\n\tstruct input_dev *input;\n};\n\nstatic irqreturn_t jornada720_kbd_interrupt(int irq, void *dev_id)\n{\n\tstruct platform_device *pdev = dev_id;\n\tstruct jornadakbd *jornadakbd = platform_get_drvdata(pdev);\n\tstruct input_dev *input = jornadakbd->input;\n\tu8 count, kbd_data, scan_code;\n\n\t \n\tjornada_ssp_start();\n\n\tif (jornada_ssp_inout(GETSCANKEYCODE) != TXDUMMY) {\n\t\tdev_dbg(&pdev->dev,\n\t\t\t\"GetKeycode command failed with ETIMEDOUT, flushed bus\\n\");\n\t} else {\n\t\t \n\t\tcount = jornada_ssp_byte(TXDUMMY);\n\n\t\t \n\t\twhile (count--) {\n\t\t\t \n\t\t\tkbd_data = jornada_ssp_byte(TXDUMMY);\n\t\t\tscan_code = kbd_data & 0x7f;\n\n\t\t\tinput_event(input, EV_MSC, MSC_SCAN, scan_code);\n\t\t\tinput_report_key(input, jornadakbd->keymap[scan_code],\n\t\t\t\t\t !(kbd_data & 0x80));\n\t\t\tinput_sync(input);\n\t\t}\n\t}\n\n\t \n\tjornada_ssp_end();\n\n\treturn IRQ_HANDLED;\n};\n\nstatic int jornada720_kbd_probe(struct platform_device *pdev)\n{\n\tstruct jornadakbd *jornadakbd;\n\tstruct input_dev *input_dev;\n\tint i, err, irq;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq <= 0)\n\t\treturn irq < 0 ? irq : -EINVAL;\n\n\tjornadakbd = devm_kzalloc(&pdev->dev, sizeof(*jornadakbd), GFP_KERNEL);\n\tinput_dev = devm_input_allocate_device(&pdev->dev);\n\tif (!jornadakbd || !input_dev)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, jornadakbd);\n\n\tmemcpy(jornadakbd->keymap, jornada_std_keymap,\n\t\tsizeof(jornada_std_keymap));\n\tjornadakbd->input = input_dev;\n\n\tinput_dev->evbit[0] = BIT(EV_KEY) | BIT(EV_REP);\n\tinput_dev->name = \"HP Jornada 720 keyboard\";\n\tinput_dev->phys = \"jornadakbd/input0\";\n\tinput_dev->keycode = jornadakbd->keymap;\n\tinput_dev->keycodesize = sizeof(unsigned short);\n\tinput_dev->keycodemax = ARRAY_SIZE(jornada_std_keymap);\n\tinput_dev->id.bustype = BUS_HOST;\n\tinput_dev->dev.parent = &pdev->dev;\n\n\tfor (i = 0; i < ARRAY_SIZE(jornadakbd->keymap); i++)\n\t\t__set_bit(jornadakbd->keymap[i], input_dev->keybit);\n\t__clear_bit(KEY_RESERVED, input_dev->keybit);\n\n\tinput_set_capability(input_dev, EV_MSC, MSC_SCAN);\n\n\terr = devm_request_irq(&pdev->dev, irq, jornada720_kbd_interrupt,\n\t\t\t       IRQF_TRIGGER_FALLING, \"jornadakbd\", pdev);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"unable to grab IRQ%d: %d\\n\", irq, err);\n\t\treturn err;\n\t}\n\n\treturn input_register_device(jornadakbd->input);\n};\n\n \nMODULE_ALIAS(\"platform:jornada720_kbd\");\n\nstatic struct platform_driver jornada720_kbd_driver = {\n\t.driver  = {\n\t\t.name    = \"jornada720_kbd\",\n\t },\n\t.probe   = jornada720_kbd_probe,\n};\nmodule_platform_driver(jornada720_kbd_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}