{
  "module_name": "jornada680_kbd.c",
  "hash_id": "134ca4568e63ebef62a21dc6713eef7f99e84f46deafb9fe20f557b635a0ca4f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/jornada680_kbd.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/jiffies.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n#include <asm/delay.h>\n#include <asm/io.h>\n\n#define PCCR 0xa4000104\n#define PDCR 0xa4000106\n#define PECR 0xa4000108\n#define PFCR 0xa400010a\n#define PCDR 0xa4000124\n#define PDDR 0xa4000126\n#define PEDR 0xa4000128\n#define PFDR 0xa400012a\n#define PGDR 0xa400012c\n#define PHDR 0xa400012e\n#define PJDR 0xa4000130\n#define PKDR 0xa4000132\n#define PLDR 0xa4000134\n\nstatic const unsigned short jornada_scancodes[] = {\n \tKEY_CAPSLOCK, KEY_MACRO, KEY_LEFTCTRL, 0, KEY_ESC, KEY_KP5, 0, 0,\t\t\t \n\t\tKEY_F1, KEY_F2, KEY_F3, KEY_F8, KEY_F7, KEY_F6, KEY_F4, KEY_F5,\t\t\t\t \n \tKEY_SLASH, KEY_APOSTROPHE, KEY_ENTER, 0, KEY_Z, 0, 0, 0,\t\t\t\t \n\t\tKEY_X, KEY_C, KEY_V, KEY_DOT, KEY_COMMA, KEY_M, KEY_B, KEY_N,\t\t\t\t \n \tKEY_KP2, KEY_KP6, KEY_KP3, 0, 0, 0, 0, 0,\t\t\t\t\t\t \n\t\tKEY_F10, KEY_RO, KEY_F9, KEY_KP4, KEY_NUMLOCK, KEY_SCROLLLOCK, KEY_LEFTALT, KEY_HANJA,\t \n \tKEY_KATAKANA, KEY_KP0, KEY_GRAVE, 0, KEY_FINANCE, 0, 0, 0,\t\t\t\t \n\t\tKEY_KPMINUS, KEY_HIRAGANA, KEY_SPACE, KEY_KPDOT, KEY_VOLUMEUP, 249, 0, 0,\t\t \n \tKEY_SEMICOLON, KEY_RIGHTBRACE, KEY_BACKSLASH, 0, KEY_A, 0, 0, 0,\t\t\t \n\t\tKEY_S, KEY_D, KEY_F, KEY_L, KEY_K, KEY_J, KEY_G, KEY_H,\t\t\t\t\t \n \tKEY_KP8, KEY_LEFTMETA, KEY_RIGHTSHIFT, 0, KEY_TAB, 0, 0, 0,\t\t\t\t \n\t\t0, KEY_LEFTSHIFT, KEY_KP7, KEY_KP9, KEY_KP1, KEY_F11, KEY_KPPLUS, KEY_KPASTERISK,\t \n \tKEY_P, KEY_LEFTBRACE, KEY_BACKSPACE, 0, KEY_Q, 0, 0, 0,\t\t\t\t\t \n\t\tKEY_W, KEY_E, KEY_R, KEY_O, KEY_I, KEY_U, KEY_T, KEY_Y,\t\t\t\t\t \n \tKEY_0, KEY_MINUS, KEY_EQUAL, 0, KEY_1, 0, 0, 0,\t\t\t\t\t\t \n\t\tKEY_2, KEY_3, KEY_4, KEY_9, KEY_8, KEY_7, KEY_5, KEY_6,\t\t\t\t\t \n \t0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n\t\t0, 0, 0, 0, 0\n};\n\n#define JORNADA_SCAN_SIZE\t18\n\nstruct jornadakbd {\n\tstruct input_dev *input;\n\tunsigned short keymap[ARRAY_SIZE(jornada_scancodes)];\n\tunsigned char length;\n\tunsigned char old_scan[JORNADA_SCAN_SIZE];\n\tunsigned char new_scan[JORNADA_SCAN_SIZE];\n};\n\nstatic void jornada_parse_kbd(struct jornadakbd *jornadakbd)\n{\n\tstruct input_dev *input_dev = jornadakbd->input;\n\tunsigned short *keymap = jornadakbd->keymap;\n\tunsigned int sync_me = 0;\n\tunsigned int i, j;\n\n\tfor (i = 0; i < JORNADA_SCAN_SIZE; i++) {\n\t\tunsigned char new = jornadakbd->new_scan[i];\n\t\tunsigned char old = jornadakbd->old_scan[i];\n\t\tunsigned int xor = new ^ old;\n\n\t\tif (xor == 0)\n\t\t\tcontinue;\n\n\t\tfor (j = 0; j < 8; j++) {\n\t\t\tunsigned int bit = 1 << j;\n\t\t\tif (xor & bit) {\n\t\t\t\tunsigned int scancode = (i << 3) + j;\n\t\t\t\tinput_event(input_dev,\n\t\t\t\t\t    EV_MSC, MSC_SCAN, scancode);\n\t\t\t\tinput_report_key(input_dev,\n\t\t\t\t\t\t keymap[scancode],\n\t\t\t\t\t\t !(new & bit));\n\t\t\t\tsync_me = 1;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (sync_me)\n\t    input_sync(input_dev);\n}\n\nstatic void jornada_scan_keyb(unsigned char *s)\n{\n\tint i;\n\tunsigned short ec_static, dc_static;  \n\tunsigned char matrix_switch[] = {\n\t\t0xfd, 0xff,    \n\t\t0xdf, 0xff,    \n\t\t0x7f, 0xff,    \n\t\t0xff, 0xfe,    \n\t\t0xff, 0xfd,    \n\t\t0xff, 0xf7,    \n\t\t0xff, 0xbf,    \n\t\t0xff, 0x7f,    \n\t}, *t = matrix_switch;\n\t \n\t \n\tunsigned short matrix_PDE[] = {\n\t\t0xcc04, 0xf0cf,   \n\t\t0xc40c, 0xf0cf,\t  \n\t\t0x4c0c, 0xf0cf,   \n\t\t0xcc0c, 0xf0cd,   \n\t\t0xcc0c, 0xf0c7,\t  \n\t\t0xcc0c, 0xf04f,   \n\t\t0xcc0c, 0xd0cf,\t  \n\t\t0xcc0c, 0x70cf,\t  \n\t}, *y = matrix_PDE;\n\n\t \n\tdc_static = (__raw_readw(PDCR) & (~0xcc0c));\n\tec_static = (__raw_readw(PECR) & (~0xf0cf));\n\n\tfor (i = 0; i < 8; i++) {\n\t\t \n\t\t__raw_writew((dc_static | *y++), PDCR);\n\t\t__raw_writew((ec_static | *y++), PECR);\n\t\tudelay(5);\n\n\t\t \n\t\t__raw_writeb(*t++, PDDR);\n\t\t__raw_writeb(*t++, PEDR);\n\t\tudelay(50);\n\n\t\t \n\t\t*s++ = __raw_readb(PCDR);\n\t\t*s++ = __raw_readb(PFDR);\n\t}\n\t \n\t__raw_writeb(0xff, PDDR);\n\t__raw_writeb(0xff, PEDR);\n\n\t \n\t__raw_writew((dc_static | (0x5555 & 0xcc0c)),PDCR);\n\t__raw_writew((ec_static | (0x5555 & 0xf0cf)),PECR);\n\n\t \n\t*s++ = __raw_readb(PGDR);\n\t*s++ = __raw_readb(PHDR);\n}\n\nstatic void jornadakbd680_poll(struct input_dev *input)\n{\n\tstruct jornadakbd *jornadakbd = input_get_drvdata(input);\n\n\tjornada_scan_keyb(jornadakbd->new_scan);\n\tjornada_parse_kbd(jornadakbd);\n\tmemcpy(jornadakbd->old_scan, jornadakbd->new_scan, JORNADA_SCAN_SIZE);\n}\n\nstatic int jornada680kbd_probe(struct platform_device *pdev)\n{\n\tstruct jornadakbd *jornadakbd;\n\tstruct input_dev *input_dev;\n\tint i, error;\n\n\tjornadakbd = devm_kzalloc(&pdev->dev, sizeof(struct jornadakbd),\n\t\t\t\t  GFP_KERNEL);\n\tif (!jornadakbd)\n\t\treturn -ENOMEM;\n\n\tinput_dev = devm_input_allocate_device(&pdev->dev);\n\tif (!input_dev) {\n\t\tdev_err(&pdev->dev, \"failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tjornadakbd->input = input_dev;\n\n\tmemcpy(jornadakbd->keymap, jornada_scancodes,\n\t\tsizeof(jornadakbd->keymap));\n\n\tinput_set_drvdata(input_dev, jornadakbd);\n\tinput_dev->evbit[0] = BIT(EV_KEY) | BIT(EV_REP);\n\tinput_dev->name = \"HP Jornada 680 keyboard\";\n\tinput_dev->phys = \"jornadakbd/input0\";\n\tinput_dev->keycode = jornadakbd->keymap;\n\tinput_dev->keycodesize = sizeof(unsigned short);\n\tinput_dev->keycodemax = ARRAY_SIZE(jornada_scancodes);\n\tinput_dev->id.bustype = BUS_HOST;\n\n\tfor (i = 0; i < 128; i++)\n\t\tif (jornadakbd->keymap[i])\n\t\t\t__set_bit(jornadakbd->keymap[i], input_dev->keybit);\n\t__clear_bit(KEY_RESERVED, input_dev->keybit);\n\n\tinput_set_capability(input_dev, EV_MSC, MSC_SCAN);\n\n\terror = input_setup_polling(input_dev, jornadakbd680_poll);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"failed to set up polling\\n\");\n\t\treturn error;\n\t}\n\n\tinput_set_poll_interval(input_dev, 50  );\n\n\terror = input_register_device(input_dev);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"failed to register input device\\n\");\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver jornada680kbd_driver = {\n\t.driver\t= {\n\t\t.name\t= \"jornada680_kbd\",\n\t},\n\t.probe\t= jornada680kbd_probe,\n};\nmodule_platform_driver(jornada680kbd_driver);\n\nMODULE_AUTHOR(\"Kristoffer Ericson <kristoffer.ericson@gmail.com>\");\nMODULE_DESCRIPTION(\"HP Jornada 620/660/680/690 Keyboard Driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:jornada680_kbd\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}