{
  "module_name": "tc3589x-keypad.c",
  "hash_id": "39b5bb3ac1c0e77e72ccdefd0db21d00f67f1c536ad12995c7e9e241692fe824",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/tc3589x-keypad.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/input.h>\n#include <linux/platform_device.h>\n#include <linux/input/matrix_keypad.h>\n#include <linux/i2c.h>\n#include <linux/slab.h>\n#include <linux/mfd/tc3589x.h>\n#include <linux/device.h>\n\n \n#define TC3589x_MAX_KPROW               8\n#define TC3589x_MAX_KPCOL               12\n\n \n#define TC3589x_MAX_DEBOUNCE_SETTLE     0xFF\n#define DEDICATED_KEY_VAL\t\t0xFF\n\n \n#define TC3589x_NO_PULL_MASK\t\t0x0\n#define TC3589x_PULL_DOWN_MASK\t\t0x1\n#define TC3589x_PULL_UP_MASK\t\t0x2\n#define TC3589x_PULLUP_ALL_MASK\t\t0xAA\n#define TC3589x_IO_PULL_VAL(index, mask)\t((mask)<<((index)%4)*2)\n\n \n#define IOCFG_BALLCFG\t\t0x01\n#define IOCFG_IG\t\t0x08\n\n#define KP_EVCODE_COL_MASK\t0x0F\n#define KP_EVCODE_ROW_MASK\t0x70\n#define KP_RELEASE_EVT_MASK\t0x80\n\n#define KP_ROW_SHIFT\t\t4\n\n#define KP_NO_VALID_KEY_MASK\t0x7F\n\n \n#define TC3589x_KBDRST\t\t0x2\n#define TC3589x_IRQRST\t\t0x10\n#define TC3589x_RESET_ALL\t0x1B\n\n \n#define TC3589x_KBDMFS_EN\t0x1\n\n \n#define KPD_CLK_EN\t\t0x1\n\n \n#define IRQ_CLEAR\t\t0x1\n\n \n#define TC3589x_EVT_LOSS_INT\t0x8\n#define TC3589x_EVT_INT\t\t0x4\n#define TC3589x_KBD_LOSS_INT\t0x2\n#define TC3589x_KBD_INT\t\t0x1\n\n \n#define TC3589x_EVT_INT_CLR\t0x2\n#define TC3589x_KBD_INT_CLR\t0x1\n\n \nstruct tc3589x_keypad_platform_data {\n\tconst struct matrix_keymap_data *keymap_data;\n\tu8                      krow;\n\tu8                      kcol;\n\tu8                      debounce_period;\n\tu8                      settle_time;\n\tunsigned long           irqtype;\n\tbool                    enable_wakeup;\n\tbool                    no_autorepeat;\n};\n\n \nstruct tc_keypad {\n\tstruct tc3589x *tc3589x;\n\tstruct input_dev *input;\n\tconst struct tc3589x_keypad_platform_data *board;\n\tunsigned int krow;\n\tunsigned int kcol;\n\tunsigned short *keymap;\n\tbool keypad_stopped;\n};\n\nstatic int tc3589x_keypad_init_key_hardware(struct tc_keypad *keypad)\n{\n\tint ret;\n\tstruct tc3589x *tc3589x = keypad->tc3589x;\n\tconst struct tc3589x_keypad_platform_data *board = keypad->board;\n\n\t \n\tif (board->kcol > TC3589x_MAX_KPCOL || board->krow > TC3589x_MAX_KPROW)\n\t\treturn -EINVAL;\n\n\t \n\tret = tc3589x_reg_write(tc3589x, TC3589x_KBDSIZE,\n\t\t\t(board->krow << KP_ROW_SHIFT) | board->kcol);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_reg_write(tc3589x, TC3589x_KBCFG_LSB, DEDICATED_KEY_VAL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = tc3589x_reg_write(tc3589x, TC3589x_KBCFG_MSB, DEDICATED_KEY_VAL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_reg_write(tc3589x, TC3589x_KBDSETTLE_REG,\n\t\t\t\tboard->settle_time);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_reg_write(tc3589x, TC3589x_KBDBOUNCE,\n\t\t\t\tboard->debounce_period);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_IOCFG, 0x0, IOCFG_IG);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_reg_write(tc3589x, TC3589x_IOPULLCFG0_LSB,\n\t\t\t\t\tTC3589x_PULLUP_ALL_MASK);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = tc3589x_reg_write(tc3589x, TC3589x_IOPULLCFG0_MSB,\n\t\t\t\t\tTC3589x_PULLUP_ALL_MASK);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_reg_write(tc3589x, TC3589x_IOPULLCFG1_LSB,\n\t\t\tTC3589x_PULLUP_ALL_MASK);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = tc3589x_reg_write(tc3589x, TC3589x_IOPULLCFG1_MSB,\n\t\t\tTC3589x_PULLUP_ALL_MASK);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = tc3589x_reg_write(tc3589x, TC3589x_IOPULLCFG2_LSB,\n\t\t\tTC3589x_PULLUP_ALL_MASK);\n\n\treturn ret;\n}\n\n#define TC35893_DATA_REGS\t\t4\n#define TC35893_KEYCODE_FIFO_EMPTY\t0x7f\n#define TC35893_KEYCODE_FIFO_CLEAR\t0xff\n#define TC35893_KEYPAD_ROW_SHIFT\t0x3\n\nstatic irqreturn_t tc3589x_keypad_irq(int irq, void *dev)\n{\n\tstruct tc_keypad *keypad = dev;\n\tstruct tc3589x *tc3589x = keypad->tc3589x;\n\tu8 i, row_index, col_index, kbd_code, up;\n\tu8 code;\n\n\tfor (i = 0; i < TC35893_DATA_REGS * 2; i++) {\n\t\tkbd_code = tc3589x_reg_read(tc3589x, TC3589x_EVTCODE_FIFO);\n\n\t\t \n\t\tif (kbd_code == TC35893_KEYCODE_FIFO_EMPTY ||\n\t\t\t\tkbd_code == TC35893_KEYCODE_FIFO_CLEAR)\n\t\t\tcontinue;\n\n\t\t \n\t\tcol_index = kbd_code & KP_EVCODE_COL_MASK;\n\t\trow_index = (kbd_code & KP_EVCODE_ROW_MASK) >> KP_ROW_SHIFT;\n\t\tcode = MATRIX_SCAN_CODE(row_index, col_index,\n\t\t\t\t\t\tTC35893_KEYPAD_ROW_SHIFT);\n\t\tup = kbd_code & KP_RELEASE_EVT_MASK;\n\n\t\tinput_event(keypad->input, EV_MSC, MSC_SCAN, code);\n\t\tinput_report_key(keypad->input, keypad->keymap[code], !up);\n\t\tinput_sync(keypad->input);\n\t}\n\n\t \n\ttc3589x_set_bits(tc3589x, TC3589x_KBDIC,\n\t\t\t0x0, TC3589x_EVT_INT_CLR | TC3589x_KBD_INT_CLR);\n\t \n\ttc3589x_set_bits(tc3589x, TC3589x_KBDMSK,\n\t\t\t0x0, TC3589x_EVT_LOSS_INT | TC3589x_EVT_INT);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int tc3589x_keypad_enable(struct tc_keypad *keypad)\n{\n\tstruct tc3589x *tc3589x = keypad->tc3589x;\n\tint ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_RSTCTRL, TC3589x_KBDRST, 0x0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_KBDMFS, 0x0, TC3589x_KBDMFS_EN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_CLKEN, 0x0, KPD_CLK_EN);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret =  tc3589x_set_bits(tc3589x, TC3589x_RSTINTCLR, 0x0, 0x1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_KBDMSK, 0x0,\n\t\t\t\t\tTC3589x_EVT_LOSS_INT | TC3589x_EVT_INT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tkeypad->keypad_stopped = false;\n\n\treturn ret;\n}\n\nstatic int tc3589x_keypad_disable(struct tc_keypad *keypad)\n{\n\tstruct tc3589x *tc3589x = keypad->tc3589x;\n\tint ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_KBDIC,\n\t\t\t0x0, TC3589x_EVT_INT_CLR | TC3589x_KBD_INT_CLR);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_KBDMSK,\n\t\t\t~(TC3589x_EVT_LOSS_INT | TC3589x_EVT_INT), 0x0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_CLKEN, 0x1, 0x0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = tc3589x_set_bits(tc3589x, TC3589x_RSTCTRL, TC3589x_KBDRST, 0x1);\n\n\tkeypad->keypad_stopped = true;\n\n\treturn ret;\n}\n\nstatic int tc3589x_keypad_open(struct input_dev *input)\n{\n\tint error;\n\tstruct tc_keypad *keypad = input_get_drvdata(input);\n\n\t \n\terror = tc3589x_keypad_enable(keypad);\n\tif (error < 0) {\n\t\tdev_err(&input->dev, \"failed to enable keypad module\\n\");\n\t\treturn error;\n\t}\n\n\terror = tc3589x_keypad_init_key_hardware(keypad);\n\tif (error < 0) {\n\t\tdev_err(&input->dev, \"failed to configure keypad module\\n\");\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic void tc3589x_keypad_close(struct input_dev *input)\n{\n\tstruct tc_keypad *keypad = input_get_drvdata(input);\n\n\t \n\ttc3589x_keypad_disable(keypad);\n}\n\nstatic const struct tc3589x_keypad_platform_data *\ntc3589x_keypad_of_probe(struct device *dev)\n{\n\tstruct device_node *np = dev->of_node;\n\tstruct tc3589x_keypad_platform_data *plat;\n\tu32 cols, rows;\n\tu32 debounce_ms;\n\tint proplen;\n\n\tif (!np)\n\t\treturn ERR_PTR(-ENODEV);\n\n\tplat = devm_kzalloc(dev, sizeof(*plat), GFP_KERNEL);\n\tif (!plat)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tof_property_read_u32(np, \"keypad,num-columns\", &cols);\n\tof_property_read_u32(np, \"keypad,num-rows\", &rows);\n\tplat->kcol = (u8) cols;\n\tplat->krow = (u8) rows;\n\tif (!plat->krow || !plat->kcol ||\n\t     plat->krow > TC_KPD_ROWS || plat->kcol > TC_KPD_COLUMNS) {\n\t\tdev_err(dev,\n\t\t\t\"keypad columns/rows not properly specified (%ux%u)\\n\",\n\t\t\tplat->kcol, plat->krow);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tif (!of_get_property(np, \"linux,keymap\", &proplen)) {\n\t\tdev_err(dev, \"property linux,keymap not found\\n\");\n\t\treturn ERR_PTR(-ENOENT);\n\t}\n\n\tplat->no_autorepeat = of_property_read_bool(np, \"linux,no-autorepeat\");\n\n\tplat->enable_wakeup = of_property_read_bool(np, \"wakeup-source\") ||\n\t\t\t       \n\t\t\t      of_property_read_bool(np, \"linux,wakeup\");\n\n\t \n\tof_property_read_u32(np, \"debounce-delay-ms\", &debounce_ms);\n\tif (debounce_ms)\n\t\tplat->debounce_period = debounce_ms * 16;\n\telse\n\t\tplat->debounce_period = TC_KPD_DEBOUNCE_PERIOD;\n\n\tplat->settle_time = TC_KPD_SETTLE_TIME;\n\t \n\tplat->irqtype = IRQF_TRIGGER_FALLING;\n\n\treturn plat;\n}\n\nstatic int tc3589x_keypad_probe(struct platform_device *pdev)\n{\n\tstruct tc3589x *tc3589x = dev_get_drvdata(pdev->dev.parent);\n\tstruct tc_keypad *keypad;\n\tstruct input_dev *input;\n\tconst struct tc3589x_keypad_platform_data *plat;\n\tint error, irq;\n\n\tplat = tc3589x_keypad_of_probe(&pdev->dev);\n\tif (IS_ERR(plat)) {\n\t\tdev_err(&pdev->dev, \"invalid keypad platform data\\n\");\n\t\treturn PTR_ERR(plat);\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tkeypad = devm_kzalloc(&pdev->dev, sizeof(struct tc_keypad),\n\t\t\t      GFP_KERNEL);\n\tif (!keypad)\n\t\treturn -ENOMEM;\n\n\tinput = devm_input_allocate_device(&pdev->dev);\n\tif (!input) {\n\t\tdev_err(&pdev->dev, \"failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tkeypad->board = plat;\n\tkeypad->input = input;\n\tkeypad->tc3589x = tc3589x;\n\n\tinput->id.bustype = BUS_I2C;\n\tinput->name = pdev->name;\n\tinput->dev.parent = &pdev->dev;\n\n\tinput->open = tc3589x_keypad_open;\n\tinput->close = tc3589x_keypad_close;\n\n\terror = matrix_keypad_build_keymap(plat->keymap_data, NULL,\n\t\t\t\t\t   TC3589x_MAX_KPROW, TC3589x_MAX_KPCOL,\n\t\t\t\t\t   NULL, input);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"Failed to build keymap\\n\");\n\t\treturn error;\n\t}\n\n\tkeypad->keymap = input->keycode;\n\n\tinput_set_capability(input, EV_MSC, MSC_SCAN);\n\tif (!plat->no_autorepeat)\n\t\t__set_bit(EV_REP, input->evbit);\n\n\tinput_set_drvdata(input, keypad);\n\n\ttc3589x_keypad_disable(keypad);\n\n\terror = devm_request_threaded_irq(&pdev->dev, irq,\n\t\t\t\t\t  NULL, tc3589x_keypad_irq,\n\t\t\t\t\t  plat->irqtype | IRQF_ONESHOT,\n\t\t\t\t\t  \"tc3589x-keypad\", keypad);\n\tif (error) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Could not allocate irq %d,error %d\\n\",\n\t\t\t\tirq, error);\n\t\treturn error;\n\t}\n\n\terror = input_register_device(input);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"Could not register input device\\n\");\n\t\treturn error;\n\t}\n\n\t \n\tdevice_init_wakeup(&pdev->dev, plat->enable_wakeup);\n\tdevice_set_wakeup_capable(&pdev->dev, plat->enable_wakeup);\n\n\tplatform_set_drvdata(pdev, keypad);\n\n\treturn 0;\n}\n\nstatic int tc3589x_keypad_suspend(struct device *dev)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\tstruct tc_keypad *keypad = platform_get_drvdata(pdev);\n\tint irq = platform_get_irq(pdev, 0);\n\n\t \n\tif (keypad->keypad_stopped)\n\t\treturn 0;\n\n\t \n\tif (!device_may_wakeup(&pdev->dev))\n\t\ttc3589x_keypad_disable(keypad);\n\telse\n\t\tenable_irq_wake(irq);\n\n\treturn 0;\n}\n\nstatic int tc3589x_keypad_resume(struct device *dev)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\tstruct tc_keypad *keypad = platform_get_drvdata(pdev);\n\tint irq = platform_get_irq(pdev, 0);\n\n\tif (!keypad->keypad_stopped)\n\t\treturn 0;\n\n\t \n\tif (!device_may_wakeup(&pdev->dev))\n\t\ttc3589x_keypad_enable(keypad);\n\telse\n\t\tdisable_irq_wake(irq);\n\n\treturn 0;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(tc3589x_keypad_dev_pm_ops,\n\t\t\t\ttc3589x_keypad_suspend, tc3589x_keypad_resume);\n\nstatic struct platform_driver tc3589x_keypad_driver = {\n\t.driver\t= {\n\t\t.name\t= \"tc3589x-keypad\",\n\t\t.pm\t= pm_sleep_ptr(&tc3589x_keypad_dev_pm_ops),\n\t},\n\t.probe\t= tc3589x_keypad_probe,\n};\nmodule_platform_driver(tc3589x_keypad_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Jayeeta Banerjee/Sundar Iyer\");\nMODULE_DESCRIPTION(\"TC35893 Keypad Driver\");\nMODULE_ALIAS(\"platform:tc3589x-keypad\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}