{
  "module_name": "amikbd.c",
  "hash_id": "384879b8b80c5d8e96ff2cc5ba51d7a03cdcbd2a39151677445c07aa60fd7f12",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/amikbd.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/keyboard.h>\n#include <linux/platform_device.h>\n\n#include <asm/amigaints.h>\n#include <asm/amigahw.h>\n#include <asm/irq.h>\n\nMODULE_AUTHOR(\"Vojtech Pavlik <vojtech@ucw.cz>\");\nMODULE_DESCRIPTION(\"Amiga keyboard driver\");\nMODULE_LICENSE(\"GPL\");\n\n#ifdef CONFIG_HW_CONSOLE\nstatic unsigned char amikbd_keycode[0x78] __initdata = {\n\t[0]\t = KEY_GRAVE,\n\t[1]\t = KEY_1,\n\t[2]\t = KEY_2,\n\t[3]\t = KEY_3,\n\t[4]\t = KEY_4,\n\t[5]\t = KEY_5,\n\t[6]\t = KEY_6,\n\t[7]\t = KEY_7,\n\t[8]\t = KEY_8,\n\t[9]\t = KEY_9,\n\t[10]\t = KEY_0,\n\t[11]\t = KEY_MINUS,\n\t[12]\t = KEY_EQUAL,\n\t[13]\t = KEY_BACKSLASH,\n\t[15]\t = KEY_KP0,\n\t[16]\t = KEY_Q,\n\t[17]\t = KEY_W,\n\t[18]\t = KEY_E,\n\t[19]\t = KEY_R,\n\t[20]\t = KEY_T,\n\t[21]\t = KEY_Y,\n\t[22]\t = KEY_U,\n\t[23]\t = KEY_I,\n\t[24]\t = KEY_O,\n\t[25]\t = KEY_P,\n\t[26]\t = KEY_LEFTBRACE,\n\t[27]\t = KEY_RIGHTBRACE,\n\t[29]\t = KEY_KP1,\n\t[30]\t = KEY_KP2,\n\t[31]\t = KEY_KP3,\n\t[32]\t = KEY_A,\n\t[33]\t = KEY_S,\n\t[34]\t = KEY_D,\n\t[35]\t = KEY_F,\n\t[36]\t = KEY_G,\n\t[37]\t = KEY_H,\n\t[38]\t = KEY_J,\n\t[39]\t = KEY_K,\n\t[40]\t = KEY_L,\n\t[41]\t = KEY_SEMICOLON,\n\t[42]\t = KEY_APOSTROPHE,\n\t[43]\t = KEY_BACKSLASH,\n\t[45]\t = KEY_KP4,\n\t[46]\t = KEY_KP5,\n\t[47]\t = KEY_KP6,\n\t[48]\t = KEY_102ND,\n\t[49]\t = KEY_Z,\n\t[50]\t = KEY_X,\n\t[51]\t = KEY_C,\n\t[52]\t = KEY_V,\n\t[53]\t = KEY_B,\n\t[54]\t = KEY_N,\n\t[55]\t = KEY_M,\n\t[56]\t = KEY_COMMA,\n\t[57]\t = KEY_DOT,\n\t[58]\t = KEY_SLASH,\n\t[60]\t = KEY_KPDOT,\n\t[61]\t = KEY_KP7,\n\t[62]\t = KEY_KP8,\n\t[63]\t = KEY_KP9,\n\t[64]\t = KEY_SPACE,\n\t[65]\t = KEY_BACKSPACE,\n\t[66]\t = KEY_TAB,\n\t[67]\t = KEY_KPENTER,\n\t[68]\t = KEY_ENTER,\n\t[69]\t = KEY_ESC,\n\t[70]\t = KEY_DELETE,\n\t[74]\t = KEY_KPMINUS,\n\t[76]\t = KEY_UP,\n\t[77]\t = KEY_DOWN,\n\t[78]\t = KEY_RIGHT,\n\t[79]\t = KEY_LEFT,\n\t[80]\t = KEY_F1,\n\t[81]\t = KEY_F2,\n\t[82]\t = KEY_F3,\n\t[83]\t = KEY_F4,\n\t[84]\t = KEY_F5,\n\t[85]\t = KEY_F6,\n\t[86]\t = KEY_F7,\n\t[87]\t = KEY_F8,\n\t[88]\t = KEY_F9,\n\t[89]\t = KEY_F10,\n\t[90]\t = KEY_KPLEFTPAREN,\n\t[91]\t = KEY_KPRIGHTPAREN,\n\t[92]\t = KEY_KPSLASH,\n\t[93]\t = KEY_KPASTERISK,\n\t[94]\t = KEY_KPPLUS,\n\t[95]\t = KEY_HELP,\n\t[96]\t = KEY_LEFTSHIFT,\n\t[97]\t = KEY_RIGHTSHIFT,\n\t[98]\t = KEY_CAPSLOCK,\n\t[99]\t = KEY_LEFTCTRL,\n\t[100]\t = KEY_LEFTALT,\n\t[101]\t = KEY_RIGHTALT,\n\t[102]\t = KEY_LEFTMETA,\n\t[103]\t = KEY_RIGHTMETA\n};\n\nstatic void __init amikbd_init_console_keymaps(void)\n{\n\t \n\tunsigned short temp_map[NR_KEYS];\n\tint i, j;\n\n\tfor (i = 0; i < MAX_NR_KEYMAPS; i++) {\n\t\tif (!key_maps[i])\n\t\t\tcontinue;\n\t\tmemset(temp_map, 0, sizeof(temp_map));\n\t\tfor (j = 0; j < 0x78; j++) {\n\t\t\tif (!amikbd_keycode[j])\n\t\t\t\tcontinue;\n\t\t\ttemp_map[j] = key_maps[i][amikbd_keycode[j]];\n\t\t}\n\t\tfor (j = 0; j < NR_KEYS; j++) {\n\t\t\tif (!temp_map[j])\n\t\t\t\ttemp_map[j] = 0xf200;\n\t\t}\n\t\tmemcpy(key_maps[i], temp_map, sizeof(temp_map));\n\t}\n}\n#else  \nstatic inline void amikbd_init_console_keymaps(void) {}\n#endif  \n\nstatic const char *amikbd_messages[8] = {\n\t[0] = KERN_ALERT \"amikbd: Ctrl-Amiga-Amiga reset warning!!\\n\",\n\t[1] = KERN_WARNING \"amikbd: keyboard lost sync\\n\",\n\t[2] = KERN_WARNING \"amikbd: keyboard buffer overflow\\n\",\n\t[3] = KERN_WARNING \"amikbd: keyboard controller failure\\n\",\n\t[4] = KERN_ERR \"amikbd: keyboard selftest failure\\n\",\n\t[5] = KERN_INFO \"amikbd: initiate power-up key stream\\n\",\n\t[6] = KERN_INFO \"amikbd: terminate power-up key stream\\n\",\n\t[7] = KERN_WARNING \"amikbd: keyboard interrupt\\n\"\n};\n\nstatic irqreturn_t amikbd_interrupt(int irq, void *data)\n{\n\tstruct input_dev *dev = data;\n\tunsigned char scancode, down;\n\n\tscancode = ~ciaa.sdr;\t\t \n\tciaa.cra |= 0x40;\t\t \n\tudelay(85);\t\t\t \n\tciaa.cra &= ~0x40;\t\t \n\n\tdown = !(scancode & 1);\t\t \n\tscancode >>= 1;\n\n\tif (scancode < 0x78) {\t\t \n\t\tif (scancode == 98) {\t \n\t\t\tinput_report_key(dev, scancode, 1);\n\t\t\tinput_report_key(dev, scancode, 0);\n\t\t} else {\n\t\t\tinput_report_key(dev, scancode, down);\n\t\t}\n\n\t\tinput_sync(dev);\n\t} else\t\t\t\t \n\t\tprintk(amikbd_messages[scancode - 0x78]);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int __init amikbd_probe(struct platform_device *pdev)\n{\n\tstruct input_dev *dev;\n\tint i, err;\n\n\tdev = devm_input_allocate_device(&pdev->dev);\n\tif (!dev) {\n\t\tdev_err(&pdev->dev, \"Not enough memory for input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tdev->name = pdev->name;\n\tdev->phys = \"amikbd/input0\";\n\tdev->id.bustype = BUS_AMIGA;\n\tdev->id.vendor = 0x0001;\n\tdev->id.product = 0x0001;\n\tdev->id.version = 0x0100;\n\n\tdev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);\n\n\tfor (i = 0; i < 0x78; i++)\n\t\tset_bit(i, dev->keybit);\n\n\tamikbd_init_console_keymaps();\n\n\tciaa.cra &= ~0x41;\t  \n\terr = devm_request_irq(&pdev->dev, IRQ_AMIGA_CIAA_SP, amikbd_interrupt,\n\t\t\t       0, \"amikbd\", dev);\n\tif (err)\n\t\treturn err;\n\n\terr = input_register_device(dev);\n\tif (err)\n\t\treturn err;\n\n\tplatform_set_drvdata(pdev, dev);\n\n\treturn 0;\n}\n\nstatic struct platform_driver amikbd_driver = {\n\t.driver   = {\n\t\t.name\t= \"amiga-keyboard\",\n\t},\n};\n\nmodule_platform_driver_probe(amikbd_driver, amikbd_probe);\n\nMODULE_ALIAS(\"platform:amiga-keyboard\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}