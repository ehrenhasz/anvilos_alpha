{
  "module_name": "ipaq-micro-keys.c",
  "hash_id": "4900f982877a8dafc418c2cd0f86b8365ec6cc77be337c6f1767e43e345e05d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/ipaq-micro-keys.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/fs.h>\n#include <linux/interrupt.h>\n#include <linux/sched.h>\n#include <linux/pm.h>\n#include <linux/sysctl.h>\n#include <linux/proc_fs.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/input.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/ipaq-micro.h>\n\nstruct ipaq_micro_keys {\n\tstruct ipaq_micro *micro;\n\tstruct input_dev *input;\n\tu16 *codes;\n};\n\nstatic const u16 micro_keycodes[] = {\n\tKEY_RECORD,\t\t \n\tKEY_CALENDAR,\t\t \n\tKEY_ADDRESSBOOK,\t \n\tKEY_MAIL,\t\t \n\tKEY_HOMEPAGE,\t\t \n\tKEY_UP,\t\t\t \n\tKEY_RIGHT,\t\t \n\tKEY_LEFT,\t\t \n\tKEY_DOWN,\t\t \n};\n\nstatic void micro_key_receive(void *data, int len, unsigned char *msg)\n{\n\tstruct ipaq_micro_keys *keys = data;\n\tint key, down;\n\n\tdown = 0x80 & msg[0];\n\tkey  = 0x7f & msg[0];\n\n\tif (key < ARRAY_SIZE(micro_keycodes)) {\n\t\tinput_report_key(keys->input, keys->codes[key], down);\n\t\tinput_sync(keys->input);\n\t}\n}\n\nstatic void micro_key_start(struct ipaq_micro_keys *keys)\n{\n\tspin_lock(&keys->micro->lock);\n\tkeys->micro->key = micro_key_receive;\n\tkeys->micro->key_data = keys;\n\tspin_unlock(&keys->micro->lock);\n}\n\nstatic void micro_key_stop(struct ipaq_micro_keys *keys)\n{\n\tspin_lock(&keys->micro->lock);\n\tkeys->micro->key = NULL;\n\tkeys->micro->key_data = NULL;\n\tspin_unlock(&keys->micro->lock);\n}\n\nstatic int micro_key_open(struct input_dev *input)\n{\n\tstruct ipaq_micro_keys *keys = input_get_drvdata(input);\n\n\tmicro_key_start(keys);\n\n\treturn 0;\n}\n\nstatic void micro_key_close(struct input_dev *input)\n{\n\tstruct ipaq_micro_keys *keys = input_get_drvdata(input);\n\n\tmicro_key_stop(keys);\n}\n\nstatic int micro_key_probe(struct platform_device *pdev)\n{\n\tstruct ipaq_micro_keys *keys;\n\tint error;\n\tint i;\n\n\tkeys = devm_kzalloc(&pdev->dev, sizeof(*keys), GFP_KERNEL);\n\tif (!keys)\n\t\treturn -ENOMEM;\n\n\tkeys->micro = dev_get_drvdata(pdev->dev.parent);\n\n\tkeys->input = devm_input_allocate_device(&pdev->dev);\n\tif (!keys->input)\n\t\treturn -ENOMEM;\n\n\tkeys->input->keycodesize = sizeof(micro_keycodes[0]);\n\tkeys->input->keycodemax = ARRAY_SIZE(micro_keycodes);\n\tkeys->codes = devm_kmemdup(&pdev->dev, micro_keycodes,\n\t\t\t   keys->input->keycodesize * keys->input->keycodemax,\n\t\t\t   GFP_KERNEL);\n\tif (!keys->codes)\n\t\treturn -ENOMEM;\n\n\tkeys->input->keycode = keys->codes;\n\n\t__set_bit(EV_KEY, keys->input->evbit);\n\tfor (i = 0; i < ARRAY_SIZE(micro_keycodes); i++)\n\t\t__set_bit(micro_keycodes[i], keys->input->keybit);\n\n\tkeys->input->name = \"h3600 micro keys\";\n\tkeys->input->open = micro_key_open;\n\tkeys->input->close = micro_key_close;\n\tinput_set_drvdata(keys->input, keys);\n\n\terror = input_register_device(keys->input);\n\tif (error)\n\t\treturn error;\n\n\tplatform_set_drvdata(pdev, keys);\n\treturn 0;\n}\n\nstatic int micro_key_suspend(struct device *dev)\n{\n\tstruct ipaq_micro_keys *keys = dev_get_drvdata(dev);\n\n\tmicro_key_stop(keys);\n\n\treturn 0;\n}\n\nstatic int micro_key_resume(struct device *dev)\n{\n\tstruct ipaq_micro_keys *keys = dev_get_drvdata(dev);\n\tstruct input_dev *input = keys->input;\n\n\tmutex_lock(&input->mutex);\n\n\tif (input_device_enabled(input))\n\t\tmicro_key_start(keys);\n\n\tmutex_unlock(&input->mutex);\n\n\treturn 0;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(micro_key_dev_pm_ops,\n\t\t\t\tmicro_key_suspend, micro_key_resume);\n\nstatic struct platform_driver micro_key_device_driver = {\n\t.driver = {\n\t\t.name    = \"ipaq-micro-keys\",\n\t\t.pm\t= pm_sleep_ptr(&micro_key_dev_pm_ops),\n\t},\n\t.probe   = micro_key_probe,\n};\nmodule_platform_driver(micro_key_device_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"driver for iPAQ Atmel micro keys\");\nMODULE_ALIAS(\"platform:ipaq-micro-keys\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}