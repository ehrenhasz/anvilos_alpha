{
  "module_name": "opencores-kbd.c",
  "hash_id": "7984bb97440eea335b09d5b95569a5e00c2c0cd9bd7efbb552356aa57b4936bb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/keyboard/opencores-kbd.c",
  "human_readable_source": "\n \n\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\nstruct opencores_kbd {\n\tstruct input_dev *input;\n\tvoid __iomem *addr;\n\tint irq;\n\tunsigned short keycodes[128];\n};\n\nstatic irqreturn_t opencores_kbd_isr(int irq, void *dev_id)\n{\n\tstruct opencores_kbd *opencores_kbd = dev_id;\n\tstruct input_dev *input = opencores_kbd->input;\n\tunsigned char c;\n\n\tc = readb(opencores_kbd->addr);\n\tinput_report_key(input, c & 0x7f, c & 0x80 ? 0 : 1);\n\tinput_sync(input);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int opencores_kbd_probe(struct platform_device *pdev)\n{\n\tstruct input_dev *input;\n\tstruct opencores_kbd *opencores_kbd;\n\tint irq, i, error;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn -EINVAL;\n\n\topencores_kbd = devm_kzalloc(&pdev->dev, sizeof(*opencores_kbd),\n\t\t\t\t     GFP_KERNEL);\n\tif (!opencores_kbd)\n\t\treturn -ENOMEM;\n\n\tinput = devm_input_allocate_device(&pdev->dev);\n\tif (!input) {\n\t\tdev_err(&pdev->dev, \"failed to allocate input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\topencores_kbd->input = input;\n\n\topencores_kbd->addr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(opencores_kbd->addr))\n\t\treturn PTR_ERR(opencores_kbd->addr);\n\n\tinput->name = pdev->name;\n\tinput->phys = \"opencores-kbd/input0\";\n\n\tinput->id.bustype = BUS_HOST;\n\tinput->id.vendor = 0x0001;\n\tinput->id.product = 0x0001;\n\tinput->id.version = 0x0100;\n\n\tinput->keycode = opencores_kbd->keycodes;\n\tinput->keycodesize = sizeof(opencores_kbd->keycodes[0]);\n\tinput->keycodemax = ARRAY_SIZE(opencores_kbd->keycodes);\n\n\t__set_bit(EV_KEY, input->evbit);\n\n\tfor (i = 0; i < ARRAY_SIZE(opencores_kbd->keycodes); i++) {\n\t\t \n\t\topencores_kbd->keycodes[i] = i;\n\t\t__set_bit(opencores_kbd->keycodes[i], input->keybit);\n\t}\n\t__clear_bit(KEY_RESERVED, input->keybit);\n\n\terror = devm_request_irq(&pdev->dev, irq, &opencores_kbd_isr,\n\t\t\t\t IRQF_TRIGGER_RISING,\n\t\t\t\t pdev->name, opencores_kbd);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"unable to claim irq %d\\n\", irq);\n\t\treturn error;\n\t}\n\n\terror = input_register_device(input);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"unable to register input device\\n\");\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver opencores_kbd_device_driver = {\n\t.probe    = opencores_kbd_probe,\n\t.driver   = {\n\t\t.name = \"opencores-kbd\",\n\t},\n};\nmodule_platform_driver(opencores_kbd_device_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Javier Herrero <jherrero@hvsistemas.es>\");\nMODULE_DESCRIPTION(\"Keyboard driver for OpenCores Keyboard Controller\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}