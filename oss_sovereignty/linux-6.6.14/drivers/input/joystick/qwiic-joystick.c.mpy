{
  "module_name": "qwiic-joystick.c",
  "hash_id": "b5422ea112a3d91213f4c1b1cbb457577efc5d7793d55555300e788ea82d0976",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/joystick/qwiic-joystick.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n\n#define DRV_NAME \"qwiic-joystick\"\n\n#define QWIIC_JSK_REG_VERS\t1\n#define QWIIC_JSK_REG_DATA\t3\n\n#define QWIIC_JSK_MAX_AXIS\tGENMASK(9, 0)\n#define QWIIC_JSK_FUZZ\t\t2\n#define QWIIC_JSK_FLAT\t\t2\n#define QWIIC_JSK_POLL_INTERVAL\t16\n#define QWIIC_JSK_POLL_MIN\t8\n#define QWIIC_JSK_POLL_MAX\t32\n\nstruct qwiic_jsk {\n\tchar phys[32];\n\tstruct input_dev *dev;\n\tstruct i2c_client *client;\n};\n\nstruct qwiic_ver {\n\tu8 major;\n\tu8 minor;\n};\n\nstruct qwiic_data {\n\t__be16 x;\n\t__be16 y;\n\tu8 thumb;\n};\n\nstatic void qwiic_poll(struct input_dev *input)\n{\n\tstruct qwiic_jsk *priv = input_get_drvdata(input);\n\tstruct qwiic_data data;\n\tint err;\n\n\terr = i2c_smbus_read_i2c_block_data(priv->client, QWIIC_JSK_REG_DATA,\n\t\t\t\t\t    sizeof(data), (u8 *)&data);\n\tif (err != sizeof(data))\n\t\treturn;\n\n\tinput_report_abs(input, ABS_X, be16_to_cpu(data.x) >> 6);\n\tinput_report_abs(input, ABS_Y, be16_to_cpu(data.y) >> 6);\n\tinput_report_key(input, BTN_THUMBL, !data.thumb);\n\tinput_sync(input);\n}\n\nstatic int qwiic_probe(struct i2c_client *client)\n{\n\tstruct qwiic_jsk *priv;\n\tstruct qwiic_ver vers;\n\tint err;\n\n\terr = i2c_smbus_read_i2c_block_data(client, QWIIC_JSK_REG_VERS,\n\t\t\t\t\t    sizeof(vers), (u8 *)&vers);\n\tif (err < 0)\n\t\treturn err;\n\tif (err != sizeof(vers))\n\t\treturn -EIO;\n\n\tdev_dbg(&client->dev, \"SparkFun Qwiic Joystick, FW: %u.%u\\n\",\n\t\tvers.major, vers.minor);\n\n\tpriv = devm_kzalloc(&client->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->client = client;\n\tsnprintf(priv->phys, sizeof(priv->phys),\n\t\t \"i2c/%s\", dev_name(&client->dev));\n\ti2c_set_clientdata(client, priv);\n\n\tpriv->dev = devm_input_allocate_device(&client->dev);\n\tif (!priv->dev)\n\t\treturn -ENOMEM;\n\n\tpriv->dev->id.bustype = BUS_I2C;\n\tpriv->dev->name = \"SparkFun Qwiic Joystick\";\n\tpriv->dev->phys = priv->phys;\n\tinput_set_drvdata(priv->dev, priv);\n\n\tinput_set_abs_params(priv->dev, ABS_X, 0, QWIIC_JSK_MAX_AXIS,\n\t\t\t     QWIIC_JSK_FUZZ, QWIIC_JSK_FLAT);\n\tinput_set_abs_params(priv->dev, ABS_Y, 0, QWIIC_JSK_MAX_AXIS,\n\t\t\t     QWIIC_JSK_FUZZ, QWIIC_JSK_FLAT);\n\tinput_set_capability(priv->dev, EV_KEY, BTN_THUMBL);\n\n\terr = input_setup_polling(priv->dev, qwiic_poll);\n\tif (err) {\n\t\tdev_err(&client->dev, \"failed to set up polling: %d\\n\", err);\n\t\treturn err;\n\t}\n\tinput_set_poll_interval(priv->dev, QWIIC_JSK_POLL_INTERVAL);\n\tinput_set_min_poll_interval(priv->dev, QWIIC_JSK_POLL_MIN);\n\tinput_set_max_poll_interval(priv->dev, QWIIC_JSK_POLL_MAX);\n\n\terr = input_register_device(priv->dev);\n\tif (err) {\n\t\tdev_err(&client->dev, \"failed to register joystick: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id of_qwiic_match[] = {\n\t{ .compatible = \"sparkfun,qwiic-joystick\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, of_qwiic_match);\n#endif  \n\nstatic const struct i2c_device_id qwiic_id_table[] = {\n\t{ KBUILD_MODNAME, 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(i2c, qwiic_id_table);\n\nstatic struct i2c_driver qwiic_driver = {\n\t.driver = {\n\t\t.name\t\t= DRV_NAME,\n\t\t.of_match_table\t= of_match_ptr(of_qwiic_match),\n\t},\n\t.id_table\t= qwiic_id_table,\n\t.probe\t\t= qwiic_probe,\n};\nmodule_i2c_driver(qwiic_driver);\n\nMODULE_AUTHOR(\"Oleh Kravchenko <oleg@kaa.org.ua>\");\nMODULE_DESCRIPTION(\"SparkFun Qwiic Joystick driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}