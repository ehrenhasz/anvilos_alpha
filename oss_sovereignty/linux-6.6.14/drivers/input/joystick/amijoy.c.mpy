{
  "module_name": "amijoy.c",
  "hash_id": "930abbbb7eb6e2bda2c7de3d08d194cb6ef390ffd2912afef6c8e0a70998ebe5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/joystick/amijoy.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/mutex.h>\n\n#include <asm/amigahw.h>\n#include <asm/amigaints.h>\n\nMODULE_AUTHOR(\"Vojtech Pavlik <vojtech@ucw.cz>\");\nMODULE_DESCRIPTION(\"Driver for Amiga joysticks\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int amijoy[2] = { 0, 1 };\nmodule_param_array_named(map, amijoy, uint, NULL, 0);\nMODULE_PARM_DESC(map, \"Map of attached joysticks in form of <a>,<b> (default is 0,1)\");\n\nstatic int amijoy_used;\nstatic DEFINE_MUTEX(amijoy_mutex);\nstatic struct input_dev *amijoy_dev[2];\nstatic char *amijoy_phys[2] = { \"amijoy/input0\", \"amijoy/input1\" };\n\nstatic irqreturn_t amijoy_interrupt(int irq, void *dummy)\n{\n\tint i, data = 0, button = 0;\n\n\tfor (i = 0; i < 2; i++)\n\t\tif (amijoy[i]) {\n\n\t\t\tswitch (i) {\n\t\t\t\tcase 0: data = ~amiga_custom.joy0dat; button = (~ciaa.pra >> 6) & 1; break;\n\t\t\t\tcase 1: data = ~amiga_custom.joy1dat; button = (~ciaa.pra >> 7) & 1; break;\n\t\t\t}\n\n\t\t\tinput_report_key(amijoy_dev[i], BTN_TRIGGER, button);\n\n\t\t\tinput_report_abs(amijoy_dev[i], ABS_X, ((data >> 1) & 1) - ((data >> 9) & 1));\n\t\t\tdata = ~(data ^ (data << 1));\n\t\t\tinput_report_abs(amijoy_dev[i], ABS_Y, ((data >> 1) & 1) - ((data >> 9) & 1));\n\n\t\t\tinput_sync(amijoy_dev[i]);\n\t\t}\n\treturn IRQ_HANDLED;\n}\n\nstatic int amijoy_open(struct input_dev *dev)\n{\n\tint err;\n\n\terr = mutex_lock_interruptible(&amijoy_mutex);\n\tif (err)\n\t\treturn err;\n\n\tif (!amijoy_used && request_irq(IRQ_AMIGA_VERTB, amijoy_interrupt, 0, \"amijoy\", amijoy_interrupt)) {\n\t\tprintk(KERN_ERR \"amijoy.c: Can't allocate irq %d\\n\", IRQ_AMIGA_VERTB);\n\t\terr = -EBUSY;\n\t\tgoto out;\n\t}\n\n\tamijoy_used++;\nout:\n\tmutex_unlock(&amijoy_mutex);\n\treturn err;\n}\n\nstatic void amijoy_close(struct input_dev *dev)\n{\n\tmutex_lock(&amijoy_mutex);\n\tif (!--amijoy_used)\n\t\tfree_irq(IRQ_AMIGA_VERTB, amijoy_interrupt);\n\tmutex_unlock(&amijoy_mutex);\n}\n\nstatic int __init amijoy_init(void)\n{\n\tint i, j;\n\tint err;\n\n\tif (!MACH_IS_AMIGA)\n\t\treturn -ENODEV;\n\n\tfor (i = 0; i < 2; i++) {\n\t\tif (!amijoy[i])\n\t\t\tcontinue;\n\n\t\tamijoy_dev[i] = input_allocate_device();\n\t\tif (!amijoy_dev[i]) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto fail;\n\t\t}\n\n\t\tif (!request_mem_region(CUSTOM_PHYSADDR + 10 + i * 2, 2, \"amijoy [Denise]\")) {\n\t\t\tinput_free_device(amijoy_dev[i]);\n\t\t\terr = -EBUSY;\n\t\t\tgoto fail;\n\t\t}\n\n\t\tamijoy_dev[i]->name = \"Amiga joystick\";\n\t\tamijoy_dev[i]->phys = amijoy_phys[i];\n\t\tamijoy_dev[i]->id.bustype = BUS_AMIGA;\n\t\tamijoy_dev[i]->id.vendor = 0x0001;\n\t\tamijoy_dev[i]->id.product = 0x0003;\n\t\tamijoy_dev[i]->id.version = 0x0100;\n\n\t\tamijoy_dev[i]->open = amijoy_open;\n\t\tamijoy_dev[i]->close = amijoy_close;\n\n\t\tamijoy_dev[i]->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\n\t\tamijoy_dev[i]->absbit[0] = BIT_MASK(ABS_X) | BIT_MASK(ABS_Y);\n\t\tamijoy_dev[i]->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\n\t\t\tBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tinput_set_abs_params(amijoy_dev[i], ABS_X + j,\n\t\t\t\t\t     -1, 1, 0, 0);\n\t\t}\n\n\t\terr = input_register_device(amijoy_dev[i]);\n\t\tif (err) {\n\t\t\tinput_free_device(amijoy_dev[i]);\n\t\t\tgoto fail;\n\t\t}\n\t}\n\treturn 0;\n\n fail:\twhile (--i >= 0)\n\t\tif (amijoy[i]) {\n\t\t\tinput_unregister_device(amijoy_dev[i]);\n\t\t\trelease_mem_region(CUSTOM_PHYSADDR + 10 + i * 2, 2);\n\t\t}\n\treturn err;\n}\n\nstatic void __exit amijoy_exit(void)\n{\n\tint i;\n\n\tfor (i = 0; i < 2; i++)\n\t\tif (amijoy[i]) {\n\t\t\tinput_unregister_device(amijoy_dev[i]);\n\t\t\trelease_mem_region(CUSTOM_PHYSADDR + 10 + i * 2, 2);\n\t\t}\n}\n\nmodule_init(amijoy_init);\nmodule_exit(amijoy_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}