{
  "module_name": "magellan.c",
  "hash_id": "c7b63491ae707da15525ec308d51dca4d23cd089333cc2652ea8c11ae5bf786f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/joystick/magellan.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/serio.h>\n\n#define DRIVER_DESC\t\"Magellan and SpaceMouse 6dof controller driver\"\n\nMODULE_AUTHOR(\"Vojtech Pavlik <vojtech@ucw.cz>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\n\n \n\n#define\tMAGELLAN_MAX_LENGTH\t32\n\nstatic int magellan_buttons[] = { BTN_0, BTN_1, BTN_2, BTN_3, BTN_4, BTN_5, BTN_6, BTN_7, BTN_8 };\nstatic int magellan_axes[] = { ABS_X, ABS_Y, ABS_Z, ABS_RX, ABS_RY, ABS_RZ };\n\n \n\nstruct magellan {\n\tstruct input_dev *dev;\n\tint idx;\n\tunsigned char data[MAGELLAN_MAX_LENGTH];\n\tchar phys[32];\n};\n\n \n\nstatic int magellan_crunch_nibbles(unsigned char *data, int count)\n{\n\tstatic unsigned char nibbles[16] = \"0AB3D56GH9:K<MN?\";\n\n\tdo {\n\t\tif (data[count] == nibbles[data[count] & 0xf])\n\t\t\tdata[count] = data[count] & 0xf;\n\t\telse\n\t\t\treturn -1;\n\t} while (--count);\n\n\treturn 0;\n}\n\nstatic void magellan_process_packet(struct magellan* magellan)\n{\n\tstruct input_dev *dev = magellan->dev;\n\tunsigned char *data = magellan->data;\n\tint i, t;\n\n\tif (!magellan->idx) return;\n\n\tswitch (magellan->data[0]) {\n\n\t\tcase 'd':\t\t\t\t \n\t\t\tif (magellan->idx != 25) return;\n\t\t\tif (magellan_crunch_nibbles(data, 24)) return;\n\t\t\tfor (i = 0; i < 6; i++)\n\t\t\t\tinput_report_abs(dev, magellan_axes[i],\n\t\t\t\t\t(data[(i << 2) + 1] << 12 | data[(i << 2) + 2] << 8 |\n\t\t\t\t\t data[(i << 2) + 3] <<  4 | data[(i << 2) + 4]) - 32768);\n\t\t\tbreak;\n\n\t\tcase 'k':\t\t\t\t \n\t\t\tif (magellan->idx != 4) return;\n\t\t\tif (magellan_crunch_nibbles(data, 3)) return;\n\t\t\tt = (data[1] << 1) | (data[2] << 5) | data[3];\n\t\t\tfor (i = 0; i < 9; i++) input_report_key(dev, magellan_buttons[i], (t >> i) & 1);\n\t\t\tbreak;\n\t}\n\n\tinput_sync(dev);\n}\n\nstatic irqreturn_t magellan_interrupt(struct serio *serio,\n\t\tunsigned char data, unsigned int flags)\n{\n\tstruct magellan* magellan = serio_get_drvdata(serio);\n\n\tif (data == '\\r') {\n\t\tmagellan_process_packet(magellan);\n\t\tmagellan->idx = 0;\n\t} else {\n\t\tif (magellan->idx < MAGELLAN_MAX_LENGTH)\n\t\t\tmagellan->data[magellan->idx++] = data;\n\t}\n\treturn IRQ_HANDLED;\n}\n\n \n\nstatic void magellan_disconnect(struct serio *serio)\n{\n\tstruct magellan* magellan = serio_get_drvdata(serio);\n\n\tserio_close(serio);\n\tserio_set_drvdata(serio, NULL);\n\tinput_unregister_device(magellan->dev);\n\tkfree(magellan);\n}\n\n \n\nstatic int magellan_connect(struct serio *serio, struct serio_driver *drv)\n{\n\tstruct magellan *magellan;\n\tstruct input_dev *input_dev;\n\tint err = -ENOMEM;\n\tint i;\n\n\tmagellan = kzalloc(sizeof(struct magellan), GFP_KERNEL);\n\tinput_dev = input_allocate_device();\n\tif (!magellan || !input_dev)\n\t\tgoto fail1;\n\n\tmagellan->dev = input_dev;\n\tsnprintf(magellan->phys, sizeof(magellan->phys), \"%s/input0\", serio->phys);\n\n\tinput_dev->name = \"LogiCad3D Magellan / SpaceMouse\";\n\tinput_dev->phys = magellan->phys;\n\tinput_dev->id.bustype = BUS_RS232;\n\tinput_dev->id.vendor = SERIO_MAGELLAN;\n\tinput_dev->id.product = 0x0001;\n\tinput_dev->id.version = 0x0100;\n\tinput_dev->dev.parent = &serio->dev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\n\n\tfor (i = 0; i < 9; i++)\n\t\tset_bit(magellan_buttons[i], input_dev->keybit);\n\n\tfor (i = 0; i < 6; i++)\n\t\tinput_set_abs_params(input_dev, magellan_axes[i], -360, 360, 0, 0);\n\n\tserio_set_drvdata(serio, magellan);\n\n\terr = serio_open(serio, drv);\n\tif (err)\n\t\tgoto fail2;\n\n\terr = input_register_device(magellan->dev);\n\tif (err)\n\t\tgoto fail3;\n\n\treturn 0;\n\n fail3:\tserio_close(serio);\n fail2:\tserio_set_drvdata(serio, NULL);\n fail1:\tinput_free_device(input_dev);\n\tkfree(magellan);\n\treturn err;\n}\n\n \n\nstatic const struct serio_device_id magellan_serio_ids[] = {\n\t{\n\t\t.type\t= SERIO_RS232,\n\t\t.proto\t= SERIO_MAGELLAN,\n\t\t.id\t= SERIO_ANY,\n\t\t.extra\t= SERIO_ANY,\n\t},\n\t{ 0 }\n};\n\nMODULE_DEVICE_TABLE(serio, magellan_serio_ids);\n\nstatic struct serio_driver magellan_drv = {\n\t.driver\t\t= {\n\t\t.name\t= \"magellan\",\n\t},\n\t.description\t= DRIVER_DESC,\n\t.id_table\t= magellan_serio_ids,\n\t.interrupt\t= magellan_interrupt,\n\t.connect\t= magellan_connect,\n\t.disconnect\t= magellan_disconnect,\n};\n\nmodule_serio_driver(magellan_drv);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}