{
  "module_name": "stinger.c",
  "hash_id": "f3b536a6f29f5360218ad4b1b7b688de7b637234193ae6d738020a576143fd4a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/joystick/stinger.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/serio.h>\n\n#define DRIVER_DESC\t\"Gravis Stinger gamepad driver\"\n\nMODULE_AUTHOR(\"Vojtech Pavlik <vojtech@ucw.cz>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\n\n \n\n#define STINGER_MAX_LENGTH 8\n\n \n\nstruct stinger {\n\tstruct input_dev *dev;\n\tint idx;\n\tunsigned char data[STINGER_MAX_LENGTH];\n\tchar phys[32];\n};\n\n \n\nstatic void stinger_process_packet(struct stinger *stinger)\n{\n\tstruct input_dev *dev = stinger->dev;\n\tunsigned char *data = stinger->data;\n\n\tif (!stinger->idx) return;\n\n\tinput_report_key(dev, BTN_A,\t  ((data[0] & 0x20) >> 5));\n\tinput_report_key(dev, BTN_B,\t  ((data[0] & 0x10) >> 4));\n\tinput_report_key(dev, BTN_C,\t  ((data[0] & 0x08) >> 3));\n\tinput_report_key(dev, BTN_X,\t  ((data[0] & 0x04) >> 2));\n\tinput_report_key(dev, BTN_Y,\t  ((data[3] & 0x20) >> 5));\n\tinput_report_key(dev, BTN_Z,\t  ((data[3] & 0x10) >> 4));\n\tinput_report_key(dev, BTN_TL,     ((data[3] & 0x08) >> 3));\n\tinput_report_key(dev, BTN_TR,     ((data[3] & 0x04) >> 2));\n\tinput_report_key(dev, BTN_SELECT, ((data[3] & 0x02) >> 1));\n\tinput_report_key(dev, BTN_START,   (data[3] & 0x01));\n\n\tinput_report_abs(dev, ABS_X, (data[1] & 0x3F) - ((data[0] & 0x01) << 6));\n\tinput_report_abs(dev, ABS_Y, ((data[0] & 0x02) << 5) - (data[2] & 0x3F));\n\n\tinput_sync(dev);\n\n\treturn;\n}\n\n \n\nstatic irqreturn_t stinger_interrupt(struct serio *serio,\n\tunsigned char data, unsigned int flags)\n{\n\tstruct stinger *stinger = serio_get_drvdata(serio);\n\n\t \n\n\tif (stinger->idx < STINGER_MAX_LENGTH)\n\t\tstinger->data[stinger->idx++] = data;\n\n\tif (stinger->idx == 4) {\n\t\tstinger_process_packet(stinger);\n\t\tstinger->idx = 0;\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\n \n\nstatic void stinger_disconnect(struct serio *serio)\n{\n\tstruct stinger *stinger = serio_get_drvdata(serio);\n\n\tserio_close(serio);\n\tserio_set_drvdata(serio, NULL);\n\tinput_unregister_device(stinger->dev);\n\tkfree(stinger);\n}\n\n \n\nstatic int stinger_connect(struct serio *serio, struct serio_driver *drv)\n{\n\tstruct stinger *stinger;\n\tstruct input_dev *input_dev;\n\tint err = -ENOMEM;\n\n\tstinger = kmalloc(sizeof(struct stinger), GFP_KERNEL);\n\tinput_dev = input_allocate_device();\n\tif (!stinger || !input_dev)\n\t\tgoto fail1;\n\n\tstinger->dev = input_dev;\n\tsnprintf(stinger->phys, sizeof(stinger->phys), \"%s/serio0\", serio->phys);\n\n\tinput_dev->name = \"Gravis Stinger\";\n\tinput_dev->phys = stinger->phys;\n\tinput_dev->id.bustype = BUS_RS232;\n\tinput_dev->id.vendor = SERIO_STINGER;\n\tinput_dev->id.product = 0x0001;\n\tinput_dev->id.version = 0x0100;\n\tinput_dev->dev.parent = &serio->dev;\n\n\tinput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\n\tinput_dev->keybit[BIT_WORD(BTN_A)] = BIT_MASK(BTN_A) | BIT_MASK(BTN_B) |\n\t\tBIT_MASK(BTN_C) | BIT_MASK(BTN_X) | BIT_MASK(BTN_Y) |\n\t\tBIT_MASK(BTN_Z) | BIT_MASK(BTN_TL) | BIT_MASK(BTN_TR) |\n\t\tBIT_MASK(BTN_START) | BIT_MASK(BTN_SELECT);\n\tinput_set_abs_params(input_dev, ABS_X, -64, 64, 0, 4);\n\tinput_set_abs_params(input_dev, ABS_Y, -64, 64, 0, 4);\n\n\tserio_set_drvdata(serio, stinger);\n\n\terr = serio_open(serio, drv);\n\tif (err)\n\t\tgoto fail2;\n\n\terr = input_register_device(stinger->dev);\n\tif (err)\n\t\tgoto fail3;\n\n\treturn 0;\n\n fail3:\tserio_close(serio);\n fail2:\tserio_set_drvdata(serio, NULL);\n fail1:\tinput_free_device(input_dev);\n\tkfree(stinger);\n\treturn err;\n}\n\n \n\nstatic const struct serio_device_id stinger_serio_ids[] = {\n\t{\n\t\t.type\t= SERIO_RS232,\n\t\t.proto\t= SERIO_STINGER,\n\t\t.id\t= SERIO_ANY,\n\t\t.extra\t= SERIO_ANY,\n\t},\n\t{ 0 }\n};\n\nMODULE_DEVICE_TABLE(serio, stinger_serio_ids);\n\nstatic struct serio_driver stinger_drv = {\n\t.driver\t\t= {\n\t\t.name\t= \"stinger\",\n\t},\n\t.description\t= DRIVER_DESC,\n\t.id_table\t= stinger_serio_ids,\n\t.interrupt\t= stinger_interrupt,\n\t.connect\t= stinger_connect,\n\t.disconnect\t= stinger_disconnect,\n};\n\nmodule_serio_driver(stinger_drv);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}