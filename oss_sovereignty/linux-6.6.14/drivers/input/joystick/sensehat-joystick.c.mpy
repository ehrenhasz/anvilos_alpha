{
  "module_name": "sensehat-joystick.c",
  "hash_id": "910328cf31de61288c6c412bdd7cd99ee089c5dd95cce779b0ceb4b59ca5d083",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/joystick/sensehat-joystick.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/input.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/property.h>\n\n#define JOYSTICK_SMB_REG 0xf2\n\nstruct sensehat_joystick {\n\tstruct platform_device *pdev;\n\tstruct input_dev *keys_dev;\n\tunsigned long prev_states;\n\tstruct regmap *regmap;\n};\n\nstatic const unsigned int keymap[] = {\n\tBTN_DPAD_DOWN, BTN_DPAD_RIGHT, BTN_DPAD_UP, BTN_SELECT, BTN_DPAD_LEFT,\n};\n\nstatic irqreturn_t sensehat_joystick_report(int irq, void *cookie)\n{\n\tstruct sensehat_joystick *sensehat_joystick = cookie;\n\tunsigned long curr_states, changes;\n\tunsigned int keys;\n\tint error;\n\tint i;\n\n\terror = regmap_read(sensehat_joystick->regmap, JOYSTICK_SMB_REG, &keys);\n\tif (error < 0) {\n\t\tdev_err(&sensehat_joystick->pdev->dev,\n\t\t\t\"Failed to read joystick state: %d\", error);\n\t\treturn IRQ_NONE;\n\t}\n\tcurr_states = keys;\n\tbitmap_xor(&changes, &curr_states, &sensehat_joystick->prev_states,\n\t\t   ARRAY_SIZE(keymap));\n\n\tfor_each_set_bit(i, &changes, ARRAY_SIZE(keymap))\n\t\tinput_report_key(sensehat_joystick->keys_dev, keymap[i],\n\t\t\t\t curr_states & BIT(i));\n\n\tinput_sync(sensehat_joystick->keys_dev);\n\tsensehat_joystick->prev_states = keys;\n\treturn IRQ_HANDLED;\n}\n\nstatic int sensehat_joystick_probe(struct platform_device *pdev)\n{\n\tstruct sensehat_joystick *sensehat_joystick;\n\tint error, i, irq;\n\n\tsensehat_joystick = devm_kzalloc(&pdev->dev, sizeof(*sensehat_joystick),\n\t\t\t\t\t GFP_KERNEL);\n\tif (!sensehat_joystick)\n\t\treturn -ENOMEM;\n\n\tsensehat_joystick->pdev = pdev;\n\n\tsensehat_joystick->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!sensehat_joystick->regmap) {\n\t\tdev_err(&pdev->dev, \"unable to get sensehat regmap\");\n\t\treturn -ENODEV;\n\t}\n\n\tsensehat_joystick->keys_dev = devm_input_allocate_device(&pdev->dev);\n\tif (!sensehat_joystick->keys_dev) {\n\t\tdev_err(&pdev->dev, \"Could not allocate input device\");\n\t\treturn -ENOMEM;\n\t}\n\n\tsensehat_joystick->keys_dev->name = \"Raspberry Pi Sense HAT Joystick\";\n\tsensehat_joystick->keys_dev->phys = \"sensehat-joystick/input0\";\n\tsensehat_joystick->keys_dev->id.bustype = BUS_I2C;\n\n\t__set_bit(EV_KEY, sensehat_joystick->keys_dev->evbit);\n\t__set_bit(EV_REP, sensehat_joystick->keys_dev->evbit);\n\tfor (i = 0; i < ARRAY_SIZE(keymap); i++)\n\t\t__set_bit(keymap[i], sensehat_joystick->keys_dev->keybit);\n\n\terror = input_register_device(sensehat_joystick->keys_dev);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"Could not register input device\");\n\t\treturn error;\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\terror = devm_request_threaded_irq(&pdev->dev, irq,\n\t\t\t\t\t  NULL, sensehat_joystick_report,\n\t\t\t\t\t  IRQF_ONESHOT, \"keys\",\n\t\t\t\t\t  sensehat_joystick);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"IRQ request failed\");\n\t\treturn error;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id sensehat_joystick_device_id[] = {\n\t{ .compatible = \"raspberrypi,sensehat-joystick\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, sensehat_joystick_device_id);\n\nstatic struct platform_driver sensehat_joystick_driver = {\n\t.probe = sensehat_joystick_probe,\n\t.driver = {\n\t\t.name = \"sensehat-joystick\",\n\t\t.of_match_table = sensehat_joystick_device_id,\n\t},\n};\n\nmodule_platform_driver(sensehat_joystick_driver);\n\nMODULE_DESCRIPTION(\"Raspberry Pi Sense HAT joystick driver\");\nMODULE_AUTHOR(\"Charles Mirabile <cmirabil@redhat.com>\");\nMODULE_AUTHOR(\"Serge Schneider <serge@raspberrypi.org>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}