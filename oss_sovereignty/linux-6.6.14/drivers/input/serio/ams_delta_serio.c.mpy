{
  "module_name": "ams_delta_serio.c",
  "hash_id": "1adf0205339116f30829a10b1cbcc51c1c2c14284c9b15193c7e3edb79403242",
  "original_prompt": "Ingested from linux-6.6.14/drivers/input/serio/ams_delta_serio.c",
  "human_readable_source": "\n \n#include <linux/irq.h>\n#include <linux/platform_data/ams-delta-fiq.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/consumer.h>\n#include <linux/serio.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n\n#define DRIVER_NAME\t\"ams-delta-serio\"\n\nMODULE_AUTHOR(\"Matt Callow\");\nMODULE_DESCRIPTION(\"AMS Delta (E3) keyboard port driver\");\nMODULE_LICENSE(\"GPL\");\n\nstruct ams_delta_serio {\n\tstruct serio *serio;\n\tstruct regulator *vcc;\n\tunsigned int *fiq_buffer;\n};\n\nstatic int check_data(struct serio *serio, int data)\n{\n\tint i, parity = 0;\n\n\t \n\tif (!(data & 0x400)) {\n\t\tdev_warn(&serio->dev, \"invalid stop bit, data=0x%X\\n\", data);\n\t\treturn SERIO_FRAME;\n\t}\n\t \n\tfor (i = 1; i < 10; i++) {\n\t\tif (data & (1 << i))\n\t\t\tparity++;\n\t}\n\t \n\tif (!(parity & 0x01)) {\n\t\tdev_warn(&serio->dev,\n\t\t\t \"parity check failed, data=0x%X parity=0x%X\\n\", data,\n\t\t\t parity);\n\t\treturn SERIO_PARITY;\n\t}\n\treturn 0;\n}\n\nstatic irqreturn_t ams_delta_serio_interrupt(int irq, void *dev_id)\n{\n\tstruct ams_delta_serio *priv = dev_id;\n\tint *circ_buff = &priv->fiq_buffer[FIQ_CIRC_BUFF];\n\tint data, dfl;\n\tu8 scancode;\n\n\tpriv->fiq_buffer[FIQ_IRQ_PEND] = 0;\n\n\t \n\twhile (priv->fiq_buffer[FIQ_KEYS_CNT] > 0) {\n\n\t\tdata = circ_buff[priv->fiq_buffer[FIQ_HEAD_OFFSET]++];\n\t\tpriv->fiq_buffer[FIQ_KEYS_CNT]--;\n\t\tif (priv->fiq_buffer[FIQ_HEAD_OFFSET] ==\n\t\t    priv->fiq_buffer[FIQ_BUF_LEN])\n\t\t\tpriv->fiq_buffer[FIQ_HEAD_OFFSET] = 0;\n\n\t\tdfl = check_data(priv->serio, data);\n\t\tscancode = (u8) (data >> 1) & 0xFF;\n\t\tserio_interrupt(priv->serio, scancode, dfl);\n\t}\n\treturn IRQ_HANDLED;\n}\n\nstatic int ams_delta_serio_open(struct serio *serio)\n{\n\tstruct ams_delta_serio *priv = serio->port_data;\n\n\t \n\treturn regulator_enable(priv->vcc);\n}\n\nstatic void ams_delta_serio_close(struct serio *serio)\n{\n\tstruct ams_delta_serio *priv = serio->port_data;\n\n\t \n\tregulator_disable(priv->vcc);\n}\n\nstatic int ams_delta_serio_init(struct platform_device *pdev)\n{\n\tstruct ams_delta_serio *priv;\n\tstruct serio *serio;\n\tint irq, err;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->fiq_buffer = pdev->dev.platform_data;\n\tif (!priv->fiq_buffer)\n\t\treturn -EINVAL;\n\n\tpriv->vcc = devm_regulator_get(&pdev->dev, \"vcc\");\n\tif (IS_ERR(priv->vcc)) {\n\t\terr = PTR_ERR(priv->vcc);\n\t\tdev_err(&pdev->dev, \"regulator request failed (%d)\\n\", err);\n\t\t \n\t\tif (err == -ENODEV)\n\t\t\terr = -EPROBE_DEFER;\n\t\treturn err;\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn -ENXIO;\n\n\terr = devm_request_irq(&pdev->dev, irq, ams_delta_serio_interrupt,\n\t\t\t       IRQ_TYPE_EDGE_RISING, DRIVER_NAME, priv);\n\tif (err < 0) {\n\t\tdev_err(&pdev->dev, \"IRQ request failed (%d)\\n\", err);\n\t\treturn err;\n\t}\n\n\tserio = kzalloc(sizeof(*serio), GFP_KERNEL);\n\tif (!serio)\n\t\treturn -ENOMEM;\n\n\tpriv->serio = serio;\n\n\tserio->id.type = SERIO_8042;\n\tserio->open = ams_delta_serio_open;\n\tserio->close = ams_delta_serio_close;\n\tstrscpy(serio->name, \"AMS DELTA keyboard adapter\", sizeof(serio->name));\n\tstrscpy(serio->phys, dev_name(&pdev->dev), sizeof(serio->phys));\n\tserio->dev.parent = &pdev->dev;\n\tserio->port_data = priv;\n\n\tserio_register_port(serio);\n\n\tplatform_set_drvdata(pdev, priv);\n\n\tdev_info(&serio->dev, \"%s\\n\", serio->name);\n\n\treturn 0;\n}\n\nstatic int ams_delta_serio_exit(struct platform_device *pdev)\n{\n\tstruct ams_delta_serio *priv = platform_get_drvdata(pdev);\n\n\tserio_unregister_port(priv->serio);\n\n\treturn 0;\n}\n\nstatic struct platform_driver ams_delta_serio_driver = {\n\t.probe\t= ams_delta_serio_init,\n\t.remove\t= ams_delta_serio_exit,\n\t.driver\t= {\n\t\t.name\t= DRIVER_NAME\n\t},\n};\nmodule_platform_driver(ams_delta_serio_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}