{
  "module_name": "spi-clps711x.c",
  "hash_id": "ccbd1e78de8950a61a902e7abf32bc27614c597b513e9dcc971962da934a992b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-clps711x.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/clk.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/mfd/syscon.h>\n#include <linux/mfd/syscon/clps711x.h>\n#include <linux/spi/spi.h>\n\n#define DRIVER_NAME\t\t\"clps711x-spi\"\n\n#define SYNCIO_FRMLEN(x)\t((x) << 8)\n#define SYNCIO_TXFRMEN\t\t(1 << 14)\n\nstruct spi_clps711x_data {\n\tvoid __iomem\t\t*syncio;\n\tstruct regmap\t\t*syscon;\n\tstruct clk\t\t*spi_clk;\n\n\tu8\t\t\t*tx_buf;\n\tu8\t\t\t*rx_buf;\n\tunsigned int\t\tbpw;\n\tint\t\t\tlen;\n};\n\nstatic int spi_clps711x_prepare_message(struct spi_controller *host,\n\t\t\t\t\tstruct spi_message *msg)\n{\n\tstruct spi_clps711x_data *hw = spi_controller_get_devdata(host);\n\tstruct spi_device *spi = msg->spi;\n\n\t \n\treturn regmap_update_bits(hw->syscon, SYSCON_OFFSET, SYSCON3_ADCCKNSEN,\n\t\t\t\t  (spi->mode & SPI_CPHA) ?\n\t\t\t\t  SYSCON3_ADCCKNSEN : 0);\n}\n\nstatic int spi_clps711x_transfer_one(struct spi_controller *host,\n\t\t\t\t     struct spi_device *spi,\n\t\t\t\t     struct spi_transfer *xfer)\n{\n\tstruct spi_clps711x_data *hw = spi_controller_get_devdata(host);\n\tu8 data;\n\n\tclk_set_rate(hw->spi_clk, xfer->speed_hz ? : spi->max_speed_hz);\n\n\thw->len = xfer->len;\n\thw->bpw = xfer->bits_per_word;\n\thw->tx_buf = (u8 *)xfer->tx_buf;\n\thw->rx_buf = (u8 *)xfer->rx_buf;\n\n\t \n\tdata = hw->tx_buf ? *hw->tx_buf++ : 0;\n\twritel(data | SYNCIO_FRMLEN(hw->bpw) | SYNCIO_TXFRMEN, hw->syncio);\n\n\treturn 1;\n}\n\nstatic irqreturn_t spi_clps711x_isr(int irq, void *dev_id)\n{\n\tstruct spi_controller *host = dev_id;\n\tstruct spi_clps711x_data *hw = spi_controller_get_devdata(host);\n\tu8 data;\n\n\t \n\tdata = readb(hw->syncio);\n\tif (hw->rx_buf)\n\t\t*hw->rx_buf++ = data;\n\n\t \n\tif (--hw->len > 0) {\n\t\tdata = hw->tx_buf ? *hw->tx_buf++ : 0;\n\t\twritel(data | SYNCIO_FRMLEN(hw->bpw) | SYNCIO_TXFRMEN,\n\t\t       hw->syncio);\n\t} else\n\t\tspi_finalize_current_transfer(host);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int spi_clps711x_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct spi_clps711x_data *hw;\n\tstruct spi_controller *host;\n\tint irq, ret;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\thost = spi_alloc_host(&pdev->dev, sizeof(*hw));\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\thost->use_gpio_descriptors = true;\n\thost->bus_num = -1;\n\thost->mode_bits = SPI_CPHA | SPI_CS_HIGH;\n\thost->bits_per_word_mask = SPI_BPW_RANGE_MASK(1, 8);\n\thost->dev.of_node = pdev->dev.of_node;\n\thost->prepare_message = spi_clps711x_prepare_message;\n\thost->transfer_one = spi_clps711x_transfer_one;\n\n\thw = spi_controller_get_devdata(host);\n\n\thw->spi_clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(hw->spi_clk)) {\n\t\tret = PTR_ERR(hw->spi_clk);\n\t\tgoto err_out;\n\t}\n\n\thw->syscon = syscon_regmap_lookup_by_phandle(np, \"syscon\");\n\tif (IS_ERR(hw->syscon)) {\n\t\tret = PTR_ERR(hw->syscon);\n\t\tgoto err_out;\n\t}\n\n\thw->syncio = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(hw->syncio)) {\n\t\tret = PTR_ERR(hw->syncio);\n\t\tgoto err_out;\n\t}\n\n\t \n\tregmap_update_bits(hw->syscon, SYSCON_OFFSET, SYSCON3_ADCCON, 0);\n\n\t \n\treadl(hw->syncio);\n\n\tret = devm_request_irq(&pdev->dev, irq, spi_clps711x_isr, 0,\n\t\t\t       dev_name(&pdev->dev), host);\n\tif (ret)\n\t\tgoto err_out;\n\n\tret = devm_spi_register_controller(&pdev->dev, host);\n\tif (!ret)\n\t\treturn 0;\n\nerr_out:\n\tspi_controller_put(host);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id clps711x_spi_dt_ids[] = {\n\t{ .compatible = \"cirrus,ep7209-spi\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, clps711x_spi_dt_ids);\n\nstatic struct platform_driver clps711x_spi_driver = {\n\t.driver\t= {\n\t\t.name\t= DRIVER_NAME,\n\t\t.of_match_table = clps711x_spi_dt_ids,\n\t},\n\t.probe\t= spi_clps711x_probe,\n};\nmodule_platform_driver(clps711x_spi_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Alexander Shiyan <shc_work@mail.ru>\");\nMODULE_DESCRIPTION(\"CLPS711X SPI bus driver\");\nMODULE_ALIAS(\"platform:\" DRIVER_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}