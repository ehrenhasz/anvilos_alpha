{
  "module_name": "spi-pxa2xx-pci.c",
  "hash_id": "b6a49378a2e41eb0d801961677dacfe49f6c16c4322d073d34729661b0b4c14f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-pxa2xx-pci.c",
  "human_readable_source": "\n \n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/platform_device.h>\n\n#include <linux/spi/pxa2xx_spi.h>\n\n#include <linux/dmaengine.h>\n#include <linux/platform_data/dma-dw.h>\n\n#define PCI_DEVICE_ID_INTEL_QUARK_X1000\t\t0x0935\n#define PCI_DEVICE_ID_INTEL_BYT\t\t\t0x0f0e\n#define PCI_DEVICE_ID_INTEL_MRFLD\t\t0x1194\n#define PCI_DEVICE_ID_INTEL_BSW0\t\t0x228e\n#define PCI_DEVICE_ID_INTEL_BSW1\t\t0x2290\n#define PCI_DEVICE_ID_INTEL_BSW2\t\t0x22ac\n#define PCI_DEVICE_ID_INTEL_CE4100\t\t0x2e6a\n#define PCI_DEVICE_ID_INTEL_LPT0_0\t\t0x9c65\n#define PCI_DEVICE_ID_INTEL_LPT0_1\t\t0x9c66\n#define PCI_DEVICE_ID_INTEL_LPT1_0\t\t0x9ce5\n#define PCI_DEVICE_ID_INTEL_LPT1_1\t\t0x9ce6\n\nstruct pxa_spi_info {\n\tint (*setup)(struct pci_dev *pdev, struct pxa2xx_spi_controller *c);\n};\n\nstatic struct dw_dma_slave byt_tx_param = { .dst_id = 0 };\nstatic struct dw_dma_slave byt_rx_param = { .src_id = 1 };\n\nstatic struct dw_dma_slave mrfld3_tx_param = { .dst_id = 15 };\nstatic struct dw_dma_slave mrfld3_rx_param = { .src_id = 14 };\nstatic struct dw_dma_slave mrfld5_tx_param = { .dst_id = 13 };\nstatic struct dw_dma_slave mrfld5_rx_param = { .src_id = 12 };\nstatic struct dw_dma_slave mrfld6_tx_param = { .dst_id = 11 };\nstatic struct dw_dma_slave mrfld6_rx_param = { .src_id = 10 };\n\nstatic struct dw_dma_slave bsw0_tx_param = { .dst_id = 0 };\nstatic struct dw_dma_slave bsw0_rx_param = { .src_id = 1 };\nstatic struct dw_dma_slave bsw1_tx_param = { .dst_id = 6 };\nstatic struct dw_dma_slave bsw1_rx_param = { .src_id = 7 };\nstatic struct dw_dma_slave bsw2_tx_param = { .dst_id = 8 };\nstatic struct dw_dma_slave bsw2_rx_param = { .src_id = 9 };\n\nstatic struct dw_dma_slave lpt1_tx_param = { .dst_id = 0 };\nstatic struct dw_dma_slave lpt1_rx_param = { .src_id = 1 };\nstatic struct dw_dma_slave lpt0_tx_param = { .dst_id = 2 };\nstatic struct dw_dma_slave lpt0_rx_param = { .src_id = 3 };\n\nstatic void pxa2xx_spi_pci_clk_unregister(void *clk)\n{\n\tclk_unregister(clk);\n}\n\nstatic int pxa2xx_spi_pci_clk_register(struct pci_dev *dev, struct ssp_device *ssp,\n\t\t\t\t       unsigned long rate)\n{\n\tchar buf[40];\n\n\tsnprintf(buf, sizeof(buf), \"pxa2xx-spi.%d\", ssp->port_id);\n\tssp->clk = clk_register_fixed_rate(&dev->dev, buf, NULL, 0, rate);\n\tif (IS_ERR(ssp->clk))\n\t\treturn PTR_ERR(ssp->clk);\n\n\treturn devm_add_action_or_reset(&dev->dev, pxa2xx_spi_pci_clk_unregister, ssp->clk);\n}\n\nstatic bool lpss_dma_filter(struct dma_chan *chan, void *param)\n{\n\tstruct dw_dma_slave *dws = param;\n\n\tif (dws->dma_dev != chan->device->dev)\n\t\treturn false;\n\n\tchan->private = dws;\n\treturn true;\n}\n\nstatic void lpss_dma_put_device(void *dma_dev)\n{\n\tpci_dev_put(dma_dev);\n}\n\nstatic int lpss_spi_setup(struct pci_dev *dev, struct pxa2xx_spi_controller *c)\n{\n\tstruct ssp_device *ssp = &c->ssp;\n\tstruct dw_dma_slave *tx, *rx;\n\tstruct pci_dev *dma_dev;\n\tint ret;\n\n\tswitch (dev->device) {\n\tcase PCI_DEVICE_ID_INTEL_BYT:\n\t\tssp->type = LPSS_BYT_SSP;\n\t\tssp->port_id = 0;\n\t\tc->tx_param = &byt_tx_param;\n\t\tc->rx_param = &byt_rx_param;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_INTEL_BSW0:\n\t\tssp->type = LPSS_BSW_SSP;\n\t\tssp->port_id = 0;\n\t\tc->tx_param = &bsw0_tx_param;\n\t\tc->rx_param = &bsw0_rx_param;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_INTEL_BSW1:\n\t\tssp->type = LPSS_BSW_SSP;\n\t\tssp->port_id = 1;\n\t\tc->tx_param = &bsw1_tx_param;\n\t\tc->rx_param = &bsw1_rx_param;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_INTEL_BSW2:\n\t\tssp->type = LPSS_BSW_SSP;\n\t\tssp->port_id = 2;\n\t\tc->tx_param = &bsw2_tx_param;\n\t\tc->rx_param = &bsw2_rx_param;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_INTEL_LPT0_0:\n\tcase PCI_DEVICE_ID_INTEL_LPT1_0:\n\t\tssp->type = LPSS_LPT_SSP;\n\t\tssp->port_id = 0;\n\t\tc->tx_param = &lpt0_tx_param;\n\t\tc->rx_param = &lpt0_rx_param;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_INTEL_LPT0_1:\n\tcase PCI_DEVICE_ID_INTEL_LPT1_1:\n\t\tssp->type = LPSS_LPT_SSP;\n\t\tssp->port_id = 1;\n\t\tc->tx_param = &lpt1_tx_param;\n\t\tc->rx_param = &lpt1_rx_param;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\n\tc->num_chipselect = 1;\n\n\tret = pxa2xx_spi_pci_clk_register(dev, ssp, 50000000);\n\tif (ret)\n\t\treturn ret;\n\n\tdma_dev = pci_get_slot(dev->bus, PCI_DEVFN(PCI_SLOT(dev->devfn), 0));\n\tret = devm_add_action_or_reset(&dev->dev, lpss_dma_put_device, dma_dev);\n\tif (ret)\n\t\treturn ret;\n\n\ttx = c->tx_param;\n\ttx->dma_dev = &dma_dev->dev;\n\ttx->m_master = 0;\n\ttx->p_master = 1;\n\n\trx = c->rx_param;\n\trx->dma_dev = &dma_dev->dev;\n\trx->m_master = 0;\n\trx->p_master = 1;\n\n\tc->dma_filter = lpss_dma_filter;\n\tc->dma_burst_size = 1;\n\tc->enable_dma = 1;\n\treturn 0;\n}\n\nstatic const struct pxa_spi_info lpss_info_config = {\n\t.setup = lpss_spi_setup,\n};\n\nstatic int ce4100_spi_setup(struct pci_dev *dev, struct pxa2xx_spi_controller *c)\n{\n\tstruct ssp_device *ssp = &c->ssp;\n\n\tssp->type = PXA25x_SSP;\n\tssp->port_id = dev->devfn;\n\tc->num_chipselect = dev->devfn;\n\n\treturn pxa2xx_spi_pci_clk_register(dev, ssp, 3686400);\n}\n\nstatic const struct pxa_spi_info ce4100_info_config = {\n\t.setup = ce4100_spi_setup,\n};\n\nstatic int mrfld_spi_setup(struct pci_dev *dev, struct pxa2xx_spi_controller *c)\n{\n\tstruct ssp_device *ssp = &c->ssp;\n\tstruct dw_dma_slave *tx, *rx;\n\tstruct pci_dev *dma_dev;\n\tint ret;\n\n\tssp->type = MRFLD_SSP;\n\n\tswitch (PCI_FUNC(dev->devfn)) {\n\tcase 0:\n\t\tssp->port_id = 3;\n\t\tc->num_chipselect = 1;\n\t\tc->tx_param = &mrfld3_tx_param;\n\t\tc->rx_param = &mrfld3_rx_param;\n\t\tbreak;\n\tcase 1:\n\t\tssp->port_id = 5;\n\t\tc->num_chipselect = 4;\n\t\tc->tx_param = &mrfld5_tx_param;\n\t\tc->rx_param = &mrfld5_rx_param;\n\t\tbreak;\n\tcase 2:\n\t\tssp->port_id = 6;\n\t\tc->num_chipselect = 1;\n\t\tc->tx_param = &mrfld6_tx_param;\n\t\tc->rx_param = &mrfld6_rx_param;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\n\tret = pxa2xx_spi_pci_clk_register(dev, ssp, 25000000);\n\tif (ret)\n\t\treturn ret;\n\n\tdma_dev = pci_get_slot(dev->bus, PCI_DEVFN(21, 0));\n\tret = devm_add_action_or_reset(&dev->dev, lpss_dma_put_device, dma_dev);\n\tif (ret)\n\t\treturn ret;\n\n\ttx = c->tx_param;\n\ttx->dma_dev = &dma_dev->dev;\n\n\trx = c->rx_param;\n\trx->dma_dev = &dma_dev->dev;\n\n\tc->dma_filter = lpss_dma_filter;\n\tc->dma_burst_size = 8;\n\tc->enable_dma = 1;\n\treturn 0;\n}\n\nstatic const struct pxa_spi_info mrfld_info_config = {\n\t.setup = mrfld_spi_setup,\n};\n\nstatic int qrk_spi_setup(struct pci_dev *dev, struct pxa2xx_spi_controller *c)\n{\n\tstruct ssp_device *ssp = &c->ssp;\n\n\tssp->type = QUARK_X1000_SSP;\n\tssp->port_id = dev->devfn;\n\tc->num_chipselect = 1;\n\n\treturn pxa2xx_spi_pci_clk_register(dev, ssp, 50000000);\n}\n\nstatic const struct pxa_spi_info qrk_info_config = {\n\t.setup = qrk_spi_setup,\n};\n\nstatic int pxa2xx_spi_pci_probe(struct pci_dev *dev,\n\t\tconst struct pci_device_id *ent)\n{\n\tconst struct pxa_spi_info *info;\n\tstruct platform_device_info pi;\n\tint ret;\n\tstruct platform_device *pdev;\n\tstruct pxa2xx_spi_controller spi_pdata;\n\tstruct ssp_device *ssp;\n\n\tret = pcim_enable_device(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = pcim_iomap_regions(dev, 1 << 0, \"PXA2xx SPI\");\n\tif (ret)\n\t\treturn ret;\n\n\tmemset(&spi_pdata, 0, sizeof(spi_pdata));\n\n\tssp = &spi_pdata.ssp;\n\tssp->dev = &dev->dev;\n\tssp->phys_base = pci_resource_start(dev, 0);\n\tssp->mmio_base = pcim_iomap_table(dev)[0];\n\n\tinfo = (struct pxa_spi_info *)ent->driver_data;\n\tret = info->setup(dev, &spi_pdata);\n\tif (ret)\n\t\treturn ret;\n\n\tpci_set_master(dev);\n\n\tret = pci_alloc_irq_vectors(dev, 1, 1, PCI_IRQ_ALL_TYPES);\n\tif (ret < 0)\n\t\treturn ret;\n\tssp->irq = pci_irq_vector(dev, 0);\n\n\tmemset(&pi, 0, sizeof(pi));\n\tpi.fwnode = dev_fwnode(&dev->dev);\n\tpi.parent = &dev->dev;\n\tpi.name = \"pxa2xx-spi\";\n\tpi.id = ssp->port_id;\n\tpi.data = &spi_pdata;\n\tpi.size_data = sizeof(spi_pdata);\n\n\tpdev = platform_device_register_full(&pi);\n\tif (IS_ERR(pdev))\n\t\treturn PTR_ERR(pdev);\n\n\tpci_set_drvdata(dev, pdev);\n\n\treturn 0;\n}\n\nstatic void pxa2xx_spi_pci_remove(struct pci_dev *dev)\n{\n\tstruct platform_device *pdev = pci_get_drvdata(dev);\n\n\tplatform_device_unregister(pdev);\n}\n\nstatic const struct pci_device_id pxa2xx_spi_pci_devices[] = {\n\t{ PCI_DEVICE_DATA(INTEL, QUARK_X1000, &qrk_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, BYT, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, MRFLD, &mrfld_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, BSW0, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, BSW1, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, BSW2, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, CE4100, &ce4100_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, LPT0_0, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, LPT0_1, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, LPT1_0, &lpss_info_config) },\n\t{ PCI_DEVICE_DATA(INTEL, LPT1_1, &lpss_info_config) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(pci, pxa2xx_spi_pci_devices);\n\nstatic struct pci_driver pxa2xx_spi_pci_driver = {\n\t.name           = \"pxa2xx_spi_pci\",\n\t.id_table       = pxa2xx_spi_pci_devices,\n\t.probe          = pxa2xx_spi_pci_probe,\n\t.remove         = pxa2xx_spi_pci_remove,\n};\n\nmodule_pci_driver(pxa2xx_spi_pci_driver);\n\nMODULE_DESCRIPTION(\"CE4100/LPSS PCI-SPI glue code for PXA's driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Sebastian Andrzej Siewior <bigeasy@linutronix.de>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}