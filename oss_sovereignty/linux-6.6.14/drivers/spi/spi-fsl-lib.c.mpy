{
  "module_name": "spi-fsl-lib.c",
  "hash_id": "ab999c13e856b6ad6d09de6be280e7d7cc2347f5d5b27c85d101cfc98b57900e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-fsl-lib.c",
  "human_readable_source": "\n \n#include <linux/dma-mapping.h>\n#include <linux/fsl_devices.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/spi/spi.h>\n#ifdef CONFIG_FSL_SOC\n#include <sysdev/fsl_soc.h>\n#endif\n\n#include \"spi-fsl-lib.h\"\n\n#define MPC8XXX_SPI_RX_BUF(type) \t\t\t\t\t  \\\nvoid mpc8xxx_spi_rx_buf_##type(u32 data, struct mpc8xxx_spi *mpc8xxx_spi) \\\n{\t\t\t\t\t\t\t\t\t  \\\n\ttype *rx = mpc8xxx_spi->rx;\t\t\t\t\t  \\\n\t*rx++ = (type)(data >> mpc8xxx_spi->rx_shift);\t\t\t  \\\n\tmpc8xxx_spi->rx = rx;\t\t\t\t\t\t  \\\n}\t\t\t\t\t\t\t\t\t  \\\nEXPORT_SYMBOL_GPL(mpc8xxx_spi_rx_buf_##type);\n\n#define MPC8XXX_SPI_TX_BUF(type)\t\t\t\t\\\nu32 mpc8xxx_spi_tx_buf_##type(struct mpc8xxx_spi *mpc8xxx_spi)\t\\\n{\t\t\t\t\t\t\t\t\\\n\tu32 data;\t\t\t\t\t\t\\\n\tconst type *tx = mpc8xxx_spi->tx;\t\t\t\\\n\tif (!tx)\t\t\t\t\t\t\\\n\t\treturn 0;\t\t\t\t\t\\\n\tdata = *tx++ << mpc8xxx_spi->tx_shift;\t\t\t\\\n\tmpc8xxx_spi->tx = tx;\t\t\t\t\t\\\n\treturn data;\t\t\t\t\t\t\\\n}\t\t\t\t\t\t\t\t\\\nEXPORT_SYMBOL_GPL(mpc8xxx_spi_tx_buf_##type);\n\nMPC8XXX_SPI_RX_BUF(u8)\nMPC8XXX_SPI_RX_BUF(u16)\nMPC8XXX_SPI_RX_BUF(u32)\nMPC8XXX_SPI_TX_BUF(u8)\nMPC8XXX_SPI_TX_BUF(u16)\nMPC8XXX_SPI_TX_BUF(u32)\n\nstruct mpc8xxx_spi_probe_info *to_of_pinfo(struct fsl_spi_platform_data *pdata)\n{\n\treturn container_of(pdata, struct mpc8xxx_spi_probe_info, pdata);\n}\nEXPORT_SYMBOL_GPL(to_of_pinfo);\n\nconst char *mpc8xxx_spi_strmode(unsigned int flags)\n{\n\tif (flags & SPI_QE_CPU_MODE) {\n\t\treturn \"QE CPU\";\n\t} else if (flags & SPI_CPM_MODE) {\n\t\tif (flags & SPI_QE)\n\t\t\treturn \"QE\";\n\t\telse if (flags & SPI_CPM2)\n\t\t\treturn \"CPM2\";\n\t\telse\n\t\t\treturn \"CPM1\";\n\t}\n\treturn \"CPU\";\n}\nEXPORT_SYMBOL_GPL(mpc8xxx_spi_strmode);\n\nvoid mpc8xxx_spi_probe(struct device *dev, struct resource *mem,\n\t\t\tunsigned int irq)\n{\n\tstruct fsl_spi_platform_data *pdata = dev_get_platdata(dev);\n\tstruct spi_master *master;\n\tstruct mpc8xxx_spi *mpc8xxx_spi;\n\n\tmaster = dev_get_drvdata(dev);\n\n\t \n\tmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH\n\t\t\t| SPI_LSB_FIRST | SPI_LOOP;\n\n\tmaster->dev.of_node = dev->of_node;\n\n\tmpc8xxx_spi = spi_master_get_devdata(master);\n\tmpc8xxx_spi->dev = dev;\n\tmpc8xxx_spi->get_rx = mpc8xxx_spi_rx_buf_u8;\n\tmpc8xxx_spi->get_tx = mpc8xxx_spi_tx_buf_u8;\n\tmpc8xxx_spi->flags = pdata->flags;\n\tmpc8xxx_spi->spibrg = pdata->sysclk;\n\tmpc8xxx_spi->irq = irq;\n\n\tmpc8xxx_spi->rx_shift = 0;\n\tmpc8xxx_spi->tx_shift = 0;\n\n\tmaster->bus_num = pdata->bus_num;\n\tmaster->num_chipselect = pdata->max_chipselect;\n\n\tinit_completion(&mpc8xxx_spi->done);\n}\nEXPORT_SYMBOL_GPL(mpc8xxx_spi_probe);\n\nint of_mpc8xxx_spi_probe(struct platform_device *ofdev)\n{\n\tstruct device *dev = &ofdev->dev;\n\tstruct device_node *np = ofdev->dev.of_node;\n\tstruct mpc8xxx_spi_probe_info *pinfo;\n\tstruct fsl_spi_platform_data *pdata;\n\tconst void *prop;\n\tint ret = -ENOMEM;\n\n\tpinfo = devm_kzalloc(&ofdev->dev, sizeof(*pinfo), GFP_KERNEL);\n\tif (!pinfo)\n\t\treturn ret;\n\n\tpdata = &pinfo->pdata;\n\tdev->platform_data = pdata;\n\n\t \n\tpdata->bus_num = -1;\n\n#ifdef CONFIG_FSL_SOC\n\t \n\tpdata->sysclk = get_brgfreq();\n\tif (pdata->sysclk == -1) {\n\t\tpdata->sysclk = fsl_get_sys_freq();\n\t\tif (pdata->sysclk == -1)\n\t\t\treturn -ENODEV;\n\t}\n#else\n\tret = of_property_read_u32(np, \"clock-frequency\", &pdata->sysclk);\n\tif (ret)\n\t\treturn ret;\n#endif\n\n\tprop = of_get_property(np, \"mode\", NULL);\n\tif (prop && !strcmp(prop, \"cpu-qe\"))\n\t\tpdata->flags = SPI_QE_CPU_MODE;\n\telse if (prop && !strcmp(prop, \"qe\"))\n\t\tpdata->flags = SPI_CPM_MODE | SPI_QE;\n\telse if (of_device_is_compatible(np, \"fsl,cpm2-spi\"))\n\t\tpdata->flags = SPI_CPM_MODE | SPI_CPM2;\n\telse if (of_device_is_compatible(np, \"fsl,cpm1-spi\"))\n\t\tpdata->flags = SPI_CPM_MODE | SPI_CPM1;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(of_mpc8xxx_spi_probe);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}