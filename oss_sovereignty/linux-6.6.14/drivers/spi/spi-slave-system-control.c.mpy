{
  "module_name": "spi-slave-system-control.c",
  "hash_id": "b55463a95e2f26dbf91749a080a4d241ee6d59a9aae9bb219548c79231fadcf5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-slave-system-control.c",
  "human_readable_source": " \n\n#include <linux/completion.h>\n#include <linux/module.h>\n#include <linux/reboot.h>\n#include <linux/suspend.h>\n#include <linux/spi/spi.h>\n\n \n#define CMD_REBOOT\t0x7c50\t \n#define CMD_POWEROFF\t0x713f\t \n#define CMD_HALT\t0x3876\t \n#define CMD_SUSPEND\t0x1b1b\t \n\nstruct spi_slave_system_control_priv {\n\tstruct spi_device *spi;\n\tstruct completion finished;\n\tstruct spi_transfer xfer;\n\tstruct spi_message msg;\n\t__be16 cmd;\n};\n\nstatic\nint spi_slave_system_control_submit(struct spi_slave_system_control_priv *priv);\n\nstatic void spi_slave_system_control_complete(void *arg)\n{\n\tstruct spi_slave_system_control_priv *priv = arg;\n\tu16 cmd;\n\tint ret;\n\n\tif (priv->msg.status)\n\t\tgoto terminate;\n\n\tcmd = be16_to_cpu(priv->cmd);\n\tswitch (cmd) {\n\tcase CMD_REBOOT:\n\t\tdev_info(&priv->spi->dev, \"Rebooting system...\\n\");\n\t\tkernel_restart(NULL);\n\t\tbreak;\n\n\tcase CMD_POWEROFF:\n\t\tdev_info(&priv->spi->dev, \"Powering off system...\\n\");\n\t\tkernel_power_off();\n\t\tbreak;\n\n\tcase CMD_HALT:\n\t\tdev_info(&priv->spi->dev, \"Halting system...\\n\");\n\t\tkernel_halt();\n\t\tbreak;\n\n\tcase CMD_SUSPEND:\n\t\tdev_info(&priv->spi->dev, \"Suspending system...\\n\");\n\t\tpm_suspend(PM_SUSPEND_MEM);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_warn(&priv->spi->dev, \"Unknown command 0x%x\\n\", cmd);\n\t\tbreak;\n\t}\n\n\tret = spi_slave_system_control_submit(priv);\n\tif (ret)\n\t\tgoto terminate;\n\n\treturn;\n\nterminate:\n\tdev_info(&priv->spi->dev, \"Terminating\\n\");\n\tcomplete(&priv->finished);\n}\n\nstatic\nint spi_slave_system_control_submit(struct spi_slave_system_control_priv *priv)\n{\n\tint ret;\n\n\tspi_message_init_with_transfers(&priv->msg, &priv->xfer, 1);\n\n\tpriv->msg.complete = spi_slave_system_control_complete;\n\tpriv->msg.context = priv;\n\n\tret = spi_async(priv->spi, &priv->msg);\n\tif (ret)\n\t\tdev_err(&priv->spi->dev, \"spi_async() failed %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int spi_slave_system_control_probe(struct spi_device *spi)\n{\n\tstruct spi_slave_system_control_priv *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(&spi->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->spi = spi;\n\tinit_completion(&priv->finished);\n\tpriv->xfer.rx_buf = &priv->cmd;\n\tpriv->xfer.len = sizeof(priv->cmd);\n\n\tret = spi_slave_system_control_submit(priv);\n\tif (ret)\n\t\treturn ret;\n\n\tspi_set_drvdata(spi, priv);\n\treturn 0;\n}\n\nstatic void spi_slave_system_control_remove(struct spi_device *spi)\n{\n\tstruct spi_slave_system_control_priv *priv = spi_get_drvdata(spi);\n\n\tspi_slave_abort(spi);\n\twait_for_completion(&priv->finished);\n}\n\nstatic struct spi_driver spi_slave_system_control_driver = {\n\t.driver = {\n\t\t.name\t= \"spi-slave-system-control\",\n\t},\n\t.probe\t\t= spi_slave_system_control_probe,\n\t.remove\t\t= spi_slave_system_control_remove,\n};\nmodule_spi_driver(spi_slave_system_control_driver);\n\nMODULE_AUTHOR(\"Geert Uytterhoeven <geert+renesas@glider.be>\");\nMODULE_DESCRIPTION(\"SPI slave handler controlling system state\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}