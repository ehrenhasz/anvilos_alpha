{
  "module_name": "spi-mt7621.c",
  "hash_id": "a49511becb7595dda13e11d15bcd042402efde066894d6d3bd865c2ac62b1aab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-mt7621.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/reset.h>\n#include <linux/spi/spi.h>\n\n#define DRIVER_NAME\t\t\"spi-mt7621\"\n\n \n#define RALINK_SPI_WAIT_MAX_LOOP 2000\n\n \n#define SPISTAT_BUSY\t\tBIT(0)\n\n#define MT7621_SPI_TRANS\t0x00\n#define SPITRANS_BUSY\t\tBIT(16)\n\n#define MT7621_SPI_OPCODE\t0x04\n#define MT7621_SPI_DATA0\t0x08\n#define MT7621_SPI_DATA4\t0x18\n#define SPI_CTL_TX_RX_CNT_MASK\t0xff\n#define SPI_CTL_START\t\tBIT(8)\n\n#define MT7621_SPI_MASTER\t0x28\n#define MASTER_MORE_BUFMODE\tBIT(2)\n#define MASTER_FULL_DUPLEX\tBIT(10)\n#define MASTER_RS_CLK_SEL\tGENMASK(27, 16)\n#define MASTER_RS_CLK_SEL_SHIFT\t16\n#define MASTER_RS_SLAVE_SEL\tGENMASK(31, 29)\n\n#define MT7621_SPI_MOREBUF\t0x2c\n#define MT7621_SPI_POLAR\t0x38\n#define MT7621_SPI_SPACE\t0x3c\n\n#define MT7621_CPHA\t\tBIT(5)\n#define MT7621_CPOL\t\tBIT(4)\n#define MT7621_LSB_FIRST\tBIT(3)\n\nstruct mt7621_spi {\n\tstruct spi_controller\t*master;\n\tvoid __iomem\t\t*base;\n\tunsigned int\t\tsys_freq;\n\tunsigned int\t\tspeed;\n\tint\t\t\tpending_write;\n};\n\nstatic inline struct mt7621_spi *spidev_to_mt7621_spi(struct spi_device *spi)\n{\n\treturn spi_controller_get_devdata(spi->master);\n}\n\nstatic inline u32 mt7621_spi_read(struct mt7621_spi *rs, u32 reg)\n{\n\treturn ioread32(rs->base + reg);\n}\n\nstatic inline void mt7621_spi_write(struct mt7621_spi *rs, u32 reg, u32 val)\n{\n\tiowrite32(val, rs->base + reg);\n}\n\nstatic void mt7621_spi_set_cs(struct spi_device *spi, int enable)\n{\n\tstruct mt7621_spi *rs = spidev_to_mt7621_spi(spi);\n\tint cs = spi_get_chipselect(spi, 0);\n\tu32 polar = 0;\n\tu32 master;\n\n\t \n\tmaster = mt7621_spi_read(rs, MT7621_SPI_MASTER);\n\tmaster |= MASTER_RS_SLAVE_SEL | MASTER_MORE_BUFMODE;\n\tmaster &= ~MASTER_FULL_DUPLEX;\n\tmt7621_spi_write(rs, MT7621_SPI_MASTER, master);\n\n\trs->pending_write = 0;\n\n\tif (enable)\n\t\tpolar = BIT(cs);\n\tmt7621_spi_write(rs, MT7621_SPI_POLAR, polar);\n}\n\nstatic int mt7621_spi_prepare(struct spi_device *spi, unsigned int speed)\n{\n\tstruct mt7621_spi *rs = spidev_to_mt7621_spi(spi);\n\tu32 rate;\n\tu32 reg;\n\n\tdev_dbg(&spi->dev, \"speed:%u\\n\", speed);\n\n\trate = DIV_ROUND_UP(rs->sys_freq, speed);\n\tdev_dbg(&spi->dev, \"rate-1:%u\\n\", rate);\n\n\tif (rate > 4097)\n\t\treturn -EINVAL;\n\n\tif (rate < 2)\n\t\trate = 2;\n\n\treg = mt7621_spi_read(rs, MT7621_SPI_MASTER);\n\treg &= ~MASTER_RS_CLK_SEL;\n\treg |= (rate - 2) << MASTER_RS_CLK_SEL_SHIFT;\n\trs->speed = speed;\n\n\treg &= ~MT7621_LSB_FIRST;\n\tif (spi->mode & SPI_LSB_FIRST)\n\t\treg |= MT7621_LSB_FIRST;\n\n\t \n\treg &= ~(MT7621_CPHA | MT7621_CPOL);\n\n\tmt7621_spi_write(rs, MT7621_SPI_MASTER, reg);\n\n\treturn 0;\n}\n\nstatic inline int mt7621_spi_wait_till_ready(struct mt7621_spi *rs)\n{\n\tint i;\n\n\tfor (i = 0; i < RALINK_SPI_WAIT_MAX_LOOP; i++) {\n\t\tu32 status;\n\n\t\tstatus = mt7621_spi_read(rs, MT7621_SPI_TRANS);\n\t\tif ((status & SPITRANS_BUSY) == 0)\n\t\t\treturn 0;\n\t\tcpu_relax();\n\t\tudelay(1);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nstatic void mt7621_spi_read_half_duplex(struct mt7621_spi *rs,\n\t\t\t\t\tint rx_len, u8 *buf)\n{\n\tint tx_len;\n\n\t \n\ttx_len = rs->pending_write;\n\trs->pending_write = 0;\n\n\twhile (rx_len || tx_len) {\n\t\tint i;\n\t\tu32 val = (min(tx_len, 4) * 8) << 24;\n\t\tint rx = min(rx_len, 32);\n\n\t\tif (tx_len > 4)\n\t\t\tval |= (tx_len - 4) * 8;\n\t\tval |= (rx * 8) << 12;\n\t\tmt7621_spi_write(rs, MT7621_SPI_MOREBUF, val);\n\n\t\ttx_len = 0;\n\n\t\tval = mt7621_spi_read(rs, MT7621_SPI_TRANS);\n\t\tval |= SPI_CTL_START;\n\t\tmt7621_spi_write(rs, MT7621_SPI_TRANS, val);\n\n\t\tmt7621_spi_wait_till_ready(rs);\n\n\t\tfor (i = 0; i < rx; i++) {\n\t\t\tif ((i % 4) == 0)\n\t\t\t\tval = mt7621_spi_read(rs, MT7621_SPI_DATA0 + i);\n\t\t\t*buf++ = val & 0xff;\n\t\t\tval >>= 8;\n\t\t}\n\n\t\trx_len -= i;\n\t}\n}\n\nstatic inline void mt7621_spi_flush(struct mt7621_spi *rs)\n{\n\tmt7621_spi_read_half_duplex(rs, 0, NULL);\n}\n\nstatic void mt7621_spi_write_half_duplex(struct mt7621_spi *rs,\n\t\t\t\t\t int tx_len, const u8 *buf)\n{\n\tint len = rs->pending_write;\n\tint val = 0;\n\n\tif (len & 3) {\n\t\tval = mt7621_spi_read(rs, MT7621_SPI_OPCODE + (len & ~3));\n\t\tif (len < 4) {\n\t\t\tval <<= (4 - len) * 8;\n\t\t\tval = swab32(val);\n\t\t}\n\t}\n\n\twhile (tx_len > 0) {\n\t\tif (len >= 36) {\n\t\t\trs->pending_write = len;\n\t\t\tmt7621_spi_flush(rs);\n\t\t\tlen = 0;\n\t\t}\n\n\t\tval |= *buf++ << (8 * (len & 3));\n\t\tlen++;\n\t\tif ((len & 3) == 0) {\n\t\t\tif (len == 4)\n\t\t\t\t \n\t\t\t\tval = swab32(val);\n\t\t\tmt7621_spi_write(rs, MT7621_SPI_OPCODE + len - 4, val);\n\t\t\tval = 0;\n\t\t}\n\t\ttx_len -= 1;\n\t}\n\n\tif (len & 3) {\n\t\tif (len < 4) {\n\t\t\tval = swab32(val);\n\t\t\tval >>= (4 - len) * 8;\n\t\t}\n\t\tmt7621_spi_write(rs, MT7621_SPI_OPCODE + (len & ~3), val);\n\t}\n\n\trs->pending_write = len;\n}\n\nstatic int mt7621_spi_transfer_one_message(struct spi_controller *master,\n\t\t\t\t\t   struct spi_message *m)\n{\n\tstruct mt7621_spi *rs = spi_controller_get_devdata(master);\n\tstruct spi_device *spi = m->spi;\n\tunsigned int speed = spi->max_speed_hz;\n\tstruct spi_transfer *t = NULL;\n\tint status = 0;\n\n\tmt7621_spi_wait_till_ready(rs);\n\n\tlist_for_each_entry(t, &m->transfers, transfer_list)\n\t\tif (t->speed_hz < speed)\n\t\t\tspeed = t->speed_hz;\n\n\tif (mt7621_spi_prepare(spi, speed)) {\n\t\tstatus = -EIO;\n\t\tgoto msg_done;\n\t}\n\n\t \n\tmt7621_spi_set_cs(spi, 1);\n\n\tm->actual_length = 0;\n\tlist_for_each_entry(t, &m->transfers, transfer_list) {\n\t\tif ((t->rx_buf) && (t->tx_buf)) {\n\t\t\t \n\t\t\tstatus = -EIO;\n\t\t\tgoto msg_done;\n\t\t} else if (t->rx_buf) {\n\t\t\tmt7621_spi_read_half_duplex(rs, t->len, t->rx_buf);\n\t\t} else if (t->tx_buf) {\n\t\t\tmt7621_spi_write_half_duplex(rs, t->len, t->tx_buf);\n\t\t}\n\t\tm->actual_length += t->len;\n\t}\n\n\t \n\tmt7621_spi_flush(rs);\n\tmt7621_spi_set_cs(spi, 0);\n\nmsg_done:\n\tm->status = status;\n\tspi_finalize_current_message(master);\n\n\treturn 0;\n}\n\nstatic int mt7621_spi_setup(struct spi_device *spi)\n{\n\tstruct mt7621_spi *rs = spidev_to_mt7621_spi(spi);\n\n\tif ((spi->max_speed_hz == 0) ||\n\t    (spi->max_speed_hz > (rs->sys_freq / 2)))\n\t\tspi->max_speed_hz = rs->sys_freq / 2;\n\n\tif (spi->max_speed_hz < (rs->sys_freq / 4097)) {\n\t\tdev_err(&spi->dev, \"setup: requested speed is too low %d Hz\\n\",\n\t\t\tspi->max_speed_hz);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id mt7621_spi_match[] = {\n\t{ .compatible = \"ralink,mt7621-spi\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mt7621_spi_match);\n\nstatic int mt7621_spi_probe(struct platform_device *pdev)\n{\n\tconst struct of_device_id *match;\n\tstruct spi_controller *master;\n\tstruct mt7621_spi *rs;\n\tvoid __iomem *base;\n\tstruct clk *clk;\n\tint ret;\n\n\tmatch = of_match_device(mt7621_spi_match, &pdev->dev);\n\tif (!match)\n\t\treturn -EINVAL;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tclk = devm_clk_get_enabled(&pdev->dev, NULL);\n\tif (IS_ERR(clk))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(clk),\n\t\t\t\t     \"unable to get SYS clock\\n\");\n\n\tmaster = devm_spi_alloc_master(&pdev->dev, sizeof(*rs));\n\tif (!master) {\n\t\tdev_info(&pdev->dev, \"master allocation failed\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tmaster->mode_bits = SPI_LSB_FIRST;\n\tmaster->flags = SPI_CONTROLLER_HALF_DUPLEX;\n\tmaster->setup = mt7621_spi_setup;\n\tmaster->transfer_one_message = mt7621_spi_transfer_one_message;\n\tmaster->bits_per_word_mask = SPI_BPW_MASK(8);\n\tmaster->dev.of_node = pdev->dev.of_node;\n\tmaster->num_chipselect = 2;\n\n\tdev_set_drvdata(&pdev->dev, master);\n\n\trs = spi_controller_get_devdata(master);\n\trs->base = base;\n\trs->master = master;\n\trs->sys_freq = clk_get_rate(clk);\n\trs->pending_write = 0;\n\tdev_info(&pdev->dev, \"sys_freq: %u\\n\", rs->sys_freq);\n\n\tret = device_reset(&pdev->dev);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"SPI reset failed!\\n\");\n\t\treturn ret;\n\t}\n\n\treturn devm_spi_register_controller(&pdev->dev, master);\n}\n\nMODULE_ALIAS(\"platform:\" DRIVER_NAME);\n\nstatic struct platform_driver mt7621_spi_driver = {\n\t.driver = {\n\t\t.name = DRIVER_NAME,\n\t\t.of_match_table = mt7621_spi_match,\n\t},\n\t.probe = mt7621_spi_probe,\n};\n\nmodule_platform_driver(mt7621_spi_driver);\n\nMODULE_DESCRIPTION(\"MT7621 SPI driver\");\nMODULE_AUTHOR(\"Felix Fietkau <nbd@nbd.name>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}