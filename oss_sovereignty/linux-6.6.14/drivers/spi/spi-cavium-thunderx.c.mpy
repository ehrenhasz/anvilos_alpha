{
  "module_name": "spi-cavium-thunderx.c",
  "hash_id": "c16bf8adfd67808742e874164f06ed9a87652ea46cb5653c10e67e0cd9936864",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-cavium-thunderx.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/spi/spi.h>\n\n#include \"spi-cavium.h\"\n\n#define DRV_NAME \"spi-thunderx\"\n\n#define SYS_FREQ_DEFAULT 700000000  \n\nstatic int thunderx_spi_probe(struct pci_dev *pdev,\n\t\t\t      const struct pci_device_id *ent)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct spi_controller *host;\n\tstruct octeon_spi *p;\n\tint ret;\n\n\thost = spi_alloc_host(dev, sizeof(struct octeon_spi));\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\tp = spi_controller_get_devdata(host);\n\n\tret = pcim_enable_device(pdev);\n\tif (ret)\n\t\tgoto error;\n\n\tret = pci_request_regions(pdev, DRV_NAME);\n\tif (ret)\n\t\tgoto error;\n\n\tp->register_base = pcim_iomap(pdev, 0, pci_resource_len(pdev, 0));\n\tif (!p->register_base) {\n\t\tret = -EINVAL;\n\t\tgoto error;\n\t}\n\n\tp->regs.config = 0x1000;\n\tp->regs.status = 0x1008;\n\tp->regs.tx = 0x1010;\n\tp->regs.data = 0x1080;\n\n\tp->clk = devm_clk_get(dev, NULL);\n\tif (IS_ERR(p->clk)) {\n\t\tret = PTR_ERR(p->clk);\n\t\tgoto error;\n\t}\n\n\tret = clk_prepare_enable(p->clk);\n\tif (ret)\n\t\tgoto error;\n\n\tp->sys_freq = clk_get_rate(p->clk);\n\tif (!p->sys_freq)\n\t\tp->sys_freq = SYS_FREQ_DEFAULT;\n\tdev_info(dev, \"Set system clock to %u\\n\", p->sys_freq);\n\n\thost->flags = SPI_CONTROLLER_HALF_DUPLEX;\n\thost->num_chipselect = 4;\n\thost->mode_bits = SPI_CPHA | SPI_CPOL | SPI_CS_HIGH |\n\t\t\t    SPI_LSB_FIRST | SPI_3WIRE;\n\thost->transfer_one_message = octeon_spi_transfer_one_message;\n\thost->bits_per_word_mask = SPI_BPW_MASK(8);\n\thost->max_speed_hz = OCTEON_SPI_MAX_CLOCK_HZ;\n\thost->dev.of_node = pdev->dev.of_node;\n\n\tpci_set_drvdata(pdev, host);\n\n\tret = devm_spi_register_controller(dev, host);\n\tif (ret)\n\t\tgoto error;\n\n\treturn 0;\n\nerror:\n\tclk_disable_unprepare(p->clk);\n\tpci_release_regions(pdev);\n\tspi_controller_put(host);\n\treturn ret;\n}\n\nstatic void thunderx_spi_remove(struct pci_dev *pdev)\n{\n\tstruct spi_controller *host = pci_get_drvdata(pdev);\n\tstruct octeon_spi *p;\n\n\tp = spi_controller_get_devdata(host);\n\tif (!p)\n\t\treturn;\n\n\tclk_disable_unprepare(p->clk);\n\tpci_release_regions(pdev);\n\t \n\twriteq(0, p->register_base + OCTEON_SPI_CFG(p));\n}\n\nstatic const struct pci_device_id thunderx_spi_pci_id_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_CAVIUM, 0xa00b) },\n\t{ 0, }\n};\n\nMODULE_DEVICE_TABLE(pci, thunderx_spi_pci_id_table);\n\nstatic struct pci_driver thunderx_spi_driver = {\n\t.name\t\t= DRV_NAME,\n\t.id_table\t= thunderx_spi_pci_id_table,\n\t.probe\t\t= thunderx_spi_probe,\n\t.remove\t\t= thunderx_spi_remove,\n};\n\nmodule_pci_driver(thunderx_spi_driver);\n\nMODULE_DESCRIPTION(\"Cavium, Inc. ThunderX SPI bus driver\");\nMODULE_AUTHOR(\"Jan Glauber\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}