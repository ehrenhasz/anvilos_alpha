{
  "module_name": "spi-slave-time.c",
  "hash_id": "b1c96bc032acb8edbe68fa67f2646b906c8b316121b8c08253f861c16ba5c9ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-slave-time.c",
  "human_readable_source": " \n\n#include <linux/completion.h>\n#include <linux/module.h>\n#include <linux/sched/clock.h>\n#include <linux/spi/spi.h>\n\n\nstruct spi_slave_time_priv {\n\tstruct spi_device *spi;\n\tstruct completion finished;\n\tstruct spi_transfer xfer;\n\tstruct spi_message msg;\n\t__be32 buf[2];\n};\n\nstatic int spi_slave_time_submit(struct spi_slave_time_priv *priv);\n\nstatic void spi_slave_time_complete(void *arg)\n{\n\tstruct spi_slave_time_priv *priv = arg;\n\tint ret;\n\n\tret = priv->msg.status;\n\tif (ret)\n\t\tgoto terminate;\n\n\tret = spi_slave_time_submit(priv);\n\tif (ret)\n\t\tgoto terminate;\n\n\treturn;\n\nterminate:\n\tdev_info(&priv->spi->dev, \"Terminating\\n\");\n\tcomplete(&priv->finished);\n}\n\nstatic int spi_slave_time_submit(struct spi_slave_time_priv *priv)\n{\n\tu32 rem_us;\n\tint ret;\n\tu64 ts;\n\n\tts = local_clock();\n\trem_us = do_div(ts, 1000000000) / 1000;\n\n\tpriv->buf[0] = cpu_to_be32(ts);\n\tpriv->buf[1] = cpu_to_be32(rem_us);\n\n\tspi_message_init_with_transfers(&priv->msg, &priv->xfer, 1);\n\n\tpriv->msg.complete = spi_slave_time_complete;\n\tpriv->msg.context = priv;\n\n\tret = spi_async(priv->spi, &priv->msg);\n\tif (ret)\n\t\tdev_err(&priv->spi->dev, \"spi_async() failed %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int spi_slave_time_probe(struct spi_device *spi)\n{\n\tstruct spi_slave_time_priv *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(&spi->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->spi = spi;\n\tinit_completion(&priv->finished);\n\tpriv->xfer.tx_buf = priv->buf;\n\tpriv->xfer.len = sizeof(priv->buf);\n\n\tret = spi_slave_time_submit(priv);\n\tif (ret)\n\t\treturn ret;\n\n\tspi_set_drvdata(spi, priv);\n\treturn 0;\n}\n\nstatic void spi_slave_time_remove(struct spi_device *spi)\n{\n\tstruct spi_slave_time_priv *priv = spi_get_drvdata(spi);\n\n\tspi_slave_abort(spi);\n\twait_for_completion(&priv->finished);\n}\n\nstatic struct spi_driver spi_slave_time_driver = {\n\t.driver = {\n\t\t.name\t= \"spi-slave-time\",\n\t},\n\t.probe\t\t= spi_slave_time_probe,\n\t.remove\t\t= spi_slave_time_remove,\n};\nmodule_spi_driver(spi_slave_time_driver);\n\nMODULE_AUTHOR(\"Geert Uytterhoeven <geert+renesas@glider.be>\");\nMODULE_DESCRIPTION(\"SPI slave reporting uptime at previous SPI message\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}