{
  "module_name": "spi-lantiq-ssc.c",
  "hash_id": "a5a94d4f3e698ed1ca06ffced2fe5a0753a1f084fa09a93d0a2dbfcd547a010f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-lantiq-ssc.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/sched.h>\n#include <linux/completion.h>\n#include <linux/spinlock.h>\n#include <linux/err.h>\n#include <linux/pm_runtime.h>\n#include <linux/spi/spi.h>\n\n#ifdef CONFIG_LANTIQ\n#include <lantiq_soc.h>\n#endif\n\n#define LTQ_SPI_RX_IRQ_NAME\t\"spi_rx\"\n#define LTQ_SPI_TX_IRQ_NAME\t\"spi_tx\"\n#define LTQ_SPI_ERR_IRQ_NAME\t\"spi_err\"\n#define LTQ_SPI_FRM_IRQ_NAME\t\"spi_frm\"\n\n#define LTQ_SPI_CLC\t\t0x00\n#define LTQ_SPI_PISEL\t\t0x04\n#define LTQ_SPI_ID\t\t0x08\n#define LTQ_SPI_CON\t\t0x10\n#define LTQ_SPI_STAT\t\t0x14\n#define LTQ_SPI_WHBSTATE\t0x18\n#define LTQ_SPI_TB\t\t0x20\n#define LTQ_SPI_RB\t\t0x24\n#define LTQ_SPI_RXFCON\t\t0x30\n#define LTQ_SPI_TXFCON\t\t0x34\n#define LTQ_SPI_FSTAT\t\t0x38\n#define LTQ_SPI_BRT\t\t0x40\n#define LTQ_SPI_BRSTAT\t\t0x44\n#define LTQ_SPI_SFCON\t\t0x60\n#define LTQ_SPI_SFSTAT\t\t0x64\n#define LTQ_SPI_GPOCON\t\t0x70\n#define LTQ_SPI_GPOSTAT\t\t0x74\n#define LTQ_SPI_FPGO\t\t0x78\n#define LTQ_SPI_RXREQ\t\t0x80\n#define LTQ_SPI_RXCNT\t\t0x84\n#define LTQ_SPI_DMACON\t\t0xec\n#define LTQ_SPI_IRNEN\t\t0xf4\n\n#define LTQ_SPI_CLC_SMC_S\t16\t \n#define LTQ_SPI_CLC_SMC_M\t(0xFF << LTQ_SPI_CLC_SMC_S)\n#define LTQ_SPI_CLC_RMC_S\t8\t \n#define LTQ_SPI_CLC_RMC_M\t(0xFF << LTQ_SPI_CLC_RMC_S)\n#define LTQ_SPI_CLC_DISS\tBIT(1)\t \n#define LTQ_SPI_CLC_DISR\tBIT(0)\t \n\n#define LTQ_SPI_ID_TXFS_S\t24\t \n#define LTQ_SPI_ID_RXFS_S\t16\t \n#define LTQ_SPI_ID_MOD_S\t8\t \n#define LTQ_SPI_ID_MOD_M\t(0xff << LTQ_SPI_ID_MOD_S)\n#define LTQ_SPI_ID_CFG_S\t5\t \n#define LTQ_SPI_ID_CFG_M\t(1 << LTQ_SPI_ID_CFG_S)\n#define LTQ_SPI_ID_REV_M\t0x1F\t \n\n#define LTQ_SPI_CON_BM_S\t16\t \n#define LTQ_SPI_CON_BM_M\t(0x1F << LTQ_SPI_CON_BM_S)\n#define LTQ_SPI_CON_EM\t\tBIT(24)\t \n#define LTQ_SPI_CON_IDLE\tBIT(23)\t \n#define LTQ_SPI_CON_ENBV\tBIT(22)\t \n#define LTQ_SPI_CON_RUEN\tBIT(12)\t \n#define LTQ_SPI_CON_TUEN\tBIT(11)\t \n#define LTQ_SPI_CON_AEN\t\tBIT(10)\t \n#define LTQ_SPI_CON_REN\t\tBIT(9)\t \n#define LTQ_SPI_CON_TEN\t\tBIT(8)\t \n#define LTQ_SPI_CON_LB\t\tBIT(7)\t \n#define LTQ_SPI_CON_PO\t\tBIT(6)\t \n#define LTQ_SPI_CON_PH\t\tBIT(5)\t \n#define LTQ_SPI_CON_HB\t\tBIT(4)\t \n#define LTQ_SPI_CON_RXOFF\tBIT(1)\t \n#define LTQ_SPI_CON_TXOFF\tBIT(0)\t \n\n#define LTQ_SPI_STAT_RXBV_S\t28\n#define LTQ_SPI_STAT_RXBV_M\t(0x7 << LTQ_SPI_STAT_RXBV_S)\n#define LTQ_SPI_STAT_BSY\tBIT(13)\t \n#define LTQ_SPI_STAT_RUE\tBIT(12)\t \n#define LTQ_SPI_STAT_TUE\tBIT(11)\t \n#define LTQ_SPI_STAT_AE\t\tBIT(10)\t \n#define LTQ_SPI_STAT_RE\t\tBIT(9)\t \n#define LTQ_SPI_STAT_TE\t\tBIT(8)\t \n#define LTQ_SPI_STAT_ME\t\tBIT(7)\t \n#define LTQ_SPI_STAT_MS\t\tBIT(1)\t \n#define LTQ_SPI_STAT_EN\t\tBIT(0)\t \n#define LTQ_SPI_STAT_ERRORS\t(LTQ_SPI_STAT_ME | LTQ_SPI_STAT_TE | \\\n\t\t\t\t LTQ_SPI_STAT_RE | LTQ_SPI_STAT_AE | \\\n\t\t\t\t LTQ_SPI_STAT_TUE | LTQ_SPI_STAT_RUE)\n\n#define LTQ_SPI_WHBSTATE_SETTUE\tBIT(15)\t \n#define LTQ_SPI_WHBSTATE_SETAE\tBIT(14)\t \n#define LTQ_SPI_WHBSTATE_SETRE\tBIT(13)\t \n#define LTQ_SPI_WHBSTATE_SETTE\tBIT(12)\t \n#define LTQ_SPI_WHBSTATE_CLRTUE\tBIT(11)\t \n#define LTQ_SPI_WHBSTATE_CLRAE\tBIT(10)\t \n#define LTQ_SPI_WHBSTATE_CLRRE\tBIT(9)\t \n#define LTQ_SPI_WHBSTATE_CLRTE\tBIT(8)\t \n#define LTQ_SPI_WHBSTATE_SETME\tBIT(7)\t \n#define LTQ_SPI_WHBSTATE_CLRME\tBIT(6)\t \n#define LTQ_SPI_WHBSTATE_SETRUE\tBIT(5)\t \n#define LTQ_SPI_WHBSTATE_CLRRUE\tBIT(4)\t \n#define LTQ_SPI_WHBSTATE_SETMS\tBIT(3)\t \n#define LTQ_SPI_WHBSTATE_CLRMS\tBIT(2)\t \n#define LTQ_SPI_WHBSTATE_SETEN\tBIT(1)\t \n#define LTQ_SPI_WHBSTATE_CLREN\tBIT(0)\t \n#define LTQ_SPI_WHBSTATE_CLR_ERRORS\t(LTQ_SPI_WHBSTATE_CLRRUE | \\\n\t\t\t\t\t LTQ_SPI_WHBSTATE_CLRME | \\\n\t\t\t\t\t LTQ_SPI_WHBSTATE_CLRTE | \\\n\t\t\t\t\t LTQ_SPI_WHBSTATE_CLRRE | \\\n\t\t\t\t\t LTQ_SPI_WHBSTATE_CLRAE | \\\n\t\t\t\t\t LTQ_SPI_WHBSTATE_CLRTUE)\n\n#define LTQ_SPI_RXFCON_RXFITL_S\t8\t \n#define LTQ_SPI_RXFCON_RXFLU\tBIT(1)\t \n#define LTQ_SPI_RXFCON_RXFEN\tBIT(0)\t \n\n#define LTQ_SPI_TXFCON_TXFITL_S\t8\t \n#define LTQ_SPI_TXFCON_TXFLU\tBIT(1)\t \n#define LTQ_SPI_TXFCON_TXFEN\tBIT(0)\t \n\n#define LTQ_SPI_FSTAT_RXFFL_S\t0\n#define LTQ_SPI_FSTAT_TXFFL_S\t8\n\n#define LTQ_SPI_GPOCON_ISCSBN_S\t8\n#define LTQ_SPI_GPOCON_INVOUTN_S\t0\n\n#define LTQ_SPI_FGPO_SETOUTN_S\t8\n#define LTQ_SPI_FGPO_CLROUTN_S\t0\n\n#define LTQ_SPI_RXREQ_RXCNT_M\t0xFFFF\t \n#define LTQ_SPI_RXCNT_TODO_M\t0xFFFF\t \n\n#define LTQ_SPI_IRNEN_TFI\tBIT(4)\t \n#define LTQ_SPI_IRNEN_F\t\tBIT(3)\t \n#define LTQ_SPI_IRNEN_E\t\tBIT(2)\t \n#define LTQ_SPI_IRNEN_T_XWAY\tBIT(1)\t \n#define LTQ_SPI_IRNEN_R_XWAY\tBIT(0)\t \n#define LTQ_SPI_IRNEN_R_XRX\tBIT(1)\t \n#define LTQ_SPI_IRNEN_T_XRX\tBIT(0)\t \n#define LTQ_SPI_IRNEN_ALL\t0x1F\n\nstruct lantiq_ssc_spi;\n\nstruct lantiq_ssc_hwcfg {\n\tint (*cfg_irq)(struct platform_device *pdev, struct lantiq_ssc_spi *spi);\n\tunsigned int\tirnen_r;\n\tunsigned int\tirnen_t;\n\tunsigned int\tirncr;\n\tunsigned int\tirnicr;\n\tbool\t\tirq_ack;\n\tu32\t\tfifo_size_mask;\n};\n\nstruct lantiq_ssc_spi {\n\tstruct spi_controller\t\t*host;\n\tstruct device\t\t\t*dev;\n\tvoid __iomem\t\t\t*regbase;\n\tstruct clk\t\t\t*spi_clk;\n\tstruct clk\t\t\t*fpi_clk;\n\tconst struct lantiq_ssc_hwcfg\t*hwcfg;\n\n\tspinlock_t\t\t\tlock;\n\tstruct workqueue_struct\t\t*wq;\n\tstruct work_struct\t\twork;\n\n\tconst u8\t\t\t*tx;\n\tu8\t\t\t\t*rx;\n\tunsigned int\t\t\ttx_todo;\n\tunsigned int\t\t\trx_todo;\n\tunsigned int\t\t\tbits_per_word;\n\tunsigned int\t\t\tspeed_hz;\n\tunsigned int\t\t\ttx_fifo_size;\n\tunsigned int\t\t\trx_fifo_size;\n\tunsigned int\t\t\tbase_cs;\n\tunsigned int\t\t\tfdx_tx_level;\n};\n\nstatic u32 lantiq_ssc_readl(const struct lantiq_ssc_spi *spi, u32 reg)\n{\n\treturn __raw_readl(spi->regbase + reg);\n}\n\nstatic void lantiq_ssc_writel(const struct lantiq_ssc_spi *spi, u32 val,\n\t\t\t      u32 reg)\n{\n\t__raw_writel(val, spi->regbase + reg);\n}\n\nstatic void lantiq_ssc_maskl(const struct lantiq_ssc_spi *spi, u32 clr,\n\t\t\t     u32 set, u32 reg)\n{\n\tu32 val = __raw_readl(spi->regbase + reg);\n\n\tval &= ~clr;\n\tval |= set;\n\t__raw_writel(val, spi->regbase + reg);\n}\n\nstatic unsigned int tx_fifo_level(const struct lantiq_ssc_spi *spi)\n{\n\tconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\n\tu32 fstat = lantiq_ssc_readl(spi, LTQ_SPI_FSTAT);\n\n\treturn (fstat >> LTQ_SPI_FSTAT_TXFFL_S) & hwcfg->fifo_size_mask;\n}\n\nstatic unsigned int rx_fifo_level(const struct lantiq_ssc_spi *spi)\n{\n\tconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\n\tu32 fstat = lantiq_ssc_readl(spi, LTQ_SPI_FSTAT);\n\n\treturn (fstat >> LTQ_SPI_FSTAT_RXFFL_S) & hwcfg->fifo_size_mask;\n}\n\nstatic unsigned int tx_fifo_free(const struct lantiq_ssc_spi *spi)\n{\n\treturn spi->tx_fifo_size - tx_fifo_level(spi);\n}\n\nstatic void rx_fifo_reset(const struct lantiq_ssc_spi *spi)\n{\n\tu32 val = spi->rx_fifo_size << LTQ_SPI_RXFCON_RXFITL_S;\n\n\tval |= LTQ_SPI_RXFCON_RXFEN | LTQ_SPI_RXFCON_RXFLU;\n\tlantiq_ssc_writel(spi, val, LTQ_SPI_RXFCON);\n}\n\nstatic void tx_fifo_reset(const struct lantiq_ssc_spi *spi)\n{\n\tu32 val = 1 << LTQ_SPI_TXFCON_TXFITL_S;\n\n\tval |= LTQ_SPI_TXFCON_TXFEN | LTQ_SPI_TXFCON_TXFLU;\n\tlantiq_ssc_writel(spi, val, LTQ_SPI_TXFCON);\n}\n\nstatic void rx_fifo_flush(const struct lantiq_ssc_spi *spi)\n{\n\tlantiq_ssc_maskl(spi, 0, LTQ_SPI_RXFCON_RXFLU, LTQ_SPI_RXFCON);\n}\n\nstatic void tx_fifo_flush(const struct lantiq_ssc_spi *spi)\n{\n\tlantiq_ssc_maskl(spi, 0, LTQ_SPI_TXFCON_TXFLU, LTQ_SPI_TXFCON);\n}\n\nstatic void hw_enter_config_mode(const struct lantiq_ssc_spi *spi)\n{\n\tlantiq_ssc_writel(spi, LTQ_SPI_WHBSTATE_CLREN, LTQ_SPI_WHBSTATE);\n}\n\nstatic void hw_enter_active_mode(const struct lantiq_ssc_spi *spi)\n{\n\tlantiq_ssc_writel(spi, LTQ_SPI_WHBSTATE_SETEN, LTQ_SPI_WHBSTATE);\n}\n\nstatic void hw_setup_speed_hz(const struct lantiq_ssc_spi *spi,\n\t\t\t      unsigned int max_speed_hz)\n{\n\tu32 spi_clk, brt;\n\n\t \n\tspi_clk = clk_get_rate(spi->fpi_clk) / 2;\n\n\tif (max_speed_hz > spi_clk)\n\t\tbrt = 0;\n\telse\n\t\tbrt = spi_clk / max_speed_hz - 1;\n\n\tif (brt > 0xFFFF)\n\t\tbrt = 0xFFFF;\n\n\tdev_dbg(spi->dev, \"spi_clk %u, max_speed_hz %u, brt %u\\n\",\n\t\tspi_clk, max_speed_hz, brt);\n\n\tlantiq_ssc_writel(spi, brt, LTQ_SPI_BRT);\n}\n\nstatic void hw_setup_bits_per_word(const struct lantiq_ssc_spi *spi,\n\t\t\t\t   unsigned int bits_per_word)\n{\n\tu32 bm;\n\n\t \n\tbm = (bits_per_word - 1) << LTQ_SPI_CON_BM_S;\n\n\tlantiq_ssc_maskl(spi, LTQ_SPI_CON_BM_M, bm, LTQ_SPI_CON);\n}\n\nstatic void hw_setup_clock_mode(const struct lantiq_ssc_spi *spi,\n\t\t\t\tunsigned int mode)\n{\n\tu32 con_set = 0, con_clr = 0;\n\n\t \n\tif (mode & SPI_CPHA)\n\t\tcon_clr |= LTQ_SPI_CON_PH;\n\telse\n\t\tcon_set |= LTQ_SPI_CON_PH;\n\n\tif (mode & SPI_CPOL)\n\t\tcon_set |= LTQ_SPI_CON_PO | LTQ_SPI_CON_IDLE;\n\telse\n\t\tcon_clr |= LTQ_SPI_CON_PO | LTQ_SPI_CON_IDLE;\n\n\t \n\tif (mode & SPI_LSB_FIRST)\n\t\tcon_clr |= LTQ_SPI_CON_HB;\n\telse\n\t\tcon_set |= LTQ_SPI_CON_HB;\n\n\t \n\tif (mode & SPI_LOOP)\n\t\tcon_set |= LTQ_SPI_CON_LB;\n\telse\n\t\tcon_clr |= LTQ_SPI_CON_LB;\n\n\tlantiq_ssc_maskl(spi, con_clr, con_set, LTQ_SPI_CON);\n}\n\nstatic void lantiq_ssc_hw_init(const struct lantiq_ssc_spi *spi)\n{\n\tconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\n\n\t \n\tlantiq_ssc_writel(spi, 1 << LTQ_SPI_CLC_RMC_S, LTQ_SPI_CLC);\n\n\t \n\thw_enter_config_mode(spi);\n\n\t \n\tlantiq_ssc_maskl(spi, 0, LTQ_SPI_WHBSTATE_CLR_ERRORS, LTQ_SPI_WHBSTATE);\n\n\t \n\tlantiq_ssc_writel(spi, LTQ_SPI_CON_RUEN | LTQ_SPI_CON_AEN |\n\t\tLTQ_SPI_CON_TEN | LTQ_SPI_CON_REN | LTQ_SPI_CON_TXOFF |\n\t\tLTQ_SPI_CON_RXOFF, LTQ_SPI_CON);\n\n\t \n\thw_setup_bits_per_word(spi, spi->bits_per_word);\n\thw_setup_clock_mode(spi, SPI_MODE_0);\n\n\t \n\tlantiq_ssc_writel(spi, LTQ_SPI_WHBSTATE_SETMS |\n\t\t\t       LTQ_SPI_WHBSTATE_CLR_ERRORS,\n\t\t\t       LTQ_SPI_WHBSTATE);\n\n\t \n\tlantiq_ssc_writel(spi, 0, LTQ_SPI_GPOCON);\n\tlantiq_ssc_writel(spi, 0xFF00, LTQ_SPI_FPGO);\n\n\t \n\trx_fifo_reset(spi);\n\ttx_fifo_reset(spi);\n\n\t \n\tlantiq_ssc_writel(spi, hwcfg->irnen_t | hwcfg->irnen_r |\n\t\t\t  LTQ_SPI_IRNEN_E, LTQ_SPI_IRNEN);\n}\n\nstatic int lantiq_ssc_setup(struct spi_device *spidev)\n{\n\tstruct spi_controller *host = spidev->controller;\n\tstruct lantiq_ssc_spi *spi = spi_controller_get_devdata(host);\n\tunsigned int cs = spi_get_chipselect(spidev, 0);\n\tu32 gpocon;\n\n\t \n\tif (spi_get_csgpiod(spidev, 0))\n\t\treturn 0;\n\n\tdev_dbg(spi->dev, \"using internal chipselect %u\\n\", cs);\n\n\tif (cs < spi->base_cs) {\n\t\tdev_err(spi->dev,\n\t\t\t\"chipselect %i too small (min %i)\\n\", cs, spi->base_cs);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tgpocon = 1 << ((cs - spi->base_cs) + LTQ_SPI_GPOCON_ISCSBN_S);\n\n\t \n\tif (spidev->mode & SPI_CS_HIGH)\n\t\tgpocon |= 1 << (cs - spi->base_cs);\n\n\tlantiq_ssc_maskl(spi, 0, gpocon, LTQ_SPI_GPOCON);\n\n\treturn 0;\n}\n\nstatic int lantiq_ssc_prepare_message(struct spi_controller *host,\n\t\t\t\t      struct spi_message *message)\n{\n\tstruct lantiq_ssc_spi *spi = spi_controller_get_devdata(host);\n\n\thw_enter_config_mode(spi);\n\thw_setup_clock_mode(spi, message->spi->mode);\n\thw_enter_active_mode(spi);\n\n\treturn 0;\n}\n\nstatic void hw_setup_transfer(struct lantiq_ssc_spi *spi,\n\t\t\t      struct spi_device *spidev, struct spi_transfer *t)\n{\n\tunsigned int speed_hz = t->speed_hz;\n\tunsigned int bits_per_word = t->bits_per_word;\n\tu32 con;\n\n\tif (bits_per_word != spi->bits_per_word ||\n\t\tspeed_hz != spi->speed_hz) {\n\t\thw_enter_config_mode(spi);\n\t\thw_setup_speed_hz(spi, speed_hz);\n\t\thw_setup_bits_per_word(spi, bits_per_word);\n\t\thw_enter_active_mode(spi);\n\n\t\tspi->speed_hz = speed_hz;\n\t\tspi->bits_per_word = bits_per_word;\n\t}\n\n\t \n\tcon = lantiq_ssc_readl(spi, LTQ_SPI_CON);\n\tif (t->tx_buf)\n\t\tcon &= ~LTQ_SPI_CON_TXOFF;\n\telse\n\t\tcon |= LTQ_SPI_CON_TXOFF;\n\n\tif (t->rx_buf)\n\t\tcon &= ~LTQ_SPI_CON_RXOFF;\n\telse\n\t\tcon |= LTQ_SPI_CON_RXOFF;\n\n\tlantiq_ssc_writel(spi, con, LTQ_SPI_CON);\n}\n\nstatic int lantiq_ssc_unprepare_message(struct spi_controller *host,\n\t\t\t\t\tstruct spi_message *message)\n{\n\tstruct lantiq_ssc_spi *spi = spi_controller_get_devdata(host);\n\n\tflush_workqueue(spi->wq);\n\n\t \n\tlantiq_ssc_maskl(spi, 0, LTQ_SPI_CON_TXOFF | LTQ_SPI_CON_RXOFF,\n\t\t\t LTQ_SPI_CON);\n\n\treturn 0;\n}\n\nstatic void tx_fifo_write(struct lantiq_ssc_spi *spi)\n{\n\tconst u8 *tx8;\n\tconst u16 *tx16;\n\tconst u32 *tx32;\n\tu32 data;\n\tunsigned int tx_free = tx_fifo_free(spi);\n\n\tspi->fdx_tx_level = 0;\n\twhile (spi->tx_todo && tx_free) {\n\t\tswitch (spi->bits_per_word) {\n\t\tcase 2 ... 8:\n\t\t\ttx8 = spi->tx;\n\t\t\tdata = *tx8;\n\t\t\tspi->tx_todo--;\n\t\t\tspi->tx++;\n\t\t\tbreak;\n\t\tcase 16:\n\t\t\ttx16 = (u16 *) spi->tx;\n\t\t\tdata = *tx16;\n\t\t\tspi->tx_todo -= 2;\n\t\t\tspi->tx += 2;\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\ttx32 = (u32 *) spi->tx;\n\t\t\tdata = *tx32;\n\t\t\tspi->tx_todo -= 4;\n\t\t\tspi->tx += 4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tWARN_ON(1);\n\t\t\tdata = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tlantiq_ssc_writel(spi, data, LTQ_SPI_TB);\n\t\ttx_free--;\n\t\tspi->fdx_tx_level++;\n\t}\n}\n\nstatic void rx_fifo_read_full_duplex(struct lantiq_ssc_spi *spi)\n{\n\tu8 *rx8;\n\tu16 *rx16;\n\tu32 *rx32;\n\tu32 data;\n\tunsigned int rx_fill = rx_fifo_level(spi);\n\n\t \n\twhile (rx_fill != spi->fdx_tx_level)\n\t\trx_fill = rx_fifo_level(spi);\n\n\twhile (rx_fill) {\n\t\tdata = lantiq_ssc_readl(spi, LTQ_SPI_RB);\n\n\t\tswitch (spi->bits_per_word) {\n\t\tcase 2 ... 8:\n\t\t\trx8 = spi->rx;\n\t\t\t*rx8 = data;\n\t\t\tspi->rx_todo--;\n\t\t\tspi->rx++;\n\t\t\tbreak;\n\t\tcase 16:\n\t\t\trx16 = (u16 *) spi->rx;\n\t\t\t*rx16 = data;\n\t\t\tspi->rx_todo -= 2;\n\t\t\tspi->rx += 2;\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\trx32 = (u32 *) spi->rx;\n\t\t\t*rx32 = data;\n\t\t\tspi->rx_todo -= 4;\n\t\t\tspi->rx += 4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tWARN_ON(1);\n\t\t\tbreak;\n\t\t}\n\n\t\trx_fill--;\n\t}\n}\n\nstatic void rx_fifo_read_half_duplex(struct lantiq_ssc_spi *spi)\n{\n\tu32 data, *rx32;\n\tu8 *rx8;\n\tunsigned int rxbv, shift;\n\tunsigned int rx_fill = rx_fifo_level(spi);\n\n\t \n\twhile (rx_fill) {\n\t\tif (spi->rx_todo < 4)  {\n\t\t\trxbv = (lantiq_ssc_readl(spi, LTQ_SPI_STAT) &\n\t\t\t\tLTQ_SPI_STAT_RXBV_M) >> LTQ_SPI_STAT_RXBV_S;\n\t\t\tdata = lantiq_ssc_readl(spi, LTQ_SPI_RB);\n\n\t\t\tshift = (rxbv - 1) * 8;\n\t\t\trx8 = spi->rx;\n\n\t\t\twhile (rxbv) {\n\t\t\t\t*rx8++ = (data >> shift) & 0xFF;\n\t\t\t\trxbv--;\n\t\t\t\tshift -= 8;\n\t\t\t\tspi->rx_todo--;\n\t\t\t\tspi->rx++;\n\t\t\t}\n\t\t} else {\n\t\t\tdata = lantiq_ssc_readl(spi, LTQ_SPI_RB);\n\t\t\trx32 = (u32 *) spi->rx;\n\n\t\t\t*rx32++ = data;\n\t\t\tspi->rx_todo -= 4;\n\t\t\tspi->rx += 4;\n\t\t}\n\t\trx_fill--;\n\t}\n}\n\nstatic void rx_request(struct lantiq_ssc_spi *spi)\n{\n\tunsigned int rxreq, rxreq_max;\n\n\t \n\trxreq = spi->rx_todo;\n\trxreq_max = spi->rx_fifo_size * 4;\n\tif (rxreq > rxreq_max)\n\t\trxreq = rxreq_max;\n\n\tlantiq_ssc_writel(spi, rxreq, LTQ_SPI_RXREQ);\n}\n\nstatic irqreturn_t lantiq_ssc_xmit_interrupt(int irq, void *data)\n{\n\tstruct lantiq_ssc_spi *spi = data;\n\tconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\n\tu32 val = lantiq_ssc_readl(spi, hwcfg->irncr);\n\n\tspin_lock(&spi->lock);\n\tif (hwcfg->irq_ack)\n\t\tlantiq_ssc_writel(spi, val, hwcfg->irncr);\n\n\tif (spi->tx) {\n\t\tif (spi->rx && spi->rx_todo)\n\t\t\trx_fifo_read_full_duplex(spi);\n\n\t\tif (spi->tx_todo)\n\t\t\ttx_fifo_write(spi);\n\t\telse if (!tx_fifo_level(spi))\n\t\t\tgoto completed;\n\t} else if (spi->rx) {\n\t\tif (spi->rx_todo) {\n\t\t\trx_fifo_read_half_duplex(spi);\n\n\t\t\tif (spi->rx_todo)\n\t\t\t\trx_request(spi);\n\t\t\telse\n\t\t\t\tgoto completed;\n\t\t} else {\n\t\t\tgoto completed;\n\t\t}\n\t}\n\n\tspin_unlock(&spi->lock);\n\treturn IRQ_HANDLED;\n\ncompleted:\n\tqueue_work(spi->wq, &spi->work);\n\tspin_unlock(&spi->lock);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t lantiq_ssc_err_interrupt(int irq, void *data)\n{\n\tstruct lantiq_ssc_spi *spi = data;\n\tconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\n\tu32 stat = lantiq_ssc_readl(spi, LTQ_SPI_STAT);\n\tu32 val = lantiq_ssc_readl(spi, hwcfg->irncr);\n\n\tif (!(stat & LTQ_SPI_STAT_ERRORS))\n\t\treturn IRQ_NONE;\n\n\tspin_lock(&spi->lock);\n\tif (hwcfg->irq_ack)\n\t\tlantiq_ssc_writel(spi, val, hwcfg->irncr);\n\n\tif (stat & LTQ_SPI_STAT_RUE)\n\t\tdev_err(spi->dev, \"receive underflow error\\n\");\n\tif (stat & LTQ_SPI_STAT_TUE)\n\t\tdev_err(spi->dev, \"transmit underflow error\\n\");\n\tif (stat & LTQ_SPI_STAT_AE)\n\t\tdev_err(spi->dev, \"abort error\\n\");\n\tif (stat & LTQ_SPI_STAT_RE)\n\t\tdev_err(spi->dev, \"receive overflow error\\n\");\n\tif (stat & LTQ_SPI_STAT_TE)\n\t\tdev_err(spi->dev, \"transmit overflow error\\n\");\n\tif (stat & LTQ_SPI_STAT_ME)\n\t\tdev_err(spi->dev, \"mode error\\n\");\n\n\t \n\tlantiq_ssc_maskl(spi, 0, LTQ_SPI_WHBSTATE_CLR_ERRORS, LTQ_SPI_WHBSTATE);\n\n\t \n\tif (spi->host->cur_msg)\n\t\tspi->host->cur_msg->status = -EIO;\n\tqueue_work(spi->wq, &spi->work);\n\tspin_unlock(&spi->lock);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t intel_lgm_ssc_isr(int irq, void *data)\n{\n\tstruct lantiq_ssc_spi *spi = data;\n\tconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\n\tu32 val = lantiq_ssc_readl(spi, hwcfg->irncr);\n\n\tif (!(val & LTQ_SPI_IRNEN_ALL))\n\t\treturn IRQ_NONE;\n\n\tif (val & LTQ_SPI_IRNEN_E)\n\t\treturn lantiq_ssc_err_interrupt(irq, data);\n\n\tif ((val & hwcfg->irnen_t) || (val & hwcfg->irnen_r))\n\t\treturn lantiq_ssc_xmit_interrupt(irq, data);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int transfer_start(struct lantiq_ssc_spi *spi, struct spi_device *spidev,\n\t\t\t  struct spi_transfer *t)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&spi->lock, flags);\n\n\tspi->tx = t->tx_buf;\n\tspi->rx = t->rx_buf;\n\n\tif (t->tx_buf) {\n\t\tspi->tx_todo = t->len;\n\n\t\t \n\t\ttx_fifo_write(spi);\n\t}\n\n\tif (spi->rx) {\n\t\tspi->rx_todo = t->len;\n\n\t\t \n\t\tif (!spi->tx)\n\t\t\trx_request(spi);\n\t}\n\n\tspin_unlock_irqrestore(&spi->lock, flags);\n\n\treturn t->len;\n}\n\n \nstatic void lantiq_ssc_bussy_work(struct work_struct *work)\n{\n\tstruct lantiq_ssc_spi *spi;\n\tunsigned long long timeout = 8LL * 1000LL;\n\tunsigned long end;\n\n\tspi = container_of(work, typeof(*spi), work);\n\n\tdo_div(timeout, spi->speed_hz);\n\ttimeout += timeout + 100;  \n\n\tend = jiffies + msecs_to_jiffies(timeout);\n\tdo {\n\t\tu32 stat = lantiq_ssc_readl(spi, LTQ_SPI_STAT);\n\n\t\tif (!(stat & LTQ_SPI_STAT_BSY)) {\n\t\t\tspi_finalize_current_transfer(spi->host);\n\t\t\treturn;\n\t\t}\n\n\t\tcond_resched();\n\t} while (!time_after_eq(jiffies, end));\n\n\tif (spi->host->cur_msg)\n\t\tspi->host->cur_msg->status = -EIO;\n\tspi_finalize_current_transfer(spi->host);\n}\n\nstatic void lantiq_ssc_handle_err(struct spi_controller *host,\n\t\t\t\t  struct spi_message *message)\n{\n\tstruct lantiq_ssc_spi *spi = spi_controller_get_devdata(host);\n\n\t \n\trx_fifo_flush(spi);\n\ttx_fifo_flush(spi);\n}\n\nstatic void lantiq_ssc_set_cs(struct spi_device *spidev, bool enable)\n{\n\tstruct lantiq_ssc_spi *spi = spi_controller_get_devdata(spidev->controller);\n\tunsigned int cs = spi_get_chipselect(spidev, 0);\n\tu32 fgpo;\n\n\tif (!!(spidev->mode & SPI_CS_HIGH) == enable)\n\t\tfgpo = (1 << (cs - spi->base_cs));\n\telse\n\t\tfgpo = (1 << (cs - spi->base_cs + LTQ_SPI_FGPO_SETOUTN_S));\n\n\tlantiq_ssc_writel(spi, fgpo, LTQ_SPI_FPGO);\n}\n\nstatic int lantiq_ssc_transfer_one(struct spi_controller *host,\n\t\t\t\t   struct spi_device *spidev,\n\t\t\t\t   struct spi_transfer *t)\n{\n\tstruct lantiq_ssc_spi *spi = spi_controller_get_devdata(host);\n\n\thw_setup_transfer(spi, spidev, t);\n\n\treturn transfer_start(spi, spidev, t);\n}\n\nstatic int intel_lgm_cfg_irq(struct platform_device *pdev, struct lantiq_ssc_spi *spi)\n{\n\tint irq;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\treturn devm_request_irq(&pdev->dev, irq, intel_lgm_ssc_isr, 0, \"spi\", spi);\n}\n\nstatic int lantiq_cfg_irq(struct platform_device *pdev, struct lantiq_ssc_spi *spi)\n{\n\tint irq, err;\n\n\tirq = platform_get_irq_byname(pdev, LTQ_SPI_RX_IRQ_NAME);\n\tif (irq < 0)\n\t\treturn irq;\n\n\terr = devm_request_irq(&pdev->dev, irq, lantiq_ssc_xmit_interrupt,\n\t\t\t       0, LTQ_SPI_RX_IRQ_NAME, spi);\n\tif (err)\n\t\treturn err;\n\n\tirq = platform_get_irq_byname(pdev, LTQ_SPI_TX_IRQ_NAME);\n\tif (irq < 0)\n\t\treturn irq;\n\n\terr = devm_request_irq(&pdev->dev, irq, lantiq_ssc_xmit_interrupt,\n\t\t\t       0, LTQ_SPI_TX_IRQ_NAME, spi);\n\n\tif (err)\n\t\treturn err;\n\n\tirq = platform_get_irq_byname(pdev, LTQ_SPI_ERR_IRQ_NAME);\n\tif (irq < 0)\n\t\treturn irq;\n\n\terr = devm_request_irq(&pdev->dev, irq, lantiq_ssc_err_interrupt,\n\t\t\t       0, LTQ_SPI_ERR_IRQ_NAME, spi);\n\treturn err;\n}\n\nstatic const struct lantiq_ssc_hwcfg lantiq_ssc_xway = {\n\t.cfg_irq\t= lantiq_cfg_irq,\n\t.irnen_r\t= LTQ_SPI_IRNEN_R_XWAY,\n\t.irnen_t\t= LTQ_SPI_IRNEN_T_XWAY,\n\t.irnicr\t\t= 0xF8,\n\t.irncr\t\t= 0xFC,\n\t.fifo_size_mask\t= GENMASK(5, 0),\n\t.irq_ack\t= false,\n};\n\nstatic const struct lantiq_ssc_hwcfg lantiq_ssc_xrx = {\n\t.cfg_irq\t= lantiq_cfg_irq,\n\t.irnen_r\t= LTQ_SPI_IRNEN_R_XRX,\n\t.irnen_t\t= LTQ_SPI_IRNEN_T_XRX,\n\t.irnicr\t\t= 0xF8,\n\t.irncr\t\t= 0xFC,\n\t.fifo_size_mask\t= GENMASK(5, 0),\n\t.irq_ack\t= false,\n};\n\nstatic const struct lantiq_ssc_hwcfg intel_ssc_lgm = {\n\t.cfg_irq\t= intel_lgm_cfg_irq,\n\t.irnen_r\t= LTQ_SPI_IRNEN_R_XRX,\n\t.irnen_t\t= LTQ_SPI_IRNEN_T_XRX,\n\t.irnicr\t\t= 0xFC,\n\t.irncr\t\t= 0xF8,\n\t.fifo_size_mask\t= GENMASK(7, 0),\n\t.irq_ack\t= true,\n};\n\nstatic const struct of_device_id lantiq_ssc_match[] = {\n\t{ .compatible = \"lantiq,ase-spi\", .data = &lantiq_ssc_xway, },\n\t{ .compatible = \"lantiq,falcon-spi\", .data = &lantiq_ssc_xrx, },\n\t{ .compatible = \"lantiq,xrx100-spi\", .data = &lantiq_ssc_xrx, },\n\t{ .compatible = \"intel,lgm-spi\", .data = &intel_ssc_lgm, },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, lantiq_ssc_match);\n\nstatic int lantiq_ssc_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct spi_controller *host;\n\tstruct lantiq_ssc_spi *spi;\n\tconst struct lantiq_ssc_hwcfg *hwcfg;\n\tu32 id, supports_dma, revision;\n\tunsigned int num_cs;\n\tint err;\n\n\thwcfg = of_device_get_match_data(dev);\n\n\thost = spi_alloc_host(dev, sizeof(struct lantiq_ssc_spi));\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\tspi = spi_controller_get_devdata(host);\n\tspi->host = host;\n\tspi->dev = dev;\n\tspi->hwcfg = hwcfg;\n\tplatform_set_drvdata(pdev, spi);\n\tspi->regbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(spi->regbase)) {\n\t\terr = PTR_ERR(spi->regbase);\n\t\tgoto err_host_put;\n\t}\n\n\terr = hwcfg->cfg_irq(pdev, spi);\n\tif (err)\n\t\tgoto err_host_put;\n\n\tspi->spi_clk = devm_clk_get(dev, \"gate\");\n\tif (IS_ERR(spi->spi_clk)) {\n\t\terr = PTR_ERR(spi->spi_clk);\n\t\tgoto err_host_put;\n\t}\n\terr = clk_prepare_enable(spi->spi_clk);\n\tif (err)\n\t\tgoto err_host_put;\n\n\t \n#if defined(CONFIG_LANTIQ) && !defined(CONFIG_COMMON_CLK)\n\tspi->fpi_clk = clk_get_fpi();\n#else\n\tspi->fpi_clk = clk_get(dev, \"freq\");\n#endif\n\tif (IS_ERR(spi->fpi_clk)) {\n\t\terr = PTR_ERR(spi->fpi_clk);\n\t\tgoto err_clk_disable;\n\t}\n\n\tnum_cs = 8;\n\tof_property_read_u32(pdev->dev.of_node, \"num-cs\", &num_cs);\n\n\tspi->base_cs = 1;\n\tof_property_read_u32(pdev->dev.of_node, \"base-cs\", &spi->base_cs);\n\n\tspin_lock_init(&spi->lock);\n\tspi->bits_per_word = 8;\n\tspi->speed_hz = 0;\n\n\thost->dev.of_node = pdev->dev.of_node;\n\thost->num_chipselect = num_cs;\n\thost->use_gpio_descriptors = true;\n\thost->setup = lantiq_ssc_setup;\n\thost->set_cs = lantiq_ssc_set_cs;\n\thost->handle_err = lantiq_ssc_handle_err;\n\thost->prepare_message = lantiq_ssc_prepare_message;\n\thost->unprepare_message = lantiq_ssc_unprepare_message;\n\thost->transfer_one = lantiq_ssc_transfer_one;\n\thost->mode_bits = SPI_CPOL | SPI_CPHA | SPI_LSB_FIRST | SPI_CS_HIGH |\n\t\t\t  SPI_LOOP;\n\thost->bits_per_word_mask = SPI_BPW_RANGE_MASK(2, 8) |\n\t\t\t\t   SPI_BPW_MASK(16) | SPI_BPW_MASK(32);\n\n\tspi->wq = alloc_ordered_workqueue(dev_name(dev), WQ_MEM_RECLAIM);\n\tif (!spi->wq) {\n\t\terr = -ENOMEM;\n\t\tgoto err_clk_put;\n\t}\n\tINIT_WORK(&spi->work, lantiq_ssc_bussy_work);\n\n\tid = lantiq_ssc_readl(spi, LTQ_SPI_ID);\n\tspi->tx_fifo_size = (id >> LTQ_SPI_ID_TXFS_S) & hwcfg->fifo_size_mask;\n\tspi->rx_fifo_size = (id >> LTQ_SPI_ID_RXFS_S) & hwcfg->fifo_size_mask;\n\tsupports_dma = (id & LTQ_SPI_ID_CFG_M) >> LTQ_SPI_ID_CFG_S;\n\trevision = id & LTQ_SPI_ID_REV_M;\n\n\tlantiq_ssc_hw_init(spi);\n\n\tdev_info(dev,\n\t\t\"Lantiq SSC SPI controller (Rev %i, TXFS %u, RXFS %u, DMA %u)\\n\",\n\t\trevision, spi->tx_fifo_size, spi->rx_fifo_size, supports_dma);\n\n\terr = devm_spi_register_controller(dev, host);\n\tif (err) {\n\t\tdev_err(dev, \"failed to register spi host\\n\");\n\t\tgoto err_wq_destroy;\n\t}\n\n\treturn 0;\n\nerr_wq_destroy:\n\tdestroy_workqueue(spi->wq);\nerr_clk_put:\n\tclk_put(spi->fpi_clk);\nerr_clk_disable:\n\tclk_disable_unprepare(spi->spi_clk);\nerr_host_put:\n\tspi_controller_put(host);\n\n\treturn err;\n}\n\nstatic void lantiq_ssc_remove(struct platform_device *pdev)\n{\n\tstruct lantiq_ssc_spi *spi = platform_get_drvdata(pdev);\n\n\tlantiq_ssc_writel(spi, 0, LTQ_SPI_IRNEN);\n\tlantiq_ssc_writel(spi, 0, LTQ_SPI_CLC);\n\trx_fifo_flush(spi);\n\ttx_fifo_flush(spi);\n\thw_enter_config_mode(spi);\n\n\tdestroy_workqueue(spi->wq);\n\tclk_disable_unprepare(spi->spi_clk);\n\tclk_put(spi->fpi_clk);\n}\n\nstatic struct platform_driver lantiq_ssc_driver = {\n\t.probe = lantiq_ssc_probe,\n\t.remove_new = lantiq_ssc_remove,\n\t.driver = {\n\t\t.name = \"spi-lantiq-ssc\",\n\t\t.of_match_table = lantiq_ssc_match,\n\t},\n};\nmodule_platform_driver(lantiq_ssc_driver);\n\nMODULE_DESCRIPTION(\"Lantiq SSC SPI controller driver\");\nMODULE_AUTHOR(\"Daniel Schwierzeck <daniel.schwierzeck@gmail.com>\");\nMODULE_AUTHOR(\"Hauke Mehrtens <hauke@hauke-m.de>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:spi-lantiq-ssc\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}