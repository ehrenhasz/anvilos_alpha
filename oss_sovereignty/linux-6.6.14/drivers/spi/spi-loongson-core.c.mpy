{
  "module_name": "spi-loongson-core.c",
  "hash_id": "6948f250b05ee244e39b1820643e354d3d79521169b5c9cf5fac7a0f3d4d65a5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/spi/spi-loongson-core.c",
  "human_readable_source": "\n\n\n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/spi/spi.h>\n\n#include \"spi-loongson.h\"\n\nstatic inline void loongson_spi_write_reg(struct loongson_spi *spi, unsigned char reg,\n\t\t\t\t\t  unsigned char data)\n{\n\twriteb(data, spi->base + reg);\n}\n\nstatic inline char loongson_spi_read_reg(struct loongson_spi *spi, unsigned char reg)\n{\n\treturn readb(spi->base + reg);\n}\n\nstatic void loongson_spi_set_cs(struct spi_device *spi, bool en)\n{\n\tint cs;\n\tunsigned char mask = (BIT(4) | BIT(0)) << spi_get_chipselect(spi, 0);\n\tunsigned char val = en ? mask :  (BIT(0) << spi_get_chipselect(spi, 0));\n\tstruct loongson_spi *loongson_spi = spi_controller_get_devdata(spi->controller);\n\n\tcs = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SFCS_REG) & ~mask;\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SFCS_REG, val | cs);\n}\n\nstatic void loongson_spi_set_clk(struct loongson_spi *loongson_spi, unsigned int hz)\n{\n\tunsigned char val;\n\tunsigned int div, div_tmp;\n\tstatic const char rdiv[12] = {0, 1, 4, 2, 3, 5, 6, 7, 8, 9, 10, 11};\n\n\tdiv = clamp_val(DIV_ROUND_UP_ULL(loongson_spi->clk_rate, hz), 2, 4096);\n\tdiv_tmp = rdiv[fls(div - 1)];\n\tloongson_spi->spcr = (div_tmp & GENMASK(1, 0)) >> 0;\n\tloongson_spi->sper = (div_tmp & GENMASK(3, 2)) >> 2;\n\tval = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SPCR_REG);\n\tval &= ~GENMASK(1, 0);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SPCR_REG, val |\n\t\t\t       loongson_spi->spcr);\n\tval = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SPER_REG);\n\tval &= ~GENMASK(1, 0);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SPER_REG, val |\n\t\t\t       loongson_spi->sper);\n\tloongson_spi->hz = hz;\n}\n\nstatic void loongson_spi_set_mode(struct loongson_spi *loongson_spi,\n\t\t\t\t  struct spi_device *spi)\n{\n\tunsigned char val;\n\n\tval = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SPCR_REG);\n\tval &= ~(LOONGSON_SPI_SPCR_CPOL | LOONGSON_SPI_SPCR_CPHA);\n\tif (spi->mode & SPI_CPOL)\n\t\tval |= LOONGSON_SPI_SPCR_CPOL;\n\tif (spi->mode & SPI_CPHA)\n\t\tval |= LOONGSON_SPI_SPCR_CPHA;\n\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SPCR_REG, val);\n\tloongson_spi->mode |= spi->mode;\n}\n\nstatic int loongson_spi_update_state(struct loongson_spi *loongson_spi,\n\t\t\t\tstruct spi_device *spi, struct spi_transfer *t)\n{\n\tif (t && loongson_spi->hz != t->speed_hz)\n\t\tloongson_spi_set_clk(loongson_spi, t->speed_hz);\n\n\tif ((spi->mode ^ loongson_spi->mode) & SPI_MODE_X_MASK)\n\t\tloongson_spi_set_mode(loongson_spi, spi);\n\n\treturn 0;\n}\n\nstatic int loongson_spi_setup(struct spi_device *spi)\n{\n\tstruct loongson_spi *loongson_spi;\n\n\tloongson_spi = spi_controller_get_devdata(spi->controller);\n\tif (spi->bits_per_word % 8)\n\t\treturn -EINVAL;\n\n\tif (spi_get_chipselect(spi, 0) >= spi->controller->num_chipselect)\n\t\treturn -EINVAL;\n\n\tloongson_spi->hz = 0;\n\tloongson_spi_set_cs(spi, true);\n\n\treturn 0;\n}\n\nstatic int loongson_spi_write_read_8bit(struct spi_device *spi, const u8 **tx_buf,\n\t\t\t\t\tu8 **rx_buf, unsigned int num)\n{\n\tint ret;\n\tstruct loongson_spi *loongson_spi = spi_controller_get_devdata(spi->controller);\n\n\tif (tx_buf && *tx_buf)\n\t\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_FIFO_REG, *((*tx_buf)++));\n\telse\n\t\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_FIFO_REG, 0);\n\n\tret = readb_poll_timeout(loongson_spi->base + LOONGSON_SPI_SPSR_REG,\n\t\t\t\t loongson_spi->spsr, (loongson_spi->spsr &\n\t\t\t\t LOONGSON_SPI_SPSR_RFEMPTY) != LOONGSON_SPI_SPSR_RFEMPTY,\n\t\t\t\t 1, USEC_PER_MSEC);\n\n\tif (rx_buf && *rx_buf)\n\t\t*(*rx_buf)++ = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_FIFO_REG);\n\telse\n\t\tloongson_spi_read_reg(loongson_spi, LOONGSON_SPI_FIFO_REG);\n\n\treturn ret;\n}\n\nstatic int loongson_spi_write_read(struct spi_device *spi, struct spi_transfer *xfer)\n{\n\tint ret;\n\tunsigned int count;\n\tconst u8 *tx = xfer->tx_buf;\n\tu8 *rx = xfer->rx_buf;\n\n\tcount = xfer->len;\n\tdo {\n\t\tret = loongson_spi_write_read_8bit(spi, &tx, &rx, count);\n\t\tif (ret)\n\t\t\tbreak;\n\t} while (--count);\n\n\treturn ret;\n}\n\nstatic int loongson_spi_prepare_message(struct spi_controller *ctlr, struct spi_message *m)\n{\n\tstruct loongson_spi *loongson_spi = spi_controller_get_devdata(ctlr);\n\n\tloongson_spi->para = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_PARA_REG);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_PARA_REG, loongson_spi->para &\n\t\t\t       ~LOONGSON_SPI_PARA_MEM_EN);\n\n\treturn 0;\n}\n\nstatic int loongson_spi_transfer_one(struct spi_controller *ctrl, struct spi_device *spi,\n\t\t\t\t     struct spi_transfer *xfer)\n{\n\tstruct loongson_spi *loongson_spi = spi_controller_get_devdata(spi->controller);\n\n\tloongson_spi_update_state(loongson_spi, spi, xfer);\n\tif (xfer->len)\n\t\treturn loongson_spi_write_read(spi, xfer);\n\n\treturn 0;\n}\n\nstatic int loongson_spi_unprepare_message(struct spi_controller *ctrl, struct spi_message *m)\n{\n\tstruct loongson_spi *loongson_spi = spi_controller_get_devdata(ctrl);\n\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_PARA_REG, loongson_spi->para);\n\n\treturn 0;\n}\n\nstatic void loongson_spi_reginit(struct loongson_spi *loongson_spi_dev)\n{\n\tunsigned char val;\n\n\tval = loongson_spi_read_reg(loongson_spi_dev, LOONGSON_SPI_SPCR_REG);\n\tval &= ~LOONGSON_SPI_SPCR_SPE;\n\tloongson_spi_write_reg(loongson_spi_dev, LOONGSON_SPI_SPCR_REG, val);\n\n\tloongson_spi_write_reg(loongson_spi_dev, LOONGSON_SPI_SPSR_REG,\n\t\t\t       (LOONGSON_SPI_SPSR_SPIF | LOONGSON_SPI_SPSR_WCOL));\n\n\tval = loongson_spi_read_reg(loongson_spi_dev, LOONGSON_SPI_SPCR_REG);\n\tval |= LOONGSON_SPI_SPCR_SPE;\n\tloongson_spi_write_reg(loongson_spi_dev, LOONGSON_SPI_SPCR_REG, val);\n}\n\nint loongson_spi_init_controller(struct device *dev, void __iomem *regs)\n{\n\tstruct spi_controller *controller;\n\tstruct loongson_spi *spi;\n\tstruct clk *clk;\n\n\tcontroller = devm_spi_alloc_host(dev, sizeof(struct loongson_spi));\n\tif (controller == NULL)\n\t\treturn -ENOMEM;\n\n\tcontroller->mode_bits = SPI_MODE_X_MASK | SPI_CS_HIGH;\n\tcontroller->setup = loongson_spi_setup;\n\tcontroller->prepare_message = loongson_spi_prepare_message;\n\tcontroller->transfer_one = loongson_spi_transfer_one;\n\tcontroller->unprepare_message = loongson_spi_unprepare_message;\n\tcontroller->set_cs = loongson_spi_set_cs;\n\tcontroller->num_chipselect = 4;\n\tdevice_set_node(&controller->dev, dev_fwnode(dev));\n\tdev_set_drvdata(dev, controller);\n\n\tspi = spi_controller_get_devdata(controller);\n\tspi->base = regs;\n\tspi->controller = controller;\n\n\tclk = devm_clk_get_optional(dev, NULL);\n\tif (IS_ERR(clk))\n\t\treturn dev_err_probe(dev, PTR_ERR(clk), \"unable to get clock\\n\");\n\n\tspi->clk_rate = clk_get_rate(clk);\n\tloongson_spi_reginit(spi);\n\n\tspi->mode = 0;\n\n\treturn devm_spi_register_controller(dev, controller);\n}\nEXPORT_SYMBOL_NS_GPL(loongson_spi_init_controller, SPI_LOONGSON_CORE);\n\nstatic int __maybe_unused loongson_spi_suspend(struct device *dev)\n{\n\tstruct loongson_spi *loongson_spi;\n\tstruct spi_controller *controller;\n\n\tcontroller = dev_get_drvdata(dev);\n\tspi_controller_suspend(controller);\n\n\tloongson_spi = spi_controller_get_devdata(controller);\n\n\tloongson_spi->spcr = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SPCR_REG);\n\tloongson_spi->sper = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SPER_REG);\n\tloongson_spi->spsr = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SPSR_REG);\n\tloongson_spi->para = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_PARA_REG);\n\tloongson_spi->sfcs = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_SFCS_REG);\n\tloongson_spi->timi = loongson_spi_read_reg(loongson_spi, LOONGSON_SPI_TIMI_REG);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused loongson_spi_resume(struct device *dev)\n{\n\tstruct loongson_spi *loongson_spi;\n\tstruct spi_controller *controller;\n\n\tcontroller = dev_get_drvdata(dev);\n\tloongson_spi = spi_controller_get_devdata(controller);\n\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SPCR_REG, loongson_spi->spcr);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SPER_REG, loongson_spi->sper);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SPSR_REG, loongson_spi->spsr);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_PARA_REG, loongson_spi->para);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_SFCS_REG, loongson_spi->sfcs);\n\tloongson_spi_write_reg(loongson_spi, LOONGSON_SPI_TIMI_REG, loongson_spi->timi);\n\n\tspi_controller_resume(controller);\n\n\treturn 0;\n}\n\nconst struct dev_pm_ops loongson_spi_dev_pm_ops = {\n\t.suspend = loongson_spi_suspend,\n\t.resume = loongson_spi_resume,\n};\nEXPORT_SYMBOL_NS_GPL(loongson_spi_dev_pm_ops, SPI_LOONGSON_CORE);\n\nMODULE_DESCRIPTION(\"Loongson SPI core driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}