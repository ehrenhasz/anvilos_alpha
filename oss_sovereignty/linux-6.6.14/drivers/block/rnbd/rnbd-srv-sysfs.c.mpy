{
  "module_name": "rnbd-srv-sysfs.c",
  "hash_id": "b8ec781f3fbfaf060f60b5047e3eb359954c774055cef561df7de263599ddf67",
  "original_prompt": "Ingested from linux-6.6.14/drivers/block/rnbd/rnbd-srv-sysfs.c",
  "human_readable_source": "\n \n#undef pr_fmt\n#define pr_fmt(fmt) KBUILD_MODNAME \" L\" __stringify(__LINE__) \": \" fmt\n\n#include <linux/kobject.h>\n#include <linux/sysfs.h>\n#include <linux/stat.h>\n#include <linux/list.h>\n#include <linux/moduleparam.h>\n#include <linux/device.h>\n\n#include \"rnbd-srv.h\"\n\nstatic struct device *rnbd_dev;\nstatic const struct class rnbd_dev_class = {\n\t.name = \"rnbd-server\",\n};\nstatic struct kobject *rnbd_devs_kobj;\n\nstatic void rnbd_srv_dev_release(struct kobject *kobj)\n{\n\tstruct rnbd_srv_dev *dev;\n\n\tdev = container_of(kobj, struct rnbd_srv_dev, dev_kobj);\n\n\tkfree(dev);\n}\n\nstatic struct kobj_type dev_ktype = {\n\t.sysfs_ops = &kobj_sysfs_ops,\n\t.release = rnbd_srv_dev_release\n};\n\nint rnbd_srv_create_dev_sysfs(struct rnbd_srv_dev *dev,\n\t\t\t       struct block_device *bdev)\n{\n\tstruct kobject *bdev_kobj;\n\tint ret;\n\n\tret = kobject_init_and_add(&dev->dev_kobj, &dev_ktype,\n\t\t\t\t   rnbd_devs_kobj, \"%pg\", bdev);\n\tif (ret) {\n\t\tkobject_put(&dev->dev_kobj);\n\t\treturn ret;\n\t}\n\n\tdev->dev_sessions_kobj = kobject_create_and_add(\"sessions\",\n\t\t\t\t\t\t\t&dev->dev_kobj);\n\tif (!dev->dev_sessions_kobj) {\n\t\tret = -ENOMEM;\n\t\tgoto free_dev_kobj;\n\t}\n\n\tbdev_kobj = &disk_to_dev(bdev->bd_disk)->kobj;\n\tret = sysfs_create_link(&dev->dev_kobj, bdev_kobj, \"block_dev\");\n\tif (ret)\n\t\tgoto put_sess_kobj;\n\n\treturn 0;\n\nput_sess_kobj:\n\tkobject_put(dev->dev_sessions_kobj);\nfree_dev_kobj:\n\tkobject_del(&dev->dev_kobj);\n\tkobject_put(&dev->dev_kobj);\n\treturn ret;\n}\n\nvoid rnbd_srv_destroy_dev_sysfs(struct rnbd_srv_dev *dev)\n{\n\tsysfs_remove_link(&dev->dev_kobj, \"block_dev\");\n\tkobject_del(dev->dev_sessions_kobj);\n\tkobject_put(dev->dev_sessions_kobj);\n\tkobject_del(&dev->dev_kobj);\n\tkobject_put(&dev->dev_kobj);\n}\n\nstatic ssize_t read_only_show(struct kobject *kobj, struct kobj_attribute *attr,\n\t\t\t      char *page)\n{\n\tstruct rnbd_srv_sess_dev *sess_dev;\n\n\tsess_dev = container_of(kobj, struct rnbd_srv_sess_dev, kobj);\n\n\treturn sysfs_emit(page, \"%d\\n\", sess_dev->readonly);\n}\n\nstatic struct kobj_attribute rnbd_srv_dev_session_ro_attr =\n\t__ATTR_RO(read_only);\n\nstatic ssize_t access_mode_show(struct kobject *kobj,\n\t\t\t\tstruct kobj_attribute *attr,\n\t\t\t\tchar *page)\n{\n\tstruct rnbd_srv_sess_dev *sess_dev;\n\n\tsess_dev = container_of(kobj, struct rnbd_srv_sess_dev, kobj);\n\n\treturn sysfs_emit(page, \"%s\\n\",\n\t\t\t  rnbd_access_modes[sess_dev->access_mode].str);\n}\n\nstatic struct kobj_attribute rnbd_srv_dev_session_access_mode_attr =\n\t__ATTR_RO(access_mode);\n\nstatic ssize_t mapping_path_show(struct kobject *kobj,\n\t\t\t\t struct kobj_attribute *attr, char *page)\n{\n\tstruct rnbd_srv_sess_dev *sess_dev;\n\n\tsess_dev = container_of(kobj, struct rnbd_srv_sess_dev, kobj);\n\n\treturn sysfs_emit(page, \"%s\\n\", sess_dev->pathname);\n}\n\nstatic struct kobj_attribute rnbd_srv_dev_session_mapping_path_attr =\n\t__ATTR_RO(mapping_path);\n\nstatic ssize_t rnbd_srv_dev_session_force_close_show(struct kobject *kobj,\n\t\t\t\t\tstruct kobj_attribute *attr, char *page)\n{\n\treturn sysfs_emit(page, \"Usage: echo 1 > %s\\n\",\n\t\t\t  attr->attr.name);\n}\n\nstatic ssize_t rnbd_srv_dev_session_force_close_store(struct kobject *kobj,\n\t\t\t\t\tstruct kobj_attribute *attr,\n\t\t\t\t\tconst char *buf, size_t count)\n{\n\tstruct rnbd_srv_sess_dev *sess_dev;\n\n\tsess_dev = container_of(kobj, struct rnbd_srv_sess_dev, kobj);\n\n\tif (!sysfs_streq(buf, \"1\")) {\n\t\trnbd_srv_err(sess_dev, \"%s: invalid value: '%s'\\n\",\n\t\t\t      attr->attr.name, buf);\n\t\treturn -EINVAL;\n\t}\n\n\trnbd_srv_info(sess_dev, \"force close requested\\n\");\n\trnbd_srv_sess_dev_force_close(sess_dev, attr);\n\n\treturn count;\n}\n\nstatic struct kobj_attribute rnbd_srv_dev_session_force_close_attr =\n\t__ATTR(force_close, 0644,\n\t       rnbd_srv_dev_session_force_close_show,\n\t       rnbd_srv_dev_session_force_close_store);\n\nstatic struct attribute *rnbd_srv_default_dev_sessions_attrs[] = {\n\t&rnbd_srv_dev_session_access_mode_attr.attr,\n\t&rnbd_srv_dev_session_ro_attr.attr,\n\t&rnbd_srv_dev_session_mapping_path_attr.attr,\n\t&rnbd_srv_dev_session_force_close_attr.attr,\n\tNULL,\n};\n\nstatic struct attribute_group rnbd_srv_default_dev_session_attr_group = {\n\t.attrs = rnbd_srv_default_dev_sessions_attrs,\n};\n\nvoid rnbd_srv_destroy_dev_session_sysfs(struct rnbd_srv_sess_dev *sess_dev)\n{\n\tsysfs_remove_group(&sess_dev->kobj,\n\t\t\t   &rnbd_srv_default_dev_session_attr_group);\n\n\tkobject_del(&sess_dev->kobj);\n\tkobject_put(&sess_dev->kobj);\n}\n\nstatic void rnbd_srv_sess_dev_release(struct kobject *kobj)\n{\n\tstruct rnbd_srv_sess_dev *sess_dev;\n\n\tsess_dev = container_of(kobj, struct rnbd_srv_sess_dev, kobj);\n\trnbd_destroy_sess_dev(sess_dev, sess_dev->keep_id);\n}\n\nstatic struct kobj_type rnbd_srv_sess_dev_ktype = {\n\t.sysfs_ops\t= &kobj_sysfs_ops,\n\t.release\t= rnbd_srv_sess_dev_release,\n};\n\nint rnbd_srv_create_dev_session_sysfs(struct rnbd_srv_sess_dev *sess_dev)\n{\n\tint ret;\n\n\tret = kobject_init_and_add(&sess_dev->kobj, &rnbd_srv_sess_dev_ktype,\n\t\t\t\t   sess_dev->dev->dev_sessions_kobj, \"%s\",\n\t\t\t\t   sess_dev->sess->sessname);\n\tif (ret) {\n\t\tkobject_put(&sess_dev->kobj);\n\t\treturn ret;\n\t}\n\n\tret = sysfs_create_group(&sess_dev->kobj,\n\t\t\t\t &rnbd_srv_default_dev_session_attr_group);\n\tif (ret) {\n\t\tkobject_del(&sess_dev->kobj);\n\t\tkobject_put(&sess_dev->kobj);\n\t}\n\n\treturn ret;\n}\n\nint rnbd_srv_create_sysfs_files(void)\n{\n\tint err;\n\n\terr = class_register(&rnbd_dev_class);\n\tif (err)\n\t\treturn err;\n\n\trnbd_dev = device_create(&rnbd_dev_class, NULL,\n\t\t\t\t MKDEV(0, 0), NULL, \"ctl\");\n\tif (IS_ERR(rnbd_dev)) {\n\t\terr = PTR_ERR(rnbd_dev);\n\t\tgoto cls_destroy;\n\t}\n\trnbd_devs_kobj = kobject_create_and_add(\"devices\", &rnbd_dev->kobj);\n\tif (!rnbd_devs_kobj) {\n\t\terr = -ENOMEM;\n\t\tgoto dev_destroy;\n\t}\n\n\treturn 0;\n\ndev_destroy:\n\tdevice_destroy(&rnbd_dev_class, MKDEV(0, 0));\ncls_destroy:\n\tclass_unregister(&rnbd_dev_class);\n\n\treturn err;\n}\n\nvoid rnbd_srv_destroy_sysfs_files(void)\n{\n\tkobject_del(rnbd_devs_kobj);\n\tkobject_put(rnbd_devs_kobj);\n\tdevice_destroy(&rnbd_dev_class, MKDEV(0, 0));\n\tclass_unregister(&rnbd_dev_class);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}