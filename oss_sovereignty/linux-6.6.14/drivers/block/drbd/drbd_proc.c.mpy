{
  "module_name": "drbd_proc.c",
  "hash_id": "1c92a2f5cd0d94154d54ea845c68753472157e1735fb34eaac2334b949e5c1ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/block/drbd/drbd_proc.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n\n#include <linux/uaccess.h>\n#include <linux/fs.h>\n#include <linux/file.h>\n#include <linux/proc_fs.h>\n#include <linux/seq_file.h>\n#include <linux/drbd.h>\n#include \"drbd_int.h\"\n\nstruct proc_dir_entry *drbd_proc;\n\nstatic void seq_printf_with_thousands_grouping(struct seq_file *seq, long v)\n{\n\t \n\tif (unlikely(v >= 1000000)) {\n\t\t \n\t\tseq_printf(seq, \"%ld,\", v / 1000000);\n\t\tv %= 1000000;\n\t\tseq_printf(seq, \"%03ld,%03ld\", v/1000, v % 1000);\n\t} else if (likely(v >= 1000))\n\t\tseq_printf(seq, \"%ld,%03ld\", v/1000, v % 1000);\n\telse\n\t\tseq_printf(seq, \"%ld\", v);\n}\n\nstatic void drbd_get_syncer_progress(struct drbd_device *device,\n\t\tunion drbd_dev_state state, unsigned long *rs_total,\n\t\tunsigned long *bits_left, unsigned int *per_mil_done)\n{\n\t \n\ttypecheck(unsigned long, device->rs_total);\n\t*rs_total = device->rs_total;\n\n\t \n\n\tif (state.conn == C_VERIFY_S || state.conn == C_VERIFY_T)\n\t\t*bits_left = device->ov_left;\n\telse\n\t\t*bits_left = drbd_bm_total_weight(device) - device->rs_failed;\n\t \n\tif (*bits_left > *rs_total) {\n\t\t \n\t\t*bits_left = *rs_total;\n\t\t*per_mil_done = *rs_total ? 0 : 1000;\n\t} else {\n\t\t \n\t\tunsigned int shift = *rs_total > UINT_MAX ? 16 : 10;\n\t\tunsigned long left = *bits_left >> shift;\n\t\tunsigned long total = 1UL + (*rs_total >> shift);\n\t\tunsigned long tmp = 1000UL - left * 1000UL/total;\n\t\t*per_mil_done = tmp;\n\t}\n}\n\n\n \nstatic void drbd_syncer_progress(struct drbd_device *device, struct seq_file *seq,\n\t\tunion drbd_dev_state state)\n{\n\tunsigned long db, dt, dbdt, rt, rs_total, rs_left;\n\tunsigned int res;\n\tint i, x, y;\n\tint stalled = 0;\n\n\tdrbd_get_syncer_progress(device, state, &rs_total, &rs_left, &res);\n\n\tx = res/50;\n\ty = 20-x;\n\tseq_puts(seq, \"\\t[\");\n\tfor (i = 1; i < x; i++)\n\t\tseq_putc(seq, '=');\n\tseq_putc(seq, '>');\n\tfor (i = 0; i < y; i++)\n\t\tseq_putc(seq, '.');\n\tseq_puts(seq, \"] \");\n\n\tif (state.conn == C_VERIFY_S || state.conn == C_VERIFY_T)\n\t\tseq_puts(seq, \"verified:\");\n\telse\n\t\tseq_puts(seq, \"sync'ed:\");\n\tseq_printf(seq, \"%3u.%u%% \", res / 10, res % 10);\n\n\t \n\tif (rs_total > (4UL << (30 - BM_BLOCK_SHIFT)))\n\t\tseq_printf(seq, \"(%lu/%lu)M\",\n\t\t\t    (unsigned long) Bit2KB(rs_left >> 10),\n\t\t\t    (unsigned long) Bit2KB(rs_total >> 10));\n\telse\n\t\tseq_printf(seq, \"(%lu/%lu)K\",\n\t\t\t    (unsigned long) Bit2KB(rs_left),\n\t\t\t    (unsigned long) Bit2KB(rs_total));\n\n\tseq_puts(seq, \"\\n\\t\");\n\n\t \n\t \n\t \n\ti = (device->rs_last_mark + 2) % DRBD_SYNC_MARKS;\n\tdt = (jiffies - device->rs_mark_time[i]) / HZ;\n\tif (dt > 180)\n\t\tstalled = 1;\n\n\tif (!dt)\n\t\tdt++;\n\tdb = device->rs_mark_left[i] - rs_left;\n\trt = (dt * (rs_left / (db/100+1)))/100;  \n\n\tseq_printf(seq, \"finish: %lu:%02lu:%02lu\",\n\t\trt / 3600, (rt % 3600) / 60, rt % 60);\n\n\tdbdt = Bit2KB(db/dt);\n\tseq_puts(seq, \" speed: \");\n\tseq_printf_with_thousands_grouping(seq, dbdt);\n\tseq_puts(seq, \" (\");\n\t \n\tif (drbd_proc_details >= 1) {\n\t\t \n\t\ti = (device->rs_last_mark + DRBD_SYNC_MARKS-1) % DRBD_SYNC_MARKS;\n\t\tdt = (jiffies - device->rs_mark_time[i]) / HZ;\n\t\tif (!dt)\n\t\t\tdt++;\n\t\tdb = device->rs_mark_left[i] - rs_left;\n\t\tdbdt = Bit2KB(db/dt);\n\t\tseq_printf_with_thousands_grouping(seq, dbdt);\n\t\tseq_puts(seq, \" -- \");\n\t}\n\n\t \n\t \n\tdt = (jiffies - device->rs_start - device->rs_paused) / HZ;\n\tif (dt == 0)\n\t\tdt = 1;\n\tdb = rs_total - rs_left;\n\tdbdt = Bit2KB(db/dt);\n\tseq_printf_with_thousands_grouping(seq, dbdt);\n\tseq_putc(seq, ')');\n\n\tif (state.conn == C_SYNC_TARGET ||\n\t    state.conn == C_VERIFY_S) {\n\t\tseq_puts(seq, \" want: \");\n\t\tseq_printf_with_thousands_grouping(seq, device->c_sync_rate);\n\t}\n\tseq_printf(seq, \" K/sec%s\\n\", stalled ? \" (stalled)\" : \"\");\n\n\tif (drbd_proc_details >= 1) {\n\t\t \n\t\tunsigned long bm_bits = drbd_bm_bits(device);\n\t\tunsigned long bit_pos;\n\t\tunsigned long long stop_sector = 0;\n\t\tif (state.conn == C_VERIFY_S ||\n\t\t    state.conn == C_VERIFY_T) {\n\t\t\tbit_pos = bm_bits - device->ov_left;\n\t\t\tif (verify_can_do_stop_sector(device))\n\t\t\t\tstop_sector = device->ov_stop_sector;\n\t\t} else\n\t\t\tbit_pos = device->bm_resync_fo;\n\t\t \n\t\tseq_printf(seq,\n\t\t\t\"\\t%3d%% sector pos: %llu/%llu\",\n\t\t\t(int)(bit_pos / (bm_bits/100+1)),\n\t\t\t(unsigned long long)bit_pos * BM_SECT_PER_BIT,\n\t\t\t(unsigned long long)bm_bits * BM_SECT_PER_BIT);\n\t\tif (stop_sector != 0 && stop_sector != ULLONG_MAX)\n\t\t\tseq_printf(seq, \" stop sector: %llu\", stop_sector);\n\t\tseq_putc(seq, '\\n');\n\t}\n}\n\nint drbd_seq_show(struct seq_file *seq, void *v)\n{\n\tint i, prev_i = -1;\n\tconst char *sn;\n\tstruct drbd_device *device;\n\tstruct net_conf *nc;\n\tunion drbd_dev_state state;\n\tchar wp;\n\n\tstatic char write_ordering_chars[] = {\n\t\t[WO_NONE] = 'n',\n\t\t[WO_DRAIN_IO] = 'd',\n\t\t[WO_BDEV_FLUSH] = 'f',\n\t};\n\n\tseq_printf(seq, \"version: \" REL_VERSION \" (api:%d/proto:%d-%d)\\n%s\\n\",\n\t\t   GENL_MAGIC_VERSION, PRO_VERSION_MIN, PRO_VERSION_MAX, drbd_buildtag());\n\n\t \n\n\trcu_read_lock();\n\tidr_for_each_entry(&drbd_devices, device, i) {\n\t\tif (prev_i != i - 1)\n\t\t\tseq_putc(seq, '\\n');\n\t\tprev_i = i;\n\n\t\tstate = device->state;\n\t\tsn = drbd_conn_str(state.conn);\n\n\t\tif (state.conn == C_STANDALONE &&\n\t\t    state.disk == D_DISKLESS &&\n\t\t    state.role == R_SECONDARY) {\n\t\t\tseq_printf(seq, \"%2d: cs:Unconfigured\\n\", i);\n\t\t} else {\n\t\t\t \n\n\t\t\tnc = rcu_dereference(first_peer_device(device)->connection->net_conf);\n\t\t\twp = nc ? nc->wire_protocol - DRBD_PROT_A + 'A' : ' ';\n\t\t\tseq_printf(seq,\n\t\t\t   \"%2d: cs:%s ro:%s/%s ds:%s/%s %c %c%c%c%c%c%c\\n\"\n\t\t\t   \"    ns:%u nr:%u dw:%u dr:%u al:%u bm:%u \"\n\t\t\t   \"lo:%d pe:%d ua:%d ap:%d ep:%d wo:%c\",\n\t\t\t   i, sn,\n\t\t\t   drbd_role_str(state.role),\n\t\t\t   drbd_role_str(state.peer),\n\t\t\t   drbd_disk_str(state.disk),\n\t\t\t   drbd_disk_str(state.pdsk),\n\t\t\t   wp,\n\t\t\t   drbd_suspended(device) ? 's' : 'r',\n\t\t\t   state.aftr_isp ? 'a' : '-',\n\t\t\t   state.peer_isp ? 'p' : '-',\n\t\t\t   state.user_isp ? 'u' : '-',\n\t\t\t   device->congestion_reason ?: '-',\n\t\t\t   test_bit(AL_SUSPENDED, &device->flags) ? 's' : '-',\n\t\t\t   device->send_cnt/2,\n\t\t\t   device->recv_cnt/2,\n\t\t\t   device->writ_cnt/2,\n\t\t\t   device->read_cnt/2,\n\t\t\t   device->al_writ_cnt,\n\t\t\t   device->bm_writ_cnt,\n\t\t\t   atomic_read(&device->local_cnt),\n\t\t\t   atomic_read(&device->ap_pending_cnt) +\n\t\t\t   atomic_read(&device->rs_pending_cnt),\n\t\t\t   atomic_read(&device->unacked_cnt),\n\t\t\t   atomic_read(&device->ap_bio_cnt),\n\t\t\t   first_peer_device(device)->connection->epochs,\n\t\t\t   write_ordering_chars[device->resource->write_ordering]\n\t\t\t);\n\t\t\tseq_printf(seq, \" oos:%llu\\n\",\n\t\t\t\t   Bit2KB((unsigned long long)\n\t\t\t\t\t   drbd_bm_total_weight(device)));\n\t\t}\n\t\tif (state.conn == C_SYNC_SOURCE ||\n\t\t    state.conn == C_SYNC_TARGET ||\n\t\t    state.conn == C_VERIFY_S ||\n\t\t    state.conn == C_VERIFY_T)\n\t\t\tdrbd_syncer_progress(device, seq, state);\n\n\t\tif (drbd_proc_details >= 1 && get_ldev_if_state(device, D_FAILED)) {\n\t\t\tlc_seq_printf_stats(seq, device->resync);\n\t\t\tlc_seq_printf_stats(seq, device->act_log);\n\t\t\tput_ldev(device);\n\t\t}\n\n\t\tif (drbd_proc_details >= 2)\n\t\t\tseq_printf(seq, \"\\tblocked on activity log: %d\\n\", atomic_read(&device->ap_actlog_cnt));\n\t}\n\trcu_read_unlock();\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}