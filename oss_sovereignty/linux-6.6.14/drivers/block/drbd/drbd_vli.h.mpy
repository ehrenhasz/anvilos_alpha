{
  "module_name": "drbd_vli.h",
  "hash_id": "7da62cb79a1f3af0bf1fd674a62aebf8a94020914cfa7dda1e4ee9980ecb8887",
  "original_prompt": "Ingested from linux-6.6.14/drivers/block/drbd/drbd_vli.h",
  "human_readable_source": " \n \n\n#ifndef _DRBD_VLI_H\n#define _DRBD_VLI_H\n\n \n\n \n\n \n\n \n\n \n#define VLI_L_1_1() do { \\\n\tLEVEL( 2, 1, 0x00); \\\n\tLEVEL( 3, 2, 0x01); \\\n\tLEVEL( 5, 3, 0x03); \\\n\tLEVEL( 7, 4, 0x07); \\\n\tLEVEL(10, 5, 0x0f); \\\n\tLEVEL(14, 6, 0x1f); \\\n\tLEVEL(21, 8, 0x3f); \\\n\tLEVEL(29, 8, 0x7f); \\\n\tLEVEL(42, 8, 0xbf); \\\n\tLEVEL(64, 8, 0xff); \\\n\t} while (0)\n\n \nstatic inline int vli_decode_bits(u64 *out, const u64 in)\n{\n\tu64 adj = 1;\n\n#define LEVEL(t,b,v)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif ((in & ((1 << b) -1)) == v) {\t\\\n\t\t\t*out = ((in & ((~0ULL) >> (64-t))) >> b) + adj;\t\\\n\t\t\treturn t;\t\t\t\\\n\t\t}\t\t\t\t\t\\\n\t\tadj += 1ULL << (t - b);\t\t\t\\\n\t} while (0)\n\n\tVLI_L_1_1();\n\n\t \n\tBUG();\n#undef LEVEL\n}\n\n \nstatic inline int __vli_encode_bits(u64 *out, const u64 in)\n{\n\tu64 max = 0;\n\tu64 adj = 1;\n\n\tif (in == 0)\n\t\treturn -EINVAL;\n\n#define LEVEL(t,b,v) do {\t\t\\\n\t\tmax += 1ULL << (t - b);\t\\\n\t\tif (in <= max) {\t\\\n\t\t\tif (out)\t\\\n\t\t\t\t*out = ((in - adj) << b) | v;\t\\\n\t\t\treturn t;\t\\\n\t\t}\t\t\t\\\n\t\tadj = max + 1;\t\t\\\n\t} while (0)\n\n\tVLI_L_1_1();\n\n\treturn -EOVERFLOW;\n#undef LEVEL\n}\n\n#undef VLI_L_1_1\n\n \n\n \n\n \nstruct bitstream_cursor {\n\t \n\tu8 *b;\n\t \n\tunsigned int bit;\n};\n\n \nstatic inline void bitstream_cursor_reset(struct bitstream_cursor *cur, void *s)\n{\n\tcur->b = s;\n\tcur->bit = 0;\n}\n\n \nstatic inline void bitstream_cursor_advance(struct bitstream_cursor *cur, unsigned int bits)\n{\n\tbits += cur->bit;\n\tcur->b = cur->b + (bits >> 3);\n\tcur->bit = bits & 7;\n}\n\n \nstruct bitstream {\n\tstruct bitstream_cursor cur;\n\tunsigned char *buf;\n\tsize_t buf_len;\t\t \n\n\t \n\tunsigned int pad_bits;\n};\n\nstatic inline void bitstream_init(struct bitstream *bs, void *s, size_t len, unsigned int pad_bits)\n{\n\tbs->buf = s;\n\tbs->buf_len = len;\n\tbs->pad_bits = pad_bits;\n\tbitstream_cursor_reset(&bs->cur, bs->buf);\n}\n\nstatic inline void bitstream_rewind(struct bitstream *bs)\n{\n\tbitstream_cursor_reset(&bs->cur, bs->buf);\n\tmemset(bs->buf, 0, bs->buf_len);\n}\n\n \nstatic inline int bitstream_put_bits(struct bitstream *bs, u64 val, const unsigned int bits)\n{\n\tunsigned char *b = bs->cur.b;\n\tunsigned int tmp;\n\n\tif (bits == 0)\n\t\treturn 0;\n\n\tif ((bs->cur.b + ((bs->cur.bit + bits -1) >> 3)) - bs->buf >= bs->buf_len)\n\t\treturn -ENOBUFS;\n\n\t \n\tif (bits < 64)\n\t\tval &= ~0ULL >> (64 - bits);\n\n\t*b++ |= (val & 0xff) << bs->cur.bit;\n\n\tfor (tmp = 8 - bs->cur.bit; tmp < bits; tmp += 8)\n\t\t*b++ |= (val >> tmp) & 0xff;\n\n\tbitstream_cursor_advance(&bs->cur, bits);\n\treturn bits;\n}\n\n \nstatic inline int bitstream_get_bits(struct bitstream *bs, u64 *out, int bits)\n{\n\tu64 val;\n\tunsigned int n;\n\n\tif (bits > 64)\n\t\treturn -EINVAL;\n\n\tif (bs->cur.b + ((bs->cur.bit + bs->pad_bits + bits -1) >> 3) - bs->buf >= bs->buf_len)\n\t\tbits = ((bs->buf_len - (bs->cur.b - bs->buf)) << 3)\n\t\t\t- bs->cur.bit - bs->pad_bits;\n\n\tif (bits == 0) {\n\t\t*out = 0;\n\t\treturn 0;\n\t}\n\n\t \n\tval = 0;\n\tn = (bs->cur.bit + bits + 7) >> 3;\n\t \n\t \n\tif (n) {\n\t\tmemcpy(&val, bs->cur.b+1, n - 1);\n\t\tval = le64_to_cpu(val) << (8 - bs->cur.bit);\n\t}\n\n\t \n\tval |= bs->cur.b[0] >> bs->cur.bit;\n\n\t \n\tval &= ~0ULL >> (64 - bits);\n\n\tbitstream_cursor_advance(&bs->cur, bits);\n\t*out = val;\n\n\treturn bits;\n}\n\n \nstatic inline int vli_encode_bits(struct bitstream *bs, u64 in)\n{\n\tu64 code;\n\tint bits = __vli_encode_bits(&code, in);\n\n\tif (bits <= 0)\n\t\treturn bits;\n\n\treturn bitstream_put_bits(bs, code, bits);\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}