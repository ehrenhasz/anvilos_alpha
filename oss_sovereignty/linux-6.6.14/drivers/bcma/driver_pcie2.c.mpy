{
  "module_name": "driver_pcie2.c",
  "hash_id": "bbb6aefcb8d9c3c64611e9ae455f13320dc11f8a4a6c9854b0660069272470eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/bcma/driver_pcie2.c",
  "human_readable_source": " \n\n#include \"bcma_private.h\"\n#include <linux/bcma/bcma.h>\n#include <linux/pci.h>\n\n \n\n#if 0\nstatic u32 bcma_core_pcie2_cfg_read(struct bcma_drv_pcie2 *pcie2, u32 addr)\n{\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, addr);\n\tpcie2_read32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR);\n\treturn pcie2_read32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA);\n}\n#endif\n\nstatic void bcma_core_pcie2_cfg_write(struct bcma_drv_pcie2 *pcie2, u32 addr,\n\t\t\t\t      u32 val)\n{\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, addr);\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, val);\n}\n\n \n\nstatic u32 bcma_core_pcie2_war_delay_perst_enab(struct bcma_drv_pcie2 *pcie2,\n\t\t\t\t\t\tbool enable)\n{\n\tu32 val;\n\n\t \n\tval = pcie2_read32(pcie2, BCMA_CORE_PCIE2_CLK_CONTROL);\n\tval |= PCIE2_CLKC_DLYPERST;\n\tval &= ~PCIE2_CLKC_DISSPROMLD;\n\tif (enable) {\n\t\tval &= ~PCIE2_CLKC_DLYPERST;\n\t\tval |= PCIE2_CLKC_DISSPROMLD;\n\t}\n\tpcie2_write32(pcie2, (BCMA_CORE_PCIE2_CLK_CONTROL), val);\n\t \n\treturn pcie2_read32(pcie2, BCMA_CORE_PCIE2_CLK_CONTROL);\n}\n\nstatic void bcma_core_pcie2_set_ltr_vals(struct bcma_drv_pcie2 *pcie2)\n{\n\t \n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, 0x844);\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x883c883c);\n\t \n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, 0x848);\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x88648864);\n\t \n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, 0x84C);\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x90039003);\n}\n\nstatic void bcma_core_pcie2_hw_ltr_war(struct bcma_drv_pcie2 *pcie2)\n{\n\tu8 core_rev = pcie2->core->id.rev;\n\tu32 devstsctr2;\n\n\tif (core_rev < 2 || core_rev == 10 || core_rev > 13)\n\t\treturn;\n\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\n\t\t      PCIE2_CAP_DEVSTSCTRL2_OFFSET);\n\tdevstsctr2 = pcie2_read32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA);\n\tif (devstsctr2 & PCIE2_CAP_DEVSTSCTRL2_LTRENAB) {\n\t\t \n\t\tbcma_core_pcie2_set_ltr_vals(pcie2);\n\n\t\t \n\n\t\t \n\t\tdevstsctr2 |= PCIE2_CAP_DEVSTSCTRL2_LTRENAB;\n\t\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\n\t\t\t      PCIE2_CAP_DEVSTSCTRL2_OFFSET);\n\t\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, devstsctr2);\n\n\t\t \n\t\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_LTR_STATE,\n\t\t\t      PCIE2_LTR_ACTIVE);\n\t\tusleep_range(1000, 2000);\n\n\t\t \n\t\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_LTR_STATE,\n\t\t\t      PCIE2_LTR_SLEEP);\n\t\tusleep_range(1000, 2000);\n\t}\n}\n\nstatic void pciedev_crwlpciegen2(struct bcma_drv_pcie2 *pcie2)\n{\n\tu8 core_rev = pcie2->core->id.rev;\n\tbool pciewar160, pciewar162;\n\n\tpciewar160 = core_rev == 7 || core_rev == 9 || core_rev == 11;\n\tpciewar162 = core_rev == 5 || core_rev == 7 || core_rev == 8 ||\n\t\t     core_rev == 9 || core_rev == 11;\n\n\tif (!pciewar160 && !pciewar162)\n\t\treturn;\n\n \n#if 0\n\tpcie2_set32(pcie2, BCMA_CORE_PCIE2_CLK_CONTROL,\n\t\t    PCIE_DISABLE_L1CLK_GATING);\n#if 0\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\n\t\t      PCIEGEN2_COE_PVT_TL_CTRL_0);\n\tpcie2_mask32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA,\n\t\t     ~(1 << COE_PVT_TL_CTRL_0_PM_DIS_L1_REENTRY_BIT));\n#endif\n#endif\n}\n\nstatic void pciedev_crwlpciegen2_180(struct bcma_drv_pcie2 *pcie2)\n{\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, PCIE2_PMCR_REFUP);\n\tpcie2_set32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x1f);\n}\n\nstatic void pciedev_crwlpciegen2_182(struct bcma_drv_pcie2 *pcie2)\n{\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, PCIE2_SBMBX);\n\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 1 << 0);\n}\n\nstatic void pciedev_reg_pm_clk_period(struct bcma_drv_pcie2 *pcie2)\n{\n\tstruct bcma_drv_cc *drv_cc = &pcie2->core->bus->drv_cc;\n\tu8 core_rev = pcie2->core->id.rev;\n\tu32 alp_khz, pm_value;\n\n\tif (core_rev <= 13) {\n\t\talp_khz = bcma_pmu_get_alp_clock(drv_cc) / 1000;\n\t\tpm_value = (1000000 * 2) / alp_khz;\n\t\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\n\t\t\t      PCIE2_PVT_REG_PM_CLK_PERIOD);\n\t\tpcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, pm_value);\n\t}\n}\n\nvoid bcma_core_pcie2_init(struct bcma_drv_pcie2 *pcie2)\n{\n\tstruct bcma_bus *bus = pcie2->core->bus;\n\tstruct bcma_chipinfo *ci = &bus->chipinfo;\n\tu32 tmp;\n\n\ttmp = pcie2_read32(pcie2, BCMA_CORE_PCIE2_SPROM(54));\n\tif ((tmp & 0xe) >> 1 == 2)\n\t\tbcma_core_pcie2_cfg_write(pcie2, 0x4e0, 0x17);\n\n\tswitch (bus->chipinfo.id) {\n\tcase BCMA_CHIP_ID_BCM4360:\n\tcase BCMA_CHIP_ID_BCM4352:\n\t\tpcie2->reqsize = 1024;\n\t\tbreak;\n\tdefault:\n\t\tpcie2->reqsize = 128;\n\t\tbreak;\n\t}\n\n\tif (ci->id == BCMA_CHIP_ID_BCM4360 && ci->rev > 3)\n\t\tbcma_core_pcie2_war_delay_perst_enab(pcie2, true);\n\tbcma_core_pcie2_hw_ltr_war(pcie2);\n\tpciedev_crwlpciegen2(pcie2);\n\tpciedev_reg_pm_clk_period(pcie2);\n\tpciedev_crwlpciegen2_180(pcie2);\n\tpciedev_crwlpciegen2_182(pcie2);\n}\n\n \n\nvoid bcma_core_pcie2_up(struct bcma_drv_pcie2 *pcie2)\n{\n\tstruct bcma_bus *bus = pcie2->core->bus;\n\tstruct pci_dev *dev = bus->host_pci;\n\tint err;\n\n\terr = pcie_set_readrq(dev, pcie2->reqsize);\n\tif (err)\n\t\tbcma_err(bus, \"Error setting PCI_EXP_DEVCTL_READRQ: %d\\n\", err);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}