{
  "module_name": "sprom.c",
  "hash_id": "eb615bab9c2fe951069a10854eb4f46294b6ee9eea0ca39060a0e95962585ccc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/bcma/sprom.c",
  "human_readable_source": " \n\n#include \"bcma_private.h\"\n\n#include <linux/bcma/bcma.h>\n#include <linux/bcma/bcma_regs.h>\n#include <linux/pci.h>\n#include <linux/io.h>\n#include <linux/dma-mapping.h>\n#include <linux/slab.h>\n\nstatic int(*get_fallback_sprom)(struct bcma_bus *dev, struct ssb_sprom *out);\n\n \nint bcma_arch_register_fallback_sprom(int (*sprom_callback)(struct bcma_bus *bus,\n\t\t\t\t     struct ssb_sprom *out))\n{\n\tif (get_fallback_sprom)\n\t\treturn -EEXIST;\n\tget_fallback_sprom = sprom_callback;\n\n\treturn 0;\n}\n\nstatic int bcma_fill_sprom_with_fallback(struct bcma_bus *bus,\n\t\t\t\t\t struct ssb_sprom *out)\n{\n\tint err;\n\n\tif (!get_fallback_sprom) {\n\t\terr = -ENOENT;\n\t\tgoto fail;\n\t}\n\n\terr = get_fallback_sprom(bus, out);\n\tif (err)\n\t\tgoto fail;\n\n\tbcma_debug(bus, \"Using SPROM revision %d provided by platform.\\n\",\n\t\t   bus->sprom.revision);\n\treturn 0;\nfail:\n\tbcma_warn(bus, \"Using fallback SPROM failed (err %d)\\n\", err);\n\treturn err;\n}\n\n \n\nstatic void bcma_sprom_read(struct bcma_bus *bus, u16 offset, u16 *sprom,\n\t\t\t    size_t words)\n{\n\tint i;\n\tfor (i = 0; i < words; i++)\n\t\tsprom[i] = bcma_read16(bus->drv_cc.core, offset + (i * 2));\n}\n\n \n\nstatic inline u8 bcma_crc8(u8 crc, u8 data)\n{\n\t \n\tstatic const u8 t[] = {\n\t\t0x00, 0xF7, 0xB9, 0x4E, 0x25, 0xD2, 0x9C, 0x6B,\n\t\t0x4A, 0xBD, 0xF3, 0x04, 0x6F, 0x98, 0xD6, 0x21,\n\t\t0x94, 0x63, 0x2D, 0xDA, 0xB1, 0x46, 0x08, 0xFF,\n\t\t0xDE, 0x29, 0x67, 0x90, 0xFB, 0x0C, 0x42, 0xB5,\n\t\t0x7F, 0x88, 0xC6, 0x31, 0x5A, 0xAD, 0xE3, 0x14,\n\t\t0x35, 0xC2, 0x8C, 0x7B, 0x10, 0xE7, 0xA9, 0x5E,\n\t\t0xEB, 0x1C, 0x52, 0xA5, 0xCE, 0x39, 0x77, 0x80,\n\t\t0xA1, 0x56, 0x18, 0xEF, 0x84, 0x73, 0x3D, 0xCA,\n\t\t0xFE, 0x09, 0x47, 0xB0, 0xDB, 0x2C, 0x62, 0x95,\n\t\t0xB4, 0x43, 0x0D, 0xFA, 0x91, 0x66, 0x28, 0xDF,\n\t\t0x6A, 0x9D, 0xD3, 0x24, 0x4F, 0xB8, 0xF6, 0x01,\n\t\t0x20, 0xD7, 0x99, 0x6E, 0x05, 0xF2, 0xBC, 0x4B,\n\t\t0x81, 0x76, 0x38, 0xCF, 0xA4, 0x53, 0x1D, 0xEA,\n\t\t0xCB, 0x3C, 0x72, 0x85, 0xEE, 0x19, 0x57, 0xA0,\n\t\t0x15, 0xE2, 0xAC, 0x5B, 0x30, 0xC7, 0x89, 0x7E,\n\t\t0x5F, 0xA8, 0xE6, 0x11, 0x7A, 0x8D, 0xC3, 0x34,\n\t\t0xAB, 0x5C, 0x12, 0xE5, 0x8E, 0x79, 0x37, 0xC0,\n\t\t0xE1, 0x16, 0x58, 0xAF, 0xC4, 0x33, 0x7D, 0x8A,\n\t\t0x3F, 0xC8, 0x86, 0x71, 0x1A, 0xED, 0xA3, 0x54,\n\t\t0x75, 0x82, 0xCC, 0x3B, 0x50, 0xA7, 0xE9, 0x1E,\n\t\t0xD4, 0x23, 0x6D, 0x9A, 0xF1, 0x06, 0x48, 0xBF,\n\t\t0x9E, 0x69, 0x27, 0xD0, 0xBB, 0x4C, 0x02, 0xF5,\n\t\t0x40, 0xB7, 0xF9, 0x0E, 0x65, 0x92, 0xDC, 0x2B,\n\t\t0x0A, 0xFD, 0xB3, 0x44, 0x2F, 0xD8, 0x96, 0x61,\n\t\t0x55, 0xA2, 0xEC, 0x1B, 0x70, 0x87, 0xC9, 0x3E,\n\t\t0x1F, 0xE8, 0xA6, 0x51, 0x3A, 0xCD, 0x83, 0x74,\n\t\t0xC1, 0x36, 0x78, 0x8F, 0xE4, 0x13, 0x5D, 0xAA,\n\t\t0x8B, 0x7C, 0x32, 0xC5, 0xAE, 0x59, 0x17, 0xE0,\n\t\t0x2A, 0xDD, 0x93, 0x64, 0x0F, 0xF8, 0xB6, 0x41,\n\t\t0x60, 0x97, 0xD9, 0x2E, 0x45, 0xB2, 0xFC, 0x0B,\n\t\t0xBE, 0x49, 0x07, 0xF0, 0x9B, 0x6C, 0x22, 0xD5,\n\t\t0xF4, 0x03, 0x4D, 0xBA, 0xD1, 0x26, 0x68, 0x9F,\n\t};\n\treturn t[crc ^ data];\n}\n\nstatic u8 bcma_sprom_crc(const u16 *sprom, size_t words)\n{\n\tint word;\n\tu8 crc = 0xFF;\n\n\tfor (word = 0; word < words - 1; word++) {\n\t\tcrc = bcma_crc8(crc, sprom[word] & 0x00FF);\n\t\tcrc = bcma_crc8(crc, (sprom[word] & 0xFF00) >> 8);\n\t}\n\tcrc = bcma_crc8(crc, sprom[words - 1] & 0x00FF);\n\tcrc ^= 0xFF;\n\n\treturn crc;\n}\n\nstatic int bcma_sprom_check_crc(const u16 *sprom, size_t words)\n{\n\tu8 crc;\n\tu8 expected_crc;\n\tu16 tmp;\n\n\tcrc = bcma_sprom_crc(sprom, words);\n\ttmp = sprom[words - 1] & SSB_SPROM_REVISION_CRC;\n\texpected_crc = tmp >> SSB_SPROM_REVISION_CRC_SHIFT;\n\tif (crc != expected_crc)\n\t\treturn -EPROTO;\n\n\treturn 0;\n}\n\nstatic int bcma_sprom_valid(struct bcma_bus *bus, const u16 *sprom,\n\t\t\t    size_t words)\n{\n\tu16 revision;\n\tint err;\n\n\terr = bcma_sprom_check_crc(sprom, words);\n\tif (err)\n\t\treturn err;\n\n\trevision = sprom[words - 1] & SSB_SPROM_REVISION_REV;\n\tif (revision < 8 || revision > 11) {\n\t\tpr_err(\"Unsupported SPROM revision: %d\\n\", revision);\n\t\treturn -ENOENT;\n\t}\n\n\tbus->sprom.revision = revision;\n\tbcma_debug(bus, \"Found SPROM revision %d\\n\", revision);\n\n\treturn 0;\n}\n\n \n\n#define SPOFF(offset)\t((offset) / sizeof(u16))\n\n#define SPEX(_field, _offset, _mask, _shift)\t\\\n\tbus->sprom._field = ((sprom[SPOFF(_offset)] & (_mask)) >> (_shift))\n\n#define SPEX32(_field, _offset, _mask, _shift)\t\\\n\tbus->sprom._field = ((((u32)sprom[SPOFF((_offset)+2)] << 16 | \\\n\t\t\t\tsprom[SPOFF(_offset)]) & (_mask)) >> (_shift))\n\n#define SPEX_ARRAY8(_field, _offset, _mask, _shift)\t\\\n\tdo {\t\\\n\t\tSPEX(_field[0], _offset +  0, _mask, _shift);\t\\\n\t\tSPEX(_field[1], _offset +  2, _mask, _shift);\t\\\n\t\tSPEX(_field[2], _offset +  4, _mask, _shift);\t\\\n\t\tSPEX(_field[3], _offset +  6, _mask, _shift);\t\\\n\t\tSPEX(_field[4], _offset +  8, _mask, _shift);\t\\\n\t\tSPEX(_field[5], _offset + 10, _mask, _shift);\t\\\n\t\tSPEX(_field[6], _offset + 12, _mask, _shift);\t\\\n\t\tSPEX(_field[7], _offset + 14, _mask, _shift);\t\\\n\t} while (0)\n\nstatic s8 sprom_extract_antgain(const u16 *in, u16 offset, u16 mask, u16 shift)\n{\n\tu16 v;\n\tu8 gain;\n\n\tv = in[SPOFF(offset)];\n\tgain = (v & mask) >> shift;\n\tif (gain == 0xFF) {\n\t\tgain = 8;  \n\t} else {\n\t\t \n\t\tgain = ((gain & 0xC0) >> 6) | ((gain & 0x3F) << 2);\n\t}\n\n\treturn (s8)gain;\n}\n\nstatic void bcma_sprom_extract_r8(struct bcma_bus *bus, const u16 *sprom)\n{\n\tu16 v, o;\n\tint i;\n\tstatic const u16 pwr_info_offset[] = {\n\t\tSSB_SROM8_PWR_INFO_CORE0, SSB_SROM8_PWR_INFO_CORE1,\n\t\tSSB_SROM8_PWR_INFO_CORE2, SSB_SROM8_PWR_INFO_CORE3\n\t};\n\tBUILD_BUG_ON(ARRAY_SIZE(pwr_info_offset) !=\n\t\t\tARRAY_SIZE(bus->sprom.core_pwr_info));\n\n\tfor (i = 0; i < 3; i++) {\n\t\tv = sprom[SPOFF(SSB_SPROM8_IL0MAC) + i];\n\t\t*(((__be16 *)bus->sprom.il0mac) + i) = cpu_to_be16(v);\n\t}\n\n\tSPEX(board_rev, SSB_SPROM8_BOARDREV, ~0, 0);\n\tSPEX(board_type, SSB_SPROM1_SPID, ~0, 0);\n\n\tSPEX(txpid2g[0], SSB_SPROM4_TXPID2G01, SSB_SPROM4_TXPID2G0,\n\t     SSB_SPROM4_TXPID2G0_SHIFT);\n\tSPEX(txpid2g[1], SSB_SPROM4_TXPID2G01, SSB_SPROM4_TXPID2G1,\n\t     SSB_SPROM4_TXPID2G1_SHIFT);\n\tSPEX(txpid2g[2], SSB_SPROM4_TXPID2G23, SSB_SPROM4_TXPID2G2,\n\t     SSB_SPROM4_TXPID2G2_SHIFT);\n\tSPEX(txpid2g[3], SSB_SPROM4_TXPID2G23, SSB_SPROM4_TXPID2G3,\n\t     SSB_SPROM4_TXPID2G3_SHIFT);\n\n\tSPEX(txpid5gl[0], SSB_SPROM4_TXPID5GL01, SSB_SPROM4_TXPID5GL0,\n\t     SSB_SPROM4_TXPID5GL0_SHIFT);\n\tSPEX(txpid5gl[1], SSB_SPROM4_TXPID5GL01, SSB_SPROM4_TXPID5GL1,\n\t     SSB_SPROM4_TXPID5GL1_SHIFT);\n\tSPEX(txpid5gl[2], SSB_SPROM4_TXPID5GL23, SSB_SPROM4_TXPID5GL2,\n\t     SSB_SPROM4_TXPID5GL2_SHIFT);\n\tSPEX(txpid5gl[3], SSB_SPROM4_TXPID5GL23, SSB_SPROM4_TXPID5GL3,\n\t     SSB_SPROM4_TXPID5GL3_SHIFT);\n\n\tSPEX(txpid5g[0], SSB_SPROM4_TXPID5G01, SSB_SPROM4_TXPID5G0,\n\t     SSB_SPROM4_TXPID5G0_SHIFT);\n\tSPEX(txpid5g[1], SSB_SPROM4_TXPID5G01, SSB_SPROM4_TXPID5G1,\n\t     SSB_SPROM4_TXPID5G1_SHIFT);\n\tSPEX(txpid5g[2], SSB_SPROM4_TXPID5G23, SSB_SPROM4_TXPID5G2,\n\t     SSB_SPROM4_TXPID5G2_SHIFT);\n\tSPEX(txpid5g[3], SSB_SPROM4_TXPID5G23, SSB_SPROM4_TXPID5G3,\n\t     SSB_SPROM4_TXPID5G3_SHIFT);\n\n\tSPEX(txpid5gh[0], SSB_SPROM4_TXPID5GH01, SSB_SPROM4_TXPID5GH0,\n\t     SSB_SPROM4_TXPID5GH0_SHIFT);\n\tSPEX(txpid5gh[1], SSB_SPROM4_TXPID5GH01, SSB_SPROM4_TXPID5GH1,\n\t     SSB_SPROM4_TXPID5GH1_SHIFT);\n\tSPEX(txpid5gh[2], SSB_SPROM4_TXPID5GH23, SSB_SPROM4_TXPID5GH2,\n\t     SSB_SPROM4_TXPID5GH2_SHIFT);\n\tSPEX(txpid5gh[3], SSB_SPROM4_TXPID5GH23, SSB_SPROM4_TXPID5GH3,\n\t     SSB_SPROM4_TXPID5GH3_SHIFT);\n\n\tSPEX(boardflags_lo, SSB_SPROM8_BFLLO, ~0, 0);\n\tSPEX(boardflags_hi, SSB_SPROM8_BFLHI, ~0, 0);\n\tSPEX(boardflags2_lo, SSB_SPROM8_BFL2LO, ~0, 0);\n\tSPEX(boardflags2_hi, SSB_SPROM8_BFL2HI, ~0, 0);\n\n\tSPEX(alpha2[0], SSB_SPROM8_CCODE, 0xff00, 8);\n\tSPEX(alpha2[1], SSB_SPROM8_CCODE, 0x00ff, 0);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(pwr_info_offset); i++) {\n\t\to = pwr_info_offset[i];\n\t\tSPEX(core_pwr_info[i].itssi_2g, o + SSB_SROM8_2G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_2G_ITSSI, SSB_SPROM8_2G_ITSSI_SHIFT);\n\t\tSPEX(core_pwr_info[i].maxpwr_2g, o + SSB_SROM8_2G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_2G_MAXP, 0);\n\n\t\tSPEX(core_pwr_info[i].pa_2g[0], o + SSB_SROM8_2G_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[1], o + SSB_SROM8_2G_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[2], o + SSB_SROM8_2G_PA_2, ~0, 0);\n\n\t\tSPEX(core_pwr_info[i].itssi_5g, o + SSB_SROM8_5G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_5G_ITSSI, SSB_SPROM8_5G_ITSSI_SHIFT);\n\t\tSPEX(core_pwr_info[i].maxpwr_5g, o + SSB_SROM8_5G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_5G_MAXP, 0);\n\t\tSPEX(core_pwr_info[i].maxpwr_5gh, o + SSB_SPROM8_5GHL_MAXP,\n\t\t\tSSB_SPROM8_5GH_MAXP, 0);\n\t\tSPEX(core_pwr_info[i].maxpwr_5gl, o + SSB_SPROM8_5GHL_MAXP,\n\t\t\tSSB_SPROM8_5GL_MAXP, SSB_SPROM8_5GL_MAXP_SHIFT);\n\n\t\tSPEX(core_pwr_info[i].pa_5gl[0], o + SSB_SROM8_5GL_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[1], o + SSB_SROM8_5GL_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[2], o + SSB_SROM8_5GL_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[0], o + SSB_SROM8_5G_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[1], o + SSB_SROM8_5G_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[2], o + SSB_SROM8_5G_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[0], o + SSB_SROM8_5GH_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[1], o + SSB_SROM8_5GH_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[2], o + SSB_SROM8_5GH_PA_2, ~0, 0);\n\t}\n\n\tSPEX(fem.ghz2.tssipos, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_TSSIPOS,\n\t     SSB_SROM8_FEM_TSSIPOS_SHIFT);\n\tSPEX(fem.ghz2.extpa_gain, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_EXTPA_GAIN,\n\t     SSB_SROM8_FEM_EXTPA_GAIN_SHIFT);\n\tSPEX(fem.ghz2.pdet_range, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_PDET_RANGE,\n\t     SSB_SROM8_FEM_PDET_RANGE_SHIFT);\n\tSPEX(fem.ghz2.tr_iso, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_TR_ISO,\n\t     SSB_SROM8_FEM_TR_ISO_SHIFT);\n\tSPEX(fem.ghz2.antswlut, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_ANTSWLUT,\n\t     SSB_SROM8_FEM_ANTSWLUT_SHIFT);\n\n\tSPEX(fem.ghz5.tssipos, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_TSSIPOS,\n\t     SSB_SROM8_FEM_TSSIPOS_SHIFT);\n\tSPEX(fem.ghz5.extpa_gain, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_EXTPA_GAIN,\n\t     SSB_SROM8_FEM_EXTPA_GAIN_SHIFT);\n\tSPEX(fem.ghz5.pdet_range, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_PDET_RANGE,\n\t     SSB_SROM8_FEM_PDET_RANGE_SHIFT);\n\tSPEX(fem.ghz5.tr_iso, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_TR_ISO,\n\t     SSB_SROM8_FEM_TR_ISO_SHIFT);\n\tSPEX(fem.ghz5.antswlut, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_ANTSWLUT,\n\t     SSB_SROM8_FEM_ANTSWLUT_SHIFT);\n\n\tSPEX(ant_available_a, SSB_SPROM8_ANTAVAIL, SSB_SPROM8_ANTAVAIL_A,\n\t     SSB_SPROM8_ANTAVAIL_A_SHIFT);\n\tSPEX(ant_available_bg, SSB_SPROM8_ANTAVAIL, SSB_SPROM8_ANTAVAIL_BG,\n\t     SSB_SPROM8_ANTAVAIL_BG_SHIFT);\n\tSPEX(maxpwr_bg, SSB_SPROM8_MAXP_BG, SSB_SPROM8_MAXP_BG_MASK, 0);\n\tSPEX(itssi_bg, SSB_SPROM8_MAXP_BG, SSB_SPROM8_ITSSI_BG,\n\t     SSB_SPROM8_ITSSI_BG_SHIFT);\n\tSPEX(maxpwr_a, SSB_SPROM8_MAXP_A, SSB_SPROM8_MAXP_A_MASK, 0);\n\tSPEX(itssi_a, SSB_SPROM8_MAXP_A, SSB_SPROM8_ITSSI_A,\n\t     SSB_SPROM8_ITSSI_A_SHIFT);\n\tSPEX(maxpwr_ah, SSB_SPROM8_MAXP_AHL, SSB_SPROM8_MAXP_AH_MASK, 0);\n\tSPEX(maxpwr_al, SSB_SPROM8_MAXP_AHL, SSB_SPROM8_MAXP_AL_MASK,\n\t     SSB_SPROM8_MAXP_AL_SHIFT);\n\tSPEX(gpio0, SSB_SPROM8_GPIOA, SSB_SPROM8_GPIOA_P0, 0);\n\tSPEX(gpio1, SSB_SPROM8_GPIOA, SSB_SPROM8_GPIOA_P1,\n\t     SSB_SPROM8_GPIOA_P1_SHIFT);\n\tSPEX(gpio2, SSB_SPROM8_GPIOB, SSB_SPROM8_GPIOB_P2, 0);\n\tSPEX(gpio3, SSB_SPROM8_GPIOB, SSB_SPROM8_GPIOB_P3,\n\t     SSB_SPROM8_GPIOB_P3_SHIFT);\n\tSPEX(tri2g, SSB_SPROM8_TRI25G, SSB_SPROM8_TRI2G, 0);\n\tSPEX(tri5g, SSB_SPROM8_TRI25G, SSB_SPROM8_TRI5G,\n\t     SSB_SPROM8_TRI5G_SHIFT);\n\tSPEX(tri5gl, SSB_SPROM8_TRI5GHL, SSB_SPROM8_TRI5GL, 0);\n\tSPEX(tri5gh, SSB_SPROM8_TRI5GHL, SSB_SPROM8_TRI5GH,\n\t     SSB_SPROM8_TRI5GH_SHIFT);\n\tSPEX(rxpo2g, SSB_SPROM8_RXPO, SSB_SPROM8_RXPO2G,\n\t     SSB_SPROM8_RXPO2G_SHIFT);\n\tSPEX(rxpo5g, SSB_SPROM8_RXPO, SSB_SPROM8_RXPO5G,\n\t     SSB_SPROM8_RXPO5G_SHIFT);\n\tSPEX(rssismf2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISMF2G, 0);\n\tSPEX(rssismc2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISMC2G,\n\t     SSB_SPROM8_RSSISMC2G_SHIFT);\n\tSPEX(rssisav2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISAV2G,\n\t     SSB_SPROM8_RSSISAV2G_SHIFT);\n\tSPEX(bxa2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_BXA2G,\n\t     SSB_SPROM8_BXA2G_SHIFT);\n\tSPEX(rssismf5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISMF5G, 0);\n\tSPEX(rssismc5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISMC5G,\n\t     SSB_SPROM8_RSSISMC5G_SHIFT);\n\tSPEX(rssisav5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISAV5G,\n\t     SSB_SPROM8_RSSISAV5G_SHIFT);\n\tSPEX(bxa5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_BXA5G,\n\t     SSB_SPROM8_BXA5G_SHIFT);\n\n\tSPEX(pa0b0, SSB_SPROM8_PA0B0, ~0, 0);\n\tSPEX(pa0b1, SSB_SPROM8_PA0B1, ~0, 0);\n\tSPEX(pa0b2, SSB_SPROM8_PA0B2, ~0, 0);\n\tSPEX(pa1b0, SSB_SPROM8_PA1B0, ~0, 0);\n\tSPEX(pa1b1, SSB_SPROM8_PA1B1, ~0, 0);\n\tSPEX(pa1b2, SSB_SPROM8_PA1B2, ~0, 0);\n\tSPEX(pa1lob0, SSB_SPROM8_PA1LOB0, ~0, 0);\n\tSPEX(pa1lob1, SSB_SPROM8_PA1LOB1, ~0, 0);\n\tSPEX(pa1lob2, SSB_SPROM8_PA1LOB2, ~0, 0);\n\tSPEX(pa1hib0, SSB_SPROM8_PA1HIB0, ~0, 0);\n\tSPEX(pa1hib1, SSB_SPROM8_PA1HIB1, ~0, 0);\n\tSPEX(pa1hib2, SSB_SPROM8_PA1HIB2, ~0, 0);\n\tSPEX(cck2gpo, SSB_SPROM8_CCK2GPO, ~0, 0);\n\tSPEX32(ofdm2gpo, SSB_SPROM8_OFDM2GPO, ~0, 0);\n\tSPEX32(ofdm5glpo, SSB_SPROM8_OFDM5GLPO, ~0, 0);\n\tSPEX32(ofdm5gpo, SSB_SPROM8_OFDM5GPO, ~0, 0);\n\tSPEX32(ofdm5ghpo, SSB_SPROM8_OFDM5GHPO, ~0, 0);\n\n\t \n\tbus->sprom.antenna_gain.a0 = sprom_extract_antgain(sprom,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN01,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN0,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN0_SHIFT);\n\tbus->sprom.antenna_gain.a1 = sprom_extract_antgain(sprom,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN01,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN1,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN1_SHIFT);\n\tbus->sprom.antenna_gain.a2 = sprom_extract_antgain(sprom,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN23,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN2,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN2_SHIFT);\n\tbus->sprom.antenna_gain.a3 = sprom_extract_antgain(sprom,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN23,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN3,\n\t\t\t\t\t\t\t   SSB_SPROM8_AGAIN3_SHIFT);\n\n\tSPEX(leddc_on_time, SSB_SPROM8_LEDDC, SSB_SPROM8_LEDDC_ON,\n\t     SSB_SPROM8_LEDDC_ON_SHIFT);\n\tSPEX(leddc_off_time, SSB_SPROM8_LEDDC, SSB_SPROM8_LEDDC_OFF,\n\t     SSB_SPROM8_LEDDC_OFF_SHIFT);\n\n\tSPEX(txchain, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_TXCHAIN,\n\t     SSB_SPROM8_TXRXC_TXCHAIN_SHIFT);\n\tSPEX(rxchain, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_RXCHAIN,\n\t     SSB_SPROM8_TXRXC_RXCHAIN_SHIFT);\n\tSPEX(antswitch, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_SWITCH,\n\t     SSB_SPROM8_TXRXC_SWITCH_SHIFT);\n\n\tSPEX(opo, SSB_SPROM8_OFDM2GPO, 0x00ff, 0);\n\n\tSPEX_ARRAY8(mcs2gpo, SSB_SPROM8_2G_MCSPO, ~0, 0);\n\tSPEX_ARRAY8(mcs5gpo, SSB_SPROM8_5G_MCSPO, ~0, 0);\n\tSPEX_ARRAY8(mcs5glpo, SSB_SPROM8_5GL_MCSPO, ~0, 0);\n\tSPEX_ARRAY8(mcs5ghpo, SSB_SPROM8_5GH_MCSPO, ~0, 0);\n\n\tSPEX(rawtempsense, SSB_SPROM8_RAWTS, SSB_SPROM8_RAWTS_RAWTEMP,\n\t     SSB_SPROM8_RAWTS_RAWTEMP_SHIFT);\n\tSPEX(measpower, SSB_SPROM8_RAWTS, SSB_SPROM8_RAWTS_MEASPOWER,\n\t     SSB_SPROM8_RAWTS_MEASPOWER_SHIFT);\n\tSPEX(tempsense_slope, SSB_SPROM8_OPT_CORRX,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_SLOPE,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_SLOPE_SHIFT);\n\tSPEX(tempcorrx, SSB_SPROM8_OPT_CORRX, SSB_SPROM8_OPT_CORRX_TEMPCORRX,\n\t     SSB_SPROM8_OPT_CORRX_TEMPCORRX_SHIFT);\n\tSPEX(tempsense_option, SSB_SPROM8_OPT_CORRX,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_OPTION,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_OPTION_SHIFT);\n\tSPEX(freqoffset_corr, SSB_SPROM8_HWIQ_IQSWP,\n\t     SSB_SPROM8_HWIQ_IQSWP_FREQ_CORR,\n\t     SSB_SPROM8_HWIQ_IQSWP_FREQ_CORR_SHIFT);\n\tSPEX(iqcal_swp_dis, SSB_SPROM8_HWIQ_IQSWP,\n\t     SSB_SPROM8_HWIQ_IQSWP_IQCAL_SWP,\n\t     SSB_SPROM8_HWIQ_IQSWP_IQCAL_SWP_SHIFT);\n\tSPEX(hw_iqcal_en, SSB_SPROM8_HWIQ_IQSWP, SSB_SPROM8_HWIQ_IQSWP_HW_IQCAL,\n\t     SSB_SPROM8_HWIQ_IQSWP_HW_IQCAL_SHIFT);\n\n\tSPEX(bw40po, SSB_SPROM8_BW40PO, ~0, 0);\n\tSPEX(cddpo, SSB_SPROM8_CDDPO, ~0, 0);\n\tSPEX(stbcpo, SSB_SPROM8_STBCPO, ~0, 0);\n\tSPEX(bwduppo, SSB_SPROM8_BWDUPPO, ~0, 0);\n\n\tSPEX(tempthresh, SSB_SPROM8_THERMAL, SSB_SPROM8_THERMAL_TRESH,\n\t     SSB_SPROM8_THERMAL_TRESH_SHIFT);\n\tSPEX(tempoffset, SSB_SPROM8_THERMAL, SSB_SPROM8_THERMAL_OFFSET,\n\t     SSB_SPROM8_THERMAL_OFFSET_SHIFT);\n\tSPEX(phycal_tempdelta, SSB_SPROM8_TEMPDELTA,\n\t     SSB_SPROM8_TEMPDELTA_PHYCAL,\n\t     SSB_SPROM8_TEMPDELTA_PHYCAL_SHIFT);\n\tSPEX(temps_period, SSB_SPROM8_TEMPDELTA, SSB_SPROM8_TEMPDELTA_PERIOD,\n\t     SSB_SPROM8_TEMPDELTA_PERIOD_SHIFT);\n\tSPEX(temps_hysteresis, SSB_SPROM8_TEMPDELTA,\n\t     SSB_SPROM8_TEMPDELTA_HYSTERESIS,\n\t     SSB_SPROM8_TEMPDELTA_HYSTERESIS_SHIFT);\n}\n\n \nstatic bool bcma_sprom_ext_available(struct bcma_bus *bus)\n{\n\tu32 chip_status;\n\tu32 srom_control;\n\tu32 present_mask;\n\n\tif (bus->drv_cc.core->id.rev >= 31) {\n\t\tif (!(bus->drv_cc.capabilities & BCMA_CC_CAP_SPROM))\n\t\t\treturn false;\n\n\t\tsrom_control = bcma_read32(bus->drv_cc.core,\n\t\t\t\t\t   BCMA_CC_SROM_CONTROL);\n\t\treturn srom_control & BCMA_CC_SROM_CONTROL_PRESENT;\n\t}\n\n\t \n\tchip_status = bcma_read32(bus->drv_cc.core, BCMA_CC_CHIPSTAT);\n\tswitch (bus->chipinfo.id) {\n\tcase BCMA_CHIP_ID_BCM4313:\n\t\tpresent_mask = BCMA_CC_CHIPST_4313_SPROM_PRESENT;\n\t\tbreak;\n\n\tcase BCMA_CHIP_ID_BCM4331:\n\t\tpresent_mask = BCMA_CC_CHIPST_4331_SPROM_PRESENT;\n\t\tbreak;\n\n\tdefault:\n\t\treturn true;\n\t}\n\n\treturn chip_status & present_mask;\n}\n\n \nstatic bool bcma_sprom_onchip_available(struct bcma_bus *bus)\n{\n\tu32 chip_status;\n\tu32 otpsize = 0;\n\tbool present;\n\n\tchip_status = bcma_read32(bus->drv_cc.core, BCMA_CC_CHIPSTAT);\n\tswitch (bus->chipinfo.id) {\n\tcase BCMA_CHIP_ID_BCM4313:\n\t\tpresent = chip_status & BCMA_CC_CHIPST_4313_OTP_PRESENT;\n\t\tbreak;\n\n\tcase BCMA_CHIP_ID_BCM4331:\n\t\tpresent = chip_status & BCMA_CC_CHIPST_4331_OTP_PRESENT;\n\t\tbreak;\n\tcase BCMA_CHIP_ID_BCM43142:\n\tcase BCMA_CHIP_ID_BCM43224:\n\tcase BCMA_CHIP_ID_BCM43225:\n\t\t \n\t\tpresent = true;\n\t\tbreak;\n\tcase BCMA_CHIP_ID_BCM43131:\n\tcase BCMA_CHIP_ID_BCM43217:\n\tcase BCMA_CHIP_ID_BCM43227:\n\tcase BCMA_CHIP_ID_BCM43228:\n\tcase BCMA_CHIP_ID_BCM43428:\n\t\tpresent = chip_status & BCMA_CC_CHIPST_43228_OTP_PRESENT;\n\t\tbreak;\n\tdefault:\n\t\tpresent = false;\n\t\tbreak;\n\t}\n\n\tif (present) {\n\t\totpsize = bus->drv_cc.capabilities & BCMA_CC_CAP_OTPS;\n\t\totpsize >>= BCMA_CC_CAP_OTPS_SHIFT;\n\t}\n\n\treturn otpsize != 0;\n}\n\n \nstatic int bcma_sprom_onchip_offset(struct bcma_bus *bus)\n{\n\tstruct bcma_device *cc = bus->drv_cc.core;\n\tu32 offset;\n\n\t \n\tif ((bcma_read32(cc, BCMA_CC_OTPS) & BCMA_CC_OTPS_GU_PROG_HW) == 0)\n\t\treturn 0;\n\n\t \n\toffset = (bcma_read32(cc, BCMA_CC_OTPL) & BCMA_CC_OTPL_GURGN_OFFSET);\n\treturn BCMA_CC_SPROM + (offset >> 3);\n}\n\nint bcma_sprom_get(struct bcma_bus *bus)\n{\n\tu16 offset = BCMA_CC_SPROM;\n\tu16 *sprom;\n\tstatic const size_t sprom_sizes[] = {\n\t\tSSB_SPROMSIZE_WORDS_R4,\n\t\tSSB_SPROMSIZE_WORDS_R10,\n\t\tSSB_SPROMSIZE_WORDS_R11,\n\t};\n\tint i, err = 0;\n\n\tif (!bus->drv_cc.core)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!bcma_sprom_ext_available(bus)) {\n\t\tbool sprom_onchip;\n\n\t\t \n\t\tsprom_onchip = bcma_sprom_onchip_available(bus);\n\t\tif (sprom_onchip) {\n\t\t\t \n\t\t\toffset = bcma_sprom_onchip_offset(bus);\n\t\t}\n\t\tif (!offset || !sprom_onchip) {\n\t\t\t \n\t\t\terr = bcma_fill_sprom_with_fallback(bus, &bus->sprom);\n\t\t\treturn err;\n\t\t}\n\t}\n\n\tif (bus->chipinfo.id == BCMA_CHIP_ID_BCM4331 ||\n\t    bus->chipinfo.id == BCMA_CHIP_ID_BCM43431)\n\t\tbcma_chipco_bcm4331_ext_pa_lines_ctl(&bus->drv_cc, false);\n\n\tbcma_debug(bus, \"SPROM offset 0x%x\\n\", offset);\n\tfor (i = 0; i < ARRAY_SIZE(sprom_sizes); i++) {\n\t\tsize_t words = sprom_sizes[i];\n\n\t\tsprom = kcalloc(words, sizeof(u16), GFP_KERNEL);\n\t\tif (!sprom)\n\t\t\treturn -ENOMEM;\n\n\t\tbcma_sprom_read(bus, offset, sprom, words);\n\t\terr = bcma_sprom_valid(bus, sprom, words);\n\t\tif (!err)\n\t\t\tbreak;\n\n\t\tkfree(sprom);\n\t}\n\n\tif (bus->chipinfo.id == BCMA_CHIP_ID_BCM4331 ||\n\t    bus->chipinfo.id == BCMA_CHIP_ID_BCM43431)\n\t\tbcma_chipco_bcm4331_ext_pa_lines_ctl(&bus->drv_cc, true);\n\n\tif (err) {\n\t\tbcma_warn(bus, \"Invalid SPROM read from the PCIe card, trying to use fallback SPROM\\n\");\n\t\terr = bcma_fill_sprom_with_fallback(bus, &bus->sprom);\n\t} else {\n\t\tbcma_sprom_extract_r8(bus, sprom);\n\t\tkfree(sprom);\n\t}\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}