{
  "module_name": "snet_hwmon.c",
  "hash_id": "ab852c384fad6380209711191154a904c7500fd70b97d4bbc4c8dda188c7e86e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vdpa/solidrun/snet_hwmon.c",
  "human_readable_source": "\n \n#include <linux/hwmon.h>\n\n#include \"snet_vdpa.h\"\n\n \n#define SNET_MON_TMP0_IN_OFF      0x00\n#define SNET_MON_TMP0_MAX_OFF     0x08\n#define SNET_MON_TMP0_CRIT_OFF    0x10\n#define SNET_MON_TMP1_IN_OFF      0x18\n#define SNET_MON_TMP1_CRIT_OFF    0x20\n#define SNET_MON_CURR_IN_OFF      0x28\n#define SNET_MON_CURR_MAX_OFF     0x30\n#define SNET_MON_CURR_CRIT_OFF    0x38\n#define SNET_MON_PWR_IN_OFF       0x40\n#define SNET_MON_VOLT_IN_OFF      0x48\n#define SNET_MON_VOLT_CRIT_OFF    0x50\n#define SNET_MON_VOLT_LCRIT_OFF   0x58\n\nstatic void snet_hwmon_read_reg(struct psnet *psnet, u32 reg, long *out)\n{\n\t*out = psnet_read64(psnet, psnet->cfg.hwmon_off + reg);\n}\n\nstatic umode_t snet_howmon_is_visible(const void *data,\n\t\t\t\t      enum hwmon_sensor_types type,\n\t\t\t\t      u32 attr, int channel)\n{\n\treturn 0444;\n}\n\nstatic int snet_howmon_read(struct device *dev, enum hwmon_sensor_types type,\n\t\t\t    u32 attr, int channel, long *val)\n{\n\tstruct psnet *psnet = dev_get_drvdata(dev);\n\tint ret = 0;\n\n\tswitch (type) {\n\tcase hwmon_in:\n\t\tswitch (attr) {\n\t\tcase hwmon_in_lcrit:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_VOLT_LCRIT_OFF, val);\n\t\t\tbreak;\n\t\tcase hwmon_in_crit:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_VOLT_CRIT_OFF, val);\n\t\t\tbreak;\n\t\tcase hwmon_in_input:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_VOLT_IN_OFF, val);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EOPNOTSUPP;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\n\tcase hwmon_power:\n\t\tswitch (attr) {\n\t\tcase hwmon_power_input:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_PWR_IN_OFF, val);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tret = -EOPNOTSUPP;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\n\tcase hwmon_curr:\n\t\tswitch (attr) {\n\t\tcase hwmon_curr_input:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_CURR_IN_OFF, val);\n\t\t\tbreak;\n\t\tcase hwmon_curr_max:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_CURR_MAX_OFF, val);\n\t\t\tbreak;\n\t\tcase hwmon_curr_crit:\n\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_CURR_CRIT_OFF, val);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EOPNOTSUPP;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\n\tcase hwmon_temp:\n\t\tswitch (attr) {\n\t\tcase hwmon_temp_input:\n\t\t\tif (channel == 0)\n\t\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_TMP0_IN_OFF, val);\n\t\t\telse\n\t\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_TMP1_IN_OFF, val);\n\t\t\tbreak;\n\t\tcase hwmon_temp_max:\n\t\t\tif (channel == 0)\n\t\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_TMP0_MAX_OFF, val);\n\t\t\telse\n\t\t\t\tret = -EOPNOTSUPP;\n\t\t\tbreak;\n\t\tcase hwmon_temp_crit:\n\t\t\tif (channel == 0)\n\t\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_TMP0_CRIT_OFF, val);\n\t\t\telse\n\t\t\t\tsnet_hwmon_read_reg(psnet, SNET_MON_TMP1_CRIT_OFF, val);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tret = -EOPNOTSUPP;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tret = -EOPNOTSUPP;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int snet_hwmon_read_string(struct device *dev,\n\t\t\t\t  enum hwmon_sensor_types type, u32 attr,\n\t\t\t\t  int channel, const char **str)\n{\n\tint ret = 0;\n\n\tswitch (type) {\n\tcase hwmon_in:\n\t\t*str = \"main_vin\";\n\t\tbreak;\n\tcase hwmon_power:\n\t\t*str = \"soc_pin\";\n\t\tbreak;\n\tcase hwmon_curr:\n\t\t*str = \"soc_iin\";\n\t\tbreak;\n\tcase hwmon_temp:\n\t\tif (channel == 0)\n\t\t\t*str = \"power_stage_temp\";\n\t\telse\n\t\t\t*str = \"ic_junction_temp\";\n\t\tbreak;\n\tdefault:\n\t\tret = -EOPNOTSUPP;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic const struct hwmon_ops snet_hwmon_ops = {\n\t.is_visible = snet_howmon_is_visible,\n\t.read = snet_howmon_read,\n\t.read_string = snet_hwmon_read_string\n};\n\nstatic const struct hwmon_channel_info * const snet_hwmon_info[] = {\n\tHWMON_CHANNEL_INFO(temp, HWMON_T_INPUT | HWMON_T_MAX | HWMON_T_CRIT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_CRIT | HWMON_T_LABEL),\n\tHWMON_CHANNEL_INFO(power, HWMON_P_INPUT | HWMON_P_LABEL),\n\tHWMON_CHANNEL_INFO(curr, HWMON_C_INPUT | HWMON_C_MAX | HWMON_C_CRIT | HWMON_C_LABEL),\n\tHWMON_CHANNEL_INFO(in, HWMON_I_INPUT | HWMON_I_CRIT | HWMON_I_LCRIT | HWMON_I_LABEL),\n\t\t\t   NULL\n};\n\nstatic const struct hwmon_chip_info snet_hwmono_info = {\n\t.ops = &snet_hwmon_ops,\n\t.info = snet_hwmon_info,\n};\n\n \nvoid psnet_create_hwmon(struct pci_dev *pdev)\n{\n\tstruct device *hwmon;\n\tstruct psnet *psnet = pci_get_drvdata(pdev);\n\n\tsnprintf(psnet->hwmon_name, SNET_NAME_SIZE, \"snet_%s\", pci_name(pdev));\n\thwmon = devm_hwmon_device_register_with_info(&pdev->dev, psnet->hwmon_name, psnet,\n\t\t\t\t\t\t     &snet_hwmono_info, NULL);\n\t \n\tif (IS_ERR(hwmon))\n\t\tSNET_WARN(pdev, \"Failed to create SNET hwmon, error %ld\\n\", PTR_ERR(hwmon));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}