{
  "module_name": "resources.c",
  "hash_id": "683020b517e60098ca926bae60d83fc73e5749f8694d3e3194ef8b803ec82a03",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vdpa/mlx5/core/resources.c",
  "human_readable_source": "\n \n\n#include <linux/iova.h>\n#include <linux/mlx5/driver.h>\n#include \"mlx5_vdpa.h\"\n\nstatic int alloc_pd(struct mlx5_vdpa_dev *dev, u32 *pdn, u16 uid)\n{\n\tstruct mlx5_core_dev *mdev = dev->mdev;\n\n\tu32 out[MLX5_ST_SZ_DW(alloc_pd_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(alloc_pd_in)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_pd_in, in, opcode, MLX5_CMD_OP_ALLOC_PD);\n\tMLX5_SET(alloc_pd_in, in, uid, uid);\n\n\terr = mlx5_cmd_exec_inout(mdev, alloc_pd, in, out);\n\tif (!err)\n\t\t*pdn = MLX5_GET(alloc_pd_out, out, pd);\n\n\treturn err;\n}\n\nstatic int dealloc_pd(struct mlx5_vdpa_dev *dev, u32 pdn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_pd_in)] = {};\n\tstruct mlx5_core_dev *mdev = dev->mdev;\n\n\tMLX5_SET(dealloc_pd_in, in, opcode, MLX5_CMD_OP_DEALLOC_PD);\n\tMLX5_SET(dealloc_pd_in, in, pd, pdn);\n\tMLX5_SET(dealloc_pd_in, in, uid, uid);\n\treturn mlx5_cmd_exec_in(mdev, dealloc_pd, in);\n}\n\nstatic int get_null_mkey(struct mlx5_vdpa_dev *dev, u32 *null_mkey)\n{\n\tu32 out[MLX5_ST_SZ_DW(query_special_contexts_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(query_special_contexts_in)] = {};\n\tstruct mlx5_core_dev *mdev = dev->mdev;\n\tint err;\n\n\tMLX5_SET(query_special_contexts_in, in, opcode, MLX5_CMD_OP_QUERY_SPECIAL_CONTEXTS);\n\terr = mlx5_cmd_exec_inout(mdev, query_special_contexts, in, out);\n\tif (!err)\n\t\t*null_mkey = MLX5_GET(query_special_contexts_out, out, null_mkey);\n\treturn err;\n}\n\nstatic int create_uctx(struct mlx5_vdpa_dev *mvdev, u16 *uid)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_uctx_out)] = {};\n\tint inlen;\n\tvoid *in;\n\tint err;\n\n\tif (MLX5_CAP_GEN(mvdev->mdev, umem_uid_0))\n\t\treturn 0;\n\n\t \n\tif (!MLX5_CAP_GEN(mvdev->mdev, log_max_uctx))\n\t\treturn -EOPNOTSUPP;\n\n\tinlen = MLX5_ST_SZ_BYTES(create_uctx_in);\n\tin = kzalloc(inlen, GFP_KERNEL);\n\tif (!in)\n\t\treturn -ENOMEM;\n\n\tMLX5_SET(create_uctx_in, in, opcode, MLX5_CMD_OP_CREATE_UCTX);\n\tMLX5_SET(create_uctx_in, in, uctx.cap, MLX5_UCTX_CAP_RAW_TX);\n\n\terr = mlx5_cmd_exec(mvdev->mdev, in, inlen, out, sizeof(out));\n\tkfree(in);\n\tif (!err)\n\t\t*uid = MLX5_GET(create_uctx_out, out, uid);\n\n\treturn err;\n}\n\nstatic void destroy_uctx(struct mlx5_vdpa_dev *mvdev, u32 uid)\n{\n\tu32 out[MLX5_ST_SZ_DW(destroy_uctx_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(destroy_uctx_in)] = {};\n\n\tif (!uid)\n\t\treturn;\n\n\tMLX5_SET(destroy_uctx_in, in, opcode, MLX5_CMD_OP_DESTROY_UCTX);\n\tMLX5_SET(destroy_uctx_in, in, uid, uid);\n\n\tmlx5_cmd_exec(mvdev->mdev, in, sizeof(in), out, sizeof(out));\n}\n\nint mlx5_vdpa_create_tis(struct mlx5_vdpa_dev *mvdev, void *in, u32 *tisn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_tis_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_tis_in, in, opcode, MLX5_CMD_OP_CREATE_TIS);\n\tMLX5_SET(create_tis_in, in, uid, mvdev->res.uid);\n\terr = mlx5_cmd_exec_inout(mvdev->mdev, create_tis, in, out);\n\tif (!err)\n\t\t*tisn = MLX5_GET(create_tis_out, out, tisn);\n\n\treturn err;\n}\n\nvoid mlx5_vdpa_destroy_tis(struct mlx5_vdpa_dev *mvdev, u32 tisn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_tis_in)] = {};\n\n\tMLX5_SET(destroy_tis_in, in, opcode, MLX5_CMD_OP_DESTROY_TIS);\n\tMLX5_SET(destroy_tis_in, in, uid, mvdev->res.uid);\n\tMLX5_SET(destroy_tis_in, in, tisn, tisn);\n\tmlx5_cmd_exec_in(mvdev->mdev, destroy_tis, in);\n}\n\nint mlx5_vdpa_create_rqt(struct mlx5_vdpa_dev *mvdev, void *in, int inlen, u32 *rqtn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_rqt_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_rqt_in, in, opcode, MLX5_CMD_OP_CREATE_RQT);\n\terr = mlx5_cmd_exec(mvdev->mdev, in, inlen, out, sizeof(out));\n\tif (!err)\n\t\t*rqtn = MLX5_GET(create_rqt_out, out, rqtn);\n\n\treturn err;\n}\n\nint mlx5_vdpa_modify_rqt(struct mlx5_vdpa_dev *mvdev, void *in, int inlen, u32 rqtn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_rqt_out)] = {};\n\n\tMLX5_SET(modify_rqt_in, in, uid, mvdev->res.uid);\n\tMLX5_SET(modify_rqt_in, in, rqtn, rqtn);\n\tMLX5_SET(modify_rqt_in, in, opcode, MLX5_CMD_OP_MODIFY_RQT);\n\treturn mlx5_cmd_exec(mvdev->mdev, in, inlen, out, sizeof(out));\n}\n\nvoid mlx5_vdpa_destroy_rqt(struct mlx5_vdpa_dev *mvdev, u32 rqtn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_rqt_in)] = {};\n\n\tMLX5_SET(destroy_rqt_in, in, opcode, MLX5_CMD_OP_DESTROY_RQT);\n\tMLX5_SET(destroy_rqt_in, in, uid, mvdev->res.uid);\n\tMLX5_SET(destroy_rqt_in, in, rqtn, rqtn);\n\tmlx5_cmd_exec_in(mvdev->mdev, destroy_rqt, in);\n}\n\nint mlx5_vdpa_create_tir(struct mlx5_vdpa_dev *mvdev, void *in, u32 *tirn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_tir_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_tir_in, in, opcode, MLX5_CMD_OP_CREATE_TIR);\n\terr = mlx5_cmd_exec_inout(mvdev->mdev, create_tir, in, out);\n\tif (!err)\n\t\t*tirn = MLX5_GET(create_tir_out, out, tirn);\n\n\treturn err;\n}\n\nvoid mlx5_vdpa_destroy_tir(struct mlx5_vdpa_dev *mvdev, u32 tirn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_tir_in)] = {};\n\n\tMLX5_SET(destroy_tir_in, in, opcode, MLX5_CMD_OP_DESTROY_TIR);\n\tMLX5_SET(destroy_tir_in, in, uid, mvdev->res.uid);\n\tMLX5_SET(destroy_tir_in, in, tirn, tirn);\n\tmlx5_cmd_exec_in(mvdev->mdev, destroy_tir, in);\n}\n\nint mlx5_vdpa_alloc_transport_domain(struct mlx5_vdpa_dev *mvdev, u32 *tdn)\n{\n\tu32 out[MLX5_ST_SZ_DW(alloc_transport_domain_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(alloc_transport_domain_in)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_transport_domain_in, in, opcode, MLX5_CMD_OP_ALLOC_TRANSPORT_DOMAIN);\n\tMLX5_SET(alloc_transport_domain_in, in, uid, mvdev->res.uid);\n\n\terr = mlx5_cmd_exec_inout(mvdev->mdev, alloc_transport_domain, in, out);\n\tif (!err)\n\t\t*tdn = MLX5_GET(alloc_transport_domain_out, out, transport_domain);\n\n\treturn err;\n}\n\nvoid mlx5_vdpa_dealloc_transport_domain(struct mlx5_vdpa_dev *mvdev, u32 tdn)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_transport_domain_in)] = {};\n\n\tMLX5_SET(dealloc_transport_domain_in, in, opcode, MLX5_CMD_OP_DEALLOC_TRANSPORT_DOMAIN);\n\tMLX5_SET(dealloc_transport_domain_in, in, uid, mvdev->res.uid);\n\tMLX5_SET(dealloc_transport_domain_in, in, transport_domain, tdn);\n\tmlx5_cmd_exec_in(mvdev->mdev, dealloc_transport_domain, in);\n}\n\nint mlx5_vdpa_create_mkey(struct mlx5_vdpa_dev *mvdev, u32 *mkey, u32 *in,\n\t\t\t  int inlen)\n{\n\tu32 lout[MLX5_ST_SZ_DW(create_mkey_out)] = {};\n\tu32 mkey_index;\n\tint err;\n\n\tMLX5_SET(create_mkey_in, in, opcode, MLX5_CMD_OP_CREATE_MKEY);\n\tMLX5_SET(create_mkey_in, in, uid, mvdev->res.uid);\n\n\terr = mlx5_cmd_exec(mvdev->mdev, in, inlen, lout, sizeof(lout));\n\tif (err)\n\t\treturn err;\n\n\tmkey_index = MLX5_GET(create_mkey_out, lout, mkey_index);\n\t*mkey = mlx5_idx_to_mkey(mkey_index);\n\treturn 0;\n}\n\nint mlx5_vdpa_destroy_mkey(struct mlx5_vdpa_dev *mvdev, u32 mkey)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_mkey_in)] = {};\n\n\tMLX5_SET(destroy_mkey_in, in, uid, mvdev->res.uid);\n\tMLX5_SET(destroy_mkey_in, in, opcode, MLX5_CMD_OP_DESTROY_MKEY);\n\tMLX5_SET(destroy_mkey_in, in, mkey_index, mlx5_mkey_to_idx(mkey));\n\treturn mlx5_cmd_exec_in(mvdev->mdev, destroy_mkey, in);\n}\n\nstatic int init_ctrl_vq(struct mlx5_vdpa_dev *mvdev)\n{\n\tmvdev->cvq.iotlb = vhost_iotlb_alloc(0, 0);\n\tif (!mvdev->cvq.iotlb)\n\t\treturn -ENOMEM;\n\n\tspin_lock_init(&mvdev->cvq.iommu_lock);\n\tvringh_set_iotlb(&mvdev->cvq.vring, mvdev->cvq.iotlb, &mvdev->cvq.iommu_lock);\n\n\treturn 0;\n}\n\nstatic void cleanup_ctrl_vq(struct mlx5_vdpa_dev *mvdev)\n{\n\tvhost_iotlb_free(mvdev->cvq.iotlb);\n}\n\nint mlx5_vdpa_alloc_resources(struct mlx5_vdpa_dev *mvdev)\n{\n\tu64 offset = MLX5_CAP64_DEV_VDPA_EMULATION(mvdev->mdev, doorbell_bar_offset);\n\tstruct mlx5_vdpa_resources *res = &mvdev->res;\n\tstruct mlx5_core_dev *mdev = mvdev->mdev;\n\tu64 kick_addr;\n\tint err;\n\n\tif (res->valid) {\n\t\tmlx5_vdpa_warn(mvdev, \"resources already allocated\\n\");\n\t\treturn -EINVAL;\n\t}\n\tmutex_init(&mvdev->mr.mkey_mtx);\n\tres->uar = mlx5_get_uars_page(mdev);\n\tif (IS_ERR(res->uar)) {\n\t\terr = PTR_ERR(res->uar);\n\t\tgoto err_uars;\n\t}\n\n\terr = create_uctx(mvdev, &res->uid);\n\tif (err)\n\t\tgoto err_uctx;\n\n\terr = alloc_pd(mvdev, &res->pdn, res->uid);\n\tif (err)\n\t\tgoto err_pd;\n\n\terr = get_null_mkey(mvdev, &res->null_mkey);\n\tif (err)\n\t\tgoto err_key;\n\n\tkick_addr = mdev->bar_addr + offset;\n\tres->phys_kick_addr = kick_addr;\n\n\tres->kick_addr = ioremap(kick_addr, PAGE_SIZE);\n\tif (!res->kick_addr) {\n\t\terr = -ENOMEM;\n\t\tgoto err_key;\n\t}\n\n\terr = init_ctrl_vq(mvdev);\n\tif (err)\n\t\tgoto err_ctrl;\n\n\tres->valid = true;\n\n\treturn 0;\n\nerr_ctrl:\n\tiounmap(res->kick_addr);\nerr_key:\n\tdealloc_pd(mvdev, res->pdn, res->uid);\nerr_pd:\n\tdestroy_uctx(mvdev, res->uid);\nerr_uctx:\n\tmlx5_put_uars_page(mdev, res->uar);\nerr_uars:\n\tmutex_destroy(&mvdev->mr.mkey_mtx);\n\treturn err;\n}\n\nvoid mlx5_vdpa_free_resources(struct mlx5_vdpa_dev *mvdev)\n{\n\tstruct mlx5_vdpa_resources *res = &mvdev->res;\n\n\tif (!res->valid)\n\t\treturn;\n\n\tcleanup_ctrl_vq(mvdev);\n\tiounmap(res->kick_addr);\n\tres->kick_addr = NULL;\n\tdealloc_pd(mvdev, res->pdn, res->uid);\n\tdestroy_uctx(mvdev, res->uid);\n\tmlx5_put_uars_page(mvdev->mdev, res->uar);\n\tmutex_destroy(&mvdev->mr.mkey_mtx);\n\tres->valid = false;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}