{
  "module_name": "cmds.c",
  "hash_id": "ce20b4397b1865fcc0c7261d889bb43f6f1acb9ea4f94eb4dc76409c180b880d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vdpa/pds/cmds.c",
  "human_readable_source": "\n \n\n#include <linux/vdpa.h>\n#include <linux/virtio_pci_modern.h>\n\n#include <linux/pds/pds_common.h>\n#include <linux/pds/pds_core_if.h>\n#include <linux/pds/pds_adminq.h>\n#include <linux/pds/pds_auxbus.h>\n\n#include \"vdpa_dev.h\"\n#include \"aux_drv.h\"\n#include \"cmds.h\"\n\nint pds_vdpa_init_hw(struct pds_vdpa_device *pdsv)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa_init.opcode = PDS_VDPA_CMD_INIT,\n\t\t.vdpa_init.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa_init.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\t \n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa_init),\n\t\t\t\t    &comp, 0);\n\tif (err)\n\t\tdev_dbg(dev, \"Failed to init hw, status %d: %pe\\n\",\n\t\t\tcomp.status, ERR_PTR(err));\n\n\treturn err;\n}\n\nint pds_vdpa_cmd_reset(struct pds_vdpa_device *pdsv)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa.opcode = PDS_VDPA_CMD_RESET,\n\t\t.vdpa.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa), &comp, 0);\n\tif (err)\n\t\tdev_dbg(dev, \"Failed to reset hw, status %d: %pe\\n\",\n\t\t\tcomp.status, ERR_PTR(err));\n\n\treturn err;\n}\n\nint pds_vdpa_cmd_set_status(struct pds_vdpa_device *pdsv, u8 status)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa_status.opcode = PDS_VDPA_CMD_STATUS_UPDATE,\n\t\t.vdpa_status.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa_status.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t\t.vdpa_status.status = status,\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa_status), &comp, 0);\n\tif (err)\n\t\tdev_dbg(dev, \"Failed to set status to %#x, error status %d: %pe\\n\",\n\t\t\tstatus, comp.status, ERR_PTR(err));\n\n\treturn err;\n}\n\nint pds_vdpa_cmd_set_mac(struct pds_vdpa_device *pdsv, u8 *mac)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa_setattr.opcode = PDS_VDPA_CMD_SET_ATTR,\n\t\t.vdpa_setattr.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa_setattr.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t\t.vdpa_setattr.attr = PDS_VDPA_ATTR_MAC,\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\tether_addr_copy(cmd.vdpa_setattr.mac, mac);\n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa_setattr),\n\t\t\t\t    &comp, 0);\n\tif (err)\n\t\tdev_dbg(dev, \"Failed to set mac address %pM, status %d: %pe\\n\",\n\t\t\tmac, comp.status, ERR_PTR(err));\n\n\treturn err;\n}\n\nint pds_vdpa_cmd_set_max_vq_pairs(struct pds_vdpa_device *pdsv, u16 max_vqp)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa_setattr.opcode = PDS_VDPA_CMD_SET_ATTR,\n\t\t.vdpa_setattr.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa_setattr.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t\t.vdpa_setattr.attr = PDS_VDPA_ATTR_MAX_VQ_PAIRS,\n\t\t.vdpa_setattr.max_vq_pairs = cpu_to_le16(max_vqp),\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa_setattr),\n\t\t\t\t    &comp, 0);\n\tif (err)\n\t\tdev_dbg(dev, \"Failed to set max vq pairs %u, status %d: %pe\\n\",\n\t\t\tmax_vqp, comp.status, ERR_PTR(err));\n\n\treturn err;\n}\n\nint pds_vdpa_cmd_init_vq(struct pds_vdpa_device *pdsv, u16 qid, u16 invert_idx,\n\t\t\t struct pds_vdpa_vq_info *vq_info)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa_vq_init.opcode = PDS_VDPA_CMD_VQ_INIT,\n\t\t.vdpa_vq_init.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa_vq_init.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t\t.vdpa_vq_init.qid = cpu_to_le16(qid),\n\t\t.vdpa_vq_init.len = cpu_to_le16(ilog2(vq_info->q_len)),\n\t\t.vdpa_vq_init.desc_addr = cpu_to_le64(vq_info->desc_addr),\n\t\t.vdpa_vq_init.avail_addr = cpu_to_le64(vq_info->avail_addr),\n\t\t.vdpa_vq_init.used_addr = cpu_to_le64(vq_info->used_addr),\n\t\t.vdpa_vq_init.intr_index = cpu_to_le16(qid),\n\t\t.vdpa_vq_init.avail_index = cpu_to_le16(vq_info->avail_idx ^ invert_idx),\n\t\t.vdpa_vq_init.used_index = cpu_to_le16(vq_info->used_idx ^ invert_idx),\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\tdev_dbg(dev, \"%s: qid %d len %d desc_addr %#llx avail_addr %#llx used_addr %#llx\\n\",\n\t\t__func__, qid, ilog2(vq_info->q_len),\n\t\tvq_info->desc_addr, vq_info->avail_addr, vq_info->used_addr);\n\n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa_vq_init),\n\t\t\t\t    &comp, 0);\n\tif (err)\n\t\tdev_dbg(dev, \"Failed to init vq %d, status %d: %pe\\n\",\n\t\t\tqid, comp.status, ERR_PTR(err));\n\n\treturn err;\n}\n\nint pds_vdpa_cmd_reset_vq(struct pds_vdpa_device *pdsv, u16 qid, u16 invert_idx,\n\t\t\t  struct pds_vdpa_vq_info *vq_info)\n{\n\tstruct pds_auxiliary_dev *padev = pdsv->vdpa_aux->padev;\n\tstruct device *dev = &padev->aux_dev.dev;\n\tunion pds_core_adminq_cmd cmd = {\n\t\t.vdpa_vq_reset.opcode = PDS_VDPA_CMD_VQ_RESET,\n\t\t.vdpa_vq_reset.vdpa_index = pdsv->vdpa_index,\n\t\t.vdpa_vq_reset.vf_id = cpu_to_le16(pdsv->vdpa_aux->vf_id),\n\t\t.vdpa_vq_reset.qid = cpu_to_le16(qid),\n\t};\n\tunion pds_core_adminq_comp comp = {};\n\tint err;\n\n\terr = pds_client_adminq_cmd(padev, &cmd, sizeof(cmd.vdpa_vq_reset),\n\t\t\t\t    &comp, 0);\n\tif (err) {\n\t\tdev_dbg(dev, \"Failed to reset vq %d, status %d: %pe\\n\",\n\t\t\tqid, comp.status, ERR_PTR(err));\n\t\treturn err;\n\t}\n\n\tvq_info->avail_idx = le16_to_cpu(comp.vdpa_vq_reset.avail_index) ^ invert_idx;\n\tvq_info->used_idx = le16_to_cpu(comp.vdpa_vq_reset.used_index) ^ invert_idx;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}