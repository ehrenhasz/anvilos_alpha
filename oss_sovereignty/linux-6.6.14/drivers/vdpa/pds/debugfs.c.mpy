{
  "module_name": "debugfs.c",
  "hash_id": "557066e297f554726c7d0318e4398d4d086f761ab5f07257428d399e05ba45ae",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vdpa/pds/debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/pci.h>\n#include <linux/vdpa.h>\n\n#include <linux/pds/pds_common.h>\n#include <linux/pds/pds_core_if.h>\n#include <linux/pds/pds_adminq.h>\n#include <linux/pds/pds_auxbus.h>\n\n#include \"aux_drv.h\"\n#include \"vdpa_dev.h\"\n#include \"debugfs.h\"\n\nstatic struct dentry *dbfs_dir;\n\nvoid pds_vdpa_debugfs_create(void)\n{\n\tdbfs_dir = debugfs_create_dir(PDS_VDPA_DRV_NAME, NULL);\n}\n\nvoid pds_vdpa_debugfs_destroy(void)\n{\n\tdebugfs_remove_recursive(dbfs_dir);\n\tdbfs_dir = NULL;\n}\n\n#define PRINT_SBIT_NAME(__seq, __f, __name)                     \\\n\tdo {                                                    \\\n\t\tif ((__f) & (__name))                               \\\n\t\t\tseq_printf(__seq, \" %s\", &#__name[16]); \\\n\t} while (0)\n\nstatic void print_status_bits(struct seq_file *seq, u8 status)\n{\n\tseq_puts(seq, \"status:\");\n\tPRINT_SBIT_NAME(seq, status, VIRTIO_CONFIG_S_ACKNOWLEDGE);\n\tPRINT_SBIT_NAME(seq, status, VIRTIO_CONFIG_S_DRIVER);\n\tPRINT_SBIT_NAME(seq, status, VIRTIO_CONFIG_S_DRIVER_OK);\n\tPRINT_SBIT_NAME(seq, status, VIRTIO_CONFIG_S_FEATURES_OK);\n\tPRINT_SBIT_NAME(seq, status, VIRTIO_CONFIG_S_NEEDS_RESET);\n\tPRINT_SBIT_NAME(seq, status, VIRTIO_CONFIG_S_FAILED);\n\tseq_puts(seq, \"\\n\");\n}\n\nstatic void print_feature_bits_all(struct seq_file *seq, u64 features)\n{\n\tint i;\n\n\tseq_puts(seq, \"features:\");\n\n\tfor (i = 0; i < (sizeof(u64) * 8); i++) {\n\t\tu64 mask = BIT_ULL(i);\n\n\t\tswitch (features & mask) {\n\t\tcase BIT_ULL(VIRTIO_NET_F_CSUM):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CSUM\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_GUEST_CSUM):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_GUEST_CSUM\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_CTRL_GUEST_OFFLOADS):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CTRL_GUEST_OFFLOADS\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_MTU):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_MTU\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_MAC):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_MAC\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_GUEST_TSO4):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_GUEST_TSO4\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_GUEST_TSO6):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_GUEST_TSO6\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_GUEST_ECN):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_GUEST_ECN\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_GUEST_UFO):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_GUEST_UFO\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_HOST_TSO4):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_HOST_TSO4\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_HOST_TSO6):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_HOST_TSO6\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_HOST_ECN):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_HOST_ECN\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_HOST_UFO):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_HOST_UFO\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_MRG_RXBUF):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_MRG_RXBUF\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_STATUS):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_STATUS\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_CTRL_VQ):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CTRL_VQ\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_CTRL_RX):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CTRL_RX\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_CTRL_VLAN):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CTRL_VLAN\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_CTRL_RX_EXTRA):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CTRL_RX_EXTRA\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_GUEST_ANNOUNCE):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_GUEST_ANNOUNCE\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_MQ):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_MQ\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_CTRL_MAC_ADDR):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_CTRL_MAC_ADDR\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_HASH_REPORT):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_HASH_REPORT\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_RSS):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_RSS\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_RSC_EXT):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_RSC_EXT\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_STANDBY):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_STANDBY\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_NET_F_SPEED_DUPLEX):\n\t\t\tseq_puts(seq, \" VIRTIO_NET_F_SPEED_DUPLEX\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_NOTIFY_ON_EMPTY):\n\t\t\tseq_puts(seq, \" VIRTIO_F_NOTIFY_ON_EMPTY\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_ANY_LAYOUT):\n\t\t\tseq_puts(seq, \" VIRTIO_F_ANY_LAYOUT\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_VERSION_1):\n\t\t\tseq_puts(seq, \" VIRTIO_F_VERSION_1\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_ACCESS_PLATFORM):\n\t\t\tseq_puts(seq, \" VIRTIO_F_ACCESS_PLATFORM\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_RING_PACKED):\n\t\t\tseq_puts(seq, \" VIRTIO_F_RING_PACKED\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_ORDER_PLATFORM):\n\t\t\tseq_puts(seq, \" VIRTIO_F_ORDER_PLATFORM\");\n\t\t\tbreak;\n\t\tcase BIT_ULL(VIRTIO_F_SR_IOV):\n\t\t\tseq_puts(seq, \" VIRTIO_F_SR_IOV\");\n\t\t\tbreak;\n\t\tcase 0:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tseq_printf(seq, \" bit_%d\", i);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tseq_puts(seq, \"\\n\");\n}\n\nvoid pds_vdpa_debugfs_add_pcidev(struct pds_vdpa_aux *vdpa_aux)\n{\n\tvdpa_aux->dentry = debugfs_create_dir(pci_name(vdpa_aux->padev->vf_pdev), dbfs_dir);\n}\n\nstatic int identity_show(struct seq_file *seq, void *v)\n{\n\tstruct pds_vdpa_aux *vdpa_aux = seq->private;\n\tstruct vdpa_mgmt_dev *mgmt;\n\tu64 hw_features;\n\n\tseq_printf(seq, \"aux_dev:            %s\\n\",\n\t\t   dev_name(&vdpa_aux->padev->aux_dev.dev));\n\n\tmgmt = &vdpa_aux->vdpa_mdev;\n\tseq_printf(seq, \"max_vqs:            %d\\n\", mgmt->max_supported_vqs);\n\tseq_printf(seq, \"config_attr_mask:   %#llx\\n\", mgmt->config_attr_mask);\n\thw_features = le64_to_cpu(vdpa_aux->ident.hw_features);\n\tseq_printf(seq, \"hw_features:        %#llx\\n\", hw_features);\n\tprint_feature_bits_all(seq, hw_features);\n\n\treturn 0;\n}\nDEFINE_SHOW_ATTRIBUTE(identity);\n\nvoid pds_vdpa_debugfs_add_ident(struct pds_vdpa_aux *vdpa_aux)\n{\n\tdebugfs_create_file(\"identity\", 0400, vdpa_aux->dentry,\n\t\t\t    vdpa_aux, &identity_fops);\n}\n\nstatic int config_show(struct seq_file *seq, void *v)\n{\n\tstruct pds_vdpa_device *pdsv = seq->private;\n\tstruct virtio_net_config vc;\n\tu8 status;\n\n\tmemcpy_fromio(&vc, pdsv->vdpa_aux->vd_mdev.device,\n\t\t      sizeof(struct virtio_net_config));\n\n\tseq_printf(seq, \"mac:                  %pM\\n\", vc.mac);\n\tseq_printf(seq, \"max_virtqueue_pairs:  %d\\n\",\n\t\t   __virtio16_to_cpu(true, vc.max_virtqueue_pairs));\n\tseq_printf(seq, \"mtu:                  %d\\n\", __virtio16_to_cpu(true, vc.mtu));\n\tseq_printf(seq, \"speed:                %d\\n\", le32_to_cpu(vc.speed));\n\tseq_printf(seq, \"duplex:               %d\\n\", vc.duplex);\n\tseq_printf(seq, \"rss_max_key_size:     %d\\n\", vc.rss_max_key_size);\n\tseq_printf(seq, \"rss_max_indirection_table_length: %d\\n\",\n\t\t   le16_to_cpu(vc.rss_max_indirection_table_length));\n\tseq_printf(seq, \"supported_hash_types: %#x\\n\",\n\t\t   le32_to_cpu(vc.supported_hash_types));\n\tseq_printf(seq, \"vn_status:            %#x\\n\",\n\t\t   __virtio16_to_cpu(true, vc.status));\n\n\tstatus = vp_modern_get_status(&pdsv->vdpa_aux->vd_mdev);\n\tseq_printf(seq, \"dev_status:           %#x\\n\", status);\n\tprint_status_bits(seq, status);\n\tseq_printf(seq, \"negotiated_features:  %#llx\\n\", pdsv->negotiated_features);\n\tprint_feature_bits_all(seq, pdsv->negotiated_features);\n\tseq_printf(seq, \"vdpa_index:           %d\\n\", pdsv->vdpa_index);\n\tseq_printf(seq, \"num_vqs:              %d\\n\", pdsv->num_vqs);\n\n\treturn 0;\n}\nDEFINE_SHOW_ATTRIBUTE(config);\n\nstatic int vq_show(struct seq_file *seq, void *v)\n{\n\tstruct pds_vdpa_vq_info *vq = seq->private;\n\n\tseq_printf(seq, \"ready:      %d\\n\", vq->ready);\n\tseq_printf(seq, \"desc_addr:  %#llx\\n\", vq->desc_addr);\n\tseq_printf(seq, \"avail_addr: %#llx\\n\", vq->avail_addr);\n\tseq_printf(seq, \"used_addr:  %#llx\\n\", vq->used_addr);\n\tseq_printf(seq, \"q_len:      %d\\n\", vq->q_len);\n\tseq_printf(seq, \"qid:        %d\\n\", vq->qid);\n\n\tseq_printf(seq, \"doorbell:   %#llx\\n\", vq->doorbell);\n\tseq_printf(seq, \"avail_idx:  %d\\n\", vq->avail_idx);\n\tseq_printf(seq, \"used_idx:   %d\\n\", vq->used_idx);\n\tseq_printf(seq, \"irq:        %d\\n\", vq->irq);\n\tseq_printf(seq, \"irq-name:   %s\\n\", vq->irq_name);\n\n\treturn 0;\n}\nDEFINE_SHOW_ATTRIBUTE(vq);\n\nvoid pds_vdpa_debugfs_add_vdpadev(struct pds_vdpa_aux *vdpa_aux)\n{\n\tint i;\n\n\tdebugfs_create_file(\"config\", 0400, vdpa_aux->dentry, vdpa_aux->pdsv, &config_fops);\n\n\tfor (i = 0; i < vdpa_aux->pdsv->num_vqs; i++) {\n\t\tchar name[16];\n\n\t\tsnprintf(name, sizeof(name), \"vq%02d\", i);\n\t\tdebugfs_create_file(name, 0400, vdpa_aux->dentry,\n\t\t\t\t    &vdpa_aux->pdsv->vqs[i], &vq_fops);\n\t}\n}\n\nvoid pds_vdpa_debugfs_del_vdpadev(struct pds_vdpa_aux *vdpa_aux)\n{\n\tdebugfs_remove_recursive(vdpa_aux->dentry);\n\tvdpa_aux->dentry = NULL;\n}\n\nvoid pds_vdpa_debugfs_reset_vdpadev(struct pds_vdpa_aux *vdpa_aux)\n{\n\t \n\tpds_vdpa_debugfs_del_vdpadev(vdpa_aux);\n\tpds_vdpa_debugfs_add_pcidev(vdpa_aux);\n\tpds_vdpa_debugfs_add_ident(vdpa_aux);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}