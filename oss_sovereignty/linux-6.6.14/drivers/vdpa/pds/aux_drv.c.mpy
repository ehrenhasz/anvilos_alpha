{
  "module_name": "aux_drv.c",
  "hash_id": "2deaa1fc37159b094a7dbf0ca6b76f3703aaa335ec35ba0a7aa58264f377fa72",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vdpa/pds/aux_drv.c",
  "human_readable_source": "\n \n\n#include <linux/auxiliary_bus.h>\n#include <linux/pci.h>\n#include <linux/vdpa.h>\n#include <linux/virtio_pci_modern.h>\n\n#include <linux/pds/pds_common.h>\n#include <linux/pds/pds_core_if.h>\n#include <linux/pds/pds_adminq.h>\n#include <linux/pds/pds_auxbus.h>\n\n#include \"aux_drv.h\"\n#include \"debugfs.h\"\n#include \"vdpa_dev.h\"\n\nstatic const struct auxiliary_device_id pds_vdpa_id_table[] = {\n\t{ .name = PDS_VDPA_DEV_NAME, },\n\t{},\n};\n\nstatic int pds_vdpa_device_id_check(struct pci_dev *pdev)\n{\n\tif (pdev->device != PCI_DEVICE_ID_PENSANDO_VDPA_VF ||\n\t    pdev->vendor != PCI_VENDOR_ID_PENSANDO)\n\t\treturn -ENODEV;\n\n\treturn PCI_DEVICE_ID_PENSANDO_VDPA_VF;\n}\n\nstatic int pds_vdpa_probe(struct auxiliary_device *aux_dev,\n\t\t\t  const struct auxiliary_device_id *id)\n\n{\n\tstruct pds_auxiliary_dev *padev =\n\t\tcontainer_of(aux_dev, struct pds_auxiliary_dev, aux_dev);\n\tstruct device *dev = &aux_dev->dev;\n\tstruct pds_vdpa_aux *vdpa_aux;\n\tint err;\n\n\tvdpa_aux = kzalloc(sizeof(*vdpa_aux), GFP_KERNEL);\n\tif (!vdpa_aux)\n\t\treturn -ENOMEM;\n\n\tvdpa_aux->padev = padev;\n\tvdpa_aux->vf_id = pci_iov_vf_id(padev->vf_pdev);\n\tauxiliary_set_drvdata(aux_dev, vdpa_aux);\n\n\t \n\terr = pds_vdpa_get_mgmt_info(vdpa_aux);\n\tif (err)\n\t\tgoto err_free_mem;\n\n\t \n\tvdpa_aux->vd_mdev.pci_dev = padev->vf_pdev;\n\tvdpa_aux->vd_mdev.device_id_check = pds_vdpa_device_id_check;\n\tvdpa_aux->vd_mdev.dma_mask = DMA_BIT_MASK(PDS_CORE_ADDR_LEN);\n\terr = vp_modern_probe(&vdpa_aux->vd_mdev);\n\tif (err) {\n\t\tdev_err(dev, \"Unable to probe for virtio configuration: %pe\\n\",\n\t\t\tERR_PTR(err));\n\t\tgoto err_free_mgmt_info;\n\t}\n\n\t \n\terr = vdpa_mgmtdev_register(&vdpa_aux->vdpa_mdev);\n\tif (err) {\n\t\tdev_err(dev, \"%s: Failed to initialize vdpa_mgmt interface: %pe\\n\",\n\t\t\t__func__, ERR_PTR(err));\n\t\tgoto err_free_virtio;\n\t}\n\n\tpds_vdpa_debugfs_add_pcidev(vdpa_aux);\n\tpds_vdpa_debugfs_add_ident(vdpa_aux);\n\n\treturn 0;\n\nerr_free_virtio:\n\tvp_modern_remove(&vdpa_aux->vd_mdev);\nerr_free_mgmt_info:\n\tpci_free_irq_vectors(padev->vf_pdev);\nerr_free_mem:\n\tkfree(vdpa_aux);\n\tauxiliary_set_drvdata(aux_dev, NULL);\n\n\treturn err;\n}\n\nstatic void pds_vdpa_remove(struct auxiliary_device *aux_dev)\n{\n\tstruct pds_vdpa_aux *vdpa_aux = auxiliary_get_drvdata(aux_dev);\n\tstruct device *dev = &aux_dev->dev;\n\n\tvdpa_mgmtdev_unregister(&vdpa_aux->vdpa_mdev);\n\tvp_modern_remove(&vdpa_aux->vd_mdev);\n\tpci_free_irq_vectors(vdpa_aux->padev->vf_pdev);\n\n\tpds_vdpa_debugfs_del_vdpadev(vdpa_aux);\n\tkfree(vdpa_aux);\n\tauxiliary_set_drvdata(aux_dev, NULL);\n\n\tdev_info(dev, \"Removed\\n\");\n}\n\nstatic struct auxiliary_driver pds_vdpa_driver = {\n\t.name = PDS_DEV_TYPE_VDPA_STR,\n\t.probe = pds_vdpa_probe,\n\t.remove = pds_vdpa_remove,\n\t.id_table = pds_vdpa_id_table,\n};\n\nstatic void __exit pds_vdpa_cleanup(void)\n{\n\tauxiliary_driver_unregister(&pds_vdpa_driver);\n\n\tpds_vdpa_debugfs_destroy();\n}\nmodule_exit(pds_vdpa_cleanup);\n\nstatic int __init pds_vdpa_init(void)\n{\n\tint err;\n\n\tpds_vdpa_debugfs_create();\n\n\terr = auxiliary_driver_register(&pds_vdpa_driver);\n\tif (err) {\n\t\tpr_err(\"%s: aux driver register failed: %pe\\n\",\n\t\t       PDS_VDPA_DRV_NAME, ERR_PTR(err));\n\t\tpds_vdpa_debugfs_destroy();\n\t}\n\n\treturn err;\n}\nmodule_init(pds_vdpa_init);\n\nMODULE_DESCRIPTION(PDS_VDPA_DRV_DESCRIPTION);\nMODULE_AUTHOR(\"Advanced Micro Devices, Inc\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}