{
  "module_name": "timberdale.c",
  "hash_id": "5c495dee3b7827e2d43b93b96cdfa6d884178607179c7881ffc8532f527e903b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/timberdale.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/mfd/core.h>\n#include <linux/slab.h>\n\n#include <linux/timb_gpio.h>\n\n#include <linux/i2c.h>\n#include <linux/platform_data/i2c-ocores.h>\n#include <linux/platform_data/i2c-xiic.h>\n\n#include <linux/spi/spi.h>\n#include <linux/spi/xilinx_spi.h>\n#include <linux/spi/max7301.h>\n#include <linux/spi/mc33880.h>\n\n#include <linux/platform_data/tsc2007.h>\n#include <linux/platform_data/media/timb_radio.h>\n#include <linux/platform_data/media/timb_video.h>\n\n#include <linux/timb_dma.h>\n\n#include <linux/ks8842.h>\n\n#include \"timberdale.h\"\n\n#define DRIVER_NAME \"timberdale\"\n\nstruct timberdale_device {\n\tresource_size_t\t\tctl_mapbase;\n\tunsigned char __iomem   *ctl_membase;\n\tstruct {\n\t\tu32 major;\n\t\tu32 minor;\n\t\tu32 config;\n\t} fw;\n};\n\n \n\nstatic struct tsc2007_platform_data timberdale_tsc2007_platform_data = {\n\t.model = 2003,\n\t.x_plate_ohms = 100\n};\n\nstatic struct i2c_board_info timberdale_i2c_board_info[] = {\n\t{\n\t\tI2C_BOARD_INFO(\"tsc2007\", 0x48),\n\t\t.platform_data = &timberdale_tsc2007_platform_data,\n\t\t.irq = IRQ_TIMBERDALE_TSC_INT\n\t},\n};\n\nstatic struct xiic_i2c_platform_data\ntimberdale_xiic_platform_data = {\n\t.devices = timberdale_i2c_board_info,\n\t.num_devices = ARRAY_SIZE(timberdale_i2c_board_info)\n};\n\nstatic struct ocores_i2c_platform_data\ntimberdale_ocores_platform_data = {\n\t.reg_shift = 2,\n\t.clock_khz = 62500,\n\t.devices = timberdale_i2c_board_info,\n\t.num_devices = ARRAY_SIZE(timberdale_i2c_board_info)\n};\n\nstatic const struct resource timberdale_xiic_resources[] = {\n\t{\n\t\t.start\t= XIICOFFSET,\n\t\t.end\t= XIICEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_I2C,\n\t\t.end\t= IRQ_TIMBERDALE_I2C,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct resource timberdale_ocores_resources[] = {\n\t{\n\t\t.start\t= OCORESOFFSET,\n\t\t.end\t= OCORESEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start \t= IRQ_TIMBERDALE_I2C,\n\t\t.end\t= IRQ_TIMBERDALE_I2C,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct max7301_platform_data timberdale_max7301_platform_data = {\n\t.base = 200\n};\n\nstatic const struct mc33880_platform_data timberdale_mc33880_platform_data = {\n\t.base = 100\n};\n\nstatic struct spi_board_info timberdale_spi_16bit_board_info[] = {\n\t{\n\t\t.modalias = \"max7301\",\n\t\t.max_speed_hz = 26000,\n\t\t.chip_select = 2,\n\t\t.mode = SPI_MODE_0,\n\t\t.platform_data = &timberdale_max7301_platform_data\n\t},\n};\n\nstatic struct spi_board_info timberdale_spi_8bit_board_info[] = {\n\t{\n\t\t.modalias = \"mc33880\",\n\t\t.max_speed_hz = 4000,\n\t\t.chip_select = 1,\n\t\t.mode = SPI_MODE_1,\n\t\t.platform_data = &timberdale_mc33880_platform_data\n\t},\n};\n\nstatic struct xspi_platform_data timberdale_xspi_platform_data = {\n\t.num_chipselect = 3,\n\t \n};\n\nstatic const struct resource timberdale_spi_resources[] = {\n\t{\n\t\t.start \t= SPIOFFSET,\n\t\t.end\t= SPIEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_SPI,\n\t\t.end\t= IRQ_TIMBERDALE_SPI,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic struct ks8842_platform_data\n\ttimberdale_ks8842_platform_data = {\n\t.rx_dma_channel = DMA_ETH_RX,\n\t.tx_dma_channel = DMA_ETH_TX\n};\n\nstatic const struct resource timberdale_eth_resources[] = {\n\t{\n\t\t.start\t= ETHOFFSET,\n\t\t.end\t= ETHEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_ETHSW_IF,\n\t\t.end\t= IRQ_TIMBERDALE_ETHSW_IF,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic struct timbgpio_platform_data\n\ttimberdale_gpio_platform_data = {\n\t.gpio_base = 0,\n\t.nr_pins = GPIO_NR_PINS,\n\t.irq_base = 200,\n};\n\nstatic const struct resource timberdale_gpio_resources[] = {\n\t{\n\t\t.start\t= GPIOOFFSET,\n\t\t.end\t= GPIOEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_GPIO,\n\t\t.end\t= IRQ_TIMBERDALE_GPIO,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct resource timberdale_mlogicore_resources[] = {\n\t{\n\t\t.start\t= MLCOREOFFSET,\n\t\t.end\t= MLCOREEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_MLCORE,\n\t\t.end\t= IRQ_TIMBERDALE_MLCORE,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_MLCORE_BUF,\n\t\t.end\t= IRQ_TIMBERDALE_MLCORE_BUF,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct resource timberdale_uart_resources[] = {\n\t{\n\t\t.start\t= UARTOFFSET,\n\t\t.end\t= UARTEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_UART,\n\t\t.end\t= IRQ_TIMBERDALE_UART,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct resource timberdale_uartlite_resources[] = {\n\t{\n\t\t.start\t= UARTLITEOFFSET,\n\t\t.end\t= UARTLITEEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_UARTLITE,\n\t\t.end\t= IRQ_TIMBERDALE_UARTLITE,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic struct i2c_board_info timberdale_adv7180_i2c_board_info = {\n\t \n\tI2C_BOARD_INFO(\"adv7180\", 0x42 >> 1),\n\t.irq = IRQ_TIMBERDALE_ADV7180\n};\n\nstatic struct timb_video_platform_data\n\ttimberdale_video_platform_data = {\n\t.dma_channel = DMA_VIDEO_RX,\n\t.i2c_adapter = 0,\n\t.encoder = {\n\t\t.info = &timberdale_adv7180_i2c_board_info\n\t}\n};\n\nstatic const struct resource\ntimberdale_radio_resources[] = {\n\t{\n\t\t.start\t= RDSOFFSET,\n\t\t.end\t= RDSEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_RDS,\n\t\t.end\t= IRQ_TIMBERDALE_RDS,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic struct i2c_board_info timberdale_tef6868_i2c_board_info = {\n\tI2C_BOARD_INFO(\"tef6862\", 0x60)\n};\n\nstatic struct i2c_board_info timberdale_saa7706_i2c_board_info = {\n\tI2C_BOARD_INFO(\"saa7706h\", 0x1C)\n};\n\nstatic struct timb_radio_platform_data\n\ttimberdale_radio_platform_data = {\n\t.i2c_adapter = 0,\n\t.tuner = &timberdale_tef6868_i2c_board_info,\n\t.dsp = &timberdale_saa7706_i2c_board_info\n};\n\nstatic const struct resource timberdale_video_resources[] = {\n\t{\n\t\t.start\t= LOGIWOFFSET,\n\t\t.end\t= LOGIWEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t \n};\n\nstatic struct timb_dma_platform_data timb_dma_platform_data = {\n\t.nr_channels = 10,\n\t.channels = {\n\t\t{\n\t\t\t \n\t\t\t.rx = true,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 1\n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = false,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 1\n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = true,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 1\n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = false,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 1\n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = true,\n\t\t\t.bytes_per_line = 1440,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 16\n\t\t},\n\t\t{\n\t\t\t \n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = true,\n\t\t},\n\t\t{\n\t\t\t \n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = true,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 1\n\t\t},\n\t\t{\n\t\t\t \n\t\t\t.rx = false,\n\t\t\t.descriptors = 2,\n\t\t\t.descriptor_elements = 1\n\t\t},\n\t}\n};\n\nstatic const struct resource timberdale_dma_resources[] = {\n\t{\n\t\t.start\t= DMAOFFSET,\n\t\t.end\t= DMAEND,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_DMA,\n\t\t.end\t= IRQ_TIMBERDALE_DMA,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct mfd_cell timberdale_cells_bar0_cfg0[] = {\n\t{\n\t\t.name = \"timb-dma\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_dma_resources),\n\t\t.resources = timberdale_dma_resources,\n\t\t.platform_data = &timb_dma_platform_data,\n\t\t.pdata_size = sizeof(timb_dma_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-uart\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_uart_resources),\n\t\t.resources = timberdale_uart_resources,\n\t},\n\t{\n\t\t.name = \"xiic-i2c\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_xiic_resources),\n\t\t.resources = timberdale_xiic_resources,\n\t\t.platform_data = &timberdale_xiic_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xiic_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-gpio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_gpio_resources),\n\t\t.resources = timberdale_gpio_resources,\n\t\t.platform_data = &timberdale_gpio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_gpio_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-video\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_video_resources),\n\t\t.resources = timberdale_video_resources,\n\t\t.platform_data = &timberdale_video_platform_data,\n\t\t.pdata_size = sizeof(timberdale_video_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-radio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_radio_resources),\n\t\t.resources = timberdale_radio_resources,\n\t\t.platform_data = &timberdale_radio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_radio_platform_data),\n\t},\n\t{\n\t\t.name = \"xilinx_spi\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_spi_resources),\n\t\t.resources = timberdale_spi_resources,\n\t\t.platform_data = &timberdale_xspi_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xspi_platform_data),\n\t},\n\t{\n\t\t.name = \"ks8842\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_eth_resources),\n\t\t.resources = timberdale_eth_resources,\n\t\t.platform_data = &timberdale_ks8842_platform_data,\n\t\t.pdata_size = sizeof(timberdale_ks8842_platform_data),\n\t},\n};\n\nstatic const struct mfd_cell timberdale_cells_bar0_cfg1[] = {\n\t{\n\t\t.name = \"timb-dma\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_dma_resources),\n\t\t.resources = timberdale_dma_resources,\n\t\t.platform_data = &timb_dma_platform_data,\n\t\t.pdata_size = sizeof(timb_dma_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-uart\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_uart_resources),\n\t\t.resources = timberdale_uart_resources,\n\t},\n\t{\n\t\t.name = \"uartlite\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_uartlite_resources),\n\t\t.resources = timberdale_uartlite_resources,\n\t},\n\t{\n\t\t.name = \"xiic-i2c\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_xiic_resources),\n\t\t.resources = timberdale_xiic_resources,\n\t\t.platform_data = &timberdale_xiic_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xiic_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-gpio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_gpio_resources),\n\t\t.resources = timberdale_gpio_resources,\n\t\t.platform_data = &timberdale_gpio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_gpio_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-mlogicore\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_mlogicore_resources),\n\t\t.resources = timberdale_mlogicore_resources,\n\t},\n\t{\n\t\t.name = \"timb-video\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_video_resources),\n\t\t.resources = timberdale_video_resources,\n\t\t.platform_data = &timberdale_video_platform_data,\n\t\t.pdata_size = sizeof(timberdale_video_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-radio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_radio_resources),\n\t\t.resources = timberdale_radio_resources,\n\t\t.platform_data = &timberdale_radio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_radio_platform_data),\n\t},\n\t{\n\t\t.name = \"xilinx_spi\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_spi_resources),\n\t\t.resources = timberdale_spi_resources,\n\t\t.platform_data = &timberdale_xspi_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xspi_platform_data),\n\t},\n\t{\n\t\t.name = \"ks8842\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_eth_resources),\n\t\t.resources = timberdale_eth_resources,\n\t\t.platform_data = &timberdale_ks8842_platform_data,\n\t\t.pdata_size = sizeof(timberdale_ks8842_platform_data),\n\t},\n};\n\nstatic const struct mfd_cell timberdale_cells_bar0_cfg2[] = {\n\t{\n\t\t.name = \"timb-dma\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_dma_resources),\n\t\t.resources = timberdale_dma_resources,\n\t\t.platform_data = &timb_dma_platform_data,\n\t\t.pdata_size = sizeof(timb_dma_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-uart\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_uart_resources),\n\t\t.resources = timberdale_uart_resources,\n\t},\n\t{\n\t\t.name = \"xiic-i2c\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_xiic_resources),\n\t\t.resources = timberdale_xiic_resources,\n\t\t.platform_data = &timberdale_xiic_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xiic_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-gpio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_gpio_resources),\n\t\t.resources = timberdale_gpio_resources,\n\t\t.platform_data = &timberdale_gpio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_gpio_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-video\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_video_resources),\n\t\t.resources = timberdale_video_resources,\n\t\t.platform_data = &timberdale_video_platform_data,\n\t\t.pdata_size = sizeof(timberdale_video_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-radio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_radio_resources),\n\t\t.resources = timberdale_radio_resources,\n\t\t.platform_data = &timberdale_radio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_radio_platform_data),\n\t},\n\t{\n\t\t.name = \"xilinx_spi\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_spi_resources),\n\t\t.resources = timberdale_spi_resources,\n\t\t.platform_data = &timberdale_xspi_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xspi_platform_data),\n\t},\n};\n\nstatic const struct mfd_cell timberdale_cells_bar0_cfg3[] = {\n\t{\n\t\t.name = \"timb-dma\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_dma_resources),\n\t\t.resources = timberdale_dma_resources,\n\t\t.platform_data = &timb_dma_platform_data,\n\t\t.pdata_size = sizeof(timb_dma_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-uart\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_uart_resources),\n\t\t.resources = timberdale_uart_resources,\n\t},\n\t{\n\t\t.name = \"ocores-i2c\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_ocores_resources),\n\t\t.resources = timberdale_ocores_resources,\n\t\t.platform_data = &timberdale_ocores_platform_data,\n\t\t.pdata_size = sizeof(timberdale_ocores_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-gpio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_gpio_resources),\n\t\t.resources = timberdale_gpio_resources,\n\t\t.platform_data = &timberdale_gpio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_gpio_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-video\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_video_resources),\n\t\t.resources = timberdale_video_resources,\n\t\t.platform_data = &timberdale_video_platform_data,\n\t\t.pdata_size = sizeof(timberdale_video_platform_data),\n\t},\n\t{\n\t\t.name = \"timb-radio\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_radio_resources),\n\t\t.resources = timberdale_radio_resources,\n\t\t.platform_data = &timberdale_radio_platform_data,\n\t\t.pdata_size = sizeof(timberdale_radio_platform_data),\n\t},\n\t{\n\t\t.name = \"xilinx_spi\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_spi_resources),\n\t\t.resources = timberdale_spi_resources,\n\t\t.platform_data = &timberdale_xspi_platform_data,\n\t\t.pdata_size = sizeof(timberdale_xspi_platform_data),\n\t},\n\t{\n\t\t.name = \"ks8842\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_eth_resources),\n\t\t.resources = timberdale_eth_resources,\n\t\t.platform_data = &timberdale_ks8842_platform_data,\n\t\t.pdata_size = sizeof(timberdale_ks8842_platform_data),\n\t},\n};\n\nstatic const struct resource timberdale_sdhc_resources[] = {\n\t \n\t{\n\t\t.start\t= SDHC0OFFSET,\n\t\t.end\t= SDHC0END,\n\t\t.flags\t= IORESOURCE_MEM,\n\t},\n\t{\n\t\t.start\t= IRQ_TIMBERDALE_SDHC,\n\t\t.end\t= IRQ_TIMBERDALE_SDHC,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct mfd_cell timberdale_cells_bar1[] = {\n\t{\n\t\t.name = \"sdhci\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_sdhc_resources),\n\t\t.resources = timberdale_sdhc_resources,\n\t},\n};\n\nstatic const struct mfd_cell timberdale_cells_bar2[] = {\n\t{\n\t\t.name = \"sdhci\",\n\t\t.num_resources = ARRAY_SIZE(timberdale_sdhc_resources),\n\t\t.resources = timberdale_sdhc_resources,\n\t},\n};\n\nstatic ssize_t fw_ver_show(struct device *dev,\n\t\t\t   struct device_attribute *attr, char *buf)\n{\n\tstruct timberdale_device *priv = dev_get_drvdata(dev);\n\n\treturn sprintf(buf, \"%d.%d.%d\\n\", priv->fw.major, priv->fw.minor,\n\t\tpriv->fw.config);\n}\n\nstatic DEVICE_ATTR_RO(fw_ver);\n\n \n\nstatic int timb_probe(struct pci_dev *dev,\n\tconst struct pci_device_id *id)\n{\n\tstruct timberdale_device *priv;\n\tint err, i;\n\tresource_size_t mapbase;\n\tstruct msix_entry *msix_entries = NULL;\n\tu8 ip_setup;\n\n\tpriv = kzalloc(sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpci_set_drvdata(dev, priv);\n\n\terr = pci_enable_device(dev);\n\tif (err)\n\t\tgoto err_enable;\n\n\tmapbase = pci_resource_start(dev, 0);\n\tif (!mapbase) {\n\t\tdev_err(&dev->dev, \"No resource\\n\");\n\t\tgoto err_start;\n\t}\n\n\t \n\tpriv->ctl_mapbase = mapbase + CHIPCTLOFFSET;\n\tif (!request_mem_region(priv->ctl_mapbase, CHIPCTLSIZE, \"timb-ctl\")) {\n\t\tdev_err(&dev->dev, \"Failed to request ctl mem\\n\");\n\t\tgoto err_start;\n\t}\n\n\tpriv->ctl_membase = ioremap(priv->ctl_mapbase, CHIPCTLSIZE);\n\tif (!priv->ctl_membase) {\n\t\tdev_err(&dev->dev, \"ioremap failed for ctl mem\\n\");\n\t\tgoto err_ioremap;\n\t}\n\n\t \n\tpriv->fw.major = ioread32(priv->ctl_membase + TIMB_REV_MAJOR);\n\tpriv->fw.minor = ioread32(priv->ctl_membase + TIMB_REV_MINOR);\n\tpriv->fw.config = ioread32(priv->ctl_membase + TIMB_HW_CONFIG);\n\n\tif (priv->fw.major > TIMB_SUPPORTED_MAJOR) {\n\t\tdev_err(&dev->dev, \"The driver supports an older \"\n\t\t\t\"version of the FPGA, please update the driver to \"\n\t\t\t\"support %d.%d\\n\", priv->fw.major, priv->fw.minor);\n\t\tgoto err_config;\n\t}\n\tif (priv->fw.major < TIMB_SUPPORTED_MAJOR ||\n\t\tpriv->fw.minor < TIMB_REQUIRED_MINOR) {\n\t\tdev_err(&dev->dev, \"The FPGA image is too old (%d.%d), \"\n\t\t\t\"please upgrade the FPGA to at least: %d.%d\\n\",\n\t\t\tpriv->fw.major, priv->fw.minor,\n\t\t\tTIMB_SUPPORTED_MAJOR, TIMB_REQUIRED_MINOR);\n\t\tgoto err_config;\n\t}\n\n\tmsix_entries = kcalloc(TIMBERDALE_NR_IRQS, sizeof(*msix_entries),\n\t\t\t       GFP_KERNEL);\n\tif (!msix_entries)\n\t\tgoto err_config;\n\n\tfor (i = 0; i < TIMBERDALE_NR_IRQS; i++)\n\t\tmsix_entries[i].entry = i;\n\n\terr = pci_enable_msix_exact(dev, msix_entries, TIMBERDALE_NR_IRQS);\n\tif (err) {\n\t\tdev_err(&dev->dev,\n\t\t\t\"MSI-X init failed: %d, expected entries: %d\\n\",\n\t\t\terr, TIMBERDALE_NR_IRQS);\n\t\tgoto err_msix;\n\t}\n\n\terr = device_create_file(&dev->dev, &dev_attr_fw_ver);\n\tif (err)\n\t\tgoto err_create_file;\n\n\t \n\tiowrite32(0x1, priv->ctl_membase + TIMB_SW_RST);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(timberdale_i2c_board_info); i++)\n\t\ttimberdale_i2c_board_info[i].irq =\n\t\t\tmsix_entries[timberdale_i2c_board_info[i].irq].vector;\n\n\t \n\tif (priv->fw.config & TIMB_HW_CONFIG_SPI_8BIT) {\n\t\ttimberdale_xspi_platform_data.bits_per_word = 8;\n\t\ttimberdale_xspi_platform_data.devices =\n\t\t\ttimberdale_spi_8bit_board_info;\n\t\ttimberdale_xspi_platform_data.num_devices =\n\t\t\tARRAY_SIZE(timberdale_spi_8bit_board_info);\n\t} else {\n\t\ttimberdale_xspi_platform_data.bits_per_word = 16;\n\t\ttimberdale_xspi_platform_data.devices =\n\t\t\ttimberdale_spi_16bit_board_info;\n\t\ttimberdale_xspi_platform_data.num_devices =\n\t\t\tARRAY_SIZE(timberdale_spi_16bit_board_info);\n\t}\n\n\tip_setup = priv->fw.config & TIMB_HW_VER_MASK;\n\tswitch (ip_setup) {\n\tcase TIMB_HW_VER0:\n\t\terr = mfd_add_devices(&dev->dev, -1,\n\t\t\ttimberdale_cells_bar0_cfg0,\n\t\t\tARRAY_SIZE(timberdale_cells_bar0_cfg0),\n\t\t\t&dev->resource[0], msix_entries[0].vector, NULL);\n\t\tbreak;\n\tcase TIMB_HW_VER1:\n\t\terr = mfd_add_devices(&dev->dev, -1,\n\t\t\ttimberdale_cells_bar0_cfg1,\n\t\t\tARRAY_SIZE(timberdale_cells_bar0_cfg1),\n\t\t\t&dev->resource[0], msix_entries[0].vector, NULL);\n\t\tbreak;\n\tcase TIMB_HW_VER2:\n\t\terr = mfd_add_devices(&dev->dev, -1,\n\t\t\ttimberdale_cells_bar0_cfg2,\n\t\t\tARRAY_SIZE(timberdale_cells_bar0_cfg2),\n\t\t\t&dev->resource[0], msix_entries[0].vector, NULL);\n\t\tbreak;\n\tcase TIMB_HW_VER3:\n\t\terr = mfd_add_devices(&dev->dev, -1,\n\t\t\ttimberdale_cells_bar0_cfg3,\n\t\t\tARRAY_SIZE(timberdale_cells_bar0_cfg3),\n\t\t\t&dev->resource[0], msix_entries[0].vector, NULL);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&dev->dev, \"Unknown IP setup: %d.%d.%d\\n\",\n\t\t\tpriv->fw.major, priv->fw.minor, ip_setup);\n\t\terr = -ENODEV;\n\t\tgoto err_mfd;\n\t}\n\n\tif (err) {\n\t\tdev_err(&dev->dev, \"mfd_add_devices failed: %d\\n\", err);\n\t\tgoto err_mfd;\n\t}\n\n\terr = mfd_add_devices(&dev->dev, 0,\n\t\ttimberdale_cells_bar1, ARRAY_SIZE(timberdale_cells_bar1),\n\t\t&dev->resource[1], msix_entries[0].vector, NULL);\n\tif (err) {\n\t\tdev_err(&dev->dev, \"mfd_add_devices failed: %d\\n\", err);\n\t\tgoto err_mfd2;\n\t}\n\n\t \n\tif (((priv->fw.config & TIMB_HW_VER_MASK) == TIMB_HW_VER0) ||\n\t\t((priv->fw.config & TIMB_HW_VER_MASK) == TIMB_HW_VER3)) {\n\t\terr = mfd_add_devices(&dev->dev, 1, timberdale_cells_bar2,\n\t\t\tARRAY_SIZE(timberdale_cells_bar2),\n\t\t\t&dev->resource[2], msix_entries[0].vector, NULL);\n\t\tif (err) {\n\t\t\tdev_err(&dev->dev, \"mfd_add_devices failed: %d\\n\", err);\n\t\t\tgoto err_mfd2;\n\t\t}\n\t}\n\n\tkfree(msix_entries);\n\n\tdev_info(&dev->dev,\n\t\t\"Found Timberdale Card. Rev: %d.%d, HW config: 0x%02x\\n\",\n\t\tpriv->fw.major, priv->fw.minor, priv->fw.config);\n\n\treturn 0;\n\nerr_mfd2:\n\tmfd_remove_devices(&dev->dev);\nerr_mfd:\n\tdevice_remove_file(&dev->dev, &dev_attr_fw_ver);\nerr_create_file:\n\tpci_disable_msix(dev);\nerr_msix:\n\tkfree(msix_entries);\nerr_config:\n\tiounmap(priv->ctl_membase);\nerr_ioremap:\n\trelease_mem_region(priv->ctl_mapbase, CHIPCTLSIZE);\nerr_start:\n\tpci_disable_device(dev);\nerr_enable:\n\tkfree(priv);\n\treturn -ENODEV;\n}\n\nstatic void timb_remove(struct pci_dev *dev)\n{\n\tstruct timberdale_device *priv = pci_get_drvdata(dev);\n\n\tmfd_remove_devices(&dev->dev);\n\n\tdevice_remove_file(&dev->dev, &dev_attr_fw_ver);\n\n\tiounmap(priv->ctl_membase);\n\trelease_mem_region(priv->ctl_mapbase, CHIPCTLSIZE);\n\n\tpci_disable_msix(dev);\n\tpci_disable_device(dev);\n\tkfree(priv);\n}\n\nstatic const struct pci_device_id timberdale_pci_tbl[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_TIMB, PCI_DEVICE_ID_TIMB) },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, timberdale_pci_tbl);\n\nstatic struct pci_driver timberdale_pci_driver = {\n\t.name = DRIVER_NAME,\n\t.id_table = timberdale_pci_tbl,\n\t.probe = timb_probe,\n\t.remove = timb_remove,\n};\n\nmodule_pci_driver(timberdale_pci_driver);\n\nMODULE_AUTHOR(\"Mocean Laboratories <info@mocean-labs.com>\");\nMODULE_VERSION(DRV_VERSION);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}