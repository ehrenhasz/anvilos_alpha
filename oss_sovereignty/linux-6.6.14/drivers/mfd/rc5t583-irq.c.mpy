{
  "module_name": "rc5t583-irq.c",
  "hash_id": "8694a5906757280a7e4d32cf2f00c67e0b413171c681b39a829b12b8654f91d3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/rc5t583-irq.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/mfd/rc5t583.h>\n\nenum int_type {\n\tSYS_INT  = 0x1,\n\tDCDC_INT = 0x2,\n\tRTC_INT  = 0x4,\n\tADC_INT  = 0x8,\n\tGPIO_INT = 0x10,\n};\n\nstatic int gpedge_add[] = {\n\tRC5T583_GPIO_GPEDGE2,\n\tRC5T583_GPIO_GPEDGE2\n};\n\nstatic int irq_en_add[] = {\n\tRC5T583_INT_EN_SYS1,\n\tRC5T583_INT_EN_SYS2,\n\tRC5T583_INT_EN_DCDC,\n\tRC5T583_INT_EN_RTC,\n\tRC5T583_INT_EN_ADC1,\n\tRC5T583_INT_EN_ADC2,\n\tRC5T583_INT_EN_ADC3,\n\tRC5T583_GPIO_EN_INT\n};\n\nstatic int irq_mon_add[] = {\n\tRC5T583_INT_MON_SYS1,\n\tRC5T583_INT_MON_SYS2,\n\tRC5T583_INT_MON_DCDC,\n\tRC5T583_INT_MON_RTC,\n\tRC5T583_INT_IR_ADCL,\n\tRC5T583_INT_IR_ADCH,\n\tRC5T583_INT_IR_ADCEND,\n\tRC5T583_INT_IR_GPIOF,\n\tRC5T583_INT_IR_GPIOR\n};\n\nstatic int irq_clr_add[] = {\n\tRC5T583_INT_IR_SYS1,\n\tRC5T583_INT_IR_SYS2,\n\tRC5T583_INT_IR_DCDC,\n\tRC5T583_INT_IR_RTC,\n\tRC5T583_INT_IR_ADCL,\n\tRC5T583_INT_IR_ADCH,\n\tRC5T583_INT_IR_ADCEND,\n\tRC5T583_INT_IR_GPIOF,\n\tRC5T583_INT_IR_GPIOR\n};\n\nstatic int main_int_type[] = {\n\tSYS_INT,\n\tSYS_INT,\n\tDCDC_INT,\n\tRTC_INT,\n\tADC_INT,\n\tADC_INT,\n\tADC_INT,\n\tGPIO_INT,\n\tGPIO_INT,\n};\n\nstruct rc5t583_irq_data {\n\tu8\tint_type;\n\tu8\tmaster_bit;\n\tu8\tint_en_bit;\n\tu8\tmask_reg_index;\n\tint\tgrp_index;\n};\n\n#define RC5T583_IRQ(_int_type, _master_bit, _grp_index, \\\n\t\t\t_int_bit, _mask_ind)\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.int_type\t= _int_type,\t\t\\\n\t\t.master_bit\t= _master_bit,\t\t\\\n\t\t.grp_index\t= _grp_index,\t\t\\\n\t\t.int_en_bit\t= _int_bit,\t\t\\\n\t\t.mask_reg_index\t= _mask_ind,\t\t\\\n\t}\n\nstatic const struct rc5t583_irq_data rc5t583_irqs[RC5T583_MAX_IRQS] = {\n\t[RC5T583_IRQ_ONKEY]\t\t= RC5T583_IRQ(SYS_INT,  0, 0, 0, 0),\n\t[RC5T583_IRQ_ACOK]\t\t= RC5T583_IRQ(SYS_INT,  0, 1, 1, 0),\n\t[RC5T583_IRQ_LIDOPEN]\t\t= RC5T583_IRQ(SYS_INT,  0, 2, 2, 0),\n\t[RC5T583_IRQ_PREOT]\t\t= RC5T583_IRQ(SYS_INT,  0, 3, 3, 0),\n\t[RC5T583_IRQ_CLKSTP]\t\t= RC5T583_IRQ(SYS_INT,  0, 4, 4, 0),\n\t[RC5T583_IRQ_ONKEY_OFF]\t\t= RC5T583_IRQ(SYS_INT,  0, 5, 5, 0),\n\t[RC5T583_IRQ_WD]\t\t= RC5T583_IRQ(SYS_INT,  0, 7, 7, 0),\n\t[RC5T583_IRQ_EN_PWRREQ1]\t= RC5T583_IRQ(SYS_INT,  0, 8, 0, 1),\n\t[RC5T583_IRQ_EN_PWRREQ2]\t= RC5T583_IRQ(SYS_INT,  0, 9, 1, 1),\n\t[RC5T583_IRQ_PRE_VINDET]\t= RC5T583_IRQ(SYS_INT,  0, 10, 2, 1),\n\n\t[RC5T583_IRQ_DC0LIM]\t\t= RC5T583_IRQ(DCDC_INT, 1, 0, 0, 2),\n\t[RC5T583_IRQ_DC1LIM]\t\t= RC5T583_IRQ(DCDC_INT, 1, 1, 1, 2),\n\t[RC5T583_IRQ_DC2LIM]\t\t= RC5T583_IRQ(DCDC_INT, 1, 2, 2, 2),\n\t[RC5T583_IRQ_DC3LIM]\t\t= RC5T583_IRQ(DCDC_INT, 1, 3, 3, 2),\n\n\t[RC5T583_IRQ_CTC]\t\t= RC5T583_IRQ(RTC_INT,  2, 0, 0, 3),\n\t[RC5T583_IRQ_YALE]\t\t= RC5T583_IRQ(RTC_INT,  2, 5, 5, 3),\n\t[RC5T583_IRQ_DALE]\t\t= RC5T583_IRQ(RTC_INT,  2, 6, 6, 3),\n\t[RC5T583_IRQ_WALE]\t\t= RC5T583_IRQ(RTC_INT,  2, 7, 7, 3),\n\n\t[RC5T583_IRQ_AIN1L]\t\t= RC5T583_IRQ(ADC_INT,  3, 0, 0, 4),\n\t[RC5T583_IRQ_AIN2L]\t\t= RC5T583_IRQ(ADC_INT,  3, 1, 1, 4),\n\t[RC5T583_IRQ_AIN3L]\t\t= RC5T583_IRQ(ADC_INT,  3, 2, 2, 4),\n\t[RC5T583_IRQ_VBATL]\t\t= RC5T583_IRQ(ADC_INT,  3, 3, 3, 4),\n\t[RC5T583_IRQ_VIN3L]\t\t= RC5T583_IRQ(ADC_INT,  3, 4, 4, 4),\n\t[RC5T583_IRQ_VIN8L]\t\t= RC5T583_IRQ(ADC_INT,  3, 5, 5, 4),\n\t[RC5T583_IRQ_AIN1H]\t\t= RC5T583_IRQ(ADC_INT,  3, 6, 0, 5),\n\t[RC5T583_IRQ_AIN2H]\t\t= RC5T583_IRQ(ADC_INT,  3, 7, 1, 5),\n\t[RC5T583_IRQ_AIN3H]\t\t= RC5T583_IRQ(ADC_INT,  3, 8, 2, 5),\n\t[RC5T583_IRQ_VBATH]\t\t= RC5T583_IRQ(ADC_INT,  3, 9, 3, 5),\n\t[RC5T583_IRQ_VIN3H]\t\t= RC5T583_IRQ(ADC_INT,  3, 10, 4, 5),\n\t[RC5T583_IRQ_VIN8H]\t\t= RC5T583_IRQ(ADC_INT,  3, 11, 5, 5),\n\t[RC5T583_IRQ_ADCEND]\t\t= RC5T583_IRQ(ADC_INT,  3, 12, 0, 6),\n\n\t[RC5T583_IRQ_GPIO0]\t\t= RC5T583_IRQ(GPIO_INT, 4, 0, 0, 7),\n\t[RC5T583_IRQ_GPIO1]\t\t= RC5T583_IRQ(GPIO_INT, 4, 1, 1, 7),\n\t[RC5T583_IRQ_GPIO2]\t\t= RC5T583_IRQ(GPIO_INT, 4, 2, 2, 7),\n\t[RC5T583_IRQ_GPIO3]\t\t= RC5T583_IRQ(GPIO_INT, 4, 3, 3, 7),\n\t[RC5T583_IRQ_GPIO4]\t\t= RC5T583_IRQ(GPIO_INT, 4, 4, 4, 7),\n\t[RC5T583_IRQ_GPIO5]\t\t= RC5T583_IRQ(GPIO_INT, 4, 5, 5, 7),\n\t[RC5T583_IRQ_GPIO6]\t\t= RC5T583_IRQ(GPIO_INT, 4, 6, 6, 7),\n\t[RC5T583_IRQ_GPIO7]\t\t= RC5T583_IRQ(GPIO_INT, 4, 7, 7, 7),\n};\n\nstatic void rc5t583_irq_lock(struct irq_data *irq_data)\n{\n\tstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\n\tmutex_lock(&rc5t583->irq_lock);\n}\n\nstatic void rc5t583_irq_unmask(struct irq_data *irq_data)\n{\n\tstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\n\tunsigned int __irq = irq_data->irq - rc5t583->irq_base;\n\tconst struct rc5t583_irq_data *data = &rc5t583_irqs[__irq];\n\n\trc5t583->group_irq_en[data->grp_index] |= 1 << data->grp_index;\n\trc5t583->intc_inten_reg |= 1 << data->master_bit;\n\trc5t583->irq_en_reg[data->mask_reg_index] |= 1 << data->int_en_bit;\n}\n\nstatic void rc5t583_irq_mask(struct irq_data *irq_data)\n{\n\tstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\n\tunsigned int __irq = irq_data->irq - rc5t583->irq_base;\n\tconst struct rc5t583_irq_data *data = &rc5t583_irqs[__irq];\n\n\trc5t583->group_irq_en[data->grp_index] &= ~(1 << data->grp_index);\n\tif (!rc5t583->group_irq_en[data->grp_index])\n\t\trc5t583->intc_inten_reg &= ~(1 << data->master_bit);\n\n\trc5t583->irq_en_reg[data->mask_reg_index] &= ~(1 << data->int_en_bit);\n}\n\nstatic int rc5t583_irq_set_type(struct irq_data *irq_data, unsigned int type)\n{\n\tstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\n\tunsigned int __irq = irq_data->irq - rc5t583->irq_base;\n\tconst struct rc5t583_irq_data *data = &rc5t583_irqs[__irq];\n\tint val = 0;\n\tint gpedge_index;\n\tint gpedge_bit_pos;\n\n\t \n\tif ((data->int_type & GPIO_INT) && (type & IRQ_TYPE_EDGE_BOTH)) {\n\t\tgpedge_index = data->int_en_bit / 4;\n\t\tgpedge_bit_pos = data->int_en_bit % 4;\n\n\t\tif (type & IRQ_TYPE_EDGE_FALLING)\n\t\t\tval |= 0x2;\n\n\t\tif (type & IRQ_TYPE_EDGE_RISING)\n\t\t\tval |= 0x1;\n\n\t\trc5t583->gpedge_reg[gpedge_index] &= ~(3 << gpedge_bit_pos);\n\t\trc5t583->gpedge_reg[gpedge_index] |= (val << gpedge_bit_pos);\n\t\trc5t583_irq_unmask(irq_data);\n\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstatic void rc5t583_irq_sync_unlock(struct irq_data *irq_data)\n{\n\tstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\n\tint i;\n\tint ret;\n\n\tfor (i = 0; i < ARRAY_SIZE(rc5t583->gpedge_reg); i++) {\n\t\tret = rc5t583_write(rc5t583->dev, gpedge_add[i],\n\t\t\t\trc5t583->gpedge_reg[i]);\n\t\tif (ret < 0)\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\t\tgpedge_add[i], ret);\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(rc5t583->irq_en_reg); i++) {\n\t\tret = rc5t583_write(rc5t583->dev, irq_en_add[i],\n\t\t\t\t\trc5t583->irq_en_reg[i]);\n\t\tif (ret < 0)\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\t\tirq_en_add[i], ret);\n\t}\n\n\tret = rc5t583_write(rc5t583->dev, RC5T583_INTC_INTEN,\n\t\t\t\trc5t583->intc_inten_reg);\n\tif (ret < 0)\n\t\tdev_warn(rc5t583->dev,\n\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\tRC5T583_INTC_INTEN, ret);\n\n\tmutex_unlock(&rc5t583->irq_lock);\n}\n\nstatic int rc5t583_irq_set_wake(struct irq_data *irq_data, unsigned int on)\n{\n\tstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\n\treturn irq_set_irq_wake(rc5t583->chip_irq, on);\n}\n\nstatic irqreturn_t rc5t583_irq(int irq, void *data)\n{\n\tstruct rc5t583 *rc5t583 = data;\n\tuint8_t int_sts[RC5T583_MAX_INTERRUPT_MASK_REGS];\n\tuint8_t master_int = 0;\n\tint i;\n\tint ret;\n\tunsigned int rtc_int_sts = 0;\n\n\t \n\tfor (i = 0; i < RC5T583_MAX_INTERRUPT_MASK_REGS; i++)\n\t\tint_sts[i] = 0;\n\n\tret  = rc5t583_read(rc5t583->dev, RC5T583_INTC_INTMON, &master_int);\n\tif (ret < 0) {\n\t\tdev_err(rc5t583->dev,\n\t\t\t\"Error in reading reg 0x%02x error: %d\\n\",\n\t\t\tRC5T583_INTC_INTMON, ret);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tfor (i = 0; i < RC5T583_MAX_INTERRUPT_MASK_REGS; ++i) {\n\t\tif (!(master_int & main_int_type[i]))\n\t\t\tcontinue;\n\n\t\tret = rc5t583_read(rc5t583->dev, irq_mon_add[i], &int_sts[i]);\n\t\tif (ret < 0) {\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in reading reg 0x%02x error: %d\\n\",\n\t\t\t\tirq_mon_add[i], ret);\n\t\t\tint_sts[i] = 0;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (main_int_type[i] & RTC_INT) {\n\t\t\trtc_int_sts = 0;\n\t\t\tif (int_sts[i] & 0x1)\n\t\t\t\trtc_int_sts |= BIT(6);\n\t\t\tif (int_sts[i] & 0x2)\n\t\t\t\trtc_int_sts |= BIT(7);\n\t\t\tif (int_sts[i] & 0x4)\n\t\t\t\trtc_int_sts |= BIT(0);\n\t\t\tif (int_sts[i] & 0x8)\n\t\t\t\trtc_int_sts |= BIT(5);\n\t\t}\n\n\t\tret = rc5t583_write(rc5t583->dev, irq_clr_add[i],\n\t\t\t\t~int_sts[i]);\n\t\tif (ret < 0)\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in reading reg 0x%02x error: %d\\n\",\n\t\t\t\tirq_clr_add[i], ret);\n\n\t\tif (main_int_type[i] & RTC_INT)\n\t\t\tint_sts[i] = rtc_int_sts;\n\t}\n\n\t \n\tint_sts[7] |= int_sts[8];\n\n\t \n\tfor (i = 0; i < RC5T583_MAX_IRQS; ++i) {\n\t\tconst struct rc5t583_irq_data *data = &rc5t583_irqs[i];\n\t\tif ((int_sts[data->mask_reg_index] & (1 << data->int_en_bit)) &&\n\t\t\t(rc5t583->group_irq_en[data->master_bit] &\n\t\t\t\t\t(1 << data->grp_index)))\n\t\t\thandle_nested_irq(rc5t583->irq_base + i);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic struct irq_chip rc5t583_irq_chip = {\n\t.name = \"rc5t583-irq\",\n\t.irq_mask = rc5t583_irq_mask,\n\t.irq_unmask = rc5t583_irq_unmask,\n\t.irq_bus_lock = rc5t583_irq_lock,\n\t.irq_bus_sync_unlock = rc5t583_irq_sync_unlock,\n\t.irq_set_type = rc5t583_irq_set_type,\n\t.irq_set_wake = pm_sleep_ptr(rc5t583_irq_set_wake),\n};\n\nint rc5t583_irq_init(struct rc5t583 *rc5t583, int irq, int irq_base)\n{\n\tint i, ret;\n\n\tif (!irq_base) {\n\t\tdev_warn(rc5t583->dev, \"No interrupt support on IRQ base\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmutex_init(&rc5t583->irq_lock);\n\n\t \n\tfor (i = 0; i < RC5T583_MAX_INTERRUPT_EN_REGS; i++)  {\n\t\tret = rc5t583_write(rc5t583->dev, irq_en_add[i],\n\t\t\t\trc5t583->irq_en_reg[i]);\n\t\tif (ret < 0)\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\t\tirq_en_add[i], ret);\n\t}\n\n\tfor (i = 0; i < RC5T583_MAX_GPEDGE_REG; i++)  {\n\t\tret = rc5t583_write(rc5t583->dev, gpedge_add[i],\n\t\t\t\trc5t583->gpedge_reg[i]);\n\t\tif (ret < 0)\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\t\tgpedge_add[i], ret);\n\t}\n\n\tret = rc5t583_write(rc5t583->dev, RC5T583_INTC_INTEN, 0x0);\n\tif (ret < 0)\n\t\tdev_warn(rc5t583->dev,\n\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\tRC5T583_INTC_INTEN, ret);\n\n\t \n\tfor (i = 0; i < RC5T583_MAX_INTERRUPT_MASK_REGS; i++)  {\n\t\tret = rc5t583_write(rc5t583->dev, irq_clr_add[i], 0);\n\t\tif (ret < 0)\n\t\t\tdev_warn(rc5t583->dev,\n\t\t\t\t\"Error in writing reg 0x%02x error: %d\\n\",\n\t\t\t\tirq_clr_add[i], ret);\n\t}\n\n\trc5t583->irq_base = irq_base;\n\trc5t583->chip_irq = irq;\n\n\tfor (i = 0; i < RC5T583_MAX_IRQS; i++) {\n\t\tint __irq = i + rc5t583->irq_base;\n\t\tirq_set_chip_data(__irq, rc5t583);\n\t\tirq_set_chip_and_handler(__irq, &rc5t583_irq_chip,\n\t\t\t\t\t handle_simple_irq);\n\t\tirq_set_nested_thread(__irq, 1);\n\t\tirq_clear_status_flags(__irq, IRQ_NOREQUEST);\n\t}\n\n\tret = devm_request_threaded_irq(rc5t583->dev, irq, NULL, rc5t583_irq,\n\t\t\t\t\tIRQF_ONESHOT, \"rc5t583\", rc5t583);\n\tif (ret < 0)\n\t\tdev_err(rc5t583->dev,\n\t\t\t\"Error in registering interrupt error: %d\\n\", ret);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}