{
  "module_name": "max8907.c",
  "hash_id": "7b16b01876cf985d71a32bfdfdeedcadf65d40f17c254ffa489ffe688f9e9b2d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max8907.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max8907.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\nstatic const struct mfd_cell max8907_cells[] = {\n\t{ .name = \"max8907-regulator\", },\n\t{ .name = \"max8907-rtc\", },\n};\n\nstatic bool max8907_gen_is_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX8907_REG_ON_OFF_IRQ1:\n\tcase MAX8907_REG_ON_OFF_STAT:\n\tcase MAX8907_REG_ON_OFF_IRQ2:\n\tcase MAX8907_REG_CHG_IRQ1:\n\tcase MAX8907_REG_CHG_IRQ2:\n\tcase MAX8907_REG_CHG_STAT:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool max8907_gen_is_precious_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX8907_REG_ON_OFF_IRQ1:\n\tcase MAX8907_REG_ON_OFF_IRQ2:\n\tcase MAX8907_REG_CHG_IRQ1:\n\tcase MAX8907_REG_CHG_IRQ2:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool max8907_gen_is_writeable_reg(struct device *dev, unsigned int reg)\n{\n\treturn !max8907_gen_is_volatile_reg(dev, reg);\n}\n\nstatic const struct regmap_config max8907_regmap_gen_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.volatile_reg = max8907_gen_is_volatile_reg,\n\t.precious_reg = max8907_gen_is_precious_reg,\n\t.writeable_reg = max8907_gen_is_writeable_reg,\n\t.max_register = MAX8907_REG_LDO20VOUT,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\nstatic bool max8907_rtc_is_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tif (reg <= MAX8907_REG_RTC_YEAR2)\n\t\treturn true;\n\n\tswitch (reg) {\n\tcase MAX8907_REG_RTC_STATUS:\n\tcase MAX8907_REG_RTC_IRQ:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool max8907_rtc_is_precious_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX8907_REG_RTC_IRQ:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool max8907_rtc_is_writeable_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MAX8907_REG_RTC_STATUS:\n\tcase MAX8907_REG_RTC_IRQ:\n\t\treturn false;\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic const struct regmap_config max8907_regmap_rtc_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.volatile_reg = max8907_rtc_is_volatile_reg,\n\t.precious_reg = max8907_rtc_is_precious_reg,\n\t.writeable_reg = max8907_rtc_is_writeable_reg,\n\t.max_register = MAX8907_REG_MPL_CNTL,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\nstatic const struct regmap_irq max8907_chg_irqs[] = {\n\t{ .reg_offset = 0, .mask = 1 << 0, },\n\t{ .reg_offset = 0, .mask = 1 << 1, },\n\t{ .reg_offset = 0, .mask = 1 << 2, },\n\t{ .reg_offset = 1, .mask = 1 << 0, },\n\t{ .reg_offset = 1, .mask = 1 << 1, },\n\t{ .reg_offset = 1, .mask = 1 << 2, },\n\t{ .reg_offset = 1, .mask = 1 << 3, },\n\t{ .reg_offset = 1, .mask = 1 << 4, },\n\t{ .reg_offset = 1, .mask = 1 << 5, },\n\t{ .reg_offset = 1, .mask = 1 << 6, },\n\t{ .reg_offset = 1, .mask = 1 << 7, },\n};\n\nstatic const struct regmap_irq_chip max8907_chg_irq_chip = {\n\t.name = \"max8907 chg\",\n\t.status_base = MAX8907_REG_CHG_IRQ1,\n\t.mask_base = MAX8907_REG_CHG_IRQ1_MASK,\n\t.wake_base = MAX8907_REG_CHG_IRQ1_MASK,\n\t.irq_reg_stride = MAX8907_REG_CHG_IRQ2 - MAX8907_REG_CHG_IRQ1,\n\t.num_regs = 2,\n\t.irqs = max8907_chg_irqs,\n\t.num_irqs = ARRAY_SIZE(max8907_chg_irqs),\n};\n\nstatic const struct regmap_irq max8907_on_off_irqs[] = {\n\t{ .reg_offset = 0, .mask = 1 << 0, },\n\t{ .reg_offset = 0, .mask = 1 << 1, },\n\t{ .reg_offset = 0, .mask = 1 << 2, },\n\t{ .reg_offset = 0, .mask = 1 << 3, },\n\t{ .reg_offset = 0, .mask = 1 << 4, },\n\t{ .reg_offset = 0, .mask = 1 << 5, },\n\t{ .reg_offset = 0, .mask = 1 << 6, },\n\t{ .reg_offset = 0, .mask = 1 << 7, },\n\t{ .reg_offset = 1, .mask = 1 << 0, },\n\t{ .reg_offset = 1, .mask = 1 << 1, },\n};\n\nstatic const struct regmap_irq_chip max8907_on_off_irq_chip = {\n\t.name = \"max8907 on_off\",\n\t.status_base = MAX8907_REG_ON_OFF_IRQ1,\n\t.mask_base = MAX8907_REG_ON_OFF_IRQ1_MASK,\n\t.irq_reg_stride = MAX8907_REG_ON_OFF_IRQ2 - MAX8907_REG_ON_OFF_IRQ1,\n\t.num_regs = 2,\n\t.irqs = max8907_on_off_irqs,\n\t.num_irqs = ARRAY_SIZE(max8907_on_off_irqs),\n};\n\nstatic const struct regmap_irq max8907_rtc_irqs[] = {\n\t{ .reg_offset = 0, .mask = 1 << 2, },\n\t{ .reg_offset = 0, .mask = 1 << 3, },\n};\n\nstatic const struct regmap_irq_chip max8907_rtc_irq_chip = {\n\t.name = \"max8907 rtc\",\n\t.status_base = MAX8907_REG_RTC_IRQ,\n\t.mask_base = MAX8907_REG_RTC_IRQ_MASK,\n\t.num_regs = 1,\n\t.irqs = max8907_rtc_irqs,\n\t.num_irqs = ARRAY_SIZE(max8907_rtc_irqs),\n};\n\nstatic struct max8907 *max8907_pm_off;\nstatic void max8907_power_off(void)\n{\n\tregmap_update_bits(max8907_pm_off->regmap_gen, MAX8907_REG_RESET_CNFG,\n\t\t\tMAX8907_MASK_POWER_OFF, MAX8907_MASK_POWER_OFF);\n}\n\nstatic int max8907_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct max8907 *max8907;\n\tint ret;\n\tstruct max8907_platform_data *pdata = dev_get_platdata(&i2c->dev);\n\tbool pm_off = false;\n\n\tif (pdata)\n\t\tpm_off = pdata->pm_off;\n\telse if (i2c->dev.of_node)\n\t\tpm_off = of_property_read_bool(i2c->dev.of_node,\n\t\t\t\t\t\"maxim,system-power-controller\");\n\n\tmax8907 = devm_kzalloc(&i2c->dev, sizeof(struct max8907), GFP_KERNEL);\n\tif (!max8907) {\n\t\tret = -ENOMEM;\n\t\tgoto err_alloc_drvdata;\n\t}\n\n\tmax8907->dev = &i2c->dev;\n\tmax8907->i2c_gen = i2c;\n\ti2c_set_clientdata(i2c, max8907);\n\tmax8907->regmap_gen = devm_regmap_init_i2c(i2c,\n\t\t\t\t\t\t&max8907_regmap_gen_config);\n\tif (IS_ERR(max8907->regmap_gen)) {\n\t\tret = PTR_ERR(max8907->regmap_gen);\n\t\tdev_err(&i2c->dev, \"gen regmap init failed: %d\\n\", ret);\n\t\tgoto err_regmap_gen;\n\t}\n\n\tmax8907->i2c_rtc = i2c_new_dummy_device(i2c->adapter, MAX8907_RTC_I2C_ADDR);\n\tif (IS_ERR(max8907->i2c_rtc)) {\n\t\tret = PTR_ERR(max8907->i2c_rtc);\n\t\tgoto err_dummy_rtc;\n\t}\n\ti2c_set_clientdata(max8907->i2c_rtc, max8907);\n\tmax8907->regmap_rtc = devm_regmap_init_i2c(max8907->i2c_rtc,\n\t\t\t\t\t\t&max8907_regmap_rtc_config);\n\tif (IS_ERR(max8907->regmap_rtc)) {\n\t\tret = PTR_ERR(max8907->regmap_rtc);\n\t\tdev_err(&i2c->dev, \"rtc regmap init failed: %d\\n\", ret);\n\t\tgoto err_regmap_rtc;\n\t}\n\n\tret = regmap_add_irq_chip(max8907->regmap_gen, max8907->i2c_gen->irq,\n\t\t\t\t  IRQF_ONESHOT | IRQF_SHARED,\n\t\t\t\t  -1, &max8907_chg_irq_chip,\n\t\t\t\t  &max8907->irqc_chg);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"failed to add chg irq chip: %d\\n\", ret);\n\t\tgoto err_irqc_chg;\n\t}\n\tret = regmap_add_irq_chip(max8907->regmap_gen, max8907->i2c_gen->irq,\n\t\t\t\t  IRQF_ONESHOT | IRQF_SHARED, -1,\n\t\t\t\t  &max8907_on_off_irq_chip,\n\t\t\t\t  &max8907->irqc_on_off);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"failed to add on off irq chip: %d\\n\", ret);\n\t\tgoto err_irqc_on_off;\n\t}\n\tret = regmap_add_irq_chip(max8907->regmap_rtc, max8907->i2c_gen->irq,\n\t\t\t\t  IRQF_ONESHOT | IRQF_SHARED, -1,\n\t\t\t\t  &max8907_rtc_irq_chip,\n\t\t\t\t  &max8907->irqc_rtc);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"failed to add rtc irq chip: %d\\n\", ret);\n\t\tgoto err_irqc_rtc;\n\t}\n\n\tret = mfd_add_devices(max8907->dev, -1, max8907_cells,\n\t\t\t      ARRAY_SIZE(max8907_cells), NULL, 0, NULL);\n\tif (ret != 0) {\n\t\tdev_err(&i2c->dev, \"failed to add MFD devices %d\\n\", ret);\n\t\tgoto err_add_devices;\n\t}\n\n\tif (pm_off && !pm_power_off) {\n\t\tmax8907_pm_off = max8907;\n\t\tpm_power_off = max8907_power_off;\n\t}\n\n\treturn 0;\n\nerr_add_devices:\n\tregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_rtc);\nerr_irqc_rtc:\n\tregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_on_off);\nerr_irqc_on_off:\n\tregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_chg);\nerr_irqc_chg:\nerr_regmap_rtc:\n\ti2c_unregister_device(max8907->i2c_rtc);\nerr_dummy_rtc:\nerr_regmap_gen:\nerr_alloc_drvdata:\n\treturn ret;\n}\n\nstatic void max8907_i2c_remove(struct i2c_client *i2c)\n{\n\tstruct max8907 *max8907 = i2c_get_clientdata(i2c);\n\n\tmfd_remove_devices(max8907->dev);\n\n\tregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_rtc);\n\tregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_on_off);\n\tregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_chg);\n\n\ti2c_unregister_device(max8907->i2c_rtc);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id max8907_of_match[] = {\n\t{ .compatible = \"maxim,max8907\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, max8907_of_match);\n#endif\n\nstatic const struct i2c_device_id max8907_i2c_id[] = {\n\t{\"max8907\", 0},\n\t{}\n};\nMODULE_DEVICE_TABLE(i2c, max8907_i2c_id);\n\nstatic struct i2c_driver max8907_i2c_driver = {\n\t.driver = {\n\t\t.name = \"max8907\",\n\t\t.of_match_table = of_match_ptr(max8907_of_match),\n\t},\n\t.probe = max8907_i2c_probe,\n\t.remove = max8907_i2c_remove,\n\t.id_table = max8907_i2c_id,\n};\n\nstatic int __init max8907_i2c_init(void)\n{\n\tint ret = -ENODEV;\n\n\tret = i2c_add_driver(&max8907_i2c_driver);\n\tif (ret != 0)\n\t\tpr_err(\"Failed to register I2C driver: %d\\n\", ret);\n\n\treturn ret;\n}\nsubsys_initcall(max8907_i2c_init);\n\nstatic void __exit max8907_i2c_exit(void)\n{\n\ti2c_del_driver(&max8907_i2c_driver);\n}\nmodule_exit(max8907_i2c_exit);\n\nMODULE_DESCRIPTION(\"MAX8907 multi-function core driver\");\nMODULE_AUTHOR(\"Gyungoh Yoo <jack.yoo@maxim-ic.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}