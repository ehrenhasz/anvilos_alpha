{
  "module_name": "max8997.c",
  "hash_id": "59e6bfb429dc3b85a91a31dc72620cf98ce956b0a0953eaec02ad12335b7bb17",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max8997.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n#include <linux/err.h>\n#include <linux/slab.h>\n#include <linux/i2c.h>\n#include <linux/of.h>\n#include <linux/of_irq.h>\n#include <linux/interrupt.h>\n#include <linux/pm_runtime.h>\n#include <linux/init.h>\n#include <linux/mutex.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max8997.h>\n#include <linux/mfd/max8997-private.h>\n\n#define I2C_ADDR_PMIC\t(0xCC >> 1)\n#define I2C_ADDR_MUIC\t(0x4A >> 1)\n#define I2C_ADDR_BATTERY\t(0x6C >> 1)\n#define I2C_ADDR_RTC\t(0x0C >> 1)\n#define I2C_ADDR_HAPTIC\t(0x90 >> 1)\n\nstatic const struct mfd_cell max8997_devs[] = {\n\t{ .name = \"max8997-pmic\", },\n\t{ .name = \"max8997-rtc\", },\n\t{ .name = \"max8997-battery\", },\n\t{ .name = \"max8997-haptic\", },\n\t{ .name = \"max8997-muic\", },\n\t{ .name = \"max8997-led\", .id = 1 },\n\t{ .name = \"max8997-led\", .id = 2 },\n};\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id max8997_pmic_dt_match[] = {\n\t{ .compatible = \"maxim,max8997-pmic\", .data = (void *)TYPE_MAX8997 },\n\t{},\n};\n#endif\n\nint max8997_read_reg(struct i2c_client *i2c, u8 reg, u8 *dest)\n{\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8997->iolock);\n\tret = i2c_smbus_read_byte_data(i2c, reg);\n\tmutex_unlock(&max8997->iolock);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret &= 0xff;\n\t*dest = ret;\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max8997_read_reg);\n\nint max8997_bulk_read(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\n{\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8997->iolock);\n\tret = i2c_smbus_read_i2c_block_data(i2c, reg, count, buf);\n\tmutex_unlock(&max8997->iolock);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max8997_bulk_read);\n\nint max8997_write_reg(struct i2c_client *i2c, u8 reg, u8 value)\n{\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8997->iolock);\n\tret = i2c_smbus_write_byte_data(i2c, reg, value);\n\tmutex_unlock(&max8997->iolock);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(max8997_write_reg);\n\nint max8997_bulk_write(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\n{\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8997->iolock);\n\tret = i2c_smbus_write_i2c_block_data(i2c, reg, count, buf);\n\tmutex_unlock(&max8997->iolock);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max8997_bulk_write);\n\nint max8997_update_reg(struct i2c_client *i2c, u8 reg, u8 val, u8 mask)\n{\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8997->iolock);\n\tret = i2c_smbus_read_byte_data(i2c, reg);\n\tif (ret >= 0) {\n\t\tu8 old_val = ret & 0xff;\n\t\tu8 new_val = (val & mask) | (old_val & (~mask));\n\t\tret = i2c_smbus_write_byte_data(i2c, reg, new_val);\n\t}\n\tmutex_unlock(&max8997->iolock);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(max8997_update_reg);\n\n \nstatic struct max8997_platform_data *max8997_i2c_parse_dt_pdata(\n\t\t\t\t\tstruct device *dev)\n{\n\tstruct max8997_platform_data *pd;\n\n\tpd = devm_kzalloc(dev, sizeof(*pd), GFP_KERNEL);\n\tif (!pd)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpd->ono = irq_of_parse_and_map(dev->of_node, 1);\n\n\treturn pd;\n}\n\nstatic inline unsigned long max8997_i2c_get_driver_data(struct i2c_client *i2c,\n\t\t\t\t\t\tconst struct i2c_device_id *id)\n{\n\tif (i2c->dev.of_node)\n\t\treturn (unsigned long)of_device_get_match_data(&i2c->dev);\n\n\treturn id->driver_data;\n}\n\nstatic int max8997_i2c_probe(struct i2c_client *i2c)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(i2c);\n\tstruct max8997_dev *max8997;\n\tstruct max8997_platform_data *pdata = dev_get_platdata(&i2c->dev);\n\tint ret = 0;\n\n\tmax8997 = devm_kzalloc(&i2c->dev, sizeof(struct max8997_dev),\n\t\t\t\tGFP_KERNEL);\n\tif (max8997 == NULL)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(i2c, max8997);\n\tmax8997->dev = &i2c->dev;\n\tmax8997->i2c = i2c;\n\tmax8997->type = max8997_i2c_get_driver_data(i2c, id);\n\tmax8997->irq = i2c->irq;\n\n\tif (IS_ENABLED(CONFIG_OF) && max8997->dev->of_node) {\n\t\tpdata = max8997_i2c_parse_dt_pdata(max8997->dev);\n\t\tif (IS_ERR(pdata))\n\t\t\treturn PTR_ERR(pdata);\n\t}\n\n\tif (!pdata)\n\t\treturn ret;\n\n\tmax8997->pdata = pdata;\n\tmax8997->ono = pdata->ono;\n\n\tmutex_init(&max8997->iolock);\n\n\tmax8997->rtc = i2c_new_dummy_device(i2c->adapter, I2C_ADDR_RTC);\n\tif (IS_ERR(max8997->rtc)) {\n\t\tdev_err(max8997->dev, \"Failed to allocate I2C device for RTC\\n\");\n\t\treturn PTR_ERR(max8997->rtc);\n\t}\n\ti2c_set_clientdata(max8997->rtc, max8997);\n\n\tmax8997->haptic = i2c_new_dummy_device(i2c->adapter, I2C_ADDR_HAPTIC);\n\tif (IS_ERR(max8997->haptic)) {\n\t\tdev_err(max8997->dev, \"Failed to allocate I2C device for Haptic\\n\");\n\t\tret = PTR_ERR(max8997->haptic);\n\t\tgoto err_i2c_haptic;\n\t}\n\ti2c_set_clientdata(max8997->haptic, max8997);\n\n\tmax8997->muic = i2c_new_dummy_device(i2c->adapter, I2C_ADDR_MUIC);\n\tif (IS_ERR(max8997->muic)) {\n\t\tdev_err(max8997->dev, \"Failed to allocate I2C device for MUIC\\n\");\n\t\tret = PTR_ERR(max8997->muic);\n\t\tgoto err_i2c_muic;\n\t}\n\ti2c_set_clientdata(max8997->muic, max8997);\n\n\tpm_runtime_set_active(max8997->dev);\n\n\tmax8997_irq_init(max8997);\n\n\tret = mfd_add_devices(max8997->dev, -1, max8997_devs,\n\t\t\tARRAY_SIZE(max8997_devs),\n\t\t\tNULL, 0, NULL);\n\tif (ret < 0) {\n\t\tdev_err(max8997->dev, \"failed to add MFD devices %d\\n\", ret);\n\t\tgoto err_mfd;\n\t}\n\n\t \n\n\t \n\tdevice_init_wakeup(max8997->dev, true);\n\n\treturn ret;\n\nerr_mfd:\n\tmfd_remove_devices(max8997->dev);\n\ti2c_unregister_device(max8997->muic);\nerr_i2c_muic:\n\ti2c_unregister_device(max8997->haptic);\nerr_i2c_haptic:\n\ti2c_unregister_device(max8997->rtc);\n\treturn ret;\n}\n\nstatic const struct i2c_device_id max8997_i2c_id[] = {\n\t{ \"max8997\", TYPE_MAX8997 },\n\t{ \"max8966\", TYPE_MAX8966 },\n\t{ }\n};\n\nstatic u8 max8997_dumpaddr_pmic[] = {\n\tMAX8997_REG_INT1MSK,\n\tMAX8997_REG_INT2MSK,\n\tMAX8997_REG_INT3MSK,\n\tMAX8997_REG_INT4MSK,\n\tMAX8997_REG_MAINCON1,\n\tMAX8997_REG_MAINCON2,\n\tMAX8997_REG_BUCKRAMP,\n\tMAX8997_REG_BUCK1CTRL,\n\tMAX8997_REG_BUCK1DVS1,\n\tMAX8997_REG_BUCK1DVS2,\n\tMAX8997_REG_BUCK1DVS3,\n\tMAX8997_REG_BUCK1DVS4,\n\tMAX8997_REG_BUCK1DVS5,\n\tMAX8997_REG_BUCK1DVS6,\n\tMAX8997_REG_BUCK1DVS7,\n\tMAX8997_REG_BUCK1DVS8,\n\tMAX8997_REG_BUCK2CTRL,\n\tMAX8997_REG_BUCK2DVS1,\n\tMAX8997_REG_BUCK2DVS2,\n\tMAX8997_REG_BUCK2DVS3,\n\tMAX8997_REG_BUCK2DVS4,\n\tMAX8997_REG_BUCK2DVS5,\n\tMAX8997_REG_BUCK2DVS6,\n\tMAX8997_REG_BUCK2DVS7,\n\tMAX8997_REG_BUCK2DVS8,\n\tMAX8997_REG_BUCK3CTRL,\n\tMAX8997_REG_BUCK3DVS,\n\tMAX8997_REG_BUCK4CTRL,\n\tMAX8997_REG_BUCK4DVS,\n\tMAX8997_REG_BUCK5CTRL,\n\tMAX8997_REG_BUCK5DVS1,\n\tMAX8997_REG_BUCK5DVS2,\n\tMAX8997_REG_BUCK5DVS3,\n\tMAX8997_REG_BUCK5DVS4,\n\tMAX8997_REG_BUCK5DVS5,\n\tMAX8997_REG_BUCK5DVS6,\n\tMAX8997_REG_BUCK5DVS7,\n\tMAX8997_REG_BUCK5DVS8,\n\tMAX8997_REG_BUCK6CTRL,\n\tMAX8997_REG_BUCK6BPSKIPCTRL,\n\tMAX8997_REG_BUCK7CTRL,\n\tMAX8997_REG_BUCK7DVS,\n\tMAX8997_REG_LDO1CTRL,\n\tMAX8997_REG_LDO2CTRL,\n\tMAX8997_REG_LDO3CTRL,\n\tMAX8997_REG_LDO4CTRL,\n\tMAX8997_REG_LDO5CTRL,\n\tMAX8997_REG_LDO6CTRL,\n\tMAX8997_REG_LDO7CTRL,\n\tMAX8997_REG_LDO8CTRL,\n\tMAX8997_REG_LDO9CTRL,\n\tMAX8997_REG_LDO10CTRL,\n\tMAX8997_REG_LDO11CTRL,\n\tMAX8997_REG_LDO12CTRL,\n\tMAX8997_REG_LDO13CTRL,\n\tMAX8997_REG_LDO14CTRL,\n\tMAX8997_REG_LDO15CTRL,\n\tMAX8997_REG_LDO16CTRL,\n\tMAX8997_REG_LDO17CTRL,\n\tMAX8997_REG_LDO18CTRL,\n\tMAX8997_REG_LDO21CTRL,\n\tMAX8997_REG_MBCCTRL1,\n\tMAX8997_REG_MBCCTRL2,\n\tMAX8997_REG_MBCCTRL3,\n\tMAX8997_REG_MBCCTRL4,\n\tMAX8997_REG_MBCCTRL5,\n\tMAX8997_REG_MBCCTRL6,\n\tMAX8997_REG_OTPCGHCVS,\n\tMAX8997_REG_SAFEOUTCTRL,\n\tMAX8997_REG_LBCNFG1,\n\tMAX8997_REG_LBCNFG2,\n\tMAX8997_REG_BBCCTRL,\n\n\tMAX8997_REG_FLASH1_CUR,\n\tMAX8997_REG_FLASH2_CUR,\n\tMAX8997_REG_MOVIE_CUR,\n\tMAX8997_REG_GSMB_CUR,\n\tMAX8997_REG_BOOST_CNTL,\n\tMAX8997_REG_LEN_CNTL,\n\tMAX8997_REG_FLASH_CNTL,\n\tMAX8997_REG_WDT_CNTL,\n\tMAX8997_REG_MAXFLASH1,\n\tMAX8997_REG_MAXFLASH2,\n\tMAX8997_REG_FLASHSTATUSMASK,\n\n\tMAX8997_REG_GPIOCNTL1,\n\tMAX8997_REG_GPIOCNTL2,\n\tMAX8997_REG_GPIOCNTL3,\n\tMAX8997_REG_GPIOCNTL4,\n\tMAX8997_REG_GPIOCNTL5,\n\tMAX8997_REG_GPIOCNTL6,\n\tMAX8997_REG_GPIOCNTL7,\n\tMAX8997_REG_GPIOCNTL8,\n\tMAX8997_REG_GPIOCNTL9,\n\tMAX8997_REG_GPIOCNTL10,\n\tMAX8997_REG_GPIOCNTL11,\n\tMAX8997_REG_GPIOCNTL12,\n\n\tMAX8997_REG_LDO1CONFIG,\n\tMAX8997_REG_LDO2CONFIG,\n\tMAX8997_REG_LDO3CONFIG,\n\tMAX8997_REG_LDO4CONFIG,\n\tMAX8997_REG_LDO5CONFIG,\n\tMAX8997_REG_LDO6CONFIG,\n\tMAX8997_REG_LDO7CONFIG,\n\tMAX8997_REG_LDO8CONFIG,\n\tMAX8997_REG_LDO9CONFIG,\n\tMAX8997_REG_LDO10CONFIG,\n\tMAX8997_REG_LDO11CONFIG,\n\tMAX8997_REG_LDO12CONFIG,\n\tMAX8997_REG_LDO13CONFIG,\n\tMAX8997_REG_LDO14CONFIG,\n\tMAX8997_REG_LDO15CONFIG,\n\tMAX8997_REG_LDO16CONFIG,\n\tMAX8997_REG_LDO17CONFIG,\n\tMAX8997_REG_LDO18CONFIG,\n\tMAX8997_REG_LDO21CONFIG,\n\n\tMAX8997_REG_DVSOKTIMER1,\n\tMAX8997_REG_DVSOKTIMER2,\n\tMAX8997_REG_DVSOKTIMER4,\n\tMAX8997_REG_DVSOKTIMER5,\n};\n\nstatic u8 max8997_dumpaddr_muic[] = {\n\tMAX8997_MUIC_REG_INTMASK1,\n\tMAX8997_MUIC_REG_INTMASK2,\n\tMAX8997_MUIC_REG_INTMASK3,\n\tMAX8997_MUIC_REG_CDETCTRL,\n\tMAX8997_MUIC_REG_CONTROL1,\n\tMAX8997_MUIC_REG_CONTROL2,\n\tMAX8997_MUIC_REG_CONTROL3,\n};\n\nstatic u8 max8997_dumpaddr_haptic[] = {\n\tMAX8997_HAPTIC_REG_CONF1,\n\tMAX8997_HAPTIC_REG_CONF2,\n\tMAX8997_HAPTIC_REG_DRVCONF,\n\tMAX8997_HAPTIC_REG_CYCLECONF1,\n\tMAX8997_HAPTIC_REG_CYCLECONF2,\n\tMAX8997_HAPTIC_REG_SIGCONF1,\n\tMAX8997_HAPTIC_REG_SIGCONF2,\n\tMAX8997_HAPTIC_REG_SIGCONF3,\n\tMAX8997_HAPTIC_REG_SIGCONF4,\n\tMAX8997_HAPTIC_REG_SIGDC1,\n\tMAX8997_HAPTIC_REG_SIGDC2,\n\tMAX8997_HAPTIC_REG_SIGPWMDC1,\n\tMAX8997_HAPTIC_REG_SIGPWMDC2,\n\tMAX8997_HAPTIC_REG_SIGPWMDC3,\n\tMAX8997_HAPTIC_REG_SIGPWMDC4,\n};\n\nstatic int max8997_freeze(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_pmic); i++)\n\t\tmax8997_read_reg(i2c, max8997_dumpaddr_pmic[i],\n\t\t\t\t&max8997->reg_dump[i]);\n\n\tfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_muic); i++)\n\t\tmax8997_read_reg(i2c, max8997_dumpaddr_muic[i],\n\t\t\t\t&max8997->reg_dump[i + MAX8997_REG_PMIC_END]);\n\n\tfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_haptic); i++)\n\t\tmax8997_read_reg(i2c, max8997_dumpaddr_haptic[i],\n\t\t\t\t&max8997->reg_dump[i + MAX8997_REG_PMIC_END +\n\t\t\t\tMAX8997_MUIC_REG_END]);\n\n\treturn 0;\n}\n\nstatic int max8997_restore(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_pmic); i++)\n\t\tmax8997_write_reg(i2c, max8997_dumpaddr_pmic[i],\n\t\t\t\tmax8997->reg_dump[i]);\n\n\tfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_muic); i++)\n\t\tmax8997_write_reg(i2c, max8997_dumpaddr_muic[i],\n\t\t\t\tmax8997->reg_dump[i + MAX8997_REG_PMIC_END]);\n\n\tfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_haptic); i++)\n\t\tmax8997_write_reg(i2c, max8997_dumpaddr_haptic[i],\n\t\t\t\tmax8997->reg_dump[i + MAX8997_REG_PMIC_END +\n\t\t\t\tMAX8997_MUIC_REG_END]);\n\n\treturn 0;\n}\n\nstatic int max8997_suspend(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\n\tdisable_irq(max8997->irq);\n\tif (device_may_wakeup(dev))\n\t\tirq_set_irq_wake(max8997->irq, 1);\n\treturn 0;\n}\n\nstatic int max8997_resume(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\n\n\tif (device_may_wakeup(dev))\n\t\tirq_set_irq_wake(max8997->irq, 0);\n\tenable_irq(max8997->irq);\n\treturn max8997_irq_resume(max8997);\n}\n\nstatic const struct dev_pm_ops max8997_pm = {\n\t.suspend = max8997_suspend,\n\t.resume = max8997_resume,\n\t.freeze = max8997_freeze,\n\t.restore = max8997_restore,\n};\n\nstatic struct i2c_driver max8997_i2c_driver = {\n\t.driver = {\n\t\t   .name = \"max8997\",\n\t\t   .pm = &max8997_pm,\n\t\t   .suppress_bind_attrs = true,\n\t\t   .of_match_table = of_match_ptr(max8997_pmic_dt_match),\n\t},\n\t.probe = max8997_i2c_probe,\n\t.id_table = max8997_i2c_id,\n};\n\nstatic int __init max8997_i2c_init(void)\n{\n\treturn i2c_add_driver(&max8997_i2c_driver);\n}\n \nsubsys_initcall(max8997_i2c_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}