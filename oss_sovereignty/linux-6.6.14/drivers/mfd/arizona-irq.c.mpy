{
  "module_name": "arizona-irq.c",
  "hash_id": "bbd6c1537893f506efb25eae6771e92466e21b6babc0f7cc67ba01434ad3c146",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/arizona-irq.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gpio.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqdomain.h>\n#include <linux/module.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slab.h>\n\n#include <linux/mfd/arizona/core.h>\n#include <linux/mfd/arizona/registers.h>\n\n#include \"arizona.h\"\n\n#define ARIZONA_AOD_IRQ_INDEX 0\n#define ARIZONA_MAIN_IRQ_INDEX 1\n\nstatic int arizona_map_irq(struct arizona *arizona, int irq)\n{\n\tint ret;\n\n\tif (arizona->aod_irq_chip) {\n\t\tret = regmap_irq_get_virq(arizona->aod_irq_chip, irq);\n\t\tif (ret >= 0)\n\t\t\treturn ret;\n\t}\n\n\treturn regmap_irq_get_virq(arizona->irq_chip, irq);\n}\n\nint arizona_request_irq(struct arizona *arizona, int irq, char *name,\n\t\t\t   irq_handler_t handler, void *data)\n{\n\tirq = arizona_map_irq(arizona, irq);\n\tif (irq < 0)\n\t\treturn irq;\n\n\treturn request_threaded_irq(irq, NULL, handler, IRQF_ONESHOT,\n\t\t\t\t    name, data);\n}\nEXPORT_SYMBOL_GPL(arizona_request_irq);\n\nvoid arizona_free_irq(struct arizona *arizona, int irq, void *data)\n{\n\tirq = arizona_map_irq(arizona, irq);\n\tif (irq < 0)\n\t\treturn;\n\n\tfree_irq(irq, data);\n}\nEXPORT_SYMBOL_GPL(arizona_free_irq);\n\nint arizona_set_irq_wake(struct arizona *arizona, int irq, int on)\n{\n\tirq = arizona_map_irq(arizona, irq);\n\tif (irq < 0)\n\t\treturn irq;\n\n\treturn irq_set_irq_wake(irq, on);\n}\nEXPORT_SYMBOL_GPL(arizona_set_irq_wake);\n\nstatic irqreturn_t arizona_boot_done(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\n\tdev_dbg(arizona->dev, \"Boot done\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t arizona_ctrlif_err(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\n\t \n\tdev_err(arizona->dev, \"Control interface error\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t arizona_irq_thread(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\tbool poll;\n\tunsigned int val;\n\tint ret;\n\n\tret = pm_runtime_resume_and_get(arizona->dev);\n\tif (ret < 0) {\n\t\tdev_err(arizona->dev, \"Failed to resume device: %d\\n\", ret);\n\t\treturn IRQ_NONE;\n\t}\n\n\tdo {\n\t\tpoll = false;\n\n\t\tif (arizona->aod_irq_chip) {\n\t\t\t \n\t\t\tret = regmap_read(arizona->regmap,\n\t\t\t\t\t  ARIZONA_AOD_IRQ1, &val);\n\t\t\tif (ret)\n\t\t\t\tdev_warn(arizona->dev,\n\t\t\t\t\t\"Failed to read AOD IRQ1 %d\\n\", ret);\n\t\t\telse if (val)\n\t\t\t\thandle_nested_irq(\n\t\t\t\t\tirq_find_mapping(arizona->virq, 0));\n\t\t}\n\n\t\t \n\t\tret = regmap_read(arizona->regmap, ARIZONA_IRQ_PIN_STATUS,\n\t\t\t\t  &val);\n\t\tif (ret == 0 && val & ARIZONA_IRQ1_STS) {\n\t\t\thandle_nested_irq(irq_find_mapping(arizona->virq, 1));\n\t\t} else if (ret != 0) {\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Failed to read main IRQ status: %d\\n\", ret);\n\t\t}\n\n\t\t \n\t\tif (!arizona->pdata.irq_gpio) {\n\t\t\tbreak;\n\t\t} else if (arizona->pdata.irq_flags & IRQF_TRIGGER_RISING &&\n\t\t\t   gpio_get_value_cansleep(arizona->pdata.irq_gpio)) {\n\t\t\tpoll = true;\n\t\t} else if (arizona->pdata.irq_flags & IRQF_TRIGGER_FALLING &&\n\t\t\t   !gpio_get_value_cansleep(arizona->pdata.irq_gpio)) {\n\t\t\tpoll = true;\n\t\t}\n\t} while (poll);\n\n\tpm_runtime_mark_last_busy(arizona->dev);\n\tpm_runtime_put_autosuspend(arizona->dev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void arizona_irq_enable(struct irq_data *data)\n{\n}\n\nstatic void arizona_irq_disable(struct irq_data *data)\n{\n}\n\nstatic int arizona_irq_set_wake(struct irq_data *data, unsigned int on)\n{\n\tstruct arizona *arizona = irq_data_get_irq_chip_data(data);\n\n\treturn irq_set_irq_wake(arizona->irq, on);\n}\n\nstatic struct irq_chip arizona_irq_chip = {\n\t.name\t\t\t= \"arizona\",\n\t.irq_disable\t\t= arizona_irq_disable,\n\t.irq_enable\t\t= arizona_irq_enable,\n\t.irq_set_wake\t\t= arizona_irq_set_wake,\n};\n\nstatic struct lock_class_key arizona_irq_lock_class;\nstatic struct lock_class_key arizona_irq_request_class;\n\nstatic int arizona_irq_map(struct irq_domain *h, unsigned int virq,\n\t\t\t      irq_hw_number_t hw)\n{\n\tstruct arizona *data = h->host_data;\n\n\tirq_set_chip_data(virq, data);\n\tirq_set_lockdep_class(virq, &arizona_irq_lock_class,\n\t\t&arizona_irq_request_class);\n\tirq_set_chip_and_handler(virq, &arizona_irq_chip, handle_simple_irq);\n\tirq_set_nested_thread(virq, 1);\n\tirq_set_noprobe(virq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops arizona_domain_ops = {\n\t.map\t= arizona_irq_map,\n\t.xlate\t= irq_domain_xlate_twocell,\n};\n\nint arizona_irq_init(struct arizona *arizona)\n{\n\tint flags = IRQF_ONESHOT;\n\tint ret;\n\tconst struct regmap_irq_chip *aod, *irq;\n\tstruct irq_data *irq_data;\n\tunsigned int virq;\n\n\tarizona->ctrlif_error = true;\n\n\tswitch (arizona->type) {\n#ifdef CONFIG_MFD_WM5102\n\tcase WM5102:\n\t\taod = &wm5102_aod;\n\t\tirq = &wm5102_irq;\n\n\t\tarizona->ctrlif_error = false;\n\t\tbreak;\n#endif\n#ifdef CONFIG_MFD_WM5110\n\tcase WM5110:\n\tcase WM8280:\n\t\taod = &wm5110_aod;\n\n\t\tswitch (arizona->rev) {\n\t\tcase 0 ... 2:\n\t\t\tirq = &wm5110_irq;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tirq = &wm5110_revd_irq;\n\t\t\tbreak;\n\t\t}\n\n\t\tarizona->ctrlif_error = false;\n\t\tbreak;\n#endif\n#ifdef CONFIG_MFD_CS47L24\n\tcase WM1831:\n\tcase CS47L24:\n\t\taod = NULL;\n\t\tirq = &cs47l24_irq;\n\n\t\tarizona->ctrlif_error = false;\n\t\tbreak;\n#endif\n#ifdef CONFIG_MFD_WM8997\n\tcase WM8997:\n\t\taod = &wm8997_aod;\n\t\tirq = &wm8997_irq;\n\n\t\tarizona->ctrlif_error = false;\n\t\tbreak;\n#endif\n#ifdef CONFIG_MFD_WM8998\n\tcase WM8998:\n\tcase WM1814:\n\t\taod = &wm8998_aod;\n\t\tirq = &wm8998_irq;\n\n\t\tarizona->ctrlif_error = false;\n\t\tbreak;\n#endif\n\tdefault:\n\t\tBUG_ON(\"Unknown Arizona class device\" == NULL);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tregmap_write(arizona->regmap, ARIZONA_WAKE_CONTROL, 0);\n\n\t \n\tif (!arizona->pdata.irq_flags) {\n\t\tirq_data = irq_get_irq_data(arizona->irq);\n\t\tif (!irq_data) {\n\t\t\tdev_err(arizona->dev, \"Invalid IRQ: %d\\n\",\n\t\t\t\tarizona->irq);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tarizona->pdata.irq_flags = irqd_get_trigger_type(irq_data);\n\t\tswitch (arizona->pdata.irq_flags) {\n\t\tcase IRQF_TRIGGER_LOW:\n\t\tcase IRQF_TRIGGER_HIGH:\n\t\tcase IRQF_TRIGGER_RISING:\n\t\tcase IRQF_TRIGGER_FALLING:\n\t\t\tbreak;\n\n\t\tcase IRQ_TYPE_NONE:\n\t\tdefault:\n\t\t\t \n\t\t\tarizona->pdata.irq_flags = IRQF_TRIGGER_LOW;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (arizona->pdata.irq_flags & (IRQF_TRIGGER_HIGH |\n\t\t\t\t\tIRQF_TRIGGER_RISING)) {\n\t\tret = regmap_update_bits(arizona->regmap, ARIZONA_IRQ_CTRL_1,\n\t\t\t\t\t ARIZONA_IRQ_POL, 0);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Couldn't set IRQ polarity: %d\\n\",\n\t\t\t\tret);\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tflags |= arizona->pdata.irq_flags;\n\n\t \n\tarizona->virq = irq_domain_add_linear(NULL, 2, &arizona_domain_ops,\n\t\t\t\t\t      arizona);\n\tif (!arizona->virq) {\n\t\tdev_err(arizona->dev, \"Failed to add core IRQ domain\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\n\tif (aod) {\n\t\tvirq = irq_create_mapping(arizona->virq, ARIZONA_AOD_IRQ_INDEX);\n\t\tif (!virq) {\n\t\t\tdev_err(arizona->dev, \"Failed to map AOD IRQs\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_domain;\n\t\t}\n\n\t\tret = regmap_add_irq_chip(arizona->regmap, virq, IRQF_ONESHOT,\n\t\t\t\t\t  0, aod, &arizona->aod_irq_chip);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Failed to add AOD IRQs: %d\\n\", ret);\n\t\t\tgoto err_map_aod;\n\t\t}\n\t}\n\n\tvirq = irq_create_mapping(arizona->virq, ARIZONA_MAIN_IRQ_INDEX);\n\tif (!virq) {\n\t\tdev_err(arizona->dev, \"Failed to map main IRQs\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_aod;\n\t}\n\n\tret = regmap_add_irq_chip(arizona->regmap, virq, IRQF_ONESHOT,\n\t\t\t\t  0, irq, &arizona->irq_chip);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to add main IRQs: %d\\n\", ret);\n\t\tgoto err_map_main_irq;\n\t}\n\n\t \n\tif (arizona->pdata.irq_gpio) {\n\t\tif (gpio_to_irq(arizona->pdata.irq_gpio) != arizona->irq) {\n\t\t\tdev_warn(arizona->dev, \"IRQ %d is not GPIO %d (%d)\\n\",\n\t\t\t\t arizona->irq, arizona->pdata.irq_gpio,\n\t\t\t\t gpio_to_irq(arizona->pdata.irq_gpio));\n\t\t\tarizona->irq = gpio_to_irq(arizona->pdata.irq_gpio);\n\t\t}\n\n\t\tret = devm_gpio_request_one(arizona->dev,\n\t\t\t\t\t    arizona->pdata.irq_gpio,\n\t\t\t\t\t    GPIOF_IN, \"arizona IRQ\");\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Failed to request IRQ GPIO %d:: %d\\n\",\n\t\t\t\tarizona->pdata.irq_gpio, ret);\n\t\t\tarizona->pdata.irq_gpio = 0;\n\t\t}\n\t}\n\n\tret = request_threaded_irq(arizona->irq, NULL, arizona_irq_thread,\n\t\t\t\t   flags, \"arizona\", arizona);\n\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to request primary IRQ %d: %d\\n\",\n\t\t\tarizona->irq, ret);\n\t\tgoto err_main_irq;\n\t}\n\n\t \n\tret = arizona_request_irq(arizona, ARIZONA_IRQ_BOOT_DONE, \"Boot done\",\n\t\t\t\t  arizona_boot_done, arizona);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to request boot done %d: %d\\n\",\n\t\t\tarizona->irq, ret);\n\t\tgoto err_boot_done;\n\t}\n\n\t \n\tif (arizona->ctrlif_error) {\n\t\tret = arizona_request_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR,\n\t\t\t\t\t  \"Control interface error\",\n\t\t\t\t\t  arizona_ctrlif_err, arizona);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Failed to request CTRLIF_ERR %d: %d\\n\",\n\t\t\t\tarizona->irq, ret);\n\t\t\tgoto err_ctrlif;\n\t\t}\n\t}\n\n\treturn 0;\n\nerr_ctrlif:\n\tarizona_free_irq(arizona, ARIZONA_IRQ_BOOT_DONE, arizona);\nerr_boot_done:\n\tfree_irq(arizona->irq, arizona);\nerr_main_irq:\n\tregmap_del_irq_chip(irq_find_mapping(arizona->virq,\n\t\t\t\t\t     ARIZONA_MAIN_IRQ_INDEX),\n\t\t\t    arizona->irq_chip);\nerr_map_main_irq:\n\tirq_dispose_mapping(irq_find_mapping(arizona->virq,\n\t\t\t\t\t     ARIZONA_MAIN_IRQ_INDEX));\nerr_aod:\n\tregmap_del_irq_chip(irq_find_mapping(arizona->virq,\n\t\t\t\t\t     ARIZONA_AOD_IRQ_INDEX),\n\t\t\t    arizona->aod_irq_chip);\nerr_map_aod:\n\tirq_dispose_mapping(irq_find_mapping(arizona->virq,\n\t\t\t\t\t     ARIZONA_AOD_IRQ_INDEX));\nerr_domain:\n\tirq_domain_remove(arizona->virq);\nerr:\n\treturn ret;\n}\n\nint arizona_irq_exit(struct arizona *arizona)\n{\n\tunsigned int virq;\n\n\tif (arizona->ctrlif_error)\n\t\tarizona_free_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR, arizona);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_BOOT_DONE, arizona);\n\n\tvirq = irq_find_mapping(arizona->virq, ARIZONA_MAIN_IRQ_INDEX);\n\tregmap_del_irq_chip(virq, arizona->irq_chip);\n\tirq_dispose_mapping(virq);\n\n\tvirq = irq_find_mapping(arizona->virq, ARIZONA_AOD_IRQ_INDEX);\n\tregmap_del_irq_chip(virq, arizona->aod_irq_chip);\n\tirq_dispose_mapping(virq);\n\n\tirq_domain_remove(arizona->virq);\n\n\tfree_irq(arizona->irq, arizona);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}