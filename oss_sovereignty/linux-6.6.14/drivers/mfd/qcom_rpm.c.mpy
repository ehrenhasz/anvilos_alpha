{
  "module_name": "qcom_rpm.c",
  "hash_id": "843f2f0da41fb777d6a553638f033e09178eb14714d990f272f26bf61a94cad8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/qcom_rpm.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/of_platform.h>\n#include <linux/io.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/qcom_rpm.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n#include <linux/clk.h>\n\n#include <dt-bindings/mfd/qcom-rpm.h>\n\nstruct qcom_rpm_resource {\n\tunsigned target_id;\n\tunsigned status_id;\n\tunsigned select_id;\n\tunsigned size;\n};\n\nstruct qcom_rpm_data {\n\tu32 version;\n\tconst struct qcom_rpm_resource *resource_table;\n\tunsigned int n_resources;\n\tunsigned int req_ctx_off;\n\tunsigned int req_sel_off;\n\tunsigned int ack_ctx_off;\n\tunsigned int ack_sel_off;\n\tunsigned int req_sel_size;\n\tunsigned int ack_sel_size;\n};\n\nstruct qcom_rpm {\n\tstruct device *dev;\n\tstruct regmap *ipc_regmap;\n\tunsigned ipc_offset;\n\tunsigned ipc_bit;\n\tstruct clk *ramclk;\n\n\tstruct completion ack;\n\tstruct mutex lock;\n\n\tvoid __iomem *status_regs;\n\tvoid __iomem *ctrl_regs;\n\tvoid __iomem *req_regs;\n\n\tu32 ack_status;\n\n\tconst struct qcom_rpm_data *data;\n};\n\n#define RPM_STATUS_REG(rpm, i)\t((rpm)->status_regs + (i) * 4)\n#define RPM_CTRL_REG(rpm, i)\t((rpm)->ctrl_regs + (i) * 4)\n#define RPM_REQ_REG(rpm, i)\t((rpm)->req_regs + (i) * 4)\n\n#define RPM_REQUEST_TIMEOUT\t(5 * HZ)\n\n#define RPM_MAX_SEL_SIZE\t7\n\n#define RPM_NOTIFICATION\tBIT(30)\n#define RPM_REJECTED\t\tBIT(31)\n\nstatic const struct qcom_rpm_resource apq8064_rpm_resource_table[] = {\n\t[QCOM_RPM_CXO_CLK] =\t\t\t{ 25, 9, 5, 1 },\n\t[QCOM_RPM_PXO_CLK] =\t\t\t{ 26, 10, 6, 1 },\n\t[QCOM_RPM_APPS_FABRIC_CLK] =\t\t{ 27, 11, 8, 1 },\n\t[QCOM_RPM_SYS_FABRIC_CLK] =\t\t{ 28, 12, 9, 1 },\n\t[QCOM_RPM_MM_FABRIC_CLK] =\t\t{ 29, 13, 10, 1 },\n\t[QCOM_RPM_DAYTONA_FABRIC_CLK] =\t\t{ 30, 14, 11, 1 },\n\t[QCOM_RPM_SFPB_CLK] =\t\t\t{ 31, 15, 12, 1 },\n\t[QCOM_RPM_CFPB_CLK] =\t\t\t{ 32, 16, 13, 1 },\n\t[QCOM_RPM_MMFPB_CLK] =\t\t\t{ 33, 17, 14, 1 },\n\t[QCOM_RPM_EBI1_CLK] =\t\t\t{ 34, 18, 16, 1 },\n\t[QCOM_RPM_APPS_FABRIC_HALT] =\t\t{ 35, 19, 18, 1 },\n\t[QCOM_RPM_APPS_FABRIC_MODE] =\t\t{ 37, 20, 19, 1 },\n\t[QCOM_RPM_APPS_FABRIC_IOCTL] =\t\t{ 40, 21, 20, 1 },\n\t[QCOM_RPM_APPS_FABRIC_ARB] =\t\t{ 41, 22, 21, 12 },\n\t[QCOM_RPM_SYS_FABRIC_HALT] =\t\t{ 53, 23, 22, 1 },\n\t[QCOM_RPM_SYS_FABRIC_MODE] =\t\t{ 55, 24, 23, 1 },\n\t[QCOM_RPM_SYS_FABRIC_IOCTL] =\t\t{ 58, 25, 24, 1 },\n\t[QCOM_RPM_SYS_FABRIC_ARB] =\t\t{ 59, 26, 25, 30 },\n\t[QCOM_RPM_MM_FABRIC_HALT] =\t\t{ 89, 27, 26, 1 },\n\t[QCOM_RPM_MM_FABRIC_MODE] =\t\t{ 91, 28, 27, 1 },\n\t[QCOM_RPM_MM_FABRIC_IOCTL] =\t\t{ 94, 29, 28, 1 },\n\t[QCOM_RPM_MM_FABRIC_ARB] =\t\t{ 95, 30, 29, 21 },\n\t[QCOM_RPM_PM8921_SMPS1] =\t\t{ 116, 31, 30, 2 },\n\t[QCOM_RPM_PM8921_SMPS2] =\t\t{ 118, 33, 31, 2 },\n\t[QCOM_RPM_PM8921_SMPS3] =\t\t{ 120, 35, 32, 2 },\n\t[QCOM_RPM_PM8921_SMPS4] =\t\t{ 122, 37, 33, 2 },\n\t[QCOM_RPM_PM8921_SMPS5] =\t\t{ 124, 39, 34, 2 },\n\t[QCOM_RPM_PM8921_SMPS6] =\t\t{ 126, 41, 35, 2 },\n\t[QCOM_RPM_PM8921_SMPS7] =\t\t{ 128, 43, 36, 2 },\n\t[QCOM_RPM_PM8921_SMPS8] =\t\t{ 130, 45, 37, 2 },\n\t[QCOM_RPM_PM8921_LDO1] =\t\t{ 132, 47, 38, 2 },\n\t[QCOM_RPM_PM8921_LDO2] =\t\t{ 134, 49, 39, 2 },\n\t[QCOM_RPM_PM8921_LDO3] =\t\t{ 136, 51, 40, 2 },\n\t[QCOM_RPM_PM8921_LDO4] =\t\t{ 138, 53, 41, 2 },\n\t[QCOM_RPM_PM8921_LDO5] =\t\t{ 140, 55, 42, 2 },\n\t[QCOM_RPM_PM8921_LDO6] =\t\t{ 142, 57, 43, 2 },\n\t[QCOM_RPM_PM8921_LDO7] =\t\t{ 144, 59, 44, 2 },\n\t[QCOM_RPM_PM8921_LDO8] =\t\t{ 146, 61, 45, 2 },\n\t[QCOM_RPM_PM8921_LDO9] =\t\t{ 148, 63, 46, 2 },\n\t[QCOM_RPM_PM8921_LDO10] =\t\t{ 150, 65, 47, 2 },\n\t[QCOM_RPM_PM8921_LDO11] =\t\t{ 152, 67, 48, 2 },\n\t[QCOM_RPM_PM8921_LDO12] =\t\t{ 154, 69, 49, 2 },\n\t[QCOM_RPM_PM8921_LDO13] =\t\t{ 156, 71, 50, 2 },\n\t[QCOM_RPM_PM8921_LDO14] =\t\t{ 158, 73, 51, 2 },\n\t[QCOM_RPM_PM8921_LDO15] =\t\t{ 160, 75, 52, 2 },\n\t[QCOM_RPM_PM8921_LDO16] =\t\t{ 162, 77, 53, 2 },\n\t[QCOM_RPM_PM8921_LDO17] =\t\t{ 164, 79, 54, 2 },\n\t[QCOM_RPM_PM8921_LDO18] =\t\t{ 166, 81, 55, 2 },\n\t[QCOM_RPM_PM8921_LDO19] =\t\t{ 168, 83, 56, 2 },\n\t[QCOM_RPM_PM8921_LDO20] =\t\t{ 170, 85, 57, 2 },\n\t[QCOM_RPM_PM8921_LDO21] =\t\t{ 172, 87, 58, 2 },\n\t[QCOM_RPM_PM8921_LDO22] =\t\t{ 174, 89, 59, 2 },\n\t[QCOM_RPM_PM8921_LDO23] =\t\t{ 176, 91, 60, 2 },\n\t[QCOM_RPM_PM8921_LDO24] =\t\t{ 178, 93, 61, 2 },\n\t[QCOM_RPM_PM8921_LDO25] =\t\t{ 180, 95, 62, 2 },\n\t[QCOM_RPM_PM8921_LDO26] =\t\t{ 182, 97, 63, 2 },\n\t[QCOM_RPM_PM8921_LDO27] =\t\t{ 184, 99, 64, 2 },\n\t[QCOM_RPM_PM8921_LDO28] =\t\t{ 186, 101, 65, 2 },\n\t[QCOM_RPM_PM8921_LDO29] =\t\t{ 188, 103, 66, 2 },\n\t[QCOM_RPM_PM8921_CLK1] =\t\t{ 190, 105, 67, 2 },\n\t[QCOM_RPM_PM8921_CLK2] =\t\t{ 192, 107, 68, 2 },\n\t[QCOM_RPM_PM8921_LVS1] =\t\t{ 194, 109, 69, 1 },\n\t[QCOM_RPM_PM8921_LVS2] =\t\t{ 195, 110, 70, 1 },\n\t[QCOM_RPM_PM8921_LVS3] =\t\t{ 196, 111, 71, 1 },\n\t[QCOM_RPM_PM8921_LVS4] =\t\t{ 197, 112, 72, 1 },\n\t[QCOM_RPM_PM8921_LVS5] =\t\t{ 198, 113, 73, 1 },\n\t[QCOM_RPM_PM8921_LVS6] =\t\t{ 199, 114, 74, 1 },\n\t[QCOM_RPM_PM8921_LVS7] =\t\t{ 200, 115, 75, 1 },\n\t[QCOM_RPM_PM8821_SMPS1] =\t\t{ 201, 116, 76, 2 },\n\t[QCOM_RPM_PM8821_SMPS2] =\t\t{ 203, 118, 77, 2 },\n\t[QCOM_RPM_PM8821_LDO1] =\t\t{ 205, 120, 78, 2 },\n\t[QCOM_RPM_PM8921_NCP] =\t\t\t{ 207, 122, 80, 2 },\n\t[QCOM_RPM_CXO_BUFFERS] =\t\t{ 209, 124, 81, 1 },\n\t[QCOM_RPM_USB_OTG_SWITCH] =\t\t{ 210, 125, 82, 1 },\n\t[QCOM_RPM_HDMI_SWITCH] =\t\t{ 211, 126, 83, 1 },\n\t[QCOM_RPM_DDR_DMM] =\t\t\t{ 212, 127, 84, 2 },\n\t[QCOM_RPM_QDSS_CLK] =\t\t\t{ 214, ~0, 7, 1 },\n\t[QCOM_RPM_VDDMIN_GPIO] =\t\t{ 215, 131, 89, 1 },\n};\n\nstatic const struct qcom_rpm_data apq8064_template = {\n\t.version = 3,\n\t.resource_table = apq8064_rpm_resource_table,\n\t.n_resources = ARRAY_SIZE(apq8064_rpm_resource_table),\n\t.req_ctx_off = 3,\n\t.req_sel_off = 11,\n\t.ack_ctx_off = 15,\n\t.ack_sel_off = 23,\n\t.req_sel_size = 4,\n\t.ack_sel_size = 7,\n};\n\nstatic const struct qcom_rpm_resource msm8660_rpm_resource_table[] = {\n\t[QCOM_RPM_CXO_CLK] =\t\t\t{ 32, 12, 5, 1 },\n\t[QCOM_RPM_PXO_CLK] =\t\t\t{ 33, 13, 6, 1 },\n\t[QCOM_RPM_PLL_4] =\t\t\t{ 34, 14, 7, 1 },\n\t[QCOM_RPM_APPS_FABRIC_CLK] =\t\t{ 35, 15, 8, 1 },\n\t[QCOM_RPM_SYS_FABRIC_CLK] =\t\t{ 36, 16, 9, 1 },\n\t[QCOM_RPM_MM_FABRIC_CLK] =\t\t{ 37, 17, 10, 1 },\n\t[QCOM_RPM_DAYTONA_FABRIC_CLK] =\t\t{ 38, 18, 11, 1 },\n\t[QCOM_RPM_SFPB_CLK] =\t\t\t{ 39, 19, 12, 1 },\n\t[QCOM_RPM_CFPB_CLK] =\t\t\t{ 40, 20, 13, 1 },\n\t[QCOM_RPM_MMFPB_CLK] =\t\t\t{ 41, 21, 14, 1 },\n\t[QCOM_RPM_SMI_CLK] =\t\t\t{ 42, 22, 15, 1 },\n\t[QCOM_RPM_EBI1_CLK] =\t\t\t{ 43, 23, 16, 1 },\n\t[QCOM_RPM_APPS_L2_CACHE_CTL] =\t\t{ 44, 24, 17, 1 },\n\t[QCOM_RPM_APPS_FABRIC_HALT] =\t\t{ 45, 25, 18, 2 },\n\t[QCOM_RPM_APPS_FABRIC_MODE] =\t\t{ 47, 26, 19, 3 },\n\t[QCOM_RPM_APPS_FABRIC_ARB] =\t\t{ 51, 28, 21, 6 },\n\t[QCOM_RPM_SYS_FABRIC_HALT] =\t\t{ 63, 29, 22, 2 },\n\t[QCOM_RPM_SYS_FABRIC_MODE] =\t\t{ 65, 30, 23, 3 },\n\t[QCOM_RPM_SYS_FABRIC_ARB] =\t\t{ 69, 32, 25, 22 },\n\t[QCOM_RPM_MM_FABRIC_HALT] =\t\t{ 105, 33, 26, 2 },\n\t[QCOM_RPM_MM_FABRIC_MODE] =\t\t{ 107, 34, 27, 3 },\n\t[QCOM_RPM_MM_FABRIC_ARB] =\t\t{ 111, 36, 29, 23 },\n\t[QCOM_RPM_PM8901_SMPS0] =\t\t{ 134, 37, 30, 2 },\n\t[QCOM_RPM_PM8901_SMPS1] =\t\t{ 136, 39, 31, 2 },\n\t[QCOM_RPM_PM8901_SMPS2] =\t\t{ 138, 41, 32, 2 },\n\t[QCOM_RPM_PM8901_SMPS3] =\t\t{ 140, 43, 33, 2 },\n\t[QCOM_RPM_PM8901_SMPS4] =\t\t{ 142, 45, 34, 2 },\n\t[QCOM_RPM_PM8901_LDO0] =\t\t{ 144, 47, 35, 2 },\n\t[QCOM_RPM_PM8901_LDO1] =\t\t{ 146, 49, 36, 2 },\n\t[QCOM_RPM_PM8901_LDO2] =\t\t{ 148, 51, 37, 2 },\n\t[QCOM_RPM_PM8901_LDO3] =\t\t{ 150, 53, 38, 2 },\n\t[QCOM_RPM_PM8901_LDO4] =\t\t{ 152, 55, 39, 2 },\n\t[QCOM_RPM_PM8901_LDO5] =\t\t{ 154, 57, 40, 2 },\n\t[QCOM_RPM_PM8901_LDO6] =\t\t{ 156, 59, 41, 2 },\n\t[QCOM_RPM_PM8901_LVS0] =\t\t{ 158, 61, 42, 1 },\n\t[QCOM_RPM_PM8901_LVS1] =\t\t{ 159, 62, 43, 1 },\n\t[QCOM_RPM_PM8901_LVS2] =\t\t{ 160, 63, 44, 1 },\n\t[QCOM_RPM_PM8901_LVS3] =\t\t{ 161, 64, 45, 1 },\n\t[QCOM_RPM_PM8901_MVS] =\t\t\t{ 162, 65, 46, 1 },\n\t[QCOM_RPM_PM8058_SMPS0] =\t\t{ 163, 66, 47, 2 },\n\t[QCOM_RPM_PM8058_SMPS1] =\t\t{ 165, 68, 48, 2 },\n\t[QCOM_RPM_PM8058_SMPS2] =\t\t{ 167, 70, 49, 2 },\n\t[QCOM_RPM_PM8058_SMPS3] =\t\t{ 169, 72, 50, 2 },\n\t[QCOM_RPM_PM8058_SMPS4] =\t\t{ 171, 74, 51, 2 },\n\t[QCOM_RPM_PM8058_LDO0] =\t\t{ 173, 76, 52, 2 },\n\t[QCOM_RPM_PM8058_LDO1] =\t\t{ 175, 78, 53, 2 },\n\t[QCOM_RPM_PM8058_LDO2] =\t\t{ 177, 80, 54, 2 },\n\t[QCOM_RPM_PM8058_LDO3] =\t\t{ 179, 82, 55, 2 },\n\t[QCOM_RPM_PM8058_LDO4] =\t\t{ 181, 84, 56, 2 },\n\t[QCOM_RPM_PM8058_LDO5] =\t\t{ 183, 86, 57, 2 },\n\t[QCOM_RPM_PM8058_LDO6] =\t\t{ 185, 88, 58, 2 },\n\t[QCOM_RPM_PM8058_LDO7] =\t\t{ 187, 90, 59, 2 },\n\t[QCOM_RPM_PM8058_LDO8] =\t\t{ 189, 92, 60, 2 },\n\t[QCOM_RPM_PM8058_LDO9] =\t\t{ 191, 94, 61, 2 },\n\t[QCOM_RPM_PM8058_LDO10] =\t\t{ 193, 96, 62, 2 },\n\t[QCOM_RPM_PM8058_LDO11] =\t\t{ 195, 98, 63, 2 },\n\t[QCOM_RPM_PM8058_LDO12] =\t\t{ 197, 100, 64, 2 },\n\t[QCOM_RPM_PM8058_LDO13] =\t\t{ 199, 102, 65, 2 },\n\t[QCOM_RPM_PM8058_LDO14] =\t\t{ 201, 104, 66, 2 },\n\t[QCOM_RPM_PM8058_LDO15] =\t\t{ 203, 106, 67, 2 },\n\t[QCOM_RPM_PM8058_LDO16] =\t\t{ 205, 108, 68, 2 },\n\t[QCOM_RPM_PM8058_LDO17] =\t\t{ 207, 110, 69, 2 },\n\t[QCOM_RPM_PM8058_LDO18] =\t\t{ 209, 112, 70, 2 },\n\t[QCOM_RPM_PM8058_LDO19] =\t\t{ 211, 114, 71, 2 },\n\t[QCOM_RPM_PM8058_LDO20] =\t\t{ 213, 116, 72, 2 },\n\t[QCOM_RPM_PM8058_LDO21] =\t\t{ 215, 118, 73, 2 },\n\t[QCOM_RPM_PM8058_LDO22] =\t\t{ 217, 120, 74, 2 },\n\t[QCOM_RPM_PM8058_LDO23] =\t\t{ 219, 122, 75, 2 },\n\t[QCOM_RPM_PM8058_LDO24] =\t\t{ 221, 124, 76, 2 },\n\t[QCOM_RPM_PM8058_LDO25] =\t\t{ 223, 126, 77, 2 },\n\t[QCOM_RPM_PM8058_LVS0] =\t\t{ 225, 128, 78, 1 },\n\t[QCOM_RPM_PM8058_LVS1] =\t\t{ 226, 129, 79, 1 },\n\t[QCOM_RPM_PM8058_NCP] =\t\t\t{ 227, 130, 80, 2 },\n\t[QCOM_RPM_CXO_BUFFERS] =\t\t{ 229, 132, 81, 1 },\n};\n\nstatic const struct qcom_rpm_data msm8660_template = {\n\t.version = 2,\n\t.resource_table = msm8660_rpm_resource_table,\n\t.n_resources = ARRAY_SIZE(msm8660_rpm_resource_table),\n\t.req_ctx_off = 3,\n\t.req_sel_off = 11,\n\t.ack_ctx_off = 19,\n\t.ack_sel_off = 27,\n\t.req_sel_size = 7,\n\t.ack_sel_size = 7,\n};\n\nstatic const struct qcom_rpm_resource msm8960_rpm_resource_table[] = {\n\t[QCOM_RPM_CXO_CLK] =\t\t\t{ 25, 9, 5, 1 },\n\t[QCOM_RPM_PXO_CLK] =\t\t\t{ 26, 10, 6, 1 },\n\t[QCOM_RPM_APPS_FABRIC_CLK] =\t\t{ 27, 11, 8, 1 },\n\t[QCOM_RPM_SYS_FABRIC_CLK] =\t\t{ 28, 12, 9, 1 },\n\t[QCOM_RPM_MM_FABRIC_CLK] =\t\t{ 29, 13, 10, 1 },\n\t[QCOM_RPM_DAYTONA_FABRIC_CLK] =\t\t{ 30, 14, 11, 1 },\n\t[QCOM_RPM_SFPB_CLK] =\t\t\t{ 31, 15, 12, 1 },\n\t[QCOM_RPM_CFPB_CLK] =\t\t\t{ 32, 16, 13, 1 },\n\t[QCOM_RPM_MMFPB_CLK] =\t\t\t{ 33, 17, 14, 1 },\n\t[QCOM_RPM_EBI1_CLK] =\t\t\t{ 34, 18, 16, 1 },\n\t[QCOM_RPM_APPS_FABRIC_HALT] =\t\t{ 35, 19, 18, 1 },\n\t[QCOM_RPM_APPS_FABRIC_MODE] =\t\t{ 37, 20, 19, 1 },\n\t[QCOM_RPM_APPS_FABRIC_IOCTL] =\t\t{ 40, 21, 20, 1 },\n\t[QCOM_RPM_APPS_FABRIC_ARB] =\t\t{ 41, 22, 21, 12 },\n\t[QCOM_RPM_SYS_FABRIC_HALT] =\t\t{ 53, 23, 22, 1 },\n\t[QCOM_RPM_SYS_FABRIC_MODE] =\t\t{ 55, 24, 23, 1 },\n\t[QCOM_RPM_SYS_FABRIC_IOCTL] =\t\t{ 58, 25, 24, 1 },\n\t[QCOM_RPM_SYS_FABRIC_ARB] =\t\t{ 59, 26, 25, 29 },\n\t[QCOM_RPM_MM_FABRIC_HALT] =\t\t{ 88, 27, 26, 1 },\n\t[QCOM_RPM_MM_FABRIC_MODE] =\t\t{ 90, 28, 27, 1 },\n\t[QCOM_RPM_MM_FABRIC_IOCTL] =\t\t{ 93, 29, 28, 1 },\n\t[QCOM_RPM_MM_FABRIC_ARB] =\t\t{ 94, 30, 29, 23 },\n\t[QCOM_RPM_PM8921_SMPS1] =\t\t{ 117, 31, 30, 2 },\n\t[QCOM_RPM_PM8921_SMPS2] =\t\t{ 119, 33, 31, 2 },\n\t[QCOM_RPM_PM8921_SMPS3] =\t\t{ 121, 35, 32, 2 },\n\t[QCOM_RPM_PM8921_SMPS4] =\t\t{ 123, 37, 33, 2 },\n\t[QCOM_RPM_PM8921_SMPS5] =\t\t{ 125, 39, 34, 2 },\n\t[QCOM_RPM_PM8921_SMPS6] =\t\t{ 127, 41, 35, 2 },\n\t[QCOM_RPM_PM8921_SMPS7] =\t\t{ 129, 43, 36, 2 },\n\t[QCOM_RPM_PM8921_SMPS8] =\t\t{ 131, 45, 37, 2 },\n\t[QCOM_RPM_PM8921_LDO1] =\t\t{ 133, 47, 38, 2 },\n\t[QCOM_RPM_PM8921_LDO2] =\t\t{ 135, 49, 39, 2 },\n\t[QCOM_RPM_PM8921_LDO3] =\t\t{ 137, 51, 40, 2 },\n\t[QCOM_RPM_PM8921_LDO4] =\t\t{ 139, 53, 41, 2 },\n\t[QCOM_RPM_PM8921_LDO5] =\t\t{ 141, 55, 42, 2 },\n\t[QCOM_RPM_PM8921_LDO6] =\t\t{ 143, 57, 43, 2 },\n\t[QCOM_RPM_PM8921_LDO7] =\t\t{ 145, 59, 44, 2 },\n\t[QCOM_RPM_PM8921_LDO8] =\t\t{ 147, 61, 45, 2 },\n\t[QCOM_RPM_PM8921_LDO9] =\t\t{ 149, 63, 46, 2 },\n\t[QCOM_RPM_PM8921_LDO10] =\t\t{ 151, 65, 47, 2 },\n\t[QCOM_RPM_PM8921_LDO11] =\t\t{ 153, 67, 48, 2 },\n\t[QCOM_RPM_PM8921_LDO12] =\t\t{ 155, 69, 49, 2 },\n\t[QCOM_RPM_PM8921_LDO13] =\t\t{ 157, 71, 50, 2 },\n\t[QCOM_RPM_PM8921_LDO14] =\t\t{ 159, 73, 51, 2 },\n\t[QCOM_RPM_PM8921_LDO15] =\t\t{ 161, 75, 52, 2 },\n\t[QCOM_RPM_PM8921_LDO16] =\t\t{ 163, 77, 53, 2 },\n\t[QCOM_RPM_PM8921_LDO17] =\t\t{ 165, 79, 54, 2 },\n\t[QCOM_RPM_PM8921_LDO18] =\t\t{ 167, 81, 55, 2 },\n\t[QCOM_RPM_PM8921_LDO19] =\t\t{ 169, 83, 56, 2 },\n\t[QCOM_RPM_PM8921_LDO20] =\t\t{ 171, 85, 57, 2 },\n\t[QCOM_RPM_PM8921_LDO21] =\t\t{ 173, 87, 58, 2 },\n\t[QCOM_RPM_PM8921_LDO22] =\t\t{ 175, 89, 59, 2 },\n\t[QCOM_RPM_PM8921_LDO23] =\t\t{ 177, 91, 60, 2 },\n\t[QCOM_RPM_PM8921_LDO24] =\t\t{ 179, 93, 61, 2 },\n\t[QCOM_RPM_PM8921_LDO25] =\t\t{ 181, 95, 62, 2 },\n\t[QCOM_RPM_PM8921_LDO26] =\t\t{ 183, 97, 63, 2 },\n\t[QCOM_RPM_PM8921_LDO27] =\t\t{ 185, 99, 64, 2 },\n\t[QCOM_RPM_PM8921_LDO28] =\t\t{ 187, 101, 65, 2 },\n\t[QCOM_RPM_PM8921_LDO29] =\t\t{ 189, 103, 66, 2 },\n\t[QCOM_RPM_PM8921_CLK1] =\t\t{ 191, 105, 67, 2 },\n\t[QCOM_RPM_PM8921_CLK2] =\t\t{ 193, 107, 68, 2 },\n\t[QCOM_RPM_PM8921_LVS1] =\t\t{ 195, 109, 69, 1 },\n\t[QCOM_RPM_PM8921_LVS2] =\t\t{ 196, 110, 70, 1 },\n\t[QCOM_RPM_PM8921_LVS3] =\t\t{ 197, 111, 71, 1 },\n\t[QCOM_RPM_PM8921_LVS4] =\t\t{ 198, 112, 72, 1 },\n\t[QCOM_RPM_PM8921_LVS5] =\t\t{ 199, 113, 73, 1 },\n\t[QCOM_RPM_PM8921_LVS6] =\t\t{ 200, 114, 74, 1 },\n\t[QCOM_RPM_PM8921_LVS7] =\t\t{ 201, 115, 75, 1 },\n\t[QCOM_RPM_PM8921_NCP] =\t\t\t{ 202, 116, 80, 2 },\n\t[QCOM_RPM_CXO_BUFFERS] =\t\t{ 204, 118, 81, 1 },\n\t[QCOM_RPM_USB_OTG_SWITCH] =\t\t{ 205, 119, 82, 1 },\n\t[QCOM_RPM_HDMI_SWITCH] =\t\t{ 206, 120, 83, 1 },\n\t[QCOM_RPM_DDR_DMM] =\t\t\t{ 207, 121, 84, 2 },\n};\n\nstatic const struct qcom_rpm_data msm8960_template = {\n\t.version = 3,\n\t.resource_table = msm8960_rpm_resource_table,\n\t.n_resources = ARRAY_SIZE(msm8960_rpm_resource_table),\n\t.req_ctx_off = 3,\n\t.req_sel_off = 11,\n\t.ack_ctx_off = 15,\n\t.ack_sel_off = 23,\n\t.req_sel_size = 4,\n\t.ack_sel_size = 7,\n};\n\nstatic const struct qcom_rpm_resource ipq806x_rpm_resource_table[] = {\n\t[QCOM_RPM_CXO_CLK] =\t\t\t{ 25, 9, 5, 1 },\n\t[QCOM_RPM_PXO_CLK] =\t\t\t{ 26, 10, 6, 1 },\n\t[QCOM_RPM_APPS_FABRIC_CLK] =\t\t{ 27, 11, 8, 1 },\n\t[QCOM_RPM_SYS_FABRIC_CLK] =\t\t{ 28, 12, 9, 1 },\n\t[QCOM_RPM_NSS_FABRIC_0_CLK] =\t\t{ 29, 13, 10, 1 },\n\t[QCOM_RPM_DAYTONA_FABRIC_CLK] =\t\t{ 30, 14, 11, 1 },\n\t[QCOM_RPM_SFPB_CLK] =\t\t\t{ 31, 15, 12, 1 },\n\t[QCOM_RPM_CFPB_CLK] =\t\t\t{ 32, 16, 13, 1 },\n\t[QCOM_RPM_NSS_FABRIC_1_CLK] =\t\t{ 33, 17, 14, 1 },\n\t[QCOM_RPM_EBI1_CLK] =\t\t\t{ 34, 18, 16, 1 },\n\t[QCOM_RPM_APPS_FABRIC_HALT] =\t\t{ 35, 19, 18, 2 },\n\t[QCOM_RPM_APPS_FABRIC_MODE] =\t\t{ 37, 20, 19, 3 },\n\t[QCOM_RPM_APPS_FABRIC_IOCTL] =\t\t{ 40, 21, 20, 1 },\n\t[QCOM_RPM_APPS_FABRIC_ARB] =\t\t{ 41, 22, 21, 12 },\n\t[QCOM_RPM_SYS_FABRIC_HALT] =\t\t{ 53, 23, 22, 2 },\n\t[QCOM_RPM_SYS_FABRIC_MODE] =\t\t{ 55, 24, 23, 3 },\n\t[QCOM_RPM_SYS_FABRIC_IOCTL] =\t\t{ 58, 25, 24, 1 },\n\t[QCOM_RPM_SYS_FABRIC_ARB] =\t\t{ 59, 26, 25, 30 },\n\t[QCOM_RPM_MM_FABRIC_HALT] =\t\t{ 89, 27, 26, 2 },\n\t[QCOM_RPM_MM_FABRIC_MODE] =\t\t{ 91, 28, 27, 3 },\n\t[QCOM_RPM_MM_FABRIC_IOCTL] =\t\t{ 94, 29, 28, 1 },\n\t[QCOM_RPM_MM_FABRIC_ARB] =\t\t{ 95, 30, 29, 2 },\n\t[QCOM_RPM_CXO_BUFFERS] =\t\t{ 209, 33, 31, 1 },\n\t[QCOM_RPM_USB_OTG_SWITCH] =\t\t{ 210, 34, 32, 1 },\n\t[QCOM_RPM_HDMI_SWITCH] =\t\t{ 211, 35, 33, 1 },\n\t[QCOM_RPM_DDR_DMM] =\t\t\t{ 212, 36, 34, 2 },\n\t[QCOM_RPM_VDDMIN_GPIO] =\t\t{ 215, 40, 39, 1 },\n\t[QCOM_RPM_SMB208_S1a] =\t\t\t{ 216, 41, 90, 2 },\n\t[QCOM_RPM_SMB208_S1b] =\t\t\t{ 218, 43, 91, 2 },\n\t[QCOM_RPM_SMB208_S2a] =\t\t\t{ 220, 45, 92, 2 },\n\t[QCOM_RPM_SMB208_S2b] =\t\t\t{ 222, 47, 93, 2 },\n};\n\nstatic const struct qcom_rpm_data ipq806x_template = {\n\t.version = 3,\n\t.resource_table = ipq806x_rpm_resource_table,\n\t.n_resources = ARRAY_SIZE(ipq806x_rpm_resource_table),\n\t.req_ctx_off = 3,\n\t.req_sel_off = 11,\n\t.ack_ctx_off = 15,\n\t.ack_sel_off = 23,\n\t.req_sel_size = 4,\n\t.ack_sel_size = 7,\n};\n\nstatic const struct qcom_rpm_resource mdm9615_rpm_resource_table[] = {\n\t[QCOM_RPM_CXO_CLK] =\t\t\t{ 25, 9, 5, 1 },\n\t[QCOM_RPM_SYS_FABRIC_CLK] =\t\t{ 26, 10, 9, 1 },\n\t[QCOM_RPM_DAYTONA_FABRIC_CLK] =\t\t{ 27, 11, 11, 1 },\n\t[QCOM_RPM_SFPB_CLK] =\t\t\t{ 28, 12, 12, 1 },\n\t[QCOM_RPM_CFPB_CLK] =\t\t\t{ 29, 13, 13, 1 },\n\t[QCOM_RPM_EBI1_CLK] =\t\t\t{ 30, 14, 16, 1 },\n\t[QCOM_RPM_APPS_FABRIC_HALT] =\t\t{ 31, 15, 22, 2 },\n\t[QCOM_RPM_APPS_FABRIC_MODE] =\t\t{ 33, 16, 23, 3 },\n\t[QCOM_RPM_APPS_FABRIC_IOCTL] =\t\t{ 36, 17, 24, 1 },\n\t[QCOM_RPM_APPS_FABRIC_ARB] =\t\t{ 37, 18, 25, 27 },\n\t[QCOM_RPM_PM8018_SMPS1] =\t\t{ 64, 19, 30, 2 },\n\t[QCOM_RPM_PM8018_SMPS2] =\t\t{ 66, 21, 31, 2 },\n\t[QCOM_RPM_PM8018_SMPS3] =\t\t{ 68, 23, 32, 2 },\n\t[QCOM_RPM_PM8018_SMPS4] =\t\t{ 70, 25, 33, 2 },\n\t[QCOM_RPM_PM8018_SMPS5] =\t\t{ 72, 27, 34, 2 },\n\t[QCOM_RPM_PM8018_LDO1] =\t\t{ 74, 29, 35, 2 },\n\t[QCOM_RPM_PM8018_LDO2] =\t\t{ 76, 31, 36, 2 },\n\t[QCOM_RPM_PM8018_LDO3] =\t\t{ 78, 33, 37, 2 },\n\t[QCOM_RPM_PM8018_LDO4] =\t\t{ 80, 35, 38, 2 },\n\t[QCOM_RPM_PM8018_LDO5] =\t\t{ 82, 37, 39, 2 },\n\t[QCOM_RPM_PM8018_LDO6] =\t\t{ 84, 39, 40, 2 },\n\t[QCOM_RPM_PM8018_LDO7] =\t\t{ 86, 41, 41, 2 },\n\t[QCOM_RPM_PM8018_LDO8] =\t\t{ 88, 43, 42, 2 },\n\t[QCOM_RPM_PM8018_LDO9] =\t\t{ 90, 45, 43, 2 },\n\t[QCOM_RPM_PM8018_LDO10] =\t\t{ 92, 47, 44, 2 },\n\t[QCOM_RPM_PM8018_LDO11] =\t\t{ 94, 49, 45, 2 },\n\t[QCOM_RPM_PM8018_LDO12] =\t\t{ 96, 51, 46, 2 },\n\t[QCOM_RPM_PM8018_LDO13] =\t\t{ 98, 53, 47, 2 },\n\t[QCOM_RPM_PM8018_LDO14] =\t\t{ 100, 55, 48, 2 },\n\t[QCOM_RPM_PM8018_LVS1] =\t\t{ 102, 57, 49, 1 },\n\t[QCOM_RPM_PM8018_NCP] =\t\t\t{ 103, 58, 80, 2 },\n\t[QCOM_RPM_CXO_BUFFERS] =\t\t{ 105, 60, 81, 1 },\n\t[QCOM_RPM_USB_OTG_SWITCH] =\t\t{ 106, 61, 82, 1 },\n\t[QCOM_RPM_HDMI_SWITCH] =\t\t{ 107, 62, 83, 1 },\n\t[QCOM_RPM_VOLTAGE_CORNER] =\t\t{ 109, 64, 87, 1 },\n};\n\nstatic const struct qcom_rpm_data mdm9615_template = {\n\t.version = 3,\n\t.resource_table = mdm9615_rpm_resource_table,\n\t.n_resources = ARRAY_SIZE(mdm9615_rpm_resource_table),\n\t.req_ctx_off = 3,\n\t.req_sel_off = 11,\n\t.ack_ctx_off = 15,\n\t.ack_sel_off = 23,\n\t.req_sel_size = 4,\n\t.ack_sel_size = 7,\n};\n\nstatic const struct of_device_id qcom_rpm_of_match[] = {\n\t{ .compatible = \"qcom,rpm-apq8064\", .data = &apq8064_template },\n\t{ .compatible = \"qcom,rpm-msm8660\", .data = &msm8660_template },\n\t{ .compatible = \"qcom,rpm-msm8960\", .data = &msm8960_template },\n\t{ .compatible = \"qcom,rpm-ipq8064\", .data = &ipq806x_template },\n\t{ .compatible = \"qcom,rpm-mdm9615\", .data = &mdm9615_template },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, qcom_rpm_of_match);\n\nint qcom_rpm_write(struct qcom_rpm *rpm,\n\t\t   int state,\n\t\t   int resource,\n\t\t   u32 *buf, size_t count)\n{\n\tconst struct qcom_rpm_resource *res;\n\tconst struct qcom_rpm_data *data = rpm->data;\n\tu32 sel_mask[RPM_MAX_SEL_SIZE] = { 0 };\n\tint left;\n\tint ret = 0;\n\tint i;\n\n\tif (WARN_ON(resource < 0 || resource >= data->n_resources))\n\t\treturn -EINVAL;\n\n\tres = &data->resource_table[resource];\n\tif (WARN_ON(res->size != count))\n\t\treturn -EINVAL;\n\n\tmutex_lock(&rpm->lock);\n\n\tfor (i = 0; i < res->size; i++)\n\t\twritel_relaxed(buf[i], RPM_REQ_REG(rpm, res->target_id + i));\n\n\tbitmap_set((unsigned long *)sel_mask, res->select_id, 1);\n\tfor (i = 0; i < rpm->data->req_sel_size; i++) {\n\t\twritel_relaxed(sel_mask[i],\n\t\t\t       RPM_CTRL_REG(rpm, rpm->data->req_sel_off + i));\n\t}\n\n\twritel_relaxed(BIT(state), RPM_CTRL_REG(rpm, rpm->data->req_ctx_off));\n\n\treinit_completion(&rpm->ack);\n\tregmap_write(rpm->ipc_regmap, rpm->ipc_offset, BIT(rpm->ipc_bit));\n\n\tleft = wait_for_completion_timeout(&rpm->ack, RPM_REQUEST_TIMEOUT);\n\tif (!left)\n\t\tret = -ETIMEDOUT;\n\telse if (rpm->ack_status & RPM_REJECTED)\n\t\tret = -EIO;\n\n\tmutex_unlock(&rpm->lock);\n\n\treturn ret;\n}\nEXPORT_SYMBOL(qcom_rpm_write);\n\nstatic irqreturn_t qcom_rpm_ack_interrupt(int irq, void *dev)\n{\n\tstruct qcom_rpm *rpm = dev;\n\tu32 ack;\n\tint i;\n\n\tack = readl_relaxed(RPM_CTRL_REG(rpm, rpm->data->ack_ctx_off));\n\tfor (i = 0; i < rpm->data->ack_sel_size; i++)\n\t\twritel_relaxed(0,\n\t\t\tRPM_CTRL_REG(rpm, rpm->data->ack_sel_off + i));\n\twritel(0, RPM_CTRL_REG(rpm, rpm->data->ack_ctx_off));\n\n\tif (ack & RPM_NOTIFICATION) {\n\t\tdev_warn(rpm->dev, \"ignoring notification!\\n\");\n\t} else {\n\t\trpm->ack_status = ack;\n\t\tcomplete(&rpm->ack);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t qcom_rpm_err_interrupt(int irq, void *dev)\n{\n\tstruct qcom_rpm *rpm = dev;\n\n\tregmap_write(rpm->ipc_regmap, rpm->ipc_offset, BIT(rpm->ipc_bit));\n\tdev_err(rpm->dev, \"RPM triggered fatal error\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t qcom_rpm_wakeup_interrupt(int irq, void *dev)\n{\n\treturn IRQ_HANDLED;\n}\n\nstatic int qcom_rpm_probe(struct platform_device *pdev)\n{\n\tconst struct of_device_id *match;\n\tstruct device_node *syscon_np;\n\tstruct qcom_rpm *rpm;\n\tu32 fw_version[3];\n\tint irq_wakeup;\n\tint irq_ack;\n\tint irq_err;\n\tint ret;\n\n\trpm = devm_kzalloc(&pdev->dev, sizeof(*rpm), GFP_KERNEL);\n\tif (!rpm)\n\t\treturn -ENOMEM;\n\n\trpm->dev = &pdev->dev;\n\tmutex_init(&rpm->lock);\n\tinit_completion(&rpm->ack);\n\n\t \n\trpm->ramclk = devm_clk_get_enabled(&pdev->dev, \"ram\");\n\tif (IS_ERR(rpm->ramclk)) {\n\t\tret = PTR_ERR(rpm->ramclk);\n\t\tif (ret == -EPROBE_DEFER)\n\t\t\treturn ret;\n\t\t \n\t\trpm->ramclk = NULL;\n\t}\n\n\tirq_ack = platform_get_irq_byname(pdev, \"ack\");\n\tif (irq_ack < 0)\n\t\treturn irq_ack;\n\n\tirq_err = platform_get_irq_byname(pdev, \"err\");\n\tif (irq_err < 0)\n\t\treturn irq_err;\n\n\tirq_wakeup = platform_get_irq_byname(pdev, \"wakeup\");\n\tif (irq_wakeup < 0)\n\t\treturn irq_wakeup;\n\n\tmatch = of_match_device(qcom_rpm_of_match, &pdev->dev);\n\tif (!match)\n\t\treturn -ENODEV;\n\trpm->data = match->data;\n\n\trpm->status_regs = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(rpm->status_regs))\n\t\treturn PTR_ERR(rpm->status_regs);\n\trpm->ctrl_regs = rpm->status_regs + 0x400;\n\trpm->req_regs = rpm->status_regs + 0x600;\n\n\tsyscon_np = of_parse_phandle(pdev->dev.of_node, \"qcom,ipc\", 0);\n\tif (!syscon_np) {\n\t\tdev_err(&pdev->dev, \"no qcom,ipc node\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\trpm->ipc_regmap = syscon_node_to_regmap(syscon_np);\n\tof_node_put(syscon_np);\n\tif (IS_ERR(rpm->ipc_regmap))\n\t\treturn PTR_ERR(rpm->ipc_regmap);\n\n\tret = of_property_read_u32_index(pdev->dev.of_node, \"qcom,ipc\", 1,\n\t\t\t\t\t &rpm->ipc_offset);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"no offset in qcom,ipc\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = of_property_read_u32_index(pdev->dev.of_node, \"qcom,ipc\", 2,\n\t\t\t\t\t &rpm->ipc_bit);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"no bit in qcom,ipc\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdev_set_drvdata(&pdev->dev, rpm);\n\n\tfw_version[0] = readl(RPM_STATUS_REG(rpm, 0));\n\tfw_version[1] = readl(RPM_STATUS_REG(rpm, 1));\n\tfw_version[2] = readl(RPM_STATUS_REG(rpm, 2));\n\tif (fw_version[0] != rpm->data->version) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"RPM version %u.%u.%u incompatible with driver version %u\",\n\t\t\tfw_version[0],\n\t\t\tfw_version[1],\n\t\t\tfw_version[2],\n\t\t\trpm->data->version);\n\t\treturn -EFAULT;\n\t}\n\n\twritel(fw_version[0], RPM_CTRL_REG(rpm, 0));\n\twritel(fw_version[1], RPM_CTRL_REG(rpm, 1));\n\twritel(fw_version[2], RPM_CTRL_REG(rpm, 2));\n\n\tdev_info(&pdev->dev, \"RPM firmware %u.%u.%u\\n\", fw_version[0],\n\t\t\t\t\t\t\tfw_version[1],\n\t\t\t\t\t\t\tfw_version[2]);\n\n\tret = devm_request_irq(&pdev->dev,\n\t\t\t       irq_ack,\n\t\t\t       qcom_rpm_ack_interrupt,\n\t\t\t       IRQF_TRIGGER_RISING,\n\t\t\t       \"qcom_rpm_ack\",\n\t\t\t       rpm);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to request ack interrupt\\n\");\n\t\treturn ret;\n\t}\n\n\tret = irq_set_irq_wake(irq_ack, 1);\n\tif (ret)\n\t\tdev_warn(&pdev->dev, \"failed to mark ack irq as wakeup\\n\");\n\n\tret = devm_request_irq(&pdev->dev,\n\t\t\t       irq_err,\n\t\t\t       qcom_rpm_err_interrupt,\n\t\t\t       IRQF_TRIGGER_RISING,\n\t\t\t       \"qcom_rpm_err\",\n\t\t\t       rpm);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to request err interrupt\\n\");\n\t\treturn ret;\n\t}\n\n\tret = devm_request_irq(&pdev->dev,\n\t\t\t       irq_wakeup,\n\t\t\t       qcom_rpm_wakeup_interrupt,\n\t\t\t       IRQF_TRIGGER_RISING,\n\t\t\t       \"qcom_rpm_wakeup\",\n\t\t\t       rpm);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to request wakeup interrupt\\n\");\n\t\treturn ret;\n\t}\n\n\tret = irq_set_irq_wake(irq_wakeup, 1);\n\tif (ret)\n\t\tdev_warn(&pdev->dev, \"failed to mark wakeup irq as wakeup\\n\");\n\n\treturn devm_of_platform_populate(&pdev->dev);\n}\n\nstatic struct platform_driver qcom_rpm_driver = {\n\t.probe = qcom_rpm_probe,\n\t.driver  = {\n\t\t.name  = \"qcom_rpm\",\n\t\t.of_match_table = qcom_rpm_of_match,\n\t},\n};\n\nstatic int __init qcom_rpm_init(void)\n{\n\treturn platform_driver_register(&qcom_rpm_driver);\n}\narch_initcall(qcom_rpm_init);\n\nstatic void __exit qcom_rpm_exit(void)\n{\n\tplatform_driver_unregister(&qcom_rpm_driver);\n}\nmodule_exit(qcom_rpm_exit)\n\nMODULE_DESCRIPTION(\"Qualcomm Resource Power Manager driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Bjorn Andersson <bjorn.andersson@sonymobile.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}