{
  "module_name": "arizona-core.c",
  "hash_id": "82539cb97a5142a45d201d8e66dde51181f326a279cdc411ad2f2427e8d82426",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/arizona-core.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/gpio/consumer.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/core.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n#include <linux/regulator/consumer.h>\n#include <linux/regulator/machine.h>\n#include <linux/slab.h>\n#include <linux/ktime.h>\n#include <linux/platform_device.h>\n\n#include <linux/mfd/arizona/core.h>\n#include <linux/mfd/arizona/registers.h>\n\n#include \"arizona.h\"\n\nstatic const char * const wm5102_core_supplies[] = {\n\t\"AVDD\",\n\t\"DBVDD1\",\n};\n\nint arizona_clk32k_enable(struct arizona *arizona)\n{\n\tint ret = 0;\n\n\tmutex_lock(&arizona->clk_lock);\n\n\tarizona->clk32k_ref++;\n\n\tif (arizona->clk32k_ref == 1) {\n\t\tswitch (arizona->pdata.clk32k_src) {\n\t\tcase ARIZONA_32KZ_MCLK1:\n\t\t\tret = pm_runtime_resume_and_get(arizona->dev);\n\t\t\tif (ret != 0)\n\t\t\t\tgoto err_ref;\n\t\t\tret = clk_prepare_enable(arizona->mclk[ARIZONA_MCLK1]);\n\t\t\tif (ret != 0) {\n\t\t\t\tpm_runtime_put_sync(arizona->dev);\n\t\t\t\tgoto err_ref;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase ARIZONA_32KZ_MCLK2:\n\t\t\tret = clk_prepare_enable(arizona->mclk[ARIZONA_MCLK2]);\n\t\t\tif (ret != 0)\n\t\t\t\tgoto err_ref;\n\t\t\tbreak;\n\t\t}\n\n\t\tret = regmap_update_bits(arizona->regmap, ARIZONA_CLOCK_32K_1,\n\t\t\t\t\t ARIZONA_CLK_32K_ENA,\n\t\t\t\t\t ARIZONA_CLK_32K_ENA);\n\t}\n\nerr_ref:\n\tif (ret != 0)\n\t\tarizona->clk32k_ref--;\n\n\tmutex_unlock(&arizona->clk_lock);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_clk32k_enable);\n\nint arizona_clk32k_disable(struct arizona *arizona)\n{\n\tmutex_lock(&arizona->clk_lock);\n\n\tWARN_ON(arizona->clk32k_ref <= 0);\n\n\tarizona->clk32k_ref--;\n\n\tif (arizona->clk32k_ref == 0) {\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_CLOCK_32K_1,\n\t\t\t\t   ARIZONA_CLK_32K_ENA, 0);\n\n\t\tswitch (arizona->pdata.clk32k_src) {\n\t\tcase ARIZONA_32KZ_MCLK1:\n\t\t\tpm_runtime_put_sync(arizona->dev);\n\t\t\tclk_disable_unprepare(arizona->mclk[ARIZONA_MCLK1]);\n\t\t\tbreak;\n\t\tcase ARIZONA_32KZ_MCLK2:\n\t\t\tclk_disable_unprepare(arizona->mclk[ARIZONA_MCLK2]);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tmutex_unlock(&arizona->clk_lock);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_clk32k_disable);\n\nstatic irqreturn_t arizona_clkgen_err(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\n\tdev_err(arizona->dev, \"CLKGEN error\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t arizona_underclocked(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, ARIZONA_INTERRUPT_RAW_STATUS_8,\n\t\t\t  &val);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to read underclock status: %d\\n\",\n\t\t\tret);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (val & ARIZONA_AIF3_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"AIF3 underclocked\\n\");\n\tif (val & ARIZONA_AIF2_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"AIF2 underclocked\\n\");\n\tif (val & ARIZONA_AIF1_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"AIF1 underclocked\\n\");\n\tif (val & ARIZONA_ISRC3_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ISRC3 underclocked\\n\");\n\tif (val & ARIZONA_ISRC2_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ISRC2 underclocked\\n\");\n\tif (val & ARIZONA_ISRC1_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ISRC1 underclocked\\n\");\n\tif (val & ARIZONA_FX_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"FX underclocked\\n\");\n\tif (val & ARIZONA_ASRC_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ASRC underclocked\\n\");\n\tif (val & ARIZONA_DAC_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"DAC underclocked\\n\");\n\tif (val & ARIZONA_ADC_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ADC underclocked\\n\");\n\tif (val & ARIZONA_MIXER_UNDERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"Mixer dropped sample\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t arizona_overclocked(int irq, void *data)\n{\n\tstruct arizona *arizona = data;\n\tunsigned int val[3];\n\tint ret;\n\n\tret = regmap_bulk_read(arizona->regmap, ARIZONA_INTERRUPT_RAW_STATUS_6,\n\t\t\t       &val[0], 3);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to read overclock status: %d\\n\",\n\t\t\tret);\n\t\treturn IRQ_NONE;\n\t}\n\n\tswitch (arizona->type) {\n\tcase WM8998:\n\tcase WM1814:\n\t\t \n\t\tval[0] = ((val[0] & 0x60e0) >> 1) |\n\t\t\t ((val[0] & 0x1e00) >> 2) |\n\t\t\t (val[0] & 0x000f);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (val[0] & ARIZONA_PWM_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"PWM overclocked\\n\");\n\tif (val[0] & ARIZONA_FX_CORE_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"FX core overclocked\\n\");\n\tif (val[0] & ARIZONA_DAC_SYS_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"DAC SYS overclocked\\n\");\n\tif (val[0] & ARIZONA_DAC_WARP_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"DAC WARP overclocked\\n\");\n\tif (val[0] & ARIZONA_ADC_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ADC overclocked\\n\");\n\tif (val[0] & ARIZONA_MIXER_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"Mixer overclocked\\n\");\n\tif (val[0] & ARIZONA_AIF3_SYNC_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"AIF3 overclocked\\n\");\n\tif (val[0] & ARIZONA_AIF2_SYNC_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"AIF2 overclocked\\n\");\n\tif (val[0] & ARIZONA_AIF1_SYNC_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"AIF1 overclocked\\n\");\n\tif (val[0] & ARIZONA_PAD_CTRL_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"Pad control overclocked\\n\");\n\n\tif (val[1] & ARIZONA_SLIMBUS_SUBSYS_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"Slimbus subsystem overclocked\\n\");\n\tif (val[1] & ARIZONA_SLIMBUS_ASYNC_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"Slimbus async overclocked\\n\");\n\tif (val[1] & ARIZONA_SLIMBUS_SYNC_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"Slimbus sync overclocked\\n\");\n\tif (val[1] & ARIZONA_ASRC_ASYNC_SYS_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ASRC async system overclocked\\n\");\n\tif (val[1] & ARIZONA_ASRC_ASYNC_WARP_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ASRC async WARP overclocked\\n\");\n\tif (val[1] & ARIZONA_ASRC_SYNC_SYS_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ASRC sync system overclocked\\n\");\n\tif (val[1] & ARIZONA_ASRC_SYNC_WARP_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ASRC sync WARP overclocked\\n\");\n\tif (val[1] & ARIZONA_ADSP2_1_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"DSP1 overclocked\\n\");\n\tif (val[1] & ARIZONA_ISRC3_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ISRC3 overclocked\\n\");\n\tif (val[1] & ARIZONA_ISRC2_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ISRC2 overclocked\\n\");\n\tif (val[1] & ARIZONA_ISRC1_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"ISRC1 overclocked\\n\");\n\n\tif (val[2] & ARIZONA_SPDIF_OVERCLOCKED_STS)\n\t\tdev_err(arizona->dev, \"SPDIF overclocked\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\n#define ARIZONA_REG_POLL_DELAY_US 7500\n\nstatic inline bool arizona_poll_reg_delay(ktime_t timeout)\n{\n\tif (ktime_compare(ktime_get(), timeout) > 0)\n\t\treturn false;\n\n\tusleep_range(ARIZONA_REG_POLL_DELAY_US / 2, ARIZONA_REG_POLL_DELAY_US);\n\n\treturn true;\n}\n\nstatic int arizona_poll_reg(struct arizona *arizona,\n\t\t\t    int timeout_ms, unsigned int reg,\n\t\t\t    unsigned int mask, unsigned int target)\n{\n\tktime_t timeout = ktime_add_us(ktime_get(), timeout_ms * USEC_PER_MSEC);\n\tunsigned int val = 0;\n\tint ret;\n\n\tdo {\n\t\tret = regmap_read(arizona->regmap, reg, &val);\n\n\t\tif ((val & mask) == target)\n\t\t\treturn 0;\n\t} while (arizona_poll_reg_delay(timeout));\n\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed polling reg 0x%x: %d\\n\",\n\t\t\treg, ret);\n\t\treturn ret;\n\t}\n\n\tdev_err(arizona->dev, \"Polling reg 0x%x timed out: %x\\n\", reg, val);\n\treturn -ETIMEDOUT;\n}\n\nstatic int arizona_wait_for_boot(struct arizona *arizona)\n{\n\tint ret;\n\n\t \n\tret = arizona_poll_reg(arizona, 30, ARIZONA_INTERRUPT_RAW_STATUS_5,\n\t\t\t       ARIZONA_BOOT_DONE_STS, ARIZONA_BOOT_DONE_STS);\n\n\tif (!ret)\n\t\tregmap_write(arizona->regmap, ARIZONA_INTERRUPT_STATUS_5,\n\t\t\t     ARIZONA_BOOT_DONE_STS);\n\n\tpm_runtime_mark_last_busy(arizona->dev);\n\n\treturn ret;\n}\n\nstatic inline void arizona_enable_reset(struct arizona *arizona)\n{\n\tif (arizona->pdata.reset)\n\t\tgpiod_set_raw_value_cansleep(arizona->pdata.reset, 0);\n}\n\nstatic void arizona_disable_reset(struct arizona *arizona)\n{\n\tif (arizona->pdata.reset) {\n\t\tswitch (arizona->type) {\n\t\tcase WM5110:\n\t\tcase WM8280:\n\t\t\t \n\t\t\tusleep_range(5000, 10000);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tgpiod_set_raw_value_cansleep(arizona->pdata.reset, 1);\n\t\tusleep_range(1000, 5000);\n\t}\n}\n\nstruct arizona_sysclk_state {\n\tunsigned int fll;\n\tunsigned int sysclk;\n};\n\nstatic int arizona_enable_freerun_sysclk(struct arizona *arizona,\n\t\t\t\t\t struct arizona_sysclk_state *state)\n{\n\tint ret, err;\n\n\t \n\tret = regmap_read(arizona->regmap, ARIZONA_FLL1_CONTROL_1, &state->fll);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to cache FLL settings: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\tret = regmap_read(arizona->regmap, ARIZONA_SYSTEM_CLOCK_1,\n\t\t\t  &state->sysclk);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to cache SYSCLK settings: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_write(arizona->regmap, ARIZONA_FLL1_CONTROL_1,\n\t\t\tARIZONA_FLL1_ENA | ARIZONA_FLL1_FREERUN);\n\tif (ret) {\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to start FLL in freerunning mode: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\tret = arizona_poll_reg(arizona, 180, ARIZONA_INTERRUPT_RAW_STATUS_5,\n\t\t\t       ARIZONA_FLL1_CLOCK_OK_STS,\n\t\t\t       ARIZONA_FLL1_CLOCK_OK_STS);\n\tif (ret)\n\t\tgoto err_fll;\n\n\tret = regmap_write(arizona->regmap, ARIZONA_SYSTEM_CLOCK_1, 0x0144);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to start SYSCLK: %d\\n\", ret);\n\t\tgoto err_fll;\n\t}\n\n\treturn 0;\n\nerr_fll:\n\terr = regmap_write(arizona->regmap, ARIZONA_FLL1_CONTROL_1, state->fll);\n\tif (err)\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to re-apply old FLL settings: %d\\n\", err);\n\n\treturn ret;\n}\n\nstatic int arizona_disable_freerun_sysclk(struct arizona *arizona,\n\t\t\t\t\t  struct arizona_sysclk_state *state)\n{\n\tint ret;\n\n\tret = regmap_write(arizona->regmap, ARIZONA_SYSTEM_CLOCK_1,\n\t\t\t   state->sysclk);\n\tif (ret) {\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to re-apply old SYSCLK settings: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = regmap_write(arizona->regmap, ARIZONA_FLL1_CONTROL_1, state->fll);\n\tif (ret) {\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to re-apply old FLL settings: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int wm5102_apply_hardware_patch(struct arizona *arizona)\n{\n\tstruct arizona_sysclk_state state;\n\tint err, ret;\n\n\tret = arizona_enable_freerun_sysclk(arizona, &state);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_write(arizona->regmap, ARIZONA_WRITE_SEQUENCER_CTRL_0,\n\t\t\t   ARIZONA_WSEQ_ENA | ARIZONA_WSEQ_START | 160);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to start write sequencer: %d\\n\",\n\t\t\tret);\n\t\tgoto err;\n\t}\n\n\tret = arizona_poll_reg(arizona, 30, ARIZONA_WRITE_SEQUENCER_CTRL_1,\n\t\t\t       ARIZONA_WSEQ_BUSY, 0);\n\tif (ret)\n\t\tregmap_write(arizona->regmap, ARIZONA_WRITE_SEQUENCER_CTRL_0,\n\t\t\t     ARIZONA_WSEQ_ABORT);\n\nerr:\n\terr = arizona_disable_freerun_sysclk(arizona, &state);\n\n\treturn ret ?: err;\n}\n\n \nstatic const struct reg_sequence wm5110_sleep_patch[] = {\n\t{ 0x337A, 0xC100 },\n\t{ 0x337B, 0x0041 },\n\t{ 0x3300, 0xA210 },\n\t{ 0x3301, 0x050C },\n};\n\nstatic int wm5110_apply_sleep_patch(struct arizona *arizona)\n{\n\tstruct arizona_sysclk_state state;\n\tint err, ret;\n\n\tret = arizona_enable_freerun_sysclk(arizona, &state);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_multi_reg_write_bypassed(arizona->regmap,\n\t\t\t\t\t      wm5110_sleep_patch,\n\t\t\t\t\t      ARRAY_SIZE(wm5110_sleep_patch));\n\n\terr = arizona_disable_freerun_sysclk(arizona, &state);\n\n\treturn ret ?: err;\n}\n\nstatic int wm5102_clear_write_sequencer(struct arizona *arizona)\n{\n\tint ret;\n\n\tret = regmap_write(arizona->regmap, ARIZONA_WRITE_SEQUENCER_CTRL_3,\n\t\t\t   0x0);\n\tif (ret) {\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to clear write sequencer state: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tarizona_enable_reset(arizona);\n\tregulator_disable(arizona->dcvdd);\n\n\tmsleep(20);\n\n\tret = regulator_enable(arizona->dcvdd);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to re-enable DCVDD: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tarizona_disable_reset(arizona);\n\n\treturn 0;\n}\n\nstatic int arizona_isolate_dcvdd(struct arizona *arizona)\n{\n\tint ret;\n\n\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t ARIZONA_ISOLATION_CONTROL,\n\t\t\t\t ARIZONA_ISOLATE_DCVDD1,\n\t\t\t\t ARIZONA_ISOLATE_DCVDD1);\n\tif (ret != 0)\n\t\tdev_err(arizona->dev, \"Failed to isolate DCVDD: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int arizona_connect_dcvdd(struct arizona *arizona)\n{\n\tint ret;\n\n\tret = regmap_update_bits(arizona->regmap,\n\t\t\t\t ARIZONA_ISOLATION_CONTROL,\n\t\t\t\t ARIZONA_ISOLATE_DCVDD1, 0);\n\tif (ret != 0)\n\t\tdev_err(arizona->dev, \"Failed to connect DCVDD: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int arizona_is_jack_det_active(struct arizona *arizona)\n{\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(arizona->regmap, ARIZONA_JACK_DETECT_ANALOGUE, &val);\n\tif (ret) {\n\t\tdev_err(arizona->dev,\n\t\t\t\"Failed to check jack det status: %d\\n\", ret);\n\t\treturn ret;\n\t} else if (val & ARIZONA_JD1_ENA) {\n\t\treturn 1;\n\t} else {\n\t\treturn 0;\n\t}\n}\n\nstatic int arizona_runtime_resume(struct device *dev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(dev);\n\tint ret;\n\n\tdev_dbg(arizona->dev, \"Leaving AoD mode\\n\");\n\n\tif (arizona->has_fully_powered_off) {\n\t\tdev_dbg(arizona->dev, \"Re-enabling core supplies\\n\");\n\n\t\tret = regulator_bulk_enable(arizona->num_core_supplies,\n\t\t\t\t\t    arizona->core_supplies);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to enable core supplies: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = regulator_enable(arizona->dcvdd);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to enable DCVDD: %d\\n\", ret);\n\t\tif (arizona->has_fully_powered_off)\n\t\t\tregulator_bulk_disable(arizona->num_core_supplies,\n\t\t\t\t\t       arizona->core_supplies);\n\t\treturn ret;\n\t}\n\n\tif (arizona->has_fully_powered_off) {\n\t\tarizona_disable_reset(arizona);\n\t\tenable_irq(arizona->irq);\n\t\tarizona->has_fully_powered_off = false;\n\t}\n\n\tregcache_cache_only(arizona->regmap, false);\n\n\tswitch (arizona->type) {\n\tcase WM5102:\n\t\tif (arizona->external_dcvdd) {\n\t\t\tret = arizona_connect_dcvdd(arizona);\n\t\t\tif (ret != 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tret = wm5102_patch(arizona);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to apply patch: %d\\n\",\n\t\t\t\tret);\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = wm5102_apply_hardware_patch(arizona);\n\t\tif (ret) {\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Failed to apply hardware patch: %d\\n\",\n\t\t\t\tret);\n\t\t\tgoto err;\n\t\t}\n\t\tbreak;\n\tcase WM5110:\n\tcase WM8280:\n\t\tret = arizona_wait_for_boot(arizona);\n\t\tif (ret)\n\t\t\tgoto err;\n\n\t\tif (arizona->external_dcvdd) {\n\t\t\tret = arizona_connect_dcvdd(arizona);\n\t\t\tif (ret != 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tret = regulator_set_voltage(arizona->dcvdd,\n\t\t\t\t\t\t    1200000, 1200000);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(arizona->dev,\n\t\t\t\t\t\"Failed to set resume voltage: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\tgoto err;\n\t\t\t}\n\t\t}\n\n\t\tret = wm5110_apply_sleep_patch(arizona);\n\t\tif (ret) {\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Failed to re-apply sleep patch: %d\\n\",\n\t\t\t\tret);\n\t\t\tgoto err;\n\t\t}\n\t\tbreak;\n\tcase WM1831:\n\tcase CS47L24:\n\t\tret = arizona_wait_for_boot(arizona);\n\t\tif (ret != 0)\n\t\t\tgoto err;\n\t\tbreak;\n\tdefault:\n\t\tret = arizona_wait_for_boot(arizona);\n\t\tif (ret != 0)\n\t\t\tgoto err;\n\n\t\tif (arizona->external_dcvdd) {\n\t\t\tret = arizona_connect_dcvdd(arizona);\n\t\t\tif (ret != 0)\n\t\t\t\tgoto err;\n\t\t}\n\t\tbreak;\n\t}\n\n\tret = regcache_sync(arizona->regmap);\n\tif (ret != 0) {\n\t\tdev_err(arizona->dev, \"Failed to restore register cache\\n\");\n\t\tgoto err;\n\t}\n\n\treturn 0;\n\nerr:\n\tregcache_cache_only(arizona->regmap, true);\n\tregulator_disable(arizona->dcvdd);\n\treturn ret;\n}\n\nstatic int arizona_runtime_suspend(struct device *dev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(dev);\n\tint jd_active = 0;\n\tint ret;\n\n\tdev_dbg(arizona->dev, \"Entering AoD mode\\n\");\n\n\tswitch (arizona->type) {\n\tcase WM5110:\n\tcase WM8280:\n\t\tjd_active = arizona_is_jack_det_active(arizona);\n\t\tif (jd_active < 0)\n\t\t\treturn jd_active;\n\n\t\tif (arizona->external_dcvdd) {\n\t\t\tret = arizona_isolate_dcvdd(arizona);\n\t\t\tif (ret != 0)\n\t\t\t\treturn ret;\n\t\t} else {\n\t\t\t \n\t\t\tret = regulator_set_voltage(arizona->dcvdd,\n\t\t\t\t\t\t    1175000, 1175000);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(arizona->dev,\n\t\t\t\t\t\"Failed to set suspend voltage: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase WM5102:\n\t\tjd_active = arizona_is_jack_det_active(arizona);\n\t\tif (jd_active < 0)\n\t\t\treturn jd_active;\n\n\t\tif (arizona->external_dcvdd) {\n\t\t\tret = arizona_isolate_dcvdd(arizona);\n\t\t\tif (ret != 0)\n\t\t\t\treturn ret;\n\t\t}\n\n\t\tif (!jd_active) {\n\t\t\tret = regmap_write(arizona->regmap,\n\t\t\t\t\t   ARIZONA_WRITE_SEQUENCER_CTRL_3, 0x0);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(arizona->dev,\n\t\t\t\t\t\"Failed to clear write sequencer: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase WM1831:\n\tcase CS47L24:\n\t\tbreak;\n\tdefault:\n\t\tjd_active = arizona_is_jack_det_active(arizona);\n\t\tif (jd_active < 0)\n\t\t\treturn jd_active;\n\n\t\tif (arizona->external_dcvdd) {\n\t\t\tret = arizona_isolate_dcvdd(arizona);\n\t\t\tif (ret != 0)\n\t\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\t}\n\n\tregcache_cache_only(arizona->regmap, true);\n\tregcache_mark_dirty(arizona->regmap);\n\tregulator_disable(arizona->dcvdd);\n\n\t \n\tif (!jd_active) {\n\t\tdev_dbg(arizona->dev, \"Fully powering off\\n\");\n\n\t\tarizona->has_fully_powered_off = true;\n\n\t\tdisable_irq_nosync(arizona->irq);\n\t\tarizona_enable_reset(arizona);\n\t\tregulator_bulk_disable(arizona->num_core_supplies,\n\t\t\t\t       arizona->core_supplies);\n\t}\n\n\treturn 0;\n}\n\nstatic int arizona_suspend(struct device *dev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(dev);\n\n\tdev_dbg(arizona->dev, \"Suspend, disabling IRQ\\n\");\n\tdisable_irq(arizona->irq);\n\n\treturn 0;\n}\n\nstatic int arizona_suspend_noirq(struct device *dev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(dev);\n\n\tdev_dbg(arizona->dev, \"Late suspend, reenabling IRQ\\n\");\n\tenable_irq(arizona->irq);\n\n\treturn 0;\n}\n\nstatic int arizona_resume_noirq(struct device *dev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(dev);\n\n\tdev_dbg(arizona->dev, \"Early resume, disabling IRQ\\n\");\n\tdisable_irq(arizona->irq);\n\n\treturn 0;\n}\n\nstatic int arizona_resume(struct device *dev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(dev);\n\n\tdev_dbg(arizona->dev, \"Resume, reenabling IRQ\\n\");\n\tenable_irq(arizona->irq);\n\n\treturn 0;\n}\n\nEXPORT_GPL_DEV_PM_OPS(arizona_pm_ops) = {\n\tRUNTIME_PM_OPS(arizona_runtime_suspend,\n\t\t       arizona_runtime_resume,\n\t\t       NULL)\n\tSYSTEM_SLEEP_PM_OPS(arizona_suspend, arizona_resume)\n\tNOIRQ_SYSTEM_SLEEP_PM_OPS(arizona_suspend_noirq,\n\t\t\t\t  arizona_resume_noirq)\n};\n\n#ifdef CONFIG_OF\nstatic int arizona_of_get_core_pdata(struct arizona *arizona)\n{\n\tstruct arizona_pdata *pdata = &arizona->pdata;\n\tint ret, i;\n\n\t \n\tpdata->reset = devm_gpiod_get(arizona->dev, \"wlf,reset\", GPIOD_OUT_LOW);\n\tif (IS_ERR(pdata->reset)) {\n\t\tret = PTR_ERR(pdata->reset);\n\n\t\t \n\t\tif (ret == -EPROBE_DEFER)\n\t\t\treturn ret;\n\t\telse if (ret != -ENOENT && ret != -ENOSYS)\n\t\t\tdev_err(arizona->dev, \"Reset GPIO malformed: %d\\n\",\n\t\t\t\tret);\n\n\t\tpdata->reset = NULL;\n\t}\n\n\tret = of_property_read_u32_array(arizona->dev->of_node,\n\t\t\t\t\t \"wlf,gpio-defaults\",\n\t\t\t\t\t pdata->gpio_defaults,\n\t\t\t\t\t ARRAY_SIZE(pdata->gpio_defaults));\n\tif (ret >= 0) {\n\t\t \n\t\tfor (i = 0; i < ARRAY_SIZE(pdata->gpio_defaults); i++) {\n\t\t\tif (pdata->gpio_defaults[i] > 0xffff)\n\t\t\t\tpdata->gpio_defaults[i] = 0;\n\t\t\telse if (pdata->gpio_defaults[i] == 0)\n\t\t\t\tpdata->gpio_defaults[i] = 0x10000;\n\t\t}\n\t} else {\n\t\tdev_err(arizona->dev, \"Failed to parse GPIO defaults: %d\\n\",\n\t\t\tret);\n\t}\n\n\treturn 0;\n}\n#else\nstatic inline int arizona_of_get_core_pdata(struct arizona *arizona)\n{\n\treturn 0;\n}\n#endif\n\nstatic const struct mfd_cell early_devs[] = {\n\t{ .name = \"arizona-ldo1\" },\n};\n\nstatic const char * const wm5102_supplies[] = {\n\t\"MICVDD\",\n\t\"DBVDD2\",\n\t\"DBVDD3\",\n\t\"CPVDD\",\n\t\"SPKVDDL\",\n\t\"SPKVDDR\",\n};\n\nstatic const struct mfd_cell wm5102_devs[] = {\n\t{ .name = \"arizona-micsupp\" },\n\t{ .name = \"arizona-gpio\" },\n\t{ .name = \"arizona-haptics\" },\n\t{ .name = \"arizona-pwm\" },\n\t{\n\t\t.name = \"wm5102-codec\",\n\t\t.parent_supplies = wm5102_supplies,\n\t\t.num_parent_supplies = ARRAY_SIZE(wm5102_supplies),\n\t},\n};\n\nstatic const struct mfd_cell wm5110_devs[] = {\n\t{ .name = \"arizona-micsupp\" },\n\t{ .name = \"arizona-gpio\" },\n\t{ .name = \"arizona-haptics\" },\n\t{ .name = \"arizona-pwm\" },\n\t{\n\t\t.name = \"wm5110-codec\",\n\t\t.parent_supplies = wm5102_supplies,\n\t\t.num_parent_supplies = ARRAY_SIZE(wm5102_supplies),\n\t},\n};\n\nstatic const char * const cs47l24_supplies[] = {\n\t\"MICVDD\",\n\t\"CPVDD\",\n\t\"SPKVDD\",\n};\n\nstatic const struct mfd_cell cs47l24_devs[] = {\n\t{ .name = \"arizona-gpio\" },\n\t{ .name = \"arizona-haptics\" },\n\t{ .name = \"arizona-pwm\" },\n\t{\n\t\t.name = \"cs47l24-codec\",\n\t\t.parent_supplies = cs47l24_supplies,\n\t\t.num_parent_supplies = ARRAY_SIZE(cs47l24_supplies),\n\t},\n};\n\nstatic const char * const wm8997_supplies[] = {\n\t\"MICVDD\",\n\t\"DBVDD2\",\n\t\"CPVDD\",\n\t\"SPKVDD\",\n};\n\nstatic const struct mfd_cell wm8997_devs[] = {\n\t{ .name = \"arizona-micsupp\" },\n\t{ .name = \"arizona-gpio\" },\n\t{ .name = \"arizona-haptics\" },\n\t{ .name = \"arizona-pwm\" },\n\t{\n\t\t.name = \"wm8997-codec\",\n\t\t.parent_supplies = wm8997_supplies,\n\t\t.num_parent_supplies = ARRAY_SIZE(wm8997_supplies),\n\t},\n};\n\nstatic const struct mfd_cell wm8998_devs[] = {\n\t{ .name = \"arizona-micsupp\" },\n\t{ .name = \"arizona-gpio\" },\n\t{ .name = \"arizona-haptics\" },\n\t{ .name = \"arizona-pwm\" },\n\t{\n\t\t.name = \"wm8998-codec\",\n\t\t.parent_supplies = wm5102_supplies,\n\t\t.num_parent_supplies = ARRAY_SIZE(wm5102_supplies),\n\t},\n};\n\nint arizona_dev_init(struct arizona *arizona)\n{\n\tstatic const char * const mclk_name[] = { \"mclk1\", \"mclk2\" };\n\tstruct device *dev = arizona->dev;\n\tconst char *type_name = NULL;\n\tunsigned int reg, val;\n\tint (*apply_patch)(struct arizona *) = NULL;\n\tconst struct mfd_cell *subdevs = NULL;\n\tint n_subdevs = 0, ret, i;\n\n\tdev_set_drvdata(arizona->dev, arizona);\n\tmutex_init(&arizona->clk_lock);\n\n\tif (dev_get_platdata(arizona->dev)) {\n\t\tmemcpy(&arizona->pdata, dev_get_platdata(arizona->dev),\n\t\t       sizeof(arizona->pdata));\n\t} else {\n\t\tret = arizona_of_get_core_pdata(arizona);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tBUILD_BUG_ON(ARRAY_SIZE(arizona->mclk) != ARRAY_SIZE(mclk_name));\n\tfor (i = 0; i < ARRAY_SIZE(arizona->mclk); i++) {\n\t\tarizona->mclk[i] = devm_clk_get(arizona->dev, mclk_name[i]);\n\t\tif (IS_ERR(arizona->mclk[i])) {\n\t\t\tdev_info(arizona->dev, \"Failed to get %s: %ld\\n\",\n\t\t\t\t mclk_name[i], PTR_ERR(arizona->mclk[i]));\n\t\t\tarizona->mclk[i] = NULL;\n\t\t}\n\t}\n\n\tregcache_cache_only(arizona->regmap, true);\n\n\tswitch (arizona->type) {\n\tcase WM5102:\n\tcase WM5110:\n\tcase WM8280:\n\tcase WM8997:\n\tcase WM8998:\n\tcase WM1814:\n\tcase WM1831:\n\tcase CS47L24:\n\t\tfor (i = 0; i < ARRAY_SIZE(wm5102_core_supplies); i++)\n\t\t\tarizona->core_supplies[i].supply\n\t\t\t\t= wm5102_core_supplies[i];\n\t\tarizona->num_core_supplies = ARRAY_SIZE(wm5102_core_supplies);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(arizona->dev, \"Unknown device type %d\\n\",\n\t\t\tarizona->type);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tarizona->external_dcvdd = true;\n\n\tswitch (arizona->type) {\n\tcase WM1831:\n\tcase CS47L24:\n\t\tbreak;  \n\tdefault:\n\t\tret = mfd_add_devices(arizona->dev, -1, early_devs,\n\t\t\t\t      ARRAY_SIZE(early_devs), NULL, 0, NULL);\n\t\tif (ret != 0) {\n\t\t\tdev_err(dev, \"Failed to add early children: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\t}\n\n\tret = devm_regulator_bulk_get(dev, arizona->num_core_supplies,\n\t\t\t\t      arizona->core_supplies);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"Failed to request core supplies: %d\\n\",\n\t\t\tret);\n\t\tgoto err_early;\n\t}\n\n\t \n\tarizona->dcvdd = regulator_get(arizona->dev, \"DCVDD\");\n\tif (IS_ERR(arizona->dcvdd)) {\n\t\tret = PTR_ERR(arizona->dcvdd);\n\t\tdev_err(dev, \"Failed to request DCVDD: %d\\n\", ret);\n\t\tgoto err_early;\n\t}\n\n\tif (!arizona->pdata.reset) {\n\t\t \n\t\tarizona->pdata.reset = devm_gpiod_get(arizona->dev, \"reset\",\n\t\t\t\t\t\t      GPIOD_OUT_LOW);\n\t\tif (IS_ERR(arizona->pdata.reset)) {\n\t\t\tret = PTR_ERR(arizona->pdata.reset);\n\t\t\tif (ret == -EPROBE_DEFER)\n\t\t\t\tgoto err_dcvdd;\n\n\t\t\tdev_err(arizona->dev,\n\t\t\t\t\"Reset GPIO missing/malformed: %d\\n\", ret);\n\n\t\t\tarizona->pdata.reset = NULL;\n\t\t}\n\t}\n\n\tret = regulator_bulk_enable(arizona->num_core_supplies,\n\t\t\t\t    arizona->core_supplies);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"Failed to enable core supplies: %d\\n\",\n\t\t\tret);\n\t\tgoto err_dcvdd;\n\t}\n\n\tret = regulator_enable(arizona->dcvdd);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"Failed to enable DCVDD: %d\\n\", ret);\n\t\tgoto err_enable;\n\t}\n\n\tarizona_disable_reset(arizona);\n\n\tregcache_cache_only(arizona->regmap, false);\n\n\t \n\tret = regmap_read(arizona->regmap, ARIZONA_SOFTWARE_RESET, &reg);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"Failed to read ID register: %d\\n\", ret);\n\t\tgoto err_reset;\n\t}\n\n\tswitch (reg) {\n\tcase 0x5102:\n\tcase 0x5110:\n\tcase 0x6349:\n\tcase 0x6363:\n\tcase 0x8997:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(arizona->dev, \"Unknown device ID: %x\\n\", reg);\n\t\tret = -ENODEV;\n\t\tgoto err_reset;\n\t}\n\n\t \n\tif (!arizona->pdata.reset) {\n\t\tret = regmap_write(arizona->regmap, ARIZONA_SOFTWARE_RESET, 0);\n\t\tif (ret != 0) {\n\t\t\tdev_err(dev, \"Failed to reset device: %d\\n\", ret);\n\t\t\tgoto err_reset;\n\t\t}\n\n\t\tusleep_range(1000, 5000);\n\t}\n\n\t \n\tswitch (arizona->type) {\n\tcase WM5102:\n\t\tret = regmap_read(arizona->regmap,\n\t\t\t\t  ARIZONA_WRITE_SEQUENCER_CTRL_3, &val);\n\t\tif (ret) {\n\t\t\tdev_err(dev,\n\t\t\t\t\"Failed to check write sequencer state: %d\\n\",\n\t\t\t\tret);\n\t\t} else if (val & 0x01) {\n\t\t\tret = wm5102_clear_write_sequencer(arizona);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tret = arizona_wait_for_boot(arizona);\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Device failed initial boot: %d\\n\", ret);\n\t\tgoto err_reset;\n\t}\n\n\t \n\tret = regmap_read(arizona->regmap, ARIZONA_SOFTWARE_RESET, &reg);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"Failed to read ID register: %d\\n\", ret);\n\t\tgoto err_reset;\n\t}\n\n\tret = regmap_read(arizona->regmap, ARIZONA_DEVICE_REVISION,\n\t\t\t  &arizona->rev);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"Failed to read revision register: %d\\n\", ret);\n\t\tgoto err_reset;\n\t}\n\tarizona->rev &= ARIZONA_DEVICE_REVISION_MASK;\n\n\tswitch (reg) {\n\tcase 0x5102:\n\t\tif (IS_ENABLED(CONFIG_MFD_WM5102)) {\n\t\t\ttype_name = \"WM5102\";\n\t\t\tif (arizona->type != WM5102) {\n\t\t\t\tdev_warn(arizona->dev,\n\t\t\t\t\t \"WM5102 registered as %d\\n\",\n\t\t\t\t\t arizona->type);\n\t\t\t\tarizona->type = WM5102;\n\t\t\t}\n\n\t\t\tapply_patch = wm5102_patch;\n\t\t\tarizona->rev &= 0x7;\n\t\t\tsubdevs = wm5102_devs;\n\t\t\tn_subdevs = ARRAY_SIZE(wm5102_devs);\n\t\t}\n\t\tbreak;\n\tcase 0x5110:\n\t\tif (IS_ENABLED(CONFIG_MFD_WM5110)) {\n\t\t\tswitch (arizona->type) {\n\t\t\tcase WM5110:\n\t\t\t\ttype_name = \"WM5110\";\n\t\t\t\tbreak;\n\t\t\tcase WM8280:\n\t\t\t\ttype_name = \"WM8280\";\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\ttype_name = \"WM5110\";\n\t\t\t\tdev_warn(arizona->dev,\n\t\t\t\t\t \"WM5110 registered as %d\\n\",\n\t\t\t\t\t arizona->type);\n\t\t\t\tarizona->type = WM5110;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tapply_patch = wm5110_patch;\n\t\t\tsubdevs = wm5110_devs;\n\t\t\tn_subdevs = ARRAY_SIZE(wm5110_devs);\n\t\t}\n\t\tbreak;\n\tcase 0x6363:\n\t\tif (IS_ENABLED(CONFIG_MFD_CS47L24)) {\n\t\t\tswitch (arizona->type) {\n\t\t\tcase CS47L24:\n\t\t\t\ttype_name = \"CS47L24\";\n\t\t\t\tbreak;\n\n\t\t\tcase WM1831:\n\t\t\t\ttype_name = \"WM1831\";\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tdev_warn(arizona->dev,\n\t\t\t\t\t \"CS47L24 registered as %d\\n\",\n\t\t\t\t\t arizona->type);\n\t\t\t\tarizona->type = CS47L24;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tapply_patch = cs47l24_patch;\n\t\t\tsubdevs = cs47l24_devs;\n\t\t\tn_subdevs = ARRAY_SIZE(cs47l24_devs);\n\t\t}\n\t\tbreak;\n\tcase 0x8997:\n\t\tif (IS_ENABLED(CONFIG_MFD_WM8997)) {\n\t\t\ttype_name = \"WM8997\";\n\t\t\tif (arizona->type != WM8997) {\n\t\t\t\tdev_warn(arizona->dev,\n\t\t\t\t\t \"WM8997 registered as %d\\n\",\n\t\t\t\t\t arizona->type);\n\t\t\t\tarizona->type = WM8997;\n\t\t\t}\n\n\t\t\tapply_patch = wm8997_patch;\n\t\t\tsubdevs = wm8997_devs;\n\t\t\tn_subdevs = ARRAY_SIZE(wm8997_devs);\n\t\t}\n\t\tbreak;\n\tcase 0x6349:\n\t\tif (IS_ENABLED(CONFIG_MFD_WM8998)) {\n\t\t\tswitch (arizona->type) {\n\t\t\tcase WM8998:\n\t\t\t\ttype_name = \"WM8998\";\n\t\t\t\tbreak;\n\n\t\t\tcase WM1814:\n\t\t\t\ttype_name = \"WM1814\";\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\ttype_name = \"WM8998\";\n\t\t\t\tdev_warn(arizona->dev,\n\t\t\t\t\t \"WM8998 registered as %d\\n\",\n\t\t\t\t\t arizona->type);\n\t\t\t\tarizona->type = WM8998;\n\t\t\t}\n\n\t\t\tapply_patch = wm8998_patch;\n\t\t\tsubdevs = wm8998_devs;\n\t\t\tn_subdevs = ARRAY_SIZE(wm8998_devs);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(arizona->dev, \"Unknown device ID %x\\n\", reg);\n\t\tret = -ENODEV;\n\t\tgoto err_reset;\n\t}\n\n\tif (!subdevs) {\n\t\tdev_err(arizona->dev,\n\t\t\t\"No kernel support for device ID %x\\n\", reg);\n\t\tret = -ENODEV;\n\t\tgoto err_reset;\n\t}\n\n\tdev_info(dev, \"%s revision %c\\n\", type_name, arizona->rev + 'A');\n\n\tif (apply_patch) {\n\t\tret = apply_patch(arizona);\n\t\tif (ret != 0) {\n\t\t\tdev_err(arizona->dev, \"Failed to apply patch: %d\\n\",\n\t\t\t\tret);\n\t\t\tgoto err_reset;\n\t\t}\n\n\t\tswitch (arizona->type) {\n\t\tcase WM5102:\n\t\t\tret = wm5102_apply_hardware_patch(arizona);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(arizona->dev,\n\t\t\t\t\t\"Failed to apply hardware patch: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\tgoto err_reset;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase WM5110:\n\t\tcase WM8280:\n\t\t\tret = wm5110_apply_sleep_patch(arizona);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(arizona->dev,\n\t\t\t\t\t\"Failed to apply sleep patch: %d\\n\",\n\t\t\t\t\tret);\n\t\t\t\tgoto err_reset;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(arizona->pdata.gpio_defaults); i++) {\n\t\tif (!arizona->pdata.gpio_defaults[i])\n\t\t\tcontinue;\n\n\t\tregmap_write(arizona->regmap, ARIZONA_GPIO1_CTRL + i,\n\t\t\t     arizona->pdata.gpio_defaults[i]);\n\t}\n\n\t \n\tif (!arizona->pdata.clk32k_src)\n\t\tarizona->pdata.clk32k_src = ARIZONA_32KZ_MCLK2;\n\n\tswitch (arizona->pdata.clk32k_src) {\n\tcase ARIZONA_32KZ_MCLK1:\n\tcase ARIZONA_32KZ_MCLK2:\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_CLOCK_32K_1,\n\t\t\t\t   ARIZONA_CLK_32K_SRC_MASK,\n\t\t\t\t   arizona->pdata.clk32k_src - 1);\n\t\tarizona_clk32k_enable(arizona);\n\t\tbreak;\n\tcase ARIZONA_32KZ_NONE:\n\t\tregmap_update_bits(arizona->regmap, ARIZONA_CLOCK_32K_1,\n\t\t\t\t   ARIZONA_CLK_32K_SRC_MASK, 2);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(arizona->dev, \"Invalid 32kHz clock source: %d\\n\",\n\t\t\tarizona->pdata.clk32k_src);\n\t\tret = -EINVAL;\n\t\tgoto err_reset;\n\t}\n\n\tfor (i = 0; i < ARIZONA_MAX_MICBIAS; i++) {\n\t\tif (!arizona->pdata.micbias[i].mV &&\n\t\t    !arizona->pdata.micbias[i].bypass)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (!arizona->pdata.micbias[i].mV)\n\t\t\tarizona->pdata.micbias[i].mV = 2800;\n\n\t\tval = (arizona->pdata.micbias[i].mV - 1500) / 100;\n\n\t\tval <<= ARIZONA_MICB1_LVL_SHIFT;\n\n\t\tif (arizona->pdata.micbias[i].ext_cap)\n\t\t\tval |= ARIZONA_MICB1_EXT_CAP;\n\n\t\tif (arizona->pdata.micbias[i].discharge)\n\t\t\tval |= ARIZONA_MICB1_DISCH;\n\n\t\tif (arizona->pdata.micbias[i].soft_start)\n\t\t\tval |= ARIZONA_MICB1_RATE;\n\n\t\tif (arizona->pdata.micbias[i].bypass)\n\t\t\tval |= ARIZONA_MICB1_BYPASS;\n\n\t\tregmap_update_bits(arizona->regmap,\n\t\t\t\t   ARIZONA_MIC_BIAS_CTRL_1 + i,\n\t\t\t\t   ARIZONA_MICB1_LVL_MASK |\n\t\t\t\t   ARIZONA_MICB1_EXT_CAP |\n\t\t\t\t   ARIZONA_MICB1_DISCH |\n\t\t\t\t   ARIZONA_MICB1_BYPASS |\n\t\t\t\t   ARIZONA_MICB1_RATE, val);\n\t}\n\n\tpm_runtime_set_active(arizona->dev);\n\tpm_runtime_enable(arizona->dev);\n\n\t \n\tret = arizona_irq_init(arizona);\n\tif (ret != 0)\n\t\tgoto err_pm;\n\n\tpm_runtime_set_autosuspend_delay(arizona->dev, 100);\n\tpm_runtime_use_autosuspend(arizona->dev);\n\n\tarizona_request_irq(arizona, ARIZONA_IRQ_CLKGEN_ERR, \"CLKGEN error\",\n\t\t\t    arizona_clkgen_err, arizona);\n\tarizona_request_irq(arizona, ARIZONA_IRQ_OVERCLOCKED, \"Overclocked\",\n\t\t\t    arizona_overclocked, arizona);\n\tarizona_request_irq(arizona, ARIZONA_IRQ_UNDERCLOCKED, \"Underclocked\",\n\t\t\t    arizona_underclocked, arizona);\n\n\tret = mfd_add_devices(arizona->dev, PLATFORM_DEVID_NONE,\n\t\t\t      subdevs, n_subdevs, NULL, 0, NULL);\n\n\tif (ret) {\n\t\tdev_err(arizona->dev, \"Failed to add subdevices: %d\\n\", ret);\n\t\tgoto err_irq;\n\t}\n\n\treturn 0;\n\nerr_irq:\n\tarizona_irq_exit(arizona);\nerr_pm:\n\tpm_runtime_disable(arizona->dev);\n\n\tswitch (arizona->pdata.clk32k_src) {\n\tcase ARIZONA_32KZ_MCLK1:\n\tcase ARIZONA_32KZ_MCLK2:\n\t\tarizona_clk32k_disable(arizona);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\nerr_reset:\n\tarizona_enable_reset(arizona);\n\tregulator_disable(arizona->dcvdd);\nerr_enable:\n\tregulator_bulk_disable(arizona->num_core_supplies,\n\t\t\t       arizona->core_supplies);\nerr_dcvdd:\n\tregulator_put(arizona->dcvdd);\nerr_early:\n\tmfd_remove_devices(dev);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(arizona_dev_init);\n\nint arizona_dev_exit(struct arizona *arizona)\n{\n\tdisable_irq(arizona->irq);\n\tpm_runtime_disable(arizona->dev);\n\n\tregulator_disable(arizona->dcvdd);\n\tregulator_put(arizona->dcvdd);\n\n\tswitch (arizona->pdata.clk32k_src) {\n\tcase ARIZONA_32KZ_MCLK1:\n\tcase ARIZONA_32KZ_MCLK2:\n\t\tarizona_clk32k_disable(arizona);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tmfd_remove_devices(arizona->dev);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_UNDERCLOCKED, arizona);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_OVERCLOCKED, arizona);\n\tarizona_free_irq(arizona, ARIZONA_IRQ_CLKGEN_ERR, arizona);\n\tarizona_irq_exit(arizona);\n\tarizona_enable_reset(arizona);\n\n\tregulator_bulk_disable(arizona->num_core_supplies,\n\t\t\t       arizona->core_supplies);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(arizona_dev_exit);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}