{
  "module_name": "tps65911-comparator.c",
  "hash_id": "bf7a069a6c6421423e5afdba8ce832ba1fe185631f20a2ac76161a2ea9d82a37",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/tps65911-comparator.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/debugfs.h>\n#include <linux/gpio.h>\n#include <linux/mfd/tps65910.h>\n\n#define COMP1\t\t\t\t\t0\n#define COMP2\t\t\t\t\t1\n\n \nstatic const u16 COMP_VSEL_TABLE[] = {\n\t0, 2500, 2500, 2500, 2500, 2550, 2600, 2650,\n\t2700, 2750, 2800, 2850, 2900, 2950, 3000, 3050,\n\t3100, 3150, 3200, 3250, 3300, 3350, 3400, 3450,\n\t3500,\n};\n\nstruct comparator {\n\tconst char *name;\n\tint reg;\n\tint uV_max;\n\tconst u16 *vsel_table;\n};\n\nstatic struct comparator tps_comparators[] = {\n\t{\n\t\t.name = \"COMP1\",\n\t\t.reg = TPS65911_VMBCH,\n\t\t.uV_max = 3500,\n\t\t.vsel_table = COMP_VSEL_TABLE,\n\t},\n\t{\n\t\t.name = \"COMP2\",\n\t\t.reg = TPS65911_VMBCH2,\n\t\t.uV_max = 3500,\n\t\t.vsel_table = COMP_VSEL_TABLE,\n\t},\n};\n\nstatic int comp_threshold_set(struct tps65910 *tps65910, int id, int voltage)\n{\n\tstruct comparator tps_comp = tps_comparators[id];\n\tint curr_voltage = 0;\n\tint ret;\n\tu8 index = 0, val;\n\n\twhile (curr_voltage < tps_comp.uV_max) {\n\t\tcurr_voltage = tps_comp.vsel_table[index];\n\t\tif (curr_voltage >= voltage)\n\t\t\tbreak;\n\t\telse if (curr_voltage < voltage)\n\t\t\tindex ++;\n\t}\n\n\tif (curr_voltage > tps_comp.uV_max)\n\t\treturn -EINVAL;\n\n\tval = index << 1;\n\tret = regmap_write(tps65910->regmap, tps_comp.reg, val);\n\n\treturn ret;\n}\n\nstatic int comp_threshold_get(struct tps65910 *tps65910, int id)\n{\n\tstruct comparator tps_comp = tps_comparators[id];\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(tps65910->regmap, tps_comp.reg, &val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tval >>= 1;\n\treturn tps_comp.vsel_table[val];\n}\n\nstatic ssize_t comp_threshold_show(struct device *dev,\n\t\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct tps65910 *tps65910 = dev_get_drvdata(dev->parent);\n\tstruct attribute comp_attr = attr->attr;\n\tint id, uVolt;\n\n\tif (!strcmp(comp_attr.name, \"comp1_threshold\"))\n\t\tid = COMP1;\n\telse if (!strcmp(comp_attr.name, \"comp2_threshold\"))\n\t\tid = COMP2;\n\telse\n\t\treturn -EINVAL;\n\n\tuVolt = comp_threshold_get(tps65910, id);\n\n\treturn sprintf(buf, \"%d\\n\", uVolt);\n}\n\nstatic DEVICE_ATTR(comp1_threshold, S_IRUGO, comp_threshold_show, NULL);\nstatic DEVICE_ATTR(comp2_threshold, S_IRUGO, comp_threshold_show, NULL);\n\nstatic int tps65911_comparator_probe(struct platform_device *pdev)\n{\n\tstruct tps65910 *tps65910 = dev_get_drvdata(pdev->dev.parent);\n\tstruct tps65910_board *pdata = dev_get_platdata(tps65910->dev);\n\tint ret;\n\n\tret = comp_threshold_set(tps65910, COMP1,  pdata->vmbch_threshold);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"cannot set COMP1 threshold\\n\");\n\t\treturn ret;\n\t}\n\n\tret = comp_threshold_set(tps65910, COMP2, pdata->vmbch2_threshold);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"cannot set COMP2 threshold\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = device_create_file(&pdev->dev, &dev_attr_comp1_threshold);\n\tif (ret < 0)\n\t\tdev_err(&pdev->dev, \"failed to add COMP1 sysfs file\\n\");\n\n\tret = device_create_file(&pdev->dev, &dev_attr_comp2_threshold);\n\tif (ret < 0)\n\t\tdev_err(&pdev->dev, \"failed to add COMP2 sysfs file\\n\");\n\n\treturn ret;\n}\n\nstatic int tps65911_comparator_remove(struct platform_device *pdev)\n{\n\tstruct tps65910 *tps65910;\n\n\ttps65910 = dev_get_drvdata(pdev->dev.parent);\n\tdevice_remove_file(&pdev->dev, &dev_attr_comp2_threshold);\n\tdevice_remove_file(&pdev->dev, &dev_attr_comp1_threshold);\n\n\treturn 0;\n}\n\nstatic struct platform_driver tps65911_comparator_driver = {\n\t.driver = {\n\t\t.name = \"tps65911-comparator\",\n\t},\n\t.probe = tps65911_comparator_probe,\n\t.remove = tps65911_comparator_remove,\n};\n\nstatic int __init tps65911_comparator_init(void)\n{\n\treturn platform_driver_register(&tps65911_comparator_driver);\n}\nsubsys_initcall(tps65911_comparator_init);\n\nstatic void __exit tps65911_comparator_exit(void)\n{\n\tplatform_driver_unregister(&tps65911_comparator_driver);\n}\nmodule_exit(tps65911_comparator_exit);\n\nMODULE_AUTHOR(\"Jorge Eduardo Candelaria <jedu@slimlogic.co.uk>\");\nMODULE_DESCRIPTION(\"TPS65911 comparator driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:tps65911-comparator\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}