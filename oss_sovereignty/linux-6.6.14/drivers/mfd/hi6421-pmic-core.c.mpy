{
  "module_name": "hi6421-pmic-core.c",
  "hash_id": "ec48a8e06e402224306c9f9669f48b3a05f51b55fa02f63d083e8d07431e7d9e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/hi6421-pmic-core.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/hi6421-pmic.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\nstatic const struct mfd_cell hi6421_devs[] = {\n\t{ .name = \"hi6421-regulator\", },\n};\n\nstatic const struct mfd_cell hi6421v530_devs[] = {\n\t{ .name = \"hi6421v530-regulator\", },\n};\n\nstatic const struct regmap_config hi6421_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 8,\n\t.max_register = HI6421_REG_TO_BUS_ADDR(HI6421_REG_MAX),\n};\n\nstatic const struct of_device_id of_hi6421_pmic_match[] = {\n\t{\n\t\t.compatible = \"hisilicon,hi6421-pmic\",\n\t\t.data = (void *)HI6421\n\t},\n\t{\n\t\t.compatible = \"hisilicon,hi6421v530-pmic\",\n\t\t.data = (void *)HI6421_V530\n\t},\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, of_hi6421_pmic_match);\n\nstatic int hi6421_pmic_probe(struct platform_device *pdev)\n{\n\tstruct hi6421_pmic *pmic;\n\tconst struct of_device_id *id;\n\tconst struct mfd_cell *subdevs;\n\tenum hi6421_type type;\n\tvoid __iomem *base;\n\tint n_subdevs, ret;\n\n\tid = of_match_device(of_hi6421_pmic_match, &pdev->dev);\n\tif (!id)\n\t\treturn -EINVAL;\n\ttype = (uintptr_t)id->data;\n\n\tpmic = devm_kzalloc(&pdev->dev, sizeof(*pmic), GFP_KERNEL);\n\tif (!pmic)\n\t\treturn -ENOMEM;\n\n\tbase = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tpmic->regmap = devm_regmap_init_mmio_clk(&pdev->dev, NULL, base,\n\t\t\t\t\t\t &hi6421_regmap_config);\n\tif (IS_ERR(pmic->regmap)) {\n\t\tdev_err(&pdev->dev, \"Failed to initialise Regmap: %ld\\n\",\n\t\t\t\t\t\tPTR_ERR(pmic->regmap));\n\t\treturn PTR_ERR(pmic->regmap);\n\t}\n\n\tplatform_set_drvdata(pdev, pmic);\n\n\tswitch (type) {\n\tcase HI6421:\n\t\t \n\t\tregmap_update_bits(pmic->regmap, HI6421_OCP_DEB_CTRL_REG,\n\t\t\t\t(HI6421_OCP_DEB_SEL_MASK\n\t\t\t\t | HI6421_OCP_EN_DEBOUNCE_MASK\n\t\t\t\t | HI6421_OCP_AUTO_STOP_MASK),\n\t\t\t\t(HI6421_OCP_DEB_SEL_8MS\n\t\t\t\t | HI6421_OCP_EN_DEBOUNCE_ENABLE));\n\n\t\tsubdevs = hi6421_devs;\n\t\tn_subdevs = ARRAY_SIZE(hi6421_devs);\n\t\tbreak;\n\tcase HI6421_V530:\n\t\tsubdevs = hi6421v530_devs;\n\t\tn_subdevs = ARRAY_SIZE(hi6421v530_devs);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"Unknown device type %d\\n\",\n\t\t\t\t\t\t(unsigned int)type);\n\t\treturn -EINVAL;\n\t}\n\n\tret = devm_mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t   subdevs, n_subdevs, NULL, 0, NULL);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to add child devices: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver hi6421_pmic_driver = {\n\t.driver = {\n\t\t.name = \"hi6421_pmic\",\n\t\t.of_match_table = of_hi6421_pmic_match,\n\t},\n\t.probe\t= hi6421_pmic_probe,\n};\nmodule_platform_driver(hi6421_pmic_driver);\n\nMODULE_AUTHOR(\"Guodong Xu <guodong.xu@linaro.org>\");\nMODULE_DESCRIPTION(\"Hi6421 PMIC driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}