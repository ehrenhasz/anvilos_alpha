{
  "module_name": "ocelot-core.c",
  "hash_id": "8307da6fb276dc40e1b22a4bae6f11af953dcd168d7a6da0fab56690c4ec9787",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/ocelot-core.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/device.h>\n#include <linux/export.h>\n#include <linux/iopoll.h>\n#include <linux/ioport.h>\n#include <linux/kernel.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/ocelot.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <linux/types.h>\n\n#include <soc/mscc/ocelot.h>\n\n#include \"ocelot.h\"\n\n#define REG_GCB_SOFT_RST\t\t0x0008\n\n#define BIT_SOFT_CHIP_RST\t\tBIT(0)\n\n#define VSC7512_MIIM0_RES_START\t\t0x7107009c\n#define VSC7512_MIIM1_RES_START\t\t0x710700c0\n#define VSC7512_MIIM_RES_SIZE\t\t0x00000024\n\n#define VSC7512_PHY_RES_START\t\t0x710700f0\n#define VSC7512_PHY_RES_SIZE\t\t0x00000004\n\n#define VSC7512_GPIO_RES_START\t\t0x71070034\n#define VSC7512_GPIO_RES_SIZE\t\t0x0000006c\n\n#define VSC7512_SIO_CTRL_RES_START\t0x710700f8\n#define VSC7512_SIO_CTRL_RES_SIZE\t0x00000100\n\n#define VSC7512_HSIO_RES_START\t\t0x710d0000\n#define VSC7512_HSIO_RES_SIZE\t\t0x00000128\n\n#define VSC7512_ANA_RES_START\t\t0x71880000\n#define VSC7512_ANA_RES_SIZE\t\t0x00010000\n\n#define VSC7512_QS_RES_START\t\t0x71080000\n#define VSC7512_QS_RES_SIZE\t\t0x00000100\n\n#define VSC7512_QSYS_RES_START\t\t0x71800000\n#define VSC7512_QSYS_RES_SIZE\t\t0x00200000\n\n#define VSC7512_REW_RES_START\t\t0x71030000\n#define VSC7512_REW_RES_SIZE\t\t0x00010000\n\n#define VSC7512_SYS_RES_START\t\t0x71010000\n#define VSC7512_SYS_RES_SIZE\t\t0x00010000\n\n#define VSC7512_S0_RES_START\t\t0x71040000\n#define VSC7512_S1_RES_START\t\t0x71050000\n#define VSC7512_S2_RES_START\t\t0x71060000\n#define VCAP_RES_SIZE\t\t\t0x00000400\n\n#define VSC7512_PORT_0_RES_START\t0x711e0000\n#define VSC7512_PORT_1_RES_START\t0x711f0000\n#define VSC7512_PORT_2_RES_START\t0x71200000\n#define VSC7512_PORT_3_RES_START\t0x71210000\n#define VSC7512_PORT_4_RES_START\t0x71220000\n#define VSC7512_PORT_5_RES_START\t0x71230000\n#define VSC7512_PORT_6_RES_START\t0x71240000\n#define VSC7512_PORT_7_RES_START\t0x71250000\n#define VSC7512_PORT_8_RES_START\t0x71260000\n#define VSC7512_PORT_9_RES_START\t0x71270000\n#define VSC7512_PORT_10_RES_START\t0x71280000\n#define VSC7512_PORT_RES_SIZE\t\t0x00010000\n\n#define VSC7512_GCB_RST_SLEEP_US\t100\n#define VSC7512_GCB_RST_TIMEOUT_US\t100000\n\nstatic int ocelot_gcb_chip_rst_status(struct ocelot_ddata *ddata)\n{\n\tint val, err;\n\n\terr = regmap_read(ddata->gcb_regmap, REG_GCB_SOFT_RST, &val);\n\tif (err)\n\t\treturn err;\n\n\treturn val;\n}\n\nint ocelot_chip_reset(struct device *dev)\n{\n\tstruct ocelot_ddata *ddata = dev_get_drvdata(dev);\n\tint ret, val;\n\n\t \n\tret = regmap_write(ddata->gcb_regmap, REG_GCB_SOFT_RST, BIT_SOFT_CHIP_RST);\n\tif (ret)\n\t\treturn ret;\n\n\treturn readx_poll_timeout(ocelot_gcb_chip_rst_status, ddata, val, !val,\n\t\t\t\t  VSC7512_GCB_RST_SLEEP_US, VSC7512_GCB_RST_TIMEOUT_US);\n}\nEXPORT_SYMBOL_NS(ocelot_chip_reset, MFD_OCELOT);\n\nstatic const struct resource vsc7512_miim0_resources[] = {\n\tDEFINE_RES_REG_NAMED(VSC7512_MIIM0_RES_START, VSC7512_MIIM_RES_SIZE, \"gcb_miim0\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PHY_RES_START, VSC7512_PHY_RES_SIZE, \"gcb_phy\"),\n};\n\nstatic const struct resource vsc7512_miim1_resources[] = {\n\tDEFINE_RES_REG_NAMED(VSC7512_MIIM1_RES_START, VSC7512_MIIM_RES_SIZE, \"gcb_miim1\"),\n};\n\nstatic const struct resource vsc7512_pinctrl_resources[] = {\n\tDEFINE_RES_REG_NAMED(VSC7512_GPIO_RES_START, VSC7512_GPIO_RES_SIZE, \"gcb_gpio\"),\n};\n\nstatic const struct resource vsc7512_sgpio_resources[] = {\n\tDEFINE_RES_REG_NAMED(VSC7512_SIO_CTRL_RES_START, VSC7512_SIO_CTRL_RES_SIZE, \"gcb_sio\"),\n};\n\nstatic const struct resource vsc7512_serdes_resources[] = {\n\tDEFINE_RES_REG_NAMED(VSC7512_HSIO_RES_START, VSC7512_HSIO_RES_SIZE, \"hsio\"),\n};\n\nstatic const struct resource vsc7512_switch_resources[] = {\n\tDEFINE_RES_REG_NAMED(VSC7512_ANA_RES_START, VSC7512_ANA_RES_SIZE, \"ana\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_HSIO_RES_START, VSC7512_HSIO_RES_SIZE, \"hsio\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_QS_RES_START, VSC7512_QS_RES_SIZE, \"qs\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_QSYS_RES_START, VSC7512_QSYS_RES_SIZE, \"qsys\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_REW_RES_START, VSC7512_REW_RES_SIZE, \"rew\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_SYS_RES_START, VSC7512_SYS_RES_SIZE, \"sys\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_S0_RES_START, VCAP_RES_SIZE, \"s0\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_S1_RES_START, VCAP_RES_SIZE, \"s1\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_S2_RES_START, VCAP_RES_SIZE, \"s2\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_0_RES_START, VSC7512_PORT_RES_SIZE, \"port0\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_1_RES_START, VSC7512_PORT_RES_SIZE, \"port1\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_2_RES_START, VSC7512_PORT_RES_SIZE, \"port2\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_3_RES_START, VSC7512_PORT_RES_SIZE, \"port3\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_4_RES_START, VSC7512_PORT_RES_SIZE, \"port4\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_5_RES_START, VSC7512_PORT_RES_SIZE, \"port5\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_6_RES_START, VSC7512_PORT_RES_SIZE, \"port6\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_7_RES_START, VSC7512_PORT_RES_SIZE, \"port7\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_8_RES_START, VSC7512_PORT_RES_SIZE, \"port8\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_9_RES_START, VSC7512_PORT_RES_SIZE, \"port9\"),\n\tDEFINE_RES_REG_NAMED(VSC7512_PORT_10_RES_START, VSC7512_PORT_RES_SIZE, \"port10\")\n};\n\nstatic const struct mfd_cell vsc7512_devs[] = {\n\t{\n\t\t.name = \"ocelot-pinctrl\",\n\t\t.of_compatible = \"mscc,ocelot-pinctrl\",\n\t\t.num_resources = ARRAY_SIZE(vsc7512_pinctrl_resources),\n\t\t.resources = vsc7512_pinctrl_resources,\n\t}, {\n\t\t.name = \"ocelot-sgpio\",\n\t\t.of_compatible = \"mscc,ocelot-sgpio\",\n\t\t.num_resources = ARRAY_SIZE(vsc7512_sgpio_resources),\n\t\t.resources = vsc7512_sgpio_resources,\n\t}, {\n\t\t.name = \"ocelot-miim0\",\n\t\t.of_compatible = \"mscc,ocelot-miim\",\n\t\t.of_reg = VSC7512_MIIM0_RES_START,\n\t\t.use_of_reg = true,\n\t\t.num_resources = ARRAY_SIZE(vsc7512_miim0_resources),\n\t\t.resources = vsc7512_miim0_resources,\n\t}, {\n\t\t.name = \"ocelot-miim1\",\n\t\t.of_compatible = \"mscc,ocelot-miim\",\n\t\t.of_reg = VSC7512_MIIM1_RES_START,\n\t\t.use_of_reg = true,\n\t\t.num_resources = ARRAY_SIZE(vsc7512_miim1_resources),\n\t\t.resources = vsc7512_miim1_resources,\n\t}, {\n\t\t.name = \"ocelot-serdes\",\n\t\t.of_compatible = \"mscc,vsc7514-serdes\",\n\t\t.num_resources = ARRAY_SIZE(vsc7512_serdes_resources),\n\t\t.resources = vsc7512_serdes_resources,\n\t}, {\n\t\t.name = \"ocelot-ext-switch\",\n\t\t.of_compatible = \"mscc,vsc7512-switch\",\n\t\t.num_resources = ARRAY_SIZE(vsc7512_switch_resources),\n\t\t.resources = vsc7512_switch_resources,\n\t},\n};\n\nstatic void ocelot_core_try_add_regmap(struct device *dev,\n\t\t\t\t       const struct resource *res)\n{\n\tif (dev_get_regmap(dev, res->name))\n\t\treturn;\n\n\tocelot_spi_init_regmap(dev, res);\n}\n\nstatic void ocelot_core_try_add_regmaps(struct device *dev,\n\t\t\t\t\tconst struct mfd_cell *cell)\n{\n\tint i;\n\n\tfor (i = 0; i < cell->num_resources; i++)\n\t\tocelot_core_try_add_regmap(dev, &cell->resources[i]);\n}\n\nint ocelot_core_init(struct device *dev)\n{\n\tint i, ndevs;\n\n\tndevs = ARRAY_SIZE(vsc7512_devs);\n\n\tfor (i = 0; i < ndevs; i++)\n\t\tocelot_core_try_add_regmaps(dev, &vsc7512_devs[i]);\n\n\treturn devm_mfd_add_devices(dev, PLATFORM_DEVID_AUTO, vsc7512_devs, ndevs, NULL, 0, NULL);\n}\nEXPORT_SYMBOL_NS(ocelot_core_init, MFD_OCELOT);\n\nMODULE_DESCRIPTION(\"Externally Controlled Ocelot Chip Driver\");\nMODULE_AUTHOR(\"Colin Foster <colin.foster@in-advantage.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(MFD_OCELOT_SPI);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}