{
  "module_name": "max8998-irq.c",
  "hash_id": "a9b957c4b4016a6944d1b28972aee8fa2a4a1a7876518293e6a352570221ff69",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max8998-irq.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/device.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqdomain.h>\n#include <linux/mfd/max8998-private.h>\n\nstruct max8998_irq_data {\n\tint reg;\n\tint mask;\n};\n\nstatic struct max8998_irq_data max8998_irqs[] = {\n\t[MAX8998_IRQ_DCINF] = {\n\t\t.reg = 1,\n\t\t.mask = MAX8998_IRQ_DCINF_MASK,\n\t},\n\t[MAX8998_IRQ_DCINR] = {\n\t\t.reg = 1,\n\t\t.mask = MAX8998_IRQ_DCINR_MASK,\n\t},\n\t[MAX8998_IRQ_JIGF] = {\n\t\t.reg = 1,\n\t\t.mask = MAX8998_IRQ_JIGF_MASK,\n\t},\n\t[MAX8998_IRQ_JIGR] = {\n\t\t.reg = 1,\n\t\t.mask = MAX8998_IRQ_JIGR_MASK,\n\t},\n\t[MAX8998_IRQ_PWRONF] = {\n\t\t.reg = 1,\n\t\t.mask = MAX8998_IRQ_PWRONF_MASK,\n\t},\n\t[MAX8998_IRQ_PWRONR] = {\n\t\t.reg = 1,\n\t\t.mask = MAX8998_IRQ_PWRONR_MASK,\n\t},\n\t[MAX8998_IRQ_WTSREVNT] = {\n\t\t.reg = 2,\n\t\t.mask = MAX8998_IRQ_WTSREVNT_MASK,\n\t},\n\t[MAX8998_IRQ_SMPLEVNT] = {\n\t\t.reg = 2,\n\t\t.mask = MAX8998_IRQ_SMPLEVNT_MASK,\n\t},\n\t[MAX8998_IRQ_ALARM1] = {\n\t\t.reg = 2,\n\t\t.mask = MAX8998_IRQ_ALARM1_MASK,\n\t},\n\t[MAX8998_IRQ_ALARM0] = {\n\t\t.reg = 2,\n\t\t.mask = MAX8998_IRQ_ALARM0_MASK,\n\t},\n\t[MAX8998_IRQ_ONKEY1S] = {\n\t\t.reg = 3,\n\t\t.mask = MAX8998_IRQ_ONKEY1S_MASK,\n\t},\n\t[MAX8998_IRQ_TOPOFFR] = {\n\t\t.reg = 3,\n\t\t.mask = MAX8998_IRQ_TOPOFFR_MASK,\n\t},\n\t[MAX8998_IRQ_DCINOVPR] = {\n\t\t.reg = 3,\n\t\t.mask = MAX8998_IRQ_DCINOVPR_MASK,\n\t},\n\t[MAX8998_IRQ_CHGRSTF] = {\n\t\t.reg = 3,\n\t\t.mask = MAX8998_IRQ_CHGRSTF_MASK,\n\t},\n\t[MAX8998_IRQ_DONER] = {\n\t\t.reg = 3,\n\t\t.mask = MAX8998_IRQ_DONER_MASK,\n\t},\n\t[MAX8998_IRQ_CHGFAULT] = {\n\t\t.reg = 3,\n\t\t.mask = MAX8998_IRQ_CHGFAULT_MASK,\n\t},\n\t[MAX8998_IRQ_LOBAT1] = {\n\t\t.reg = 4,\n\t\t.mask = MAX8998_IRQ_LOBAT1_MASK,\n\t},\n\t[MAX8998_IRQ_LOBAT2] = {\n\t\t.reg = 4,\n\t\t.mask = MAX8998_IRQ_LOBAT2_MASK,\n\t},\n};\n\nstatic inline struct max8998_irq_data *\nirq_to_max8998_irq(struct max8998_dev *max8998, struct irq_data *data)\n{\n\treturn &max8998_irqs[data->hwirq];\n}\n\nstatic void max8998_irq_lock(struct irq_data *data)\n{\n\tstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\n\n\tmutex_lock(&max8998->irqlock);\n}\n\nstatic void max8998_irq_sync_unlock(struct irq_data *data)\n{\n\tstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8998->irq_masks_cur); i++) {\n\t\t \n\t\tif (max8998->irq_masks_cur[i] != max8998->irq_masks_cache[i]) {\n\t\t\tmax8998->irq_masks_cache[i] = max8998->irq_masks_cur[i];\n\t\t\tmax8998_write_reg(max8998->i2c, MAX8998_REG_IRQM1 + i,\n\t\t\t\t\tmax8998->irq_masks_cur[i]);\n\t\t}\n\t}\n\n\tmutex_unlock(&max8998->irqlock);\n}\n\nstatic void max8998_irq_unmask(struct irq_data *data)\n{\n\tstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\n\tstruct max8998_irq_data *irq_data = irq_to_max8998_irq(max8998, data);\n\n\tmax8998->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\n}\n\nstatic void max8998_irq_mask(struct irq_data *data)\n{\n\tstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\n\tstruct max8998_irq_data *irq_data = irq_to_max8998_irq(max8998, data);\n\n\tmax8998->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\n}\n\nstatic struct irq_chip max8998_irq_chip = {\n\t.name = \"max8998\",\n\t.irq_bus_lock = max8998_irq_lock,\n\t.irq_bus_sync_unlock = max8998_irq_sync_unlock,\n\t.irq_mask = max8998_irq_mask,\n\t.irq_unmask = max8998_irq_unmask,\n};\n\nstatic irqreturn_t max8998_irq_thread(int irq, void *data)\n{\n\tstruct max8998_dev *max8998 = data;\n\tu8 irq_reg[MAX8998_NUM_IRQ_REGS];\n\tint ret;\n\tint i;\n\n\tret = max8998_bulk_read(max8998->i2c, MAX8998_REG_IRQ1,\n\t\t\tMAX8998_NUM_IRQ_REGS, irq_reg);\n\tif (ret < 0) {\n\t\tdev_err(max8998->dev, \"Failed to read interrupt register: %d\\n\",\n\t\t\t\tret);\n\t\treturn IRQ_NONE;\n\t}\n\n\t \n\tfor (i = 0; i < MAX8998_NUM_IRQ_REGS; i++)\n\t\tirq_reg[i] &= ~max8998->irq_masks_cur[i];\n\n\t \n\tfor (i = 0; i < MAX8998_IRQ_NR; i++) {\n\t\tif (irq_reg[max8998_irqs[i].reg - 1] & max8998_irqs[i].mask) {\n\t\t\tirq = irq_find_mapping(max8998->irq_domain, i);\n\t\t\tif (WARN_ON(!irq)) {\n\t\t\t\tdisable_irq_nosync(max8998->irq);\n\t\t\t\treturn IRQ_NONE;\n\t\t\t}\n\t\t\thandle_nested_irq(irq);\n\t\t}\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nint max8998_irq_resume(struct max8998_dev *max8998)\n{\n\tif (max8998->irq && max8998->irq_domain)\n\t\tmax8998_irq_thread(max8998->irq, max8998);\n\treturn 0;\n}\n\nstatic int max8998_irq_domain_map(struct irq_domain *d, unsigned int irq,\n\t\t\t\t\tirq_hw_number_t hw)\n{\n\tstruct max8997_dev *max8998 = d->host_data;\n\n\tirq_set_chip_data(irq, max8998);\n\tirq_set_chip_and_handler(irq, &max8998_irq_chip, handle_edge_irq);\n\tirq_set_nested_thread(irq, 1);\n\tirq_set_noprobe(irq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops max8998_irq_domain_ops = {\n\t.map = max8998_irq_domain_map,\n};\n\nint max8998_irq_init(struct max8998_dev *max8998)\n{\n\tint i;\n\tint ret;\n\tstruct irq_domain *domain;\n\n\tif (!max8998->irq) {\n\t\tdev_warn(max8998->dev,\n\t\t\t \"No interrupt specified, no interrupts\\n\");\n\t\treturn 0;\n\t}\n\n\tmutex_init(&max8998->irqlock);\n\n\t \n\tfor (i = 0; i < MAX8998_NUM_IRQ_REGS; i++) {\n\t\tmax8998->irq_masks_cur[i] = 0xff;\n\t\tmax8998->irq_masks_cache[i] = 0xff;\n\t\tmax8998_write_reg(max8998->i2c, MAX8998_REG_IRQM1 + i, 0xff);\n\t}\n\n\tmax8998_write_reg(max8998->i2c, MAX8998_REG_STATUSM1, 0xff);\n\tmax8998_write_reg(max8998->i2c, MAX8998_REG_STATUSM2, 0xff);\n\n\tdomain = irq_domain_add_simple(NULL, MAX8998_IRQ_NR,\n\t\t\tmax8998->irq_base, &max8998_irq_domain_ops, max8998);\n\tif (!domain) {\n\t\tdev_err(max8998->dev, \"could not create irq domain\\n\");\n\t\treturn -ENODEV;\n\t}\n\tmax8998->irq_domain = domain;\n\n\tret = request_threaded_irq(max8998->irq, NULL, max8998_irq_thread,\n\t\t\t\t   IRQF_TRIGGER_FALLING | IRQF_ONESHOT,\n\t\t\t\t   \"max8998-irq\", max8998);\n\tif (ret) {\n\t\tdev_err(max8998->dev, \"Failed to request IRQ %d: %d\\n\",\n\t\t\tmax8998->irq, ret);\n\t\treturn ret;\n\t}\n\n\tif (!max8998->ono)\n\t\treturn 0;\n\n\tret = request_threaded_irq(max8998->ono, NULL, max8998_irq_thread,\n\t\t\t\t   IRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\n\t\t\t\t   IRQF_ONESHOT, \"max8998-ono\", max8998);\n\tif (ret)\n\t\tdev_err(max8998->dev, \"Failed to request IRQ %d: %d\\n\",\n\t\t\tmax8998->ono, ret);\n\n\treturn 0;\n}\n\nvoid max8998_irq_exit(struct max8998_dev *max8998)\n{\n\tif (max8998->ono)\n\t\tfree_irq(max8998->ono, max8998);\n\n\tif (max8998->irq)\n\t\tfree_irq(max8998->irq, max8998);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}