{
  "module_name": "wl1273-core.c",
  "hash_id": "a8634c8fa70c57235208e2d4726cda8e64293b0fcff72b95146a249d684de3ce",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/wl1273-core.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/wl1273-core.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n\n#define DRIVER_DESC \"WL1273 FM Radio Core\"\n\nstatic const struct i2c_device_id wl1273_driver_id_table[] = {\n\t{ WL1273_FM_DRIVER_NAME, 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, wl1273_driver_id_table);\n\nstatic int wl1273_fm_read_reg(struct wl1273_core *core, u8 reg, u16 *value)\n{\n\tstruct i2c_client *client = core->client;\n\tu8 b[2];\n\tint r;\n\n\tr = i2c_smbus_read_i2c_block_data(client, reg, sizeof(b), b);\n\tif (r != 2) {\n\t\tdev_err(&client->dev, \"%s: Read: %d fails.\\n\", __func__, reg);\n\t\treturn -EREMOTEIO;\n\t}\n\n\t*value = (u16)b[0] << 8 | b[1];\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_write_cmd(struct wl1273_core *core, u8 cmd, u16 param)\n{\n\tstruct i2c_client *client = core->client;\n\tu8 buf[] = { (param >> 8) & 0xff, param & 0xff };\n\tint r;\n\n\tr = i2c_smbus_write_i2c_block_data(client, cmd, sizeof(buf), buf);\n\tif (r) {\n\t\tdev_err(&client->dev, \"%s: Cmd: %d fails.\\n\", __func__, cmd);\n\t\treturn r;\n\t}\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_write_data(struct wl1273_core *core, u8 *data, u16 len)\n{\n\tstruct i2c_client *client = core->client;\n\tstruct i2c_msg msg;\n\tint r;\n\n\tmsg.addr = client->addr;\n\tmsg.flags = 0;\n\tmsg.buf = data;\n\tmsg.len = len;\n\n\tr = i2c_transfer(client->adapter, &msg, 1);\n\tif (r != 1) {\n\t\tdev_err(&client->dev, \"%s: write error.\\n\", __func__);\n\t\treturn -EREMOTEIO;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int wl1273_fm_set_audio(struct wl1273_core *core, unsigned int new_mode)\n{\n\tint r = 0;\n\n\tif (core->mode == WL1273_MODE_OFF ||\n\t    core->mode == WL1273_MODE_SUSPENDED)\n\t\treturn -EPERM;\n\n\tif (core->mode == WL1273_MODE_RX && new_mode == WL1273_AUDIO_DIGITAL) {\n\t\tr = wl1273_fm_write_cmd(core, WL1273_PCM_MODE_SET,\n\t\t\t\t\tWL1273_PCM_DEF_MODE);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t\tr = wl1273_fm_write_cmd(core, WL1273_I2S_MODE_CONFIG_SET,\n\t\t\t\t\tcore->i2s_mode);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t\tr = wl1273_fm_write_cmd(core, WL1273_AUDIO_ENABLE,\n\t\t\t\t\tWL1273_AUDIO_ENABLE_I2S);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t} else if (core->mode == WL1273_MODE_RX &&\n\t\t   new_mode == WL1273_AUDIO_ANALOG) {\n\t\tr = wl1273_fm_write_cmd(core, WL1273_AUDIO_ENABLE,\n\t\t\t\t\tWL1273_AUDIO_ENABLE_ANALOG);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t} else if (core->mode == WL1273_MODE_TX &&\n\t\t   new_mode == WL1273_AUDIO_DIGITAL) {\n\t\tr = wl1273_fm_write_cmd(core, WL1273_I2S_MODE_CONFIG_SET,\n\t\t\t\t\tcore->i2s_mode);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t\tr = wl1273_fm_write_cmd(core, WL1273_AUDIO_IO_SET,\n\t\t\t\t\tWL1273_AUDIO_IO_SET_I2S);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t} else if (core->mode == WL1273_MODE_TX &&\n\t\t   new_mode == WL1273_AUDIO_ANALOG) {\n\t\tr = wl1273_fm_write_cmd(core, WL1273_AUDIO_IO_SET,\n\t\t\t\t\tWL1273_AUDIO_IO_SET_ANALOG);\n\t\tif (r)\n\t\t\tgoto out;\n\t}\n\n\tcore->audio_mode = new_mode;\nout:\n\treturn r;\n}\n\n \nstatic int wl1273_fm_set_volume(struct wl1273_core *core, unsigned int volume)\n{\n\tint r;\n\n\tif (volume > WL1273_MAX_VOLUME)\n\t\treturn -EINVAL;\n\n\tif (core->volume == volume)\n\t\treturn 0;\n\n\tr = wl1273_fm_write_cmd(core, WL1273_VOLUME_SET, volume);\n\tif (r)\n\t\treturn r;\n\n\tcore->volume = volume;\n\treturn 0;\n}\n\nstatic int wl1273_core_probe(struct i2c_client *client)\n{\n\tstruct wl1273_fm_platform_data *pdata = dev_get_platdata(&client->dev);\n\tstruct wl1273_core *core;\n\tstruct mfd_cell *cell;\n\tint children = 0;\n\tint r = 0;\n\n\tdev_dbg(&client->dev, \"%s\\n\", __func__);\n\n\tif (!pdata) {\n\t\tdev_err(&client->dev, \"No platform data.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (!(pdata->children & WL1273_RADIO_CHILD)) {\n\t\tdev_err(&client->dev, \"Cannot function without radio child.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tcore = devm_kzalloc(&client->dev, sizeof(*core), GFP_KERNEL);\n\tif (!core)\n\t\treturn -ENOMEM;\n\n\tcore->pdata = pdata;\n\tcore->client = client;\n\tmutex_init(&core->lock);\n\n\ti2c_set_clientdata(client, core);\n\n\tdev_dbg(&client->dev, \"%s: Have V4L2.\\n\", __func__);\n\n\tcell = &core->cells[children];\n\tcell->name = \"wl1273_fm_radio\";\n\tcell->platform_data = &core;\n\tcell->pdata_size = sizeof(core);\n\tchildren++;\n\n\tcore->read = wl1273_fm_read_reg;\n\tcore->write = wl1273_fm_write_cmd;\n\tcore->write_data = wl1273_fm_write_data;\n\tcore->set_audio = wl1273_fm_set_audio;\n\tcore->set_volume = wl1273_fm_set_volume;\n\n\tif (pdata->children & WL1273_CODEC_CHILD) {\n\t\tcell = &core->cells[children];\n\n\t\tdev_dbg(&client->dev, \"%s: Have codec.\\n\", __func__);\n\t\tcell->name = \"wl1273-codec\";\n\t\tcell->platform_data = &core;\n\t\tcell->pdata_size = sizeof(core);\n\t\tchildren++;\n\t}\n\n\tdev_dbg(&client->dev, \"%s: number of children: %d.\\n\",\n\t\t__func__, children);\n\n\tr = devm_mfd_add_devices(&client->dev, -1, core->cells,\n\t\t\t\t children, NULL, 0, NULL);\n\tif (r)\n\t\tgoto err;\n\n\treturn 0;\n\nerr:\n\tpdata->free_resources();\n\n\tdev_dbg(&client->dev, \"%s\\n\", __func__);\n\n\treturn r;\n}\n\nstatic struct i2c_driver wl1273_core_driver = {\n\t.driver = {\n\t\t.name = WL1273_FM_DRIVER_NAME,\n\t},\n\t.probe = wl1273_core_probe,\n\t.id_table = wl1273_driver_id_table,\n};\n\nstatic int __init wl1273_core_init(void)\n{\n\tint r;\n\n\tr = i2c_add_driver(&wl1273_core_driver);\n\tif (r) {\n\t\tpr_err(WL1273_FM_DRIVER_NAME\n\t\t       \": driver registration failed\\n\");\n\t\treturn r;\n\t}\n\n\treturn r;\n}\n\nstatic void __exit wl1273_core_exit(void)\n{\n\ti2c_del_driver(&wl1273_core_driver);\n}\nlate_initcall(wl1273_core_init);\nmodule_exit(wl1273_core_exit);\n\nMODULE_AUTHOR(\"Matti Aaltonen <matti.j.aaltonen@nokia.com>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}