{
  "module_name": "mxs-lradc.c",
  "hash_id": "f867db1880a2d74fcb63d3f5e058916b256fff4ec021b93a5700c9ebc62e8ced",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/mxs-lradc.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/mxs-lradc.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n#define ADC_CELL\t\t0\n#define TSC_CELL\t\t1\n#define RES_MEM\t\t\t0\n\nenum mx23_lradc_irqs {\n\tMX23_LRADC_TS_IRQ = 0,\n\tMX23_LRADC_CH0_IRQ,\n\tMX23_LRADC_CH1_IRQ,\n\tMX23_LRADC_CH2_IRQ,\n\tMX23_LRADC_CH3_IRQ,\n\tMX23_LRADC_CH4_IRQ,\n\tMX23_LRADC_CH5_IRQ,\n\tMX23_LRADC_CH6_IRQ,\n\tMX23_LRADC_CH7_IRQ,\n};\n\nenum mx28_lradc_irqs {\n\tMX28_LRADC_TS_IRQ = 0,\n\tMX28_LRADC_TRESH0_IRQ,\n\tMX28_LRADC_TRESH1_IRQ,\n\tMX28_LRADC_CH0_IRQ,\n\tMX28_LRADC_CH1_IRQ,\n\tMX28_LRADC_CH2_IRQ,\n\tMX28_LRADC_CH3_IRQ,\n\tMX28_LRADC_CH4_IRQ,\n\tMX28_LRADC_CH5_IRQ,\n\tMX28_LRADC_CH6_IRQ,\n\tMX28_LRADC_CH7_IRQ,\n\tMX28_LRADC_BUTTON0_IRQ,\n\tMX28_LRADC_BUTTON1_IRQ,\n};\n\nstatic struct resource mx23_adc_resources[] = {\n\tDEFINE_RES_MEM(0x0, 0x0),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH0_IRQ, \"mxs-lradc-channel0\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH1_IRQ, \"mxs-lradc-channel1\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH2_IRQ, \"mxs-lradc-channel2\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH3_IRQ, \"mxs-lradc-channel3\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH4_IRQ, \"mxs-lradc-channel4\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH5_IRQ, \"mxs-lradc-channel5\"),\n};\n\nstatic struct resource mx23_touchscreen_resources[] = {\n\tDEFINE_RES_MEM(0x0, 0x0),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_TS_IRQ, \"mxs-lradc-touchscreen\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH6_IRQ, \"mxs-lradc-channel6\"),\n\tDEFINE_RES_IRQ_NAMED(MX23_LRADC_CH7_IRQ, \"mxs-lradc-channel7\"),\n};\n\nstatic struct resource mx28_adc_resources[] = {\n\tDEFINE_RES_MEM(0x0, 0x0),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_TRESH0_IRQ, \"mxs-lradc-thresh0\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_TRESH1_IRQ, \"mxs-lradc-thresh1\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH0_IRQ, \"mxs-lradc-channel0\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH1_IRQ, \"mxs-lradc-channel1\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH2_IRQ, \"mxs-lradc-channel2\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH3_IRQ, \"mxs-lradc-channel3\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH4_IRQ, \"mxs-lradc-channel4\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH5_IRQ, \"mxs-lradc-channel5\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_BUTTON0_IRQ, \"mxs-lradc-button0\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_BUTTON1_IRQ, \"mxs-lradc-button1\"),\n};\n\nstatic struct resource mx28_touchscreen_resources[] = {\n\tDEFINE_RES_MEM(0x0, 0x0),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_TS_IRQ, \"mxs-lradc-touchscreen\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH6_IRQ, \"mxs-lradc-channel6\"),\n\tDEFINE_RES_IRQ_NAMED(MX28_LRADC_CH7_IRQ, \"mxs-lradc-channel7\"),\n};\n\nstatic struct mfd_cell mx23_cells[] = {\n\t{\n\t\t.name = \"mxs-lradc-adc\",\n\t\t.resources = mx23_adc_resources,\n\t\t.num_resources = ARRAY_SIZE(mx23_adc_resources),\n\t},\n\t{\n\t\t.name = \"mxs-lradc-ts\",\n\t\t.resources = mx23_touchscreen_resources,\n\t\t.num_resources = ARRAY_SIZE(mx23_touchscreen_resources),\n\t},\n};\n\nstatic struct mfd_cell mx28_cells[] = {\n\t{\n\t\t.name = \"mxs-lradc-adc\",\n\t\t.resources = mx28_adc_resources,\n\t\t.num_resources = ARRAY_SIZE(mx28_adc_resources),\n\t},\n\t{\n\t\t.name = \"mxs-lradc-ts\",\n\t\t.resources = mx28_touchscreen_resources,\n\t\t.num_resources = ARRAY_SIZE(mx28_touchscreen_resources),\n\t}\n};\n\nstatic const struct of_device_id mxs_lradc_dt_ids[] = {\n\t{ .compatible = \"fsl,imx23-lradc\", .data = (void *)IMX23_LRADC, },\n\t{ .compatible = \"fsl,imx28-lradc\", .data = (void *)IMX28_LRADC, },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, mxs_lradc_dt_ids);\n\nstatic int mxs_lradc_probe(struct platform_device *pdev)\n{\n\tconst struct of_device_id *of_id;\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *node = dev->of_node;\n\tstruct mxs_lradc *lradc;\n\tstruct mfd_cell *cells = NULL;\n\tstruct resource *res;\n\tint ret = 0;\n\tu32 ts_wires = 0;\n\n\tlradc = devm_kzalloc(&pdev->dev, sizeof(*lradc), GFP_KERNEL);\n\tif (!lradc)\n\t\treturn -ENOMEM;\n\n\tof_id = of_match_device(mxs_lradc_dt_ids, &pdev->dev);\n\tif (!of_id)\n\t\treturn -EINVAL;\n\n\tlradc->soc = (uintptr_t)of_id->data;\n\n\tlradc->clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(lradc->clk)) {\n\t\tdev_err(dev, \"Failed to get the delay unit clock\\n\");\n\t\treturn PTR_ERR(lradc->clk);\n\t}\n\n\tret = clk_prepare_enable(lradc->clk);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to enable the delay unit clock\\n\");\n\t\treturn ret;\n\t}\n\n\tret = of_property_read_u32(node, \"fsl,lradc-touchscreen-wires\",\n\t\t\t\t\t &ts_wires);\n\n\tif (!ret) {\n\t\tlradc->buffer_vchans = BUFFER_VCHANS_LIMITED;\n\n\t\tswitch (ts_wires) {\n\t\tcase 4:\n\t\t\tlradc->touchscreen_wire = MXS_LRADC_TOUCHSCREEN_4WIRE;\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\tif (lradc->soc == IMX28_LRADC) {\n\t\t\t\tlradc->touchscreen_wire =\n\t\t\t\t\tMXS_LRADC_TOUCHSCREEN_5WIRE;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfallthrough;\t \n\t\tdefault:\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Unsupported number of touchscreen wires (%d)\\n\"\n\t\t\t\t, ts_wires);\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_clk;\n\t\t}\n\t} else {\n\t\tlradc->buffer_vchans = BUFFER_VCHANS_ALL;\n\t}\n\n\tplatform_set_drvdata(pdev, lradc);\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res) {\n\t\tret = -ENOMEM;\n\t\tgoto err_clk;\n\t}\n\n\tswitch (lradc->soc) {\n\tcase IMX23_LRADC:\n\t\tmx23_adc_resources[RES_MEM] = *res;\n\t\tmx23_touchscreen_resources[RES_MEM] = *res;\n\t\tcells = mx23_cells;\n\t\tbreak;\n\tcase IMX28_LRADC:\n\t\tmx28_adc_resources[RES_MEM] = *res;\n\t\tmx28_touchscreen_resources[RES_MEM] = *res;\n\t\tcells = mx28_cells;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"Unsupported SoC\\n\");\n\t\tret = -ENODEV;\n\t\tgoto err_clk;\n\t}\n\n\tret = devm_mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t   &cells[ADC_CELL], 1, NULL, 0, NULL);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to add the ADC subdevice\\n\");\n\t\tgoto err_clk;\n\t}\n\n\tif (!lradc->touchscreen_wire)\n\t\treturn 0;\n\n\tret = devm_mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t   &cells[TSC_CELL], 1, NULL, 0, NULL);\n\tif (ret) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Failed to add the touchscreen subdevice\\n\");\n\t\tgoto err_clk;\n\t}\n\n\treturn 0;\n\nerr_clk:\n\tclk_disable_unprepare(lradc->clk);\n\n\treturn ret;\n}\n\nstatic int mxs_lradc_remove(struct platform_device *pdev)\n{\n\tstruct mxs_lradc *lradc = platform_get_drvdata(pdev);\n\n\tclk_disable_unprepare(lradc->clk);\n\n\treturn 0;\n}\n\nstatic struct platform_driver mxs_lradc_driver = {\n\t.driver = {\n\t\t.name = \"mxs-lradc\",\n\t\t.of_match_table = mxs_lradc_dt_ids,\n\t},\n\t.probe = mxs_lradc_probe,\n\t.remove = mxs_lradc_remove,\n};\nmodule_platform_driver(mxs_lradc_driver);\n\nMODULE_AUTHOR(\"Ksenija Stanojevic <ksenija.stanojevic@gmail.com>\");\nMODULE_DESCRIPTION(\"Freescale i.MX23/i.MX28 LRADC driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:mxs-lradc\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}