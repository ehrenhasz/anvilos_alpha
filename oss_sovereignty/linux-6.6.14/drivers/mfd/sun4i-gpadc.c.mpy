{
  "module_name": "sun4i-gpadc.c",
  "hash_id": "a5fdd673a653881a894daa54743e63dada42d8d2b8262b0b5034372628ad421d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/sun4i-gpadc.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/core.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/sun4i-gpadc.h>\n\n#define ARCH_SUN4I_A10 0\n#define ARCH_SUN5I_A13 1\n#define ARCH_SUN6I_A31 2\n\nstatic const struct resource adc_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(SUN4I_GPADC_IRQ_FIFO_DATA, \"FIFO_DATA_PENDING\"),\n\tDEFINE_RES_IRQ_NAMED(SUN4I_GPADC_IRQ_TEMP_DATA, \"TEMP_DATA_PENDING\"),\n};\n\nstatic const struct regmap_irq sun4i_gpadc_regmap_irq[] = {\n\tREGMAP_IRQ_REG(SUN4I_GPADC_IRQ_FIFO_DATA, 0,\n\t\t       SUN4I_GPADC_INT_FIFOC_TP_DATA_IRQ_EN),\n\tREGMAP_IRQ_REG(SUN4I_GPADC_IRQ_TEMP_DATA, 0,\n\t\t       SUN4I_GPADC_INT_FIFOC_TEMP_IRQ_EN),\n};\n\nstatic const struct regmap_irq_chip sun4i_gpadc_regmap_irq_chip = {\n\t.name = \"sun4i_gpadc_irq_chip\",\n\t.status_base = SUN4I_GPADC_INT_FIFOS,\n\t.ack_base = SUN4I_GPADC_INT_FIFOS,\n\t.unmask_base = SUN4I_GPADC_INT_FIFOC,\n\t.init_ack_masked = true,\n\t.irqs = sun4i_gpadc_regmap_irq,\n\t.num_irqs = ARRAY_SIZE(sun4i_gpadc_regmap_irq),\n\t.num_regs = 1,\n};\n\nstatic struct mfd_cell sun4i_gpadc_cells[] = {\n\t{\n\t\t.name\t= \"sun4i-a10-gpadc-iio\",\n\t\t.resources = adc_resources,\n\t\t.num_resources = ARRAY_SIZE(adc_resources),\n\t},\n\t{ .name = \"iio_hwmon\" }\n};\n\nstatic struct mfd_cell sun5i_gpadc_cells[] = {\n\t{\n\t\t.name\t= \"sun5i-a13-gpadc-iio\",\n\t\t.resources = adc_resources,\n\t\t.num_resources = ARRAY_SIZE(adc_resources),\n\t},\n\t{ .name = \"iio_hwmon\" },\n};\n\nstatic struct mfd_cell sun6i_gpadc_cells[] = {\n\t{\n\t\t.name\t= \"sun6i-a31-gpadc-iio\",\n\t\t.resources = adc_resources,\n\t\t.num_resources = ARRAY_SIZE(adc_resources),\n\t},\n\t{ .name = \"iio_hwmon\" },\n};\n\nstatic const struct regmap_config sun4i_gpadc_regmap_config = {\n\t.reg_bits = 32,\n\t.val_bits = 32,\n\t.reg_stride = 4,\n\t.fast_io = true,\n};\n\nstatic const struct of_device_id sun4i_gpadc_of_match[] = {\n\t{\n\t\t.compatible = \"allwinner,sun4i-a10-ts\",\n\t\t.data = (void *)ARCH_SUN4I_A10,\n\t}, {\n\t\t.compatible = \"allwinner,sun5i-a13-ts\",\n\t\t.data = (void *)ARCH_SUN5I_A13,\n\t}, {\n\t\t.compatible = \"allwinner,sun6i-a31-ts\",\n\t\t.data = (void *)ARCH_SUN6I_A31,\n\t}, {   }\n};\n\nMODULE_DEVICE_TABLE(of, sun4i_gpadc_of_match);\n\nstatic int sun4i_gpadc_probe(struct platform_device *pdev)\n{\n\tstruct sun4i_gpadc_dev *dev;\n\tconst struct of_device_id *of_id;\n\tconst struct mfd_cell *cells;\n\tunsigned int irq, size;\n\tint ret;\n\n\tof_id = of_match_node(sun4i_gpadc_of_match, pdev->dev.of_node);\n\tif (!of_id)\n\t\treturn -EINVAL;\n\n\tswitch ((long)of_id->data) {\n\tcase ARCH_SUN4I_A10:\n\t\tcells = sun4i_gpadc_cells;\n\t\tsize = ARRAY_SIZE(sun4i_gpadc_cells);\n\t\tbreak;\n\tcase ARCH_SUN5I_A13:\n\t\tcells = sun5i_gpadc_cells;\n\t\tsize = ARRAY_SIZE(sun5i_gpadc_cells);\n\t\tbreak;\n\tcase ARCH_SUN6I_A31:\n\t\tcells = sun6i_gpadc_cells;\n\t\tsize = ARRAY_SIZE(sun6i_gpadc_cells);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tdev = devm_kzalloc(&pdev->dev, sizeof(*dev), GFP_KERNEL);\n\tif (!dev)\n\t\treturn -ENOMEM;\n\n\tdev->base = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(dev->base))\n\t\treturn PTR_ERR(dev->base);\n\n\tdev->dev = &pdev->dev;\n\tdev_set_drvdata(dev->dev, dev);\n\n\tdev->regmap = devm_regmap_init_mmio(dev->dev, dev->base,\n\t\t\t\t\t    &sun4i_gpadc_regmap_config);\n\tif (IS_ERR(dev->regmap)) {\n\t\tret = PTR_ERR(dev->regmap);\n\t\tdev_err(&pdev->dev, \"failed to init regmap: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tregmap_write(dev->regmap, SUN4I_GPADC_INT_FIFOC, 0);\n\n\tirq = platform_get_irq(pdev, 0);\n\tret = devm_regmap_add_irq_chip(&pdev->dev, dev->regmap, irq,\n\t\t\t\t       IRQF_ONESHOT, 0,\n\t\t\t\t       &sun4i_gpadc_regmap_irq_chip,\n\t\t\t\t       &dev->regmap_irqc);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to add irq chip: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_mfd_add_devices(dev->dev, 0, cells, size, NULL, 0, NULL);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to add MFD devices: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver sun4i_gpadc_driver = {\n\t.driver = {\n\t\t.name = \"sun4i-gpadc\",\n\t\t.of_match_table = sun4i_gpadc_of_match,\n\t},\n\t.probe = sun4i_gpadc_probe,\n};\n\nmodule_platform_driver(sun4i_gpadc_driver);\n\nMODULE_DESCRIPTION(\"Allwinner sunxi platforms' GPADC MFD core driver\");\nMODULE_AUTHOR(\"Quentin Schulz <quentin.schulz@free-electrons.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}