{
  "module_name": "stmpe-spi.c",
  "hash_id": "f6e9e10d2735522b595d3476eb4454beb99706f1645c5ecc7de02659f9638698",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/stmpe-spi.c",
  "human_readable_source": "\n \n\n#include <linux/spi/spi.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/types.h>\n#include \"stmpe.h\"\n\n#define READ_CMD\t(1 << 7)\n\nstatic int spi_reg_read(struct stmpe *stmpe, u8 reg)\n{\n\tstruct spi_device *spi = stmpe->client;\n\tint status = spi_w8r16(spi, reg | READ_CMD);\n\n\treturn (status < 0) ? status : status >> 8;\n}\n\nstatic int spi_reg_write(struct stmpe *stmpe, u8 reg, u8 val)\n{\n\tstruct spi_device *spi = stmpe->client;\n\tu16 cmd = (val << 8) | reg;\n\n\treturn spi_write(spi, (const u8 *)&cmd, 2);\n}\n\nstatic int spi_block_read(struct stmpe *stmpe, u8 reg, u8 length, u8 *values)\n{\n\tint ret, i;\n\n\tfor (i = 0; i < length; i++) {\n\t\tret = spi_reg_read(stmpe, reg + i);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\t*(values + i) = ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int spi_block_write(struct stmpe *stmpe, u8 reg, u8 length,\n\t\tconst u8 *values)\n{\n\tint ret = 0, i;\n\n\tfor (i = length; i > 0; i--, reg++) {\n\t\tret = spi_reg_write(stmpe, reg, *(values + i - 1));\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic void spi_init(struct stmpe *stmpe)\n{\n\tstruct spi_device *spi = stmpe->client;\n\n\tspi->bits_per_word = 8;\n\n\t \n\tif (stmpe->variant->id_val == 0x0811)\n\t\tspi_reg_write(stmpe, STMPE811_REG_SPI_CFG, spi->mode);\n\n\tif (spi_setup(spi) < 0)\n\t\tdev_dbg(&spi->dev, \"spi_setup failed\\n\");\n}\n\nstatic struct stmpe_client_info spi_ci = {\n\t.read_byte = spi_reg_read,\n\t.write_byte = spi_reg_write,\n\t.read_block = spi_block_read,\n\t.write_block = spi_block_write,\n\t.init = spi_init,\n};\n\nstatic int\nstmpe_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\n\t \n\tif (spi->max_speed_hz > 1000000) {\n\t\tdev_dbg(&spi->dev, \"f(sample) %d KHz?\\n\",\n\t\t\t\t(spi->max_speed_hz/1000));\n\t\treturn -EINVAL;\n\t}\n\n\tspi_ci.irq = spi->irq;\n\tspi_ci.client = spi;\n\tspi_ci.dev = &spi->dev;\n\n\treturn stmpe_probe(&spi_ci, id->driver_data);\n}\n\nstatic void stmpe_spi_remove(struct spi_device *spi)\n{\n\tstruct stmpe *stmpe = spi_get_drvdata(spi);\n\n\tstmpe_remove(stmpe);\n}\n\nstatic const struct of_device_id stmpe_spi_of_match[] = {\n\t{ .compatible = \"st,stmpe610\", },\n\t{ .compatible = \"st,stmpe801\", },\n\t{ .compatible = \"st,stmpe811\", },\n\t{ .compatible = \"st,stmpe1601\", },\n\t{ .compatible = \"st,stmpe2401\", },\n\t{ .compatible = \"st,stmpe2403\", },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, stmpe_spi_of_match);\n\nstatic const struct spi_device_id stmpe_spi_id[] = {\n\t{ \"stmpe610\", STMPE610 },\n\t{ \"stmpe801\", STMPE801 },\n\t{ \"stmpe811\", STMPE811 },\n\t{ \"stmpe1601\", STMPE1601 },\n\t{ \"stmpe2401\", STMPE2401 },\n\t{ \"stmpe2403\", STMPE2403 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, stmpe_id);\n\nstatic struct spi_driver stmpe_spi_driver = {\n\t.driver = {\n\t\t.name\t= \"stmpe-spi\",\n\t\t.of_match_table = of_match_ptr(stmpe_spi_of_match),\n\t\t.pm\t= pm_sleep_ptr(&stmpe_dev_pm_ops),\n\t},\n\t.probe\t\t= stmpe_spi_probe,\n\t.remove\t\t= stmpe_spi_remove,\n\t.id_table\t= stmpe_spi_id,\n};\n\nstatic int __init stmpe_init(void)\n{\n\treturn spi_register_driver(&stmpe_spi_driver);\n}\nsubsys_initcall(stmpe_init);\n\nstatic void __exit stmpe_exit(void)\n{\n\tspi_unregister_driver(&stmpe_spi_driver);\n}\nmodule_exit(stmpe_exit);\n\nMODULE_DESCRIPTION(\"STMPE MFD SPI Interface Driver\");\nMODULE_AUTHOR(\"Viresh Kumar <vireshk@kernel.org>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}