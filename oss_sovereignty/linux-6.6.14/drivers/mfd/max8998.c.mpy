{
  "module_name": "max8998.c",
  "hash_id": "7d209988820c879eb19b675d1024181679331d7e8e78a71cd83888298f0a8577",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max8998.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/of.h>\n#include <linux/of_irq.h>\n#include <linux/pm_runtime.h>\n#include <linux/mutex.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max8998.h>\n#include <linux/mfd/max8998-private.h>\n\n#define RTC_I2C_ADDR\t\t(0x0c >> 1)\n\nstatic const struct mfd_cell max8998_devs[] = {\n\t{\n\t\t.name = \"max8998-pmic\",\n\t}, {\n\t\t.name = \"max8998-rtc\",\n\t}, {\n\t\t.name = \"max8998-battery\",\n\t},\n};\n\nstatic const struct mfd_cell lp3974_devs[] = {\n\t{\n\t\t.name = \"lp3974-pmic\",\n\t}, {\n\t\t.name = \"lp3974-rtc\",\n\t},\n};\n\nint max8998_read_reg(struct i2c_client *i2c, u8 reg, u8 *dest)\n{\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8998->iolock);\n\tret = i2c_smbus_read_byte_data(i2c, reg);\n\tmutex_unlock(&max8998->iolock);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret &= 0xff;\n\t*dest = ret;\n\treturn 0;\n}\nEXPORT_SYMBOL(max8998_read_reg);\n\nint max8998_bulk_read(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\n{\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8998->iolock);\n\tret = i2c_smbus_read_i2c_block_data(i2c, reg, count, buf);\n\tmutex_unlock(&max8998->iolock);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(max8998_bulk_read);\n\nint max8998_write_reg(struct i2c_client *i2c, u8 reg, u8 value)\n{\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8998->iolock);\n\tret = i2c_smbus_write_byte_data(i2c, reg, value);\n\tmutex_unlock(&max8998->iolock);\n\treturn ret;\n}\nEXPORT_SYMBOL(max8998_write_reg);\n\nint max8998_bulk_write(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\n{\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8998->iolock);\n\tret = i2c_smbus_write_i2c_block_data(i2c, reg, count, buf);\n\tmutex_unlock(&max8998->iolock);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(max8998_bulk_write);\n\nint max8998_update_reg(struct i2c_client *i2c, u8 reg, u8 val, u8 mask)\n{\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\tint ret;\n\n\tmutex_lock(&max8998->iolock);\n\tret = i2c_smbus_read_byte_data(i2c, reg);\n\tif (ret >= 0) {\n\t\tu8 old_val = ret & 0xff;\n\t\tu8 new_val = (val & mask) | (old_val & (~mask));\n\t\tret = i2c_smbus_write_byte_data(i2c, reg, new_val);\n\t}\n\tmutex_unlock(&max8998->iolock);\n\treturn ret;\n}\nEXPORT_SYMBOL(max8998_update_reg);\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id max8998_dt_match[] = {\n\t{ .compatible = \"maxim,max8998\", .data = (void *)TYPE_MAX8998 },\n\t{ .compatible = \"national,lp3974\", .data = (void *)TYPE_LP3974 },\n\t{ .compatible = \"ti,lp3974\", .data = (void *)TYPE_LP3974 },\n\t{},\n};\n#endif\n\n \nstatic struct max8998_platform_data *max8998_i2c_parse_dt_pdata(\n\t\t\t\t\t\t\tstruct device *dev)\n{\n\tstruct max8998_platform_data *pd;\n\n\tpd = devm_kzalloc(dev, sizeof(*pd), GFP_KERNEL);\n\tif (!pd)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpd->ono = irq_of_parse_and_map(dev->of_node, 1);\n\n\t \n\treturn pd;\n}\n\nstatic inline unsigned long max8998_i2c_get_driver_data(struct i2c_client *i2c,\n\t\t\t\t\t\tconst struct i2c_device_id *id)\n{\n\tif (i2c->dev.of_node)\n\t\treturn (unsigned long)of_device_get_match_data(&i2c->dev);\n\n\treturn id->driver_data;\n}\n\nstatic int max8998_i2c_probe(struct i2c_client *i2c)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(i2c);\n\tstruct max8998_platform_data *pdata = dev_get_platdata(&i2c->dev);\n\tstruct max8998_dev *max8998;\n\tint ret = 0;\n\n\tmax8998 = devm_kzalloc(&i2c->dev, sizeof(struct max8998_dev),\n\t\t\t\tGFP_KERNEL);\n\tif (max8998 == NULL)\n\t\treturn -ENOMEM;\n\n\tif (IS_ENABLED(CONFIG_OF) && i2c->dev.of_node) {\n\t\tpdata = max8998_i2c_parse_dt_pdata(&i2c->dev);\n\t\tif (IS_ERR(pdata))\n\t\t\treturn PTR_ERR(pdata);\n\t}\n\n\ti2c_set_clientdata(i2c, max8998);\n\tmax8998->dev = &i2c->dev;\n\tmax8998->i2c = i2c;\n\tmax8998->irq = i2c->irq;\n\tmax8998->type = max8998_i2c_get_driver_data(i2c, id);\n\tmax8998->pdata = pdata;\n\tif (pdata) {\n\t\tmax8998->ono = pdata->ono;\n\t\tmax8998->irq_base = pdata->irq_base;\n\t\tmax8998->wakeup = pdata->wakeup;\n\t}\n\tmutex_init(&max8998->iolock);\n\n\tmax8998->rtc = i2c_new_dummy_device(i2c->adapter, RTC_I2C_ADDR);\n\tif (IS_ERR(max8998->rtc)) {\n\t\tdev_err(&i2c->dev, \"Failed to allocate I2C device for RTC\\n\");\n\t\treturn PTR_ERR(max8998->rtc);\n\t}\n\ti2c_set_clientdata(max8998->rtc, max8998);\n\n\tmax8998_irq_init(max8998);\n\n\tpm_runtime_set_active(max8998->dev);\n\n\tswitch (max8998->type) {\n\tcase TYPE_LP3974:\n\t\tret = mfd_add_devices(max8998->dev, -1,\n\t\t\t\t      lp3974_devs, ARRAY_SIZE(lp3974_devs),\n\t\t\t\t      NULL, 0, NULL);\n\t\tbreak;\n\tcase TYPE_MAX8998:\n\t\tret = mfd_add_devices(max8998->dev, -1,\n\t\t\t\t      max8998_devs, ARRAY_SIZE(max8998_devs),\n\t\t\t\t      NULL, 0, NULL);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\tif (ret < 0)\n\t\tgoto err;\n\n\tdevice_init_wakeup(max8998->dev, max8998->wakeup);\n\n\treturn ret;\n\nerr:\n\tmfd_remove_devices(max8998->dev);\n\tmax8998_irq_exit(max8998);\n\ti2c_unregister_device(max8998->rtc);\n\treturn ret;\n}\n\nstatic const struct i2c_device_id max8998_i2c_id[] = {\n\t{ \"max8998\", TYPE_MAX8998 },\n\t{ \"lp3974\", TYPE_LP3974},\n\t{ }\n};\n\nstatic int max8998_suspend(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\n\tif (device_may_wakeup(dev))\n\t\tirq_set_irq_wake(max8998->irq, 1);\n\treturn 0;\n}\n\nstatic int max8998_resume(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tstruct max8998_dev *max8998 = i2c_get_clientdata(i2c);\n\n\tif (device_may_wakeup(dev))\n\t\tirq_set_irq_wake(max8998->irq, 0);\n\t \n\treturn max8998_irq_resume(i2c_get_clientdata(i2c));\n}\n\nstruct max8998_reg_dump {\n\tu8\taddr;\n\tu8\tval;\n};\n#define SAVE_ITEM(x)\t{ .addr = (x), .val = 0x0, }\nstatic struct max8998_reg_dump max8998_dump[] = {\n\tSAVE_ITEM(MAX8998_REG_IRQM1),\n\tSAVE_ITEM(MAX8998_REG_IRQM2),\n\tSAVE_ITEM(MAX8998_REG_IRQM3),\n\tSAVE_ITEM(MAX8998_REG_IRQM4),\n\tSAVE_ITEM(MAX8998_REG_STATUSM1),\n\tSAVE_ITEM(MAX8998_REG_STATUSM2),\n\tSAVE_ITEM(MAX8998_REG_CHGR1),\n\tSAVE_ITEM(MAX8998_REG_CHGR2),\n\tSAVE_ITEM(MAX8998_REG_LDO_ACTIVE_DISCHARGE1),\n\tSAVE_ITEM(MAX8998_REG_LDO_ACTIVE_DISCHARGE1),\n\tSAVE_ITEM(MAX8998_REG_BUCK_ACTIVE_DISCHARGE3),\n\tSAVE_ITEM(MAX8998_REG_ONOFF1),\n\tSAVE_ITEM(MAX8998_REG_ONOFF2),\n\tSAVE_ITEM(MAX8998_REG_ONOFF3),\n\tSAVE_ITEM(MAX8998_REG_ONOFF4),\n\tSAVE_ITEM(MAX8998_REG_BUCK1_VOLTAGE1),\n\tSAVE_ITEM(MAX8998_REG_BUCK1_VOLTAGE2),\n\tSAVE_ITEM(MAX8998_REG_BUCK1_VOLTAGE3),\n\tSAVE_ITEM(MAX8998_REG_BUCK1_VOLTAGE4),\n\tSAVE_ITEM(MAX8998_REG_BUCK2_VOLTAGE1),\n\tSAVE_ITEM(MAX8998_REG_BUCK2_VOLTAGE2),\n\tSAVE_ITEM(MAX8998_REG_LDO2_LDO3),\n\tSAVE_ITEM(MAX8998_REG_LDO4),\n\tSAVE_ITEM(MAX8998_REG_LDO5),\n\tSAVE_ITEM(MAX8998_REG_LDO6),\n\tSAVE_ITEM(MAX8998_REG_LDO7),\n\tSAVE_ITEM(MAX8998_REG_LDO8_LDO9),\n\tSAVE_ITEM(MAX8998_REG_LDO10_LDO11),\n\tSAVE_ITEM(MAX8998_REG_LDO12),\n\tSAVE_ITEM(MAX8998_REG_LDO13),\n\tSAVE_ITEM(MAX8998_REG_LDO14),\n\tSAVE_ITEM(MAX8998_REG_LDO15),\n\tSAVE_ITEM(MAX8998_REG_LDO16),\n\tSAVE_ITEM(MAX8998_REG_LDO17),\n\tSAVE_ITEM(MAX8998_REG_BKCHR),\n\tSAVE_ITEM(MAX8998_REG_LBCNFG1),\n\tSAVE_ITEM(MAX8998_REG_LBCNFG2),\n};\n \nstatic int max8998_freeze(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8998_dump); i++)\n\t\tmax8998_read_reg(i2c, max8998_dump[i].addr,\n\t\t\t\t&max8998_dump[i].val);\n\n\treturn 0;\n}\n\n \nstatic int max8998_restore(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8998_dump); i++)\n\t\tmax8998_write_reg(i2c, max8998_dump[i].addr,\n\t\t\t\tmax8998_dump[i].val);\n\n\treturn 0;\n}\n\nstatic const struct dev_pm_ops max8998_pm = {\n\t.suspend = max8998_suspend,\n\t.resume = max8998_resume,\n\t.freeze = max8998_freeze,\n\t.restore = max8998_restore,\n};\n\nstatic struct i2c_driver max8998_i2c_driver = {\n\t.driver = {\n\t\t   .name = \"max8998\",\n\t\t   .pm = &max8998_pm,\n\t\t   .suppress_bind_attrs = true,\n\t\t   .of_match_table = of_match_ptr(max8998_dt_match),\n\t},\n\t.probe = max8998_i2c_probe,\n\t.id_table = max8998_i2c_id,\n};\n\nstatic int __init max8998_i2c_init(void)\n{\n\treturn i2c_add_driver(&max8998_i2c_driver);\n}\n \nsubsys_initcall(max8998_i2c_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}