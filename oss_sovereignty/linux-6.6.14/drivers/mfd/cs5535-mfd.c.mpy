{
  "module_name": "cs5535-mfd.c",
  "hash_id": "20f011de97a3ccd056800025ddc5e7be4bac54ba4c0e91f0b1458490f5bb1f3e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/cs5535-mfd.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/mfd/core.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <asm/olpc.h>\n\n#define DRV_NAME \"cs5535-mfd\"\n\nenum cs5535_mfd_bars {\n\tSMB_BAR = 0,\n\tGPIO_BAR = 1,\n\tMFGPT_BAR = 2,\n\tPMS_BAR = 4,\n\tACPI_BAR = 5,\n\tNR_BARS,\n};\n\nstatic struct resource cs5535_mfd_resources[NR_BARS];\n\nstatic struct mfd_cell cs5535_mfd_cells[] = {\n\t{\n\t\t.name = \"cs5535-smb\",\n\t\t.num_resources = 1,\n\t\t.resources = &cs5535_mfd_resources[SMB_BAR],\n\t},\n\t{\n\t\t.name = \"cs5535-gpio\",\n\t\t.num_resources = 1,\n\t\t.resources = &cs5535_mfd_resources[GPIO_BAR],\n\t},\n\t{\n\t\t.name = \"cs5535-mfgpt\",\n\t\t.num_resources = 1,\n\t\t.resources = &cs5535_mfd_resources[MFGPT_BAR],\n\t},\n\t{\n\t\t.name = \"cs5535-pms\",\n\t\t.num_resources = 1,\n\t\t.resources = &cs5535_mfd_resources[PMS_BAR],\n\t},\n};\n\nstatic struct mfd_cell cs5535_olpc_mfd_cells[] = {\n\t{\n\t\t.name = \"olpc-xo1-pm-acpi\",\n\t\t.num_resources = 1,\n\t\t.resources = &cs5535_mfd_resources[ACPI_BAR],\n\t},\n\t{\n\t\t.name = \"olpc-xo1-sci-acpi\",\n\t\t.num_resources = 1,\n\t\t.resources = &cs5535_mfd_resources[ACPI_BAR],\n\t},\n};\n\nstatic int cs5535_mfd_probe(struct pci_dev *pdev,\n\t\tconst struct pci_device_id *id)\n{\n\tint err, bar;\n\n\terr = pci_enable_device(pdev);\n\tif (err)\n\t\treturn err;\n\n\tfor (bar = 0; bar < NR_BARS; bar++) {\n\t\tstruct resource *r = &cs5535_mfd_resources[bar];\n\n\t\tr->flags = IORESOURCE_IO;\n\t\tr->start = pci_resource_start(pdev, bar);\n\t\tr->end = pci_resource_end(pdev, bar);\n\t}\n\n\terr = pci_request_region(pdev, PMS_BAR, DRV_NAME);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to request PMS_BAR's IO region\\n\");\n\t\tgoto err_disable;\n\t}\n\n\terr = mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE, cs5535_mfd_cells,\n\t\t\t      ARRAY_SIZE(cs5535_mfd_cells), NULL, 0, NULL);\n\tif (err) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Failed to add CS5535 sub-devices: %d\\n\", err);\n\t\tgoto err_release_pms;\n\t}\n\n\tif (machine_is_olpc()) {\n\t\terr = pci_request_region(pdev, ACPI_BAR, DRV_NAME);\n\t\tif (err) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Failed to request ACPI_BAR's IO region\\n\");\n\t\t\tgoto err_remove_devices;\n\t\t}\n\n\t\terr = mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t      cs5535_olpc_mfd_cells,\n\t\t\t\t      ARRAY_SIZE(cs5535_olpc_mfd_cells),\n\t\t\t\t      NULL, 0, NULL);\n\t\tif (err) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Failed to add CS5535 OLPC sub-devices: %d\\n\",\n\t\t\t\terr);\n\t\t\tgoto err_release_acpi;\n\t\t}\n\t}\n\n\tdev_info(&pdev->dev, \"%zu devices registered.\\n\",\n\t\t\tARRAY_SIZE(cs5535_mfd_cells));\n\n\treturn 0;\n\nerr_release_acpi:\n\tpci_release_region(pdev, ACPI_BAR);\nerr_remove_devices:\n\tmfd_remove_devices(&pdev->dev);\nerr_release_pms:\n\tpci_release_region(pdev, PMS_BAR);\nerr_disable:\n\tpci_disable_device(pdev);\n\treturn err;\n}\n\nstatic void cs5535_mfd_remove(struct pci_dev *pdev)\n{\n\tmfd_remove_devices(&pdev->dev);\n\n\tif (machine_is_olpc())\n\t\tpci_release_region(pdev, ACPI_BAR);\n\n\tpci_release_region(pdev, PMS_BAR);\n\tpci_disable_device(pdev);\n}\n\nstatic const struct pci_device_id cs5535_mfd_pci_tbl[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_NS, PCI_DEVICE_ID_NS_CS5535_ISA) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_AMD, PCI_DEVICE_ID_AMD_CS5536_ISA) },\n\t{ 0, }\n};\nMODULE_DEVICE_TABLE(pci, cs5535_mfd_pci_tbl);\n\nstatic struct pci_driver cs5535_mfd_driver = {\n\t.name = DRV_NAME,\n\t.id_table = cs5535_mfd_pci_tbl,\n\t.probe = cs5535_mfd_probe,\n\t.remove = cs5535_mfd_remove,\n};\n\nmodule_pci_driver(cs5535_mfd_driver);\n\nMODULE_AUTHOR(\"Andres Salomon <dilinger@queued.net>\");\nMODULE_DESCRIPTION(\"MFD driver for CS5535/CS5536 southbridge's ISA PCI device\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}