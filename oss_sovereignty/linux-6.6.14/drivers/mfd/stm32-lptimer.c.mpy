{
  "module_name": "stm32-lptimer.c",
  "hash_id": "4858384431fee212ddb0d2a7435cccfac1bb062ed3af0e87619a957decc809bb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/stm32-lptimer.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/stm32-lptimer.h>\n#include <linux/module.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n\n#define STM32_LPTIM_MAX_REGISTER\t0x3fc\n\nstatic const struct regmap_config stm32_lptimer_regmap_cfg = {\n\t.reg_bits = 32,\n\t.val_bits = 32,\n\t.reg_stride = sizeof(u32),\n\t.max_register = STM32_LPTIM_MAX_REGISTER,\n\t.fast_io = true,\n};\n\nstatic int stm32_lptimer_detect_encoder(struct stm32_lptimer *ddata)\n{\n\tu32 val;\n\tint ret;\n\n\t \n\tret = regmap_update_bits(ddata->regmap, STM32_LPTIM_CFGR,\n\t\t\t\t STM32_LPTIM_ENC, STM32_LPTIM_ENC);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_read(ddata->regmap, STM32_LPTIM_CFGR, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_update_bits(ddata->regmap, STM32_LPTIM_CFGR,\n\t\t\t\t STM32_LPTIM_ENC, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tddata->has_encoder = !!(val & STM32_LPTIM_ENC);\n\n\treturn 0;\n}\n\nstatic int stm32_lptimer_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct stm32_lptimer *ddata;\n\tvoid __iomem *mmio;\n\tint ret;\n\n\tddata = devm_kzalloc(dev, sizeof(*ddata), GFP_KERNEL);\n\tif (!ddata)\n\t\treturn -ENOMEM;\n\n\tmmio = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(mmio))\n\t\treturn PTR_ERR(mmio);\n\n\tddata->regmap = devm_regmap_init_mmio_clk(dev, \"mux\", mmio,\n\t\t\t\t\t\t  &stm32_lptimer_regmap_cfg);\n\tif (IS_ERR(ddata->regmap))\n\t\treturn PTR_ERR(ddata->regmap);\n\n\tddata->clk = devm_clk_get(dev, NULL);\n\tif (IS_ERR(ddata->clk))\n\t\treturn PTR_ERR(ddata->clk);\n\n\tret = stm32_lptimer_detect_encoder(ddata);\n\tif (ret)\n\t\treturn ret;\n\n\tplatform_set_drvdata(pdev, ddata);\n\n\treturn devm_of_platform_populate(&pdev->dev);\n}\n\nstatic const struct of_device_id stm32_lptimer_of_match[] = {\n\t{ .compatible = \"st,stm32-lptimer\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, stm32_lptimer_of_match);\n\nstatic struct platform_driver stm32_lptimer_driver = {\n\t.probe = stm32_lptimer_probe,\n\t.driver = {\n\t\t.name = \"stm32-lptimer\",\n\t\t.of_match_table = stm32_lptimer_of_match,\n\t},\n};\nmodule_platform_driver(stm32_lptimer_driver);\n\nMODULE_AUTHOR(\"Fabrice Gasnier <fabrice.gasnier@st.com>\");\nMODULE_DESCRIPTION(\"STMicroelectronics STM32 Low-Power Timer\");\nMODULE_ALIAS(\"platform:stm32-lptimer\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}