{
  "module_name": "wcd934x.c",
  "hash_id": "cf2e34532d4cbf92b29addfb07d502675b645239689babb6828dbb5e7b3260a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/wcd934x.c",
  "human_readable_source": "\n\n\n#include <linux/clk.h>\n#include <linux/gpio/consumer.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/wcd934x/registers.h>\n#include <linux/mfd/wcd934x/wcd934x.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_irq.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slimbus.h>\n\n#define WCD934X_REGMAP_IRQ_REG(_irq, _off, _mask)\t\t\\\n\t[_irq] = {\t\t\t\t\t\t\\\n\t\t.reg_offset = (_off),\t\t\t\t\\\n\t\t.mask = (_mask),\t\t\t\t\\\n\t\t.type = {\t\t\t\t\t\\\n\t\t\t.type_reg_offset = (_off),\t\t\\\n\t\t\t.types_supported = IRQ_TYPE_EDGE_BOTH,\t\\\n\t\t\t.type_reg_mask  = (_mask),\t\t\\\n\t\t\t.type_level_low_val = (_mask),\t\t\\\n\t\t\t.type_level_high_val = (_mask),\t\t\\\n\t\t\t.type_falling_val = 0,\t\t\t\\\n\t\t\t.type_rising_val = 0,\t\t\t\\\n\t\t},\t\t\t\t\t\t\\\n\t}\n\nstatic const struct mfd_cell wcd934x_devices[] = {\n\t{\n\t\t.name = \"wcd934x-codec\",\n\t}, {\n\t\t.name = \"wcd934x-gpio\",\n\t\t.of_compatible = \"qcom,wcd9340-gpio\",\n\t}, {\n\t\t.name = \"wcd934x-soundwire\",\n\t\t.of_compatible = \"qcom,soundwire-v1.3.0\",\n\t},\n};\n\nstatic const struct regmap_irq wcd934x_irqs[] = {\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_SLIMBUS, 0, BIT(0)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_HPH_PA_OCPL_FAULT, 0, BIT(2)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_HPH_PA_OCPR_FAULT, 0, BIT(3)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_MBHC_SW_DET, 1, BIT(0)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_MBHC_ELECT_INS_REM_DET, 1, BIT(1)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_MBHC_BUTTON_PRESS_DET, 1, BIT(2)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_MBHC_BUTTON_RELEASE_DET, 1, BIT(3)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_MBHC_ELECT_INS_REM_LEG_DET, 1, BIT(4)),\n\tWCD934X_REGMAP_IRQ_REG(WCD934X_IRQ_SOUNDWIRE, 2, BIT(4)),\n};\n\nstatic const unsigned int wcd934x_config_regs[] = {\n\tWCD934X_INTR_LEVEL0,\n};\n\nstatic const struct regmap_irq_chip wcd934x_regmap_irq_chip = {\n\t.name = \"wcd934x_irq\",\n\t.status_base = WCD934X_INTR_PIN1_STATUS0,\n\t.mask_base = WCD934X_INTR_PIN1_MASK0,\n\t.ack_base = WCD934X_INTR_PIN1_CLEAR0,\n\t.num_regs = 4,\n\t.irqs = wcd934x_irqs,\n\t.num_irqs = ARRAY_SIZE(wcd934x_irqs),\n\t.config_base = wcd934x_config_regs,\n\t.num_config_bases = ARRAY_SIZE(wcd934x_config_regs),\n\t.num_config_regs = 4,\n\t.set_type_config = regmap_irq_set_type_config_simple,\n};\n\nstatic bool wcd934x_is_volatile_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase WCD934X_INTR_PIN1_STATUS0...WCD934X_INTR_PIN2_CLEAR3:\n\tcase WCD934X_SWR_AHB_BRIDGE_RD_DATA_0:\n\tcase WCD934X_SWR_AHB_BRIDGE_RD_DATA_1:\n\tcase WCD934X_SWR_AHB_BRIDGE_RD_DATA_2:\n\tcase WCD934X_SWR_AHB_BRIDGE_RD_DATA_3:\n\tcase WCD934X_SWR_AHB_BRIDGE_ACCESS_STATUS:\n\tcase WCD934X_ANA_MBHC_RESULT_3:\n\tcase WCD934X_ANA_MBHC_RESULT_2:\n\tcase WCD934X_ANA_MBHC_RESULT_1:\n\tcase WCD934X_ANA_MBHC_MECH:\n\tcase WCD934X_ANA_MBHC_ELECT:\n\tcase WCD934X_ANA_MBHC_ZDET:\n\tcase WCD934X_ANA_MICB2:\n\tcase WCD934X_ANA_RCO:\n\tcase WCD934X_ANA_BIAS:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n};\n\nstatic const struct regmap_range_cfg wcd934x_ranges[] = {\n\t{\t.name = \"WCD934X\",\n\t\t.range_min =  0x0,\n\t\t.range_max =  WCD934X_MAX_REGISTER,\n\t\t.selector_reg = WCD934X_SEL_REGISTER,\n\t\t.selector_mask = WCD934X_SEL_MASK,\n\t\t.selector_shift = WCD934X_SEL_SHIFT,\n\t\t.window_start = WCD934X_WINDOW_START,\n\t\t.window_len = WCD934X_WINDOW_LENGTH,\n\t},\n};\n\nstatic struct regmap_config wcd934x_regmap_config = {\n\t.reg_bits = 16,\n\t.val_bits = 8,\n\t.cache_type = REGCACHE_RBTREE,\n\t.max_register = 0xffff,\n\t.can_multi_write = true,\n\t.ranges = wcd934x_ranges,\n\t.num_ranges = ARRAY_SIZE(wcd934x_ranges),\n\t.volatile_reg = wcd934x_is_volatile_register,\n};\n\nstatic int wcd934x_bring_up(struct wcd934x_ddata *ddata)\n{\n\tstruct regmap *regmap = ddata->regmap;\n\tu16 id_minor, id_major;\n\tint ret;\n\n\tret = regmap_bulk_read(regmap, WCD934X_CHIP_TIER_CTRL_CHIP_ID_BYTE0,\n\t\t\t       (u8 *)&id_minor, sizeof(u16));\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_bulk_read(regmap, WCD934X_CHIP_TIER_CTRL_CHIP_ID_BYTE2,\n\t\t\t       (u8 *)&id_major, sizeof(u16));\n\tif (ret)\n\t\treturn ret;\n\n\tdev_info(ddata->dev, \"WCD934x chip id major 0x%x, minor 0x%x\\n\",\n\t\t id_major, id_minor);\n\n\tregmap_write(regmap, WCD934X_CODEC_RPM_RST_CTL, 0x01);\n\tregmap_write(regmap, WCD934X_SIDO_NEW_VOUT_A_STARTUP, 0x19);\n\tregmap_write(regmap, WCD934X_SIDO_NEW_VOUT_D_STARTUP, 0x15);\n\t \n\tusleep_range(1000, 1100);\n\tregmap_write(regmap, WCD934X_CODEC_RPM_PWR_CDC_DIG_HM_CTL, 0x5);\n\tregmap_write(regmap, WCD934X_CODEC_RPM_PWR_CDC_DIG_HM_CTL, 0x7);\n\tregmap_write(regmap, WCD934X_CODEC_RPM_RST_CTL, 0x3);\n\tregmap_write(regmap, WCD934X_CODEC_RPM_RST_CTL, 0x7);\n\tregmap_write(regmap, WCD934X_CODEC_RPM_PWR_CDC_DIG_HM_CTL, 0x3);\n\n\treturn 0;\n}\n\nstatic int wcd934x_slim_status_up(struct slim_device *sdev)\n{\n\tstruct device *dev = &sdev->dev;\n\tstruct wcd934x_ddata *ddata;\n\tint ret;\n\n\tddata = dev_get_drvdata(dev);\n\n\tddata->regmap = regmap_init_slimbus(sdev, &wcd934x_regmap_config);\n\tif (IS_ERR(ddata->regmap)) {\n\t\tdev_err(dev, \"Error allocating slim regmap\\n\");\n\t\treturn PTR_ERR(ddata->regmap);\n\t}\n\n\tret = wcd934x_bring_up(ddata);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to bring up WCD934X: err = %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_regmap_add_irq_chip(dev, ddata->regmap, ddata->irq,\n\t\t\t\t       IRQF_TRIGGER_HIGH, 0,\n\t\t\t\t       &wcd934x_regmap_irq_chip,\n\t\t\t\t       &ddata->irq_data);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add IRQ chip: err = %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = mfd_add_devices(dev, PLATFORM_DEVID_AUTO, wcd934x_devices,\n\t\t\t      ARRAY_SIZE(wcd934x_devices), NULL, 0, NULL);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to add child devices: err = %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic int wcd934x_slim_status(struct slim_device *sdev,\n\t\t\t       enum slim_device_status status)\n{\n\tswitch (status) {\n\tcase SLIM_DEVICE_STATUS_UP:\n\t\treturn wcd934x_slim_status_up(sdev);\n\tcase SLIM_DEVICE_STATUS_DOWN:\n\t\tmfd_remove_devices(&sdev->dev);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int wcd934x_slim_probe(struct slim_device *sdev)\n{\n\tstruct device *dev = &sdev->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct wcd934x_ddata *ddata;\n\tstruct gpio_desc *reset_gpio;\n\tint ret;\n\n\tddata = devm_kzalloc(dev, sizeof(*ddata), GFP_KERNEL);\n\tif (!ddata)\n\t\treturn\t-ENOMEM;\n\n\tddata->irq = of_irq_get(np, 0);\n\tif (ddata->irq < 0)\n\t\treturn dev_err_probe(ddata->dev, ddata->irq,\n\t\t\t\t     \"Failed to get IRQ\\n\");\n\n\tddata->extclk = devm_clk_get(dev, \"extclk\");\n\tif (IS_ERR(ddata->extclk))\n\t\treturn dev_err_probe(dev, PTR_ERR(ddata->extclk),\n\t\t\t\t     \"Failed to get extclk\");\n\n\tddata->supplies[0].supply = \"vdd-buck\";\n\tddata->supplies[1].supply = \"vdd-buck-sido\";\n\tddata->supplies[2].supply = \"vdd-tx\";\n\tddata->supplies[3].supply = \"vdd-rx\";\n\tddata->supplies[4].supply = \"vdd-io\";\n\n\tret = regulator_bulk_get(dev, WCD934X_MAX_SUPPLY, ddata->supplies);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get supplies\\n\");\n\n\tret = regulator_bulk_enable(WCD934X_MAX_SUPPLY, ddata->supplies);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to enable supplies\\n\");\n\n\t \n\tusleep_range(600, 650);\n\treset_gpio = devm_gpiod_get_optional(dev, \"reset\", GPIOD_OUT_LOW);\n\tif (IS_ERR(reset_gpio)) {\n\t\tret = dev_err_probe(dev, PTR_ERR(reset_gpio),\n\t\t\t\t    \"Failed to get reset gpio\\n\");\n\t\tgoto err_disable_regulators;\n\t}\n\tmsleep(20);\n\tgpiod_set_value(reset_gpio, 1);\n\tmsleep(20);\n\n\tddata->dev = dev;\n\tdev_set_drvdata(dev, ddata);\n\n\treturn 0;\n\nerr_disable_regulators:\n\tregulator_bulk_disable(WCD934X_MAX_SUPPLY, ddata->supplies);\n\treturn ret;\n}\n\nstatic void wcd934x_slim_remove(struct slim_device *sdev)\n{\n\tstruct wcd934x_ddata *ddata = dev_get_drvdata(&sdev->dev);\n\n\tregulator_bulk_disable(WCD934X_MAX_SUPPLY, ddata->supplies);\n\tmfd_remove_devices(&sdev->dev);\n}\n\nstatic const struct slim_device_id wcd934x_slim_id[] = {\n\t{ SLIM_MANF_ID_QCOM, SLIM_PROD_CODE_WCD9340,\n\t  SLIM_DEV_IDX_WCD9340, SLIM_DEV_INSTANCE_ID_WCD9340 },\n\t{}\n};\n\nstatic struct slim_driver wcd934x_slim_driver = {\n\t.driver = {\n\t\t.name = \"wcd934x-slim\",\n\t},\n\t.probe = wcd934x_slim_probe,\n\t.remove = wcd934x_slim_remove,\n\t.device_status = wcd934x_slim_status,\n\t.id_table = wcd934x_slim_id,\n};\n\nmodule_slim_driver(wcd934x_slim_driver);\nMODULE_DESCRIPTION(\"WCD934X slim driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"slim:217:250:*\");\nMODULE_AUTHOR(\"Srinivas Kandagatla <srinivas.kandagatla@linaro.org>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}