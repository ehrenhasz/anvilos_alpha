{
  "module_name": "da9062-core.c",
  "hash_id": "56d8ed65fb9b126ae59c21c00902b83e169754c1d1402ff580bfeb5cafd7c012",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/da9062-core.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/device.h>\n#include <linux/interrupt.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n#include <linux/irq.h>\n#include <linux/mfd/core.h>\n#include <linux/i2c.h>\n#include <linux/mfd/da9062/core.h>\n#include <linux/mfd/da9062/registers.h>\n#include <linux/regulator/of_regulator.h>\n\n#define\tDA9062_REG_EVENT_A_OFFSET\t0\n#define\tDA9062_REG_EVENT_B_OFFSET\t1\n#define\tDA9062_REG_EVENT_C_OFFSET\t2\n\n#define\tDA9062_IRQ_LOW\t0\n#define\tDA9062_IRQ_HIGH\t1\n\nstatic struct regmap_irq da9061_irqs[] = {\n\t \n\t[DA9061_IRQ_ONKEY] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_NONKEY_MASK,\n\t},\n\t[DA9061_IRQ_WDG_WARN] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_WDG_WARN_MASK,\n\t},\n\t[DA9061_IRQ_SEQ_RDY] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_SEQ_RDY_MASK,\n\t},\n\t \n\t[DA9061_IRQ_TEMP] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_TEMP_MASK,\n\t},\n\t[DA9061_IRQ_LDO_LIM] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_LDO_LIM_MASK,\n\t},\n\t[DA9061_IRQ_DVC_RDY] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_DVC_RDY_MASK,\n\t},\n\t[DA9061_IRQ_VDD_WARN] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_VDD_WARN_MASK,\n\t},\n\t \n\t[DA9061_IRQ_GPI0] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI0_MASK,\n\t},\n\t[DA9061_IRQ_GPI1] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI1_MASK,\n\t},\n\t[DA9061_IRQ_GPI2] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI2_MASK,\n\t},\n\t[DA9061_IRQ_GPI3] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI3_MASK,\n\t},\n\t[DA9061_IRQ_GPI4] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI4_MASK,\n\t},\n};\n\nstatic struct regmap_irq_chip da9061_irq_chip = {\n\t.name = \"da9061-irq\",\n\t.irqs = da9061_irqs,\n\t.num_irqs = DA9061_NUM_IRQ,\n\t.num_regs = 3,\n\t.status_base = DA9062AA_EVENT_A,\n\t.mask_base = DA9062AA_IRQ_MASK_A,\n\t.ack_base = DA9062AA_EVENT_A,\n};\n\nstatic struct regmap_irq da9062_irqs[] = {\n\t \n\t[DA9062_IRQ_ONKEY] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_NONKEY_MASK,\n\t},\n\t[DA9062_IRQ_ALARM] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_ALARM_MASK,\n\t},\n\t[DA9062_IRQ_TICK] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_TICK_MASK,\n\t},\n\t[DA9062_IRQ_WDG_WARN] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_WDG_WARN_MASK,\n\t},\n\t[DA9062_IRQ_SEQ_RDY] = {\n\t\t.reg_offset = DA9062_REG_EVENT_A_OFFSET,\n\t\t.mask = DA9062AA_M_SEQ_RDY_MASK,\n\t},\n\t \n\t[DA9062_IRQ_TEMP] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_TEMP_MASK,\n\t},\n\t[DA9062_IRQ_LDO_LIM] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_LDO_LIM_MASK,\n\t},\n\t[DA9062_IRQ_DVC_RDY] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_DVC_RDY_MASK,\n\t},\n\t[DA9062_IRQ_VDD_WARN] = {\n\t\t.reg_offset = DA9062_REG_EVENT_B_OFFSET,\n\t\t.mask = DA9062AA_M_VDD_WARN_MASK,\n\t},\n\t \n\t[DA9062_IRQ_GPI0] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI0_MASK,\n\t},\n\t[DA9062_IRQ_GPI1] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI1_MASK,\n\t},\n\t[DA9062_IRQ_GPI2] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI2_MASK,\n\t},\n\t[DA9062_IRQ_GPI3] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI3_MASK,\n\t},\n\t[DA9062_IRQ_GPI4] = {\n\t\t.reg_offset = DA9062_REG_EVENT_C_OFFSET,\n\t\t.mask = DA9062AA_M_GPI4_MASK,\n\t},\n};\n\nstatic struct regmap_irq_chip da9062_irq_chip = {\n\t.name = \"da9062-irq\",\n\t.irqs = da9062_irqs,\n\t.num_irqs = DA9062_NUM_IRQ,\n\t.num_regs = 3,\n\t.status_base = DA9062AA_EVENT_A,\n\t.mask_base = DA9062AA_IRQ_MASK_A,\n\t.ack_base = DA9062AA_EVENT_A,\n};\n\nstatic const struct resource da9061_core_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(DA9061_IRQ_VDD_WARN, \"VDD_WARN\"),\n};\n\nstatic const struct resource da9061_regulators_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(DA9061_IRQ_LDO_LIM, \"LDO_LIM\"),\n};\n\nstatic const struct resource da9061_thermal_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(DA9061_IRQ_TEMP, \"THERMAL\"),\n};\n\nstatic const struct resource da9061_wdt_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(DA9061_IRQ_WDG_WARN, \"WD_WARN\"),\n};\n\nstatic const struct resource da9061_onkey_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(DA9061_IRQ_ONKEY, \"ONKEY\"),\n};\n\nstatic const struct mfd_cell da9061_devs_irq[] = {\n\tMFD_CELL_OF(\"da9061-core\", da9061_core_resources, NULL, 0, 0,\n\t\t    NULL),\n\tMFD_CELL_OF(\"da9062-regulators\", da9061_regulators_resources, NULL, 0, 0,\n\t\t    NULL),\n\tMFD_CELL_OF(\"da9061-watchdog\", da9061_wdt_resources, NULL, 0, 0,\n\t\t    \"dlg,da9061-watchdog\"),\n\tMFD_CELL_OF(\"da9061-thermal\", da9061_thermal_resources, NULL, 0, 0,\n\t\t    \"dlg,da9061-thermal\"),\n\tMFD_CELL_OF(\"da9061-onkey\", da9061_onkey_resources, NULL, 0, 0,\n\t\t    \"dlg,da9061-onkey\"),\n};\n\nstatic const struct mfd_cell da9061_devs_noirq[] = {\n\tMFD_CELL_OF(\"da9061-core\", NULL, NULL, 0, 0, NULL),\n\tMFD_CELL_OF(\"da9062-regulators\", NULL, NULL, 0, 0, NULL),\n\tMFD_CELL_OF(\"da9061-watchdog\", NULL, NULL, 0, 0, \"dlg,da9061-watchdog\"),\n\tMFD_CELL_OF(\"da9061-thermal\", NULL, NULL, 0, 0, \"dlg,da9061-thermal\"),\n\tMFD_CELL_OF(\"da9061-onkey\", NULL, NULL, 0, 0, \"dlg,da9061-onkey\"),\n};\n\nstatic const struct resource da9062_core_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_VDD_WARN, 1, \"VDD_WARN\", IORESOURCE_IRQ),\n};\n\nstatic const struct resource da9062_regulators_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_LDO_LIM, 1, \"LDO_LIM\", IORESOURCE_IRQ),\n};\n\nstatic const struct resource da9062_thermal_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_TEMP, 1, \"THERMAL\", IORESOURCE_IRQ),\n};\n\nstatic const struct resource da9062_wdt_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_WDG_WARN, 1, \"WD_WARN\", IORESOURCE_IRQ),\n};\n\nstatic const struct resource da9062_rtc_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_ALARM, 1, \"ALARM\", IORESOURCE_IRQ),\n\tDEFINE_RES_NAMED(DA9062_IRQ_TICK, 1, \"TICK\", IORESOURCE_IRQ),\n};\n\nstatic const struct resource da9062_onkey_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_ONKEY, 1, \"ONKEY\", IORESOURCE_IRQ),\n};\n\nstatic const struct resource da9062_gpio_resources[] = {\n\tDEFINE_RES_NAMED(DA9062_IRQ_GPI0, 1, \"GPI0\", IORESOURCE_IRQ),\n\tDEFINE_RES_NAMED(DA9062_IRQ_GPI1, 1, \"GPI1\", IORESOURCE_IRQ),\n\tDEFINE_RES_NAMED(DA9062_IRQ_GPI2, 1, \"GPI2\", IORESOURCE_IRQ),\n\tDEFINE_RES_NAMED(DA9062_IRQ_GPI3, 1, \"GPI3\", IORESOURCE_IRQ),\n\tDEFINE_RES_NAMED(DA9062_IRQ_GPI4, 1, \"GPI4\", IORESOURCE_IRQ),\n};\n\nstatic const struct mfd_cell da9062_devs_irq[] = {\n\tMFD_CELL_OF(\"da9062-core\", da9062_core_resources, NULL, 0, 0,\n\t\t    NULL),\n\tMFD_CELL_OF(\"da9062-regulators\", da9062_regulators_resources, NULL, 0, 0,\n\t\t    NULL),\n\tMFD_CELL_OF(\"da9062-watchdog\", da9062_wdt_resources, NULL, 0, 0,\n\t\t    \"dlg,da9062-watchdog\"),\n\tMFD_CELL_OF(\"da9062-thermal\", da9062_thermal_resources, NULL, 0, 0,\n\t\t    \"dlg,da9062-thermal\"),\n\tMFD_CELL_OF(\"da9062-rtc\", da9062_rtc_resources, NULL, 0, 0,\n\t\t    \"dlg,da9062-rtc\"),\n\tMFD_CELL_OF(\"da9062-onkey\", da9062_onkey_resources, NULL, 0, 0,\n\t\t    \"dlg,da9062-onkey\"),\n\tMFD_CELL_OF(\"da9062-gpio\", da9062_gpio_resources, NULL, 0, 0,\n\t\t    \"dlg,da9062-gpio\"),\n};\n\nstatic const struct mfd_cell da9062_devs_noirq[] = {\n\tMFD_CELL_OF(\"da9062-core\", NULL, NULL, 0, 0, NULL),\n\tMFD_CELL_OF(\"da9062-regulators\", NULL, NULL, 0, 0, NULL),\n\tMFD_CELL_OF(\"da9062-watchdog\", NULL, NULL, 0, 0, \"dlg,da9062-watchdog\"),\n\tMFD_CELL_OF(\"da9062-thermal\", NULL, NULL, 0, 0, \"dlg,da9062-thermal\"),\n\tMFD_CELL_OF(\"da9062-rtc\", NULL, NULL, 0, 0, \"dlg,da9062-rtc\"),\n\tMFD_CELL_OF(\"da9062-onkey\", NULL, NULL, 0, 0, \"dlg,da9062-onkey\"),\n\tMFD_CELL_OF(\"da9062-gpio\", NULL, NULL, 0, 0, \"dlg,da9062-gpio\"),\n};\n\nstatic int da9062_clear_fault_log(struct da9062 *chip)\n{\n\tint ret;\n\tint fault_log;\n\n\tret = regmap_read(chip->regmap, DA9062AA_FAULT_LOG, &fault_log);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (fault_log) {\n\t\tif (fault_log & DA9062AA_TWD_ERROR_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: TWD_ERROR\\n\");\n\t\tif (fault_log & DA9062AA_POR_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: POR\\n\");\n\t\tif (fault_log & DA9062AA_VDD_FAULT_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: VDD_FAULT\\n\");\n\t\tif (fault_log & DA9062AA_VDD_START_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: VDD_START\\n\");\n\t\tif (fault_log & DA9062AA_TEMP_CRIT_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: TEMP_CRIT\\n\");\n\t\tif (fault_log & DA9062AA_KEY_RESET_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: KEY_RESET\\n\");\n\t\tif (fault_log & DA9062AA_NSHUTDOWN_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: NSHUTDOWN\\n\");\n\t\tif (fault_log & DA9062AA_WAIT_SHUT_MASK)\n\t\t\tdev_dbg(chip->dev, \"Fault log entry detected: WAIT_SHUT\\n\");\n\n\t\tret = regmap_write(chip->regmap, DA9062AA_FAULT_LOG,\n\t\t\t\t   fault_log);\n\t}\n\n\treturn ret;\n}\n\nstatic int da9062_get_device_type(struct da9062 *chip)\n{\n\tint device_id, variant_id, variant_mrc, variant_vrc;\n\tchar *type;\n\tint ret;\n\n\tret = regmap_read(chip->regmap, DA9062AA_DEVICE_ID, &device_id);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"Cannot read chip ID.\\n\");\n\t\treturn -EIO;\n\t}\n\tif (device_id != DA9062_PMIC_DEVICE_ID) {\n\t\tdev_err(chip->dev, \"Invalid device ID: 0x%02x\\n\", device_id);\n\t\treturn -ENODEV;\n\t}\n\n\tret = regmap_read(chip->regmap, DA9062AA_VARIANT_ID, &variant_id);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"Cannot read chip variant id.\\n\");\n\t\treturn -EIO;\n\t}\n\n\tvariant_vrc = (variant_id & DA9062AA_VRC_MASK) >> DA9062AA_VRC_SHIFT;\n\n\tswitch (variant_vrc) {\n\tcase DA9062_PMIC_VARIANT_VRC_DA9061:\n\t\ttype = \"DA9061\";\n\t\tbreak;\n\tcase DA9062_PMIC_VARIANT_VRC_DA9062:\n\t\ttype = \"DA9062\";\n\t\tbreak;\n\tdefault:\n\t\ttype = \"Unknown\";\n\t\tbreak;\n\t}\n\n\tdev_info(chip->dev,\n\t\t \"Device detected (device-ID: 0x%02X, var-ID: 0x%02X, %s)\\n\",\n\t\t device_id, variant_id, type);\n\n\tvariant_mrc = (variant_id & DA9062AA_MRC_MASK) >> DA9062AA_MRC_SHIFT;\n\n\tif (variant_mrc < DA9062_PMIC_VARIANT_MRC_AA) {\n\t\tdev_err(chip->dev,\n\t\t\t\"Cannot support variant MRC: 0x%02X\\n\", variant_mrc);\n\t\treturn -ENODEV;\n\t}\n\n\treturn ret;\n}\n\nstatic u32 da9062_configure_irq_type(struct da9062 *chip, int irq, u32 *trigger)\n{\n\tu32 irq_type = 0;\n\tstruct irq_data *irq_data = irq_get_irq_data(irq);\n\n\tif (!irq_data) {\n\t\tdev_err(chip->dev, \"Invalid IRQ: %d\\n\", irq);\n\t\treturn -EINVAL;\n\t}\n\t*trigger = irqd_get_trigger_type(irq_data);\n\n\tswitch (*trigger) {\n\tcase IRQ_TYPE_LEVEL_HIGH:\n\t\tirq_type = DA9062_IRQ_HIGH;\n\t\tbreak;\n\tcase IRQ_TYPE_LEVEL_LOW:\n\t\tirq_type = DA9062_IRQ_LOW;\n\t\tbreak;\n\tdefault:\n\t\tdev_warn(chip->dev, \"Unsupported IRQ type: %d\\n\", *trigger);\n\t\treturn -EINVAL;\n\t}\n\treturn regmap_update_bits(chip->regmap, DA9062AA_CONFIG_A,\n\t\t\tDA9062AA_IRQ_TYPE_MASK,\n\t\t\tirq_type << DA9062AA_IRQ_TYPE_SHIFT);\n}\n\nstatic const struct regmap_range da9061_aa_readable_ranges[] = {\n\tregmap_reg_range(DA9062AA_PAGE_CON, DA9062AA_STATUS_B),\n\tregmap_reg_range(DA9062AA_STATUS_D, DA9062AA_EVENT_C),\n\tregmap_reg_range(DA9062AA_IRQ_MASK_A, DA9062AA_IRQ_MASK_C),\n\tregmap_reg_range(DA9062AA_CONTROL_A, DA9062AA_GPIO_4),\n\tregmap_reg_range(DA9062AA_GPIO_WKUP_MODE, DA9062AA_GPIO_OUT3_4),\n\tregmap_reg_range(DA9062AA_BUCK1_CONT, DA9062AA_BUCK4_CONT),\n\tregmap_reg_range(DA9062AA_BUCK3_CONT, DA9062AA_BUCK3_CONT),\n\tregmap_reg_range(DA9062AA_LDO1_CONT, DA9062AA_LDO4_CONT),\n\tregmap_reg_range(DA9062AA_DVC_1, DA9062AA_DVC_1),\n\tregmap_reg_range(DA9062AA_SEQ, DA9062AA_ID_4_3),\n\tregmap_reg_range(DA9062AA_ID_12_11, DA9062AA_ID_16_15),\n\tregmap_reg_range(DA9062AA_ID_22_21, DA9062AA_ID_32_31),\n\tregmap_reg_range(DA9062AA_SEQ_A, DA9062AA_WAIT),\n\tregmap_reg_range(DA9062AA_RESET, DA9062AA_BUCK_ILIM_C),\n\tregmap_reg_range(DA9062AA_BUCK1_CFG, DA9062AA_BUCK3_CFG),\n\tregmap_reg_range(DA9062AA_VBUCK1_A, DA9062AA_VBUCK4_A),\n\tregmap_reg_range(DA9062AA_VBUCK3_A, DA9062AA_VBUCK3_A),\n\tregmap_reg_range(DA9062AA_VLDO1_A, DA9062AA_VLDO4_A),\n\tregmap_reg_range(DA9062AA_CONFIG_A, DA9062AA_CONFIG_A),\n\tregmap_reg_range(DA9062AA_VBUCK1_B, DA9062AA_VBUCK4_B),\n\tregmap_reg_range(DA9062AA_VBUCK3_B, DA9062AA_VBUCK3_B),\n\tregmap_reg_range(DA9062AA_VLDO1_B, DA9062AA_VLDO4_B),\n\tregmap_reg_range(DA9062AA_INTERFACE, DA9062AA_CONFIG_E),\n\tregmap_reg_range(DA9062AA_CONFIG_G, DA9062AA_CONFIG_K),\n\tregmap_reg_range(DA9062AA_CONFIG_M, DA9062AA_CONFIG_M),\n\tregmap_reg_range(DA9062AA_GP_ID_0, DA9062AA_GP_ID_19),\n\tregmap_reg_range(DA9062AA_DEVICE_ID, DA9062AA_CONFIG_ID),\n};\n\nstatic const struct regmap_range da9061_aa_writeable_ranges[] = {\n\tregmap_reg_range(DA9062AA_PAGE_CON, DA9062AA_PAGE_CON),\n\tregmap_reg_range(DA9062AA_FAULT_LOG, DA9062AA_EVENT_C),\n\tregmap_reg_range(DA9062AA_IRQ_MASK_A, DA9062AA_IRQ_MASK_C),\n\tregmap_reg_range(DA9062AA_CONTROL_A, DA9062AA_GPIO_4),\n\tregmap_reg_range(DA9062AA_GPIO_WKUP_MODE, DA9062AA_GPIO_OUT3_4),\n\tregmap_reg_range(DA9062AA_BUCK1_CONT, DA9062AA_BUCK4_CONT),\n\tregmap_reg_range(DA9062AA_BUCK3_CONT, DA9062AA_BUCK3_CONT),\n\tregmap_reg_range(DA9062AA_LDO1_CONT, DA9062AA_LDO4_CONT),\n\tregmap_reg_range(DA9062AA_DVC_1, DA9062AA_DVC_1),\n\tregmap_reg_range(DA9062AA_SEQ, DA9062AA_ID_4_3),\n\tregmap_reg_range(DA9062AA_ID_12_11, DA9062AA_ID_16_15),\n\tregmap_reg_range(DA9062AA_ID_22_21, DA9062AA_ID_32_31),\n\tregmap_reg_range(DA9062AA_SEQ_A, DA9062AA_WAIT),\n\tregmap_reg_range(DA9062AA_RESET, DA9062AA_BUCK_ILIM_C),\n\tregmap_reg_range(DA9062AA_BUCK1_CFG, DA9062AA_BUCK3_CFG),\n\tregmap_reg_range(DA9062AA_VBUCK1_A, DA9062AA_VBUCK4_A),\n\tregmap_reg_range(DA9062AA_VBUCK3_A, DA9062AA_VBUCK3_A),\n\tregmap_reg_range(DA9062AA_VLDO1_A, DA9062AA_VLDO4_A),\n\tregmap_reg_range(DA9062AA_CONFIG_A, DA9062AA_CONFIG_A),\n\tregmap_reg_range(DA9062AA_VBUCK1_B, DA9062AA_VBUCK4_B),\n\tregmap_reg_range(DA9062AA_VBUCK3_B, DA9062AA_VBUCK3_B),\n\tregmap_reg_range(DA9062AA_VLDO1_B, DA9062AA_VLDO4_B),\n\tregmap_reg_range(DA9062AA_CONFIG_J, DA9062AA_CONFIG_J),\n\tregmap_reg_range(DA9062AA_GP_ID_0, DA9062AA_GP_ID_19),\n};\n\nstatic const struct regmap_range da9061_aa_volatile_ranges[] = {\n\tregmap_reg_range(DA9062AA_PAGE_CON, DA9062AA_STATUS_B),\n\tregmap_reg_range(DA9062AA_STATUS_D, DA9062AA_EVENT_C),\n\tregmap_reg_range(DA9062AA_CONTROL_A, DA9062AA_CONTROL_B),\n\tregmap_reg_range(DA9062AA_CONTROL_E, DA9062AA_CONTROL_F),\n\tregmap_reg_range(DA9062AA_BUCK1_CONT, DA9062AA_BUCK4_CONT),\n\tregmap_reg_range(DA9062AA_BUCK3_CONT, DA9062AA_BUCK3_CONT),\n\tregmap_reg_range(DA9062AA_LDO1_CONT, DA9062AA_LDO4_CONT),\n\tregmap_reg_range(DA9062AA_DVC_1, DA9062AA_DVC_1),\n\tregmap_reg_range(DA9062AA_SEQ, DA9062AA_SEQ),\n};\n\nstatic const struct regmap_access_table da9061_aa_readable_table = {\n\t.yes_ranges = da9061_aa_readable_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(da9061_aa_readable_ranges),\n};\n\nstatic const struct regmap_access_table da9061_aa_writeable_table = {\n\t.yes_ranges = da9061_aa_writeable_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(da9061_aa_writeable_ranges),\n};\n\nstatic const struct regmap_access_table da9061_aa_volatile_table = {\n\t.yes_ranges = da9061_aa_volatile_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(da9061_aa_volatile_ranges),\n};\n\nstatic const struct regmap_range_cfg da9061_range_cfg[] = {\n\t{\n\t\t.range_min = DA9062AA_PAGE_CON,\n\t\t.range_max = DA9062AA_CONFIG_ID,\n\t\t.selector_reg = DA9062AA_PAGE_CON,\n\t\t.selector_mask = 1 << DA9062_I2C_PAGE_SEL_SHIFT,\n\t\t.selector_shift = DA9062_I2C_PAGE_SEL_SHIFT,\n\t\t.window_start = 0,\n\t\t.window_len = 256,\n\t}\n};\n\nstatic struct regmap_config da9061_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.ranges = da9061_range_cfg,\n\t.num_ranges = ARRAY_SIZE(da9061_range_cfg),\n\t.max_register = DA9062AA_CONFIG_ID,\n\t.cache_type = REGCACHE_RBTREE,\n\t.rd_table = &da9061_aa_readable_table,\n\t.wr_table = &da9061_aa_writeable_table,\n\t.volatile_table = &da9061_aa_volatile_table,\n};\n\nstatic const struct regmap_range da9062_aa_readable_ranges[] = {\n\tregmap_reg_range(DA9062AA_PAGE_CON, DA9062AA_STATUS_B),\n\tregmap_reg_range(DA9062AA_STATUS_D, DA9062AA_EVENT_C),\n\tregmap_reg_range(DA9062AA_IRQ_MASK_A, DA9062AA_IRQ_MASK_C),\n\tregmap_reg_range(DA9062AA_CONTROL_A, DA9062AA_GPIO_4),\n\tregmap_reg_range(DA9062AA_GPIO_WKUP_MODE, DA9062AA_BUCK4_CONT),\n\tregmap_reg_range(DA9062AA_BUCK3_CONT, DA9062AA_BUCK3_CONT),\n\tregmap_reg_range(DA9062AA_LDO1_CONT, DA9062AA_LDO4_CONT),\n\tregmap_reg_range(DA9062AA_DVC_1, DA9062AA_DVC_1),\n\tregmap_reg_range(DA9062AA_COUNT_S, DA9062AA_SECOND_D),\n\tregmap_reg_range(DA9062AA_SEQ, DA9062AA_ID_4_3),\n\tregmap_reg_range(DA9062AA_ID_12_11, DA9062AA_ID_16_15),\n\tregmap_reg_range(DA9062AA_ID_22_21, DA9062AA_ID_32_31),\n\tregmap_reg_range(DA9062AA_SEQ_A, DA9062AA_BUCK3_CFG),\n\tregmap_reg_range(DA9062AA_VBUCK2_A, DA9062AA_VBUCK4_A),\n\tregmap_reg_range(DA9062AA_VBUCK3_A, DA9062AA_VBUCK3_A),\n\tregmap_reg_range(DA9062AA_VLDO1_A, DA9062AA_VLDO4_A),\n\tregmap_reg_range(DA9062AA_VBUCK2_B, DA9062AA_VBUCK4_B),\n\tregmap_reg_range(DA9062AA_VBUCK3_B, DA9062AA_VBUCK3_B),\n\tregmap_reg_range(DA9062AA_VLDO1_B, DA9062AA_VLDO4_B),\n\tregmap_reg_range(DA9062AA_BBAT_CONT, DA9062AA_BBAT_CONT),\n\tregmap_reg_range(DA9062AA_INTERFACE, DA9062AA_CONFIG_E),\n\tregmap_reg_range(DA9062AA_CONFIG_G, DA9062AA_CONFIG_K),\n\tregmap_reg_range(DA9062AA_CONFIG_M, DA9062AA_CONFIG_M),\n\tregmap_reg_range(DA9062AA_TRIM_CLDR, DA9062AA_GP_ID_19),\n\tregmap_reg_range(DA9062AA_DEVICE_ID, DA9062AA_CONFIG_ID),\n};\n\nstatic const struct regmap_range da9062_aa_writeable_ranges[] = {\n\tregmap_reg_range(DA9062AA_PAGE_CON, DA9062AA_PAGE_CON),\n\tregmap_reg_range(DA9062AA_FAULT_LOG, DA9062AA_EVENT_C),\n\tregmap_reg_range(DA9062AA_IRQ_MASK_A, DA9062AA_IRQ_MASK_C),\n\tregmap_reg_range(DA9062AA_CONTROL_A, DA9062AA_GPIO_4),\n\tregmap_reg_range(DA9062AA_GPIO_WKUP_MODE, DA9062AA_BUCK4_CONT),\n\tregmap_reg_range(DA9062AA_BUCK3_CONT, DA9062AA_BUCK3_CONT),\n\tregmap_reg_range(DA9062AA_LDO1_CONT, DA9062AA_LDO4_CONT),\n\tregmap_reg_range(DA9062AA_DVC_1, DA9062AA_DVC_1),\n\tregmap_reg_range(DA9062AA_COUNT_S, DA9062AA_ALARM_Y),\n\tregmap_reg_range(DA9062AA_SEQ, DA9062AA_ID_4_3),\n\tregmap_reg_range(DA9062AA_ID_12_11, DA9062AA_ID_16_15),\n\tregmap_reg_range(DA9062AA_ID_22_21, DA9062AA_ID_32_31),\n\tregmap_reg_range(DA9062AA_SEQ_A, DA9062AA_BUCK3_CFG),\n\tregmap_reg_range(DA9062AA_VBUCK2_A, DA9062AA_VBUCK4_A),\n\tregmap_reg_range(DA9062AA_VBUCK3_A, DA9062AA_VBUCK3_A),\n\tregmap_reg_range(DA9062AA_VLDO1_A, DA9062AA_VLDO4_A),\n\tregmap_reg_range(DA9062AA_VBUCK2_B, DA9062AA_VBUCK4_B),\n\tregmap_reg_range(DA9062AA_VBUCK3_B, DA9062AA_VBUCK3_B),\n\tregmap_reg_range(DA9062AA_VLDO1_B, DA9062AA_VLDO4_B),\n\tregmap_reg_range(DA9062AA_BBAT_CONT, DA9062AA_BBAT_CONT),\n\tregmap_reg_range(DA9062AA_CONFIG_J, DA9062AA_CONFIG_J),\n\tregmap_reg_range(DA9062AA_GP_ID_0, DA9062AA_GP_ID_19),\n};\n\nstatic const struct regmap_range da9062_aa_volatile_ranges[] = {\n\tregmap_reg_range(DA9062AA_PAGE_CON, DA9062AA_STATUS_B),\n\tregmap_reg_range(DA9062AA_STATUS_D, DA9062AA_EVENT_C),\n\tregmap_reg_range(DA9062AA_CONTROL_A, DA9062AA_CONTROL_B),\n\tregmap_reg_range(DA9062AA_CONTROL_E, DA9062AA_CONTROL_F),\n\tregmap_reg_range(DA9062AA_BUCK2_CONT, DA9062AA_BUCK4_CONT),\n\tregmap_reg_range(DA9062AA_BUCK3_CONT, DA9062AA_BUCK3_CONT),\n\tregmap_reg_range(DA9062AA_LDO1_CONT, DA9062AA_LDO4_CONT),\n\tregmap_reg_range(DA9062AA_DVC_1, DA9062AA_DVC_1),\n\tregmap_reg_range(DA9062AA_COUNT_S, DA9062AA_SECOND_D),\n\tregmap_reg_range(DA9062AA_SEQ, DA9062AA_SEQ),\n\tregmap_reg_range(DA9062AA_EN_32K, DA9062AA_EN_32K),\n};\n\nstatic const struct regmap_access_table da9062_aa_readable_table = {\n\t.yes_ranges = da9062_aa_readable_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(da9062_aa_readable_ranges),\n};\n\nstatic const struct regmap_access_table da9062_aa_writeable_table = {\n\t.yes_ranges = da9062_aa_writeable_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(da9062_aa_writeable_ranges),\n};\n\nstatic const struct regmap_access_table da9062_aa_volatile_table = {\n\t.yes_ranges = da9062_aa_volatile_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(da9062_aa_volatile_ranges),\n};\n\nstatic const struct regmap_range_cfg da9062_range_cfg[] = {\n\t{\n\t\t.range_min = DA9062AA_PAGE_CON,\n\t\t.range_max = DA9062AA_CONFIG_ID,\n\t\t.selector_reg = DA9062AA_PAGE_CON,\n\t\t.selector_mask = 1 << DA9062_I2C_PAGE_SEL_SHIFT,\n\t\t.selector_shift = DA9062_I2C_PAGE_SEL_SHIFT,\n\t\t.window_start = 0,\n\t\t.window_len = 256,\n\t}\n};\n\nstatic struct regmap_config da9062_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.ranges = da9062_range_cfg,\n\t.num_ranges = ARRAY_SIZE(da9062_range_cfg),\n\t.max_register = DA9062AA_CONFIG_ID,\n\t.cache_type = REGCACHE_RBTREE,\n\t.rd_table = &da9062_aa_readable_table,\n\t.wr_table = &da9062_aa_writeable_table,\n\t.volatile_table = &da9062_aa_volatile_table,\n};\n\nstatic const struct of_device_id da9062_dt_ids[] = {\n\t{ .compatible = \"dlg,da9061\", .data = (void *)COMPAT_TYPE_DA9061, },\n\t{ .compatible = \"dlg,da9062\", .data = (void *)COMPAT_TYPE_DA9062, },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, da9062_dt_ids);\n\nstatic int da9062_i2c_probe(struct i2c_client *i2c)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(i2c);\n\tstruct da9062 *chip;\n\tunsigned int irq_base = 0;\n\tconst struct mfd_cell *cell;\n\tconst struct regmap_irq_chip *irq_chip;\n\tconst struct regmap_config *config;\n\tint cell_num;\n\tu32 trigger_type = 0;\n\tint ret;\n\n\tchip = devm_kzalloc(&i2c->dev, sizeof(*chip), GFP_KERNEL);\n\tif (!chip)\n\t\treturn -ENOMEM;\n\n\tif (i2c->dev.of_node)\n\t\tchip->chip_type = (uintptr_t)of_device_get_match_data(&i2c->dev);\n\telse\n\t\tchip->chip_type = id->driver_data;\n\n\ti2c_set_clientdata(i2c, chip);\n\tchip->dev = &i2c->dev;\n\n\t \n\tswitch (chip->chip_type) {\n\tcase COMPAT_TYPE_DA9061:\n\t\tcell = da9061_devs_noirq;\n\t\tcell_num = ARRAY_SIZE(da9061_devs_noirq);\n\t\tconfig = &da9061_regmap_config;\n\t\tbreak;\n\tcase COMPAT_TYPE_DA9062:\n\t\tcell = da9062_devs_noirq;\n\t\tcell_num = ARRAY_SIZE(da9062_devs_noirq);\n\t\tconfig = &da9062_regmap_config;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(chip->dev, \"Unrecognised chip type\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tchip->regmap = devm_regmap_init_i2c(i2c, config);\n\tif (IS_ERR(chip->regmap)) {\n\t\tret = PTR_ERR(chip->regmap);\n\t\tdev_err(chip->dev, \"Failed to allocate register map: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\t \n\tif (i2c_check_functionality(i2c->adapter, I2C_FUNC_I2C)) {\n\t\tdev_info(chip->dev, \"Entering I2C mode!\\n\");\n\t\tret = regmap_clear_bits(chip->regmap, DA9062AA_CONFIG_J,\n\t\t\t\t\tDA9062AA_TWOWIRE_TO_MASK);\n\t\tif (ret < 0) {\n\t\t\tdev_err(chip->dev, \"Failed to set Two-Wire Bus Mode.\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = da9062_clear_fault_log(chip);\n\tif (ret < 0)\n\t\tdev_warn(chip->dev, \"Cannot clear fault log\\n\");\n\n\tret = da9062_get_device_type(chip);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (i2c->irq) {\n\t\tif (chip->chip_type == COMPAT_TYPE_DA9061) {\n\t\t\tcell = da9061_devs_irq;\n\t\t\tcell_num = ARRAY_SIZE(da9061_devs_irq);\n\t\t\tirq_chip = &da9061_irq_chip;\n\t\t} else {\n\t\t\tcell = da9062_devs_irq;\n\t\t\tcell_num = ARRAY_SIZE(da9062_devs_irq);\n\t\t\tirq_chip = &da9062_irq_chip;\n\t\t}\n\n\t\tret = da9062_configure_irq_type(chip, i2c->irq, &trigger_type);\n\t\tif (ret < 0) {\n\t\t\tdev_err(chip->dev, \"Failed to configure IRQ type\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = regmap_add_irq_chip(chip->regmap, i2c->irq,\n\t\t\t\t\t  trigger_type | IRQF_SHARED | IRQF_ONESHOT,\n\t\t\t\t\t  -1, irq_chip, &chip->regmap_irq);\n\t\tif (ret) {\n\t\t\tdev_err(chip->dev, \"Failed to request IRQ %d: %d\\n\",\n\t\t\t\ti2c->irq, ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tirq_base = regmap_irq_chip_get_base(chip->regmap_irq);\n\t}\n\n\tret = mfd_add_devices(chip->dev, PLATFORM_DEVID_NONE, cell,\n\t\t\t      cell_num, NULL, irq_base,\n\t\t\t      NULL);\n\tif (ret) {\n\t\tdev_err(chip->dev, \"Cannot register child devices\\n\");\n\t\tif (i2c->irq)\n\t\t\tregmap_del_irq_chip(i2c->irq, chip->regmap_irq);\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic void da9062_i2c_remove(struct i2c_client *i2c)\n{\n\tstruct da9062 *chip = i2c_get_clientdata(i2c);\n\n\tmfd_remove_devices(chip->dev);\n\tregmap_del_irq_chip(i2c->irq, chip->regmap_irq);\n}\n\nstatic const struct i2c_device_id da9062_i2c_id[] = {\n\t{ \"da9061\", COMPAT_TYPE_DA9061 },\n\t{ \"da9062\", COMPAT_TYPE_DA9062 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(i2c, da9062_i2c_id);\n\nstatic struct i2c_driver da9062_i2c_driver = {\n\t.driver = {\n\t\t.name = \"da9062\",\n\t\t.of_match_table = da9062_dt_ids,\n\t},\n\t.probe = da9062_i2c_probe,\n\t.remove   = da9062_i2c_remove,\n\t.id_table = da9062_i2c_id,\n};\n\nmodule_i2c_driver(da9062_i2c_driver);\n\nMODULE_DESCRIPTION(\"Core device driver for Dialog DA9061 and DA9062\");\nMODULE_AUTHOR(\"Steve Twiss <stwiss.opensource@diasemi.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}