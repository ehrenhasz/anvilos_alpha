{
  "module_name": "mt6360-core.c",
  "hash_id": "cd8aef30da50b9b23f2438cc3f9b7c54416709ff7a05e8287e8e3c66fb616f5a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/mt6360-core.c",
  "human_readable_source": "\n \n\n#include <linux/crc8.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/core.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\nenum {\n\tMT6360_SLAVE_TCPC = 0,\n\tMT6360_SLAVE_PMIC,\n\tMT6360_SLAVE_LDO,\n\tMT6360_SLAVE_PMU,\n\tMT6360_SLAVE_MAX,\n};\n\nstruct mt6360_ddata {\n\tstruct i2c_client *i2c[MT6360_SLAVE_MAX];\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tstruct regmap_irq_chip_data *irq_data;\n\tunsigned int chip_rev;\n\tu8 crc8_tbl[CRC8_TABLE_SIZE];\n};\n\n#define MT6360_TCPC_SLAVEID\t\t0x4E\n#define MT6360_PMIC_SLAVEID\t\t0x1A\n#define MT6360_LDO_SLAVEID\t\t0x64\n#define MT6360_PMU_SLAVEID\t\t0x34\n\n#define MT6360_REG_TCPCSTART\t\t0x00\n#define MT6360_REG_TCPCEND\t\t0xFF\n#define MT6360_REG_PMICSTART\t\t0x100\n#define MT6360_REG_PMICEND\t\t0x13B\n#define MT6360_REG_LDOSTART\t\t0x200\n#define MT6360_REG_LDOEND\t\t0x21C\n#define MT6360_REG_PMUSTART\t\t0x300\n#define MT6360_PMU_DEV_INFO\t\t0x300\n#define MT6360_PMU_CHG_IRQ1\t\t0x3D0\n#define MT6360_PMU_CHG_MASK1\t\t0x3F0\n#define MT6360_REG_PMUEND\t\t0x3FF\n\n#define MT6360_PMU_IRQ_REGNUM\t\t16\n\n#define CHIP_VEN_MASK\t\t\t0xF0\n#define CHIP_VEN_MT6360\t\t\t0x50\n#define CHIP_REV_MASK\t\t\t0x0F\n\n#define MT6360_ADDRESS_MASK\t\t0x3F\n#define MT6360_DATA_SIZE_1_BYTE\t\t0x00\n#define MT6360_DATA_SIZE_2_BYTES\t0x40\n#define MT6360_DATA_SIZE_3_BYTES\t0x80\n#define MT6360_DATA_SIZE_4_BYTES\t0xC0\n\n#define MT6360_CRC8_POLYNOMIAL\t\t0x7\n\n#define MT6360_CRC_I2C_ADDR_SIZE\t1\n#define MT6360_CRC_REG_ADDR_SIZE\t1\n \n#define MT6360_ALLOC_READ_SIZE(_size)\t(_size + 3)\n \n#define MT6360_ALLOC_WRITE_SIZE(_size)\t(_size + 4)\n#define MT6360_CRC_PREDATA_OFFSET\t(MT6360_CRC_I2C_ADDR_SIZE + MT6360_CRC_REG_ADDR_SIZE)\n#define MT6360_CRC_CRC8_SIZE\t\t1\n#define MT6360_CRC_DUMMY_BYTE_SIZE\t1\n#define MT6360_REGMAP_REG_BYTE_SIZE\t2\n#define I2C_ADDR_XLATE_8BIT(_addr, _rw)\t(((_addr & 0x7F) << 1) + _rw)\n\n \n#define MT6360_CHG_TREG_EVT\t\t4\n#define MT6360_CHG_AICR_EVT\t\t5\n#define MT6360_CHG_MIVR_EVT\t\t6\n#define MT6360_PWR_RDY_EVT\t\t7\n \n#define MT6360_CHG_BATSYSUV_EVT\t\t9\n#define MT6360_FLED_CHG_VINOVP_EVT\t11\n#define MT6360_CHG_VSYSUV_EVT\t\t12\n#define MT6360_CHG_VSYSOV_EVT\t\t13\n#define MT6360_CHG_VBATOV_EVT\t\t14\n#define MT6360_CHG_VBUSOV_EVT\t\t15\n \n \n#define MT6360_WD_PMU_DET\t\t25\n#define MT6360_WD_PMU_DONE\t\t26\n#define MT6360_CHG_TMRI\t\t\t27\n#define MT6360_CHG_ADPBADI\t\t29\n#define MT6360_CHG_RVPI\t\t\t30\n#define MT6360_OTPI\t\t\t31\n \n#define MT6360_CHG_AICCMEASL\t\t32\n#define MT6360_CHGDET_DONEI\t\t34\n#define MT6360_WDTMRI\t\t\t35\n#define MT6360_SSFINISHI\t\t36\n#define MT6360_CHG_RECHGI\t\t37\n#define MT6360_CHG_TERMI\t\t38\n#define MT6360_CHG_IEOCI\t\t39\n \n#define MT6360_PUMPX_DONEI\t\t40\n#define MT6360_BAT_OVP_ADC_EVT\t\t41\n#define MT6360_TYPEC_OTP_EVT\t\t42\n#define MT6360_ADC_WAKEUP_EVT\t\t43\n#define MT6360_ADC_DONEI\t\t44\n#define MT6360_BST_BATUVI\t\t45\n#define MT6360_BST_VBUSOVI\t\t46\n#define MT6360_BST_OLPI\t\t\t47\n \n#define MT6360_ATTACH_I\t\t\t48\n#define MT6360_DETACH_I\t\t\t49\n#define MT6360_QC30_STPDONE\t\t51\n#define MT6360_QC_VBUSDET_DONE\t\t52\n#define MT6360_HVDCP_DET\t\t53\n#define MT6360_CHGDETI\t\t\t54\n#define MT6360_DCDTI\t\t\t55\n \n#define MT6360_FOD_DONE_EVT\t\t56\n#define MT6360_FOD_OV_EVT\t\t57\n#define MT6360_CHRDET_UVP_EVT\t\t58\n#define MT6360_CHRDET_OVP_EVT\t\t59\n#define MT6360_CHRDET_EXT_EVT\t\t60\n#define MT6360_FOD_LR_EVT\t\t61\n#define MT6360_FOD_HR_EVT\t\t62\n#define MT6360_FOD_DISCHG_FAIL_EVT\t63\n \n#define MT6360_USBID_EVT\t\t64\n#define MT6360_APWDTRST_EVT\t\t65\n#define MT6360_EN_EVT\t\t\t66\n#define MT6360_QONB_RST_EVT\t\t67\n#define MT6360_MRSTB_EVT\t\t68\n#define MT6360_OTP_EVT\t\t\t69\n#define MT6360_VDDAOV_EVT\t\t70\n#define MT6360_SYSUV_EVT\t\t71\n \n#define MT6360_FLED_STRBPIN_EVT\t\t72\n#define MT6360_FLED_TORPIN_EVT\t\t73\n#define MT6360_FLED_TX_EVT\t\t74\n#define MT6360_FLED_LVF_EVT\t\t75\n#define MT6360_FLED2_SHORT_EVT\t\t78\n#define MT6360_FLED1_SHORT_EVT\t\t79\n \n#define MT6360_FLED2_STRB_EVT\t\t80\n#define MT6360_FLED1_STRB_EVT\t\t81\n#define MT6360_FLED2_STRB_TO_EVT\t82\n#define MT6360_FLED1_STRB_TO_EVT\t83\n#define MT6360_FLED2_TOR_EVT\t\t84\n#define MT6360_FLED1_TOR_EVT\t\t85\n \n \n#define MT6360_BUCK1_PGB_EVT\t\t96\n#define MT6360_BUCK1_OC_EVT\t\t100\n#define MT6360_BUCK1_OV_EVT\t\t101\n#define MT6360_BUCK1_UV_EVT\t\t102\n \n#define MT6360_BUCK2_PGB_EVT\t\t104\n#define MT6360_BUCK2_OC_EVT\t\t108\n#define MT6360_BUCK2_OV_EVT\t\t109\n#define MT6360_BUCK2_UV_EVT\t\t110\n \n#define MT6360_LDO1_OC_EVT\t\t113\n#define MT6360_LDO2_OC_EVT\t\t114\n#define MT6360_LDO3_OC_EVT\t\t115\n#define MT6360_LDO5_OC_EVT\t\t117\n#define MT6360_LDO6_OC_EVT\t\t118\n#define MT6360_LDO7_OC_EVT\t\t119\n \n#define MT6360_LDO1_PGB_EVT\t\t121\n#define MT6360_LDO2_PGB_EVT\t\t122\n#define MT6360_LDO3_PGB_EVT\t\t123\n#define MT6360_LDO5_PGB_EVT\t\t125\n#define MT6360_LDO6_PGB_EVT\t\t126\n#define MT6360_LDO7_PGB_EVT\t\t127\n\nstatic const struct regmap_irq mt6360_irqs[] =  {\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_TREG_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_AICR_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_MIVR_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_PWR_RDY_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_BATSYSUV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED_CHG_VINOVP_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_VSYSUV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_VSYSOV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_VBATOV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_VBUSOV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_WD_PMU_DET, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_WD_PMU_DONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_TMRI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_ADPBADI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_RVPI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_OTPI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_AICCMEASL, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHGDET_DONEI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_WDTMRI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_SSFINISHI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_RECHGI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_TERMI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHG_IEOCI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_PUMPX_DONEI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BAT_OVP_ADC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_TYPEC_OTP_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_ADC_WAKEUP_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_ADC_DONEI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BST_BATUVI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BST_VBUSOVI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BST_OLPI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_ATTACH_I, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_DETACH_I, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_QC30_STPDONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_QC_VBUSDET_DONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_HVDCP_DET, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHGDETI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_DCDTI, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FOD_DONE_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FOD_OV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHRDET_UVP_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHRDET_OVP_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_CHRDET_EXT_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FOD_LR_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FOD_HR_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FOD_DISCHG_FAIL_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_USBID_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_APWDTRST_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_EN_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_QONB_RST_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_MRSTB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_OTP_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_VDDAOV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_SYSUV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED_STRBPIN_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED_TORPIN_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED_TX_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED_LVF_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED2_SHORT_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED1_SHORT_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED2_STRB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED1_STRB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED2_STRB_TO_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED1_STRB_TO_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED2_TOR_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_FLED1_TOR_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK1_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK1_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK1_OV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK1_UV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK2_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK2_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK2_OV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_BUCK2_UV_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO1_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO2_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO3_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO5_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO6_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO7_OC_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO1_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO2_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO3_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO5_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO6_PGB_EVT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6360_LDO7_PGB_EVT, 8),\n};\n\nstatic const struct regmap_irq_chip mt6360_irq_chip = {\n\t.name = \"mt6360_irqs\",\n\t.irqs = mt6360_irqs,\n\t.num_irqs = ARRAY_SIZE(mt6360_irqs),\n\t.num_regs = MT6360_PMU_IRQ_REGNUM,\n\t.mask_base = MT6360_PMU_CHG_MASK1,\n\t.status_base = MT6360_PMU_CHG_IRQ1,\n\t.ack_base = MT6360_PMU_CHG_IRQ1,\n\t.init_ack_masked = true,\n\t.use_ack = true,\n};\n\nstatic const struct resource mt6360_adc_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6360_ADC_DONEI, \"adc_donei\"),\n};\n\nstatic const struct resource mt6360_chg_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_TREG_EVT, \"chg_treg_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_PWR_RDY_EVT, \"pwr_rdy_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_BATSYSUV_EVT, \"chg_batsysuv_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_VSYSUV_EVT, \"chg_vsysuv_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_VSYSOV_EVT, \"chg_vsysov_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_VBATOV_EVT, \"chg_vbatov_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_VBUSOV_EVT, \"chg_vbusov_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_AICCMEASL, \"chg_aiccmeasl\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_WDTMRI, \"wdtmri\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_RECHGI, \"chg_rechgi\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_TERMI, \"chg_termi\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHG_IEOCI, \"chg_ieoci\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_PUMPX_DONEI, \"pumpx_donei\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_ATTACH_I, \"attach_i\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_CHRDET_EXT_EVT, \"chrdet_ext_evt\"),\n};\n\nstatic const struct resource mt6360_led_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6360_FLED_CHG_VINOVP_EVT, \"fled_chg_vinovp_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_FLED_LVF_EVT, \"fled_lvf_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_FLED2_SHORT_EVT, \"fled2_short_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_FLED1_SHORT_EVT, \"fled1_short_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_FLED2_STRB_TO_EVT, \"fled2_strb_to_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_FLED1_STRB_TO_EVT, \"fled1_strb_to_evt\"),\n};\n\nstatic const struct resource mt6360_regulator_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK1_PGB_EVT, \"buck1_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK1_OC_EVT, \"buck1_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK1_OV_EVT, \"buck1_ov_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK1_UV_EVT, \"buck1_uv_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK2_PGB_EVT, \"buck2_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK2_OC_EVT, \"buck2_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK2_OV_EVT, \"buck2_ov_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_BUCK2_UV_EVT, \"buck2_uv_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO1_OC_EVT, \"ldo1_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO2_OC_EVT, \"ldo2_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO3_OC_EVT, \"ldo3_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO5_OC_EVT, \"ldo5_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO6_OC_EVT, \"ldo6_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO7_OC_EVT, \"ldo7_oc_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO1_PGB_EVT, \"ldo1_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO2_PGB_EVT, \"ldo2_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO3_PGB_EVT, \"ldo3_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO5_PGB_EVT, \"ldo5_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO6_PGB_EVT, \"ldo6_pgb_evt\"),\n\tDEFINE_RES_IRQ_NAMED(MT6360_LDO7_PGB_EVT, \"ldo7_pgb_evt\"),\n};\n\nstatic const struct mfd_cell mt6360_devs[] = {\n\tMFD_CELL_OF(\"mt6360-adc\", mt6360_adc_resources,\n\t\t    NULL, 0, 0, \"mediatek,mt6360-adc\"),\n\tMFD_CELL_OF(\"mt6360-chg\", mt6360_chg_resources,\n\t\t    NULL, 0, 0, \"mediatek,mt6360-chg\"),\n\tMFD_CELL_OF(\"mt6360-led\", mt6360_led_resources,\n\t\t    NULL, 0, 0, \"mediatek,mt6360-led\"),\n\tMFD_CELL_RES(\"mt6360-regulator\", mt6360_regulator_resources),\n\tMFD_CELL_OF(\"mt6360-tcpc\", NULL,\n\t\t    NULL, 0, 0, \"mediatek,mt6360-tcpc\"),\n};\n\nstatic int mt6360_check_vendor_info(struct mt6360_ddata *ddata)\n{\n\tu32 info;\n\tint ret;\n\n\tret = regmap_read(ddata->regmap, MT6360_PMU_DEV_INFO, &info);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif ((info & CHIP_VEN_MASK) != CHIP_VEN_MT6360) {\n\t\tdev_err(ddata->dev, \"Device not supported\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tddata->chip_rev = info & CHIP_REV_MASK;\n\n\treturn 0;\n}\n\nstatic const unsigned short mt6360_slave_addr[MT6360_SLAVE_MAX] = {\n\tMT6360_TCPC_SLAVEID,\n\tMT6360_PMIC_SLAVEID,\n\tMT6360_LDO_SLAVEID,\n\tMT6360_PMU_SLAVEID,\n};\n\nstatic int mt6360_xlate_pmicldo_addr(u8 *addr, int rw_size)\n{\n\t \n\t*addr &= MT6360_ADDRESS_MASK;\n\n\tswitch (rw_size) {\n\tcase 1:\n\t\t*addr |= MT6360_DATA_SIZE_1_BYTE;\n\t\tbreak;\n\tcase 2:\n\t\t*addr |= MT6360_DATA_SIZE_2_BYTES;\n\t\tbreak;\n\tcase 3:\n\t\t*addr |= MT6360_DATA_SIZE_3_BYTES;\n\t\tbreak;\n\tcase 4:\n\t\t*addr |= MT6360_DATA_SIZE_4_BYTES;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt6360_regmap_read(void *context, const void *reg, size_t reg_size,\n\t\t\t      void *val, size_t val_size)\n{\n\tstruct mt6360_ddata *ddata = context;\n\tu8 bank = *(u8 *)reg;\n\tu8 reg_addr = *(u8 *)(reg + 1);\n\tstruct i2c_client *i2c;\n\tbool crc_needed = false;\n\tu8 *buf;\n\tint buf_len = MT6360_ALLOC_READ_SIZE(val_size);\n\tint read_size = val_size;\n\tu8 crc;\n\tint ret;\n\n\tif (bank >= MT6360_SLAVE_MAX)\n\t\treturn -EINVAL;\n\n\ti2c = ddata->i2c[bank];\n\n\tif (bank == MT6360_SLAVE_PMIC || bank == MT6360_SLAVE_LDO) {\n\t\tcrc_needed = true;\n\t\tret = mt6360_xlate_pmicldo_addr(&reg_addr, val_size);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tread_size += MT6360_CRC_CRC8_SIZE;\n\t}\n\n\tbuf = kzalloc(buf_len, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tbuf[0] = I2C_ADDR_XLATE_8BIT(i2c->addr, I2C_SMBUS_READ);\n\tbuf[1] = reg_addr;\n\n\tret = i2c_smbus_read_i2c_block_data(i2c, reg_addr, read_size,\n\t\t\t\t\t    buf + MT6360_CRC_PREDATA_OFFSET);\n\tif (ret < 0)\n\t\tgoto out;\n\telse if (ret != read_size) {\n\t\tret = -EIO;\n\t\tgoto out;\n\t}\n\n\tif (crc_needed) {\n\t\tcrc = crc8(ddata->crc8_tbl, buf, val_size + MT6360_CRC_PREDATA_OFFSET, 0);\n\t\tif (crc != buf[val_size + MT6360_CRC_PREDATA_OFFSET]) {\n\t\t\tret = -EIO;\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tmemcpy(val, buf + MT6360_CRC_PREDATA_OFFSET, val_size);\nout:\n\tkfree(buf);\n\treturn (ret < 0) ? ret : 0;\n}\n\nstatic int mt6360_regmap_write(void *context, const void *val, size_t val_size)\n{\n\tstruct mt6360_ddata *ddata = context;\n\tu8 bank = *(u8 *)val;\n\tu8 reg_addr = *(u8 *)(val + 1);\n\tstruct i2c_client *i2c;\n\tbool crc_needed = false;\n\tu8 *buf;\n\tint buf_len = MT6360_ALLOC_WRITE_SIZE(val_size);\n\tint write_size = val_size - MT6360_REGMAP_REG_BYTE_SIZE;\n\tint ret;\n\n\tif (bank >= MT6360_SLAVE_MAX)\n\t\treturn -EINVAL;\n\n\ti2c = ddata->i2c[bank];\n\n\tif (bank == MT6360_SLAVE_PMIC || bank == MT6360_SLAVE_LDO) {\n\t\tcrc_needed = true;\n\t\tret = mt6360_xlate_pmicldo_addr(&reg_addr, val_size - MT6360_REGMAP_REG_BYTE_SIZE);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tbuf = kzalloc(buf_len, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tbuf[0] = I2C_ADDR_XLATE_8BIT(i2c->addr, I2C_SMBUS_WRITE);\n\tbuf[1] = reg_addr;\n\tmemcpy(buf + MT6360_CRC_PREDATA_OFFSET, val + MT6360_REGMAP_REG_BYTE_SIZE, write_size);\n\n\tif (crc_needed) {\n\t\tbuf[val_size] = crc8(ddata->crc8_tbl, buf, val_size, 0);\n\t\twrite_size += (MT6360_CRC_CRC8_SIZE + MT6360_CRC_DUMMY_BYTE_SIZE);\n\t}\n\n\tret = i2c_smbus_write_i2c_block_data(i2c, reg_addr, write_size,\n\t\t\t\t\t     buf + MT6360_CRC_PREDATA_OFFSET);\n\n\tkfree(buf);\n\treturn ret;\n}\n\nstatic const struct regmap_bus mt6360_regmap_bus = {\n\t.read\t\t= mt6360_regmap_read,\n\t.write\t\t= mt6360_regmap_write,\n\n\t \n\t.max_raw_read\t= 4,\n\t.max_raw_write\t= 4,\n};\n\nstatic bool mt6360_is_readwrite_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase MT6360_REG_TCPCSTART ... MT6360_REG_TCPCEND:\n\t\tfallthrough;\n\tcase MT6360_REG_PMICSTART ... MT6360_REG_PMICEND:\n\t\tfallthrough;\n\tcase MT6360_REG_LDOSTART ... MT6360_REG_LDOEND:\n\t\tfallthrough;\n\tcase MT6360_REG_PMUSTART ... MT6360_REG_PMUEND:\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic const struct regmap_config mt6360_regmap_config = {\n\t.reg_bits\t\t= 16,\n\t.val_bits\t\t= 8,\n\t.reg_format_endian\t= REGMAP_ENDIAN_BIG,\n\t.max_register\t\t= MT6360_REG_PMUEND,\n\t.writeable_reg\t\t= mt6360_is_readwrite_reg,\n\t.readable_reg\t\t= mt6360_is_readwrite_reg,\n};\n\nstatic int mt6360_probe(struct i2c_client *client)\n{\n\tstruct mt6360_ddata *ddata;\n\tint i, ret;\n\n\tddata = devm_kzalloc(&client->dev, sizeof(*ddata), GFP_KERNEL);\n\tif (!ddata)\n\t\treturn -ENOMEM;\n\n\tddata->dev = &client->dev;\n\ti2c_set_clientdata(client, ddata);\n\n\tfor (i = 0; i < MT6360_SLAVE_MAX - 1; i++) {\n\t\tddata->i2c[i] = devm_i2c_new_dummy_device(&client->dev,\n\t\t\t\t\t\t\t  client->adapter,\n\t\t\t\t\t\t\t  mt6360_slave_addr[i]);\n\t\tif (IS_ERR(ddata->i2c[i])) {\n\t\t\tdev_err(&client->dev,\n\t\t\t\t\"Failed to get new dummy I2C device for address 0x%x\",\n\t\t\t\tmt6360_slave_addr[i]);\n\t\t\treturn PTR_ERR(ddata->i2c[i]);\n\t\t}\n\t}\n\tddata->i2c[MT6360_SLAVE_MAX - 1] = client;\n\n\tcrc8_populate_msb(ddata->crc8_tbl, MT6360_CRC8_POLYNOMIAL);\n\tddata->regmap = devm_regmap_init(ddata->dev, &mt6360_regmap_bus, ddata,\n\t\t\t\t\t &mt6360_regmap_config);\n\tif (IS_ERR(ddata->regmap)) {\n\t\tdev_err(&client->dev, \"Failed to register regmap\\n\");\n\t\treturn PTR_ERR(ddata->regmap);\n\t}\n\n\tret = mt6360_check_vendor_info(ddata);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_regmap_add_irq_chip(&client->dev, ddata->regmap, client->irq,\n\t\t\t\t       0, 0, &mt6360_irq_chip,\n\t\t\t\t       &ddata->irq_data);\n\tif (ret) {\n\t\tdev_err(&client->dev, \"Failed to add Regmap IRQ Chip\\n\");\n\t\treturn ret;\n\t}\n\n\tret = devm_mfd_add_devices(&client->dev, PLATFORM_DEVID_AUTO,\n\t\t\t\t   mt6360_devs, ARRAY_SIZE(mt6360_devs), NULL,\n\t\t\t\t   0, regmap_irq_get_domain(ddata->irq_data));\n\tif (ret) {\n\t\tdev_err(&client->dev,\n\t\t\t\"Failed to register subordinate devices\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int __maybe_unused mt6360_suspend(struct device *dev)\n{\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\n\tif (device_may_wakeup(dev))\n\t\tenable_irq_wake(i2c->irq);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused mt6360_resume(struct device *dev)\n{\n\n\tstruct i2c_client *i2c = to_i2c_client(dev);\n\n\tif (device_may_wakeup(dev))\n\t\tdisable_irq_wake(i2c->irq);\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(mt6360_pm_ops, mt6360_suspend, mt6360_resume);\n\nstatic const struct of_device_id __maybe_unused mt6360_of_id[] = {\n\t{ .compatible = \"mediatek,mt6360\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mt6360_of_id);\n\nstatic struct i2c_driver mt6360_driver = {\n\t.driver = {\n\t\t.name = \"mt6360\",\n\t\t.pm = &mt6360_pm_ops,\n\t\t.of_match_table = of_match_ptr(mt6360_of_id),\n\t},\n\t.probe = mt6360_probe,\n};\nmodule_i2c_driver(mt6360_driver);\n\nMODULE_AUTHOR(\"Gene Chen <gene_chen@richtek.com>\");\nMODULE_DESCRIPTION(\"MT6360 I2C Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}