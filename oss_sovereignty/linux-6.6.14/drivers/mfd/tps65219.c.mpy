{
  "module_name": "tps65219.c",
  "hash_id": "7c177c8fa743f9cbd4e51fd6c2bf99de9e3351e4d863555375eec6c0d64c40b2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/tps65219.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/i2c.h>\n#include <linux/reboot.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/core.h>\n#include <linux/mfd/tps65219.h>\n\nstatic int tps65219_warm_reset(struct tps65219 *tps)\n{\n\treturn regmap_update_bits(tps->regmap, TPS65219_REG_MFP_CTRL,\n\t\t\t\t  TPS65219_MFP_WARM_RESET_I2C_CTRL_MASK,\n\t\t\t\t  TPS65219_MFP_WARM_RESET_I2C_CTRL_MASK);\n}\n\nstatic int tps65219_cold_reset(struct tps65219 *tps)\n{\n\treturn regmap_update_bits(tps->regmap, TPS65219_REG_MFP_CTRL,\n\t\t\t\t  TPS65219_MFP_COLD_RESET_I2C_CTRL_MASK,\n\t\t\t\t  TPS65219_MFP_COLD_RESET_I2C_CTRL_MASK);\n}\n\nstatic int tps65219_soft_shutdown(struct tps65219 *tps)\n{\n\treturn regmap_update_bits(tps->regmap, TPS65219_REG_MFP_CTRL,\n\t\t\t\t  TPS65219_MFP_I2C_OFF_REQ_MASK,\n\t\t\t\t  TPS65219_MFP_I2C_OFF_REQ_MASK);\n}\n\nstatic int tps65219_power_off_handler(struct sys_off_data *data)\n{\n\ttps65219_soft_shutdown(data->cb_data);\n\treturn NOTIFY_DONE;\n}\n\nstatic int tps65219_restart(struct tps65219 *tps, unsigned long reboot_mode)\n{\n\tif (reboot_mode == REBOOT_WARM)\n\t\ttps65219_warm_reset(tps);\n\telse\n\t\ttps65219_cold_reset(tps);\n\n\treturn NOTIFY_DONE;\n}\n\nstatic int tps65219_restart_handler(struct sys_off_data *data)\n{\n\ttps65219_restart(data->cb_data, data->mode);\n\treturn NOTIFY_DONE;\n}\n\nstatic const struct resource tps65219_pwrbutton_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_PB_FALLING_EDGE_DETECT, \"falling\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_PB_RISING_EDGE_DETECT, \"rising\"),\n};\n\nstatic const struct resource tps65219_regulator_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO3_SCG, \"LDO3_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO3_OC, \"LDO3_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO3_UV, \"LDO3_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO4_SCG, \"LDO4_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO4_OC, \"LDO4_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO4_UV, \"LDO4_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO1_SCG, \"LDO1_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO1_OC, \"LDO1_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO1_UV, \"LDO1_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO2_SCG, \"LDO2_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO2_OC, \"LDO2_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO2_UV, \"LDO2_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK3_SCG, \"BUCK3_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK3_OC, \"BUCK3_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK3_NEG_OC, \"BUCK3_NEG_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK3_UV, \"BUCK3_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK1_SCG, \"BUCK1_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK1_OC, \"BUCK1_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK1_NEG_OC, \"BUCK1_NEG_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK1_UV, \"BUCK1_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK2_SCG, \"BUCK2_SCG\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK2_OC, \"BUCK2_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK2_NEG_OC, \"BUCK2_NEG_OC\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK2_UV, \"BUCK2_UV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK1_RV, \"BUCK1_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK2_RV, \"BUCK2_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK3_RV, \"BUCK3_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO1_RV, \"LDO1_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO2_RV, \"LDO2_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO3_RV, \"LDO3_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO4_RV, \"LDO4_RV\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK1_RV_SD, \"BUCK1_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK2_RV_SD, \"BUCK2_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_BUCK3_RV_SD, \"BUCK3_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO1_RV_SD, \"LDO1_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO2_RV_SD, \"LDO2_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO3_RV_SD, \"LDO3_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_LDO4_RV_SD, \"LDO4_RV_SD\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_TIMEOUT, \"TIMEOUT\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_3_WARM, \"SENSOR_3_WARM\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_2_WARM, \"SENSOR_2_WARM\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_1_WARM, \"SENSOR_1_WARM\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_0_WARM, \"SENSOR_0_WARM\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_3_HOT, \"SENSOR_3_HOT\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_2_HOT, \"SENSOR_2_HOT\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_1_HOT, \"SENSOR_1_HOT\"),\n\tDEFINE_RES_IRQ_NAMED(TPS65219_INT_SENSOR_0_HOT, \"SENSOR_0_HOT\"),\n};\n\nstatic const struct mfd_cell tps65219_cells[] = {\n\t{\n\t\t.name = \"tps65219-regulator\",\n\t\t.resources = tps65219_regulator_resources,\n\t\t.num_resources = ARRAY_SIZE(tps65219_regulator_resources),\n\t},\n\t{ .name = \"tps65219-gpio\", },\n};\n\nstatic const struct mfd_cell tps65219_pwrbutton_cell = {\n\t.name = \"tps65219-pwrbutton\",\n\t.resources = tps65219_pwrbutton_resources,\n\t.num_resources = ARRAY_SIZE(tps65219_pwrbutton_resources),\n};\n\nstatic const struct regmap_config tps65219_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = TPS65219_REG_FACTORY_CONFIG_2,\n};\n\n \n \nstatic unsigned int bit0_offsets[] = { TPS65219_REG_INT_TO_RV_POS };\nstatic unsigned int bit1_offsets[] = { TPS65219_REG_INT_RV_POS };\t \nstatic unsigned int bit2_offsets[] = { TPS65219_REG_INT_SYS_POS };\t \nstatic unsigned int bit3_offsets[] = { TPS65219_REG_INT_BUCK_1_2_POS };\t \nstatic unsigned int bit4_offsets[] = { TPS65219_REG_INT_BUCK_3_POS };\t \nstatic unsigned int bit5_offsets[] = { TPS65219_REG_INT_LDO_1_2_POS };\t \nstatic unsigned int bit6_offsets[] = { TPS65219_REG_INT_LDO_3_4_POS };\t \nstatic unsigned int bit7_offsets[] = { TPS65219_REG_INT_PB_POS };\t \n\nstatic struct regmap_irq_sub_irq_map tps65219_sub_irq_offsets[] = {\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit0_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit1_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit2_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit3_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit4_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit5_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit6_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit7_offsets),\n};\n\n#define TPS65219_REGMAP_IRQ_REG(int_name, register_position) \\\n\tREGMAP_IRQ_REG(int_name, register_position, int_name##_MASK)\n\nstatic struct regmap_irq tps65219_irqs[] = {\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO3_SCG, TPS65219_REG_INT_LDO_3_4_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO3_OC, TPS65219_REG_INT_LDO_3_4_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO3_UV, TPS65219_REG_INT_LDO_3_4_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO4_SCG, TPS65219_REG_INT_LDO_3_4_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO4_OC, TPS65219_REG_INT_LDO_3_4_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO4_UV, TPS65219_REG_INT_LDO_3_4_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO1_SCG, TPS65219_REG_INT_LDO_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO1_OC, TPS65219_REG_INT_LDO_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO1_UV, TPS65219_REG_INT_LDO_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO2_SCG, TPS65219_REG_INT_LDO_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO2_OC, TPS65219_REG_INT_LDO_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO2_UV, TPS65219_REG_INT_LDO_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK3_SCG, TPS65219_REG_INT_BUCK_3_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK3_OC, TPS65219_REG_INT_BUCK_3_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK3_NEG_OC, TPS65219_REG_INT_BUCK_3_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK3_UV, TPS65219_REG_INT_BUCK_3_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK2_SCG, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK2_OC, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK2_NEG_OC, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK2_UV, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK1_SCG, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK1_OC, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK1_NEG_OC, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK1_UV, TPS65219_REG_INT_BUCK_1_2_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_3_WARM, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_2_WARM, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_1_WARM, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_0_WARM, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_3_HOT, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_2_HOT, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_1_HOT, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_SENSOR_0_HOT, TPS65219_REG_INT_SYS_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK1_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK2_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK3_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO1_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO2_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO3_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO4_RV, TPS65219_REG_INT_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK1_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK2_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_BUCK3_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO1_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO2_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO3_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_LDO4_RV_SD, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_TIMEOUT, TPS65219_REG_INT_TO_RV_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_PB_FALLING_EDGE_DETECT, TPS65219_REG_INT_PB_POS),\n\tTPS65219_REGMAP_IRQ_REG(TPS65219_INT_PB_RISING_EDGE_DETECT, TPS65219_REG_INT_PB_POS),\n};\n\nstatic struct regmap_irq_chip tps65219_irq_chip = {\n\t.name = \"tps65219_irq\",\n\t.main_status = TPS65219_REG_INT_SOURCE,\n\t.num_main_regs = 1,\n\t.num_main_status_bits = 8,\n\t.irqs = tps65219_irqs,\n\t.num_irqs = ARRAY_SIZE(tps65219_irqs),\n\t.status_base = TPS65219_REG_INT_LDO_3_4,\n\t.ack_base = TPS65219_REG_INT_LDO_3_4,\n\t.clear_ack = 1,\n\t.num_regs = 8,\n\t.sub_reg_offsets = tps65219_sub_irq_offsets,\n};\n\nstatic int tps65219_probe(struct i2c_client *client)\n{\n\tstruct tps65219 *tps;\n\tunsigned int chipid;\n\tbool pwr_button;\n\tint ret;\n\n\ttps = devm_kzalloc(&client->dev, sizeof(*tps), GFP_KERNEL);\n\tif (!tps)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(client, tps);\n\n\ttps->dev = &client->dev;\n\n\ttps->regmap = devm_regmap_init_i2c(client, &tps65219_regmap_config);\n\tif (IS_ERR(tps->regmap)) {\n\t\tret = PTR_ERR(tps->regmap);\n\t\tdev_err(tps->dev, \"Failed to allocate register map: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_regmap_add_irq_chip(&client->dev, tps->regmap, client->irq,\n\t\t\t\t       IRQF_ONESHOT, 0, &tps65219_irq_chip,\n\t\t\t\t       &tps->irq_data);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_read(tps->regmap, TPS65219_REG_TI_DEV_ID, &chipid);\n\tif (ret) {\n\t\tdev_err(tps->dev, \"Failed to read device ID: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_mfd_add_devices(tps->dev, PLATFORM_DEVID_AUTO,\n\t\t\t\t   tps65219_cells, ARRAY_SIZE(tps65219_cells),\n\t\t\t\t   NULL, 0, regmap_irq_get_domain(tps->irq_data));\n\tif (ret) {\n\t\tdev_err(tps->dev, \"Failed to add child devices: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpwr_button = of_property_read_bool(tps->dev->of_node, \"ti,power-button\");\n\tif (pwr_button) {\n\t\tret = devm_mfd_add_devices(tps->dev, PLATFORM_DEVID_AUTO,\n\t\t\t\t\t   &tps65219_pwrbutton_cell, 1, NULL, 0,\n\t\t\t\t\t   regmap_irq_get_domain(tps->irq_data));\n\t\tif (ret) {\n\t\t\tdev_err(tps->dev, \"Failed to add power-button: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = devm_register_restart_handler(tps->dev,\n\t\t\t\t\t    tps65219_restart_handler,\n\t\t\t\t\t    tps);\n\n\tif (ret) {\n\t\tdev_err(tps->dev, \"cannot register restart handler, %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_register_power_off_handler(tps->dev,\n\t\t\t\t\t      tps65219_power_off_handler,\n\t\t\t\t\t      tps);\n\tif (ret) {\n\t\tdev_err(tps->dev, \"failed to register power-off handler: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic const struct of_device_id of_tps65219_match_table[] = {\n\t{ .compatible = \"ti,tps65219\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, of_tps65219_match_table);\n\nstatic struct i2c_driver tps65219_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"tps65219\",\n\t\t.of_match_table = of_tps65219_match_table,\n\t},\n\t.probe\t\t= tps65219_probe,\n};\nmodule_i2c_driver(tps65219_driver);\n\nMODULE_AUTHOR(\"Jerome Neanne <jneanne@baylibre.com>\");\nMODULE_DESCRIPTION(\"TPS65219 power management IC driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}