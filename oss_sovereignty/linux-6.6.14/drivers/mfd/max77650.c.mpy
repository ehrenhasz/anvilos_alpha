{
  "module_name": "max77650.c",
  "hash_id": "1be788332a100c62742cb5f70db362f4c0b211d629879ab30544c858051b8753",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max77650.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max77650.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n\n#define MAX77650_INT_GPI_F_MSK\t\tBIT(0)\n#define MAX77650_INT_GPI_R_MSK\t\tBIT(1)\n#define MAX77650_INT_GPI_MSK \\\n\t\t\t(MAX77650_INT_GPI_F_MSK | MAX77650_INT_GPI_R_MSK)\n#define MAX77650_INT_nEN_F_MSK\t\tBIT(2)\n#define MAX77650_INT_nEN_R_MSK\t\tBIT(3)\n#define MAX77650_INT_TJAL1_R_MSK\tBIT(4)\n#define MAX77650_INT_TJAL2_R_MSK\tBIT(5)\n#define MAX77650_INT_DOD_R_MSK\t\tBIT(6)\n\n#define MAX77650_INT_THM_MSK\t\tBIT(0)\n#define MAX77650_INT_CHG_MSK\t\tBIT(1)\n#define MAX77650_INT_CHGIN_MSK\t\tBIT(2)\n#define MAX77650_INT_TJ_REG_MSK\t\tBIT(3)\n#define MAX77650_INT_CHGIN_CTRL_MSK\tBIT(4)\n#define MAX77650_INT_SYS_CTRL_MSK\tBIT(5)\n#define MAX77650_INT_SYS_CNFG_MSK\tBIT(6)\n\n#define MAX77650_INT_GLBL_OFFSET\t0\n#define MAX77650_INT_CHG_OFFSET\t\t1\n\n#define MAX77650_SBIA_LPM_MASK\t\tBIT(5)\n#define MAX77650_SBIA_LPM_DISABLED\t0x00\n\nenum {\n\tMAX77650_INT_GPI,\n\tMAX77650_INT_nEN_F,\n\tMAX77650_INT_nEN_R,\n\tMAX77650_INT_TJAL1_R,\n\tMAX77650_INT_TJAL2_R,\n\tMAX77650_INT_DOD_R,\n\tMAX77650_INT_THM,\n\tMAX77650_INT_CHG,\n\tMAX77650_INT_CHGIN,\n\tMAX77650_INT_TJ_REG,\n\tMAX77650_INT_CHGIN_CTRL,\n\tMAX77650_INT_SYS_CTRL,\n\tMAX77650_INT_SYS_CNFG,\n};\n\nstatic const struct resource max77650_charger_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MAX77650_INT_CHG, \"CHG\"),\n\tDEFINE_RES_IRQ_NAMED(MAX77650_INT_CHGIN, \"CHGIN\"),\n};\n\nstatic const struct resource max77650_gpio_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MAX77650_INT_GPI, \"GPI\"),\n};\n\nstatic const struct resource max77650_onkey_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MAX77650_INT_nEN_F, \"nEN_F\"),\n\tDEFINE_RES_IRQ_NAMED(MAX77650_INT_nEN_R, \"nEN_R\"),\n};\n\nstatic const struct mfd_cell max77650_cells[] = {\n\t{\n\t\t.name\t\t= \"max77650-regulator\",\n\t\t.of_compatible\t= \"maxim,max77650-regulator\",\n\t}, {\n\t\t.name\t\t= \"max77650-charger\",\n\t\t.of_compatible\t= \"maxim,max77650-charger\",\n\t\t.resources\t= max77650_charger_resources,\n\t\t.num_resources\t= ARRAY_SIZE(max77650_charger_resources),\n\t}, {\n\t\t.name\t\t= \"max77650-gpio\",\n\t\t.of_compatible\t= \"maxim,max77650-gpio\",\n\t\t.resources\t= max77650_gpio_resources,\n\t\t.num_resources\t= ARRAY_SIZE(max77650_gpio_resources),\n\t}, {\n\t\t.name\t\t= \"max77650-led\",\n\t\t.of_compatible\t= \"maxim,max77650-led\",\n\t}, {\n\t\t.name\t\t= \"max77650-onkey\",\n\t\t.of_compatible\t= \"maxim,max77650-onkey\",\n\t\t.resources\t= max77650_onkey_resources,\n\t\t.num_resources\t= ARRAY_SIZE(max77650_onkey_resources),\n\t},\n};\n\nstatic const struct regmap_irq max77650_irqs[] = {\n\t[MAX77650_INT_GPI] = {\n\t\t.reg_offset = MAX77650_INT_GLBL_OFFSET,\n\t\t.mask = MAX77650_INT_GPI_MSK,\n\t\t.type = {\n\t\t\t.type_falling_val = MAX77650_INT_GPI_F_MSK,\n\t\t\t.type_rising_val = MAX77650_INT_GPI_R_MSK,\n\t\t\t.types_supported = IRQ_TYPE_EDGE_BOTH,\n\t\t},\n\t},\n\tREGMAP_IRQ_REG(MAX77650_INT_nEN_F,\n\t\t       MAX77650_INT_GLBL_OFFSET, MAX77650_INT_nEN_F_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_nEN_R,\n\t\t       MAX77650_INT_GLBL_OFFSET, MAX77650_INT_nEN_R_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_TJAL1_R,\n\t\t       MAX77650_INT_GLBL_OFFSET, MAX77650_INT_TJAL1_R_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_TJAL2_R,\n\t\t       MAX77650_INT_GLBL_OFFSET, MAX77650_INT_TJAL2_R_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_DOD_R,\n\t\t       MAX77650_INT_GLBL_OFFSET, MAX77650_INT_DOD_R_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_THM,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_THM_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_CHG,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_CHG_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_CHGIN,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_CHGIN_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_TJ_REG,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_TJ_REG_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_CHGIN_CTRL,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_CHGIN_CTRL_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_SYS_CTRL,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_SYS_CTRL_MSK),\n\tREGMAP_IRQ_REG(MAX77650_INT_SYS_CNFG,\n\t\t       MAX77650_INT_CHG_OFFSET, MAX77650_INT_SYS_CNFG_MSK),\n};\n\nstatic const struct regmap_irq_chip max77650_irq_chip = {\n\t.name\t\t\t= \"max77650-irq\",\n\t.irqs\t\t\t= max77650_irqs,\n\t.num_irqs\t\t= ARRAY_SIZE(max77650_irqs),\n\t.num_regs\t\t= 2,\n\t.status_base\t\t= MAX77650_REG_INT_GLBL,\n\t.mask_base\t\t= MAX77650_REG_INTM_GLBL,\n\t.type_in_mask\t\t= true,\n\t.init_ack_masked\t= true,\n\t.clear_on_unmask\t= true,\n};\n\nstatic const struct regmap_config max77650_regmap_config = {\n\t.name\t\t= \"max77650\",\n\t.reg_bits\t= 8,\n\t.val_bits\t= 8,\n};\n\nstatic int max77650_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct regmap_irq_chip_data *irq_data;\n\tstruct device *dev = &i2c->dev;\n\tstruct irq_domain *domain;\n\tstruct regmap *map;\n\tunsigned int val;\n\tint rv, id;\n\n\tmap = devm_regmap_init_i2c(i2c, &max77650_regmap_config);\n\tif (IS_ERR(map)) {\n\t\tdev_err(dev, \"Unable to initialise I2C Regmap\\n\");\n\t\treturn PTR_ERR(map);\n\t}\n\n\trv = regmap_read(map, MAX77650_REG_CID, &val);\n\tif (rv) {\n\t\tdev_err(dev, \"Unable to read Chip ID\\n\");\n\t\treturn rv;\n\t}\n\n\tid = MAX77650_CID_BITS(val);\n\tswitch (id) {\n\tcase MAX77650_CID_77650A:\n\tcase MAX77650_CID_77650C:\n\tcase MAX77650_CID_77651A:\n\tcase MAX77650_CID_77651B:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"Chip not supported - ID: 0x%02x\\n\", id);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\trv = regmap_update_bits(map,\n\t\t\t\tMAX77650_REG_CNFG_GLBL,\n\t\t\t\tMAX77650_SBIA_LPM_MASK,\n\t\t\t\tMAX77650_SBIA_LPM_DISABLED);\n\tif (rv) {\n\t\tdev_err(dev, \"Unable to change the power mode\\n\");\n\t\treturn rv;\n\t}\n\n\trv = devm_regmap_add_irq_chip(dev, map, i2c->irq,\n\t\t\t\t      IRQF_ONESHOT | IRQF_SHARED, 0,\n\t\t\t\t      &max77650_irq_chip, &irq_data);\n\tif (rv) {\n\t\tdev_err(dev, \"Unable to add Regmap IRQ chip\\n\");\n\t\treturn rv;\n\t}\n\n\tdomain = regmap_irq_get_domain(irq_data);\n\n\treturn devm_mfd_add_devices(dev, PLATFORM_DEVID_NONE,\n\t\t\t\t    max77650_cells, ARRAY_SIZE(max77650_cells),\n\t\t\t\t    NULL, 0, domain);\n}\n\nstatic const struct of_device_id max77650_of_match[] = {\n\t{ .compatible = \"maxim,max77650\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max77650_of_match);\n\nstatic struct i2c_driver max77650_i2c_driver = {\n\t.driver = {\n\t\t.name = \"max77650\",\n\t\t.of_match_table = max77650_of_match,\n\t},\n\t.probe = max77650_i2c_probe,\n};\nmodule_i2c_driver(max77650_i2c_driver);\n\nMODULE_DESCRIPTION(\"MAXIM 77650/77651 multi-function core driver\");\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}