{
  "module_name": "atmel-hlcdc.c",
  "hash_id": "9c081117d8b883ac1e234c60d96721b649a3bb72beeabf35eaf45b42a1391630",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/atmel-hlcdc.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/iopoll.h>\n#include <linux/mfd/atmel-hlcdc.h>\n#include <linux/mfd/core.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define ATMEL_HLCDC_REG_MAX\t\t(0x4000 - 0x4)\n\nstruct atmel_hlcdc_regmap {\n\tvoid __iomem *regs;\n\tstruct device *dev;\n};\n\nstatic const struct mfd_cell atmel_hlcdc_cells[] = {\n\t{\n\t\t.name = \"atmel-hlcdc-pwm\",\n\t\t.of_compatible = \"atmel,hlcdc-pwm\",\n\t},\n\t{\n\t\t.name = \"atmel-hlcdc-dc\",\n\t\t.of_compatible = \"atmel,hlcdc-display-controller\",\n\t},\n};\n\nstatic int regmap_atmel_hlcdc_reg_write(void *context, unsigned int reg,\n\t\t\t\t\tunsigned int val)\n{\n\tstruct atmel_hlcdc_regmap *hregmap = context;\n\n\tif (reg <= ATMEL_HLCDC_DIS) {\n\t\tu32 status;\n\t\tint ret;\n\n\t\tret = readl_poll_timeout_atomic(hregmap->regs + ATMEL_HLCDC_SR,\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\t!(status & ATMEL_HLCDC_SIP),\n\t\t\t\t\t\t1, 100);\n\t\tif (ret) {\n\t\t\tdev_err(hregmap->dev,\n\t\t\t\t\"Timeout! Clock domain synchronization is in progress!\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\twritel(val, hregmap->regs + reg);\n\n\treturn 0;\n}\n\nstatic int regmap_atmel_hlcdc_reg_read(void *context, unsigned int reg,\n\t\t\t\t       unsigned int *val)\n{\n\tstruct atmel_hlcdc_regmap *hregmap = context;\n\n\t*val = readl(hregmap->regs + reg);\n\n\treturn 0;\n}\n\nstatic const struct regmap_config atmel_hlcdc_regmap_config = {\n\t.reg_bits = 32,\n\t.val_bits = 32,\n\t.reg_stride = 4,\n\t.max_register = ATMEL_HLCDC_REG_MAX,\n\t.reg_write = regmap_atmel_hlcdc_reg_write,\n\t.reg_read = regmap_atmel_hlcdc_reg_read,\n\t.fast_io = true,\n};\n\nstatic int atmel_hlcdc_probe(struct platform_device *pdev)\n{\n\tstruct atmel_hlcdc_regmap *hregmap;\n\tstruct device *dev = &pdev->dev;\n\tstruct atmel_hlcdc *hlcdc;\n\n\thregmap = devm_kzalloc(dev, sizeof(*hregmap), GFP_KERNEL);\n\tif (!hregmap)\n\t\treturn -ENOMEM;\n\n\thlcdc = devm_kzalloc(dev, sizeof(*hlcdc), GFP_KERNEL);\n\tif (!hlcdc)\n\t\treturn -ENOMEM;\n\n\thregmap->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(hregmap->regs))\n\t\treturn PTR_ERR(hregmap->regs);\n\n\thregmap->dev = &pdev->dev;\n\n\thlcdc->irq = platform_get_irq(pdev, 0);\n\tif (hlcdc->irq < 0)\n\t\treturn hlcdc->irq;\n\n\thlcdc->periph_clk = devm_clk_get(dev, \"periph_clk\");\n\tif (IS_ERR(hlcdc->periph_clk)) {\n\t\tdev_err(dev, \"failed to get peripheral clock\\n\");\n\t\treturn PTR_ERR(hlcdc->periph_clk);\n\t}\n\n\thlcdc->sys_clk = devm_clk_get(dev, \"sys_clk\");\n\tif (IS_ERR(hlcdc->sys_clk)) {\n\t\tdev_err(dev, \"failed to get system clock\\n\");\n\t\treturn PTR_ERR(hlcdc->sys_clk);\n\t}\n\n\thlcdc->slow_clk = devm_clk_get(dev, \"slow_clk\");\n\tif (IS_ERR(hlcdc->slow_clk)) {\n\t\tdev_err(dev, \"failed to get slow clock\\n\");\n\t\treturn PTR_ERR(hlcdc->slow_clk);\n\t}\n\n\thlcdc->regmap = devm_regmap_init(dev, NULL, hregmap,\n\t\t\t\t\t &atmel_hlcdc_regmap_config);\n\tif (IS_ERR(hlcdc->regmap))\n\t\treturn PTR_ERR(hlcdc->regmap);\n\n\tdev_set_drvdata(dev, hlcdc);\n\n\treturn devm_mfd_add_devices(dev, -1, atmel_hlcdc_cells,\n\t\t\t\t    ARRAY_SIZE(atmel_hlcdc_cells),\n\t\t\t\t    NULL, 0, NULL);\n}\n\nstatic const struct of_device_id atmel_hlcdc_match[] = {\n\t{ .compatible = \"atmel,at91sam9n12-hlcdc\" },\n\t{ .compatible = \"atmel,at91sam9x5-hlcdc\" },\n\t{ .compatible = \"atmel,sama5d2-hlcdc\" },\n\t{ .compatible = \"atmel,sama5d3-hlcdc\" },\n\t{ .compatible = \"atmel,sama5d4-hlcdc\" },\n\t{ .compatible = \"microchip,sam9x60-hlcdc\" },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, atmel_hlcdc_match);\n\nstatic struct platform_driver atmel_hlcdc_driver = {\n\t.probe = atmel_hlcdc_probe,\n\t.driver = {\n\t\t.name = \"atmel-hlcdc\",\n\t\t.of_match_table = atmel_hlcdc_match,\n\t},\n};\nmodule_platform_driver(atmel_hlcdc_driver);\n\nMODULE_ALIAS(\"platform:atmel-hlcdc\");\nMODULE_AUTHOR(\"Boris Brezillon <boris.brezillon@free-electrons.com>\");\nMODULE_DESCRIPTION(\"Atmel HLCDC driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}