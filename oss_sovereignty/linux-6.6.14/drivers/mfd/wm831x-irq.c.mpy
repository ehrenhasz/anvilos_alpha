{
  "module_name": "wm831x-irq.c",
  "hash_id": "a731c1c5d99065b223ab3c359373edfecab3a59569fb90a77d2a4e21d0c54e4c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/wm831x-irq.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/i2c.h>\n#include <linux/irq.h>\n#include <linux/mfd/core.h>\n#include <linux/interrupt.h>\n#include <linux/irqdomain.h>\n\n#include <linux/mfd/wm831x/core.h>\n#include <linux/mfd/wm831x/pdata.h>\n#include <linux/mfd/wm831x/gpio.h>\n#include <linux/mfd/wm831x/irq.h>\n\n#include <linux/delay.h>\n\nstruct wm831x_irq_data {\n\tint primary;\n\tint reg;\n\tint mask;\n};\n\nstatic struct wm831x_irq_data wm831x_irqs[] = {\n\t[WM831X_IRQ_TEMP_THW] = {\n\t\t.primary = WM831X_TEMP_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_TEMP_THW_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_1] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP1_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_2] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP2_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_3] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP3_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_4] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP4_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_5] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP5_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_6] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP6_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_7] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP7_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_8] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP8_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_9] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP9_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_10] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP10_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_11] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP11_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_12] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP12_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_13] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP13_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_14] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP14_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_15] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP15_EINT,\n\t},\n\t[WM831X_IRQ_GPIO_16] = {\n\t\t.primary = WM831X_GP_INT,\n\t\t.reg = 5,\n\t\t.mask = WM831X_GP16_EINT,\n\t},\n\t[WM831X_IRQ_ON] = {\n\t\t.primary = WM831X_ON_PIN_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_ON_PIN_EINT,\n\t},\n\t[WM831X_IRQ_PPM_SYSLO] = {\n\t\t.primary = WM831X_PPM_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_PPM_SYSLO_EINT,\n\t},\n\t[WM831X_IRQ_PPM_PWR_SRC] = {\n\t\t.primary = WM831X_PPM_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_PPM_PWR_SRC_EINT,\n\t},\n\t[WM831X_IRQ_PPM_USB_CURR] = {\n\t\t.primary = WM831X_PPM_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_PPM_USB_CURR_EINT,\n\t},\n\t[WM831X_IRQ_WDOG_TO] = {\n\t\t.primary = WM831X_WDOG_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_WDOG_TO_EINT,\n\t},\n\t[WM831X_IRQ_RTC_PER] = {\n\t\t.primary = WM831X_RTC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_RTC_PER_EINT,\n\t},\n\t[WM831X_IRQ_RTC_ALM] = {\n\t\t.primary = WM831X_RTC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_RTC_ALM_EINT,\n\t},\n\t[WM831X_IRQ_CHG_BATT_HOT] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_BATT_HOT_EINT,\n\t},\n\t[WM831X_IRQ_CHG_BATT_COLD] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_BATT_COLD_EINT,\n\t},\n\t[WM831X_IRQ_CHG_BATT_FAIL] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_BATT_FAIL_EINT,\n\t},\n\t[WM831X_IRQ_CHG_OV] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_OV_EINT,\n\t},\n\t[WM831X_IRQ_CHG_END] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_END_EINT,\n\t},\n\t[WM831X_IRQ_CHG_TO] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_TO_EINT,\n\t},\n\t[WM831X_IRQ_CHG_MODE] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_MODE_EINT,\n\t},\n\t[WM831X_IRQ_CHG_START] = {\n\t\t.primary = WM831X_CHG_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CHG_START_EINT,\n\t},\n\t[WM831X_IRQ_TCHDATA] = {\n\t\t.primary = WM831X_TCHDATA_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_TCHDATA_EINT,\n\t},\n\t[WM831X_IRQ_TCHPD] = {\n\t\t.primary = WM831X_TCHPD_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_TCHPD_EINT,\n\t},\n\t[WM831X_IRQ_AUXADC_DATA] = {\n\t\t.primary = WM831X_AUXADC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_AUXADC_DATA_EINT,\n\t},\n\t[WM831X_IRQ_AUXADC_DCOMP1] = {\n\t\t.primary = WM831X_AUXADC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_AUXADC_DCOMP1_EINT,\n\t},\n\t[WM831X_IRQ_AUXADC_DCOMP2] = {\n\t\t.primary = WM831X_AUXADC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_AUXADC_DCOMP2_EINT,\n\t},\n\t[WM831X_IRQ_AUXADC_DCOMP3] = {\n\t\t.primary = WM831X_AUXADC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_AUXADC_DCOMP3_EINT,\n\t},\n\t[WM831X_IRQ_AUXADC_DCOMP4] = {\n\t\t.primary = WM831X_AUXADC_INT,\n\t\t.reg = 1,\n\t\t.mask = WM831X_AUXADC_DCOMP4_EINT,\n\t},\n\t[WM831X_IRQ_CS1] = {\n\t\t.primary = WM831X_CS_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CS1_EINT,\n\t},\n\t[WM831X_IRQ_CS2] = {\n\t\t.primary = WM831X_CS_INT,\n\t\t.reg = 2,\n\t\t.mask = WM831X_CS2_EINT,\n\t},\n\t[WM831X_IRQ_HC_DC1] = {\n\t\t.primary = WM831X_HC_INT,\n\t\t.reg = 4,\n\t\t.mask = WM831X_HC_DC1_EINT,\n\t},\n\t[WM831X_IRQ_HC_DC2] = {\n\t\t.primary = WM831X_HC_INT,\n\t\t.reg = 4,\n\t\t.mask = WM831X_HC_DC2_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO1] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO1_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO2] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO2_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO3] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO3_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO4] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO4_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO5] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO5_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO6] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO6_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO7] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO7_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO8] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO8_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO9] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO9_EINT,\n\t},\n\t[WM831X_IRQ_UV_LDO10] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 3,\n\t\t.mask = WM831X_UV_LDO10_EINT,\n\t},\n\t[WM831X_IRQ_UV_DC1] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 4,\n\t\t.mask = WM831X_UV_DC1_EINT,\n\t},\n\t[WM831X_IRQ_UV_DC2] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 4,\n\t\t.mask = WM831X_UV_DC2_EINT,\n\t},\n\t[WM831X_IRQ_UV_DC3] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 4,\n\t\t.mask = WM831X_UV_DC3_EINT,\n\t},\n\t[WM831X_IRQ_UV_DC4] = {\n\t\t.primary = WM831X_UV_INT,\n\t\t.reg = 4,\n\t\t.mask = WM831X_UV_DC4_EINT,\n\t},\n};\n\nstatic inline int irq_data_to_status_reg(struct wm831x_irq_data *irq_data)\n{\n\treturn WM831X_INTERRUPT_STATUS_1 - 1 + irq_data->reg;\n}\n\nstatic inline struct wm831x_irq_data *irq_to_wm831x_irq(struct wm831x *wm831x,\n\t\t\t\t\t\t\tint irq)\n{\n\treturn &wm831x_irqs[irq];\n}\n\nstatic void wm831x_irq_lock(struct irq_data *data)\n{\n\tstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\n\n\tmutex_lock(&wm831x->irq_lock);\n}\n\nstatic void wm831x_irq_sync_unlock(struct irq_data *data)\n{\n\tstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(wm831x->gpio_update); i++) {\n\t\tif (wm831x->gpio_update[i]) {\n\t\t\twm831x_set_bits(wm831x, WM831X_GPIO1_CONTROL + i,\n\t\t\t\t\tWM831X_GPN_INT_MODE | WM831X_GPN_POL,\n\t\t\t\t\twm831x->gpio_update[i]);\n\t\t\twm831x->gpio_update[i] = 0;\n\t\t}\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(wm831x->irq_masks_cur); i++) {\n\t\t \n\t\tif (wm831x->irq_masks_cur[i] != wm831x->irq_masks_cache[i]) {\n\t\t\tdev_dbg(wm831x->dev, \"IRQ mask sync: %x = %x\\n\",\n\t\t\t\tWM831X_INTERRUPT_STATUS_1_MASK + i,\n\t\t\t\twm831x->irq_masks_cur[i]);\n\n\t\t\twm831x->irq_masks_cache[i] = wm831x->irq_masks_cur[i];\n\t\t\twm831x_reg_write(wm831x,\n\t\t\t\t\t WM831X_INTERRUPT_STATUS_1_MASK + i,\n\t\t\t\t\t wm831x->irq_masks_cur[i]);\n\t\t}\n\t}\n\n\tmutex_unlock(&wm831x->irq_lock);\n}\n\nstatic void wm831x_irq_enable(struct irq_data *data)\n{\n\tstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\n\tstruct wm831x_irq_data *irq_data = irq_to_wm831x_irq(wm831x,\n\t\t\t\t\t\t\t     data->hwirq);\n\n\twm831x->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\n}\n\nstatic void wm831x_irq_disable(struct irq_data *data)\n{\n\tstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\n\tstruct wm831x_irq_data *irq_data = irq_to_wm831x_irq(wm831x,\n\t\t\t\t\t\t\t     data->hwirq);\n\n\twm831x->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\n}\n\nstatic int wm831x_irq_set_type(struct irq_data *data, unsigned int type)\n{\n\tstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\n\tint irq;\n\n\tirq = data->hwirq;\n\n\tif (irq < WM831X_IRQ_GPIO_1 || irq > WM831X_IRQ_GPIO_11) {\n\t\t \n\t\tif (irq >= 0 && irq < WM831X_NUM_IRQS)\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn -EINVAL;\n\t}\n\n\t \n\tirq -= WM831X_IRQ_GPIO_1;\n\n\t \n\twm831x->gpio_level_low[irq] = false;\n\twm831x->gpio_level_high[irq] = false;\n\tswitch (type) {\n\tcase IRQ_TYPE_EDGE_BOTH:\n\t\twm831x->gpio_update[irq] = 0x10000 | WM831X_GPN_INT_MODE;\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_RISING:\n\t\twm831x->gpio_update[irq] = 0x10000 | WM831X_GPN_POL;\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_FALLING:\n\t\twm831x->gpio_update[irq] = 0x10000;\n\t\tbreak;\n\tcase IRQ_TYPE_LEVEL_HIGH:\n\t\twm831x->gpio_update[irq] = 0x10000 | WM831X_GPN_POL;\n\t\twm831x->gpio_level_high[irq] = true;\n\t\tbreak;\n\tcase IRQ_TYPE_LEVEL_LOW:\n\t\twm831x->gpio_update[irq] = 0x10000;\n\t\twm831x->gpio_level_low[irq] = true;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic struct irq_chip wm831x_irq_chip = {\n\t.name\t\t\t= \"wm831x\",\n\t.irq_bus_lock\t\t= wm831x_irq_lock,\n\t.irq_bus_sync_unlock\t= wm831x_irq_sync_unlock,\n\t.irq_disable\t\t= wm831x_irq_disable,\n\t.irq_enable\t\t= wm831x_irq_enable,\n\t.irq_set_type\t\t= wm831x_irq_set_type,\n};\n\n \nstatic irqreturn_t wm831x_irq_thread(int irq, void *data)\n{\n\tstruct wm831x *wm831x = data;\n\tunsigned int i;\n\tint primary, status_addr, ret;\n\tint status_regs[WM831X_NUM_IRQ_REGS] = { 0 };\n\tint read[WM831X_NUM_IRQ_REGS] = { 0 };\n\tint *status;\n\n\tprimary = wm831x_reg_read(wm831x, WM831X_SYSTEM_INTERRUPTS);\n\tif (primary < 0) {\n\t\tdev_err(wm831x->dev, \"Failed to read system interrupt: %d\\n\",\n\t\t\tprimary);\n\t\tgoto out;\n\t}\n\n\t \n\tif (primary & WM831X_TCHPD_INT)\n\t\thandle_nested_irq(irq_find_mapping(wm831x->irq_domain,\n\t\t\t\t\t\t   WM831X_IRQ_TCHPD));\n\tif (primary & WM831X_TCHDATA_INT)\n\t\thandle_nested_irq(irq_find_mapping(wm831x->irq_domain,\n\t\t\t\t\t\t   WM831X_IRQ_TCHDATA));\n\tprimary &= ~(WM831X_TCHDATA_EINT | WM831X_TCHPD_EINT);\n\n\tfor (i = 0; i < ARRAY_SIZE(wm831x_irqs); i++) {\n\t\tint offset = wm831x_irqs[i].reg - 1;\n\n\t\tif (!(primary & wm831x_irqs[i].primary))\n\t\t\tcontinue;\n\n\t\tstatus = &status_regs[offset];\n\n\t\t \n\t\tif (!read[offset]) {\n\t\t\tstatus_addr = irq_data_to_status_reg(&wm831x_irqs[i]);\n\n\t\t\t*status = wm831x_reg_read(wm831x, status_addr);\n\t\t\tif (*status < 0) {\n\t\t\t\tdev_err(wm831x->dev,\n\t\t\t\t\t\"Failed to read IRQ status: %d\\n\",\n\t\t\t\t\t*status);\n\t\t\t\tgoto out;\n\t\t\t}\n\n\t\t\tread[offset] = 1;\n\n\t\t\t \n\t\t\t*status &= ~wm831x->irq_masks_cur[offset];\n\n\t\t\t \n\t\t\twm831x_reg_write(wm831x, status_addr, *status);\n\t\t}\n\n\t\tif (*status & wm831x_irqs[i].mask)\n\t\t\thandle_nested_irq(irq_find_mapping(wm831x->irq_domain,\n\t\t\t\t\t\t\t   i));\n\n\t\t \n\t\tif (primary == WM831X_GP_INT &&\n\t\t    wm831x->gpio_level_high[i - WM831X_IRQ_GPIO_1]) {\n\t\t\tret = wm831x_reg_read(wm831x, WM831X_GPIO_LEVEL);\n\t\t\twhile (ret & 1 << (i - WM831X_IRQ_GPIO_1)) {\n\t\t\t\thandle_nested_irq(irq_find_mapping(wm831x->irq_domain,\n\t\t\t\t\t\t\t\t   i));\n\t\t\t\tret = wm831x_reg_read(wm831x,\n\t\t\t\t\t\t      WM831X_GPIO_LEVEL);\n\t\t\t}\n\t\t}\n\n\t\tif (primary == WM831X_GP_INT &&\n\t\t    wm831x->gpio_level_low[i - WM831X_IRQ_GPIO_1]) {\n\t\t\tret = wm831x_reg_read(wm831x, WM831X_GPIO_LEVEL);\n\t\t\twhile (!(ret & 1 << (i - WM831X_IRQ_GPIO_1))) {\n\t\t\t\thandle_nested_irq(irq_find_mapping(wm831x->irq_domain,\n\t\t\t\t\t\t\t\t   i));\n\t\t\t\tret = wm831x_reg_read(wm831x,\n\t\t\t\t\t\t      WM831X_GPIO_LEVEL);\n\t\t\t}\n\t\t}\n\t}\n\nout:\n\treturn IRQ_HANDLED;\n}\n\nstatic int wm831x_irq_map(struct irq_domain *h, unsigned int virq,\n\t\t\t  irq_hw_number_t hw)\n{\n\tirq_set_chip_data(virq, h->host_data);\n\tirq_set_chip_and_handler(virq, &wm831x_irq_chip, handle_edge_irq);\n\tirq_set_nested_thread(virq, 1);\n\tirq_set_noprobe(virq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops wm831x_irq_domain_ops = {\n\t.map\t= wm831x_irq_map,\n\t.xlate\t= irq_domain_xlate_twocell,\n};\n\nint wm831x_irq_init(struct wm831x *wm831x, int irq)\n{\n\tstruct wm831x_pdata *pdata = &wm831x->pdata;\n\tstruct irq_domain *domain;\n\tint i, ret, irq_base;\n\n\tmutex_init(&wm831x->irq_lock);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(wm831x->irq_masks_cur); i++) {\n\t\twm831x->irq_masks_cur[i] = 0xffff;\n\t\twm831x->irq_masks_cache[i] = 0xffff;\n\t\twm831x_reg_write(wm831x, WM831X_INTERRUPT_STATUS_1_MASK + i,\n\t\t\t\t 0xffff);\n\t}\n\n\t \n\tif (pdata->irq_base) {\n\t\tirq_base = irq_alloc_descs(pdata->irq_base, 0,\n\t\t\t\t\t   WM831X_NUM_IRQS, 0);\n\t\tif (irq_base < 0) {\n\t\t\tdev_warn(wm831x->dev, \"Failed to allocate IRQs: %d\\n\",\n\t\t\t\t irq_base);\n\t\t\tirq_base = 0;\n\t\t}\n\t} else {\n\t\tirq_base = 0;\n\t}\n\n\tif (irq_base)\n\t\tdomain = irq_domain_add_legacy(wm831x->dev->of_node,\n\t\t\t\t\t       ARRAY_SIZE(wm831x_irqs),\n\t\t\t\t\t       irq_base, 0,\n\t\t\t\t\t       &wm831x_irq_domain_ops,\n\t\t\t\t\t       wm831x);\n\telse\n\t\tdomain = irq_domain_add_linear(wm831x->dev->of_node,\n\t\t\t\t\t       ARRAY_SIZE(wm831x_irqs),\n\t\t\t\t\t       &wm831x_irq_domain_ops,\n\t\t\t\t\t       wm831x);\n\n\tif (!domain) {\n\t\tdev_warn(wm831x->dev, \"Failed to allocate IRQ domain\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (pdata->irq_cmos)\n\t\ti = 0;\n\telse\n\t\ti = WM831X_IRQ_OD;\n\n\twm831x_set_bits(wm831x, WM831X_IRQ_CONFIG,\n\t\t\tWM831X_IRQ_OD, i);\n\n\twm831x->irq = irq;\n\twm831x->irq_domain = domain;\n\n\tif (irq) {\n\t\t \n\t\tret = enable_irq_wake(irq);\n\t\tif (ret != 0) {\n\t\t\tdev_warn(wm831x->dev,\n\t\t\t\t \"Can't enable IRQ as wake source: %d\\n\",\n\t\t\t\t ret);\n\t\t}\n\n\t\tret = request_threaded_irq(irq, NULL, wm831x_irq_thread,\n\t\t\t\t\t   IRQF_TRIGGER_LOW | IRQF_ONESHOT,\n\t\t\t\t\t   \"wm831x\", wm831x);\n\t\tif (ret != 0) {\n\t\t\tdev_err(wm831x->dev, \"Failed to request IRQ %d: %d\\n\",\n\t\t\t\tirq, ret);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tdev_warn(wm831x->dev,\n\t\t\t \"No interrupt specified - functionality limited\\n\");\n\t}\n\n\t \n\twm831x_reg_write(wm831x, WM831X_SYSTEM_INTERRUPTS_MASK, 0);\n\n\treturn 0;\n}\n\nvoid wm831x_irq_exit(struct wm831x *wm831x)\n{\n\tif (wm831x->irq)\n\t\tfree_irq(wm831x->irq, wm831x);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}