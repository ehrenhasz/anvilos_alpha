{
  "module_name": "max8925-core.c",
  "hash_id": "a91125ecd3f3f29683a143c7d78b198f35b06a806516be69270f96c9b7db32b5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max8925-core.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/i2c.h>\n#include <linux/irq.h>\n#include <linux/interrupt.h>\n#include <linux/irqdomain.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/machine.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max8925.h>\n#include <linux/of.h>\n\nstatic const struct resource bk_resources[] = {\n\t{ 0x84, 0x84, \"mode control\", IORESOURCE_REG, },\n\t{ 0x85, 0x85, \"control\",      IORESOURCE_REG, },\n};\n\nstatic struct mfd_cell bk_devs[] = {\n\t{\n\t\t.name\t\t= \"max8925-backlight\",\n\t\t.num_resources\t= ARRAY_SIZE(bk_resources),\n\t\t.resources\t= &bk_resources[0],\n\t\t.id\t\t= -1,\n\t},\n};\n\nstatic const struct resource touch_resources[] = {\n\t{\n\t\t.name\t= \"max8925-tsc\",\n\t\t.start\t= MAX8925_TSC_IRQ,\n\t\t.end\t= MAX8925_ADC_RES_END,\n\t\t.flags\t= IORESOURCE_REG,\n\t},\n};\n\nstatic const struct mfd_cell touch_devs[] = {\n\t{\n\t\t.name\t\t= \"max8925-touch\",\n\t\t.num_resources\t= 1,\n\t\t.resources\t= &touch_resources[0],\n\t\t.id\t\t= -1,\n\t},\n};\n\nstatic const struct resource power_supply_resources[] = {\n\t{\n\t\t.name\t= \"max8925-power\",\n\t\t.start\t= MAX8925_CHG_IRQ1,\n\t\t.end\t= MAX8925_CHG_IRQ1_MASK,\n\t\t.flags\t= IORESOURCE_REG,\n\t},\n};\n\nstatic const struct mfd_cell power_devs[] = {\n\t{\n\t\t.name\t\t= \"max8925-power\",\n\t\t.num_resources\t= 1,\n\t\t.resources\t= &power_supply_resources[0],\n\t\t.id\t\t= -1,\n\t},\n};\n\nstatic const struct resource rtc_resources[] = {\n\t{\n\t\t.name\t= \"max8925-rtc\",\n\t\t.start\t= MAX8925_IRQ_RTC_ALARM0,\n\t\t.end\t= MAX8925_IRQ_RTC_ALARM0,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct mfd_cell rtc_devs[] = {\n\t{\n\t\t.name\t\t= \"max8925-rtc\",\n\t\t.num_resources\t= 1,\n\t\t.resources\t= &rtc_resources[0],\n\t\t.id\t\t= -1,\n\t},\n};\n\nstatic const struct resource onkey_resources[] = {\n\t{\n\t\t.name\t= \"max8925-onkey\",\n\t\t.start\t= MAX8925_IRQ_GPM_SW_R,\n\t\t.end\t= MAX8925_IRQ_GPM_SW_R,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t}, {\n\t\t.name\t= \"max8925-onkey\",\n\t\t.start\t= MAX8925_IRQ_GPM_SW_F,\n\t\t.end\t= MAX8925_IRQ_GPM_SW_F,\n\t\t.flags\t= IORESOURCE_IRQ,\n\t},\n};\n\nstatic const struct mfd_cell onkey_devs[] = {\n\t{\n\t\t.name\t\t= \"max8925-onkey\",\n\t\t.num_resources\t= 2,\n\t\t.resources\t= &onkey_resources[0],\n\t\t.id\t\t= -1,\n\t},\n};\n\nstatic const struct resource sd1_resources[] = {\n\t{0x06, 0x06, \"sdv\", IORESOURCE_REG, },\n};\n\nstatic const struct resource sd2_resources[] = {\n\t{0x09, 0x09, \"sdv\", IORESOURCE_REG, },\n};\n\nstatic const struct resource sd3_resources[] = {\n\t{0x0c, 0x0c, \"sdv\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo1_resources[] = {\n\t{0x1a, 0x1a, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo2_resources[] = {\n\t{0x1e, 0x1e, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo3_resources[] = {\n\t{0x22, 0x22, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo4_resources[] = {\n\t{0x26, 0x26, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo5_resources[] = {\n\t{0x2a, 0x2a, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo6_resources[] = {\n\t{0x2e, 0x2e, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo7_resources[] = {\n\t{0x32, 0x32, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo8_resources[] = {\n\t{0x36, 0x36, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo9_resources[] = {\n\t{0x3a, 0x3a, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo10_resources[] = {\n\t{0x3e, 0x3e, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo11_resources[] = {\n\t{0x42, 0x42, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo12_resources[] = {\n\t{0x46, 0x46, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo13_resources[] = {\n\t{0x4a, 0x4a, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo14_resources[] = {\n\t{0x4e, 0x4e, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo15_resources[] = {\n\t{0x52, 0x52, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo16_resources[] = {\n\t{0x12, 0x12, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo17_resources[] = {\n\t{0x16, 0x16, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo18_resources[] = {\n\t{0x74, 0x74, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo19_resources[] = {\n\t{0x5e, 0x5e, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic const struct resource ldo20_resources[] = {\n\t{0x9e, 0x9e, \"ldov\", IORESOURCE_REG, },\n};\n\nstatic struct mfd_cell reg_devs[] = {\n\t{\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 0,\n\t\t.num_resources = ARRAY_SIZE(sd1_resources),\n\t\t.resources = sd1_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 1,\n\t\t.num_resources = ARRAY_SIZE(sd2_resources),\n\t\t.resources = sd2_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 2,\n\t\t.num_resources = ARRAY_SIZE(sd3_resources),\n\t\t.resources = sd3_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 3,\n\t\t.num_resources = ARRAY_SIZE(ldo1_resources),\n\t\t.resources = ldo1_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 4,\n\t\t.num_resources = ARRAY_SIZE(ldo2_resources),\n\t\t.resources = ldo2_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 5,\n\t\t.num_resources = ARRAY_SIZE(ldo3_resources),\n\t\t.resources = ldo3_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 6,\n\t\t.num_resources = ARRAY_SIZE(ldo4_resources),\n\t\t.resources = ldo4_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 7,\n\t\t.num_resources = ARRAY_SIZE(ldo5_resources),\n\t\t.resources = ldo5_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 8,\n\t\t.num_resources = ARRAY_SIZE(ldo6_resources),\n\t\t.resources = ldo6_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 9,\n\t\t.num_resources = ARRAY_SIZE(ldo7_resources),\n\t\t.resources = ldo7_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 10,\n\t\t.num_resources = ARRAY_SIZE(ldo8_resources),\n\t\t.resources = ldo8_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 11,\n\t\t.num_resources = ARRAY_SIZE(ldo9_resources),\n\t\t.resources = ldo9_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 12,\n\t\t.num_resources = ARRAY_SIZE(ldo10_resources),\n\t\t.resources = ldo10_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 13,\n\t\t.num_resources = ARRAY_SIZE(ldo11_resources),\n\t\t.resources = ldo11_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 14,\n\t\t.num_resources = ARRAY_SIZE(ldo12_resources),\n\t\t.resources = ldo12_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 15,\n\t\t.num_resources = ARRAY_SIZE(ldo13_resources),\n\t\t.resources = ldo13_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 16,\n\t\t.num_resources = ARRAY_SIZE(ldo14_resources),\n\t\t.resources = ldo14_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 17,\n\t\t.num_resources = ARRAY_SIZE(ldo15_resources),\n\t\t.resources = ldo15_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 18,\n\t\t.num_resources = ARRAY_SIZE(ldo16_resources),\n\t\t.resources = ldo16_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 19,\n\t\t.num_resources = ARRAY_SIZE(ldo17_resources),\n\t\t.resources = ldo17_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 20,\n\t\t.num_resources = ARRAY_SIZE(ldo18_resources),\n\t\t.resources = ldo18_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 21,\n\t\t.num_resources = ARRAY_SIZE(ldo19_resources),\n\t\t.resources = ldo19_resources,\n\t}, {\n\t\t.name = \"max8925-regulator\",\n\t\t.id = 22,\n\t\t.num_resources = ARRAY_SIZE(ldo20_resources),\n\t\t.resources = ldo20_resources,\n\t},\n};\n\nenum {\n\tFLAGS_ADC = 1,\t \n\tFLAGS_RTC,\t \n};\n\nstruct max8925_irq_data {\n\tint\treg;\n\tint\tmask_reg;\n\tint\tenable;\t\t \n\tint\toffs;\t\t \n\tint\tflags;\n\tint\ttsc_irq;\n};\n\nstatic struct max8925_irq_data max8925_irqs[] = {\n\t[MAX8925_IRQ_VCHG_DC_OVP] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ1,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 0,\n\t},\n\t[MAX8925_IRQ_VCHG_DC_F] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ1,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 1,\n\t},\n\t[MAX8925_IRQ_VCHG_DC_R] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ1,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 2,\n\t},\n\t[MAX8925_IRQ_VCHG_THM_OK_R] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 0,\n\t},\n\t[MAX8925_IRQ_VCHG_THM_OK_F] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 1,\n\t},\n\t[MAX8925_IRQ_VCHG_SYSLOW_F] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 2,\n\t},\n\t[MAX8925_IRQ_VCHG_SYSLOW_R] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 3,\n\t},\n\t[MAX8925_IRQ_VCHG_RST] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 4,\n\t},\n\t[MAX8925_IRQ_VCHG_DONE] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 5,\n\t},\n\t[MAX8925_IRQ_VCHG_TOPOFF] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 6,\n\t},\n\t[MAX8925_IRQ_VCHG_TMR_FAULT] = {\n\t\t.reg\t\t= MAX8925_CHG_IRQ2,\n\t\t.mask_reg\t= MAX8925_CHG_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 7,\n\t},\n\t[MAX8925_IRQ_GPM_RSTIN] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 0,\n\t},\n\t[MAX8925_IRQ_GPM_MPL] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 1,\n\t},\n\t[MAX8925_IRQ_GPM_SW_3SEC] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 2,\n\t},\n\t[MAX8925_IRQ_GPM_EXTON_F] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 3,\n\t},\n\t[MAX8925_IRQ_GPM_EXTON_R] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 4,\n\t},\n\t[MAX8925_IRQ_GPM_SW_1SEC] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 5,\n\t},\n\t[MAX8925_IRQ_GPM_SW_F] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 6,\n\t},\n\t[MAX8925_IRQ_GPM_SW_R] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ1,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ1_MASK,\n\t\t.offs\t\t= 1 << 7,\n\t},\n\t[MAX8925_IRQ_GPM_SYSCKEN_F] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ2,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 0,\n\t},\n\t[MAX8925_IRQ_GPM_SYSCKEN_R] = {\n\t\t.reg\t\t= MAX8925_ON_OFF_IRQ2,\n\t\t.mask_reg\t= MAX8925_ON_OFF_IRQ2_MASK,\n\t\t.offs\t\t= 1 << 1,\n\t},\n\t[MAX8925_IRQ_RTC_ALARM1] = {\n\t\t.reg\t\t= MAX8925_RTC_IRQ,\n\t\t.mask_reg\t= MAX8925_RTC_IRQ_MASK,\n\t\t.offs\t\t= 1 << 2,\n\t\t.flags\t\t= FLAGS_RTC,\n\t},\n\t[MAX8925_IRQ_RTC_ALARM0] = {\n\t\t.reg\t\t= MAX8925_RTC_IRQ,\n\t\t.mask_reg\t= MAX8925_RTC_IRQ_MASK,\n\t\t.offs\t\t= 1 << 3,\n\t\t.flags\t\t= FLAGS_RTC,\n\t},\n\t[MAX8925_IRQ_TSC_STICK] = {\n\t\t.reg\t\t= MAX8925_TSC_IRQ,\n\t\t.mask_reg\t= MAX8925_TSC_IRQ_MASK,\n\t\t.offs\t\t= 1 << 0,\n\t\t.flags\t\t= FLAGS_ADC,\n\t\t.tsc_irq\t= 1,\n\t},\n\t[MAX8925_IRQ_TSC_NSTICK] = {\n\t\t.reg\t\t= MAX8925_TSC_IRQ,\n\t\t.mask_reg\t= MAX8925_TSC_IRQ_MASK,\n\t\t.offs\t\t= 1 << 1,\n\t\t.flags\t\t= FLAGS_ADC,\n\t\t.tsc_irq\t= 1,\n\t},\n};\n\nstatic irqreturn_t max8925_irq(int irq, void *data)\n{\n\tstruct max8925_chip *chip = data;\n\tstruct max8925_irq_data *irq_data;\n\tstruct i2c_client *i2c;\n\tint read_reg = -1, value = 0;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8925_irqs); i++) {\n\t\tirq_data = &max8925_irqs[i];\n\t\t \n\t\tif (irq_data->tsc_irq)\n\t\t\tcontinue;\n\t\tif (irq_data->flags == FLAGS_RTC)\n\t\t\ti2c = chip->rtc;\n\t\telse if (irq_data->flags == FLAGS_ADC)\n\t\t\ti2c = chip->adc;\n\t\telse\n\t\t\ti2c = chip->i2c;\n\t\tif (read_reg != irq_data->reg) {\n\t\t\tread_reg = irq_data->reg;\n\t\t\tvalue = max8925_reg_read(i2c, irq_data->reg);\n\t\t}\n\t\tif (value & irq_data->enable)\n\t\t\thandle_nested_irq(chip->irq_base + i);\n\t}\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t max8925_tsc_irq(int irq, void *data)\n{\n\tstruct max8925_chip *chip = data;\n\tstruct max8925_irq_data *irq_data;\n\tstruct i2c_client *i2c;\n\tint read_reg = -1, value = 0;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(max8925_irqs); i++) {\n\t\tirq_data = &max8925_irqs[i];\n\t\t \n\t\tif (!irq_data->tsc_irq)\n\t\t\tcontinue;\n\t\tif (irq_data->flags == FLAGS_RTC)\n\t\t\ti2c = chip->rtc;\n\t\telse if (irq_data->flags == FLAGS_ADC)\n\t\t\ti2c = chip->adc;\n\t\telse\n\t\t\ti2c = chip->i2c;\n\t\tif (read_reg != irq_data->reg) {\n\t\t\tread_reg = irq_data->reg;\n\t\t\tvalue = max8925_reg_read(i2c, irq_data->reg);\n\t\t}\n\t\tif (value & irq_data->enable)\n\t\t\thandle_nested_irq(chip->irq_base + i);\n\t}\n\treturn IRQ_HANDLED;\n}\n\nstatic void max8925_irq_lock(struct irq_data *data)\n{\n\tstruct max8925_chip *chip = irq_data_get_irq_chip_data(data);\n\n\tmutex_lock(&chip->irq_lock);\n}\n\nstatic void max8925_irq_sync_unlock(struct irq_data *data)\n{\n\tstruct max8925_chip *chip = irq_data_get_irq_chip_data(data);\n\tstruct max8925_irq_data *irq_data;\n\tstatic unsigned char cache_chg[2] = {0xff, 0xff};\n\tstatic unsigned char cache_on[2] = {0xff, 0xff};\n\tstatic unsigned char cache_rtc = 0xff, cache_tsc = 0xff;\n\tunsigned char irq_chg[2], irq_on[2];\n\tunsigned char irq_rtc, irq_tsc;\n\tint i;\n\n\t \n\tirq_chg[0] = cache_chg[0];\n\tirq_chg[1] = cache_chg[1];\n\tirq_on[0] = cache_on[0];\n\tirq_on[1] = cache_on[1];\n\tirq_rtc = cache_rtc;\n\tirq_tsc = cache_tsc;\n\tfor (i = 0; i < ARRAY_SIZE(max8925_irqs); i++) {\n\t\tirq_data = &max8925_irqs[i];\n\t\t \n\t\tswitch (irq_data->mask_reg) {\n\t\tcase MAX8925_CHG_IRQ1_MASK:\n\t\t\tirq_chg[0] &= ~irq_data->enable;\n\t\t\tbreak;\n\t\tcase MAX8925_CHG_IRQ2_MASK:\n\t\t\tirq_chg[1] &= ~irq_data->enable;\n\t\t\tbreak;\n\t\tcase MAX8925_ON_OFF_IRQ1_MASK:\n\t\t\tirq_on[0] &= ~irq_data->enable;\n\t\t\tbreak;\n\t\tcase MAX8925_ON_OFF_IRQ2_MASK:\n\t\t\tirq_on[1] &= ~irq_data->enable;\n\t\t\tbreak;\n\t\tcase MAX8925_RTC_IRQ_MASK:\n\t\t\tirq_rtc &= ~irq_data->enable;\n\t\t\tbreak;\n\t\tcase MAX8925_TSC_IRQ_MASK:\n\t\t\tirq_tsc &= ~irq_data->enable;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(chip->dev, \"wrong IRQ\\n\");\n\t\t\tbreak;\n\t\t}\n\t}\n\t \n\tif (cache_chg[0] != irq_chg[0]) {\n\t\tcache_chg[0] = irq_chg[0];\n\t\tmax8925_reg_write(chip->i2c, MAX8925_CHG_IRQ1_MASK,\n\t\t\tirq_chg[0]);\n\t}\n\tif (cache_chg[1] != irq_chg[1]) {\n\t\tcache_chg[1] = irq_chg[1];\n\t\tmax8925_reg_write(chip->i2c, MAX8925_CHG_IRQ2_MASK,\n\t\t\tirq_chg[1]);\n\t}\n\tif (cache_on[0] != irq_on[0]) {\n\t\tcache_on[0] = irq_on[0];\n\t\tmax8925_reg_write(chip->i2c, MAX8925_ON_OFF_IRQ1_MASK,\n\t\t\t\tirq_on[0]);\n\t}\n\tif (cache_on[1] != irq_on[1]) {\n\t\tcache_on[1] = irq_on[1];\n\t\tmax8925_reg_write(chip->i2c, MAX8925_ON_OFF_IRQ2_MASK,\n\t\t\t\tirq_on[1]);\n\t}\n\tif (cache_rtc != irq_rtc) {\n\t\tcache_rtc = irq_rtc;\n\t\tmax8925_reg_write(chip->rtc, MAX8925_RTC_IRQ_MASK, irq_rtc);\n\t}\n\tif (cache_tsc != irq_tsc) {\n\t\tcache_tsc = irq_tsc;\n\t\tmax8925_reg_write(chip->adc, MAX8925_TSC_IRQ_MASK, irq_tsc);\n\t}\n\n\tmutex_unlock(&chip->irq_lock);\n}\n\nstatic void max8925_irq_enable(struct irq_data *data)\n{\n\tstruct max8925_chip *chip = irq_data_get_irq_chip_data(data);\n\n\tmax8925_irqs[data->irq - chip->irq_base].enable\n\t\t= max8925_irqs[data->irq - chip->irq_base].offs;\n}\n\nstatic void max8925_irq_disable(struct irq_data *data)\n{\n\tstruct max8925_chip *chip = irq_data_get_irq_chip_data(data);\n\n\tmax8925_irqs[data->irq - chip->irq_base].enable = 0;\n}\n\nstatic struct irq_chip max8925_irq_chip = {\n\t.name\t\t= \"max8925\",\n\t.irq_bus_lock\t= max8925_irq_lock,\n\t.irq_bus_sync_unlock = max8925_irq_sync_unlock,\n\t.irq_enable\t= max8925_irq_enable,\n\t.irq_disable\t= max8925_irq_disable,\n};\n\nstatic int max8925_irq_domain_map(struct irq_domain *d, unsigned int virq,\n\t\t\t\t irq_hw_number_t hw)\n{\n\tirq_set_chip_data(virq, d->host_data);\n\tirq_set_chip_and_handler(virq, &max8925_irq_chip, handle_edge_irq);\n\tirq_set_nested_thread(virq, 1);\n\tirq_set_noprobe(virq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops max8925_irq_domain_ops = {\n\t.map\t= max8925_irq_domain_map,\n\t.xlate\t= irq_domain_xlate_onetwocell,\n};\n\n\nstatic int max8925_irq_init(struct max8925_chip *chip, int irq,\n\t\t\t    struct max8925_platform_data *pdata)\n{\n\tunsigned long flags = IRQF_TRIGGER_FALLING | IRQF_ONESHOT;\n\tint ret;\n\tstruct device_node *node = chip->dev->of_node;\n\n\t \n\tmax8925_reg_read(chip->i2c, MAX8925_CHG_IRQ1);\n\tmax8925_reg_read(chip->i2c, MAX8925_CHG_IRQ2);\n\tmax8925_reg_read(chip->i2c, MAX8925_ON_OFF_IRQ1);\n\tmax8925_reg_read(chip->i2c, MAX8925_ON_OFF_IRQ2);\n\tmax8925_reg_read(chip->rtc, MAX8925_RTC_IRQ);\n\tmax8925_reg_read(chip->adc, MAX8925_TSC_IRQ);\n\t \n\tmax8925_reg_write(chip->rtc, MAX8925_ALARM0_CNTL, 0);\n\tmax8925_reg_write(chip->rtc, MAX8925_ALARM1_CNTL, 0);\n\tmax8925_reg_write(chip->i2c, MAX8925_CHG_IRQ1_MASK, 0xff);\n\tmax8925_reg_write(chip->i2c, MAX8925_CHG_IRQ2_MASK, 0xff);\n\tmax8925_reg_write(chip->i2c, MAX8925_ON_OFF_IRQ1_MASK, 0xff);\n\tmax8925_reg_write(chip->i2c, MAX8925_ON_OFF_IRQ2_MASK, 0xff);\n\tmax8925_reg_write(chip->rtc, MAX8925_RTC_IRQ_MASK, 0xff);\n\n\tmutex_init(&chip->irq_lock);\n\tchip->irq_base = irq_alloc_descs(-1, 0, MAX8925_NR_IRQS, 0);\n\tif (chip->irq_base < 0) {\n\t\tdev_err(chip->dev, \"Failed to allocate interrupts, ret:%d\\n\",\n\t\t\tchip->irq_base);\n\t\treturn -EBUSY;\n\t}\n\n\tirq_domain_add_legacy(node, MAX8925_NR_IRQS, chip->irq_base, 0,\n\t\t\t      &max8925_irq_domain_ops, chip);\n\n\t \n\tchip->core_irq = irq;\n\tif (!chip->core_irq)\n\t\treturn -EBUSY;\n\tret = request_threaded_irq(irq, NULL, max8925_irq, flags | IRQF_ONESHOT,\n\t\t\t\t   \"max8925\", chip);\n\tif (ret) {\n\t\tdev_err(chip->dev, \"Failed to request core IRQ: %d\\n\", ret);\n\t\tchip->core_irq = 0;\n\t\treturn -EBUSY;\n\t}\n\n\t \n\n\t \n\tmax8925_reg_write(chip->adc, MAX8925_TSC_IRQ_MASK, 0x0f);\n\n\tif (!pdata->tsc_irq) {\n\t\tdev_warn(chip->dev, \"No interrupt support on TSC IRQ\\n\");\n\t\treturn 0;\n\t}\n\tchip->tsc_irq = pdata->tsc_irq;\n\tret = request_threaded_irq(chip->tsc_irq, NULL, max8925_tsc_irq,\n\t\t\t\t   flags | IRQF_ONESHOT, \"max8925-tsc\", chip);\n\tif (ret) {\n\t\tdev_err(chip->dev, \"Failed to request TSC IRQ: %d\\n\", ret);\n\t\tchip->tsc_irq = 0;\n\t}\n\treturn 0;\n}\n\nstatic void init_regulator(struct max8925_chip *chip,\n\t\t\t\t     struct max8925_platform_data *pdata)\n{\n\tint ret;\n\n\tif (!pdata)\n\t\treturn;\n\tif (pdata->sd1) {\n\t\treg_devs[0].platform_data = pdata->sd1;\n\t\treg_devs[0].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->sd2) {\n\t\treg_devs[1].platform_data = pdata->sd2;\n\t\treg_devs[1].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->sd3) {\n\t\treg_devs[2].platform_data = pdata->sd3;\n\t\treg_devs[2].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo1) {\n\t\treg_devs[3].platform_data = pdata->ldo1;\n\t\treg_devs[3].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo2) {\n\t\treg_devs[4].platform_data = pdata->ldo2;\n\t\treg_devs[4].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo3) {\n\t\treg_devs[5].platform_data = pdata->ldo3;\n\t\treg_devs[5].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo4) {\n\t\treg_devs[6].platform_data = pdata->ldo4;\n\t\treg_devs[6].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo5) {\n\t\treg_devs[7].platform_data = pdata->ldo5;\n\t\treg_devs[7].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo6) {\n\t\treg_devs[8].platform_data = pdata->ldo6;\n\t\treg_devs[8].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo7) {\n\t\treg_devs[9].platform_data = pdata->ldo7;\n\t\treg_devs[9].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo8) {\n\t\treg_devs[10].platform_data = pdata->ldo8;\n\t\treg_devs[10].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo9) {\n\t\treg_devs[11].platform_data = pdata->ldo9;\n\t\treg_devs[11].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo10) {\n\t\treg_devs[12].platform_data = pdata->ldo10;\n\t\treg_devs[12].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo11) {\n\t\treg_devs[13].platform_data = pdata->ldo11;\n\t\treg_devs[13].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo12) {\n\t\treg_devs[14].platform_data = pdata->ldo12;\n\t\treg_devs[14].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo13) {\n\t\treg_devs[15].platform_data = pdata->ldo13;\n\t\treg_devs[15].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo14) {\n\t\treg_devs[16].platform_data = pdata->ldo14;\n\t\treg_devs[16].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo15) {\n\t\treg_devs[17].platform_data = pdata->ldo15;\n\t\treg_devs[17].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo16) {\n\t\treg_devs[18].platform_data = pdata->ldo16;\n\t\treg_devs[18].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo17) {\n\t\treg_devs[19].platform_data = pdata->ldo17;\n\t\treg_devs[19].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo18) {\n\t\treg_devs[20].platform_data = pdata->ldo18;\n\t\treg_devs[20].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo19) {\n\t\treg_devs[21].platform_data = pdata->ldo19;\n\t\treg_devs[21].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tif (pdata->ldo20) {\n\t\treg_devs[22].platform_data = pdata->ldo20;\n\t\treg_devs[22].pdata_size = sizeof(struct regulator_init_data);\n\t}\n\tret = mfd_add_devices(chip->dev, 0, reg_devs, ARRAY_SIZE(reg_devs),\n\t\t\t      NULL, 0, NULL);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"Failed to add regulator subdev\\n\");\n\t\treturn;\n\t}\n}\n\nint max8925_device_init(struct max8925_chip *chip,\n\t\t\t\t  struct max8925_platform_data *pdata)\n{\n\tint ret;\n\n\tmax8925_irq_init(chip, chip->i2c->irq, pdata);\n\n\tif (pdata && (pdata->power || pdata->touch)) {\n\t\t \n\t\tmax8925_set_bits(chip->i2c, MAX8925_RESET_CNFG, 1, 1);\n\t\t \n\t\tmax8925_set_bits(chip->adc, MAX8925_TSC_CNFG1, 3, 2);\n\t\t \n\t\tdo {\n\t\t\tret = max8925_reg_read(chip->adc, MAX8925_TSC_IRQ);\n\t\t} while (ret & MAX8925_NREF_OK);\n\t\t \n\t\tmax8925_set_bits(chip->adc, MAX8925_ADC_SCHED, 3, 2);\n\t}\n\n\t \n\tmax8925_set_bits(chip->rtc, MAX8925_MPL_CNTL, 1 << 4, 1 << 4);\n\n\tret = mfd_add_devices(chip->dev, 0, &rtc_devs[0],\n\t\t\t      ARRAY_SIZE(rtc_devs),\n\t\t\t      NULL, chip->irq_base, NULL);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"Failed to add rtc subdev\\n\");\n\t\tgoto out;\n\t}\n\n\tret = mfd_add_devices(chip->dev, 0, &onkey_devs[0],\n\t\t\t      ARRAY_SIZE(onkey_devs),\n\t\t\t      NULL, chip->irq_base, NULL);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"Failed to add onkey subdev\\n\");\n\t\tgoto out_dev;\n\t}\n\n\tinit_regulator(chip, pdata);\n\n\tif (pdata && pdata->backlight) {\n\t\tbk_devs[0].platform_data = &pdata->backlight;\n\t\tbk_devs[0].pdata_size = sizeof(struct max8925_backlight_pdata);\n\t}\n\tret = mfd_add_devices(chip->dev, 0, bk_devs, ARRAY_SIZE(bk_devs),\n\t\t\t      NULL, 0, NULL);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"Failed to add backlight subdev\\n\");\n\t\tgoto out_dev;\n\t}\n\n\tret = mfd_add_devices(chip->dev, 0, &power_devs[0],\n\t\t\t      ARRAY_SIZE(power_devs),\n\t\t\t      NULL, 0, NULL);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev,\n\t\t\t\"Failed to add power supply subdev, err = %d\\n\", ret);\n\t\tgoto out_dev;\n\t}\n\n\tif (pdata && pdata->touch) {\n\t\tret = mfd_add_devices(chip->dev, 0, &touch_devs[0],\n\t\t\t\t      ARRAY_SIZE(touch_devs),\n\t\t\t\t      NULL, chip->tsc_irq, NULL);\n\t\tif (ret < 0) {\n\t\t\tdev_err(chip->dev, \"Failed to add touch subdev\\n\");\n\t\t\tgoto out_dev;\n\t\t}\n\t}\n\n\treturn 0;\nout_dev:\n\tmfd_remove_devices(chip->dev);\nout:\n\treturn ret;\n}\n\nvoid max8925_device_exit(struct max8925_chip *chip)\n{\n\tif (chip->core_irq)\n\t\tfree_irq(chip->core_irq, chip);\n\tif (chip->tsc_irq)\n\t\tfree_irq(chip->tsc_irq, chip);\n\tmfd_remove_devices(chip->dev);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}