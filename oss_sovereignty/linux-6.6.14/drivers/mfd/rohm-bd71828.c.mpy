{
  "module_name": "rohm-bd71828.c",
  "hash_id": "875f607f461dc94316e706be5f02914ed1ff60cb31000ceeb5601594ca8e4f12",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/rohm-bd71828.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/gpio_keys.h>\n#include <linux/i2c.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/ioport.h>\n#include <linux/irq.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/rohm-bd71815.h>\n#include <linux/mfd/rohm-bd71828.h>\n#include <linux/mfd/rohm-generic.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n#include <linux/types.h>\n\nstatic struct gpio_keys_button button = {\n\t.code = KEY_POWER,\n\t.gpio = -1,\n\t.type = EV_KEY,\n};\n\nstatic struct gpio_keys_platform_data bd71828_powerkey_data = {\n\t.buttons = &button,\n\t.nbuttons = 1,\n\t.name = \"bd71828-pwrkey\",\n};\n\nstatic const struct resource bd71815_rtc_irqs[] = {\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_RTC0, \"bd71815-rtc-alm-0\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_RTC1, \"bd71815-rtc-alm-1\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_RTC2, \"bd71815-rtc-alm-2\"),\n};\n\nstatic const struct resource bd71828_rtc_irqs[] = {\n\tDEFINE_RES_IRQ_NAMED(BD71828_INT_RTC0, \"bd71828-rtc-alm-0\"),\n\tDEFINE_RES_IRQ_NAMED(BD71828_INT_RTC1, \"bd71828-rtc-alm-1\"),\n\tDEFINE_RES_IRQ_NAMED(BD71828_INT_RTC2, \"bd71828-rtc-alm-2\"),\n};\n\nstatic struct resource bd71815_power_irqs[] = {\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_DCIN_RMV, \"bd71815-dcin-rmv\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CLPS_OUT, \"bd71815-clps-out\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CLPS_IN, \"bd71815-clps-in\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_DCIN_OVP_RES, \"bd71815-dcin-ovp-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_DCIN_OVP_DET, \"bd71815-dcin-ovp-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_DCIN_MON_RES, \"bd71815-dcin-mon-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_DCIN_MON_DET, \"bd71815-dcin-mon-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_VSYS_UV_RES, \"bd71815-vsys-uv-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_VSYS_UV_DET, \"bd71815-vsys-uv-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_VSYS_LOW_RES, \"bd71815-vsys-low-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_VSYS_LOW_DET, \"bd71815-vsys-low-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_VSYS_MON_RES, \"bd71815-vsys-mon-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_VSYS_MON_RES, \"bd71815-vsys-mon-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CHG_WDG_TEMP, \"bd71815-chg-wdg-temp\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CHG_WDG_TIME, \"bd71815-chg-wdg\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CHG_RECHARGE_RES, \"bd71815-rechg-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CHG_RECHARGE_DET, \"bd71815-rechg-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CHG_RANGED_TEMP_TRANSITION, \"bd71815-ranged-temp-transit\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_CHG_STATE_TRANSITION, \"bd71815-chg-state-change\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_TEMP_NORMAL, \"bd71815-bat-temp-normal\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_TEMP_ERANGE, \"bd71815-bat-temp-erange\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_REMOVED, \"bd71815-bat-rmv\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_DETECTED, \"bd71815-bat-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_THERM_REMOVED, \"bd71815-therm-rmv\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_THERM_DETECTED, \"bd71815-therm-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_DEAD, \"bd71815-bat-dead\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_SHORTC_RES, \"bd71815-bat-short-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_SHORTC_DET, \"bd71815-bat-short-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_LOW_VOLT_RES, \"bd71815-bat-low-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_LOW_VOLT_DET, \"bd71815-bat-low-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_VOLT_RES, \"bd71815-bat-over-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_VOLT_DET, \"bd71815-bat-over-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_MON_RES, \"bd71815-bat-mon-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_MON_DET, \"bd71815-bat-mon-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_CC_MON1, \"bd71815-bat-cc-mon1\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_CC_MON2, \"bd71815-bat-cc-mon2\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_CC_MON3, \"bd71815-bat-cc-mon3\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_CURR_1_RES, \"bd71815-bat-oc1-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_CURR_1_DET, \"bd71815-bat-oc1-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_CURR_2_RES, \"bd71815-bat-oc2-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_CURR_2_DET, \"bd71815-bat-oc2-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_CURR_3_RES, \"bd71815-bat-oc3-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_BAT_OVER_CURR_3_DET, \"bd71815-bat-oc3-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_TEMP_BAT_LOW_RES, \"bd71815-bat-low-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_TEMP_BAT_LOW_DET, \"bd71815-bat-low-det\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_TEMP_BAT_HI_RES, \"bd71815-bat-hi-res\"),\n\tDEFINE_RES_IRQ_NAMED(BD71815_INT_TEMP_BAT_HI_DET, \"bd71815-bat-hi-det\"),\n};\n\nstatic struct mfd_cell bd71815_mfd_cells[] = {\n\t{ .name = \"bd71815-pmic\", },\n\t{ .name = \"bd71815-clk\", },\n\t{ .name = \"bd71815-gpo\", },\n\t{\n\t\t.name = \"bd71815-power\",\n\t\t.num_resources = ARRAY_SIZE(bd71815_power_irqs),\n\t\t.resources = &bd71815_power_irqs[0],\n\t},\n\t{\n\t\t.name = \"bd71815-rtc\",\n\t\t.num_resources = ARRAY_SIZE(bd71815_rtc_irqs),\n\t\t.resources = &bd71815_rtc_irqs[0],\n\t},\n};\n\nstatic struct mfd_cell bd71828_mfd_cells[] = {\n\t{ .name = \"bd71828-pmic\", },\n\t{ .name = \"bd71828-gpio\", },\n\t{ .name = \"bd71828-led\", .of_compatible = \"rohm,bd71828-leds\" },\n\t \n\t{ .name = \"bd71828-clk\", },\n\t{ .name = \"bd71827-power\", },\n\t{\n\t\t.name = \"bd71828-rtc\",\n\t\t.resources = bd71828_rtc_irqs,\n\t\t.num_resources = ARRAY_SIZE(bd71828_rtc_irqs),\n\t}, {\n\t\t.name = \"gpio-keys\",\n\t\t.platform_data = &bd71828_powerkey_data,\n\t\t.pdata_size = sizeof(bd71828_powerkey_data),\n\t},\n};\n\nstatic const struct regmap_range bd71815_volatile_ranges[] = {\n\t{\n\t\t.range_min = BD71815_REG_SEC,\n\t\t.range_max = BD71815_REG_YEAR,\n\t}, {\n\t\t.range_min = BD71815_REG_CONF,\n\t\t.range_max = BD71815_REG_BAT_TEMP,\n\t}, {\n\t\t.range_min = BD71815_REG_VM_IBAT_U,\n\t\t.range_max = BD71815_REG_CC_CTRL,\n\t}, {\n\t\t.range_min = BD71815_REG_CC_STAT,\n\t\t.range_max = BD71815_REG_CC_CURCD_L,\n\t}, {\n\t\t.range_min = BD71815_REG_VM_BTMP_MON,\n\t\t.range_max = BD71815_REG_VM_BTMP_MON,\n\t}, {\n\t\t.range_min = BD71815_REG_INT_STAT,\n\t\t.range_max = BD71815_REG_INT_UPDATE,\n\t}, {\n\t\t.range_min = BD71815_REG_VM_VSYS_U,\n\t\t.range_max = BD71815_REG_REX_CTRL_1,\n\t}, {\n\t\t.range_min = BD71815_REG_FULL_CCNTD_3,\n\t\t.range_max = BD71815_REG_CCNTD_CHG_2,\n\t},\n};\n\nstatic const struct regmap_range bd71828_volatile_ranges[] = {\n\t{\n\t\t.range_min = BD71828_REG_PS_CTRL_1,\n\t\t.range_max = BD71828_REG_PS_CTRL_1,\n\t}, {\n\t\t.range_min = BD71828_REG_PS_CTRL_3,\n\t\t.range_max = BD71828_REG_PS_CTRL_3,\n\t}, {\n\t\t.range_min = BD71828_REG_RTC_SEC,\n\t\t.range_max = BD71828_REG_RTC_YEAR,\n\t}, {\n\t\t \n\t\t.range_min = BD71828_REG_CHG_STATE,\n\t\t.range_max = BD71828_REG_CHG_FULL,\n\t}, {\n\t\t.range_min = BD71828_REG_INT_MAIN,\n\t\t.range_max = BD71828_REG_IO_STAT,\n\t},\n};\n\nstatic const struct regmap_access_table bd71815_volatile_regs = {\n\t.yes_ranges = &bd71815_volatile_ranges[0],\n\t.n_yes_ranges = ARRAY_SIZE(bd71815_volatile_ranges),\n};\n\nstatic const struct regmap_access_table bd71828_volatile_regs = {\n\t.yes_ranges = &bd71828_volatile_ranges[0],\n\t.n_yes_ranges = ARRAY_SIZE(bd71828_volatile_ranges),\n};\n\nstatic const struct regmap_config bd71815_regmap = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.volatile_table = &bd71815_volatile_regs,\n\t.max_register = BD71815_MAX_REGISTER - 1,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\nstatic const struct regmap_config bd71828_regmap = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.volatile_table = &bd71828_volatile_regs,\n\t.max_register = BD71828_MAX_REGISTER,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\n \n\nstatic unsigned int bit0_offsets[] = {11};\t\t \nstatic unsigned int bit1_offsets[] = {10};\t\t \nstatic unsigned int bit2_offsets[] = {6, 7, 8, 9};\t \nstatic unsigned int bit3_offsets[] = {5};\t\t \nstatic unsigned int bit4_offsets[] = {4};\t\t \nstatic unsigned int bit5_offsets[] = {3};\t\t \nstatic unsigned int bit6_offsets[] = {1, 2};\t\t \nstatic unsigned int bit7_offsets[] = {0};\t\t \n\nstatic struct regmap_irq_sub_irq_map bd718xx_sub_irq_offsets[] = {\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit0_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit1_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit2_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit3_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit4_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit5_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit6_offsets),\n\tREGMAP_IRQ_MAIN_REG_OFFSET(bit7_offsets),\n};\n\nstatic const struct regmap_irq bd71815_irqs[] = {\n\tREGMAP_IRQ_REG(BD71815_INT_BUCK1_OCP, 0, BD71815_INT_BUCK1_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BUCK2_OCP, 0, BD71815_INT_BUCK2_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BUCK3_OCP, 0, BD71815_INT_BUCK3_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BUCK4_OCP, 0, BD71815_INT_BUCK4_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BUCK5_OCP, 0, BD71815_INT_BUCK5_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_LED_OVP, 0, BD71815_INT_LED_OVP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_LED_OCP, 0, BD71815_INT_LED_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_LED_SCP, 0, BD71815_INT_LED_SCP_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_DCIN_RMV, 1, BD71815_INT_DCIN_RMV_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CLPS_OUT, 1, BD71815_INT_CLPS_OUT_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CLPS_IN, 1, BD71815_INT_CLPS_IN_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_DCIN_OVP_RES, 1, BD71815_INT_DCIN_OVP_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_DCIN_OVP_DET, 1, BD71815_INT_DCIN_OVP_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_DCIN_MON_RES, 2, BD71815_INT_DCIN_MON_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_DCIN_MON_DET, 2, BD71815_INT_DCIN_MON_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_WDOG, 2, BD71815_INT_WDOG_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_VSYS_UV_RES, 3, BD71815_INT_VSYS_UV_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_VSYS_UV_DET, 3, BD71815_INT_VSYS_UV_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_VSYS_LOW_RES, 3, BD71815_INT_VSYS_LOW_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_VSYS_LOW_DET, 3, BD71815_INT_VSYS_LOW_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_VSYS_MON_RES, 3, BD71815_INT_VSYS_MON_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_VSYS_MON_DET, 3, BD71815_INT_VSYS_MON_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_CHG_WDG_TEMP, 4, BD71815_INT_CHG_WDG_TEMP_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CHG_WDG_TIME, 4, BD71815_INT_CHG_WDG_TIME_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CHG_RECHARGE_RES, 4, BD71815_INT_CHG_RECHARGE_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CHG_RECHARGE_DET, 4, BD71815_INT_CHG_RECHARGE_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CHG_RANGED_TEMP_TRANSITION, 4,\n\t\t       BD71815_INT_CHG_RANGED_TEMP_TRANSITION_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_CHG_STATE_TRANSITION, 4, BD71815_INT_CHG_STATE_TRANSITION_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_BAT_TEMP_NORMAL, 5, BD71815_INT_BAT_TEMP_NORMAL_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_TEMP_ERANGE, 5, BD71815_INT_BAT_TEMP_ERANGE_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_REMOVED, 5, BD71815_INT_BAT_REMOVED_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_DETECTED, 5, BD71815_INT_BAT_DETECTED_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_THERM_REMOVED, 5, BD71815_INT_THERM_REMOVED_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_THERM_DETECTED, 5, BD71815_INT_THERM_DETECTED_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_BAT_DEAD, 6, BD71815_INT_BAT_DEAD_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_SHORTC_RES, 6, BD71815_INT_BAT_SHORTC_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_SHORTC_DET, 6, BD71815_INT_BAT_SHORTC_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_LOW_VOLT_RES, 6, BD71815_INT_BAT_LOW_VOLT_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_LOW_VOLT_DET, 6, BD71815_INT_BAT_LOW_VOLT_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_VOLT_RES, 6, BD71815_INT_BAT_OVER_VOLT_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_VOLT_DET, 6, BD71815_INT_BAT_OVER_VOLT_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_BAT_MON_RES, 7, BD71815_INT_BAT_MON_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_MON_DET, 7, BD71815_INT_BAT_MON_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_BAT_CC_MON1, 8, BD71815_INT_BAT_CC_MON1_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_CC_MON2, 8, BD71815_INT_BAT_CC_MON2_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_CC_MON3, 8, BD71815_INT_BAT_CC_MON3_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_CURR_1_RES, 9, BD71815_INT_BAT_OVER_CURR_1_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_CURR_1_DET, 9, BD71815_INT_BAT_OVER_CURR_1_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_CURR_2_RES, 9, BD71815_INT_BAT_OVER_CURR_2_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_CURR_2_DET, 9, BD71815_INT_BAT_OVER_CURR_2_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_CURR_3_RES, 9, BD71815_INT_BAT_OVER_CURR_3_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_BAT_OVER_CURR_3_DET, 9, BD71815_INT_BAT_OVER_CURR_3_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_BAT_LOW_RES, 10, BD71815_INT_TEMP_BAT_LOW_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_BAT_LOW_DET, 10, BD71815_INT_TEMP_BAT_LOW_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_BAT_HI_RES, 10, BD71815_INT_TEMP_BAT_HI_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_BAT_HI_DET, 10, BD71815_INT_TEMP_BAT_HI_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_CHIP_OVER_125_RES, 10,\n\t\t       BD71815_INT_TEMP_CHIP_OVER_125_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_CHIP_OVER_125_DET, 10,\n\t\t       BD71815_INT_TEMP_CHIP_OVER_125_DET_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_CHIP_OVER_VF_RES, 10,\n\t\t       BD71815_INT_TEMP_CHIP_OVER_VF_RES_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_TEMP_CHIP_OVER_VF_DET, 10,\n\t\t       BD71815_INT_TEMP_CHIP_OVER_VF_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71815_INT_RTC0, 11, BD71815_INT_RTC0_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_RTC1, 11, BD71815_INT_RTC1_MASK),\n\tREGMAP_IRQ_REG(BD71815_INT_RTC2, 11, BD71815_INT_RTC2_MASK),\n};\n\nstatic struct regmap_irq bd71828_irqs[] = {\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK1_OCP, 0, BD71828_INT_BUCK1_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK2_OCP, 0, BD71828_INT_BUCK2_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK3_OCP, 0, BD71828_INT_BUCK3_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK4_OCP, 0, BD71828_INT_BUCK4_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK5_OCP, 0, BD71828_INT_BUCK5_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK6_OCP, 0, BD71828_INT_BUCK6_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BUCK7_OCP, 0, BD71828_INT_BUCK7_OCP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_PGFAULT, 0, BD71828_INT_PGFAULT_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_DCIN_DET, 1, BD71828_INT_DCIN_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_DCIN_RMV, 1, BD71828_INT_DCIN_RMV_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CLPS_OUT, 1, BD71828_INT_CLPS_OUT_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CLPS_IN, 1, BD71828_INT_CLPS_IN_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_DCIN_MON_RES, 2, BD71828_INT_DCIN_MON_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_DCIN_MON_DET, 2, BD71828_INT_DCIN_MON_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_LONGPUSH, 2, BD71828_INT_LONGPUSH_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_MIDPUSH, 2, BD71828_INT_MIDPUSH_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_SHORTPUSH, 2, BD71828_INT_SHORTPUSH_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_PUSH, 2, BD71828_INT_PUSH_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_WDOG, 2, BD71828_INT_WDOG_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_SWRESET, 2, BD71828_INT_SWRESET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_UV_RES, 3, BD71828_INT_VSYS_UV_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_UV_DET, 3, BD71828_INT_VSYS_UV_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_LOW_RES, 3, BD71828_INT_VSYS_LOW_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_LOW_DET, 3, BD71828_INT_VSYS_LOW_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_HALL_IN, 3, BD71828_INT_VSYS_HALL_IN_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_HALL_TOGGLE, 3, BD71828_INT_VSYS_HALL_TOGGLE_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_MON_RES, 3, BD71828_INT_VSYS_MON_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_VSYS_MON_DET, 3, BD71828_INT_VSYS_MON_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_CHG_DCIN_ILIM, 4, BD71828_INT_CHG_DCIN_ILIM_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_TOPOFF_TO_DONE, 4, BD71828_INT_CHG_TOPOFF_TO_DONE_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_WDG_TEMP, 4, BD71828_INT_CHG_WDG_TEMP_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_WDG_TIME, 4, BD71828_INT_CHG_WDG_TIME_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_RECHARGE_RES, 4, BD71828_INT_CHG_RECHARGE_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_RECHARGE_DET, 4, BD71828_INT_CHG_RECHARGE_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_RANGED_TEMP_TRANSITION, 4,\n\t\t       BD71828_INT_CHG_RANGED_TEMP_TRANSITION_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_CHG_STATE_TRANSITION, 4, BD71828_INT_CHG_STATE_TRANSITION_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_BAT_TEMP_NORMAL, 5, BD71828_INT_BAT_TEMP_NORMAL_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_TEMP_ERANGE, 5, BD71828_INT_BAT_TEMP_ERANGE_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_TEMP_WARN, 5, BD71828_INT_BAT_TEMP_WARN_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_REMOVED, 5, BD71828_INT_BAT_REMOVED_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_DETECTED, 5, BD71828_INT_BAT_DETECTED_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_THERM_REMOVED, 5, BD71828_INT_THERM_REMOVED_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_THERM_DETECTED, 5, BD71828_INT_THERM_DETECTED_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_BAT_DEAD, 6, BD71828_INT_BAT_DEAD_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_SHORTC_RES, 6, BD71828_INT_BAT_SHORTC_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_SHORTC_DET, 6, BD71828_INT_BAT_SHORTC_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_LOW_VOLT_RES, 6, BD71828_INT_BAT_LOW_VOLT_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_LOW_VOLT_DET, 6, BD71828_INT_BAT_LOW_VOLT_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_VOLT_RES, 6, BD71828_INT_BAT_OVER_VOLT_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_VOLT_DET, 6, BD71828_INT_BAT_OVER_VOLT_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_BAT_MON_RES, 7, BD71828_INT_BAT_MON_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_MON_DET, 7, BD71828_INT_BAT_MON_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_BAT_CC_MON1, 8, BD71828_INT_BAT_CC_MON1_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_CC_MON2, 8, BD71828_INT_BAT_CC_MON2_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_CC_MON3, 8, BD71828_INT_BAT_CC_MON3_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_CURR_1_RES, 9, BD71828_INT_BAT_OVER_CURR_1_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_CURR_1_DET, 9, BD71828_INT_BAT_OVER_CURR_1_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_CURR_2_RES, 9, BD71828_INT_BAT_OVER_CURR_2_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_CURR_2_DET, 9, BD71828_INT_BAT_OVER_CURR_2_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_CURR_3_RES, 9, BD71828_INT_BAT_OVER_CURR_3_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_BAT_OVER_CURR_3_DET, 9, BD71828_INT_BAT_OVER_CURR_3_DET_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_BAT_LOW_RES, 10, BD71828_INT_TEMP_BAT_LOW_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_BAT_LOW_DET, 10, BD71828_INT_TEMP_BAT_LOW_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_BAT_HI_RES, 10, BD71828_INT_TEMP_BAT_HI_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_BAT_HI_DET, 10, BD71828_INT_TEMP_BAT_HI_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_CHIP_OVER_125_RES, 10,\n\t\t       BD71828_INT_TEMP_CHIP_OVER_125_RES_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_CHIP_OVER_125_DET, 10,\n\t\t       BD71828_INT_TEMP_CHIP_OVER_125_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_CHIP_OVER_VF_DET, 10,\n\t\t       BD71828_INT_TEMP_CHIP_OVER_VF_DET_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_TEMP_CHIP_OVER_VF_RES, 10,\n\t\t       BD71828_INT_TEMP_CHIP_OVER_VF_RES_MASK),\n\t \n\tREGMAP_IRQ_REG(BD71828_INT_RTC0, 11, BD71828_INT_RTC0_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_RTC1, 11, BD71828_INT_RTC1_MASK),\n\tREGMAP_IRQ_REG(BD71828_INT_RTC2, 11, BD71828_INT_RTC2_MASK),\n};\n\nstatic struct regmap_irq_chip bd71828_irq_chip = {\n\t.name = \"bd71828_irq\",\n\t.main_status = BD71828_REG_INT_MAIN,\n\t.irqs = &bd71828_irqs[0],\n\t.num_irqs = ARRAY_SIZE(bd71828_irqs),\n\t.status_base = BD71828_REG_INT_BUCK,\n\t.unmask_base = BD71828_REG_INT_MASK_BUCK,\n\t.ack_base = BD71828_REG_INT_BUCK,\n\t.init_ack_masked = true,\n\t.num_regs = 12,\n\t.num_main_regs = 1,\n\t.sub_reg_offsets = &bd718xx_sub_irq_offsets[0],\n\t.num_main_status_bits = 8,\n\t.irq_reg_stride = 1,\n};\n\nstatic struct regmap_irq_chip bd71815_irq_chip = {\n\t.name = \"bd71815_irq\",\n\t.main_status = BD71815_REG_INT_STAT,\n\t.irqs = &bd71815_irqs[0],\n\t.num_irqs = ARRAY_SIZE(bd71815_irqs),\n\t.status_base = BD71815_REG_INT_STAT_01,\n\t.unmask_base = BD71815_REG_INT_EN_01,\n\t.ack_base = BD71815_REG_INT_STAT_01,\n\t.init_ack_masked = true,\n\t.num_regs = 12,\n\t.num_main_regs = 1,\n\t.sub_reg_offsets = &bd718xx_sub_irq_offsets[0],\n\t.num_main_status_bits = 8,\n\t.irq_reg_stride = 1,\n};\n\nstatic int set_clk_mode(struct device *dev, struct regmap *regmap,\n\t\t\tint clkmode_reg)\n{\n\tint ret;\n\tunsigned int open_drain;\n\n\tret = of_property_read_u32(dev->of_node, \"rohm,clkout-open-drain\", &open_drain);\n\tif (ret) {\n\t\tif (ret == -EINVAL)\n\t\t\treturn 0;\n\t\treturn ret;\n\t}\n\tif (open_drain > 1) {\n\t\tdev_err(dev, \"bad clk32kout mode configuration\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (open_drain)\n\t\treturn regmap_update_bits(regmap, clkmode_reg, OUT32K_MODE,\n\t\t\t\t\t  OUT32K_MODE_OPEN_DRAIN);\n\n\treturn regmap_update_bits(regmap, clkmode_reg, OUT32K_MODE,\n\t\t\t\t  OUT32K_MODE_CMOS);\n}\n\nstatic int bd71828_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct regmap_irq_chip_data *irq_data;\n\tint ret;\n\tstruct regmap *regmap;\n\tconst struct regmap_config *regmap_config;\n\tstruct regmap_irq_chip *irqchip;\n\tunsigned int chip_type;\n\tstruct mfd_cell *mfd;\n\tint cells;\n\tint button_irq;\n\tint clkmode_reg;\n\n\tif (!i2c->irq) {\n\t\tdev_err(&i2c->dev, \"No IRQ configured\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tchip_type = (unsigned int)(uintptr_t)\n\t\t    of_device_get_match_data(&i2c->dev);\n\tswitch (chip_type) {\n\tcase ROHM_CHIP_TYPE_BD71828:\n\t\tmfd = bd71828_mfd_cells;\n\t\tcells = ARRAY_SIZE(bd71828_mfd_cells);\n\t\tregmap_config = &bd71828_regmap;\n\t\tirqchip = &bd71828_irq_chip;\n\t\tclkmode_reg = BD71828_REG_OUT32K;\n\t\tbutton_irq = BD71828_INT_SHORTPUSH;\n\t\tbreak;\n\tcase ROHM_CHIP_TYPE_BD71815:\n\t\tmfd = bd71815_mfd_cells;\n\t\tcells = ARRAY_SIZE(bd71815_mfd_cells);\n\t\tregmap_config = &bd71815_regmap;\n\t\tirqchip = &bd71815_irq_chip;\n\t\tclkmode_reg = BD71815_REG_OUT32K;\n\t\t \n\t\tbutton_irq = 0;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&i2c->dev, \"Unknown device type\");\n\t\treturn -EINVAL;\n\t}\n\n\tregmap = devm_regmap_init_i2c(i2c, regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn dev_err_probe(&i2c->dev, PTR_ERR(regmap),\n\t\t\t\t     \"Failed to initialize Regmap\\n\");\n\n\tret = devm_regmap_add_irq_chip(&i2c->dev, regmap, i2c->irq,\n\t\t\t\t       IRQF_ONESHOT, 0, irqchip, &irq_data);\n\tif (ret)\n\t\treturn dev_err_probe(&i2c->dev, ret,\n\t\t\t\t     \"Failed to add IRQ chip\\n\");\n\n\tdev_dbg(&i2c->dev, \"Registered %d IRQs for chip\\n\",\n\t\tirqchip->num_irqs);\n\n\tif (button_irq) {\n\t\tret = regmap_irq_get_virq(irq_data, button_irq);\n\t\tif (ret < 0)\n\t\t\treturn dev_err_probe(&i2c->dev, ret,\n\t\t\t\t\t     \"Failed to get the power-key IRQ\\n\");\n\n\t\tbutton.irq = ret;\n\t}\n\n\tret = set_clk_mode(&i2c->dev, regmap, clkmode_reg);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_mfd_add_devices(&i2c->dev, PLATFORM_DEVID_AUTO, mfd, cells,\n\t\t\t\t   NULL, 0, regmap_irq_get_domain(irq_data));\n\tif (ret)\n\t\tdev_err_probe(&i2c->dev, ret, \"Failed to create subdevices\\n\");\n\n\treturn ret;\n}\n\nstatic const struct of_device_id bd71828_of_match[] = {\n\t{\n\t\t.compatible = \"rohm,bd71828\",\n\t\t.data = (void *)ROHM_CHIP_TYPE_BD71828,\n\t}, {\n\t\t.compatible = \"rohm,bd71815\",\n\t\t.data = (void *)ROHM_CHIP_TYPE_BD71815,\n\t },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, bd71828_of_match);\n\nstatic struct i2c_driver bd71828_drv = {\n\t.driver = {\n\t\t.name = \"rohm-bd71828\",\n\t\t.of_match_table = bd71828_of_match,\n\t},\n\t.probe = bd71828_i2c_probe,\n};\nmodule_i2c_driver(bd71828_drv);\n\nMODULE_AUTHOR(\"Matti Vaittinen <matti.vaittinen@fi.rohmeurope.com>\");\nMODULE_DESCRIPTION(\"ROHM BD71828 Power Management IC driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}