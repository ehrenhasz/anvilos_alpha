{
  "module_name": "max77541.c",
  "hash_id": "9a24b427f6b33feb0cba58c8bcb27910a5dfd42c5bc42c89fc48aaed075f5c65",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max77541.c",
  "human_readable_source": "\n \n\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max77541.h>\n#include <linux/property.h>\n#include <linux/regmap.h>\n\nstatic const struct regmap_config max77541_regmap_config = {\n\t.reg_bits   = 8,\n\t.val_bits   = 8,\n};\n\nstatic const struct regmap_irq max77541_src_irqs[] = {\n\t{ .mask = MAX77541_BIT_INT_SRC_TOPSYS },\n\t{ .mask = MAX77541_BIT_INT_SRC_BUCK },\n};\n\nstatic const struct regmap_irq_chip max77541_src_irq_chip = {\n\t.name\t\t= \"max77541-src\",\n\t.status_base\t= MAX77541_REG_INT_SRC,\n\t.mask_base\t= MAX77541_REG_INT_SRC_M,\n\t.num_regs\t= 1,\n\t.irqs\t\t= max77541_src_irqs,\n\t.num_irqs       = ARRAY_SIZE(max77541_src_irqs),\n};\n\nstatic const struct regmap_irq max77541_topsys_irqs[] = {\n\t{ .mask = MAX77541_BIT_TOPSYS_INT_TJ_120C },\n\t{ .mask = MAX77541_BIT_TOPSYS_INT_TJ_140C },\n\t{ .mask = MAX77541_BIT_TOPSYS_INT_TSHDN },\n\t{ .mask = MAX77541_BIT_TOPSYS_INT_UVLO },\n\t{ .mask = MAX77541_BIT_TOPSYS_INT_ALT_SWO },\n\t{ .mask = MAX77541_BIT_TOPSYS_INT_EXT_FREQ_DET },\n};\n\nstatic const struct regmap_irq_chip max77541_topsys_irq_chip = {\n\t.name\t\t= \"max77541-topsys\",\n\t.status_base\t= MAX77541_REG_TOPSYS_INT,\n\t.mask_base\t= MAX77541_REG_TOPSYS_INT_M,\n\t.num_regs\t= 1,\n\t.irqs\t\t= max77541_topsys_irqs,\n\t.num_irqs\t= ARRAY_SIZE(max77541_topsys_irqs),\n};\n\nstatic const struct regmap_irq max77541_buck_irqs[] = {\n\t{ .mask = MAX77541_BIT_BUCK_INT_M1_POK_FLT },\n\t{ .mask = MAX77541_BIT_BUCK_INT_M2_POK_FLT },\n\t{ .mask = MAX77541_BIT_BUCK_INT_M1_SCFLT },\n\t{ .mask = MAX77541_BIT_BUCK_INT_M2_SCFLT },\n};\n\nstatic const struct regmap_irq_chip max77541_buck_irq_chip = {\n\t.name\t\t= \"max77541-buck\",\n\t.status_base\t= MAX77541_REG_BUCK_INT,\n\t.mask_base\t= MAX77541_REG_BUCK_INT_M,\n\t.num_regs\t= 1,\n\t.irqs\t\t= max77541_buck_irqs,\n\t.num_irqs\t= ARRAY_SIZE(max77541_buck_irqs),\n};\n\nstatic const struct regmap_irq max77541_adc_irqs[] = {\n\t{ .mask = MAX77541_BIT_ADC_INT_CH1_I },\n\t{ .mask = MAX77541_BIT_ADC_INT_CH2_I },\n\t{ .mask = MAX77541_BIT_ADC_INT_CH3_I },\n\t{ .mask = MAX77541_BIT_ADC_INT_CH6_I },\n};\n\nstatic const struct regmap_irq_chip max77541_adc_irq_chip = {\n\t.name\t\t= \"max77541-adc\",\n\t.status_base\t= MAX77541_REG_ADC_INT,\n\t.mask_base\t= MAX77541_REG_ADC_INT_M,\n\t.num_regs\t= 1,\n\t.irqs\t\t= max77541_adc_irqs,\n\t.num_irqs\t= ARRAY_SIZE(max77541_adc_irqs),\n};\n\nstatic const struct mfd_cell max77540_devs[] = {\n\tMFD_CELL_OF(\"max77540-regulator\", NULL, NULL, 0, 0, NULL),\n};\n\nstatic const struct mfd_cell max77541_devs[] = {\n\tMFD_CELL_OF(\"max77541-regulator\", NULL, NULL, 0, 0, NULL),\n\tMFD_CELL_OF(\"max77541-adc\", NULL, NULL, 0, 0, NULL),\n};\n\nstatic int max77541_pmic_irq_init(struct device *dev)\n{\n\tstruct max77541 *max77541 = dev_get_drvdata(dev);\n\tint irq = max77541->i2c->irq;\n\tint ret;\n\n\tret = devm_regmap_add_irq_chip(dev, max77541->regmap, irq,\n\t\t\t\t       IRQF_ONESHOT | IRQF_SHARED, 0,\n\t\t\t\t       &max77541_src_irq_chip,\n\t\t\t\t       &max77541->irq_data);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_regmap_add_irq_chip(dev, max77541->regmap, irq,\n\t\t\t\t       IRQF_ONESHOT | IRQF_SHARED, 0,\n\t\t\t\t       &max77541_topsys_irq_chip,\n\t\t\t\t       &max77541->irq_topsys);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_regmap_add_irq_chip(dev, max77541->regmap, irq,\n\t\t\t\t       IRQF_ONESHOT | IRQF_SHARED, 0,\n\t\t\t\t       &max77541_buck_irq_chip,\n\t\t\t\t       &max77541->irq_buck);\n\tif (ret)\n\t\treturn ret;\n\n\tif (max77541->id == MAX77541) {\n\t\tret = devm_regmap_add_irq_chip(dev, max77541->regmap, irq,\n\t\t\t\t\t       IRQF_ONESHOT | IRQF_SHARED, 0,\n\t\t\t\t\t       &max77541_adc_irq_chip,\n\t\t\t\t\t       &max77541->irq_adc);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77541_pmic_setup(struct device *dev)\n{\n\tstruct max77541 *max77541 = dev_get_drvdata(dev);\n\tconst struct mfd_cell *cells;\n\tint n_devs;\n\tint ret;\n\n\tswitch (max77541->id) {\n\tcase MAX77540:\n\t\tcells =  max77540_devs;\n\t\tn_devs = ARRAY_SIZE(max77540_devs);\n\t\tbreak;\n\tcase MAX77541:\n\t\tcells =  max77541_devs;\n\t\tn_devs = ARRAY_SIZE(max77541_devs);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = max77541_pmic_irq_init(dev);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to initialize IRQ\\n\");\n\n\tret = device_init_wakeup(dev, true);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Unable to init wakeup\\n\");\n\n\treturn devm_mfd_add_devices(dev, PLATFORM_DEVID_NONE,\n\t\t\t\t    cells, n_devs, NULL, 0, NULL);\n}\n\nstatic int max77541_probe(struct i2c_client *client)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(client);\n\tstruct device *dev = &client->dev;\n\tstruct max77541 *max77541;\n\n\tmax77541 = devm_kzalloc(dev, sizeof(*max77541), GFP_KERNEL);\n\tif (!max77541)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(client, max77541);\n\tmax77541->i2c = client;\n\n\tmax77541->id = (uintptr_t)device_get_match_data(dev);\n\tif (!max77541->id)\n\t\tmax77541->id  = (enum max7754x_ids)id->driver_data;\n\n\tif (!max77541->id)\n\t\treturn -EINVAL;\n\n\tmax77541->regmap = devm_regmap_init_i2c(client,\n\t\t\t\t\t\t&max77541_regmap_config);\n\tif (IS_ERR(max77541->regmap))\n\t\treturn dev_err_probe(dev, PTR_ERR(max77541->regmap),\n\t\t\t\t     \"Failed to allocate register map\\n\");\n\n\treturn max77541_pmic_setup(dev);\n}\n\nstatic const struct of_device_id max77541_of_id[] = {\n\t{\n\t\t.compatible = \"adi,max77540\",\n\t\t.data = (void *)MAX77540,\n\t},\n\t{\n\t\t.compatible = \"adi,max77541\",\n\t\t.data = (void *)MAX77541,\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max77541_of_id);\n\nstatic const struct i2c_device_id max77541_id[] = {\n\t{ \"max77540\", MAX77540 },\n\t{ \"max77541\", MAX77541 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, max77541_id);\n\nstatic struct i2c_driver max77541_driver = {\n\t.driver = {\n\t\t.name = \"max77541\",\n\t\t.of_match_table = max77541_of_id,\n\t},\n\t.probe = max77541_probe,\n\t.id_table = max77541_id,\n};\nmodule_i2c_driver(max77541_driver);\n\nMODULE_DESCRIPTION(\"MAX7740/MAX7741 Driver\");\nMODULE_AUTHOR(\"Okan Sahin <okan.sahin@analog.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}