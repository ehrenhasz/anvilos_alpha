{
  "module_name": "cs42l43.c",
  "hash_id": "bbc746c0bdf9bd064dbf54b20613c59867bcb6239b2b9e5e9ccf79009365bd98",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/cs42l43.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/build_bug.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/errno.h>\n#include <linux/firmware.h>\n#include <linux/jiffies.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/cs42l43-regs.h>\n#include <linux/module.h>\n#include <linux/pm_runtime.h>\n#include <linux/soundwire/sdw.h>\n\n#include \"cs42l43.h\"\n\n#define CS42L43_RESET_DELAY\t\t\t20\n\n#define CS42L43_SDW_ATTACH_TIMEOUT\t\t500\n#define CS42L43_SDW_DETACH_TIMEOUT\t\t100\n\n#define CS42L43_MCU_BOOT_STAGE1\t\t\t1\n#define CS42L43_MCU_BOOT_STAGE2\t\t\t2\n#define CS42L43_MCU_BOOT_STAGE3\t\t\t3\n#define CS42L43_MCU_BOOT_STAGE4\t\t\t4\n#define CS42L43_MCU_POLL\t\t\t5000\n#define CS42L43_MCU_CMD_TIMEOUT\t\t\t20000\n#define CS42L43_MCU_UPDATE_FORMAT\t\t3\n#define CS42L43_MCU_UPDATE_OFFSET\t\t0x100000\n#define CS42L43_MCU_UPDATE_TIMEOUT\t\t500000\n#define CS42L43_MCU_UPDATE_RETRIES\t\t5\n\n#define CS42L43_MCU_SUPPORTED_REV\t\t0x2105\n#define CS42L43_MCU_SHADOW_REGS_REQUIRED_REV\t0x2200\n#define CS42L43_MCU_SUPPORTED_BIOS_REV\t\t0x0001\n\n#define CS42L43_VDDP_DELAY\t\t\t50\n#define CS42L43_VDDD_DELAY\t\t\t1000\n\n#define CS42L43_AUTOSUSPEND_TIME\t\t250\n\nstruct cs42l43_patch_header {\n\t__le16 version;\n\t__le16 size;\n\tu8 reserved;\n\tu8 secure;\n\t__le16 bss_size;\n\t__le32 apply_addr;\n\t__le32 checksum;\n\t__le32 sha;\n\t__le16 swrev;\n\t__le16 patchid;\n\t__le16 ipxid;\n\t__le16 romver;\n\t__le32 load_addr;\n} __packed;\n\nstatic const struct reg_sequence cs42l43_reva_patch[] = {\n\t{ 0x4000,\t\t\t\t\t0x00000055 },\n\t{ 0x4000,\t\t\t\t\t0x000000AA },\n\t{ 0x10084,\t\t\t\t\t0x00000000 },\n\t{ 0x1741C,\t\t\t\t\t0x00CD2000 },\n\t{ 0x1718C,\t\t\t\t\t0x00000003 },\n\t{ 0x4000,\t\t\t\t\t0x00000000 },\n\t{ CS42L43_CCM_BLK_CLK_CONTROL,\t\t\t0x00000002 },\n\t{ CS42L43_HPPATHVOL,\t\t\t\t0x011B011B },\n\t{ CS42L43_OSC_DIV_SEL,\t\t\t\t0x00000001 },\n\t{ CS42L43_DACCNFG2,\t\t\t\t0x00000005 },\n\t{ CS42L43_MIC_DETECT_CONTROL_ANDROID,\t\t0x80790079 },\n\t{ CS42L43_RELID,\t\t\t\t0x0000000F },\n};\n\nconst struct reg_default cs42l43_reg_default[CS42L43_N_DEFAULTS] = {\n\t{ CS42L43_DRV_CTRL1,\t\t\t\t0x000186C0 },\n\t{ CS42L43_DRV_CTRL3,\t\t\t\t0x286DB018 },\n\t{ CS42L43_DRV_CTRL4,\t\t\t\t0x000006D8 },\n\t{ CS42L43_DRV_CTRL_5,\t\t\t\t0x136C00C0 },\n\t{ CS42L43_GPIO_CTRL1,\t\t\t\t0x00000707 },\n\t{ CS42L43_GPIO_CTRL2,\t\t\t\t0x00000000 },\n\t{ CS42L43_GPIO_FN_SEL,\t\t\t\t0x00000000 },\n\t{ CS42L43_MCLK_SRC_SEL,\t\t\t\t0x00000000 },\n\t{ CS42L43_SAMPLE_RATE1,\t\t\t\t0x00000003 },\n\t{ CS42L43_SAMPLE_RATE2,\t\t\t\t0x00000003 },\n\t{ CS42L43_SAMPLE_RATE3,\t\t\t\t0x00000003 },\n\t{ CS42L43_SAMPLE_RATE4,\t\t\t\t0x00000003 },\n\t{ CS42L43_PLL_CONTROL,\t\t\t\t0x00000000 },\n\t{ CS42L43_FS_SELECT1,\t\t\t\t0x00000000 },\n\t{ CS42L43_FS_SELECT2,\t\t\t\t0x00000000 },\n\t{ CS42L43_FS_SELECT3,\t\t\t\t0x00000000 },\n\t{ CS42L43_FS_SELECT4,\t\t\t\t0x00000000 },\n\t{ CS42L43_PDM_CONTROL,\t\t\t\t0x00000000 },\n\t{ CS42L43_ASP_CLK_CONFIG1,\t\t\t0x00010001 },\n\t{ CS42L43_ASP_CLK_CONFIG2,\t\t\t0x00000000 },\n\t{ CS42L43_OSC_DIV_SEL,\t\t\t\t0x00000001 },\n\t{ CS42L43_ADC_B_CTRL1,\t\t\t\t0x00000000 },\n\t{ CS42L43_ADC_B_CTRL2,\t\t\t\t0x00000000 },\n\t{ CS42L43_DECIM_HPF_WNF_CTRL1,\t\t\t0x00000001 },\n\t{ CS42L43_DECIM_HPF_WNF_CTRL2,\t\t\t0x00000001 },\n\t{ CS42L43_DECIM_HPF_WNF_CTRL3,\t\t\t0x00000001 },\n\t{ CS42L43_DECIM_HPF_WNF_CTRL4,\t\t\t0x00000001 },\n\t{ CS42L43_DMIC_PDM_CTRL,\t\t\t0x00000000 },\n\t{ CS42L43_DECIM_VOL_CTRL_CH1_CH2,\t\t0x20122012 },\n\t{ CS42L43_DECIM_VOL_CTRL_CH3_CH4,\t\t0x20122012 },\n\t{ CS42L43_INTP_VOLUME_CTRL1,\t\t\t0x00000180 },\n\t{ CS42L43_INTP_VOLUME_CTRL2,\t\t\t0x00000180 },\n\t{ CS42L43_AMP1_2_VOL_RAMP,\t\t\t0x00000022 },\n\t{ CS42L43_ASP_CTRL,\t\t\t\t0x00000004 },\n\t{ CS42L43_ASP_FSYNC_CTRL1,\t\t\t0x000000FA },\n\t{ CS42L43_ASP_FSYNC_CTRL2,\t\t\t0x00000001 },\n\t{ CS42L43_ASP_FSYNC_CTRL3,\t\t\t0x00000000 },\n\t{ CS42L43_ASP_FSYNC_CTRL4,\t\t\t0x000001F4 },\n\t{ CS42L43_ASP_DATA_CTRL,\t\t\t0x0000003A },\n\t{ CS42L43_ASP_RX_EN,\t\t\t\t0x00000000 },\n\t{ CS42L43_ASP_TX_EN,\t\t\t\t0x00000000 },\n\t{ CS42L43_ASP_RX_CH1_CTRL,\t\t\t0x00170001 },\n\t{ CS42L43_ASP_RX_CH2_CTRL,\t\t\t0x00170031 },\n\t{ CS42L43_ASP_RX_CH3_CTRL,\t\t\t0x00170061 },\n\t{ CS42L43_ASP_RX_CH4_CTRL,\t\t\t0x00170091 },\n\t{ CS42L43_ASP_RX_CH5_CTRL,\t\t\t0x001700C1 },\n\t{ CS42L43_ASP_RX_CH6_CTRL,\t\t\t0x001700F1 },\n\t{ CS42L43_ASP_TX_CH1_CTRL,\t\t\t0x00170001 },\n\t{ CS42L43_ASP_TX_CH2_CTRL,\t\t\t0x00170031 },\n\t{ CS42L43_ASP_TX_CH3_CTRL,\t\t\t0x00170061 },\n\t{ CS42L43_ASP_TX_CH4_CTRL,\t\t\t0x00170091 },\n\t{ CS42L43_ASP_TX_CH5_CTRL,\t\t\t0x001700C1 },\n\t{ CS42L43_ASP_TX_CH6_CTRL,\t\t\t0x001700F1 },\n\t{ CS42L43_ASPTX1_INPUT,\t\t\t\t0x00800000 },\n\t{ CS42L43_ASPTX2_INPUT,\t\t\t\t0x00800000 },\n\t{ CS42L43_ASPTX3_INPUT,\t\t\t\t0x00800000 },\n\t{ CS42L43_ASPTX4_INPUT,\t\t\t\t0x00800000 },\n\t{ CS42L43_ASPTX5_INPUT,\t\t\t\t0x00800000 },\n\t{ CS42L43_ASPTX6_INPUT,\t\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP1_CH1_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP1_CH2_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP1_CH3_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP1_CH4_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP2_CH1_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP2_CH2_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP3_CH1_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP3_CH2_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP4_CH1_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_SWIRE_DP4_CH2_INPUT,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_INT1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_INT2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_INT3_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_INT4_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_DEC1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_DEC2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_DEC3_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_DEC4_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC1INT1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC1INT2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC1DEC1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC1DEC2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC2INT1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC2INT2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC2DEC1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_ISRC2DEC2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_EQ1MIX_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_EQ1MIX_INPUT2,\t\t\t0x00800000 },\n\t{ CS42L43_EQ1MIX_INPUT3,\t\t\t0x00800000 },\n\t{ CS42L43_EQ1MIX_INPUT4,\t\t\t0x00800000 },\n\t{ CS42L43_EQ2MIX_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_EQ2MIX_INPUT2,\t\t\t0x00800000 },\n\t{ CS42L43_EQ2MIX_INPUT3,\t\t\t0x00800000 },\n\t{ CS42L43_EQ2MIX_INPUT4,\t\t\t0x00800000 },\n\t{ CS42L43_SPDIF1_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_SPDIF2_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_AMP1MIX_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_AMP1MIX_INPUT2,\t\t\t0x00800000 },\n\t{ CS42L43_AMP1MIX_INPUT3,\t\t\t0x00800000 },\n\t{ CS42L43_AMP1MIX_INPUT4,\t\t\t0x00800000 },\n\t{ CS42L43_AMP2MIX_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_AMP2MIX_INPUT2,\t\t\t0x00800000 },\n\t{ CS42L43_AMP2MIX_INPUT3,\t\t\t0x00800000 },\n\t{ CS42L43_AMP2MIX_INPUT4,\t\t\t0x00800000 },\n\t{ CS42L43_AMP3MIX_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_AMP3MIX_INPUT2,\t\t\t0x00800000 },\n\t{ CS42L43_AMP3MIX_INPUT3,\t\t\t0x00800000 },\n\t{ CS42L43_AMP3MIX_INPUT4,\t\t\t0x00800000 },\n\t{ CS42L43_AMP4MIX_INPUT1,\t\t\t0x00800000 },\n\t{ CS42L43_AMP4MIX_INPUT2,\t\t\t0x00800000 },\n\t{ CS42L43_AMP4MIX_INPUT3,\t\t\t0x00800000 },\n\t{ CS42L43_AMP4MIX_INPUT4,\t\t\t0x00800000 },\n\t{ CS42L43_ASRC_INT_ENABLES,\t\t\t0x00000100 },\n\t{ CS42L43_ASRC_DEC_ENABLES,\t\t\t0x00000100 },\n\t{ CS42L43_PDNCNTL,\t\t\t\t0x00000000 },\n\t{ CS42L43_RINGSENSE_DEB_CTRL,\t\t\t0x0000001B },\n\t{ CS42L43_TIPSENSE_DEB_CTRL,\t\t\t0x0000001B },\n\t{ CS42L43_HS2,\t\t\t\t\t0x050106F3 },\n\t{ CS42L43_STEREO_MIC_CTRL,\t\t\t0x00000000 },\n\t{ CS42L43_STEREO_MIC_CLAMP_CTRL,\t\t0x00000001 },\n\t{ CS42L43_BLOCK_EN2,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN3,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN4,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN5,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN6,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN7,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN8,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN9,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN10,\t\t\t\t0x00000000 },\n\t{ CS42L43_BLOCK_EN11,\t\t\t\t0x00000000 },\n\t{ CS42L43_TONE_CH1_CTRL,\t\t\t0x00000000 },\n\t{ CS42L43_TONE_CH2_CTRL,\t\t\t0x00000000 },\n\t{ CS42L43_MIC_DETECT_CONTROL_1,\t\t\t0x00000003 },\n\t{ CS42L43_HS_BIAS_SENSE_AND_CLAMP_AUTOCONTROL,\t0x02000003 },\n\t{ CS42L43_MIC_DETECT_CONTROL_ANDROID,\t\t0x80790079 },\n\t{ CS42L43_ISRC1_CTRL,\t\t\t\t0x00000000 },\n\t{ CS42L43_ISRC2_CTRL,\t\t\t\t0x00000000 },\n\t{ CS42L43_CTRL_REG,\t\t\t\t0x00000006 },\n\t{ CS42L43_FDIV_FRAC,\t\t\t\t0x40000000 },\n\t{ CS42L43_CAL_RATIO,\t\t\t\t0x00000080 },\n\t{ CS42L43_SPI_CLK_CONFIG1,\t\t\t0x00000000 },\n\t{ CS42L43_SPI_CONFIG1,\t\t\t\t0x00000000 },\n\t{ CS42L43_SPI_CONFIG2,\t\t\t\t0x00000000 },\n\t{ CS42L43_SPI_CONFIG3,\t\t\t\t0x00000001 },\n\t{ CS42L43_SPI_CONFIG4,\t\t\t\t0x00000000 },\n\t{ CS42L43_TRAN_CONFIG3,\t\t\t\t0x00000000 },\n\t{ CS42L43_TRAN_CONFIG4,\t\t\t\t0x00000000 },\n\t{ CS42L43_TRAN_CONFIG5,\t\t\t\t0x00000000 },\n\t{ CS42L43_TRAN_CONFIG6,\t\t\t\t0x00000000 },\n\t{ CS42L43_TRAN_CONFIG7,\t\t\t\t0x00000000 },\n\t{ CS42L43_TRAN_CONFIG8,\t\t\t\t0x00000000 },\n\t{ CS42L43_DACCNFG1,\t\t\t\t0x00000008 },\n\t{ CS42L43_DACCNFG2,\t\t\t\t0x00000005 },\n\t{ CS42L43_HPPATHVOL,\t\t\t\t0x011B011B },\n\t{ CS42L43_PGAVOL,\t\t\t\t0x00003470 },\n\t{ CS42L43_LOADDETENA,\t\t\t\t0x00000000 },\n\t{ CS42L43_CTRL,\t\t\t\t\t0x00000037 },\n\t{ CS42L43_COEFF_DATA_IN0,\t\t\t0x00000000 },\n\t{ CS42L43_COEFF_RD_WR0,\t\t\t\t0x00000000 },\n\t{ CS42L43_START_EQZ0,\t\t\t\t0x00000000 },\n\t{ CS42L43_MUTE_EQ_IN0,\t\t\t\t0x00000000 },\n\t{ CS42L43_DECIM_MASK,\t\t\t\t0x0000000F },\n\t{ CS42L43_EQ_MIX_MASK,\t\t\t\t0x0000000F },\n\t{ CS42L43_ASP_MASK,\t\t\t\t0x000000FF },\n\t{ CS42L43_PLL_MASK,\t\t\t\t0x00000003 },\n\t{ CS42L43_SOFT_MASK,\t\t\t\t0x0000FFFF },\n\t{ CS42L43_SWIRE_MASK,\t\t\t\t0x00007FFF },\n\t{ CS42L43_MSM_MASK,\t\t\t\t0x00000FFF },\n\t{ CS42L43_ACC_DET_MASK,\t\t\t\t0x00000FFF },\n\t{ CS42L43_I2C_TGT_MASK,\t\t\t\t0x00000003 },\n\t{ CS42L43_SPI_MSTR_MASK,\t\t\t0x00000007 },\n\t{ CS42L43_SW_TO_SPI_BRIDGE_MASK,\t\t0x00000001 },\n\t{ CS42L43_OTP_MASK,\t\t\t\t0x00000007 },\n\t{ CS42L43_CLASS_D_AMP_MASK,\t\t\t0x00003FFF },\n\t{ CS42L43_GPIO_INT_MASK,\t\t\t0x0000003F },\n\t{ CS42L43_ASRC_MASK,\t\t\t\t0x0000000F },\n\t{ CS42L43_HPOUT_MASK,\t\t\t\t0x00000003 },\n};\nEXPORT_SYMBOL_NS_GPL(cs42l43_reg_default, MFD_CS42L43);\n\nbool cs42l43_readable_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase CS42L43_DEVID:\n\tcase CS42L43_REVID:\n\tcase CS42L43_RELID:\n\tcase CS42L43_SFT_RESET:\n\tcase CS42L43_DRV_CTRL1:\n\tcase CS42L43_DRV_CTRL3:\n\tcase CS42L43_DRV_CTRL4:\n\tcase CS42L43_DRV_CTRL_5:\n\tcase CS42L43_GPIO_CTRL1:\n\tcase CS42L43_GPIO_CTRL2:\n\tcase CS42L43_GPIO_STS:\n\tcase CS42L43_GPIO_FN_SEL:\n\tcase CS42L43_MCLK_SRC_SEL:\n\tcase CS42L43_SAMPLE_RATE1 ... CS42L43_SAMPLE_RATE4:\n\tcase CS42L43_PLL_CONTROL:\n\tcase CS42L43_FS_SELECT1 ... CS42L43_FS_SELECT4:\n\tcase CS42L43_PDM_CONTROL:\n\tcase CS42L43_ASP_CLK_CONFIG1 ... CS42L43_ASP_CLK_CONFIG2:\n\tcase CS42L43_OSC_DIV_SEL:\n\tcase CS42L43_ADC_B_CTRL1 ...  CS42L43_ADC_B_CTRL2:\n\tcase CS42L43_DECIM_HPF_WNF_CTRL1 ... CS42L43_DECIM_HPF_WNF_CTRL4:\n\tcase CS42L43_DMIC_PDM_CTRL:\n\tcase CS42L43_DECIM_VOL_CTRL_CH1_CH2 ... CS42L43_DECIM_VOL_CTRL_CH3_CH4:\n\tcase CS42L43_INTP_VOLUME_CTRL1 ... CS42L43_INTP_VOLUME_CTRL2:\n\tcase CS42L43_AMP1_2_VOL_RAMP:\n\tcase CS42L43_ASP_CTRL:\n\tcase CS42L43_ASP_FSYNC_CTRL1 ... CS42L43_ASP_FSYNC_CTRL4:\n\tcase CS42L43_ASP_DATA_CTRL:\n\tcase CS42L43_ASP_RX_EN ... CS42L43_ASP_TX_EN:\n\tcase CS42L43_ASP_RX_CH1_CTRL ... CS42L43_ASP_RX_CH6_CTRL:\n\tcase CS42L43_ASP_TX_CH1_CTRL ... CS42L43_ASP_TX_CH6_CTRL:\n\tcase CS42L43_OTP_REVISION_ID:\n\tcase CS42L43_ASPTX1_INPUT:\n\tcase CS42L43_ASPTX2_INPUT:\n\tcase CS42L43_ASPTX3_INPUT:\n\tcase CS42L43_ASPTX4_INPUT:\n\tcase CS42L43_ASPTX5_INPUT:\n\tcase CS42L43_ASPTX6_INPUT:\n\tcase CS42L43_SWIRE_DP1_CH1_INPUT:\n\tcase CS42L43_SWIRE_DP1_CH2_INPUT:\n\tcase CS42L43_SWIRE_DP1_CH3_INPUT:\n\tcase CS42L43_SWIRE_DP1_CH4_INPUT:\n\tcase CS42L43_SWIRE_DP2_CH1_INPUT:\n\tcase CS42L43_SWIRE_DP2_CH2_INPUT:\n\tcase CS42L43_SWIRE_DP3_CH1_INPUT:\n\tcase CS42L43_SWIRE_DP3_CH2_INPUT:\n\tcase CS42L43_SWIRE_DP4_CH1_INPUT:\n\tcase CS42L43_SWIRE_DP4_CH2_INPUT:\n\tcase CS42L43_ASRC_INT1_INPUT1:\n\tcase CS42L43_ASRC_INT2_INPUT1:\n\tcase CS42L43_ASRC_INT3_INPUT1:\n\tcase CS42L43_ASRC_INT4_INPUT1:\n\tcase CS42L43_ASRC_DEC1_INPUT1:\n\tcase CS42L43_ASRC_DEC2_INPUT1:\n\tcase CS42L43_ASRC_DEC3_INPUT1:\n\tcase CS42L43_ASRC_DEC4_INPUT1:\n\tcase CS42L43_ISRC1INT1_INPUT1:\n\tcase CS42L43_ISRC1INT2_INPUT1:\n\tcase CS42L43_ISRC1DEC1_INPUT1:\n\tcase CS42L43_ISRC1DEC2_INPUT1:\n\tcase CS42L43_ISRC2INT1_INPUT1:\n\tcase CS42L43_ISRC2INT2_INPUT1:\n\tcase CS42L43_ISRC2DEC1_INPUT1:\n\tcase CS42L43_ISRC2DEC2_INPUT1:\n\tcase CS42L43_EQ1MIX_INPUT1 ... CS42L43_EQ1MIX_INPUT4:\n\tcase CS42L43_EQ2MIX_INPUT1 ... CS42L43_EQ2MIX_INPUT4:\n\tcase CS42L43_SPDIF1_INPUT1:\n\tcase CS42L43_SPDIF2_INPUT1:\n\tcase CS42L43_AMP1MIX_INPUT1 ... CS42L43_AMP1MIX_INPUT4:\n\tcase CS42L43_AMP2MIX_INPUT1 ... CS42L43_AMP2MIX_INPUT4:\n\tcase CS42L43_AMP3MIX_INPUT1 ... CS42L43_AMP3MIX_INPUT4:\n\tcase CS42L43_AMP4MIX_INPUT1 ... CS42L43_AMP4MIX_INPUT4:\n\tcase CS42L43_ASRC_INT_ENABLES ... CS42L43_ASRC_DEC_ENABLES:\n\tcase CS42L43_PDNCNTL:\n\tcase CS42L43_RINGSENSE_DEB_CTRL:\n\tcase CS42L43_TIPSENSE_DEB_CTRL:\n\tcase CS42L43_TIP_RING_SENSE_INTERRUPT_STATUS:\n\tcase CS42L43_HS2:\n\tcase CS42L43_HS_STAT:\n\tcase CS42L43_MCU_SW_INTERRUPT:\n\tcase CS42L43_STEREO_MIC_CTRL:\n\tcase CS42L43_STEREO_MIC_CLAMP_CTRL:\n\tcase CS42L43_BLOCK_EN2 ... CS42L43_BLOCK_EN11:\n\tcase CS42L43_TONE_CH1_CTRL ... CS42L43_TONE_CH2_CTRL:\n\tcase CS42L43_MIC_DETECT_CONTROL_1:\n\tcase CS42L43_DETECT_STATUS_1:\n\tcase CS42L43_HS_BIAS_SENSE_AND_CLAMP_AUTOCONTROL:\n\tcase CS42L43_MIC_DETECT_CONTROL_ANDROID:\n\tcase CS42L43_ISRC1_CTRL:\n\tcase CS42L43_ISRC2_CTRL:\n\tcase CS42L43_CTRL_REG:\n\tcase CS42L43_FDIV_FRAC:\n\tcase CS42L43_CAL_RATIO:\n\tcase CS42L43_SPI_CLK_CONFIG1:\n\tcase CS42L43_SPI_CONFIG1 ... CS42L43_SPI_CONFIG4:\n\tcase CS42L43_SPI_STATUS1 ... CS42L43_SPI_STATUS2:\n\tcase CS42L43_TRAN_CONFIG1 ... CS42L43_TRAN_CONFIG8:\n\tcase CS42L43_TRAN_STATUS1 ... CS42L43_TRAN_STATUS3:\n\tcase CS42L43_TX_DATA:\n\tcase CS42L43_RX_DATA:\n\tcase CS42L43_DACCNFG1 ... CS42L43_DACCNFG2:\n\tcase CS42L43_HPPATHVOL:\n\tcase CS42L43_PGAVOL:\n\tcase CS42L43_LOADDETRESULTS:\n\tcase CS42L43_LOADDETENA:\n\tcase CS42L43_CTRL:\n\tcase CS42L43_COEFF_DATA_IN0:\n\tcase CS42L43_COEFF_RD_WR0:\n\tcase CS42L43_INIT_DONE0:\n\tcase CS42L43_START_EQZ0:\n\tcase CS42L43_MUTE_EQ_IN0:\n\tcase CS42L43_DECIM_INT ... CS42L43_HPOUT_INT:\n\tcase CS42L43_DECIM_MASK ... CS42L43_HPOUT_MASK:\n\tcase CS42L43_DECIM_INT_SHADOW ... CS42L43_HP_OUT_SHADOW:\n\tcase CS42L43_BOOT_CONTROL:\n\tcase CS42L43_BLOCK_EN:\n\tcase CS42L43_SHUTTER_CONTROL:\n\tcase CS42L43_MCU_SW_REV ... CS42L43_MCU_RAM_MAX:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\nEXPORT_SYMBOL_NS_GPL(cs42l43_readable_register, MFD_CS42L43);\n\nbool cs42l43_precious_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase CS42L43_SFT_RESET:\n\tcase CS42L43_TX_DATA:\n\tcase CS42L43_RX_DATA:\n\tcase CS42L43_DECIM_INT ... CS42L43_HPOUT_INT:\n\tcase CS42L43_MCU_SW_REV ... CS42L43_MCU_RAM_MAX:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\nEXPORT_SYMBOL_NS_GPL(cs42l43_precious_register, MFD_CS42L43);\n\nbool cs42l43_volatile_register(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase CS42L43_DEVID:\n\tcase CS42L43_REVID:\n\tcase CS42L43_RELID:\n\tcase CS42L43_GPIO_STS:\n\tcase CS42L43_OTP_REVISION_ID:\n\tcase CS42L43_TIP_RING_SENSE_INTERRUPT_STATUS:\n\tcase CS42L43_HS_STAT:\n\tcase CS42L43_MCU_SW_INTERRUPT:\n\tcase CS42L43_DETECT_STATUS_1:\n\tcase CS42L43_SPI_STATUS1 ... CS42L43_SPI_STATUS2:\n\tcase CS42L43_TRAN_CONFIG1 ... CS42L43_TRAN_CONFIG2:\n\tcase CS42L43_TRAN_CONFIG8:\n\tcase CS42L43_TRAN_STATUS1 ... CS42L43_TRAN_STATUS3:\n\tcase CS42L43_LOADDETRESULTS:\n\tcase CS42L43_INIT_DONE0:\n\tcase CS42L43_DECIM_INT_SHADOW ... CS42L43_HP_OUT_SHADOW:\n\tcase CS42L43_BOOT_CONTROL:\n\tcase CS42L43_BLOCK_EN:\n\t\treturn true;\n\tdefault:\n\t\treturn cs42l43_precious_register(dev, reg);\n\t}\n}\nEXPORT_SYMBOL_NS_GPL(cs42l43_volatile_register, MFD_CS42L43);\n\n#define CS42L43_IRQ_OFFSET(reg) ((CS42L43_##reg##_INT) - CS42L43_DECIM_INT)\n\n#define CS42L43_IRQ_REG(name, reg) REGMAP_IRQ_REG(CS42L43_##name, \\\n\t\t\t\t\t\t  CS42L43_IRQ_OFFSET(reg), \\\n\t\t\t\t\t\t  CS42L43_##name##_INT_MASK)\n\nstatic const struct regmap_irq cs42l43_regmap_irqs[] = {\n\tCS42L43_IRQ_REG(PLL_LOST_LOCK,\t\t\t\tPLL),\n\tCS42L43_IRQ_REG(PLL_READY,\t\t\t\tPLL),\n\n\tCS42L43_IRQ_REG(HP_STARTUP_DONE,\t\t\tMSM),\n\tCS42L43_IRQ_REG(HP_SHUTDOWN_DONE,\t\t\tMSM),\n\tCS42L43_IRQ_REG(HSDET_DONE,\t\t\t\tMSM),\n\tCS42L43_IRQ_REG(TIPSENSE_UNPLUG_DB,\t\t\tMSM),\n\tCS42L43_IRQ_REG(TIPSENSE_PLUG_DB,\t\t\tMSM),\n\tCS42L43_IRQ_REG(RINGSENSE_UNPLUG_DB,\t\t\tMSM),\n\tCS42L43_IRQ_REG(RINGSENSE_PLUG_DB,\t\t\tMSM),\n\tCS42L43_IRQ_REG(TIPSENSE_UNPLUG_PDET,\t\t\tMSM),\n\tCS42L43_IRQ_REG(TIPSENSE_PLUG_PDET,\t\t\tMSM),\n\tCS42L43_IRQ_REG(RINGSENSE_UNPLUG_PDET,\t\t\tMSM),\n\tCS42L43_IRQ_REG(RINGSENSE_PLUG_PDET,\t\t\tMSM),\n\n\tCS42L43_IRQ_REG(HS2_BIAS_SENSE,\t\t\t\tACC_DET),\n\tCS42L43_IRQ_REG(HS1_BIAS_SENSE,\t\t\t\tACC_DET),\n\tCS42L43_IRQ_REG(DC_DETECT1_FALSE,\t\t\tACC_DET),\n\tCS42L43_IRQ_REG(DC_DETECT1_TRUE,\t\t\tACC_DET),\n\tCS42L43_IRQ_REG(HSBIAS_CLAMPED,\t\t\t\tACC_DET),\n\tCS42L43_IRQ_REG(HS3_4_BIAS_SENSE,\t\t\tACC_DET),\n\n\tCS42L43_IRQ_REG(AMP2_CLK_STOP_FAULT,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_CLK_STOP_FAULT,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP2_VDDSPK_FAULT,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_VDDSPK_FAULT,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP2_SHUTDOWN_DONE,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_SHUTDOWN_DONE,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP2_STARTUP_DONE,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_STARTUP_DONE,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP2_THERM_SHDN,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_THERM_SHDN,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP2_THERM_WARN,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_THERM_WARN,\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP2_SCDET,\t\t\t\tCLASS_D_AMP),\n\tCS42L43_IRQ_REG(AMP1_SCDET,\t\t\t\tCLASS_D_AMP),\n\n\tCS42L43_IRQ_REG(GPIO3_FALL,\t\t\t\tGPIO),\n\tCS42L43_IRQ_REG(GPIO3_RISE,\t\t\t\tGPIO),\n\tCS42L43_IRQ_REG(GPIO2_FALL,\t\t\t\tGPIO),\n\tCS42L43_IRQ_REG(GPIO2_RISE,\t\t\t\tGPIO),\n\tCS42L43_IRQ_REG(GPIO1_FALL,\t\t\t\tGPIO),\n\tCS42L43_IRQ_REG(GPIO1_RISE,\t\t\t\tGPIO),\n\n\tCS42L43_IRQ_REG(HP_ILIMIT,\t\t\t\tHPOUT),\n\tCS42L43_IRQ_REG(HP_LOADDET_DONE,\t\t\tHPOUT),\n};\n\nstatic const struct regmap_irq_chip cs42l43_irq_chip = {\n\t.name = \"cs42l43\",\n\n\t.status_base = CS42L43_DECIM_INT,\n\t.mask_base = CS42L43_DECIM_MASK,\n\t.num_regs = 16,\n\n\t.irqs = cs42l43_regmap_irqs,\n\t.num_irqs = ARRAY_SIZE(cs42l43_regmap_irqs),\n\n\t.runtime_pm = true,\n};\n\nstatic const char * const cs42l43_core_supplies[] = {\n\t\"vdd-a\", \"vdd-io\", \"vdd-cp\",\n};\n\nstatic const char * const cs42l43_parent_supplies[] = { \"vdd-amp\" };\n\nstatic const struct mfd_cell cs42l43_devs[] = {\n\t{ .name = \"cs42l43-pinctrl\", },\n\t{ .name = \"cs42l43-spi\", },\n\t{\n\t\t.name = \"cs42l43-codec\",\n\t\t.parent_supplies = cs42l43_parent_supplies,\n\t\t.num_parent_supplies = ARRAY_SIZE(cs42l43_parent_supplies),\n\t},\n};\n\n \nstatic int cs42l43_soft_reset(struct cs42l43 *cs42l43)\n{\n\tstatic const struct reg_sequence reset[] = {\n\t\t{ CS42L43_SFT_RESET, CS42L43_SFT_RESET_VAL },\n\t};\n\n\treinit_completion(&cs42l43->device_detach);\n\n\t \n\tregcache_cache_only(cs42l43->regmap, true);\n\tregmap_multi_reg_write_bypassed(cs42l43->regmap, reset, ARRAY_SIZE(reset));\n\n\tmsleep(CS42L43_RESET_DELAY);\n\n\tif (cs42l43->sdw) {\n\t\tunsigned long timeout = msecs_to_jiffies(CS42L43_SDW_DETACH_TIMEOUT);\n\t\tunsigned long time;\n\n\t\ttime = wait_for_completion_timeout(&cs42l43->device_detach, timeout);\n\t\tif (!time) {\n\t\t\tdev_err(cs42l43->dev, \"Timed out waiting for device detach\\n\");\n\t\t\treturn -ETIMEDOUT;\n\t\t}\n\t}\n\n\treturn -EAGAIN;\n}\n\n \nstatic int cs42l43_wait_for_attach(struct cs42l43 *cs42l43)\n{\n\tif (!cs42l43->attached) {\n\t\tunsigned long timeout = msecs_to_jiffies(CS42L43_SDW_ATTACH_TIMEOUT);\n\t\tunsigned long time;\n\n\t\ttime = wait_for_completion_timeout(&cs42l43->device_attach, timeout);\n\t\tif (!time) {\n\t\t\tdev_err(cs42l43->dev, \"Timed out waiting for device re-attach\\n\");\n\t\t\treturn -ETIMEDOUT;\n\t\t}\n\t}\n\n\tregcache_cache_only(cs42l43->regmap, false);\n\n\t \n\tif (cs42l43->sdw)\n\t\tregmap_write(cs42l43->regmap, CS42L43_OSC_DIV_SEL,\n\t\t\t     CS42L43_OSC_DIV2_EN_MASK);\n\n\treturn 0;\n}\n\n \nstatic int cs42l43_mcu_stage_2_3(struct cs42l43 *cs42l43, bool shadow)\n{\n\tunsigned int need_reg = CS42L43_NEED_CONFIGS;\n\tunsigned int val;\n\tint ret;\n\n\tif (shadow)\n\t\tneed_reg = CS42L43_FW_SH_BOOT_CFG_NEED_CONFIGS;\n\n\tregmap_write(cs42l43->regmap, need_reg, 0);\n\n\tret = regmap_read_poll_timeout(cs42l43->regmap, CS42L43_BOOT_STATUS,\n\t\t\t\t       val, (val == CS42L43_MCU_BOOT_STAGE3),\n\t\t\t\t       CS42L43_MCU_POLL, CS42L43_MCU_CMD_TIMEOUT);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to move to stage 3: %d, 0x%x\\n\", ret, val);\n\t\treturn ret;\n\t}\n\n\treturn -EAGAIN;\n}\n\n \nstatic int cs42l43_mcu_stage_3_2(struct cs42l43 *cs42l43)\n{\n\tregmap_write(cs42l43->regmap, CS42L43_FW_MISSION_CTRL_NEED_CONFIGS,\n\t\t     CS42L43_FW_PATCH_NEED_CFG_MASK);\n\tregmap_write(cs42l43->regmap, CS42L43_FW_MISSION_CTRL_HAVE_CONFIGS, 0);\n\n\treturn cs42l43_soft_reset(cs42l43);\n}\n\n \nstatic int cs42l43_mcu_disable(struct cs42l43 *cs42l43)\n{\n\tunsigned int val;\n\tint ret;\n\n\tregmap_write(cs42l43->regmap, CS42L43_FW_MISSION_CTRL_MM_MCU_CFG_REG,\n\t\t     CS42L43_FW_MISSION_CTRL_MM_MCU_CFG_DISABLE_VAL);\n\tregmap_write(cs42l43->regmap, CS42L43_FW_MISSION_CTRL_MM_CTRL_SELECTION,\n\t\t     CS42L43_FW_MM_CTRL_MCU_SEL_MASK);\n\tregmap_write(cs42l43->regmap, CS42L43_MCU_SW_INTERRUPT, CS42L43_CONTROL_IND_MASK);\n\tregmap_write(cs42l43->regmap, CS42L43_MCU_SW_INTERRUPT, 0);\n\n\tret = regmap_read_poll_timeout(cs42l43->regmap, CS42L43_SOFT_INT_SHADOW, val,\n\t\t\t\t       (val & CS42L43_CONTROL_APPLIED_INT_MASK),\n\t\t\t\t       CS42L43_MCU_POLL, CS42L43_MCU_CMD_TIMEOUT);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to disable firmware: %d, 0x%x\\n\", ret, val);\n\t\treturn ret;\n\t}\n\n\t \n\treturn cs42l43_soft_reset(cs42l43);\n}\n\n \nstatic void cs42l43_mcu_load_firmware(const struct firmware *firmware, void *context)\n{\n\tstruct cs42l43 *cs42l43 = context;\n\tconst struct cs42l43_patch_header *hdr;\n\tunsigned int loadaddr, val;\n\tint ret;\n\n\tif (!firmware) {\n\t\tdev_err(cs42l43->dev, \"Failed to load firmware\\n\");\n\t\tcs42l43->firmware_error = -ENODEV;\n\t\tgoto err;\n\t}\n\n\thdr = (const struct cs42l43_patch_header *)&firmware->data[0];\n\tloadaddr = le32_to_cpu(hdr->load_addr);\n\n\tif (le16_to_cpu(hdr->version) != CS42L43_MCU_UPDATE_FORMAT) {\n\t\tdev_err(cs42l43->dev, \"Bad firmware file format: %d\\n\", hdr->version);\n\t\tcs42l43->firmware_error = -EINVAL;\n\t\tgoto err_release;\n\t}\n\n\tregmap_write(cs42l43->regmap, CS42L43_PATCH_START_ADDR, loadaddr);\n\tregmap_bulk_write(cs42l43->regmap, loadaddr + CS42L43_MCU_UPDATE_OFFSET,\n\t\t\t  &firmware->data[0], firmware->size / sizeof(u32));\n\n\tregmap_write(cs42l43->regmap, CS42L43_MCU_SW_INTERRUPT, CS42L43_PATCH_IND_MASK);\n\tregmap_write(cs42l43->regmap, CS42L43_MCU_SW_INTERRUPT, 0);\n\n\tret = regmap_read_poll_timeout(cs42l43->regmap, CS42L43_SOFT_INT_SHADOW, val,\n\t\t\t\t       (val & CS42L43_PATCH_APPLIED_INT_MASK),\n\t\t\t\t       CS42L43_MCU_POLL, CS42L43_MCU_UPDATE_TIMEOUT);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to update firmware: %d, 0x%x\\n\", ret, val);\n\t\tcs42l43->firmware_error = ret;\n\t\tgoto err_release;\n\t}\n\nerr_release:\n\trelease_firmware(firmware);\nerr:\n\tcomplete(&cs42l43->firmware_download);\n}\n\n \nstatic int cs42l43_mcu_update_step(struct cs42l43 *cs42l43)\n{\n\tunsigned int mcu_rev, bios_rev, boot_status, secure_cfg;\n\tbool patched, shadow;\n\tint ret;\n\n\t \n\tregmap_read(cs42l43->regmap, CS42L43_SOFT_INT, &mcu_rev);\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_BOOT_STATUS, &boot_status);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to read boot status: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_MCU_SW_REV, &mcu_rev);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to read firmware revision: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tbios_rev = (((mcu_rev & CS42L43_BIOS_MAJOR_REV_MASK) << 12) |\n\t\t    ((mcu_rev & CS42L43_BIOS_MINOR_REV_MASK) << 4) |\n\t\t    ((mcu_rev & CS42L43_BIOS_SUBMINOR_REV_MASK) >> 8)) >>\n\t\t   CS42L43_BIOS_MAJOR_REV_SHIFT;\n\tmcu_rev = ((mcu_rev & CS42L43_FW_MAJOR_REV_MASK) << 12) |\n\t\t  ((mcu_rev & CS42L43_FW_MINOR_REV_MASK) << 4) |\n\t\t  ((mcu_rev & CS42L43_FW_SUBMINOR_REV_MASK) >> 8);\n\n\t \n\tpatched = mcu_rev >= CS42L43_MCU_SUPPORTED_REV ||\n\t\t  bios_rev >= CS42L43_MCU_SUPPORTED_BIOS_REV;\n\t \n\tshadow = mcu_rev >= CS42L43_MCU_SHADOW_REGS_REQUIRED_REV;\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_BOOT_CONTROL, &secure_cfg);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to read security settings: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tcs42l43->hw_lock = secure_cfg & CS42L43_LOCK_HW_STS_MASK;\n\n\tif (!patched && cs42l43->hw_lock) {\n\t\tdev_err(cs42l43->dev, \"Unpatched secure device\\n\");\n\t\treturn -EPERM;\n\t}\n\n\tdev_dbg(cs42l43->dev, \"Firmware(0x%x, 0x%x) in boot stage %d\\n\",\n\t\tmcu_rev, bios_rev, boot_status);\n\n\tswitch (boot_status) {\n\tcase CS42L43_MCU_BOOT_STAGE2:\n\t\tif (!patched) {\n\t\t\tret = request_firmware_nowait(THIS_MODULE, FW_ACTION_UEVENT,\n\t\t\t\t\t\t      \"cs42l43.bin\", cs42l43->dev,\n\t\t\t\t\t\t      GFP_KERNEL, cs42l43,\n\t\t\t\t\t\t      cs42l43_mcu_load_firmware);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(cs42l43->dev, \"Failed to request firmware: %d\\n\", ret);\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\twait_for_completion(&cs42l43->firmware_download);\n\n\t\t\tif (cs42l43->firmware_error)\n\t\t\t\treturn cs42l43->firmware_error;\n\n\t\t\treturn -EAGAIN;\n\t\t} else {\n\t\t\treturn cs42l43_mcu_stage_2_3(cs42l43, shadow);\n\t\t}\n\tcase CS42L43_MCU_BOOT_STAGE3:\n\t\tif (patched)\n\t\t\treturn cs42l43_mcu_disable(cs42l43);\n\t\telse\n\t\t\treturn cs42l43_mcu_stage_3_2(cs42l43);\n\tcase CS42L43_MCU_BOOT_STAGE4:\n\t\treturn 0;\n\tdefault:\n\t\tdev_err(cs42l43->dev, \"Invalid boot status: %d\\n\", boot_status);\n\t\treturn -EINVAL;\n\t}\n}\n\n \nstatic int cs42l43_mcu_update(struct cs42l43 *cs42l43)\n{\n\tint i, ret;\n\n\tfor (i = 0; i < CS42L43_MCU_UPDATE_RETRIES; i++) {\n\t\tret = cs42l43_mcu_update_step(cs42l43);\n\t\tif (ret != -EAGAIN)\n\t\t\treturn ret;\n\n\t\tret = cs42l43_wait_for_attach(cs42l43);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tdev_err(cs42l43->dev, \"Failed retrying update\\n\");\n\treturn -ETIMEDOUT;\n}\n\nstatic int cs42l43_irq_config(struct cs42l43 *cs42l43)\n{\n\tstruct irq_data *irq_data;\n\tunsigned long irq_flags;\n\tint ret;\n\n\tif (cs42l43->sdw)\n\t\tcs42l43->irq = cs42l43->sdw->irq;\n\n\tcs42l43->irq_chip = cs42l43_irq_chip;\n\tcs42l43->irq_chip.irq_drv_data = cs42l43;\n\n\tirq_data = irq_get_irq_data(cs42l43->irq);\n\tif (!irq_data) {\n\t\tdev_err(cs42l43->dev, \"Invalid IRQ: %d\\n\", cs42l43->irq);\n\t\treturn -EINVAL;\n\t}\n\n\tirq_flags = irqd_get_trigger_type(irq_data);\n\tswitch (irq_flags) {\n\tcase IRQF_TRIGGER_LOW:\n\tcase IRQF_TRIGGER_HIGH:\n\tcase IRQF_TRIGGER_RISING:\n\tcase IRQF_TRIGGER_FALLING:\n\t\tbreak;\n\tcase IRQ_TYPE_NONE:\n\tdefault:\n\t\tirq_flags = IRQF_TRIGGER_LOW;\n\t\tbreak;\n\t}\n\n\tirq_flags |= IRQF_ONESHOT;\n\n\tret = devm_regmap_add_irq_chip(cs42l43->dev, cs42l43->regmap,\n\t\t\t\t       cs42l43->irq, irq_flags, 0,\n\t\t\t\t       &cs42l43->irq_chip, &cs42l43->irq_data);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to add IRQ chip: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tdev_dbg(cs42l43->dev, \"Configured IRQ %d with flags 0x%lx\\n\",\n\t\tcs42l43->irq, irq_flags);\n\n\treturn 0;\n}\n\nstatic void cs42l43_boot_work(struct work_struct *work)\n{\n\tstruct cs42l43 *cs42l43 = container_of(work, struct cs42l43, boot_work);\n\tunsigned int devid, revid, otp;\n\tint ret;\n\n\tret = cs42l43_wait_for_attach(cs42l43);\n\tif (ret)\n\t\tgoto err;\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_DEVID, &devid);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to read devid: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tswitch (devid) {\n\tcase CS42L43_DEVID_VAL:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(cs42l43->dev, \"Unrecognised devid: 0x%06x\\n\", devid);\n\t\tgoto err;\n\t}\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_REVID, &revid);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to read rev: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_OTP_REVISION_ID, &otp);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to read otp rev: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tdev_info(cs42l43->dev,\n\t\t \"devid: 0x%06x, rev: 0x%02x, otp: 0x%02x\\n\", devid, revid, otp);\n\n\tret = cs42l43_mcu_update(cs42l43);\n\tif (ret)\n\t\tgoto err;\n\n\tret = regmap_register_patch(cs42l43->regmap, cs42l43_reva_patch,\n\t\t\t\t    ARRAY_SIZE(cs42l43_reva_patch));\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to apply register patch: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tret = cs42l43_irq_config(cs42l43);\n\tif (ret)\n\t\tgoto err;\n\n\tret = devm_mfd_add_devices(cs42l43->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t   cs42l43_devs, ARRAY_SIZE(cs42l43_devs),\n\t\t\t\t   NULL, 0, NULL);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to add subdevices: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tpm_runtime_mark_last_busy(cs42l43->dev);\n\tpm_runtime_put_autosuspend(cs42l43->dev);\n\n\treturn;\n\nerr:\n\tpm_runtime_put_sync(cs42l43->dev);\n\tcs42l43_dev_remove(cs42l43);\n}\n\nstatic int cs42l43_power_up(struct cs42l43 *cs42l43)\n{\n\tint ret;\n\n\tret = regulator_enable(cs42l43->vdd_p);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to enable vdd-p: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tusleep_range(CS42L43_VDDP_DELAY, 2 * CS42L43_VDDP_DELAY);\n\n\tgpiod_set_value_cansleep(cs42l43->reset, 1);\n\n\tret = regulator_bulk_enable(CS42L43_N_SUPPLIES, cs42l43->core_supplies);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to enable core supplies: %d\\n\", ret);\n\t\tgoto err_reset;\n\t}\n\n\tret = regulator_enable(cs42l43->vdd_d);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to enable vdd-d: %d\\n\", ret);\n\t\tgoto err_core_supplies;\n\t}\n\n\tusleep_range(CS42L43_VDDD_DELAY, 2 * CS42L43_VDDD_DELAY);\n\n\treturn 0;\n\nerr_core_supplies:\n\tregulator_bulk_disable(CS42L43_N_SUPPLIES, cs42l43->core_supplies);\nerr_reset:\n\tgpiod_set_value_cansleep(cs42l43->reset, 0);\n\tregulator_disable(cs42l43->vdd_p);\n\n\treturn ret;\n}\n\nstatic int cs42l43_power_down(struct cs42l43 *cs42l43)\n{\n\tint ret;\n\n\tret = regulator_disable(cs42l43->vdd_d);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to disable vdd-d: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = regulator_bulk_disable(CS42L43_N_SUPPLIES, cs42l43->core_supplies);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to disable core supplies: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tgpiod_set_value_cansleep(cs42l43->reset, 0);\n\n\tret = regulator_disable(cs42l43->vdd_p);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to disable vdd-p: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nint cs42l43_dev_probe(struct cs42l43 *cs42l43)\n{\n\tint i, ret;\n\n\tdev_set_drvdata(cs42l43->dev, cs42l43);\n\n\tmutex_init(&cs42l43->pll_lock);\n\tinit_completion(&cs42l43->device_attach);\n\tinit_completion(&cs42l43->device_detach);\n\tinit_completion(&cs42l43->firmware_download);\n\tINIT_WORK(&cs42l43->boot_work, cs42l43_boot_work);\n\n\tregcache_cache_only(cs42l43->regmap, true);\n\n\tcs42l43->reset = devm_gpiod_get_optional(cs42l43->dev, \"reset\", GPIOD_OUT_LOW);\n\tif (IS_ERR(cs42l43->reset))\n\t\treturn dev_err_probe(cs42l43->dev, PTR_ERR(cs42l43->reset),\n\t\t\t\t     \"Failed to get reset\\n\");\n\n\tcs42l43->vdd_p = devm_regulator_get(cs42l43->dev, \"vdd-p\");\n\tif (IS_ERR(cs42l43->vdd_p))\n\t\treturn dev_err_probe(cs42l43->dev, PTR_ERR(cs42l43->vdd_p),\n\t\t\t\t     \"Failed to get vdd-p\\n\");\n\n\tcs42l43->vdd_d = devm_regulator_get(cs42l43->dev, \"vdd-d\");\n\tif (IS_ERR(cs42l43->vdd_d))\n\t\treturn dev_err_probe(cs42l43->dev, PTR_ERR(cs42l43->vdd_d),\n\t\t\t\t     \"Failed to get vdd-d\\n\");\n\n\tBUILD_BUG_ON(ARRAY_SIZE(cs42l43_core_supplies) != CS42L43_N_SUPPLIES);\n\n\tfor (i = 0; i < CS42L43_N_SUPPLIES; i++)\n\t\tcs42l43->core_supplies[i].supply = cs42l43_core_supplies[i];\n\n\tret = devm_regulator_bulk_get(cs42l43->dev, CS42L43_N_SUPPLIES,\n\t\t\t\t      cs42l43->core_supplies);\n\tif (ret)\n\t\treturn dev_err_probe(cs42l43->dev, ret,\n\t\t\t\t     \"Failed to get core supplies\\n\");\n\n\tret = cs42l43_power_up(cs42l43);\n\tif (ret)\n\t\treturn ret;\n\n\tpm_runtime_set_autosuspend_delay(cs42l43->dev, CS42L43_AUTOSUSPEND_TIME);\n\tpm_runtime_use_autosuspend(cs42l43->dev);\n\tpm_runtime_set_active(cs42l43->dev);\n\t \n\tpm_runtime_get_noresume(cs42l43->dev);\n\tdevm_pm_runtime_enable(cs42l43->dev);\n\n\tqueue_work(system_long_wq, &cs42l43->boot_work);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_NS_GPL(cs42l43_dev_probe, MFD_CS42L43);\n\nvoid cs42l43_dev_remove(struct cs42l43 *cs42l43)\n{\n\tcs42l43_power_down(cs42l43);\n}\nEXPORT_SYMBOL_NS_GPL(cs42l43_dev_remove, MFD_CS42L43);\n\nstatic int cs42l43_suspend(struct device *dev)\n{\n\tstruct cs42l43 *cs42l43 = dev_get_drvdata(dev);\n\tint ret;\n\n\t \n\tpm_runtime_get_noresume(dev);\n\n\tret = pm_runtime_force_suspend(dev);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to force suspend: %d\\n\", ret);\n\t\tpm_runtime_put_noidle(dev);\n\t\treturn ret;\n\t}\n\n\tpm_runtime_put_noidle(dev);\n\n\tret = cs42l43_power_down(cs42l43);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int cs42l43_resume(struct device *dev)\n{\n\tstruct cs42l43 *cs42l43 = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = cs42l43_power_up(cs42l43);\n\tif (ret)\n\t\treturn ret;\n\n\tret = pm_runtime_force_resume(dev);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to force resume: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int cs42l43_runtime_suspend(struct device *dev)\n{\n\tstruct cs42l43 *cs42l43 = dev_get_drvdata(dev);\n\n\t \n\tregcache_cache_only(cs42l43->regmap, true);\n\n\treturn 0;\n}\n\nstatic int cs42l43_runtime_resume(struct device *dev)\n{\n\tstruct cs42l43 *cs42l43 = dev_get_drvdata(dev);\n\tunsigned int reset_canary;\n\tint ret;\n\n\tret = cs42l43_wait_for_attach(cs42l43);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_read(cs42l43->regmap, CS42L43_RELID, &reset_canary);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to check reset canary: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tif (!reset_canary) {\n\t\t \n\t\tret = cs42l43_mcu_update(cs42l43);\n\t\tif (ret)\n\t\t\tgoto err;\n\n\t\tregcache_mark_dirty(cs42l43->regmap);\n\t}\n\n\tret = regcache_sync(cs42l43->regmap);\n\tif (ret) {\n\t\tdev_err(cs42l43->dev, \"Failed to restore register cache: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\treturn 0;\n\nerr:\n\tregcache_cache_only(cs42l43->regmap, true);\n\n\treturn ret;\n}\n\nEXPORT_NS_GPL_DEV_PM_OPS(cs42l43_pm_ops, MFD_CS42L43) = {\n\tSYSTEM_SLEEP_PM_OPS(cs42l43_suspend, cs42l43_resume)\n\tRUNTIME_PM_OPS(cs42l43_runtime_suspend, cs42l43_runtime_resume, NULL)\n};\n\nMODULE_DESCRIPTION(\"CS42L43 Core Driver\");\nMODULE_AUTHOR(\"Charles Keepax <ckeepax@opensource.cirrus.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_FIRMWARE(\"cs42l43.bin\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}