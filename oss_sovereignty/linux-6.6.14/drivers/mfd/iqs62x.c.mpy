{
  "module_name": "iqs62x.c",
  "hash_id": "78b109d6ad61af2717642765e6d181401f51725b9cc75296b2c914e1de19b71c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/iqs62x.c",
  "human_readable_source": "\n \n\n#include <linux/completion.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/firmware.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/list.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/iqs62x.h>\n#include <linux/module.h>\n#include <linux/notifier.h>\n#include <linux/of.h>\n#include <linux/property.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <asm/unaligned.h>\n\n#define IQS62X_PROD_NUM\t\t\t\t0x00\n\n#define IQS62X_SYS_FLAGS\t\t\t0x10\n\n#define IQS620_HALL_FLAGS\t\t\t0x16\n#define IQS621_HALL_FLAGS\t\t\t0x19\n#define IQS622_HALL_FLAGS\t\t\tIQS621_HALL_FLAGS\n\n#define IQS624_INTERVAL_NUM\t\t\t0x18\n#define IQS625_INTERVAL_NUM\t\t\t0x12\n\n#define IQS622_PROX_SETTINGS_4\t\t\t0x48\n#define IQS620_PROX_SETTINGS_4\t\t\t0x50\n#define IQS620_PROX_SETTINGS_4_SAR_EN\t\tBIT(7)\n\n#define IQS621_ALS_CAL_DIV_LUX\t\t\t0x82\n#define IQS621_ALS_CAL_DIV_IR\t\t\t0x83\n\n#define IQS620_TEMP_CAL_MULT\t\t\t0xC2\n#define IQS620_TEMP_CAL_DIV\t\t\t0xC3\n#define IQS620_TEMP_CAL_OFFS\t\t\t0xC4\n\n#define IQS62X_SYS_SETTINGS\t\t\t0xD0\n#define IQS62X_SYS_SETTINGS_ACK_RESET\t\tBIT(6)\n#define IQS62X_SYS_SETTINGS_EVENT_MODE\t\tBIT(5)\n#define IQS62X_SYS_SETTINGS_CLK_DIV\t\tBIT(4)\n#define IQS62X_SYS_SETTINGS_COMM_ATI\t\tBIT(3)\n#define IQS62X_SYS_SETTINGS_REDO_ATI\t\tBIT(1)\n\n#define IQS62X_PWR_SETTINGS\t\t\t0xD2\n#define IQS62X_PWR_SETTINGS_DIS_AUTO\t\tBIT(5)\n#define IQS62X_PWR_SETTINGS_PWR_MODE_MASK\t(BIT(4) | BIT(3))\n#define IQS62X_PWR_SETTINGS_PWR_MODE_HALT\t(BIT(4) | BIT(3))\n#define IQS62X_PWR_SETTINGS_PWR_MODE_NORM\t0\n\n#define IQS62X_OTP_CMD\t\t\t\t0xF0\n#define IQS62X_OTP_CMD_FG3\t\t\t0x13\n#define IQS62X_OTP_DATA\t\t\t\t0xF1\n#define IQS62X_MAX_REG\t\t\t\t0xFF\n\n#define IQS62X_HALL_CAL_MASK\t\t\tGENMASK(3, 0)\n\n#define IQS62X_FW_REC_TYPE_INFO\t\t\t0\n#define IQS62X_FW_REC_TYPE_PROD\t\t\t1\n#define IQS62X_FW_REC_TYPE_HALL\t\t\t2\n#define IQS62X_FW_REC_TYPE_MASK\t\t\t3\n#define IQS62X_FW_REC_TYPE_DATA\t\t\t4\n\n#define IQS62X_ATI_STARTUP_MS\t\t\t350\n#define IQS62X_FILT_SETTLE_MS\t\t\t250\n\nstruct iqs62x_fw_rec {\n\tu8 type;\n\tu8 addr;\n\tu8 len;\n\tu8 data;\n} __packed;\n\nstruct iqs62x_fw_blk {\n\tstruct list_head list;\n\tu8 addr;\n\tu8 mask;\n\tu8 len;\n\tu8 data[];\n};\n\nstruct iqs62x_info {\n\tu8 prod_num;\n\tu8 sw_num;\n\tu8 hw_num;\n} __packed;\n\nstatic int iqs62x_dev_init(struct iqs62x_core *iqs62x)\n{\n\tstruct iqs62x_fw_blk *fw_blk;\n\tunsigned int val;\n\tint ret;\n\n\tlist_for_each_entry(fw_blk, &iqs62x->fw_blk_head, list) {\n\t\t \n\t\tif (fw_blk->addr == IQS62X_SYS_SETTINGS &&\n\t\t    *fw_blk->data & IQS62X_SYS_SETTINGS_CLK_DIV)\n\t\t\tmsleep(IQS62X_ATI_STARTUP_MS);\n\n\t\tif (fw_blk->mask)\n\t\t\tret = regmap_update_bits(iqs62x->regmap, fw_blk->addr,\n\t\t\t\t\t\t fw_blk->mask, *fw_blk->data);\n\t\telse\n\t\t\tret = regmap_raw_write(iqs62x->regmap, fw_blk->addr,\n\t\t\t\t\t       fw_blk->data, fw_blk->len);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tswitch (iqs62x->dev_desc->prod_num) {\n\tcase IQS620_PROD_NUM:\n\tcase IQS622_PROD_NUM:\n\t\tret = regmap_read(iqs62x->regmap,\n\t\t\t\t  iqs62x->dev_desc->prox_settings, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (val & IQS620_PROX_SETTINGS_4_SAR_EN)\n\t\t\tiqs62x->ui_sel = IQS62X_UI_SAR1;\n\t\tfallthrough;\n\n\tcase IQS621_PROD_NUM:\n\t\tret = regmap_write(iqs62x->regmap, IQS620_GLBL_EVENT_MASK,\n\t\t\t\t   IQS620_GLBL_EVENT_MASK_PMU |\n\t\t\t\t   iqs62x->dev_desc->prox_mask |\n\t\t\t\t   iqs62x->dev_desc->sar_mask |\n\t\t\t\t   iqs62x->dev_desc->hall_mask |\n\t\t\t\t   iqs62x->dev_desc->hyst_mask |\n\t\t\t\t   iqs62x->dev_desc->temp_mask |\n\t\t\t\t   iqs62x->dev_desc->als_mask |\n\t\t\t\t   iqs62x->dev_desc->ir_mask);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tdefault:\n\t\tret = regmap_write(iqs62x->regmap, IQS624_HALL_UI,\n\t\t\t\t   IQS624_HALL_UI_WHL_EVENT |\n\t\t\t\t   IQS624_HALL_UI_INT_EVENT |\n\t\t\t\t   IQS624_HALL_UI_AUTO_CAL);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tret = regmap_read(iqs62x->regmap, IQS624_INTERVAL_DIV, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (val >= iqs62x->dev_desc->interval_div)\n\t\t\tbreak;\n\n\t\tret = regmap_write(iqs62x->regmap, IQS624_INTERVAL_DIV,\n\t\t\t\t   iqs62x->dev_desc->interval_div);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_update_bits(iqs62x->regmap, IQS62X_SYS_SETTINGS,\n\t\t\t\t IQS62X_SYS_SETTINGS_ACK_RESET |\n\t\t\t\t IQS62X_SYS_SETTINGS_EVENT_MODE |\n\t\t\t\t IQS62X_SYS_SETTINGS_COMM_ATI |\n\t\t\t\t IQS62X_SYS_SETTINGS_REDO_ATI,\n\t\t\t\t IQS62X_SYS_SETTINGS_ACK_RESET |\n\t\t\t\t IQS62X_SYS_SETTINGS_REDO_ATI);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tusleep_range(5000, 5100);\n\n\treturn 0;\n}\n\nstatic int iqs62x_firmware_parse(struct iqs62x_core *iqs62x,\n\t\t\t\t const struct firmware *fw)\n{\n\tstruct i2c_client *client = iqs62x->client;\n\tstruct iqs62x_fw_rec *fw_rec;\n\tstruct iqs62x_fw_blk *fw_blk;\n\tunsigned int val;\n\tsize_t pos = 0;\n\tint ret = 0;\n\tu8 mask, len, *data;\n\tu8 hall_cal_index = 0;\n\n\twhile (pos < fw->size) {\n\t\tif (pos + sizeof(*fw_rec) > fw->size) {\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t\tfw_rec = (struct iqs62x_fw_rec *)(fw->data + pos);\n\t\tpos += sizeof(*fw_rec);\n\n\t\tif (pos + fw_rec->len - 1 > fw->size) {\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t\tpos += fw_rec->len - 1;\n\n\t\tswitch (fw_rec->type) {\n\t\tcase IQS62X_FW_REC_TYPE_INFO:\n\t\t\tcontinue;\n\n\t\tcase IQS62X_FW_REC_TYPE_PROD:\n\t\t\tif (fw_rec->data == iqs62x->dev_desc->prod_num)\n\t\t\t\tcontinue;\n\n\t\t\tdev_err(&client->dev,\n\t\t\t\t\"Incompatible product number: 0x%02X\\n\",\n\t\t\t\tfw_rec->data);\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\n\t\tcase IQS62X_FW_REC_TYPE_HALL:\n\t\t\tif (!hall_cal_index) {\n\t\t\t\tret = regmap_write(iqs62x->regmap,\n\t\t\t\t\t\t   IQS62X_OTP_CMD,\n\t\t\t\t\t\t   IQS62X_OTP_CMD_FG3);\n\t\t\t\tif (ret)\n\t\t\t\t\tbreak;\n\n\t\t\t\tret = regmap_read(iqs62x->regmap,\n\t\t\t\t\t\t  IQS62X_OTP_DATA, &val);\n\t\t\t\tif (ret)\n\t\t\t\t\tbreak;\n\n\t\t\t\thall_cal_index = val & IQS62X_HALL_CAL_MASK;\n\t\t\t\tif (!hall_cal_index) {\n\t\t\t\t\tdev_err(&client->dev,\n\t\t\t\t\t\t\"Uncalibrated device\\n\");\n\t\t\t\t\tret = -ENODATA;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (hall_cal_index > fw_rec->len) {\n\t\t\t\tret = -EINVAL;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tmask = 0;\n\t\t\tdata = &fw_rec->data + hall_cal_index - 1;\n\t\t\tlen = sizeof(*data);\n\t\t\tbreak;\n\n\t\tcase IQS62X_FW_REC_TYPE_MASK:\n\t\t\tif (fw_rec->len < (sizeof(mask) + sizeof(*data))) {\n\t\t\t\tret = -EINVAL;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tmask = fw_rec->data;\n\t\t\tdata = &fw_rec->data + sizeof(mask);\n\t\t\tlen = sizeof(*data);\n\t\t\tbreak;\n\n\t\tcase IQS62X_FW_REC_TYPE_DATA:\n\t\t\tmask = 0;\n\t\t\tdata = &fw_rec->data;\n\t\t\tlen = fw_rec->len;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tdev_err(&client->dev,\n\t\t\t\t\"Unrecognized record type: 0x%02X\\n\",\n\t\t\t\tfw_rec->type);\n\t\t\tret = -EINVAL;\n\t\t}\n\n\t\tif (ret)\n\t\t\tbreak;\n\n\t\tfw_blk = devm_kzalloc(&client->dev,\n\t\t\t\t      struct_size(fw_blk, data, len),\n\t\t\t\t      GFP_KERNEL);\n\t\tif (!fw_blk) {\n\t\t\tret = -ENOMEM;\n\t\t\tbreak;\n\t\t}\n\n\t\tfw_blk->addr = fw_rec->addr;\n\t\tfw_blk->mask = mask;\n\t\tfw_blk->len = len;\n\t\tmemcpy(fw_blk->data, data, len);\n\n\t\tlist_add(&fw_blk->list, &iqs62x->fw_blk_head);\n\t}\n\n\trelease_firmware(fw);\n\n\treturn ret;\n}\n\nconst struct iqs62x_event_desc iqs62x_events[IQS62X_NUM_EVENTS] = {\n\t[IQS62X_EVENT_PROX_CH0_T] = {\n\t\t.reg\t= IQS62X_EVENT_PROX,\n\t\t.mask\t= BIT(4),\n\t\t.val\t= BIT(4),\n\t},\n\t[IQS62X_EVENT_PROX_CH0_P] = {\n\t\t.reg\t= IQS62X_EVENT_PROX,\n\t\t.mask\t= BIT(0),\n\t\t.val\t= BIT(0),\n\t},\n\t[IQS62X_EVENT_PROX_CH1_T] = {\n\t\t.reg\t= IQS62X_EVENT_PROX,\n\t\t.mask\t= BIT(5),\n\t\t.val\t= BIT(5),\n\t},\n\t[IQS62X_EVENT_PROX_CH1_P] = {\n\t\t.reg\t= IQS62X_EVENT_PROX,\n\t\t.mask\t= BIT(1),\n\t\t.val\t= BIT(1),\n\t},\n\t[IQS62X_EVENT_PROX_CH2_T] = {\n\t\t.reg\t= IQS62X_EVENT_PROX,\n\t\t.mask\t= BIT(6),\n\t\t.val\t= BIT(6),\n\t},\n\t[IQS62X_EVENT_PROX_CH2_P] = {\n\t\t.reg\t= IQS62X_EVENT_PROX,\n\t\t.mask\t= BIT(2),\n\t\t.val\t= BIT(2),\n\t},\n\t[IQS62X_EVENT_HYST_POS_T] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(6) | BIT(7),\n\t\t.val\t= BIT(6),\n\t},\n\t[IQS62X_EVENT_HYST_POS_P] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(5) | BIT(7),\n\t\t.val\t= BIT(5),\n\t},\n\t[IQS62X_EVENT_HYST_NEG_T] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(6) | BIT(7),\n\t\t.val\t= BIT(6) | BIT(7),\n\t},\n\t[IQS62X_EVENT_HYST_NEG_P] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(5) | BIT(7),\n\t\t.val\t= BIT(5) | BIT(7),\n\t},\n\t[IQS62X_EVENT_SAR1_ACT] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(4),\n\t\t.val\t= BIT(4),\n\t},\n\t[IQS62X_EVENT_SAR1_QRD] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(2),\n\t\t.val\t= BIT(2),\n\t},\n\t[IQS62X_EVENT_SAR1_MOVE] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(1),\n\t\t.val\t= BIT(1),\n\t},\n\t[IQS62X_EVENT_SAR1_HALT] = {\n\t\t.reg\t= IQS62X_EVENT_HYST,\n\t\t.mask\t= BIT(0),\n\t\t.val\t= BIT(0),\n\t},\n\t[IQS62X_EVENT_WHEEL_UP] = {\n\t\t.reg\t= IQS62X_EVENT_WHEEL,\n\t\t.mask\t= BIT(7) | BIT(6),\n\t\t.val\t= BIT(7),\n\t},\n\t[IQS62X_EVENT_WHEEL_DN] = {\n\t\t.reg\t= IQS62X_EVENT_WHEEL,\n\t\t.mask\t= BIT(7) | BIT(6),\n\t\t.val\t= BIT(7) | BIT(6),\n\t},\n\t[IQS62X_EVENT_HALL_N_T] = {\n\t\t.reg\t= IQS62X_EVENT_HALL,\n\t\t.mask\t= BIT(2) | BIT(0),\n\t\t.val\t= BIT(2),\n\t},\n\t[IQS62X_EVENT_HALL_N_P] = {\n\t\t.reg\t= IQS62X_EVENT_HALL,\n\t\t.mask\t= BIT(1) | BIT(0),\n\t\t.val\t= BIT(1),\n\t},\n\t[IQS62X_EVENT_HALL_S_T] = {\n\t\t.reg\t= IQS62X_EVENT_HALL,\n\t\t.mask\t= BIT(2) | BIT(0),\n\t\t.val\t= BIT(2) | BIT(0),\n\t},\n\t[IQS62X_EVENT_HALL_S_P] = {\n\t\t.reg\t= IQS62X_EVENT_HALL,\n\t\t.mask\t= BIT(1) | BIT(0),\n\t\t.val\t= BIT(1) | BIT(0),\n\t},\n\t[IQS62X_EVENT_SYS_RESET] = {\n\t\t.reg\t= IQS62X_EVENT_SYS,\n\t\t.mask\t= BIT(7),\n\t\t.val\t= BIT(7),\n\t},\n\t[IQS62X_EVENT_SYS_ATI] = {\n\t\t.reg\t= IQS62X_EVENT_SYS,\n\t\t.mask\t= BIT(2),\n\t\t.val\t= BIT(2),\n\t},\n};\nEXPORT_SYMBOL_GPL(iqs62x_events);\n\nstatic irqreturn_t iqs62x_irq(int irq, void *context)\n{\n\tstruct iqs62x_core *iqs62x = context;\n\tstruct i2c_client *client = iqs62x->client;\n\tstruct iqs62x_event_data event_data;\n\tstruct iqs62x_event_desc event_desc;\n\tenum iqs62x_event_reg event_reg;\n\tunsigned long event_flags = 0;\n\tint ret, i, j;\n\tu8 event_map[IQS62X_EVENT_SIZE];\n\n\t \n\tret = regmap_raw_read(iqs62x->regmap, IQS62X_SYS_FLAGS, event_map,\n\t\t\t      sizeof(event_map));\n\tif (ret) {\n\t\tdev_err(&client->dev, \"Failed to read device status: %d\\n\",\n\t\t\tret);\n\t\treturn IRQ_NONE;\n\t}\n\n\tfor (i = 0; i < sizeof(event_map); i++) {\n\t\tevent_reg = iqs62x->dev_desc->event_regs[iqs62x->ui_sel][i];\n\n\t\tswitch (event_reg) {\n\t\tcase IQS62X_EVENT_UI_LO:\n\t\t\tevent_data.ui_data = get_unaligned_le16(&event_map[i]);\n\t\t\tfallthrough;\n\n\t\tcase IQS62X_EVENT_UI_HI:\n\t\tcase IQS62X_EVENT_NONE:\n\t\t\tcontinue;\n\n\t\tcase IQS62X_EVENT_ALS:\n\t\t\tevent_data.als_flags = event_map[i];\n\t\t\tcontinue;\n\n\t\tcase IQS62X_EVENT_IR:\n\t\t\tevent_data.ir_flags = event_map[i];\n\t\t\tcontinue;\n\n\t\tcase IQS62X_EVENT_INTER:\n\t\t\tevent_data.interval = event_map[i];\n\t\t\tcontinue;\n\n\t\tcase IQS62X_EVENT_HYST:\n\t\t\tevent_map[i] <<= iqs62x->dev_desc->hyst_shift;\n\t\t\tfallthrough;\n\n\t\tcase IQS62X_EVENT_WHEEL:\n\t\tcase IQS62X_EVENT_HALL:\n\t\tcase IQS62X_EVENT_PROX:\n\t\tcase IQS62X_EVENT_SYS:\n\t\t\tbreak;\n\t\t}\n\n\t\tfor (j = 0; j < IQS62X_NUM_EVENTS; j++) {\n\t\t\tevent_desc = iqs62x_events[j];\n\n\t\t\tif (event_desc.reg != event_reg)\n\t\t\t\tcontinue;\n\n\t\t\tif ((event_map[i] & event_desc.mask) == event_desc.val)\n\t\t\t\tevent_flags |= BIT(j);\n\t\t}\n\t}\n\n\t \n\tif (event_flags & BIT(IQS62X_EVENT_SYS_RESET)) {\n\t\tdev_err(&client->dev, \"Unexpected device reset\\n\");\n\n\t\tret = iqs62x_dev_init(iqs62x);\n\t\tif (ret) {\n\t\t\tdev_err(&client->dev,\n\t\t\t\t\"Failed to re-initialize device: %d\\n\", ret);\n\t\t\treturn IRQ_NONE;\n\t\t}\n\n\t\tiqs62x->event_cache |= BIT(IQS62X_EVENT_SYS_RESET);\n\t\treinit_completion(&iqs62x->ati_done);\n\t} else if (event_flags & BIT(IQS62X_EVENT_SYS_ATI)) {\n\t\tiqs62x->event_cache |= BIT(IQS62X_EVENT_SYS_ATI);\n\t\treinit_completion(&iqs62x->ati_done);\n\t} else if (!completion_done(&iqs62x->ati_done)) {\n\t\tret = regmap_update_bits(iqs62x->regmap, IQS62X_SYS_SETTINGS,\n\t\t\t\t\t IQS62X_SYS_SETTINGS_EVENT_MODE, 0xFF);\n\t\tif (ret) {\n\t\t\tdev_err(&client->dev,\n\t\t\t\t\"Failed to enable event mode: %d\\n\", ret);\n\t\t\treturn IRQ_NONE;\n\t\t}\n\n\t\tmsleep(IQS62X_FILT_SETTLE_MS);\n\t\tcomplete_all(&iqs62x->ati_done);\n\t}\n\n\t \n\tif (completion_done(&iqs62x->ati_done)) {\n\t\tevent_flags |= iqs62x->event_cache;\n\t\tret = blocking_notifier_call_chain(&iqs62x->nh, event_flags,\n\t\t\t\t\t\t   &event_data);\n\t\tif (ret & NOTIFY_STOP_MASK)\n\t\t\treturn IRQ_NONE;\n\n\t\tiqs62x->event_cache = 0;\n\t}\n\n\t \n\tusleep_range(150, 200);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void iqs62x_firmware_load(const struct firmware *fw, void *context)\n{\n\tstruct iqs62x_core *iqs62x = context;\n\tstruct i2c_client *client = iqs62x->client;\n\tint ret;\n\n\tif (fw) {\n\t\tret = iqs62x_firmware_parse(iqs62x, fw);\n\t\tif (ret) {\n\t\t\tdev_err(&client->dev, \"Failed to parse firmware: %d\\n\",\n\t\t\t\tret);\n\t\t\tgoto err_out;\n\t\t}\n\t}\n\n\tret = iqs62x_dev_init(iqs62x);\n\tif (ret) {\n\t\tdev_err(&client->dev, \"Failed to initialize device: %d\\n\", ret);\n\t\tgoto err_out;\n\t}\n\n\tret = devm_request_threaded_irq(&client->dev, client->irq,\n\t\t\t\t\tNULL, iqs62x_irq, IRQF_ONESHOT,\n\t\t\t\t\tclient->name, iqs62x);\n\tif (ret) {\n\t\tdev_err(&client->dev, \"Failed to request IRQ: %d\\n\", ret);\n\t\tgoto err_out;\n\t}\n\n\tif (!wait_for_completion_timeout(&iqs62x->ati_done,\n\t\t\t\t\t msecs_to_jiffies(2000))) {\n\t\tdev_err(&client->dev, \"Failed to complete ATI\\n\");\n\t\tgoto err_out;\n\t}\n\n\tret = devm_mfd_add_devices(&client->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t   iqs62x->dev_desc->sub_devs,\n\t\t\t\t   iqs62x->dev_desc->num_sub_devs,\n\t\t\t\t   NULL, 0, NULL);\n\tif (ret)\n\t\tdev_err(&client->dev, \"Failed to add sub-devices: %d\\n\", ret);\n\nerr_out:\n\tcomplete_all(&iqs62x->fw_done);\n}\n\nstatic const struct mfd_cell iqs620at_sub_devs[] = {\n\t{\n\t\t.name = \"iqs62x-keys\",\n\t\t.of_compatible = \"azoteq,iqs620a-keys\",\n\t},\n\t{\n\t\t.name = \"iqs620a-pwm\",\n\t\t.of_compatible = \"azoteq,iqs620a-pwm\",\n\t},\n\t{ .name = \"iqs620at-temp\", },\n};\n\nstatic const struct mfd_cell iqs620a_sub_devs[] = {\n\t{\n\t\t.name = \"iqs62x-keys\",\n\t\t.of_compatible = \"azoteq,iqs620a-keys\",\n\t},\n\t{\n\t\t.name = \"iqs620a-pwm\",\n\t\t.of_compatible = \"azoteq,iqs620a-pwm\",\n\t},\n};\n\nstatic const struct mfd_cell iqs621_sub_devs[] = {\n\t{\n\t\t.name = \"iqs62x-keys\",\n\t\t.of_compatible = \"azoteq,iqs621-keys\",\n\t},\n\t{ .name = \"iqs621-als\", },\n};\n\nstatic const struct mfd_cell iqs622_sub_devs[] = {\n\t{\n\t\t.name = \"iqs62x-keys\",\n\t\t.of_compatible = \"azoteq,iqs622-keys\",\n\t},\n\t{ .name = \"iqs621-als\", },\n};\n\nstatic const struct mfd_cell iqs624_sub_devs[] = {\n\t{\n\t\t.name = \"iqs62x-keys\",\n\t\t.of_compatible = \"azoteq,iqs624-keys\",\n\t},\n\t{ .name = \"iqs624-pos\", },\n};\n\nstatic const struct mfd_cell iqs625_sub_devs[] = {\n\t{\n\t\t.name = \"iqs62x-keys\",\n\t\t.of_compatible = \"azoteq,iqs625-keys\",\n\t},\n\t{ .name = \"iqs624-pos\", },\n};\n\nstatic const u8 iqs620at_cal_regs[] = {\n\tIQS620_TEMP_CAL_MULT,\n\tIQS620_TEMP_CAL_DIV,\n\tIQS620_TEMP_CAL_OFFS,\n};\n\nstatic const u8 iqs621_cal_regs[] = {\n\tIQS621_ALS_CAL_DIV_LUX,\n\tIQS621_ALS_CAL_DIV_IR,\n};\n\nstatic const enum iqs62x_event_reg iqs620a_event_regs[][IQS62X_EVENT_SIZE] = {\n\t[IQS62X_UI_PROX] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_PROX,\t \n\t\tIQS62X_EVENT_HYST,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_HALL,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t},\n\t[IQS62X_UI_SAR1] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_HYST,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_HALL,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t},\n};\n\nstatic const enum iqs62x_event_reg iqs621_event_regs[][IQS62X_EVENT_SIZE] = {\n\t[IQS62X_UI_PROX] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_PROX,\t \n\t\tIQS62X_EVENT_HYST,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_ALS,\t \n\t\tIQS62X_EVENT_UI_LO,\t \n\t\tIQS62X_EVENT_UI_HI,\t \n\t\tIQS62X_EVENT_HALL,\t \n\t},\n};\n\nstatic const enum iqs62x_event_reg iqs622_event_regs[][IQS62X_EVENT_SIZE] = {\n\t[IQS62X_UI_PROX] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_PROX,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_ALS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_IR,\t \n\t\tIQS62X_EVENT_UI_LO,\t \n\t\tIQS62X_EVENT_UI_HI,\t \n\t\tIQS62X_EVENT_HALL,\t \n\t},\n\t[IQS62X_UI_SAR1] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_HYST,\t \n\t\tIQS62X_EVENT_ALS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_IR,\t \n\t\tIQS62X_EVENT_UI_LO,\t \n\t\tIQS62X_EVENT_UI_HI,\t \n\t\tIQS62X_EVENT_HALL,\t \n\t},\n};\n\nstatic const enum iqs62x_event_reg iqs624_event_regs[][IQS62X_EVENT_SIZE] = {\n\t[IQS62X_UI_PROX] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_PROX,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_WHEEL,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_UI_LO,\t \n\t\tIQS62X_EVENT_UI_HI,\t \n\t\tIQS62X_EVENT_INTER,\t \n\t\tIQS62X_EVENT_NONE,\n\t},\n};\n\nstatic const enum iqs62x_event_reg iqs625_event_regs[][IQS62X_EVENT_SIZE] = {\n\t[IQS62X_UI_PROX] = {\n\t\tIQS62X_EVENT_SYS,\t \n\t\tIQS62X_EVENT_PROX,\t \n\t\tIQS62X_EVENT_INTER,\t \n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t\tIQS62X_EVENT_NONE,\n\t},\n};\n\nstatic const struct iqs62x_dev_desc iqs62x_devs[] = {\n\t{\n\t\t.dev_name\t= \"iqs620at\",\n\t\t.sub_devs\t= iqs620at_sub_devs,\n\t\t.num_sub_devs\t= ARRAY_SIZE(iqs620at_sub_devs),\n\t\t.prod_num\t= IQS620_PROD_NUM,\n\t\t.sw_num\t\t= 0x08,\n\t\t.cal_regs\t= iqs620at_cal_regs,\n\t\t.num_cal_regs\t= ARRAY_SIZE(iqs620at_cal_regs),\n\t\t.prox_mask\t= BIT(0),\n\t\t.sar_mask\t= BIT(1) | BIT(7),\n\t\t.hall_mask\t= BIT(2),\n\t\t.hyst_mask\t= BIT(3),\n\t\t.temp_mask\t= BIT(4),\n\t\t.prox_settings\t= IQS620_PROX_SETTINGS_4,\n\t\t.hall_flags\t= IQS620_HALL_FLAGS,\n\t\t.fw_name\t= \"iqs620a.bin\",\n\t\t.event_regs\t= &iqs620a_event_regs[IQS62X_UI_PROX],\n\t},\n\t{\n\t\t.dev_name\t= \"iqs620a\",\n\t\t.sub_devs\t= iqs620a_sub_devs,\n\t\t.num_sub_devs\t= ARRAY_SIZE(iqs620a_sub_devs),\n\t\t.prod_num\t= IQS620_PROD_NUM,\n\t\t.sw_num\t\t= 0x08,\n\t\t.prox_mask\t= BIT(0),\n\t\t.sar_mask\t= BIT(1) | BIT(7),\n\t\t.hall_mask\t= BIT(2),\n\t\t.hyst_mask\t= BIT(3),\n\t\t.temp_mask\t= BIT(4),\n\t\t.prox_settings\t= IQS620_PROX_SETTINGS_4,\n\t\t.hall_flags\t= IQS620_HALL_FLAGS,\n\t\t.fw_name\t= \"iqs620a.bin\",\n\t\t.event_regs\t= &iqs620a_event_regs[IQS62X_UI_PROX],\n\t},\n\t{\n\t\t.dev_name\t= \"iqs621\",\n\t\t.sub_devs\t= iqs621_sub_devs,\n\t\t.num_sub_devs\t= ARRAY_SIZE(iqs621_sub_devs),\n\t\t.prod_num\t= IQS621_PROD_NUM,\n\t\t.sw_num\t\t= 0x09,\n\t\t.cal_regs\t= iqs621_cal_regs,\n\t\t.num_cal_regs\t= ARRAY_SIZE(iqs621_cal_regs),\n\t\t.prox_mask\t= BIT(0),\n\t\t.hall_mask\t= BIT(1),\n\t\t.als_mask\t= BIT(2),\n\t\t.hyst_mask\t= BIT(3),\n\t\t.temp_mask\t= BIT(4),\n\t\t.als_flags\t= IQS621_ALS_FLAGS,\n\t\t.hall_flags\t= IQS621_HALL_FLAGS,\n\t\t.hyst_shift\t= 5,\n\t\t.fw_name\t= \"iqs621.bin\",\n\t\t.event_regs\t= &iqs621_event_regs[IQS62X_UI_PROX],\n\t},\n\t{\n\t\t.dev_name\t= \"iqs622\",\n\t\t.sub_devs\t= iqs622_sub_devs,\n\t\t.num_sub_devs\t= ARRAY_SIZE(iqs622_sub_devs),\n\t\t.prod_num\t= IQS622_PROD_NUM,\n\t\t.sw_num\t\t= 0x06,\n\t\t.prox_mask\t= BIT(0),\n\t\t.sar_mask\t= BIT(1),\n\t\t.hall_mask\t= BIT(2),\n\t\t.als_mask\t= BIT(3),\n\t\t.ir_mask\t= BIT(4),\n\t\t.prox_settings\t= IQS622_PROX_SETTINGS_4,\n\t\t.als_flags\t= IQS622_ALS_FLAGS,\n\t\t.hall_flags\t= IQS622_HALL_FLAGS,\n\t\t.fw_name\t= \"iqs622.bin\",\n\t\t.event_regs\t= &iqs622_event_regs[IQS62X_UI_PROX],\n\t},\n\t{\n\t\t.dev_name\t= \"iqs624\",\n\t\t.sub_devs\t= iqs624_sub_devs,\n\t\t.num_sub_devs\t= ARRAY_SIZE(iqs624_sub_devs),\n\t\t.prod_num\t= IQS624_PROD_NUM,\n\t\t.sw_num\t\t= 0x0B,\n\t\t.interval\t= IQS624_INTERVAL_NUM,\n\t\t.interval_div\t= 3,\n\t\t.fw_name\t= \"iqs624.bin\",\n\t\t.event_regs\t= &iqs624_event_regs[IQS62X_UI_PROX],\n\t},\n\t{\n\t\t.dev_name\t= \"iqs625\",\n\t\t.sub_devs\t= iqs625_sub_devs,\n\t\t.num_sub_devs\t= ARRAY_SIZE(iqs625_sub_devs),\n\t\t.prod_num\t= IQS625_PROD_NUM,\n\t\t.sw_num\t\t= 0x0B,\n\t\t.interval\t= IQS625_INTERVAL_NUM,\n\t\t.interval_div\t= 10,\n\t\t.fw_name\t= \"iqs625.bin\",\n\t\t.event_regs\t= &iqs625_event_regs[IQS62X_UI_PROX],\n\t},\n};\n\nstatic const struct regmap_config iqs62x_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = IQS62X_MAX_REG,\n};\n\nstatic int iqs62x_probe(struct i2c_client *client)\n{\n\tstruct iqs62x_core *iqs62x;\n\tstruct iqs62x_info info;\n\tunsigned int val;\n\tint ret, i, j;\n\tconst char *fw_name = NULL;\n\n\tiqs62x = devm_kzalloc(&client->dev, sizeof(*iqs62x), GFP_KERNEL);\n\tif (!iqs62x)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(client, iqs62x);\n\tiqs62x->client = client;\n\n\tBLOCKING_INIT_NOTIFIER_HEAD(&iqs62x->nh);\n\tINIT_LIST_HEAD(&iqs62x->fw_blk_head);\n\n\tinit_completion(&iqs62x->ati_done);\n\tinit_completion(&iqs62x->fw_done);\n\n\tiqs62x->regmap = devm_regmap_init_i2c(client, &iqs62x_regmap_config);\n\tif (IS_ERR(iqs62x->regmap)) {\n\t\tret = PTR_ERR(iqs62x->regmap);\n\t\tdev_err(&client->dev, \"Failed to initialize register map: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tret = regmap_raw_read(iqs62x->regmap, IQS62X_PROD_NUM, &info,\n\t\t\t      sizeof(info));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(iqs62x_devs); i++) {\n\t\tif (info.prod_num != iqs62x_devs[i].prod_num)\n\t\t\tcontinue;\n\n\t\tiqs62x->dev_desc = &iqs62x_devs[i];\n\n\t\tif (info.sw_num < iqs62x->dev_desc->sw_num)\n\t\t\tcontinue;\n\n\t\tiqs62x->sw_num = info.sw_num;\n\t\tiqs62x->hw_num = info.hw_num;\n\n\t\t \n\t\tfor (j = 0; j < iqs62x->dev_desc->num_cal_regs; j++) {\n\t\t\tret = regmap_read(iqs62x->regmap,\n\t\t\t\t\t  iqs62x->dev_desc->cal_regs[j], &val);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tif (!val)\n\t\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (j == iqs62x->dev_desc->num_cal_regs)\n\t\t\tbreak;\n\t}\n\n\tif (!iqs62x->dev_desc) {\n\t\tdev_err(&client->dev, \"Unrecognized product number: 0x%02X\\n\",\n\t\t\tinfo.prod_num);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!iqs62x->sw_num) {\n\t\tdev_err(&client->dev, \"Unrecognized software number: 0x%02X\\n\",\n\t\t\tinfo.sw_num);\n\t\treturn -EINVAL;\n\t}\n\n\tif (i == ARRAY_SIZE(iqs62x_devs)) {\n\t\tdev_err(&client->dev, \"Uncalibrated device\\n\");\n\t\treturn -ENODATA;\n\t}\n\n\tdevice_property_read_string(&client->dev, \"firmware-name\", &fw_name);\n\n\tret = request_firmware_nowait(THIS_MODULE, FW_ACTION_UEVENT,\n\t\t\t\t      fw_name ? : iqs62x->dev_desc->fw_name,\n\t\t\t\t      &client->dev, GFP_KERNEL, iqs62x,\n\t\t\t\t      iqs62x_firmware_load);\n\tif (ret)\n\t\tdev_err(&client->dev, \"Failed to request firmware: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic void iqs62x_remove(struct i2c_client *client)\n{\n\tstruct iqs62x_core *iqs62x = i2c_get_clientdata(client);\n\n\twait_for_completion(&iqs62x->fw_done);\n}\n\nstatic int __maybe_unused iqs62x_suspend(struct device *dev)\n{\n\tstruct iqs62x_core *iqs62x = dev_get_drvdata(dev);\n\tint ret;\n\n\twait_for_completion(&iqs62x->fw_done);\n\n\t \n\tret = regmap_update_bits(iqs62x->regmap, IQS62X_PWR_SETTINGS,\n\t\t\t\t IQS62X_PWR_SETTINGS_DIS_AUTO, 0xFF);\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_update_bits(iqs62x->regmap, IQS62X_PWR_SETTINGS,\n\t\t\t\t  IQS62X_PWR_SETTINGS_PWR_MODE_MASK,\n\t\t\t\t  IQS62X_PWR_SETTINGS_PWR_MODE_HALT);\n}\n\nstatic int __maybe_unused iqs62x_resume(struct device *dev)\n{\n\tstruct iqs62x_core *iqs62x = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = regmap_update_bits(iqs62x->regmap, IQS62X_PWR_SETTINGS,\n\t\t\t\t IQS62X_PWR_SETTINGS_PWR_MODE_MASK,\n\t\t\t\t IQS62X_PWR_SETTINGS_PWR_MODE_NORM);\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_update_bits(iqs62x->regmap, IQS62X_PWR_SETTINGS,\n\t\t\t\t  IQS62X_PWR_SETTINGS_DIS_AUTO, 0);\n}\n\nstatic SIMPLE_DEV_PM_OPS(iqs62x_pm, iqs62x_suspend, iqs62x_resume);\n\nstatic const struct of_device_id iqs62x_of_match[] = {\n\t{ .compatible = \"azoteq,iqs620a\" },\n\t{ .compatible = \"azoteq,iqs621\" },\n\t{ .compatible = \"azoteq,iqs622\" },\n\t{ .compatible = \"azoteq,iqs624\" },\n\t{ .compatible = \"azoteq,iqs625\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, iqs62x_of_match);\n\nstatic struct i2c_driver iqs62x_i2c_driver = {\n\t.driver = {\n\t\t.name = \"iqs62x\",\n\t\t.of_match_table = iqs62x_of_match,\n\t\t.pm = &iqs62x_pm,\n\t},\n\t.probe = iqs62x_probe,\n\t.remove = iqs62x_remove,\n};\nmodule_i2c_driver(iqs62x_i2c_driver);\n\nMODULE_AUTHOR(\"Jeff LaBundy <jeff@labundy.com>\");\nMODULE_DESCRIPTION(\"Azoteq IQS620A/621/622/624/625 Multi-Function Sensors\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}