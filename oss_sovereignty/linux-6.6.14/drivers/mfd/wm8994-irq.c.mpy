{
  "module_name": "wm8994-irq.c",
  "hash_id": "d6062f002f26fb172e6c36bd97fca9d9ff006a26f5ee420007d0cc5acb8d830d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/wm8994-irq.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/gpio.h>\n#include <linux/i2c.h>\n#include <linux/irq.h>\n#include <linux/mfd/core.h>\n#include <linux/interrupt.h>\n#include <linux/irqdomain.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/wm8994/core.h>\n#include <linux/mfd/wm8994/pdata.h>\n#include <linux/mfd/wm8994/registers.h>\n\n#include <linux/delay.h>\n\nstatic const struct regmap_irq wm8994_irqs[] = {\n\t[WM8994_IRQ_TEMP_SHUT] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_TEMP_SHUT_EINT,\n\t},\n\t[WM8994_IRQ_MIC1_DET] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_MIC1_DET_EINT,\n\t},\n\t[WM8994_IRQ_MIC1_SHRT] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_MIC1_SHRT_EINT,\n\t},\n\t[WM8994_IRQ_MIC2_DET] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_MIC2_DET_EINT,\n\t},\n\t[WM8994_IRQ_MIC2_SHRT] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_MIC2_SHRT_EINT,\n\t},\n\t[WM8994_IRQ_FLL1_LOCK] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_FLL1_LOCK_EINT,\n\t},\n\t[WM8994_IRQ_FLL2_LOCK] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_FLL2_LOCK_EINT,\n\t},\n\t[WM8994_IRQ_SRC1_LOCK] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_SRC1_LOCK_EINT,\n\t},\n\t[WM8994_IRQ_SRC2_LOCK] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_SRC2_LOCK_EINT,\n\t},\n\t[WM8994_IRQ_AIF1DRC1_SIG_DET] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_AIF1DRC1_SIG_DET,\n\t},\n\t[WM8994_IRQ_AIF1DRC2_SIG_DET] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_AIF1DRC2_SIG_DET_EINT,\n\t},\n\t[WM8994_IRQ_AIF2DRC_SIG_DET] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_AIF2DRC_SIG_DET_EINT,\n\t},\n\t[WM8994_IRQ_FIFOS_ERR] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_FIFOS_ERR_EINT,\n\t},\n\t[WM8994_IRQ_WSEQ_DONE] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_WSEQ_DONE_EINT,\n\t},\n\t[WM8994_IRQ_DCS_DONE] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_DCS_DONE_EINT,\n\t},\n\t[WM8994_IRQ_TEMP_WARN] = {\n\t\t.reg_offset = 1,\n\t\t.mask = WM8994_TEMP_WARN_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(1)] = {\n\t\t.mask = WM8994_GP1_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(2)] = {\n\t\t.mask = WM8994_GP2_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(3)] = {\n\t\t.mask = WM8994_GP3_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(4)] = {\n\t\t.mask = WM8994_GP4_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(5)] = {\n\t\t.mask = WM8994_GP5_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(6)] = {\n\t\t.mask = WM8994_GP6_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(7)] = {\n\t\t.mask = WM8994_GP7_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(8)] = {\n\t\t.mask = WM8994_GP8_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(9)] = {\n\t\t.mask = WM8994_GP8_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(10)] = {\n\t\t.mask = WM8994_GP10_EINT,\n\t},\n\t[WM8994_IRQ_GPIO(11)] = {\n\t\t.mask = WM8994_GP11_EINT,\n\t},\n};\n\nstatic const struct regmap_irq_chip wm8994_irq_chip = {\n\t.name = \"wm8994\",\n\t.irqs = wm8994_irqs,\n\t.num_irqs = ARRAY_SIZE(wm8994_irqs),\n\n\t.num_regs = 2,\n\t.status_base = WM8994_INTERRUPT_STATUS_1,\n\t.mask_base = WM8994_INTERRUPT_STATUS_1_MASK,\n\t.ack_base = WM8994_INTERRUPT_STATUS_1,\n\t.runtime_pm = true,\n};\n\nstatic void wm8994_edge_irq_enable(struct irq_data *data)\n{\n}\n\nstatic void wm8994_edge_irq_disable(struct irq_data *data)\n{\n}\n\nstatic struct irq_chip wm8994_edge_irq_chip = {\n\t.name\t\t\t= \"wm8994_edge\",\n\t.irq_disable\t\t= wm8994_edge_irq_disable,\n\t.irq_enable\t\t= wm8994_edge_irq_enable,\n};\n\nstatic irqreturn_t wm8994_edge_irq(int irq, void *data)\n{\n\tstruct wm8994 *wm8994 = data;\n\n\twhile (gpio_get_value_cansleep(wm8994->pdata.irq_gpio))\n\t\thandle_nested_irq(irq_find_mapping(wm8994->edge_irq, 0));\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int wm8994_edge_irq_map(struct irq_domain *h, unsigned int virq,\n\t\t\t       irq_hw_number_t hw)\n{\n\tstruct wm8994 *wm8994 = h->host_data;\n\n\tirq_set_chip_data(virq, wm8994);\n\tirq_set_chip_and_handler(virq, &wm8994_edge_irq_chip, handle_edge_irq);\n\tirq_set_nested_thread(virq, 1);\n\tirq_set_noprobe(virq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops wm8994_edge_irq_ops = {\n\t.map\t= wm8994_edge_irq_map,\n\t.xlate\t= irq_domain_xlate_twocell,\n};\n\nint wm8994_irq_init(struct wm8994 *wm8994)\n{\n\tint ret;\n\tunsigned long irqflags;\n\tstruct wm8994_pdata *pdata = &wm8994->pdata;\n\n\tif (!wm8994->irq) {\n\t\tdev_warn(wm8994->dev,\n\t\t\t \"No interrupt specified, no interrupts\\n\");\n\t\twm8994->irq_base = 0;\n\t\treturn 0;\n\t}\n\n\t \n\tirqflags = IRQF_TRIGGER_HIGH | IRQF_ONESHOT;\n\tif (pdata->irq_flags)\n\t\tirqflags = pdata->irq_flags;\n\n\t \n\tif (irqflags & (IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING)) {\n\t\tif (gpio_to_irq(pdata->irq_gpio) != wm8994->irq) {\n\t\t\tdev_warn(wm8994->dev, \"IRQ %d is not GPIO %d (%d)\\n\",\n\t\t\t\t wm8994->irq, pdata->irq_gpio,\n\t\t\t\t gpio_to_irq(pdata->irq_gpio));\n\t\t\twm8994->irq = gpio_to_irq(pdata->irq_gpio);\n\t\t}\n\n\t\tret = devm_gpio_request_one(wm8994->dev, pdata->irq_gpio,\n\t\t\t\t\t    GPIOF_IN, \"WM8994 IRQ\");\n\n\t\tif (ret != 0) {\n\t\t\tdev_err(wm8994->dev, \"Failed to get IRQ GPIO: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\twm8994->edge_irq = irq_domain_add_linear(NULL, 1,\n\t\t\t\t\t\t\t &wm8994_edge_irq_ops,\n\t\t\t\t\t\t\t wm8994);\n\n\t\tret = regmap_add_irq_chip(wm8994->regmap,\n\t\t\t\t\t  irq_create_mapping(wm8994->edge_irq,\n\t\t\t\t\t\t\t     0),\n\t\t\t\t\t  IRQF_ONESHOT,\n\t\t\t\t\t  wm8994->irq_base, &wm8994_irq_chip,\n\t\t\t\t\t  &wm8994->irq_data);\n\t\tif (ret != 0) {\n\t\t\tdev_err(wm8994->dev, \"Failed to get IRQ: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = request_threaded_irq(wm8994->irq,\n\t\t\t\t\t   NULL, wm8994_edge_irq,\n\t\t\t\t\t   irqflags,\n\t\t\t\t\t   \"WM8994 edge\", wm8994);\n\t} else {\n\t\tret = regmap_add_irq_chip(wm8994->regmap, wm8994->irq,\n\t\t\t\t\t  irqflags,\n\t\t\t\t\t  wm8994->irq_base, &wm8994_irq_chip,\n\t\t\t\t\t  &wm8994->irq_data);\n\t}\n\n\tif (ret != 0) {\n\t\tdev_err(wm8994->dev, \"Failed to register IRQ chip: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\twm8994_reg_write(wm8994, WM8994_INTERRUPT_CONTROL, 0);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(wm8994_irq_init);\n\nvoid wm8994_irq_exit(struct wm8994 *wm8994)\n{\n\tregmap_del_irq_chip(wm8994->irq, wm8994->irq_data);\n}\nEXPORT_SYMBOL(wm8994_irq_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}