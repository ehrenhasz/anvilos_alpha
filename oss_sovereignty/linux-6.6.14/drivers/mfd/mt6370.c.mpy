{
  "module_name": "mt6370.c",
  "hash_id": "48ddbad777cb7a10d1946544eb5dd56bba7cbbb75b0a4ee5a5297ac07868066d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/mt6370.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/bitfield.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/core.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n\n#include \"mt6370.h\"\n\n#define MT6370_REG_DEV_INFO\t0x100\n#define MT6370_REG_CHG_IRQ1\t0x1C0\n#define MT6370_REG_CHG_MASK1\t0x1E0\n#define MT6370_REG_MAXADDR\t0x1FF\n\n#define MT6370_VENID_MASK\tGENMASK(7, 4)\n\n#define MT6370_NUM_IRQREGS\t16\n#define MT6370_USBC_I2CADDR\t0x4E\n#define MT6370_MAX_ADDRLEN\t2\n\n#define MT6370_VENID_RT5081\t0x8\n#define MT6370_VENID_RT5081A\t0xA\n#define MT6370_VENID_MT6370\t0xE\n#define MT6370_VENID_MT6371\t0xF\n#define MT6370_VENID_MT6372P\t0x9\n#define MT6370_VENID_MT6372CP\t0xB\n\nstatic const struct regmap_irq mt6370_irqs[] = {\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DIRCHGON, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_TREG, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_AICR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_MIVR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_PWR_RDY, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FL_CHG_VINOVP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_VSYSUV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_VSYSOV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_VBATOV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_VINOVPCHG, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_TS_BAT_COLD, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_TS_BAT_COOL, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_TS_BAT_WARM, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_TS_BAT_HOT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_TS_STATC, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_FAULT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_STATC, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_TMR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_BATABS, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_ADPBAD, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_RVP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_TSHUTDOWN, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_IINMEAS, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_ICCMEAS, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHGDET_DONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_WDTMR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_SSFINISH, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_RECHG, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_TERM, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHG_IEOC, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_ADC_DONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_PUMPX_DONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_BST_BATUV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_BST_MIDOV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_BST_OLP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_ATTACH, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DETACH, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_HVDCP_STPDONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_HVDCP_VBUSDET_DONE, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_HVDCP_DET, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_CHGDET, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DCDT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DIRCHG_VGOK, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DIRCHG_WDTMR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DIRCHG_UC, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DIRCHG_OC, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DIRCHG_OV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_OVPCTRL_SWON, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_OVPCTRL_UVP_D, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_OVPCTRL_UVP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_OVPCTRL_OVP_D, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_OVPCTRL_OVP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED_STRBPIN, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED_TORPIN, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED_TX, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED_LVF, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED2_SHORT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED1_SHORT, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED2_STRB, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED1_STRB, 8),\n\tREGMAP_IRQ_REG_LINE(mT6370_IRQ_FLED2_STRB_TO, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED1_STRB_TO, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED2_TOR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_FLED1_TOR, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_OTP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_VDDA_OVP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_VDDA_UV, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_LDO_OC, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_BLED_OCP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_BLED_OVP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DSV_VNEG_OCP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DSV_VPOS_OCP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DSV_BST_OCP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DSV_VNEG_SCP, 8),\n\tREGMAP_IRQ_REG_LINE(MT6370_IRQ_DSV_VPOS_SCP, 8),\n};\n\nstatic const struct regmap_irq_chip mt6370_irq_chip = {\n\t.name\t\t= \"mt6370-irqs\",\n\t.status_base\t= MT6370_REG_CHG_IRQ1,\n\t.mask_base\t= MT6370_REG_CHG_MASK1,\n\t.num_regs\t= MT6370_NUM_IRQREGS,\n\t.irqs\t\t= mt6370_irqs,\n\t.num_irqs\t= ARRAY_SIZE(mt6370_irqs),\n};\n\nstatic const struct resource mt6370_regulator_irqs[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6370_IRQ_DSV_VPOS_SCP, \"db_vpos_scp\"),\n\tDEFINE_RES_IRQ_NAMED(MT6370_IRQ_DSV_VNEG_SCP, \"db_vneg_scp\"),\n\tDEFINE_RES_IRQ_NAMED(MT6370_IRQ_DSV_BST_OCP, \"db_vbst_ocp\"),\n\tDEFINE_RES_IRQ_NAMED(MT6370_IRQ_DSV_VPOS_OCP, \"db_vpos_ocp\"),\n\tDEFINE_RES_IRQ_NAMED(MT6370_IRQ_DSV_VNEG_OCP, \"db_vneg_ocp\"),\n\tDEFINE_RES_IRQ_NAMED(MT6370_IRQ_LDO_OC, \"ldo_oc\"),\n};\n\nstatic const struct mfd_cell mt6370_devices[] = {\n\tMFD_CELL_OF(\"mt6370-adc\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6370-adc\"),\n\tMFD_CELL_OF(\"mt6370-charger\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6370-charger\"),\n\tMFD_CELL_OF(\"mt6370-flashlight\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6370-flashlight\"),\n\tMFD_CELL_OF(\"mt6370-indicator\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6370-indicator\"),\n\tMFD_CELL_OF(\"mt6370-tcpc\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6370-tcpc\"),\n\tMFD_CELL_RES(\"mt6370-regulator\", mt6370_regulator_irqs),\n};\n\nstatic const struct mfd_cell mt6370_exclusive_devices[] = {\n\tMFD_CELL_OF(\"mt6370-backlight\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6370-backlight\"),\n};\n\nstatic const struct mfd_cell mt6372_exclusive_devices[] = {\n\tMFD_CELL_OF(\"mt6370-backlight\",\n\t\t    NULL, NULL, 0, 0, \"mediatek,mt6372-backlight\"),\n};\n\nstatic int mt6370_check_vendor_info(struct device *dev, struct regmap *rmap,\n\t\t\t\t    int *vid)\n{\n\tunsigned int devinfo;\n\tint ret;\n\n\tret = regmap_read(rmap, MT6370_REG_DEV_INFO, &devinfo);\n\tif (ret)\n\t\treturn ret;\n\n\t*vid = FIELD_GET(MT6370_VENID_MASK, devinfo);\n\tswitch (*vid) {\n\tcase MT6370_VENID_RT5081:\n\tcase MT6370_VENID_RT5081A:\n\tcase MT6370_VENID_MT6370:\n\tcase MT6370_VENID_MT6371:\n\tcase MT6370_VENID_MT6372P:\n\tcase MT6370_VENID_MT6372CP:\n\t\treturn 0;\n\tdefault:\n\t\tdev_err(dev, \"Unknown Vendor ID 0x%02x\\n\", devinfo);\n\t\treturn -ENODEV;\n\t}\n}\n\nstatic int mt6370_regmap_read(void *context, const void *reg_buf,\n\t\t\t      size_t reg_size, void *val_buf, size_t val_size)\n{\n\tstruct mt6370_info *info = context;\n\tconst u8 *u8_buf = reg_buf;\n\tu8 bank_idx, bank_addr;\n\tint ret;\n\n\tbank_idx = u8_buf[0];\n\tbank_addr = u8_buf[1];\n\n\tret = i2c_smbus_read_i2c_block_data(info->i2c[bank_idx], bank_addr,\n\t\t\t\t\t    val_size, val_buf);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (ret != val_size)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\nstatic int mt6370_regmap_write(void *context, const void *data, size_t count)\n{\n\tstruct mt6370_info *info = context;\n\tconst u8 *u8_buf = data;\n\tu8 bank_idx, bank_addr;\n\tint len = count - MT6370_MAX_ADDRLEN;\n\n\tbank_idx = u8_buf[0];\n\tbank_addr = u8_buf[1];\n\n\treturn i2c_smbus_write_i2c_block_data(info->i2c[bank_idx], bank_addr,\n\t\t\t\t\t      len, data + MT6370_MAX_ADDRLEN);\n}\n\nstatic const struct regmap_bus mt6370_regmap_bus = {\n\t.read\t\t= mt6370_regmap_read,\n\t.write\t\t= mt6370_regmap_write,\n};\n\nstatic const struct regmap_config mt6370_regmap_config = {\n\t.reg_bits\t\t= 16,\n\t.val_bits\t\t= 8,\n\t.reg_format_endian\t= REGMAP_ENDIAN_BIG,\n\t.max_register\t\t= MT6370_REG_MAXADDR,\n};\n\nstatic int mt6370_probe(struct i2c_client *i2c)\n{\n\tstruct mt6370_info *info;\n\tstruct i2c_client *usbc_i2c;\n\tstruct regmap *regmap;\n\tstruct device *dev = &i2c->dev;\n\tint ret, vid;\n\n\tinfo = devm_kzalloc(dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tusbc_i2c = devm_i2c_new_dummy_device(dev, i2c->adapter,\n\t\t\t\t\t     MT6370_USBC_I2CADDR);\n\tif (IS_ERR(usbc_i2c))\n\t\treturn dev_err_probe(dev, PTR_ERR(usbc_i2c),\n\t\t\t\t     \"Failed to register USBC I2C client\\n\");\n\n\t \n\tinfo->i2c[MT6370_PMU_I2C] = i2c;\n\tinfo->i2c[MT6370_USBC_I2C] = usbc_i2c;\n\n\tregmap = devm_regmap_init(dev, &mt6370_regmap_bus,\n\t\t\t\t  info, &mt6370_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn dev_err_probe(dev, PTR_ERR(regmap),\n\t\t\t\t     \"Failed to init regmap\\n\");\n\n\tret = mt6370_check_vendor_info(dev, regmap, &vid);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to check vendor info\\n\");\n\n\tret = devm_regmap_add_irq_chip(dev, regmap, i2c->irq,\n\t\t\t\t       IRQF_ONESHOT, -1, &mt6370_irq_chip,\n\t\t\t\t       &info->irq_data);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to add irq chip\\n\");\n\n\tswitch (vid) {\n\tcase MT6370_VENID_MT6372P:\n\tcase MT6370_VENID_MT6372CP:\n\t\tret = devm_mfd_add_devices(dev, PLATFORM_DEVID_AUTO,\n\t\t\t\t\t   mt6372_exclusive_devices,\n\t\t\t\t\t   ARRAY_SIZE(mt6372_exclusive_devices),\n\t\t\t\t\t   NULL, 0,\n\t\t\t\t\t   regmap_irq_get_domain(info->irq_data));\n\t\tbreak;\n\tdefault:\n\t\tret = devm_mfd_add_devices(dev, PLATFORM_DEVID_AUTO,\n\t\t\t\t\t   mt6370_exclusive_devices,\n\t\t\t\t\t   ARRAY_SIZE(mt6370_exclusive_devices),\n\t\t\t\t\t   NULL, 0,\n\t\t\t\t\t   regmap_irq_get_domain(info->irq_data));\n\t\tbreak;\n\t}\n\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to add the exclusive devices\\n\");\n\n\treturn devm_mfd_add_devices(dev, PLATFORM_DEVID_AUTO,\n\t\t\t\t    mt6370_devices, ARRAY_SIZE(mt6370_devices),\n\t\t\t\t    NULL, 0,\n\t\t\t\t    regmap_irq_get_domain(info->irq_data));\n}\n\nstatic const struct of_device_id mt6370_match_table[] = {\n\t{ .compatible = \"mediatek,mt6370\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mt6370_match_table);\n\nstatic struct i2c_driver mt6370_driver = {\n\t.driver = {\n\t\t.name = \"mt6370\",\n\t\t.of_match_table = mt6370_match_table,\n\t},\n\t.probe = mt6370_probe,\n};\nmodule_i2c_driver(mt6370_driver);\n\nMODULE_AUTHOR(\"ChiYuan Huang <cy_huang@richtek.com>\");\nMODULE_DESCRIPTION(\"MediaTek MT6370 SubPMIC Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}