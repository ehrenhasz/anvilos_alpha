{
  "module_name": "intel-m10-bmc-spi.c",
  "hash_id": "a6e083f7206b2c081c38c5b9dc3d1cb6dc48c285bcb5815765ea08ab060bb7f6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/intel-m10-bmc-spi.c",
  "human_readable_source": "\n \n#include <linux/bitfield.h>\n#include <linux/dev_printk.h>\n#include <linux/init.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/intel-m10-bmc.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <linux/spi/spi.h>\n\nstatic const struct regmap_range m10bmc_regmap_range[] = {\n\tregmap_reg_range(M10BMC_N3000_LEGACY_BUILD_VER, M10BMC_N3000_LEGACY_BUILD_VER),\n\tregmap_reg_range(M10BMC_N3000_SYS_BASE, M10BMC_N3000_SYS_END),\n\tregmap_reg_range(M10BMC_N3000_FLASH_BASE, M10BMC_N3000_FLASH_END),\n};\n\nstatic const struct regmap_access_table m10bmc_access_table = {\n\t.yes_ranges\t= m10bmc_regmap_range,\n\t.n_yes_ranges\t= ARRAY_SIZE(m10bmc_regmap_range),\n};\n\nstatic struct regmap_config intel_m10bmc_regmap_config = {\n\t.reg_bits = 32,\n\t.val_bits = 32,\n\t.reg_stride = 4,\n\t.wr_table = &m10bmc_access_table,\n\t.rd_table = &m10bmc_access_table,\n\t.max_register = M10BMC_N3000_MEM_END,\n};\n\nstatic int check_m10bmc_version(struct intel_m10bmc *ddata)\n{\n\tunsigned int v;\n\tint ret;\n\n\t \n\tret = m10bmc_raw_read(ddata, M10BMC_N3000_LEGACY_BUILD_VER, &v);\n\tif (ret)\n\t\treturn -ENODEV;\n\n\tif (v != M10BMC_N3000_VER_LEGACY_INVALID) {\n\t\tdev_err(ddata->dev, \"bad version M10BMC detected\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\treturn 0;\n}\n\nstatic int intel_m10_bmc_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\tconst struct intel_m10bmc_platform_info *info;\n\tstruct device *dev = &spi->dev;\n\tstruct intel_m10bmc *ddata;\n\tint ret;\n\n\tddata = devm_kzalloc(dev, sizeof(*ddata), GFP_KERNEL);\n\tif (!ddata)\n\t\treturn -ENOMEM;\n\n\tinfo = (struct intel_m10bmc_platform_info *)id->driver_data;\n\tddata->dev = dev;\n\n\tddata->regmap = devm_regmap_init_spi_avmm(spi, &intel_m10bmc_regmap_config);\n\tif (IS_ERR(ddata->regmap)) {\n\t\tret = PTR_ERR(ddata->regmap);\n\t\tdev_err(dev, \"Failed to allocate regmap: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tspi_set_drvdata(spi, ddata);\n\n\tret = check_m10bmc_version(ddata);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to identify m10bmc hardware\\n\");\n\t\treturn ret;\n\t}\n\n\treturn m10bmc_dev_init(ddata, info);\n}\n\nstatic const struct m10bmc_csr_map m10bmc_n3000_csr_map = {\n\t.base = M10BMC_N3000_SYS_BASE,\n\t.build_version = M10BMC_N3000_BUILD_VER,\n\t.fw_version = NIOS2_N3000_FW_VERSION,\n\t.mac_low = M10BMC_N3000_MAC_LOW,\n\t.mac_high = M10BMC_N3000_MAC_HIGH,\n\t.doorbell = M10BMC_N3000_DOORBELL,\n\t.auth_result = M10BMC_N3000_AUTH_RESULT,\n\t.bmc_prog_addr = M10BMC_N3000_BMC_PROG_ADDR,\n\t.bmc_reh_addr = M10BMC_N3000_BMC_REH_ADDR,\n\t.bmc_magic = M10BMC_N3000_BMC_PROG_MAGIC,\n\t.sr_prog_addr = M10BMC_N3000_SR_PROG_ADDR,\n\t.sr_reh_addr = M10BMC_N3000_SR_REH_ADDR,\n\t.sr_magic = M10BMC_N3000_SR_PROG_MAGIC,\n\t.pr_prog_addr = M10BMC_N3000_PR_PROG_ADDR,\n\t.pr_reh_addr = M10BMC_N3000_PR_REH_ADDR,\n\t.pr_magic = M10BMC_N3000_PR_PROG_MAGIC,\n\t.rsu_update_counter = M10BMC_N3000_STAGING_FLASH_COUNT,\n};\n\nstatic struct mfd_cell m10bmc_d5005_subdevs[] = {\n\t{ .name = \"d5005bmc-hwmon\" },\n\t{ .name = \"d5005bmc-sec-update\" },\n};\n\nstatic const struct regmap_range m10bmc_d5005_fw_handshake_regs[] = {\n\tregmap_reg_range(M10BMC_N3000_TELEM_START, M10BMC_D5005_TELEM_END),\n};\n\nstatic struct mfd_cell m10bmc_pacn3000_subdevs[] = {\n\t{ .name = \"n3000bmc-hwmon\" },\n\t{ .name = \"n3000bmc-retimer\" },\n\t{ .name = \"n3000bmc-sec-update\" },\n};\n\nstatic const struct regmap_range m10bmc_n3000_fw_handshake_regs[] = {\n\tregmap_reg_range(M10BMC_N3000_TELEM_START, M10BMC_N3000_TELEM_END),\n};\n\nstatic struct mfd_cell m10bmc_n5010_subdevs[] = {\n\t{ .name = \"n5010bmc-hwmon\" },\n};\n\nstatic const struct intel_m10bmc_platform_info m10bmc_spi_n3000 = {\n\t.cells = m10bmc_pacn3000_subdevs,\n\t.n_cells = ARRAY_SIZE(m10bmc_pacn3000_subdevs),\n\t.handshake_sys_reg_ranges = m10bmc_n3000_fw_handshake_regs,\n\t.handshake_sys_reg_nranges = ARRAY_SIZE(m10bmc_n3000_fw_handshake_regs),\n\t.csr_map = &m10bmc_n3000_csr_map,\n};\n\nstatic const struct intel_m10bmc_platform_info m10bmc_spi_d5005 = {\n\t.cells = m10bmc_d5005_subdevs,\n\t.n_cells = ARRAY_SIZE(m10bmc_d5005_subdevs),\n\t.handshake_sys_reg_ranges = m10bmc_d5005_fw_handshake_regs,\n\t.handshake_sys_reg_nranges = ARRAY_SIZE(m10bmc_d5005_fw_handshake_regs),\n\t.csr_map = &m10bmc_n3000_csr_map,\n};\n\nstatic const struct intel_m10bmc_platform_info m10bmc_spi_n5010 = {\n\t.cells = m10bmc_n5010_subdevs,\n\t.n_cells = ARRAY_SIZE(m10bmc_n5010_subdevs),\n\t.handshake_sys_reg_ranges = m10bmc_n3000_fw_handshake_regs,\n\t.handshake_sys_reg_nranges = ARRAY_SIZE(m10bmc_n3000_fw_handshake_regs),\n\t.csr_map = &m10bmc_n3000_csr_map,\n};\n\nstatic const struct spi_device_id m10bmc_spi_id[] = {\n\t{ \"m10-n3000\", (kernel_ulong_t)&m10bmc_spi_n3000 },\n\t{ \"m10-d5005\", (kernel_ulong_t)&m10bmc_spi_d5005 },\n\t{ \"m10-n5010\", (kernel_ulong_t)&m10bmc_spi_n5010 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, m10bmc_spi_id);\n\nstatic struct spi_driver intel_m10bmc_spi_driver = {\n\t.driver = {\n\t\t.name = \"intel-m10-bmc\",\n\t\t.dev_groups = m10bmc_dev_groups,\n\t},\n\t.probe = intel_m10_bmc_spi_probe,\n\t.id_table = m10bmc_spi_id,\n};\nmodule_spi_driver(intel_m10bmc_spi_driver);\n\nMODULE_DESCRIPTION(\"Intel MAX 10 BMC SPI bus interface\");\nMODULE_AUTHOR(\"Intel Corporation\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"spi:intel-m10-bmc\");\nMODULE_IMPORT_NS(INTEL_M10_BMC_CORE);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}