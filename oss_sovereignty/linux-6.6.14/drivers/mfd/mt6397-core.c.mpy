{
  "module_name": "mt6397-core.c",
  "hash_id": "7a83dfc648af6674f55ac935e84b20d8c5128c7f478ceee11211a09d86e02a46",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/mt6397-core.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/ioport.h>\n#include <linux/irqdomain.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/mt6323/core.h>\n#include <linux/mfd/mt6331/core.h>\n#include <linux/mfd/mt6357/core.h>\n#include <linux/mfd/mt6358/core.h>\n#include <linux/mfd/mt6359/core.h>\n#include <linux/mfd/mt6397/core.h>\n#include <linux/mfd/mt6323/registers.h>\n#include <linux/mfd/mt6331/registers.h>\n#include <linux/mfd/mt6357/registers.h>\n#include <linux/mfd/mt6358/registers.h>\n#include <linux/mfd/mt6359/registers.h>\n#include <linux/mfd/mt6397/registers.h>\n\n#define MT6323_RTC_BASE\t\t0x8000\n#define MT6323_RTC_SIZE\t\t0x40\n\n#define MT6357_RTC_BASE\t\t0x0588\n#define MT6357_RTC_SIZE\t\t0x3c\n\n#define MT6331_RTC_BASE\t\t0x4000\n#define MT6331_RTC_SIZE\t\t0x40\n\n#define MT6358_RTC_BASE\t\t0x0588\n#define MT6358_RTC_SIZE\t\t0x3c\n\n#define MT6397_RTC_BASE\t\t0xe000\n#define MT6397_RTC_SIZE\t\t0x3e\n\n#define MT6323_PWRC_BASE\t0x8000\n#define MT6323_PWRC_SIZE\t0x40\n\nstatic const struct resource mt6323_rtc_resources[] = {\n\tDEFINE_RES_MEM(MT6323_RTC_BASE, MT6323_RTC_SIZE),\n\tDEFINE_RES_IRQ(MT6323_IRQ_STATUS_RTC),\n};\n\nstatic const struct resource mt6357_rtc_resources[] = {\n\tDEFINE_RES_MEM(MT6357_RTC_BASE, MT6357_RTC_SIZE),\n\tDEFINE_RES_IRQ(MT6357_IRQ_RTC),\n};\n\nstatic const struct resource mt6331_rtc_resources[] = {\n\tDEFINE_RES_MEM(MT6331_RTC_BASE, MT6331_RTC_SIZE),\n\tDEFINE_RES_IRQ(MT6331_IRQ_STATUS_RTC),\n};\n\nstatic const struct resource mt6358_rtc_resources[] = {\n\tDEFINE_RES_MEM(MT6358_RTC_BASE, MT6358_RTC_SIZE),\n\tDEFINE_RES_IRQ(MT6358_IRQ_RTC),\n};\n\nstatic const struct resource mt6397_rtc_resources[] = {\n\tDEFINE_RES_MEM(MT6397_RTC_BASE, MT6397_RTC_SIZE),\n\tDEFINE_RES_IRQ(MT6397_IRQ_RTC),\n};\n\nstatic const struct resource mt6358_keys_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6358_IRQ_PWRKEY, \"powerkey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6358_IRQ_HOMEKEY, \"homekey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6358_IRQ_PWRKEY_R, \"powerkey_r\"),\n\tDEFINE_RES_IRQ_NAMED(MT6358_IRQ_HOMEKEY_R, \"homekey_r\"),\n};\n\nstatic const struct resource mt6359_keys_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6359_IRQ_PWRKEY, \"powerkey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6359_IRQ_HOMEKEY, \"homekey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6359_IRQ_PWRKEY_R, \"powerkey_r\"),\n\tDEFINE_RES_IRQ_NAMED(MT6359_IRQ_HOMEKEY_R, \"homekey_r\"),\n};\n\nstatic const struct resource mt6323_keys_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6323_IRQ_STATUS_PWRKEY, \"powerkey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6323_IRQ_STATUS_FCHRKEY, \"homekey\"),\n};\n\nstatic const struct resource mt6357_keys_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6357_IRQ_PWRKEY, \"powerkey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6357_IRQ_HOMEKEY, \"homekey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6357_IRQ_PWRKEY_R, \"powerkey_r\"),\n\tDEFINE_RES_IRQ_NAMED(MT6357_IRQ_HOMEKEY_R, \"homekey_r\"),\n};\n\nstatic const struct resource mt6331_keys_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6331_IRQ_STATUS_PWRKEY, \"powerkey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6331_IRQ_STATUS_HOMEKEY, \"homekey\"),\n};\n\nstatic const struct resource mt6397_keys_resources[] = {\n\tDEFINE_RES_IRQ_NAMED(MT6397_IRQ_PWRKEY, \"powerkey\"),\n\tDEFINE_RES_IRQ_NAMED(MT6397_IRQ_HOMEKEY, \"homekey\"),\n};\n\nstatic const struct resource mt6323_pwrc_resources[] = {\n\tDEFINE_RES_MEM(MT6323_PWRC_BASE, MT6323_PWRC_SIZE),\n};\n\nstatic const struct mfd_cell mt6323_devs[] = {\n\t{\n\t\t.name = \"mt6323-rtc\",\n\t\t.num_resources = ARRAY_SIZE(mt6323_rtc_resources),\n\t\t.resources = mt6323_rtc_resources,\n\t\t.of_compatible = \"mediatek,mt6323-rtc\",\n\t}, {\n\t\t.name = \"mt6323-regulator\",\n\t\t.of_compatible = \"mediatek,mt6323-regulator\"\n\t}, {\n\t\t.name = \"mt6323-led\",\n\t\t.of_compatible = \"mediatek,mt6323-led\"\n\t}, {\n\t\t.name = \"mtk-pmic-keys\",\n\t\t.num_resources = ARRAY_SIZE(mt6323_keys_resources),\n\t\t.resources = mt6323_keys_resources,\n\t\t.of_compatible = \"mediatek,mt6323-keys\"\n\t}, {\n\t\t.name = \"mt6323-pwrc\",\n\t\t.num_resources = ARRAY_SIZE(mt6323_pwrc_resources),\n\t\t.resources = mt6323_pwrc_resources,\n\t\t.of_compatible = \"mediatek,mt6323-pwrc\"\n\t},\n};\n\nstatic const struct mfd_cell mt6357_devs[] = {\n\t{\n\t\t.name = \"mt6357-regulator\",\n\t}, {\n\t\t.name = \"mt6357-rtc\",\n\t\t.num_resources = ARRAY_SIZE(mt6357_rtc_resources),\n\t\t.resources = mt6357_rtc_resources,\n\t\t.of_compatible = \"mediatek,mt6357-rtc\",\n\t}, {\n\t\t.name = \"mtk-pmic-keys\",\n\t\t.num_resources = ARRAY_SIZE(mt6357_keys_resources),\n\t\t.resources = mt6357_keys_resources,\n\t\t.of_compatible = \"mediatek,mt6357-keys\"\n\t},\n};\n\n \nstatic const struct mfd_cell mt6331_mt6332_devs[] = {\n\t{\n\t\t.name = \"mt6331-rtc\",\n\t\t.num_resources = ARRAY_SIZE(mt6331_rtc_resources),\n\t\t.resources = mt6331_rtc_resources,\n\t\t.of_compatible = \"mediatek,mt6331-rtc\",\n\t}, {\n\t\t.name = \"mt6331-regulator\",\n\t\t.of_compatible = \"mediatek,mt6331-regulator\"\n\t}, {\n\t\t.name = \"mt6332-regulator\",\n\t\t.of_compatible = \"mediatek,mt6332-regulator\"\n\t}, {\n\t\t.name = \"mtk-pmic-keys\",\n\t\t.num_resources = ARRAY_SIZE(mt6331_keys_resources),\n\t\t.resources = mt6331_keys_resources,\n\t\t.of_compatible = \"mediatek,mt6331-keys\"\n\t},\n};\n\nstatic const struct mfd_cell mt6358_devs[] = {\n\t{\n\t\t.name = \"mt6358-regulator\",\n\t\t.of_compatible = \"mediatek,mt6358-regulator\"\n\t}, {\n\t\t.name = \"mt6358-rtc\",\n\t\t.num_resources = ARRAY_SIZE(mt6358_rtc_resources),\n\t\t.resources = mt6358_rtc_resources,\n\t\t.of_compatible = \"mediatek,mt6358-rtc\",\n\t}, {\n\t\t.name = \"mt6358-sound\",\n\t\t.of_compatible = \"mediatek,mt6358-sound\"\n\t}, {\n\t\t.name = \"mt6358-keys\",\n\t\t.num_resources = ARRAY_SIZE(mt6358_keys_resources),\n\t\t.resources = mt6358_keys_resources,\n\t\t.of_compatible = \"mediatek,mt6358-keys\"\n\t},\n};\n\nstatic const struct mfd_cell mt6359_devs[] = {\n\t{ .name = \"mt6359-regulator\", },\n\t{\n\t\t.name = \"mt6359-rtc\",\n\t\t.num_resources = ARRAY_SIZE(mt6358_rtc_resources),\n\t\t.resources = mt6358_rtc_resources,\n\t\t.of_compatible = \"mediatek,mt6358-rtc\",\n\t},\n\t{ .name = \"mt6359-sound\", },\n\t{\n\t\t.name = \"mtk-pmic-keys\",\n\t\t.num_resources = ARRAY_SIZE(mt6359_keys_resources),\n\t\t.resources = mt6359_keys_resources,\n\t\t.of_compatible = \"mediatek,mt6359-keys\"\n\t},\n};\n\nstatic const struct mfd_cell mt6397_devs[] = {\n\t{\n\t\t.name = \"mt6397-rtc\",\n\t\t.num_resources = ARRAY_SIZE(mt6397_rtc_resources),\n\t\t.resources = mt6397_rtc_resources,\n\t\t.of_compatible = \"mediatek,mt6397-rtc\",\n\t}, {\n\t\t.name = \"mt6397-regulator\",\n\t\t.of_compatible = \"mediatek,mt6397-regulator\",\n\t}, {\n\t\t.name = \"mt6397-codec\",\n\t\t.of_compatible = \"mediatek,mt6397-codec\",\n\t}, {\n\t\t.name = \"mt6397-clk\",\n\t\t.of_compatible = \"mediatek,mt6397-clk\",\n\t}, {\n\t\t.name = \"mt6397-pinctrl\",\n\t\t.of_compatible = \"mediatek,mt6397-pinctrl\",\n\t}, {\n\t\t.name = \"mtk-pmic-keys\",\n\t\t.num_resources = ARRAY_SIZE(mt6397_keys_resources),\n\t\t.resources = mt6397_keys_resources,\n\t\t.of_compatible = \"mediatek,mt6397-keys\"\n\t}\n};\n\nstruct chip_data {\n\tu32 cid_addr;\n\tu32 cid_shift;\n\tconst struct mfd_cell *cells;\n\tint cell_size;\n\tint (*irq_init)(struct mt6397_chip *chip);\n};\n\nstatic const struct chip_data mt6323_core = {\n\t.cid_addr = MT6323_CID,\n\t.cid_shift = 0,\n\t.cells = mt6323_devs,\n\t.cell_size = ARRAY_SIZE(mt6323_devs),\n\t.irq_init = mt6397_irq_init,\n};\n\nstatic const struct chip_data mt6357_core = {\n\t.cid_addr = MT6357_SWCID,\n\t.cid_shift = 8,\n\t.cells = mt6357_devs,\n\t.cell_size = ARRAY_SIZE(mt6357_devs),\n\t.irq_init = mt6358_irq_init,\n};\n\nstatic const struct chip_data mt6331_mt6332_core = {\n\t.cid_addr = MT6331_HWCID,\n\t.cid_shift = 0,\n\t.cells = mt6331_mt6332_devs,\n\t.cell_size = ARRAY_SIZE(mt6331_mt6332_devs),\n\t.irq_init = mt6397_irq_init,\n};\n\nstatic const struct chip_data mt6358_core = {\n\t.cid_addr = MT6358_SWCID,\n\t.cid_shift = 8,\n\t.cells = mt6358_devs,\n\t.cell_size = ARRAY_SIZE(mt6358_devs),\n\t.irq_init = mt6358_irq_init,\n};\n\nstatic const struct chip_data mt6359_core = {\n\t.cid_addr = MT6359_SWCID,\n\t.cid_shift = 8,\n\t.cells = mt6359_devs,\n\t.cell_size = ARRAY_SIZE(mt6359_devs),\n\t.irq_init = mt6358_irq_init,\n};\n\nstatic const struct chip_data mt6397_core = {\n\t.cid_addr = MT6397_CID,\n\t.cid_shift = 0,\n\t.cells = mt6397_devs,\n\t.cell_size = ARRAY_SIZE(mt6397_devs),\n\t.irq_init = mt6397_irq_init,\n};\n\nstatic int mt6397_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tunsigned int id = 0;\n\tstruct mt6397_chip *pmic;\n\tconst struct chip_data *pmic_core;\n\n\tpmic = devm_kzalloc(&pdev->dev, sizeof(*pmic), GFP_KERNEL);\n\tif (!pmic)\n\t\treturn -ENOMEM;\n\n\tpmic->dev = &pdev->dev;\n\n\t \n\tpmic->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!pmic->regmap)\n\t\treturn -ENODEV;\n\n\tpmic_core = of_device_get_match_data(&pdev->dev);\n\tif (!pmic_core)\n\t\treturn -ENODEV;\n\n\tret = regmap_read(pmic->regmap, pmic_core->cid_addr, &id);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to read chip id: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpmic->chip_id = (id >> pmic_core->cid_shift) & 0xff;\n\n\tplatform_set_drvdata(pdev, pmic);\n\n\tpmic->irq = platform_get_irq(pdev, 0);\n\tif (pmic->irq <= 0)\n\t\treturn pmic->irq;\n\n\tret = pmic_core->irq_init(pmic);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\n\t\t\t\t   pmic_core->cells, pmic_core->cell_size,\n\t\t\t\t   NULL, 0, pmic->irq_domain);\n\tif (ret) {\n\t\tirq_domain_remove(pmic->irq_domain);\n\t\tdev_err(&pdev->dev, \"failed to add child devices: %d\\n\", ret);\n\t}\n\n\treturn ret;\n}\n\nstatic const struct of_device_id mt6397_of_match[] = {\n\t{\n\t\t.compatible = \"mediatek,mt6323\",\n\t\t.data = &mt6323_core,\n\t}, {\n\t\t.compatible = \"mediatek,mt6331\",\n\t\t.data = &mt6331_mt6332_core,\n\t}, {\n\t\t.compatible = \"mediatek,mt6357\",\n\t\t.data = &mt6357_core,\n\t}, {\n\t\t.compatible = \"mediatek,mt6358\",\n\t\t.data = &mt6358_core,\n\t}, {\n\t\t.compatible = \"mediatek,mt6359\",\n\t\t.data = &mt6359_core,\n\t}, {\n\t\t.compatible = \"mediatek,mt6397\",\n\t\t.data = &mt6397_core,\n\t}, {\n\t\t \n\t}\n};\nMODULE_DEVICE_TABLE(of, mt6397_of_match);\n\nstatic const struct platform_device_id mt6397_id[] = {\n\t{ \"mt6397\", 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, mt6397_id);\n\nstatic struct platform_driver mt6397_driver = {\n\t.probe = mt6397_probe,\n\t.driver = {\n\t\t.name = \"mt6397\",\n\t\t.of_match_table = mt6397_of_match,\n\t},\n\t.id_table = mt6397_id,\n};\n\nmodule_platform_driver(mt6397_driver);\n\nMODULE_AUTHOR(\"Flora Fu, MediaTek\");\nMODULE_DESCRIPTION(\"Driver for MediaTek MT6397 PMIC\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}