{
  "module_name": "max8997-irq.c",
  "hash_id": "abc334535a79a176ca35b1eb0b87b54684cc7caeb4bdabddd09e898c7cf0deab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mfd/max8997-irq.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n#include <linux/err.h>\n#include <linux/irq.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/max8997.h>\n#include <linux/mfd/max8997-private.h>\n\nstatic const u8 max8997_mask_reg[] = {\n\t[PMIC_INT1] = MAX8997_REG_INT1MSK,\n\t[PMIC_INT2] = MAX8997_REG_INT2MSK,\n\t[PMIC_INT3] = MAX8997_REG_INT3MSK,\n\t[PMIC_INT4] = MAX8997_REG_INT4MSK,\n\t[FUEL_GAUGE] = MAX8997_REG_INVALID,\n\t[MUIC_INT1] = MAX8997_MUIC_REG_INTMASK1,\n\t[MUIC_INT2] = MAX8997_MUIC_REG_INTMASK2,\n\t[MUIC_INT3] = MAX8997_MUIC_REG_INTMASK3,\n\t[GPIO_LOW] = MAX8997_REG_INVALID,\n\t[GPIO_HI] = MAX8997_REG_INVALID,\n\t[FLASH_STATUS] = MAX8997_REG_INVALID,\n};\n\nstatic struct i2c_client *get_i2c(struct max8997_dev *max8997,\n\t\t\t\tenum max8997_irq_source src)\n{\n\tswitch (src) {\n\tcase PMIC_INT1 ... PMIC_INT4:\n\t\treturn max8997->i2c;\n\tcase FUEL_GAUGE:\n\t\treturn NULL;\n\tcase MUIC_INT1 ... MUIC_INT3:\n\t\treturn max8997->muic;\n\tcase GPIO_LOW ... GPIO_HI:\n\t\treturn max8997->i2c;\n\tcase FLASH_STATUS:\n\t\treturn max8997->i2c;\n\tdefault:\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n}\n\nstruct max8997_irq_data {\n\tint mask;\n\tenum max8997_irq_source group;\n};\n\n#define DECLARE_IRQ(idx, _group, _mask)\t\t\\\n\t[(idx)] = { .group = (_group), .mask = (_mask) }\nstatic const struct max8997_irq_data max8997_irqs[] = {\n\tDECLARE_IRQ(MAX8997_PMICIRQ_PWRONR,\tPMIC_INT1, 1 << 0),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_PWRONF,\tPMIC_INT1, 1 << 1),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_PWRON1SEC,\tPMIC_INT1, 1 << 3),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_JIGONR,\tPMIC_INT1, 1 << 4),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_JIGONF,\tPMIC_INT1, 1 << 5),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_LOWBAT2,\tPMIC_INT1, 1 << 6),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_LOWBAT1,\tPMIC_INT1, 1 << 7),\n\n\tDECLARE_IRQ(MAX8997_PMICIRQ_JIGR,\tPMIC_INT2, 1 << 0),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_JIGF,\tPMIC_INT2, 1 << 1),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_MR,\t\tPMIC_INT2, 1 << 2),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_DVS1OK,\tPMIC_INT2, 1 << 3),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_DVS2OK,\tPMIC_INT2, 1 << 4),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_DVS3OK,\tPMIC_INT2, 1 << 5),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_DVS4OK,\tPMIC_INT2, 1 << 6),\n\n\tDECLARE_IRQ(MAX8997_PMICIRQ_CHGINS,\tPMIC_INT3, 1 << 0),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_CHGRM,\tPMIC_INT3, 1 << 1),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_DCINOVP,\tPMIC_INT3, 1 << 2),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_TOPOFFR,\tPMIC_INT3, 1 << 3),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_CHGRSTF,\tPMIC_INT3, 1 << 5),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_MBCHGTMEXPD,\tPMIC_INT3, 1 << 7),\n\n\tDECLARE_IRQ(MAX8997_PMICIRQ_RTC60S,\tPMIC_INT4, 1 << 0),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_RTCA1,\tPMIC_INT4, 1 << 1),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_RTCA2,\tPMIC_INT4, 1 << 2),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_SMPL_INT,\tPMIC_INT4, 1 << 3),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_RTC1S,\tPMIC_INT4, 1 << 4),\n\tDECLARE_IRQ(MAX8997_PMICIRQ_WTSR,\tPMIC_INT4, 1 << 5),\n\n\tDECLARE_IRQ(MAX8997_MUICIRQ_ADCError,\tMUIC_INT1, 1 << 2),\n\tDECLARE_IRQ(MAX8997_MUICIRQ_ADCLow,\tMUIC_INT1, 1 << 1),\n\tDECLARE_IRQ(MAX8997_MUICIRQ_ADC,\tMUIC_INT1, 1 << 0),\n\n\tDECLARE_IRQ(MAX8997_MUICIRQ_VBVolt,\tMUIC_INT2, 1 << 4),\n\tDECLARE_IRQ(MAX8997_MUICIRQ_DBChg,\tMUIC_INT2, 1 << 3),\n\tDECLARE_IRQ(MAX8997_MUICIRQ_DCDTmr,\tMUIC_INT2, 1 << 2),\n\tDECLARE_IRQ(MAX8997_MUICIRQ_ChgDetRun,\tMUIC_INT2, 1 << 1),\n\tDECLARE_IRQ(MAX8997_MUICIRQ_ChgTyp,\tMUIC_INT2, 1 << 0),\n\n\tDECLARE_IRQ(MAX8997_MUICIRQ_OVP,\tMUIC_INT3, 1 << 2),\n};\n\nstatic void max8997_irq_lock(struct irq_data *data)\n{\n\tstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\n\n\tmutex_lock(&max8997->irqlock);\n}\n\nstatic void max8997_irq_sync_unlock(struct irq_data *data)\n{\n\tstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\n\tint i;\n\n\tfor (i = 0; i < MAX8997_IRQ_GROUP_NR; i++) {\n\t\tu8 mask_reg = max8997_mask_reg[i];\n\t\tstruct i2c_client *i2c = get_i2c(max8997, i);\n\n\t\tif (mask_reg == MAX8997_REG_INVALID ||\n\t\t\t\tIS_ERR_OR_NULL(i2c))\n\t\t\tcontinue;\n\t\tmax8997->irq_masks_cache[i] = max8997->irq_masks_cur[i];\n\n\t\tmax8997_write_reg(i2c, max8997_mask_reg[i],\n\t\t\t\tmax8997->irq_masks_cur[i]);\n\t}\n\n\tmutex_unlock(&max8997->irqlock);\n}\n\ninline static const struct max8997_irq_data *\nirq_to_max8997_irq(struct max8997_dev *max8997, struct irq_data *data)\n{\n\treturn &max8997_irqs[data->hwirq];\n}\n\nstatic void max8997_irq_mask(struct irq_data *data)\n{\n\tstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\n\tconst struct max8997_irq_data *irq_data = irq_to_max8997_irq(max8997,\n\t\t\t\t\t\t\t\t     data);\n\n\tmax8997->irq_masks_cur[irq_data->group] |= irq_data->mask;\n}\n\nstatic void max8997_irq_unmask(struct irq_data *data)\n{\n\tstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\n\tconst struct max8997_irq_data *irq_data = irq_to_max8997_irq(max8997,\n\t\t\t\t\t\t\t\t     data);\n\n\tmax8997->irq_masks_cur[irq_data->group] &= ~irq_data->mask;\n}\n\nstatic struct irq_chip max8997_irq_chip = {\n\t.name\t\t\t= \"max8997\",\n\t.irq_bus_lock\t\t= max8997_irq_lock,\n\t.irq_bus_sync_unlock\t= max8997_irq_sync_unlock,\n\t.irq_mask\t\t= max8997_irq_mask,\n\t.irq_unmask\t\t= max8997_irq_unmask,\n};\n\n#define MAX8997_IRQSRC_PMIC\t\t(1 << 1)\n#define MAX8997_IRQSRC_FUELGAUGE\t(1 << 2)\n#define MAX8997_IRQSRC_MUIC\t\t(1 << 3)\n#define MAX8997_IRQSRC_GPIO\t\t(1 << 4)\n#define MAX8997_IRQSRC_FLASH\t\t(1 << 5)\nstatic irqreturn_t max8997_irq_thread(int irq, void *data)\n{\n\tstruct max8997_dev *max8997 = data;\n\tu8 irq_reg[MAX8997_IRQ_GROUP_NR] = {};\n\tu8 irq_src;\n\tint ret;\n\tint i, cur_irq;\n\n\tret = max8997_read_reg(max8997->i2c, MAX8997_REG_INTSRC, &irq_src);\n\tif (ret < 0) {\n\t\tdev_err(max8997->dev, \"Failed to read interrupt source: %d\\n\",\n\t\t\t\tret);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (irq_src & MAX8997_IRQSRC_PMIC) {\n\t\t \n\t\tmax8997_bulk_read(max8997->i2c, MAX8997_REG_INT1, 4,\n\t\t\t\t&irq_reg[PMIC_INT1]);\n\t}\n\tif (irq_src & MAX8997_IRQSRC_FUELGAUGE) {\n\t\t \n\t\tirq_reg[FUEL_GAUGE] = 0;\n\t}\n\tif (irq_src & MAX8997_IRQSRC_MUIC) {\n\t\t \n\t\tmax8997_bulk_read(max8997->muic, MAX8997_MUIC_REG_INT1, 3,\n\t\t\t\t&irq_reg[MUIC_INT1]);\n\t}\n\tif (irq_src & MAX8997_IRQSRC_GPIO) {\n\t\t \n\t\tu8 gpio_info[MAX8997_NUM_GPIO];\n\n\t\tirq_reg[GPIO_LOW] = 0;\n\t\tirq_reg[GPIO_HI] = 0;\n\n\t\tmax8997_bulk_read(max8997->i2c, MAX8997_REG_GPIOCNTL1,\n\t\t\t\tMAX8997_NUM_GPIO, gpio_info);\n\t\tfor (i = 0; i < MAX8997_NUM_GPIO; i++) {\n\t\t\tbool interrupt = false;\n\n\t\t\tswitch (gpio_info[i] & MAX8997_GPIO_INT_MASK) {\n\t\t\tcase MAX8997_GPIO_INT_BOTH:\n\t\t\t\tif (max8997->gpio_status[i] != gpio_info[i])\n\t\t\t\t\tinterrupt = true;\n\t\t\t\tbreak;\n\t\t\tcase MAX8997_GPIO_INT_RISE:\n\t\t\t\tif ((max8997->gpio_status[i] != gpio_info[i]) &&\n\t\t\t\t    (gpio_info[i] & MAX8997_GPIO_DATA_MASK))\n\t\t\t\t\tinterrupt = true;\n\t\t\t\tbreak;\n\t\t\tcase MAX8997_GPIO_INT_FALL:\n\t\t\t\tif ((max8997->gpio_status[i] != gpio_info[i]) &&\n\t\t\t\t    !(gpio_info[i] & MAX8997_GPIO_DATA_MASK))\n\t\t\t\t\tinterrupt = true;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (interrupt) {\n\t\t\t\tif (i < 8)\n\t\t\t\t\tirq_reg[GPIO_LOW] |= (1 << i);\n\t\t\t\telse\n\t\t\t\t\tirq_reg[GPIO_HI] |= (1 << (i - 8));\n\t\t\t}\n\n\t\t}\n\t}\n\tif (irq_src & MAX8997_IRQSRC_FLASH) {\n\t\t \n\t\tret = max8997_read_reg(max8997->i2c, MAX8997_REG_FLASHSTATUS,\n\t\t\t\t&irq_reg[FLASH_STATUS]);\n\t}\n\n\t \n\tfor (i = 0; i < MAX8997_IRQ_GROUP_NR; i++)\n\t\tirq_reg[i] &= ~max8997->irq_masks_cur[i];\n\n\t \n\tfor (i = 0; i < MAX8997_IRQ_NR; i++) {\n\t\tif (irq_reg[max8997_irqs[i].group] & max8997_irqs[i].mask) {\n\t\t\tcur_irq = irq_find_mapping(max8997->irq_domain, i);\n\t\t\tif (cur_irq)\n\t\t\t\thandle_nested_irq(cur_irq);\n\t\t}\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nint max8997_irq_resume(struct max8997_dev *max8997)\n{\n\tif (max8997->irq && max8997->irq_domain)\n\t\tmax8997_irq_thread(0, max8997);\n\treturn 0;\n}\n\nstatic int max8997_irq_domain_map(struct irq_domain *d, unsigned int irq,\n\t\t\t\t\tirq_hw_number_t hw)\n{\n\tstruct max8997_dev *max8997 = d->host_data;\n\n\tirq_set_chip_data(irq, max8997);\n\tirq_set_chip_and_handler(irq, &max8997_irq_chip, handle_edge_irq);\n\tirq_set_nested_thread(irq, 1);\n\tirq_set_noprobe(irq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops max8997_irq_domain_ops = {\n\t.map = max8997_irq_domain_map,\n};\n\nint max8997_irq_init(struct max8997_dev *max8997)\n{\n\tstruct irq_domain *domain;\n\tint i;\n\tint ret;\n\tu8 val;\n\n\tif (!max8997->irq) {\n\t\tdev_warn(max8997->dev, \"No interrupt specified.\\n\");\n\t\treturn 0;\n\t}\n\n\tmutex_init(&max8997->irqlock);\n\n\t \n\tfor (i = 0; i < MAX8997_IRQ_GROUP_NR; i++) {\n\t\tstruct i2c_client *i2c;\n\n\t\tmax8997->irq_masks_cur[i] = 0xff;\n\t\tmax8997->irq_masks_cache[i] = 0xff;\n\t\ti2c = get_i2c(max8997, i);\n\n\t\tif (IS_ERR_OR_NULL(i2c))\n\t\t\tcontinue;\n\t\tif (max8997_mask_reg[i] == MAX8997_REG_INVALID)\n\t\t\tcontinue;\n\n\t\tmax8997_write_reg(i2c, max8997_mask_reg[i], 0xff);\n\t}\n\n\tfor (i = 0; i < MAX8997_NUM_GPIO; i++) {\n\t\tmax8997->gpio_status[i] = (max8997_read_reg(max8997->i2c,\n\t\t\t\t\t\tMAX8997_REG_GPIOCNTL1 + i,\n\t\t\t\t\t\t&val)\n\t\t\t\t\t& MAX8997_GPIO_DATA_MASK) ?\n\t\t\t\t\ttrue : false;\n\t}\n\n\tdomain = irq_domain_add_linear(NULL, MAX8997_IRQ_NR,\n\t\t\t\t\t&max8997_irq_domain_ops, max8997);\n\tif (!domain) {\n\t\tdev_err(max8997->dev, \"could not create irq domain\\n\");\n\t\treturn -ENODEV;\n\t}\n\tmax8997->irq_domain = domain;\n\n\tret = request_threaded_irq(max8997->irq, NULL, max8997_irq_thread,\n\t\t\tIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\n\t\t\t\"max8997-irq\", max8997);\n\n\tif (ret) {\n\t\tdev_err(max8997->dev, \"Failed to request IRQ %d: %d\\n\",\n\t\t\t\tmax8997->irq, ret);\n\t\treturn ret;\n\t}\n\n\tif (!max8997->ono)\n\t\treturn 0;\n\n\tret = request_threaded_irq(max8997->ono, NULL, max8997_irq_thread,\n\t\t\tIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\n\t\t\tIRQF_ONESHOT, \"max8997-ono\", max8997);\n\n\tif (ret)\n\t\tdev_err(max8997->dev, \"Failed to request ono-IRQ %d: %d\\n\",\n\t\t\t\tmax8997->ono, ret);\n\n\treturn 0;\n}\n\nvoid max8997_irq_exit(struct max8997_dev *max8997)\n{\n\tif (max8997->ono)\n\t\tfree_irq(max8997->ono, max8997);\n\n\tif (max8997->irq)\n\t\tfree_irq(max8997->irq, max8997);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}