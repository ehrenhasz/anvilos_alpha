{
  "module_name": "virtio_pci_legacy_dev.c",
  "hash_id": "1445fcc5c4056e6f7f7b3dc8df32f7d4babd992f2cc84c3b167e4b1668241789",
  "original_prompt": "Ingested from linux-6.6.14/drivers/virtio/virtio_pci_legacy_dev.c",
  "human_readable_source": "\n\n#include \"linux/virtio_pci.h\"\n#include <linux/virtio_pci_legacy.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n\n\n \nint vp_legacy_probe(struct virtio_pci_legacy_device *ldev)\n{\n\tstruct pci_dev *pci_dev = ldev->pci_dev;\n\tint rc;\n\n\t \n\tif (pci_dev->device < 0x1000 || pci_dev->device > 0x103f)\n\t\treturn -ENODEV;\n\n\tif (pci_dev->revision != VIRTIO_PCI_ABI_VERSION)\n\t\treturn -ENODEV;\n\n\trc = dma_set_mask(&pci_dev->dev, DMA_BIT_MASK(64));\n\tif (rc) {\n\t\trc = dma_set_mask_and_coherent(&pci_dev->dev, DMA_BIT_MASK(32));\n\t} else {\n\t\t \n\t\tdma_set_coherent_mask(&pci_dev->dev,\n\t\t\t\tDMA_BIT_MASK(32 + VIRTIO_PCI_QUEUE_ADDR_SHIFT));\n\t}\n\n\tif (rc)\n\t\tdev_warn(&pci_dev->dev, \"Failed to enable 64-bit or 32-bit DMA.  Trying to continue, but this might not work.\\n\");\n\n\trc = pci_request_region(pci_dev, 0, \"virtio-pci-legacy\");\n\tif (rc)\n\t\treturn rc;\n\n\tldev->ioaddr = pci_iomap(pci_dev, 0, 0);\n\tif (!ldev->ioaddr) {\n\t\trc = -EIO;\n\t\tgoto err_iomap;\n\t}\n\n\tldev->isr = ldev->ioaddr + VIRTIO_PCI_ISR;\n\n\tldev->id.vendor = pci_dev->subsystem_vendor;\n\tldev->id.device = pci_dev->subsystem_device;\n\n\treturn 0;\nerr_iomap:\n\tpci_release_region(pci_dev, 0);\n\treturn rc;\n}\nEXPORT_SYMBOL_GPL(vp_legacy_probe);\n\n \nvoid vp_legacy_remove(struct virtio_pci_legacy_device *ldev)\n{\n\tstruct pci_dev *pci_dev = ldev->pci_dev;\n\n\tpci_iounmap(pci_dev, ldev->ioaddr);\n\tpci_release_region(pci_dev, 0);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_remove);\n\n \nu64 vp_legacy_get_features(struct virtio_pci_legacy_device *ldev)\n{\n\n\treturn ioread32(ldev->ioaddr + VIRTIO_PCI_HOST_FEATURES);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_get_features);\n\n \nu64 vp_legacy_get_driver_features(struct virtio_pci_legacy_device *ldev)\n{\n\treturn ioread32(ldev->ioaddr + VIRTIO_PCI_GUEST_FEATURES);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_get_driver_features);\n\n \nvoid vp_legacy_set_features(struct virtio_pci_legacy_device *ldev,\n\t\t\t    u32 features)\n{\n\tiowrite32(features, ldev->ioaddr + VIRTIO_PCI_GUEST_FEATURES);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_set_features);\n\n \nu8 vp_legacy_get_status(struct virtio_pci_legacy_device *ldev)\n{\n\treturn ioread8(ldev->ioaddr + VIRTIO_PCI_STATUS);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_get_status);\n\n \nvoid vp_legacy_set_status(struct virtio_pci_legacy_device *ldev,\n\t\t\t\t u8 status)\n{\n\tiowrite8(status, ldev->ioaddr + VIRTIO_PCI_STATUS);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_set_status);\n\n \nu16 vp_legacy_queue_vector(struct virtio_pci_legacy_device *ldev,\n\t\t\t   u16 index, u16 vector)\n{\n\tiowrite16(index, ldev->ioaddr + VIRTIO_PCI_QUEUE_SEL);\n\tiowrite16(vector, ldev->ioaddr + VIRTIO_MSI_QUEUE_VECTOR);\n\t \n\treturn ioread16(ldev->ioaddr + VIRTIO_MSI_QUEUE_VECTOR);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_queue_vector);\n\n \nu16 vp_legacy_config_vector(struct virtio_pci_legacy_device *ldev,\n\t\t\t    u16 vector)\n{\n\t \n\tiowrite16(vector, ldev->ioaddr + VIRTIO_MSI_CONFIG_VECTOR);\n\t \n\t \n\treturn ioread16(ldev->ioaddr + VIRTIO_MSI_CONFIG_VECTOR);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_config_vector);\n\n \nvoid vp_legacy_set_queue_address(struct virtio_pci_legacy_device *ldev,\n\t\t\t     u16 index, u32 queue_pfn)\n{\n\tiowrite16(index, ldev->ioaddr + VIRTIO_PCI_QUEUE_SEL);\n\tiowrite32(queue_pfn, ldev->ioaddr + VIRTIO_PCI_QUEUE_PFN);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_set_queue_address);\n\n \nbool vp_legacy_get_queue_enable(struct virtio_pci_legacy_device *ldev,\n\t\t\t\tu16 index)\n{\n\tiowrite16(index, ldev->ioaddr + VIRTIO_PCI_QUEUE_SEL);\n\treturn ioread32(ldev->ioaddr + VIRTIO_PCI_QUEUE_PFN);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_get_queue_enable);\n\n \nu16 vp_legacy_get_queue_size(struct virtio_pci_legacy_device *ldev,\n\t\t\t     u16 index)\n{\n\tiowrite16(index, ldev->ioaddr + VIRTIO_PCI_QUEUE_SEL);\n\treturn ioread16(ldev->ioaddr + VIRTIO_PCI_QUEUE_NUM);\n}\nEXPORT_SYMBOL_GPL(vp_legacy_get_queue_size);\n\nMODULE_VERSION(\"0.1\");\nMODULE_DESCRIPTION(\"Legacy Virtio PCI Device\");\nMODULE_AUTHOR(\"Wu Zongyong <wuzongyong@linux.alibaba.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}