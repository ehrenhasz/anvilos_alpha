{
  "module_name": "da8xx-mstpri.c",
  "hash_id": "f4c150c07aa517378465f12f37e88b9a686960ad5c77e5a611d8a529106689fd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/bus/da8xx-mstpri.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/io.h>\n#include <linux/regmap.h>\n\n \n\n#define DA8XX_MSTPRI0_OFFSET\t\t0\n#define DA8XX_MSTPRI1_OFFSET\t\t4\n#define DA8XX_MSTPRI2_OFFSET\t\t8\n\nenum {\n\tDA8XX_MSTPRI_ARM_I = 0,\n\tDA8XX_MSTPRI_ARM_D,\n\tDA8XX_MSTPRI_UPP,\n\tDA8XX_MSTPRI_SATA,\n\tDA8XX_MSTPRI_PRU0,\n\tDA8XX_MSTPRI_PRU1,\n\tDA8XX_MSTPRI_EDMA30TC0,\n\tDA8XX_MSTPRI_EDMA30TC1,\n\tDA8XX_MSTPRI_EDMA31TC0,\n\tDA8XX_MSTPRI_VPIF_DMA_0,\n\tDA8XX_MSTPRI_VPIF_DMA_1,\n\tDA8XX_MSTPRI_EMAC,\n\tDA8XX_MSTPRI_USB0CFG,\n\tDA8XX_MSTPRI_USB0CDMA,\n\tDA8XX_MSTPRI_UHPI,\n\tDA8XX_MSTPRI_USB1,\n\tDA8XX_MSTPRI_LCDC,\n};\n\nstruct da8xx_mstpri_descr {\n\tint reg;\n\tint shift;\n\tint mask;\n};\n\nstatic const struct da8xx_mstpri_descr da8xx_mstpri_priority_list[] = {\n\t[DA8XX_MSTPRI_ARM_I] = {\n\t\t.reg = DA8XX_MSTPRI0_OFFSET,\n\t\t.shift = 0,\n\t\t.mask = 0x0000000f,\n\t},\n\t[DA8XX_MSTPRI_ARM_D] = {\n\t\t.reg = DA8XX_MSTPRI0_OFFSET,\n\t\t.shift = 4,\n\t\t.mask = 0x000000f0,\n\t},\n\t[DA8XX_MSTPRI_UPP] = {\n\t\t.reg = DA8XX_MSTPRI0_OFFSET,\n\t\t.shift = 16,\n\t\t.mask = 0x000f0000,\n\t},\n\t[DA8XX_MSTPRI_SATA] = {\n\t\t.reg = DA8XX_MSTPRI0_OFFSET,\n\t\t.shift = 20,\n\t\t.mask = 0x00f00000,\n\t},\n\t[DA8XX_MSTPRI_PRU0] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 0,\n\t\t.mask = 0x0000000f,\n\t},\n\t[DA8XX_MSTPRI_PRU1] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 4,\n\t\t.mask = 0x000000f0,\n\t},\n\t[DA8XX_MSTPRI_EDMA30TC0] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 8,\n\t\t.mask = 0x00000f00,\n\t},\n\t[DA8XX_MSTPRI_EDMA30TC1] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 12,\n\t\t.mask = 0x0000f000,\n\t},\n\t[DA8XX_MSTPRI_EDMA31TC0] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 16,\n\t\t.mask = 0x000f0000,\n\t},\n\t[DA8XX_MSTPRI_VPIF_DMA_0] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 24,\n\t\t.mask = 0x0f000000,\n\t},\n\t[DA8XX_MSTPRI_VPIF_DMA_1] = {\n\t\t.reg = DA8XX_MSTPRI1_OFFSET,\n\t\t.shift = 28,\n\t\t.mask = 0xf0000000,\n\t},\n\t[DA8XX_MSTPRI_EMAC] = {\n\t\t.reg = DA8XX_MSTPRI2_OFFSET,\n\t\t.shift = 0,\n\t\t.mask = 0x0000000f,\n\t},\n\t[DA8XX_MSTPRI_USB0CFG] = {\n\t\t.reg = DA8XX_MSTPRI2_OFFSET,\n\t\t.shift = 8,\n\t\t.mask = 0x00000f00,\n\t},\n\t[DA8XX_MSTPRI_USB0CDMA] = {\n\t\t.reg = DA8XX_MSTPRI2_OFFSET,\n\t\t.shift = 12,\n\t\t.mask = 0x0000f000,\n\t},\n\t[DA8XX_MSTPRI_UHPI] = {\n\t\t.reg = DA8XX_MSTPRI2_OFFSET,\n\t\t.shift = 20,\n\t\t.mask = 0x00f00000,\n\t},\n\t[DA8XX_MSTPRI_USB1] = {\n\t\t.reg = DA8XX_MSTPRI2_OFFSET,\n\t\t.shift = 24,\n\t\t.mask = 0x0f000000,\n\t},\n\t[DA8XX_MSTPRI_LCDC] = {\n\t\t.reg = DA8XX_MSTPRI2_OFFSET,\n\t\t.shift = 28,\n\t\t.mask = 0xf0000000,\n\t},\n};\n\nstruct da8xx_mstpri_priority {\n\tint which;\n\tu32 val;\n};\n\nstruct da8xx_mstpri_board_priorities {\n\tconst char *board;\n\tconst struct da8xx_mstpri_priority *priorities;\n\tsize_t numprio;\n};\n\n \nstatic const struct da8xx_mstpri_priority da850_lcdk_priorities[] = {\n\t{\n\t\t.which = DA8XX_MSTPRI_LCDC,\n\t\t.val = 0,\n\t},\n\t{\n\t\t.which = DA8XX_MSTPRI_EDMA30TC1,\n\t\t.val = 0,\n\t},\n\t{\n\t\t.which = DA8XX_MSTPRI_EDMA30TC0,\n\t\t.val = 1,\n\t},\n};\n\nstatic const struct da8xx_mstpri_board_priorities da8xx_mstpri_board_confs[] = {\n\t{\n\t\t.board = \"ti,da850-lcdk\",\n\t\t.priorities = da850_lcdk_priorities,\n\t\t.numprio = ARRAY_SIZE(da850_lcdk_priorities),\n\t},\n};\n\nstatic const struct da8xx_mstpri_board_priorities *\nda8xx_mstpri_get_board_prio(void)\n{\n\tconst struct da8xx_mstpri_board_priorities *board_prio;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(da8xx_mstpri_board_confs); i++) {\n\t\tboard_prio = &da8xx_mstpri_board_confs[i];\n\n\t\tif (of_machine_is_compatible(board_prio->board))\n\t\t\treturn board_prio;\n\t}\n\n\treturn NULL;\n}\n\nstatic int da8xx_mstpri_probe(struct platform_device *pdev)\n{\n\tconst struct da8xx_mstpri_board_priorities *prio_list;\n\tconst struct da8xx_mstpri_descr *prio_descr;\n\tconst struct da8xx_mstpri_priority *prio;\n\tstruct device *dev = &pdev->dev;\n\tstruct resource *res;\n\tvoid __iomem *mstpri;\n\tu32 reg;\n\tint i;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tmstpri = devm_ioremap_resource(dev, res);\n\tif (IS_ERR(mstpri)) {\n\t\tdev_err(dev, \"unable to map MSTPRI registers\\n\");\n\t\treturn PTR_ERR(mstpri);\n\t}\n\n\tprio_list = da8xx_mstpri_get_board_prio();\n\tif (!prio_list) {\n\t\tdev_err(dev, \"no master priorities defined for this board\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < prio_list->numprio; i++) {\n\t\tprio = &prio_list->priorities[i];\n\t\tprio_descr = &da8xx_mstpri_priority_list[prio->which];\n\n\t\tif (prio_descr->reg + sizeof(u32) > resource_size(res)) {\n\t\t\tdev_warn(dev, \"register offset out of range\\n\");\n\t\t\tcontinue;\n\t\t}\n\n\t\treg = readl(mstpri + prio_descr->reg);\n\t\treg &= ~prio_descr->mask;\n\t\treg |= prio->val << prio_descr->shift;\n\n\t\twritel(reg, mstpri + prio_descr->reg);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id da8xx_mstpri_of_match[] = {\n\t{ .compatible = \"ti,da850-mstpri\", },\n\t{ },\n};\n\nstatic struct platform_driver da8xx_mstpri_driver = {\n\t.probe = da8xx_mstpri_probe,\n\t.driver = {\n\t\t.name = \"da8xx-mstpri\",\n\t\t.of_match_table = da8xx_mstpri_of_match,\n\t},\n};\nmodule_platform_driver(da8xx_mstpri_driver);\n\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_DESCRIPTION(\"TI da8xx master peripheral priority driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}