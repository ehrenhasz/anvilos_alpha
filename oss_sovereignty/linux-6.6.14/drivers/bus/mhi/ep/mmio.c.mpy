{
  "module_name": "mmio.c",
  "hash_id": "879387397684f8fa03750efcf09a461b101e03784ef0244c7787f16047233e1f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/bus/mhi/ep/mmio.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/io.h>\n#include <linux/mhi_ep.h>\n\n#include \"internal.h\"\n\nu32 mhi_ep_mmio_read(struct mhi_ep_cntrl *mhi_cntrl, u32 offset)\n{\n\treturn readl(mhi_cntrl->mmio + offset);\n}\n\nvoid mhi_ep_mmio_write(struct mhi_ep_cntrl *mhi_cntrl, u32 offset, u32 val)\n{\n\twritel(val, mhi_cntrl->mmio + offset);\n}\n\nvoid mhi_ep_mmio_masked_write(struct mhi_ep_cntrl *mhi_cntrl, u32 offset, u32 mask, u32 val)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, offset);\n\tregval &= ~mask;\n\tregval |= (val << __ffs(mask)) & mask;\n\tmhi_ep_mmio_write(mhi_cntrl, offset, regval);\n}\n\nu32 mhi_ep_mmio_masked_read(struct mhi_ep_cntrl *dev, u32 offset, u32 mask)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(dev, offset);\n\tregval &= mask;\n\tregval >>= __ffs(mask);\n\n\treturn regval;\n}\n\nvoid mhi_ep_mmio_get_mhi_state(struct mhi_ep_cntrl *mhi_cntrl, enum mhi_state *state,\n\t\t\t\tbool *mhi_reset)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_MHICTRL);\n\t*state = FIELD_GET(MHICTRL_MHISTATE_MASK, regval);\n\t*mhi_reset = !!FIELD_GET(MHICTRL_RESET_MASK, regval);\n}\n\nstatic void mhi_ep_mmio_set_chdb(struct mhi_ep_cntrl *mhi_cntrl, u32 ch_id, bool enable)\n{\n\tu32 chid_mask, chid_shift, chdb_idx, val;\n\n\tchid_shift = ch_id % 32;\n\tchid_mask = BIT(chid_shift);\n\tchdb_idx = ch_id / 32;\n\n\tval = enable ? 1 : 0;\n\n\tmhi_ep_mmio_masked_write(mhi_cntrl, MHI_CHDB_INT_MASK_n(chdb_idx), chid_mask, val);\n\n\t \n\tmhi_cntrl->chdb[chdb_idx].mask &= ~chid_mask;\n\tmhi_cntrl->chdb[chdb_idx].mask |= val << chid_shift;\n}\n\nvoid mhi_ep_mmio_enable_chdb(struct mhi_ep_cntrl *mhi_cntrl, u32 ch_id)\n{\n\tmhi_ep_mmio_set_chdb(mhi_cntrl, ch_id, true);\n}\n\nvoid mhi_ep_mmio_disable_chdb(struct mhi_ep_cntrl *mhi_cntrl, u32 ch_id)\n{\n\tmhi_ep_mmio_set_chdb(mhi_cntrl, ch_id, false);\n}\n\nstatic void mhi_ep_mmio_set_chdb_interrupts(struct mhi_ep_cntrl *mhi_cntrl, bool enable)\n{\n\tu32 val, i;\n\n\tval = enable ? MHI_CHDB_INT_MASK_n_EN_ALL : 0;\n\n\tfor (i = 0; i < MHI_MASK_ROWS_CH_DB; i++) {\n\t\tmhi_ep_mmio_write(mhi_cntrl, MHI_CHDB_INT_MASK_n(i), val);\n\t\tmhi_cntrl->chdb[i].mask = val;\n\t}\n}\n\nvoid mhi_ep_mmio_enable_chdb_interrupts(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_set_chdb_interrupts(mhi_cntrl, true);\n}\n\nstatic void mhi_ep_mmio_mask_chdb_interrupts(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_set_chdb_interrupts(mhi_cntrl, false);\n}\n\nbool mhi_ep_mmio_read_chdb_status_interrupts(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tbool chdb = false;\n\tu32 i;\n\n\tfor (i = 0; i < MHI_MASK_ROWS_CH_DB; i++) {\n\t\tmhi_cntrl->chdb[i].status = mhi_ep_mmio_read(mhi_cntrl, MHI_CHDB_INT_STATUS_n(i));\n\t\tif (mhi_cntrl->chdb[i].status)\n\t\t\tchdb = true;\n\t}\n\n\t \n\treturn chdb;\n}\n\nstatic void mhi_ep_mmio_set_erdb_interrupts(struct mhi_ep_cntrl *mhi_cntrl, bool enable)\n{\n\tu32 val, i;\n\n\tval = enable ? MHI_ERDB_INT_MASK_n_EN_ALL : 0;\n\n\tfor (i = 0; i < MHI_MASK_ROWS_EV_DB; i++)\n\t\tmhi_ep_mmio_write(mhi_cntrl, MHI_ERDB_INT_MASK_n(i), val);\n}\n\nstatic void mhi_ep_mmio_mask_erdb_interrupts(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_set_erdb_interrupts(mhi_cntrl, false);\n}\n\nvoid mhi_ep_mmio_enable_ctrl_interrupt(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_masked_write(mhi_cntrl, MHI_CTRL_INT_MASK,\n\t\t\t\t  MHI_CTRL_MHICTRL_MASK, 1);\n}\n\nvoid mhi_ep_mmio_disable_ctrl_interrupt(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_masked_write(mhi_cntrl, MHI_CTRL_INT_MASK,\n\t\t\t\t  MHI_CTRL_MHICTRL_MASK, 0);\n}\n\nvoid mhi_ep_mmio_enable_cmdb_interrupt(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_masked_write(mhi_cntrl, MHI_CTRL_INT_MASK,\n\t\t\t\t  MHI_CTRL_CRDB_MASK, 1);\n}\n\nvoid mhi_ep_mmio_disable_cmdb_interrupt(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_masked_write(mhi_cntrl, MHI_CTRL_INT_MASK,\n\t\t\t\t  MHI_CTRL_CRDB_MASK, 0);\n}\n\nvoid mhi_ep_mmio_mask_interrupts(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_disable_ctrl_interrupt(mhi_cntrl);\n\tmhi_ep_mmio_disable_cmdb_interrupt(mhi_cntrl);\n\tmhi_ep_mmio_mask_chdb_interrupts(mhi_cntrl);\n\tmhi_ep_mmio_mask_erdb_interrupts(mhi_cntrl);\n}\n\nstatic void mhi_ep_mmio_clear_interrupts(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tu32 i;\n\n\tfor (i = 0; i < MHI_MASK_ROWS_CH_DB; i++)\n\t\tmhi_ep_mmio_write(mhi_cntrl, MHI_CHDB_INT_CLEAR_n(i),\n\t\t\t\t   MHI_CHDB_INT_CLEAR_n_CLEAR_ALL);\n\n\tfor (i = 0; i < MHI_MASK_ROWS_EV_DB; i++)\n\t\tmhi_ep_mmio_write(mhi_cntrl, MHI_ERDB_INT_CLEAR_n(i),\n\t\t\t\t   MHI_ERDB_INT_CLEAR_n_CLEAR_ALL);\n\n\tmhi_ep_mmio_write(mhi_cntrl, MHI_CTRL_INT_CLEAR,\n\t\t\t   MHI_CTRL_INT_MMIO_WR_CLEAR |\n\t\t\t   MHI_CTRL_INT_CRDB_CLEAR |\n\t\t\t   MHI_CTRL_INT_CRDB_MHICTRL_CLEAR);\n}\n\nvoid mhi_ep_mmio_get_chc_base(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_CCABAP_HIGHER);\n\tmhi_cntrl->ch_ctx_host_pa = regval;\n\tmhi_cntrl->ch_ctx_host_pa <<= 32;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_CCABAP_LOWER);\n\tmhi_cntrl->ch_ctx_host_pa |= regval;\n}\n\nvoid mhi_ep_mmio_get_erc_base(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_ECABAP_HIGHER);\n\tmhi_cntrl->ev_ctx_host_pa = regval;\n\tmhi_cntrl->ev_ctx_host_pa <<= 32;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_ECABAP_LOWER);\n\tmhi_cntrl->ev_ctx_host_pa |= regval;\n}\n\nvoid mhi_ep_mmio_get_crc_base(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_CRCBAP_HIGHER);\n\tmhi_cntrl->cmd_ctx_host_pa = regval;\n\tmhi_cntrl->cmd_ctx_host_pa <<= 32;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_CRCBAP_LOWER);\n\tmhi_cntrl->cmd_ctx_host_pa |= regval;\n}\n\nu64 mhi_ep_mmio_get_db(struct mhi_ep_ring *ring)\n{\n\tstruct mhi_ep_cntrl *mhi_cntrl = ring->mhi_cntrl;\n\tu64 db_offset;\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, ring->db_offset_h);\n\tdb_offset = regval;\n\tdb_offset <<= 32;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, ring->db_offset_l);\n\tdb_offset |= regval;\n\n\treturn db_offset;\n}\n\nvoid mhi_ep_mmio_set_env(struct mhi_ep_cntrl *mhi_cntrl, u32 value)\n{\n\tmhi_ep_mmio_write(mhi_cntrl, EP_BHI_EXECENV, value);\n}\n\nvoid mhi_ep_mmio_clear_reset(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_masked_write(mhi_cntrl, EP_MHICTRL, MHICTRL_RESET_MASK, 0);\n}\n\nvoid mhi_ep_mmio_reset(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tmhi_ep_mmio_write(mhi_cntrl, EP_MHICTRL, 0);\n\tmhi_ep_mmio_write(mhi_cntrl, EP_MHISTATUS, 0);\n\tmhi_ep_mmio_clear_interrupts(mhi_cntrl);\n}\n\nvoid mhi_ep_mmio_init(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tu32 regval;\n\n\tmhi_cntrl->chdb_offset = mhi_ep_mmio_read(mhi_cntrl, EP_CHDBOFF);\n\tmhi_cntrl->erdb_offset = mhi_ep_mmio_read(mhi_cntrl, EP_ERDBOFF);\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_MHICFG);\n\tmhi_cntrl->event_rings = FIELD_GET(MHICFG_NER_MASK, regval);\n\tmhi_cntrl->hw_event_rings = FIELD_GET(MHICFG_NHWER_MASK, regval);\n\n\tmhi_ep_mmio_reset(mhi_cntrl);\n}\n\nvoid mhi_ep_mmio_update_ner(struct mhi_ep_cntrl *mhi_cntrl)\n{\n\tu32 regval;\n\n\tregval = mhi_ep_mmio_read(mhi_cntrl, EP_MHICFG);\n\tmhi_cntrl->event_rings = FIELD_GET(MHICFG_NER_MASK, regval);\n\tmhi_cntrl->hw_event_rings = FIELD_GET(MHICFG_NHWER_MASK, regval);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}