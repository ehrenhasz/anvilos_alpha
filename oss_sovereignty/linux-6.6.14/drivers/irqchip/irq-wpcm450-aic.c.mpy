{
  "module_name": "irq-wpcm450-aic.c",
  "hash_id": "3541e65a7084601ea62950609a4cfcb522586a98e3b187b2241f8f444cbfe287",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-wpcm450-aic.c",
  "human_readable_source": "\n\n\n#include <linux/irqchip.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/printk.h>\n\n#include <asm/exception.h>\n\n#define AIC_SCR(x)\t((x)*4)\t \n#define AIC_GEN\t\t0x84\t \n#define AIC_GRSR\t0x88\t \n#define AIC_IRSR\t0x100\t \n#define AIC_IASR\t0x104\t \n#define AIC_ISR\t\t0x108\t \n#define AIC_IPER\t0x10c\t \n#define AIC_ISNR\t0x110\t \n#define AIC_IMR\t\t0x114\t \n#define AIC_OISR\t0x118\t \n#define AIC_MECR\t0x120\t \n#define AIC_MDCR\t0x124\t \n#define AIC_SSCR\t0x128\t \n#define AIC_SCCR\t0x12c\t \n#define AIC_EOSCR\t0x130\t \n\n#define AIC_SCR_SRCTYPE_LOW_LEVEL\t(0 << 6)\n#define AIC_SCR_SRCTYPE_HIGH_LEVEL\t(1 << 6)\n#define AIC_SCR_SRCTYPE_NEG_EDGE\t(2 << 6)\n#define AIC_SCR_SRCTYPE_POS_EDGE\t(3 << 6)\n#define AIC_SCR_PRIORITY(x)\t\t(x)\n#define AIC_SCR_PRIORITY_MASK\t\t0x7\n\n#define AIC_NUM_IRQS\t\t32\n\nstruct wpcm450_aic {\n\tvoid __iomem *regs;\n\tstruct irq_domain *domain;\n};\n\nstatic struct wpcm450_aic *aic;\n\nstatic void wpcm450_aic_init_hw(void)\n{\n\tint i;\n\n\t \n\twritel(0xffffffff, aic->regs + AIC_MDCR);\n\n\t \n\treadl(aic->regs + AIC_IPER);\n\twritel(0, aic->regs + AIC_EOSCR);\n\n\t \n\tfor (i = 0; i < AIC_NUM_IRQS; i++)\n\t\twritel(AIC_SCR_SRCTYPE_HIGH_LEVEL | AIC_SCR_PRIORITY(7),\n\t\t       aic->regs + AIC_SCR(i));\n}\n\nstatic void __exception_irq_entry wpcm450_aic_handle_irq(struct pt_regs *regs)\n{\n\tint hwirq;\n\n\t \n\t \n\thwirq = readl(aic->regs + AIC_IPER) / 4;\n\n\tgeneric_handle_domain_irq(aic->domain, hwirq);\n}\n\nstatic void wpcm450_aic_eoi(struct irq_data *d)\n{\n\t \n\twritel(0, aic->regs + AIC_EOSCR);\n}\n\nstatic void wpcm450_aic_mask(struct irq_data *d)\n{\n\tunsigned int mask = BIT(d->hwirq);\n\n\t \n\twritel(mask, aic->regs + AIC_MDCR);\n}\n\nstatic void wpcm450_aic_unmask(struct irq_data *d)\n{\n\tunsigned int mask = BIT(d->hwirq);\n\n\t \n\twritel(mask, aic->regs + AIC_MECR);\n}\n\nstatic int wpcm450_aic_set_type(struct irq_data *d, unsigned int flow_type)\n{\n\t \n\tif ((flow_type & IRQ_TYPE_SENSE_MASK) != IRQ_TYPE_LEVEL_HIGH)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic struct irq_chip wpcm450_aic_chip = {\n\t.name = \"wpcm450-aic\",\n\t.irq_eoi = wpcm450_aic_eoi,\n\t.irq_mask = wpcm450_aic_mask,\n\t.irq_unmask = wpcm450_aic_unmask,\n\t.irq_set_type = wpcm450_aic_set_type,\n};\n\nstatic int wpcm450_aic_map(struct irq_domain *d, unsigned int irq, irq_hw_number_t hwirq)\n{\n\tif (hwirq >= AIC_NUM_IRQS)\n\t\treturn -EPERM;\n\n\tirq_set_chip_and_handler(irq, &wpcm450_aic_chip, handle_fasteoi_irq);\n\tirq_set_chip_data(irq, aic);\n\tirq_set_probe(irq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops wpcm450_aic_ops = {\n\t.map = wpcm450_aic_map,\n\t.xlate = irq_domain_xlate_twocell,\n};\n\nstatic int __init wpcm450_aic_of_init(struct device_node *node,\n\t\t\t\t      struct device_node *parent)\n{\n\tif (parent)\n\t\treturn -EINVAL;\n\n\taic = kzalloc(sizeof(*aic), GFP_KERNEL);\n\tif (!aic)\n\t\treturn -ENOMEM;\n\n\taic->regs = of_iomap(node, 0);\n\tif (!aic->regs) {\n\t\tpr_err(\"Failed to map WPCM450 AIC registers\\n\");\n\t\tkfree(aic);\n\t\treturn -ENOMEM;\n\t}\n\n\twpcm450_aic_init_hw();\n\n\tset_handle_irq(wpcm450_aic_handle_irq);\n\n\taic->domain = irq_domain_add_linear(node, AIC_NUM_IRQS, &wpcm450_aic_ops, aic);\n\n\treturn 0;\n}\n\nIRQCHIP_DECLARE(wpcm450_aic, \"nuvoton,wpcm450-aic\", wpcm450_aic_of_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}