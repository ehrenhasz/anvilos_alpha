{
  "module_name": "irq-idt3243x.c",
  "hash_id": "5856381085cf2521cdd0e02639ceff639a9e2517bb94bc41e68e4e5306c88416",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-idt3243x.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqchip/chained_irq.h>\n#include <linux/irqdomain.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n\n#define IDT_PIC_NR_IRQS\t\t32\n\n#define IDT_PIC_IRQ_PEND\t\t0x00\n#define IDT_PIC_IRQ_MASK\t\t0x08\n\nstruct idt_pic_data {\n\tvoid __iomem *base;\n\tstruct irq_domain *irq_domain;\n\tstruct irq_chip_generic *gc;\n};\n\nstatic void idt_irq_dispatch(struct irq_desc *desc)\n{\n\tstruct idt_pic_data *idtpic = irq_desc_get_handler_data(desc);\n\tstruct irq_chip *host_chip = irq_desc_get_chip(desc);\n\tu32 pending, hwirq;\n\n\tchained_irq_enter(host_chip, desc);\n\n\tpending = irq_reg_readl(idtpic->gc, IDT_PIC_IRQ_PEND);\n\tpending &= ~idtpic->gc->mask_cache;\n\twhile (pending) {\n\t\thwirq = __fls(pending);\n\t\tgeneric_handle_domain_irq(idtpic->irq_domain, hwirq);\n\t\tpending &= ~(1 << hwirq);\n\t}\n\n\tchained_irq_exit(host_chip, desc);\n}\n\nstatic int idt_pic_init(struct device_node *of_node, struct device_node *parent)\n{\n\tstruct irq_domain *domain;\n\tstruct idt_pic_data *idtpic;\n\tstruct irq_chip_generic *gc;\n\tstruct irq_chip_type *ct;\n\tunsigned int parent_irq;\n\tint ret = 0;\n\n\tidtpic = kzalloc(sizeof(*idtpic), GFP_KERNEL);\n\tif (!idtpic) {\n\t\tret = -ENOMEM;\n\t\tgoto out_err;\n\t}\n\n\tparent_irq = irq_of_parse_and_map(of_node, 0);\n\tif (!parent_irq) {\n\t\tpr_err(\"Failed to map parent IRQ!\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out_free;\n\t}\n\n\tidtpic->base = of_iomap(of_node, 0);\n\tif (!idtpic->base) {\n\t\tpr_err(\"Failed to map base address!\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto out_unmap_irq;\n\t}\n\n\tdomain = irq_domain_add_linear(of_node, IDT_PIC_NR_IRQS,\n\t\t\t\t       &irq_generic_chip_ops, NULL);\n\tif (!domain) {\n\t\tpr_err(\"Failed to add irqdomain!\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto out_iounmap;\n\t}\n\tidtpic->irq_domain = domain;\n\n\tret = irq_alloc_domain_generic_chips(domain, 32, 1, \"IDTPIC\",\n\t\t\t\t\t     handle_level_irq, 0,\n\t\t\t\t\t     IRQ_NOPROBE | IRQ_LEVEL, 0);\n\tif (ret)\n\t\tgoto out_domain_remove;\n\n\tgc = irq_get_domain_generic_chip(domain, 0);\n\tgc->reg_base = idtpic->base;\n\tgc->private = idtpic;\n\n\tct = gc->chip_types;\n\tct->regs.mask = IDT_PIC_IRQ_MASK;\n\tct->chip.irq_mask = irq_gc_mask_set_bit;\n\tct->chip.irq_unmask = irq_gc_mask_clr_bit;\n\tidtpic->gc = gc;\n\n\t \n\twritel(0xffffffff, idtpic->base + IDT_PIC_IRQ_MASK);\n\tgc->mask_cache = 0xffffffff;\n\n\tirq_set_chained_handler_and_data(parent_irq,\n\t\t\t\t\t idt_irq_dispatch, idtpic);\n\n\treturn 0;\n\nout_domain_remove:\n\tirq_domain_remove(domain);\nout_iounmap:\n\tiounmap(idtpic->base);\nout_unmap_irq:\n\tirq_dispose_mapping(parent_irq);\nout_free:\n\tkfree(idtpic);\nout_err:\n\tpr_err(\"Failed to initialize! (errno = %d)\\n\", ret);\n\treturn ret;\n}\n\nIRQCHIP_DECLARE(idt_pic, \"idt,32434-pic\", idt_pic_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}