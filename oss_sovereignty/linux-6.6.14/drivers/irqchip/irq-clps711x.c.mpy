{
  "module_name": "irq-clps711x.c",
  "hash_id": "ec6d90950622cc45d714fcba285589ec0105312f52df6662e312f4d438b9f0cd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-clps711x.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqdomain.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/slab.h>\n\n#include <asm/exception.h>\n#include <asm/mach/irq.h>\n\n#define CLPS711X_INTSR1\t(0x0240)\n#define CLPS711X_INTMR1\t(0x0280)\n#define CLPS711X_BLEOI\t(0x0600)\n#define CLPS711X_MCEOI\t(0x0640)\n#define CLPS711X_TEOI\t(0x0680)\n#define CLPS711X_TC1EOI\t(0x06c0)\n#define CLPS711X_TC2EOI\t(0x0700)\n#define CLPS711X_RTCEOI\t(0x0740)\n#define CLPS711X_UMSEOI\t(0x0780)\n#define CLPS711X_COEOI\t(0x07c0)\n#define CLPS711X_INTSR2\t(0x1240)\n#define CLPS711X_INTMR2\t(0x1280)\n#define CLPS711X_SRXEOF\t(0x1600)\n#define CLPS711X_KBDEOI\t(0x1700)\n#define CLPS711X_INTSR3\t(0x2240)\n#define CLPS711X_INTMR3\t(0x2280)\n\nstatic const struct {\n#define CLPS711X_FLAG_EN\t(1 << 0)\n#define CLPS711X_FLAG_FIQ\t(1 << 1)\n\tunsigned int\tflags;\n\tphys_addr_t\teoi;\n} clps711x_irqs[] = {\n\t[1]\t= { CLPS711X_FLAG_FIQ, CLPS711X_BLEOI, },\n\t[3]\t= { CLPS711X_FLAG_FIQ, CLPS711X_MCEOI, },\n\t[4]\t= { CLPS711X_FLAG_EN, CLPS711X_COEOI, },\n\t[5]\t= { CLPS711X_FLAG_EN, },\n\t[6]\t= { CLPS711X_FLAG_EN, },\n\t[7]\t= { CLPS711X_FLAG_EN, },\n\t[8]\t= { CLPS711X_FLAG_EN, CLPS711X_TC1EOI, },\n\t[9]\t= { CLPS711X_FLAG_EN, CLPS711X_TC2EOI, },\n\t[10]\t= { CLPS711X_FLAG_EN, CLPS711X_RTCEOI, },\n\t[11]\t= { CLPS711X_FLAG_EN, CLPS711X_TEOI, },\n\t[12]\t= { CLPS711X_FLAG_EN, },\n\t[13]\t= { CLPS711X_FLAG_EN, },\n\t[14]\t= { CLPS711X_FLAG_EN, CLPS711X_UMSEOI, },\n\t[15]\t= { CLPS711X_FLAG_EN, CLPS711X_SRXEOF, },\n\t[16]\t= { CLPS711X_FLAG_EN, CLPS711X_KBDEOI, },\n\t[17]\t= { CLPS711X_FLAG_EN, },\n\t[18]\t= { CLPS711X_FLAG_EN, },\n\t[28]\t= { CLPS711X_FLAG_EN, },\n\t[29]\t= { CLPS711X_FLAG_EN, },\n\t[32]\t= { CLPS711X_FLAG_FIQ, },\n};\n\nstatic struct {\n\tvoid __iomem\t\t*base;\n\tvoid __iomem\t\t*intmr[3];\n\tvoid __iomem\t\t*intsr[3];\n\tstruct irq_domain\t*domain;\n\tstruct irq_domain_ops\tops;\n} *clps711x_intc;\n\nstatic asmlinkage void __exception_irq_entry clps711x_irqh(struct pt_regs *regs)\n{\n\tu32 irqstat;\n\n\tdo {\n\t\tirqstat = readw_relaxed(clps711x_intc->intmr[0]) &\n\t\t\t  readw_relaxed(clps711x_intc->intsr[0]);\n\t\tif (irqstat)\n\t\t\tgeneric_handle_domain_irq(clps711x_intc->domain,\n\t\t\t\t\t\t  fls(irqstat) - 1);\n\n\t\tirqstat = readw_relaxed(clps711x_intc->intmr[1]) &\n\t\t\t  readw_relaxed(clps711x_intc->intsr[1]);\n\t\tif (irqstat)\n\t\t\tgeneric_handle_domain_irq(clps711x_intc->domain,\n\t\t\t\t\t\t  fls(irqstat) - 1 + 16);\n\t} while (irqstat);\n}\n\nstatic void clps711x_intc_eoi(struct irq_data *d)\n{\n\tirq_hw_number_t hwirq = irqd_to_hwirq(d);\n\n\twritel_relaxed(0, clps711x_intc->base + clps711x_irqs[hwirq].eoi);\n}\n\nstatic void clps711x_intc_mask(struct irq_data *d)\n{\n\tirq_hw_number_t hwirq = irqd_to_hwirq(d);\n\tvoid __iomem *intmr = clps711x_intc->intmr[hwirq / 16];\n\tu32 tmp;\n\n\ttmp = readl_relaxed(intmr);\n\ttmp &= ~(1 << (hwirq % 16));\n\twritel_relaxed(tmp, intmr);\n}\n\nstatic void clps711x_intc_unmask(struct irq_data *d)\n{\n\tirq_hw_number_t hwirq = irqd_to_hwirq(d);\n\tvoid __iomem *intmr = clps711x_intc->intmr[hwirq / 16];\n\tu32 tmp;\n\n\ttmp = readl_relaxed(intmr);\n\ttmp |= 1 << (hwirq % 16);\n\twritel_relaxed(tmp, intmr);\n}\n\nstatic struct irq_chip clps711x_intc_chip = {\n\t.name\t\t= \"clps711x-intc\",\n\t.irq_eoi\t= clps711x_intc_eoi,\n\t.irq_mask\t= clps711x_intc_mask,\n\t.irq_unmask\t= clps711x_intc_unmask,\n};\n\nstatic int __init clps711x_intc_irq_map(struct irq_domain *h, unsigned int virq,\n\t\t\t\t\tirq_hw_number_t hw)\n{\n\tirq_flow_handler_t handler = handle_level_irq;\n\tunsigned int flags = 0;\n\n\tif (!clps711x_irqs[hw].flags)\n\t\treturn 0;\n\n\tif (clps711x_irqs[hw].flags & CLPS711X_FLAG_FIQ) {\n\t\thandler = handle_bad_irq;\n\t\tflags |= IRQ_NOAUTOEN;\n\t} else if (clps711x_irqs[hw].eoi) {\n\t\thandler = handle_fasteoi_irq;\n\t}\n\n\t \n\tif (clps711x_irqs[hw].eoi)\n\t\twritel_relaxed(0, clps711x_intc->base + clps711x_irqs[hw].eoi);\n\n\tirq_set_chip_and_handler(virq, &clps711x_intc_chip, handler);\n\tirq_modify_status(virq, IRQ_NOPROBE, flags);\n\n\treturn 0;\n}\n\nstatic int __init _clps711x_intc_init(struct device_node *np,\n\t\t\t\t      phys_addr_t base, resource_size_t size)\n{\n\tint err;\n\n\tclps711x_intc = kzalloc(sizeof(*clps711x_intc), GFP_KERNEL);\n\tif (!clps711x_intc)\n\t\treturn -ENOMEM;\n\n\tclps711x_intc->base = ioremap(base, size);\n\tif (!clps711x_intc->base) {\n\t\terr = -ENOMEM;\n\t\tgoto out_kfree;\n\t}\n\n\tclps711x_intc->intsr[0] = clps711x_intc->base + CLPS711X_INTSR1;\n\tclps711x_intc->intmr[0] = clps711x_intc->base + CLPS711X_INTMR1;\n\tclps711x_intc->intsr[1] = clps711x_intc->base + CLPS711X_INTSR2;\n\tclps711x_intc->intmr[1] = clps711x_intc->base + CLPS711X_INTMR2;\n\tclps711x_intc->intsr[2] = clps711x_intc->base + CLPS711X_INTSR3;\n\tclps711x_intc->intmr[2] = clps711x_intc->base + CLPS711X_INTMR3;\n\n\t \n\twritel_relaxed(0, clps711x_intc->intmr[0]);\n\twritel_relaxed(0, clps711x_intc->intmr[1]);\n\twritel_relaxed(0, clps711x_intc->intmr[2]);\n\n\terr = irq_alloc_descs(-1, 0, ARRAY_SIZE(clps711x_irqs), numa_node_id());\n\tif (err < 0)\n\t\tgoto out_iounmap;\n\n\tclps711x_intc->ops.map = clps711x_intc_irq_map;\n\tclps711x_intc->ops.xlate = irq_domain_xlate_onecell;\n\tclps711x_intc->domain =\n\t\tirq_domain_add_legacy(np, ARRAY_SIZE(clps711x_irqs),\n\t\t\t\t      0, 0, &clps711x_intc->ops, NULL);\n\tif (!clps711x_intc->domain) {\n\t\terr = -ENOMEM;\n\t\tgoto out_irqfree;\n\t}\n\n\tirq_set_default_host(clps711x_intc->domain);\n\tset_handle_irq(clps711x_irqh);\n\n#ifdef CONFIG_FIQ\n\tinit_FIQ(0);\n#endif\n\n\treturn 0;\n\nout_irqfree:\n\tirq_free_descs(0, ARRAY_SIZE(clps711x_irqs));\n\nout_iounmap:\n\tiounmap(clps711x_intc->base);\n\nout_kfree:\n\tkfree(clps711x_intc);\n\n\treturn err;\n}\n\nstatic int __init clps711x_intc_init_dt(struct device_node *np,\n\t\t\t\t\tstruct device_node *parent)\n{\n\tstruct resource res;\n\tint err;\n\n\terr = of_address_to_resource(np, 0, &res);\n\tif (err)\n\t\treturn err;\n\n\treturn _clps711x_intc_init(np, res.start, resource_size(&res));\n}\nIRQCHIP_DECLARE(clps711x, \"cirrus,ep7209-intc\", clps711x_intc_init_dt);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}