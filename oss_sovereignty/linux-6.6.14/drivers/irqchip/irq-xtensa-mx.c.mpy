{
  "module_name": "irq-xtensa-mx.c",
  "hash_id": "ff88674aa36dc071515adb2a7912ca2282b5854cc21b9cf49aa6fd5c444e8819",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-xtensa-mx.c",
  "human_readable_source": " \n\n#include <linux/interrupt.h>\n#include <linux/irqdomain.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqchip/xtensa-mx.h>\n#include <linux/of.h>\n\n#include <asm/mxregs.h>\n\n#define HW_IRQ_IPI_COUNT 2\n#define HW_IRQ_MX_BASE 2\n#define HW_IRQ_EXTERN_BASE 3\n\nstatic DEFINE_PER_CPU(unsigned int, cached_irq_mask);\n\nstatic int xtensa_mx_irq_map(struct irq_domain *d, unsigned int irq,\n\t\tirq_hw_number_t hw)\n{\n\tif (hw < HW_IRQ_IPI_COUNT) {\n\t\tstruct irq_chip *irq_chip = d->host_data;\n\t\tirq_set_chip_and_handler_name(irq, irq_chip,\n\t\t\t\thandle_percpu_irq, \"ipi\");\n\t\tirq_set_status_flags(irq, IRQ_LEVEL);\n\t\treturn 0;\n\t}\n\tirqd_set_single_target(irq_desc_get_irq_data(irq_to_desc(irq)));\n\treturn xtensa_irq_map(d, irq, hw);\n}\n\n \nstatic int xtensa_mx_irq_domain_xlate(struct irq_domain *d,\n\t\tstruct device_node *ctrlr,\n\t\tconst u32 *intspec, unsigned int intsize,\n\t\tunsigned long *out_hwirq, unsigned int *out_type)\n{\n\treturn xtensa_irq_domain_xlate(intspec, intsize,\n\t\t\tintspec[0], intspec[0] + HW_IRQ_EXTERN_BASE,\n\t\t\tout_hwirq, out_type);\n}\n\nstatic const struct irq_domain_ops xtensa_mx_irq_domain_ops = {\n\t.xlate = xtensa_mx_irq_domain_xlate,\n\t.map = xtensa_mx_irq_map,\n};\n\nvoid secondary_init_irq(void)\n{\n\t__this_cpu_write(cached_irq_mask,\n\t\t\tXCHAL_INTTYPE_MASK_EXTERN_EDGE |\n\t\t\tXCHAL_INTTYPE_MASK_EXTERN_LEVEL);\n\txtensa_set_sr(XCHAL_INTTYPE_MASK_EXTERN_EDGE |\n\t\t\tXCHAL_INTTYPE_MASK_EXTERN_LEVEL, intenable);\n}\n\nstatic void xtensa_mx_irq_mask(struct irq_data *d)\n{\n\tunsigned int mask = 1u << d->hwirq;\n\n\tif (mask & (XCHAL_INTTYPE_MASK_EXTERN_EDGE |\n\t\t    XCHAL_INTTYPE_MASK_EXTERN_LEVEL)) {\n\t\tunsigned int ext_irq = xtensa_get_ext_irq_no(d->hwirq);\n\n\t\tif (ext_irq >= HW_IRQ_MX_BASE) {\n\t\t\tset_er(1u << (ext_irq - HW_IRQ_MX_BASE), MIENG);\n\t\t\treturn;\n\t\t}\n\t}\n\tmask = __this_cpu_read(cached_irq_mask) & ~mask;\n\t__this_cpu_write(cached_irq_mask, mask);\n\txtensa_set_sr(mask, intenable);\n}\n\nstatic void xtensa_mx_irq_unmask(struct irq_data *d)\n{\n\tunsigned int mask = 1u << d->hwirq;\n\n\tif (mask & (XCHAL_INTTYPE_MASK_EXTERN_EDGE |\n\t\t    XCHAL_INTTYPE_MASK_EXTERN_LEVEL)) {\n\t\tunsigned int ext_irq = xtensa_get_ext_irq_no(d->hwirq);\n\n\t\tif (ext_irq >= HW_IRQ_MX_BASE) {\n\t\t\tset_er(1u << (ext_irq - HW_IRQ_MX_BASE), MIENGSET);\n\t\t\treturn;\n\t\t}\n\t}\n\tmask |= __this_cpu_read(cached_irq_mask);\n\t__this_cpu_write(cached_irq_mask, mask);\n\txtensa_set_sr(mask, intenable);\n}\n\nstatic void xtensa_mx_irq_enable(struct irq_data *d)\n{\n\txtensa_mx_irq_unmask(d);\n}\n\nstatic void xtensa_mx_irq_disable(struct irq_data *d)\n{\n\txtensa_mx_irq_mask(d);\n}\n\nstatic void xtensa_mx_irq_ack(struct irq_data *d)\n{\n\txtensa_set_sr(1 << d->hwirq, intclear);\n}\n\nstatic int xtensa_mx_irq_retrigger(struct irq_data *d)\n{\n\tunsigned int mask = 1u << d->hwirq;\n\n\tif (WARN_ON(mask & ~XCHAL_INTTYPE_MASK_SOFTWARE))\n\t\treturn 0;\n\txtensa_set_sr(mask, intset);\n\treturn 1;\n}\n\nstatic int xtensa_mx_irq_set_affinity(struct irq_data *d,\n\t\tconst struct cpumask *dest, bool force)\n{\n\tint cpu = cpumask_any_and(dest, cpu_online_mask);\n\tunsigned mask = 1u << cpu;\n\n\tset_er(mask, MIROUT(d->hwirq - HW_IRQ_MX_BASE));\n\tirq_data_update_effective_affinity(d, cpumask_of(cpu));\n\n\treturn 0;\n\n}\n\nstatic struct irq_chip xtensa_mx_irq_chip = {\n\t.name\t\t= \"xtensa-mx\",\n\t.irq_enable\t= xtensa_mx_irq_enable,\n\t.irq_disable\t= xtensa_mx_irq_disable,\n\t.irq_mask\t= xtensa_mx_irq_mask,\n\t.irq_unmask\t= xtensa_mx_irq_unmask,\n\t.irq_ack\t= xtensa_mx_irq_ack,\n\t.irq_retrigger\t= xtensa_mx_irq_retrigger,\n\t.irq_set_affinity = xtensa_mx_irq_set_affinity,\n};\n\nstatic void __init xtensa_mx_init_common(struct irq_domain *root_domain)\n{\n\tunsigned int i;\n\n\tirq_set_default_host(root_domain);\n\tsecondary_init_irq();\n\n\t \n\tfor (i = 0; i < XCHAL_NUM_EXTINTERRUPTS; ++i)\n\t\tset_er(1, MIROUT(i));\n}\n\nint __init xtensa_mx_init_legacy(struct device_node *interrupt_parent)\n{\n\tstruct irq_domain *root_domain =\n\t\tirq_domain_add_legacy(NULL, NR_IRQS - 1, 1, 0,\n\t\t\t\t&xtensa_mx_irq_domain_ops,\n\t\t\t\t&xtensa_mx_irq_chip);\n\txtensa_mx_init_common(root_domain);\n\treturn 0;\n}\n\nstatic int __init xtensa_mx_init(struct device_node *np,\n\t\tstruct device_node *interrupt_parent)\n{\n\tstruct irq_domain *root_domain =\n\t\tirq_domain_add_linear(np, NR_IRQS, &xtensa_mx_irq_domain_ops,\n\t\t\t\t&xtensa_mx_irq_chip);\n\txtensa_mx_init_common(root_domain);\n\treturn 0;\n}\nIRQCHIP_DECLARE(xtensa_mx_irq_chip, \"cdns,xtensa-mx\", xtensa_mx_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}