{
  "module_name": "spear-shirq.c",
  "hash_id": "7baf589e9ede467c65409d3030151567806372afd43fc73a634dfda1d3bf4b32",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/spear-shirq.c",
  "human_readable_source": " \n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/err.h>\n#include <linux/export.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqdomain.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/spinlock.h>\n\n \nstruct spear_shirq {\n\tvoid __iomem\t\t*base;\n\tu32\t\t\tstatus_reg;\n\tu32\t\t\tmask_reg;\n\tu32\t\t\tmask;\n\tu32\t\t\tvirq_base;\n\tu32\t\t\tnr_irqs;\n\tu32\t\t\toffset;\n\tstruct irq_chip\t\t*irq_chip;\n};\n\n \n#define SPEAR300_INT_ENB_MASK_REG\t0x54\n#define SPEAR300_INT_STS_MASK_REG\t0x58\n\nstatic DEFINE_RAW_SPINLOCK(shirq_lock);\n\nstatic void shirq_irq_mask(struct irq_data *d)\n{\n\tstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\n\tu32 val, shift = d->irq - shirq->virq_base + shirq->offset;\n\tu32 __iomem *reg = shirq->base + shirq->mask_reg;\n\n\traw_spin_lock(&shirq_lock);\n\tval = readl(reg) & ~(0x1 << shift);\n\twritel(val, reg);\n\traw_spin_unlock(&shirq_lock);\n}\n\nstatic void shirq_irq_unmask(struct irq_data *d)\n{\n\tstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\n\tu32 val, shift = d->irq - shirq->virq_base + shirq->offset;\n\tu32 __iomem *reg = shirq->base + shirq->mask_reg;\n\n\traw_spin_lock(&shirq_lock);\n\tval = readl(reg) | (0x1 << shift);\n\twritel(val, reg);\n\traw_spin_unlock(&shirq_lock);\n}\n\nstatic struct irq_chip shirq_chip = {\n\t.name\t\t= \"spear-shirq\",\n\t.irq_mask\t= shirq_irq_mask,\n\t.irq_unmask\t= shirq_irq_unmask,\n};\n\nstatic struct spear_shirq spear300_shirq_ras1 = {\n\t.offset\t\t= 0,\n\t.nr_irqs\t= 9,\n\t.mask\t\t= ((0x1 << 9) - 1) << 0,\n\t.irq_chip\t= &shirq_chip,\n\t.status_reg\t= SPEAR300_INT_STS_MASK_REG,\n\t.mask_reg\t= SPEAR300_INT_ENB_MASK_REG,\n};\n\nstatic struct spear_shirq *spear300_shirq_blocks[] = {\n\t&spear300_shirq_ras1,\n};\n\n \n#define SPEAR310_INT_STS_MASK_REG\t0x04\n\nstatic struct spear_shirq spear310_shirq_ras1 = {\n\t.offset\t\t= 0,\n\t.nr_irqs\t= 8,\n\t.mask\t\t= ((0x1 << 8) - 1) << 0,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR310_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq spear310_shirq_ras2 = {\n\t.offset\t\t= 8,\n\t.nr_irqs\t= 5,\n\t.mask\t\t= ((0x1 << 5) - 1) << 8,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR310_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq spear310_shirq_ras3 = {\n\t.offset\t\t= 13,\n\t.nr_irqs\t= 1,\n\t.mask\t\t= ((0x1 << 1) - 1) << 13,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR310_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq spear310_shirq_intrcomm_ras = {\n\t.offset\t\t= 14,\n\t.nr_irqs\t= 3,\n\t.mask\t\t= ((0x1 << 3) - 1) << 14,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR310_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq *spear310_shirq_blocks[] = {\n\t&spear310_shirq_ras1,\n\t&spear310_shirq_ras2,\n\t&spear310_shirq_ras3,\n\t&spear310_shirq_intrcomm_ras,\n};\n\n \n#define SPEAR320_INT_STS_MASK_REG\t\t0x04\n#define SPEAR320_INT_CLR_MASK_REG\t\t0x04\n#define SPEAR320_INT_ENB_MASK_REG\t\t0x08\n\nstatic struct spear_shirq spear320_shirq_ras3 = {\n\t.offset\t\t= 0,\n\t.nr_irqs\t= 7,\n\t.mask\t\t= ((0x1 << 7) - 1) << 0,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR320_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq spear320_shirq_ras1 = {\n\t.offset\t\t= 7,\n\t.nr_irqs\t= 3,\n\t.mask\t\t= ((0x1 << 3) - 1) << 7,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR320_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq spear320_shirq_ras2 = {\n\t.offset\t\t= 10,\n\t.nr_irqs\t= 1,\n\t.mask\t\t= ((0x1 << 1) - 1) << 10,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR320_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq spear320_shirq_intrcomm_ras = {\n\t.offset\t\t= 11,\n\t.nr_irqs\t= 11,\n\t.mask\t\t= ((0x1 << 11) - 1) << 11,\n\t.irq_chip\t= &dummy_irq_chip,\n\t.status_reg\t= SPEAR320_INT_STS_MASK_REG,\n};\n\nstatic struct spear_shirq *spear320_shirq_blocks[] = {\n\t&spear320_shirq_ras3,\n\t&spear320_shirq_ras1,\n\t&spear320_shirq_ras2,\n\t&spear320_shirq_intrcomm_ras,\n};\n\nstatic void shirq_handler(struct irq_desc *desc)\n{\n\tstruct spear_shirq *shirq = irq_desc_get_handler_data(desc);\n\tu32 pend;\n\n\tpend = readl(shirq->base + shirq->status_reg) & shirq->mask;\n\tpend >>= shirq->offset;\n\n\twhile (pend) {\n\t\tint irq = __ffs(pend);\n\n\t\tpend &= ~(0x1 << irq);\n\t\tgeneric_handle_irq(shirq->virq_base + irq);\n\t}\n}\n\nstatic void __init spear_shirq_register(struct spear_shirq *shirq,\n\t\t\t\t\tint parent_irq)\n{\n\tint i;\n\n\tif (!shirq->irq_chip)\n\t\treturn;\n\n\tirq_set_chained_handler_and_data(parent_irq, shirq_handler, shirq);\n\n\tfor (i = 0; i < shirq->nr_irqs; i++) {\n\t\tirq_set_chip_and_handler(shirq->virq_base + i,\n\t\t\t\t\t shirq->irq_chip, handle_simple_irq);\n\t\tirq_set_chip_data(shirq->virq_base + i, shirq);\n\t}\n}\n\nstatic int __init shirq_init(struct spear_shirq **shirq_blocks, int block_nr,\n\t\tstruct device_node *np)\n{\n\tint i, parent_irq, virq_base, hwirq = 0, nr_irqs = 0;\n\tstruct irq_domain *shirq_domain;\n\tvoid __iomem *base;\n\n\tbase = of_iomap(np, 0);\n\tif (!base) {\n\t\tpr_err(\"%s: failed to map shirq registers\\n\", __func__);\n\t\treturn -ENXIO;\n\t}\n\n\tfor (i = 0; i < block_nr; i++)\n\t\tnr_irqs += shirq_blocks[i]->nr_irqs;\n\n\tvirq_base = irq_alloc_descs(-1, 0, nr_irqs, 0);\n\tif (virq_base < 0) {\n\t\tpr_err(\"%s: irq desc alloc failed\\n\", __func__);\n\t\tgoto err_unmap;\n\t}\n\n\tshirq_domain = irq_domain_add_legacy(np, nr_irqs, virq_base, 0,\n\t\t\t&irq_domain_simple_ops, NULL);\n\tif (WARN_ON(!shirq_domain)) {\n\t\tpr_warn(\"%s: irq domain init failed\\n\", __func__);\n\t\tgoto err_free_desc;\n\t}\n\n\tfor (i = 0; i < block_nr; i++) {\n\t\tshirq_blocks[i]->base = base;\n\t\tshirq_blocks[i]->virq_base = irq_find_mapping(shirq_domain,\n\t\t\t\thwirq);\n\n\t\tparent_irq = irq_of_parse_and_map(np, i);\n\t\tspear_shirq_register(shirq_blocks[i], parent_irq);\n\t\thwirq += shirq_blocks[i]->nr_irqs;\n\t}\n\n\treturn 0;\n\nerr_free_desc:\n\tirq_free_descs(virq_base, nr_irqs);\nerr_unmap:\n\tiounmap(base);\n\treturn -ENXIO;\n}\n\nstatic int __init spear300_shirq_of_init(struct device_node *np,\n\t\t\t\t\t struct device_node *parent)\n{\n\treturn shirq_init(spear300_shirq_blocks,\n\t\t\tARRAY_SIZE(spear300_shirq_blocks), np);\n}\nIRQCHIP_DECLARE(spear300_shirq, \"st,spear300-shirq\", spear300_shirq_of_init);\n\nstatic int __init spear310_shirq_of_init(struct device_node *np,\n\t\t\t\t\t struct device_node *parent)\n{\n\treturn shirq_init(spear310_shirq_blocks,\n\t\t\tARRAY_SIZE(spear310_shirq_blocks), np);\n}\nIRQCHIP_DECLARE(spear310_shirq, \"st,spear310-shirq\", spear310_shirq_of_init);\n\nstatic int __init spear320_shirq_of_init(struct device_node *np,\n\t\t\t\t\t struct device_node *parent)\n{\n\treturn shirq_init(spear320_shirq_blocks,\n\t\t\tARRAY_SIZE(spear320_shirq_blocks), np);\n}\nIRQCHIP_DECLARE(spear320_shirq, \"st,spear320-shirq\", spear320_shirq_of_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}