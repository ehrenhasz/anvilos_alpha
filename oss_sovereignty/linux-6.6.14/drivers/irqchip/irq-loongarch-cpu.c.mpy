{
  "module_name": "irq-loongarch-cpu.c",
  "hash_id": "8dbcaac3b2be06b7a1da8df2758a8b944129b20e8debb4d6d501ec0921392935",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-loongarch-cpu.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqdomain.h>\n\n#include <asm/loongarch.h>\n#include <asm/setup.h>\n\nstatic struct irq_domain *irq_domain;\nstruct fwnode_handle *cpuintc_handle;\n\nstatic u32 lpic_gsi_to_irq(u32 gsi)\n{\n\t \n\tif (gsi >= GSI_MIN_PCH_IRQ && gsi <= GSI_MAX_PCH_IRQ)\n\t\treturn acpi_register_gsi(NULL, gsi, ACPI_LEVEL_SENSITIVE, ACPI_ACTIVE_HIGH);\n\n\treturn 0;\n}\n\nstatic struct fwnode_handle *lpic_get_gsi_domain_id(u32 gsi)\n{\n\tint id;\n\tstruct fwnode_handle *domain_handle = NULL;\n\n\tswitch (gsi) {\n\tcase GSI_MIN_CPU_IRQ ... GSI_MAX_CPU_IRQ:\n\t\tif (liointc_handle)\n\t\t\tdomain_handle = liointc_handle;\n\t\tbreak;\n\n\tcase GSI_MIN_LPC_IRQ ... GSI_MAX_LPC_IRQ:\n\t\tif (pch_lpc_handle)\n\t\t\tdomain_handle = pch_lpc_handle;\n\t\tbreak;\n\n\tcase GSI_MIN_PCH_IRQ ... GSI_MAX_PCH_IRQ:\n\t\tid = find_pch_pic(gsi);\n\t\tif (id >= 0 && pch_pic_handle[id])\n\t\t\tdomain_handle = pch_pic_handle[id];\n\t\tbreak;\n\t}\n\n\treturn domain_handle;\n}\n\nstatic void mask_loongarch_irq(struct irq_data *d)\n{\n\tclear_csr_ecfg(ECFGF(d->hwirq));\n}\n\nstatic void unmask_loongarch_irq(struct irq_data *d)\n{\n\tset_csr_ecfg(ECFGF(d->hwirq));\n}\n\nstatic struct irq_chip cpu_irq_controller = {\n\t.name\t\t= \"CPUINTC\",\n\t.irq_mask\t= mask_loongarch_irq,\n\t.irq_unmask\t= unmask_loongarch_irq,\n};\n\nstatic void handle_cpu_irq(struct pt_regs *regs)\n{\n\tint hwirq;\n\tunsigned int estat = read_csr_estat() & CSR_ESTAT_IS;\n\n\twhile ((hwirq = ffs(estat))) {\n\t\testat &= ~BIT(hwirq - 1);\n\t\tgeneric_handle_domain_irq(irq_domain, hwirq - 1);\n\t}\n}\n\nstatic int loongarch_cpu_intc_map(struct irq_domain *d, unsigned int irq,\n\t\t\t     irq_hw_number_t hwirq)\n{\n\tirq_set_noprobe(irq);\n\tirq_set_chip_and_handler(irq, &cpu_irq_controller, handle_percpu_irq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops loongarch_cpu_intc_irq_domain_ops = {\n\t.map = loongarch_cpu_intc_map,\n\t.xlate = irq_domain_xlate_onecell,\n};\n\n#ifdef CONFIG_OF\nstatic int __init cpuintc_of_init(struct device_node *of_node,\n\t\t\t\tstruct device_node *parent)\n{\n\tcpuintc_handle = of_node_to_fwnode(of_node);\n\n\tirq_domain = irq_domain_create_linear(cpuintc_handle, EXCCODE_INT_NUM,\n\t\t\t\t&loongarch_cpu_intc_irq_domain_ops, NULL);\n\tif (!irq_domain)\n\t\tpanic(\"Failed to add irqdomain for loongarch CPU\");\n\n\tset_handle_irq(&handle_cpu_irq);\n\n\treturn 0;\n}\nIRQCHIP_DECLARE(cpu_intc, \"loongson,cpu-interrupt-controller\", cpuintc_of_init);\n#endif\n\nstatic int __init liointc_parse_madt(union acpi_subtable_headers *header,\n\t\t\t\t\tconst unsigned long end)\n{\n\tstruct acpi_madt_lio_pic *liointc_entry = (struct acpi_madt_lio_pic *)header;\n\n\treturn liointc_acpi_init(irq_domain, liointc_entry);\n}\n\nstatic int __init eiointc_parse_madt(union acpi_subtable_headers *header,\n\t\t\t\t\tconst unsigned long end)\n{\n\tstruct acpi_madt_eio_pic *eiointc_entry = (struct acpi_madt_eio_pic *)header;\n\n\treturn eiointc_acpi_init(irq_domain, eiointc_entry);\n}\n\nstatic int __init acpi_cascade_irqdomain_init(void)\n{\n\tint r;\n\n\tr = acpi_table_parse_madt(ACPI_MADT_TYPE_LIO_PIC, liointc_parse_madt, 0);\n\tif (r < 0)\n\t\treturn r;\n\n\tr = acpi_table_parse_madt(ACPI_MADT_TYPE_EIO_PIC, eiointc_parse_madt, 0);\n\tif (r < 0)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int __init cpuintc_acpi_init(union acpi_subtable_headers *header,\n\t\t\t\t   const unsigned long end)\n{\n\tint ret;\n\n\tif (irq_domain)\n\t\treturn 0;\n\n\t \n\tclear_csr_ecfg(ECFG0_IM);\n\tclear_csr_estat(ESTATF_IP);\n\n\tcpuintc_handle = irq_domain_alloc_named_fwnode(\"CPUINTC\");\n\tirq_domain = irq_domain_create_linear(cpuintc_handle, EXCCODE_INT_NUM,\n\t\t\t\t\t&loongarch_cpu_intc_irq_domain_ops, NULL);\n\n\tif (!irq_domain)\n\t\tpanic(\"Failed to add irqdomain for LoongArch CPU\");\n\n\tset_handle_irq(&handle_cpu_irq);\n\tacpi_set_irq_model(ACPI_IRQ_MODEL_LPIC, lpic_get_gsi_domain_id);\n\tacpi_set_gsi_to_irq_fallback(lpic_gsi_to_irq);\n\tret = acpi_cascade_irqdomain_init();\n\n\treturn ret;\n}\n\nIRQCHIP_ACPI_DECLARE(cpuintc_v1, ACPI_MADT_TYPE_CORE_PIC,\n\t\tNULL, ACPI_MADT_CORE_PIC_VERSION_V1, cpuintc_acpi_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}