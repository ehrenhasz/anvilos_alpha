{
  "module_name": "irq-aspeed-scu-ic.c",
  "hash_id": "543cf2ca4bd27face0c8c8ff9a1bcb5cc2b07d5d0a8faf549ae67b4485eb19fd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-aspeed-scu-ic.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqchip/chained_irq.h>\n#include <linux/irqdomain.h>\n#include <linux/mfd/syscon.h>\n#include <linux/of_irq.h>\n#include <linux/regmap.h>\n\n#define ASPEED_SCU_IC_REG\t\t0x018\n#define ASPEED_SCU_IC_SHIFT\t\t0\n#define ASPEED_SCU_IC_ENABLE\t\tGENMASK(15, ASPEED_SCU_IC_SHIFT)\n#define ASPEED_SCU_IC_NUM_IRQS\t\t7\n#define ASPEED_SCU_IC_STATUS\t\tGENMASK(28, 16)\n#define ASPEED_SCU_IC_STATUS_SHIFT\t16\n\n#define ASPEED_AST2600_SCU_IC0_REG\t0x560\n#define ASPEED_AST2600_SCU_IC0_SHIFT\t0\n#define ASPEED_AST2600_SCU_IC0_ENABLE\t\\\n\tGENMASK(5, ASPEED_AST2600_SCU_IC0_SHIFT)\n#define ASPEED_AST2600_SCU_IC0_NUM_IRQS\t6\n\n#define ASPEED_AST2600_SCU_IC1_REG\t0x570\n#define ASPEED_AST2600_SCU_IC1_SHIFT\t4\n#define ASPEED_AST2600_SCU_IC1_ENABLE\t\\\n\tGENMASK(5, ASPEED_AST2600_SCU_IC1_SHIFT)\n#define ASPEED_AST2600_SCU_IC1_NUM_IRQS\t2\n\nstruct aspeed_scu_ic {\n\tunsigned long irq_enable;\n\tunsigned long irq_shift;\n\tunsigned int num_irqs;\n\tunsigned int reg;\n\tstruct regmap *scu;\n\tstruct irq_domain *irq_domain;\n};\n\nstatic void aspeed_scu_ic_irq_handler(struct irq_desc *desc)\n{\n\tunsigned int sts;\n\tunsigned long bit;\n\tunsigned long enabled;\n\tunsigned long max;\n\tunsigned long status;\n\tstruct aspeed_scu_ic *scu_ic = irq_desc_get_handler_data(desc);\n\tstruct irq_chip *chip = irq_desc_get_chip(desc);\n\tunsigned int mask = scu_ic->irq_enable << ASPEED_SCU_IC_STATUS_SHIFT;\n\n\tchained_irq_enter(chip, desc);\n\n\t \n\tregmap_read(scu_ic->scu, scu_ic->reg, &sts);\n\tenabled = sts & scu_ic->irq_enable;\n\tstatus = (sts >> ASPEED_SCU_IC_STATUS_SHIFT) & enabled;\n\n\tbit = scu_ic->irq_shift;\n\tmax = scu_ic->num_irqs + bit;\n\n\tfor_each_set_bit_from(bit, &status, max) {\n\t\tgeneric_handle_domain_irq(scu_ic->irq_domain,\n\t\t\t\t\t  bit - scu_ic->irq_shift);\n\n\t\tregmap_write_bits(scu_ic->scu, scu_ic->reg, mask,\n\t\t\t\t  BIT(bit + ASPEED_SCU_IC_STATUS_SHIFT));\n\t}\n\n\tchained_irq_exit(chip, desc);\n}\n\nstatic void aspeed_scu_ic_irq_mask(struct irq_data *data)\n{\n\tstruct aspeed_scu_ic *scu_ic = irq_data_get_irq_chip_data(data);\n\tunsigned int mask = BIT(data->hwirq + scu_ic->irq_shift) |\n\t\t(scu_ic->irq_enable << ASPEED_SCU_IC_STATUS_SHIFT);\n\n\t \n\tregmap_update_bits(scu_ic->scu, scu_ic->reg, mask, 0);\n}\n\nstatic void aspeed_scu_ic_irq_unmask(struct irq_data *data)\n{\n\tstruct aspeed_scu_ic *scu_ic = irq_data_get_irq_chip_data(data);\n\tunsigned int bit = BIT(data->hwirq + scu_ic->irq_shift);\n\tunsigned int mask = bit |\n\t\t(scu_ic->irq_enable << ASPEED_SCU_IC_STATUS_SHIFT);\n\n\t \n\tregmap_update_bits(scu_ic->scu, scu_ic->reg, mask, bit);\n}\n\nstatic int aspeed_scu_ic_irq_set_affinity(struct irq_data *data,\n\t\t\t\t\t  const struct cpumask *dest,\n\t\t\t\t\t  bool force)\n{\n\treturn -EINVAL;\n}\n\nstatic struct irq_chip aspeed_scu_ic_chip = {\n\t.name\t\t\t= \"aspeed-scu-ic\",\n\t.irq_mask\t\t= aspeed_scu_ic_irq_mask,\n\t.irq_unmask\t\t= aspeed_scu_ic_irq_unmask,\n\t.irq_set_affinity\t= aspeed_scu_ic_irq_set_affinity,\n};\n\nstatic int aspeed_scu_ic_map(struct irq_domain *domain, unsigned int irq,\n\t\t\t     irq_hw_number_t hwirq)\n{\n\tirq_set_chip_and_handler(irq, &aspeed_scu_ic_chip, handle_level_irq);\n\tirq_set_chip_data(irq, domain->host_data);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops aspeed_scu_ic_domain_ops = {\n\t.map = aspeed_scu_ic_map,\n};\n\nstatic int aspeed_scu_ic_of_init_common(struct aspeed_scu_ic *scu_ic,\n\t\t\t\t\tstruct device_node *node)\n{\n\tint irq;\n\tint rc = 0;\n\n\tif (!node->parent) {\n\t\trc = -ENODEV;\n\t\tgoto err;\n\t}\n\n\tscu_ic->scu = syscon_node_to_regmap(node->parent);\n\tif (IS_ERR(scu_ic->scu)) {\n\t\trc = PTR_ERR(scu_ic->scu);\n\t\tgoto err;\n\t}\n\tregmap_write_bits(scu_ic->scu, scu_ic->reg, ASPEED_SCU_IC_STATUS, ASPEED_SCU_IC_STATUS);\n\tregmap_write_bits(scu_ic->scu, scu_ic->reg, ASPEED_SCU_IC_ENABLE, 0);\n\n\tirq = irq_of_parse_and_map(node, 0);\n\tif (!irq) {\n\t\trc = -EINVAL;\n\t\tgoto err;\n\t}\n\n\tscu_ic->irq_domain = irq_domain_add_linear(node, scu_ic->num_irqs,\n\t\t\t\t\t\t   &aspeed_scu_ic_domain_ops,\n\t\t\t\t\t\t   scu_ic);\n\tif (!scu_ic->irq_domain) {\n\t\trc = -ENOMEM;\n\t\tgoto err;\n\t}\n\n\tirq_set_chained_handler_and_data(irq, aspeed_scu_ic_irq_handler,\n\t\t\t\t\t scu_ic);\n\n\treturn 0;\n\nerr:\n\tkfree(scu_ic);\n\n\treturn rc;\n}\n\nstatic int __init aspeed_scu_ic_of_init(struct device_node *node,\n\t\t\t\t\tstruct device_node *parent)\n{\n\tstruct aspeed_scu_ic *scu_ic = kzalloc(sizeof(*scu_ic), GFP_KERNEL);\n\n\tif (!scu_ic)\n\t\treturn -ENOMEM;\n\n\tscu_ic->irq_enable = ASPEED_SCU_IC_ENABLE;\n\tscu_ic->irq_shift = ASPEED_SCU_IC_SHIFT;\n\tscu_ic->num_irqs = ASPEED_SCU_IC_NUM_IRQS;\n\tscu_ic->reg = ASPEED_SCU_IC_REG;\n\n\treturn aspeed_scu_ic_of_init_common(scu_ic, node);\n}\n\nstatic int __init aspeed_ast2600_scu_ic0_of_init(struct device_node *node,\n\t\t\t\t\t\t struct device_node *parent)\n{\n\tstruct aspeed_scu_ic *scu_ic = kzalloc(sizeof(*scu_ic), GFP_KERNEL);\n\n\tif (!scu_ic)\n\t\treturn -ENOMEM;\n\n\tscu_ic->irq_enable = ASPEED_AST2600_SCU_IC0_ENABLE;\n\tscu_ic->irq_shift = ASPEED_AST2600_SCU_IC0_SHIFT;\n\tscu_ic->num_irqs = ASPEED_AST2600_SCU_IC0_NUM_IRQS;\n\tscu_ic->reg = ASPEED_AST2600_SCU_IC0_REG;\n\n\treturn aspeed_scu_ic_of_init_common(scu_ic, node);\n}\n\nstatic int __init aspeed_ast2600_scu_ic1_of_init(struct device_node *node,\n\t\t\t\t\t\t struct device_node *parent)\n{\n\tstruct aspeed_scu_ic *scu_ic = kzalloc(sizeof(*scu_ic), GFP_KERNEL);\n\n\tif (!scu_ic)\n\t\treturn -ENOMEM;\n\n\tscu_ic->irq_enable = ASPEED_AST2600_SCU_IC1_ENABLE;\n\tscu_ic->irq_shift = ASPEED_AST2600_SCU_IC1_SHIFT;\n\tscu_ic->num_irqs = ASPEED_AST2600_SCU_IC1_NUM_IRQS;\n\tscu_ic->reg = ASPEED_AST2600_SCU_IC1_REG;\n\n\treturn aspeed_scu_ic_of_init_common(scu_ic, node);\n}\n\nIRQCHIP_DECLARE(ast2400_scu_ic, \"aspeed,ast2400-scu-ic\", aspeed_scu_ic_of_init);\nIRQCHIP_DECLARE(ast2500_scu_ic, \"aspeed,ast2500-scu-ic\", aspeed_scu_ic_of_init);\nIRQCHIP_DECLARE(ast2600_scu_ic0, \"aspeed,ast2600-scu-ic0\",\n\t\taspeed_ast2600_scu_ic0_of_init);\nIRQCHIP_DECLARE(ast2600_scu_ic1, \"aspeed,ast2600-scu-ic1\",\n\t\taspeed_ast2600_scu_ic1_of_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}