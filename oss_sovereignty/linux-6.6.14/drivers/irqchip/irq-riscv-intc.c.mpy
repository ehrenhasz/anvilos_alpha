{
  "module_name": "irq-riscv-intc.c",
  "hash_id": "f60f45703e5ea9db51fb03958ab90fd26b770f09c2169533781fdb685c600ef8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-riscv-intc.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) \"riscv-intc: \" fmt\n#include <linux/acpi.h>\n#include <linux/atomic.h>\n#include <linux/bits.h>\n#include <linux/cpu.h>\n#include <linux/irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqdomain.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/smp.h>\n\nstatic struct irq_domain *intc_domain;\n\nstatic asmlinkage void riscv_intc_irq(struct pt_regs *regs)\n{\n\tunsigned long cause = regs->cause & ~CAUSE_IRQ_FLAG;\n\n\tif (unlikely(cause >= BITS_PER_LONG))\n\t\tpanic(\"unexpected interrupt cause\");\n\n\tgeneric_handle_domain_irq(intc_domain, cause);\n}\n\n \n\nstatic void riscv_intc_irq_mask(struct irq_data *d)\n{\n\tcsr_clear(CSR_IE, BIT(d->hwirq));\n}\n\nstatic void riscv_intc_irq_unmask(struct irq_data *d)\n{\n\tcsr_set(CSR_IE, BIT(d->hwirq));\n}\n\nstatic void riscv_intc_irq_eoi(struct irq_data *d)\n{\n\t \n}\n\nstatic struct irq_chip riscv_intc_chip = {\n\t.name = \"RISC-V INTC\",\n\t.irq_mask = riscv_intc_irq_mask,\n\t.irq_unmask = riscv_intc_irq_unmask,\n\t.irq_eoi = riscv_intc_irq_eoi,\n};\n\nstatic int riscv_intc_domain_map(struct irq_domain *d, unsigned int irq,\n\t\t\t\t irq_hw_number_t hwirq)\n{\n\tirq_set_percpu_devid(irq);\n\tirq_domain_set_info(d, irq, hwirq, &riscv_intc_chip, d->host_data,\n\t\t\t    handle_percpu_devid_irq, NULL, NULL);\n\n\treturn 0;\n}\n\nstatic int riscv_intc_domain_alloc(struct irq_domain *domain,\n\t\t\t\t   unsigned int virq, unsigned int nr_irqs,\n\t\t\t\t   void *arg)\n{\n\tint i, ret;\n\tirq_hw_number_t hwirq;\n\tunsigned int type = IRQ_TYPE_NONE;\n\tstruct irq_fwspec *fwspec = arg;\n\n\tret = irq_domain_translate_onecell(domain, fwspec, &hwirq, &type);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < nr_irqs; i++) {\n\t\tret = riscv_intc_domain_map(domain, virq + i, hwirq + i);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops riscv_intc_domain_ops = {\n\t.map\t= riscv_intc_domain_map,\n\t.xlate\t= irq_domain_xlate_onecell,\n\t.alloc\t= riscv_intc_domain_alloc\n};\n\nstatic struct fwnode_handle *riscv_intc_hwnode(void)\n{\n\treturn intc_domain->fwnode;\n}\n\nstatic int __init riscv_intc_init_common(struct fwnode_handle *fn)\n{\n\tint rc;\n\n\tintc_domain = irq_domain_create_linear(fn, BITS_PER_LONG,\n\t\t\t\t\t       &riscv_intc_domain_ops, NULL);\n\tif (!intc_domain) {\n\t\tpr_err(\"unable to add IRQ domain\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\trc = set_handle_irq(&riscv_intc_irq);\n\tif (rc) {\n\t\tpr_err(\"failed to set irq handler\\n\");\n\t\treturn rc;\n\t}\n\n\triscv_set_intc_hwnode_fn(riscv_intc_hwnode);\n\n\tpr_info(\"%d local interrupts mapped\\n\", BITS_PER_LONG);\n\n\treturn 0;\n}\n\nstatic int __init riscv_intc_init(struct device_node *node,\n\t\t\t\t  struct device_node *parent)\n{\n\tint rc;\n\tunsigned long hartid;\n\n\trc = riscv_of_parent_hartid(node, &hartid);\n\tif (rc < 0) {\n\t\tpr_warn(\"unable to find hart id for %pOF\\n\", node);\n\t\treturn 0;\n\t}\n\n\t \n\tif (riscv_hartid_to_cpuid(hartid) != smp_processor_id()) {\n\t\t \n\t\tfwnode_dev_initialized(of_fwnode_handle(node), true);\n\t\treturn 0;\n\t}\n\n\treturn riscv_intc_init_common(of_node_to_fwnode(node));\n}\n\nIRQCHIP_DECLARE(riscv, \"riscv,cpu-intc\", riscv_intc_init);\n\n#ifdef CONFIG_ACPI\n\nstatic int __init riscv_intc_acpi_init(union acpi_subtable_headers *header,\n\t\t\t\t       const unsigned long end)\n{\n\tstruct fwnode_handle *fn;\n\tstruct acpi_madt_rintc *rintc;\n\n\trintc = (struct acpi_madt_rintc *)header;\n\n\t \n\tif (riscv_hartid_to_cpuid(rintc->hart_id) != smp_processor_id())\n\t\treturn 0;\n\n\tfn = irq_domain_alloc_named_fwnode(\"RISCV-INTC\");\n\tif (!fn) {\n\t\tpr_err(\"unable to allocate INTC FW node\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\treturn riscv_intc_init_common(fn);\n}\n\nIRQCHIP_ACPI_DECLARE(riscv_intc, ACPI_MADT_TYPE_RINTC, NULL,\n\t\t     ACPI_MADT_RINTC_VERSION_V1, riscv_intc_acpi_init);\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}