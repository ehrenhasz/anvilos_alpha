{
  "module_name": "irq-loongson-htpic.c",
  "hash_id": "d37416c37ef3862ad69857a8ebdde54da3868cc9582c8d66c6075ff62096a3eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/irqchip/irq-loongson-htpic.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/irqchip.h>\n#include <linux/irqchip/chained_irq.h>\n#include <linux/irq.h>\n#include <linux/io.h>\n#include <linux/syscore_ops.h>\n\n#include <asm/i8259.h>\n\n#define HTPIC_MAX_PARENT_IRQ\t4\n#define HTINT_NUM_VECTORS\t8\n#define HTINT_EN_OFF\t\t0x20\n\nstruct loongson_htpic {\n\tvoid __iomem *base;\n\tstruct irq_domain *domain;\n};\n\nstatic struct loongson_htpic *htpic;\n\nstatic void htpic_irq_dispatch(struct irq_desc *desc)\n{\n\tstruct loongson_htpic *priv = irq_desc_get_handler_data(desc);\n\tstruct irq_chip *chip = irq_desc_get_chip(desc);\n\tuint32_t pending;\n\n\tchained_irq_enter(chip, desc);\n\tpending = readl(priv->base);\n\t \n\twritel(pending, priv->base);\n\n\tif (!pending)\n\t\tspurious_interrupt();\n\n\twhile (pending) {\n\t\tint bit = __ffs(pending);\n\n\t\tif (unlikely(bit > 15)) {\n\t\t\tspurious_interrupt();\n\t\t\tbreak;\n\t\t}\n\n\t\tgeneric_handle_domain_irq(priv->domain, bit);\n\t\tpending &= ~BIT(bit);\n\t}\n\tchained_irq_exit(chip, desc);\n}\n\nstatic void htpic_reg_init(void)\n{\n\tint i;\n\n\tfor (i = 0; i < HTINT_NUM_VECTORS; i++) {\n\t\t \n\t\twritel(0x0, htpic->base + HTINT_EN_OFF + i * 0x4);\n\t\t \n\t\t(void) readl(htpic->base + i * 0x4);\n\t\t \n\t\twritel(GENMASK(31, 0), htpic->base + i * 0x4);\n\t}\n\n\t \n\twritel(0xffff, htpic->base + HTINT_EN_OFF);\n}\n\nstatic void htpic_resume(void)\n{\n\thtpic_reg_init();\n}\n\nstruct syscore_ops htpic_syscore_ops = {\n\t.resume\t\t= htpic_resume,\n};\n\nstatic int __init htpic_of_init(struct device_node *node, struct device_node *parent)\n{\n\tunsigned int parent_irq[4];\n\tint i, err;\n\tint num_parents = 0;\n\n\tif (htpic) {\n\t\tpr_err(\"loongson-htpic: Only one HTPIC is allowed in the system\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\thtpic = kzalloc(sizeof(*htpic), GFP_KERNEL);\n\tif (!htpic)\n\t\treturn -ENOMEM;\n\n\thtpic->base = of_iomap(node, 0);\n\tif (!htpic->base) {\n\t\terr = -ENODEV;\n\t\tgoto out_free;\n\t}\n\n\thtpic->domain = __init_i8259_irqs(node);\n\tif (!htpic->domain) {\n\t\tpr_err(\"loongson-htpic: Failed to initialize i8259 IRQs\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto out_iounmap;\n\t}\n\n\t \n\tfor (i = 0; i < HTPIC_MAX_PARENT_IRQ; i++) {\n\t\tparent_irq[i] = irq_of_parse_and_map(node, i);\n\t\tif (parent_irq[i] <= 0)\n\t\t\tbreak;\n\n\t\tnum_parents++;\n\t}\n\n\tif (!num_parents) {\n\t\tpr_err(\"loongson-htpic: Failed to get parent irqs\\n\");\n\t\terr = -ENODEV;\n\t\tgoto out_remove_domain;\n\t}\n\n\thtpic_reg_init();\n\n\tfor (i = 0; i < num_parents; i++) {\n\t\tirq_set_chained_handler_and_data(parent_irq[i],\n\t\t\t\t\t\thtpic_irq_dispatch, htpic);\n\t}\n\n\tregister_syscore_ops(&htpic_syscore_ops);\n\n\treturn 0;\n\nout_remove_domain:\n\tirq_domain_remove(htpic->domain);\nout_iounmap:\n\tiounmap(htpic->base);\nout_free:\n\tkfree(htpic);\n\treturn err;\n}\n\nIRQCHIP_DECLARE(loongson_htpic, \"loongson,htpic-1.0\", htpic_of_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}