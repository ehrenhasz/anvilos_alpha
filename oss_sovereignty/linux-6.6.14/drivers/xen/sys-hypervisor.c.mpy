{
  "module_name": "sys-hypervisor.c",
  "hash_id": "12111e063cf5a6e8f70282377f58c1461bbb36b1e894931eb69bb2d6b33d11cb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/xen/sys-hypervisor.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/kobject.h>\n#include <linux/err.h>\n\n#include <asm/xen/hypervisor.h>\n#include <asm/xen/hypercall.h>\n\n#include <xen/xen.h>\n#include <xen/xenbus.h>\n#include <xen/interface/xen.h>\n#include <xen/interface/version.h>\n#ifdef CONFIG_XEN_HAVE_VPMU\n#include <xen/interface/xenpmu.h>\n#endif\n\n#define HYPERVISOR_ATTR_RO(_name) \\\nstatic struct hyp_sysfs_attr _name##_attr = __ATTR_RO(_name)\n\n#define HYPERVISOR_ATTR_RW(_name) \\\nstatic struct hyp_sysfs_attr _name##_attr = __ATTR_RW(_name)\n\nstruct hyp_sysfs_attr {\n\tstruct attribute attr;\n\tssize_t (*show)(struct hyp_sysfs_attr *, char *);\n\tssize_t (*store)(struct hyp_sysfs_attr *, const char *, size_t);\n\tunion {\n\t\tvoid *hyp_attr_data;\n\t\tunsigned long hyp_attr_value;\n\t};\n};\n\nstatic ssize_t type_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\treturn sprintf(buffer, \"xen\\n\");\n}\n\nHYPERVISOR_ATTR_RO(type);\n\nstatic int __init xen_sysfs_type_init(void)\n{\n\treturn sysfs_create_file(hypervisor_kobj, &type_attr.attr);\n}\n\nstatic ssize_t guest_type_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tconst char *type;\n\n\tswitch (xen_domain_type) {\n\tcase XEN_NATIVE:\n\t\t \n\t\ttype = \"Xen\";\n\t\tbreak;\n\tcase XEN_PV_DOMAIN:\n\t\ttype = \"PV\";\n\t\tbreak;\n\tcase XEN_HVM_DOMAIN:\n\t\ttype = xen_pvh_domain() ? \"PVH\" : \"HVM\";\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn sprintf(buffer, \"%s\\n\", type);\n}\n\nHYPERVISOR_ATTR_RO(guest_type);\n\nstatic int __init xen_sysfs_guest_type_init(void)\n{\n\treturn sysfs_create_file(hypervisor_kobj, &guest_type_attr.attr);\n}\n\n \nstatic ssize_t major_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint version = HYPERVISOR_xen_version(XENVER_version, NULL);\n\tif (version)\n\t\treturn sprintf(buffer, \"%d\\n\", version >> 16);\n\treturn -ENODEV;\n}\n\nHYPERVISOR_ATTR_RO(major);\n\nstatic ssize_t minor_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint version = HYPERVISOR_xen_version(XENVER_version, NULL);\n\tif (version)\n\t\treturn sprintf(buffer, \"%d\\n\", version & 0xff);\n\treturn -ENODEV;\n}\n\nHYPERVISOR_ATTR_RO(minor);\n\nstatic ssize_t extra_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tchar *extra;\n\n\textra = kmalloc(XEN_EXTRAVERSION_LEN, GFP_KERNEL);\n\tif (extra) {\n\t\tret = HYPERVISOR_xen_version(XENVER_extraversion, extra);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%s\\n\", extra);\n\t\tkfree(extra);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(extra);\n\nstatic struct attribute *version_attrs[] = {\n\t&major_attr.attr,\n\t&minor_attr.attr,\n\t&extra_attr.attr,\n\tNULL\n};\n\nstatic const struct attribute_group version_group = {\n\t.name = \"version\",\n\t.attrs = version_attrs,\n};\n\nstatic int __init xen_sysfs_version_init(void)\n{\n\treturn sysfs_create_group(hypervisor_kobj, &version_group);\n}\n\n \n\nstatic ssize_t uuid_show_fallback(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tchar *vm, *val;\n\tint ret;\n\textern int xenstored_ready;\n\n\tif (!xenstored_ready)\n\t\treturn -EBUSY;\n\n\tvm = xenbus_read(XBT_NIL, \"vm\", \"\", NULL);\n\tif (IS_ERR(vm))\n\t\treturn PTR_ERR(vm);\n\tval = xenbus_read(XBT_NIL, vm, \"uuid\", NULL);\n\tkfree(vm);\n\tif (IS_ERR(val))\n\t\treturn PTR_ERR(val);\n\tret = sprintf(buffer, \"%s\\n\", val);\n\tkfree(val);\n\treturn ret;\n}\n\nstatic ssize_t uuid_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\txen_domain_handle_t uuid;\n\tint ret;\n\tret = HYPERVISOR_xen_version(XENVER_guest_handle, uuid);\n\tif (ret)\n\t\treturn uuid_show_fallback(attr, buffer);\n\tret = sprintf(buffer, \"%pU\\n\", uuid);\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(uuid);\n\nstatic int __init xen_sysfs_uuid_init(void)\n{\n\treturn sysfs_create_file(hypervisor_kobj, &uuid_attr.attr);\n}\n\n \n\nstatic ssize_t compiler_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tstruct xen_compile_info *info;\n\n\tinfo = kmalloc(sizeof(struct xen_compile_info), GFP_KERNEL);\n\tif (info) {\n\t\tret = HYPERVISOR_xen_version(XENVER_compile_info, info);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%s\\n\", info->compiler);\n\t\tkfree(info);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(compiler);\n\nstatic ssize_t compiled_by_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tstruct xen_compile_info *info;\n\n\tinfo = kmalloc(sizeof(struct xen_compile_info), GFP_KERNEL);\n\tif (info) {\n\t\tret = HYPERVISOR_xen_version(XENVER_compile_info, info);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%s\\n\", info->compile_by);\n\t\tkfree(info);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(compiled_by);\n\nstatic ssize_t compile_date_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tstruct xen_compile_info *info;\n\n\tinfo = kmalloc(sizeof(struct xen_compile_info), GFP_KERNEL);\n\tif (info) {\n\t\tret = HYPERVISOR_xen_version(XENVER_compile_info, info);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%s\\n\", info->compile_date);\n\t\tkfree(info);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(compile_date);\n\nstatic struct attribute *xen_compile_attrs[] = {\n\t&compiler_attr.attr,\n\t&compiled_by_attr.attr,\n\t&compile_date_attr.attr,\n\tNULL\n};\n\nstatic const struct attribute_group xen_compilation_group = {\n\t.name = \"compilation\",\n\t.attrs = xen_compile_attrs,\n};\n\nstatic int __init xen_sysfs_compilation_init(void)\n{\n\treturn sysfs_create_group(hypervisor_kobj, &xen_compilation_group);\n}\n\n \n\nstatic ssize_t capabilities_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tchar *caps;\n\n\tcaps = kmalloc(XEN_CAPABILITIES_INFO_LEN, GFP_KERNEL);\n\tif (caps) {\n\t\tret = HYPERVISOR_xen_version(XENVER_capabilities, caps);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%s\\n\", caps);\n\t\tkfree(caps);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(capabilities);\n\nstatic ssize_t changeset_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tchar *cset;\n\n\tcset = kmalloc(XEN_CHANGESET_INFO_LEN, GFP_KERNEL);\n\tif (cset) {\n\t\tret = HYPERVISOR_xen_version(XENVER_changeset, cset);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%s\\n\", cset);\n\t\tkfree(cset);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(changeset);\n\nstatic ssize_t virtual_start_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret = -ENOMEM;\n\tstruct xen_platform_parameters *parms;\n\n\tparms = kmalloc(sizeof(struct xen_platform_parameters), GFP_KERNEL);\n\tif (parms) {\n\t\tret = HYPERVISOR_xen_version(XENVER_platform_parameters,\n\t\t\t\t\t     parms);\n\t\tif (!ret)\n\t\t\tret = sprintf(buffer, \"%\"PRI_xen_ulong\"\\n\",\n\t\t\t\t      parms->virt_start);\n\t\tkfree(parms);\n\t}\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(virtual_start);\n\nstatic ssize_t pagesize_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret;\n\n\tret = HYPERVISOR_xen_version(XENVER_pagesize, NULL);\n\tif (ret > 0)\n\t\tret = sprintf(buffer, \"%x\\n\", ret);\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(pagesize);\n\nstatic ssize_t xen_feature_show(int index, char *buffer)\n{\n\tssize_t ret;\n\tstruct xen_feature_info info;\n\n\tinfo.submap_idx = index;\n\tret = HYPERVISOR_xen_version(XENVER_get_features, &info);\n\tif (!ret)\n\t\tret = sprintf(buffer, \"%08x\", info.submap);\n\n\treturn ret;\n}\n\nstatic ssize_t features_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tssize_t len;\n\tint i;\n\n\tlen = 0;\n\tfor (i = XENFEAT_NR_SUBMAPS-1; i >= 0; i--) {\n\t\tint ret = xen_feature_show(i, buffer + len);\n\t\tif (ret < 0) {\n\t\t\tif (len == 0)\n\t\t\t\tlen = ret;\n\t\t\tbreak;\n\t\t}\n\t\tlen += ret;\n\t}\n\tif (len > 0)\n\t\tbuffer[len++] = '\\n';\n\n\treturn len;\n}\n\nHYPERVISOR_ATTR_RO(features);\n\nstatic ssize_t buildid_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tssize_t ret;\n\tstruct xen_build_id *buildid;\n\n\tret = HYPERVISOR_xen_version(XENVER_build_id, NULL);\n\tif (ret < 0) {\n\t\tif (ret == -EPERM)\n\t\t\tret = sprintf(buffer, \"<denied>\");\n\t\treturn ret;\n\t}\n\n\tbuildid = kmalloc(sizeof(*buildid) + ret, GFP_KERNEL);\n\tif (!buildid)\n\t\treturn -ENOMEM;\n\n\tbuildid->len = ret;\n\tret = HYPERVISOR_xen_version(XENVER_build_id, buildid);\n\tif (ret > 0)\n\t\tret = sprintf(buffer, \"%s\", buildid->buf);\n\tkfree(buildid);\n\n\treturn ret;\n}\n\nHYPERVISOR_ATTR_RO(buildid);\n\nstatic struct attribute *xen_properties_attrs[] = {\n\t&capabilities_attr.attr,\n\t&changeset_attr.attr,\n\t&virtual_start_attr.attr,\n\t&pagesize_attr.attr,\n\t&features_attr.attr,\n\t&buildid_attr.attr,\n\tNULL\n};\n\nstatic const struct attribute_group xen_properties_group = {\n\t.name = \"properties\",\n\t.attrs = xen_properties_attrs,\n};\n\nstatic int __init xen_sysfs_properties_init(void)\n{\n\treturn sysfs_create_group(hypervisor_kobj, &xen_properties_group);\n}\n\n#define FLAG_UNAME \"unknown\"\n#define FLAG_UNAME_FMT FLAG_UNAME \"%02u\"\n#define FLAG_UNAME_MAX sizeof(FLAG_UNAME \"XX\")\n#define FLAG_COUNT (sizeof(xen_start_flags) * BITS_PER_BYTE)\nstatic_assert(sizeof(xen_start_flags) <=\n\t      sizeof_field(struct hyp_sysfs_attr, hyp_attr_value));\n\nstatic ssize_t flag_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tchar *p = buffer;\n\n\t*p++ = '0' + ((xen_start_flags & attr->hyp_attr_value) != 0);\n\t*p++ = '\\n';\n\treturn p - buffer;\n}\n\n#define FLAG_NODE(flag, node)\t\t\t\t\\\n\t[ilog2(flag)] = {\t\t\t\t\\\n\t\t.attr = { .name = #node, .mode = 0444 },\\\n\t\t.show = flag_show,\t\t\t\\\n\t\t.hyp_attr_value = flag\t\t\t\\\n\t}\n\n \nstatic struct hyp_sysfs_attr flag_attrs[FLAG_COUNT] = {\n\tFLAG_NODE(SIF_PRIVILEGED, privileged),\n\tFLAG_NODE(SIF_INITDOMAIN, initdomain)\n};\nstatic struct attribute_group xen_flags_group = {\n\t.name = \"start_flags\",\n\t.attrs = (struct attribute *[FLAG_COUNT + 1]){}\n};\nstatic char flag_unames[FLAG_COUNT][FLAG_UNAME_MAX];\n\nstatic int __init xen_sysfs_flags_init(void)\n{\n\tfor (unsigned fnum = 0; fnum != FLAG_COUNT; fnum++) {\n\t\tif (likely(flag_attrs[fnum].attr.name == NULL)) {\n\t\t\tsprintf(flag_unames[fnum], FLAG_UNAME_FMT, fnum);\n\t\t\tflag_attrs[fnum].attr.name = flag_unames[fnum];\n\t\t\tflag_attrs[fnum].attr.mode = 0444;\n\t\t\tflag_attrs[fnum].show = flag_show;\n\t\t\tflag_attrs[fnum].hyp_attr_value = 1 << fnum;\n\t\t}\n\t\txen_flags_group.attrs[fnum] = &flag_attrs[fnum].attr;\n\t}\n\treturn sysfs_create_group(hypervisor_kobj, &xen_flags_group);\n}\n\n#ifdef CONFIG_XEN_HAVE_VPMU\nstruct pmu_mode {\n\tconst char *name;\n\tuint32_t mode;\n};\n\nstatic struct pmu_mode pmu_modes[] = {\n\t{\"off\", XENPMU_MODE_OFF},\n\t{\"self\", XENPMU_MODE_SELF},\n\t{\"hv\", XENPMU_MODE_HV},\n\t{\"all\", XENPMU_MODE_ALL}\n};\n\nstatic ssize_t pmu_mode_store(struct hyp_sysfs_attr *attr,\n\t\t\t      const char *buffer, size_t len)\n{\n\tint ret;\n\tstruct xen_pmu_params xp;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(pmu_modes); i++) {\n\t\tif (strncmp(buffer, pmu_modes[i].name, len - 1) == 0) {\n\t\t\txp.val = pmu_modes[i].mode;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (i == ARRAY_SIZE(pmu_modes))\n\t\treturn -EINVAL;\n\n\txp.version.maj = XENPMU_VER_MAJ;\n\txp.version.min = XENPMU_VER_MIN;\n\tret = HYPERVISOR_xenpmu_op(XENPMU_mode_set, &xp);\n\tif (ret)\n\t\treturn ret;\n\n\treturn len;\n}\n\nstatic ssize_t pmu_mode_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret;\n\tstruct xen_pmu_params xp;\n\tint i;\n\tuint32_t mode;\n\n\txp.version.maj = XENPMU_VER_MAJ;\n\txp.version.min = XENPMU_VER_MIN;\n\tret = HYPERVISOR_xenpmu_op(XENPMU_mode_get, &xp);\n\tif (ret)\n\t\treturn ret;\n\n\tmode = (uint32_t)xp.val;\n\tfor (i = 0; i < ARRAY_SIZE(pmu_modes); i++) {\n\t\tif (mode == pmu_modes[i].mode)\n\t\t\treturn sprintf(buffer, \"%s\\n\", pmu_modes[i].name);\n\t}\n\n\treturn -EINVAL;\n}\nHYPERVISOR_ATTR_RW(pmu_mode);\n\nstatic ssize_t pmu_features_store(struct hyp_sysfs_attr *attr,\n\t\t\t\t  const char *buffer, size_t len)\n{\n\tint ret;\n\tuint32_t features;\n\tstruct xen_pmu_params xp;\n\n\tret = kstrtou32(buffer, 0, &features);\n\tif (ret)\n\t\treturn ret;\n\n\txp.val = features;\n\txp.version.maj = XENPMU_VER_MAJ;\n\txp.version.min = XENPMU_VER_MIN;\n\tret = HYPERVISOR_xenpmu_op(XENPMU_feature_set, &xp);\n\tif (ret)\n\t\treturn ret;\n\n\treturn len;\n}\n\nstatic ssize_t pmu_features_show(struct hyp_sysfs_attr *attr, char *buffer)\n{\n\tint ret;\n\tstruct xen_pmu_params xp;\n\n\txp.version.maj = XENPMU_VER_MAJ;\n\txp.version.min = XENPMU_VER_MIN;\n\tret = HYPERVISOR_xenpmu_op(XENPMU_feature_get, &xp);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sprintf(buffer, \"0x%x\\n\", (uint32_t)xp.val);\n}\nHYPERVISOR_ATTR_RW(pmu_features);\n\nstatic struct attribute *xen_pmu_attrs[] = {\n\t&pmu_mode_attr.attr,\n\t&pmu_features_attr.attr,\n\tNULL\n};\n\nstatic const struct attribute_group xen_pmu_group = {\n\t.name = \"pmu\",\n\t.attrs = xen_pmu_attrs,\n};\n\nstatic int __init xen_sysfs_pmu_init(void)\n{\n\treturn sysfs_create_group(hypervisor_kobj, &xen_pmu_group);\n}\n#endif\n\nstatic int __init hyper_sysfs_init(void)\n{\n\tint ret;\n\n\tif (!xen_domain())\n\t\treturn -ENODEV;\n\n\tret = xen_sysfs_type_init();\n\tif (ret)\n\t\tgoto out;\n\tret = xen_sysfs_guest_type_init();\n\tif (ret)\n\t\tgoto guest_type_out;\n\tret = xen_sysfs_version_init();\n\tif (ret)\n\t\tgoto version_out;\n\tret = xen_sysfs_compilation_init();\n\tif (ret)\n\t\tgoto comp_out;\n\tret = xen_sysfs_uuid_init();\n\tif (ret)\n\t\tgoto uuid_out;\n\tret = xen_sysfs_properties_init();\n\tif (ret)\n\t\tgoto prop_out;\n\tret = xen_sysfs_flags_init();\n\tif (ret)\n\t\tgoto flags_out;\n#ifdef CONFIG_XEN_HAVE_VPMU\n\tif (xen_initial_domain()) {\n\t\tret = xen_sysfs_pmu_init();\n\t\tif (ret) {\n\t\t\tsysfs_remove_group(hypervisor_kobj, &xen_flags_group);\n\t\t\tgoto flags_out;\n\t\t}\n\t}\n#endif\n\tgoto out;\n\nflags_out:\n\tsysfs_remove_group(hypervisor_kobj, &xen_properties_group);\nprop_out:\n\tsysfs_remove_file(hypervisor_kobj, &uuid_attr.attr);\nuuid_out:\n\tsysfs_remove_group(hypervisor_kobj, &xen_compilation_group);\ncomp_out:\n\tsysfs_remove_group(hypervisor_kobj, &version_group);\nversion_out:\n\tsysfs_remove_file(hypervisor_kobj, &guest_type_attr.attr);\nguest_type_out:\n\tsysfs_remove_file(hypervisor_kobj, &type_attr.attr);\nout:\n\treturn ret;\n}\ndevice_initcall(hyper_sysfs_init);\n\nstatic ssize_t hyp_sysfs_show(struct kobject *kobj,\n\t\t\t      struct attribute *attr,\n\t\t\t      char *buffer)\n{\n\tstruct hyp_sysfs_attr *hyp_attr;\n\thyp_attr = container_of(attr, struct hyp_sysfs_attr, attr);\n\tif (hyp_attr->show)\n\t\treturn hyp_attr->show(hyp_attr, buffer);\n\treturn 0;\n}\n\nstatic ssize_t hyp_sysfs_store(struct kobject *kobj,\n\t\t\t       struct attribute *attr,\n\t\t\t       const char *buffer,\n\t\t\t       size_t len)\n{\n\tstruct hyp_sysfs_attr *hyp_attr;\n\thyp_attr = container_of(attr, struct hyp_sysfs_attr, attr);\n\tif (hyp_attr->store)\n\t\treturn hyp_attr->store(hyp_attr, buffer, len);\n\treturn 0;\n}\n\nstatic const struct sysfs_ops hyp_sysfs_ops = {\n\t.show = hyp_sysfs_show,\n\t.store = hyp_sysfs_store,\n};\n\nstatic const struct kobj_type hyp_sysfs_kobj_type = {\n\t.sysfs_ops = &hyp_sysfs_ops,\n};\n\nstatic int __init hypervisor_subsys_init(void)\n{\n\tif (!xen_domain())\n\t\treturn -ENODEV;\n\n\thypervisor_kobj->ktype = &hyp_sysfs_kobj_type;\n\treturn 0;\n}\ndevice_initcall(hypervisor_subsys_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}