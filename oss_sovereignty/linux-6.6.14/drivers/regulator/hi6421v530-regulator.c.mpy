{
  "module_name": "hi6421v530-regulator.c",
  "hash_id": "fe25c9e13841dca62984fd42f5dd2c527e8b66c6a44e0cb32e5e3c82928a719a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/hi6421v530-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n\n#include <linux/mfd/hi6421-pmic.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n\n \nstruct hi6421v530_regulator_info {\n\tstruct regulator_desc rdesc;\n\tu8 mode_mask;\n\tu32 eco_microamp;\n};\n\n \nenum hi6421v530_regulator_id {\n\tHI6421V530_LDO3,\n\tHI6421V530_LDO9,\n\tHI6421V530_LDO11,\n\tHI6421V530_LDO15,\n\tHI6421V530_LDO16,\n};\n\nstatic const unsigned int ldo_3_voltages[] = {\n\t1800000, 1825000, 1850000, 1875000,\n\t1900000, 1925000, 1950000, 1975000,\n\t2000000, 2025000, 2050000, 2075000,\n\t2100000, 2125000, 2150000, 2200000,\n};\n\nstatic const unsigned int ldo_9_11_voltages[] = {\n\t1750000, 1800000, 1825000, 2800000,\n\t2850000, 2950000, 3000000, 3300000,\n};\n\nstatic const unsigned int ldo_15_16_voltages[] = {\n\t1750000, 1800000, 2400000, 2600000,\n\t2700000, 2850000, 2950000, 3000000,\n};\n\nstatic const struct regulator_ops hi6421v530_ldo_ops;\n\n#define HI6421V530_LDO_ENABLE_TIME (350)\n\n \n#define HI6421V530_LDO(_ID, v_table, vreg, vmask, ereg, emask,\t\t\\\n\t\t   odelay, ecomask, ecoamp) {\t\t\t\t\\\n\t.rdesc = {\t\t\t\t\t\t\t\\\n\t\t.name\t\t = #_ID,\t\t\t\t\\\n\t\t.of_match        = of_match_ptr(#_ID),\t\t\t\\\n\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\t\\\n\t\t.ops\t\t = &hi6421v530_ldo_ops,\t\t\t\\\n\t\t.type\t\t = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t.id\t\t = HI6421V530_##_ID,\t\t\t\\\n\t\t.owner\t\t = THIS_MODULE,\t\t\t\t\\\n\t\t.n_voltages\t = ARRAY_SIZE(v_table),\t\t\t\\\n\t\t.volt_table\t = v_table,\t\t\t\t\\\n\t\t.vsel_reg\t = HI6421_REG_TO_BUS_ADDR(vreg),\t\\\n\t\t.vsel_mask\t = vmask,\t\t\t\t\\\n\t\t.enable_reg\t = HI6421_REG_TO_BUS_ADDR(ereg),\t\\\n\t\t.enable_mask\t = emask,\t\t\t\t\\\n\t\t.enable_time\t = HI6421V530_LDO_ENABLE_TIME,\t\t\\\n\t\t.off_on_delay\t = odelay,\t\t\t\t\\\n\t},\t\t\t\t\t\t\t\t\\\n\t.mode_mask\t= ecomask,\t\t\t\t\t\\\n\t.eco_microamp\t= ecoamp,\t\t\t\t\t\\\n}\n\n \n\nstatic struct hi6421v530_regulator_info hi6421v530_regulator_info[] = {\n\tHI6421V530_LDO(LDO3, ldo_3_voltages, 0x061, 0xf, 0x060, 0x2,\n\t\t   20000, 0x6, 8000),\n\tHI6421V530_LDO(LDO9, ldo_9_11_voltages, 0x06b, 0x7, 0x06a, 0x2,\n\t\t   40000, 0x6, 8000),\n\tHI6421V530_LDO(LDO11, ldo_9_11_voltages, 0x06f, 0x7, 0x06e, 0x2,\n\t\t   40000, 0x6, 8000),\n\tHI6421V530_LDO(LDO15, ldo_15_16_voltages, 0x077, 0x7, 0x076, 0x2,\n\t\t   40000, 0x6, 8000),\n\tHI6421V530_LDO(LDO16, ldo_15_16_voltages, 0x079, 0x7, 0x078, 0x2,\n\t\t   40000, 0x6, 8000),\n};\n\nstatic unsigned int hi6421v530_regulator_ldo_get_mode(\n\t\t\t\t\tstruct regulator_dev *rdev)\n{\n\tstruct hi6421v530_regulator_info *info;\n\tunsigned int reg_val;\n\n\tinfo = rdev_get_drvdata(rdev);\n\tregmap_read(rdev->regmap, rdev->desc->enable_reg, &reg_val);\n\n\tif (reg_val & (info->mode_mask))\n\t\treturn REGULATOR_MODE_IDLE;\n\n\treturn REGULATOR_MODE_NORMAL;\n}\n\nstatic int hi6421v530_regulator_ldo_set_mode(struct regulator_dev *rdev,\n\t\t\t\t\t\tunsigned int mode)\n{\n\tstruct hi6421v530_regulator_info *info;\n\tunsigned int new_mode;\n\n\tinfo = rdev_get_drvdata(rdev);\n\tswitch (mode) {\n\tcase REGULATOR_MODE_NORMAL:\n\t\tnew_mode = 0;\n\t\tbreak;\n\tcase REGULATOR_MODE_IDLE:\n\t\tnew_mode = info->mode_mask;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(rdev->regmap, rdev->desc->enable_reg,\n\t\t\t   info->mode_mask, new_mode);\n\n\treturn 0;\n}\n\n\nstatic const struct regulator_ops hi6421v530_ldo_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.list_voltage = regulator_list_voltage_table,\n\t.map_voltage = regulator_map_voltage_ascend,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_mode = hi6421v530_regulator_ldo_get_mode,\n\t.set_mode = hi6421v530_regulator_ldo_set_mode,\n};\n\nstatic int hi6421v530_regulator_probe(struct platform_device *pdev)\n{\n\tstruct hi6421_pmic *pmic;\n\tstruct regulator_dev *rdev;\n\tstruct regulator_config config = { };\n\tunsigned int i;\n\n\tpmic = dev_get_drvdata(pdev->dev.parent);\n\tif (!pmic) {\n\t\tdev_err(&pdev->dev, \"no pmic in the regulator parent node\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(hi6421v530_regulator_info); i++) {\n\t\tconfig.dev = pdev->dev.parent;\n\t\tconfig.regmap = pmic->regmap;\n\t\tconfig.driver_data = &hi6421v530_regulator_info[i];\n\n\t\trdev = devm_regulator_register(&pdev->dev,\n\t\t\t\t&hi6421v530_regulator_info[i].rdesc,\n\t\t\t\t&config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(&pdev->dev, \"failed to register regulator %s\\n\",\n\t\t\t\thi6421v530_regulator_info[i].rdesc.name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic const struct platform_device_id hi6421v530_regulator_table[] = {\n\t{ .name = \"hi6421v530-regulator\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(platform, hi6421v530_regulator_table);\n\nstatic struct platform_driver hi6421v530_regulator_driver = {\n\t.id_table = hi6421v530_regulator_table,\n\t.driver = {\n\t\t.name\t= \"hi6421v530-regulator\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe\t= hi6421v530_regulator_probe,\n};\nmodule_platform_driver(hi6421v530_regulator_driver);\n\nMODULE_AUTHOR(\"Wang Xiaoyin <hw.wangxiaoyin@hisilicon.com>\");\nMODULE_DESCRIPTION(\"Hi6421v530 regulator driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}