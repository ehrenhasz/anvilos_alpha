{
  "module_name": "qcom-refgen-regulator.c",
  "hash_id": "ee8fb3e5479294f3c3a97abec7fe5ac7c573629c6d08d640fbf2656feb06526e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/qcom-refgen-regulator.c",
  "human_readable_source": "\n\n\n\n#include <linux/bitfield.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n\n#define REFGEN_REG_BIAS_EN\t\t0x08\n#define REFGEN_BIAS_EN_MASK\t\tGENMASK(2, 0)\n #define REFGEN_BIAS_EN_ENABLE\t\t0x7\n #define REFGEN_BIAS_EN_DISABLE\t\t0x6\n\n#define REFGEN_REG_BG_CTRL\t\t0x14\n#define REFGEN_BG_CTRL_MASK\t\tGENMASK(2, 1)\n #define REFGEN_BG_CTRL_ENABLE\t\t0x3\n #define REFGEN_BG_CTRL_DISABLE\t\t0x2\n\n#define REFGEN_REG_PWRDWN_CTRL5\t\t0x80\n#define REFGEN_PWRDWN_CTRL5_MASK\tBIT(0)\n #define REFGEN_PWRDWN_CTRL5_ENABLE\t0x1\n\nstatic int qcom_sdm845_refgen_enable(struct regulator_dev *rdev)\n{\n\tregmap_update_bits(rdev->regmap, REFGEN_REG_BG_CTRL, REFGEN_BG_CTRL_MASK,\n\t\t\t   FIELD_PREP(REFGEN_BG_CTRL_MASK, REFGEN_BG_CTRL_ENABLE));\n\n\tregmap_write(rdev->regmap, REFGEN_REG_BIAS_EN,\n\t\t     FIELD_PREP(REFGEN_BIAS_EN_MASK, REFGEN_BIAS_EN_ENABLE));\n\n\treturn 0;\n}\n\nstatic int qcom_sdm845_refgen_disable(struct regulator_dev *rdev)\n{\n\tregmap_write(rdev->regmap, REFGEN_REG_BIAS_EN,\n\t\t     FIELD_PREP(REFGEN_BIAS_EN_MASK, REFGEN_BIAS_EN_DISABLE));\n\n\tregmap_update_bits(rdev->regmap, REFGEN_REG_BG_CTRL, REFGEN_BG_CTRL_MASK,\n\t\t\t   FIELD_PREP(REFGEN_BG_CTRL_MASK, REFGEN_BG_CTRL_DISABLE));\n\n\treturn 0;\n}\n\nstatic int qcom_sdm845_refgen_is_enabled(struct regulator_dev *rdev)\n{\n\tu32 val;\n\n\tregmap_read(rdev->regmap, REFGEN_REG_BG_CTRL, &val);\n\tif (FIELD_GET(REFGEN_BG_CTRL_MASK, val) != REFGEN_BG_CTRL_ENABLE)\n\t\treturn 0;\n\n\tregmap_read(rdev->regmap, REFGEN_REG_BIAS_EN, &val);\n\tif (FIELD_GET(REFGEN_BIAS_EN_MASK, val) != REFGEN_BIAS_EN_ENABLE)\n\t\treturn 0;\n\n\treturn 1;\n}\n\nstatic struct regulator_desc sdm845_refgen_desc = {\n\t.enable_time = 5,\n\t.name = \"refgen\",\n\t.owner = THIS_MODULE,\n\t.type = REGULATOR_VOLTAGE,\n\t.ops = &(const struct regulator_ops) {\n\t\t.enable\t\t= qcom_sdm845_refgen_enable,\n\t\t.disable\t= qcom_sdm845_refgen_disable,\n\t\t.is_enabled\t= qcom_sdm845_refgen_is_enabled,\n\t},\n};\n\nstatic struct regulator_desc sm8250_refgen_desc = {\n\t.enable_reg = REFGEN_REG_PWRDWN_CTRL5,\n\t.enable_mask = REFGEN_PWRDWN_CTRL5_MASK,\n\t.enable_val = REFGEN_PWRDWN_CTRL5_ENABLE,\n\t.disable_val = 0,\n\t.enable_time = 5,\n\t.name = \"refgen\",\n\t.owner = THIS_MODULE,\n\t.type = REGULATOR_VOLTAGE,\n\t.ops = &(const struct regulator_ops) {\n\t\t.enable\t\t= regulator_enable_regmap,\n\t\t.disable\t= regulator_disable_regmap,\n\t\t.is_enabled\t= regulator_is_enabled_regmap,\n\t},\n};\n\nstatic const struct regmap_config qcom_refgen_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.fast_io = true,\n};\n\nstatic int qcom_refgen_probe(struct platform_device *pdev)\n{\n\tstruct regulator_init_data *init_data;\n\tstruct regulator_config config = {};\n\tconst struct regulator_desc *rdesc;\n\tstruct device *dev = &pdev->dev;\n\tstruct regulator_dev *rdev;\n\tstruct regmap *regmap;\n\tvoid __iomem *base;\n\n\trdesc = of_device_get_match_data(dev);\n\tif (!rdesc)\n\t\treturn -ENODATA;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tregmap = devm_regmap_init_mmio(dev, base, &qcom_refgen_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn PTR_ERR(regmap);\n\n\tinit_data = of_get_regulator_init_data(dev, dev->of_node, rdesc);\n\tif (!init_data)\n\t\treturn -ENOMEM;\n\n\tconfig.dev = dev;\n\tconfig.init_data = init_data;\n\tconfig.of_node = dev->of_node;\n\tconfig.regmap = regmap;\n\n\trdev = devm_regulator_register(dev, rdesc, &config);\n\tif (IS_ERR(rdev))\n\t\treturn PTR_ERR(rdev);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id qcom_refgen_match_table[] = {\n\t{ .compatible = \"qcom,sdm845-refgen-regulator\", .data = &sdm845_refgen_desc },\n\t{ .compatible = \"qcom,sm8250-refgen-regulator\", .data = &sm8250_refgen_desc },\n\t{ }\n};\n\nstatic struct platform_driver qcom_refgen_driver = {\n\t.probe = qcom_refgen_probe,\n\t.driver = {\n\t\t.name = \"qcom-refgen-regulator\",\n\t\t.of_match_table = qcom_refgen_match_table,\n\t},\n};\nmodule_platform_driver(qcom_refgen_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Qualcomm REFGEN regulator driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}