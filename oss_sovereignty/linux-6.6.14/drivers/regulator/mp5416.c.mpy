{
  "module_name": "mp5416.c",
  "hash_id": "7fa2a8c962218f15bb261feeda6cb512172de5320ee8d980caaa396d9f8444d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/mp5416.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/err.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n\n#define MP5416_REG_CTL0\t\t\t0x00\n#define MP5416_REG_CTL1\t\t\t0x01\n#define MP5416_REG_CTL2\t\t\t0x02\n#define MP5416_REG_ILIM\t\t\t0x03\n#define MP5416_REG_BUCK1\t\t0x04\n#define MP5416_REG_BUCK2\t\t0x05\n#define MP5416_REG_BUCK3\t\t0x06\n#define MP5416_REG_BUCK4\t\t0x07\n#define MP5416_REG_LDO1\t\t\t0x08\n#define MP5416_REG_LDO2\t\t\t0x09\n#define MP5416_REG_LDO3\t\t\t0x0a\n#define MP5416_REG_LDO4\t\t\t0x0b\n\n#define MP5416_REGULATOR_EN\t\tBIT(7)\n#define MP5416_MASK_VSET\t\t0x7f\n#define MP5416_MASK_BUCK1_ILIM\t\t0xc0\n#define MP5416_MASK_BUCK2_ILIM\t\t0x0c\n#define MP5416_MASK_BUCK3_ILIM\t\t0x30\n#define MP5416_MASK_BUCK4_ILIM\t\t0x03\n#define MP5416_MASK_DVS_SLEWRATE\t0xc0\n\n \n#define MP5416_VOLT1_MIN\t\t600000\n#define MP5416_VOLT1_MAX\t\t2187500\n#define MP5416_VOLT1_STEP\t\t12500\n#define MP5416_VOLT2_MIN\t\t800000\n#define MP5416_VOLT2_MAX\t\t3975000\n#define MP5416_VOLT2_STEP\t\t25000\n\n#define MP5416_VOLT1_RANGE \\\n\t((MP5416_VOLT1_MAX - MP5416_VOLT1_MIN)/MP5416_VOLT1_STEP + 1)\n#define MP5416_VOLT2_RANGE \\\n\t((MP5416_VOLT2_MAX - MP5416_VOLT2_MIN)/MP5416_VOLT2_STEP + 1)\n\n#define MP5416BUCK(_name, _id, _ilim, _dreg, _dval, _vsel)\t\t\\\n\t[MP5416_BUCK ## _id] = {\t\t\t\t\t\\\n\t\t.id = MP5416_BUCK ## _id,\t\t\t\t\\\n\t\t.name = _name,\t\t\t\t\t\t\\\n\t\t.of_match = _name,\t\t\t\t\t\\\n\t\t.regulators_node = \"regulators\",\t\t\t\\\n\t\t.ops = &mp5416_buck_ops,\t\t\t\t\\\n\t\t.min_uV = MP5416_VOLT ##_vsel## _MIN,\t\t\t\\\n\t\t.uV_step = MP5416_VOLT ##_vsel## _STEP,\t\t\t\\\n\t\t.n_voltages = MP5416_VOLT ##_vsel## _RANGE,\t\t\\\n\t\t.curr_table = _ilim,\t\t\t\t\t\\\n\t\t.n_current_limits = ARRAY_SIZE(_ilim),\t\t\t\\\n\t\t.csel_reg = MP5416_REG_ILIM,\t\t\t\t\\\n\t\t.csel_mask = MP5416_MASK_BUCK ## _id ##_ILIM,\t\t\\\n\t\t.vsel_reg = MP5416_REG_BUCK ## _id,\t\t\t\\\n\t\t.vsel_mask = MP5416_MASK_VSET,\t\t\t\t\\\n\t\t.enable_reg = MP5416_REG_BUCK ## _id,\t\t\t\\\n\t\t.enable_mask = MP5416_REGULATOR_EN,\t\t\t\\\n\t\t.ramp_reg = MP5416_REG_CTL2,\t\t\t\t\\\n\t\t.ramp_mask = MP5416_MASK_DVS_SLEWRATE,\t\t\t\\\n\t\t.ramp_delay_table = mp5416_buck_ramp_table,\t\t\\\n\t\t.n_ramp_values = ARRAY_SIZE(mp5416_buck_ramp_table),\t\\\n\t\t.active_discharge_on\t= _dval,\t\t\t\\\n\t\t.active_discharge_reg\t= _dreg,\t\t\t\\\n\t\t.active_discharge_mask\t= _dval,\t\t\t\\\n\t\t.owner\t\t\t= THIS_MODULE,\t\t\t\\\n\t}\n\n#define MP5416LDO(_name, _id, _dval)\t\t\t\t\t\\\n\t[MP5416_LDO ## _id] = {\t\t\t\t\t\t\\\n\t\t.id = MP5416_LDO ## _id,\t\t\t\t\\\n\t\t.name = _name,\t\t\t\t\t\t\\\n\t\t.of_match = _name,\t\t\t\t\t\\\n\t\t.regulators_node = \"regulators\",\t\t\t\\\n\t\t.ops = &mp5416_ldo_ops,\t\t\t\t\t\\\n\t\t.min_uV = MP5416_VOLT2_MIN,\t\t\t\t\\\n\t\t.uV_step = MP5416_VOLT2_STEP,\t\t\t\t\\\n\t\t.n_voltages = MP5416_VOLT2_RANGE,\t\t\t\\\n\t\t.vsel_reg = MP5416_REG_LDO ##_id,\t\t\t\\\n\t\t.vsel_mask = MP5416_MASK_VSET,\t\t\t\t\\\n\t\t.enable_reg = MP5416_REG_LDO ##_id,\t\t\t\\\n\t\t.enable_mask = MP5416_REGULATOR_EN,\t\t\t\\\n\t\t.active_discharge_on\t= _dval,\t\t\t\\\n\t\t.active_discharge_reg\t= MP5416_REG_CTL2,\t\t\\\n\t\t.active_discharge_mask\t= _dval,\t\t\t\\\n\t\t.owner\t\t\t= THIS_MODULE,\t\t\t\\\n\t}\n\nenum mp5416_regulators {\n\tMP5416_BUCK1,\n\tMP5416_BUCK2,\n\tMP5416_BUCK3,\n\tMP5416_BUCK4,\n\tMP5416_LDO1,\n\tMP5416_LDO2,\n\tMP5416_LDO3,\n\tMP5416_LDO4,\n\tMP5416_MAX_REGULATORS,\n};\n\nstatic const struct regmap_config mp5416_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = 0x0d,\n};\n\n \nstatic const unsigned int mp5416_I_limits1[] = {\n\t3800000, 4600000, 5600000, 6800000\n};\n\n \nstatic const unsigned int mp5416_I_limits2[] = {\n\t2200000, 3200000, 4200000, 5200000\n};\n\n \nstatic const unsigned int mp5416_buck_ramp_table[] = {\n\t32000, 16000, 8000, 4000\n};\n\nstatic const struct regulator_ops mp5416_ldo_ops = {\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.set_active_discharge\t= regulator_set_active_discharge_regmap,\n};\n\nstatic const struct regulator_ops mp5416_buck_ops = {\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.set_active_discharge\t= regulator_set_active_discharge_regmap,\n\t.get_current_limit\t= regulator_get_current_limit_regmap,\n\t.set_current_limit\t= regulator_set_current_limit_regmap,\n\t.set_ramp_delay\t\t= regulator_set_ramp_delay_regmap,\n};\n\nstatic struct regulator_desc mp5416_regulators_desc[MP5416_MAX_REGULATORS] = {\n\tMP5416BUCK(\"buck1\", 1, mp5416_I_limits1, MP5416_REG_CTL1, BIT(0), 1),\n\tMP5416BUCK(\"buck2\", 2, mp5416_I_limits2, MP5416_REG_CTL1, BIT(1), 2),\n\tMP5416BUCK(\"buck3\", 3, mp5416_I_limits1, MP5416_REG_CTL1, BIT(2), 1),\n\tMP5416BUCK(\"buck4\", 4, mp5416_I_limits2, MP5416_REG_CTL2, BIT(5), 2),\n\tMP5416LDO(\"ldo1\", 1, BIT(4)),\n\tMP5416LDO(\"ldo2\", 2, BIT(3)),\n\tMP5416LDO(\"ldo3\", 3, BIT(2)),\n\tMP5416LDO(\"ldo4\", 4, BIT(1)),\n};\n\nstatic struct regulator_desc mp5496_regulators_desc[MP5416_MAX_REGULATORS] = {\n\tMP5416BUCK(\"buck1\", 1, mp5416_I_limits1, MP5416_REG_CTL1, BIT(0), 1),\n\tMP5416BUCK(\"buck2\", 2, mp5416_I_limits2, MP5416_REG_CTL1, BIT(1), 1),\n\tMP5416BUCK(\"buck3\", 3, mp5416_I_limits1, MP5416_REG_CTL1, BIT(2), 1),\n\tMP5416BUCK(\"buck4\", 4, mp5416_I_limits2, MP5416_REG_CTL2, BIT(5), 1),\n\tMP5416LDO(\"ldo1\", 1, BIT(4)),\n\tMP5416LDO(\"ldo2\", 2, BIT(3)),\n\tMP5416LDO(\"ldo3\", 3, BIT(2)),\n\tMP5416LDO(\"ldo4\", 4, BIT(1)),\n};\n\nstatic int mp5416_i2c_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tstruct regulator_config config = { NULL, };\n\tstatic const struct regulator_desc *desc;\n\tstruct regulator_dev *rdev;\n\tstruct regmap *regmap;\n\tint i;\n\n\tregmap = devm_regmap_init_i2c(client, &mp5416_regmap_config);\n\tif (IS_ERR(regmap)) {\n\t\tdev_err(dev, \"Failed to allocate regmap!\\n\");\n\t\treturn PTR_ERR(regmap);\n\t}\n\n\tdesc = of_device_get_match_data(dev);\n\tif (!desc)\n\t\treturn -ENODEV;\n\n\tconfig.dev = dev;\n\tconfig.regmap = regmap;\n\n\tfor (i = 0; i < MP5416_MAX_REGULATORS; i++) {\n\t\trdev = devm_regulator_register(dev,\n\t\t\t\t\t       &desc[i],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(dev, \"Failed to register regulator!\\n\");\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id mp5416_of_match[] = {\n\t{ .compatible = \"mps,mp5416\", .data = &mp5416_regulators_desc },\n\t{ .compatible = \"mps,mp5496\", .data = &mp5496_regulators_desc },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mp5416_of_match);\n\nstatic const struct i2c_device_id mp5416_id[] = {\n\t{ \"mp5416\", },\n\t{ \"mp5496\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(i2c, mp5416_id);\n\nstatic struct i2c_driver mp5416_regulator_driver = {\n\t.driver = {\n\t\t.name = \"mp5416\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = of_match_ptr(mp5416_of_match),\n\t},\n\t.probe = mp5416_i2c_probe,\n\t.id_table = mp5416_id,\n};\nmodule_i2c_driver(mp5416_regulator_driver);\n\nMODULE_AUTHOR(\"Saravanan Sekar <sravanhome@gmail.com>\");\nMODULE_DESCRIPTION(\"MP5416 PMIC regulator driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}