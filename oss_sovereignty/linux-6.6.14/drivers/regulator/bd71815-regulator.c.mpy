{
  "module_name": "bd71815-regulator.c",
  "hash_id": "10fb17c52cff50a0e8a640696e05c1e404d4ee9850138fa0c5a8ccaca0f37493",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/bd71815-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/of.h>\n#include <linux/gpio/consumer.h>\n#include <linux/regulator/driver.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/mfd/rohm-generic.h>\n#include <linux/mfd/rohm-bd71815.h>\n#include <linux/regulator/of_regulator.h>\n\nstruct bd71815_regulator {\n\tstruct regulator_desc desc;\n\tconst struct rohm_dvs_config *dvs;\n};\n\nstatic const int bd7181x_wled_currents[] = {\n\t10, 20, 30, 50, 70, 100, 200, 300, 500, 700, 1000, 2000, 3000, 4000,\n\t5000, 6000, 7000, 8000, 9000, 10000, 11000, 12000, 13000, 14000, 15000,\n\t16000, 17000, 18000, 19000, 20000, 21000, 22000, 23000, 24000, 25000,\n};\n\nstatic const struct rohm_dvs_config buck1_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_BUCK1_VOLT_H,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= BD71815_BUCK_RUN_ON,\n\t.snvs_on_mask\t\t= BD71815_BUCK_SNVS_ON,\n\t.suspend_reg\t\t= BD71815_REG_BUCK1_VOLT_L,\n\t.suspend_mask\t\t= BD71815_VOLT_MASK,\n\t.suspend_on_mask\t= BD71815_BUCK_SUSP_ON,\n\t.lpsr_reg\t\t= BD71815_REG_BUCK1_VOLT_L,\n\t.lpsr_mask\t\t= BD71815_VOLT_MASK,\n\t.lpsr_on_mask\t\t= BD71815_BUCK_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config buck2_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_BUCK2_VOLT_H,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= BD71815_BUCK_RUN_ON,\n\t.snvs_on_mask\t\t= BD71815_BUCK_SNVS_ON,\n\t.suspend_reg\t\t= BD71815_REG_BUCK2_VOLT_L,\n\t.suspend_mask\t\t= BD71815_VOLT_MASK,\n\t.suspend_on_mask\t= BD71815_BUCK_SUSP_ON,\n\t.lpsr_reg\t\t= BD71815_REG_BUCK2_VOLT_L,\n\t.lpsr_mask\t\t= BD71815_VOLT_MASK,\n\t.lpsr_on_mask\t\t= BD71815_BUCK_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config buck3_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_BUCK3_VOLT,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= BD71815_BUCK_RUN_ON,\n\t.snvs_on_mask\t\t= BD71815_BUCK_SNVS_ON,\n\t.suspend_on_mask\t= BD71815_BUCK_SUSP_ON,\n\t.lpsr_on_mask\t\t= BD71815_BUCK_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config buck4_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_BUCK4_VOLT,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= BD71815_BUCK_RUN_ON,\n\t.snvs_on_mask\t\t= BD71815_BUCK_SNVS_ON,\n\t.suspend_on_mask\t= BD71815_BUCK_SUSP_ON,\n\t.lpsr_on_mask\t\t= BD71815_BUCK_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config ldo1_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_LDO_MODE1,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= LDO1_RUN_ON,\n\t.snvs_on_mask\t\t= LDO1_SNVS_ON,\n\t.suspend_on_mask\t= LDO1_SUSP_ON,\n\t.lpsr_on_mask\t\t= LDO1_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config ldo2_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_LDO_MODE2,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= LDO2_RUN_ON,\n\t.snvs_on_mask\t\t= LDO2_SNVS_ON,\n\t.suspend_on_mask\t= LDO2_SUSP_ON,\n\t.lpsr_on_mask\t\t= LDO2_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config ldo3_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_LDO_MODE2,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= LDO3_RUN_ON,\n\t.snvs_on_mask\t\t= LDO3_SNVS_ON,\n\t.suspend_on_mask\t= LDO3_SUSP_ON,\n\t.lpsr_on_mask\t\t= LDO3_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config ldo4_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_LDO_MODE3,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= LDO4_RUN_ON,\n\t.snvs_on_mask\t\t= LDO4_SNVS_ON,\n\t.suspend_on_mask\t= LDO4_SUSP_ON,\n\t.lpsr_on_mask\t\t= LDO4_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config ldo5_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_LDO_MODE3,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= LDO5_RUN_ON,\n\t.snvs_on_mask\t\t= LDO5_SNVS_ON,\n\t.suspend_on_mask\t= LDO5_SUSP_ON,\n\t.lpsr_on_mask\t\t= LDO5_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config dvref_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_on_mask\t\t= DVREF_RUN_ON,\n\t.snvs_on_mask\t\t= DVREF_SNVS_ON,\n\t.suspend_on_mask\t= DVREF_SUSP_ON,\n\t.lpsr_on_mask\t\t= DVREF_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config ldolpsr_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_on_mask\t\t= DVREF_RUN_ON,\n\t.snvs_on_mask\t\t= DVREF_SNVS_ON,\n\t.suspend_on_mask\t= DVREF_SUSP_ON,\n\t.lpsr_on_mask\t\t= DVREF_LPSR_ON,\n};\n\nstatic const struct rohm_dvs_config buck5_dvs = {\n\t.level_map\t\t= ROHM_DVS_LEVEL_RUN | ROHM_DVS_LEVEL_SNVS |\n\t\t\t\t  ROHM_DVS_LEVEL_SUSPEND | ROHM_DVS_LEVEL_LPSR,\n\t.run_reg\t\t= BD71815_REG_BUCK5_VOLT,\n\t.run_mask\t\t= BD71815_VOLT_MASK,\n\t.run_on_mask\t\t= BD71815_BUCK_RUN_ON,\n\t.snvs_on_mask\t\t= BD71815_BUCK_SNVS_ON,\n\t.suspend_on_mask\t= BD71815_BUCK_SUSP_ON,\n\t.lpsr_on_mask\t\t= BD71815_BUCK_LPSR_ON,\n};\n\nstatic int set_hw_dvs_levels(struct device_node *np,\n\t\t\t     const struct regulator_desc *desc,\n\t\t\t     struct regulator_config *cfg)\n{\n\tstruct bd71815_regulator *data;\n\n\tdata = container_of(desc, struct bd71815_regulator, desc);\n\treturn rohm_regulator_set_dvs_levels(data->dvs, np, desc, cfg->regmap);\n}\n\n \nstatic int buck12_set_hw_dvs_levels(struct device_node *np,\n\t\t\t\t    const struct regulator_desc *desc,\n\t\t\t\t    struct regulator_config *cfg)\n{\n\tstruct bd71815_regulator *data;\n\tint ret = 0, val;\n\n\tdata = container_of(desc, struct bd71815_regulator, desc);\n\n\tif (of_property_present(np, \"rohm,dvs-run-voltage\") ||\n\t    of_property_present(np, \"rohm,dvs-suspend-voltage\") ||\n\t    of_property_present(np, \"rohm,dvs-lpsr-voltage\") ||\n\t    of_property_present(np, \"rohm,dvs-snvs-voltage\")) {\n\t\tret = regmap_read(cfg->regmap, desc->vsel_reg, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (!(BD71815_BUCK_STBY_DVS & val) &&\n\t\t    !(BD71815_BUCK_DVSSEL & val)) {\n\t\t\tint val2;\n\n\t\t\t \n\t\t\tret = regmap_read(cfg->regmap, desc->vsel_reg + 1,\n\t\t\t\t\t  &val2);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = regmap_update_bits(cfg->regmap, desc->vsel_reg,\n\t\t\t\t\t\t BD71815_VOLT_MASK |\n\t\t\t\t\t\t BD71815_BUCK_DVSSEL,\n\t\t\t\t\t\t val2 | BD71815_BUCK_DVSSEL);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\t\tret = rohm_regulator_set_dvs_levels(data->dvs, np, desc,\n\t\t\t\t\t\t    cfg->regmap);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\t \n\t\tret = regmap_update_bits(cfg->regmap, desc->vsel_reg,\n\t\t\t\t\t BD71815_BUCK_STBY_DVS,\n\t\t\t\t\t BD71815_BUCK_STBY_DVS);\n\t}\n\n\treturn ret;\n}\n\n \nstatic const unsigned int bd7181x_ramp_table[] = { 1250, 2500, 5000, 10000 };\n\nstatic int bd7181x_led_set_current_limit(struct regulator_dev *rdev,\n\t\t\t\t\tint min_uA, int max_uA)\n{\n\tint ret;\n\tint onstatus;\n\n\tonstatus = regulator_is_enabled_regmap(rdev);\n\n\tret = regulator_set_current_limit_regmap(rdev, min_uA, max_uA);\n\tif (!ret) {\n\t\tint newstatus;\n\n\t\tnewstatus = regulator_is_enabled_regmap(rdev);\n\t\tif (onstatus != newstatus) {\n\t\t\t \n\t\t\tif (onstatus)\n\t\t\t\tret = regulator_enable_regmap(rdev);\n\t\t\telse\n\t\t\t\tret = regulator_disable_regmap(rdev);\n\n\t\t\tif (ret)\n\t\t\t\tdev_err(rdev_get_dev(rdev),\n\t\t\t\t\t\"failed to revert the LED state (%d)\\n\",\n\t\t\t\t\tret);\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int bd7181x_buck12_get_voltage_sel(struct regulator_dev *rdev)\n{\n\tint rid = rdev_get_id(rdev);\n\tint ret, regh, regl, val;\n\n\tregh = BD71815_REG_BUCK1_VOLT_H + rid * 0x2;\n\tregl = BD71815_REG_BUCK1_VOLT_L + rid * 0x2;\n\n\tret = regmap_read(rdev->regmap, regh, &val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif ((!(val & BD71815_BUCK_STBY_DVS)) && (!(val & BD71815_BUCK_DVSSEL)))\n\t\tret = regmap_read(rdev->regmap, regl, &val);\n\n\tif (ret)\n\t\treturn ret;\n\n\treturn val & BD71815_VOLT_MASK;\n}\n\n \nstatic int bd7181x_buck12_set_voltage_sel(struct regulator_dev *rdev,\n\t\t\t\t\t  unsigned int sel)\n{\n\tint rid = rdev_get_id(rdev);\n\tint ret, val, reg, regh, regl;\n\n\tregh = BD71815_REG_BUCK1_VOLT_H + rid*0x2;\n\tregl = BD71815_REG_BUCK1_VOLT_L + rid*0x2;\n\n\tret = regmap_read(rdev->regmap, regh, &val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (((val & BD71815_BUCK_STBY_DVS))) {\n\t\treturn regmap_update_bits(rdev->regmap, regh, BD71815_VOLT_MASK,\n\t\t\t\t\t  sel);\n\t}\n\t \n\tif (val & BD71815_BUCK_DVSSEL)\n\t\treg = regl;\n\telse\n\t\treg = regh;\n\n\tret = regmap_update_bits(rdev->regmap, reg, BD71815_VOLT_MASK, sel);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn regmap_update_bits(rdev->regmap, regh, BD71815_BUCK_DVSSEL,\n\t\t\t\t  ~val);\n}\n\nstatic const struct regulator_ops bd7181x_ldo_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n};\n\nstatic const struct regulator_ops bd7181x_fixed_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n};\n\nstatic const struct regulator_ops bd7181x_buck_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_time_sel = regulator_set_voltage_time_sel,\n};\n\nstatic const struct regulator_ops bd7181x_buck12_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.set_voltage_sel = bd7181x_buck12_set_voltage_sel,\n\t.get_voltage_sel = bd7181x_buck12_get_voltage_sel,\n\t.set_voltage_time_sel = regulator_set_voltage_time_sel,\n\t.set_ramp_delay = regulator_set_ramp_delay_regmap,\n};\n\nstatic const struct regulator_ops bd7181x_led_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.set_current_limit = bd7181x_led_set_current_limit,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n};\n\n#define BD71815_FIXED_REG(_name, _id, ereg, emsk, voltage, _dvs)\t\\\n\t[(_id)] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = #_name,\t\t\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.n_voltages = 1,\t\t\t\t\\\n\t\t\t.ops = &bd7181x_fixed_regulator_ops,\t\t\\\n\t\t\t.type = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t\t.id = (_id),\t\t\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t\t.min_uV = (voltage),\t\t\t\t\\\n\t\t\t.enable_reg = (ereg),\t\t\t\t\\\n\t\t\t.enable_mask = (emsk),\t\t\t\t\\\n\t\t\t.of_parse_cb = set_hw_dvs_levels,\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.dvs = (_dvs),\t\t\t\t\t\t\\\n\t}\n\n#define BD71815_BUCK_REG(_name, _id, vsel, ereg, min, max, step, _dvs)\t\\\n\t[(_id)] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = #_name,\t\t\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.n_voltages = ((max) - (min)) / (step) + 1,\t\\\n\t\t\t.ops = &bd7181x_buck_regulator_ops,\t\t\\\n\t\t\t.type = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t\t.id = (_id),\t\t\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t\t.min_uV = (min),\t\t\t\t\\\n\t\t\t.uV_step = (step),\t\t\t\t\\\n\t\t\t.vsel_reg = (vsel),\t\t\t\t\\\n\t\t\t.vsel_mask = BD71815_VOLT_MASK,\t\t\t\\\n\t\t\t.enable_reg = (ereg),\t\t\t\t\\\n\t\t\t.enable_mask = BD71815_BUCK_RUN_ON,\t\t\\\n\t\t\t.of_parse_cb = set_hw_dvs_levels,\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.dvs = (_dvs),\t\t\t\t\t\t\\\n\t}\n\n#define BD71815_BUCK12_REG(_name, _id, vsel, ereg, min, max, step,\t\\\n\t\t\t   _dvs)\t\t\t\t\t\\\n\t[(_id)] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = #_name,\t\t\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.n_voltages = ((max) - (min)) / (step) + 1,\t\\\n\t\t\t.ops = &bd7181x_buck12_regulator_ops,\t\t\\\n\t\t\t.type = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t\t.id = (_id),\t\t\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t\t.min_uV = (min),\t\t\t\t\\\n\t\t\t.uV_step = (step),\t\t\t\t\\\n\t\t\t.vsel_reg = (vsel),\t\t\t\t\\\n\t\t\t.vsel_mask = BD71815_VOLT_MASK,\t\t\t\\\n\t\t\t.enable_reg = (ereg),\t\t\t\t\\\n\t\t\t.enable_mask = BD71815_BUCK_RUN_ON,\t\t\\\n\t\t\t.ramp_reg = (ereg),\t\t\t\t\\\n\t\t\t.ramp_mask = BD71815_BUCK_RAMPRATE_MASK,\t\\\n\t\t\t.ramp_delay_table = bd7181x_ramp_table,\t\t\\\n\t\t\t.n_ramp_values = ARRAY_SIZE(bd7181x_ramp_table),\\\n\t\t\t.of_parse_cb = buck12_set_hw_dvs_levels,\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.dvs = (_dvs),\t\t\t\t\t\t\\\n\t}\n\n#define BD71815_LED_REG(_name, _id, csel, mask, ereg, emsk, currents)\t\\\n\t[(_id)] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = #_name,\t\t\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.n_current_limits = ARRAY_SIZE(currents),\t\\\n\t\t\t.ops = &bd7181x_led_regulator_ops,\t\t\\\n\t\t\t.type = REGULATOR_CURRENT,\t\t\t\\\n\t\t\t.id = (_id),\t\t\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t\t.curr_table = currents,\t\t\t\t\\\n\t\t\t.csel_reg = (csel),\t\t\t\t\\\n\t\t\t.csel_mask = (mask),\t\t\t\t\\\n\t\t\t.enable_reg = (ereg),\t\t\t\t\\\n\t\t\t.enable_mask = (emsk),\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n\n#define BD71815_LDO_REG(_name, _id, vsel, ereg, emsk, min, max, step,\t\\\n\t\t\t_dvs)\t\t\t\t\t\t\\\n\t[(_id)] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = #_name,\t\t\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.n_voltages = ((max) - (min)) / (step) + 1,\t\\\n\t\t\t.ops = &bd7181x_ldo_regulator_ops,\t\t\\\n\t\t\t.type = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t\t.id = (_id),\t\t\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t\t.min_uV = (min),\t\t\t\t\\\n\t\t\t.uV_step = (step),\t\t\t\t\\\n\t\t\t.vsel_reg = (vsel),\t\t\t\t\\\n\t\t\t.vsel_mask = BD71815_VOLT_MASK,\t\t\t\\\n\t\t\t.enable_reg = (ereg),\t\t\t\t\\\n\t\t\t.enable_mask = (emsk),\t\t\t\t\\\n\t\t\t.of_parse_cb = set_hw_dvs_levels,\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.dvs = (_dvs),\t\t\t\t\t\t\\\n\t}\n\nstatic const struct bd71815_regulator bd71815_regulators[] = {\n\tBD71815_BUCK12_REG(buck1, BD71815_BUCK1, BD71815_REG_BUCK1_VOLT_H,\n\t\t\t   BD71815_REG_BUCK1_MODE, 800000, 2000000, 25000,\n\t\t\t   &buck1_dvs),\n\tBD71815_BUCK12_REG(buck2, BD71815_BUCK2, BD71815_REG_BUCK2_VOLT_H,\n\t\t\t   BD71815_REG_BUCK2_MODE, 800000, 2000000, 25000,\n\t\t\t   &buck2_dvs),\n\tBD71815_BUCK_REG(buck3, BD71815_BUCK3, BD71815_REG_BUCK3_VOLT,\n\t\t\t BD71815_REG_BUCK3_MODE,  1200000, 2700000, 50000,\n\t\t\t &buck3_dvs),\n\tBD71815_BUCK_REG(buck4, BD71815_BUCK4, BD71815_REG_BUCK4_VOLT,\n\t\t\t BD71815_REG_BUCK4_MODE,  1100000, 1850000, 25000,\n\t\t\t &buck4_dvs),\n\tBD71815_BUCK_REG(buck5, BD71815_BUCK5, BD71815_REG_BUCK5_VOLT,\n\t\t\t BD71815_REG_BUCK5_MODE,  1800000, 3300000, 50000,\n\t\t\t &buck5_dvs),\n\tBD71815_LDO_REG(ldo1, BD71815_LDO1, BD71815_REG_LDO1_VOLT,\n\t\t\tBD71815_REG_LDO_MODE1, LDO1_RUN_ON, 800000, 3300000,\n\t\t\t50000, &ldo1_dvs),\n\tBD71815_LDO_REG(ldo2, BD71815_LDO2, BD71815_REG_LDO2_VOLT,\n\t\t\tBD71815_REG_LDO_MODE2, LDO2_RUN_ON, 800000, 3300000,\n\t\t\t50000, &ldo2_dvs),\n\t \n\tBD71815_LDO_REG(ldo3, BD71815_LDO3, BD71815_REG_LDO3_VOLT,\n\t\t\tBD71815_REG_LDO_MODE2, LDO3_RUN_ON, 800000, 3300000,\n\t\t\t50000, &ldo3_dvs),\n\tBD71815_LDO_REG(ldo4, BD71815_LDO4, BD71815_REG_LDO4_VOLT,\n\t\t\tBD71815_REG_LDO_MODE3, LDO4_RUN_ON, 800000, 3300000,\n\t\t\t50000, &ldo4_dvs),\n\tBD71815_LDO_REG(ldo5, BD71815_LDO5, BD71815_REG_LDO5_VOLT_H,\n\t\t\tBD71815_REG_LDO_MODE3, LDO5_RUN_ON, 800000, 3300000,\n\t\t\t50000, &ldo5_dvs),\n\tBD71815_FIXED_REG(ldodvref, BD71815_LDODVREF, BD71815_REG_LDO_MODE4,\n\t\t\t  DVREF_RUN_ON, 3000000, &dvref_dvs),\n\tBD71815_FIXED_REG(ldolpsr, BD71815_LDOLPSR, BD71815_REG_LDO_MODE4,\n\t\t\t  LDO_LPSR_RUN_ON, 1800000, &ldolpsr_dvs),\n\tBD71815_LED_REG(wled, BD71815_WLED, BD71815_REG_LED_DIMM, LED_DIMM_MASK,\n\t\t\tBD71815_REG_LED_CTRL, LED_RUN_ON,\n\t\t\tbd7181x_wled_currents),\n};\n\nstatic int bd7181x_probe(struct platform_device *pdev)\n{\n\tstruct regulator_config config = {};\n\tint i, ret;\n\tstruct gpio_desc *ldo4_en;\n\tstruct regmap *regmap;\n\n\tregmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!regmap) {\n\t\tdev_err(&pdev->dev, \"No parent regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tldo4_en = devm_fwnode_gpiod_get(&pdev->dev,\n\t\t\t\t\tdev_fwnode(pdev->dev.parent),\n\t\t\t\t\t\"rohm,vsel\", GPIOD_ASIS, \"ldo4-en\");\n\tif (IS_ERR(ldo4_en)) {\n\t\tret = PTR_ERR(ldo4_en);\n\t\tif (ret != -ENOENT)\n\t\t\treturn ret;\n\t\tldo4_en = NULL;\n\t}\n\n\t \n\tret = regmap_update_bits(regmap, BD71815_REG_PWRCTRL, RESTARTEN, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tconfig.dev = pdev->dev.parent;\n\tconfig.regmap = regmap;\n\n\tfor (i = 0; i < BD71815_REGULATOR_CNT; i++) {\n\t\tconst struct regulator_desc *desc;\n\t\tstruct regulator_dev *rdev;\n\n\t\tdesc = &bd71815_regulators[i].desc;\n\n\t\tif (i == BD71815_LDO4)\n\t\t\tconfig.ena_gpiod = ldo4_en;\n\t\telse\n\t\t\tconfig.ena_gpiod = NULL;\n\n\t\trdev = devm_regulator_register(&pdev->dev, desc, &config);\n\t\tif (IS_ERR(rdev))\n\t\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(rdev),\n\t\t\t\t\t     \"failed to register %s regulator\\n\",\n\t\t\t\t\t     desc->name);\n\t}\n\treturn 0;\n}\n\nstatic const struct platform_device_id bd7181x_pmic_id[] = {\n\t{ \"bd71815-pmic\", ROHM_CHIP_TYPE_BD71815 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, bd7181x_pmic_id);\n\nstatic struct platform_driver bd7181x_regulator = {\n\t.driver = {\n\t\t.name = \"bd7181x-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = bd7181x_probe,\n\t.id_table = bd7181x_pmic_id,\n};\nmodule_platform_driver(bd7181x_regulator);\n\nMODULE_AUTHOR(\"Tony Luo <luofc@embedinfo.com>\");\nMODULE_DESCRIPTION(\"BD71815 voltage regulator driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:bd7181x-pmic\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}