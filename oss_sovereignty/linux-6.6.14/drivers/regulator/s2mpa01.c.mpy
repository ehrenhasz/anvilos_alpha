{
  "module_name": "s2mpa01.c",
  "hash_id": "5bfa97b7aa0821f69b7b7fb1bb357f771be4d9c77ed1b490516ff1a7d9a37f47",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/s2mpa01.c",
  "human_readable_source": "\n\n\n\n\n#include <linux/bug.h>\n#include <linux/err.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/mfd/samsung/core.h>\n#include <linux/mfd/samsung/s2mpa01.h>\n\nstruct s2mpa01_info {\n\tint ramp_delay24;\n\tint ramp_delay3;\n\tint ramp_delay5;\n\tint ramp_delay16;\n\tint ramp_delay7;\n\tint ramp_delay8910;\n};\n\nstatic int get_ramp_delay(int ramp_delay)\n{\n\tunsigned char cnt = 0;\n\n\tramp_delay /= 6250;\n\n\twhile (true) {\n\t\tramp_delay = ramp_delay >> 1;\n\t\tif (ramp_delay == 0)\n\t\t\tbreak;\n\t\tcnt++;\n\t}\n\n\tif (cnt > 3)\n\t\tcnt = 3;\n\n\treturn cnt;\n}\n\nstatic int s2mpa01_regulator_set_voltage_time_sel(struct regulator_dev *rdev,\n\t\t\t\t   unsigned int old_selector,\n\t\t\t\t   unsigned int new_selector)\n{\n\tstruct s2mpa01_info *s2mpa01 = rdev_get_drvdata(rdev);\n\tunsigned int ramp_delay = 0;\n\tint old_volt, new_volt;\n\n\tswitch (rdev_get_id(rdev)) {\n\tcase S2MPA01_BUCK2:\n\tcase S2MPA01_BUCK4:\n\t\tramp_delay = s2mpa01->ramp_delay24;\n\t\tbreak;\n\tcase S2MPA01_BUCK3:\n\t\tramp_delay = s2mpa01->ramp_delay3;\n\t\tbreak;\n\tcase S2MPA01_BUCK5:\n\t\tramp_delay = s2mpa01->ramp_delay5;\n\t\tbreak;\n\tcase S2MPA01_BUCK1:\n\tcase S2MPA01_BUCK6:\n\t\tramp_delay = s2mpa01->ramp_delay16;\n\t\tbreak;\n\tcase S2MPA01_BUCK7:\n\t\tramp_delay = s2mpa01->ramp_delay7;\n\t\tbreak;\n\tcase S2MPA01_BUCK8:\n\tcase S2MPA01_BUCK9:\n\tcase S2MPA01_BUCK10:\n\t\tramp_delay = s2mpa01->ramp_delay8910;\n\t\tbreak;\n\t}\n\n\tif (ramp_delay == 0)\n\t\tramp_delay = rdev->desc->ramp_delay;\n\n\told_volt = rdev->desc->min_uV + (rdev->desc->uV_step * old_selector);\n\tnew_volt = rdev->desc->min_uV + (rdev->desc->uV_step * new_selector);\n\n\treturn DIV_ROUND_UP(abs(new_volt - old_volt), ramp_delay);\n}\n\nstatic int s2mpa01_set_ramp_delay(struct regulator_dev *rdev, int ramp_delay)\n{\n\tstruct s2mpa01_info *s2mpa01 = rdev_get_drvdata(rdev);\n\tunsigned int ramp_val, ramp_shift, ramp_reg = S2MPA01_REG_RAMP2;\n\tunsigned int ramp_enable = 1, enable_shift = 0;\n\tint ret;\n\n\tswitch (rdev_get_id(rdev)) {\n\tcase S2MPA01_BUCK1:\n\t\tenable_shift = S2MPA01_BUCK1_RAMP_EN_SHIFT;\n\t\tif (!ramp_delay) {\n\t\t\tramp_enable = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (ramp_delay > s2mpa01->ramp_delay16)\n\t\t\ts2mpa01->ramp_delay16 = ramp_delay;\n\t\telse\n\t\t\tramp_delay = s2mpa01->ramp_delay16;\n\n\t\tramp_shift = S2MPA01_BUCK16_RAMP_SHIFT;\n\t\tbreak;\n\tcase S2MPA01_BUCK2:\n\t\tenable_shift = S2MPA01_BUCK2_RAMP_EN_SHIFT;\n\t\tif (!ramp_delay) {\n\t\t\tramp_enable = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (ramp_delay > s2mpa01->ramp_delay24)\n\t\t\ts2mpa01->ramp_delay24 = ramp_delay;\n\t\telse\n\t\t\tramp_delay = s2mpa01->ramp_delay24;\n\n\t\tramp_shift = S2MPA01_BUCK24_RAMP_SHIFT;\n\t\tramp_reg = S2MPA01_REG_RAMP1;\n\t\tbreak;\n\tcase S2MPA01_BUCK3:\n\t\tenable_shift = S2MPA01_BUCK3_RAMP_EN_SHIFT;\n\t\tif (!ramp_delay) {\n\t\t\tramp_enable = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\ts2mpa01->ramp_delay3 = ramp_delay;\n\t\tramp_shift = S2MPA01_BUCK3_RAMP_SHIFT;\n\t\tramp_reg = S2MPA01_REG_RAMP1;\n\t\tbreak;\n\tcase S2MPA01_BUCK4:\n\t\tenable_shift = S2MPA01_BUCK4_RAMP_EN_SHIFT;\n\t\tif (!ramp_delay) {\n\t\t\tramp_enable = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (ramp_delay > s2mpa01->ramp_delay24)\n\t\t\ts2mpa01->ramp_delay24 = ramp_delay;\n\t\telse\n\t\t\tramp_delay = s2mpa01->ramp_delay24;\n\n\t\tramp_shift = S2MPA01_BUCK24_RAMP_SHIFT;\n\t\tramp_reg = S2MPA01_REG_RAMP1;\n\t\tbreak;\n\tcase S2MPA01_BUCK5:\n\t\ts2mpa01->ramp_delay5 = ramp_delay;\n\t\tramp_shift = S2MPA01_BUCK5_RAMP_SHIFT;\n\t\tbreak;\n\tcase S2MPA01_BUCK6:\n\t\tif (ramp_delay > s2mpa01->ramp_delay16)\n\t\t\ts2mpa01->ramp_delay16 = ramp_delay;\n\t\telse\n\t\t\tramp_delay = s2mpa01->ramp_delay16;\n\n\t\tramp_shift = S2MPA01_BUCK16_RAMP_SHIFT;\n\t\tbreak;\n\tcase S2MPA01_BUCK7:\n\t\ts2mpa01->ramp_delay7 = ramp_delay;\n\t\tramp_shift = S2MPA01_BUCK7_RAMP_SHIFT;\n\t\tbreak;\n\tcase S2MPA01_BUCK8:\n\tcase S2MPA01_BUCK9:\n\tcase S2MPA01_BUCK10:\n\t\tif (ramp_delay > s2mpa01->ramp_delay8910)\n\t\t\ts2mpa01->ramp_delay8910 = ramp_delay;\n\t\telse\n\t\t\tramp_delay = s2mpa01->ramp_delay8910;\n\n\t\tramp_shift = S2MPA01_BUCK8910_RAMP_SHIFT;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tif (!ramp_enable)\n\t\tgoto ramp_disable;\n\n\t \n\tif (rdev_get_id(rdev) >= S2MPA01_BUCK1 &&\n\t\t\trdev_get_id(rdev) <= S2MPA01_BUCK4) {\n\t\tret = regmap_update_bits(rdev->regmap, S2MPA01_REG_RAMP1,\n\t\t\t\t\t 1 << enable_shift, 1 << enable_shift);\n\t\tif (ret) {\n\t\t\tdev_err(&rdev->dev, \"failed to enable ramp rate\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tramp_val = get_ramp_delay(ramp_delay);\n\n\treturn regmap_update_bits(rdev->regmap, ramp_reg, 0x3 << ramp_shift,\n\t\t\t\t  ramp_val << ramp_shift);\n\nramp_disable:\n\treturn regmap_update_bits(rdev->regmap, S2MPA01_REG_RAMP1,\n\t\t\t\t  1 << enable_shift, 0);\n}\n\nstatic const struct regulator_ops s2mpa01_ldo_ops = {\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.set_voltage_time_sel\t= regulator_set_voltage_time_sel,\n};\n\nstatic const struct regulator_ops s2mpa01_buck_ops = {\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.set_voltage_time_sel\t= s2mpa01_regulator_set_voltage_time_sel,\n\t.set_ramp_delay\t\t= s2mpa01_set_ramp_delay,\n};\n\n#define regulator_desc_ldo(num, step) {\t\t\t\\\n\t.name\t\t= \"LDO\"#num,\t\t\t\\\n\t.of_match\t= of_match_ptr(\"LDO\"#num),\t\\\n\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t.id\t\t= S2MPA01_LDO##num,\t\t\\\n\t.ops\t\t= &s2mpa01_ldo_ops,\t\t\\\n\t.type\t\t= REGULATOR_VOLTAGE,\t\t\\\n\t.owner\t\t= THIS_MODULE,\t\t\t\\\n\t.min_uV\t\t= MIN_800_MV,\t\t\t\\\n\t.uV_step\t= step,\t\t\t\t\\\n\t.n_voltages\t= S2MPA01_LDO_N_VOLTAGES,\t\\\n\t.vsel_reg\t= S2MPA01_REG_L1CTRL + num - 1,\t\\\n\t.vsel_mask\t= S2MPA01_LDO_VSEL_MASK,\t\\\n\t.enable_reg\t= S2MPA01_REG_L1CTRL + num - 1,\t\\\n\t.enable_mask\t= S2MPA01_ENABLE_MASK\t\t\\\n}\n\n#define regulator_desc_buck1_4(num)\t{\t\t\t\\\n\t.name\t\t= \"BUCK\"#num,\t\t\t\t\\\n\t.of_match\t= of_match_ptr(\"BUCK\"#num),\t\t\\\n\t.regulators_node = of_match_ptr(\"regulators\"),\t\t\\\n\t.id\t\t= S2MPA01_BUCK##num,\t\t\t\\\n\t.ops\t\t= &s2mpa01_buck_ops,\t\t\t\\\n\t.type\t\t= REGULATOR_VOLTAGE,\t\t\t\\\n\t.owner\t\t= THIS_MODULE,\t\t\t\t\\\n\t.min_uV\t\t= MIN_600_MV,\t\t\t\t\\\n\t.uV_step\t= STEP_6_25_MV,\t\t\t\t\\\n\t.n_voltages\t= S2MPA01_BUCK_N_VOLTAGES,\t\t\\\n\t.ramp_delay\t= S2MPA01_RAMP_DELAY,\t\t\t\\\n\t.vsel_reg\t= S2MPA01_REG_B1CTRL2 + (num - 1) * 2,\t\\\n\t.vsel_mask\t= S2MPA01_BUCK_VSEL_MASK,\t\t\\\n\t.enable_reg\t= S2MPA01_REG_B1CTRL1 + (num - 1) * 2,\t\\\n\t.enable_mask\t= S2MPA01_ENABLE_MASK\t\t\t\\\n}\n\n#define regulator_desc_buck5\t{\t\t\t\t\\\n\t.name\t\t= \"BUCK5\",\t\t\t\t\\\n\t.of_match\t= of_match_ptr(\"BUCK5\"),\t\t\\\n\t.regulators_node = of_match_ptr(\"regulators\"),\t\t\\\n\t.id\t\t= S2MPA01_BUCK5,\t\t\t\\\n\t.ops\t\t= &s2mpa01_buck_ops,\t\t\t\\\n\t.type\t\t= REGULATOR_VOLTAGE,\t\t\t\\\n\t.owner\t\t= THIS_MODULE,\t\t\t\t\\\n\t.min_uV\t\t= MIN_800_MV,\t\t\t\t\\\n\t.uV_step\t= STEP_6_25_MV,\t\t\t\t\\\n\t.n_voltages\t= S2MPA01_BUCK_N_VOLTAGES,\t\t\\\n\t.ramp_delay\t= S2MPA01_RAMP_DELAY,\t\t\t\\\n\t.vsel_reg\t= S2MPA01_REG_B5CTRL2,\t\t\t\\\n\t.vsel_mask\t= S2MPA01_BUCK_VSEL_MASK,\t\t\\\n\t.enable_reg\t= S2MPA01_REG_B5CTRL1,\t\t\t\\\n\t.enable_mask\t= S2MPA01_ENABLE_MASK\t\t\t\\\n}\n\n#define regulator_desc_buck6_10(num, min, step) {\t\t\t\\\n\t.name\t\t= \"BUCK\"#num,\t\t\t\t\\\n\t.of_match\t= of_match_ptr(\"BUCK\"#num),\t\t\\\n\t.regulators_node = of_match_ptr(\"regulators\"),\t\t\\\n\t.id\t\t= S2MPA01_BUCK##num,\t\t\t\\\n\t.ops\t\t= &s2mpa01_buck_ops,\t\t\t\\\n\t.type\t\t= REGULATOR_VOLTAGE,\t\t\t\\\n\t.owner\t\t= THIS_MODULE,\t\t\t\t\\\n\t.min_uV\t\t= min,\t\t\t\t\t\\\n\t.uV_step\t= step,\t\t\t\t\t\\\n\t.n_voltages\t= S2MPA01_BUCK_N_VOLTAGES,\t\t\\\n\t.ramp_delay\t= S2MPA01_RAMP_DELAY,\t\t\t\\\n\t.vsel_reg\t= S2MPA01_REG_B6CTRL2 + (num - 6) * 2,\t\\\n\t.vsel_mask\t= S2MPA01_BUCK_VSEL_MASK,\t\t\\\n\t.enable_reg\t= S2MPA01_REG_B6CTRL1 + (num - 6) * 2,\t\\\n\t.enable_mask\t= S2MPA01_ENABLE_MASK\t\t\t\\\n}\n\nstatic const struct regulator_desc regulators[] = {\n\tregulator_desc_ldo(1, STEP_25_MV),\n\tregulator_desc_ldo(2, STEP_50_MV),\n\tregulator_desc_ldo(3, STEP_50_MV),\n\tregulator_desc_ldo(4, STEP_50_MV),\n\tregulator_desc_ldo(5, STEP_25_MV),\n\tregulator_desc_ldo(6, STEP_25_MV),\n\tregulator_desc_ldo(7, STEP_50_MV),\n\tregulator_desc_ldo(8, STEP_50_MV),\n\tregulator_desc_ldo(9, STEP_50_MV),\n\tregulator_desc_ldo(10, STEP_50_MV),\n\tregulator_desc_ldo(11, STEP_50_MV),\n\tregulator_desc_ldo(12, STEP_50_MV),\n\tregulator_desc_ldo(13, STEP_50_MV),\n\tregulator_desc_ldo(14, STEP_50_MV),\n\tregulator_desc_ldo(15, STEP_50_MV),\n\tregulator_desc_ldo(16, STEP_50_MV),\n\tregulator_desc_ldo(17, STEP_50_MV),\n\tregulator_desc_ldo(18, STEP_50_MV),\n\tregulator_desc_ldo(19, STEP_50_MV),\n\tregulator_desc_ldo(20, STEP_50_MV),\n\tregulator_desc_ldo(21, STEP_50_MV),\n\tregulator_desc_ldo(22, STEP_50_MV),\n\tregulator_desc_ldo(23, STEP_50_MV),\n\tregulator_desc_ldo(24, STEP_50_MV),\n\tregulator_desc_ldo(25, STEP_50_MV),\n\tregulator_desc_ldo(26, STEP_25_MV),\n\tregulator_desc_buck1_4(1),\n\tregulator_desc_buck1_4(2),\n\tregulator_desc_buck1_4(3),\n\tregulator_desc_buck1_4(4),\n\tregulator_desc_buck5,\n\tregulator_desc_buck6_10(6, MIN_600_MV, STEP_6_25_MV),\n\tregulator_desc_buck6_10(7, MIN_600_MV, STEP_6_25_MV),\n\tregulator_desc_buck6_10(8, MIN_800_MV, STEP_12_5_MV),\n\tregulator_desc_buck6_10(9, MIN_1500_MV, STEP_12_5_MV),\n\tregulator_desc_buck6_10(10, MIN_1000_MV, STEP_12_5_MV),\n};\n\nstatic int s2mpa01_pmic_probe(struct platform_device *pdev)\n{\n\tstruct sec_pmic_dev *iodev = dev_get_drvdata(pdev->dev.parent);\n\tstruct regulator_config config = { };\n\tstruct s2mpa01_info *s2mpa01;\n\tint i;\n\n\ts2mpa01 = devm_kzalloc(&pdev->dev, sizeof(*s2mpa01), GFP_KERNEL);\n\tif (!s2mpa01)\n\t\treturn -ENOMEM;\n\n\tconfig.dev = iodev->dev;\n\tconfig.regmap = iodev->regmap_pmic;\n\tconfig.driver_data = s2mpa01;\n\n\tfor (i = 0; i < S2MPA01_REGULATOR_MAX; i++) {\n\t\tstruct regulator_dev *rdev;\n\n\t\trdev = devm_regulator_register(&pdev->dev,\n\t\t\t\t\t\t&regulators[i], &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(&pdev->dev, \"regulator init failed for %d\\n\",\n\t\t\t\ti);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id s2mpa01_pmic_id[] = {\n\t{ \"s2mpa01-pmic\", 0},\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, s2mpa01_pmic_id);\n\nstatic struct platform_driver s2mpa01_pmic_driver = {\n\t.driver = {\n\t\t.name = \"s2mpa01-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = s2mpa01_pmic_probe,\n\t.id_table = s2mpa01_pmic_id,\n};\n\nmodule_platform_driver(s2mpa01_pmic_driver);\n\n \nMODULE_AUTHOR(\"Sangbeom Kim <sbkim73@samsung.com>\");\nMODULE_AUTHOR(\"Sachin Kamat <sachin.kamat@samsung.com>\");\nMODULE_DESCRIPTION(\"Samsung S2MPA01 Regulator Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}