{
  "module_name": "max8998.c",
  "hash_id": "e52a49eb62e37191b222cf718e1b674c80313db9d41ae1b8783840d90fafa13b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max8998.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/i2c.h>\n#include <linux/err.h>\n#include <linux/gpio.h>\n#include <linux/slab.h>\n#include <linux/interrupt.h>\n#include <linux/mutex.h>\n#include <linux/of.h>\n#include <linux/of_gpio.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/mfd/max8998.h>\n#include <linux/mfd/max8998-private.h>\n\nstruct max8998_data {\n\tstruct device\t\t*dev;\n\tstruct max8998_dev\t*iodev;\n\tint\t\t\tnum_regulators;\n\tu8                      buck1_vol[4];  \n\tu8                      buck2_vol[2];\n\tunsigned int\t\tbuck1_idx;  \n\t\t\t\t\t    \n\tunsigned int\t\tbuck2_idx;\n};\n\nstatic const unsigned int charger_current_table[] = {\n\t90000, 380000, 475000, 550000, 570000, 600000, 700000, 800000,\n};\n\nstatic int max8998_get_enable_register(struct regulator_dev *rdev,\n\t\t\t\t\tint *reg, int *shift)\n{\n\tint ldo = rdev_get_id(rdev);\n\n\tswitch (ldo) {\n\tcase MAX8998_LDO2 ... MAX8998_LDO5:\n\t\t*reg = MAX8998_REG_ONOFF1;\n\t\t*shift = 3 - (ldo - MAX8998_LDO2);\n\t\tbreak;\n\tcase MAX8998_LDO6 ... MAX8998_LDO13:\n\t\t*reg = MAX8998_REG_ONOFF2;\n\t\t*shift = 7 - (ldo - MAX8998_LDO6);\n\t\tbreak;\n\tcase MAX8998_LDO14 ... MAX8998_LDO17:\n\t\t*reg = MAX8998_REG_ONOFF3;\n\t\t*shift = 7 - (ldo - MAX8998_LDO14);\n\t\tbreak;\n\tcase MAX8998_BUCK1 ... MAX8998_BUCK4:\n\t\t*reg = MAX8998_REG_ONOFF1;\n\t\t*shift = 7 - (ldo - MAX8998_BUCK1);\n\t\tbreak;\n\tcase MAX8998_EN32KHZ_AP ... MAX8998_ENVICHG:\n\t\t*reg = MAX8998_REG_ONOFF4;\n\t\t*shift = 7 - (ldo - MAX8998_EN32KHZ_AP);\n\t\tbreak;\n\tcase MAX8998_ESAFEOUT1 ... MAX8998_ESAFEOUT2:\n\t\t*reg = MAX8998_REG_CHGR2;\n\t\t*shift = 7 - (ldo - MAX8998_ESAFEOUT1);\n\t\tbreak;\n\tcase MAX8998_CHARGER:\n\t\t*reg = MAX8998_REG_CHGR2;\n\t\t*shift = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max8998_ldo_is_enabled(struct regulator_dev *rdev)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint ret, reg, shift = 8;\n\tu8 val;\n\n\tret = max8998_get_enable_register(rdev, &reg, &shift);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max8998_read_reg(i2c, reg, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn val & (1 << shift);\n}\n\nstatic int max8998_ldo_is_enabled_inverted(struct regulator_dev *rdev)\n{\n\treturn (!max8998_ldo_is_enabled(rdev));\n}\n\nstatic int max8998_ldo_enable(struct regulator_dev *rdev)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint reg, shift = 8, ret;\n\n\tret = max8998_get_enable_register(rdev, &reg, &shift);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max8998_update_reg(i2c, reg, 1<<shift, 1<<shift);\n}\n\nstatic int max8998_ldo_disable(struct regulator_dev *rdev)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint reg, shift = 8, ret;\n\n\tret = max8998_get_enable_register(rdev, &reg, &shift);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max8998_update_reg(i2c, reg, 0, 1<<shift);\n}\n\nstatic int max8998_get_voltage_register(struct regulator_dev *rdev,\n\t\t\t\tint *_reg, int *_shift, int *_mask)\n{\n\tint ldo = rdev_get_id(rdev);\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tint reg, shift = 0, mask = 0xff;\n\n\tswitch (ldo) {\n\tcase MAX8998_LDO2 ... MAX8998_LDO3:\n\t\treg = MAX8998_REG_LDO2_LDO3;\n\t\tmask = 0xf;\n\t\tif (ldo == MAX8998_LDO2)\n\t\t\tshift = 4;\n\t\telse\n\t\t\tshift = 0;\n\t\tbreak;\n\tcase MAX8998_LDO4 ... MAX8998_LDO7:\n\t\treg = MAX8998_REG_LDO4 + (ldo - MAX8998_LDO4);\n\t\tbreak;\n\tcase MAX8998_LDO8 ... MAX8998_LDO9:\n\t\treg = MAX8998_REG_LDO8_LDO9;\n\t\tmask = 0xf;\n\t\tif (ldo == MAX8998_LDO8)\n\t\t\tshift = 4;\n\t\telse\n\t\t\tshift = 0;\n\t\tbreak;\n\tcase MAX8998_LDO10 ... MAX8998_LDO11:\n\t\treg = MAX8998_REG_LDO10_LDO11;\n\t\tif (ldo == MAX8998_LDO10) {\n\t\t\tshift = 5;\n\t\t\tmask = 0x7;\n\t\t} else {\n\t\t\tshift = 0;\n\t\t\tmask = 0x1f;\n\t\t}\n\t\tbreak;\n\tcase MAX8998_LDO12 ... MAX8998_LDO17:\n\t\treg = MAX8998_REG_LDO12 + (ldo - MAX8998_LDO12);\n\t\tbreak;\n\tcase MAX8998_BUCK1:\n\t\treg = MAX8998_REG_BUCK1_VOLTAGE1 + max8998->buck1_idx;\n\t\tbreak;\n\tcase MAX8998_BUCK2:\n\t\treg = MAX8998_REG_BUCK2_VOLTAGE1 + max8998->buck2_idx;\n\t\tbreak;\n\tcase MAX8998_BUCK3:\n\t\treg = MAX8998_REG_BUCK3;\n\t\tbreak;\n\tcase MAX8998_BUCK4:\n\t\treg = MAX8998_REG_BUCK4;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t*_reg = reg;\n\t*_shift = shift;\n\t*_mask = mask;\n\n\treturn 0;\n}\n\nstatic int max8998_get_voltage_sel(struct regulator_dev *rdev)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint reg, shift = 0, mask, ret;\n\tu8 val;\n\n\tret = max8998_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max8998_read_reg(i2c, reg, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tval >>= shift;\n\tval &= mask;\n\n\treturn val;\n}\n\nstatic int max8998_set_voltage_ldo_sel(struct regulator_dev *rdev,\n\t\t\t\t       unsigned selector)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint reg, shift = 0, mask, ret;\n\n\tret = max8998_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max8998_update_reg(i2c, reg, selector<<shift, mask<<shift);\n\n\treturn ret;\n}\n\nstatic inline void buck1_gpio_set(int gpio1, int gpio2, int v)\n{\n\tgpio_set_value(gpio1, v & 0x1);\n\tgpio_set_value(gpio2, (v >> 1) & 0x1);\n}\n\nstatic inline void buck2_gpio_set(int gpio, int v)\n{\n\tgpio_set_value(gpio, v & 0x1);\n}\n\nstatic int max8998_set_voltage_buck_sel(struct regulator_dev *rdev,\n\t\t\t\t\tunsigned selector)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct max8998_platform_data *pdata = max8998->iodev->pdata;\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint buck = rdev_get_id(rdev);\n\tint reg, shift = 0, mask, ret, j;\n\tstatic u8 buck1_last_val;\n\n\tret = max8998_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (buck) {\n\tcase MAX8998_BUCK1:\n\t\tdev_dbg(max8998->dev,\n\t\t\t\"BUCK1, selector:%d, buck1_vol1:%d, buck1_vol2:%d\\n\"\n\t\t\t\"buck1_vol3:%d, buck1_vol4:%d\\n\",\n\t\t\tselector, max8998->buck1_vol[0], max8998->buck1_vol[1],\n\t\t\tmax8998->buck1_vol[2], max8998->buck1_vol[3]);\n\n\t\tif (gpio_is_valid(pdata->buck1_set1) &&\n\t\t    gpio_is_valid(pdata->buck1_set2)) {\n\n\t\t\t \n\t\t\t \n\t\t\tfor (j = 0; j < ARRAY_SIZE(max8998->buck1_vol); j++) {\n\t\t\t\tif (max8998->buck1_vol[j] == selector) {\n\t\t\t\t\tmax8998->buck1_idx = j;\n\t\t\t\t\tbuck1_gpio_set(pdata->buck1_set1,\n\t\t\t\t\t\t       pdata->buck1_set2, j);\n\t\t\t\t\tgoto buck1_exit;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (pdata->buck_voltage_lock)\n\t\t\t\treturn -EINVAL;\n\n\t\t\t \n\t\t\tmax8998->buck1_idx = (buck1_last_val % 2) + 2;\n\t\t\tdev_dbg(max8998->dev, \"max8998->buck1_idx:%d\\n\",\n\t\t\t\tmax8998->buck1_idx);\n\t\t\tmax8998->buck1_vol[max8998->buck1_idx] = selector;\n\t\t\tret = max8998_get_voltage_register(rdev, &reg,\n\t\t\t\t\t\t\t   &shift,\n\t\t\t\t\t\t\t   &mask);\n\t\t\tret = max8998_write_reg(i2c, reg, selector);\n\t\t\tbuck1_gpio_set(pdata->buck1_set1,\n\t\t\t\t       pdata->buck1_set2, max8998->buck1_idx);\n\t\t\tbuck1_last_val++;\nbuck1_exit:\n\t\t\tdev_dbg(max8998->dev, \"%s: SET1:%d, SET2:%d\\n\",\n\t\t\t\ti2c->name, gpio_get_value(pdata->buck1_set1),\n\t\t\t\tgpio_get_value(pdata->buck1_set2));\n\t\t\tbreak;\n\t\t} else {\n\t\t\tret = max8998_write_reg(i2c, reg, selector);\n\t\t}\n\t\tbreak;\n\n\tcase MAX8998_BUCK2:\n\t\tdev_dbg(max8998->dev,\n\t\t\t\"BUCK2, selector:%d buck2_vol1:%d, buck2_vol2:%d\\n\",\n\t\t\tselector, max8998->buck2_vol[0], max8998->buck2_vol[1]);\n\t\tif (gpio_is_valid(pdata->buck2_set3)) {\n\n\t\t\t \n\t\t\t \n\t\t\tfor (j = 0; j < ARRAY_SIZE(max8998->buck2_vol); j++) {\n\t\t\t\tif (max8998->buck2_vol[j] == selector) {\n\t\t\t\t\tmax8998->buck2_idx = j;\n\t\t\t\t\tbuck2_gpio_set(pdata->buck2_set3, j);\n\t\t\t\t\tgoto buck2_exit;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (pdata->buck_voltage_lock)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tmax8998_get_voltage_register(rdev,\n\t\t\t\t\t&reg, &shift, &mask);\n\t\t\tret = max8998_write_reg(i2c, reg, selector);\n\t\t\tmax8998->buck2_vol[max8998->buck2_idx] = selector;\n\t\t\tbuck2_gpio_set(pdata->buck2_set3, max8998->buck2_idx);\nbuck2_exit:\n\t\t\tdev_dbg(max8998->dev, \"%s: SET3:%d\\n\", i2c->name,\n\t\t\t\tgpio_get_value(pdata->buck2_set3));\n\t\t} else {\n\t\t\tret = max8998_write_reg(i2c, reg, selector);\n\t\t}\n\t\tbreak;\n\n\tcase MAX8998_BUCK3:\n\tcase MAX8998_BUCK4:\n\t\tret = max8998_update_reg(i2c, reg, selector<<shift,\n\t\t\t\t\t mask<<shift);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic int max8998_set_voltage_buck_time_sel(struct regulator_dev *rdev,\n\t\t\t\t\t     unsigned int old_selector,\n\t\t\t\t\t     unsigned int new_selector)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tint buck = rdev_get_id(rdev);\n\tu8 val = 0;\n\tint difference, ret;\n\n\tif (buck < MAX8998_BUCK1 || buck > MAX8998_BUCK4)\n\t\treturn -EINVAL;\n\n\t \n\tret = max8998_read_reg(i2c, MAX8998_REG_ONOFF4, &val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\t \n\tif (max8998->iodev->type == TYPE_MAX8998 && !(val & MAX8998_ENRAMP))\n\t\treturn 0;\n\n\tdifference = (new_selector - old_selector) * rdev->desc->uV_step / 1000;\n\tif (difference > 0)\n\t\treturn DIV_ROUND_UP(difference, (val & 0x0f) + 1);\n\n\treturn 0;\n}\n\nstatic int max8998_set_current_limit(struct regulator_dev *rdev,\n\t\t\t\t     int min_uA, int max_uA)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tunsigned int n_currents = rdev->desc->n_current_limits;\n\tint i, sel = -1;\n\n\tif (n_currents == 0)\n\t\treturn -EINVAL;\n\n\tif (rdev->desc->curr_table) {\n\t\tconst unsigned int *curr_table = rdev->desc->curr_table;\n\t\tbool ascend = curr_table[n_currents - 1] > curr_table[0];\n\n\t\t \n\t\tif (ascend) {\n\t\t\tfor (i = n_currents - 1; i >= 0; i--) {\n\t\t\t\tif (min_uA <= curr_table[i] &&\n\t\t\t\t    curr_table[i] <= max_uA) {\n\t\t\t\t\tsel = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (i = 0; i < n_currents; i++) {\n\t\t\t\tif (min_uA <= curr_table[i] &&\n\t\t\t\t    curr_table[i] <= max_uA) {\n\t\t\t\t\tsel = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (sel < 0)\n\t\treturn -EINVAL;\n\n\tsel <<= ffs(rdev->desc->csel_mask) - 1;\n\n\treturn max8998_update_reg(i2c, rdev->desc->csel_reg,\n\t\t\t\t  sel, rdev->desc->csel_mask);\n}\n\nstatic int max8998_get_current_limit(struct regulator_dev *rdev)\n{\n\tstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8998->iodev->i2c;\n\tu8 val;\n\tint ret;\n\n\tret = max8998_read_reg(i2c, rdev->desc->csel_reg, &val);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tval &= rdev->desc->csel_mask;\n\tval >>= ffs(rdev->desc->csel_mask) - 1;\n\n\tif (rdev->desc->curr_table) {\n\t\tif (val >= rdev->desc->n_current_limits)\n\t\t\treturn -EINVAL;\n\n\t\treturn rdev->desc->curr_table[val];\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct regulator_ops max8998_ldo_ops = {\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.is_enabled\t\t= max8998_ldo_is_enabled,\n\t.enable\t\t\t= max8998_ldo_enable,\n\t.disable\t\t= max8998_ldo_disable,\n\t.get_voltage_sel\t= max8998_get_voltage_sel,\n\t.set_voltage_sel\t= max8998_set_voltage_ldo_sel,\n};\n\nstatic const struct regulator_ops max8998_buck_ops = {\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.is_enabled\t\t= max8998_ldo_is_enabled,\n\t.enable\t\t\t= max8998_ldo_enable,\n\t.disable\t\t= max8998_ldo_disable,\n\t.get_voltage_sel\t= max8998_get_voltage_sel,\n\t.set_voltage_sel\t= max8998_set_voltage_buck_sel,\n\t.set_voltage_time_sel\t= max8998_set_voltage_buck_time_sel,\n};\n\nstatic const struct regulator_ops max8998_charger_ops = {\n\t.set_current_limit\t= max8998_set_current_limit,\n\t.get_current_limit\t= max8998_get_current_limit,\n\t.is_enabled\t\t= max8998_ldo_is_enabled_inverted,\n\t \n\t.enable\t\t\t= max8998_ldo_disable,\n\t.disable\t\t= max8998_ldo_enable,\n};\n\nstatic const struct regulator_ops max8998_others_ops = {\n\t.is_enabled\t\t= max8998_ldo_is_enabled,\n\t.enable\t\t\t= max8998_ldo_enable,\n\t.disable\t\t= max8998_ldo_disable,\n};\n\n#define MAX8998_LINEAR_REG(_name, _ops, _min, _step, _max) \\\n\t{ \\\n\t\t.name = #_name, \\\n\t\t.id = MAX8998_##_name, \\\n\t\t.ops = _ops, \\\n\t\t.min_uV = (_min), \\\n\t\t.uV_step = (_step), \\\n\t\t.n_voltages = ((_max) - (_min)) / (_step) + 1, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t}\n\n#define MAX8998_CURRENT_REG(_name, _ops, _table, _reg, _mask) \\\n\t{ \\\n\t\t.name = #_name, \\\n\t\t.id = MAX8998_##_name, \\\n\t\t.ops = _ops, \\\n\t\t.curr_table = _table, \\\n\t\t.n_current_limits = ARRAY_SIZE(_table), \\\n\t\t.csel_reg = _reg, \\\n\t\t.csel_mask = _mask, \\\n\t\t.type = REGULATOR_CURRENT, \\\n\t\t.owner = THIS_MODULE, \\\n\t}\n\n#define MAX8998_OTHERS_REG(_name, _id) \\\n\t{ \\\n\t\t.name = #_name, \\\n\t\t.id = _id, \\\n\t\t.ops = &max8998_others_ops, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t}\n\nstatic const struct regulator_desc regulators[] = {\n\tMAX8998_LINEAR_REG(LDO2, &max8998_ldo_ops, 800000, 50000, 1300000),\n\tMAX8998_LINEAR_REG(LDO3, &max8998_ldo_ops, 800000, 50000, 1300000),\n\tMAX8998_LINEAR_REG(LDO4, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO5, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO6, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO7, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO8, &max8998_ldo_ops, 3000000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO9, &max8998_ldo_ops, 2800000, 100000, 3100000),\n\tMAX8998_LINEAR_REG(LDO10, &max8998_ldo_ops, 950000, 50000, 1300000),\n\tMAX8998_LINEAR_REG(LDO11, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO12, &max8998_ldo_ops, 800000, 100000, 3300000),\n\tMAX8998_LINEAR_REG(LDO13, &max8998_ldo_ops, 800000, 100000, 3300000),\n\tMAX8998_LINEAR_REG(LDO14, &max8998_ldo_ops, 1200000, 100000, 3300000),\n\tMAX8998_LINEAR_REG(LDO15, &max8998_ldo_ops, 1200000, 100000, 3300000),\n\tMAX8998_LINEAR_REG(LDO16, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(LDO17, &max8998_ldo_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(BUCK1, &max8998_buck_ops, 750000, 25000, 1525000),\n\tMAX8998_LINEAR_REG(BUCK2, &max8998_buck_ops, 750000, 25000, 1525000),\n\tMAX8998_LINEAR_REG(BUCK3, &max8998_buck_ops, 1600000, 100000, 3600000),\n\tMAX8998_LINEAR_REG(BUCK4, &max8998_buck_ops, 800000, 100000, 2300000),\n\tMAX8998_OTHERS_REG(EN32KHz-AP, MAX8998_EN32KHZ_AP),\n\tMAX8998_OTHERS_REG(EN32KHz-CP, MAX8998_EN32KHZ_CP),\n\tMAX8998_OTHERS_REG(ENVICHG, MAX8998_ENVICHG),\n\tMAX8998_OTHERS_REG(ESAFEOUT1, MAX8998_ESAFEOUT1),\n\tMAX8998_OTHERS_REG(ESAFEOUT2, MAX8998_ESAFEOUT2),\n\tMAX8998_CURRENT_REG(CHARGER, &max8998_charger_ops,\n\t\t\t    charger_current_table, MAX8998_REG_CHGR1, 0x7),\n};\n\nstatic int max8998_pmic_dt_parse_dvs_gpio(struct max8998_dev *iodev,\n\t\t\tstruct max8998_platform_data *pdata,\n\t\t\tstruct device_node *pmic_np)\n{\n\tint gpio;\n\n\tgpio = of_get_named_gpio(pmic_np, \"max8998,pmic-buck1-dvs-gpios\", 0);\n\tif (!gpio_is_valid(gpio)) {\n\t\tdev_err(iodev->dev, \"invalid buck1 gpio[0]: %d\\n\", gpio);\n\t\treturn -EINVAL;\n\t}\n\tpdata->buck1_set1 = gpio;\n\n\tgpio = of_get_named_gpio(pmic_np, \"max8998,pmic-buck1-dvs-gpios\", 1);\n\tif (!gpio_is_valid(gpio)) {\n\t\tdev_err(iodev->dev, \"invalid buck1 gpio[1]: %d\\n\", gpio);\n\t\treturn -EINVAL;\n\t}\n\tpdata->buck1_set2 = gpio;\n\n\tgpio = of_get_named_gpio(pmic_np, \"max8998,pmic-buck2-dvs-gpio\", 0);\n\tif (!gpio_is_valid(gpio)) {\n\t\tdev_err(iodev->dev, \"invalid buck 2 gpio: %d\\n\", gpio);\n\t\treturn -EINVAL;\n\t}\n\tpdata->buck2_set3 = gpio;\n\n\treturn 0;\n}\n\nstatic int max8998_pmic_dt_parse_pdata(struct max8998_dev *iodev,\n\t\t\t\t\tstruct max8998_platform_data *pdata)\n{\n\tstruct device_node *pmic_np = iodev->dev->of_node;\n\tstruct device_node *regulators_np, *reg_np;\n\tstruct max8998_regulator_data *rdata;\n\tunsigned int i;\n\tint ret;\n\n\tregulators_np = of_get_child_by_name(pmic_np, \"regulators\");\n\tif (!regulators_np) {\n\t\tdev_err(iodev->dev, \"could not find regulators sub-node\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tpdata->num_regulators = of_get_child_count(regulators_np);\n\n\trdata = devm_kcalloc(iodev->dev,\n\t\t\t     pdata->num_regulators, sizeof(*rdata),\n\t\t\t     GFP_KERNEL);\n\tif (!rdata) {\n\t\tof_node_put(regulators_np);\n\t\treturn -ENOMEM;\n\t}\n\n\tpdata->regulators = rdata;\n\tfor (i = 0; i < ARRAY_SIZE(regulators); ++i) {\n\t\treg_np = of_get_child_by_name(regulators_np,\n\t\t\t\t\t\t\tregulators[i].name);\n\t\tif (!reg_np)\n\t\t\tcontinue;\n\n\t\trdata->id = regulators[i].id;\n\t\trdata->initdata = of_get_regulator_init_data(iodev->dev,\n\t\t\t\t\t\t\t     reg_np,\n\t\t\t\t\t\t\t     &regulators[i]);\n\t\trdata->reg_node = reg_np;\n\t\t++rdata;\n\t}\n\tpdata->num_regulators = rdata - pdata->regulators;\n\n\tof_node_put(reg_np);\n\tof_node_put(regulators_np);\n\n\tret = max8998_pmic_dt_parse_dvs_gpio(iodev, pdata, pmic_np);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tpdata->buck_voltage_lock = of_property_read_bool(pmic_np, \"max8998,pmic-buck-voltage-lock\");\n\n\tret = of_property_read_u32(pmic_np,\n\t\t\t\t\t\"max8998,pmic-buck1-default-dvs-idx\",\n\t\t\t\t\t&pdata->buck1_default_idx);\n\tif (!ret && pdata->buck1_default_idx >= 4) {\n\t\tpdata->buck1_default_idx = 0;\n\t\tdev_warn(iodev->dev, \"invalid value for default dvs index, using 0 instead\\n\");\n\t}\n\n\tret = of_property_read_u32(pmic_np,\n\t\t\t\t\t\"max8998,pmic-buck2-default-dvs-idx\",\n\t\t\t\t\t&pdata->buck2_default_idx);\n\tif (!ret && pdata->buck2_default_idx >= 2) {\n\t\tpdata->buck2_default_idx = 0;\n\t\tdev_warn(iodev->dev, \"invalid value for default dvs index, using 0 instead\\n\");\n\t}\n\n\tret = of_property_read_u32_array(pmic_np,\n\t\t\t\t\t\"max8998,pmic-buck1-dvs-voltage\",\n\t\t\t\t\tpdata->buck1_voltage,\n\t\t\t\t\tARRAY_SIZE(pdata->buck1_voltage));\n\tif (ret) {\n\t\tdev_err(iodev->dev, \"buck1 voltages not specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = of_property_read_u32_array(pmic_np,\n\t\t\t\t\t\"max8998,pmic-buck2-dvs-voltage\",\n\t\t\t\t\tpdata->buck2_voltage,\n\t\t\t\t\tARRAY_SIZE(pdata->buck2_voltage));\n\tif (ret) {\n\t\tdev_err(iodev->dev, \"buck2 voltages not specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max8998_pmic_probe(struct platform_device *pdev)\n{\n\tstruct max8998_dev *iodev = dev_get_drvdata(pdev->dev.parent);\n\tstruct max8998_platform_data *pdata = iodev->pdata;\n\tstruct regulator_config config = { };\n\tstruct regulator_dev *rdev;\n\tstruct max8998_data *max8998;\n\tstruct i2c_client *i2c;\n\tint i, ret;\n\tunsigned int v;\n\n\tif (!pdata) {\n\t\tdev_err(pdev->dev.parent, \"No platform init data supplied\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (IS_ENABLED(CONFIG_OF) && iodev->dev->of_node) {\n\t\tret = max8998_pmic_dt_parse_pdata(iodev, pdata);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tmax8998 = devm_kzalloc(&pdev->dev, sizeof(struct max8998_data),\n\t\t\t       GFP_KERNEL);\n\tif (!max8998)\n\t\treturn -ENOMEM;\n\n\tmax8998->dev = &pdev->dev;\n\tmax8998->iodev = iodev;\n\tmax8998->num_regulators = pdata->num_regulators;\n\tplatform_set_drvdata(pdev, max8998);\n\ti2c = max8998->iodev->i2c;\n\n\tmax8998->buck1_idx = pdata->buck1_default_idx;\n\tmax8998->buck2_idx = pdata->buck2_default_idx;\n\n\t \n\t \n\t \n\n\t \n\tif (gpio_is_valid(pdata->buck1_set1) &&\n\t    gpio_is_valid(pdata->buck1_set2)) {\n\t\t \n\t\tif (!pdata->buck1_set1) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"MAX8998 SET1 GPIO defined as 0 !\\n\");\n\t\t\tWARN_ON(!pdata->buck1_set1);\n\t\t\treturn -EIO;\n\t\t}\n\t\t \n\t\tif (!pdata->buck1_set2) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"MAX8998 SET2 GPIO defined as 0 !\\n\");\n\t\t\tWARN_ON(!pdata->buck1_set2);\n\t\t\treturn -EIO;\n\t\t}\n\n\t\tgpio_request(pdata->buck1_set1, \"MAX8998 BUCK1_SET1\");\n\t\tgpio_direction_output(pdata->buck1_set1,\n\t\t\t\t      max8998->buck1_idx & 0x1);\n\n\n\t\tgpio_request(pdata->buck1_set2, \"MAX8998 BUCK1_SET2\");\n\t\tgpio_direction_output(pdata->buck1_set2,\n\t\t\t\t      (max8998->buck1_idx >> 1) & 0x1);\n\n\t\t \n\t\tfor (v = 0; v < ARRAY_SIZE(pdata->buck1_voltage); ++v) {\n\t\t\tint index = MAX8998_BUCK1 - MAX8998_LDO2;\n\n\t\t\ti = 0;\n\t\t\twhile (regulators[index].min_uV +\n\t\t\t       regulators[index].uV_step * i\n\t\t\t       < pdata->buck1_voltage[v])\n\t\t\t\ti++;\n\n\t\t\tmax8998->buck1_vol[v] = i;\n\t\t\tret = max8998_write_reg(i2c,\n\t\t\t\t\tMAX8998_REG_BUCK1_VOLTAGE1 + v, i);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (gpio_is_valid(pdata->buck2_set3)) {\n\t\t \n\t\tif (!pdata->buck2_set3) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"MAX8998 SET3 GPIO defined as 0 !\\n\");\n\t\t\tWARN_ON(!pdata->buck2_set3);\n\t\t\treturn -EIO;\n\t\t}\n\t\tgpio_request(pdata->buck2_set3, \"MAX8998 BUCK2_SET3\");\n\t\tgpio_direction_output(pdata->buck2_set3,\n\t\t\t\t      max8998->buck2_idx & 0x1);\n\n\t\t \n\t\tfor (v = 0; v < ARRAY_SIZE(pdata->buck2_voltage); ++v) {\n\t\t\tint index = MAX8998_BUCK2 - MAX8998_LDO2;\n\n\t\t\ti = 0;\n\t\t\twhile (regulators[index].min_uV +\n\t\t\t       regulators[index].uV_step * i\n\t\t\t       < pdata->buck2_voltage[v])\n\t\t\t\ti++;\n\n\t\t\tmax8998->buck2_vol[v] = i;\n\t\t\tret = max8998_write_reg(i2c,\n\t\t\t\t\tMAX8998_REG_BUCK2_VOLTAGE1 + v, i);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\t}\n\n\tfor (i = 0; i < pdata->num_regulators; i++) {\n\t\tint index = pdata->regulators[i].id - MAX8998_LDO2;\n\n\t\tconfig.dev = max8998->dev;\n\t\tconfig.of_node = pdata->regulators[i].reg_node;\n\t\tconfig.init_data = pdata->regulators[i].initdata;\n\t\tconfig.driver_data = max8998;\n\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[index],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tret = PTR_ERR(rdev);\n\t\t\tdev_err(max8998->dev, \"regulator %s init failed (%d)\\n\",\n\t\t\t\t\t\tregulators[index].name, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id max8998_pmic_id[] = {\n\t{ \"max8998-pmic\", TYPE_MAX8998 },\n\t{ \"lp3974-pmic\", TYPE_LP3974 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, max8998_pmic_id);\n\nstatic struct platform_driver max8998_pmic_driver = {\n\t.driver = {\n\t\t.name = \"max8998-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = max8998_pmic_probe,\n\t.id_table = max8998_pmic_id,\n};\n\nstatic int __init max8998_pmic_init(void)\n{\n\treturn platform_driver_register(&max8998_pmic_driver);\n}\nsubsys_initcall(max8998_pmic_init);\n\nstatic void __exit max8998_pmic_cleanup(void)\n{\n\tplatform_driver_unregister(&max8998_pmic_driver);\n}\nmodule_exit(max8998_pmic_cleanup);\n\nMODULE_DESCRIPTION(\"MAXIM 8998 voltage regulator driver\");\nMODULE_AUTHOR(\"Kyungmin Park <kyungmin.park@samsung.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}