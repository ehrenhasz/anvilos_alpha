{
  "module_name": "lp873x-regulator.c",
  "hash_id": "d679202c2b9b2239361e72aa0a924c094de094eb22905f0dd381d9aa8e96cefb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/lp873x-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/lp873x.h>\n\n#define LP873X_REGULATOR(_name, _id, _of, _ops, _n, _vr, _vm, _er, _em, \\\n\t\t\t _delay, _lr, _cr)\t\t\t\t\\\n\t[_id] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name\t\t\t= _name,\t\t\\\n\t\t\t.supply_name\t\t= _of \"-in\",\t\t\\\n\t\t\t.id\t\t\t= _id,\t\t\t\\\n\t\t\t.of_match\t\t= of_match_ptr(_of),\t\\\n\t\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\\\n\t\t\t.ops\t\t\t= &_ops,\t\t\\\n\t\t\t.n_voltages\t\t= _n,\t\t\t\\\n\t\t\t.type\t\t\t= REGULATOR_VOLTAGE,\t\\\n\t\t\t.owner\t\t\t= THIS_MODULE,\t\t\\\n\t\t\t.vsel_reg\t\t= _vr,\t\t\t\\\n\t\t\t.vsel_mask\t\t= _vm,\t\t\t\\\n\t\t\t.enable_reg\t\t= _er,\t\t\t\\\n\t\t\t.enable_mask\t\t= _em,\t\t\t\\\n\t\t\t.ramp_delay\t\t= _delay,\t\t\\\n\t\t\t.linear_ranges\t\t= _lr,\t\t\t\\\n\t\t\t.n_linear_ranges\t= ARRAY_SIZE(_lr),\t\\\n\t\t\t.curr_table\t= lp873x_buck_uA,\t\t\\\n\t\t\t.n_current_limits = ARRAY_SIZE(lp873x_buck_uA),\t\\\n\t\t\t.csel_reg\t= (_cr),\t\t\t\\\n\t\t\t.csel_mask\t= LP873X_BUCK0_CTRL_2_BUCK0_ILIM,\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.ctrl2_reg = _cr,\t\t\t\t\t\\\n\t}\n\nstruct lp873x_regulator {\n\tstruct regulator_desc desc;\n\tunsigned int ctrl2_reg;\n};\n\nstatic const struct lp873x_regulator regulators[];\n\nstatic const struct linear_range buck0_buck1_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(0, 0x0, 0x13, 0),\n\tREGULATOR_LINEAR_RANGE(700000, 0x14, 0x17, 10000),\n\tREGULATOR_LINEAR_RANGE(735000, 0x18, 0x9d, 5000),\n\tREGULATOR_LINEAR_RANGE(1420000, 0x9e, 0xff, 20000),\n};\n\nstatic const struct linear_range ldo0_ldo1_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(800000, 0x0, 0x19, 100000),\n};\n\nstatic const unsigned int lp873x_buck_ramp_delay[] = {\n\t30000, 15000, 10000, 7500, 3800, 1900, 940, 470\n};\n\n \nstatic const unsigned int lp873x_buck_uA[] = {\n\t1500000, 2000000, 2500000, 3000000, 3500000, 4000000,\n};\n\nstatic int lp873x_buck_set_ramp_delay(struct regulator_dev *rdev,\n\t\t\t\t      int ramp_delay)\n{\n\tint id = rdev_get_id(rdev);\n\tstruct lp873x *lp873 = rdev_get_drvdata(rdev);\n\tunsigned int reg;\n\tint ret;\n\n\tif (ramp_delay <= 470)\n\t\treg = 7;\n\telse if (ramp_delay <= 940)\n\t\treg = 6;\n\telse if (ramp_delay <= 1900)\n\t\treg = 5;\n\telse if (ramp_delay <= 3800)\n\t\treg = 4;\n\telse if (ramp_delay <= 7500)\n\t\treg = 3;\n\telse if (ramp_delay <= 10000)\n\t\treg = 2;\n\telse if (ramp_delay <= 15000)\n\t\treg = 1;\n\telse\n\t\treg = 0;\n\n\tret = regmap_update_bits(lp873->regmap, regulators[id].ctrl2_reg,\n\t\t\t\t LP873X_BUCK0_CTRL_2_BUCK0_SLEW_RATE,\n\t\t\t\t reg << __ffs(LP873X_BUCK0_CTRL_2_BUCK0_SLEW_RATE));\n\tif (ret) {\n\t\tdev_err(lp873->dev, \"SLEW RATE write failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trdev->constraints->ramp_delay = lp873x_buck_ramp_delay[reg];\n\n\treturn 0;\n}\n\n \nstatic const struct regulator_ops lp873x_buck01_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n\t.set_voltage_time_sel\t= regulator_set_voltage_time_sel,\n\t.set_ramp_delay\t\t= lp873x_buck_set_ramp_delay,\n\t.set_current_limit\t= regulator_set_current_limit_regmap,\n\t.get_current_limit\t= regulator_get_current_limit_regmap,\n};\n\n \nstatic const struct regulator_ops lp873x_ldo01_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n};\n\nstatic const struct lp873x_regulator regulators[] = {\n\tLP873X_REGULATOR(\"BUCK0\", LP873X_BUCK_0, \"buck0\", lp873x_buck01_ops,\n\t\t\t 256, LP873X_REG_BUCK0_VOUT,\n\t\t\t LP873X_BUCK0_VOUT_BUCK0_VSET, LP873X_REG_BUCK0_CTRL_1,\n\t\t\t LP873X_BUCK0_CTRL_1_BUCK0_EN, 10000,\n\t\t\t buck0_buck1_ranges, LP873X_REG_BUCK0_CTRL_2),\n\tLP873X_REGULATOR(\"BUCK1\", LP873X_BUCK_1, \"buck1\", lp873x_buck01_ops,\n\t\t\t 256, LP873X_REG_BUCK1_VOUT,\n\t\t\t LP873X_BUCK1_VOUT_BUCK1_VSET, LP873X_REG_BUCK1_CTRL_1,\n\t\t\t LP873X_BUCK1_CTRL_1_BUCK1_EN, 10000,\n\t\t\t buck0_buck1_ranges, LP873X_REG_BUCK1_CTRL_2),\n\tLP873X_REGULATOR(\"LDO0\", LP873X_LDO_0, \"ldo0\", lp873x_ldo01_ops, 26,\n\t\t\t LP873X_REG_LDO0_VOUT, LP873X_LDO0_VOUT_LDO0_VSET,\n\t\t\t LP873X_REG_LDO0_CTRL,\n\t\t\t LP873X_LDO0_CTRL_LDO0_EN, 0, ldo0_ldo1_ranges, 0xFF),\n\tLP873X_REGULATOR(\"LDO1\", LP873X_LDO_1, \"ldo1\", lp873x_ldo01_ops, 26,\n\t\t\t LP873X_REG_LDO1_VOUT, LP873X_LDO1_VOUT_LDO1_VSET,\n\t\t\t LP873X_REG_LDO1_CTRL,\n\t\t\t LP873X_LDO1_CTRL_LDO1_EN, 0, ldo0_ldo1_ranges, 0xFF),\n};\n\nstatic int lp873x_regulator_probe(struct platform_device *pdev)\n{\n\tstruct lp873x *lp873 = dev_get_drvdata(pdev->dev.parent);\n\tstruct regulator_config config = { };\n\tstruct regulator_dev *rdev;\n\tint i;\n\n\tplatform_set_drvdata(pdev, lp873);\n\n\tconfig.dev = &pdev->dev;\n\tconfig.dev->of_node = lp873->dev->of_node;\n\tconfig.driver_data = lp873;\n\tconfig.regmap = lp873->regmap;\n\n\tfor (i = 0; i < ARRAY_SIZE(regulators); i++) {\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[i].desc,\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(lp873->dev, \"failed to register %s regulator\\n\",\n\t\t\t\tpdev->name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id lp873x_regulator_id_table[] = {\n\t{ \"lp873x-regulator\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, lp873x_regulator_id_table);\n\nstatic struct platform_driver lp873x_regulator_driver = {\n\t.driver = {\n\t\t.name = \"lp873x-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = lp873x_regulator_probe,\n\t.id_table = lp873x_regulator_id_table,\n};\nmodule_platform_driver(lp873x_regulator_driver);\n\nMODULE_AUTHOR(\"J Keerthy <j-keerthy@ti.com>\");\nMODULE_DESCRIPTION(\"LP873X voltage regulator driver\");\nMODULE_ALIAS(\"platform:lp873x-pmic\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}