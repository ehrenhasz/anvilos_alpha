{
  "module_name": "wm8994-regulator.c",
  "hash_id": "ca77154a0cb47bb7a78aa78ab1b5f34ec292b763a81741fbc415e4dbd959c7cb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/wm8994-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/init.h>\n#include <linux/bitops.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/gpio/consumer.h>\n#include <linux/slab.h>\n\n#include <linux/mfd/wm8994/core.h>\n#include <linux/mfd/wm8994/registers.h>\n#include <linux/mfd/wm8994/pdata.h>\n\nstruct wm8994_ldo {\n\tstruct regulator_dev *regulator;\n\tstruct wm8994 *wm8994;\n\tstruct regulator_consumer_supply supply;\n\tstruct regulator_init_data init_data;\n};\n\n#define WM8994_LDO1_MAX_SELECTOR 0x7\n#define WM8994_LDO2_MAX_SELECTOR 0x3\n\nstatic const struct regulator_ops wm8994_ldo1_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.map_voltage = regulator_map_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n};\n\nstatic int wm8994_ldo2_list_voltage(struct regulator_dev *rdev,\n\t\t\t\t    unsigned int selector)\n{\n\tstruct wm8994_ldo *ldo = rdev_get_drvdata(rdev);\n\n\tif (selector > WM8994_LDO2_MAX_SELECTOR)\n\t\treturn -EINVAL;\n\n\tswitch (ldo->wm8994->type) {\n\tcase WM8994:\n\t\treturn (selector * 100000) + 900000;\n\tcase WM8958:\n\t\treturn (selector * 100000) + 1000000;\n\tcase WM1811:\n\t\tswitch (selector) {\n\t\tcase 0:\n\t\t\treturn -EINVAL;\n\t\tdefault:\n\t\t\treturn (selector * 100000) + 950000;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic const struct regulator_ops wm8994_ldo2_ops = {\n\t.list_voltage = wm8994_ldo2_list_voltage,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n};\n\nstatic const struct regulator_desc wm8994_ldo_desc[] = {\n\t{\n\t\t.name = \"LDO1\",\n\t\t.id = 1,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.n_voltages = WM8994_LDO1_MAX_SELECTOR + 1,\n\t\t.vsel_reg = WM8994_LDO_1,\n\t\t.vsel_mask = WM8994_LDO1_VSEL_MASK,\n\t\t.ops = &wm8994_ldo1_ops,\n\t\t.min_uV = 2400000,\n\t\t.uV_step = 100000,\n\t\t.enable_time = 3000,\n\t\t.off_on_delay = 36000,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"LDO2\",\n\t\t.id = 2,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.n_voltages = WM8994_LDO2_MAX_SELECTOR + 1,\n\t\t.vsel_reg = WM8994_LDO_2,\n\t\t.vsel_mask = WM8994_LDO2_VSEL_MASK,\n\t\t.ops = &wm8994_ldo2_ops,\n\t\t.enable_time = 3000,\n\t\t.off_on_delay = 36000,\n\t\t.owner = THIS_MODULE,\n\t},\n};\n\nstatic const struct regulator_desc wm8958_ldo_desc[] = {\n\t{\n\t\t.name = \"LDO1\",\n\t\t.id = 1,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.n_voltages = WM8994_LDO1_MAX_SELECTOR + 1,\n\t\t.vsel_reg = WM8994_LDO_1,\n\t\t.vsel_mask = WM8994_LDO1_VSEL_MASK,\n\t\t.ops = &wm8994_ldo1_ops,\n\t\t.min_uV = 2400000,\n\t\t.uV_step = 100000,\n\t\t.enable_time = 3000,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"LDO2\",\n\t\t.id = 2,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.n_voltages = WM8994_LDO2_MAX_SELECTOR + 1,\n\t\t.vsel_reg = WM8994_LDO_2,\n\t\t.vsel_mask = WM8994_LDO2_VSEL_MASK,\n\t\t.ops = &wm8994_ldo2_ops,\n\t\t.enable_time = 3000,\n\t\t.owner = THIS_MODULE,\n\t},\n};\n\nstatic const struct regulator_consumer_supply wm8994_ldo_consumer[] = {\n\t{ .supply = \"AVDD1\" },\n\t{ .supply = \"DCVDD\" },\n};\n\nstatic const struct regulator_init_data wm8994_ldo_default[] = {\n\t{\n\t\t.constraints = {\n\t\t\t.valid_ops_mask = REGULATOR_CHANGE_STATUS,\n\t\t},\n\t\t.num_consumer_supplies = 1,\n\t},\n\t{\n\t\t.constraints = {\n\t\t\t.valid_ops_mask = REGULATOR_CHANGE_STATUS,\n\t\t},\n\t\t.num_consumer_supplies = 1,\n\t},\n};\n\nstatic int wm8994_ldo_probe(struct platform_device *pdev)\n{\n\tstruct wm8994 *wm8994 = dev_get_drvdata(pdev->dev.parent);\n\tstruct wm8994_pdata *pdata = dev_get_platdata(wm8994->dev);\n\tint id = pdev->id % ARRAY_SIZE(pdata->ldo);\n\tstruct regulator_config config = { };\n\tstruct wm8994_ldo *ldo;\n\tstruct gpio_desc *gpiod;\n\tint ret;\n\n\tdev_dbg(&pdev->dev, \"Probing LDO%d\\n\", id + 1);\n\n\tldo = devm_kzalloc(&pdev->dev, sizeof(struct wm8994_ldo), GFP_KERNEL);\n\tif (!ldo)\n\t\treturn -ENOMEM;\n\n\tldo->wm8994 = wm8994;\n\tldo->supply = wm8994_ldo_consumer[id];\n\tldo->supply.dev_name = dev_name(wm8994->dev);\n\n\tconfig.dev = wm8994->dev;\n\tconfig.driver_data = ldo;\n\tconfig.regmap = wm8994->regmap;\n\tconfig.init_data = &ldo->init_data;\n\n\t \n\tgpiod = gpiod_get_optional(pdev->dev.parent,\n\t\t\t\t   id ? \"wlf,ldo2ena\" : \"wlf,ldo1ena\",\n\t\t\t\t   GPIOD_OUT_LOW |\n\t\t\t\t   GPIOD_FLAGS_BIT_NONEXCLUSIVE);\n\tif (IS_ERR(gpiod))\n\t\treturn PTR_ERR(gpiod);\n\tconfig.ena_gpiod = gpiod;\n\n\t \n\tif (!pdata || !pdata->ldo[id].init_data || wm8994->dev->of_node) {\n\t\tdev_dbg(wm8994->dev, \"Using default init data, supply %s %s\\n\",\n\t\t\tldo->supply.dev_name, ldo->supply.supply);\n\n\t\tldo->init_data = wm8994_ldo_default[id];\n\t\tldo->init_data.consumer_supplies = &ldo->supply;\n\t\tif (!gpiod)\n\t\t\tldo->init_data.constraints.valid_ops_mask = 0;\n\t} else {\n\t\tldo->init_data = *pdata->ldo[id].init_data;\n\t}\n\n\t \n\tif (ldo->wm8994->type == WM8994) {\n\t\tldo->regulator = devm_regulator_register(&pdev->dev,\n\t\t\t\t\t\t\t &wm8994_ldo_desc[id],\n\t\t\t\t\t\t\t &config);\n\t} else {\n\t\tldo->regulator = devm_regulator_register(&pdev->dev,\n\t\t\t\t\t\t\t &wm8958_ldo_desc[id],\n\t\t\t\t\t\t\t &config);\n\t}\n\n\tif (IS_ERR(ldo->regulator)) {\n\t\tret = PTR_ERR(ldo->regulator);\n\t\tdev_err(wm8994->dev, \"Failed to register LDO%d: %d\\n\",\n\t\t\tid + 1, ret);\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, ldo);\n\n\treturn 0;\n}\n\nstatic struct platform_driver wm8994_ldo_driver = {\n\t.probe = wm8994_ldo_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"wm8994-ldo\",\n\t\t.probe_type = PROBE_FORCE_SYNCHRONOUS,\n\t},\n};\n\nmodule_platform_driver(wm8994_ldo_driver);\n\n \nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_DESCRIPTION(\"WM8994 LDO driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm8994-ldo\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}