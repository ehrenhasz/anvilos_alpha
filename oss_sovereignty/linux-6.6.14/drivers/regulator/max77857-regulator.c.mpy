{
  "module_name": "max77857-regulator.c",
  "hash_id": "183050572433f13b09fe80151290a7a1cbc47b6cb7c1f3f29bb4f34b79fef3ac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max77857-regulator.c",
  "human_readable_source": "\n \n#include <linux/bitfield.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/util_macros.h>\n\n#define MAX77857_REG_INT_SRC\t\t0x10\n#define MAX77857_REG_INT_MASK\t\t0x11\n#define MAX77857_REG_CONT1\t\t0x12\n#define MAX77857_REG_CONT2\t\t0x13\n#define MAX77857_REG_CONT3\t\t0x14\n\n#define MAX77857_INT_SRC_OCP\t\tBIT(0)\n#define MAX77857_INT_SRC_THS\t\tBIT(1)\n#define MAX77857_INT_SRC_HARDSHORT\tBIT(2)\n#define MAX77857_INT_SRC_OVP\t\tBIT(3)\n#define MAX77857_INT_SRC_POK\t\tBIT(4)\n\n#define MAX77857_ILIM_MASK\t\tGENMASK(2, 0)\n#define MAX77857_CONT1_FREQ\t\tGENMASK(4, 3)\n#define MAX77857_CONT3_FPWM\t\tBIT(5)\n\n#define MAX77859_REG_INT_SRC\t\t0x11\n#define MAX77859_REG_CONT1\t\t0x13\n#define MAX77859_REG_CONT2\t\t0x14\n#define MAX77859_REG_CONT3\t\t0x15\n#define MAX77859_REG_CONT5\t\t0x17\n#define MAX77859_CONT2_FPWM\t\tBIT(2)\n#define MAX77859_CONT2_INTB\t\tBIT(3)\n#define MAX77859_CONT3_DVS_START\tBIT(2)\n#define MAX77859_VOLTAGE_SEL_MASK\tGENMASK(9, 0)\n\n#define MAX77859_CURRENT_MIN\t\t1000000\n#define MAX77859_CURRENT_MAX\t\t5000000\n#define MAX77859_CURRENT_STEP\t\t50000\n\nenum max77857_id {\n\tID_MAX77831 = 1,\n\tID_MAX77857,\n\tID_MAX77859,\n\tID_MAX77859A,\n};\n\nstatic bool max77857_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tenum max77857_id id = (uintptr_t)dev_get_drvdata(dev);\n\n\tswitch (id) {\n\tcase ID_MAX77831:\n\tcase ID_MAX77857:\n\t\treturn reg == MAX77857_REG_INT_SRC;\n\tcase ID_MAX77859:\n\tcase ID_MAX77859A:\n\t\treturn reg == MAX77859_REG_INT_SRC;\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic struct regmap_config max77857_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.cache_type = REGCACHE_MAPLE,\n\t.volatile_reg = max77857_volatile_reg,\n};\n\nstatic int max77857_get_status(struct regulator_dev *rdev)\n{\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(rdev->regmap, MAX77857_REG_INT_SRC, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tif (FIELD_GET(MAX77857_INT_SRC_POK, val))\n\t\treturn REGULATOR_STATUS_ON;\n\n\treturn REGULATOR_STATUS_ERROR;\n}\n\nstatic unsigned int max77857_get_mode(struct regulator_dev *rdev)\n{\n\tenum max77857_id id = (uintptr_t)rdev_get_drvdata(rdev);\n\tunsigned int regval;\n\tint ret;\n\n\tswitch (id) {\n\tcase ID_MAX77831:\n\tcase ID_MAX77857:\n\t\tret = regmap_read(rdev->regmap, MAX77857_REG_CONT3, &regval);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (FIELD_GET(MAX77857_CONT3_FPWM, regval))\n\t\t\treturn REGULATOR_MODE_FAST;\n\n\t\tbreak;\n\tcase ID_MAX77859:\n\tcase ID_MAX77859A:\n\t\tret = regmap_read(rdev->regmap, MAX77859_REG_CONT2, &regval);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (FIELD_GET(MAX77859_CONT2_FPWM, regval))\n\t\t\treturn REGULATOR_MODE_FAST;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn REGULATOR_MODE_NORMAL;\n}\n\nstatic int max77857_set_mode(struct regulator_dev *rdev, unsigned int mode)\n{\n\tenum max77857_id id = (uintptr_t)rdev_get_drvdata(rdev);\n\tunsigned int reg, val;\n\n\tswitch (id) {\n\tcase ID_MAX77831:\n\tcase ID_MAX77857:\n\t\treg = MAX77857_REG_CONT3;\n\t\tval = MAX77857_CONT3_FPWM;\n\t\tbreak;\n\tcase ID_MAX77859:\n\tcase ID_MAX77859A:\n\t\treg = MAX77859_REG_CONT2;\n\t\tval = MAX77859_CONT2_FPWM;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (mode) {\n\tcase REGULATOR_MODE_FAST:\n\t\treturn regmap_set_bits(rdev->regmap, reg, val);\n\tcase REGULATOR_MODE_NORMAL:\n\t\treturn regmap_clear_bits(rdev->regmap, reg, val);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int max77857_get_error_flags(struct regulator_dev *rdev,\n\t\t\t\t    unsigned int *flags)\n{\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(rdev->regmap, MAX77857_REG_INT_SRC, &val);\n\tif (ret)\n\t\treturn ret;\n\n\t*flags = 0;\n\n\tif (FIELD_GET(MAX77857_INT_SRC_OVP, val))\n\t\t*flags |= REGULATOR_ERROR_OVER_VOLTAGE_WARN;\n\n\tif (FIELD_GET(MAX77857_INT_SRC_OCP, val) ||\n\t    FIELD_GET(MAX77857_INT_SRC_HARDSHORT, val))\n\t\t*flags |= REGULATOR_ERROR_OVER_CURRENT;\n\n\tif (FIELD_GET(MAX77857_INT_SRC_THS, val))\n\t\t*flags |= REGULATOR_ERROR_OVER_TEMP;\n\n\tif (!FIELD_GET(MAX77857_INT_SRC_POK, val))\n\t\t*flags |= REGULATOR_ERROR_FAIL;\n\n\treturn 0;\n}\n\nstatic struct linear_range max77859_lin_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(3200000, 0x0A0, 0x320, 20000)\n};\n\nstatic const unsigned int max77859_ramp_table[4] = {\n\t1000, 500, 250, 125\n};\n\nstatic int max77859_set_voltage_sel(struct regulator_dev *rdev,\n\t\t\t\t    unsigned int sel)\n{\n\t__be16 reg;\n\tint ret;\n\n\treg = cpu_to_be16(sel);\n\n\tret = regmap_bulk_write(rdev->regmap, MAX77859_REG_CONT3, &reg, 2);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn regmap_set_bits(rdev->regmap, MAX77859_REG_CONT3,\n\t\t\t       MAX77859_CONT3_DVS_START);\n}\n\nstatic int max77859_get_voltage_sel(struct regulator_dev *rdev)\n{\n\t__be16 reg;\n\tint ret;\n\n\tret = regmap_bulk_read(rdev->regmap, MAX77859_REG_CONT3, &reg, 2);\n\tif (ret)\n\t\treturn ret;\n\n\treturn FIELD_GET(MAX77859_VOLTAGE_SEL_MASK, __be16_to_cpu(reg));\n}\n\nstatic int max77859_set_current_limit(struct regulator_dev *rdev, int min_uA, int max_uA)\n{\n\tu32 selector;\n\n\tif (max_uA < MAX77859_CURRENT_MIN)\n\t\treturn -EINVAL;\n\n\tselector = 0x12 + (max_uA - MAX77859_CURRENT_MIN) / MAX77859_CURRENT_STEP;\n\n\tselector = clamp_val(selector, 0x00, 0x7F);\n\n\treturn regmap_write(rdev->regmap, MAX77859_REG_CONT5, selector);\n}\n\nstatic int max77859_get_current_limit(struct regulator_dev *rdev)\n{\n\tu32 selector;\n\tint ret;\n\n\tret = regmap_read(rdev->regmap, MAX77859_REG_CONT5, &selector);\n\tif (ret)\n\t\treturn ret;\n\n\tif (selector <= 0x12)\n\t\treturn MAX77859_CURRENT_MIN;\n\n\tif (selector >= 0x64)\n\t\treturn MAX77859_CURRENT_MAX;\n\n\treturn MAX77859_CURRENT_MIN + (selector - 0x12) * MAX77859_CURRENT_STEP;\n}\n\nstatic const struct regulator_ops max77859_regulator_ops = {\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.set_voltage_sel = max77859_set_voltage_sel,\n\t.get_voltage_sel = max77859_get_voltage_sel,\n\t.set_ramp_delay = regulator_set_ramp_delay_regmap,\n\t.get_status = max77857_get_status,\n\t.set_mode = max77857_set_mode,\n\t.get_mode = max77857_get_mode,\n\t.get_error_flags = max77857_get_error_flags,\n};\n\nstatic const struct regulator_ops max77859a_regulator_ops = {\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.set_voltage_sel = max77859_set_voltage_sel,\n\t.get_voltage_sel = max77859_get_voltage_sel,\n\t.set_current_limit = max77859_set_current_limit,\n\t.get_current_limit = max77859_get_current_limit,\n\t.set_ramp_delay = regulator_set_ramp_delay_regmap,\n\t.get_status = max77857_get_status,\n\t.set_mode = max77857_set_mode,\n\t.get_mode = max77857_get_mode,\n\t.get_error_flags = max77857_get_error_flags,\n};\n\nstatic const struct regulator_ops max77857_regulator_ops = {\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_ramp_delay = regulator_set_ramp_delay_regmap,\n\t.get_status = max77857_get_status,\n\t.set_mode = max77857_set_mode,\n\t.get_mode = max77857_get_mode,\n\t.get_error_flags = max77857_get_error_flags,\n};\n\nstatic struct linear_range max77857_lin_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(4485000, 0x3D, 0xCC, 73500)\n};\n\nstatic const unsigned int max77857_switch_freq[] = {\n\t1200000, 1500000, 1800000, 2100000\n};\n\n#define RAMAP_DELAY_INIT_VAL 1333\n\nstatic const unsigned int max77857_ramp_table[2][4] = {\n\t{ RAMAP_DELAY_INIT_VAL, 667, 333, 227 },  \n\t{ 1166, 667, 333, 167 },  \n};\n\nstatic struct regulator_desc max77857_regulator_desc = {\n\t.ops = &max77857_regulator_ops,\n\t.name = \"max77857\",\n\t.linear_ranges = max77857_lin_ranges,\n\t.n_linear_ranges = ARRAY_SIZE(max77857_lin_ranges),\n\t.vsel_mask = 0xFF,\n\t.vsel_reg = MAX77857_REG_CONT2,\n\t.ramp_delay_table = max77857_ramp_table[0],\n\t.n_ramp_values = ARRAY_SIZE(max77857_ramp_table[0]),\n\t.ramp_reg = MAX77857_REG_CONT3,\n\t.ramp_mask = GENMASK(1, 0),\n\t.ramp_delay = RAMAP_DELAY_INIT_VAL,\n\t.owner = THIS_MODULE,\n};\n\nstatic void max77857_calc_range(struct device *dev, enum max77857_id id)\n{\n\tstruct linear_range *range;\n\tunsigned long vref_step;\n\tu32 rtop = 0;\n\tu32 rbot = 0;\n\n\tdevice_property_read_u32(dev, \"adi,rtop-ohms\", &rtop);\n\tdevice_property_read_u32(dev, \"adi,rbot-ohms\", &rbot);\n\n\tif (!rbot || !rtop)\n\t\treturn;\n\n\tswitch (id) {\n\tcase ID_MAX77831:\n\tcase ID_MAX77857:\n\t\trange = max77857_lin_ranges;\n\t\tvref_step = 4900UL;\n\t\tbreak;\n\tcase ID_MAX77859:\n\tcase ID_MAX77859A:\n\t\trange = max77859_lin_ranges;\n\t\tvref_step = 1250UL;\n\t\tbreak;\n\t}\n\n\trange->step = DIV_ROUND_CLOSEST(vref_step * (rbot + rtop), rbot);\n\trange->min = range->step * range->min_sel;\n}\n\nstatic int max77857_probe(struct i2c_client *client)\n{\n\tconst struct i2c_device_id *i2c_id;\n\tstruct device *dev = &client->dev;\n\tstruct regulator_config cfg = { };\n\tstruct regulator_dev *rdev;\n\tstruct regmap *regmap;\n\tenum max77857_id id;\n\tu32 switch_freq = 0;\n\tint ret;\n\n\ti2c_id = i2c_client_get_device_id(client);\n\tif (!i2c_id)\n\t\treturn -EINVAL;\n\n\tid = i2c_id->driver_data;\n\n\tdev_set_drvdata(dev, (void *)id);\n\n\tif (id == ID_MAX77859 || id == ID_MAX77859A) {\n\t\tmax77857_regulator_desc.ops = &max77859_regulator_ops;\n\t\tmax77857_regulator_desc.linear_ranges = max77859_lin_ranges;\n\t\tmax77857_regulator_desc.ramp_delay_table = max77859_ramp_table;\n\t\tmax77857_regulator_desc.ramp_delay = max77859_ramp_table[0];\n\t}\n\n\tif (id == ID_MAX77859A)\n\t\tmax77857_regulator_desc.ops = &max77859a_regulator_ops;\n\n\tmax77857_calc_range(dev, id);\n\n\tregmap = devm_regmap_init_i2c(client, &max77857_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn dev_err_probe(dev, PTR_ERR(regmap),\n\t\t\t\t     \"cannot initialize regmap\\n\");\n\n\tdevice_property_read_u32(dev, \"adi,switch-frequency-hz\", &switch_freq);\n\tif (switch_freq) {\n\t\tswitch_freq = find_closest(switch_freq, max77857_switch_freq,\n\t\t\t\t\t   ARRAY_SIZE(max77857_switch_freq));\n\n\t\tif (id == ID_MAX77831 && switch_freq == 3)\n\t\t\tswitch_freq = 2;\n\n\t\tswitch (id) {\n\t\tcase ID_MAX77831:\n\t\tcase ID_MAX77857:\n\t\t\tret = regmap_update_bits(regmap, MAX77857_REG_CONT1,\n\t\t\t\t\t\t MAX77857_CONT1_FREQ, switch_freq);\n\n\t\t\tif (switch_freq >= 2)\n\t\t\t\tbreak;\n\n\t\t\tmax77857_regulator_desc.ramp_delay_table = max77857_ramp_table[1];\n\t\t\tmax77857_regulator_desc.ramp_delay = max77857_ramp_table[1][0];\n\t\t\tbreak;\n\t\tcase ID_MAX77859:\n\t\tcase ID_MAX77859A:\n\t\t\tret = regmap_update_bits(regmap, MAX77859_REG_CONT1,\n\t\t\t\t\t\t MAX77857_CONT1_FREQ, switch_freq);\n\t\t\tbreak;\n\t\t}\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tcfg.dev = dev;\n\tcfg.driver_data = (void *)id;\n\tcfg.regmap = regmap;\n\tcfg.init_data = of_get_regulator_init_data(dev, dev->of_node,\n\t\t\t\t\t\t   &max77857_regulator_desc);\n\tif (!cfg.init_data)\n\t\treturn -ENOMEM;\n\n\trdev = devm_regulator_register(dev, &max77857_regulator_desc, &cfg);\n\tif (IS_ERR(rdev))\n\t\treturn dev_err_probe(dev, PTR_ERR(rdev),\n\t\t\t\t     \"cannot register regulator\\n\");\n\n\treturn 0;\n}\n\nconst struct i2c_device_id max77857_id[] = {\n\t{ \"max77831\", ID_MAX77831 },\n\t{ \"max77857\", ID_MAX77857 },\n\t{ \"max77859\", ID_MAX77859 },\n\t{ \"max77859a\", ID_MAX77859A },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, max77857_id);\n\nstatic const struct of_device_id max77857_of_id[] = {\n\t{ .compatible = \"adi,max77831\", .data = (void *)ID_MAX77831 },\n\t{ .compatible = \"adi,max77857\", .data = (void *)ID_MAX77857 },\n\t{ .compatible = \"adi,max77859\", .data = (void *)ID_MAX77859 },\n\t{ .compatible = \"adi,max77859a\", .data = (void *)ID_MAX77859A },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max77857_of_id);\n\nstatic struct i2c_driver max77857_driver = {\n\t.driver = {\n\t\t.name = \"max77857\",\n\t\t.of_match_table = max77857_of_id,\n\t},\n\t.id_table = max77857_id,\n\t.probe = max77857_probe,\n};\nmodule_i2c_driver(max77857_driver);\n\nMODULE_DESCRIPTION(\"Analog Devices MAX77857 Buck-Boost Converter Driver\");\nMODULE_AUTHOR(\"Ibrahim Tilki <Ibrahim.Tilki@analog.com>\");\nMODULE_AUTHOR(\"Okan Sahin <Okan.Sahin@analog.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}