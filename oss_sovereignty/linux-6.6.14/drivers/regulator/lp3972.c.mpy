{
  "module_name": "lp3972.c",
  "hash_id": "98a5863ed9a04286b5b08999b5f0791c78fbc8ab2a845776b10dd458d5fd6e4c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/lp3972.c",
  "human_readable_source": "\n \n\n#include <linux/bug.h>\n#include <linux/err.h>\n#include <linux/i2c.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/lp3972.h>\n#include <linux/slab.h>\n\nstruct lp3972 {\n\tstruct device *dev;\n\tstruct mutex io_lock;\n\tstruct i2c_client *i2c;\n};\n\n \n#define LP3972_SCR_REG\t\t0x07\n#define LP3972_OVER1_REG\t0x10\n#define LP3972_OVSR1_REG\t0x11\n#define LP3972_OVER2_REG\t0x12\n#define LP3972_OVSR2_REG\t0x13\n#define LP3972_VCC1_REG\t\t0x20\n#define LP3972_ADTV1_REG\t0x23\n#define LP3972_ADTV2_REG\t0x24\n#define LP3972_AVRC_REG\t\t0x25\n#define LP3972_CDTC1_REG\t0x26\n#define LP3972_CDTC2_REG\t0x27\n#define LP3972_SDTV1_REG\t0x29\n#define LP3972_SDTV2_REG\t0x2A\n#define LP3972_MDTV1_REG\t0x32\n#define LP3972_MDTV2_REG\t0x33\n#define LP3972_L2VCR_REG\t0x39\n#define LP3972_L34VCR_REG\t0x3A\n#define LP3972_SCR1_REG\t\t0x80\n#define LP3972_SCR2_REG\t\t0x81\n#define LP3972_OEN3_REG\t\t0x82\n#define LP3972_OSR3_REG\t\t0x83\n#define LP3972_LOER4_REG\t0x84\n#define LP3972_B2TV_REG\t\t0x85\n#define LP3972_B3TV_REG\t\t0x86\n#define LP3972_B32RC_REG\t0x87\n#define LP3972_ISRA_REG\t\t0x88\n#define LP3972_BCCR_REG\t\t0x89\n#define LP3972_II1RR_REG\t0x8E\n#define LP3972_II2RR_REG\t0x8F\n\n#define LP3972_SYS_CONTROL1_REG\t\tLP3972_SCR1_REG\n \n#define SYS_CONTROL1_INIT_VAL\t\t0x02\n#define SYS_CONTROL1_INIT_MASK\t\t0x1F\n\n#define LP3972_VOL_CHANGE_REG\t\tLP3972_VCC1_REG\n#define LP3972_VOL_CHANGE_FLAG_GO\t0x01\n#define LP3972_VOL_CHANGE_FLAG_MASK\t0x03\n\n \n#define LP3972_OEN3_L1EN\tBIT(0)\n#define LP3972_OVER2_LDO2_EN\tBIT(2)\n#define LP3972_OVER2_LDO3_EN\tBIT(3)\n#define LP3972_OVER2_LDO4_EN\tBIT(4)\n#define LP3972_OVER1_S_EN\tBIT(2)\n\nstatic const unsigned int ldo1_voltage_map[] = {\n\t1700000, 1725000, 1750000, 1775000, 1800000, 1825000, 1850000, 1875000,\n\t1900000, 1925000, 1950000, 1975000, 2000000,\n};\n\nstatic const unsigned int ldo23_voltage_map[] = {\n\t1800000, 1900000, 2000000, 2100000, 2200000, 2300000, 2400000, 2500000,\n\t2600000, 2700000, 2800000, 2900000, 3000000, 3100000, 3200000, 3300000,\n};\n\nstatic const unsigned int ldo4_voltage_map[] = {\n\t1000000, 1050000, 1100000, 1150000, 1200000, 1250000, 1300000, 1350000,\n\t1400000, 1500000, 1800000, 1900000, 2500000, 2800000, 3000000, 3300000,\n};\n\nstatic const unsigned int ldo5_voltage_map[] = {\n\t      0,       0,       0,       0,       0,  850000,  875000,  900000,\n\t 925000,  950000,  975000, 1000000, 1025000, 1050000, 1075000, 1100000,\n\t1125000, 1150000, 1175000, 1200000, 1225000, 1250000, 1275000, 1300000,\n\t1325000, 1350000, 1375000, 1400000, 1425000, 1450000, 1475000, 1500000,\n};\n\nstatic const unsigned int buck1_voltage_map[] = {\n\t 725000,  750000,  775000,  800000,  825000,  850000,  875000,  900000,\n\t 925000,  950000,  975000, 1000000, 1025000, 1050000, 1075000, 1100000,\n\t1125000, 1150000, 1175000, 1200000, 1225000, 1250000, 1275000, 1300000,\n\t1325000, 1350000, 1375000, 1400000, 1425000, 1450000, 1475000, 1500000,\n};\n\nstatic const unsigned int buck23_voltage_map[] = {\n\t      0,  800000,  850000,  900000,  950000, 1000000, 1050000, 1100000,\n\t1150000, 1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000,\n\t1550000, 1600000, 1650000, 1700000, 1800000, 1900000, 2500000, 2800000,\n\t3000000, 3300000,\n};\n\nstatic const int ldo_output_enable_mask[] = {\n\tLP3972_OEN3_L1EN,\n\tLP3972_OVER2_LDO2_EN,\n\tLP3972_OVER2_LDO3_EN,\n\tLP3972_OVER2_LDO4_EN,\n\tLP3972_OVER1_S_EN,\n};\n\nstatic const int ldo_output_enable_addr[] = {\n\tLP3972_OEN3_REG,\n\tLP3972_OVER2_REG,\n\tLP3972_OVER2_REG,\n\tLP3972_OVER2_REG,\n\tLP3972_OVER1_REG,\n};\n\nstatic const int ldo_vol_ctl_addr[] = {\n\tLP3972_MDTV1_REG,\n\tLP3972_L2VCR_REG,\n\tLP3972_L34VCR_REG,\n\tLP3972_L34VCR_REG,\n\tLP3972_SDTV1_REG,\n};\n\nstatic const int buck_vol_enable_addr[] = {\n\tLP3972_OVER1_REG,\n\tLP3972_OEN3_REG,\n\tLP3972_OEN3_REG,\n};\n\nstatic const int buck_base_addr[] = {\n\tLP3972_ADTV1_REG,\n\tLP3972_B2TV_REG,\n\tLP3972_B3TV_REG,\n};\n\n#define LP3972_LDO_OUTPUT_ENABLE_MASK(x) (ldo_output_enable_mask[x])\n#define LP3972_LDO_OUTPUT_ENABLE_REG(x) (ldo_output_enable_addr[x])\n\n \n#define LP3972_LDO_VOL_CONTR_SHIFT(x) (((x) & 1) << 2)\n#define LP3972_LDO_VOL_CONTR_REG(x) (ldo_vol_ctl_addr[x])\n#define LP3972_LDO_VOL_CHANGE_SHIFT(x) ((x) ? 4 : 6)\n\n#define LP3972_LDO_VOL_MASK(x) (((x) % 4) ? 0x0f : 0x1f)\n#define LP3972_LDO_VOL_MIN_IDX(x) (((x) == 4) ? 0x05 : 0x00)\n#define LP3972_LDO_VOL_MAX_IDX(x) ((x) ? (((x) == 4) ? 0x1f : 0x0f) : 0x0c)\n\n#define LP3972_BUCK_VOL_ENABLE_REG(x) (buck_vol_enable_addr[x])\n#define LP3972_BUCK_VOL1_REG(x) (buck_base_addr[x])\n#define LP3972_BUCK_VOL_MASK 0x1f\n\nstatic int lp3972_i2c_read(struct i2c_client *i2c, char reg, int count,\n\tu16 *dest)\n{\n\tint ret;\n\n\tif (count != 1)\n\t\treturn -EIO;\n\tret = i2c_smbus_read_byte_data(i2c, reg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*dest = ret;\n\treturn 0;\n}\n\nstatic int lp3972_i2c_write(struct i2c_client *i2c, char reg, int count,\n\tconst u16 *src)\n{\n\tif (count != 1)\n\t\treturn -EIO;\n\treturn i2c_smbus_write_byte_data(i2c, reg, *src);\n}\n\nstatic u8 lp3972_reg_read(struct lp3972 *lp3972, u8 reg)\n{\n\tu16 val = 0;\n\n\tmutex_lock(&lp3972->io_lock);\n\n\tlp3972_i2c_read(lp3972->i2c, reg, 1, &val);\n\n\tdev_dbg(lp3972->dev, \"reg read 0x%02x -> 0x%02x\\n\", (int)reg,\n\t\t(unsigned)val & 0xff);\n\n\tmutex_unlock(&lp3972->io_lock);\n\n\treturn val & 0xff;\n}\n\nstatic int lp3972_set_bits(struct lp3972 *lp3972, u8 reg, u16 mask, u16 val)\n{\n\tu16 tmp;\n\tint ret;\n\n\tmutex_lock(&lp3972->io_lock);\n\n\tret = lp3972_i2c_read(lp3972->i2c, reg, 1, &tmp);\n\tif (ret == 0) {\n\t\ttmp = (tmp & ~mask) | val;\n\t\tret = lp3972_i2c_write(lp3972->i2c, reg, 1, &tmp);\n\t\tdev_dbg(lp3972->dev, \"reg write 0x%02x -> 0x%02x\\n\", (int)reg,\n\t\t\t(unsigned)val & 0xff);\n\t}\n\tmutex_unlock(&lp3972->io_lock);\n\n\treturn ret;\n}\n\nstatic int lp3972_ldo_is_enabled(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint ldo = rdev_get_id(dev) - LP3972_LDO1;\n\tu16 mask = LP3972_LDO_OUTPUT_ENABLE_MASK(ldo);\n\tu16 val;\n\n\tval = lp3972_reg_read(lp3972, LP3972_LDO_OUTPUT_ENABLE_REG(ldo));\n\treturn !!(val & mask);\n}\n\nstatic int lp3972_ldo_enable(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint ldo = rdev_get_id(dev) - LP3972_LDO1;\n\tu16 mask = LP3972_LDO_OUTPUT_ENABLE_MASK(ldo);\n\n\treturn lp3972_set_bits(lp3972, LP3972_LDO_OUTPUT_ENABLE_REG(ldo),\n\t\t\t\tmask, mask);\n}\n\nstatic int lp3972_ldo_disable(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint ldo = rdev_get_id(dev) - LP3972_LDO1;\n\tu16 mask = LP3972_LDO_OUTPUT_ENABLE_MASK(ldo);\n\n\treturn lp3972_set_bits(lp3972, LP3972_LDO_OUTPUT_ENABLE_REG(ldo),\n\t\t\t\tmask, 0);\n}\n\nstatic int lp3972_ldo_get_voltage_sel(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint ldo = rdev_get_id(dev) - LP3972_LDO1;\n\tu16 mask = LP3972_LDO_VOL_MASK(ldo);\n\tu16 val, reg;\n\n\treg = lp3972_reg_read(lp3972, LP3972_LDO_VOL_CONTR_REG(ldo));\n\tval = (reg >> LP3972_LDO_VOL_CONTR_SHIFT(ldo)) & mask;\n\n\treturn val;\n}\n\nstatic int lp3972_ldo_set_voltage_sel(struct regulator_dev *dev,\n\t\t\t\t      unsigned int selector)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint ldo = rdev_get_id(dev) - LP3972_LDO1;\n\tint shift, ret;\n\n\tshift = LP3972_LDO_VOL_CONTR_SHIFT(ldo);\n\tret = lp3972_set_bits(lp3972, LP3972_LDO_VOL_CONTR_REG(ldo),\n\t\tLP3972_LDO_VOL_MASK(ldo) << shift, selector << shift);\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tswitch (ldo) {\n\tcase LP3972_LDO1:\n\tcase LP3972_LDO5:\n\t\tshift = LP3972_LDO_VOL_CHANGE_SHIFT(ldo);\n\t\tret = lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\n\t\t\tLP3972_VOL_CHANGE_FLAG_MASK << shift,\n\t\t\tLP3972_VOL_CHANGE_FLAG_GO << shift);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\n\t\t\tLP3972_VOL_CHANGE_FLAG_MASK << shift, 0);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct regulator_ops lp3972_ldo_ops = {\n\t.list_voltage = regulator_list_voltage_table,\n\t.map_voltage = regulator_map_voltage_ascend,\n\t.is_enabled = lp3972_ldo_is_enabled,\n\t.enable = lp3972_ldo_enable,\n\t.disable = lp3972_ldo_disable,\n\t.get_voltage_sel = lp3972_ldo_get_voltage_sel,\n\t.set_voltage_sel = lp3972_ldo_set_voltage_sel,\n};\n\nstatic int lp3972_dcdc_is_enabled(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint buck = rdev_get_id(dev) - LP3972_DCDC1;\n\tu16 mask = 1 << (buck * 2);\n\tu16 val;\n\n\tval = lp3972_reg_read(lp3972, LP3972_BUCK_VOL_ENABLE_REG(buck));\n\treturn !!(val & mask);\n}\n\nstatic int lp3972_dcdc_enable(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint buck = rdev_get_id(dev) - LP3972_DCDC1;\n\tu16 mask = 1 << (buck * 2);\n\tu16 val;\n\n\tval = lp3972_set_bits(lp3972, LP3972_BUCK_VOL_ENABLE_REG(buck),\n\t\t\t\tmask, mask);\n\treturn val;\n}\n\nstatic int lp3972_dcdc_disable(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint buck = rdev_get_id(dev) - LP3972_DCDC1;\n\tu16 mask = 1 << (buck * 2);\n\tu16 val;\n\n\tval = lp3972_set_bits(lp3972, LP3972_BUCK_VOL_ENABLE_REG(buck),\n\t\t\t\tmask, 0);\n\treturn val;\n}\n\nstatic int lp3972_dcdc_get_voltage_sel(struct regulator_dev *dev)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint buck = rdev_get_id(dev) - LP3972_DCDC1;\n\tu16 reg;\n\n\treg = lp3972_reg_read(lp3972, LP3972_BUCK_VOL1_REG(buck));\n\treg &= LP3972_BUCK_VOL_MASK;\n\n\treturn reg;\n}\n\nstatic int lp3972_dcdc_set_voltage_sel(struct regulator_dev *dev,\n\t\t\t\t       unsigned int selector)\n{\n\tstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\n\tint buck = rdev_get_id(dev) - LP3972_DCDC1;\n\tint ret;\n\n\tret = lp3972_set_bits(lp3972, LP3972_BUCK_VOL1_REG(buck),\n\t\t\t\tLP3972_BUCK_VOL_MASK, selector);\n\tif (ret)\n\t\treturn ret;\n\n\tif (buck != 0)\n\t\treturn ret;\n\n\tret = lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\n\t\tLP3972_VOL_CHANGE_FLAG_MASK, LP3972_VOL_CHANGE_FLAG_GO);\n\tif (ret)\n\t\treturn ret;\n\n\treturn lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\n\t\t\t\tLP3972_VOL_CHANGE_FLAG_MASK, 0);\n}\n\nstatic const struct regulator_ops lp3972_dcdc_ops = {\n\t.list_voltage = regulator_list_voltage_table,\n\t.map_voltage = regulator_map_voltage_ascend,\n\t.is_enabled = lp3972_dcdc_is_enabled,\n\t.enable = lp3972_dcdc_enable,\n\t.disable = lp3972_dcdc_disable,\n\t.get_voltage_sel = lp3972_dcdc_get_voltage_sel,\n\t.set_voltage_sel = lp3972_dcdc_set_voltage_sel,\n};\n\nstatic const struct regulator_desc regulators[] = {\n\t{\n\t\t.name = \"LDO1\",\n\t\t.id = LP3972_LDO1,\n\t\t.ops = &lp3972_ldo_ops,\n\t\t.n_voltages = ARRAY_SIZE(ldo1_voltage_map),\n\t\t.volt_table = ldo1_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"LDO2\",\n\t\t.id = LP3972_LDO2,\n\t\t.ops = &lp3972_ldo_ops,\n\t\t.n_voltages = ARRAY_SIZE(ldo23_voltage_map),\n\t\t.volt_table = ldo23_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"LDO3\",\n\t\t.id = LP3972_LDO3,\n\t\t.ops = &lp3972_ldo_ops,\n\t\t.n_voltages = ARRAY_SIZE(ldo23_voltage_map),\n\t\t.volt_table = ldo23_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"LDO4\",\n\t\t.id = LP3972_LDO4,\n\t\t.ops = &lp3972_ldo_ops,\n\t\t.n_voltages = ARRAY_SIZE(ldo4_voltage_map),\n\t\t.volt_table = ldo4_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"LDO5\",\n\t\t.id = LP3972_LDO5,\n\t\t.ops = &lp3972_ldo_ops,\n\t\t.n_voltages = ARRAY_SIZE(ldo5_voltage_map),\n\t\t.volt_table = ldo5_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"DCDC1\",\n\t\t.id = LP3972_DCDC1,\n\t\t.ops = &lp3972_dcdc_ops,\n\t\t.n_voltages = ARRAY_SIZE(buck1_voltage_map),\n\t\t.volt_table = buck1_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"DCDC2\",\n\t\t.id = LP3972_DCDC2,\n\t\t.ops = &lp3972_dcdc_ops,\n\t\t.n_voltages = ARRAY_SIZE(buck23_voltage_map),\n\t\t.volt_table = buck23_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n\t{\n\t\t.name = \"DCDC3\",\n\t\t.id = LP3972_DCDC3,\n\t\t.ops = &lp3972_dcdc_ops,\n\t\t.n_voltages = ARRAY_SIZE(buck23_voltage_map),\n\t\t.volt_table = buck23_voltage_map,\n\t\t.type = REGULATOR_VOLTAGE,\n\t\t.owner = THIS_MODULE,\n\t},\n};\n\nstatic int setup_regulators(struct lp3972 *lp3972,\n\tstruct lp3972_platform_data *pdata)\n{\n\tint i, err;\n\n\t \n\tfor (i = 0; i < pdata->num_regulators; i++) {\n\t\tstruct lp3972_regulator_subdev *reg = &pdata->regulators[i];\n\t\tstruct regulator_config config = { };\n\t\tstruct regulator_dev *rdev;\n\n\t\tconfig.dev = lp3972->dev;\n\t\tconfig.init_data = reg->initdata;\n\t\tconfig.driver_data = lp3972;\n\n\t\trdev = devm_regulator_register(lp3972->dev,\n\t\t\t\t\t       &regulators[reg->id], &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\terr = PTR_ERR(rdev);\n\t\t\tdev_err(lp3972->dev, \"regulator init failed: %d\\n\",\n\t\t\t\terr);\n\t\t\treturn err;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int lp3972_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct lp3972 *lp3972;\n\tstruct lp3972_platform_data *pdata = dev_get_platdata(&i2c->dev);\n\tint ret;\n\tu16 val;\n\n\tif (!pdata) {\n\t\tdev_dbg(&i2c->dev, \"No platform init data supplied\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tlp3972 = devm_kzalloc(&i2c->dev, sizeof(struct lp3972), GFP_KERNEL);\n\tif (!lp3972)\n\t\treturn -ENOMEM;\n\n\tlp3972->i2c = i2c;\n\tlp3972->dev = &i2c->dev;\n\n\tmutex_init(&lp3972->io_lock);\n\n\t \n\tret = lp3972_i2c_read(i2c, LP3972_SYS_CONTROL1_REG, 1, &val);\n\tif (ret == 0 &&\n\t\t(val & SYS_CONTROL1_INIT_MASK) != SYS_CONTROL1_INIT_VAL) {\n\t\tret = -ENODEV;\n\t\tdev_err(&i2c->dev, \"chip reported: val = 0x%x\\n\", val);\n\t}\n\tif (ret < 0) {\n\t\tdev_err(&i2c->dev, \"failed to detect device. ret = %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = setup_regulators(lp3972, pdata);\n\tif (ret < 0)\n\t\treturn ret;\n\n\ti2c_set_clientdata(i2c, lp3972);\n\treturn 0;\n}\n\nstatic const struct i2c_device_id lp3972_i2c_id[] = {\n\t{ \"lp3972\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, lp3972_i2c_id);\n\nstatic struct i2c_driver lp3972_i2c_driver = {\n\t.driver = {\n\t\t.name = \"lp3972\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = lp3972_i2c_probe,\n\t.id_table = lp3972_i2c_id,\n};\n\nstatic int __init lp3972_module_init(void)\n{\n\treturn i2c_add_driver(&lp3972_i2c_driver);\n}\nsubsys_initcall(lp3972_module_init);\n\nstatic void __exit lp3972_module_exit(void)\n{\n\ti2c_del_driver(&lp3972_i2c_driver);\n}\nmodule_exit(lp3972_module_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Axel Lin <axel.lin@gmail.com>\");\nMODULE_DESCRIPTION(\"LP3972 PMIC driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}