{
  "module_name": "max77650-regulator.c",
  "hash_id": "0b59ef470b633c350701e6c0276f002924e347bda1e01997c44ff7c5d4916360",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max77650-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/of.h>\n#include <linux/mfd/max77650.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n\n#define MAX77650_REGULATOR_EN_CTRL_MASK\t\tGENMASK(3, 0)\n#define MAX77650_REGULATOR_EN_CTRL_BITS(_reg) \\\n\t\t((_reg) & MAX77650_REGULATOR_EN_CTRL_MASK)\n#define MAX77650_REGULATOR_ENABLED\t\tGENMASK(2, 1)\n#define MAX77650_REGULATOR_DISABLED\t\tBIT(2)\n\n#define MAX77650_REGULATOR_V_LDO_MASK\t\tGENMASK(6, 0)\n#define MAX77650_REGULATOR_V_SBB_MASK\t\tGENMASK(5, 0)\n#define MAX77651_REGULATOR_V_SBB1_MASK\t\tGENMASK(5, 2)\n#define MAX77651_REGULATOR_V_SBB1_RANGE_MASK\tGENMASK(1, 0)\n\n#define MAX77650_REGULATOR_AD_MASK\t\tBIT(3)\n#define MAX77650_REGULATOR_AD_DISABLED\t\t0x00\n#define MAX77650_REGULATOR_AD_ENABLED\t\tBIT(3)\n\n#define MAX77650_REGULATOR_CURR_LIM_MASK\tGENMASK(7, 6)\n\nenum {\n\tMAX77650_REGULATOR_ID_LDO = 0,\n\tMAX77650_REGULATOR_ID_SBB0,\n\tMAX77650_REGULATOR_ID_SBB1,\n\tMAX77650_REGULATOR_ID_SBB2,\n\tMAX77650_REGULATOR_NUM_REGULATORS,\n};\n\nstruct max77650_regulator_desc {\n\tstruct regulator_desc desc;\n\tunsigned int regA;\n\tunsigned int regB;\n};\n\nstatic struct max77650_regulator_desc max77651_SBB1_desc;\n\nstatic const unsigned int max77651_sbb1_volt_range_sel[] = {\n\t0x0, 0x1, 0x2, 0x3\n};\n\nstatic const struct linear_range max77651_sbb1_volt_ranges[] = {\n\t \n\tREGULATOR_LINEAR_RANGE(2400000, 0x00, 0x0f, 50000),\n\t \n\tREGULATOR_LINEAR_RANGE(3200000, 0x00, 0x0f, 50000),\n\t \n\tREGULATOR_LINEAR_RANGE(4000000, 0x00, 0x0f, 50000),\n\t \n\tREGULATOR_LINEAR_RANGE(4800000, 0x00, 0x09, 50000),\n};\n\nstatic const unsigned int max77650_current_limit_table[] = {\n\t1000000, 866000, 707000, 500000,\n};\n\nstatic int max77650_regulator_is_enabled(struct regulator_dev *rdev)\n{\n\tstruct max77650_regulator_desc *rdesc;\n\tstruct regmap *map;\n\tint val, rv, en;\n\n\trdesc = rdev_get_drvdata(rdev);\n\tmap = rdev_get_regmap(rdev);\n\n\trv = regmap_read(map, rdesc->regB, &val);\n\tif (rv)\n\t\treturn rv;\n\n\ten = MAX77650_REGULATOR_EN_CTRL_BITS(val);\n\n\treturn en != MAX77650_REGULATOR_DISABLED;\n}\n\nstatic int max77650_regulator_enable(struct regulator_dev *rdev)\n{\n\tstruct max77650_regulator_desc *rdesc;\n\tstruct regmap *map;\n\n\trdesc = rdev_get_drvdata(rdev);\n\tmap = rdev_get_regmap(rdev);\n\n\treturn regmap_update_bits(map, rdesc->regB,\n\t\t\t\t  MAX77650_REGULATOR_EN_CTRL_MASK,\n\t\t\t\t  MAX77650_REGULATOR_ENABLED);\n}\n\nstatic int max77650_regulator_disable(struct regulator_dev *rdev)\n{\n\tstruct max77650_regulator_desc *rdesc;\n\tstruct regmap *map;\n\n\trdesc = rdev_get_drvdata(rdev);\n\tmap = rdev_get_regmap(rdev);\n\n\treturn regmap_update_bits(map, rdesc->regB,\n\t\t\t\t  MAX77650_REGULATOR_EN_CTRL_MASK,\n\t\t\t\t  MAX77650_REGULATOR_DISABLED);\n}\n\nstatic const struct regulator_ops max77650_regulator_LDO_ops = {\n\t.is_enabled\t\t= max77650_regulator_is_enabled,\n\t.enable\t\t\t= max77650_regulator_enable,\n\t.disable\t\t= max77650_regulator_disable,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.set_active_discharge\t= regulator_set_active_discharge_regmap,\n};\n\nstatic const struct regulator_ops max77650_regulator_SBB_ops = {\n\t.is_enabled\t\t= max77650_regulator_is_enabled,\n\t.enable\t\t\t= max77650_regulator_enable,\n\t.disable\t\t= max77650_regulator_disable,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.get_current_limit\t= regulator_get_current_limit_regmap,\n\t.set_current_limit\t= regulator_set_current_limit_regmap,\n\t.set_active_discharge\t= regulator_set_active_discharge_regmap,\n};\n\n \nstatic const struct regulator_ops max77651_SBB1_regulator_ops = {\n\t.is_enabled\t\t= max77650_regulator_is_enabled,\n\t.enable\t\t\t= max77650_regulator_enable,\n\t.disable\t\t= max77650_regulator_disable,\n\t.list_voltage\t\t= regulator_list_voltage_pickable_linear_range,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_pickable_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_pickable_regmap,\n\t.get_current_limit\t= regulator_get_current_limit_regmap,\n\t.set_current_limit\t= regulator_set_current_limit_regmap,\n\t.set_active_discharge\t= regulator_set_active_discharge_regmap,\n};\n\nstatic struct max77650_regulator_desc max77650_LDO_desc = {\n\t.desc = {\n\t\t.name\t\t\t= \"ldo\",\n\t\t.of_match\t\t= of_match_ptr(\"ldo\"),\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\n\t\t.supply_name\t\t= \"in-ldo\",\n\t\t.id\t\t\t= MAX77650_REGULATOR_ID_LDO,\n\t\t.ops\t\t\t= &max77650_regulator_LDO_ops,\n\t\t.min_uV\t\t\t= 1350000,\n\t\t.uV_step\t\t= 12500,\n\t\t.n_voltages\t\t= 128,\n\t\t.vsel_step\t\t= 1,\n\t\t.vsel_mask\t\t= MAX77650_REGULATOR_V_LDO_MASK,\n\t\t.vsel_reg\t\t= MAX77650_REG_CNFG_LDO_A,\n\t\t.active_discharge_off\t= MAX77650_REGULATOR_AD_DISABLED,\n\t\t.active_discharge_on\t= MAX77650_REGULATOR_AD_ENABLED,\n\t\t.active_discharge_mask\t= MAX77650_REGULATOR_AD_MASK,\n\t\t.active_discharge_reg\t= MAX77650_REG_CNFG_LDO_B,\n\t\t.enable_time\t\t= 100,\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\n\t\t.owner\t\t\t= THIS_MODULE,\n\t},\n\t.regA\t\t= MAX77650_REG_CNFG_LDO_A,\n\t.regB\t\t= MAX77650_REG_CNFG_LDO_B,\n};\n\nstatic struct max77650_regulator_desc max77650_SBB0_desc = {\n\t.desc = {\n\t\t.name\t\t\t= \"sbb0\",\n\t\t.of_match\t\t= of_match_ptr(\"sbb0\"),\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\n\t\t.supply_name\t\t= \"in-sbb0\",\n\t\t.id\t\t\t= MAX77650_REGULATOR_ID_SBB0,\n\t\t.ops\t\t\t= &max77650_regulator_SBB_ops,\n\t\t.min_uV\t\t\t= 800000,\n\t\t.uV_step\t\t= 25000,\n\t\t.n_voltages\t\t= 64,\n\t\t.vsel_step\t\t= 1,\n\t\t.vsel_mask\t\t= MAX77650_REGULATOR_V_SBB_MASK,\n\t\t.vsel_reg\t\t= MAX77650_REG_CNFG_SBB0_A,\n\t\t.active_discharge_off\t= MAX77650_REGULATOR_AD_DISABLED,\n\t\t.active_discharge_on\t= MAX77650_REGULATOR_AD_ENABLED,\n\t\t.active_discharge_mask\t= MAX77650_REGULATOR_AD_MASK,\n\t\t.active_discharge_reg\t= MAX77650_REG_CNFG_SBB0_B,\n\t\t.enable_time\t\t= 100,\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\n\t\t.owner\t\t\t= THIS_MODULE,\n\t\t.csel_reg\t\t= MAX77650_REG_CNFG_SBB0_A,\n\t\t.csel_mask\t\t= MAX77650_REGULATOR_CURR_LIM_MASK,\n\t\t.curr_table\t\t= max77650_current_limit_table,\n\t\t.n_current_limits = ARRAY_SIZE(max77650_current_limit_table),\n\t},\n\t.regA\t\t= MAX77650_REG_CNFG_SBB0_A,\n\t.regB\t\t= MAX77650_REG_CNFG_SBB0_B,\n};\n\nstatic struct max77650_regulator_desc max77650_SBB1_desc = {\n\t.desc = {\n\t\t.name\t\t\t= \"sbb1\",\n\t\t.of_match\t\t= of_match_ptr(\"sbb1\"),\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\n\t\t.supply_name\t\t= \"in-sbb1\",\n\t\t.id\t\t\t= MAX77650_REGULATOR_ID_SBB1,\n\t\t.ops\t\t\t= &max77650_regulator_SBB_ops,\n\t\t.min_uV\t\t\t= 800000,\n\t\t.uV_step\t\t= 12500,\n\t\t.n_voltages\t\t= 64,\n\t\t.vsel_step\t\t= 1,\n\t\t.vsel_mask\t\t= MAX77650_REGULATOR_V_SBB_MASK,\n\t\t.vsel_reg\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t\t.active_discharge_off\t= MAX77650_REGULATOR_AD_DISABLED,\n\t\t.active_discharge_on\t= MAX77650_REGULATOR_AD_ENABLED,\n\t\t.active_discharge_mask\t= MAX77650_REGULATOR_AD_MASK,\n\t\t.active_discharge_reg\t= MAX77650_REG_CNFG_SBB1_B,\n\t\t.enable_time\t\t= 100,\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\n\t\t.owner\t\t\t= THIS_MODULE,\n\t\t.csel_reg\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t\t.csel_mask\t\t= MAX77650_REGULATOR_CURR_LIM_MASK,\n\t\t.curr_table\t\t= max77650_current_limit_table,\n\t\t.n_current_limits = ARRAY_SIZE(max77650_current_limit_table),\n\t},\n\t.regA\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t.regB\t\t= MAX77650_REG_CNFG_SBB1_B,\n};\n\nstatic struct max77650_regulator_desc max77651_SBB1_desc = {\n\t.desc = {\n\t\t.name\t\t\t= \"sbb1\",\n\t\t.of_match\t\t= of_match_ptr(\"sbb1\"),\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\n\t\t.supply_name\t\t= \"in-sbb1\",\n\t\t.id\t\t\t= MAX77650_REGULATOR_ID_SBB1,\n\t\t.ops\t\t\t= &max77651_SBB1_regulator_ops,\n\t\t.linear_range_selectors_bitfield\t= max77651_sbb1_volt_range_sel,\n\t\t.linear_ranges\t\t= max77651_sbb1_volt_ranges,\n\t\t.n_linear_ranges\t= ARRAY_SIZE(max77651_sbb1_volt_ranges),\n\t\t.n_voltages\t\t= 58,\n\t\t.vsel_step\t\t= 1,\n\t\t.vsel_range_mask\t= MAX77651_REGULATOR_V_SBB1_RANGE_MASK,\n\t\t.vsel_range_reg\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t\t.vsel_mask\t\t= MAX77651_REGULATOR_V_SBB1_MASK,\n\t\t.vsel_reg\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t\t.active_discharge_off\t= MAX77650_REGULATOR_AD_DISABLED,\n\t\t.active_discharge_on\t= MAX77650_REGULATOR_AD_ENABLED,\n\t\t.active_discharge_mask\t= MAX77650_REGULATOR_AD_MASK,\n\t\t.active_discharge_reg\t= MAX77650_REG_CNFG_SBB1_B,\n\t\t.enable_time\t\t= 100,\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\n\t\t.owner\t\t\t= THIS_MODULE,\n\t\t.csel_reg\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t\t.csel_mask\t\t= MAX77650_REGULATOR_CURR_LIM_MASK,\n\t\t.curr_table\t\t= max77650_current_limit_table,\n\t\t.n_current_limits = ARRAY_SIZE(max77650_current_limit_table),\n\t},\n\t.regA\t\t= MAX77650_REG_CNFG_SBB1_A,\n\t.regB\t\t= MAX77650_REG_CNFG_SBB1_B,\n};\n\nstatic struct max77650_regulator_desc max77650_SBB2_desc = {\n\t.desc = {\n\t\t.name\t\t\t= \"sbb2\",\n\t\t.of_match\t\t= of_match_ptr(\"sbb2\"),\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\n\t\t.supply_name\t\t= \"in-sbb0\",\n\t\t.id\t\t\t= MAX77650_REGULATOR_ID_SBB2,\n\t\t.ops\t\t\t= &max77650_regulator_SBB_ops,\n\t\t.min_uV\t\t\t= 800000,\n\t\t.uV_step\t\t= 50000,\n\t\t.n_voltages\t\t= 64,\n\t\t.vsel_step\t\t= 1,\n\t\t.vsel_mask\t\t= MAX77650_REGULATOR_V_SBB_MASK,\n\t\t.vsel_reg\t\t= MAX77650_REG_CNFG_SBB2_A,\n\t\t.active_discharge_off\t= MAX77650_REGULATOR_AD_DISABLED,\n\t\t.active_discharge_on\t= MAX77650_REGULATOR_AD_ENABLED,\n\t\t.active_discharge_mask\t= MAX77650_REGULATOR_AD_MASK,\n\t\t.active_discharge_reg\t= MAX77650_REG_CNFG_SBB2_B,\n\t\t.enable_time\t\t= 100,\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\n\t\t.owner\t\t\t= THIS_MODULE,\n\t\t.csel_reg\t\t= MAX77650_REG_CNFG_SBB2_A,\n\t\t.csel_mask\t\t= MAX77650_REGULATOR_CURR_LIM_MASK,\n\t\t.curr_table\t\t= max77650_current_limit_table,\n\t\t.n_current_limits = ARRAY_SIZE(max77650_current_limit_table),\n\t},\n\t.regA\t\t= MAX77650_REG_CNFG_SBB2_A,\n\t.regB\t\t= MAX77650_REG_CNFG_SBB2_B,\n};\n\nstatic struct max77650_regulator_desc max77651_SBB2_desc = {\n\t.desc = {\n\t\t.name\t\t\t= \"sbb2\",\n\t\t.of_match\t\t= of_match_ptr(\"sbb2\"),\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\n\t\t.supply_name\t\t= \"in-sbb0\",\n\t\t.id\t\t\t= MAX77650_REGULATOR_ID_SBB2,\n\t\t.ops\t\t\t= &max77650_regulator_SBB_ops,\n\t\t.min_uV\t\t\t= 2400000,\n\t\t.uV_step\t\t= 50000,\n\t\t.n_voltages\t\t= 64,\n\t\t.vsel_step\t\t= 1,\n\t\t.vsel_mask\t\t= MAX77650_REGULATOR_V_SBB_MASK,\n\t\t.vsel_reg\t\t= MAX77650_REG_CNFG_SBB2_A,\n\t\t.active_discharge_off\t= MAX77650_REGULATOR_AD_DISABLED,\n\t\t.active_discharge_on\t= MAX77650_REGULATOR_AD_ENABLED,\n\t\t.active_discharge_mask\t= MAX77650_REGULATOR_AD_MASK,\n\t\t.active_discharge_reg\t= MAX77650_REG_CNFG_SBB2_B,\n\t\t.enable_time\t\t= 100,\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\n\t\t.owner\t\t\t= THIS_MODULE,\n\t\t.csel_reg\t\t= MAX77650_REG_CNFG_SBB2_A,\n\t\t.csel_mask\t\t= MAX77650_REGULATOR_CURR_LIM_MASK,\n\t\t.curr_table\t\t= max77650_current_limit_table,\n\t\t.n_current_limits = ARRAY_SIZE(max77650_current_limit_table),\n\t},\n\t.regA\t\t= MAX77650_REG_CNFG_SBB2_A,\n\t.regB\t\t= MAX77650_REG_CNFG_SBB2_B,\n};\n\nstatic int max77650_regulator_probe(struct platform_device *pdev)\n{\n\tstruct max77650_regulator_desc **rdescs;\n\tstruct max77650_regulator_desc *rdesc;\n\tstruct regulator_config config = { };\n\tstruct device *dev, *parent;\n\tstruct regulator_dev *rdev;\n\tstruct regmap *map;\n\tunsigned int val;\n\tint i, rv;\n\n\tdev = &pdev->dev;\n\tparent = dev->parent;\n\n\tif (!dev->of_node)\n\t\tdev->of_node = parent->of_node;\n\n\trdescs = devm_kcalloc(dev, MAX77650_REGULATOR_NUM_REGULATORS,\n\t\t\t      sizeof(*rdescs), GFP_KERNEL);\n\tif (!rdescs)\n\t\treturn -ENOMEM;\n\n\tmap = dev_get_regmap(parent, NULL);\n\tif (!map)\n\t\treturn -ENODEV;\n\n\trv = regmap_read(map, MAX77650_REG_CID, &val);\n\tif (rv)\n\t\treturn rv;\n\n\trdescs[MAX77650_REGULATOR_ID_LDO] = &max77650_LDO_desc;\n\trdescs[MAX77650_REGULATOR_ID_SBB0] = &max77650_SBB0_desc;\n\n\tswitch (MAX77650_CID_BITS(val)) {\n\tcase MAX77650_CID_77650A:\n\tcase MAX77650_CID_77650C:\n\t\trdescs[MAX77650_REGULATOR_ID_SBB1] = &max77650_SBB1_desc;\n\t\trdescs[MAX77650_REGULATOR_ID_SBB2] = &max77650_SBB2_desc;\n\t\tbreak;\n\tcase MAX77650_CID_77651A:\n\tcase MAX77650_CID_77651B:\n\t\trdescs[MAX77650_REGULATOR_ID_SBB1] = &max77651_SBB1_desc;\n\t\trdescs[MAX77650_REGULATOR_ID_SBB2] = &max77651_SBB2_desc;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\n\tconfig.dev = parent;\n\n\tfor (i = 0; i < MAX77650_REGULATOR_NUM_REGULATORS; i++) {\n\t\trdesc = rdescs[i];\n\t\tconfig.driver_data = rdesc;\n\n\t\trdev = devm_regulator_register(dev, &rdesc->desc, &config);\n\t\tif (IS_ERR(rdev))\n\t\t\treturn PTR_ERR(rdev);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id max77650_regulator_of_match[] = {\n\t{ .compatible = \"maxim,max77650-regulator\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max77650_regulator_of_match);\n\nstatic struct platform_driver max77650_regulator_driver = {\n\t.driver = {\n\t\t.name = \"max77650-regulator\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = max77650_regulator_of_match,\n\t},\n\t.probe = max77650_regulator_probe,\n};\nmodule_platform_driver(max77650_regulator_driver);\n\nMODULE_DESCRIPTION(\"MAXIM 77650/77651 regulator driver\");\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:max77650-regulator\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}