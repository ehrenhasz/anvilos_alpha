{
  "module_name": "as3722-regulator.c",
  "hash_id": "271189dc0e545d52a36e223abc53781abc85ec8acb73b36b3b23bf2aac8fe76a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/as3722-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mfd/as3722.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/slab.h>\n\n \nenum as3722_regulators_id {\n\tAS3722_REGULATOR_ID_SD0,\n\tAS3722_REGULATOR_ID_SD1,\n\tAS3722_REGULATOR_ID_SD2,\n\tAS3722_REGULATOR_ID_SD3,\n\tAS3722_REGULATOR_ID_SD4,\n\tAS3722_REGULATOR_ID_SD5,\n\tAS3722_REGULATOR_ID_SD6,\n\tAS3722_REGULATOR_ID_LDO0,\n\tAS3722_REGULATOR_ID_LDO1,\n\tAS3722_REGULATOR_ID_LDO2,\n\tAS3722_REGULATOR_ID_LDO3,\n\tAS3722_REGULATOR_ID_LDO4,\n\tAS3722_REGULATOR_ID_LDO5,\n\tAS3722_REGULATOR_ID_LDO6,\n\tAS3722_REGULATOR_ID_LDO7,\n\tAS3722_REGULATOR_ID_LDO9,\n\tAS3722_REGULATOR_ID_LDO10,\n\tAS3722_REGULATOR_ID_LDO11,\n\tAS3722_REGULATOR_ID_MAX,\n};\n\nstruct as3722_register_mapping {\n\tu8 regulator_id;\n\tconst char *name;\n\tconst char *sname;\n\tu8 vsel_reg;\n\tu8 vsel_mask;\n\tint n_voltages;\n\tu32 enable_reg;\n\tu8 enable_mask;\n\tu32 control_reg;\n\tu8 mode_mask;\n\tu32 sleep_ctrl_reg;\n\tu8 sleep_ctrl_mask;\n};\n\nstruct as3722_regulator_config_data {\n\tstruct regulator_init_data *reg_init;\n\tbool enable_tracking;\n\tint ext_control;\n};\n\nstruct as3722_regulators {\n\tstruct device *dev;\n\tstruct as3722 *as3722;\n\tstruct regulator_desc desc[AS3722_REGULATOR_ID_MAX];\n\tstruct as3722_regulator_config_data\n\t\t\treg_config_data[AS3722_REGULATOR_ID_MAX];\n};\n\nstatic const struct as3722_register_mapping as3722_reg_lookup[] = {\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD0,\n\t\t.name = \"as3722-sd0\",\n\t\t.vsel_reg = AS3722_SD0_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(0),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL1_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD0_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD0_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD0_MODE_FAST,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD1,\n\t\t.name = \"as3722-sd1\",\n\t\t.vsel_reg = AS3722_SD1_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(1),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL1_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD1_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD1_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD1_MODE_FAST,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD2,\n\t\t.name = \"as3722-sd2\",\n\t\t.sname = \"vsup-sd2\",\n\t\t.vsel_reg = AS3722_SD2_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(2),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL1_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD2_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD23_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD2_MODE_FAST,\n\t\t.n_voltages = AS3722_SD2_VSEL_MAX + 1,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD3,\n\t\t.name = \"as3722-sd3\",\n\t\t.sname = \"vsup-sd3\",\n\t\t.vsel_reg = AS3722_SD3_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(3),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL1_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD3_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD23_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD3_MODE_FAST,\n\t\t.n_voltages = AS3722_SD2_VSEL_MAX + 1,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD4,\n\t\t.name = \"as3722-sd4\",\n\t\t.sname = \"vsup-sd4\",\n\t\t.vsel_reg = AS3722_SD4_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(4),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL2_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD4_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD4_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD4_MODE_FAST,\n\t\t.n_voltages = AS3722_SD2_VSEL_MAX + 1,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD5,\n\t\t.name = \"as3722-sd5\",\n\t\t.sname = \"vsup-sd5\",\n\t\t.vsel_reg = AS3722_SD5_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(5),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL2_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD5_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD5_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD5_MODE_FAST,\n\t\t.n_voltages = AS3722_SD2_VSEL_MAX + 1,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_SD6,\n\t\t.name = \"as3722-sd6\",\n\t\t.vsel_reg = AS3722_SD6_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_SD_VSEL_MASK,\n\t\t.enable_reg = AS3722_SD_CONTROL_REG,\n\t\t.enable_mask = AS3722_SDn_CTRL(6),\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL2_REG,\n\t\t.sleep_ctrl_mask = AS3722_SD6_EXT_ENABLE_MASK,\n\t\t.control_reg = AS3722_SD6_CONTROL_REG,\n\t\t.mode_mask = AS3722_SD6_MODE_FAST,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO0,\n\t\t.name = \"as3722-ldo0\",\n\t\t.sname = \"vin-ldo0\",\n\t\t.vsel_reg = AS3722_LDO0_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO0_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO0_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL3_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO0_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO0_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO1,\n\t\t.name = \"as3722-ldo1\",\n\t\t.sname = \"vin-ldo1-6\",\n\t\t.vsel_reg = AS3722_LDO1_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO1_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL3_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO1_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO2,\n\t\t.name = \"as3722-ldo2\",\n\t\t.sname = \"vin-ldo2-5-7\",\n\t\t.vsel_reg = AS3722_LDO2_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO2_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL3_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO2_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO3,\n\t\t.name = \"as3722-ldo3\",\n\t\t.sname = \"vin-ldo3-4\",\n\t\t.vsel_reg = AS3722_LDO3_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO3_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO3_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL3_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO3_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO3_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO4,\n\t\t.name = \"as3722-ldo4\",\n\t\t.sname = \"vin-ldo3-4\",\n\t\t.vsel_reg = AS3722_LDO4_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO4_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL4_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO4_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO5,\n\t\t.name = \"as3722-ldo5\",\n\t\t.sname = \"vin-ldo2-5-7\",\n\t\t.vsel_reg = AS3722_LDO5_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO5_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL4_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO5_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO6,\n\t\t.name = \"as3722-ldo6\",\n\t\t.sname = \"vin-ldo1-6\",\n\t\t.vsel_reg = AS3722_LDO6_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO6_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL4_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO6_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO7,\n\t\t.name = \"as3722-ldo7\",\n\t\t.sname = \"vin-ldo2-5-7\",\n\t\t.vsel_reg = AS3722_LDO7_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL0_REG,\n\t\t.enable_mask = AS3722_LDO7_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL4_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO7_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO9,\n\t\t.name = \"as3722-ldo9\",\n\t\t.sname = \"vin-ldo9-10\",\n\t\t.vsel_reg = AS3722_LDO9_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL1_REG,\n\t\t.enable_mask = AS3722_LDO9_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL5_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO9_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO10,\n\t\t.name = \"as3722-ldo10\",\n\t\t.sname = \"vin-ldo9-10\",\n\t\t.vsel_reg = AS3722_LDO10_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL1_REG,\n\t\t.enable_mask = AS3722_LDO10_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL5_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO10_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n\t{\n\t\t.regulator_id = AS3722_REGULATOR_ID_LDO11,\n\t\t.name = \"as3722-ldo11\",\n\t\t.sname = \"vin-ldo11\",\n\t\t.vsel_reg = AS3722_LDO11_VOLTAGE_REG,\n\t\t.vsel_mask = AS3722_LDO_VSEL_MASK,\n\t\t.enable_reg = AS3722_LDOCONTROL1_REG,\n\t\t.enable_mask = AS3722_LDO11_CTRL,\n\t\t.sleep_ctrl_reg = AS3722_ENABLE_CTRL5_REG,\n\t\t.sleep_ctrl_mask = AS3722_LDO11_EXT_ENABLE_MASK,\n\t\t.n_voltages = AS3722_LDO_NUM_VOLT,\n\t},\n};\n\nstatic const unsigned int as3722_ldo_current[] = { 150000, 300000 };\nstatic const unsigned int as3722_sd016_current[] = {\n\t2500000, 3000000, 3500000\n};\n\nstatic const struct regulator_ops as3722_ldo0_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n};\n\nstatic const struct regulator_ops as3722_ldo0_extcntrl_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n};\n\nstatic int as3722_ldo3_set_tracking_mode(struct as3722_regulators *as3722_reg,\n\t\tint id, u8 mode)\n{\n\tstruct as3722 *as3722 = as3722_reg->as3722;\n\n\tswitch (mode) {\n\tcase AS3722_LDO3_MODE_PMOS:\n\tcase AS3722_LDO3_MODE_PMOS_TRACKING:\n\tcase AS3722_LDO3_MODE_NMOS:\n\tcase AS3722_LDO3_MODE_SWITCH:\n\t\treturn as3722_update_bits(as3722,\n\t\t\tas3722_reg_lookup[id].vsel_reg,\n\t\t\tAS3722_LDO3_MODE_MASK, mode);\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int as3722_ldo3_get_current_limit(struct regulator_dev *rdev)\n{\n\treturn 150000;\n}\n\nstatic const struct regulator_ops as3722_ldo3_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_current_limit = as3722_ldo3_get_current_limit,\n};\n\nstatic const struct regulator_ops as3722_ldo3_extcntrl_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_current_limit = as3722_ldo3_get_current_limit,\n};\n\nstatic const struct regulator_ops as3722_ldo6_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n\t.get_bypass = regulator_get_bypass_regmap,\n\t.set_bypass = regulator_set_bypass_regmap,\n};\n\nstatic const struct regulator_ops as3722_ldo6_extcntrl_ops = {\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n\t.get_bypass = regulator_get_bypass_regmap,\n\t.set_bypass = regulator_set_bypass_regmap,\n};\n\nstatic const struct linear_range as3722_ldo_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(0, 0x00, 0x00, 0),\n\tREGULATOR_LINEAR_RANGE(825000, 0x01, 0x24, 25000),\n\tREGULATOR_LINEAR_RANGE(1725000, 0x40, 0x7F, 25000),\n};\n\nstatic const struct regulator_ops as3722_ldo_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n};\n\nstatic const struct regulator_ops as3722_ldo_extcntrl_ops = {\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n};\n\nstatic unsigned int as3722_sd_get_mode(struct regulator_dev *rdev)\n{\n\tstruct as3722_regulators *as3722_regs = rdev_get_drvdata(rdev);\n\tstruct as3722 *as3722 = as3722_regs->as3722;\n\tint id = rdev_get_id(rdev);\n\tu32 val;\n\tint ret;\n\n\tif (!as3722_reg_lookup[id].control_reg)\n\t\treturn -ENOTSUPP;\n\n\tret = as3722_read(as3722, as3722_reg_lookup[id].control_reg, &val);\n\tif (ret < 0) {\n\t\tdev_err(as3722_regs->dev, \"Reg 0x%02x read failed: %d\\n\",\n\t\t\tas3722_reg_lookup[id].control_reg, ret);\n\t\treturn ret;\n\t}\n\n\tif (val & as3722_reg_lookup[id].mode_mask)\n\t\treturn REGULATOR_MODE_FAST;\n\telse\n\t\treturn REGULATOR_MODE_NORMAL;\n}\n\nstatic int as3722_sd_set_mode(struct regulator_dev *rdev,\n\t\tunsigned int mode)\n{\n\tstruct as3722_regulators *as3722_regs = rdev_get_drvdata(rdev);\n\tstruct as3722 *as3722 = as3722_regs->as3722;\n\tu8 id = rdev_get_id(rdev);\n\tu8 val = 0;\n\tint ret;\n\n\tif (!as3722_reg_lookup[id].control_reg)\n\t\treturn -ERANGE;\n\n\tswitch (mode) {\n\tcase REGULATOR_MODE_FAST:\n\t\tval = as3722_reg_lookup[id].mode_mask;\n\t\tfallthrough;\n\tcase REGULATOR_MODE_NORMAL:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = as3722_update_bits(as3722, as3722_reg_lookup[id].control_reg,\n\t\t\tas3722_reg_lookup[id].mode_mask, val);\n\tif (ret < 0) {\n\t\tdev_err(as3722_regs->dev, \"Reg 0x%02x update failed: %d\\n\",\n\t\t\tas3722_reg_lookup[id].control_reg, ret);\n\t\treturn ret;\n\t}\n\treturn ret;\n}\n\nstatic bool as3722_sd0_is_low_voltage(struct as3722_regulators *as3722_regs)\n{\n\tint err;\n\tunsigned val;\n\n\terr = as3722_read(as3722_regs->as3722, AS3722_FUSE7_REG, &val);\n\tif (err < 0) {\n\t\tdev_err(as3722_regs->dev, \"Reg 0x%02x read failed: %d\\n\",\n\t\t\tAS3722_FUSE7_REG, err);\n\t\treturn false;\n\t}\n\tif (val & AS3722_FUSE7_SD0_LOW_VOLTAGE)\n\t\treturn true;\n\treturn false;\n}\n\nstatic const struct linear_range as3722_sd2345_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(0, 0x00, 0x00, 0),\n\tREGULATOR_LINEAR_RANGE(612500, 0x01, 0x40, 12500),\n\tREGULATOR_LINEAR_RANGE(1425000, 0x41, 0x70, 25000),\n\tREGULATOR_LINEAR_RANGE(2650000, 0x71, 0x7F, 50000),\n};\n\nstatic const struct regulator_ops as3722_sd016_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.map_voltage = regulator_map_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n\t.get_mode = as3722_sd_get_mode,\n\t.set_mode = as3722_sd_set_mode,\n};\n\nstatic const struct regulator_ops as3722_sd016_extcntrl_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.map_voltage = regulator_map_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_current_limit = regulator_get_current_limit_regmap,\n\t.set_current_limit = regulator_set_current_limit_regmap,\n\t.get_mode = as3722_sd_get_mode,\n\t.set_mode = as3722_sd_set_mode,\n};\n\nstatic const struct regulator_ops as3722_sd2345_ops = {\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.get_mode = as3722_sd_get_mode,\n\t.set_mode = as3722_sd_set_mode,\n};\n\nstatic const struct regulator_ops as3722_sd2345_extcntrl_ops = {\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.get_mode = as3722_sd_get_mode,\n\t.set_mode = as3722_sd_set_mode,\n};\n\nstatic int as3722_extreg_init(struct as3722_regulators *as3722_regs, int id,\n\t\tint ext_pwr_ctrl)\n{\n\tint ret;\n\tunsigned int val;\n\n\tif ((ext_pwr_ctrl < AS3722_EXT_CONTROL_ENABLE1) ||\n\t\t(ext_pwr_ctrl > AS3722_EXT_CONTROL_ENABLE3))\n\t\treturn -EINVAL;\n\n\tval =  ext_pwr_ctrl << (ffs(as3722_reg_lookup[id].sleep_ctrl_mask) - 1);\n\tret = as3722_update_bits(as3722_regs->as3722,\n\t\t\tas3722_reg_lookup[id].sleep_ctrl_reg,\n\t\t\tas3722_reg_lookup[id].sleep_ctrl_mask, val);\n\tif (ret < 0)\n\t\tdev_err(as3722_regs->dev, \"Reg 0x%02x update failed: %d\\n\",\n\t\t\tas3722_reg_lookup[id].sleep_ctrl_reg, ret);\n\treturn ret;\n}\n\nstatic struct of_regulator_match as3722_regulator_matches[] = {\n\t{ .name = \"sd0\", },\n\t{ .name = \"sd1\", },\n\t{ .name = \"sd2\", },\n\t{ .name = \"sd3\", },\n\t{ .name = \"sd4\", },\n\t{ .name = \"sd5\", },\n\t{ .name = \"sd6\", },\n\t{ .name = \"ldo0\", },\n\t{ .name = \"ldo1\", },\n\t{ .name = \"ldo2\", },\n\t{ .name = \"ldo3\", },\n\t{ .name = \"ldo4\", },\n\t{ .name = \"ldo5\", },\n\t{ .name = \"ldo6\", },\n\t{ .name = \"ldo7\", },\n\t{ .name = \"ldo9\", },\n\t{ .name = \"ldo10\", },\n\t{ .name = \"ldo11\", },\n};\n\nstatic int as3722_get_regulator_dt_data(struct platform_device *pdev,\n\t\tstruct as3722_regulators *as3722_regs)\n{\n\tstruct device_node *np;\n\tstruct as3722_regulator_config_data *reg_config;\n\tu32 prop;\n\tint id;\n\tint ret;\n\n\tnp = of_get_child_by_name(pdev->dev.parent->of_node, \"regulators\");\n\tif (!np) {\n\t\tdev_err(&pdev->dev, \"Device is not having regulators node\\n\");\n\t\treturn -ENODEV;\n\t}\n\tpdev->dev.of_node = np;\n\n\tret = of_regulator_match(&pdev->dev, np, as3722_regulator_matches,\n\t\t\tARRAY_SIZE(as3722_regulator_matches));\n\tof_node_put(np);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Parsing of regulator node failed: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tfor (id = 0; id < ARRAY_SIZE(as3722_regulator_matches); ++id) {\n\t\tstruct device_node *reg_node;\n\n\t\treg_config = &as3722_regs->reg_config_data[id];\n\t\treg_config->reg_init = as3722_regulator_matches[id].init_data;\n\t\treg_node = as3722_regulator_matches[id].of_node;\n\n\t\tif (!reg_config->reg_init || !reg_node)\n\t\t\tcontinue;\n\n\t\tret = of_property_read_u32(reg_node, \"ams,ext-control\", &prop);\n\t\tif (!ret) {\n\t\t\tif (prop < 3)\n\t\t\t\treg_config->ext_control = prop;\n\t\t\telse\n\t\t\t\tdev_warn(&pdev->dev,\n\t\t\t\t\t\"ext-control have invalid option: %u\\n\",\n\t\t\t\t\tprop);\n\t\t}\n\t\treg_config->enable_tracking =\n\t\t\tof_property_read_bool(reg_node, \"ams,enable-tracking\");\n\t}\n\treturn 0;\n}\n\nstatic int as3722_regulator_probe(struct platform_device *pdev)\n{\n\tstruct as3722 *as3722 = dev_get_drvdata(pdev->dev.parent);\n\tstruct as3722_regulators *as3722_regs;\n\tstruct as3722_regulator_config_data *reg_config;\n\tstruct regulator_dev *rdev;\n\tstruct regulator_config config = { };\n\tconst struct regulator_ops *ops;\n\tint id;\n\tint ret;\n\n\tas3722_regs = devm_kzalloc(&pdev->dev, sizeof(*as3722_regs),\n\t\t\t\tGFP_KERNEL);\n\tif (!as3722_regs)\n\t\treturn -ENOMEM;\n\n\tas3722_regs->dev = &pdev->dev;\n\tas3722_regs->as3722 = as3722;\n\tplatform_set_drvdata(pdev, as3722_regs);\n\n\tret = as3722_get_regulator_dt_data(pdev, as3722_regs);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tconfig.dev = &pdev->dev;\n\tconfig.driver_data = as3722_regs;\n\tconfig.regmap = as3722->regmap;\n\n\tfor (id = 0; id < AS3722_REGULATOR_ID_MAX; id++) {\n\t\tstruct regulator_desc *desc;\n\n\t\tdesc = &as3722_regs->desc[id];\n\t\treg_config = &as3722_regs->reg_config_data[id];\n\n\t\tdesc->name = as3722_reg_lookup[id].name;\n\t\tdesc->supply_name = as3722_reg_lookup[id].sname;\n\t\tdesc->id = as3722_reg_lookup[id].regulator_id;\n\t\tdesc->n_voltages = as3722_reg_lookup[id].n_voltages;\n\t\tdesc->type = REGULATOR_VOLTAGE;\n\t\tdesc->owner = THIS_MODULE;\n\t\tdesc->enable_reg = as3722_reg_lookup[id].enable_reg;\n\t\tdesc->enable_mask = as3722_reg_lookup[id].enable_mask;\n\t\tdesc->vsel_reg = as3722_reg_lookup[id].vsel_reg;\n\t\tdesc->vsel_mask = as3722_reg_lookup[id].vsel_mask;\n\t\tswitch (id) {\n\t\tcase AS3722_REGULATOR_ID_LDO0:\n\t\t\tif (reg_config->ext_control)\n\t\t\t\tops = &as3722_ldo0_extcntrl_ops;\n\t\t\telse\n\t\t\t\tops = &as3722_ldo0_ops;\n\t\t\tdesc->min_uV = 825000;\n\t\t\tdesc->uV_step = 25000;\n\t\t\tdesc->linear_min_sel = 1;\n\t\t\tdesc->enable_time = 500;\n\t\t\tdesc->curr_table = as3722_ldo_current;\n\t\t\tdesc->n_current_limits = ARRAY_SIZE(as3722_ldo_current);\n\t\t\tdesc->csel_reg = as3722_reg_lookup[id].vsel_reg;\n\t\t\tdesc->csel_mask = AS3722_LDO_ILIMIT_MASK;\n\t\t\tbreak;\n\t\tcase AS3722_REGULATOR_ID_LDO3:\n\t\t\tif (reg_config->ext_control)\n\t\t\t\tops = &as3722_ldo3_extcntrl_ops;\n\t\t\telse\n\t\t\t\tops = &as3722_ldo3_ops;\n\t\t\tdesc->min_uV = 620000;\n\t\t\tdesc->uV_step = 20000;\n\t\t\tdesc->linear_min_sel = 1;\n\t\t\tdesc->enable_time = 500;\n\t\t\tif (reg_config->enable_tracking) {\n\t\t\t\tret = as3722_ldo3_set_tracking_mode(as3722_regs,\n\t\t\t\t\tid, AS3722_LDO3_MODE_PMOS_TRACKING);\n\t\t\t\tif (ret < 0) {\n\t\t\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\t\t\"LDO3 tracking failed: %d\\n\",\n\t\t\t\t\t\tret);\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase AS3722_REGULATOR_ID_LDO6:\n\t\t\tif (reg_config->ext_control)\n\t\t\t\tops = &as3722_ldo6_extcntrl_ops;\n\t\t\telse\n\t\t\t\tops = &as3722_ldo6_ops;\n\t\t\tdesc->enable_time = 500;\n\t\t\tdesc->bypass_reg = AS3722_LDO6_VOLTAGE_REG;\n\t\t\tdesc->bypass_mask = AS3722_LDO_VSEL_MASK;\n\t\t\tdesc->bypass_val_on = AS3722_LDO6_VSEL_BYPASS;\n\t\t\tdesc->bypass_val_off = AS3722_LDO6_VSEL_BYPASS;\n\t\t\tdesc->linear_ranges = as3722_ldo_ranges;\n\t\t\tdesc->n_linear_ranges = ARRAY_SIZE(as3722_ldo_ranges);\n\t\t\tdesc->curr_table = as3722_ldo_current;\n\t\t\tdesc->n_current_limits = ARRAY_SIZE(as3722_ldo_current);\n\t\t\tdesc->csel_reg = as3722_reg_lookup[id].vsel_reg;\n\t\t\tdesc->csel_mask = AS3722_LDO_ILIMIT_MASK;\n\t\t\tbreak;\n\t\tcase AS3722_REGULATOR_ID_SD0:\n\t\tcase AS3722_REGULATOR_ID_SD1:\n\t\tcase AS3722_REGULATOR_ID_SD6:\n\t\t\tif (reg_config->ext_control)\n\t\t\t\tops = &as3722_sd016_extcntrl_ops;\n\t\t\telse\n\t\t\t\tops = &as3722_sd016_ops;\n\t\t\tif (id == AS3722_REGULATOR_ID_SD0 &&\n\t\t\t    as3722_sd0_is_low_voltage(as3722_regs)) {\n\t\t\t\tas3722_regs->desc[id].n_voltages =\n\t\t\t\t\tAS3722_SD0_VSEL_LOW_VOL_MAX + 1;\n\t\t\t\tas3722_regs->desc[id].min_uV = 410000;\n\t\t\t} else {\n\t\t\t\tas3722_regs->desc[id].n_voltages =\n\t\t\t\t\tAS3722_SD0_VSEL_MAX + 1;\n\t\t\t\tas3722_regs->desc[id].min_uV = 610000;\n\t\t\t}\n\t\t\tdesc->uV_step = 10000;\n\t\t\tdesc->linear_min_sel = 1;\n\t\t\tdesc->enable_time = 600;\n\t\t\tdesc->curr_table = as3722_sd016_current;\n\t\t\tdesc->n_current_limits =\n\t\t\t\tARRAY_SIZE(as3722_sd016_current);\n\t\t\tif (id == AS3722_REGULATOR_ID_SD0) {\n\t\t\t\tdesc->csel_reg = AS3722_OVCURRENT_REG;\n\t\t\t\tdesc->csel_mask =\n\t\t\t\t\tAS3722_OVCURRENT_SD0_TRIP_MASK;\n\t\t\t} else if (id == AS3722_REGULATOR_ID_SD1) {\n\t\t\t\tdesc->csel_reg = AS3722_OVCURRENT_REG;\n\t\t\t\tdesc->csel_mask =\n\t\t\t\t\tAS3722_OVCURRENT_SD1_TRIP_MASK;\n\t\t\t} else if (id == AS3722_REGULATOR_ID_SD6) {\n\t\t\t\tdesc->csel_reg = AS3722_OVCURRENT_DEB_REG;\n\t\t\t\tdesc->csel_mask =\n\t\t\t\t\tAS3722_OVCURRENT_SD6_TRIP_MASK;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase AS3722_REGULATOR_ID_SD2:\n\t\tcase AS3722_REGULATOR_ID_SD3:\n\t\tcase AS3722_REGULATOR_ID_SD4:\n\t\tcase AS3722_REGULATOR_ID_SD5:\n\t\t\tif (reg_config->ext_control)\n\t\t\t\tops = &as3722_sd2345_extcntrl_ops;\n\t\t\telse\n\t\t\t\tops = &as3722_sd2345_ops;\n\t\t\tdesc->linear_ranges = as3722_sd2345_ranges;\n\t\t\tdesc->n_linear_ranges =\n\t\t\t\t\tARRAY_SIZE(as3722_sd2345_ranges);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif (reg_config->ext_control)\n\t\t\t\tops = &as3722_ldo_extcntrl_ops;\n\t\t\telse\n\t\t\t\tops = &as3722_ldo_ops;\n\t\t\tdesc->enable_time = 500;\n\t\t\tdesc->linear_ranges = as3722_ldo_ranges;\n\t\t\tdesc->n_linear_ranges = ARRAY_SIZE(as3722_ldo_ranges);\n\t\t\tdesc->curr_table = as3722_ldo_current;\n\t\t\tdesc->n_current_limits = ARRAY_SIZE(as3722_ldo_current);\n\t\t\tdesc->csel_reg = as3722_reg_lookup[id].vsel_reg;\n\t\t\tdesc->csel_mask = AS3722_LDO_ILIMIT_MASK;\n\t\t\tbreak;\n\t\t}\n\t\tdesc->ops = ops;\n\t\tconfig.init_data = reg_config->reg_init;\n\t\tconfig.of_node = as3722_regulator_matches[id].of_node;\n\t\trdev = devm_regulator_register(&pdev->dev, desc, &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tret = PTR_ERR(rdev);\n\t\t\tdev_err(&pdev->dev, \"regulator %d register failed %d\\n\",\n\t\t\t\tid, ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (reg_config->ext_control) {\n\t\t\tret = regulator_enable_regmap(rdev);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\t\"Regulator %d enable failed: %d\\n\",\n\t\t\t\t\tid, ret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\tret = as3722_extreg_init(as3722_regs, id,\n\t\t\t\t\treg_config->ext_control);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\t\"AS3722 ext control failed: %d\", ret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic const struct of_device_id of_as3722_regulator_match[] = {\n\t{ .compatible = \"ams,as3722-regulator\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, of_as3722_regulator_match);\n\nstatic struct platform_driver as3722_regulator_driver = {\n\t.driver = {\n\t\t.name = \"as3722-regulator\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = of_as3722_regulator_match,\n\t},\n\t.probe = as3722_regulator_probe,\n};\n\nmodule_platform_driver(as3722_regulator_driver);\n\nMODULE_ALIAS(\"platform:as3722-regulator\");\nMODULE_DESCRIPTION(\"AS3722 regulator driver\");\nMODULE_AUTHOR(\"Florian Lobmaier <florian.lobmaier@ams.com>\");\nMODULE_AUTHOR(\"Laxman Dewangan <ldewangan@nvidia.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}