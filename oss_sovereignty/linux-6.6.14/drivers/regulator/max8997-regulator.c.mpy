{
  "module_name": "max8997-regulator.c",
  "hash_id": "c66c817d51ec2a955616b2d9ee9247a1a821eb25dd13560d843b6389aa6e63cf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max8997-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n#include <linux/bug.h>\n#include <linux/err.h>\n#include <linux/gpio.h>\n#include <linux/of_gpio.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/mfd/max8997.h>\n#include <linux/mfd/max8997-private.h>\n#include <linux/regulator/of_regulator.h>\n\nstruct max8997_data {\n\tstruct device *dev;\n\tstruct max8997_dev *iodev;\n\tint num_regulators;\n\tint ramp_delay;  \n\n\tbool buck1_gpiodvs;\n\tbool buck2_gpiodvs;\n\tbool buck5_gpiodvs;\n\tu8 buck1_vol[8];\n\tu8 buck2_vol[8];\n\tu8 buck5_vol[8];\n\tint buck125_gpios[3];\n\tint buck125_gpioindex;\n\tbool ignore_gpiodvs_side_effect;\n\n\tu8 saved_states[MAX8997_REG_MAX];\n};\n\nstatic const unsigned int safeoutvolt[] = {\n\t4850000,\n\t4900000,\n\t4950000,\n\t3300000,\n};\n\nstatic inline void max8997_set_gpio(struct max8997_data *max8997)\n{\n\tint set3 = (max8997->buck125_gpioindex) & 0x1;\n\tint set2 = ((max8997->buck125_gpioindex) >> 1) & 0x1;\n\tint set1 = ((max8997->buck125_gpioindex) >> 2) & 0x1;\n\n\tgpio_set_value(max8997->buck125_gpios[0], set1);\n\tgpio_set_value(max8997->buck125_gpios[1], set2);\n\tgpio_set_value(max8997->buck125_gpios[2], set3);\n}\n\nstruct voltage_map_desc {\n\tint min;\n\tint max;\n\tint step;\n};\n\n \nstatic const struct voltage_map_desc ldo_voltage_map_desc = {\n\t.min = 800000,\t.max = 3950000,\t.step = 50000,\n};  \n\nstatic const struct voltage_map_desc buck1245_voltage_map_desc = {\n\t.min = 650000,\t.max = 2225000,\t.step = 25000,\n};  \n\nstatic const struct voltage_map_desc buck37_voltage_map_desc = {\n\t.min = 750000,\t.max = 3900000,\t.step = 50000,\n};  \n\n \nstatic const struct voltage_map_desc charger_current_map_desc = {\n\t.min = 200000,\t.max = 950000,\t.step = 50000,\n};\n\nstatic const struct voltage_map_desc topoff_current_map_desc = {\n\t.min = 50000,\t.max = 200000,\t.step = 10000,\n};\n\nstatic const struct voltage_map_desc *reg_voltage_map[] = {\n\t[MAX8997_LDO1] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO2] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO3] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO4] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO5] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO6] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO7] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO8] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO9] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO10] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO11] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO12] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO13] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO14] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO15] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO16] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO17] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO18] = &ldo_voltage_map_desc,\n\t[MAX8997_LDO21] = &ldo_voltage_map_desc,\n\t[MAX8997_BUCK1] = &buck1245_voltage_map_desc,\n\t[MAX8997_BUCK2] = &buck1245_voltage_map_desc,\n\t[MAX8997_BUCK3] = &buck37_voltage_map_desc,\n\t[MAX8997_BUCK4] = &buck1245_voltage_map_desc,\n\t[MAX8997_BUCK5] = &buck1245_voltage_map_desc,\n\t[MAX8997_BUCK6] = NULL,\n\t[MAX8997_BUCK7] = &buck37_voltage_map_desc,\n\t[MAX8997_EN32KHZ_AP] = NULL,\n\t[MAX8997_EN32KHZ_CP] = NULL,\n\t[MAX8997_ENVICHG] = NULL,\n\t[MAX8997_ESAFEOUT1] = NULL,\n\t[MAX8997_ESAFEOUT2] = NULL,\n\t[MAX8997_CHARGER_CV] = NULL,\n\t[MAX8997_CHARGER] = &charger_current_map_desc,\n\t[MAX8997_CHARGER_TOPOFF] = &topoff_current_map_desc,\n};\n\nstatic int max8997_list_voltage_charger_cv(struct regulator_dev *rdev,\n\t\tunsigned int selector)\n{\n\tint rid = rdev_get_id(rdev);\n\n\tif (rid != MAX8997_CHARGER_CV)\n\t\tgoto err;\n\n\tswitch (selector) {\n\tcase 0x00:\n\t\treturn 4200000;\n\tcase 0x01 ... 0x0E:\n\t\treturn 4000000 + 20000 * (selector - 0x01);\n\tcase 0x0F:\n\t\treturn 4350000;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\nerr:\n\treturn -EINVAL;\n}\n\nstatic int max8997_list_voltage(struct regulator_dev *rdev,\n\t\tunsigned int selector)\n{\n\tconst struct voltage_map_desc *desc;\n\tint rid = rdev_get_id(rdev);\n\tint val;\n\n\tif (rid < 0 || rid >= ARRAY_SIZE(reg_voltage_map))\n\t\treturn -EINVAL;\n\n\tdesc = reg_voltage_map[rid];\n\tif (desc == NULL)\n\t\treturn -EINVAL;\n\n\tval = desc->min + desc->step * selector;\n\tif (val > desc->max)\n\t\treturn -EINVAL;\n\n\treturn val;\n}\n\nstatic int max8997_get_enable_register(struct regulator_dev *rdev,\n\t\tint *reg, int *mask, int *pattern)\n{\n\tint rid = rdev_get_id(rdev);\n\n\tswitch (rid) {\n\tcase MAX8997_LDO1 ... MAX8997_LDO21:\n\t\t*reg = MAX8997_REG_LDO1CTRL + (rid - MAX8997_LDO1);\n\t\t*mask = 0xC0;\n\t\t*pattern = 0xC0;\n\t\tbreak;\n\tcase MAX8997_BUCK1:\n\t\t*reg = MAX8997_REG_BUCK1CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_BUCK2:\n\t\t*reg = MAX8997_REG_BUCK2CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_BUCK3:\n\t\t*reg = MAX8997_REG_BUCK3CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_BUCK4:\n\t\t*reg = MAX8997_REG_BUCK4CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_BUCK5:\n\t\t*reg = MAX8997_REG_BUCK5CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_BUCK6:\n\t\t*reg = MAX8997_REG_BUCK6CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_BUCK7:\n\t\t*reg = MAX8997_REG_BUCK7CTRL;\n\t\t*mask = 0x01;\n\t\t*pattern = 0x01;\n\t\tbreak;\n\tcase MAX8997_EN32KHZ_AP ... MAX8997_EN32KHZ_CP:\n\t\t*reg = MAX8997_REG_MAINCON1;\n\t\t*mask = 0x01 << (rid - MAX8997_EN32KHZ_AP);\n\t\t*pattern = 0x01 << (rid - MAX8997_EN32KHZ_AP);\n\t\tbreak;\n\tcase MAX8997_ENVICHG:\n\t\t*reg = MAX8997_REG_MBCCTRL1;\n\t\t*mask = 0x80;\n\t\t*pattern = 0x80;\n\t\tbreak;\n\tcase MAX8997_ESAFEOUT1 ... MAX8997_ESAFEOUT2:\n\t\t*reg = MAX8997_REG_SAFEOUTCTRL;\n\t\t*mask = 0x40 << (rid - MAX8997_ESAFEOUT1);\n\t\t*pattern = 0x40 << (rid - MAX8997_ESAFEOUT1);\n\t\tbreak;\n\tcase MAX8997_CHARGER:\n\t\t*reg = MAX8997_REG_MBCCTRL2;\n\t\t*mask = 0x40;\n\t\t*pattern = 0x40;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max8997_reg_is_enabled(struct regulator_dev *rdev)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint ret, reg, mask, pattern;\n\tu8 val;\n\n\tret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max8997_read_reg(i2c, reg, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn (val & mask) == pattern;\n}\n\nstatic int max8997_reg_enable(struct regulator_dev *rdev)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint ret, reg, mask, pattern;\n\n\tret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max8997_update_reg(i2c, reg, pattern, mask);\n}\n\nstatic int max8997_reg_disable(struct regulator_dev *rdev)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint ret, reg, mask, pattern;\n\n\tret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max8997_update_reg(i2c, reg, ~pattern, mask);\n}\n\nstatic int max8997_get_voltage_register(struct regulator_dev *rdev,\n\t\tint *_reg, int *_shift, int *_mask)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tint rid = rdev_get_id(rdev);\n\tint reg, shift = 0, mask = 0x3f;\n\n\tswitch (rid) {\n\tcase MAX8997_LDO1 ... MAX8997_LDO21:\n\t\treg = MAX8997_REG_LDO1CTRL + (rid - MAX8997_LDO1);\n\t\tbreak;\n\tcase MAX8997_BUCK1:\n\t\treg = MAX8997_REG_BUCK1DVS1;\n\t\tif (max8997->buck1_gpiodvs)\n\t\t\treg += max8997->buck125_gpioindex;\n\t\tbreak;\n\tcase MAX8997_BUCK2:\n\t\treg = MAX8997_REG_BUCK2DVS1;\n\t\tif (max8997->buck2_gpiodvs)\n\t\t\treg += max8997->buck125_gpioindex;\n\t\tbreak;\n\tcase MAX8997_BUCK3:\n\t\treg = MAX8997_REG_BUCK3DVS;\n\t\tbreak;\n\tcase MAX8997_BUCK4:\n\t\treg = MAX8997_REG_BUCK4DVS;\n\t\tbreak;\n\tcase MAX8997_BUCK5:\n\t\treg = MAX8997_REG_BUCK5DVS1;\n\t\tif (max8997->buck5_gpiodvs)\n\t\t\treg += max8997->buck125_gpioindex;\n\t\tbreak;\n\tcase MAX8997_BUCK7:\n\t\treg = MAX8997_REG_BUCK7DVS;\n\t\tbreak;\n\tcase MAX8997_ESAFEOUT1 ...  MAX8997_ESAFEOUT2:\n\t\treg = MAX8997_REG_SAFEOUTCTRL;\n\t\tshift = (rid == MAX8997_ESAFEOUT2) ? 2 : 0;\n\t\tmask = 0x3;\n\t\tbreak;\n\tcase MAX8997_CHARGER_CV:\n\t\treg = MAX8997_REG_MBCCTRL3;\n\t\tshift = 0;\n\t\tmask = 0xf;\n\t\tbreak;\n\tcase MAX8997_CHARGER:\n\t\treg = MAX8997_REG_MBCCTRL4;\n\t\tshift = 0;\n\t\tmask = 0xf;\n\t\tbreak;\n\tcase MAX8997_CHARGER_TOPOFF:\n\t\treg = MAX8997_REG_MBCCTRL5;\n\t\tshift = 0;\n\t\tmask = 0xf;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t*_reg = reg;\n\t*_shift = shift;\n\t*_mask = mask;\n\n\treturn 0;\n}\n\nstatic int max8997_get_voltage_sel(struct regulator_dev *rdev)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint reg, shift, mask, ret;\n\tu8 val;\n\n\tret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max8997_read_reg(i2c, reg, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tval >>= shift;\n\tval &= mask;\n\n\treturn val;\n}\n\nstatic inline int max8997_get_voltage_proper_val(\n\t\tconst struct voltage_map_desc *desc,\n\t\tint min_vol, int max_vol)\n{\n\tint i;\n\n\tif (desc == NULL)\n\t\treturn -EINVAL;\n\n\tif (max_vol < desc->min || min_vol > desc->max)\n\t\treturn -EINVAL;\n\n\tif (min_vol < desc->min)\n\t\tmin_vol = desc->min;\n\n\ti = DIV_ROUND_UP(min_vol - desc->min, desc->step);\n\n\tif (desc->min + desc->step * i > max_vol)\n\t\treturn -EINVAL;\n\n\treturn i;\n}\n\nstatic int max8997_set_voltage_charger_cv(struct regulator_dev *rdev,\n\t\tint min_uV, int max_uV, unsigned *selector)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint rid = rdev_get_id(rdev);\n\tint lb, ub;\n\tint reg, shift = 0, mask, ret = 0;\n\tu8 val = 0x0;\n\n\tif (rid != MAX8997_CHARGER_CV)\n\t\treturn -EINVAL;\n\n\tret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tif (max_uV < 4000000 || min_uV > 4350000)\n\t\treturn -EINVAL;\n\n\tif (min_uV <= 4000000)\n\t\tval = 0x1;\n\telse if (min_uV <= 4200000 && max_uV >= 4200000)\n\t\tval = 0x0;\n\telse {\n\t\tlb = (min_uV - 4000001) / 20000 + 2;\n\t\tub = (max_uV - 4000000) / 20000 + 1;\n\n\t\tif (lb > ub)\n\t\t\treturn -EINVAL;\n\n\t\tif (lb < 0xf)\n\t\t\tval = lb;\n\t\telse {\n\t\t\tif (ub >= 0xf)\n\t\t\t\tval = 0xf;\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\t*selector = val;\n\n\tret = max8997_update_reg(i2c, reg, val << shift, mask);\n\n\treturn ret;\n}\n\n \nstatic int max8997_set_voltage_ldobuck(struct regulator_dev *rdev,\n\t\tint min_uV, int max_uV, unsigned *selector)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tconst struct voltage_map_desc *desc;\n\tint rid = rdev_get_id(rdev);\n\tint i, reg, shift, mask, ret;\n\n\tswitch (rid) {\n\tcase MAX8997_LDO1 ... MAX8997_LDO21:\n\t\tbreak;\n\tcase MAX8997_BUCK1 ... MAX8997_BUCK5:\n\t\tbreak;\n\tcase MAX8997_BUCK6:\n\t\treturn -EINVAL;\n\tcase MAX8997_BUCK7:\n\t\tbreak;\n\tcase MAX8997_CHARGER:\n\t\tbreak;\n\tcase MAX8997_CHARGER_TOPOFF:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tdesc = reg_voltage_map[rid];\n\n\ti = max8997_get_voltage_proper_val(desc, min_uV, max_uV);\n\tif (i < 0)\n\t\treturn i;\n\n\tret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max8997_update_reg(i2c, reg, i << shift, mask << shift);\n\t*selector = i;\n\n\treturn ret;\n}\n\nstatic int max8997_set_voltage_buck_time_sel(struct regulator_dev *rdev,\n\t\t\t\t\t\tunsigned int old_selector,\n\t\t\t\t\t\tunsigned int new_selector)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tint rid = rdev_get_id(rdev);\n\tconst struct voltage_map_desc *desc = reg_voltage_map[rid];\n\n\t \n\tif (old_selector >= new_selector)\n\t\treturn 0;\n\n\t \n\tswitch (rid) {\n\tcase MAX8997_BUCK1:\n\t\tif (max8997->buck1_gpiodvs)\n\t\t\treturn 0;\n\t\tbreak;\n\tcase MAX8997_BUCK2:\n\t\tif (max8997->buck2_gpiodvs)\n\t\t\treturn 0;\n\t\tbreak;\n\tcase MAX8997_BUCK5:\n\t\tif (max8997->buck5_gpiodvs)\n\t\t\treturn 0;\n\t\tbreak;\n\t}\n\n\tswitch (rid) {\n\tcase MAX8997_BUCK1:\n\tcase MAX8997_BUCK2:\n\tcase MAX8997_BUCK4:\n\tcase MAX8997_BUCK5:\n\t\treturn DIV_ROUND_UP(desc->step * (new_selector - old_selector),\n\t\t\t\t    max8997->ramp_delay * 1000);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int max8997_assess_side_effect(struct regulator_dev *rdev,\n\t\tu8 new_val, int *best)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tint rid = rdev_get_id(rdev);\n\tu8 *buckx_val[3];\n\tbool buckx_gpiodvs[3];\n\tint side_effect[8];\n\tint min_side_effect = INT_MAX;\n\tint i;\n\n\t*best = -1;\n\n\tswitch (rid) {\n\tcase MAX8997_BUCK1:\n\t\trid = 0;\n\t\tbreak;\n\tcase MAX8997_BUCK2:\n\t\trid = 1;\n\t\tbreak;\n\tcase MAX8997_BUCK5:\n\t\trid = 2;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tbuckx_val[0] = max8997->buck1_vol;\n\tbuckx_val[1] = max8997->buck2_vol;\n\tbuckx_val[2] = max8997->buck5_vol;\n\tbuckx_gpiodvs[0] = max8997->buck1_gpiodvs;\n\tbuckx_gpiodvs[1] = max8997->buck2_gpiodvs;\n\tbuckx_gpiodvs[2] = max8997->buck5_gpiodvs;\n\n\tfor (i = 0; i < 8; i++) {\n\t\tint others;\n\n\t\tif (new_val != (buckx_val[rid])[i]) {\n\t\t\tside_effect[i] = -1;\n\t\t\tcontinue;\n\t\t}\n\n\t\tside_effect[i] = 0;\n\t\tfor (others = 0; others < 3; others++) {\n\t\t\tint diff;\n\n\t\t\tif (others == rid)\n\t\t\t\tcontinue;\n\t\t\tif (buckx_gpiodvs[others] == false)\n\t\t\t\tcontinue;  \n\t\t\tdiff = (buckx_val[others])[i] -\n\t\t\t\t(buckx_val[others])[max8997->buck125_gpioindex];\n\t\t\tif (diff > 0)\n\t\t\t\tside_effect[i] += diff;\n\t\t\telse if (diff < 0)\n\t\t\t\tside_effect[i] -= diff;\n\t\t}\n\t\tif (side_effect[i] == 0) {\n\t\t\t*best = i;\n\t\t\treturn 0;  \n\t\t}\n\t\tif (side_effect[i] < min_side_effect) {\n\t\t\tmin_side_effect = side_effect[i];\n\t\t\t*best = i;\n\t\t}\n\t}\n\n\tif (*best == -1)\n\t\treturn -EINVAL;\n\n\treturn side_effect[*best];\n}\n\n \nstatic int max8997_set_voltage_buck(struct regulator_dev *rdev,\n\t\tint min_uV, int max_uV, unsigned *selector)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tint rid = rdev_get_id(rdev);\n\tconst struct voltage_map_desc *desc;\n\tint new_val, new_idx, damage, tmp_val, tmp_idx, tmp_dmg;\n\tbool gpio_dvs_mode = false;\n\n\tif (rid < MAX8997_BUCK1 || rid > MAX8997_BUCK7)\n\t\treturn -EINVAL;\n\n\tswitch (rid) {\n\tcase MAX8997_BUCK1:\n\t\tif (max8997->buck1_gpiodvs)\n\t\t\tgpio_dvs_mode = true;\n\t\tbreak;\n\tcase MAX8997_BUCK2:\n\t\tif (max8997->buck2_gpiodvs)\n\t\t\tgpio_dvs_mode = true;\n\t\tbreak;\n\tcase MAX8997_BUCK5:\n\t\tif (max8997->buck5_gpiodvs)\n\t\t\tgpio_dvs_mode = true;\n\t\tbreak;\n\t}\n\n\tif (!gpio_dvs_mode)\n\t\treturn max8997_set_voltage_ldobuck(rdev, min_uV, max_uV,\n\t\t\t\t\t\tselector);\n\n\tdesc = reg_voltage_map[rid];\n\tnew_val = max8997_get_voltage_proper_val(desc, min_uV, max_uV);\n\tif (new_val < 0)\n\t\treturn new_val;\n\n\ttmp_dmg = INT_MAX;\n\ttmp_idx = -1;\n\ttmp_val = -1;\n\tdo {\n\t\tdamage = max8997_assess_side_effect(rdev, new_val, &new_idx);\n\t\tif (damage == 0)\n\t\t\tgoto out;\n\n\t\tif (tmp_dmg > damage) {\n\t\t\ttmp_idx = new_idx;\n\t\t\ttmp_val = new_val;\n\t\t\ttmp_dmg = damage;\n\t\t}\n\n\t\tnew_val++;\n\t} while (desc->min + desc->step * new_val <= desc->max);\n\n\tnew_idx = tmp_idx;\n\tnew_val = tmp_val;\n\n\tif (max8997->ignore_gpiodvs_side_effect == false)\n\t\treturn -EINVAL;\n\n\tdev_warn(&rdev->dev,\n\t\t\"MAX8997 GPIO-DVS Side Effect Warning: GPIO SET:  %d -> %d\\n\",\n\t\tmax8997->buck125_gpioindex, tmp_idx);\n\nout:\n\tif (new_idx < 0 || new_val < 0)\n\t\treturn -EINVAL;\n\n\tmax8997->buck125_gpioindex = new_idx;\n\tmax8997_set_gpio(max8997);\n\t*selector = new_val;\n\n\treturn 0;\n}\n\n \nstatic int max8997_set_voltage_safeout_sel(struct regulator_dev *rdev,\n\t\t\t\t\t   unsigned selector)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint rid = rdev_get_id(rdev);\n\tint reg, shift = 0, mask, ret;\n\n\tif (rid != MAX8997_ESAFEOUT1 && rid != MAX8997_ESAFEOUT2)\n\t\treturn -EINVAL;\n\n\tret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max8997_update_reg(i2c, reg, selector << shift, mask << shift);\n}\n\nstatic int max8997_reg_disable_suspend(struct regulator_dev *rdev)\n{\n\tstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\n\tstruct i2c_client *i2c = max8997->iodev->i2c;\n\tint ret, reg, mask, pattern;\n\tint rid = rdev_get_id(rdev);\n\n\tret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\n\tif (ret)\n\t\treturn ret;\n\n\tmax8997_read_reg(i2c, reg, &max8997->saved_states[rid]);\n\n\tif (rid == MAX8997_LDO1 ||\n\t\t\trid == MAX8997_LDO10 ||\n\t\t\trid == MAX8997_LDO21) {\n\t\tdev_dbg(&rdev->dev, \"Conditional Power-Off for %s\\n\",\n\t\t\t\trdev->desc->name);\n\t\treturn max8997_update_reg(i2c, reg, 0x40, mask);\n\t}\n\n\tdev_dbg(&rdev->dev, \"Full Power-Off for %s (%xh -> %xh)\\n\",\n\t\t\trdev->desc->name, max8997->saved_states[rid] & mask,\n\t\t\t(~pattern) & mask);\n\treturn max8997_update_reg(i2c, reg, ~pattern, mask);\n}\n\nstatic const struct regulator_ops max8997_ldo_ops = {\n\t.list_voltage\t\t= max8997_list_voltage,\n\t.is_enabled\t\t= max8997_reg_is_enabled,\n\t.enable\t\t\t= max8997_reg_enable,\n\t.disable\t\t= max8997_reg_disable,\n\t.get_voltage_sel\t= max8997_get_voltage_sel,\n\t.set_voltage\t\t= max8997_set_voltage_ldobuck,\n\t.set_suspend_disable\t= max8997_reg_disable_suspend,\n};\n\nstatic const struct regulator_ops max8997_buck_ops = {\n\t.list_voltage\t\t= max8997_list_voltage,\n\t.is_enabled\t\t= max8997_reg_is_enabled,\n\t.enable\t\t\t= max8997_reg_enable,\n\t.disable\t\t= max8997_reg_disable,\n\t.get_voltage_sel\t= max8997_get_voltage_sel,\n\t.set_voltage\t\t= max8997_set_voltage_buck,\n\t.set_voltage_time_sel\t= max8997_set_voltage_buck_time_sel,\n\t.set_suspend_disable\t= max8997_reg_disable_suspend,\n};\n\nstatic const struct regulator_ops max8997_fixedvolt_ops = {\n\t.list_voltage\t\t= max8997_list_voltage,\n\t.is_enabled\t\t= max8997_reg_is_enabled,\n\t.enable\t\t\t= max8997_reg_enable,\n\t.disable\t\t= max8997_reg_disable,\n\t.set_suspend_disable\t= max8997_reg_disable_suspend,\n};\n\nstatic const struct regulator_ops max8997_safeout_ops = {\n\t.list_voltage\t\t= regulator_list_voltage_table,\n\t.is_enabled\t\t= max8997_reg_is_enabled,\n\t.enable\t\t\t= max8997_reg_enable,\n\t.disable\t\t= max8997_reg_disable,\n\t.get_voltage_sel\t= max8997_get_voltage_sel,\n\t.set_voltage_sel\t= max8997_set_voltage_safeout_sel,\n\t.set_suspend_disable\t= max8997_reg_disable_suspend,\n};\n\nstatic const struct regulator_ops max8997_fixedstate_ops = {\n\t.list_voltage\t\t= max8997_list_voltage_charger_cv,\n\t.get_voltage_sel\t= max8997_get_voltage_sel,\n\t.set_voltage\t\t= max8997_set_voltage_charger_cv,\n};\n\nstatic int max8997_set_current_limit(struct regulator_dev *rdev,\n\t\t\t\t     int min_uA, int max_uA)\n{\n\tunsigned dummy;\n\tint rid = rdev_get_id(rdev);\n\n\tif (rid != MAX8997_CHARGER && rid != MAX8997_CHARGER_TOPOFF)\n\t\treturn -EINVAL;\n\n\t \n\treturn max8997_set_voltage_ldobuck(rdev, min_uA, max_uA, &dummy);\n}\n\nstatic int max8997_get_current_limit(struct regulator_dev *rdev)\n{\n\tint sel, rid = rdev_get_id(rdev);\n\n\tif (rid != MAX8997_CHARGER && rid != MAX8997_CHARGER_TOPOFF)\n\t\treturn -EINVAL;\n\n\tsel = max8997_get_voltage_sel(rdev);\n\tif (sel < 0)\n\t\treturn sel;\n\n\t \n\treturn max8997_list_voltage(rdev, sel);\n}\n\nstatic const struct regulator_ops max8997_charger_ops = {\n\t.is_enabled\t\t= max8997_reg_is_enabled,\n\t.enable\t\t\t= max8997_reg_enable,\n\t.disable\t\t= max8997_reg_disable,\n\t.get_current_limit\t= max8997_get_current_limit,\n\t.set_current_limit\t= max8997_set_current_limit,\n};\n\nstatic const struct regulator_ops max8997_charger_fixedstate_ops = {\n\t.get_current_limit\t= max8997_get_current_limit,\n\t.set_current_limit\t= max8997_set_current_limit,\n};\n\n#define MAX8997_VOLTAGE_REGULATOR(_name, _ops) {\\\n\t.name\t\t= #_name,\t\t\\\n\t.id\t\t= MAX8997_##_name,\t\\\n\t.ops\t\t= &_ops,\t\t\\\n\t.type\t\t= REGULATOR_VOLTAGE,\t\\\n\t.owner\t\t= THIS_MODULE,\t\t\\\n}\n\n#define MAX8997_CURRENT_REGULATOR(_name, _ops) {\\\n\t.name\t\t= #_name,\t\t\\\n\t.id\t\t= MAX8997_##_name,\t\\\n\t.ops\t\t= &_ops,\t\t\\\n\t.type\t\t= REGULATOR_CURRENT,\t\\\n\t.owner\t\t= THIS_MODULE,\t\t\\\n}\n\nstatic struct regulator_desc regulators[] = {\n\tMAX8997_VOLTAGE_REGULATOR(LDO1, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO2, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO3, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO4, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO5, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO6, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO7, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO8, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO9, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO10, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO11, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO12, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO13, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO14, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO15, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO16, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO17, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO18, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(LDO21, max8997_ldo_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK1, max8997_buck_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK2, max8997_buck_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK3, max8997_buck_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK4, max8997_buck_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK5, max8997_buck_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK6, max8997_fixedvolt_ops),\n\tMAX8997_VOLTAGE_REGULATOR(BUCK7, max8997_buck_ops),\n\tMAX8997_VOLTAGE_REGULATOR(EN32KHZ_AP, max8997_fixedvolt_ops),\n\tMAX8997_VOLTAGE_REGULATOR(EN32KHZ_CP, max8997_fixedvolt_ops),\n\tMAX8997_VOLTAGE_REGULATOR(ENVICHG, max8997_fixedvolt_ops),\n\tMAX8997_VOLTAGE_REGULATOR(ESAFEOUT1, max8997_safeout_ops),\n\tMAX8997_VOLTAGE_REGULATOR(ESAFEOUT2, max8997_safeout_ops),\n\tMAX8997_VOLTAGE_REGULATOR(CHARGER_CV, max8997_fixedstate_ops),\n\tMAX8997_CURRENT_REGULATOR(CHARGER, max8997_charger_ops),\n\tMAX8997_CURRENT_REGULATOR(CHARGER_TOPOFF,\n\t\t\t\t  max8997_charger_fixedstate_ops),\n};\n\n#ifdef CONFIG_OF\nstatic int max8997_pmic_dt_parse_dvs_gpio(struct platform_device *pdev,\n\t\t\tstruct max8997_platform_data *pdata,\n\t\t\tstruct device_node *pmic_np)\n{\n\tint i, gpio;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tgpio = of_get_named_gpio(pmic_np,\n\t\t\t\t\t\"max8997,pmic-buck125-dvs-gpios\", i);\n\t\tif (!gpio_is_valid(gpio)) {\n\t\t\tdev_err(&pdev->dev, \"invalid gpio[%d]: %d\\n\", i, gpio);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tpdata->buck125_gpios[i] = gpio;\n\t}\n\treturn 0;\n}\n\nstatic int max8997_pmic_dt_parse_pdata(struct platform_device *pdev,\n\t\t\t\t\tstruct max8997_platform_data *pdata)\n{\n\tstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\n\tstruct device_node *pmic_np, *regulators_np, *reg_np;\n\tstruct max8997_regulator_data *rdata;\n\tunsigned int i, dvs_voltage_nr = 1, ret;\n\n\tpmic_np = iodev->dev->of_node;\n\tif (!pmic_np) {\n\t\tdev_err(&pdev->dev, \"could not find pmic sub-node\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tregulators_np = of_get_child_by_name(pmic_np, \"regulators\");\n\tif (!regulators_np) {\n\t\tdev_err(&pdev->dev, \"could not find regulators sub-node\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tpdata->num_regulators = of_get_child_count(regulators_np);\n\n\trdata = devm_kcalloc(&pdev->dev,\n\t\t\t     pdata->num_regulators, sizeof(*rdata),\n\t\t\t     GFP_KERNEL);\n\tif (!rdata) {\n\t\tof_node_put(regulators_np);\n\t\treturn -ENOMEM;\n\t}\n\n\tpdata->regulators = rdata;\n\tfor_each_child_of_node(regulators_np, reg_np) {\n\t\tfor (i = 0; i < ARRAY_SIZE(regulators); i++)\n\t\t\tif (of_node_name_eq(reg_np, regulators[i].name))\n\t\t\t\tbreak;\n\n\t\tif (i == ARRAY_SIZE(regulators)) {\n\t\t\tdev_warn(&pdev->dev, \"don't know how to configure regulator %pOFn\\n\",\n\t\t\t\t reg_np);\n\t\t\tcontinue;\n\t\t}\n\n\t\trdata->id = i;\n\t\trdata->initdata = of_get_regulator_init_data(&pdev->dev,\n\t\t\t\t\t\t\t     reg_np,\n\t\t\t\t\t\t\t     &regulators[i]);\n\t\trdata->reg_node = reg_np;\n\t\trdata++;\n\t}\n\tof_node_put(regulators_np);\n\n\tpdata->buck1_gpiodvs = of_property_read_bool(pmic_np, \"max8997,pmic-buck1-uses-gpio-dvs\");\n\tpdata->buck2_gpiodvs = of_property_read_bool(pmic_np, \"max8997,pmic-buck2-uses-gpio-dvs\");\n\tpdata->buck5_gpiodvs = of_property_read_bool(pmic_np, \"max8997,pmic-buck5-uses-gpio-dvs\");\n\n\tif (pdata->buck1_gpiodvs || pdata->buck2_gpiodvs ||\n\t\t\t\t\t\tpdata->buck5_gpiodvs) {\n\t\tret = max8997_pmic_dt_parse_dvs_gpio(pdev, pdata, pmic_np);\n\t\tif (ret)\n\t\t\treturn -EINVAL;\n\n\t\tif (of_property_read_u32(pmic_np,\n\t\t\t\t\"max8997,pmic-buck125-default-dvs-idx\",\n\t\t\t\t&pdata->buck125_default_idx)) {\n\t\t\tpdata->buck125_default_idx = 0;\n\t\t} else {\n\t\t\tif (pdata->buck125_default_idx >= 8) {\n\t\t\t\tpdata->buck125_default_idx = 0;\n\t\t\t\tdev_info(&pdev->dev, \"invalid value for default dvs index, using 0 instead\\n\");\n\t\t\t}\n\t\t}\n\n\t\tif (of_get_property(pmic_np,\n\t\t\t\"max8997,pmic-ignore-gpiodvs-side-effect\", NULL))\n\t\t\tpdata->ignore_gpiodvs_side_effect = true;\n\n\t\tdvs_voltage_nr = 8;\n\t}\n\n\tif (of_property_read_u32_array(pmic_np,\n\t\t\t\t\"max8997,pmic-buck1-dvs-voltage\",\n\t\t\t\tpdata->buck1_voltage, dvs_voltage_nr)) {\n\t\tdev_err(&pdev->dev, \"buck1 voltages not specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (of_property_read_u32_array(pmic_np,\n\t\t\t\t\"max8997,pmic-buck2-dvs-voltage\",\n\t\t\t\tpdata->buck2_voltage, dvs_voltage_nr)) {\n\t\tdev_err(&pdev->dev, \"buck2 voltages not specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (of_property_read_u32_array(pmic_np,\n\t\t\t\t\"max8997,pmic-buck5-dvs-voltage\",\n\t\t\t\tpdata->buck5_voltage, dvs_voltage_nr)) {\n\t\tdev_err(&pdev->dev, \"buck5 voltages not specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n#else\nstatic int max8997_pmic_dt_parse_pdata(struct platform_device *pdev,\n\t\t\t\t\tstruct max8997_platform_data *pdata)\n{\n\treturn 0;\n}\n#endif  \n\nstatic int max8997_pmic_probe(struct platform_device *pdev)\n{\n\tstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\n\tstruct max8997_platform_data *pdata = iodev->pdata;\n\tstruct regulator_config config = { };\n\tstruct regulator_dev *rdev;\n\tstruct max8997_data *max8997;\n\tstruct i2c_client *i2c;\n\tint i, ret, nr_dvs;\n\tu8 max_buck1 = 0, max_buck2 = 0, max_buck5 = 0;\n\n\tif (!pdata) {\n\t\tdev_err(&pdev->dev, \"No platform init data supplied.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (iodev->dev->of_node) {\n\t\tret = max8997_pmic_dt_parse_pdata(pdev, pdata);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tmax8997 = devm_kzalloc(&pdev->dev, sizeof(struct max8997_data),\n\t\t\t       GFP_KERNEL);\n\tif (!max8997)\n\t\treturn -ENOMEM;\n\n\tmax8997->dev = &pdev->dev;\n\tmax8997->iodev = iodev;\n\tmax8997->num_regulators = pdata->num_regulators;\n\tplatform_set_drvdata(pdev, max8997);\n\ti2c = max8997->iodev->i2c;\n\n\tmax8997->buck125_gpioindex = pdata->buck125_default_idx;\n\tmax8997->buck1_gpiodvs = pdata->buck1_gpiodvs;\n\tmax8997->buck2_gpiodvs = pdata->buck2_gpiodvs;\n\tmax8997->buck5_gpiodvs = pdata->buck5_gpiodvs;\n\tmemcpy(max8997->buck125_gpios, pdata->buck125_gpios, sizeof(int) * 3);\n\tmax8997->ignore_gpiodvs_side_effect = pdata->ignore_gpiodvs_side_effect;\n\n\tnr_dvs = (pdata->buck1_gpiodvs || pdata->buck2_gpiodvs ||\n\t\t\tpdata->buck5_gpiodvs) ? 8 : 1;\n\n\tfor (i = 0; i < nr_dvs; i++) {\n\t\tmax8997->buck1_vol[i] = ret =\n\t\t\tmax8997_get_voltage_proper_val(\n\t\t\t\t\t&buck1245_voltage_map_desc,\n\t\t\t\t\tpdata->buck1_voltage[i],\n\t\t\t\t\tpdata->buck1_voltage[i] +\n\t\t\t\t\tbuck1245_voltage_map_desc.step);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tmax8997->buck2_vol[i] = ret =\n\t\t\tmax8997_get_voltage_proper_val(\n\t\t\t\t\t&buck1245_voltage_map_desc,\n\t\t\t\t\tpdata->buck2_voltage[i],\n\t\t\t\t\tpdata->buck2_voltage[i] +\n\t\t\t\t\tbuck1245_voltage_map_desc.step);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tmax8997->buck5_vol[i] = ret =\n\t\t\tmax8997_get_voltage_proper_val(\n\t\t\t\t\t&buck1245_voltage_map_desc,\n\t\t\t\t\tpdata->buck5_voltage[i],\n\t\t\t\t\tpdata->buck5_voltage[i] +\n\t\t\t\t\tbuck1245_voltage_map_desc.step);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (max_buck1 < max8997->buck1_vol[i])\n\t\t\tmax_buck1 = max8997->buck1_vol[i];\n\t\tif (max_buck2 < max8997->buck2_vol[i])\n\t\t\tmax_buck2 = max8997->buck2_vol[i];\n\t\tif (max_buck5 < max8997->buck5_vol[i])\n\t\t\tmax_buck5 = max8997->buck5_vol[i];\n\t}\n\n\t \n\tfor (i = 0; i < 8; i++) {\n\t\tmax8997_update_reg(i2c, MAX8997_REG_BUCK1DVS1 + i,\n\t\t\t\tmax_buck1, 0x3f);\n\t\tmax8997_update_reg(i2c, MAX8997_REG_BUCK2DVS1 + i,\n\t\t\t\tmax_buck2, 0x3f);\n\t\tmax8997_update_reg(i2c, MAX8997_REG_BUCK5DVS1 + i,\n\t\t\t\tmax_buck5, 0x3f);\n\t}\n\n\t \n\tfor (i = 0; i < nr_dvs; i++) {\n\t\tmax8997_update_reg(i2c, MAX8997_REG_BUCK1DVS1 + i,\n\t\t\t\tmax8997->buck1_vol[i],\n\t\t\t\t0x3f);\n\t\tmax8997_update_reg(i2c, MAX8997_REG_BUCK2DVS1 + i,\n\t\t\t\tmax8997->buck2_vol[i],\n\t\t\t\t0x3f);\n\t\tmax8997_update_reg(i2c, MAX8997_REG_BUCK5DVS1 + i,\n\t\t\t\tmax8997->buck5_vol[i],\n\t\t\t\t0x3f);\n\t}\n\n\t \n\tif (pdata->buck1_gpiodvs || pdata->buck2_gpiodvs ||\n\t\t\tpdata->buck5_gpiodvs) {\n\n\t\tif (!gpio_is_valid(pdata->buck125_gpios[0]) ||\n\t\t\t\t!gpio_is_valid(pdata->buck125_gpios[1]) ||\n\t\t\t\t!gpio_is_valid(pdata->buck125_gpios[2])) {\n\t\t\tdev_err(&pdev->dev, \"GPIO NOT VALID\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tret = devm_gpio_request(&pdev->dev, pdata->buck125_gpios[0],\n\t\t\t\t\t\"MAX8997 SET1\");\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = devm_gpio_request(&pdev->dev, pdata->buck125_gpios[1],\n\t\t\t\t\t\"MAX8997 SET2\");\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = devm_gpio_request(&pdev->dev, pdata->buck125_gpios[2],\n\t\t\t\t\"MAX8997 SET3\");\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tgpio_direction_output(pdata->buck125_gpios[0],\n\t\t\t\t(max8997->buck125_gpioindex >> 2)\n\t\t\t\t& 0x1);  \n\t\tgpio_direction_output(pdata->buck125_gpios[1],\n\t\t\t\t(max8997->buck125_gpioindex >> 1)\n\t\t\t\t& 0x1);  \n\t\tgpio_direction_output(pdata->buck125_gpios[2],\n\t\t\t\t(max8997->buck125_gpioindex >> 0)\n\t\t\t\t& 0x1);  \n\t}\n\n\t \n\tmax8997_update_reg(i2c, MAX8997_REG_BUCK1CTRL, (pdata->buck1_gpiodvs) ?\n\t\t\t(1 << 1) : (0 << 1), 1 << 1);\n\tmax8997_update_reg(i2c, MAX8997_REG_BUCK2CTRL, (pdata->buck2_gpiodvs) ?\n\t\t\t(1 << 1) : (0 << 1), 1 << 1);\n\tmax8997_update_reg(i2c, MAX8997_REG_BUCK5CTRL, (pdata->buck5_gpiodvs) ?\n\t\t\t(1 << 1) : (0 << 1), 1 << 1);\n\n\t \n\tmax8997->ramp_delay = 10;  \n\tmax8997_write_reg(i2c, MAX8997_REG_BUCKRAMP, (0xf << 4) | 0x9);\n\n\tfor (i = 0; i < pdata->num_regulators; i++) {\n\t\tconst struct voltage_map_desc *desc;\n\t\tint id = pdata->regulators[i].id;\n\n\t\tdesc = reg_voltage_map[id];\n\t\tif (desc) {\n\t\t\tregulators[id].n_voltages =\n\t\t\t\t(desc->max - desc->min) / desc->step + 1;\n\t\t} else if (id == MAX8997_ESAFEOUT1 || id == MAX8997_ESAFEOUT2) {\n\t\t\tregulators[id].volt_table = safeoutvolt;\n\t\t\tregulators[id].n_voltages = ARRAY_SIZE(safeoutvolt);\n\t\t} else if (id == MAX8997_CHARGER_CV) {\n\t\t\tregulators[id].n_voltages = 16;\n\t\t}\n\n\t\tconfig.dev = max8997->dev;\n\t\tconfig.init_data = pdata->regulators[i].initdata;\n\t\tconfig.driver_data = max8997;\n\t\tconfig.of_node = pdata->regulators[i].reg_node;\n\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[id],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(max8997->dev, \"regulator init failed for %d\\n\",\n\t\t\t\t\tid);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id max8997_pmic_id[] = {\n\t{ \"max8997-pmic\", 0},\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, max8997_pmic_id);\n\nstatic struct platform_driver max8997_pmic_driver = {\n\t.driver = {\n\t\t.name = \"max8997-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = max8997_pmic_probe,\n\t.id_table = max8997_pmic_id,\n};\n\nstatic int __init max8997_pmic_init(void)\n{\n\treturn platform_driver_register(&max8997_pmic_driver);\n}\nsubsys_initcall(max8997_pmic_init);\n\nstatic void __exit max8997_pmic_cleanup(void)\n{\n\tplatform_driver_unregister(&max8997_pmic_driver);\n}\nmodule_exit(max8997_pmic_cleanup);\n\nMODULE_DESCRIPTION(\"MAXIM 8997/8966 Regulator Driver\");\nMODULE_AUTHOR(\"MyungJoo Ham <myungjoo.ham@samsung.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}