{
  "module_name": "max20411-regulator.c",
  "hash_id": "48de4cb9e9152314ef78580de812209dce71341240458dbd46155bd624ebf025",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max20411-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/gpio/consumer.h>\n#include <linux/i2c.h>\n#include <linux/module.h>\n#include <linux/of_platform.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n\n#define MAX20411_UV_STEP\t\t6250\n#define MAX20411_BASE_UV\t\t243750\n#define MAX20411_MIN_SEL\t\t41  \n#define MAX20411_MAX_SEL\t\t165  \n#define MAX20411_VID_OFFSET\t\t0x7\n#define MAX20411_VID_MASK\t\t0xff\n#define MAX20411_SLEW_OFFSET\t\t0x6\n#define MAX20411_SLEW_DVS_MASK\t\t0xc\n#define MAX20411_SLEW_SR_MASK\t\t0x3\n\nstruct max20411 {\n\tstruct device *dev;\n\tstruct device_node *of_node;\n\tstruct regulator_desc desc;\n\tstruct regulator_dev *rdev;\n\tstruct regmap *regmap;\n};\n\nstatic const unsigned int max20411_slew_rates[] = { 13100, 6600, 3300, 1600 };\n\nstatic int max20411_enable_time(struct regulator_dev *rdev)\n{\n\tint voltage, rate, ret;\n\tunsigned int val;\n\n\t \n\tret = regmap_read(rdev->regmap, rdev->desc->vsel_reg, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tval &= rdev->desc->vsel_mask;\n\tvoltage = regulator_list_voltage_linear(rdev, val);\n\n\t \n\tret = regmap_read(rdev->regmap, MAX20411_SLEW_OFFSET, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tval = FIELD_GET(MAX20411_SLEW_SR_MASK, val);\n\trate = max20411_slew_rates[val];\n\n\treturn DIV_ROUND_UP(voltage, rate);\n}\n\nstatic const struct regmap_config max20411_regmap_config = {\n\t.reg_bits\t\t= 8,\n\t.val_bits\t\t= 8,\n\t.max_register\t\t= 0xe,\n};\n\nstatic const struct regulator_ops max20411_ops = {\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.enable_time\t\t= max20411_enable_time,\n};\n\nstatic const struct regulator_desc max20411_desc = {\n\t.ops = &max20411_ops,\n\t.owner = THIS_MODULE,\n\t.type = REGULATOR_VOLTAGE,\n\t.supply_name = \"vin\",\n\t.name = \"max20411\",\n\n\t \n\t.min_uV = MAX20411_BASE_UV,\n\t.uV_step = MAX20411_UV_STEP,\n\t.linear_min_sel = MAX20411_MIN_SEL,\n\t.n_voltages = MAX20411_MAX_SEL + 1,\n\n\t.vsel_reg = MAX20411_VID_OFFSET,\n\t.vsel_mask = MAX20411_VID_MASK,\n\n\t.ramp_reg = MAX20411_SLEW_OFFSET,\n\t.ramp_mask = MAX20411_SLEW_DVS_MASK,\n\t.ramp_delay_table = max20411_slew_rates,\n\t.n_ramp_values = ARRAY_SIZE(max20411_slew_rates),\n};\n\nstatic int max20411_probe(struct i2c_client *client)\n{\n\tstruct regulator_init_data *init_data;\n\tstruct device *dev = &client->dev;\n\tstruct regulator_config cfg = {};\n\tstruct max20411 *max20411;\n\n\tmax20411 = devm_kzalloc(dev, sizeof(*max20411), GFP_KERNEL);\n\tif (!max20411)\n\t\treturn -ENOMEM;\n\n\tmax20411->regmap = devm_regmap_init_i2c(client, &max20411_regmap_config);\n\tif (IS_ERR(max20411->regmap)) {\n\t\tdev_err(dev, \"Failed to allocate regmap!\\n\");\n\t\treturn PTR_ERR(max20411->regmap);\n\t}\n\n\tmax20411->dev = dev;\n\tmax20411->of_node = dev->of_node;\n\n\tmax20411->desc = max20411_desc;\n\tinit_data = of_get_regulator_init_data(max20411->dev, max20411->of_node, &max20411->desc);\n\tif (!init_data)\n\t\treturn -ENODATA;\n\n\tcfg.dev = max20411->dev;\n\tcfg.init_data = init_data;\n\tcfg.of_node = max20411->of_node;\n\tcfg.driver_data = max20411;\n\n\tcfg.ena_gpiod = gpiod_get(max20411->dev, \"enable\", GPIOD_ASIS);\n\tif (IS_ERR(cfg.ena_gpiod))\n\t\treturn dev_err_probe(dev, PTR_ERR(cfg.ena_gpiod),\n\t\t\t\t     \"unable to acquire enable gpio\\n\");\n\n\tmax20411->rdev = devm_regulator_register(max20411->dev, &max20411->desc, &cfg);\n\tif (IS_ERR(max20411->rdev))\n\t\tdev_err(max20411->dev, \"Failed to register regulator\\n\");\n\n\treturn PTR_ERR_OR_ZERO(max20411->rdev);\n}\n\nstatic const struct of_device_id of_max20411_match_tbl[] = {\n\t{ .compatible = \"maxim,max20411\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, of_max20411_match_tbl);\n\nstatic const struct i2c_device_id max20411_id[] = {\n\t{ \"max20411\", 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(i2c, max20411_id);\n\nstatic struct i2c_driver max20411_i2c_driver = {\n\t.driver\t= {\n\t\t.name = \"max20411\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table\t= of_max20411_match_tbl,\n\t},\n\t.probe = max20411_probe,\n\t.id_table = max20411_id,\n};\nmodule_i2c_driver(max20411_i2c_driver);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}