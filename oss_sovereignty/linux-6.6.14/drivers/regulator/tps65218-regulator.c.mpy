{
  "module_name": "tps65218-regulator.c",
  "hash_id": "811e6776d820d8ced9ee9ba7de7e4de9ddf355bc7efa8afb6669508b719f4328",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/tps65218-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/mfd/tps65218.h>\n\n#define TPS65218_REGULATOR(_name, _of, _id, _type, _ops, _n, _vr, _vm, _er, \\\n\t\t\t   _em, _cr, _cm, _lr, _nlr, _delay, _fuv, _sr, _sm, \\\n\t\t\t   _ct, _ncl) \\\n\t{\t\t\t\t\t\t\t\\\n\t\t.name\t\t\t= _name,\t\t\\\n\t\t.of_match\t\t= _of,\t\t\t\\\n\t\t.id\t\t\t= _id,\t\t\t\\\n\t\t.ops\t\t\t= &_ops,\t\t\\\n\t\t.n_voltages\t\t= _n,\t\t\t\\\n\t\t.type\t\t\t= _type,\t\\\n\t\t.owner\t\t\t= THIS_MODULE,\t\t\\\n\t\t.vsel_reg\t\t= _vr,\t\t\t\\\n\t\t.vsel_mask\t\t= _vm,\t\t\t\\\n\t\t.csel_reg\t\t= _cr,\t\t\t\\\n\t\t.csel_mask\t\t= _cm,\t\t\t\\\n\t\t.curr_table\t\t= _ct,\t\t\t\\\n\t\t.n_current_limits\t= _ncl,\t\t\t\\\n\t\t.enable_reg\t\t= _er,\t\t\t\\\n\t\t.enable_mask\t\t= _em,\t\t\t\\\n\t\t.volt_table\t\t= NULL,\t\t\t\\\n\t\t.linear_ranges\t\t= _lr,\t\t\t\\\n\t\t.n_linear_ranges\t= _nlr,\t\t\t\\\n\t\t.ramp_delay\t\t= _delay,\t\t\\\n\t\t.fixed_uV\t\t= _fuv,\t\t\t\\\n\t\t.bypass_reg\t= _sr,\t\t\t\t\\\n\t\t.bypass_mask\t= _sm,\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\\\n\nstatic const struct linear_range dcdc1_dcdc2_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(850000, 0x0, 0x32, 10000),\n\tREGULATOR_LINEAR_RANGE(1375000, 0x33, 0x3f, 25000),\n};\n\nstatic const struct linear_range ldo1_dcdc3_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(900000, 0x0, 0x1a, 25000),\n\tREGULATOR_LINEAR_RANGE(1600000, 0x1b, 0x3f, 50000),\n};\n\nstatic const struct linear_range dcdc4_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(1175000, 0x0, 0xf, 25000),\n\tREGULATOR_LINEAR_RANGE(1600000, 0x10, 0x34, 50000),\n};\n\nstatic int tps65218_pmic_set_voltage_sel(struct regulator_dev *dev,\n\t\t\t\t\t unsigned selector)\n{\n\tint ret;\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\tunsigned int rid = rdev_get_id(dev);\n\n\t \n\tret = tps65218_set_bits(tps, dev->desc->vsel_reg, dev->desc->vsel_mask,\n\t\t\t\tselector, TPS65218_PROTECT_L1);\n\n\t \n\tswitch (rid) {\n\tcase TPS65218_DCDC_1:\n\tcase TPS65218_DCDC_2:\n\t\tret = tps65218_set_bits(tps, TPS65218_REG_CONTRL_SLEW_RATE,\n\t\t\t\t\tTPS65218_SLEW_RATE_GO,\n\t\t\t\t\tTPS65218_SLEW_RATE_GO,\n\t\t\t\t\tTPS65218_PROTECT_L1);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic int tps65218_pmic_enable(struct regulator_dev *dev)\n{\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\tint rid = rdev_get_id(dev);\n\n\tif (rid < TPS65218_DCDC_1 || rid > TPS65218_LDO_1)\n\t\treturn -EINVAL;\n\n\t \n\treturn tps65218_set_bits(tps, dev->desc->enable_reg,\n\t\t\t\t dev->desc->enable_mask, dev->desc->enable_mask,\n\t\t\t\t TPS65218_PROTECT_L1);\n}\n\nstatic int tps65218_pmic_disable(struct regulator_dev *dev)\n{\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\tint rid = rdev_get_id(dev);\n\n\tif (rid < TPS65218_DCDC_1 || rid > TPS65218_LDO_1)\n\t\treturn -EINVAL;\n\n\t \n\treturn tps65218_clear_bits(tps, dev->desc->enable_reg,\n\t\t\t\t   dev->desc->enable_mask, TPS65218_PROTECT_L1);\n}\n\nstatic int tps65218_pmic_set_suspend_enable(struct regulator_dev *dev)\n{\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\tunsigned int rid = rdev_get_id(dev);\n\n\tif (rid > TPS65218_LDO_1)\n\t\treturn -EINVAL;\n\n\treturn tps65218_clear_bits(tps, dev->desc->bypass_reg,\n\t\t\t\t   dev->desc->bypass_mask,\n\t\t\t\t   TPS65218_PROTECT_L1);\n}\n\nstatic int tps65218_pmic_set_suspend_disable(struct regulator_dev *dev)\n{\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\tunsigned int rid = rdev_get_id(dev);\n\n\tif (rid > TPS65218_LDO_1)\n\t\treturn -EINVAL;\n\n\t \n\tif (rid == TPS65218_DCDC_3 && tps->rev == TPS65218_REV_2_1)\n\t\treturn 0;\n\n\tif (!tps->strobes[rid]) {\n\t\tif (rid == TPS65218_DCDC_3)\n\t\t\ttps->strobes[rid] = 3;\n\t\telse\n\t\t\treturn -EINVAL;\n\t}\n\n\treturn tps65218_set_bits(tps, dev->desc->bypass_reg,\n\t\t\t\t dev->desc->bypass_mask,\n\t\t\t\t tps->strobes[rid], TPS65218_PROTECT_L1);\n}\n\n \nstatic const struct regulator_ops tps65218_dcdc12_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= tps65218_pmic_enable,\n\t.disable\t\t= tps65218_pmic_disable,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= tps65218_pmic_set_voltage_sel,\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n\t.set_voltage_time_sel\t= regulator_set_voltage_time_sel,\n\t.set_suspend_enable\t= tps65218_pmic_set_suspend_enable,\n\t.set_suspend_disable\t= tps65218_pmic_set_suspend_disable,\n};\n\n \nstatic const struct regulator_ops tps65218_ldo1_dcdc34_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= tps65218_pmic_enable,\n\t.disable\t\t= tps65218_pmic_disable,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= tps65218_pmic_set_voltage_sel,\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n\t.set_suspend_enable\t= tps65218_pmic_set_suspend_enable,\n\t.set_suspend_disable\t= tps65218_pmic_set_suspend_disable,\n};\n\nstatic const unsigned int ls3_currents[] = { 100000, 200000, 500000, 1000000 };\n\nstatic int tps65218_pmic_set_input_current_lim(struct regulator_dev *dev,\n\t\t\t\t\t       int lim_uA)\n{\n\tunsigned int index = 0;\n\tunsigned int num_currents = ARRAY_SIZE(ls3_currents);\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\n\twhile (index < num_currents && ls3_currents[index] != lim_uA)\n\t\tindex++;\n\n\tif (index == num_currents)\n\t\treturn -EINVAL;\n\n\treturn tps65218_set_bits(tps, dev->desc->csel_reg, dev->desc->csel_mask,\n\t\t\t\t index << __builtin_ctz(dev->desc->csel_mask),\n\t\t\t\t TPS65218_PROTECT_L1);\n}\n\nstatic int tps65218_pmic_set_current_limit(struct regulator_dev *dev,\n\t\t\t\t\t   int min_uA, int max_uA)\n{\n\tint index = 0;\n\tunsigned int num_currents = ARRAY_SIZE(ls3_currents);\n\tstruct tps65218 *tps = rdev_get_drvdata(dev);\n\n\twhile (index < num_currents && ls3_currents[index] <= max_uA)\n\t\tindex++;\n\n\tindex--;\n\n\tif (index < 0 || ls3_currents[index] < min_uA)\n\t\treturn -EINVAL;\n\n\treturn tps65218_set_bits(tps, dev->desc->csel_reg, dev->desc->csel_mask,\n\t\t\t\t index << __builtin_ctz(dev->desc->csel_mask),\n\t\t\t\t TPS65218_PROTECT_L1);\n}\n\nstatic const struct regulator_ops tps65218_ls23_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= tps65218_pmic_enable,\n\t.disable\t\t= tps65218_pmic_disable,\n\t.set_input_current_limit = tps65218_pmic_set_input_current_lim,\n\t.set_current_limit\t= tps65218_pmic_set_current_limit,\n\t.get_current_limit\t= regulator_get_current_limit_regmap,\n};\n\n \nstatic const struct regulator_ops tps65218_dcdc56_pmic_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= tps65218_pmic_enable,\n\t.disable\t\t= tps65218_pmic_disable,\n\t.set_suspend_enable\t= tps65218_pmic_set_suspend_enable,\n\t.set_suspend_disable\t= tps65218_pmic_set_suspend_disable,\n};\n\nstatic const struct regulator_desc regulators[] = {\n\tTPS65218_REGULATOR(\"DCDC1\", \"regulator-dcdc1\", TPS65218_DCDC_1,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_dcdc12_ops, 64,\n\t\t\t   TPS65218_REG_CONTROL_DCDC1,\n\t\t\t   TPS65218_CONTROL_DCDC1_MASK, TPS65218_REG_ENABLE1,\n\t\t\t   TPS65218_ENABLE1_DC1_EN, 0, 0, dcdc1_dcdc2_ranges,\n\t\t\t   2, 4000, 0, TPS65218_REG_SEQ3,\n\t\t\t   TPS65218_SEQ3_DC1_SEQ_MASK, NULL, 0),\n\tTPS65218_REGULATOR(\"DCDC2\", \"regulator-dcdc2\", TPS65218_DCDC_2,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_dcdc12_ops, 64,\n\t\t\t   TPS65218_REG_CONTROL_DCDC2,\n\t\t\t   TPS65218_CONTROL_DCDC2_MASK, TPS65218_REG_ENABLE1,\n\t\t\t   TPS65218_ENABLE1_DC2_EN, 0, 0, dcdc1_dcdc2_ranges,\n\t\t\t   2, 4000, 0, TPS65218_REG_SEQ3,\n\t\t\t   TPS65218_SEQ3_DC2_SEQ_MASK, NULL, 0),\n\tTPS65218_REGULATOR(\"DCDC3\", \"regulator-dcdc3\", TPS65218_DCDC_3,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_ldo1_dcdc34_ops, 64,\n\t\t\t   TPS65218_REG_CONTROL_DCDC3,\n\t\t\t   TPS65218_CONTROL_DCDC3_MASK, TPS65218_REG_ENABLE1,\n\t\t\t   TPS65218_ENABLE1_DC3_EN, 0, 0, ldo1_dcdc3_ranges, 2,\n\t\t\t   0, 0, TPS65218_REG_SEQ4, TPS65218_SEQ4_DC3_SEQ_MASK,\n\t\t\t   NULL, 0),\n\tTPS65218_REGULATOR(\"DCDC4\", \"regulator-dcdc4\", TPS65218_DCDC_4,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_ldo1_dcdc34_ops, 53,\n\t\t\t   TPS65218_REG_CONTROL_DCDC4,\n\t\t\t   TPS65218_CONTROL_DCDC4_MASK, TPS65218_REG_ENABLE1,\n\t\t\t   TPS65218_ENABLE1_DC4_EN, 0, 0, dcdc4_ranges, 2,\n\t\t\t   0, 0, TPS65218_REG_SEQ4, TPS65218_SEQ4_DC4_SEQ_MASK,\n\t\t\t   NULL, 0),\n\tTPS65218_REGULATOR(\"DCDC5\", \"regulator-dcdc5\", TPS65218_DCDC_5,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_dcdc56_pmic_ops, 1, -1,\n\t\t\t   -1, TPS65218_REG_ENABLE1, TPS65218_ENABLE1_DC5_EN, 0,\n\t\t\t   0, NULL, 0, 0, 1000000, TPS65218_REG_SEQ5,\n\t\t\t   TPS65218_SEQ5_DC5_SEQ_MASK, NULL, 0),\n\tTPS65218_REGULATOR(\"DCDC6\", \"regulator-dcdc6\", TPS65218_DCDC_6,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_dcdc56_pmic_ops, 1, -1,\n\t\t\t   -1, TPS65218_REG_ENABLE1, TPS65218_ENABLE1_DC6_EN, 0,\n\t\t\t   0, NULL, 0, 0, 1800000, TPS65218_REG_SEQ5,\n\t\t\t   TPS65218_SEQ5_DC6_SEQ_MASK, NULL, 0),\n\tTPS65218_REGULATOR(\"LDO1\", \"regulator-ldo1\", TPS65218_LDO_1,\n\t\t\t   REGULATOR_VOLTAGE, tps65218_ldo1_dcdc34_ops, 64,\n\t\t\t   TPS65218_REG_CONTROL_LDO1,\n\t\t\t   TPS65218_CONTROL_LDO1_MASK, TPS65218_REG_ENABLE2,\n\t\t\t   TPS65218_ENABLE2_LDO1_EN, 0, 0, ldo1_dcdc3_ranges,\n\t\t\t   2, 0, 0, TPS65218_REG_SEQ6,\n\t\t\t   TPS65218_SEQ6_LDO1_SEQ_MASK, NULL, 0),\n\tTPS65218_REGULATOR(\"LS2\", \"regulator-ls2\", TPS65218_LS_2,\n\t\t\t   REGULATOR_CURRENT, tps65218_ls23_ops, 0, 0, 0,\n\t\t\t   TPS65218_REG_ENABLE2, TPS65218_ENABLE2_LS2_EN,\n\t\t\t   TPS65218_REG_CONFIG2, TPS65218_CONFIG2_LS2ILIM_MASK,\n\t\t\t   NULL, 0, 0, 0, 0, 0, ls3_currents,\n\t\t\t   ARRAY_SIZE(ls3_currents)),\n\tTPS65218_REGULATOR(\"LS3\", \"regulator-ls3\", TPS65218_LS_3,\n\t\t\t   REGULATOR_CURRENT, tps65218_ls23_ops, 0, 0, 0,\n\t\t\t   TPS65218_REG_ENABLE2, TPS65218_ENABLE2_LS3_EN,\n\t\t\t   TPS65218_REG_CONFIG2, TPS65218_CONFIG2_LS3ILIM_MASK,\n\t\t\t   NULL, 0, 0, 0, 0, 0, ls3_currents,\n\t\t\t   ARRAY_SIZE(ls3_currents)),\n};\n\nstatic int tps65218_regulator_probe(struct platform_device *pdev)\n{\n\tstruct tps65218 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct regulator_dev *rdev;\n\tstruct regulator_config config = { };\n\tint i, ret;\n\tunsigned int val;\n\n\tconfig.dev = &pdev->dev;\n\tconfig.dev->of_node = tps->dev->of_node;\n\tconfig.driver_data = tps;\n\tconfig.regmap = tps->regmap;\n\n\t \n\ttps->strobes = devm_kcalloc(&pdev->dev,\n\t\t\t\t    TPS65218_NUM_REGULATOR, sizeof(u8),\n\t\t\t\t    GFP_KERNEL);\n\tif (!tps->strobes)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < ARRAY_SIZE(regulators); i++) {\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[i],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(tps->dev, \"failed to register %s regulator\\n\",\n\t\t\t\tpdev->name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\n\t\tret = regmap_read(tps->regmap, regulators[i].bypass_reg, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\ttps->strobes[i] = val & regulators[i].bypass_mask;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id tps65218_regulator_id_table[] = {\n\t{ \"tps65218-regulator\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, tps65218_regulator_id_table);\n\nstatic struct platform_driver tps65218_regulator_driver = {\n\t.driver = {\n\t\t.name = \"tps65218-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = tps65218_regulator_probe,\n\t.id_table = tps65218_regulator_id_table,\n};\n\nmodule_platform_driver(tps65218_regulator_driver);\n\nMODULE_AUTHOR(\"J Keerthy <j-keerthy@ti.com>\");\nMODULE_DESCRIPTION(\"TPS65218 voltage regulator driver\");\nMODULE_ALIAS(\"platform:tps65218-pmic\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}