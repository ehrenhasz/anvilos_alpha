{
  "module_name": "max8907-regulator.c",
  "hash_id": "78ed4a2a1e1f6a313fbd9bee5f4c49a5c332039fe6cab53044b427042dcc7422",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max8907-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/mfd/core.h>\n#include <linux/mfd/max8907.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\n#define MAX8907_II2RR_VERSION_MASK\t0xF0\n#define MAX8907_II2RR_VERSION_REV_A\t0x00\n#define MAX8907_II2RR_VERSION_REV_B\t0x10\n#define MAX8907_II2RR_VERSION_REV_C\t0x30\n\nstruct max8907_regulator {\n\tstruct regulator_desc desc[MAX8907_NUM_REGULATORS];\n};\n\n#define REG_MBATT() \\\n\t[MAX8907_MBATT] = { \\\n\t\t.name = \"MBATT\", \\\n\t\t.supply_name = \"mbatt\", \\\n\t\t.id = MAX8907_MBATT, \\\n\t\t.ops = &max8907_mbatt_ops, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t}\n\n#define REG_LDO(ids, supply, base, min, max, step) \\\n\t[MAX8907_##ids] = { \\\n\t\t.name = #ids, \\\n\t\t.supply_name = supply, \\\n\t\t.id = MAX8907_##ids, \\\n\t\t.n_voltages = ((max) - (min)) / (step) + 1, \\\n\t\t.ops = &max8907_ldo_ops, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t\t.min_uV = (min), \\\n\t\t.uV_step = (step), \\\n\t\t.vsel_reg = (base) + MAX8907_VOUT, \\\n\t\t.vsel_mask = 0x3f, \\\n\t\t.enable_reg = (base) + MAX8907_CTL, \\\n\t\t.enable_mask = MAX8907_MASK_LDO_EN, \\\n\t}\n\n#define REG_FIXED(ids, supply, voltage) \\\n\t[MAX8907_##ids] = { \\\n\t\t.name = #ids, \\\n\t\t.supply_name = supply, \\\n\t\t.id = MAX8907_##ids, \\\n\t\t.n_voltages = 1, \\\n\t\t.ops = &max8907_fixed_ops, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t\t.min_uV = (voltage), \\\n\t}\n\n#define REG_OUT5V(ids, supply, base, voltage) \\\n\t[MAX8907_##ids] = { \\\n\t\t.name = #ids, \\\n\t\t.supply_name = supply, \\\n\t\t.id = MAX8907_##ids, \\\n\t\t.n_voltages = 1, \\\n\t\t.ops = &max8907_out5v_ops, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t\t.min_uV = (voltage), \\\n\t\t.enable_reg = (base), \\\n\t\t.enable_mask = MAX8907_MASK_OUT5V_EN, \\\n\t}\n\n#define REG_BBAT(ids, supply, base, min, max, step) \\\n\t[MAX8907_##ids] = { \\\n\t\t.name = #ids, \\\n\t\t.supply_name = supply, \\\n\t\t.id = MAX8907_##ids, \\\n\t\t.n_voltages = ((max) - (min)) / (step) + 1, \\\n\t\t.ops = &max8907_bbat_ops, \\\n\t\t.type = REGULATOR_VOLTAGE, \\\n\t\t.owner = THIS_MODULE, \\\n\t\t.min_uV = (min), \\\n\t\t.uV_step = (step), \\\n\t\t.vsel_reg = (base), \\\n\t\t.vsel_mask = MAX8907_MASK_VBBATTCV, \\\n\t}\n\n#define LDO_750_50(id, supply, base) REG_LDO(id, supply, (base), \\\n\t\t\t750000, 3900000, 50000)\n#define LDO_650_25(id, supply, base) REG_LDO(id, supply, (base), \\\n\t\t\t650000, 2225000, 25000)\n\nstatic const struct regulator_ops max8907_mbatt_ops = {\n};\n\nstatic const struct regulator_ops max8907_ldo_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n};\n\nstatic const struct regulator_ops max8907_ldo_hwctl_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n};\n\nstatic const struct regulator_ops max8907_fixed_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n};\n\nstatic const struct regulator_ops max8907_out5v_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n};\n\nstatic const struct regulator_ops max8907_out5v_hwctl_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n};\n\nstatic const struct regulator_ops max8907_bbat_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n};\n\nstatic const struct regulator_desc max8907_regulators[] = {\n\tREG_MBATT(),\n\tREG_LDO(SD1, \"in-v1\", MAX8907_REG_SDCTL1, 650000, 2225000, 25000),\n\tREG_LDO(SD2, \"in-v2\", MAX8907_REG_SDCTL2, 637500, 1425000, 12500),\n\tREG_LDO(SD3, \"in-v3\", MAX8907_REG_SDCTL3, 750000, 3900000, 50000),\n\tLDO_750_50(LDO1, \"in1\", MAX8907_REG_LDOCTL1),\n\tLDO_650_25(LDO2, \"in2\", MAX8907_REG_LDOCTL2),\n\tLDO_650_25(LDO3, \"in3\", MAX8907_REG_LDOCTL3),\n\tLDO_750_50(LDO4, \"in4\", MAX8907_REG_LDOCTL4),\n\tLDO_750_50(LDO5, \"in5\", MAX8907_REG_LDOCTL5),\n\tLDO_750_50(LDO6, \"in6\", MAX8907_REG_LDOCTL6),\n\tLDO_750_50(LDO7, \"in7\", MAX8907_REG_LDOCTL7),\n\tLDO_750_50(LDO8, \"in8\", MAX8907_REG_LDOCTL8),\n\tLDO_750_50(LDO9, \"in9\", MAX8907_REG_LDOCTL9),\n\tLDO_750_50(LDO10, \"in10\", MAX8907_REG_LDOCTL10),\n\tLDO_750_50(LDO11, \"in11\", MAX8907_REG_LDOCTL11),\n\tLDO_750_50(LDO12, \"in12\", MAX8907_REG_LDOCTL12),\n\tLDO_750_50(LDO13, \"in13\", MAX8907_REG_LDOCTL13),\n\tLDO_750_50(LDO14, \"in14\", MAX8907_REG_LDOCTL14),\n\tLDO_750_50(LDO15, \"in15\", MAX8907_REG_LDOCTL15),\n\tLDO_750_50(LDO16, \"in16\", MAX8907_REG_LDOCTL16),\n\tLDO_650_25(LDO17, \"in17\", MAX8907_REG_LDOCTL17),\n\tLDO_650_25(LDO18, \"in18\", MAX8907_REG_LDOCTL18),\n\tLDO_750_50(LDO19, \"in19\", MAX8907_REG_LDOCTL19),\n\tLDO_750_50(LDO20, \"in20\", MAX8907_REG_LDOCTL20),\n\tREG_OUT5V(OUT5V, \"mbatt\", MAX8907_REG_OUT5VEN, 5000000),\n\tREG_OUT5V(OUT33V, \"mbatt\",  MAX8907_REG_OUT33VEN, 3300000),\n\tREG_BBAT(BBAT, \"MBATT\", MAX8907_REG_BBAT_CNFG,\n\t\t\t\t\t\t2400000, 3000000, 200000),\n\tREG_FIXED(SDBY, \"MBATT\", 1200000),\n\tREG_FIXED(VRTC, \"MBATT\", 3300000),\n};\n\n#ifdef CONFIG_OF\n\n#define MATCH(_name, _id) \\\n\t[MAX8907_##_id] = { \\\n\t\t.name = #_name, \\\n\t\t.driver_data = (void *)&max8907_regulators[MAX8907_##_id], \\\n\t}\n\nstatic struct of_regulator_match max8907_matches[] = {\n\tMATCH(mbatt, MBATT),\n\tMATCH(sd1, SD1),\n\tMATCH(sd2, SD2),\n\tMATCH(sd3, SD3),\n\tMATCH(ldo1, LDO1),\n\tMATCH(ldo2, LDO2),\n\tMATCH(ldo3, LDO3),\n\tMATCH(ldo4, LDO4),\n\tMATCH(ldo5, LDO5),\n\tMATCH(ldo6, LDO6),\n\tMATCH(ldo7, LDO7),\n\tMATCH(ldo8, LDO8),\n\tMATCH(ldo9, LDO9),\n\tMATCH(ldo10, LDO10),\n\tMATCH(ldo11, LDO11),\n\tMATCH(ldo12, LDO12),\n\tMATCH(ldo13, LDO13),\n\tMATCH(ldo14, LDO14),\n\tMATCH(ldo15, LDO15),\n\tMATCH(ldo16, LDO16),\n\tMATCH(ldo17, LDO17),\n\tMATCH(ldo18, LDO18),\n\tMATCH(ldo19, LDO19),\n\tMATCH(ldo20, LDO20),\n\tMATCH(out5v, OUT5V),\n\tMATCH(out33v, OUT33V),\n\tMATCH(bbat, BBAT),\n\tMATCH(sdby, SDBY),\n\tMATCH(vrtc, VRTC),\n};\n\nstatic int max8907_regulator_parse_dt(struct platform_device *pdev)\n{\n\tstruct device_node *np, *regulators;\n\tint ret;\n\n\tnp = pdev->dev.parent->of_node;\n\tif (!np)\n\t\treturn 0;\n\n\tregulators = of_get_child_by_name(np, \"regulators\");\n\tif (!regulators) {\n\t\tdev_err(&pdev->dev, \"regulators node not found\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = of_regulator_match(&pdev->dev, regulators, max8907_matches,\n\t\t\t\t ARRAY_SIZE(max8907_matches));\n\tof_node_put(regulators);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Error parsing regulator init data: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic inline struct regulator_init_data *match_init_data(int index)\n{\n\treturn max8907_matches[index].init_data;\n}\n\nstatic inline struct device_node *match_of_node(int index)\n{\n\treturn max8907_matches[index].of_node;\n}\n#else\nstatic int max8907_regulator_parse_dt(struct platform_device *pdev)\n{\n\treturn 0;\n}\n\nstatic inline struct regulator_init_data *match_init_data(int index)\n{\n\treturn NULL;\n}\n\nstatic inline struct device_node *match_of_node(int index)\n{\n\treturn NULL;\n}\n#endif\n\nstatic int max8907_regulator_probe(struct platform_device *pdev)\n{\n\tstruct max8907 *max8907 = dev_get_drvdata(pdev->dev.parent);\n\tstruct max8907_platform_data *pdata = dev_get_platdata(max8907->dev);\n\tint ret;\n\tstruct max8907_regulator *pmic;\n\tunsigned int val;\n\tint i;\n\tstruct regulator_config config = {};\n\tstruct regulator_init_data *idata;\n\tconst char *mbatt_rail_name = NULL;\n\n\tret = max8907_regulator_parse_dt(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tpmic = devm_kzalloc(&pdev->dev, sizeof(*pmic), GFP_KERNEL);\n\tif (!pmic)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, pmic);\n\n\tmemcpy(pmic->desc, max8907_regulators, sizeof(pmic->desc));\n\n\t \n\tret = regmap_read(max8907->regmap_gen, MAX8907_REG_II2RR, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tif ((val & MAX8907_II2RR_VERSION_MASK) ==\n\t    MAX8907_II2RR_VERSION_REV_B) {\n\t\tpmic->desc[MAX8907_SD1].min_uV = 637500;\n\t\tpmic->desc[MAX8907_SD1].uV_step = 12500;\n\t\tpmic->desc[MAX8907_SD1].n_voltages =\n\t\t\t\t\t\t(1425000 - 637500) / 12500 + 1;\n\t}\n\n\tfor (i = 0; i < MAX8907_NUM_REGULATORS; i++) {\n\t\tstruct regulator_dev *rdev;\n\n\t\tconfig.dev = pdev->dev.parent;\n\t\tif (pdata)\n\t\t\tidata = pdata->init_data[i];\n\t\telse\n\t\t\tidata = match_init_data(i);\n\t\tconfig.init_data = idata;\n\t\tconfig.driver_data = pmic;\n\t\tconfig.regmap = max8907->regmap_gen;\n\t\tconfig.of_node = match_of_node(i);\n\n\t\tswitch (pmic->desc[i].id) {\n\t\tcase MAX8907_MBATT:\n\t\t\tif (idata && idata->constraints.name)\n\t\t\t\tmbatt_rail_name = idata->constraints.name;\n\t\t\telse\n\t\t\t\tmbatt_rail_name = pmic->desc[i].name;\n\t\t\tbreak;\n\t\tcase MAX8907_BBAT:\n\t\tcase MAX8907_SDBY:\n\t\tcase MAX8907_VRTC:\n\t\t\tidata->supply_regulator = mbatt_rail_name;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (pmic->desc[i].ops == &max8907_ldo_ops) {\n\t\t\tret = regmap_read(config.regmap, pmic->desc[i].enable_reg,\n\t\t\t\t    &val);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tif ((val & MAX8907_MASK_LDO_SEQ) !=\n\t\t\t    MAX8907_MASK_LDO_SEQ)\n\t\t\t\tpmic->desc[i].ops = &max8907_ldo_hwctl_ops;\n\t\t} else if (pmic->desc[i].ops == &max8907_out5v_ops) {\n\t\t\tret = regmap_read(config.regmap, pmic->desc[i].enable_reg,\n\t\t\t\t    &val);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tif ((val & (MAX8907_MASK_OUT5V_VINEN |\n\t\t\t\t\t\tMAX8907_MASK_OUT5V_ENSRC)) !=\n\t\t\t    MAX8907_MASK_OUT5V_ENSRC)\n\t\t\t\tpmic->desc[i].ops = &max8907_out5v_hwctl_ops;\n\t\t}\n\n\t\trdev = devm_regulator_register(&pdev->dev,\n\t\t\t\t\t\t&pmic->desc[i], &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed to register %s regulator\\n\",\n\t\t\t\tpmic->desc[i].name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver max8907_regulator_driver = {\n\t.driver = {\n\t\t   .name = \"max8907-regulator\",\n\t\t   .probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t   },\n\t.probe = max8907_regulator_probe,\n};\n\nstatic int __init max8907_regulator_init(void)\n{\n\treturn platform_driver_register(&max8907_regulator_driver);\n}\n\nsubsys_initcall(max8907_regulator_init);\n\nstatic void __exit max8907_reg_exit(void)\n{\n\tplatform_driver_unregister(&max8907_regulator_driver);\n}\n\nmodule_exit(max8907_reg_exit);\n\nMODULE_DESCRIPTION(\"MAX8907 regulator driver\");\nMODULE_AUTHOR(\"Gyungoh Yoo <jack.yoo@maxim-ic.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:max8907-regulator\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}