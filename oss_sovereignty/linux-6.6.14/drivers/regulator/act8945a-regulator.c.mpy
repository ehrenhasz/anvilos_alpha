{
  "module_name": "act8945a-regulator.c",
  "hash_id": "f58a15d69a494e9190e55b3f9b093b1b50ec4af669de024b0f0d2dd457f53be4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/act8945a-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <dt-bindings/regulator/active-semi,8945a-regulator.h>\n\n \n#define ACT8945A_SYS_MODE\t0x00\n#define ACT8945A_SYS_CTRL\t0x01\n#define ACT8945A_SYS_UNLK_REGS\t0x0b\n#define ACT8945A_DCDC1_VSET1\t0x20\n#define ACT8945A_DCDC1_VSET2\t0x21\n#define ACT8945A_DCDC1_CTRL\t0x22\n#define ACT8945A_DCDC1_SUS\t0x24\n#define ACT8945A_DCDC2_VSET1\t0x30\n#define ACT8945A_DCDC2_VSET2\t0x31\n#define ACT8945A_DCDC2_CTRL\t0x32\n#define ACT8945A_DCDC2_SUS\t0x34\n#define ACT8945A_DCDC3_VSET1\t0x40\n#define ACT8945A_DCDC3_VSET2\t0x41\n#define ACT8945A_DCDC3_CTRL\t0x42\n#define ACT8945A_DCDC3_SUS\t0x44\n#define ACT8945A_LDO1_VSET\t0x50\n#define ACT8945A_LDO1_CTRL\t0x51\n#define ACT8945A_LDO1_SUS\t0x52\n#define ACT8945A_LDO2_VSET\t0x54\n#define ACT8945A_LDO2_CTRL\t0x55\n#define ACT8945A_LDO2_SUS\t0x56\n#define ACT8945A_LDO3_VSET\t0x60\n#define ACT8945A_LDO3_CTRL\t0x61\n#define ACT8945A_LDO3_SUS\t0x62\n#define ACT8945A_LDO4_VSET\t0x64\n#define ACT8945A_LDO4_CTRL\t0x65\n#define ACT8945A_LDO4_SUS\t0x66\n\n \n#define ACT8945A_ENA\t\t0x80\t \n#define ACT8945A_VSEL_MASK\t0x3F\t \n\n \n#define ACT8945A_VOLTAGE_NUM\t64\n\nenum {\n\tACT8945A_ID_DCDC1,\n\tACT8945A_ID_DCDC2,\n\tACT8945A_ID_DCDC3,\n\tACT8945A_ID_LDO1,\n\tACT8945A_ID_LDO2,\n\tACT8945A_ID_LDO3,\n\tACT8945A_ID_LDO4,\n\tACT8945A_ID_MAX,\n};\n\nstruct act8945a_pmic {\n\tstruct regmap *regmap;\n\tu32 op_mode[ACT8945A_ID_MAX];\n};\n\nstatic const struct linear_range act8945a_voltage_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(600000, 0, 23, 25000),\n\tREGULATOR_LINEAR_RANGE(1200000, 24, 47, 50000),\n\tREGULATOR_LINEAR_RANGE(2400000, 48, 63, 100000),\n};\n\nstatic int act8945a_set_suspend_state(struct regulator_dev *rdev, bool enable)\n{\n\tstruct regmap *regmap = rdev->regmap;\n\tint id = rdev_get_id(rdev);\n\tint reg, val;\n\n\tswitch (id) {\n\tcase ACT8945A_ID_DCDC1:\n\t\treg = ACT8945A_DCDC1_SUS;\n\t\tval = 0xa8;\n\t\tbreak;\n\tcase ACT8945A_ID_DCDC2:\n\t\treg = ACT8945A_DCDC2_SUS;\n\t\tval = 0xa8;\n\t\tbreak;\n\tcase ACT8945A_ID_DCDC3:\n\t\treg = ACT8945A_DCDC3_SUS;\n\t\tval = 0xa8;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO1:\n\t\treg = ACT8945A_LDO1_SUS;\n\t\tval = 0xe8;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO2:\n\t\treg = ACT8945A_LDO2_SUS;\n\t\tval = 0xe8;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO3:\n\t\treg = ACT8945A_LDO3_SUS;\n\t\tval = 0xe8;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO4:\n\t\treg = ACT8945A_LDO4_SUS;\n\t\tval = 0xe8;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (enable)\n\t\tval |= BIT(4);\n\n\t \n\treturn regmap_write(regmap, reg, val);\n}\n\nstatic int act8945a_set_suspend_enable(struct regulator_dev *rdev)\n{\n\treturn act8945a_set_suspend_state(rdev, true);\n}\n\nstatic int act8945a_set_suspend_disable(struct regulator_dev *rdev)\n{\n\treturn act8945a_set_suspend_state(rdev, false);\n}\n\nstatic unsigned int act8945a_of_map_mode(unsigned int mode)\n{\n\tswitch (mode) {\n\tcase ACT8945A_REGULATOR_MODE_FIXED:\n\tcase ACT8945A_REGULATOR_MODE_NORMAL:\n\t\treturn REGULATOR_MODE_NORMAL;\n\tcase ACT8945A_REGULATOR_MODE_LOWPOWER:\n\t\treturn REGULATOR_MODE_STANDBY;\n\tdefault:\n\t\treturn REGULATOR_MODE_INVALID;\n\t}\n}\n\nstatic int act8945a_set_mode(struct regulator_dev *rdev, unsigned int mode)\n{\n\tstruct act8945a_pmic *act8945a = rdev_get_drvdata(rdev);\n\tstruct regmap *regmap = rdev->regmap;\n\tint id = rdev_get_id(rdev);\n\tint reg, ret, val = 0;\n\n\tswitch (id) {\n\tcase ACT8945A_ID_DCDC1:\n\t\treg = ACT8945A_DCDC1_CTRL;\n\t\tbreak;\n\tcase ACT8945A_ID_DCDC2:\n\t\treg = ACT8945A_DCDC2_CTRL;\n\t\tbreak;\n\tcase ACT8945A_ID_DCDC3:\n\t\treg = ACT8945A_DCDC3_CTRL;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO1:\n\t\treg = ACT8945A_LDO1_CTRL;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO2:\n\t\treg = ACT8945A_LDO2_CTRL;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO3:\n\t\treg = ACT8945A_LDO3_CTRL;\n\t\tbreak;\n\tcase ACT8945A_ID_LDO4:\n\t\treg = ACT8945A_LDO4_CTRL;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (mode) {\n\tcase REGULATOR_MODE_STANDBY:\n\t\tif (id > ACT8945A_ID_DCDC3)\n\t\t\tval = BIT(5);\n\t\tbreak;\n\tcase REGULATOR_MODE_NORMAL:\n\t\tif (id <= ACT8945A_ID_DCDC3)\n\t\t\tval = BIT(5);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = regmap_update_bits(regmap, reg, BIT(5), val);\n\tif (ret)\n\t\treturn ret;\n\n\tact8945a->op_mode[id] = mode;\n\n\treturn 0;\n}\n\nstatic unsigned int act8945a_get_mode(struct regulator_dev *rdev)\n{\n\tstruct act8945a_pmic *act8945a = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\n\tif (id < ACT8945A_ID_DCDC1 || id >= ACT8945A_ID_MAX)\n\t\treturn -EINVAL;\n\n\treturn act8945a->op_mode[id];\n}\n\nstatic const struct regulator_ops act8945a_ops = {\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.set_mode\t\t= act8945a_set_mode,\n\t.get_mode\t\t= act8945a_get_mode,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.set_suspend_enable\t= act8945a_set_suspend_enable,\n\t.set_suspend_disable\t= act8945a_set_suspend_disable,\n};\n\n#define ACT89xx_REG(_name, _family, _id, _vsel_reg, _supply)\t\t\\\n\t[_family##_ID_##_id] = {\t\t\t\t\t\\\n\t\t.name\t\t\t= _name,\t\t\t\\\n\t\t.supply_name\t\t= _supply,\t\t\t\\\n\t\t.of_match\t\t= of_match_ptr(\"REG_\"#_id),\t\\\n\t\t.of_map_mode\t\t= act8945a_of_map_mode,\t\t\\\n\t\t.regulators_node\t= of_match_ptr(\"regulators\"),\t\\\n\t\t.id\t\t\t= _family##_ID_##_id,\t\t\\\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\t\t\\\n\t\t.ops\t\t\t= &act8945a_ops,\t\t\\\n\t\t.n_voltages\t\t= ACT8945A_VOLTAGE_NUM,\t\t\\\n\t\t.linear_ranges\t\t= act8945a_voltage_ranges,\t\\\n\t\t.n_linear_ranges\t= ARRAY_SIZE(act8945a_voltage_ranges), \\\n\t\t.vsel_reg\t\t= _family##_##_id##_##_vsel_reg, \\\n\t\t.vsel_mask\t\t= ACT8945A_VSEL_MASK,\t\t\\\n\t\t.enable_reg\t\t= _family##_##_id##_CTRL,\t\\\n\t\t.enable_mask\t\t= ACT8945A_ENA,\t\t\t\\\n\t\t.owner\t\t\t= THIS_MODULE,\t\t\t\\\n\t}\n\nstatic const struct regulator_desc act8945a_regulators[] = {\n\tACT89xx_REG(\"DCDC_REG1\", ACT8945A, DCDC1, VSET1, \"vp1\"),\n\tACT89xx_REG(\"DCDC_REG2\", ACT8945A, DCDC2, VSET1, \"vp2\"),\n\tACT89xx_REG(\"DCDC_REG3\", ACT8945A, DCDC3, VSET1, \"vp3\"),\n\tACT89xx_REG(\"LDO_REG1\", ACT8945A, LDO1, VSET, \"inl45\"),\n\tACT89xx_REG(\"LDO_REG2\", ACT8945A, LDO2, VSET, \"inl45\"),\n\tACT89xx_REG(\"LDO_REG3\", ACT8945A, LDO3, VSET, \"inl67\"),\n\tACT89xx_REG(\"LDO_REG4\", ACT8945A, LDO4, VSET, \"inl67\"),\n};\n\nstatic const struct regulator_desc act8945a_alt_regulators[] = {\n\tACT89xx_REG(\"DCDC_REG1\", ACT8945A, DCDC1, VSET2, \"vp1\"),\n\tACT89xx_REG(\"DCDC_REG2\", ACT8945A, DCDC2, VSET2, \"vp2\"),\n\tACT89xx_REG(\"DCDC_REG3\", ACT8945A, DCDC3, VSET2, \"vp3\"),\n\tACT89xx_REG(\"LDO_REG1\", ACT8945A, LDO1, VSET, \"inl45\"),\n\tACT89xx_REG(\"LDO_REG2\", ACT8945A, LDO2, VSET, \"inl45\"),\n\tACT89xx_REG(\"LDO_REG3\", ACT8945A, LDO3, VSET, \"inl67\"),\n\tACT89xx_REG(\"LDO_REG4\", ACT8945A, LDO4, VSET, \"inl67\"),\n};\n\nstatic int act8945a_pmic_probe(struct platform_device *pdev)\n{\n\tstruct regulator_config config = { };\n\tconst struct regulator_desc *regulators;\n\tstruct act8945a_pmic *act8945a;\n\tstruct regulator_dev *rdev;\n\tint i, num_regulators;\n\tbool voltage_select;\n\n\tact8945a = devm_kzalloc(&pdev->dev, sizeof(*act8945a), GFP_KERNEL);\n\tif (!act8945a)\n\t\treturn -ENOMEM;\n\n\tact8945a->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!act8945a->regmap) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"could not retrieve regmap from parent device\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tvoltage_select = of_property_read_bool(pdev->dev.parent->of_node,\n\t\t\t\t\t       \"active-semi,vsel-high\");\n\n\tif (voltage_select) {\n\t\tregulators = act8945a_alt_regulators;\n\t\tnum_regulators = ARRAY_SIZE(act8945a_alt_regulators);\n\t} else {\n\t\tregulators = act8945a_regulators;\n\t\tnum_regulators = ARRAY_SIZE(act8945a_regulators);\n\t}\n\n\tconfig.dev = &pdev->dev;\n\tconfig.dev->of_node = pdev->dev.parent->of_node;\n\tconfig.driver_data = act8945a;\n\tfor (i = 0; i < num_regulators; i++) {\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[i],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed to register %s regulator\\n\",\n\t\t\t\tregulators[i].name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\tplatform_set_drvdata(pdev, act8945a);\n\n\t \n\treturn regmap_write(act8945a->regmap, ACT8945A_SYS_UNLK_REGS, 0xef);\n}\n\nstatic int __maybe_unused act8945a_suspend(struct device *pdev)\n{\n\tstruct act8945a_pmic *act8945a = dev_get_drvdata(pdev);\n\n\t \n\treturn regmap_write(act8945a->regmap, ACT8945A_SYS_CTRL, 0x42);\n}\n\nstatic SIMPLE_DEV_PM_OPS(act8945a_pm, act8945a_suspend, NULL);\n\nstatic void act8945a_pmic_shutdown(struct platform_device *pdev)\n{\n\tstruct act8945a_pmic *act8945a = platform_get_drvdata(pdev);\n\n\t \n\tregmap_write(act8945a->regmap, ACT8945A_SYS_CTRL, 0x0);\n}\n\nstatic struct platform_driver act8945a_pmic_driver = {\n\t.driver = {\n\t\t.name = \"act8945a-regulator\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.pm = &act8945a_pm,\n\t},\n\t.probe = act8945a_pmic_probe,\n\t.shutdown = act8945a_pmic_shutdown,\n};\nmodule_platform_driver(act8945a_pmic_driver);\n\nMODULE_DESCRIPTION(\"Active-semi ACT8945A voltage regulator driver\");\nMODULE_AUTHOR(\"Wenyou Yang <wenyou.yang@atmel.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}