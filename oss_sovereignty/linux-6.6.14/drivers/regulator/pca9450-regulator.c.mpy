{
  "module_name": "pca9450-regulator.c",
  "hash_id": "200601bcaee5045134d3829c4e31ccb78227b9cd704bf1aa43e50233196a7a09",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/pca9450-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/gpio/consumer.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/regulator/pca9450.h>\n\nstruct pc9450_dvs_config {\n\tunsigned int run_reg;  \n\tunsigned int run_mask;\n\tunsigned int standby_reg;  \n\tunsigned int standby_mask;\n};\n\nstruct pca9450_regulator_desc {\n\tstruct regulator_desc desc;\n\tconst struct pc9450_dvs_config dvs;\n};\n\nstruct pca9450 {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tstruct gpio_desc *sd_vsel_gpio;\n\tenum pca9450_chip_type type;\n\tunsigned int rcnt;\n\tint irq;\n};\n\nstatic const struct regmap_range pca9450_status_range = {\n\t.range_min = PCA9450_REG_INT1,\n\t.range_max = PCA9450_REG_PWRON_STAT,\n};\n\nstatic const struct regmap_access_table pca9450_volatile_regs = {\n\t.yes_ranges = &pca9450_status_range,\n\t.n_yes_ranges = 1,\n};\n\nstatic const struct regmap_config pca9450_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.volatile_table = &pca9450_volatile_regs,\n\t.max_register = PCA9450_MAX_REGISTER - 1,\n\t.cache_type = REGCACHE_RBTREE,\n};\n\n \nstatic const unsigned int pca9450_dvs_buck_ramp_table[] = {\n\t25000, 12500, 6250, 3125\n};\n\nstatic const struct regulator_ops pca9450_dvs_buck_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_time_sel = regulator_set_voltage_time_sel,\n\t.set_ramp_delay\t= regulator_set_ramp_delay_regmap,\n};\n\nstatic const struct regulator_ops pca9450_buck_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_time_sel = regulator_set_voltage_time_sel,\n};\n\nstatic const struct regulator_ops pca9450_ldo_regulator_ops = {\n\t.enable = regulator_enable_regmap,\n\t.disable = regulator_disable_regmap,\n\t.is_enabled = regulator_is_enabled_regmap,\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n};\n\n \nstatic const struct linear_range pca9450_dvs_buck_volts[] = {\n\tREGULATOR_LINEAR_RANGE(600000,  0x00, 0x7F, 12500),\n};\n\n \nstatic const struct linear_range pca9450_buck_volts[] = {\n\tREGULATOR_LINEAR_RANGE(600000, 0x00, 0x70, 25000),\n\tREGULATOR_LINEAR_RANGE(3400000, 0x71, 0x7F, 0),\n};\n\n \nstatic const struct linear_range pca9450_ldo1_volts[] = {\n\tREGULATOR_LINEAR_RANGE(1600000, 0x00, 0x03, 100000),\n\tREGULATOR_LINEAR_RANGE(3000000, 0x04, 0x07, 100000),\n};\n\n \nstatic const struct linear_range pca9450_ldo2_volts[] = {\n\tREGULATOR_LINEAR_RANGE(800000, 0x00, 0x07, 50000),\n};\n\n \nstatic const struct linear_range pca9450_ldo34_volts[] = {\n\tREGULATOR_LINEAR_RANGE(800000, 0x00, 0x19, 100000),\n\tREGULATOR_LINEAR_RANGE(3300000, 0x1A, 0x1F, 0),\n};\n\n \nstatic const struct linear_range pca9450_ldo5_volts[] = {\n\tREGULATOR_LINEAR_RANGE(1800000,  0x00, 0x0F, 100000),\n};\n\nstatic int buck_set_dvs(const struct regulator_desc *desc,\n\t\t\tstruct device_node *np, struct regmap *regmap,\n\t\t\tchar *prop, unsigned int reg, unsigned int mask)\n{\n\tint ret, i;\n\tuint32_t uv;\n\n\tret = of_property_read_u32(np, prop, &uv);\n\tif (ret == -EINVAL)\n\t\treturn 0;\n\telse if (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < desc->n_voltages; i++) {\n\t\tret = regulator_desc_list_voltage_linear_range(desc, i);\n\t\tif (ret < 0)\n\t\t\tcontinue;\n\t\tif (ret == uv) {\n\t\t\ti <<= ffs(desc->vsel_mask) - 1;\n\t\t\tret = regmap_update_bits(regmap, reg, mask, i);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (ret == 0) {\n\t\tstruct pca9450_regulator_desc *regulator = container_of(desc,\n\t\t\t\t\tstruct pca9450_regulator_desc, desc);\n\n\t\t \n\t\tret = regmap_update_bits(regmap, regulator->desc.enable_reg,\n\t\t\t\t\t BUCK1_DVS_CTRL, BUCK1_DVS_CTRL);\n\t}\n\treturn ret;\n}\n\nstatic int pca9450_set_dvs_levels(struct device_node *np,\n\t\t\t    const struct regulator_desc *desc,\n\t\t\t    struct regulator_config *cfg)\n{\n\tstruct pca9450_regulator_desc *data = container_of(desc,\n\t\t\t\t\tstruct pca9450_regulator_desc, desc);\n\tconst struct pc9450_dvs_config *dvs = &data->dvs;\n\tunsigned int reg, mask;\n\tchar *prop;\n\tint i, ret = 0;\n\n\tfor (i = 0; i < PCA9450_DVS_LEVEL_MAX; i++) {\n\t\tswitch (i) {\n\t\tcase PCA9450_DVS_LEVEL_RUN:\n\t\t\tprop = \"nxp,dvs-run-voltage\";\n\t\t\treg = dvs->run_reg;\n\t\t\tmask = dvs->run_mask;\n\t\t\tbreak;\n\t\tcase PCA9450_DVS_LEVEL_STANDBY:\n\t\t\tprop = \"nxp,dvs-standby-voltage\";\n\t\t\treg = dvs->standby_reg;\n\t\t\tmask = dvs->standby_mask;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tret = buck_set_dvs(desc, np, cfg->regmap, prop, reg, mask);\n\t\tif (ret)\n\t\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct pca9450_regulator_desc pca9450a_regulators[] = {\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck1\",\n\t\t\t.of_match = of_match_ptr(\"BUCK1\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK1,\n\t\t\t.ops = &pca9450_dvs_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK1_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_dvs_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_dvs_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK1OUT_DVS0,\n\t\t\t.vsel_mask = BUCK1OUT_DVS0_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK1CTRL,\n\t\t\t.enable_mask = BUCK1_ENMODE_MASK,\n\t\t\t.ramp_reg = PCA9450_REG_BUCK1CTRL,\n\t\t\t.ramp_mask = BUCK1_RAMP_MASK,\n\t\t\t.ramp_delay_table = pca9450_dvs_buck_ramp_table,\n\t\t\t.n_ramp_values = ARRAY_SIZE(pca9450_dvs_buck_ramp_table),\n\t\t\t.owner = THIS_MODULE,\n\t\t\t.of_parse_cb = pca9450_set_dvs_levels,\n\t\t},\n\t\t.dvs = {\n\t\t\t.run_reg = PCA9450_REG_BUCK1OUT_DVS0,\n\t\t\t.run_mask = BUCK1OUT_DVS0_MASK,\n\t\t\t.standby_reg = PCA9450_REG_BUCK1OUT_DVS1,\n\t\t\t.standby_mask = BUCK1OUT_DVS1_MASK,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck2\",\n\t\t\t.of_match = of_match_ptr(\"BUCK2\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK2,\n\t\t\t.ops = &pca9450_dvs_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK2_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_dvs_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_dvs_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK2OUT_DVS0,\n\t\t\t.vsel_mask = BUCK2OUT_DVS0_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK2CTRL,\n\t\t\t.enable_mask = BUCK2_ENMODE_MASK,\n\t\t\t.ramp_reg = PCA9450_REG_BUCK2CTRL,\n\t\t\t.ramp_mask = BUCK2_RAMP_MASK,\n\t\t\t.ramp_delay_table = pca9450_dvs_buck_ramp_table,\n\t\t\t.n_ramp_values = ARRAY_SIZE(pca9450_dvs_buck_ramp_table),\n\t\t\t.owner = THIS_MODULE,\n\t\t\t.of_parse_cb = pca9450_set_dvs_levels,\n\t\t},\n\t\t.dvs = {\n\t\t\t.run_reg = PCA9450_REG_BUCK2OUT_DVS0,\n\t\t\t.run_mask = BUCK2OUT_DVS0_MASK,\n\t\t\t.standby_reg = PCA9450_REG_BUCK2OUT_DVS1,\n\t\t\t.standby_mask = BUCK2OUT_DVS1_MASK,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck3\",\n\t\t\t.of_match = of_match_ptr(\"BUCK3\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK3,\n\t\t\t.ops = &pca9450_dvs_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK3_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_dvs_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_dvs_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK3OUT_DVS0,\n\t\t\t.vsel_mask = BUCK3OUT_DVS0_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK3CTRL,\n\t\t\t.enable_mask = BUCK3_ENMODE_MASK,\n\t\t\t.ramp_reg = PCA9450_REG_BUCK3CTRL,\n\t\t\t.ramp_mask = BUCK3_RAMP_MASK,\n\t\t\t.ramp_delay_table = pca9450_dvs_buck_ramp_table,\n\t\t\t.n_ramp_values = ARRAY_SIZE(pca9450_dvs_buck_ramp_table),\n\t\t\t.owner = THIS_MODULE,\n\t\t\t.of_parse_cb = pca9450_set_dvs_levels,\n\t\t},\n\t\t.dvs = {\n\t\t\t.run_reg = PCA9450_REG_BUCK3OUT_DVS0,\n\t\t\t.run_mask = BUCK3OUT_DVS0_MASK,\n\t\t\t.standby_reg = PCA9450_REG_BUCK3OUT_DVS1,\n\t\t\t.standby_mask = BUCK3OUT_DVS1_MASK,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck4\",\n\t\t\t.of_match = of_match_ptr(\"BUCK4\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK4,\n\t\t\t.ops = &pca9450_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK4_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK4OUT,\n\t\t\t.vsel_mask = BUCK4OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK4CTRL,\n\t\t\t.enable_mask = BUCK4_ENMODE_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck5\",\n\t\t\t.of_match = of_match_ptr(\"BUCK5\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK5,\n\t\t\t.ops = &pca9450_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK5_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK5OUT,\n\t\t\t.vsel_mask = BUCK5OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK5CTRL,\n\t\t\t.enable_mask = BUCK5_ENMODE_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck6\",\n\t\t\t.of_match = of_match_ptr(\"BUCK6\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK6,\n\t\t\t.ops = &pca9450_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK6_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK6OUT,\n\t\t\t.vsel_mask = BUCK6OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK6CTRL,\n\t\t\t.enable_mask = BUCK6_ENMODE_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo1\",\n\t\t\t.of_match = of_match_ptr(\"LDO1\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO1,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO1_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo1_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo1_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO1CTRL,\n\t\t\t.vsel_mask = LDO1OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO1CTRL,\n\t\t\t.enable_mask = LDO1_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo2\",\n\t\t\t.of_match = of_match_ptr(\"LDO2\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO2,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO2_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo2_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo2_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO2CTRL,\n\t\t\t.vsel_mask = LDO2OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO2CTRL,\n\t\t\t.enable_mask = LDO2_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo3\",\n\t\t\t.of_match = of_match_ptr(\"LDO3\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO3,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO3_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo34_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo34_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO3CTRL,\n\t\t\t.vsel_mask = LDO3OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO3CTRL,\n\t\t\t.enable_mask = LDO3_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo4\",\n\t\t\t.of_match = of_match_ptr(\"LDO4\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO4,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO4_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo34_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo34_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO4CTRL,\n\t\t\t.vsel_mask = LDO4OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO4CTRL,\n\t\t\t.enable_mask = LDO4_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo5\",\n\t\t\t.of_match = of_match_ptr(\"LDO5\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO5,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO5_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo5_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo5_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO5CTRL_H,\n\t\t\t.vsel_mask = LDO5HOUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO5CTRL_H,\n\t\t\t.enable_mask = LDO5H_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n};\n\n \nstatic const struct pca9450_regulator_desc pca9450bc_regulators[] = {\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck1\",\n\t\t\t.of_match = of_match_ptr(\"BUCK1\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK1,\n\t\t\t.ops = &pca9450_dvs_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK1_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_dvs_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_dvs_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK1OUT_DVS0,\n\t\t\t.vsel_mask = BUCK1OUT_DVS0_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK1CTRL,\n\t\t\t.enable_mask = BUCK1_ENMODE_MASK,\n\t\t\t.ramp_reg = PCA9450_REG_BUCK1CTRL,\n\t\t\t.ramp_mask = BUCK1_RAMP_MASK,\n\t\t\t.ramp_delay_table = pca9450_dvs_buck_ramp_table,\n\t\t\t.n_ramp_values = ARRAY_SIZE(pca9450_dvs_buck_ramp_table),\n\t\t\t.owner = THIS_MODULE,\n\t\t\t.of_parse_cb = pca9450_set_dvs_levels,\n\t\t},\n\t\t.dvs = {\n\t\t\t.run_reg = PCA9450_REG_BUCK1OUT_DVS0,\n\t\t\t.run_mask = BUCK1OUT_DVS0_MASK,\n\t\t\t.standby_reg = PCA9450_REG_BUCK1OUT_DVS1,\n\t\t\t.standby_mask = BUCK1OUT_DVS1_MASK,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck2\",\n\t\t\t.of_match = of_match_ptr(\"BUCK2\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK2,\n\t\t\t.ops = &pca9450_dvs_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK2_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_dvs_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_dvs_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK2OUT_DVS0,\n\t\t\t.vsel_mask = BUCK2OUT_DVS0_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK2CTRL,\n\t\t\t.enable_mask = BUCK2_ENMODE_MASK,\n\t\t\t.ramp_reg = PCA9450_REG_BUCK2CTRL,\n\t\t\t.ramp_mask = BUCK2_RAMP_MASK,\n\t\t\t.ramp_delay_table = pca9450_dvs_buck_ramp_table,\n\t\t\t.n_ramp_values = ARRAY_SIZE(pca9450_dvs_buck_ramp_table),\n\t\t\t.owner = THIS_MODULE,\n\t\t\t.of_parse_cb = pca9450_set_dvs_levels,\n\t\t},\n\t\t.dvs = {\n\t\t\t.run_reg = PCA9450_REG_BUCK2OUT_DVS0,\n\t\t\t.run_mask = BUCK2OUT_DVS0_MASK,\n\t\t\t.standby_reg = PCA9450_REG_BUCK2OUT_DVS1,\n\t\t\t.standby_mask = BUCK2OUT_DVS1_MASK,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck4\",\n\t\t\t.of_match = of_match_ptr(\"BUCK4\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK4,\n\t\t\t.ops = &pca9450_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK4_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK4OUT,\n\t\t\t.vsel_mask = BUCK4OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK4CTRL,\n\t\t\t.enable_mask = BUCK4_ENMODE_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck5\",\n\t\t\t.of_match = of_match_ptr(\"BUCK5\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK5,\n\t\t\t.ops = &pca9450_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK5_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK5OUT,\n\t\t\t.vsel_mask = BUCK5OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK5CTRL,\n\t\t\t.enable_mask = BUCK5_ENMODE_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"buck6\",\n\t\t\t.of_match = of_match_ptr(\"BUCK6\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_BUCK6,\n\t\t\t.ops = &pca9450_buck_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_BUCK6_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_buck_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_buck_volts),\n\t\t\t.vsel_reg = PCA9450_REG_BUCK6OUT,\n\t\t\t.vsel_mask = BUCK6OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_BUCK6CTRL,\n\t\t\t.enable_mask = BUCK6_ENMODE_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo1\",\n\t\t\t.of_match = of_match_ptr(\"LDO1\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO1,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO1_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo1_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo1_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO1CTRL,\n\t\t\t.vsel_mask = LDO1OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO1CTRL,\n\t\t\t.enable_mask = LDO1_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo2\",\n\t\t\t.of_match = of_match_ptr(\"LDO2\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO2,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO2_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo2_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo2_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO2CTRL,\n\t\t\t.vsel_mask = LDO2OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO2CTRL,\n\t\t\t.enable_mask = LDO2_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo3\",\n\t\t\t.of_match = of_match_ptr(\"LDO3\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO3,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO3_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo34_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo34_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO3CTRL,\n\t\t\t.vsel_mask = LDO3OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO3CTRL,\n\t\t\t.enable_mask = LDO3_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo4\",\n\t\t\t.of_match = of_match_ptr(\"LDO4\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO4,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO4_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo34_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo34_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO4CTRL,\n\t\t\t.vsel_mask = LDO4OUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO4CTRL,\n\t\t\t.enable_mask = LDO4_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n\t{\n\t\t.desc = {\n\t\t\t.name = \"ldo5\",\n\t\t\t.of_match = of_match_ptr(\"LDO5\"),\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\n\t\t\t.id = PCA9450_LDO5,\n\t\t\t.ops = &pca9450_ldo_regulator_ops,\n\t\t\t.type = REGULATOR_VOLTAGE,\n\t\t\t.n_voltages = PCA9450_LDO5_VOLTAGE_NUM,\n\t\t\t.linear_ranges = pca9450_ldo5_volts,\n\t\t\t.n_linear_ranges = ARRAY_SIZE(pca9450_ldo5_volts),\n\t\t\t.vsel_reg = PCA9450_REG_LDO5CTRL_H,\n\t\t\t.vsel_mask = LDO5HOUT_MASK,\n\t\t\t.enable_reg = PCA9450_REG_LDO5CTRL_H,\n\t\t\t.enable_mask = LDO5H_EN_MASK,\n\t\t\t.owner = THIS_MODULE,\n\t\t},\n\t},\n};\n\nstatic irqreturn_t pca9450_irq_handler(int irq, void *data)\n{\n\tstruct pca9450 *pca9450 = data;\n\tstruct regmap *regmap = pca9450->regmap;\n\tunsigned int status;\n\tint ret;\n\n\tret = regmap_read(regmap, PCA9450_REG_INT1, &status);\n\tif (ret < 0) {\n\t\tdev_err(pca9450->dev,\n\t\t\t\"Failed to read INT1(%d)\\n\", ret);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (status & IRQ_PWRON)\n\t\tdev_warn(pca9450->dev, \"PWRON interrupt.\\n\");\n\n\tif (status & IRQ_WDOGB)\n\t\tdev_warn(pca9450->dev, \"WDOGB interrupt.\\n\");\n\n\tif (status & IRQ_VR_FLT1)\n\t\tdev_warn(pca9450->dev, \"VRFLT1 interrupt.\\n\");\n\n\tif (status & IRQ_VR_FLT2)\n\t\tdev_warn(pca9450->dev, \"VRFLT2 interrupt.\\n\");\n\n\tif (status & IRQ_LOWVSYS)\n\t\tdev_warn(pca9450->dev, \"LOWVSYS interrupt.\\n\");\n\n\tif (status & IRQ_THERM_105)\n\t\tdev_warn(pca9450->dev, \"IRQ_THERM_105 interrupt.\\n\");\n\n\tif (status & IRQ_THERM_125)\n\t\tdev_warn(pca9450->dev, \"IRQ_THERM_125 interrupt.\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int pca9450_i2c_probe(struct i2c_client *i2c)\n{\n\tenum pca9450_chip_type type = (unsigned int)(uintptr_t)\n\t\t\t\t      of_device_get_match_data(&i2c->dev);\n\tconst struct pca9450_regulator_desc\t*regulator_desc;\n\tstruct regulator_config config = { };\n\tstruct pca9450 *pca9450;\n\tunsigned int device_id, i;\n\tunsigned int reset_ctrl;\n\tint ret;\n\n\tif (!i2c->irq) {\n\t\tdev_err(&i2c->dev, \"No IRQ configured?\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tpca9450 = devm_kzalloc(&i2c->dev, sizeof(struct pca9450), GFP_KERNEL);\n\tif (!pca9450)\n\t\treturn -ENOMEM;\n\n\tswitch (type) {\n\tcase PCA9450_TYPE_PCA9450A:\n\t\tregulator_desc = pca9450a_regulators;\n\t\tpca9450->rcnt = ARRAY_SIZE(pca9450a_regulators);\n\t\tbreak;\n\tcase PCA9450_TYPE_PCA9450BC:\n\t\tregulator_desc = pca9450bc_regulators;\n\t\tpca9450->rcnt = ARRAY_SIZE(pca9450bc_regulators);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&i2c->dev, \"Unknown device type\");\n\t\treturn -EINVAL;\n\t}\n\n\tpca9450->irq = i2c->irq;\n\tpca9450->type = type;\n\tpca9450->dev = &i2c->dev;\n\n\tdev_set_drvdata(&i2c->dev, pca9450);\n\n\tpca9450->regmap = devm_regmap_init_i2c(i2c,\n\t\t\t\t\t       &pca9450_regmap_config);\n\tif (IS_ERR(pca9450->regmap)) {\n\t\tdev_err(&i2c->dev, \"regmap initialization failed\\n\");\n\t\treturn PTR_ERR(pca9450->regmap);\n\t}\n\n\tret = regmap_read(pca9450->regmap, PCA9450_REG_DEV_ID, &device_id);\n\tif (ret) {\n\t\tdev_err(&i2c->dev, \"Read device id error\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (((device_id >> 4) != 0x1 && type == PCA9450_TYPE_PCA9450A) ||\n\t    ((device_id >> 4) != 0x3 && type == PCA9450_TYPE_PCA9450BC)) {\n\t\tdev_err(&i2c->dev, \"Device id(%x) mismatched\\n\",\n\t\t\tdevice_id >> 4);\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < pca9450->rcnt; i++) {\n\t\tconst struct regulator_desc *desc;\n\t\tstruct regulator_dev *rdev;\n\t\tconst struct pca9450_regulator_desc *r;\n\n\t\tr = &regulator_desc[i];\n\t\tdesc = &r->desc;\n\n\t\tconfig.regmap = pca9450->regmap;\n\t\tconfig.dev = pca9450->dev;\n\n\t\trdev = devm_regulator_register(pca9450->dev, desc, &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tret = PTR_ERR(rdev);\n\t\t\tdev_err(pca9450->dev,\n\t\t\t\t\"Failed to register regulator(%s): %d\\n\",\n\t\t\t\tdesc->name, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = devm_request_threaded_irq(pca9450->dev, pca9450->irq, NULL,\n\t\t\t\t\tpca9450_irq_handler,\n\t\t\t\t\t(IRQF_TRIGGER_FALLING | IRQF_ONESHOT),\n\t\t\t\t\t\"pca9450-irq\", pca9450);\n\tif (ret != 0) {\n\t\tdev_err(pca9450->dev, \"Failed to request IRQ: %d\\n\",\n\t\t\tpca9450->irq);\n\t\treturn ret;\n\t}\n\t \n\tret = regmap_update_bits(pca9450->regmap, PCA9450_REG_INT1_MSK,\n\t\t\t\tIRQ_VR_FLT1 | IRQ_VR_FLT2 | IRQ_LOWVSYS |\n\t\t\t\tIRQ_THERM_105 | IRQ_THERM_125,\n\t\t\t\tIRQ_PWRON | IRQ_WDOGB | IRQ_RSVD);\n\tif (ret) {\n\t\tdev_err(&i2c->dev, \"Unmask irq error\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_clear_bits(pca9450->regmap, PCA9450_REG_BUCK123_DVS,\n\t\t\t\tBUCK123_PRESET_EN);\n\tif (ret) {\n\t\tdev_err(&i2c->dev, \"Failed to clear PRESET_EN bit: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (of_property_read_bool(i2c->dev.of_node, \"nxp,wdog_b-warm-reset\"))\n\t\treset_ctrl = WDOG_B_CFG_WARM;\n\telse\n\t\treset_ctrl = WDOG_B_CFG_COLD_LDO12;\n\n\t \n\tret = regmap_update_bits(pca9450->regmap, PCA9450_REG_RESET_CTRL,\n\t\t\t\t WDOG_B_CFG_MASK, reset_ctrl);\n\tif (ret) {\n\t\tdev_err(&i2c->dev, \"Failed to set WDOG_B reset behavior\\n\");\n\t\treturn ret;\n\t}\n\n\tif (of_property_read_bool(i2c->dev.of_node, \"nxp,i2c-lt-enable\")) {\n\t\t \n\t\tret = regmap_update_bits(pca9450->regmap, PCA9450_REG_CONFIG2,\n\t\t\t\t\t I2C_LT_MASK, I2C_LT_ON_STANDBY_RUN);\n\t\tif (ret) {\n\t\t\tdev_err(&i2c->dev,\n\t\t\t\t\"Failed to enable I2C level translator\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tpca9450->sd_vsel_gpio = gpiod_get_optional(pca9450->dev, \"sd-vsel\", GPIOD_OUT_HIGH);\n\n\tif (IS_ERR(pca9450->sd_vsel_gpio)) {\n\t\tdev_err(&i2c->dev, \"Failed to get SD_VSEL GPIO\\n\");\n\t\treturn PTR_ERR(pca9450->sd_vsel_gpio);\n\t}\n\n\tdev_info(&i2c->dev, \"%s probed.\\n\",\n\t\ttype == PCA9450_TYPE_PCA9450A ? \"pca9450a\" : \"pca9450bc\");\n\n\treturn 0;\n}\n\nstatic const struct of_device_id pca9450_of_match[] = {\n\t{\n\t\t.compatible = \"nxp,pca9450a\",\n\t\t.data = (void *)PCA9450_TYPE_PCA9450A,\n\t},\n\t{\n\t\t.compatible = \"nxp,pca9450b\",\n\t\t.data = (void *)PCA9450_TYPE_PCA9450BC,\n\t},\n\t{\n\t\t.compatible = \"nxp,pca9450c\",\n\t\t.data = (void *)PCA9450_TYPE_PCA9450BC,\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, pca9450_of_match);\n\nstatic struct i2c_driver pca9450_i2c_driver = {\n\t.driver = {\n\t\t.name = \"nxp-pca9450\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = pca9450_of_match,\n\t},\n\t.probe = pca9450_i2c_probe,\n};\n\nmodule_i2c_driver(pca9450_i2c_driver);\n\nMODULE_AUTHOR(\"Robin Gong <yibin.gong@nxp.com>\");\nMODULE_DESCRIPTION(\"NXP PCA9450 Power Management IC driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}