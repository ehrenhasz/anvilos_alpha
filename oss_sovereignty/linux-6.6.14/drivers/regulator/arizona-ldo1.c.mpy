{
  "module_name": "arizona-ldo1.c",
  "hash_id": "c151abffd334ad9262b2ec2275734b7b30f6d4c96fe08631445c8555f8a00d8d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/arizona-ldo1.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/init.h>\n#include <linux/bitops.h>\n#include <linux/err.h>\n#include <linux/of.h>\n#include <linux/gpio/consumer.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/slab.h>\n\n#include <linux/regulator/arizona-ldo1.h>\n\n#include <linux/mfd/arizona/core.h>\n#include <linux/mfd/arizona/pdata.h>\n#include <linux/mfd/arizona/registers.h>\n\n#include <linux/mfd/madera/core.h>\n#include <linux/mfd/madera/pdata.h>\n#include <linux/mfd/madera/registers.h>\n\nstruct arizona_ldo1 {\n\tstruct regulator_dev *regulator;\n\tstruct regmap *regmap;\n\n\tstruct regulator_consumer_supply supply;\n\tstruct regulator_init_data init_data;\n\n\tstruct gpio_desc *ena_gpiod;\n};\n\nstatic int arizona_ldo1_hc_set_voltage_sel(struct regulator_dev *rdev,\n\t\t\t\t\t   unsigned sel)\n{\n\tstruct regmap *regmap = rdev_get_regmap(rdev);\n\tunsigned int val;\n\tint ret;\n\n\tif (sel == rdev->desc->n_voltages - 1)\n\t\tval = ARIZONA_LDO1_HI_PWR;\n\telse\n\t\tval = 0;\n\n\tret = regmap_update_bits(regmap, ARIZONA_LDO1_CONTROL_2,\n\t\t\t\t ARIZONA_LDO1_HI_PWR, val);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tif (val)\n\t\treturn 0;\n\n\treturn regulator_set_voltage_sel_regmap(rdev, sel);\n}\n\nstatic int arizona_ldo1_hc_get_voltage_sel(struct regulator_dev *rdev)\n{\n\tstruct regmap *regmap = rdev_get_regmap(rdev);\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(regmap, ARIZONA_LDO1_CONTROL_2, &val);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tif (val & ARIZONA_LDO1_HI_PWR)\n\t\treturn rdev->desc->n_voltages - 1;\n\n\treturn regulator_get_voltage_sel_regmap(rdev);\n}\n\nstatic const struct regulator_ops arizona_ldo1_hc_ops = {\n\t.list_voltage = regulator_list_voltage_linear_range,\n\t.map_voltage = regulator_map_voltage_linear_range,\n\t.get_voltage_sel = arizona_ldo1_hc_get_voltage_sel,\n\t.set_voltage_sel = arizona_ldo1_hc_set_voltage_sel,\n\t.get_bypass = regulator_get_bypass_regmap,\n\t.set_bypass = regulator_set_bypass_regmap,\n};\n\nstatic const struct linear_range arizona_ldo1_hc_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(900000, 0, 0x6, 50000),\n\tREGULATOR_LINEAR_RANGE(1800000, 0x7, 0x7, 0),\n};\n\nstatic const struct regulator_desc arizona_ldo1_hc = {\n\t.name = \"LDO1\",\n\t.supply_name = \"LDOVDD\",\n\t.type = REGULATOR_VOLTAGE,\n\t.ops = &arizona_ldo1_hc_ops,\n\n\t.vsel_reg = ARIZONA_LDO1_CONTROL_1,\n\t.vsel_mask = ARIZONA_LDO1_VSEL_MASK,\n\t.bypass_reg = ARIZONA_LDO1_CONTROL_1,\n\t.bypass_mask = ARIZONA_LDO1_BYPASS,\n\t.linear_ranges = arizona_ldo1_hc_ranges,\n\t.n_linear_ranges = ARRAY_SIZE(arizona_ldo1_hc_ranges),\n\t.n_voltages = 8,\n\t.enable_time = 1500,\n\t.ramp_delay = 24000,\n\n\t.owner = THIS_MODULE,\n};\n\nstatic const struct regulator_ops arizona_ldo1_ops = {\n\t.list_voltage = regulator_list_voltage_linear,\n\t.map_voltage = regulator_map_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n};\n\nstatic const struct regulator_desc arizona_ldo1 = {\n\t.name = \"LDO1\",\n\t.supply_name = \"LDOVDD\",\n\t.type = REGULATOR_VOLTAGE,\n\t.ops = &arizona_ldo1_ops,\n\n\t.vsel_reg = ARIZONA_LDO1_CONTROL_1,\n\t.vsel_mask = ARIZONA_LDO1_VSEL_MASK,\n\t.min_uV = 900000,\n\t.uV_step = 25000,\n\t.n_voltages = 13,\n\t.enable_time = 500,\n\t.ramp_delay = 24000,\n\n\t.owner = THIS_MODULE,\n};\n\nstatic const struct regulator_init_data arizona_ldo1_dvfs = {\n\t.constraints = {\n\t\t.min_uV = 1200000,\n\t\t.max_uV = 1800000,\n\t\t.valid_ops_mask = REGULATOR_CHANGE_STATUS |\n\t\t\t\t  REGULATOR_CHANGE_VOLTAGE,\n\t},\n\t.num_consumer_supplies = 1,\n};\n\nstatic const struct regulator_init_data arizona_ldo1_default = {\n\t.constraints = {\n\t\t.valid_ops_mask = REGULATOR_CHANGE_STATUS,\n\t},\n\t.num_consumer_supplies = 1,\n};\n\nstatic const struct regulator_init_data arizona_ldo1_wm5110 = {\n\t.constraints = {\n\t\t.min_uV = 1175000,\n\t\t.max_uV = 1200000,\n\t\t.valid_ops_mask = REGULATOR_CHANGE_STATUS |\n\t\t\t\t  REGULATOR_CHANGE_VOLTAGE,\n\t},\n\t.num_consumer_supplies = 1,\n};\n\nstatic const struct regulator_desc madera_ldo1 = {\n\t.name = \"LDO1\",\n\t.supply_name = \"LDOVDD\",\n\t.type = REGULATOR_VOLTAGE,\n\t.ops = &arizona_ldo1_ops,\n\n\t.vsel_reg = MADERA_LDO1_CONTROL_1,\n\t.vsel_mask = MADERA_LDO1_VSEL_MASK,\n\t.min_uV = 900000,\n\t.uV_step = 25000,\n\t.n_voltages = 13,\n\t.enable_time = 3000,\n\n\t.owner = THIS_MODULE,\n};\n\nstatic const struct regulator_init_data madera_ldo1_default = {\n\t.constraints = {\n\t\t.min_uV = 1200000,\n\t\t.max_uV = 1200000,\n\t\t.valid_ops_mask = REGULATOR_CHANGE_STATUS,\n\t},\n\t.num_consumer_supplies = 1,\n};\n\nstatic int arizona_ldo1_of_get_pdata(struct arizona_ldo1_pdata *pdata,\n\t\t\t\t     struct regulator_config *config,\n\t\t\t\t     const struct regulator_desc *desc,\n\t\t\t\t     bool *external_dcvdd)\n{\n\tstruct arizona_ldo1 *ldo1 = config->driver_data;\n\tstruct device_node *np = config->dev->of_node;\n\tstruct device_node *init_node, *dcvdd_node;\n\tstruct regulator_init_data *init_data;\n\n\tinit_node = of_get_child_by_name(np, \"ldo1\");\n\tdcvdd_node = of_parse_phandle(np, \"DCVDD-supply\", 0);\n\n\tif (init_node) {\n\t\tconfig->of_node = init_node;\n\n\t\tinit_data = of_get_regulator_init_data(config->dev, init_node,\n\t\t\t\t\t\t       desc);\n\t\tif (init_data) {\n\t\t\tinit_data->consumer_supplies = &ldo1->supply;\n\t\t\tinit_data->num_consumer_supplies = 1;\n\n\t\t\tif (dcvdd_node && dcvdd_node != init_node)\n\t\t\t\t*external_dcvdd = true;\n\n\t\t\tpdata->init_data = init_data;\n\t\t}\n\t} else if (dcvdd_node) {\n\t\t*external_dcvdd = true;\n\t}\n\n\tof_node_put(dcvdd_node);\n\n\treturn 0;\n}\n\nstatic int arizona_ldo1_common_init(struct platform_device *pdev,\n\t\t\t\t    struct arizona_ldo1 *ldo1,\n\t\t\t\t    const struct regulator_desc *desc,\n\t\t\t\t    struct arizona_ldo1_pdata *pdata,\n\t\t\t\t    bool *external_dcvdd)\n{\n\tstruct device *parent_dev = pdev->dev.parent;\n\tstruct regulator_config config = { };\n\tint ret;\n\n\t*external_dcvdd = false;\n\n\tldo1->supply.supply = \"DCVDD\";\n\tldo1->init_data.consumer_supplies = &ldo1->supply;\n\tldo1->supply.dev_name = dev_name(parent_dev);\n\n\tconfig.dev = parent_dev;\n\tconfig.driver_data = ldo1;\n\tconfig.regmap = ldo1->regmap;\n\n\tif (IS_ENABLED(CONFIG_OF)) {\n\t\tif (!dev_get_platdata(parent_dev)) {\n\t\t\tret = arizona_ldo1_of_get_pdata(pdata,\n\t\t\t\t\t\t\t&config, desc,\n\t\t\t\t\t\t\texternal_dcvdd);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tconfig.ena_gpiod = gpiod_get_optional(parent_dev, \"wlf,ldoena\",\n\t\t\t\tGPIOD_OUT_LOW | GPIOD_FLAGS_BIT_NONEXCLUSIVE);\n\tif (IS_ERR(config.ena_gpiod))\n\t\treturn PTR_ERR(config.ena_gpiod);\n\n\tldo1->ena_gpiod = config.ena_gpiod;\n\n\tif (pdata->init_data)\n\t\tconfig.init_data = pdata->init_data;\n\telse\n\t\tconfig.init_data = &ldo1->init_data;\n\n\t \n\tif (config.init_data->num_consumer_supplies == 0)\n\t\t*external_dcvdd = true;\n\n\tldo1->regulator = devm_regulator_register(&pdev->dev, desc, &config);\n\n\tof_node_put(config.of_node);\n\n\tif (IS_ERR(ldo1->regulator)) {\n\t\tret = PTR_ERR(ldo1->regulator);\n\t\tdev_err(&pdev->dev, \"Failed to register LDO1 supply: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, ldo1);\n\n\treturn 0;\n}\n\nstatic int arizona_ldo1_probe(struct platform_device *pdev)\n{\n\tstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\n\tstruct arizona_ldo1 *ldo1;\n\tconst struct regulator_desc *desc;\n\tbool external_dcvdd;\n\tint ret;\n\n\tldo1 = devm_kzalloc(&pdev->dev, sizeof(*ldo1), GFP_KERNEL);\n\tif (!ldo1)\n\t\treturn -ENOMEM;\n\n\tldo1->regmap = arizona->regmap;\n\n\t \n\tswitch (arizona->type) {\n\tcase WM5102:\n\tcase WM8997:\n\tcase WM8998:\n\tcase WM1814:\n\t\tdesc = &arizona_ldo1_hc;\n\t\tldo1->init_data = arizona_ldo1_dvfs;\n\t\tbreak;\n\tcase WM5110:\n\tcase WM8280:\n\t\tdesc = &arizona_ldo1;\n\t\tldo1->init_data = arizona_ldo1_wm5110;\n\t\tbreak;\n\tdefault:\n\t\tdesc = &arizona_ldo1;\n\t\tldo1->init_data = arizona_ldo1_default;\n\t\tbreak;\n\t}\n\n\tret = arizona_ldo1_common_init(pdev, ldo1, desc,\n\t\t\t\t       &arizona->pdata.ldo1,\n\t\t\t\t       &external_dcvdd);\n\tif (ret == 0)\n\t\tarizona->external_dcvdd = external_dcvdd;\n\n\treturn ret;\n}\n\nstatic int arizona_ldo1_remove(struct platform_device *pdev)\n{\n\tstruct arizona_ldo1 *ldo1 = platform_get_drvdata(pdev);\n\n\tif (ldo1->ena_gpiod)\n\t\tgpiod_put(ldo1->ena_gpiod);\n\n\treturn 0;\n}\n\nstatic int madera_ldo1_probe(struct platform_device *pdev)\n{\n\tstruct madera *madera = dev_get_drvdata(pdev->dev.parent);\n\tstruct arizona_ldo1 *ldo1;\n\tbool external_dcvdd;\n\tint ret;\n\n\tldo1 = devm_kzalloc(&pdev->dev, sizeof(*ldo1), GFP_KERNEL);\n\tif (!ldo1)\n\t\treturn -ENOMEM;\n\n\tldo1->regmap = madera->regmap;\n\n\tldo1->init_data = madera_ldo1_default;\n\n\tret = arizona_ldo1_common_init(pdev, ldo1, &madera_ldo1,\n\t\t\t\t       &madera->pdata.ldo1,\n\t\t\t\t       &external_dcvdd);\n\tif (ret)\n\t\treturn ret;\n\n\tmadera->internal_dcvdd = !external_dcvdd;\n\n\treturn 0;\n}\n\nstatic struct platform_driver arizona_ldo1_driver = {\n\t.probe = arizona_ldo1_probe,\n\t.remove = arizona_ldo1_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"arizona-ldo1\",\n\t\t.probe_type = PROBE_FORCE_SYNCHRONOUS,\n\t},\n};\n\nstatic struct platform_driver madera_ldo1_driver = {\n\t.probe = madera_ldo1_probe,\n\t.remove = arizona_ldo1_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"madera-ldo1\",\n\t\t.probe_type = PROBE_FORCE_SYNCHRONOUS,\n\t},\n};\n\nstatic struct platform_driver * const madera_ldo1_drivers[] = {\n\t&arizona_ldo1_driver,\n\t&madera_ldo1_driver,\n};\n\nstatic int __init arizona_ldo1_init(void)\n{\n\treturn platform_register_drivers(madera_ldo1_drivers,\n\t\t\t\t\t ARRAY_SIZE(madera_ldo1_drivers));\n}\nmodule_init(arizona_ldo1_init);\n\nstatic void __exit madera_ldo1_exit(void)\n{\n\tplatform_unregister_drivers(madera_ldo1_drivers,\n\t\t\t\t    ARRAY_SIZE(madera_ldo1_drivers));\n}\nmodule_exit(madera_ldo1_exit);\n\n \nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_DESCRIPTION(\"Arizona LDO1 driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:arizona-ldo1\");\nMODULE_ALIAS(\"platform:madera-ldo1\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}