{
  "module_name": "bd9571mwv-regulator.c",
  "hash_id": "f62bbceaaf26a6259700e9f462be1201e40b8ee19ceb5f593ed137be06ff9760",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/bd9571mwv-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/rohm-generic.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n\n#include <linux/mfd/bd9571mwv.h>\n\nstruct bd9571mwv_reg {\n\tstruct regmap *regmap;\n\n\t \n\tu8 bkup_mode_cnt_keepon;\t \n\tu8 bkup_mode_cnt_saved;\n\tbool bkup_mode_enabled;\n\n\t \n\tbool rstbmode_level;\n\tbool rstbmode_pulse;\n};\n\nenum bd9571mwv_regulators { VD09, VD18, VD25, VD33, DVFS };\n\n#define BD9571MWV_REG(_name, _of, _id, _ops, _vr, _vm, _nv, _min, _step, _lmin)\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.name\t\t\t= _name,\t\t\\\n\t\t.of_match\t\t= of_match_ptr(_of),\t\\\n\t\t.regulators_node\t= \"regulators\",\t\t\\\n\t\t.id\t\t\t= _id,\t\t\t\\\n\t\t.ops\t\t\t= &_ops,\t\t\\\n\t\t.n_voltages\t\t= _nv,\t\t\t\\\n\t\t.type\t\t\t= REGULATOR_VOLTAGE,\t\\\n\t\t.owner\t\t\t= THIS_MODULE,\t\t\\\n\t\t.vsel_reg\t\t= _vr,\t\t\t\\\n\t\t.vsel_mask\t\t= _vm,\t\t\t\\\n\t\t.min_uV\t\t\t= _min,\t\t\t\\\n\t\t.uV_step\t\t= _step,\t\t\\\n\t\t.linear_min_sel\t\t= _lmin,\t\t\\\n\t}\n\nstatic int bd9571mwv_avs_get_moni_state(struct regulator_dev *rdev)\n{\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(rdev->regmap, BD9571MWV_AVS_SET_MONI, &val);\n\tif (ret != 0)\n\t\treturn ret;\n\n\treturn val & BD9571MWV_AVS_SET_MONI_MASK;\n}\n\nstatic int bd9571mwv_avs_set_voltage_sel_regmap(struct regulator_dev *rdev,\n\t\t\t\t\t\tunsigned int sel)\n{\n\tint ret;\n\n\tret = bd9571mwv_avs_get_moni_state(rdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn regmap_write_bits(rdev->regmap, BD9571MWV_AVS_VD09_VID(ret),\n\t\t\t\t rdev->desc->vsel_mask, sel);\n}\n\nstatic int bd9571mwv_avs_get_voltage_sel_regmap(struct regulator_dev *rdev)\n{\n\tunsigned int val;\n\tint ret;\n\n\tret = bd9571mwv_avs_get_moni_state(rdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(rdev->regmap, BD9571MWV_AVS_VD09_VID(ret), &val);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tval &= rdev->desc->vsel_mask;\n\tval >>= ffs(rdev->desc->vsel_mask) - 1;\n\n\treturn val;\n}\n\nstatic int bd9571mwv_reg_set_voltage_sel_regmap(struct regulator_dev *rdev,\n\t\t\t\t\t\tunsigned int sel)\n{\n\treturn regmap_write_bits(rdev->regmap, BD9571MWV_DVFS_SETVID,\n\t\t\t\t rdev->desc->vsel_mask, sel);\n}\n\n \nstatic const struct regulator_ops avs_ops = {\n\t.set_voltage_sel\t= bd9571mwv_avs_set_voltage_sel_regmap,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= bd9571mwv_avs_get_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n};\n\n \nstatic const struct regulator_ops reg_ops = {\n\t.set_voltage_sel\t= bd9571mwv_reg_set_voltage_sel_regmap,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n};\n\n \nstatic const struct regulator_ops vid_ops = {\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n};\n\nstatic const struct regulator_desc regulators[] = {\n\tBD9571MWV_REG(\"VD09\", \"vd09\", VD09, avs_ops, 0, 0x7f,\n\t\t      0x6f, 600000, 10000, 0x3c),\n\tBD9571MWV_REG(\"VD18\", \"vd18\", VD18, vid_ops, BD9571MWV_VD18_VID, 0xf,\n\t\t      16, 1625000, 25000, 0),\n\tBD9571MWV_REG(\"VD25\", \"vd25\", VD25, vid_ops, BD9571MWV_VD25_VID, 0xf,\n\t\t      16, 2150000, 50000, 0),\n\tBD9571MWV_REG(\"VD33\", \"vd33\", VD33, vid_ops, BD9571MWV_VD33_VID, 0xf,\n\t\t      11, 2800000, 100000, 0),\n\tBD9571MWV_REG(\"DVFS\", \"dvfs\", DVFS, reg_ops,\n\t\t      BD9571MWV_DVFS_MONIVDAC, 0x7f,\n\t\t      0x6f, 600000, 10000, 0x3c),\n};\n\n#ifdef CONFIG_PM_SLEEP\nstatic int bd9571mwv_bkup_mode_read(struct bd9571mwv_reg *bdreg,\n\t\t\t\t    unsigned int *mode)\n{\n\tint ret;\n\n\tret = regmap_read(bdreg->regmap, BD9571MWV_BKUP_MODE_CNT, mode);\n\tif (ret) {\n\t\tdev_err(regmap_get_device(bdreg->regmap),\n\t\t\t\"failed to read backup mode (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int bd9571mwv_bkup_mode_write(struct bd9571mwv_reg *bdreg,\n\t\t\t\t     unsigned int mode)\n{\n\tint ret;\n\n\tret = regmap_write(bdreg->regmap, BD9571MWV_BKUP_MODE_CNT, mode);\n\tif (ret) {\n\t\tdev_err(regmap_get_device(bdreg->regmap),\n\t\t\t\"failed to configure backup mode 0x%x (%d)\\n\",\n\t\t\tmode, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic ssize_t backup_mode_show(struct device *dev,\n\t\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct bd9571mwv_reg *bdreg = dev_get_drvdata(dev);\n\n\treturn sysfs_emit(buf, \"%s\\n\", bdreg->bkup_mode_enabled ? \"on\" : \"off\");\n}\n\nstatic ssize_t backup_mode_store(struct device *dev,\n\t\t\t\t struct device_attribute *attr,\n\t\t\t\t const char *buf, size_t count)\n{\n\tstruct bd9571mwv_reg *bdreg = dev_get_drvdata(dev);\n\tunsigned int mode;\n\tint ret;\n\n\tif (!count)\n\t\treturn 0;\n\n\tret = kstrtobool(buf, &bdreg->bkup_mode_enabled);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!bdreg->rstbmode_level)\n\t\treturn count;\n\n\t \n\tret = bd9571mwv_bkup_mode_read(bdreg, &mode);\n\tif (ret)\n\t\treturn ret;\n\n\tmode &= ~BD9571MWV_BKUP_MODE_CNT_KEEPON_MASK;\n\tif (bdreg->bkup_mode_enabled)\n\t\tmode |= bdreg->bkup_mode_cnt_keepon;\n\n\tret = bd9571mwv_bkup_mode_write(bdreg, mode);\n\tif (ret)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic DEVICE_ATTR_RW(backup_mode);\n\nstatic int bd9571mwv_suspend(struct device *dev)\n{\n\tstruct bd9571mwv_reg *bdreg = dev_get_drvdata(dev);\n\tunsigned int mode;\n\tint ret;\n\n\tif (!bdreg->bkup_mode_enabled)\n\t\treturn 0;\n\n\t \n\tret = bd9571mwv_bkup_mode_read(bdreg, &mode);\n\tif (ret)\n\t\treturn ret;\n\n\tbdreg->bkup_mode_cnt_saved = mode;\n\n\tif (!bdreg->rstbmode_pulse)\n\t\treturn 0;\n\n\t \n\tmode &= ~BD9571MWV_BKUP_MODE_CNT_KEEPON_MASK;\n\tmode |= bdreg->bkup_mode_cnt_keepon;\n\n\tif (mode != bdreg->bkup_mode_cnt_saved)\n\t\treturn bd9571mwv_bkup_mode_write(bdreg, mode);\n\n\treturn 0;\n}\n\nstatic int bd9571mwv_resume(struct device *dev)\n{\n\tstruct bd9571mwv_reg *bdreg = dev_get_drvdata(dev);\n\n\tif (!bdreg->bkup_mode_enabled)\n\t\treturn 0;\n\n\t \n\treturn bd9571mwv_bkup_mode_write(bdreg, bdreg->bkup_mode_cnt_saved);\n}\n\nstatic const struct dev_pm_ops bd9571mwv_pm  = {\n\tSET_SYSTEM_SLEEP_PM_OPS(bd9571mwv_suspend, bd9571mwv_resume)\n};\n\nstatic int bd9571mwv_regulator_remove(struct platform_device *pdev)\n{\n\tdevice_remove_file(&pdev->dev, &dev_attr_backup_mode);\n\treturn 0;\n}\n#define DEV_PM_OPS\t&bd9571mwv_pm\n#else\n#define DEV_PM_OPS\tNULL\n#define bd9571mwv_regulator_remove\tNULL\n#endif  \n\nstatic int bd9571mwv_regulator_probe(struct platform_device *pdev)\n{\n\tstruct regulator_config config = { };\n\tstruct bd9571mwv_reg *bdreg;\n\tstruct regulator_dev *rdev;\n\tunsigned int val;\n\tint i;\n\tenum rohm_chip_type chip = platform_get_device_id(pdev)->driver_data;\n\n\tbdreg = devm_kzalloc(&pdev->dev, sizeof(*bdreg), GFP_KERNEL);\n\tif (!bdreg)\n\t\treturn -ENOMEM;\n\n\tbdreg->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\n\tplatform_set_drvdata(pdev, bdreg);\n\n\tconfig.dev = &pdev->dev;\n\tconfig.dev->of_node = pdev->dev.parent->of_node;\n\tconfig.driver_data = bdreg;\n\tconfig.regmap = bdreg->regmap;\n\n\tfor (i = 0; i < ARRAY_SIZE(regulators); i++) {\n\t\t \n\t\tif (chip == ROHM_CHIP_TYPE_BD9574 && regulators[i].id != DVFS)\n\t\t\tcontinue;\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[i],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(&pdev->dev, \"failed to register %s regulator\\n\",\n\t\t\t\tregulators[i].name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\tval = 0;\n\tof_property_read_u32(config.dev->of_node, \"rohm,ddr-backup-power\", &val);\n\tif (val & ~BD9571MWV_BKUP_MODE_CNT_KEEPON_MASK) {\n\t\tdev_err(&pdev->dev, \"invalid %s mode %u\\n\",\n\t\t\t\"rohm,ddr-backup-power\", val);\n\t\treturn -EINVAL;\n\t}\n\tbdreg->bkup_mode_cnt_keepon = val;\n\n\tbdreg->rstbmode_level = of_property_read_bool(config.dev->of_node,\n\t\t\t\t\t\t      \"rohm,rstbmode-level\");\n\tbdreg->rstbmode_pulse = of_property_read_bool(config.dev->of_node,\n\t\t\t\t\t\t      \"rohm,rstbmode-pulse\");\n\tif (bdreg->rstbmode_level && bdreg->rstbmode_pulse) {\n\t\tdev_err(&pdev->dev, \"only one rohm,rstbmode-* may be specified\");\n\t\treturn -EINVAL;\n\t}\n\n#ifdef CONFIG_PM_SLEEP\n\tif (bdreg->bkup_mode_cnt_keepon) {\n\t\tint ret;\n\n\t\t \n\t\tbdreg->bkup_mode_enabled = bdreg->rstbmode_pulse;\n\n\t\tret = device_create_file(&pdev->dev, &dev_attr_backup_mode);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n#endif  \n\n\treturn 0;\n}\n\nstatic const struct platform_device_id bd9571mwv_regulator_id_table[] = {\n\t{ \"bd9571mwv-regulator\", ROHM_CHIP_TYPE_BD9571 },\n\t{ \"bd9574mwf-regulator\", ROHM_CHIP_TYPE_BD9574 },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, bd9571mwv_regulator_id_table);\n\nstatic struct platform_driver bd9571mwv_regulator_driver = {\n\t.driver = {\n\t\t.name = \"bd9571mwv-regulator\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.pm = DEV_PM_OPS,\n\t},\n\t.probe = bd9571mwv_regulator_probe,\n\t.remove = bd9571mwv_regulator_remove,\n\t.id_table = bd9571mwv_regulator_id_table,\n};\nmodule_platform_driver(bd9571mwv_regulator_driver);\n\nMODULE_AUTHOR(\"Marek Vasut <marek.vasut+renesas@gmail.com>\");\nMODULE_DESCRIPTION(\"BD9571MWV Regulator driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}