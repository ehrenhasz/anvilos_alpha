{
  "module_name": "max77826-regulator.c",
  "hash_id": "0db62b9ca0a51b5b77316af4a99e348b69819ddb2a2a3250f04dfa53f9b582ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max77826-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/of_regulator.h>\n#include <linux/i2c.h>\n#include <linux/regmap.h>\n\nenum max77826_registers {\n\tMAX77826_REG_INT_SRC = 0x00,\n\tMAX77826_REG_SYS_INT,\n\tMAX77826_REG_INT1,\n\tMAX77826_REG_INT2,\n\tMAX77826_REG_BB_INT,\n\tMAX77826_REG_INT_SRC_M,\n\tMAX77826_REG_TOPSYS_INT_M,\n\tMAX77826_REG_INT1_M,\n\tMAX77826_REG_INT2_M,\n\tMAX77826_REG_BB_INT_M,\n\tMAX77826_REG_TOPSYS_STAT,\n\tMAX77826_REG_STAT1,\n\tMAX77826_REG_STAT2,\n\tMAX77826_REG_BB_STAT,\n\t \n\tMAX77826_REG_LDO_OPMD1 = 0x10,\n\tMAX77826_REG_LDO_OPMD2,\n\tMAX77826_REG_LDO_OPMD3,\n\tMAX77826_REG_LDO_OPMD4,\n\tMAX77826_REG_B_BB_OPMD,\n\t \n\tMAX77826_REG_LDO1_CFG = 0x20,\n\tMAX77826_REG_LDO2_CFG,\n\tMAX77826_REG_LDO3_CFG,\n\tMAX77826_REG_LDO4_CFG,\n\tMAX77826_REG_LDO5_CFG,\n\tMAX77826_REG_LDO6_CFG,\n\tMAX77826_REG_LDO7_CFG,\n\tMAX77826_REG_LDO8_CFG,\n\tMAX77826_REG_LDO9_CFG,\n\tMAX77826_REG_LDO10_CFG,\n\tMAX77826_REG_LDO11_CFG,\n\tMAX77826_REG_LDO12_CFG,\n\tMAX77826_REG_LDO13_CFG,\n\tMAX77826_REG_LDO14_CFG,\n\tMAX77826_REG_LDO15_CFG,\n\t \n\tMAX77826_REG_BUCK_CFG = 0x30,\n\tMAX77826_REG_BUCK_VOUT,\n\tMAX77826_REG_BB_CFG,\n\tMAX77826_REG_BB_VOUT,\n\t \n\tMAX77826_REG_BUCK_SS_FREQ = 0x40,\n\tMAX77826_REG_UVLO_FALL,\n\t \n\tMAX77826_REG_DEVICE_ID = 0xCF,\n};\n\nenum max77826_regulators {\n\tMAX77826_LDO1 = 0,\n\tMAX77826_LDO2,\n\tMAX77826_LDO3,\n\tMAX77826_LDO4,\n\tMAX77826_LDO5,\n\tMAX77826_LDO6,\n\tMAX77826_LDO7,\n\tMAX77826_LDO8,\n\tMAX77826_LDO9,\n\tMAX77826_LDO10,\n\tMAX77826_LDO11,\n\tMAX77826_LDO12,\n\tMAX77826_LDO13,\n\tMAX77826_LDO14,\n\tMAX77826_LDO15,\n\tMAX77826_BUCK,\n\tMAX77826_BUCKBOOST,\n\tMAX77826_MAX_REGULATORS,\n};\n\n#define MAX77826_MASK_LDO\t\t0x7f\n#define MAX77826_MASK_BUCK\t\t0xff\n#define MAX77826_MASK_BUCKBOOST\t\t0x7f\n#define MAX77826_BUCK_RAMP_DELAY\t12500\n\n \n \n#define MAX77826_NMOS_LDO_VOLT_MIN\t600000\n#define MAX77826_NMOS_LDO_VOLT_MAX\t2187500\n#define MAX77826_NMOS_LDO_VOLT_STEP\t12500\n\n \n#define MAX77826_PMOS_LDO_VOLT_MIN\t800000\n#define MAX77826_PMOS_LDO_VOLT_MAX\t3975000\n#define MAX77826_PMOS_LDO_VOLT_STEP\t25000\n\n \n#define MAX77826_BUCK_VOLT_MIN\t\t500000\n#define MAX77826_BUCK_VOLT_MAX\t\t1800000\n#define MAX77826_BUCK_VOLT_STEP\t\t6250\n\n \n#define MAX77826_BUCKBOOST_VOLT_MIN\t2600000\n#define MAX77826_BUCKBOOST_VOLT_MAX\t4187500\n#define MAX77826_BUCKBOOST_VOLT_STEP\t12500\n#define MAX77826_VOLT_RANGE(_type)\t\t\t\t\t\\\n\t((MAX77826_ ## _type ## _VOLT_MAX -\t\t\t\t\\\n\t  MAX77826_ ## _type ## _VOLT_MIN) /\t\t\t\t\\\n\t MAX77826_ ## _type ## _VOLT_STEP + 1)\n\n#define MAX77826_LDO(_id, _type)\t\t\t\t\t\\\n\t[MAX77826_LDO ## _id] = {\t\t\t\t\t\\\n\t\t.id = MAX77826_LDO ## _id,\t\t\t\t\\\n\t\t.name = \"LDO\"#_id,\t\t\t\t\t\\\n\t\t.of_match = of_match_ptr(\"LDO\"#_id),\t\t\t\\\n\t\t.regulators_node = \"regulators\",\t\t\t\\\n\t\t.ops = &max77826_most_ops,\t\t\t\t\\\n\t\t.min_uV = MAX77826_ ## _type ## _LDO_VOLT_MIN,\t\t\\\n\t\t.uV_step = MAX77826_ ## _type ## _LDO_VOLT_STEP,\t\\\n\t\t.n_voltages = MAX77826_VOLT_RANGE(_type ## _LDO),\t\\\n\t\t.enable_reg = MAX77826_REG_LDO_OPMD1 + (_id - 1) / 4,\t\\\n\t\t.enable_mask = BIT(((_id - 1) % 4) * 2 + 1),\t\t\\\n\t\t.vsel_reg = MAX77826_REG_LDO1_CFG + (_id - 1),\t\t\\\n\t\t.vsel_mask = MAX77826_MASK_LDO,\t\t\t\t\\\n\t\t.owner = THIS_MODULE,\t\t\t\t\t\\\n\t}\n\n#define MAX77826_BUCK(_idx, _id, _ops)\t\t\t\t\t\\\n\t[MAX77826_ ## _id] = {\t\t\t\t\t\t\\\n\t\t.id = MAX77826_ ## _id,\t\t\t\t\t\\\n\t\t.name = #_id,\t\t\t\t\t\t\\\n\t\t.of_match = of_match_ptr(#_id),\t\t\t\t\\\n\t\t.regulators_node = \"regulators\",\t\t\t\\\n\t\t.ops = &_ops,\t\t\t\t\t\t\\\n\t\t.min_uV =  MAX77826_ ## _id ## _VOLT_MIN,\t\t\\\n\t\t.uV_step = MAX77826_ ## _id ## _VOLT_STEP,\t\t\\\n\t\t.n_voltages = MAX77826_VOLT_RANGE(_id),\t\t\t\\\n\t\t.enable_reg = MAX77826_REG_B_BB_OPMD,\t\t\t\\\n\t\t.enable_mask = BIT(_idx * 2 + 1),\t\t\t\\\n\t\t.vsel_reg = MAX77826_REG_BUCK_VOUT + _idx * 2,\t\t\\\n\t\t.vsel_mask = MAX77826_MASK_ ## _id,\t\t\t\\\n\t\t.owner = THIS_MODULE,\t\t\t\t\t\\\n\t}\n\n\n\nstruct max77826_regulator_info {\n\tstruct regmap *regmap;\n\tstruct regulator_desc *rdesc;\n};\n\nstatic const struct regmap_config max77826_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = MAX77826_REG_DEVICE_ID,\n};\n\nstatic int max77826_set_voltage_time_sel(struct regulator_dev *,\n\t\t\t\tunsigned int old_selector,\n\t\t\t\tunsigned int new_selector);\n\nstatic const struct regulator_ops max77826_most_ops = {\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n};\n\nstatic const struct regulator_ops max77826_buck_ops = {\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.set_voltage_time_sel\t= max77826_set_voltage_time_sel,\n};\n\nstatic struct regulator_desc max77826_regulators_desc[] = {\n\tMAX77826_LDO(1, NMOS),\n\tMAX77826_LDO(2, NMOS),\n\tMAX77826_LDO(3, NMOS),\n\tMAX77826_LDO(4, PMOS),\n\tMAX77826_LDO(5, PMOS),\n\tMAX77826_LDO(6, PMOS),\n\tMAX77826_LDO(7, PMOS),\n\tMAX77826_LDO(8, PMOS),\n\tMAX77826_LDO(9, PMOS),\n\tMAX77826_LDO(10, PMOS),\n\tMAX77826_LDO(11, PMOS),\n\tMAX77826_LDO(12, PMOS),\n\tMAX77826_LDO(13, PMOS),\n\tMAX77826_LDO(14, PMOS),\n\tMAX77826_LDO(15, PMOS),\n\tMAX77826_BUCK(0, BUCK, max77826_buck_ops),\n\tMAX77826_BUCK(1, BUCKBOOST, max77826_most_ops),\n};\n\nstatic int max77826_set_voltage_time_sel(struct regulator_dev *rdev,\n\t\t\t\tunsigned int old_selector,\n\t\t\t\tunsigned int new_selector)\n{\n\tif (new_selector > old_selector) {\n\t\treturn DIV_ROUND_UP(MAX77826_BUCK_VOLT_STEP *\n\t\t\t\t(new_selector - old_selector),\n\t\t\t\tMAX77826_BUCK_RAMP_DELAY);\n\t}\n\n\treturn 0;\n}\n\nstatic int max77826_read_device_id(struct regmap *regmap, struct device *dev)\n{\n\tunsigned int device_id;\n\tint res;\n\n\tres = regmap_read(regmap, MAX77826_REG_DEVICE_ID, &device_id);\n\tif (!res)\n\t\tdev_dbg(dev, \"DEVICE_ID: 0x%x\\n\", device_id);\n\n\treturn res;\n}\n\nstatic int max77826_i2c_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tstruct max77826_regulator_info *info;\n\tstruct regulator_config config = {};\n\tstruct regulator_dev *rdev;\n\tstruct regmap *regmap;\n\tint i;\n\n\tinfo = devm_kzalloc(dev, sizeof(struct max77826_regulator_info),\n\t\t\t\tGFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->rdesc = max77826_regulators_desc;\n\tregmap = devm_regmap_init_i2c(client, &max77826_regmap_config);\n\tif (IS_ERR(regmap)) {\n\t\tdev_err(dev, \"Failed to allocate regmap!\\n\");\n\t\treturn PTR_ERR(regmap);\n\t}\n\n\tinfo->regmap = regmap;\n\ti2c_set_clientdata(client, info);\n\n\tconfig.dev = dev;\n\tconfig.regmap = regmap;\n\tconfig.driver_data = info;\n\n\tfor (i = 0; i < MAX77826_MAX_REGULATORS; i++) {\n\t\trdev = devm_regulator_register(dev,\n\t\t\t\t\t       &max77826_regulators_desc[i],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(dev, \"Failed to register regulator!\\n\");\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn max77826_read_device_id(regmap, dev);\n}\n\nstatic const struct of_device_id __maybe_unused max77826_of_match[] = {\n\t{ .compatible = \"maxim,max77826\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, max77826_of_match);\n\nstatic const struct i2c_device_id max77826_id[] = {\n\t{ \"max77826-regulator\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(i2c, max77826_id);\n\nstatic struct i2c_driver max77826_regulator_driver = {\n\t.driver = {\n\t\t.name = \"max77826\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = of_match_ptr(max77826_of_match),\n\t},\n\t.probe = max77826_i2c_probe,\n\t.id_table = max77826_id,\n};\nmodule_i2c_driver(max77826_regulator_driver);\n\nMODULE_AUTHOR(\"Iskren Chernev <iskren.chernev@gmail.com>\");\nMODULE_DESCRIPTION(\"MAX77826 PMIC regulator driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}