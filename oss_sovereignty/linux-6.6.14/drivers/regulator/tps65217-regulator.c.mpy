{
  "module_name": "tps65217-regulator.c",
  "hash_id": "0c1c686d7dc9ac18fc7c36f8c07e6b0d5edd52b94ab22b8e7c0e70bd1ef1e982",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/tps65217-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n\n#include <linux/regulator/of_regulator.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/mfd/tps65217.h>\n\n#define TPS65217_REGULATOR(_name, _id, _of_match, _ops, _n, _vr, _vm, _em, \\\n\t\t\t   _t, _lr, _nlr,  _sr, _sm)\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.name\t\t= _name,\t\t\\\n\t\t.id\t\t= _id,\t\t\t\\\n\t\t.of_match       = of_match_ptr(_of_match),    \\\n\t\t.regulators_node= of_match_ptr(\"regulators\"), \\\n\t\t.ops\t\t= &_ops,\t\t\\\n\t\t.n_voltages\t= _n,\t\t\t\\\n\t\t.type\t\t= REGULATOR_VOLTAGE,\t\\\n\t\t.owner\t\t= THIS_MODULE,\t\t\\\n\t\t.vsel_reg\t= _vr,\t\t\t\\\n\t\t.vsel_mask\t= _vm,\t\t\t\\\n\t\t.enable_reg\t= TPS65217_REG_ENABLE,\t\\\n\t\t.enable_mask\t= _em,\t\t\t\\\n\t\t.volt_table\t= _t,\t\t\t\\\n\t\t.linear_ranges\t= _lr,\t\t\t\\\n\t\t.n_linear_ranges = _nlr,\t\t\\\n\t\t.bypass_reg\t= _sr,\t\t\t\\\n\t\t.bypass_mask\t= _sm,\t\t\t\\\n\t}\t\t\t\t\t\t\\\n\nstatic const unsigned int LDO1_VSEL_table[] = {\n\t1000000, 1100000, 1200000, 1250000,\n\t1300000, 1350000, 1400000, 1500000,\n\t1600000, 1800000, 2500000, 2750000,\n\t2800000, 3000000, 3100000, 3300000,\n};\n\nstatic const struct linear_range tps65217_uv1_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(900000, 0, 24, 25000),\n\tREGULATOR_LINEAR_RANGE(1550000, 25, 52, 50000),\n\tREGULATOR_LINEAR_RANGE(3000000, 53, 55, 100000),\n\tREGULATOR_LINEAR_RANGE(3300000, 56, 63, 0),\n};\n\nstatic const struct linear_range tps65217_uv2_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(1500000, 0, 8, 50000),\n\tREGULATOR_LINEAR_RANGE(2000000, 9, 13, 100000),\n\tREGULATOR_LINEAR_RANGE(2450000, 14, 31, 50000),\n};\n\nstatic int tps65217_pmic_enable(struct regulator_dev *dev)\n{\n\tstruct tps65217 *tps = rdev_get_drvdata(dev);\n\tint rid = rdev_get_id(dev);\n\n\tif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\n\t\treturn -EINVAL;\n\n\t \n\treturn tps65217_set_bits(tps, TPS65217_REG_ENABLE,\n\t\t\t\t dev->desc->enable_mask, dev->desc->enable_mask,\n\t\t\t\t TPS65217_PROTECT_L1);\n}\n\nstatic int tps65217_pmic_disable(struct regulator_dev *dev)\n{\n\tstruct tps65217 *tps = rdev_get_drvdata(dev);\n\tint rid = rdev_get_id(dev);\n\n\tif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\n\t\treturn -EINVAL;\n\n\t \n\treturn tps65217_clear_bits(tps, TPS65217_REG_ENABLE,\n\t\t\t\t   dev->desc->enable_mask, TPS65217_PROTECT_L1);\n}\n\nstatic int tps65217_pmic_set_voltage_sel(struct regulator_dev *dev,\n\t\t\t\t\t unsigned selector)\n{\n\tint ret;\n\tstruct tps65217 *tps = rdev_get_drvdata(dev);\n\tunsigned int rid = rdev_get_id(dev);\n\n\t \n\tret = tps65217_set_bits(tps, dev->desc->vsel_reg, dev->desc->vsel_mask,\n\t\t\t\tselector, TPS65217_PROTECT_L2);\n\n\t \n\tswitch (rid) {\n\tcase TPS65217_DCDC_1 ... TPS65217_DCDC_3:\n\t\tret = tps65217_set_bits(tps, TPS65217_REG_DEFSLEW,\n\t\t\t\t       TPS65217_DEFSLEW_GO, TPS65217_DEFSLEW_GO,\n\t\t\t\t       TPS65217_PROTECT_L2);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic int tps65217_pmic_set_suspend_enable(struct regulator_dev *dev)\n{\n\tstruct tps65217 *tps = rdev_get_drvdata(dev);\n\tunsigned int rid = rdev_get_id(dev);\n\n\tif (rid > TPS65217_LDO_4)\n\t\treturn -EINVAL;\n\n\treturn tps65217_clear_bits(tps, dev->desc->bypass_reg,\n\t\t\t\t   dev->desc->bypass_mask,\n\t\t\t\t   TPS65217_PROTECT_L1);\n}\n\nstatic int tps65217_pmic_set_suspend_disable(struct regulator_dev *dev)\n{\n\tstruct tps65217 *tps = rdev_get_drvdata(dev);\n\tunsigned int rid = rdev_get_id(dev);\n\n\tif (rid > TPS65217_LDO_4)\n\t\treturn -EINVAL;\n\n\tif (!tps->strobes[rid])\n\t\treturn -EINVAL;\n\n\treturn tps65217_set_bits(tps, dev->desc->bypass_reg,\n\t\t\t\t dev->desc->bypass_mask,\n\t\t\t\t tps->strobes[rid], TPS65217_PROTECT_L1);\n}\n\n \nstatic const struct regulator_ops tps65217_pmic_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= tps65217_pmic_enable,\n\t.disable\t\t= tps65217_pmic_disable,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= tps65217_pmic_set_voltage_sel,\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n\t.set_suspend_enable\t= tps65217_pmic_set_suspend_enable,\n\t.set_suspend_disable\t= tps65217_pmic_set_suspend_disable,\n};\n\n \nstatic const struct regulator_ops tps65217_pmic_ldo1_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= tps65217_pmic_enable,\n\t.disable\t\t= tps65217_pmic_disable,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= tps65217_pmic_set_voltage_sel,\n\t.list_voltage\t\t= regulator_list_voltage_table,\n\t.map_voltage\t\t= regulator_map_voltage_ascend,\n\t.set_suspend_enable\t= tps65217_pmic_set_suspend_enable,\n\t.set_suspend_disable\t= tps65217_pmic_set_suspend_disable,\n};\n\nstatic const struct regulator_desc regulators[] = {\n\tTPS65217_REGULATOR(\"DCDC1\", TPS65217_DCDC_1, \"dcdc1\",\n\t\t\t   tps65217_pmic_ops, 64, TPS65217_REG_DEFDCDC1,\n\t\t\t   TPS65217_DEFDCDCX_DCDC_MASK, TPS65217_ENABLE_DC1_EN,\n\t\t\t   NULL, tps65217_uv1_ranges,\n\t\t\t   ARRAY_SIZE(tps65217_uv1_ranges), TPS65217_REG_SEQ1,\n\t\t\t   TPS65217_SEQ1_DC1_SEQ_MASK),\n\tTPS65217_REGULATOR(\"DCDC2\", TPS65217_DCDC_2, \"dcdc2\",\n\t\t\t   tps65217_pmic_ops, 64, TPS65217_REG_DEFDCDC2,\n\t\t\t   TPS65217_DEFDCDCX_DCDC_MASK, TPS65217_ENABLE_DC2_EN,\n\t\t\t   NULL, tps65217_uv1_ranges,\n\t\t\t   ARRAY_SIZE(tps65217_uv1_ranges), TPS65217_REG_SEQ1,\n\t\t\t   TPS65217_SEQ1_DC2_SEQ_MASK),\n\tTPS65217_REGULATOR(\"DCDC3\", TPS65217_DCDC_3, \"dcdc3\",\n\t\t\t   tps65217_pmic_ops, 64, TPS65217_REG_DEFDCDC3,\n\t\t\t   TPS65217_DEFDCDCX_DCDC_MASK, TPS65217_ENABLE_DC3_EN,\n\t\t\t   NULL, tps65217_uv1_ranges,\n\t\t\t   ARRAY_SIZE(tps65217_uv1_ranges), TPS65217_REG_SEQ2,\n\t\t\t   TPS65217_SEQ2_DC3_SEQ_MASK),\n\tTPS65217_REGULATOR(\"LDO1\", TPS65217_LDO_1, \"ldo1\",\n\t\t\t   tps65217_pmic_ldo1_ops, 16, TPS65217_REG_DEFLDO1,\n\t\t\t   TPS65217_DEFLDO1_LDO1_MASK, TPS65217_ENABLE_LDO1_EN,\n\t\t\t   LDO1_VSEL_table, NULL, 0, TPS65217_REG_SEQ2,\n\t\t\t   TPS65217_SEQ2_LDO1_SEQ_MASK),\n\tTPS65217_REGULATOR(\"LDO2\", TPS65217_LDO_2, \"ldo2\", tps65217_pmic_ops,\n\t\t\t   64, TPS65217_REG_DEFLDO2,\n\t\t\t   TPS65217_DEFLDO2_LDO2_MASK, TPS65217_ENABLE_LDO2_EN,\n\t\t\t   NULL, tps65217_uv1_ranges,\n\t\t\t   ARRAY_SIZE(tps65217_uv1_ranges), TPS65217_REG_SEQ3,\n\t\t\t   TPS65217_SEQ3_LDO2_SEQ_MASK),\n\tTPS65217_REGULATOR(\"LDO3\", TPS65217_LDO_3, \"ldo3\", tps65217_pmic_ops,\n\t\t\t   32, TPS65217_REG_DEFLS1, TPS65217_DEFLDO3_LDO3_MASK,\n\t\t\t   TPS65217_ENABLE_LS1_EN | TPS65217_DEFLDO3_LDO3_EN,\n\t\t\t   NULL, tps65217_uv2_ranges,\n\t\t\t   ARRAY_SIZE(tps65217_uv2_ranges), TPS65217_REG_SEQ3,\n\t\t\t   TPS65217_SEQ3_LDO3_SEQ_MASK),\n\tTPS65217_REGULATOR(\"LDO4\", TPS65217_LDO_4, \"ldo4\", tps65217_pmic_ops,\n\t\t\t   32, TPS65217_REG_DEFLS2, TPS65217_DEFLDO4_LDO4_MASK,\n\t\t\t   TPS65217_ENABLE_LS2_EN | TPS65217_DEFLDO4_LDO4_EN,\n\t\t\t   NULL, tps65217_uv2_ranges,\n\t\t\t   ARRAY_SIZE(tps65217_uv2_ranges), TPS65217_REG_SEQ4,\n\t\t\t   TPS65217_SEQ4_LDO4_SEQ_MASK),\n};\n\nstatic int tps65217_regulator_probe(struct platform_device *pdev)\n{\n\tstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct tps65217_board *pdata = dev_get_platdata(tps->dev);\n\tstruct regulator_dev *rdev;\n\tstruct regulator_config config = { };\n\tint i, ret;\n\tunsigned int val;\n\n\t \n\ttps->strobes = devm_kcalloc(&pdev->dev,\n\t\t\t\t    TPS65217_NUM_REGULATOR, sizeof(u8),\n\t\t\t\t    GFP_KERNEL);\n\tif (!tps->strobes)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, tps);\n\n\tfor (i = 0; i < TPS65217_NUM_REGULATOR; i++) {\n\t\t \n\t\tconfig.dev = tps->dev;\n\t\tif (pdata)\n\t\t\tconfig.init_data = pdata->tps65217_init_data[i];\n\t\tconfig.driver_data = tps;\n\t\tconfig.regmap = tps->regmap;\n\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[i],\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(tps->dev, \"failed to register %s regulator\\n\",\n\t\t\t\tpdev->name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\n\t\t \n\t\tret = tps65217_reg_read(tps, regulators[i].bypass_reg, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\ttps->strobes[i] = val & regulators[i].bypass_mask;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver tps65217_regulator_driver = {\n\t.driver = {\n\t\t.name = \"tps65217-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = tps65217_regulator_probe,\n};\n\nstatic int __init tps65217_regulator_init(void)\n{\n\treturn platform_driver_register(&tps65217_regulator_driver);\n}\nsubsys_initcall(tps65217_regulator_init);\n\nstatic void __exit tps65217_regulator_exit(void)\n{\n\tplatform_driver_unregister(&tps65217_regulator_driver);\n}\nmodule_exit(tps65217_regulator_exit);\n\nMODULE_AUTHOR(\"AnilKumar Ch <anilkumar@ti.com>\");\nMODULE_DESCRIPTION(\"TPS65217 voltage regulator driver\");\nMODULE_ALIAS(\"platform:tps65217-pmic\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}