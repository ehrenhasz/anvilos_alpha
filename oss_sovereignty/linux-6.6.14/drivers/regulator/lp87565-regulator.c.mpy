{
  "module_name": "lp87565-regulator.c",
  "hash_id": "36d2780146c5eac018fa7a0431d1b1403d57813fa44d30a88dfd0797a3623061",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/lp87565-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/lp87565.h>\n\nenum LP87565_regulator_id {\n\t \n\tLP87565_BUCK_0,\n\tLP87565_BUCK_1,\n\tLP87565_BUCK_2,\n\tLP87565_BUCK_3,\n\tLP87565_BUCK_10,\n\tLP87565_BUCK_23,\n\tLP87565_BUCK_3210,\n};\n\n#define LP87565_REGULATOR(_name, _id, _of, _ops, _n, _vr, _vm,\t\t\\\n\t\t\t  _er, _em, _ev, _delay, _lr, _cr)\t\t\\\n\t[_id] = {\t\t\t\t\t\t\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name\t\t\t= _name,\t\t\\\n\t\t\t.supply_name\t\t= _of \"-in\",\t\t\\\n\t\t\t.id\t\t\t= _id,\t\t\t\\\n\t\t\t.of_match\t\t= _of,\t\t\t\\\n\t\t\t.regulators_node\t= \"regulators\",\t\t\\\n\t\t\t.ops\t\t\t= &_ops,\t\t\\\n\t\t\t.n_voltages\t\t= _n,\t\t\t\\\n\t\t\t.type\t\t\t= REGULATOR_VOLTAGE,\t\\\n\t\t\t.owner\t\t\t= THIS_MODULE,\t\t\\\n\t\t\t.vsel_reg\t\t= _vr,\t\t\t\\\n\t\t\t.vsel_mask\t\t= _vm,\t\t\t\\\n\t\t\t.enable_reg\t\t= _er,\t\t\t\\\n\t\t\t.enable_mask\t\t= _em,\t\t\t\\\n\t\t\t.enable_val\t\t= _ev,\t\t\t\\\n\t\t\t.ramp_delay\t\t= _delay,\t\t\\\n\t\t\t.linear_ranges\t\t= _lr,\t\t\t\\\n\t\t\t.n_linear_ranges\t= ARRAY_SIZE(_lr),\t\\\n\t\t\t.curr_table = lp87565_buck_uA,\t\t\t\\\n\t\t\t.n_current_limits = ARRAY_SIZE(lp87565_buck_uA),\\\n\t\t\t.csel_reg = (_cr),\t\t\t\t\\\n\t\t\t.csel_mask = LP87565_BUCK_CTRL_2_ILIM,\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.ctrl2_reg = _cr,\t\t\t\t\t\\\n\t}\n\nstruct lp87565_regulator {\n\tstruct regulator_desc desc;\n\tunsigned int ctrl2_reg;\n};\n\nstatic const struct lp87565_regulator regulators[];\n\nstatic const struct linear_range buck0_1_2_3_ranges[] = {\n\tREGULATOR_LINEAR_RANGE(600000, 0xA, 0x17, 10000),\n\tREGULATOR_LINEAR_RANGE(735000, 0x18, 0x9d, 5000),\n\tREGULATOR_LINEAR_RANGE(1420000, 0x9e, 0xff, 20000),\n};\n\nstatic const unsigned int lp87565_buck_ramp_delay[] = {\n\t30000, 15000, 10000, 7500, 3800, 1900, 940, 470\n};\n\n \nstatic const unsigned int lp87565_buck_uA[] = {\n\t1500000, 2000000, 2500000, 3000000, 3500000, 4000000, 4500000, 5000000,\n};\n\nstatic int lp87565_buck_set_ramp_delay(struct regulator_dev *rdev,\n\t\t\t\t       int ramp_delay)\n{\n\tint id = rdev_get_id(rdev);\n\tunsigned int reg;\n\tint ret;\n\n\tif (ramp_delay <= 470)\n\t\treg = 7;\n\telse if (ramp_delay <= 940)\n\t\treg = 6;\n\telse if (ramp_delay <= 1900)\n\t\treg = 5;\n\telse if (ramp_delay <= 3800)\n\t\treg = 4;\n\telse if (ramp_delay <= 7500)\n\t\treg = 3;\n\telse if (ramp_delay <= 10000)\n\t\treg = 2;\n\telse if (ramp_delay <= 15000)\n\t\treg = 1;\n\telse\n\t\treg = 0;\n\n\tret = regmap_update_bits(rdev->regmap, regulators[id].ctrl2_reg,\n\t\t\t\t LP87565_BUCK_CTRL_2_SLEW_RATE,\n\t\t\t\t reg << __ffs(LP87565_BUCK_CTRL_2_SLEW_RATE));\n\tif (ret) {\n\t\tdev_err(&rdev->dev, \"SLEW RATE write failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trdev->constraints->ramp_delay = lp87565_buck_ramp_delay[reg];\n\n\t \n\trdev->constraints->ramp_delay =\n\t\t\t\trdev->constraints->ramp_delay * 85 / 100;\n\n\treturn 0;\n}\n\n \nstatic const struct regulator_ops lp87565_buck_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear_range,\n\t.map_voltage\t\t= regulator_map_voltage_linear_range,\n\t.set_voltage_time_sel\t= regulator_set_voltage_time_sel,\n\t.set_ramp_delay\t\t= lp87565_buck_set_ramp_delay,\n\t.set_current_limit\t= regulator_set_current_limit_regmap,\n\t.get_current_limit\t= regulator_get_current_limit_regmap,\n};\n\nstatic const struct lp87565_regulator regulators[] = {\n\tLP87565_REGULATOR(\"BUCK0\", LP87565_BUCK_0, \"buck0\", lp87565_buck_ops,\n\t\t\t  256, LP87565_REG_BUCK0_VOUT, LP87565_BUCK_VSET,\n\t\t\t  LP87565_REG_BUCK0_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL,\n\t\t\t  LP87565_BUCK_CTRL_1_EN, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK0_CTRL_2),\n\tLP87565_REGULATOR(\"BUCK1\", LP87565_BUCK_1, \"buck1\", lp87565_buck_ops,\n\t\t\t  256, LP87565_REG_BUCK1_VOUT, LP87565_BUCK_VSET,\n\t\t\t  LP87565_REG_BUCK1_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL,\n\t\t\t  LP87565_BUCK_CTRL_1_EN, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK1_CTRL_2),\n\tLP87565_REGULATOR(\"BUCK2\", LP87565_BUCK_2, \"buck2\", lp87565_buck_ops,\n\t\t\t  256, LP87565_REG_BUCK2_VOUT, LP87565_BUCK_VSET,\n\t\t\t  LP87565_REG_BUCK2_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL,\n\t\t\t  LP87565_BUCK_CTRL_1_EN, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK2_CTRL_2),\n\tLP87565_REGULATOR(\"BUCK3\", LP87565_BUCK_3, \"buck3\", lp87565_buck_ops,\n\t\t\t  256, LP87565_REG_BUCK3_VOUT, LP87565_BUCK_VSET,\n\t\t\t  LP87565_REG_BUCK3_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL,\n\t\t\t  LP87565_BUCK_CTRL_1_EN, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK3_CTRL_2),\n\tLP87565_REGULATOR(\"BUCK10\", LP87565_BUCK_10, \"buck10\", lp87565_buck_ops,\n\t\t\t  256, LP87565_REG_BUCK0_VOUT, LP87565_BUCK_VSET,\n\t\t\t  LP87565_REG_BUCK0_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL |\n\t\t\t  LP87565_BUCK_CTRL_1_FPWM_MP_0_2,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_FPWM_MP_0_2, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK0_CTRL_2),\n\tLP87565_REGULATOR(\"BUCK23\", LP87565_BUCK_23, \"buck23\", lp87565_buck_ops,\n\t\t\t  256, LP87565_REG_BUCK2_VOUT, LP87565_BUCK_VSET,\n\t\t\t  LP87565_REG_BUCK2_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL,\n\t\t\t  LP87565_BUCK_CTRL_1_EN, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK2_CTRL_2),\n\tLP87565_REGULATOR(\"BUCK3210\", LP87565_BUCK_3210, \"buck3210\",\n\t\t\t  lp87565_buck_ops, 256, LP87565_REG_BUCK0_VOUT,\n\t\t\t  LP87565_BUCK_VSET, LP87565_REG_BUCK0_CTRL_1,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_EN_PIN_CTRL |\n\t\t\t  LP87565_BUCK_CTRL_1_FPWM_MP_0_2,\n\t\t\t  LP87565_BUCK_CTRL_1_EN |\n\t\t\t  LP87565_BUCK_CTRL_1_FPWM_MP_0_2, 3230,\n\t\t\t  buck0_1_2_3_ranges, LP87565_REG_BUCK0_CTRL_2),\n};\n\nstatic int lp87565_regulator_probe(struct platform_device *pdev)\n{\n\tstruct lp87565 *lp87565 = dev_get_drvdata(pdev->dev.parent);\n\tstruct regulator_config config = { };\n\tstruct regulator_dev *rdev;\n\tint i, min_idx, max_idx;\n\n\tplatform_set_drvdata(pdev, lp87565);\n\n\tconfig.dev = &pdev->dev;\n\tconfig.dev->of_node = lp87565->dev->of_node;\n\tconfig.driver_data = lp87565;\n\tconfig.regmap = lp87565->regmap;\n\n\tswitch (lp87565->dev_type) {\n\tcase LP87565_DEVICE_TYPE_LP87565_Q1:\n\t\tmin_idx = LP87565_BUCK_10;\n\t\tmax_idx = LP87565_BUCK_23;\n\t\tbreak;\n\tcase LP87565_DEVICE_TYPE_LP87561_Q1:\n\t\tmin_idx = LP87565_BUCK_3210;\n\t\tmax_idx = LP87565_BUCK_3210;\n\t\tbreak;\n\tdefault:\n\t\tmin_idx = LP87565_BUCK_0;\n\t\tmax_idx = LP87565_BUCK_3;\n\t\tbreak;\n\t}\n\n\tfor (i = min_idx; i <= max_idx; i++) {\n\t\trdev = devm_regulator_register(&pdev->dev, &regulators[i].desc,\n\t\t\t\t\t       &config);\n\t\tif (IS_ERR(rdev)) {\n\t\t\tdev_err(lp87565->dev, \"failed to register %s regulator\\n\",\n\t\t\t\tpdev->name);\n\t\t\treturn PTR_ERR(rdev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id lp87565_regulator_id_table[] = {\n\t{ \"lp87565-regulator\", },\n\t{ \"lp87565-q1-regulator\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, lp87565_regulator_id_table);\n\nstatic struct platform_driver lp87565_regulator_driver = {\n\t.driver = {\n\t\t.name = \"lp87565-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe = lp87565_regulator_probe,\n\t.id_table = lp87565_regulator_id_table,\n};\nmodule_platform_driver(lp87565_regulator_driver);\n\nMODULE_AUTHOR(\"J Keerthy <j-keerthy@ti.com>\");\nMODULE_DESCRIPTION(\"LP87565 voltage regulator driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}