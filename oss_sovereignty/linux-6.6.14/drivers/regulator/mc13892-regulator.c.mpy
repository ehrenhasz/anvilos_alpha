{
  "module_name": "mc13892-regulator.c",
  "hash_id": "c0d515e196009fde61dca9b1bc1826ec04530ed16968e50b454ae8fb5ec71234",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/mc13892-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/mfd/mc13892.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/driver.h>\n#include <linux/platform_device.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/module.h>\n#include \"mc13xxx.h\"\n\n#define MC13892_REVISION\t\t\t7\n\n#define MC13892_POWERCTL0\t\t\t13\n#define MC13892_POWERCTL0_USEROFFSPI\t\t3\n#define MC13892_POWERCTL0_VCOINCELLVSEL\t\t20\n#define MC13892_POWERCTL0_VCOINCELLVSEL_M\t(7<<20)\n#define MC13892_POWERCTL0_VCOINCELLEN\t\t(1<<23)\n\n#define MC13892_SWITCHERS0_SWxHI\t\t(1<<23)\n\n#define MC13892_SWITCHERS0\t\t\t24\n#define MC13892_SWITCHERS0_SW1VSEL\t\t0\n#define MC13892_SWITCHERS0_SW1VSEL_M\t\t(0x1f<<0)\n#define MC13892_SWITCHERS0_SW1HI\t\t(1<<23)\n#define MC13892_SWITCHERS0_SW1EN\t\t0\n\n#define MC13892_SWITCHERS1\t\t\t25\n#define MC13892_SWITCHERS1_SW2VSEL\t\t0\n#define MC13892_SWITCHERS1_SW2VSEL_M\t\t(0x1f<<0)\n#define MC13892_SWITCHERS1_SW2HI\t\t(1<<23)\n#define MC13892_SWITCHERS1_SW2EN\t\t0\n\n#define MC13892_SWITCHERS2\t\t\t26\n#define MC13892_SWITCHERS2_SW3VSEL\t\t0\n#define MC13892_SWITCHERS2_SW3VSEL_M\t\t(0x1f<<0)\n#define MC13892_SWITCHERS2_SW3HI\t\t(1<<23)\n#define MC13892_SWITCHERS2_SW3EN\t\t0\n\n#define MC13892_SWITCHERS3\t\t\t27\n#define MC13892_SWITCHERS3_SW4VSEL\t\t0\n#define MC13892_SWITCHERS3_SW4VSEL_M\t\t(0x1f<<0)\n#define MC13892_SWITCHERS3_SW4HI\t\t(1<<23)\n#define MC13892_SWITCHERS3_SW4EN\t\t0\n\n#define MC13892_SWITCHERS4\t\t\t28\n#define MC13892_SWITCHERS4_SW1MODE\t\t0\n#define MC13892_SWITCHERS4_SW1MODE_AUTO\t\t(8<<0)\n#define MC13892_SWITCHERS4_SW1MODE_M\t\t(0xf<<0)\n#define MC13892_SWITCHERS4_SW2MODE\t\t10\n#define MC13892_SWITCHERS4_SW2MODE_AUTO\t\t(8<<10)\n#define MC13892_SWITCHERS4_SW2MODE_M\t\t(0xf<<10)\n\n#define MC13892_SWITCHERS5\t\t\t29\n#define MC13892_SWITCHERS5_SW3MODE\t\t0\n#define MC13892_SWITCHERS5_SW3MODE_AUTO\t\t(8<<0)\n#define MC13892_SWITCHERS5_SW3MODE_M\t\t(0xf<<0)\n#define MC13892_SWITCHERS5_SW4MODE\t\t8\n#define MC13892_SWITCHERS5_SW4MODE_AUTO\t\t(8<<8)\n#define MC13892_SWITCHERS5_SW4MODE_M\t\t(0xf<<8)\n#define MC13892_SWITCHERS5_SWBSTEN\t\t(1<<20)\n\n#define MC13892_REGULATORSETTING0\t\t30\n#define MC13892_REGULATORSETTING0_VGEN1VSEL\t0\n#define MC13892_REGULATORSETTING0_VDIGVSEL\t4\n#define MC13892_REGULATORSETTING0_VGEN2VSEL\t6\n#define MC13892_REGULATORSETTING0_VPLLVSEL\t9\n#define MC13892_REGULATORSETTING0_VUSB2VSEL\t11\n#define MC13892_REGULATORSETTING0_VGEN3VSEL\t14\n#define MC13892_REGULATORSETTING0_VCAMVSEL\t16\n\n#define MC13892_REGULATORSETTING0_VGEN1VSEL_M\t(3<<0)\n#define MC13892_REGULATORSETTING0_VDIGVSEL_M\t(3<<4)\n#define MC13892_REGULATORSETTING0_VGEN2VSEL_M\t(7<<6)\n#define MC13892_REGULATORSETTING0_VPLLVSEL_M\t(3<<9)\n#define MC13892_REGULATORSETTING0_VUSB2VSEL_M\t(3<<11)\n#define MC13892_REGULATORSETTING0_VGEN3VSEL_M\t(1<<14)\n#define MC13892_REGULATORSETTING0_VCAMVSEL_M\t(3<<16)\n\n#define MC13892_REGULATORSETTING1\t\t31\n#define MC13892_REGULATORSETTING1_VVIDEOVSEL\t2\n#define MC13892_REGULATORSETTING1_VAUDIOVSEL\t4\n#define MC13892_REGULATORSETTING1_VSDVSEL\t6\n\n#define MC13892_REGULATORSETTING1_VVIDEOVSEL_M\t(3<<2)\n#define MC13892_REGULATORSETTING1_VAUDIOVSEL_M\t(3<<4)\n#define MC13892_REGULATORSETTING1_VSDVSEL_M\t(7<<6)\n\n#define MC13892_REGULATORMODE0\t\t\t32\n#define MC13892_REGULATORMODE0_VGEN1EN\t\t(1<<0)\n#define MC13892_REGULATORMODE0_VGEN1STDBY\t(1<<1)\n#define MC13892_REGULATORMODE0_VGEN1MODE\t(1<<2)\n#define MC13892_REGULATORMODE0_VIOHIEN\t\t(1<<3)\n#define MC13892_REGULATORMODE0_VIOHISTDBY\t(1<<4)\n#define MC13892_REGULATORMODE0_VIOHIMODE\t(1<<5)\n#define MC13892_REGULATORMODE0_VDIGEN\t\t(1<<9)\n#define MC13892_REGULATORMODE0_VDIGSTDBY\t(1<<10)\n#define MC13892_REGULATORMODE0_VDIGMODE\t\t(1<<11)\n#define MC13892_REGULATORMODE0_VGEN2EN\t\t(1<<12)\n#define MC13892_REGULATORMODE0_VGEN2STDBY\t(1<<13)\n#define MC13892_REGULATORMODE0_VGEN2MODE\t(1<<14)\n#define MC13892_REGULATORMODE0_VPLLEN\t\t(1<<15)\n#define MC13892_REGULATORMODE0_VPLLSTDBY\t(1<<16)\n#define MC13892_REGULATORMODE0_VPLLMODE\t\t(1<<17)\n#define MC13892_REGULATORMODE0_VUSB2EN\t\t(1<<18)\n#define MC13892_REGULATORMODE0_VUSB2STDBY\t(1<<19)\n#define MC13892_REGULATORMODE0_VUSB2MODE\t(1<<20)\n\n#define MC13892_REGULATORMODE1\t\t\t33\n#define MC13892_REGULATORMODE1_VGEN3EN\t\t(1<<0)\n#define MC13892_REGULATORMODE1_VGEN3STDBY\t(1<<1)\n#define MC13892_REGULATORMODE1_VGEN3MODE\t(1<<2)\n#define MC13892_REGULATORMODE1_VCAMEN\t\t(1<<6)\n#define MC13892_REGULATORMODE1_VCAMSTDBY\t(1<<7)\n#define MC13892_REGULATORMODE1_VCAMMODE\t\t(1<<8)\n#define MC13892_REGULATORMODE1_VCAMCONFIGEN\t(1<<9)\n#define MC13892_REGULATORMODE1_VVIDEOEN\t\t(1<<12)\n#define MC13892_REGULATORMODE1_VVIDEOSTDBY\t(1<<13)\n#define MC13892_REGULATORMODE1_VVIDEOMODE\t(1<<14)\n#define MC13892_REGULATORMODE1_VAUDIOEN\t\t(1<<15)\n#define MC13892_REGULATORMODE1_VAUDIOSTDBY\t(1<<16)\n#define MC13892_REGULATORMODE1_VAUDIOMODE\t(1<<17)\n#define MC13892_REGULATORMODE1_VSDEN\t\t(1<<18)\n#define MC13892_REGULATORMODE1_VSDSTDBY\t\t(1<<19)\n#define MC13892_REGULATORMODE1_VSDMODE\t\t(1<<20)\n\n#define MC13892_POWERMISC\t\t\t34\n#define MC13892_POWERMISC_GPO1EN\t\t(1<<6)\n#define MC13892_POWERMISC_GPO2EN\t\t(1<<8)\n#define MC13892_POWERMISC_GPO3EN\t\t(1<<10)\n#define MC13892_POWERMISC_GPO4EN\t\t(1<<12)\n#define MC13892_POWERMISC_PWGT1SPIEN\t\t(1<<15)\n#define MC13892_POWERMISC_PWGT2SPIEN\t\t(1<<16)\n#define MC13892_POWERMISC_GPO4ADINEN\t\t(1<<21)\n\n#define MC13892_POWERMISC_PWGTSPI_M\t\t(3 << 15)\n\n#define MC13892_USB1\t\t\t\t50\n#define MC13892_USB1_VUSBEN\t\t\t(1<<3)\n\nstatic const unsigned int mc13892_vcoincell[] = {\n\t2500000, 2700000, 2800000, 2900000, 3000000, 3100000,\n\t3200000, 3300000,\n};\n\nstatic const unsigned int mc13892_sw1[] = {\n\t600000,   625000,  650000,  675000,  700000,  725000,\n\t750000,   775000,  800000,  825000,  850000,  875000,\n\t900000,   925000,  950000,  975000, 1000000, 1025000,\n\t1050000, 1075000, 1100000, 1125000, 1150000, 1175000,\n\t1200000, 1225000, 1250000, 1275000, 1300000, 1325000,\n\t1350000, 1375000\n};\n\n \n#define MC13892_SWxHI_SEL_OFFSET\t\t20\n\nstatic const unsigned int mc13892_sw[] = {\n\t600000,   625000,  650000,  675000,  700000,  725000,\n\t750000,   775000,  800000,  825000,  850000,  875000,\n\t900000,   925000,  950000,  975000, 1000000, 1025000,\n\t1050000, 1075000, 1100000, 1125000, 1150000, 1175000,\n\t1200000, 1225000, 1250000, 1275000, 1300000, 1325000,\n\t1350000, 1375000, 1400000, 1425000, 1450000, 1475000,\n\t1500000, 1525000, 1550000, 1575000, 1600000, 1625000,\n\t1650000, 1675000, 1700000, 1725000, 1750000, 1775000,\n\t1800000, 1825000, 1850000, 1875000\n};\n\nstatic const unsigned int mc13892_swbst[] = {\n\t5000000,\n};\n\nstatic const unsigned int mc13892_viohi[] = {\n\t2775000,\n};\n\nstatic const unsigned int mc13892_vpll[] = {\n\t1050000, 1250000, 1650000, 1800000,\n};\n\nstatic const unsigned int mc13892_vdig[] = {\n\t1050000, 1250000, 1650000, 1800000,\n};\n\nstatic const unsigned int mc13892_vsd[] = {\n\t1800000, 2000000, 2600000, 2700000,\n\t2800000, 2900000, 3000000, 3150000,\n};\n\nstatic const unsigned int mc13892_vusb2[] = {\n\t2400000, 2600000, 2700000, 2775000,\n};\n\nstatic const unsigned int mc13892_vvideo[] = {\n\t2700000, 2775000, 2500000, 2600000,\n};\n\nstatic const unsigned int mc13892_vaudio[] = {\n\t2300000, 2500000, 2775000, 3000000,\n};\n\nstatic const unsigned int mc13892_vcam[] = {\n\t2500000, 2600000, 2750000, 3000000,\n};\n\nstatic const unsigned int mc13892_vgen1[] = {\n\t1200000, 1500000, 2775000, 3150000,\n};\n\nstatic const unsigned int mc13892_vgen2[] = {\n\t1200000, 1500000, 1600000, 1800000,\n\t2700000, 2800000, 3000000, 3150000,\n};\n\nstatic const unsigned int mc13892_vgen3[] = {\n\t1800000, 2900000,\n};\n\nstatic const unsigned int mc13892_vusb[] = {\n\t3300000,\n};\n\nstatic const unsigned int mc13892_gpo[] = {\n\t2750000,\n};\n\nstatic const unsigned int mc13892_pwgtdrv[] = {\n\t5000000,\n};\n\nstatic const struct regulator_ops mc13892_gpo_regulator_ops;\nstatic const struct regulator_ops mc13892_sw_regulator_ops;\n\n\n#define MC13892_FIXED_DEFINE(name, node, reg, voltages)\t\t\t\\\n\tMC13xxx_FIXED_DEFINE(MC13892_, name, node, reg, voltages,\t\\\n\t\t\tmc13xxx_fixed_regulator_ops)\n\n#define MC13892_GPO_DEFINE(name, node, reg, voltages)\t\t\t\\\n\tMC13xxx_GPO_DEFINE(MC13892_, name, node, reg, voltages,\t\t\\\n\t\t\tmc13892_gpo_regulator_ops)\n\n#define MC13892_SW_DEFINE(name, node, reg, vsel_reg, voltages)\t\t\\\n\tMC13xxx_DEFINE(MC13892_, name, node, reg, vsel_reg, voltages,\t\\\n\t\t\tmc13892_sw_regulator_ops)\n\n#define MC13892_DEFINE_REGU(name, node, reg, vsel_reg, voltages)\t\\\n\tMC13xxx_DEFINE(MC13892_, name, node, reg, vsel_reg, voltages, \\\n\t\t\tmc13xxx_regulator_ops)\n\nstatic struct mc13xxx_regulator mc13892_regulators[] = {\n\tMC13892_DEFINE_REGU(VCOINCELL, vcoincell, POWERCTL0, POWERCTL0, mc13892_vcoincell),\n\tMC13892_SW_DEFINE(SW1, sw1, SWITCHERS0, SWITCHERS0, mc13892_sw1),\n\tMC13892_SW_DEFINE(SW2, sw2, SWITCHERS1, SWITCHERS1, mc13892_sw),\n\tMC13892_SW_DEFINE(SW3, sw3, SWITCHERS2, SWITCHERS2, mc13892_sw),\n\tMC13892_SW_DEFINE(SW4, sw4, SWITCHERS3, SWITCHERS3, mc13892_sw),\n\tMC13892_FIXED_DEFINE(SWBST, swbst, SWITCHERS5, mc13892_swbst),\n\tMC13892_FIXED_DEFINE(VIOHI, viohi, REGULATORMODE0, mc13892_viohi),\n\tMC13892_DEFINE_REGU(VPLL, vpll, REGULATORMODE0, REGULATORSETTING0,\n\t\tmc13892_vpll),\n\tMC13892_DEFINE_REGU(VDIG, vdig, REGULATORMODE0, REGULATORSETTING0,\n\t\tmc13892_vdig),\n\tMC13892_DEFINE_REGU(VSD, vsd, REGULATORMODE1, REGULATORSETTING1,\n\t\tmc13892_vsd),\n\tMC13892_DEFINE_REGU(VUSB2, vusb2, REGULATORMODE0, REGULATORSETTING0,\n\t\tmc13892_vusb2),\n\tMC13892_DEFINE_REGU(VVIDEO, vvideo, REGULATORMODE1, REGULATORSETTING1,\n\t\tmc13892_vvideo),\n\tMC13892_DEFINE_REGU(VAUDIO, vaudio, REGULATORMODE1, REGULATORSETTING1,\n\t\tmc13892_vaudio),\n\tMC13892_DEFINE_REGU(VCAM, vcam, REGULATORMODE1, REGULATORSETTING0,\n\t\tmc13892_vcam),\n\tMC13892_DEFINE_REGU(VGEN1, vgen1, REGULATORMODE0, REGULATORSETTING0,\n\t\tmc13892_vgen1),\n\tMC13892_DEFINE_REGU(VGEN2, vgen2, REGULATORMODE0, REGULATORSETTING0,\n\t\tmc13892_vgen2),\n\tMC13892_DEFINE_REGU(VGEN3, vgen3, REGULATORMODE1, REGULATORSETTING0,\n\t\tmc13892_vgen3),\n\tMC13892_FIXED_DEFINE(VUSB, vusb, USB1, mc13892_vusb),\n\tMC13892_GPO_DEFINE(GPO1, gpo1, POWERMISC, mc13892_gpo),\n\tMC13892_GPO_DEFINE(GPO2, gpo2, POWERMISC, mc13892_gpo),\n\tMC13892_GPO_DEFINE(GPO3, gpo3, POWERMISC, mc13892_gpo),\n\tMC13892_GPO_DEFINE(GPO4, gpo4, POWERMISC, mc13892_gpo),\n\tMC13892_GPO_DEFINE(PWGT1SPI, pwgt1spi, POWERMISC, mc13892_pwgtdrv),\n\tMC13892_GPO_DEFINE(PWGT2SPI, pwgt2spi, POWERMISC, mc13892_pwgtdrv),\n};\n\nstatic int mc13892_powermisc_rmw(struct mc13xxx_regulator_priv *priv, u32 mask,\n\t\t\t\t u32 val)\n{\n\tstruct mc13xxx *mc13892 = priv->mc13xxx;\n\tint ret;\n\tu32 valread;\n\n\tBUG_ON(val & ~mask);\n\n\tmc13xxx_lock(priv->mc13xxx);\n\tret = mc13xxx_reg_read(mc13892, MC13892_POWERMISC, &valread);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tpriv->powermisc_pwgt_state =\n\t\t(priv->powermisc_pwgt_state & ~mask) | val;\n\tpriv->powermisc_pwgt_state &= MC13892_POWERMISC_PWGTSPI_M;\n\n\t \n\tvalread = (valread & ~mask) | val;\n\t \n\tvalread = (valread & ~MC13892_POWERMISC_PWGTSPI_M) |\n\t\tpriv->powermisc_pwgt_state;\n\n\tret = mc13xxx_reg_write(mc13892, MC13892_POWERMISC, valread);\nout:\n\tmc13xxx_unlock(priv->mc13xxx);\n\treturn ret;\n}\n\nstatic int mc13892_gpo_regulator_enable(struct regulator_dev *rdev)\n{\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\tu32 en_val = mc13892_regulators[id].enable_bit;\n\tu32 mask = mc13892_regulators[id].enable_bit;\n\n\tdev_dbg(rdev_get_dev(rdev), \"%s id: %d\\n\", __func__, id);\n\n\t \n\tif (id == MC13892_PWGT1SPI || id == MC13892_PWGT2SPI)\n\t\ten_val = 0;\n\n\tif (id == MC13892_GPO4)\n\t\tmask |= MC13892_POWERMISC_GPO4ADINEN;\n\n\treturn mc13892_powermisc_rmw(priv, mask, en_val);\n}\n\nstatic int mc13892_gpo_regulator_disable(struct regulator_dev *rdev)\n{\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\tu32 dis_val = 0;\n\n\tdev_dbg(rdev_get_dev(rdev), \"%s id: %d\\n\", __func__, id);\n\n\t \n\tif (id == MC13892_PWGT1SPI || id == MC13892_PWGT2SPI)\n\t\tdis_val = mc13892_regulators[id].enable_bit;\n\n\treturn mc13892_powermisc_rmw(priv, mc13892_regulators[id].enable_bit,\n\t\tdis_val);\n}\n\nstatic int mc13892_gpo_regulator_is_enabled(struct regulator_dev *rdev)\n{\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint ret, id = rdev_get_id(rdev);\n\tunsigned int val;\n\n\tmc13xxx_lock(priv->mc13xxx);\n\tret = mc13xxx_reg_read(priv->mc13xxx, mc13892_regulators[id].reg, &val);\n\tmc13xxx_unlock(priv->mc13xxx);\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tval = (val & ~MC13892_POWERMISC_PWGTSPI_M) |\n\t\t(priv->powermisc_pwgt_state ^ MC13892_POWERMISC_PWGTSPI_M);\n\n\treturn (val & mc13892_regulators[id].enable_bit) != 0;\n}\n\n\nstatic const struct regulator_ops mc13892_gpo_regulator_ops = {\n\t.enable = mc13892_gpo_regulator_enable,\n\t.disable = mc13892_gpo_regulator_disable,\n\t.is_enabled = mc13892_gpo_regulator_is_enabled,\n\t.list_voltage = regulator_list_voltage_table,\n\t.set_voltage = mc13xxx_fixed_regulator_set_voltage,\n};\n\nstatic int mc13892_sw_regulator_get_voltage_sel(struct regulator_dev *rdev)\n{\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint ret, id = rdev_get_id(rdev);\n\tunsigned int val, selector;\n\n\tdev_dbg(rdev_get_dev(rdev), \"%s id: %d\\n\", __func__, id);\n\n\tmc13xxx_lock(priv->mc13xxx);\n\tret = mc13xxx_reg_read(priv->mc13xxx,\n\t\tmc13892_regulators[id].vsel_reg, &val);\n\tmc13xxx_unlock(priv->mc13xxx);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\n\tselector = val & mc13892_regulators[id].vsel_mask;\n\n\tif ((mc13892_regulators[id].vsel_reg != MC13892_SWITCHERS0) &&\n\t    (val & MC13892_SWITCHERS0_SWxHI)) {\n\t\tselector += MC13892_SWxHI_SEL_OFFSET;\n\t}\n\n\tdev_dbg(rdev_get_dev(rdev), \"%s id: %d val: 0x%08x selector: %d\\n\",\n\t\t\t__func__, id, val, selector);\n\n\treturn selector;\n}\n\nstatic int mc13892_sw_regulator_set_voltage_sel(struct regulator_dev *rdev,\n\t\t\t\t\t\tunsigned selector)\n{\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint volt, mask, id = rdev_get_id(rdev);\n\tu32 reg_value;\n\tint ret;\n\n\tvolt = rdev->desc->volt_table[selector];\n\tmask = mc13892_regulators[id].vsel_mask;\n\treg_value = selector;\n\n\t \n\n\tif (mc13892_regulators[id].vsel_reg != MC13892_SWITCHERS0) {\n\t\tmask |= MC13892_SWITCHERS0_SWxHI;\n\n\t\tif (volt > 1375000) {\n\t\t\treg_value -= MC13892_SWxHI_SEL_OFFSET;\n\t\t\treg_value |= MC13892_SWITCHERS0_SWxHI;\n\t\t} else {\n\t\t\treg_value &= ~MC13892_SWITCHERS0_SWxHI;\n\t\t}\n\t}\n\n\tmc13xxx_lock(priv->mc13xxx);\n\tret = mc13xxx_reg_rmw(priv->mc13xxx, mc13892_regulators[id].vsel_reg,\n\t\t\t      mask, reg_value);\n\tmc13xxx_unlock(priv->mc13xxx);\n\n\treturn ret;\n}\n\nstatic const struct regulator_ops mc13892_sw_regulator_ops = {\n\t.list_voltage = regulator_list_voltage_table,\n\t.map_voltage = regulator_map_voltage_ascend,\n\t.set_voltage_sel = mc13892_sw_regulator_set_voltage_sel,\n\t.get_voltage_sel = mc13892_sw_regulator_get_voltage_sel,\n};\n\nstatic int mc13892_vcam_set_mode(struct regulator_dev *rdev, unsigned int mode)\n{\n\tunsigned int en_val = 0;\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint ret, id = rdev_get_id(rdev);\n\n\tif (mode == REGULATOR_MODE_FAST)\n\t\ten_val = MC13892_REGULATORMODE1_VCAMCONFIGEN;\n\n\tmc13xxx_lock(priv->mc13xxx);\n\tret = mc13xxx_reg_rmw(priv->mc13xxx, mc13892_regulators[id].reg,\n\t\tMC13892_REGULATORMODE1_VCAMCONFIGEN, en_val);\n\tmc13xxx_unlock(priv->mc13xxx);\n\n\treturn ret;\n}\n\nstatic unsigned int mc13892_vcam_get_mode(struct regulator_dev *rdev)\n{\n\tstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\n\tint ret, id = rdev_get_id(rdev);\n\tunsigned int val;\n\n\tmc13xxx_lock(priv->mc13xxx);\n\tret = mc13xxx_reg_read(priv->mc13xxx, mc13892_regulators[id].reg, &val);\n\tmc13xxx_unlock(priv->mc13xxx);\n\n\tif (ret)\n\t\treturn ret;\n\n\tif (val & MC13892_REGULATORMODE1_VCAMCONFIGEN)\n\t\treturn REGULATOR_MODE_FAST;\n\n\treturn REGULATOR_MODE_NORMAL;\n}\n\nstatic struct regulator_ops mc13892_vcam_ops;\n\nstatic int mc13892_regulator_probe(struct platform_device *pdev)\n{\n\tstruct mc13xxx_regulator_priv *priv;\n\tstruct mc13xxx *mc13892 = dev_get_drvdata(pdev->dev.parent);\n\tstruct mc13xxx_regulator_platform_data *pdata =\n\t\tdev_get_platdata(&pdev->dev);\n\tstruct mc13xxx_regulator_init_data *mc13xxx_data;\n\tstruct regulator_config config = { };\n\tint i, ret;\n\tint num_regulators = 0;\n\tu32 val;\n\n\tnum_regulators = mc13xxx_get_num_regulators_dt(pdev);\n\n\tif (num_regulators <= 0 && pdata)\n\t\tnum_regulators = pdata->num_regulators;\n\tif (num_regulators <= 0)\n\t\treturn -EINVAL;\n\n\tpriv = devm_kzalloc(&pdev->dev,\n\t\t\t    struct_size(priv, regulators, num_regulators),\n\t\t\t    GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->num_regulators = num_regulators;\n\tpriv->mc13xxx_regulators = mc13892_regulators;\n\tpriv->mc13xxx = mc13892;\n\tplatform_set_drvdata(pdev, priv);\n\n\tmc13xxx_lock(mc13892);\n\tret = mc13xxx_reg_read(mc13892, MC13892_REVISION, &val);\n\tif (ret)\n\t\tgoto err_unlock;\n\n\t \n\tif ((val & 0x0000FFFF) == 0x45d0) {\n\t\tret = mc13xxx_reg_rmw(mc13892, MC13892_SWITCHERS4,\n\t\t\tMC13892_SWITCHERS4_SW1MODE_M |\n\t\t\tMC13892_SWITCHERS4_SW2MODE_M,\n\t\t\tMC13892_SWITCHERS4_SW1MODE_AUTO |\n\t\t\tMC13892_SWITCHERS4_SW2MODE_AUTO);\n\t\tif (ret)\n\t\t\tgoto err_unlock;\n\n\t\tret = mc13xxx_reg_rmw(mc13892, MC13892_SWITCHERS5,\n\t\t\tMC13892_SWITCHERS5_SW3MODE_M |\n\t\t\tMC13892_SWITCHERS5_SW4MODE_M,\n\t\t\tMC13892_SWITCHERS5_SW3MODE_AUTO |\n\t\t\tMC13892_SWITCHERS5_SW4MODE_AUTO);\n\t\tif (ret)\n\t\t\tgoto err_unlock;\n\t}\n\tmc13xxx_unlock(mc13892);\n\n\t \n\tmemcpy(&mc13892_vcam_ops, mc13892_regulators[MC13892_VCAM].desc.ops,\n\t\t\t\t\t\tsizeof(struct regulator_ops));\n\tmc13892_vcam_ops.set_mode = mc13892_vcam_set_mode;\n\tmc13892_vcam_ops.get_mode = mc13892_vcam_get_mode;\n\tmc13892_regulators[MC13892_VCAM].desc.ops = &mc13892_vcam_ops;\n\n\tmc13xxx_data = mc13xxx_parse_regulators_dt(pdev, mc13892_regulators,\n\t\t\t\t\tARRAY_SIZE(mc13892_regulators));\n\n\tfor (i = 0; i < priv->num_regulators; i++) {\n\t\tstruct regulator_init_data *init_data;\n\t\tstruct regulator_desc *desc;\n\t\tstruct device_node *node = NULL;\n\t\tint id;\n\n\t\tif (mc13xxx_data) {\n\t\t\tid = mc13xxx_data[i].id;\n\t\t\tinit_data = mc13xxx_data[i].init_data;\n\t\t\tnode = mc13xxx_data[i].node;\n\t\t} else {\n\t\t\tid = pdata->regulators[i].id;\n\t\t\tinit_data = pdata->regulators[i].init_data;\n\t\t}\n\t\tdesc = &mc13892_regulators[id].desc;\n\n\t\tconfig.dev = &pdev->dev;\n\t\tconfig.init_data = init_data;\n\t\tconfig.driver_data = priv;\n\t\tconfig.of_node = node;\n\n\t\tpriv->regulators[i] = devm_regulator_register(&pdev->dev, desc,\n\t\t\t\t\t\t\t      &config);\n\t\tif (IS_ERR(priv->regulators[i])) {\n\t\t\tdev_err(&pdev->dev, \"failed to register regulator %s\\n\",\n\t\t\t\tmc13892_regulators[i].desc.name);\n\t\t\treturn PTR_ERR(priv->regulators[i]);\n\t\t}\n\t}\n\n\treturn 0;\n\nerr_unlock:\n\tmc13xxx_unlock(mc13892);\n\treturn ret;\n}\n\nstatic struct platform_driver mc13892_regulator_driver = {\n\t.driver\t= {\n\t\t.name\t= \"mc13892-regulator\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n\t.probe\t= mc13892_regulator_probe,\n};\n\nstatic int __init mc13892_regulator_init(void)\n{\n\treturn platform_driver_register(&mc13892_regulator_driver);\n}\nsubsys_initcall(mc13892_regulator_init);\n\nstatic void __exit mc13892_regulator_exit(void)\n{\n\tplatform_driver_unregister(&mc13892_regulator_driver);\n}\nmodule_exit(mc13892_regulator_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Yong Shen <yong.shen@linaro.org>\");\nMODULE_DESCRIPTION(\"Regulator Driver for Freescale MC13892 PMIC\");\nMODULE_ALIAS(\"platform:mc13892-regulator\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}