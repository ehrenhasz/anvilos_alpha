{
  "module_name": "max77620-regulator.c",
  "hash_id": "4b9ab0cc602f08ad63827e279c45ac767742774d5b2d30d62392470f845e61d6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max77620-regulator.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/mfd/max77620.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/regulator/of_regulator.h>\n\n#define max77620_rails(_name)\t\"max77620-\"#_name\n\n \n#define MAX77620_POWER_MODE_NORMAL\t\t3\n#define MAX77620_POWER_MODE_LPM\t\t\t2\n#define MAX77620_POWER_MODE_GLPM\t\t1\n#define MAX77620_POWER_MODE_DISABLE\t\t0\n\n \n#define MAX77620_SD_SR_13_75\t\t\t0\n#define MAX77620_SD_SR_27_5\t\t\t1\n#define MAX77620_SD_SR_55\t\t\t2\n#define MAX77620_SD_SR_100\t\t\t3\n\nenum max77620_regulators {\n\tMAX77620_REGULATOR_ID_SD0,\n\tMAX77620_REGULATOR_ID_SD1,\n\tMAX77620_REGULATOR_ID_SD2,\n\tMAX77620_REGULATOR_ID_SD3,\n\tMAX77620_REGULATOR_ID_SD4,\n\tMAX77620_REGULATOR_ID_LDO0,\n\tMAX77620_REGULATOR_ID_LDO1,\n\tMAX77620_REGULATOR_ID_LDO2,\n\tMAX77620_REGULATOR_ID_LDO3,\n\tMAX77620_REGULATOR_ID_LDO4,\n\tMAX77620_REGULATOR_ID_LDO5,\n\tMAX77620_REGULATOR_ID_LDO6,\n\tMAX77620_REGULATOR_ID_LDO7,\n\tMAX77620_REGULATOR_ID_LDO8,\n\tMAX77620_NUM_REGS,\n};\n\n \nenum max77620_regulator_type {\n\tMAX77620_REGULATOR_TYPE_SD,\n\tMAX77620_REGULATOR_TYPE_LDO_N,\n\tMAX77620_REGULATOR_TYPE_LDO_P,\n};\n\nstruct max77620_regulator_info {\n\tu8 type;\n\tu8 fps_addr;\n\tu8 volt_addr;\n\tu8 cfg_addr;\n\tu8 power_mode_mask;\n\tu8 power_mode_shift;\n\tu8 remote_sense_addr;\n\tu8 remote_sense_mask;\n\tstruct regulator_desc desc;\n};\n\nstruct max77620_regulator_pdata {\n\tint active_fps_src;\n\tint active_fps_pd_slot;\n\tint active_fps_pu_slot;\n\tint suspend_fps_src;\n\tint suspend_fps_pd_slot;\n\tint suspend_fps_pu_slot;\n\tint current_mode;\n\tint power_ok;\n\tint ramp_rate_setting;\n};\n\nstruct max77620_regulator {\n\tstruct device *dev;\n\tstruct regmap *rmap;\n\tstruct max77620_regulator_info *rinfo[MAX77620_NUM_REGS];\n\tstruct max77620_regulator_pdata reg_pdata[MAX77620_NUM_REGS];\n\tint enable_power_mode[MAX77620_NUM_REGS];\n\tint current_power_mode[MAX77620_NUM_REGS];\n\tint active_fps_src[MAX77620_NUM_REGS];\n};\n\n#define fps_src_name(fps_src)\t\\\n\t(fps_src == MAX77620_FPS_SRC_0 ? \"FPS_SRC_0\" :\t\\\n\tfps_src == MAX77620_FPS_SRC_1 ? \"FPS_SRC_1\" :\t\\\n\tfps_src == MAX77620_FPS_SRC_2 ? \"FPS_SRC_2\" : \"FPS_SRC_NONE\")\n\nstatic int max77620_regulator_get_fps_src(struct max77620_regulator *pmic,\n\t\t\t\t\t  int id)\n{\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(pmic->rmap, rinfo->fps_addr, &val);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Reg 0x%02x read failed %d\\n\",\n\t\t\trinfo->fps_addr, ret);\n\t\treturn ret;\n\t}\n\n\treturn (val & MAX77620_FPS_SRC_MASK) >> MAX77620_FPS_SRC_SHIFT;\n}\n\nstatic int max77620_regulator_set_fps_src(struct max77620_regulator *pmic,\n\t\t\t\t\t  int fps_src, int id)\n{\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tunsigned int val;\n\tint ret;\n\n\tif (!rinfo)\n\t\treturn 0;\n\n\tswitch (fps_src) {\n\tcase MAX77620_FPS_SRC_0:\n\tcase MAX77620_FPS_SRC_1:\n\tcase MAX77620_FPS_SRC_2:\n\tcase MAX77620_FPS_SRC_NONE:\n\t\tbreak;\n\n\tcase MAX77620_FPS_SRC_DEF:\n\t\tret = regmap_read(pmic->rmap, rinfo->fps_addr, &val);\n\t\tif (ret < 0) {\n\t\t\tdev_err(pmic->dev, \"Reg 0x%02x read failed %d\\n\",\n\t\t\t\trinfo->fps_addr, ret);\n\t\t\treturn ret;\n\t\t}\n\t\tret = (val & MAX77620_FPS_SRC_MASK) >> MAX77620_FPS_SRC_SHIFT;\n\t\tpmic->active_fps_src[id] = ret;\n\t\treturn 0;\n\n\tdefault:\n\t\tdev_err(pmic->dev, \"Invalid FPS %d for regulator %d\\n\",\n\t\t\tfps_src, id);\n\t\treturn -EINVAL;\n\t}\n\n\tret = regmap_update_bits(pmic->rmap, rinfo->fps_addr,\n\t\t\t\t MAX77620_FPS_SRC_MASK,\n\t\t\t\t fps_src << MAX77620_FPS_SRC_SHIFT);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Reg 0x%02x update failed %d\\n\",\n\t\t\trinfo->fps_addr, ret);\n\t\treturn ret;\n\t}\n\tpmic->active_fps_src[id] = fps_src;\n\n\treturn 0;\n}\n\nstatic int max77620_regulator_set_fps_slots(struct max77620_regulator *pmic,\n\t\t\t\t\t    int id, bool is_suspend)\n{\n\tstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tunsigned int val = 0;\n\tunsigned int mask = 0;\n\tint pu = rpdata->active_fps_pu_slot;\n\tint pd = rpdata->active_fps_pd_slot;\n\tint ret = 0;\n\n\tif (!rinfo)\n\t\treturn 0;\n\n\tif (is_suspend) {\n\t\tpu = rpdata->suspend_fps_pu_slot;\n\t\tpd = rpdata->suspend_fps_pd_slot;\n\t}\n\n\t \n\tif (pu >= 0) {\n\t\tval |= (pu << MAX77620_FPS_PU_PERIOD_SHIFT);\n\t\tmask |= MAX77620_FPS_PU_PERIOD_MASK;\n\t}\n\n\t \n\tif (pd >= 0) {\n\t\tval |= (pd << MAX77620_FPS_PD_PERIOD_SHIFT);\n\t\tmask |= MAX77620_FPS_PD_PERIOD_MASK;\n\t}\n\n\tif (mask) {\n\t\tret = regmap_update_bits(pmic->rmap, rinfo->fps_addr,\n\t\t\t\t\t mask, val);\n\t\tif (ret < 0) {\n\t\t\tdev_err(pmic->dev, \"Reg 0x%02x update failed: %d\\n\",\n\t\t\t\trinfo->fps_addr, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int max77620_regulator_set_power_mode(struct max77620_regulator *pmic,\n\t\t\t\t\t     int power_mode, int id)\n{\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tu8 mask = rinfo->power_mode_mask;\n\tu8 shift = rinfo->power_mode_shift;\n\tu8 addr;\n\tint ret;\n\n\tswitch (rinfo->type) {\n\tcase MAX77620_REGULATOR_TYPE_SD:\n\t\taddr = rinfo->cfg_addr;\n\t\tbreak;\n\tdefault:\n\t\taddr = rinfo->volt_addr;\n\t\tbreak;\n\t}\n\n\tret = regmap_update_bits(pmic->rmap, addr, mask, power_mode << shift);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Regulator %d mode set failed: %d\\n\",\n\t\t\tid, ret);\n\t\treturn ret;\n\t}\n\tpmic->current_power_mode[id] = power_mode;\n\n\treturn ret;\n}\n\nstatic int max77620_regulator_get_power_mode(struct max77620_regulator *pmic,\n\t\t\t\t\t     int id)\n{\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tunsigned int val, addr;\n\tu8 mask = rinfo->power_mode_mask;\n\tu8 shift = rinfo->power_mode_shift;\n\tint ret;\n\n\tswitch (rinfo->type) {\n\tcase MAX77620_REGULATOR_TYPE_SD:\n\t\taddr = rinfo->cfg_addr;\n\t\tbreak;\n\tdefault:\n\t\taddr = rinfo->volt_addr;\n\t\tbreak;\n\t}\n\n\tret = regmap_read(pmic->rmap, addr, &val);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Regulator %d: Reg 0x%02x read failed: %d\\n\",\n\t\t\tid, addr, ret);\n\t\treturn ret;\n\t}\n\n\treturn (val & mask) >> shift;\n}\n\nstatic int max77620_read_slew_rate(struct max77620_regulator *pmic, int id)\n{\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tunsigned int rval;\n\tint slew_rate;\n\tint ret;\n\n\tret = regmap_read(pmic->rmap, rinfo->cfg_addr, &rval);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Register 0x%02x read failed: %d\\n\",\n\t\t\trinfo->cfg_addr, ret);\n\t\treturn ret;\n\t}\n\n\tswitch (rinfo->type) {\n\tcase MAX77620_REGULATOR_TYPE_SD:\n\t\tslew_rate = (rval >> MAX77620_SD_SR_SHIFT) & 0x3;\n\t\tswitch (slew_rate) {\n\t\tcase 0:\n\t\t\tslew_rate = 13750;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tslew_rate = 27500;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tslew_rate = 55000;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tslew_rate = 100000;\n\t\t\tbreak;\n\t\t}\n\t\trinfo->desc.ramp_delay = slew_rate;\n\t\tbreak;\n\tdefault:\n\t\tslew_rate = rval & 0x1;\n\t\tswitch (slew_rate) {\n\t\tcase 0:\n\t\t\tslew_rate = 100000;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tslew_rate = 5000;\n\t\t\tbreak;\n\t\t}\n\t\trinfo->desc.ramp_delay = slew_rate;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77620_set_slew_rate(struct max77620_regulator *pmic, int id,\n\t\t\t\t  int slew_rate)\n{\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tunsigned int val;\n\tint ret;\n\tu8 mask;\n\n\tif (rinfo->type == MAX77620_REGULATOR_TYPE_SD) {\n\t\tif (slew_rate <= 13750)\n\t\t\tval = 0;\n\t\telse if (slew_rate <= 27500)\n\t\t\tval = 1;\n\t\telse if (slew_rate <= 55000)\n\t\t\tval = 2;\n\t\telse\n\t\t\tval = 3;\n\t\tval <<= MAX77620_SD_SR_SHIFT;\n\t\tmask = MAX77620_SD_SR_MASK;\n\t} else {\n\t\tif (slew_rate <= 5000)\n\t\t\tval = 1;\n\t\telse\n\t\t\tval = 0;\n\t\tmask = MAX77620_LDO_SLEW_RATE_MASK;\n\t}\n\n\tret = regmap_update_bits(pmic->rmap, rinfo->cfg_addr, mask, val);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Regulator %d slew rate set failed: %d\\n\",\n\t\t\tid, ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77620_config_power_ok(struct max77620_regulator *pmic, int id)\n{\n\tstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tstruct max77620_chip *chip = dev_get_drvdata(pmic->dev->parent);\n\tu8 val, mask;\n\tint ret;\n\n\tswitch (chip->chip_id) {\n\tcase MAX20024:\n\t\tif (rpdata->power_ok >= 0) {\n\t\t\tif (rinfo->type == MAX77620_REGULATOR_TYPE_SD)\n\t\t\t\tmask = MAX20024_SD_CFG1_MPOK_MASK;\n\t\t\telse\n\t\t\t\tmask = MAX20024_LDO_CFG2_MPOK_MASK;\n\n\t\t\tval = rpdata->power_ok ? mask : 0;\n\n\t\t\tret = regmap_update_bits(pmic->rmap, rinfo->cfg_addr,\n\t\t\t\t\t\t mask, val);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(pmic->dev, \"Reg 0x%02x update failed %d\\n\",\n\t\t\t\t\trinfo->cfg_addr, ret);\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77620_init_pmic(struct max77620_regulator *pmic, int id)\n{\n\tstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\n\tint ret;\n\n\tmax77620_config_power_ok(pmic, id);\n\n\t \n\tret = max77620_regulator_get_power_mode(pmic, id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tpmic->current_power_mode[id] = ret;\n\tpmic->enable_power_mode[id] = MAX77620_POWER_MODE_NORMAL;\n\n\tif (rpdata->active_fps_src == MAX77620_FPS_SRC_DEF) {\n\t\tret = max77620_regulator_get_fps_src(pmic, id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\trpdata->active_fps_src = ret;\n\t}\n\n\t  \n\tif (rpdata->active_fps_src == MAX77620_FPS_SRC_NONE) {\n\t\tret = max77620_regulator_set_power_mode(pmic,\n\t\t\t\t\tpmic->enable_power_mode[id], id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t} else {\n\t\tif (pmic->current_power_mode[id] !=\n\t\t     pmic->enable_power_mode[id]) {\n\t\t\tret = max77620_regulator_set_power_mode(pmic,\n\t\t\t\t\tpmic->enable_power_mode[id], id);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = max77620_regulator_set_fps_src(pmic, rpdata->active_fps_src, id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = max77620_regulator_set_fps_slots(pmic, id, false);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (rpdata->ramp_rate_setting) {\n\t\tret = max77620_set_slew_rate(pmic, id,\n\t\t\t\t\t     rpdata->ramp_rate_setting);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77620_regulator_enable(struct regulator_dev *rdev)\n{\n\tstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\n\tif (pmic->active_fps_src[id] != MAX77620_FPS_SRC_NONE)\n\t\treturn 0;\n\n\treturn max77620_regulator_set_power_mode(pmic,\n\t\t\tpmic->enable_power_mode[id], id);\n}\n\nstatic int max77620_regulator_disable(struct regulator_dev *rdev)\n{\n\tstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\n\tif (pmic->active_fps_src[id] != MAX77620_FPS_SRC_NONE)\n\t\treturn 0;\n\n\treturn max77620_regulator_set_power_mode(pmic,\n\t\t\tMAX77620_POWER_MODE_DISABLE, id);\n}\n\nstatic int max77620_regulator_is_enabled(struct regulator_dev *rdev)\n{\n\tstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\tint ret;\n\n\tif (pmic->active_fps_src[id] != MAX77620_FPS_SRC_NONE)\n\t\treturn 1;\n\n\tret = max77620_regulator_get_power_mode(pmic, id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (ret != MAX77620_POWER_MODE_DISABLE)\n\t\treturn 1;\n\n\treturn 0;\n}\n\nstatic int max77620_regulator_set_mode(struct regulator_dev *rdev,\n\t\t\t\t       unsigned int mode)\n{\n\tstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\n\tbool fpwm = false;\n\tint power_mode;\n\tint ret;\n\tu8 val;\n\n\tswitch (mode) {\n\tcase REGULATOR_MODE_FAST:\n\t\tfpwm = true;\n\t\tpower_mode = MAX77620_POWER_MODE_NORMAL;\n\t\tbreak;\n\n\tcase REGULATOR_MODE_NORMAL:\n\t\tpower_mode = MAX77620_POWER_MODE_NORMAL;\n\t\tbreak;\n\n\tcase REGULATOR_MODE_IDLE:\n\t\tpower_mode = MAX77620_POWER_MODE_LPM;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(pmic->dev, \"Regulator %d mode %d is invalid\\n\",\n\t\t\tid, mode);\n\t\treturn -EINVAL;\n\t}\n\n\tif (rinfo->type != MAX77620_REGULATOR_TYPE_SD)\n\t\tgoto skip_fpwm;\n\n\tval = (fpwm) ? MAX77620_SD_FPWM_MASK : 0;\n\tret = regmap_update_bits(pmic->rmap, rinfo->cfg_addr,\n\t\t\t\t MAX77620_SD_FPWM_MASK, val);\n\tif (ret < 0) {\n\t\tdev_err(pmic->dev, \"Reg 0x%02x update failed: %d\\n\",\n\t\t\trinfo->cfg_addr, ret);\n\t\treturn ret;\n\t}\n\trpdata->current_mode = mode;\n\nskip_fpwm:\n\tret = max77620_regulator_set_power_mode(pmic, power_mode, id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tpmic->enable_power_mode[id] = power_mode;\n\n\treturn 0;\n}\n\nstatic unsigned int max77620_regulator_get_mode(struct regulator_dev *rdev)\n{\n\tstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\tstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\n\tint fpwm = 0;\n\tint ret;\n\tint pm_mode, reg_mode;\n\tunsigned int val;\n\n\tret = max77620_regulator_get_power_mode(pmic, id);\n\tif (ret < 0)\n\t\treturn 0;\n\n\tpm_mode = ret;\n\n\tif (rinfo->type == MAX77620_REGULATOR_TYPE_SD) {\n\t\tret = regmap_read(pmic->rmap, rinfo->cfg_addr, &val);\n\t\tif (ret < 0) {\n\t\t\tdev_err(pmic->dev, \"Reg 0x%02x read failed: %d\\n\",\n\t\t\t\trinfo->cfg_addr, ret);\n\t\t\treturn ret;\n\t\t}\n\t\tfpwm = !!(val & MAX77620_SD_FPWM_MASK);\n\t}\n\n\tswitch (pm_mode) {\n\tcase MAX77620_POWER_MODE_NORMAL:\n\tcase MAX77620_POWER_MODE_DISABLE:\n\t\tif (fpwm)\n\t\t\treg_mode = REGULATOR_MODE_FAST;\n\t\telse\n\t\t\treg_mode = REGULATOR_MODE_NORMAL;\n\t\tbreak;\n\tcase MAX77620_POWER_MODE_LPM:\n\tcase MAX77620_POWER_MODE_GLPM:\n\t\treg_mode = REGULATOR_MODE_IDLE;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\treturn reg_mode;\n}\n\nstatic int max77620_regulator_set_ramp_delay(struct regulator_dev *rdev,\n\t\t\t\t\t     int ramp_delay)\n{\n\tstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\n\tint id = rdev_get_id(rdev);\n\tstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\n\n\t \n\tif (rpdata->ramp_rate_setting)\n\t\treturn 0;\n\n\treturn max77620_set_slew_rate(pmic, id, ramp_delay);\n}\n\nstatic int max77620_of_parse_cb(struct device_node *np,\n\t\t\t\tconst struct regulator_desc *desc,\n\t\t\t\tstruct regulator_config *config)\n{\n\tstruct max77620_regulator *pmic = config->driver_data;\n\tstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[desc->id];\n\tu32 pval;\n\tint ret;\n\n\tret = of_property_read_u32(np, \"maxim,active-fps-source\", &pval);\n\trpdata->active_fps_src = (!ret) ? pval : MAX77620_FPS_SRC_DEF;\n\n\tret = of_property_read_u32(np, \"maxim,active-fps-power-up-slot\", &pval);\n\trpdata->active_fps_pu_slot = (!ret) ? pval : -1;\n\n\tret = of_property_read_u32(\n\t\t\tnp, \"maxim,active-fps-power-down-slot\", &pval);\n\trpdata->active_fps_pd_slot = (!ret) ? pval : -1;\n\n\tret = of_property_read_u32(np, \"maxim,suspend-fps-source\", &pval);\n\trpdata->suspend_fps_src = (!ret) ? pval : -1;\n\n\tret = of_property_read_u32(\n\t\t\tnp, \"maxim,suspend-fps-power-up-slot\", &pval);\n\trpdata->suspend_fps_pu_slot = (!ret) ? pval : -1;\n\n\tret = of_property_read_u32(\n\t\t\tnp, \"maxim,suspend-fps-power-down-slot\", &pval);\n\trpdata->suspend_fps_pd_slot = (!ret) ? pval : -1;\n\n\tret = of_property_read_u32(np, \"maxim,power-ok-control\", &pval);\n\tif (!ret)\n\t\trpdata->power_ok = pval;\n\telse\n\t\trpdata->power_ok = -1;\n\n\tret = of_property_read_u32(np, \"maxim,ramp-rate-setting\", &pval);\n\trpdata->ramp_rate_setting = (!ret) ? pval : 0;\n\n\treturn max77620_init_pmic(pmic, desc->id);\n}\n\nstatic const struct regulator_ops max77620_regulator_ops = {\n\t.is_enabled = max77620_regulator_is_enabled,\n\t.enable = max77620_regulator_enable,\n\t.disable = max77620_regulator_disable,\n\t.list_voltage = regulator_list_voltage_linear,\n\t.map_voltage = regulator_map_voltage_linear,\n\t.get_voltage_sel = regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel = regulator_set_voltage_sel_regmap,\n\t.set_mode = max77620_regulator_set_mode,\n\t.get_mode = max77620_regulator_get_mode,\n\t.set_ramp_delay = max77620_regulator_set_ramp_delay,\n\t.set_voltage_time_sel = regulator_set_voltage_time_sel,\n\t.set_active_discharge = regulator_set_active_discharge_regmap,\n};\n\n#define MAX77620_SD_CNF2_ROVS_EN_NONE\t0\n#define RAIL_SD(_id, _name, _sname, _volt_mask, _min_uV, _max_uV,\t\\\n\t\t_step_uV, _rs_add, _rs_mask)\t\t\t\t\\\n\t[MAX77620_REGULATOR_ID_##_id] = {\t\t\t\t\\\n\t\t.type = MAX77620_REGULATOR_TYPE_SD,\t\t\t\\\n\t\t.volt_addr = MAX77620_REG_##_id,\t\t\t\\\n\t\t.cfg_addr = MAX77620_REG_##_id##_CFG,\t\t\t\\\n\t\t.fps_addr = MAX77620_REG_FPS_##_id,\t\t\t\\\n\t\t.remote_sense_addr = _rs_add,\t\t\t\t\\\n\t\t.remote_sense_mask = MAX77620_SD_CNF2_ROVS_EN_##_rs_mask, \\\n\t\t.power_mode_mask = MAX77620_SD_POWER_MODE_MASK,\t\t\\\n\t\t.power_mode_shift = MAX77620_SD_POWER_MODE_SHIFT,\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = max77620_rails(_name),\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.of_parse_cb = max77620_of_parse_cb,\t\t\\\n\t\t\t.supply_name = _sname,\t\t\t\t\\\n\t\t\t.id = MAX77620_REGULATOR_ID_##_id,\t\t\\\n\t\t\t.ops = &max77620_regulator_ops,\t\t\t\\\n\t\t\t.n_voltages = ((_max_uV - _min_uV) / _step_uV) + 1, \\\n\t\t\t.min_uV = _min_uV,\t\t\t\t\\\n\t\t\t.uV_step = _step_uV,\t\t\t\t\\\n\t\t\t.enable_time = 500,\t\t\t\t\\\n\t\t\t.vsel_mask = MAX77620_##_volt_mask##_VOLT_MASK,\t\\\n\t\t\t.vsel_reg = MAX77620_REG_##_id,\t\t\t\\\n\t\t\t.active_discharge_off = 0,\t\t\t\\\n\t\t\t.active_discharge_on = MAX77620_SD_CFG1_ADE_ENABLE, \\\n\t\t\t.active_discharge_mask = MAX77620_SD_CFG1_ADE_MASK, \\\n\t\t\t.active_discharge_reg = MAX77620_REG_##_id##_CFG, \\\n\t\t\t.type = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n\n#define RAIL_LDO(_id, _name, _sname, _type, _min_uV, _max_uV, _step_uV) \\\n\t[MAX77620_REGULATOR_ID_##_id] = {\t\t\t\t\\\n\t\t.type = MAX77620_REGULATOR_TYPE_LDO_##_type,\t\t\\\n\t\t.volt_addr = MAX77620_REG_##_id##_CFG,\t\t\t\\\n\t\t.cfg_addr = MAX77620_REG_##_id##_CFG2,\t\t\t\\\n\t\t.fps_addr = MAX77620_REG_FPS_##_id,\t\t\t\\\n\t\t.remote_sense_addr = 0xFF,\t\t\t\t\\\n\t\t.power_mode_mask = MAX77620_LDO_POWER_MODE_MASK,\t\\\n\t\t.power_mode_shift = MAX77620_LDO_POWER_MODE_SHIFT,\t\\\n\t\t.desc = {\t\t\t\t\t\t\\\n\t\t\t.name = max77620_rails(_name),\t\t\t\\\n\t\t\t.of_match = of_match_ptr(#_name),\t\t\\\n\t\t\t.regulators_node = of_match_ptr(\"regulators\"),\t\\\n\t\t\t.of_parse_cb = max77620_of_parse_cb,\t\t\\\n\t\t\t.supply_name = _sname,\t\t\t\t\\\n\t\t\t.id = MAX77620_REGULATOR_ID_##_id,\t\t\\\n\t\t\t.ops = &max77620_regulator_ops,\t\t\t\\\n\t\t\t.n_voltages = ((_max_uV - _min_uV) / _step_uV) + 1, \\\n\t\t\t.min_uV = _min_uV,\t\t\t\t\\\n\t\t\t.uV_step = _step_uV,\t\t\t\t\\\n\t\t\t.enable_time = 500,\t\t\t\t\\\n\t\t\t.vsel_mask = MAX77620_LDO_VOLT_MASK,\t\t\\\n\t\t\t.vsel_reg = MAX77620_REG_##_id##_CFG,\t\t\\\n\t\t\t.active_discharge_off = 0,\t\t\t\\\n\t\t\t.active_discharge_on = MAX77620_LDO_CFG2_ADE_ENABLE, \\\n\t\t\t.active_discharge_mask = MAX77620_LDO_CFG2_ADE_MASK, \\\n\t\t\t.active_discharge_reg = MAX77620_REG_##_id##_CFG2, \\\n\t\t\t.type = REGULATOR_VOLTAGE,\t\t\t\\\n\t\t\t.owner = THIS_MODULE,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n\nstatic struct max77620_regulator_info max77620_regs_info[MAX77620_NUM_REGS] = {\n\tRAIL_SD(SD0, sd0, \"in-sd0\", SD0, 600000, 1400000, 12500, 0x22, SD0),\n\tRAIL_SD(SD1, sd1, \"in-sd1\", SD1, 600000, 1550000, 12500, 0x22, SD1),\n\tRAIL_SD(SD2, sd2, \"in-sd2\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD3, sd3, \"in-sd3\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\n\tRAIL_LDO(LDO0, ldo0, \"in-ldo0-1\", N, 800000, 2375000, 25000),\n\tRAIL_LDO(LDO1, ldo1, \"in-ldo0-1\", N, 800000, 2375000, 25000),\n\tRAIL_LDO(LDO2, ldo2, \"in-ldo2\",   P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO3, ldo3, \"in-ldo3-5\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO4, ldo4, \"in-ldo4-6\", P, 800000, 1587500, 12500),\n\tRAIL_LDO(LDO5, ldo5, \"in-ldo3-5\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO6, ldo6, \"in-ldo4-6\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO7, ldo7, \"in-ldo7-8\", N, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO8, ldo8, \"in-ldo7-8\", N, 800000, 3950000, 50000),\n};\n\nstatic struct max77620_regulator_info max20024_regs_info[MAX77620_NUM_REGS] = {\n\tRAIL_SD(SD0, sd0, \"in-sd0\", SD0, 800000, 1587500, 12500, 0x22, SD0),\n\tRAIL_SD(SD1, sd1, \"in-sd1\", SD1, 600000, 3387500, 12500, 0x22, SD1),\n\tRAIL_SD(SD2, sd2, \"in-sd2\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD3, sd3, \"in-sd3\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD4, sd4, \"in-sd4\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\n\tRAIL_LDO(LDO0, ldo0, \"in-ldo0-1\", N, 800000, 2375000, 25000),\n\tRAIL_LDO(LDO1, ldo1, \"in-ldo0-1\", N, 800000, 2375000, 25000),\n\tRAIL_LDO(LDO2, ldo2, \"in-ldo2\",   P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO3, ldo3, \"in-ldo3-5\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO4, ldo4, \"in-ldo4-6\", P, 800000, 1587500, 12500),\n\tRAIL_LDO(LDO5, ldo5, \"in-ldo3-5\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO6, ldo6, \"in-ldo4-6\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO7, ldo7, \"in-ldo7-8\", N, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO8, ldo8, \"in-ldo7-8\", N, 800000, 3950000, 50000),\n};\n\nstatic struct max77620_regulator_info max77663_regs_info[MAX77620_NUM_REGS] = {\n\tRAIL_SD(SD0, sd0, \"in-sd0\", SD0, 600000, 3387500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD1, sd1, \"in-sd1\", SD1, 800000, 1587500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD2, sd2, \"in-sd2\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD3, sd3, \"in-sd3\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\tRAIL_SD(SD4, sd4, \"in-sd4\", SDX, 600000, 3787500, 12500, 0xFF, NONE),\n\n\tRAIL_LDO(LDO0, ldo0, \"in-ldo0-1\", N, 800000, 2375000, 25000),\n\tRAIL_LDO(LDO1, ldo1, \"in-ldo0-1\", N, 800000, 2375000, 25000),\n\tRAIL_LDO(LDO2, ldo2, \"in-ldo2\",   P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO3, ldo3, \"in-ldo3-5\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO4, ldo4, \"in-ldo4-6\", P, 800000, 1587500, 12500),\n\tRAIL_LDO(LDO5, ldo5, \"in-ldo3-5\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO6, ldo6, \"in-ldo4-6\", P, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO7, ldo7, \"in-ldo7-8\", N, 800000, 3950000, 50000),\n\tRAIL_LDO(LDO8, ldo8, \"in-ldo7-8\", N, 800000, 3950000, 50000),\n};\n\nstatic int max77620_regulator_probe(struct platform_device *pdev)\n{\n\tstruct max77620_chip *max77620_chip = dev_get_drvdata(pdev->dev.parent);\n\tstruct max77620_regulator_info *rinfo;\n\tstruct device *dev = &pdev->dev;\n\tstruct regulator_config config = { };\n\tstruct max77620_regulator *pmic;\n\tint ret = 0;\n\tint id;\n\n\tpmic = devm_kzalloc(dev, sizeof(*pmic), GFP_KERNEL);\n\tif (!pmic)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, pmic);\n\tpmic->dev = dev;\n\tpmic->rmap = max77620_chip->rmap;\n\tif (!dev->of_node)\n\t\tdev->of_node = pdev->dev.parent->of_node;\n\n\tswitch (max77620_chip->chip_id) {\n\tcase MAX77620:\n\t\trinfo = max77620_regs_info;\n\t\tbreak;\n\tcase MAX20024:\n\t\trinfo = max20024_regs_info;\n\t\tbreak;\n\tcase MAX77663:\n\t\trinfo = max77663_regs_info;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tconfig.regmap = pmic->rmap;\n\tconfig.dev = dev;\n\tconfig.driver_data = pmic;\n\n\t \n\tdevice_set_of_node_from_dev(&pdev->dev, pdev->dev.parent);\n\n\tfor (id = 0; id < MAX77620_NUM_REGS; id++) {\n\t\tstruct regulator_dev *rdev;\n\t\tstruct regulator_desc *rdesc;\n\n\t\tif ((max77620_chip->chip_id == MAX77620) &&\n\t\t    (id == MAX77620_REGULATOR_ID_SD4))\n\t\t\tcontinue;\n\n\t\trdesc = &rinfo[id].desc;\n\t\tpmic->rinfo[id] = &rinfo[id];\n\t\tpmic->enable_power_mode[id] = MAX77620_POWER_MODE_NORMAL;\n\t\tpmic->reg_pdata[id].active_fps_src = -1;\n\t\tpmic->reg_pdata[id].active_fps_pd_slot = -1;\n\t\tpmic->reg_pdata[id].active_fps_pu_slot = -1;\n\t\tpmic->reg_pdata[id].suspend_fps_src = -1;\n\t\tpmic->reg_pdata[id].suspend_fps_pd_slot = -1;\n\t\tpmic->reg_pdata[id].suspend_fps_pu_slot = -1;\n\t\tpmic->reg_pdata[id].power_ok = -1;\n\t\tpmic->reg_pdata[id].ramp_rate_setting = -1;\n\n\t\tret = max77620_read_slew_rate(pmic, id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\trdev = devm_regulator_register(dev, rdesc, &config);\n\t\tif (IS_ERR(rdev))\n\t\t\treturn dev_err_probe(dev, PTR_ERR(rdev),\n\t\t\t\t\t     \"Regulator registration %s failed\\n\",\n\t\t\t\t\t     rdesc->name);\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int max77620_regulator_suspend(struct device *dev)\n{\n\tstruct max77620_regulator *pmic = dev_get_drvdata(dev);\n\tstruct max77620_regulator_pdata *reg_pdata;\n\tint id;\n\n\tfor (id = 0; id < MAX77620_NUM_REGS; id++) {\n\t\treg_pdata = &pmic->reg_pdata[id];\n\n\t\tmax77620_regulator_set_fps_slots(pmic, id, true);\n\t\tif (reg_pdata->suspend_fps_src < 0)\n\t\t\tcontinue;\n\n\t\tmax77620_regulator_set_fps_src(pmic, reg_pdata->suspend_fps_src,\n\t\t\t\t\t       id);\n\t}\n\n\treturn 0;\n}\n\nstatic int max77620_regulator_resume(struct device *dev)\n{\n\tstruct max77620_regulator *pmic = dev_get_drvdata(dev);\n\tstruct max77620_regulator_pdata *reg_pdata;\n\tint id;\n\n\tfor (id = 0; id < MAX77620_NUM_REGS; id++) {\n\t\treg_pdata = &pmic->reg_pdata[id];\n\n\t\tmax77620_config_power_ok(pmic, id);\n\n\t\tmax77620_regulator_set_fps_slots(pmic, id, false);\n\t\tif (reg_pdata->active_fps_src < 0)\n\t\t\tcontinue;\n\t\tmax77620_regulator_set_fps_src(pmic, reg_pdata->active_fps_src,\n\t\t\t\t\t       id);\n\t}\n\n\treturn 0;\n}\n#endif\n\nstatic const struct dev_pm_ops max77620_regulator_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(max77620_regulator_suspend,\n\t\t\t\tmax77620_regulator_resume)\n};\n\nstatic const struct platform_device_id max77620_regulator_devtype[] = {\n\t{ .name = \"max77620-pmic\", },\n\t{ .name = \"max20024-pmic\", },\n\t{ .name = \"max77663-pmic\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(platform, max77620_regulator_devtype);\n\nstatic struct platform_driver max77620_regulator_driver = {\n\t.probe = max77620_regulator_probe,\n\t.id_table = max77620_regulator_devtype,\n\t.driver = {\n\t\t.name = \"max77620-pmic\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.pm = &max77620_regulator_pm_ops,\n\t},\n};\n\nmodule_platform_driver(max77620_regulator_driver);\n\nMODULE_DESCRIPTION(\"MAX77620/MAX20024 regulator driver\");\nMODULE_AUTHOR(\"Mallikarjun Kasoju <mkasoju@nvidia.com>\");\nMODULE_AUTHOR(\"Laxman Dewangan <ldewangan@nvidia.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}