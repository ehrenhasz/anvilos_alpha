{
  "module_name": "max14577-regulator.c",
  "hash_id": "cdcc2a1b23f3082ad020fd0164fab923ad18e77643115be6225105f1f177b1c8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/max14577-regulator.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/driver.h>\n#include <linux/mfd/max14577.h>\n#include <linux/mfd/max14577-private.h>\n#include <linux/regulator/of_regulator.h>\n\nstatic int max14577_reg_is_enabled(struct regulator_dev *rdev)\n{\n\tint rid = rdev_get_id(rdev);\n\tstruct regmap *rmap = rdev->regmap;\n\tu8 reg_data;\n\n\tswitch (rid) {\n\tcase MAX14577_CHARGER:\n\t\tmax14577_read_reg(rmap, MAX14577_CHG_REG_CHG_CTRL2, &reg_data);\n\t\tif ((reg_data & CHGCTRL2_MBCHOSTEN_MASK) == 0)\n\t\t\treturn 0;\n\t\tmax14577_read_reg(rmap, MAX14577_CHG_REG_STATUS3, &reg_data);\n\t\tif ((reg_data & STATUS3_CGMBC_MASK) == 0)\n\t\t\treturn 0;\n\t\t \n\t\treturn 1;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int max14577_reg_get_current_limit(struct regulator_dev *rdev)\n{\n\tu8 reg_data;\n\tstruct regmap *rmap = rdev->regmap;\n\tstruct max14577 *max14577 = rdev_get_drvdata(rdev);\n\tconst struct maxim_charger_current *limits =\n\t\t&maxim_charger_currents[max14577->dev_type];\n\n\tif (rdev_get_id(rdev) != MAX14577_CHARGER)\n\t\treturn -EINVAL;\n\n\tmax14577_read_reg(rmap, MAX14577_CHG_REG_CHG_CTRL4, &reg_data);\n\n\tif ((reg_data & CHGCTRL4_MBCICHWRCL_MASK) == 0)\n\t\treturn limits->min;\n\n\treg_data = ((reg_data & CHGCTRL4_MBCICHWRCH_MASK) >>\n\t\t\tCHGCTRL4_MBCICHWRCH_SHIFT);\n\treturn limits->high_start + reg_data * limits->high_step;\n}\n\nstatic int max14577_reg_set_current_limit(struct regulator_dev *rdev,\n\t\tint min_uA, int max_uA)\n{\n\tu8 reg_data;\n\tint ret;\n\tstruct max14577 *max14577 = rdev_get_drvdata(rdev);\n\tconst struct maxim_charger_current *limits =\n\t\t&maxim_charger_currents[max14577->dev_type];\n\n\tif (rdev_get_id(rdev) != MAX14577_CHARGER)\n\t\treturn -EINVAL;\n\n\tret = maxim_charger_calc_reg_current(limits, min_uA, max_uA, &reg_data);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max14577_update_reg(rdev->regmap, MAX14577_CHG_REG_CHG_CTRL4,\n\t\t\tCHGCTRL4_MBCICHWRCL_MASK | CHGCTRL4_MBCICHWRCH_MASK,\n\t\t\treg_data);\n}\n\nstatic const struct regulator_ops max14577_safeout_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n};\n\nstatic const struct regulator_ops max14577_charger_ops = {\n\t.is_enabled\t\t= max14577_reg_is_enabled,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.get_current_limit\t= max14577_reg_get_current_limit,\n\t.set_current_limit\t= max14577_reg_set_current_limit,\n};\n\n#define MAX14577_SAFEOUT_REG\t{ \\\n\t.name\t\t= \"SAFEOUT\", \\\n\t.of_match\t= of_match_ptr(\"SAFEOUT\"), \\\n\t.regulators_node = of_match_ptr(\"regulators\"), \\\n\t.id\t\t= MAX14577_SAFEOUT, \\\n\t.ops\t\t= &max14577_safeout_ops, \\\n\t.type\t\t= REGULATOR_VOLTAGE, \\\n\t.owner\t\t= THIS_MODULE, \\\n\t.n_voltages\t= 1, \\\n\t.min_uV\t\t= MAX14577_REGULATOR_SAFEOUT_VOLTAGE, \\\n\t.enable_reg\t= MAX14577_REG_CONTROL2, \\\n\t.enable_mask\t= CTRL2_SFOUTORD_MASK, \\\n}\n#define MAX14577_CHARGER_REG\t{ \\\n\t.name\t\t= \"CHARGER\", \\\n\t.of_match\t= of_match_ptr(\"CHARGER\"), \\\n\t.regulators_node = of_match_ptr(\"regulators\"), \\\n\t.id\t\t= MAX14577_CHARGER, \\\n\t.ops\t\t= &max14577_charger_ops, \\\n\t.type\t\t= REGULATOR_CURRENT, \\\n\t.owner\t\t= THIS_MODULE, \\\n\t.enable_reg\t= MAX14577_CHG_REG_CHG_CTRL2, \\\n\t.enable_mask\t= CHGCTRL2_MBCHOSTEN_MASK, \\\n}\n\nstatic const struct regulator_desc max14577_supported_regulators[] = {\n\t[MAX14577_SAFEOUT] = MAX14577_SAFEOUT_REG,\n\t[MAX14577_CHARGER] = MAX14577_CHARGER_REG,\n};\n\nstatic const struct regulator_ops max77836_ldo_ops = {\n\t.is_enabled\t\t= regulator_is_enabled_regmap,\n\t.enable\t\t\t= regulator_enable_regmap,\n\t.disable\t\t= regulator_disable_regmap,\n\t.list_voltage\t\t= regulator_list_voltage_linear,\n\t.map_voltage\t\t= regulator_map_voltage_linear,\n\t.get_voltage_sel\t= regulator_get_voltage_sel_regmap,\n\t.set_voltage_sel\t= regulator_set_voltage_sel_regmap,\n\t \n};\n\n#define MAX77836_LDO_REG(num)\t{ \\\n\t.name\t\t= \"LDO\" # num, \\\n\t.of_match\t= of_match_ptr(\"LDO\" # num), \\\n\t.regulators_node = of_match_ptr(\"regulators\"), \\\n\t.id\t\t= MAX77836_LDO ## num, \\\n\t.ops\t\t= &max77836_ldo_ops, \\\n\t.type\t\t= REGULATOR_VOLTAGE, \\\n\t.owner\t\t= THIS_MODULE, \\\n\t.n_voltages\t= MAX77836_REGULATOR_LDO_VOLTAGE_STEPS_NUM, \\\n\t.min_uV\t\t= MAX77836_REGULATOR_LDO_VOLTAGE_MIN, \\\n\t.uV_step\t= MAX77836_REGULATOR_LDO_VOLTAGE_STEP, \\\n\t.enable_reg\t= MAX77836_LDO_REG_CNFG1_LDO ## num, \\\n\t.enable_mask\t= MAX77836_CNFG1_LDO_PWRMD_MASK, \\\n\t.vsel_reg\t= MAX77836_LDO_REG_CNFG1_LDO ## num, \\\n\t.vsel_mask\t= MAX77836_CNFG1_LDO_TV_MASK, \\\n}\n\nstatic const struct regulator_desc max77836_supported_regulators[] = {\n\t[MAX14577_SAFEOUT] = MAX14577_SAFEOUT_REG,\n\t[MAX14577_CHARGER] = MAX14577_CHARGER_REG,\n\t[MAX77836_LDO1] = MAX77836_LDO_REG(1),\n\t[MAX77836_LDO2] = MAX77836_LDO_REG(2),\n};\n\n \nstatic struct regmap *max14577_get_regmap(struct max14577 *max14577,\n\t\tint reg_id)\n{\n\tswitch (max14577->dev_type) {\n\tcase MAXIM_DEVICE_TYPE_MAX77836:\n\t\tswitch (reg_id) {\n\t\tcase MAX77836_SAFEOUT ... MAX77836_CHARGER:\n\t\t\treturn max14577->regmap;\n\t\tdefault:\n\t\t\t \n\t\t\treturn max14577->regmap_pmic;\n\t\t}\n\n\tcase MAXIM_DEVICE_TYPE_MAX14577:\n\tdefault:\n\t\treturn max14577->regmap;\n\t}\n}\n\nstatic int max14577_regulator_probe(struct platform_device *pdev)\n{\n\tstruct max14577 *max14577 = dev_get_drvdata(pdev->dev.parent);\n\tstruct max14577_platform_data *pdata = dev_get_platdata(max14577->dev);\n\tint i, ret = 0;\n\tstruct regulator_config config = {};\n\tconst struct regulator_desc *supported_regulators;\n\tunsigned int supported_regulators_size;\n\tenum maxim_device_type dev_type = max14577->dev_type;\n\n\tswitch (dev_type) {\n\tcase MAXIM_DEVICE_TYPE_MAX77836:\n\t\tsupported_regulators = max77836_supported_regulators;\n\t\tsupported_regulators_size = ARRAY_SIZE(max77836_supported_regulators);\n\t\tbreak;\n\tcase MAXIM_DEVICE_TYPE_MAX14577:\n\tdefault:\n\t\tsupported_regulators = max14577_supported_regulators;\n\t\tsupported_regulators_size = ARRAY_SIZE(max14577_supported_regulators);\n\t}\n\n\tconfig.dev = max14577->dev;\n\tconfig.driver_data = max14577;\n\n\tfor (i = 0; i < supported_regulators_size; i++) {\n\t\tstruct regulator_dev *regulator;\n\t\t \n\t\tif (pdata && pdata->regulators) {\n\t\t\tconfig.init_data = pdata->regulators[i].initdata;\n\t\t\tconfig.of_node = pdata->regulators[i].of_node;\n\t\t}\n\t\tconfig.regmap = max14577_get_regmap(max14577,\n\t\t\t\tsupported_regulators[i].id);\n\n\t\tregulator = devm_regulator_register(&pdev->dev,\n\t\t\t\t&supported_regulators[i], &config);\n\t\tif (IS_ERR(regulator)) {\n\t\t\tret = PTR_ERR(regulator);\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\t\"Regulator init failed for %d/%s with error: %d\\n\",\n\t\t\t\t\ti, supported_regulators[i].name, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic const struct platform_device_id max14577_regulator_id[] = {\n\t{ \"max14577-regulator\", MAXIM_DEVICE_TYPE_MAX14577, },\n\t{ \"max77836-regulator\", MAXIM_DEVICE_TYPE_MAX77836, },\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, max14577_regulator_id);\n\nstatic struct platform_driver max14577_regulator_driver = {\n\t.driver = {\n\t\t   .name = \"max14577-regulator\",\n\t\t   .probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t   },\n\t.probe\t\t= max14577_regulator_probe,\n\t.id_table\t= max14577_regulator_id,\n};\n\nstatic int __init max14577_regulator_init(void)\n{\n\tBUILD_BUG_ON(ARRAY_SIZE(max14577_supported_regulators) != MAX14577_REGULATOR_NUM);\n\tBUILD_BUG_ON(ARRAY_SIZE(max77836_supported_regulators) != MAX77836_REGULATOR_NUM);\n\n\tBUILD_BUG_ON(MAX77836_REGULATOR_LDO_VOLTAGE_MIN +\n\t\t\t(MAX77836_REGULATOR_LDO_VOLTAGE_STEP *\n\t\t\t  (MAX77836_REGULATOR_LDO_VOLTAGE_STEPS_NUM - 1)) !=\n\t\t\tMAX77836_REGULATOR_LDO_VOLTAGE_MAX);\n\n\treturn platform_driver_register(&max14577_regulator_driver);\n}\nsubsys_initcall(max14577_regulator_init);\n\nstatic void __exit max14577_regulator_exit(void)\n{\n\tplatform_driver_unregister(&max14577_regulator_driver);\n}\nmodule_exit(max14577_regulator_exit);\n\nMODULE_AUTHOR(\"Krzysztof Kozlowski <krzk@kernel.org>\");\nMODULE_DESCRIPTION(\"Maxim 14577/77836 regulator driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}