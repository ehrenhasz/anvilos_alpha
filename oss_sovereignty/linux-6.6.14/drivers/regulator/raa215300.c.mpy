{
  "module_name": "raa215300.c",
  "hash_id": "c56441d2920788b9a6540275baeb042e126ee6b14acbf9f1c43cb440b29901f6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/regulator/raa215300.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/clk.h>\n#include <linux/clkdev.h>\n#include <linux/clk-provider.h>\n#include <linux/err.h>\n#include <linux/i2c.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n\n#define RAA215300_FAULT_LATCHED_STATUS_1\t0x59\n#define RAA215300_FAULT_LATCHED_STATUS_2\t0x5a\n#define RAA215300_FAULT_LATCHED_STATUS_3\t0x5b\n#define RAA215300_FAULT_LATCHED_STATUS_4\t0x5c\n#define RAA215300_FAULT_LATCHED_STATUS_6\t0x5e\n\n#define RAA215300_INT_MASK_1\t0x64\n#define RAA215300_INT_MASK_2\t0x65\n#define RAA215300_INT_MASK_3\t0x66\n#define RAA215300_INT_MASK_4\t0x67\n#define RAA215300_INT_MASK_6\t0x68\n\n#define RAA215300_REG_BLOCK_EN\t0x6c\n#define RAA215300_HW_REV\t0xf8\n\n#define RAA215300_INT_MASK_1_ALL\tGENMASK(5, 0)\n#define RAA215300_INT_MASK_2_ALL\tGENMASK(3, 0)\n#define RAA215300_INT_MASK_3_ALL\tGENMASK(5, 0)\n#define RAA215300_INT_MASK_4_ALL\tBIT(0)\n#define RAA215300_INT_MASK_6_ALL\tGENMASK(7, 0)\n\n#define RAA215300_REG_BLOCK_EN_RTC_EN\tBIT(6)\n#define RAA215300_RTC_DEFAULT_ADDR\t0x6f\n\nstatic const struct regmap_config raa215300_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = 0xff,\n};\n\nstatic void raa215300_rtc_unregister_device(void *data)\n{\n\ti2c_unregister_device(data);\n}\n\nstatic int raa215300_clk_present(struct i2c_client *client, const char *name)\n{\n\tstruct clk *clk;\n\n\tclk = devm_clk_get_optional(&client->dev, name);\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\treturn !!clk;\n}\n\nstatic int raa215300_i2c_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tconst char *clkin_name = \"clkin\";\n\tunsigned int pmic_version, val;\n\tconst char *xin_name = \"xin\";\n\tconst char *clk_name = NULL;\n\tstruct regmap *regmap;\n\tint ret;\n\n\tregmap = devm_regmap_init_i2c(client, &raa215300_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn dev_err_probe(dev, PTR_ERR(regmap),\n\t\t\t\t     \"regmap i2c init failed\\n\");\n\n\tret = regmap_read(regmap, RAA215300_HW_REV, &pmic_version);\n\tif (ret < 0)\n\t\treturn dev_err_probe(dev, ret, \"HW rev read failed\\n\");\n\n\tdev_dbg(dev, \"RAA215300 PMIC version 0x%04x\\n\", pmic_version);\n\n\t \n\tregmap_read(regmap, RAA215300_REG_BLOCK_EN, &val);\n\tval &= RAA215300_REG_BLOCK_EN_RTC_EN;\n\tregmap_write(regmap, RAA215300_REG_BLOCK_EN, val);\n\n\t \n\tregmap_read(regmap, RAA215300_FAULT_LATCHED_STATUS_1, &val);\n\tregmap_write(regmap, RAA215300_FAULT_LATCHED_STATUS_1, val);\n\tregmap_read(regmap, RAA215300_FAULT_LATCHED_STATUS_2, &val);\n\tregmap_write(regmap, RAA215300_FAULT_LATCHED_STATUS_2, val);\n\tregmap_read(regmap, RAA215300_FAULT_LATCHED_STATUS_3, &val);\n\tregmap_write(regmap, RAA215300_FAULT_LATCHED_STATUS_3, val);\n\tregmap_read(regmap, RAA215300_FAULT_LATCHED_STATUS_4, &val);\n\tregmap_write(regmap, RAA215300_FAULT_LATCHED_STATUS_4, val);\n\tregmap_read(regmap, RAA215300_FAULT_LATCHED_STATUS_6, &val);\n\tregmap_write(regmap, RAA215300_FAULT_LATCHED_STATUS_6, val);\n\n\t \n\tregmap_write(regmap, RAA215300_INT_MASK_1, RAA215300_INT_MASK_1_ALL);\n\tregmap_write(regmap, RAA215300_INT_MASK_2, RAA215300_INT_MASK_2_ALL);\n\tregmap_write(regmap, RAA215300_INT_MASK_3, RAA215300_INT_MASK_3_ALL);\n\tregmap_write(regmap, RAA215300_INT_MASK_4, RAA215300_INT_MASK_4_ALL);\n\tregmap_write(regmap, RAA215300_INT_MASK_6, RAA215300_INT_MASK_6_ALL);\n\n\tret = raa215300_clk_present(client, xin_name);\n\tif (ret < 0) {\n\t\treturn ret;\n\t} else if (ret) {\n\t\tclk_name = xin_name;\n\t} else {\n\t\tret = raa215300_clk_present(client, clkin_name);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tif (ret)\n\t\t\tclk_name = clkin_name;\n\t}\n\n\tif (clk_name) {\n\t\tconst char *name = pmic_version >= 0x12 ? \"isl1208\" : \"raa215300_a0\";\n\t\tstruct device_node *np = client->dev.of_node;\n\t\tu32 addr = RAA215300_RTC_DEFAULT_ADDR;\n\t\tstruct i2c_board_info info = {};\n\t\tstruct i2c_client *rtc_client;\n\t\tstruct clk_hw *hw;\n\t\tssize_t size;\n\n\t\thw = devm_clk_hw_register_fixed_rate(dev, clk_name, NULL, 0, 32768);\n\t\tif (IS_ERR(hw))\n\t\t\treturn PTR_ERR(hw);\n\n\t\tret = devm_clk_hw_register_clkdev(dev, hw, clk_name, NULL);\n\t\tif (ret)\n\t\t\treturn dev_err_probe(dev, ret, \"Failed to initialize clkdev\\n\");\n\n\t\tif (np) {\n\t\t\tint i;\n\n\t\t\ti = of_property_match_string(np, \"reg-names\", \"rtc\");\n\t\t\tif (i >= 0)\n\t\t\t\tof_property_read_u32_index(np, \"reg\", i, &addr);\n\t\t}\n\n\t\tinfo.addr = addr;\n\t\tif (client->irq > 0)\n\t\t\tinfo.irq = client->irq;\n\n\t\tsize = strscpy(info.type, name, sizeof(info.type));\n\t\tif (size < 0)\n\t\t\treturn dev_err_probe(dev, size,\n\t\t\t\t\t     \"Invalid device name: %s\\n\", name);\n\n\t\t \n\t\tregmap_update_bits(regmap, RAA215300_REG_BLOCK_EN,\n\t\t\t\t   RAA215300_REG_BLOCK_EN_RTC_EN,\n\t\t\t\t   RAA215300_REG_BLOCK_EN_RTC_EN);\n\n\t\trtc_client = i2c_new_client_device(client->adapter, &info);\n\t\tif (IS_ERR(rtc_client))\n\t\t\treturn PTR_ERR(rtc_client);\n\n\t\tret = devm_add_action_or_reset(dev,\n\t\t\t\t\t       raa215300_rtc_unregister_device,\n\t\t\t\t\t       rtc_client);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id raa215300_dt_match[] = {\n\t{ .compatible = \"renesas,raa215300\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, raa215300_dt_match);\n\nstatic struct i2c_driver raa215300_i2c_driver = {\n\t.driver = {\n\t\t.name = \"raa215300\",\n\t\t.of_match_table = raa215300_dt_match,\n\t},\n\t.probe = raa215300_i2c_probe,\n};\nmodule_i2c_driver(raa215300_i2c_driver);\n\nMODULE_DESCRIPTION(\"Renesas RAA215300 PMIC driver\");\nMODULE_AUTHOR(\"Fabrizio Castro <fabrizio.castro.jz@renesas.com>\");\nMODULE_AUTHOR(\"Biju Das <biju.das.jz@bp.renesas.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}