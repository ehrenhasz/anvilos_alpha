{
  "module_name": "gpio_backlight.c",
  "hash_id": "f4196eff3e2e060552b8cd64ce1b4f40fdc8a4820de0267802fe6566ea4d3cdb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/gpio_backlight.c",
  "human_readable_source": "\n \n\n#include <linux/backlight.h>\n#include <linux/err.h>\n#include <linux/fb.h>\n#include <linux/gpio/consumer.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_data/gpio_backlight.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/slab.h>\n\nstruct gpio_backlight {\n\tstruct device *dev;\n\tstruct gpio_desc *gpiod;\n};\n\nstatic int gpio_backlight_update_status(struct backlight_device *bl)\n{\n\tstruct gpio_backlight *gbl = bl_get_data(bl);\n\n\tgpiod_set_value_cansleep(gbl->gpiod, backlight_get_brightness(bl));\n\n\treturn 0;\n}\n\nstatic int gpio_backlight_check_fb(struct backlight_device *bl,\n\t\t\t\t   struct fb_info *info)\n{\n\tstruct gpio_backlight *gbl = bl_get_data(bl);\n\n\treturn !gbl->dev || gbl->dev == info->device;\n}\n\nstatic const struct backlight_ops gpio_backlight_ops = {\n\t.options\t= BL_CORE_SUSPENDRESUME,\n\t.update_status\t= gpio_backlight_update_status,\n\t.check_fb\t= gpio_backlight_check_fb,\n};\n\nstatic int gpio_backlight_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct gpio_backlight_platform_data *pdata = dev_get_platdata(dev);\n\tstruct device_node *of_node = dev->of_node;\n\tstruct backlight_properties props;\n\tstruct backlight_device *bl;\n\tstruct gpio_backlight *gbl;\n\tint ret, init_brightness, def_value;\n\n\tgbl = devm_kzalloc(dev, sizeof(*gbl), GFP_KERNEL);\n\tif (gbl == NULL)\n\t\treturn -ENOMEM;\n\n\tif (pdata)\n\t\tgbl->dev = pdata->dev;\n\n\tdef_value = device_property_read_bool(dev, \"default-on\");\n\n\tgbl->gpiod = devm_gpiod_get(dev, NULL, GPIOD_ASIS);\n\tif (IS_ERR(gbl->gpiod)) {\n\t\tret = PTR_ERR(gbl->gpiod);\n\t\tif (ret != -EPROBE_DEFER)\n\t\t\tdev_err(dev,\n\t\t\t\t\"Error: The gpios parameter is missing or invalid.\\n\");\n\t\treturn ret;\n\t}\n\n\tmemset(&props, 0, sizeof(props));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = 1;\n\tbl = devm_backlight_device_register(dev, dev_name(dev), dev, gbl,\n\t\t\t\t\t    &gpio_backlight_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\n\t \n\tif (!of_node || !of_node->phandle)\n\t\t \n\t\tbl->props.power = def_value ? FB_BLANK_UNBLANK\n\t\t\t\t\t    : FB_BLANK_POWERDOWN;\n\telse if (gpiod_get_value_cansleep(gbl->gpiod) == 0)\n\t\tbl->props.power = FB_BLANK_POWERDOWN;\n\telse\n\t\tbl->props.power = FB_BLANK_UNBLANK;\n\n\tbl->props.brightness = 1;\n\n\tinit_brightness = backlight_get_brightness(bl);\n\tret = gpiod_direction_output(gbl->gpiod, init_brightness);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to set initial brightness\\n\");\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, bl);\n\treturn 0;\n}\n\nstatic struct of_device_id gpio_backlight_of_match[] = {\n\t{ .compatible = \"gpio-backlight\" },\n\t{   }\n};\n\nMODULE_DEVICE_TABLE(of, gpio_backlight_of_match);\n\nstatic struct platform_driver gpio_backlight_driver = {\n\t.driver\t\t= {\n\t\t.name\t\t= \"gpio-backlight\",\n\t\t.of_match_table = gpio_backlight_of_match,\n\t},\n\t.probe\t\t= gpio_backlight_probe,\n};\n\nmodule_platform_driver(gpio_backlight_driver);\n\nMODULE_AUTHOR(\"Laurent Pinchart <laurent.pinchart@ideasonboard.com>\");\nMODULE_DESCRIPTION(\"GPIO-based Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:gpio-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}