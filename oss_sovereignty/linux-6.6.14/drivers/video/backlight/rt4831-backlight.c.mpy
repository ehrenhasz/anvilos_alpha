{
  "module_name": "rt4831-backlight.c",
  "hash_id": "faccaf7686530dc3f593b87b6100b39c59bfbc172faa6fb4071503f69fbee4d4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/rt4831-backlight.c",
  "human_readable_source": "\n\n#include <dt-bindings/leds/rt4831-backlight.h>\n#include <linux/backlight.h>\n#include <linux/bitops.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/regmap.h>\n\n#define RT4831_REG_BLCFG\t0x02\n#define RT4831_REG_BLDIML\t0x04\n#define RT4831_REG_ENABLE\t0x08\n#define RT4831_REG_BLOPT2\t0x11\n\n#define RT4831_BLMAX_BRIGHTNESS\t2048\n\n#define RT4831_BLOVP_MASK\tGENMASK(7, 5)\n#define RT4831_BLOVP_SHIFT\t5\n#define RT4831_BLPWMEN_MASK\tBIT(0)\n#define RT4831_BLEN_MASK\tBIT(4)\n#define RT4831_BLCH_MASK\tGENMASK(3, 0)\n#define RT4831_BLDIML_MASK\tGENMASK(2, 0)\n#define RT4831_BLDIMH_MASK\tGENMASK(10, 3)\n#define RT4831_BLDIMH_SHIFT\t3\n#define RT4831_BLOCP_MASK\tGENMASK(1, 0)\n\n#define RT4831_BLOCP_MINUA\t900000\n#define RT4831_BLOCP_MAXUA\t1800000\n#define RT4831_BLOCP_STEPUA\t300000\n\nstruct rt4831_priv {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tstruct backlight_device *bl;\n};\n\nstatic int rt4831_bl_update_status(struct backlight_device *bl_dev)\n{\n\tstruct rt4831_priv *priv = bl_get_data(bl_dev);\n\tint brightness = backlight_get_brightness(bl_dev);\n\tunsigned int enable = brightness ? RT4831_BLEN_MASK : 0;\n\tu8 v[2];\n\tint ret;\n\n\tif (brightness) {\n\t\tv[0] = (brightness - 1) & RT4831_BLDIML_MASK;\n\t\tv[1] = ((brightness - 1) & RT4831_BLDIMH_MASK) >> RT4831_BLDIMH_SHIFT;\n\n\t\tret = regmap_raw_write(priv->regmap, RT4831_REG_BLDIML, v, sizeof(v));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn regmap_update_bits(priv->regmap, RT4831_REG_ENABLE, RT4831_BLEN_MASK, enable);\n\n}\n\nstatic int rt4831_bl_get_brightness(struct backlight_device *bl_dev)\n{\n\tstruct rt4831_priv *priv = bl_get_data(bl_dev);\n\tunsigned int val;\n\tu8 v[2];\n\tint ret;\n\n\tret = regmap_read(priv->regmap, RT4831_REG_ENABLE, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(val & RT4831_BLEN_MASK))\n\t\treturn 0;\n\n\tret = regmap_raw_read(priv->regmap, RT4831_REG_BLDIML, v, sizeof(v));\n\tif (ret)\n\t\treturn ret;\n\n\tret = (v[1] << RT4831_BLDIMH_SHIFT) + (v[0] & RT4831_BLDIML_MASK) + 1;\n\n\treturn ret;\n}\n\nstatic const struct backlight_ops rt4831_bl_ops = {\n\t.options = BL_CORE_SUSPENDRESUME,\n\t.update_status = rt4831_bl_update_status,\n\t.get_brightness = rt4831_bl_get_brightness,\n};\n\nstatic int rt4831_parse_backlight_properties(struct rt4831_priv *priv,\n\t\t\t\t\t     struct backlight_properties *bl_props)\n{\n\tstruct device *dev = priv->dev;\n\tu8 propval;\n\tu32 brightness, ocp_uA;\n\tunsigned int val = 0;\n\tint ret;\n\n\t \n\tret = device_property_read_u32(dev, \"max-brightness\", &brightness);\n\tif (ret)\n\t\tbrightness = RT4831_BLMAX_BRIGHTNESS;\n\n\tbl_props->max_brightness = min_t(u32, brightness, RT4831_BLMAX_BRIGHTNESS);\n\n\tret = device_property_read_u32(dev, \"default-brightness\", &brightness);\n\tif (ret)\n\t\tbrightness = bl_props->max_brightness;\n\n\tbl_props->brightness = min_t(u32, brightness, bl_props->max_brightness);\n\n\t \n\tif (device_property_read_bool(dev, \"richtek,pwm-enable\"))\n\t\tval = RT4831_BLPWMEN_MASK;\n\n\tret = regmap_update_bits(priv->regmap, RT4831_REG_BLCFG, RT4831_BLPWMEN_MASK, val);\n\tif (ret)\n\t\treturn ret;\n\n\tret = device_property_read_u8(dev, \"richtek,bled-ovp-sel\", &propval);\n\tif (ret)\n\t\tpropval = RT4831_BLOVPLVL_21V;\n\n\tpropval = min_t(u8, propval, RT4831_BLOVPLVL_29V);\n\tret = regmap_update_bits(priv->regmap, RT4831_REG_BLCFG, RT4831_BLOVP_MASK,\n\t\t\t\t propval << RT4831_BLOVP_SHIFT);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = device_property_read_u32(dev, \"richtek,bled-ocp-microamp\",\n\t\t\t\t       &ocp_uA);\n\tif (!ret) {\n\t\tocp_uA = clamp_val(ocp_uA, RT4831_BLOCP_MINUA,\n\t\t\t\t   RT4831_BLOCP_MAXUA);\n\t\tval = DIV_ROUND_UP(ocp_uA - RT4831_BLOCP_MINUA,\n\t\t\t\t   RT4831_BLOCP_STEPUA);\n\t\tret = regmap_update_bits(priv->regmap, RT4831_REG_BLOPT2,\n\t\t\t\t\t RT4831_BLOCP_MASK, val);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = device_property_read_u8(dev, \"richtek,channel-use\", &propval);\n\tif (ret) {\n\t\tdev_err(dev, \"richtek,channel-use DT property missing\\n\");\n\t\treturn ret;\n\t}\n\n\tif (!(propval & RT4831_BLCH_MASK)) {\n\t\tdev_err(dev, \"No channel specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn regmap_update_bits(priv->regmap, RT4831_REG_ENABLE, RT4831_BLCH_MASK, propval);\n}\n\nstatic int rt4831_bl_probe(struct platform_device *pdev)\n{\n\tstruct rt4831_priv *priv;\n\tstruct backlight_properties bl_props = { .type = BACKLIGHT_RAW,\n\t\t\t\t\t\t .scale = BACKLIGHT_SCALE_LINEAR };\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = &pdev->dev;\n\n\tpriv->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!priv->regmap) {\n\t\tdev_err(&pdev->dev, \"Failed to init regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tret = rt4831_parse_backlight_properties(priv, &bl_props);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to parse backlight properties\\n\");\n\t\treturn ret;\n\t}\n\n\tpriv->bl = devm_backlight_device_register(&pdev->dev, pdev->name, &pdev->dev, priv,\n\t\t\t\t\t\t  &rt4831_bl_ops, &bl_props);\n\tif (IS_ERR(priv->bl)) {\n\t\tdev_err(&pdev->dev, \"Failed to register backlight\\n\");\n\t\treturn PTR_ERR(priv->bl);\n\t}\n\n\tbacklight_update_status(priv->bl);\n\tplatform_set_drvdata(pdev, priv);\n\n\treturn 0;\n}\n\nstatic void rt4831_bl_remove(struct platform_device *pdev)\n{\n\tstruct rt4831_priv *priv = platform_get_drvdata(pdev);\n\tstruct backlight_device *bl_dev = priv->bl;\n\n\tbl_dev->props.brightness = 0;\n\tbacklight_update_status(priv->bl);\n}\n\nstatic const struct of_device_id __maybe_unused rt4831_bl_of_match[] = {\n\t{ .compatible = \"richtek,rt4831-backlight\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, rt4831_bl_of_match);\n\nstatic struct platform_driver rt4831_bl_driver = {\n\t.driver = {\n\t\t.name = \"rt4831-backlight\",\n\t\t.of_match_table = rt4831_bl_of_match,\n\t},\n\t.probe = rt4831_bl_probe,\n\t.remove_new = rt4831_bl_remove,\n};\nmodule_platform_driver(rt4831_bl_driver);\n\nMODULE_AUTHOR(\"ChiYuan Huang <cy_huang@richtek.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}