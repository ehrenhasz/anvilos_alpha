{
  "module_name": "mt6370-backlight.c",
  "hash_id": "6dec2a08ae356a57ae8d9b0b064301ebc797acc9f5de8e179d780df26b2f54ed",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/mt6370-backlight.c",
  "human_readable_source": "\n \n\n#include <linux/backlight.h>\n#include <linux/bitfield.h>\n#include <linux/bits.h>\n#include <linux/gpio/consumer.h>\n#include <linux/kernel.h>\n#include <linux/minmax.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/regmap.h>\n\n#define MT6370_REG_DEV_INFO\t\t0x100\n#define MT6370_REG_BL_EN\t\t0x1A0\n#define MT6370_REG_BL_BSTCTRL\t\t0x1A1\n#define MT6370_REG_BL_PWM\t\t0x1A2\n#define MT6370_REG_BL_DIM2\t\t0x1A4\n\n#define MT6370_VENID_MASK\t\tGENMASK(7, 4)\n#define MT6370_BL_EXT_EN_MASK\t\tBIT(7)\n#define MT6370_BL_EN_MASK\t\tBIT(6)\n#define MT6370_BL_CODE_MASK\t\tBIT(0)\n#define MT6370_BL_CH_MASK\t\tGENMASK(5, 2)\n#define MT6370_BL_CH_SHIFT\t\t2\n#define MT6370_BL_DIM2_COMMON_MASK\tGENMASK(2, 0)\n#define MT6370_BL_DIM2_COMMON_SHIFT\t3\n#define MT6370_BL_DIM2_6372_MASK\tGENMASK(5, 0)\n#define MT6370_BL_DIM2_6372_SHIFT\t6\n#define MT6370_BL_PWM_EN_MASK\t\tBIT(7)\n#define MT6370_BL_PWM_HYS_EN_MASK\tBIT(2)\n#define MT6370_BL_PWM_HYS_SEL_MASK\tGENMASK(1, 0)\n#define MT6370_BL_OVP_EN_MASK\t\tBIT(7)\n#define MT6370_BL_OVP_SEL_MASK\t\tGENMASK(6, 5)\n#define MT6370_BL_OVP_SEL_SHIFT\t\t5\n#define MT6370_BL_OC_EN_MASK\t\tBIT(3)\n#define MT6370_BL_OC_SEL_MASK\t\tGENMASK(2, 1)\n#define MT6370_BL_OC_SEL_SHIFT\t\t1\n\n#define MT6370_BL_PWM_HYS_TH_MIN_STEP\t1\n#define MT6370_BL_PWM_HYS_TH_MAX_STEP\t64\n#define MT6370_BL_OVP_MIN_UV\t\t17000000\n#define MT6370_BL_OVP_MAX_UV\t\t29000000\n#define MT6370_BL_OVP_STEP_UV\t\t4000000\n#define MT6370_BL_OCP_MIN_UA\t\t900000\n#define MT6370_BL_OCP_MAX_UA\t\t1800000\n#define MT6370_BL_OCP_STEP_UA\t\t300000\n#define MT6370_BL_MAX_COMMON_BRIGHTNESS\t2048\n#define MT6370_BL_MAX_6372_BRIGHTNESS\t16384\n#define MT6370_BL_MAX_CH\t\t15\n\nenum {\n\tMT6370_VID_COMMON = 1,\n\tMT6370_VID_6372,\n};\n\nstruct mt6370_priv {\n\tu8 dim2_mask;\n\tu8 dim2_shift;\n\tint def_max_brightness;\n\tstruct backlight_device *bl;\n\tstruct device *dev;\n\tstruct gpio_desc *enable_gpio;\n\tstruct regmap *regmap;\n};\n\nstatic int mt6370_bl_update_status(struct backlight_device *bl_dev)\n{\n\tstruct mt6370_priv *priv = bl_get_data(bl_dev);\n\tint brightness = backlight_get_brightness(bl_dev);\n\tunsigned int enable_val;\n\tu8 brightness_val[2];\n\tint ret;\n\n\tif (brightness) {\n\t\tbrightness_val[0] = (brightness - 1) & priv->dim2_mask;\n\t\tbrightness_val[1] = (brightness - 1) >> priv->dim2_shift;\n\n\t\tret = regmap_raw_write(priv->regmap, MT6370_REG_BL_DIM2,\n\t\t\t\t       brightness_val, sizeof(brightness_val));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tgpiod_set_value(priv->enable_gpio, !!brightness);\n\n\tenable_val = brightness ? MT6370_BL_EN_MASK : 0;\n\treturn regmap_update_bits(priv->regmap, MT6370_REG_BL_EN,\n\t\t\t\t  MT6370_BL_EN_MASK, enable_val);\n}\n\nstatic int mt6370_bl_get_brightness(struct backlight_device *bl_dev)\n{\n\tstruct mt6370_priv *priv = bl_get_data(bl_dev);\n\tunsigned int enable;\n\tu8 brightness_val[2];\n\tint brightness, ret;\n\n\tret = regmap_read(priv->regmap, MT6370_REG_BL_EN, &enable);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(enable & MT6370_BL_EN_MASK))\n\t\treturn 0;\n\n\tret = regmap_raw_read(priv->regmap, MT6370_REG_BL_DIM2,\n\t\t\t      brightness_val, sizeof(brightness_val));\n\tif (ret)\n\t\treturn ret;\n\n\tbrightness = brightness_val[1] << priv->dim2_shift;\n\tbrightness += brightness_val[0] & priv->dim2_mask;\n\n\treturn brightness + 1;\n}\n\nstatic const struct backlight_ops mt6370_bl_ops = {\n\t.options = BL_CORE_SUSPENDRESUME,\n\t.update_status = mt6370_bl_update_status,\n\t.get_brightness = mt6370_bl_get_brightness,\n};\n\nstatic int mt6370_init_backlight_properties(struct mt6370_priv *priv,\n\t\t\t\t\t    struct backlight_properties *props)\n{\n\tstruct device *dev = priv->dev;\n\tu8 prop_val;\n\tu32 brightness, ovp_uV, ocp_uA;\n\tunsigned int mask, val;\n\tint ret;\n\n\t \n\tval = 0;\n\tif (device_property_read_bool(dev, \"mediatek,bled-pwm-enable\"))\n\t\tval |= MT6370_BL_PWM_EN_MASK;\n\n\tif (device_property_read_bool(dev, \"mediatek,bled-pwm-hys-enable\"))\n\t\tval |= MT6370_BL_PWM_HYS_EN_MASK;\n\n\tret = device_property_read_u8(dev,\n\t\t\t\t      \"mediatek,bled-pwm-hys-input-th-steps\",\n\t\t\t\t      &prop_val);\n\tif (!ret) {\n\t\tprop_val = clamp_val(prop_val,\n\t\t\t\t     MT6370_BL_PWM_HYS_TH_MIN_STEP,\n\t\t\t\t     MT6370_BL_PWM_HYS_TH_MAX_STEP);\n\t\tprop_val = prop_val <= 1 ? 0 :\n\t\t\t   prop_val <= 4 ? 1 :\n\t\t\t   prop_val <= 16 ? 2 : 3;\n\t\tval |= prop_val;\n\t}\n\n\tret = regmap_update_bits(priv->regmap, MT6370_REG_BL_PWM,\n\t\t\t\t val, val);\n\tif (ret)\n\t\treturn ret;\n\n\tval = 0;\n\tif (device_property_read_bool(dev, \"mediatek,bled-ovp-shutdown\"))\n\t\tval |= MT6370_BL_OVP_EN_MASK;\n\n\tret = device_property_read_u32(dev, \"mediatek,bled-ovp-microvolt\",\n\t\t\t\t       &ovp_uV);\n\tif (!ret) {\n\t\tovp_uV = clamp_val(ovp_uV, MT6370_BL_OVP_MIN_UV,\n\t\t\t\t   MT6370_BL_OVP_MAX_UV);\n\t\tovp_uV = DIV_ROUND_UP(ovp_uV - MT6370_BL_OVP_MIN_UV,\n\t\t\t\t      MT6370_BL_OVP_STEP_UV);\n\t\tval |= ovp_uV << MT6370_BL_OVP_SEL_SHIFT;\n\t}\n\n\tif (device_property_read_bool(dev, \"mediatek,bled-ocp-shutdown\"))\n\t\tval |= MT6370_BL_OC_EN_MASK;\n\n\tret = device_property_read_u32(dev, \"mediatek,bled-ocp-microamp\",\n\t\t\t\t       &ocp_uA);\n\tif (!ret) {\n\t\tocp_uA = clamp_val(ocp_uA, MT6370_BL_OCP_MIN_UA,\n\t\t\t\t   MT6370_BL_OCP_MAX_UA);\n\t\tocp_uA = DIV_ROUND_UP(ocp_uA - MT6370_BL_OCP_MIN_UA,\n\t\t\t\t      MT6370_BL_OCP_STEP_UA);\n\t\tval |= ocp_uA << MT6370_BL_OC_SEL_SHIFT;\n\t}\n\n\tret = regmap_update_bits(priv->regmap, MT6370_REG_BL_BSTCTRL,\n\t\t\t\t val, val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = device_property_read_u32(dev, \"max-brightness\", &brightness);\n\tif (ret)\n\t\tbrightness = priv->def_max_brightness;\n\n\tprops->max_brightness = min_t(u32, brightness, priv->def_max_brightness);\n\n\tret = device_property_read_u32(dev, \"default-brightness\", &brightness);\n\tif (ret)\n\t\tbrightness = props->max_brightness;\n\n\tprops->brightness = min_t(u32, brightness, props->max_brightness);\n\n\tval = 0;\n\tif (device_property_read_bool(dev, \"mediatek,bled-exponential-mode-enable\")) {\n\t\tval |= MT6370_BL_CODE_MASK;\n\t\tprops->scale = BACKLIGHT_SCALE_NON_LINEAR;\n\t} else\n\t\tprops->scale = BACKLIGHT_SCALE_LINEAR;\n\n\tret = device_property_read_u8(dev, \"mediatek,bled-channel-use\",\n\t\t\t\t      &prop_val);\n\tif (ret) {\n\t\tdev_err(dev, \"mediatek,bled-channel-use DT property missing\\n\");\n\t\treturn ret;\n\t}\n\n\tif (!prop_val || prop_val > MT6370_BL_MAX_CH) {\n\t\tdev_err(dev,\n\t\t\t\"No channel specified or over than upper bound (%d)\\n\",\n\t\t\tprop_val);\n\t\treturn -EINVAL;\n\t}\n\n\tmask = MT6370_BL_EXT_EN_MASK | MT6370_BL_CH_MASK;\n\tval |= prop_val << MT6370_BL_CH_SHIFT;\n\n\tif (priv->enable_gpio)\n\t\tval |= MT6370_BL_EXT_EN_MASK;\n\n\treturn regmap_update_bits(priv->regmap, MT6370_REG_BL_EN, mask, val);\n}\n\nstatic int mt6370_check_vendor_info(struct mt6370_priv *priv)\n{\n\t \n\tunsigned int dev_info, hw_vid, of_vid;\n\tint ret;\n\n\tret = regmap_read(priv->regmap, MT6370_REG_DEV_INFO, &dev_info);\n\tif (ret)\n\t\treturn ret;\n\n\tof_vid = (uintptr_t)device_get_match_data(priv->dev);\n\thw_vid = FIELD_GET(MT6370_VENID_MASK, dev_info);\n\thw_vid = (hw_vid == 0x9 || hw_vid == 0xb) ? MT6370_VID_6372 : MT6370_VID_COMMON;\n\tif (hw_vid != of_vid)\n\t\treturn dev_err_probe(priv->dev, -EINVAL,\n\t\t\t\t     \"Buggy DT, wrong compatible string\\n\");\n\n\tif (hw_vid == MT6370_VID_6372) {\n\t\tpriv->dim2_mask = MT6370_BL_DIM2_6372_MASK;\n\t\tpriv->dim2_shift = MT6370_BL_DIM2_6372_SHIFT;\n\t\tpriv->def_max_brightness = MT6370_BL_MAX_6372_BRIGHTNESS;\n\t} else {\n\t\tpriv->dim2_mask = MT6370_BL_DIM2_COMMON_MASK;\n\t\tpriv->dim2_shift = MT6370_BL_DIM2_COMMON_SHIFT;\n\t\tpriv->def_max_brightness = MT6370_BL_MAX_COMMON_BRIGHTNESS;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt6370_bl_probe(struct platform_device *pdev)\n{\n\tstruct backlight_properties props = {\n\t\t.type = BACKLIGHT_RAW,\n\t};\n\tstruct device *dev = &pdev->dev;\n\tstruct mt6370_priv *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = dev;\n\n\tpriv->regmap = dev_get_regmap(dev->parent, NULL);\n\tif (!priv->regmap)\n\t\treturn dev_err_probe(dev, -ENODEV, \"Failed to get regmap\\n\");\n\n\tret = mt6370_check_vendor_info(priv);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to check vendor info\\n\");\n\n\tpriv->enable_gpio = devm_gpiod_get_optional(dev, \"enable\",\n\t\t\t\t\t\t    GPIOD_OUT_HIGH);\n\tif (IS_ERR(priv->enable_gpio))\n\t\treturn dev_err_probe(dev, PTR_ERR(priv->enable_gpio),\n\t\t\t\t     \"Failed to get 'enable' gpio\\n\");\n\n\tret = mt6370_init_backlight_properties(priv, &props);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"Failed to init backlight properties\\n\");\n\n\tpriv->bl = devm_backlight_device_register(dev, pdev->name, dev, priv,\n\t\t\t\t\t\t  &mt6370_bl_ops, &props);\n\tif (IS_ERR(priv->bl))\n\t\treturn dev_err_probe(dev, PTR_ERR(priv->bl),\n\t\t\t\t     \"Failed to register backlight\\n\");\n\n\tbacklight_update_status(priv->bl);\n\tplatform_set_drvdata(pdev, priv);\n\n\treturn 0;\n}\n\nstatic void mt6370_bl_remove(struct platform_device *pdev)\n{\n\tstruct mt6370_priv *priv = platform_get_drvdata(pdev);\n\tstruct backlight_device *bl_dev = priv->bl;\n\n\tbl_dev->props.brightness = 0;\n\tbacklight_update_status(priv->bl);\n}\n\nstatic const struct of_device_id mt6370_bl_of_match[] = {\n\t{ .compatible = \"mediatek,mt6370-backlight\", .data = (void *)MT6370_VID_COMMON },\n\t{ .compatible = \"mediatek,mt6372-backlight\", .data = (void *)MT6370_VID_6372 },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mt6370_bl_of_match);\n\nstatic struct platform_driver mt6370_bl_driver = {\n\t.driver = {\n\t\t.name = \"mt6370-backlight\",\n\t\t.of_match_table = mt6370_bl_of_match,\n\t},\n\t.probe = mt6370_bl_probe,\n\t.remove_new = mt6370_bl_remove,\n};\nmodule_platform_driver(mt6370_bl_driver);\n\nMODULE_AUTHOR(\"ChiaEn Wu <chiaen_wu@richtek.com>\");\nMODULE_DESCRIPTION(\"MediaTek MT6370 Backlight Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}