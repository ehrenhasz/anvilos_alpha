{
  "module_name": "wm831x_bl.c",
  "hash_id": "4127121531c5b02f7277a152ad22d62fa54e677545c05f3469a84185440fdb6d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/wm831x_bl.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/module.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/slab.h>\n\n#include <linux/mfd/wm831x/core.h>\n#include <linux/mfd/wm831x/pdata.h>\n#include <linux/mfd/wm831x/regulator.h>\n\nstruct wm831x_backlight_data {\n\tstruct wm831x *wm831x;\n\tint isink_reg;\n\tint current_brightness;\n};\n\nstatic int wm831x_backlight_set(struct backlight_device *bl, int brightness)\n{\n\tstruct wm831x_backlight_data *data = bl_get_data(bl);\n\tstruct wm831x *wm831x = data->wm831x;\n\tint power_up = !data->current_brightness && brightness;\n\tint power_down = data->current_brightness && !brightness;\n\tint ret;\n\n\tif (power_up) {\n\t\t \n\t\tret = wm831x_set_bits(wm831x, data->isink_reg,\n\t\t\t\t      WM831X_CS1_ENA, WM831X_CS1_ENA);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\n\t\t \n\t\tret = wm831x_set_bits(wm831x, WM831X_DCDC_ENABLE,\n\t\t\t\t      WM831X_DC4_ENA, WM831X_DC4_ENA);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\t}\n\n\tif (power_down) {\n\t\t \n\t\tret = wm831x_set_bits(wm831x, WM831X_DCDC_ENABLE,\n\t\t\t\t      WM831X_DC4_ENA, 0);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\n\t\t \n\t\tret = wm831x_set_bits(wm831x, data->isink_reg,\n\t\t\t\t      WM831X_CS1_DRIVE | WM831X_CS1_ENA, 0);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\t}\n\n\t \n\tret = wm831x_set_bits(wm831x, data->isink_reg,\n\t\t\t      WM831X_CS1_ISEL_MASK, brightness);\n\tif (ret < 0)\n\t\tgoto err;\n\n\tif (power_up) {\n\t\t \n\t\tret = wm831x_set_bits(wm831x, data->isink_reg,\n\t\t\t\t      WM831X_CS1_DRIVE, WM831X_CS1_DRIVE);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tdata->current_brightness = brightness;\n\n\treturn 0;\n\nerr:\n\t \n\tif (power_up || power_down) {\n\t\twm831x_set_bits(wm831x, WM831X_DCDC_ENABLE, WM831X_DC4_ENA, 0);\n\t\twm831x_set_bits(wm831x, data->isink_reg, WM831X_CS1_ENA, 0);\n\t}\n\n\treturn ret;\n}\n\nstatic int wm831x_backlight_update_status(struct backlight_device *bl)\n{\n\treturn wm831x_backlight_set(bl, backlight_get_brightness(bl));\n}\n\nstatic int wm831x_backlight_get_brightness(struct backlight_device *bl)\n{\n\tstruct wm831x_backlight_data *data = bl_get_data(bl);\n\n\treturn data->current_brightness;\n}\n\nstatic const struct backlight_ops wm831x_backlight_ops = {\n\t.options = BL_CORE_SUSPENDRESUME,\n\t.update_status\t= wm831x_backlight_update_status,\n\t.get_brightness\t= wm831x_backlight_get_brightness,\n};\n\nstatic int wm831x_backlight_probe(struct platform_device *pdev)\n{\n\tstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\n\tstruct wm831x_pdata *wm831x_pdata = dev_get_platdata(pdev->dev.parent);\n\tstruct wm831x_backlight_pdata *pdata;\n\tstruct wm831x_backlight_data *data;\n\tstruct backlight_device *bl;\n\tstruct backlight_properties props;\n\tint ret, i, max_isel, isink_reg, dcdc_cfg;\n\n\t \n\tif (wm831x_pdata)\n\t\tpdata = wm831x_pdata->backlight;\n\telse\n\t\tpdata = NULL;\n\n\tif (!pdata) {\n\t\tdev_err(&pdev->dev, \"No platform data supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tfor (i = 0; i < WM831X_ISINK_MAX_ISEL; i++) {\n\t\tif (wm831x_isinkv_values[i] > pdata->max_uA)\n\t\t\tbreak;\n\t}\n\n\tif (i == 0) {\n\t\tdev_err(&pdev->dev, \"Invalid max_uA: %duA\\n\", pdata->max_uA);\n\t\treturn -EINVAL;\n\t}\n\tmax_isel = i - 1;\n\n\tif (pdata->max_uA != wm831x_isinkv_values[max_isel])\n\t\tdev_warn(&pdev->dev,\n\t\t\t \"Maximum current is %duA not %duA as requested\\n\",\n\t\t\t wm831x_isinkv_values[max_isel], pdata->max_uA);\n\n\tswitch (pdata->isink) {\n\tcase 1:\n\t\tisink_reg = WM831X_CURRENT_SINK_1;\n\t\tdcdc_cfg = 0;\n\t\tbreak;\n\tcase 2:\n\t\tisink_reg = WM831X_CURRENT_SINK_2;\n\t\tdcdc_cfg = WM831X_DC4_FBSRC;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"Invalid ISINK %d\\n\", pdata->isink);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tret = wm831x_reg_unlock(wm831x);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = wm831x_set_bits(wm831x, WM831X_DC4_CONTROL, WM831X_DC4_FBSRC,\n\t\t\t      dcdc_cfg);\n\n\twm831x_reg_lock(wm831x);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (data == NULL)\n\t\treturn -ENOMEM;\n\n\tdata->wm831x = wm831x;\n\tdata->current_brightness = 0;\n\tdata->isink_reg = isink_reg;\n\n\tmemset(&props, 0, sizeof(props));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = max_isel;\n\tbl = devm_backlight_device_register(&pdev->dev, \"wm831x\", &pdev->dev,\n\t\t\t\t\tdata, &wm831x_backlight_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(&pdev->dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\n\tbl->props.brightness = max_isel;\n\n\tplatform_set_drvdata(pdev, bl);\n\n\t \n\twm831x_set_bits(wm831x, WM831X_DCDC_ENABLE, WM831X_DC4_ENA, 0);\n\n\tbacklight_update_status(bl);\n\n\treturn 0;\n}\n\nstatic struct platform_driver wm831x_backlight_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"wm831x-backlight\",\n\t},\n\t.probe\t\t= wm831x_backlight_probe,\n};\n\nmodule_platform_driver(wm831x_backlight_driver);\n\nMODULE_DESCRIPTION(\"Backlight Driver for WM831x PMICs\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm831x-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}