{
  "module_name": "platform_lcd.c",
  "hash_id": "c90fda1bf0d79d6a5088e5ee1d84d1bee4b2a8eb777619b165449a41273f7232",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/platform_lcd.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/lcd.h>\n#include <linux/slab.h>\n\n#include <video/platform_lcd.h>\n\nstruct platform_lcd {\n\tstruct device\t\t*us;\n\tstruct lcd_device\t*lcd;\n\tstruct plat_lcd_data\t*pdata;\n\n\tunsigned int\t\t power;\n\tunsigned int\t\t suspended:1;\n};\n\nstatic inline struct platform_lcd *to_our_lcd(struct lcd_device *lcd)\n{\n\treturn lcd_get_data(lcd);\n}\n\nstatic int platform_lcd_get_power(struct lcd_device *lcd)\n{\n\tstruct platform_lcd *plcd = to_our_lcd(lcd);\n\n\treturn plcd->power;\n}\n\nstatic int platform_lcd_set_power(struct lcd_device *lcd, int power)\n{\n\tstruct platform_lcd *plcd = to_our_lcd(lcd);\n\tint lcd_power = 1;\n\n\tif (power == FB_BLANK_POWERDOWN || plcd->suspended)\n\t\tlcd_power = 0;\n\n\tplcd->pdata->set_power(plcd->pdata, lcd_power);\n\tplcd->power = power;\n\n\treturn 0;\n}\n\nstatic int platform_lcd_match(struct lcd_device *lcd, struct fb_info *info)\n{\n\tstruct platform_lcd *plcd = to_our_lcd(lcd);\n\tstruct plat_lcd_data *pdata = plcd->pdata;\n\n\tif (pdata->match_fb)\n\t\treturn pdata->match_fb(pdata, info);\n\n\treturn plcd->us->parent == info->device;\n}\n\nstatic struct lcd_ops platform_lcd_ops = {\n\t.get_power\t= platform_lcd_get_power,\n\t.set_power\t= platform_lcd_set_power,\n\t.check_fb\t= platform_lcd_match,\n};\n\nstatic int platform_lcd_probe(struct platform_device *pdev)\n{\n\tstruct plat_lcd_data *pdata;\n\tstruct platform_lcd *plcd;\n\tstruct device *dev = &pdev->dev;\n\tint err;\n\n\tpdata = dev_get_platdata(&pdev->dev);\n\tif (!pdata) {\n\t\tdev_err(dev, \"no platform data supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (pdata->probe) {\n\t\terr = pdata->probe(pdata);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tplcd = devm_kzalloc(&pdev->dev, sizeof(struct platform_lcd),\n\t\t\t    GFP_KERNEL);\n\tif (!plcd)\n\t\treturn -ENOMEM;\n\n\tplcd->us = dev;\n\tplcd->pdata = pdata;\n\tplcd->lcd = devm_lcd_device_register(&pdev->dev, dev_name(dev), dev,\n\t\t\t\t\t\tplcd, &platform_lcd_ops);\n\tif (IS_ERR(plcd->lcd)) {\n\t\tdev_err(dev, \"cannot register lcd device\\n\");\n\t\treturn PTR_ERR(plcd->lcd);\n\t}\n\n\tplatform_set_drvdata(pdev, plcd);\n\tplatform_lcd_set_power(plcd->lcd, FB_BLANK_NORMAL);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int platform_lcd_suspend(struct device *dev)\n{\n\tstruct platform_lcd *plcd = dev_get_drvdata(dev);\n\n\tplcd->suspended = 1;\n\tplatform_lcd_set_power(plcd->lcd, plcd->power);\n\n\treturn 0;\n}\n\nstatic int platform_lcd_resume(struct device *dev)\n{\n\tstruct platform_lcd *plcd = dev_get_drvdata(dev);\n\n\tplcd->suspended = 0;\n\tplatform_lcd_set_power(plcd->lcd, plcd->power);\n\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(platform_lcd_pm_ops, platform_lcd_suspend,\n\t\t\tplatform_lcd_resume);\n\nstatic struct platform_driver platform_lcd_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"platform-lcd\",\n\t\t.pm\t= &platform_lcd_pm_ops,\n\t},\n\t.probe\t\t= platform_lcd_probe,\n};\n\nmodule_platform_driver(platform_lcd_driver);\n\nMODULE_AUTHOR(\"Ben Dooks <ben-linux@fluff.org>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:platform-lcd\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}