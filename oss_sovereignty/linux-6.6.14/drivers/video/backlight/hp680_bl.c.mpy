{
  "module_name": "hp680_bl.c",
  "hash_id": "17cb6b17c6f29468c1e0f189d8fcf5e6dc2220f17ad39e9bd39c99d73270cc49",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/hp680_bl.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/spinlock.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n\n#include <cpu/dac.h>\n#include <mach/hp6xx.h>\n#include <asm/hd64461.h>\n\n#define HP680_MAX_INTENSITY 255\n#define HP680_DEFAULT_INTENSITY 10\n\nstatic int hp680bl_suspended;\nstatic int current_intensity;\nstatic DEFINE_SPINLOCK(bl_lock);\n\nstatic void hp680bl_send_intensity(struct backlight_device *bd)\n{\n\tunsigned long flags;\n\tu16 v;\n\tint intensity = backlight_get_brightness(bd);\n\n\tif (hp680bl_suspended)\n\t\tintensity = 0;\n\n\tspin_lock_irqsave(&bl_lock, flags);\n\tif (intensity && current_intensity == 0) {\n\t\tsh_dac_enable(DAC_LCD_BRIGHTNESS);\n\t\tv = inw(HD64461_GPBDR);\n\t\tv &= ~HD64461_GPBDR_LCDOFF;\n\t\toutw(v, HD64461_GPBDR);\n\t\tsh_dac_output(255-(u8)intensity, DAC_LCD_BRIGHTNESS);\n\t} else if (intensity == 0 && current_intensity != 0) {\n\t\tsh_dac_output(255-(u8)intensity, DAC_LCD_BRIGHTNESS);\n\t\tsh_dac_disable(DAC_LCD_BRIGHTNESS);\n\t\tv = inw(HD64461_GPBDR);\n\t\tv |= HD64461_GPBDR_LCDOFF;\n\t\toutw(v, HD64461_GPBDR);\n\t} else if (intensity) {\n\t\tsh_dac_output(255-(u8)intensity, DAC_LCD_BRIGHTNESS);\n\t}\n\tspin_unlock_irqrestore(&bl_lock, flags);\n\n\tcurrent_intensity = intensity;\n}\n\n\n#ifdef CONFIG_PM_SLEEP\nstatic int hp680bl_suspend(struct device *dev)\n{\n\tstruct backlight_device *bd = dev_get_drvdata(dev);\n\n\thp680bl_suspended = 1;\n\thp680bl_send_intensity(bd);\n\treturn 0;\n}\n\nstatic int hp680bl_resume(struct device *dev)\n{\n\tstruct backlight_device *bd = dev_get_drvdata(dev);\n\n\thp680bl_suspended = 0;\n\thp680bl_send_intensity(bd);\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(hp680bl_pm_ops, hp680bl_suspend, hp680bl_resume);\n\nstatic int hp680bl_set_intensity(struct backlight_device *bd)\n{\n\thp680bl_send_intensity(bd);\n\treturn 0;\n}\n\nstatic int hp680bl_get_intensity(struct backlight_device *bd)\n{\n\treturn current_intensity;\n}\n\nstatic const struct backlight_ops hp680bl_ops = {\n\t.get_brightness = hp680bl_get_intensity,\n\t.update_status  = hp680bl_set_intensity,\n};\n\nstatic int hp680bl_probe(struct platform_device *pdev)\n{\n\tstruct backlight_properties props;\n\tstruct backlight_device *bd;\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = HP680_MAX_INTENSITY;\n\tbd = devm_backlight_device_register(&pdev->dev, \"hp680-bl\", &pdev->dev,\n\t\t\t\t\tNULL, &hp680bl_ops, &props);\n\tif (IS_ERR(bd))\n\t\treturn PTR_ERR(bd);\n\n\tplatform_set_drvdata(pdev, bd);\n\n\tbd->props.brightness = HP680_DEFAULT_INTENSITY;\n\thp680bl_send_intensity(bd);\n\n\treturn 0;\n}\n\nstatic void hp680bl_remove(struct platform_device *pdev)\n{\n\tstruct backlight_device *bd = platform_get_drvdata(pdev);\n\n\tbd->props.brightness = 0;\n\tbd->props.power = 0;\n\thp680bl_send_intensity(bd);\n}\n\nstatic struct platform_driver hp680bl_driver = {\n\t.probe\t\t= hp680bl_probe,\n\t.remove_new\t= hp680bl_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"hp680-bl\",\n\t\t.pm\t= &hp680bl_pm_ops,\n\t},\n};\n\nstatic struct platform_device *hp680bl_device;\n\nstatic int __init hp680bl_init(void)\n{\n\tint ret;\n\n\tret = platform_driver_register(&hp680bl_driver);\n\tif (ret)\n\t\treturn ret;\n\thp680bl_device = platform_device_register_simple(\"hp680-bl\", -1,\n\t\t\t\t\t\t\tNULL, 0);\n\tif (IS_ERR(hp680bl_device)) {\n\t\tplatform_driver_unregister(&hp680bl_driver);\n\t\treturn PTR_ERR(hp680bl_device);\n\t}\n\treturn 0;\n}\n\nstatic void __exit hp680bl_exit(void)\n{\n\tplatform_device_unregister(hp680bl_device);\n\tplatform_driver_unregister(&hp680bl_driver);\n}\n\nmodule_init(hp680bl_init);\nmodule_exit(hp680bl_exit);\n\nMODULE_AUTHOR(\"Andriy Skulysh <askulysh@gmail.com>\");\nMODULE_DESCRIPTION(\"HP Jornada 680 Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}