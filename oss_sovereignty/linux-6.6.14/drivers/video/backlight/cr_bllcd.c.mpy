{
  "module_name": "cr_bllcd.c",
  "hash_id": "2a340d03130d3fc11d334801715f3192f8b125b76b4067e7afe081cca9005ac3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/cr_bllcd.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/mutex.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/lcd.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n\n \n\n#define CRVML_DEVICE_LPC    0x27B8\n#define CRVML_REG_GPIOBAR   0x48\n#define CRVML_REG_GPIOEN    0x4C\n#define CRVML_GPIOEN_BIT    (1 << 4)\n#define CRVML_PANEL_PORT    0x38\n#define CRVML_LVDS_ON       0x00000001\n#define CRVML_PANEL_ON      0x00000002\n#define CRVML_BACKLIGHT_OFF 0x00000004\n\n \n#define CRVML_DEVICE_MCH   0x5001\n#define CRVML_REG_MCHBAR   0x44\n#define CRVML_REG_MCHEN    0x54\n#define CRVML_MCHEN_BIT    (1 << 28)\n#define CRVML_MCHMAP_SIZE  4096\n#define CRVML_REG_CLOCK    0xc3c\n#define CRVML_CLOCK_SHIFT  8\n#define CRVML_CLOCK_MASK   0x00000f00\n\nstatic struct pci_dev *lpc_dev;\nstatic u32 gpio_bar;\n\nstruct cr_panel {\n\tstruct backlight_device *cr_backlight_device;\n\tstruct lcd_device *cr_lcd_device;\n};\n\nstatic int cr_backlight_set_intensity(struct backlight_device *bd)\n{\n\tu32 addr = gpio_bar + CRVML_PANEL_PORT;\n\tu32 cur = inl(addr);\n\n\tif (backlight_get_brightness(bd) == 0) {\n\t\t \n\t\tcur |= CRVML_BACKLIGHT_OFF;\n\t\toutl(cur, addr);\n\t} else {\n\t\t \n\t\tcur &= ~CRVML_BACKLIGHT_OFF;\n\t\toutl(cur, addr);\n\t}\n\n\treturn 0;\n}\n\nstatic int cr_backlight_get_intensity(struct backlight_device *bd)\n{\n\tu32 addr = gpio_bar + CRVML_PANEL_PORT;\n\tu32 cur = inl(addr);\n\tu8 intensity;\n\n\tif (cur & CRVML_BACKLIGHT_OFF)\n\t\tintensity = 0;\n\telse\n\t\tintensity = 1;\n\n\treturn intensity;\n}\n\nstatic const struct backlight_ops cr_backlight_ops = {\n\t.get_brightness = cr_backlight_get_intensity,\n\t.update_status = cr_backlight_set_intensity,\n};\n\nstatic void cr_panel_on(void)\n{\n\tu32 addr = gpio_bar + CRVML_PANEL_PORT;\n\tu32 cur = inl(addr);\n\n\tif (!(cur & CRVML_PANEL_ON)) {\n\t\t \n\t\tif (cur & 0x00000001) {\n\t\t\tcur &= ~CRVML_LVDS_ON;\n\t\t\toutl(cur, addr);\n\t\t}\n\t\t \n\t\tschedule_timeout(HZ / 10);\n\t\tcur |= CRVML_PANEL_ON;\n\t\toutl(cur, addr);\n\t}\n\n\t \n\n\tif (!(cur & CRVML_LVDS_ON)) {\n\t\tschedule_timeout(HZ / 10);\n\t\toutl(cur | CRVML_LVDS_ON, addr);\n\t}\n}\n\nstatic void cr_panel_off(void)\n{\n\tu32 addr = gpio_bar + CRVML_PANEL_PORT;\n\tu32 cur = inl(addr);\n\n\t \n\tif (cur & CRVML_LVDS_ON) {\n\t\tcur &= ~CRVML_LVDS_ON;\n\t\toutl(cur, addr);\n\t}\n\tif (cur & CRVML_PANEL_ON) {\n\t\tschedule_timeout(HZ / 10);\n\t\toutl(cur & ~CRVML_PANEL_ON, addr);\n\t}\n}\n\nstatic int cr_lcd_set_power(struct lcd_device *ld, int power)\n{\n\tif (power == FB_BLANK_UNBLANK)\n\t\tcr_panel_on();\n\tif (power == FB_BLANK_POWERDOWN)\n\t\tcr_panel_off();\n\n\treturn 0;\n}\n\nstatic struct lcd_ops cr_lcd_ops = {\n\t.set_power = cr_lcd_set_power,\n};\n\nstatic int cr_backlight_probe(struct platform_device *pdev)\n{\n\tstruct backlight_properties props;\n\tstruct backlight_device *bdp;\n\tstruct lcd_device *ldp;\n\tstruct cr_panel *crp;\n\tu8 dev_en;\n\n\tlpc_dev = pci_get_device(PCI_VENDOR_ID_INTEL,\n\t\t\t\t\tCRVML_DEVICE_LPC, NULL);\n\tif (!lpc_dev) {\n\t\tpr_err(\"INTEL CARILLO RANCH LPC not found.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tpci_read_config_byte(lpc_dev, CRVML_REG_GPIOEN, &dev_en);\n\tif (!(dev_en & CRVML_GPIOEN_BIT)) {\n\t\tpr_err(\"Carillo Ranch GPIO device was not enabled.\\n\");\n\t\tpci_dev_put(lpc_dev);\n\t\treturn -ENODEV;\n\t}\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tbdp = devm_backlight_device_register(&pdev->dev, \"cr-backlight\",\n\t\t\t\t\t&pdev->dev, NULL, &cr_backlight_ops,\n\t\t\t\t\t&props);\n\tif (IS_ERR(bdp)) {\n\t\tpci_dev_put(lpc_dev);\n\t\treturn PTR_ERR(bdp);\n\t}\n\n\tldp = devm_lcd_device_register(&pdev->dev, \"cr-lcd\", &pdev->dev, NULL,\n\t\t\t\t\t&cr_lcd_ops);\n\tif (IS_ERR(ldp)) {\n\t\tpci_dev_put(lpc_dev);\n\t\treturn PTR_ERR(ldp);\n\t}\n\n\tpci_read_config_dword(lpc_dev, CRVML_REG_GPIOBAR,\n\t\t\t      &gpio_bar);\n\tgpio_bar &= ~0x3F;\n\n\tcrp = devm_kzalloc(&pdev->dev, sizeof(*crp), GFP_KERNEL);\n\tif (!crp) {\n\t\tpci_dev_put(lpc_dev);\n\t\treturn -ENOMEM;\n\t}\n\n\tcrp->cr_backlight_device = bdp;\n\tcrp->cr_lcd_device = ldp;\n\tcrp->cr_backlight_device->props.power = FB_BLANK_UNBLANK;\n\tcrp->cr_backlight_device->props.brightness = 0;\n\tcr_backlight_set_intensity(crp->cr_backlight_device);\n\tcr_lcd_set_power(crp->cr_lcd_device, FB_BLANK_UNBLANK);\n\n\tplatform_set_drvdata(pdev, crp);\n\n\treturn 0;\n}\n\nstatic void cr_backlight_remove(struct platform_device *pdev)\n{\n\tstruct cr_panel *crp = platform_get_drvdata(pdev);\n\n\tcrp->cr_backlight_device->props.power = FB_BLANK_POWERDOWN;\n\tcrp->cr_backlight_device->props.brightness = 0;\n\tcrp->cr_backlight_device->props.max_brightness = 0;\n\tcr_backlight_set_intensity(crp->cr_backlight_device);\n\tcr_lcd_set_power(crp->cr_lcd_device, FB_BLANK_POWERDOWN);\n\tpci_dev_put(lpc_dev);\n}\n\nstatic struct platform_driver cr_backlight_driver = {\n\t.probe = cr_backlight_probe,\n\t.remove_new = cr_backlight_remove,\n\t.driver = {\n\t\t   .name = \"cr_backlight\",\n\t\t   },\n};\n\nstatic struct platform_device *crp;\n\nstatic int __init cr_backlight_init(void)\n{\n\tint ret = platform_driver_register(&cr_backlight_driver);\n\n\tif (ret)\n\t\treturn ret;\n\n\tcrp = platform_device_register_simple(\"cr_backlight\", -1, NULL, 0);\n\tif (IS_ERR(crp)) {\n\t\tplatform_driver_unregister(&cr_backlight_driver);\n\t\treturn PTR_ERR(crp);\n\t}\n\n\tpr_info(\"Carillo Ranch Backlight Driver Initialized.\\n\");\n\n\treturn 0;\n}\n\nstatic void __exit cr_backlight_exit(void)\n{\n\tplatform_device_unregister(crp);\n\tplatform_driver_unregister(&cr_backlight_driver);\n}\n\nmodule_init(cr_backlight_init);\nmodule_exit(cr_backlight_exit);\n\nMODULE_AUTHOR(\"Tungsten Graphics Inc.\");\nMODULE_DESCRIPTION(\"Carillo Ranch Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}