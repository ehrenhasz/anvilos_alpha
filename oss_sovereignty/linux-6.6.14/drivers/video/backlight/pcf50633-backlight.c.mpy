{
  "module_name": "pcf50633-backlight.c",
  "hash_id": "c07e1026f30a5482601c3a1d01e5dcf432fca7cc84d9fe1c87dc3b622930d38d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/pcf50633-backlight.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/platform_device.h>\n\n#include <linux/backlight.h>\n#include <linux/fb.h>\n\n#include <linux/mfd/pcf50633/core.h>\n#include <linux/mfd/pcf50633/backlight.h>\n\nstruct pcf50633_bl {\n\tstruct pcf50633 *pcf;\n\tstruct backlight_device *bl;\n\n\tunsigned int brightness;\n\tunsigned int brightness_limit;\n};\n\n \nint pcf50633_bl_set_brightness_limit(struct pcf50633 *pcf, unsigned int limit)\n{\n\tstruct pcf50633_bl *pcf_bl = platform_get_drvdata(pcf->bl_pdev);\n\n\tif (!pcf_bl)\n\t\treturn -ENODEV;\n\n\tpcf_bl->brightness_limit = limit & 0x3f;\n\tbacklight_update_status(pcf_bl->bl);\n\n\treturn 0;\n}\n\nstatic int pcf50633_bl_update_status(struct backlight_device *bl)\n{\n\tstruct pcf50633_bl *pcf_bl = bl_get_data(bl);\n\tunsigned int new_brightness;\n\n\n\tif (bl->props.state & (BL_CORE_SUSPENDED | BL_CORE_FBBLANK) ||\n\t\tbl->props.power != FB_BLANK_UNBLANK)\n\t\tnew_brightness = 0;\n\telse if (bl->props.brightness < pcf_bl->brightness_limit)\n\t\tnew_brightness = bl->props.brightness;\n\telse\n\t\tnew_brightness = pcf_bl->brightness_limit;\n\n\n\tif (pcf_bl->brightness == new_brightness)\n\t\treturn 0;\n\n\tif (new_brightness) {\n\t\tpcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDOUT,\n\t\t\t\t\tnew_brightness);\n\t\tif (!pcf_bl->brightness)\n\t\t\tpcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDENA, 1);\n\t} else {\n\t\tpcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDENA, 0);\n\t}\n\n\tpcf_bl->brightness = new_brightness;\n\n\treturn 0;\n}\n\nstatic int pcf50633_bl_get_brightness(struct backlight_device *bl)\n{\n\tstruct pcf50633_bl *pcf_bl = bl_get_data(bl);\n\n\treturn pcf_bl->brightness;\n}\n\nstatic const struct backlight_ops pcf50633_bl_ops = {\n\t.get_brightness = pcf50633_bl_get_brightness,\n\t.update_status\t= pcf50633_bl_update_status,\n\t.options\t= BL_CORE_SUSPENDRESUME,\n};\n\nstatic int pcf50633_bl_probe(struct platform_device *pdev)\n{\n\tstruct pcf50633_bl *pcf_bl;\n\tstruct device *parent = pdev->dev.parent;\n\tstruct pcf50633_platform_data *pcf50633_data = dev_get_platdata(parent);\n\tstruct pcf50633_bl_platform_data *pdata = pcf50633_data->backlight_data;\n\tstruct backlight_properties bl_props;\n\n\tpcf_bl = devm_kzalloc(&pdev->dev, sizeof(*pcf_bl), GFP_KERNEL);\n\tif (!pcf_bl)\n\t\treturn -ENOMEM;\n\n\tmemset(&bl_props, 0, sizeof(bl_props));\n\tbl_props.type = BACKLIGHT_RAW;\n\tbl_props.max_brightness = 0x3f;\n\tbl_props.power = FB_BLANK_UNBLANK;\n\n\tif (pdata) {\n\t\tbl_props.brightness = pdata->default_brightness;\n\t\tpcf_bl->brightness_limit = pdata->default_brightness_limit;\n\t} else {\n\t\tbl_props.brightness = 0x3f;\n\t\tpcf_bl->brightness_limit = 0x3f;\n\t}\n\n\tpcf_bl->pcf = dev_to_pcf50633(pdev->dev.parent);\n\n\tpcf_bl->bl = devm_backlight_device_register(&pdev->dev, pdev->name,\n\t\t\t\t\t\t&pdev->dev, pcf_bl,\n\t\t\t\t\t\t&pcf50633_bl_ops, &bl_props);\n\n\tif (IS_ERR(pcf_bl->bl))\n\t\treturn PTR_ERR(pcf_bl->bl);\n\n\tplatform_set_drvdata(pdev, pcf_bl);\n\n\tpcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDDIM, pdata->ramp_time);\n\n\t \n\tpcf_bl->brightness = pcf_bl->bl->props.brightness + 1;\n\n\tbacklight_update_status(pcf_bl->bl);\n\n\treturn 0;\n}\n\nstatic struct platform_driver pcf50633_bl_driver = {\n\t.probe =\tpcf50633_bl_probe,\n\t.driver = {\n\t\t.name = \"pcf50633-backlight\",\n\t},\n};\n\nmodule_platform_driver(pcf50633_bl_driver);\n\nMODULE_AUTHOR(\"Lars-Peter Clausen <lars@metafoo.de>\");\nMODULE_DESCRIPTION(\"PCF50633 backlight driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:pcf50633-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}