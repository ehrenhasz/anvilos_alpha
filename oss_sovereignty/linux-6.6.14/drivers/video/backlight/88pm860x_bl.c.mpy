{
  "module_name": "88pm860x_bl.c",
  "hash_id": "cb610d923bd5dbb705b99ef09e24aae56d24d458e62a65f54f021b25607750d3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/88pm860x_bl.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/fb.h>\n#include <linux/i2c.h>\n#include <linux/backlight.h>\n#include <linux/mfd/88pm860x.h>\n#include <linux/module.h>\n\n#define MAX_BRIGHTNESS\t\t(0xFF)\n#define MIN_BRIGHTNESS\t\t(0)\n\n#define CURRENT_BITMASK\t\t(0x1F << 1)\n\nstruct pm860x_backlight_data {\n\tstruct pm860x_chip *chip;\n\tstruct i2c_client *i2c;\n\tint\tcurrent_brightness;\n\tint\tport;\n\tint\tpwm;\n\tint\tiset;\n\tint\treg_duty_cycle;\n\tint\treg_always_on;\n\tint\treg_current;\n};\n\nstatic int backlight_power_set(struct pm860x_chip *chip, int port,\n\t\tint on)\n{\n\tint ret = -EINVAL;\n\n\tswitch (port) {\n\tcase 0:\n\t\tret = on ? pm8606_osc_enable(chip, WLED1_DUTY) :\n\t\t\tpm8606_osc_disable(chip, WLED1_DUTY);\n\t\tbreak;\n\tcase 1:\n\t\tret = on ? pm8606_osc_enable(chip, WLED2_DUTY) :\n\t\t\tpm8606_osc_disable(chip, WLED2_DUTY);\n\t\tbreak;\n\tcase 2:\n\t\tret = on ? pm8606_osc_enable(chip, WLED3_DUTY) :\n\t\t\tpm8606_osc_disable(chip, WLED3_DUTY);\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int pm860x_backlight_set(struct backlight_device *bl, int brightness)\n{\n\tstruct pm860x_backlight_data *data = bl_get_data(bl);\n\tstruct pm860x_chip *chip = data->chip;\n\tunsigned char value;\n\tint ret;\n\n\tif (brightness > MAX_BRIGHTNESS)\n\t\tvalue = MAX_BRIGHTNESS;\n\telse\n\t\tvalue = brightness;\n\n\tif (brightness)\n\t\tbacklight_power_set(chip, data->port, 1);\n\n\tret = pm860x_reg_write(data->i2c, data->reg_duty_cycle, value);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tif ((data->current_brightness == 0) && brightness) {\n\t\tif (data->iset) {\n\t\t\tret = pm860x_set_bits(data->i2c, data->reg_current,\n\t\t\t\t\t      CURRENT_BITMASK, data->iset);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto out;\n\t\t}\n\t\tif (data->pwm) {\n\t\t\tret = pm860x_set_bits(data->i2c, PM8606_PWM,\n\t\t\t\t\t      PM8606_PWM_FREQ_MASK, data->pwm);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto out;\n\t\t}\n\t\tif (brightness == MAX_BRIGHTNESS) {\n\t\t\t \n\t\t\tret = pm860x_set_bits(data->i2c, data->reg_always_on,\n\t\t\t\t\t      PM8606_WLED_ON, PM8606_WLED_ON);\n\t\t}\n\t} else {\n\t\tif (brightness == MAX_BRIGHTNESS) {\n\t\t\t \n\t\t\tret = pm860x_set_bits(data->i2c, data->reg_always_on,\n\t\t\t\t\t      PM8606_WLED_ON, PM8606_WLED_ON);\n\t\t} else {\n\t\t\t \n\t\t\tret = pm860x_set_bits(data->i2c, data->reg_always_on,\n\t\t\t\t\t      PM8606_WLED_ON, 0);\n\t\t}\n\t}\n\tif (ret < 0)\n\t\tgoto out;\n\n\tif (brightness == 0)\n\t\tbacklight_power_set(chip, data->port, 0);\n\n\tdev_dbg(chip->dev, \"set brightness %d\\n\", value);\n\tdata->current_brightness = value;\n\treturn 0;\nout:\n\tdev_dbg(chip->dev, \"set brightness %d failure with return value: %d\\n\",\n\t\tvalue, ret);\n\treturn ret;\n}\n\nstatic int pm860x_backlight_update_status(struct backlight_device *bl)\n{\n\treturn pm860x_backlight_set(bl, backlight_get_brightness(bl));\n}\n\nstatic int pm860x_backlight_get_brightness(struct backlight_device *bl)\n{\n\tstruct pm860x_backlight_data *data = bl_get_data(bl);\n\tstruct pm860x_chip *chip = data->chip;\n\tint ret;\n\n\tret = pm860x_reg_read(data->i2c, data->reg_duty_cycle);\n\tif (ret < 0)\n\t\tgoto out;\n\tdata->current_brightness = ret;\n\tdev_dbg(chip->dev, \"get brightness %d\\n\", data->current_brightness);\n\treturn data->current_brightness;\nout:\n\treturn -EINVAL;\n}\n\nstatic const struct backlight_ops pm860x_backlight_ops = {\n\t.options\t= BL_CORE_SUSPENDRESUME,\n\t.update_status\t= pm860x_backlight_update_status,\n\t.get_brightness\t= pm860x_backlight_get_brightness,\n};\n\n#ifdef CONFIG_OF\nstatic int pm860x_backlight_dt_init(struct platform_device *pdev,\n\t\t\t\t    struct pm860x_backlight_data *data,\n\t\t\t\t    char *name)\n{\n\tstruct device_node *nproot, *np;\n\tint iset = 0;\n\n\tnproot = of_get_child_by_name(pdev->dev.parent->of_node, \"backlights\");\n\tif (!nproot) {\n\t\tdev_err(&pdev->dev, \"failed to find backlights node\\n\");\n\t\treturn -ENODEV;\n\t}\n\tfor_each_child_of_node(nproot, np) {\n\t\tif (of_node_name_eq(np, name)) {\n\t\t\tof_property_read_u32(np, \"marvell,88pm860x-iset\",\n\t\t\t\t\t     &iset);\n\t\t\tdata->iset = PM8606_WLED_CURRENT(iset);\n\t\t\tof_property_read_u32(np, \"marvell,88pm860x-pwm\",\n\t\t\t\t\t     &data->pwm);\n\t\t\tof_node_put(np);\n\t\t\tbreak;\n\t\t}\n\t}\n\tof_node_put(nproot);\n\treturn 0;\n}\n#else\n#define pm860x_backlight_dt_init(x, y, z)\t(-1)\n#endif\n\nstatic int pm860x_backlight_probe(struct platform_device *pdev)\n{\n\tstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\n\tstruct pm860x_backlight_pdata *pdata = dev_get_platdata(&pdev->dev);\n\tstruct pm860x_backlight_data *data;\n\tstruct backlight_device *bl;\n\tstruct resource *res;\n\tstruct backlight_properties props;\n\tchar name[MFD_NAME_SIZE];\n\tint ret = 0;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(struct pm860x_backlight_data),\n\t\t\t    GFP_KERNEL);\n\tif (data == NULL)\n\t\treturn -ENOMEM;\n\tres = platform_get_resource_byname(pdev, IORESOURCE_REG, \"duty cycle\");\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"No REG resource for duty cycle\\n\");\n\t\treturn -ENXIO;\n\t}\n\tdata->reg_duty_cycle = res->start;\n\tres = platform_get_resource_byname(pdev, IORESOURCE_REG, \"always on\");\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"No REG resource for always on\\n\");\n\t\treturn -ENXIO;\n\t}\n\tdata->reg_always_on = res->start;\n\tres = platform_get_resource_byname(pdev, IORESOURCE_REG, \"current\");\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"No REG resource for current\\n\");\n\t\treturn -ENXIO;\n\t}\n\tdata->reg_current = res->start;\n\n\tmemset(name, 0, MFD_NAME_SIZE);\n\tsprintf(name, \"backlight-%d\", pdev->id);\n\tdata->port = pdev->id;\n\tdata->chip = chip;\n\tdata->i2c = (chip->id == CHIP_PM8606) ? chip->client : chip->companion;\n\tdata->current_brightness = MAX_BRIGHTNESS;\n\tif (pm860x_backlight_dt_init(pdev, data, name)) {\n\t\tif (pdata) {\n\t\t\tdata->pwm = pdata->pwm;\n\t\t\tdata->iset = pdata->iset;\n\t\t}\n\t}\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = MAX_BRIGHTNESS;\n\tbl = devm_backlight_device_register(&pdev->dev, name, &pdev->dev, data,\n\t\t\t\t\t&pm860x_backlight_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(&pdev->dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\tbl->props.brightness = MAX_BRIGHTNESS;\n\n\tplatform_set_drvdata(pdev, bl);\n\n\t \n\tret = pm860x_backlight_get_brightness(bl);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tbacklight_update_status(bl);\n\treturn 0;\n}\n\nstatic struct platform_driver pm860x_backlight_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"88pm860x-backlight\",\n\t},\n\t.probe\t\t= pm860x_backlight_probe,\n};\n\nmodule_platform_driver(pm860x_backlight_driver);\n\nMODULE_DESCRIPTION(\"Backlight Driver for Marvell Semiconductor 88PM8606\");\nMODULE_AUTHOR(\"Haojian Zhuang <haojian.zhuang@marvell.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:88pm860x-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}