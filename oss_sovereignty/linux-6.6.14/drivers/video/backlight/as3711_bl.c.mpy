{
  "module_name": "as3711_bl.c",
  "hash_id": "c5504043f5b8e04d9ab86b14edd2863183feadfae3a7860fa409bbb4240bbce0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/as3711_bl.c",
  "human_readable_source": "\n \n\n#include <linux/backlight.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/fb.h>\n#include <linux/kernel.h>\n#include <linux/mfd/as3711.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\nenum as3711_bl_type {\n\tAS3711_BL_SU1,\n\tAS3711_BL_SU2,\n};\n\nstruct as3711_bl_data {\n\tbool powered;\n\tenum as3711_bl_type type;\n\tint brightness;\n\tstruct backlight_device *bl;\n};\n\nstruct as3711_bl_supply {\n\tstruct as3711_bl_data su1;\n\tstruct as3711_bl_data su2;\n\tconst struct as3711_bl_pdata *pdata;\n\tstruct as3711 *as3711;\n};\n\nstatic struct as3711_bl_supply *to_supply(struct as3711_bl_data *su)\n{\n\tswitch (su->type) {\n\tcase AS3711_BL_SU1:\n\t\treturn container_of(su, struct as3711_bl_supply, su1);\n\tcase AS3711_BL_SU2:\n\t\treturn container_of(su, struct as3711_bl_supply, su2);\n\t}\n\treturn NULL;\n}\n\nstatic int as3711_set_brightness_auto_i(struct as3711_bl_data *data,\n\t\t\t\t\tunsigned int brightness)\n{\n\tstruct as3711_bl_supply *supply = to_supply(data);\n\tstruct as3711 *as3711 = supply->as3711;\n\tconst struct as3711_bl_pdata *pdata = supply->pdata;\n\tint ret = 0;\n\n\t \n\tif (pdata->su2_auto_curr1)\n\t\tret = regmap_write(as3711->regmap, AS3711_CURR1_VALUE,\n\t\t\t\t   brightness);\n\tif (!ret && pdata->su2_auto_curr2)\n\t\tret = regmap_write(as3711->regmap, AS3711_CURR2_VALUE,\n\t\t\t\t   brightness);\n\tif (!ret && pdata->su2_auto_curr3)\n\t\tret = regmap_write(as3711->regmap, AS3711_CURR3_VALUE,\n\t\t\t\t   brightness);\n\n\treturn ret;\n}\n\nstatic int as3711_set_brightness_v(struct as3711 *as3711,\n\t\t\t\t   unsigned int brightness,\n\t\t\t\t   unsigned int reg)\n{\n\tif (brightness > 31)\n\t\treturn -EINVAL;\n\n\treturn regmap_update_bits(as3711->regmap, reg, 0xf0,\n\t\t\t\t  brightness << 4);\n}\n\nstatic int as3711_bl_su2_reset(struct as3711_bl_supply *supply)\n{\n\tstruct as3711 *as3711 = supply->as3711;\n\tint ret = regmap_update_bits(as3711->regmap, AS3711_STEPUP_CONTROL_5,\n\t\t\t\t     3, supply->pdata->su2_fbprot);\n\tif (!ret)\n\t\tret = regmap_update_bits(as3711->regmap,\n\t\t\t\t\t AS3711_STEPUP_CONTROL_2, 1, 0);\n\tif (!ret)\n\t\tret = regmap_update_bits(as3711->regmap,\n\t\t\t\t\t AS3711_STEPUP_CONTROL_2, 1, 1);\n\treturn ret;\n}\n\n \nstatic int as3711_bl_update_status(struct backlight_device *bl)\n{\n\tstruct as3711_bl_data *data = bl_get_data(bl);\n\tstruct as3711_bl_supply *supply = to_supply(data);\n\tstruct as3711 *as3711 = supply->as3711;\n\tint brightness;\n\tint ret = 0;\n\n\tbrightness = backlight_get_brightness(bl);\n\n\tif (data->type == AS3711_BL_SU1) {\n\t\tret = as3711_set_brightness_v(as3711, brightness,\n\t\t\t\t\t      AS3711_STEPUP_CONTROL_1);\n\t} else {\n\t\tconst struct as3711_bl_pdata *pdata = supply->pdata;\n\n\t\tswitch (pdata->su2_feedback) {\n\t\tcase AS3711_SU2_VOLTAGE:\n\t\t\tret = as3711_set_brightness_v(as3711, brightness,\n\t\t\t\t\t\t      AS3711_STEPUP_CONTROL_2);\n\t\t\tbreak;\n\t\tcase AS3711_SU2_CURR_AUTO:\n\t\t\tret = as3711_set_brightness_auto_i(data, brightness / 4);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\t\t\tif (brightness) {\n\t\t\t\tret = as3711_bl_su2_reset(supply);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\treturn ret;\n\t\t\t\tudelay(500);\n\t\t\t\tret = as3711_set_brightness_auto_i(data, brightness);\n\t\t\t} else {\n\t\t\t\tret = regmap_update_bits(as3711->regmap,\n\t\t\t\t\t\tAS3711_STEPUP_CONTROL_2, 1, 0);\n\t\t\t}\n\t\t\tbreak;\n\t\t \n\t\tcase AS3711_SU2_CURR1:\n\t\t\tret = regmap_write(as3711->regmap, AS3711_CURR1_VALUE,\n\t\t\t\t\t   brightness);\n\t\t\tbreak;\n\t\tcase AS3711_SU2_CURR2:\n\t\t\tret = regmap_write(as3711->regmap, AS3711_CURR2_VALUE,\n\t\t\t\t\t   brightness);\n\t\t\tbreak;\n\t\tcase AS3711_SU2_CURR3:\n\t\t\tret = regmap_write(as3711->regmap, AS3711_CURR3_VALUE,\n\t\t\t\t\t   brightness);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EINVAL;\n\t\t}\n\t}\n\tif (!ret)\n\t\tdata->brightness = brightness;\n\n\treturn ret;\n}\n\nstatic int as3711_bl_get_brightness(struct backlight_device *bl)\n{\n\tstruct as3711_bl_data *data = bl_get_data(bl);\n\n\treturn data->brightness;\n}\n\nstatic const struct backlight_ops as3711_bl_ops = {\n\t.update_status\t= as3711_bl_update_status,\n\t.get_brightness\t= as3711_bl_get_brightness,\n};\n\nstatic int as3711_bl_init_su2(struct as3711_bl_supply *supply)\n{\n\tstruct as3711 *as3711 = supply->as3711;\n\tconst struct as3711_bl_pdata *pdata = supply->pdata;\n\tu8 ctl = 0;\n\tint ret;\n\n\tdev_dbg(as3711->dev, \"%s(): use %u\\n\", __func__, pdata->su2_feedback);\n\n\t \n\tret = regmap_write(as3711->regmap, AS3711_STEPUP_CONTROL_2, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (pdata->su2_feedback) {\n\tcase AS3711_SU2_VOLTAGE:\n\t\tret = regmap_update_bits(as3711->regmap, AS3711_STEPUP_CONTROL_4, 3, 0);\n\t\tbreak;\n\tcase AS3711_SU2_CURR1:\n\t\tctl = 1;\n\t\tret = regmap_update_bits(as3711->regmap, AS3711_STEPUP_CONTROL_4, 3, 1);\n\t\tbreak;\n\tcase AS3711_SU2_CURR2:\n\t\tctl = 4;\n\t\tret = regmap_update_bits(as3711->regmap, AS3711_STEPUP_CONTROL_4, 3, 2);\n\t\tbreak;\n\tcase AS3711_SU2_CURR3:\n\t\tctl = 0x10;\n\t\tret = regmap_update_bits(as3711->regmap, AS3711_STEPUP_CONTROL_4, 3, 3);\n\t\tbreak;\n\tcase AS3711_SU2_CURR_AUTO:\n\t\tif (pdata->su2_auto_curr1)\n\t\t\tctl = 2;\n\t\tif (pdata->su2_auto_curr2)\n\t\t\tctl |= 8;\n\t\tif (pdata->su2_auto_curr3)\n\t\t\tctl |= 0x20;\n\t\tret = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (!ret)\n\t\tret = regmap_write(as3711->regmap, AS3711_CURR_CONTROL, ctl);\n\n\treturn ret;\n}\n\nstatic int as3711_bl_register(struct platform_device *pdev,\n\t\t\t      unsigned int max_brightness, struct as3711_bl_data *su)\n{\n\tstruct backlight_properties props = {.type = BACKLIGHT_RAW,};\n\tstruct backlight_device *bl;\n\n\t \n\tprops.max_brightness = max_brightness;\n\n\tbl = devm_backlight_device_register(&pdev->dev,\n\t\t\t\t       su->type == AS3711_BL_SU1 ?\n\t\t\t\t       \"as3711-su1\" : \"as3711-su2\",\n\t\t\t\t       &pdev->dev, su,\n\t\t\t\t       &as3711_bl_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(&pdev->dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\n\tbl->props.brightness = props.max_brightness;\n\n\tbacklight_update_status(bl);\n\n\tsu->bl = bl;\n\n\treturn 0;\n}\n\nstatic int as3711_backlight_parse_dt(struct device *dev)\n{\n\tstruct as3711_bl_pdata *pdata = dev_get_platdata(dev);\n\tstruct device_node *bl, *fb;\n\tint ret;\n\n\tbl = of_get_child_by_name(dev->parent->of_node, \"backlight\");\n\tif (!bl) {\n\t\tdev_dbg(dev, \"backlight node not found\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tfb = of_parse_phandle(bl, \"su1-dev\", 0);\n\tif (fb) {\n\t\tof_node_put(fb);\n\n\t\tpdata->su1_fb = true;\n\n\t\tret = of_property_read_u32(bl, \"su1-max-uA\", &pdata->su1_max_uA);\n\t\tif (pdata->su1_max_uA <= 0)\n\t\t\tret = -EINVAL;\n\t\tif (ret < 0)\n\t\t\tgoto err_put_bl;\n\t}\n\n\tfb = of_parse_phandle(bl, \"su2-dev\", 0);\n\tif (fb) {\n\t\tint count = 0;\n\n\t\tof_node_put(fb);\n\n\t\tpdata->su2_fb = true;\n\n\t\tret = of_property_read_u32(bl, \"su2-max-uA\", &pdata->su2_max_uA);\n\t\tif (pdata->su2_max_uA <= 0)\n\t\t\tret = -EINVAL;\n\t\tif (ret < 0)\n\t\t\tgoto err_put_bl;\n\n\t\tif (of_property_read_bool(bl, \"su2-feedback-voltage\")) {\n\t\t\tpdata->su2_feedback = AS3711_SU2_VOLTAGE;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-feedback-curr1\")) {\n\t\t\tpdata->su2_feedback = AS3711_SU2_CURR1;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-feedback-curr2\")) {\n\t\t\tpdata->su2_feedback = AS3711_SU2_CURR2;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-feedback-curr3\")) {\n\t\t\tpdata->su2_feedback = AS3711_SU2_CURR3;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-feedback-curr-auto\")) {\n\t\t\tpdata->su2_feedback = AS3711_SU2_CURR_AUTO;\n\t\t\tcount++;\n\t\t}\n\t\tif (count != 1) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_put_bl;\n\t\t}\n\n\t\tcount = 0;\n\t\tif (of_property_read_bool(bl, \"su2-fbprot-lx-sd4\")) {\n\t\t\tpdata->su2_fbprot = AS3711_SU2_LX_SD4;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-fbprot-gpio2\")) {\n\t\t\tpdata->su2_fbprot = AS3711_SU2_GPIO2;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-fbprot-gpio3\")) {\n\t\t\tpdata->su2_fbprot = AS3711_SU2_GPIO3;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-fbprot-gpio4\")) {\n\t\t\tpdata->su2_fbprot = AS3711_SU2_GPIO4;\n\t\t\tcount++;\n\t\t}\n\t\tif (count != 1) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_put_bl;\n\t\t}\n\n\t\tcount = 0;\n\t\tif (of_property_read_bool(bl, \"su2-auto-curr1\")) {\n\t\t\tpdata->su2_auto_curr1 = true;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-auto-curr2\")) {\n\t\t\tpdata->su2_auto_curr2 = true;\n\t\t\tcount++;\n\t\t}\n\t\tif (of_property_read_bool(bl, \"su2-auto-curr3\")) {\n\t\t\tpdata->su2_auto_curr3 = true;\n\t\t\tcount++;\n\t\t}\n\n\t\t \n\t\tif (!count ^ (pdata->su2_feedback != AS3711_SU2_CURR_AUTO)) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_put_bl;\n\t\t}\n\t}\n\n\tof_node_put(bl);\n\n\treturn 0;\n\nerr_put_bl:\n\tof_node_put(bl);\n\n\treturn ret;\n}\n\nstatic int as3711_backlight_probe(struct platform_device *pdev)\n{\n\tstruct as3711_bl_pdata *pdata = dev_get_platdata(&pdev->dev);\n\tstruct as3711 *as3711 = dev_get_drvdata(pdev->dev.parent);\n\tstruct as3711_bl_supply *supply;\n\tstruct as3711_bl_data *su;\n\tunsigned int max_brightness;\n\tint ret;\n\n\tif (!pdata) {\n\t\tdev_err(&pdev->dev, \"No platform data, exiting...\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (pdev->dev.parent->of_node) {\n\t\tret = as3711_backlight_parse_dt(&pdev->dev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&pdev->dev, \"DT parsing failed: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (!pdata->su1_fb && !pdata->su2_fb) {\n\t\tdev_err(&pdev->dev, \"No framebuffer specified\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (pdata->su1_fb ||\n\t    pdata->su2_fbprot != AS3711_SU2_GPIO4 ||\n\t    pdata->su2_feedback != AS3711_SU2_CURR_AUTO) {\n\t\tdev_warn(&pdev->dev,\n\t\t\t \"Attention! An untested mode has been chosen!\\n\"\n\t\t\t \"Please, review the code, enable, test, and report success:-)\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tsupply = devm_kzalloc(&pdev->dev, sizeof(*supply), GFP_KERNEL);\n\tif (!supply)\n\t\treturn -ENOMEM;\n\n\tsupply->as3711 = as3711;\n\tsupply->pdata = pdata;\n\n\tif (pdata->su1_fb) {\n\t\tsu = &supply->su1;\n\t\tsu->type = AS3711_BL_SU1;\n\n\t\tmax_brightness = min(pdata->su1_max_uA, 31);\n\t\tret = as3711_bl_register(pdev, max_brightness, su);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (pdata->su2_fb) {\n\t\tsu = &supply->su2;\n\t\tsu->type = AS3711_BL_SU2;\n\n\t\tswitch (pdata->su2_fbprot) {\n\t\tcase AS3711_SU2_GPIO2:\n\t\tcase AS3711_SU2_GPIO3:\n\t\tcase AS3711_SU2_GPIO4:\n\t\tcase AS3711_SU2_LX_SD4:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tswitch (pdata->su2_feedback) {\n\t\tcase AS3711_SU2_VOLTAGE:\n\t\t\tmax_brightness = min(pdata->su2_max_uA, 31);\n\t\t\tbreak;\n\t\tcase AS3711_SU2_CURR1:\n\t\tcase AS3711_SU2_CURR2:\n\t\tcase AS3711_SU2_CURR3:\n\t\tcase AS3711_SU2_CURR_AUTO:\n\t\t\tmax_brightness = min(pdata->su2_max_uA / 150, 255);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tret = as3711_bl_init_su2(supply);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = as3711_bl_register(pdev, max_brightness, su);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, supply);\n\n\treturn 0;\n}\n\nstatic struct platform_driver as3711_backlight_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"as3711-backlight\",\n\t},\n\t.probe\t\t= as3711_backlight_probe,\n};\n\nmodule_platform_driver(as3711_backlight_driver);\n\nMODULE_DESCRIPTION(\"Backlight Driver for AS3711 PMICs\");\nMODULE_AUTHOR(\"Guennadi Liakhovetski <g.liakhovetski@gmx.de\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:as3711-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}