{
  "module_name": "da903x_bl.c",
  "hash_id": "404d1e8514dccba8e820b5d63fce3d73a2f3fea68498d3f805538b45fcb2eb28",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/da903x_bl.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/mfd/da903x.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n\n#define DA9030_WLED_CONTROL\t0x25\n#define DA9030_WLED_CP_EN\t(1 << 6)\n#define DA9030_WLED_TRIM(x)\t((x) & 0x7)\n\n#define DA9034_WLED_CONTROL1\t0x3C\n#define DA9034_WLED_CONTROL2\t0x3D\n#define DA9034_WLED_ISET(x)\t((x) & 0x1f)\n\n#define DA9034_WLED_BOOST_EN\t(1 << 5)\n\n#define DA9030_MAX_BRIGHTNESS\t7\n#define DA9034_MAX_BRIGHTNESS\t0x7f\n\nstruct da903x_backlight_data {\n\tstruct device *da903x_dev;\n\tint id;\n\tint current_brightness;\n};\n\nstatic int da903x_backlight_set(struct backlight_device *bl, int brightness)\n{\n\tstruct da903x_backlight_data *data = bl_get_data(bl);\n\tstruct device *dev = data->da903x_dev;\n\tuint8_t val;\n\tint ret = 0;\n\n\tswitch (data->id) {\n\tcase DA9034_ID_WLED:\n\t\tret = da903x_update(dev, DA9034_WLED_CONTROL1,\n\t\t\t\tbrightness, 0x7f);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (data->current_brightness && brightness == 0)\n\t\t\tret = da903x_clr_bits(dev,\n\t\t\t\t\tDA9034_WLED_CONTROL2,\n\t\t\t\t\tDA9034_WLED_BOOST_EN);\n\n\t\tif (data->current_brightness == 0 && brightness)\n\t\t\tret = da903x_set_bits(dev,\n\t\t\t\t\tDA9034_WLED_CONTROL2,\n\t\t\t\t\tDA9034_WLED_BOOST_EN);\n\t\tbreak;\n\tcase DA9030_ID_WLED:\n\t\tval = DA9030_WLED_TRIM(brightness);\n\t\tval |= brightness ? DA9030_WLED_CP_EN : 0;\n\t\tret = da903x_write(dev, DA9030_WLED_CONTROL, val);\n\t\tbreak;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\tdata->current_brightness = brightness;\n\treturn 0;\n}\n\nstatic int da903x_backlight_update_status(struct backlight_device *bl)\n{\n\treturn da903x_backlight_set(bl, backlight_get_brightness(bl));\n}\n\nstatic int da903x_backlight_get_brightness(struct backlight_device *bl)\n{\n\tstruct da903x_backlight_data *data = bl_get_data(bl);\n\n\treturn data->current_brightness;\n}\n\nstatic const struct backlight_ops da903x_backlight_ops = {\n\t.options\t= BL_CORE_SUSPENDRESUME,\n\t.update_status\t= da903x_backlight_update_status,\n\t.get_brightness\t= da903x_backlight_get_brightness,\n};\n\nstatic int da903x_backlight_probe(struct platform_device *pdev)\n{\n\tstruct da9034_backlight_pdata *pdata = dev_get_platdata(&pdev->dev);\n\tstruct da903x_backlight_data *data;\n\tstruct backlight_device *bl;\n\tstruct backlight_properties props;\n\tint max_brightness;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (data == NULL)\n\t\treturn -ENOMEM;\n\n\tswitch (pdev->id) {\n\tcase DA9030_ID_WLED:\n\t\tmax_brightness = DA9030_MAX_BRIGHTNESS;\n\t\tbreak;\n\tcase DA9034_ID_WLED:\n\t\tmax_brightness = DA9034_MAX_BRIGHTNESS;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"invalid backlight device ID(%d)\\n\",\n\t\t\t\tpdev->id);\n\t\treturn -EINVAL;\n\t}\n\n\tdata->id = pdev->id;\n\tdata->da903x_dev = pdev->dev.parent;\n\tdata->current_brightness = 0;\n\n\t \n\tif (pdata)\n\t\tda903x_write(data->da903x_dev, DA9034_WLED_CONTROL2,\n\t\t\t\tDA9034_WLED_ISET(pdata->output_current));\n\n\tmemset(&props, 0, sizeof(props));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = max_brightness;\n\tbl = devm_backlight_device_register(&pdev->dev, pdev->name,\n\t\t\t\t\tdata->da903x_dev, data,\n\t\t\t\t\t&da903x_backlight_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(&pdev->dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\n\tbl->props.brightness = max_brightness;\n\n\tplatform_set_drvdata(pdev, bl);\n\tbacklight_update_status(bl);\n\treturn 0;\n}\n\nstatic struct platform_driver da903x_backlight_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"da903x-backlight\",\n\t},\n\t.probe\t\t= da903x_backlight_probe,\n};\n\nmodule_platform_driver(da903x_backlight_driver);\n\nMODULE_DESCRIPTION(\"Backlight Driver for Dialog Semiconductor DA9030/DA9034\");\nMODULE_AUTHOR(\"Eric Miao <eric.miao@marvell.com>\");\nMODULE_AUTHOR(\"Mike Rapoport <mike@compulab.co.il>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:da903x-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}