{
  "module_name": "ktd253-backlight.c",
  "hash_id": "79480dc8b34ecf6895092971c94c35c9e681244d89c70119606010e538f596c2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/ktd253-backlight.c",
  "human_readable_source": "\n \n#include <linux/backlight.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/fb.h>\n#include <linux/gpio/consumer.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/limits.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/slab.h>\n\n \n#define KTD253_MIN_RATIO 1\n#define KTD253_MAX_RATIO 32\n#define KTD253_DEFAULT_RATIO 13\n\n#define KTD253_T_LOW_NS (200 + 10)  \n#define KTD253_T_HIGH_NS (200 + 10)  \n#define KTD253_T_OFF_CRIT_NS 100000  \n#define KTD253_T_OFF_MS 3\n\nstruct ktd253_backlight {\n\tstruct device *dev;\n\tstruct backlight_device *bl;\n\tstruct gpio_desc *gpiod;\n\tu16 ratio;\n};\n\nstatic void ktd253_backlight_set_max_ratio(struct ktd253_backlight *ktd253)\n{\n\tgpiod_set_value_cansleep(ktd253->gpiod, 1);\n\tndelay(KTD253_T_HIGH_NS);\n\t \n}\n\nstatic int ktd253_backlight_stepdown(struct ktd253_backlight *ktd253)\n{\n\t \n\tu64 ns;\n\n\tns = ktime_get_ns();\n\tgpiod_set_value(ktd253->gpiod, 0);\n\tndelay(KTD253_T_LOW_NS);\n\tgpiod_set_value(ktd253->gpiod, 1);\n\tns = ktime_get_ns() - ns;\n\tif (ns >= KTD253_T_OFF_CRIT_NS) {\n\t\tdev_err(ktd253->dev, \"PCM on backlight took too long (%llu ns)\\n\", ns);\n\t\treturn -EAGAIN;\n\t}\n\tndelay(KTD253_T_HIGH_NS);\n\treturn 0;\n}\n\nstatic int ktd253_backlight_update_status(struct backlight_device *bl)\n{\n\tstruct ktd253_backlight *ktd253 = bl_get_data(bl);\n\tint brightness = backlight_get_brightness(bl);\n\tu16 target_ratio;\n\tu16 current_ratio = ktd253->ratio;\n\tint ret;\n\n\tdev_dbg(ktd253->dev, \"new brightness/ratio: %d/32\\n\", brightness);\n\n\ttarget_ratio = brightness;\n\n\tif (target_ratio == current_ratio)\n\t\t \n\t\treturn 0;\n\n\tif (target_ratio == 0) {\n\t\tgpiod_set_value_cansleep(ktd253->gpiod, 0);\n\t\t \n\t\tmsleep(KTD253_T_OFF_MS);\n\t\tktd253->ratio = 0;\n\t\treturn 0;\n\t}\n\n\tif (current_ratio == 0) {\n\t\tktd253_backlight_set_max_ratio(ktd253);\n\t\tcurrent_ratio = KTD253_MAX_RATIO;\n\t}\n\n\twhile (current_ratio != target_ratio) {\n\t\t \n\t\tret = ktd253_backlight_stepdown(ktd253);\n\t\tif (ret == -EAGAIN) {\n\t\t\t \n\t\t\tgpiod_set_value_cansleep(ktd253->gpiod, 0);\n\t\t\tmsleep(KTD253_T_OFF_MS);\n\t\t\tktd253_backlight_set_max_ratio(ktd253);\n\t\t\tcurrent_ratio = KTD253_MAX_RATIO;\n\t\t} else if (current_ratio == KTD253_MIN_RATIO) {\n\t\t\t \n\t\t\tcurrent_ratio = KTD253_MAX_RATIO;\n\t\t} else {\n\t\t\tcurrent_ratio--;\n\t\t}\n\t}\n\tktd253->ratio = current_ratio;\n\n\tdev_dbg(ktd253->dev, \"new ratio set to %d/32\\n\", target_ratio);\n\n\treturn 0;\n}\n\nstatic const struct backlight_ops ktd253_backlight_ops = {\n\t.options\t= BL_CORE_SUSPENDRESUME,\n\t.update_status\t= ktd253_backlight_update_status,\n};\n\nstatic int ktd253_backlight_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct backlight_device *bl;\n\tstruct ktd253_backlight *ktd253;\n\tu32 max_brightness;\n\tu32 brightness;\n\tint ret;\n\n\tktd253 = devm_kzalloc(dev, sizeof(*ktd253), GFP_KERNEL);\n\tif (!ktd253)\n\t\treturn -ENOMEM;\n\tktd253->dev = dev;\n\n\tret = device_property_read_u32(dev, \"max-brightness\", &max_brightness);\n\tif (ret)\n\t\tmax_brightness = KTD253_MAX_RATIO;\n\tif (max_brightness > KTD253_MAX_RATIO) {\n\t\t \n\t\tdev_err(dev, \"illegal max brightness specified\\n\");\n\t\tmax_brightness = KTD253_MAX_RATIO;\n\t}\n\n\tret = device_property_read_u32(dev, \"default-brightness\", &brightness);\n\tif (ret)\n\t\tbrightness = KTD253_DEFAULT_RATIO;\n\tif (brightness > max_brightness) {\n\t\t \n\t\tdev_err(dev, \"default brightness exceeds max brightness\\n\");\n\t\tbrightness = max_brightness;\n\t}\n\n\tktd253->gpiod = devm_gpiod_get(dev, \"enable\", GPIOD_OUT_LOW);\n\tif (IS_ERR(ktd253->gpiod))\n\t\treturn dev_err_probe(dev, PTR_ERR(ktd253->gpiod),\n\t\t\t\t     \"gpio line missing or invalid.\\n\");\n\tgpiod_set_consumer_name(ktd253->gpiod, dev_name(dev));\n\t \n\tmsleep(KTD253_T_OFF_MS);\n\n\tbl = devm_backlight_device_register(dev, dev_name(dev), dev, ktd253,\n\t\t\t\t\t    &ktd253_backlight_ops, NULL);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\tbl->props.max_brightness = max_brightness;\n\t \n\tif (brightness) {\n\t\tbl->props.brightness = brightness;\n\t\tbl->props.power = FB_BLANK_UNBLANK;\n\t} else {\n\t\tbl->props.brightness = 0;\n\t\tbl->props.power = FB_BLANK_POWERDOWN;\n\t}\n\n\tktd253->bl = bl;\n\tplatform_set_drvdata(pdev, bl);\n\tbacklight_update_status(bl);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id ktd253_backlight_of_match[] = {\n\t{ .compatible = \"kinetic,ktd253\" },\n\t{ .compatible = \"kinetic,ktd259\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, ktd253_backlight_of_match);\n\nstatic struct platform_driver ktd253_backlight_driver = {\n\t.driver = {\n\t\t.name = \"ktd253-backlight\",\n\t\t.of_match_table = ktd253_backlight_of_match,\n\t},\n\t.probe\t\t= ktd253_backlight_probe,\n};\nmodule_platform_driver(ktd253_backlight_driver);\n\nMODULE_AUTHOR(\"Linus Walleij <linus.walleij@linaro.org>\");\nMODULE_DESCRIPTION(\"Kinetic KTD253 Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:ktd253-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}