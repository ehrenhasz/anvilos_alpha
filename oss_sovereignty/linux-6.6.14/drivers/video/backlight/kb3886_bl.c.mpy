{
  "module_name": "kb3886_bl.c",
  "hash_id": "2da8b8d4746f9463216a8487e732f9eb05349c2b154dae173c9393cfd66bc438",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/kb3886_bl.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/mutex.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/delay.h>\n#include <linux/dmi.h>\n\n#define KB3886_PARENT 0x64\n#define KB3886_IO 0x60\n#define KB3886_ADC_DAC_PWM 0xC4\n#define KB3886_PWM0_WRITE 0x81\n#define KB3886_PWM0_READ 0x41\n\nstatic DEFINE_MUTEX(bl_mutex);\n\nstatic void kb3886_bl_set_intensity(int intensity)\n{\n\tmutex_lock(&bl_mutex);\n\tintensity = intensity&0xff;\n\toutb(KB3886_ADC_DAC_PWM, KB3886_PARENT);\n\tusleep_range(10000, 11000);\n\toutb(KB3886_PWM0_WRITE, KB3886_IO);\n\tusleep_range(10000, 11000);\n\toutb(intensity, KB3886_IO);\n\tmutex_unlock(&bl_mutex);\n}\n\nstruct kb3886bl_machinfo {\n\tint max_intensity;\n\tint default_intensity;\n\tint limit_mask;\n\tvoid (*set_bl_intensity)(int intensity);\n};\n\nstatic struct kb3886bl_machinfo kb3886_bl_machinfo = {\n\t.max_intensity = 0xff,\n\t.default_intensity = 0xa0,\n\t.limit_mask = 0x7f,\n\t.set_bl_intensity = kb3886_bl_set_intensity,\n};\n\nstatic struct platform_device kb3886bl_device = {\n\t.name\t\t= \"kb3886-bl\",\n\t.dev\t\t= {\n\t\t.platform_data\t= &kb3886_bl_machinfo,\n\t},\n\t.id\t\t= -1,\n};\n\nstatic struct platform_device *devices[] __initdata = {\n\t&kb3886bl_device,\n};\n\n \n\nstatic int kb3886bl_intensity;\nstatic struct backlight_device *kb3886_backlight_device;\nstatic struct kb3886bl_machinfo *bl_machinfo;\n\nstatic unsigned long kb3886bl_flags;\n#define KB3886BL_SUSPENDED     0x01\n\nstatic const struct dmi_system_id kb3886bl_device_table[] __initconst = {\n\t{\n\t\t.ident = \"Sahara Touch-iT\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"SDV\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"iTouch T201\"),\n\t\t},\n\t},\n\t{ }\n};\n\nstatic int kb3886bl_send_intensity(struct backlight_device *bd)\n{\n\tint intensity = backlight_get_brightness(bd);\n\n\tif (kb3886bl_flags & KB3886BL_SUSPENDED)\n\t\tintensity = 0;\n\n\tbl_machinfo->set_bl_intensity(intensity);\n\n\tkb3886bl_intensity = intensity;\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int kb3886bl_suspend(struct device *dev)\n{\n\tstruct backlight_device *bd = dev_get_drvdata(dev);\n\n\tkb3886bl_flags |= KB3886BL_SUSPENDED;\n\tbacklight_update_status(bd);\n\treturn 0;\n}\n\nstatic int kb3886bl_resume(struct device *dev)\n{\n\tstruct backlight_device *bd = dev_get_drvdata(dev);\n\n\tkb3886bl_flags &= ~KB3886BL_SUSPENDED;\n\tbacklight_update_status(bd);\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(kb3886bl_pm_ops, kb3886bl_suspend, kb3886bl_resume);\n\nstatic int kb3886bl_get_intensity(struct backlight_device *bd)\n{\n\treturn kb3886bl_intensity;\n}\n\nstatic const struct backlight_ops kb3886bl_ops = {\n\t.get_brightness = kb3886bl_get_intensity,\n\t.update_status  = kb3886bl_send_intensity,\n};\n\nstatic int kb3886bl_probe(struct platform_device *pdev)\n{\n\tstruct backlight_properties props;\n\tstruct kb3886bl_machinfo *machinfo = dev_get_platdata(&pdev->dev);\n\n\tbl_machinfo = machinfo;\n\tif (!machinfo->limit_mask)\n\t\tmachinfo->limit_mask = -1;\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = machinfo->max_intensity;\n\tkb3886_backlight_device = devm_backlight_device_register(&pdev->dev,\n\t\t\t\t\t\t\t\"kb3886-bl\", &pdev->dev,\n\t\t\t\t\t\t\tNULL, &kb3886bl_ops,\n\t\t\t\t\t\t\t&props);\n\tif (IS_ERR(kb3886_backlight_device))\n\t\treturn PTR_ERR(kb3886_backlight_device);\n\n\tplatform_set_drvdata(pdev, kb3886_backlight_device);\n\n\tkb3886_backlight_device->props.power = FB_BLANK_UNBLANK;\n\tkb3886_backlight_device->props.brightness = machinfo->default_intensity;\n\tbacklight_update_status(kb3886_backlight_device);\n\n\treturn 0;\n}\n\nstatic struct platform_driver kb3886bl_driver = {\n\t.probe\t\t= kb3886bl_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"kb3886-bl\",\n\t\t.pm\t= &kb3886bl_pm_ops,\n\t},\n};\n\nstatic int __init kb3886_init(void)\n{\n\tif (!dmi_check_system(kb3886bl_device_table))\n\t\treturn -ENODEV;\n\n\tplatform_add_devices(devices, ARRAY_SIZE(devices));\n\treturn platform_driver_register(&kb3886bl_driver);\n}\n\nstatic void __exit kb3886_exit(void)\n{\n\tplatform_driver_unregister(&kb3886bl_driver);\n}\n\nmodule_init(kb3886_init);\nmodule_exit(kb3886_exit);\n\nMODULE_AUTHOR(\"Claudio Nieder <private@claudio.ch>\");\nMODULE_DESCRIPTION(\"Tabletkiosk Sahara Touch-iT Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"dmi:*:svnSDV:pniTouchT201:*\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}