{
  "module_name": "locomolcd.c",
  "hash_id": "eab3bdbd01049243ee1c384788643035a4745b4bcf1d641203511550769ae146",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/locomolcd.c",
  "human_readable_source": "\n \n\n \n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/interrupt.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n\n#include <asm/hardware/locomo.h>\n#include <asm/irq.h>\n#include <asm/mach/sharpsl_param.h>\n#include <asm/mach-types.h>\n\n#include \"../../../arch/arm/mach-sa1100/generic.h\"\n\nstatic struct backlight_device *locomolcd_bl_device;\nstatic struct locomo_dev *locomolcd_dev;\nstatic unsigned long locomolcd_flags;\n#define LOCOMOLCD_SUSPENDED     0x01\n\nstatic void locomolcd_on(int comadj)\n{\n\tlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHA_ON, 0);\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHA_ON, 1);\n\tmdelay(2);\n\n\tlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHD_ON, 0);\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHD_ON, 1);\n\tmdelay(2);\n\n\tlocomo_m62332_senddata(locomolcd_dev, comadj, 0);\n\tmdelay(5);\n\n\tlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VEE_ON, 0);\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VEE_ON, 1);\n\tmdelay(10);\n\n\t \n\tlocomo_writel(0x01, locomolcd_dev->mapbase + LOCOMO_TC);\n\n\t \n\tlocomo_writel(6, locomolcd_dev->mapbase + LOCOMO_CPSD);\n\n\t \n\tlocomo_writel((0x04 | 0x01), locomolcd_dev->mapbase + LOCOMO_TC);\n\tmdelay(10);\n\n\tlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_MOD, 0);\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_MOD, 1);\n}\n\nstatic void locomolcd_off(int comadj)\n{\n\t \n\tlocomo_writel(0x06, locomolcd_dev->mapbase + LOCOMO_TC);\n\tmdelay(1);\n\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHA_ON, 0);\n\tmdelay(110);\n\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VEE_ON, 0);\n\tmdelay(700);\n\n\t \n\tlocomo_writel(0, locomolcd_dev->mapbase + LOCOMO_TC);\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_MOD, 0);\n\tlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHD_ON, 0);\n}\n\nvoid locomolcd_power(int on)\n{\n\tint comadj = sharpsl_param.comadj;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\tif (!locomolcd_dev) {\n\t\tlocal_irq_restore(flags);\n\t\treturn;\n\t}\n\n\t \n\tif (comadj == -1 && machine_is_collie())\n\t\tcomadj = 128;\n\n\tif (on)\n\t\tlocomolcd_on(comadj);\n\telse\n\t\tlocomolcd_off(comadj);\n\n\tlocal_irq_restore(flags);\n}\nEXPORT_SYMBOL(locomolcd_power);\n\nstatic int current_intensity;\n\nstatic int locomolcd_set_intensity(struct backlight_device *bd)\n{\n\tint intensity = backlight_get_brightness(bd);\n\n\tif (locomolcd_flags & LOCOMOLCD_SUSPENDED)\n\t\tintensity = 0;\n\n\tswitch (intensity) {\n\t \n\tcase 0:\n\t\tlocomo_frontlight_set(locomolcd_dev, 0, 0, 161);\n\t\tbreak;\n\tcase 1:\n\t\tlocomo_frontlight_set(locomolcd_dev, 117, 0, 161);\n\t\tbreak;\n\tcase 2:\n\t\tlocomo_frontlight_set(locomolcd_dev, 163, 0, 148);\n\t\tbreak;\n\tcase 3:\n\t\tlocomo_frontlight_set(locomolcd_dev, 194, 0, 161);\n\t\tbreak;\n\tcase 4:\n\t\tlocomo_frontlight_set(locomolcd_dev, 194, 1, 161);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\tcurrent_intensity = intensity;\n\treturn 0;\n}\n\nstatic int locomolcd_get_intensity(struct backlight_device *bd)\n{\n\treturn current_intensity;\n}\n\nstatic const struct backlight_ops locomobl_data = {\n\t.get_brightness = locomolcd_get_intensity,\n\t.update_status  = locomolcd_set_intensity,\n};\n\n#ifdef CONFIG_PM_SLEEP\nstatic int locomolcd_suspend(struct device *dev)\n{\n\tlocomolcd_flags |= LOCOMOLCD_SUSPENDED;\n\tlocomolcd_set_intensity(locomolcd_bl_device);\n\treturn 0;\n}\n\nstatic int locomolcd_resume(struct device *dev)\n{\n\tlocomolcd_flags &= ~LOCOMOLCD_SUSPENDED;\n\tlocomolcd_set_intensity(locomolcd_bl_device);\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(locomolcd_pm_ops, locomolcd_suspend, locomolcd_resume);\n\nstatic int locomolcd_probe(struct locomo_dev *ldev)\n{\n\tstruct backlight_properties props;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\tlocomolcd_dev = ldev;\n\n\tlocomo_gpio_set_dir(ldev->dev.parent, LOCOMO_GPIO_FL_VR, 0);\n\n\tlocal_irq_restore(flags);\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = 4;\n\tlocomolcd_bl_device = backlight_device_register(\"locomo-bl\",\n\t\t\t\t\t\t\t&ldev->dev, NULL,\n\t\t\t\t\t\t\t&locomobl_data, &props);\n\n\tif (IS_ERR(locomolcd_bl_device))\n\t\treturn PTR_ERR(locomolcd_bl_device);\n\n\t \n\tlocomolcd_bl_device->props.brightness = 2;\n\tlocomolcd_set_intensity(locomolcd_bl_device);\n\n\treturn 0;\n}\n\nstatic void locomolcd_remove(struct locomo_dev *dev)\n{\n\tunsigned long flags;\n\n\tlocomolcd_bl_device->props.brightness = 0;\n\tlocomolcd_bl_device->props.power = 0;\n\tlocomolcd_set_intensity(locomolcd_bl_device);\n\n\tbacklight_device_unregister(locomolcd_bl_device);\n\tlocal_irq_save(flags);\n\tlocomolcd_dev = NULL;\n\tlocal_irq_restore(flags);\n}\n\nstatic struct locomo_driver poodle_lcd_driver = {\n\t.drv = {\n\t\t.name\t= \"locomo-backlight\",\n\t\t.pm\t= &locomolcd_pm_ops,\n\t},\n\t.devid\t= LOCOMO_DEVID_BACKLIGHT,\n\t.probe\t= locomolcd_probe,\n\t.remove\t= locomolcd_remove,\n};\n\nstatic int __init locomolcd_init(void)\n{\n\treturn locomo_driver_register(&poodle_lcd_driver);\n}\n\nstatic void __exit locomolcd_exit(void)\n{\n\tlocomo_driver_unregister(&poodle_lcd_driver);\n}\n\nmodule_init(locomolcd_init);\nmodule_exit(locomolcd_exit);\n\nMODULE_AUTHOR(\"John Lenz <lenz@cs.wisc.edu>, Pavel Machek <pavel@ucw.cz>\");\nMODULE_DESCRIPTION(\"Collie LCD driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}