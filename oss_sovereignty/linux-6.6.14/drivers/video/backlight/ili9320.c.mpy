{
  "module_name": "ili9320.c",
  "hash_id": "2fafb077ac3638805753018713b5edda4815d45d6454deec3c149d47e3243e50",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/ili9320.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/fb.h>\n#include <linux/init.h>\n#include <linux/lcd.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n\n#include <linux/spi/spi.h>\n\n#include <video/ili9320.h>\n\n#include \"ili9320.h\"\n\n\nstatic inline int ili9320_write_spi(struct ili9320 *ili,\n\t\t\t\t    unsigned int reg,\n\t\t\t\t    unsigned int value)\n{\n\tstruct ili9320_spi *spi = &ili->access.spi;\n\tunsigned char *addr = spi->buffer_addr;\n\tunsigned char *data = spi->buffer_data;\n\n\t \n\n\taddr[0] = spi->id | ILI9320_SPI_INDEX | ILI9320_SPI_WRITE;\n\taddr[1] = reg >> 8;\n\taddr[2] = reg;\n\n\t \n\n\tdata[0] = spi->id | ILI9320_SPI_DATA  | ILI9320_SPI_WRITE;\n\tdata[1] = value >> 8;\n\tdata[2] = value;\n\n\treturn spi_sync(spi->dev, &spi->message);\n}\n\nint ili9320_write(struct ili9320 *ili, unsigned int reg, unsigned int value)\n{\n\tdev_dbg(ili->dev, \"write: reg=%02x, val=%04x\\n\", reg, value);\n\treturn ili->write(ili, reg, value);\n}\nEXPORT_SYMBOL_GPL(ili9320_write);\n\nint ili9320_write_regs(struct ili9320 *ili,\n\t\t       const struct ili9320_reg *values,\n\t\t       int nr_values)\n{\n\tint index;\n\tint ret;\n\n\tfor (index = 0; index < nr_values; index++, values++) {\n\t\tret = ili9320_write(ili, values->address, values->value);\n\t\tif (ret != 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ili9320_write_regs);\n\nstatic void ili9320_reset(struct ili9320 *lcd)\n{\n\tstruct ili9320_platdata *cfg = lcd->platdata;\n\n\tcfg->reset(1);\n\tmdelay(50);\n\n\tcfg->reset(0);\n\tmdelay(50);\n\n\tcfg->reset(1);\n\tmdelay(100);\n}\n\nstatic inline int ili9320_init_chip(struct ili9320 *lcd)\n{\n\tint ret;\n\n\tili9320_reset(lcd);\n\n\tret = lcd->client->init(lcd, lcd->platdata);\n\tif (ret != 0) {\n\t\tdev_err(lcd->dev, \"failed to initialise display\\n\");\n\t\treturn ret;\n\t}\n\n\tlcd->initialised = 1;\n\treturn 0;\n}\n\nstatic inline int ili9320_power_on(struct ili9320 *lcd)\n{\n\tif (!lcd->initialised)\n\t\tili9320_init_chip(lcd);\n\n\tlcd->display1 |= (ILI9320_DISPLAY1_D(3) | ILI9320_DISPLAY1_BASEE);\n\tili9320_write(lcd, ILI9320_DISPLAY1, lcd->display1);\n\n\treturn 0;\n}\n\nstatic inline int ili9320_power_off(struct ili9320 *lcd)\n{\n\tlcd->display1 &= ~(ILI9320_DISPLAY1_D(3) | ILI9320_DISPLAY1_BASEE);\n\tili9320_write(lcd, ILI9320_DISPLAY1, lcd->display1);\n\n\treturn 0;\n}\n\n#define POWER_IS_ON(pwr)\t((pwr) <= FB_BLANK_NORMAL)\n\nstatic int ili9320_power(struct ili9320 *lcd, int power)\n{\n\tint ret = 0;\n\n\tdev_dbg(lcd->dev, \"power %d => %d\\n\", lcd->power, power);\n\n\tif (POWER_IS_ON(power) && !POWER_IS_ON(lcd->power))\n\t\tret = ili9320_power_on(lcd);\n\telse if (!POWER_IS_ON(power) && POWER_IS_ON(lcd->power))\n\t\tret = ili9320_power_off(lcd);\n\n\tif (ret == 0)\n\t\tlcd->power = power;\n\telse\n\t\tdev_warn(lcd->dev, \"failed to set power mode %d\\n\", power);\n\n\treturn ret;\n}\n\nstatic inline struct ili9320 *to_our_lcd(struct lcd_device *lcd)\n{\n\treturn lcd_get_data(lcd);\n}\n\nstatic int ili9320_set_power(struct lcd_device *ld, int power)\n{\n\tstruct ili9320 *lcd = to_our_lcd(ld);\n\n\treturn ili9320_power(lcd, power);\n}\n\nstatic int ili9320_get_power(struct lcd_device *ld)\n{\n\tstruct ili9320 *lcd = to_our_lcd(ld);\n\n\treturn lcd->power;\n}\n\nstatic struct lcd_ops ili9320_ops = {\n\t.get_power\t= ili9320_get_power,\n\t.set_power\t= ili9320_set_power,\n};\n\nstatic void ili9320_setup_spi(struct ili9320 *ili,\n\t\t\t\t\tstruct spi_device *dev)\n{\n\tstruct ili9320_spi *spi = &ili->access.spi;\n\n\tili->write = ili9320_write_spi;\n\tspi->dev = dev;\n\n\t \n\n\tspi->xfer[0].tx_buf = spi->buffer_addr;\n\tspi->xfer[1].tx_buf = spi->buffer_data;\n\tspi->xfer[0].len = 3;\n\tspi->xfer[1].len = 3;\n\tspi->xfer[0].bits_per_word = 8;\n\tspi->xfer[1].bits_per_word = 8;\n\tspi->xfer[0].cs_change = 1;\n\n\tspi_message_init(&spi->message);\n\tspi_message_add_tail(&spi->xfer[0], &spi->message);\n\tspi_message_add_tail(&spi->xfer[1], &spi->message);\n}\n\nint ili9320_probe_spi(struct spi_device *spi,\n\t\t\t\tstruct ili9320_client *client)\n{\n\tstruct ili9320_platdata *cfg = dev_get_platdata(&spi->dev);\n\tstruct device *dev = &spi->dev;\n\tstruct ili9320 *ili;\n\tstruct lcd_device *lcd;\n\tint ret = 0;\n\n\t \n\n\tif (cfg == NULL) {\n\t\tdev_err(dev, \"no platform data supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (cfg->hsize <= 0 || cfg->vsize <= 0 || cfg->reset == NULL) {\n\t\tdev_err(dev, \"invalid platform data supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\n\tili = devm_kzalloc(&spi->dev, sizeof(struct ili9320), GFP_KERNEL);\n\tif (ili == NULL)\n\t\treturn -ENOMEM;\n\n\tili->access.spi.id = ILI9320_SPI_IDCODE | ILI9320_SPI_ID(1);\n\n\tili->dev = dev;\n\tili->client = client;\n\tili->power = FB_BLANK_POWERDOWN;\n\tili->platdata = cfg;\n\n\tspi_set_drvdata(spi, ili);\n\n\tili9320_setup_spi(ili, spi);\n\n\tlcd = devm_lcd_device_register(&spi->dev, \"ili9320\", dev, ili,\n\t\t\t\t\t&ili9320_ops);\n\tif (IS_ERR(lcd)) {\n\t\tdev_err(dev, \"failed to register lcd device\\n\");\n\t\treturn PTR_ERR(lcd);\n\t}\n\n\tili->lcd = lcd;\n\n\tdev_info(dev, \"initialising %s\\n\", client->name);\n\n\tret = ili9320_power(ili, FB_BLANK_UNBLANK);\n\tif (ret != 0) {\n\t\tdev_err(dev, \"failed to set lcd power state\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ili9320_probe_spi);\n\nvoid ili9320_remove(struct ili9320 *ili)\n{\n\tili9320_power(ili, FB_BLANK_POWERDOWN);\n}\nEXPORT_SYMBOL_GPL(ili9320_remove);\n\n#ifdef CONFIG_PM_SLEEP\nint ili9320_suspend(struct ili9320 *lcd)\n{\n\tint ret;\n\n\tret = ili9320_power(lcd, FB_BLANK_POWERDOWN);\n\n\tif (lcd->platdata->suspend == ILI9320_SUSPEND_DEEP) {\n\t\tili9320_write(lcd, ILI9320_POWER1, lcd->power1 |\n\t\t\t      ILI9320_POWER1_SLP |\n\t\t\t      ILI9320_POWER1_DSTB);\n\t\tlcd->initialised = 0;\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(ili9320_suspend);\n\nint ili9320_resume(struct ili9320 *lcd)\n{\n\tdev_info(lcd->dev, \"resuming from power state %d\\n\", lcd->power);\n\n\tif (lcd->platdata->suspend == ILI9320_SUSPEND_DEEP)\n\t\tili9320_write(lcd, ILI9320_POWER1, 0x00);\n\n\treturn ili9320_power(lcd, FB_BLANK_UNBLANK);\n}\nEXPORT_SYMBOL_GPL(ili9320_resume);\n#endif\n\n \nvoid ili9320_shutdown(struct ili9320 *lcd)\n{\n\tili9320_power(lcd, FB_BLANK_POWERDOWN);\n}\nEXPORT_SYMBOL_GPL(ili9320_shutdown);\n\nMODULE_AUTHOR(\"Ben Dooks <ben-linux@fluff.org>\");\nMODULE_DESCRIPTION(\"ILI9320 LCD Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}