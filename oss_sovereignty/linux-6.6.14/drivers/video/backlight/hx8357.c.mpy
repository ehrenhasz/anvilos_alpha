{
  "module_name": "hx8357.c",
  "hash_id": "2ef67b0e8d0bbb650d770030a7d427e3183654072758eab7709bbdfb0a62023f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/hx8357.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/lcd.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/of_gpio.h>\n#include <linux/spi/spi.h>\n\n#define HX8357_NUM_IM_PINS\t3\n\n#define HX8357_SWRESET\t\t\t0x01\n#define HX8357_GET_RED_CHANNEL\t\t0x06\n#define HX8357_GET_GREEN_CHANNEL\t0x07\n#define HX8357_GET_BLUE_CHANNEL\t\t0x08\n#define HX8357_GET_POWER_MODE\t\t0x0a\n#define HX8357_GET_MADCTL\t\t0x0b\n#define HX8357_GET_PIXEL_FORMAT\t\t0x0c\n#define HX8357_GET_DISPLAY_MODE\t\t0x0d\n#define HX8357_GET_SIGNAL_MODE\t\t0x0e\n#define HX8357_GET_DIAGNOSTIC_RESULT\t0x0f\n#define HX8357_ENTER_SLEEP_MODE\t\t0x10\n#define HX8357_EXIT_SLEEP_MODE\t\t0x11\n#define HX8357_ENTER_PARTIAL_MODE\t0x12\n#define HX8357_ENTER_NORMAL_MODE\t0x13\n#define HX8357_EXIT_INVERSION_MODE\t0x20\n#define HX8357_ENTER_INVERSION_MODE\t0x21\n#define HX8357_SET_DISPLAY_OFF\t\t0x28\n#define HX8357_SET_DISPLAY_ON\t\t0x29\n#define HX8357_SET_COLUMN_ADDRESS\t0x2a\n#define HX8357_SET_PAGE_ADDRESS\t\t0x2b\n#define HX8357_WRITE_MEMORY_START\t0x2c\n#define HX8357_READ_MEMORY_START\t0x2e\n#define HX8357_SET_PARTIAL_AREA\t\t0x30\n#define HX8357_SET_SCROLL_AREA\t\t0x33\n#define HX8357_SET_TEAR_OFF\t\t0x34\n#define HX8357_SET_TEAR_ON\t\t0x35\n#define HX8357_SET_ADDRESS_MODE\t\t0x36\n#define HX8357_SET_SCROLL_START\t\t0x37\n#define HX8357_EXIT_IDLE_MODE\t\t0x38\n#define HX8357_ENTER_IDLE_MODE\t\t0x39\n#define HX8357_SET_PIXEL_FORMAT\t\t0x3a\n#define HX8357_SET_PIXEL_FORMAT_DBI_3BIT\t(0x1)\n#define HX8357_SET_PIXEL_FORMAT_DBI_16BIT\t(0x5)\n#define HX8357_SET_PIXEL_FORMAT_DBI_18BIT\t(0x6)\n#define HX8357_SET_PIXEL_FORMAT_DPI_3BIT\t(0x1 << 4)\n#define HX8357_SET_PIXEL_FORMAT_DPI_16BIT\t(0x5 << 4)\n#define HX8357_SET_PIXEL_FORMAT_DPI_18BIT\t(0x6 << 4)\n#define HX8357_WRITE_MEMORY_CONTINUE\t0x3c\n#define HX8357_READ_MEMORY_CONTINUE\t0x3e\n#define HX8357_SET_TEAR_SCAN_LINES\t0x44\n#define HX8357_GET_SCAN_LINES\t\t0x45\n#define HX8357_READ_DDB_START\t\t0xa1\n#define HX8357_SET_DISPLAY_MODE\t\t0xb4\n#define HX8357_SET_DISPLAY_MODE_RGB_THROUGH\t(0x3)\n#define HX8357_SET_DISPLAY_MODE_RGB_INTERFACE\t(1 << 4)\n#define HX8357_SET_PANEL_DRIVING\t0xc0\n#define HX8357_SET_DISPLAY_FRAME\t0xc5\n#define HX8357_SET_RGB\t\t\t0xc6\n#define HX8357_SET_RGB_ENABLE_HIGH\t\t(1 << 1)\n#define HX8357_SET_GAMMA\t\t0xc8\n#define HX8357_SET_POWER\t\t0xd0\n#define HX8357_SET_VCOM\t\t\t0xd1\n#define HX8357_SET_POWER_NORMAL\t\t0xd2\n#define HX8357_SET_PANEL_RELATED\t0xe9\n\n#define HX8369_SET_DISPLAY_BRIGHTNESS\t\t0x51\n#define HX8369_WRITE_CABC_DISPLAY_VALUE\t\t0x53\n#define HX8369_WRITE_CABC_BRIGHT_CTRL\t\t0x55\n#define HX8369_WRITE_CABC_MIN_BRIGHTNESS\t0x5e\n#define HX8369_SET_POWER\t\t\t0xb1\n#define HX8369_SET_DISPLAY_MODE\t\t\t0xb2\n#define HX8369_SET_DISPLAY_WAVEFORM_CYC\t\t0xb4\n#define HX8369_SET_VCOM\t\t\t\t0xb6\n#define HX8369_SET_EXTENSION_COMMAND\t\t0xb9\n#define HX8369_SET_GIP\t\t\t\t0xd5\n#define HX8369_SET_GAMMA_CURVE_RELATED\t\t0xe0\n\nstruct hx8357_data {\n\tunsigned\t\tim_pins[HX8357_NUM_IM_PINS];\n\tunsigned\t\treset;\n\tstruct spi_device\t*spi;\n\tint\t\t\tstate;\n\tbool\t\t\tuse_im_pins;\n};\n\nstatic u8 hx8357_seq_power[] = {\n\tHX8357_SET_POWER, 0x44, 0x41, 0x06,\n};\n\nstatic u8 hx8357_seq_vcom[] = {\n\tHX8357_SET_VCOM, 0x40, 0x10,\n};\n\nstatic u8 hx8357_seq_power_normal[] = {\n\tHX8357_SET_POWER_NORMAL, 0x05, 0x12,\n};\n\nstatic u8 hx8357_seq_panel_driving[] = {\n\tHX8357_SET_PANEL_DRIVING, 0x14, 0x3b, 0x00, 0x02, 0x11,\n};\n\nstatic u8 hx8357_seq_display_frame[] = {\n\tHX8357_SET_DISPLAY_FRAME, 0x0c,\n};\n\nstatic u8 hx8357_seq_panel_related[] = {\n\tHX8357_SET_PANEL_RELATED, 0x01,\n};\n\nstatic u8 hx8357_seq_undefined1[] = {\n\t0xea, 0x03, 0x00, 0x00,\n};\n\nstatic u8 hx8357_seq_undefined2[] = {\n\t0xeb, 0x40, 0x54, 0x26, 0xdb,\n};\n\nstatic u8 hx8357_seq_gamma[] = {\n\tHX8357_SET_GAMMA, 0x00, 0x15, 0x00, 0x22, 0x00,\n\t0x08, 0x77, 0x26, 0x77, 0x22, 0x04, 0x00,\n};\n\nstatic u8 hx8357_seq_address_mode[] = {\n\tHX8357_SET_ADDRESS_MODE, 0xc0,\n};\n\nstatic u8 hx8357_seq_pixel_format[] = {\n\tHX8357_SET_PIXEL_FORMAT,\n\tHX8357_SET_PIXEL_FORMAT_DPI_18BIT |\n\tHX8357_SET_PIXEL_FORMAT_DBI_18BIT,\n};\n\nstatic u8 hx8357_seq_column_address[] = {\n\tHX8357_SET_COLUMN_ADDRESS, 0x00, 0x00, 0x01, 0x3f,\n};\n\nstatic u8 hx8357_seq_page_address[] = {\n\tHX8357_SET_PAGE_ADDRESS, 0x00, 0x00, 0x01, 0xdf,\n};\n\nstatic u8 hx8357_seq_rgb[] = {\n\tHX8357_SET_RGB, 0x02,\n};\n\nstatic u8 hx8357_seq_display_mode[] = {\n\tHX8357_SET_DISPLAY_MODE,\n\tHX8357_SET_DISPLAY_MODE_RGB_THROUGH |\n\tHX8357_SET_DISPLAY_MODE_RGB_INTERFACE,\n};\n\nstatic u8 hx8369_seq_write_CABC_min_brightness[] = {\n\tHX8369_WRITE_CABC_MIN_BRIGHTNESS, 0x00,\n};\n\nstatic u8 hx8369_seq_write_CABC_control[] = {\n\tHX8369_WRITE_CABC_DISPLAY_VALUE, 0x24,\n};\n\nstatic u8 hx8369_seq_set_display_brightness[] = {\n\tHX8369_SET_DISPLAY_BRIGHTNESS, 0xFF,\n};\n\nstatic u8 hx8369_seq_write_CABC_control_setting[] = {\n\tHX8369_WRITE_CABC_BRIGHT_CTRL, 0x02,\n};\n\nstatic u8 hx8369_seq_extension_command[] = {\n\tHX8369_SET_EXTENSION_COMMAND, 0xff, 0x83, 0x69,\n};\n\nstatic u8 hx8369_seq_display_related[] = {\n\tHX8369_SET_DISPLAY_MODE, 0x00, 0x2b, 0x03, 0x03, 0x70, 0x00,\n\t0xff, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00,\t0x01,\n};\n\nstatic u8 hx8369_seq_panel_waveform_cycle[] = {\n\tHX8369_SET_DISPLAY_WAVEFORM_CYC, 0x0a, 0x1d, 0x80, 0x06, 0x02,\n};\n\nstatic u8 hx8369_seq_set_address_mode[] = {\n\tHX8357_SET_ADDRESS_MODE, 0x00,\n};\n\nstatic u8 hx8369_seq_vcom[] = {\n\tHX8369_SET_VCOM, 0x3e, 0x3e,\n};\n\nstatic u8 hx8369_seq_gip[] = {\n\tHX8369_SET_GIP, 0x00, 0x01, 0x03, 0x25, 0x01, 0x02, 0x28, 0x70,\n\t0x11, 0x13, 0x00, 0x00, 0x40, 0x26, 0x51, 0x37, 0x00, 0x00, 0x71,\n\t0x35, 0x60, 0x24, 0x07, 0x0f, 0x04, 0x04,\n};\n\nstatic u8 hx8369_seq_power[] = {\n\tHX8369_SET_POWER, 0x01, 0x00, 0x34, 0x03, 0x00, 0x11, 0x11, 0x32,\n\t0x2f, 0x3f, 0x3f, 0x01, 0x3a, 0x01, 0xe6, 0xe6, 0xe6, 0xe6, 0xe6,\n};\n\nstatic u8 hx8369_seq_gamma_curve_related[] = {\n\tHX8369_SET_GAMMA_CURVE_RELATED, 0x00, 0x0d, 0x19, 0x2f, 0x3b, 0x3d,\n\t0x2e, 0x4a, 0x08, 0x0e, 0x0f, 0x14, 0x16, 0x14, 0x14, 0x14, 0x1e,\n\t0x00, 0x0d, 0x19, 0x2f, 0x3b, 0x3d, 0x2e, 0x4a, 0x08, 0x0e, 0x0f,\n\t0x14, 0x16, 0x14, 0x14, 0x14, 0x1e,\n};\n\nstatic int hx8357_spi_write_then_read(struct lcd_device *lcdev,\n\t\t\t\tu8 *txbuf, u16 txlen,\n\t\t\t\tu8 *rxbuf, u16 rxlen)\n{\n\tstruct hx8357_data *lcd = lcd_get_data(lcdev);\n\tstruct spi_message msg;\n\tstruct spi_transfer xfer[2];\n\tu16 *local_txbuf = NULL;\n\tint ret = 0;\n\n\tmemset(xfer, 0, sizeof(xfer));\n\tspi_message_init(&msg);\n\n\tif (txlen) {\n\t\tint i;\n\n\t\tlocal_txbuf = kcalloc(txlen, sizeof(*local_txbuf), GFP_KERNEL);\n\n\t\tif (!local_txbuf)\n\t\t\treturn -ENOMEM;\n\n\t\tfor (i = 0; i < txlen; i++) {\n\t\t\tlocal_txbuf[i] = txbuf[i];\n\t\t\tif (i > 0)\n\t\t\t\tlocal_txbuf[i] |= 1 << 8;\n\t\t}\n\n\t\txfer[0].len = 2 * txlen;\n\t\txfer[0].bits_per_word = 9;\n\t\txfer[0].tx_buf = local_txbuf;\n\t\tspi_message_add_tail(&xfer[0], &msg);\n\t}\n\n\tif (rxlen) {\n\t\txfer[1].len = rxlen;\n\t\txfer[1].bits_per_word = 8;\n\t\txfer[1].rx_buf = rxbuf;\n\t\tspi_message_add_tail(&xfer[1], &msg);\n\t}\n\n\tret = spi_sync(lcd->spi, &msg);\n\tif (ret < 0)\n\t\tdev_err(&lcdev->dev, \"Couldn't send SPI data\\n\");\n\n\tif (txlen)\n\t\tkfree(local_txbuf);\n\n\treturn ret;\n}\n\nstatic inline int hx8357_spi_write_array(struct lcd_device *lcdev,\n\t\t\t\t\tu8 *value, u8 len)\n{\n\treturn hx8357_spi_write_then_read(lcdev, value, len, NULL, 0);\n}\n\nstatic inline int hx8357_spi_write_byte(struct lcd_device *lcdev,\n\t\t\t\t\tu8 value)\n{\n\treturn hx8357_spi_write_then_read(lcdev, &value, 1, NULL, 0);\n}\n\nstatic int hx8357_enter_standby(struct lcd_device *lcdev)\n{\n\tint ret;\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_OFF);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(10000, 12000);\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_ENTER_SLEEP_MODE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tmsleep(120);\n\n\treturn 0;\n}\n\nstatic int hx8357_exit_standby(struct lcd_device *lcdev)\n{\n\tint ret;\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tmsleep(120);\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_ON);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic void hx8357_lcd_reset(struct lcd_device *lcdev)\n{\n\tstruct hx8357_data *lcd = lcd_get_data(lcdev);\n\n\t \n\tgpio_set_value(lcd->reset, 1);\n\tusleep_range(10000, 12000);\n\tgpio_set_value(lcd->reset, 0);\n\tusleep_range(10000, 12000);\n\tgpio_set_value(lcd->reset, 1);\n\n\t \n\tmsleep(120);\n}\n\nstatic int hx8357_lcd_init(struct lcd_device *lcdev)\n{\n\tstruct hx8357_data *lcd = lcd_get_data(lcdev);\n\tint ret;\n\n\t \n\tif (lcd->use_im_pins) {\n\t\tgpio_set_value_cansleep(lcd->im_pins[0], 1);\n\t\tgpio_set_value_cansleep(lcd->im_pins[1], 0);\n\t\tgpio_set_value_cansleep(lcd->im_pins[2], 1);\n\t}\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_power,\n\t\t\t\tARRAY_SIZE(hx8357_seq_power));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_vcom,\n\t\t\t\tARRAY_SIZE(hx8357_seq_vcom));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_power_normal,\n\t\t\t\tARRAY_SIZE(hx8357_seq_power_normal));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_panel_driving,\n\t\t\t\tARRAY_SIZE(hx8357_seq_panel_driving));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_display_frame,\n\t\t\t\tARRAY_SIZE(hx8357_seq_display_frame));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_panel_related,\n\t\t\t\tARRAY_SIZE(hx8357_seq_panel_related));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_undefined1,\n\t\t\t\tARRAY_SIZE(hx8357_seq_undefined1));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_undefined2,\n\t\t\t\tARRAY_SIZE(hx8357_seq_undefined2));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_gamma,\n\t\t\t\tARRAY_SIZE(hx8357_seq_gamma));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_address_mode,\n\t\t\t\tARRAY_SIZE(hx8357_seq_address_mode));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_pixel_format,\n\t\t\t\tARRAY_SIZE(hx8357_seq_pixel_format));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_column_address,\n\t\t\t\tARRAY_SIZE(hx8357_seq_column_address));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_page_address,\n\t\t\t\tARRAY_SIZE(hx8357_seq_page_address));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_rgb,\n\t\t\t\tARRAY_SIZE(hx8357_seq_rgb));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8357_seq_display_mode,\n\t\t\t\tARRAY_SIZE(hx8357_seq_display_mode));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tmsleep(120);\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_ON);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(5000, 7000);\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_WRITE_MEMORY_START);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int hx8369_lcd_init(struct lcd_device *lcdev)\n{\n\tint ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_extension_command,\n\t\t\t\tARRAY_SIZE(hx8369_seq_extension_command));\n\tif (ret < 0)\n\t\treturn ret;\n\tusleep_range(10000, 12000);\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_display_related,\n\t\t\t\tARRAY_SIZE(hx8369_seq_display_related));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_panel_waveform_cycle,\n\t\t\t\tARRAY_SIZE(hx8369_seq_panel_waveform_cycle));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_set_address_mode,\n\t\t\t\tARRAY_SIZE(hx8369_seq_set_address_mode));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_vcom,\n\t\t\t\tARRAY_SIZE(hx8369_seq_vcom));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_gip,\n\t\t\t\tARRAY_SIZE(hx8369_seq_gip));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_power,\n\t\t\t\tARRAY_SIZE(hx8369_seq_power));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tmsleep(120);\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_gamma_curve_related,\n\t\t\t\tARRAY_SIZE(hx8369_seq_gamma_curve_related));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\n\tif (ret < 0)\n\t\treturn ret;\n\tusleep_range(1000, 1200);\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_write_CABC_control,\n\t\t\t\tARRAY_SIZE(hx8369_seq_write_CABC_control));\n\tif (ret < 0)\n\t\treturn ret;\n\tusleep_range(10000, 12000);\n\n\tret = hx8357_spi_write_array(lcdev,\n\t\t\thx8369_seq_write_CABC_control_setting,\n\t\t\tARRAY_SIZE(hx8369_seq_write_CABC_control_setting));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_array(lcdev,\n\t\t\thx8369_seq_write_CABC_min_brightness,\n\t\t\tARRAY_SIZE(hx8369_seq_write_CABC_min_brightness));\n\tif (ret < 0)\n\t\treturn ret;\n\tusleep_range(10000, 12000);\n\n\tret = hx8357_spi_write_array(lcdev, hx8369_seq_set_display_brightness,\n\t\t\t\tARRAY_SIZE(hx8369_seq_set_display_brightness));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_ON);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\n#define POWER_IS_ON(pwr)\t((pwr) <= FB_BLANK_NORMAL)\n\nstatic int hx8357_set_power(struct lcd_device *lcdev, int power)\n{\n\tstruct hx8357_data *lcd = lcd_get_data(lcdev);\n\tint ret = 0;\n\n\tif (POWER_IS_ON(power) && !POWER_IS_ON(lcd->state))\n\t\tret = hx8357_exit_standby(lcdev);\n\telse if (!POWER_IS_ON(power) && POWER_IS_ON(lcd->state))\n\t\tret = hx8357_enter_standby(lcdev);\n\n\tif (ret == 0)\n\t\tlcd->state = power;\n\telse\n\t\tdev_warn(&lcdev->dev, \"failed to set power mode %d\\n\", power);\n\n\treturn ret;\n}\n\nstatic int hx8357_get_power(struct lcd_device *lcdev)\n{\n\tstruct hx8357_data *lcd = lcd_get_data(lcdev);\n\n\treturn lcd->state;\n}\n\nstatic struct lcd_ops hx8357_ops = {\n\t.set_power\t= hx8357_set_power,\n\t.get_power\t= hx8357_get_power,\n};\n\nstatic const struct of_device_id hx8357_dt_ids[] = {\n\t{\n\t\t.compatible = \"himax,hx8357\",\n\t\t.data = hx8357_lcd_init,\n\t},\n\t{\n\t\t.compatible = \"himax,hx8369\",\n\t\t.data = hx8369_lcd_init,\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, hx8357_dt_ids);\n\nstatic int hx8357_probe(struct spi_device *spi)\n{\n\tstruct lcd_device *lcdev;\n\tstruct hx8357_data *lcd;\n\tconst struct of_device_id *match;\n\tint i, ret;\n\n\tlcd = devm_kzalloc(&spi->dev, sizeof(*lcd), GFP_KERNEL);\n\tif (!lcd)\n\t\treturn -ENOMEM;\n\n\tret = spi_setup(spi);\n\tif (ret < 0) {\n\t\tdev_err(&spi->dev, \"SPI setup failed.\\n\");\n\t\treturn ret;\n\t}\n\n\tlcd->spi = spi;\n\n\tmatch = of_match_device(hx8357_dt_ids, &spi->dev);\n\tif (!match || !match->data)\n\t\treturn -EINVAL;\n\n\tlcd->reset = of_get_named_gpio(spi->dev.of_node, \"gpios-reset\", 0);\n\tif (!gpio_is_valid(lcd->reset)) {\n\t\tdev_err(&spi->dev, \"Missing dt property: gpios-reset\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = devm_gpio_request_one(&spi->dev, lcd->reset,\n\t\t\t\t    GPIOF_OUT_INIT_HIGH,\n\t\t\t\t    \"hx8357-reset\");\n\tif (ret) {\n\t\tdev_err(&spi->dev,\n\t\t\t\"failed to request gpio %d: %d\\n\",\n\t\t\tlcd->reset, ret);\n\t\treturn -EINVAL;\n\t}\n\n\tif (of_property_present(spi->dev.of_node, \"im-gpios\")) {\n\t\tlcd->use_im_pins = 1;\n\n\t\tfor (i = 0; i < HX8357_NUM_IM_PINS; i++) {\n\t\t\tlcd->im_pins[i] = of_get_named_gpio(spi->dev.of_node,\n\t\t\t\t\t\t\t    \"im-gpios\", i);\n\t\t\tif (lcd->im_pins[i] == -EPROBE_DEFER) {\n\t\t\t\tdev_info(&spi->dev, \"GPIO requested is not here yet, deferring the probe\\n\");\n\t\t\t\treturn -EPROBE_DEFER;\n\t\t\t}\n\t\t\tif (!gpio_is_valid(lcd->im_pins[i])) {\n\t\t\t\tdev_err(&spi->dev, \"Missing dt property: im-gpios\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tret = devm_gpio_request_one(&spi->dev, lcd->im_pins[i],\n\t\t\t\t\t\t    GPIOF_OUT_INIT_LOW,\n\t\t\t\t\t\t    \"im_pins\");\n\t\t\tif (ret) {\n\t\t\t\tdev_err(&spi->dev, \"failed to request gpio %d: %d\\n\",\n\t\t\t\t\tlcd->im_pins[i], ret);\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlcd->use_im_pins = 0;\n\t}\n\n\tlcdev = devm_lcd_device_register(&spi->dev, \"mxsfb\", &spi->dev, lcd,\n\t\t\t\t\t&hx8357_ops);\n\tif (IS_ERR(lcdev)) {\n\t\tret = PTR_ERR(lcdev);\n\t\treturn ret;\n\t}\n\tspi_set_drvdata(spi, lcdev);\n\n\thx8357_lcd_reset(lcdev);\n\n\tret = ((int (*)(struct lcd_device *))match->data)(lcdev);\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Couldn't initialize panel\\n\");\n\t\treturn ret;\n\t}\n\n\tdev_info(&spi->dev, \"Panel probed\\n\");\n\n\treturn 0;\n}\n\nstatic struct spi_driver hx8357_driver = {\n\t.probe  = hx8357_probe,\n\t.driver = {\n\t\t.name = \"hx8357\",\n\t\t.of_match_table = hx8357_dt_ids,\n\t},\n};\n\nmodule_spi_driver(hx8357_driver);\n\nMODULE_AUTHOR(\"Maxime Ripard <maxime.ripard@free-electrons.com>\");\nMODULE_DESCRIPTION(\"Himax HX-8357 LCD Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}