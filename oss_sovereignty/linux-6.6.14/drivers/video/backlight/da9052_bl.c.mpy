{
  "module_name": "da9052_bl.c",
  "hash_id": "04be57d41882fdb1f94f303ea3c8b6e68e61244794d7f4b4f323364e6d261248",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/da9052_bl.c",
  "human_readable_source": "\n \n\n#include <linux/backlight.h>\n#include <linux/delay.h>\n#include <linux/fb.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <linux/mfd/da9052/da9052.h>\n#include <linux/mfd/da9052/reg.h>\n\n#define DA9052_MAX_BRIGHTNESS\t\t0xFF\n\nenum {\n\tDA9052_WLEDS_OFF,\n\tDA9052_WLEDS_ON,\n};\n\nenum {\n\tDA9052_TYPE_WLED1,\n\tDA9052_TYPE_WLED2,\n\tDA9052_TYPE_WLED3,\n};\n\nstatic const unsigned char wled_bank[] = {\n\tDA9052_LED1_CONF_REG,\n\tDA9052_LED2_CONF_REG,\n\tDA9052_LED3_CONF_REG,\n};\n\nstruct da9052_bl {\n\tstruct da9052 *da9052;\n\tuint brightness;\n\tuint state;\n\tuint led_reg;\n};\n\nstatic int da9052_adjust_wled_brightness(struct da9052_bl *wleds)\n{\n\tunsigned char boost_en;\n\tunsigned char i_sink;\n\tint ret;\n\n\tboost_en = 0x3F;\n\ti_sink = 0xFF;\n\tif (wleds->state == DA9052_WLEDS_OFF) {\n\t\tboost_en = 0x00;\n\t\ti_sink = 0x00;\n\t}\n\n\tret = da9052_reg_write(wleds->da9052, DA9052_BOOST_REG, boost_en);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = da9052_reg_write(wleds->da9052, DA9052_LED_CONT_REG, i_sink);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = da9052_reg_write(wleds->da9052, wled_bank[wleds->led_reg], 0x0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(10000, 11000);\n\n\tif (wleds->brightness) {\n\t\tret = da9052_reg_write(wleds->da9052, wled_bank[wleds->led_reg],\n\t\t\t\t       wleds->brightness);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int da9052_backlight_update_status(struct backlight_device *bl)\n{\n\tint brightness = bl->props.brightness;\n\tstruct da9052_bl *wleds = bl_get_data(bl);\n\n\twleds->brightness = brightness;\n\twleds->state = DA9052_WLEDS_ON;\n\n\treturn da9052_adjust_wled_brightness(wleds);\n}\n\nstatic int da9052_backlight_get_brightness(struct backlight_device *bl)\n{\n\tstruct da9052_bl *wleds = bl_get_data(bl);\n\n\treturn wleds->brightness;\n}\n\nstatic const struct backlight_ops da9052_backlight_ops = {\n\t.update_status = da9052_backlight_update_status,\n\t.get_brightness = da9052_backlight_get_brightness,\n};\n\nstatic int da9052_backlight_probe(struct platform_device *pdev)\n{\n\tstruct backlight_device *bl;\n\tstruct backlight_properties props;\n\tstruct da9052_bl *wleds;\n\n\twleds = devm_kzalloc(&pdev->dev, sizeof(struct da9052_bl), GFP_KERNEL);\n\tif (!wleds)\n\t\treturn -ENOMEM;\n\n\twleds->da9052 = dev_get_drvdata(pdev->dev.parent);\n\twleds->brightness = 0;\n\twleds->led_reg = platform_get_device_id(pdev)->driver_data;\n\twleds->state = DA9052_WLEDS_OFF;\n\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = DA9052_MAX_BRIGHTNESS;\n\n\tbl = devm_backlight_device_register(&pdev->dev, pdev->name,\n\t\t\t\t\twleds->da9052->dev, wleds,\n\t\t\t\t\t&da9052_backlight_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(&pdev->dev, \"Failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\n\tbl->props.max_brightness = DA9052_MAX_BRIGHTNESS;\n\tbl->props.brightness = 0;\n\tplatform_set_drvdata(pdev, bl);\n\n\treturn da9052_adjust_wled_brightness(wleds);\n}\n\nstatic void da9052_backlight_remove(struct platform_device *pdev)\n{\n\tstruct backlight_device *bl = platform_get_drvdata(pdev);\n\tstruct da9052_bl *wleds = bl_get_data(bl);\n\n\twleds->brightness = 0;\n\twleds->state = DA9052_WLEDS_OFF;\n\tda9052_adjust_wled_brightness(wleds);\n}\n\nstatic const struct platform_device_id da9052_wled_ids[] = {\n\t{\n\t\t.name\t\t= \"da9052-wled1\",\n\t\t.driver_data\t= DA9052_TYPE_WLED1,\n\t},\n\t{\n\t\t.name\t\t= \"da9052-wled2\",\n\t\t.driver_data\t= DA9052_TYPE_WLED2,\n\t},\n\t{\n\t\t.name\t\t= \"da9052-wled3\",\n\t\t.driver_data\t= DA9052_TYPE_WLED3,\n\t},\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, da9052_wled_ids);\n\nstatic struct platform_driver da9052_wled_driver = {\n\t.probe\t\t= da9052_backlight_probe,\n\t.remove_new\t= da9052_backlight_remove,\n\t.id_table\t= da9052_wled_ids,\n\t.driver\t= {\n\t\t.name\t= \"da9052-wled\",\n\t},\n};\n\nmodule_platform_driver(da9052_wled_driver);\n\nMODULE_AUTHOR(\"David Dajun Chen <dchen@diasemi.com>\");\nMODULE_DESCRIPTION(\"Backlight driver for DA9052 PMIC\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}