{
  "module_name": "tps65217_bl.c",
  "hash_id": "58017198449d501912ca8ca4b76cd9609effa9d3af0b480d3e7b5b28d2dbcb23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/tps65217_bl.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/backlight.h>\n#include <linux/err.h>\n#include <linux/fb.h>\n#include <linux/mfd/tps65217.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\nstruct tps65217_bl {\n\tstruct tps65217 *tps;\n\tstruct device *dev;\n\tstruct backlight_device *bl;\n\tbool is_enabled;\n};\n\nstatic int tps65217_bl_enable(struct tps65217_bl *tps65217_bl)\n{\n\tint rc;\n\n\trc = tps65217_set_bits(tps65217_bl->tps, TPS65217_REG_WLEDCTRL1,\n\t\t\tTPS65217_WLEDCTRL1_ISINK_ENABLE,\n\t\t\tTPS65217_WLEDCTRL1_ISINK_ENABLE, TPS65217_PROTECT_NONE);\n\tif (rc) {\n\t\tdev_err(tps65217_bl->dev,\n\t\t\t\"failed to enable backlight: %d\\n\", rc);\n\t\treturn rc;\n\t}\n\n\ttps65217_bl->is_enabled = true;\n\n\tdev_dbg(tps65217_bl->dev, \"backlight enabled\\n\");\n\n\treturn 0;\n}\n\nstatic int tps65217_bl_disable(struct tps65217_bl *tps65217_bl)\n{\n\tint rc;\n\n\trc = tps65217_clear_bits(tps65217_bl->tps,\n\t\t\t\tTPS65217_REG_WLEDCTRL1,\n\t\t\t\tTPS65217_WLEDCTRL1_ISINK_ENABLE,\n\t\t\t\tTPS65217_PROTECT_NONE);\n\tif (rc) {\n\t\tdev_err(tps65217_bl->dev,\n\t\t\t\"failed to disable backlight: %d\\n\", rc);\n\t\treturn rc;\n\t}\n\n\ttps65217_bl->is_enabled = false;\n\n\tdev_dbg(tps65217_bl->dev, \"backlight disabled\\n\");\n\n\treturn 0;\n}\n\nstatic int tps65217_bl_update_status(struct backlight_device *bl)\n{\n\tstruct tps65217_bl *tps65217_bl = bl_get_data(bl);\n\tint rc;\n\tint brightness = backlight_get_brightness(bl);\n\n\tif (brightness > 0) {\n\t\trc = tps65217_reg_write(tps65217_bl->tps,\n\t\t\t\t\tTPS65217_REG_WLEDCTRL2,\n\t\t\t\t\tbrightness - 1,\n\t\t\t\t\tTPS65217_PROTECT_NONE);\n\t\tif (rc) {\n\t\t\tdev_err(tps65217_bl->dev,\n\t\t\t\t\"failed to set brightness level: %d\\n\", rc);\n\t\t\treturn rc;\n\t\t}\n\n\t\tdev_dbg(tps65217_bl->dev, \"brightness set to %d\\n\", brightness);\n\n\t\tif (!tps65217_bl->is_enabled)\n\t\t\trc = tps65217_bl_enable(tps65217_bl);\n\t} else {\n\t\trc = tps65217_bl_disable(tps65217_bl);\n\t}\n\n\treturn rc;\n}\n\nstatic const struct backlight_ops tps65217_bl_ops = {\n\t.options\t= BL_CORE_SUSPENDRESUME,\n\t.update_status\t= tps65217_bl_update_status,\n};\n\nstatic int tps65217_bl_hw_init(struct tps65217_bl *tps65217_bl,\n\t\t\tstruct tps65217_bl_pdata *pdata)\n{\n\tint rc;\n\n\trc = tps65217_bl_disable(tps65217_bl);\n\tif (rc)\n\t\treturn rc;\n\n\tswitch (pdata->isel) {\n\tcase TPS65217_BL_ISET1:\n\t\t \n\t\trc = tps65217_clear_bits(tps65217_bl->tps,\n\t\t\t\t\tTPS65217_REG_WLEDCTRL1,\n\t\t\t\t\tTPS65217_WLEDCTRL1_ISEL,\n\t\t\t\t\tTPS65217_PROTECT_NONE);\n\t\tif (rc) {\n\t\t\tdev_err(tps65217_bl->dev,\n\t\t\t\t\"failed to select ISET1 current level: %d)\\n\",\n\t\t\t\trc);\n\t\t\treturn rc;\n\t\t}\n\n\t\tdev_dbg(tps65217_bl->dev, \"selected ISET1 current level\\n\");\n\n\t\tbreak;\n\n\tcase TPS65217_BL_ISET2:\n\t\t \n\t\trc = tps65217_set_bits(tps65217_bl->tps, TPS65217_REG_WLEDCTRL1,\n\t\t\t\tTPS65217_WLEDCTRL1_ISEL,\n\t\t\t\tTPS65217_WLEDCTRL1_ISEL, TPS65217_PROTECT_NONE);\n\t\tif (rc) {\n\t\t\tdev_err(tps65217_bl->dev,\n\t\t\t\t\"failed to select ISET2 current level: %d\\n\",\n\t\t\t\trc);\n\t\t\treturn rc;\n\t\t}\n\n\t\tdev_dbg(tps65217_bl->dev, \"selected ISET2 current level\\n\");\n\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(tps65217_bl->dev,\n\t\t\t\"invalid value for current level: %d\\n\", pdata->isel);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trc = tps65217_set_bits(tps65217_bl->tps,\n\t\t\tTPS65217_REG_WLEDCTRL1,\n\t\t\tTPS65217_WLEDCTRL1_FDIM_MASK,\n\t\t\tpdata->fdim,\n\t\t\tTPS65217_PROTECT_NONE);\n\tif (rc) {\n\t\tdev_err(tps65217_bl->dev,\n\t\t\t\"failed to select PWM dimming frequency: %d\\n\",\n\t\t\trc);\n\t\treturn rc;\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic struct tps65217_bl_pdata *\ntps65217_bl_parse_dt(struct platform_device *pdev)\n{\n\tstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct device_node *node;\n\tstruct tps65217_bl_pdata *pdata, *err;\n\tu32 val;\n\n\tnode = of_get_child_by_name(tps->dev->of_node, \"backlight\");\n\tif (!node)\n\t\treturn ERR_PTR(-ENODEV);\n\n\tpdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata) {\n\t\terr = ERR_PTR(-ENOMEM);\n\t\tgoto err;\n\t}\n\n\tpdata->isel = TPS65217_BL_ISET1;\n\tif (!of_property_read_u32(node, \"isel\", &val)) {\n\t\tif (val < TPS65217_BL_ISET1 ||\n\t\t\tval > TPS65217_BL_ISET2) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"invalid 'isel' value in the device tree\\n\");\n\t\t\terr = ERR_PTR(-EINVAL);\n\t\t\tgoto err;\n\t\t}\n\n\t\tpdata->isel = val;\n\t}\n\n\tpdata->fdim = TPS65217_BL_FDIM_200HZ;\n\tif (!of_property_read_u32(node, \"fdim\", &val)) {\n\t\tswitch (val) {\n\t\tcase 100:\n\t\t\tpdata->fdim = TPS65217_BL_FDIM_100HZ;\n\t\t\tbreak;\n\n\t\tcase 200:\n\t\t\tpdata->fdim = TPS65217_BL_FDIM_200HZ;\n\t\t\tbreak;\n\n\t\tcase 500:\n\t\t\tpdata->fdim = TPS65217_BL_FDIM_500HZ;\n\t\t\tbreak;\n\n\t\tcase 1000:\n\t\t\tpdata->fdim = TPS65217_BL_FDIM_1000HZ;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"invalid 'fdim' value in the device tree\\n\");\n\t\t\terr = ERR_PTR(-EINVAL);\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tif (!of_property_read_u32(node, \"default-brightness\", &val)) {\n\t\tif (val > 100) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"invalid 'default-brightness' value in the device tree\\n\");\n\t\t\terr = ERR_PTR(-EINVAL);\n\t\t\tgoto err;\n\t\t}\n\n\t\tpdata->dft_brightness = val;\n\t}\n\n\tof_node_put(node);\n\n\treturn pdata;\n\nerr:\n\tof_node_put(node);\n\n\treturn err;\n}\n#else\nstatic struct tps65217_bl_pdata *\ntps65217_bl_parse_dt(struct platform_device *pdev)\n{\n\treturn NULL;\n}\n#endif\n\nstatic int tps65217_bl_probe(struct platform_device *pdev)\n{\n\tint rc;\n\tstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct tps65217_bl *tps65217_bl;\n\tstruct tps65217_bl_pdata *pdata;\n\tstruct backlight_properties bl_props;\n\n\tpdata = tps65217_bl_parse_dt(pdev);\n\tif (IS_ERR(pdata))\n\t\treturn PTR_ERR(pdata);\n\n\ttps65217_bl = devm_kzalloc(&pdev->dev, sizeof(*tps65217_bl),\n\t\t\t\tGFP_KERNEL);\n\tif (tps65217_bl == NULL)\n\t\treturn -ENOMEM;\n\n\ttps65217_bl->tps = tps;\n\ttps65217_bl->dev = &pdev->dev;\n\ttps65217_bl->is_enabled = false;\n\n\trc = tps65217_bl_hw_init(tps65217_bl, pdata);\n\tif (rc)\n\t\treturn rc;\n\n\tmemset(&bl_props, 0, sizeof(struct backlight_properties));\n\tbl_props.type = BACKLIGHT_RAW;\n\tbl_props.max_brightness = 100;\n\n\ttps65217_bl->bl = devm_backlight_device_register(&pdev->dev, pdev->name,\n\t\t\t\t\t\ttps65217_bl->dev, tps65217_bl,\n\t\t\t\t\t\t&tps65217_bl_ops, &bl_props);\n\tif (IS_ERR(tps65217_bl->bl)) {\n\t\tdev_err(tps65217_bl->dev,\n\t\t\t\"registration of backlight device failed: %d\\n\", rc);\n\t\treturn PTR_ERR(tps65217_bl->bl);\n\t}\n\n\ttps65217_bl->bl->props.brightness = pdata->dft_brightness;\n\tbacklight_update_status(tps65217_bl->bl);\n\tplatform_set_drvdata(pdev, tps65217_bl);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id tps65217_bl_of_match[] = {\n\t{ .compatible = \"ti,tps65217-bl\", },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, tps65217_bl_of_match);\n#endif\n\nstatic struct platform_driver tps65217_bl_driver = {\n\t.probe\t\t= tps65217_bl_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"tps65217-bl\",\n\t\t.of_match_table = of_match_ptr(tps65217_bl_of_match),\n\t},\n};\n\nmodule_platform_driver(tps65217_bl_driver);\n\nMODULE_DESCRIPTION(\"TPS65217 Backlight driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Matthias Kaehlcke <matthias@kaehlcke.net>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}