{
  "module_name": "omap1_bl.c",
  "hash_id": "32aadcb82c33e309562d9a7141e0b97971e67106d33123aadf56c10aa8702f4f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/omap1_bl.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/slab.h>\n#include <linux/platform_data/omap1_bl.h>\n\n#include <linux/soc/ti/omap1-io.h>\n#include <linux/soc/ti/omap1-mux.h>\n\n#define OMAPBL_MAX_INTENSITY\t\t0xff\n\nstruct omap_backlight {\n\tint powermode;\n\tint current_intensity;\n\n\tstruct device *dev;\n\tstruct omap_backlight_config *pdata;\n};\n\nstatic inline void omapbl_send_intensity(int intensity)\n{\n\tomap_writeb(intensity, OMAP_PWL_ENABLE);\n}\n\nstatic inline void omapbl_send_enable(int enable)\n{\n\tomap_writeb(enable, OMAP_PWL_CLK_ENABLE);\n}\n\nstatic void omapbl_blank(struct omap_backlight *bl, int mode)\n{\n\tif (bl->pdata->set_power)\n\t\tbl->pdata->set_power(bl->dev, mode);\n\n\tswitch (mode) {\n\tcase FB_BLANK_NORMAL:\n\tcase FB_BLANK_VSYNC_SUSPEND:\n\tcase FB_BLANK_HSYNC_SUSPEND:\n\tcase FB_BLANK_POWERDOWN:\n\t\tomapbl_send_intensity(0);\n\t\tomapbl_send_enable(0);\n\t\tbreak;\n\n\tcase FB_BLANK_UNBLANK:\n\t\tomapbl_send_intensity(bl->current_intensity);\n\t\tomapbl_send_enable(1);\n\t\tbreak;\n\t}\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int omapbl_suspend(struct device *dev)\n{\n\tstruct backlight_device *bl_dev = dev_get_drvdata(dev);\n\tstruct omap_backlight *bl = bl_get_data(bl_dev);\n\n\tomapbl_blank(bl, FB_BLANK_POWERDOWN);\n\treturn 0;\n}\n\nstatic int omapbl_resume(struct device *dev)\n{\n\tstruct backlight_device *bl_dev = dev_get_drvdata(dev);\n\tstruct omap_backlight *bl = bl_get_data(bl_dev);\n\n\tomapbl_blank(bl, bl->powermode);\n\treturn 0;\n}\n#endif\n\nstatic int omapbl_set_power(struct backlight_device *dev, int state)\n{\n\tstruct omap_backlight *bl = bl_get_data(dev);\n\n\tomapbl_blank(bl, state);\n\tbl->powermode = state;\n\n\treturn 0;\n}\n\nstatic int omapbl_update_status(struct backlight_device *dev)\n{\n\tstruct omap_backlight *bl = bl_get_data(dev);\n\n\tif (bl->current_intensity != dev->props.brightness) {\n\t\tif (bl->powermode == FB_BLANK_UNBLANK)\n\t\t\tomapbl_send_intensity(dev->props.brightness);\n\t\tbl->current_intensity = dev->props.brightness;\n\t}\n\n\tif (dev->props.fb_blank != bl->powermode)\n\t\tomapbl_set_power(dev, dev->props.fb_blank);\n\n\treturn 0;\n}\n\nstatic int omapbl_get_intensity(struct backlight_device *dev)\n{\n\tstruct omap_backlight *bl = bl_get_data(dev);\n\n\treturn bl->current_intensity;\n}\n\nstatic const struct backlight_ops omapbl_ops = {\n\t.get_brightness = omapbl_get_intensity,\n\t.update_status  = omapbl_update_status,\n};\n\nstatic int omapbl_probe(struct platform_device *pdev)\n{\n\tstruct backlight_properties props;\n\tstruct backlight_device *dev;\n\tstruct omap_backlight *bl;\n\tstruct omap_backlight_config *pdata = dev_get_platdata(&pdev->dev);\n\n\tif (!pdata)\n\t\treturn -ENXIO;\n\n\tbl = devm_kzalloc(&pdev->dev, sizeof(struct omap_backlight),\n\t\t\t  GFP_KERNEL);\n\tif (unlikely(!bl))\n\t\treturn -ENOMEM;\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = OMAPBL_MAX_INTENSITY;\n\tdev = devm_backlight_device_register(&pdev->dev, \"omap-bl\", &pdev->dev,\n\t\t\t\t\tbl, &omapbl_ops, &props);\n\tif (IS_ERR(dev))\n\t\treturn PTR_ERR(dev);\n\n\tbl->powermode = FB_BLANK_POWERDOWN;\n\tbl->current_intensity = 0;\n\n\tbl->pdata = pdata;\n\tbl->dev = &pdev->dev;\n\n\tplatform_set_drvdata(pdev, dev);\n\n\tomap_cfg_reg(PWL);\t \n\n\tdev->props.fb_blank = FB_BLANK_UNBLANK;\n\tdev->props.brightness = pdata->default_intensity;\n\tomapbl_update_status(dev);\n\n\tdev_info(&pdev->dev, \"OMAP LCD backlight initialised\\n\");\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(omapbl_pm_ops, omapbl_suspend, omapbl_resume);\n\nstatic struct platform_driver omapbl_driver = {\n\t.probe\t\t= omapbl_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"omap-bl\",\n\t\t.pm\t= &omapbl_pm_ops,\n\t},\n};\n\nmodule_platform_driver(omapbl_driver);\n\nMODULE_AUTHOR(\"Andrzej Zaborowski <balrog@zabor.org>\");\nMODULE_DESCRIPTION(\"OMAP LCD Backlight driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}