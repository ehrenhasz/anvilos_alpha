{
  "module_name": "pandora_bl.c",
  "hash_id": "753d3065648c052bd8d554d6d60a25d69aacba85aa71b905c45c22f81dbc4345",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/pandora_bl.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/delay.h>\n#include <linux/fb.h>\n#include <linux/backlight.h>\n#include <linux/mfd/twl.h>\n#include <linux/err.h>\n\n#define TWL_PWM0_ON\t\t0x00\n#define TWL_PWM0_OFF\t\t0x01\n\n#define TWL_INTBR_GPBR1\t\t0x0c\n#define TWL_INTBR_PMBR1\t\t0x0d\n\n#define TWL_PMBR1_PWM0_MUXMASK\t0x0c\n#define TWL_PMBR1_PWM0\t\t0x04\n#define PWM0_CLK_ENABLE\t\tBIT(0)\n#define PWM0_ENABLE\t\tBIT(2)\n\n \n#define MIN_VALUE 9\n#define MAX_VALUE 63\n#define MAX_USER_VALUE (MAX_VALUE - MIN_VALUE)\n\nstruct pandora_private {\n\tunsigned old_state;\n#define PANDORABL_WAS_OFF 1\n};\n\nstatic int pandora_backlight_update_status(struct backlight_device *bl)\n{\n\tint brightness = bl->props.brightness;\n\tstruct pandora_private *priv = bl_get_data(bl);\n\tu8 r;\n\n\tif (bl->props.power != FB_BLANK_UNBLANK)\n\t\tbrightness = 0;\n\tif (bl->props.state & BL_CORE_FBBLANK)\n\t\tbrightness = 0;\n\tif (bl->props.state & BL_CORE_SUSPENDED)\n\t\tbrightness = 0;\n\n\tif ((unsigned int)brightness > MAX_USER_VALUE)\n\t\tbrightness = MAX_USER_VALUE;\n\n\tif (brightness == 0) {\n\t\tif (priv->old_state == PANDORABL_WAS_OFF)\n\t\t\tgoto done;\n\n\t\t \n\t\ttwl_i2c_read_u8(TWL4030_MODULE_INTBR, &r, TWL_INTBR_GPBR1);\n\t\tr &= ~PWM0_ENABLE;\n\t\ttwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\n\t\tr &= ~PWM0_CLK_ENABLE;\n\t\ttwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\n\n\t\tgoto done;\n\t}\n\n\tif (priv->old_state == PANDORABL_WAS_OFF) {\n\t\t \n\t\ttwl_i2c_write_u8(TWL_MODULE_PWM, MAX_VALUE, TWL_PWM0_OFF);\n\n\t\t \n\t\ttwl_i2c_read_u8(TWL4030_MODULE_INTBR, &r, TWL_INTBR_GPBR1);\n\t\tr &= ~PWM0_ENABLE;\n\t\tr |= PWM0_CLK_ENABLE;\n\t\ttwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\n\t\tr |= PWM0_ENABLE;\n\t\ttwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\n\n\t\t \n\t\tusleep_range(2000, 10000);\n\t}\n\n\ttwl_i2c_write_u8(TWL_MODULE_PWM, MIN_VALUE + brightness, TWL_PWM0_OFF);\n\ndone:\n\tif (brightness != 0)\n\t\tpriv->old_state = 0;\n\telse\n\t\tpriv->old_state = PANDORABL_WAS_OFF;\n\n\treturn 0;\n}\n\nstatic const struct backlight_ops pandora_backlight_ops = {\n\t.options\t= BL_CORE_SUSPENDRESUME,\n\t.update_status\t= pandora_backlight_update_status,\n};\n\nstatic int pandora_backlight_probe(struct platform_device *pdev)\n{\n\tstruct backlight_properties props;\n\tstruct backlight_device *bl;\n\tstruct pandora_private *priv;\n\tu8 r;\n\n\tpriv = devm_kmalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv) {\n\t\tdev_err(&pdev->dev, \"failed to allocate driver private data\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tmemset(&props, 0, sizeof(props));\n\tprops.max_brightness = MAX_USER_VALUE;\n\tprops.type = BACKLIGHT_RAW;\n\tbl = devm_backlight_device_register(&pdev->dev, pdev->name, &pdev->dev,\n\t\t\t\t\tpriv, &pandora_backlight_ops, &props);\n\tif (IS_ERR(bl)) {\n\t\tdev_err(&pdev->dev, \"failed to register backlight\\n\");\n\t\treturn PTR_ERR(bl);\n\t}\n\n\tplatform_set_drvdata(pdev, bl);\n\n\t \n\ttwl_i2c_write_u8(TWL_MODULE_PWM, 0x80, TWL_PWM0_ON);\n\n\tpriv->old_state = PANDORABL_WAS_OFF;\n\tbl->props.brightness = MAX_USER_VALUE;\n\tbacklight_update_status(bl);\n\n\t \n\ttwl_i2c_read_u8(TWL4030_MODULE_INTBR, &r, TWL_INTBR_PMBR1);\n\tr &= ~TWL_PMBR1_PWM0_MUXMASK;\n\tr |= TWL_PMBR1_PWM0;\n\ttwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_PMBR1);\n\n\treturn 0;\n}\n\nstatic struct platform_driver pandora_backlight_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"pandora-backlight\",\n\t},\n\t.probe\t\t= pandora_backlight_probe,\n};\n\nmodule_platform_driver(pandora_backlight_driver);\n\nMODULE_AUTHOR(\"Gra\u017evydas Ignotas <notasas@gmail.com>\");\nMODULE_DESCRIPTION(\"Pandora Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:pandora-backlight\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}