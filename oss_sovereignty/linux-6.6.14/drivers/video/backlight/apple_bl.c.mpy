{
  "module_name": "apple_bl.c",
  "hash_id": "31262aa7536ebbe1e6a00f5f50797547f4692597239ab38f10ad90da302a8c8c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/backlight/apple_bl.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/backlight.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/pci.h>\n#include <linux/acpi.h>\n#include <linux/atomic.h>\n#include <acpi/video.h>\n\nstatic struct backlight_device *apple_backlight_device;\n\nstruct hw_data {\n\t \n\tunsigned long iostart;\n\tunsigned long iolen;\n\t \n\tconst struct backlight_ops backlight_ops;\n\tvoid (*set_brightness)(int);\n};\n\nstatic const struct hw_data *hw_data;\n\n \nstatic int debug;\nmodule_param_named(debug, debug, int, 0644);\nMODULE_PARM_DESC(debug, \"Set to one to enable debugging messages.\");\n\n \nstatic void intel_chipset_set_brightness(int intensity)\n{\n\toutb(0x04 | (intensity << 4), 0xb3);\n\toutb(0xbf, 0xb2);\n}\n\nstatic int intel_chipset_send_intensity(struct backlight_device *bd)\n{\n\tint intensity = bd->props.brightness;\n\n\tif (debug)\n\t\tpr_debug(\"setting brightness to %d\\n\", intensity);\n\n\tintel_chipset_set_brightness(intensity);\n\treturn 0;\n}\n\nstatic int intel_chipset_get_intensity(struct backlight_device *bd)\n{\n\tint intensity;\n\n\toutb(0x03, 0xb3);\n\toutb(0xbf, 0xb2);\n\tintensity = inb(0xb3) >> 4;\n\n\tif (debug)\n\t\tpr_debug(\"read brightness of %d\\n\", intensity);\n\n\treturn intensity;\n}\n\nstatic const struct hw_data intel_chipset_data = {\n\t.iostart = 0xb2,\n\t.iolen = 2,\n\t.backlight_ops\t= {\n\t\t.options\t= BL_CORE_SUSPENDRESUME,\n\t\t.get_brightness\t= intel_chipset_get_intensity,\n\t\t.update_status\t= intel_chipset_send_intensity,\n\t},\n\t.set_brightness = intel_chipset_set_brightness,\n};\n\n \nstatic void nvidia_chipset_set_brightness(int intensity)\n{\n\toutb(0x04 | (intensity << 4), 0x52f);\n\toutb(0xbf, 0x52e);\n}\n\nstatic int nvidia_chipset_send_intensity(struct backlight_device *bd)\n{\n\tint intensity = bd->props.brightness;\n\n\tif (debug)\n\t\tpr_debug(\"setting brightness to %d\\n\", intensity);\n\n\tnvidia_chipset_set_brightness(intensity);\n\treturn 0;\n}\n\nstatic int nvidia_chipset_get_intensity(struct backlight_device *bd)\n{\n\tint intensity;\n\n\toutb(0x03, 0x52f);\n\toutb(0xbf, 0x52e);\n\tintensity = inb(0x52f) >> 4;\n\n\tif (debug)\n\t\tpr_debug(\"read brightness of %d\\n\", intensity);\n\n\treturn intensity;\n}\n\nstatic const struct hw_data nvidia_chipset_data = {\n\t.iostart = 0x52e,\n\t.iolen = 2,\n\t.backlight_ops\t\t= {\n\t\t.options\t= BL_CORE_SUSPENDRESUME,\n\t\t.get_brightness\t= nvidia_chipset_get_intensity,\n\t\t.update_status\t= nvidia_chipset_send_intensity\n\t},\n\t.set_brightness = nvidia_chipset_set_brightness,\n};\n\nstatic int apple_bl_add(struct acpi_device *dev)\n{\n\tstruct backlight_properties props;\n\tstruct pci_dev *host;\n\tint intensity;\n\n\thost = pci_get_domain_bus_and_slot(0, 0, 0);\n\n\tif (!host) {\n\t\tpr_err(\"unable to find PCI host\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (host->vendor == PCI_VENDOR_ID_INTEL)\n\t\thw_data = &intel_chipset_data;\n\telse if (host->vendor == PCI_VENDOR_ID_NVIDIA)\n\t\thw_data = &nvidia_chipset_data;\n\n\tpci_dev_put(host);\n\n\tif (!hw_data) {\n\t\tpr_err(\"unknown hardware\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\n\tintensity = hw_data->backlight_ops.get_brightness(NULL);\n\n\tif (!intensity) {\n\t\thw_data->set_brightness(1);\n\t\tif (!hw_data->backlight_ops.get_brightness(NULL))\n\t\t\treturn -ENODEV;\n\n\t\thw_data->set_brightness(0);\n\t}\n\n\tif (!request_region(hw_data->iostart, hw_data->iolen,\n\t\t\t    \"Apple backlight\"))\n\t\treturn -ENXIO;\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_PLATFORM;\n\tprops.max_brightness = 15;\n\tapple_backlight_device = backlight_device_register(\"apple_backlight\",\n\t\t\t\t  NULL, NULL, &hw_data->backlight_ops, &props);\n\n\tif (IS_ERR(apple_backlight_device)) {\n\t\trelease_region(hw_data->iostart, hw_data->iolen);\n\t\treturn PTR_ERR(apple_backlight_device);\n\t}\n\n\tapple_backlight_device->props.brightness =\n\t\thw_data->backlight_ops.get_brightness(apple_backlight_device);\n\tbacklight_update_status(apple_backlight_device);\n\n\treturn 0;\n}\n\nstatic void apple_bl_remove(struct acpi_device *dev)\n{\n\tbacklight_device_unregister(apple_backlight_device);\n\n\trelease_region(hw_data->iostart, hw_data->iolen);\n\thw_data = NULL;\n}\n\nstatic const struct acpi_device_id apple_bl_ids[] = {\n\t{\"APP0002\", 0},\n\t{\"\", 0},\n};\n\nstatic struct acpi_driver apple_bl_driver = {\n\t.name = \"Apple backlight\",\n\t.ids = apple_bl_ids,\n\t.ops = {\n\t\t.add = apple_bl_add,\n\t\t.remove = apple_bl_remove,\n\t},\n};\n\nstatic int __init apple_bl_init(void)\n{\n\t \n\tif (acpi_video_get_backlight_type() != acpi_backlight_vendor)\n\t\treturn -ENODEV;\n\n\treturn acpi_bus_register_driver(&apple_bl_driver);\n}\n\nstatic void __exit apple_bl_exit(void)\n{\n\tacpi_bus_unregister_driver(&apple_bl_driver);\n}\n\nmodule_init(apple_bl_init);\nmodule_exit(apple_bl_exit);\n\nMODULE_AUTHOR(\"Matthew Garrett <mjg@redhat.com>\");\nMODULE_DESCRIPTION(\"Apple Backlight Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(acpi, apple_bl_ids);\nMODULE_ALIAS(\"mbp_nvidia_bl\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}