{
  "module_name": "vgastate.c",
  "hash_id": "9c2f5b1923d3defdc7b8285536bc8c7fd4ce3ca5526c04f9a4fce3f6cb4f5918",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/vgastate.c",
  "human_readable_source": " \n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/fb.h>\n#include <linux/vmalloc.h>\n#include <video/vga.h>\n\nstruct regstate {\n\t__u8 *vga_font0;\n\t__u8 *vga_font1;\n\t__u8 *vga_text;\n\t__u8 *vga_cmap;\n\t__u8 *attr;\n\t__u8 *crtc;\n\t__u8 *gfx;\n\t__u8 *seq;\n\t__u8 misc;\n};\n\nstatic inline unsigned char vga_rcrtcs(void __iomem *regbase, unsigned short iobase,\n\t\t\t\t       unsigned char reg)\n{\n\tvga_w(regbase, iobase + 0x4, reg);\n\treturn vga_r(regbase, iobase + 0x5);\n}\n\nstatic inline void vga_wcrtcs(void __iomem *regbase, unsigned short iobase,\n\t\t\t      unsigned char reg, unsigned char val)\n{\n\tvga_w(regbase, iobase + 0x4, reg);\n\tvga_w(regbase, iobase + 0x5, val);\n}\n\nstatic void save_vga_text(struct vgastate *state, void __iomem *fbbase)\n{\n\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\tint i;\n\tu8 misc, attr10, gr4, gr5, gr6, seq1, seq2, seq4;\n\tunsigned short iobase;\n\n\t \n\tmisc = vga_r(state->vgabase, VGA_MIS_R);\n\tiobase = (misc & 1) ? 0x3d0 : 0x3b0;\n\n\tvga_r(state->vgabase, iobase + 0xa);\n\tvga_w(state->vgabase, VGA_ATT_W, 0x00);\n\tattr10 = vga_rattr(state->vgabase, 0x10);\n\tvga_r(state->vgabase, iobase + 0xa);\n\tvga_w(state->vgabase, VGA_ATT_W, 0x20);\n\n\tif (attr10 & 1)\n\t\treturn;\n\n\t \n\tgr4 = vga_rgfx(state->vgabase, VGA_GFX_PLANE_READ);\n\tgr5 = vga_rgfx(state->vgabase, VGA_GFX_MODE);\n\tgr6 = vga_rgfx(state->vgabase, VGA_GFX_MISC);\n\tseq2 = vga_rseq(state->vgabase, VGA_SEQ_PLANE_WRITE);\n\tseq4 = vga_rseq(state->vgabase, VGA_SEQ_MEMORY_MODE);\n\n\t \n\tseq1 = vga_rseq(state->vgabase, VGA_SEQ_CLOCK_MODE);\n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 | 1 << 5);\n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\n\n\t \n\tif (state->flags & VGA_SAVE_FONT0) {\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x4);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x2);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < 4 * 8192; i++)\n\t\t\tsaved->vga_font0[i] = vga_r(fbbase, i);\n\t}\n\n\t \n\tif (state->flags & VGA_SAVE_FONT1) {\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x8);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x3);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < state->memsize; i++)\n\t\t\tsaved->vga_font1[i] = vga_r(fbbase, i);\n\t}\n\n\t \n\tif (state->flags & VGA_SAVE_TEXT) {\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x1);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < 8192; i++)\n\t\t\tsaved->vga_text[i] = vga_r(fbbase, i);\n\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x2);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x1);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < 8192; i++)\n\t\t\tsaved->vga_text[8192+i] = vga_r(fbbase + 2 * 8192, i);\n\t}\n\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, seq2);\n\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, seq4);\n\n\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, gr4);\n\tvga_wgfx(state->vgabase, VGA_GFX_MODE, gr5);\n\tvga_wgfx(state->vgabase, VGA_GFX_MISC, gr6);\n\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 & ~(1 << 5));\n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\n\n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1);\n}\n\nstatic void restore_vga_text(struct vgastate *state, void __iomem *fbbase)\n{\n\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\tint i;\n\tu8 gr1, gr3, gr4, gr5, gr6, gr8;\n\tu8 seq1, seq2, seq4;\n\n\t \n\tgr1 = vga_rgfx(state->vgabase, VGA_GFX_SR_ENABLE);\n\tgr3 = vga_rgfx(state->vgabase, VGA_GFX_DATA_ROTATE);\n\tgr4 = vga_rgfx(state->vgabase, VGA_GFX_PLANE_READ);\n\tgr5 = vga_rgfx(state->vgabase, VGA_GFX_MODE);\n\tgr6 = vga_rgfx(state->vgabase, VGA_GFX_MISC);\n\tgr8 = vga_rgfx(state->vgabase, VGA_GFX_BIT_MASK);\n\tseq2 = vga_rseq(state->vgabase, VGA_SEQ_PLANE_WRITE);\n\tseq4 = vga_rseq(state->vgabase, VGA_SEQ_MEMORY_MODE);\n\n\t \n\tseq1 = vga_rseq(state->vgabase, VGA_SEQ_CLOCK_MODE);\n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 | 1 << 5);\n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\n\n\tif (state->depth == 4) {\n\t\tvga_wgfx(state->vgabase, VGA_GFX_DATA_ROTATE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_BIT_MASK, 0xff);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_SR_ENABLE, 0x00);\n\t}\n\n\t \n\tif (state->flags & VGA_SAVE_FONT0) {\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x4);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x2);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < 4 * 8192; i++)\n\t\t\tvga_w(fbbase, i, saved->vga_font0[i]);\n\t}\n\n\t \n\tif (state->flags & VGA_SAVE_FONT1) {\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x8);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x3);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < state->memsize; i++)\n\t\t\tvga_w(fbbase, i, saved->vga_font1[i]);\n\t}\n\n\t \n\tif (state->flags & VGA_SAVE_TEXT) {\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x1);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < 8192; i++)\n\t\t\tvga_w(fbbase, i, saved->vga_text[i]);\n\n\t\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x2);\n\t\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x1);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\n\t\tvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\n\t\tfor (i = 0; i < 8192; i++)\n\t\t\tvga_w(fbbase, i, saved->vga_text[8192+i]);\n\t}\n\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 & ~(1 << 5));\n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\n\n\t \n\tvga_wgfx(state->vgabase, VGA_GFX_SR_ENABLE, gr1);\n\tvga_wgfx(state->vgabase, VGA_GFX_DATA_ROTATE, gr3);\n\tvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, gr4);\n\tvga_wgfx(state->vgabase, VGA_GFX_MODE, gr5);\n\tvga_wgfx(state->vgabase, VGA_GFX_MISC, gr6);\n\tvga_wgfx(state->vgabase, VGA_GFX_BIT_MASK, gr8);\n\n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1);\n\tvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, seq2);\n\tvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, seq4);\n}\n\nstatic void save_vga_mode(struct vgastate *state)\n{\n\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\tunsigned short iobase;\n\tint i;\n\n\tsaved->misc = vga_r(state->vgabase, VGA_MIS_R);\n\tif (saved->misc & 1)\n\t\tiobase = 0x3d0;\n\telse\n\t\tiobase = 0x3b0;\n\n\tfor (i = 0; i < state->num_crtc; i++)\n\t\tsaved->crtc[i] = vga_rcrtcs(state->vgabase, iobase, i);\n\n\tvga_r(state->vgabase, iobase + 0xa);\n\tvga_w(state->vgabase, VGA_ATT_W, 0x00);\n\tfor (i = 0; i < state->num_attr; i++) {\n\t\tvga_r(state->vgabase, iobase + 0xa);\n\t\tsaved->attr[i] = vga_rattr(state->vgabase, i);\n\t}\n\tvga_r(state->vgabase, iobase + 0xa);\n\tvga_w(state->vgabase, VGA_ATT_W, 0x20);\n\n\tfor (i = 0; i < state->num_gfx; i++)\n\t\tsaved->gfx[i] = vga_rgfx(state->vgabase, i);\n\n\tfor (i = 0; i < state->num_seq; i++)\n\t\tsaved->seq[i] = vga_rseq(state->vgabase, i);\n}\n\nstatic void restore_vga_mode(struct vgastate *state)\n{\n\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\tunsigned short iobase;\n\tint i;\n\n\tvga_w(state->vgabase, VGA_MIS_W, saved->misc);\n\n\tif (saved->misc & 1)\n\t\tiobase = 0x3d0;\n\telse\n\t\tiobase = 0x3b0;\n\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE,\n\t\t saved->seq[VGA_SEQ_CLOCK_MODE] | 0x20);\n\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x01);\n\n\t \n\tvga_r(state->vgabase, iobase + 0xa);\n\tvga_w(state->vgabase, VGA_ATT_W, 0x00);\n\n\tfor (i = 2; i < state->num_seq; i++)\n\t\tvga_wseq(state->vgabase, i, saved->seq[i]);\n\n\n\t \n\tvga_wcrtcs(state->vgabase, iobase, 17, saved->crtc[17] & ~0x80);\n\tfor (i = 0; i < state->num_crtc; i++)\n\t\tvga_wcrtcs(state->vgabase, iobase, i, saved->crtc[i]);\n\n\tfor (i = 0; i < state->num_gfx; i++)\n\t\tvga_wgfx(state->vgabase, i, saved->gfx[i]);\n\n\tfor (i = 0; i < state->num_attr; i++) {\n\t\tvga_r(state->vgabase, iobase + 0xa);\n\t\tvga_wattr(state->vgabase, i, saved->attr[i]);\n\t}\n\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x03);\n\t \n\tvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE,\n\t\t saved->seq[VGA_SEQ_CLOCK_MODE] & ~(1 << 5));\n\n\t \n\tvga_r(state->vgabase, iobase + 0xa);\n\tvga_w(state->vgabase, VGA_ATT_W, 0x20);\n}\n\nstatic void save_vga_cmap(struct vgastate *state)\n{\n\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\tint i;\n\n\tvga_w(state->vgabase, VGA_PEL_MSK, 0xff);\n\n\t \n\tvga_w(state->vgabase, VGA_PEL_IR, 0x00);\n\tfor (i = 0; i < 768; i++)\n\t\tsaved->vga_cmap[i] = vga_r(state->vgabase, VGA_PEL_D);\n}\n\nstatic void restore_vga_cmap(struct vgastate *state)\n{\n\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\tint i;\n\n\tvga_w(state->vgabase, VGA_PEL_MSK, 0xff);\n\n\t \n\tvga_w(state->vgabase, VGA_PEL_IW, 0x00);\n\tfor (i = 0; i < 768; i++)\n\t\tvga_w(state->vgabase, VGA_PEL_D, saved->vga_cmap[i]);\n}\n\nstatic void vga_cleanup(struct vgastate *state)\n{\n\tif (state->vidstate != NULL) {\n\t\tstruct regstate *saved = (struct regstate *) state->vidstate;\n\n\t\tvfree(saved->vga_font0);\n\t\tvfree(saved->vga_font1);\n\t\tvfree(saved->vga_text);\n\t\tvfree(saved->vga_cmap);\n\t\tvfree(saved->attr);\n\t\tkfree(saved);\n\t\tstate->vidstate = NULL;\n\t}\n}\n\nint save_vga(struct vgastate *state)\n{\n\tstruct regstate *saved;\n\n\tsaved = kzalloc(sizeof(struct regstate), GFP_KERNEL);\n\n\tif (saved == NULL)\n\t\treturn 1;\n\n\tstate->vidstate = (void *)saved;\n\n\tif (state->flags & VGA_SAVE_CMAP) {\n\t\tsaved->vga_cmap = vmalloc(768);\n\t\tif (!saved->vga_cmap) {\n\t\t\tvga_cleanup(state);\n\t\t\treturn 1;\n\t\t}\n\t\tsave_vga_cmap(state);\n\t}\n\n\tif (state->flags & VGA_SAVE_MODE) {\n\t\tint total;\n\n\t\tif (state->num_attr < 21)\n\t\t\tstate->num_attr = 21;\n\t\tif (state->num_crtc < 25)\n\t\t\tstate->num_crtc = 25;\n\t\tif (state->num_gfx < 9)\n\t\t\tstate->num_gfx = 9;\n\t\tif (state->num_seq < 5)\n\t\t\tstate->num_seq = 5;\n\t\ttotal = state->num_attr + state->num_crtc +\n\t\t\tstate->num_gfx + state->num_seq;\n\n\t\tsaved->attr = vmalloc(total);\n\t\tif (!saved->attr) {\n\t\t\tvga_cleanup(state);\n\t\t\treturn 1;\n\t\t}\n\t\tsaved->crtc = saved->attr + state->num_attr;\n\t\tsaved->gfx = saved->crtc + state->num_crtc;\n\t\tsaved->seq = saved->gfx + state->num_gfx;\n\n\t\tsave_vga_mode(state);\n\t}\n\n\tif (state->flags & VGA_SAVE_FONTS) {\n\t\tvoid __iomem *fbbase;\n\n\t\t \n\t\tif (state->memsize && state->memsize < 4 * 8192) {\n\t\t\tvga_cleanup(state);\n\t\t\treturn 1;\n\t\t}\n\t\tif (!state->memsize)\n\t\t\tstate->memsize = 8 * 8192;\n\n\t\tif (!state->membase)\n\t\t\tstate->membase = 0xA0000;\n\n\t\tfbbase = ioremap(state->membase, state->memsize);\n\n\t\tif (!fbbase) {\n\t\t\tvga_cleanup(state);\n\t\t\treturn 1;\n\t\t}\n\n\t\t \n\t\tif (state->flags & VGA_SAVE_FONT0) {\n\t\t\tsaved->vga_font0 = vmalloc(4 * 8192);\n\t\t\tif (!saved->vga_font0) {\n\t\t\t\tiounmap(fbbase);\n\t\t\t\tvga_cleanup(state);\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (state->flags & VGA_SAVE_FONT1) {\n\t\t\tsaved->vga_font1 = vmalloc(state->memsize);\n\t\t\tif (!saved->vga_font1) {\n\t\t\t\tiounmap(fbbase);\n\t\t\t\tvga_cleanup(state);\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (state->flags & VGA_SAVE_TEXT) {\n\t\t\tsaved->vga_text = vmalloc(8192 * 2);\n\t\t\tif (!saved->vga_text) {\n\t\t\t\tiounmap(fbbase);\n\t\t\t\tvga_cleanup(state);\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t}\n\n\t\tsave_vga_text(state, fbbase);\n\t\tiounmap(fbbase);\n\t}\n\treturn 0;\n}\n\nint restore_vga(struct vgastate *state)\n{\n\tif (state->vidstate == NULL)\n\t\treturn 1;\n\n\tif (state->flags & VGA_SAVE_MODE)\n\t\trestore_vga_mode(state);\n\n\tif (state->flags & VGA_SAVE_FONTS) {\n\t\tvoid __iomem *fbbase = ioremap(state->membase, state->memsize);\n\n\t\tif (!fbbase) {\n\t\t\tvga_cleanup(state);\n\t\t\treturn 1;\n\t\t}\n\t\trestore_vga_text(state, fbbase);\n\t\tiounmap(fbbase);\n\t}\n\n\tif (state->flags & VGA_SAVE_CMAP)\n\t\trestore_vga_cmap(state);\n\n\tvga_cleanup(state);\n\treturn 0;\n}\n\nEXPORT_SYMBOL(save_vga);\nEXPORT_SYMBOL(restore_vga);\n\nMODULE_AUTHOR(\"James Simmons <jsimmons@users.sf.net>\");\nMODULE_DESCRIPTION(\"VGA State Save/Restore\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}