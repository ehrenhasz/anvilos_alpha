{
  "module_name": "sunxvr2500.c",
  "hash_id": "11c1698670c06bf78425d5e70de20bb6f4eb9ae1f07103c2c8fa41e5021a8da5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/sunxvr2500.c",
  "human_readable_source": " \n\n#include <linux/aperture.h>\n#include <linux/kernel.h>\n#include <linux/fb.h>\n#include <linux/pci.h>\n#include <linux/init.h>\n#include <linux/of.h>\n\n#include <asm/io.h>\n\nstruct s3d_info {\n\tstruct fb_info\t\t*info;\n\tstruct pci_dev\t\t*pdev;\n\n\tchar __iomem\t\t*fb_base;\n\tunsigned long\t\tfb_base_phys;\n\n\tstruct device_node\t*of_node;\n\n\tunsigned int\t\twidth;\n\tunsigned int\t\theight;\n\tunsigned int\t\tdepth;\n\tunsigned int\t\tfb_size;\n\n\tu32\t\t\tpseudo_palette[16];\n};\n\nstatic int s3d_get_props(struct s3d_info *sp)\n{\n\tsp->width = of_getintprop_default(sp->of_node, \"width\", 0);\n\tsp->height = of_getintprop_default(sp->of_node, \"height\", 0);\n\tsp->depth = of_getintprop_default(sp->of_node, \"depth\", 8);\n\n\tif (!sp->width || !sp->height) {\n\t\tprintk(KERN_ERR \"s3d: Critical properties missing for %s\\n\",\n\t\t       pci_name(sp->pdev));\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int s3d_setcolreg(unsigned regno,\n\t\t\t unsigned red, unsigned green, unsigned blue,\n\t\t\t unsigned transp, struct fb_info *info)\n{\n\tu32 value;\n\n\tif (regno < 16) {\n\t\tred >>= 8;\n\t\tgreen >>= 8;\n\t\tblue >>= 8;\n\n\t\tvalue = (blue << 24) | (green << 16) | (red << 8);\n\t\t((u32 *)info->pseudo_palette)[regno] = value;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct fb_ops s3d_ops = {\n\t.owner\t\t\t= THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_setcolreg\t\t= s3d_setcolreg,\n};\n\nstatic int s3d_set_fbinfo(struct s3d_info *sp)\n{\n\tstruct fb_info *info = sp->info;\n\tstruct fb_var_screeninfo *var = &info->var;\n\n\tinfo->fbops = &s3d_ops;\n\tinfo->screen_base = sp->fb_base;\n\tinfo->screen_size = sp->fb_size;\n\n\tinfo->pseudo_palette = sp->pseudo_palette;\n\n\t \n\tstrscpy(info->fix.id, \"s3d\", sizeof(info->fix.id));\n        info->fix.smem_start = sp->fb_base_phys;\n        info->fix.smem_len = sp->fb_size;\n        info->fix.type = FB_TYPE_PACKED_PIXELS;\n\tif (sp->depth == 32 || sp->depth == 24)\n\t\tinfo->fix.visual = FB_VISUAL_TRUECOLOR;\n\telse\n\t\tinfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\n\n\tvar->xres = sp->width;\n\tvar->yres = sp->height;\n\tvar->xres_virtual = var->xres;\n\tvar->yres_virtual = var->yres;\n\tvar->bits_per_pixel = sp->depth;\n\n\tvar->red.offset = 8;\n\tvar->red.length = 8;\n\tvar->green.offset = 16;\n\tvar->green.length = 8;\n\tvar->blue.offset = 24;\n\tvar->blue.length = 8;\n\tvar->transp.offset = 0;\n\tvar->transp.length = 0;\n\n\tif (fb_alloc_cmap(&info->cmap, 256, 0)) {\n\t\tprintk(KERN_ERR \"s3d: Cannot allocate color map.\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n        return 0;\n}\n\nstatic int s3d_pci_register(struct pci_dev *pdev,\n\t\t\t    const struct pci_device_id *ent)\n{\n\tstruct fb_info *info;\n\tstruct s3d_info *sp;\n\tint err;\n\n\terr = aperture_remove_conflicting_pci_devices(pdev, \"s3dfb\");\n\tif (err)\n\t\treturn err;\n\n\terr = pci_enable_device(pdev);\n\tif (err < 0) {\n\t\tprintk(KERN_ERR \"s3d: Cannot enable PCI device %s\\n\",\n\t\t       pci_name(pdev));\n\t\tgoto err_out;\n\t}\n\n\tinfo = framebuffer_alloc(sizeof(struct s3d_info), &pdev->dev);\n\tif (!info) {\n\t\terr = -ENOMEM;\n\t\tgoto err_disable;\n\t}\n\n\tsp = info->par;\n\tsp->info = info;\n\tsp->pdev = pdev;\n\tsp->of_node = pci_device_to_OF_node(pdev);\n\tif (!sp->of_node) {\n\t\tprintk(KERN_ERR \"s3d: Cannot find OF node of %s\\n\",\n\t\t       pci_name(pdev));\n\t\terr = -ENODEV;\n\t\tgoto err_release_fb;\n\t}\n\n\tsp->fb_base_phys = pci_resource_start (pdev, 1);\n\n\terr = pci_request_region(pdev, 1, \"s3d framebuffer\");\n\tif (err < 0) {\n\t\tprintk(\"s3d: Cannot request region 1 for %s\\n\",\n\t\t       pci_name(pdev));\n\t\tgoto err_release_fb;\n\t}\n\n\terr = s3d_get_props(sp);\n\tif (err)\n\t\tgoto err_release_pci;\n\n\t \n\tswitch (sp->depth) {\n\tcase 8:\n\t\tinfo->fix.line_length = sp->width;\n\t\tbreak;\n\tcase 16:\n\t\tinfo->fix.line_length = sp->width * 2;\n\t\tbreak;\n\tcase 24:\n\t\tinfo->fix.line_length = sp->width * 3;\n\t\tbreak;\n\tcase 32:\n\t\tinfo->fix.line_length = sp->width * 4;\n\t\tbreak;\n\t}\n\tsp->fb_size = info->fix.line_length * sp->height;\n\n\tsp->fb_base = ioremap(sp->fb_base_phys, sp->fb_size);\n\tif (!sp->fb_base) {\n\t\terr = -ENOMEM;\n\t\tgoto err_release_pci;\n\t}\n\n\terr = s3d_set_fbinfo(sp);\n\tif (err)\n\t\tgoto err_unmap_fb;\n\n\tpci_set_drvdata(pdev, info);\n\n\tprintk(\"s3d: Found device at %s\\n\", pci_name(pdev));\n\n\terr = register_framebuffer(info);\n\tif (err < 0) {\n\t\tprintk(KERN_ERR \"s3d: Could not register framebuffer %s\\n\",\n\t\t       pci_name(pdev));\n\t\tgoto err_unmap_fb;\n\t}\n\n\treturn 0;\n\nerr_unmap_fb:\n\tiounmap(sp->fb_base);\n\nerr_release_pci:\n\tpci_release_region(pdev, 1);\n\nerr_release_fb:\n        framebuffer_release(info);\n\nerr_disable:\n\tpci_disable_device(pdev);\n\nerr_out:\n\treturn err;\n}\n\nstatic const struct pci_device_id s3d_pci_table[] = {\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x002c),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x002d),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x002e),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x002f),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x0030),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x0031),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x0032),\t},\n\t{\tPCI_DEVICE(PCI_VENDOR_ID_3DLABS, 0x0033),\t},\n\t{ 0, }\n};\n\nstatic struct pci_driver s3d_driver = {\n\t.driver = {\n\t\t.suppress_bind_attrs = true,\n\t},\n\t.name\t\t= \"s3d\",\n\t.id_table\t= s3d_pci_table,\n\t.probe\t\t= s3d_pci_register,\n};\n\nstatic int __init s3d_init(void)\n{\n\tif (fb_modesetting_disabled(\"s3d\"))\n\t\treturn -ENODEV;\n\n\tif (fb_get_options(\"s3d\", NULL))\n\t\treturn -ENODEV;\n\n\treturn pci_register_driver(&s3d_driver);\n}\ndevice_initcall(s3d_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}