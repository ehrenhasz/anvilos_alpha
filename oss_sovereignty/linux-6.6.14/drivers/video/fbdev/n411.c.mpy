{
  "module_name": "n411.c",
  "hash_id": "dfd80515156313dc7552204b3ec22a2d69e32e35b984f715750cf4893cf2bc9c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/n411.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/string.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/fb.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/list.h>\n#include <linux/uaccess.h>\n#include <linux/irq.h>\n\n#include <video/hecubafb.h>\n\nstatic unsigned long dio_addr;\nstatic unsigned long cio_addr;\nstatic unsigned long c2io_addr;\nstatic unsigned long splashval;\nstatic unsigned int nosplash;\nstatic unsigned char ctl;\n\nstatic void n411_set_ctl(struct hecubafb_par *par, unsigned char bit, unsigned\n\t\t\t\t\t\t\tchar state)\n{\n\tswitch (bit) {\n\tcase HCB_CD_BIT:\n\t\tif (state)\n\t\t\tctl &= ~(HCB_CD_BIT);\n\t\telse\n\t\t\tctl |= HCB_CD_BIT;\n\t\tbreak;\n\tcase HCB_DS_BIT:\n\t\tif (state)\n\t\t\tctl &= ~(HCB_DS_BIT);\n\t\telse\n\t\t\tctl |= HCB_DS_BIT;\n\t\tbreak;\n\t}\n\toutb(ctl, cio_addr);\n}\n\nstatic unsigned char n411_get_ctl(struct hecubafb_par *par)\n{\n\treturn inb(c2io_addr);\n}\n\nstatic void n411_set_data(struct hecubafb_par *par, unsigned char value)\n{\n\toutb(value, dio_addr);\n}\n\nstatic void n411_wait_for_ack(struct hecubafb_par *par, int clear)\n{\n\tint timeout;\n\tunsigned char tmp;\n\n\ttimeout = 500;\n\tdo {\n\t\ttmp = n411_get_ctl(par);\n\t\tif ((tmp & HCB_ACK_BIT) && (!clear))\n\t\t\treturn;\n\t\telse if (!(tmp & HCB_ACK_BIT) && (clear))\n\t\t\treturn;\n\t\tudelay(1);\n\t} while (timeout--);\n\tprintk(KERN_ERR \"timed out waiting for ack\\n\");\n}\n\nstatic int n411_init_control(struct hecubafb_par *par)\n{\n\tunsigned char tmp;\n\t \n\n\t \n\tctl = HCB_WUP_BIT | HCB_RW_BIT | HCB_CD_BIT ;\n\tn411_set_ctl(par, HCB_DS_BIT, 1);\n\n\t \n\ttmp = n411_get_ctl(par);\n\tif (tmp & HCB_ACK_BIT) {\n\t\tprintk(KERN_ERR \"Fail because ACK is already low\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\treturn 0;\n}\n\n\nstatic int n411_init_board(struct hecubafb_par *par)\n{\n\tint retval;\n\n\tretval = n411_init_control(par);\n\tif (retval)\n\t\treturn retval;\n\n\tpar->send_command(par, APOLLO_INIT_DISPLAY);\n\tpar->send_data(par, 0x81);\n\n\t \n\tudelay(1000);\n\n\t \n\tif (!nosplash) {\n\t\tpar->send_command(par, APOLLO_ERASE_DISPLAY);\n\t\tpar->send_data(par, splashval);\n\t}\n\n\treturn 0;\n}\n\nstatic struct hecuba_board n411_board = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.init\t\t\t= n411_init_board,\n\t.set_ctl\t\t= n411_set_ctl,\n\t.set_data\t\t= n411_set_data,\n\t.wait_for_ack\t\t= n411_wait_for_ack,\n};\n\nstatic struct platform_device *n411_device;\nstatic int __init n411_init(void)\n{\n\tint ret;\n\tif (!dio_addr || !cio_addr || !c2io_addr) {\n\t\tprintk(KERN_WARNING \"no IO addresses supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trequest_module(\"hecubafb\");\n\n\tn411_device = platform_device_alloc(\"hecubafb\", -1);\n\tif (!n411_device)\n\t\treturn -ENOMEM;\n\n\tret = platform_device_add_data(n411_device, &n411_board,\n\t\t\t\t       sizeof(n411_board));\n\tif (ret)\n\t\tgoto put_plat_device;\n\n\t \n\tret = platform_device_add(n411_device);\n\n\tif (ret)\n\t\tgoto put_plat_device;\n\n\treturn 0;\n\nput_plat_device:\n\tplatform_device_put(n411_device);\n\treturn ret;\n}\n\nstatic void __exit n411_exit(void)\n{\n\tplatform_device_unregister(n411_device);\n}\n\nmodule_init(n411_init);\nmodule_exit(n411_exit);\n\nmodule_param(nosplash, uint, 0);\nMODULE_PARM_DESC(nosplash, \"Disable doing the splash screen\");\nmodule_param_hw(dio_addr, ulong, ioport, 0);\nMODULE_PARM_DESC(dio_addr, \"IO address for data, eg: 0x480\");\nmodule_param_hw(cio_addr, ulong, ioport, 0);\nMODULE_PARM_DESC(cio_addr, \"IO address for control, eg: 0x400\");\nmodule_param_hw(c2io_addr, ulong, ioport, 0);\nMODULE_PARM_DESC(c2io_addr, \"IO address for secondary control, eg: 0x408\");\nmodule_param(splashval, ulong, 0);\nMODULE_PARM_DESC(splashval, \"Splash pattern: 0x00 is black, 0x01 is white\");\n\nMODULE_DESCRIPTION(\"board driver for n411 hecuba/apollo epd kit\");\nMODULE_AUTHOR(\"Jaya Kumar\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}