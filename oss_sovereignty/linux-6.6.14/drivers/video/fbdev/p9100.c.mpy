{
  "module_name": "p9100.c",
  "hash_id": "9562e4fd73d8dd9ddbcb81d661034466017d6dddf41829aeb14170ae47da2bbe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/p9100.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/string.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/fb.h>\n#include <linux/mm.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n\n#include <asm/io.h>\n#include <asm/fbio.h>\n\n#include \"sbuslib.h\"\n\n \n\nstatic int p9100_setcolreg(unsigned, unsigned, unsigned, unsigned,\n\t\t\t   unsigned, struct fb_info *);\nstatic int p9100_blank(int, struct fb_info *);\n\nstatic int p9100_mmap(struct fb_info *, struct vm_area_struct *);\nstatic int p9100_ioctl(struct fb_info *, unsigned int, unsigned long);\n\n \n\nstatic const struct fb_ops p9100_ops = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.fb_setcolreg\t\t= p9100_setcolreg,\n\t.fb_blank\t\t= p9100_blank,\n\t.fb_fillrect\t\t= cfb_fillrect,\n\t.fb_copyarea\t\t= cfb_copyarea,\n\t.fb_imageblit\t\t= cfb_imageblit,\n\t.fb_mmap\t\t= p9100_mmap,\n\t.fb_ioctl\t\t= p9100_ioctl,\n#ifdef CONFIG_COMPAT\n\t.fb_compat_ioctl\t= sbusfb_compat_ioctl,\n#endif\n};\n\n \n#define P9100_SYSCTL_OFF\t0x0UL\n#define P9100_VIDEOCTL_OFF\t0x100UL\n#define P9100_VRAMCTL_OFF \t0x180UL\n#define P9100_RAMDAC_OFF \t0x200UL\n#define P9100_VIDEOCOPROC_OFF \t0x400UL\n\n \n#define P9100_CMD_OFF 0x0UL\n\n \n#define P9100_FB_OFF 0x0UL\n\n \n#define SYS_CONFIG_PIXELSIZE_SHIFT 26\n\n#define SCREENPAINT_TIMECTL1_ENABLE_VIDEO 0x20  \n\nstruct p9100_regs {\n\t \n\tu32 sys_base;\n\tu32 sys_config;\n\tu32 sys_intr;\n\tu32 sys_int_ena;\n\tu32 sys_alt_rd;\n\tu32 sys_alt_wr;\n\tu32 sys_xxx[58];\n\n\t \n\tu32 vid_base;\n\tu32 vid_hcnt;\n\tu32 vid_htotal;\n\tu32 vid_hsync_rise;\n\tu32 vid_hblank_rise;\n\tu32 vid_hblank_fall;\n\tu32 vid_hcnt_preload;\n\tu32 vid_vcnt;\n\tu32 vid_vlen;\n\tu32 vid_vsync_rise;\n\tu32 vid_vblank_rise;\n\tu32 vid_vblank_fall;\n\tu32 vid_vcnt_preload;\n\tu32 vid_screenpaint_addr;\n\tu32 vid_screenpaint_timectl1;\n\tu32 vid_screenpaint_qsfcnt;\n\tu32 vid_screenpaint_timectl2;\n\tu32 vid_xxx[15];\n\n\t \n\tu32 vram_base;\n\tu32 vram_memcfg;\n\tu32 vram_refresh_pd;\n\tu32 vram_refresh_cnt;\n\tu32 vram_raslo_max;\n\tu32 vram_raslo_cur;\n\tu32 pwrup_cfg;\n\tu32 vram_xxx[25];\n\n\t \n\tu32 ramdac_cmap_wridx;\n\tu32 ramdac_palette_data;\n\tu32 ramdac_pixel_mask;\n\tu32 ramdac_palette_rdaddr;\n\tu32 ramdac_idx_lo;\n\tu32 ramdac_idx_hi;\n\tu32 ramdac_idx_data;\n\tu32 ramdac_idx_ctl;\n\tu32 ramdac_xxx[1784];\n};\n\nstruct p9100_cmd_parameng {\n\tu32 parameng_status;\n\tu32 parameng_bltcmd;\n\tu32 parameng_quadcmd;\n};\n\nstruct p9100_par {\n\tspinlock_t\t\tlock;\n\tstruct p9100_regs\t__iomem *regs;\n\n\tu32\t\t\tflags;\n#define P9100_FLAG_BLANKED\t0x00000001\n\n\tunsigned long\t\twhich_io;\n};\n\n \nstatic int p9100_setcolreg(unsigned regno,\n\t\t\t   unsigned red, unsigned green, unsigned blue,\n\t\t\t   unsigned transp, struct fb_info *info)\n{\n\tstruct p9100_par *par = (struct p9100_par *) info->par;\n\tstruct p9100_regs __iomem *regs = par->regs;\n\tunsigned long flags;\n\n\tif (regno >= 256)\n\t\treturn 1;\n\n\tred >>= 8;\n\tgreen >>= 8;\n\tblue >>= 8;\n\n\tspin_lock_irqsave(&par->lock, flags);\n\n\tsbus_writel((regno << 16), &regs->ramdac_cmap_wridx);\n\tsbus_writel((red << 16), &regs->ramdac_palette_data);\n\tsbus_writel((green << 16), &regs->ramdac_palette_data);\n\tsbus_writel((blue << 16), &regs->ramdac_palette_data);\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n\n\treturn 0;\n}\n\n \nstatic int\np9100_blank(int blank, struct fb_info *info)\n{\n\tstruct p9100_par *par = (struct p9100_par *) info->par;\n\tstruct p9100_regs __iomem *regs = par->regs;\n\tunsigned long flags;\n\tu32 val;\n\n\tspin_lock_irqsave(&par->lock, flags);\n\n\tswitch (blank) {\n\tcase FB_BLANK_UNBLANK:  \n\t\tval = sbus_readl(&regs->vid_screenpaint_timectl1);\n\t\tval |= SCREENPAINT_TIMECTL1_ENABLE_VIDEO;\n\t\tsbus_writel(val, &regs->vid_screenpaint_timectl1);\n\t\tpar->flags &= ~P9100_FLAG_BLANKED;\n\t\tbreak;\n\n\tcase FB_BLANK_NORMAL:  \n\tcase FB_BLANK_VSYNC_SUSPEND:  \n\tcase FB_BLANK_HSYNC_SUSPEND:  \n\tcase FB_BLANK_POWERDOWN:  \n\t\tval = sbus_readl(&regs->vid_screenpaint_timectl1);\n\t\tval &= ~SCREENPAINT_TIMECTL1_ENABLE_VIDEO;\n\t\tsbus_writel(val, &regs->vid_screenpaint_timectl1);\n\t\tpar->flags |= P9100_FLAG_BLANKED;\n\t\tbreak;\n\t}\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n\n\treturn 0;\n}\n\nstatic struct sbus_mmap_map p9100_mmap_map[] = {\n\t{ CG3_MMAP_OFFSET,\t0,\t\tSBUS_MMAP_FBSIZE(1) },\n\t{ 0,\t\t\t0,\t\t0\t\t    }\n};\n\nstatic int p9100_mmap(struct fb_info *info, struct vm_area_struct *vma)\n{\n\tstruct p9100_par *par = (struct p9100_par *)info->par;\n\n\treturn sbusfb_mmap_helper(p9100_mmap_map,\n\t\t\t\t  info->fix.smem_start, info->fix.smem_len,\n\t\t\t\t  par->which_io, vma);\n}\n\nstatic int p9100_ioctl(struct fb_info *info, unsigned int cmd,\n\t\t       unsigned long arg)\n{\n\t \n\treturn sbusfb_ioctl_helper(cmd, arg, info,\n\t\t\t\t   FBTYPE_SUN3COLOR, 8, info->fix.smem_len);\n}\n\n \n\nstatic void p9100_init_fix(struct fb_info *info, int linebytes, struct device_node *dp)\n{\n\tsnprintf(info->fix.id, sizeof(info->fix.id), \"%pOFn\", dp);\n\n\tinfo->fix.type = FB_TYPE_PACKED_PIXELS;\n\tinfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\n\n\tinfo->fix.line_length = linebytes;\n\n\tinfo->fix.accel = FB_ACCEL_SUN_CGTHREE;\n}\n\nstatic int p9100_probe(struct platform_device *op)\n{\n\tstruct device_node *dp = op->dev.of_node;\n\tstruct fb_info *info;\n\tstruct p9100_par *par;\n\tint linebytes, err;\n\n\tinfo = framebuffer_alloc(sizeof(struct p9100_par), &op->dev);\n\n\terr = -ENOMEM;\n\tif (!info)\n\t\tgoto out_err;\n\tpar = info->par;\n\n\tspin_lock_init(&par->lock);\n\n\t \n\tinfo->fix.smem_start = op->resource[2].start;\n\tpar->which_io = op->resource[2].flags & IORESOURCE_BITS;\n\n\tsbusfb_fill_var(&info->var, dp, 8);\n\tinfo->var.red.length = 8;\n\tinfo->var.green.length = 8;\n\tinfo->var.blue.length = 8;\n\n\tlinebytes = of_getintprop_default(dp, \"linebytes\", info->var.xres);\n\tinfo->fix.smem_len = PAGE_ALIGN(linebytes * info->var.yres);\n\n\tpar->regs = of_ioremap(&op->resource[0], 0,\n\t\t\t       sizeof(struct p9100_regs), \"p9100 regs\");\n\tif (!par->regs)\n\t\tgoto out_release_fb;\n\n\tinfo->fbops = &p9100_ops;\n\tinfo->screen_base = of_ioremap(&op->resource[2], 0,\n\t\t\t\t       info->fix.smem_len, \"p9100 ram\");\n\tif (!info->screen_base)\n\t\tgoto out_unmap_regs;\n\n\tp9100_blank(FB_BLANK_UNBLANK, info);\n\n\tif (fb_alloc_cmap(&info->cmap, 256, 0))\n\t\tgoto out_unmap_screen;\n\n\tp9100_init_fix(info, linebytes, dp);\n\n\terr = register_framebuffer(info);\n\tif (err < 0)\n\t\tgoto out_dealloc_cmap;\n\n\tfb_set_cmap(&info->cmap, info);\n\n\tdev_set_drvdata(&op->dev, info);\n\n\tprintk(KERN_INFO \"%pOF: p9100 at %lx:%lx\\n\",\n\t       dp,\n\t       par->which_io, info->fix.smem_start);\n\n\treturn 0;\n\nout_dealloc_cmap:\n\tfb_dealloc_cmap(&info->cmap);\n\nout_unmap_screen:\n\tof_iounmap(&op->resource[2], info->screen_base, info->fix.smem_len);\n\nout_unmap_regs:\n\tof_iounmap(&op->resource[0], par->regs, sizeof(struct p9100_regs));\n\nout_release_fb:\n\tframebuffer_release(info);\n\nout_err:\n\treturn err;\n}\n\nstatic void p9100_remove(struct platform_device *op)\n{\n\tstruct fb_info *info = dev_get_drvdata(&op->dev);\n\tstruct p9100_par *par = info->par;\n\n\tunregister_framebuffer(info);\n\tfb_dealloc_cmap(&info->cmap);\n\n\tof_iounmap(&op->resource[0], par->regs, sizeof(struct p9100_regs));\n\tof_iounmap(&op->resource[2], info->screen_base, info->fix.smem_len);\n\n\tframebuffer_release(info);\n}\n\nstatic const struct of_device_id p9100_match[] = {\n\t{\n\t\t.name = \"p9100\",\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, p9100_match);\n\nstatic struct platform_driver p9100_driver = {\n\t.driver = {\n\t\t.name = \"p9100\",\n\t\t.of_match_table = p9100_match,\n\t},\n\t.probe\t\t= p9100_probe,\n\t.remove_new\t= p9100_remove,\n};\n\nstatic int __init p9100_init(void)\n{\n\tif (fb_get_options(\"p9100fb\", NULL))\n\t\treturn -ENODEV;\n\n\treturn platform_driver_register(&p9100_driver);\n}\n\nstatic void __exit p9100_exit(void)\n{\n\tplatform_driver_unregister(&p9100_driver);\n}\n\nmodule_init(p9100_init);\nmodule_exit(p9100_exit);\n\nMODULE_DESCRIPTION(\"framebuffer driver for P9100 chipsets\");\nMODULE_AUTHOR(\"David S. Miller <davem@davemloft.net>\");\nMODULE_VERSION(\"2.0\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}