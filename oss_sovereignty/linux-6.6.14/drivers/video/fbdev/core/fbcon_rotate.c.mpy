{
  "module_name": "fbcon_rotate.c",
  "hash_id": "51686cc81ffb625c39e3c16b5f7b3a0060c0fef53d23b39fd240ce0c6b4e5c46",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/core/fbcon_rotate.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/string.h>\n#include <linux/fb.h>\n#include <linux/vt_kern.h>\n#include <linux/console.h>\n#include <asm/types.h>\n#include \"fbcon.h\"\n#include \"fbcon_rotate.h\"\n\nstatic int fbcon_rotate_font(struct fb_info *info, struct vc_data *vc)\n{\n\tstruct fbcon_ops *ops = info->fbcon_par;\n\tint len, err = 0;\n\tint s_cellsize, d_cellsize, i;\n\tconst u8 *src;\n\tu8 *dst;\n\n\tif (vc->vc_font.data == ops->fontdata &&\n\t    ops->p->con_rotate == ops->cur_rotate)\n\t\tgoto finished;\n\n\tsrc = ops->fontdata = vc->vc_font.data;\n\tops->cur_rotate = ops->p->con_rotate;\n\tlen = vc->vc_font.charcount;\n\ts_cellsize = ((vc->vc_font.width + 7)/8) *\n\t\tvc->vc_font.height;\n\td_cellsize = s_cellsize;\n\n\tif (ops->rotate == FB_ROTATE_CW ||\n\t    ops->rotate == FB_ROTATE_CCW)\n\t\td_cellsize = ((vc->vc_font.height + 7)/8) *\n\t\t\tvc->vc_font.width;\n\n\tif (info->fbops->fb_sync)\n\t\tinfo->fbops->fb_sync(info);\n\n\tif (ops->fd_size < d_cellsize * len) {\n\t\tdst = kmalloc_array(len, d_cellsize, GFP_KERNEL);\n\n\t\tif (dst == NULL) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto finished;\n\t\t}\n\n\t\tops->fd_size = d_cellsize * len;\n\t\tkfree(ops->fontbuffer);\n\t\tops->fontbuffer = dst;\n\t}\n\n\tdst = ops->fontbuffer;\n\tmemset(dst, 0, ops->fd_size);\n\n\tswitch (ops->rotate) {\n\tcase FB_ROTATE_UD:\n\t\tfor (i = len; i--; ) {\n\t\t\trotate_ud(src, dst, vc->vc_font.width,\n\t\t\t\t  vc->vc_font.height);\n\n\t\t\tsrc += s_cellsize;\n\t\t\tdst += d_cellsize;\n\t\t}\n\t\tbreak;\n\tcase FB_ROTATE_CW:\n\t\tfor (i = len; i--; ) {\n\t\t\trotate_cw(src, dst, vc->vc_font.width,\n\t\t\t\t  vc->vc_font.height);\n\t\t\tsrc += s_cellsize;\n\t\t\tdst += d_cellsize;\n\t\t}\n\t\tbreak;\n\tcase FB_ROTATE_CCW:\n\t\tfor (i = len; i--; ) {\n\t\t\trotate_ccw(src, dst, vc->vc_font.width,\n\t\t\t\t   vc->vc_font.height);\n\t\t\tsrc += s_cellsize;\n\t\t\tdst += d_cellsize;\n\t\t}\n\t\tbreak;\n\t}\n\nfinished:\n\treturn err;\n}\n\nvoid fbcon_set_rotate(struct fbcon_ops *ops)\n{\n\tops->rotate_font = fbcon_rotate_font;\n\n\tswitch(ops->rotate) {\n\tcase FB_ROTATE_CW:\n\t\tfbcon_rotate_cw(ops);\n\t\tbreak;\n\tcase FB_ROTATE_UD:\n\t\tfbcon_rotate_ud(ops);\n\t\tbreak;\n\tcase FB_ROTATE_CCW:\n\t\tfbcon_rotate_ccw(ops);\n\t\tbreak;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}