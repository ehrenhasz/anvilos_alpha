{
  "module_name": "cfbcopyarea.c",
  "hash_id": "fa7b7b0cbd21cac06382a1305ba0f72104ed61d16ad8ed853f2b099b5321f86f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/core/cfbcopyarea.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/fb.h>\n#include <asm/types.h>\n#include <asm/io.h>\n#include \"fb_draw.h\"\n\n#if BITS_PER_LONG == 32\n#  define FB_WRITEL fb_writel\n#  define FB_READL  fb_readl\n#else\n#  define FB_WRITEL fb_writeq\n#  define FB_READL  fb_readq\n#endif\n\n     \n\nstatic void\nbitcpy(struct fb_info *p, unsigned long __iomem *dst, unsigned dst_idx,\n\t\tconst unsigned long __iomem *src, unsigned src_idx, int bits,\n\t\tunsigned n, u32 bswapmask)\n{\n\tunsigned long first, last;\n\tint const shift = dst_idx-src_idx;\n\n#if 0\n\t \n\tmemmove((char *)dst + ((dst_idx & (bits - 1))) / 8,\n\t\t(char *)src + ((src_idx & (bits - 1))) / 8, n / 8);\n\treturn;\n#endif\n\n\tfirst = fb_shifted_pixels_mask_long(p, dst_idx, bswapmask);\n\tlast = ~fb_shifted_pixels_mask_long(p, (dst_idx+n) % bits, bswapmask);\n\n\tif (!shift) {\n\t\t\n\n\t\tif (dst_idx+n <= bits) {\n\t\t\t\n\t\t\tif (last)\n\t\t\t\tfirst &= last;\n\t\t\tFB_WRITEL( comp( FB_READL(src), FB_READL(dst), first), dst);\n\t\t} else {\n\t\t\t\n\n\t\t\t\n\t\t\tif (first != ~0UL) {\n\t\t\t\tFB_WRITEL( comp( FB_READL(src), FB_READL(dst), first), dst);\n\t\t\t\tdst++;\n\t\t\t\tsrc++;\n\t\t\t\tn -= bits - dst_idx;\n\t\t\t}\n\n\t\t\t\n\t\t\tn /= bits;\n\t\t\twhile (n >= 8) {\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\t\t\t\tn -= 8;\n\t\t\t}\n\t\t\twhile (n--)\n\t\t\t\tFB_WRITEL(FB_READL(src++), dst++);\n\n\t\t\t\n\t\t\tif (last)\n\t\t\t\tFB_WRITEL( comp( FB_READL(src), FB_READL(dst), last), dst);\n\t\t}\n\t} else {\n\t\t \n\t\tunsigned long d0, d1;\n\t\tint m;\n\n\t\tint const left = shift & (bits - 1);\n\t\tint const right = -shift & (bits - 1);\n\n\t\tif (dst_idx+n <= bits) {\n\t\t\t\n\t\t\tif (last)\n\t\t\t\tfirst &= last;\n\t\t\td0 = FB_READL(src);\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\tif (shift > 0) {\n\t\t\t\t\n\t\t\t\td0 <<= left;\n\t\t\t} else if (src_idx+n <= bits) {\n\t\t\t\t\n\t\t\t\td0 >>= right;\n\t\t\t} else {\n\t\t\t\t\n\t\t\t\td1 = FB_READL(src + 1);\n\t\t\t\td1 = fb_rev_pixels_in_long(d1, bswapmask);\n\t\t\t\td0 = d0 >> right | d1 << left;\n\t\t\t}\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\tFB_WRITEL(comp(d0, FB_READL(dst), first), dst);\n\t\t} else {\n\t\t\t\n\t\t\t \n\t\t\td0 = FB_READL(src++);\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\t\n\t\t\tif (shift > 0) {\n\t\t\t\t\n\t\t\t\td1 = d0;\n\t\t\t\td0 <<= left;\n\t\t\t\tn -= bits - dst_idx;\n\t\t\t} else {\n\t\t\t\t\n\t\t\t\td1 = FB_READL(src++);\n\t\t\t\td1 = fb_rev_pixels_in_long(d1, bswapmask);\n\n\t\t\t\td0 = d0 >> right | d1 << left;\n\t\t\t\tn -= bits - dst_idx;\n\t\t\t}\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\tFB_WRITEL(comp(d0, FB_READL(dst), first), dst);\n\t\t\td0 = d1;\n\t\t\tdst++;\n\n\t\t\t\n\t\t\tm = n % bits;\n\t\t\tn /= bits;\n\t\t\twhile ((n >= 4) && !bswapmask) {\n\t\t\t\td1 = FB_READL(src++);\n\t\t\t\tFB_WRITEL(d0 >> right | d1 << left, dst++);\n\t\t\t\td0 = d1;\n\t\t\t\td1 = FB_READL(src++);\n\t\t\t\tFB_WRITEL(d0 >> right | d1 << left, dst++);\n\t\t\t\td0 = d1;\n\t\t\t\td1 = FB_READL(src++);\n\t\t\t\tFB_WRITEL(d0 >> right | d1 << left, dst++);\n\t\t\t\td0 = d1;\n\t\t\t\td1 = FB_READL(src++);\n\t\t\t\tFB_WRITEL(d0 >> right | d1 << left, dst++);\n\t\t\t\td0 = d1;\n\t\t\t\tn -= 4;\n\t\t\t}\n\t\t\twhile (n--) {\n\t\t\t\td1 = FB_READL(src++);\n\t\t\t\td1 = fb_rev_pixels_in_long(d1, bswapmask);\n\t\t\t\td0 = d0 >> right | d1 << left;\n\t\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\t\tFB_WRITEL(d0, dst++);\n\t\t\t\td0 = d1;\n\t\t\t}\n\n\t\t\t\n\t\t\tif (m) {\n\t\t\t\tif (m <= bits - right) {\n\t\t\t\t\t\n\t\t\t\t\td0 >>= right;\n\t\t\t\t} else {\n\t\t\t\t\t\n\t\t\t\t\td1 = FB_READL(src);\n\t\t\t\t\td1 = fb_rev_pixels_in_long(d1,\n\t\t\t\t\t\t\t\tbswapmask);\n\t\t\t\t\td0 = d0 >> right | d1 << left;\n\t\t\t\t}\n\t\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\t\tFB_WRITEL(comp(d0, FB_READL(dst), last), dst);\n\t\t\t}\n\t\t}\n\t}\n}\n\n     \n\nstatic void\nbitcpy_rev(struct fb_info *p, unsigned long __iomem *dst, unsigned dst_idx,\n\t\tconst unsigned long __iomem *src, unsigned src_idx, int bits,\n\t\tunsigned n, u32 bswapmask)\n{\n\tunsigned long first, last;\n\tint shift;\n\n#if 0\n\t \n\tmemmove((char *)dst + ((dst_idx & (bits - 1))) / 8,\n\t\t(char *)src + ((src_idx & (bits - 1))) / 8, n / 8);\n\treturn;\n#endif\n\n\tdst += (dst_idx + n - 1) / bits;\n\tsrc += (src_idx + n - 1) / bits;\n\tdst_idx = (dst_idx + n - 1) % bits;\n\tsrc_idx = (src_idx + n - 1) % bits;\n\n\tshift = dst_idx-src_idx;\n\n\tfirst = ~fb_shifted_pixels_mask_long(p, (dst_idx + 1) % bits, bswapmask);\n\tlast = fb_shifted_pixels_mask_long(p, (bits + dst_idx + 1 - n) % bits, bswapmask);\n\n\tif (!shift) {\n\t\t\n\n\t\tif ((unsigned long)dst_idx+1 >= n) {\n\t\t\t\n\t\t\tif (first)\n\t\t\t\tlast &= first;\n\t\t\tFB_WRITEL( comp( FB_READL(src), FB_READL(dst), last), dst);\n\t\t} else {\n\t\t\t\n\n\t\t\t\n\t\t\tif (first) {\n\t\t\t\tFB_WRITEL( comp( FB_READL(src), FB_READL(dst), first), dst);\n\t\t\t\tdst--;\n\t\t\t\tsrc--;\n\t\t\t\tn -= dst_idx+1;\n\t\t\t}\n\n\t\t\t\n\t\t\tn /= bits;\n\t\t\twhile (n >= 8) {\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\t\t\t\tn -= 8;\n\t\t\t}\n\t\t\twhile (n--)\n\t\t\t\tFB_WRITEL(FB_READL(src--), dst--);\n\n\t\t\t\n\t\t\tif (last != -1UL)\n\t\t\t\tFB_WRITEL( comp( FB_READL(src), FB_READL(dst), last), dst);\n\t\t}\n\t} else {\n\t\t\n\t\tunsigned long d0, d1;\n\t\tint m;\n\n\t\tint const left = shift & (bits-1);\n\t\tint const right = -shift & (bits-1);\n\n\t\tif ((unsigned long)dst_idx+1 >= n) {\n\t\t\t\n\t\t\tif (first)\n\t\t\t\tlast &= first;\n\t\t\td0 = FB_READL(src);\n\t\t\tif (shift < 0) {\n\t\t\t\t\n\t\t\t\td0 >>= right;\n\t\t\t} else if (1+(unsigned long)src_idx >= n) {\n\t\t\t\t\n\t\t\t\td0 <<= left;\n\t\t\t} else {\n\t\t\t\t\n\t\t\t\td1 = FB_READL(src - 1);\n\t\t\t\td1 = fb_rev_pixels_in_long(d1, bswapmask);\n\t\t\t\td0 = d0 << left | d1 >> right;\n\t\t\t}\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\tFB_WRITEL(comp(d0, FB_READL(dst), last), dst);\n\t\t} else {\n\t\t\t\n\t\t\t \n\n\t\t\td0 = FB_READL(src--);\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\t\n\t\t\tif (shift < 0) {\n\t\t\t\t\n\t\t\t\td1 = d0;\n\t\t\t\td0 >>= right;\n\t\t\t} else {\n\t\t\t\t\n\t\t\t\td1 = FB_READL(src--);\n\t\t\t\td1 = fb_rev_pixels_in_long(d1, bswapmask);\n\t\t\t\td0 = d0 << left | d1 >> right;\n\t\t\t}\n\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\tif (!first)\n\t\t\t\tFB_WRITEL(d0, dst);\n\t\t\telse\n\t\t\t\tFB_WRITEL(comp(d0, FB_READL(dst), first), dst);\n\t\t\td0 = d1;\n\t\t\tdst--;\n\t\t\tn -= dst_idx+1;\n\n\t\t\t\n\t\t\tm = n % bits;\n\t\t\tn /= bits;\n\t\t\twhile ((n >= 4) && !bswapmask) {\n\t\t\t\td1 = FB_READL(src--);\n\t\t\t\tFB_WRITEL(d0 << left | d1 >> right, dst--);\n\t\t\t\td0 = d1;\n\t\t\t\td1 = FB_READL(src--);\n\t\t\t\tFB_WRITEL(d0 << left | d1 >> right, dst--);\n\t\t\t\td0 = d1;\n\t\t\t\td1 = FB_READL(src--);\n\t\t\t\tFB_WRITEL(d0 << left | d1 >> right, dst--);\n\t\t\t\td0 = d1;\n\t\t\t\td1 = FB_READL(src--);\n\t\t\t\tFB_WRITEL(d0 << left | d1 >> right, dst--);\n\t\t\t\td0 = d1;\n\t\t\t\tn -= 4;\n\t\t\t}\n\t\t\twhile (n--) {\n\t\t\t\td1 = FB_READL(src--);\n\t\t\t\td1 = fb_rev_pixels_in_long(d1, bswapmask);\n\t\t\t\td0 = d0 << left | d1 >> right;\n\t\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\t\tFB_WRITEL(d0, dst--);\n\t\t\t\td0 = d1;\n\t\t\t}\n\n\t\t\t\n\t\t\tif (m) {\n\t\t\t\tif (m <= bits - left) {\n\t\t\t\t\t\n\t\t\t\t\td0 <<= left;\n\t\t\t\t} else {\n\t\t\t\t\t\n\t\t\t\t\td1 = FB_READL(src);\n\t\t\t\t\td1 = fb_rev_pixels_in_long(d1,\n\t\t\t\t\t\t\t\tbswapmask);\n\t\t\t\t\td0 = d0 << left | d1 >> right;\n\t\t\t\t}\n\t\t\t\td0 = fb_rev_pixels_in_long(d0, bswapmask);\n\t\t\t\tFB_WRITEL(comp(d0, FB_READL(dst), last), dst);\n\t\t\t}\n\t\t}\n\t}\n}\n\nvoid cfb_copyarea(struct fb_info *p, const struct fb_copyarea *area)\n{\n\tu32 dx = area->dx, dy = area->dy, sx = area->sx, sy = area->sy;\n\tu32 height = area->height, width = area->width;\n\tunsigned int const bits_per_line = p->fix.line_length * 8u;\n\tunsigned long __iomem *base = NULL;\n\tint bits = BITS_PER_LONG, bytes = bits >> 3;\n\tunsigned dst_idx = 0, src_idx = 0, rev_copy = 0;\n\tu32 bswapmask = fb_compute_bswapmask(p);\n\n\tif (p->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\n\t \n\tif ((dy == sy && dx > sx) || (dy > sy)) {\n\t\tdy += height;\n\t\tsy += height;\n\t\trev_copy = 1;\n\t}\n\n\t\n\t\n\tbase = (unsigned long __iomem *)((unsigned long)p->screen_base & ~(bytes-1));\n\tdst_idx = src_idx = 8*((unsigned long)p->screen_base & (bytes-1));\n\t\n\tdst_idx += dy*bits_per_line + dx*p->var.bits_per_pixel;\n\tsrc_idx += sy*bits_per_line + sx*p->var.bits_per_pixel;\n\n\tif (p->fbops->fb_sync)\n\t\tp->fbops->fb_sync(p);\n\n\tif (rev_copy) {\n\t\twhile (height--) {\n\t\t\tdst_idx -= bits_per_line;\n\t\t\tsrc_idx -= bits_per_line;\n\t\t\tbitcpy_rev(p, base + (dst_idx / bits), dst_idx % bits,\n\t\t\t\tbase + (src_idx / bits), src_idx % bits, bits,\n\t\t\t\twidth*p->var.bits_per_pixel, bswapmask);\n\t\t}\n\t} else {\n\t\twhile (height--) {\n\t\t\tbitcpy(p, base + (dst_idx / bits), dst_idx % bits,\n\t\t\t\tbase + (src_idx / bits), src_idx % bits, bits,\n\t\t\t\twidth*p->var.bits_per_pixel, bswapmask);\n\t\t\tdst_idx += bits_per_line;\n\t\t\tsrc_idx += bits_per_line;\n\t\t}\n\t}\n}\n\nEXPORT_SYMBOL(cfb_copyarea);\n\nMODULE_AUTHOR(\"James Simmons <jsimmons@users.sf.net>\");\nMODULE_DESCRIPTION(\"Generic software accelerated copyarea\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}