{
  "module_name": "syscopyarea.c",
  "hash_id": "206cd27845f8330da82c1f6f7e7db7ab1aa12d1216477f8dbad773ebb7906ac3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/core/syscopyarea.c",
  "human_readable_source": " \n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/fb.h>\n#include <asm/types.h>\n#include <asm/io.h>\n#include \"fb_draw.h\"\n\n     \n\nstatic void\nbitcpy(struct fb_info *p, unsigned long *dst, unsigned dst_idx,\n\tconst unsigned long *src, unsigned src_idx, int bits, unsigned n)\n{\n\tunsigned long first, last;\n\tint const shift = dst_idx-src_idx;\n\tint left, right;\n\n\tfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\n\tlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\n\n\tif (!shift) {\n\t\t \n\t\tif (dst_idx+n <= bits) {\n\t\t\t \n\t\t\tif (last)\n\t\t\t\tfirst &= last;\n\t\t\t*dst = comp(*src, *dst, first);\n\t\t} else {\n\t\t\t \n\t\t\t \n \t\t\tif (first != ~0UL) {\n\t\t\t\t*dst = comp(*src, *dst, first);\n\t\t\t\tdst++;\n\t\t\t\tsrc++;\n\t\t\t\tn -= bits - dst_idx;\n\t\t\t}\n\n\t\t\t \n\t\t\tn /= bits;\n\t\t\twhile (n >= 8) {\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\t*dst++ = *src++;\n\t\t\t\tn -= 8;\n\t\t\t}\n\t\t\twhile (n--)\n\t\t\t\t*dst++ = *src++;\n\n\t\t\t \n\t\t\tif (last)\n\t\t\t\t*dst = comp(*src, *dst, last);\n\t\t}\n\t} else {\n\t\tunsigned long d0, d1;\n\t\tint m;\n\n\t\t \n\t\tright = shift & (bits - 1);\n\t\tleft = -shift & (bits - 1);\n\n\t\tif (dst_idx+n <= bits) {\n\t\t\t \n\t\t\tif (last)\n\t\t\t\tfirst &= last;\n\t\t\tif (shift > 0) {\n\t\t\t\t \n\t\t\t\t*dst = comp(*src << left, *dst, first);\n\t\t\t} else if (src_idx+n <= bits) {\n\t\t\t\t \n\t\t\t\t*dst = comp(*src >> right, *dst, first);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\td0 = *src++;\n\t\t\t\td1 = *src;\n\t\t\t\t*dst = comp(d0 >> right | d1 << left, *dst,\n\t\t\t\t\t    first);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\t \n\t\t\td0 = *src++;\n\t\t\t \n\t\t\tif (shift > 0) {\n\t\t\t\t \n\t\t\t\t*dst = comp(d0 << left, *dst, first);\n\t\t\t\tdst++;\n\t\t\t\tn -= bits - dst_idx;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\td1 = *src++;\n\t\t\t\t*dst = comp(d0 >> right | d1 << left, *dst,\n\t\t\t\t\t    first);\n\t\t\t\td0 = d1;\n\t\t\t\tdst++;\n\t\t\t\tn -= bits - dst_idx;\n\t\t\t}\n\n\t\t\t \n\t\t\tm = n % bits;\n\t\t\tn /= bits;\n\t\t\twhile (n >= 4) {\n\t\t\t\td1 = *src++;\n\t\t\t\t*dst++ = d0 >> right | d1 << left;\n\t\t\t\td0 = d1;\n\t\t\t\td1 = *src++;\n\t\t\t\t*dst++ = d0 >> right | d1 << left;\n\t\t\t\td0 = d1;\n\t\t\t\td1 = *src++;\n\t\t\t\t*dst++ = d0 >> right | d1 << left;\n\t\t\t\td0 = d1;\n\t\t\t\td1 = *src++;\n\t\t\t\t*dst++ = d0 >> right | d1 << left;\n\t\t\t\td0 = d1;\n\t\t\t\tn -= 4;\n\t\t\t}\n\t\t\twhile (n--) {\n\t\t\t\td1 = *src++;\n\t\t\t\t*dst++ = d0 >> right | d1 << left;\n\t\t\t\td0 = d1;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (m) {\n\t\t\t\tif (m <= bits - right) {\n\t\t\t\t\t \n\t\t\t\t\td0 >>= right;\n\t\t\t\t} else {\n\t\t\t\t\t \n \t\t\t\t\td1 = *src;\n\t\t\t\t\td0 = d0 >> right | d1 << left;\n\t\t\t\t}\n\t\t\t\t*dst = comp(d0, *dst, last);\n\t\t\t}\n\t\t}\n\t}\n}\n\n     \n\nstatic void\nbitcpy_rev(struct fb_info *p, unsigned long *dst, unsigned dst_idx,\n\t   const unsigned long *src, unsigned src_idx, unsigned bits,\n\t   unsigned n)\n{\n\tunsigned long first, last;\n\tint shift;\n\n\tdst += (dst_idx + n - 1) / bits;\n\tsrc += (src_idx + n - 1) / bits;\n\tdst_idx = (dst_idx + n - 1) % bits;\n\tsrc_idx = (src_idx + n - 1) % bits;\n\n\tshift = dst_idx-src_idx;\n\n\tfirst = ~FB_SHIFT_HIGH(p, ~0UL, (dst_idx + 1) % bits);\n\tlast = FB_SHIFT_HIGH(p, ~0UL, (bits + dst_idx + 1 - n) % bits);\n\n\tif (!shift) {\n\t\t \n\t\tif ((unsigned long)dst_idx+1 >= n) {\n\t\t\t \n\t\t\tif (first)\n\t\t\t\tlast &= first;\n\t\t\t*dst = comp(*src, *dst, last);\n\t\t} else {\n\t\t\t \n\n\t\t\t \n\t\t\tif (first) {\n\t\t\t\t*dst = comp(*src, *dst, first);\n\t\t\t\tdst--;\n\t\t\t\tsrc--;\n\t\t\t\tn -= dst_idx+1;\n\t\t\t}\n\n\t\t\t \n\t\t\tn /= bits;\n\t\t\twhile (n >= 8) {\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\t*dst-- = *src--;\n\t\t\t\tn -= 8;\n\t\t\t}\n\t\t\twhile (n--)\n\t\t\t\t*dst-- = *src--;\n\t\t\t \n\t\t\tif (last != -1UL)\n\t\t\t\t*dst = comp(*src, *dst, last);\n\t\t}\n\t} else {\n\t\t \n\n\t\tint const left = shift & (bits-1);\n\t\tint const right = -shift & (bits-1);\n\n\t\tif ((unsigned long)dst_idx+1 >= n) {\n\t\t\t \n\t\t\tif (first)\n\t\t\t\tlast &= first;\n\t\t\tif (shift < 0) {\n\t\t\t\t \n\t\t\t\t*dst = comp(*src >> right, *dst, last);\n\t\t\t} else if (1+(unsigned long)src_idx >= n) {\n\t\t\t\t \n\t\t\t\t*dst = comp(*src << left, *dst, last);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\t*dst = comp(*src << left | *(src-1) >> right,\n\t\t\t\t\t    *dst, last);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\t \n\t\t\tunsigned long d0, d1;\n\t\t\tint m;\n\n\t\t\td0 = *src--;\n\t\t\t \n\t\t\tif (shift < 0) {\n\t\t\t\t \n\t\t\t\td1 = d0;\n\t\t\t\td0 >>= right;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\td1 = *src--;\n\t\t\t\td0 = d0 << left | d1 >> right;\n\t\t\t}\n\t\t\tif (!first)\n\t\t\t\t*dst = d0;\n\t\t\telse\n\t\t\t\t*dst = comp(d0, *dst, first);\n\t\t\td0 = d1;\n\t\t\tdst--;\n\t\t\tn -= dst_idx+1;\n\n\t\t\t \n\t\t\tm = n % bits;\n\t\t\tn /= bits;\n\t\t\twhile (n >= 4) {\n\t\t\t\td1 = *src--;\n\t\t\t\t*dst-- = d0 << left | d1 >> right;\n\t\t\t\td0 = d1;\n\t\t\t\td1 = *src--;\n\t\t\t\t*dst-- = d0 << left | d1 >> right;\n\t\t\t\td0 = d1;\n\t\t\t\td1 = *src--;\n\t\t\t\t*dst-- = d0 << left | d1 >> right;\n\t\t\t\td0 = d1;\n\t\t\t\td1 = *src--;\n\t\t\t\t*dst-- = d0 << left | d1 >> right;\n\t\t\t\td0 = d1;\n\t\t\t\tn -= 4;\n\t\t\t}\n\t\t\twhile (n--) {\n\t\t\t\td1 = *src--;\n\t\t\t\t*dst-- = d0 << left | d1 >> right;\n\t\t\t\td0 = d1;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (m) {\n\t\t\t\tif (m <= bits - left) {\n\t\t\t\t\t \n\t\t\t\t\td0 <<= left;\n\t\t\t\t} else {\n\t\t\t\t\t \n\t\t\t\t\td1 = *src;\n\t\t\t\t\td0 = d0 << left | d1 >> right;\n\t\t\t\t}\n\t\t\t\t*dst = comp(d0, *dst, last);\n\t\t\t}\n\t\t}\n\t}\n}\n\nvoid sys_copyarea(struct fb_info *p, const struct fb_copyarea *area)\n{\n\tu32 dx = area->dx, dy = area->dy, sx = area->sx, sy = area->sy;\n\tu32 height = area->height, width = area->width;\n\tunsigned int const bits_per_line = p->fix.line_length * 8u;\n\tunsigned long *base = NULL;\n\tint bits = BITS_PER_LONG, bytes = bits >> 3;\n\tunsigned dst_idx = 0, src_idx = 0, rev_copy = 0;\n\n\tif (p->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\n\t \n\tif ((dy == sy && dx > sx) || (dy > sy)) {\n\t\tdy += height;\n\t\tsy += height;\n\t\trev_copy = 1;\n\t}\n\n\t \n\tbase = (unsigned long *)((unsigned long)p->screen_base & ~(bytes-1));\n\tdst_idx = src_idx = 8*((unsigned long)p->screen_base & (bytes-1));\n\t \n\tdst_idx += dy*bits_per_line + dx*p->var.bits_per_pixel;\n\tsrc_idx += sy*bits_per_line + sx*p->var.bits_per_pixel;\n\n\tif (p->fbops->fb_sync)\n\t\tp->fbops->fb_sync(p);\n\n\tif (rev_copy) {\n\t\twhile (height--) {\n\t\t\tdst_idx -= bits_per_line;\n\t\t\tsrc_idx -= bits_per_line;\n\t\t\tbitcpy_rev(p, base + (dst_idx / bits), dst_idx % bits,\n\t\t\t\tbase + (src_idx / bits), src_idx % bits, bits,\n\t\t\t\twidth*p->var.bits_per_pixel);\n\t\t}\n\t} else {\n\t\twhile (height--) {\n\t\t\tbitcpy(p, base + (dst_idx / bits), dst_idx % bits,\n\t\t\t\tbase + (src_idx / bits), src_idx % bits, bits,\n\t\t\t\twidth*p->var.bits_per_pixel);\n\t\t\tdst_idx += bits_per_line;\n\t\t\tsrc_idx += bits_per_line;\n\t\t}\n\t}\n}\n\nEXPORT_SYMBOL(sys_copyarea);\n\nMODULE_AUTHOR(\"Antonino Daplas <adaplas@pol.net>\");\nMODULE_DESCRIPTION(\"Generic copyarea (sys-to-sys)\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}