{
  "module_name": "fbsysfs.c",
  "hash_id": "9cc130fb33738fa0c155c5a025c055d58a4f679c1fda49b98cc22d6d2fba73ac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/core/fbsysfs.c",
  "human_readable_source": "\n \n\n#include <linux/console.h>\n#include <linux/fb.h>\n#include <linux/fbcon.h>\n#include <linux/major.h>\n\n#include \"fb_internal.h\"\n\n#define FB_SYSFS_FLAG_ATTR 1\n\nstatic int activate(struct fb_info *fb_info, struct fb_var_screeninfo *var)\n{\n\tint err;\n\n\tvar->activate |= FB_ACTIVATE_FORCE;\n\tconsole_lock();\n\tlock_fb_info(fb_info);\n\terr = fb_set_var(fb_info, var);\n\tif (!err)\n\t\tfbcon_update_vcs(fb_info, var->activate & FB_ACTIVATE_ALL);\n\tunlock_fb_info(fb_info);\n\tconsole_unlock();\n\tif (err)\n\t\treturn err;\n\treturn 0;\n}\n\nstatic int mode_string(char *buf, unsigned int offset,\n\t\t       const struct fb_videomode *mode)\n{\n\tchar m = 'U';\n\tchar v = 'p';\n\n\tif (mode->flag & FB_MODE_IS_DETAILED)\n\t\tm = 'D';\n\tif (mode->flag & FB_MODE_IS_VESA)\n\t\tm = 'V';\n\tif (mode->flag & FB_MODE_IS_STANDARD)\n\t\tm = 'S';\n\n\tif (mode->vmode & FB_VMODE_INTERLACED)\n\t\tv = 'i';\n\tif (mode->vmode & FB_VMODE_DOUBLE)\n\t\tv = 'd';\n\n\treturn snprintf(&buf[offset], PAGE_SIZE - offset, \"%c:%dx%d%c-%d\\n\",\n\t                m, mode->xres, mode->yres, v, mode->refresh);\n}\n\nstatic ssize_t store_mode(struct device *device, struct device_attribute *attr,\n\t\t\t  const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tchar mstr[100];\n\tstruct fb_var_screeninfo var;\n\tstruct fb_modelist *modelist;\n\tstruct fb_videomode *mode;\n\tsize_t i;\n\tint err;\n\n\tmemset(&var, 0, sizeof(var));\n\n\tlist_for_each_entry(modelist, &fb_info->modelist, list) {\n\t\tmode = &modelist->mode;\n\t\ti = mode_string(mstr, 0, mode);\n\t\tif (strncmp(mstr, buf, max(count, i)) == 0) {\n\n\t\t\tvar = fb_info->var;\n\t\t\tfb_videomode_to_var(&var, mode);\n\t\t\tif ((err = activate(fb_info, &var)))\n\t\t\t\treturn err;\n\t\t\tfb_info->mode = mode;\n\t\t\treturn count;\n\t\t}\n\t}\n\treturn -EINVAL;\n}\n\nstatic ssize_t show_mode(struct device *device, struct device_attribute *attr,\n\t\t\t char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\n\tif (!fb_info->mode)\n\t\treturn 0;\n\n\treturn mode_string(buf, 0, fb_info->mode);\n}\n\nstatic ssize_t store_modes(struct device *device,\n\t\t\t   struct device_attribute *attr,\n\t\t\t   const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tLIST_HEAD(old_list);\n\tint i = count / sizeof(struct fb_videomode);\n\n\tif (i * sizeof(struct fb_videomode) != count)\n\t\treturn -EINVAL;\n\n\tconsole_lock();\n\tlock_fb_info(fb_info);\n\n\tlist_splice(&fb_info->modelist, &old_list);\n\tfb_videomode_to_modelist((const struct fb_videomode *)buf, i,\n\t\t\t\t &fb_info->modelist);\n\tif (fb_new_modelist(fb_info)) {\n\t\tfb_destroy_modelist(&fb_info->modelist);\n\t\tlist_splice(&old_list, &fb_info->modelist);\n\t} else\n\t\tfb_destroy_modelist(&old_list);\n\n\tunlock_fb_info(fb_info);\n\tconsole_unlock();\n\n\treturn 0;\n}\n\nstatic ssize_t show_modes(struct device *device, struct device_attribute *attr,\n\t\t\t  char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tunsigned int i;\n\tstruct fb_modelist *modelist;\n\tconst struct fb_videomode *mode;\n\n\ti = 0;\n\tlist_for_each_entry(modelist, &fb_info->modelist, list) {\n\t\tmode = &modelist->mode;\n\t\ti += mode_string(buf, i, mode);\n\t}\n\treturn i;\n}\n\nstatic ssize_t store_bpp(struct device *device, struct device_attribute *attr,\n\t\t\t const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tstruct fb_var_screeninfo var;\n\tchar ** last = NULL;\n\tint err;\n\n\tvar = fb_info->var;\n\tvar.bits_per_pixel = simple_strtoul(buf, last, 0);\n\tif ((err = activate(fb_info, &var)))\n\t\treturn err;\n\treturn count;\n}\n\nstatic ssize_t show_bpp(struct device *device, struct device_attribute *attr,\n\t\t\tchar *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\treturn sysfs_emit(buf, \"%d\\n\", fb_info->var.bits_per_pixel);\n}\n\nstatic ssize_t store_rotate(struct device *device,\n\t\t\t    struct device_attribute *attr,\n\t\t\t    const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tstruct fb_var_screeninfo var;\n\tchar **last = NULL;\n\tint err;\n\n\tvar = fb_info->var;\n\tvar.rotate = simple_strtoul(buf, last, 0);\n\n\tif ((err = activate(fb_info, &var)))\n\t\treturn err;\n\n\treturn count;\n}\n\n\nstatic ssize_t show_rotate(struct device *device,\n\t\t\t   struct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\n\treturn sysfs_emit(buf, \"%d\\n\", fb_info->var.rotate);\n}\n\nstatic ssize_t store_virtual(struct device *device,\n\t\t\t     struct device_attribute *attr,\n\t\t\t     const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tstruct fb_var_screeninfo var;\n\tchar *last = NULL;\n\tint err;\n\n\tvar = fb_info->var;\n\tvar.xres_virtual = simple_strtoul(buf, &last, 0);\n\tlast++;\n\tif (last - buf >= count)\n\t\treturn -EINVAL;\n\tvar.yres_virtual = simple_strtoul(last, &last, 0);\n\n\tif ((err = activate(fb_info, &var)))\n\t\treturn err;\n\treturn count;\n}\n\nstatic ssize_t show_virtual(struct device *device,\n\t\t\t    struct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\treturn sysfs_emit(buf, \"%d,%d\\n\", fb_info->var.xres_virtual,\n\t\t\tfb_info->var.yres_virtual);\n}\n\nstatic ssize_t show_stride(struct device *device,\n\t\t\t   struct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\treturn sysfs_emit(buf, \"%d\\n\", fb_info->fix.line_length);\n}\n\nstatic ssize_t store_blank(struct device *device,\n\t\t\t   struct device_attribute *attr,\n\t\t\t   const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tchar *last = NULL;\n\tint err, arg;\n\n\targ = simple_strtoul(buf, &last, 0);\n\tconsole_lock();\n\terr = fb_blank(fb_info, arg);\n\t \n\tfbcon_fb_blanked(fb_info, arg);\n\tconsole_unlock();\n\tif (err < 0)\n\t\treturn err;\n\treturn count;\n}\n\nstatic ssize_t show_blank(struct device *device,\n\t\t\t  struct device_attribute *attr, char *buf)\n{\n\n\treturn 0;\n}\n\nstatic ssize_t store_console(struct device *device,\n\t\t\t     struct device_attribute *attr,\n\t\t\t     const char *buf, size_t count)\n{\n\n\treturn 0;\n}\n\nstatic ssize_t show_console(struct device *device,\n\t\t\t    struct device_attribute *attr, char *buf)\n{\n\n\treturn 0;\n}\n\nstatic ssize_t store_cursor(struct device *device,\n\t\t\t    struct device_attribute *attr,\n\t\t\t    const char *buf, size_t count)\n{\n\n\treturn 0;\n}\n\nstatic ssize_t show_cursor(struct device *device,\n\t\t\t   struct device_attribute *attr, char *buf)\n{\n\n\treturn 0;\n}\n\nstatic ssize_t store_pan(struct device *device,\n\t\t\t struct device_attribute *attr,\n\t\t\t const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tstruct fb_var_screeninfo var;\n\tchar *last = NULL;\n\tint err;\n\n\tvar = fb_info->var;\n\tvar.xoffset = simple_strtoul(buf, &last, 0);\n\tlast++;\n\tif (last - buf >= count)\n\t\treturn -EINVAL;\n\tvar.yoffset = simple_strtoul(last, &last, 0);\n\n\tconsole_lock();\n\terr = fb_pan_display(fb_info, &var);\n\tconsole_unlock();\n\n\tif (err < 0)\n\t\treturn err;\n\treturn count;\n}\n\nstatic ssize_t show_pan(struct device *device,\n\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\treturn sysfs_emit(buf, \"%d,%d\\n\", fb_info->var.xoffset,\n\t\t\tfb_info->var.yoffset);\n}\n\nstatic ssize_t show_name(struct device *device,\n\t\t\t struct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\n\treturn sysfs_emit(buf, \"%s\\n\", fb_info->fix.id);\n}\n\nstatic ssize_t store_fbstate(struct device *device,\n\t\t\t     struct device_attribute *attr,\n\t\t\t     const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tu32 state;\n\tchar *last = NULL;\n\n\tstate = simple_strtoul(buf, &last, 0);\n\n\tconsole_lock();\n\tlock_fb_info(fb_info);\n\n\tfb_set_suspend(fb_info, (int)state);\n\n\tunlock_fb_info(fb_info);\n\tconsole_unlock();\n\n\treturn count;\n}\n\nstatic ssize_t show_fbstate(struct device *device,\n\t\t\t    struct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\treturn sysfs_emit(buf, \"%d\\n\", fb_info->state);\n}\n\n#if IS_ENABLED(CONFIG_FB_BACKLIGHT)\nstatic ssize_t store_bl_curve(struct device *device,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tu8 tmp_curve[FB_BACKLIGHT_LEVELS];\n\tunsigned int i;\n\n\t \n\tif (!fb_info || !fb_info->bl_dev)\n\t\treturn -ENODEV;\n\n\tif (count != (FB_BACKLIGHT_LEVELS / 8 * 24))\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < (FB_BACKLIGHT_LEVELS / 8); ++i)\n\t\tif (sscanf(&buf[i * 24],\n\t\t\t\"%2hhx %2hhx %2hhx %2hhx %2hhx %2hhx %2hhx %2hhx\\n\",\n\t\t\t&tmp_curve[i * 8 + 0],\n\t\t\t&tmp_curve[i * 8 + 1],\n\t\t\t&tmp_curve[i * 8 + 2],\n\t\t\t&tmp_curve[i * 8 + 3],\n\t\t\t&tmp_curve[i * 8 + 4],\n\t\t\t&tmp_curve[i * 8 + 5],\n\t\t\t&tmp_curve[i * 8 + 6],\n\t\t\t&tmp_curve[i * 8 + 7]) != 8)\n\t\t\treturn -EINVAL;\n\n\t \n\tmutex_lock(&fb_info->bl_curve_mutex);\n\tfor (i = 0; i < FB_BACKLIGHT_LEVELS; ++i)\n\t\tfb_info->bl_curve[i] = tmp_curve[i];\n\tmutex_unlock(&fb_info->bl_curve_mutex);\n\n\treturn count;\n}\n\nstatic ssize_t show_bl_curve(struct device *device,\n\t\t\t     struct device_attribute *attr, char *buf)\n{\n\tstruct fb_info *fb_info = dev_get_drvdata(device);\n\tssize_t len = 0;\n\tunsigned int i;\n\n\t \n\tif (!fb_info || !fb_info->bl_dev)\n\t\treturn -ENODEV;\n\n\tmutex_lock(&fb_info->bl_curve_mutex);\n\tfor (i = 0; i < FB_BACKLIGHT_LEVELS; i += 8)\n\t\tlen += scnprintf(&buf[len], PAGE_SIZE - len, \"%8ph\\n\",\n\t\t\t\tfb_info->bl_curve + i);\n\tmutex_unlock(&fb_info->bl_curve_mutex);\n\n\treturn len;\n}\n#endif\n\n \nstatic struct device_attribute device_attrs[] = {\n\t__ATTR(bits_per_pixel, S_IRUGO|S_IWUSR, show_bpp, store_bpp),\n\t__ATTR(blank, S_IRUGO|S_IWUSR, show_blank, store_blank),\n\t__ATTR(console, S_IRUGO|S_IWUSR, show_console, store_console),\n\t__ATTR(cursor, S_IRUGO|S_IWUSR, show_cursor, store_cursor),\n\t__ATTR(mode, S_IRUGO|S_IWUSR, show_mode, store_mode),\n\t__ATTR(modes, S_IRUGO|S_IWUSR, show_modes, store_modes),\n\t__ATTR(pan, S_IRUGO|S_IWUSR, show_pan, store_pan),\n\t__ATTR(virtual_size, S_IRUGO|S_IWUSR, show_virtual, store_virtual),\n\t__ATTR(name, S_IRUGO, show_name, NULL),\n\t__ATTR(stride, S_IRUGO, show_stride, NULL),\n\t__ATTR(rotate, S_IRUGO|S_IWUSR, show_rotate, store_rotate),\n\t__ATTR(state, S_IRUGO|S_IWUSR, show_fbstate, store_fbstate),\n#if IS_ENABLED(CONFIG_FB_BACKLIGHT)\n\t__ATTR(bl_curve, S_IRUGO|S_IWUSR, show_bl_curve, store_bl_curve),\n#endif\n};\n\nstatic int fb_init_device(struct fb_info *fb_info)\n{\n\tint i, error = 0;\n\n\tdev_set_drvdata(fb_info->dev, fb_info);\n\n\tfb_info->class_flag |= FB_SYSFS_FLAG_ATTR;\n\n\tfor (i = 0; i < ARRAY_SIZE(device_attrs); i++) {\n\t\terror = device_create_file(fb_info->dev, &device_attrs[i]);\n\n\t\tif (error)\n\t\t\tbreak;\n\t}\n\n\tif (error) {\n\t\twhile (--i >= 0)\n\t\t\tdevice_remove_file(fb_info->dev, &device_attrs[i]);\n\t\tfb_info->class_flag &= ~FB_SYSFS_FLAG_ATTR;\n\t}\n\n\treturn 0;\n}\n\nstatic void fb_cleanup_device(struct fb_info *fb_info)\n{\n\tunsigned int i;\n\n\tif (fb_info->class_flag & FB_SYSFS_FLAG_ATTR) {\n\t\tfor (i = 0; i < ARRAY_SIZE(device_attrs); i++)\n\t\t\tdevice_remove_file(fb_info->dev, &device_attrs[i]);\n\n\t\tfb_info->class_flag &= ~FB_SYSFS_FLAG_ATTR;\n\t}\n}\n\nint fb_device_create(struct fb_info *fb_info)\n{\n\tint node = fb_info->node;\n\tdev_t devt = MKDEV(FB_MAJOR, node);\n\tint ret;\n\n\tfb_info->dev = device_create(fb_class, fb_info->device, devt, NULL, \"fb%d\", node);\n\tif (IS_ERR(fb_info->dev)) {\n\t\t \n\t\tret = PTR_ERR(fb_info->dev);\n\t\tpr_warn(\"Unable to create device for framebuffer %d; error %d\\n\", node, ret);\n\t\tfb_info->dev = NULL;\n\t} else {\n\t\tfb_init_device(fb_info);\n\t}\n\n\treturn 0;\n}\n\nvoid fb_device_destroy(struct fb_info *fb_info)\n{\n\tdev_t devt = MKDEV(FB_MAJOR, fb_info->node);\n\n\tif (!fb_info->dev)\n\t\treturn;\n\n\tfb_cleanup_device(fb_info);\n\tdevice_destroy(fb_class, devt);\n\tfb_info->dev = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}