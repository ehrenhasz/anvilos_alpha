{
  "module_name": "fb_io_fops.c",
  "hash_id": "73e9f818f04fba212587440fd9ffb97330ddef926a6ce07b25109a8fc5aa6618",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/core/fb_io_fops.c",
  "human_readable_source": "\n\n#include <linux/fb.h>\n#include <linux/module.h>\n#include <linux/uaccess.h>\n\nssize_t fb_io_read(struct fb_info *info, char __user *buf, size_t count, loff_t *ppos)\n{\n\tunsigned long p = *ppos;\n\tu8 *buffer, *dst;\n\tu8 __iomem *src;\n\tint c, cnt = 0, err = 0;\n\tunsigned long total_size, trailing;\n\n\tif (!info->screen_base)\n\t\treturn -ENODEV;\n\n\ttotal_size = info->screen_size;\n\n\tif (total_size == 0)\n\t\ttotal_size = info->fix.smem_len;\n\n\tif (p >= total_size)\n\t\treturn 0;\n\n\tif (count >= total_size)\n\t\tcount = total_size;\n\n\tif (count + p > total_size)\n\t\tcount = total_size - p;\n\n\tbuffer = kmalloc((count > PAGE_SIZE) ? PAGE_SIZE : count,\n\t\t\t GFP_KERNEL);\n\tif (!buffer)\n\t\treturn -ENOMEM;\n\n\tsrc = (u8 __iomem *) (info->screen_base + p);\n\n\tif (info->fbops->fb_sync)\n\t\tinfo->fbops->fb_sync(info);\n\n\twhile (count) {\n\t\tc  = (count > PAGE_SIZE) ? PAGE_SIZE : count;\n\t\tdst = buffer;\n\t\tfb_memcpy_fromio(dst, src, c);\n\t\tdst += c;\n\t\tsrc += c;\n\n\t\ttrailing = copy_to_user(buf, buffer, c);\n\t\tif (trailing == c) {\n\t\t\terr = -EFAULT;\n\t\t\tbreak;\n\t\t}\n\t\tc -= trailing;\n\n\t\t*ppos += c;\n\t\tbuf += c;\n\t\tcnt += c;\n\t\tcount -= c;\n\t}\n\n\tkfree(buffer);\n\n\treturn cnt ? cnt : err;\n}\nEXPORT_SYMBOL(fb_io_read);\n\nssize_t fb_io_write(struct fb_info *info, const char __user *buf, size_t count, loff_t *ppos)\n{\n\tunsigned long p = *ppos;\n\tu8 *buffer, *src;\n\tu8 __iomem *dst;\n\tint c, cnt = 0, err = 0;\n\tunsigned long total_size, trailing;\n\n\tif (!info->screen_base)\n\t\treturn -ENODEV;\n\n\ttotal_size = info->screen_size;\n\n\tif (total_size == 0)\n\t\ttotal_size = info->fix.smem_len;\n\n\tif (p > total_size)\n\t\treturn -EFBIG;\n\n\tif (count > total_size) {\n\t\terr = -EFBIG;\n\t\tcount = total_size;\n\t}\n\n\tif (count + p > total_size) {\n\t\tif (!err)\n\t\t\terr = -ENOSPC;\n\n\t\tcount = total_size - p;\n\t}\n\n\tbuffer = kmalloc((count > PAGE_SIZE) ? PAGE_SIZE : count,\n\t\t\t GFP_KERNEL);\n\tif (!buffer)\n\t\treturn -ENOMEM;\n\n\tdst = (u8 __iomem *) (info->screen_base + p);\n\n\tif (info->fbops->fb_sync)\n\t\tinfo->fbops->fb_sync(info);\n\n\twhile (count) {\n\t\tc = (count > PAGE_SIZE) ? PAGE_SIZE : count;\n\t\tsrc = buffer;\n\n\t\ttrailing = copy_from_user(src, buf, c);\n\t\tif (trailing == c) {\n\t\t\terr = -EFAULT;\n\t\t\tbreak;\n\t\t}\n\t\tc -= trailing;\n\n\t\tfb_memcpy_toio(dst, src, c);\n\t\tdst += c;\n\t\tsrc += c;\n\t\t*ppos += c;\n\t\tbuf += c;\n\t\tcnt += c;\n\t\tcount -= c;\n\t}\n\n\tkfree(buffer);\n\n\treturn (cnt) ? cnt : err;\n}\nEXPORT_SYMBOL(fb_io_write);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}