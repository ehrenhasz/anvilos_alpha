{
  "module_name": "cfbfillrect.c",
  "hash_id": "95dc123390214ef5919f89db598582d37e5ff4a7214ac94f45aafcef9ff2a2aa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/core/cfbfillrect.c",
  "human_readable_source": " \n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/fb.h>\n#include <asm/types.h>\n#include \"fb_draw.h\"\n\n#if BITS_PER_LONG == 32\n#  define FB_WRITEL fb_writel\n#  define FB_READL  fb_readl\n#else\n#  define FB_WRITEL fb_writeq\n#  define FB_READL  fb_readq\n#endif\n\n     \n\nstatic void\nbitfill_aligned(struct fb_info *p, unsigned long __iomem *dst, int dst_idx,\n\t\tunsigned long pat, unsigned n, int bits, u32 bswapmask)\n{\n\tunsigned long first, last;\n\n\tif (!n)\n\t\treturn;\n\n\tfirst = fb_shifted_pixels_mask_long(p, dst_idx, bswapmask);\n\tlast = ~fb_shifted_pixels_mask_long(p, (dst_idx+n) % bits, bswapmask);\n\n\tif (dst_idx+n <= bits) {\n\t\t\n\t\tif (last)\n\t\t\tfirst &= last;\n\t\tFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\n\t} else {\n\t\t\n\n\t\t\n\t\tif (first!= ~0UL) {\n\t\t\tFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\n\t\t\tdst++;\n\t\t\tn -= bits - dst_idx;\n\t\t}\n\n\t\t\n\t\tn /= bits;\n\t\twhile (n >= 8) {\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tn -= 8;\n\t\t}\n\t\twhile (n--)\n\t\t\tFB_WRITEL(pat, dst++);\n\n\t\t\n\t\tif (last)\n\t\t\tFB_WRITEL(comp(pat, FB_READL(dst), last), dst);\n\t}\n}\n\n\n     \n\nstatic void\nbitfill_unaligned(struct fb_info *p, unsigned long __iomem *dst, int dst_idx,\n\t\t  unsigned long pat, int left, int right, unsigned n, int bits)\n{\n\tunsigned long first, last;\n\n\tif (!n)\n\t\treturn;\n\n\tfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\n\tlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\n\n\tif (dst_idx+n <= bits) {\n\t\t\n\t\tif (last)\n\t\t\tfirst &= last;\n\t\tFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\n\t} else {\n\t\t\n\t\t\n\t\tif (first) {\n\t\t\tFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tn -= bits - dst_idx;\n\t\t}\n\n\t\t\n\t\tn /= bits;\n\t\twhile (n >= 4) {\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tn -= 4;\n\t\t}\n\t\twhile (n--) {\n\t\t\tFB_WRITEL(pat, dst++);\n\t\t\tpat = pat << left | pat >> right;\n\t\t}\n\n\t\t\n\t\tif (last)\n\t\t\tFB_WRITEL(comp(pat, FB_READL(dst), last), dst);\n\t}\n}\n\n     \nstatic void\nbitfill_aligned_rev(struct fb_info *p, unsigned long __iomem *dst,\n\t\t    int dst_idx, unsigned long pat, unsigned n, int bits,\n\t\t    u32 bswapmask)\n{\n\tunsigned long val = pat, dat;\n\tunsigned long first, last;\n\n\tif (!n)\n\t\treturn;\n\n\tfirst = fb_shifted_pixels_mask_long(p, dst_idx, bswapmask);\n\tlast = ~fb_shifted_pixels_mask_long(p, (dst_idx+n) % bits, bswapmask);\n\n\tif (dst_idx+n <= bits) {\n\t\t\n\t\tif (last)\n\t\t\tfirst &= last;\n\t\tdat = FB_READL(dst);\n\t\tFB_WRITEL(comp(dat ^ val, dat, first), dst);\n\t} else {\n\t\t\n\t\t\n\t\tif (first!=0UL) {\n\t\t\tdat = FB_READL(dst);\n\t\t\tFB_WRITEL(comp(dat ^ val, dat, first), dst);\n\t\t\tdst++;\n\t\t\tn -= bits - dst_idx;\n\t\t}\n\n\t\t\n\t\tn /= bits;\n\t\twhile (n >= 8) {\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t\tn -= 8;\n\t\t}\n\t\twhile (n--) {\n\t\t\tFB_WRITEL(FB_READL(dst) ^ val, dst);\n\t\t\tdst++;\n\t\t}\n\t\t\n\t\tif (last) {\n\t\t\tdat = FB_READL(dst);\n\t\t\tFB_WRITEL(comp(dat ^ val, dat, last), dst);\n\t\t}\n\t}\n}\n\n\n     \n\nstatic void\nbitfill_unaligned_rev(struct fb_info *p, unsigned long __iomem *dst,\n\t\t      int dst_idx, unsigned long pat, int left, int right,\n\t\t      unsigned n, int bits)\n{\n\tunsigned long first, last, dat;\n\n\tif (!n)\n\t\treturn;\n\n\tfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\n\tlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\n\n\tif (dst_idx+n <= bits) {\n\t\t\n\t\tif (last)\n\t\t\tfirst &= last;\n\t\tdat = FB_READL(dst);\n\t\tFB_WRITEL(comp(dat ^ pat, dat, first), dst);\n\t} else {\n\t\t\n\n\t\t\n\t\tif (first != 0UL) {\n\t\t\tdat = FB_READL(dst);\n\t\t\tFB_WRITEL(comp(dat ^ pat, dat, first), dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tn -= bits - dst_idx;\n\t\t}\n\n\t\t\n\t\tn /= bits;\n\t\twhile (n >= 4) {\n\t\t\tFB_WRITEL(FB_READL(dst) ^ pat, dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ pat, dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ pat, dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tFB_WRITEL(FB_READL(dst) ^ pat, dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t\tn -= 4;\n\t\t}\n\t\twhile (n--) {\n\t\t\tFB_WRITEL(FB_READL(dst) ^ pat, dst);\n\t\t\tdst++;\n\t\t\tpat = pat << left | pat >> right;\n\t\t}\n\n\t\t\n\t\tif (last) {\n\t\t\tdat = FB_READL(dst);\n\t\t\tFB_WRITEL(comp(dat ^ pat, dat, last), dst);\n\t\t}\n\t}\n}\n\nvoid cfb_fillrect(struct fb_info *p, const struct fb_fillrect *rect)\n{\n\tunsigned long pat, pat2, fg;\n\tunsigned long width = rect->width, height = rect->height;\n\tint bits = BITS_PER_LONG, bytes = bits >> 3;\n\tu32 bpp = p->var.bits_per_pixel;\n\tunsigned long __iomem *dst;\n\tint dst_idx, left;\n\n\tif (p->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\n\tif (p->fix.visual == FB_VISUAL_TRUECOLOR ||\n\t    p->fix.visual == FB_VISUAL_DIRECTCOLOR )\n\t\tfg = ((u32 *) (p->pseudo_palette))[rect->color];\n\telse\n\t\tfg = rect->color;\n\n\tpat = pixel_to_pat(bpp, fg);\n\n\tdst = (unsigned long __iomem *)((unsigned long)p->screen_base & ~(bytes-1));\n\tdst_idx = ((unsigned long)p->screen_base & (bytes - 1))*8;\n\tdst_idx += rect->dy*p->fix.line_length*8+rect->dx*bpp;\n\t \n\tleft = bits % bpp;\n\tif (p->fbops->fb_sync)\n\t\tp->fbops->fb_sync(p);\n\tif (!left) {\n\t\tu32 bswapmask = fb_compute_bswapmask(p);\n\t\tvoid (*fill_op32)(struct fb_info *p,\n\t\t\t\t  unsigned long __iomem *dst, int dst_idx,\n\t\t                  unsigned long pat, unsigned n, int bits,\n\t\t\t\t  u32 bswapmask) = NULL;\n\n\t\tswitch (rect->rop) {\n\t\tcase ROP_XOR:\n\t\t\tfill_op32 = bitfill_aligned_rev;\n\t\t\tbreak;\n\t\tcase ROP_COPY:\n\t\t\tfill_op32 = bitfill_aligned;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tprintk( KERN_ERR \"cfb_fillrect(): unknown rop, defaulting to ROP_COPY\\n\");\n\t\t\tfill_op32 = bitfill_aligned;\n\t\t\tbreak;\n\t\t}\n\t\twhile (height--) {\n\t\t\tdst += dst_idx >> (ffs(bits) - 1);\n\t\t\tdst_idx &= (bits - 1);\n\t\t\tfill_op32(p, dst, dst_idx, pat, width*bpp, bits,\n\t\t\t\t  bswapmask);\n\t\t\tdst_idx += p->fix.line_length*8;\n\t\t}\n\t} else {\n\t\tint right, r;\n\t\tvoid (*fill_op)(struct fb_info *p, unsigned long __iomem *dst,\n\t\t\t\tint dst_idx, unsigned long pat, int left,\n\t\t\t\tint right, unsigned n, int bits) = NULL;\n#ifdef __LITTLE_ENDIAN\n\t\tright = left;\n\t\tleft = bpp - right;\n#else\n\t\tright = bpp - left;\n#endif\n\t\tswitch (rect->rop) {\n\t\tcase ROP_XOR:\n\t\t\tfill_op = bitfill_unaligned_rev;\n\t\t\tbreak;\n\t\tcase ROP_COPY:\n\t\t\tfill_op = bitfill_unaligned;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tprintk(KERN_ERR \"cfb_fillrect(): unknown rop, defaulting to ROP_COPY\\n\");\n\t\t\tfill_op = bitfill_unaligned;\n\t\t\tbreak;\n\t\t}\n\t\twhile (height--) {\n\t\t\tdst += dst_idx / bits;\n\t\t\tdst_idx &= (bits - 1);\n\t\t\tr = dst_idx % bpp;\n\t\t\t \n\t\t\tpat2 = le_long_to_cpu(rolx(cpu_to_le_long(pat), r, bpp));\n\t\t\tfill_op(p, dst, dst_idx, pat2, left, right,\n\t\t\t\twidth*bpp, bits);\n\t\t\tdst_idx += p->fix.line_length*8;\n\t\t}\n\t}\n}\n\nEXPORT_SYMBOL(cfb_fillrect);\n\nMODULE_AUTHOR(\"James Simmons <jsimmons@users.sf.net>\");\nMODULE_DESCRIPTION(\"Generic software accelerated fill rectangle\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}