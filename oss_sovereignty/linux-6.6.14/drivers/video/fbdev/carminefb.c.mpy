{
  "module_name": "carminefb.c",
  "hash_id": "b7adbb391e148a123243e682c0ca0fc2fb41f96133a1b7100f0fcec6d260e9a4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/carminefb.c",
  "human_readable_source": "\n \n#include <linux/aperture.h>\n#include <linux/delay.h>\n#include <linux/errno.h>\n#include <linux/fb.h>\n#include <linux/interrupt.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n\n#include \"carminefb.h\"\n#include \"carminefb_regs.h\"\n\n#if !defined(__LITTLE_ENDIAN) && !defined(__BIG_ENDIAN)\n#error  \"The endianness of the target host has not been defined.\"\n#endif\n\n \n#define CARMINEFB_DEFAULT_VIDEO_MODE\t1\n\nstatic unsigned int fb_mode = CARMINEFB_DEFAULT_VIDEO_MODE;\nmodule_param(fb_mode, uint, 0444);\nMODULE_PARM_DESC(fb_mode, \"Initial video mode as integer.\");\n\nstatic char *fb_mode_str;\nmodule_param(fb_mode_str, charp, 0444);\nMODULE_PARM_DESC(fb_mode_str, \"Initial video mode in characters.\");\n\n \nstatic int fb_displays = CARMINE_USE_DISPLAY0 | CARMINE_USE_DISPLAY1;\nmodule_param(fb_displays, int, 0444);\nMODULE_PARM_DESC(fb_displays, \"Bit mode, which displays are used\");\n\nstruct carmine_hw {\n\tvoid __iomem *v_regs;\n\tvoid __iomem *screen_mem;\n\tstruct fb_info *fb[MAX_DISPLAY];\n};\n\nstruct carmine_resolution {\n\tu32 htp;\n\tu32 hsp;\n\tu32 hsw;\n\tu32 hdp;\n\tu32 vtr;\n\tu32 vsp;\n\tu32 vsw;\n\tu32 vdp;\n\tu32 disp_mode;\n};\n\nstruct carmine_fb {\n\tvoid __iomem *display_reg;\n\tvoid __iomem *screen_base;\n\tu32 smem_offset;\n\tu32 cur_mode;\n\tu32 new_mode;\n\tstruct carmine_resolution *res;\n\tu32 pseudo_palette[16];\n};\n\nstatic struct fb_fix_screeninfo carminefb_fix = {\n\t.id = \"Carmine\",\n\t.type = FB_TYPE_PACKED_PIXELS,\n\t.visual = FB_VISUAL_TRUECOLOR,\n\t.accel = FB_ACCEL_NONE,\n};\n\nstatic const struct fb_videomode carmine_modedb[] = {\n\t{\n\t\t.name\t\t= \"640x480\",\n\t\t.xres\t\t= 640,\n\t\t.yres\t\t= 480,\n\t}, {\n\t\t.name\t\t= \"800x600\",\n\t\t.xres\t\t= 800,\n\t\t.yres\t\t= 600,\n\t},\n};\n\nstatic struct carmine_resolution car_modes[] = {\n\t{\n\t\t \n\t\t.htp = 800,\n\t\t.hsp = 672,\n\t\t.hsw = 96,\n\t\t.hdp = 640,\n\t\t.vtr = 525,\n\t\t.vsp = 490,\n\t\t.vsw = 2,\n\t\t.vdp = 480,\n\t\t.disp_mode = 0x1400,\n\t},\n\t{\n\t\t \n\t\t.htp = 1060,\n\t\t.hsp = 864,\n\t\t.hsw = 72,\n\t\t.hdp = 800,\n\t\t.vtr = 628,\n\t\t.vsp = 601,\n\t\t.vsw = 2,\n\t\t.vdp = 600,\n\t\t.disp_mode = 0x0d00,\n\t}\n};\n\nstatic int carmine_find_mode(const struct fb_var_screeninfo *var)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(car_modes); i++)\n\t\tif (car_modes[i].hdp == var->xres &&\n\t\t    car_modes[i].vdp == var->yres)\n\t\t\treturn i;\n\treturn -EINVAL;\n}\n\nstatic void c_set_disp_reg(const struct carmine_fb *par,\n\t\tu32 offset, u32 val)\n{\n\twritel(val, par->display_reg + offset);\n}\n\nstatic u32 c_get_disp_reg(const struct carmine_fb *par,\n\t\tu32 offset)\n{\n\treturn readl(par->display_reg + offset);\n}\n\nstatic void c_set_hw_reg(const struct carmine_hw *hw,\n\t\tu32 offset, u32 val)\n{\n\twritel(val, hw->v_regs + offset);\n}\n\nstatic u32 c_get_hw_reg(const struct carmine_hw *hw,\n\t\tu32 offset)\n{\n\treturn readl(hw->v_regs + offset);\n}\n\nstatic int carmine_setcolreg(unsigned regno, unsigned red, unsigned green,\n\t\tunsigned blue, unsigned transp, struct fb_info *info)\n{\n\tif (regno >= 16)\n\t\treturn 1;\n\n\tred >>= 8;\n\tgreen >>= 8;\n\tblue >>= 8;\n\ttransp >>= 8;\n\n\t((__be32 *)info->pseudo_palette)[regno] = cpu_to_be32(transp << 24 |\n\t\tred << 0 | green << 8 | blue << 16);\n\treturn 0;\n}\n\nstatic int carmine_check_var(struct fb_var_screeninfo *var,\n\t\tstruct fb_info *info)\n{\n\tint ret;\n\n\tret = carmine_find_mode(var);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (var->grayscale || var->rotate || var->nonstd)\n\t\treturn -EINVAL;\n\n\tvar->xres_virtual = var->xres;\n\tvar->yres_virtual = var->yres;\n\n\tvar->bits_per_pixel = 32;\n\n#ifdef __BIG_ENDIAN\n\tvar->transp.offset = 24;\n\tvar->red.offset = 0;\n\tvar->green.offset = 8;\n\tvar->blue.offset = 16;\n#else\n\tvar->transp.offset = 24;\n\tvar->red.offset = 16;\n\tvar->green.offset = 8;\n\tvar->blue.offset = 0;\n#endif\n\n\tvar->red.length = 8;\n\tvar->green.length = 8;\n\tvar->blue.length = 8;\n\tvar->transp.length = 8;\n\n\tvar->red.msb_right = 0;\n\tvar->green.msb_right = 0;\n\tvar->blue.msb_right = 0;\n\tvar->transp.msb_right = 0;\n\treturn 0;\n}\n\nstatic void carmine_init_display_param(struct carmine_fb *par)\n{\n\tu32 width;\n\tu32 height;\n\tu32 param;\n\tu32 window_size;\n\tu32 soffset = par->smem_offset;\n\n\tc_set_disp_reg(par, CARMINE_DISP_REG_C_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_MLMR_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_CURSOR_MODE,\n\t\t\tCARMINE_CURSOR0_PRIORITY_MASK |\n\t\t\tCARMINE_CURSOR1_PRIORITY_MASK |\n\t\t\tCARMINE_CURSOR_CUTZ_MASK);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_CUR1_POS, 0 << 16 | 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_CUR2_POS, 0 << 16 | 0);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_EXT_MODE, CARMINE_WINDOW_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L1_EXT_MODE,\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_EXT_MODE, CARMINE_EXTEND_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_EXT_MODE, CARMINE_EXTEND_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_EXT_MODE, CARMINE_EXTEND_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_EXT_MODE, CARMINE_EXTEND_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_EXT_MODE, CARMINE_EXTEND_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_EXT_MODE, CARMINE_EXTEND_MODE |\n\t\t\tCARMINE_EXT_CMODE_DIRECT24_RGBA);\n\n\t \n\twidth = par->res->hdp * 4 / CARMINE_DISP_WIDTH_UNIT;\n\twidth = width << CARMINE_DISP_WIDTH_SHIFT;\n\n\theight = par->res->vdp - 1;\n\tparam = width | height;\n\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_MODE_W_H, param);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L1_WIDTH, width);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_MODE_W_H, param);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_MODE_W_H, param);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_MODE_W_H, param);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_MODE_W_H, param);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_MODE_W_H, param);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_MODE_W_H, param);\n\n\t \n\twindow_size = (par->res->vdp - 1) << CARMINE_DISP_WIN_H_SHIFT;\n\twindow_size |= par->res->hdp;\n\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L1_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L1_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_WIN_SIZE, window_size);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_WIN_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_WIN_SIZE, window_size);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_ORG_ADR, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L1_ORG_ADR, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_ORG_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_ORG_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_ORG_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_ORG_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_ORG_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_ORG_ADR1, soffset);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_DISP_ADR, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_DISP_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_DISP_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_DISP_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_DISP_ADR1, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_DISP_ADR0, soffset);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_DISP_ADR0, soffset);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_DISP_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_DISP_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_DISP_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_DISP_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_DISP_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_DISP_POS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_DISP_POS, 0);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L0, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L1, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L2, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L3, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L4, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L5, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L6, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L7, 0);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L1_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6_TRANS, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7_TRANS, 0);\n\n\t \n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0RM, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2RM, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3RM, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4RM, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5RM, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6RM, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7RM, 0);\n\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0PX, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2PX, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3PX, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4PX, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5PX, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6PX, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7PX, 0);\n\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L0PY, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L2PY, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L3PY, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L4PY, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L5PY, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L6PY, 0);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_L7PY, 0);\n}\n\nstatic void set_display_parameters(struct carmine_fb *par)\n{\n\tu32 mode;\n\tu32 hdp, vdp, htp, hsp, hsw, vtr, vsp, vsw;\n\n\t \n\thdp = par->res->hdp - 1;\n\tvdp = par->res->vdp - 1;\n\thtp = par->res->htp - 1;\n\thsp = par->res->hsp - 1;\n\thsw = par->res->hsw - 1;\n\tvtr = par->res->vtr - 1;\n\tvsp = par->res->vsp - 1;\n\tvsw = par->res->vsw - 1;\n\n\tc_set_disp_reg(par, CARMINE_DISP_REG_H_TOTAL,\n\t\t\thtp << CARMINE_DISP_HTP_SHIFT);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_H_PERIOD,\n\t\t\t(hdp << CARMINE_DISP_HDB_SHIFT)\t| hdp);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_V_H_W_H_POS,\n\t\t\t(vsw << CARMINE_DISP_VSW_SHIFT) |\n\t\t\t(hsw << CARMINE_DISP_HSW_SHIFT) |\n\t\t\t(hsp));\n\tc_set_disp_reg(par, CARMINE_DISP_REG_V_TOTAL,\n\t\t\tvtr << CARMINE_DISP_VTR_SHIFT);\n\tc_set_disp_reg(par, CARMINE_DISP_REG_V_PERIOD_POS,\n\t\t\t(vdp << CARMINE_DISP_VDP_SHIFT) | vsp);\n\n\t \n\tmode = c_get_disp_reg(par, CARMINE_DISP_REG_DCM1);\n\tmode = (mode & ~CARMINE_DISP_DCM_MASK) |\n\t\t(par->res->disp_mode & CARMINE_DISP_DCM_MASK);\n\t \n\tmode |= CARMINE_DEN | CARMINE_L0E;\n\tc_set_disp_reg(par, CARMINE_DISP_REG_DCM1, mode);\n}\n\nstatic int carmine_set_par(struct fb_info *info)\n{\n\tstruct carmine_fb *par = info->par;\n\tint ret;\n\n\tret = carmine_find_mode(&info->var);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tpar->new_mode = ret;\n\tif (par->cur_mode != par->new_mode) {\n\n\t\tpar->cur_mode = par->new_mode;\n\t\tpar->res = &car_modes[par->new_mode];\n\n\t\tcarmine_init_display_param(par);\n\t\tset_display_parameters(par);\n\t}\n\n\tinfo->fix.line_length = info->var.xres * info->var.bits_per_pixel / 8;\n\treturn 0;\n}\n\nstatic int init_hardware(struct carmine_hw *hw)\n{\n\tu32 flags;\n\tu32 loops;\n\tu32 ret;\n\n\t \n\t \n\tc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_CLOCK_ENABLE,\n\t\t\tCARMINE_DFLT_IP_CLOCK_ENABLE);\n\n\t \n\tc_set_hw_reg(hw, CARMINE_DISP0_REG + CARMINE_DISP_REG_DCM1, 0);\n\tc_set_hw_reg(hw, CARMINE_DISP1_REG + CARMINE_DISP_REG_DCM1, 0);\n\n\t \n\tc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_SOFTWARE_RESET, 1);\n\tc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_SOFTWARE_RESET, 0);\n\n\t \n\tflags = CARMINE_DFLT_IP_DCTL_IO_CONT1 << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_IO_CONT0;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_IOCONT1_IOCONT0,\n\t\t\tflags);\n\n\t \n\tflags = CARMINE_DFLT_IP_DCTL_MODE << 16 | CARMINE_DFLT_IP_DCTL_ADD;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_MODE_ADD,\n\t\t\tflags);\n\n\tflags = CARMINE_DFLT_IP_DCTL_SET_TIME1 << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_EMODE;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_SETTIME1_EMODE,\n\t\t\tflags);\n\n\tflags = CARMINE_DFLT_IP_DCTL_REFRESH << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_SET_TIME2;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_REFRESH_SETTIME2,\n\t\t\tflags);\n\n\tflags = CARMINE_DFLT_IP_DCTL_RESERVE2 << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_FIFO_DEPTH;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_RSV2_RSV1, flags);\n\n\tflags = CARMINE_DFLT_IP_DCTL_DDRIF2 << 16 | CARMINE_DFLT_IP_DCTL_DDRIF1;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_DDRIF2_DDRIF1,\n\t\t\tflags);\n\n\tflags = CARMINE_DFLT_IP_DCTL_RESERVE0 << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_STATES;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_RSV0_STATES,\n\t\t\tflags);\n\n\t \n\tif (CARMINE_DCTL_DLL_RESET) {\n\t\tfor (loops = 0; loops < CARMINE_DCTL_INIT_WAIT_LIMIT; loops++) {\n\n\t\t\tret = c_get_hw_reg(hw, CARMINE_DCTL_REG +\n\t\t\t\t\tCARMINE_DCTL_REG_RSV0_STATES);\n\t\t\tret &= CARMINE_DCTL_REG_STATES_MASK;\n\t\t\tif (!ret)\n\t\t\t\tbreak;\n\n\t\t\tmdelay(CARMINE_DCTL_INIT_WAIT_INTERVAL);\n\t\t}\n\n\t\tif (loops >= CARMINE_DCTL_INIT_WAIT_LIMIT) {\n\t\t\tprintk(KERN_ERR \"DRAM init failed\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t}\n\n\tflags = CARMINE_DFLT_IP_DCTL_MODE_AFT_RST << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_ADD;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_MODE_ADD, flags);\n\n\tflags = CARMINE_DFLT_IP_DCTL_RESERVE0 << 16 |\n\t\tCARMINE_DFLT_IP_DCTL_STATES_AFT_RST;\n\tc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_RSV0_STATES,\n\t\t\tflags);\n\n\t \n\tc_set_hw_reg(hw, CARMINE_WB_REG + CARMINE_WB_REG_WBM,\n\t\t\tCARMINE_WB_REG_WBM_DEFAULT);\n\n\t \n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_VRINTM, 0);\n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_VRERRM, 0);\n\n\t \n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_PX, 0);\n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_PY, 0);\n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_LX, 0);\n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_LY, 0);\n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_TX, 0);\n\tc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_TY, 0);\n\treturn 0;\n}\n\nstatic const struct fb_ops carminefb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_check_var\t= carmine_check_var,\n\t.fb_set_par\t= carmine_set_par,\n\t.fb_setcolreg\t= carmine_setcolreg,\n};\n\nstatic int alloc_carmine_fb(void __iomem *regs, void __iomem *smem_base,\n\t\t\t    int smem_offset, struct device *device,\n\t\t\t    struct fb_info **rinfo)\n{\n\tint ret;\n\tstruct fb_info *info;\n\tstruct carmine_fb *par;\n\n\tinfo = framebuffer_alloc(sizeof *par, device);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tpar = info->par;\n\tpar->display_reg = regs;\n\tpar->smem_offset = smem_offset;\n\n\tinfo->screen_base = smem_base + smem_offset;\n\tinfo->screen_size = CARMINE_DISPLAY_MEM;\n\tinfo->fbops = &carminefb_ops;\n\n\tinfo->fix = carminefb_fix;\n\tinfo->pseudo_palette = par->pseudo_palette;\n\n\tret = fb_alloc_cmap(&info->cmap, 256, 1);\n\tif (ret < 0)\n\t\tgoto err_free_fb;\n\n\tif (fb_mode >= ARRAY_SIZE(carmine_modedb))\n\t\tfb_mode = CARMINEFB_DEFAULT_VIDEO_MODE;\n\n\tpar->cur_mode = par->new_mode = ~0;\n\n\tret = fb_find_mode(&info->var, info, fb_mode_str, carmine_modedb,\n\t\t\tARRAY_SIZE(carmine_modedb),\n\t\t\t&carmine_modedb[fb_mode], 32);\n\tif (!ret || ret == 4) {\n\t\tret = -EINVAL;\n\t\tgoto err_dealloc_cmap;\n\t}\n\n\tfb_videomode_to_modelist(carmine_modedb, ARRAY_SIZE(carmine_modedb),\n\t\t\t&info->modelist);\n\n\tret = register_framebuffer(info);\n\tif (ret < 0)\n\t\tgoto err_dealloc_cmap;\n\n\tfb_info(info, \"%s frame buffer device\\n\", info->fix.id);\n\n\t*rinfo = info;\n\treturn 0;\n\nerr_dealloc_cmap:\n\tfb_dealloc_cmap(&info->cmap);\nerr_free_fb:\n\tframebuffer_release(info);\n\treturn ret;\n}\n\nstatic void cleanup_fb_device(struct fb_info *info)\n{\n\tif (info) {\n\t\tunregister_framebuffer(info);\n\t\tfb_dealloc_cmap(&info->cmap);\n\t\tframebuffer_release(info);\n\t}\n}\n\nstatic int carminefb_probe(struct pci_dev *dev, const struct pci_device_id *ent)\n{\n\tstruct carmine_hw *hw;\n\tstruct device *device = &dev->dev;\n\tstruct fb_info *info;\n\tint ret;\n\n\tret = aperture_remove_conflicting_pci_devices(dev, \"carminefb\");\n\tif (ret)\n\t\treturn ret;\n\n\tret = pci_enable_device(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = -ENOMEM;\n\thw = kzalloc(sizeof *hw, GFP_KERNEL);\n\tif (!hw)\n\t\tgoto err_enable_pci;\n\n\tcarminefb_fix.mmio_start = pci_resource_start(dev, CARMINE_CONFIG_BAR);\n\tcarminefb_fix.mmio_len = pci_resource_len(dev, CARMINE_CONFIG_BAR);\n\n\tif (!request_mem_region(carminefb_fix.mmio_start,\n\t\t\t\tcarminefb_fix.mmio_len,\n\t\t\t\t\"carminefb regbase\")) {\n\t\tprintk(KERN_ERR \"carminefb: Can't reserve regbase.\\n\");\n\t\tret = -EBUSY;\n\t\tgoto err_free_hw;\n\t}\n\thw->v_regs = ioremap(carminefb_fix.mmio_start,\n\t\t\tcarminefb_fix.mmio_len);\n\tif (!hw->v_regs) {\n\t\tprintk(KERN_ERR \"carminefb: Can't remap %s register.\\n\",\n\t\t\t\tcarminefb_fix.id);\n\t\tgoto err_free_reg_mmio;\n\t}\n\n\tcarminefb_fix.smem_start = pci_resource_start(dev, CARMINE_MEMORY_BAR);\n\tcarminefb_fix.smem_len = pci_resource_len(dev, CARMINE_MEMORY_BAR);\n\n\t \n\tif (carminefb_fix.smem_len > CARMINE_TOTAL_DIPLAY_MEM)\n\t\tcarminefb_fix.smem_len = CARMINE_TOTAL_DIPLAY_MEM;\n\n\telse if (carminefb_fix.smem_len < CARMINE_TOTAL_DIPLAY_MEM) {\n\t\tprintk(KERN_ERR \"carminefb: Memory bar is only %d bytes, %d \"\n\t\t\t\t\"are required.\", carminefb_fix.smem_len,\n\t\t\t\tCARMINE_TOTAL_DIPLAY_MEM);\n\t\tgoto err_unmap_vregs;\n\t}\n\n\tif (!request_mem_region(carminefb_fix.smem_start,\n\t\t\t\tcarminefb_fix.smem_len,\t\"carminefb smem\")) {\n\t\tprintk(KERN_ERR \"carminefb: Can't reserve smem.\\n\");\n\t\tgoto err_unmap_vregs;\n\t}\n\n\thw->screen_mem = ioremap(carminefb_fix.smem_start,\n\t\t\tcarminefb_fix.smem_len);\n\tif (!hw->screen_mem) {\n\t\tprintk(KERN_ERR \"carmine: Can't ioremap smem area.\\n\");\n\t\tgoto err_reg_smem;\n\t}\n\n\tret = init_hardware(hw);\n\tif (ret)\n\t\tgoto err_unmap_screen;\n\n\tinfo = NULL;\n\tif (fb_displays & CARMINE_USE_DISPLAY0) {\n\t\tret = alloc_carmine_fb(hw->v_regs + CARMINE_DISP0_REG,\n\t\t\t\thw->screen_mem, CARMINE_DISPLAY_MEM * 0,\n\t\t\t\tdevice, &info);\n\t\tif (ret)\n\t\t\tgoto err_deinit_hw;\n\t}\n\n\thw->fb[0] = info;\n\n\tinfo = NULL;\n\tif (fb_displays & CARMINE_USE_DISPLAY1) {\n\t\tret = alloc_carmine_fb(hw->v_regs + CARMINE_DISP1_REG,\n\t\t\t\thw->screen_mem, CARMINE_DISPLAY_MEM * 1,\n\t\t\t\tdevice, &info);\n\t\tif (ret)\n\t\t\tgoto err_cleanup_fb0;\n\t}\n\n\thw->fb[1] = info;\n\tinfo = NULL;\n\n\tpci_set_drvdata(dev, hw);\n\treturn 0;\n\nerr_cleanup_fb0:\n\tcleanup_fb_device(hw->fb[0]);\nerr_deinit_hw:\n\t \n\tc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_CLOCK_ENABLE, 0);\nerr_unmap_screen:\n\tiounmap(hw->screen_mem);\nerr_reg_smem:\n\trelease_mem_region(carminefb_fix.smem_start, carminefb_fix.smem_len);\nerr_unmap_vregs:\n\tiounmap(hw->v_regs);\nerr_free_reg_mmio:\n\trelease_mem_region(carminefb_fix.mmio_start, carminefb_fix.mmio_len);\nerr_free_hw:\n\tkfree(hw);\nerr_enable_pci:\n\tpci_disable_device(dev);\n\treturn ret;\n}\n\nstatic void carminefb_remove(struct pci_dev *dev)\n{\n\tstruct carmine_hw *hw = pci_get_drvdata(dev);\n\tstruct fb_fix_screeninfo fix;\n\tint i;\n\n\t \n\tif (hw->fb[0])\n\t\tfix = hw->fb[0]->fix;\n\telse\n\t\tfix = hw->fb[1]->fix;\n\n\t \n\tc_set_hw_reg(hw, CARMINE_DISP0_REG + CARMINE_DISP_REG_DCM1, 0);\n\tc_set_hw_reg(hw, CARMINE_DISP1_REG + CARMINE_DISP_REG_DCM1, 0);\n\tc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_CLOCK_ENABLE, 0);\n\n\tfor (i = 0; i < MAX_DISPLAY; i++)\n\t\tcleanup_fb_device(hw->fb[i]);\n\n\tiounmap(hw->screen_mem);\n\trelease_mem_region(fix.smem_start, fix.smem_len);\n\tiounmap(hw->v_regs);\n\trelease_mem_region(fix.mmio_start, fix.mmio_len);\n\n\tpci_disable_device(dev);\n\tkfree(hw);\n}\n\n#define PCI_VENDOR_ID_FUJITU_LIMITED 0x10cf\nstatic struct pci_device_id carmine_devices[] = {\n{\n\tPCI_DEVICE(PCI_VENDOR_ID_FUJITU_LIMITED, 0x202b)},\n\t{0, 0, 0, 0, 0, 0, 0}\n};\n\nMODULE_DEVICE_TABLE(pci, carmine_devices);\n\nstatic struct pci_driver carmine_pci_driver = {\n\t.name\t\t= \"carminefb\",\n\t.id_table\t= carmine_devices,\n\t.probe\t\t= carminefb_probe,\n\t.remove\t\t= carminefb_remove,\n};\n\nstatic int __init carminefb_init(void)\n{\n\tif (fb_modesetting_disabled(\"carminefb\"))\n\t\treturn -ENODEV;\n\n\tif (!(fb_displays &\n\t\t(CARMINE_USE_DISPLAY0 | CARMINE_USE_DISPLAY1))) {\n\t\tprintk(KERN_ERR \"If you disable both displays than you don't \"\n\t\t\t\t\"need the driver at all\\n\");\n\t\treturn -EINVAL;\n\t}\n\treturn pci_register_driver(&carmine_pci_driver);\n}\nmodule_init(carminefb_init);\n\nstatic void __exit carminefb_cleanup(void)\n{\n\tpci_unregister_driver(&carmine_pci_driver);\n}\nmodule_exit(carminefb_cleanup);\n\nMODULE_AUTHOR(\"Sebastian Siewior <bigeasy@linutronix.de>\");\nMODULE_DESCRIPTION(\"Framebuffer driver for Fujitsu Carmine based devices\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}