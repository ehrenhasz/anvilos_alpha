{
  "module_name": "cr_pll.c",
  "hash_id": "59aeabb1949fd11d721d0fbadb50d9d5fd1a8105dc542461ac9ae2124c7830ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/vermilion/cr_pll.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/pci.h>\n#include <linux/errno.h>\n#include <linux/fb.h>\n#include \"vermilion.h\"\n\n \n#define CRVML_DEVICE_MCH   0x5001\n#define CRVML_REG_MCHBAR   0x44\n#define CRVML_REG_MCHEN    0x54\n#define CRVML_MCHEN_BIT    (1 << 28)\n#define CRVML_MCHMAP_SIZE  4096\n#define CRVML_REG_CLOCK    0xc3c\n#define CRVML_CLOCK_SHIFT  8\n#define CRVML_CLOCK_MASK   0x00000f00\n\nstatic struct pci_dev *mch_dev;\nstatic u32 mch_bar;\nstatic void __iomem *mch_regs_base;\nstatic u32 saved_clock;\n\nstatic const unsigned crvml_clocks[] = {\n\t6750,\n\t13500,\n\t27000,\n\t29700,\n\t37125,\n\t54000,\n\t59400,\n\t74250,\n\t120000\n\t     \n};\n\nstatic const u32 crvml_clock_bits[] = {\n\t0x0a,\n\t0x09,\n\t0x08,\n\t0x07,\n\t0x06,\n\t0x05,\n\t0x04,\n\t0x03,\n\t0x0b\n};\n\nstatic const unsigned crvml_num_clocks = ARRAY_SIZE(crvml_clocks);\n\nstatic int crvml_sys_restore(struct vml_sys *sys)\n{\n\tvoid __iomem *clock_reg = mch_regs_base + CRVML_REG_CLOCK;\n\n\tiowrite32(saved_clock, clock_reg);\n\tioread32(clock_reg);\n\n\treturn 0;\n}\n\nstatic int crvml_sys_save(struct vml_sys *sys)\n{\n\tvoid __iomem *clock_reg = mch_regs_base + CRVML_REG_CLOCK;\n\n\tsaved_clock = ioread32(clock_reg);\n\n\treturn 0;\n}\n\nstatic int crvml_nearest_index(const struct vml_sys *sys, int clock)\n{\n\tint i;\n\tint cur_index = 0;\n\tint cur_diff;\n\tint diff;\n\n\tcur_diff = clock - crvml_clocks[0];\n\tcur_diff = (cur_diff < 0) ? -cur_diff : cur_diff;\n\tfor (i = 1; i < crvml_num_clocks; ++i) {\n\t\tdiff = clock - crvml_clocks[i];\n\t\tdiff = (diff < 0) ? -diff : diff;\n\t\tif (diff < cur_diff) {\n\t\t\tcur_index = i;\n\t\t\tcur_diff = diff;\n\t\t}\n\t}\n\treturn cur_index;\n}\n\nstatic int crvml_nearest_clock(const struct vml_sys *sys, int clock)\n{\n\treturn crvml_clocks[crvml_nearest_index(sys, clock)];\n}\n\nstatic int crvml_set_clock(struct vml_sys *sys, int clock)\n{\n\tvoid __iomem *clock_reg = mch_regs_base + CRVML_REG_CLOCK;\n\tint index;\n\tu32 clock_val;\n\n\tindex = crvml_nearest_index(sys, clock);\n\n\tif (crvml_clocks[index] != clock)\n\t\treturn -EINVAL;\n\n\tclock_val = ioread32(clock_reg) & ~CRVML_CLOCK_MASK;\n\tclock_val = crvml_clock_bits[index] << CRVML_CLOCK_SHIFT;\n\tiowrite32(clock_val, clock_reg);\n\tioread32(clock_reg);\n\n\treturn 0;\n}\n\nstatic struct vml_sys cr_pll_ops = {\n\t.name = \"Carillo Ranch\",\n\t.save = crvml_sys_save,\n\t.restore = crvml_sys_restore,\n\t.set_clock = crvml_set_clock,\n\t.nearest_clock = crvml_nearest_clock,\n};\n\nstatic int __init cr_pll_init(void)\n{\n\tint err;\n\tu32 dev_en;\n\n\tmch_dev = pci_get_device(PCI_VENDOR_ID_INTEL,\n\t\t\t\t\tCRVML_DEVICE_MCH, NULL);\n\tif (!mch_dev) {\n\t\tprintk(KERN_ERR\n\t\t       \"Could not find Carillo Ranch MCH device.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tpci_read_config_dword(mch_dev, CRVML_REG_MCHEN, &dev_en);\n\tif (!(dev_en & CRVML_MCHEN_BIT)) {\n\t\tprintk(KERN_ERR\n\t\t       \"Carillo Ranch MCH device was not enabled.\\n\");\n\t\tpci_dev_put(mch_dev);\n\t\treturn -ENODEV;\n\t}\n\n\tpci_read_config_dword(mch_dev, CRVML_REG_MCHBAR,\n\t\t\t      &mch_bar);\n\tmch_regs_base =\n\t    ioremap(mch_bar, CRVML_MCHMAP_SIZE);\n\tif (!mch_regs_base) {\n\t\tprintk(KERN_ERR\n\t\t       \"Carillo Ranch MCH device was not enabled.\\n\");\n\t\tpci_dev_put(mch_dev);\n\t\treturn -ENODEV;\n\t}\n\n\terr = vmlfb_register_subsys(&cr_pll_ops);\n\tif (err) {\n\t\tprintk(KERN_ERR\n\t\t       \"Carillo Ranch failed to initialize vml_sys.\\n\");\n\t\tiounmap(mch_regs_base);\n\t\tpci_dev_put(mch_dev);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic void __exit cr_pll_exit(void)\n{\n\tvmlfb_unregister_subsys(&cr_pll_ops);\n\n\tiounmap(mch_regs_base);\n\tpci_dev_put(mch_dev);\n}\n\nmodule_init(cr_pll_init);\nmodule_exit(cr_pll_exit);\n\nMODULE_AUTHOR(\"Tungsten Graphics Inc.\");\nMODULE_DESCRIPTION(\"Carillo Ranch PLL Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}