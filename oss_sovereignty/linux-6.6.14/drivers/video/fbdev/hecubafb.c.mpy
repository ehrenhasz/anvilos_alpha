{
  "module_name": "hecubafb.c",
  "hash_id": "c91fb58dc3ddf8fb68f7669aa736f9e873d847011aec872c25f1f4c600e8b60a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/hecubafb.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/string.h>\n#include <linux/mm.h>\n#include <linux/vmalloc.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/fb.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/list.h>\n#include <linux/uaccess.h>\n\n#include <video/hecubafb.h>\n\n \n#define DPY_W 600\n#define DPY_H 800\n\nstatic const struct fb_fix_screeninfo hecubafb_fix = {\n\t.id =\t\t\"hecubafb\",\n\t.type =\t\tFB_TYPE_PACKED_PIXELS,\n\t.visual =\tFB_VISUAL_MONO01,\n\t.xpanstep =\t0,\n\t.ypanstep =\t0,\n\t.ywrapstep =\t0,\n\t.line_length =\tDPY_W,\n\t.accel =\tFB_ACCEL_NONE,\n};\n\nstatic const struct fb_var_screeninfo hecubafb_var = {\n\t.xres\t\t= DPY_W,\n\t.yres\t\t= DPY_H,\n\t.xres_virtual\t= DPY_W,\n\t.yres_virtual\t= DPY_H,\n\t.bits_per_pixel\t= 1,\n\t.nonstd\t\t= 1,\n};\n\n \n\nstatic void apollo_send_data(struct hecubafb_par *par, unsigned char data)\n{\n\t \n\tpar->board->set_data(par, data);\n\n\t \n\tpar->board->set_ctl(par, HCB_DS_BIT, 0);\n\n\t \n\tpar->board->wait_for_ack(par, 0);\n\n\t \n\tpar->board->set_ctl(par, HCB_DS_BIT, 1);\n\n\t \n\tpar->board->wait_for_ack(par, 1);\n}\n\nstatic void apollo_send_command(struct hecubafb_par *par, unsigned char data)\n{\n\t \n\tpar->board->set_ctl(par, HCB_CD_BIT, 1);\n\n\t \n\tapollo_send_data(par, data);\n\n\t \n\tpar->board->set_ctl(par, HCB_CD_BIT, 0);\n}\n\nstatic void hecubafb_dpy_update(struct hecubafb_par *par)\n{\n\tint i;\n\tunsigned char *buf = par->info->screen_buffer;\n\n\tapollo_send_command(par, APOLLO_START_NEW_IMG);\n\n\tfor (i=0; i < (DPY_W*DPY_H/8); i++) {\n\t\tapollo_send_data(par, *(buf++));\n\t}\n\n\tapollo_send_command(par, APOLLO_STOP_IMG_DATA);\n\tapollo_send_command(par, APOLLO_DISPLAY_IMG);\n}\n\n \nstatic void hecubafb_dpy_deferred_io(struct fb_info *info, struct list_head *pagereflist)\n{\n\thecubafb_dpy_update(info->par);\n}\n\nstatic void hecubafb_defio_damage_range(struct fb_info *info, off_t off, size_t len)\n{\n\tstruct hecubafb_par *par = info->par;\n\n\thecubafb_dpy_update(par);\n}\n\nstatic void hecubafb_defio_damage_area(struct fb_info *info, u32 x, u32 y,\n\t\t\t\t       u32 width, u32 height)\n{\n\tstruct hecubafb_par *par = info->par;\n\n\thecubafb_dpy_update(par);\n}\n\nFB_GEN_DEFAULT_DEFERRED_SYSMEM_OPS(hecubafb,\n\t\t\t\t   hecubafb_defio_damage_range,\n\t\t\t\t   hecubafb_defio_damage_area)\n\nstatic const struct fb_ops hecubafb_ops = {\n\t.owner\t= THIS_MODULE,\n\tFB_DEFAULT_DEFERRED_OPS(hecubafb),\n};\n\nstatic struct fb_deferred_io hecubafb_defio = {\n\t.delay\t\t= HZ,\n\t.deferred_io\t= hecubafb_dpy_deferred_io,\n};\n\nstatic int hecubafb_probe(struct platform_device *dev)\n{\n\tstruct fb_info *info;\n\tstruct hecuba_board *board;\n\tint retval = -ENOMEM;\n\tint videomemorysize;\n\tunsigned char *videomemory;\n\tstruct hecubafb_par *par;\n\n\t \n\tboard = dev->dev.platform_data;\n\tif (!board)\n\t\treturn -EINVAL;\n\n\t \n\tif (!try_module_get(board->owner))\n\t\treturn -ENODEV;\n\n\tvideomemorysize = (DPY_W*DPY_H)/8;\n\n\tvideomemory = vzalloc(videomemorysize);\n\tif (!videomemory)\n\t\tgoto err_videomem_alloc;\n\n\tinfo = framebuffer_alloc(sizeof(struct hecubafb_par), &dev->dev);\n\tif (!info)\n\t\tgoto err_fballoc;\n\n\tinfo->screen_buffer = videomemory;\n\tinfo->fbops = &hecubafb_ops;\n\n\tinfo->var = hecubafb_var;\n\tinfo->fix = hecubafb_fix;\n\tinfo->fix.smem_len = videomemorysize;\n\tpar = info->par;\n\tpar->info = info;\n\tpar->board = board;\n\tpar->send_command = apollo_send_command;\n\tpar->send_data = apollo_send_data;\n\n\tinfo->flags = FBINFO_VIRTFB;\n\n\tinfo->fbdefio = &hecubafb_defio;\n\tfb_deferred_io_init(info);\n\n\tretval = register_framebuffer(info);\n\tif (retval < 0)\n\t\tgoto err_fbreg;\n\tplatform_set_drvdata(dev, info);\n\n\tfb_info(info, \"Hecuba frame buffer device, using %dK of video memory\\n\",\n\t\tvideomemorysize >> 10);\n\n\t \n\tretval = par->board->init(par);\n\tif (retval < 0)\n\t\tgoto err_fbreg;\n\n\treturn 0;\nerr_fbreg:\n\tframebuffer_release(info);\nerr_fballoc:\n\tvfree(videomemory);\nerr_videomem_alloc:\n\tmodule_put(board->owner);\n\treturn retval;\n}\n\nstatic void hecubafb_remove(struct platform_device *dev)\n{\n\tstruct fb_info *info = platform_get_drvdata(dev);\n\n\tif (info) {\n\t\tstruct hecubafb_par *par = info->par;\n\t\tfb_deferred_io_cleanup(info);\n\t\tunregister_framebuffer(info);\n\t\tvfree(info->screen_buffer);\n\t\tif (par->board->remove)\n\t\t\tpar->board->remove(par);\n\t\tmodule_put(par->board->owner);\n\t\tframebuffer_release(info);\n\t}\n}\n\nstatic struct platform_driver hecubafb_driver = {\n\t.probe\t= hecubafb_probe,\n\t.remove_new = hecubafb_remove,\n\t.driver\t= {\n\t\t.name\t= \"hecubafb\",\n\t},\n};\nmodule_platform_driver(hecubafb_driver);\n\nMODULE_DESCRIPTION(\"fbdev driver for Hecuba/Apollo controller\");\nMODULE_AUTHOR(\"Jaya Kumar\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}