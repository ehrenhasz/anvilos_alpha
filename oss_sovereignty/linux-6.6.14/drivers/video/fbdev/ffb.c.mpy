{
  "module_name": "ffb.c",
  "hash_id": "74348ecb32377ed246b8d2a5e00f3d412d93bf2e123e46c75208d7a83b66ef40",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/ffb.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/string.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/fb.h>\n#include <linux/mm.h>\n#include <linux/timer.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n\n#include <asm/io.h>\n#include <asm/upa.h>\n#include <asm/fbio.h>\n\n#include \"sbuslib.h\"\n\n \n\nstatic int ffb_setcolreg(unsigned, unsigned, unsigned, unsigned,\n\t\t\t unsigned, struct fb_info *);\nstatic int ffb_blank(int, struct fb_info *);\n\nstatic void ffb_imageblit(struct fb_info *, const struct fb_image *);\nstatic void ffb_fillrect(struct fb_info *, const struct fb_fillrect *);\nstatic void ffb_copyarea(struct fb_info *, const struct fb_copyarea *);\nstatic int ffb_sync(struct fb_info *);\nstatic int ffb_mmap(struct fb_info *, struct vm_area_struct *);\nstatic int ffb_ioctl(struct fb_info *, unsigned int, unsigned long);\nstatic int ffb_pan_display(struct fb_var_screeninfo *, struct fb_info *);\n\n \n\nstatic const struct fb_ops ffb_ops = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.fb_setcolreg\t\t= ffb_setcolreg,\n\t.fb_blank\t\t= ffb_blank,\n\t.fb_pan_display\t\t= ffb_pan_display,\n\t.fb_fillrect\t\t= ffb_fillrect,\n\t.fb_copyarea\t\t= ffb_copyarea,\n\t.fb_imageblit\t\t= ffb_imageblit,\n\t.fb_sync\t\t= ffb_sync,\n\t.fb_mmap\t\t= ffb_mmap,\n\t.fb_ioctl\t\t= ffb_ioctl,\n#ifdef CONFIG_COMPAT\n\t.fb_compat_ioctl\t= sbusfb_compat_ioctl,\n#endif\n};\n\n \n#define\tFFB_SFB8R_VOFF\t\t0x00000000\n#define\tFFB_SFB8G_VOFF\t\t0x00400000\n#define\tFFB_SFB8B_VOFF\t\t0x00800000\n#define\tFFB_SFB8X_VOFF\t\t0x00c00000\n#define\tFFB_SFB32_VOFF\t\t0x01000000\n#define\tFFB_SFB64_VOFF\t\t0x02000000\n#define\tFFB_FBC_REGS_VOFF\t0x04000000\n#define\tFFB_BM_FBC_REGS_VOFF\t0x04002000\n#define\tFFB_DFB8R_VOFF\t\t0x04004000\n#define\tFFB_DFB8G_VOFF\t\t0x04404000\n#define\tFFB_DFB8B_VOFF\t\t0x04804000\n#define\tFFB_DFB8X_VOFF\t\t0x04c04000\n#define\tFFB_DFB24_VOFF\t\t0x05004000\n#define\tFFB_DFB32_VOFF\t\t0x06004000\n#define\tFFB_DFB422A_VOFF\t0x07004000\t \n#define\tFFB_DFB422AD_VOFF\t0x07804000\t \n#define\tFFB_DFB24B_VOFF\t\t0x08004000\t \n#define\tFFB_DFB422B_VOFF\t0x09004000\t \n#define\tFFB_DFB422BD_VOFF\t0x09804000\t \n#define\tFFB_SFB16Z_VOFF\t\t0x0a004000\t \n#define\tFFB_SFB8Z_VOFF\t\t0x0a404000\t \n#define\tFFB_SFB422_VOFF\t\t0x0ac04000\t \n#define\tFFB_SFB422D_VOFF\t0x0b404000\t \n#define\tFFB_FBC_KREGS_VOFF\t0x0bc04000\n#define\tFFB_DAC_VOFF\t\t0x0bc06000\n#define\tFFB_PROM_VOFF\t\t0x0bc08000\n#define\tFFB_EXP_VOFF\t\t0x0bc18000\n\n#define\tFFB_SFB8R_POFF\t\t0x04000000UL\n#define\tFFB_SFB8G_POFF\t\t0x04400000UL\n#define\tFFB_SFB8B_POFF\t\t0x04800000UL\n#define\tFFB_SFB8X_POFF\t\t0x04c00000UL\n#define\tFFB_SFB32_POFF\t\t0x05000000UL\n#define\tFFB_SFB64_POFF\t\t0x06000000UL\n#define\tFFB_FBC_REGS_POFF\t0x00600000UL\n#define\tFFB_BM_FBC_REGS_POFF\t0x00600000UL\n#define\tFFB_DFB8R_POFF\t\t0x01000000UL\n#define\tFFB_DFB8G_POFF\t\t0x01400000UL\n#define\tFFB_DFB8B_POFF\t\t0x01800000UL\n#define\tFFB_DFB8X_POFF\t\t0x01c00000UL\n#define\tFFB_DFB24_POFF\t\t0x02000000UL\n#define\tFFB_DFB32_POFF\t\t0x03000000UL\n#define\tFFB_FBC_KREGS_POFF\t0x00610000UL\n#define\tFFB_DAC_POFF\t\t0x00400000UL\n#define\tFFB_PROM_POFF\t\t0x00000000UL\n#define\tFFB_EXP_POFF\t\t0x00200000UL\n#define FFB_DFB422A_POFF\t0x09000000UL\n#define FFB_DFB422AD_POFF\t0x09800000UL\n#define FFB_DFB24B_POFF\t\t0x0a000000UL\n#define FFB_DFB422B_POFF\t0x0b000000UL\n#define FFB_DFB422BD_POFF\t0x0b800000UL\n#define FFB_SFB16Z_POFF\t\t0x0c800000UL\n#define FFB_SFB8Z_POFF\t\t0x0c000000UL\n#define FFB_SFB422_POFF\t\t0x0d000000UL\n#define FFB_SFB422D_POFF\t0x0d800000UL\n\n \n#define FFB_DRAWOP_DOT\t\t0x00\n#define FFB_DRAWOP_AADOT\t0x01\n#define FFB_DRAWOP_BRLINECAP\t0x02\n#define FFB_DRAWOP_BRLINEOPEN\t0x03\n#define FFB_DRAWOP_DDLINE\t0x04\n#define FFB_DRAWOP_AALINE\t0x05\n#define FFB_DRAWOP_TRIANGLE\t0x06\n#define FFB_DRAWOP_POLYGON\t0x07\n#define FFB_DRAWOP_RECTANGLE\t0x08\n#define FFB_DRAWOP_FASTFILL\t0x09\n#define FFB_DRAWOP_BCOPY\t0x0a\n#define FFB_DRAWOP_VSCROLL\t0x0b\n\n \n \n#define FFB_PPC_FW_DISABLE\t0x800000\n#define FFB_PPC_FW_ENABLE\t0xc00000\n \n#define FFB_PPC_ACE_DISABLE\t0x040000\n#define FFB_PPC_ACE_AUX_SUB\t0x080000\n#define FFB_PPC_ACE_AUX_ADD\t0x0c0000\n \n#define FFB_PPC_DCE_DISABLE\t0x020000\n#define FFB_PPC_DCE_ENABLE\t0x030000\n \n#define FFB_PPC_ABE_DISABLE\t0x008000\n#define FFB_PPC_ABE_ENABLE\t0x00c000\n \n#define FFB_PPC_VCE_DISABLE\t0x001000\n#define FFB_PPC_VCE_2D\t\t0x002000\n#define FFB_PPC_VCE_3D\t\t0x003000\n \n#define FFB_PPC_APE_DISABLE\t0x000800\n#define FFB_PPC_APE_ENABLE\t0x000c00\n \n#define FFB_PPC_TBE_OPAQUE\t0x000200\n#define FFB_PPC_TBE_TRANSPARENT\t0x000300\n \n#define FFB_PPC_ZS_VAR\t\t0x000080\n#define FFB_PPC_ZS_CONST\t0x0000c0\n \n#define FFB_PPC_YS_VAR\t\t0x000020\n#define FFB_PPC_YS_CONST\t0x000030\n \n#define FFB_PPC_XS_WID\t\t0x000004\n#define FFB_PPC_XS_VAR\t\t0x000008\n#define FFB_PPC_XS_CONST\t0x00000c\n \n#define FFB_PPC_CS_VAR\t\t0x000002\n#define FFB_PPC_CS_CONST\t0x000003\n\n#define FFB_ROP_NEW\t\t0x83\n#define FFB_ROP_OLD\t\t0x85\n#define FFB_ROP_NEW_XOR_OLD\t0x86\n\n#define FFB_UCSR_FIFO_MASK\t0x00000fff\n#define FFB_UCSR_FB_BUSY\t0x01000000\n#define FFB_UCSR_RP_BUSY\t0x02000000\n#define FFB_UCSR_ALL_BUSY\t(FFB_UCSR_RP_BUSY|FFB_UCSR_FB_BUSY)\n#define FFB_UCSR_READ_ERR\t0x40000000\n#define FFB_UCSR_FIFO_OVFL\t0x80000000\n#define FFB_UCSR_ALL_ERRORS\t(FFB_UCSR_READ_ERR|FFB_UCSR_FIFO_OVFL)\n\nstruct ffb_fbc {\n\t \n\tu32\txxx1[3];\n\tu32\talpha;\n\tu32\tred;\n\tu32\tgreen;\n\tu32\tblue;\n\tu32\tdepth;\n\tu32\ty;\n\tu32\tx;\n\tu32\txxx2[2];\n\tu32\tryf;\n\tu32\trxf;\n\tu32\txxx3[2];\n\n\tu32\tdmyf;\n\tu32\tdmxf;\n\tu32\txxx4[2];\n\tu32\tebyi;\n\tu32\tebxi;\n\tu32\txxx5[2];\n\tu32\tby;\n\tu32\tbx;\n\tu32\tdy;\n\tu32\tdx;\n\tu32\tbh;\n\tu32\tbw;\n\tu32\txxx6[2];\n\n\tu32\txxx7[32];\n\n\t \n\tu32\tsuvtx;\n\tu32\txxx8[63];\n\n\t \n\tu32\tppc;\n\tu32\twid;\n\tu32\tfg;\n\tu32\tbg;\n\tu32\tconsty;\n\tu32\tconstz;\n\tu32\txclip;\n\tu32\tdcss;\n\tu32\tvclipmin;\n\tu32\tvclipmax;\n\tu32\tvclipzmin;\n\tu32\tvclipzmax;\n\tu32\tdcsf;\n\tu32\tdcsb;\n\tu32\tdczf;\n\tu32\tdczb;\n\n\tu32\txxx9;\n\tu32\tblendc;\n\tu32\tblendc1;\n\tu32\tblendc2;\n\tu32\tfbramitc;\n\tu32\tfbc;\n\tu32\trop;\n\tu32\tcmp;\n\tu32\tmatchab;\n\tu32\tmatchc;\n\tu32\tmagnab;\n\tu32\tmagnc;\n\tu32\tfbcfg0;\n\tu32\tfbcfg1;\n\tu32\tfbcfg2;\n\tu32\tfbcfg3;\n\n\tu32\tppcfg;\n\tu32\tpick;\n\tu32\tfillmode;\n\tu32\tfbramwac;\n\tu32\tpmask;\n\tu32\txpmask;\n\tu32\typmask;\n\tu32\tzpmask;\n\tu32\tclip0min;\n\tu32\tclip0max;\n\tu32\tclip1min;\n\tu32\tclip1max;\n\tu32\tclip2min;\n\tu32\tclip2max;\n\tu32\tclip3min;\n\tu32\tclip3max;\n\n\t \n\tu32\trawblend2;\n\tu32\trawpreblend;\n\tu32\trawstencil;\n\tu32\trawstencilctl;\n\tu32\tthreedram1;\n\tu32\tthreedram2;\n\tu32\tpassin;\n\tu32\trawclrdepth;\n\tu32\trawpmask;\n\tu32\trawcsrc;\n\tu32\trawmatch;\n\tu32\trawmagn;\n\tu32\trawropblend;\n\tu32\trawcmp;\n\tu32\trawwac;\n\tu32\tfbramid;\n\n\tu32\tdrawop;\n\tu32\txxx10[2];\n\tu32\tfontlpat;\n\tu32\txxx11;\n\tu32\tfontxy;\n\tu32\tfontw;\n\tu32\tfontinc;\n\tu32\tfont;\n\tu32\txxx12[3];\n\tu32\tblend2;\n\tu32\tpreblend;\n\tu32\tstencil;\n\tu32\tstencilctl;\n\n\tu32\txxx13[4];\n\tu32\tdcss1;\n\tu32\tdcss2;\n\tu32\tdcss3;\n\tu32\twidpmask;\n\tu32\tdcs2;\n\tu32\tdcs3;\n\tu32\tdcs4;\n\tu32\txxx14;\n\tu32\tdcd2;\n\tu32\tdcd3;\n\tu32\tdcd4;\n\tu32\txxx15;\n\n\tu32\tpattern[32];\n\n\tu32\txxx16[256];\n\n\tu32\tdevid;\n\tu32\txxx17[63];\n\n\tu32\tucsr;\n\tu32\txxx18[31];\n\n\tu32\tmer;\n};\n\nstruct ffb_dac {\n\tu32\ttype;\n\tu32\tvalue;\n\tu32\ttype2;\n\tu32\tvalue2;\n};\n\n#define FFB_DAC_UCTRL\t\t0x1001  \n#define FFB_DAC_UCTRL_MANREV\t0x00000f00  \n#define FFB_DAC_UCTRL_MANREV_SHIFT 8\n#define FFB_DAC_TGEN\t\t0x6000  \n#define FFB_DAC_TGEN_VIDE\t0x00000001  \n#define FFB_DAC_DID\t\t0x8000  \n#define FFB_DAC_DID_PNUM\t0x0ffff000  \n#define FFB_DAC_DID_PNUM_SHIFT\t12\n#define FFB_DAC_DID_REV\t\t0xf0000000  \n#define FFB_DAC_DID_REV_SHIFT\t28\n\n#define FFB_DAC_CUR_CTRL\t0x100\n#define FFB_DAC_CUR_CTRL_P0\t0x00000001\n#define FFB_DAC_CUR_CTRL_P1\t0x00000002\n\nstruct ffb_par {\n\tspinlock_t\t\tlock;\n\tstruct ffb_fbc __iomem\t*fbc;\n\tstruct ffb_dac __iomem\t*dac;\n\n\tu32\t\t\tflags;\n#define FFB_FLAG_AFB\t\t0x00000001  \n#define FFB_FLAG_BLANKED\t0x00000002  \n#define FFB_FLAG_INVCURSOR\t0x00000004  \n\n\tu32\t\t\tfg_cache __attribute__((aligned (8)));\n\tu32\t\t\tbg_cache;\n\tu32\t\t\trop_cache;\n\n\tint\t\t\tfifo_cache;\n\n\tunsigned long\t\tphysbase;\n\tunsigned long\t\tfbsize;\n\n\tint\t\t\tboard_type;\n\n\tu32\t\t\tpseudo_palette[16];\n};\n\nstatic void FFBFifo(struct ffb_par *par, int n)\n{\n\tstruct ffb_fbc __iomem *fbc;\n\tint cache = par->fifo_cache;\n\n\tif (cache - n < 0) {\n\t\tfbc = par->fbc;\n\t\tdo {\n\t\t\tcache = (upa_readl(&fbc->ucsr) & FFB_UCSR_FIFO_MASK);\n\t\t\tcache -= 8;\n\t\t} while (cache - n < 0);\n\t}\n\tpar->fifo_cache = cache - n;\n}\n\nstatic void FFBWait(struct ffb_par *par)\n{\n\tstruct ffb_fbc __iomem *fbc;\n\tint limit = 10000;\n\n\tfbc = par->fbc;\n\tdo {\n\t\tif ((upa_readl(&fbc->ucsr) & FFB_UCSR_ALL_BUSY) == 0)\n\t\t\tbreak;\n\t\tif ((upa_readl(&fbc->ucsr) & FFB_UCSR_ALL_ERRORS) != 0) {\n\t\t\tupa_writel(FFB_UCSR_ALL_ERRORS, &fbc->ucsr);\n\t\t}\n\t\tudelay(10);\n\t} while (--limit > 0);\n}\n\nstatic int ffb_sync(struct fb_info *p)\n{\n\tstruct ffb_par *par = (struct ffb_par *)p->par;\n\n\tFFBWait(par);\n\treturn 0;\n}\n\nstatic __inline__ void ffb_rop(struct ffb_par *par, u32 rop)\n{\n\tif (par->rop_cache != rop) {\n\t\tFFBFifo(par, 1);\n\t\tupa_writel(rop, &par->fbc->rop);\n\t\tpar->rop_cache = rop;\n\t}\n}\n\nstatic void ffb_switch_from_graph(struct ffb_par *par)\n{\n\tstruct ffb_fbc __iomem *fbc = par->fbc;\n\tstruct ffb_dac __iomem *dac = par->dac;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&par->lock, flags);\n\tFFBWait(par);\n\tpar->fifo_cache = 0;\n\tFFBFifo(par, 7);\n\tupa_writel(FFB_PPC_VCE_DISABLE | FFB_PPC_TBE_OPAQUE |\n\t\t   FFB_PPC_APE_DISABLE | FFB_PPC_CS_CONST,\n\t\t   &fbc->ppc);\n\tupa_writel(0x2000707f, &fbc->fbc);\n\tupa_writel(par->rop_cache, &fbc->rop);\n\tupa_writel(0xffffffff, &fbc->pmask);\n\tupa_writel((1 << 16) | (0 << 0), &fbc->fontinc);\n\tupa_writel(par->fg_cache, &fbc->fg);\n\tupa_writel(par->bg_cache, &fbc->bg);\n\tFFBWait(par);\n\n\t \n\tupa_writel(FFB_DAC_CUR_CTRL, &dac->type2);\n\tif (par->flags & FFB_FLAG_INVCURSOR)\n\t\tupa_writel(0, &dac->value2);\n\telse\n\t\tupa_writel((FFB_DAC_CUR_CTRL_P0 |\n\t\t\t    FFB_DAC_CUR_CTRL_P1), &dac->value2);\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n}\n\nstatic int ffb_pan_display(struct fb_var_screeninfo *var, struct fb_info *info)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\n\t \n\tffb_switch_from_graph(par);\n\n\tif (var->xoffset || var->yoffset || var->vmode)\n\t\treturn -EINVAL;\n\treturn 0;\n}\n\n \nstatic void ffb_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\tstruct ffb_fbc __iomem *fbc = par->fbc;\n\tunsigned long flags;\n\tu32 fg;\n\n\tBUG_ON(rect->rop != ROP_COPY && rect->rop != ROP_XOR);\n\n\tfg = ((u32 *)info->pseudo_palette)[rect->color];\n\n\tspin_lock_irqsave(&par->lock, flags);\n\n\tif (fg != par->fg_cache) {\n\t\tFFBFifo(par, 1);\n\t\tupa_writel(fg, &fbc->fg);\n\t\tpar->fg_cache = fg;\n\t}\n\n\tffb_rop(par, rect->rop == ROP_COPY ?\n\t\t     FFB_ROP_NEW :\n\t\t     FFB_ROP_NEW_XOR_OLD);\n\n\tFFBFifo(par, 5);\n\tupa_writel(FFB_DRAWOP_RECTANGLE, &fbc->drawop);\n\tupa_writel(rect->dy, &fbc->by);\n\tupa_writel(rect->dx, &fbc->bx);\n\tupa_writel(rect->height, &fbc->bh);\n\tupa_writel(rect->width, &fbc->bw);\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n}\n\n \n\nstatic void ffb_copyarea(struct fb_info *info, const struct fb_copyarea *area)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\tstruct ffb_fbc __iomem *fbc = par->fbc;\n\tunsigned long flags;\n\n\tif (area->dx != area->sx ||\n\t    area->dy == area->sy) {\n\t\tcfb_copyarea(info, area);\n\t\treturn;\n\t}\n\n\tspin_lock_irqsave(&par->lock, flags);\n\n\tffb_rop(par, FFB_ROP_OLD);\n\n\tFFBFifo(par, 7);\n\tupa_writel(FFB_DRAWOP_VSCROLL, &fbc->drawop);\n\tupa_writel(area->sy, &fbc->by);\n\tupa_writel(area->sx, &fbc->bx);\n\tupa_writel(area->dy, &fbc->dy);\n\tupa_writel(area->dx, &fbc->dx);\n\tupa_writel(area->height, &fbc->bh);\n\tupa_writel(area->width, &fbc->bw);\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n}\n\n \nstatic void ffb_imageblit(struct fb_info *info, const struct fb_image *image)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\tstruct ffb_fbc __iomem *fbc = par->fbc;\n\tconst u8 *data = image->data;\n\tunsigned long flags;\n\tu32 fg, bg, xy;\n\tu64 fgbg;\n\tint i, width, stride;\n\n\tif (image->depth > 1) {\n\t\tcfb_imageblit(info, image);\n\t\treturn;\n\t}\n\n\tfg = ((u32 *)info->pseudo_palette)[image->fg_color];\n\tbg = ((u32 *)info->pseudo_palette)[image->bg_color];\n\tfgbg = ((u64) fg << 32) | (u64) bg;\n\txy = (image->dy << 16) | image->dx;\n\twidth = image->width;\n\tstride = ((width + 7) >> 3);\n\n\tspin_lock_irqsave(&par->lock, flags);\n\n\tif (fgbg != *(u64 *)&par->fg_cache) {\n\t\tFFBFifo(par, 2);\n\t\tupa_writeq(fgbg, &fbc->fg);\n\t\t*(u64 *)&par->fg_cache = fgbg;\n\t}\n\n\tif (width >= 32) {\n\t\tFFBFifo(par, 1);\n\t\tupa_writel(32, &fbc->fontw);\n\t}\n\n\twhile (width >= 32) {\n\t\tconst u8 *next_data = data + 4;\n\n\t\tFFBFifo(par, 1);\n\t\tupa_writel(xy, &fbc->fontxy);\n\t\txy += (32 << 0);\n\n\t\tfor (i = 0; i < image->height; i++) {\n\t\t\tu32 val = (((u32)data[0] << 24) |\n\t\t\t\t   ((u32)data[1] << 16) |\n\t\t\t\t   ((u32)data[2] <<  8) |\n\t\t\t\t   ((u32)data[3] <<  0));\n\t\t\tFFBFifo(par, 1);\n\t\t\tupa_writel(val, &fbc->font);\n\n\t\t\tdata += stride;\n\t\t}\n\n\t\tdata = next_data;\n\t\twidth -= 32;\n\t}\n\n\tif (width) {\n\t\tFFBFifo(par, 2);\n\t\tupa_writel(width, &fbc->fontw);\n\t\tupa_writel(xy, &fbc->fontxy);\n\n\t\tfor (i = 0; i < image->height; i++) {\n\t\t\tu32 val = (((u32)data[0] << 24) |\n\t\t\t\t   ((u32)data[1] << 16) |\n\t\t\t\t   ((u32)data[2] <<  8) |\n\t\t\t\t   ((u32)data[3] <<  0));\n\t\t\tFFBFifo(par, 1);\n\t\t\tupa_writel(val, &fbc->font);\n\n\t\t\tdata += stride;\n\t\t}\n\t}\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n}\n\nstatic void ffb_fixup_var_rgb(struct fb_var_screeninfo *var)\n{\n\tvar->red.offset = 0;\n\tvar->red.length = 8;\n\tvar->green.offset = 8;\n\tvar->green.length = 8;\n\tvar->blue.offset = 16;\n\tvar->blue.length = 8;\n\tvar->transp.offset = 0;\n\tvar->transp.length = 0;\n}\n\n \nstatic int ffb_setcolreg(unsigned regno,\n\t\t\t unsigned red, unsigned green, unsigned blue,\n\t\t\t unsigned transp, struct fb_info *info)\n{\n\tu32 value;\n\n\tif (regno >= 16)\n\t\treturn 1;\n\n\tred >>= 8;\n\tgreen >>= 8;\n\tblue >>= 8;\n\n\tvalue = (blue << 16) | (green << 8) | red;\n\t((u32 *)info->pseudo_palette)[regno] = value;\n\n\treturn 0;\n}\n\n \nstatic int ffb_blank(int blank, struct fb_info *info)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\tstruct ffb_dac __iomem *dac = par->dac;\n\tunsigned long flags;\n\tu32 val;\n\tint i;\n\n\tspin_lock_irqsave(&par->lock, flags);\n\n\tFFBWait(par);\n\n\tupa_writel(FFB_DAC_TGEN, &dac->type);\n\tval = upa_readl(&dac->value);\n\tswitch (blank) {\n\tcase FB_BLANK_UNBLANK:  \n\t\tval |= FFB_DAC_TGEN_VIDE;\n\t\tpar->flags &= ~FFB_FLAG_BLANKED;\n\t\tbreak;\n\n\tcase FB_BLANK_NORMAL:  \n\tcase FB_BLANK_VSYNC_SUSPEND:  \n\tcase FB_BLANK_HSYNC_SUSPEND:  \n\tcase FB_BLANK_POWERDOWN:  \n\t\tval &= ~FFB_DAC_TGEN_VIDE;\n\t\tpar->flags |= FFB_FLAG_BLANKED;\n\t\tbreak;\n\t}\n\tupa_writel(FFB_DAC_TGEN, &dac->type);\n\tupa_writel(val, &dac->value);\n\tfor (i = 0; i < 10; i++) {\n\t\tupa_writel(FFB_DAC_TGEN, &dac->type);\n\t\tupa_readl(&dac->value);\n\t}\n\n\tspin_unlock_irqrestore(&par->lock, flags);\n\n\treturn 0;\n}\n\nstatic struct sbus_mmap_map ffb_mmap_map[] = {\n\t{\n\t\t.voff\t= FFB_SFB8R_VOFF,\n\t\t.poff\t= FFB_SFB8R_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB8G_VOFF,\n\t\t.poff\t= FFB_SFB8G_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB8B_VOFF,\n\t\t.poff\t= FFB_SFB8B_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB8X_VOFF,\n\t\t.poff\t= FFB_SFB8X_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB32_VOFF,\n\t\t.poff\t= FFB_SFB32_POFF,\n\t\t.size\t= 0x1000000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB64_VOFF,\n\t\t.poff\t= FFB_SFB64_POFF,\n\t\t.size\t= 0x2000000\n\t},\n\t{\n\t\t.voff\t= FFB_FBC_REGS_VOFF,\n\t\t.poff\t= FFB_FBC_REGS_POFF,\n\t\t.size\t= 0x0002000\n\t},\n\t{\n\t\t.voff\t= FFB_BM_FBC_REGS_VOFF,\n\t\t.poff\t= FFB_BM_FBC_REGS_POFF,\n\t\t.size\t= 0x0002000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB8R_VOFF,\n\t\t.poff\t= FFB_DFB8R_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB8G_VOFF,\n\t\t.poff\t= FFB_DFB8G_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB8B_VOFF,\n\t\t.poff\t= FFB_DFB8B_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB8X_VOFF,\n\t\t.poff\t= FFB_DFB8X_POFF,\n\t\t.size\t= 0x0400000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB24_VOFF,\n\t\t.poff\t= FFB_DFB24_POFF,\n\t\t.size\t= 0x1000000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB32_VOFF,\n\t\t.poff\t= FFB_DFB32_POFF,\n\t\t.size\t= 0x1000000\n\t},\n\t{\n\t\t.voff\t= FFB_FBC_KREGS_VOFF,\n\t\t.poff\t= FFB_FBC_KREGS_POFF,\n\t\t.size\t= 0x0002000\n\t},\n\t{\n\t\t.voff\t= FFB_DAC_VOFF,\n\t\t.poff\t= FFB_DAC_POFF,\n\t\t.size\t= 0x0002000\n\t},\n\t{\n\t\t.voff\t= FFB_PROM_VOFF,\n\t\t.poff\t= FFB_PROM_POFF,\n\t\t.size\t= 0x0010000\n\t},\n\t{\n\t\t.voff\t= FFB_EXP_VOFF,\n\t\t.poff\t= FFB_EXP_POFF,\n\t\t.size\t= 0x0002000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB422A_VOFF,\n\t\t.poff\t= FFB_DFB422A_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB422AD_VOFF,\n\t\t.poff\t= FFB_DFB422AD_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB24B_VOFF,\n\t\t.poff\t= FFB_DFB24B_POFF,\n\t\t.size\t= 0x1000000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB422B_VOFF,\n\t\t.poff\t= FFB_DFB422B_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_DFB422BD_VOFF,\n\t\t.poff\t= FFB_DFB422BD_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB16Z_VOFF,\n\t\t.poff\t= FFB_SFB16Z_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB8Z_VOFF,\n\t\t.poff\t= FFB_SFB8Z_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB422_VOFF,\n\t\t.poff\t= FFB_SFB422_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{\n\t\t.voff\t= FFB_SFB422D_VOFF,\n\t\t.poff\t= FFB_SFB422D_POFF,\n\t\t.size\t= 0x0800000\n\t},\n\t{ .size = 0 }\n};\n\nstatic int ffb_mmap(struct fb_info *info, struct vm_area_struct *vma)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\n\treturn sbusfb_mmap_helper(ffb_mmap_map,\n\t\t\t\t  par->physbase, par->fbsize,\n\t\t\t\t  0, vma);\n}\n\nstatic int ffb_ioctl(struct fb_info *info, unsigned int cmd, unsigned long arg)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\n\treturn sbusfb_ioctl_helper(cmd, arg, info,\n\t\t\t\t   FBTYPE_CREATOR, 24, par->fbsize);\n}\n\n \n\nstatic void ffb_init_fix(struct fb_info *info)\n{\n\tstruct ffb_par *par = (struct ffb_par *)info->par;\n\tconst char *ffb_type_name;\n\n\tif (!(par->flags & FFB_FLAG_AFB)) {\n\t\tif ((par->board_type & 0x7) == 0x3)\n\t\t\tffb_type_name = \"Creator 3D\";\n\t\telse\n\t\t\tffb_type_name = \"Creator\";\n\t} else\n\t\tffb_type_name = \"Elite 3D\";\n\n\tstrscpy(info->fix.id, ffb_type_name, sizeof(info->fix.id));\n\n\tinfo->fix.type = FB_TYPE_PACKED_PIXELS;\n\tinfo->fix.visual = FB_VISUAL_TRUECOLOR;\n\n\t \n\tinfo->fix.line_length = 8192;\n\n\tinfo->fix.accel = FB_ACCEL_SUN_CREATOR;\n}\n\nstatic int ffb_probe(struct platform_device *op)\n{\n\tstruct device_node *dp = op->dev.of_node;\n\tstruct ffb_fbc __iomem *fbc;\n\tstruct ffb_dac __iomem *dac;\n\tstruct fb_info *info;\n\tstruct ffb_par *par;\n\tu32 dac_pnum, dac_rev, dac_mrev;\n\tint err;\n\n\tinfo = framebuffer_alloc(sizeof(struct ffb_par), &op->dev);\n\n\terr = -ENOMEM;\n\tif (!info)\n\t\tgoto out_err;\n\n\tpar = info->par;\n\n\tspin_lock_init(&par->lock);\n\tpar->fbc = of_ioremap(&op->resource[2], 0,\n\t\t\t      sizeof(struct ffb_fbc), \"ffb fbc\");\n\tif (!par->fbc)\n\t\tgoto out_release_fb;\n\n\tpar->dac = of_ioremap(&op->resource[1], 0,\n\t\t\t      sizeof(struct ffb_dac), \"ffb dac\");\n\tif (!par->dac)\n\t\tgoto out_unmap_fbc;\n\n\tpar->rop_cache = FFB_ROP_NEW;\n\tpar->physbase = op->resource[0].start;\n\n\t \n\tinfo->flags = ( \n\t\t       FBINFO_HWACCEL_FILLRECT |\n\t\t       FBINFO_HWACCEL_IMAGEBLIT);\n\n\tinfo->fbops = &ffb_ops;\n\n\tinfo->screen_base = (char *) par->physbase + FFB_DFB24_POFF;\n\tinfo->pseudo_palette = par->pseudo_palette;\n\n\tsbusfb_fill_var(&info->var, dp, 32);\n\tpar->fbsize = PAGE_ALIGN(info->var.xres * info->var.yres * 4);\n\tffb_fixup_var_rgb(&info->var);\n\n\tinfo->var.accel_flags = FB_ACCELF_TEXT;\n\n\tif (of_node_name_eq(dp, \"SUNW,afb\"))\n\t\tpar->flags |= FFB_FLAG_AFB;\n\n\tpar->board_type = of_getintprop_default(dp, \"board_type\", 0);\n\n\tfbc = par->fbc;\n\tif ((upa_readl(&fbc->ucsr) & FFB_UCSR_ALL_ERRORS) != 0)\n\t\tupa_writel(FFB_UCSR_ALL_ERRORS, &fbc->ucsr);\n\n\tdac = par->dac;\n\tupa_writel(FFB_DAC_DID, &dac->type);\n\tdac_pnum = upa_readl(&dac->value);\n\tdac_rev = (dac_pnum & FFB_DAC_DID_REV) >> FFB_DAC_DID_REV_SHIFT;\n\tdac_pnum = (dac_pnum & FFB_DAC_DID_PNUM) >> FFB_DAC_DID_PNUM_SHIFT;\n\n\tupa_writel(FFB_DAC_UCTRL, &dac->type);\n\tdac_mrev = upa_readl(&dac->value);\n\tdac_mrev = (dac_mrev & FFB_DAC_UCTRL_MANREV) >>\n\t\tFFB_DAC_UCTRL_MANREV_SHIFT;\n\n\t \n\tif ((par->flags & FFB_FLAG_AFB) || dac_pnum == 0x236e) {\n\t\tpar->flags &= ~FFB_FLAG_INVCURSOR;\n\t} else {\n\t\tif (dac_mrev < 3)\n\t\t\tpar->flags |= FFB_FLAG_INVCURSOR;\n\t}\n\n\tffb_switch_from_graph(par);\n\n\t \n\tffb_blank(FB_BLANK_UNBLANK, info);\n\n\tif (fb_alloc_cmap(&info->cmap, 256, 0))\n\t\tgoto out_unmap_dac;\n\n\tffb_init_fix(info);\n\n\terr = register_framebuffer(info);\n\tif (err < 0)\n\t\tgoto out_dealloc_cmap;\n\n\tdev_set_drvdata(&op->dev, info);\n\n\tprintk(KERN_INFO \"%pOF: %s at %016lx, type %d, \"\n\t       \"DAC pnum[%x] rev[%d] manuf_rev[%d]\\n\",\n\t       dp,\n\t       ((par->flags & FFB_FLAG_AFB) ? \"AFB\" : \"FFB\"),\n\t       par->physbase, par->board_type,\n\t       dac_pnum, dac_rev, dac_mrev);\n\n\treturn 0;\n\nout_dealloc_cmap:\n\tfb_dealloc_cmap(&info->cmap);\n\nout_unmap_dac:\n\tof_iounmap(&op->resource[1], par->dac, sizeof(struct ffb_dac));\n\nout_unmap_fbc:\n\tof_iounmap(&op->resource[2], par->fbc, sizeof(struct ffb_fbc));\n\nout_release_fb:\n\tframebuffer_release(info);\n\nout_err:\n\treturn err;\n}\n\nstatic void ffb_remove(struct platform_device *op)\n{\n\tstruct fb_info *info = dev_get_drvdata(&op->dev);\n\tstruct ffb_par *par = info->par;\n\n\tunregister_framebuffer(info);\n\tfb_dealloc_cmap(&info->cmap);\n\n\tof_iounmap(&op->resource[2], par->fbc, sizeof(struct ffb_fbc));\n\tof_iounmap(&op->resource[1], par->dac, sizeof(struct ffb_dac));\n\n\tframebuffer_release(info);\n}\n\nstatic const struct of_device_id ffb_match[] = {\n\t{\n\t\t.name = \"SUNW,ffb\",\n\t},\n\t{\n\t\t.name = \"SUNW,afb\",\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ffb_match);\n\nstatic struct platform_driver ffb_driver = {\n\t.driver = {\n\t\t.name = \"ffb\",\n\t\t.of_match_table = ffb_match,\n\t},\n\t.probe\t\t= ffb_probe,\n\t.remove_new\t= ffb_remove,\n};\n\nstatic int __init ffb_init(void)\n{\n\tif (fb_get_options(\"ffb\", NULL))\n\t\treturn -ENODEV;\n\n\treturn platform_driver_register(&ffb_driver);\n}\n\nstatic void __exit ffb_exit(void)\n{\n\tplatform_driver_unregister(&ffb_driver);\n}\n\nmodule_init(ffb_init);\nmodule_exit(ffb_exit);\n\nMODULE_DESCRIPTION(\"framebuffer driver for Creator/Elite3D chipsets\");\nMODULE_AUTHOR(\"David S. Miller <davem@davemloft.net>\");\nMODULE_VERSION(\"2.0\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}