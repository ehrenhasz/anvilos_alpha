{
  "module_name": "lcd_ams_delta.c",
  "hash_id": "03ce59ab681286b7e3e15d7daa92dc19ceaffc9b29d000849a37bfb799c4425c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/omap/lcd_ams_delta.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/io.h>\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/lcd.h>\n\n#include <linux/soc/ti/omap1-io.h>\n\n#include \"omapfb.h\"\n\n#define AMS_DELTA_DEFAULT_CONTRAST\t112\n\n#define AMS_DELTA_MAX_CONTRAST\t\t0x00FF\n#define AMS_DELTA_LCD_POWER\t\t0x0100\n\n\n \n\nstatic int ams_delta_lcd;\nstatic struct gpio_desc *gpiod_vblen;\nstatic struct gpio_desc *gpiod_ndisp;\n\nstatic int ams_delta_lcd_set_power(struct lcd_device *dev, int power)\n{\n\tif (power == FB_BLANK_UNBLANK) {\n\t\tif (!(ams_delta_lcd & AMS_DELTA_LCD_POWER)) {\n\t\t\tomap_writeb(ams_delta_lcd & AMS_DELTA_MAX_CONTRAST,\n\t\t\t\t\tOMAP_PWL_ENABLE);\n\t\t\tomap_writeb(1, OMAP_PWL_CLK_ENABLE);\n\t\t\tams_delta_lcd |= AMS_DELTA_LCD_POWER;\n\t\t}\n\t} else {\n\t\tif (ams_delta_lcd & AMS_DELTA_LCD_POWER) {\n\t\t\tomap_writeb(0, OMAP_PWL_ENABLE);\n\t\t\tomap_writeb(0, OMAP_PWL_CLK_ENABLE);\n\t\t\tams_delta_lcd &= ~AMS_DELTA_LCD_POWER;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int ams_delta_lcd_set_contrast(struct lcd_device *dev, int value)\n{\n\tif ((value >= 0) && (value <= AMS_DELTA_MAX_CONTRAST)) {\n\t\tomap_writeb(value, OMAP_PWL_ENABLE);\n\t\tams_delta_lcd &= ~AMS_DELTA_MAX_CONTRAST;\n\t\tams_delta_lcd |= value;\n\t}\n\treturn 0;\n}\n\n#ifdef CONFIG_LCD_CLASS_DEVICE\nstatic int ams_delta_lcd_get_power(struct lcd_device *dev)\n{\n\tif (ams_delta_lcd & AMS_DELTA_LCD_POWER)\n\t\treturn FB_BLANK_UNBLANK;\n\telse\n\t\treturn FB_BLANK_POWERDOWN;\n}\n\nstatic int ams_delta_lcd_get_contrast(struct lcd_device *dev)\n{\n\tif (!(ams_delta_lcd & AMS_DELTA_LCD_POWER))\n\t\treturn 0;\n\n\treturn ams_delta_lcd & AMS_DELTA_MAX_CONTRAST;\n}\n\nstatic struct lcd_ops ams_delta_lcd_ops = {\n\t.get_power = ams_delta_lcd_get_power,\n\t.set_power = ams_delta_lcd_set_power,\n\t.get_contrast = ams_delta_lcd_get_contrast,\n\t.set_contrast = ams_delta_lcd_set_contrast,\n};\n#endif\n\n\n \n\nstatic int ams_delta_panel_enable(struct lcd_panel *panel)\n{\n\tgpiod_set_value(gpiod_ndisp, 1);\n\tgpiod_set_value(gpiod_vblen, 1);\n\treturn 0;\n}\n\nstatic void ams_delta_panel_disable(struct lcd_panel *panel)\n{\n\tgpiod_set_value(gpiod_vblen, 0);\n\tgpiod_set_value(gpiod_ndisp, 0);\n}\n\nstatic struct lcd_panel ams_delta_panel = {\n\t.name\t\t= \"ams-delta\",\n\t.config\t\t= 0,\n\n\t.bpp\t\t= 12,\n\t.data_lines\t= 16,\n\t.x_res\t\t= 480,\n\t.y_res\t\t= 320,\n\t.pixel_clock\t= 4687,\n\t.hsw\t\t= 3,\n\t.hfp\t\t= 1,\n\t.hbp\t\t= 1,\n\t.vsw\t\t= 1,\n\t.vfp\t\t= 0,\n\t.vbp\t\t= 0,\n\t.pcd\t\t= 0,\n\t.acb\t\t= 37,\n\n\t.enable\t\t= ams_delta_panel_enable,\n\t.disable\t= ams_delta_panel_disable,\n};\n\n\n \n\nstatic int ams_delta_panel_probe(struct platform_device *pdev)\n{\n\tstruct lcd_device *lcd_device = NULL;\n\n\tgpiod_vblen = devm_gpiod_get(&pdev->dev, \"vblen\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpiod_vblen))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(gpiod_vblen),\n\t\t\t\t     \"VBLEN GPIO request failed\\n\");\n\n\tgpiod_ndisp = devm_gpiod_get(&pdev->dev, \"ndisp\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpiod_ndisp))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(gpiod_ndisp),\n\t\t\t\t     \"NDISP GPIO request failed\\n\");\n\n#ifdef CONFIG_LCD_CLASS_DEVICE\n\tlcd_device = lcd_device_register(\"omapfb\", &pdev->dev, NULL,\n\t\t\t\t\t\t&ams_delta_lcd_ops);\n\n\tif (IS_ERR(lcd_device)) {\n\t\tint ret = PTR_ERR(lcd_device);\n\n\t\tdev_err(&pdev->dev, \"failed to register device\\n\");\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, lcd_device);\n\tlcd_device->props.max_contrast = AMS_DELTA_MAX_CONTRAST;\n#endif\n\n\tams_delta_lcd_set_contrast(lcd_device, AMS_DELTA_DEFAULT_CONTRAST);\n\tams_delta_lcd_set_power(lcd_device, FB_BLANK_UNBLANK);\n\n\tomapfb_register_panel(&ams_delta_panel);\n\treturn 0;\n}\n\nstatic struct platform_driver ams_delta_panel_driver = {\n\t.probe\t\t= ams_delta_panel_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"lcd_ams_delta\",\n\t},\n};\n\nmodule_platform_driver(ams_delta_panel_driver);\n\nMODULE_AUTHOR(\"Jonathan McDowell <noodles@earth.li>\");\nMODULE_DESCRIPTION(\"LCD panel support for the Amstrad E3 (Delta) videophone\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}