{
  "module_name": "overlay.c",
  "hash_id": "0fdc7a8095af86bffb0055297444a10b0fccc667e1c9e6d37509485664defb92",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/omap2/omapfb/dss/overlay.c",
  "human_readable_source": "\n \n\n#define DSS_SUBSYS_NAME \"OVERLAY\"\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/sysfs.h>\n#include <linux/platform_device.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n\n#include <video/omapfb_dss.h>\n\n#include \"dss.h\"\n#include \"dss_features.h\"\n\nstatic int num_overlays;\nstatic struct omap_overlay *overlays;\n\nint omap_dss_get_num_overlays(void)\n{\n\treturn num_overlays;\n}\nEXPORT_SYMBOL(omap_dss_get_num_overlays);\n\nstruct omap_overlay *omap_dss_get_overlay(int num)\n{\n\tif (num >= num_overlays)\n\t\treturn NULL;\n\n\treturn &overlays[num];\n}\nEXPORT_SYMBOL(omap_dss_get_overlay);\n\nvoid dss_init_overlays(struct platform_device *pdev)\n{\n\tint i, r;\n\n\tnum_overlays = dss_feat_get_num_ovls();\n\n\toverlays = kcalloc(num_overlays, sizeof(struct omap_overlay),\n\t\t\t   GFP_KERNEL);\n\n\tBUG_ON(overlays == NULL);\n\n\tfor (i = 0; i < num_overlays; ++i) {\n\t\tstruct omap_overlay *ovl = &overlays[i];\n\n\t\tswitch (i) {\n\t\tcase 0:\n\t\t\tovl->name = \"gfx\";\n\t\t\tovl->id = OMAP_DSS_GFX;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tovl->name = \"vid1\";\n\t\t\tovl->id = OMAP_DSS_VIDEO1;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tovl->name = \"vid2\";\n\t\t\tovl->id = OMAP_DSS_VIDEO2;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tovl->name = \"vid3\";\n\t\t\tovl->id = OMAP_DSS_VIDEO3;\n\t\t\tbreak;\n\t\t}\n\n\t\tovl->caps = dss_feat_get_overlay_caps(ovl->id);\n\t\tovl->supported_modes =\n\t\t\tdss_feat_get_supported_color_modes(ovl->id);\n\n\t\tr = dss_overlay_kobj_init(ovl, pdev);\n\t\tif (r)\n\t\t\tDSSERR(\"failed to create sysfs file\\n\");\n\t}\n}\n\nvoid dss_uninit_overlays(struct platform_device *pdev)\n{\n\tint i;\n\n\tfor (i = 0; i < num_overlays; ++i) {\n\t\tstruct omap_overlay *ovl = &overlays[i];\n\t\tdss_overlay_kobj_uninit(ovl);\n\t}\n\n\tkfree(overlays);\n\toverlays = NULL;\n\tnum_overlays = 0;\n}\n\nint dss_ovl_simple_check(struct omap_overlay *ovl,\n\t\tconst struct omap_overlay_info *info)\n{\n\tif ((ovl->caps & OMAP_DSS_OVL_CAP_SCALE) == 0) {\n\t\tif (info->out_width != 0 && info->width != info->out_width) {\n\t\t\tDSSERR(\"check_overlay: overlay %d doesn't support \"\n\t\t\t\t\t\"scaling\\n\", ovl->id);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tif (info->out_height != 0 && info->height != info->out_height) {\n\t\t\tDSSERR(\"check_overlay: overlay %d doesn't support \"\n\t\t\t\t\t\"scaling\\n\", ovl->id);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif ((ovl->supported_modes & info->color_mode) == 0) {\n\t\tDSSERR(\"check_overlay: overlay %d doesn't support mode %d\\n\",\n\t\t\t\tovl->id, info->color_mode);\n\t\treturn -EINVAL;\n\t}\n\n\tif (info->zorder >= omap_dss_get_num_overlays()) {\n\t\tDSSERR(\"check_overlay: zorder %d too high\\n\", info->zorder);\n\t\treturn -EINVAL;\n\t}\n\n\tif (dss_feat_rotation_type_supported(info->rotation_type) == 0) {\n\t\tDSSERR(\"check_overlay: rotation type %d not supported\\n\",\n\t\t\t\tinfo->rotation_type);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nint dss_ovl_check(struct omap_overlay *ovl, struct omap_overlay_info *info,\n\t\tconst struct omap_video_timings *mgr_timings)\n{\n\tu16 outw, outh;\n\tu16 dw, dh;\n\n\tdw = mgr_timings->x_res;\n\tdh = mgr_timings->y_res;\n\n\tif ((ovl->caps & OMAP_DSS_OVL_CAP_SCALE) == 0) {\n\t\toutw = info->width;\n\t\touth = info->height;\n\t} else {\n\t\tif (info->out_width == 0)\n\t\t\toutw = info->width;\n\t\telse\n\t\t\toutw = info->out_width;\n\n\t\tif (info->out_height == 0)\n\t\t\touth = info->height;\n\t\telse\n\t\t\touth = info->out_height;\n\t}\n\n\tif (dw < info->pos_x + outw) {\n\t\tDSSERR(\"overlay %d horizontally not inside the display area \"\n\t\t\t\t\"(%d + %d >= %d)\\n\",\n\t\t\t\tovl->id, info->pos_x, outw, dw);\n\t\treturn -EINVAL;\n\t}\n\n\tif (dh < info->pos_y + outh) {\n\t\tDSSERR(\"overlay %d vertically not inside the display area \"\n\t\t\t\t\"(%d + %d >= %d)\\n\",\n\t\t\t\tovl->id, info->pos_y, outh, dh);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nbool dss_ovl_use_replication(struct dss_lcd_mgr_config config,\n\t\tenum omap_color_mode mode)\n{\n\tif (mode != OMAP_DSS_COLOR_RGB12U && mode != OMAP_DSS_COLOR_RGB16)\n\t\treturn false;\n\n\treturn config.video_port_width > 16;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}