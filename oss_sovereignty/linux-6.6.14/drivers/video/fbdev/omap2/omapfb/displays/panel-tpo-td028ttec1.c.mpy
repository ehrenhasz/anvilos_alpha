{
  "module_name": "panel-tpo-td028ttec1.c",
  "hash_id": "35475d5a5f2ee12aad30ce8bea31ce0f81842dbec89a0a3f7e2c7e1912534ef7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/omap2/omapfb/displays/panel-tpo-td028ttec1.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/spi/spi.h>\n#include <video/omapfb_dss.h>\n\nstruct panel_drv_data {\n\tstruct omap_dss_device dssdev;\n\tstruct omap_dss_device *in;\n\n\tint data_lines;\n\n\tstruct omap_video_timings videomode;\n\n\tstruct spi_device *spi_dev;\n};\n\nstatic const struct omap_video_timings td028ttec1_panel_timings = {\n\t.x_res\t\t= 480,\n\t.y_res\t\t= 640,\n\t.pixelclock\t= 22153000,\n\t.hfp\t\t= 24,\n\t.hsw\t\t= 8,\n\t.hbp\t\t= 8,\n\t.vfp\t\t= 4,\n\t.vsw\t\t= 2,\n\t.vbp\t\t= 2,\n\n\t.vsync_level\t= OMAPDSS_SIG_ACTIVE_LOW,\n\t.hsync_level\t= OMAPDSS_SIG_ACTIVE_LOW,\n\n\t.data_pclk_edge\t= OMAPDSS_DRIVE_SIG_FALLING_EDGE,\n\t.de_level\t= OMAPDSS_SIG_ACTIVE_HIGH,\n\t.sync_pclk_edge\t= OMAPDSS_DRIVE_SIG_RISING_EDGE,\n};\n\n#define JBT_COMMAND\t0x000\n#define JBT_DATA\t0x100\n\nstatic int jbt_ret_write_0(struct panel_drv_data *ddata, u8 reg)\n{\n\tint rc;\n\tu16 tx_buf = JBT_COMMAND | reg;\n\n\trc = spi_write(ddata->spi_dev, (u8 *)&tx_buf,\n\t\t\t1*sizeof(u16));\n\tif (rc != 0)\n\t\tdev_err(&ddata->spi_dev->dev,\n\t\t\t\"jbt_ret_write_0 spi_write ret %d\\n\", rc);\n\n\treturn rc;\n}\n\nstatic int jbt_reg_write_1(struct panel_drv_data *ddata, u8 reg, u8 data)\n{\n\tint rc;\n\tu16 tx_buf[2];\n\n\ttx_buf[0] = JBT_COMMAND | reg;\n\ttx_buf[1] = JBT_DATA | data;\n\trc = spi_write(ddata->spi_dev, (u8 *)tx_buf,\n\t\t\t2*sizeof(u16));\n\tif (rc != 0)\n\t\tdev_err(&ddata->spi_dev->dev,\n\t\t\t\"jbt_reg_write_1 spi_write ret %d\\n\", rc);\n\n\treturn rc;\n}\n\nstatic int jbt_reg_write_2(struct panel_drv_data *ddata, u8 reg, u16 data)\n{\n\tint rc;\n\tu16 tx_buf[3];\n\n\ttx_buf[0] = JBT_COMMAND | reg;\n\ttx_buf[1] = JBT_DATA | (data >> 8);\n\ttx_buf[2] = JBT_DATA | (data & 0xff);\n\n\trc = spi_write(ddata->spi_dev, (u8 *)tx_buf,\n\t\t\t3*sizeof(u16));\n\n\tif (rc != 0)\n\t\tdev_err(&ddata->spi_dev->dev,\n\t\t\t\"jbt_reg_write_2 spi_write ret %d\\n\", rc);\n\n\treturn rc;\n}\n\nenum jbt_register {\n\tJBT_REG_SLEEP_IN\t\t= 0x10,\n\tJBT_REG_SLEEP_OUT\t\t= 0x11,\n\n\tJBT_REG_DISPLAY_OFF\t\t= 0x28,\n\tJBT_REG_DISPLAY_ON\t\t= 0x29,\n\n\tJBT_REG_RGB_FORMAT\t\t= 0x3a,\n\tJBT_REG_QUAD_RATE\t\t= 0x3b,\n\n\tJBT_REG_POWER_ON_OFF\t\t= 0xb0,\n\tJBT_REG_BOOSTER_OP\t\t= 0xb1,\n\tJBT_REG_BOOSTER_MODE\t\t= 0xb2,\n\tJBT_REG_BOOSTER_FREQ\t\t= 0xb3,\n\tJBT_REG_OPAMP_SYSCLK\t\t= 0xb4,\n\tJBT_REG_VSC_VOLTAGE\t\t= 0xb5,\n\tJBT_REG_VCOM_VOLTAGE\t\t= 0xb6,\n\tJBT_REG_EXT_DISPL\t\t= 0xb7,\n\tJBT_REG_OUTPUT_CONTROL\t\t= 0xb8,\n\tJBT_REG_DCCLK_DCEV\t\t= 0xb9,\n\tJBT_REG_DISPLAY_MODE1\t\t= 0xba,\n\tJBT_REG_DISPLAY_MODE2\t\t= 0xbb,\n\tJBT_REG_DISPLAY_MODE\t\t= 0xbc,\n\tJBT_REG_ASW_SLEW\t\t= 0xbd,\n\tJBT_REG_DUMMY_DISPLAY\t\t= 0xbe,\n\tJBT_REG_DRIVE_SYSTEM\t\t= 0xbf,\n\n\tJBT_REG_SLEEP_OUT_FR_A\t\t= 0xc0,\n\tJBT_REG_SLEEP_OUT_FR_B\t\t= 0xc1,\n\tJBT_REG_SLEEP_OUT_FR_C\t\t= 0xc2,\n\tJBT_REG_SLEEP_IN_LCCNT_D\t= 0xc3,\n\tJBT_REG_SLEEP_IN_LCCNT_E\t= 0xc4,\n\tJBT_REG_SLEEP_IN_LCCNT_F\t= 0xc5,\n\tJBT_REG_SLEEP_IN_LCCNT_G\t= 0xc6,\n\n\tJBT_REG_GAMMA1_FINE_1\t\t= 0xc7,\n\tJBT_REG_GAMMA1_FINE_2\t\t= 0xc8,\n\tJBT_REG_GAMMA1_INCLINATION\t= 0xc9,\n\tJBT_REG_GAMMA1_BLUE_OFFSET\t= 0xca,\n\n\tJBT_REG_BLANK_CONTROL\t\t= 0xcf,\n\tJBT_REG_BLANK_TH_TV\t\t= 0xd0,\n\tJBT_REG_CKV_ON_OFF\t\t= 0xd1,\n\tJBT_REG_CKV_1_2\t\t\t= 0xd2,\n\tJBT_REG_OEV_TIMING\t\t= 0xd3,\n\tJBT_REG_ASW_TIMING_1\t\t= 0xd4,\n\tJBT_REG_ASW_TIMING_2\t\t= 0xd5,\n\n\tJBT_REG_HCLOCK_VGA\t\t= 0xec,\n\tJBT_REG_HCLOCK_QVGA\t\t= 0xed,\n};\n\n#define to_panel_data(p) container_of(p, struct panel_drv_data, dssdev)\n\nstatic int td028ttec1_panel_connect(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\tint r;\n\n\tif (omapdss_device_is_connected(dssdev))\n\t\treturn 0;\n\n\tr = in->ops.dpi->connect(in, dssdev);\n\tif (r)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic void td028ttec1_panel_disconnect(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\tif (!omapdss_device_is_connected(dssdev))\n\t\treturn;\n\n\tin->ops.dpi->disconnect(in, dssdev);\n}\n\nstatic int td028ttec1_panel_enable(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\tint r;\n\n\tif (!omapdss_device_is_connected(dssdev))\n\t\treturn -ENODEV;\n\n\tif (omapdss_device_is_enabled(dssdev))\n\t\treturn 0;\n\n\tif (ddata->data_lines)\n\t\tin->ops.dpi->set_data_lines(in, ddata->data_lines);\n\tin->ops.dpi->set_timings(in, &ddata->videomode);\n\n\tr = in->ops.dpi->enable(in);\n\tif (r)\n\t\treturn r;\n\n\tdev_dbg(dssdev->dev, \"td028ttec1_panel_enable() - state %d\\n\",\n\t\tdssdev->state);\n\n\t \n\tr |= jbt_ret_write_0(ddata, 0x00);\n\tusleep_range(1000, 2000);\n\tr |= jbt_ret_write_0(ddata, 0x00);\n\tusleep_range(1000, 2000);\n\tr |= jbt_ret_write_0(ddata, 0x00);\n\tusleep_range(1000, 2000);\n\n\tif (r) {\n\t\tdev_warn(dssdev->dev, \"transfer error\\n\");\n\t\tgoto transfer_err;\n\t}\n\n\t \n\tr |= jbt_reg_write_1(ddata, JBT_REG_POWER_ON_OFF, 0x17);\n\n\t \n\tr |= jbt_reg_write_1(ddata, JBT_REG_DISPLAY_MODE, 0x80);\n\n\t \n\tr |= jbt_reg_write_1(ddata, JBT_REG_QUAD_RATE, 0x00);\n\n\t \n\tr |= jbt_reg_write_1(ddata, JBT_REG_POWER_ON_OFF, 0x16);\n\n\t \n\tr |= jbt_reg_write_2(ddata, JBT_REG_OUTPUT_CONTROL, 0xfff9);\n\n\t \n\tr |= jbt_ret_write_0(ddata, JBT_REG_SLEEP_OUT);\n\n\t \n\n\t \n\tr |= jbt_reg_write_1(ddata, JBT_REG_DISPLAY_MODE1, 0x01);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_DISPLAY_MODE2, 0x00);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_RGB_FORMAT, 0x60);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_DRIVE_SYSTEM, 0x10);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_BOOSTER_OP, 0x56);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_BOOSTER_MODE, 0x33);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_BOOSTER_FREQ, 0x11);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_BOOSTER_FREQ, 0x11);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_OPAMP_SYSCLK, 0x02);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_VSC_VOLTAGE, 0x2b);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_VCOM_VOLTAGE, 0x40);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_EXT_DISPL, 0x03);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_DCCLK_DCEV, 0x04);\n\t \n\tr |= jbt_reg_write_1(ddata, JBT_REG_ASW_SLEW, 0x04);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_DUMMY_DISPLAY, 0x00);\n\n\tr |= jbt_reg_write_1(ddata, JBT_REG_SLEEP_OUT_FR_A, 0x11);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_SLEEP_OUT_FR_B, 0x11);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_SLEEP_OUT_FR_C, 0x11);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_SLEEP_IN_LCCNT_D, 0x2040);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_SLEEP_IN_LCCNT_E, 0x60c0);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_SLEEP_IN_LCCNT_F, 0x1020);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_SLEEP_IN_LCCNT_G, 0x60c0);\n\n\tr |= jbt_reg_write_2(ddata, JBT_REG_GAMMA1_FINE_1, 0x5533);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_GAMMA1_FINE_2, 0x00);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_GAMMA1_INCLINATION, 0x00);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_GAMMA1_BLUE_OFFSET, 0x00);\n\n\tr |= jbt_reg_write_2(ddata, JBT_REG_HCLOCK_VGA, 0x1f0);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_BLANK_CONTROL, 0x02);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_BLANK_TH_TV, 0x0804);\n\n\tr |= jbt_reg_write_1(ddata, JBT_REG_CKV_ON_OFF, 0x01);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_CKV_1_2, 0x0000);\n\n\tr |= jbt_reg_write_2(ddata, JBT_REG_OEV_TIMING, 0x0d0e);\n\tr |= jbt_reg_write_2(ddata, JBT_REG_ASW_TIMING_1, 0x11a4);\n\tr |= jbt_reg_write_1(ddata, JBT_REG_ASW_TIMING_2, 0x0e);\n\n\tr |= jbt_ret_write_0(ddata, JBT_REG_DISPLAY_ON);\n\n\tdssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\n\ntransfer_err:\n\n\treturn r ? -EIO : 0;\n}\n\nstatic void td028ttec1_panel_disable(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\tif (!omapdss_device_is_enabled(dssdev))\n\t\treturn;\n\n\tdev_dbg(dssdev->dev, \"td028ttec1_panel_disable()\\n\");\n\n\tjbt_ret_write_0(ddata, JBT_REG_DISPLAY_OFF);\n\tjbt_reg_write_2(ddata, JBT_REG_OUTPUT_CONTROL, 0x8002);\n\tjbt_ret_write_0(ddata, JBT_REG_SLEEP_IN);\n\tjbt_reg_write_1(ddata, JBT_REG_POWER_ON_OFF, 0x00);\n\n\tin->ops.dpi->disable(in);\n\n\tdssdev->state = OMAP_DSS_DISPLAY_DISABLED;\n}\n\nstatic void td028ttec1_panel_set_timings(struct omap_dss_device *dssdev,\n\t\tstruct omap_video_timings *timings)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\tddata->videomode = *timings;\n\tdssdev->panel.timings = *timings;\n\n\tin->ops.dpi->set_timings(in, timings);\n}\n\nstatic void td028ttec1_panel_get_timings(struct omap_dss_device *dssdev,\n\t\tstruct omap_video_timings *timings)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\n\t*timings = ddata->videomode;\n}\n\nstatic int td028ttec1_panel_check_timings(struct omap_dss_device *dssdev,\n\t\tstruct omap_video_timings *timings)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\treturn in->ops.dpi->check_timings(in, timings);\n}\n\nstatic struct omap_dss_driver td028ttec1_ops = {\n\t.connect\t= td028ttec1_panel_connect,\n\t.disconnect\t= td028ttec1_panel_disconnect,\n\n\t.enable\t\t= td028ttec1_panel_enable,\n\t.disable\t= td028ttec1_panel_disable,\n\n\t.set_timings\t= td028ttec1_panel_set_timings,\n\t.get_timings\t= td028ttec1_panel_get_timings,\n\t.check_timings\t= td028ttec1_panel_check_timings,\n};\n\nstatic int td028ttec1_probe_of(struct spi_device *spi)\n{\n\tstruct device_node *node = spi->dev.of_node;\n\tstruct panel_drv_data *ddata = dev_get_drvdata(&spi->dev);\n\tstruct omap_dss_device *in;\n\n\tin = omapdss_of_find_source_for_first_ep(node);\n\tif (IS_ERR(in)) {\n\t\tdev_err(&spi->dev, \"failed to find video source\\n\");\n\t\treturn PTR_ERR(in);\n\t}\n\n\tddata->in = in;\n\n\treturn 0;\n}\n\nstatic int td028ttec1_panel_probe(struct spi_device *spi)\n{\n\tstruct panel_drv_data *ddata;\n\tstruct omap_dss_device *dssdev;\n\tint r;\n\n\tdev_dbg(&spi->dev, \"%s\\n\", __func__);\n\n\tif (!spi->dev.of_node)\n\t\treturn -ENODEV;\n\n\tspi->bits_per_word = 9;\n\tspi->mode = SPI_MODE_3;\n\n\tr = spi_setup(spi);\n\tif (r < 0) {\n\t\tdev_err(&spi->dev, \"spi_setup failed: %d\\n\", r);\n\t\treturn r;\n\t}\n\n\tddata = devm_kzalloc(&spi->dev, sizeof(*ddata), GFP_KERNEL);\n\tif (ddata == NULL)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&spi->dev, ddata);\n\n\tddata->spi_dev = spi;\n\n\tr = td028ttec1_probe_of(spi);\n\tif (r)\n\t\treturn r;\n\n\tddata->videomode = td028ttec1_panel_timings;\n\n\tdssdev = &ddata->dssdev;\n\tdssdev->dev = &spi->dev;\n\tdssdev->driver = &td028ttec1_ops;\n\tdssdev->type = OMAP_DISPLAY_TYPE_DPI;\n\tdssdev->owner = THIS_MODULE;\n\tdssdev->panel.timings = ddata->videomode;\n\tdssdev->phy.dpi.data_lines = ddata->data_lines;\n\n\tr = omapdss_register_display(dssdev);\n\tif (r) {\n\t\tdev_err(&spi->dev, \"Failed to register panel\\n\");\n\t\tgoto err_reg;\n\t}\n\n\treturn 0;\n\nerr_reg:\n\tomap_dss_put_device(ddata->in);\n\treturn r;\n}\n\nstatic void td028ttec1_panel_remove(struct spi_device *spi)\n{\n\tstruct panel_drv_data *ddata = dev_get_drvdata(&spi->dev);\n\tstruct omap_dss_device *dssdev = &ddata->dssdev;\n\tstruct omap_dss_device *in = ddata->in;\n\n\tdev_dbg(&ddata->spi_dev->dev, \"%s\\n\", __func__);\n\n\tomapdss_unregister_display(dssdev);\n\n\ttd028ttec1_panel_disable(dssdev);\n\ttd028ttec1_panel_disconnect(dssdev);\n\n\tomap_dss_put_device(in);\n}\n\nstatic const struct of_device_id td028ttec1_of_match[] = {\n\t{ .compatible = \"omapdss,tpo,td028ttec1\", },\n\t \n\t{ .compatible = \"omapdss,toppoly,td028ttec1\", },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(of, td028ttec1_of_match);\n\nstatic const struct spi_device_id td028ttec1_ids[] = {\n\t{ \"toppoly,td028ttec1\", 0 },\n\t{ \"tpo,td028ttec1\", 0},\n\t{   }\n};\n\nMODULE_DEVICE_TABLE(spi, td028ttec1_ids);\n\nstatic struct spi_driver td028ttec1_spi_driver = {\n\t.probe\t\t= td028ttec1_panel_probe,\n\t.remove\t\t= td028ttec1_panel_remove,\n\t.id_table\t= td028ttec1_ids,\n\n\t.driver         = {\n\t\t.name   = \"panel-tpo-td028ttec1\",\n\t\t.of_match_table = td028ttec1_of_match,\n\t\t.suppress_bind_attrs = true,\n\t},\n};\n\nmodule_spi_driver(td028ttec1_spi_driver);\n\nMODULE_AUTHOR(\"H. Nikolaus Schaller <hns@goldelico.com>\");\nMODULE_DESCRIPTION(\"Toppoly TD028TTEC1 panel driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}