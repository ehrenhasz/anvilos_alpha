{
  "module_name": "panel-lgphilips-lb035q02.c",
  "hash_id": "3e88b6acf628a299764ccd251ab6b2a2fbdbeecd96e4618903cda272a67290a6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/omap2/omapfb/displays/panel-lgphilips-lb035q02.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/spi/spi.h>\n#include <linux/mutex.h>\n#include <linux/gpio/consumer.h>\n\n#include <video/omapfb_dss.h>\n\nstatic const struct omap_video_timings lb035q02_timings = {\n\t.x_res = 320,\n\t.y_res = 240,\n\n\t.pixelclock\t= 6500000,\n\n\t.hsw\t\t= 2,\n\t.hfp\t\t= 20,\n\t.hbp\t\t= 68,\n\n\t.vsw\t\t= 2,\n\t.vfp\t\t= 4,\n\t.vbp\t\t= 18,\n\n\t.vsync_level\t= OMAPDSS_SIG_ACTIVE_LOW,\n\t.hsync_level\t= OMAPDSS_SIG_ACTIVE_LOW,\n\t.data_pclk_edge\t= OMAPDSS_DRIVE_SIG_RISING_EDGE,\n\t.de_level\t= OMAPDSS_SIG_ACTIVE_HIGH,\n\t.sync_pclk_edge\t= OMAPDSS_DRIVE_SIG_FALLING_EDGE,\n};\n\nstruct panel_drv_data {\n\tstruct omap_dss_device dssdev;\n\tstruct omap_dss_device *in;\n\n\tstruct spi_device *spi;\n\n\tint data_lines;\n\n\tstruct omap_video_timings videomode;\n\n\tstruct gpio_desc *enable_gpio;\n};\n\n#define to_panel_data(p) container_of(p, struct panel_drv_data, dssdev)\n\nstatic int lb035q02_write_reg(struct spi_device *spi, u8 reg, u16 val)\n{\n\tstruct spi_message msg;\n\tstruct spi_transfer index_xfer = {\n\t\t.len\t\t= 3,\n\t\t.cs_change\t= 1,\n\t};\n\tstruct spi_transfer value_xfer = {\n\t\t.len\t\t= 3,\n\t};\n\tu8\tbuffer[16];\n\n\tspi_message_init(&msg);\n\n\t \n\tbuffer[0] = 0x70;\n\tbuffer[1] = 0x00;\n\tbuffer[2] = reg & 0x7f;\n\tindex_xfer.tx_buf = buffer;\n\tspi_message_add_tail(&index_xfer, &msg);\n\n\t \n\tbuffer[4] = 0x72;\n\tbuffer[5] = val >> 8;\n\tbuffer[6] = val;\n\tvalue_xfer.tx_buf = buffer + 4;\n\tspi_message_add_tail(&value_xfer, &msg);\n\n\treturn spi_sync(spi, &msg);\n}\n\nstatic void init_lb035q02_panel(struct spi_device *spi)\n{\n\t \n\tlb035q02_write_reg(spi, 0x01, 0x6300);\n\tlb035q02_write_reg(spi, 0x02, 0x0200);\n\tlb035q02_write_reg(spi, 0x03, 0x0177);\n\tlb035q02_write_reg(spi, 0x04, 0x04c7);\n\tlb035q02_write_reg(spi, 0x05, 0xffc0);\n\tlb035q02_write_reg(spi, 0x06, 0xe806);\n\tlb035q02_write_reg(spi, 0x0a, 0x4008);\n\tlb035q02_write_reg(spi, 0x0b, 0x0000);\n\tlb035q02_write_reg(spi, 0x0d, 0x0030);\n\tlb035q02_write_reg(spi, 0x0e, 0x2800);\n\tlb035q02_write_reg(spi, 0x0f, 0x0000);\n\tlb035q02_write_reg(spi, 0x16, 0x9f80);\n\tlb035q02_write_reg(spi, 0x17, 0x0a0f);\n\tlb035q02_write_reg(spi, 0x1e, 0x00c1);\n\tlb035q02_write_reg(spi, 0x30, 0x0300);\n\tlb035q02_write_reg(spi, 0x31, 0x0007);\n\tlb035q02_write_reg(spi, 0x32, 0x0000);\n\tlb035q02_write_reg(spi, 0x33, 0x0000);\n\tlb035q02_write_reg(spi, 0x34, 0x0707);\n\tlb035q02_write_reg(spi, 0x35, 0x0004);\n\tlb035q02_write_reg(spi, 0x36, 0x0302);\n\tlb035q02_write_reg(spi, 0x37, 0x0202);\n\tlb035q02_write_reg(spi, 0x3a, 0x0a0d);\n\tlb035q02_write_reg(spi, 0x3b, 0x0806);\n}\n\nstatic int lb035q02_connect(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\tint r;\n\n\tif (omapdss_device_is_connected(dssdev))\n\t\treturn 0;\n\n\tr = in->ops.dpi->connect(in, dssdev);\n\tif (r)\n\t\treturn r;\n\n\tinit_lb035q02_panel(ddata->spi);\n\n\treturn 0;\n}\n\nstatic void lb035q02_disconnect(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\tif (!omapdss_device_is_connected(dssdev))\n\t\treturn;\n\n\tin->ops.dpi->disconnect(in, dssdev);\n}\n\nstatic int lb035q02_enable(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\tint r;\n\n\tif (!omapdss_device_is_connected(dssdev))\n\t\treturn -ENODEV;\n\n\tif (omapdss_device_is_enabled(dssdev))\n\t\treturn 0;\n\n\tif (ddata->data_lines)\n\t\tin->ops.dpi->set_data_lines(in, ddata->data_lines);\n\tin->ops.dpi->set_timings(in, &ddata->videomode);\n\n\tr = in->ops.dpi->enable(in);\n\tif (r)\n\t\treturn r;\n\n\tif (ddata->enable_gpio)\n\t\tgpiod_set_value_cansleep(ddata->enable_gpio, 1);\n\n\tdssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\n\n\treturn 0;\n}\n\nstatic void lb035q02_disable(struct omap_dss_device *dssdev)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\tif (!omapdss_device_is_enabled(dssdev))\n\t\treturn;\n\n\tif (ddata->enable_gpio)\n\t\tgpiod_set_value_cansleep(ddata->enable_gpio, 0);\n\n\tin->ops.dpi->disable(in);\n\n\tdssdev->state = OMAP_DSS_DISPLAY_DISABLED;\n}\n\nstatic void lb035q02_set_timings(struct omap_dss_device *dssdev,\n\t\tstruct omap_video_timings *timings)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\tddata->videomode = *timings;\n\tdssdev->panel.timings = *timings;\n\n\tin->ops.dpi->set_timings(in, timings);\n}\n\nstatic void lb035q02_get_timings(struct omap_dss_device *dssdev,\n\t\tstruct omap_video_timings *timings)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\n\t*timings = ddata->videomode;\n}\n\nstatic int lb035q02_check_timings(struct omap_dss_device *dssdev,\n\t\tstruct omap_video_timings *timings)\n{\n\tstruct panel_drv_data *ddata = to_panel_data(dssdev);\n\tstruct omap_dss_device *in = ddata->in;\n\n\treturn in->ops.dpi->check_timings(in, timings);\n}\n\nstatic struct omap_dss_driver lb035q02_ops = {\n\t.connect\t= lb035q02_connect,\n\t.disconnect\t= lb035q02_disconnect,\n\n\t.enable\t\t= lb035q02_enable,\n\t.disable\t= lb035q02_disable,\n\n\t.set_timings\t= lb035q02_set_timings,\n\t.get_timings\t= lb035q02_get_timings,\n\t.check_timings\t= lb035q02_check_timings,\n\n\t.get_resolution\t= omapdss_default_get_resolution,\n};\n\nstatic int lb035q02_probe_of(struct spi_device *spi)\n{\n\tstruct device_node *node = spi->dev.of_node;\n\tstruct panel_drv_data *ddata = spi_get_drvdata(spi);\n\tstruct omap_dss_device *in;\n\tstruct gpio_desc *gpio;\n\n\tgpio = devm_gpiod_get(&spi->dev, \"enable\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpio))\n\t\treturn dev_err_probe(&spi->dev, PTR_ERR(gpio),\n\t\t\t\t     \"failed to parse enable gpio\\n\");\n\n\tddata->enable_gpio = gpio;\n\n\tin = omapdss_of_find_source_for_first_ep(node);\n\tif (IS_ERR(in)) {\n\t\tdev_err(&spi->dev, \"failed to find video source\\n\");\n\t\treturn PTR_ERR(in);\n\t}\n\n\tddata->in = in;\n\n\treturn 0;\n}\n\nstatic int lb035q02_panel_spi_probe(struct spi_device *spi)\n{\n\tstruct panel_drv_data *ddata;\n\tstruct omap_dss_device *dssdev;\n\tint r;\n\n\tif (!spi->dev.of_node)\n\t\treturn -ENODEV;\n\n\tddata = devm_kzalloc(&spi->dev, sizeof(*ddata), GFP_KERNEL);\n\tif (ddata == NULL)\n\t\treturn -ENOMEM;\n\n\tspi_set_drvdata(spi, ddata);\n\n\tddata->spi = spi;\n\n\tr = lb035q02_probe_of(spi);\n\tif (r)\n\t\treturn r;\n\n\tddata->videomode = lb035q02_timings;\n\n\tdssdev = &ddata->dssdev;\n\tdssdev->dev = &spi->dev;\n\tdssdev->driver = &lb035q02_ops;\n\tdssdev->type = OMAP_DISPLAY_TYPE_DPI;\n\tdssdev->owner = THIS_MODULE;\n\tdssdev->panel.timings = ddata->videomode;\n\tdssdev->phy.dpi.data_lines = ddata->data_lines;\n\n\tr = omapdss_register_display(dssdev);\n\tif (r) {\n\t\tdev_err(&spi->dev, \"Failed to register panel\\n\");\n\t\tgoto err_reg;\n\t}\n\n\treturn 0;\n\nerr_reg:\n\tomap_dss_put_device(ddata->in);\n\treturn r;\n}\n\nstatic void lb035q02_panel_spi_remove(struct spi_device *spi)\n{\n\tstruct panel_drv_data *ddata = spi_get_drvdata(spi);\n\tstruct omap_dss_device *dssdev = &ddata->dssdev;\n\tstruct omap_dss_device *in = ddata->in;\n\n\tomapdss_unregister_display(dssdev);\n\n\tlb035q02_disable(dssdev);\n\tlb035q02_disconnect(dssdev);\n\n\tomap_dss_put_device(in);\n}\n\nstatic const struct of_device_id lb035q02_of_match[] = {\n\t{ .compatible = \"omapdss,lgphilips,lb035q02\", },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(of, lb035q02_of_match);\n\nstatic struct spi_driver lb035q02_spi_driver = {\n\t.probe\t\t= lb035q02_panel_spi_probe,\n\t.remove\t\t= lb035q02_panel_spi_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"panel_lgphilips_lb035q02\",\n\t\t.of_match_table = lb035q02_of_match,\n\t\t.suppress_bind_attrs = true,\n\t},\n};\n\nmodule_spi_driver(lb035q02_spi_driver);\n\nMODULE_ALIAS(\"spi:lgphilips,lb035q02\");\nMODULE_AUTHOR(\"Tomi Valkeinen <tomi.valkeinen@ti.com>\");\nMODULE_DESCRIPTION(\"LG.Philips LB035Q02 LCD Panel driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}