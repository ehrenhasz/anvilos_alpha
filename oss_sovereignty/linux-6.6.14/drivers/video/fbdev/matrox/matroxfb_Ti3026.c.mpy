{
  "module_name": "matroxfb_Ti3026.c",
  "hash_id": "60f972b60645ab89e11196dcb2f6f5795eb03f191360478b3467458719b09fd8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/matrox/matroxfb_Ti3026.c",
  "human_readable_source": "\n \n\n\n#include \"matroxfb_Ti3026.h\"\n#include \"matroxfb_misc.h\"\n#include \"matroxfb_accel.h\"\n#include <linux/matroxfb.h>\n\n#ifdef CONFIG_FB_MATROX_MILLENIUM\n#define outTi3026 matroxfb_DAC_out\n#define inTi3026 matroxfb_DAC_in\n\n#define TVP3026_INDEX\t\t0x00\n#define TVP3026_PALWRADD\t0x00\n#define TVP3026_PALDATA\t\t0x01\n#define TVP3026_PIXRDMSK\t0x02\n#define TVP3026_PALRDADD\t0x03\n#define TVP3026_CURCOLWRADD\t0x04\n#define     TVP3026_CLOVERSCAN\t\t0x00\n#define     TVP3026_CLCOLOR0\t\t0x01\n#define     TVP3026_CLCOLOR1\t\t0x02\n#define     TVP3026_CLCOLOR2\t\t0x03\n#define TVP3026_CURCOLDATA\t0x05\n#define TVP3026_CURCOLRDADD\t0x07\n#define TVP3026_CURCTRL\t\t0x09\n#define TVP3026_X_DATAREG\t0x0A\n#define TVP3026_CURRAMDATA\t0x0B\n#define TVP3026_CURPOSXL\t0x0C\n#define TVP3026_CURPOSXH\t0x0D\n#define TVP3026_CURPOSYL\t0x0E\n#define TVP3026_CURPOSYH\t0x0F\n\n#define TVP3026_XSILICONREV\t0x01\n#define TVP3026_XCURCTRL\t0x06\n#define     TVP3026_XCURCTRL_DIS\t0x00\t \n#define     TVP3026_XCURCTRL_3COLOR\t0x01\t \n#define     TVP3026_XCURCTRL_XGA\t0x02\t \n#define     TVP3026_XCURCTRL_XWIN\t0x03\t \n#define     TVP3026_XCURCTRL_BLANK2048\t0x00\n#define     TVP3026_XCURCTRL_BLANK4096\t0x10\n#define     TVP3026_XCURCTRL_INTERLACED\t0x20\n#define     TVP3026_XCURCTRL_ODD\t0x00  \n#define     TVP3026_XCURCTRL_EVEN\t0x40  \n#define     TVP3026_XCURCTRL_INDIRECT\t0x00\n#define     TVP3026_XCURCTRL_DIRECT\t0x80\n#define TVP3026_XLATCHCTRL\t0x0F\n#define     TVP3026_XLATCHCTRL_1_1\t0x06\n#define     TVP3026_XLATCHCTRL_2_1\t0x07\n#define     TVP3026_XLATCHCTRL_4_1\t0x06\n#define     TVP3026_XLATCHCTRL_8_1\t0x06\n#define     TVP3026_XLATCHCTRL_16_1\t0x06\n#define     TVP3026A_XLATCHCTRL_4_3\t0x06\t \n#define     TVP3026A_XLATCHCTRL_8_3\t0x07\n#define     TVP3026B_XLATCHCTRL_4_3\t0x08\n#define     TVP3026B_XLATCHCTRL_8_3\t0x06\t \n#define TVP3026_XTRUECOLORCTRL\t0x18\n#define     TVP3026_XTRUECOLORCTRL_VRAM_SHIFT_ACCEL\t0x00\n#define     TVP3026_XTRUECOLORCTRL_VRAM_SHIFT_TVP\t0x20\n#define     TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR\t\t0x80\n#define     TVP3026_XTRUECOLORCTRL_TRUECOLOR\t\t0x40  \n#define     TVP3026_XTRUECOLORCTRL_DIRECTCOLOR\t\t0x00\n#define     TVP3026_XTRUECOLORCTRL_24_ALTERNATE\t\t0x08  \n#define     TVP3026_XTRUECOLORCTRL_RGB_888\t\t0x16  \n#define\t    TVP3026_XTRUECOLORCTRL_BGR_888\t\t0x17\n#define     TVP3026_XTRUECOLORCTRL_ORGB_8888\t\t0x06\n#define     TVP3026_XTRUECOLORCTRL_BGRO_8888\t\t0x07\n#define     TVP3026_XTRUECOLORCTRL_RGB_565\t\t0x05\n#define     TVP3026_XTRUECOLORCTRL_ORGB_1555\t\t0x04\n#define     TVP3026_XTRUECOLORCTRL_RGB_664\t\t0x03\n#define     TVP3026_XTRUECOLORCTRL_RGBO_4444\t\t0x01\n#define TVP3026_XMUXCTRL\t0x19\n#define     TVP3026_XMUXCTRL_MEMORY_8BIT\t\t\t0x01  \n#define     TVP3026_XMUXCTRL_MEMORY_16BIT\t\t\t0x02  \n#define     TVP3026_XMUXCTRL_MEMORY_32BIT\t\t\t0x03  \n#define     TVP3026_XMUXCTRL_MEMORY_64BIT\t\t\t0x04  \n#define     TVP3026_XMUXCTRL_PIXEL_4BIT\t\t\t\t0x40  \n#define     TVP3026_XMUXCTRL_PIXEL_4BIT_SWAPPED\t\t\t0x60  \n#define     TVP3026_XMUXCTRL_PIXEL_8BIT\t\t\t\t0x48\n#define     TVP3026_XMUXCTRL_PIXEL_16BIT\t\t\t0x50\n#define     TVP3026_XMUXCTRL_PIXEL_32BIT\t\t\t0x58\n#define     TVP3026_XMUXCTRL_VGA\t\t\t\t0x98  \n#define TVP3026_XCLKCTRL\t0x1A\n#define     TVP3026_XCLKCTRL_DIV1\t0x00\n#define     TVP3026_XCLKCTRL_DIV2\t0x10\n#define     TVP3026_XCLKCTRL_DIV4\t0x20\n#define     TVP3026_XCLKCTRL_DIV8\t0x30\n#define     TVP3026_XCLKCTRL_DIV16\t0x40\n#define     TVP3026_XCLKCTRL_DIV32\t0x50\n#define     TVP3026_XCLKCTRL_DIV64\t0x60\n#define     TVP3026_XCLKCTRL_CLKSTOPPED\t0x70\n#define     TVP3026_XCLKCTRL_SRC_CLK0\t0x00\n#define     TVP3026_XCLKCTRL_SRC_CLK1   0x01\n#define     TVP3026_XCLKCTRL_SRC_CLK2\t0x02\t \n#define     TVP3026_XCLKCTRL_SRC_NCLK2\t0x03\t \n#define     TVP3026_XCLKCTRL_SRC_ECLK2\t0x04\t \n#define     TVP3026_XCLKCTRL_SRC_PLL\t0x05\n#define     TVP3026_XCLKCTRL_SRC_DIS\t0x06\t \n#define     TVP3026_XCLKCTRL_SRC_CLK0VGA 0x07\n#define TVP3026_XPALETTEPAGE\t0x1C\n#define TVP3026_XGENCTRL\t0x1D\n#define     TVP3026_XGENCTRL_HSYNC_POS\t0x00\n#define     TVP3026_XGENCTRL_HSYNC_NEG\t0x01\n#define     TVP3026_XGENCTRL_VSYNC_POS\t0x00\n#define     TVP3026_XGENCTRL_VSYNC_NEG\t0x02\n#define     TVP3026_XGENCTRL_LITTLE_ENDIAN 0x00\n#define     TVP3026_XGENCTRL_BIG_ENDIAN    0x08\n#define     TVP3026_XGENCTRL_BLACK_0IRE\t\t0x00\n#define     TVP3026_XGENCTRL_BLACK_75IRE\t0x10\n#define     TVP3026_XGENCTRL_NO_SYNC_ON_GREEN\t0x00\n#define     TVP3026_XGENCTRL_SYNC_ON_GREEN\t0x20\n#define     TVP3026_XGENCTRL_OVERSCAN_DIS\t0x00\n#define     TVP3026_XGENCTRL_OVERSCAN_EN\t0x40\n#define TVP3026_XMISCCTRL\t0x1E\n#define     TVP3026_XMISCCTRL_DAC_PUP\t0x00\n#define     TVP3026_XMISCCTRL_DAC_PDOWN\t0x01\n#define     TVP3026_XMISCCTRL_DAC_EXT\t0x00  \n#define     TVP3026_XMISCCTRL_DAC_6BIT\t0x04\n#define     TVP3026_XMISCCTRL_DAC_8BIT\t0x0C\n#define     TVP3026_XMISCCTRL_PSEL_DIS\t0x00\n#define     TVP3026_XMISCCTRL_PSEL_EN\t0x10\n#define     TVP3026_XMISCCTRL_PSEL_LOW\t0x00  \n#define     TVP3026_XMISCCTRL_PSEL_HIGH 0x20  \n#define TVP3026_XGENIOCTRL\t0x2A\n#define TVP3026_XGENIODATA\t0x2B\n#define TVP3026_XPLLADDR\t0x2C\n#define     TVP3026_XPLLADDR_X(LOOP,MCLK,PIX) (((LOOP)<<4) | ((MCLK)<<2) | (PIX))\n#define     TVP3026_XPLLDATA_N\t\t0x00\n#define     TVP3026_XPLLDATA_M\t\t0x01\n#define     TVP3026_XPLLDATA_P\t\t0x02\n#define     TVP3026_XPLLDATA_STAT\t0x03\n#define TVP3026_XPIXPLLDATA\t0x2D\n#define TVP3026_XMEMPLLDATA\t0x2E\n#define TVP3026_XLOOPPLLDATA\t0x2F\n#define TVP3026_XCOLKEYOVRMIN\t0x30\n#define TVP3026_XCOLKEYOVRMAX\t0x31\n#define TVP3026_XCOLKEYREDMIN\t0x32\n#define TVP3026_XCOLKEYREDMAX\t0x33\n#define TVP3026_XCOLKEYGREENMIN\t0x34\n#define TVP3026_XCOLKEYGREENMAX\t0x35\n#define TVP3026_XCOLKEYBLUEMIN\t0x36\n#define TVP3026_XCOLKEYBLUEMAX\t0x37\n#define TVP3026_XCOLKEYCTRL\t0x38\n#define     TVP3026_XCOLKEYCTRL_OVR_EN\t0x01\n#define     TVP3026_XCOLKEYCTRL_RED_EN\t0x02\n#define     TVP3026_XCOLKEYCTRL_GREEN_EN 0x04\n#define     TVP3026_XCOLKEYCTRL_BLUE_EN\t0x08\n#define     TVP3026_XCOLKEYCTRL_NEGATE\t0x10\n#define     TVP3026_XCOLKEYCTRL_ZOOM1\t0x00\n#define     TVP3026_XCOLKEYCTRL_ZOOM2\t0x20\n#define     TVP3026_XCOLKEYCTRL_ZOOM4\t0x40\n#define     TVP3026_XCOLKEYCTRL_ZOOM8\t0x60\n#define     TVP3026_XCOLKEYCTRL_ZOOM16\t0x80\n#define     TVP3026_XCOLKEYCTRL_ZOOM32\t0xA0\n#define TVP3026_XMEMPLLCTRL\t0x39\n#define     TVP3026_XMEMPLLCTRL_DIV(X)\t(((X)-1)>>1)\t \n#define     TVP3026_XMEMPLLCTRL_STROBEMKC4\t0x08\n#define     TVP3026_XMEMPLLCTRL_MCLK_DOTCLOCK\t0x00\t \n#define     TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL\t0x10\t \n#define     TVP3026_XMEMPLLCTRL_RCLK_PIXPLL\t0x00\n#define     TVP3026_XMEMPLLCTRL_RCLK_LOOPPLL\t0x20\n#define     TVP3026_XMEMPLLCTRL_RCLK_DOTDIVN\t0x40\t \n#define TVP3026_XSENSETEST\t0x3A\n#define TVP3026_XTESTMODEDATA\t0x3B\n#define TVP3026_XCRCREML\t0x3C\n#define TVP3026_XCRCREMH\t0x3D\n#define TVP3026_XCRCBITSEL\t0x3E\n#define TVP3026_XID\t\t0x3F\n\nstatic const unsigned char DACseq[] =\n{ TVP3026_XLATCHCTRL, TVP3026_XTRUECOLORCTRL,\n  TVP3026_XMUXCTRL, TVP3026_XCLKCTRL,\n  TVP3026_XPALETTEPAGE,\n  TVP3026_XGENCTRL,\n  TVP3026_XMISCCTRL,\n  TVP3026_XGENIOCTRL,\n  TVP3026_XGENIODATA,\n  TVP3026_XCOLKEYOVRMIN, TVP3026_XCOLKEYOVRMAX, TVP3026_XCOLKEYREDMIN, TVP3026_XCOLKEYREDMAX,\n  TVP3026_XCOLKEYGREENMIN, TVP3026_XCOLKEYGREENMAX, TVP3026_XCOLKEYBLUEMIN, TVP3026_XCOLKEYBLUEMAX,\n  TVP3026_XCOLKEYCTRL,\n  TVP3026_XMEMPLLCTRL, TVP3026_XSENSETEST, TVP3026_XCURCTRL };\n\n#define POS3026_XLATCHCTRL\t0\n#define POS3026_XTRUECOLORCTRL\t1\n#define POS3026_XMUXCTRL\t2\n#define POS3026_XCLKCTRL\t3\n#define POS3026_XGENCTRL\t5\n#define POS3026_XMISCCTRL\t6\n#define POS3026_XMEMPLLCTRL\t18\n#define POS3026_XCURCTRL\t20\n\nstatic const unsigned char MGADACbpp32[] =\n{ TVP3026_XLATCHCTRL_2_1, TVP3026_XTRUECOLORCTRL_DIRECTCOLOR | TVP3026_XTRUECOLORCTRL_ORGB_8888,\n  0x00, TVP3026_XCLKCTRL_DIV1 | TVP3026_XCLKCTRL_SRC_PLL,\n  0x00,\n  TVP3026_XGENCTRL_HSYNC_POS | TVP3026_XGENCTRL_VSYNC_POS | TVP3026_XGENCTRL_LITTLE_ENDIAN | TVP3026_XGENCTRL_BLACK_0IRE | TVP3026_XGENCTRL_NO_SYNC_ON_GREEN | TVP3026_XGENCTRL_OVERSCAN_DIS,\n  TVP3026_XMISCCTRL_DAC_PUP | TVP3026_XMISCCTRL_DAC_8BIT | TVP3026_XMISCCTRL_PSEL_DIS | TVP3026_XMISCCTRL_PSEL_HIGH,\n  0x00,\n  0x1E,\n  0xFF, 0xFF, 0xFF, 0xFF,\n  0xFF, 0xFF, 0xFF, 0xFF,\n  TVP3026_XCOLKEYCTRL_ZOOM1,\n  0x00, 0x00, TVP3026_XCURCTRL_DIS };\n\nstatic int Ti3026_calcclock(const struct matrox_fb_info *minfo,\n\t\t\t    unsigned int freq, unsigned int fmax, int *in,\n\t\t\t    int *feed, int *post)\n{\n\tunsigned int fvco;\n\tunsigned int lin, lfeed, lpost;\n\n\tDBG(__func__)\n\n\tfvco = PLL_calcclock(minfo, freq, fmax, &lin, &lfeed, &lpost);\n\tfvco >>= (*post = lpost);\n\t*in = 64 - lin;\n\t*feed = 64 - lfeed;\n\treturn fvco;\n}\n\nstatic int Ti3026_setpclk(struct matrox_fb_info *minfo, int clk)\n{\n\tunsigned int f_pll;\n\tunsigned int pixfeed, pixin, pixpost;\n\tstruct matrox_hw_state *hw = &minfo->hw;\n\n\tDBG(__func__)\n\n\tf_pll = Ti3026_calcclock(minfo, clk, minfo->max_pixel_clock, &pixin, &pixfeed, &pixpost);\n\n\thw->DACclk[0] = pixin | 0xC0;\n\thw->DACclk[1] = pixfeed;\n\thw->DACclk[2] = pixpost | 0xB0;\n\n\t{\n\t\tunsigned int loopfeed, loopin, looppost, loopdiv, z;\n\t\tunsigned int Bpp;\n\n\t\tBpp = minfo->curr.final_bppShift;\n\n\t\tif (minfo->fbcon.var.bits_per_pixel == 24) {\n\t\t\tloopfeed = 3;\t\t \n\t\t\tloopin = 3 * 32 / Bpp;\n\t\t} else {\n\t\t\tloopfeed = 4;\n\t\t\tloopin = 4 * 32 / Bpp;\n\t\t}\n\t\tz = (110000 * loopin) / (f_pll * loopfeed);\n\t\tloopdiv = 0;  \n\t\tif (z < 2)\n\t\t\tlooppost = 0;\n\t\telse if (z < 4)\n\t\t\tlooppost = 1;\n\t\telse if (z < 8)\n\t\t\tlooppost = 2;\n\t\telse {\n\t\t\tlooppost = 3;\n\t\t\tloopdiv = z/16;\n\t\t}\n\t\tif (minfo->fbcon.var.bits_per_pixel == 24) {\n\t\t\thw->DACclk[3] = ((65 - loopin) & 0x3F) | 0xC0;\n\t\t\thw->DACclk[4] = (65 - loopfeed) | 0x80;\n\t\t\tif (minfo->accel.ramdac_rev > 0x20) {\n\t\t\t\tif (isInterleave(minfo))\n\t\t\t\t\thw->DACreg[POS3026_XLATCHCTRL] = TVP3026B_XLATCHCTRL_8_3;\n\t\t\t\telse {\n\t\t\t\t\thw->DACclk[4] &= ~0xC0;\n\t\t\t\t\thw->DACreg[POS3026_XLATCHCTRL] = TVP3026B_XLATCHCTRL_4_3;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (isInterleave(minfo))\n\t\t\t\t\t;\t \n\t\t\t\telse {\n\t\t\t\t\thw->DACclk[4] ^= 0xC0;\t \n\t\t\t\t\thw->DACreg[POS3026_XLATCHCTRL] = TVP3026A_XLATCHCTRL_4_3;\n\t\t\t\t}\n\t\t\t}\n\t\t\thw->DACclk[5] = looppost | 0xF8;\n\t\t\tif (minfo->devflags.mga_24bpp_fix)\n\t\t\t\thw->DACclk[5] ^= 0x40;\n\t\t} else {\n\t\t\thw->DACclk[3] = ((65 - loopin) & 0x3F) | 0xC0;\n\t\t\thw->DACclk[4] = 65 - loopfeed;\n\t\t\thw->DACclk[5] = looppost | 0xF0;\n\t\t}\n\t\thw->DACreg[POS3026_XMEMPLLCTRL] = loopdiv | TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL | TVP3026_XMEMPLLCTRL_RCLK_LOOPPLL;\n\t}\n\treturn 0;\n}\n\nstatic int Ti3026_init(struct matrox_fb_info *minfo, struct my_timming *m)\n{\n\tu_int8_t muxctrl = isInterleave(minfo) ? TVP3026_XMUXCTRL_MEMORY_64BIT : TVP3026_XMUXCTRL_MEMORY_32BIT;\n\tstruct matrox_hw_state *hw = &minfo->hw;\n\n\tDBG(__func__)\n\n\tmemcpy(hw->DACreg, MGADACbpp32, sizeof(MGADACbpp32));\n\tswitch (minfo->fbcon.var.bits_per_pixel) {\n\t\tcase 4:\thw->DACreg[POS3026_XLATCHCTRL] = TVP3026_XLATCHCTRL_16_1;\t \n\t\t\thw->DACreg[POS3026_XTRUECOLORCTRL] = TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR;\n\t\t\thw->DACreg[POS3026_XMUXCTRL] = muxctrl | TVP3026_XMUXCTRL_PIXEL_4BIT;\n\t\t\thw->DACreg[POS3026_XCLKCTRL] = TVP3026_XCLKCTRL_SRC_PLL | TVP3026_XCLKCTRL_DIV8;\n\t\t\thw->DACreg[POS3026_XMISCCTRL] = TVP3026_XMISCCTRL_DAC_PUP | TVP3026_XMISCCTRL_DAC_8BIT | TVP3026_XMISCCTRL_PSEL_DIS | TVP3026_XMISCCTRL_PSEL_LOW;\n\t\t\tbreak;\n\t\tcase 8: hw->DACreg[POS3026_XLATCHCTRL] = TVP3026_XLATCHCTRL_8_1;\t \n\t\t\thw->DACreg[POS3026_XTRUECOLORCTRL] = TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR;\n\t\t\thw->DACreg[POS3026_XMUXCTRL] = muxctrl | TVP3026_XMUXCTRL_PIXEL_8BIT;\n\t\t\thw->DACreg[POS3026_XCLKCTRL] = TVP3026_XCLKCTRL_SRC_PLL | TVP3026_XCLKCTRL_DIV4;\n\t\t\thw->DACreg[POS3026_XMISCCTRL] = TVP3026_XMISCCTRL_DAC_PUP | TVP3026_XMISCCTRL_DAC_8BIT | TVP3026_XMISCCTRL_PSEL_DIS | TVP3026_XMISCCTRL_PSEL_LOW;\n\t\t\tbreak;\n\t\tcase 16:\n\t\t\t \n\t\t\thw->DACreg[POS3026_XTRUECOLORCTRL] = (minfo->fbcon.var.green.length == 5) ? (TVP3026_XTRUECOLORCTRL_DIRECTCOLOR | TVP3026_XTRUECOLORCTRL_ORGB_1555) : (TVP3026_XTRUECOLORCTRL_DIRECTCOLOR | TVP3026_XTRUECOLORCTRL_RGB_565);\n\t\t\thw->DACreg[POS3026_XMUXCTRL] = muxctrl | TVP3026_XMUXCTRL_PIXEL_16BIT;\n\t\t\thw->DACreg[POS3026_XCLKCTRL] = TVP3026_XCLKCTRL_SRC_PLL | TVP3026_XCLKCTRL_DIV2;\n\t\t\tbreak;\n\t\tcase 24:\n\t\t\t \n\t\t\thw->DACreg[POS3026_XTRUECOLORCTRL] = TVP3026_XTRUECOLORCTRL_DIRECTCOLOR | TVP3026_XTRUECOLORCTRL_RGB_888;\n\t\t\thw->DACreg[POS3026_XMUXCTRL] = muxctrl | TVP3026_XMUXCTRL_PIXEL_32BIT;\n\t\t\thw->DACreg[POS3026_XCLKCTRL] = TVP3026_XCLKCTRL_SRC_PLL | TVP3026_XCLKCTRL_DIV4;\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\t \n\t\t\thw->DACreg[POS3026_XMUXCTRL] = muxctrl | TVP3026_XMUXCTRL_PIXEL_32BIT;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn 1;\t \n\t}\n\tif (matroxfb_vgaHWinit(minfo, m)) return 1;\n\n\t \n\thw->MiscOutReg = 0xCB;\n\tif (m->sync & FB_SYNC_HOR_HIGH_ACT)\n\t\thw->DACreg[POS3026_XGENCTRL] |= TVP3026_XGENCTRL_HSYNC_NEG;\n\tif (m->sync & FB_SYNC_VERT_HIGH_ACT)\n\t\thw->DACreg[POS3026_XGENCTRL] |= TVP3026_XGENCTRL_VSYNC_NEG;\n\tif (m->sync & FB_SYNC_ON_GREEN)\n\t\thw->DACreg[POS3026_XGENCTRL] |= TVP3026_XGENCTRL_SYNC_ON_GREEN;\n\n\t \n\tif (minfo->video.len < 0x400000)\n\t\thw->CRTCEXT[3] |= 0x08;\n\telse if (minfo->video.len > 0x400000)\n\t\thw->CRTCEXT[3] |= 0x10;\n\n\t \n\tif (m->interlaced) {\n\t\thw->DACreg[POS3026_XCURCTRL] |= TVP3026_XCURCTRL_INTERLACED;\n\t}\n\tif (m->HTotal >= 1536)\n\t\thw->DACreg[POS3026_XCURCTRL] |= TVP3026_XCURCTRL_BLANK4096;\n\n\t \n\thw->MXoptionReg &= ~0x00001000;\n\tif (isInterleave(minfo)) hw->MXoptionReg |= 0x00001000;\n\n\t \n\tTi3026_setpclk(minfo, m->pixclock);\n\treturn 0;\n}\n\nstatic void ti3026_setMCLK(struct matrox_fb_info *minfo, int fout)\n{\n\tunsigned int f_pll;\n\tunsigned int pclk_m, pclk_n, pclk_p;\n\tunsigned int mclk_m, mclk_n, mclk_p;\n\tunsigned int rfhcnt, mclk_ctl;\n\tint tmout;\n\n\tDBG(__func__)\n\n\tf_pll = Ti3026_calcclock(minfo, fout, minfo->max_pixel_clock, &mclk_n, &mclk_m, &mclk_p);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFC);\n\tpclk_n = inTi3026(minfo, TVP3026_XPIXPLLDATA);\n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFD);\n\tpclk_m = inTi3026(minfo, TVP3026_XPIXPLLDATA);\n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFE);\n\tpclk_p = inTi3026(minfo, TVP3026_XPIXPLLDATA);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFE);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, 0x00);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFC);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, mclk_n | 0xC0);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, mclk_m);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, mclk_p | 0xB0);\n\n\t \n\tfor (tmout = 500000; tmout; tmout--) {\n\t\tif (inTi3026(minfo, TVP3026_XPIXPLLDATA) & 0x40)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\tif (!tmout)\n\t\tprintk(KERN_ERR \"matroxfb: Temporary pixel PLL not locked after 5 secs\\n\");\n\n\t \n\tmclk_ctl = inTi3026(minfo, TVP3026_XMEMPLLCTRL);\n\toutTi3026(minfo, TVP3026_XMEMPLLCTRL, mclk_ctl & 0xE7);\n\toutTi3026(minfo, TVP3026_XMEMPLLCTRL, (mclk_ctl & 0xE7) | TVP3026_XMEMPLLCTRL_STROBEMKC4);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFB);\n\toutTi3026(minfo, TVP3026_XMEMPLLDATA, 0x00);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xF3);\n\toutTi3026(minfo, TVP3026_XMEMPLLDATA, mclk_n | 0xC0);\n\toutTi3026(minfo, TVP3026_XMEMPLLDATA, mclk_m);\n\toutTi3026(minfo, TVP3026_XMEMPLLDATA, mclk_p | 0xB0);\n\n\t \n\tfor (tmout = 500000; tmout; tmout--) {\n\t\tif (inTi3026(minfo, TVP3026_XMEMPLLDATA) & 0x40)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\tif (!tmout)\n\t\tprintk(KERN_ERR \"matroxfb: Memory PLL not locked after 5 secs\\n\");\n\n\tf_pll = f_pll * 333 / (10000 << mclk_p);\n\tif (isMilleniumII(minfo)) {\n\t\trfhcnt = (f_pll - 128) / 256;\n\t\tif (rfhcnt > 15)\n\t\t\trfhcnt = 15;\n\t} else {\n\t\trfhcnt = (f_pll - 64) / 128;\n\t\tif (rfhcnt > 15)\n\t\t\trfhcnt = 0;\n\t}\n\tminfo->hw.MXoptionReg = (minfo->hw.MXoptionReg & ~0x000F0000) | (rfhcnt << 16);\n\tpci_write_config_dword(minfo->pcidev, PCI_OPTION_REG, minfo->hw.MXoptionReg);\n\n\t \n\toutTi3026(minfo, TVP3026_XMEMPLLCTRL, (mclk_ctl & 0xE7) | TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL);\n\toutTi3026(minfo, TVP3026_XMEMPLLCTRL, (mclk_ctl       ) | TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL | TVP3026_XMEMPLLCTRL_STROBEMKC4);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFE);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, 0x00);\n\n\t \n\toutTi3026(minfo, TVP3026_XPLLADDR, 0xFC);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, pclk_n);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, pclk_m);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, pclk_p);\n\n\t \n\tfor (tmout = 500000; tmout; tmout--) {\n\t\tif (inTi3026(minfo, TVP3026_XPIXPLLDATA) & 0x40)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\tif (!tmout)\n\t\tprintk(KERN_ERR \"matroxfb: Pixel PLL not locked after 5 secs\\n\");\n}\n\nstatic void ti3026_ramdac_init(struct matrox_fb_info *minfo)\n{\n\tDBG(__func__)\n\n\tminfo->features.pll.vco_freq_min = 110000;\n\tminfo->features.pll.ref_freq\t = 114545;\n\tminfo->features.pll.feed_div_min = 2;\n\tminfo->features.pll.feed_div_max = 24;\n\tminfo->features.pll.in_div_min\t = 2;\n\tminfo->features.pll.in_div_max\t = 63;\n\tminfo->features.pll.post_shift_max = 3;\n\tif (minfo->devflags.noinit)\n\t\treturn;\n\tti3026_setMCLK(minfo, 60000);\n}\n\nstatic void Ti3026_restore(struct matrox_fb_info *minfo)\n{\n\tint i;\n\tunsigned char progdac[6];\n\tstruct matrox_hw_state *hw = &minfo->hw;\n\tCRITFLAGS\n\n\tDBG(__func__)\n\n#ifdef DEBUG\n\tdprintk(KERN_INFO \"EXTVGA regs: \");\n\tfor (i = 0; i < 6; i++)\n\t\tdprintk(\"%02X:\", hw->CRTCEXT[i]);\n\tdprintk(\"\\n\");\n#endif\n\n\tCRITBEGIN\n\n\tpci_write_config_dword(minfo->pcidev, PCI_OPTION_REG, hw->MXoptionReg);\n\n\tCRITEND\n\n\tmatroxfb_vgaHWrestore(minfo);\n\n\tCRITBEGIN\n\n\tminfo->crtc1.panpos = -1;\n\tfor (i = 0; i < 6; i++)\n\t\tmga_setr(M_EXTVGA_INDEX, i, hw->CRTCEXT[i]);\n\n\tfor (i = 0; i < 21; i++) {\n\t\toutTi3026(minfo, DACseq[i], hw->DACreg[i]);\n\t}\n\n\toutTi3026(minfo, TVP3026_XPLLADDR, 0x00);\n\tprogdac[0] = inTi3026(minfo, TVP3026_XPIXPLLDATA);\n\tprogdac[3] = inTi3026(minfo, TVP3026_XLOOPPLLDATA);\n\toutTi3026(minfo, TVP3026_XPLLADDR, 0x15);\n\tprogdac[1] = inTi3026(minfo, TVP3026_XPIXPLLDATA);\n\tprogdac[4] = inTi3026(minfo, TVP3026_XLOOPPLLDATA);\n\toutTi3026(minfo, TVP3026_XPLLADDR, 0x2A);\n\tprogdac[2] = inTi3026(minfo, TVP3026_XPIXPLLDATA);\n\tprogdac[5] = inTi3026(minfo, TVP3026_XLOOPPLLDATA);\n\n\tCRITEND\n\tif (memcmp(hw->DACclk, progdac, 6)) {\n\t\t \n\t\t \n\t\t \n\n\t\tCRITBEGIN\n\t\toutTi3026(minfo, TVP3026_XCLKCTRL, hw->DACreg[POS3026_XCLKCTRL]);\n\t\toutTi3026(minfo, TVP3026_XPLLADDR, 0x2A);\n\t\toutTi3026(minfo, TVP3026_XLOOPPLLDATA, 0);\n\t\toutTi3026(minfo, TVP3026_XPIXPLLDATA, 0);\n\n\t\toutTi3026(minfo, TVP3026_XPLLADDR, 0x00);\n\t\tfor (i = 0; i < 3; i++)\n\t\t\toutTi3026(minfo, TVP3026_XPIXPLLDATA, hw->DACclk[i]);\n\t\t \n\t\tif (hw->MiscOutReg & 0x08) {\n\t\t\tint tmout;\n\t\t\toutTi3026(minfo, TVP3026_XPLLADDR, 0x3F);\n\t\t\tfor (tmout = 500000; tmout; --tmout) {\n\t\t\t\tif (inTi3026(minfo, TVP3026_XPIXPLLDATA) & 0x40)\n\t\t\t\t\tbreak;\n\t\t\t\tudelay(10);\n\t\t\t}\n\n\t\t\tCRITEND\n\n\t\t\tif (!tmout)\n\t\t\t\tprintk(KERN_ERR \"matroxfb: Pixel PLL not locked after 5 secs\\n\");\n\t\t\telse\n\t\t\t\tdprintk(KERN_INFO \"PixelPLL: %d\\n\", 500000-tmout);\n\t\t\tCRITBEGIN\n\t\t}\n\t\toutTi3026(minfo, TVP3026_XMEMPLLCTRL, hw->DACreg[POS3026_XMEMPLLCTRL]);\n\t\toutTi3026(minfo, TVP3026_XPLLADDR, 0x00);\n\t\tfor (i = 3; i < 6; i++)\n\t\t\toutTi3026(minfo, TVP3026_XLOOPPLLDATA, hw->DACclk[i]);\n\t\tCRITEND\n\t\tif ((hw->MiscOutReg & 0x08) && ((hw->DACclk[5] & 0x80) == 0x80)) {\n\t\t\tint tmout;\n\n\t\t\tCRITBEGIN\n\t\t\toutTi3026(minfo, TVP3026_XPLLADDR, 0x3F);\n\t\t\tfor (tmout = 500000; tmout; --tmout) {\n\t\t\t\tif (inTi3026(minfo, TVP3026_XLOOPPLLDATA) & 0x40)\n\t\t\t\t\tbreak;\n\t\t\t\tudelay(10);\n\t\t\t}\n\t\t\tCRITEND\n\t\t\tif (!tmout)\n\t\t\t\tprintk(KERN_ERR \"matroxfb: Loop PLL not locked after 5 secs\\n\");\n\t\t\telse\n\t\t\t\tdprintk(KERN_INFO \"LoopPLL: %d\\n\", 500000-tmout);\n\t\t}\n\t}\n\n#ifdef DEBUG\n\tdprintk(KERN_DEBUG \"3026DACregs \");\n\tfor (i = 0; i < 21; i++) {\n\t\tdprintk(\"R%02X=%02X \", DACseq[i], hw->DACreg[i]);\n\t\tif ((i & 0x7) == 0x7) dprintk(KERN_DEBUG \"continuing... \");\n\t}\n\tdprintk(KERN_DEBUG \"DACclk \");\n\tfor (i = 0; i < 6; i++)\n\t\tdprintk(\"C%02X=%02X \", i, hw->DACclk[i]);\n\tdprintk(\"\\n\");\n#endif\n}\n\nstatic void Ti3026_reset(struct matrox_fb_info *minfo)\n{\n\tDBG(__func__)\n\n\tti3026_ramdac_init(minfo);\n}\n\nstatic struct matrox_altout ti3026_output = {\n\t.name\t = \"Primary output\",\n};\n\nstatic int Ti3026_preinit(struct matrox_fb_info *minfo)\n{\n\tstatic const int vxres_mill2[] = { 512,        640, 768,  800,  832,  960,\n\t\t\t\t\t  1024, 1152, 1280,      1600, 1664, 1920,\n\t\t\t\t\t  2048, 0};\n\tstatic const int vxres_mill1[] = {             640, 768,  800,        960,\n\t\t\t\t\t  1024, 1152, 1280,      1600,       1920,\n\t\t\t\t\t  2048, 0};\n\tstruct matrox_hw_state *hw = &minfo->hw;\n\n\tDBG(__func__)\n\n\tminfo->millenium = 1;\n\tminfo->milleniumII = (minfo->pcidev->device != PCI_DEVICE_ID_MATROX_MIL);\n\tminfo->capable.cfb4 = 1;\n\tminfo->capable.text = 1;  \n\tminfo->capable.vxres = isMilleniumII(minfo) ? vxres_mill2 : vxres_mill1;\n\n\tminfo->outputs[0].data = minfo;\n\tminfo->outputs[0].output = &ti3026_output;\n\tminfo->outputs[0].src = minfo->outputs[0].default_src;\n\tminfo->outputs[0].mode = MATROXFB_OUTPUT_MODE_MONITOR;\n\n\tif (minfo->devflags.noinit)\n\t\treturn 0;\n\t \n\thw->MXoptionReg &= 0xC0000100;\n\thw->MXoptionReg |= 0x002C0000;\n\tif (minfo->devflags.novga)\n\t\thw->MXoptionReg &= ~0x00000100;\n\tif (minfo->devflags.nobios)\n\t\thw->MXoptionReg &= ~0x40000000;\n\tif (minfo->devflags.nopciretry)\n\t\thw->MXoptionReg |=  0x20000000;\n\tpci_write_config_dword(minfo->pcidev, PCI_OPTION_REG, hw->MXoptionReg);\n\n\tminfo->accel.ramdac_rev = inTi3026(minfo, TVP3026_XSILICONREV);\n\n\toutTi3026(minfo, TVP3026_XCLKCTRL, TVP3026_XCLKCTRL_SRC_CLK0VGA | TVP3026_XCLKCTRL_CLKSTOPPED);\n\toutTi3026(minfo, TVP3026_XTRUECOLORCTRL, TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR);\n\toutTi3026(minfo, TVP3026_XMUXCTRL, TVP3026_XMUXCTRL_VGA);\n\n\toutTi3026(minfo, TVP3026_XPLLADDR, 0x2A);\n\toutTi3026(minfo, TVP3026_XLOOPPLLDATA, 0x00);\n\toutTi3026(minfo, TVP3026_XPIXPLLDATA, 0x00);\n\n\tmga_outb(M_MISC_REG, 0x67);\n\n\toutTi3026(minfo, TVP3026_XMEMPLLCTRL, TVP3026_XMEMPLLCTRL_STROBEMKC4 | TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL);\n\n\tmga_outl(M_RESET, 1);\n\tudelay(250);\n\tmga_outl(M_RESET, 0);\n\tudelay(250);\n\tmga_outl(M_MACCESS, 0x00008000);\n\tudelay(10);\n\treturn 0;\n}\n\nstruct matrox_switch matrox_millennium = {\n\t.preinit\t= Ti3026_preinit,\n\t.reset\t\t= Ti3026_reset,\n\t.init\t\t= Ti3026_init,\n\t.restore\t= Ti3026_restore\n};\nEXPORT_SYMBOL(matrox_millennium);\n#endif\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}