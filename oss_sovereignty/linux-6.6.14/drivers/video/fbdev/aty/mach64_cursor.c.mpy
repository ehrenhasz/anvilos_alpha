{
  "module_name": "mach64_cursor.c",
  "hash_id": "0fc087c7fc08c09bb76766664f4079710cca4fc15e8bf567a2e90366a1a01332",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/aty/mach64_cursor.c",
  "human_readable_source": "\n \n\n#include <linux/fb.h>\n#include <linux/init.h>\n#include <linux/string.h>\n#include \"../core/fb_draw.h\"\n\n#include <asm/io.h>\n\n#ifdef __sparc__\n#include <asm/fbio.h>\n#endif\n\n#include <video/mach64.h>\n#include \"atyfb.h\"\n\n \n\n     \nstatic const u8 cursor_bits_lookup[16] = {\n\t0x00, 0x40, 0x10, 0x50, 0x04, 0x44, 0x14, 0x54,\n\t0x01, 0x41, 0x11, 0x51, 0x05, 0x45, 0x15, 0x55\n};\n\nstatic int atyfb_cursor(struct fb_info *info, struct fb_cursor *cursor)\n{\n\tstruct atyfb_par *par = (struct atyfb_par *) info->par;\n\tu16 xoff, yoff;\n\tint x, y, h;\n\n#ifdef __sparc__\n\tif (par->mmaped)\n\t\treturn -EPERM;\n#endif\n\tif (par->asleep)\n\t\treturn -EPERM;\n\n\twait_for_fifo(1, par);\n\tif (cursor->enable)\n\t\taty_st_le32(GEN_TEST_CNTL, aty_ld_le32(GEN_TEST_CNTL, par)\n\t\t\t    | HWCURSOR_ENABLE, par);\n\telse\n\t\taty_st_le32(GEN_TEST_CNTL, aty_ld_le32(GEN_TEST_CNTL, par)\n\t\t\t\t& ~HWCURSOR_ENABLE, par);\n\n\t \n\tif (cursor->set & FB_CUR_SETPOS) {\n\t\tx = cursor->image.dx - cursor->hot.x - info->var.xoffset;\n\t\tif (x < 0) {\n\t\t\txoff = -x;\n\t\t\tx = 0;\n\t\t} else {\n\t\t\txoff = 0;\n\t\t}\n\n\t\ty = cursor->image.dy - cursor->hot.y - info->var.yoffset;\n\t\tif (y < 0) {\n\t\t\tyoff = -y;\n\t\t\ty = 0;\n\t\t} else {\n\t\t\tyoff = 0;\n\t\t}\n\n\t\th = cursor->image.height;\n\n\t\t \n                if (par->crtc.gen_cntl & CRTC_DBL_SCAN_EN) {\n\t\t\ty<<=1;\n\t\t\th<<=1;\n\t\t}\n\t\twait_for_fifo(3, par);\n\t\taty_st_le32(CUR_OFFSET, (info->fix.smem_len >> 3) + (yoff << 1), par);\n\t\taty_st_le32(CUR_HORZ_VERT_OFF,\n\t\t\t    ((u32) (64 - h + yoff) << 16) | xoff, par);\n\t\taty_st_le32(CUR_HORZ_VERT_POSN, ((u32) y << 16) | x, par);\n\t}\n\n\t \n\tif (cursor->set & FB_CUR_SETCMAP) {\n\t\tu32 fg_idx, bg_idx, fg, bg;\n\n\t\tfg_idx = cursor->image.fg_color;\n\t\tbg_idx = cursor->image.bg_color;\n\n\t\tfg = ((info->cmap.red[fg_idx] & 0xff) << 24) |\n\t\t     ((info->cmap.green[fg_idx] & 0xff) << 16) |\n\t\t     ((info->cmap.blue[fg_idx] & 0xff) << 8) | 0xff;\n\n\t\tbg = ((info->cmap.red[bg_idx] & 0xff) << 24) |\n\t\t     ((info->cmap.green[bg_idx] & 0xff) << 16) |\n\t\t     ((info->cmap.blue[bg_idx] & 0xff) << 8);\n\n\t\twait_for_fifo(2, par);\n\t\taty_st_le32(CUR_CLR0, bg, par);\n\t\taty_st_le32(CUR_CLR1, fg, par);\n\t}\n\n\tif (cursor->set & (FB_CUR_SETSHAPE | FB_CUR_SETIMAGE)) {\n\t    u8 *src = (u8 *)cursor->image.data;\n\t    u8 *msk = (u8 *)cursor->mask;\n\t    u8 __iomem *dst = (u8 __iomem *)info->sprite.addr;\n\t    unsigned int width = (cursor->image.width + 7) >> 3;\n\t    unsigned int height = cursor->image.height;\n\t    unsigned int align = info->sprite.scan_align;\n\n\t    unsigned int i, j, offset;\n\t    u8 m, b;\n\n\t    \n\t    fb_memset_io(dst, 0xaa, 1024);\n\n\t    offset = align - width*2;\n\n\t    for (i = 0; i < height; i++) {\n\t\tfor (j = 0; j < width; j++) {\n\t\t\tu16 l = 0xaaaa;\n\t\t\tb = *src++;\n\t\t\tm = *msk++;\n\t\t\tswitch (cursor->rop) {\n\t\t\tcase ROP_XOR:\n\t\t\t    \n\t\t\t    l = cursor_bits_lookup[(b ^ m) >> 4] |\n\t\t\t    \n\t\t\t\t    (cursor_bits_lookup[(b ^ m) & 0x0f] << 8);\n\t\t\t    break;\n\t\t\tcase ROP_COPY:\n\t\t\t    \n\t\t\t    l = cursor_bits_lookup[(b & m) >> 4] |\n\t\t\t    \n\t\t\t\t    (cursor_bits_lookup[(b & m) & 0x0f] << 8);\n\t\t\t    break;\n\t\t\t}\n\t\t\t \n\t\t\tif ((j + 1) * 8 > cursor->image.width) {\n\t\t\t\tl = comp(l, 0xaaaa,\n\t\t\t\t    (1 << ((cursor->image.width & 7) * 2)) - 1);\n\t\t\t}\n\t\t\tfb_writeb(l & 0xff, dst++);\n\t\t\tfb_writeb(l >> 8, dst++);\n\t\t}\n\t\tdst += offset;\n\t    }\n\t}\n\n\treturn 0;\n}\n\nint aty_init_cursor(struct fb_info *info, struct fb_ops *atyfb_ops)\n{\n\tunsigned long addr;\n\n\tinfo->fix.smem_len -= PAGE_SIZE;\n\n#ifdef __sparc__\n\taddr = (unsigned long) info->screen_base - 0x800000 + info->fix.smem_len;\n\tinfo->sprite.addr = (u8 *) addr;\n#else\n#ifdef __BIG_ENDIAN\n\taddr = info->fix.smem_start - 0x800000 + info->fix.smem_len;\n\tinfo->sprite.addr = (u8 *) ioremap(addr, 1024);\n#else\n\taddr = (unsigned long) info->screen_base + info->fix.smem_len;\n\tinfo->sprite.addr = (u8 *) addr;\n#endif\n#endif\n\tif (!info->sprite.addr)\n\t\treturn -ENXIO;\n\tinfo->sprite.size = PAGE_SIZE;\n\tinfo->sprite.scan_align = 16;\t \n\tinfo->sprite.buf_align = 16; \t \n\tinfo->sprite.flags = FB_PIXMAP_IO;\n\n\tatyfb_ops->fb_cursor = atyfb_cursor;\n\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}