{
  "module_name": "radeon_pm.c",
  "hash_id": "5ab390db9ac8ee8005dc27efa8a7e53b7d936adcc75f1693540479a05a50ab3f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/aty/radeon_pm.c",
  "human_readable_source": "\n \n\n#include \"radeonfb.h\"\n\n#include <linux/console.h>\n#include <linux/agp_backend.h>\n\n#ifdef CONFIG_PPC_PMAC\n#include <asm/machdep.h>\n#include <asm/pmac_feature.h>\n#endif\n\n#include \"ati_ids.h\"\n\n \n\n#if defined(CONFIG_PM) && defined(CONFIG_X86)\nstatic void radeon_reinitialize_M10(struct radeonfb_info *rinfo);\n\nstruct radeon_device_id {\n        const char *ident;                      \n        const unsigned short subsystem_vendor;  \n        const unsigned short subsystem_device;  \n\tconst enum radeon_pm_mode pm_mode_modifier;  \n\tconst reinit_function_ptr new_reinit_func;    \n};\n\n#define BUGFIX(model, sv, sd, pm, fn) { \\\n\t.ident = model, \\\n\t.subsystem_vendor = sv, \\\n\t.subsystem_device = sd, \\\n\t.pm_mode_modifier = pm, \\\n\t.new_reinit_func  = fn  \\\n}\n\nstatic struct radeon_device_id radeon_workaround_list[] = {\n\tBUGFIX(\"IBM Thinkpad R32\",\n\t       PCI_VENDOR_ID_IBM, 0x1905,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad R40\",\n\t       PCI_VENDOR_ID_IBM, 0x0526,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad R40\",\n\t       PCI_VENDOR_ID_IBM, 0x0527,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad R50/R51/T40/T41\",\n\t       PCI_VENDOR_ID_IBM, 0x0531,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad R51/T40/T41/T42\",\n\t       PCI_VENDOR_ID_IBM, 0x0530,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad T30\",\n\t       PCI_VENDOR_ID_IBM, 0x0517,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad T40p\",\n\t       PCI_VENDOR_ID_IBM, 0x054d,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad T42\",\n\t       PCI_VENDOR_ID_IBM, 0x0550,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"IBM Thinkpad X31/X32\",\n\t       PCI_VENDOR_ID_IBM, 0x052f,\n\t       radeon_pm_d2, NULL),\n\tBUGFIX(\"Samsung P35\",\n\t       PCI_VENDOR_ID_SAMSUNG, 0xc00c,\n\t       radeon_pm_off, radeon_reinitialize_M10),\n\tBUGFIX(\"Acer Aspire 2010\",\n\t       PCI_VENDOR_ID_AI, 0x0061,\n\t       radeon_pm_off, radeon_reinitialize_M10),\n\tBUGFIX(\"Acer Travelmate 290D/292LMi\",\n\t       PCI_VENDOR_ID_AI, 0x005a,\n\t       radeon_pm_off, radeon_reinitialize_M10),\n\t{ .ident = NULL }\n};\n\nstatic int radeon_apply_workarounds(struct radeonfb_info *rinfo)\n{\n\tstruct radeon_device_id *id;\n\n\tfor (id = radeon_workaround_list; id->ident != NULL; id++ )\n\t\tif ((id->subsystem_vendor == rinfo->pdev->subsystem_vendor ) &&\n\t\t    (id->subsystem_device == rinfo->pdev->subsystem_device )) {\n\n\t\t\t \n\t\t\tprintk(KERN_DEBUG \"radeonfb: %s detected\"\n\t\t\t       \", enabling workaround\\n\", id->ident);\n\n\t\t\trinfo->pm_mode |= id->pm_mode_modifier;\n\n\t\t\tif (id->new_reinit_func != NULL)\n\t\t\t\trinfo->reinit_func = id->new_reinit_func;\n\n\t\t\treturn 1;\n\t\t}\n\treturn 0;   \n}\n\n#else   \nstatic inline int radeon_apply_workarounds(struct radeonfb_info *rinfo)\n{\n        return 0;\n}\n#endif  \n\n\n\nstatic void radeon_pm_disable_dynamic_mode(struct radeonfb_info *rinfo)\n{\n\tu32 tmp;\n\n\t \n\tif ((rinfo->family == CHIP_FAMILY_RV100) && (!rinfo->is_mobility)) {\n\t\tif (rinfo->has_CRTC2) {\n\t\t\ttmp = INPLL(pllSCLK_CNTL);\n\t\t\ttmp &= ~SCLK_CNTL__DYN_STOP_LAT_MASK;\n\t\t\ttmp |= SCLK_CNTL__CP_MAX_DYN_STOP_LAT | SCLK_CNTL__FORCEON_MASK;\n\t\t\tOUTPLL(pllSCLK_CNTL, tmp);\n\t\t}\n\t\ttmp = INPLL(pllMCLK_CNTL);\n\t\ttmp |= (MCLK_CNTL__FORCE_MCLKA |\n\t\t        MCLK_CNTL__FORCE_MCLKB |\n\t\t        MCLK_CNTL__FORCE_YCLKA |\n\t\t        MCLK_CNTL__FORCE_YCLKB |\n\t\t\tMCLK_CNTL__FORCE_AIC |\n\t\t\tMCLK_CNTL__FORCE_MC);\n                OUTPLL(pllMCLK_CNTL, tmp);\n\t\treturn;\n\t}\n\t \n\tif (!rinfo->has_CRTC2) {\n                tmp = INPLL(pllSCLK_CNTL);\n                tmp |= (SCLK_CNTL__FORCE_CP\t| SCLK_CNTL__FORCE_HDP\t|\n\t\t\tSCLK_CNTL__FORCE_DISP1\t| SCLK_CNTL__FORCE_TOP\t|\n                        SCLK_CNTL__FORCE_E2\t| SCLK_CNTL__FORCE_SE \t|\n\t\t\tSCLK_CNTL__FORCE_IDCT\t| SCLK_CNTL__FORCE_VIP\t|\n\t\t\tSCLK_CNTL__FORCE_RE\t| SCLK_CNTL__FORCE_PB \t|\n\t\t\tSCLK_CNTL__FORCE_TAM\t| SCLK_CNTL__FORCE_TDM\t|\n                        SCLK_CNTL__FORCE_RB);\n                OUTPLL(pllSCLK_CNTL, tmp);\n\t\treturn;\n\t}\n\t \n\tif (rinfo->family == CHIP_FAMILY_RV350) {\n                 \n                tmp = INPLL(pllSCLK_CNTL2);\n                tmp |= (SCLK_CNTL2__R300_FORCE_TCL |\n                        SCLK_CNTL2__R300_FORCE_GA  |\n\t\t\tSCLK_CNTL2__R300_FORCE_CBA);\n                OUTPLL(pllSCLK_CNTL2, tmp);\n\n                tmp = INPLL(pllSCLK_CNTL);\n                tmp |= (SCLK_CNTL__FORCE_DISP2\t\t| SCLK_CNTL__FORCE_CP\t\t|\n                        SCLK_CNTL__FORCE_HDP\t\t| SCLK_CNTL__FORCE_DISP1\t|\n                        SCLK_CNTL__FORCE_TOP\t\t| SCLK_CNTL__FORCE_E2\t\t|\n                        SCLK_CNTL__R300_FORCE_VAP\t| SCLK_CNTL__FORCE_IDCT    \t|\n\t\t\tSCLK_CNTL__FORCE_VIP\t\t| SCLK_CNTL__R300_FORCE_SR\t|\n\t\t\tSCLK_CNTL__R300_FORCE_PX\t| SCLK_CNTL__R300_FORCE_TX\t|\n\t\t\tSCLK_CNTL__R300_FORCE_US\t| SCLK_CNTL__FORCE_TV_SCLK\t|\n                        SCLK_CNTL__R300_FORCE_SU\t| SCLK_CNTL__FORCE_OV0);\n                OUTPLL(pllSCLK_CNTL, tmp);\n\n                tmp = INPLL(pllSCLK_MORE_CNTL);\n\t\ttmp |= (SCLK_MORE_CNTL__FORCE_DISPREGS\t| SCLK_MORE_CNTL__FORCE_MC_GUI\t|\n\t\t\tSCLK_MORE_CNTL__FORCE_MC_HOST);\n                OUTPLL(pllSCLK_MORE_CNTL, tmp);\n\n\t\ttmp = INPLL(pllMCLK_CNTL);\n\t\ttmp |= (MCLK_CNTL__FORCE_MCLKA |\n\t\t        MCLK_CNTL__FORCE_MCLKB |\n\t\t        MCLK_CNTL__FORCE_YCLKA |\n\t\t        MCLK_CNTL__FORCE_YCLKB |\n\t\t\tMCLK_CNTL__FORCE_MC);\n                OUTPLL(pllMCLK_CNTL, tmp);\n\n                tmp = INPLL(pllVCLK_ECP_CNTL);\n                tmp &= ~(VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb  |\n                         VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb |\n\t\t\t VCLK_ECP_CNTL__R300_DISP_DAC_PIXCLK_DAC_BLANK_OFF);\n                OUTPLL(pllVCLK_ECP_CNTL, tmp);\n\n                tmp = INPLL(pllPIXCLKS_CNTL);\n                tmp &= ~(PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb\t|\n\t\t\t PIXCLKS_CNTL__R300_DVOCLK_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__R300_PIXCLK_DVO_ALWAYS_ONb\t|\n\t\t\t PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__R300_PIXCLK_TRANS_ALWAYS_ONb\t|\n\t\t\t PIXCLKS_CNTL__R300_PIXCLK_TVO_ALWAYS_ONb\t|\n\t\t\t PIXCLKS_CNTL__R300_P2G2CLK_ALWAYS_ONb\t\t|\n\t\t\t PIXCLKS_CNTL__R300_DISP_DAC_PIXCLK_DAC2_BLANK_OFF);\n                OUTPLL(pllPIXCLKS_CNTL, tmp);\n\n\t\treturn;\n\t}\n\t\n\t \n\n\t \n\ttmp = INPLL(pllSCLK_CNTL);\n\ttmp |= (SCLK_CNTL__FORCE_CP | SCLK_CNTL__FORCE_E2);\n\n\t \n\tif (rinfo->is_mobility) {\n\t\ttmp |= \tSCLK_CNTL__FORCE_HDP|\n\t\t\tSCLK_CNTL__FORCE_DISP1|\n\t\t\tSCLK_CNTL__FORCE_DISP2|\n\t\t\tSCLK_CNTL__FORCE_TOP|\n\t\t\tSCLK_CNTL__FORCE_SE|\n\t\t\tSCLK_CNTL__FORCE_IDCT|\n\t\t\tSCLK_CNTL__FORCE_VIP|\n\t\t\tSCLK_CNTL__FORCE_PB|\n\t\t\tSCLK_CNTL__FORCE_RE|\n\t\t\tSCLK_CNTL__FORCE_TAM|\n\t\t\tSCLK_CNTL__FORCE_TDM|\n\t\t\tSCLK_CNTL__FORCE_RB|\n\t\t\tSCLK_CNTL__FORCE_TV_SCLK|\n\t\t\tSCLK_CNTL__FORCE_SUBPIC|\n\t\t\tSCLK_CNTL__FORCE_OV0;\n\t}\n\telse if (rinfo->family == CHIP_FAMILY_R300 ||\n\t\t   rinfo->family == CHIP_FAMILY_R350) {\n\t\ttmp |=  SCLK_CNTL__FORCE_HDP   |\n\t\t\tSCLK_CNTL__FORCE_DISP1 |\n\t\t\tSCLK_CNTL__FORCE_DISP2 |\n\t\t\tSCLK_CNTL__FORCE_TOP   |\n\t\t\tSCLK_CNTL__FORCE_IDCT  |\n\t\t\tSCLK_CNTL__FORCE_VIP;\n\t}\n    \tOUTPLL(pllSCLK_CNTL, tmp);\n\tradeon_msleep(16);\n\n\tif (rinfo->family == CHIP_FAMILY_R300 || rinfo->family == CHIP_FAMILY_R350) {\n\t\ttmp = INPLL(pllSCLK_CNTL2);\n\t\ttmp |=  SCLK_CNTL2__R300_FORCE_TCL |\n\t\t\tSCLK_CNTL2__R300_FORCE_GA  |\n\t\t\tSCLK_CNTL2__R300_FORCE_CBA;\n\t\tOUTPLL(pllSCLK_CNTL2, tmp);\n\t\tradeon_msleep(16);\n\t}\n\n\ttmp = INPLL(pllCLK_PIN_CNTL);\n\ttmp &= ~CLK_PIN_CNTL__SCLK_DYN_START_CNTL;\n\tOUTPLL(pllCLK_PIN_CNTL, tmp);\n\tradeon_msleep(15);\n\n\tif (rinfo->is_IGP) {\n\t\t \n\t\ttmp = INPLL(pllMCLK_CNTL);\n\t\ttmp &= ~(MCLK_CNTL__FORCE_MCLKA |\n\t\t\t MCLK_CNTL__FORCE_YCLKA);\n\t\tOUTPLL(pllMCLK_CNTL, tmp);\n\t\tradeon_msleep(16);\n\t}\n\t \n\telse if (rinfo->is_mobility) {\n\t\ttmp = INPLL(pllMCLK_CNTL);\n\t\ttmp |= (MCLK_CNTL__FORCE_MCLKA |\n\t\t\tMCLK_CNTL__FORCE_MCLKB |\n\t\t\tMCLK_CNTL__FORCE_YCLKA |\n\t\t\tMCLK_CNTL__FORCE_YCLKB);\n\t\tOUTPLL(pllMCLK_CNTL, tmp);\n\t\tradeon_msleep(16);\n\n\t\ttmp = INPLL(pllMCLK_MISC);\n\t\ttmp &= \t~(MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT|\n\t\t\t  MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT|\n\t\t\t  MCLK_MISC__MC_MCLK_DYN_ENABLE|\n\t\t\t  MCLK_MISC__IO_MCLK_DYN_ENABLE);\n\t\tOUTPLL(pllMCLK_MISC, tmp);\n\t\tradeon_msleep(15);\n\t}\n\n\tif (rinfo->is_mobility) {\n\t\ttmp = INPLL(pllSCLK_MORE_CNTL);\n\t\ttmp |= \tSCLK_MORE_CNTL__FORCE_DISPREGS|\n\t\t\tSCLK_MORE_CNTL__FORCE_MC_GUI|\n\t\t\tSCLK_MORE_CNTL__FORCE_MC_HOST;\n\t\tOUTPLL(pllSCLK_MORE_CNTL, tmp);\n\t\tradeon_msleep(16);\n\t}\n\n\ttmp = INPLL(pllPIXCLKS_CNTL);\n\ttmp &= ~(PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb |\n\t\t PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb|\n\t\t PIXCLKS_CNTL__PIXCLK_DIG_TMDS_ALWAYS_ONb |\n\t\t PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb|\n\t\t PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb|\n\t\t PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb|\n\t\t PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb);\n \tOUTPLL(pllPIXCLKS_CNTL, tmp);\n\tradeon_msleep(16);\n\n\ttmp = INPLL( pllVCLK_ECP_CNTL);\n\ttmp &= ~(VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb |\n\t\t VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb);\n\tOUTPLL( pllVCLK_ECP_CNTL, tmp);\n\tradeon_msleep(16);\n}\n\nstatic void radeon_pm_enable_dynamic_mode(struct radeonfb_info *rinfo)\n{\n\tu32 tmp;\n\n\t \n\tif (!rinfo->has_CRTC2) {\n                tmp = INPLL(pllSCLK_CNTL);\n\n\t\tif ((INREG(CNFG_CNTL) & CFG_ATI_REV_ID_MASK) > CFG_ATI_REV_A13)\n                    tmp &= ~(SCLK_CNTL__FORCE_CP\t| SCLK_CNTL__FORCE_RB);\n                tmp &= ~(SCLK_CNTL__FORCE_HDP\t\t| SCLK_CNTL__FORCE_DISP1 |\n\t\t\t SCLK_CNTL__FORCE_TOP\t\t| SCLK_CNTL__FORCE_SE   |\n\t\t\t SCLK_CNTL__FORCE_IDCT\t\t| SCLK_CNTL__FORCE_RE   |\n\t\t\t SCLK_CNTL__FORCE_PB\t\t| SCLK_CNTL__FORCE_TAM  |\n\t\t\t SCLK_CNTL__FORCE_TDM);\n                OUTPLL(pllSCLK_CNTL, tmp);\n\t\treturn;\n\t}\n\n\t \n\tif (rinfo->family == CHIP_FAMILY_RV350) {\n\t\ttmp = INPLL(pllSCLK_CNTL2);\n\t\ttmp &= ~(SCLK_CNTL2__R300_FORCE_TCL |\n\t\t\t SCLK_CNTL2__R300_FORCE_GA  |\n\t\t\t SCLK_CNTL2__R300_FORCE_CBA);\n\t\ttmp |=  (SCLK_CNTL2__R300_TCL_MAX_DYN_STOP_LAT |\n\t\t\t SCLK_CNTL2__R300_GA_MAX_DYN_STOP_LAT  |\n\t\t\t SCLK_CNTL2__R300_CBA_MAX_DYN_STOP_LAT);\n\t\tOUTPLL(pllSCLK_CNTL2, tmp);\n\n\t\ttmp = INPLL(pllSCLK_CNTL);\n\t\ttmp &= ~(SCLK_CNTL__FORCE_DISP2 | SCLK_CNTL__FORCE_CP      |\n\t\t\t SCLK_CNTL__FORCE_HDP   | SCLK_CNTL__FORCE_DISP1   |\n\t\t\t SCLK_CNTL__FORCE_TOP   | SCLK_CNTL__FORCE_E2      |\n\t\t\t SCLK_CNTL__R300_FORCE_VAP | SCLK_CNTL__FORCE_IDCT |\n\t\t\t SCLK_CNTL__FORCE_VIP   | SCLK_CNTL__R300_FORCE_SR |\n\t\t\t SCLK_CNTL__R300_FORCE_PX | SCLK_CNTL__R300_FORCE_TX |\n\t\t\t SCLK_CNTL__R300_FORCE_US | SCLK_CNTL__FORCE_TV_SCLK |\n\t\t\t SCLK_CNTL__R300_FORCE_SU | SCLK_CNTL__FORCE_OV0);\n\t\ttmp |= SCLK_CNTL__DYN_STOP_LAT_MASK;\n\t\tOUTPLL(pllSCLK_CNTL, tmp);\n\n\t\ttmp = INPLL(pllSCLK_MORE_CNTL);\n\t\ttmp &= ~SCLK_MORE_CNTL__FORCEON;\n\t\ttmp |=  SCLK_MORE_CNTL__DISPREGS_MAX_DYN_STOP_LAT |\n\t\t\tSCLK_MORE_CNTL__MC_GUI_MAX_DYN_STOP_LAT |\n\t\t\tSCLK_MORE_CNTL__MC_HOST_MAX_DYN_STOP_LAT;\n\t\tOUTPLL(pllSCLK_MORE_CNTL, tmp);\n\n\t\ttmp = INPLL(pllVCLK_ECP_CNTL);\n\t\ttmp |= (VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb |\n\t\t\tVCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb);\n\t\tOUTPLL(pllVCLK_ECP_CNTL, tmp);\n\n\t\ttmp = INPLL(pllPIXCLKS_CNTL);\n\t\ttmp |= (PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb         |\n\t\t\tPIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb     |\n\t\t\tPIXCLKS_CNTL__DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb |\n\t\t\tPIXCLKS_CNTL__R300_DVOCLK_ALWAYS_ONb            |\n\t\t\tPIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb    |\n\t\t\tPIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb       |\n\t\t\tPIXCLKS_CNTL__R300_PIXCLK_DVO_ALWAYS_ONb        |\n\t\t\tPIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb     |\n\t\t\tPIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb     |\n\t\t\tPIXCLKS_CNTL__R300_PIXCLK_TRANS_ALWAYS_ONb      |\n\t\t\tPIXCLKS_CNTL__R300_PIXCLK_TVO_ALWAYS_ONb        |\n\t\t\tPIXCLKS_CNTL__R300_P2G2CLK_ALWAYS_ONb           |\n\t\t\tPIXCLKS_CNTL__R300_P2G2CLK_DAC_ALWAYS_ONb);\n\t\tOUTPLL(pllPIXCLKS_CNTL, tmp);\n\n\t\ttmp = INPLL(pllMCLK_MISC);\n\t\ttmp |= (MCLK_MISC__MC_MCLK_DYN_ENABLE |\n\t\t\tMCLK_MISC__IO_MCLK_DYN_ENABLE);\n\t\tOUTPLL(pllMCLK_MISC, tmp);\n\n\t\ttmp = INPLL(pllMCLK_CNTL);\n\t\ttmp |= (MCLK_CNTL__FORCE_MCLKA | MCLK_CNTL__FORCE_MCLKB);\n\t\ttmp &= ~(MCLK_CNTL__FORCE_YCLKA  |\n\t\t\t MCLK_CNTL__FORCE_YCLKB  |\n\t\t\t MCLK_CNTL__FORCE_MC);\n\n\t\t \n\t\tif ((tmp & MCLK_CNTL__R300_DISABLE_MC_MCLKA) &&\n\t\t    (tmp & MCLK_CNTL__R300_DISABLE_MC_MCLKB)) {\n\t\t\t \n\t\t\ttmp = INPLL(pllMCLK_CNTL);\n\t\t\tif (rinfo->vram_width == 64) {\n\t\t\t    if (INREG(MEM_CNTL) & R300_MEM_USE_CD_CH_ONLY)\n\t\t\t\ttmp &= ~MCLK_CNTL__R300_DISABLE_MC_MCLKB;\n\t\t\t    else\n\t\t\t\ttmp &= ~MCLK_CNTL__R300_DISABLE_MC_MCLKA;\n\t\t\t} else {\n\t\t\t    tmp &= ~(MCLK_CNTL__R300_DISABLE_MC_MCLKA |\n\t\t\t\t     MCLK_CNTL__R300_DISABLE_MC_MCLKB);\n\t\t\t}\n\t\t}\n\t\tOUTPLL(pllMCLK_CNTL, tmp);\n\t\treturn;\n\t}\n\n\t \n\tif (rinfo->family == CHIP_FAMILY_R300 || rinfo->family == CHIP_FAMILY_R350) {\n\t\ttmp = INPLL(pllSCLK_CNTL);\n\t\ttmp &= ~(SCLK_CNTL__R300_FORCE_VAP);\n\t\ttmp |= SCLK_CNTL__FORCE_CP;\n\t\tOUTPLL(pllSCLK_CNTL, tmp);\n\t\tradeon_msleep(15);\n\n\t\ttmp = INPLL(pllSCLK_CNTL2);\n\t\ttmp &= ~(SCLK_CNTL2__R300_FORCE_TCL |\n\t\t\t SCLK_CNTL2__R300_FORCE_GA  |\n\t\t\t SCLK_CNTL2__R300_FORCE_CBA);\n\t\tOUTPLL(pllSCLK_CNTL2, tmp);\n\t}\n\n\t \n\n\ttmp = INPLL( pllCLK_PWRMGT_CNTL);\n\ttmp &= ~(CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK|\n\t\t CLK_PWRMGT_CNTL__DISP_DYN_STOP_LAT_MASK|\n\t\t CLK_PWRMGT_CNTL__DYN_STOP_MODE_MASK);\n\ttmp |= CLK_PWRMGT_CNTL__ENGINE_DYNCLK_MODE_MASK |\n\t       (0x01 << CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT__SHIFT);\n\tOUTPLL( pllCLK_PWRMGT_CNTL, tmp);\n\tradeon_msleep(15);\n\n\ttmp = INPLL(pllCLK_PIN_CNTL);\n\ttmp |= CLK_PIN_CNTL__SCLK_DYN_START_CNTL;\n\tOUTPLL(pllCLK_PIN_CNTL, tmp);\n\tradeon_msleep(15);\n\n\t \n\ttmp = INPLL(pllSCLK_CNTL);\n\ttmp &= ~SCLK_CNTL__FORCEON_MASK;\n\n\t \n\tif ((rinfo->family == CHIP_FAMILY_RV250 &&\n\t     ((INREG(CNFG_CNTL) & CFG_ATI_REV_ID_MASK) < CFG_ATI_REV_A13)) ||\n\t    ((rinfo->family == CHIP_FAMILY_RV100) &&\n\t     ((INREG(CNFG_CNTL) & CFG_ATI_REV_ID_MASK) <= CFG_ATI_REV_A13))) {\n\t\ttmp |= SCLK_CNTL__FORCE_CP;\n\t\ttmp |= SCLK_CNTL__FORCE_VIP;\n\t}\n\tOUTPLL(pllSCLK_CNTL, tmp);\n\tradeon_msleep(15);\n\n\tif ((rinfo->family == CHIP_FAMILY_RV200) ||\n\t    (rinfo->family == CHIP_FAMILY_RV250) ||\n\t    (rinfo->family == CHIP_FAMILY_RV280)) {\n\t\ttmp = INPLL(pllSCLK_MORE_CNTL);\n\t\ttmp &= ~SCLK_MORE_CNTL__FORCEON;\n\n\t\t \n\t\tif (((rinfo->family == CHIP_FAMILY_RV200) ||\n\t\t     (rinfo->family == CHIP_FAMILY_RV250)) &&\n\t\t    ((INREG(CNFG_CNTL) & CFG_ATI_REV_ID_MASK) < CFG_ATI_REV_A13))\n\t\t\ttmp |= SCLK_MORE_CNTL__FORCEON;\n\n\t\tOUTPLL(pllSCLK_MORE_CNTL, tmp);\n\t\tradeon_msleep(15);\n\t}\n\t\n\n\t \n\tif (((rinfo->family == CHIP_FAMILY_RV200) ||\n\t     (rinfo->family == CHIP_FAMILY_RV250)) &&\n\t    ((INREG(CNFG_CNTL) & CFG_ATI_REV_ID_MASK) < CFG_ATI_REV_A13)) {\n\t\ttmp = INPLL(pllPLL_PWRMGT_CNTL);\n\t\ttmp |= PLL_PWRMGT_CNTL__TCL_BYPASS_DISABLE;\n\t\tOUTPLL(pllPLL_PWRMGT_CNTL, tmp);\n\t\tradeon_msleep(15);\n\t}\n\n\ttmp = INPLL(pllPIXCLKS_CNTL);\n\ttmp |=  PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb |\n\t\tPIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb|\n\t\tPIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb|\n\t\tPIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb|\n\t\tPIXCLKS_CNTL__PIXCLK_DIG_TMDS_ALWAYS_ONb|\n\t\tPIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb|\n\t\tPIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb;\n\tOUTPLL(pllPIXCLKS_CNTL, tmp);\n\tradeon_msleep(15);\n\t\t\n\ttmp = INPLL(pllVCLK_ECP_CNTL);\n\ttmp |=  VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb |\n\t\tVCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb;\n\tOUTPLL(pllVCLK_ECP_CNTL, tmp);\n\n\t \n#ifdef CONFIG_PPC\n\tif (rinfo->is_mobility) {\n\t\ttmp  = INPLL(pllMCLK_CNTL);\n\t\ttmp &= ~(MCLK_CNTL__FORCE_MCLKA |\n\t\t\t MCLK_CNTL__FORCE_MCLKB |\n\t\t\t MCLK_CNTL__FORCE_YCLKA |\n\t\t\t MCLK_CNTL__FORCE_YCLKB);\n\t\tOUTPLL(pllMCLK_CNTL, tmp);\n\t\tradeon_msleep(15);\n\n\t\ttmp = INPLL(pllMCLK_MISC);\n\t\ttmp |= \tMCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT|\n\t\t\tMCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT|\n\t\t\tMCLK_MISC__MC_MCLK_DYN_ENABLE|\n\t\t\tMCLK_MISC__IO_MCLK_DYN_ENABLE;\n\t\tOUTPLL(pllMCLK_MISC, tmp);\n\t\tradeon_msleep(15);\n\t}\n#endif  \n}\n\n#ifdef CONFIG_PM\n\nstatic void OUTMC( struct radeonfb_info *rinfo, u8 indx, u32 value)\n{\n\tOUTREG( MC_IND_INDEX, indx | MC_IND_INDEX__MC_IND_WR_EN);\t\n\tOUTREG( MC_IND_DATA, value);\t\t\n}\n\nstatic u32 INMC(struct radeonfb_info *rinfo, u8 indx)\n{\n\tOUTREG( MC_IND_INDEX, indx);\t\t\t\t\t\n\treturn INREG( MC_IND_DATA);\n}\n\nstatic void radeon_pm_save_regs(struct radeonfb_info *rinfo, int saving_for_d3)\n{\n\trinfo->save_regs[0] = INPLL(PLL_PWRMGT_CNTL);\n\trinfo->save_regs[1] = INPLL(CLK_PWRMGT_CNTL);\n\trinfo->save_regs[2] = INPLL(MCLK_CNTL);\n\trinfo->save_regs[3] = INPLL(SCLK_CNTL);\n\trinfo->save_regs[4] = INPLL(CLK_PIN_CNTL);\n\trinfo->save_regs[5] = INPLL(VCLK_ECP_CNTL);\n\trinfo->save_regs[6] = INPLL(PIXCLKS_CNTL);\n\trinfo->save_regs[7] = INPLL(MCLK_MISC);\n\trinfo->save_regs[8] = INPLL(P2PLL_CNTL);\n\t\n\trinfo->save_regs[9] = INREG(DISP_MISC_CNTL);\n\trinfo->save_regs[10] = INREG(DISP_PWR_MAN);\n\trinfo->save_regs[11] = INREG(LVDS_GEN_CNTL);\n\trinfo->save_regs[13] = INREG(TV_DAC_CNTL);\n\trinfo->save_regs[14] = INREG(BUS_CNTL1);\n\trinfo->save_regs[15] = INREG(CRTC_OFFSET_CNTL);\n\trinfo->save_regs[16] = INREG(AGP_CNTL);\n\trinfo->save_regs[17] = (INREG(CRTC_GEN_CNTL) & 0xfdffffff) | 0x04000000;\n\trinfo->save_regs[18] = (INREG(CRTC2_GEN_CNTL) & 0xfdffffff) | 0x04000000;\n\trinfo->save_regs[19] = INREG(GPIOPAD_A);\n\trinfo->save_regs[20] = INREG(GPIOPAD_EN);\n\trinfo->save_regs[21] = INREG(GPIOPAD_MASK);\n\trinfo->save_regs[22] = INREG(ZV_LCDPAD_A);\n\trinfo->save_regs[23] = INREG(ZV_LCDPAD_EN);\n\trinfo->save_regs[24] = INREG(ZV_LCDPAD_MASK);\n\trinfo->save_regs[25] = INREG(GPIO_VGA_DDC);\n\trinfo->save_regs[26] = INREG(GPIO_DVI_DDC);\n\trinfo->save_regs[27] = INREG(GPIO_MONID);\n\trinfo->save_regs[28] = INREG(GPIO_CRT2_DDC);\n\n\trinfo->save_regs[29] = INREG(SURFACE_CNTL);\n\trinfo->save_regs[30] = INREG(MC_FB_LOCATION);\n\trinfo->save_regs[31] = INREG(DISPLAY_BASE_ADDR);\n\trinfo->save_regs[32] = INREG(MC_AGP_LOCATION);\n\trinfo->save_regs[33] = INREG(CRTC2_DISPLAY_BASE_ADDR);\n\n\trinfo->save_regs[34] = INPLL(SCLK_MORE_CNTL);\n\trinfo->save_regs[35] = INREG(MEM_SDRAM_MODE_REG);\n\trinfo->save_regs[36] = INREG(BUS_CNTL);\n\trinfo->save_regs[39] = INREG(RBBM_CNTL);\n\trinfo->save_regs[40] = INREG(DAC_CNTL);\n\trinfo->save_regs[41] = INREG(HOST_PATH_CNTL);\n\trinfo->save_regs[37] = INREG(MPP_TB_CONFIG);\n\trinfo->save_regs[38] = INREG(FCP_CNTL);\n\n\tif (rinfo->is_mobility) {\n\t\trinfo->save_regs[12] = INREG(LVDS_PLL_CNTL);\n\t\trinfo->save_regs[43] = INPLL(pllSSPLL_CNTL);\n\t\trinfo->save_regs[44] = INPLL(pllSSPLL_REF_DIV);\n\t\trinfo->save_regs[45] = INPLL(pllSSPLL_DIV_0);\n\t\trinfo->save_regs[90] = INPLL(pllSS_INT_CNTL);\n\t\trinfo->save_regs[91] = INPLL(pllSS_TST_CNTL);\n\t\trinfo->save_regs[81] = INREG(LVDS_GEN_CNTL);\n\t}\n\n\tif (rinfo->family >= CHIP_FAMILY_RV200) {\n\t\trinfo->save_regs[42] = INREG(MEM_REFRESH_CNTL);\n\t\trinfo->save_regs[46] = INREG(MC_CNTL);\n\t\trinfo->save_regs[47] = INREG(MC_INIT_GFX_LAT_TIMER);\n\t\trinfo->save_regs[48] = INREG(MC_INIT_MISC_LAT_TIMER);\n\t\trinfo->save_regs[49] = INREG(MC_TIMING_CNTL);\n\t\trinfo->save_regs[50] = INREG(MC_READ_CNTL_AB);\n\t\trinfo->save_regs[51] = INREG(MC_IOPAD_CNTL);\n\t\trinfo->save_regs[52] = INREG(MC_CHIP_IO_OE_CNTL_AB);\n\t\trinfo->save_regs[53] = INREG(MC_DEBUG);\n\t}\n\trinfo->save_regs[54] = INREG(PAMAC0_DLY_CNTL);\n\trinfo->save_regs[55] = INREG(PAMAC1_DLY_CNTL);\n\trinfo->save_regs[56] = INREG(PAD_CTLR_MISC);\n\trinfo->save_regs[57] = INREG(FW_CNTL);\n\n\tif (rinfo->family >= CHIP_FAMILY_R300) {\n\t\trinfo->save_regs[58] = INMC(rinfo, ixR300_MC_MC_INIT_WR_LAT_TIMER);\n\t\trinfo->save_regs[59] = INMC(rinfo, ixR300_MC_IMP_CNTL);\n\t\trinfo->save_regs[60] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_C0);\n\t\trinfo->save_regs[61] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_C1);\n\t\trinfo->save_regs[62] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_D0);\n\t\trinfo->save_regs[63] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_D1);\n\t\trinfo->save_regs[64] = INMC(rinfo, ixR300_MC_BIST_CNTL_3);\n\t\trinfo->save_regs[65] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_A0);\n\t\trinfo->save_regs[66] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_A1);\n\t\trinfo->save_regs[67] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_B0);\n\t\trinfo->save_regs[68] = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_B1);\n\t\trinfo->save_regs[69] = INMC(rinfo, ixR300_MC_DEBUG_CNTL);\n\t\trinfo->save_regs[70] = INMC(rinfo, ixR300_MC_DLL_CNTL);\n\t\trinfo->save_regs[71] = INMC(rinfo, ixR300_MC_IMP_CNTL_0);\n\t\trinfo->save_regs[72] = INMC(rinfo, ixR300_MC_ELPIDA_CNTL);\n\t\trinfo->save_regs[96] = INMC(rinfo, ixR300_MC_READ_CNTL_CD);\n\t} else {\n\t\trinfo->save_regs[59] = INMC(rinfo, ixMC_IMP_CNTL);\n\t\trinfo->save_regs[65] = INMC(rinfo, ixMC_CHP_IO_CNTL_A0);\n\t\trinfo->save_regs[66] = INMC(rinfo, ixMC_CHP_IO_CNTL_A1);\n\t\trinfo->save_regs[67] = INMC(rinfo, ixMC_CHP_IO_CNTL_B0);\n\t\trinfo->save_regs[68] = INMC(rinfo, ixMC_CHP_IO_CNTL_B1);\n\t\trinfo->save_regs[71] = INMC(rinfo, ixMC_IMP_CNTL_0);\n\t}\n\n\trinfo->save_regs[73] = INPLL(pllMPLL_CNTL);\n\trinfo->save_regs[74] = INPLL(pllSPLL_CNTL);\n\trinfo->save_regs[75] = INPLL(pllMPLL_AUX_CNTL);\n\trinfo->save_regs[76] = INPLL(pllSPLL_AUX_CNTL);\n\trinfo->save_regs[77] = INPLL(pllM_SPLL_REF_FB_DIV);\n\trinfo->save_regs[78] = INPLL(pllAGP_PLL_CNTL);\n\trinfo->save_regs[79] = INREG(PAMAC2_DLY_CNTL);\n\n\trinfo->save_regs[80] = INREG(OV0_BASE_ADDR);\n\trinfo->save_regs[82] = INREG(FP_GEN_CNTL);\n\trinfo->save_regs[83] = INREG(FP2_GEN_CNTL);\n\trinfo->save_regs[84] = INREG(TMDS_CNTL);\n\trinfo->save_regs[85] = INREG(TMDS_TRANSMITTER_CNTL);\n\trinfo->save_regs[86] = INREG(DISP_OUTPUT_CNTL);\n\trinfo->save_regs[87] = INREG(DISP_HW_DEBUG);\n\trinfo->save_regs[88] = INREG(TV_MASTER_CNTL);\n\trinfo->save_regs[89] = INPLL(pllP2PLL_REF_DIV);\n\trinfo->save_regs[92] = INPLL(pllPPLL_DIV_0);\n\trinfo->save_regs[93] = INPLL(pllPPLL_CNTL);\n\trinfo->save_regs[94] = INREG(GRPH_BUFFER_CNTL);\n\trinfo->save_regs[95] = INREG(GRPH2_BUFFER_CNTL);\n\trinfo->save_regs[96] = INREG(HDP_DEBUG);\n\trinfo->save_regs[97] = INPLL(pllMDLL_CKO);\n\trinfo->save_regs[98] = INPLL(pllMDLL_RDCKA);\n\trinfo->save_regs[99] = INPLL(pllMDLL_RDCKB);\n}\n\nstatic void radeon_pm_restore_regs(struct radeonfb_info *rinfo)\n{\n\tOUTPLL(P2PLL_CNTL, rinfo->save_regs[8] & 0xFFFFFFFE);  \n\t\n\tOUTPLL(PLL_PWRMGT_CNTL, rinfo->save_regs[0]);\n\tOUTPLL(CLK_PWRMGT_CNTL, rinfo->save_regs[1]);\n\tOUTPLL(MCLK_CNTL, rinfo->save_regs[2]);\n\tOUTPLL(SCLK_CNTL, rinfo->save_regs[3]);\n\tOUTPLL(CLK_PIN_CNTL, rinfo->save_regs[4]);\n\tOUTPLL(VCLK_ECP_CNTL, rinfo->save_regs[5]);\n\tOUTPLL(PIXCLKS_CNTL, rinfo->save_regs[6]);\n\tOUTPLL(MCLK_MISC, rinfo->save_regs[7]);\n\tif (rinfo->family == CHIP_FAMILY_RV350)\n\t\tOUTPLL(SCLK_MORE_CNTL, rinfo->save_regs[34]);\n\n\tOUTREG(SURFACE_CNTL, rinfo->save_regs[29]);\n\tOUTREG(MC_FB_LOCATION, rinfo->save_regs[30]);\n\tOUTREG(DISPLAY_BASE_ADDR, rinfo->save_regs[31]);\n\tOUTREG(MC_AGP_LOCATION, rinfo->save_regs[32]);\n\tOUTREG(CRTC2_DISPLAY_BASE_ADDR, rinfo->save_regs[33]);\n\tOUTREG(CNFG_MEMSIZE, rinfo->video_ram);\n\n\tOUTREG(DISP_MISC_CNTL, rinfo->save_regs[9]);\n\tOUTREG(DISP_PWR_MAN, rinfo->save_regs[10]);\n\tOUTREG(LVDS_GEN_CNTL, rinfo->save_regs[11]);\n\tOUTREG(LVDS_PLL_CNTL,rinfo->save_regs[12]);\n\tOUTREG(TV_DAC_CNTL, rinfo->save_regs[13]);\n\tOUTREG(BUS_CNTL1, rinfo->save_regs[14]);\n\tOUTREG(CRTC_OFFSET_CNTL, rinfo->save_regs[15]);\n\tOUTREG(AGP_CNTL, rinfo->save_regs[16]);\n\tOUTREG(CRTC_GEN_CNTL, rinfo->save_regs[17]);\n\tOUTREG(CRTC2_GEN_CNTL, rinfo->save_regs[18]);\n\tOUTPLL(P2PLL_CNTL, rinfo->save_regs[8]);\n\n\tOUTREG(GPIOPAD_A, rinfo->save_regs[19]);\n\tOUTREG(GPIOPAD_EN, rinfo->save_regs[20]);\n\tOUTREG(GPIOPAD_MASK, rinfo->save_regs[21]);\n\tOUTREG(ZV_LCDPAD_A, rinfo->save_regs[22]);\n\tOUTREG(ZV_LCDPAD_EN, rinfo->save_regs[23]);\n\tOUTREG(ZV_LCDPAD_MASK, rinfo->save_regs[24]);\n\tOUTREG(GPIO_VGA_DDC, rinfo->save_regs[25]);\n\tOUTREG(GPIO_DVI_DDC, rinfo->save_regs[26]);\n\tOUTREG(GPIO_MONID, rinfo->save_regs[27]);\n\tOUTREG(GPIO_CRT2_DDC, rinfo->save_regs[28]);\n}\n\nstatic void radeon_pm_disable_iopad(struct radeonfb_info *rinfo)\n{\t\t\n\tOUTREG(GPIOPAD_MASK, 0x0001ffff);\n\tOUTREG(GPIOPAD_EN, 0x00000400);\n\tOUTREG(GPIOPAD_A, 0x00000000);\t\t\n        OUTREG(ZV_LCDPAD_MASK, 0x00000000);\n        OUTREG(ZV_LCDPAD_EN, 0x00000000);\n      \tOUTREG(ZV_LCDPAD_A, 0x00000000); \t\n\tOUTREG(GPIO_VGA_DDC, 0x00030000);\n\tOUTREG(GPIO_DVI_DDC, 0x00000000);\n\tOUTREG(GPIO_MONID, 0x00030000);\n\tOUTREG(GPIO_CRT2_DDC, 0x00000000);\n}\n\nstatic void radeon_pm_program_v2clk(struct radeonfb_info *rinfo)\n{\n\t \n\tif (rinfo->family <= CHIP_FAMILY_RV280) {\n\t\tOUTPLL(pllPIXCLKS_CNTL,\n\t\t\t __INPLL(rinfo, pllPIXCLKS_CNTL)\n\t\t\t & ~PIXCLKS_CNTL__PIX2CLK_SRC_SEL_MASK);\n\t \n\t\tOUTPLL(pllP2PLL_REF_DIV, 0x0000000c);\n\t\tOUTPLL(pllP2PLL_CNTL, 0x0000bf00);\n\t} else {\n\t\tOUTPLL(pllP2PLL_REF_DIV, 0x0000000c);\n\t\tINPLL(pllP2PLL_REF_DIV);\n\t\tOUTPLL(pllP2PLL_CNTL, 0x0000a700);\n\t}\n\n\tOUTPLL(pllP2PLL_DIV_0, 0x00020074 | P2PLL_DIV_0__P2PLL_ATOMIC_UPDATE_W);\n\t\n\tOUTPLL(pllP2PLL_CNTL, INPLL(pllP2PLL_CNTL) & ~P2PLL_CNTL__P2PLL_SLEEP);\n\tmdelay(1);\n\n\tOUTPLL(pllP2PLL_CNTL, INPLL(pllP2PLL_CNTL) & ~P2PLL_CNTL__P2PLL_RESET);\n\tmdelay( 1);\n\n  \tOUTPLL(pllPIXCLKS_CNTL,\n  \t\t(INPLL(pllPIXCLKS_CNTL) & ~PIXCLKS_CNTL__PIX2CLK_SRC_SEL_MASK)\n  \t\t| (0x03 << PIXCLKS_CNTL__PIX2CLK_SRC_SEL__SHIFT));\n\tmdelay( 1);\t\n}\n\nstatic void radeon_pm_low_current(struct radeonfb_info *rinfo)\n{\n\tu32 reg;\n\n\treg  = INREG(BUS_CNTL1);\n\tif (rinfo->family <= CHIP_FAMILY_RV280) {\n\t\treg &= ~BUS_CNTL1_MOBILE_PLATFORM_SEL_MASK;\n\t\treg |= BUS_CNTL1_AGPCLK_VALID | (1<<BUS_CNTL1_MOBILE_PLATFORM_SEL_SHIFT);\n\t} else {\n\t\treg |= 0x4080;\n\t}\n\tOUTREG(BUS_CNTL1, reg);\n\t\n\treg  = INPLL(PLL_PWRMGT_CNTL);\n\treg |= PLL_PWRMGT_CNTL_SPLL_TURNOFF | PLL_PWRMGT_CNTL_PPLL_TURNOFF |\n\t\tPLL_PWRMGT_CNTL_P2PLL_TURNOFF | PLL_PWRMGT_CNTL_TVPLL_TURNOFF;\n\treg &= ~PLL_PWRMGT_CNTL_SU_MCLK_USE_BCLK;\n\treg &= ~PLL_PWRMGT_CNTL_MOBILE_SU;\n\tOUTPLL(PLL_PWRMGT_CNTL, reg);\n\t\n\treg  = INREG(TV_DAC_CNTL);\n\treg &= ~(TV_DAC_CNTL_BGADJ_MASK |TV_DAC_CNTL_DACADJ_MASK);\n\treg |=TV_DAC_CNTL_BGSLEEP | TV_DAC_CNTL_RDACPD | TV_DAC_CNTL_GDACPD |\n\t\tTV_DAC_CNTL_BDACPD |\n\t\t(8<<TV_DAC_CNTL_BGADJ__SHIFT) | (8<<TV_DAC_CNTL_DACADJ__SHIFT);\n\tOUTREG(TV_DAC_CNTL, reg);\n\t\n\treg  = INREG(TMDS_TRANSMITTER_CNTL);\n\treg &= ~(TMDS_PLL_EN | TMDS_PLLRST);\n\tOUTREG(TMDS_TRANSMITTER_CNTL, reg);\n\n\treg = INREG(DAC_CNTL);\n\treg &= ~DAC_CMP_EN;\n\tOUTREG(DAC_CNTL, reg);\n\n\treg = INREG(DAC_CNTL2);\n\treg &= ~DAC2_CMP_EN;\n\tOUTREG(DAC_CNTL2, reg);\n\t\n\treg  = INREG(TV_DAC_CNTL);\n\treg &= ~TV_DAC_CNTL_DETECT;\n\tOUTREG(TV_DAC_CNTL, reg);\n}\n\nstatic void radeon_pm_setup_for_suspend(struct radeonfb_info *rinfo)\n{\n\n\tu32 sclk_cntl, mclk_cntl, sclk_more_cntl;\n\n\tu32 pll_pwrmgt_cntl;\n\tu32 clk_pwrmgt_cntl;\n\tu32 clk_pin_cntl;\n\tu32 vclk_ecp_cntl; \n\tu32 pixclks_cntl;\n\tu32 disp_mis_cntl;\n\tu32 disp_pwr_man;\n\tu32 tmp;\n\t\n\t \n\tsclk_cntl = INPLL( pllSCLK_CNTL);\n\tsclk_cntl |= \tSCLK_CNTL__IDCT_MAX_DYN_STOP_LAT|\n\t\t\tSCLK_CNTL__VIP_MAX_DYN_STOP_LAT|\n\t\t\tSCLK_CNTL__RE_MAX_DYN_STOP_LAT|\n\t\t\tSCLK_CNTL__PB_MAX_DYN_STOP_LAT|\n\t\t\tSCLK_CNTL__TAM_MAX_DYN_STOP_LAT|\n\t\t\tSCLK_CNTL__TDM_MAX_DYN_STOP_LAT|\n\t\t\tSCLK_CNTL__RB_MAX_DYN_STOP_LAT|\n\t\t\t\n\t\t\tSCLK_CNTL__FORCE_DISP2|\n\t\t\tSCLK_CNTL__FORCE_CP|\n\t\t\tSCLK_CNTL__FORCE_HDP|\n\t\t\tSCLK_CNTL__FORCE_DISP1|\n\t\t\tSCLK_CNTL__FORCE_TOP|\n\t\t\tSCLK_CNTL__FORCE_E2|\n\t\t\tSCLK_CNTL__FORCE_SE|\n\t\t\tSCLK_CNTL__FORCE_IDCT|\n\t\t\tSCLK_CNTL__FORCE_VIP|\n\t\t\t\n\t\t\tSCLK_CNTL__FORCE_PB|\n\t\t\tSCLK_CNTL__FORCE_TAM|\n\t\t\tSCLK_CNTL__FORCE_TDM|\n\t\t\tSCLK_CNTL__FORCE_RB|\n\t\t\tSCLK_CNTL__FORCE_TV_SCLK|\n\t\t\tSCLK_CNTL__FORCE_SUBPIC|\n\t\t\tSCLK_CNTL__FORCE_OV0;\n\tif (rinfo->family <= CHIP_FAMILY_RV280)\n\t\tsclk_cntl |= SCLK_CNTL__FORCE_RE;\n\telse\n\t\tsclk_cntl |= SCLK_CNTL__SE_MAX_DYN_STOP_LAT |\n\t\t\tSCLK_CNTL__E2_MAX_DYN_STOP_LAT |\n\t\t\tSCLK_CNTL__TV_MAX_DYN_STOP_LAT |\n\t\t\tSCLK_CNTL__HDP_MAX_DYN_STOP_LAT |\n\t\t\tSCLK_CNTL__CP_MAX_DYN_STOP_LAT;\n\n\tOUTPLL( pllSCLK_CNTL, sclk_cntl);\n\n\tsclk_more_cntl = INPLL(pllSCLK_MORE_CNTL);\n\tsclk_more_cntl |= \tSCLK_MORE_CNTL__FORCE_DISPREGS |\n\t\t\t\tSCLK_MORE_CNTL__FORCE_MC_GUI |\n\t\t\t\tSCLK_MORE_CNTL__FORCE_MC_HOST;\n\n\tOUTPLL(pllSCLK_MORE_CNTL, sclk_more_cntl);\t\t\n\n\t\n\tmclk_cntl = INPLL( pllMCLK_CNTL);\n\tmclk_cntl &= ~(\tMCLK_CNTL__FORCE_MCLKA |\n\t\t\tMCLK_CNTL__FORCE_MCLKB |\n\t\t\tMCLK_CNTL__FORCE_YCLKA |\n\t\t\tMCLK_CNTL__FORCE_YCLKB |\n\t\t\tMCLK_CNTL__FORCE_MC\n\t\t      );\t\n    \tOUTPLL( pllMCLK_CNTL, mclk_cntl);\n\t\n\t \n\tvclk_ecp_cntl = INPLL( pllVCLK_ECP_CNTL);\n\tvclk_ecp_cntl &= ~(VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb\n\t\t\t   | VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb);\n\tvclk_ecp_cntl |= VCLK_ECP_CNTL__ECP_FORCE_ON;\n\tOUTPLL( pllVCLK_ECP_CNTL, vclk_ecp_cntl);\n\t\n\t\n\tpixclks_cntl = INPLL( pllPIXCLKS_CNTL);\n\tpixclks_cntl &= ~(\tPIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb | \n\t\t\t\tPIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb|\n\t\t\t\tPIXCLKS_CNTL__PIXCLK_DIG_TMDS_ALWAYS_ONb |\n\t\t\t\tPIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb|\n\t\t\t\tPIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb|\n\t\t\t\tPIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb|\n\t\t\t\tPIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb);\n\t\t\t\t\t\t\n \tOUTPLL( pllPIXCLKS_CNTL, pixclks_cntl);\n\n\t \n\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) &\n\t       ~(LVDS_BLON | LVDS_EN | LVDS_ON | LVDS_DIGON));\n\n\t \n\tpll_pwrmgt_cntl = INPLL( pllPLL_PWRMGT_CNTL);\n\t\n\tpll_pwrmgt_cntl |= \tPLL_PWRMGT_CNTL__SPLL_TURNOFF |\n\t\t\t\tPLL_PWRMGT_CNTL__MPLL_TURNOFF|\n\t\t\t\tPLL_PWRMGT_CNTL__PPLL_TURNOFF|\n\t\t\t\tPLL_PWRMGT_CNTL__P2PLL_TURNOFF|\n\t\t\t\tPLL_PWRMGT_CNTL__TVPLL_TURNOFF;\n\t\t\t\t\t\t\n\tOUTPLL( pllPLL_PWRMGT_CNTL, pll_pwrmgt_cntl);\n\t\n\tclk_pwrmgt_cntl\t = INPLL( pllCLK_PWRMGT_CNTL);\n\t\n\tclk_pwrmgt_cntl &= ~(\tCLK_PWRMGT_CNTL__MPLL_PWRMGT_OFF|\n\t\t\t\tCLK_PWRMGT_CNTL__SPLL_PWRMGT_OFF|\n\t\t\t\tCLK_PWRMGT_CNTL__PPLL_PWRMGT_OFF|\n\t\t\t\tCLK_PWRMGT_CNTL__P2PLL_PWRMGT_OFF|\n\t\t\t\tCLK_PWRMGT_CNTL__MCLK_TURNOFF|\n\t\t\t\tCLK_PWRMGT_CNTL__SCLK_TURNOFF|\n\t\t\t\tCLK_PWRMGT_CNTL__PCLK_TURNOFF|\n\t\t\t\tCLK_PWRMGT_CNTL__P2CLK_TURNOFF|\n\t\t\t\tCLK_PWRMGT_CNTL__TVPLL_PWRMGT_OFF|\n\t\t\t\tCLK_PWRMGT_CNTL__GLOBAL_PMAN_EN|\n\t\t\t\tCLK_PWRMGT_CNTL__ENGINE_DYNCLK_MODE|\n\t\t\t\tCLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK|\n\t\t\t\tCLK_PWRMGT_CNTL__CG_NO1_DEBUG_MASK\n\t\t\t);\n\t\t\t\t\t\t\n\tclk_pwrmgt_cntl |= CLK_PWRMGT_CNTL__GLOBAL_PMAN_EN\n\t\t| CLK_PWRMGT_CNTL__DISP_PM;\n\t\n\tOUTPLL( pllCLK_PWRMGT_CNTL, clk_pwrmgt_cntl);\n\t\n\tclk_pin_cntl = INPLL( pllCLK_PIN_CNTL);\n\t\n\tclk_pin_cntl &= ~CLK_PIN_CNTL__ACCESS_REGS_IN_SUSPEND;\n\n\t \n\ttmp = INPLL( pllMCLK_MISC) | MCLK_MISC__EN_MCLK_TRISTATE_IN_SUSPEND;\n\tOUTPLL( pllMCLK_MISC, tmp);\n\n\t \n#ifdef CONFIG_PPC_PMAC\n\tif (machine_is(powermac)) {\n\t\t \n\t\tif (rinfo->family <= CHIP_FAMILY_RV280) {\n\t\t\tOUTREG(BUS_CNTL1, INREG(BUS_CNTL1) |  BUS_CNTL1__AGPCLK_VALID);\n\t\t\tOUTREG(BUS_CNTL1,\n\t\t\t       (INREG(BUS_CNTL1) & ~BUS_CNTL1__MOBILE_PLATFORM_SEL_MASK)\n\t\t\t       | (2<<BUS_CNTL1__MOBILE_PLATFORM_SEL__SHIFT));\t \n\t\t} else {\n\t\t\tOUTREG(BUS_CNTL1, INREG(BUS_CNTL1));\n\t\t\tOUTREG(BUS_CNTL1, (INREG(BUS_CNTL1) & ~0x4000) | 0x8000);\n\t\t}\n\t}\n#endif\n\n\tOUTREG(CRTC_OFFSET_CNTL, (INREG(CRTC_OFFSET_CNTL)\n\t\t\t\t  & ~CRTC_OFFSET_CNTL__CRTC_STEREO_SYNC_OUT_EN));\n\t\n\tclk_pin_cntl &= ~CLK_PIN_CNTL__CG_CLK_TO_OUTPIN;\n\tclk_pin_cntl |= CLK_PIN_CNTL__XTALIN_ALWAYS_ONb;\t\n\tOUTPLL( pllCLK_PIN_CNTL, clk_pin_cntl);\n\n\t \n\tOUTREG(AGP_CNTL,\n\t\t(INREG(AGP_CNTL) & ~(AGP_CNTL__MAX_IDLE_CLK_MASK))\n\t\t| (0x20<<AGP_CNTL__MAX_IDLE_CLK__SHIFT));\n\n\t \n\t \n\ttmp = INPLL( pllPLL_PWRMGT_CNTL) & ~PLL_PWRMGT_CNTL__PM_MODE_SEL;\n\tOUTPLL( pllPLL_PWRMGT_CNTL, tmp);\n\n\n\tdisp_mis_cntl = INREG(DISP_MISC_CNTL);\n\t\n\tdisp_mis_cntl &= ~(\tDISP_MISC_CNTL__SOFT_RESET_GRPH_PP | \n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_SUBPIC_PP | \n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_OV0_PP |\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_GRPH_SCLK|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_SUBPIC_SCLK|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_OV0_SCLK|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_GRPH2_PP|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_GRPH2_SCLK|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_LVDS|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_TMDS|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_DIG_TMDS|\n\t\t\t\tDISP_MISC_CNTL__SOFT_RESET_TV);\n\t\n\tOUTREG(DISP_MISC_CNTL, disp_mis_cntl);\n\t\t\t\t\t\t\n\tdisp_pwr_man = INREG(DISP_PWR_MAN);\n\t\n\tdisp_pwr_man &= ~(\tDISP_PWR_MAN__DISP_PWR_MAN_D3_CRTC_EN\t| \n\t\t\t\tDISP_PWR_MAN__DISP2_PWR_MAN_D3_CRTC2_EN |\n\t\t\t\tDISP_PWR_MAN__DISP_PWR_MAN_DPMS_MASK|\n\t\t\t\tDISP_PWR_MAN__DISP_D3_RST|\n\t\t\t\tDISP_PWR_MAN__DISP_D3_REG_RST\n\t\t\t\t);\n\t\n\tdisp_pwr_man |= DISP_PWR_MAN__DISP_D3_GRPH_RST|\n\t\t\t\t\tDISP_PWR_MAN__DISP_D3_SUBPIC_RST|\n\t\t\t\t\tDISP_PWR_MAN__DISP_D3_OV0_RST|\n\t\t\t\t\tDISP_PWR_MAN__DISP_D1D2_GRPH_RST|\n\t\t\t\t\tDISP_PWR_MAN__DISP_D1D2_SUBPIC_RST|\n\t\t\t\t\tDISP_PWR_MAN__DISP_D1D2_OV0_RST|\n\t\t\t\t\tDISP_PWR_MAN__DIG_TMDS_ENABLE_RST|\n\t\t\t\t\tDISP_PWR_MAN__TV_ENABLE_RST| \n\n\t\t\t\t\t0;\n\t\n\tOUTREG(DISP_PWR_MAN, disp_pwr_man);\t\t\t\t\t\n\t\t\t\t\t\t\t\n\tclk_pwrmgt_cntl = INPLL( pllCLK_PWRMGT_CNTL);\n\tpll_pwrmgt_cntl = INPLL( pllPLL_PWRMGT_CNTL) ;\n\tclk_pin_cntl \t= INPLL( pllCLK_PIN_CNTL);\n\tdisp_pwr_man\t= INREG(DISP_PWR_MAN);\n\t\t\n\t\n\t \n\tclk_pwrmgt_cntl |= CLK_PWRMGT_CNTL__DISP_PM;\n\tpll_pwrmgt_cntl |= PLL_PWRMGT_CNTL__MOBILE_SU | PLL_PWRMGT_CNTL__SU_SCLK_USE_BCLK;\n\tclk_pin_cntl\t|= CLK_PIN_CNTL__XTALIN_ALWAYS_ONb;\n\tdisp_pwr_man \t&= ~(DISP_PWR_MAN__DISP_PWR_MAN_D3_CRTC_EN_MASK\n\t\t\t     | DISP_PWR_MAN__DISP2_PWR_MAN_D3_CRTC2_EN_MASK);\n\n\tOUTPLL( pllCLK_PWRMGT_CNTL, clk_pwrmgt_cntl);\n\tOUTPLL( pllPLL_PWRMGT_CNTL, pll_pwrmgt_cntl);\n\tOUTPLL( pllCLK_PIN_CNTL, clk_pin_cntl);\n\tOUTREG(DISP_PWR_MAN, disp_pwr_man);\n\n\t \n\tOUTREG( CRTC_GEN_CNTL, (INREG( CRTC_GEN_CNTL) & ~CRTC_GEN_CNTL__CRTC_EN)\n\t\t| CRTC_GEN_CNTL__CRTC_DISP_REQ_EN_B);\n\tOUTREG( CRTC2_GEN_CNTL, (INREG( CRTC2_GEN_CNTL) & ~CRTC2_GEN_CNTL__CRTC2_EN)\n\t\t| CRTC2_GEN_CNTL__CRTC2_DISP_REQ_EN_B);\n\n\tmdelay(17);\t\t\t\t   \n\n}\n\nstatic void radeon_pm_yclk_mclk_sync(struct radeonfb_info *rinfo)\n{\n\tu32 mc_chp_io_cntl_a1, mc_chp_io_cntl_b1;\n\n\tmc_chp_io_cntl_a1 = INMC( rinfo, ixMC_CHP_IO_CNTL_A1)\n\t\t& ~MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA_MASK;\n\tmc_chp_io_cntl_b1 = INMC( rinfo, ixMC_CHP_IO_CNTL_B1)\n\t\t& ~MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB_MASK;\n\n\tOUTMC( rinfo, ixMC_CHP_IO_CNTL_A1, mc_chp_io_cntl_a1\n\t       | (1<<MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA__SHIFT));\n\tOUTMC( rinfo, ixMC_CHP_IO_CNTL_B1, mc_chp_io_cntl_b1\n\t       | (1<<MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB__SHIFT));\n\n\tOUTMC( rinfo, ixMC_CHP_IO_CNTL_A1, mc_chp_io_cntl_a1);\n\tOUTMC( rinfo, ixMC_CHP_IO_CNTL_B1, mc_chp_io_cntl_b1);\n\n\tmdelay( 1);\n}\n\nstatic void radeon_pm_yclk_mclk_sync_m10(struct radeonfb_info *rinfo)\n{\n\tu32 mc_chp_io_cntl_a1, mc_chp_io_cntl_b1;\n\n\tmc_chp_io_cntl_a1 = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_A1)\n\t\t& ~MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA_MASK;\n\tmc_chp_io_cntl_b1 = INMC(rinfo, ixR300_MC_CHP_IO_CNTL_B1)\n\t\t& ~MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB_MASK;\n\n\tOUTMC( rinfo, ixR300_MC_CHP_IO_CNTL_A1,\n\t       mc_chp_io_cntl_a1 | (1<<MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA__SHIFT));\n\tOUTMC( rinfo, ixR300_MC_CHP_IO_CNTL_B1,\n\t       mc_chp_io_cntl_b1 | (1<<MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB__SHIFT));\n\n\tOUTMC( rinfo, ixR300_MC_CHP_IO_CNTL_A1, mc_chp_io_cntl_a1);\n\tOUTMC( rinfo, ixR300_MC_CHP_IO_CNTL_B1, mc_chp_io_cntl_b1);\n\n\tmdelay( 1);\n}\n\nstatic void radeon_pm_program_mode_reg(struct radeonfb_info *rinfo, u16 value,\n\t\t\t\t       u8 delay_required)\n{  \n\tu32 mem_sdram_mode;\n\n\tmem_sdram_mode  = INREG( MEM_SDRAM_MODE_REG);\n\n\tmem_sdram_mode &= ~MEM_SDRAM_MODE_REG__MEM_MODE_REG_MASK;\n\tmem_sdram_mode |= (value<<MEM_SDRAM_MODE_REG__MEM_MODE_REG__SHIFT)\n\t\t| MEM_SDRAM_MODE_REG__MEM_CFG_TYPE;\n\tOUTREG( MEM_SDRAM_MODE_REG, mem_sdram_mode);\n\tif (delay_required >= 2)\n\t\tmdelay(1);\n\n\tmem_sdram_mode |=  MEM_SDRAM_MODE_REG__MEM_SDRAM_RESET;\n\tOUTREG( MEM_SDRAM_MODE_REG, mem_sdram_mode);\n\tif (delay_required >= 2)\n\t\tmdelay(1);\n\n\tmem_sdram_mode &= ~MEM_SDRAM_MODE_REG__MEM_SDRAM_RESET;\n\tOUTREG( MEM_SDRAM_MODE_REG, mem_sdram_mode);\n\tif (delay_required >= 2)\n\t\tmdelay(1);\n\n\tif (delay_required) {\n\t\tdo {\n\t\t\tif (delay_required >= 2)\n\t\t\t\tmdelay(1);\n\t\t} while ((INREG(MC_STATUS)\n\t\t\t  & (MC_STATUS__MEM_PWRUP_COMPL_A |\n\t\t\t     MC_STATUS__MEM_PWRUP_COMPL_B)) == 0);\n\t}\n}\n\nstatic void radeon_pm_m10_program_mode_wait(struct radeonfb_info *rinfo)\n{\n\tint cnt;\n\n\tfor (cnt = 0; cnt < 100; ++cnt) {\n\t\tmdelay(1);\n\t\tif (INREG(MC_STATUS) & (MC_STATUS__MEM_PWRUP_COMPL_A\n\t\t\t\t\t| MC_STATUS__MEM_PWRUP_COMPL_B))\n\t\t\tbreak;\n\t}\n}\n\n\nstatic void radeon_pm_enable_dll(struct radeonfb_info *rinfo)\n{  \n#define DLL_RESET_DELAY \t5\n#define DLL_SLEEP_DELAY\t\t1\n\n\tu32 cko = INPLL(pllMDLL_CKO)   | MDLL_CKO__MCKOA_SLEEP\n\t\t| MDLL_CKO__MCKOA_RESET;\n\tu32 cka = INPLL(pllMDLL_RDCKA) | MDLL_RDCKA__MRDCKA0_SLEEP\n\t\t| MDLL_RDCKA__MRDCKA1_SLEEP | MDLL_RDCKA__MRDCKA0_RESET\n\t\t| MDLL_RDCKA__MRDCKA1_RESET;\n\tu32 ckb = INPLL(pllMDLL_RDCKB) | MDLL_RDCKB__MRDCKB0_SLEEP\n\t\t| MDLL_RDCKB__MRDCKB1_SLEEP | MDLL_RDCKB__MRDCKB0_RESET\n\t\t| MDLL_RDCKB__MRDCKB1_RESET;\n\n\t \n\tOUTPLL(pllMDLL_CKO,   \tcko);\n\tOUTPLL(pllMDLL_RDCKA,  \tcka);\n\tOUTPLL(pllMDLL_RDCKB,\tckb);\n\n\tmdelay(DLL_RESET_DELAY*2);\n\n\tcko &= ~(MDLL_CKO__MCKOA_SLEEP | MDLL_CKO__MCKOB_SLEEP);\n\tOUTPLL(pllMDLL_CKO, cko);\n\tmdelay(DLL_SLEEP_DELAY);\n\tcko &= ~(MDLL_CKO__MCKOA_RESET | MDLL_CKO__MCKOB_RESET);\n\tOUTPLL(pllMDLL_CKO, cko);\n\tmdelay(DLL_RESET_DELAY);\n\n\tcka &= ~(MDLL_RDCKA__MRDCKA0_SLEEP | MDLL_RDCKA__MRDCKA1_SLEEP);\n\tOUTPLL(pllMDLL_RDCKA, cka);\n\tmdelay(DLL_SLEEP_DELAY);\n\tcka &= ~(MDLL_RDCKA__MRDCKA0_RESET | MDLL_RDCKA__MRDCKA1_RESET);\n\tOUTPLL(pllMDLL_RDCKA, cka);\n\tmdelay(DLL_RESET_DELAY);\n\n\tckb &= ~(MDLL_RDCKB__MRDCKB0_SLEEP | MDLL_RDCKB__MRDCKB1_SLEEP);\n\tOUTPLL(pllMDLL_RDCKB, ckb);\n\tmdelay(DLL_SLEEP_DELAY);\n\tckb &= ~(MDLL_RDCKB__MRDCKB0_RESET | MDLL_RDCKB__MRDCKB1_RESET);\n\tOUTPLL(pllMDLL_RDCKB, ckb);\n\tmdelay(DLL_RESET_DELAY);\n\n\n#undef DLL_RESET_DELAY\n#undef DLL_SLEEP_DELAY\n}\n\nstatic void radeon_pm_enable_dll_m10(struct radeonfb_info *rinfo)\n{\n\tu32 dll_value;\n\tu32 dll_sleep_mask = 0;\n\tu32 dll_reset_mask = 0;\n\tu32 mc;\n\n#define DLL_RESET_DELAY \t5\n#define DLL_SLEEP_DELAY\t\t1\n\n\tOUTMC(rinfo, ixR300_MC_DLL_CNTL, rinfo->save_regs[70]);\n\tmc = INREG(MC_CNTL);\n\t \n\tswitch (mc & 0x3) {\n\tcase 1:\n\t\tif (mc & 0x4)\n\t\t\tbreak;\n\t\tfallthrough;\n\tcase 2:\n\t\tdll_sleep_mask |= MDLL_R300_RDCK__MRDCKB_SLEEP;\n\t\tdll_reset_mask |= MDLL_R300_RDCK__MRDCKB_RESET;\n\t\tfallthrough;\n\tcase 0:\n\t\tdll_sleep_mask |= MDLL_R300_RDCK__MRDCKA_SLEEP;\n\t\tdll_reset_mask |= MDLL_R300_RDCK__MRDCKA_RESET;\n\t}\n\tswitch (mc & 0x3) {\n\tcase 1:\n\t\tif (!(mc & 0x4))\n\t\t\tbreak;\n\t\tfallthrough;\n\tcase 2:\n\t\tdll_sleep_mask |= MDLL_R300_RDCK__MRDCKD_SLEEP;\n\t\tdll_reset_mask |= MDLL_R300_RDCK__MRDCKD_RESET;\n\t\tdll_sleep_mask |= MDLL_R300_RDCK__MRDCKC_SLEEP;\n\t\tdll_reset_mask |= MDLL_R300_RDCK__MRDCKC_RESET;\n\t}\n\n\tdll_value = INPLL(pllMDLL_RDCKA);\n\n\t \n\tdll_value &= ~(dll_sleep_mask);\n\tOUTPLL(pllMDLL_RDCKA, dll_value);\n\tmdelay( DLL_SLEEP_DELAY);  \t\t\n\n\tdll_value &= ~(dll_reset_mask);\n\tOUTPLL(pllMDLL_RDCKA, dll_value);\n\tmdelay( DLL_RESET_DELAY);  \t\t\n\n#undef DLL_RESET_DELAY \n#undef DLL_SLEEP_DELAY\n}\n\n\nstatic void radeon_pm_full_reset_sdram(struct radeonfb_info *rinfo)\n{\n\tu32 crtcGenCntl, crtcGenCntl2, memRefreshCntl, crtc_more_cntl,\n\t\tfp_gen_cntl, fp2_gen_cntl;\n \n\tcrtcGenCntl  = INREG( CRTC_GEN_CNTL);\n\tcrtcGenCntl2 = INREG( CRTC2_GEN_CNTL);\n\n\tcrtc_more_cntl \t= INREG( CRTC_MORE_CNTL);\n\tfp_gen_cntl \t= INREG( FP_GEN_CNTL);\n\tfp2_gen_cntl \t= INREG( FP2_GEN_CNTL);\n \n\n\tOUTREG( CRTC_MORE_CNTL, 0);\n\tOUTREG( FP_GEN_CNTL, 0);\n\tOUTREG( FP2_GEN_CNTL,0);\n \n\tOUTREG( CRTC_GEN_CNTL,  (crtcGenCntl | CRTC_GEN_CNTL__CRTC_DISP_REQ_EN_B) );\n\tOUTREG( CRTC2_GEN_CNTL, (crtcGenCntl2 | CRTC2_GEN_CNTL__CRTC2_DISP_REQ_EN_B) );\n  \n\t \n\tif (rinfo->family == CHIP_FAMILY_RV350) {\n\t\tu32 sdram_mode_reg = rinfo->save_regs[35];\n\t\tstatic const u32 default_mrtable[] =\n\t\t\t{ 0x21320032,\n\t\t\t  0x21321000, 0xa1321000, 0x21321000, 0xffffffff,\n\t\t\t  0x21320032, 0xa1320032, 0x21320032, 0xffffffff,\n\t\t\t  0x21321002, 0xa1321002, 0x21321002, 0xffffffff,\n\t\t\t  0x21320132, 0xa1320132, 0x21320132, 0xffffffff,\n\t\t\t  0x21320032, 0xa1320032, 0x21320032, 0xffffffff,\n\t\t\t  0x31320032 };\n\n\t\tconst u32 *mrtable = default_mrtable;\n\t\tint i, mrtable_size = ARRAY_SIZE(default_mrtable);\n\n\t\tmdelay(30);\n\n\t\t \n\t\tmemRefreshCntl \t= INREG( MEM_REFRESH_CNTL)\n\t\t\t& ~MEM_REFRESH_CNTL__MEM_REFRESH_DIS;\n\t\tOUTREG( MEM_REFRESH_CNTL, memRefreshCntl\n\t\t\t| MEM_REFRESH_CNTL__MEM_REFRESH_DIS);\n\n\t\t \n       \t\tradeon_pm_enable_dll_m10(rinfo);\n\t\tradeon_pm_yclk_mclk_sync_m10(rinfo);\n\n#ifdef CONFIG_PPC\n\t\tif (rinfo->of_node != NULL) {\n\t\t\tint size;\n\n\t\t\tmrtable = of_get_property(rinfo->of_node, \"ATY,MRT\", &size);\n\t\t\tif (mrtable)\n\t\t\t\tmrtable_size = size >> 2;\n\t\t\telse\n\t\t\t\tmrtable = default_mrtable;\n\t\t}\n#endif  \n\n\t\t \n\t\tsdram_mode_reg = mrtable[0];\n\t\tOUTREG(MEM_SDRAM_MODE_REG, sdram_mode_reg);\n\t\tfor (i = 0; i < mrtable_size; i++) {\n\t\t\tif (mrtable[i] == 0xffffffffu)\n\t\t\t\tradeon_pm_m10_program_mode_wait(rinfo);\n\t\t\telse {\n\t\t\t\tsdram_mode_reg &= ~(MEM_SDRAM_MODE_REG__MEM_MODE_REG_MASK\n\t\t\t\t\t\t    | MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE\n\t\t\t\t\t\t    | MEM_SDRAM_MODE_REG__MEM_SDRAM_RESET);\n\t\t\t\tsdram_mode_reg |= mrtable[i];\n\n\t\t\t\tOUTREG(MEM_SDRAM_MODE_REG, sdram_mode_reg);\n\t\t\t\tmdelay(1);\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tOUTREG(MEM_REFRESH_CNTL, memRefreshCntl);\n\t\tmdelay(30);\n\n\t}\n\t \n\telse if (!rinfo->is_mobility && rinfo->family == CHIP_FAMILY_RV200) {\n\t\t \n\t\tmemRefreshCntl \t= INREG( MEM_REFRESH_CNTL)\n\t\t\t& ~MEM_REFRESH_CNTL__MEM_REFRESH_DIS;\n\t\tOUTREG(MEM_REFRESH_CNTL, memRefreshCntl\n\t\t       | MEM_REFRESH_CNTL__MEM_REFRESH_DIS);\n\t\tmdelay(30);\n\n\t\t \n\t\tOUTREG(MEM_SDRAM_MODE_REG,\n\t\t       INREG( MEM_SDRAM_MODE_REG) & ~MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\n\t\tradeon_pm_program_mode_reg(rinfo, 0x2002, 2);\n\t\tradeon_pm_program_mode_reg(rinfo, 0x0132, 2);\n\t\tradeon_pm_program_mode_reg(rinfo, 0x0032, 2);\n\n\t\tOUTREG(MEM_SDRAM_MODE_REG,\n\t\t       INREG(MEM_SDRAM_MODE_REG) | MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\n\t\tOUTREG( MEM_REFRESH_CNTL, \tmemRefreshCntl);\n\n\t}\n\t \n\telse if (rinfo->is_mobility && rinfo->family == CHIP_FAMILY_RV100) {\n\t\t \n\t\tmemRefreshCntl = INREG(EXT_MEM_CNTL) & ~(1 << 20);\n\t\tOUTREG( EXT_MEM_CNTL, memRefreshCntl | (1 << 20));\n \n\t\t \n\t\tOUTREG( MEM_SDRAM_MODE_REG,\n\t\t\tINREG( MEM_SDRAM_MODE_REG)\n\t\t\t& ~MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\n\t\t \n\t\tradeon_pm_enable_dll(rinfo);\n\n\t\t \n\t\tradeon_pm_yclk_mclk_sync(rinfo);\n\n\t\t \n\t\tradeon_pm_program_mode_reg(rinfo, 0x2000, 1);   \n\t\tradeon_pm_program_mode_reg(rinfo, 0x2001, 1);   \n\t\tradeon_pm_program_mode_reg(rinfo, 0x2002, 1);   \n\t\tradeon_pm_program_mode_reg(rinfo, 0x0132, 1);   \n\t\tradeon_pm_program_mode_reg(rinfo, 0x0032, 1); \n\n\t\t \n\t\tOUTREG( MEM_SDRAM_MODE_REG,\n\t\t\tINREG( MEM_SDRAM_MODE_REG) | MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\n\t\tOUTREG(EXT_MEM_CNTL, memRefreshCntl);\n\t}\n\t \n\telse if (rinfo->is_mobility) {\n\n\t\t \n\t\tmemRefreshCntl \t= INREG( MEM_REFRESH_CNTL)\n\t\t\t& ~MEM_REFRESH_CNTL__MEM_REFRESH_DIS;\n\t\tOUTREG( MEM_REFRESH_CNTL, memRefreshCntl\n\t\t\t| MEM_REFRESH_CNTL__MEM_REFRESH_DIS);\n\n\t\t \n\t\tOUTREG( MEM_SDRAM_MODE_REG,\n\t\t\tINREG( MEM_SDRAM_MODE_REG)\n\t\t\t& ~MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\n\t\t \n\t\tradeon_pm_enable_dll(rinfo);\n\n\t\t \n\t\tradeon_pm_yclk_mclk_sync(rinfo);\n\n\t\t \n\t\tif (rinfo->family <= CHIP_FAMILY_RV250) {\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x2000, 1);\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x2001, 1);\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x2002, 1);\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x0132, 1);\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x0032, 1);\n\t\t}\n\t\t \n\t\telse if (rinfo->family == CHIP_FAMILY_RV280) {\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x2000, 1);\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x0132, 1);\n\t\t\tradeon_pm_program_mode_reg(rinfo, 0x0032, 1);\n\t\t}\n\n\t\t \n\t\tOUTREG( MEM_SDRAM_MODE_REG,\n\t\t\tINREG( MEM_SDRAM_MODE_REG) | MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\n\t\tOUTREG( MEM_REFRESH_CNTL, \tmemRefreshCntl);\n\t}\n\n\tOUTREG( CRTC_GEN_CNTL, \t\tcrtcGenCntl);\n\tOUTREG( CRTC2_GEN_CNTL, \tcrtcGenCntl2);\n\tOUTREG( FP_GEN_CNTL, \t\tfp_gen_cntl);\n\tOUTREG( FP2_GEN_CNTL, \t\tfp2_gen_cntl);\n\n\tOUTREG( CRTC_MORE_CNTL, \tcrtc_more_cntl);\n\n\tmdelay( 15);\n}\n\n#if defined(CONFIG_X86) || defined(CONFIG_PPC_PMAC)\nstatic void radeon_pm_reset_pad_ctlr_strength(struct radeonfb_info *rinfo)\n{\n\tu32 tmp, tmp2;\n\tint i,j;\n\n\t \n\tINREG(PAD_CTLR_STRENGTH);\n\tOUTREG(PAD_CTLR_STRENGTH, INREG(PAD_CTLR_STRENGTH) & ~PAD_MANUAL_OVERRIDE);\n\ttmp = INREG(PAD_CTLR_STRENGTH);\n\tfor (i = j = 0; i < 65; ++i) {\n\t\tmdelay(1);\n\t\ttmp2 = INREG(PAD_CTLR_STRENGTH);\n\t\tif (tmp != tmp2) {\n\t\t\ttmp = tmp2;\n\t\t\ti = 0;\n\t\t\tj++;\n\t\t\tif (j > 10) {\n\t\t\t\tprintk(KERN_WARNING \"radeon: PAD_CTLR_STRENGTH doesn't \"\n\t\t\t\t       \"stabilize !\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void radeon_pm_all_ppls_off(struct radeonfb_info *rinfo)\n{\n\tu32 tmp;\n\n\ttmp = INPLL(pllPPLL_CNTL);\n\tOUTPLL(pllPPLL_CNTL, tmp | 0x3);\n\ttmp = INPLL(pllP2PLL_CNTL);\n\tOUTPLL(pllP2PLL_CNTL, tmp | 0x3);\n\ttmp = INPLL(pllSPLL_CNTL);\n\tOUTPLL(pllSPLL_CNTL, tmp | 0x3);\n\ttmp = INPLL(pllMPLL_CNTL);\n\tOUTPLL(pllMPLL_CNTL, tmp | 0x3);\n}\n\nstatic void radeon_pm_start_mclk_sclk(struct radeonfb_info *rinfo)\n{\n\tu32 tmp;\n\n\t \n\ttmp = INPLL(pllSCLK_CNTL);\n\tOUTPLL(pllSCLK_CNTL, tmp & ~SCLK_CNTL__SCLK_SRC_SEL_MASK);\n\n\t \n\ttmp = INPLL(pllSPLL_CNTL);\n\tOUTREG8(CLOCK_CNTL_INDEX, pllSPLL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA + 1, (tmp >> 8) & 0xff);\n\tradeon_pll_errata_after_data(rinfo);\n\n\t \n\ttmp = INPLL(pllM_SPLL_REF_FB_DIV);\n\ttmp = (tmp & 0xff00fffful) | (rinfo->save_regs[77] & 0x00ff0000ul);\n\tOUTPLL(pllM_SPLL_REF_FB_DIV, tmp);\n\n\t \n\ttmp = INPLL(pllSPLL_CNTL);\n\tOUTPLL(pllSPLL_CNTL, tmp & ~1);\n\t(void)INPLL(pllSPLL_CNTL);\n\n\tmdelay(10);\n\n\t \n\ttmp = INPLL(pllSPLL_CNTL);\n\tOUTPLL(pllSPLL_CNTL, tmp & ~0x2);\n\t(void)INPLL(pllSPLL_CNTL);\n\n\tmdelay(10);\n\n\t \n\ttmp = INPLL(pllSCLK_CNTL);\n\ttmp &= ~SCLK_CNTL__SCLK_SRC_SEL_MASK;\n\ttmp |= rinfo->save_regs[3] & SCLK_CNTL__SCLK_SRC_SEL_MASK;\n\tOUTPLL(pllSCLK_CNTL, tmp);\n\t(void)INPLL(pllSCLK_CNTL);\n\n\tmdelay(10);\n\n\t \n\ttmp = INPLL(pllMPLL_CNTL);\n\tOUTREG8(CLOCK_CNTL_INDEX, pllMPLL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA + 1, (tmp >> 8) & 0xff);\n\tradeon_pll_errata_after_data(rinfo);\n\n\t \n\ttmp = INPLL(pllM_SPLL_REF_FB_DIV);\n\ttmp = (tmp & 0xffff00fful) | (rinfo->save_regs[77] & 0x0000ff00ul);\n\n\tOUTPLL(pllM_SPLL_REF_FB_DIV, tmp);\n\t \n\ttmp = INPLL(pllMPLL_CNTL);\n\tOUTPLL(pllMPLL_CNTL, tmp & ~0x2);\n\t(void)INPLL(pllMPLL_CNTL);\n\n\tmdelay(10);\n\n\t \n\ttmp = INPLL(pllMPLL_CNTL);\n\tOUTPLL(pllMPLL_CNTL, tmp & ~0x1);\n\t(void)INPLL(pllMPLL_CNTL);\n\n\tmdelay(10);\n\n\t \n\ttmp = INPLL(pllMCLK_CNTL);\n\ttmp |= rinfo->save_regs[2] & 0xffff;\n\tOUTPLL(pllMCLK_CNTL, tmp);\n\t(void)INPLL(pllMCLK_CNTL);\n\n\tmdelay(10);\n}\n\nstatic void radeon_pm_m10_disable_spread_spectrum(struct radeonfb_info *rinfo)\n{\n\tu32 r2ec;\n\n\t \n\tmdelay(20);\n\tr2ec = INREG(VGA_DDA_ON_OFF);\n\tOUTREG(VGA_DDA_ON_OFF, r2ec);\n\tmdelay(1);\n\n\t \n\tOUTPLL(pllSSPLL_CNTL, 0xbf03);\n\n\t \n\tOUTPLL(pllSS_INT_CNTL, rinfo->save_regs[90] & ~3);\n\n\t \n\n\tr2ec |= 0x3f0;\n\tOUTREG(VGA_DDA_ON_OFF, r2ec);\n\tmdelay(1);\n}\n\nstatic void radeon_pm_m10_enable_lvds_spread_spectrum(struct radeonfb_info *rinfo)\n{\n\tu32 r2ec, tmp;\n\n\t \n\tr2ec = INREG(VGA_DDA_ON_OFF);\n\tOUTREG(VGA_DDA_ON_OFF, r2ec);\n\tmdelay(1);\n\n\t \n\tOUTPLL(pllSSPLL_CNTL, rinfo->save_regs[43] | 3);\n\tmdelay(3);\n\n\tOUTPLL(pllSSPLL_REF_DIV, rinfo->save_regs[44]);\n\tOUTPLL(pllSSPLL_DIV_0, rinfo->save_regs[45]);\n\ttmp = INPLL(pllSSPLL_CNTL);\n\tOUTPLL(pllSSPLL_CNTL, tmp & ~0x2);\n\tmdelay(6);\n\ttmp = INPLL(pllSSPLL_CNTL);\n\tOUTPLL(pllSSPLL_CNTL, tmp & ~0x1);\n\tmdelay(5);\n\n       \tOUTPLL(pllSS_INT_CNTL, rinfo->save_regs[90]);\n\n\tr2ec |= 8;\n\tOUTREG(VGA_DDA_ON_OFF, r2ec);\n\tmdelay(20);\n\n\t \n\ttmp = INREG(LVDS_GEN_CNTL);\n\tOUTREG(LVDS_GEN_CNTL, tmp | LVDS_EN);\n\n\t \n\ttmp = INREG(LVDS_PLL_CNTL);\n\ttmp &= ~0x30000;\n\ttmp |= 0x10000;\n\tOUTREG(LVDS_PLL_CNTL, tmp);\n\n\tOUTPLL(pllSCLK_MORE_CNTL, rinfo->save_regs[34]);\n\tOUTPLL(pllSS_TST_CNTL, rinfo->save_regs[91]);\n\n\t \n\tINREG(RBBM_STATUS);\n\n\t \n\ttmp = INPLL(pllSS_TST_CNTL);\n\ttmp |= 0x00400000;\n\tOUTPLL(pllSS_TST_CNTL, tmp);\n}\n\nstatic void radeon_pm_restore_pixel_pll(struct radeonfb_info *rinfo)\n{\n\tu32 tmp;\n\n\tOUTREG8(CLOCK_CNTL_INDEX, pllHTOTAL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA, 0);\n\tradeon_pll_errata_after_data(rinfo);\n\n\ttmp = INPLL(pllVCLK_ECP_CNTL);\n\tOUTPLL(pllVCLK_ECP_CNTL, tmp | 0x80);\n\tmdelay(5);\n\n\ttmp = INPLL(pllPPLL_REF_DIV);\n\ttmp = (tmp & ~PPLL_REF_DIV_MASK) | rinfo->pll.ref_div;\n\tOUTPLL(pllPPLL_REF_DIV, tmp);\n\tINPLL(pllPPLL_REF_DIV);\n\n\t \n\ttmp = INPLL(pllPPLL_CNTL);\n\tOUTREG8(CLOCK_CNTL_INDEX, pllSPLL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA + 1, (tmp >> 8) & 0xff);\n\tradeon_pll_errata_after_data(rinfo);\n\n\t \n\tOUTPLL(pllPPLL_DIV_0, rinfo->save_regs[92]);\n\n\ttmp = INPLL(pllPPLL_CNTL);\n\tOUTPLL(pllPPLL_CNTL, tmp & ~0x2);\n\tmdelay(5);\n\n\ttmp = INPLL(pllPPLL_CNTL);\n\tOUTPLL(pllPPLL_CNTL, tmp & ~0x1);\n\tmdelay(5);\n\n\ttmp = INPLL(pllVCLK_ECP_CNTL);\n\tOUTPLL(pllVCLK_ECP_CNTL, tmp | 3);\n\tmdelay(5);\n\n\ttmp = INPLL(pllVCLK_ECP_CNTL);\n\tOUTPLL(pllVCLK_ECP_CNTL, tmp | 3);\n\tmdelay(5);\n\n\t \n\tOUTREG8(CLOCK_CNTL_INDEX+1, 0);\n\tradeon_pll_errata_after_index(rinfo);\n\tradeon_pll_errata_after_data(rinfo);\n}\n\nstatic void radeon_pm_m10_reconfigure_mc(struct radeonfb_info *rinfo)\n{\n\tOUTREG(MC_CNTL, rinfo->save_regs[46]);\n\tOUTREG(MC_INIT_GFX_LAT_TIMER, rinfo->save_regs[47]);\n\tOUTREG(MC_INIT_MISC_LAT_TIMER, rinfo->save_regs[48]);\n\tOUTREG(MEM_SDRAM_MODE_REG,\n\t       rinfo->save_regs[35] & ~MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\tOUTREG(MC_TIMING_CNTL, rinfo->save_regs[49]);\n\tOUTREG(MEM_REFRESH_CNTL, rinfo->save_regs[42]);\n\tOUTREG(MC_READ_CNTL_AB, rinfo->save_regs[50]);\n\tOUTREG(MC_CHIP_IO_OE_CNTL_AB, rinfo->save_regs[52]);\n\tOUTREG(MC_IOPAD_CNTL, rinfo->save_regs[51]);\n\tOUTREG(MC_DEBUG, rinfo->save_regs[53]);\n\n\tOUTMC(rinfo, ixR300_MC_MC_INIT_WR_LAT_TIMER, rinfo->save_regs[58]);\n\tOUTMC(rinfo, ixR300_MC_IMP_CNTL, rinfo->save_regs[59]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_C0, rinfo->save_regs[60]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_C1, rinfo->save_regs[61]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_D0, rinfo->save_regs[62]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_D1, rinfo->save_regs[63]);\n\tOUTMC(rinfo, ixR300_MC_BIST_CNTL_3, rinfo->save_regs[64]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_A0, rinfo->save_regs[65]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_A1, rinfo->save_regs[66]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_B0, rinfo->save_regs[67]);\n\tOUTMC(rinfo, ixR300_MC_CHP_IO_CNTL_B1, rinfo->save_regs[68]);\n\tOUTMC(rinfo, ixR300_MC_DEBUG_CNTL, rinfo->save_regs[69]);\n\tOUTMC(rinfo, ixR300_MC_DLL_CNTL, rinfo->save_regs[70]);\n\tOUTMC(rinfo, ixR300_MC_IMP_CNTL_0, rinfo->save_regs[71]);\n\tOUTMC(rinfo, ixR300_MC_ELPIDA_CNTL, rinfo->save_regs[72]);\n\tOUTMC(rinfo, ixR300_MC_READ_CNTL_CD, rinfo->save_regs[96]);\n\tOUTREG(MC_IND_INDEX, 0);\n}\n\nstatic void radeon_reinitialize_M10(struct radeonfb_info *rinfo)\n{\n\tu32 tmp, i;\n\n\t \n\tOUTREG(MC_AGP_LOCATION, rinfo->save_regs[32]);\n\tOUTREG(DISPLAY_BASE_ADDR, rinfo->save_regs[31]);\n\tOUTREG(CRTC2_DISPLAY_BASE_ADDR, rinfo->save_regs[33]);\n\tOUTREG(MC_FB_LOCATION, rinfo->save_regs[30]);\n\tOUTREG(OV0_BASE_ADDR, rinfo->save_regs[80]);\n\tOUTREG(CNFG_MEMSIZE, rinfo->video_ram);\n\tOUTREG(BUS_CNTL, rinfo->save_regs[36]);\n\tOUTREG(BUS_CNTL1, rinfo->save_regs[14]);\n\tOUTREG(MPP_TB_CONFIG, rinfo->save_regs[37]);\n\tOUTREG(FCP_CNTL, rinfo->save_regs[38]);\n\tOUTREG(RBBM_CNTL, rinfo->save_regs[39]);\n\tOUTREG(DAC_CNTL, rinfo->save_regs[40]);\n\tOUTREG(DAC_MACRO_CNTL, (INREG(DAC_MACRO_CNTL) & ~0x6) | 8);\n\tOUTREG(DAC_MACRO_CNTL, (INREG(DAC_MACRO_CNTL) & ~0x6) | 8);\n\n\t \n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) | DAC2_EXPAND_MODE);\n\n\t \n\tradeon_pm_reset_pad_ctlr_strength(rinfo);\n\n\t \n\tradeon_pm_all_ppls_off(rinfo);\n\n\t \n\tINREG(SURFACE_CNTL);\n\tOUTREG(SURFACE_CNTL, 0);\n\n\t \n\ttmp = INREG(TV_DAC_CNTL) & ~TV_DAC_CNTL_BGADJ_MASK;\n\ttmp |= 8 << TV_DAC_CNTL_BGADJ__SHIFT;\n\tOUTREG(TV_DAC_CNTL, tmp);\n\n\ttmp = INREG(TV_DAC_CNTL) & ~TV_DAC_CNTL_DACADJ_MASK;\n\ttmp |= 7 << TV_DAC_CNTL_DACADJ__SHIFT;\n\tOUTREG(TV_DAC_CNTL, tmp);\n\n\t \n\tOUTREG(AGP_CNTL, rinfo->save_regs[16]);\n\tOUTREG(HOST_PATH_CNTL, rinfo->save_regs[41]);\n\tOUTREG(DISP_MISC_CNTL, rinfo->save_regs[9]);\n\n\t \n\ttmp = rinfo->save_regs[1]\n\t\t& ~(CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK |\n\t\t    CLK_PWRMGT_CNTL__MC_BUSY);\n\tOUTPLL(pllCLK_PWRMGT_CNTL, tmp);\n\n\tOUTREG(PAD_CTLR_MISC, rinfo->save_regs[56]);\n\tOUTREG(FW_CNTL, rinfo->save_regs[57]);\n\tOUTREG(HDP_DEBUG, rinfo->save_regs[96]);\n\tOUTREG(PAMAC0_DLY_CNTL, rinfo->save_regs[54]);\n\tOUTREG(PAMAC1_DLY_CNTL, rinfo->save_regs[55]);\n\tOUTREG(PAMAC2_DLY_CNTL, rinfo->save_regs[79]);\n\n\t \n\tradeon_pm_m10_reconfigure_mc(rinfo);\n\n\t \n\tOUTREG(CRTC_GEN_CNTL, INREG(CRTC_GEN_CNTL)\n\t       | CRTC_GEN_CNTL__CRTC_DISP_REQ_EN_B);\n\tOUTREG(CRTC2_GEN_CNTL, INREG(CRTC2_GEN_CNTL)\n\t       | CRTC2_GEN_CNTL__CRTC2_DISP_REQ_EN_B);\n\tmdelay(30);\n\n\t \n\tOUTREG(MEM_REFRESH_CNTL, INREG(MEM_REFRESH_CNTL)\n\t       | MEM_REFRESH_CNTL__MEM_REFRESH_DIS);\n\n\t \n\tOUTPLL(pllCLK_PIN_CNTL, rinfo->save_regs[4]);\n\n\t \n\ttmp = rinfo->save_regs[2] & 0xff000000;\n\ttmp |=\tMCLK_CNTL__FORCE_MCLKA |\n\t\tMCLK_CNTL__FORCE_MCLKB |\n\t\tMCLK_CNTL__FORCE_YCLKA |\n\t\tMCLK_CNTL__FORCE_YCLKB |\n\t\tMCLK_CNTL__FORCE_MC;\n\tOUTPLL(pllMCLK_CNTL, tmp);\n\n\t \n\ttmp = INPLL(pllSCLK_CNTL);\n\ttmp |=\tSCLK_CNTL__FORCE_DISP2|\n\t\tSCLK_CNTL__FORCE_CP|\n\t\tSCLK_CNTL__FORCE_HDP|\n\t\tSCLK_CNTL__FORCE_DISP1|\n\t\tSCLK_CNTL__FORCE_TOP|\n\t\tSCLK_CNTL__FORCE_E2|\n\t\tSCLK_CNTL__FORCE_SE|\n\t\tSCLK_CNTL__FORCE_IDCT|\n\t\tSCLK_CNTL__FORCE_VIP|\n\t\tSCLK_CNTL__FORCE_PB|\n\t\tSCLK_CNTL__FORCE_TAM|\n\t\tSCLK_CNTL__FORCE_TDM|\n\t\tSCLK_CNTL__FORCE_RB|\n\t\tSCLK_CNTL__FORCE_TV_SCLK|\n\t\tSCLK_CNTL__FORCE_SUBPIC|\n\t\tSCLK_CNTL__FORCE_OV0;\n\ttmp |=\tSCLK_CNTL__CP_MAX_DYN_STOP_LAT  |\n\t\tSCLK_CNTL__HDP_MAX_DYN_STOP_LAT |\n\t\tSCLK_CNTL__TV_MAX_DYN_STOP_LAT  |\n\t\tSCLK_CNTL__E2_MAX_DYN_STOP_LAT  |\n\t\tSCLK_CNTL__SE_MAX_DYN_STOP_LAT  |\n\t\tSCLK_CNTL__IDCT_MAX_DYN_STOP_LAT|\n\t\tSCLK_CNTL__VIP_MAX_DYN_STOP_LAT |\n\t\tSCLK_CNTL__RE_MAX_DYN_STOP_LAT  |\n\t\tSCLK_CNTL__PB_MAX_DYN_STOP_LAT  |\n\t\tSCLK_CNTL__TAM_MAX_DYN_STOP_LAT |\n\t\tSCLK_CNTL__TDM_MAX_DYN_STOP_LAT |\n\t\tSCLK_CNTL__RB_MAX_DYN_STOP_LAT;\n\tOUTPLL(pllSCLK_CNTL, tmp);\n\n\tOUTPLL(pllVCLK_ECP_CNTL, 0);\n\tOUTPLL(pllPIXCLKS_CNTL, 0);\n\tOUTPLL(pllMCLK_MISC,\n\t       MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT |\n\t       MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT);\n\n\tmdelay(5);\n\n\t \n\tOUTPLL(pllM_SPLL_REF_FB_DIV, rinfo->save_regs[77]);\n\tOUTPLL(pllMPLL_AUX_CNTL, rinfo->save_regs[75]);\n\tOUTPLL(pllSPLL_AUX_CNTL, rinfo->save_regs[76]);\n\n\t \n\tOUTPLL(pllPPLL_CNTL, rinfo->save_regs[93] | 0x3);\n\tOUTPLL(pllP2PLL_CNTL, rinfo->save_regs[8] | 0x3);\n\tOUTPLL(pllMPLL_CNTL, rinfo->save_regs[73] | 0x03);\n\tOUTPLL(pllSPLL_CNTL, rinfo->save_regs[74] | 0x03);\n\n\t \n\tOUTMC(rinfo, ixR300_MC_DLL_CNTL, rinfo->save_regs[70]);\n\n\t \n\tOUTPLL(pllMDLL_RDCKA, rinfo->save_regs[98] | 0xff);\n\tmdelay(5);\n\n\t \n\tOUTPLL(pllPLL_PWRMGT_CNTL, rinfo->save_regs[0]);\n\n\t \n\tOUTPLL(pllHTOTAL_CNTL, 0);\n\tOUTPLL(pllHTOTAL2_CNTL, 0);\n\n\t \n\ttmp = INPLL(pllSCLK_CNTL2);  \n\tOUTPLL(pllSCLK_CNTL2, tmp);\n\n\ttmp = INPLL(pllSCLK_MORE_CNTL);\n\ttmp |= \tSCLK_MORE_CNTL__FORCE_DISPREGS |\t \n\t\tSCLK_MORE_CNTL__FORCE_MC_GUI |\n\t\tSCLK_MORE_CNTL__FORCE_MC_HOST;\n\tOUTPLL(pllSCLK_MORE_CNTL, tmp);\n\n\t \n\tradeon_pm_start_mclk_sclk(rinfo);\n\n\t \n\tradeon_pm_full_reset_sdram(rinfo);\n\n\t \n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) | 0x20);\n\tfor (i=0; i<256; i++)\n\t\tOUTREG(PALETTE_30_DATA, 0x15555555);\n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) & ~20);\n\tudelay(20);\n\tfor (i=0; i<256; i++)\n\t\tOUTREG(PALETTE_30_DATA, 0x15555555);\n\n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) & ~0x20);\n\tmdelay(3);\n\n\t \n\tOUTREG(FP_GEN_CNTL, rinfo->save_regs[82]);\n\tOUTREG(FP2_GEN_CNTL, rinfo->save_regs[83]);\n\n\t \n\tOUTREG(LVDS_GEN_CNTL, rinfo->save_regs[11] &\n\t       ~(LVDS_EN | LVDS_ON | LVDS_DIGON | LVDS_BLON | LVDS_BL_MOD_EN));\n\tOUTREG(LVDS_PLL_CNTL, (rinfo->save_regs[12] & ~0xf0000) | 0x20000);\n\n\tOUTREG(DISP_OUTPUT_CNTL, rinfo->save_regs[86]);\n\n\t \n\tOUTREG(GPIOPAD_A, rinfo->save_regs[19]);\n\tOUTREG(GPIOPAD_EN, rinfo->save_regs[20]);\n\tOUTREG(GPIOPAD_MASK, rinfo->save_regs[21]);\n\n\t \n\tfor (i = 0; i < 0x8000; ++i)\n\t\twriteb(0, rinfo->fb_base + i);\n\n\tmdelay(40);\n\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) | LVDS_DIGON | LVDS_ON);\n\tmdelay(40);\n\n\t \n\tOUTREG(GRPH_BUFFER_CNTL, rinfo->save_regs[94]);\n\tOUTREG(GRPH2_BUFFER_CNTL, rinfo->save_regs[95]);\n\n\t \n\tradeon_pm_m10_disable_spread_spectrum(rinfo);\n\tradeon_pm_restore_pixel_pll(rinfo);\n\n\t \n\tradeon_pm_m10_enable_lvds_spread_spectrum(rinfo);\n}\n#endif\n\n#ifdef CONFIG_PPC\n#ifdef CONFIG_PPC_PMAC\nstatic void radeon_pm_m9p_reconfigure_mc(struct radeonfb_info *rinfo)\n{\n\tOUTREG(MC_CNTL, rinfo->save_regs[46]);\n\tOUTREG(MC_INIT_GFX_LAT_TIMER, rinfo->save_regs[47]);\n\tOUTREG(MC_INIT_MISC_LAT_TIMER, rinfo->save_regs[48]);\n\tOUTREG(MEM_SDRAM_MODE_REG,\n\t       rinfo->save_regs[35] & ~MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE);\n\tOUTREG(MC_TIMING_CNTL, rinfo->save_regs[49]);\n\tOUTREG(MC_READ_CNTL_AB, rinfo->save_regs[50]);\n\tOUTREG(MEM_REFRESH_CNTL, rinfo->save_regs[42]);\n\tOUTREG(MC_IOPAD_CNTL, rinfo->save_regs[51]);\n\tOUTREG(MC_DEBUG, rinfo->save_regs[53]);\n\tOUTREG(MC_CHIP_IO_OE_CNTL_AB, rinfo->save_regs[52]);\n\n\tOUTMC(rinfo, ixMC_IMP_CNTL, rinfo->save_regs[59]  );\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_A0, rinfo->save_regs[65]  );\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_A1, rinfo->save_regs[66]  );\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_B0, rinfo->save_regs[67]  );\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_B1, rinfo->save_regs[68]  );\n\tOUTMC(rinfo, ixMC_IMP_CNTL_0, rinfo->save_regs[71]  );\n\tOUTREG(MC_IND_INDEX, 0);\n\tOUTREG(CNFG_MEMSIZE, rinfo->video_ram);\n\n\tmdelay(20);\n}\n\nstatic void radeon_reinitialize_M9P(struct radeonfb_info *rinfo)\n{\n\tu32 tmp, i;\n\n\t \n\tOUTREG(SURFACE_CNTL, rinfo->save_regs[29]);\n\tOUTREG(MC_AGP_LOCATION, rinfo->save_regs[32]);\n\tOUTREG(DISPLAY_BASE_ADDR, rinfo->save_regs[31]);\n\tOUTREG(CRTC2_DISPLAY_BASE_ADDR, rinfo->save_regs[33]);\n\tOUTREG(MC_FB_LOCATION, rinfo->save_regs[30]);\n\tOUTREG(OV0_BASE_ADDR, rinfo->save_regs[80]);\n\tOUTREG(BUS_CNTL, rinfo->save_regs[36]);\n\tOUTREG(BUS_CNTL1, rinfo->save_regs[14]);\n\tOUTREG(MPP_TB_CONFIG, rinfo->save_regs[37]);\n\tOUTREG(FCP_CNTL, rinfo->save_regs[38]);\n\tOUTREG(RBBM_CNTL, rinfo->save_regs[39]);\n\n\tOUTREG(DAC_CNTL, rinfo->save_regs[40]);\n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) | DAC2_EXPAND_MODE);\n\n\t \n\tradeon_pm_reset_pad_ctlr_strength(rinfo);\n\n\t \n\tradeon_pm_all_ppls_off(rinfo);\n\n\t \n\tINREG(SURFACE_CNTL);\n\tOUTREG(SURFACE_CNTL, 0);\n\n\t \n\ttmp = INREG(TV_DAC_CNTL) & ~TV_DAC_CNTL_BGADJ_MASK;\n\ttmp |= 6 << TV_DAC_CNTL_BGADJ__SHIFT;\n\tOUTREG(TV_DAC_CNTL, tmp);\n\n\ttmp = INREG(TV_DAC_CNTL) & ~TV_DAC_CNTL_DACADJ_MASK;\n\ttmp |= 6 << TV_DAC_CNTL_DACADJ__SHIFT;\n\tOUTREG(TV_DAC_CNTL, tmp);\n\n\tOUTPLL(pllAGP_PLL_CNTL, rinfo->save_regs[78]);\n\n\tOUTREG(PAMAC0_DLY_CNTL, rinfo->save_regs[54]);\n\tOUTREG(PAMAC1_DLY_CNTL, rinfo->save_regs[55]);\n\tOUTREG(PAMAC2_DLY_CNTL, rinfo->save_regs[79]);\n\n\tOUTREG(AGP_CNTL, rinfo->save_regs[16]);\n\tOUTREG(HOST_PATH_CNTL, rinfo->save_regs[41]);  \n\tOUTREG(DISP_MISC_CNTL, rinfo->save_regs[9]);\n\n\ttmp  = rinfo->save_regs[1]\n\t\t& ~(CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK |\n\t\t    CLK_PWRMGT_CNTL__MC_BUSY);\n\tOUTPLL(pllCLK_PWRMGT_CNTL, tmp);\n\n\tOUTREG(FW_CNTL, rinfo->save_regs[57]);\n\n\t \n\tOUTREG(MEM_REFRESH_CNTL, INREG(MEM_REFRESH_CNTL)\n\t       | MEM_REFRESH_CNTL__MEM_REFRESH_DIS);\n\n\t \n       \tOUTPLL(pllCLK_PIN_CNTL, rinfo->save_regs[4]);\n\n\t \n\ttmp = rinfo->save_regs[2] & 0xff000000;\n\ttmp |=\tMCLK_CNTL__FORCE_MCLKA |\n\t\tMCLK_CNTL__FORCE_MCLKB |\n\t\tMCLK_CNTL__FORCE_YCLKA |\n\t\tMCLK_CNTL__FORCE_YCLKB |\n\t\tMCLK_CNTL__FORCE_MC    |\n\t\tMCLK_CNTL__FORCE_AIC;\n\tOUTPLL(pllMCLK_CNTL, tmp);\n\n\t \n\ttmp =\t0 |\n\t\tSCLK_CNTL__FORCE_DISP2|\n\t\tSCLK_CNTL__FORCE_CP|\n\t\tSCLK_CNTL__FORCE_HDP|\n\t\tSCLK_CNTL__FORCE_DISP1|\n\t\tSCLK_CNTL__FORCE_TOP|\n\t\tSCLK_CNTL__FORCE_E2|\n\t\tSCLK_CNTL__FORCE_SE|\n\t\tSCLK_CNTL__FORCE_IDCT|\n\t\tSCLK_CNTL__FORCE_VIP|\n\t\tSCLK_CNTL__FORCE_RE|\n\t\tSCLK_CNTL__FORCE_PB|\n\t\tSCLK_CNTL__FORCE_TAM|\n\t\tSCLK_CNTL__FORCE_TDM|\n\t\tSCLK_CNTL__FORCE_RB;\n\tOUTPLL(pllSCLK_CNTL, tmp);\n\n\t \n\tOUTPLL(pllVCLK_ECP_CNTL, 0);\n\tOUTPLL(pllPIXCLKS_CNTL, 0);\n\n\t \n\tOUTPLL(pllMCLK_MISC,\n\t       MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT |\n\t       MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT);\n\n\tmdelay(5);\n\n\t \n\tOUTPLL(pllM_SPLL_REF_FB_DIV, rinfo->save_regs[77]);\n\tOUTPLL(pllMPLL_AUX_CNTL, rinfo->save_regs[75]);\n\tOUTPLL(pllSPLL_AUX_CNTL, rinfo->save_regs[76]);\n\n\t \n\tOUTPLL(pllPPLL_CNTL, rinfo->save_regs[93] | 0x3);\n\tOUTPLL(pllP2PLL_CNTL, rinfo->save_regs[8] | 0x3);\n\n\t \n\tOUTPLL(pllMPLL_CNTL, rinfo->save_regs[73] | 0x03);\n\tOUTPLL(pllSPLL_CNTL, rinfo->save_regs[74] | 0x03);\n\n\t \n\tOUTPLL(pllMDLL_CKO, 0x9c009c);\n\tOUTPLL(pllMDLL_RDCKA, 0x08830883);\n\tOUTPLL(pllMDLL_RDCKB, 0x08830883);\n\tmdelay(5);\n\n\t   \n\ttmp = rinfo->save_regs[0];\n\ttmp &= ~PLL_PWRMGT_CNTL_SU_SCLK_USE_BCLK;\n\ttmp |= PLL_PWRMGT_CNTL_SU_MCLK_USE_BCLK;\n\tOUTPLL(PLL_PWRMGT_CNTL,  tmp);\n\n\t \n\tOUTPLL(pllHTOTAL_CNTL, 0);\n\tOUTPLL(pllHTOTAL2_CNTL, 0);\n\n\t \n\tOUTREG(CRTC_GEN_CNTL, 0x04000000);\n\tOUTREG(CRTC2_GEN_CNTL, 0x04000000);\n\tOUTREG(FP_GEN_CNTL, 0x00004008);\n\tOUTREG(FP2_GEN_CNTL, 0x00000008);\n\tOUTREG(LVDS_GEN_CNTL, 0x08000008);\n\n\t \n\tradeon_pm_m9p_reconfigure_mc(rinfo);\n\n\t \n\tradeon_pm_start_mclk_sclk(rinfo);\n\n\t \n\tradeon_pm_full_reset_sdram(rinfo);\n\n\t \n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) | 0x20);\n\tfor (i=0; i<256; i++)\n\t\tOUTREG(PALETTE_30_DATA, 0x15555555);\n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) & ~20);\n\tudelay(20);\n\tfor (i=0; i<256; i++)\n\t\tOUTREG(PALETTE_30_DATA, 0x15555555);\n\n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) & ~0x20);\n\tmdelay(3);\n\n\t \n\tOUTREG(TV_MASTER_CNTL, rinfo->save_regs[88]);\n\tOUTREG(TV_DAC_CNTL, rinfo->save_regs[13] | 0x07000000);\n\n\t \n\tOUTREG(GPIOPAD_A, rinfo->save_regs[19]);\n\tOUTREG(GPIOPAD_EN, rinfo->save_regs[20]);\n\tOUTREG(GPIOPAD_MASK, rinfo->save_regs[21]);\n\n\t \n\ttmp = INPLL(pllSCLK_MORE_CNTL) & 0x0000ffff;\n\ttmp |= rinfo->save_regs[34] & 0xffff0000;\n\ttmp |= SCLK_MORE_CNTL__FORCE_DISPREGS;\n\tOUTPLL(pllSCLK_MORE_CNTL, tmp);\n\n\ttmp = INPLL(pllSCLK_MORE_CNTL) & 0x0000ffff;\n\ttmp |= rinfo->save_regs[34] & 0xffff0000;\n\ttmp |= SCLK_MORE_CNTL__FORCE_DISPREGS;\n\tOUTPLL(pllSCLK_MORE_CNTL, tmp);\n\n\tOUTREG(LVDS_GEN_CNTL, rinfo->save_regs[11] &\n\t       ~(LVDS_EN | LVDS_ON | LVDS_DIGON | LVDS_BLON | LVDS_BL_MOD_EN));\n\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) | LVDS_BLON);\n\tOUTREG(LVDS_PLL_CNTL, (rinfo->save_regs[12] & ~0xf0000) | 0x20000);\n\tmdelay(20);\n\n\t \n\tfor (i = 0; i < 0x8000; ++i)\n\t\twriteb(0, rinfo->fb_base + i);\n\n\tOUTREG(0x2ec, 0x6332a020);\n\tOUTPLL(pllSSPLL_REF_DIV, rinfo->save_regs[44]  );\n\tOUTPLL(pllSSPLL_DIV_0, rinfo->save_regs[45]  );\n\ttmp = INPLL(pllSSPLL_CNTL);\n\ttmp &= ~2;\n\tOUTPLL(pllSSPLL_CNTL, tmp);\n\tmdelay(6);\n\ttmp &= ~1;\n\tOUTPLL(pllSSPLL_CNTL, tmp);\n\tmdelay(5);\n\ttmp |= 3;\n\tOUTPLL(pllSSPLL_CNTL, tmp);\n\tmdelay(5);\n\n\tOUTPLL(pllSS_INT_CNTL, rinfo->save_regs[90] & ~3); \n\tOUTREG(0x2ec, 0x6332a3f0);\n\tmdelay(17);\n\n\tOUTPLL(pllPPLL_REF_DIV, rinfo->pll.ref_div);\n\tOUTPLL(pllPPLL_DIV_0, rinfo->save_regs[92]);\n\n\tmdelay(40);\n\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) | LVDS_DIGON | LVDS_ON);\n\tmdelay(40);\n\n\t \n\tOUTREG(GRPH_BUFFER_CNTL, rinfo->save_regs[94]);\n\tOUTREG(GRPH2_BUFFER_CNTL, rinfo->save_regs[95]);\n\n\t \n\tradeon_pm_m10_disable_spread_spectrum(rinfo);\n\tradeon_pm_restore_pixel_pll(rinfo);\n\tradeon_pm_m10_enable_lvds_spread_spectrum(rinfo);\n}\n#endif\n\n#if 0  \nstatic void radeon_reinitialize_QW(struct radeonfb_info *rinfo)\n{\n\tint i;\n\tu32 tmp, tmp2;\n\tu32 cko, cka, ckb;\n\tu32 cgc, cec, c2gc;\n\n\tOUTREG(MC_AGP_LOCATION, rinfo->save_regs[32]);\n\tOUTREG(DISPLAY_BASE_ADDR, rinfo->save_regs[31]);\n\tOUTREG(CRTC2_DISPLAY_BASE_ADDR, rinfo->save_regs[33]);\n\tOUTREG(MC_FB_LOCATION, rinfo->save_regs[30]);\n\tOUTREG(BUS_CNTL, rinfo->save_regs[36]);\n\tOUTREG(RBBM_CNTL, rinfo->save_regs[39]);\n\n\tINREG(PAD_CTLR_STRENGTH);\n\tOUTREG(PAD_CTLR_STRENGTH, INREG(PAD_CTLR_STRENGTH) & ~0x10000);\n\tfor (i = 0; i < 65; ++i) {\n\t\tmdelay(1);\n\t\tINREG(PAD_CTLR_STRENGTH);\n\t}\n\n\tOUTREG(DISP_TEST_DEBUG_CNTL, INREG(DISP_TEST_DEBUG_CNTL) | 0x10000000);\n\tOUTREG(OV0_FLAG_CNTRL, INREG(OV0_FLAG_CNTRL) | 0x100);\n\tOUTREG(CRTC_GEN_CNTL, INREG(CRTC_GEN_CNTL));\n\tOUTREG(DAC_CNTL, 0xff00410a);\n\tOUTREG(CRTC2_GEN_CNTL, INREG(CRTC2_GEN_CNTL));\n\tOUTREG(DAC_CNTL2, INREG(DAC_CNTL2) | 0x4000);\n\n\tOUTREG(SURFACE_CNTL, rinfo->save_regs[29]);\n\tOUTREG(AGP_CNTL, rinfo->save_regs[16]);\n\tOUTREG(HOST_PATH_CNTL, rinfo->save_regs[41]);\n\tOUTREG(DISP_MISC_CNTL, rinfo->save_regs[9]);\n\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_A0, 0xf7bb4433);\n\tOUTREG(MC_IND_INDEX, 0);\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_B0, 0xf7bb4433);\n\tOUTREG(MC_IND_INDEX, 0);\n\n\tOUTREG(CRTC_MORE_CNTL, INREG(CRTC_MORE_CNTL));\n\n\ttmp = INPLL(pllVCLK_ECP_CNTL);\n\tOUTPLL(pllVCLK_ECP_CNTL, tmp);\n\ttmp = INPLL(pllPIXCLKS_CNTL);\n\tOUTPLL(pllPIXCLKS_CNTL, tmp);\n\n\tOUTPLL(MCLK_CNTL, 0xaa3f0000);\n\tOUTPLL(SCLK_CNTL, 0xffff0000);\n\tOUTPLL(pllMPLL_AUX_CNTL, 6);\n\tOUTPLL(pllSPLL_AUX_CNTL, 1);\n\tOUTPLL(MDLL_CKO, 0x9f009f);\n\tOUTPLL(MDLL_RDCKA, 0x830083);\n\tOUTPLL(pllMDLL_RDCKB, 0x830083);\n\tOUTPLL(PPLL_CNTL, 0xa433);\n\tOUTPLL(P2PLL_CNTL, 0xa433);\n\tOUTPLL(MPLL_CNTL, 0x0400a403);\n\tOUTPLL(SPLL_CNTL, 0x0400a433);\n\n\ttmp = INPLL(M_SPLL_REF_FB_DIV);\n\tOUTPLL(M_SPLL_REF_FB_DIV, tmp);\n\ttmp = INPLL(M_SPLL_REF_FB_DIV);\n\tOUTPLL(M_SPLL_REF_FB_DIV, tmp | 0xc);\n\tINPLL(M_SPLL_REF_FB_DIV);\n\n\ttmp = INPLL(MPLL_CNTL);\n\tOUTREG8(CLOCK_CNTL_INDEX, MPLL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA + 1, (tmp >> 8) & 0xff);\n\tradeon_pll_errata_after_data(rinfo);\n\n\ttmp = INPLL(M_SPLL_REF_FB_DIV);\n\tOUTPLL(M_SPLL_REF_FB_DIV, tmp | 0x5900);\n\n\ttmp = INPLL(MPLL_CNTL);\n\tOUTPLL(MPLL_CNTL, tmp & ~0x2);\n\tmdelay(1);\n\ttmp = INPLL(MPLL_CNTL);\n\tOUTPLL(MPLL_CNTL, tmp & ~0x1);\n\tmdelay(10);\n\n\tOUTPLL(MCLK_CNTL, 0xaa3f1212);\n\tmdelay(1);\n\n\tINPLL(M_SPLL_REF_FB_DIV);\n\tINPLL(MCLK_CNTL);\n\tINPLL(M_SPLL_REF_FB_DIV);\n\n\ttmp = INPLL(SPLL_CNTL);\n\tOUTREG8(CLOCK_CNTL_INDEX, SPLL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA + 1, (tmp >> 8) & 0xff);\n\tradeon_pll_errata_after_data(rinfo);\n\n\ttmp = INPLL(M_SPLL_REF_FB_DIV);\n\tOUTPLL(M_SPLL_REF_FB_DIV, tmp | 0x780000);\n\n\ttmp = INPLL(SPLL_CNTL);\n\tOUTPLL(SPLL_CNTL, tmp & ~0x1);\n\tmdelay(1);\n\ttmp = INPLL(SPLL_CNTL);\n\tOUTPLL(SPLL_CNTL, tmp & ~0x2);\n\tmdelay(10);\n\n\ttmp = INPLL(SCLK_CNTL);\n\tOUTPLL(SCLK_CNTL, tmp | 2);\n\tmdelay(1);\n\n\tcko = INPLL(pllMDLL_CKO);\n\tcka = INPLL(pllMDLL_RDCKA);\n\tckb = INPLL(pllMDLL_RDCKB);\n\n\tcko &= ~(MDLL_CKO__MCKOA_SLEEP | MDLL_CKO__MCKOB_SLEEP);\n\tOUTPLL(pllMDLL_CKO, cko);\n\tmdelay(1);\n\tcko &= ~(MDLL_CKO__MCKOA_RESET | MDLL_CKO__MCKOB_RESET);\n\tOUTPLL(pllMDLL_CKO, cko);\n\tmdelay(5);\n\n\tcka &= ~(MDLL_RDCKA__MRDCKA0_SLEEP | MDLL_RDCKA__MRDCKA1_SLEEP);\n\tOUTPLL(pllMDLL_RDCKA, cka);\n\tmdelay(1);\n\tcka &= ~(MDLL_RDCKA__MRDCKA0_RESET | MDLL_RDCKA__MRDCKA1_RESET);\n\tOUTPLL(pllMDLL_RDCKA, cka);\n\tmdelay(5);\n\n\tckb &= ~(MDLL_RDCKB__MRDCKB0_SLEEP | MDLL_RDCKB__MRDCKB1_SLEEP);\n\tOUTPLL(pllMDLL_RDCKB, ckb);\n\tmdelay(1);\n\tckb &= ~(MDLL_RDCKB__MRDCKB0_RESET | MDLL_RDCKB__MRDCKB1_RESET);\n\tOUTPLL(pllMDLL_RDCKB, ckb);\n\tmdelay(5);\n\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_A1, 0x151550ff);\n\tOUTREG(MC_IND_INDEX, 0);\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_B1, 0x151550ff);\n\tOUTREG(MC_IND_INDEX, 0);\n\tmdelay(1);\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_A1, 0x141550ff);\n\tOUTREG(MC_IND_INDEX, 0);\n\tOUTMC(rinfo, ixMC_CHP_IO_CNTL_B1, 0x141550ff);\n\tOUTREG(MC_IND_INDEX, 0);\n\tmdelay(1);\n\n\tOUTPLL(pllHTOTAL_CNTL, 0);\n\tOUTPLL(pllHTOTAL2_CNTL, 0);\n\n\tOUTREG(MEM_CNTL, 0x29002901);\n\tOUTREG(MEM_SDRAM_MODE_REG, 0x45320032);\t \n\tOUTREG(EXT_MEM_CNTL, 0x1a394333);\n\tOUTREG(MEM_IO_CNTL_A1, 0x0aac0aac);\n\tOUTREG(MEM_INIT_LATENCY_TIMER, 0x34444444);\n\tOUTREG(MEM_REFRESH_CNTL, 0x1f1f7218);\t \n\tOUTREG(MC_DEBUG, 0);\n\tOUTREG(MEM_IO_OE_CNTL, 0x04300430);\n\n\tOUTMC(rinfo, ixMC_IMP_CNTL, 0x00f460d6);\n\tOUTREG(MC_IND_INDEX, 0);\n\tOUTMC(rinfo, ixMC_IMP_CNTL_0, 0x00009249);\n\tOUTREG(MC_IND_INDEX, 0);\n\n\tOUTREG(CNFG_MEMSIZE, rinfo->video_ram);\n\n\tradeon_pm_full_reset_sdram(rinfo);\n\n\tINREG(FP_GEN_CNTL);\n\tOUTREG(TMDS_CNTL, 0x01000000);\t \n\ttmp = INREG(FP_GEN_CNTL);\n\ttmp |= FP_CRTC_DONT_SHADOW_HEND | FP_CRTC_DONT_SHADOW_VPAR | 0x200;\n\tOUTREG(FP_GEN_CNTL, tmp);\n\n\ttmp = INREG(DISP_OUTPUT_CNTL);\n\ttmp &= ~0x400;\n\tOUTREG(DISP_OUTPUT_CNTL, tmp);\n\n\tOUTPLL(CLK_PIN_CNTL, rinfo->save_regs[4]);\n\tOUTPLL(CLK_PWRMGT_CNTL, rinfo->save_regs[1]);\n\tOUTPLL(PLL_PWRMGT_CNTL, rinfo->save_regs[0]);\n\n\ttmp = INPLL(MCLK_MISC);\n\ttmp |= MCLK_MISC__MC_MCLK_DYN_ENABLE | MCLK_MISC__IO_MCLK_DYN_ENABLE;\n\tOUTPLL(MCLK_MISC, tmp);\n\n\ttmp = INPLL(SCLK_CNTL);\n\tOUTPLL(SCLK_CNTL, tmp);\n\n\tOUTREG(CRTC_MORE_CNTL, 0);\n\tOUTREG8(CRTC_GEN_CNTL+1, 6);\n\tOUTREG8(CRTC_GEN_CNTL+3, 1);\n\tOUTREG(CRTC_PITCH, 32);\n\n\ttmp = INPLL(VCLK_ECP_CNTL);\n\tOUTPLL(VCLK_ECP_CNTL, tmp);\n\n\ttmp = INPLL(PPLL_CNTL);\n\tOUTPLL(PPLL_CNTL, tmp);\n\n\t \n\n\ttmp = INREG(FP_GEN_CNTL);\n\ttmp2 = INREG(TMDS_TRANSMITTER_CNTL);\n\ttmp |= 2;\n\tOUTREG(FP_GEN_CNTL, tmp);\n\tmdelay(5);\n\tOUTREG(FP_GEN_CNTL, tmp);\n\tmdelay(5);\n\tOUTREG(TMDS_TRANSMITTER_CNTL, tmp2);\n\tOUTREG(CRTC_MORE_CNTL, 0);\n\tmdelay(20);\n\n\ttmp = INREG(CRTC_MORE_CNTL);\n\tOUTREG(CRTC_MORE_CNTL, tmp);\n\n\tcgc = INREG(CRTC_GEN_CNTL);\n\tcec = INREG(CRTC_EXT_CNTL);\n\tc2gc = INREG(CRTC2_GEN_CNTL);\n\n\tOUTREG(CRTC_H_SYNC_STRT_WID, 0x008e0580);\n\tOUTREG(CRTC_H_TOTAL_DISP, 0x009f00d2);\n\tOUTREG8(CLOCK_CNTL_INDEX, HTOTAL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA, 0);\n\tradeon_pll_errata_after_data(rinfo);\n\tOUTREG(CRTC_V_SYNC_STRT_WID, 0x00830403);\n\tOUTREG(CRTC_V_TOTAL_DISP, 0x03ff0429);\n\tOUTREG(FP_CRTC_H_TOTAL_DISP, 0x009f0033);\n\tOUTREG(FP_H_SYNC_STRT_WID, 0x008e0080);\n\tOUTREG(CRT_CRTC_H_SYNC_STRT_WID, 0x008e0080);\n\tOUTREG(FP_CRTC_V_TOTAL_DISP, 0x03ff002a);\n\tOUTREG(FP_V_SYNC_STRT_WID, 0x00830004);\n\tOUTREG(CRT_CRTC_V_SYNC_STRT_WID, 0x00830004);\n\tOUTREG(FP_HORZ_VERT_ACTIVE, 0x009f03ff);\n\tOUTREG(FP_HORZ_STRETCH, 0);\n\tOUTREG(FP_VERT_STRETCH, 0);\n\tOUTREG(OVR_CLR, 0);\n\tOUTREG(OVR_WID_LEFT_RIGHT, 0);\n\tOUTREG(OVR_WID_TOP_BOTTOM, 0);\n\n\ttmp = INPLL(PPLL_REF_DIV);\n\ttmp = (tmp & ~PPLL_REF_DIV_MASK) | rinfo->pll.ref_div;\n\tOUTPLL(PPLL_REF_DIV, tmp);\n\tINPLL(PPLL_REF_DIV);\n\n\tOUTREG8(CLOCK_CNTL_INDEX, PPLL_CNTL + PLL_WR_EN);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG8(CLOCK_CNTL_DATA + 1, 0xbc);\n\tradeon_pll_errata_after_data(rinfo);\n\n\ttmp = INREG(CLOCK_CNTL_INDEX);\n\tradeon_pll_errata_after_index(rinfo);\n\tOUTREG(CLOCK_CNTL_INDEX, tmp & 0xff);\n\tradeon_pll_errata_after_index(rinfo);\n\tradeon_pll_errata_after_data(rinfo);\n\n\tOUTPLL(PPLL_DIV_0, 0x48090);\n\n\ttmp = INPLL(PPLL_CNTL);\n\tOUTPLL(PPLL_CNTL, tmp & ~0x2);\n\tmdelay(1);\n\ttmp = INPLL(PPLL_CNTL);\n\tOUTPLL(PPLL_CNTL, tmp & ~0x1);\n\tmdelay(10);\n\n\ttmp = INPLL(VCLK_ECP_CNTL);\n\tOUTPLL(VCLK_ECP_CNTL, tmp | 3);\n\tmdelay(1);\n\n\ttmp = INPLL(VCLK_ECP_CNTL);\n\tOUTPLL(VCLK_ECP_CNTL, tmp);\n\n\tc2gc |= CRTC2_DISP_REQ_EN_B;\n\tOUTREG(CRTC2_GEN_CNTL, c2gc);\n\tcgc |= CRTC_EN;\n\tOUTREG(CRTC_GEN_CNTL, cgc);\n\tOUTREG(CRTC_EXT_CNTL, cec);\n\tOUTREG(CRTC_PITCH, 0xa0);\n\tOUTREG(CRTC_OFFSET, 0);\n\tOUTREG(CRTC_OFFSET_CNTL, 0);\n\n\tOUTREG(GRPH_BUFFER_CNTL, 0x20117c7c);\n\tOUTREG(GRPH2_BUFFER_CNTL, 0x00205c5c);\n\n\ttmp2 = INREG(FP_GEN_CNTL);\n\ttmp = INREG(TMDS_TRANSMITTER_CNTL);\n\tOUTREG(0x2a8, 0x0000061b);\n\ttmp |= TMDS_PLL_EN;\n\tOUTREG(TMDS_TRANSMITTER_CNTL, tmp);\n\tmdelay(1);\n\ttmp &= ~TMDS_PLLRST;\n\tOUTREG(TMDS_TRANSMITTER_CNTL, tmp);\n\ttmp2 &= ~2;\n\ttmp2 |= FP_TMDS_EN;\n\tOUTREG(FP_GEN_CNTL, tmp2);\n\tmdelay(5);\n\ttmp2 |= FP_FPON;\n\tOUTREG(FP_GEN_CNTL, tmp2);\n\n\tOUTREG(CUR_HORZ_VERT_OFF, CUR_LOCK | 1);\n\tcgc = INREG(CRTC_GEN_CNTL);\n\tOUTREG(CUR_HORZ_VERT_POSN, 0xbfff0fff);\n\tcgc |= 0x10000;\n\tOUTREG(CUR_OFFSET, 0);\n}\n#endif  \n\n#endif  \n\nstatic void radeonfb_whack_power_state(struct radeonfb_info *rinfo, pci_power_t state)\n{\n\tu16 pwr_cmd;\n\n\tfor (;;) {\n\t\tpci_read_config_word(rinfo->pdev,\n\t\t\t\t     rinfo->pdev->pm_cap + PCI_PM_CTRL,\n\t\t\t\t     &pwr_cmd);\n\t\tif (pwr_cmd & state)\n\t\t\tbreak;\n\t\tpwr_cmd = (pwr_cmd & ~PCI_PM_CTRL_STATE_MASK) | state;\n\t\tpci_write_config_word(rinfo->pdev,\n\t\t\t\t      rinfo->pdev->pm_cap + PCI_PM_CTRL,\n\t\t\t\t      pwr_cmd);\n\t\tmsleep(500);\n\t}\n\trinfo->pdev->current_state = state;\n}\n\nstatic void radeon_set_suspend(struct radeonfb_info *rinfo, int suspend)\n{\n\tu32 tmp;\n\n\tif (!rinfo->pdev->pm_cap)\n\t\treturn;\n\n\t \n\tif (suspend) {\n\t\tprintk(KERN_DEBUG \"radeonfb (%s): switching to D2 state...\\n\",\n\t\t       pci_name(rinfo->pdev));\n\n\t\t \n\t\tradeon_pm_disable_dynamic_mode(rinfo);\n\n\t\t \n\t\tradeon_pm_save_regs(rinfo, 0);\n\n\t\t \n\t\tif (rinfo->is_mobility) {\n\t\t\t \n\t\t\tradeon_pm_program_v2clk(rinfo);\n\t\t\n\t\t\t \n\t\t\tradeon_pm_disable_iopad(rinfo);\n\n\t\t\t \n\t\t\tradeon_pm_low_current(rinfo);\n\n\t\t\t \n\t\t\tradeon_pm_setup_for_suspend(rinfo);\n\n\t\t\tif (rinfo->family <= CHIP_FAMILY_RV280) {\n\t\t\t\t \n\t\t\t\t \n\t\t\t\ttmp = INPLL( pllMDLL_CKO) | MDLL_CKO__MCKOA_RESET\n\t\t\t\t\t| MDLL_CKO__MCKOB_RESET;\n\t\t\t\tOUTPLL( pllMDLL_CKO, tmp );\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tpci_disable_device(rinfo->pdev);\n\t\tpci_save_state(rinfo->pdev);\n\t\t \n\t\tradeonfb_whack_power_state(rinfo, PCI_D2);\n\t\tpci_platform_power_transition(rinfo->pdev, PCI_D2);\n\t} else {\n\t\tprintk(KERN_DEBUG \"radeonfb (%s): switching to D0 state...\\n\",\n\t\t       pci_name(rinfo->pdev));\n\n\t\tif (rinfo->family <= CHIP_FAMILY_RV250) {\n\t\t\t \n\t\t\tradeon_pm_full_reset_sdram(rinfo);\n\n\t\t\t \n\t\t\tradeon_pm_restore_regs(rinfo);\n\t\t} else {\n\t\t\t \n\t\t\tradeon_pm_restore_regs(rinfo);\n\t\t\t \n\t\t\tradeon_pm_full_reset_sdram(rinfo);\n\t\t}\n\t}\n}\n\nstatic int radeonfb_pci_suspend_late(struct device *dev, pm_message_t mesg)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n        struct fb_info *info = pci_get_drvdata(pdev);\n        struct radeonfb_info *rinfo = info->par;\n\n\tif (mesg.event == pdev->dev.power.power_state.event)\n\t\treturn 0;\n\n\tprintk(KERN_DEBUG \"radeonfb (%s): suspending for event: %d...\\n\",\n\t       pci_name(pdev), mesg.event);\n\n\t \n\tswitch (mesg.event) {\n\tcase PM_EVENT_FREEZE:\t\t \n\tcase PM_EVENT_PRETHAW:\t\t \n\t\tgoto done;\n\t}\n\n\tconsole_lock();\n\n\tfb_set_suspend(info, 1);\n\n\tif (!(info->flags & FBINFO_HWACCEL_DISABLED)) {\n\t\t \n\t\tradeon_engine_idle();\n\t\tradeonfb_engine_reset(rinfo);\n\t\tradeon_engine_idle();\n\t}\n\n\t \n\tradeon_screen_blank(rinfo, FB_BLANK_POWERDOWN, 1);\n\n\t \n\trinfo->asleep = 1;\n\trinfo->lock_blank = 1;\n\tdel_timer_sync(&rinfo->lvds_timer);\n\n#ifdef CONFIG_PPC_PMAC\n\t \n\tpmac_suspend_agp_for_card(pdev);\n#endif  \n\n\t \n\tif (rinfo->pm_mode & radeon_pm_off) {\n\t\t \n\t\tradeon_pm_disable_dynamic_mode(rinfo);\n\t\tmsleep(50);\n\t\tradeon_pm_save_regs(rinfo, 1);\n\n\t\tif (rinfo->is_mobility && !(rinfo->pm_mode & radeon_pm_d2)) {\n\t\t\t \n\t\t\tusleep_range(1000, 2000);\n\t\t\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) & ~(LVDS_BL_MOD_EN));\n\t\t\tusleep_range(1000, 2000);\n\t\t\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) & ~(LVDS_EN | LVDS_ON));\n\t\t\tOUTREG(LVDS_PLL_CNTL, (INREG(LVDS_PLL_CNTL) & ~30000) | 0x20000);\n\t\t\tmsleep(20);\n\t\t\tOUTREG(LVDS_GEN_CNTL, INREG(LVDS_GEN_CNTL) & ~(LVDS_DIGON));\n\t\t}\n\t}\n\t \n\tif (rinfo->pm_mode & radeon_pm_d2)\n\t\tradeon_set_suspend(rinfo, 1);\n\n\tconsole_unlock();\n\n done:\n\tpdev->dev.power.power_state = mesg;\n\n\treturn 0;\n}\n\nstatic int radeonfb_pci_suspend(struct device *dev)\n{\n\treturn radeonfb_pci_suspend_late(dev, PMSG_SUSPEND);\n}\n\nstatic int radeonfb_pci_hibernate(struct device *dev)\n{\n\treturn radeonfb_pci_suspend_late(dev, PMSG_HIBERNATE);\n}\n\nstatic int radeonfb_pci_freeze(struct device *dev)\n{\n\treturn radeonfb_pci_suspend_late(dev, PMSG_FREEZE);\n}\n\nstatic int radeon_check_power_loss(struct radeonfb_info *rinfo)\n{\n\treturn rinfo->save_regs[4] != INPLL(CLK_PIN_CNTL) ||\n\t       rinfo->save_regs[2] != INPLL(MCLK_CNTL) ||\n\t       rinfo->save_regs[3] != INPLL(SCLK_CNTL);\n}\n\nstatic int radeonfb_pci_resume(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n        struct fb_info *info = pci_get_drvdata(pdev);\n        struct radeonfb_info *rinfo = info->par;\n\tint rc = 0;\n\n\tif (pdev->dev.power.power_state.event == PM_EVENT_ON)\n\t\treturn 0;\n\n\tif (rinfo->no_schedule) {\n\t\tif (!console_trylock())\n\t\t\treturn 0;\n\t} else\n\t\tconsole_lock();\n\n\tprintk(KERN_DEBUG \"radeonfb (%s): resuming from state: %d...\\n\",\n\t       pci_name(pdev), pdev->dev.power.power_state.event);\n\n\t \n\tif (pdev->dev.power.power_state.event == PM_EVENT_SUSPEND) {\n\t\t \n\t\tif ((rinfo->pm_mode & radeon_pm_off) && radeon_check_power_loss(rinfo)) {\n\t\t\tif (rinfo->reinit_func != NULL)\n\t\t\t\trinfo->reinit_func(rinfo);\n\t\t\telse {\n\t\t\t\tprintk(KERN_ERR \"radeonfb (%s): can't resume radeon from\"\n\t\t\t\t       \" D3 cold, need softboot !\", pci_name(pdev));\n\t\t\t\trc = -EIO;\n\t\t\t\tgoto bail;\n\t\t\t}\n\t\t}\n\t\t \n\t\telse if (rinfo->pm_mode & radeon_pm_d2)\n\t\t\tradeon_set_suspend(rinfo, 0);\n\n\t\trinfo->asleep = 0;\n\t} else\n\t\tradeon_engine_idle();\n\n\t \n\tradeon_write_mode (rinfo, &rinfo->state, 1);\n\tif (!(info->flags & FBINFO_HWACCEL_DISABLED))\n\t\tradeonfb_engine_init (rinfo);\n\n\tfb_pan_display(info, &info->var);\n\tfb_set_cmap(&info->cmap, info);\n\n\t \n\tfb_set_suspend(info, 0);\n\n\t \n\trinfo->lock_blank = 0;\n\tradeon_screen_blank(rinfo, FB_BLANK_UNBLANK, 1);\n\n#ifdef CONFIG_PPC_PMAC\n\t \n\tpmac_resume_agp_for_card(pdev);\n#endif  \n\n\n\t \n\tif (rinfo->dynclk == 1)\n\t\tradeon_pm_enable_dynamic_mode(rinfo);\n\telse if (rinfo->dynclk == 0)\n\t\tradeon_pm_disable_dynamic_mode(rinfo);\n\n\tpdev->dev.power.power_state = PMSG_ON;\n\n bail:\n\tconsole_unlock();\n\n\treturn rc;\n}\n\nconst struct dev_pm_ops radeonfb_pci_pm_ops = {\n\t.suspend\t= radeonfb_pci_suspend,\n\t.resume\t\t= radeonfb_pci_resume,\n\t.freeze\t\t= radeonfb_pci_freeze,\n\t.thaw\t\t= radeonfb_pci_resume,\n\t.poweroff\t= radeonfb_pci_hibernate,\n\t.restore\t= radeonfb_pci_resume,\n};\n\n#ifdef CONFIG_PPC__disabled\nstatic void radeonfb_early_resume(void *data)\n{\n        struct radeonfb_info *rinfo = data;\n\n\trinfo->no_schedule = 1;\n\tpci_restore_state(rinfo->pdev);\n\tradeonfb_pci_resume(rinfo->pdev);\n\trinfo->no_schedule = 0;\n}\n#endif  \n\n#endif  \n\nvoid radeonfb_pm_init(struct radeonfb_info *rinfo, int dynclk, int ignore_devlist, int force_sleep)\n{\n\t \n\tif (rinfo->family == CHIP_FAMILY_RS480)\n\t\trinfo->dynclk = -1;\n\telse\n\t\trinfo->dynclk = dynclk;\n\n\tif (rinfo->dynclk == 1) {\n\t\tradeon_pm_enable_dynamic_mode(rinfo);\n\t\tprintk(\"radeonfb: Dynamic Clock Power Management enabled\\n\");\n\t} else if (rinfo->dynclk == 0) {\n\t\tradeon_pm_disable_dynamic_mode(rinfo);\n\t\tprintk(\"radeonfb: Dynamic Clock Power Management disabled\\n\");\n\t}\n\n#if defined(CONFIG_PM)\n#if defined(CONFIG_PPC_PMAC)\n\t \n\tif (machine_is(powermac) && rinfo->of_node) {\n\t\tif (rinfo->is_mobility && rinfo->pdev->pm_cap &&\n\t\t    rinfo->family <= CHIP_FAMILY_RV250)\n\t\t\trinfo->pm_mode |= radeon_pm_d2;\n\n\t\t \n\t\tif (of_node_name_eq(rinfo->of_node, \"ATY,JasperParent\") ||\n\t\t    of_node_name_eq(rinfo->of_node, \"ATY,SnowyParent\")) {\n\t\t\trinfo->reinit_func = radeon_reinitialize_M10;\n\t\t\trinfo->pm_mode |= radeon_pm_off;\n\t\t}\n#if 0  \n\t\tif (!strcmp(rinfo->of_node->name, \"ATY,BlueStoneParent\")) {\n\t\t\trinfo->reinit_func = radeon_reinitialize_QW;\n\t\t\trinfo->pm_mode |= radeon_pm_off;\n\t\t}\n#endif\n\t\tif (of_node_name_eq(rinfo->of_node, \"ATY,ViaParent\")) {\n\t\t\trinfo->reinit_func = radeon_reinitialize_M9P;\n\t\t\trinfo->pm_mode |= radeon_pm_off;\n\t\t}\n\n\t\t \n\t\tif (rinfo->pm_mode != radeon_pm_none) {\n\t\t\tpmac_call_feature(PMAC_FTR_DEVICE_CAN_WAKE, rinfo->of_node, 0, 1);\n#if 0  \n\t\t\tpmac_set_early_video_resume(radeonfb_early_resume, rinfo);\n#endif\n\t\t}\n\n#if 0\n\t\t \n\t\tOUTREG(TV_DAC_CNTL, INREG(TV_DAC_CNTL) | 0x07000000);\n#endif\n\t}\n#endif  \n#endif  \n\n\tif (ignore_devlist)\n\t\tprintk(KERN_DEBUG\n\t\t       \"radeonfb: skipping test for device workarounds\\n\");\n\telse\n\t\tradeon_apply_workarounds(rinfo);\n\n\tif (force_sleep) {\n\t\tprintk(KERN_DEBUG\n\t\t       \"radeonfb: forcefully enabling D2 sleep mode\\n\");\n\t\trinfo->pm_mode |= radeon_pm_d2;\n\t}\n}\n\nvoid radeonfb_pm_exit(struct radeonfb_info *rinfo)\n{\n#if defined(CONFIG_PM) && defined(CONFIG_PPC_PMAC)\n\tif (rinfo->pm_mode != radeon_pm_none)\n\t\tpmac_set_early_video_resume(NULL, NULL);\n#endif\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}