{
  "module_name": "radeon_backlight.c",
  "hash_id": "7777ab951a000fc2301f7b804d07e3a5ec2e3b1e91d3f58c9c686353efd19293",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/aty/radeon_backlight.c",
  "human_readable_source": "\n \n\n#include \"radeonfb.h\"\n#include <linux/backlight.h>\n#include <linux/slab.h>\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n#include <asm/backlight.h>\n#endif\n\n#define MAX_RADEON_LEVEL 0xFF\n\nstruct radeon_bl_privdata {\n\tstruct radeonfb_info *rinfo;\n\tuint8_t negative;\n};\n\nstatic int radeon_bl_get_level_brightness(struct radeon_bl_privdata *pdata,\n\t\tint level)\n{\n\tint rlevel;\n\n\t \n\t \n\trlevel = pdata->rinfo->info->bl_curve[level] *\n\t\t FB_BACKLIGHT_MAX / MAX_RADEON_LEVEL;\n\n\tif (rlevel < 0)\n\t\trlevel = 0;\n\telse if (rlevel > MAX_RADEON_LEVEL)\n\t\trlevel = MAX_RADEON_LEVEL;\n\n\tif (pdata->negative)\n\t\trlevel = MAX_RADEON_LEVEL - rlevel;\n\n\treturn rlevel;\n}\n\nstatic int radeon_bl_update_status(struct backlight_device *bd)\n{\n\tstruct radeon_bl_privdata *pdata = bl_get_data(bd);\n\tstruct radeonfb_info *rinfo = pdata->rinfo;\n\tu32 lvds_gen_cntl, tmpPixclksCntl;\n\tint level;\n\n\tif (rinfo->mon1_type != MT_LCD)\n\t\treturn 0;\n\n\t \n\tlevel = backlight_get_brightness(bd);\n\n\tdel_timer_sync(&rinfo->lvds_timer);\n\tradeon_engine_idle();\n\n\tlvds_gen_cntl = INREG(LVDS_GEN_CNTL);\n\tif (level > 0) {\n\t\tlvds_gen_cntl &= ~LVDS_DISPLAY_DIS;\n\t\tif (!(lvds_gen_cntl & LVDS_BLON) || !(lvds_gen_cntl & LVDS_ON)) {\n\t\t\tlvds_gen_cntl |= (rinfo->init_state.lvds_gen_cntl & LVDS_DIGON);\n\t\t\tlvds_gen_cntl |= LVDS_BLON | LVDS_EN;\n\t\t\tOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\t\tlvds_gen_cntl &= ~LVDS_BL_MOD_LEVEL_MASK;\n\t\t\tlvds_gen_cntl |=\n\t\t\t\t(radeon_bl_get_level_brightness(pdata, level) <<\n\t\t\t\t LVDS_BL_MOD_LEVEL_SHIFT);\n\t\t\tlvds_gen_cntl |= LVDS_ON;\n\t\t\tlvds_gen_cntl |= (rinfo->init_state.lvds_gen_cntl & LVDS_BL_MOD_EN);\n\t\t\trinfo->pending_lvds_gen_cntl = lvds_gen_cntl;\n\t\t\tmod_timer(&rinfo->lvds_timer,\n\t\t\t\t  jiffies + msecs_to_jiffies(rinfo->panel_info.pwr_delay));\n\t\t} else {\n\t\t\tlvds_gen_cntl &= ~LVDS_BL_MOD_LEVEL_MASK;\n\t\t\tlvds_gen_cntl |=\n\t\t\t\t(radeon_bl_get_level_brightness(pdata, level) <<\n\t\t\t\t LVDS_BL_MOD_LEVEL_SHIFT);\n\t\t\tOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\t}\n\t\trinfo->init_state.lvds_gen_cntl &= ~LVDS_STATE_MASK;\n\t\trinfo->init_state.lvds_gen_cntl |= rinfo->pending_lvds_gen_cntl\n\t\t\t& LVDS_STATE_MASK;\n\t} else {\n\t\t \n\t\ttmpPixclksCntl = INPLL(PIXCLKS_CNTL);\n\t\tif (rinfo->is_mobility || rinfo->is_IGP)\n\t\t\tOUTPLLP(PIXCLKS_CNTL, 0, ~PIXCLK_LVDS_ALWAYS_ONb);\n\t\tlvds_gen_cntl &= ~(LVDS_BL_MOD_LEVEL_MASK | LVDS_BL_MOD_EN);\n\t\tlvds_gen_cntl |= (radeon_bl_get_level_brightness(pdata, 0) <<\n\t\t\t\t  LVDS_BL_MOD_LEVEL_SHIFT);\n\t\tlvds_gen_cntl |= LVDS_DISPLAY_DIS;\n\t\tOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\tudelay(100);\n\t\tlvds_gen_cntl &= ~(LVDS_ON | LVDS_EN);\n\t\tOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\tlvds_gen_cntl &= ~(LVDS_DIGON);\n\t\trinfo->pending_lvds_gen_cntl = lvds_gen_cntl;\n\t\tmod_timer(&rinfo->lvds_timer,\n\t\t\t  jiffies + msecs_to_jiffies(rinfo->panel_info.pwr_delay));\n\t\tif (rinfo->is_mobility || rinfo->is_IGP)\n\t\t\tOUTPLL(PIXCLKS_CNTL, tmpPixclksCntl);\n\t}\n\trinfo->init_state.lvds_gen_cntl &= ~LVDS_STATE_MASK;\n\trinfo->init_state.lvds_gen_cntl |= (lvds_gen_cntl & LVDS_STATE_MASK);\n\n\treturn 0;\n}\n\nstatic const struct backlight_ops radeon_bl_data = {\n\t.update_status\t= radeon_bl_update_status,\n};\n\nvoid radeonfb_bl_init(struct radeonfb_info *rinfo)\n{\n\tstruct backlight_properties props;\n\tstruct backlight_device *bd;\n\tstruct radeon_bl_privdata *pdata;\n\tchar name[12];\n\n\tif (rinfo->mon1_type != MT_LCD)\n\t\treturn;\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n\tif (!pmac_has_backlight_type(\"ati\") &&\n\t    !pmac_has_backlight_type(\"mnca\"))\n\t\treturn;\n#endif\n\n\tpdata = kmalloc(sizeof(struct radeon_bl_privdata), GFP_KERNEL);\n\tif (!pdata) {\n\t\tprintk(\"radeonfb: Memory allocation failed\\n\");\n\t\tgoto error;\n\t}\n\n\tsnprintf(name, sizeof(name), \"radeonbl%d\", rinfo->info->node);\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = FB_BACKLIGHT_LEVELS - 1;\n\tbd = backlight_device_register(name, rinfo->info->device, pdata,\n\t\t\t\t       &radeon_bl_data, &props);\n\tif (IS_ERR(bd)) {\n\t\trinfo->info->bl_dev = NULL;\n\t\tprintk(\"radeonfb: Backlight registration failed\\n\");\n\t\tgoto error;\n\t}\n\n\tpdata->rinfo = rinfo;\n\n\t \n\tpdata->negative =\n\t\t(rinfo->family != CHIP_FAMILY_RV200 &&\n\t\t rinfo->family != CHIP_FAMILY_RV250 &&\n\t\t rinfo->family != CHIP_FAMILY_RV280 &&\n\t\t rinfo->family != CHIP_FAMILY_RV350);\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n\tpdata->negative = pdata->negative ||\n\t\tof_machine_is_compatible(\"PowerBook4,3\") ||\n\t\tof_machine_is_compatible(\"PowerBook6,3\") ||\n\t\tof_machine_is_compatible(\"PowerBook6,5\");\n#endif\n\n\trinfo->info->bl_dev = bd;\n\tfb_bl_default_curve(rinfo->info, 0,\n\t\t 63 * FB_BACKLIGHT_MAX / MAX_RADEON_LEVEL,\n\t\t217 * FB_BACKLIGHT_MAX / MAX_RADEON_LEVEL);\n\n\tbd->props.brightness = bd->props.max_brightness;\n\tbd->props.power = FB_BLANK_UNBLANK;\n\tbacklight_update_status(bd);\n\n\tprintk(\"radeonfb: Backlight initialized (%s)\\n\", name);\n\n\treturn;\n\nerror:\n\tkfree(pdata);\n\treturn;\n}\n\nvoid radeonfb_bl_exit(struct radeonfb_info *rinfo)\n{\n\tstruct backlight_device *bd = rinfo->info->bl_dev;\n\n\tif (bd) {\n\t\tstruct radeon_bl_privdata *pdata;\n\n\t\tpdata = bl_get_data(bd);\n\t\tbacklight_device_unregister(bd);\n\t\tkfree(pdata);\n\t\trinfo->info->bl_dev = NULL;\n\n\t\tprintk(\"radeonfb: Backlight unloaded\\n\");\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}