{
  "module_name": "radeon_accel.c",
  "hash_id": "26756cbe6c86a32acd221bea45504c259d0ef5ce844feba779382b922d8e33f9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/aty/radeon_accel.c",
  "human_readable_source": "\n#include \"radeonfb.h\"\n\n \n\nstatic void radeon_fixup_offset(struct radeonfb_info *rinfo)\n{\n\tu32 local_base;\n\n\t \n\t \n\n\tradeon_fifo_wait (1);\n\tlocal_base = INREG(MC_FB_LOCATION) << 16;\n\tif (local_base == rinfo->fb_local_base)\n\t\treturn;\n\n\trinfo->fb_local_base = local_base;\n\n\tradeon_fifo_wait (3);\n\tOUTREG(DEFAULT_PITCH_OFFSET, (rinfo->pitch << 0x16) |\n\t\t\t\t     (rinfo->fb_local_base >> 10));\n\tOUTREG(DST_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\n\tOUTREG(SRC_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\n}\n\nstatic void radeonfb_prim_fillrect(struct radeonfb_info *rinfo, \n\t\t\t\t   const struct fb_fillrect *region)\n{\n\tradeon_fifo_wait(4);  \n  \n\tOUTREG(DP_GUI_MASTER_CNTL,  \n\t\trinfo->dp_gui_master_cntl   \n                | GMC_BRUSH_SOLID_COLOR\n                | ROP3_P);\n\tif (radeon_get_dstbpp(rinfo->depth) != DST_8BPP)\n\t\tOUTREG(DP_BRUSH_FRGD_CLR, rinfo->pseudo_palette[region->color]);\n\telse\n\t\tOUTREG(DP_BRUSH_FRGD_CLR, region->color);\n\tOUTREG(DP_WRITE_MSK, 0xffffffff);\n\tOUTREG(DP_CNTL, (DST_X_LEFT_TO_RIGHT | DST_Y_TOP_TO_BOTTOM));\n\n\tradeon_fifo_wait(2);\n\tOUTREG(DSTCACHE_CTLSTAT, RB2D_DC_FLUSH_ALL);\n\tOUTREG(WAIT_UNTIL, (WAIT_2D_IDLECLEAN | WAIT_DMA_GUI_IDLE));\n\n\tradeon_fifo_wait(2);  \n\tOUTREG(DST_Y_X, (region->dy << 16) | region->dx);\n\tOUTREG(DST_WIDTH_HEIGHT, (region->width << 16) | region->height);\n}\n\nvoid radeonfb_fillrect(struct fb_info *info, const struct fb_fillrect *region)\n{\n\tstruct radeonfb_info *rinfo = info->par;\n\tstruct fb_fillrect modded;\n\tint vxres, vyres;\n  \n\tif (info->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\tif (info->flags & FBINFO_HWACCEL_DISABLED) {\n\t\tcfb_fillrect(info, region);\n\t\treturn;\n\t}\n\n\tradeon_fixup_offset(rinfo);\n\n\tvxres = info->var.xres_virtual;\n\tvyres = info->var.yres_virtual;\n\n\tmemcpy(&modded, region, sizeof(struct fb_fillrect));\n\n\tif(!modded.width || !modded.height ||\n\t   modded.dx >= vxres || modded.dy >= vyres)\n\t\treturn;\n  \n\tif(modded.dx + modded.width  > vxres) modded.width  = vxres - modded.dx;\n\tif(modded.dy + modded.height > vyres) modded.height = vyres - modded.dy;\n\n\tradeonfb_prim_fillrect(rinfo, &modded);\n}\n\nstatic void radeonfb_prim_copyarea(struct radeonfb_info *rinfo, \n\t\t\t\t   const struct fb_copyarea *area)\n{\n\tint xdir, ydir;\n\tu32 sx, sy, dx, dy, w, h;\n\n\tw = area->width; h = area->height;\n\tdx = area->dx; dy = area->dy;\n\tsx = area->sx; sy = area->sy;\n\txdir = sx - dx;\n\tydir = sy - dy;\n\n\tif ( xdir < 0 ) { sx += w-1; dx += w-1; }\n\tif ( ydir < 0 ) { sy += h-1; dy += h-1; }\n\n\tradeon_fifo_wait(3);\n\tOUTREG(DP_GUI_MASTER_CNTL,\n\t\trinfo->dp_gui_master_cntl  \n\t\t| GMC_BRUSH_NONE\n\t\t| GMC_SRC_DSTCOLOR\n\t\t| ROP3_S \n\t\t| DP_SRC_SOURCE_MEMORY );\n\tOUTREG(DP_WRITE_MSK, 0xffffffff);\n\tOUTREG(DP_CNTL, (xdir>=0 ? DST_X_LEFT_TO_RIGHT : 0)\n\t\t\t| (ydir>=0 ? DST_Y_TOP_TO_BOTTOM : 0));\n\n\tradeon_fifo_wait(2);\n\tOUTREG(DSTCACHE_CTLSTAT, RB2D_DC_FLUSH_ALL);\n\tOUTREG(WAIT_UNTIL, (WAIT_2D_IDLECLEAN | WAIT_DMA_GUI_IDLE));\n\n\tradeon_fifo_wait(3);\n\tOUTREG(SRC_Y_X, (sy << 16) | sx);\n\tOUTREG(DST_Y_X, (dy << 16) | dx);\n\tOUTREG(DST_HEIGHT_WIDTH, (h << 16) | w);\n}\n\n\nvoid radeonfb_copyarea(struct fb_info *info, const struct fb_copyarea *area)\n{\n\tstruct radeonfb_info *rinfo = info->par;\n\tstruct fb_copyarea modded;\n\tu32 vxres, vyres;\n\tmodded.sx = area->sx;\n\tmodded.sy = area->sy;\n\tmodded.dx = area->dx;\n\tmodded.dy = area->dy;\n\tmodded.width  = area->width;\n\tmodded.height = area->height;\n  \n\tif (info->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\tif (info->flags & FBINFO_HWACCEL_DISABLED) {\n\t\tcfb_copyarea(info, area);\n\t\treturn;\n\t}\n\n\tradeon_fixup_offset(rinfo);\n\n\tvxres = info->var.xres_virtual;\n\tvyres = info->var.yres_virtual;\n\n\tif(!modded.width || !modded.height ||\n\t   modded.sx >= vxres || modded.sy >= vyres ||\n\t   modded.dx >= vxres || modded.dy >= vyres)\n\t\treturn;\n  \n\tif(modded.sx + modded.width > vxres)  modded.width = vxres - modded.sx;\n\tif(modded.dx + modded.width > vxres)  modded.width = vxres - modded.dx;\n\tif(modded.sy + modded.height > vyres) modded.height = vyres - modded.sy;\n\tif(modded.dy + modded.height > vyres) modded.height = vyres - modded.dy;\n  \n\tradeonfb_prim_copyarea(rinfo, &modded);\n}\n\nvoid radeonfb_imageblit(struct fb_info *info, const struct fb_image *image)\n{\n\tstruct radeonfb_info *rinfo = info->par;\n\n\tif (info->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\tradeon_engine_idle();\n\n\tcfb_imageblit(info, image);\n}\n\nint radeonfb_sync(struct fb_info *info)\n{\n\tstruct radeonfb_info *rinfo = info->par;\n\n\tif (info->state != FBINFO_STATE_RUNNING)\n\t\treturn 0;\n\tradeon_engine_idle();\n\n\treturn 0;\n}\n\nvoid radeonfb_engine_reset(struct radeonfb_info *rinfo)\n{\n\tu32 clock_cntl_index, mclk_cntl, rbbm_soft_reset;\n\tu32 host_path_cntl;\n\n\tradeon_engine_flush (rinfo);\n\n\tclock_cntl_index = INREG(CLOCK_CNTL_INDEX);\n\tmclk_cntl = INPLL(MCLK_CNTL);\n\n\tOUTPLL(MCLK_CNTL, (mclk_cntl |\n\t\t\t   FORCEON_MCLKA |\n\t\t\t   FORCEON_MCLKB |\n\t\t\t   FORCEON_YCLKA |\n\t\t\t   FORCEON_YCLKB |\n\t\t\t   FORCEON_MC |\n\t\t\t   FORCEON_AIC));\n\n\thost_path_cntl = INREG(HOST_PATH_CNTL);\n\trbbm_soft_reset = INREG(RBBM_SOFT_RESET);\n\n\tif (IS_R300_VARIANT(rinfo)) {\n\t\tu32 tmp;\n\n\t\tOUTREG(RBBM_SOFT_RESET, (rbbm_soft_reset |\n\t\t\t\t\t SOFT_RESET_CP |\n\t\t\t\t\t SOFT_RESET_HI |\n\t\t\t\t\t SOFT_RESET_E2));\n\t\tINREG(RBBM_SOFT_RESET);\n\t\tOUTREG(RBBM_SOFT_RESET, 0);\n\t\ttmp = INREG(RB2D_DSTCACHE_MODE);\n\t\tOUTREG(RB2D_DSTCACHE_MODE, tmp | (1 << 17));  \n\t} else {\n\t\tOUTREG(RBBM_SOFT_RESET, rbbm_soft_reset |\n\t\t\t\t\tSOFT_RESET_CP |\n\t\t\t\t\tSOFT_RESET_HI |\n\t\t\t\t\tSOFT_RESET_SE |\n\t\t\t\t\tSOFT_RESET_RE |\n\t\t\t\t\tSOFT_RESET_PP |\n\t\t\t\t\tSOFT_RESET_E2 |\n\t\t\t\t\tSOFT_RESET_RB);\n\t\tINREG(RBBM_SOFT_RESET);\n\t\tOUTREG(RBBM_SOFT_RESET, rbbm_soft_reset & (u32)\n\t\t\t\t\t~(SOFT_RESET_CP |\n\t\t\t\t\t  SOFT_RESET_HI |\n\t\t\t\t\t  SOFT_RESET_SE |\n\t\t\t\t\t  SOFT_RESET_RE |\n\t\t\t\t\t  SOFT_RESET_PP |\n\t\t\t\t\t  SOFT_RESET_E2 |\n\t\t\t\t\t  SOFT_RESET_RB));\n\t\tINREG(RBBM_SOFT_RESET);\n\t}\n\n\tOUTREG(HOST_PATH_CNTL, host_path_cntl | HDP_SOFT_RESET);\n\tINREG(HOST_PATH_CNTL);\n\tOUTREG(HOST_PATH_CNTL, host_path_cntl);\n\n\tif (!IS_R300_VARIANT(rinfo))\n\t\tOUTREG(RBBM_SOFT_RESET, rbbm_soft_reset);\n\n\tOUTREG(CLOCK_CNTL_INDEX, clock_cntl_index);\n\tOUTPLL(MCLK_CNTL, mclk_cntl);\n}\n\nvoid radeonfb_engine_init (struct radeonfb_info *rinfo)\n{\n\tunsigned long temp;\n\n\t \n\tOUTREG(RB3D_CNTL, 0);\n\n\tradeonfb_engine_reset(rinfo);\n\n\tradeon_fifo_wait (1);\n\tif (IS_R300_VARIANT(rinfo)) {\n\t\tOUTREG(RB2D_DSTCACHE_MODE, INREG(RB2D_DSTCACHE_MODE) |\n\t\t       RB2D_DC_AUTOFLUSH_ENABLE |\n\t\t       RB2D_DC_DC_DISABLE_IGNORE_PE);\n\t} else {\n\t\t \n\t\tOUTREG(RB2D_DSTCACHE_MODE, 0);\n\t}\n\n\tradeon_fifo_wait (3);\n\t \n\trinfo->fb_local_base = INREG(MC_FB_LOCATION) << 16;\n\n\tOUTREG(DEFAULT_PITCH_OFFSET, (rinfo->pitch << 0x16) |\n\t\t\t\t     (rinfo->fb_local_base >> 10));\n\tOUTREG(DST_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\n\tOUTREG(SRC_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\n\n\tradeon_fifo_wait (1);\n#if defined(__BIG_ENDIAN)\n\tOUTREGP(DP_DATATYPE, HOST_BIG_ENDIAN_EN, ~HOST_BIG_ENDIAN_EN);\n#else\n\tOUTREGP(DP_DATATYPE, 0, ~HOST_BIG_ENDIAN_EN);\n#endif\n\tradeon_fifo_wait (2);\n\tOUTREG(DEFAULT_SC_TOP_LEFT, 0);\n\tOUTREG(DEFAULT_SC_BOTTOM_RIGHT, (DEFAULT_SC_RIGHT_MAX |\n\t\t\t\t\t DEFAULT_SC_BOTTOM_MAX));\n\n\ttemp = radeon_get_dstbpp(rinfo->depth);\n\trinfo->dp_gui_master_cntl = ((temp << 8) | GMC_CLR_CMP_CNTL_DIS);\n\n\tradeon_fifo_wait (1);\n\tOUTREG(DP_GUI_MASTER_CNTL, (rinfo->dp_gui_master_cntl |\n\t\t\t\t    GMC_BRUSH_SOLID_COLOR |\n\t\t\t\t    GMC_SRC_DATATYPE_COLOR));\n\n\tradeon_fifo_wait (7);\n\n\t \n\tOUTREG(DST_LINE_START, 0);\n\tOUTREG(DST_LINE_END, 0);\n\n\t \n\tOUTREG(DP_BRUSH_FRGD_CLR, 0xffffffff);\n\tOUTREG(DP_BRUSH_BKGD_CLR, 0x00000000);\n\n\t \n\tOUTREG(DP_SRC_FRGD_CLR, 0xffffffff);\n\tOUTREG(DP_SRC_BKGD_CLR, 0x00000000);\n\n\t \n\tOUTREG(DP_WRITE_MSK, 0xffffffff);\n\n\tradeon_engine_idle ();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}