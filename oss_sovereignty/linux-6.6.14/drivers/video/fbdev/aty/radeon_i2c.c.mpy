{
  "module_name": "radeon_i2c.c",
  "hash_id": "9c025a046a7984b43d34b3d69d4fd0b53452a21d260266958a1b2b99d611de9e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/aty/radeon_i2c.c",
  "human_readable_source": "\n#include \"radeonfb.h\"\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/fb.h>\n\n\n#include <linux/i2c.h>\n#include <linux/i2c-algo-bit.h>\n\n#include <asm/io.h>\n\n#include <video/radeon.h>\n#include \"../edid.h\"\n\nstatic void radeon_gpio_setscl(void* data, int state)\n{\n\tstruct radeon_i2c_chan \t*chan = data;\n\tstruct radeonfb_info\t*rinfo = chan->rinfo;\n\tu32\t\t\tval;\n\t\n\tval = INREG(chan->ddc_reg) & ~(VGA_DDC_CLK_OUT_EN);\n\tif (!state)\n\t\tval |= VGA_DDC_CLK_OUT_EN;\n\n\tOUTREG(chan->ddc_reg, val);\n\t(void)INREG(chan->ddc_reg);\n}\n\nstatic void radeon_gpio_setsda(void* data, int state)\n{\n\tstruct radeon_i2c_chan \t*chan = data;\n\tstruct radeonfb_info\t*rinfo = chan->rinfo;\n\tu32\t\t\tval;\n\t\n\tval = INREG(chan->ddc_reg) & ~(VGA_DDC_DATA_OUT_EN);\n\tif (!state)\n\t\tval |= VGA_DDC_DATA_OUT_EN;\n\n\tOUTREG(chan->ddc_reg, val);\n\t(void)INREG(chan->ddc_reg);\n}\n\nstatic int radeon_gpio_getscl(void* data)\n{\n\tstruct radeon_i2c_chan \t*chan = data;\n\tstruct radeonfb_info\t*rinfo = chan->rinfo;\n\tu32\t\t\tval;\n\t\n\tval = INREG(chan->ddc_reg);\n\n\treturn (val & VGA_DDC_CLK_INPUT) ? 1 : 0;\n}\n\nstatic int radeon_gpio_getsda(void* data)\n{\n\tstruct radeon_i2c_chan \t*chan = data;\n\tstruct radeonfb_info\t*rinfo = chan->rinfo;\n\tu32\t\t\tval;\n\t\n\tval = INREG(chan->ddc_reg);\n\n\treturn (val & VGA_DDC_DATA_INPUT) ? 1 : 0;\n}\n\nstatic int radeon_setup_i2c_bus(struct radeon_i2c_chan *chan, const char *name)\n{\n\tint rc;\n\n\tsnprintf(chan->adapter.name, sizeof(chan->adapter.name),\n\t\t \"radeonfb %s\", name);\n\tchan->adapter.owner\t\t= THIS_MODULE;\n\tchan->adapter.algo_data\t\t= &chan->algo;\n\tchan->adapter.dev.parent\t= &chan->rinfo->pdev->dev;\n\tchan->algo.setsda\t\t= radeon_gpio_setsda;\n\tchan->algo.setscl\t\t= radeon_gpio_setscl;\n\tchan->algo.getsda\t\t= radeon_gpio_getsda;\n\tchan->algo.getscl\t\t= radeon_gpio_getscl;\n\tchan->algo.udelay\t\t= 10;\n\tchan->algo.timeout\t\t= 20;\n\tchan->algo.data \t\t= chan;\t\n\t\n\ti2c_set_adapdata(&chan->adapter, chan);\n\t\n\t \n\tradeon_gpio_setsda(chan, 1);\n\tradeon_gpio_setscl(chan, 1);\n\tudelay(20);\n\n\trc = i2c_bit_add_bus(&chan->adapter);\n\tif (rc == 0)\n\t\tdev_dbg(&chan->rinfo->pdev->dev, \"I2C bus %s registered.\\n\", name);\n\telse\n\t\tdev_warn(&chan->rinfo->pdev->dev, \"Failed to register I2C bus %s.\\n\", name);\n\treturn rc;\n}\n\nvoid radeon_create_i2c_busses(struct radeonfb_info *rinfo)\n{\n\trinfo->i2c[0].rinfo\t= rinfo;\n\trinfo->i2c[0].ddc_reg\t= GPIO_MONID;\n#ifndef CONFIG_PPC\n\trinfo->i2c[0].adapter.class = I2C_CLASS_HWMON;\n#endif\n\tradeon_setup_i2c_bus(&rinfo->i2c[0], \"monid\");\n\n\trinfo->i2c[1].rinfo\t= rinfo;\n\trinfo->i2c[1].ddc_reg\t= GPIO_DVI_DDC;\n\tradeon_setup_i2c_bus(&rinfo->i2c[1], \"dvi\");\n\n\trinfo->i2c[2].rinfo\t= rinfo;\n\trinfo->i2c[2].ddc_reg\t= GPIO_VGA_DDC;\n\tradeon_setup_i2c_bus(&rinfo->i2c[2], \"vga\");\n\n\trinfo->i2c[3].rinfo\t= rinfo;\n\trinfo->i2c[3].ddc_reg\t= GPIO_CRT2_DDC;\n\tradeon_setup_i2c_bus(&rinfo->i2c[3], \"crt2\");\n}\n\nvoid radeon_delete_i2c_busses(struct radeonfb_info *rinfo)\n{\n\tif (rinfo->i2c[0].rinfo)\n\t\ti2c_del_adapter(&rinfo->i2c[0].adapter);\n\trinfo->i2c[0].rinfo = NULL;\n\n\tif (rinfo->i2c[1].rinfo)\n\t\ti2c_del_adapter(&rinfo->i2c[1].adapter);\n\trinfo->i2c[1].rinfo = NULL;\n\n\tif (rinfo->i2c[2].rinfo)\n\t\ti2c_del_adapter(&rinfo->i2c[2].adapter);\n\trinfo->i2c[2].rinfo = NULL;\n\n\tif (rinfo->i2c[3].rinfo)\n\t\ti2c_del_adapter(&rinfo->i2c[3].adapter);\n\trinfo->i2c[3].rinfo = NULL;\n}\n\nint radeon_probe_i2c_connector(struct radeonfb_info *rinfo, int conn,\n\t\t\t       u8 **out_edid)\n{\n\tu8 *edid;\n\n\tedid = fb_ddc_read(&rinfo->i2c[conn-1].adapter);\n\n\tif (out_edid)\n\t\t*out_edid = edid;\n\tif (!edid) {\n\t\tpr_debug(\"radeonfb: I2C (port %d) ... not found\\n\", conn);\n\t\treturn MT_NONE;\n\t}\n\tif (edid[0x14] & 0x80) {\n\t\t \n\t\tif (rinfo->is_mobility   &&\n\t\t    (INREG(LVDS_GEN_CNTL) & LVDS_ON)) {\n\t\t\tpr_debug(\"radeonfb: I2C (port %d) ... found LVDS panel\\n\", conn);\n\t\t\treturn MT_LCD;\n\t\t} else {\n\t\t\tpr_debug(\"radeonfb: I2C (port %d) ... found TMDS panel\\n\", conn);\n\t\t\treturn MT_DFP;\n\t\t}\n\t}\n\tpr_debug(\"radeonfb: I2C (port %d) ... found CRT display\\n\", conn);\n\treturn MT_CRT;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}