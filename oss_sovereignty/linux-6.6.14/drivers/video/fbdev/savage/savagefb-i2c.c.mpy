{
  "module_name": "savagefb-i2c.c",
  "hash_id": "8b0b6bda1c1edb95665f53b563bcf7c5a1e362fef99772c014076caf1d1cee53",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/savage/savagefb-i2c.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/gfp.h>\n#include <linux/pci.h>\n#include <linux/fb.h>\n\n#include <asm/io.h>\n#include \"savagefb.h\"\n\n#define SAVAGE_DDC \t0x50\n\n#define VGA_CR_IX\t0x3d4\n#define VGA_CR_DATA\t0x3d5\n\n#define CR_SERIAL1\t0xa0\t \n#define MM_SERIAL1\t0xff20\n#define CR_SERIAL2\t0xb1\t \n\n \n#define PROSAVAGE_I2C_ENAB\t0x10\n#define PROSAVAGE_I2C_SCL_OUT\t0x01\n#define PROSAVAGE_I2C_SDA_OUT\t0x02\n#define PROSAVAGE_I2C_SCL_IN\t0x04\n#define PROSAVAGE_I2C_SDA_IN\t0x08\n\n#define SAVAGE4_I2C_ENAB\t0x00000020\n#define SAVAGE4_I2C_SCL_OUT\t0x00000001\n#define SAVAGE4_I2C_SDA_OUT\t0x00000002\n#define SAVAGE4_I2C_SCL_IN\t0x00000008\n#define SAVAGE4_I2C_SDA_IN\t0x00000010\n\nstatic void savage4_gpio_setscl(void *data, int val)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\tunsigned int r;\n\n\tr = readl(chan->ioaddr + chan->reg);\n\tif(val)\n\t\tr |= SAVAGE4_I2C_SCL_OUT;\n\telse\n\t\tr &= ~SAVAGE4_I2C_SCL_OUT;\n\twritel(r, chan->ioaddr + chan->reg);\n\treadl(chan->ioaddr + chan->reg);\t \n}\n\nstatic void savage4_gpio_setsda(void *data, int val)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\n\tunsigned int r;\n\tr = readl(chan->ioaddr + chan->reg);\n\tif(val)\n\t\tr |= SAVAGE4_I2C_SDA_OUT;\n\telse\n\t\tr &= ~SAVAGE4_I2C_SDA_OUT;\n\twritel(r, chan->ioaddr + chan->reg);\n\treadl(chan->ioaddr + chan->reg);\t \n}\n\nstatic int savage4_gpio_getscl(void *data)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\n\treturn (0 != (readl(chan->ioaddr + chan->reg) & SAVAGE4_I2C_SCL_IN));\n}\n\nstatic int savage4_gpio_getsda(void *data)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\n\treturn (0 != (readl(chan->ioaddr + chan->reg) & SAVAGE4_I2C_SDA_IN));\n}\n\nstatic void prosavage_gpio_setscl(void* data, int val)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\tu32\t\t\t  r;\n\n\tr = VGArCR(chan->reg, chan->par);\n\tr |= PROSAVAGE_I2C_ENAB;\n\tif (val) {\n\t\tr |= PROSAVAGE_I2C_SCL_OUT;\n\t} else {\n\t\tr &= ~PROSAVAGE_I2C_SCL_OUT;\n\t}\n\n\tVGAwCR(chan->reg, r, chan->par);\n}\n\nstatic void prosavage_gpio_setsda(void* data, int val)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\tunsigned int r;\n\n\tr = VGArCR(chan->reg, chan->par);\n\tr |= PROSAVAGE_I2C_ENAB;\n\tif (val) {\n\t\tr |= PROSAVAGE_I2C_SDA_OUT;\n\t} else {\n\t\tr &= ~PROSAVAGE_I2C_SDA_OUT;\n\t}\n\n\tVGAwCR(chan->reg, r, chan->par);\n}\n\nstatic int prosavage_gpio_getscl(void* data)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\n\treturn (VGArCR(chan->reg, chan->par) & PROSAVAGE_I2C_SCL_IN) ? 1 : 0;\n}\n\nstatic int prosavage_gpio_getsda(void* data)\n{\n\tstruct savagefb_i2c_chan *chan = data;\n\n\treturn (VGArCR(chan->reg, chan->par) & PROSAVAGE_I2C_SDA_IN) ? 1 : 0;\n}\n\nstatic int savage_setup_i2c_bus(struct savagefb_i2c_chan *chan,\n\t\t\t\tconst char *name)\n{\n\tint rc = 0;\n\n\tif (chan->par) {\n\t\tstrcpy(chan->adapter.name, name);\n\t\tchan->adapter.owner\t\t= THIS_MODULE;\n\t\tchan->adapter.algo_data\t\t= &chan->algo;\n\t\tchan->adapter.dev.parent\t= &chan->par->pcidev->dev;\n\t\tchan->algo.udelay\t\t= 10;\n\t\tchan->algo.timeout\t\t= 20;\n\t\tchan->algo.data \t\t= chan;\n\n\t\ti2c_set_adapdata(&chan->adapter, chan);\n\n\t\t \n\t\tchan->algo.setsda(chan, 1);\n\t\tchan->algo.setscl(chan, 1);\n\t\tudelay(20);\n\n\t\trc = i2c_bit_add_bus(&chan->adapter);\n\n\t\tif (rc == 0)\n\t\t\tdev_dbg(&chan->par->pcidev->dev,\n\t\t\t\t\"I2C bus %s registered.\\n\", name);\n\t\telse\n\t\t\tdev_warn(&chan->par->pcidev->dev,\n\t\t\t\t \"Failed to register I2C bus %s.\\n\", name);\n\t}\n\n\treturn rc;\n}\n\nvoid savagefb_create_i2c_busses(struct fb_info *info)\n{\n\tstruct savagefb_par *par = info->par;\n\tpar->chan.par\t= par;\n\n\tswitch (par->chip) {\n\tcase S3_PROSAVAGE:\n\tcase S3_PROSAVAGEDDR:\n\tcase S3_TWISTER:\n\t\tpar->chan.reg         = CR_SERIAL2;\n\t\tpar->chan.ioaddr      = par->mmio.vbase;\n\t\tpar->chan.algo.setsda = prosavage_gpio_setsda;\n\t\tpar->chan.algo.setscl = prosavage_gpio_setscl;\n\t\tpar->chan.algo.getsda = prosavage_gpio_getsda;\n\t\tpar->chan.algo.getscl = prosavage_gpio_getscl;\n\t\tbreak;\n\tcase S3_SAVAGE4:\n\t\tpar->chan.reg = CR_SERIAL1;\n\t\tif (par->pcidev->revision > 1 && !(VGArCR(0xa6, par) & 0x40))\n\t\t\tpar->chan.reg = CR_SERIAL2;\n\t\tpar->chan.ioaddr      = par->mmio.vbase;\n\t\tpar->chan.algo.setsda = prosavage_gpio_setsda;\n\t\tpar->chan.algo.setscl = prosavage_gpio_setscl;\n\t\tpar->chan.algo.getsda = prosavage_gpio_getsda;\n\t\tpar->chan.algo.getscl = prosavage_gpio_getscl;\n\t\tbreak;\n\tcase S3_SAVAGE2000:\n\t\tpar->chan.reg         = MM_SERIAL1;\n\t\tpar->chan.ioaddr      = par->mmio.vbase;\n\t\tpar->chan.algo.setsda = savage4_gpio_setsda;\n\t\tpar->chan.algo.setscl = savage4_gpio_setscl;\n\t\tpar->chan.algo.getsda = savage4_gpio_getsda;\n\t\tpar->chan.algo.getscl = savage4_gpio_getscl;\n\t\tbreak;\n\tdefault:\n\t\tpar->chan.par = NULL;\n\t}\n\n\tsavage_setup_i2c_bus(&par->chan, \"SAVAGE DDC2\");\n}\n\nvoid savagefb_delete_i2c_busses(struct fb_info *info)\n{\n\tstruct savagefb_par *par = info->par;\n\n\tif (par->chan.par)\n\t\ti2c_del_adapter(&par->chan.adapter);\n\n\tpar->chan.par = NULL;\n}\n\nint savagefb_probe_i2c_connector(struct fb_info *info, u8 **out_edid)\n{\n\tstruct savagefb_par *par = info->par;\n\tu8 *edid;\n\n\tif (par->chan.par)\n\t\tedid = fb_ddc_read(&par->chan.adapter);\n\telse\n\t\tedid = NULL;\n\n\tif (!edid) {\n\t\t \n\t\tconst u8 *e = fb_firmware_edid(info->device);\n\n\t\tif (e)\n\t\t\tedid = kmemdup(e, EDID_LENGTH, GFP_KERNEL);\n\t}\n\n\t*out_edid = edid;\n\n\treturn (edid) ? 0 : 1;\n}\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}