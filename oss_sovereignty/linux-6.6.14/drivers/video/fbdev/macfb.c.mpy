{
  "module_name": "macfb.c",
  "hash_id": "9713cfaf44c9b4f9ecf8dd4e34c2a025299202007eeb0f083eeef489e9941d9f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/macfb.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/string.h>\n#include <linux/mm.h>\n#include <linux/delay.h>\n#include <linux/nubus.h>\n#include <linux/init.h>\n#include <linux/fb.h>\n\n#include <asm/setup.h>\n#include <asm/macintosh.h>\n#include <asm/io.h>\n\n \n#define DAC_BASE 0x50f24000\n\n \n#define DAFB_BASE 0xf9800200\n\n \n#define CIVIC_BASE 0x50f30800\n\n \n#define GSC_BASE 0x50F20000\n\n \n#define CSC_BASE 0x50F20000\n\nstatic int (*macfb_setpalette)(unsigned int regno, unsigned int red,\n\t\t\t       unsigned int green, unsigned int blue,\n\t\t\t       struct fb_info *info);\n\nstatic struct {\n\tunsigned char addr;\n\tunsigned char lut;\n} __iomem *v8_brazil_cmap_regs;\n\nstatic struct {\n\tunsigned char addr;\n\tchar pad1[3];  \n\tunsigned char lut;\n\tchar pad2[3];  \n\tunsigned char cntl;  \n} __iomem *rbv_cmap_regs;\n\nstatic struct {\n\tunsigned long reset;\n\tunsigned long pad1[3];\n\tunsigned char pad2[3];\n\tunsigned char lut;\n} __iomem *dafb_cmap_regs;\n\nstatic struct {\n\tunsigned char addr;\t \n\tunsigned char pad1[15];\n\tunsigned char lut;\t \n\tunsigned char pad2[15];\n\tunsigned char status;\t \n\tunsigned char pad3[7];\n\tunsigned long vbl_addr;\t \n\tunsigned int  status2;\t \n} __iomem *civic_cmap_regs;\n\nstatic struct {\n\tchar pad1[0x40];\n\tunsigned char clut_waddr;\t \n\tchar pad2;\n\tunsigned char clut_data;\t \n\tchar pad3[0x3];\n\tunsigned char clut_raddr;\t \n} __iomem *csc_cmap_regs;\n\n \nstruct mdc_cmap_regs {\n\tchar pad1[0x200200];\n\tunsigned char addr;\n\tchar pad2[6];\n\tunsigned char lut;\n};\n\nstruct toby_cmap_regs {\n\tchar pad1[0x90018];\n\tunsigned char lut;  \n\tchar pad2[3];\n\tunsigned char addr;  \n};\n\nstruct jet_cmap_regs {\n\tchar pad1[0xe0e000];\n\tunsigned char addr;\n\tunsigned char lut;\n};\n\n#define PIXEL_TO_MM(a)\t(((a)*10)/28)\t \n\nstatic struct fb_var_screeninfo macfb_defined = {\n\t.activate\t= FB_ACTIVATE_NOW,\n\t.right_margin\t= 32,\n\t.upper_margin\t= 16,\n\t.lower_margin\t= 4,\n\t.vsync_len\t= 4,\n\t.vmode\t\t= FB_VMODE_NONINTERLACED,\n};\n\nstatic struct fb_fix_screeninfo macfb_fix = {\n\t.type\t= FB_TYPE_PACKED_PIXELS,\n\t.accel\t= FB_ACCEL_NONE,\n};\n\nstatic void *slot_addr;\nstatic struct fb_info fb_info;\nstatic u32 pseudo_palette[16];\nstatic int vidtest;\n\n \nstatic int dafb_setpalette(unsigned int regno, unsigned int red,\n\t\t\t   unsigned int green, unsigned int blue,\n\t\t\t   struct fb_info *info)\n{\n\tstatic int lastreg = -2;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\t \n\tif (regno != lastreg + 1) {\n\t\tint i;\n\n\t\t \n\t\tnubus_writel(0, &dafb_cmap_regs->reset);\n\t\tnop();\n\n\t\t \n\t\tfor (i = 0; i < regno; i++) {\n\t\t\tnubus_writeb(info->cmap.red[i] >> 8,\n\t\t\t\t     &dafb_cmap_regs->lut);\n\t\t\tnop();\n\t\t\tnubus_writeb(info->cmap.green[i] >> 8,\n\t\t\t\t     &dafb_cmap_regs->lut);\n\t\t\tnop();\n\t\t\tnubus_writeb(info->cmap.blue[i] >> 8,\n\t\t\t\t     &dafb_cmap_regs->lut);\n\t\t\tnop();\n\t\t}\n\t}\n\n\tnubus_writeb(red, &dafb_cmap_regs->lut);\n\tnop();\n\tnubus_writeb(green, &dafb_cmap_regs->lut);\n\tnop();\n\tnubus_writeb(blue, &dafb_cmap_regs->lut);\n\n\tlocal_irq_restore(flags);\n\tlastreg = regno;\n\treturn 0;\n}\n\n \nstatic int v8_brazil_setpalette(unsigned int regno, unsigned int red,\n\t\t\t\tunsigned int green, unsigned int blue,\n\t\t\t\tstruct fb_info *info)\n{\n\tunsigned int bpp = info->var.bits_per_pixel;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\t \n\tregno = (regno << (8 - bpp)) | (0xFF >> bpp);\n\tnubus_writeb(regno, &v8_brazil_cmap_regs->addr);\n\tnop();\n\n\t \n\tnubus_writeb(red, &v8_brazil_cmap_regs->lut);\n\tnop();\n\tnubus_writeb(green, &v8_brazil_cmap_regs->lut);\n\tnop();\n\tnubus_writeb(blue, &v8_brazil_cmap_regs->lut);\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\n \nstatic int rbv_setpalette(unsigned int regno, unsigned int red,\n\t\t\t  unsigned int green, unsigned int blue,\n\t\t\t  struct fb_info *info)\n{\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\t \n\tregno += 256 - (1 << info->var.bits_per_pixel);\n\n\t \n\tnubus_writeb(0xFF, &rbv_cmap_regs->cntl);\n\tnop();\n\n\t \n\tnubus_writeb(regno, &rbv_cmap_regs->addr);\n\tnop();\n\n\t \n\tnubus_writeb(red, &rbv_cmap_regs->lut);\n\tnop();\n\tnubus_writeb(green, &rbv_cmap_regs->lut);\n\tnop();\n\tnubus_writeb(blue, &rbv_cmap_regs->lut);\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\n \nstatic int mdc_setpalette(unsigned int regno, unsigned int red,\n\t\t\t  unsigned int green, unsigned int blue,\n\t\t\t  struct fb_info *info)\n{\n\tstruct mdc_cmap_regs *cmap_regs = slot_addr;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\t \n\tnubus_writeb(regno, &cmap_regs->addr);\n\tnop();\n\tnubus_writeb(red, &cmap_regs->lut);\n\tnop();\n\tnubus_writeb(green, &cmap_regs->lut);\n\tnop();\n\tnubus_writeb(blue, &cmap_regs->lut);\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\n \nstatic int toby_setpalette(unsigned int regno, unsigned int red,\n\t\t\t   unsigned int green, unsigned int blue,\n\t\t\t   struct fb_info *info)\n{\n\tstruct toby_cmap_regs *cmap_regs = slot_addr;\n\tunsigned int bpp = info->var.bits_per_pixel;\n\tunsigned long flags;\n\n\tred = ~red;\n\tgreen = ~green;\n\tblue = ~blue;\n\tregno = (regno << (8 - bpp)) | (0xFF >> bpp);\n\n\tlocal_irq_save(flags);\n\n\tnubus_writeb(regno, &cmap_regs->addr);\n\tnop();\n\tnubus_writeb(red, &cmap_regs->lut);\n\tnop();\n\tnubus_writeb(green, &cmap_regs->lut);\n\tnop();\n\tnubus_writeb(blue, &cmap_regs->lut);\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\n \nstatic int jet_setpalette(unsigned int regno, unsigned int red,\n\t\t\t  unsigned int green, unsigned int blue,\n\t\t\t  struct fb_info *info)\n{\n\tstruct jet_cmap_regs *cmap_regs = slot_addr;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\tnubus_writeb(regno, &cmap_regs->addr);\n\tnop();\n\tnubus_writeb(red, &cmap_regs->lut);\n\tnop();\n\tnubus_writeb(green, &cmap_regs->lut);\n\tnop();\n\tnubus_writeb(blue, &cmap_regs->lut);\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\n \nstatic int civic_setpalette(unsigned int regno, unsigned int red,\n\t\t\t    unsigned int green, unsigned int blue,\n\t\t\t    struct fb_info *info)\n{\n\tunsigned long flags;\n\tint clut_status;\n\n\tlocal_irq_save(flags);\n\n\t \n\tnubus_writeb(regno, &civic_cmap_regs->addr);\n\tnop();\n\n\t \n\tclut_status =  nubus_readb(&civic_cmap_regs->status2);\n\n\tif ((clut_status & 0x0008) == 0)\n\t{\n#if 0\n\t\tif ((clut_status & 0x000D) != 0)\n\t\t{\n\t\t\tnubus_writeb(0x00, &civic_cmap_regs->lut);\n\t\t\tnop();\n\t\t\tnubus_writeb(0x00, &civic_cmap_regs->lut);\n\t\t\tnop();\n\t\t}\n#endif\n\n\t\tnubus_writeb(red, &civic_cmap_regs->lut);\n\t\tnop();\n\t\tnubus_writeb(green, &civic_cmap_regs->lut);\n\t\tnop();\n\t\tnubus_writeb(blue, &civic_cmap_regs->lut);\n\t\tnop();\n\t\tnubus_writeb(0x00, &civic_cmap_regs->lut);\n\t}\n\telse\n\t{\n\t\tunsigned char junk;\n\n\t\tjunk = nubus_readb(&civic_cmap_regs->lut);\n\t\tnop();\n\t\tjunk = nubus_readb(&civic_cmap_regs->lut);\n\t\tnop();\n\t\tjunk = nubus_readb(&civic_cmap_regs->lut);\n\t\tnop();\n\t\tjunk = nubus_readb(&civic_cmap_regs->lut);\n\t\tnop();\n\n\t\tif ((clut_status & 0x000D) != 0)\n\t\t{\n\t\t\tnubus_writeb(0x00, &civic_cmap_regs->lut);\n\t\t\tnop();\n\t\t\tnubus_writeb(0x00, &civic_cmap_regs->lut);\n\t\t\tnop();\n\t\t}\n\n\t\tnubus_writeb(red, &civic_cmap_regs->lut);\n\t\tnop();\n\t\tnubus_writeb(green, &civic_cmap_regs->lut);\n\t\tnop();\n\t\tnubus_writeb(blue, &civic_cmap_regs->lut);\n\t\tnop();\n\t\tnubus_writeb(junk, &civic_cmap_regs->lut);\n\t}\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\n \nstatic int csc_setpalette(unsigned int regno, unsigned int red,\n\t\t\t  unsigned int green, unsigned int blue,\n\t\t\t  struct fb_info *info)\n{\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\n\tudelay(1);  \n\tnubus_writeb(regno, &csc_cmap_regs->clut_waddr);\n\tnubus_writeb(red, &csc_cmap_regs->clut_data);\n\tnubus_writeb(green, &csc_cmap_regs->clut_data);\n\tnubus_writeb(blue, &csc_cmap_regs->clut_data);\n\n\tlocal_irq_restore(flags);\n\treturn 0;\n}\n\nstatic int macfb_setcolreg(unsigned regno, unsigned red, unsigned green,\n\t\t\t   unsigned blue, unsigned transp,\n\t\t\t   struct fb_info *fb_info)\n{\n\t \n\n\tif (regno >= fb_info->cmap.len)\n\t\treturn 1;\n\n\tif (fb_info->var.bits_per_pixel <= 8) {\n\t\tswitch (fb_info->var.bits_per_pixel) {\n\t\tcase 1:\n\t\t\t \n\t\t\tbreak;\n\t\tcase 2:\n\t\tcase 4:\n\t\tcase 8:\n\t\t\tif (macfb_setpalette)\n\t\t\t\tmacfb_setpalette(regno, red >> 8, green >> 8,\n\t\t\t\t\t\t blue >> 8, fb_info);\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t\tbreak;\n\t\t}\n\t} else if (regno < 16) {\n\t\tswitch (fb_info->var.bits_per_pixel) {\n\t\tcase 16:\n\t\t\tif (fb_info->var.red.offset == 10) {\n\t\t\t\t \n\t\t\t\t((u32*) (fb_info->pseudo_palette))[regno] =\n\t\t\t\t\t((red   & 0xf800) >>  1) |\n\t\t\t\t\t((green & 0xf800) >>  6) |\n\t\t\t\t\t((blue  & 0xf800) >> 11) |\n\t\t\t\t\t((transp != 0) << 15);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\t((u32*) (fb_info->pseudo_palette))[regno] =\n\t\t\t\t\t((red   & 0xf800) >>  0) |\n\t\t\t\t\t((green & 0xfc00) >>  5) |\n\t\t\t\t\t((blue  & 0xf800) >> 11);\n\t\t\t}\n\t\t\tbreak;\n\t\t \n\t\tcase 24:\n\t\tcase 32:\n\t\t\tred   >>= 8;\n\t\t\tgreen >>= 8;\n\t\t\tblue  >>= 8;\n\t\t\t((u32 *)(fb_info->pseudo_palette))[regno] =\n\t\t\t\t(red   << fb_info->var.red.offset) |\n\t\t\t\t(green << fb_info->var.green.offset) |\n\t\t\t\t(blue  << fb_info->var.blue.offset);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct fb_ops macfb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_setcolreg\t= macfb_setcolreg,\n};\n\nstatic void __init macfb_setup(char *options)\n{\n\tchar *this_opt;\n\n\tif (!options || !*options)\n\t\treturn;\n\n\twhile ((this_opt = strsep(&options, \",\")) != NULL) {\n\t\tif (!*this_opt)\n\t\t\tcontinue;\n\n\t\tif (!strcmp(this_opt, \"inverse\"))\n\t\t\tfb_invert_cmaps();\n\t\telse\n\t\t\tif (!strcmp(this_opt, \"vidtest\"))\n\t\t\t\tvidtest = 1;  \n\t}\n}\n\nstatic void __init iounmap_macfb(void)\n{\n\tif (dafb_cmap_regs)\n\t\tiounmap(dafb_cmap_regs);\n\tif (v8_brazil_cmap_regs)\n\t\tiounmap(v8_brazil_cmap_regs);\n\tif (rbv_cmap_regs)\n\t\tiounmap(rbv_cmap_regs);\n\tif (civic_cmap_regs)\n\t\tiounmap(civic_cmap_regs);\n\tif (csc_cmap_regs)\n\t\tiounmap(csc_cmap_regs);\n}\n\nstatic int __init macfb_init(void)\n{\n\tint video_cmap_len, video_is_nubus = 0;\n\tstruct nubus_rsrc *ndev = NULL;\n\tchar *option = NULL;\n\tint err;\n\n\tif (fb_get_options(\"macfb\", &option))\n\t\treturn -ENODEV;\n\tmacfb_setup(option);\n\n\tif (!MACH_IS_MAC)\n\t\treturn -ENODEV;\n\n\tif (mac_bi_data.id == MAC_MODEL_Q630 ||\n\t    mac_bi_data.id == MAC_MODEL_P588)\n\t\treturn -ENODEV;  \n\n\tmacfb_defined.xres = mac_bi_data.dimensions & 0xFFFF;\n\tmacfb_defined.yres = mac_bi_data.dimensions >> 16;\n\tmacfb_defined.bits_per_pixel = mac_bi_data.videodepth;\n\n\tmacfb_fix.line_length = mac_bi_data.videorow;\n\tmacfb_fix.smem_len    = macfb_fix.line_length * macfb_defined.yres;\n\t \n\tmacfb_fix.smem_start  = mac_bi_data.videoaddr;\n\n\t \n\tfb_info.screen_base = ioremap(mac_bi_data.videoaddr,\n\t\t\t\t      macfb_fix.smem_len);\n\tif (!fb_info.screen_base)\n\t\treturn -ENODEV;\n\n\tpr_info(\"macfb: framebuffer at 0x%08lx, mapped to 0x%p, size %dk\\n\",\n\t        macfb_fix.smem_start, fb_info.screen_base,\n\t        macfb_fix.smem_len / 1024);\n\tpr_info(\"macfb: mode is %dx%dx%d, linelength=%d\\n\",\n\t        macfb_defined.xres, macfb_defined.yres,\n\t        macfb_defined.bits_per_pixel, macfb_fix.line_length);\n\n\t \n\tmacfb_defined.xres_virtual = macfb_defined.xres;\n\tmacfb_defined.yres_virtual = macfb_defined.yres;\n\tmacfb_defined.height       = PIXEL_TO_MM(macfb_defined.yres);\n\tmacfb_defined.width        = PIXEL_TO_MM(macfb_defined.xres);\n\n\t \n\tmacfb_defined.pixclock     = 10000000 / macfb_defined.xres *\n\t\t\t\t     1000 / macfb_defined.yres;\n\tmacfb_defined.left_margin  = (macfb_defined.xres / 8) & 0xf8;\n\tmacfb_defined.hsync_len    = (macfb_defined.xres / 8) & 0xf8;\n\n\tswitch (macfb_defined.bits_per_pixel) {\n\tcase 1:\n\t\tmacfb_defined.red.length = macfb_defined.bits_per_pixel;\n\t\tmacfb_defined.green.length = macfb_defined.bits_per_pixel;\n\t\tmacfb_defined.blue.length = macfb_defined.bits_per_pixel;\n\t\tvideo_cmap_len = 2;\n\t\tmacfb_fix.visual = FB_VISUAL_MONO01;\n\t\tbreak;\n\tcase 2:\n\tcase 4:\n\tcase 8:\n\t\tmacfb_defined.red.length = macfb_defined.bits_per_pixel;\n\t\tmacfb_defined.green.length = macfb_defined.bits_per_pixel;\n\t\tmacfb_defined.blue.length = macfb_defined.bits_per_pixel;\n\t\tvideo_cmap_len = 1 << macfb_defined.bits_per_pixel;\n\t\tmacfb_fix.visual = FB_VISUAL_PSEUDOCOLOR;\n\t\tbreak;\n\tcase 16:\n\t\tmacfb_defined.transp.offset = 15;\n\t\tmacfb_defined.transp.length = 1;\n\t\tmacfb_defined.red.offset = 10;\n\t\tmacfb_defined.red.length = 5;\n\t\tmacfb_defined.green.offset = 5;\n\t\tmacfb_defined.green.length = 5;\n\t\tmacfb_defined.blue.offset = 0;\n\t\tmacfb_defined.blue.length = 5;\n\t\tvideo_cmap_len = 16;\n\t\t \n\t\tmacfb_fix.visual = FB_VISUAL_TRUECOLOR;\n\t\tbreak;\n\tcase 24:\n\tcase 32:\n\t\tmacfb_defined.red.offset = 16;\n\t\tmacfb_defined.red.length = 8;\n\t\tmacfb_defined.green.offset = 8;\n\t\tmacfb_defined.green.length = 8;\n\t\tmacfb_defined.blue.offset = 0;\n\t\tmacfb_defined.blue.length = 8;\n\t\tvideo_cmap_len = 16;\n\t\tmacfb_fix.visual = FB_VISUAL_TRUECOLOR;\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"macfb: unknown or unsupported bit depth: %d\\n\",\n\t\t       macfb_defined.bits_per_pixel);\n\t\terr = -EINVAL;\n\t\tgoto fail_unmap;\n\t}\n\n\t \n\n\tfor_each_func_rsrc(ndev) {\n\t\tunsigned long base = ndev->board->slot_addr;\n\n\t\tif (mac_bi_data.videoaddr < base ||\n\t\t    mac_bi_data.videoaddr - base > 0xFFFFFF)\n\t\t\tcontinue;\n\n\t\tif (ndev->category != NUBUS_CAT_DISPLAY ||\n\t\t    ndev->type != NUBUS_TYPE_VIDEO)\n\t\t\tcontinue;\n\n\t\tvideo_is_nubus = 1;\n\t\tslot_addr = (unsigned char *)base;\n\n\t\tswitch(ndev->dr_hw) {\n\t\tcase NUBUS_DRHW_APPLE_MDC:\n\t\t\tstrcpy(macfb_fix.id, \"Mac Disp. Card\");\n\t\t\tmacfb_setpalette = mdc_setpalette;\n\t\t\tbreak;\n\t\tcase NUBUS_DRHW_APPLE_TFB:\n\t\t\tstrcpy(macfb_fix.id, \"Toby\");\n\t\t\tmacfb_setpalette = toby_setpalette;\n\t\t\tbreak;\n\t\tcase NUBUS_DRHW_APPLE_JET:\n\t\t\tstrcpy(macfb_fix.id, \"Jet\");\n\t\t\tmacfb_setpalette = jet_setpalette;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tstrcpy(macfb_fix.id, \"Generic NuBus\");\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tif (!video_is_nubus)\n\t\tswitch (mac_bi_data.id) {\n\t\t \n\t\tcase MAC_MODEL_P475:\n\t\tcase MAC_MODEL_P475F:\n\t\tcase MAC_MODEL_P575:\n\t\tcase MAC_MODEL_Q605:\n\n\t\tcase MAC_MODEL_Q800:\n\t\tcase MAC_MODEL_Q650:\n\t\tcase MAC_MODEL_Q610:\n\t\tcase MAC_MODEL_C650:\n\t\tcase MAC_MODEL_C610:\n\t\tcase MAC_MODEL_Q700:\n\t\tcase MAC_MODEL_Q900:\n\t\tcase MAC_MODEL_Q950:\n\t\t\tstrcpy(macfb_fix.id, \"DAFB\");\n\t\t\tmacfb_setpalette = dafb_setpalette;\n\t\t\tdafb_cmap_regs = ioremap(DAFB_BASE, 0x1000);\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_LCII:\n\t\t\tstrcpy(macfb_fix.id, \"V8\");\n\t\t\tmacfb_setpalette = v8_brazil_setpalette;\n\t\t\tv8_brazil_cmap_regs = ioremap(DAC_BASE, 0x1000);\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_IIVI:\n\t\tcase MAC_MODEL_IIVX:\n\t\tcase MAC_MODEL_P600:\n\t\t\tstrcpy(macfb_fix.id, \"Brazil\");\n\t\t\tmacfb_setpalette = v8_brazil_setpalette;\n\t\t\tv8_brazil_cmap_regs = ioremap(DAC_BASE, 0x1000);\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_LCIII:\n\t\tcase MAC_MODEL_P520:\n\t\tcase MAC_MODEL_P550:\n\t\tcase MAC_MODEL_P460:\n\t\t\tstrcpy(macfb_fix.id, \"Sonora\");\n\t\t\tmacfb_setpalette = v8_brazil_setpalette;\n\t\t\tv8_brazil_cmap_regs = ioremap(DAC_BASE, 0x1000);\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_IICI:\n\t\tcase MAC_MODEL_IISI:\n\t\t\tstrcpy(macfb_fix.id, \"RBV\");\n\t\t\tmacfb_setpalette = rbv_setpalette;\n\t\t\trbv_cmap_regs = ioremap(DAC_BASE, 0x1000);\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_Q840:\n\t\tcase MAC_MODEL_C660:\n\t\t\tstrcpy(macfb_fix.id, \"Civic\");\n\t\t\tmacfb_setpalette = civic_setpalette;\n\t\t\tcivic_cmap_regs = ioremap(CIVIC_BASE, 0x1000);\n\t\t\tbreak;\n\n\n\t\t \n\t\tcase MAC_MODEL_LC:\n\t\t\tstrcpy(macfb_fix.id, \"LC\");\n\t\t\tif (vidtest) {\n\t\t\t\tmacfb_setpalette = v8_brazil_setpalette;\n\t\t\t\tv8_brazil_cmap_regs =\n\t\t\t\t\tioremap(DAC_BASE, 0x1000);\n\t\t\t}\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_CCL:\n\t\t\tstrcpy(macfb_fix.id, \"Color Classic\");\n\t\t\tif (vidtest) {\n\t\t\t\tmacfb_setpalette = v8_brazil_setpalette;\n\t\t\t\tv8_brazil_cmap_regs =\n\t\t\t\t\tioremap(DAC_BASE, 0x1000);\n\t\t\t}\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_TV:\n\t\t\tstrcpy(macfb_fix.id, \"Mac TV\");\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_SE30:\n\t\tcase MAC_MODEL_CLII:\n\t\t\tstrcpy(macfb_fix.id, \"Monochrome\");\n\t\t\tbreak;\n\n\t\t \n\n\t\t \n\t\tcase MAC_MODEL_PB140:\n\t\tcase MAC_MODEL_PB145:\n\t\tcase MAC_MODEL_PB170:\n\t\t\tstrcpy(macfb_fix.id, \"DDC\");\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_PB150:\t \n\t\tcase MAC_MODEL_PB160:\n\t\tcase MAC_MODEL_PB165:\n\t\tcase MAC_MODEL_PB180:\n\t\tcase MAC_MODEL_PB210:\n\t\tcase MAC_MODEL_PB230:\n\t\t\tstrcpy(macfb_fix.id, \"GSC\");\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_PB165C:\n\t\tcase MAC_MODEL_PB180C:\n\t\t\tstrcpy(macfb_fix.id, \"TIM\");\n\t\t\tbreak;\n\n\t\t \n\t\tcase MAC_MODEL_PB190:\t \n\t\tcase MAC_MODEL_PB520:\n\t\tcase MAC_MODEL_PB250:\n\t\tcase MAC_MODEL_PB270C:\n\t\tcase MAC_MODEL_PB280:\n\t\tcase MAC_MODEL_PB280C:\n\t\t\tstrcpy(macfb_fix.id, \"CSC\");\n\t\t\tmacfb_setpalette = csc_setpalette;\n\t\t\tcsc_cmap_regs = ioremap(CSC_BASE, 0x1000);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tstrcpy(macfb_fix.id, \"Unknown\");\n\t\t\tbreak;\n\t\t}\n\n\tfb_info.fbops\t\t= &macfb_ops;\n\tfb_info.var\t\t= macfb_defined;\n\tfb_info.fix\t\t= macfb_fix;\n\tfb_info.pseudo_palette\t= pseudo_palette;\n\n\terr = fb_alloc_cmap(&fb_info.cmap, video_cmap_len, 0);\n\tif (err)\n\t\tgoto fail_unmap;\n\n\terr = register_framebuffer(&fb_info);\n\tif (err)\n\t\tgoto fail_dealloc;\n\n\tfb_info(&fb_info, \"%s frame buffer device\\n\", fb_info.fix.id);\n\n\treturn 0;\n\nfail_dealloc:\n\tfb_dealloc_cmap(&fb_info.cmap);\nfail_unmap:\n\tiounmap(fb_info.screen_base);\n\tiounmap_macfb();\n\treturn err;\n}\n\nmodule_init(macfb_init);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}