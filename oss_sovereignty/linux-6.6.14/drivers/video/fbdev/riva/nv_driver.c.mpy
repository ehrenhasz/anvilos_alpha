{
  "module_name": "nv_driver.c",
  "hash_id": "ba550bf79c715586e2ad11dd130567e9028644c12001fe15ff1d5d86af43e3d3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/riva/nv_driver.c",
  "human_readable_source": " \n \n\n \n\n \n\n \n\n#include <linux/delay.h>\n#include <linux/pci.h>\n#include <linux/pci_ids.h>\n#include \"nv_type.h\"\n#include \"rivafb.h\"\n#include \"nvreg.h\"\n\n#define PFX \"rivafb: \"\n\nstatic inline unsigned char MISCin(struct riva_par *par)\n{\n\treturn (VGA_RD08(par->riva.PVIO, 0x3cc));\n}\n\nstatic Bool \nriva_is_connected(struct riva_par *par, Bool second)\n{\n\tvolatile U032 __iomem *PRAMDAC = par->riva.PRAMDAC0;\n\tU032 reg52C, reg608;\n\tBool present;\n\n\tif(second) PRAMDAC += 0x800;\n\n\treg52C = NV_RD32(PRAMDAC, 0x052C);\n\treg608 = NV_RD32(PRAMDAC, 0x0608);\n\n\tNV_WR32(PRAMDAC, 0x0608, reg608 & ~0x00010000);\n\n\tNV_WR32(PRAMDAC, 0x052C, reg52C & 0x0000FEEE);\n\tmdelay(1); \n\tNV_WR32(PRAMDAC, 0x052C, NV_RD32(PRAMDAC, 0x052C) | 1);\n\n\tNV_WR32(par->riva.PRAMDAC0, 0x0610, 0x94050140);\n\tNV_WR32(par->riva.PRAMDAC0, 0x0608, 0x00001000);\n\n\tmdelay(1);\n\n\tpresent = (NV_RD32(PRAMDAC, 0x0608) & (1 << 28)) ? TRUE : FALSE;\n\n\tNV_WR32(par->riva.PRAMDAC0, 0x0608,\n\t\tNV_RD32(par->riva.PRAMDAC0, 0x0608) & 0x0000EFFF);\n\n\tNV_WR32(PRAMDAC, 0x052C, reg52C);\n\tNV_WR32(PRAMDAC, 0x0608, reg608);\n\n\treturn present;\n}\n\nstatic void\nriva_override_CRTC(struct riva_par *par)\n{\n\tprintk(KERN_INFO PFX\n\t\t\"Detected CRTC controller %i being used\\n\",\n\t\tpar->SecondCRTC ? 1 : 0);\n\n\tif(par->forceCRTC != -1) {\n\t\tprintk(KERN_INFO PFX\n\t\t\t\"Forcing usage of CRTC %i\\n\", par->forceCRTC);\n\t\tpar->SecondCRTC = par->forceCRTC;\n\t}\n}\n\nstatic void\nriva_is_second(struct riva_par *par)\n{\n\tif (par->FlatPanel == 1) {\n\t\tswitch(par->Chipset & 0xffff) {\n\t\tcase 0x0174:\n\t\tcase 0x0175:\n\t\tcase 0x0176:\n\t\tcase 0x0177:\n\t\tcase 0x0179:\n\t\tcase 0x017C:\n\t\tcase 0x017D:\n\t\tcase 0x0186:\n\t\tcase 0x0187:\n\t\t \n\t\tcase 0x0286:\n\t\tcase 0x028C:\n\t\tcase 0x0316:\n\t\tcase 0x0317:\n\t\tcase 0x031A:\n\t\tcase 0x031B:\n\t\tcase 0x031C:\n\t\tcase 0x031D:\n\t\tcase 0x031E:\n\t\tcase 0x031F:\n\t\tcase 0x0324:\n\t\tcase 0x0325:\n\t\tcase 0x0328:\n\t\tcase 0x0329:\n\t\tcase 0x032C:\n\t\tcase 0x032D:\n\t\t\tpar->SecondCRTC = TRUE;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpar->SecondCRTC = FALSE;\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tif(riva_is_connected(par, 0)) {\n\n\t\t\tif (NV_RD32(par->riva.PRAMDAC0, 0x0000052C) & 0x100)\n\t\t\t\tpar->SecondCRTC = TRUE;\n\t\t\telse\n\t\t\t\tpar->SecondCRTC = FALSE;\n\t\t} else \n\t\tif (riva_is_connected(par, 1)) {\n\t\t\tif(NV_RD32(par->riva.PRAMDAC0, 0x0000252C) & 0x100)\n\t\t\t\tpar->SecondCRTC = TRUE;\n\t\t\telse\n\t\t\t\tpar->SecondCRTC = FALSE;\n\t\t} else  \n\t\t\tpar->SecondCRTC = FALSE;\n\t}\n\triva_override_CRTC(par);\n}\n\nunsigned long riva_get_memlen(struct riva_par *par)\n{\n\tRIVA_HW_INST *chip = &par->riva;\n\tunsigned long memlen = 0;\n\tunsigned int chipset = par->Chipset;\n\tstruct pci_dev* dev;\n\tu32 amt;\n\tint domain = pci_domain_nr(par->pdev->bus);\n\n\tswitch (chip->Architecture) {\n\tcase NV_ARCH_03:\n\t\tif (NV_RD32(chip->PFB, 0x00000000) & 0x00000020) {\n\t\t\tif (((NV_RD32(chip->PMC, 0x00000000) & 0xF0) == 0x20)\n\t\t\t    && ((NV_RD32(chip->PMC, 0x00000000)&0x0F)>=0x02)) {\n\t\t\t\t \n\t\t\t\tswitch (NV_RD32(chip->PFB,0x00000000) & 0x03) {\n\t\t\t\tcase 2:\n\t\t\t\t\tmemlen = 1024 * 4;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 1:\n\t\t\t\t\tmemlen = 1024 * 2;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tmemlen = 1024 * 8;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tmemlen = 1024 * 8;\n\t\t\t}            \n\t\t} else \t{\n\t\t\t \n\t\t\tswitch (NV_RD32(chip->PFB, 0x00000000) & 0x00000003) {\n\t\t\tcase 0:\n\t\t\t\tmemlen = 1024 * 8;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tmemlen = 1024 * 4;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tmemlen = 1024 * 2;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}        \n\t\tbreak;\n\tcase NV_ARCH_04:\n\t\tif (NV_RD32(chip->PFB, 0x00000000) & 0x00000100) {\n\t\t\tmemlen = ((NV_RD32(chip->PFB, 0x00000000)>>12)&0x0F) *\n\t\t\t\t1024 * 2 + 1024 * 2;\n\t\t} else {\n\t\t\tswitch (NV_RD32(chip->PFB, 0x00000000) & 0x00000003) {\n\t\t\tcase 0:\n\t\t\t\tmemlen = 1024 * 32;\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tmemlen = 1024 * 4;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tmemlen = 1024 * 8;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\tdefault:\n\t\t\t\tmemlen = 1024 * 16;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase NV_ARCH_10:\n\tcase NV_ARCH_20:\n\tcase NV_ARCH_30:\n\t\tif(chipset == NV_CHIP_IGEFORCE2) {\n\n\t\t\tdev = pci_get_domain_bus_and_slot(domain, 0, 1);\n\t\t\tpci_read_config_dword(dev, 0x7C, &amt);\n\t\t\tpci_dev_put(dev);\n\t\t\tmemlen = (((amt >> 6) & 31) + 1) * 1024;\n\t\t} else if (chipset == NV_CHIP_0x01F0) {\n\t\t\tdev = pci_get_domain_bus_and_slot(domain, 0, 1);\n\t\t\tpci_read_config_dword(dev, 0x84, &amt);\n\t\t\tpci_dev_put(dev);\n\t\t\tmemlen = (((amt >> 4) & 127) + 1) * 1024;\n\t\t} else {\n\t\t\tswitch ((NV_RD32(chip->PFB, 0x0000020C) >> 20) &\n\t\t\t\t0x000000FF){\n\t\t\tcase 0x02:\n\t\t\t\tmemlen = 1024 * 2;\n\t\t\t\tbreak;\n\t\t\tcase 0x04:\n\t\t\t\tmemlen = 1024 * 4;\n\t\t\t\tbreak;\n\t\t\tcase 0x08:\n\t\t\t\tmemlen = 1024 * 8;\n\t\t\t\tbreak;\n\t\t\tcase 0x10:\n\t\t\t\tmemlen = 1024 * 16;\n\t\t\t\tbreak;\n\t\t\tcase 0x20:\n\t\t\t\tmemlen = 1024 * 32;\n\t\t\t\tbreak;\n\t\t\tcase 0x40:\n\t\t\t\tmemlen = 1024 * 64;\n\t\t\t\tbreak;\n\t\t\tcase 0x80:\n\t\t\t\tmemlen = 1024 * 128;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tmemlen = 1024 * 16;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\treturn memlen;\n}\n\nunsigned long riva_get_maxdclk(struct riva_par *par)\n{\n\tRIVA_HW_INST *chip = &par->riva;\n\tunsigned long dclk = 0;\n\n\tswitch (chip->Architecture) {\n\tcase NV_ARCH_03:\n\t\tif (NV_RD32(chip->PFB, 0x00000000) & 0x00000020) {\n\t\t\tif (((NV_RD32(chip->PMC, 0x00000000) & 0xF0) == 0x20)\n\t\t\t    && ((NV_RD32(chip->PMC,0x00000000)&0x0F) >= 0x02)) {\n\t\t\t\t \n\t\t\t\tdclk = 800000;\n\t\t\t} else {\n\t\t\t\tdclk = 1000000;\n\t\t\t}            \n\t\t} else {\n\t\t\t \n\t\t\tdclk = 1000000;\n\t\t} \n\t\tbreak;\n\tcase NV_ARCH_04:\n\tcase NV_ARCH_10:\n\tcase NV_ARCH_20:\n\tcase NV_ARCH_30:\n\t\tswitch ((NV_RD32(chip->PFB, 0x00000000) >> 3) & 0x00000003) {\n\t\tcase 3:\n\t\t\tdclk = 800000;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdclk = 1000000;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\treturn dclk;\n}\n\nvoid\nriva_common_setup(struct riva_par *par)\n{\n\tpar->riva.EnableIRQ = 0;\n\tpar->riva.PRAMDAC0 =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00680000);\n\tpar->riva.PFB =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00100000);\n\tpar->riva.PFIFO =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00002000);\n\tpar->riva.PGRAPH =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00400000);\n\tpar->riva.PEXTDEV =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00101000);\n\tpar->riva.PTIMER =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00009000);\n\tpar->riva.PMC =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00000000);\n\tpar->riva.FIFO =\n\t\t(volatile U032 __iomem *)(par->ctrl_base + 0x00800000);\n\tpar->riva.PCIO0 = par->ctrl_base + 0x00601000;\n\tpar->riva.PDIO0 = par->ctrl_base + 0x00681000;\n\tpar->riva.PVIO = par->ctrl_base + 0x000C0000;\n\n\tpar->riva.IO = (MISCin(par) & 0x01) ? 0x3D0 : 0x3B0;\n\t\n\tif (par->FlatPanel == -1) {\n\t\tswitch (par->Chipset & 0xffff) {\n\t\tcase 0x0112:    \n\t\tcase 0x0174:\n\t\tcase 0x0175:\n\t\tcase 0x0176:\n\t\tcase 0x0177:\n\t\tcase 0x0179:\n\t\tcase 0x017C:\n\t\tcase 0x017D:\n\t\tcase 0x0186:\n\t\tcase 0x0187:\n\t\tcase 0x0286:\n\t\tcase 0x028C:\n\t\tcase 0x0316:\n\t\tcase 0x0317:\n\t\tcase 0x031A:\n\t\tcase 0x031B:\n\t\tcase 0x031C:\n\t\tcase 0x031D:\n\t\tcase 0x031E:\n\t\tcase 0x031F:\n\t\tcase 0x0324:\n\t\tcase 0x0325:\n\t\tcase 0x0328:\n\t\tcase 0x0329:\n\t\tcase 0x032C:\n\t\tcase 0x032D:\n\t\t\tprintk(KERN_INFO PFX \n\t\t\t\t\"On a laptop.  Assuming Digital Flat Panel\\n\");\n\t\t\tpar->FlatPanel = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tswitch (par->Chipset & 0x0ff0) {\n\tcase 0x0110:\n\t\tif (par->Chipset == NV_CHIP_GEFORCE2_GO)\n\t\t\tpar->SecondCRTC = TRUE; \n#if defined(__powerpc__)\n\t\tif (par->FlatPanel == 1)\n\t\t\tpar->SecondCRTC = TRUE;\n#endif\n\t\triva_override_CRTC(par);\n\t\tbreak;\n\tcase 0x0170:\n\tcase 0x0180:\n\tcase 0x01F0:\n\tcase 0x0250:\n\tcase 0x0280:\n\tcase 0x0300:\n\tcase 0x0310:\n\tcase 0x0320:\n\tcase 0x0330:\n\tcase 0x0340:\n\t\triva_is_second(par);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (par->SecondCRTC) {\n\t\tpar->riva.PCIO = par->riva.PCIO0 + 0x2000;\n\t\tpar->riva.PCRTC = par->riva.PCRTC0 + 0x800;\n\t\tpar->riva.PRAMDAC = par->riva.PRAMDAC0 + 0x800;\n\t\tpar->riva.PDIO = par->riva.PDIO0 + 0x2000;\n\t} else {\n\t\tpar->riva.PCIO = par->riva.PCIO0;\n\t\tpar->riva.PCRTC = par->riva.PCRTC0;\n\t\tpar->riva.PRAMDAC = par->riva.PRAMDAC0;\n\t\tpar->riva.PDIO = par->riva.PDIO0;\n\t}\n\n\tif (par->FlatPanel == -1) {\n\t\t \n\t\tpar->FlatPanel = 0;\n\t}\n\tpar->riva.flatPanel = (par->FlatPanel > 0) ? TRUE : FALSE;\n\n\tRivaGetConfig(&par->riva, par->pdev, par->Chipset);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}