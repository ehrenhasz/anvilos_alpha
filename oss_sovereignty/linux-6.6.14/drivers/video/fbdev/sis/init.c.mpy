{
  "module_name": "init.c",
  "hash_id": "0848958b81e4122741a5b1f0716c1c5d11d9f575e33eecf45f3b06d211557161",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/sis/init.c",
  "human_readable_source": " \n \n \n\n#include \"init.h\"\n\n#ifdef CONFIG_FB_SIS_300\n#include \"300vtbl.h\"\n#endif\n\n#ifdef CONFIG_FB_SIS_315\n#include \"310vtbl.h\"\n#endif\n\n#if defined(ALLOC_PRAGMA)\n#pragma alloc_text(PAGE,SiSSetMode)\n#endif\n\n \n \n \n\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\nstatic void\nInitCommonPointer(struct SiS_Private *SiS_Pr)\n{\n   SiS_Pr->SiS_SModeIDTable  = SiS_SModeIDTable;\n   SiS_Pr->SiS_StResInfo     = SiS_StResInfo;\n   SiS_Pr->SiS_ModeResInfo   = SiS_ModeResInfo;\n   SiS_Pr->SiS_StandTable    = SiS_StandTable;\n\n   SiS_Pr->SiS_NTSCTiming     = SiS_NTSCTiming;\n   SiS_Pr->SiS_PALTiming      = SiS_PALTiming;\n   SiS_Pr->SiS_HiTVSt1Timing  = SiS_HiTVSt1Timing;\n   SiS_Pr->SiS_HiTVSt2Timing  = SiS_HiTVSt2Timing;\n\n   SiS_Pr->SiS_HiTVExtTiming  = SiS_HiTVExtTiming;\n   SiS_Pr->SiS_HiTVGroup3Data = SiS_HiTVGroup3Data;\n   SiS_Pr->SiS_HiTVGroup3Simu = SiS_HiTVGroup3Simu;\n#if 0\n   SiS_Pr->SiS_HiTVTextTiming = SiS_HiTVTextTiming;\n   SiS_Pr->SiS_HiTVGroup3Text = SiS_HiTVGroup3Text;\n#endif\n\n   SiS_Pr->SiS_StPALData   = SiS_StPALData;\n   SiS_Pr->SiS_ExtPALData  = SiS_ExtPALData;\n   SiS_Pr->SiS_StNTSCData  = SiS_StNTSCData;\n   SiS_Pr->SiS_ExtNTSCData = SiS_ExtNTSCData;\n   SiS_Pr->SiS_St1HiTVData = SiS_StHiTVData;\n   SiS_Pr->SiS_St2HiTVData = SiS_St2HiTVData;\n   SiS_Pr->SiS_ExtHiTVData = SiS_ExtHiTVData;\n   SiS_Pr->SiS_St525iData  = SiS_StNTSCData;\n   SiS_Pr->SiS_St525pData  = SiS_St525pData;\n   SiS_Pr->SiS_St750pData  = SiS_St750pData;\n   SiS_Pr->SiS_Ext525iData = SiS_ExtNTSCData;\n   SiS_Pr->SiS_Ext525pData = SiS_ExtNTSCData;\n   SiS_Pr->SiS_Ext750pData = SiS_Ext750pData;\n\n   SiS_Pr->pSiS_OutputSelect = &SiS_OutputSelect;\n   SiS_Pr->pSiS_SoftSetting  = &SiS_SoftSetting;\n\n   SiS_Pr->SiS_LCD1280x720Data      = SiS_LCD1280x720Data;\n   SiS_Pr->SiS_StLCD1280x768_2Data  = SiS_StLCD1280x768_2Data;\n   SiS_Pr->SiS_ExtLCD1280x768_2Data = SiS_ExtLCD1280x768_2Data;\n   SiS_Pr->SiS_LCD1280x800Data      = SiS_LCD1280x800Data;\n   SiS_Pr->SiS_LCD1280x800_2Data    = SiS_LCD1280x800_2Data;\n   SiS_Pr->SiS_LCD1280x854Data      = SiS_LCD1280x854Data;\n   SiS_Pr->SiS_LCD1280x960Data      = SiS_LCD1280x960Data;\n   SiS_Pr->SiS_StLCD1400x1050Data   = SiS_StLCD1400x1050Data;\n   SiS_Pr->SiS_ExtLCD1400x1050Data  = SiS_ExtLCD1400x1050Data;\n   SiS_Pr->SiS_LCD1680x1050Data     = SiS_LCD1680x1050Data;\n   SiS_Pr->SiS_StLCD1600x1200Data   = SiS_StLCD1600x1200Data;\n   SiS_Pr->SiS_ExtLCD1600x1200Data  = SiS_ExtLCD1600x1200Data;\n   SiS_Pr->SiS_NoScaleData          = SiS_NoScaleData;\n\n   SiS_Pr->SiS_LVDS320x240Data_1   = SiS_LVDS320x240Data_1;\n   SiS_Pr->SiS_LVDS320x240Data_2   = SiS_LVDS320x240Data_2;\n   SiS_Pr->SiS_LVDS640x480Data_1   = SiS_LVDS640x480Data_1;\n   SiS_Pr->SiS_LVDS800x600Data_1   = SiS_LVDS800x600Data_1;\n   SiS_Pr->SiS_LVDS1024x600Data_1  = SiS_LVDS1024x600Data_1;\n   SiS_Pr->SiS_LVDS1024x768Data_1  = SiS_LVDS1024x768Data_1;\n\n   SiS_Pr->SiS_LVDSCRT1320x240_1     = SiS_LVDSCRT1320x240_1;\n   SiS_Pr->SiS_LVDSCRT1320x240_2     = SiS_LVDSCRT1320x240_2;\n   SiS_Pr->SiS_LVDSCRT1320x240_2_H   = SiS_LVDSCRT1320x240_2_H;\n   SiS_Pr->SiS_LVDSCRT1320x240_3     = SiS_LVDSCRT1320x240_3;\n   SiS_Pr->SiS_LVDSCRT1320x240_3_H   = SiS_LVDSCRT1320x240_3_H;\n   SiS_Pr->SiS_LVDSCRT1640x480_1     = SiS_LVDSCRT1640x480_1;\n   SiS_Pr->SiS_LVDSCRT1640x480_1_H   = SiS_LVDSCRT1640x480_1_H;\n#if 0\n   SiS_Pr->SiS_LVDSCRT11024x600_1    = SiS_LVDSCRT11024x600_1;\n   SiS_Pr->SiS_LVDSCRT11024x600_1_H  = SiS_LVDSCRT11024x600_1_H;\n   SiS_Pr->SiS_LVDSCRT11024x600_2    = SiS_LVDSCRT11024x600_2;\n   SiS_Pr->SiS_LVDSCRT11024x600_2_H  = SiS_LVDSCRT11024x600_2_H;\n#endif\n\n   SiS_Pr->SiS_CHTVUNTSCData = SiS_CHTVUNTSCData;\n   SiS_Pr->SiS_CHTVONTSCData = SiS_CHTVONTSCData;\n\n   SiS_Pr->SiS_PanelMinLVDS   = Panel_800x600;     \n   SiS_Pr->SiS_PanelMin301    = Panel_1024x768;    \n}\n#endif\n\n#ifdef CONFIG_FB_SIS_300\nstatic void\nInitTo300Pointer(struct SiS_Private *SiS_Pr)\n{\n   InitCommonPointer(SiS_Pr);\n\n   SiS_Pr->SiS_VBModeIDTable = SiS300_VBModeIDTable;\n   SiS_Pr->SiS_EModeIDTable  = SiS300_EModeIDTable;\n   SiS_Pr->SiS_RefIndex      = SiS300_RefIndex;\n   SiS_Pr->SiS_CRT1Table     = SiS300_CRT1Table;\n   if(SiS_Pr->ChipType == SIS_300) {\n      SiS_Pr->SiS_MCLKData_0 = SiS300_MCLKData_300;  \n   } else {\n      SiS_Pr->SiS_MCLKData_0 = SiS300_MCLKData_630;  \n   }\n   SiS_Pr->SiS_VCLKData      = SiS300_VCLKData;\n   SiS_Pr->SiS_VBVCLKData    = (struct SiS_VBVCLKData *)SiS300_VCLKData;\n\n   SiS_Pr->SiS_SR15  = SiS300_SR15;\n\n   SiS_Pr->SiS_PanelDelayTbl     = SiS300_PanelDelayTbl;\n   SiS_Pr->SiS_PanelDelayTblLVDS = SiS300_PanelDelayTbl;\n\n   SiS_Pr->SiS_ExtLCD1024x768Data   = SiS300_ExtLCD1024x768Data;\n   SiS_Pr->SiS_St2LCD1024x768Data   = SiS300_St2LCD1024x768Data;\n   SiS_Pr->SiS_ExtLCD1280x1024Data  = SiS300_ExtLCD1280x1024Data;\n   SiS_Pr->SiS_St2LCD1280x1024Data  = SiS300_St2LCD1280x1024Data;\n\n   SiS_Pr->SiS_CRT2Part2_1024x768_1  = SiS300_CRT2Part2_1024x768_1;\n   SiS_Pr->SiS_CRT2Part2_1024x768_2  = SiS300_CRT2Part2_1024x768_2;\n   SiS_Pr->SiS_CRT2Part2_1024x768_3  = SiS300_CRT2Part2_1024x768_3;\n\n   SiS_Pr->SiS_CHTVUPALData  = SiS300_CHTVUPALData;\n   SiS_Pr->SiS_CHTVOPALData  = SiS300_CHTVOPALData;\n   SiS_Pr->SiS_CHTVUPALMData = SiS_CHTVUNTSCData;     \n   SiS_Pr->SiS_CHTVOPALMData = SiS_CHTVONTSCData;     \n   SiS_Pr->SiS_CHTVUPALNData = SiS300_CHTVUPALData;   \n   SiS_Pr->SiS_CHTVOPALNData = SiS300_CHTVOPALData;   \n   SiS_Pr->SiS_CHTVSOPALData = SiS300_CHTVSOPALData;\n\n   SiS_Pr->SiS_LVDS848x480Data_1   = SiS300_LVDS848x480Data_1;\n   SiS_Pr->SiS_LVDS848x480Data_2   = SiS300_LVDS848x480Data_2;\n   SiS_Pr->SiS_LVDSBARCO1024Data_1 = SiS300_LVDSBARCO1024Data_1;\n   SiS_Pr->SiS_LVDSBARCO1366Data_1 = SiS300_LVDSBARCO1366Data_1;\n   SiS_Pr->SiS_LVDSBARCO1366Data_2 = SiS300_LVDSBARCO1366Data_2;\n\n   SiS_Pr->SiS_PanelType04_1a = SiS300_PanelType04_1a;\n   SiS_Pr->SiS_PanelType04_2a = SiS300_PanelType04_2a;\n   SiS_Pr->SiS_PanelType04_1b = SiS300_PanelType04_1b;\n   SiS_Pr->SiS_PanelType04_2b = SiS300_PanelType04_2b;\n\n   SiS_Pr->SiS_CHTVCRT1UNTSC = SiS300_CHTVCRT1UNTSC;\n   SiS_Pr->SiS_CHTVCRT1ONTSC = SiS300_CHTVCRT1ONTSC;\n   SiS_Pr->SiS_CHTVCRT1UPAL  = SiS300_CHTVCRT1UPAL;\n   SiS_Pr->SiS_CHTVCRT1OPAL  = SiS300_CHTVCRT1OPAL;\n   SiS_Pr->SiS_CHTVCRT1SOPAL = SiS300_CHTVCRT1SOPAL;\n   SiS_Pr->SiS_CHTVReg_UNTSC = SiS300_CHTVReg_UNTSC;\n   SiS_Pr->SiS_CHTVReg_ONTSC = SiS300_CHTVReg_ONTSC;\n   SiS_Pr->SiS_CHTVReg_UPAL  = SiS300_CHTVReg_UPAL;\n   SiS_Pr->SiS_CHTVReg_OPAL  = SiS300_CHTVReg_OPAL;\n   SiS_Pr->SiS_CHTVReg_UPALM = SiS300_CHTVReg_UNTSC;   \n   SiS_Pr->SiS_CHTVReg_OPALM = SiS300_CHTVReg_ONTSC;   \n   SiS_Pr->SiS_CHTVReg_UPALN = SiS300_CHTVReg_UPAL;    \n   SiS_Pr->SiS_CHTVReg_OPALN = SiS300_CHTVReg_OPAL;    \n   SiS_Pr->SiS_CHTVReg_SOPAL = SiS300_CHTVReg_SOPAL;\n   SiS_Pr->SiS_CHTVVCLKUNTSC = SiS300_CHTVVCLKUNTSC;\n   SiS_Pr->SiS_CHTVVCLKONTSC = SiS300_CHTVVCLKONTSC;\n   SiS_Pr->SiS_CHTVVCLKUPAL  = SiS300_CHTVVCLKUPAL;\n   SiS_Pr->SiS_CHTVVCLKOPAL  = SiS300_CHTVVCLKOPAL;\n   SiS_Pr->SiS_CHTVVCLKUPALM = SiS300_CHTVVCLKUNTSC;   \n   SiS_Pr->SiS_CHTVVCLKOPALM = SiS300_CHTVVCLKONTSC;   \n   SiS_Pr->SiS_CHTVVCLKUPALN = SiS300_CHTVVCLKUPAL;    \n   SiS_Pr->SiS_CHTVVCLKOPALN = SiS300_CHTVVCLKOPAL;    \n   SiS_Pr->SiS_CHTVVCLKSOPAL = SiS300_CHTVVCLKSOPAL;\n}\n#endif\n\n#ifdef CONFIG_FB_SIS_315\nstatic void\nInitTo310Pointer(struct SiS_Private *SiS_Pr)\n{\n   InitCommonPointer(SiS_Pr);\n\n   SiS_Pr->SiS_EModeIDTable  = SiS310_EModeIDTable;\n   SiS_Pr->SiS_RefIndex      = SiS310_RefIndex;\n   SiS_Pr->SiS_CRT1Table     = SiS310_CRT1Table;\n   if(SiS_Pr->ChipType >= SIS_340) {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_340;   \n   } else if(SiS_Pr->ChipType >= SIS_761) {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_761;   \n   } else if(SiS_Pr->ChipType >= SIS_760) {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_760;   \n   } else if(SiS_Pr->ChipType >= SIS_661) {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_660;   \n   } else if(SiS_Pr->ChipType == SIS_330) {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_330;   \n   } else if(SiS_Pr->ChipType > SIS_315PRO) {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_650;   \n   } else {\n      SiS_Pr->SiS_MCLKData_0 = SiS310_MCLKData_0_315;   \n   }\n   if(SiS_Pr->ChipType >= SIS_340) {\n      SiS_Pr->SiS_MCLKData_1 = SiS310_MCLKData_1_340;\n   } else {\n      SiS_Pr->SiS_MCLKData_1 = SiS310_MCLKData_1;\n   }\n   SiS_Pr->SiS_VCLKData      = SiS310_VCLKData;\n   SiS_Pr->SiS_VBVCLKData    = SiS310_VBVCLKData;\n\n   SiS_Pr->SiS_SR15  = SiS310_SR15;\n\n   SiS_Pr->SiS_PanelDelayTbl     = SiS310_PanelDelayTbl;\n   SiS_Pr->SiS_PanelDelayTblLVDS = SiS310_PanelDelayTblLVDS;\n\n   SiS_Pr->SiS_St2LCD1024x768Data   = SiS310_St2LCD1024x768Data;\n   SiS_Pr->SiS_ExtLCD1024x768Data   = SiS310_ExtLCD1024x768Data;\n   SiS_Pr->SiS_St2LCD1280x1024Data  = SiS310_St2LCD1280x1024Data;\n   SiS_Pr->SiS_ExtLCD1280x1024Data  = SiS310_ExtLCD1280x1024Data;\n\n   SiS_Pr->SiS_CRT2Part2_1024x768_1  = SiS310_CRT2Part2_1024x768_1;\n\n   SiS_Pr->SiS_CHTVUPALData  = SiS310_CHTVUPALData;\n   SiS_Pr->SiS_CHTVOPALData  = SiS310_CHTVOPALData;\n   SiS_Pr->SiS_CHTVUPALMData = SiS310_CHTVUPALMData;\n   SiS_Pr->SiS_CHTVOPALMData = SiS310_CHTVOPALMData;\n   SiS_Pr->SiS_CHTVUPALNData = SiS310_CHTVUPALNData;\n   SiS_Pr->SiS_CHTVOPALNData = SiS310_CHTVOPALNData;\n   SiS_Pr->SiS_CHTVSOPALData = SiS310_CHTVSOPALData;\n\n   SiS_Pr->SiS_CHTVCRT1UNTSC = SiS310_CHTVCRT1UNTSC;\n   SiS_Pr->SiS_CHTVCRT1ONTSC = SiS310_CHTVCRT1ONTSC;\n   SiS_Pr->SiS_CHTVCRT1UPAL  = SiS310_CHTVCRT1UPAL;\n   SiS_Pr->SiS_CHTVCRT1OPAL  = SiS310_CHTVCRT1OPAL;\n   SiS_Pr->SiS_CHTVCRT1SOPAL = SiS310_CHTVCRT1OPAL;\n\n   SiS_Pr->SiS_CHTVReg_UNTSC = SiS310_CHTVReg_UNTSC;\n   SiS_Pr->SiS_CHTVReg_ONTSC = SiS310_CHTVReg_ONTSC;\n   SiS_Pr->SiS_CHTVReg_UPAL  = SiS310_CHTVReg_UPAL;\n   SiS_Pr->SiS_CHTVReg_OPAL  = SiS310_CHTVReg_OPAL;\n   SiS_Pr->SiS_CHTVReg_UPALM = SiS310_CHTVReg_UPALM;\n   SiS_Pr->SiS_CHTVReg_OPALM = SiS310_CHTVReg_OPALM;\n   SiS_Pr->SiS_CHTVReg_UPALN = SiS310_CHTVReg_UPALN;\n   SiS_Pr->SiS_CHTVReg_OPALN = SiS310_CHTVReg_OPALN;\n   SiS_Pr->SiS_CHTVReg_SOPAL = SiS310_CHTVReg_OPAL;\n\n   SiS_Pr->SiS_CHTVVCLKUNTSC = SiS310_CHTVVCLKUNTSC;\n   SiS_Pr->SiS_CHTVVCLKONTSC = SiS310_CHTVVCLKONTSC;\n   SiS_Pr->SiS_CHTVVCLKUPAL  = SiS310_CHTVVCLKUPAL;\n   SiS_Pr->SiS_CHTVVCLKOPAL  = SiS310_CHTVVCLKOPAL;\n   SiS_Pr->SiS_CHTVVCLKUPALM = SiS310_CHTVVCLKUPALM;\n   SiS_Pr->SiS_CHTVVCLKOPALM = SiS310_CHTVVCLKOPALM;\n   SiS_Pr->SiS_CHTVVCLKUPALN = SiS310_CHTVVCLKUPALN;\n   SiS_Pr->SiS_CHTVVCLKOPALN = SiS310_CHTVVCLKOPALN;\n   SiS_Pr->SiS_CHTVVCLKSOPAL = SiS310_CHTVVCLKOPAL;\n}\n#endif\n\nbool\nSiSInitPtr(struct SiS_Private *SiS_Pr)\n{\n   if(SiS_Pr->ChipType < SIS_315H) {\n#ifdef CONFIG_FB_SIS_300\n      InitTo300Pointer(SiS_Pr);\n#else\n      return false;\n#endif\n   } else {\n#ifdef CONFIG_FB_SIS_315\n      InitTo310Pointer(SiS_Pr);\n#else\n      return false;\n#endif\n   }\n   return true;\n}\n\n \n \n \n\nstatic\nunsigned short\nSiS_GetModeID(int VGAEngine, unsigned int VBFlags, int HDisplay, int VDisplay,\n\t\tint Depth, bool FSTN, int LCDwidth, int LCDheight)\n{\n   unsigned short ModeIndex = 0;\n\n   switch(HDisplay)\n   {\n\tcase 320:\n\t\tif(VDisplay == 200) ModeIndex = ModeIndex_320x200[Depth];\n\t\telse if(VDisplay == 240) {\n\t\t\tif((VBFlags & CRT2_LCD) && (FSTN))\n\t\t\t\tModeIndex = ModeIndex_320x240_FSTN[Depth];\n\t\t\telse\n\t\t\t\tModeIndex = ModeIndex_320x240[Depth];\n\t\t}\n\t\tbreak;\n\tcase 400:\n\t\tif((!(VBFlags & CRT1_LCDA)) || ((LCDwidth >= 800) && (LCDheight >= 600))) {\n\t\t\tif(VDisplay == 300) ModeIndex = ModeIndex_400x300[Depth];\n\t\t}\n\t\tbreak;\n\tcase 512:\n\t\tif((!(VBFlags & CRT1_LCDA)) || ((LCDwidth >= 1024) && (LCDheight >= 768))) {\n\t\t\tif(VDisplay == 384) ModeIndex = ModeIndex_512x384[Depth];\n\t\t}\n\t\tbreak;\n\tcase 640:\n\t\tif(VDisplay == 480)      ModeIndex = ModeIndex_640x480[Depth];\n\t\telse if(VDisplay == 400) ModeIndex = ModeIndex_640x400[Depth];\n\t\tbreak;\n\tcase 720:\n\t\tif(VDisplay == 480)      ModeIndex = ModeIndex_720x480[Depth];\n\t\telse if(VDisplay == 576) ModeIndex = ModeIndex_720x576[Depth];\n\t\tbreak;\n\tcase 768:\n\t\tif(VDisplay == 576) ModeIndex = ModeIndex_768x576[Depth];\n\t\tbreak;\n\tcase 800:\n\t\tif(VDisplay == 600)      ModeIndex = ModeIndex_800x600[Depth];\n\t\telse if(VDisplay == 480) ModeIndex = ModeIndex_800x480[Depth];\n\t\tbreak;\n\tcase 848:\n\t\tif(VDisplay == 480) ModeIndex = ModeIndex_848x480[Depth];\n\t\tbreak;\n\tcase 856:\n\t\tif(VDisplay == 480) ModeIndex = ModeIndex_856x480[Depth];\n\t\tbreak;\n\tcase 960:\n\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t\tif(VDisplay == 540)      ModeIndex = ModeIndex_960x540[Depth];\n\t\t\telse if(VDisplay == 600) ModeIndex = ModeIndex_960x600[Depth];\n\t\t}\n\t\tbreak;\n\tcase 1024:\n\t\tif(VDisplay == 576)      ModeIndex = ModeIndex_1024x576[Depth];\n\t\telse if(VDisplay == 768) ModeIndex = ModeIndex_1024x768[Depth];\n\t\telse if(VGAEngine == SIS_300_VGA) {\n\t\t\tif(VDisplay == 600) ModeIndex = ModeIndex_1024x600[Depth];\n\t\t}\n\t\tbreak;\n\tcase 1152:\n\t\tif(VDisplay == 864) ModeIndex = ModeIndex_1152x864[Depth];\n\t\tif(VGAEngine == SIS_300_VGA) {\n\t\t\tif(VDisplay == 768) ModeIndex = ModeIndex_1152x768[Depth];\n\t\t}\n\t\tbreak;\n\tcase 1280:\n\t\tswitch(VDisplay) {\n\t\t\tcase 720:\n\t\t\t\tModeIndex = ModeIndex_1280x720[Depth];\n\t\t\t\tbreak;\n\t\t\tcase 768:\n\t\t\t\tif(VGAEngine == SIS_300_VGA) {\n\t\t\t\t\tModeIndex = ModeIndex_300_1280x768[Depth];\n\t\t\t\t} else {\n\t\t\t\t\tModeIndex = ModeIndex_310_1280x768[Depth];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 800:\n\t\t\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t\t\t\tModeIndex = ModeIndex_1280x800[Depth];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 854:\n\t\t\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t\t\t\tModeIndex = ModeIndex_1280x854[Depth];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 960:\n\t\t\t\tModeIndex = ModeIndex_1280x960[Depth];\n\t\t\t\tbreak;\n\t\t\tcase 1024:\n\t\t\t\tModeIndex = ModeIndex_1280x1024[Depth];\n\t\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 1360:\n\t\tif(VDisplay == 768) ModeIndex = ModeIndex_1360x768[Depth];\n\t\tif(VGAEngine == SIS_300_VGA) {\n\t\t\tif(VDisplay == 1024) ModeIndex = ModeIndex_300_1360x1024[Depth];\n\t\t}\n\t\tbreak;\n\tcase 1400:\n\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t\tif(VDisplay == 1050) {\n\t\t\t\tModeIndex = ModeIndex_1400x1050[Depth];\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase 1600:\n\t\tif(VDisplay == 1200) ModeIndex = ModeIndex_1600x1200[Depth];\n\t\tbreak;\n\tcase 1680:\n\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t\tif(VDisplay == 1050) ModeIndex = ModeIndex_1680x1050[Depth];\n\t\t}\n\t\tbreak;\n\tcase 1920:\n\t\tif(VDisplay == 1440) ModeIndex = ModeIndex_1920x1440[Depth];\n\t\telse if(VGAEngine == SIS_315_VGA) {\n\t\t\tif(VDisplay == 1080) ModeIndex = ModeIndex_1920x1080[Depth];\n\t\t}\n\t\tbreak;\n\tcase 2048:\n\t\tif(VDisplay == 1536) {\n\t\t\tif(VGAEngine == SIS_300_VGA) {\n\t\t\t\tModeIndex = ModeIndex_300_2048x1536[Depth];\n\t\t\t} else {\n\t\t\t\tModeIndex = ModeIndex_310_2048x1536[Depth];\n\t\t\t}\n\t\t}\n\t\tbreak;\n   }\n\n   return ModeIndex;\n}\n\nunsigned short\nSiS_GetModeID_LCD(int VGAEngine, unsigned int VBFlags, int HDisplay, int VDisplay,\n\t\tint Depth, bool FSTN, unsigned short CustomT, int LCDwidth, int LCDheight,\n\t\tunsigned int VBFlags2)\n{\n   unsigned short ModeIndex = 0;\n\n   if(VBFlags2 & (VB2_LVDS | VB2_30xBDH)) {\n\n      switch(HDisplay)\n      {\n\tcase 320:\n\t     if((CustomT != CUT_PANEL848) && (CustomT != CUT_PANEL856)) {\n\t\tif(VDisplay == 200) {\n\t\t   if(!FSTN) ModeIndex = ModeIndex_320x200[Depth];\n\t\t} else if(VDisplay == 240) {\n\t\t   if(!FSTN) ModeIndex = ModeIndex_320x240[Depth];\n\t\t   else if(VGAEngine == SIS_315_VGA) {\n\t\t      ModeIndex = ModeIndex_320x240_FSTN[Depth];\n\t\t   }\n\t\t}\n\t     }\n\t     break;\n\tcase 400:\n\t     if((CustomT != CUT_PANEL848) && (CustomT != CUT_PANEL856)) {\n\t\tif(!((VGAEngine == SIS_300_VGA) && (VBFlags2 & VB2_TRUMPION))) {\n\t\t   if(VDisplay == 300) ModeIndex = ModeIndex_400x300[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 512:\n\t     if((CustomT != CUT_PANEL848) && (CustomT != CUT_PANEL856)) {\n\t\tif(!((VGAEngine == SIS_300_VGA) && (VBFlags2 & VB2_TRUMPION))) {\n\t\t   if(LCDwidth >= 1024 && LCDwidth != 1152 && LCDheight >= 768) {\n\t\t      if(VDisplay == 384) {\n\t\t         ModeIndex = ModeIndex_512x384[Depth];\n\t\t      }\n\t\t   }\n\t\t}\n\t     }\n\t     break;\n\tcase 640:\n\t     if(VDisplay == 480) ModeIndex = ModeIndex_640x480[Depth];\n\t     else if(VDisplay == 400) {\n\t\tif((CustomT != CUT_PANEL848) && (CustomT != CUT_PANEL856))\n\t\t   ModeIndex = ModeIndex_640x400[Depth];\n\t     }\n\t     break;\n\tcase 800:\n\t     if(VDisplay == 600) ModeIndex = ModeIndex_800x600[Depth];\n\t     break;\n\tcase 848:\n\t     if(CustomT == CUT_PANEL848) {\n\t        if(VDisplay == 480) ModeIndex = ModeIndex_848x480[Depth];\n\t     }\n\t     break;\n\tcase 856:\n\t     if(CustomT == CUT_PANEL856) {\n\t        if(VDisplay == 480) ModeIndex = ModeIndex_856x480[Depth];\n\t     }\n\t     break;\n\tcase 1024:\n\t     if(VDisplay == 768) ModeIndex = ModeIndex_1024x768[Depth];\n\t     else if(VGAEngine == SIS_300_VGA) {\n\t\tif((VDisplay == 600) && (LCDheight == 600)) {\n\t\t   ModeIndex = ModeIndex_1024x600[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 1152:\n\t     if(VGAEngine == SIS_300_VGA) {\n\t\tif((VDisplay == 768) && (LCDheight == 768)) {\n\t\t   ModeIndex = ModeIndex_1152x768[Depth];\n\t\t}\n\t     }\n\t     break;\n        case 1280:\n\t     if(VDisplay == 1024) ModeIndex = ModeIndex_1280x1024[Depth];\n\t     else if(VGAEngine == SIS_315_VGA) {\n\t\tif((VDisplay == 768) && (LCDheight == 768)) {\n\t\t   ModeIndex = ModeIndex_310_1280x768[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 1360:\n\t     if(VGAEngine == SIS_300_VGA) {\n\t\tif(CustomT == CUT_BARCO1366) {\n\t\t   if(VDisplay == 1024) ModeIndex = ModeIndex_300_1360x1024[Depth];\n\t\t}\n\t     }\n\t     if(CustomT == CUT_PANEL848) {\n\t\tif(VDisplay == 768) ModeIndex = ModeIndex_1360x768[Depth];\n\t     }\n\t     break;\n\tcase 1400:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 1050) ModeIndex = ModeIndex_1400x1050[Depth];\n\t     }\n\t     break;\n\tcase 1600:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 1200) ModeIndex = ModeIndex_1600x1200[Depth];\n\t     }\n\t     break;\n      }\n\n   } else if(VBFlags2 & VB2_SISBRIDGE) {\n\n      switch(HDisplay)\n      {\n\tcase 320:\n\t     if(VDisplay == 200)      ModeIndex = ModeIndex_320x200[Depth];\n\t     else if(VDisplay == 240) ModeIndex = ModeIndex_320x240[Depth];\n\t     break;\n\tcase 400:\n\t     if(LCDwidth >= 800 && LCDheight >= 600) {\n\t\tif(VDisplay == 300) ModeIndex = ModeIndex_400x300[Depth];\n\t     }\n\t     break;\n\tcase 512:\n\t     if(LCDwidth >= 1024 && LCDheight >= 768 && LCDwidth != 1152) {\n\t\tif(VDisplay == 384) ModeIndex = ModeIndex_512x384[Depth];\n\t     }\n\t     break;\n\tcase 640:\n\t     if(VDisplay == 480)      ModeIndex = ModeIndex_640x480[Depth];\n\t     else if(VDisplay == 400) ModeIndex = ModeIndex_640x400[Depth];\n\t     break;\n\tcase 720:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 480)      ModeIndex = ModeIndex_720x480[Depth];\n\t\telse if(VDisplay == 576) ModeIndex = ModeIndex_720x576[Depth];\n\t     }\n\t     break;\n\tcase 768:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 576) ModeIndex = ModeIndex_768x576[Depth];\n\t     }\n\t     break;\n\tcase 800:\n\t     if(VDisplay == 600) ModeIndex = ModeIndex_800x600[Depth];\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 480) ModeIndex = ModeIndex_800x480[Depth];\n\t     }\n\t     break;\n\tcase 848:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 480) ModeIndex = ModeIndex_848x480[Depth];\n\t     }\n\t     break;\n\tcase 856:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 480) ModeIndex = ModeIndex_856x480[Depth];\n\t     }\n\t     break;\n\tcase 960:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 540)      ModeIndex = ModeIndex_960x540[Depth];\n\t\telse if(VDisplay == 600) ModeIndex = ModeIndex_960x600[Depth];\n\t     }\n\t     break;\n\tcase 1024:\n\t     if(VDisplay == 768) ModeIndex = ModeIndex_1024x768[Depth];\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 576) ModeIndex = ModeIndex_1024x576[Depth];\n\t     }\n\t     break;\n\tcase 1152:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 864) ModeIndex = ModeIndex_1152x864[Depth];\n\t     }\n\t     break;\n\tcase 1280:\n\t     switch(VDisplay) {\n\t     case 720:\n\t\tModeIndex = ModeIndex_1280x720[Depth];\n\t\tbreak;\n\t     case 768:\n\t\tif(VGAEngine == SIS_300_VGA) {\n\t\t   ModeIndex = ModeIndex_300_1280x768[Depth];\n\t\t} else {\n\t\t   ModeIndex = ModeIndex_310_1280x768[Depth];\n\t\t}\n\t\tbreak;\n\t     case 800:\n\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t   ModeIndex = ModeIndex_1280x800[Depth];\n\t\t}\n\t\tbreak;\n\t     case 854:\n\t\tif(VGAEngine == SIS_315_VGA) {\n\t\t   ModeIndex = ModeIndex_1280x854[Depth];\n\t\t}\n\t\tbreak;\n\t     case 960:\n\t\tModeIndex = ModeIndex_1280x960[Depth];\n\t\tbreak;\n\t     case 1024:\n\t\tModeIndex = ModeIndex_1280x1024[Depth];\n\t\tbreak;\n\t     }\n\t     break;\n\tcase 1360:\n\t     if(VGAEngine == SIS_315_VGA) {   \n\t\tif(VDisplay == 768) ModeIndex = ModeIndex_1360x768[Depth];\n\t     }\n\t     break;\n\tcase 1400:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VBFlags2 & VB2_LCDOVER1280BRIDGE) {\n\t\t   if(VDisplay == 1050) ModeIndex = ModeIndex_1400x1050[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 1600:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VBFlags2 & VB2_LCDOVER1280BRIDGE) {\n\t\t   if(VDisplay == 1200) ModeIndex = ModeIndex_1600x1200[Depth];\n\t\t}\n\t     }\n\t     break;\n#ifndef VB_FORBID_CRT2LCD_OVER_1600\n\tcase 1680:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VBFlags2 & VB2_LCDOVER1280BRIDGE) {\n\t\t   if(VDisplay == 1050) ModeIndex = ModeIndex_1680x1050[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 1920:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VBFlags2 & VB2_LCDOVER1600BRIDGE) {\n\t\t   if(VDisplay == 1440) ModeIndex = ModeIndex_1920x1440[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 2048:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VBFlags2 & VB2_LCDOVER1600BRIDGE) {\n\t\t   if(VDisplay == 1536) ModeIndex = ModeIndex_310_2048x1536[Depth];\n\t\t}\n\t     }\n\t     break;\n#endif\n      }\n   }\n\n   return ModeIndex;\n}\n\nunsigned short\nSiS_GetModeID_TV(int VGAEngine, unsigned int VBFlags, int HDisplay, int VDisplay, int Depth,\n\t\t\tunsigned int VBFlags2)\n{\n   unsigned short ModeIndex = 0;\n\n   if(VBFlags2 & VB2_CHRONTEL) {\n\n      switch(HDisplay)\n      {\n\tcase 512:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 384) ModeIndex = ModeIndex_512x384[Depth];\n\t     }\n\t     break;\n\tcase 640:\n\t     if(VDisplay == 480)      ModeIndex = ModeIndex_640x480[Depth];\n\t     else if(VDisplay == 400) ModeIndex = ModeIndex_640x400[Depth];\n\t     break;\n\tcase 800:\n\t     if(VDisplay == 600) ModeIndex = ModeIndex_800x600[Depth];\n\t     break;\n\tcase 1024:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 768) ModeIndex = ModeIndex_1024x768[Depth];\n\t     }\n\t     break;\n      }\n\n   } else if(VBFlags2 & VB2_SISTVBRIDGE) {\n\n      switch(HDisplay)\n      {\n\tcase 320:\n\t     if(VDisplay == 200)      ModeIndex = ModeIndex_320x200[Depth];\n\t     else if(VDisplay == 240) ModeIndex = ModeIndex_320x240[Depth];\n\t     break;\n\tcase 400:\n\t     if(VDisplay == 300) ModeIndex = ModeIndex_400x300[Depth];\n\t     break;\n\tcase 512:\n\t     if( ((VBFlags & TV_YPBPR) && (VBFlags & (TV_YPBPR750P | TV_YPBPR1080I))) ||\n\t\t (VBFlags & TV_HIVISION) \t\t\t\t\t      ||\n\t\t ((!(VBFlags & (TV_YPBPR | TV_PALM))) && (VBFlags & TV_PAL)) ) {\n\t\tif(VDisplay == 384) ModeIndex = ModeIndex_512x384[Depth];\n\t     }\n\t     break;\n\tcase 640:\n\t     if(VDisplay == 480)      ModeIndex = ModeIndex_640x480[Depth];\n\t     else if(VDisplay == 400) ModeIndex = ModeIndex_640x400[Depth];\n\t     break;\n\tcase 720:\n\t     if((!(VBFlags & TV_HIVISION)) && (!((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR1080I)))) {\n\t\tif(VDisplay == 480) {\n\t\t   ModeIndex = ModeIndex_720x480[Depth];\n\t\t} else if(VDisplay == 576) {\n\t\t   if( ((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR750P)) ||\n\t\t       ((!(VBFlags & (TV_YPBPR | TV_PALM))) && (VBFlags & TV_PAL)) )\n\t\t      ModeIndex = ModeIndex_720x576[Depth];\n\t\t}\n\t     }\n             break;\n\tcase 768:\n\t     if((!(VBFlags & TV_HIVISION)) && (!((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR1080I)))) {\n\t\tif( ((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR750P)) ||\n\t\t    ((!(VBFlags & (TV_YPBPR | TV_PALM))) && (VBFlags & TV_PAL)) ) {\n\t\t   if(VDisplay == 576) ModeIndex = ModeIndex_768x576[Depth];\n\t\t}\n             }\n\t     break;\n\tcase 800:\n\t     if(VDisplay == 600) ModeIndex = ModeIndex_800x600[Depth];\n\t     else if(VDisplay == 480) {\n\t\tif(!((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR750P))) {\n\t\t   ModeIndex = ModeIndex_800x480[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 960:\n\t     if(VGAEngine == SIS_315_VGA) {\n\t\tif(VDisplay == 600) {\n\t\t   if((VBFlags & TV_HIVISION) || ((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR1080I))) {\n\t\t      ModeIndex = ModeIndex_960x600[Depth];\n\t\t   }\n\t\t}\n\t     }\n\t     break;\n\tcase 1024:\n\t     if(VDisplay == 768) {\n\t\tif(VBFlags2 & VB2_30xBLV) {\n\t\t   ModeIndex = ModeIndex_1024x768[Depth];\n\t\t}\n\t     } else if(VDisplay == 576) {\n\t\tif( (VBFlags & TV_HIVISION) ||\n\t\t    ((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR1080I)) ||\n\t\t    ((VBFlags2 & VB2_30xBLV) &&\n\t\t     ((!(VBFlags & (TV_YPBPR | TV_PALM))) && (VBFlags & TV_PAL))) ) {\n\t\t   ModeIndex = ModeIndex_1024x576[Depth];\n\t\t}\n\t     }\n\t     break;\n\tcase 1280:\n\t     if(VDisplay == 720) {\n\t\tif((VBFlags & TV_HIVISION) ||\n\t\t   ((VBFlags & TV_YPBPR) && (VBFlags & (TV_YPBPR1080I | TV_YPBPR750P)))) {\n\t\t   ModeIndex = ModeIndex_1280x720[Depth];\n\t\t}\n\t     } else if(VDisplay == 1024) {\n\t\tif((VBFlags & TV_HIVISION) ||\n\t\t   ((VBFlags & TV_YPBPR) && (VBFlags & TV_YPBPR1080I))) {\n\t\t   ModeIndex = ModeIndex_1280x1024[Depth];\n\t\t}\n\t     }\n\t     break;\n      }\n   }\n   return ModeIndex;\n}\n\nunsigned short\nSiS_GetModeID_VGA2(int VGAEngine, unsigned int VBFlags, int HDisplay, int VDisplay, int Depth,\n\t\t\tunsigned int VBFlags2)\n{\n   if(!(VBFlags2 & VB2_SISVGA2BRIDGE)) return 0;\n\n   if(HDisplay >= 1920) return 0;\n\n   switch(HDisplay)\n   {\n\tcase 1600:\n\t\tif(VDisplay == 1200) {\n\t\t\tif(VGAEngine != SIS_315_VGA) return 0;\n\t\t\tif(!(VBFlags2 & VB2_30xB)) return 0;\n\t\t}\n\t\tbreak;\n\tcase 1680:\n\t\tif(VDisplay == 1050) {\n\t\t\tif(VGAEngine != SIS_315_VGA) return 0;\n\t\t\tif(!(VBFlags2 & VB2_30xB)) return 0;\n\t\t}\n\t\tbreak;\n   }\n\n   return SiS_GetModeID(VGAEngine, 0, HDisplay, VDisplay, Depth, false, 0, 0);\n}\n\n\n \n \n \n\nvoid\nSiS_SetReg(SISIOADDRESS port, u8 index, u8 data)\n{\n\toutb(index, port);\n\toutb(data, port + 1);\n}\n\nvoid\nSiS_SetRegByte(SISIOADDRESS port, u8 data)\n{\n\toutb(data, port);\n}\n\nvoid\nSiS_SetRegShort(SISIOADDRESS port, u16 data)\n{\n\toutw(data, port);\n}\n\nvoid\nSiS_SetRegLong(SISIOADDRESS port, u32 data)\n{\n\toutl(data, port);\n}\n\nu8\nSiS_GetReg(SISIOADDRESS port, u8 index)\n{\n\toutb(index, port);\n\treturn inb(port + 1);\n}\n\nu8\nSiS_GetRegByte(SISIOADDRESS port)\n{\n\treturn inb(port);\n}\n\nu16\nSiS_GetRegShort(SISIOADDRESS port)\n{\n\treturn inw(port);\n}\n\nu32\nSiS_GetRegLong(SISIOADDRESS port)\n{\n\treturn inl(port);\n}\n\nvoid\nSiS_SetRegANDOR(SISIOADDRESS Port, u8 Index, u8 DataAND, u8 DataOR)\n{\n   u8 temp;\n\n   temp = SiS_GetReg(Port, Index);\n   temp = (temp & (DataAND)) | DataOR;\n   SiS_SetReg(Port, Index, temp);\n}\n\nvoid\nSiS_SetRegAND(SISIOADDRESS Port, u8 Index, u8 DataAND)\n{\n   u8 temp;\n\n   temp = SiS_GetReg(Port, Index);\n   temp &= DataAND;\n   SiS_SetReg(Port, Index, temp);\n}\n\nvoid\nSiS_SetRegOR(SISIOADDRESS Port, u8 Index, u8 DataOR)\n{\n   u8 temp;\n\n   temp = SiS_GetReg(Port, Index);\n   temp |= DataOR;\n   SiS_SetReg(Port, Index, temp);\n}\n\n \n \n \n\nvoid\nSiS_DisplayOn(struct SiS_Private *SiS_Pr)\n{\n   SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x01,0xDF);\n}\n\nvoid\nSiS_DisplayOff(struct SiS_Private *SiS_Pr)\n{\n   SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x01,0x20);\n}\n\n\n \n \n \n\nvoid\nSiSRegInit(struct SiS_Private *SiS_Pr, SISIOADDRESS BaseAddr)\n{\n   SiS_Pr->SiS_P3c4 = BaseAddr + 0x14;\n   SiS_Pr->SiS_P3d4 = BaseAddr + 0x24;\n   SiS_Pr->SiS_P3c0 = BaseAddr + 0x10;\n   SiS_Pr->SiS_P3ce = BaseAddr + 0x1e;\n   SiS_Pr->SiS_P3c2 = BaseAddr + 0x12;\n   SiS_Pr->SiS_P3ca = BaseAddr + 0x1a;\n   SiS_Pr->SiS_P3c6 = BaseAddr + 0x16;\n   SiS_Pr->SiS_P3c7 = BaseAddr + 0x17;\n   SiS_Pr->SiS_P3c8 = BaseAddr + 0x18;\n   SiS_Pr->SiS_P3c9 = BaseAddr + 0x19;\n   SiS_Pr->SiS_P3cb = BaseAddr + 0x1b;\n   SiS_Pr->SiS_P3cc = BaseAddr + 0x1c;\n   SiS_Pr->SiS_P3cd = BaseAddr + 0x1d;\n   SiS_Pr->SiS_P3da = BaseAddr + 0x2a;\n   SiS_Pr->SiS_Part1Port = BaseAddr + SIS_CRT2_PORT_04;\n   SiS_Pr->SiS_Part2Port = BaseAddr + SIS_CRT2_PORT_10;\n   SiS_Pr->SiS_Part3Port = BaseAddr + SIS_CRT2_PORT_12;\n   SiS_Pr->SiS_Part4Port = BaseAddr + SIS_CRT2_PORT_14;\n   SiS_Pr->SiS_Part5Port = BaseAddr + SIS_CRT2_PORT_14 + 2;\n   SiS_Pr->SiS_DDC_Port  = BaseAddr + 0x14;\n   SiS_Pr->SiS_VidCapt   = BaseAddr + SIS_VIDEO_CAPTURE;\n   SiS_Pr->SiS_VidPlay   = BaseAddr + SIS_VIDEO_PLAYBACK;\n}\n\n \n \n \n\nstatic void\nSiS_GetSysFlags(struct SiS_Private *SiS_Pr)\n{\n   unsigned char cr5f, temp1, temp2;\n\n    \n    \n   SiS_Pr->SiS_SensibleSR11 = false;\n   SiS_Pr->SiS_MyCR63 = 0x63;\n   if(SiS_Pr->ChipType >= SIS_330) {\n      SiS_Pr->SiS_MyCR63 = 0x53;\n      if(SiS_Pr->ChipType >= SIS_661) {\n         SiS_Pr->SiS_SensibleSR11 = true;\n      }\n   }\n\n    \n\n   SiS_Pr->SiS_SysFlags = 0;\n   if(SiS_Pr->ChipType == SIS_650) {\n      cr5f = SiS_GetReg(SiS_Pr->SiS_P3d4,0x5f) & 0xf0;\n      SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x5c,0x07);\n      temp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x5c) & 0xf8;\n      SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x5c,0xf8);\n      temp2 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x5c) & 0xf8;\n      if((!temp1) || (temp2)) {\n\t switch(cr5f) {\n\t    case 0x80:\n\t    case 0x90:\n\t    case 0xc0:\n\t       SiS_Pr->SiS_SysFlags |= SF_IsM650;\n\t       break;\n\t    case 0xa0:\n\t    case 0xb0:\n\t    case 0xe0:\n\t       SiS_Pr->SiS_SysFlags |= SF_Is651;\n\t       break;\n\t }\n      } else {\n\t switch(cr5f) {\n\t    case 0x90:\n\t       temp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x5c) & 0xf8;\n\t       switch(temp1) {\n\t\t  case 0x00: SiS_Pr->SiS_SysFlags |= SF_IsM652; break;\n\t\t  case 0x40: SiS_Pr->SiS_SysFlags |= SF_IsM653; break;\n\t\t  default:   SiS_Pr->SiS_SysFlags |= SF_IsM650; break;\n\t       }\n\t       break;\n\t    case 0xb0:\n\t       SiS_Pr->SiS_SysFlags |= SF_Is652;\n\t       break;\n\t    default:\n\t       SiS_Pr->SiS_SysFlags |= SF_IsM650;\n\t       break;\n\t }\n      }\n   }\n\n   if(SiS_Pr->ChipType >= SIS_760 && SiS_Pr->ChipType <= SIS_761) {\n      if(SiS_GetReg(SiS_Pr->SiS_P3d4,0x78) & 0x30) {\n         SiS_Pr->SiS_SysFlags |= SF_760LFB;\n      }\n      if(SiS_GetReg(SiS_Pr->SiS_P3d4,0x79) & 0xf0) {\n         SiS_Pr->SiS_SysFlags |= SF_760UMA;\n      }\n   }\n}\n\n \n \n \n\nstatic void\nSiSInitPCIetc(struct SiS_Private *SiS_Pr)\n{\n   switch(SiS_Pr->ChipType) {\n#ifdef CONFIG_FB_SIS_300\n   case SIS_300:\n   case SIS_540:\n   case SIS_630:\n   case SIS_730:\n       \n      SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x20,0xa1);\n       \n      SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x5A);\n      break;\n#endif\n#ifdef CONFIG_FB_SIS_315\n   case SIS_315H:\n   case SIS_315:\n   case SIS_315PRO:\n   case SIS_650:\n   case SIS_740:\n   case SIS_330:\n   case SIS_661:\n   case SIS_741:\n   case SIS_660:\n   case SIS_760:\n   case SIS_761:\n   case SIS_340:\n   case XGI_40:\n       \n      SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x20,0xa1);\n       \n      SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0xDA);\n      break;\n   case XGI_20:\n   case SIS_550:\n       \n      SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x20,0xa1);\n       \n       \n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x1E,0x60,0x40);\n      break;\n#endif\n   default:\n      break;\n   }\n}\n\n \n \n \n\nstatic\nvoid\nSiSSetLVDSetc(struct SiS_Private *SiS_Pr)\n{\n   unsigned short temp;\n\n   SiS_Pr->SiS_IF_DEF_LVDS = 0;\n   SiS_Pr->SiS_IF_DEF_TRUMPION = 0;\n   SiS_Pr->SiS_IF_DEF_CH70xx = 0;\n   SiS_Pr->SiS_IF_DEF_CONEX = 0;\n\n   SiS_Pr->SiS_ChrontelInit = 0;\n\n   if(SiS_Pr->ChipType == XGI_20) return;\n\n    \n   temp = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x00);\n   if((temp == 1) || (temp == 2)) return;\n\n   switch(SiS_Pr->ChipType) {\n#ifdef CONFIG_FB_SIS_300\n   case SIS_540:\n   case SIS_630:\n   case SIS_730:\n\ttemp = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x37) & 0x0e) >> 1;\n\tif((temp >= 2) && (temp <= 5))\tSiS_Pr->SiS_IF_DEF_LVDS = 1;\n\tif(temp == 3)\t\t\tSiS_Pr->SiS_IF_DEF_TRUMPION = 1;\n\tif((temp == 4) || (temp == 5)) {\n\t\t \n\t\tSiS_Pr->SiS_Backup70xx = SiS_GetCH700x(SiS_Pr, 0x0e);\n\t\tSiS_Pr->SiS_IF_DEF_CH70xx = 1;\n\t}\n\tbreak;\n#endif\n#ifdef CONFIG_FB_SIS_315\n   case SIS_550:\n   case SIS_650:\n   case SIS_740:\n   case SIS_330:\n\ttemp = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x37) & 0x0e) >> 1;\n\tif((temp >= 2) && (temp <= 3))\tSiS_Pr->SiS_IF_DEF_LVDS = 1;\n\tif(temp == 3)\t\t\tSiS_Pr->SiS_IF_DEF_CH70xx = 2;\n\tbreak;\n   case SIS_661:\n   case SIS_741:\n   case SIS_660:\n   case SIS_760:\n   case SIS_761:\n   case SIS_340:\n   case XGI_20:\n   case XGI_40:\n\ttemp = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x38) & 0xe0) >> 5;\n\tif((temp >= 2) && (temp <= 3)) \tSiS_Pr->SiS_IF_DEF_LVDS = 1;\n\tif(temp == 3)\t\t\tSiS_Pr->SiS_IF_DEF_CH70xx = 2;\n\tif(temp == 4)\t\t\tSiS_Pr->SiS_IF_DEF_CONEX = 1;   \n\tbreak;\n#endif\n   default:\n\tbreak;\n   }\n}\n\n \n \n \n\nvoid\nSiS_SetEnableDstn(struct SiS_Private *SiS_Pr, int enable)\n{\n   SiS_Pr->SiS_IF_DEF_DSTN = enable ? 1 : 0;\n}\n\nvoid\nSiS_SetEnableFstn(struct SiS_Private *SiS_Pr, int enable)\n{\n   SiS_Pr->SiS_IF_DEF_FSTN = enable ? 1 : 0;\n}\n\n \n \n \n\nunsigned short\nSiS_GetModeFlag(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex)\n{\n   if(SiS_Pr->UseCustomMode) {\n      return SiS_Pr->CModeFlag;\n   } else if(ModeNo <= 0x13) {\n      return SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\n   } else {\n      return SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\n   }\n}\n\n \n \n \n\nbool\nSiSDetermineROMLayout661(struct SiS_Private *SiS_Pr)\n{\n   unsigned char  *ROMAddr  = SiS_Pr->VirtualRomBase;\n   unsigned short romversoffs, romvmaj = 1, romvmin = 0;\n\n   if(SiS_Pr->ChipType >= XGI_20) {\n       \n      return false;\n   } else if(SiS_Pr->ChipType >= SIS_761) {\n       \n      return true;\n   } else if(SiS_Pr->ChipType >= SIS_661) {\n      if((ROMAddr[0x1a] == 'N') &&\n\t (ROMAddr[0x1b] == 'e') &&\n\t (ROMAddr[0x1c] == 'w') &&\n\t (ROMAddr[0x1d] == 'V')) {\n\t return true;\n      }\n      romversoffs = ROMAddr[0x16] | (ROMAddr[0x17] << 8);\n      if(romversoffs) {\n\t if((ROMAddr[romversoffs+1] == '.') || (ROMAddr[romversoffs+4] == '.')) {\n\t    romvmaj = ROMAddr[romversoffs] - '0';\n\t    romvmin = ((ROMAddr[romversoffs+2] -'0') * 10) + (ROMAddr[romversoffs+3] - '0');\n\t }\n      }\n      if((romvmaj != 0) || (romvmin >= 92)) {\n\t return true;\n      }\n   } else if(IS_SIS650740) {\n      if((ROMAddr[0x1a] == 'N') &&\n\t (ROMAddr[0x1b] == 'e') &&\n\t (ROMAddr[0x1c] == 'w') &&\n\t (ROMAddr[0x1d] == 'V')) {\n\t return true;\n      }\n   }\n   return false;\n}\n\nstatic void\nSiSDetermineROMUsage(struct SiS_Private *SiS_Pr)\n{\n   unsigned char  *ROMAddr  = SiS_Pr->VirtualRomBase;\n   unsigned short romptr = 0;\n\n   SiS_Pr->SiS_UseROM = false;\n   SiS_Pr->SiS_ROMNew = false;\n   SiS_Pr->SiS_PWDOffset = 0;\n\n   if(SiS_Pr->ChipType >= XGI_20) return;\n\n   if((ROMAddr) && (SiS_Pr->UseROM)) {\n      if(SiS_Pr->ChipType == SIS_300) {\n\t  \n\t if((ROMAddr[3] == 0xe9) && ((ROMAddr[5] << 8) | ROMAddr[4]) > 0x21a)\n\t    SiS_Pr->SiS_UseROM = true;\n      } else if(SiS_Pr->ChipType < SIS_315H) {\n\t  \n\t SiS_Pr->SiS_UseROM = true;\n      } else {\n\t  \n\t SiS_Pr->SiS_UseROM = true;\n\t if((SiS_Pr->SiS_ROMNew = SiSDetermineROMLayout661(SiS_Pr))) {\n\t    SiS_Pr->SiS_EMIOffset = 14;\n\t    SiS_Pr->SiS_PWDOffset = 17;\n\t    SiS_Pr->SiS661LCD2TableSize = 36;\n\t     \n\t    if((romptr = SISGETROMW(0x0102))) {\n\t       if(ROMAddr[romptr + (32 * 16)] == 0xff)\n\t\t  SiS_Pr->SiS661LCD2TableSize = 32;\n\t       else if(ROMAddr[romptr + (34 * 16)] == 0xff)\n\t\t  SiS_Pr->SiS661LCD2TableSize = 34;\n\t       else if(ROMAddr[romptr + (36 * 16)] == 0xff)\t    \n\t\t  SiS_Pr->SiS661LCD2TableSize = 36;\n\t       else if( (ROMAddr[romptr + (38 * 16)] == 0xff) ||    \n\t\t \t(ROMAddr[0x6F] & 0x01) ) {\t\t    \n\t\t  SiS_Pr->SiS661LCD2TableSize = 38;\t\t    \n\t\t  SiS_Pr->SiS_EMIOffset = 16;\n\t\t  SiS_Pr->SiS_PWDOffset = 19;\n\t       }\n\t    }\n\t }\n      }\n   }\n}\n\n \n \n \n\nstatic void\nSiS_SetSegRegLower(struct SiS_Private *SiS_Pr, unsigned short value)\n{\n   unsigned short temp;\n\n   value &= 0x00ff;\n   temp = SiS_GetRegByte(SiS_Pr->SiS_P3cb) & 0xf0;\n   temp |= (value >> 4);\n   SiS_SetRegByte(SiS_Pr->SiS_P3cb, temp);\n   temp = SiS_GetRegByte(SiS_Pr->SiS_P3cd) & 0xf0;\n   temp |= (value & 0x0f);\n   SiS_SetRegByte(SiS_Pr->SiS_P3cd, temp);\n}\n\nstatic void\nSiS_SetSegRegUpper(struct SiS_Private *SiS_Pr, unsigned short value)\n{\n   unsigned short temp;\n\n   value &= 0x00ff;\n   temp = SiS_GetRegByte(SiS_Pr->SiS_P3cb) & 0x0f;\n   temp |= (value & 0xf0);\n   SiS_SetRegByte(SiS_Pr->SiS_P3cb, temp);\n   temp = SiS_GetRegByte(SiS_Pr->SiS_P3cd) & 0x0f;\n   temp |= (value << 4);\n   SiS_SetRegByte(SiS_Pr->SiS_P3cd, temp);\n}\n\nstatic void\nSiS_SetSegmentReg(struct SiS_Private *SiS_Pr, unsigned short value)\n{\n   SiS_SetSegRegLower(SiS_Pr, value);\n   SiS_SetSegRegUpper(SiS_Pr, value);\n}\n\nstatic void\nSiS_ResetSegmentReg(struct SiS_Private *SiS_Pr)\n{\n   SiS_SetSegmentReg(SiS_Pr, 0);\n}\n\nstatic void\nSiS_SetSegmentRegOver(struct SiS_Private *SiS_Pr, unsigned short value)\n{\n   unsigned short temp = value >> 8;\n\n   temp &= 0x07;\n   temp |= (temp << 4);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x1d,temp);\n   SiS_SetSegmentReg(SiS_Pr, value);\n}\n\nstatic void\nSiS_ResetSegmentRegOver(struct SiS_Private *SiS_Pr)\n{\n   SiS_SetSegmentRegOver(SiS_Pr, 0);\n}\n\nstatic void\nSiS_ResetSegmentRegisters(struct SiS_Private *SiS_Pr)\n{\n   if((IS_SIS65x) || (SiS_Pr->ChipType >= SIS_661)) {\n      SiS_ResetSegmentReg(SiS_Pr);\n      SiS_ResetSegmentRegOver(SiS_Pr);\n   }\n}\n\n \n \n \n\nstatic\nvoid\nSiS_GetVBType(struct SiS_Private *SiS_Pr)\n{\n   unsigned short flag = 0, rev = 0, nolcd = 0;\n   unsigned short p4_0f, p4_25, p4_27;\n\n   SiS_Pr->SiS_VBType = 0;\n\n   if((SiS_Pr->SiS_IF_DEF_LVDS) || (SiS_Pr->SiS_IF_DEF_CONEX))\n      return;\n\n   if(SiS_Pr->ChipType == XGI_20)\n      return;\n\n   flag = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x00);\n\n   if(flag > 3)\n      return;\n\n   rev = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x01);\n\n   if(flag >= 2) {\n      SiS_Pr->SiS_VBType = VB_SIS302B;\n   } else if(flag == 1) {\n      if(rev >= 0xC0) {\n\t SiS_Pr->SiS_VBType = VB_SIS301C;\n      } else if(rev >= 0xB0) {\n\t SiS_Pr->SiS_VBType = VB_SIS301B;\n\t  \n\t nolcd = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x23);\n\t if(!(nolcd & 0x02)) SiS_Pr->SiS_VBType |= VB_NoLCD;\n      } else {\n\t SiS_Pr->SiS_VBType = VB_SIS301;\n      }\n   }\n   if(SiS_Pr->SiS_VBType & (VB_SIS301B | VB_SIS301C | VB_SIS302B)) {\n      if(rev >= 0xE0) {\n\t flag = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x39);\n\t if(flag == 0xff) SiS_Pr->SiS_VBType = VB_SIS302LV;\n\t else \t \t  SiS_Pr->SiS_VBType = VB_SIS301C;   \n      } else if(rev >= 0xD0) {\n\t SiS_Pr->SiS_VBType = VB_SIS301LV;\n      }\n   }\n   if(SiS_Pr->SiS_VBType & (VB_SIS301C | VB_SIS301LV | VB_SIS302LV | VB_SIS302ELV)) {\n      p4_0f = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x0f);\n      p4_25 = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x25);\n      p4_27 = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x27);\n      SiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x0f,0x7f);\n      SiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x25,0x08);\n      SiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x27,0xfd);\n      if(SiS_GetReg(SiS_Pr->SiS_Part4Port,0x26) & 0x08) {\n         SiS_Pr->SiS_VBType |= VB_UMC;\n      }\n      SiS_SetReg(SiS_Pr->SiS_Part4Port,0x27,p4_27);\n      SiS_SetReg(SiS_Pr->SiS_Part4Port,0x25,p4_25);\n      SiS_SetReg(SiS_Pr->SiS_Part4Port,0x0f,p4_0f);\n   }\n}\n\n \n \n \n\nstatic bool\nSiS_CheckMemorySize(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex)\n{\n   unsigned short AdapterMemSize = SiS_Pr->VideoMemorySize / (1024*1024);\n   unsigned short modeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\n   unsigned short memorysize = ((modeflag & MemoryInfoFlag) >> MemorySizeShift) + 1;\n\n   if(!AdapterMemSize) return true;\n\n   if(AdapterMemSize < memorysize) return false;\n   return true;\n}\n\n \n \n \n\n#ifdef CONFIG_FB_SIS_315\nstatic unsigned char\nSiS_Get310DRAMType(struct SiS_Private *SiS_Pr)\n{\n   unsigned char data;\n\n   if((*SiS_Pr->pSiS_SoftSetting) & SoftDRAMType) {\n      data = (*SiS_Pr->pSiS_SoftSetting) & 0x03;\n   } else {\n      if(SiS_Pr->ChipType >= XGI_20) {\n          \n\t data = 0;\n      } else if(SiS_Pr->ChipType >= SIS_340) {\n\t  \n\t data = 0;\n      } else if(SiS_Pr->ChipType >= SIS_661) {\n\t if(SiS_Pr->SiS_ROMNew) {\n\t    data = ((SiS_GetReg(SiS_Pr->SiS_P3d4,0x78) & 0xc0) >> 6);\n\t } else {\n\t    data = SiS_GetReg(SiS_Pr->SiS_P3d4,0x78) & 0x07;\n\t }\n      } else if(IS_SIS550650740) {\n\t data = SiS_GetReg(SiS_Pr->SiS_P3c4,0x13) & 0x07;\n      } else {\t \n\t data = SiS_GetReg(SiS_Pr->SiS_P3c4,0x3a) & 0x03;\n\t if(SiS_Pr->ChipType == SIS_330) {\n\t    if(data > 1) {\n\t       switch(SiS_GetReg(SiS_Pr->SiS_P3d4,0x5f) & 0x30) {\n\t       case 0x00: data = 1; break;\n\t       case 0x10: data = 3; break;\n\t       case 0x20: data = 3; break;\n\t       case 0x30: data = 2; break;\n\t       }\n\t    } else {\n\t       data = 0;\n\t    }\n\t }\n      }\n   }\n\n   return data;\n}\n\nstatic unsigned short\nSiS_GetMCLK(struct SiS_Private *SiS_Pr)\n{\n   unsigned char  *ROMAddr = SiS_Pr->VirtualRomBase;\n   unsigned short index;\n\n   index = SiS_Get310DRAMType(SiS_Pr);\n   if(SiS_Pr->ChipType >= SIS_661) {\n      if(SiS_Pr->SiS_ROMNew) {\n\t return((unsigned short)(SISGETROMW((0x90 + (index * 5) + 3))));\n      }\n      return(SiS_Pr->SiS_MCLKData_0[index].CLOCK);\n   } else if(index >= 4) {\n      return(SiS_Pr->SiS_MCLKData_1[index - 4].CLOCK);\n   } else {\n      return(SiS_Pr->SiS_MCLKData_0[index].CLOCK);\n   }\n}\n#endif\n\n \n \n \n\nstatic void\nSiS_ClearBuffer(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\n{\n   unsigned char  SISIOMEMTYPE *memaddr = SiS_Pr->VideoMemoryAddress;\n   unsigned int   memsize = SiS_Pr->VideoMemorySize;\n   unsigned short SISIOMEMTYPE *pBuffer;\n   int i;\n\n   if(!memaddr || !memsize) return;\n\n   if(SiS_Pr->SiS_ModeType >= ModeEGA) {\n      if(ModeNo > 0x13) {\n\t memset_io(memaddr, 0, memsize);\n      } else {\n\t pBuffer = (unsigned short SISIOMEMTYPE *)memaddr;\n\t for(i = 0; i < 0x4000; i++) writew(0x0000, &pBuffer[i]);\n      }\n   } else if(SiS_Pr->SiS_ModeType < ModeCGA) {\n      pBuffer = (unsigned short SISIOMEMTYPE *)memaddr;\n      for(i = 0; i < 0x4000; i++) writew(0x0720, &pBuffer[i]);\n   } else {\n      memset_io(memaddr, 0, 0x8000);\n   }\n}\n\n \n \n \n\nbool\nSiS_SearchModeID(struct SiS_Private *SiS_Pr, unsigned short *ModeNo,\n\t\tunsigned short *ModeIdIndex)\n{\n   unsigned char VGAINFO = SiS_Pr->SiS_VGAINFO;\n\n   if((*ModeNo) <= 0x13) {\n\n      if((*ModeNo) <= 0x05) (*ModeNo) |= 0x01;\n\n      for((*ModeIdIndex) = 0; ;(*ModeIdIndex)++) {\n\t if(SiS_Pr->SiS_SModeIDTable[(*ModeIdIndex)].St_ModeID == (*ModeNo)) break;\n\t if(SiS_Pr->SiS_SModeIDTable[(*ModeIdIndex)].St_ModeID == 0xFF) return false;\n      }\n\n      if((*ModeNo) == 0x07) {\n\t  if(VGAINFO & 0x10) (*ModeIdIndex)++;    \n\t   \n      }\n      if((*ModeNo) <= 0x03) {\n\t if(!(VGAINFO & 0x80)) (*ModeIdIndex)++;\n\t if(VGAINFO & 0x10)    (*ModeIdIndex)++;  \n\t  \n      }\n       \n\n   } else {\n\n      for((*ModeIdIndex) = 0; ;(*ModeIdIndex)++) {\n\t if(SiS_Pr->SiS_EModeIDTable[(*ModeIdIndex)].Ext_ModeID == (*ModeNo)) break;\n\t if(SiS_Pr->SiS_EModeIDTable[(*ModeIdIndex)].Ext_ModeID == 0xFF) return false;\n      }\n\n   }\n   return true;\n}\n\n \n \n \n\nunsigned short\nSiS_GetModePtr(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\n{\n   unsigned short index;\n\n   if(ModeNo <= 0x13) {\n      index = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_StTableIndex;\n   } else {\n      if(SiS_Pr->SiS_ModeType <= ModeEGA) index = 0x1B;\n      else index = 0x0F;\n   }\n   return index;\n}\n\n \n \n \n\nunsigned short\nSiS_GetRefCRTVCLK(struct SiS_Private *SiS_Pr, unsigned short Index, int UseWide)\n{\n   if(SiS_Pr->SiS_RefIndex[Index].Ext_InfoFlag & HaveWideTiming) {\n      if(UseWide == 1) {\n         return SiS_Pr->SiS_RefIndex[Index].Ext_CRTVCLK_WIDE;\n      } else {\n         return SiS_Pr->SiS_RefIndex[Index].Ext_CRTVCLK_NORM;\n      }\n   } else {\n      return SiS_Pr->SiS_RefIndex[Index].Ext_CRTVCLK;\n   }\n}\n\nunsigned short\nSiS_GetRefCRT1CRTC(struct SiS_Private *SiS_Pr, unsigned short Index, int UseWide)\n{\n   if(SiS_Pr->SiS_RefIndex[Index].Ext_InfoFlag & HaveWideTiming) {\n      if(UseWide == 1) {\n         return SiS_Pr->SiS_RefIndex[Index].Ext_CRT1CRTC_WIDE;\n      } else {\n         return SiS_Pr->SiS_RefIndex[Index].Ext_CRT1CRTC_NORM;\n      }\n   } else {\n      return SiS_Pr->SiS_RefIndex[Index].Ext_CRT1CRTC;\n   }\n}\n\n \n \n \n\nstatic bool\nSiS_DoLowModeTest(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\n{\n   unsigned short temp, temp1, temp2;\n\n   if((ModeNo != 0x03) && (ModeNo != 0x10) && (ModeNo != 0x12))\n      return true;\n   temp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x11);\n   SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x11,0x80);\n   temp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x00);\n   SiS_SetReg(SiS_Pr->SiS_P3d4,0x00,0x55);\n   temp2 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x00);\n   SiS_SetReg(SiS_Pr->SiS_P3d4,0x00,temp1);\n   SiS_SetReg(SiS_Pr->SiS_P3d4,0x11,temp);\n   if((SiS_Pr->ChipType >= SIS_315H) ||\n      (SiS_Pr->ChipType == SIS_300)) {\n      if(temp2 == 0x55) return false;\n      else return true;\n   } else {\n      if(temp2 != 0x55) return true;\n      else {\n\t SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x35,0x01);\n\t return false;\n      }\n   }\n}\n\nstatic void\nSiS_SetLowModeTest(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\n{\n   if(SiS_DoLowModeTest(SiS_Pr, ModeNo)) {\n      SiS_Pr->SiS_SetFlag |= LowModeTests;\n   }\n}\n\n \n \n \n\nstatic void\nSiS_OpenCRTC(struct SiS_Private *SiS_Pr)\n{\n   if(IS_SIS650) {\n      SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x51,0x1f);\n      if(IS_SIS651) SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x51,0x20);\n      SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x56,0xe7);\n   } else if(IS_SIS661741660760) {\n      SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x61,0xf7);\n      SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x51,0x1f);\n      SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x56,0xe7);\n      if(!SiS_Pr->SiS_ROMNew) {\n\t SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x3a,0xef);\n      }\n   }\n}\n\nstatic void\nSiS_CloseCRTC(struct SiS_Private *SiS_Pr)\n{\n#if 0  \n   unsigned short temp1 = 0, temp2 = 0;\n\n   if(IS_SIS661741660760) {\n      if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\n         temp1 = 0xa0; temp2 = 0x08;\n      }\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x51,0x1f,temp1);\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x56,0xe7,temp2);\n   }\n#endif\n}\n\nstatic void\nSiS_HandleCRT1(struct SiS_Private *SiS_Pr)\n{\n    \n   SiS_SetRegAND(SiS_Pr->SiS_P3d4,SiS_Pr->SiS_MyCR63,0xbf);\n#if 0\n   if(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x15) & 0x01)) {\n      if((SiS_GetReg(SiS_Pr->SiS_P3c4,0x15) & 0x0a) ||\n         (SiS_GetReg(SiS_Pr->SiS_P3c4,0x16) & 0x01)) {\n         SiS_SetRegOR(SiS_Pr->SiS_P3d4,SiS_Pr->SiS_MyCR63,0x40);\n      }\n   }\n#endif\n}\n\n \n \n \n\nunsigned short\nSiS_GetColorDepth(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex)\n{\n   static const unsigned short ColorDepth[6] = { 1, 2, 4, 4, 6, 8 };\n   unsigned short modeflag;\n   short index;\n\n    \n   if(ModeNo == 0xfe) {\n      modeflag = SiS_Pr->CModeFlag;\n   } else if(ModeNo <= 0x13) {\n      modeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\n   } else {\n      modeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\n   }\n\n   index = (modeflag & ModeTypeMask) - ModeEGA;\n   if(index < 0) index = 0;\n   return ColorDepth[index];\n}\n\n \n \n \n\nunsigned short\nSiS_GetOffset(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex, unsigned short RRTI)\n{\n   unsigned short xres, temp, colordepth, infoflag;\n\n   if(SiS_Pr->UseCustomMode) {\n      infoflag = SiS_Pr->CInfoFlag;\n      xres = SiS_Pr->CHDisplay;\n   } else {\n      infoflag = SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag;\n      xres = SiS_Pr->SiS_RefIndex[RRTI].XRes;\n   }\n\n   colordepth = SiS_GetColorDepth(SiS_Pr, ModeNo, ModeIdIndex);\n\n   temp = xres / 16;\n   if(infoflag & InterlaceMode) temp <<= 1;\n   temp *= colordepth;\n   if(xres % 16) temp += (colordepth >> 1);\n\n   return temp;\n}\n\n \n \n \n\nstatic void\nSiS_SetSeqRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\n{\n   unsigned char SRdata;\n   int i;\n\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x00,0x03);\n\n    \n   SRdata = SiS_Pr->SiS_StandTable[StandTableIndex].SR[0] | 0x20;\n\n    \n   if((SiS_Pr->SiS_VBType & VB_SISVB) || (SiS_Pr->SiS_IF_DEF_LVDS)) {\n\n      if(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToTV)) {\n         if(SiS_Pr->SiS_VBInfo & SetInSlaveMode)    SRdata |= 0x01;\n      } else if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) SRdata |= 0x01;\n\n   }\n\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x01,SRdata);\n\n   for(i = 2; i <= 4; i++) {\n      SRdata = SiS_Pr->SiS_StandTable[StandTableIndex].SR[i - 1];\n      SiS_SetReg(SiS_Pr->SiS_P3c4,i,SRdata);\n   }\n}\n\n \n \n \n\nstatic void\nSiS_SetMiscRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\n{\n   unsigned char Miscdata;\n\n   Miscdata = SiS_Pr->SiS_StandTable[StandTableIndex].MISC;\n\n   if(SiS_Pr->ChipType < SIS_661) {\n      if(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\n\t if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\n\t   Miscdata |= 0x0C;\n\t }\n      }\n   }\n\n   SiS_SetRegByte(SiS_Pr->SiS_P3c2,Miscdata);\n}\n\n \n \n \n\nstatic void\nSiS_SetCRTCRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\n{\n   unsigned char  CRTCdata;\n   unsigned short i;\n\n    \n   SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x11,0x7f);\n\n   for(i = 0; i <= 0x18; i++) {\n      CRTCdata = SiS_Pr->SiS_StandTable[StandTableIndex].CRTC[i];\n      SiS_SetReg(SiS_Pr->SiS_P3d4,i,CRTCdata);\n   }\n\n   if(SiS_Pr->ChipType >= SIS_661) {\n      SiS_OpenCRTC(SiS_Pr);\n      for(i = 0x13; i <= 0x14; i++) {\n\t CRTCdata = SiS_Pr->SiS_StandTable[StandTableIndex].CRTC[i];\n\t SiS_SetReg(SiS_Pr->SiS_P3d4,i,CRTCdata);\n      }\n   } else if( ( (SiS_Pr->ChipType == SIS_630) ||\n\t        (SiS_Pr->ChipType == SIS_730) )  &&\n\t      (SiS_Pr->ChipRevision >= 0x30) ) {\n      if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\n\t if(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToTV)) {\n\t    SiS_SetReg(SiS_Pr->SiS_P3d4,0x18,0xFE);\n\t }\n      }\n   }\n}\n\n \n \n \n\nstatic void\nSiS_SetATTRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\n{\n   unsigned char  ARdata;\n   unsigned short i;\n\n   for(i = 0; i <= 0x13; i++) {\n      ARdata = SiS_Pr->SiS_StandTable[StandTableIndex].ATTR[i];\n\n      if(i == 0x13) {\n\t  \n\t if(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\n\t    if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) ARdata = 0;\n\t }\n\t if(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\n\t    if(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\n\t       if(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\n\t\t  if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) ARdata = 0;\n\t       }\n\t    }\n\t }\n\t if(SiS_Pr->ChipType >= SIS_661) {\n\t    if(SiS_Pr->SiS_VBInfo & (SetCRT2ToTV | SetCRT2ToLCD)) {\n\t       if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) ARdata = 0;\n\t    }\n\t } else if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\n\t    if(SiS_Pr->ChipType >= SIS_315H) {\n\t       if(IS_SIS550650740660) {\n\t\t   \n\t\t  if(SiS_Pr->SiS_VBType & VB_SIS30xB) {\n\t\t     if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) ARdata = 0;\n\t\t  } else {\n\t\t     ARdata = 0;\n\t\t  }\n\t       }\n\t    } else {\n\t       if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) ARdata = 0;\n\t    }\n\t }\n      }\n      SiS_GetRegByte(SiS_Pr->SiS_P3da);\t\t \n      SiS_SetRegByte(SiS_Pr->SiS_P3c0,i);\t \n      SiS_SetRegByte(SiS_Pr->SiS_P3c0,ARdata);\t \n   }\n\n   SiS_GetRegByte(SiS_Pr->SiS_P3da);\t\t \n   SiS_SetRegByte(SiS_Pr->SiS_P3c0,0x14);\t \n   SiS_SetRegByte(SiS_Pr->SiS_P3c0,0x00);\t \n\n   SiS_GetRegByte(SiS_Pr->SiS_P3da);\n   SiS_SetRegByte(SiS_Pr->SiS_P3c0,0x20);\t \n   SiS_GetRegByte(SiS_Pr->SiS_P3da);\n}\n\n \n \n \n\nstatic void\nSiS_SetGRCRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\n{\n   unsigned char  GRdata;\n   unsigned short i;\n\n   for(i = 0; i <= 0x08; i++) {\n      GRdata = SiS_Pr->SiS_StandTable[StandTableIndex].GRC[i];\n      SiS_SetReg(SiS_Pr->SiS_P3ce,i,GRdata);\n   }\n\n   if(SiS_Pr->SiS_ModeType > ModeVGA) {\n       \n      SiS_SetRegAND(SiS_Pr->SiS_P3ce,0x05,0xBF);\n   }\n}\n\n \n \n \n\nstatic void\nSiS_ClearExt1Regs(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\n{\n   unsigned short i;\n\n   for(i = 0x0A; i <= 0x0E; i++) {\n      SiS_SetReg(SiS_Pr->SiS_P3c4,i,0x00);\n   }\n\n   if(SiS_Pr->ChipType >= SIS_315H) {\n      SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x37,0xFE);\n      if(ModeNo <= 0x13) {\n\t if(ModeNo == 0x06 || ModeNo >= 0x0e) {\n\t    SiS_SetReg(SiS_Pr->SiS_P3c4,0x0e,0x20);\n\t }\n      }\n   }\n}\n\n \n \n \n\nstatic void\nSiS_ResetCRT1VCLK(struct SiS_Private *SiS_Pr)\n{\n   if(SiS_Pr->ChipType >= SIS_315H) {\n      if(SiS_Pr->ChipType < SIS_661) {\n\t if(SiS_Pr->SiS_IF_DEF_LVDS == 0) return;\n      }\n   } else {\n      if((SiS_Pr->SiS_IF_DEF_LVDS == 0) &&\n\t (!(SiS_Pr->SiS_VBType & VB_SIS30xBLV)) ) {\n\t return;\n      }\n   }\n\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x31,0xcf,0x20);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2B,SiS_Pr->SiS_VCLKData[1].SR2B);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2C,SiS_Pr->SiS_VCLKData[1].SR2C);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2D,0x80);\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x31,0xcf,0x10);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2B,SiS_Pr->SiS_VCLKData[0].SR2B);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2C,SiS_Pr->SiS_VCLKData[0].SR2C);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2D,0x80);\n}\n\n \n \n \n\nstatic void\nSiS_SetCRT1Sync(struct SiS_Private *SiS_Pr, unsigned short RRTI)\n{\n   unsigned short sync;\n\n   if(SiS_Pr->UseCustomMode) {\n      sync = SiS_Pr->CInfoFlag >> 8;\n   } else {\n      sync = SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag >> 8;\n   }\n\n   sync &= 0xC0;\n   sync |= 0x2f;\n   SiS_SetRegByte(SiS_Pr->SiS_P3c2,sync);\n}\n\n \n \n \n\nstatic void\nSiS_SetCRT1CRTC(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex, unsigned short RRTI)\n{\n   unsigned short temp, i, j, modeflag;\n   unsigned char  *crt1data = NULL;\n\n   modeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\n\n   if(SiS_Pr->UseCustomMode) {\n\n      crt1data = &SiS_Pr->CCRT1CRTC[0];\n\n   } else {\n\n      temp = SiS_GetRefCRT1CRTC(SiS_Pr, RRTI, SiS_Pr->SiS_UseWide);\n\n       \n      if((temp == 0x20) && (SiS_Pr->Alternate1600x1200)) temp = 0x57;\n\n      crt1data = (unsigned char *)&SiS_Pr->SiS_CRT1Table[temp].CR[0];\n\n   }\n\n    \n   SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x11,0x7f);\n\n   for(i = 0, j = 0; i <= 7; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,j,crt1data[i]);\n   }\n   for(j = 0x10; i <= 10; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,j,crt1data[i]);\n   }\n   for(j = 0x15; i <= 12; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,j,crt1data[i]);\n   }\n   for(j = 0x0A; i <= 15; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3c4,j,crt1data[i]);\n   }\n\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x0E,crt1data[16] & 0xE0);\n\n   temp = (crt1data[16] & 0x01) << 5;\n   if(modeflag & DoubleScanMode) temp |= 0x80;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x09,0x5F,temp);\n\n   if(SiS_Pr->SiS_ModeType > ModeVGA) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,0x14,0x4F);\n   }\n\n#ifdef CONFIG_FB_SIS_315\n   if(SiS_Pr->ChipType == XGI_20) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,0x04,crt1data[4] - 1);\n      if(!(temp = crt1data[5] & 0x1f)) {\n         SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x0c,0xfb);\n      }\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x05,0xe0,((temp - 1) & 0x1f));\n      temp = (crt1data[16] >> 5) + 3;\n      if(temp > 7) temp -= 7;\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0e,0x1f,(temp << 5));\n   }\n#endif\n}\n\n \n \n \n \n \n\nstatic void\nSiS_SetCRT1Offset(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex, unsigned short RRTI)\n{\n   unsigned short temp, DisplayUnit, infoflag;\n\n   if(SiS_Pr->UseCustomMode) {\n      infoflag = SiS_Pr->CInfoFlag;\n   } else {\n      infoflag = SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag;\n   }\n\n   DisplayUnit = SiS_GetOffset(SiS_Pr, ModeNo, ModeIdIndex, RRTI);\n\n   temp = (DisplayUnit >> 8) & 0x0f;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0E,0xF0,temp);\n\n   SiS_SetReg(SiS_Pr->SiS_P3d4,0x13,DisplayUnit & 0xFF);\n\n   if(infoflag & InterlaceMode) DisplayUnit >>= 1;\n\n   DisplayUnit <<= 5;\n   temp = (DisplayUnit >> 8) + 1;\n   if(DisplayUnit & 0xff) temp++;\n   if(SiS_Pr->ChipType == XGI_20) {\n      if(ModeNo == 0x4a || ModeNo == 0x49) temp--;\n   }\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x10,temp);\n}\n\n \n \n \n\nstatic void\nSiS_SetCRT1VCLK(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex, unsigned short RRTI)\n{\n   unsigned short index = 0, clka, clkb;\n\n   if(SiS_Pr->UseCustomMode) {\n      clka = SiS_Pr->CSR2B;\n      clkb = SiS_Pr->CSR2C;\n   } else {\n      index = SiS_GetVCLK2Ptr(SiS_Pr, ModeNo, ModeIdIndex, RRTI);\n      if((SiS_Pr->SiS_VBType & VB_SIS30xBLV) &&\n\t (SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\n\t  \n\t if((index == 0x21) && (SiS_Pr->Alternate1600x1200)) index = 0x72;\n\t clka = SiS_Pr->SiS_VBVCLKData[index].Part4_A;\n\t clkb = SiS_Pr->SiS_VBVCLKData[index].Part4_B;\n      } else {\n\t clka = SiS_Pr->SiS_VCLKData[index].SR2B;\n\t clkb = SiS_Pr->SiS_VCLKData[index].SR2C;\n      }\n   }\n\n   SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x31,0xCF);\n\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2b,clka);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x2c,clkb);\n\n   if(SiS_Pr->ChipType >= SIS_315H) {\n#ifdef CONFIG_FB_SIS_315\n      SiS_SetReg(SiS_Pr->SiS_P3c4,0x2D,0x01);\n      if(SiS_Pr->ChipType == XGI_20) {\n         unsigned short mf = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\n\t if(mf & HalfDCLK) {\n\t    SiS_SetReg(SiS_Pr->SiS_P3c4,0x2b,SiS_GetReg(SiS_Pr->SiS_P3c4,0x2b));\n\t    clkb = SiS_GetReg(SiS_Pr->SiS_P3c4,0x2c);\n\t    clkb = (((clkb & 0x1f) << 1) + 1) | (clkb & 0xe0);\n\t    SiS_SetReg(SiS_Pr->SiS_P3c4,0x2c,clkb);\n\t }\n      }\n#endif\n   } else {\n      SiS_SetReg(SiS_Pr->SiS_P3c4,0x2D,0x80);\n   }\n}\n\n \n \n \n\n#ifdef CONFIG_FB_SIS_300\nvoid\nSiS_GetFIFOThresholdIndex300(struct SiS_Private *SiS_Pr, unsigned short *idx1,\n\t\tunsigned short *idx2)\n{\n   unsigned short temp1, temp2;\n   static const unsigned char ThTiming[8] = {\n\t\t1, 2, 2, 3, 0, 1, 1, 2\n   };\n\n   temp1 = temp2 = (SiS_GetReg(SiS_Pr->SiS_P3c4,0x18) & 0x62) >> 1;\n   (*idx2) = (unsigned short)(ThTiming[((temp2 >> 3) | temp1) & 0x07]);\n   (*idx1) = (unsigned short)(SiS_GetReg(SiS_Pr->SiS_P3c4,0x16) >> 6) & 0x03;\n   (*idx1) |= (unsigned short)(((SiS_GetReg(SiS_Pr->SiS_P3c4,0x14) >> 4) & 0x0c));\n   (*idx1) <<= 1;\n}\n\nstatic unsigned short\nSiS_GetFIFOThresholdA300(unsigned short idx1, unsigned short idx2)\n{\n   static const unsigned char ThLowA[8 * 3] = {\n\t\t61, 3,52, 5,68, 7,100,11,\n\t\t43, 3,42, 5,54, 7, 78,11,\n\t\t34, 3,37, 5,47, 7, 67,11\n   };\n\n   return (unsigned short)((ThLowA[idx1 + 1] * idx2) + ThLowA[idx1]);\n}\n\nunsigned short\nSiS_GetFIFOThresholdB300(unsigned short idx1, unsigned short idx2)\n{\n   static const unsigned char ThLowB[8 * 3] = {\n\t\t81, 4,72, 6,88, 8,120,12,\n\t\t55, 4,54, 6,66, 8, 90,12,\n\t\t42, 4,45, 6,55, 8, 75,12\n   };\n\n   return (unsigned short)((ThLowB[idx1 + 1] * idx2) + ThLowB[idx1]);\n}\n\nstatic unsigned short\nSiS_DoCalcDelay(struct SiS_Private *SiS_Pr, unsigned short MCLK, unsigned short VCLK,\n\t\tunsigned short colordepth, unsigned short key)\n{\n   unsigned short idx1, idx2;\n   unsigned int   longtemp = VCLK * colordepth;\n\n   SiS_GetFIFOThresholdIndex300(SiS_Pr, &idx1, &idx2);\n\n   if(key == 0) {\n      longtemp *= SiS_GetFIFOThresholdA300(idx1, idx2);\n   } else {\n      longtemp *= SiS_GetFIFOThresholdB300(idx1, idx2);\n   }\n   idx1 = longtemp % (MCLK * 16);\n   longtemp /= (MCLK * 16);\n   if(idx1) longtemp++;\n   return (unsigned short)longtemp;\n}\n\nstatic unsigned short\nSiS_CalcDelay(struct SiS_Private *SiS_Pr, unsigned short VCLK,\n\t\tunsigned short colordepth, unsigned short MCLK)\n{\n   unsigned short temp1, temp2;\n\n   temp2 = SiS_DoCalcDelay(SiS_Pr, MCLK, VCLK, colordepth, 0);\n   temp1 = SiS_DoCalcDelay(SiS_Pr, MCLK, VCLK, colordepth, 1);\n   if(temp1 < 4) temp1 = 4;\n   temp1 -= 4;\n   if(temp2 < temp1) temp2 = temp1;\n   return temp2;\n}\n\nstatic void\nSiS_SetCRT1FIFO_300(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short RefreshRateTableIndex)\n{\n   unsigned short ThresholdLow = 0;\n   unsigned short temp, index, VCLK, MCLK, colorth;\n   static const unsigned short colortharray[6] = { 1, 1, 2, 2, 3, 4 };\n\n   if(ModeNo > 0x13) {\n\n       \n      if(SiS_Pr->UseCustomMode) {\n\t VCLK = SiS_Pr->CSRClock;\n      } else {\n\t index = SiS_GetRefCRTVCLK(SiS_Pr, RefreshRateTableIndex, SiS_Pr->SiS_UseWide);\n\t VCLK = SiS_Pr->SiS_VCLKData[index].CLOCK;\n      }\n\n       \n      colorth = colortharray[(SiS_Pr->SiS_ModeType - ModeEGA)];\n\n       \n      index = SiS_GetReg(SiS_Pr->SiS_P3c4,0x3A) & 0x07;\n      MCLK = SiS_Pr->SiS_MCLKData_0[index].CLOCK;\n\n      temp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x35) & 0xc3;\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x16,0x3c,temp);\n\n      do {\n\t ThresholdLow = SiS_CalcDelay(SiS_Pr, VCLK, colorth, MCLK) + 1;\n\t if(ThresholdLow < 0x13) break;\n\t SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x16,0xfc);\n\t ThresholdLow = 0x13;\n\t temp = SiS_GetReg(SiS_Pr->SiS_P3c4,0x16) >> 6;\n\t if(!temp) break;\n\t SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x16,0x3f,((temp - 1) << 6));\n      } while(0);\n\n   } else ThresholdLow = 2;\n\n    \n   temp = (ThresholdLow << 4) | 0x0f;\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x08,temp);\n\n   temp = (ThresholdLow & 0x10) << 1;\n   if(ModeNo > 0x13) temp |= 0x40;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0f,0x9f,temp);\n\n    \n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x3B,0x09);\n\n    \n   temp = ThresholdLow + 3;\n   if(temp > 0x0f) temp = 0x0f;\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x09,temp);\n}\n\nunsigned short\nSiS_GetLatencyFactor630(struct SiS_Private *SiS_Pr, unsigned short index)\n{\n   static const unsigned char LatencyFactor[] = {\n\t\t97, 88, 86, 79, 77,  0,        \n\t\t 0, 87, 85, 78, 76, 54,        \n\t\t97, 88, 86, 79, 77,  0,        \n\t\t 0, 79, 77, 70, 68, 48,        \n\t\t80, 72, 69, 63, 61,  0,        \n\t\t 0, 70, 68, 61, 59, 37,        \n\t\t86, 77, 75, 68, 66,  0,        \n\t\t 0, 68, 66, 59, 57, 37         \n   };\n   static const unsigned char LatencyFactor730[] = {\n\t\t 69, 63, 61,\n\t\t 86, 79, 77,\n\t\t103, 96, 94,\n\t\t120,113,111,\n\t\t137,130,128\n   };\n\n   if(SiS_Pr->ChipType == SIS_730) {\n      return (unsigned short)LatencyFactor730[index];\n   } else {\n      return (unsigned short)LatencyFactor[index];\n   }\n}\n\nstatic unsigned short\nSiS_CalcDelay2(struct SiS_Private *SiS_Pr, unsigned char key)\n{\n   unsigned short index;\n\n   if(SiS_Pr->ChipType == SIS_730) {\n      index = ((key & 0x0f) * 3) + ((key & 0xc0) >> 6);\n   } else {\n      index = (key & 0xe0) >> 5;\n      if(key & 0x10)    index +=  6;\n      if(!(key & 0x01)) index += 24;\n      if(SiS_GetReg(SiS_Pr->SiS_P3c4,0x14) & 0x80) index += 12;\n   }\n   return SiS_GetLatencyFactor630(SiS_Pr, index);\n}\n\nstatic void\nSiS_SetCRT1FIFO_630(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n                    unsigned short RefreshRateTableIndex)\n{\n   unsigned short  ThresholdLow = 0;\n   unsigned short  i, data, VCLK, MCLK16, colorth = 0;\n   unsigned int    templ, datal;\n   const unsigned char *queuedata = NULL;\n   static const unsigned char FQBQData[21] = {\n\t\t0x01,0x21,0x41,0x61,0x81,\n\t\t0x31,0x51,0x71,0x91,0xb1,\n\t\t0x00,0x20,0x40,0x60,0x80,\n\t\t0x30,0x50,0x70,0x90,0xb0,\n\t\t0xff\n   };\n   static const unsigned char FQBQData730[16] = {\n\t\t0x34,0x74,0xb4,\n\t\t0x23,0x63,0xa3,\n\t\t0x12,0x52,0x92,\n\t\t0x01,0x41,0x81,\n\t\t0x00,0x40,0x80,\n\t\t0xff\n   };\n   static const unsigned short colortharray[6] = {\n\t\t1, 1, 2, 2, 3, 4\n   };\n\n   i = 0;\n\n\tif (SiS_Pr->ChipType == SIS_730)\n\t\tqueuedata = &FQBQData730[0];\n\telse\n\t\tqueuedata = &FQBQData[0];\n\n   if(ModeNo > 0x13) {\n\n       \n      if(SiS_Pr->UseCustomMode) {\n\t VCLK = SiS_Pr->CSRClock;\n      } else {\n\t data = SiS_GetRefCRTVCLK(SiS_Pr, RefreshRateTableIndex, SiS_Pr->SiS_UseWide);\n\t VCLK = SiS_Pr->SiS_VCLKData[data].CLOCK;\n      }\n\n       \n      data = SiS_GetReg(SiS_Pr->SiS_P3c4,0x1A) & 0x07;\n      MCLK16 = SiS_Pr->SiS_MCLKData_0[data].CLOCK * 16;\n\n       \n      colorth = colortharray[(SiS_Pr->SiS_ModeType - ModeEGA)];\n\n      do {\n\t templ = SiS_CalcDelay2(SiS_Pr, queuedata[i]) * VCLK * colorth;\n\n\t datal = templ % MCLK16;\n\t templ = (templ / MCLK16) + 1;\n\t if(datal) templ++;\n\n\t if(templ > 0x13) {\n\t    if(queuedata[i + 1] == 0xFF) {\n\t       ThresholdLow = 0x13;\n\t       break;\n\t    }\n\t    i++;\n\t } else {\n\t    ThresholdLow = templ;\n\t    break;\n\t }\n      } while(queuedata[i] != 0xFF);\n\n   } else {\n\n      if(SiS_Pr->ChipType != SIS_730) i = 9;\n      ThresholdLow = 0x02;\n\n   }\n\n    \n   data = ((ThresholdLow & 0x0f) << 4) | 0x0f;\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x08,data);\n\n   data = (ThresholdLow & 0x10) << 1;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0F,0xDF,data);\n\n    \n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x3B,0x09);\n\n    \n   data = ThresholdLow + 3;\n   if(data > 0x0f) data = 0x0f;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x09,0x80,data);\n\n   \n   templ = sisfb_read_nbridge_pci_dword(SiS_Pr, 0x50);\n\n   if(SiS_Pr->ChipType == SIS_730) {\n\n      templ &= 0xfffff9ff;\n      templ |= ((queuedata[i] & 0xc0) << 3);\n\n   } else {\n\n      templ &= 0xf0ffffff;\n      if( (ModeNo <= 0x13) &&\n          (SiS_Pr->ChipType == SIS_630) &&\n\t  (SiS_Pr->ChipRevision >= 0x30) ) {\n\t templ |= 0x0b000000;\n      } else {\n         templ |= ((queuedata[i] & 0xf0) << 20);\n      }\n\n   }\n\n   sisfb_write_nbridge_pci_dword(SiS_Pr, 0x50, templ);\n   templ = sisfb_read_nbridge_pci_dword(SiS_Pr, 0xA0);\n\n    \n   if(SiS_Pr->ChipType == SIS_730) {\n\n      templ &= 0x00ffffff;\n      datal = queuedata[i] << 8;\n      templ |= (((datal & 0x0f00) | ((datal & 0x3000) >> 8)) << 20);\n\n   } else {\n\n      templ &= 0xf0ffffff;\n      templ |= ((queuedata[i] & 0x0f) << 24);\n\n   }\n\n   sisfb_write_nbridge_pci_dword(SiS_Pr, 0xA0, templ);\n}\n#endif  \n\n#ifdef CONFIG_FB_SIS_315\nstatic void\nSiS_SetCRT1FIFO_310(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\n{\n   unsigned short modeflag;\n\n    \n   SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x3D,0xFE);\n\n   modeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\n\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x08,0xAE);\n   SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x09,0xF0);\n   if(ModeNo > 0x13) {\n      if(SiS_Pr->ChipType >= XGI_20) {\n\t SiS_SetReg(SiS_Pr->SiS_P3c4,0x08,0x34);\n\t SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x3D,0x01);\n      } else if(SiS_Pr->ChipType >= SIS_661) {\n\t if(!(modeflag & HalfDCLK)) {\n\t    SiS_SetReg(SiS_Pr->SiS_P3c4,0x08,0x34);\n\t    SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x3D,0x01);\n\t }\n      } else {\n\t if((!(modeflag & DoubleScanMode)) || (!(modeflag & HalfDCLK))) {\n\t    SiS_SetReg(SiS_Pr->SiS_P3c4,0x08,0x34);\n\t    SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x3D,0x01);\n\t }\n      }\n   }\n}\n#endif\n\n \n \n \n\nstatic void\nSiS_SetVCLKState(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short RefreshRateTableIndex, unsigned short ModeIdIndex)\n{\n   unsigned short data = 0, VCLK = 0, index = 0;\n\n   if(ModeNo > 0x13) {\n      if(SiS_Pr->UseCustomMode) {\n         VCLK = SiS_Pr->CSRClock;\n      } else {\n         index = SiS_GetVCLK2Ptr(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\n         VCLK = SiS_Pr->SiS_VCLKData[index].CLOCK;\n      }\n   }\n\n   if(SiS_Pr->ChipType < SIS_315H) {\n#ifdef CONFIG_FB_SIS_300\n      if(VCLK > 150) data |= 0x80;\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x07,0x7B,data);\n\n      data = 0x00;\n      if(VCLK >= 150) data |= 0x08;\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x32,0xF7,data);\n#endif\n   } else if(SiS_Pr->ChipType < XGI_20) {\n#ifdef CONFIG_FB_SIS_315\n      if(VCLK >= 166) data |= 0x0c;\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x32,0xf3,data);\n\n      if(VCLK >= 166) {\n         SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1f,0xe7);\n      }\n#endif\n   } else {\n#ifdef CONFIG_FB_SIS_315\n      if(VCLK >= 200) data |= 0x0c;\n      if(SiS_Pr->ChipType == XGI_20) data &= ~0x04;\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x32,0xf3,data);\n      if(SiS_Pr->ChipType != XGI_20) {\n         data = SiS_GetReg(SiS_Pr->SiS_P3c4,0x1f) & 0xe7;\n\t if(VCLK < 200) data |= 0x10;\n\t SiS_SetReg(SiS_Pr->SiS_P3c4,0x1f,data);\n      }\n#endif\n   }\n\n    \n   if(SiS_Pr->ChipType >= SIS_661) {\n\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x07,0xE8,0x10);\n\n   } else {\n\n      data = 0x03;\n      if(VCLK >= 260)      data = 0x00;\n      else if(VCLK >= 160) data = 0x01;\n      else if(VCLK >= 135) data = 0x02;\n\n      if(SiS_Pr->ChipType == SIS_540) {\n          \n         if (VCLK < 234) data = 0x02;\n      }\n\n      if(SiS_Pr->ChipType < SIS_315H) {\n         SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x07,0xFC,data);\n      } else {\n         if(SiS_Pr->ChipType > SIS_315PRO) {\n            if(ModeNo > 0x13) data &= 0xfc;\n         }\n         SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x07,0xF8,data);\n      }\n\n   }\n}\n\nstatic void\nSiS_SetCRT1ModeRegs(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex, unsigned short RRTI)\n{\n   unsigned short data, infoflag = 0, modeflag;\n#ifdef CONFIG_FB_SIS_315\n   unsigned char  *ROMAddr  = SiS_Pr->VirtualRomBase;\n   unsigned short data2, data3;\n#endif\n\n   modeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\n\n   if(SiS_Pr->UseCustomMode) {\n      infoflag = SiS_Pr->CInfoFlag;\n   } else {\n      if(ModeNo > 0x13) {\n\t infoflag = SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag;\n      }\n   }\n\n    \n   SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1F,0x3F);\n\n   data = 0;\n   if(ModeNo > 0x13) {\n      if(SiS_Pr->SiS_ModeType > ModeEGA) {\n         data |= 0x02;\n         data |= ((SiS_Pr->SiS_ModeType - ModeVGA) << 2);\n      }\n      if(infoflag & InterlaceMode) data |= 0x20;\n   }\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x06,0xC0,data);\n\n   if(SiS_Pr->ChipType != SIS_300) {\n      data = 0;\n      if(infoflag & InterlaceMode) {\n\t  \n\t int hrs = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x04) |\n\t\t    ((SiS_GetReg(SiS_Pr->SiS_P3c4,0x0b) & 0xc0) << 2)) - 3;\n\t int hto = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x00) |\n\t\t    ((SiS_GetReg(SiS_Pr->SiS_P3c4,0x0b) & 0x03) << 8)) + 5;\n\t data = hrs - (hto >> 1) + 3;\n      }\n      SiS_SetReg(SiS_Pr->SiS_P3d4,0x19,data);\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x1a,0xFC,((data >> 8) & 0x03));\n   }\n\n   if(modeflag & HalfDCLK) {\n      SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x01,0x08);\n   }\n\n   data = 0;\n   if(modeflag & LineCompareOff) data = 0x08;\n   if(SiS_Pr->ChipType == SIS_300) {\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0F,0xF7,data);\n   } else {\n      if(SiS_Pr->ChipType >= XGI_20) data |= 0x20;\n      if(SiS_Pr->SiS_ModeType == ModeEGA) {\n\t if(ModeNo > 0x13) {\n\t    data |= 0x40;\n\t }\n      }\n      SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0F,0xB7,data);\n   }\n\n#ifdef CONFIG_FB_SIS_315\n   if(SiS_Pr->ChipType >= SIS_315H) {\n      SiS_SetRegAND(SiS_Pr->SiS_P3c4,0x31,0xfb);\n   }\n\n   if(SiS_Pr->ChipType == SIS_315PRO) {\n\n      data = SiS_Pr->SiS_SR15[(2 * 4) + SiS_Get310DRAMType(SiS_Pr)];\n      if(SiS_Pr->SiS_ModeType == ModeText) {\n\t data &= 0xc7;\n      } else {\n\t data2 = SiS_GetOffset(SiS_Pr, ModeNo, ModeIdIndex, RRTI) >> 1;\n\t if(infoflag & InterlaceMode) data2 >>= 1;\n\t data3 = SiS_GetColorDepth(SiS_Pr, ModeNo, ModeIdIndex) >> 1;\n\t if(data3) data2 /= data3;\n\t if(data2 >= 0x50) {\n\t    data &= 0x0f;\n\t    data |= 0x50;\n\t }\n      }\n      SiS_SetReg(SiS_Pr->SiS_P3c4,0x17,data);\n\n   } else if((SiS_Pr->ChipType == SIS_330) || (SiS_Pr->SiS_SysFlags & SF_760LFB)) {\n\n      data = SiS_Get310DRAMType(SiS_Pr);\n      if(SiS_Pr->ChipType == SIS_330) {\n\t data = SiS_Pr->SiS_SR15[(2 * 4) + data];\n      } else {\n\t if(SiS_Pr->SiS_ROMNew)\t     data = ROMAddr[0xf6];\n\t else if(SiS_Pr->SiS_UseROM) data = ROMAddr[0x100 + data];\n\t else\t\t\t     data = 0xba;\n      }\n      if(SiS_Pr->SiS_ModeType <= ModeEGA) {\n\t data &= 0xc7;\n      } else {\n\t if(SiS_Pr->UseCustomMode) {\n\t    data2 = SiS_Pr->CSRClock;\n\t } else {\n\t    data2 = SiS_GetVCLK2Ptr(SiS_Pr, ModeNo, ModeIdIndex, RRTI);\n\t    data2 = SiS_Pr->SiS_VCLKData[data2].CLOCK;\n\t }\n\n\t data3 = SiS_GetColorDepth(SiS_Pr, ModeNo, ModeIdIndex) >> 1;\n\t if(data3) data2 *= data3;\n\n\t data2 = ((unsigned int)(SiS_GetMCLK(SiS_Pr) * 1024)) / data2;\n\n\t if(SiS_Pr->ChipType == SIS_330) {\n\t    if(SiS_Pr->SiS_ModeType != Mode16Bpp) {\n\t       if     (data2 >= 0x19c) data = 0xba;\n\t       else if(data2 >= 0x140) data = 0x7a;\n\t       else if(data2 >= 0x101) data = 0x3a;\n\t       else if(data2 >= 0xf5)  data = 0x32;\n\t       else if(data2 >= 0xe2)  data = 0x2a;\n\t       else if(data2 >= 0xc4)  data = 0x22;\n\t       else if(data2 >= 0xac)  data = 0x1a;\n\t       else if(data2 >= 0x9e)  data = 0x12;\n\t       else if(data2 >= 0x8e)  data = 0x0a;\n\t       else                    data = 0x02;\n\t    } else {\n\t       if(data2 >= 0x127)      data = 0xba;\n\t       else                    data = 0x7a;\n\t    }\n\t } else {   \n\t    if     (data2 >= 0x190) data = 0xba;\n\t    else if(data2 >= 0xff)  data = 0x7a;\n\t    else if(data2 >= 0xd3)  data = 0x3a;\n\t    else if(data2 >= 0xa9)  data = 0x1a;\n\t    else if(data2 >= 0x93)  data = 0x0a;\n\t    else                    data = 0x02;\n\t }\n      }\n      SiS_SetReg(SiS_Pr->SiS_P3c4,0x17,data);\n\n   }\n       \n       \n#endif\n\n   data = 0x60;\n   if(SiS_Pr->SiS_ModeType != ModeText) {\n      data ^= 0x60;\n      if(SiS_Pr->SiS_ModeType != ModeEGA) {\n         data ^= 0xA0;\n      }\n   }\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x21,0x1F,data);\n\n   SiS_SetVCLKState(SiS_Pr, ModeNo, RRTI, ModeIdIndex);\n\n#ifdef CONFIG_FB_SIS_315\n   if(((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->ChipType < SIS_661)) ||\n       (SiS_Pr->ChipType == XGI_40)) {\n      if(SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & 0x40) {\n         SiS_SetReg(SiS_Pr->SiS_P3d4,0x52,0x2c);\n      } else {\n         SiS_SetReg(SiS_Pr->SiS_P3d4,0x52,0x6c);\n      }\n   } else if(SiS_Pr->ChipType == XGI_20) {\n      if(SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & 0x40) {\n         SiS_SetReg(SiS_Pr->SiS_P3d4,0x52,0x33);\n      } else {\n         SiS_SetReg(SiS_Pr->SiS_P3d4,0x52,0x73);\n      }\n      SiS_SetReg(SiS_Pr->SiS_P3d4,0x51,0x02);\n   }\n#endif\n}\n\n#ifdef CONFIG_FB_SIS_315\nstatic void\nSiS_SetupDualChip(struct SiS_Private *SiS_Pr)\n{\n#if 0\n    \n   SISIOADDRESS P2_3c2 = SiS_Pr->IOAddress2 + 0x12;\n   SISIOADDRESS P2_3c4 = SiS_Pr->IOAddress2 + 0x14;\n   SISIOADDRESS P2_3ce = SiS_Pr->IOAddress2 + 0x1e;\n   int i;\n\n   if((SiS_Pr->ChipRevision != 0) ||\n      (!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x3a) & 0x04)))\n      return;\n\n   for(i = 0; i <= 4; i++) {\t\t\t\t\t \n      SiS_SetReg(P2_3c4,i,SiS_GetReg(SiS_Pr->SiS_P3c4,i));\n   }\n   for(i = 0; i <= 8; i++) {\t\t\t\t\t \n      SiS_SetReg(P2_3ce,i,SiS_GetReg(SiS_Pr->SiS_P3ce,i));\n   }\n   SiS_SetReg(P2_3c4,0x05,0x86);\n   SiS_SetReg(P2_3c4,0x06,SiS_GetReg(SiS_Pr->SiS_P3c4,0x06));\t \n   SiS_SetReg(P2_3c4,0x21,SiS_GetReg(SiS_Pr->SiS_P3c4,0x21));\t \n   SiS_SetRegByte(P2_3c2,SiS_GetRegByte(SiS_Pr->SiS_P3cc));\t \n   SiS_SetReg(P2_3c4,0x05,0x00);\n#endif\n}\n#endif\n\n \n \n \n\nstatic void\nSiS_WriteDAC(struct SiS_Private *SiS_Pr, SISIOADDRESS DACData, unsigned short shiftflag,\n             unsigned short dl, unsigned short ah, unsigned short al, unsigned short dh)\n{\n   unsigned short d1, d2, d3;\n\n   switch(dl) {\n   case  0: d1 = dh; d2 = ah; d3 = al; break;\n   case  1: d1 = ah; d2 = al; d3 = dh; break;\n   default: d1 = al; d2 = dh; d3 = ah;\n   }\n   SiS_SetRegByte(DACData, (d1 << shiftflag));\n   SiS_SetRegByte(DACData, (d2 << shiftflag));\n   SiS_SetRegByte(DACData, (d3 << shiftflag));\n}\n\nvoid\nSiS_LoadDAC(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\n{\n   unsigned short data, data2, time, i, j, k, m, n, o;\n   unsigned short si, di, bx, sf;\n   SISIOADDRESS DACAddr, DACData;\n   const unsigned char *table = NULL;\n\n   data = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex) & DACInfoFlag;\n\n   j = time = 64;\n   if(data == 0x00)      table = SiS_MDA_DAC;\n   else if(data == 0x08) table = SiS_CGA_DAC;\n   else if(data == 0x10) table = SiS_EGA_DAC;\n   else if(data == 0x18) {\n      j = 16;\n      time = 256;\n      table = SiS_VGA_DAC;\n   }\n\n   if( ( (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) &&         \n         (SiS_Pr->SiS_VBType & VB_NoLCD) )        ||\n       (SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)       ||    \n       (!(SiS_Pr->SiS_SetFlag & ProgrammingCRT2)) ) {   \n      SiS_SetRegByte(SiS_Pr->SiS_P3c6,0xFF);\n      DACAddr = SiS_Pr->SiS_P3c8;\n      DACData = SiS_Pr->SiS_P3c9;\n      sf = 0;\n   } else {\n      DACAddr = SiS_Pr->SiS_Part5Port;\n      DACData = SiS_Pr->SiS_Part5Port + 1;\n      sf = 2;\n   }\n\n   SiS_SetRegByte(DACAddr,0x00);\n\n   for(i = 0; i < j; i++) {\n      data = table[i];\n      for(k = 0; k < 3; k++) {\n\tdata2 = 0;\n\tif(data & 0x01) data2 += 0x2A;\n\tif(data & 0x02) data2 += 0x15;\n\tSiS_SetRegByte(DACData, (data2 << sf));\n\tdata >>= 2;\n      }\n   }\n\n   if(time == 256) {\n      for(i = 16; i < 32; i++) {\n\t data = table[i] << sf;\n\t for(k = 0; k < 3; k++) SiS_SetRegByte(DACData, data);\n      }\n      si = 32;\n      for(m = 0; m < 9; m++) {\n\t di = si;\n\t bx = si + 4;\n\t for(n = 0; n < 3; n++) {\n\t    for(o = 0; o < 5; o++) {\n\t       SiS_WriteDAC(SiS_Pr, DACData, sf, n, table[di], table[bx], table[si]);\n\t       si++;\n\t    }\n\t    si -= 2;\n\t    for(o = 0; o < 3; o++) {\n\t       SiS_WriteDAC(SiS_Pr, DACData, sf, n, table[di], table[si], table[bx]);\n\t       si--;\n\t    }\n\t }             \n\t si += 5;\n      }                \n   }\n}\n\n \n \n \n\nstatic void\nSiS_SetCRT1Group(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\n{\n   unsigned short StandTableIndex, RefreshRateTableIndex;\n\n   SiS_Pr->SiS_CRT1Mode = ModeNo;\n\n   StandTableIndex = SiS_GetModePtr(SiS_Pr, ModeNo, ModeIdIndex);\n\n   if(SiS_Pr->SiS_SetFlag & LowModeTests) {\n      if(SiS_Pr->SiS_VBInfo & (SetSimuScanMode | SwitchCRT2)) {\n         SiS_DisableBridge(SiS_Pr);\n      }\n   }\n\n   SiS_ResetSegmentRegisters(SiS_Pr);\n\n   SiS_SetSeqRegs(SiS_Pr, StandTableIndex);\n   SiS_SetMiscRegs(SiS_Pr, StandTableIndex);\n   SiS_SetCRTCRegs(SiS_Pr, StandTableIndex);\n   SiS_SetATTRegs(SiS_Pr, StandTableIndex);\n   SiS_SetGRCRegs(SiS_Pr, StandTableIndex);\n   SiS_ClearExt1Regs(SiS_Pr, ModeNo);\n   SiS_ResetCRT1VCLK(SiS_Pr);\n\n   SiS_Pr->SiS_SelectCRT2Rate = 0;\n   SiS_Pr->SiS_SetFlag &= (~ProgrammingCRT2);\n\n   if(SiS_Pr->SiS_VBInfo & SetSimuScanMode) {\n      if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\n         SiS_Pr->SiS_SetFlag |= ProgrammingCRT2;\n      }\n   }\n\n   if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\n      SiS_Pr->SiS_SetFlag |= ProgrammingCRT2;\n   }\n\n   RefreshRateTableIndex = SiS_GetRatePtr(SiS_Pr, ModeNo, ModeIdIndex);\n\n   if(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\n      SiS_Pr->SiS_SetFlag &= ~ProgrammingCRT2;\n   }\n\n   if(RefreshRateTableIndex != 0xFFFF) {\n      SiS_SetCRT1Sync(SiS_Pr, RefreshRateTableIndex);\n      SiS_SetCRT1CRTC(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\n      SiS_SetCRT1Offset(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\n      SiS_SetCRT1VCLK(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\n   }\n\n   switch(SiS_Pr->ChipType) {\n#ifdef CONFIG_FB_SIS_300\n   case SIS_300:\n      SiS_SetCRT1FIFO_300(SiS_Pr, ModeNo, RefreshRateTableIndex);\n      break;\n   case SIS_540:\n   case SIS_630:\n   case SIS_730:\n      SiS_SetCRT1FIFO_630(SiS_Pr, ModeNo, RefreshRateTableIndex);\n      break;\n#endif\n   default:\n#ifdef CONFIG_FB_SIS_315\n      if(SiS_Pr->ChipType == XGI_20) {\n         unsigned char sr2b = 0, sr2c = 0;\n         switch(ModeNo) {\n\t case 0x00:\n\t case 0x01: sr2b = 0x4e; sr2c = 0xe9; break;\n\t case 0x04:\n\t case 0x05:\n\t case 0x0d: sr2b = 0x1b; sr2c = 0xe3; break;\n\t }\n\t if(sr2b) {\n            SiS_SetReg(SiS_Pr->SiS_P3c4,0x2b,sr2b);\n\t    SiS_SetReg(SiS_Pr->SiS_P3c4,0x2c,sr2c);\n\t    SiS_SetRegByte(SiS_Pr->SiS_P3c2,(SiS_GetRegByte(SiS_Pr->SiS_P3cc) | 0x0c));\n\t }\n      }\n      SiS_SetCRT1FIFO_310(SiS_Pr, ModeNo, ModeIdIndex);\n#endif\n      break;\n   }\n\n   SiS_SetCRT1ModeRegs(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\n\n#ifdef CONFIG_FB_SIS_315\n   if(SiS_Pr->ChipType == XGI_40) {\n      SiS_SetupDualChip(SiS_Pr);\n   }\n#endif\n\n   SiS_LoadDAC(SiS_Pr, ModeNo, ModeIdIndex);\n\n   if(SiS_Pr->SiS_flag_clearbuffer) {\n      SiS_ClearBuffer(SiS_Pr, ModeNo);\n   }\n\n   if(!(SiS_Pr->SiS_VBInfo & (SetSimuScanMode | SwitchCRT2 | SetCRT2ToLCDA))) {\n      SiS_WaitRetrace1(SiS_Pr);\n      SiS_DisplayOn(SiS_Pr);\n   }\n}\n\n \n \n \n\nstatic void\nSiS_InitVB(struct SiS_Private *SiS_Pr)\n{\n   unsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\n\n   SiS_Pr->Init_P4_0E = 0;\n   if(SiS_Pr->SiS_ROMNew) {\n      SiS_Pr->Init_P4_0E = ROMAddr[0x82];\n   } else if(SiS_Pr->ChipType >= XGI_40) {\n      if(SiS_Pr->SiS_XGIROM) {\n         SiS_Pr->Init_P4_0E = ROMAddr[0x80];\n      }\n   }\n}\n\nstatic void\nSiS_ResetVB(struct SiS_Private *SiS_Pr)\n{\n#ifdef CONFIG_FB_SIS_315\n   unsigned char  *ROMAddr = SiS_Pr->VirtualRomBase;\n   unsigned short temp;\n\n    \n   if(SiS_Pr->SiS_UseROM) {\n      if(SiS_Pr->ChipType < SIS_330) {\n\t temp = ROMAddr[VB310Data_1_2_Offset] | 0x40;\n\t if(SiS_Pr->SiS_ROMNew) temp = ROMAddr[0x80] | 0x40;\n\t SiS_SetReg(SiS_Pr->SiS_Part1Port,0x02,temp);\n      } else if(SiS_Pr->ChipType >= SIS_661 && SiS_Pr->ChipType < XGI_20) {\n\t temp = ROMAddr[0x7e] | 0x40;\n\t if(SiS_Pr->SiS_ROMNew) temp = ROMAddr[0x80] | 0x40;\n\t SiS_SetReg(SiS_Pr->SiS_Part1Port,0x02,temp);\n      }\n   } else if(SiS_Pr->ChipType >= XGI_40) {\n      temp = 0x40;\n      if(SiS_Pr->SiS_XGIROM) temp |= ROMAddr[0x7e];\n       \n      SiS_SetReg(SiS_Pr->SiS_Part1Port,0x02,temp);\n   }\n#endif\n}\n\n \n \n \n\nstatic void\nSiS_StrangeStuff(struct SiS_Private *SiS_Pr)\n{\n    \n#ifdef CONFIG_FB_SIS_315\n   if((IS_SIS651) || (IS_SISM650) ||\n      SiS_Pr->ChipType == SIS_340 ||\n      SiS_Pr->ChipType == XGI_40) {\n      SiS_SetReg(SiS_Pr->SiS_VidCapt, 0x3f, 0x00);    \n      SiS_SetReg(SiS_Pr->SiS_VidCapt, 0x00, 0x00);\n      SiS_SetReg(SiS_Pr->SiS_VidPlay, 0x00, 0x86);    \n      SiS_SetRegAND(SiS_Pr->SiS_VidPlay, 0x30, 0xfe);  \n      SiS_SetRegAND(SiS_Pr->SiS_VidPlay, 0x3f, 0xef);\n   }\n    \n#endif\n}\n\n \n \n \n\nstatic void\nSiS_Handle760(struct SiS_Private *SiS_Pr)\n{\n#ifdef CONFIG_FB_SIS_315\n   unsigned int somebase;\n   unsigned char temp1, temp2, temp3;\n\n   if( (SiS_Pr->ChipType != SIS_760)                         ||\n       ((SiS_GetReg(SiS_Pr->SiS_P3d4, 0x5c) & 0xf8) != 0x80) ||\n       (!(SiS_Pr->SiS_SysFlags & SF_760LFB))                 ||\n       (!(SiS_Pr->SiS_SysFlags & SF_760UMA)) )\n      return;\n\n   somebase = sisfb_read_mio_pci_word(SiS_Pr, 0x74);\n   somebase &= 0xffff;\n\n   if(somebase == 0) return;\n\n   temp3 = SiS_GetRegByte((somebase + 0x85)) & 0xb7;\n\n   if(SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & 0x40) {\n      temp1 = 0x21;\n      temp2 = 0x03;\n      temp3 |= 0x08;\n   } else {\n      temp1 = 0x25;\n      temp2 = 0x0b;\n   }\n\n   sisfb_write_nbridge_pci_byte(SiS_Pr, 0x7e, temp1);\n   sisfb_write_nbridge_pci_byte(SiS_Pr, 0x8d, temp2);\n\n   SiS_SetRegByte((somebase + 0x85), temp3);\n#endif\n}\n\n \n \n \n\nbool\nSiSSetMode(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\n{\n   SISIOADDRESS BaseAddr = SiS_Pr->IOAddress;\n   unsigned short RealModeNo, ModeIdIndex;\n   unsigned char  backupreg = 0;\n   unsigned short KeepLockReg;\n\n   SiS_Pr->UseCustomMode = false;\n   SiS_Pr->CRT1UsesCustomMode = false;\n\n   SiS_Pr->SiS_flag_clearbuffer = 0;\n\n   if(SiS_Pr->UseCustomMode) {\n      ModeNo = 0xfe;\n   } else {\n      if(!(ModeNo & 0x80)) SiS_Pr->SiS_flag_clearbuffer = 1;\n      ModeNo &= 0x7f;\n   }\n\n    \n   RealModeNo = ModeNo;\n   if(ModeNo == 0x5b) ModeNo = 0x56;\n\n   SiSInitPtr(SiS_Pr);\n   SiSRegInit(SiS_Pr, BaseAddr);\n   SiS_GetSysFlags(SiS_Pr);\n\n   SiS_Pr->SiS_VGAINFO = 0x11;\n\n   KeepLockReg = SiS_GetReg(SiS_Pr->SiS_P3c4,0x05);\n   SiS_SetReg(SiS_Pr->SiS_P3c4,0x05,0x86);\n\n   SiSInitPCIetc(SiS_Pr);\n   SiSSetLVDSetc(SiS_Pr);\n   SiSDetermineROMUsage(SiS_Pr);\n\n   SiS_UnLockCRT2(SiS_Pr);\n\n   if(!SiS_Pr->UseCustomMode) {\n      if(!(SiS_SearchModeID(SiS_Pr, &ModeNo, &ModeIdIndex))) return false;\n   } else {\n      ModeIdIndex = 0;\n   }\n\n   SiS_GetVBType(SiS_Pr);\n\n    \n   SiS_InitVB(SiS_Pr);\n   if(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\n      if(SiS_Pr->ChipType >= SIS_315H) {\n         SiS_ResetVB(SiS_Pr);\n\t SiS_SetRegOR(SiS_Pr->SiS_P3c4,0x32,0x10);\n\t SiS_SetRegOR(SiS_Pr->SiS_Part2Port,0x00,0x0c);\n         backupreg = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\n      } else {\n         backupreg = SiS_GetReg(SiS_Pr->SiS_P3d4,0x35);\n      }\n   }\n\n    \n   SiS_GetVBInfo(SiS_Pr, ModeNo, ModeIdIndex, (SiS_Pr->UseCustomMode) ? 0 : 1);\n   SiS_SetYPbPr(SiS_Pr);\n   SiS_SetTVMode(SiS_Pr, ModeNo, ModeIdIndex);\n   SiS_GetLCDResInfo(SiS_Pr, ModeNo, ModeIdIndex);\n   SiS_SetLowModeTest(SiS_Pr, ModeNo);\n\n    \n   if(!SiS_CheckMemorySize(SiS_Pr, ModeNo, ModeIdIndex)) {\n      return false;\n   }\n\n   SiS_OpenCRTC(SiS_Pr);\n\n   if(SiS_Pr->UseCustomMode) {\n      SiS_Pr->CRT1UsesCustomMode = true;\n      SiS_Pr->CSRClock_CRT1 = SiS_Pr->CSRClock;\n      SiS_Pr->CModeFlag_CRT1 = SiS_Pr->CModeFlag;\n   } else {\n      SiS_Pr->CRT1UsesCustomMode = false;\n   }\n\n    \n   if( (SiS_Pr->SiS_VBInfo & (SetSimuScanMode | SetCRT2ToLCDA)) ||\n       (!(SiS_Pr->SiS_VBInfo & SwitchCRT2)) ) {\n      SiS_SetCRT1Group(SiS_Pr, ModeNo, ModeIdIndex);\n   }\n\n    \n   if(SiS_Pr->SiS_VBInfo & (SetSimuScanMode | SwitchCRT2 | SetCRT2ToLCDA)) {\n      if( (SiS_Pr->SiS_VBType & VB_SISVB)    ||\n\t  (SiS_Pr->SiS_IF_DEF_LVDS     == 1) ||\n\t  (SiS_Pr->SiS_IF_DEF_CH70xx   != 0) ||\n\t  (SiS_Pr->SiS_IF_DEF_TRUMPION != 0) ) {\n\t SiS_SetCRT2Group(SiS_Pr, RealModeNo);\n      }\n   }\n\n   SiS_HandleCRT1(SiS_Pr);\n\n   SiS_StrangeStuff(SiS_Pr);\n\n   SiS_DisplayOn(SiS_Pr);\n   SiS_SetRegByte(SiS_Pr->SiS_P3c6,0xFF);\n\n#ifdef CONFIG_FB_SIS_315\n   if(SiS_Pr->ChipType >= SIS_315H) {\n      if(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\n\t if(!(SiS_IsDualEdge(SiS_Pr))) {\n\t    SiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x13,0xfb);\n\t }\n      }\n   }\n#endif\n\n   if(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\n      if(SiS_Pr->ChipType >= SIS_315H) {\n#ifdef CONFIG_FB_SIS_315\n\t if(!SiS_Pr->SiS_ROMNew) {\n\t    if(SiS_IsVAMode(SiS_Pr)) {\n\t       SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x35,0x01);\n\t    } else {\n\t       SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x35,0xFE);\n\t    }\n\t }\n\n\t SiS_SetReg(SiS_Pr->SiS_P3d4,0x38,backupreg);\n\n\t if((IS_SIS650) && (SiS_GetReg(SiS_Pr->SiS_P3d4,0x30) & 0xfc)) {\n\t    if((ModeNo == 0x03) || (ModeNo == 0x10)) {\n\t       SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x51,0x80);\n\t       SiS_SetRegOR(SiS_Pr->SiS_P3d4,0x56,0x08);\n\t    }\n\t }\n\n\t if(SiS_GetReg(SiS_Pr->SiS_P3d4,0x30) & SetCRT2ToLCD) {\n\t    SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x38,0xfc);\n\t }\n#endif\n      } else if((SiS_Pr->ChipType == SIS_630) ||\n\t        (SiS_Pr->ChipType == SIS_730)) {\n\t SiS_SetReg(SiS_Pr->SiS_P3d4,0x35,backupreg);\n      }\n   }\n\n   SiS_CloseCRTC(SiS_Pr);\n\n   SiS_Handle760(SiS_Pr);\n\n    \n   if(KeepLockReg != 0xA1) SiS_SetReg(SiS_Pr->SiS_P3c4,0x05,0x00);\n\n   return true;\n}\n\n#ifndef GETBITSTR\n#define GENBITSMASK(mask)   \tGENMASK(1?mask,0?mask)\n#define GETBITS(var,mask)   \t(((var) & GENBITSMASK(mask)) >> (0?mask))\n#define GETBITSTR(val,from,to)  ((GETBITS(val,from)) << (0?to))\n#endif\n\nvoid\nSiS_CalcCRRegisters(struct SiS_Private *SiS_Pr, int depth)\n{\n   int x = 1;  \n\n   SiS_Pr->CCRT1CRTC[0]  =  ((SiS_Pr->CHTotal >> 3) - 5) & 0xff;\t\t \n   SiS_Pr->CCRT1CRTC[1]  =  (SiS_Pr->CHDisplay >> 3) - 1;\t\t\t \n   SiS_Pr->CCRT1CRTC[2]  =  (SiS_Pr->CHBlankStart >> 3) - 1;\t\t\t \n   SiS_Pr->CCRT1CRTC[3]  =  (((SiS_Pr->CHBlankEnd >> 3) - 1) & 0x1F) | 0x80;\t \n   SiS_Pr->CCRT1CRTC[4]  =  (SiS_Pr->CHSyncStart >> 3) + 3;\t\t\t \n   SiS_Pr->CCRT1CRTC[5]  =  ((((SiS_Pr->CHBlankEnd >> 3) - 1) & 0x20) << 2) |\t \n\t\t\t    (((SiS_Pr->CHSyncEnd >> 3) + 3) & 0x1F);\n\n   SiS_Pr->CCRT1CRTC[6]  =  (SiS_Pr->CVTotal       - 2) & 0xFF;\t\t\t \n   SiS_Pr->CCRT1CRTC[7]  =  (((SiS_Pr->CVTotal     - 2) & 0x100) >> 8)\t\t \n\t\t\t  | (((SiS_Pr->CVDisplay   - 1) & 0x100) >> 7)\n\t\t\t  | (((SiS_Pr->CVSyncStart - x) & 0x100) >> 6)\n\t\t\t  | (((SiS_Pr->CVBlankStart- 1) & 0x100) >> 5)\n\t\t\t  | 0x10\n\t\t\t  | (((SiS_Pr->CVTotal     - 2) & 0x200) >> 4)\n\t\t\t  | (((SiS_Pr->CVDisplay   - 1) & 0x200) >> 3)\n\t\t\t  | (((SiS_Pr->CVSyncStart - x) & 0x200) >> 2);\n\n   SiS_Pr->CCRT1CRTC[16] = ((((SiS_Pr->CVBlankStart - 1) & 0x200) >> 4) >> 5); \t \n\n   if(depth != 8) {\n      if(SiS_Pr->CHDisplay >= 1600)      SiS_Pr->CCRT1CRTC[16] |= 0x60;\t\t \n      else if(SiS_Pr->CHDisplay >= 640)  SiS_Pr->CCRT1CRTC[16] |= 0x40;\n   }\n\n   SiS_Pr->CCRT1CRTC[8] =  (SiS_Pr->CVSyncStart  - x) & 0xFF;\t\t\t \n   SiS_Pr->CCRT1CRTC[9] =  ((SiS_Pr->CVSyncEnd   - x) & 0x0F) | 0x80;\t\t \n   SiS_Pr->CCRT1CRTC[10] = (SiS_Pr->CVDisplay    - 1) & 0xFF;\t\t\t \n   SiS_Pr->CCRT1CRTC[11] = (SiS_Pr->CVBlankStart - 1) & 0xFF;\t\t\t \n   SiS_Pr->CCRT1CRTC[12] = (SiS_Pr->CVBlankEnd   - 1) & 0xFF;\t\t\t \n\n   SiS_Pr->CCRT1CRTC[13] =\t\t\t\t\t\t\t \n\t\t\tGETBITSTR((SiS_Pr->CVTotal     -2), 10:10, 0:0) |\n\t\t\tGETBITSTR((SiS_Pr->CVDisplay   -1), 10:10, 1:1) |\n\t\t\tGETBITSTR((SiS_Pr->CVBlankStart-1), 10:10, 2:2) |\n\t\t\tGETBITSTR((SiS_Pr->CVSyncStart -x), 10:10, 3:3) |\n\t\t\tGETBITSTR((SiS_Pr->CVBlankEnd  -1),   8:8, 4:4) |\n\t\t\tGETBITSTR((SiS_Pr->CVSyncEnd     ),   4:4, 5:5) ;\n\n   SiS_Pr->CCRT1CRTC[14] =\t\t\t\t\t\t\t \n\t\t\tGETBITSTR((SiS_Pr->CHTotal      >> 3) - 5, 9:8, 1:0) |\n\t\t\tGETBITSTR((SiS_Pr->CHDisplay    >> 3) - 1, 9:8, 3:2) |\n\t\t\tGETBITSTR((SiS_Pr->CHBlankStart >> 3) - 1, 9:8, 5:4) |\n\t\t\tGETBITSTR((SiS_Pr->CHSyncStart  >> 3) + 3, 9:8, 7:6) ;\n\n\n   SiS_Pr->CCRT1CRTC[15] =\t\t\t\t\t\t\t \n\t\t\tGETBITSTR((SiS_Pr->CHBlankEnd >> 3) - 1, 7:6, 1:0) |\n\t\t\tGETBITSTR((SiS_Pr->CHSyncEnd  >> 3) + 3, 5:5, 2:2) ;\n}\n\nvoid\nSiS_CalcLCDACRT1Timing(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\n\t\tunsigned short ModeIdIndex)\n{\n   unsigned short modeflag, tempax, tempbx = 0, remaining = 0;\n   unsigned short VGAHDE = SiS_Pr->SiS_VGAHDE;\n   int i, j;\n\n    \n   if(SiS_Pr->SiS_LCDInfo & LCDPass11) return;\n\n   modeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\n\n   if(modeflag & HalfDCLK) VGAHDE >>= 1;\n\n   SiS_Pr->CHDisplay = VGAHDE;\n   SiS_Pr->CHBlankStart = VGAHDE;\n\n   SiS_Pr->CVDisplay = SiS_Pr->SiS_VGAVDE;\n   SiS_Pr->CVBlankStart = SiS_Pr->SiS_VGAVDE;\n\n   if(SiS_Pr->ChipType < SIS_315H) {\n#ifdef CONFIG_FB_SIS_300\n      tempbx = SiS_Pr->SiS_VGAHT;\n      if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\n         tempbx = SiS_Pr->PanelHT;\n      }\n      if(modeflag & HalfDCLK) tempbx >>= 1;\n      remaining = tempbx % 8;\n#endif\n   } else {\n#ifdef CONFIG_FB_SIS_315\n       \n      tempbx = SiS_Pr->PanelHT - SiS_Pr->PanelXRes;\n      tempax = SiS_Pr->SiS_VGAHDE;   \n      if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\n         tempax = SiS_Pr->PanelXRes;\n      }\n      tempbx += tempax;\n      if(modeflag & HalfDCLK) tempbx -= VGAHDE;\n#endif\n   }\n   SiS_Pr->CHTotal = SiS_Pr->CHBlankEnd = tempbx;\n\n   if(SiS_Pr->ChipType < SIS_315H) {\n#ifdef CONFIG_FB_SIS_300\n      if(SiS_Pr->SiS_VGAHDE == SiS_Pr->PanelXRes) {\n\t SiS_Pr->CHSyncStart = SiS_Pr->SiS_VGAHDE + ((SiS_Pr->PanelHRS + 1) & ~1);\n\t SiS_Pr->CHSyncEnd = SiS_Pr->CHSyncStart + SiS_Pr->PanelHRE;\n\t if(modeflag & HalfDCLK) {\n\t    SiS_Pr->CHSyncStart >>= 1;\n\t    SiS_Pr->CHSyncEnd >>= 1;\n\t }\n      } else if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\n\t tempax = (SiS_Pr->PanelXRes - SiS_Pr->SiS_VGAHDE) >> 1;\n\t tempbx = (SiS_Pr->PanelHRS + 1) & ~1;\n\t if(modeflag & HalfDCLK) {\n\t    tempax >>= 1;\n\t    tempbx >>= 1;\n\t }\n\t SiS_Pr->CHSyncStart = (VGAHDE + tempax + tempbx + 7) & ~7;\n\t tempax = SiS_Pr->PanelHRE + 7;\n\t if(modeflag & HalfDCLK) tempax >>= 1;\n\t SiS_Pr->CHSyncEnd = (SiS_Pr->CHSyncStart + tempax) & ~7;\n      } else {\n\t SiS_Pr->CHSyncStart = SiS_Pr->SiS_VGAHDE;\n\t if(modeflag & HalfDCLK) {\n\t    SiS_Pr->CHSyncStart >>= 1;\n\t    tempax = ((SiS_Pr->CHTotal - SiS_Pr->CHSyncStart) / 3) << 1;\n\t    SiS_Pr->CHSyncEnd = SiS_Pr->CHSyncStart + tempax;\n\t } else {\n\t    SiS_Pr->CHSyncEnd = (SiS_Pr->CHSyncStart + (SiS_Pr->CHTotal / 10) + 7) & ~7;\n\t    SiS_Pr->CHSyncStart += 8;\n\t }\n      }\n#endif\n   } else {\n#ifdef CONFIG_FB_SIS_315\n      tempax = VGAHDE;\n      if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\n\t tempbx = SiS_Pr->PanelXRes;\n\t if(modeflag & HalfDCLK) tempbx >>= 1;\n\t tempax += ((tempbx - tempax) >> 1);\n      }\n      tempax += SiS_Pr->PanelHRS;\n      SiS_Pr->CHSyncStart = tempax;\n      tempax += SiS_Pr->PanelHRE;\n      SiS_Pr->CHSyncEnd = tempax;\n#endif\n   }\n\n   tempbx = SiS_Pr->PanelVT - SiS_Pr->PanelYRes;\n   tempax = SiS_Pr->SiS_VGAVDE;\n   if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\n      tempax = SiS_Pr->PanelYRes;\n   } else if(SiS_Pr->ChipType < SIS_315H) {\n#ifdef CONFIG_FB_SIS_300\n       \n      if(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\n\t if((tempax + tempbx) == 438) tempbx += 16;\n      } else if((SiS_Pr->SiS_LCDResInfo == Panel_800x600) ||\n\t\t(SiS_Pr->SiS_LCDResInfo == Panel_1024x600)) {\n\t tempax = 0;\n\t tempbx = SiS_Pr->SiS_VGAVT;\n      }\n#endif\n   }\n   SiS_Pr->CVTotal = SiS_Pr->CVBlankEnd = tempbx + tempax;\n\n   tempax = SiS_Pr->SiS_VGAVDE;\n   if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\n      tempax += (SiS_Pr->PanelYRes - tempax) >> 1;\n   }\n   tempax += SiS_Pr->PanelVRS;\n   SiS_Pr->CVSyncStart = tempax;\n   tempax += SiS_Pr->PanelVRE;\n   SiS_Pr->CVSyncEnd = tempax;\n   if(SiS_Pr->ChipType < SIS_315H) {\n      SiS_Pr->CVSyncStart--;\n      SiS_Pr->CVSyncEnd--;\n   }\n\n   SiS_CalcCRRegisters(SiS_Pr, 8);\n   SiS_Pr->CCRT1CRTC[15] &= ~0xF8;\n   SiS_Pr->CCRT1CRTC[15] |= (remaining << 4);\n   SiS_Pr->CCRT1CRTC[16] &= ~0xE0;\n\n   SiS_SetRegAND(SiS_Pr->SiS_P3d4,0x11,0x7f);\n\n   for(i = 0, j = 0; i <= 7; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,j,SiS_Pr->CCRT1CRTC[i]);\n   }\n   for(j = 0x10; i <= 10; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,j,SiS_Pr->CCRT1CRTC[i]);\n   }\n   for(j = 0x15; i <= 12; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3d4,j,SiS_Pr->CCRT1CRTC[i]);\n   }\n   for(j = 0x0A; i <= 15; i++, j++) {\n      SiS_SetReg(SiS_Pr->SiS_P3c4,j,SiS_Pr->CCRT1CRTC[i]);\n   }\n\n   tempax = SiS_Pr->CCRT1CRTC[16] & 0xE0;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0E,0x1F,tempax);\n\n   tempax = (SiS_Pr->CCRT1CRTC[16] & 0x01) << 5;\n   if(modeflag & DoubleScanMode) tempax |= 0x80;\n   SiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x09,0x5F,tempax);\n\n}\n\nvoid\nSiS_Generic_ConvertCRData(struct SiS_Private *SiS_Pr, unsigned char *crdata,\n\t\t\tint xres, int yres,\n\t\t\tstruct fb_var_screeninfo *var, bool writeres\n)\n{\n   unsigned short HRE, HBE, HRS, HDE;\n   unsigned short VRE, VBE, VRS, VDE;\n   unsigned char  sr_data, cr_data;\n   int            B, C, D, E, F, temp;\n\n   sr_data = crdata[14];\n\n    \n   HDE = crdata[1] | ((unsigned short)(sr_data & 0x0C) << 6);\n   E = HDE + 1;\n\n    \n   HRS = crdata[4] | ((unsigned short)(sr_data & 0xC0) << 2);\n   F = HRS - E - 3;\n\n   sr_data = crdata[15];\n   cr_data = crdata[5];\n\n    \n   HBE = (crdata[3] & 0x1f) |\n         ((unsigned short)(cr_data & 0x80) >> 2) |\n         ((unsigned short)(sr_data & 0x03) << 6);\n\n    \n   HRE = (cr_data & 0x1f) | ((sr_data & 0x04) << 3);\n\n   temp = HBE - ((E - 1) & 255);\n   B = (temp > 0) ? temp : (temp + 256);\n\n   temp = HRE - ((E + F + 3) & 63);\n   C = (temp > 0) ? temp : (temp + 64);\n\n   D = B - F - C;\n\n   if(writeres) var->xres = xres = E * 8;\n   var->left_margin = D * 8;\n   var->right_margin = F * 8;\n   var->hsync_len = C * 8;\n\n    \n   sr_data = crdata[13];\n   cr_data = crdata[7];\n\n    \n   VDE = crdata[10] |\n\t ((unsigned short)(cr_data & 0x02) << 7) |\n\t ((unsigned short)(cr_data & 0x40) << 3) |\n\t ((unsigned short)(sr_data & 0x02) << 9);\n   E = VDE + 1;\n\n    \n   VRS = crdata[8] |\n\t ((unsigned short)(cr_data & 0x04) << 6) |\n\t ((unsigned short)(cr_data & 0x80) << 2) |\n\t ((unsigned short)(sr_data & 0x08) << 7);\n   F = VRS + 1 - E;\n\n    \n   VBE = crdata[12] | ((unsigned short)(sr_data & 0x10) << 4);\n   temp = VBE - ((E - 1) & 511);\n   B = (temp > 0) ? temp : (temp + 512);\n\n    \n   VRE = (crdata[9] & 0x0f) | ((sr_data & 0x20) >> 1);\n   temp = VRE - ((E + F - 1) & 31);\n   C = (temp > 0) ? temp : (temp + 32);\n\n   D = B - F - C;\n\n   if(writeres) var->yres = yres = E;\n   var->upper_margin = D;\n   var->lower_margin = F;\n   var->vsync_len = C;\n\n   if((xres == 320) && ((yres == 200) || (yres == 240))) {\n\t \n      var->left_margin = (400 - 376);\n      var->right_margin = (328 - 320);\n      var->hsync_len = (376 - 328);\n\n   }\n\n}\n\n\n\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}