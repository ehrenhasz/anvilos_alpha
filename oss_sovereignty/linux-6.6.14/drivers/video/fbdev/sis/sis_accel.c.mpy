{
  "module_name": "sis_accel.c",
  "hash_id": "5ed00bab4f442c694ddd9f615d24f07e900f171d47b57083cbf16560e95d4684",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/sis/sis_accel.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/fb.h>\n#include <linux/ioport.h>\n#include <linux/types.h>\n#include <asm/io.h>\n\n#include \"sis.h\"\n#include \"sis_accel.h\"\n\nstatic const u8 sisALUConv[] =\n{\n    0x00,        \n    0x88,        \n    0x44,        \n    0xCC,        \n    0x22,        \n    0xAA,        \n    0x66,        \n    0xEE,        \n    0x11,        \n    0x99,        \n    0x55,        \n    0xDD,        \n    0x33,        \n    0xBB,        \n    0x77,        \n    0xFF,        \n};\n \nstatic const u8 sisPatALUConv[] =\n{\n    0x00,        \n    0xA0,        \n    0x50,        \n    0xF0,        \n    0x0A,        \n    0xAA,        \n    0x5A,        \n    0xFA,        \n    0x05,        \n    0xA5,        \n    0x55,        \n    0xF5,        \n    0x0F,        \n    0xAF,        \n    0x5F,        \n    0xFF,        \n};\n\nstatic const int myrops[] = {\n   \t3, 10, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3\n};\n\n \n#ifdef CONFIG_FB_SIS_300\nstatic void\nSiS300Sync(struct sis_video_info *ivideo)\n{\n\tSiS300Idle\n}\n\nstatic void\nSiS300SetupForScreenToScreenCopy(struct sis_video_info *ivideo, int xdir, int ydir,\n                                 int rop, int trans_color)\n{\n\tSiS300SetupDSTColorDepth(ivideo->DstColor);\n\tSiS300SetupSRCPitch(ivideo->video_linelength)\n\tSiS300SetupDSTRect(ivideo->video_linelength, 0xffff)\n\n\tif(trans_color != -1) {\n\t\tSiS300SetupROP(0x0A)\n\t\tSiS300SetupSRCTrans(trans_color)\n\t\tSiS300SetupCMDFlag(TRANSPARENT_BITBLT)\n\t} else {\n\t        SiS300SetupROP(sisALUConv[rop])\n\t}\n\tif(xdir > 0) {\n\t\tSiS300SetupCMDFlag(X_INC)\n\t}\n\tif(ydir > 0) {\n\t\tSiS300SetupCMDFlag(Y_INC)\n\t}\n}\n\nstatic void\nSiS300SubsequentScreenToScreenCopy(struct sis_video_info *ivideo, int src_x,\n\t\t\t\t   int src_y, int dst_x, int dst_y, int width, int height)\n{\n\tu32 srcbase = 0, dstbase = 0;\n\n\tif(src_y >= 2048) {\n\t\tsrcbase = ivideo->video_linelength * src_y;\n\t\tsrc_y = 0;\n\t}\n\tif(dst_y >= 2048) {\n\t\tdstbase = ivideo->video_linelength * dst_y;\n\t\tdst_y = 0;\n\t}\n\n\tSiS300SetupSRCBase(srcbase);\n\tSiS300SetupDSTBase(dstbase);\n\n\tif(!(ivideo->CommandReg & X_INC))  {\n\t\tsrc_x += width-1;\n\t\tdst_x += width-1;\n\t}\n\tif(!(ivideo->CommandReg & Y_INC))  {\n\t\tsrc_y += height-1;\n\t\tdst_y += height-1;\n\t}\n\tSiS300SetupRect(width, height)\n\tSiS300SetupSRCXY(src_x, src_y)\n\tSiS300SetupDSTXY(dst_x, dst_y)\n\tSiS300DoCMD\n}\n\nstatic void\nSiS300SetupForSolidFill(struct sis_video_info *ivideo, u32 color, int rop)\n{\n\tSiS300SetupPATFG(color)\n\tSiS300SetupDSTRect(ivideo->video_linelength, 0xffff)\n\tSiS300SetupDSTColorDepth(ivideo->DstColor);\n\tSiS300SetupROP(sisPatALUConv[rop])\n\tSiS300SetupCMDFlag(PATFG)\n}\n\nstatic void\nSiS300SubsequentSolidFillRect(struct sis_video_info *ivideo, int x, int y, int w, int h)\n{\n\tu32 dstbase = 0;\n\n\tif(y >= 2048) {\n\t\tdstbase = ivideo->video_linelength * y;\n\t\ty = 0;\n\t}\n\tSiS300SetupDSTBase(dstbase)\n\tSiS300SetupDSTXY(x,y)\n\tSiS300SetupRect(w,h)\n\tSiS300SetupCMDFlag(X_INC | Y_INC | BITBLT)\n\tSiS300DoCMD\n}\n#endif\n\n \n\n#ifdef CONFIG_FB_SIS_315\nstatic void\nSiS310Sync(struct sis_video_info *ivideo)\n{\n\tSiS310Idle\n}\n\nstatic void\nSiS310SetupForScreenToScreenCopy(struct sis_video_info *ivideo, int rop, int trans_color)\n{\n\tSiS310SetupDSTColorDepth(ivideo->DstColor);\n\tSiS310SetupSRCPitch(ivideo->video_linelength)\n\tSiS310SetupDSTRect(ivideo->video_linelength, 0x0fff)\n\tif(trans_color != -1) {\n\t\tSiS310SetupROP(0x0A)\n\t\tSiS310SetupSRCTrans(trans_color)\n\t\tSiS310SetupCMDFlag(TRANSPARENT_BITBLT)\n\t} else {\n\t        SiS310SetupROP(sisALUConv[rop])\n\t\t \n\t\t \n\t}\n\tSiS310SetupCMDFlag(ivideo->SiS310_AccelDepth)\n\t \n}\n\nstatic void\nSiS310SubsequentScreenToScreenCopy(struct sis_video_info *ivideo, int src_x, int src_y,\n\t\t\t int dst_x, int dst_y, int width, int height)\n{\n\tu32 srcbase = 0, dstbase = 0;\n\tint mymin = min(src_y, dst_y);\n\tint mymax = max(src_y, dst_y);\n\n\t \n\tif((mymax - mymin) < height) {\n\t\tif((src_y >= 2048) || (dst_y >= 2048)) {\n\t\t\tsrcbase = ivideo->video_linelength * mymin;\n\t\t\tdstbase = ivideo->video_linelength * mymin;\n\t\t\tsrc_y -= mymin;\n\t\t\tdst_y -= mymin;\n\t\t}\n\t} else {\n\t\tif(src_y >= 2048) {\n\t\t\tsrcbase = ivideo->video_linelength * src_y;\n\t\t\tsrc_y = 0;\n\t\t}\n\t\tif(dst_y >= 2048) {\n\t\t\tdstbase = ivideo->video_linelength * dst_y;\n\t\t\tdst_y = 0;\n\t\t}\n\t}\n\n\tsrcbase += ivideo->video_offset;\n\tdstbase += ivideo->video_offset;\n\n\tSiS310SetupSRCBase(srcbase);\n\tSiS310SetupDSTBase(dstbase);\n\tSiS310SetupRect(width, height)\n\tSiS310SetupSRCXY(src_x, src_y)\n\tSiS310SetupDSTXY(dst_x, dst_y)\n\tSiS310DoCMD\n}\n\nstatic void\nSiS310SetupForSolidFill(struct sis_video_info *ivideo, u32 color, int rop)\n{\n\tSiS310SetupPATFG(color)\n\tSiS310SetupDSTRect(ivideo->video_linelength, 0x0fff)\n\tSiS310SetupDSTColorDepth(ivideo->DstColor);\n\tSiS310SetupROP(sisPatALUConv[rop])\n\tSiS310SetupCMDFlag(PATFG | ivideo->SiS310_AccelDepth)\n}\n\nstatic void\nSiS310SubsequentSolidFillRect(struct sis_video_info *ivideo, int x, int y, int w, int h)\n{\n\tu32 dstbase = 0;\n\n\tif(y >= 2048) {\n\t\tdstbase = ivideo->video_linelength * y;\n\t\ty = 0;\n\t}\n\tdstbase += ivideo->video_offset;\n\tSiS310SetupDSTBase(dstbase)\n\tSiS310SetupDSTXY(x,y)\n\tSiS310SetupRect(w,h)\n\tSiS310SetupCMDFlag(BITBLT)\n\tSiS310DoCMD\n}\n#endif\n\n \n\n \n\nint sisfb_initaccel(struct sis_video_info *ivideo)\n{\n#ifdef SISFB_USE_SPINLOCKS\n\tspin_lock_init(&ivideo->lockaccel);\n#endif\n\treturn 0;\n}\n\nvoid sisfb_syncaccel(struct sis_video_info *ivideo)\n{\n\tif(ivideo->sisvga_engine == SIS_300_VGA) {\n#ifdef CONFIG_FB_SIS_300\n\t\tSiS300Sync(ivideo);\n#endif\n\t} else {\n#ifdef CONFIG_FB_SIS_315\n\t\tSiS310Sync(ivideo);\n#endif\n\t}\n}\n\nint fbcon_sis_sync(struct fb_info *info)\n{\n\tstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\n\tCRITFLAGS\n\n\tif((!ivideo->accel) || (!ivideo->engineok))\n\t\treturn 0;\n\n\tCRITBEGIN\n\tsisfb_syncaccel(ivideo);\n\tCRITEND\n\n\treturn 0;\n}\n\nvoid fbcon_sis_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\n{\n\tstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\n\tu32 col = 0;\n\tu32 vxres = info->var.xres_virtual;\n\tu32 vyres = info->var.yres_virtual;\n\tint width, height;\n\tCRITFLAGS\n\n\tif(info->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\n\tif((!ivideo->accel) || (!ivideo->engineok)) {\n\t\tcfb_fillrect(info, rect);\n\t\treturn;\n\t}\n\n\tif(!rect->width || !rect->height || rect->dx >= vxres || rect->dy >= vyres)\n\t\treturn;\n\n\t \n\twidth = ((rect->dx + rect->width) > vxres) ? (vxres - rect->dx) : rect->width;\n\theight = ((rect->dy + rect->height) > vyres) ? (vyres - rect->dy) : rect->height;\n\n\tswitch(info->var.bits_per_pixel) {\n\tcase 8:  col = rect->color;\n\t\t break;\n\tcase 16:\n\tcase 32: col = ((u32 *)(info->pseudo_palette))[rect->color];\n\t\t break;\n\t}\n\n\tif(ivideo->sisvga_engine == SIS_300_VGA) {\n#ifdef CONFIG_FB_SIS_300\n\t\tCRITBEGIN\n\t\tSiS300SetupForSolidFill(ivideo, col, myrops[rect->rop]);\n\t\tSiS300SubsequentSolidFillRect(ivideo, rect->dx, rect->dy, width, height);\n\t\tCRITEND\n#endif\n\t} else {\n#ifdef CONFIG_FB_SIS_315\n\t\tCRITBEGIN\n\t\tSiS310SetupForSolidFill(ivideo, col, myrops[rect->rop]);\n\t\tSiS310SubsequentSolidFillRect(ivideo, rect->dx, rect->dy, width, height);\n\t\tCRITEND\n#endif\n\t}\n\n\tsisfb_syncaccel(ivideo);\n}\n\nvoid fbcon_sis_copyarea(struct fb_info *info, const struct fb_copyarea *area)\n{\n\tstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\n\tu32 vxres = info->var.xres_virtual;\n\tu32 vyres = info->var.yres_virtual;\n\tint width = area->width;\n\tint height = area->height;\n\tCRITFLAGS\n\n\tif(info->state != FBINFO_STATE_RUNNING)\n\t\treturn;\n\n\tif((!ivideo->accel) || (!ivideo->engineok)) {\n\t\tcfb_copyarea(info, area);\n\t\treturn;\n\t}\n\n\tif(!width || !height ||\n\t   area->sx >= vxres || area->sy >= vyres ||\n\t   area->dx >= vxres || area->dy >= vyres)\n\t\treturn;\n\n\t \n\tif((area->sx + width) > vxres) width = vxres - area->sx;\n\tif((area->dx + width) > vxres) width = vxres - area->dx;\n\tif((area->sy + height) > vyres) height = vyres - area->sy;\n\tif((area->dy + height) > vyres) height = vyres - area->dy;\n\n\tif(ivideo->sisvga_engine == SIS_300_VGA) {\n#ifdef CONFIG_FB_SIS_300\n\t\tint xdir, ydir;\n\n\t\tif(area->sx < area->dx) xdir = 0;\n\t\telse                    xdir = 1;\n\t\tif(area->sy < area->dy) ydir = 0;\n\t\telse                    ydir = 1;\n\n\t\tCRITBEGIN\n\t\tSiS300SetupForScreenToScreenCopy(ivideo, xdir, ydir, 3, -1);\n\t\tSiS300SubsequentScreenToScreenCopy(ivideo, area->sx, area->sy,\n\t\t\t\t\tarea->dx, area->dy, width, height);\n\t\tCRITEND\n#endif\n\t} else {\n#ifdef CONFIG_FB_SIS_315\n\t\tCRITBEGIN\n\t\tSiS310SetupForScreenToScreenCopy(ivideo, 3, -1);\n\t\tSiS310SubsequentScreenToScreenCopy(ivideo, area->sx, area->sy,\n\t\t\t\t\tarea->dx, area->dy, width, height);\n\t\tCRITEND\n#endif\n\t}\n\n\tsisfb_syncaccel(ivideo);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}