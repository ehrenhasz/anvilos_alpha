{
  "module_name": "lcd.c",
  "hash_id": "0809b46d832c079431436c82d1c7d86e7da7b7abe02b10b3a6a8563c61b0c46f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/via/lcd.c",
  "human_readable_source": "\n \n#include <linux/via-core.h>\n#include <linux/via_i2c.h>\n#include \"global.h\"\n\n#define viafb_compact_res(x, y) (((x)<<16)|(y))\n\n \n \nstatic const int PowerSequenceOn[3][3] = {\n\t{0x10, 0x08, 0x06}, {0x10, 0x08, 0x06},\t{0x19, 0x1FE, 0x01}\n};\nstatic const int PowerSequenceOff[3][3] = {\n\t{0x06, 0x08, 0x10}, {0x00, 0x00, 0x00},\t{0xD2, 0x19, 0x01}\n};\n\nstatic struct _lcd_scaling_factor lcd_scaling_factor = {\n\t \n\t{LCD_HOR_SCALING_FACTOR_REG_NUM,\n\t {{CR9F, 0, 1}, {CR77, 0, 7}, {CR79, 4, 5} } },\n\t \n\t{LCD_VER_SCALING_FACTOR_REG_NUM,\n\t {{CR79, 3, 3}, {CR78, 0, 7}, {CR79, 6, 7} } }\n};\nstatic struct _lcd_scaling_factor lcd_scaling_factor_CLE = {\n\t \n\t{LCD_HOR_SCALING_FACTOR_REG_NUM_CLE, {{CR77, 0, 7}, {CR79, 4, 5} } },\n\t \n\t{LCD_VER_SCALING_FACTOR_REG_NUM_CLE, {{CR78, 0, 7}, {CR79, 6, 7} } }\n};\n\nstatic bool lvds_identify_integratedlvds(void);\nstatic void fp_id_to_vindex(int panel_id);\nstatic int lvds_register_read(int index);\nstatic void load_lcd_scaling(int set_hres, int set_vres, int panel_hres,\n\t\t      int panel_vres);\nstatic void lcd_patch_skew_dvp0(struct lvds_setting_information\n\t\t\t *plvds_setting_info,\n\t\t\t struct lvds_chip_information *plvds_chip_info);\nstatic void lcd_patch_skew_dvp1(struct lvds_setting_information\n\t\t\t *plvds_setting_info,\n\t\t\t struct lvds_chip_information *plvds_chip_info);\nstatic void lcd_patch_skew(struct lvds_setting_information\n\t*plvds_setting_info, struct lvds_chip_information *plvds_chip_info);\n\nstatic void integrated_lvds_disable(struct lvds_setting_information\n\t\t\t     *plvds_setting_info,\n\t\t\t     struct lvds_chip_information *plvds_chip_info);\nstatic void integrated_lvds_enable(struct lvds_setting_information\n\t\t\t    *plvds_setting_info,\n\t\t\t    struct lvds_chip_information *plvds_chip_info);\nstatic void lcd_powersequence_off(void);\nstatic void lcd_powersequence_on(void);\nstatic void fill_lcd_format(void);\nstatic void check_diport_of_integrated_lvds(\n\tstruct lvds_chip_information *plvds_chip_info,\n\t\t\t\t     struct lvds_setting_information\n\t\t\t\t     *plvds_setting_info);\n\nstatic inline bool check_lvds_chip(int device_id_subaddr, int device_id)\n{\n\treturn lvds_register_read(device_id_subaddr) == device_id;\n}\n\nvoid viafb_init_lcd_size(void)\n{\n\tDEBUG_MSG(KERN_INFO \"viafb_init_lcd_size()\\n\");\n\n\tfp_id_to_vindex(viafb_lcd_panel_id);\n\tviaparinfo->lvds_setting_info2->lcd_panel_hres =\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres;\n\tviaparinfo->lvds_setting_info2->lcd_panel_vres =\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres;\n\tviaparinfo->lvds_setting_info2->device_lcd_dualedge =\n\t    viaparinfo->lvds_setting_info->device_lcd_dualedge;\n\tviaparinfo->lvds_setting_info2->LCDDithering =\n\t\tviaparinfo->lvds_setting_info->LCDDithering;\n}\n\nstatic bool lvds_identify_integratedlvds(void)\n{\n\tif (viafb_display_hardware_layout == HW_LAYOUT_LCD_EXTERNAL_LCD2) {\n\t\t \n\t\t \n\t\tif (viaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\n\t\t\tviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name =\n\t\t\t    INTEGRATED_LVDS;\n\t\t\tDEBUG_MSG(KERN_INFO \"Support two dual channel LVDS! \"\n\t\t\t\t  \"(Internal LVDS + External LVDS)\\n\");\n\t\t} else {\n\t\t\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\n\t\t\t    INTEGRATED_LVDS;\n\t\t\tDEBUG_MSG(KERN_INFO \"Not found external LVDS, \"\n\t\t\t\t  \"so can't support two dual channel LVDS!\\n\");\n\t\t}\n\t} else if (viafb_display_hardware_layout == HW_LAYOUT_LCD1_LCD2) {\n\t\t \n\t\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\n\t\tINTEGRATED_LVDS;\n\t\tviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name =\n\t\t\tINTEGRATED_LVDS;\n\t\tDEBUG_MSG(KERN_INFO \"Support two single channel LVDS! \"\n\t\t\t  \"(Internal LVDS + Internal LVDS)\\n\");\n\t} else if (viafb_display_hardware_layout != HW_LAYOUT_DVI_ONLY) {\n\t\t \n\t\tif (!viaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\n\t\t\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\n\t\t\t    INTEGRATED_LVDS;\n\t\t\tDEBUG_MSG(KERN_INFO \"Found Integrated LVDS!\\n\");\n\t\t}\n\t} else {\n\t\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\n\t\t\tNON_LVDS_TRANSMITTER;\n\t\tDEBUG_MSG(KERN_INFO \"Do not support LVDS!\\n\");\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nbool viafb_lvds_trasmitter_identify(void)\n{\n\tif (viafb_lvds_identify_vt1636(VIA_PORT_31)) {\n\t\tviaparinfo->chip_info->lvds_chip_info.i2c_port = VIA_PORT_31;\n\t\tDEBUG_MSG(KERN_INFO\n\t\t\t  \"Found VIA VT1636 LVDS on port i2c 0x31\\n\");\n\t} else {\n\t\tif (viafb_lvds_identify_vt1636(VIA_PORT_2C)) {\n\t\t\tviaparinfo->chip_info->lvds_chip_info.i2c_port =\n\t\t\t\tVIA_PORT_2C;\n\t\t\tDEBUG_MSG(KERN_INFO\n\t\t\t\t  \"Found VIA VT1636 LVDS on port gpio 0x2c\\n\");\n\t\t}\n\t}\n\n\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700)\n\t\tlvds_identify_integratedlvds();\n\n\tif (viaparinfo->chip_info->lvds_chip_info.lvds_chip_name)\n\t\treturn true;\n\t \n\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name = VT1631_LVDS;\n\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_slave_addr =\n\t\tVT1631_LVDS_I2C_ADDR;\n\n\tif (check_lvds_chip(VT1631_DEVICE_ID_REG, VT1631_DEVICE_ID)) {\n\t\tDEBUG_MSG(KERN_INFO \"\\n VT1631 LVDS ! \\n\");\n\t\tDEBUG_MSG(KERN_INFO \"\\n %2d\",\n\t\t\t  viaparinfo->chip_info->lvds_chip_info.lvds_chip_name);\n\t\tDEBUG_MSG(KERN_INFO \"\\n %2d\",\n\t\t\t  viaparinfo->chip_info->lvds_chip_info.lvds_chip_name);\n\t\treturn true;\n\t}\n\n\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\n\t\tNON_LVDS_TRANSMITTER;\n\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_slave_addr =\n\t\tVT1631_LVDS_I2C_ADDR;\n\treturn false;\n}\n\nstatic void fp_id_to_vindex(int panel_id)\n{\n\tDEBUG_MSG(KERN_INFO \"fp_get_panel_id()\\n\");\n\n\tif (panel_id > LCD_PANEL_ID_MAXIMUM)\n\t\tviafb_lcd_panel_id = panel_id =\n\t\tviafb_read_reg(VIACR, CR3F) & 0x0F;\n\n\tswitch (panel_id) {\n\tcase 0x0:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 640;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 480;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x1:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 800;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 600;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x2:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x3:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x4:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 1024;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x5:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1400;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 1050;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x6:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1600;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 1200;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x8:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 800;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 480;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x9:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0xA:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0xB:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0xC:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0xD:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 1024;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0xE:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1400;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 1050;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0xF:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1600;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 1200;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0x10:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1366;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0x11:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 600;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x12:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x13:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 800;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x14:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1360;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0x15:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tcase 0x16:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 480;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 640;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t\tbreak;\n\tcase 0x17:\n\t\t \n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 1200;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 900;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 0;\n\t\tbreak;\n\tdefault:\n\t\tviaparinfo->lvds_setting_info->lcd_panel_hres = 800;\n\t\tviaparinfo->lvds_setting_info->lcd_panel_vres = 600;\n\t\tviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\n\t\tviaparinfo->lvds_setting_info->LCDDithering = 1;\n\t}\n}\n\nstatic int lvds_register_read(int index)\n{\n\tu8 data;\n\n\tviafb_i2c_readbyte(VIA_PORT_2C,\n\t\t\t(u8) viaparinfo->chip_info->lvds_chip_info.lvds_chip_slave_addr,\n\t\t\t(u8) index, &data);\n\treturn data;\n}\n\nstatic void load_lcd_scaling(int set_hres, int set_vres, int panel_hres,\n\t\t      int panel_vres)\n{\n\tint reg_value = 0;\n\tint viafb_load_reg_num;\n\tstruct io_register *reg = NULL;\n\n\tDEBUG_MSG(KERN_INFO \"load_lcd_scaling()!!\\n\");\n\n\t \n\tviafb_write_reg_mask(CR79, VIACR, 0x07, BIT0 + BIT1 + BIT2);\n\n\t \n\tif (set_hres < panel_hres) {\n\t\t \n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_CLE266:\n\t\tcase UNICHROME_K400:\n\t\t\treg_value =\n\t\t\t    CLE266_LCD_HOR_SCF_FORMULA(set_hres, panel_hres);\n\t\t\tviafb_load_reg_num =\n\t\t\t    lcd_scaling_factor_CLE.lcd_hor_scaling_factor.\n\t\t\t    reg_num;\n\t\t\treg = lcd_scaling_factor_CLE.lcd_hor_scaling_factor.reg;\n\t\t\tviafb_load_reg(reg_value,\n\t\t\t\tviafb_load_reg_num, reg, VIACR);\n\t\t\tbreak;\n\t\tcase UNICHROME_K800:\n\t\tcase UNICHROME_PM800:\n\t\tcase UNICHROME_CN700:\n\t\tcase UNICHROME_CX700:\n\t\tcase UNICHROME_K8M890:\n\t\tcase UNICHROME_P4M890:\n\t\tcase UNICHROME_P4M900:\n\t\tcase UNICHROME_CN750:\n\t\tcase UNICHROME_VX800:\n\t\tcase UNICHROME_VX855:\n\t\tcase UNICHROME_VX900:\n\t\t\treg_value =\n\t\t\t    K800_LCD_HOR_SCF_FORMULA(set_hres, panel_hres);\n\t\t\t \n\t\t\tviafb_write_reg_mask(CRA2, VIACR, 0xC0, BIT7 + BIT6);\n\t\t\tviafb_load_reg_num =\n\t\t\t    lcd_scaling_factor.lcd_hor_scaling_factor.reg_num;\n\t\t\treg = lcd_scaling_factor.lcd_hor_scaling_factor.reg;\n\t\t\tviafb_load_reg(reg_value,\n\t\t\t\tviafb_load_reg_num, reg, VIACR);\n\t\t\tbreak;\n\t\t}\n\n\t\tDEBUG_MSG(KERN_INFO \"Horizontal Scaling value = %d\", reg_value);\n\t} else {\n\t\t \n\t\tviafb_write_reg_mask(CRA2, VIACR, 0x00, BIT7);\n\t}\n\n\t \n\tif (set_vres < panel_vres) {\n\t\t \n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_CLE266:\n\t\tcase UNICHROME_K400:\n\t\t\treg_value =\n\t\t\t    CLE266_LCD_VER_SCF_FORMULA(set_vres, panel_vres);\n\t\t\tviafb_load_reg_num =\n\t\t\t    lcd_scaling_factor_CLE.lcd_ver_scaling_factor.\n\t\t\t    reg_num;\n\t\t\treg = lcd_scaling_factor_CLE.lcd_ver_scaling_factor.reg;\n\t\t\tviafb_load_reg(reg_value,\n\t\t\t\tviafb_load_reg_num, reg, VIACR);\n\t\t\tbreak;\n\t\tcase UNICHROME_K800:\n\t\tcase UNICHROME_PM800:\n\t\tcase UNICHROME_CN700:\n\t\tcase UNICHROME_CX700:\n\t\tcase UNICHROME_K8M890:\n\t\tcase UNICHROME_P4M890:\n\t\tcase UNICHROME_P4M900:\n\t\tcase UNICHROME_CN750:\n\t\tcase UNICHROME_VX800:\n\t\tcase UNICHROME_VX855:\n\t\tcase UNICHROME_VX900:\n\t\t\treg_value =\n\t\t\t    K800_LCD_VER_SCF_FORMULA(set_vres, panel_vres);\n\t\t\t \n\t\t\tviafb_write_reg_mask(CRA2, VIACR, 0x08, BIT3);\n\t\t\tviafb_load_reg_num =\n\t\t\t    lcd_scaling_factor.lcd_ver_scaling_factor.reg_num;\n\t\t\treg = lcd_scaling_factor.lcd_ver_scaling_factor.reg;\n\t\t\tviafb_load_reg(reg_value,\n\t\t\t\tviafb_load_reg_num, reg, VIACR);\n\t\t\tbreak;\n\t\t}\n\n\t\tDEBUG_MSG(KERN_INFO \"Vertical Scaling value = %d\", reg_value);\n\t} else {\n\t\t \n\t\tviafb_write_reg_mask(CRA2, VIACR, 0x00, BIT3);\n\t}\n}\n\nstatic void via_pitch_alignment_patch_lcd(int iga_path, int hres, int bpp)\n{\n\tunsigned char cr13, cr35, cr65, cr66, cr67;\n\tunsigned long dwScreenPitch = 0;\n\tunsigned long dwPitch;\n\n\tdwPitch = hres * (bpp >> 3);\n\tif (dwPitch & 0x1F) {\n\t\tdwScreenPitch = ((dwPitch + 31) & ~31) >> 3;\n\t\tif (iga_path == IGA2) {\n\t\t\tif (bpp > 8) {\n\t\t\t\tcr66 = (unsigned char)(dwScreenPitch & 0xFF);\n\t\t\t\tviafb_write_reg(CR66, VIACR, cr66);\n\t\t\t\tcr67 = viafb_read_reg(VIACR, CR67) & 0xFC;\n\t\t\t\tcr67 |=\n\t\t\t\t    (unsigned\n\t\t\t\t     char)((dwScreenPitch & 0x300) >> 8);\n\t\t\t\tviafb_write_reg(CR67, VIACR, cr67);\n\t\t\t}\n\n\t\t\t \n\t\t\tcr67 = viafb_read_reg(VIACR, CR67) & 0xF3;\n\t\t\tcr67 |= (unsigned char)((dwScreenPitch & 0x600) >> 7);\n\t\t\tviafb_write_reg(CR67, VIACR, cr67);\n\t\t\tcr65 = (unsigned char)((dwScreenPitch >> 1) & 0xFF);\n\t\t\tcr65 += 2;\n\t\t\tviafb_write_reg(CR65, VIACR, cr65);\n\t\t} else {\n\t\t\tif (bpp > 8) {\n\t\t\t\tcr13 = (unsigned char)(dwScreenPitch & 0xFF);\n\t\t\t\tviafb_write_reg(CR13, VIACR, cr13);\n\t\t\t\tcr35 = viafb_read_reg(VIACR, CR35) & 0x1F;\n\t\t\t\tcr35 |=\n\t\t\t\t    (unsigned\n\t\t\t\t     char)((dwScreenPitch & 0x700) >> 3);\n\t\t\t\tviafb_write_reg(CR35, VIACR, cr35);\n\t\t\t}\n\t\t}\n\t}\n}\nstatic void lcd_patch_skew_dvp0(struct lvds_setting_information\n\t\t\t *plvds_setting_info,\n\t\t\t struct lvds_chip_information *plvds_chip_info)\n{\n\tif (VT1636_LVDS == plvds_chip_info->lvds_chip_name) {\n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_P4M900:\n\t\t\tviafb_vt1636_patch_skew_on_vt3364(plvds_setting_info,\n\t\t\t\t\t\t    plvds_chip_info);\n\t\t\tbreak;\n\t\tcase UNICHROME_P4M890:\n\t\t\tviafb_vt1636_patch_skew_on_vt3327(plvds_setting_info,\n\t\t\t\t\t\t    plvds_chip_info);\n\t\t\tbreak;\n\t\t}\n\t}\n}\nstatic void lcd_patch_skew_dvp1(struct lvds_setting_information\n\t\t\t *plvds_setting_info,\n\t\t\t struct lvds_chip_information *plvds_chip_info)\n{\n\tif (VT1636_LVDS == plvds_chip_info->lvds_chip_name) {\n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_CX700:\n\t\t\tviafb_vt1636_patch_skew_on_vt3324(plvds_setting_info,\n\t\t\t\t\t\t    plvds_chip_info);\n\t\t\tbreak;\n\t\t}\n\t}\n}\nstatic void lcd_patch_skew(struct lvds_setting_information\n\t*plvds_setting_info, struct lvds_chip_information *plvds_chip_info)\n{\n\tDEBUG_MSG(KERN_INFO \"lcd_patch_skew\\n\");\n\tswitch (plvds_chip_info->output_interface) {\n\tcase INTERFACE_DVP0:\n\t\tlcd_patch_skew_dvp0(plvds_setting_info, plvds_chip_info);\n\t\tbreak;\n\tcase INTERFACE_DVP1:\n\t\tlcd_patch_skew_dvp1(plvds_setting_info, plvds_chip_info);\n\t\tbreak;\n\tcase INTERFACE_DFP_LOW:\n\t\tif (UNICHROME_P4M900 == viaparinfo->chip_info->gfx_chip_name) {\n\t\t\tviafb_write_reg_mask(CR99, VIACR, 0x08,\n\t\t\t\t       BIT0 + BIT1 + BIT2 + BIT3);\n\t\t}\n\t\tbreak;\n\t}\n}\n\n \nvoid viafb_lcd_set_mode(const struct fb_var_screeninfo *var, u16 cxres,\n\tu16 cyres, struct lvds_setting_information *plvds_setting_info,\n\tstruct lvds_chip_information *plvds_chip_info)\n{\n\tint set_iga = plvds_setting_info->iga_path;\n\tint mode_bpp = var->bits_per_pixel;\n\tint set_hres = cxres ? cxres : var->xres;\n\tint set_vres = cyres ? cyres : var->yres;\n\tint panel_hres = plvds_setting_info->lcd_panel_hres;\n\tint panel_vres = plvds_setting_info->lcd_panel_vres;\n\tu32 clock;\n\tstruct via_display_timing timing;\n\tstruct fb_var_screeninfo panel_var;\n\tconst struct fb_videomode *panel_crt_table;\n\n\tDEBUG_MSG(KERN_INFO \"viafb_lcd_set_mode!!\\n\");\n\t \n\tpanel_crt_table = viafb_get_best_mode(panel_hres, panel_vres, 60);\n\tviafb_fill_var_timing_info(&panel_var, panel_crt_table);\n\tDEBUG_MSG(KERN_INFO \"below viafb_lcd_set_mode!!\\n\");\n\tif (VT1636_LVDS == plvds_chip_info->lvds_chip_name)\n\t\tviafb_init_lvds_vt1636(plvds_setting_info, plvds_chip_info);\n\tclock = PICOS2KHZ(panel_crt_table->pixclock) * 1000;\n\tplvds_setting_info->vclk = clock;\n\n\tif (set_iga == IGA2 && (set_hres < panel_hres || set_vres < panel_vres)\n\t\t&& plvds_setting_info->display_method == LCD_EXPANDSION) {\n\t\ttiming = var_to_timing(&panel_var, panel_hres, panel_vres);\n\t\tload_lcd_scaling(set_hres, set_vres, panel_hres, panel_vres);\n\t} else {\n\t\ttiming = var_to_timing(&panel_var, set_hres, set_vres);\n\t\tif (set_iga == IGA2)\n\t\t\t \n\t\t\tvia_write_reg_mask(VIACR, 0x79, 0x00,\n\t\t\t\tBIT0 + BIT1 + BIT2);\n\t}\n\n\tif (set_iga == IGA1)\n\t\tvia_set_primary_timing(&timing);\n\telse if (set_iga == IGA2)\n\t\tvia_set_secondary_timing(&timing);\n\n\t \n\tviafb_load_fetch_count_reg(set_hres, mode_bpp / 8, set_iga);\n\n\tif ((viaparinfo->chip_info->gfx_chip_name != UNICHROME_CLE266)\n\t\t&& (viaparinfo->chip_info->gfx_chip_name != UNICHROME_K400))\n\t\tviafb_load_FIFO_reg(set_iga, set_hres, set_vres);\n\n\tfill_lcd_format();\n\tviafb_set_vclock(clock, set_iga);\n\tlcd_patch_skew(plvds_setting_info, plvds_chip_info);\n\n\t \n\tif ((viaparinfo->chip_info->gfx_chip_name == UNICHROME_K800)\n\t    || (UNICHROME_K8M890 == viaparinfo->chip_info->gfx_chip_name))\n\t\tviafb_write_reg_mask(CR6A, VIACR, 0x01, BIT0);\n\n\t \n\tvia_pitch_alignment_patch_lcd(plvds_setting_info->iga_path, set_hres,\n\t\tvar->bits_per_pixel);\n}\n\nstatic void integrated_lvds_disable(struct lvds_setting_information\n\t\t\t     *plvds_setting_info,\n\t\t\t     struct lvds_chip_information *plvds_chip_info)\n{\n\tbool turn_off_first_powersequence = false;\n\tbool turn_off_second_powersequence = false;\n\tif (INTERFACE_LVDS0LVDS1 == plvds_chip_info->output_interface)\n\t\tturn_off_first_powersequence = true;\n\tif (INTERFACE_LVDS0 == plvds_chip_info->output_interface)\n\t\tturn_off_first_powersequence = true;\n\tif (INTERFACE_LVDS1 == plvds_chip_info->output_interface)\n\t\tturn_off_second_powersequence = true;\n\tif (turn_off_second_powersequence) {\n\t\t \n\n\t\t \n\t\tviafb_write_reg_mask(CRD4, VIACR, 0, BIT1);\n\n\t\t \n\t\tviafb_write_reg_mask(CRD3, VIACR, 0xC0, BIT6 + BIT7);\n\t}\n\tif (turn_off_first_powersequence) {\n\t\t \n\n\t\t \n\t\tviafb_write_reg_mask(CR6A, VIACR, 0, BIT3);\n\n\t\t \n\t\tviafb_write_reg_mask(CR91, VIACR, 0xC0, BIT6 + BIT7);\n\t}\n\n\t \n\tswitch (plvds_chip_info->output_interface) {\n\tcase INTERFACE_LVDS0:\n\t\t{\n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0x80, BIT7);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_LVDS1:\n\t\t{\n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0x40, BIT6);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_LVDS0LVDS1:\n\t\t{\n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0xC0, BIT6 + BIT7);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void integrated_lvds_enable(struct lvds_setting_information\n\t\t\t    *plvds_setting_info,\n\t\t\t    struct lvds_chip_information *plvds_chip_info)\n{\n\tDEBUG_MSG(KERN_INFO \"integrated_lvds_enable, out_interface:%d\\n\",\n\t\t  plvds_chip_info->output_interface);\n\tif (plvds_setting_info->lcd_mode == LCD_SPWG)\n\t\tviafb_write_reg_mask(CRD2, VIACR, 0x00, BIT0 + BIT1);\n\telse\n\t\tviafb_write_reg_mask(CRD2, VIACR, 0x03, BIT0 + BIT1);\n\n\tswitch (plvds_chip_info->output_interface) {\n\tcase INTERFACE_LVDS0LVDS1:\n\tcase INTERFACE_LVDS0:\n\t\t \n\t\t \n\t\tviafb_write_reg_mask(CR91, VIACR, 0, BIT0);\n\t\t \n\t\tviafb_write_reg_mask(CR91, VIACR, 0, BIT6 + BIT7);\n\t\t \n\t\tviafb_write_reg_mask(CR6A, VIACR, 0x08, BIT3);\n\t\tbreak;\n\tcase INTERFACE_LVDS1:\n\t\t \n\t\t \n\t\tviafb_write_reg_mask(CRD3, VIACR, 0, BIT0);\n\t\t \n\t\tviafb_write_reg_mask(CRD3, VIACR, 0, BIT6 + BIT7);\n\t\t \n\t\tviafb_write_reg_mask(CRD4, VIACR, 0x02, BIT1);\n\t\tbreak;\n\t}\n\n\t \n\tswitch (plvds_chip_info->output_interface) {\n\tcase INTERFACE_LVDS0:\n\t\t{\n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0, BIT7);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_LVDS1:\n\t\t{\n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0, BIT6);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_LVDS0LVDS1:\n\t\t{\n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0, BIT6 + BIT7);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nvoid viafb_lcd_disable(void)\n{\n\n\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266) {\n\t\tlcd_powersequence_off();\n\t\t \n\t\tviafb_write_reg_mask(SR1E, VIASR, 0x00, 0x30);\n\t} else if (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\n\t\tif (viafb_LCD2_ON\n\t\t    && (INTEGRATED_LVDS ==\n\t\t\tviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name))\n\t\t\tintegrated_lvds_disable(viaparinfo->lvds_setting_info,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info2);\n\t\tif (INTEGRATED_LVDS ==\n\t\t\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name)\n\t\t\tintegrated_lvds_disable(viaparinfo->lvds_setting_info,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info);\n\t\tif (VT1636_LVDS == viaparinfo->chip_info->\n\t\t\tlvds_chip_info.lvds_chip_name)\n\t\t\tviafb_disable_lvds_vt1636(viaparinfo->lvds_setting_info,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info);\n\t} else if (VT1636_LVDS ==\n\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\n\t\tviafb_disable_lvds_vt1636(viaparinfo->lvds_setting_info,\n\t\t\t\t    &viaparinfo->chip_info->lvds_chip_info);\n\t} else {\n\t\t \n\t\tviafb_write_reg_mask(SR3D, VIASR, 0x00, 0x20);\n\t\t \n\t\tviafb_write_reg_mask(CR91, VIACR, 0x80, 0x80);\n\t}\n\n\t \n\tviafb_write_reg_mask(CR79, VIACR, 0x00, 0x01);\n\t \n\tviafb_write_reg_mask(CR6B, VIACR, 0x00, 0x08);\n}\n\nstatic void set_lcd_output_path(int set_iga, int output_interface)\n{\n\tswitch (output_interface) {\n\tcase INTERFACE_DFP:\n\t\tif ((UNICHROME_K8M890 == viaparinfo->chip_info->gfx_chip_name)\n\t\t    || (UNICHROME_P4M890 ==\n\t\t    viaparinfo->chip_info->gfx_chip_name))\n\t\t\tviafb_write_reg_mask(CR97, VIACR, 0x84,\n\t\t\t\t       BIT7 + BIT2 + BIT1 + BIT0);\n\t\tfallthrough;\n\tcase INTERFACE_DVP0:\n\tcase INTERFACE_DVP1:\n\tcase INTERFACE_DFP_HIGH:\n\tcase INTERFACE_DFP_LOW:\n\t\tif (set_iga == IGA2)\n\t\t\tviafb_write_reg(CR91, VIACR, 0x00);\n\t\tbreak;\n\t}\n}\n\nvoid viafb_lcd_enable(void)\n{\n\tviafb_write_reg_mask(CR6B, VIACR, 0x00, BIT3);\n\tviafb_write_reg_mask(CR6A, VIACR, 0x08, BIT3);\n\tset_lcd_output_path(viaparinfo->lvds_setting_info->iga_path,\n\t\tviaparinfo->chip_info->lvds_chip_info.output_interface);\n\tif (viafb_LCD2_ON)\n\t\tset_lcd_output_path(viaparinfo->lvds_setting_info2->iga_path,\n\t\t\tviaparinfo->chip_info->\n\t\t\tlvds_chip_info2.output_interface);\n\n\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266) {\n\t\t \n\t\tviafb_write_reg_mask(SR1E, VIASR, 0x30, 0x30);\n\t\tlcd_powersequence_on();\n\t} else if (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\n\t\tif (viafb_LCD2_ON && (INTEGRATED_LVDS ==\n\t\t\tviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name))\n\t\t\tintegrated_lvds_enable(viaparinfo->lvds_setting_info2, \\\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info2);\n\t\tif (INTEGRATED_LVDS ==\n\t\t\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name)\n\t\t\tintegrated_lvds_enable(viaparinfo->lvds_setting_info,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info);\n\t\tif (VT1636_LVDS == viaparinfo->chip_info->\n\t\t\tlvds_chip_info.lvds_chip_name)\n\t\t\tviafb_enable_lvds_vt1636(viaparinfo->\n\t\t\tlvds_setting_info, &viaparinfo->chip_info->\n\t\t\tlvds_chip_info);\n\t} else if (VT1636_LVDS ==\n\tviaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\n\t\tviafb_enable_lvds_vt1636(viaparinfo->lvds_setting_info,\n\t\t\t\t   &viaparinfo->chip_info->lvds_chip_info);\n\t} else {\n\t\t \n\t\tviafb_write_reg_mask(SR3D, VIASR, 0x20, 0x20);\n\t\t \n\t\tviafb_write_reg_mask(CR91, VIACR, 0x00, 0x80);\n\t\t \n\t\tviafb_write_reg_mask(CR6A, VIACR, 0x48, 0x48);\n\t}\n}\n\nstatic void lcd_powersequence_off(void)\n{\n\tint i, mask, data;\n\n\t \n\tviafb_write_reg_mask(CR91, VIACR, 0x11, 0x11);\n\n\tfor (i = 0; i < 3; i++) {\n\t\tmask = PowerSequenceOff[0][i];\n\t\tdata = PowerSequenceOff[1][i] & mask;\n\t\tviafb_write_reg_mask(CR91, VIACR, (u8) data, (u8) mask);\n\t\tudelay(PowerSequenceOff[2][i]);\n\t}\n\n\t \n\tviafb_write_reg_mask(CR6A, VIACR, 0x00, 0x08);\n}\n\nstatic void lcd_powersequence_on(void)\n{\n\tint i, mask, data;\n\n\t \n\tviafb_write_reg_mask(CR91, VIACR, 0x11, 0x11);\n\n\t \n\tviafb_write_reg_mask(CR6A, VIACR, 0x08, 0x08);\n\n\tfor (i = 0; i < 3; i++) {\n\t\tmask = PowerSequenceOn[0][i];\n\t\tdata = PowerSequenceOn[1][i] & mask;\n\t\tviafb_write_reg_mask(CR91, VIACR, (u8) data, (u8) mask);\n\t\tudelay(PowerSequenceOn[2][i]);\n\t}\n\n\tudelay(1);\n}\n\nstatic void fill_lcd_format(void)\n{\n\tu8 bdithering = 0, bdual = 0;\n\n\tif (viaparinfo->lvds_setting_info->device_lcd_dualedge)\n\t\tbdual = BIT4;\n\tif (viaparinfo->lvds_setting_info->LCDDithering)\n\t\tbdithering = BIT0;\n\t \n\tviafb_write_reg_mask(CR88, VIACR, (bdithering | bdual), BIT4 + BIT0);\n}\n\nstatic void check_diport_of_integrated_lvds(\n\tstruct lvds_chip_information *plvds_chip_info,\n\t\t\t\t     struct lvds_setting_information\n\t\t\t\t     *plvds_setting_info)\n{\n\t \n\tswitch (viafb_display_hardware_layout) {\n\tcase HW_LAYOUT_LCD_ONLY:\n\t\t{\n\t\t\tif (plvds_setting_info->device_lcd_dualedge) {\n\t\t\t\tplvds_chip_info->output_interface =\n\t\t\t\t    INTERFACE_LVDS0LVDS1;\n\t\t\t} else {\n\t\t\t\tplvds_chip_info->output_interface =\n\t\t\t\t    INTERFACE_LVDS0;\n\t\t\t}\n\n\t\t\tbreak;\n\t\t}\n\n\tcase HW_LAYOUT_DVI_ONLY:\n\t\t{\n\t\t\tplvds_chip_info->output_interface = INTERFACE_NONE;\n\t\t\tbreak;\n\t\t}\n\n\tcase HW_LAYOUT_LCD1_LCD2:\n\tcase HW_LAYOUT_LCD_EXTERNAL_LCD2:\n\t\t{\n\t\t\tplvds_chip_info->output_interface =\n\t\t\t    INTERFACE_LVDS0LVDS1;\n\t\t\tbreak;\n\t\t}\n\n\tcase HW_LAYOUT_LCD_DVI:\n\t\t{\n\t\t\tplvds_chip_info->output_interface = INTERFACE_LVDS1;\n\t\t\tbreak;\n\t\t}\n\n\tdefault:\n\t\t{\n\t\t\tplvds_chip_info->output_interface = INTERFACE_LVDS1;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tDEBUG_MSG(KERN_INFO\n\t\t  \"Display Hardware Layout: 0x%x, LCD DI Port: 0x%x\\n\",\n\t\t  viafb_display_hardware_layout,\n\t\t  plvds_chip_info->output_interface);\n}\n\nvoid viafb_init_lvds_output_interface(struct lvds_chip_information\n\t\t\t\t*plvds_chip_info,\n\t\t\t\tstruct lvds_setting_information\n\t\t\t\t*plvds_setting_info)\n{\n\tif (INTERFACE_NONE != plvds_chip_info->output_interface) {\n\t\t \n\t\treturn;\n\t}\n\n\tswitch (plvds_chip_info->lvds_chip_name) {\n\n\tcase VT1636_LVDS:\n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_CX700:\n\t\t\tplvds_chip_info->output_interface = INTERFACE_DVP1;\n\t\t\tbreak;\n\t\tcase UNICHROME_CN700:\n\t\t\tplvds_chip_info->output_interface = INTERFACE_DFP_LOW;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tplvds_chip_info->output_interface = INTERFACE_DVP0;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\n\tcase INTEGRATED_LVDS:\n\t\tcheck_diport_of_integrated_lvds(plvds_chip_info,\n\t\t\t\t\t\tplvds_setting_info);\n\t\tbreak;\n\n\tdefault:\n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_K8M890:\n\t\tcase UNICHROME_P4M900:\n\t\tcase UNICHROME_P4M890:\n\t\t\tplvds_chip_info->output_interface = INTERFACE_DFP_LOW;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tplvds_chip_info->output_interface = INTERFACE_DFP;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n}\n\nbool viafb_lcd_get_mobile_state(bool *mobile)\n{\n\tunsigned char __iomem *romptr, *tableptr, *biosptr;\n\tu8 core_base;\n\t \n\tconst u32 romaddr = 0x000C0000;\n\tu16 start_pattern;\n\n\tbiosptr = ioremap(romaddr, 0x10000);\n\tstart_pattern = readw(biosptr);\n\n\t \n\tif (start_pattern == 0xAA55) {\n\t\t \n\t\t \n\t\tromptr = biosptr + 0x1B;\n\t\ttableptr = biosptr + readw(romptr);\n\n\t\t \n\t\t \n\t\tromptr = tableptr + 18;\n\t\tromptr = biosptr + readw(romptr);\n\n\t\t \n\t\t \n\t\tromptr += 41;\n\n\t\tcore_base = readb(romptr);\n\n\t\tif (core_base & 0x8)\n\t\t\t*mobile = false;\n\t\telse\n\t\t\t*mobile = true;\n\t\t \n\t\tiounmap(biosptr);\n\n\t\treturn true;\n\t} else {\n\t\tiounmap(biosptr);\n\t\treturn false;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}