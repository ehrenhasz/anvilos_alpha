{
  "module_name": "hw.c",
  "hash_id": "a6c76a643a9c2faf04397701bfb949cfbbe9d618da249de253351547e235be39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/via/hw.c",
  "human_readable_source": "\n \n\n#include <linux/via-core.h>\n#include \"global.h\"\n#include \"via_clock.h\"\n\nstatic struct pll_limit cle266_pll_limits[] = {\n\t{19, 19, 4, 0},\n\t{26, 102, 5, 0},\n\t{53, 112, 6, 0},\n\t{41, 100, 7, 0},\n\t{83, 108, 8, 0},\n\t{87, 118, 9, 0},\n\t{95, 115, 12, 0},\n\t{108, 108, 13, 0},\n\t{83, 83, 17, 0},\n\t{67, 98, 20, 0},\n\t{121, 121, 24, 0},\n\t{99, 99, 29, 0},\n\t{33, 33, 3, 1},\n\t{15, 23, 4, 1},\n\t{37, 121, 5, 1},\n\t{82, 82, 6, 1},\n\t{31, 84, 7, 1},\n\t{83, 83, 8, 1},\n\t{76, 127, 9, 1},\n\t{33, 121, 4, 2},\n\t{91, 118, 5, 2},\n\t{83, 109, 6, 2},\n\t{90, 90, 7, 2},\n\t{93, 93, 2, 3},\n\t{53, 53, 3, 3},\n\t{73, 117, 4, 3},\n\t{101, 127, 5, 3},\n\t{99, 99, 7, 3}\n};\n\nstatic struct pll_limit k800_pll_limits[] = {\n\t{22, 22, 2, 0},\n\t{28, 28, 3, 0},\n\t{81, 112, 3, 1},\n\t{86, 166, 4, 1},\n\t{109, 153, 5, 1},\n\t{66, 116, 3, 2},\n\t{93, 137, 4, 2},\n\t{117, 208, 5, 2},\n\t{30, 30, 2, 3},\n\t{69, 125, 3, 3},\n\t{89, 161, 4, 3},\n\t{121, 208, 5, 3},\n\t{66, 66, 2, 4},\n\t{85, 85, 3, 4},\n\t{141, 161, 4, 4},\n\t{177, 177, 5, 4}\n};\n\nstatic struct pll_limit cx700_pll_limits[] = {\n\t{98, 98, 3, 1},\n\t{86, 86, 4, 1},\n\t{109, 208, 5, 1},\n\t{68, 68, 2, 2},\n\t{95, 116, 3, 2},\n\t{93, 166, 4, 2},\n\t{110, 206, 5, 2},\n\t{174, 174, 7, 2},\n\t{82, 109, 3, 3},\n\t{117, 161, 4, 3},\n\t{112, 208, 5, 3},\n\t{141, 202, 5, 4}\n};\n\nstatic struct pll_limit vx855_pll_limits[] = {\n\t{86, 86, 4, 1},\n\t{108, 208, 5, 1},\n\t{110, 208, 5, 2},\n\t{83, 112, 3, 3},\n\t{103, 161, 4, 3},\n\t{112, 209, 5, 3},\n\t{142, 161, 4, 4},\n\t{141, 176, 5, 4}\n};\n\n \nstatic struct io_reg scaling_parameters[] = {\n\t{VIACR, CR7A, 0xFF, 0x01},\t \n\t{VIACR, CR7B, 0xFF, 0x02},\t \n\t{VIACR, CR7C, 0xFF, 0x03},\t \n\t{VIACR, CR7D, 0xFF, 0x04},\t \n\t{VIACR, CR7E, 0xFF, 0x07},\t \n\t{VIACR, CR7F, 0xFF, 0x0A},\t \n\t{VIACR, CR80, 0xFF, 0x0D},\t \n\t{VIACR, CR81, 0xFF, 0x13},\t \n\t{VIACR, CR82, 0xFF, 0x16},\t \n\t{VIACR, CR83, 0xFF, 0x19},\t \n\t{VIACR, CR84, 0xFF, 0x1C},\t \n\t{VIACR, CR85, 0xFF, 0x1D},\t \n\t{VIACR, CR86, 0xFF, 0x1E},\t \n\t{VIACR, CR87, 0xFF, 0x1F},\t \n};\n\nstatic struct io_reg common_vga[] = {\n\t{VIACR, CR07, 0x10, 0x10},  \n\t{VIACR, CR08, 0xFF, 0x00},  \n\t{VIACR, CR09, 0xDF, 0x40},  \n\t{VIACR, CR0A, 0xFF, 0x1E},  \n\t{VIACR, CR0B, 0xFF, 0x00},  \n\t{VIACR, CR0E, 0xFF, 0x00},  \n\t{VIACR, CR0F, 0xFF, 0x00},  \n\t{VIACR, CR11, 0xF0, 0x80},  \n\t{VIACR, CR14, 0xFF, 0x00},  \n\t{VIACR, CR17, 0xFF, 0x63},  \n\t{VIACR, CR18, 0xFF, 0xFF},  \n};\n\nstatic struct fifo_depth_select display_fifo_depth_reg = {\n\t \n\t{IGA1_FIFO_DEPTH_SELECT_REG_NUM, {{SR17, 0, 7} } },\n\t \n\t{IGA2_FIFO_DEPTH_SELECT_REG_NUM,\n\t {{CR68, 4, 7}, {CR94, 7, 7}, {CR95, 7, 7} } }\n};\n\nstatic struct fifo_threshold_select fifo_threshold_select_reg = {\n\t \n\t{IGA1_FIFO_THRESHOLD_REG_NUM, {{SR16, 0, 5}, {SR16, 7, 7} } },\n\t \n\t{IGA2_FIFO_THRESHOLD_REG_NUM, {{CR68, 0, 3}, {CR95, 4, 6} } }\n};\n\nstatic struct fifo_high_threshold_select fifo_high_threshold_select_reg = {\n\t \n\t{IGA1_FIFO_HIGH_THRESHOLD_REG_NUM, {{SR18, 0, 5}, {SR18, 7, 7} } },\n\t \n\t{IGA2_FIFO_HIGH_THRESHOLD_REG_NUM, {{CR92, 0, 3}, {CR95, 0, 2} } }\n};\n\nstatic struct display_queue_expire_num display_queue_expire_num_reg = {\n\t \n\t{IGA1_DISPLAY_QUEUE_EXPIRE_NUM_REG_NUM, {{SR22, 0, 4} } },\n\t \n\t{IGA2_DISPLAY_QUEUE_EXPIRE_NUM_REG_NUM, {{CR94, 0, 6} } }\n};\n\n \nstatic struct fetch_count fetch_count_reg = {\n\t \n\t{IGA1_FETCH_COUNT_REG_NUM, {{SR1C, 0, 7}, {SR1D, 0, 1} } },\n\t \n\t{IGA2_FETCH_COUNT_REG_NUM, {{CR65, 0, 7}, {CR67, 2, 3} } }\n};\n\nstatic struct rgbLUT palLUT_table[] = {\n\t \n\t \n\t{0x00, 0x00, 0x00}, {0x00, 0x00, 0x2A}, {0x00, 0x2A, 0x00}, {0x00,\n\t\t\t\t\t\t\t\t     0x2A,\n\t\t\t\t\t\t\t\t     0x2A},\n\t \n\t{0x2A, 0x00, 0x00}, {0x2A, 0x00, 0x2A}, {0x2A, 0x15, 0x00}, {0x2A,\n\t\t\t\t\t\t\t\t     0x2A,\n\t\t\t\t\t\t\t\t     0x2A},\n\t \n\t{0x15, 0x15, 0x15}, {0x15, 0x15, 0x3F}, {0x15, 0x3F, 0x15}, {0x15,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x3F, 0x15, 0x15}, {0x3F, 0x15, 0x3F}, {0x3F, 0x3F, 0x15}, {0x3F,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x00, 0x00, 0x00}, {0x05, 0x05, 0x05}, {0x08, 0x08, 0x08}, {0x0B,\n\t\t\t\t\t\t\t\t     0x0B,\n\t\t\t\t\t\t\t\t     0x0B},\n\t \n\t{0x0E, 0x0E, 0x0E}, {0x11, 0x11, 0x11}, {0x14, 0x14, 0x14}, {0x18,\n\t\t\t\t\t\t\t\t     0x18,\n\t\t\t\t\t\t\t\t     0x18},\n\t \n\t{0x1C, 0x1C, 0x1C}, {0x20, 0x20, 0x20}, {0x24, 0x24, 0x24}, {0x28,\n\t\t\t\t\t\t\t\t     0x28,\n\t\t\t\t\t\t\t\t     0x28},\n\t \n\t{0x2D, 0x2D, 0x2D}, {0x32, 0x32, 0x32}, {0x38, 0x38, 0x38}, {0x3F,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x00, 0x00, 0x3F}, {0x10, 0x00, 0x3F}, {0x1F, 0x00, 0x3F}, {0x2F,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x3F, 0x00, 0x3F}, {0x3F, 0x00, 0x2F}, {0x3F, 0x00, 0x1F}, {0x3F,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x3F, 0x00, 0x00}, {0x3F, 0x10, 0x00}, {0x3F, 0x1F, 0x00}, {0x3F,\n\t\t\t\t\t\t\t\t     0x2F,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x3F, 0x3F, 0x00}, {0x2F, 0x3F, 0x00}, {0x1F, 0x3F, 0x00}, {0x10,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x00, 0x3F, 0x00}, {0x00, 0x3F, 0x10}, {0x00, 0x3F, 0x1F}, {0x00,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x2F},\n\t \n\t{0x00, 0x3F, 0x3F}, {0x00, 0x2F, 0x3F}, {0x00, 0x1F, 0x3F}, {0x00,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x1F, 0x1F, 0x3F}, {0x27, 0x1F, 0x3F}, {0x2F, 0x1F, 0x3F}, {0x37,\n\t\t\t\t\t\t\t\t     0x1F,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x3F, 0x1F, 0x3F}, {0x3F, 0x1F, 0x37}, {0x3F, 0x1F, 0x2F}, {0x3F,\n\t\t\t\t\t\t\t\t     0x1F,\n\t\t\t\t\t\t\t\t     0x27},\n\t \n\t{0x3F, 0x1F, 0x1F}, {0x3F, 0x27, 0x1F}, {0x3F, 0x2F, 0x1F}, {0x3F,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x1F},\n\t \n\t{0x3F, 0x3F, 0x1F}, {0x37, 0x3F, 0x1F}, {0x2F, 0x3F, 0x1F}, {0x27,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x1F},\n\t \n\t{0x1F, 0x3F, 0x1F}, {0x1F, 0x3F, 0x27}, {0x1F, 0x3F, 0x2F}, {0x1F,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x37},\n\t \n\t{0x1F, 0x3F, 0x3F}, {0x1F, 0x37, 0x3F}, {0x1F, 0x2F, 0x3F}, {0x1F,\n\t\t\t\t\t\t\t\t     0x27,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x2D, 0x2D, 0x3F}, {0x31, 0x2D, 0x3F}, {0x36, 0x2D, 0x3F}, {0x3A,\n\t\t\t\t\t\t\t\t     0x2D,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x3F, 0x2D, 0x3F}, {0x3F, 0x2D, 0x3A}, {0x3F, 0x2D, 0x36}, {0x3F,\n\t\t\t\t\t\t\t\t     0x2D,\n\t\t\t\t\t\t\t\t     0x31},\n\t \n\t{0x3F, 0x2D, 0x2D}, {0x3F, 0x31, 0x2D}, {0x3F, 0x36, 0x2D}, {0x3F,\n\t\t\t\t\t\t\t\t     0x3A,\n\t\t\t\t\t\t\t\t     0x2D},\n\t \n\t{0x3F, 0x3F, 0x2D}, {0x3A, 0x3F, 0x2D}, {0x36, 0x3F, 0x2D}, {0x31,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x2D},\n\t \n\t{0x2D, 0x3F, 0x2D}, {0x2D, 0x3F, 0x31}, {0x2D, 0x3F, 0x36}, {0x2D,\n\t\t\t\t\t\t\t\t     0x3F,\n\t\t\t\t\t\t\t\t     0x3A},\n\t \n\t{0x2D, 0x3F, 0x3F}, {0x2D, 0x3A, 0x3F}, {0x2D, 0x36, 0x3F}, {0x2D,\n\t\t\t\t\t\t\t\t     0x31,\n\t\t\t\t\t\t\t\t     0x3F},\n\t \n\t{0x00, 0x00, 0x1C}, {0x07, 0x00, 0x1C}, {0x0E, 0x00, 0x1C}, {0x15,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x1C},\n\t \n\t{0x1C, 0x00, 0x1C}, {0x1C, 0x00, 0x15}, {0x1C, 0x00, 0x0E}, {0x1C,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x07},\n\t \n\t{0x1C, 0x00, 0x00}, {0x1C, 0x07, 0x00}, {0x1C, 0x0E, 0x00}, {0x1C,\n\t\t\t\t\t\t\t\t     0x15,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x1C, 0x1C, 0x00}, {0x15, 0x1C, 0x00}, {0x0E, 0x1C, 0x00}, {0x07,\n\t\t\t\t\t\t\t\t     0x1C,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x07}, {0x00, 0x1C, 0x0E}, {0x00,\n\t\t\t\t\t\t\t\t     0x1C,\n\t\t\t\t\t\t\t\t     0x15},\n\t \n\t{0x00, 0x1C, 0x1C}, {0x00, 0x15, 0x1C}, {0x00, 0x0E, 0x1C}, {0x00,\n\t\t\t\t\t\t\t\t     0x07,\n\t\t\t\t\t\t\t\t     0x1C},\n\t \n\t{0x0E, 0x0E, 0x1C}, {0x11, 0x0E, 0x1C}, {0x15, 0x0E, 0x1C}, {0x18,\n\t\t\t\t\t\t\t\t     0x0E,\n\t\t\t\t\t\t\t\t     0x1C},\n\t \n\t{0x1C, 0x0E, 0x1C}, {0x1C, 0x0E, 0x18}, {0x1C, 0x0E, 0x15}, {0x1C,\n\t\t\t\t\t\t\t\t     0x0E,\n\t\t\t\t\t\t\t\t     0x11},\n\t \n\t{0x1C, 0x0E, 0x0E}, {0x1C, 0x11, 0x0E}, {0x1C, 0x15, 0x0E}, {0x1C,\n\t\t\t\t\t\t\t\t     0x18,\n\t\t\t\t\t\t\t\t     0x0E},\n\t \n\t{0x1C, 0x1C, 0x0E}, {0x18, 0x1C, 0x0E}, {0x15, 0x1C, 0x0E}, {0x11,\n\t\t\t\t\t\t\t\t     0x1C,\n\t\t\t\t\t\t\t\t     0x0E},\n\t \n\t{0x0E, 0x1C, 0x0E}, {0x0E, 0x1C, 0x11}, {0x0E, 0x1C, 0x15}, {0x0E,\n\t\t\t\t\t\t\t\t     0x1C,\n\t\t\t\t\t\t\t\t     0x18},\n\t \n\t{0x0E, 0x1C, 0x1C}, {0x0E, 0x18, 0x1C}, {0x0E, 0x15, 0x1C}, {0x0E,\n\t\t\t\t\t\t\t\t     0x11,\n\t\t\t\t\t\t\t\t     0x1C},\n\t \n\t{0x14, 0x14, 0x1C}, {0x16, 0x14, 0x1C}, {0x18, 0x14, 0x1C}, {0x1A,\n\t\t\t\t\t\t\t\t     0x14,\n\t\t\t\t\t\t\t\t     0x1C},\n\t \n\t{0x1C, 0x14, 0x1C}, {0x1C, 0x14, 0x1A}, {0x1C, 0x14, 0x18}, {0x1C,\n\t\t\t\t\t\t\t\t     0x14,\n\t\t\t\t\t\t\t\t     0x16},\n\t \n\t{0x1C, 0x14, 0x14}, {0x1C, 0x16, 0x14}, {0x1C, 0x18, 0x14}, {0x1C,\n\t\t\t\t\t\t\t\t     0x1A,\n\t\t\t\t\t\t\t\t     0x14},\n\t \n\t{0x1C, 0x1C, 0x14}, {0x1A, 0x1C, 0x14}, {0x18, 0x1C, 0x14}, {0x16,\n\t\t\t\t\t\t\t\t     0x1C,\n\t\t\t\t\t\t\t\t     0x14},\n\t \n\t{0x14, 0x1C, 0x14}, {0x14, 0x1C, 0x16}, {0x14, 0x1C, 0x18}, {0x14,\n\t\t\t\t\t\t\t\t     0x1C,\n\t\t\t\t\t\t\t\t     0x1A},\n\t \n\t{0x14, 0x1C, 0x1C}, {0x14, 0x1A, 0x1C}, {0x14, 0x18, 0x1C}, {0x14,\n\t\t\t\t\t\t\t\t     0x16,\n\t\t\t\t\t\t\t\t     0x1C},\n\t \n\t{0x00, 0x00, 0x10}, {0x04, 0x00, 0x10}, {0x08, 0x00, 0x10}, {0x0C,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x10, 0x00, 0x10}, {0x10, 0x00, 0x0C}, {0x10, 0x00, 0x08}, {0x10,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x04},\n\t \n\t{0x10, 0x00, 0x00}, {0x10, 0x04, 0x00}, {0x10, 0x08, 0x00}, {0x10,\n\t\t\t\t\t\t\t\t     0x0C,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x10, 0x10, 0x00}, {0x0C, 0x10, 0x00}, {0x08, 0x10, 0x00}, {0x04,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x00, 0x10, 0x00}, {0x00, 0x10, 0x04}, {0x00, 0x10, 0x08}, {0x00,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x0C},\n\t \n\t{0x00, 0x10, 0x10}, {0x00, 0x0C, 0x10}, {0x00, 0x08, 0x10}, {0x00,\n\t\t\t\t\t\t\t\t     0x04,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x08, 0x08, 0x10}, {0x0A, 0x08, 0x10}, {0x0C, 0x08, 0x10}, {0x0E,\n\t\t\t\t\t\t\t\t     0x08,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x10, 0x08, 0x10}, {0x10, 0x08, 0x0E}, {0x10, 0x08, 0x0C}, {0x10,\n\t\t\t\t\t\t\t\t     0x08,\n\t\t\t\t\t\t\t\t     0x0A},\n\t \n\t{0x10, 0x08, 0x08}, {0x10, 0x0A, 0x08}, {0x10, 0x0C, 0x08}, {0x10,\n\t\t\t\t\t\t\t\t     0x0E,\n\t\t\t\t\t\t\t\t     0x08},\n\t \n\t{0x10, 0x10, 0x08}, {0x0E, 0x10, 0x08}, {0x0C, 0x10, 0x08}, {0x0A,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x08},\n\t \n\t{0x08, 0x10, 0x08}, {0x08, 0x10, 0x0A}, {0x08, 0x10, 0x0C}, {0x08,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x0E},\n\t \n\t{0x08, 0x10, 0x10}, {0x08, 0x0E, 0x10}, {0x08, 0x0C, 0x10}, {0x08,\n\t\t\t\t\t\t\t\t     0x0A,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x0B, 0x0B, 0x10}, {0x0C, 0x0B, 0x10}, {0x0D, 0x0B, 0x10}, {0x0F,\n\t\t\t\t\t\t\t\t     0x0B,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x10, 0x0B, 0x10}, {0x10, 0x0B, 0x0F}, {0x10, 0x0B, 0x0D}, {0x10,\n\t\t\t\t\t\t\t\t     0x0B,\n\t\t\t\t\t\t\t\t     0x0C},\n\t \n\t{0x10, 0x0B, 0x0B}, {0x10, 0x0C, 0x0B}, {0x10, 0x0D, 0x0B}, {0x10,\n\t\t\t\t\t\t\t\t     0x0F,\n\t\t\t\t\t\t\t\t     0x0B},\n\t \n\t{0x10, 0x10, 0x0B}, {0x0F, 0x10, 0x0B}, {0x0D, 0x10, 0x0B}, {0x0C,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x0B},\n\t \n\t{0x0B, 0x10, 0x0B}, {0x0B, 0x10, 0x0C}, {0x0B, 0x10, 0x0D}, {0x0B,\n\t\t\t\t\t\t\t\t     0x10,\n\t\t\t\t\t\t\t\t     0x0F},\n\t \n\t{0x0B, 0x10, 0x10}, {0x0B, 0x0F, 0x10}, {0x0B, 0x0D, 0x10}, {0x0B,\n\t\t\t\t\t\t\t\t     0x0C,\n\t\t\t\t\t\t\t\t     0x10},\n\t \n\t{0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x00},\n\t \n\t{0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00,\n\t\t\t\t\t\t\t\t     0x00,\n\t\t\t\t\t\t\t\t     0x00}\n};\n\nstatic struct via_device_mapping device_mapping[] = {\n\t{VIA_LDVP0, \"LDVP0\"},\n\t{VIA_LDVP1, \"LDVP1\"},\n\t{VIA_DVP0, \"DVP0\"},\n\t{VIA_CRT, \"CRT\"},\n\t{VIA_DVP1, \"DVP1\"},\n\t{VIA_LVDS1, \"LVDS1\"},\n\t{VIA_LVDS2, \"LVDS2\"}\n};\n\n \nstatic struct via_clock clock;\n\nstatic void load_fix_bit_crtc_reg(void);\nstatic void init_gfx_chip_info(int chip_type);\nstatic void init_tmds_chip_info(void);\nstatic void init_lvds_chip_info(void);\nstatic void device_screen_off(void);\nstatic void device_screen_on(void);\nstatic void set_display_channel(void);\nstatic void device_off(void);\nstatic void device_on(void);\nstatic void enable_second_display_channel(void);\nstatic void disable_second_display_channel(void);\n\nvoid viafb_lock_crt(void)\n{\n\tviafb_write_reg_mask(CR11, VIACR, BIT7, BIT7);\n}\n\nvoid viafb_unlock_crt(void)\n{\n\tviafb_write_reg_mask(CR11, VIACR, 0, BIT7);\n\tviafb_write_reg_mask(CR47, VIACR, 0, BIT0);\n}\n\nstatic void write_dac_reg(u8 index, u8 r, u8 g, u8 b)\n{\n\toutb(index, LUT_INDEX_WRITE);\n\toutb(r, LUT_DATA);\n\toutb(g, LUT_DATA);\n\toutb(b, LUT_DATA);\n}\n\nstatic u32 get_dvi_devices(int output_interface)\n{\n\tswitch (output_interface) {\n\tcase INTERFACE_DVP0:\n\t\treturn VIA_DVP0 | VIA_LDVP0;\n\n\tcase INTERFACE_DVP1:\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266)\n\t\t\treturn VIA_LDVP1;\n\t\telse\n\t\t\treturn VIA_DVP1;\n\n\tcase INTERFACE_DFP_HIGH:\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266)\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn VIA_LVDS2 | VIA_DVP0;\n\n\tcase INTERFACE_DFP_LOW:\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266)\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn VIA_DVP1 | VIA_LVDS1;\n\n\tcase INTERFACE_TMDS:\n\t\treturn VIA_LVDS1;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 get_lcd_devices(int output_interface)\n{\n\tswitch (output_interface) {\n\tcase INTERFACE_DVP0:\n\t\treturn VIA_DVP0;\n\n\tcase INTERFACE_DVP1:\n\t\treturn VIA_DVP1;\n\n\tcase INTERFACE_DFP_HIGH:\n\t\treturn VIA_LVDS2 | VIA_DVP0;\n\n\tcase INTERFACE_DFP_LOW:\n\t\treturn VIA_LVDS1 | VIA_DVP1;\n\n\tcase INTERFACE_DFP:\n\t\treturn VIA_LVDS1 | VIA_LVDS2;\n\n\tcase INTERFACE_LVDS0:\n\tcase INTERFACE_LVDS0LVDS1:\n\t\treturn VIA_LVDS1;\n\n\tcase INTERFACE_LVDS1:\n\t\treturn VIA_LVDS2;\n\t}\n\n\treturn 0;\n}\n\n \nvoid viafb_set_iga_path(void)\n{\n\tint crt_iga_path = 0;\n\n\tif (viafb_SAMM_ON == 1) {\n\t\tif (viafb_CRT_ON) {\n\t\t\tif (viafb_primary_dev == CRT_Device)\n\t\t\t\tcrt_iga_path = IGA1;\n\t\t\telse\n\t\t\t\tcrt_iga_path = IGA2;\n\t\t}\n\n\t\tif (viafb_DVI_ON) {\n\t\t\tif (viafb_primary_dev == DVI_Device)\n\t\t\t\tviaparinfo->tmds_setting_info->iga_path = IGA1;\n\t\t\telse\n\t\t\t\tviaparinfo->tmds_setting_info->iga_path = IGA2;\n\t\t}\n\n\t\tif (viafb_LCD_ON) {\n\t\t\tif (viafb_primary_dev == LCD_Device) {\n\t\t\t\tif (viafb_dual_fb &&\n\t\t\t\t\t(viaparinfo->chip_info->gfx_chip_name ==\n\t\t\t\t\tUNICHROME_CLE266)) {\n\t\t\t\t\tviaparinfo->\n\t\t\t\t\tlvds_setting_info->iga_path = IGA2;\n\t\t\t\t\tcrt_iga_path = IGA1;\n\t\t\t\t\tviaparinfo->\n\t\t\t\t\ttmds_setting_info->iga_path = IGA1;\n\t\t\t\t} else\n\t\t\t\t\tviaparinfo->\n\t\t\t\t\tlvds_setting_info->iga_path = IGA1;\n\t\t\t} else {\n\t\t\t\tviaparinfo->lvds_setting_info->iga_path = IGA2;\n\t\t\t}\n\t\t}\n\t\tif (viafb_LCD2_ON) {\n\t\t\tif (LCD2_Device == viafb_primary_dev)\n\t\t\t\tviaparinfo->lvds_setting_info2->iga_path = IGA1;\n\t\t\telse\n\t\t\t\tviaparinfo->lvds_setting_info2->iga_path = IGA2;\n\t\t}\n\t} else {\n\t\tviafb_SAMM_ON = 0;\n\n\t\tif (viafb_CRT_ON && viafb_LCD_ON) {\n\t\t\tcrt_iga_path = IGA1;\n\t\t\tviaparinfo->lvds_setting_info->iga_path = IGA2;\n\t\t} else if (viafb_CRT_ON && viafb_DVI_ON) {\n\t\t\tcrt_iga_path = IGA1;\n\t\t\tviaparinfo->tmds_setting_info->iga_path = IGA2;\n\t\t} else if (viafb_LCD_ON && viafb_DVI_ON) {\n\t\t\tviaparinfo->tmds_setting_info->iga_path = IGA1;\n\t\t\tviaparinfo->lvds_setting_info->iga_path = IGA2;\n\t\t} else if (viafb_LCD_ON && viafb_LCD2_ON) {\n\t\t\tviaparinfo->lvds_setting_info->iga_path = IGA2;\n\t\t\tviaparinfo->lvds_setting_info2->iga_path = IGA2;\n\t\t} else if (viafb_CRT_ON) {\n\t\t\tcrt_iga_path = IGA1;\n\t\t} else if (viafb_LCD_ON) {\n\t\t\tviaparinfo->lvds_setting_info->iga_path = IGA2;\n\t\t} else if (viafb_DVI_ON) {\n\t\t\tviaparinfo->tmds_setting_info->iga_path = IGA1;\n\t\t}\n\t}\n\n\tviaparinfo->shared->iga1_devices = 0;\n\tviaparinfo->shared->iga2_devices = 0;\n\tif (viafb_CRT_ON) {\n\t\tif (crt_iga_path == IGA1)\n\t\t\tviaparinfo->shared->iga1_devices |= VIA_CRT;\n\t\telse\n\t\t\tviaparinfo->shared->iga2_devices |= VIA_CRT;\n\t}\n\n\tif (viafb_DVI_ON) {\n\t\tif (viaparinfo->tmds_setting_info->iga_path == IGA1)\n\t\t\tviaparinfo->shared->iga1_devices |= get_dvi_devices(\n\t\t\t\tviaparinfo->chip_info->\n\t\t\t\ttmds_chip_info.output_interface);\n\t\telse\n\t\t\tviaparinfo->shared->iga2_devices |= get_dvi_devices(\n\t\t\t\tviaparinfo->chip_info->\n\t\t\t\ttmds_chip_info.output_interface);\n\t}\n\n\tif (viafb_LCD_ON) {\n\t\tif (viaparinfo->lvds_setting_info->iga_path == IGA1)\n\t\t\tviaparinfo->shared->iga1_devices |= get_lcd_devices(\n\t\t\t\tviaparinfo->chip_info->\n\t\t\t\tlvds_chip_info.output_interface);\n\t\telse\n\t\t\tviaparinfo->shared->iga2_devices |= get_lcd_devices(\n\t\t\t\tviaparinfo->chip_info->\n\t\t\t\tlvds_chip_info.output_interface);\n\t}\n\n\tif (viafb_LCD2_ON) {\n\t\tif (viaparinfo->lvds_setting_info2->iga_path == IGA1)\n\t\t\tviaparinfo->shared->iga1_devices |= get_lcd_devices(\n\t\t\t\tviaparinfo->chip_info->\n\t\t\t\tlvds_chip_info2.output_interface);\n\t\telse\n\t\t\tviaparinfo->shared->iga2_devices |= get_lcd_devices(\n\t\t\t\tviaparinfo->chip_info->\n\t\t\t\tlvds_chip_info2.output_interface);\n\t}\n\n\t \n\tif (machine_is_olpc())\n\t\tviaparinfo->shared->iga2_devices = VIA_DVP1 | VIA_LVDS2;\n}\n\nstatic void set_color_register(u8 index, u8 red, u8 green, u8 blue)\n{\n\toutb(0xFF, 0x3C6);  \n\toutb(index, 0x3C8);\n\toutb(red, 0x3C9);\n\toutb(green, 0x3C9);\n\toutb(blue, 0x3C9);\n}\n\nvoid viafb_set_primary_color_register(u8 index, u8 red, u8 green, u8 blue)\n{\n\tviafb_write_reg_mask(0x1A, VIASR, 0x00, 0x01);\n\tset_color_register(index, red, green, blue);\n}\n\nvoid viafb_set_secondary_color_register(u8 index, u8 red, u8 green, u8 blue)\n{\n\tviafb_write_reg_mask(0x1A, VIASR, 0x01, 0x01);\n\tset_color_register(index, red, green, blue);\n}\n\nstatic void set_source_common(u8 index, u8 offset, u8 iga)\n{\n\tu8 value, mask = 1 << offset;\n\n\tswitch (iga) {\n\tcase IGA1:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tcase IGA2:\n\t\tvalue = mask;\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_WARNING \"viafb: Unsupported source: %d\\n\", iga);\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIACR, index, value, mask);\n}\n\nstatic void set_crt_source(u8 iga)\n{\n\tu8 value;\n\n\tswitch (iga) {\n\tcase IGA1:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tcase IGA2:\n\t\tvalue = 0x40;\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_WARNING \"viafb: Unsupported source: %d\\n\", iga);\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIASR, 0x16, value, 0x40);\n}\n\nstatic inline void set_ldvp0_source(u8 iga)\n{\n\tset_source_common(0x6C, 7, iga);\n}\n\nstatic inline void set_ldvp1_source(u8 iga)\n{\n\tset_source_common(0x93, 7, iga);\n}\n\nstatic inline void set_dvp0_source(u8 iga)\n{\n\tset_source_common(0x96, 4, iga);\n}\n\nstatic inline void set_dvp1_source(u8 iga)\n{\n\tset_source_common(0x9B, 4, iga);\n}\n\nstatic inline void set_lvds1_source(u8 iga)\n{\n\tset_source_common(0x99, 4, iga);\n}\n\nstatic inline void set_lvds2_source(u8 iga)\n{\n\tset_source_common(0x97, 4, iga);\n}\n\nvoid via_set_source(u32 devices, u8 iga)\n{\n\tif (devices & VIA_LDVP0)\n\t\tset_ldvp0_source(iga);\n\tif (devices & VIA_LDVP1)\n\t\tset_ldvp1_source(iga);\n\tif (devices & VIA_DVP0)\n\t\tset_dvp0_source(iga);\n\tif (devices & VIA_CRT)\n\t\tset_crt_source(iga);\n\tif (devices & VIA_DVP1)\n\t\tset_dvp1_source(iga);\n\tif (devices & VIA_LVDS1)\n\t\tset_lvds1_source(iga);\n\tif (devices & VIA_LVDS2)\n\t\tset_lvds2_source(iga);\n}\n\nstatic void set_crt_state(u8 state)\n{\n\tu8 value;\n\n\tswitch (state) {\n\tcase VIA_STATE_ON:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tcase VIA_STATE_STANDBY:\n\t\tvalue = 0x10;\n\t\tbreak;\n\tcase VIA_STATE_SUSPEND:\n\t\tvalue = 0x20;\n\t\tbreak;\n\tcase VIA_STATE_OFF:\n\t\tvalue = 0x30;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIACR, 0x36, value, 0x30);\n}\n\nstatic void set_dvp0_state(u8 state)\n{\n\tu8 value;\n\n\tswitch (state) {\n\tcase VIA_STATE_ON:\n\t\tvalue = 0xC0;\n\t\tbreak;\n\tcase VIA_STATE_OFF:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIASR, 0x1E, value, 0xC0);\n}\n\nstatic void set_dvp1_state(u8 state)\n{\n\tu8 value;\n\n\tswitch (state) {\n\tcase VIA_STATE_ON:\n\t\tvalue = 0x30;\n\t\tbreak;\n\tcase VIA_STATE_OFF:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIASR, 0x1E, value, 0x30);\n}\n\nstatic void set_lvds1_state(u8 state)\n{\n\tu8 value;\n\n\tswitch (state) {\n\tcase VIA_STATE_ON:\n\t\tvalue = 0x03;\n\t\tbreak;\n\tcase VIA_STATE_OFF:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIASR, 0x2A, value, 0x03);\n}\n\nstatic void set_lvds2_state(u8 state)\n{\n\tu8 value;\n\n\tswitch (state) {\n\tcase VIA_STATE_ON:\n\t\tvalue = 0x0C;\n\t\tbreak;\n\tcase VIA_STATE_OFF:\n\t\tvalue = 0x00;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tvia_write_reg_mask(VIASR, 0x2A, value, 0x0C);\n}\n\nvoid via_set_state(u32 devices, u8 state)\n{\n\t \n\tif (devices & VIA_DVP0)\n\t\tset_dvp0_state(state);\n\tif (devices & VIA_CRT)\n\t\tset_crt_state(state);\n\tif (devices & VIA_DVP1)\n\t\tset_dvp1_state(state);\n\tif (devices & VIA_LVDS1)\n\t\tset_lvds1_state(state);\n\tif (devices & VIA_LVDS2)\n\t\tset_lvds2_state(state);\n}\n\nvoid via_set_sync_polarity(u32 devices, u8 polarity)\n{\n\tif (polarity & ~(VIA_HSYNC_NEGATIVE | VIA_VSYNC_NEGATIVE)) {\n\t\tprintk(KERN_WARNING \"viafb: Unsupported polarity: %d\\n\",\n\t\t\tpolarity);\n\t\treturn;\n\t}\n\n\tif (devices & VIA_CRT)\n\t\tvia_write_misc_reg_mask(polarity << 6, 0xC0);\n\tif (devices & VIA_DVP1)\n\t\tvia_write_reg_mask(VIACR, 0x9B, polarity << 5, 0x60);\n\tif (devices & VIA_LVDS1)\n\t\tvia_write_reg_mask(VIACR, 0x99, polarity << 5, 0x60);\n\tif (devices & VIA_LVDS2)\n\t\tvia_write_reg_mask(VIACR, 0x97, polarity << 5, 0x60);\n}\n\nu32 via_parse_odev(char *input, char **end)\n{\n\tchar *ptr = input;\n\tu32 odev = 0;\n\tbool next = true;\n\tint i, len;\n\n\twhile (next) {\n\t\tnext = false;\n\t\tfor (i = 0; i < ARRAY_SIZE(device_mapping); i++) {\n\t\t\tlen = strlen(device_mapping[i].name);\n\t\t\tif (!strncmp(ptr, device_mapping[i].name, len)) {\n\t\t\t\todev |= device_mapping[i].device;\n\t\t\t\tptr += len;\n\t\t\t\tif (*ptr == ',') {\n\t\t\t\t\tptr++;\n\t\t\t\t\tnext = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t*end = ptr;\n\treturn odev;\n}\n\nvoid via_odev_to_seq(struct seq_file *m, u32 odev)\n{\n\tint i, count = 0;\n\n\tfor (i = 0; i < ARRAY_SIZE(device_mapping); i++) {\n\t\tif (odev & device_mapping[i].device) {\n\t\t\tif (count > 0)\n\t\t\t\tseq_putc(m, ',');\n\n\t\t\tseq_puts(m, device_mapping[i].name);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\tseq_putc(m, '\\n');\n}\n\nstatic void load_fix_bit_crtc_reg(void)\n{\n\tviafb_unlock_crt();\n\n\t \n\tviafb_write_reg_mask(CR03, VIACR, 0x80, BIT7);\n\t \n\tviafb_write_reg_mask(CR35, VIACR, 0x10, BIT4);\n\t \n\tviafb_write_reg_mask(CR33, VIACR, 0x06, BIT0 + BIT1 + BIT2);\n\t \n\n\tviafb_lock_crt();\n\n\t \n\tif ((viaparinfo->chip_info->gfx_chip_name == UNICHROME_K800)\n\t\t|| (viaparinfo->chip_info->gfx_chip_name == UNICHROME_K8M890))\n\t\tviafb_write_reg_mask(CR33, VIACR, 0x08, BIT3);\n\tif ((viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266)\n\t    && (viaparinfo->chip_info->gfx_chip_revision == CLE266_REVISION_AX))\n\t\tviafb_write_reg_mask(SR1A, VIASR, 0x02, BIT1);\n\n}\n\nvoid viafb_load_reg(int timing_value, int viafb_load_reg_num,\n\tstruct io_register *reg,\n\t      int io_type)\n{\n\tint reg_mask;\n\tint bit_num = 0;\n\tint data;\n\tint i, j;\n\tint shift_next_reg;\n\tint start_index, end_index, cr_index;\n\tu16 get_bit;\n\n\tfor (i = 0; i < viafb_load_reg_num; i++) {\n\t\treg_mask = 0;\n\t\tdata = 0;\n\t\tstart_index = reg[i].start_bit;\n\t\tend_index = reg[i].end_bit;\n\t\tcr_index = reg[i].io_addr;\n\n\t\tshift_next_reg = bit_num;\n\t\tfor (j = start_index; j <= end_index; j++) {\n\t\t\t \n\t\t\treg_mask = reg_mask | (BIT0 << j);\n\t\t\tget_bit = (timing_value & (BIT0 << bit_num));\n\t\t\tdata =\n\t\t\t    data | ((get_bit >> shift_next_reg) << start_index);\n\t\t\tbit_num++;\n\t\t}\n\t\tif (io_type == VIACR)\n\t\t\tviafb_write_reg_mask(cr_index, VIACR, data, reg_mask);\n\t\telse\n\t\t\tviafb_write_reg_mask(cr_index, VIASR, data, reg_mask);\n\t}\n\n}\n\n \nvoid viafb_write_regx(struct io_reg RegTable[], int ItemNum)\n{\n\tint i;\n\n\t \n\n\tfor (i = 0; i < ItemNum; i++)\n\t\tvia_write_reg_mask(RegTable[i].port, RegTable[i].index,\n\t\t\tRegTable[i].value, RegTable[i].mask);\n}\n\nvoid viafb_load_fetch_count_reg(int h_addr, int bpp_byte, int set_iga)\n{\n\tint reg_value;\n\tint viafb_load_reg_num;\n\tstruct io_register *reg = NULL;\n\n\tswitch (set_iga) {\n\tcase IGA1:\n\t\treg_value = IGA1_FETCH_COUNT_FORMULA(h_addr, bpp_byte);\n\t\tviafb_load_reg_num = fetch_count_reg.\n\t\t\tiga1_fetch_count_reg.reg_num;\n\t\treg = fetch_count_reg.iga1_fetch_count_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIASR);\n\t\tbreak;\n\tcase IGA2:\n\t\treg_value = IGA2_FETCH_COUNT_FORMULA(h_addr, bpp_byte);\n\t\tviafb_load_reg_num = fetch_count_reg.\n\t\t\tiga2_fetch_count_reg.reg_num;\n\t\treg = fetch_count_reg.iga2_fetch_count_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIACR);\n\t\tbreak;\n\t}\n\n}\n\nvoid viafb_load_FIFO_reg(int set_iga, int hor_active, int ver_active)\n{\n\tint reg_value;\n\tint viafb_load_reg_num;\n\tstruct io_register *reg = NULL;\n\tint iga1_fifo_max_depth = 0, iga1_fifo_threshold =\n\t    0, iga1_fifo_high_threshold = 0, iga1_display_queue_expire_num = 0;\n\tint iga2_fifo_max_depth = 0, iga2_fifo_threshold =\n\t    0, iga2_fifo_high_threshold = 0, iga2_display_queue_expire_num = 0;\n\n\tif (set_iga == IGA1) {\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_K800) {\n\t\t\tiga1_fifo_max_depth = K800_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = K800_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    K800_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\t \n\t\t\tif ((hor_active > 1280) && (ver_active > 1024))\n\t\t\t\tiga1_display_queue_expire_num = 16;\n\t\t\telse\n\t\t\t\tiga1_display_queue_expire_num =\n\t\t\t\t    K800_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_PM800) {\n\t\t\tiga1_fifo_max_depth = P880_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = P880_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    P880_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    P880_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\n\t\t\t \n\t\t\tif ((hor_active > 1280) && (ver_active > 1024))\n\t\t\t\tiga1_display_queue_expire_num = 16;\n\t\t\telse\n\t\t\t\tiga1_display_queue_expire_num =\n\t\t\t\t    P880_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CN700) {\n\t\t\tiga1_fifo_max_depth = CN700_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = CN700_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    CN700_IGA1_FIFO_HIGH_THRESHOLD;\n\n\t\t\t \n\t\t\tif ((hor_active > 1280) && (ver_active > 1024))\n\t\t\t\tiga1_display_queue_expire_num = 16;\n\t\t\telse\n\t\t\t\tiga1_display_queue_expire_num =\n\t\t\t\t    CN700_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\n\t\t\tiga1_fifo_max_depth = CX700_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = CX700_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    CX700_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    CX700_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_K8M890) {\n\t\t\tiga1_fifo_max_depth = K8M890_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = K8M890_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    K8M890_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    K8M890_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_P4M890) {\n\t\t\tiga1_fifo_max_depth = P4M890_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = P4M890_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    P4M890_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    P4M890_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_P4M900) {\n\t\t\tiga1_fifo_max_depth = P4M900_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = P4M900_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    P4M900_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    P4M900_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_VX800) {\n\t\t\tiga1_fifo_max_depth = VX800_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = VX800_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    VX800_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    VX800_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_VX855) {\n\t\t\tiga1_fifo_max_depth = VX855_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = VX855_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    VX855_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    VX855_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_VX900) {\n\t\t\tiga1_fifo_max_depth = VX900_IGA1_FIFO_MAX_DEPTH;\n\t\t\tiga1_fifo_threshold = VX900_IGA1_FIFO_THRESHOLD;\n\t\t\tiga1_fifo_high_threshold =\n\t\t\t    VX900_IGA1_FIFO_HIGH_THRESHOLD;\n\t\t\tiga1_display_queue_expire_num =\n\t\t\t    VX900_IGA1_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\t \n\t\treg_value = IGA1_FIFO_DEPTH_SELECT_FORMULA(iga1_fifo_max_depth);\n\t\tviafb_load_reg_num =\n\t\t    display_fifo_depth_reg.iga1_fifo_depth_select_reg.reg_num;\n\t\treg = display_fifo_depth_reg.iga1_fifo_depth_select_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIASR);\n\n\t\t \n\t\treg_value = IGA1_FIFO_THRESHOLD_FORMULA(iga1_fifo_threshold);\n\t\tviafb_load_reg_num =\n\t\t    fifo_threshold_select_reg.\n\t\t    iga1_fifo_threshold_select_reg.reg_num;\n\t\treg =\n\t\t    fifo_threshold_select_reg.\n\t\t    iga1_fifo_threshold_select_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIASR);\n\n\t\t \n\t\treg_value =\n\t\t    IGA1_FIFO_HIGH_THRESHOLD_FORMULA(iga1_fifo_high_threshold);\n\t\tviafb_load_reg_num =\n\t\t    fifo_high_threshold_select_reg.\n\t\t    iga1_fifo_high_threshold_select_reg.reg_num;\n\t\treg =\n\t\t    fifo_high_threshold_select_reg.\n\t\t    iga1_fifo_high_threshold_select_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIASR);\n\n\t\t \n\t\treg_value =\n\t\t    IGA1_DISPLAY_QUEUE_EXPIRE_NUM_FORMULA\n\t\t    (iga1_display_queue_expire_num);\n\t\tviafb_load_reg_num =\n\t\t    display_queue_expire_num_reg.\n\t\t    iga1_display_queue_expire_num_reg.reg_num;\n\t\treg =\n\t\t    display_queue_expire_num_reg.\n\t\t    iga1_display_queue_expire_num_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIASR);\n\n\t} else {\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_K800) {\n\t\t\tiga2_fifo_max_depth = K800_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = K800_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    K800_IGA2_FIFO_HIGH_THRESHOLD;\n\n\t\t\t \n\t\t\tif ((hor_active > 1280) && (ver_active > 1024))\n\t\t\t\tiga2_display_queue_expire_num = 16;\n\t\t\telse\n\t\t\t\tiga2_display_queue_expire_num =\n\t\t\t\t    K800_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_PM800) {\n\t\t\tiga2_fifo_max_depth = P880_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = P880_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    P880_IGA2_FIFO_HIGH_THRESHOLD;\n\n\t\t\t \n\t\t\tif ((hor_active > 1280) && (ver_active > 1024))\n\t\t\t\tiga2_display_queue_expire_num = 16;\n\t\t\telse\n\t\t\t\tiga2_display_queue_expire_num =\n\t\t\t\t    P880_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CN700) {\n\t\t\tiga2_fifo_max_depth = CN700_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = CN700_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    CN700_IGA2_FIFO_HIGH_THRESHOLD;\n\n\t\t\t \n\t\t\tif ((hor_active > 1280) && (ver_active > 1024))\n\t\t\t\tiga2_display_queue_expire_num = 16;\n\t\t\telse\n\t\t\t\tiga2_display_queue_expire_num =\n\t\t\t\t    CN700_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\n\t\t\tiga2_fifo_max_depth = CX700_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = CX700_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    CX700_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    CX700_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_K8M890) {\n\t\t\tiga2_fifo_max_depth = K8M890_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = K8M890_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    K8M890_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    K8M890_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_P4M890) {\n\t\t\tiga2_fifo_max_depth = P4M890_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = P4M890_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    P4M890_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    P4M890_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_P4M900) {\n\t\t\tiga2_fifo_max_depth = P4M900_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = P4M900_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    P4M900_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    P4M900_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_VX800) {\n\t\t\tiga2_fifo_max_depth = VX800_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = VX800_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    VX800_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    VX800_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_VX855) {\n\t\t\tiga2_fifo_max_depth = VX855_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = VX855_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    VX855_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    VX855_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_VX900) {\n\t\t\tiga2_fifo_max_depth = VX900_IGA2_FIFO_MAX_DEPTH;\n\t\t\tiga2_fifo_threshold = VX900_IGA2_FIFO_THRESHOLD;\n\t\t\tiga2_fifo_high_threshold =\n\t\t\t    VX900_IGA2_FIFO_HIGH_THRESHOLD;\n\t\t\tiga2_display_queue_expire_num =\n\t\t\t    VX900_IGA2_DISPLAY_QUEUE_EXPIRE_NUM;\n\t\t}\n\n\t\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_K800) {\n\t\t\t \n\t\t\treg_value =\n\t\t\t    IGA2_FIFO_DEPTH_SELECT_FORMULA(iga2_fifo_max_depth)\n\t\t\t    - 1;\n\t\t\t \n\t\t\tviafb_load_reg_num =\n\t\t\t    display_fifo_depth_reg.\n\t\t\t    iga2_fifo_depth_select_reg.reg_num;\n\t\t\treg =\n\t\t\t    display_fifo_depth_reg.\n\t\t\t    iga2_fifo_depth_select_reg.reg;\n\t\t\tviafb_load_reg(reg_value,\n\t\t\t\tviafb_load_reg_num, reg, VIACR);\n\t\t} else {\n\n\t\t\t \n\t\t\treg_value =\n\t\t\t    IGA2_FIFO_DEPTH_SELECT_FORMULA(iga2_fifo_max_depth);\n\t\t\tviafb_load_reg_num =\n\t\t\t    display_fifo_depth_reg.\n\t\t\t    iga2_fifo_depth_select_reg.reg_num;\n\t\t\treg =\n\t\t\t    display_fifo_depth_reg.\n\t\t\t    iga2_fifo_depth_select_reg.reg;\n\t\t\tviafb_load_reg(reg_value,\n\t\t\t\tviafb_load_reg_num, reg, VIACR);\n\t\t}\n\n\t\t \n\t\treg_value = IGA2_FIFO_THRESHOLD_FORMULA(iga2_fifo_threshold);\n\t\tviafb_load_reg_num =\n\t\t    fifo_threshold_select_reg.\n\t\t    iga2_fifo_threshold_select_reg.reg_num;\n\t\treg =\n\t\t    fifo_threshold_select_reg.\n\t\t    iga2_fifo_threshold_select_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIACR);\n\n\t\t \n\t\treg_value =\n\t\t    IGA2_FIFO_HIGH_THRESHOLD_FORMULA(iga2_fifo_high_threshold);\n\t\tviafb_load_reg_num =\n\t\t    fifo_high_threshold_select_reg.\n\t\t    iga2_fifo_high_threshold_select_reg.reg_num;\n\t\treg =\n\t\t    fifo_high_threshold_select_reg.\n\t\t    iga2_fifo_high_threshold_select_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIACR);\n\n\t\t \n\t\treg_value =\n\t\t    IGA2_DISPLAY_QUEUE_EXPIRE_NUM_FORMULA\n\t\t    (iga2_display_queue_expire_num);\n\t\tviafb_load_reg_num =\n\t\t    display_queue_expire_num_reg.\n\t\t    iga2_display_queue_expire_num_reg.reg_num;\n\t\treg =\n\t\t    display_queue_expire_num_reg.\n\t\t    iga2_display_queue_expire_num_reg.reg;\n\t\tviafb_load_reg(reg_value, viafb_load_reg_num, reg, VIACR);\n\n\t}\n\n}\n\nstatic struct via_pll_config get_pll_config(struct pll_limit *limits, int size,\n\tint clk)\n{\n\tstruct via_pll_config cur, up, down, best = {0, 1, 0};\n\tconst u32 f0 = 14318180;  \n\tint i, f;\n\n\tfor (i = 0; i < size; i++) {\n\t\tcur.rshift = limits[i].rshift;\n\t\tcur.divisor = limits[i].divisor;\n\t\tcur.multiplier = clk / ((f0 / cur.divisor)>>cur.rshift);\n\t\tf = abs(get_pll_output_frequency(f0, cur) - clk);\n\t\tup = down = cur;\n\t\tup.multiplier++;\n\t\tdown.multiplier--;\n\t\tif (abs(get_pll_output_frequency(f0, up) - clk) < f)\n\t\t\tcur = up;\n\t\telse if (abs(get_pll_output_frequency(f0, down) - clk) < f)\n\t\t\tcur = down;\n\n\t\tif (cur.multiplier < limits[i].multiplier_min)\n\t\t\tcur.multiplier = limits[i].multiplier_min;\n\t\telse if (cur.multiplier > limits[i].multiplier_max)\n\t\t\tcur.multiplier = limits[i].multiplier_max;\n\n\t\tf = abs(get_pll_output_frequency(f0, cur) - clk);\n\t\tif (f < abs(get_pll_output_frequency(f0, best) - clk))\n\t\t\tbest = cur;\n\t}\n\n\treturn best;\n}\n\nstatic struct via_pll_config get_best_pll_config(int clk)\n{\n\tstruct via_pll_config config;\n\n\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\tcase UNICHROME_CLE266:\n\tcase UNICHROME_K400:\n\t\tconfig = get_pll_config(cle266_pll_limits,\n\t\t\tARRAY_SIZE(cle266_pll_limits), clk);\n\t\tbreak;\n\tcase UNICHROME_K800:\n\tcase UNICHROME_PM800:\n\tcase UNICHROME_CN700:\n\t\tconfig = get_pll_config(k800_pll_limits,\n\t\t\tARRAY_SIZE(k800_pll_limits), clk);\n\t\tbreak;\n\tcase UNICHROME_CX700:\n\tcase UNICHROME_CN750:\n\tcase UNICHROME_K8M890:\n\tcase UNICHROME_P4M890:\n\tcase UNICHROME_P4M900:\n\tcase UNICHROME_VX800:\n\t\tconfig = get_pll_config(cx700_pll_limits,\n\t\t\tARRAY_SIZE(cx700_pll_limits), clk);\n\t\tbreak;\n\tcase UNICHROME_VX855:\n\tcase UNICHROME_VX900:\n\t\tconfig = get_pll_config(vx855_pll_limits,\n\t\t\tARRAY_SIZE(vx855_pll_limits), clk);\n\t\tbreak;\n\t}\n\n\treturn config;\n}\n\n \nvoid viafb_set_vclock(u32 clk, int set_iga)\n{\n\tstruct via_pll_config config = get_best_pll_config(clk);\n\n\tif (set_iga == IGA1)\n\t\tclock.set_primary_pll(config);\n\tif (set_iga == IGA2)\n\t\tclock.set_secondary_pll(config);\n\n\t \n\tvia_write_misc_reg_mask(0x0C, 0x0C);  \n}\n\nstruct via_display_timing var_to_timing(const struct fb_var_screeninfo *var,\n\tu16 cxres, u16 cyres)\n{\n\tstruct via_display_timing timing;\n\tu16 dx = (var->xres - cxres) / 2, dy = (var->yres - cyres) / 2;\n\n\ttiming.hor_addr = cxres;\n\ttiming.hor_sync_start = timing.hor_addr + var->right_margin + dx;\n\ttiming.hor_sync_end = timing.hor_sync_start + var->hsync_len;\n\ttiming.hor_total = timing.hor_sync_end + var->left_margin + dx;\n\ttiming.hor_blank_start = timing.hor_addr + dx;\n\ttiming.hor_blank_end = timing.hor_total - dx;\n\ttiming.ver_addr = cyres;\n\ttiming.ver_sync_start = timing.ver_addr + var->lower_margin + dy;\n\ttiming.ver_sync_end = timing.ver_sync_start + var->vsync_len;\n\ttiming.ver_total = timing.ver_sync_end + var->upper_margin + dy;\n\ttiming.ver_blank_start = timing.ver_addr + dy;\n\ttiming.ver_blank_end = timing.ver_total - dy;\n\treturn timing;\n}\n\nvoid viafb_fill_crtc_timing(const struct fb_var_screeninfo *var,\n\tu16 cxres, u16 cyres, int iga)\n{\n\tstruct via_display_timing crt_reg = var_to_timing(var,\n\t\tcxres ? cxres : var->xres, cyres ? cyres : var->yres);\n\n\tif (iga == IGA1)\n\t\tvia_set_primary_timing(&crt_reg);\n\telse if (iga == IGA2)\n\t\tvia_set_secondary_timing(&crt_reg);\n\n\tviafb_load_fetch_count_reg(var->xres, var->bits_per_pixel / 8, iga);\n\tif (viaparinfo->chip_info->gfx_chip_name != UNICHROME_CLE266\n\t\t&& viaparinfo->chip_info->gfx_chip_name != UNICHROME_K400)\n\t\tviafb_load_FIFO_reg(iga, var->xres, var->yres);\n\n\tviafb_set_vclock(PICOS2KHZ(var->pixclock) * 1000, iga);\n}\n\nvoid viafb_init_chip_info(int chip_type)\n{\n\tvia_clock_init(&clock, chip_type);\n\tinit_gfx_chip_info(chip_type);\n\tinit_tmds_chip_info();\n\tinit_lvds_chip_info();\n\n\t \n\tviafb_set_iga_path();\n\n\tviaparinfo->lvds_setting_info->display_method = viafb_lcd_dsp_method;\n\tviaparinfo->lvds_setting_info->lcd_mode = viafb_lcd_mode;\n\tviaparinfo->lvds_setting_info2->display_method =\n\t\tviaparinfo->lvds_setting_info->display_method;\n\tviaparinfo->lvds_setting_info2->lcd_mode =\n\t\tviaparinfo->lvds_setting_info->lcd_mode;\n}\n\nvoid viafb_update_device_setting(int hres, int vres, int bpp, int flag)\n{\n\tif (flag == 0) {\n\t\tviaparinfo->tmds_setting_info->h_active = hres;\n\t\tviaparinfo->tmds_setting_info->v_active = vres;\n\t} else {\n\n\t\tif (viaparinfo->tmds_setting_info->iga_path == IGA2) {\n\t\t\tviaparinfo->tmds_setting_info->h_active = hres;\n\t\t\tviaparinfo->tmds_setting_info->v_active = vres;\n\t\t}\n\n\t}\n}\n\nstatic void init_gfx_chip_info(int chip_type)\n{\n\tu8 tmp;\n\n\tviaparinfo->chip_info->gfx_chip_name = chip_type;\n\n\t \n\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266) {\n\t\t \n\t\ttmp = viafb_read_reg(VIACR, CR4F);\n\t\tviafb_write_reg(CR4F, VIACR, 0x55);\n\t\tif (viafb_read_reg(VIACR, CR4F) != 0x55)\n\t\t\tviaparinfo->chip_info->gfx_chip_revision =\n\t\t\tCLE266_REVISION_AX;\n\t\telse\n\t\t\tviaparinfo->chip_info->gfx_chip_revision =\n\t\t\tCLE266_REVISION_CX;\n\t\t \n\t\tviafb_write_reg(CR4F, VIACR, tmp);\n\t}\n\n\tif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\n\t\ttmp = viafb_read_reg(VIASR, SR43);\n\t\tDEBUG_MSG(KERN_INFO \"SR43:%X\\n\", tmp);\n\t\tif (tmp & 0x02) {\n\t\t\tviaparinfo->chip_info->gfx_chip_revision =\n\t\t\t\tCX700_REVISION_700M2;\n\t\t} else if (tmp & 0x40) {\n\t\t\tviaparinfo->chip_info->gfx_chip_revision =\n\t\t\t\tCX700_REVISION_700M;\n\t\t} else {\n\t\t\tviaparinfo->chip_info->gfx_chip_revision =\n\t\t\t\tCX700_REVISION_700;\n\t\t}\n\t}\n\n\t \n\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\tcase UNICHROME_VX800:\n\tcase UNICHROME_VX855:\n\tcase UNICHROME_VX900:\n\t\tviaparinfo->chip_info->twod_engine = VIA_2D_ENG_M1;\n\t\tbreak;\n\tcase UNICHROME_K8M890:\n\tcase UNICHROME_P4M900:\n\t\tviaparinfo->chip_info->twod_engine = VIA_2D_ENG_H5;\n\t\tbreak;\n\tdefault:\n\t\tviaparinfo->chip_info->twod_engine = VIA_2D_ENG_H2;\n\t\tbreak;\n\t}\n}\n\nstatic void init_tmds_chip_info(void)\n{\n\tviafb_tmds_trasmitter_identify();\n\n\tif (INTERFACE_NONE == viaparinfo->chip_info->tmds_chip_info.\n\t\toutput_interface) {\n\t\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\t\tcase UNICHROME_CX700:\n\t\t\t{\n\t\t\t\t \n\t\t\t\tif ((viafb_display_hardware_layout ==\n\t\t\t\t     HW_LAYOUT_DVI_ONLY)\n\t\t\t\t    || (viafb_display_hardware_layout ==\n\t\t\t\t\tHW_LAYOUT_LCD_DVI)) {\n\t\t\t\t\tviaparinfo->chip_info->tmds_chip_info.\n\t\t\t\t\t    output_interface = INTERFACE_TMDS;\n\t\t\t\t} else {\n\t\t\t\t\tviaparinfo->chip_info->tmds_chip_info.\n\t\t\t\t\t\toutput_interface =\n\t\t\t\t\t\tINTERFACE_NONE;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\tcase UNICHROME_K8M890:\n\t\tcase UNICHROME_P4M900:\n\t\tcase UNICHROME_P4M890:\n\t\t\t \n\t\t\tviaparinfo->chip_info->tmds_chip_info.output_interface =\n\t\t\t    INTERFACE_DFP_LOW;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t{\n\t\t\t\t \n\t\t\t\tviaparinfo->chip_info->tmds_chip_info\n\t\t\t\t.output_interface = INTERFACE_DVP1;\n\t\t\t}\n\t\t}\n\t}\n\n\tDEBUG_MSG(KERN_INFO \"TMDS Chip = %d\\n\",\n\t\t  viaparinfo->chip_info->tmds_chip_info.tmds_chip_name);\n\tviafb_init_dvi_size(&viaparinfo->shared->chip_info.tmds_chip_info,\n\t\t&viaparinfo->shared->tmds_setting_info);\n}\n\nstatic void init_lvds_chip_info(void)\n{\n\tviafb_lvds_trasmitter_identify();\n\tviafb_init_lcd_size();\n\tviafb_init_lvds_output_interface(&viaparinfo->chip_info->lvds_chip_info,\n\t\t\t\t   viaparinfo->lvds_setting_info);\n\tif (viaparinfo->chip_info->lvds_chip_info2.lvds_chip_name) {\n\t\tviafb_init_lvds_output_interface(&viaparinfo->chip_info->\n\t\t\tlvds_chip_info2, viaparinfo->lvds_setting_info2);\n\t}\n\t \n\tif ((UNICHROME_CX700 == viaparinfo->chip_info->gfx_chip_name)\n\t    && (HW_LAYOUT_LCD1_LCD2 == viafb_display_hardware_layout)) {\n\t\tif ((INTEGRATED_LVDS == viaparinfo->chip_info->lvds_chip_info.\n\t\t\tlvds_chip_name) && (INTEGRATED_LVDS ==\n\t\t\tviaparinfo->chip_info->\n\t\t\tlvds_chip_info2.lvds_chip_name)) {\n\t\t\tviaparinfo->chip_info->lvds_chip_info.output_interface =\n\t\t\t\tINTERFACE_LVDS0;\n\t\t\tviaparinfo->chip_info->lvds_chip_info2.\n\t\t\t\toutput_interface =\n\t\t\t    INTERFACE_LVDS1;\n\t\t}\n\t}\n\n\tDEBUG_MSG(KERN_INFO \"LVDS Chip = %d\\n\",\n\t\t  viaparinfo->chip_info->lvds_chip_info.lvds_chip_name);\n\tDEBUG_MSG(KERN_INFO \"LVDS1 output_interface = %d\\n\",\n\t\t  viaparinfo->chip_info->lvds_chip_info.output_interface);\n\tDEBUG_MSG(KERN_INFO \"LVDS2 output_interface = %d\\n\",\n\t\t  viaparinfo->chip_info->lvds_chip_info.output_interface);\n}\n\nvoid viafb_init_dac(int set_iga)\n{\n\tint i;\n\tu8 tmp;\n\n\tif (set_iga == IGA1) {\n\t\t \n\t\tviafb_write_reg_mask(SR1A, VIASR, 0x00, BIT0);\n\t\t \n\t\tviafb_write_reg_mask(SR1B, VIASR, 0x00, BIT7 + BIT6);\n\t\tfor (i = 0; i < 256; i++) {\n\t\t\twrite_dac_reg(i, palLUT_table[i].red,\n\t\t\t\t      palLUT_table[i].green,\n\t\t\t\t      palLUT_table[i].blue);\n\t\t}\n\t\t \n\t\tviafb_write_reg_mask(SR1B, VIASR, 0xC0, BIT7 + BIT6);\n\t} else {\n\t\ttmp = viafb_read_reg(VIACR, CR6A);\n\t\t \n\t\tviafb_write_reg_mask(CR6A, VIACR, 0x40, BIT6);\n\t\tviafb_write_reg_mask(SR1A, VIASR, 0x01, BIT0);\n\t\tfor (i = 0; i < 256; i++) {\n\t\t\twrite_dac_reg(i, palLUT_table[i].red,\n\t\t\t\t      palLUT_table[i].green,\n\t\t\t\t      palLUT_table[i].blue);\n\t\t}\n\t\t \n\t\tviafb_write_reg_mask(SR1A, VIASR, 0x00, BIT0);\n\t\tviafb_write_reg(CR6A, VIACR, tmp);\n\t}\n}\n\nstatic void device_screen_off(void)\n{\n\t \n\tviafb_write_reg_mask(SR01, VIASR, 0x20, BIT5);\n}\n\nstatic void device_screen_on(void)\n{\n\t \n\tviafb_write_reg_mask(SR01, VIASR, 0x00, BIT5);\n}\n\nstatic void set_display_channel(void)\n{\n\t \n\tif (viafb_LCD2_ON &&\n\t\tviaparinfo->lvds_setting_info2->device_lcd_dualedge) {\n\t\t \n\t\t \n\t\tviafb_write_reg_mask(CRD2, VIACR, 0x20, BIT4 + BIT5);\n\t} else if (viafb_LCD_ON && viafb_DVI_ON) {\n\t\t \n\t\t \n\t\tviafb_write_reg_mask(CRD2, VIACR, 0x10, BIT4 + BIT5);\n\t} else if (viafb_DVI_ON) {\n\t\t \n\t\tviafb_write_reg_mask(CRD2, VIACR, 0x30, BIT4 + BIT5);\n\t} else if (viafb_LCD_ON) {\n\t\tif (viaparinfo->lvds_setting_info->device_lcd_dualedge) {\n\t\t\t \n\t\t\t \n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0x20, BIT4 + BIT5);\n\t\t} else {\n\t\t\t \n\t\t\tviafb_write_reg_mask(CRD2, VIACR, 0x00, BIT4 + BIT5);\n\t\t}\n\t}\n}\n\nstatic u8 get_sync(struct fb_var_screeninfo *var)\n{\n\tu8 polarity = 0;\n\n\tif (!(var->sync & FB_SYNC_HOR_HIGH_ACT))\n\t\tpolarity |= VIA_HSYNC_NEGATIVE;\n\tif (!(var->sync & FB_SYNC_VERT_HIGH_ACT))\n\t\tpolarity |= VIA_VSYNC_NEGATIVE;\n\treturn polarity;\n}\n\nstatic void hw_init(void)\n{\n\tint i;\n\n\tinb(VIAStatus);\n\toutb(0x00, VIAAR);\n\n\t \n\tviafb_write_regx(common_vga, ARRAY_SIZE(common_vga));\n\tswitch (viaparinfo->chip_info->gfx_chip_name) {\n\tcase UNICHROME_CLE266:\n\t\tviafb_write_regx(CLE266_ModeXregs, NUM_TOTAL_CLE266_ModeXregs);\n\t\tbreak;\n\n\tcase UNICHROME_K400:\n\t\tviafb_write_regx(KM400_ModeXregs, NUM_TOTAL_KM400_ModeXregs);\n\t\tbreak;\n\n\tcase UNICHROME_K800:\n\tcase UNICHROME_PM800:\n\t\tviafb_write_regx(CN400_ModeXregs, NUM_TOTAL_CN400_ModeXregs);\n\t\tbreak;\n\n\tcase UNICHROME_CN700:\n\tcase UNICHROME_K8M890:\n\tcase UNICHROME_P4M890:\n\tcase UNICHROME_P4M900:\n\t\tviafb_write_regx(CN700_ModeXregs, NUM_TOTAL_CN700_ModeXregs);\n\t\tbreak;\n\n\tcase UNICHROME_CX700:\n\tcase UNICHROME_VX800:\n\t\tviafb_write_regx(CX700_ModeXregs, NUM_TOTAL_CX700_ModeXregs);\n\t\tbreak;\n\n\tcase UNICHROME_VX855:\n\tcase UNICHROME_VX900:\n\t\tviafb_write_regx(VX855_ModeXregs, NUM_TOTAL_VX855_ModeXregs);\n\t\tbreak;\n\t}\n\n\t \n\tvia_write_reg_mask(VIACR, 0x45, 0x00, 0x01);\n\n\t \n\tvia_write_reg_mask(VIACR, 0xFD, 0, 0x80);  \n\tviafb_write_regx(scaling_parameters, ARRAY_SIZE(scaling_parameters));\n\n\t \n\t \n\toutb(VPIT.Misc, VIA_MISC_REG_WRITE);\n\n\t \n\tfor (i = 1; i <= StdSR; i++)\n\t\tvia_write_reg(VIASR, i, VPIT.SR[i - 1]);\n\n\tviafb_write_reg_mask(0x15, VIASR, 0xA2, 0xA2);\n\n\t \n\tfor (i = 0; i < StdGR; i++)\n\t\tvia_write_reg(VIAGR, i, VPIT.GR[i]);\n\n\t \n\tfor (i = 0; i < StdAR; i++) {\n\t\tinb(VIAStatus);\n\t\toutb(i, VIAAR);\n\t\toutb(VPIT.AR[i], VIAAR);\n\t}\n\n\tinb(VIAStatus);\n\toutb(0x20, VIAAR);\n\n\tload_fix_bit_crtc_reg();\n}\n\nint viafb_setmode(void)\n{\n\tint j, cxres = 0, cyres = 0;\n\tint port;\n\tu32 devices = viaparinfo->shared->iga1_devices\n\t\t| viaparinfo->shared->iga2_devices;\n\tu8 value, index, mask;\n\tstruct fb_var_screeninfo var2;\n\n\tdevice_screen_off();\n\tdevice_off();\n\tvia_set_state(devices, VIA_STATE_OFF);\n\n\thw_init();\n\n\t \n\n\tif ((viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266\n\t\t|| viaparinfo->chip_info->gfx_chip_name == UNICHROME_K400)\n\t\t&& viafbinfo->var.xres == 1024 && viafbinfo->var.yres == 768) {\n\t\tfor (j = 0; j < res_patch_table[0].table_length; j++) {\n\t\t\tindex = res_patch_table[0].io_reg_table[j].index;\n\t\t\tport = res_patch_table[0].io_reg_table[j].port;\n\t\t\tvalue = res_patch_table[0].io_reg_table[j].value;\n\t\t\tmask = res_patch_table[0].io_reg_table[j].mask;\n\t\t\tviafb_write_reg_mask(index, port, value, mask);\n\t\t}\n\t}\n\n\tvia_set_primary_pitch(viafbinfo->fix.line_length);\n\tvia_set_secondary_pitch(viafb_dual_fb ? viafbinfo1->fix.line_length\n\t\t: viafbinfo->fix.line_length);\n\tvia_set_primary_color_depth(viaparinfo->depth);\n\tvia_set_secondary_color_depth(viafb_dual_fb ? viaparinfo1->depth\n\t\t: viaparinfo->depth);\n\tvia_set_source(viaparinfo->shared->iga1_devices, IGA1);\n\tvia_set_source(viaparinfo->shared->iga2_devices, IGA2);\n\tif (viaparinfo->shared->iga2_devices)\n\t\tenable_second_display_channel();\n\telse\n\t\tdisable_second_display_channel();\n\n\t \n\n\t \n\n\tif (viafb_dual_fb) {\n\t\tvar2 = viafbinfo1->var;\n\t} else if (viafb_SAMM_ON) {\n\t\tviafb_fill_var_timing_info(&var2, viafb_get_best_mode(\n\t\t\tviafb_second_xres, viafb_second_yres, viafb_refresh1));\n\t\tcxres = viafbinfo->var.xres;\n\t\tcyres = viafbinfo->var.yres;\n\t\tvar2.bits_per_pixel = viafbinfo->var.bits_per_pixel;\n\t}\n\n\t \n\tif (viafb_CRT_ON) {\n\t\tif (viaparinfo->shared->iga2_devices & VIA_CRT\n\t\t\t&& viafb_SAMM_ON)\n\t\t\tviafb_fill_crtc_timing(&var2, cxres, cyres, IGA2);\n\t\telse\n\t\t\tviafb_fill_crtc_timing(&viafbinfo->var, 0, 0,\n\t\t\t\t(viaparinfo->shared->iga1_devices & VIA_CRT)\n\t\t\t\t? IGA1 : IGA2);\n\n\t\t \n\t\tif (viafbinfo->var.xres % 8) {\n\t\t\tviafb_unlock_crt();\n\t\t\tviafb_write_reg(CR02, VIACR,\n\t\t\t\tviafb_read_reg(VIACR, CR02) - 1);\n\t\t\tviafb_lock_crt();\n\t\t}\n\t}\n\n\tif (viafb_DVI_ON) {\n\t\tif (viaparinfo->shared->tmds_setting_info.iga_path == IGA2\n\t\t\t&& viafb_SAMM_ON)\n\t\t\tviafb_dvi_set_mode(&var2, cxres, cyres, IGA2);\n\t\telse\n\t\t\tviafb_dvi_set_mode(&viafbinfo->var, 0, 0,\n\t\t\t\tviaparinfo->tmds_setting_info->iga_path);\n\t}\n\n\tif (viafb_LCD_ON) {\n\t\tif (viafb_SAMM_ON &&\n\t\t\t(viaparinfo->lvds_setting_info->iga_path == IGA2)) {\n\t\t\tviafb_lcd_set_mode(&var2, cxres, cyres,\n\t\t\t\tviaparinfo->lvds_setting_info,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info);\n\t\t} else {\n\t\t\t \n\t\t\tif (viaparinfo->lvds_setting_info->iga_path == IGA1) {\n\t\t\t\tviaparinfo->lvds_setting_info->display_method =\n\t\t\t\t    LCD_CENTERING;\n\t\t\t}\n\t\t\tviafb_lcd_set_mode(&viafbinfo->var, 0, 0,\n\t\t\t\tviaparinfo->lvds_setting_info,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info);\n\t\t}\n\t}\n\tif (viafb_LCD2_ON) {\n\t\tif (viafb_SAMM_ON &&\n\t\t\t(viaparinfo->lvds_setting_info2->iga_path == IGA2)) {\n\t\t\tviafb_lcd_set_mode(&var2, cxres, cyres,\n\t\t\t\tviaparinfo->lvds_setting_info2,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info2);\n\t\t} else {\n\t\t\t \n\t\t\tif (viaparinfo->lvds_setting_info2->iga_path == IGA1) {\n\t\t\t\tviaparinfo->lvds_setting_info2->display_method =\n\t\t\t\t    LCD_CENTERING;\n\t\t\t}\n\t\t\tviafb_lcd_set_mode(&viafbinfo->var, 0, 0,\n\t\t\t\tviaparinfo->lvds_setting_info2,\n\t\t\t\t&viaparinfo->chip_info->lvds_chip_info2);\n\t\t}\n\t}\n\n\tif ((viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700)\n\t    && (viafb_LCD_ON || viafb_DVI_ON))\n\t\tset_display_channel();\n\n\t \n\tif (!viafb_hotplug) {\n\t\tviafb_hotplug_Xres = viafbinfo->var.xres;\n\t\tviafb_hotplug_Yres = viafbinfo->var.yres;\n\t\tviafb_hotplug_bpp = viafbinfo->var.bits_per_pixel;\n\t\tviafb_hotplug_refresh = viafb_refresh;\n\n\t\tif (viafb_DVI_ON)\n\t\t\tviafb_DeviceStatus = DVI_Device;\n\t\telse\n\t\t\tviafb_DeviceStatus = CRT_Device;\n\t}\n\tdevice_on();\n\tif (!viafb_SAMM_ON)\n\t\tvia_set_sync_polarity(devices, get_sync(&viafbinfo->var));\n\telse {\n\t\tvia_set_sync_polarity(viaparinfo->shared->iga1_devices,\n\t\t\tget_sync(&viafbinfo->var));\n\t\tvia_set_sync_polarity(viaparinfo->shared->iga2_devices,\n\t\t\tget_sync(&var2));\n\t}\n\n\tclock.set_engine_pll_state(VIA_STATE_ON);\n\tclock.set_primary_clock_source(VIA_CLKSRC_X1, true);\n\tclock.set_secondary_clock_source(VIA_CLKSRC_X1, true);\n\n#ifdef CONFIG_FB_VIA_X_COMPATIBILITY\n\tclock.set_primary_pll_state(VIA_STATE_ON);\n\tclock.set_primary_clock_state(VIA_STATE_ON);\n\tclock.set_secondary_pll_state(VIA_STATE_ON);\n\tclock.set_secondary_clock_state(VIA_STATE_ON);\n#else\n\tif (viaparinfo->shared->iga1_devices) {\n\t\tclock.set_primary_pll_state(VIA_STATE_ON);\n\t\tclock.set_primary_clock_state(VIA_STATE_ON);\n\t} else {\n\t\tclock.set_primary_pll_state(VIA_STATE_OFF);\n\t\tclock.set_primary_clock_state(VIA_STATE_OFF);\n\t}\n\n\tif (viaparinfo->shared->iga2_devices) {\n\t\tclock.set_secondary_pll_state(VIA_STATE_ON);\n\t\tclock.set_secondary_clock_state(VIA_STATE_ON);\n\t} else {\n\t\tclock.set_secondary_pll_state(VIA_STATE_OFF);\n\t\tclock.set_secondary_clock_state(VIA_STATE_OFF);\n\t}\n#endif  \n\n\tvia_set_state(devices, VIA_STATE_ON);\n\tdevice_screen_on();\n\treturn 1;\n}\n\nint viafb_get_refresh(int hres, int vres, u32 long_refresh)\n{\n\tconst struct fb_videomode *best;\n\n\tbest = viafb_get_best_mode(hres, vres, long_refresh);\n\tif (!best)\n\t\treturn 60;\n\n\tif (abs(best->refresh - long_refresh) > 3) {\n\t\tif (hres == 1200 && vres == 900)\n\t\t\treturn 49;  \n\t\telse\n\t\t\treturn 60;\n\t}\n\n\treturn best->refresh;\n}\n\nstatic void device_off(void)\n{\n\tviafb_dvi_disable();\n\tviafb_lcd_disable();\n}\n\nstatic void device_on(void)\n{\n\tif (viafb_DVI_ON == 1)\n\t\tviafb_dvi_enable();\n\tif (viafb_LCD_ON == 1)\n\t\tviafb_lcd_enable();\n}\n\nstatic void enable_second_display_channel(void)\n{\n\t \n\tviafb_write_reg_mask(CR6A, VIACR, 0x00, BIT6);\n\tviafb_write_reg_mask(CR6A, VIACR, BIT7, BIT7);\n\tviafb_write_reg_mask(CR6A, VIACR, BIT6, BIT6);\n}\n\nstatic void disable_second_display_channel(void)\n{\n\t \n\tviafb_write_reg_mask(CR6A, VIACR, 0x00, BIT6);\n\tviafb_write_reg_mask(CR6A, VIACR, 0x00, BIT7);\n\tviafb_write_reg_mask(CR6A, VIACR, BIT6, BIT6);\n}\n\nvoid viafb_set_dpa_gfx(int output_interface, struct GFX_DPA_SETTING\\\n\t\t\t\t\t*p_gfx_dpa_setting)\n{\n\tswitch (output_interface) {\n\tcase INTERFACE_DVP0:\n\t\t{\n\t\t\t \n\t\t\tviafb_write_reg_mask(CR96, VIACR,\n\t\t\t\t       p_gfx_dpa_setting->DVP0, 0x0F);\n\n\t\t\t \n\t\t\tviafb_write_reg_mask(SR1E, VIASR,\n\t\t\t\t       p_gfx_dpa_setting->DVP0ClockDri_S, BIT2);\n\t\t\tviafb_write_reg_mask(SR2A, VIASR,\n\t\t\t\t       p_gfx_dpa_setting->DVP0ClockDri_S1,\n\t\t\t\t       BIT4);\n\t\t\tviafb_write_reg_mask(SR1B, VIASR,\n\t\t\t\t       p_gfx_dpa_setting->DVP0DataDri_S, BIT1);\n\t\t\tviafb_write_reg_mask(SR2A, VIASR,\n\t\t\t\t       p_gfx_dpa_setting->DVP0DataDri_S1, BIT5);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_DVP1:\n\t\t{\n\t\t\t \n\t\t\tviafb_write_reg_mask(CR9B, VIACR,\n\t\t\t\t       p_gfx_dpa_setting->DVP1, 0x0F);\n\n\t\t\t \n\t\t\tviafb_write_reg_mask(SR65, VIASR,\n\t\t\t\t       p_gfx_dpa_setting->DVP1Driving, 0x0F);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_DFP_HIGH:\n\t\t{\n\t\t\tviafb_write_reg_mask(CR97, VIACR,\n\t\t\t\t       p_gfx_dpa_setting->DFPHigh, 0x0F);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_DFP_LOW:\n\t\t{\n\t\t\tviafb_write_reg_mask(CR99, VIACR,\n\t\t\t\t       p_gfx_dpa_setting->DFPLow, 0x0F);\n\t\t\tbreak;\n\t\t}\n\n\tcase INTERFACE_DFP:\n\t\t{\n\t\t\tviafb_write_reg_mask(CR97, VIACR,\n\t\t\t\t       p_gfx_dpa_setting->DFPHigh, 0x0F);\n\t\t\tviafb_write_reg_mask(CR99, VIACR,\n\t\t\t\t       p_gfx_dpa_setting->DFPLow, 0x0F);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nvoid viafb_fill_var_timing_info(struct fb_var_screeninfo *var,\n\tconst struct fb_videomode *mode)\n{\n\tvar->pixclock = mode->pixclock;\n\tvar->xres = mode->xres;\n\tvar->yres = mode->yres;\n\tvar->left_margin = mode->left_margin;\n\tvar->right_margin = mode->right_margin;\n\tvar->hsync_len = mode->hsync_len;\n\tvar->upper_margin = mode->upper_margin;\n\tvar->lower_margin = mode->lower_margin;\n\tvar->vsync_len = mode->vsync_len;\n\tvar->sync = mode->sync;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}