{
  "module_name": "fm2fb.c",
  "hash_id": "8022f3beef05515ee69f50d4ba77ef9155227daa40834df6b593c078186c9d2b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/fm2fb.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/mm.h>\n#include <linux/fb.h>\n#include <linux/init.h>\n#include <linux/zorro.h>\n#include <asm/io.h>\n\n \n\n \n\n#define FRAMEMASTER_SIZE\t0x200000\n#define FRAMEMASTER_REG\t\t0x1ffff8\n\n#define FRAMEMASTER_NOLACE\t1\n#define FRAMEMASTER_ENABLE\t2\n#define FRAMEMASTER_COMPL\t4\n#define FRAMEMASTER_ROM\t\t8\n\nstatic volatile unsigned char *fm2fb_reg;\n\nstatic struct fb_fix_screeninfo fb_fix = {\n\t.smem_len =\tFRAMEMASTER_REG,\n\t.type =\t\tFB_TYPE_PACKED_PIXELS,\n\t.visual =\tFB_VISUAL_TRUECOLOR,\n\t.line_length =\t(768 << 2),\n\t.mmio_len =\t(8),\n\t.accel =\tFB_ACCEL_NONE,\n};\n\nstatic int fm2fb_mode = -1;\n\n#define FM2FB_MODE_PAL\t0\n#define FM2FB_MODE_NTSC\t1\n\nstatic struct fb_var_screeninfo fb_var_modes[] = {\n    {\n\t \n\t768, 576, 768, 576, 0, 0, 32, 0,\n\t{ 16, 8, 0 }, { 8, 8, 0 }, { 0, 8, 0 }, { 24, 8, 0 },\n\t0, FB_ACTIVATE_NOW, -1, -1, FB_ACCEL_NONE,\n\t33333, 10, 102, 10, 5, 80, 34, FB_SYNC_COMP_HIGH_ACT, 0\n    }, {\n\t \n\t768, 480, 768, 480, 0, 0, 32, 0,\n\t{ 16, 8, 0 }, { 8, 8, 0 }, { 0, 8, 0 }, { 24, 8, 0 },\n\t0, FB_ACTIVATE_NOW, -1, -1, FB_ACCEL_NONE,\n\t33333, 10, 102, 10, 5, 80, 34, FB_SYNC_COMP_HIGH_ACT, 0\n    }\n};\n\n     \n\nstatic int fm2fb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\n                           u_int transp, struct fb_info *info);\nstatic int fm2fb_blank(int blank, struct fb_info *info);\n\nstatic const struct fb_ops fm2fb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_setcolreg\t= fm2fb_setcolreg,\n\t.fb_blank\t= fm2fb_blank,\n};\n\n     \nstatic int fm2fb_blank(int blank, struct fb_info *info)\n{\n\tunsigned char t = FRAMEMASTER_ROM;\n\n\tif (!blank)\n\t\tt |= FRAMEMASTER_ENABLE | FRAMEMASTER_NOLACE;\n\tfm2fb_reg[0] = t;\n\treturn 0;\n}\n\n     \nstatic int fm2fb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\n                         u_int transp, struct fb_info *info)\n{\n\tif (regno < 16) {\n\t\tred >>= 8;\n\t\tgreen >>= 8;\n\t\tblue >>= 8;\n\n\t\t((u32*)(info->pseudo_palette))[regno] = (red << 16) |\n\t\t\t(green << 8) | blue;\n\t}\n\n\treturn 0;\n}\n\n     \n\nstatic int fm2fb_probe(struct zorro_dev *z, const struct zorro_device_id *id);\n\nstatic const struct zorro_device_id fm2fb_devices[] = {\n\t{ ZORRO_PROD_BSC_FRAMEMASTER_II },\n\t{ ZORRO_PROD_HELFRICH_RAINBOW_II },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(zorro, fm2fb_devices);\n\nstatic struct zorro_driver fm2fb_driver = {\n\t.name\t\t= \"fm2fb\",\n\t.id_table\t= fm2fb_devices,\n\t.probe\t\t= fm2fb_probe,\n};\n\nstatic int fm2fb_probe(struct zorro_dev *z, const struct zorro_device_id *id)\n{\n\tstruct fb_info *info;\n\tunsigned long *ptr;\n\tint is_fm;\n\tint x, y;\n\n\tis_fm = z->id == ZORRO_PROD_BSC_FRAMEMASTER_II;\n\n\tif (!zorro_request_device(z,\"fm2fb\"))\n\t\treturn -ENXIO;\n\n\tinfo = framebuffer_alloc(16 * sizeof(u32), &z->dev);\n\tif (!info) {\n\t\tzorro_release_device(z);\n\t\treturn -ENOMEM;\n\t}\n\n\tif (fb_alloc_cmap(&info->cmap, 256, 0) < 0) {\n\t\tframebuffer_release(info);\n\t\tzorro_release_device(z);\n\t\treturn -ENOMEM;\n\t}\n\n\t \n\tfb_fix.smem_start = zorro_resource_start(z);\n\tinfo->screen_base = ioremap(fb_fix.smem_start, FRAMEMASTER_SIZE);\n\tfb_fix.mmio_start = fb_fix.smem_start + FRAMEMASTER_REG;\n\tfm2fb_reg  = (unsigned char *)(info->screen_base+FRAMEMASTER_REG);\n\n\tstrcpy(fb_fix.id, is_fm ? \"FrameMaster II\" : \"Rainbow II\");\n\n\t \n\tptr = (unsigned long *)fb_fix.smem_start;\n\tfor (y = 0; y < 576; y++) {\n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0xffffff; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0xffff00; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0x00ffff; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0x00ff00; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0xff00ff; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0xff0000; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0x0000ff; \n\t\tfor (x = 0; x < 96; x++) *ptr++ = 0x000000; \n\t}\n\tfm2fb_blank(0, info);\n\n\tif (fm2fb_mode == -1)\n\t\tfm2fb_mode = FM2FB_MODE_PAL;\n\n\tinfo->fbops = &fm2fb_ops;\n\tinfo->var = fb_var_modes[fm2fb_mode];\n\tinfo->pseudo_palette = info->par;\n\tinfo->par = NULL;\n\tinfo->fix = fb_fix;\n\n\tif (register_framebuffer(info) < 0) {\n\t\tfb_dealloc_cmap(&info->cmap);\n\t\tiounmap(info->screen_base);\n\t\tframebuffer_release(info);\n\t\tzorro_release_device(z);\n\t\treturn -EINVAL;\n\t}\n\tfb_info(info, \"%s frame buffer device\\n\", fb_fix.id);\n\treturn 0;\n}\n\nstatic int __init fm2fb_setup(char *options)\n{\n\tchar *this_opt;\n\n\tif (!options || !*options)\n\t\treturn 0;\n\n\twhile ((this_opt = strsep(&options, \",\")) != NULL) {\n\t\tif (!strncmp(this_opt, \"pal\", 3))\n\t\t\tfm2fb_mode = FM2FB_MODE_PAL;\n\t\telse if (!strncmp(this_opt, \"ntsc\", 4))\n\t\t\tfm2fb_mode = FM2FB_MODE_NTSC;\n\t}\n\treturn 0;\n}\n\nstatic int __init fm2fb_init(void)\n{\n\tchar *option = NULL;\n\n\tif (fb_get_options(\"fm2fb\", &option))\n\t\treturn -ENODEV;\n\tfm2fb_setup(option);\n\treturn zorro_register_driver(&fm2fb_driver);\n}\n\nmodule_init(fm2fb_init);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}