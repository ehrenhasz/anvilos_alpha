{
  "module_name": "nv_backlight.c",
  "hash_id": "6be96d83310efaf7db097c4eb0228d81426bb1aaaa4ebb28669943e17142a12a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/nvidia/nv_backlight.c",
  "human_readable_source": "\n \n\n#include <linux/backlight.h>\n#include <linux/fb.h>\n#include <linux/pci.h>\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n#include <asm/backlight.h>\n#endif\n\n#include \"nv_local.h\"\n#include \"nv_type.h\"\n#include \"nv_proto.h\"\n\n \n#define MIN_LEVEL 0x158\n#define MAX_LEVEL 0x534\n#define LEVEL_STEP ((MAX_LEVEL - MIN_LEVEL) / FB_BACKLIGHT_MAX)\n\nstatic int nvidia_bl_get_level_brightness(struct nvidia_par *par,\n\t\tint level)\n{\n\tstruct fb_info *info = pci_get_drvdata(par->pci_dev);\n\tint nlevel;\n\n\t \n\t \n\tnlevel = MIN_LEVEL + info->bl_curve[level] * LEVEL_STEP;\n\n\tif (nlevel < 0)\n\t\tnlevel = 0;\n\telse if (nlevel < MIN_LEVEL)\n\t\tnlevel = MIN_LEVEL;\n\telse if (nlevel > MAX_LEVEL)\n\t\tnlevel = MAX_LEVEL;\n\n\treturn nlevel;\n}\n\nstatic int nvidia_bl_update_status(struct backlight_device *bd)\n{\n\tstruct nvidia_par *par = bl_get_data(bd);\n\tu32 tmp_pcrt, tmp_pmc, fpcontrol;\n\tint level = backlight_get_brightness(bd);\n\n\tif (!par->FlatPanel)\n\t\treturn 0;\n\n\ttmp_pmc = NV_RD32(par->PMC, 0x10F0) & 0x0000FFFF;\n\ttmp_pcrt = NV_RD32(par->PCRTC0, 0x081C) & 0xFFFFFFFC;\n\tfpcontrol = NV_RD32(par->PRAMDAC, 0x0848) & 0xCFFFFFCC;\n\n\tif (level > 0) {\n\t\ttmp_pcrt |= 0x1;\n\t\ttmp_pmc |= (1 << 31);  \n\t\ttmp_pmc |= nvidia_bl_get_level_brightness(par, level) << 16;\n\t\tfpcontrol |= par->fpSyncs;\n\t} else\n\t\tfpcontrol |= 0x20000022;\n\n\tNV_WR32(par->PCRTC0, 0x081C, tmp_pcrt);\n\tNV_WR32(par->PMC, 0x10F0, tmp_pmc);\n\tNV_WR32(par->PRAMDAC, 0x848, fpcontrol);\n\n\treturn 0;\n}\n\nstatic const struct backlight_ops nvidia_bl_ops = {\n\t.update_status\t= nvidia_bl_update_status,\n};\n\nvoid nvidia_bl_init(struct nvidia_par *par)\n{\n\tstruct backlight_properties props;\n\tstruct fb_info *info = pci_get_drvdata(par->pci_dev);\n\tstruct backlight_device *bd;\n\tchar name[12];\n\n\tif (!par->FlatPanel)\n\t\treturn;\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n\tif (!machine_is(powermac) ||\n\t    !pmac_has_backlight_type(\"mnca\"))\n\t\treturn;\n#endif\n\n\tsnprintf(name, sizeof(name), \"nvidiabl%d\", info->node);\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_RAW;\n\tprops.max_brightness = FB_BACKLIGHT_LEVELS - 1;\n\tbd = backlight_device_register(name, info->device, par, &nvidia_bl_ops,\n\t\t\t\t       &props);\n\tif (IS_ERR(bd)) {\n\t\tinfo->bl_dev = NULL;\n\t\tprintk(KERN_WARNING \"nvidia: Backlight registration failed\\n\");\n\t\tgoto error;\n\t}\n\n\tinfo->bl_dev = bd;\n\tfb_bl_default_curve(info, 0,\n\t\t0x158 * FB_BACKLIGHT_MAX / MAX_LEVEL,\n\t\t0x534 * FB_BACKLIGHT_MAX / MAX_LEVEL);\n\n\tbd->props.brightness = bd->props.max_brightness;\n\tbd->props.power = FB_BLANK_UNBLANK;\n\tbacklight_update_status(bd);\n\n\tprintk(\"nvidia: Backlight initialized (%s)\\n\", name);\n\nerror:\n\treturn;\n}\n\nvoid nvidia_bl_exit(struct nvidia_par *par)\n{\n\tstruct fb_info *info = pci_get_drvdata(par->pci_dev);\n\tstruct backlight_device *bd = info->bl_dev;\n\n\tbacklight_device_unregister(bd);\n\tprintk(\"nvidia: Backlight unloaded\\n\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}