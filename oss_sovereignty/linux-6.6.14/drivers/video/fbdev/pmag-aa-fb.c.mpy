{
  "module_name": "pmag-aa-fb.c",
  "hash_id": "a525e29807c589e611b9ee90f29fc15cbcb239bb1fab0923d7e058f67f65566d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/video/fbdev/pmag-aa-fb.c",
  "human_readable_source": " \n\n#include <linux/compiler.h>\n#include <linux/errno.h>\n#include <linux/fb.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/tc.h>\n#include <linux/timer.h>\n\n#include \"bt455.h\"\n#include \"bt431.h\"\n\n \n#define DRIVER_VERSION \"0.03\"\n#define DRIVER_AUTHOR \"Karsten Merker <merker@linuxtag.org>\"\n#define DRIVER_DESCRIPTION \"PMAG-AA Framebuffer Driver\"\n\n \n#define PMAG_AA_BT455_OFFSET\t\t0x100000\n\n \n#define PMAG_AA_BT431_OFFSET\t\t0x180000\n\n \n#define PMAG_AA_ONBOARD_FBMEM_OFFSET\t0x200000\n\nstruct aafb_par {\n\tvoid __iomem *mmio;\n\tstruct bt455_regs __iomem *bt455;\n\tstruct bt431_regs __iomem *bt431;\n};\n\nstatic const struct fb_var_screeninfo aafb_defined = {\n\t.xres\t\t= 1280,\n\t.yres\t\t= 1024,\n\t.xres_virtual\t= 2048,\n\t.yres_virtual\t= 1024,\n\t.bits_per_pixel\t= 8,\n\t.grayscale\t= 1,\n\t.red.length\t= 0,\n\t.green.length\t= 1,\n\t.blue.length\t= 0,\n\t.activate\t= FB_ACTIVATE_NOW,\n\t.accel_flags\t= FB_ACCEL_NONE,\n\t.pixclock\t= 7645,\n\t.left_margin\t= 224,\n\t.right_margin\t= 32,\n\t.upper_margin\t= 33,\n\t.lower_margin\t= 3,\n\t.hsync_len\t= 160,\n\t.vsync_len\t= 3,\n\t.sync\t\t= FB_SYNC_ON_GREEN,\n\t.vmode\t\t= FB_VMODE_NONINTERLACED,\n};\n\nstatic const struct fb_fix_screeninfo aafb_fix = {\n\t.id\t\t= \"PMAG-AA\",\n\t.smem_len\t= (2048 * 1024),\n\t.type\t\t= FB_TYPE_PACKED_PIXELS,\n\t.visual\t\t= FB_VISUAL_MONO10,\n\t.ypanstep\t= 1,\n\t.ywrapstep\t= 1,\n\t.line_length\t= 2048,\n\t.mmio_len\t= PMAG_AA_ONBOARD_FBMEM_OFFSET - PMAG_AA_BT455_OFFSET,\n};\n\nstatic int aafb_cursor(struct fb_info *info, struct fb_cursor *cursor)\n{\n\tstruct aafb_par *par = info->par;\n\n\tif (cursor->image.height > BT431_CURSOR_SIZE ||\n\t    cursor->image.width > BT431_CURSOR_SIZE) {\n\t\tbt431_erase_cursor(par->bt431);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!cursor->enable)\n\t\tbt431_erase_cursor(par->bt431);\n\n\tif (cursor->set & FB_CUR_SETPOS)\n\t\tbt431_position_cursor(par->bt431,\n\t\t\t\t      cursor->image.dx, cursor->image.dy);\n\tif (cursor->set & FB_CUR_SETCMAP) {\n\t\tu8 fg = cursor->image.fg_color ? 0xf : 0x0;\n\t\tu8 bg = cursor->image.bg_color ? 0xf : 0x0;\n\n\t\tbt455_write_cmap_entry(par->bt455, 8, bg);\n\t\tbt455_write_cmap_next(par->bt455, bg);\n\t\tbt455_write_ovly_next(par->bt455, fg);\n\t}\n\tif (cursor->set & (FB_CUR_SETSIZE | FB_CUR_SETSHAPE | FB_CUR_SETIMAGE))\n\t\tbt431_set_cursor(par->bt431,\n\t\t\t\t cursor->image.data, cursor->mask, cursor->rop,\n\t\t\t\t cursor->image.width, cursor->image.height);\n\n\tif (cursor->enable)\n\t\tbt431_enable_cursor(par->bt431);\n\n\treturn 0;\n}\n\n \n\nstatic int aafb_blank(int blank, struct fb_info *info)\n{\n\tstruct aafb_par *par = info->par;\n\tu8 val = blank ? 0x00 : 0x0f;\n\n\tbt455_write_cmap_entry(par->bt455, 1, val);\n\treturn 0;\n}\n\nstatic const struct fb_ops aafb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_blank\t= aafb_blank,\n\t.fb_cursor\t= aafb_cursor,\n};\n\nstatic int pmagaafb_probe(struct device *dev)\n{\n\tstruct tc_dev *tdev = to_tc_dev(dev);\n\tresource_size_t start, len;\n\tstruct fb_info *info;\n\tstruct aafb_par *par;\n\tint err;\n\n\tinfo = framebuffer_alloc(sizeof(struct aafb_par), dev);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tpar = info->par;\n\tdev_set_drvdata(dev, info);\n\n\tinfo->fbops = &aafb_ops;\n\tinfo->fix = aafb_fix;\n\tinfo->var = aafb_defined;\n\n\t \n\tstart = tdev->resource.start;\n\tlen = tdev->resource.end - start + 1;\n\tif (!request_mem_region(start, len, dev_name(dev))) {\n\t\tprintk(KERN_ERR \"%s: Cannot reserve FB region\\n\",\n\t\t       dev_name(dev));\n\t\terr = -EBUSY;\n\t\tgoto err_alloc;\n\t}\n\n\t \n\tinfo->fix.mmio_start = start + PMAG_AA_BT455_OFFSET;\n\tpar->mmio = ioremap(info->fix.mmio_start, info->fix.mmio_len);\n\tif (!par->mmio) {\n\t\tprintk(KERN_ERR \"%s: Cannot map MMIO\\n\", dev_name(dev));\n\t\terr = -ENOMEM;\n\t\tgoto err_resource;\n\t}\n\tpar->bt455 = par->mmio - PMAG_AA_BT455_OFFSET + PMAG_AA_BT455_OFFSET;\n\tpar->bt431 = par->mmio - PMAG_AA_BT455_OFFSET + PMAG_AA_BT431_OFFSET;\n\n\t \n\tinfo->fix.smem_start = start + PMAG_AA_ONBOARD_FBMEM_OFFSET;\n\tinfo->screen_base = ioremap(info->fix.smem_start,\n\t\t\t\t\t    info->fix.smem_len);\n\tif (!info->screen_base) {\n\t\tprintk(KERN_ERR \"%s: Cannot map FB\\n\", dev_name(dev));\n\t\terr = -ENOMEM;\n\t\tgoto err_mmio_map;\n\t}\n\tinfo->screen_size = info->fix.smem_len;\n\n\t \n\tbt455_write_cmap_entry(par->bt455, 0, 0x0);\n\tbt455_write_cmap_next(par->bt455, 0xf);\n\n\t \n\tbt431_erase_cursor(par->bt431);\n\tbt431_init_cursor(par->bt431);\n\n\terr = register_framebuffer(info);\n\tif (err < 0) {\n\t\tprintk(KERN_ERR \"%s: Cannot register framebuffer\\n\",\n\t\t       dev_name(dev));\n\t\tgoto err_smem_map;\n\t}\n\n\tget_device(dev);\n\n\tpr_info(\"fb%d: %s frame buffer device at %s\\n\",\n\t\tinfo->node, info->fix.id, dev_name(dev));\n\n\treturn 0;\n\n\nerr_smem_map:\n\tiounmap(info->screen_base);\n\nerr_mmio_map:\n\tiounmap(par->mmio);\n\nerr_resource:\n\trelease_mem_region(start, len);\n\nerr_alloc:\n\tframebuffer_release(info);\n\treturn err;\n}\n\nstatic int pmagaafb_remove(struct device *dev)\n{\n\tstruct tc_dev *tdev = to_tc_dev(dev);\n\tstruct fb_info *info = dev_get_drvdata(dev);\n\tstruct aafb_par *par = info->par;\n\tresource_size_t start, len;\n\n\tput_device(dev);\n\tunregister_framebuffer(info);\n\tiounmap(info->screen_base);\n\tiounmap(par->mmio);\n\tstart = tdev->resource.start;\n\tlen = tdev->resource.end - start + 1;\n\trelease_mem_region(start, len);\n\tframebuffer_release(info);\n\treturn 0;\n}\n\n \nstatic const struct tc_device_id pmagaafb_tc_table[] = {\n\t{ \"DEC     \", \"PMAG-AA \" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(tc, pmagaafb_tc_table);\n\nstatic struct tc_driver pmagaafb_driver = {\n\t.id_table\t= pmagaafb_tc_table,\n\t.driver\t\t= {\n\t\t.name\t= \"pmagaafb\",\n\t\t.bus\t= &tc_bus_type,\n\t\t.probe\t= pmagaafb_probe,\n\t\t.remove\t= pmagaafb_remove,\n\t},\n};\n\nstatic int __init pmagaafb_init(void)\n{\n#ifndef MODULE\n\tif (fb_get_options(\"pmagaafb\", NULL))\n\t\treturn -ENXIO;\n#endif\n\treturn tc_register_driver(&pmagaafb_driver);\n}\n\nstatic void __exit pmagaafb_exit(void)\n{\n\ttc_unregister_driver(&pmagaafb_driver);\n}\n\nmodule_init(pmagaafb_init);\nmodule_exit(pmagaafb_exit);\n\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESCRIPTION);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}