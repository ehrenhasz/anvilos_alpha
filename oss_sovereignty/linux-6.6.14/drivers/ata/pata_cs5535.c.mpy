{
  "module_name": "pata_cs5535.c",
  "hash_id": "94068443d8a656132e9273d86b512c010b52256745788eb30ed8746a77413269",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_cs5535.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n#include <asm/msr.h>\n\n#define DRV_NAME\t\"pata_cs5535\"\n#define DRV_VERSION\t\"0.2.12\"\n\n \n\n#define MSR_ATAC_BASE    \t0x51300000\n#define ATAC_GLD_MSR_CAP \t(MSR_ATAC_BASE+0)\n#define ATAC_GLD_MSR_CONFIG    (MSR_ATAC_BASE+0x01)\n#define ATAC_GLD_MSR_SMI       (MSR_ATAC_BASE+0x02)\n#define ATAC_GLD_MSR_ERROR     (MSR_ATAC_BASE+0x03)\n#define ATAC_GLD_MSR_PM        (MSR_ATAC_BASE+0x04)\n#define ATAC_GLD_MSR_DIAG      (MSR_ATAC_BASE+0x05)\n#define ATAC_IO_BAR            (MSR_ATAC_BASE+0x08)\n#define ATAC_RESET             (MSR_ATAC_BASE+0x10)\n#define ATAC_CH0D0_PIO         (MSR_ATAC_BASE+0x20)\n#define ATAC_CH0D0_DMA         (MSR_ATAC_BASE+0x21)\n#define ATAC_CH0D1_PIO         (MSR_ATAC_BASE+0x22)\n#define ATAC_CH0D1_DMA         (MSR_ATAC_BASE+0x23)\n#define ATAC_PCI_ABRTERR       (MSR_ATAC_BASE+0x24)\n\n#define ATAC_BM0_CMD_PRIM      0x00\n#define ATAC_BM0_STS_PRIM      0x02\n#define ATAC_BM0_PRD           0x04\n\n#define CS5535_CABLE_DETECT    0x48\n\n \n\nstatic int cs5535_cable_detect(struct ata_port *ap)\n{\n\tu8 cable;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\n\tpci_read_config_byte(pdev, CS5535_CABLE_DETECT, &cable);\n\tif (cable & 1)\n\t\treturn ATA_CBL_PATA80;\n\telse\n\t\treturn ATA_CBL_PATA40;\n}\n\n \n\nstatic void cs5535_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tstatic const u16 pio_timings[5] = {\n\t\t0xF7F4, 0xF173, 0x8141, 0x5131, 0x1131\n\t};\n\tstatic const u16 pio_cmd_timings[5] = {\n\t\t0xF7F4, 0x53F3, 0x13F1, 0x5131, 0x1131\n\t};\n\tu32 reg, __maybe_unused dummy;\n\tstruct ata_device *pair = ata_dev_pair(adev);\n\n\tint mode = adev->pio_mode - XFER_PIO_0;\n\tint cmdmode = mode;\n\n\t \n\tif (pair) {\n\t\tint pairmode = pair->pio_mode - XFER_PIO_0;\n\t\tcmdmode = min(mode, pairmode);\n\t\t \n\t\tif (cmdmode < pairmode)\n\t\t\twrmsr(ATAC_CH0D0_PIO + 2 * pair->devno,\n\t\t\t\tpio_cmd_timings[cmdmode] << 16 | pio_timings[pairmode], 0);\n\t}\n\t \n\twrmsr(ATAC_CH0D0_PIO + 2 * adev->devno,\n\t\tpio_cmd_timings[cmdmode] << 16 | pio_timings[mode], 0);\n\n\t \n\trdmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg, dummy);\n\twrmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg | 0x80000000UL, 0);\n}\n\n \n\nstatic void cs5535_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\tstatic const u32 udma_timings[5] = {\n\t\t0x7F7436A1, 0x7F733481, 0x7F723261, 0x7F713161, 0x7F703061\n\t};\n\tstatic const u32 mwdma_timings[3] = {\n\t\t0x7F0FFFF3, 0x7F035352, 0x7F024241\n\t};\n\tu32 reg, __maybe_unused dummy;\n\tint mode = adev->dma_mode;\n\n\trdmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg, dummy);\n\treg &= 0x80000000UL;\n\tif (mode >= XFER_UDMA_0)\n\t\treg |= udma_timings[mode - XFER_UDMA_0];\n\telse\n\t\treg |= mwdma_timings[mode - XFER_MW_DMA_0];\n\twrmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg, 0);\n}\n\nstatic const struct scsi_host_template cs5535_sht = {\n\tATA_BMDMA_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations cs5535_port_ops = {\n\t.inherits\t= &ata_bmdma_port_ops,\n\t.cable_detect\t= cs5535_cable_detect,\n\t.set_piomode\t= cs5535_set_piomode,\n\t.set_dmamode\t= cs5535_set_dmamode,\n};\n\n \n\nstatic int cs5535_init_one(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\tstatic const struct ata_port_info info = {\n\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t.pio_mask = ATA_PIO4,\n\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t.udma_mask = ATA_UDMA4,\n\t\t.port_ops = &cs5535_port_ops\n\t};\n\tconst struct ata_port_info *ppi[] = { &info, &ata_dummy_port_info };\n\n\treturn ata_pci_bmdma_init_one(dev, ppi, &cs5535_sht, NULL, 0);\n}\n\nstatic const struct pci_device_id cs5535[] = {\n\t{ PCI_VDEVICE(NS, PCI_DEVICE_ID_NS_CS5535_IDE), },\n\t{ PCI_VDEVICE(AMD, PCI_DEVICE_ID_AMD_CS5535_IDE), },\n\n\t{ },\n};\n\nstatic struct pci_driver cs5535_pci_driver = {\n\t.name\t\t= DRV_NAME,\n\t.id_table\t= cs5535,\n\t.probe \t\t= cs5535_init_one,\n\t.remove\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t= ata_pci_device_suspend,\n\t.resume\t\t= ata_pci_device_resume,\n#endif\n};\n\nmodule_pci_driver(cs5535_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox, Jens Altmann, Wolfgan Zuleger, Alexander Kiausch\");\nMODULE_DESCRIPTION(\"low-level driver for the NS/AMD 5535\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, cs5535);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}