{
  "module_name": "ahci_dm816.c",
  "hash_id": "923d8ad51bf45487496d9d6b47ce4c3db6070dd764998a6c3498e9f17bdeb21f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/ahci_dm816.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/pm.h>\n#include <linux/platform_device.h>\n#include <linux/libata.h>\n#include <linux/ahci_platform.h>\n\n#include \"ahci.h\"\n\n#define AHCI_DM816_DRV_NAME\t\t\"ahci-dm816\"\n\n#define AHCI_DM816_PHY_ENPLL(x)\t\t((x) << 0)\n#define AHCI_DM816_PHY_MPY(x)\t\t((x) << 1)\n#define AHCI_DM816_PHY_LOS(x)\t\t((x) << 12)\n#define AHCI_DM816_PHY_RXCDR(x)\t\t((x) << 13)\n#define AHCI_DM816_PHY_RXEQ(x)\t\t((x) << 16)\n#define AHCI_DM816_PHY_TXSWING(x)\t((x) << 23)\n\n#define AHCI_DM816_P0PHYCR_REG\t\t0x178\n#define AHCI_DM816_P1PHYCR_REG\t\t0x1f8\n\n#define AHCI_DM816_PLL_OUT\t\t1500000000LU\n\nstatic const unsigned long pll_mpy_table[] = {\n\t  400,  500,  600,  800,  825, 1000, 1200,\n\t 1250, 1500, 1600, 1650, 2000, 2200, 2500\n};\n\nstatic int ahci_dm816_get_mpy_bits(unsigned long refclk_rate)\n{\n\tunsigned long pll_multiplier;\n\tint i;\n\n\t \n\tpll_multiplier = AHCI_DM816_PLL_OUT / (refclk_rate / 100);\n\n\tfor (i = 0; i < ARRAY_SIZE(pll_mpy_table); i++) {\n\t\tif (pll_mpy_table[i] == pll_multiplier)\n\t\t\treturn i;\n\t}\n\n\t \n\treturn -1;\n}\n\nstatic int ahci_dm816_phy_init(struct ahci_host_priv *hpriv, struct device *dev)\n{\n\tunsigned long refclk_rate;\n\tint mpy;\n\tu32 val;\n\n\t \n\tif (hpriv->n_clks < 2) {\n\t\tdev_err(dev, \"reference clock not supplied\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\trefclk_rate = clk_get_rate(hpriv->clks[1].clk);\n\tif ((refclk_rate % 100) != 0) {\n\t\tdev_err(dev, \"reference clock rate must be divisible by 100\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmpy = ahci_dm816_get_mpy_bits(refclk_rate);\n\tif (mpy < 0) {\n\t\tdev_err(dev, \"can't calculate the MPY bits value\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tval = AHCI_DM816_PHY_MPY(mpy) | AHCI_DM816_PHY_LOS(1) |\n\t      AHCI_DM816_PHY_RXCDR(4) | AHCI_DM816_PHY_RXEQ(1) |\n\t      AHCI_DM816_PHY_TXSWING(3) | AHCI_DM816_PHY_ENPLL(1);\n\twritel(val, hpriv->mmio + AHCI_DM816_P0PHYCR_REG);\n\n\t \n\tval = AHCI_DM816_PHY_LOS(1) | AHCI_DM816_PHY_RXCDR(4) |\n\t      AHCI_DM816_PHY_RXEQ(1) | AHCI_DM816_PHY_TXSWING(3);\n\twritel(val, hpriv->mmio + AHCI_DM816_P1PHYCR_REG);\n\n\treturn 0;\n}\n\nstatic int ahci_dm816_softreset(struct ata_link *link,\n\t\t\t\tunsigned int *class, unsigned long deadline)\n{\n\tint pmp, ret;\n\n\tpmp = sata_srst_pmp(link);\n\n\t \n\tret = ahci_do_softreset(link, class, pmp, deadline, ahci_check_ready);\n\tif (pmp && ret == -EBUSY)\n\t\treturn ahci_do_softreset(link, class, 0,\n\t\t\t\t\t deadline, ahci_check_ready);\n\n\treturn ret;\n}\n\nstatic struct ata_port_operations ahci_dm816_port_ops = {\n\t.inherits = &ahci_platform_ops,\n\t.softreset = ahci_dm816_softreset,\n};\n\nstatic const struct ata_port_info ahci_dm816_port_info = {\n\t.flags\t\t= AHCI_FLAG_COMMON,\n\t.pio_mask\t= ATA_PIO4,\n\t.udma_mask\t= ATA_UDMA6,\n\t.port_ops\t= &ahci_dm816_port_ops,\n};\n\nstatic const struct scsi_host_template ahci_dm816_platform_sht = {\n\tAHCI_SHT(AHCI_DM816_DRV_NAME),\n};\n\nstatic int ahci_dm816_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct ahci_host_priv *hpriv;\n\tint rc;\n\n\thpriv = ahci_platform_get_resources(pdev, 0);\n\tif (IS_ERR(hpriv))\n\t\treturn PTR_ERR(hpriv);\n\n\trc = ahci_platform_enable_resources(hpriv);\n\tif (rc)\n\t\treturn rc;\n\n\trc = ahci_dm816_phy_init(hpriv, dev);\n\tif (rc)\n\t\tgoto disable_resources;\n\n\trc = ahci_platform_init_host(pdev, hpriv,\n\t\t\t\t     &ahci_dm816_port_info,\n\t\t\t\t     &ahci_dm816_platform_sht);\n\tif (rc)\n\t\tgoto disable_resources;\n\n\treturn 0;\n\ndisable_resources:\n\tahci_platform_disable_resources(hpriv);\n\n\treturn rc;\n}\n\nstatic SIMPLE_DEV_PM_OPS(ahci_dm816_pm_ops,\n\t\t\t ahci_platform_suspend,\n\t\t\t ahci_platform_resume);\n\nstatic const struct of_device_id ahci_dm816_of_match[] = {\n\t{ .compatible = \"ti,dm816-ahci\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, ahci_dm816_of_match);\n\nstatic struct platform_driver ahci_dm816_driver = {\n\t.probe = ahci_dm816_probe,\n\t.remove_new = ata_platform_remove_one,\n\t.driver = {\n\t\t.name = AHCI_DM816_DRV_NAME,\n\t\t.of_match_table = ahci_dm816_of_match,\n\t\t.pm = &ahci_dm816_pm_ops,\n\t},\n};\nmodule_platform_driver(ahci_dm816_driver);\n\nMODULE_DESCRIPTION(\"DaVinci DM816 AHCI SATA platform driver\");\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}