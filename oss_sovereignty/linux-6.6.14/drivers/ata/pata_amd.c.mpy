{
  "module_name": "pata_amd.c",
  "hash_id": "4a68bdf46857f30796a7489d580015f1e02c95685f043388128e014e09772e7a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_amd.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n\n#define DRV_NAME \"pata_amd\"\n#define DRV_VERSION \"0.4.1\"\n\n \n\nstatic void timing_setup(struct ata_port *ap, struct ata_device *adev, int offset, int speed, int clock)\n{\n\tstatic const unsigned char amd_cyc2udma[] = {\n\t\t6, 6, 5, 4, 0, 1, 1, 2, 2, 3, 3, 3, 3, 3, 3, 7\n\t};\n\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tstruct ata_device *peer = ata_dev_pair(adev);\n\tint dn = ap->port_no * 2 + adev->devno;\n\tstruct ata_timing at, apeer;\n\tint T, UT;\n\tconst int amd_clock = 33333;\t \n\tu8 t;\n\n\tT = 1000000000 / amd_clock;\n\tUT = T;\n\tif (clock >= 2)\n\t\tUT = T / 2;\n\n\tif (ata_timing_compute(adev, speed, &at, T, UT) < 0) {\n\t\tdev_err(&pdev->dev, \"unknown mode %d\\n\", speed);\n\t\treturn;\n\t}\n\n\tif (peer) {\n\t\t \n\t\tif (ata_dma_enabled(peer)) {\n\t\t\tata_timing_compute(peer, peer->dma_mode, &apeer, T, UT);\n\t\t\tata_timing_merge(&apeer, &at, &at, ATA_TIMING_8BIT);\n\t\t}\n\t\tata_timing_compute(peer, peer->pio_mode, &apeer, T, UT);\n\t\tata_timing_merge(&apeer, &at, &at, ATA_TIMING_8BIT);\n\t}\n\n\tif (speed == XFER_UDMA_5 && amd_clock <= 33333) at.udma = 1;\n\tif (speed == XFER_UDMA_6 && amd_clock <= 33333) at.udma = 15;\n\n\t \n\n\t \n\tpci_read_config_byte(pdev, offset + 0x0C, &t);\n\tt = (t & ~(3 << ((3 - dn) << 1))) | ((clamp_val(at.setup, 1, 4) - 1) << ((3 - dn) << 1));\n\tpci_write_config_byte(pdev, offset + 0x0C , t);\n\n\t \n\tpci_write_config_byte(pdev, offset + 0x0E + (1 - (dn >> 1)),\n\t\t((clamp_val(at.act8b, 1, 16) - 1) << 4) | (clamp_val(at.rec8b, 1, 16) - 1));\n\n\t \n\tpci_write_config_byte(pdev, offset + 0x08 + (3 - dn),\n\t\t((clamp_val(at.active, 1, 16) - 1) << 4) | (clamp_val(at.recover, 1, 16) - 1));\n\n\tswitch (clock) {\n\t\tcase 1:\n\t\tt = at.udma ? (0xc0 | (clamp_val(at.udma, 2, 5) - 2)) : 0x03;\n\t\tbreak;\n\n\t\tcase 2:\n\t\tt = at.udma ? (0xc0 | amd_cyc2udma[clamp_val(at.udma, 2, 10)]) : 0x03;\n\t\tbreak;\n\n\t\tcase 3:\n\t\tt = at.udma ? (0xc0 | amd_cyc2udma[clamp_val(at.udma, 1, 10)]) : 0x03;\n\t\tbreak;\n\n\t\tcase 4:\n\t\tt = at.udma ? (0xc0 | amd_cyc2udma[clamp_val(at.udma, 1, 15)]) : 0x03;\n\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn;\n\t}\n\n\t \n\tif (at.udma)\n\t\tpci_write_config_byte(pdev, offset + 0x10 + (3 - dn), t);\n}\n\n \n\nstatic int amd_pre_reset(struct ata_link *link, unsigned long deadline)\n{\n\tstatic const struct pci_bits amd_enable_bits[] = {\n\t\t{ 0x40, 1, 0x02, 0x02 },\n\t\t{ 0x40, 1, 0x01, 0x01 }\n\t};\n\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\n\tif (!pci_test_config_bits(pdev, &amd_enable_bits[ap->port_no]))\n\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\n \n\nstatic int amd_cable_detect(struct ata_port *ap)\n{\n\tstatic const u32 bitmask[2] = {0x03, 0x0C};\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tu8 ata66;\n\n\tpci_read_config_byte(pdev, 0x42, &ata66);\n\tif (ata66 & bitmask[ap->port_no])\n\t\treturn ATA_CBL_PATA80;\n\treturn ATA_CBL_PATA40;\n}\n\n \n\nstatic void amd_fifo_setup(struct ata_port *ap)\n{\n\tstruct ata_device *adev;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tstatic const u8 fifobit[2] = { 0xC0, 0x30};\n\tu8 fifo = fifobit[ap->port_no];\n\tu8 r;\n\n\n\tata_for_each_dev(adev, &ap->link, ENABLED) {\n\t\tif (adev->class == ATA_DEV_ATAPI)\n\t\t\tfifo = 0;\n\t}\n\tif (pdev->device == PCI_DEVICE_ID_AMD_VIPER_7411)  \n\t\tfifo = 0;\n\n\t \n\tpci_read_config_byte(pdev, 0x41, &r);\n\tr &= ~fifobit[ap->port_no];\n\tr |= fifo;\n\tpci_write_config_byte(pdev, 0x41, r);\n}\n\n \n\nstatic void amd33_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tamd_fifo_setup(ap);\n\ttiming_setup(ap, adev, 0x40, adev->pio_mode, 1);\n}\n\nstatic void amd66_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tamd_fifo_setup(ap);\n\ttiming_setup(ap, adev, 0x40, adev->pio_mode, 2);\n}\n\nstatic void amd100_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tamd_fifo_setup(ap);\n\ttiming_setup(ap, adev, 0x40, adev->pio_mode, 3);\n}\n\nstatic void amd133_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tamd_fifo_setup(ap);\n\ttiming_setup(ap, adev, 0x40, adev->pio_mode, 4);\n}\n\n \n\nstatic void amd33_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x40, adev->dma_mode, 1);\n}\n\nstatic void amd66_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x40, adev->dma_mode, 2);\n}\n\nstatic void amd100_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x40, adev->dma_mode, 3);\n}\n\nstatic void amd133_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x40, adev->dma_mode, 4);\n}\n\n \nstatic unsigned int nv_mode_filter(struct ata_device *dev,\n\t\t\t\t   unsigned int xfer_mask)\n{\n\tstatic const unsigned int udma_mask_map[] =\n\t\t{ ATA_UDMA2, ATA_UDMA1, ATA_UDMA0, 0,\n\t\t  ATA_UDMA3, ATA_UDMA4, ATA_UDMA5, ATA_UDMA6 };\n\tstruct ata_port *ap = dev->link->ap;\n\tchar acpi_str[32] = \"\";\n\tu32 saved_udma, udma;\n\tconst struct ata_acpi_gtm *gtm;\n\tunsigned int bios_limit = 0, acpi_limit = 0, limit;\n\n\t \n\tudma = saved_udma = (unsigned long)ap->host->private_data;\n\n\tif (ap->port_no == 0)\n\t\tudma >>= 16;\n\tif (dev->devno == 0)\n\t\tudma >>= 8;\n\n\tif ((udma & 0xc0) == 0xc0)\n\t\tbios_limit = ata_pack_xfermask(0, 0, udma_mask_map[udma & 0x7]);\n\n\t \n\tgtm = ata_acpi_init_gtm(ap);\n\tif (gtm) {\n\t\tacpi_limit = ata_acpi_gtm_xfermask(dev, gtm);\n\n\t\tsnprintf(acpi_str, sizeof(acpi_str), \" (%u:%u:0x%x)\",\n\t\t\t gtm->drive[0].dma, gtm->drive[1].dma, gtm->flags);\n\t}\n\n\t \n\tlimit = bios_limit | acpi_limit;\n\n\t \n\tif (!(limit & ATA_MASK_PIO))\n\t\tlimit |= ATA_MASK_PIO;\n\tif (!(limit & (ATA_MASK_MWDMA | ATA_MASK_UDMA)))\n\t\tlimit |= ATA_MASK_MWDMA | ATA_MASK_UDMA;\n\t \n\tlimit |= ata_pack_xfermask(ATA_PIO4, ATA_MWDMA2, ATA_UDMA2);\n\n\tata_port_dbg(ap,\n\t\t     \"nv_mode_filter: 0x%x&0x%x->0x%x, BIOS=0x%x (0x%x) ACPI=0x%x%s\\n\",\n\t\t     xfer_mask, limit, xfer_mask & limit, bios_limit,\n\t\t     saved_udma, acpi_limit, acpi_str);\n\n\treturn xfer_mask & limit;\n}\n\n \n\nstatic int nv_pre_reset(struct ata_link *link, unsigned long deadline)\n{\n\tstatic const struct pci_bits nv_enable_bits[] = {\n\t\t{ 0x50, 1, 0x02, 0x02 },\n\t\t{ 0x50, 1, 0x01, 0x01 }\n\t};\n\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\n\tif (!pci_test_config_bits(pdev, &nv_enable_bits[ap->port_no]))\n\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\n \n\nstatic void nv100_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x50, adev->pio_mode, 3);\n}\n\nstatic void nv133_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x50, adev->pio_mode, 4);\n}\n\n \n\nstatic void nv100_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x50, adev->dma_mode, 3);\n}\n\nstatic void nv133_set_dmamode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttiming_setup(ap, adev, 0x50, adev->dma_mode, 4);\n}\n\nstatic void nv_host_stop(struct ata_host *host)\n{\n\tu32 udma = (unsigned long)host->private_data;\n\n\t \n\tpci_write_config_dword(to_pci_dev(host->dev), 0x60, udma);\n}\n\nstatic const struct scsi_host_template amd_sht = {\n\tATA_BMDMA_SHT(DRV_NAME),\n};\n\nstatic const struct ata_port_operations amd_base_port_ops = {\n\t.inherits\t= &ata_bmdma32_port_ops,\n\t.prereset\t= amd_pre_reset,\n};\n\nstatic struct ata_port_operations amd33_port_ops = {\n\t.inherits\t= &amd_base_port_ops,\n\t.cable_detect\t= ata_cable_40wire,\n\t.set_piomode\t= amd33_set_piomode,\n\t.set_dmamode\t= amd33_set_dmamode,\n};\n\nstatic struct ata_port_operations amd66_port_ops = {\n\t.inherits\t= &amd_base_port_ops,\n\t.cable_detect\t= ata_cable_unknown,\n\t.set_piomode\t= amd66_set_piomode,\n\t.set_dmamode\t= amd66_set_dmamode,\n};\n\nstatic struct ata_port_operations amd100_port_ops = {\n\t.inherits\t= &amd_base_port_ops,\n\t.cable_detect\t= ata_cable_unknown,\n\t.set_piomode\t= amd100_set_piomode,\n\t.set_dmamode\t= amd100_set_dmamode,\n};\n\nstatic struct ata_port_operations amd133_port_ops = {\n\t.inherits\t= &amd_base_port_ops,\n\t.cable_detect\t= amd_cable_detect,\n\t.set_piomode\t= amd133_set_piomode,\n\t.set_dmamode\t= amd133_set_dmamode,\n};\n\nstatic const struct ata_port_operations nv_base_port_ops = {\n\t.inherits\t= &ata_bmdma_port_ops,\n\t.cable_detect\t= ata_cable_ignore,\n\t.mode_filter\t= nv_mode_filter,\n\t.prereset\t= nv_pre_reset,\n\t.host_stop\t= nv_host_stop,\n};\n\nstatic struct ata_port_operations nv100_port_ops = {\n\t.inherits\t= &nv_base_port_ops,\n\t.set_piomode\t= nv100_set_piomode,\n\t.set_dmamode\t= nv100_set_dmamode,\n};\n\nstatic struct ata_port_operations nv133_port_ops = {\n\t.inherits\t= &nv_base_port_ops,\n\t.set_piomode\t= nv133_set_piomode,\n\t.set_dmamode\t= nv133_set_dmamode,\n};\n\nstatic void amd_clear_fifo(struct pci_dev *pdev)\n{\n\tu8 fifo;\n\t \n\tpci_read_config_byte(pdev, 0x41, &fifo);\n\tfifo &= 0x0F;\n\tpci_write_config_byte(pdev, 0x41, fifo);\n}\n\nstatic int amd_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\n{\n\tstatic const struct ata_port_info info[10] = {\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA2,\n\t\t\t.port_ops = &amd33_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA4,\n\t\t\t.port_ops = &amd66_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA4,\n\t\t\t.port_ops = &amd66_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA5,\n\t\t\t.port_ops = &amd100_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA5,\n\t\t\t.port_ops = &amd100_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA6,\n\t\t\t.port_ops = &amd133_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA5,\n\t\t\t.port_ops = &amd133_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA5,\n\t\t\t.port_ops = &nv100_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA6,\n\t\t\t.port_ops = &nv133_port_ops\n\t\t},\n\t\t{\t \n\t\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t\t.pio_mask = ATA_PIO4,\n\t\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t\t.udma_mask = ATA_UDMA5,\n\t\t\t.port_ops = &amd100_port_ops\n\t\t}\n\t};\n\tconst struct ata_port_info *ppi[] = { NULL, NULL };\n\tint type = id->driver_data;\n\tvoid *hpriv = NULL;\n\tu8 fifo;\n\tint rc;\n\n\tata_print_version_once(&pdev->dev, DRV_VERSION);\n\n\trc = pcim_enable_device(pdev);\n\tif (rc)\n\t\treturn rc;\n\n\tpci_read_config_byte(pdev, 0x41, &fifo);\n\n\t \n\tif (type == 1 && pdev->revision > 0x7)\n\t\ttype = 2;\n\n\t \n\tif (type == 5 && pdev->subsystem_vendor == PCI_VENDOR_ID_AMD &&\n\t\t\t pdev->subsystem_device == PCI_DEVICE_ID_AMD_SERENADE)\n\t\ttype = 6;\t \n\n\t \n\tppi[0] = &info[type];\n\n\tif (type < 3)\n\t\tata_pci_bmdma_clear_simplex(pdev);\n\tif (pdev->vendor == PCI_VENDOR_ID_AMD)\n\t\tamd_clear_fifo(pdev);\n\t \n\tif (type == 7 || type == 8) {\n\t\tu32 udma;\n\n\t\tpci_read_config_dword(pdev, 0x60, &udma);\n\t\thpriv = (void *)(unsigned long)udma;\n\t}\n\n\t \n\treturn ata_pci_bmdma_init_one(pdev, ppi, &amd_sht, hpriv, 0);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int amd_reinit_one(struct pci_dev *pdev)\n{\n\tstruct ata_host *host = pci_get_drvdata(pdev);\n\tint rc;\n\n\trc = ata_pci_device_do_resume(pdev);\n\tif (rc)\n\t\treturn rc;\n\n\tif (pdev->vendor == PCI_VENDOR_ID_AMD) {\n\t\tamd_clear_fifo(pdev);\n\t\tif (pdev->device == PCI_DEVICE_ID_AMD_VIPER_7409 ||\n\t\t    pdev->device == PCI_DEVICE_ID_AMD_COBRA_7401)\n\t\t\tata_pci_bmdma_clear_simplex(pdev);\n\t}\n\tata_host_resume(host);\n\treturn 0;\n}\n#endif\n\nstatic const struct pci_device_id amd[] = {\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_COBRA_7401),\t\t0 },\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_VIPER_7409),\t\t1 },\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_VIPER_7411),\t\t3 },\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_OPUS_7441),\t\t4 },\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_8111_IDE),\t\t5 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_IDE),\t7 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE2_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE2S_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE3_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE3S_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_CK804_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP65_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP67_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP73_IDE),\t8 },\n\t{ PCI_VDEVICE(NVIDIA,\tPCI_DEVICE_ID_NVIDIA_NFORCE_MCP77_IDE),\t8 },\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_CS5536_IDE),\t\t9 },\n\t{ PCI_VDEVICE(AMD,\tPCI_DEVICE_ID_AMD_CS5536_DEV_IDE),\t9 },\n\n\t{ },\n};\n\nstatic struct pci_driver amd_pci_driver = {\n\t.name \t\t= DRV_NAME,\n\t.id_table\t= amd,\n\t.probe \t\t= amd_init_one,\n\t.remove\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t= ata_pci_device_suspend,\n\t.resume\t\t= amd_reinit_one,\n#endif\n};\n\nmodule_pci_driver(amd_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox\");\nMODULE_DESCRIPTION(\"low-level driver for AMD and Nvidia PATA IDE\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, amd);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}