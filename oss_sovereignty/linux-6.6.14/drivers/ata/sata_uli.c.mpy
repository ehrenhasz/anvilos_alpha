{
  "module_name": "sata_uli.c",
  "hash_id": "458bdf3fefb73b0a70fb73fb11fedd5056f37e5b794ecf4da5b6f0e2d5d14e4c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/sata_uli.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/gfp.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/device.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n\n#define DRV_NAME\t\"sata_uli\"\n#define DRV_VERSION\t\"1.3\"\n\nenum {\n\tuli_5289\t\t= 0,\n\tuli_5287\t\t= 1,\n\tuli_5281\t\t= 2,\n\n\tuli_max_ports\t\t= 4,\n\n\t \n\tULI5287_BASE\t\t= 0x90,  \n\tULI5287_OFFS\t\t= 0x10,  \n\tULI5281_BASE\t\t= 0x60,  \n\tULI5281_OFFS\t\t= 0x60,  \n};\n\nstruct uli_priv {\n\tunsigned int\t\tscr_cfg_addr[uli_max_ports];\n};\n\nstatic int uli_init_one(struct pci_dev *pdev, const struct pci_device_id *ent);\nstatic int uli_scr_read(struct ata_link *link, unsigned int sc_reg, u32 *val);\nstatic int uli_scr_write(struct ata_link *link, unsigned int sc_reg, u32 val);\n\nstatic const struct pci_device_id uli_pci_tbl[] = {\n\t{ PCI_VDEVICE(AL, 0x5289), uli_5289 },\n\t{ PCI_VDEVICE(AL, 0x5287), uli_5287 },\n\t{ PCI_VDEVICE(AL, 0x5281), uli_5281 },\n\n\t{ }\t \n};\n\nstatic struct pci_driver uli_pci_driver = {\n\t.name\t\t\t= DRV_NAME,\n\t.id_table\t\t= uli_pci_tbl,\n\t.probe\t\t\t= uli_init_one,\n\t.remove\t\t\t= ata_pci_remove_one,\n};\n\nstatic const struct scsi_host_template uli_sht = {\n\tATA_BMDMA_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations uli_ops = {\n\t.inherits\t\t= &ata_bmdma_port_ops,\n\t.scr_read\t\t= uli_scr_read,\n\t.scr_write\t\t= uli_scr_write,\n\t.hardreset\t\t= ATA_OP_NULL,\n};\n\nstatic const struct ata_port_info uli_port_info = {\n\t.flags\t\t= ATA_FLAG_SATA | ATA_FLAG_IGN_SIMPLEX,\n\t.pio_mask       = ATA_PIO4,\n\t.udma_mask      = ATA_UDMA6,\n\t.port_ops       = &uli_ops,\n};\n\n\nMODULE_AUTHOR(\"Peer Chen\");\nMODULE_DESCRIPTION(\"low-level driver for ULi Electronics SATA controller\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, uli_pci_tbl);\nMODULE_VERSION(DRV_VERSION);\n\nstatic unsigned int get_scr_cfg_addr(struct ata_port *ap, unsigned int sc_reg)\n{\n\tstruct uli_priv *hpriv = ap->host->private_data;\n\treturn hpriv->scr_cfg_addr[ap->port_no] + (4 * sc_reg);\n}\n\nstatic u32 uli_scr_cfg_read(struct ata_link *link, unsigned int sc_reg)\n{\n\tstruct pci_dev *pdev = to_pci_dev(link->ap->host->dev);\n\tunsigned int cfg_addr = get_scr_cfg_addr(link->ap, sc_reg);\n\tu32 val;\n\n\tpci_read_config_dword(pdev, cfg_addr, &val);\n\treturn val;\n}\n\nstatic void uli_scr_cfg_write(struct ata_link *link, unsigned int scr, u32 val)\n{\n\tstruct pci_dev *pdev = to_pci_dev(link->ap->host->dev);\n\tunsigned int cfg_addr = get_scr_cfg_addr(link->ap, scr);\n\n\tpci_write_config_dword(pdev, cfg_addr, val);\n}\n\nstatic int uli_scr_read(struct ata_link *link, unsigned int sc_reg, u32 *val)\n{\n\tif (sc_reg > SCR_CONTROL)\n\t\treturn -EINVAL;\n\n\t*val = uli_scr_cfg_read(link, sc_reg);\n\treturn 0;\n}\n\nstatic int uli_scr_write(struct ata_link *link, unsigned int sc_reg, u32 val)\n{\n\tif (sc_reg > SCR_CONTROL) \n\t\treturn -EINVAL;\n\n\tuli_scr_cfg_write(link, sc_reg, val);\n\treturn 0;\n}\n\nstatic int uli_init_one(struct pci_dev *pdev, const struct pci_device_id *ent)\n{\n\tconst struct ata_port_info *ppi[] = { &uli_port_info, NULL };\n\tunsigned int board_idx = (unsigned int) ent->driver_data;\n\tstruct ata_host *host;\n\tstruct uli_priv *hpriv;\n\tvoid __iomem * const *iomap;\n\tstruct ata_ioports *ioaddr;\n\tint n_ports, rc;\n\n\tata_print_version_once(&pdev->dev, DRV_VERSION);\n\n\trc = pcim_enable_device(pdev);\n\tif (rc)\n\t\treturn rc;\n\n\tn_ports = 2;\n\tif (board_idx == uli_5287)\n\t\tn_ports = 4;\n\n\t \n\thost = ata_host_alloc_pinfo(&pdev->dev, ppi, n_ports);\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\thpriv = devm_kzalloc(&pdev->dev, sizeof(*hpriv), GFP_KERNEL);\n\tif (!hpriv)\n\t\treturn -ENOMEM;\n\thost->private_data = hpriv;\n\n\t \n\trc = ata_pci_sff_init_host(host);\n\tif (rc)\n\t\treturn rc;\n\n\tata_pci_bmdma_init(host);\n\n\tiomap = host->iomap;\n\n\tswitch (board_idx) {\n\tcase uli_5287:\n\t\t \n\t\thpriv->scr_cfg_addr[0] = ULI5287_BASE;\n\t\thpriv->scr_cfg_addr[1] = ULI5287_BASE + ULI5287_OFFS;\n\n\t\tioaddr = &host->ports[2]->ioaddr;\n\t\tioaddr->cmd_addr = iomap[0] + 8;\n\t\tioaddr->altstatus_addr =\n\t\tioaddr->ctl_addr = (void __iomem *)\n\t\t\t((unsigned long)iomap[1] | ATA_PCI_CTL_OFS) + 4;\n\t\tioaddr->bmdma_addr = iomap[4] + 16;\n\t\thpriv->scr_cfg_addr[2] = ULI5287_BASE + ULI5287_OFFS*4;\n\t\tata_sff_std_ports(ioaddr);\n\n\t\tata_port_desc(host->ports[2],\n\t\t\t\"cmd 0x%llx ctl 0x%llx bmdma 0x%llx\",\n\t\t\t(unsigned long long)pci_resource_start(pdev, 0) + 8,\n\t\t\t((unsigned long long)pci_resource_start(pdev, 1) | ATA_PCI_CTL_OFS) + 4,\n\t\t\t(unsigned long long)pci_resource_start(pdev, 4) + 16);\n\n\t\tioaddr = &host->ports[3]->ioaddr;\n\t\tioaddr->cmd_addr = iomap[2] + 8;\n\t\tioaddr->altstatus_addr =\n\t\tioaddr->ctl_addr = (void __iomem *)\n\t\t\t((unsigned long)iomap[3] | ATA_PCI_CTL_OFS) + 4;\n\t\tioaddr->bmdma_addr = iomap[4] + 24;\n\t\thpriv->scr_cfg_addr[3] = ULI5287_BASE + ULI5287_OFFS*5;\n\t\tata_sff_std_ports(ioaddr);\n\n\t\tata_port_desc(host->ports[2],\n\t\t\t\"cmd 0x%llx ctl 0x%llx bmdma 0x%llx\",\n\t\t\t(unsigned long long)pci_resource_start(pdev, 2) + 9,\n\t\t\t((unsigned long long)pci_resource_start(pdev, 3) | ATA_PCI_CTL_OFS) + 4,\n\t\t\t(unsigned long long)pci_resource_start(pdev, 4) + 24);\n\n\t\tbreak;\n\n\tcase uli_5289:\n\t\thpriv->scr_cfg_addr[0] = ULI5287_BASE;\n\t\thpriv->scr_cfg_addr[1] = ULI5287_BASE + ULI5287_OFFS;\n\t\tbreak;\n\n\tcase uli_5281:\n\t\thpriv->scr_cfg_addr[0] = ULI5281_BASE;\n\t\thpriv->scr_cfg_addr[1] = ULI5281_BASE + ULI5281_OFFS;\n\t\tbreak;\n\n\tdefault:\n\t\tBUG();\n\t\tbreak;\n\t}\n\n\tpci_set_master(pdev);\n\tpci_intx(pdev, 1);\n\treturn ata_host_activate(host, pdev->irq, ata_bmdma_interrupt,\n\t\t\t\t IRQF_SHARED, &uli_sht);\n}\n\nmodule_pci_driver(uli_pci_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}