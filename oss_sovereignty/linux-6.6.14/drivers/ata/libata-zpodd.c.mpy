{
  "module_name": "libata-zpodd.c",
  "hash_id": "e80e979deba7913c29e7a7b988fb4516107ecb55aa985ed1bb39c9b68b742a60",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/libata-zpodd.c",
  "human_readable_source": "\n#include <linux/libata.h>\n#include <linux/cdrom.h>\n#include <linux/pm_runtime.h>\n#include <linux/module.h>\n#include <linux/pm_qos.h>\n#include <scsi/scsi_device.h>\n\n#include \"libata.h\"\n\nstatic int zpodd_poweroff_delay = 30;  \nmodule_param(zpodd_poweroff_delay, int, 0644);\nMODULE_PARM_DESC(zpodd_poweroff_delay, \"Poweroff delay for ZPODD in seconds\");\n\nenum odd_mech_type {\n\tODD_MECH_TYPE_SLOT,\n\tODD_MECH_TYPE_DRAWER,\n\tODD_MECH_TYPE_UNSUPPORTED,\n};\n\nstruct zpodd {\n\tenum odd_mech_type\tmech_type;  \n\tstruct ata_device\t*dev;\n\n\t \n\tbool\t\t\tfrom_notify;  \n\tbool\t\t\tzp_ready;  \n\tunsigned long\t\tlast_ready;  \n\tbool\t\t\tzp_sampled;  \n\tbool\t\t\tpowered_off;  \n};\n\nstatic int eject_tray(struct ata_device *dev)\n{\n\tstruct ata_taskfile tf;\n\tstatic const char cdb[ATAPI_CDB_LEN] = {  GPCMD_START_STOP_UNIT,\n\t\t0, 0, 0,\n\t\t0x02,      \n\t\t0, 0, 0, 0, 0, 0, 0,\n\t};\n\n\tata_tf_init(dev, &tf);\n\ttf.flags = ATA_TFLAG_ISADDR | ATA_TFLAG_DEVICE;\n\ttf.command = ATA_CMD_PACKET;\n\ttf.protocol = ATAPI_PROT_NODATA;\n\n\treturn ata_exec_internal(dev, &tf, cdb, DMA_NONE, NULL, 0, 0);\n}\n\n \nstatic enum odd_mech_type zpodd_get_mech_type(struct ata_device *dev)\n{\n\tchar *buf;\n\tunsigned int ret;\n\tstruct rm_feature_desc *desc;\n\tstruct ata_taskfile tf;\n\tstatic const char cdb[ATAPI_CDB_LEN] = {  GPCMD_GET_CONFIGURATION,\n\t\t\t2,       \n\t\t\t0, 3,    \n\t\t\t0, 0, 0, \n\t\t\t0, 16,\n\t\t\t0, 0, 0,\n\t};\n\n\tbuf = kzalloc(16, GFP_KERNEL);\n\tif (!buf)\n\t\treturn ODD_MECH_TYPE_UNSUPPORTED;\n\tdesc = (void *)(buf + 8);\n\n\tata_tf_init(dev, &tf);\n\ttf.flags = ATA_TFLAG_ISADDR | ATA_TFLAG_DEVICE;\n\ttf.command = ATA_CMD_PACKET;\n\ttf.protocol = ATAPI_PROT_PIO;\n\ttf.lbam = 16;\n\n\tret = ata_exec_internal(dev, &tf, cdb, DMA_FROM_DEVICE,\n\t\t\t\tbuf, 16, 0);\n\tif (ret) {\n\t\tkfree(buf);\n\t\treturn ODD_MECH_TYPE_UNSUPPORTED;\n\t}\n\n\tif (be16_to_cpu(desc->feature_code) != 3) {\n\t\tkfree(buf);\n\t\treturn ODD_MECH_TYPE_UNSUPPORTED;\n\t}\n\n\tif (desc->mech_type == 0 && desc->load == 0 && desc->eject == 1) {\n\t\tkfree(buf);\n\t\treturn ODD_MECH_TYPE_SLOT;\n\t} else if (desc->mech_type == 1 && desc->load == 0 &&\n\t\t   desc->eject == 1) {\n\t\tkfree(buf);\n\t\treturn ODD_MECH_TYPE_DRAWER;\n\t} else {\n\t\tkfree(buf);\n\t\treturn ODD_MECH_TYPE_UNSUPPORTED;\n\t}\n}\n\n \nstatic bool zpready(struct ata_device *dev)\n{\n\tu8 sense_key, *sense_buf;\n\tunsigned int ret, asc, ascq, add_len;\n\tstruct zpodd *zpodd = dev->zpodd;\n\n\tret = atapi_eh_tur(dev, &sense_key);\n\n\tif (!ret || sense_key != NOT_READY)\n\t\treturn false;\n\n\tsense_buf = dev->link->ap->sector_buf;\n\tret = atapi_eh_request_sense(dev, sense_buf, sense_key);\n\tif (ret)\n\t\treturn false;\n\n\t \n\tif ((sense_buf[0] & 0x7f) != 0x70)\n\t\treturn false;\n\n\tadd_len = sense_buf[7];\n\t \n\tif (add_len < 6)\n\t\treturn false;\n\n\tasc = sense_buf[12];\n\tascq = sense_buf[13];\n\n\tif (zpodd->mech_type == ODD_MECH_TYPE_SLOT)\n\t\t \n\t\treturn asc == 0x3a;\n\telse\n\t\t \n\t\treturn asc == 0x3a && ascq == 0x01;\n}\n\n \nvoid zpodd_on_suspend(struct ata_device *dev)\n{\n\tstruct zpodd *zpodd = dev->zpodd;\n\tunsigned long expires;\n\n\tif (!zpready(dev)) {\n\t\tzpodd->zp_sampled = false;\n\t\tzpodd->zp_ready = false;\n\t\treturn;\n\t}\n\n\tif (!zpodd->zp_sampled) {\n\t\tzpodd->zp_sampled = true;\n\t\tzpodd->last_ready = jiffies;\n\t\treturn;\n\t}\n\n\texpires = zpodd->last_ready +\n\t\t  msecs_to_jiffies(zpodd_poweroff_delay * 1000);\n\tif (time_before(jiffies, expires))\n\t\treturn;\n\n\tzpodd->zp_ready = true;\n}\n\nbool zpodd_zpready(struct ata_device *dev)\n{\n\tstruct zpodd *zpodd = dev->zpodd;\n\treturn zpodd->zp_ready;\n}\n\n \nvoid zpodd_enable_run_wake(struct ata_device *dev)\n{\n\tstruct zpodd *zpodd = dev->zpodd;\n\n\tsdev_disable_disk_events(dev->sdev);\n\n\tzpodd->powered_off = true;\n\tacpi_pm_set_device_wakeup(&dev->tdev, true);\n}\n\n \nvoid zpodd_disable_run_wake(struct ata_device *dev)\n{\n\tstruct zpodd *zpodd = dev->zpodd;\n\n\tif (zpodd->powered_off)\n\t\tacpi_pm_set_device_wakeup(&dev->tdev, false);\n}\n\n \nvoid zpodd_post_poweron(struct ata_device *dev)\n{\n\tstruct zpodd *zpodd = dev->zpodd;\n\n\tif (!zpodd->powered_off)\n\t\treturn;\n\n\tzpodd->powered_off = false;\n\n\tif (zpodd->from_notify) {\n\t\tzpodd->from_notify = false;\n\t\tif (zpodd->mech_type == ODD_MECH_TYPE_DRAWER)\n\t\t\teject_tray(dev);\n\t}\n\n\tzpodd->zp_sampled = false;\n\tzpodd->zp_ready = false;\n\n\tsdev_enable_disk_events(dev->sdev);\n}\n\nstatic void zpodd_wake_dev(acpi_handle handle, u32 event, void *context)\n{\n\tstruct ata_device *ata_dev = context;\n\tstruct zpodd *zpodd = ata_dev->zpodd;\n\tstruct device *dev = &ata_dev->sdev->sdev_gendev;\n\n\tif (event == ACPI_NOTIFY_DEVICE_WAKE && pm_runtime_suspended(dev)) {\n\t\tzpodd->from_notify = true;\n\t\tpm_runtime_resume(dev);\n\t}\n}\n\nstatic void ata_acpi_add_pm_notifier(struct ata_device *dev)\n{\n\tacpi_handle handle = ata_dev_acpi_handle(dev);\n\tacpi_install_notify_handler(handle, ACPI_SYSTEM_NOTIFY,\n\t\t\t\t    zpodd_wake_dev, dev);\n}\n\nstatic void ata_acpi_remove_pm_notifier(struct ata_device *dev)\n{\n\tacpi_handle handle = ata_dev_acpi_handle(dev);\n\tacpi_remove_notify_handler(handle, ACPI_SYSTEM_NOTIFY, zpodd_wake_dev);\n}\n\nvoid zpodd_init(struct ata_device *dev)\n{\n\tstruct acpi_device *adev = ACPI_COMPANION(&dev->tdev);\n\tenum odd_mech_type mech_type;\n\tstruct zpodd *zpodd;\n\n\tif (dev->zpodd || !adev || !acpi_device_can_poweroff(adev))\n\t\treturn;\n\n\tmech_type = zpodd_get_mech_type(dev);\n\tif (mech_type == ODD_MECH_TYPE_UNSUPPORTED)\n\t\treturn;\n\n\tzpodd = kzalloc(sizeof(struct zpodd), GFP_KERNEL);\n\tif (!zpodd)\n\t\treturn;\n\n\tzpodd->mech_type = mech_type;\n\n\tata_acpi_add_pm_notifier(dev);\n\tzpodd->dev = dev;\n\tdev->zpodd = zpodd;\n\tdev_pm_qos_expose_flags(&dev->tdev, 0);\n}\n\nvoid zpodd_exit(struct ata_device *dev)\n{\n\tata_acpi_remove_pm_notifier(dev);\n\tkfree(dev->zpodd);\n\tdev->zpodd = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}