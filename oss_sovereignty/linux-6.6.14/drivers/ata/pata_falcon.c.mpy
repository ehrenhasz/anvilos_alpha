{
  "module_name": "pata_falcon.c",
  "hash_id": "ee30103052ec4133935f8f8e074a043ae21ddabb9e188d47f0c94a22649fa057",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_falcon.c",
  "human_readable_source": "\n\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_cmnd.h>\n#include <linux/ata.h>\n#include <linux/libata.h>\n#include <linux/mm.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n\n#include <asm/setup.h>\n#include <asm/atarihw.h>\n#include <asm/atariints.h>\n#include <asm/atari_stdma.h>\n\n#define DRV_NAME \"pata_falcon\"\n#define DRV_VERSION \"0.1.0\"\n\nstatic int pata_falcon_swap_mask;\n\nmodule_param_named(data_swab, pata_falcon_swap_mask, int, 0444);\nMODULE_PARM_DESC(data_swab, \"Data byte swap enable/disable bitmap (0x1==drive1, 0x2==drive2, 0x4==drive3, 0x8==drive4, default==0)\");\n\nstatic const struct scsi_host_template pata_falcon_sht = {\n\tATA_PIO_SHT(DRV_NAME),\n};\n\nstatic unsigned int pata_falcon_data_xfer(struct ata_queued_cmd *qc,\n\t\t\t\t\t  unsigned char *buf,\n\t\t\t\t\t  unsigned int buflen, int rw)\n{\n\tstruct ata_device *dev = qc->dev;\n\tstruct ata_port *ap = dev->link->ap;\n\tvoid __iomem *data_addr = ap->ioaddr.data_addr;\n\tunsigned int words = buflen >> 1;\n\tstruct scsi_cmnd *cmd = qc->scsicmd;\n\tbool swap = 1;\n\n\tif (dev->class == ATA_DEV_ATA && cmd &&\n\t    !blk_rq_is_passthrough(scsi_cmd_to_rq(cmd)))\n\t\tswap = (uintptr_t)ap->private_data & BIT(dev->devno);\n\n\t \n\tif (rw == READ) {\n\t\tif (swap)\n\t\t\traw_insw_swapw(data_addr, (u16 *)buf, words);\n\t\telse\n\t\t\traw_insw(data_addr, (u16 *)buf, words);\n\t} else {\n\t\tif (swap)\n\t\t\traw_outsw_swapw(data_addr, (u16 *)buf, words);\n\t\telse\n\t\t\traw_outsw(data_addr, (u16 *)buf, words);\n\t}\n\n\t \n\tif (unlikely(buflen & 0x01)) {\n\t\tunsigned char pad[2] = { };\n\n\t\t \n\t\tbuf += buflen - 1;\n\n\t\tif (rw == READ) {\n\t\t\tif (swap)\n\t\t\t\traw_insw_swapw(data_addr, (u16 *)pad, 1);\n\t\t\telse\n\t\t\t\traw_insw(data_addr, (u16 *)pad, 1);\n\t\t\t*buf = pad[0];\n\t\t} else {\n\t\t\tpad[0] = *buf;\n\t\t\tif (swap)\n\t\t\t\traw_outsw_swapw(data_addr, (u16 *)pad, 1);\n\t\t\telse\n\t\t\t\traw_outsw(data_addr, (u16 *)pad, 1);\n\t\t}\n\t\twords++;\n\t}\n\n\treturn words << 1;\n}\n\n \nstatic int pata_falcon_set_mode(struct ata_link *link,\n\t\t\t\tstruct ata_device **unused)\n{\n\tstruct ata_device *dev;\n\n\tata_for_each_dev(dev, link, ENABLED) {\n\t\t \n\t\tdev->pio_mode = dev->xfer_mode = XFER_PIO_0;\n\t\tdev->xfer_shift = ATA_SHIFT_PIO;\n\t\tdev->flags |= ATA_DFLAG_PIO;\n\t\tata_dev_info(dev, \"configured for PIO\\n\");\n\t}\n\treturn 0;\n}\n\nstatic struct ata_port_operations pata_falcon_ops = {\n\t.inherits\t= &ata_sff_port_ops,\n\t.sff_data_xfer\t= pata_falcon_data_xfer,\n\t.cable_detect\t= ata_cable_unknown,\n\t.set_mode\t= pata_falcon_set_mode,\n};\n\nstatic int __init pata_falcon_init_one(struct platform_device *pdev)\n{\n\tstruct resource *base_mem_res, *ctl_mem_res;\n\tstruct resource *base_res, *ctl_res, *irq_res;\n\tstruct ata_host *host;\n\tstruct ata_port *ap;\n\tvoid __iomem *base, *ctl_base;\n\tint mask_shift = 0;  \n\tint irq = 0, io_offset = 1, reg_shift = 2;  \n\n\tdev_info(&pdev->dev, \"Atari Falcon and Q40/Q60 PATA controller\\n\");\n\n\tbase_res = platform_get_resource(pdev, IORESOURCE_IO, 0);\n\tif (base_res && !devm_request_region(&pdev->dev, base_res->start,\n\t\t\t\t\t   resource_size(base_res), DRV_NAME)) {\n\t\tdev_err(&pdev->dev, \"resources busy\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tctl_res = platform_get_resource(pdev, IORESOURCE_IO, 1);\n\tif (ctl_res && !devm_request_region(&pdev->dev, ctl_res->start,\n\t\t\t\t\t    resource_size(ctl_res), DRV_NAME)) {\n\t\tdev_err(&pdev->dev, \"resources busy\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tbase_mem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!base_mem_res)\n\t\treturn -ENODEV;\n\tif (!devm_request_mem_region(&pdev->dev, base_mem_res->start,\n\t\t\t\t     resource_size(base_mem_res), DRV_NAME)) {\n\t\tdev_err(&pdev->dev, \"resources busy\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tctl_mem_res = platform_get_resource(pdev, IORESOURCE_MEM, 1);\n\tif (!ctl_mem_res)\n\t\treturn -ENODEV;\n\n\t \n\thost = ata_host_alloc(&pdev->dev, 1);\n\tif (!host)\n\t\treturn -ENOMEM;\n\tap = host->ports[0];\n\n\tap->ops = &pata_falcon_ops;\n\tap->pio_mask = ATA_PIO4;\n\tap->flags |= ATA_FLAG_SLAVE_POSS | ATA_FLAG_NO_IORDY;\n\n\t \n\tap->ioaddr.data_addr = (void __iomem *)base_mem_res->start;\n\n\tif (base_res) {\t\t \n\t\tio_offset = 0x10000;\n\t\treg_shift = 0;\n\t\tbase = (void __iomem *)base_res->start;\n\t\tctl_base = (void __iomem *)ctl_res->start;\n\t} else {\n\t\tbase = (void __iomem *)base_mem_res->start;\n\t\tctl_base = (void __iomem *)ctl_mem_res->start;\n\t}\n\n\tap->ioaddr.error_addr\t= base + io_offset + (1 << reg_shift);\n\tap->ioaddr.feature_addr\t= base + io_offset + (1 << reg_shift);\n\tap->ioaddr.nsect_addr\t= base + io_offset + (2 << reg_shift);\n\tap->ioaddr.lbal_addr\t= base + io_offset + (3 << reg_shift);\n\tap->ioaddr.lbam_addr\t= base + io_offset + (4 << reg_shift);\n\tap->ioaddr.lbah_addr\t= base + io_offset + (5 << reg_shift);\n\tap->ioaddr.device_addr\t= base + io_offset + (6 << reg_shift);\n\tap->ioaddr.status_addr\t= base + io_offset + (7 << reg_shift);\n\tap->ioaddr.command_addr\t= base + io_offset + (7 << reg_shift);\n\n\tap->ioaddr.altstatus_addr\t= ctl_base + io_offset;\n\tap->ioaddr.ctl_addr\t\t= ctl_base + io_offset;\n\n\tata_port_desc(ap, \"cmd %px ctl %px data %px\",\n\t\t      base, ctl_base, ap->ioaddr.data_addr);\n\n\tif (pdev->id > 0)\n\t\tmask_shift = 2;\n\tap->private_data = (void *)(uintptr_t)(pata_falcon_swap_mask >> mask_shift);\n\n\tirq_res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\n\tif (irq_res && irq_res->start > 0) {\n\t\tirq = irq_res->start;\n\t} else {\n\t\tap->flags |= ATA_FLAG_PIO_POLLING;\n\t\tata_port_desc(ap, \"no IRQ, using PIO polling\");\n\t}\n\n\t \n\treturn ata_host_activate(host, irq, irq ? ata_sff_interrupt : NULL,\n\t\t\t\t IRQF_SHARED, &pata_falcon_sht);\n}\n\nstatic int __exit pata_falcon_remove_one(struct platform_device *pdev)\n{\n\tstruct ata_host *host = platform_get_drvdata(pdev);\n\n\tata_host_detach(host);\n\n\treturn 0;\n}\n\nstatic struct platform_driver pata_falcon_driver = {\n\t.remove = __exit_p(pata_falcon_remove_one),\n\t.driver   = {\n\t\t.name\t= \"atari-falcon-ide\",\n\t},\n};\n\nmodule_platform_driver_probe(pata_falcon_driver, pata_falcon_init_one);\n\nMODULE_AUTHOR(\"Bartlomiej Zolnierkiewicz\");\nMODULE_DESCRIPTION(\"low-level driver for Atari Falcon PATA\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:atari-falcon-ide\");\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}