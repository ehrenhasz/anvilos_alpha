{
  "module_name": "pata_rb532_cf.c",
  "hash_id": "3d3915ea71a9813efa2174b885d75a6bf2ac6a89480923dc579de6b76f84da30",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_rb532_cf.c",
  "human_readable_source": "\n \n\n#include <linux/gfp.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <linux/io.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/gpio/consumer.h>\n\n#include <linux/libata.h>\n#include <scsi/scsi_host.h>\n\n#include <asm/mach-rc32434/rb.h>\n\n#define DRV_NAME\t\"pata-rb532-cf\"\n#define DRV_VERSION\t\"0.1.0\"\n#define DRV_DESC\t\"PATA driver for RouterBOARD 532 Compact Flash\"\n\n#define RB500_CF_MAXPORTS\t1\n#define RB500_CF_IO_DELAY\t400\n\n#define RB500_CF_REG_BASE\t0x0800\n#define RB500_CF_REG_ERR\t0x080D\n#define RB500_CF_REG_CTRL\t0x080E\n \n#define RB500_CF_REG_DBUF32\t0x0C00\n\nstruct rb532_cf_info {\n\tvoid __iomem\t*iobase;\n\tstruct gpio_desc *gpio_line;\n\tunsigned int\tirq;\n};\n\n \n\nstatic irqreturn_t rb532_pata_irq_handler(int irq, void *dev_instance)\n{\n\tstruct ata_host *ah = dev_instance;\n\tstruct rb532_cf_info *info = ah->private_data;\n\n\tif (gpiod_get_value(info->gpio_line)) {\n\t\tirq_set_irq_type(info->irq, IRQ_TYPE_LEVEL_LOW);\n\t\tata_sff_interrupt(info->irq, dev_instance);\n\t} else {\n\t\tirq_set_irq_type(info->irq, IRQ_TYPE_LEVEL_HIGH);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic struct ata_port_operations rb532_pata_port_ops = {\n\t.inherits\t\t= &ata_sff_port_ops,\n\t.sff_data_xfer\t\t= ata_sff_data_xfer32,\n};\n\n \n\nstatic const struct scsi_host_template rb532_pata_sht = {\n\tATA_PIO_SHT(DRV_NAME),\n};\n\n \n\nstatic void rb532_pata_setup_ports(struct ata_host *ah)\n{\n\tstruct rb532_cf_info *info = ah->private_data;\n\tstruct ata_port *ap;\n\n\tap = ah->ports[0];\n\n\tap->ops\t\t= &rb532_pata_port_ops;\n\tap->pio_mask\t= ATA_PIO4;\n\n\tap->ioaddr.cmd_addr\t= info->iobase + RB500_CF_REG_BASE;\n\tap->ioaddr.ctl_addr\t= info->iobase + RB500_CF_REG_CTRL;\n\tap->ioaddr.altstatus_addr = info->iobase + RB500_CF_REG_CTRL;\n\n\tata_sff_std_ports(&ap->ioaddr);\n\n\tap->ioaddr.data_addr\t= info->iobase + RB500_CF_REG_DBUF32;\n\tap->ioaddr.error_addr\t= info->iobase + RB500_CF_REG_ERR;\n}\n\nstatic int rb532_pata_driver_probe(struct platform_device *pdev)\n{\n\tint irq;\n\tstruct gpio_desc *gpiod;\n\tstruct resource *res;\n\tstruct ata_host *ah;\n\tstruct rb532_cf_info *info;\n\tint ret;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"no IOMEM resource found\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\tif (!irq)\n\t\treturn -EINVAL;\n\n\tgpiod = devm_gpiod_get(&pdev->dev, NULL, GPIOD_IN);\n\tif (IS_ERR(gpiod)) {\n\t\tdev_err(&pdev->dev, \"no GPIO found for irq%d\\n\", irq);\n\t\treturn PTR_ERR(gpiod);\n\t}\n\tgpiod_set_consumer_name(gpiod, DRV_NAME);\n\n\t \n\tah = ata_host_alloc(&pdev->dev, RB500_CF_MAXPORTS);\n\tif (!ah)\n\t\treturn -ENOMEM;\n\n\tinfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tah->private_data = info;\n\tinfo->gpio_line = gpiod;\n\tinfo->irq = irq;\n\n\tinfo->iobase = devm_ioremap(&pdev->dev, res->start,\n\t\t\t\tresource_size(res));\n\tif (!info->iobase)\n\t\treturn -ENOMEM;\n\n\trb532_pata_setup_ports(ah);\n\n\tret = ata_host_activate(ah, irq, rb532_pata_irq_handler,\n\t\t\t\tIRQF_TRIGGER_LOW, &rb532_pata_sht);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic void rb532_pata_driver_remove(struct platform_device *pdev)\n{\n\tstruct ata_host *ah = platform_get_drvdata(pdev);\n\n\tata_host_detach(ah);\n}\n\nstatic struct platform_driver rb532_pata_platform_driver = {\n\t.probe\t\t= rb532_pata_driver_probe,\n\t.remove_new\t= rb532_pata_driver_remove,\n\t.driver\t = {\n\t\t.name   = DRV_NAME,\n\t},\n};\n\n#define DRV_INFO DRV_DESC \" version \" DRV_VERSION\n\nmodule_platform_driver(rb532_pata_platform_driver);\n\nMODULE_AUTHOR(\"Gabor Juhos <juhosg at openwrt.org>\");\nMODULE_AUTHOR(\"Florian Fainelli <florian@openwrt.org>\");\nMODULE_DESCRIPTION(DRV_DESC);\nMODULE_VERSION(DRV_VERSION);\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:\" DRV_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}