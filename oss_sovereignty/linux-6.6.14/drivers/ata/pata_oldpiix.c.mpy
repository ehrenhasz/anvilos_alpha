{
  "module_name": "pata_oldpiix.c",
  "hash_id": "675111260df5506a0ff52e5bf648af1ae1cd338f0b12ceba6de99e6b554bf628",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_oldpiix.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n#include <linux/ata.h>\n\n#define DRV_NAME\t\"pata_oldpiix\"\n#define DRV_VERSION\t\"0.5.5\"\n\n \n\nstatic int oldpiix_pre_reset(struct ata_link *link, unsigned long deadline)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tstatic const struct pci_bits oldpiix_enable_bits[] = {\n\t\t{ 0x41U, 1U, 0x80UL, 0x80UL },\t \n\t\t{ 0x43U, 1U, 0x80UL, 0x80UL },\t \n\t};\n\n\tif (!pci_test_config_bits(pdev, &oldpiix_enable_bits[ap->port_no]))\n\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\n \n\nstatic void oldpiix_set_piomode (struct ata_port *ap, struct ata_device *adev)\n{\n\tunsigned int pio\t= adev->pio_mode - XFER_PIO_0;\n\tstruct pci_dev *dev\t= to_pci_dev(ap->host->dev);\n\tunsigned int idetm_port= ap->port_no ? 0x42 : 0x40;\n\tu16 idetm_data;\n\tint control = 0;\n\n\t \n\n\tstatic const\t  \n\tu8 timings[][2]\t= { { 0, 0 },\n\t\t\t    { 0, 0 },\n\t\t\t    { 1, 0 },\n\t\t\t    { 2, 1 },\n\t\t\t    { 2, 3 }, };\n\n\tif (pio > 1)\n\t\tcontrol |= 1;\t \n\tif (ata_pio_need_iordy(adev))\n\t\tcontrol |= 2;\t \n\n\t \n\tif (adev->class == ATA_DEV_ATA)\n\t\tcontrol |= 4;\t \n\n\tpci_read_config_word(dev, idetm_port, &idetm_data);\n\n\t \n\tif (adev->devno == 0) {\n\t\tidetm_data &= 0xCCE0;\n\t\tidetm_data |= control;\n\t} else {\n\t\tidetm_data &= 0xCC0E;\n\t\tidetm_data |= (control << 4);\n\t}\n\tidetm_data |= (timings[pio][0] << 12) |\n\t\t\t(timings[pio][1] << 8);\n\tpci_write_config_word(dev, idetm_port, idetm_data);\n\n\t \n\tap->private_data = adev;\n}\n\n \n\nstatic void oldpiix_set_dmamode (struct ata_port *ap, struct ata_device *adev)\n{\n\tstruct pci_dev *dev\t= to_pci_dev(ap->host->dev);\n\tu8 idetm_port\t\t= ap->port_no ? 0x42 : 0x40;\n\tu16 idetm_data;\n\n\tstatic const\t  \n\tu8 timings[][2]\t= { { 0, 0 },\n\t\t\t    { 0, 0 },\n\t\t\t    { 1, 0 },\n\t\t\t    { 2, 1 },\n\t\t\t    { 2, 3 }, };\n\n\t \n\n\tunsigned int mwdma\t= adev->dma_mode - XFER_MW_DMA_0;\n\tunsigned int control;\n\tconst unsigned int needed_pio[3] = {\n\t\tXFER_PIO_0, XFER_PIO_3, XFER_PIO_4\n\t};\n\tint pio = needed_pio[mwdma] - XFER_PIO_0;\n\n\tpci_read_config_word(dev, idetm_port, &idetm_data);\n\n\tcontrol = 3;\t \n\t \n\tif (adev->class == ATA_DEV_ATA)\n\t\tcontrol |= 4;\t \n\n\t \n\n\tif (adev->pio_mode < needed_pio[mwdma])\n\t\t \n\t\tcontrol |= 8;\t \n\n\t \n\tif (adev->devno == 0) {\n\t\tidetm_data &= 0xCCE0;\n\t\tidetm_data |= control;\n\t} else {\n\t\tidetm_data &= 0xCC0E;\n\t\tidetm_data |= (control << 4);\n\t}\n\tidetm_data |= (timings[pio][0] << 12) | (timings[pio][1] << 8);\n\tpci_write_config_word(dev, idetm_port, idetm_data);\n\n\t \n\tap->private_data = adev;\n}\n\n \n\nstatic unsigned int oldpiix_qc_issue(struct ata_queued_cmd *qc)\n{\n\tstruct ata_port *ap = qc->ap;\n\tstruct ata_device *adev = qc->dev;\n\n\tif (adev != ap->private_data) {\n\t\toldpiix_set_piomode(ap, adev);\n\t\tif (ata_dma_enabled(adev))\n\t\t\toldpiix_set_dmamode(ap, adev);\n\t}\n\treturn ata_bmdma_qc_issue(qc);\n}\n\n\nstatic const struct scsi_host_template oldpiix_sht = {\n\tATA_BMDMA_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations oldpiix_pata_ops = {\n\t.inherits\t\t= &ata_bmdma_port_ops,\n\t.qc_issue\t\t= oldpiix_qc_issue,\n\t.cable_detect\t\t= ata_cable_40wire,\n\t.set_piomode\t\t= oldpiix_set_piomode,\n\t.set_dmamode\t\t= oldpiix_set_dmamode,\n\t.prereset\t\t= oldpiix_pre_reset,\n};\n\n\n \n\nstatic int oldpiix_init_one (struct pci_dev *pdev, const struct pci_device_id *ent)\n{\n\tstatic const struct ata_port_info info = {\n\t\t.flags\t\t= ATA_FLAG_SLAVE_POSS,\n\t\t.pio_mask\t= ATA_PIO4,\n\t\t.mwdma_mask\t= ATA_MWDMA12_ONLY,\n\t\t.port_ops\t= &oldpiix_pata_ops,\n\t};\n\tconst struct ata_port_info *ppi[] = { &info, NULL };\n\n\tata_print_version_once(&pdev->dev, DRV_VERSION);\n\n\treturn ata_pci_bmdma_init_one(pdev, ppi, &oldpiix_sht, NULL, 0);\n}\n\nstatic const struct pci_device_id oldpiix_pci_tbl[] = {\n\t{ PCI_VDEVICE(INTEL, 0x1230), },\n\n\t{ }\t \n};\n\nstatic struct pci_driver oldpiix_pci_driver = {\n\t.name\t\t\t= DRV_NAME,\n\t.id_table\t\t= oldpiix_pci_tbl,\n\t.probe\t\t\t= oldpiix_init_one,\n\t.remove\t\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t\t= ata_pci_device_suspend,\n\t.resume\t\t\t= ata_pci_device_resume,\n#endif\n};\n\nmodule_pci_driver(oldpiix_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox\");\nMODULE_DESCRIPTION(\"SCSI low-level driver for early PIIX series controllers\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, oldpiix_pci_tbl);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}