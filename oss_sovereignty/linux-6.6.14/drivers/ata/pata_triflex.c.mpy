{
  "module_name": "pata_triflex.c",
  "hash_id": "0c888e8d10c55d568027c8f87e43d9b86281a7ffc55de38e49b85fef6985783f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_triflex.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n\n#define DRV_NAME \"pata_triflex\"\n#define DRV_VERSION \"0.2.8\"\n\n \n\nstatic int triflex_prereset(struct ata_link *link, unsigned long deadline)\n{\n\tstatic const struct pci_bits triflex_enable_bits[] = {\n\t\t{ 0x80, 1, 0x01, 0x01 },\n\t\t{ 0x80, 1, 0x02, 0x02 }\n\t};\n\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\n\tif (!pci_test_config_bits(pdev, &triflex_enable_bits[ap->port_no]))\n\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\n\n\n \n\nstatic void triflex_load_timing(struct ata_port *ap, struct ata_device *adev, int speed)\n{\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tu32 timing = 0;\n\tu32 triflex_timing, old_triflex_timing;\n\tint channel_offset = ap->port_no ? 0x74: 0x70;\n\tunsigned int is_slave\t= (adev->devno != 0);\n\n\n\tpci_read_config_dword(pdev, channel_offset, &old_triflex_timing);\n\ttriflex_timing = old_triflex_timing;\n\n\tswitch(speed)\n\t{\n\t\tcase XFER_MW_DMA_2:\n\t\t\ttiming = 0x0103;break;\n\t\tcase XFER_MW_DMA_1:\n\t\t\ttiming = 0x0203;break;\n\t\tcase XFER_MW_DMA_0:\n\t\t\ttiming = 0x0808;break;\n\t\tcase XFER_SW_DMA_2:\n\t\tcase XFER_SW_DMA_1:\n\t\tcase XFER_SW_DMA_0:\n\t\t\ttiming = 0x0F0F;break;\n\t\tcase XFER_PIO_4:\n\t\t\ttiming = 0x0202;break;\n\t\tcase XFER_PIO_3:\n\t\t\ttiming = 0x0204;break;\n\t\tcase XFER_PIO_2:\n\t\t\ttiming = 0x0404;break;\n\t\tcase XFER_PIO_1:\n\t\t\ttiming = 0x0508;break;\n\t\tcase XFER_PIO_0:\n\t\t\ttiming = 0x0808;break;\n\t\tdefault:\n\t\t\tBUG();\n\t}\n\ttriflex_timing &= ~ (0xFFFF << (16 * is_slave));\n\ttriflex_timing |= (timing << (16 * is_slave));\n\n\tif (triflex_timing != old_triflex_timing)\n\t\tpci_write_config_dword(pdev, channel_offset, triflex_timing);\n}\n\n \nstatic void triflex_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\ttriflex_load_timing(ap, adev, adev->pio_mode);\n}\n\n \n\nstatic void triflex_bmdma_start(struct ata_queued_cmd *qc)\n{\n\ttriflex_load_timing(qc->ap, qc->dev, qc->dev->dma_mode);\n\tata_bmdma_start(qc);\n}\n\n \n\nstatic void triflex_bmdma_stop(struct ata_queued_cmd *qc)\n{\n\tata_bmdma_stop(qc);\n\ttriflex_load_timing(qc->ap, qc->dev, qc->dev->pio_mode);\n}\n\nstatic const struct scsi_host_template triflex_sht = {\n\tATA_BMDMA_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations triflex_port_ops = {\n\t.inherits\t= &ata_bmdma_port_ops,\n\t.bmdma_start \t= triflex_bmdma_start,\n\t.bmdma_stop\t= triflex_bmdma_stop,\n\t.cable_detect\t= ata_cable_40wire,\n\t.set_piomode\t= triflex_set_piomode,\n\t.prereset\t= triflex_prereset,\n};\n\nstatic int triflex_init_one(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\tstatic const struct ata_port_info info = {\n\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t.pio_mask = ATA_PIO4,\n\t\t.mwdma_mask = ATA_MWDMA2,\n\t\t.port_ops = &triflex_port_ops\n\t};\n\tconst struct ata_port_info *ppi[] = { &info, NULL };\n\n\tata_print_version_once(&dev->dev, DRV_VERSION);\n\n\treturn ata_pci_bmdma_init_one(dev, ppi, &triflex_sht, NULL, 0);\n}\n\nstatic const struct pci_device_id triflex[] = {\n\t{ PCI_VDEVICE(COMPAQ, PCI_DEVICE_ID_COMPAQ_TRIFLEX_IDE), },\n\n\t{ },\n};\n\n#ifdef CONFIG_PM_SLEEP\nstatic int triflex_ata_pci_device_suspend(struct pci_dev *pdev, pm_message_t mesg)\n{\n\tstruct ata_host *host = pci_get_drvdata(pdev);\n\n\tata_host_suspend(host, mesg);\n\n\t \n\tpci_save_state(pdev);\n\n\treturn 0;\n}\n\n#endif\n\nstatic struct pci_driver triflex_pci_driver = {\n\t.name \t\t= DRV_NAME,\n\t.id_table\t= triflex,\n\t.probe \t\t= triflex_init_one,\n\t.remove\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t= triflex_ata_pci_device_suspend,\n\t.resume\t\t= ata_pci_device_resume,\n#endif\n};\n\nmodule_pci_driver(triflex_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox\");\nMODULE_DESCRIPTION(\"low-level driver for Compaq Triflex\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, triflex);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}