{
  "module_name": "pata_ns87410.c",
  "hash_id": "549a060a06a68c1f78febc1ae516617de884791ce222ac9430298c8e54a9590c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_ns87410.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n\n#define DRV_NAME \"pata_ns87410\"\n#define DRV_VERSION \"0.4.6\"\n\n \n\nstatic int ns87410_pre_reset(struct ata_link *link, unsigned long deadline)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tstatic const struct pci_bits ns87410_enable_bits[] = {\n\t\t{ 0x43, 1, 0x08, 0x08 },\n\t\t{ 0x47, 1, 0x08, 0x08 }\n\t};\n\n\tif (!pci_test_config_bits(pdev, &ns87410_enable_bits[ap->port_no]))\n\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\n \n\nstatic void ns87410_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tint port = 0x40 + 4 * ap->port_no;\n\tu8 idetcr, idefr;\n\tstruct ata_timing at;\n\n\tstatic const u8 activebits[15] = {\n\t\t0, 1, 2, 3, 4,\n\t\t5, 5, 6, 6, 6,\n\t\t6, 7, 7, 7, 7\n\t};\n\n\tstatic const u8 recoverbits[12] = {\n\t\t0, 1, 2, 3, 4, 5, 6, 6, 7, 7, 7, 7\n\t};\n\n\tpci_read_config_byte(pdev, port + 3, &idefr);\n\n\tif (ata_pio_need_iordy(adev))\n\t\tidefr |= 0x04;\t \n\telse\n\t\tidefr &= ~0x04;\n\n\tif (ata_timing_compute(adev, adev->pio_mode, &at, 30303, 1) < 0) {\n\t\tdev_err(&pdev->dev, \"unknown mode %d\\n\", adev->pio_mode);\n\t\treturn;\n\t}\n\n\tat.active = clamp_val(at.active, 2, 16) - 2;\n\tat.setup = clamp_val(at.setup, 1, 4) - 1;\n\tat.recover = clamp_val(at.recover, 1, 12) - 1;\n\n\tidetcr = (at.setup << 6) | (recoverbits[at.recover] << 3) | activebits[at.active];\n\n\tpci_write_config_byte(pdev, port, idetcr);\n\tpci_write_config_byte(pdev, port + 3, idefr);\n\t \n\tap->private_data = adev;\n}\n\n \n\nstatic unsigned int ns87410_qc_issue(struct ata_queued_cmd *qc)\n{\n\tstruct ata_port *ap = qc->ap;\n\tstruct ata_device *adev = qc->dev;\n\n\t \n\n\tif (adev->pio_mode && adev != ap->private_data)\n\t\tns87410_set_piomode(ap, adev);\n\n\treturn ata_sff_qc_issue(qc);\n}\n\nstatic const struct scsi_host_template ns87410_sht = {\n\tATA_PIO_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations ns87410_port_ops = {\n\t.inherits\t= &ata_sff_port_ops,\n\t.qc_issue\t= ns87410_qc_issue,\n\t.cable_detect\t= ata_cable_40wire,\n\t.set_piomode\t= ns87410_set_piomode,\n\t.prereset\t= ns87410_pre_reset,\n};\n\nstatic int ns87410_init_one(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\tstatic const struct ata_port_info info = {\n\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t.pio_mask = ATA_PIO3,\n\t\t.port_ops = &ns87410_port_ops\n\t};\n\tconst struct ata_port_info *ppi[] = { &info, NULL };\n\treturn ata_pci_sff_init_one(dev, ppi, &ns87410_sht, NULL, 0);\n}\n\nstatic const struct pci_device_id ns87410[] = {\n\t{ PCI_VDEVICE(NS, PCI_DEVICE_ID_NS_87410), },\n\n\t{ },\n};\n\nstatic struct pci_driver ns87410_pci_driver = {\n\t.name \t\t= DRV_NAME,\n\t.id_table\t= ns87410,\n\t.probe \t\t= ns87410_init_one,\n\t.remove\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t= ata_pci_device_suspend,\n\t.resume\t\t= ata_pci_device_resume,\n#endif\n};\n\nmodule_pci_driver(ns87410_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox\");\nMODULE_DESCRIPTION(\"low-level driver for Nat Semi 87410\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, ns87410);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}