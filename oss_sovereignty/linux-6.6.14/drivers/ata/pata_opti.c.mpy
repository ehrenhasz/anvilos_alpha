{
  "module_name": "pata_opti.c",
  "hash_id": "c84411e24cb6c84fc68128a9995c8e80cce6b99223af84664b202790cff30aad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_opti.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n\n#define DRV_NAME \"pata_opti\"\n#define DRV_VERSION \"0.2.9\"\n\nenum {\n\tREAD_REG\t= 0,\t \n\tWRITE_REG \t= 1,\t \n\tCNTRL_REG \t= 3,\t \n\tSTRAP_REG \t= 5,\t \n\tMISC_REG \t= 6\t \n};\n\n \n\nstatic int opti_pre_reset(struct ata_link *link, unsigned long deadline)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tstatic const struct pci_bits opti_enable_bits[] = {\n\t\t{ 0x45, 1, 0x80, 0x00 },\n\t\t{ 0x40, 1, 0x08, 0x00 }\n\t};\n\n\tif (!pci_test_config_bits(pdev, &opti_enable_bits[ap->port_no]))\n\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\n \n\nstatic void opti_write_reg(struct ata_port *ap, u8 val, int reg)\n{\n\tvoid __iomem *regio = ap->ioaddr.cmd_addr;\n\n\t \n\tioread16(regio + 1);\n\tioread16(regio + 1);\n\tiowrite8(3, regio + 2);\n\n\t \n\tiowrite8(val, regio + reg);\n\n\t \n\tiowrite8(0x83, regio + 2);\n}\n\n \n\nstatic void opti_set_piomode(struct ata_port *ap, struct ata_device *adev)\n{\n\tstruct ata_device *pair = ata_dev_pair(adev);\n\tint clock;\n\tint pio = adev->pio_mode - XFER_PIO_0;\n\tvoid __iomem *regio = ap->ioaddr.cmd_addr;\n\tu8 addr;\n\n\t \n\tstatic const u8 addr_timing[2][5] = {\n\t\t{ 0x30, 0x20, 0x20, 0x10, 0x10 },\n\t\t{ 0x20, 0x20, 0x10, 0x10, 0x10 }\n\t};\n\tstatic const u8 data_rec_timing[2][5] = {\n\t\t{ 0x6B, 0x56, 0x42, 0x32, 0x31 },\n\t\t{ 0x58, 0x44, 0x32, 0x22, 0x21 }\n\t};\n\n\tiowrite8(0xff, regio + 5);\n\tclock = ioread16(regio + 5) & 1;\n\n\t \n\n\taddr = addr_timing[clock][pio];\n\tif (pair) {\n\t\t \n\t\tu8 pair_addr = addr_timing[clock][pair->pio_mode - XFER_PIO_0];\n\t\tif (pair_addr > addr)\n\t\t\taddr = pair_addr;\n\t}\n\n\t \n\topti_write_reg(ap, adev->devno, MISC_REG);\n\topti_write_reg(ap, data_rec_timing[clock][pio], READ_REG);\n\topti_write_reg(ap, data_rec_timing[clock][pio], WRITE_REG);\n\topti_write_reg(ap, addr, MISC_REG);\n\n\t \n\topti_write_reg(ap, 0x85, CNTRL_REG);\n}\n\nstatic const struct scsi_host_template opti_sht = {\n\tATA_PIO_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations opti_port_ops = {\n\t.inherits\t= &ata_sff_port_ops,\n\t.cable_detect\t= ata_cable_40wire,\n\t.set_piomode\t= opti_set_piomode,\n\t.prereset\t= opti_pre_reset,\n};\n\nstatic int opti_init_one(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\tstatic const struct ata_port_info info = {\n\t\t.flags = ATA_FLAG_SLAVE_POSS,\n\t\t.pio_mask = ATA_PIO4,\n\t\t.port_ops = &opti_port_ops\n\t};\n\tconst struct ata_port_info *ppi[] = { &info, NULL };\n\n\tata_print_version_once(&dev->dev, DRV_VERSION);\n\n\treturn ata_pci_sff_init_one(dev, ppi, &opti_sht, NULL, 0);\n}\n\nstatic const struct pci_device_id opti[] = {\n\t{ PCI_VDEVICE(OPTI, PCI_DEVICE_ID_OPTI_82C621), 0 },\n\t{ PCI_VDEVICE(OPTI, PCI_DEVICE_ID_OPTI_82C825), 1 },\n\n\t{ },\n};\n\nstatic struct pci_driver opti_pci_driver = {\n\t.name \t\t= DRV_NAME,\n\t.id_table\t= opti,\n\t.probe \t\t= opti_init_one,\n\t.remove\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t= ata_pci_device_suspend,\n\t.resume\t\t= ata_pci_device_resume,\n#endif\n};\n\nmodule_pci_driver(opti_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox\");\nMODULE_DESCRIPTION(\"low-level driver for Opti 621/621X\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, opti);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}