{
  "module_name": "pata_marvell.c",
  "hash_id": "2c05e07f7e3b986182be17595d95855f3e54bc530d1252157cb9eb495162ad0f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ata/pata_marvell.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/blkdev.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <scsi/scsi_host.h>\n#include <linux/libata.h>\n#include <linux/ata.h>\n\n#define DRV_NAME\t\"pata_marvell\"\n#define DRV_VERSION\t\"0.1.6\"\n\n \n\nstatic int marvell_pata_active(struct pci_dev *pdev)\n{\n\tu32 devices;\n\tvoid __iomem *barp;\n\n\t \n\tif (pdev->device != 0x6145)\n\t\treturn 1;\n\n\tbarp = pci_iomap(pdev, 5, 0x10);\n\tif (barp == NULL)\n\t\treturn -ENOMEM;\n\n\tdevices = ioread32(barp + 0x0C);\n\tpci_iounmap(pdev, barp);\n\n\tif (devices & 0x10)\n\t\treturn 1;\n\treturn 0;\n}\n\n \n\nstatic int marvell_pre_reset(struct ata_link *link, unsigned long deadline)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\n\tif (pdev->device == 0x6145 && ap->port_no == 0 &&\n\t\t!marvell_pata_active(pdev))\t \n\t\t\treturn -ENOENT;\n\n\treturn ata_sff_prereset(link, deadline);\n}\n\nstatic int marvell_cable_detect(struct ata_port *ap)\n{\n\t \n\tswitch(ap->port_no)\n\t{\n\tcase 0:\n\t\tif (!ap->ioaddr.bmdma_addr)\n\t\t\treturn ATA_CBL_PATA_UNK;\n\t\tif (ioread8(ap->ioaddr.bmdma_addr + 1) & 1)\n\t\t\treturn ATA_CBL_PATA40;\n\t\treturn ATA_CBL_PATA80;\n\tcase 1:  \n\t\treturn ATA_CBL_SATA;\n\t}\n\n\tBUG();\n\treturn 0;\t \n}\n\n \n\nstatic const struct scsi_host_template marvell_sht = {\n\tATA_BMDMA_SHT(DRV_NAME),\n};\n\nstatic struct ata_port_operations marvell_ops = {\n\t.inherits\t\t= &ata_bmdma_port_ops,\n\t.cable_detect\t\t= marvell_cable_detect,\n\t.prereset\t\t= marvell_pre_reset,\n};\n\n\n \n\nstatic int marvell_init_one (struct pci_dev *pdev, const struct pci_device_id *id)\n{\n\tstatic const struct ata_port_info info = {\n\t\t.flags\t\t= ATA_FLAG_SLAVE_POSS,\n\n\t\t.pio_mask\t= ATA_PIO4,\n\t\t.mwdma_mask\t= ATA_MWDMA2,\n\t\t.udma_mask \t= ATA_UDMA5,\n\n\t\t.port_ops\t= &marvell_ops,\n\t};\n\tstatic const struct ata_port_info info_sata = {\n\t\t \n\t\t.flags\t\t= ATA_FLAG_SLAVE_POSS,\n\n\t\t.pio_mask\t= ATA_PIO4,\n\t\t.mwdma_mask\t= ATA_MWDMA2,\n\t\t.udma_mask \t= ATA_UDMA6,\n\n\t\t.port_ops\t= &marvell_ops,\n\t};\n\tconst struct ata_port_info *ppi[] = { &info, &info_sata };\n\n\tif (pdev->device == 0x6101)\n\t\tppi[1] = &ata_dummy_port_info;\n\n#if IS_ENABLED(CONFIG_SATA_AHCI)\n\tif (!marvell_pata_active(pdev)) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"PATA port not active, deferring to AHCI driver.\\n\");\n\t\treturn -ENODEV;\n\t}\n#endif\n\treturn ata_pci_bmdma_init_one(pdev, ppi, &marvell_sht, NULL, 0);\n}\n\nstatic const struct pci_device_id marvell_pci_tbl[] = {\n\t{ PCI_DEVICE(0x11AB, 0x6101), },\n\t{ PCI_DEVICE(0x11AB, 0x6121), },\n\t{ PCI_DEVICE(0x11AB, 0x6123), },\n\t{ PCI_DEVICE(0x11AB, 0x6145), },\n\t{ PCI_DEVICE(0x1B4B, 0x91A0), },\n\t{ PCI_DEVICE(0x1B4B, 0x91A4), },\n\n\t{ }\t \n};\n\nstatic struct pci_driver marvell_pci_driver = {\n\t.name\t\t\t= DRV_NAME,\n\t.id_table\t\t= marvell_pci_tbl,\n\t.probe\t\t\t= marvell_init_one,\n\t.remove\t\t\t= ata_pci_remove_one,\n#ifdef CONFIG_PM_SLEEP\n\t.suspend\t\t= ata_pci_device_suspend,\n\t.resume\t\t\t= ata_pci_device_resume,\n#endif\n};\n\nmodule_pci_driver(marvell_pci_driver);\n\nMODULE_AUTHOR(\"Alan Cox\");\nMODULE_DESCRIPTION(\"SCSI low-level driver for Marvell ATA in legacy mode\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(pci, marvell_pci_tbl);\nMODULE_VERSION(DRV_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}