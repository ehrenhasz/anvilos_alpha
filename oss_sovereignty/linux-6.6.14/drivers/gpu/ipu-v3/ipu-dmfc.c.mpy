{
  "module_name": "ipu-dmfc.c",
  "hash_id": "a5f7813648461d6fcf4938e8f2e0fe5c140bddebaf2f4bc6f358919a158aafbf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/ipu-v3/ipu-dmfc.c",
  "human_readable_source": "\n \n#include <linux/export.h>\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/io.h>\n\n#include <video/imx-ipu-v3.h>\n#include \"ipu-prv.h\"\n\n#define DMFC_RD_CHAN\t\t0x0000\n#define DMFC_WR_CHAN\t\t0x0004\n#define DMFC_WR_CHAN_DEF\t0x0008\n#define DMFC_DP_CHAN\t\t0x000c\n#define DMFC_DP_CHAN_DEF\t0x0010\n#define DMFC_GENERAL1\t\t0x0014\n#define DMFC_GENERAL2\t\t0x0018\n#define DMFC_IC_CTRL\t\t0x001c\n#define DMFC_WR_CHAN_ALT\t0x0020\n#define DMFC_WR_CHAN_DEF_ALT\t0x0024\n#define DMFC_DP_CHAN_ALT\t0x0028\n#define DMFC_DP_CHAN_DEF_ALT\t0x002c\n#define DMFC_GENERAL1_ALT\t0x0030\n#define DMFC_STAT\t\t0x0034\n\n#define DMFC_WR_CHAN_1_28\t\t0\n#define DMFC_WR_CHAN_2_41\t\t8\n#define DMFC_WR_CHAN_1C_42\t\t16\n#define DMFC_WR_CHAN_2C_43\t\t24\n\n#define DMFC_DP_CHAN_5B_23\t\t0\n#define DMFC_DP_CHAN_5F_27\t\t8\n#define DMFC_DP_CHAN_6B_24\t\t16\n#define DMFC_DP_CHAN_6F_29\t\t24\n\nstruct dmfc_channel_data {\n\tint\t\tipu_channel;\n\tunsigned long\tchannel_reg;\n\tunsigned long\tshift;\n\tunsigned\teot_shift;\n\tunsigned\tmax_fifo_lines;\n};\n\nstatic const struct dmfc_channel_data dmfcdata[] = {\n\t{\n\t\t.ipu_channel\t= IPUV3_CHANNEL_MEM_BG_SYNC,\n\t\t.channel_reg\t= DMFC_DP_CHAN,\n\t\t.shift\t\t= DMFC_DP_CHAN_5B_23,\n\t\t.eot_shift\t= 20,\n\t\t.max_fifo_lines\t= 3,\n\t}, {\n\t\t.ipu_channel\t= 24,\n\t\t.channel_reg\t= DMFC_DP_CHAN,\n\t\t.shift\t\t= DMFC_DP_CHAN_6B_24,\n\t\t.eot_shift\t= 22,\n\t\t.max_fifo_lines\t= 1,\n\t}, {\n\t\t.ipu_channel\t= IPUV3_CHANNEL_MEM_FG_SYNC,\n\t\t.channel_reg\t= DMFC_DP_CHAN,\n\t\t.shift\t\t= DMFC_DP_CHAN_5F_27,\n\t\t.eot_shift\t= 21,\n\t\t.max_fifo_lines\t= 2,\n\t}, {\n\t\t.ipu_channel\t= IPUV3_CHANNEL_MEM_DC_SYNC,\n\t\t.channel_reg\t= DMFC_WR_CHAN,\n\t\t.shift\t\t= DMFC_WR_CHAN_1_28,\n\t\t.eot_shift\t= 16,\n\t\t.max_fifo_lines\t= 2,\n\t}, {\n\t\t.ipu_channel\t= 29,\n\t\t.channel_reg\t= DMFC_DP_CHAN,\n\t\t.shift\t\t= DMFC_DP_CHAN_6F_29,\n\t\t.eot_shift\t= 23,\n\t\t.max_fifo_lines\t= 1,\n\t},\n};\n\n#define DMFC_NUM_CHANNELS\tARRAY_SIZE(dmfcdata)\n\nstruct ipu_dmfc_priv;\n\nstruct dmfc_channel {\n\tunsigned\t\t\tslots;\n\tstruct ipu_soc\t\t\t*ipu;\n\tstruct ipu_dmfc_priv\t\t*priv;\n\tconst struct dmfc_channel_data\t*data;\n};\n\nstruct ipu_dmfc_priv {\n\tstruct ipu_soc *ipu;\n\tstruct device *dev;\n\tstruct dmfc_channel channels[DMFC_NUM_CHANNELS];\n\tstruct mutex mutex;\n\tvoid __iomem *base;\n\tint use_count;\n};\n\nint ipu_dmfc_enable_channel(struct dmfc_channel *dmfc)\n{\n\tstruct ipu_dmfc_priv *priv = dmfc->priv;\n\tmutex_lock(&priv->mutex);\n\n\tif (!priv->use_count)\n\t\tipu_module_enable(priv->ipu, IPU_CONF_DMFC_EN);\n\n\tpriv->use_count++;\n\n\tmutex_unlock(&priv->mutex);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ipu_dmfc_enable_channel);\n\nvoid ipu_dmfc_disable_channel(struct dmfc_channel *dmfc)\n{\n\tstruct ipu_dmfc_priv *priv = dmfc->priv;\n\n\tmutex_lock(&priv->mutex);\n\n\tpriv->use_count--;\n\n\tif (!priv->use_count)\n\t\tipu_module_disable(priv->ipu, IPU_CONF_DMFC_EN);\n\n\tif (priv->use_count < 0)\n\t\tpriv->use_count = 0;\n\n\tmutex_unlock(&priv->mutex);\n}\nEXPORT_SYMBOL_GPL(ipu_dmfc_disable_channel);\n\nvoid ipu_dmfc_config_wait4eot(struct dmfc_channel *dmfc, int width)\n{\n\tstruct ipu_dmfc_priv *priv = dmfc->priv;\n\tu32 dmfc_gen1;\n\n\tmutex_lock(&priv->mutex);\n\n\tdmfc_gen1 = readl(priv->base + DMFC_GENERAL1);\n\n\tif ((dmfc->slots * 64 * 4) / width > dmfc->data->max_fifo_lines)\n\t\tdmfc_gen1 |= 1 << dmfc->data->eot_shift;\n\telse\n\t\tdmfc_gen1 &= ~(1 << dmfc->data->eot_shift);\n\n\twritel(dmfc_gen1, priv->base + DMFC_GENERAL1);\n\n\tmutex_unlock(&priv->mutex);\n}\nEXPORT_SYMBOL_GPL(ipu_dmfc_config_wait4eot);\n\nstruct dmfc_channel *ipu_dmfc_get(struct ipu_soc *ipu, int ipu_channel)\n{\n\tstruct ipu_dmfc_priv *priv = ipu->dmfc_priv;\n\tint i;\n\n\tfor (i = 0; i < DMFC_NUM_CHANNELS; i++)\n\t\tif (dmfcdata[i].ipu_channel == ipu_channel)\n\t\t\treturn &priv->channels[i];\n\treturn ERR_PTR(-ENODEV);\n}\nEXPORT_SYMBOL_GPL(ipu_dmfc_get);\n\nvoid ipu_dmfc_put(struct dmfc_channel *dmfc)\n{\n}\nEXPORT_SYMBOL_GPL(ipu_dmfc_put);\n\nint ipu_dmfc_init(struct ipu_soc *ipu, struct device *dev, unsigned long base,\n\t\tstruct clk *ipu_clk)\n{\n\tstruct ipu_dmfc_priv *priv;\n\tint i;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->base = devm_ioremap(dev, base, PAGE_SIZE);\n\tif (!priv->base)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = dev;\n\tpriv->ipu = ipu;\n\tmutex_init(&priv->mutex);\n\n\tipu->dmfc_priv = priv;\n\n\tfor (i = 0; i < DMFC_NUM_CHANNELS; i++) {\n\t\tpriv->channels[i].priv = priv;\n\t\tpriv->channels[i].ipu = ipu;\n\t\tpriv->channels[i].data = &dmfcdata[i];\n\n\t\tif (dmfcdata[i].ipu_channel == IPUV3_CHANNEL_MEM_BG_SYNC ||\n\t\t    dmfcdata[i].ipu_channel == IPUV3_CHANNEL_MEM_FG_SYNC ||\n\t\t    dmfcdata[i].ipu_channel == IPUV3_CHANNEL_MEM_DC_SYNC)\n\t\t\tpriv->channels[i].slots = 2;\n\t}\n\n\twritel(0x00000050, priv->base + DMFC_WR_CHAN);\n\twritel(0x00005654, priv->base + DMFC_DP_CHAN);\n\twritel(0x202020f6, priv->base + DMFC_WR_CHAN_DEF);\n\twritel(0x2020f6f6, priv->base + DMFC_DP_CHAN_DEF);\n\twritel(0x00000003, priv->base + DMFC_GENERAL1);\n\n\treturn 0;\n}\n\nvoid ipu_dmfc_exit(struct ipu_soc *ipu)\n{\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}