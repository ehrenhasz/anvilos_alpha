{
  "module_name": "ipu-cpmem.c",
  "hash_id": "ae1d3c8505d41b354e2adda60422e2eae47021d53d569fe1bc589c48d376b78b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/ipu-v3/ipu-cpmem.c",
  "human_readable_source": "\n \n#include <linux/types.h>\n#include <linux/bitrev.h>\n#include <linux/io.h>\n#include <linux/sizes.h>\n#include <drm/drm_fourcc.h>\n#include \"ipu-prv.h\"\n\nstruct ipu_cpmem_word {\n\tu32 data[5];\n\tu32 res[3];\n};\n\nstruct ipu_ch_param {\n\tstruct ipu_cpmem_word word[2];\n};\n\nstruct ipu_cpmem {\n\tstruct ipu_ch_param __iomem *base;\n\tu32 module;\n\tspinlock_t lock;\n\tint use_count;\n\tstruct ipu_soc *ipu;\n};\n\n#define IPU_CPMEM_WORD(word, ofs, size) ((((word) * 160 + (ofs)) << 8) | (size))\n\n#define IPU_FIELD_UBO\t\tIPU_CPMEM_WORD(0, 46, 22)\n#define IPU_FIELD_VBO\t\tIPU_CPMEM_WORD(0, 68, 22)\n#define IPU_FIELD_IOX\t\tIPU_CPMEM_WORD(0, 90, 4)\n#define IPU_FIELD_RDRW\t\tIPU_CPMEM_WORD(0, 94, 1)\n#define IPU_FIELD_SO\t\tIPU_CPMEM_WORD(0, 113, 1)\n#define IPU_FIELD_SLY\t\tIPU_CPMEM_WORD(1, 102, 14)\n#define IPU_FIELD_SLUV\t\tIPU_CPMEM_WORD(1, 128, 14)\n\n#define IPU_FIELD_XV\t\tIPU_CPMEM_WORD(0, 0, 10)\n#define IPU_FIELD_YV\t\tIPU_CPMEM_WORD(0, 10, 9)\n#define IPU_FIELD_XB\t\tIPU_CPMEM_WORD(0, 19, 13)\n#define IPU_FIELD_YB\t\tIPU_CPMEM_WORD(0, 32, 12)\n#define IPU_FIELD_NSB_B\t\tIPU_CPMEM_WORD(0, 44, 1)\n#define IPU_FIELD_CF\t\tIPU_CPMEM_WORD(0, 45, 1)\n#define IPU_FIELD_SX\t\tIPU_CPMEM_WORD(0, 46, 12)\n#define IPU_FIELD_SY\t\tIPU_CPMEM_WORD(0, 58, 11)\n#define IPU_FIELD_NS\t\tIPU_CPMEM_WORD(0, 69, 10)\n#define IPU_FIELD_SDX\t\tIPU_CPMEM_WORD(0, 79, 7)\n#define IPU_FIELD_SM\t\tIPU_CPMEM_WORD(0, 86, 10)\n#define IPU_FIELD_SCC\t\tIPU_CPMEM_WORD(0, 96, 1)\n#define IPU_FIELD_SCE\t\tIPU_CPMEM_WORD(0, 97, 1)\n#define IPU_FIELD_SDY\t\tIPU_CPMEM_WORD(0, 98, 7)\n#define IPU_FIELD_SDRX\t\tIPU_CPMEM_WORD(0, 105, 1)\n#define IPU_FIELD_SDRY\t\tIPU_CPMEM_WORD(0, 106, 1)\n#define IPU_FIELD_BPP\t\tIPU_CPMEM_WORD(0, 107, 3)\n#define IPU_FIELD_DEC_SEL\tIPU_CPMEM_WORD(0, 110, 2)\n#define IPU_FIELD_DIM\t\tIPU_CPMEM_WORD(0, 112, 1)\n#define IPU_FIELD_BNDM\t\tIPU_CPMEM_WORD(0, 114, 3)\n#define IPU_FIELD_BM\t\tIPU_CPMEM_WORD(0, 117, 2)\n#define IPU_FIELD_ROT\t\tIPU_CPMEM_WORD(0, 119, 1)\n#define IPU_FIELD_ROT_HF_VF\tIPU_CPMEM_WORD(0, 119, 3)\n#define IPU_FIELD_HF\t\tIPU_CPMEM_WORD(0, 120, 1)\n#define IPU_FIELD_VF\t\tIPU_CPMEM_WORD(0, 121, 1)\n#define IPU_FIELD_THE\t\tIPU_CPMEM_WORD(0, 122, 1)\n#define IPU_FIELD_CAP\t\tIPU_CPMEM_WORD(0, 123, 1)\n#define IPU_FIELD_CAE\t\tIPU_CPMEM_WORD(0, 124, 1)\n#define IPU_FIELD_FW\t\tIPU_CPMEM_WORD(0, 125, 13)\n#define IPU_FIELD_FH\t\tIPU_CPMEM_WORD(0, 138, 12)\n#define IPU_FIELD_EBA0\t\tIPU_CPMEM_WORD(1, 0, 29)\n#define IPU_FIELD_EBA1\t\tIPU_CPMEM_WORD(1, 29, 29)\n#define IPU_FIELD_ILO\t\tIPU_CPMEM_WORD(1, 58, 20)\n#define IPU_FIELD_NPB\t\tIPU_CPMEM_WORD(1, 78, 7)\n#define IPU_FIELD_PFS\t\tIPU_CPMEM_WORD(1, 85, 4)\n#define IPU_FIELD_ALU\t\tIPU_CPMEM_WORD(1, 89, 1)\n#define IPU_FIELD_ALBM\t\tIPU_CPMEM_WORD(1, 90, 3)\n#define IPU_FIELD_ID\t\tIPU_CPMEM_WORD(1, 93, 2)\n#define IPU_FIELD_TH\t\tIPU_CPMEM_WORD(1, 95, 7)\n#define IPU_FIELD_SL\t\tIPU_CPMEM_WORD(1, 102, 14)\n#define IPU_FIELD_WID0\t\tIPU_CPMEM_WORD(1, 116, 3)\n#define IPU_FIELD_WID1\t\tIPU_CPMEM_WORD(1, 119, 3)\n#define IPU_FIELD_WID2\t\tIPU_CPMEM_WORD(1, 122, 3)\n#define IPU_FIELD_WID3\t\tIPU_CPMEM_WORD(1, 125, 3)\n#define IPU_FIELD_OFS0\t\tIPU_CPMEM_WORD(1, 128, 5)\n#define IPU_FIELD_OFS1\t\tIPU_CPMEM_WORD(1, 133, 5)\n#define IPU_FIELD_OFS2\t\tIPU_CPMEM_WORD(1, 138, 5)\n#define IPU_FIELD_OFS3\t\tIPU_CPMEM_WORD(1, 143, 5)\n#define IPU_FIELD_SXYS\t\tIPU_CPMEM_WORD(1, 148, 1)\n#define IPU_FIELD_CRE\t\tIPU_CPMEM_WORD(1, 149, 1)\n#define IPU_FIELD_DEC_SEL2\tIPU_CPMEM_WORD(1, 150, 1)\n\nstatic inline struct ipu_ch_param __iomem *\nipu_get_cpmem(struct ipuv3_channel *ch)\n{\n\tstruct ipu_cpmem *cpmem = ch->ipu->cpmem_priv;\n\n\treturn cpmem->base + ch->num;\n}\n\nstatic void ipu_ch_param_write_field(struct ipuv3_channel *ch, u32 wbs, u32 v)\n{\n\tstruct ipu_ch_param __iomem *base = ipu_get_cpmem(ch);\n\tu32 bit = (wbs >> 8) % 160;\n\tu32 size = wbs & 0xff;\n\tu32 word = (wbs >> 8) / 160;\n\tu32 i = bit / 32;\n\tu32 ofs = bit % 32;\n\tu32 mask = (1 << size) - 1;\n\tu32 val;\n\n\tpr_debug(\"%s %d %d %d\\n\", __func__, word, bit , size);\n\n\tval = readl(&base->word[word].data[i]);\n\tval &= ~(mask << ofs);\n\tval |= v << ofs;\n\twritel(val, &base->word[word].data[i]);\n\n\tif ((bit + size - 1) / 32 > i) {\n\t\tval = readl(&base->word[word].data[i + 1]);\n\t\tval &= ~(mask >> (ofs ? (32 - ofs) : 0));\n\t\tval |= v >> (ofs ? (32 - ofs) : 0);\n\t\twritel(val, &base->word[word].data[i + 1]);\n\t}\n}\n\nstatic u32 ipu_ch_param_read_field(struct ipuv3_channel *ch, u32 wbs)\n{\n\tstruct ipu_ch_param __iomem *base = ipu_get_cpmem(ch);\n\tu32 bit = (wbs >> 8) % 160;\n\tu32 size = wbs & 0xff;\n\tu32 word = (wbs >> 8) / 160;\n\tu32 i = bit / 32;\n\tu32 ofs = bit % 32;\n\tu32 mask = (1 << size) - 1;\n\tu32 val = 0;\n\n\tpr_debug(\"%s %d %d %d\\n\", __func__, word, bit , size);\n\n\tval = (readl(&base->word[word].data[i]) >> ofs) & mask;\n\n\tif ((bit + size - 1) / 32 > i) {\n\t\tu32 tmp;\n\n\t\ttmp = readl(&base->word[word].data[i + 1]);\n\t\ttmp &= mask >> (ofs ? (32 - ofs) : 0);\n\t\tval |= tmp << (ofs ? (32 - ofs) : 0);\n\t}\n\n\treturn val;\n}\n\n \nstatic int v4l2_pix_fmt_to_drm_fourcc(u32 pixelformat)\n{\n\tswitch (pixelformat) {\n\tcase V4L2_PIX_FMT_RGB565:\n\t\t \n\t\treturn DRM_FORMAT_RGB565;\n\tcase V4L2_PIX_FMT_BGR24:\n\t\t \n\t\treturn DRM_FORMAT_RGB888;\n\tcase V4L2_PIX_FMT_RGB24:\n\t\t \n\t\treturn DRM_FORMAT_BGR888;\n\tcase V4L2_PIX_FMT_BGR32:\n\t\t \n\t\treturn DRM_FORMAT_XRGB8888;\n\tcase V4L2_PIX_FMT_RGB32:\n\t\t \n\t\treturn DRM_FORMAT_XBGR8888;\n\tcase V4L2_PIX_FMT_ABGR32:\n\t\t \n\t\treturn DRM_FORMAT_ARGB8888;\n\tcase V4L2_PIX_FMT_XBGR32:\n\t\t \n\t\treturn DRM_FORMAT_XRGB8888;\n\tcase V4L2_PIX_FMT_BGRA32:\n\t\t \n\t\treturn DRM_FORMAT_RGBA8888;\n\tcase V4L2_PIX_FMT_BGRX32:\n\t\t \n\t\treturn DRM_FORMAT_RGBX8888;\n\tcase V4L2_PIX_FMT_RGBA32:\n\t\t \n\t\treturn DRM_FORMAT_ABGR8888;\n\tcase V4L2_PIX_FMT_RGBX32:\n\t\t \n\t\treturn DRM_FORMAT_XBGR8888;\n\tcase V4L2_PIX_FMT_ARGB32:\n\t\t \n\t\treturn DRM_FORMAT_BGRA8888;\n\tcase V4L2_PIX_FMT_XRGB32:\n\t\t \n\t\treturn DRM_FORMAT_BGRX8888;\n\tcase V4L2_PIX_FMT_UYVY:\n\t\treturn DRM_FORMAT_UYVY;\n\tcase V4L2_PIX_FMT_YUYV:\n\t\treturn DRM_FORMAT_YUYV;\n\tcase V4L2_PIX_FMT_YUV420:\n\t\treturn DRM_FORMAT_YUV420;\n\tcase V4L2_PIX_FMT_YUV422P:\n\t\treturn DRM_FORMAT_YUV422;\n\tcase V4L2_PIX_FMT_YVU420:\n\t\treturn DRM_FORMAT_YVU420;\n\tcase V4L2_PIX_FMT_NV12:\n\t\treturn DRM_FORMAT_NV12;\n\tcase V4L2_PIX_FMT_NV16:\n\t\treturn DRM_FORMAT_NV16;\n\t}\n\n\treturn -EINVAL;\n}\n\nvoid ipu_cpmem_zero(struct ipuv3_channel *ch)\n{\n\tstruct ipu_ch_param __iomem *p = ipu_get_cpmem(ch);\n\tvoid __iomem *base = p;\n\tint i;\n\n\tfor (i = 0; i < sizeof(*p) / sizeof(u32); i++)\n\t\twritel(0, base + i * sizeof(u32));\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_zero);\n\nvoid ipu_cpmem_set_resolution(struct ipuv3_channel *ch, int xres, int yres)\n{\n\tipu_ch_param_write_field(ch, IPU_FIELD_FW, xres - 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_FH, yres - 1);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_resolution);\n\nvoid ipu_cpmem_skip_odd_chroma_rows(struct ipuv3_channel *ch)\n{\n\tipu_ch_param_write_field(ch, IPU_FIELD_RDRW, 1);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_skip_odd_chroma_rows);\n\nvoid ipu_cpmem_set_stride(struct ipuv3_channel *ch, int stride)\n{\n\tipu_ch_param_write_field(ch, IPU_FIELD_SLY, stride - 1);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_stride);\n\nvoid ipu_cpmem_set_high_priority(struct ipuv3_channel *ch)\n{\n\tstruct ipu_soc *ipu = ch->ipu;\n\tu32 val;\n\n\tif (ipu->ipu_type == IPUV3EX)\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_ID, 1);\n\n\tval = ipu_idmac_read(ipu, IDMAC_CHA_PRI(ch->num));\n\tval |= 1 << (ch->num % 32);\n\tipu_idmac_write(ipu, val, IDMAC_CHA_PRI(ch->num));\n};\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_high_priority);\n\nvoid ipu_cpmem_set_buffer(struct ipuv3_channel *ch, int bufnum, dma_addr_t buf)\n{\n\tWARN_ON_ONCE(buf & 0x7);\n\n\tif (bufnum)\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_EBA1, buf >> 3);\n\telse\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_EBA0, buf >> 3);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_buffer);\n\nvoid ipu_cpmem_set_uv_offset(struct ipuv3_channel *ch, u32 u_off, u32 v_off)\n{\n\tWARN_ON_ONCE((u_off & 0x7) || (v_off & 0x7));\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_UBO, u_off / 8);\n\tipu_ch_param_write_field(ch, IPU_FIELD_VBO, v_off / 8);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_uv_offset);\n\nvoid ipu_cpmem_interlaced_scan(struct ipuv3_channel *ch, int stride,\n\t\t\t       u32 pixelformat)\n{\n\tu32 ilo, sly, sluv;\n\n\tif (stride < 0) {\n\t\tstride = -stride;\n\t\tilo = 0x100000 - (stride / 8);\n\t} else {\n\t\tilo = stride / 8;\n\t}\n\n\tsly = (stride * 2) - 1;\n\n\tswitch (pixelformat) {\n\tcase V4L2_PIX_FMT_YUV420:\n\tcase V4L2_PIX_FMT_YVU420:\n\t\tsluv = stride / 2 - 1;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV12:\n\t\tsluv = stride - 1;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_YUV422P:\n\t\tsluv = stride - 1;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV16:\n\t\tsluv = stride * 2 - 1;\n\t\tbreak;\n\tdefault:\n\t\tsluv = 0;\n\t\tbreak;\n\t}\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_SO, 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_ILO, ilo);\n\tipu_ch_param_write_field(ch, IPU_FIELD_SLY, sly);\n\tif (sluv)\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_SLUV, sluv);\n};\nEXPORT_SYMBOL_GPL(ipu_cpmem_interlaced_scan);\n\nvoid ipu_cpmem_set_axi_id(struct ipuv3_channel *ch, u32 id)\n{\n\tid &= 0x3;\n\tipu_ch_param_write_field(ch, IPU_FIELD_ID, id);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_axi_id);\n\nint ipu_cpmem_get_burstsize(struct ipuv3_channel *ch)\n{\n\treturn ipu_ch_param_read_field(ch, IPU_FIELD_NPB) + 1;\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_get_burstsize);\n\nvoid ipu_cpmem_set_burstsize(struct ipuv3_channel *ch, int burstsize)\n{\n\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, burstsize - 1);\n};\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_burstsize);\n\nvoid ipu_cpmem_set_block_mode(struct ipuv3_channel *ch)\n{\n\tipu_ch_param_write_field(ch, IPU_FIELD_BM, 1);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_block_mode);\n\nvoid ipu_cpmem_set_rotation(struct ipuv3_channel *ch,\n\t\t\t    enum ipu_rotate_mode rot)\n{\n\tu32 temp_rot = bitrev8(rot) >> 5;\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_ROT_HF_VF, temp_rot);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_rotation);\n\nint ipu_cpmem_set_format_rgb(struct ipuv3_channel *ch,\n\t\t\t     const struct ipu_rgb *rgb)\n{\n\tint bpp = 0, npb = 0, ro, go, bo, to;\n\n\tro = rgb->bits_per_pixel - rgb->red.length - rgb->red.offset;\n\tgo = rgb->bits_per_pixel - rgb->green.length - rgb->green.offset;\n\tbo = rgb->bits_per_pixel - rgb->blue.length - rgb->blue.offset;\n\tto = rgb->bits_per_pixel - rgb->transp.length - rgb->transp.offset;\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_WID0, rgb->red.length - 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_OFS0, ro);\n\tipu_ch_param_write_field(ch, IPU_FIELD_WID1, rgb->green.length - 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_OFS1, go);\n\tipu_ch_param_write_field(ch, IPU_FIELD_WID2, rgb->blue.length - 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_OFS2, bo);\n\n\tif (rgb->transp.length) {\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_WID3,\n\t\t\t\trgb->transp.length - 1);\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_OFS3, to);\n\t} else {\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_WID3, 7);\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_OFS3,\n\t\t\t\trgb->bits_per_pixel);\n\t}\n\n\tswitch (rgb->bits_per_pixel) {\n\tcase 32:\n\t\tbpp = 0;\n\t\tnpb = 15;\n\t\tbreak;\n\tcase 24:\n\t\tbpp = 1;\n\t\tnpb = 19;\n\t\tbreak;\n\tcase 16:\n\t\tbpp = 3;\n\t\tnpb = 31;\n\t\tbreak;\n\tcase 8:\n\t\tbpp = 5;\n\t\tnpb = 63;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tipu_ch_param_write_field(ch, IPU_FIELD_BPP, bpp);\n\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, npb);\n\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 7);  \n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_format_rgb);\n\nint ipu_cpmem_set_format_passthrough(struct ipuv3_channel *ch, int width)\n{\n\tint bpp = 0, npb = 0;\n\n\tswitch (width) {\n\tcase 32:\n\t\tbpp = 0;\n\t\tnpb = 15;\n\t\tbreak;\n\tcase 24:\n\t\tbpp = 1;\n\t\tnpb = 19;\n\t\tbreak;\n\tcase 16:\n\t\tbpp = 3;\n\t\tnpb = 31;\n\t\tbreak;\n\tcase 8:\n\t\tbpp = 5;\n\t\tnpb = 63;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_BPP, bpp);\n\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, npb);\n\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 6);  \n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_format_passthrough);\n\nvoid ipu_cpmem_set_yuv_interleaved(struct ipuv3_channel *ch, u32 pixel_format)\n{\n\tswitch (pixel_format) {\n\tcase V4L2_PIX_FMT_UYVY:\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_BPP, 3);  \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 0xA); \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31); \n\t\tbreak;\n\tcase V4L2_PIX_FMT_YUYV:\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_BPP, 3);  \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 0x8); \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31); \n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_yuv_interleaved);\n\nvoid ipu_cpmem_set_yuv_planar_full(struct ipuv3_channel *ch,\n\t\t\t\t   unsigned int uv_stride,\n\t\t\t\t   unsigned int u_offset, unsigned int v_offset)\n{\n\tWARN_ON_ONCE((u_offset & 0x7) || (v_offset & 0x7));\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_SLUV, uv_stride - 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_UBO, u_offset / 8);\n\tipu_ch_param_write_field(ch, IPU_FIELD_VBO, v_offset / 8);\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_yuv_planar_full);\n\nstatic const struct ipu_rgb def_xrgb_32 = {\n\t.red\t= { .offset = 16, .length = 8, },\n\t.green\t= { .offset =  8, .length = 8, },\n\t.blue\t= { .offset =  0, .length = 8, },\n\t.transp = { .offset = 24, .length = 8, },\n\t.bits_per_pixel = 32,\n};\n\nstatic const struct ipu_rgb def_xbgr_32 = {\n\t.red\t= { .offset =  0, .length = 8, },\n\t.green\t= { .offset =  8, .length = 8, },\n\t.blue\t= { .offset = 16, .length = 8, },\n\t.transp = { .offset = 24, .length = 8, },\n\t.bits_per_pixel = 32,\n};\n\nstatic const struct ipu_rgb def_rgbx_32 = {\n\t.red\t= { .offset = 24, .length = 8, },\n\t.green\t= { .offset = 16, .length = 8, },\n\t.blue\t= { .offset =  8, .length = 8, },\n\t.transp = { .offset =  0, .length = 8, },\n\t.bits_per_pixel = 32,\n};\n\nstatic const struct ipu_rgb def_bgrx_32 = {\n\t.red\t= { .offset =  8, .length = 8, },\n\t.green\t= { .offset = 16, .length = 8, },\n\t.blue\t= { .offset = 24, .length = 8, },\n\t.transp = { .offset =  0, .length = 8, },\n\t.bits_per_pixel = 32,\n};\n\nstatic const struct ipu_rgb def_rgb_24 = {\n\t.red\t= { .offset = 16, .length = 8, },\n\t.green\t= { .offset =  8, .length = 8, },\n\t.blue\t= { .offset =  0, .length = 8, },\n\t.transp = { .offset =  0, .length = 0, },\n\t.bits_per_pixel = 24,\n};\n\nstatic const struct ipu_rgb def_bgr_24 = {\n\t.red\t= { .offset =  0, .length = 8, },\n\t.green\t= { .offset =  8, .length = 8, },\n\t.blue\t= { .offset = 16, .length = 8, },\n\t.transp = { .offset =  0, .length = 0, },\n\t.bits_per_pixel = 24,\n};\n\nstatic const struct ipu_rgb def_rgb_16 = {\n\t.red\t= { .offset = 11, .length = 5, },\n\t.green\t= { .offset =  5, .length = 6, },\n\t.blue\t= { .offset =  0, .length = 5, },\n\t.transp = { .offset =  0, .length = 0, },\n\t.bits_per_pixel = 16,\n};\n\nstatic const struct ipu_rgb def_bgr_16 = {\n\t.red\t= { .offset =  0, .length = 5, },\n\t.green\t= { .offset =  5, .length = 6, },\n\t.blue\t= { .offset = 11, .length = 5, },\n\t.transp = { .offset =  0, .length = 0, },\n\t.bits_per_pixel = 16,\n};\n\nstatic const struct ipu_rgb def_argb_16 = {\n\t.red\t= { .offset = 10, .length = 5, },\n\t.green\t= { .offset =  5, .length = 5, },\n\t.blue\t= { .offset =  0, .length = 5, },\n\t.transp = { .offset = 15, .length = 1, },\n\t.bits_per_pixel = 16,\n};\n\nstatic const struct ipu_rgb def_argb_16_4444 = {\n\t.red\t= { .offset =  8, .length = 4, },\n\t.green\t= { .offset =  4, .length = 4, },\n\t.blue\t= { .offset =  0, .length = 4, },\n\t.transp = { .offset = 12, .length = 4, },\n\t.bits_per_pixel = 16,\n};\n\nstatic const struct ipu_rgb def_abgr_16 = {\n\t.red\t= { .offset =  0, .length = 5, },\n\t.green\t= { .offset =  5, .length = 5, },\n\t.blue\t= { .offset = 10, .length = 5, },\n\t.transp = { .offset = 15, .length = 1, },\n\t.bits_per_pixel = 16,\n};\n\nstatic const struct ipu_rgb def_rgba_16 = {\n\t.red\t= { .offset = 11, .length = 5, },\n\t.green\t= { .offset =  6, .length = 5, },\n\t.blue\t= { .offset =  1, .length = 5, },\n\t.transp = { .offset =  0, .length = 1, },\n\t.bits_per_pixel = 16,\n};\n\nstatic const struct ipu_rgb def_bgra_16 = {\n\t.red\t= { .offset =  1, .length = 5, },\n\t.green\t= { .offset =  6, .length = 5, },\n\t.blue\t= { .offset = 11, .length = 5, },\n\t.transp = { .offset =  0, .length = 1, },\n\t.bits_per_pixel = 16,\n};\n\n#define Y_OFFSET(pix, x, y)\t((x) + pix->bytesperline * (y))\n#define U_OFFSET(pix, x, y)\t((pix->bytesperline * pix->height) +\t \\\n\t\t\t\t (pix->bytesperline * ((y) / 2) / 2) + (x) / 2)\n#define V_OFFSET(pix, x, y)\t((pix->bytesperline * pix->height) +\t \\\n\t\t\t\t (pix->bytesperline * pix->height / 4) + \\\n\t\t\t\t (pix->bytesperline * ((y) / 2) / 2) + (x) / 2)\n#define U2_OFFSET(pix, x, y)\t((pix->bytesperline * pix->height) +\t \\\n\t\t\t\t (pix->bytesperline * (y) / 2) + (x) / 2)\n#define V2_OFFSET(pix, x, y)\t((pix->bytesperline * pix->height) +\t \\\n\t\t\t\t (pix->bytesperline * pix->height / 2) + \\\n\t\t\t\t (pix->bytesperline * (y) / 2) + (x) / 2)\n#define UV_OFFSET(pix, x, y)\t((pix->bytesperline * pix->height) +\t \\\n\t\t\t\t (pix->bytesperline * ((y) / 2)) + (x))\n#define UV2_OFFSET(pix, x, y)\t((pix->bytesperline * pix->height) +\t \\\n\t\t\t\t (pix->bytesperline * y) + (x))\n\n#define NUM_ALPHA_CHANNELS\t7\n\n \nstatic int ipu_channel_albm(int ch_num)\n{\n\tswitch (ch_num) {\n\tcase IPUV3_CHANNEL_G_MEM_IC_PRP_VF:\treturn 0;\n\tcase IPUV3_CHANNEL_G_MEM_IC_PP:\t\treturn 1;\n\tcase IPUV3_CHANNEL_MEM_FG_SYNC:\t\treturn 2;\n\tcase IPUV3_CHANNEL_MEM_FG_ASYNC:\treturn 3;\n\tcase IPUV3_CHANNEL_MEM_BG_SYNC:\t\treturn 4;\n\tcase IPUV3_CHANNEL_MEM_BG_ASYNC:\treturn 5;\n\tcase IPUV3_CHANNEL_MEM_VDI_PLANE1_COMB: return 6;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic void ipu_cpmem_set_separate_alpha(struct ipuv3_channel *ch)\n{\n\tstruct ipu_soc *ipu = ch->ipu;\n\tint albm;\n\tu32 val;\n\n\talbm = ipu_channel_albm(ch->num);\n\tif (albm < 0)\n\t\treturn;\n\n\tipu_ch_param_write_field(ch, IPU_FIELD_ALU, 1);\n\tipu_ch_param_write_field(ch, IPU_FIELD_ALBM, albm);\n\tipu_ch_param_write_field(ch, IPU_FIELD_CRE, 1);\n\n\tval = ipu_idmac_read(ipu, IDMAC_SEP_ALPHA);\n\tval |= BIT(ch->num);\n\tipu_idmac_write(ipu, val, IDMAC_SEP_ALPHA);\n}\n\nint ipu_cpmem_set_fmt(struct ipuv3_channel *ch, u32 drm_fourcc)\n{\n\tswitch (drm_fourcc) {\n\tcase DRM_FORMAT_YUV420:\n\tcase DRM_FORMAT_YVU420:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 2);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_YUV422:\n\tcase DRM_FORMAT_YVU422:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 1);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_YUV444:\n\tcase DRM_FORMAT_YVU444:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 0);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_NV12:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 4);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_NV16:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 3);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_UYVY:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_BPP, 3);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 0xA);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_YUYV:\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_BPP, 3);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_PFS, 0x8);\n\t\t \n\t\tipu_ch_param_write_field(ch, IPU_FIELD_NPB, 31);\n\t\tbreak;\n\tcase DRM_FORMAT_ABGR8888:\n\tcase DRM_FORMAT_XBGR8888:\n\t\tipu_cpmem_set_format_rgb(ch, &def_xbgr_32);\n\t\tbreak;\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_XRGB8888:\n\t\tipu_cpmem_set_format_rgb(ch, &def_xrgb_32);\n\t\tbreak;\n\tcase DRM_FORMAT_RGBA8888:\n\tcase DRM_FORMAT_RGBX8888:\n\tcase DRM_FORMAT_RGBX8888_A8:\n\t\tipu_cpmem_set_format_rgb(ch, &def_rgbx_32);\n\t\tbreak;\n\tcase DRM_FORMAT_BGRA8888:\n\tcase DRM_FORMAT_BGRX8888:\n\tcase DRM_FORMAT_BGRX8888_A8:\n\t\tipu_cpmem_set_format_rgb(ch, &def_bgrx_32);\n\t\tbreak;\n\tcase DRM_FORMAT_BGR888:\n\tcase DRM_FORMAT_BGR888_A8:\n\t\tipu_cpmem_set_format_rgb(ch, &def_bgr_24);\n\t\tbreak;\n\tcase DRM_FORMAT_RGB888:\n\tcase DRM_FORMAT_RGB888_A8:\n\t\tipu_cpmem_set_format_rgb(ch, &def_rgb_24);\n\t\tbreak;\n\tcase DRM_FORMAT_RGB565:\n\tcase DRM_FORMAT_RGB565_A8:\n\t\tipu_cpmem_set_format_rgb(ch, &def_rgb_16);\n\t\tbreak;\n\tcase DRM_FORMAT_BGR565:\n\tcase DRM_FORMAT_BGR565_A8:\n\t\tipu_cpmem_set_format_rgb(ch, &def_bgr_16);\n\t\tbreak;\n\tcase DRM_FORMAT_ARGB1555:\n\t\tipu_cpmem_set_format_rgb(ch, &def_argb_16);\n\t\tbreak;\n\tcase DRM_FORMAT_ABGR1555:\n\t\tipu_cpmem_set_format_rgb(ch, &def_abgr_16);\n\t\tbreak;\n\tcase DRM_FORMAT_RGBA5551:\n\t\tipu_cpmem_set_format_rgb(ch, &def_rgba_16);\n\t\tbreak;\n\tcase DRM_FORMAT_BGRA5551:\n\t\tipu_cpmem_set_format_rgb(ch, &def_bgra_16);\n\t\tbreak;\n\tcase DRM_FORMAT_ARGB4444:\n\t\tipu_cpmem_set_format_rgb(ch, &def_argb_16_4444);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (drm_fourcc) {\n\tcase DRM_FORMAT_RGB565_A8:\n\tcase DRM_FORMAT_BGR565_A8:\n\tcase DRM_FORMAT_RGB888_A8:\n\tcase DRM_FORMAT_BGR888_A8:\n\tcase DRM_FORMAT_RGBX8888_A8:\n\tcase DRM_FORMAT_BGRX8888_A8:\n\t\tipu_ch_param_write_field(ch, IPU_FIELD_WID3, 7);\n\t\tipu_cpmem_set_separate_alpha(ch);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_fmt);\n\nint ipu_cpmem_set_image(struct ipuv3_channel *ch, struct ipu_image *image)\n{\n\tstruct v4l2_pix_format *pix = &image->pix;\n\tint offset, u_offset, v_offset;\n\tint ret = 0;\n\n\tpr_debug(\"%s: resolution: %dx%d stride: %d\\n\",\n\t\t __func__, pix->width, pix->height,\n\t\t pix->bytesperline);\n\n\tipu_cpmem_set_resolution(ch, image->rect.width, image->rect.height);\n\tipu_cpmem_set_stride(ch, pix->bytesperline);\n\n\tipu_cpmem_set_fmt(ch, v4l2_pix_fmt_to_drm_fourcc(pix->pixelformat));\n\n\tswitch (pix->pixelformat) {\n\tcase V4L2_PIX_FMT_YUV420:\n\t\toffset = Y_OFFSET(pix, image->rect.left, image->rect.top);\n\t\tu_offset = image->u_offset ?\n\t\t\timage->u_offset : U_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t   image->rect.top) - offset;\n\t\tv_offset = image->v_offset ?\n\t\t\timage->v_offset : V_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t   image->rect.top) - offset;\n\n\t\tipu_cpmem_set_yuv_planar_full(ch, pix->bytesperline / 2,\n\t\t\t\t\t      u_offset, v_offset);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_YVU420:\n\t\toffset = Y_OFFSET(pix, image->rect.left, image->rect.top);\n\t\tu_offset = image->u_offset ?\n\t\t\timage->u_offset : V_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t   image->rect.top) - offset;\n\t\tv_offset = image->v_offset ?\n\t\t\timage->v_offset : U_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t   image->rect.top) - offset;\n\n\t\tipu_cpmem_set_yuv_planar_full(ch, pix->bytesperline / 2,\n\t\t\t\t\t      u_offset, v_offset);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_YUV422P:\n\t\toffset = Y_OFFSET(pix, image->rect.left, image->rect.top);\n\t\tu_offset = image->u_offset ?\n\t\t\timage->u_offset : U2_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t    image->rect.top) - offset;\n\t\tv_offset = image->v_offset ?\n\t\t\timage->v_offset : V2_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t    image->rect.top) - offset;\n\n\t\tipu_cpmem_set_yuv_planar_full(ch, pix->bytesperline / 2,\n\t\t\t\t\t      u_offset, v_offset);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV12:\n\t\toffset = Y_OFFSET(pix, image->rect.left, image->rect.top);\n\t\tu_offset = image->u_offset ?\n\t\t\timage->u_offset : UV_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t    image->rect.top) - offset;\n\t\tv_offset = image->v_offset ? image->v_offset : 0;\n\n\t\tipu_cpmem_set_yuv_planar_full(ch, pix->bytesperline,\n\t\t\t\t\t      u_offset, v_offset);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV16:\n\t\toffset = Y_OFFSET(pix, image->rect.left, image->rect.top);\n\t\tu_offset = image->u_offset ?\n\t\t\timage->u_offset : UV2_OFFSET(pix, image->rect.left,\n\t\t\t\t\t\t     image->rect.top) - offset;\n\t\tv_offset = image->v_offset ? image->v_offset : 0;\n\n\t\tipu_cpmem_set_yuv_planar_full(ch, pix->bytesperline,\n\t\t\t\t\t      u_offset, v_offset);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_UYVY:\n\tcase V4L2_PIX_FMT_YUYV:\n\tcase V4L2_PIX_FMT_RGB565:\n\t\toffset = image->rect.left * 2 +\n\t\t\timage->rect.top * pix->bytesperline;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_RGB32:\n\tcase V4L2_PIX_FMT_BGR32:\n\tcase V4L2_PIX_FMT_ABGR32:\n\tcase V4L2_PIX_FMT_XBGR32:\n\tcase V4L2_PIX_FMT_BGRA32:\n\tcase V4L2_PIX_FMT_BGRX32:\n\tcase V4L2_PIX_FMT_RGBA32:\n\tcase V4L2_PIX_FMT_RGBX32:\n\tcase V4L2_PIX_FMT_ARGB32:\n\tcase V4L2_PIX_FMT_XRGB32:\n\t\toffset = image->rect.left * 4 +\n\t\t\timage->rect.top * pix->bytesperline;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_RGB24:\n\tcase V4L2_PIX_FMT_BGR24:\n\t\toffset = image->rect.left * 3 +\n\t\t\timage->rect.top * pix->bytesperline;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_SBGGR8:\n\tcase V4L2_PIX_FMT_SGBRG8:\n\tcase V4L2_PIX_FMT_SGRBG8:\n\tcase V4L2_PIX_FMT_SRGGB8:\n\tcase V4L2_PIX_FMT_GREY:\n\t\toffset = image->rect.left + image->rect.top * pix->bytesperline;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_SBGGR16:\n\tcase V4L2_PIX_FMT_SGBRG16:\n\tcase V4L2_PIX_FMT_SGRBG16:\n\tcase V4L2_PIX_FMT_SRGGB16:\n\tcase V4L2_PIX_FMT_Y16:\n\t\toffset = image->rect.left * 2 +\n\t\t\t image->rect.top * pix->bytesperline;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tWARN_ON(1);\n\t\toffset = 0;\n\t\tret = -EINVAL;\n\t}\n\n\tipu_cpmem_set_buffer(ch, 0, image->phys0 + offset);\n\tipu_cpmem_set_buffer(ch, 1, image->phys1 + offset);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_set_image);\n\nvoid ipu_cpmem_dump(struct ipuv3_channel *ch)\n{\n\tstruct ipu_ch_param __iomem *p = ipu_get_cpmem(ch);\n\tstruct ipu_soc *ipu = ch->ipu;\n\tint chno = ch->num;\n\n\tdev_dbg(ipu->dev, \"ch %d word 0 - %08X %08X %08X %08X %08X\\n\", chno,\n\t\treadl(&p->word[0].data[0]),\n\t\treadl(&p->word[0].data[1]),\n\t\treadl(&p->word[0].data[2]),\n\t\treadl(&p->word[0].data[3]),\n\t\treadl(&p->word[0].data[4]));\n\tdev_dbg(ipu->dev, \"ch %d word 1 - %08X %08X %08X %08X %08X\\n\", chno,\n\t\treadl(&p->word[1].data[0]),\n\t\treadl(&p->word[1].data[1]),\n\t\treadl(&p->word[1].data[2]),\n\t\treadl(&p->word[1].data[3]),\n\t\treadl(&p->word[1].data[4]));\n\tdev_dbg(ipu->dev, \"PFS 0x%x, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_PFS));\n\tdev_dbg(ipu->dev, \"BPP 0x%x, \",\n\t\tipu_ch_param_read_field(ch, IPU_FIELD_BPP));\n\tdev_dbg(ipu->dev, \"NPB 0x%x\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_NPB));\n\n\tdev_dbg(ipu->dev, \"FW %d, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_FW));\n\tdev_dbg(ipu->dev, \"FH %d, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_FH));\n\tdev_dbg(ipu->dev, \"EBA0 0x%x\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_EBA0) << 3);\n\tdev_dbg(ipu->dev, \"EBA1 0x%x\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_EBA1) << 3);\n\tdev_dbg(ipu->dev, \"Stride %d\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_SL));\n\tdev_dbg(ipu->dev, \"scan_order %d\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_SO));\n\tdev_dbg(ipu->dev, \"uv_stride %d\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_SLUV));\n\tdev_dbg(ipu->dev, \"u_offset 0x%x\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_UBO) << 3);\n\tdev_dbg(ipu->dev, \"v_offset 0x%x\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_VBO) << 3);\n\n\tdev_dbg(ipu->dev, \"Width0 %d+1, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_WID0));\n\tdev_dbg(ipu->dev, \"Width1 %d+1, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_WID1));\n\tdev_dbg(ipu->dev, \"Width2 %d+1, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_WID2));\n\tdev_dbg(ipu->dev, \"Width3 %d+1, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_WID3));\n\tdev_dbg(ipu->dev, \"Offset0 %d, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_OFS0));\n\tdev_dbg(ipu->dev, \"Offset1 %d, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_OFS1));\n\tdev_dbg(ipu->dev, \"Offset2 %d, \",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_OFS2));\n\tdev_dbg(ipu->dev, \"Offset3 %d\\n\",\n\t\t ipu_ch_param_read_field(ch, IPU_FIELD_OFS3));\n}\nEXPORT_SYMBOL_GPL(ipu_cpmem_dump);\n\nint ipu_cpmem_init(struct ipu_soc *ipu, struct device *dev, unsigned long base)\n{\n\tstruct ipu_cpmem *cpmem;\n\n\tcpmem = devm_kzalloc(dev, sizeof(*cpmem), GFP_KERNEL);\n\tif (!cpmem)\n\t\treturn -ENOMEM;\n\n\tipu->cpmem_priv = cpmem;\n\n\tspin_lock_init(&cpmem->lock);\n\tcpmem->base = devm_ioremap(dev, base, SZ_128K);\n\tif (!cpmem->base)\n\t\treturn -ENOMEM;\n\n\tdev_dbg(dev, \"CPMEM base: 0x%08lx remapped to %p\\n\",\n\t\tbase, cpmem->base);\n\tcpmem->ipu = ipu;\n\n\treturn 0;\n}\n\nvoid ipu_cpmem_exit(struct ipu_soc *ipu)\n{\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}