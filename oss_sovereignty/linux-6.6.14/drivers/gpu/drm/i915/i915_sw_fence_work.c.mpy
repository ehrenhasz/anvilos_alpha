{
  "module_name": "i915_sw_fence_work.c",
  "hash_id": "955f7fdfa71540cb06b20701498d91670d2b6d910d1fb38ba2d2b481555a53d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/i915_sw_fence_work.c",
  "human_readable_source": "\n\n \n\n#include \"i915_sw_fence_work.h\"\n\nstatic void fence_complete(struct dma_fence_work *f)\n{\n\tif (f->ops->release)\n\t\tf->ops->release(f);\n\tdma_fence_signal(&f->dma);\n}\n\nstatic void fence_work(struct work_struct *work)\n{\n\tstruct dma_fence_work *f = container_of(work, typeof(*f), work);\n\n\tf->ops->work(f);\n\n\tfence_complete(f);\n\tdma_fence_put(&f->dma);\n}\n\nstatic int\nfence_notify(struct i915_sw_fence *fence, enum i915_sw_fence_notify state)\n{\n\tstruct dma_fence_work *f = container_of(fence, typeof(*f), chain);\n\n\tswitch (state) {\n\tcase FENCE_COMPLETE:\n\t\tif (fence->error)\n\t\t\tdma_fence_set_error(&f->dma, fence->error);\n\n\t\tif (!f->dma.error) {\n\t\t\tdma_fence_get(&f->dma);\n\t\t\tif (test_bit(DMA_FENCE_WORK_IMM, &f->dma.flags))\n\t\t\t\tfence_work(&f->work);\n\t\t\telse\n\t\t\t\tqueue_work(system_unbound_wq, &f->work);\n\t\t} else {\n\t\t\tfence_complete(f);\n\t\t}\n\t\tbreak;\n\n\tcase FENCE_FREE:\n\t\tdma_fence_put(&f->dma);\n\t\tbreak;\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstatic const char *get_driver_name(struct dma_fence *fence)\n{\n\treturn \"dma-fence\";\n}\n\nstatic const char *get_timeline_name(struct dma_fence *fence)\n{\n\tstruct dma_fence_work *f = container_of(fence, typeof(*f), dma);\n\n\treturn f->ops->name ?: \"work\";\n}\n\nstatic void fence_release(struct dma_fence *fence)\n{\n\tstruct dma_fence_work *f = container_of(fence, typeof(*f), dma);\n\n\ti915_sw_fence_fini(&f->chain);\n\n\tBUILD_BUG_ON(offsetof(typeof(*f), dma));\n\tdma_fence_free(&f->dma);\n}\n\nstatic const struct dma_fence_ops fence_ops = {\n\t.get_driver_name = get_driver_name,\n\t.get_timeline_name = get_timeline_name,\n\t.release = fence_release,\n};\n\nvoid dma_fence_work_init(struct dma_fence_work *f,\n\t\t\t const struct dma_fence_work_ops *ops)\n{\n\tf->ops = ops;\n\tspin_lock_init(&f->lock);\n\tdma_fence_init(&f->dma, &fence_ops, &f->lock, 0, 0);\n\ti915_sw_fence_init(&f->chain, fence_notify);\n\tINIT_WORK(&f->work, fence_work);\n}\n\nint dma_fence_work_chain(struct dma_fence_work *f, struct dma_fence *signal)\n{\n\tif (!signal)\n\t\treturn 0;\n\n\treturn __i915_sw_fence_await_dma_fence(&f->chain, signal, &f->cb);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}