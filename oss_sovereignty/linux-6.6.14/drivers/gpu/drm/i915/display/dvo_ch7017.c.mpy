{
  "module_name": "dvo_ch7017.c",
  "hash_id": "32e1403032bcb4ea04ab26514e195d0b947374ddaee84044472601d46549e1f5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/dvo_ch7017.c",
  "human_readable_source": " \n\n#include \"intel_display_types.h\"\n#include \"intel_dvo_dev.h\"\n\n#define CH7017_TV_DISPLAY_MODE\t\t0x00\n#define CH7017_FLICKER_FILTER\t\t0x01\n#define CH7017_VIDEO_BANDWIDTH\t\t0x02\n#define CH7017_TEXT_ENHANCEMENT\t\t0x03\n#define CH7017_START_ACTIVE_VIDEO\t0x04\n#define CH7017_HORIZONTAL_POSITION\t0x05\n#define CH7017_VERTICAL_POSITION\t0x06\n#define CH7017_BLACK_LEVEL\t\t0x07\n#define CH7017_CONTRAST_ENHANCEMENT\t0x08\n#define CH7017_TV_PLL\t\t\t0x09\n#define CH7017_TV_PLL_M\t\t\t0x0a\n#define CH7017_TV_PLL_N\t\t\t0x0b\n#define CH7017_SUB_CARRIER_0\t\t0x0c\n#define CH7017_CIV_CONTROL\t\t0x10\n#define CH7017_CIV_0\t\t\t0x11\n#define CH7017_CHROMA_BOOST\t\t0x14\n#define CH7017_CLOCK_MODE\t\t0x1c\n#define CH7017_INPUT_CLOCK\t\t0x1d\n#define CH7017_GPIO_CONTROL\t\t0x1e\n#define CH7017_INPUT_DATA_FORMAT\t0x1f\n#define CH7017_CONNECTION_DETECT\t0x20\n#define CH7017_DAC_CONTROL\t\t0x21\n#define CH7017_BUFFERED_CLOCK_OUTPUT\t0x22\n#define CH7017_DEFEAT_VSYNC\t\t0x47\n#define CH7017_TEST_PATTERN\t\t0x48\n\n#define CH7017_POWER_MANAGEMENT\t\t0x49\n \n#define CH7017_TV_EN\t\t\t(1 << 0)\n#define CH7017_DAC0_POWER_DOWN\t\t(1 << 1)\n#define CH7017_DAC1_POWER_DOWN\t\t(1 << 2)\n#define CH7017_DAC2_POWER_DOWN\t\t(1 << 3)\n#define CH7017_DAC3_POWER_DOWN\t\t(1 << 4)\n \n#define CH7017_TV_POWER_DOWN_EN\t\t(1 << 5)\n\n#define CH7017_VERSION_ID\t\t0x4a\n\n#define CH7017_DEVICE_ID\t\t0x4b\n#define CH7017_DEVICE_ID_VALUE\t\t0x1b\n#define CH7018_DEVICE_ID_VALUE\t\t0x1a\n#define CH7019_DEVICE_ID_VALUE\t\t0x19\n\n#define CH7017_XCLK_D2_ADJUST\t\t0x53\n#define CH7017_UP_SCALER_COEFF_0\t0x55\n#define CH7017_UP_SCALER_COEFF_1\t0x56\n#define CH7017_UP_SCALER_COEFF_2\t0x57\n#define CH7017_UP_SCALER_COEFF_3\t0x58\n#define CH7017_UP_SCALER_COEFF_4\t0x59\n#define CH7017_UP_SCALER_VERTICAL_INC_0\t0x5a\n#define CH7017_UP_SCALER_VERTICAL_INC_1\t0x5b\n#define CH7017_GPIO_INVERT\t\t0x5c\n#define CH7017_UP_SCALER_HORIZONTAL_INC_0\t0x5d\n#define CH7017_UP_SCALER_HORIZONTAL_INC_1\t0x5e\n\n#define CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT\t0x5f\n \n\n#define CH7017_ACTIVE_INPUT_LINE_OUTPUT\t0x60\n \n#define CH7017_LVDS_HAP_INPUT_MASK\t(0x7 << 0)\n \n#define CH7017_LVDS_VAL_HIGH_MASK\t(0x7 << 3)\n\n#define CH7017_VERTICAL_ACTIVE_LINE_OUTPUT\t0x61\n \n\n#define CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT\t0x62\n \n\n#define CH7017_LVDS_POWER_DOWN\t\t0x63\n \n#define CH7017_LVDS_HAP_HIGH_MASK\t(0x7 << 0)\n \n#define CH7017_LVDS_POWER_DOWN_EN\t(1 << 6)\n \n#define CH7017_LVDS_UPSCALER_EN\t\t(1 << 7)\n#define CH7017_LVDS_POWER_DOWN_DEFAULT_RESERVED 0x08\n\n#define CH7017_LVDS_ENCODING\t\t0x64\n#define CH7017_LVDS_DITHER_2D\t\t(1 << 2)\n#define CH7017_LVDS_DITHER_DIS\t\t(1 << 3)\n#define CH7017_LVDS_DUAL_CHANNEL_EN\t(1 << 4)\n#define CH7017_LVDS_24_BIT\t\t(1 << 5)\n\n#define CH7017_LVDS_ENCODING_2\t\t0x65\n\n#define CH7017_LVDS_PLL_CONTROL\t\t0x66\n \n#define CH7017_LVDS_PANEN\t\t(1 << 0)\n \n#define CH7017_LVDS_BKLEN\t\t(1 << 3)\n\n#define CH7017_POWER_SEQUENCING_T1\t0x67\n#define CH7017_POWER_SEQUENCING_T2\t0x68\n#define CH7017_POWER_SEQUENCING_T3\t0x69\n#define CH7017_POWER_SEQUENCING_T4\t0x6a\n#define CH7017_POWER_SEQUENCING_T5\t0x6b\n#define CH7017_GPIO_DRIVER_TYPE\t\t0x6c\n#define CH7017_GPIO_DATA\t\t0x6d\n#define CH7017_GPIO_DIRECTION_CONTROL\t0x6e\n\n#define CH7017_LVDS_PLL_FEEDBACK_DIV\t0x71\n# define CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT 4\n# define CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT 0\n# define CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED 0x80\n\n#define CH7017_LVDS_PLL_VCO_CONTROL\t0x72\n# define CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED 0x80\n# define CH7017_LVDS_PLL_VCO_SHIFT\t4\n# define CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT 0\n\n#define CH7017_OUTPUTS_ENABLE\t\t0x73\n# define CH7017_CHARGE_PUMP_LOW\t\t0x0\n# define CH7017_CHARGE_PUMP_HIGH\t0x3\n# define CH7017_LVDS_CHANNEL_A\t\t(1 << 3)\n# define CH7017_LVDS_CHANNEL_B\t\t(1 << 4)\n# define CH7017_TV_DAC_A\t\t(1 << 5)\n# define CH7017_TV_DAC_B\t\t(1 << 6)\n# define CH7017_DDC_SELECT_DC2\t\t(1 << 7)\n\n#define CH7017_LVDS_OUTPUT_AMPLITUDE\t0x74\n#define CH7017_LVDS_PLL_EMI_REDUCTION\t0x75\n#define CH7017_LVDS_POWER_DOWN_FLICKER\t0x76\n\n#define CH7017_LVDS_CONTROL_2\t\t0x78\n# define CH7017_LOOP_FILTER_SHIFT\t5\n# define CH7017_PHASE_DETECTOR_SHIFT\t0\n\n#define CH7017_BANG_LIMIT_CONTROL\t0x7f\n\nstruct ch7017_priv {\n\tu8 dummy;\n};\n\nstatic void ch7017_dump_regs(struct intel_dvo_device *dvo);\nstatic void ch7017_dpms(struct intel_dvo_device *dvo, bool enable);\n\nstatic bool ch7017_read(struct intel_dvo_device *dvo, u8 addr, u8 *val)\n{\n\tstruct i2c_msg msgs[] = {\n\t\t{\n\t\t\t.addr = dvo->slave_addr,\n\t\t\t.flags = 0,\n\t\t\t.len = 1,\n\t\t\t.buf = &addr,\n\t\t},\n\t\t{\n\t\t\t.addr = dvo->slave_addr,\n\t\t\t.flags = I2C_M_RD,\n\t\t\t.len = 1,\n\t\t\t.buf = val,\n\t\t}\n\t};\n\treturn i2c_transfer(dvo->i2c_bus, msgs, 2) == 2;\n}\n\nstatic bool ch7017_write(struct intel_dvo_device *dvo, u8 addr, u8 val)\n{\n\tu8 buf[2] = { addr, val };\n\tstruct i2c_msg msg = {\n\t\t.addr = dvo->slave_addr,\n\t\t.flags = 0,\n\t\t.len = 2,\n\t\t.buf = buf,\n\t};\n\treturn i2c_transfer(dvo->i2c_bus, &msg, 1) == 1;\n}\n\n \nstatic bool ch7017_init(struct intel_dvo_device *dvo,\n\t\t\tstruct i2c_adapter *adapter)\n{\n\tstruct ch7017_priv *priv;\n\tconst char *str;\n\tu8 val;\n\n\tpriv = kzalloc(sizeof(struct ch7017_priv), GFP_KERNEL);\n\tif (priv == NULL)\n\t\treturn false;\n\n\tdvo->i2c_bus = adapter;\n\tdvo->dev_priv = priv;\n\n\tif (!ch7017_read(dvo, CH7017_DEVICE_ID, &val))\n\t\tgoto fail;\n\n\tswitch (val) {\n\tcase CH7017_DEVICE_ID_VALUE:\n\t\tstr = \"ch7017\";\n\t\tbreak;\n\tcase CH7018_DEVICE_ID_VALUE:\n\t\tstr = \"ch7018\";\n\t\tbreak;\n\tcase CH7019_DEVICE_ID_VALUE:\n\t\tstr = \"ch7019\";\n\t\tbreak;\n\tdefault:\n\t\tDRM_DEBUG_KMS(\"ch701x not detected, got %d: from %s \"\n\t\t\t      \"slave %d.\\n\",\n\t\t\t      val, adapter->name, dvo->slave_addr);\n\t\tgoto fail;\n\t}\n\n\tDRM_DEBUG_KMS(\"%s detected on %s, addr %d\\n\",\n\t\t      str, adapter->name, dvo->slave_addr);\n\treturn true;\n\nfail:\n\tkfree(priv);\n\treturn false;\n}\n\nstatic enum drm_connector_status ch7017_detect(struct intel_dvo_device *dvo)\n{\n\treturn connector_status_connected;\n}\n\nstatic enum drm_mode_status ch7017_mode_valid(struct intel_dvo_device *dvo,\n\t\t\t\t\t      struct drm_display_mode *mode)\n{\n\tif (mode->clock > 160000)\n\t\treturn MODE_CLOCK_HIGH;\n\n\treturn MODE_OK;\n}\n\nstatic void ch7017_mode_set(struct intel_dvo_device *dvo,\n\t\t\t    const struct drm_display_mode *mode,\n\t\t\t    const struct drm_display_mode *adjusted_mode)\n{\n\tu8 lvds_pll_feedback_div, lvds_pll_vco_control;\n\tu8 outputs_enable, lvds_control_2, lvds_power_down;\n\tu8 horizontal_active_pixel_input;\n\tu8 horizontal_active_pixel_output, vertical_active_line_output;\n\tu8 active_input_line_output;\n\n\tDRM_DEBUG_KMS(\"Registers before mode setting\\n\");\n\tch7017_dump_regs(dvo);\n\n\t \n\tif (mode->clock < 100000) {\n\t\toutputs_enable = CH7017_LVDS_CHANNEL_A | CH7017_CHARGE_PUMP_LOW;\n\t\tlvds_pll_feedback_div = CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED |\n\t\t\t(2 << CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT) |\n\t\t\t(13 << CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT);\n\t\tlvds_pll_vco_control = CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED |\n\t\t\t(2 << CH7017_LVDS_PLL_VCO_SHIFT) |\n\t\t\t(3 << CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT);\n\t\tlvds_control_2 = (1 << CH7017_LOOP_FILTER_SHIFT) |\n\t\t\t(0 << CH7017_PHASE_DETECTOR_SHIFT);\n\t} else {\n\t\toutputs_enable = CH7017_LVDS_CHANNEL_A | CH7017_CHARGE_PUMP_HIGH;\n\t\tlvds_pll_feedback_div =\n\t\t\tCH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED |\n\t\t\t(2 << CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT) |\n\t\t\t(3 << CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT);\n\t\tlvds_control_2 = (3 << CH7017_LOOP_FILTER_SHIFT) |\n\t\t\t(0 << CH7017_PHASE_DETECTOR_SHIFT);\n\t\tif (1) {  \n\t\t\toutputs_enable |= CH7017_LVDS_CHANNEL_B;\n\t\t\tlvds_pll_vco_control = CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED |\n\t\t\t\t(2 << CH7017_LVDS_PLL_VCO_SHIFT) |\n\t\t\t\t(13 << CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT);\n\t\t} else {\n\t\t\tlvds_pll_vco_control = CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED |\n\t\t\t\t(1 << CH7017_LVDS_PLL_VCO_SHIFT) |\n\t\t\t\t(13 << CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT);\n\t\t}\n\t}\n\n\thorizontal_active_pixel_input = mode->hdisplay & 0x00ff;\n\n\tvertical_active_line_output = mode->vdisplay & 0x00ff;\n\thorizontal_active_pixel_output = mode->hdisplay & 0x00ff;\n\n\tactive_input_line_output = ((mode->hdisplay & 0x0700) >> 8) |\n\t\t\t\t   (((mode->vdisplay & 0x0700) >> 8) << 3);\n\n\tlvds_power_down = CH7017_LVDS_POWER_DOWN_DEFAULT_RESERVED |\n\t\t\t  (mode->hdisplay & 0x0700) >> 8;\n\n\tch7017_dpms(dvo, false);\n\tch7017_write(dvo, CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT,\n\t\t\thorizontal_active_pixel_input);\n\tch7017_write(dvo, CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT,\n\t\t\thorizontal_active_pixel_output);\n\tch7017_write(dvo, CH7017_VERTICAL_ACTIVE_LINE_OUTPUT,\n\t\t\tvertical_active_line_output);\n\tch7017_write(dvo, CH7017_ACTIVE_INPUT_LINE_OUTPUT,\n\t\t\tactive_input_line_output);\n\tch7017_write(dvo, CH7017_LVDS_PLL_VCO_CONTROL, lvds_pll_vco_control);\n\tch7017_write(dvo, CH7017_LVDS_PLL_FEEDBACK_DIV, lvds_pll_feedback_div);\n\tch7017_write(dvo, CH7017_LVDS_CONTROL_2, lvds_control_2);\n\tch7017_write(dvo, CH7017_OUTPUTS_ENABLE, outputs_enable);\n\n\t \n\tch7017_write(dvo, CH7017_LVDS_POWER_DOWN, lvds_power_down);\n\n\tDRM_DEBUG_KMS(\"Registers after mode setting\\n\");\n\tch7017_dump_regs(dvo);\n}\n\n \nstatic void ch7017_dpms(struct intel_dvo_device *dvo, bool enable)\n{\n\tu8 val;\n\n\tch7017_read(dvo, CH7017_LVDS_POWER_DOWN, &val);\n\n\t \n\tch7017_write(dvo, CH7017_POWER_MANAGEMENT,\n\t\t\tCH7017_DAC0_POWER_DOWN |\n\t\t\tCH7017_DAC1_POWER_DOWN |\n\t\t\tCH7017_DAC2_POWER_DOWN |\n\t\t\tCH7017_DAC3_POWER_DOWN |\n\t\t\tCH7017_TV_POWER_DOWN_EN);\n\n\tif (enable) {\n\t\t \n\t\tch7017_write(dvo, CH7017_LVDS_POWER_DOWN,\n\t\t\t     val & ~CH7017_LVDS_POWER_DOWN_EN);\n\t} else {\n\t\t \n\t\tch7017_write(dvo, CH7017_LVDS_POWER_DOWN,\n\t\t\t     val | CH7017_LVDS_POWER_DOWN_EN);\n\t}\n\n\t \n\tmsleep(20);\n}\n\nstatic bool ch7017_get_hw_state(struct intel_dvo_device *dvo)\n{\n\tu8 val;\n\n\tch7017_read(dvo, CH7017_LVDS_POWER_DOWN, &val);\n\n\tif (val & CH7017_LVDS_POWER_DOWN_EN)\n\t\treturn false;\n\telse\n\t\treturn true;\n}\n\nstatic void ch7017_dump_regs(struct intel_dvo_device *dvo)\n{\n\tu8 val;\n\n#define DUMP(reg)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\\\n\tch7017_read(dvo, reg, &val);\t\t\t\\\n\tDRM_DEBUG_KMS(#reg \": %02x\\n\", val);\t\t\\\n} while (0)\n\n\tDUMP(CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT);\n\tDUMP(CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT);\n\tDUMP(CH7017_VERTICAL_ACTIVE_LINE_OUTPUT);\n\tDUMP(CH7017_ACTIVE_INPUT_LINE_OUTPUT);\n\tDUMP(CH7017_LVDS_PLL_VCO_CONTROL);\n\tDUMP(CH7017_LVDS_PLL_FEEDBACK_DIV);\n\tDUMP(CH7017_LVDS_CONTROL_2);\n\tDUMP(CH7017_OUTPUTS_ENABLE);\n\tDUMP(CH7017_LVDS_POWER_DOWN);\n}\n\nstatic void ch7017_destroy(struct intel_dvo_device *dvo)\n{\n\tstruct ch7017_priv *priv = dvo->dev_priv;\n\n\tif (priv) {\n\t\tkfree(priv);\n\t\tdvo->dev_priv = NULL;\n\t}\n}\n\nconst struct intel_dvo_dev_ops ch7017_ops = {\n\t.init = ch7017_init,\n\t.detect = ch7017_detect,\n\t.mode_valid = ch7017_mode_valid,\n\t.mode_set = ch7017_mode_set,\n\t.dpms = ch7017_dpms,\n\t.get_hw_state = ch7017_get_hw_state,\n\t.dump_regs = ch7017_dump_regs,\n\t.destroy = ch7017_destroy,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}