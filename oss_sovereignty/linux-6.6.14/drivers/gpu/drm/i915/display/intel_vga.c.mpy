{
  "module_name": "intel_vga.c",
  "hash_id": "20cf7405515c4a8ac93f1b70979ffc7262527740e635f1f67f62b51beebc8f6a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_vga.c",
  "human_readable_source": "\n \n\n#include <linux/pci.h>\n#include <linux/vgaarb.h>\n\n#include <video/vga.h>\n\n#include \"soc/intel_gmch.h\"\n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_de.h\"\n#include \"intel_vga.h\"\n\nstatic i915_reg_t intel_vga_cntrl_reg(struct drm_i915_private *i915)\n{\n\tif (IS_VALLEYVIEW(i915) || IS_CHERRYVIEW(i915))\n\t\treturn VLV_VGACNTRL;\n\telse if (DISPLAY_VER(i915) >= 5)\n\t\treturn CPU_VGACNTRL;\n\telse\n\t\treturn VGACNTRL;\n}\n\n \nvoid intel_vga_disable(struct drm_i915_private *dev_priv)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev_priv->drm.dev);\n\ti915_reg_t vga_reg = intel_vga_cntrl_reg(dev_priv);\n\tu8 sr1;\n\n\tif (intel_de_read(dev_priv, vga_reg) & VGA_DISP_DISABLE)\n\t\treturn;\n\n\t \n\tvga_get_uninterruptible(pdev, VGA_RSRC_LEGACY_IO);\n\toutb(0x01, VGA_SEQ_I);\n\tsr1 = inb(VGA_SEQ_D);\n\toutb(sr1 | VGA_SR01_SCREEN_OFF, VGA_SEQ_D);\n\tvga_put(pdev, VGA_RSRC_LEGACY_IO);\n\tudelay(300);\n\n\tintel_de_write(dev_priv, vga_reg, VGA_DISP_DISABLE);\n\tintel_de_posting_read(dev_priv, vga_reg);\n}\n\nvoid intel_vga_redisable_power_on(struct drm_i915_private *dev_priv)\n{\n\ti915_reg_t vga_reg = intel_vga_cntrl_reg(dev_priv);\n\n\tif (!(intel_de_read(dev_priv, vga_reg) & VGA_DISP_DISABLE)) {\n\t\tdrm_dbg_kms(&dev_priv->drm,\n\t\t\t    \"Something enabled VGA plane, disabling it\\n\");\n\t\tintel_vga_disable(dev_priv);\n\t}\n}\n\nvoid intel_vga_redisable(struct drm_i915_private *i915)\n{\n\tintel_wakeref_t wakeref;\n\n\t \n\twakeref = intel_display_power_get_if_enabled(i915, POWER_DOMAIN_VGA);\n\tif (!wakeref)\n\t\treturn;\n\n\tintel_vga_redisable_power_on(i915);\n\n\tintel_display_power_put(i915, POWER_DOMAIN_VGA, wakeref);\n}\n\nvoid intel_vga_reset_io_mem(struct drm_i915_private *i915)\n{\n\tstruct pci_dev *pdev = to_pci_dev(i915->drm.dev);\n\n\t \n\tvga_get_uninterruptible(pdev, VGA_RSRC_LEGACY_IO);\n\toutb(inb(VGA_MIS_R), VGA_MIS_W);\n\tvga_put(pdev, VGA_RSRC_LEGACY_IO);\n}\n\nstatic unsigned int\nintel_vga_set_decode(struct pci_dev *pdev, bool enable_decode)\n{\n\tstruct drm_i915_private *i915 = pdev_to_i915(pdev);\n\n\tintel_gmch_vga_set_state(i915, enable_decode);\n\n\tif (enable_decode)\n\t\treturn VGA_RSRC_LEGACY_IO | VGA_RSRC_LEGACY_MEM |\n\t\t       VGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM;\n\telse\n\t\treturn VGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM;\n}\n\nint intel_vga_register(struct drm_i915_private *i915)\n{\n\n\tstruct pci_dev *pdev = to_pci_dev(i915->drm.dev);\n\tint ret;\n\n\t \n\tret = vga_client_register(pdev, intel_vga_set_decode);\n\tif (ret && ret != -ENODEV)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nvoid intel_vga_unregister(struct drm_i915_private *i915)\n{\n\tstruct pci_dev *pdev = to_pci_dev(i915->drm.dev);\n\n\tvga_client_unregister(pdev);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}