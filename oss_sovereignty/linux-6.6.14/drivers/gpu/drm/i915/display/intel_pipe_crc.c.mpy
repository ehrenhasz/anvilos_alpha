{
  "module_name": "intel_pipe_crc.c",
  "hash_id": "bbccae5087b55b1861633047f46ceb4a748eef9b7c009783e7ef2d3d5a6d3e43",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_pipe_crc.c",
  "human_readable_source": " \n\n#include <linux/ctype.h>\n#include <linux/debugfs.h>\n#include <linux/seq_file.h>\n\n#include \"i915_irq.h\"\n#include \"i915_reg.h\"\n#include \"intel_atomic.h\"\n#include \"intel_de.h\"\n#include \"intel_display_types.h\"\n#include \"intel_pipe_crc.h\"\n\nstatic const char * const pipe_crc_sources[] = {\n\t[INTEL_PIPE_CRC_SOURCE_NONE] = \"none\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE1] = \"plane1\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE2] = \"plane2\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE3] = \"plane3\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE4] = \"plane4\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE5] = \"plane5\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE6] = \"plane6\",\n\t[INTEL_PIPE_CRC_SOURCE_PLANE7] = \"plane7\",\n\t[INTEL_PIPE_CRC_SOURCE_PIPE] = \"pipe\",\n\t[INTEL_PIPE_CRC_SOURCE_TV] = \"TV\",\n\t[INTEL_PIPE_CRC_SOURCE_DP_B] = \"DP-B\",\n\t[INTEL_PIPE_CRC_SOURCE_DP_C] = \"DP-C\",\n\t[INTEL_PIPE_CRC_SOURCE_DP_D] = \"DP-D\",\n\t[INTEL_PIPE_CRC_SOURCE_AUTO] = \"auto\",\n};\n\nstatic int i8xx_pipe_crc_ctl_reg(enum intel_pipe_crc_source *source,\n\t\t\t\t u32 *val)\n{\n\tif (*source == INTEL_PIPE_CRC_SOURCE_AUTO)\n\t\t*source = INTEL_PIPE_CRC_SOURCE_PIPE;\n\n\tswitch (*source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_INCLUDE_BORDER_I8XX;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\t*val = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void i9xx_pipe_crc_auto_source(struct drm_i915_private *dev_priv,\n\t\t\t\t      enum pipe pipe,\n\t\t\t\t      enum intel_pipe_crc_source *source)\n{\n\tstruct intel_encoder *encoder;\n\tstruct intel_crtc *crtc;\n\tstruct intel_digital_port *dig_port;\n\n\t*source = INTEL_PIPE_CRC_SOURCE_PIPE;\n\n\tdrm_modeset_lock_all(&dev_priv->drm);\n\tfor_each_intel_encoder(&dev_priv->drm, encoder) {\n\t\tif (!encoder->base.crtc)\n\t\t\tcontinue;\n\n\t\tcrtc = to_intel_crtc(encoder->base.crtc);\n\n\t\tif (crtc->pipe != pipe)\n\t\t\tcontinue;\n\n\t\tswitch (encoder->type) {\n\t\tcase INTEL_OUTPUT_TVOUT:\n\t\t\t*source = INTEL_PIPE_CRC_SOURCE_TV;\n\t\t\tbreak;\n\t\tcase INTEL_OUTPUT_DP:\n\t\tcase INTEL_OUTPUT_EDP:\n\t\t\tdig_port = enc_to_dig_port(encoder);\n\t\t\tswitch (dig_port->base.port) {\n\t\t\tcase PORT_B:\n\t\t\t\t*source = INTEL_PIPE_CRC_SOURCE_DP_B;\n\t\t\t\tbreak;\n\t\t\tcase PORT_C:\n\t\t\t\t*source = INTEL_PIPE_CRC_SOURCE_DP_C;\n\t\t\t\tbreak;\n\t\t\tcase PORT_D:\n\t\t\t\t*source = INTEL_PIPE_CRC_SOURCE_DP_D;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdrm_WARN(&dev_priv->drm, 1, \"nonexisting DP port %c\\n\",\n\t\t\t\t\t port_name(dig_port->base.port));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\tdrm_modeset_unlock_all(&dev_priv->drm);\n}\n\nstatic int vlv_pipe_crc_ctl_reg(struct drm_i915_private *dev_priv,\n\t\t\t\tenum pipe pipe,\n\t\t\t\tenum intel_pipe_crc_source *source,\n\t\t\t\tu32 *val)\n{\n\tbool need_stable_symbols = false;\n\n\tif (*source == INTEL_PIPE_CRC_SOURCE_AUTO)\n\t\ti9xx_pipe_crc_auto_source(dev_priv, pipe, source);\n\n\tswitch (*source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PIPE_VLV;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_DP_B:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_DP_B_VLV;\n\t\tneed_stable_symbols = true;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_DP_C:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_DP_C_VLV;\n\t\tneed_stable_symbols = true;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_DP_D:\n\t\tif (!IS_CHERRYVIEW(dev_priv))\n\t\t\treturn -EINVAL;\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_DP_D_VLV;\n\t\tneed_stable_symbols = true;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\t*val = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (need_stable_symbols) {\n\t\tu32 tmp = intel_de_read(dev_priv, PORT_DFT2_G4X);\n\n\t\ttmp |= DC_BALANCE_RESET_VLV;\n\t\tswitch (pipe) {\n\t\tcase PIPE_A:\n\t\t\ttmp |= PIPE_A_SCRAMBLE_RESET;\n\t\t\tbreak;\n\t\tcase PIPE_B:\n\t\t\ttmp |= PIPE_B_SCRAMBLE_RESET;\n\t\t\tbreak;\n\t\tcase PIPE_C:\n\t\t\ttmp |= PIPE_C_SCRAMBLE_RESET;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tintel_de_write(dev_priv, PORT_DFT2_G4X, tmp);\n\t}\n\n\treturn 0;\n}\n\nstatic int i9xx_pipe_crc_ctl_reg(struct drm_i915_private *dev_priv,\n\t\t\t\t enum pipe pipe,\n\t\t\t\t enum intel_pipe_crc_source *source,\n\t\t\t\t u32 *val)\n{\n\tif (*source == INTEL_PIPE_CRC_SOURCE_AUTO)\n\t\ti9xx_pipe_crc_auto_source(dev_priv, pipe, source);\n\n\tswitch (*source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PIPE_I9XX;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_TV:\n\t\tif (!SUPPORTS_TV(dev_priv))\n\t\t\treturn -EINVAL;\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_TV_PRE;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\t*val = 0;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void vlv_undo_pipe_scramble_reset(struct drm_i915_private *dev_priv,\n\t\t\t\t\t enum pipe pipe)\n{\n\tu32 tmp = intel_de_read(dev_priv, PORT_DFT2_G4X);\n\n\tswitch (pipe) {\n\tcase PIPE_A:\n\t\ttmp &= ~PIPE_A_SCRAMBLE_RESET;\n\t\tbreak;\n\tcase PIPE_B:\n\t\ttmp &= ~PIPE_B_SCRAMBLE_RESET;\n\t\tbreak;\n\tcase PIPE_C:\n\t\ttmp &= ~PIPE_C_SCRAMBLE_RESET;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\tif (!(tmp & PIPE_SCRAMBLE_RESET_MASK))\n\t\ttmp &= ~DC_BALANCE_RESET_VLV;\n\tintel_de_write(dev_priv, PORT_DFT2_G4X, tmp);\n}\n\nstatic int ilk_pipe_crc_ctl_reg(enum intel_pipe_crc_source *source,\n\t\t\t\tu32 *val)\n{\n\tif (*source == INTEL_PIPE_CRC_SOURCE_AUTO)\n\t\t*source = INTEL_PIPE_CRC_SOURCE_PIPE;\n\n\tswitch (*source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE1:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PRIMARY_ILK;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE2:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_SPRITE_ILK;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PIPE_ILK;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\t*val = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void\nintel_crtc_crc_setup_workarounds(struct intel_crtc *crtc, bool enable)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tstruct intel_crtc_state *pipe_config;\n\tstruct drm_atomic_state *state;\n\tstruct drm_modeset_acquire_ctx ctx;\n\tint ret;\n\n\tdrm_modeset_acquire_init(&ctx, 0);\n\n\tstate = drm_atomic_state_alloc(&dev_priv->drm);\n\tif (!state) {\n\t\tret = -ENOMEM;\n\t\tgoto unlock;\n\t}\n\n\tstate->acquire_ctx = &ctx;\n\tto_intel_atomic_state(state)->internal = true;\n\nretry:\n\tpipe_config = intel_atomic_get_crtc_state(state, crtc);\n\tif (IS_ERR(pipe_config)) {\n\t\tret = PTR_ERR(pipe_config);\n\t\tgoto put_state;\n\t}\n\n\tpipe_config->uapi.mode_changed = pipe_config->has_psr;\n\tpipe_config->crc_enabled = enable;\n\n\tif (IS_HASWELL(dev_priv) &&\n\t    pipe_config->hw.active && crtc->pipe == PIPE_A &&\n\t    pipe_config->cpu_transcoder == TRANSCODER_EDP)\n\t\tpipe_config->uapi.mode_changed = true;\n\n\tret = drm_atomic_commit(state);\n\nput_state:\n\tif (ret == -EDEADLK) {\n\t\tdrm_atomic_state_clear(state);\n\t\tdrm_modeset_backoff(&ctx);\n\t\tgoto retry;\n\t}\n\n\tdrm_atomic_state_put(state);\nunlock:\n\tdrm_WARN(&dev_priv->drm, ret,\n\t\t \"Toggling workaround to %i returns %i\\n\", enable, ret);\n\tdrm_modeset_drop_locks(&ctx);\n\tdrm_modeset_acquire_fini(&ctx);\n}\n\nstatic int ivb_pipe_crc_ctl_reg(struct drm_i915_private *dev_priv,\n\t\t\t\tenum pipe pipe,\n\t\t\t\tenum intel_pipe_crc_source *source,\n\t\t\t\tu32 *val)\n{\n\tif (*source == INTEL_PIPE_CRC_SOURCE_AUTO)\n\t\t*source = INTEL_PIPE_CRC_SOURCE_PIPE;\n\n\tswitch (*source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE1:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PRIMARY_IVB;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE2:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_SPRITE_IVB;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PF_IVB;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\t*val = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int skl_pipe_crc_ctl_reg(struct drm_i915_private *dev_priv,\n\t\t\t\tenum pipe pipe,\n\t\t\t\tenum intel_pipe_crc_source *source,\n\t\t\t\tu32 *val)\n{\n\tif (*source == INTEL_PIPE_CRC_SOURCE_AUTO)\n\t\t*source = INTEL_PIPE_CRC_SOURCE_PIPE;\n\n\tswitch (*source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE1:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_1_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE2:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_2_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE3:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_3_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE4:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_4_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE5:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_5_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE6:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_6_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE7:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_PLANE_7_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\t\t*val = PIPE_CRC_ENABLE | PIPE_CRC_SOURCE_DMUX_SKL;\n\t\tbreak;\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\t*val = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int get_new_crc_ctl_reg(struct drm_i915_private *dev_priv,\n\t\t\t       enum pipe pipe,\n\t\t\t       enum intel_pipe_crc_source *source, u32 *val)\n{\n\tif (DISPLAY_VER(dev_priv) == 2)\n\t\treturn i8xx_pipe_crc_ctl_reg(source, val);\n\telse if (DISPLAY_VER(dev_priv) < 5)\n\t\treturn i9xx_pipe_crc_ctl_reg(dev_priv, pipe, source, val);\n\telse if (IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv))\n\t\treturn vlv_pipe_crc_ctl_reg(dev_priv, pipe, source, val);\n\telse if (IS_IRONLAKE(dev_priv) || IS_SANDYBRIDGE(dev_priv))\n\t\treturn ilk_pipe_crc_ctl_reg(source, val);\n\telse if (DISPLAY_VER(dev_priv) < 9)\n\t\treturn ivb_pipe_crc_ctl_reg(dev_priv, pipe, source, val);\n\telse\n\t\treturn skl_pipe_crc_ctl_reg(dev_priv, pipe, source, val);\n}\n\nstatic int\ndisplay_crc_ctl_parse_source(const char *buf, enum intel_pipe_crc_source *s)\n{\n\tint i;\n\n\tif (!buf) {\n\t\t*s = INTEL_PIPE_CRC_SOURCE_NONE;\n\t\treturn 0;\n\t}\n\n\ti = match_string(pipe_crc_sources, ARRAY_SIZE(pipe_crc_sources), buf);\n\tif (i < 0)\n\t\treturn i;\n\n\t*s = i;\n\treturn 0;\n}\n\nvoid intel_crtc_crc_init(struct intel_crtc *crtc)\n{\n\tstruct intel_pipe_crc *pipe_crc = &crtc->pipe_crc;\n\n\tspin_lock_init(&pipe_crc->lock);\n}\n\nstatic int i8xx_crc_source_valid(struct drm_i915_private *dev_priv,\n\t\t\t\t const enum intel_pipe_crc_source source)\n{\n\tswitch (source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int i9xx_crc_source_valid(struct drm_i915_private *dev_priv,\n\t\t\t\t const enum intel_pipe_crc_source source)\n{\n\tswitch (source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\tcase INTEL_PIPE_CRC_SOURCE_TV:\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int vlv_crc_source_valid(struct drm_i915_private *dev_priv,\n\t\t\t\tconst enum intel_pipe_crc_source source)\n{\n\tswitch (source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\tcase INTEL_PIPE_CRC_SOURCE_DP_B:\n\tcase INTEL_PIPE_CRC_SOURCE_DP_C:\n\tcase INTEL_PIPE_CRC_SOURCE_DP_D:\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int ilk_crc_source_valid(struct drm_i915_private *dev_priv,\n\t\t\t\tconst enum intel_pipe_crc_source source)\n{\n\tswitch (source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE1:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE2:\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int ivb_crc_source_valid(struct drm_i915_private *dev_priv,\n\t\t\t\tconst enum intel_pipe_crc_source source)\n{\n\tswitch (source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE1:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE2:\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int skl_crc_source_valid(struct drm_i915_private *dev_priv,\n\t\t\t\tconst enum intel_pipe_crc_source source)\n{\n\tswitch (source) {\n\tcase INTEL_PIPE_CRC_SOURCE_PIPE:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE1:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE2:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE3:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE4:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE5:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE6:\n\tcase INTEL_PIPE_CRC_SOURCE_PLANE7:\n\tcase INTEL_PIPE_CRC_SOURCE_NONE:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int\nintel_is_valid_crc_source(struct drm_i915_private *dev_priv,\n\t\t\t  const enum intel_pipe_crc_source source)\n{\n\tif (DISPLAY_VER(dev_priv) == 2)\n\t\treturn i8xx_crc_source_valid(dev_priv, source);\n\telse if (DISPLAY_VER(dev_priv) < 5)\n\t\treturn i9xx_crc_source_valid(dev_priv, source);\n\telse if (IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv))\n\t\treturn vlv_crc_source_valid(dev_priv, source);\n\telse if (IS_IRONLAKE(dev_priv) || IS_SANDYBRIDGE(dev_priv))\n\t\treturn ilk_crc_source_valid(dev_priv, source);\n\telse if (DISPLAY_VER(dev_priv) < 9)\n\t\treturn ivb_crc_source_valid(dev_priv, source);\n\telse\n\t\treturn skl_crc_source_valid(dev_priv, source);\n}\n\nconst char *const *intel_crtc_get_crc_sources(struct drm_crtc *crtc,\n\t\t\t\t\t      size_t *count)\n{\n\t*count = ARRAY_SIZE(pipe_crc_sources);\n\treturn pipe_crc_sources;\n}\n\nint intel_crtc_verify_crc_source(struct drm_crtc *crtc, const char *source_name,\n\t\t\t\t size_t *values_cnt)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->dev);\n\tenum intel_pipe_crc_source source;\n\n\tif (display_crc_ctl_parse_source(source_name, &source) < 0) {\n\t\tdrm_dbg(&dev_priv->drm, \"unknown source %s\\n\", source_name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (source == INTEL_PIPE_CRC_SOURCE_AUTO ||\n\t    intel_is_valid_crc_source(dev_priv, source) == 0) {\n\t\t*values_cnt = 5;\n\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\nint intel_crtc_set_crc_source(struct drm_crtc *_crtc, const char *source_name)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(_crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tstruct intel_pipe_crc *pipe_crc = &crtc->pipe_crc;\n\tenum intel_display_power_domain power_domain;\n\tenum intel_pipe_crc_source source;\n\tenum pipe pipe = crtc->pipe;\n\tintel_wakeref_t wakeref;\n\tu32 val = 0;  \n\tint ret = 0;\n\tbool enable;\n\n\tif (display_crc_ctl_parse_source(source_name, &source) < 0) {\n\t\tdrm_dbg(&dev_priv->drm, \"unknown source %s\\n\", source_name);\n\t\treturn -EINVAL;\n\t}\n\n\tpower_domain = POWER_DOMAIN_PIPE(pipe);\n\twakeref = intel_display_power_get_if_enabled(dev_priv, power_domain);\n\tif (!wakeref) {\n\t\tdrm_dbg_kms(&dev_priv->drm,\n\t\t\t    \"Trying to capture CRC while pipe is off\\n\");\n\t\treturn -EIO;\n\t}\n\n\tenable = source != INTEL_PIPE_CRC_SOURCE_NONE;\n\tif (enable)\n\t\tintel_crtc_crc_setup_workarounds(crtc, true);\n\n\tret = get_new_crc_ctl_reg(dev_priv, pipe, &source, &val);\n\tif (ret != 0)\n\t\tgoto out;\n\n\tpipe_crc->source = source;\n\tintel_de_write(dev_priv, PIPE_CRC_CTL(pipe), val);\n\tintel_de_posting_read(dev_priv, PIPE_CRC_CTL(pipe));\n\n\tif (!source) {\n\t\tif (IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv))\n\t\t\tvlv_undo_pipe_scramble_reset(dev_priv, pipe);\n\t}\n\n\tpipe_crc->skipped = 0;\n\nout:\n\tif (!enable)\n\t\tintel_crtc_crc_setup_workarounds(crtc, false);\n\n\tintel_display_power_put(dev_priv, power_domain, wakeref);\n\n\treturn ret;\n}\n\nvoid intel_crtc_enable_pipe_crc(struct intel_crtc *crtc)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tstruct intel_pipe_crc *pipe_crc = &crtc->pipe_crc;\n\tenum pipe pipe = crtc->pipe;\n\tu32 val = 0;\n\n\tif (!crtc->base.crc.opened)\n\t\treturn;\n\n\tif (get_new_crc_ctl_reg(dev_priv, pipe, &pipe_crc->source, &val) < 0)\n\t\treturn;\n\n\t \n\tpipe_crc->skipped = 0;\n\n\tintel_de_write(dev_priv, PIPE_CRC_CTL(pipe), val);\n\tintel_de_posting_read(dev_priv, PIPE_CRC_CTL(pipe));\n}\n\nvoid intel_crtc_disable_pipe_crc(struct intel_crtc *crtc)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tstruct intel_pipe_crc *pipe_crc = &crtc->pipe_crc;\n\tenum pipe pipe = crtc->pipe;\n\n\t \n\tspin_lock_irq(&pipe_crc->lock);\n\tpipe_crc->skipped = INT_MIN;\n\tspin_unlock_irq(&pipe_crc->lock);\n\n\tintel_de_write(dev_priv, PIPE_CRC_CTL(pipe), 0);\n\tintel_de_posting_read(dev_priv, PIPE_CRC_CTL(pipe));\n\tintel_synchronize_irq(dev_priv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}