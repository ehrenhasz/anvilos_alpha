{
  "module_name": "intel_hotplug_irq.c",
  "hash_id": "e8ea3289990c6aa6563f0b09f23d81a530149d32ac9388b98ec7a17ec5b1fef6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_hotplug_irq.c",
  "human_readable_source": "\n \n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_de.h\"\n#include \"intel_display_irq.h\"\n#include \"intel_display_types.h\"\n#include \"intel_dp_aux.h\"\n#include \"intel_gmbus.h\"\n#include \"intel_hotplug.h\"\n#include \"intel_hotplug_irq.h\"\n\ntypedef bool (*long_pulse_detect_func)(enum hpd_pin pin, u32 val);\ntypedef u32 (*hotplug_enables_func)(struct intel_encoder *encoder);\ntypedef u32 (*hotplug_mask_func)(enum hpd_pin pin);\n\nstatic const u32 hpd_ilk[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = DE_DP_A_HOTPLUG,\n};\n\nstatic const u32 hpd_ivb[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = DE_DP_A_HOTPLUG_IVB,\n};\n\nstatic const u32 hpd_bdw[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = GEN8_DE_PORT_HOTPLUG(HPD_PORT_A),\n};\n\nstatic const u32 hpd_ibx[HPD_NUM_PINS] = {\n\t[HPD_CRT] = SDE_CRT_HOTPLUG,\n\t[HPD_SDVO_B] = SDE_SDVOB_HOTPLUG,\n\t[HPD_PORT_B] = SDE_PORTB_HOTPLUG,\n\t[HPD_PORT_C] = SDE_PORTC_HOTPLUG,\n\t[HPD_PORT_D] = SDE_PORTD_HOTPLUG,\n};\n\nstatic const u32 hpd_cpt[HPD_NUM_PINS] = {\n\t[HPD_CRT] = SDE_CRT_HOTPLUG_CPT,\n\t[HPD_SDVO_B] = SDE_SDVOB_HOTPLUG_CPT,\n\t[HPD_PORT_B] = SDE_PORTB_HOTPLUG_CPT,\n\t[HPD_PORT_C] = SDE_PORTC_HOTPLUG_CPT,\n\t[HPD_PORT_D] = SDE_PORTD_HOTPLUG_CPT,\n};\n\nstatic const u32 hpd_spt[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = SDE_PORTA_HOTPLUG_SPT,\n\t[HPD_PORT_B] = SDE_PORTB_HOTPLUG_CPT,\n\t[HPD_PORT_C] = SDE_PORTC_HOTPLUG_CPT,\n\t[HPD_PORT_D] = SDE_PORTD_HOTPLUG_CPT,\n\t[HPD_PORT_E] = SDE_PORTE_HOTPLUG_SPT,\n};\n\nstatic const u32 hpd_mask_i915[HPD_NUM_PINS] = {\n\t[HPD_CRT] = CRT_HOTPLUG_INT_EN,\n\t[HPD_SDVO_B] = SDVOB_HOTPLUG_INT_EN,\n\t[HPD_SDVO_C] = SDVOC_HOTPLUG_INT_EN,\n\t[HPD_PORT_B] = PORTB_HOTPLUG_INT_EN,\n\t[HPD_PORT_C] = PORTC_HOTPLUG_INT_EN,\n\t[HPD_PORT_D] = PORTD_HOTPLUG_INT_EN,\n};\n\nstatic const u32 hpd_status_g4x[HPD_NUM_PINS] = {\n\t[HPD_CRT] = CRT_HOTPLUG_INT_STATUS,\n\t[HPD_SDVO_B] = SDVOB_HOTPLUG_INT_STATUS_G4X,\n\t[HPD_SDVO_C] = SDVOC_HOTPLUG_INT_STATUS_G4X,\n\t[HPD_PORT_B] = PORTB_HOTPLUG_INT_STATUS,\n\t[HPD_PORT_C] = PORTC_HOTPLUG_INT_STATUS,\n\t[HPD_PORT_D] = PORTD_HOTPLUG_INT_STATUS,\n};\n\nstatic const u32 hpd_status_i915[HPD_NUM_PINS] = {\n\t[HPD_CRT] = CRT_HOTPLUG_INT_STATUS,\n\t[HPD_SDVO_B] = SDVOB_HOTPLUG_INT_STATUS_I915,\n\t[HPD_SDVO_C] = SDVOC_HOTPLUG_INT_STATUS_I915,\n\t[HPD_PORT_B] = PORTB_HOTPLUG_INT_STATUS,\n\t[HPD_PORT_C] = PORTC_HOTPLUG_INT_STATUS,\n\t[HPD_PORT_D] = PORTD_HOTPLUG_INT_STATUS,\n};\n\nstatic const u32 hpd_bxt[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = GEN8_DE_PORT_HOTPLUG(HPD_PORT_A),\n\t[HPD_PORT_B] = GEN8_DE_PORT_HOTPLUG(HPD_PORT_B),\n\t[HPD_PORT_C] = GEN8_DE_PORT_HOTPLUG(HPD_PORT_C),\n};\n\nstatic const u32 hpd_gen11[HPD_NUM_PINS] = {\n\t[HPD_PORT_TC1] = GEN11_TC_HOTPLUG(HPD_PORT_TC1) | GEN11_TBT_HOTPLUG(HPD_PORT_TC1),\n\t[HPD_PORT_TC2] = GEN11_TC_HOTPLUG(HPD_PORT_TC2) | GEN11_TBT_HOTPLUG(HPD_PORT_TC2),\n\t[HPD_PORT_TC3] = GEN11_TC_HOTPLUG(HPD_PORT_TC3) | GEN11_TBT_HOTPLUG(HPD_PORT_TC3),\n\t[HPD_PORT_TC4] = GEN11_TC_HOTPLUG(HPD_PORT_TC4) | GEN11_TBT_HOTPLUG(HPD_PORT_TC4),\n\t[HPD_PORT_TC5] = GEN11_TC_HOTPLUG(HPD_PORT_TC5) | GEN11_TBT_HOTPLUG(HPD_PORT_TC5),\n\t[HPD_PORT_TC6] = GEN11_TC_HOTPLUG(HPD_PORT_TC6) | GEN11_TBT_HOTPLUG(HPD_PORT_TC6),\n};\n\nstatic const u32 hpd_xelpdp[HPD_NUM_PINS] = {\n\t[HPD_PORT_TC1] = XELPDP_TBT_HOTPLUG(HPD_PORT_TC1) | XELPDP_DP_ALT_HOTPLUG(HPD_PORT_TC1),\n\t[HPD_PORT_TC2] = XELPDP_TBT_HOTPLUG(HPD_PORT_TC2) | XELPDP_DP_ALT_HOTPLUG(HPD_PORT_TC2),\n\t[HPD_PORT_TC3] = XELPDP_TBT_HOTPLUG(HPD_PORT_TC3) | XELPDP_DP_ALT_HOTPLUG(HPD_PORT_TC3),\n\t[HPD_PORT_TC4] = XELPDP_TBT_HOTPLUG(HPD_PORT_TC4) | XELPDP_DP_ALT_HOTPLUG(HPD_PORT_TC4),\n};\n\nstatic const u32 hpd_icp[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_A),\n\t[HPD_PORT_B] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_B),\n\t[HPD_PORT_C] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_C),\n\t[HPD_PORT_TC1] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC1),\n\t[HPD_PORT_TC2] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC2),\n\t[HPD_PORT_TC3] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC3),\n\t[HPD_PORT_TC4] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC4),\n\t[HPD_PORT_TC5] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC5),\n\t[HPD_PORT_TC6] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC6),\n};\n\nstatic const u32 hpd_sde_dg1[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_A),\n\t[HPD_PORT_B] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_B),\n\t[HPD_PORT_C] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_C),\n\t[HPD_PORT_D] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_D),\n\t[HPD_PORT_TC1] = SDE_TC_HOTPLUG_DG2(HPD_PORT_TC1),\n};\n\nstatic const u32 hpd_mtp[HPD_NUM_PINS] = {\n\t[HPD_PORT_A] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_A),\n\t[HPD_PORT_B] = SDE_DDI_HOTPLUG_ICP(HPD_PORT_B),\n\t[HPD_PORT_TC1] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC1),\n\t[HPD_PORT_TC2] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC2),\n\t[HPD_PORT_TC3] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC3),\n\t[HPD_PORT_TC4] = SDE_TC_HOTPLUG_ICP(HPD_PORT_TC4),\n};\n\nstatic void intel_hpd_init_pins(struct drm_i915_private *dev_priv)\n{\n\tstruct intel_hotplug *hpd = &dev_priv->display.hotplug;\n\n\tif (HAS_GMCH(dev_priv)) {\n\t\tif (IS_G4X(dev_priv) || IS_VALLEYVIEW(dev_priv) ||\n\t\t    IS_CHERRYVIEW(dev_priv))\n\t\t\thpd->hpd = hpd_status_g4x;\n\t\telse\n\t\t\thpd->hpd = hpd_status_i915;\n\t\treturn;\n\t}\n\n\tif (DISPLAY_VER(dev_priv) >= 14)\n\t\thpd->hpd = hpd_xelpdp;\n\telse if (DISPLAY_VER(dev_priv) >= 11)\n\t\thpd->hpd = hpd_gen11;\n\telse if (IS_GEMINILAKE(dev_priv) || IS_BROXTON(dev_priv))\n\t\thpd->hpd = hpd_bxt;\n\telse if (DISPLAY_VER(dev_priv) == 9)\n\t\thpd->hpd = NULL;  \n\telse if (DISPLAY_VER(dev_priv) >= 8)\n\t\thpd->hpd = hpd_bdw;\n\telse if (DISPLAY_VER(dev_priv) >= 7)\n\t\thpd->hpd = hpd_ivb;\n\telse\n\t\thpd->hpd = hpd_ilk;\n\n\tif ((INTEL_PCH_TYPE(dev_priv) < PCH_DG1) &&\n\t    (!HAS_PCH_SPLIT(dev_priv) || HAS_PCH_NOP(dev_priv)))\n\t\treturn;\n\n\tif (INTEL_PCH_TYPE(dev_priv) >= PCH_DG1)\n\t\thpd->pch_hpd = hpd_sde_dg1;\n\telse if (INTEL_PCH_TYPE(dev_priv) >= PCH_MTP)\n\t\thpd->pch_hpd = hpd_mtp;\n\telse if (INTEL_PCH_TYPE(dev_priv) >= PCH_ICP)\n\t\thpd->pch_hpd = hpd_icp;\n\telse if (HAS_PCH_CNP(dev_priv) || HAS_PCH_SPT(dev_priv))\n\t\thpd->pch_hpd = hpd_spt;\n\telse if (HAS_PCH_LPT(dev_priv) || HAS_PCH_CPT(dev_priv))\n\t\thpd->pch_hpd = hpd_cpt;\n\telse if (HAS_PCH_IBX(dev_priv))\n\t\thpd->pch_hpd = hpd_ibx;\n\telse\n\t\tMISSING_CASE(INTEL_PCH_TYPE(dev_priv));\n}\n\n \nvoid i915_hotplug_interrupt_update_locked(struct drm_i915_private *dev_priv,\n\t\t\t\t\t  u32 mask, u32 bits)\n{\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\tdrm_WARN_ON(&dev_priv->drm, bits & ~mask);\n\n\tintel_uncore_rmw(&dev_priv->uncore, PORT_HOTPLUG_EN, mask, bits);\n}\n\n \nvoid i915_hotplug_interrupt_update(struct drm_i915_private *dev_priv,\n\t\t\t\t   u32 mask,\n\t\t\t\t   u32 bits)\n{\n\tspin_lock_irq(&dev_priv->irq_lock);\n\ti915_hotplug_interrupt_update_locked(dev_priv, mask, bits);\n\tspin_unlock_irq(&dev_priv->irq_lock);\n}\n\nstatic bool gen11_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_TC1:\n\tcase HPD_PORT_TC2:\n\tcase HPD_PORT_TC3:\n\tcase HPD_PORT_TC4:\n\tcase HPD_PORT_TC5:\n\tcase HPD_PORT_TC6:\n\t\treturn val & GEN11_HOTPLUG_CTL_LONG_DETECT(pin);\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool bxt_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_A:\n\t\treturn val & PORTA_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_B:\n\t\treturn val & PORTB_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_C:\n\t\treturn val & PORTC_HOTPLUG_LONG_DETECT;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool icp_ddi_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_A:\n\tcase HPD_PORT_B:\n\tcase HPD_PORT_C:\n\tcase HPD_PORT_D:\n\t\treturn val & SHOTPLUG_CTL_DDI_HPD_LONG_DETECT(pin);\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool icp_tc_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_TC1:\n\tcase HPD_PORT_TC2:\n\tcase HPD_PORT_TC3:\n\tcase HPD_PORT_TC4:\n\tcase HPD_PORT_TC5:\n\tcase HPD_PORT_TC6:\n\t\treturn val & ICP_TC_HPD_LONG_DETECT(pin);\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool spt_port_hotplug2_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_E:\n\t\treturn val & PORTE_HOTPLUG_LONG_DETECT;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool spt_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_A:\n\t\treturn val & PORTA_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_B:\n\t\treturn val & PORTB_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_C:\n\t\treturn val & PORTC_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_D:\n\t\treturn val & PORTD_HOTPLUG_LONG_DETECT;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool ilk_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_A:\n\t\treturn val & DIGITAL_PORTA_HOTPLUG_LONG_DETECT;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool pch_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_B:\n\t\treturn val & PORTB_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_C:\n\t\treturn val & PORTC_HOTPLUG_LONG_DETECT;\n\tcase HPD_PORT_D:\n\t\treturn val & PORTD_HOTPLUG_LONG_DETECT;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic bool i9xx_port_hotplug_long_detect(enum hpd_pin pin, u32 val)\n{\n\tswitch (pin) {\n\tcase HPD_PORT_B:\n\t\treturn val & PORTB_HOTPLUG_INT_LONG_PULSE;\n\tcase HPD_PORT_C:\n\t\treturn val & PORTC_HOTPLUG_INT_LONG_PULSE;\n\tcase HPD_PORT_D:\n\t\treturn val & PORTD_HOTPLUG_INT_LONG_PULSE;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\n \nstatic void intel_get_hpd_pins(struct drm_i915_private *dev_priv,\n\t\t\t       u32 *pin_mask, u32 *long_mask,\n\t\t\t       u32 hotplug_trigger, u32 dig_hotplug_reg,\n\t\t\t       const u32 hpd[HPD_NUM_PINS],\n\t\t\t       bool long_pulse_detect(enum hpd_pin pin, u32 val))\n{\n\tenum hpd_pin pin;\n\n\tBUILD_BUG_ON(BITS_PER_TYPE(*pin_mask) < HPD_NUM_PINS);\n\n\tfor_each_hpd_pin(pin) {\n\t\tif ((hpd[pin] & hotplug_trigger) == 0)\n\t\t\tcontinue;\n\n\t\t*pin_mask |= BIT(pin);\n\n\t\tif (long_pulse_detect(pin, dig_hotplug_reg))\n\t\t\t*long_mask |= BIT(pin);\n\t}\n\n\tdrm_dbg(&dev_priv->drm,\n\t\t\"hotplug event received, stat 0x%08x, dig 0x%08x, pins 0x%08x, long 0x%08x\\n\",\n\t\thotplug_trigger, dig_hotplug_reg, *pin_mask, *long_mask);\n}\n\nstatic u32 intel_hpd_enabled_irqs(struct drm_i915_private *dev_priv,\n\t\t\t\t  const u32 hpd[HPD_NUM_PINS])\n{\n\tstruct intel_encoder *encoder;\n\tu32 enabled_irqs = 0;\n\n\tfor_each_intel_encoder(&dev_priv->drm, encoder)\n\t\tif (dev_priv->display.hotplug.stats[encoder->hpd_pin].state == HPD_ENABLED)\n\t\t\tenabled_irqs |= hpd[encoder->hpd_pin];\n\n\treturn enabled_irqs;\n}\n\nstatic u32 intel_hpd_hotplug_irqs(struct drm_i915_private *dev_priv,\n\t\t\t\t  const u32 hpd[HPD_NUM_PINS])\n{\n\tstruct intel_encoder *encoder;\n\tu32 hotplug_irqs = 0;\n\n\tfor_each_intel_encoder(&dev_priv->drm, encoder)\n\t\thotplug_irqs |= hpd[encoder->hpd_pin];\n\n\treturn hotplug_irqs;\n}\n\nstatic u32 intel_hpd_hotplug_mask(struct drm_i915_private *i915,\n\t\t\t\t  hotplug_mask_func hotplug_mask)\n{\n\tenum hpd_pin pin;\n\tu32 hotplug = 0;\n\n\tfor_each_hpd_pin(pin)\n\t\thotplug |= hotplug_mask(pin);\n\n\treturn hotplug;\n}\n\nstatic u32 intel_hpd_hotplug_enables(struct drm_i915_private *i915,\n\t\t\t\t     hotplug_enables_func hotplug_enables)\n{\n\tstruct intel_encoder *encoder;\n\tu32 hotplug = 0;\n\n\tfor_each_intel_encoder(&i915->drm, encoder)\n\t\thotplug |= hotplug_enables(encoder);\n\n\treturn hotplug;\n}\n\nu32 i9xx_hpd_irq_ack(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_status = 0, hotplug_status_mask;\n\tint i;\n\n\tif (IS_G4X(dev_priv) ||\n\t    IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv))\n\t\thotplug_status_mask = HOTPLUG_INT_STATUS_G4X |\n\t\t\tDP_AUX_CHANNEL_MASK_INT_STATUS_G4X;\n\telse\n\t\thotplug_status_mask = HOTPLUG_INT_STATUS_I915;\n\n\t \n\tfor (i = 0; i < 10; i++) {\n\t\tu32 tmp = intel_uncore_read(&dev_priv->uncore, PORT_HOTPLUG_STAT) & hotplug_status_mask;\n\n\t\tif (tmp == 0)\n\t\t\treturn hotplug_status;\n\n\t\thotplug_status |= tmp;\n\t\tintel_uncore_write(&dev_priv->uncore, PORT_HOTPLUG_STAT, hotplug_status);\n\t}\n\n\tdrm_WARN_ONCE(&dev_priv->drm, 1,\n\t\t      \"PORT_HOTPLUG_STAT did not clear (0x%08x)\\n\",\n\t\t      intel_uncore_read(&dev_priv->uncore, PORT_HOTPLUG_STAT));\n\n\treturn hotplug_status;\n}\n\nvoid i9xx_hpd_irq_handler(struct drm_i915_private *dev_priv, u32 hotplug_status)\n{\n\tu32 pin_mask = 0, long_mask = 0;\n\tu32 hotplug_trigger;\n\n\tif (IS_G4X(dev_priv) ||\n\t    IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv))\n\t\thotplug_trigger = hotplug_status & HOTPLUG_INT_STATUS_G4X;\n\telse\n\t\thotplug_trigger = hotplug_status & HOTPLUG_INT_STATUS_I915;\n\n\tif (hotplug_trigger) {\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   hotplug_trigger, hotplug_trigger,\n\t\t\t\t   dev_priv->display.hotplug.hpd,\n\t\t\t\t   i9xx_port_hotplug_long_detect);\n\n\t\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n\t}\n\n\tif ((IS_G4X(dev_priv) ||\n\t     IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv)) &&\n\t    hotplug_status & DP_AUX_CHANNEL_MASK_INT_STATUS_G4X)\n\t\tintel_dp_aux_irq_handler(dev_priv);\n}\n\nvoid ibx_hpd_irq_handler(struct drm_i915_private *dev_priv, u32 hotplug_trigger)\n{\n\tu32 dig_hotplug_reg, pin_mask = 0, long_mask = 0;\n\n\t \n\tdig_hotplug_reg = intel_uncore_read(&dev_priv->uncore, PCH_PORT_HOTPLUG);\n\tif (!hotplug_trigger) {\n\t\tu32 mask = PORTA_HOTPLUG_STATUS_MASK |\n\t\t\tPORTD_HOTPLUG_STATUS_MASK |\n\t\t\tPORTC_HOTPLUG_STATUS_MASK |\n\t\t\tPORTB_HOTPLUG_STATUS_MASK;\n\t\tdig_hotplug_reg &= ~mask;\n\t}\n\n\tintel_uncore_write(&dev_priv->uncore, PCH_PORT_HOTPLUG, dig_hotplug_reg);\n\tif (!hotplug_trigger)\n\t\treturn;\n\n\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t   hotplug_trigger, dig_hotplug_reg,\n\t\t\t   dev_priv->display.hotplug.pch_hpd,\n\t\t\t   pch_port_hotplug_long_detect);\n\n\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n}\n\nvoid xelpdp_pica_irq_handler(struct drm_i915_private *i915, u32 iir)\n{\n\tenum hpd_pin pin;\n\tu32 hotplug_trigger = iir & (XELPDP_DP_ALT_HOTPLUG_MASK | XELPDP_TBT_HOTPLUG_MASK);\n\tu32 trigger_aux = iir & XELPDP_AUX_TC_MASK;\n\tu32 pin_mask = 0, long_mask = 0;\n\n\tfor (pin = HPD_PORT_TC1; pin <= HPD_PORT_TC4; pin++) {\n\t\tu32 val;\n\n\t\tif (!(i915->display.hotplug.hpd[pin] & hotplug_trigger))\n\t\t\tcontinue;\n\n\t\tpin_mask |= BIT(pin);\n\n\t\tval = intel_de_read(i915, XELPDP_PORT_HOTPLUG_CTL(pin));\n\t\tintel_de_write(i915, XELPDP_PORT_HOTPLUG_CTL(pin), val);\n\n\t\tif (val & (XELPDP_DP_ALT_HPD_LONG_DETECT | XELPDP_TBT_HPD_LONG_DETECT))\n\t\t\tlong_mask |= BIT(pin);\n\t}\n\n\tif (pin_mask) {\n\t\tdrm_dbg(&i915->drm,\n\t\t\t\"pica hotplug event received, stat 0x%08x, pins 0x%08x, long 0x%08x\\n\",\n\t\t\thotplug_trigger, pin_mask, long_mask);\n\n\t\tintel_hpd_irq_handler(i915, pin_mask, long_mask);\n\t}\n\n\tif (trigger_aux)\n\t\tintel_dp_aux_irq_handler(i915);\n\n\tif (!pin_mask && !trigger_aux)\n\t\tdrm_err(&i915->drm,\n\t\t\t\"Unexpected DE HPD/AUX interrupt 0x%08x\\n\", iir);\n}\n\nvoid icp_irq_handler(struct drm_i915_private *dev_priv, u32 pch_iir)\n{\n\tu32 ddi_hotplug_trigger = pch_iir & SDE_DDI_HOTPLUG_MASK_ICP;\n\tu32 tc_hotplug_trigger = pch_iir & SDE_TC_HOTPLUG_MASK_ICP;\n\tu32 pin_mask = 0, long_mask = 0;\n\n\tif (ddi_hotplug_trigger) {\n\t\tu32 dig_hotplug_reg;\n\n\t\t \n\t\tspin_lock(&dev_priv->irq_lock);\n\t\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, SHOTPLUG_CTL_DDI, 0, 0);\n\t\tspin_unlock(&dev_priv->irq_lock);\n\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   ddi_hotplug_trigger, dig_hotplug_reg,\n\t\t\t\t   dev_priv->display.hotplug.pch_hpd,\n\t\t\t\t   icp_ddi_port_hotplug_long_detect);\n\t}\n\n\tif (tc_hotplug_trigger) {\n\t\tu32 dig_hotplug_reg;\n\n\t\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, SHOTPLUG_CTL_TC, 0, 0);\n\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   tc_hotplug_trigger, dig_hotplug_reg,\n\t\t\t\t   dev_priv->display.hotplug.pch_hpd,\n\t\t\t\t   icp_tc_port_hotplug_long_detect);\n\t}\n\n\tif (pin_mask)\n\t\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n\n\tif (pch_iir & SDE_GMBUS_ICP)\n\t\tintel_gmbus_irq_handler(dev_priv);\n}\n\nvoid spt_irq_handler(struct drm_i915_private *dev_priv, u32 pch_iir)\n{\n\tu32 hotplug_trigger = pch_iir & SDE_HOTPLUG_MASK_SPT &\n\t\t~SDE_PORTE_HOTPLUG_SPT;\n\tu32 hotplug2_trigger = pch_iir & SDE_PORTE_HOTPLUG_SPT;\n\tu32 pin_mask = 0, long_mask = 0;\n\n\tif (hotplug_trigger) {\n\t\tu32 dig_hotplug_reg;\n\n\t\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG, 0, 0);\n\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   hotplug_trigger, dig_hotplug_reg,\n\t\t\t\t   dev_priv->display.hotplug.pch_hpd,\n\t\t\t\t   spt_port_hotplug_long_detect);\n\t}\n\n\tif (hotplug2_trigger) {\n\t\tu32 dig_hotplug_reg;\n\n\t\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG2, 0, 0);\n\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   hotplug2_trigger, dig_hotplug_reg,\n\t\t\t\t   dev_priv->display.hotplug.pch_hpd,\n\t\t\t\t   spt_port_hotplug2_long_detect);\n\t}\n\n\tif (pin_mask)\n\t\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n\n\tif (pch_iir & SDE_GMBUS_CPT)\n\t\tintel_gmbus_irq_handler(dev_priv);\n}\n\nvoid ilk_hpd_irq_handler(struct drm_i915_private *dev_priv, u32 hotplug_trigger)\n{\n\tu32 dig_hotplug_reg, pin_mask = 0, long_mask = 0;\n\n\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, DIGITAL_PORT_HOTPLUG_CNTRL, 0, 0);\n\n\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t   hotplug_trigger, dig_hotplug_reg,\n\t\t\t   dev_priv->display.hotplug.hpd,\n\t\t\t   ilk_port_hotplug_long_detect);\n\n\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n}\n\nvoid bxt_hpd_irq_handler(struct drm_i915_private *dev_priv, u32 hotplug_trigger)\n{\n\tu32 dig_hotplug_reg, pin_mask = 0, long_mask = 0;\n\n\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG, 0, 0);\n\n\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t   hotplug_trigger, dig_hotplug_reg,\n\t\t\t   dev_priv->display.hotplug.hpd,\n\t\t\t   bxt_port_hotplug_long_detect);\n\n\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n}\n\nvoid gen11_hpd_irq_handler(struct drm_i915_private *dev_priv, u32 iir)\n{\n\tu32 pin_mask = 0, long_mask = 0;\n\tu32 trigger_tc = iir & GEN11_DE_TC_HOTPLUG_MASK;\n\tu32 trigger_tbt = iir & GEN11_DE_TBT_HOTPLUG_MASK;\n\n\tif (trigger_tc) {\n\t\tu32 dig_hotplug_reg;\n\n\t\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, GEN11_TC_HOTPLUG_CTL, 0, 0);\n\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   trigger_tc, dig_hotplug_reg,\n\t\t\t\t   dev_priv->display.hotplug.hpd,\n\t\t\t\t   gen11_port_hotplug_long_detect);\n\t}\n\n\tif (trigger_tbt) {\n\t\tu32 dig_hotplug_reg;\n\n\t\tdig_hotplug_reg = intel_uncore_rmw(&dev_priv->uncore, GEN11_TBT_HOTPLUG_CTL, 0, 0);\n\n\t\tintel_get_hpd_pins(dev_priv, &pin_mask, &long_mask,\n\t\t\t\t   trigger_tbt, dig_hotplug_reg,\n\t\t\t\t   dev_priv->display.hotplug.hpd,\n\t\t\t\t   gen11_port_hotplug_long_detect);\n\t}\n\n\tif (pin_mask)\n\t\tintel_hpd_irq_handler(dev_priv, pin_mask, long_mask);\n\telse\n\t\tdrm_err(&dev_priv->drm,\n\t\t\t\"Unexpected DE HPD interrupt 0x%08x\\n\", iir);\n}\n\nstatic u32 ibx_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_A:\n\t\treturn PORTA_HOTPLUG_ENABLE;\n\tcase HPD_PORT_B:\n\t\treturn PORTB_HOTPLUG_ENABLE | PORTB_PULSE_DURATION_MASK;\n\tcase HPD_PORT_C:\n\t\treturn PORTC_HOTPLUG_ENABLE | PORTC_PULSE_DURATION_MASK;\n\tcase HPD_PORT_D:\n\t\treturn PORTD_HOTPLUG_ENABLE | PORTD_PULSE_DURATION_MASK;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 ibx_hotplug_enables(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tswitch (encoder->hpd_pin) {\n\tcase HPD_PORT_A:\n\t\t \n\t\treturn HAS_PCH_LPT_LP(i915) ?\n\t\t\tPORTA_HOTPLUG_ENABLE : 0;\n\tcase HPD_PORT_B:\n\t\treturn PORTB_HOTPLUG_ENABLE |\n\t\t\tPORTB_PULSE_DURATION_2ms;\n\tcase HPD_PORT_C:\n\t\treturn PORTC_HOTPLUG_ENABLE |\n\t\t\tPORTC_PULSE_DURATION_2ms;\n\tcase HPD_PORT_D:\n\t\treturn PORTD_HOTPLUG_ENABLE |\n\t\t\tPORTD_PULSE_DURATION_2ms;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic void ibx_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\t \n\tintel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, ibx_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, ibx_hotplug_enables));\n}\n\nstatic void ibx_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, PCH_PORT_HOTPLUG,\n\t\t\t ibx_hotplug_mask(encoder->hpd_pin),\n\t\t\t ibx_hotplug_enables(encoder));\n}\n\nstatic void ibx_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(dev_priv, dev_priv->display.hotplug.pch_hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(dev_priv, dev_priv->display.hotplug.pch_hpd);\n\n\tibx_display_interrupt_update(dev_priv, hotplug_irqs, enabled_irqs);\n\n\tibx_hpd_detection_setup(dev_priv);\n}\n\nstatic u32 icp_ddi_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_A:\n\tcase HPD_PORT_B:\n\tcase HPD_PORT_C:\n\tcase HPD_PORT_D:\n\t\treturn SHOTPLUG_CTL_DDI_HPD_ENABLE(hpd_pin);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 icp_ddi_hotplug_enables(struct intel_encoder *encoder)\n{\n\treturn icp_ddi_hotplug_mask(encoder->hpd_pin);\n}\n\nstatic u32 icp_tc_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_TC1:\n\tcase HPD_PORT_TC2:\n\tcase HPD_PORT_TC3:\n\tcase HPD_PORT_TC4:\n\tcase HPD_PORT_TC5:\n\tcase HPD_PORT_TC6:\n\t\treturn ICP_TC_HPD_ENABLE(hpd_pin);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 icp_tc_hotplug_enables(struct intel_encoder *encoder)\n{\n\treturn icp_tc_hotplug_mask(encoder->hpd_pin);\n}\n\nstatic void icp_ddi_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\tintel_uncore_rmw(&dev_priv->uncore, SHOTPLUG_CTL_DDI,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, icp_ddi_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, icp_ddi_hotplug_enables));\n}\n\nstatic void icp_ddi_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, SHOTPLUG_CTL_DDI,\n\t\t\t icp_ddi_hotplug_mask(encoder->hpd_pin),\n\t\t\t icp_ddi_hotplug_enables(encoder));\n}\n\nstatic void icp_tc_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\tintel_uncore_rmw(&dev_priv->uncore, SHOTPLUG_CTL_TC,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, icp_tc_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, icp_tc_hotplug_enables));\n}\n\nstatic void icp_tc_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, SHOTPLUG_CTL_TC,\n\t\t\t icp_tc_hotplug_mask(encoder->hpd_pin),\n\t\t\t icp_tc_hotplug_enables(encoder));\n}\n\nstatic void icp_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\ticp_ddi_hpd_enable_detection(encoder);\n\ticp_tc_hpd_enable_detection(encoder);\n}\n\nstatic void icp_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(dev_priv, dev_priv->display.hotplug.pch_hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(dev_priv, dev_priv->display.hotplug.pch_hpd);\n\n\tif (INTEL_PCH_TYPE(dev_priv) <= PCH_TGP)\n\t\tintel_uncore_write(&dev_priv->uncore, SHPD_FILTER_CNT, SHPD_FILTER_CNT_500_ADJ);\n\telse\n\t\tintel_uncore_write(&dev_priv->uncore, SHPD_FILTER_CNT, SHPD_FILTER_CNT_250);\n\n\tibx_display_interrupt_update(dev_priv, hotplug_irqs, enabled_irqs);\n\n\ticp_ddi_hpd_detection_setup(dev_priv);\n\ticp_tc_hpd_detection_setup(dev_priv);\n}\n\nstatic u32 gen11_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_TC1:\n\tcase HPD_PORT_TC2:\n\tcase HPD_PORT_TC3:\n\tcase HPD_PORT_TC4:\n\tcase HPD_PORT_TC5:\n\tcase HPD_PORT_TC6:\n\t\treturn GEN11_HOTPLUG_CTL_ENABLE(hpd_pin);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 gen11_hotplug_enables(struct intel_encoder *encoder)\n{\n\treturn gen11_hotplug_mask(encoder->hpd_pin);\n}\n\nstatic void dg1_hpd_invert(struct drm_i915_private *i915)\n{\n\tu32 val = (INVERT_DDIA_HPD |\n\t\t   INVERT_DDIB_HPD |\n\t\t   INVERT_DDIC_HPD |\n\t\t   INVERT_DDID_HPD);\n\tintel_uncore_rmw(&i915->uncore, SOUTH_CHICKEN1, 0, val);\n}\n\nstatic void dg1_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tdg1_hpd_invert(i915);\n\ticp_hpd_enable_detection(encoder);\n}\n\nstatic void dg1_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tdg1_hpd_invert(dev_priv);\n\ticp_hpd_irq_setup(dev_priv);\n}\n\nstatic void gen11_tc_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\tintel_uncore_rmw(&dev_priv->uncore, GEN11_TC_HOTPLUG_CTL,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, gen11_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, gen11_hotplug_enables));\n}\n\nstatic void gen11_tc_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, GEN11_TC_HOTPLUG_CTL,\n\t\t\t gen11_hotplug_mask(encoder->hpd_pin),\n\t\t\t gen11_hotplug_enables(encoder));\n}\n\nstatic void gen11_tbt_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\tintel_uncore_rmw(&dev_priv->uncore, GEN11_TBT_HOTPLUG_CTL,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, gen11_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, gen11_hotplug_enables));\n}\n\nstatic void gen11_tbt_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, GEN11_TBT_HOTPLUG_CTL,\n\t\t\t gen11_hotplug_mask(encoder->hpd_pin),\n\t\t\t gen11_hotplug_enables(encoder));\n}\n\nstatic void gen11_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tgen11_tc_hpd_enable_detection(encoder);\n\tgen11_tbt_hpd_enable_detection(encoder);\n\n\tif (INTEL_PCH_TYPE(i915) >= PCH_ICP)\n\t\ticp_hpd_enable_detection(encoder);\n}\n\nstatic void gen11_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(dev_priv, dev_priv->display.hotplug.hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(dev_priv, dev_priv->display.hotplug.hpd);\n\n\tintel_uncore_rmw(&dev_priv->uncore, GEN11_DE_HPD_IMR, hotplug_irqs,\n\t\t\t ~enabled_irqs & hotplug_irqs);\n\tintel_uncore_posting_read(&dev_priv->uncore, GEN11_DE_HPD_IMR);\n\n\tgen11_tc_hpd_detection_setup(dev_priv);\n\tgen11_tbt_hpd_detection_setup(dev_priv);\n\n\tif (INTEL_PCH_TYPE(dev_priv) >= PCH_ICP)\n\t\ticp_hpd_irq_setup(dev_priv);\n}\n\nstatic u32 mtp_ddi_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_A:\n\tcase HPD_PORT_B:\n\t\treturn SHOTPLUG_CTL_DDI_HPD_ENABLE(hpd_pin);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 mtp_ddi_hotplug_enables(struct intel_encoder *encoder)\n{\n\treturn mtp_ddi_hotplug_mask(encoder->hpd_pin);\n}\n\nstatic u32 mtp_tc_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_TC1:\n\tcase HPD_PORT_TC2:\n\tcase HPD_PORT_TC3:\n\tcase HPD_PORT_TC4:\n\t\treturn ICP_TC_HPD_ENABLE(hpd_pin);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 mtp_tc_hotplug_enables(struct intel_encoder *encoder)\n{\n\treturn mtp_tc_hotplug_mask(encoder->hpd_pin);\n}\n\nstatic void mtp_ddi_hpd_detection_setup(struct drm_i915_private *i915)\n{\n\tintel_de_rmw(i915, SHOTPLUG_CTL_DDI,\n\t\t     intel_hpd_hotplug_mask(i915, mtp_ddi_hotplug_mask),\n\t\t     intel_hpd_hotplug_enables(i915, mtp_ddi_hotplug_enables));\n}\n\nstatic void mtp_ddi_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_de_rmw(i915, SHOTPLUG_CTL_DDI,\n\t\t     mtp_ddi_hotplug_mask(encoder->hpd_pin),\n\t\t     mtp_ddi_hotplug_enables(encoder));\n}\n\nstatic void mtp_tc_hpd_detection_setup(struct drm_i915_private *i915)\n{\n\tintel_de_rmw(i915, SHOTPLUG_CTL_TC,\n\t\t     intel_hpd_hotplug_mask(i915, mtp_tc_hotplug_mask),\n\t\t     intel_hpd_hotplug_enables(i915, mtp_tc_hotplug_enables));\n}\n\nstatic void mtp_tc_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_de_rmw(i915, SHOTPLUG_CTL_DDI,\n\t\t     mtp_tc_hotplug_mask(encoder->hpd_pin),\n\t\t     mtp_tc_hotplug_enables(encoder));\n}\n\nstatic void mtp_hpd_invert(struct drm_i915_private *i915)\n{\n\tu32 val = (INVERT_DDIA_HPD |\n\t\t   INVERT_DDIB_HPD |\n\t\t   INVERT_DDIC_HPD |\n\t\t   INVERT_TC1_HPD |\n\t\t   INVERT_TC2_HPD |\n\t\t   INVERT_TC3_HPD |\n\t\t   INVERT_TC4_HPD |\n\t\t   INVERT_DDID_HPD_MTP |\n\t\t   INVERT_DDIE_HPD);\n\tintel_de_rmw(i915, SOUTH_CHICKEN1, 0, val);\n}\n\nstatic void mtp_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tmtp_hpd_invert(i915);\n\tmtp_ddi_hpd_enable_detection(encoder);\n\tmtp_tc_hpd_enable_detection(encoder);\n}\n\nstatic void mtp_hpd_irq_setup(struct drm_i915_private *i915)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(i915, i915->display.hotplug.pch_hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(i915, i915->display.hotplug.pch_hpd);\n\n\tintel_de_write(i915, SHPD_FILTER_CNT, SHPD_FILTER_CNT_250);\n\n\tmtp_hpd_invert(i915);\n\tibx_display_interrupt_update(i915, hotplug_irqs, enabled_irqs);\n\n\tmtp_ddi_hpd_detection_setup(i915);\n\tmtp_tc_hpd_detection_setup(i915);\n}\n\nstatic bool is_xelpdp_pica_hpd_pin(enum hpd_pin hpd_pin)\n{\n\treturn hpd_pin >= HPD_PORT_TC1 && hpd_pin <= HPD_PORT_TC4;\n}\n\nstatic void _xelpdp_pica_hpd_detection_setup(struct drm_i915_private *i915,\n\t\t\t\t\t     enum hpd_pin hpd_pin, bool enable)\n{\n\tu32 mask = XELPDP_TBT_HOTPLUG_ENABLE |\n\t\tXELPDP_DP_ALT_HOTPLUG_ENABLE;\n\n\tif (!is_xelpdp_pica_hpd_pin(hpd_pin))\n\t\treturn;\n\n\tintel_de_rmw(i915, XELPDP_PORT_HOTPLUG_CTL(hpd_pin),\n\t\t     mask, enable ? mask : 0);\n}\n\nstatic void xelpdp_pica_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\t_xelpdp_pica_hpd_detection_setup(i915, encoder->hpd_pin, true);\n}\n\nstatic void xelpdp_pica_hpd_detection_setup(struct drm_i915_private *i915)\n{\n\tstruct intel_encoder *encoder;\n\tu32 available_pins = 0;\n\tenum hpd_pin pin;\n\n\tBUILD_BUG_ON(BITS_PER_TYPE(available_pins) < HPD_NUM_PINS);\n\n\tfor_each_intel_encoder(&i915->drm, encoder)\n\t\tavailable_pins |= BIT(encoder->hpd_pin);\n\n\tfor_each_hpd_pin(pin)\n\t\t_xelpdp_pica_hpd_detection_setup(i915, pin, available_pins & BIT(pin));\n}\n\nstatic void xelpdp_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\txelpdp_pica_hpd_enable_detection(encoder);\n\tmtp_hpd_enable_detection(encoder);\n}\n\nstatic void xelpdp_hpd_irq_setup(struct drm_i915_private *i915)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(i915, i915->display.hotplug.hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(i915, i915->display.hotplug.hpd);\n\n\tintel_de_rmw(i915, PICAINTERRUPT_IMR, hotplug_irqs,\n\t\t     ~enabled_irqs & hotplug_irqs);\n\tintel_uncore_posting_read(&i915->uncore, PICAINTERRUPT_IMR);\n\n\txelpdp_pica_hpd_detection_setup(i915);\n\n\tif (INTEL_PCH_TYPE(i915) >= PCH_MTP)\n\t\tmtp_hpd_irq_setup(i915);\n}\n\nstatic u32 spt_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_A:\n\t\treturn PORTA_HOTPLUG_ENABLE;\n\tcase HPD_PORT_B:\n\t\treturn PORTB_HOTPLUG_ENABLE;\n\tcase HPD_PORT_C:\n\t\treturn PORTC_HOTPLUG_ENABLE;\n\tcase HPD_PORT_D:\n\t\treturn PORTD_HOTPLUG_ENABLE;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 spt_hotplug_enables(struct intel_encoder *encoder)\n{\n\treturn spt_hotplug_mask(encoder->hpd_pin);\n}\n\nstatic u32 spt_hotplug2_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_E:\n\t\treturn PORTE_HOTPLUG_ENABLE;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 spt_hotplug2_enables(struct intel_encoder *encoder)\n{\n\treturn spt_hotplug2_mask(encoder->hpd_pin);\n}\n\nstatic void spt_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\t \n\tif (HAS_PCH_CNP(dev_priv)) {\n\t\tintel_uncore_rmw(&dev_priv->uncore, SOUTH_CHICKEN1, CHASSIS_CLK_REQ_DURATION_MASK,\n\t\t\t\t CHASSIS_CLK_REQ_DURATION(0xf));\n\t}\n\n\t \n\tintel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, spt_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, spt_hotplug_enables));\n\n\tintel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG2,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, spt_hotplug2_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, spt_hotplug2_enables));\n}\n\nstatic void spt_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\t \n\tif (HAS_PCH_CNP(i915)) {\n\t\tintel_uncore_rmw(&i915->uncore, SOUTH_CHICKEN1,\n\t\t\t\t CHASSIS_CLK_REQ_DURATION_MASK,\n\t\t\t\t CHASSIS_CLK_REQ_DURATION(0xf));\n\t}\n\n\tintel_uncore_rmw(&i915->uncore, PCH_PORT_HOTPLUG,\n\t\t\t spt_hotplug_mask(encoder->hpd_pin),\n\t\t\t spt_hotplug_enables(encoder));\n\n\tintel_uncore_rmw(&i915->uncore, PCH_PORT_HOTPLUG2,\n\t\t\t spt_hotplug2_mask(encoder->hpd_pin),\n\t\t\t spt_hotplug2_enables(encoder));\n}\n\nstatic void spt_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tif (INTEL_PCH_TYPE(dev_priv) >= PCH_CNP)\n\t\tintel_uncore_write(&dev_priv->uncore, SHPD_FILTER_CNT, SHPD_FILTER_CNT_500_ADJ);\n\n\tenabled_irqs = intel_hpd_enabled_irqs(dev_priv, dev_priv->display.hotplug.pch_hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(dev_priv, dev_priv->display.hotplug.pch_hpd);\n\n\tibx_display_interrupt_update(dev_priv, hotplug_irqs, enabled_irqs);\n\n\tspt_hpd_detection_setup(dev_priv);\n}\n\nstatic u32 ilk_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_A:\n\t\treturn DIGITAL_PORTA_HOTPLUG_ENABLE |\n\t\t\tDIGITAL_PORTA_PULSE_DURATION_MASK;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 ilk_hotplug_enables(struct intel_encoder *encoder)\n{\n\tswitch (encoder->hpd_pin) {\n\tcase HPD_PORT_A:\n\t\treturn DIGITAL_PORTA_HOTPLUG_ENABLE |\n\t\t\tDIGITAL_PORTA_PULSE_DURATION_2ms;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic void ilk_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\t \n\tintel_uncore_rmw(&dev_priv->uncore, DIGITAL_PORT_HOTPLUG_CNTRL,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, ilk_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, ilk_hotplug_enables));\n}\n\nstatic void ilk_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, DIGITAL_PORT_HOTPLUG_CNTRL,\n\t\t\t ilk_hotplug_mask(encoder->hpd_pin),\n\t\t\t ilk_hotplug_enables(encoder));\n\n\tibx_hpd_enable_detection(encoder);\n}\n\nstatic void ilk_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(dev_priv, dev_priv->display.hotplug.hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(dev_priv, dev_priv->display.hotplug.hpd);\n\n\tif (DISPLAY_VER(dev_priv) >= 8)\n\t\tbdw_update_port_irq(dev_priv, hotplug_irqs, enabled_irqs);\n\telse\n\t\tilk_update_display_irq(dev_priv, hotplug_irqs, enabled_irqs);\n\n\tilk_hpd_detection_setup(dev_priv);\n\n\tibx_hpd_irq_setup(dev_priv);\n}\n\nstatic u32 bxt_hotplug_mask(enum hpd_pin hpd_pin)\n{\n\tswitch (hpd_pin) {\n\tcase HPD_PORT_A:\n\t\treturn PORTA_HOTPLUG_ENABLE | BXT_DDIA_HPD_INVERT;\n\tcase HPD_PORT_B:\n\t\treturn PORTB_HOTPLUG_ENABLE | BXT_DDIB_HPD_INVERT;\n\tcase HPD_PORT_C:\n\t\treturn PORTC_HOTPLUG_ENABLE | BXT_DDIC_HPD_INVERT;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 bxt_hotplug_enables(struct intel_encoder *encoder)\n{\n\tu32 hotplug;\n\n\tswitch (encoder->hpd_pin) {\n\tcase HPD_PORT_A:\n\t\thotplug = PORTA_HOTPLUG_ENABLE;\n\t\tif (intel_bios_encoder_hpd_invert(encoder->devdata))\n\t\t\thotplug |= BXT_DDIA_HPD_INVERT;\n\t\treturn hotplug;\n\tcase HPD_PORT_B:\n\t\thotplug = PORTB_HOTPLUG_ENABLE;\n\t\tif (intel_bios_encoder_hpd_invert(encoder->devdata))\n\t\t\thotplug |= BXT_DDIB_HPD_INVERT;\n\t\treturn hotplug;\n\tcase HPD_PORT_C:\n\t\thotplug = PORTC_HOTPLUG_ENABLE;\n\t\tif (intel_bios_encoder_hpd_invert(encoder->devdata))\n\t\t\thotplug |= BXT_DDIC_HPD_INVERT;\n\t\treturn hotplug;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic void bxt_hpd_detection_setup(struct drm_i915_private *dev_priv)\n{\n\tintel_uncore_rmw(&dev_priv->uncore, PCH_PORT_HOTPLUG,\n\t\t\t intel_hpd_hotplug_mask(dev_priv, bxt_hotplug_mask),\n\t\t\t intel_hpd_hotplug_enables(dev_priv, bxt_hotplug_enables));\n}\n\nstatic void bxt_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tintel_uncore_rmw(&i915->uncore, PCH_PORT_HOTPLUG,\n\t\t\t bxt_hotplug_mask(encoder->hpd_pin),\n\t\t\t bxt_hotplug_enables(encoder));\n}\n\nstatic void bxt_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_irqs, enabled_irqs;\n\n\tenabled_irqs = intel_hpd_enabled_irqs(dev_priv, dev_priv->display.hotplug.hpd);\n\thotplug_irqs = intel_hpd_hotplug_irqs(dev_priv, dev_priv->display.hotplug.hpd);\n\n\tbdw_update_port_irq(dev_priv, hotplug_irqs, enabled_irqs);\n\n\tbxt_hpd_detection_setup(dev_priv);\n}\n\nstatic void i915_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\tu32 hotplug_en = hpd_mask_i915[encoder->hpd_pin];\n\n\t \n\ti915_hotplug_interrupt_update(i915, hotplug_en, hotplug_en);\n}\n\nstatic void i915_hpd_irq_setup(struct drm_i915_private *dev_priv)\n{\n\tu32 hotplug_en;\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\t \n\thotplug_en = intel_hpd_enabled_irqs(dev_priv, hpd_mask_i915);\n\t \n\tif (IS_G4X(dev_priv))\n\t\thotplug_en |= CRT_HOTPLUG_ACTIVATION_PERIOD_64;\n\thotplug_en |= CRT_HOTPLUG_VOLTAGE_COMPARE_50;\n\n\t \n\ti915_hotplug_interrupt_update_locked(dev_priv,\n\t\t\t\t\t     HOTPLUG_INT_EN_MASK |\n\t\t\t\t\t     CRT_HOTPLUG_VOLTAGE_COMPARE_MASK |\n\t\t\t\t\t     CRT_HOTPLUG_ACTIVATION_PERIOD_64,\n\t\t\t\t\t     hotplug_en);\n}\n\nstruct intel_hotplug_funcs {\n\t \n\tvoid (*hpd_irq_setup)(struct drm_i915_private *i915);\n\t \n\tvoid (*hpd_enable_detection)(struct intel_encoder *encoder);\n};\n\n#define HPD_FUNCS(platform)\t\t\t\t\t \\\nstatic const struct intel_hotplug_funcs platform##_hpd_funcs = { \\\n\t.hpd_irq_setup = platform##_hpd_irq_setup,\t\t \\\n\t.hpd_enable_detection = platform##_hpd_enable_detection, \\\n}\n\nHPD_FUNCS(i915);\nHPD_FUNCS(xelpdp);\nHPD_FUNCS(dg1);\nHPD_FUNCS(gen11);\nHPD_FUNCS(bxt);\nHPD_FUNCS(icp);\nHPD_FUNCS(spt);\nHPD_FUNCS(ilk);\n#undef HPD_FUNCS\n\nvoid intel_hpd_enable_detection(struct intel_encoder *encoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(encoder->base.dev);\n\n\tif (i915->display.funcs.hotplug)\n\t\ti915->display.funcs.hotplug->hpd_enable_detection(encoder);\n}\n\nvoid intel_hpd_irq_setup(struct drm_i915_private *i915)\n{\n\tif (i915->display_irqs_enabled && i915->display.funcs.hotplug)\n\t\ti915->display.funcs.hotplug->hpd_irq_setup(i915);\n}\n\nvoid intel_hotplug_irq_init(struct drm_i915_private *i915)\n{\n\tintel_hpd_init_pins(i915);\n\n\tintel_hpd_init_early(i915);\n\n\tif (HAS_GMCH(i915)) {\n\t\tif (I915_HAS_HOTPLUG(i915))\n\t\t\ti915->display.funcs.hotplug = &i915_hpd_funcs;\n\t} else {\n\t\tif (HAS_PCH_DG2(i915))\n\t\t\ti915->display.funcs.hotplug = &icp_hpd_funcs;\n\t\telse if (HAS_PCH_DG1(i915))\n\t\t\ti915->display.funcs.hotplug = &dg1_hpd_funcs;\n\t\telse if (DISPLAY_VER(i915) >= 14)\n\t\t\ti915->display.funcs.hotplug = &xelpdp_hpd_funcs;\n\t\telse if (DISPLAY_VER(i915) >= 11)\n\t\t\ti915->display.funcs.hotplug = &gen11_hpd_funcs;\n\t\telse if (IS_GEMINILAKE(i915) || IS_BROXTON(i915))\n\t\t\ti915->display.funcs.hotplug = &bxt_hpd_funcs;\n\t\telse if (INTEL_PCH_TYPE(i915) >= PCH_ICP)\n\t\t\ti915->display.funcs.hotplug = &icp_hpd_funcs;\n\t\telse if (INTEL_PCH_TYPE(i915) >= PCH_SPT)\n\t\t\ti915->display.funcs.hotplug = &spt_hpd_funcs;\n\t\telse\n\t\t\ti915->display.funcs.hotplug = &ilk_hpd_funcs;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}