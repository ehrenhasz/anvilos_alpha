{
  "module_name": "intel_fb_pin.c",
  "hash_id": "2d515f6e96229e9ae3ca20332e80077ecc96d8da871825778f70fc36630ca369",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_fb_pin.c",
  "human_readable_source": "\n \n\n \n\n#include \"gem/i915_gem_domain.h\"\n#include \"gem/i915_gem_object.h\"\n\n#include \"i915_drv.h\"\n#include \"intel_display_types.h\"\n#include \"intel_dpt.h\"\n#include \"intel_fb.h\"\n#include \"intel_fb_pin.h\"\n\nstatic struct i915_vma *\nintel_pin_fb_obj_dpt(struct drm_framebuffer *fb,\n\t\t     const struct i915_gtt_view *view,\n\t\t     bool uses_fence,\n\t\t     unsigned long *out_flags,\n\t\t     struct i915_address_space *vm)\n{\n\tstruct drm_device *dev = fb->dev;\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tstruct drm_i915_gem_object *obj = intel_fb_obj(fb);\n\tstruct i915_gem_ww_ctx ww;\n\tstruct i915_vma *vma;\n\tu32 alignment;\n\tint ret;\n\n\t \n\tGEM_WARN_ON(vm->bind_async_flags);\n\n\tif (WARN_ON(!i915_gem_object_is_framebuffer(obj)))\n\t\treturn ERR_PTR(-EINVAL);\n\n\talignment = 4096 * 512;\n\n\tatomic_inc(&dev_priv->gpu_error.pending_fb_pin);\n\n\tfor_i915_gem_ww(&ww, ret, true) {\n\t\tret = i915_gem_object_lock(obj, &ww);\n\t\tif (ret)\n\t\t\tcontinue;\n\n\t\tif (HAS_LMEM(dev_priv)) {\n\t\t\tunsigned int flags = obj->flags;\n\n\t\t\t \n\t\t\tif (intel_fb_rc_ccs_cc_plane(fb) >= 0)\n\t\t\t\tflags &= ~I915_BO_ALLOC_GPU_ONLY;\n\t\t\tret = __i915_gem_object_migrate(obj, &ww, INTEL_REGION_LMEM_0,\n\t\t\t\t\t\t\tflags);\n\t\t\tif (ret)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tret = i915_gem_object_set_cache_level(obj, I915_CACHE_NONE);\n\t\tif (ret)\n\t\t\tcontinue;\n\n\t\tvma = i915_vma_instance(obj, vm, view);\n\t\tif (IS_ERR(vma)) {\n\t\t\tret = PTR_ERR(vma);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (i915_vma_misplaced(vma, 0, alignment, 0)) {\n\t\t\tret = i915_vma_unbind(vma);\n\t\t\tif (ret)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tret = i915_vma_pin_ww(vma, &ww, 0, alignment, PIN_GLOBAL);\n\t\tif (ret)\n\t\t\tcontinue;\n\t}\n\tif (ret) {\n\t\tvma = ERR_PTR(ret);\n\t\tgoto err;\n\t}\n\n\tvma->display_alignment = max(vma->display_alignment, alignment);\n\n\ti915_gem_object_flush_if_display(obj);\n\n\ti915_vma_get(vma);\nerr:\n\tatomic_dec(&dev_priv->gpu_error.pending_fb_pin);\n\n\treturn vma;\n}\n\nstruct i915_vma *\nintel_pin_and_fence_fb_obj(struct drm_framebuffer *fb,\n\t\t\t   bool phys_cursor,\n\t\t\t   const struct i915_gtt_view *view,\n\t\t\t   bool uses_fence,\n\t\t\t   unsigned long *out_flags)\n{\n\tstruct drm_device *dev = fb->dev;\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tstruct drm_i915_gem_object *obj = intel_fb_obj(fb);\n\tintel_wakeref_t wakeref;\n\tstruct i915_gem_ww_ctx ww;\n\tstruct i915_vma *vma;\n\tunsigned int pinctl;\n\tu32 alignment;\n\tint ret;\n\n\tif (drm_WARN_ON(dev, !i915_gem_object_is_framebuffer(obj)))\n\t\treturn ERR_PTR(-EINVAL);\n\n\tif (phys_cursor)\n\t\talignment = intel_cursor_alignment(dev_priv);\n\telse\n\t\talignment = intel_surf_alignment(fb, 0);\n\tif (drm_WARN_ON(dev, alignment && !is_power_of_2(alignment)))\n\t\treturn ERR_PTR(-EINVAL);\n\n\t \n\tif (intel_scanout_needs_vtd_wa(dev_priv) && alignment < 256 * 1024)\n\t\talignment = 256 * 1024;\n\n\t \n\twakeref = intel_runtime_pm_get(&dev_priv->runtime_pm);\n\n\tatomic_inc(&dev_priv->gpu_error.pending_fb_pin);\n\n\t \n\tpinctl = 0;\n\tif (HAS_GMCH(dev_priv))\n\t\tpinctl |= PIN_MAPPABLE;\n\n\ti915_gem_ww_ctx_init(&ww, true);\nretry:\n\tret = i915_gem_object_lock(obj, &ww);\n\tif (!ret && phys_cursor)\n\t\tret = i915_gem_object_attach_phys(obj, alignment);\n\telse if (!ret && HAS_LMEM(dev_priv))\n\t\tret = i915_gem_object_migrate(obj, &ww, INTEL_REGION_LMEM_0);\n\tif (!ret)\n\t\tret = i915_gem_object_pin_pages(obj);\n\tif (ret)\n\t\tgoto err;\n\n\tvma = i915_gem_object_pin_to_display_plane(obj, &ww, alignment,\n\t\t\t\t\t\t   view, pinctl);\n\tif (IS_ERR(vma)) {\n\t\tret = PTR_ERR(vma);\n\t\tgoto err_unpin;\n\t}\n\n\tif (uses_fence && i915_vma_is_map_and_fenceable(vma)) {\n\t\t \n\t\tret = i915_vma_pin_fence(vma);\n\t\tif (ret != 0 && DISPLAY_VER(dev_priv) < 4) {\n\t\t\ti915_vma_unpin(vma);\n\t\t\tgoto err_unpin;\n\t\t}\n\t\tret = 0;\n\n\t\tif (vma->fence)\n\t\t\t*out_flags |= PLANE_HAS_FENCE;\n\t}\n\n\ti915_vma_get(vma);\n\nerr_unpin:\n\ti915_gem_object_unpin_pages(obj);\nerr:\n\tif (ret == -EDEADLK) {\n\t\tret = i915_gem_ww_ctx_backoff(&ww);\n\t\tif (!ret)\n\t\t\tgoto retry;\n\t}\n\ti915_gem_ww_ctx_fini(&ww);\n\tif (ret)\n\t\tvma = ERR_PTR(ret);\n\n\tatomic_dec(&dev_priv->gpu_error.pending_fb_pin);\n\tintel_runtime_pm_put(&dev_priv->runtime_pm, wakeref);\n\treturn vma;\n}\n\nvoid intel_unpin_fb_vma(struct i915_vma *vma, unsigned long flags)\n{\n\tif (flags & PLANE_HAS_FENCE)\n\t\ti915_vma_unpin_fence(vma);\n\ti915_vma_unpin(vma);\n\ti915_vma_put(vma);\n}\n\nint intel_plane_pin_fb(struct intel_plane_state *plane_state)\n{\n\tstruct intel_plane *plane = to_intel_plane(plane_state->uapi.plane);\n\tstruct drm_i915_private *dev_priv = to_i915(plane->base.dev);\n\tstruct drm_framebuffer *fb = plane_state->hw.fb;\n\tstruct i915_vma *vma;\n\tbool phys_cursor =\n\t\tplane->id == PLANE_CURSOR &&\n\t\tDISPLAY_INFO(dev_priv)->cursor_needs_physical;\n\n\tif (!intel_fb_uses_dpt(fb)) {\n\t\tvma = intel_pin_and_fence_fb_obj(fb, phys_cursor,\n\t\t\t\t\t\t &plane_state->view.gtt,\n\t\t\t\t\t\t intel_plane_uses_fence(plane_state),\n\t\t\t\t\t\t &plane_state->flags);\n\t\tif (IS_ERR(vma))\n\t\t\treturn PTR_ERR(vma);\n\n\t\tplane_state->ggtt_vma = vma;\n\t} else {\n\t\tstruct intel_framebuffer *intel_fb = to_intel_framebuffer(fb);\n\n\t\tvma = intel_dpt_pin(intel_fb->dpt_vm);\n\t\tif (IS_ERR(vma))\n\t\t\treturn PTR_ERR(vma);\n\n\t\tplane_state->ggtt_vma = vma;\n\n\t\tvma = intel_pin_fb_obj_dpt(fb, &plane_state->view.gtt, false,\n\t\t\t\t\t   &plane_state->flags, intel_fb->dpt_vm);\n\t\tif (IS_ERR(vma)) {\n\t\t\tintel_dpt_unpin(intel_fb->dpt_vm);\n\t\t\tplane_state->ggtt_vma = NULL;\n\t\t\treturn PTR_ERR(vma);\n\t\t}\n\n\t\tplane_state->dpt_vma = vma;\n\n\t\tWARN_ON(plane_state->ggtt_vma == plane_state->dpt_vma);\n\t}\n\n\treturn 0;\n}\n\nvoid intel_plane_unpin_fb(struct intel_plane_state *old_plane_state)\n{\n\tstruct drm_framebuffer *fb = old_plane_state->hw.fb;\n\tstruct i915_vma *vma;\n\n\tif (!intel_fb_uses_dpt(fb)) {\n\t\tvma = fetch_and_zero(&old_plane_state->ggtt_vma);\n\t\tif (vma)\n\t\t\tintel_unpin_fb_vma(vma, old_plane_state->flags);\n\t} else {\n\t\tstruct intel_framebuffer *intel_fb = to_intel_framebuffer(fb);\n\n\t\tvma = fetch_and_zero(&old_plane_state->dpt_vma);\n\t\tif (vma)\n\t\t\tintel_unpin_fb_vma(vma, old_plane_state->flags);\n\n\t\tvma = fetch_and_zero(&old_plane_state->ggtt_vma);\n\t\tif (vma)\n\t\t\tintel_dpt_unpin(intel_fb->dpt_vm);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}