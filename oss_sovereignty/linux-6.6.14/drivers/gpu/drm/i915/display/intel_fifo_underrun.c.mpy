{
  "module_name": "intel_fifo_underrun.c",
  "hash_id": "db9229f70ae9ccdd32bf42a75237ceadc07c063770b0a2919fcd3fdc745cd882",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_fifo_underrun.c",
  "human_readable_source": " \n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_de.h\"\n#include \"intel_display_irq.h\"\n#include \"intel_display_trace.h\"\n#include \"intel_display_types.h\"\n#include \"intel_fbc.h\"\n#include \"intel_fifo_underrun.h\"\n#include \"intel_pch_display.h\"\n\n \n\nstatic bool ivb_can_enable_err_int(struct drm_device *dev)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tstruct intel_crtc *crtc;\n\tenum pipe pipe;\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\tfor_each_pipe(dev_priv, pipe) {\n\t\tcrtc = intel_crtc_for_pipe(dev_priv, pipe);\n\n\t\tif (crtc->cpu_fifo_underrun_disabled)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic bool cpt_can_enable_serr_int(struct drm_device *dev)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tenum pipe pipe;\n\tstruct intel_crtc *crtc;\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\tfor_each_pipe(dev_priv, pipe) {\n\t\tcrtc = intel_crtc_for_pipe(dev_priv, pipe);\n\n\t\tif (crtc->pch_fifo_underrun_disabled)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void i9xx_check_fifo_underruns(struct intel_crtc *crtc)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\ti915_reg_t reg = PIPESTAT(crtc->pipe);\n\tu32 enable_mask;\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\tif ((intel_de_read(dev_priv, reg) & PIPE_FIFO_UNDERRUN_STATUS) == 0)\n\t\treturn;\n\n\tenable_mask = i915_pipestat_enable_mask(dev_priv, crtc->pipe);\n\tintel_de_write(dev_priv, reg, enable_mask | PIPE_FIFO_UNDERRUN_STATUS);\n\tintel_de_posting_read(dev_priv, reg);\n\n\ttrace_intel_cpu_fifo_underrun(dev_priv, crtc->pipe);\n\tdrm_err(&dev_priv->drm, \"pipe %c underrun\\n\", pipe_name(crtc->pipe));\n}\n\nstatic void i9xx_set_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t     enum pipe pipe,\n\t\t\t\t\t     bool enable, bool old)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\ti915_reg_t reg = PIPESTAT(pipe);\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\tif (enable) {\n\t\tu32 enable_mask = i915_pipestat_enable_mask(dev_priv, pipe);\n\n\t\tintel_de_write(dev_priv, reg,\n\t\t\t       enable_mask | PIPE_FIFO_UNDERRUN_STATUS);\n\t\tintel_de_posting_read(dev_priv, reg);\n\t} else {\n\t\tif (old && intel_de_read(dev_priv, reg) & PIPE_FIFO_UNDERRUN_STATUS)\n\t\t\tdrm_err(&dev_priv->drm, \"pipe %c underrun\\n\",\n\t\t\t\tpipe_name(pipe));\n\t}\n}\n\nstatic void ilk_set_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t    enum pipe pipe, bool enable)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tu32 bit = (pipe == PIPE_A) ?\n\t\tDE_PIPEA_FIFO_UNDERRUN : DE_PIPEB_FIFO_UNDERRUN;\n\n\tif (enable)\n\t\tilk_enable_display_irq(dev_priv, bit);\n\telse\n\t\tilk_disable_display_irq(dev_priv, bit);\n}\n\nstatic void ivb_check_fifo_underruns(struct intel_crtc *crtc)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tenum pipe pipe = crtc->pipe;\n\tu32 err_int = intel_de_read(dev_priv, GEN7_ERR_INT);\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\tif ((err_int & ERR_INT_FIFO_UNDERRUN(pipe)) == 0)\n\t\treturn;\n\n\tintel_de_write(dev_priv, GEN7_ERR_INT, ERR_INT_FIFO_UNDERRUN(pipe));\n\tintel_de_posting_read(dev_priv, GEN7_ERR_INT);\n\n\ttrace_intel_cpu_fifo_underrun(dev_priv, pipe);\n\tdrm_err(&dev_priv->drm, \"fifo underrun on pipe %c\\n\", pipe_name(pipe));\n}\n\nstatic void ivb_set_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t    enum pipe pipe, bool enable,\n\t\t\t\t\t    bool old)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tif (enable) {\n\t\tintel_de_write(dev_priv, GEN7_ERR_INT,\n\t\t\t       ERR_INT_FIFO_UNDERRUN(pipe));\n\n\t\tif (!ivb_can_enable_err_int(dev))\n\t\t\treturn;\n\n\t\tilk_enable_display_irq(dev_priv, DE_ERR_INT_IVB);\n\t} else {\n\t\tilk_disable_display_irq(dev_priv, DE_ERR_INT_IVB);\n\n\t\tif (old &&\n\t\t    intel_de_read(dev_priv, GEN7_ERR_INT) & ERR_INT_FIFO_UNDERRUN(pipe)) {\n\t\t\tdrm_err(&dev_priv->drm,\n\t\t\t\t\"uncleared fifo underrun on pipe %c\\n\",\n\t\t\t\tpipe_name(pipe));\n\t\t}\n\t}\n}\n\nstatic u32\nicl_pipe_status_underrun_mask(struct drm_i915_private *dev_priv)\n{\n\tu32 mask = PIPE_STATUS_UNDERRUN;\n\n\tif (DISPLAY_VER(dev_priv) >= 13)\n\t\tmask |= PIPE_STATUS_SOFT_UNDERRUN_XELPD |\n\t\t\tPIPE_STATUS_HARD_UNDERRUN_XELPD |\n\t\t\tPIPE_STATUS_PORT_UNDERRUN_XELPD;\n\n\treturn mask;\n}\n\nstatic void bdw_set_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t    enum pipe pipe, bool enable)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tu32 mask = gen8_de_pipe_underrun_mask(dev_priv);\n\n\tif (enable) {\n\t\tif (DISPLAY_VER(dev_priv) >= 11)\n\t\t\tintel_de_write(dev_priv, ICL_PIPESTATUS(pipe),\n\t\t\t\t       icl_pipe_status_underrun_mask(dev_priv));\n\n\t\tbdw_enable_pipe_irq(dev_priv, pipe, mask);\n\t} else {\n\t\tbdw_disable_pipe_irq(dev_priv, pipe, mask);\n\t}\n}\n\nstatic void ibx_set_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t    enum pipe pch_transcoder,\n\t\t\t\t\t    bool enable)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tu32 bit = (pch_transcoder == PIPE_A) ?\n\t\tSDE_TRANSA_FIFO_UNDER : SDE_TRANSB_FIFO_UNDER;\n\n\tif (enable)\n\t\tibx_enable_display_interrupt(dev_priv, bit);\n\telse\n\t\tibx_disable_display_interrupt(dev_priv, bit);\n}\n\nstatic void cpt_check_pch_fifo_underruns(struct intel_crtc *crtc)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tenum pipe pch_transcoder = crtc->pipe;\n\tu32 serr_int = intel_de_read(dev_priv, SERR_INT);\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\tif ((serr_int & SERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder)) == 0)\n\t\treturn;\n\n\tintel_de_write(dev_priv, SERR_INT,\n\t\t       SERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder));\n\tintel_de_posting_read(dev_priv, SERR_INT);\n\n\ttrace_intel_pch_fifo_underrun(dev_priv, pch_transcoder);\n\tdrm_err(&dev_priv->drm, \"pch fifo underrun on pch transcoder %c\\n\",\n\t\tpipe_name(pch_transcoder));\n}\n\nstatic void cpt_set_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t    enum pipe pch_transcoder,\n\t\t\t\t\t    bool enable, bool old)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\n\tif (enable) {\n\t\tintel_de_write(dev_priv, SERR_INT,\n\t\t\t       SERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder));\n\n\t\tif (!cpt_can_enable_serr_int(dev))\n\t\t\treturn;\n\n\t\tibx_enable_display_interrupt(dev_priv, SDE_ERROR_CPT);\n\t} else {\n\t\tibx_disable_display_interrupt(dev_priv, SDE_ERROR_CPT);\n\n\t\tif (old && intel_de_read(dev_priv, SERR_INT) &\n\t\t    SERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder)) {\n\t\t\tdrm_err(&dev_priv->drm,\n\t\t\t\t\"uncleared pch fifo underrun on pch transcoder %c\\n\",\n\t\t\t\tpipe_name(pch_transcoder));\n\t\t}\n\t}\n}\n\nstatic bool __intel_set_cpu_fifo_underrun_reporting(struct drm_device *dev,\n\t\t\t\t\t\t    enum pipe pipe, bool enable)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tstruct intel_crtc *crtc = intel_crtc_for_pipe(dev_priv, pipe);\n\tbool old;\n\n\tlockdep_assert_held(&dev_priv->irq_lock);\n\n\told = !crtc->cpu_fifo_underrun_disabled;\n\tcrtc->cpu_fifo_underrun_disabled = !enable;\n\n\tif (HAS_GMCH(dev_priv))\n\t\ti9xx_set_fifo_underrun_reporting(dev, pipe, enable, old);\n\telse if (IS_IRONLAKE(dev_priv) || IS_SANDYBRIDGE(dev_priv))\n\t\tilk_set_fifo_underrun_reporting(dev, pipe, enable);\n\telse if (DISPLAY_VER(dev_priv) == 7)\n\t\tivb_set_fifo_underrun_reporting(dev, pipe, enable, old);\n\telse if (DISPLAY_VER(dev_priv) >= 8)\n\t\tbdw_set_fifo_underrun_reporting(dev, pipe, enable);\n\n\treturn old;\n}\n\n \nbool intel_set_cpu_fifo_underrun_reporting(struct drm_i915_private *dev_priv,\n\t\t\t\t\t   enum pipe pipe, bool enable)\n{\n\tunsigned long flags;\n\tbool ret;\n\n\tspin_lock_irqsave(&dev_priv->irq_lock, flags);\n\tret = __intel_set_cpu_fifo_underrun_reporting(&dev_priv->drm, pipe,\n\t\t\t\t\t\t      enable);\n\tspin_unlock_irqrestore(&dev_priv->irq_lock, flags);\n\n\treturn ret;\n}\n\n \nbool intel_set_pch_fifo_underrun_reporting(struct drm_i915_private *dev_priv,\n\t\t\t\t\t   enum pipe pch_transcoder,\n\t\t\t\t\t   bool enable)\n{\n\tstruct intel_crtc *crtc =\n\t\tintel_crtc_for_pipe(dev_priv, pch_transcoder);\n\tunsigned long flags;\n\tbool old;\n\n\t \n\n\tspin_lock_irqsave(&dev_priv->irq_lock, flags);\n\n\told = !crtc->pch_fifo_underrun_disabled;\n\tcrtc->pch_fifo_underrun_disabled = !enable;\n\n\tif (HAS_PCH_IBX(dev_priv))\n\t\tibx_set_fifo_underrun_reporting(&dev_priv->drm,\n\t\t\t\t\t\tpch_transcoder,\n\t\t\t\t\t\tenable);\n\telse\n\t\tcpt_set_fifo_underrun_reporting(&dev_priv->drm,\n\t\t\t\t\t\tpch_transcoder,\n\t\t\t\t\t\tenable, old);\n\n\tspin_unlock_irqrestore(&dev_priv->irq_lock, flags);\n\treturn old;\n}\n\n \nvoid intel_cpu_fifo_underrun_irq_handler(struct drm_i915_private *dev_priv,\n\t\t\t\t\t enum pipe pipe)\n{\n\tstruct intel_crtc *crtc = intel_crtc_for_pipe(dev_priv, pipe);\n\tu32 underruns = 0;\n\n\t \n\tif (crtc == NULL)\n\t\treturn;\n\n\t \n\tif (HAS_GMCH(dev_priv) &&\n\t    crtc->cpu_fifo_underrun_disabled)\n\t\treturn;\n\n\t \n\tif (DISPLAY_VER(dev_priv) >= 11) {\n\t\tunderruns = intel_de_read(dev_priv, ICL_PIPESTATUS(pipe)) &\n\t\t\ticl_pipe_status_underrun_mask(dev_priv);\n\t\tintel_de_write(dev_priv, ICL_PIPESTATUS(pipe), underruns);\n\t}\n\n\tif (intel_set_cpu_fifo_underrun_reporting(dev_priv, pipe, false)) {\n\t\ttrace_intel_cpu_fifo_underrun(dev_priv, pipe);\n\n\t\tif (DISPLAY_VER(dev_priv) >= 11)\n\t\t\tdrm_err(&dev_priv->drm, \"CPU pipe %c FIFO underrun: %s%s%s%s\\n\",\n\t\t\t\tpipe_name(pipe),\n\t\t\t\tunderruns & PIPE_STATUS_SOFT_UNDERRUN_XELPD ? \"soft,\" : \"\",\n\t\t\t\tunderruns & PIPE_STATUS_HARD_UNDERRUN_XELPD ? \"hard,\" : \"\",\n\t\t\t\tunderruns & PIPE_STATUS_PORT_UNDERRUN_XELPD ? \"port,\" : \"\",\n\t\t\t\tunderruns & PIPE_STATUS_UNDERRUN ? \"transcoder,\" : \"\");\n\t\telse\n\t\t\tdrm_err(&dev_priv->drm, \"CPU pipe %c FIFO underrun\\n\", pipe_name(pipe));\n\t}\n\n\tintel_fbc_handle_fifo_underrun_irq(dev_priv);\n}\n\n \nvoid intel_pch_fifo_underrun_irq_handler(struct drm_i915_private *dev_priv,\n\t\t\t\t\t enum pipe pch_transcoder)\n{\n\tif (intel_set_pch_fifo_underrun_reporting(dev_priv, pch_transcoder,\n\t\t\t\t\t\t  false)) {\n\t\ttrace_intel_pch_fifo_underrun(dev_priv, pch_transcoder);\n\t\tdrm_err(&dev_priv->drm, \"PCH transcoder %c FIFO underrun\\n\",\n\t\t\tpipe_name(pch_transcoder));\n\t}\n}\n\n \nvoid intel_check_cpu_fifo_underruns(struct drm_i915_private *dev_priv)\n{\n\tstruct intel_crtc *crtc;\n\n\tspin_lock_irq(&dev_priv->irq_lock);\n\n\tfor_each_intel_crtc(&dev_priv->drm, crtc) {\n\t\tif (crtc->cpu_fifo_underrun_disabled)\n\t\t\tcontinue;\n\n\t\tif (HAS_GMCH(dev_priv))\n\t\t\ti9xx_check_fifo_underruns(crtc);\n\t\telse if (DISPLAY_VER(dev_priv) == 7)\n\t\t\tivb_check_fifo_underruns(crtc);\n\t}\n\n\tspin_unlock_irq(&dev_priv->irq_lock);\n}\n\n \nvoid intel_check_pch_fifo_underruns(struct drm_i915_private *dev_priv)\n{\n\tstruct intel_crtc *crtc;\n\n\tspin_lock_irq(&dev_priv->irq_lock);\n\n\tfor_each_intel_crtc(&dev_priv->drm, crtc) {\n\t\tif (crtc->pch_fifo_underrun_disabled)\n\t\t\tcontinue;\n\n\t\tif (HAS_PCH_CPT(dev_priv))\n\t\t\tcpt_check_pch_fifo_underruns(crtc);\n\t}\n\n\tspin_unlock_irq(&dev_priv->irq_lock);\n}\n\nvoid intel_init_fifo_underrun_reporting(struct drm_i915_private *i915,\n\t\t\t\t\tstruct intel_crtc *crtc,\n\t\t\t\t\tbool enable)\n{\n\tcrtc->cpu_fifo_underrun_disabled = !enable;\n\n\t \n\tif (intel_has_pch_trancoder(i915, crtc->pipe))\n\t\tcrtc->pch_fifo_underrun_disabled = !enable;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}