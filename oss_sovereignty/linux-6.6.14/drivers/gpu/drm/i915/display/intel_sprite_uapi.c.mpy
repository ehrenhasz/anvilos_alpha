{
  "module_name": "intel_sprite_uapi.c",
  "hash_id": "601691bdda19463c673e63a0efcc6d60308f6557d3efd6eaaa773ffc938c204e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_sprite_uapi.c",
  "human_readable_source": "\n \n\n#include \"i915_drv.h\"\n#include \"intel_crtc.h\"\n#include \"intel_display_types.h\"\n#include \"intel_sprite_uapi.h\"\n\nstatic bool has_dst_key_in_primary_plane(struct drm_i915_private *dev_priv)\n{\n\treturn DISPLAY_VER(dev_priv) >= 9;\n}\n\nstatic void intel_plane_set_ckey(struct intel_plane_state *plane_state,\n\t\t\t\t const struct drm_intel_sprite_colorkey *set)\n{\n\tstruct intel_plane *plane = to_intel_plane(plane_state->uapi.plane);\n\tstruct drm_i915_private *dev_priv = to_i915(plane->base.dev);\n\tstruct drm_intel_sprite_colorkey *key = &plane_state->ckey;\n\n\t*key = *set;\n\n\t \n\tif (plane->id == PLANE_PRIMARY &&\n\t    set->flags & I915_SET_COLORKEY_SOURCE)\n\t\tkey->flags = 0;\n\n\t \n\tif (DISPLAY_VER(dev_priv) >= 9 && plane->id != PLANE_PRIMARY &&\n\t    set->flags & I915_SET_COLORKEY_DESTINATION)\n\t\tkey->flags = 0;\n}\n\nint intel_sprite_set_colorkey_ioctl(struct drm_device *dev, void *data,\n\t\t\t\t    struct drm_file *file_priv)\n{\n\tstruct drm_i915_private *dev_priv = to_i915(dev);\n\tstruct drm_intel_sprite_colorkey *set = data;\n\tstruct drm_plane *plane;\n\tstruct drm_plane_state *plane_state;\n\tstruct drm_atomic_state *state;\n\tstruct drm_modeset_acquire_ctx ctx;\n\tint ret = 0;\n\n\t \n\tset->flags &= ~I915_SET_COLORKEY_NONE;\n\n\tif (set->flags & ~(I915_SET_COLORKEY_DESTINATION | I915_SET_COLORKEY_SOURCE))\n\t\treturn -EINVAL;\n\n\t \n\tif ((set->flags & (I915_SET_COLORKEY_DESTINATION | I915_SET_COLORKEY_SOURCE)) == (I915_SET_COLORKEY_DESTINATION | I915_SET_COLORKEY_SOURCE))\n\t\treturn -EINVAL;\n\n\tif ((IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv)) &&\n\t    set->flags & I915_SET_COLORKEY_DESTINATION)\n\t\treturn -EINVAL;\n\n\tplane = drm_plane_find(dev, file_priv, set->plane_id);\n\tif (!plane || plane->type != DRM_PLANE_TYPE_OVERLAY)\n\t\treturn -ENOENT;\n\n\t \n\tif (DISPLAY_VER(dev_priv) >= 9 &&\n\t    to_intel_plane(plane)->id >= PLANE_SPRITE1 &&\n\t    set->flags & I915_SET_COLORKEY_DESTINATION)\n\t\treturn -EINVAL;\n\n\tdrm_modeset_acquire_init(&ctx, 0);\n\n\tstate = drm_atomic_state_alloc(plane->dev);\n\tif (!state) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\tstate->acquire_ctx = &ctx;\n\tto_intel_atomic_state(state)->internal = true;\n\n\twhile (1) {\n\t\tplane_state = drm_atomic_get_plane_state(state, plane);\n\t\tret = PTR_ERR_OR_ZERO(plane_state);\n\t\tif (!ret)\n\t\t\tintel_plane_set_ckey(to_intel_plane_state(plane_state), set);\n\n\t\t \n\t\tif (!ret && has_dst_key_in_primary_plane(dev_priv)) {\n\t\t\tstruct intel_crtc *crtc =\n\t\t\t\tintel_crtc_for_pipe(dev_priv,\n\t\t\t\t\t\t    to_intel_plane(plane)->pipe);\n\n\t\t\tplane_state = drm_atomic_get_plane_state(state,\n\t\t\t\t\t\t\t\t crtc->base.primary);\n\t\t\tret = PTR_ERR_OR_ZERO(plane_state);\n\t\t\tif (!ret)\n\t\t\t\tintel_plane_set_ckey(to_intel_plane_state(plane_state), set);\n\t\t}\n\n\t\tif (!ret)\n\t\t\tret = drm_atomic_commit(state);\n\n\t\tif (ret != -EDEADLK)\n\t\t\tbreak;\n\n\t\tdrm_atomic_state_clear(state);\n\t\tdrm_modeset_backoff(&ctx);\n\t}\n\n\tdrm_atomic_state_put(state);\nout:\n\tdrm_modeset_drop_locks(&ctx);\n\tdrm_modeset_acquire_fini(&ctx);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}