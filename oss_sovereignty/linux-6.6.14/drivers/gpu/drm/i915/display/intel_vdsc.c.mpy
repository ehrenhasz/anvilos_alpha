{
  "module_name": "intel_vdsc.c",
  "hash_id": "7229177d0f5daa4c3b997295d5d0084f5b22eff40b8f0d3d8835cea166ee6e1f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_vdsc.c",
  "human_readable_source": "\n \n#include <linux/limits.h>\n\n#include <drm/display/drm_dsc_helper.h>\n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_crtc.h\"\n#include \"intel_de.h\"\n#include \"intel_display_types.h\"\n#include \"intel_dsi.h\"\n#include \"intel_qp_tables.h\"\n#include \"intel_vdsc.h\"\n#include \"intel_vdsc_regs.h\"\n\nbool intel_dsc_source_support(const struct intel_crtc_state *crtc_state)\n{\n\tconst struct intel_crtc *crtc = to_intel_crtc(crtc_state->uapi.crtc);\n\tstruct drm_i915_private *i915 = to_i915(crtc->base.dev);\n\tenum transcoder cpu_transcoder = crtc_state->cpu_transcoder;\n\n\tif (!HAS_DSC(i915))\n\t\treturn false;\n\n\tif (DISPLAY_VER(i915) == 11 && cpu_transcoder == TRANSCODER_A)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic bool is_pipe_dsc(struct intel_crtc *crtc, enum transcoder cpu_transcoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(crtc->base.dev);\n\n\tif (DISPLAY_VER(i915) >= 12)\n\t\treturn true;\n\n\tif (cpu_transcoder == TRANSCODER_EDP ||\n\t    cpu_transcoder == TRANSCODER_DSI_0 ||\n\t    cpu_transcoder == TRANSCODER_DSI_1)\n\t\treturn false;\n\n\t \n\tdrm_WARN_ON(&i915->drm, crtc->pipe == PIPE_A);\n\n\treturn true;\n}\n\nstatic void\nintel_vdsc_set_min_max_qp(struct drm_dsc_config *vdsc_cfg, int buf,\n\t\t\t  int bpp)\n{\n\tint bpc = vdsc_cfg->bits_per_component;\n\n\t \n\tvdsc_cfg->rc_range_params[buf].range_min_qp =\n\t\tintel_lookup_range_min_qp(bpc, buf, bpp, vdsc_cfg->native_420);\n\tvdsc_cfg->rc_range_params[buf].range_max_qp =\n\t\tintel_lookup_range_max_qp(bpc, buf, bpp, vdsc_cfg->native_420);\n}\n\n \nstatic void\ncalculate_rc_params(struct drm_dsc_config *vdsc_cfg)\n{\n\tint bpc = vdsc_cfg->bits_per_component;\n\tint bpp = vdsc_cfg->bits_per_pixel >> 4;\n\tint qp_bpc_modifier = (bpc - 8) * 2;\n\tu32 res, buf_i, bpp_i;\n\n\tif (vdsc_cfg->slice_height >= 8)\n\t\tvdsc_cfg->first_line_bpg_offset =\n\t\t\t12 + DIV_ROUND_UP((9 * min(34, vdsc_cfg->slice_height - 8)), 100);\n\telse\n\t\tvdsc_cfg->first_line_bpg_offset = 2 * (vdsc_cfg->slice_height - 1);\n\n\t \n\tif (vdsc_cfg->native_420) {\n\t\tif (vdsc_cfg->slice_height >= 8)\n\t\t\tvdsc_cfg->second_line_bpg_offset = 12;\n\t\telse\n\t\t\tvdsc_cfg->second_line_bpg_offset =\n\t\t\t\t2 * (vdsc_cfg->slice_height - 1);\n\n\t\tvdsc_cfg->second_line_offset_adj = 512;\n\t\tvdsc_cfg->nsl_bpg_offset = DIV_ROUND_UP(vdsc_cfg->second_line_bpg_offset << 11,\n\t\t\t\t\t\t\tvdsc_cfg->slice_height - 1);\n\t}\n\n\t \n\tif (bpp >= 12)\n\t\tvdsc_cfg->initial_offset = 2048;\n\telse if (bpp >= 10)\n\t\tvdsc_cfg->initial_offset = 5632 - DIV_ROUND_UP(((bpp - 10) * 3584), 2);\n\telse if (bpp >= 8)\n\t\tvdsc_cfg->initial_offset = 6144 - DIV_ROUND_UP(((bpp - 8) * 512), 2);\n\telse\n\t\tvdsc_cfg->initial_offset = 6144;\n\n\t \n\tvdsc_cfg->initial_xmit_delay = DIV_ROUND_UP(DSC_RC_MODEL_SIZE_CONST, 2 * bpp);\n\n\tvdsc_cfg->flatness_min_qp = 3 + qp_bpc_modifier;\n\tvdsc_cfg->flatness_max_qp = 12 + qp_bpc_modifier;\n\n\tvdsc_cfg->rc_quant_incr_limit0 = 11 + qp_bpc_modifier;\n\tvdsc_cfg->rc_quant_incr_limit1 = 11 + qp_bpc_modifier;\n\n\tif (vdsc_cfg->native_420) {\n\t\tstatic const s8 ofs_und4[] = {\n\t\t\t2, 0, 0, -2, -4, -6, -8, -8, -8, -10, -10, -12, -12, -12, -12\n\t\t};\n\t\tstatic const s8 ofs_und5[] = {\n\t\t\t2, 0, 0, -2, -4, -6, -8, -8, -8, -10, -10, -10, -12, -12, -12\n\t\t};\n\t\tstatic const s8 ofs_und6[] = {\n\t\t\t2, 0, 0, -2, -4, -6, -8, -8, -8, -10, -10, -10, -12, -12, -12\n\t\t};\n\t\tstatic const s8 ofs_und8[] = {\n\t\t\t10, 8, 6, 4, 2, 0, -2, -4, -6, -8, -10, -10, -12, -12, -12\n\t\t};\n\n\t\tbpp_i  = bpp - 8;\n\t\tfor (buf_i = 0; buf_i < DSC_NUM_BUF_RANGES; buf_i++) {\n\t\t\tu8 range_bpg_offset;\n\n\t\t\tintel_vdsc_set_min_max_qp(vdsc_cfg, buf_i, bpp_i);\n\n\t\t\t \n\t\t\tif (bpp <= 8) {\n\t\t\t\trange_bpg_offset = ofs_und4[buf_i];\n\t\t\t} else if (bpp <= 10) {\n\t\t\t\tres = DIV_ROUND_UP(((bpp - 8) *\n\t\t\t\t\t\t    (ofs_und5[buf_i] - ofs_und4[buf_i])), 2);\n\t\t\t\trange_bpg_offset = ofs_und4[buf_i] + res;\n\t\t\t} else if (bpp <= 12) {\n\t\t\t\tres = DIV_ROUND_UP(((bpp - 10) *\n\t\t\t\t\t\t    (ofs_und6[buf_i] - ofs_und5[buf_i])), 2);\n\t\t\t\trange_bpg_offset = ofs_und5[buf_i] + res;\n\t\t\t} else if (bpp <= 16) {\n\t\t\t\tres = DIV_ROUND_UP(((bpp - 12) *\n\t\t\t\t\t\t    (ofs_und8[buf_i] - ofs_und6[buf_i])), 4);\n\t\t\t\trange_bpg_offset = ofs_und6[buf_i] + res;\n\t\t\t} else {\n\t\t\t\trange_bpg_offset = ofs_und8[buf_i];\n\t\t\t}\n\n\t\t\tvdsc_cfg->rc_range_params[buf_i].range_bpg_offset =\n\t\t\t\trange_bpg_offset & DSC_RANGE_BPG_OFFSET_MASK;\n\t\t}\n\t} else {\n\t\tstatic const s8 ofs_und6[] = {\n\t\t\t0, -2, -2, -4, -6, -6, -8, -8, -8, -10, -10, -12, -12, -12, -12\n\t\t};\n\t\tstatic const s8 ofs_und8[] = {\n\t\t\t2, 0, 0, -2, -4, -6, -8, -8, -8, -10, -10, -10, -12, -12, -12\n\t\t};\n\t\tstatic const s8 ofs_und12[] = {\n\t\t\t2, 0, 0, -2, -4, -6, -8, -8, -8, -10, -10, -10, -12, -12, -12\n\t\t};\n\t\tstatic const s8 ofs_und15[] = {\n\t\t\t10, 8, 6, 4, 2, 0, -2, -4, -6, -8, -10, -10, -12, -12, -12\n\t\t};\n\n\t\tbpp_i  = (2 * (bpp - 6));\n\t\tfor (buf_i = 0; buf_i < DSC_NUM_BUF_RANGES; buf_i++) {\n\t\t\tu8 range_bpg_offset;\n\n\t\t\tintel_vdsc_set_min_max_qp(vdsc_cfg, buf_i, bpp_i);\n\n\t\t\t \n\t\t\tif (bpp <= 6) {\n\t\t\t\trange_bpg_offset = ofs_und6[buf_i];\n\t\t\t} else if (bpp <= 8) {\n\t\t\t\tres = DIV_ROUND_UP(((bpp - 6) *\n\t\t\t\t\t\t    (ofs_und8[buf_i] - ofs_und6[buf_i])), 2);\n\t\t\t\trange_bpg_offset = ofs_und6[buf_i] + res;\n\t\t\t} else if (bpp <= 12) {\n\t\t\t\trange_bpg_offset = ofs_und8[buf_i];\n\t\t\t} else if (bpp <= 15) {\n\t\t\t\tres = DIV_ROUND_UP(((bpp - 12) *\n\t\t\t\t\t\t    (ofs_und15[buf_i] - ofs_und12[buf_i])), 3);\n\t\t\t\trange_bpg_offset = ofs_und12[buf_i] + res;\n\t\t\t} else {\n\t\t\t\trange_bpg_offset = ofs_und15[buf_i];\n\t\t\t}\n\n\t\t\tvdsc_cfg->rc_range_params[buf_i].range_bpg_offset =\n\t\t\t\trange_bpg_offset & DSC_RANGE_BPG_OFFSET_MASK;\n\t\t}\n\t}\n}\n\nstatic int intel_dsc_slice_dimensions_valid(struct intel_crtc_state *pipe_config,\n\t\t\t\t\t    struct drm_dsc_config *vdsc_cfg)\n{\n\tif (pipe_config->output_format == INTEL_OUTPUT_FORMAT_RGB ||\n\t    pipe_config->output_format == INTEL_OUTPUT_FORMAT_YCBCR444) {\n\t\tif (vdsc_cfg->slice_height > 4095)\n\t\t\treturn -EINVAL;\n\t\tif (vdsc_cfg->slice_height * vdsc_cfg->slice_width < 15000)\n\t\t\treturn -EINVAL;\n\t} else if (pipe_config->output_format == INTEL_OUTPUT_FORMAT_YCBCR420) {\n\t\tif (vdsc_cfg->slice_width % 2)\n\t\t\treturn -EINVAL;\n\t\tif (vdsc_cfg->slice_height % 2)\n\t\t\treturn -EINVAL;\n\t\tif (vdsc_cfg->slice_height > 4094)\n\t\t\treturn -EINVAL;\n\t\tif (vdsc_cfg->slice_height * vdsc_cfg->slice_width < 30000)\n\t\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nint intel_dsc_compute_params(struct intel_crtc_state *pipe_config)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(pipe_config->uapi.crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tstruct drm_dsc_config *vdsc_cfg = &pipe_config->dsc.config;\n\tu16 compressed_bpp = pipe_config->dsc.compressed_bpp;\n\tint err;\n\tint ret;\n\n\tvdsc_cfg->pic_width = pipe_config->hw.adjusted_mode.crtc_hdisplay;\n\tvdsc_cfg->slice_width = DIV_ROUND_UP(vdsc_cfg->pic_width,\n\t\t\t\t\t     pipe_config->dsc.slice_count);\n\n\terr = intel_dsc_slice_dimensions_valid(pipe_config, vdsc_cfg);\n\n\tif (err) {\n\t\tdrm_dbg_kms(&dev_priv->drm, \"Slice dimension requirements not met\\n\");\n\t\treturn err;\n\t}\n\n\t \n\tvdsc_cfg->convert_rgb = pipe_config->output_format != INTEL_OUTPUT_FORMAT_YCBCR420 &&\n\t\t\t\tpipe_config->output_format != INTEL_OUTPUT_FORMAT_YCBCR444;\n\n\tif (DISPLAY_VER(dev_priv) >= 14 &&\n\t    pipe_config->output_format == INTEL_OUTPUT_FORMAT_YCBCR420)\n\t\tvdsc_cfg->native_420 = true;\n\t \n\tvdsc_cfg->native_422 = false;\n\tvdsc_cfg->simple_422 = false;\n\t \n\tvdsc_cfg->vbr_enable = false;\n\n\t \n\tvdsc_cfg->bits_per_pixel = compressed_bpp << 4;\n\n\t \n\tif (vdsc_cfg->native_420)\n\t\tvdsc_cfg->bits_per_pixel <<= 1;\n\n\tvdsc_cfg->bits_per_component = pipe_config->pipe_bpp / 3;\n\n\tdrm_dsc_set_rc_buf_thresh(vdsc_cfg);\n\n\t \n\tif (DISPLAY_VER(dev_priv) >= 13) {\n\t\tcalculate_rc_params(vdsc_cfg);\n\t} else {\n\t\tif ((compressed_bpp == 8 ||\n\t\t     compressed_bpp == 12) &&\n\t\t    (vdsc_cfg->bits_per_component == 8 ||\n\t\t     vdsc_cfg->bits_per_component == 10 ||\n\t\t     vdsc_cfg->bits_per_component == 12))\n\t\t\tret = drm_dsc_setup_rc_params(vdsc_cfg, DRM_DSC_1_1_PRE_SCR);\n\t\telse\n\t\t\tret = drm_dsc_setup_rc_params(vdsc_cfg, DRM_DSC_1_2_444);\n\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (vdsc_cfg->bits_per_component <= 10)\n\t\tvdsc_cfg->mux_word_size = DSC_MUX_WORD_SIZE_8_10_BPC;\n\telse\n\t\tvdsc_cfg->mux_word_size = DSC_MUX_WORD_SIZE_12_BPC;\n\n\t \n\tvdsc_cfg->initial_scale_value = (vdsc_cfg->rc_model_size << 3) /\n\t\t(vdsc_cfg->rc_model_size - vdsc_cfg->initial_offset);\n\n\treturn 0;\n}\n\nenum intel_display_power_domain\nintel_dsc_power_domain(struct intel_crtc *crtc, enum transcoder cpu_transcoder)\n{\n\tstruct drm_i915_private *i915 = to_i915(crtc->base.dev);\n\tenum pipe pipe = crtc->pipe;\n\n\t \n\tif (DISPLAY_VER(i915) == 12 && !IS_ROCKETLAKE(i915) && pipe == PIPE_A)\n\t\treturn POWER_DOMAIN_TRANSCODER_VDSC_PW2;\n\telse if (is_pipe_dsc(crtc, cpu_transcoder))\n\t\treturn POWER_DOMAIN_PIPE(pipe);\n\telse\n\t\treturn POWER_DOMAIN_TRANSCODER_VDSC_PW2;\n}\n\nint intel_dsc_get_num_vdsc_instances(const struct intel_crtc_state *crtc_state)\n{\n\tint num_vdsc_instances = (crtc_state->dsc.dsc_split) ? 2 : 1;\n\n\tif (crtc_state->bigjoiner_pipes)\n\t\tnum_vdsc_instances *= 2;\n\n\treturn num_vdsc_instances;\n}\n\nstatic void intel_dsc_pps_configure(const struct intel_crtc_state *crtc_state)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(crtc_state->uapi.crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tconst struct drm_dsc_config *vdsc_cfg = &crtc_state->dsc.config;\n\tenum transcoder cpu_transcoder = crtc_state->cpu_transcoder;\n\tenum pipe pipe = crtc->pipe;\n\tu32 pps_val = 0;\n\tu32 rc_buf_thresh_dword[4];\n\tu32 rc_range_params_dword[8];\n\tint i = 0;\n\tint num_vdsc_instances = intel_dsc_get_num_vdsc_instances(crtc_state);\n\n\t \n\tpps_val = DSC_VER_MAJ | vdsc_cfg->dsc_version_minor <<\n\t\tDSC_VER_MIN_SHIFT |\n\t\tvdsc_cfg->bits_per_component << DSC_BPC_SHIFT |\n\t\tvdsc_cfg->line_buf_depth << DSC_LINE_BUF_DEPTH_SHIFT;\n\tif (vdsc_cfg->dsc_version_minor == 2) {\n\t\tpps_val |= DSC_ALT_ICH_SEL;\n\t\tif (vdsc_cfg->native_420)\n\t\t\tpps_val |= DSC_NATIVE_420_ENABLE;\n\t\tif (vdsc_cfg->native_422)\n\t\t\tpps_val |= DSC_NATIVE_422_ENABLE;\n\t}\n\tif (vdsc_cfg->block_pred_enable)\n\t\tpps_val |= DSC_BLOCK_PREDICTION;\n\tif (vdsc_cfg->convert_rgb)\n\t\tpps_val |= DSC_COLOR_SPACE_CONVERSION;\n\tif (vdsc_cfg->simple_422)\n\t\tpps_val |= DSC_422_ENABLE;\n\tif (vdsc_cfg->vbr_enable)\n\t\tpps_val |= DSC_VBR_ENABLE;\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS0 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_0,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_0,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_0(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_0(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_BPP(vdsc_cfg->bits_per_pixel);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS1 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_1,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_1,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_1(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_1(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_PIC_HEIGHT(vdsc_cfg->pic_height) |\n\t\tDSC_PIC_WIDTH(vdsc_cfg->pic_width / num_vdsc_instances);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS2 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_2,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_2,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_2(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_2(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_SLICE_HEIGHT(vdsc_cfg->slice_height) |\n\t\tDSC_SLICE_WIDTH(vdsc_cfg->slice_width);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS3 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_3,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_3,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_3(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_3(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_INITIAL_XMIT_DELAY(vdsc_cfg->initial_xmit_delay) |\n\t\tDSC_INITIAL_DEC_DELAY(vdsc_cfg->initial_dec_delay);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS4 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_4,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_4,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_4(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_4(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_SCALE_INC_INT(vdsc_cfg->scale_increment_interval) |\n\t\tDSC_SCALE_DEC_INT(vdsc_cfg->scale_decrement_interval);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS5 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_5,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_5,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_5(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_5(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_INITIAL_SCALE_VALUE(vdsc_cfg->initial_scale_value) |\n\t\tDSC_FIRST_LINE_BPG_OFFSET(vdsc_cfg->first_line_bpg_offset) |\n\t\tDSC_FLATNESS_MIN_QP(vdsc_cfg->flatness_min_qp) |\n\t\tDSC_FLATNESS_MAX_QP(vdsc_cfg->flatness_max_qp);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS6 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_6,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_6,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_6(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_6(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_SLICE_BPG_OFFSET(vdsc_cfg->slice_bpg_offset) |\n\t\tDSC_NFL_BPG_OFFSET(vdsc_cfg->nfl_bpg_offset);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS7 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_7,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_7,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_7(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_7(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_FINAL_OFFSET(vdsc_cfg->final_offset) |\n\t\tDSC_INITIAL_OFFSET(vdsc_cfg->initial_offset);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS8 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_8,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_8,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_8(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_8(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_RC_MODEL_SIZE(vdsc_cfg->rc_model_size) |\n\t\tDSC_RC_EDGE_FACTOR(DSC_RC_EDGE_FACTOR_CONST);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS9 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_9,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv, DSCC_PICTURE_PARAMETER_SET_9,\n\t\t\t\t       pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_9(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_9(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_RC_QUANT_INC_LIMIT0(vdsc_cfg->rc_quant_incr_limit0) |\n\t\tDSC_RC_QUANT_INC_LIMIT1(vdsc_cfg->rc_quant_incr_limit1) |\n\t\tDSC_RC_TARGET_OFF_HIGH(DSC_RC_TGT_OFFSET_HI_CONST) |\n\t\tDSC_RC_TARGET_OFF_LOW(DSC_RC_TGT_OFFSET_LO_CONST);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS10 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_10,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       DSCC_PICTURE_PARAMETER_SET_10, pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_10(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_10(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tpps_val = 0;\n\tpps_val |= DSC_SLICE_CHUNK_SIZE(vdsc_cfg->slice_chunk_size) |\n\t\tDSC_SLICE_PER_LINE((vdsc_cfg->pic_width / num_vdsc_instances) /\n\t\t\t\t   vdsc_cfg->slice_width) |\n\t\tDSC_SLICE_ROW_PER_FRAME(vdsc_cfg->pic_height /\n\t\t\t\t\tvdsc_cfg->slice_height);\n\tdrm_dbg_kms(&dev_priv->drm, \"PPS16 = 0x%08x\\n\", pps_val);\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_PICTURE_PARAMETER_SET_16,\n\t\t\t       pps_val);\n\t\t \n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       DSCC_PICTURE_PARAMETER_SET_16, pps_val);\n\t} else {\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_PICTURE_PARAMETER_SET_16(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_PICTURE_PARAMETER_SET_16(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\tif (DISPLAY_VER(dev_priv) >= 14) {\n\t\t \n\t\tpps_val = 0;\n\t\tpps_val |= DSC_SL_BPG_OFFSET(vdsc_cfg->second_line_bpg_offset);\n\t\tdrm_dbg_kms(&dev_priv->drm, \"PPS17 = 0x%08x\\n\", pps_val);\n\t\tintel_de_write(dev_priv,\n\t\t\t       MTL_DSC0_PICTURE_PARAMETER_SET_17(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       MTL_DSC1_PICTURE_PARAMETER_SET_17(pipe),\n\t\t\t\t       pps_val);\n\n\t\t \n\t\tpps_val = 0;\n\t\tpps_val |= DSC_NSL_BPG_OFFSET(vdsc_cfg->nsl_bpg_offset) |\n\t\t\t   DSC_SL_OFFSET_ADJ(vdsc_cfg->second_line_offset_adj);\n\t\tdrm_dbg_kms(&dev_priv->drm, \"PPS18 = 0x%08x\\n\", pps_val);\n\t\tintel_de_write(dev_priv,\n\t\t\t       MTL_DSC0_PICTURE_PARAMETER_SET_18(pipe),\n\t\t\t       pps_val);\n\t\tif (crtc_state->dsc.dsc_split)\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       MTL_DSC1_PICTURE_PARAMETER_SET_18(pipe),\n\t\t\t\t       pps_val);\n\t}\n\n\t \n\tmemset(rc_buf_thresh_dword, 0, sizeof(rc_buf_thresh_dword));\n\tfor (i = 0; i < DSC_NUM_BUF_RANGES - 1; i++) {\n\t\trc_buf_thresh_dword[i / 4] |=\n\t\t\t(u32)(vdsc_cfg->rc_buf_thresh[i] <<\n\t\t\t      BITS_PER_BYTE * (i % 4));\n\t\tdrm_dbg_kms(&dev_priv->drm, \"RC_BUF_THRESH_%d = 0x%08x\\n\", i,\n\t\t\t    rc_buf_thresh_dword[i / 4]);\n\t}\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_RC_BUF_THRESH_0,\n\t\t\t       rc_buf_thresh_dword[0]);\n\t\tintel_de_write(dev_priv, DSCA_RC_BUF_THRESH_0_UDW,\n\t\t\t       rc_buf_thresh_dword[1]);\n\t\tintel_de_write(dev_priv, DSCA_RC_BUF_THRESH_1,\n\t\t\t       rc_buf_thresh_dword[2]);\n\t\tintel_de_write(dev_priv, DSCA_RC_BUF_THRESH_1_UDW,\n\t\t\t       rc_buf_thresh_dword[3]);\n\t\tif (crtc_state->dsc.dsc_split) {\n\t\t\tintel_de_write(dev_priv, DSCC_RC_BUF_THRESH_0,\n\t\t\t\t       rc_buf_thresh_dword[0]);\n\t\t\tintel_de_write(dev_priv, DSCC_RC_BUF_THRESH_0_UDW,\n\t\t\t\t       rc_buf_thresh_dword[1]);\n\t\t\tintel_de_write(dev_priv, DSCC_RC_BUF_THRESH_1,\n\t\t\t\t       rc_buf_thresh_dword[2]);\n\t\t\tintel_de_write(dev_priv, DSCC_RC_BUF_THRESH_1_UDW,\n\t\t\t\t       rc_buf_thresh_dword[3]);\n\t\t}\n\t} else {\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_BUF_THRESH_0(pipe),\n\t\t\t       rc_buf_thresh_dword[0]);\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_BUF_THRESH_0_UDW(pipe),\n\t\t\t       rc_buf_thresh_dword[1]);\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_BUF_THRESH_1(pipe),\n\t\t\t       rc_buf_thresh_dword[2]);\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_BUF_THRESH_1_UDW(pipe),\n\t\t\t       rc_buf_thresh_dword[3]);\n\t\tif (crtc_state->dsc.dsc_split) {\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_BUF_THRESH_0(pipe),\n\t\t\t\t       rc_buf_thresh_dword[0]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_BUF_THRESH_0_UDW(pipe),\n\t\t\t\t       rc_buf_thresh_dword[1]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_BUF_THRESH_1(pipe),\n\t\t\t\t       rc_buf_thresh_dword[2]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_BUF_THRESH_1_UDW(pipe),\n\t\t\t\t       rc_buf_thresh_dword[3]);\n\t\t}\n\t}\n\n\t \n\tmemset(rc_range_params_dword, 0, sizeof(rc_range_params_dword));\n\tfor (i = 0; i < DSC_NUM_BUF_RANGES; i++) {\n\t\trc_range_params_dword[i / 2] |=\n\t\t\t(u32)(((vdsc_cfg->rc_range_params[i].range_bpg_offset <<\n\t\t\t\tRC_BPG_OFFSET_SHIFT) |\n\t\t\t       (vdsc_cfg->rc_range_params[i].range_max_qp <<\n\t\t\t\tRC_MAX_QP_SHIFT) |\n\t\t\t       (vdsc_cfg->rc_range_params[i].range_min_qp <<\n\t\t\t\tRC_MIN_QP_SHIFT)) << 16 * (i % 2));\n\t\tdrm_dbg_kms(&dev_priv->drm, \"RC_RANGE_PARAM_%d = 0x%08x\\n\", i,\n\t\t\t    rc_range_params_dword[i / 2]);\n\t}\n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_0,\n\t\t\t       rc_range_params_dword[0]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_0_UDW,\n\t\t\t       rc_range_params_dword[1]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_1,\n\t\t\t       rc_range_params_dword[2]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_1_UDW,\n\t\t\t       rc_range_params_dword[3]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_2,\n\t\t\t       rc_range_params_dword[4]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_2_UDW,\n\t\t\t       rc_range_params_dword[5]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_3,\n\t\t\t       rc_range_params_dword[6]);\n\t\tintel_de_write(dev_priv, DSCA_RC_RANGE_PARAMETERS_3_UDW,\n\t\t\t       rc_range_params_dword[7]);\n\t\tif (crtc_state->dsc.dsc_split) {\n\t\t\tintel_de_write(dev_priv, DSCC_RC_RANGE_PARAMETERS_0,\n\t\t\t\t       rc_range_params_dword[0]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       DSCC_RC_RANGE_PARAMETERS_0_UDW,\n\t\t\t\t       rc_range_params_dword[1]);\n\t\t\tintel_de_write(dev_priv, DSCC_RC_RANGE_PARAMETERS_1,\n\t\t\t\t       rc_range_params_dword[2]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       DSCC_RC_RANGE_PARAMETERS_1_UDW,\n\t\t\t\t       rc_range_params_dword[3]);\n\t\t\tintel_de_write(dev_priv, DSCC_RC_RANGE_PARAMETERS_2,\n\t\t\t\t       rc_range_params_dword[4]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       DSCC_RC_RANGE_PARAMETERS_2_UDW,\n\t\t\t\t       rc_range_params_dword[5]);\n\t\t\tintel_de_write(dev_priv, DSCC_RC_RANGE_PARAMETERS_3,\n\t\t\t\t       rc_range_params_dword[6]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       DSCC_RC_RANGE_PARAMETERS_3_UDW,\n\t\t\t\t       rc_range_params_dword[7]);\n\t\t}\n\t} else {\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_RANGE_PARAMETERS_0(pipe),\n\t\t\t       rc_range_params_dword[0]);\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_RC_RANGE_PARAMETERS_0_UDW(pipe),\n\t\t\t       rc_range_params_dword[1]);\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_RANGE_PARAMETERS_1(pipe),\n\t\t\t       rc_range_params_dword[2]);\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_RC_RANGE_PARAMETERS_1_UDW(pipe),\n\t\t\t       rc_range_params_dword[3]);\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_RANGE_PARAMETERS_2(pipe),\n\t\t\t       rc_range_params_dword[4]);\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_RC_RANGE_PARAMETERS_2_UDW(pipe),\n\t\t\t       rc_range_params_dword[5]);\n\t\tintel_de_write(dev_priv, ICL_DSC0_RC_RANGE_PARAMETERS_3(pipe),\n\t\t\t       rc_range_params_dword[6]);\n\t\tintel_de_write(dev_priv,\n\t\t\t       ICL_DSC0_RC_RANGE_PARAMETERS_3_UDW(pipe),\n\t\t\t       rc_range_params_dword[7]);\n\t\tif (crtc_state->dsc.dsc_split) {\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_0(pipe),\n\t\t\t\t       rc_range_params_dword[0]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_0_UDW(pipe),\n\t\t\t\t       rc_range_params_dword[1]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_1(pipe),\n\t\t\t\t       rc_range_params_dword[2]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_1_UDW(pipe),\n\t\t\t\t       rc_range_params_dword[3]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_2(pipe),\n\t\t\t\t       rc_range_params_dword[4]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_2_UDW(pipe),\n\t\t\t\t       rc_range_params_dword[5]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_3(pipe),\n\t\t\t\t       rc_range_params_dword[6]);\n\t\t\tintel_de_write(dev_priv,\n\t\t\t\t       ICL_DSC1_RC_RANGE_PARAMETERS_3_UDW(pipe),\n\t\t\t\t       rc_range_params_dword[7]);\n\t\t}\n\t}\n}\n\nvoid intel_dsc_dsi_pps_write(struct intel_encoder *encoder,\n\t\t\t     const struct intel_crtc_state *crtc_state)\n{\n\tconst struct drm_dsc_config *vdsc_cfg = &crtc_state->dsc.config;\n\tstruct intel_dsi *intel_dsi = enc_to_intel_dsi(encoder);\n\tstruct mipi_dsi_device *dsi;\n\tstruct drm_dsc_picture_parameter_set pps;\n\tenum port port;\n\n\tif (!crtc_state->dsc.compression_enable)\n\t\treturn;\n\n\tdrm_dsc_pps_payload_pack(&pps, vdsc_cfg);\n\n\tfor_each_dsi_port(port, intel_dsi->ports) {\n\t\tdsi = intel_dsi->dsi_hosts[port]->device;\n\n\t\tmipi_dsi_picture_parameter_set(dsi, &pps);\n\t\tmipi_dsi_compression_mode(dsi, true);\n\t}\n}\n\nvoid intel_dsc_dp_pps_write(struct intel_encoder *encoder,\n\t\t\t    const struct intel_crtc_state *crtc_state)\n{\n\tstruct intel_digital_port *dig_port = enc_to_dig_port(encoder);\n\tconst struct drm_dsc_config *vdsc_cfg = &crtc_state->dsc.config;\n\tstruct drm_dsc_pps_infoframe dp_dsc_pps_sdp;\n\n\tif (!crtc_state->dsc.compression_enable)\n\t\treturn;\n\n\t \n\tdrm_dsc_dp_pps_header_init(&dp_dsc_pps_sdp.pps_header);\n\n\t \n\tdrm_dsc_pps_payload_pack(&dp_dsc_pps_sdp.pps_payload, vdsc_cfg);\n\n\tdig_port->write_infoframe(encoder, crtc_state,\n\t\t\t\t  DP_SDP_PPS, &dp_dsc_pps_sdp,\n\t\t\t\t  sizeof(dp_dsc_pps_sdp));\n}\n\nstatic i915_reg_t dss_ctl1_reg(struct intel_crtc *crtc, enum transcoder cpu_transcoder)\n{\n\treturn is_pipe_dsc(crtc, cpu_transcoder) ?\n\t\tICL_PIPE_DSS_CTL1(crtc->pipe) : DSS_CTL1;\n}\n\nstatic i915_reg_t dss_ctl2_reg(struct intel_crtc *crtc, enum transcoder cpu_transcoder)\n{\n\treturn is_pipe_dsc(crtc, cpu_transcoder) ?\n\t\tICL_PIPE_DSS_CTL2(crtc->pipe) : DSS_CTL2;\n}\n\nvoid intel_uncompressed_joiner_enable(const struct intel_crtc_state *crtc_state)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(crtc_state->uapi.crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tu32 dss_ctl1_val = 0;\n\n\tif (crtc_state->bigjoiner_pipes && !crtc_state->dsc.compression_enable) {\n\t\tif (intel_crtc_is_bigjoiner_slave(crtc_state))\n\t\t\tdss_ctl1_val |= UNCOMPRESSED_JOINER_SLAVE;\n\t\telse\n\t\t\tdss_ctl1_val |= UNCOMPRESSED_JOINER_MASTER;\n\n\t\tintel_de_write(dev_priv, dss_ctl1_reg(crtc, crtc_state->cpu_transcoder), dss_ctl1_val);\n\t}\n}\n\nvoid intel_dsc_enable(const struct intel_crtc_state *crtc_state)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(crtc_state->uapi.crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tu32 dss_ctl1_val = 0;\n\tu32 dss_ctl2_val = 0;\n\n\tif (!crtc_state->dsc.compression_enable)\n\t\treturn;\n\n\tintel_dsc_pps_configure(crtc_state);\n\n\tdss_ctl2_val |= LEFT_BRANCH_VDSC_ENABLE;\n\tif (crtc_state->dsc.dsc_split) {\n\t\tdss_ctl2_val |= RIGHT_BRANCH_VDSC_ENABLE;\n\t\tdss_ctl1_val |= JOINER_ENABLE;\n\t}\n\tif (crtc_state->bigjoiner_pipes) {\n\t\tdss_ctl1_val |= BIG_JOINER_ENABLE;\n\t\tif (!intel_crtc_is_bigjoiner_slave(crtc_state))\n\t\t\tdss_ctl1_val |= MASTER_BIG_JOINER_ENABLE;\n\t}\n\tintel_de_write(dev_priv, dss_ctl1_reg(crtc, crtc_state->cpu_transcoder), dss_ctl1_val);\n\tintel_de_write(dev_priv, dss_ctl2_reg(crtc, crtc_state->cpu_transcoder), dss_ctl2_val);\n}\n\nvoid intel_dsc_disable(const struct intel_crtc_state *old_crtc_state)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(old_crtc_state->uapi.crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\n\t \n\tif (old_crtc_state->dsc.compression_enable ||\n\t    old_crtc_state->bigjoiner_pipes) {\n\t\tintel_de_write(dev_priv, dss_ctl1_reg(crtc, old_crtc_state->cpu_transcoder), 0);\n\t\tintel_de_write(dev_priv, dss_ctl2_reg(crtc, old_crtc_state->cpu_transcoder), 0);\n\t}\n}\n\nvoid intel_dsc_get_config(struct intel_crtc_state *crtc_state)\n{\n\tstruct intel_crtc *crtc = to_intel_crtc(crtc_state->uapi.crtc);\n\tstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\n\tstruct drm_dsc_config *vdsc_cfg = &crtc_state->dsc.config;\n\tenum transcoder cpu_transcoder = crtc_state->cpu_transcoder;\n\tenum pipe pipe = crtc->pipe;\n\tenum intel_display_power_domain power_domain;\n\tintel_wakeref_t wakeref;\n\tu32 dss_ctl1, dss_ctl2, pps0 = 0, pps1 = 0;\n\n\tif (!intel_dsc_source_support(crtc_state))\n\t\treturn;\n\n\tpower_domain = intel_dsc_power_domain(crtc, cpu_transcoder);\n\n\twakeref = intel_display_power_get_if_enabled(dev_priv, power_domain);\n\tif (!wakeref)\n\t\treturn;\n\n\tdss_ctl1 = intel_de_read(dev_priv, dss_ctl1_reg(crtc, cpu_transcoder));\n\tdss_ctl2 = intel_de_read(dev_priv, dss_ctl2_reg(crtc, cpu_transcoder));\n\n\tcrtc_state->dsc.compression_enable = dss_ctl2 & LEFT_BRANCH_VDSC_ENABLE;\n\tif (!crtc_state->dsc.compression_enable)\n\t\tgoto out;\n\n\tcrtc_state->dsc.dsc_split = (dss_ctl2 & RIGHT_BRANCH_VDSC_ENABLE) &&\n\t\t(dss_ctl1 & JOINER_ENABLE);\n\n\t \n\n\t \n\tif (!is_pipe_dsc(crtc, cpu_transcoder)) {\n\t\tpps1 = intel_de_read(dev_priv, DSCA_PICTURE_PARAMETER_SET_1);\n\t} else {\n\t\tpps0 = intel_de_read(dev_priv,\n\t\t\t\t     ICL_DSC0_PICTURE_PARAMETER_SET_0(pipe));\n\t\tpps1 = intel_de_read(dev_priv,\n\t\t\t\t     ICL_DSC0_PICTURE_PARAMETER_SET_1(pipe));\n\t}\n\n\tvdsc_cfg->bits_per_pixel = pps1;\n\n\tif (pps0 & DSC_NATIVE_420_ENABLE)\n\t\tvdsc_cfg->bits_per_pixel >>= 1;\n\n\tcrtc_state->dsc.compressed_bpp = vdsc_cfg->bits_per_pixel >> 4;\nout:\n\tintel_display_power_put(dev_priv, power_domain, wakeref);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}