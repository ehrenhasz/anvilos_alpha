{
  "module_name": "intel_frontbuffer.c",
  "hash_id": "315bffc4bd8444f1ac6145ca76cab248b06225cd912c978c37ef296923045302",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/display/intel_frontbuffer.c",
  "human_readable_source": " \n\n \n\n#include \"i915_drv.h\"\n#include \"intel_display_trace.h\"\n#include \"intel_display_types.h\"\n#include \"intel_dp.h\"\n#include \"intel_drrs.h\"\n#include \"intel_fbc.h\"\n#include \"intel_frontbuffer.h\"\n#include \"intel_psr.h\"\n\n \nstatic void frontbuffer_flush(struct drm_i915_private *i915,\n\t\t\t      unsigned int frontbuffer_bits,\n\t\t\t      enum fb_op_origin origin)\n{\n\t \n\tspin_lock(&i915->display.fb_tracking.lock);\n\tfrontbuffer_bits &= ~i915->display.fb_tracking.busy_bits;\n\tspin_unlock(&i915->display.fb_tracking.lock);\n\n\tif (!frontbuffer_bits)\n\t\treturn;\n\n\ttrace_intel_frontbuffer_flush(i915, frontbuffer_bits, origin);\n\n\tmight_sleep();\n\tintel_drrs_flush(i915, frontbuffer_bits);\n\tintel_psr_flush(i915, frontbuffer_bits, origin);\n\tintel_fbc_flush(i915, frontbuffer_bits, origin);\n}\n\n \nvoid intel_frontbuffer_flip_prepare(struct drm_i915_private *i915,\n\t\t\t\t    unsigned frontbuffer_bits)\n{\n\tspin_lock(&i915->display.fb_tracking.lock);\n\ti915->display.fb_tracking.flip_bits |= frontbuffer_bits;\n\t \n\ti915->display.fb_tracking.busy_bits &= ~frontbuffer_bits;\n\tspin_unlock(&i915->display.fb_tracking.lock);\n}\n\n \nvoid intel_frontbuffer_flip_complete(struct drm_i915_private *i915,\n\t\t\t\t     unsigned frontbuffer_bits)\n{\n\tspin_lock(&i915->display.fb_tracking.lock);\n\t \n\tfrontbuffer_bits &= i915->display.fb_tracking.flip_bits;\n\ti915->display.fb_tracking.flip_bits &= ~frontbuffer_bits;\n\tspin_unlock(&i915->display.fb_tracking.lock);\n\n\tif (frontbuffer_bits)\n\t\tfrontbuffer_flush(i915, frontbuffer_bits, ORIGIN_FLIP);\n}\n\n \nvoid intel_frontbuffer_flip(struct drm_i915_private *i915,\n\t\t\t    unsigned frontbuffer_bits)\n{\n\tspin_lock(&i915->display.fb_tracking.lock);\n\t \n\ti915->display.fb_tracking.busy_bits &= ~frontbuffer_bits;\n\tspin_unlock(&i915->display.fb_tracking.lock);\n\n\tfrontbuffer_flush(i915, frontbuffer_bits, ORIGIN_FLIP);\n}\n\nvoid __intel_fb_invalidate(struct intel_frontbuffer *front,\n\t\t\t   enum fb_op_origin origin,\n\t\t\t   unsigned int frontbuffer_bits)\n{\n\tstruct drm_i915_private *i915 = intel_bo_to_i915(front->obj);\n\n\tif (origin == ORIGIN_CS) {\n\t\tspin_lock(&i915->display.fb_tracking.lock);\n\t\ti915->display.fb_tracking.busy_bits |= frontbuffer_bits;\n\t\ti915->display.fb_tracking.flip_bits &= ~frontbuffer_bits;\n\t\tspin_unlock(&i915->display.fb_tracking.lock);\n\t}\n\n\ttrace_intel_frontbuffer_invalidate(i915, frontbuffer_bits, origin);\n\n\tmight_sleep();\n\tintel_psr_invalidate(i915, frontbuffer_bits, origin);\n\tintel_drrs_invalidate(i915, frontbuffer_bits);\n\tintel_fbc_invalidate(i915, frontbuffer_bits, origin);\n}\n\nvoid __intel_fb_flush(struct intel_frontbuffer *front,\n\t\t      enum fb_op_origin origin,\n\t\t      unsigned int frontbuffer_bits)\n{\n\tstruct drm_i915_private *i915 = intel_bo_to_i915(front->obj);\n\n\tif (origin == ORIGIN_CS) {\n\t\tspin_lock(&i915->display.fb_tracking.lock);\n\t\t \n\t\tfrontbuffer_bits &= i915->display.fb_tracking.busy_bits;\n\t\ti915->display.fb_tracking.busy_bits &= ~frontbuffer_bits;\n\t\tspin_unlock(&i915->display.fb_tracking.lock);\n\t}\n\n\tif (frontbuffer_bits)\n\t\tfrontbuffer_flush(i915, frontbuffer_bits, origin);\n}\n\nstatic int frontbuffer_active(struct i915_active *ref)\n{\n\tstruct intel_frontbuffer *front =\n\t\tcontainer_of(ref, typeof(*front), write);\n\n\tkref_get(&front->ref);\n\treturn 0;\n}\n\nstatic void frontbuffer_retire(struct i915_active *ref)\n{\n\tstruct intel_frontbuffer *front =\n\t\tcontainer_of(ref, typeof(*front), write);\n\n\tintel_frontbuffer_flush(front, ORIGIN_CS);\n\tintel_frontbuffer_put(front);\n}\n\nstatic void frontbuffer_release(struct kref *ref)\n\t__releases(&intel_bo_to_i915(front->obj)->display.fb_tracking.lock)\n{\n\tstruct intel_frontbuffer *front =\n\t\tcontainer_of(ref, typeof(*front), ref);\n\tstruct drm_i915_gem_object *obj = front->obj;\n\n\tdrm_WARN_ON(&intel_bo_to_i915(obj)->drm, atomic_read(&front->bits));\n\n\ti915_ggtt_clear_scanout(obj);\n\n\ti915_gem_object_set_frontbuffer(obj, NULL);\n\tspin_unlock(&intel_bo_to_i915(obj)->display.fb_tracking.lock);\n\n\ti915_active_fini(&front->write);\n\n\ti915_gem_object_put(obj);\n\tkfree_rcu(front, rcu);\n}\n\nstruct intel_frontbuffer *\nintel_frontbuffer_get(struct drm_i915_gem_object *obj)\n{\n\tstruct drm_i915_private *i915 = intel_bo_to_i915(obj);\n\tstruct intel_frontbuffer *front, *cur;\n\n\tfront = i915_gem_object_get_frontbuffer(obj);\n\tif (front)\n\t\treturn front;\n\n\tfront = kmalloc(sizeof(*front), GFP_KERNEL);\n\tif (!front)\n\t\treturn NULL;\n\n\tfront->obj = obj;\n\tkref_init(&front->ref);\n\tatomic_set(&front->bits, 0);\n\ti915_active_init(&front->write,\n\t\t\t frontbuffer_active,\n\t\t\t frontbuffer_retire,\n\t\t\t I915_ACTIVE_RETIRE_SLEEPS);\n\n\tspin_lock(&i915->display.fb_tracking.lock);\n\tcur = i915_gem_object_set_frontbuffer(obj, front);\n\tspin_unlock(&i915->display.fb_tracking.lock);\n\tif (cur != front)\n\t\tkfree(front);\n\treturn cur;\n}\n\nvoid intel_frontbuffer_put(struct intel_frontbuffer *front)\n{\n\tkref_put_lock(&front->ref,\n\t\t      frontbuffer_release,\n\t\t      &intel_bo_to_i915(front->obj)->display.fb_tracking.lock);\n}\n\n \nvoid intel_frontbuffer_track(struct intel_frontbuffer *old,\n\t\t\t     struct intel_frontbuffer *new,\n\t\t\t     unsigned int frontbuffer_bits)\n{\n\t \n\tBUILD_BUG_ON(INTEL_FRONTBUFFER_BITS_PER_PIPE * I915_MAX_PIPES >\n\t\t     BITS_PER_TYPE(atomic_t));\n\tBUILD_BUG_ON(INTEL_FRONTBUFFER_BITS_PER_PIPE * I915_MAX_PIPES > 32);\n\tBUILD_BUG_ON(I915_MAX_PLANES > INTEL_FRONTBUFFER_BITS_PER_PIPE);\n\n\tif (old) {\n\t\tdrm_WARN_ON(&intel_bo_to_i915(old->obj)->drm,\n\t\t\t    !(atomic_read(&old->bits) & frontbuffer_bits));\n\t\tatomic_andnot(frontbuffer_bits, &old->bits);\n\t}\n\n\tif (new) {\n\t\tdrm_WARN_ON(&intel_bo_to_i915(new->obj)->drm,\n\t\t\t    atomic_read(&new->bits) & frontbuffer_bits);\n\t\tatomic_or(frontbuffer_bits, &new->bits);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}