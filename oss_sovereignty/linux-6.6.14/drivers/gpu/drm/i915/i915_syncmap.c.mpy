{
  "module_name": "i915_syncmap.c",
  "hash_id": "d1570413ffac0a7d99f5e9ca0fc802472dde01c0043d2ee76bc84b85609cf63a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/i915_syncmap.c",
  "human_readable_source": " \n\n#include <linux/slab.h>\n\n#include \"i915_syncmap.h\"\n\n#include \"i915_gem.h\"  \n#include \"i915_selftest.h\"\n\n#define SHIFT ilog2(KSYNCMAP)\n#define MASK (KSYNCMAP - 1)\n\n \n\nstruct i915_syncmap {\n\tu64 prefix;\n\tunsigned int height;\n\tunsigned int bitmap;\n\tstruct i915_syncmap *parent;\n\t \n};\n\n \nvoid i915_syncmap_init(struct i915_syncmap **root)\n{\n\tBUILD_BUG_ON_NOT_POWER_OF_2(KSYNCMAP);\n\tBUILD_BUG_ON_NOT_POWER_OF_2(SHIFT);\n\tBUILD_BUG_ON(KSYNCMAP > BITS_PER_TYPE((*root)->bitmap));\n\t*root = NULL;\n}\n\nstatic inline u32 *__sync_seqno(struct i915_syncmap *p)\n{\n\tGEM_BUG_ON(p->height);\n\treturn (u32 *)(p + 1);\n}\n\nstatic inline struct i915_syncmap **__sync_child(struct i915_syncmap *p)\n{\n\tGEM_BUG_ON(!p->height);\n\treturn (struct i915_syncmap **)(p + 1);\n}\n\nstatic inline unsigned int\n__sync_branch_idx(const struct i915_syncmap *p, u64 id)\n{\n\treturn (id >> p->height) & MASK;\n}\n\nstatic inline unsigned int\n__sync_leaf_idx(const struct i915_syncmap *p, u64 id)\n{\n\tGEM_BUG_ON(p->height);\n\treturn id & MASK;\n}\n\nstatic inline u64 __sync_branch_prefix(const struct i915_syncmap *p, u64 id)\n{\n\treturn id >> p->height >> SHIFT;\n}\n\nstatic inline u64 __sync_leaf_prefix(const struct i915_syncmap *p, u64 id)\n{\n\tGEM_BUG_ON(p->height);\n\treturn id >> SHIFT;\n}\n\nstatic inline bool seqno_later(u32 a, u32 b)\n{\n\treturn (s32)(a - b) >= 0;\n}\n\n \nbool i915_syncmap_is_later(struct i915_syncmap **root, u64 id, u32 seqno)\n{\n\tstruct i915_syncmap *p;\n\tunsigned int idx;\n\n\tp = *root;\n\tif (!p)\n\t\treturn false;\n\n\tif (likely(__sync_leaf_prefix(p, id) == p->prefix))\n\t\tgoto found;\n\n\t \n\tdo {\n\t\tp = p->parent;\n\t\tif (!p)\n\t\t\treturn false;\n\n\t\tif (__sync_branch_prefix(p, id) == p->prefix)\n\t\t\tbreak;\n\t} while (1);\n\n\t \n\tdo {\n\t\tif (!p->height)\n\t\t\tbreak;\n\n\t\tp = __sync_child(p)[__sync_branch_idx(p, id)];\n\t\tif (!p)\n\t\t\treturn false;\n\n\t\tif (__sync_branch_prefix(p, id) != p->prefix)\n\t\t\treturn false;\n\t} while (1);\n\n\t*root = p;\nfound:\n\tidx = __sync_leaf_idx(p, id);\n\tif (!(p->bitmap & BIT(idx)))\n\t\treturn false;\n\n\treturn seqno_later(__sync_seqno(p)[idx], seqno);\n}\n\nstatic struct i915_syncmap *\n__sync_alloc_leaf(struct i915_syncmap *parent, u64 id)\n{\n\tstruct i915_syncmap *p;\n\n\tp = kmalloc(sizeof(*p) + KSYNCMAP * sizeof(u32), GFP_KERNEL);\n\tif (unlikely(!p))\n\t\treturn NULL;\n\n\tp->parent = parent;\n\tp->height = 0;\n\tp->bitmap = 0;\n\tp->prefix = __sync_leaf_prefix(p, id);\n\treturn p;\n}\n\nstatic inline void __sync_set_seqno(struct i915_syncmap *p, u64 id, u32 seqno)\n{\n\tunsigned int idx = __sync_leaf_idx(p, id);\n\n\tp->bitmap |= BIT(idx);\n\t__sync_seqno(p)[idx] = seqno;\n}\n\nstatic inline void __sync_set_child(struct i915_syncmap *p,\n\t\t\t\t    unsigned int idx,\n\t\t\t\t    struct i915_syncmap *child)\n{\n\tp->bitmap |= BIT(idx);\n\t__sync_child(p)[idx] = child;\n}\n\nstatic noinline int __sync_set(struct i915_syncmap **root, u64 id, u32 seqno)\n{\n\tstruct i915_syncmap *p = *root;\n\tunsigned int idx;\n\n\tif (!p) {\n\t\tp = __sync_alloc_leaf(NULL, id);\n\t\tif (unlikely(!p))\n\t\t\treturn -ENOMEM;\n\n\t\tgoto found;\n\t}\n\n\t \n\tGEM_BUG_ON(__sync_leaf_prefix(p, id) == p->prefix);\n\n\t \n\tdo {\n\t\tif (!p->parent)\n\t\t\tbreak;\n\n\t\tp = p->parent;\n\n\t\tif (__sync_branch_prefix(p, id) == p->prefix)\n\t\t\tbreak;\n\t} while (1);\n\n\t \n\tdo {\n\t\tstruct i915_syncmap *next;\n\n\t\tif (__sync_branch_prefix(p, id) != p->prefix) {\n\t\t\tunsigned int above;\n\n\t\t\t \n\t\t\tnext = kzalloc(sizeof(*next) + KSYNCMAP * sizeof(next),\n\t\t\t\t       GFP_KERNEL);\n\t\t\tif (unlikely(!next))\n\t\t\t\treturn -ENOMEM;\n\n\t\t\t \n\t\t\tabove = fls64(__sync_branch_prefix(p, id) ^ p->prefix);\n\t\t\tabove = round_up(above, SHIFT);\n\t\t\tnext->height = above + p->height;\n\t\t\tnext->prefix = __sync_branch_prefix(next, id);\n\n\t\t\t \n\t\t\tif (p->parent) {\n\t\t\t\tidx = __sync_branch_idx(p->parent, id);\n\t\t\t\t__sync_child(p->parent)[idx] = next;\n\t\t\t\tGEM_BUG_ON(!(p->parent->bitmap & BIT(idx)));\n\t\t\t}\n\t\t\tnext->parent = p->parent;\n\n\t\t\t \n\t\t\tidx = p->prefix >> (above - SHIFT) & MASK;\n\t\t\t__sync_set_child(next, idx, p);\n\t\t\tp->parent = next;\n\n\t\t\t \n\t\t\tp = next;\n\t\t} else {\n\t\t\tif (!p->height)\n\t\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tGEM_BUG_ON(!p->height);\n\t\tidx = __sync_branch_idx(p, id);\n\t\tnext = __sync_child(p)[idx];\n\t\tif (!next) {\n\t\t\tnext = __sync_alloc_leaf(p, id);\n\t\t\tif (unlikely(!next))\n\t\t\t\treturn -ENOMEM;\n\n\t\t\t__sync_set_child(p, idx, next);\n\t\t\tp = next;\n\t\t\tbreak;\n\t\t}\n\n\t\tp = next;\n\t} while (1);\n\nfound:\n\tGEM_BUG_ON(p->prefix != __sync_leaf_prefix(p, id));\n\t__sync_set_seqno(p, id, seqno);\n\t*root = p;\n\treturn 0;\n}\n\n \nint i915_syncmap_set(struct i915_syncmap **root, u64 id, u32 seqno)\n{\n\tstruct i915_syncmap *p = *root;\n\n\t \n\tif (likely(p && __sync_leaf_prefix(p, id) == p->prefix)) {\n\t\t__sync_set_seqno(p, id, seqno);\n\t\treturn 0;\n\t}\n\n\treturn __sync_set(root, id, seqno);\n}\n\nstatic void __sync_free(struct i915_syncmap *p)\n{\n\tif (p->height) {\n\t\tunsigned int i;\n\n\t\twhile ((i = ffs(p->bitmap))) {\n\t\t\tp->bitmap &= ~0u << i;\n\t\t\t__sync_free(__sync_child(p)[i - 1]);\n\t\t}\n\t}\n\n\tkfree(p);\n}\n\n \nvoid i915_syncmap_free(struct i915_syncmap **root)\n{\n\tstruct i915_syncmap *p;\n\n\tp = *root;\n\tif (!p)\n\t\treturn;\n\n\twhile (p->parent)\n\t\tp = p->parent;\n\n\t__sync_free(p);\n\t*root = NULL;\n}\n\n#if IS_ENABLED(CONFIG_DRM_I915_SELFTEST)\n#include \"selftests/i915_syncmap.c\"\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}