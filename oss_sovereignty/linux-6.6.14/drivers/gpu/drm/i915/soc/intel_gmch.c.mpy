{
  "module_name": "intel_gmch.c",
  "hash_id": "d8c848269e14662f00ba56f5da43fd93dc73eb36de6bc12fe2752b4569424768",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/soc/intel_gmch.c",
  "human_readable_source": "\n \n\n#include <linux/pci.h>\n#include <linux/pnp.h>\n\n#include <drm/drm_managed.h>\n#include <drm/i915_drm.h>\n\n#include \"i915_drv.h\"\n#include \"intel_gmch.h\"\n#include \"intel_pci_config.h\"\n\nstatic void intel_gmch_bridge_release(struct drm_device *dev, void *bridge)\n{\n\tpci_dev_put(bridge);\n}\n\nint intel_gmch_bridge_setup(struct drm_i915_private *i915)\n{\n\tint domain = pci_domain_nr(to_pci_dev(i915->drm.dev)->bus);\n\n\ti915->gmch.pdev = pci_get_domain_bus_and_slot(domain, 0, PCI_DEVFN(0, 0));\n\tif (!i915->gmch.pdev) {\n\t\tdrm_err(&i915->drm, \"bridge device not found\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn drmm_add_action_or_reset(&i915->drm, intel_gmch_bridge_release,\n\t\t\t\t\ti915->gmch.pdev);\n}\n\n \nstatic int\nintel_alloc_mchbar_resource(struct drm_i915_private *i915)\n{\n\tint reg = GRAPHICS_VER(i915) >= 4 ? MCHBAR_I965 : MCHBAR_I915;\n\tu32 temp_lo, temp_hi = 0;\n\tu64 mchbar_addr;\n\tint ret;\n\n\tif (GRAPHICS_VER(i915) >= 4)\n\t\tpci_read_config_dword(i915->gmch.pdev, reg + 4, &temp_hi);\n\tpci_read_config_dword(i915->gmch.pdev, reg, &temp_lo);\n\tmchbar_addr = ((u64)temp_hi << 32) | temp_lo;\n\n\t \n\tif (IS_ENABLED(CONFIG_PNP) && mchbar_addr &&\n\t    pnp_range_reserved(mchbar_addr, mchbar_addr + MCHBAR_SIZE))\n\t\treturn 0;\n\n\t \n\ti915->gmch.mch_res.name = \"i915 MCHBAR\";\n\ti915->gmch.mch_res.flags = IORESOURCE_MEM;\n\tret = pci_bus_alloc_resource(i915->gmch.pdev->bus,\n\t\t\t\t     &i915->gmch.mch_res,\n\t\t\t\t     MCHBAR_SIZE, MCHBAR_SIZE,\n\t\t\t\t     PCIBIOS_MIN_MEM,\n\t\t\t\t     0, pcibios_align_resource,\n\t\t\t\t     i915->gmch.pdev);\n\tif (ret) {\n\t\tdrm_dbg(&i915->drm, \"failed bus alloc: %d\\n\", ret);\n\t\ti915->gmch.mch_res.start = 0;\n\t\treturn ret;\n\t}\n\n\tif (GRAPHICS_VER(i915) >= 4)\n\t\tpci_write_config_dword(i915->gmch.pdev, reg + 4,\n\t\t\t\t       upper_32_bits(i915->gmch.mch_res.start));\n\n\tpci_write_config_dword(i915->gmch.pdev, reg,\n\t\t\t       lower_32_bits(i915->gmch.mch_res.start));\n\treturn 0;\n}\n\n \nvoid intel_gmch_bar_setup(struct drm_i915_private *i915)\n{\n\tint mchbar_reg = GRAPHICS_VER(i915) >= 4 ? MCHBAR_I965 : MCHBAR_I915;\n\tu32 temp;\n\tbool enabled;\n\n\tif (IS_VALLEYVIEW(i915) || IS_CHERRYVIEW(i915))\n\t\treturn;\n\n\ti915->gmch.mchbar_need_disable = false;\n\n\tif (IS_I915G(i915) || IS_I915GM(i915)) {\n\t\tpci_read_config_dword(i915->gmch.pdev, DEVEN, &temp);\n\t\tenabled = !!(temp & DEVEN_MCHBAR_EN);\n\t} else {\n\t\tpci_read_config_dword(i915->gmch.pdev, mchbar_reg, &temp);\n\t\tenabled = temp & 1;\n\t}\n\n\t \n\tif (enabled)\n\t\treturn;\n\n\tif (intel_alloc_mchbar_resource(i915))\n\t\treturn;\n\n\ti915->gmch.mchbar_need_disable = true;\n\n\t \n\tif (IS_I915G(i915) || IS_I915GM(i915)) {\n\t\tpci_write_config_dword(i915->gmch.pdev, DEVEN,\n\t\t\t\t       temp | DEVEN_MCHBAR_EN);\n\t} else {\n\t\tpci_read_config_dword(i915->gmch.pdev, mchbar_reg, &temp);\n\t\tpci_write_config_dword(i915->gmch.pdev, mchbar_reg, temp | 1);\n\t}\n}\n\nvoid intel_gmch_bar_teardown(struct drm_i915_private *i915)\n{\n\tint mchbar_reg = GRAPHICS_VER(i915) >= 4 ? MCHBAR_I965 : MCHBAR_I915;\n\n\tif (i915->gmch.mchbar_need_disable) {\n\t\tif (IS_I915G(i915) || IS_I915GM(i915)) {\n\t\t\tu32 deven_val;\n\n\t\t\tpci_read_config_dword(i915->gmch.pdev, DEVEN,\n\t\t\t\t\t      &deven_val);\n\t\t\tdeven_val &= ~DEVEN_MCHBAR_EN;\n\t\t\tpci_write_config_dword(i915->gmch.pdev, DEVEN,\n\t\t\t\t\t       deven_val);\n\t\t} else {\n\t\t\tu32 mchbar_val;\n\n\t\t\tpci_read_config_dword(i915->gmch.pdev, mchbar_reg,\n\t\t\t\t\t      &mchbar_val);\n\t\t\tmchbar_val &= ~1;\n\t\t\tpci_write_config_dword(i915->gmch.pdev, mchbar_reg,\n\t\t\t\t\t       mchbar_val);\n\t\t}\n\t}\n\n\tif (i915->gmch.mch_res.start)\n\t\trelease_resource(&i915->gmch.mch_res);\n}\n\nint intel_gmch_vga_set_state(struct drm_i915_private *i915, bool enable_decode)\n{\n\tunsigned int reg = DISPLAY_VER(i915) >= 6 ? SNB_GMCH_CTRL : INTEL_GMCH_CTRL;\n\tu16 gmch_ctrl;\n\n\tif (pci_read_config_word(i915->gmch.pdev, reg, &gmch_ctrl)) {\n\t\tdrm_err(&i915->drm, \"failed to read control word\\n\");\n\t\treturn -EIO;\n\t}\n\n\tif (!!(gmch_ctrl & INTEL_GMCH_VGA_DISABLE) == !enable_decode)\n\t\treturn 0;\n\n\tif (enable_decode)\n\t\tgmch_ctrl &= ~INTEL_GMCH_VGA_DISABLE;\n\telse\n\t\tgmch_ctrl |= INTEL_GMCH_VGA_DISABLE;\n\n\tif (pci_write_config_word(i915->gmch.pdev, reg, gmch_ctrl)) {\n\t\tdrm_err(&i915->drm, \"failed to write control word\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}