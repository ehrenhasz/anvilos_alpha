{
  "module_name": "i915_drm_client.c",
  "hash_id": "f8d519a7191b65c7873138863c00718e63542afe310030b81ee9a8e23b149c16",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/i915_drm_client.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/types.h>\n\n#include <uapi/drm/i915_drm.h>\n\n#include <drm/drm_print.h>\n\n#include \"gem/i915_gem_context.h\"\n#include \"i915_drm_client.h\"\n#include \"i915_file_private.h\"\n#include \"i915_gem.h\"\n#include \"i915_utils.h\"\n\nstruct i915_drm_client *i915_drm_client_alloc(void)\n{\n\tstruct i915_drm_client *client;\n\n\tclient = kzalloc(sizeof(*client), GFP_KERNEL);\n\tif (!client)\n\t\treturn NULL;\n\n\tkref_init(&client->kref);\n\tspin_lock_init(&client->ctx_lock);\n\tINIT_LIST_HEAD(&client->ctx_list);\n\n\treturn client;\n}\n\nvoid __i915_drm_client_free(struct kref *kref)\n{\n\tstruct i915_drm_client *client =\n\t\tcontainer_of(kref, typeof(*client), kref);\n\n\tkfree(client);\n}\n\n#ifdef CONFIG_PROC_FS\nstatic const char * const uabi_class_names[] = {\n\t[I915_ENGINE_CLASS_RENDER] = \"render\",\n\t[I915_ENGINE_CLASS_COPY] = \"copy\",\n\t[I915_ENGINE_CLASS_VIDEO] = \"video\",\n\t[I915_ENGINE_CLASS_VIDEO_ENHANCE] = \"video-enhance\",\n\t[I915_ENGINE_CLASS_COMPUTE] = \"compute\",\n};\n\nstatic u64 busy_add(struct i915_gem_context *ctx, unsigned int class)\n{\n\tstruct i915_gem_engines_iter it;\n\tstruct intel_context *ce;\n\tu64 total = 0;\n\n\tfor_each_gem_engine(ce, rcu_dereference(ctx->engines), it) {\n\t\tif (ce->engine->uabi_class != class)\n\t\t\tcontinue;\n\n\t\ttotal += intel_context_get_total_runtime_ns(ce);\n\t}\n\n\treturn total;\n}\n\nstatic void\nshow_client_class(struct drm_printer *p,\n\t\t  struct drm_i915_private *i915,\n\t\t  struct i915_drm_client *client,\n\t\t  unsigned int class)\n{\n\tconst unsigned int capacity = i915->engine_uabi_class_count[class];\n\tu64 total = atomic64_read(&client->past_runtime[class]);\n\tstruct i915_gem_context *ctx;\n\n\trcu_read_lock();\n\tlist_for_each_entry_rcu(ctx, &client->ctx_list, client_link)\n\t\ttotal += busy_add(ctx, class);\n\trcu_read_unlock();\n\n\tif (capacity)\n\t\tdrm_printf(p, \"drm-engine-%s:\\t%llu ns\\n\",\n\t\t\t   uabi_class_names[class], total);\n\n\tif (capacity > 1)\n\t\tdrm_printf(p, \"drm-engine-capacity-%s:\\t%u\\n\",\n\t\t\t   uabi_class_names[class],\n\t\t\t   capacity);\n}\n\nvoid i915_drm_client_fdinfo(struct drm_printer *p, struct drm_file *file)\n{\n\tstruct drm_i915_file_private *file_priv = file->driver_priv;\n\tstruct drm_i915_private *i915 = file_priv->i915;\n\tunsigned int i;\n\n\t \n\n\tif (GRAPHICS_VER(i915) < 8)\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(uabi_class_names); i++)\n\t\tshow_client_class(p, i915, file_priv->client, i);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}