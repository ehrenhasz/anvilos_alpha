{
  "module_name": "display.c",
  "hash_id": "7f0c10b327066d0e330bedb8272535619240764e58bd9d9e79ce77d00a666ba6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gvt/display.c",
  "human_readable_source": " \n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"gvt.h\"\n\n#include \"display/intel_display.h\"\n#include \"display/intel_dpio_phy.h\"\n\nstatic int get_edp_pipe(struct intel_vgpu *vgpu)\n{\n\tu32 data = vgpu_vreg(vgpu, _TRANS_DDI_FUNC_CTL_EDP);\n\tint pipe = -1;\n\n\tswitch (data & TRANS_DDI_EDP_INPUT_MASK) {\n\tcase TRANS_DDI_EDP_INPUT_A_ON:\n\tcase TRANS_DDI_EDP_INPUT_A_ONOFF:\n\t\tpipe = PIPE_A;\n\t\tbreak;\n\tcase TRANS_DDI_EDP_INPUT_B_ONOFF:\n\t\tpipe = PIPE_B;\n\t\tbreak;\n\tcase TRANS_DDI_EDP_INPUT_C_ONOFF:\n\t\tpipe = PIPE_C;\n\t\tbreak;\n\t}\n\treturn pipe;\n}\n\nstatic int edp_pipe_is_enabled(struct intel_vgpu *vgpu)\n{\n\tstruct drm_i915_private *dev_priv = vgpu->gvt->gt->i915;\n\n\tif (!(vgpu_vreg_t(vgpu, TRANSCONF(TRANSCODER_EDP)) & TRANSCONF_ENABLE))\n\t\treturn 0;\n\n\tif (!(vgpu_vreg(vgpu, _TRANS_DDI_FUNC_CTL_EDP) & TRANS_DDI_FUNC_ENABLE))\n\t\treturn 0;\n\treturn 1;\n}\n\nint pipe_is_enabled(struct intel_vgpu *vgpu, int pipe)\n{\n\tstruct drm_i915_private *dev_priv = vgpu->gvt->gt->i915;\n\n\tif (drm_WARN_ON(&dev_priv->drm,\n\t\t\tpipe < PIPE_A || pipe >= I915_MAX_PIPES))\n\t\treturn -EINVAL;\n\n\tif (vgpu_vreg_t(vgpu, TRANSCONF(pipe)) & TRANSCONF_ENABLE)\n\t\treturn 1;\n\n\tif (edp_pipe_is_enabled(vgpu) &&\n\t\t\tget_edp_pipe(vgpu) == pipe)\n\t\treturn 1;\n\treturn 0;\n}\n\nstatic unsigned char virtual_dp_monitor_edid[GVT_EDID_NUM][EDID_SIZE] = {\n\t{\n \n\t\t \n\t\t0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,\n\t\t \n\t\t0x22, 0xf0, 0x54, 0x29, 0x00, 0x00, 0x00, 0x00, 0x04, 0x17,\n\t\t \n\t\t0x01, 0x04,\n\t\t \n\t\t0xa5, 0x34, 0x20, 0x78, 0x23,\n\t\t \n\t\t0xfc, 0x81, 0xa4, 0x55, 0x4d, 0x9d, 0x25, 0x12, 0x50, 0x54,\n\t\t \n\t\t0x21, 0x08, 0x00,\n\t\t \n\t\t0x00, 0xc0, 0x00, 0xc0, 0x00, 0x40, 0x00, 0x80, 0x00, 0x00,\n\t\t0x00, 0x40, 0x00, 0x00, 0x00, 0x01,\n\t\t \n\t\t0x00, 0x00, 0x80, 0xa0, 0x70, 0xb0,\n\t\t0x23, 0x40, 0x30, 0x20, 0x36, 0x00, 0x06, 0x44, 0x21, 0x00, 0x00, 0x1a,\n\t\t \n\t\t0x00, 0x00, 0x00, 0xfd, 0x00, 0x18, 0x3c, 0x18, 0x50, 0x11, 0x00, 0x0a,\n\t\t0x20, 0x20, 0x20, 0x20, 0x20, 0x20,\n\t\t \n\t\t0x00, 0x00, 0x00, 0xfc, 0x00, 0x48,\n\t\t0x50, 0x20, 0x5a, 0x52, 0x32, 0x34, 0x34, 0x30, 0x77, 0x0a, 0x20, 0x20,\n\t\t \n\t\t0x00, 0x00, 0x00, 0xff, 0x00, 0x43, 0x4e, 0x34, 0x33, 0x30, 0x34, 0x30,\n\t\t0x44, 0x58, 0x51, 0x0a, 0x20, 0x20,\n\t\t \n\t\t0x00,\n\t\t \n\t\t0xef,\n\t},\n\t{\n \n\t\t \n\t\t0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,\n\t\t \n\t\t0x22, 0xf0, 0x54, 0x29, 0x00, 0x00, 0x00, 0x00, 0x04, 0x17,\n\t\t \n\t\t0x01, 0x04,\n\t\t \n\t\t0xa5, 0x34, 0x20, 0x78, 0x23,\n\t\t \n\t\t0xfc, 0x81, 0xa4, 0x55, 0x4d, 0x9d, 0x25, 0x12, 0x50, 0x54,\n\t\t \n\t\t0x21, 0x08, 0x00,\n\t\t \n\t\t0xd1, 0xc0, 0x81, 0xc0, 0x81, 0x40, 0x81, 0x80, 0x95, 0x00,\n\t\t0xa9, 0x40, 0xb3, 0x00, 0x01, 0x01,\n\t\t \n\t\t0x28, 0x3c, 0x80, 0xa0, 0x70, 0xb0,\n\t\t0x23, 0x40, 0x30, 0x20, 0x36, 0x00, 0x06, 0x44, 0x21, 0x00, 0x00, 0x1a,\n\t\t \n\t\t0x00, 0x00, 0x00, 0xfd, 0x00, 0x18, 0x3c, 0x18, 0x50, 0x11, 0x00, 0x0a,\n\t\t0x20, 0x20, 0x20, 0x20, 0x20, 0x20,\n\t\t \n\t\t0x00, 0x00, 0x00, 0xfc, 0x00, 0x48,\n\t\t0x50, 0x20, 0x5a, 0x52, 0x32, 0x34, 0x34, 0x30, 0x77, 0x0a, 0x20, 0x20,\n\t\t \n\t\t0x00, 0x00, 0x00, 0xff, 0x00, 0x43, 0x4e, 0x34, 0x33, 0x30, 0x34, 0x30,\n\t\t0x44, 0x58, 0x51, 0x0a, 0x20, 0x20,\n\t\t \n\t\t0x00,\n\t\t \n\t\t0x45,\n\t},\n};\n\n#define DPCD_HEADER_SIZE        0xb\n\n \nstatic u8 dpcd_fix_data[DPCD_HEADER_SIZE] = {\n\t0x12, 0x014, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\n};\n\nstatic void emulate_monitor_status_change(struct intel_vgpu *vgpu)\n{\n\tstruct drm_i915_private *dev_priv = vgpu->gvt->gt->i915;\n\tint pipe;\n\n\tif (IS_BROXTON(dev_priv)) {\n\t\tenum transcoder trans;\n\t\tenum port port;\n\n\t\t \n\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) &=\n\t\t\t~(GEN8_DE_PORT_HOTPLUG(HPD_PORT_A) |\n\t\t\t  GEN8_DE_PORT_HOTPLUG(HPD_PORT_B) |\n\t\t\t  GEN8_DE_PORT_HOTPLUG(HPD_PORT_C));\n\n\t\tfor_each_pipe(dev_priv, pipe) {\n\t\t\tvgpu_vreg_t(vgpu, TRANSCONF(pipe)) &=\n\t\t\t\t~(TRANSCONF_ENABLE | TRANSCONF_STATE_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, DSPCNTR(pipe)) &= ~DISP_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, SPRCTL(pipe)) &= ~SPRITE_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, CURCNTR(pipe)) &= ~MCURSOR_MODE_MASK;\n\t\t\tvgpu_vreg_t(vgpu, CURCNTR(pipe)) |= MCURSOR_MODE_DISABLE;\n\t\t}\n\n\t\tfor (trans = TRANSCODER_A; trans <= TRANSCODER_EDP; trans++) {\n\t\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(trans)) &=\n\t\t\t\t~(TRANS_DDI_BPC_MASK | TRANS_DDI_MODE_SELECT_MASK |\n\t\t\t\t  TRANS_DDI_PORT_MASK | TRANS_DDI_FUNC_ENABLE);\n\t\t}\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) &=\n\t\t\t~(TRANS_DDI_BPC_MASK | TRANS_DDI_MODE_SELECT_MASK |\n\t\t\t  TRANS_DDI_PORT_MASK);\n\n\t\tfor (port = PORT_A; port <= PORT_C; port++) {\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(port)) &=\n\t\t\t\t~BXT_PHY_LANE_ENABLED;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(port)) |=\n\t\t\t\t(BXT_PHY_CMNLANE_POWERDOWN_ACK |\n\t\t\t\t BXT_PHY_LANE_POWERDOWN_ACK);\n\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_PLL_ENABLE(port)) &=\n\t\t\t\t~(PORT_PLL_POWER_STATE | PORT_PLL_POWER_ENABLE |\n\t\t\t\t  PORT_PLL_REF_SEL | PORT_PLL_LOCK |\n\t\t\t\t  PORT_PLL_ENABLE);\n\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(port)) &=\n\t\t\t\t~(DDI_INIT_DISPLAY_DETECTED |\n\t\t\t\t  DDI_BUF_CTL_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(port)) |= DDI_BUF_IS_IDLE;\n\t\t}\n\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &=\n\t\t\t~(PORTA_HOTPLUG_ENABLE | PORTA_HOTPLUG_STATUS_MASK);\n\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &=\n\t\t\t~(PORTB_HOTPLUG_ENABLE | PORTB_HOTPLUG_STATUS_MASK);\n\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &=\n\t\t\t~(PORTC_HOTPLUG_ENABLE | PORTC_HOTPLUG_STATUS_MASK);\n\t\t \n\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &= ~BXT_DDI_HPD_INVERT_MASK;\n\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) &= ~BXT_DE_PORT_HOTPLUG_MASK;\n\n\t\tvgpu_vreg_t(vgpu, BXT_P_CR_GT_DISP_PWRON) &= ~(BIT(0) | BIT(1));\n\t\tvgpu_vreg_t(vgpu, BXT_PORT_CL1CM_DW0(DPIO_PHY0)) &=\n\t\t\t~PHY_POWER_GOOD;\n\t\tvgpu_vreg_t(vgpu, BXT_PORT_CL1CM_DW0(DPIO_PHY1)) &=\n\t\t\t~PHY_POWER_GOOD;\n\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL_FAMILY(DPIO_PHY0)) &= ~BIT(30);\n\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL_FAMILY(DPIO_PHY1)) &= ~BIT(30);\n\n\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) &= ~SFUSE_STRAP_DDIB_DETECTED;\n\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) &= ~SFUSE_STRAP_DDIC_DETECTED;\n\n\t\t \n\t\tvgpu_vreg_t(vgpu, TRANSCONF(TRANSCODER_A)) |= TRANSCONF_ENABLE;\n\t\tvgpu_vreg_t(vgpu, TRANSCONF(TRANSCODER_A)) |= TRANSCONF_STATE_ENABLE;\n\n\t\t \n\t\tvgpu_vreg_t(vgpu, PIPE_DATA_M1(TRANSCODER_A)) = TU_SIZE(64);\n\t\tvgpu_vreg_t(vgpu, PIPE_DATA_M1(TRANSCODER_A)) |= 0x5b425e;\n\t\tvgpu_vreg_t(vgpu, PIPE_DATA_N1(TRANSCODER_A)) = 0x800000;\n\t\tvgpu_vreg_t(vgpu, PIPE_LINK_M1(TRANSCODER_A)) = 0x3cd6e;\n\t\tvgpu_vreg_t(vgpu, PIPE_LINK_N1(TRANSCODER_A)) = 0x80000;\n\n\t\t \n\t\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_A)) {\n\t\t\tvgpu_vreg_t(vgpu, BXT_P_CR_GT_DISP_PWRON) |= BIT(1);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_CL1CM_DW0(DPIO_PHY1)) |=\n\t\t\t\tPHY_POWER_GOOD;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL_FAMILY(DPIO_PHY1)) |=\n\t\t\t\tBIT(30);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(PORT_A)) |=\n\t\t\t\tBXT_PHY_LANE_ENABLED;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(PORT_A)) &=\n\t\t\t\t~(BXT_PHY_CMNLANE_POWERDOWN_ACK |\n\t\t\t\t  BXT_PHY_LANE_POWERDOWN_ACK);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_PLL_ENABLE(PORT_A)) |=\n\t\t\t\t(PORT_PLL_POWER_STATE | PORT_PLL_POWER_ENABLE |\n\t\t\t\t PORT_PLL_REF_SEL | PORT_PLL_LOCK |\n\t\t\t\t PORT_PLL_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_A)) |=\n\t\t\t\t(DDI_BUF_CTL_ENABLE | DDI_INIT_DISPLAY_DETECTED);\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_A)) &=\n\t\t\t\t~DDI_BUF_IS_IDLE;\n\t\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_EDP)) |=\n\t\t\t\t(TRANS_DDI_BPC_8 | TRANS_DDI_MODE_SELECT_DP_SST |\n\t\t\t\t TRANS_DDI_FUNC_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTA_HOTPLUG_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_A);\n\t\t}\n\n\t\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_B)) {\n\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |= SFUSE_STRAP_DDIB_DETECTED;\n\t\t\tvgpu_vreg_t(vgpu, BXT_P_CR_GT_DISP_PWRON) |= BIT(0);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_CL1CM_DW0(DPIO_PHY0)) |=\n\t\t\t\tPHY_POWER_GOOD;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL_FAMILY(DPIO_PHY0)) |=\n\t\t\t\tBIT(30);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(PORT_B)) |=\n\t\t\t\tBXT_PHY_LANE_ENABLED;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(PORT_B)) &=\n\t\t\t\t~(BXT_PHY_CMNLANE_POWERDOWN_ACK |\n\t\t\t\t  BXT_PHY_LANE_POWERDOWN_ACK);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_PLL_ENABLE(PORT_B)) |=\n\t\t\t\t(PORT_PLL_POWER_STATE | PORT_PLL_POWER_ENABLE |\n\t\t\t\t PORT_PLL_REF_SEL | PORT_PLL_LOCK |\n\t\t\t\t PORT_PLL_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_B)) |=\n\t\t\t\tDDI_BUF_CTL_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_B)) &=\n\t\t\t\t~DDI_BUF_IS_IDLE;\n\t\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) |=\n\t\t\t\t(TRANS_DDI_BPC_8 | TRANS_DDI_MODE_SELECT_DP_SST |\n\t\t\t\t (PORT_B << TRANS_DDI_PORT_SHIFT) |\n\t\t\t\t TRANS_DDI_FUNC_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTB_HOTPLUG_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_B);\n\t\t}\n\n\t\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_C)) {\n\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |= SFUSE_STRAP_DDIC_DETECTED;\n\t\t\tvgpu_vreg_t(vgpu, BXT_P_CR_GT_DISP_PWRON) |= BIT(0);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_CL1CM_DW0(DPIO_PHY0)) |=\n\t\t\t\tPHY_POWER_GOOD;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL_FAMILY(DPIO_PHY0)) |=\n\t\t\t\tBIT(30);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(PORT_C)) |=\n\t\t\t\tBXT_PHY_LANE_ENABLED;\n\t\t\tvgpu_vreg_t(vgpu, BXT_PHY_CTL(PORT_C)) &=\n\t\t\t\t~(BXT_PHY_CMNLANE_POWERDOWN_ACK |\n\t\t\t\t  BXT_PHY_LANE_POWERDOWN_ACK);\n\t\t\tvgpu_vreg_t(vgpu, BXT_PORT_PLL_ENABLE(PORT_C)) |=\n\t\t\t\t(PORT_PLL_POWER_STATE | PORT_PLL_POWER_ENABLE |\n\t\t\t\t PORT_PLL_REF_SEL | PORT_PLL_LOCK |\n\t\t\t\t PORT_PLL_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_C)) |=\n\t\t\t\tDDI_BUF_CTL_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_C)) &=\n\t\t\t\t~DDI_BUF_IS_IDLE;\n\t\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) |=\n\t\t\t\t(TRANS_DDI_BPC_8 | TRANS_DDI_MODE_SELECT_DP_SST |\n\t\t\t\t (PORT_B << TRANS_DDI_PORT_SHIFT) |\n\t\t\t\t TRANS_DDI_FUNC_ENABLE);\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTC_HOTPLUG_ENABLE;\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_C);\n\t\t}\n\n\t\treturn;\n\t}\n\n\tvgpu_vreg_t(vgpu, SDEISR) &= ~(SDE_PORTB_HOTPLUG_CPT |\n\t\t\tSDE_PORTC_HOTPLUG_CPT |\n\t\t\tSDE_PORTD_HOTPLUG_CPT);\n\n\tif (IS_SKYLAKE(dev_priv) ||\n\t    IS_KABYLAKE(dev_priv) ||\n\t    IS_COFFEELAKE(dev_priv) ||\n\t    IS_COMETLAKE(dev_priv)) {\n\t\tvgpu_vreg_t(vgpu, SDEISR) &= ~(SDE_PORTA_HOTPLUG_SPT |\n\t\t\t\tSDE_PORTE_HOTPLUG_SPT);\n\t\tvgpu_vreg_t(vgpu, SKL_FUSE_STATUS) |=\n\t\t\t\tSKL_FUSE_DOWNLOAD_STATUS |\n\t\t\t\tSKL_FUSE_PG_DIST_STATUS(SKL_PG0) |\n\t\t\t\tSKL_FUSE_PG_DIST_STATUS(SKL_PG1) |\n\t\t\t\tSKL_FUSE_PG_DIST_STATUS(SKL_PG2);\n\t\t \n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL1) =\n\t\t\tDPLL_CTRL1_OVERRIDE(DPLL_ID_SKL_DPLL0);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL1) |=\n\t\t\tDPLL_CTRL1_LINK_RATE(DPLL_CTRL1_LINK_RATE_1620, DPLL_ID_SKL_DPLL0);\n\t\tvgpu_vreg_t(vgpu, LCPLL1_CTL) =\n\t\t\tLCPLL_PLL_ENABLE | LCPLL_PLL_LOCK;\n\t\tvgpu_vreg_t(vgpu, DPLL_STATUS) = DPLL_LOCK(DPLL_ID_SKL_DPLL0);\n\t\t \n\t\tvgpu_vreg_t(vgpu, PIPE_DATA_M1(TRANSCODER_A)) = TU_SIZE(64);\n\t\tvgpu_vreg_t(vgpu, PIPE_DATA_M1(TRANSCODER_A)) |= 0x5b425e;\n\t\tvgpu_vreg_t(vgpu, PIPE_DATA_N1(TRANSCODER_A)) = 0x800000;\n\t\tvgpu_vreg_t(vgpu, PIPE_LINK_M1(TRANSCODER_A)) = 0x3cd6e;\n\t\tvgpu_vreg_t(vgpu, PIPE_LINK_N1(TRANSCODER_A)) = 0x80000;\n\t}\n\n\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_B)) {\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) &=\n\t\t\t~DPLL_CTRL2_DDI_CLK_OFF(PORT_B);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) |=\n\t\t\tDPLL_CTRL2_DDI_CLK_SEL(DPLL_ID_SKL_DPLL0, PORT_B);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) |=\n\t\t\tDPLL_CTRL2_DDI_SEL_OVERRIDE(PORT_B);\n\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |= SFUSE_STRAP_DDIB_DETECTED;\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) &=\n\t\t\t~(TRANS_DDI_BPC_MASK | TRANS_DDI_MODE_SELECT_MASK |\n\t\t\tTRANS_DDI_PORT_MASK);\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) |=\n\t\t\t(TRANS_DDI_BPC_8 | TRANS_DDI_MODE_SELECT_DP_SST |\n\t\t\t(PORT_B << TRANS_DDI_PORT_SHIFT) |\n\t\t\tTRANS_DDI_FUNC_ENABLE);\n\t\tif (IS_BROADWELL(dev_priv)) {\n\t\t\tvgpu_vreg_t(vgpu, PORT_CLK_SEL(PORT_B)) &=\n\t\t\t\t~PORT_CLK_SEL_MASK;\n\t\t\tvgpu_vreg_t(vgpu, PORT_CLK_SEL(PORT_B)) |=\n\t\t\t\tPORT_CLK_SEL_LCPLL_810;\n\t\t}\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_B)) |= DDI_BUF_CTL_ENABLE;\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_B)) &= ~DDI_BUF_IS_IDLE;\n\t\tvgpu_vreg_t(vgpu, SDEISR) |= SDE_PORTB_HOTPLUG_CPT;\n\t}\n\n\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_C)) {\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) &=\n\t\t\t~DPLL_CTRL2_DDI_CLK_OFF(PORT_C);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) |=\n\t\t\tDPLL_CTRL2_DDI_CLK_SEL(DPLL_ID_SKL_DPLL0, PORT_C);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) |=\n\t\t\tDPLL_CTRL2_DDI_SEL_OVERRIDE(PORT_C);\n\t\tvgpu_vreg_t(vgpu, SDEISR) |= SDE_PORTC_HOTPLUG_CPT;\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) &=\n\t\t\t~(TRANS_DDI_BPC_MASK | TRANS_DDI_MODE_SELECT_MASK |\n\t\t\tTRANS_DDI_PORT_MASK);\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) |=\n\t\t\t(TRANS_DDI_BPC_8 | TRANS_DDI_MODE_SELECT_DP_SST |\n\t\t\t(PORT_C << TRANS_DDI_PORT_SHIFT) |\n\t\t\tTRANS_DDI_FUNC_ENABLE);\n\t\tif (IS_BROADWELL(dev_priv)) {\n\t\t\tvgpu_vreg_t(vgpu, PORT_CLK_SEL(PORT_C)) &=\n\t\t\t\t~PORT_CLK_SEL_MASK;\n\t\t\tvgpu_vreg_t(vgpu, PORT_CLK_SEL(PORT_C)) |=\n\t\t\t\tPORT_CLK_SEL_LCPLL_810;\n\t\t}\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_C)) |= DDI_BUF_CTL_ENABLE;\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_C)) &= ~DDI_BUF_IS_IDLE;\n\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |= SFUSE_STRAP_DDIC_DETECTED;\n\t}\n\n\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_D)) {\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) &=\n\t\t\t~DPLL_CTRL2_DDI_CLK_OFF(PORT_D);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) |=\n\t\t\tDPLL_CTRL2_DDI_CLK_SEL(DPLL_ID_SKL_DPLL0, PORT_D);\n\t\tvgpu_vreg_t(vgpu, DPLL_CTRL2) |=\n\t\t\tDPLL_CTRL2_DDI_SEL_OVERRIDE(PORT_D);\n\t\tvgpu_vreg_t(vgpu, SDEISR) |= SDE_PORTD_HOTPLUG_CPT;\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) &=\n\t\t\t~(TRANS_DDI_BPC_MASK | TRANS_DDI_MODE_SELECT_MASK |\n\t\t\tTRANS_DDI_PORT_MASK);\n\t\tvgpu_vreg_t(vgpu, TRANS_DDI_FUNC_CTL(TRANSCODER_A)) |=\n\t\t\t(TRANS_DDI_BPC_8 | TRANS_DDI_MODE_SELECT_DP_SST |\n\t\t\t(PORT_D << TRANS_DDI_PORT_SHIFT) |\n\t\t\tTRANS_DDI_FUNC_ENABLE);\n\t\tif (IS_BROADWELL(dev_priv)) {\n\t\t\tvgpu_vreg_t(vgpu, PORT_CLK_SEL(PORT_D)) &=\n\t\t\t\t~PORT_CLK_SEL_MASK;\n\t\t\tvgpu_vreg_t(vgpu, PORT_CLK_SEL(PORT_D)) |=\n\t\t\t\tPORT_CLK_SEL_LCPLL_810;\n\t\t}\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_D)) |= DDI_BUF_CTL_ENABLE;\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_D)) &= ~DDI_BUF_IS_IDLE;\n\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |= SFUSE_STRAP_DDID_DETECTED;\n\t}\n\n\tif ((IS_SKYLAKE(dev_priv) ||\n\t     IS_KABYLAKE(dev_priv) ||\n\t     IS_COFFEELAKE(dev_priv) ||\n\t     IS_COMETLAKE(dev_priv)) &&\n\t\t\tintel_vgpu_has_monitor_on_port(vgpu, PORT_E)) {\n\t\tvgpu_vreg_t(vgpu, SDEISR) |= SDE_PORTE_HOTPLUG_SPT;\n\t}\n\n\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_A)) {\n\t\tif (IS_BROADWELL(dev_priv))\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_A);\n\t\telse\n\t\t\tvgpu_vreg_t(vgpu, SDEISR) |= SDE_PORTA_HOTPLUG_SPT;\n\n\t\tvgpu_vreg_t(vgpu, DDI_BUF_CTL(PORT_A)) |= DDI_INIT_DISPLAY_DETECTED;\n\t}\n\n\t \n\tif (IS_BROADWELL(dev_priv))\n\t\tvgpu_vreg_t(vgpu, PCH_ADPA) &= ~ADPA_CRT_HOTPLUG_MONITOR_MASK;\n\n\t \n\tfor_each_pipe(dev_priv, pipe) {\n\t\tvgpu_vreg_t(vgpu, DSPCNTR(pipe)) &= ~DISP_ENABLE;\n\t\tvgpu_vreg_t(vgpu, SPRCTL(pipe)) &= ~SPRITE_ENABLE;\n\t\tvgpu_vreg_t(vgpu, CURCNTR(pipe)) &= ~MCURSOR_MODE_MASK;\n\t\tvgpu_vreg_t(vgpu, CURCNTR(pipe)) |= MCURSOR_MODE_DISABLE;\n\t}\n\n\tvgpu_vreg_t(vgpu, TRANSCONF(TRANSCODER_A)) |= TRANSCONF_ENABLE;\n}\n\nstatic void clean_virtual_dp_monitor(struct intel_vgpu *vgpu, int port_num)\n{\n\tstruct intel_vgpu_port *port = intel_vgpu_port(vgpu, port_num);\n\n\tkfree(port->edid);\n\tport->edid = NULL;\n\n\tkfree(port->dpcd);\n\tport->dpcd = NULL;\n}\n\nstatic enum hrtimer_restart vblank_timer_fn(struct hrtimer *data)\n{\n\tstruct intel_vgpu_vblank_timer *vblank_timer;\n\tstruct intel_vgpu *vgpu;\n\n\tvblank_timer = container_of(data, struct intel_vgpu_vblank_timer, timer);\n\tvgpu = container_of(vblank_timer, struct intel_vgpu, vblank_timer);\n\n\t \n\tintel_gvt_request_service(vgpu->gvt,\n\t\t\t\t  INTEL_GVT_REQUEST_EMULATE_VBLANK + vgpu->id);\n\thrtimer_add_expires_ns(&vblank_timer->timer, vblank_timer->period);\n\treturn HRTIMER_RESTART;\n}\n\nstatic int setup_virtual_dp_monitor(struct intel_vgpu *vgpu, int port_num,\n\t\t\t\t    int type, unsigned int resolution)\n{\n\tstruct drm_i915_private *i915 = vgpu->gvt->gt->i915;\n\tstruct intel_vgpu_port *port = intel_vgpu_port(vgpu, port_num);\n\tstruct intel_vgpu_vblank_timer *vblank_timer = &vgpu->vblank_timer;\n\n\tif (drm_WARN_ON(&i915->drm, resolution >= GVT_EDID_NUM))\n\t\treturn -EINVAL;\n\n\tport->edid = kzalloc(sizeof(*(port->edid)), GFP_KERNEL);\n\tif (!port->edid)\n\t\treturn -ENOMEM;\n\n\tport->dpcd = kzalloc(sizeof(*(port->dpcd)), GFP_KERNEL);\n\tif (!port->dpcd) {\n\t\tkfree(port->edid);\n\t\treturn -ENOMEM;\n\t}\n\n\tmemcpy(port->edid->edid_block, virtual_dp_monitor_edid[resolution],\n\t\t\tEDID_SIZE);\n\tport->edid->data_valid = true;\n\n\tmemcpy(port->dpcd->data, dpcd_fix_data, DPCD_HEADER_SIZE);\n\tport->dpcd->data_valid = true;\n\tport->dpcd->data[DPCD_SINK_COUNT] = 0x1;\n\tport->type = type;\n\tport->id = resolution;\n\tport->vrefresh_k = GVT_DEFAULT_REFRESH_RATE * MSEC_PER_SEC;\n\tvgpu->display.port_num = port_num;\n\n\t \n\thrtimer_init(&vblank_timer->timer, CLOCK_MONOTONIC, HRTIMER_MODE_ABS);\n\tvblank_timer->timer.function = vblank_timer_fn;\n\tvblank_timer->vrefresh_k = port->vrefresh_k;\n\tvblank_timer->period = DIV64_U64_ROUND_CLOSEST(NSEC_PER_SEC * MSEC_PER_SEC, vblank_timer->vrefresh_k);\n\n\temulate_monitor_status_change(vgpu);\n\n\treturn 0;\n}\n\n \nvoid vgpu_update_vblank_emulation(struct intel_vgpu *vgpu, bool turnon)\n{\n\tstruct intel_vgpu_vblank_timer *vblank_timer = &vgpu->vblank_timer;\n\tstruct intel_vgpu_port *port =\n\t\tintel_vgpu_port(vgpu, vgpu->display.port_num);\n\n\tif (turnon) {\n\t\t \n\t\tif (vblank_timer->vrefresh_k != port->vrefresh_k ||\n\t\t    !hrtimer_active(&vblank_timer->timer)) {\n\t\t\t \n\t\t\tif (hrtimer_active(&vblank_timer->timer))\n\t\t\t\thrtimer_cancel(&vblank_timer->timer);\n\n\t\t\t \n\t\t\tvblank_timer->vrefresh_k = port->vrefresh_k;\n\t\t\tvblank_timer->period = DIV64_U64_ROUND_CLOSEST(NSEC_PER_SEC * MSEC_PER_SEC, vblank_timer->vrefresh_k);\n\t\t\thrtimer_start(&vblank_timer->timer,\n\t\t\t\t      ktime_add_ns(ktime_get(), vblank_timer->period),\n\t\t\t\t      HRTIMER_MODE_ABS);\n\t\t}\n\t} else {\n\t\t \n\t\thrtimer_cancel(&vblank_timer->timer);\n\t}\n}\n\nstatic void emulate_vblank_on_pipe(struct intel_vgpu *vgpu, int pipe)\n{\n\tstruct drm_i915_private *dev_priv = vgpu->gvt->gt->i915;\n\tstruct intel_vgpu_irq *irq = &vgpu->irq;\n\tint vblank_event[] = {\n\t\t[PIPE_A] = PIPE_A_VBLANK,\n\t\t[PIPE_B] = PIPE_B_VBLANK,\n\t\t[PIPE_C] = PIPE_C_VBLANK,\n\t};\n\tint event;\n\n\tif (pipe < PIPE_A || pipe > PIPE_C)\n\t\treturn;\n\n\tfor_each_set_bit(event, irq->flip_done_event[pipe],\n\t\t\tINTEL_GVT_EVENT_MAX) {\n\t\tclear_bit(event, irq->flip_done_event[pipe]);\n\t\tif (!pipe_is_enabled(vgpu, pipe))\n\t\t\tcontinue;\n\n\t\tintel_vgpu_trigger_virtual_event(vgpu, event);\n\t}\n\n\tif (pipe_is_enabled(vgpu, pipe)) {\n\t\tvgpu_vreg_t(vgpu, PIPE_FRMCOUNT_G4X(pipe))++;\n\t\tintel_vgpu_trigger_virtual_event(vgpu, vblank_event[pipe]);\n\t}\n}\n\nvoid intel_vgpu_emulate_vblank(struct intel_vgpu *vgpu)\n{\n\tint pipe;\n\n\tmutex_lock(&vgpu->vgpu_lock);\n\tfor_each_pipe(vgpu->gvt->gt->i915, pipe)\n\t\temulate_vblank_on_pipe(vgpu, pipe);\n\tmutex_unlock(&vgpu->vgpu_lock);\n}\n\n \nvoid intel_vgpu_emulate_hotplug(struct intel_vgpu *vgpu, bool connected)\n{\n\tstruct drm_i915_private *i915 = vgpu->gvt->gt->i915;\n\n\t \n\tif (IS_SKYLAKE(i915) ||\n\t    IS_KABYLAKE(i915) ||\n\t    IS_COFFEELAKE(i915) ||\n\t    IS_COMETLAKE(i915)) {\n\t\tif (connected) {\n\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |=\n\t\t\t\tSFUSE_STRAP_DDID_DETECTED;\n\t\t\tvgpu_vreg_t(vgpu, SDEISR) |= SDE_PORTD_HOTPLUG_CPT;\n\t\t} else {\n\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) &=\n\t\t\t\t~SFUSE_STRAP_DDID_DETECTED;\n\t\t\tvgpu_vreg_t(vgpu, SDEISR) &= ~SDE_PORTD_HOTPLUG_CPT;\n\t\t}\n\t\tvgpu_vreg_t(vgpu, SDEIIR) |= SDE_PORTD_HOTPLUG_CPT;\n\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTD_HOTPLUG_STATUS_MASK;\n\t\tintel_vgpu_trigger_virtual_event(vgpu, DP_D_HOTPLUG);\n\t} else if (IS_BROXTON(i915)) {\n\t\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_A)) {\n\t\t\tif (connected) {\n\t\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_A);\n\t\t\t} else {\n\t\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) &=\n\t\t\t\t\t~GEN8_DE_PORT_HOTPLUG(HPD_PORT_A);\n\t\t\t}\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_IIR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_A);\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &=\n\t\t\t\t~PORTA_HOTPLUG_STATUS_MASK;\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTA_HOTPLUG_LONG_DETECT;\n\t\t\tintel_vgpu_trigger_virtual_event(vgpu, DP_A_HOTPLUG);\n\t\t}\n\t\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_B)) {\n\t\t\tif (connected) {\n\t\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_B);\n\t\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |=\n\t\t\t\t\tSFUSE_STRAP_DDIB_DETECTED;\n\t\t\t} else {\n\t\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) &=\n\t\t\t\t\t~GEN8_DE_PORT_HOTPLUG(HPD_PORT_B);\n\t\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) &=\n\t\t\t\t\t~SFUSE_STRAP_DDIB_DETECTED;\n\t\t\t}\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_IIR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_B);\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &=\n\t\t\t\t~PORTB_HOTPLUG_STATUS_MASK;\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTB_HOTPLUG_LONG_DETECT;\n\t\t\tintel_vgpu_trigger_virtual_event(vgpu, DP_B_HOTPLUG);\n\t\t}\n\t\tif (intel_vgpu_has_monitor_on_port(vgpu, PORT_C)) {\n\t\t\tif (connected) {\n\t\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) |=\n\t\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_C);\n\t\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) |=\n\t\t\t\t\tSFUSE_STRAP_DDIC_DETECTED;\n\t\t\t} else {\n\t\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_ISR) &=\n\t\t\t\t\t~GEN8_DE_PORT_HOTPLUG(HPD_PORT_C);\n\t\t\t\tvgpu_vreg_t(vgpu, SFUSE_STRAP) &=\n\t\t\t\t\t~SFUSE_STRAP_DDIC_DETECTED;\n\t\t\t}\n\t\t\tvgpu_vreg_t(vgpu, GEN8_DE_PORT_IIR) |=\n\t\t\t\tGEN8_DE_PORT_HOTPLUG(HPD_PORT_C);\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) &=\n\t\t\t\t~PORTC_HOTPLUG_STATUS_MASK;\n\t\t\tvgpu_vreg_t(vgpu, PCH_PORT_HOTPLUG) |=\n\t\t\t\tPORTC_HOTPLUG_LONG_DETECT;\n\t\t\tintel_vgpu_trigger_virtual_event(vgpu, DP_C_HOTPLUG);\n\t\t}\n\t}\n}\n\n \nvoid intel_vgpu_clean_display(struct intel_vgpu *vgpu)\n{\n\tstruct drm_i915_private *dev_priv = vgpu->gvt->gt->i915;\n\n\tif (IS_SKYLAKE(dev_priv) ||\n\t    IS_KABYLAKE(dev_priv) ||\n\t    IS_COFFEELAKE(dev_priv) ||\n\t    IS_COMETLAKE(dev_priv))\n\t\tclean_virtual_dp_monitor(vgpu, PORT_D);\n\telse\n\t\tclean_virtual_dp_monitor(vgpu, PORT_B);\n\n\tvgpu_update_vblank_emulation(vgpu, false);\n}\n\n \nint intel_vgpu_init_display(struct intel_vgpu *vgpu, u64 resolution)\n{\n\tstruct drm_i915_private *dev_priv = vgpu->gvt->gt->i915;\n\n\tintel_vgpu_init_i2c_edid(vgpu);\n\n\tif (IS_SKYLAKE(dev_priv) ||\n\t    IS_KABYLAKE(dev_priv) ||\n\t    IS_COFFEELAKE(dev_priv) ||\n\t    IS_COMETLAKE(dev_priv))\n\t\treturn setup_virtual_dp_monitor(vgpu, PORT_D, GVT_DP_D,\n\t\t\t\t\t\tresolution);\n\telse\n\t\treturn setup_virtual_dp_monitor(vgpu, PORT_B, GVT_DP_B,\n\t\t\t\t\t\tresolution);\n}\n\n \nvoid intel_vgpu_reset_display(struct intel_vgpu *vgpu)\n{\n\temulate_monitor_status_change(vgpu);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}