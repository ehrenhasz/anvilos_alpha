{
  "module_name": "gtt.h",
  "hash_id": "3d4410ca28db07bc86418d75cd8e32b401a04faf9f68e84188445f5baa1678e9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gvt/gtt.h",
  "human_readable_source": " \n\n#ifndef _GVT_GTT_H_\n#define _GVT_GTT_H_\n\n#include <linux/kernel.h>\n#include <linux/kref.h>\n#include <linux/mutex.h>\n#include <linux/radix-tree.h>\n\n#include \"gt/intel_gtt.h\"\n\nstruct intel_gvt;\nstruct intel_vgpu;\nstruct intel_vgpu_mm;\n\n#define I915_GTT_PAGE_SHIFT         12\n\n#define INTEL_GVT_INVALID_ADDR (~0UL)\n\nstruct intel_gvt_gtt_entry {\n\tu64 val64;\n\tint type;\n};\n\nstruct intel_gvt_gtt_pte_ops {\n\tint (*get_entry)(void *pt,\n\t\t\t struct intel_gvt_gtt_entry *e,\n\t\t\t unsigned long index,\n\t\t\t bool hypervisor_access,\n\t\t\t unsigned long gpa,\n\t\t\t struct intel_vgpu *vgpu);\n\tint (*set_entry)(void *pt,\n\t\t\t struct intel_gvt_gtt_entry *e,\n\t\t\t unsigned long index,\n\t\t\t bool hypervisor_access,\n\t\t\t unsigned long gpa,\n\t\t\t struct intel_vgpu *vgpu);\n\tbool (*test_present)(struct intel_gvt_gtt_entry *e);\n\tvoid (*clear_present)(struct intel_gvt_gtt_entry *e);\n\tvoid (*set_present)(struct intel_gvt_gtt_entry *e);\n\tbool (*test_pse)(struct intel_gvt_gtt_entry *e);\n\tvoid (*clear_pse)(struct intel_gvt_gtt_entry *e);\n\tbool (*test_ips)(struct intel_gvt_gtt_entry *e);\n\tvoid (*clear_ips)(struct intel_gvt_gtt_entry *e);\n\tbool (*test_64k_splited)(struct intel_gvt_gtt_entry *e);\n\tvoid (*clear_64k_splited)(struct intel_gvt_gtt_entry *e);\n\tvoid (*set_64k_splited)(struct intel_gvt_gtt_entry *e);\n\tvoid (*set_pfn)(struct intel_gvt_gtt_entry *e, unsigned long pfn);\n\tunsigned long (*get_pfn)(struct intel_gvt_gtt_entry *e);\n};\n\nstruct intel_gvt_gtt_gma_ops {\n\tunsigned long (*gma_to_ggtt_pte_index)(unsigned long gma);\n\tunsigned long (*gma_to_pte_index)(unsigned long gma);\n\tunsigned long (*gma_to_pde_index)(unsigned long gma);\n\tunsigned long (*gma_to_l3_pdp_index)(unsigned long gma);\n\tunsigned long (*gma_to_l4_pdp_index)(unsigned long gma);\n\tunsigned long (*gma_to_pml4_index)(unsigned long gma);\n};\n\nstruct intel_gvt_gtt {\n\tconst struct intel_gvt_gtt_pte_ops *pte_ops;\n\tconst struct intel_gvt_gtt_gma_ops *gma_ops;\n\tint (*mm_alloc_page_table)(struct intel_vgpu_mm *mm);\n\tvoid (*mm_free_page_table)(struct intel_vgpu_mm *mm);\n\tstruct list_head oos_page_use_list_head;\n\tstruct list_head oos_page_free_list_head;\n\tstruct mutex ppgtt_mm_lock;\n\tstruct list_head ppgtt_mm_lru_list_head;\n\n\tstruct page *scratch_page;\n\tunsigned long scratch_mfn;\n};\n\nenum intel_gvt_gtt_type {\n\tGTT_TYPE_INVALID = 0,\n\n\tGTT_TYPE_GGTT_PTE,\n\n\tGTT_TYPE_PPGTT_PTE_4K_ENTRY,\n\tGTT_TYPE_PPGTT_PTE_64K_ENTRY,\n\tGTT_TYPE_PPGTT_PTE_2M_ENTRY,\n\tGTT_TYPE_PPGTT_PTE_1G_ENTRY,\n\n\tGTT_TYPE_PPGTT_PTE_ENTRY,\n\n\tGTT_TYPE_PPGTT_PDE_ENTRY,\n\tGTT_TYPE_PPGTT_PDP_ENTRY,\n\tGTT_TYPE_PPGTT_PML4_ENTRY,\n\n\tGTT_TYPE_PPGTT_ROOT_ENTRY,\n\n\tGTT_TYPE_PPGTT_ROOT_L3_ENTRY,\n\tGTT_TYPE_PPGTT_ROOT_L4_ENTRY,\n\n\tGTT_TYPE_PPGTT_ENTRY,\n\n\tGTT_TYPE_PPGTT_PTE_PT,\n\tGTT_TYPE_PPGTT_PDE_PT,\n\tGTT_TYPE_PPGTT_PDP_PT,\n\tGTT_TYPE_PPGTT_PML4_PT,\n\n\tGTT_TYPE_MAX,\n};\n\nenum intel_gvt_mm_type {\n\tINTEL_GVT_MM_GGTT,\n\tINTEL_GVT_MM_PPGTT,\n};\n\n#define GVT_RING_CTX_NR_PDPS\tGEN8_3LVL_PDPES\n\nstruct intel_gvt_partial_pte {\n\tunsigned long offset;\n\tu64 data;\n\tstruct list_head list;\n};\n\nstruct intel_vgpu_mm {\n\tenum intel_gvt_mm_type type;\n\tstruct intel_vgpu *vgpu;\n\n\tstruct kref ref;\n\tatomic_t pincount;\n\n\tunion {\n\t\tstruct {\n\t\t\tenum intel_gvt_gtt_type root_entry_type;\n\t\t\t \n\t\t\tu64 guest_pdps[GVT_RING_CTX_NR_PDPS];\n\t\t\tu64 shadow_pdps[GVT_RING_CTX_NR_PDPS];\n\t\t\tbool shadowed;\n\n\t\t\tstruct list_head list;\n\t\t\tstruct list_head lru_list;\n\t\t\tstruct list_head link;  \n\t\t} ppgtt_mm;\n\t\tstruct {\n\t\t\tvoid *virtual_ggtt;\n\t\t\t \n\t\t\tu64 *host_ggtt_aperture;\n\t\t\tu64 *host_ggtt_hidden;\n\t\t\tstruct list_head partial_pte_list;\n\t\t} ggtt_mm;\n\t};\n};\n\nstruct intel_vgpu_mm *intel_vgpu_create_ppgtt_mm(struct intel_vgpu *vgpu,\n\t\tenum intel_gvt_gtt_type root_entry_type, u64 pdps[]);\n\nstatic inline void intel_vgpu_mm_get(struct intel_vgpu_mm *mm)\n{\n\tkref_get(&mm->ref);\n}\n\nvoid _intel_vgpu_mm_release(struct kref *mm_ref);\n\nstatic inline void intel_vgpu_mm_put(struct intel_vgpu_mm *mm)\n{\n\tkref_put(&mm->ref, _intel_vgpu_mm_release);\n}\n\nstatic inline void intel_vgpu_destroy_mm(struct intel_vgpu_mm *mm)\n{\n\tintel_vgpu_mm_put(mm);\n}\n\nstruct intel_vgpu_guest_page;\n\nstruct intel_vgpu_scratch_pt {\n\tstruct page *page;\n\tunsigned long page_mfn;\n};\n\nstruct intel_vgpu_gtt {\n\tstruct intel_vgpu_mm *ggtt_mm;\n\tunsigned long active_ppgtt_mm_bitmap;\n\tstruct list_head ppgtt_mm_list_head;\n\tstruct radix_tree_root spt_tree;\n\tstruct list_head oos_page_list_head;\n\tstruct list_head post_shadow_list_head;\n\tstruct intel_vgpu_scratch_pt scratch_pt[GTT_TYPE_MAX];\n};\n\nint intel_vgpu_init_gtt(struct intel_vgpu *vgpu);\nvoid intel_vgpu_clean_gtt(struct intel_vgpu *vgpu);\nvoid intel_vgpu_reset_ggtt(struct intel_vgpu *vgpu, bool invalidate_old);\nvoid intel_vgpu_invalidate_ppgtt(struct intel_vgpu *vgpu);\n\nint intel_gvt_init_gtt(struct intel_gvt *gvt);\nvoid intel_gvt_clean_gtt(struct intel_gvt *gvt);\n\nstruct intel_vgpu_mm *intel_gvt_find_ppgtt_mm(struct intel_vgpu *vgpu,\n\t\t\t\t\t      int page_table_level,\n\t\t\t\t\t      void *root_entry);\n\nstruct intel_vgpu_oos_page {\n\tstruct intel_vgpu_ppgtt_spt *spt;\n\tstruct list_head list;\n\tstruct list_head vm_list;\n\tint id;\n\tvoid *mem;\n};\n\n#define GTT_ENTRY_NUM_IN_ONE_PAGE 512\n\n \nstruct intel_vgpu_ppgtt_spt {\n\tatomic_t refcount;\n\tstruct intel_vgpu *vgpu;\n\n\tstruct {\n\t\tenum intel_gvt_gtt_type type;\n\t\tbool pde_ips;  \n\t\tvoid *vaddr;\n\t\tstruct page *page;\n\t\tunsigned long mfn;\n\t} shadow_page;\n\n\tstruct {\n\t\tenum intel_gvt_gtt_type type;\n\t\tbool pde_ips;  \n\t\tunsigned long gfn;\n\t\tunsigned long write_cnt;\n\t\tstruct intel_vgpu_oos_page *oos_page;\n\t} guest_page;\n\n\tDECLARE_BITMAP(post_shadow_bitmap, GTT_ENTRY_NUM_IN_ONE_PAGE);\n\tstruct list_head post_shadow_list;\n};\n\nint intel_vgpu_sync_oos_pages(struct intel_vgpu *vgpu);\n\nint intel_vgpu_flush_post_shadow(struct intel_vgpu *vgpu);\n\nint intel_vgpu_pin_mm(struct intel_vgpu_mm *mm);\n\nvoid intel_vgpu_unpin_mm(struct intel_vgpu_mm *mm);\n\nunsigned long intel_vgpu_gma_to_gpa(struct intel_vgpu_mm *mm,\n\t\tunsigned long gma);\n\nstruct intel_vgpu_mm *intel_vgpu_find_ppgtt_mm(struct intel_vgpu *vgpu,\n\t\tu64 pdps[]);\n\nstruct intel_vgpu_mm *intel_vgpu_get_ppgtt_mm(struct intel_vgpu *vgpu,\n\t\tenum intel_gvt_gtt_type root_entry_type, u64 pdps[]);\n\nint intel_vgpu_put_ppgtt_mm(struct intel_vgpu *vgpu, u64 pdps[]);\n\nint intel_vgpu_emulate_ggtt_mmio_read(struct intel_vgpu *vgpu,\n\tunsigned int off, void *p_data, unsigned int bytes);\n\nint intel_vgpu_emulate_ggtt_mmio_write(struct intel_vgpu *vgpu,\n\tunsigned int off, void *p_data, unsigned int bytes);\n\nvoid intel_vgpu_destroy_all_ppgtt_mm(struct intel_vgpu *vgpu);\nvoid intel_gvt_restore_ggtt(struct intel_gvt *gvt);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}