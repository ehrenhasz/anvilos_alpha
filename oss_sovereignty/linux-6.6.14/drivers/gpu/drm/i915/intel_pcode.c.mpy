{
  "module_name": "intel_pcode.c",
  "hash_id": "15705f772446a3d2df575d90680896a2ea16cc4e29d018c090ff6084664a7ce9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/intel_pcode.c",
  "human_readable_source": "\n \n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_pcode.h\"\n\nstatic int gen6_check_mailbox_status(u32 mbox)\n{\n\tswitch (mbox & GEN6_PCODE_ERROR_MASK) {\n\tcase GEN6_PCODE_SUCCESS:\n\t\treturn 0;\n\tcase GEN6_PCODE_UNIMPLEMENTED_CMD:\n\t\treturn -ENODEV;\n\tcase GEN6_PCODE_ILLEGAL_CMD:\n\t\treturn -ENXIO;\n\tcase GEN6_PCODE_MIN_FREQ_TABLE_GT_RATIO_OUT_OF_RANGE:\n\tcase GEN7_PCODE_MIN_FREQ_TABLE_GT_RATIO_OUT_OF_RANGE:\n\t\treturn -EOVERFLOW;\n\tcase GEN6_PCODE_TIMEOUT:\n\t\treturn -ETIMEDOUT;\n\tdefault:\n\t\tMISSING_CASE(mbox & GEN6_PCODE_ERROR_MASK);\n\t\treturn 0;\n\t}\n}\n\nstatic int gen7_check_mailbox_status(u32 mbox)\n{\n\tswitch (mbox & GEN6_PCODE_ERROR_MASK) {\n\tcase GEN6_PCODE_SUCCESS:\n\t\treturn 0;\n\tcase GEN6_PCODE_ILLEGAL_CMD:\n\t\treturn -ENXIO;\n\tcase GEN7_PCODE_TIMEOUT:\n\t\treturn -ETIMEDOUT;\n\tcase GEN7_PCODE_ILLEGAL_DATA:\n\t\treturn -EINVAL;\n\tcase GEN11_PCODE_ILLEGAL_SUBCOMMAND:\n\t\treturn -ENXIO;\n\tcase GEN11_PCODE_LOCKED:\n\t\treturn -EBUSY;\n\tcase GEN11_PCODE_REJECTED:\n\t\treturn -EACCES;\n\tcase GEN7_PCODE_MIN_FREQ_TABLE_GT_RATIO_OUT_OF_RANGE:\n\t\treturn -EOVERFLOW;\n\tdefault:\n\t\tMISSING_CASE(mbox & GEN6_PCODE_ERROR_MASK);\n\t\treturn 0;\n\t}\n}\n\nstatic int __snb_pcode_rw(struct intel_uncore *uncore, u32 mbox,\n\t\t\t  u32 *val, u32 *val1,\n\t\t\t  int fast_timeout_us, int slow_timeout_ms,\n\t\t\t  bool is_read)\n{\n\tlockdep_assert_held(&uncore->i915->sb_lock);\n\n\t \n\n\tif (intel_uncore_read_fw(uncore, GEN6_PCODE_MAILBOX) & GEN6_PCODE_READY)\n\t\treturn -EAGAIN;\n\n\tintel_uncore_write_fw(uncore, GEN6_PCODE_DATA, *val);\n\tintel_uncore_write_fw(uncore, GEN6_PCODE_DATA1, val1 ? *val1 : 0);\n\tintel_uncore_write_fw(uncore,\n\t\t\t      GEN6_PCODE_MAILBOX, GEN6_PCODE_READY | mbox);\n\n\tif (__intel_wait_for_register_fw(uncore,\n\t\t\t\t\t GEN6_PCODE_MAILBOX,\n\t\t\t\t\t GEN6_PCODE_READY, 0,\n\t\t\t\t\t fast_timeout_us,\n\t\t\t\t\t slow_timeout_ms,\n\t\t\t\t\t &mbox))\n\t\treturn -ETIMEDOUT;\n\n\tif (is_read)\n\t\t*val = intel_uncore_read_fw(uncore, GEN6_PCODE_DATA);\n\tif (is_read && val1)\n\t\t*val1 = intel_uncore_read_fw(uncore, GEN6_PCODE_DATA1);\n\n\tif (GRAPHICS_VER(uncore->i915) > 6)\n\t\treturn gen7_check_mailbox_status(mbox);\n\telse\n\t\treturn gen6_check_mailbox_status(mbox);\n}\n\nint snb_pcode_read(struct intel_uncore *uncore, u32 mbox, u32 *val, u32 *val1)\n{\n\tint err;\n\n\tmutex_lock(&uncore->i915->sb_lock);\n\terr = __snb_pcode_rw(uncore, mbox, val, val1, 500, 20, true);\n\tmutex_unlock(&uncore->i915->sb_lock);\n\n\tif (err) {\n\t\tdrm_dbg(&uncore->i915->drm,\n\t\t\t\"warning: pcode (read from mbox %x) mailbox access failed for %ps: %d\\n\",\n\t\t\tmbox, __builtin_return_address(0), err);\n\t}\n\n\treturn err;\n}\n\nint snb_pcode_write_timeout(struct intel_uncore *uncore, u32 mbox, u32 val,\n\t\t\t    int fast_timeout_us, int slow_timeout_ms)\n{\n\tint err;\n\n\tmutex_lock(&uncore->i915->sb_lock);\n\terr = __snb_pcode_rw(uncore, mbox, &val, NULL,\n\t\t\t     fast_timeout_us, slow_timeout_ms, false);\n\tmutex_unlock(&uncore->i915->sb_lock);\n\n\tif (err) {\n\t\tdrm_dbg(&uncore->i915->drm,\n\t\t\t\"warning: pcode (write of 0x%08x to mbox %x) mailbox access failed for %ps: %d\\n\",\n\t\t\tval, mbox, __builtin_return_address(0), err);\n\t}\n\n\treturn err;\n}\n\nstatic bool skl_pcode_try_request(struct intel_uncore *uncore, u32 mbox,\n\t\t\t\t  u32 request, u32 reply_mask, u32 reply,\n\t\t\t\t  u32 *status)\n{\n\t*status = __snb_pcode_rw(uncore, mbox, &request, NULL, 500, 0, true);\n\n\treturn (*status == 0) && ((request & reply_mask) == reply);\n}\n\n \nint skl_pcode_request(struct intel_uncore *uncore, u32 mbox, u32 request,\n\t\t      u32 reply_mask, u32 reply, int timeout_base_ms)\n{\n\tu32 status;\n\tint ret;\n\n\tmutex_lock(&uncore->i915->sb_lock);\n\n#define COND \\\n\tskl_pcode_try_request(uncore, mbox, request, reply_mask, reply, &status)\n\n\t \n\tif (COND) {\n\t\tret = 0;\n\t\tgoto out;\n\t}\n\tret = _wait_for(COND, timeout_base_ms * 1000, 10, 10);\n\tif (!ret)\n\t\tgoto out;\n\n\t \n\tdrm_dbg_kms(&uncore->i915->drm,\n\t\t    \"PCODE timeout, retrying with preemption disabled\\n\");\n\tdrm_WARN_ON_ONCE(&uncore->i915->drm, timeout_base_ms > 3);\n\tpreempt_disable();\n\tret = wait_for_atomic(COND, 50);\n\tpreempt_enable();\n\nout:\n\tmutex_unlock(&uncore->i915->sb_lock);\n\treturn status ? status : ret;\n#undef COND\n}\n\nstatic int pcode_init_wait(struct intel_uncore *uncore, int timeout_ms)\n{\n\tif (__intel_wait_for_register_fw(uncore,\n\t\t\t\t\t GEN6_PCODE_MAILBOX,\n\t\t\t\t\t GEN6_PCODE_READY, 0,\n\t\t\t\t\t 500, timeout_ms,\n\t\t\t\t\t NULL))\n\t\treturn -EPROBE_DEFER;\n\n\treturn skl_pcode_request(uncore,\n\t\t\t\t DG1_PCODE_STATUS,\n\t\t\t\t DG1_UNCORE_GET_INIT_STATUS,\n\t\t\t\t DG1_UNCORE_INIT_STATUS_COMPLETE,\n\t\t\t\t DG1_UNCORE_INIT_STATUS_COMPLETE, timeout_ms);\n}\n\nint intel_pcode_init(struct intel_uncore *uncore)\n{\n\tint err;\n\n\tif (!IS_DGFX(uncore->i915))\n\t\treturn 0;\n\n\t \n\terr = pcode_init_wait(uncore, 10000);\n\n\tif (err) {\n\t\tdrm_notice(&uncore->i915->drm,\n\t\t\t   \"Waiting for HW initialisation...\\n\");\n\t\terr = pcode_init_wait(uncore, 180000);\n\t}\n\n\treturn err;\n}\n\nint snb_pcode_read_p(struct intel_uncore *uncore, u32 mbcmd, u32 p1, u32 p2, u32 *val)\n{\n\tintel_wakeref_t wakeref;\n\tu32 mbox;\n\tint err;\n\n\tmbox = REG_FIELD_PREP(GEN6_PCODE_MB_COMMAND, mbcmd)\n\t\t| REG_FIELD_PREP(GEN6_PCODE_MB_PARAM1, p1)\n\t\t| REG_FIELD_PREP(GEN6_PCODE_MB_PARAM2, p2);\n\n\twith_intel_runtime_pm(uncore->rpm, wakeref)\n\t\terr = snb_pcode_read(uncore, mbox, val, NULL);\n\n\treturn err;\n}\n\nint snb_pcode_write_p(struct intel_uncore *uncore, u32 mbcmd, u32 p1, u32 p2, u32 val)\n{\n\tintel_wakeref_t wakeref;\n\tu32 mbox;\n\tint err;\n\n\tmbox = REG_FIELD_PREP(GEN6_PCODE_MB_COMMAND, mbcmd)\n\t\t| REG_FIELD_PREP(GEN6_PCODE_MB_PARAM1, p1)\n\t\t| REG_FIELD_PREP(GEN6_PCODE_MB_PARAM2, p2);\n\n\twith_intel_runtime_pm(uncore->rpm, wakeref)\n\t\terr = snb_pcode_write(uncore, mbox, val);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}