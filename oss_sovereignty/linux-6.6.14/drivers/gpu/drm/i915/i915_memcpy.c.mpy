{
  "module_name": "i915_memcpy.c",
  "hash_id": "4421a1080668e96d43ae3a577e6347c4501cd94a51b7732c64d317e7995aac85",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/i915_memcpy.c",
  "human_readable_source": " \n\n#include <linux/kernel.h>\n#include <asm/fpu/api.h>\n\n#include \"i915_memcpy.h\"\n\n#if IS_ENABLED(CONFIG_DRM_I915_DEBUG)\n#define CI_BUG_ON(expr) BUG_ON(expr)\n#else\n#define CI_BUG_ON(expr) BUILD_BUG_ON_INVALID(expr)\n#endif\n\nstatic DEFINE_STATIC_KEY_FALSE(has_movntdqa);\n\nstatic void __memcpy_ntdqa(void *dst, const void *src, unsigned long len)\n{\n\tkernel_fpu_begin();\n\n\twhile (len >= 4) {\n\t\tasm(\"movntdqa   (%0), %%xmm0\\n\"\n\t\t    \"movntdqa 16(%0), %%xmm1\\n\"\n\t\t    \"movntdqa 32(%0), %%xmm2\\n\"\n\t\t    \"movntdqa 48(%0), %%xmm3\\n\"\n\t\t    \"movaps %%xmm0,   (%1)\\n\"\n\t\t    \"movaps %%xmm1, 16(%1)\\n\"\n\t\t    \"movaps %%xmm2, 32(%1)\\n\"\n\t\t    \"movaps %%xmm3, 48(%1)\\n\"\n\t\t    :: \"r\" (src), \"r\" (dst) : \"memory\");\n\t\tsrc += 64;\n\t\tdst += 64;\n\t\tlen -= 4;\n\t}\n\twhile (len--) {\n\t\tasm(\"movntdqa (%0), %%xmm0\\n\"\n\t\t    \"movaps %%xmm0, (%1)\\n\"\n\t\t    :: \"r\" (src), \"r\" (dst) : \"memory\");\n\t\tsrc += 16;\n\t\tdst += 16;\n\t}\n\n\tkernel_fpu_end();\n}\n\nstatic void __memcpy_ntdqu(void *dst, const void *src, unsigned long len)\n{\n\tkernel_fpu_begin();\n\n\twhile (len >= 4) {\n\t\tasm(\"movntdqa   (%0), %%xmm0\\n\"\n\t\t    \"movntdqa 16(%0), %%xmm1\\n\"\n\t\t    \"movntdqa 32(%0), %%xmm2\\n\"\n\t\t    \"movntdqa 48(%0), %%xmm3\\n\"\n\t\t    \"movups %%xmm0,   (%1)\\n\"\n\t\t    \"movups %%xmm1, 16(%1)\\n\"\n\t\t    \"movups %%xmm2, 32(%1)\\n\"\n\t\t    \"movups %%xmm3, 48(%1)\\n\"\n\t\t    :: \"r\" (src), \"r\" (dst) : \"memory\");\n\t\tsrc += 64;\n\t\tdst += 64;\n\t\tlen -= 4;\n\t}\n\twhile (len--) {\n\t\tasm(\"movntdqa (%0), %%xmm0\\n\"\n\t\t    \"movups %%xmm0, (%1)\\n\"\n\t\t    :: \"r\" (src), \"r\" (dst) : \"memory\");\n\t\tsrc += 16;\n\t\tdst += 16;\n\t}\n\n\tkernel_fpu_end();\n}\n\n \nbool i915_memcpy_from_wc(void *dst, const void *src, unsigned long len)\n{\n\tif (unlikely(((unsigned long)dst | (unsigned long)src | len) & 15))\n\t\treturn false;\n\n\tif (static_branch_likely(&has_movntdqa)) {\n\t\tif (likely(len))\n\t\t\t__memcpy_ntdqa(dst, src, len >> 4);\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n \nvoid i915_unaligned_memcpy_from_wc(void *dst, const void *src, unsigned long len)\n{\n\tunsigned long addr;\n\n\tCI_BUG_ON(!i915_has_memcpy_from_wc());\n\n\taddr = (unsigned long)src;\n\tif (!IS_ALIGNED(addr, 16)) {\n\t\tunsigned long x = min(ALIGN(addr, 16) - addr, len);\n\n\t\tmemcpy(dst, src, x);\n\n\t\tlen -= x;\n\t\tdst += x;\n\t\tsrc += x;\n\t}\n\n\tif (likely(len))\n\t\t__memcpy_ntdqu(dst, src, DIV_ROUND_UP(len, 16));\n}\n\nvoid i915_memcpy_init_early(struct drm_i915_private *dev_priv)\n{\n\t \n\tif (static_cpu_has(X86_FEATURE_XMM4_1) &&\n\t    !boot_cpu_has(X86_FEATURE_HYPERVISOR))\n\t\tstatic_branch_enable(&has_movntdqa);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}