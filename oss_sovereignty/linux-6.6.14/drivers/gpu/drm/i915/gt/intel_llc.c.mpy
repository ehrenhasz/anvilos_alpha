{
  "module_name": "intel_llc.c",
  "hash_id": "96b254e5b76ed3835b11611ae540e85fdf29f8b8d0a2389ef486bfa7ce2ebadf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/intel_llc.c",
  "human_readable_source": "\n \n\n#include <asm/tsc.h>\n#include <linux/cpufreq.h>\n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_gt.h\"\n#include \"intel_llc.h\"\n#include \"intel_mchbar_regs.h\"\n#include \"intel_pcode.h\"\n#include \"intel_rps.h\"\n\nstruct ia_constants {\n\tunsigned int min_gpu_freq;\n\tunsigned int max_gpu_freq;\n\n\tunsigned int min_ring_freq;\n\tunsigned int max_ia_freq;\n};\n\nstatic struct intel_gt *llc_to_gt(struct intel_llc *llc)\n{\n\treturn container_of(llc, struct intel_gt, llc);\n}\n\nstatic unsigned int cpu_max_MHz(void)\n{\n\tstruct cpufreq_policy *policy;\n\tunsigned int max_khz;\n\n\tpolicy = cpufreq_cpu_get(0);\n\tif (policy) {\n\t\tmax_khz = policy->cpuinfo.max_freq;\n\t\tcpufreq_cpu_put(policy);\n\t} else {\n\t\t \n\t\tmax_khz = tsc_khz;\n\t}\n\n\treturn max_khz / 1000;\n}\n\nstatic bool get_ia_constants(struct intel_llc *llc,\n\t\t\t     struct ia_constants *consts)\n{\n\tstruct drm_i915_private *i915 = llc_to_gt(llc)->i915;\n\tstruct intel_rps *rps = &llc_to_gt(llc)->rps;\n\n\tif (!HAS_LLC(i915) || IS_DGFX(i915))\n\t\treturn false;\n\n\tconsts->max_ia_freq = cpu_max_MHz();\n\n\tconsts->min_ring_freq =\n\t\tintel_uncore_read(llc_to_gt(llc)->uncore, DCLK) & 0xf;\n\t \n\tconsts->min_ring_freq = mult_frac(consts->min_ring_freq, 8, 3);\n\n\tconsts->min_gpu_freq = intel_rps_get_min_raw_freq(rps);\n\tconsts->max_gpu_freq = intel_rps_get_max_raw_freq(rps);\n\n\treturn true;\n}\n\nstatic void calc_ia_freq(struct intel_llc *llc,\n\t\t\t unsigned int gpu_freq,\n\t\t\t const struct ia_constants *consts,\n\t\t\t unsigned int *out_ia_freq,\n\t\t\t unsigned int *out_ring_freq)\n{\n\tstruct drm_i915_private *i915 = llc_to_gt(llc)->i915;\n\tconst int diff = consts->max_gpu_freq - gpu_freq;\n\tunsigned int ia_freq = 0, ring_freq = 0;\n\n\tif (GRAPHICS_VER(i915) >= 9) {\n\t\t \n\t\tring_freq = gpu_freq;\n\t} else if (GRAPHICS_VER(i915) >= 8) {\n\t\t \n\t\tring_freq = max(consts->min_ring_freq, gpu_freq);\n\t} else if (IS_HASWELL(i915)) {\n\t\tring_freq = mult_frac(gpu_freq, 5, 4);\n\t\tring_freq = max(consts->min_ring_freq, ring_freq);\n\t\t \n\t} else {\n\t\tconst int min_freq = 15;\n\t\tconst int scale = 180;\n\n\t\t \n\t\tif (gpu_freq < min_freq)\n\t\t\tia_freq = 800;\n\t\telse\n\t\t\tia_freq = consts->max_ia_freq - diff * scale / 2;\n\t\tia_freq = DIV_ROUND_CLOSEST(ia_freq, 100);\n\t}\n\n\t*out_ia_freq = ia_freq;\n\t*out_ring_freq = ring_freq;\n}\n\nstatic void gen6_update_ring_freq(struct intel_llc *llc)\n{\n\tstruct ia_constants consts;\n\tunsigned int gpu_freq;\n\n\tif (!get_ia_constants(llc, &consts))\n\t\treturn;\n\n\t \n\tif (consts.max_gpu_freq <= consts.min_gpu_freq)\n\t\treturn;\n\t \n\tfor (gpu_freq = consts.max_gpu_freq;\n\t     gpu_freq >= consts.min_gpu_freq;\n\t     gpu_freq--) {\n\t\tunsigned int ia_freq, ring_freq;\n\n\t\tcalc_ia_freq(llc, gpu_freq, &consts, &ia_freq, &ring_freq);\n\t\tsnb_pcode_write(llc_to_gt(llc)->uncore, GEN6_PCODE_WRITE_MIN_FREQ_TABLE,\n\t\t\t\tia_freq << GEN6_PCODE_FREQ_IA_RATIO_SHIFT |\n\t\t\t\tring_freq << GEN6_PCODE_FREQ_RING_RATIO_SHIFT |\n\t\t\t\tgpu_freq);\n\t}\n}\n\nvoid intel_llc_enable(struct intel_llc *llc)\n{\n\tgen6_update_ring_freq(llc);\n}\n\nvoid intel_llc_disable(struct intel_llc *llc)\n{\n\t \n}\n\n#if IS_ENABLED(CONFIG_DRM_I915_SELFTEST)\n#include \"selftest_llc.c\"\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}