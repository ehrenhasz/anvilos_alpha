{
  "module_name": "shmem_utils.c",
  "hash_id": "3d78c2eb2e359860f7b43b8ce7826767bfe9a4298441cad70be710639fb06e99",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/shmem_utils.c",
  "human_readable_source": "\n \n\n#include <linux/iosys-map.h>\n#include <linux/mm.h>\n#include <linux/pagemap.h>\n#include <linux/shmem_fs.h>\n\n#include \"i915_drv.h\"\n#include \"gem/i915_gem_object.h\"\n#include \"gem/i915_gem_lmem.h\"\n#include \"shmem_utils.h\"\n\nstruct file *shmem_create_from_data(const char *name, void *data, size_t len)\n{\n\tstruct file *file;\n\tint err;\n\n\tfile = shmem_file_setup(name, PAGE_ALIGN(len), VM_NORESERVE);\n\tif (IS_ERR(file))\n\t\treturn file;\n\n\terr = shmem_write(file, 0, data, len);\n\tif (err) {\n\t\tfput(file);\n\t\treturn ERR_PTR(err);\n\t}\n\n\treturn file;\n}\n\nstruct file *shmem_create_from_object(struct drm_i915_gem_object *obj)\n{\n\tenum i915_map_type map_type;\n\tstruct file *file;\n\tvoid *ptr;\n\n\tif (i915_gem_object_is_shmem(obj)) {\n\t\tfile = obj->base.filp;\n\t\tatomic_long_inc(&file->f_count);\n\t\treturn file;\n\t}\n\n\tmap_type = i915_gem_object_is_lmem(obj) ? I915_MAP_WC : I915_MAP_WB;\n\tptr = i915_gem_object_pin_map_unlocked(obj, map_type);\n\tif (IS_ERR(ptr))\n\t\treturn ERR_CAST(ptr);\n\n\tfile = shmem_create_from_data(\"\", ptr, obj->base.size);\n\ti915_gem_object_unpin_map(obj);\n\n\treturn file;\n}\n\nvoid *shmem_pin_map(struct file *file)\n{\n\tstruct page **pages;\n\tsize_t n_pages, i;\n\tvoid *vaddr;\n\n\tn_pages = file->f_mapping->host->i_size >> PAGE_SHIFT;\n\tpages = kvmalloc_array(n_pages, sizeof(*pages), GFP_KERNEL);\n\tif (!pages)\n\t\treturn NULL;\n\n\tfor (i = 0; i < n_pages; i++) {\n\t\tpages[i] = shmem_read_mapping_page_gfp(file->f_mapping, i,\n\t\t\t\t\t\t       GFP_KERNEL);\n\t\tif (IS_ERR(pages[i]))\n\t\t\tgoto err_page;\n\t}\n\n\tvaddr = vmap(pages, n_pages, VM_MAP_PUT_PAGES, PAGE_KERNEL);\n\tif (!vaddr)\n\t\tgoto err_page;\n\tmapping_set_unevictable(file->f_mapping);\n\treturn vaddr;\nerr_page:\n\twhile (i--)\n\t\tput_page(pages[i]);\n\tkvfree(pages);\n\treturn NULL;\n}\n\nvoid shmem_unpin_map(struct file *file, void *ptr)\n{\n\tmapping_clear_unevictable(file->f_mapping);\n\tvfree(ptr);\n}\n\nstatic int __shmem_rw(struct file *file, loff_t off,\n\t\t      void *ptr, size_t len,\n\t\t      bool write)\n{\n\tunsigned long pfn;\n\n\tfor (pfn = off >> PAGE_SHIFT; len; pfn++) {\n\t\tunsigned int this =\n\t\t\tmin_t(size_t, PAGE_SIZE - offset_in_page(off), len);\n\t\tstruct page *page;\n\t\tvoid *vaddr;\n\n\t\tpage = shmem_read_mapping_page_gfp(file->f_mapping, pfn,\n\t\t\t\t\t\t   GFP_KERNEL);\n\t\tif (IS_ERR(page))\n\t\t\treturn PTR_ERR(page);\n\n\t\tvaddr = kmap(page);\n\t\tif (write) {\n\t\t\tmemcpy(vaddr + offset_in_page(off), ptr, this);\n\t\t\tset_page_dirty(page);\n\t\t} else {\n\t\t\tmemcpy(ptr, vaddr + offset_in_page(off), this);\n\t\t}\n\t\tmark_page_accessed(page);\n\t\tkunmap(page);\n\t\tput_page(page);\n\n\t\tlen -= this;\n\t\tptr += this;\n\t\toff = 0;\n\t}\n\n\treturn 0;\n}\n\nint shmem_read_to_iosys_map(struct file *file, loff_t off,\n\t\t\t    struct iosys_map *map, size_t map_off, size_t len)\n{\n\tunsigned long pfn;\n\n\tfor (pfn = off >> PAGE_SHIFT; len; pfn++) {\n\t\tunsigned int this =\n\t\t\tmin_t(size_t, PAGE_SIZE - offset_in_page(off), len);\n\t\tstruct page *page;\n\t\tvoid *vaddr;\n\n\t\tpage = shmem_read_mapping_page_gfp(file->f_mapping, pfn,\n\t\t\t\t\t\t   GFP_KERNEL);\n\t\tif (IS_ERR(page))\n\t\t\treturn PTR_ERR(page);\n\n\t\tvaddr = kmap(page);\n\t\tiosys_map_memcpy_to(map, map_off, vaddr + offset_in_page(off),\n\t\t\t\t    this);\n\t\tmark_page_accessed(page);\n\t\tkunmap(page);\n\t\tput_page(page);\n\n\t\tlen -= this;\n\t\tmap_off += this;\n\t\toff = 0;\n\t}\n\n\treturn 0;\n}\n\nint shmem_read(struct file *file, loff_t off, void *dst, size_t len)\n{\n\treturn __shmem_rw(file, off, dst, len, false);\n}\n\nint shmem_write(struct file *file, loff_t off, void *src, size_t len)\n{\n\treturn __shmem_rw(file, off, src, len, true);\n}\n\n#if IS_ENABLED(CONFIG_DRM_I915_SELFTEST)\n#include \"st_shmem_utils.c\"\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}