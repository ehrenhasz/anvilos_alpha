{
  "module_name": "gen2_engine_cs.c",
  "hash_id": "42bb918d1b22be8c44c9a36b6890fa3d9baf4c58d228d2dacd3e8416ba6b50a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/gen2_engine_cs.c",
  "human_readable_source": "\n \n\n#include \"gen2_engine_cs.h\"\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_engine.h\"\n#include \"intel_engine_regs.h\"\n#include \"intel_gpu_commands.h\"\n#include \"intel_gt.h\"\n#include \"intel_gt_irq.h\"\n#include \"intel_ring.h\"\n\nint gen2_emit_flush(struct i915_request *rq, u32 mode)\n{\n\tunsigned int num_store_dw = 12;\n\tu32 cmd, *cs;\n\n\tcmd = MI_FLUSH;\n\tif (mode & EMIT_INVALIDATE)\n\t\tcmd |= MI_READ_FLUSH;\n\n\tcs = intel_ring_begin(rq, 2 + 4 * num_store_dw);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = cmd;\n\twhile (num_store_dw--) {\n\t\t*cs++ = MI_STORE_DWORD_INDEX;\n\t\t*cs++ = I915_GEM_HWS_SCRATCH * sizeof(u32);\n\t\t*cs++ = 0;\n\t\t*cs++ = MI_FLUSH | MI_NO_WRITE_FLUSH;\n\t}\n\t*cs++ = cmd;\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen4_emit_flush_rcs(struct i915_request *rq, u32 mode)\n{\n\tu32 cmd, *cs;\n\tint i;\n\n\t \n\n\tcmd = MI_FLUSH;\n\tif (mode & EMIT_INVALIDATE) {\n\t\tcmd |= MI_EXE_FLUSH;\n\t\tif (IS_G4X(rq->i915) || GRAPHICS_VER(rq->i915) == 5)\n\t\t\tcmd |= MI_INVALIDATE_ISP;\n\t}\n\n\ti = 2;\n\tif (mode & EMIT_INVALIDATE)\n\t\ti += 20;\n\n\tcs = intel_ring_begin(rq, i);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = cmd;\n\n\t \n\tif (mode & EMIT_INVALIDATE) {\n\t\t*cs++ = GFX_OP_PIPE_CONTROL(4) | PIPE_CONTROL_QW_WRITE;\n\t\t*cs++ = intel_gt_scratch_offset(rq->engine->gt,\n\t\t\t\t\t\tINTEL_GT_SCRATCH_FIELD_DEFAULT) |\n\t\t\tPIPE_CONTROL_GLOBAL_GTT;\n\t\t*cs++ = 0;\n\t\t*cs++ = 0;\n\n\t\tfor (i = 0; i < 12; i++)\n\t\t\t*cs++ = MI_FLUSH;\n\n\t\t*cs++ = GFX_OP_PIPE_CONTROL(4) | PIPE_CONTROL_QW_WRITE;\n\t\t*cs++ = intel_gt_scratch_offset(rq->engine->gt,\n\t\t\t\t\t\tINTEL_GT_SCRATCH_FIELD_DEFAULT) |\n\t\t\tPIPE_CONTROL_GLOBAL_GTT;\n\t\t*cs++ = 0;\n\t\t*cs++ = 0;\n\t}\n\n\t*cs++ = cmd;\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen4_emit_flush_vcs(struct i915_request *rq, u32 mode)\n{\n\tu32 *cs;\n\n\tcs = intel_ring_begin(rq, 2);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_FLUSH;\n\t*cs++ = MI_NOOP;\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nstatic u32 *__gen2_emit_breadcrumb(struct i915_request *rq, u32 *cs,\n\t\t\t\t   int flush, int post)\n{\n\tGEM_BUG_ON(i915_request_active_timeline(rq)->hwsp_ggtt != rq->engine->status_page.vma);\n\tGEM_BUG_ON(offset_in_page(rq->hwsp_seqno) != I915_GEM_HWS_SEQNO_ADDR);\n\n\t*cs++ = MI_FLUSH;\n\n\twhile (flush--) {\n\t\t*cs++ = MI_STORE_DWORD_INDEX;\n\t\t*cs++ = I915_GEM_HWS_SCRATCH * sizeof(u32);\n\t\t*cs++ = rq->fence.seqno;\n\t}\n\n\twhile (post--) {\n\t\t*cs++ = MI_STORE_DWORD_INDEX;\n\t\t*cs++ = I915_GEM_HWS_SEQNO_ADDR;\n\t\t*cs++ = rq->fence.seqno;\n\t}\n\n\t*cs++ = MI_USER_INTERRUPT;\n\n\trq->tail = intel_ring_offset(rq, cs);\n\tassert_ring_tail_valid(rq->ring, rq->tail);\n\n\treturn cs;\n}\n\nu32 *gen3_emit_breadcrumb(struct i915_request *rq, u32 *cs)\n{\n\treturn __gen2_emit_breadcrumb(rq, cs, 16, 8);\n}\n\nu32 *gen5_emit_breadcrumb(struct i915_request *rq, u32 *cs)\n{\n\treturn __gen2_emit_breadcrumb(rq, cs, 8, 8);\n}\n\n \n#define I830_BATCH_LIMIT SZ_256K\n#define I830_TLB_ENTRIES (2)\n#define I830_WA_SIZE max(I830_TLB_ENTRIES * SZ_4K, I830_BATCH_LIMIT)\nint i830_emit_bb_start(struct i915_request *rq,\n\t\t       u64 offset, u32 len,\n\t\t       unsigned int dispatch_flags)\n{\n\tu32 *cs, cs_offset =\n\t\tintel_gt_scratch_offset(rq->engine->gt,\n\t\t\t\t\tINTEL_GT_SCRATCH_FIELD_DEFAULT);\n\n\tGEM_BUG_ON(rq->engine->gt->scratch->size < I830_WA_SIZE);\n\n\tcs = intel_ring_begin(rq, 6);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t \n\t*cs++ = COLOR_BLT_CMD | BLT_WRITE_RGBA;\n\t*cs++ = BLT_DEPTH_32 | BLT_ROP_COLOR_COPY | 4096;\n\t*cs++ = I830_TLB_ENTRIES << 16 | 4;  \n\t*cs++ = cs_offset;\n\t*cs++ = 0xdeadbeef;\n\t*cs++ = MI_NOOP;\n\tintel_ring_advance(rq, cs);\n\n\tif ((dispatch_flags & I915_DISPATCH_PINNED) == 0) {\n\t\tif (len > I830_BATCH_LIMIT)\n\t\t\treturn -ENOSPC;\n\n\t\tcs = intel_ring_begin(rq, 6 + 2);\n\t\tif (IS_ERR(cs))\n\t\t\treturn PTR_ERR(cs);\n\n\t\t \n\t\t*cs++ = SRC_COPY_BLT_CMD | BLT_WRITE_RGBA | (6 - 2);\n\t\t*cs++ = BLT_DEPTH_32 | BLT_ROP_SRC_COPY | 4096;\n\t\t*cs++ = DIV_ROUND_UP(len, 4096) << 16 | 4096;\n\t\t*cs++ = cs_offset;\n\t\t*cs++ = 4096;\n\t\t*cs++ = offset;\n\n\t\t*cs++ = MI_FLUSH;\n\t\t*cs++ = MI_NOOP;\n\t\tintel_ring_advance(rq, cs);\n\n\t\t \n\t\toffset = cs_offset;\n\t}\n\n\tif (!(dispatch_flags & I915_DISPATCH_SECURE))\n\t\toffset |= MI_BATCH_NON_SECURE;\n\n\tcs = intel_ring_begin(rq, 2);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_BATCH_BUFFER_START | MI_BATCH_GTT;\n\t*cs++ = offset;\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen3_emit_bb_start(struct i915_request *rq,\n\t\t       u64 offset, u32 len,\n\t\t       unsigned int dispatch_flags)\n{\n\tu32 *cs;\n\n\tif (!(dispatch_flags & I915_DISPATCH_SECURE))\n\t\toffset |= MI_BATCH_NON_SECURE;\n\n\tcs = intel_ring_begin(rq, 2);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_BATCH_BUFFER_START | MI_BATCH_GTT;\n\t*cs++ = offset;\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen4_emit_bb_start(struct i915_request *rq,\n\t\t       u64 offset, u32 length,\n\t\t       unsigned int dispatch_flags)\n{\n\tu32 security;\n\tu32 *cs;\n\n\tsecurity = MI_BATCH_NON_SECURE_I965;\n\tif (dispatch_flags & I915_DISPATCH_SECURE)\n\t\tsecurity = 0;\n\n\tcs = intel_ring_begin(rq, 2);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_BATCH_BUFFER_START | MI_BATCH_GTT | security;\n\t*cs++ = offset;\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nvoid gen2_irq_enable(struct intel_engine_cs *engine)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\ti915->irq_mask &= ~engine->irq_enable_mask;\n\tintel_uncore_write16(&i915->uncore, GEN2_IMR, i915->irq_mask);\n\tENGINE_POSTING_READ16(engine, RING_IMR);\n}\n\nvoid gen2_irq_disable(struct intel_engine_cs *engine)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\ti915->irq_mask |= engine->irq_enable_mask;\n\tintel_uncore_write16(&i915->uncore, GEN2_IMR, i915->irq_mask);\n}\n\nvoid gen3_irq_enable(struct intel_engine_cs *engine)\n{\n\tengine->i915->irq_mask &= ~engine->irq_enable_mask;\n\tintel_uncore_write(engine->uncore, GEN2_IMR, engine->i915->irq_mask);\n\tintel_uncore_posting_read_fw(engine->uncore, GEN2_IMR);\n}\n\nvoid gen3_irq_disable(struct intel_engine_cs *engine)\n{\n\tengine->i915->irq_mask |= engine->irq_enable_mask;\n\tintel_uncore_write(engine->uncore, GEN2_IMR, engine->i915->irq_mask);\n}\n\nvoid gen5_irq_enable(struct intel_engine_cs *engine)\n{\n\tgen5_gt_enable_irq(engine->gt, engine->irq_enable_mask);\n}\n\nvoid gen5_irq_disable(struct intel_engine_cs *engine)\n{\n\tgen5_gt_disable_irq(engine->gt, engine->irq_enable_mask);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}