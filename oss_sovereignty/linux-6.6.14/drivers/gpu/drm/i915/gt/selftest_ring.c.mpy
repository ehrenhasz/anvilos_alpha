{
  "module_name": "selftest_ring.c",
  "hash_id": "73ac016444a76917fc38713257ef65fb0510c5fa8bc03d04b1f91ab59b2d89da",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/selftest_ring.c",
  "human_readable_source": "\n \n\nstatic struct intel_ring *mock_ring(unsigned long sz)\n{\n\tstruct intel_ring *ring;\n\n\tring = kzalloc(sizeof(*ring) + sz, GFP_KERNEL);\n\tif (!ring)\n\t\treturn NULL;\n\n\tkref_init(&ring->ref);\n\tring->size = sz;\n\tring->wrap = BITS_PER_TYPE(ring->size) - ilog2(sz);\n\tring->effective_size = sz;\n\tring->vaddr = (void *)(ring + 1);\n\tatomic_set(&ring->pin_count, 1);\n\n\tintel_ring_update_space(ring);\n\n\treturn ring;\n}\n\nstatic void mock_ring_free(struct intel_ring *ring)\n{\n\tkfree(ring);\n}\n\nstatic int check_ring_direction(struct intel_ring *ring,\n\t\t\t\tu32 next, u32 prev,\n\t\t\t\tint expected)\n{\n\tint result;\n\n\tresult = intel_ring_direction(ring, next, prev);\n\tif (result < 0)\n\t\tresult = -1;\n\telse if (result > 0)\n\t\tresult = 1;\n\n\tif (result != expected) {\n\t\tpr_err(\"intel_ring_direction(%u, %u):%d != %d\\n\",\n\t\t       next, prev, result, expected);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int check_ring_step(struct intel_ring *ring, u32 x, u32 step)\n{\n\tu32 prev = x, next = intel_ring_wrap(ring, x + step);\n\tint err = 0;\n\n\terr |= check_ring_direction(ring, next, next,  0);\n\terr |= check_ring_direction(ring, prev, prev,  0);\n\terr |= check_ring_direction(ring, next, prev,  1);\n\terr |= check_ring_direction(ring, prev, next, -1);\n\n\treturn err;\n}\n\nstatic int check_ring_offset(struct intel_ring *ring, u32 x, u32 step)\n{\n\tint err = 0;\n\n\terr |= check_ring_step(ring, x, step);\n\terr |= check_ring_step(ring, intel_ring_wrap(ring, x + 1), step);\n\terr |= check_ring_step(ring, intel_ring_wrap(ring, x - 1), step);\n\n\treturn err;\n}\n\nstatic int igt_ring_direction(void *dummy)\n{\n\tstruct intel_ring *ring;\n\tunsigned int half = 2048;\n\tint step, err = 0;\n\n\tring = mock_ring(2 * half);\n\tif (!ring)\n\t\treturn -ENOMEM;\n\n\tGEM_BUG_ON(ring->size != 2 * half);\n\n\t \n\tfor (step = 1; step < half; step <<= 1) {\n\t\terr |= check_ring_offset(ring, 0, step);\n\t\terr |= check_ring_offset(ring, half, step);\n\t}\n\terr |= check_ring_step(ring, 0, half - 64);\n\n\t \n\terr |= check_ring_offset(ring, 0, 2 * half + 64);\n\terr |= check_ring_offset(ring, 3 * half, 1);\n\n\tmock_ring_free(ring);\n\treturn err;\n}\n\nint intel_ring_mock_selftests(void)\n{\n\tstatic const struct i915_subtest tests[] = {\n\t\tSUBTEST(igt_ring_direction),\n\t};\n\n\treturn i915_subtests(tests, NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}