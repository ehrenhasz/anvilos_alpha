{
  "module_name": "intel_mocs.c",
  "hash_id": "342607187133fd7699bdd92092afe331a57007f6cf750730dc40b3c819b20a56",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/intel_mocs.c",
  "human_readable_source": "\n \n\n#include \"i915_drv.h\"\n\n#include \"intel_engine.h\"\n#include \"intel_gt.h\"\n#include \"intel_gt_mcr.h\"\n#include \"intel_gt_regs.h\"\n#include \"intel_mocs.h\"\n#include \"intel_ring.h\"\n\n \nstruct drm_i915_mocs_entry {\n\tu32 control_value;\n\tu16 l3cc_value;\n\tu16 used;\n};\n\nstruct drm_i915_mocs_table {\n\tunsigned int size;\n\tunsigned int n_entries;\n\tconst struct drm_i915_mocs_entry *table;\n\tu8 uc_index;\n\tu8 wb_index;  \n\tu8 unused_entries_index;\n};\n\n \n#define _LE_CACHEABILITY(value)\t((value) << 0)\n#define _LE_TGT_CACHE(value)\t((value) << 2)\n#define LE_LRUM(value)\t\t((value) << 4)\n#define LE_AOM(value)\t\t((value) << 6)\n#define LE_RSC(value)\t\t((value) << 7)\n#define LE_SCC(value)\t\t((value) << 8)\n#define LE_PFM(value)\t\t((value) << 11)\n#define LE_SCF(value)\t\t((value) << 14)\n#define LE_COS(value)\t\t((value) << 15)\n#define LE_SSE(value)\t\t((value) << 17)\n\n \n#define _L4_CACHEABILITY(value)\t((value) << 2)\n#define IG_PAT(value)\t\t((value) << 8)\n\n \n#define L3_ESC(value)\t\t((value) << 0)\n#define L3_SCC(value)\t\t((value) << 1)\n#define _L3_CACHEABILITY(value)\t((value) << 4)\n#define L3_GLBGO(value)\t\t((value) << 6)\n#define L3_LKUP(value)\t\t((value) << 7)\n\n \n#define GEN9_NUM_MOCS_ENTRIES\t64   \n#define PVC_NUM_MOCS_ENTRIES\t3\n#define MTL_NUM_MOCS_ENTRIES\t16\n\n \n \n#define LE_0_PAGETABLE\t\t_LE_CACHEABILITY(0)\n#define LE_1_UC\t\t\t_LE_CACHEABILITY(1)\n#define LE_2_WT\t\t\t_LE_CACHEABILITY(2)\n#define LE_3_WB\t\t\t_LE_CACHEABILITY(3)\n\n \n#define LE_TC_0_PAGETABLE\t_LE_TGT_CACHE(0)\n#define LE_TC_1_LLC\t\t_LE_TGT_CACHE(1)\n#define LE_TC_2_LLC_ELLC\t_LE_TGT_CACHE(2)\n#define LE_TC_3_LLC_ELLC_ALT\t_LE_TGT_CACHE(3)\n\n \n#define L3_0_DIRECT\t\t_L3_CACHEABILITY(0)\n#define L3_1_UC\t\t\t_L3_CACHEABILITY(1)\n#define L3_2_RESERVED\t\t_L3_CACHEABILITY(2)\n#define L3_3_WB\t\t\t_L3_CACHEABILITY(3)\n\n \n#define L4_0_WB\t\t\t_L4_CACHEABILITY(0)\n#define L4_1_WT\t\t\t_L4_CACHEABILITY(1)\n#define L4_2_RESERVED\t\t_L4_CACHEABILITY(2)\n#define L4_3_UC\t\t\t_L4_CACHEABILITY(3)\n\n#define MOCS_ENTRY(__idx, __control_value, __l3cc_value) \\\n\t[__idx] = { \\\n\t\t.control_value = __control_value, \\\n\t\t.l3cc_value = __l3cc_value, \\\n\t\t.used = 1, \\\n\t}\n\n \n#define GEN9_MOCS_ENTRIES \\\n\tMOCS_ENTRY(I915_MOCS_UNCACHED, \\\n\t\t   LE_1_UC | LE_TC_2_LLC_ELLC, \\\n\t\t   L3_1_UC), \\\n\tMOCS_ENTRY(I915_MOCS_PTE, \\\n\t\t   LE_0_PAGETABLE | LE_TC_0_PAGETABLE | LE_LRUM(3), \\\n\t\t   L3_3_WB)\n\nstatic const struct drm_i915_mocs_entry skl_mocs_table[] = {\n\tGEN9_MOCS_ENTRIES,\n\tMOCS_ENTRY(I915_MOCS_CACHED,\n\t\t   LE_3_WB | LE_TC_2_LLC_ELLC | LE_LRUM(3),\n\t\t   L3_3_WB),\n\n\t \n\tMOCS_ENTRY(63,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_1_UC)\n};\n\n \nstatic const struct drm_i915_mocs_entry broxton_mocs_table[] = {\n\tGEN9_MOCS_ENTRIES,\n\tMOCS_ENTRY(I915_MOCS_CACHED,\n\t\t   LE_1_UC | LE_TC_2_LLC_ELLC | LE_LRUM(3),\n\t\t   L3_3_WB)\n};\n\n#define GEN11_MOCS_ENTRIES \\\n\t  \\\n\t  \\\n\tMOCS_ENTRY(2, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(3, \\\n\t\t   LE_1_UC | LE_TC_1_LLC, \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(4, \\\n\t\t   LE_1_UC | LE_TC_1_LLC, \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(5, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(6, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(1), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(7, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(1), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(8, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(2), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(9, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(2), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(10, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_AOM(1), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(11, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_AOM(1), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(12, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(1) | LE_AOM(1), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(13, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(1) | LE_AOM(1), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(14, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(2) | LE_AOM(1), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(15, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(2) | LE_AOM(1), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(16, \\\n\t\t   LE_1_UC | LE_TC_1_LLC | LE_SCF(1), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(17, \\\n\t\t   LE_1_UC | LE_TC_1_LLC | LE_SCF(1), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(18, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_SSE(3), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(19, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_SCC(7), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(20, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_SCC(3), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(21, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_SCC(1), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(22, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_RSC(1) | LE_SCC(3), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(23, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3) | LE_RSC(1) | LE_SCC(7), \\\n\t\t   L3_3_WB), \\\n\t  \\\n\tMOCS_ENTRY(62, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3), \\\n\t\t   L3_1_UC), \\\n\t  \\\n\tMOCS_ENTRY(63, \\\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3), \\\n\t\t   L3_1_UC)\n\nstatic const struct drm_i915_mocs_entry tgl_mocs_table[] = {\n\t \n\tMOCS_ENTRY(I915_MOCS_PTE,\n\t\t   LE_0_PAGETABLE | LE_TC_0_PAGETABLE,\n\t\t   L3_1_UC),\n\tGEN11_MOCS_ENTRIES,\n\n\t \n\tMOCS_ENTRY(48,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_3_WB),\n\t \n\tMOCS_ENTRY(49,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_3_WB),\n\t \n\tMOCS_ENTRY(50,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(51,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(60,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(61,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_3_WB),\n};\n\nstatic const struct drm_i915_mocs_entry icl_mocs_table[] = {\n\t \n\tMOCS_ENTRY(I915_MOCS_UNCACHED,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(I915_MOCS_PTE,\n\t\t   LE_0_PAGETABLE | LE_TC_0_PAGETABLE,\n\t\t   L3_3_WB),\n\n\tGEN11_MOCS_ENTRIES\n};\n\nstatic const struct drm_i915_mocs_entry dg1_mocs_table[] = {\n\n\t \n\tMOCS_ENTRY(1, 0, L3_1_UC),\n\t \n\tMOCS_ENTRY(5, 0, L3_3_WB),\n\t \n\tMOCS_ENTRY(6, 0, L3_ESC(1) | L3_SCC(1) | L3_3_WB),\n\t \n\tMOCS_ENTRY(7, 0, L3_ESC(1) | L3_SCC(3) | L3_3_WB),\n\t \n\tMOCS_ENTRY(8, 0, L3_ESC(1) | L3_SCC(7) | L3_3_WB),\n\n\t \n\tMOCS_ENTRY(48, 0, L3_3_WB),\n\t \n\tMOCS_ENTRY(49, 0, L3_1_UC),\n\n\t \n\tMOCS_ENTRY(60, 0, L3_1_UC),\n\tMOCS_ENTRY(61, 0, L3_1_UC),\n\tMOCS_ENTRY(62, 0, L3_1_UC),\n\tMOCS_ENTRY(63, 0, L3_1_UC),\n};\n\nstatic const struct drm_i915_mocs_entry gen12_mocs_table[] = {\n\tGEN11_MOCS_ENTRIES,\n\t \n\tMOCS_ENTRY(48,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_3_WB),\n\t \n\tMOCS_ENTRY(49,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_3_WB),\n\t \n\tMOCS_ENTRY(50,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(51,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(60,\n\t\t   LE_3_WB | LE_TC_1_LLC | LE_LRUM(3),\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(61,\n\t\t   LE_1_UC | LE_TC_1_LLC,\n\t\t   L3_3_WB),\n};\n\nstatic const struct drm_i915_mocs_entry xehpsdv_mocs_table[] = {\n\t \n\tMOCS_ENTRY(0, 0, L3_3_WB | L3_LKUP(1)),\n\n\t \n\tMOCS_ENTRY(1, 0, L3_1_UC | L3_LKUP(1)),\n\t \n\tMOCS_ENTRY(2, 0, L3_1_UC | L3_GLBGO(1) | L3_LKUP(1)),\n\t \n\tMOCS_ENTRY(3, 0, L3_1_UC | L3_GLBGO(1)),\n\t \n\tMOCS_ENTRY(4, 0, L3_1_UC),\n\n\t \n\tMOCS_ENTRY(5, 0, L3_3_WB | L3_LKUP(1)),\n\n\t \n\tMOCS_ENTRY(48, 0, L3_3_WB | L3_LKUP(1)),\n\tMOCS_ENTRY(49, 0, L3_1_UC | L3_LKUP(1)),\n\tMOCS_ENTRY(60, 0, L3_1_UC),\n\tMOCS_ENTRY(61, 0, L3_1_UC),\n\tMOCS_ENTRY(62, 0, L3_1_UC),\n\tMOCS_ENTRY(63, 0, L3_1_UC),\n};\n\nstatic const struct drm_i915_mocs_entry dg2_mocs_table[] = {\n\t \n\tMOCS_ENTRY(0, 0, L3_1_UC | L3_LKUP(1)),\n\t \n\tMOCS_ENTRY(1, 0, L3_1_UC | L3_GLBGO(1) | L3_LKUP(1)),\n\t \n\tMOCS_ENTRY(2, 0, L3_1_UC | L3_GLBGO(1)),\n\n\t \n\tMOCS_ENTRY(3, 0, L3_3_WB | L3_LKUP(1)),\n};\n\nstatic const struct drm_i915_mocs_entry dg2_mocs_table_g10_ax[] = {\n\t \n\tMOCS_ENTRY(0, 0, L3_1_UC | L3_GLBGO(1) | L3_LKUP(1)),\n\t \n\tMOCS_ENTRY(1, 0, L3_1_UC | L3_GLBGO(1) | L3_LKUP(1)),\n\t \n\tMOCS_ENTRY(2, 0, L3_1_UC | L3_GLBGO(1)),\n\n\t \n\tMOCS_ENTRY(3, 0, L3_3_WB | L3_LKUP(1)),\n};\n\nstatic const struct drm_i915_mocs_entry pvc_mocs_table[] = {\n\t \n\tMOCS_ENTRY(0, 0, L3_3_WB),\n\n\t \n\tMOCS_ENTRY(1, 0, L3_1_UC),\n\n\t \n\tMOCS_ENTRY(2, 0, L3_3_WB),\n};\n\nstatic const struct drm_i915_mocs_entry mtl_mocs_table[] = {\n\t \n\tMOCS_ENTRY(0,\n\t\t   IG_PAT(0),\n\t\t   L3_LKUP(1) | L3_3_WB),\n\t \n\tMOCS_ENTRY(1,\n\t\t   IG_PAT(1),\n\t\t   L3_LKUP(1) | L3_3_WB),\n\t \n\tMOCS_ENTRY(2,\n\t\t   IG_PAT(1),\n\t\t   L3_LKUP(1) | L3_1_UC),\n\t \n\tMOCS_ENTRY(3,\n\t\t   IG_PAT(1) | L4_3_UC,\n\t\t   L3_LKUP(1) | L3_1_UC),\n\t \n\tMOCS_ENTRY(4,\n\t\t   IG_PAT(1),\n\t\t   L3_LKUP(1) | L3_GLBGO(1) | L3_1_UC),\n\t \n\tMOCS_ENTRY(5,\n\t\t   IG_PAT(1) | L4_3_UC,\n\t\t   L3_LKUP(1) | L3_GLBGO(1) | L3_1_UC),\n\t \n\tMOCS_ENTRY(6,\n\t\t   IG_PAT(1),\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(7,\n\t\t   IG_PAT(1) | L4_3_UC,\n\t\t   L3_1_UC),\n\t \n\tMOCS_ENTRY(8,\n\t\t   IG_PAT(1),\n\t\t   L3_GLBGO(1) | L3_1_UC),\n\t \n\tMOCS_ENTRY(9,\n\t\t   IG_PAT(1) | L4_3_UC,\n\t\t   L3_GLBGO(1) | L3_1_UC),\n\t \n\tMOCS_ENTRY(14,\n\t\t   IG_PAT(1) | L4_1_WT,\n\t\t   L3_LKUP(1) | L3_3_WB),\n\t \n\tMOCS_ENTRY(15,\n\t\t   IG_PAT(1),\n\t\t   L3_GLBGO(1) | L3_1_UC),\n};\n\nenum {\n\tHAS_GLOBAL_MOCS = BIT(0),\n\tHAS_ENGINE_MOCS = BIT(1),\n\tHAS_RENDER_L3CC = BIT(2),\n};\n\nstatic bool has_l3cc(const struct drm_i915_private *i915)\n{\n\treturn true;\n}\n\nstatic bool has_global_mocs(const struct drm_i915_private *i915)\n{\n\treturn HAS_GLOBAL_MOCS_REGISTERS(i915);\n}\n\nstatic bool has_mocs(const struct drm_i915_private *i915)\n{\n\treturn !IS_DGFX(i915);\n}\n\nstatic unsigned int get_mocs_settings(const struct drm_i915_private *i915,\n\t\t\t\t      struct drm_i915_mocs_table *table)\n{\n\tunsigned int flags;\n\n\tmemset(table, 0, sizeof(struct drm_i915_mocs_table));\n\n\ttable->unused_entries_index = I915_MOCS_PTE;\n\tif (IS_METEORLAKE(i915)) {\n\t\ttable->size = ARRAY_SIZE(mtl_mocs_table);\n\t\ttable->table = mtl_mocs_table;\n\t\ttable->n_entries = MTL_NUM_MOCS_ENTRIES;\n\t\ttable->uc_index = 9;\n\t\ttable->unused_entries_index = 1;\n\t} else if (IS_PONTEVECCHIO(i915)) {\n\t\ttable->size = ARRAY_SIZE(pvc_mocs_table);\n\t\ttable->table = pvc_mocs_table;\n\t\ttable->n_entries = PVC_NUM_MOCS_ENTRIES;\n\t\ttable->uc_index = 1;\n\t\ttable->wb_index = 2;\n\t\ttable->unused_entries_index = 2;\n\t} else if (IS_DG2(i915)) {\n\t\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_A0, STEP_B0)) {\n\t\t\ttable->size = ARRAY_SIZE(dg2_mocs_table_g10_ax);\n\t\t\ttable->table = dg2_mocs_table_g10_ax;\n\t\t} else {\n\t\t\ttable->size = ARRAY_SIZE(dg2_mocs_table);\n\t\t\ttable->table = dg2_mocs_table;\n\t\t}\n\t\ttable->uc_index = 1;\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->unused_entries_index = 3;\n\t} else if (IS_XEHPSDV(i915)) {\n\t\ttable->size = ARRAY_SIZE(xehpsdv_mocs_table);\n\t\ttable->table = xehpsdv_mocs_table;\n\t\ttable->uc_index = 2;\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->unused_entries_index = 5;\n\t} else if (IS_DG1(i915)) {\n\t\ttable->size = ARRAY_SIZE(dg1_mocs_table);\n\t\ttable->table = dg1_mocs_table;\n\t\ttable->uc_index = 1;\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->uc_index = 1;\n\t\ttable->unused_entries_index = 5;\n\t} else if (IS_TIGERLAKE(i915) || IS_ROCKETLAKE(i915)) {\n\t\t \n\t\ttable->size  = ARRAY_SIZE(tgl_mocs_table);\n\t\ttable->table = tgl_mocs_table;\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->uc_index = 3;\n\t} else if (GRAPHICS_VER(i915) >= 12) {\n\t\ttable->size  = ARRAY_SIZE(gen12_mocs_table);\n\t\ttable->table = gen12_mocs_table;\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->uc_index = 3;\n\t\ttable->unused_entries_index = 2;\n\t} else if (GRAPHICS_VER(i915) == 11) {\n\t\ttable->size  = ARRAY_SIZE(icl_mocs_table);\n\t\ttable->table = icl_mocs_table;\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t} else if (IS_GEN9_BC(i915)) {\n\t\ttable->size  = ARRAY_SIZE(skl_mocs_table);\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->table = skl_mocs_table;\n\t} else if (IS_GEN9_LP(i915)) {\n\t\ttable->size  = ARRAY_SIZE(broxton_mocs_table);\n\t\ttable->n_entries = GEN9_NUM_MOCS_ENTRIES;\n\t\ttable->table = broxton_mocs_table;\n\t} else {\n\t\tdrm_WARN_ONCE(&i915->drm, GRAPHICS_VER(i915) >= 9,\n\t\t\t      \"Platform that should have a MOCS table does not.\\n\");\n\t\treturn 0;\n\t}\n\n\tif (GEM_DEBUG_WARN_ON(table->size > table->n_entries))\n\t\treturn 0;\n\n\t \n\tif (GRAPHICS_VER(i915) == 9) {\n\t\tint i;\n\n\t\tfor (i = 0; i < table->size; i++)\n\t\t\tif (GEM_DEBUG_WARN_ON(table->table[i].l3cc_value &\n\t\t\t\t\t      (L3_ESC(1) | L3_SCC(0x7))))\n\t\t\t\treturn 0;\n\t}\n\n\tflags = 0;\n\tif (has_mocs(i915)) {\n\t\tif (has_global_mocs(i915))\n\t\t\tflags |= HAS_GLOBAL_MOCS;\n\t\telse\n\t\t\tflags |= HAS_ENGINE_MOCS;\n\t}\n\tif (has_l3cc(i915))\n\t\tflags |= HAS_RENDER_L3CC;\n\n\treturn flags;\n}\n\n \nstatic u32 get_entry_control(const struct drm_i915_mocs_table *table,\n\t\t\t     unsigned int index)\n{\n\tif (index < table->size && table->table[index].used)\n\t\treturn table->table[index].control_value;\n\treturn table->table[table->unused_entries_index].control_value;\n}\n\n#define for_each_mocs(mocs, t, i) \\\n\tfor (i = 0; \\\n\t     i < (t)->n_entries ? (mocs = get_entry_control((t), i)), 1 : 0;\\\n\t     i++)\n\nstatic void __init_mocs_table(struct intel_uncore *uncore,\n\t\t\t      const struct drm_i915_mocs_table *table,\n\t\t\t      u32 addr)\n{\n\tunsigned int i;\n\tu32 mocs;\n\n\tdrm_WARN_ONCE(&uncore->i915->drm, !table->unused_entries_index,\n\t\t      \"Unused entries index should have been defined\\n\");\n\tfor_each_mocs(mocs, table, i)\n\t\tintel_uncore_write_fw(uncore, _MMIO(addr + i * 4), mocs);\n}\n\nstatic u32 mocs_offset(const struct intel_engine_cs *engine)\n{\n\tstatic const u32 offset[] = {\n\t\t[RCS0]  =  __GEN9_RCS0_MOCS0,\n\t\t[VCS0]  =  __GEN9_VCS0_MOCS0,\n\t\t[VCS1]  =  __GEN9_VCS1_MOCS0,\n\t\t[VECS0] =  __GEN9_VECS0_MOCS0,\n\t\t[BCS0]  =  __GEN9_BCS0_MOCS0,\n\t\t[VCS2]  = __GEN11_VCS2_MOCS0,\n\t};\n\n\tGEM_BUG_ON(engine->id >= ARRAY_SIZE(offset));\n\treturn offset[engine->id];\n}\n\nstatic void init_mocs_table(struct intel_engine_cs *engine,\n\t\t\t    const struct drm_i915_mocs_table *table)\n{\n\t__init_mocs_table(engine->uncore, table, mocs_offset(engine));\n}\n\n \nstatic u16 get_entry_l3cc(const struct drm_i915_mocs_table *table,\n\t\t\t  unsigned int index)\n{\n\tif (index < table->size && table->table[index].used)\n\t\treturn table->table[index].l3cc_value;\n\treturn table->table[table->unused_entries_index].l3cc_value;\n}\n\nstatic u32 l3cc_combine(u16 low, u16 high)\n{\n\treturn low | (u32)high << 16;\n}\n\n#define for_each_l3cc(l3cc, t, i) \\\n\tfor (i = 0; \\\n\t     i < ((t)->n_entries + 1) / 2 ? \\\n\t     (l3cc = l3cc_combine(get_entry_l3cc((t), 2 * i), \\\n\t\t\t\t  get_entry_l3cc((t), 2 * i + 1))), 1 : \\\n\t     0; \\\n\t     i++)\n\nstatic void init_l3cc_table(struct intel_gt *gt,\n\t\t\t    const struct drm_i915_mocs_table *table)\n{\n\tunsigned long flags;\n\tunsigned int i;\n\tu32 l3cc;\n\n\tintel_gt_mcr_lock(gt, &flags);\n\tfor_each_l3cc(l3cc, table, i)\n\t\tif (GRAPHICS_VER_FULL(gt->i915) >= IP_VER(12, 50))\n\t\t\tintel_gt_mcr_multicast_write_fw(gt, XEHP_LNCFCMOCS(i), l3cc);\n\t\telse\n\t\t\tintel_uncore_write_fw(gt->uncore, GEN9_LNCFCMOCS(i), l3cc);\n\tintel_gt_mcr_unlock(gt, flags);\n}\n\nvoid intel_mocs_init_engine(struct intel_engine_cs *engine)\n{\n\tstruct drm_i915_mocs_table table;\n\tunsigned int flags;\n\n\t \n\tassert_forcewakes_active(engine->uncore, FORCEWAKE_ALL);\n\n\tflags = get_mocs_settings(engine->i915, &table);\n\tif (!flags)\n\t\treturn;\n\n\t \n\tif (flags & HAS_ENGINE_MOCS)\n\t\tinit_mocs_table(engine, &table);\n\n\tif (flags & HAS_RENDER_L3CC && engine->class == RENDER_CLASS)\n\t\tinit_l3cc_table(engine->gt, &table);\n}\n\nstatic u32 global_mocs_offset(void)\n{\n\treturn i915_mmio_reg_offset(GEN12_GLOBAL_MOCS(0));\n}\n\nvoid intel_set_mocs_index(struct intel_gt *gt)\n{\n\tstruct drm_i915_mocs_table table;\n\n\tget_mocs_settings(gt->i915, &table);\n\tgt->mocs.uc_index = table.uc_index;\n\tif (HAS_L3_CCS_READ(gt->i915))\n\t\tgt->mocs.wb_index = table.wb_index;\n}\n\nvoid intel_mocs_init(struct intel_gt *gt)\n{\n\tstruct drm_i915_mocs_table table;\n\tunsigned int flags;\n\n\t \n\tflags = get_mocs_settings(gt->i915, &table);\n\tif (flags & HAS_GLOBAL_MOCS)\n\t\t__init_mocs_table(gt->uncore, &table, global_mocs_offset());\n\n\t \n\tif (flags & HAS_RENDER_L3CC)\n\t\tinit_l3cc_table(gt, &table);\n}\n\n#if IS_ENABLED(CONFIG_DRM_I915_SELFTEST)\n#include \"selftest_mocs.c\"\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}