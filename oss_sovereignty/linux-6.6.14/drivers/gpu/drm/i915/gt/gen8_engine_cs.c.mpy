{
  "module_name": "gen8_engine_cs.c",
  "hash_id": "7971e5bfed830a3c5ce8218cc7131e91c3180feb32adb40d4a25cb3ee5265887",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/gen8_engine_cs.c",
  "human_readable_source": "\n \n\n#include \"gen8_engine_cs.h\"\n#include \"i915_drv.h\"\n#include \"intel_engine_regs.h\"\n#include \"intel_gpu_commands.h\"\n#include \"intel_lrc.h\"\n#include \"intel_ring.h\"\n\nint gen8_emit_flush_rcs(struct i915_request *rq, u32 mode)\n{\n\tbool vf_flush_wa = false, dc_flush_wa = false;\n\tu32 *cs, flags = 0;\n\tint len;\n\n\tflags |= PIPE_CONTROL_CS_STALL;\n\n\tif (mode & EMIT_FLUSH) {\n\t\tflags |= PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH;\n\t\tflags |= PIPE_CONTROL_DEPTH_CACHE_FLUSH;\n\t\tflags |= PIPE_CONTROL_DC_FLUSH_ENABLE;\n\t\tflags |= PIPE_CONTROL_FLUSH_ENABLE;\n\t}\n\n\tif (mode & EMIT_INVALIDATE) {\n\t\tflags |= PIPE_CONTROL_TLB_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_INSTRUCTION_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_TEXTURE_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_VF_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_CONST_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_STATE_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_QW_WRITE;\n\t\tflags |= PIPE_CONTROL_STORE_DATA_INDEX;\n\n\t\t \n\t\tif (GRAPHICS_VER(rq->i915) == 9)\n\t\t\tvf_flush_wa = true;\n\n\t\t \n\t\tif (IS_KABYLAKE(rq->i915) && IS_GRAPHICS_STEP(rq->i915, 0, STEP_C0))\n\t\t\tdc_flush_wa = true;\n\t}\n\n\tlen = 6;\n\n\tif (vf_flush_wa)\n\t\tlen += 6;\n\n\tif (dc_flush_wa)\n\t\tlen += 12;\n\n\tcs = intel_ring_begin(rq, len);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\tif (vf_flush_wa)\n\t\tcs = gen8_emit_pipe_control(cs, 0, 0);\n\n\tif (dc_flush_wa)\n\t\tcs = gen8_emit_pipe_control(cs, PIPE_CONTROL_DC_FLUSH_ENABLE,\n\t\t\t\t\t    0);\n\n\tcs = gen8_emit_pipe_control(cs, flags, LRC_PPHWSP_SCRATCH_ADDR);\n\n\tif (dc_flush_wa)\n\t\tcs = gen8_emit_pipe_control(cs, PIPE_CONTROL_CS_STALL, 0);\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen8_emit_flush_xcs(struct i915_request *rq, u32 mode)\n{\n\tu32 cmd, *cs;\n\n\tcs = intel_ring_begin(rq, 4);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\tcmd = MI_FLUSH_DW + 1;\n\n\t \n\tcmd |= MI_FLUSH_DW_STORE_INDEX | MI_FLUSH_DW_OP_STOREDW;\n\n\tif (mode & EMIT_INVALIDATE) {\n\t\tcmd |= MI_INVALIDATE_TLB;\n\t\tif (rq->engine->class == VIDEO_DECODE_CLASS)\n\t\t\tcmd |= MI_INVALIDATE_BSD;\n\t}\n\n\t*cs++ = cmd;\n\t*cs++ = LRC_PPHWSP_SCRATCH_ADDR;\n\t*cs++ = 0;  \n\t*cs++ = 0;  \n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen11_emit_flush_rcs(struct i915_request *rq, u32 mode)\n{\n\tif (mode & EMIT_FLUSH) {\n\t\tu32 *cs;\n\t\tu32 flags = 0;\n\n\t\tflags |= PIPE_CONTROL_CS_STALL;\n\n\t\tflags |= PIPE_CONTROL_TILE_CACHE_FLUSH;\n\t\tflags |= PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH;\n\t\tflags |= PIPE_CONTROL_DEPTH_CACHE_FLUSH;\n\t\tflags |= PIPE_CONTROL_DC_FLUSH_ENABLE;\n\t\tflags |= PIPE_CONTROL_FLUSH_ENABLE;\n\t\tflags |= PIPE_CONTROL_QW_WRITE;\n\t\tflags |= PIPE_CONTROL_STORE_DATA_INDEX;\n\n\t\tcs = intel_ring_begin(rq, 6);\n\t\tif (IS_ERR(cs))\n\t\t\treturn PTR_ERR(cs);\n\n\t\tcs = gen8_emit_pipe_control(cs, flags, LRC_PPHWSP_SCRATCH_ADDR);\n\t\tintel_ring_advance(rq, cs);\n\t}\n\n\tif (mode & EMIT_INVALIDATE) {\n\t\tu32 *cs;\n\t\tu32 flags = 0;\n\n\t\tflags |= PIPE_CONTROL_CS_STALL;\n\n\t\tflags |= PIPE_CONTROL_COMMAND_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_TLB_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_INSTRUCTION_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_TEXTURE_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_VF_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_CONST_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_STATE_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_QW_WRITE;\n\t\tflags |= PIPE_CONTROL_STORE_DATA_INDEX;\n\n\t\tcs = intel_ring_begin(rq, 6);\n\t\tif (IS_ERR(cs))\n\t\t\treturn PTR_ERR(cs);\n\n\t\tcs = gen8_emit_pipe_control(cs, flags, LRC_PPHWSP_SCRATCH_ADDR);\n\t\tintel_ring_advance(rq, cs);\n\t}\n\n\treturn 0;\n}\n\nstatic u32 preparser_disable(bool state)\n{\n\treturn MI_ARB_CHECK | 1 << 8 | state;\n}\n\nstatic i915_reg_t gen12_get_aux_inv_reg(struct intel_engine_cs *engine)\n{\n\tswitch (engine->id) {\n\tcase RCS0:\n\t\treturn GEN12_CCS_AUX_INV;\n\tcase BCS0:\n\t\treturn GEN12_BCS0_AUX_INV;\n\tcase VCS0:\n\t\treturn GEN12_VD0_AUX_INV;\n\tcase VCS2:\n\t\treturn GEN12_VD2_AUX_INV;\n\tcase VECS0:\n\t\treturn GEN12_VE0_AUX_INV;\n\tcase CCS0:\n\t\treturn GEN12_CCS0_AUX_INV;\n\tdefault:\n\t\treturn INVALID_MMIO_REG;\n\t}\n}\n\nstatic bool gen12_needs_ccs_aux_inv(struct intel_engine_cs *engine)\n{\n\ti915_reg_t reg = gen12_get_aux_inv_reg(engine);\n\n\tif (IS_PONTEVECCHIO(engine->i915))\n\t\treturn false;\n\n\t \n\treturn i915_mmio_reg_valid(reg) && !HAS_FLAT_CCS(engine->i915);\n}\n\nu32 *gen12_emit_aux_table_inv(struct intel_engine_cs *engine, u32 *cs)\n{\n\ti915_reg_t inv_reg = gen12_get_aux_inv_reg(engine);\n\tu32 gsi_offset = engine->gt->uncore->gsi_offset;\n\n\tif (!gen12_needs_ccs_aux_inv(engine))\n\t\treturn cs;\n\n\t*cs++ = MI_LOAD_REGISTER_IMM(1) | MI_LRI_MMIO_REMAP_EN;\n\t*cs++ = i915_mmio_reg_offset(inv_reg) + gsi_offset;\n\t*cs++ = AUX_INV;\n\n\t*cs++ = MI_SEMAPHORE_WAIT_TOKEN |\n\t\tMI_SEMAPHORE_REGISTER_POLL |\n\t\tMI_SEMAPHORE_POLL |\n\t\tMI_SEMAPHORE_SAD_EQ_SDD;\n\t*cs++ = 0;\n\t*cs++ = i915_mmio_reg_offset(inv_reg) + gsi_offset;\n\t*cs++ = 0;\n\t*cs++ = 0;\n\n\treturn cs;\n}\n\nstatic int mtl_dummy_pipe_control(struct i915_request *rq)\n{\n\t \n\tif (IS_MTL_GRAPHICS_STEP(rq->i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(rq->i915, P, STEP_A0, STEP_B0)) {\n\t\tu32 *cs;\n\n\t\t \n\t\tcs = intel_ring_begin(rq, 6);\n\t\tif (IS_ERR(cs))\n\t\t\treturn PTR_ERR(cs);\n\t\tcs = gen12_emit_pipe_control(cs,\n\t\t\t\t\t     0,\n\t\t\t\t\t     PIPE_CONTROL_DEPTH_CACHE_FLUSH,\n\t\t\t\t\t     LRC_PPHWSP_SCRATCH_ADDR);\n\t\tintel_ring_advance(rq, cs);\n\t}\n\n\treturn 0;\n}\n\nint gen12_emit_flush_rcs(struct i915_request *rq, u32 mode)\n{\n\tstruct intel_engine_cs *engine = rq->engine;\n\n\t \n\tif (mode & EMIT_FLUSH || gen12_needs_ccs_aux_inv(engine)) {\n\t\tu32 bit_group_0 = 0;\n\t\tu32 bit_group_1 = 0;\n\t\tint err;\n\t\tu32 *cs;\n\n\t\terr = mtl_dummy_pipe_control(rq);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tbit_group_0 |= PIPE_CONTROL0_HDC_PIPELINE_FLUSH;\n\n\t\t \n\t\tif (GRAPHICS_VER_FULL(rq->i915) >= IP_VER(12, 70))\n\t\t\tbit_group_0 |= PIPE_CONTROL_CCS_FLUSH;\n\n\t\t \n\t\tif (mode & EMIT_FLUSH)\n\t\t\tbit_group_1 |= PIPE_CONTROL_FLUSH_L3;\n\n\t\tbit_group_1 |= PIPE_CONTROL_TILE_CACHE_FLUSH;\n\t\tbit_group_1 |= PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH;\n\t\tbit_group_1 |= PIPE_CONTROL_DEPTH_CACHE_FLUSH;\n\t\t \n\t\tbit_group_1 |= PIPE_CONTROL_DEPTH_STALL;\n\t\tbit_group_1 |= PIPE_CONTROL_DC_FLUSH_ENABLE;\n\t\tbit_group_1 |= PIPE_CONTROL_FLUSH_ENABLE;\n\n\t\tbit_group_1 |= PIPE_CONTROL_STORE_DATA_INDEX;\n\t\tbit_group_1 |= PIPE_CONTROL_QW_WRITE;\n\n\t\tbit_group_1 |= PIPE_CONTROL_CS_STALL;\n\n\t\tif (!HAS_3D_PIPELINE(engine->i915))\n\t\t\tbit_group_1 &= ~PIPE_CONTROL_3D_ARCH_FLAGS;\n\t\telse if (engine->class == COMPUTE_CLASS)\n\t\t\tbit_group_1 &= ~PIPE_CONTROL_3D_ENGINE_FLAGS;\n\n\t\tcs = intel_ring_begin(rq, 6);\n\t\tif (IS_ERR(cs))\n\t\t\treturn PTR_ERR(cs);\n\n\t\tcs = gen12_emit_pipe_control(cs, bit_group_0, bit_group_1,\n\t\t\t\t\t     LRC_PPHWSP_SCRATCH_ADDR);\n\t\tintel_ring_advance(rq, cs);\n\t}\n\n\tif (mode & EMIT_INVALIDATE) {\n\t\tu32 flags = 0;\n\t\tu32 *cs, count;\n\t\tint err;\n\n\t\terr = mtl_dummy_pipe_control(rq);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tflags |= PIPE_CONTROL_COMMAND_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_TLB_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_INSTRUCTION_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_TEXTURE_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_VF_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_CONST_CACHE_INVALIDATE;\n\t\tflags |= PIPE_CONTROL_STATE_CACHE_INVALIDATE;\n\n\t\tflags |= PIPE_CONTROL_STORE_DATA_INDEX;\n\t\tflags |= PIPE_CONTROL_QW_WRITE;\n\n\t\tflags |= PIPE_CONTROL_CS_STALL;\n\n\t\tif (!HAS_3D_PIPELINE(engine->i915))\n\t\t\tflags &= ~PIPE_CONTROL_3D_ARCH_FLAGS;\n\t\telse if (engine->class == COMPUTE_CLASS)\n\t\t\tflags &= ~PIPE_CONTROL_3D_ENGINE_FLAGS;\n\n\t\tcount = 8;\n\t\tif (gen12_needs_ccs_aux_inv(rq->engine))\n\t\t\tcount += 8;\n\n\t\tcs = intel_ring_begin(rq, count);\n\t\tif (IS_ERR(cs))\n\t\t\treturn PTR_ERR(cs);\n\n\t\t \n\t\t*cs++ = preparser_disable(true);\n\n\t\tcs = gen8_emit_pipe_control(cs, flags, LRC_PPHWSP_SCRATCH_ADDR);\n\n\t\tcs = gen12_emit_aux_table_inv(engine, cs);\n\n\t\t*cs++ = preparser_disable(false);\n\t\tintel_ring_advance(rq, cs);\n\t}\n\n\treturn 0;\n}\n\nint gen12_emit_flush_xcs(struct i915_request *rq, u32 mode)\n{\n\tu32 cmd = 4;\n\tu32 *cs;\n\n\tif (mode & EMIT_INVALIDATE) {\n\t\tcmd += 2;\n\n\t\tif (gen12_needs_ccs_aux_inv(rq->engine))\n\t\t\tcmd += 8;\n\t}\n\n\tcs = intel_ring_begin(rq, cmd);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\tif (mode & EMIT_INVALIDATE)\n\t\t*cs++ = preparser_disable(true);\n\n\tcmd = MI_FLUSH_DW + 1;\n\n\t \n\tcmd |= MI_FLUSH_DW_STORE_INDEX | MI_FLUSH_DW_OP_STOREDW;\n\n\tif (mode & EMIT_INVALIDATE) {\n\t\tcmd |= MI_INVALIDATE_TLB;\n\t\tif (rq->engine->class == VIDEO_DECODE_CLASS)\n\t\t\tcmd |= MI_INVALIDATE_BSD;\n\n\t\tif (gen12_needs_ccs_aux_inv(rq->engine) &&\n\t\t    rq->engine->class == COPY_ENGINE_CLASS)\n\t\t\tcmd |= MI_FLUSH_DW_CCS;\n\t}\n\n\t*cs++ = cmd;\n\t*cs++ = LRC_PPHWSP_SCRATCH_ADDR;\n\t*cs++ = 0;  \n\t*cs++ = 0;  \n\n\tcs = gen12_emit_aux_table_inv(rq->engine, cs);\n\n\tif (mode & EMIT_INVALIDATE)\n\t\t*cs++ = preparser_disable(false);\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nstatic u32 preempt_address(struct intel_engine_cs *engine)\n{\n\treturn (i915_ggtt_offset(engine->status_page.vma) +\n\t\tI915_GEM_HWS_PREEMPT_ADDR);\n}\n\nstatic u32 hwsp_offset(const struct i915_request *rq)\n{\n\tconst struct intel_timeline *tl;\n\n\t \n\ttl = rcu_dereference_protected(rq->timeline,\n\t\t\t\t       !i915_request_signaled(rq));\n\n\t \n\treturn page_mask_bits(tl->hwsp_offset) + offset_in_page(rq->hwsp_seqno);\n}\n\nint gen8_emit_init_breadcrumb(struct i915_request *rq)\n{\n\tu32 *cs;\n\n\tGEM_BUG_ON(i915_request_has_initial_breadcrumb(rq));\n\tif (!i915_request_timeline(rq)->has_initial_breadcrumb)\n\t\treturn 0;\n\n\tcs = intel_ring_begin(rq, 6);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_STORE_DWORD_IMM_GEN4 | MI_USE_GGTT;\n\t*cs++ = hwsp_offset(rq);\n\t*cs++ = 0;\n\t*cs++ = rq->fence.seqno - 1;\n\n\t \n\t*cs++ = MI_NOOP;\n\t*cs++ = MI_ARB_CHECK;\n\n\tintel_ring_advance(rq, cs);\n\n\t \n\trq->infix = intel_ring_offset(rq, cs);\n\n\t__set_bit(I915_FENCE_FLAG_INITIAL_BREADCRUMB, &rq->fence.flags);\n\n\treturn 0;\n}\n\nstatic int __xehp_emit_bb_start(struct i915_request *rq,\n\t\t\t\tu64 offset, u32 len,\n\t\t\t\tconst unsigned int flags,\n\t\t\t\tu32 arb)\n{\n\tstruct intel_context *ce = rq->context;\n\tu32 wa_offset = lrc_indirect_bb(ce);\n\tu32 *cs;\n\n\tGEM_BUG_ON(!ce->wa_bb_page);\n\n\tcs = intel_ring_begin(rq, 12);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_ARB_ON_OFF | arb;\n\n\t*cs++ = MI_LOAD_REGISTER_MEM_GEN8 |\n\t\tMI_SRM_LRM_GLOBAL_GTT |\n\t\tMI_LRI_LRM_CS_MMIO;\n\t*cs++ = i915_mmio_reg_offset(RING_PREDICATE_RESULT(0));\n\t*cs++ = wa_offset + DG2_PREDICATE_RESULT_WA;\n\t*cs++ = 0;\n\n\t*cs++ = MI_BATCH_BUFFER_START_GEN8 |\n\t\t(flags & I915_DISPATCH_SECURE ? 0 : BIT(8));\n\t*cs++ = lower_32_bits(offset);\n\t*cs++ = upper_32_bits(offset);\n\n\t \n\t*cs++ = MI_BATCH_BUFFER_START_GEN8;\n\t*cs++ = wa_offset + DG2_PREDICATE_RESULT_BB;\n\t*cs++ = 0;\n\n\t*cs++ = MI_ARB_ON_OFF | MI_ARB_DISABLE;\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint xehp_emit_bb_start_noarb(struct i915_request *rq,\n\t\t\t     u64 offset, u32 len,\n\t\t\t     const unsigned int flags)\n{\n\treturn __xehp_emit_bb_start(rq, offset, len, flags, MI_ARB_DISABLE);\n}\n\nint xehp_emit_bb_start(struct i915_request *rq,\n\t\t       u64 offset, u32 len,\n\t\t       const unsigned int flags)\n{\n\treturn __xehp_emit_bb_start(rq, offset, len, flags, MI_ARB_ENABLE);\n}\n\nint gen8_emit_bb_start_noarb(struct i915_request *rq,\n\t\t\t     u64 offset, u32 len,\n\t\t\t     const unsigned int flags)\n{\n\tu32 *cs;\n\n\tcs = intel_ring_begin(rq, 4);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t \n\t*cs++ = MI_ARB_ON_OFF | MI_ARB_DISABLE;\n\n\t \n\t*cs++ = MI_BATCH_BUFFER_START_GEN8 |\n\t\t(flags & I915_DISPATCH_SECURE ? 0 : BIT(8));\n\t*cs++ = lower_32_bits(offset);\n\t*cs++ = upper_32_bits(offset);\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint gen8_emit_bb_start(struct i915_request *rq,\n\t\t       u64 offset, u32 len,\n\t\t       const unsigned int flags)\n{\n\tu32 *cs;\n\n\tif (unlikely(i915_request_has_nopreempt(rq)))\n\t\treturn gen8_emit_bb_start_noarb(rq, offset, len, flags);\n\n\tcs = intel_ring_begin(rq, 6);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = MI_ARB_ON_OFF | MI_ARB_ENABLE;\n\n\t*cs++ = MI_BATCH_BUFFER_START_GEN8 |\n\t\t(flags & I915_DISPATCH_SECURE ? 0 : BIT(8));\n\t*cs++ = lower_32_bits(offset);\n\t*cs++ = upper_32_bits(offset);\n\n\t*cs++ = MI_ARB_ON_OFF | MI_ARB_DISABLE;\n\t*cs++ = MI_NOOP;\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nstatic void assert_request_valid(struct i915_request *rq)\n{\n\tstruct intel_ring *ring __maybe_unused = rq->ring;\n\n\t \n\tGEM_BUG_ON(intel_ring_direction(ring, rq->wa_tail, rq->head) <= 0);\n}\n\n \nstatic u32 *gen8_emit_wa_tail(struct i915_request *rq, u32 *cs)\n{\n\t \n\t*cs++ = MI_ARB_CHECK;\n\t*cs++ = MI_NOOP;\n\trq->wa_tail = intel_ring_offset(rq, cs);\n\n\t \n\tassert_request_valid(rq);\n\n\treturn cs;\n}\n\nstatic u32 *emit_preempt_busywait(struct i915_request *rq, u32 *cs)\n{\n\t*cs++ = MI_ARB_CHECK;  \n\t*cs++ = MI_SEMAPHORE_WAIT |\n\t\tMI_SEMAPHORE_GLOBAL_GTT |\n\t\tMI_SEMAPHORE_POLL |\n\t\tMI_SEMAPHORE_SAD_EQ_SDD;\n\t*cs++ = 0;\n\t*cs++ = preempt_address(rq->engine);\n\t*cs++ = 0;\n\t*cs++ = MI_NOOP;\n\n\treturn cs;\n}\n\nstatic __always_inline u32*\ngen8_emit_fini_breadcrumb_tail(struct i915_request *rq, u32 *cs)\n{\n\t*cs++ = MI_USER_INTERRUPT;\n\n\t*cs++ = MI_ARB_ON_OFF | MI_ARB_ENABLE;\n\tif (intel_engine_has_semaphores(rq->engine) &&\n\t    !intel_uc_uses_guc_submission(&rq->engine->gt->uc))\n\t\tcs = emit_preempt_busywait(rq, cs);\n\n\trq->tail = intel_ring_offset(rq, cs);\n\tassert_ring_tail_valid(rq->ring, rq->tail);\n\n\treturn gen8_emit_wa_tail(rq, cs);\n}\n\nstatic u32 *emit_xcs_breadcrumb(struct i915_request *rq, u32 *cs)\n{\n\treturn gen8_emit_ggtt_write(cs, rq->fence.seqno, hwsp_offset(rq), 0);\n}\n\nu32 *gen8_emit_fini_breadcrumb_xcs(struct i915_request *rq, u32 *cs)\n{\n\treturn gen8_emit_fini_breadcrumb_tail(rq, emit_xcs_breadcrumb(rq, cs));\n}\n\nu32 *gen8_emit_fini_breadcrumb_rcs(struct i915_request *rq, u32 *cs)\n{\n\tcs = gen8_emit_pipe_control(cs,\n\t\t\t\t    PIPE_CONTROL_CS_STALL |\n\t\t\t\t    PIPE_CONTROL_TLB_INVALIDATE |\n\t\t\t\t    PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH |\n\t\t\t\t    PIPE_CONTROL_DEPTH_CACHE_FLUSH |\n\t\t\t\t    PIPE_CONTROL_DC_FLUSH_ENABLE,\n\t\t\t\t    0);\n\n\t \n\tcs = gen8_emit_ggtt_write_rcs(cs,\n\t\t\t\t      rq->fence.seqno,\n\t\t\t\t      hwsp_offset(rq),\n\t\t\t\t      PIPE_CONTROL_FLUSH_ENABLE |\n\t\t\t\t      PIPE_CONTROL_CS_STALL);\n\n\treturn gen8_emit_fini_breadcrumb_tail(rq, cs);\n}\n\nu32 *gen11_emit_fini_breadcrumb_rcs(struct i915_request *rq, u32 *cs)\n{\n\tcs = gen8_emit_pipe_control(cs,\n\t\t\t\t    PIPE_CONTROL_CS_STALL |\n\t\t\t\t    PIPE_CONTROL_TLB_INVALIDATE |\n\t\t\t\t    PIPE_CONTROL_TILE_CACHE_FLUSH |\n\t\t\t\t    PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH |\n\t\t\t\t    PIPE_CONTROL_DEPTH_CACHE_FLUSH |\n\t\t\t\t    PIPE_CONTROL_DC_FLUSH_ENABLE,\n\t\t\t\t    0);\n\n\t \n\tcs = gen8_emit_ggtt_write_rcs(cs,\n\t\t\t\t      rq->fence.seqno,\n\t\t\t\t      hwsp_offset(rq),\n\t\t\t\t      PIPE_CONTROL_FLUSH_ENABLE |\n\t\t\t\t      PIPE_CONTROL_CS_STALL);\n\n\treturn gen8_emit_fini_breadcrumb_tail(rq, cs);\n}\n\n \n\nstatic u32 *gen12_emit_preempt_busywait(struct i915_request *rq, u32 *cs)\n{\n\t*cs++ = MI_ARB_CHECK;  \n\t*cs++ = MI_SEMAPHORE_WAIT_TOKEN |\n\t\tMI_SEMAPHORE_GLOBAL_GTT |\n\t\tMI_SEMAPHORE_POLL |\n\t\tMI_SEMAPHORE_SAD_EQ_SDD;\n\t*cs++ = 0;\n\t*cs++ = preempt_address(rq->engine);\n\t*cs++ = 0;\n\t*cs++ = 0;\n\n\treturn cs;\n}\n\n \n#define CCS_SEMAPHORE_PPHWSP_OFFSET\t0x540\nstatic u32 ccs_semaphore_offset(struct i915_request *rq)\n{\n\treturn i915_ggtt_offset(rq->context->state) +\n\t\t(LRC_PPHWSP_PN * PAGE_SIZE) + CCS_SEMAPHORE_PPHWSP_OFFSET;\n}\n\n \nstatic u32 *ccs_emit_wa_busywait(struct i915_request *rq, u32 *cs)\n{\n\tint i;\n\n\t*cs++ = MI_ATOMIC_INLINE | MI_ATOMIC_GLOBAL_GTT | MI_ATOMIC_CS_STALL |\n\t\tMI_ATOMIC_MOVE;\n\t*cs++ = ccs_semaphore_offset(rq);\n\t*cs++ = 0;\n\t*cs++ = 1;\n\n\t \n\tfor (i = 0; i < 8; ++i)\n\t\t*cs++ = 0;\n\n\t*cs++ = MI_SEMAPHORE_WAIT |\n\t\tMI_SEMAPHORE_GLOBAL_GTT |\n\t\tMI_SEMAPHORE_POLL |\n\t\tMI_SEMAPHORE_SAD_EQ_SDD;\n\t*cs++ = 0;\n\t*cs++ = ccs_semaphore_offset(rq);\n\t*cs++ = 0;\n\n\treturn cs;\n}\n\nstatic __always_inline u32*\ngen12_emit_fini_breadcrumb_tail(struct i915_request *rq, u32 *cs)\n{\n\t*cs++ = MI_USER_INTERRUPT;\n\n\t*cs++ = MI_ARB_ON_OFF | MI_ARB_ENABLE;\n\tif (intel_engine_has_semaphores(rq->engine) &&\n\t    !intel_uc_uses_guc_submission(&rq->engine->gt->uc))\n\t\tcs = gen12_emit_preempt_busywait(rq, cs);\n\n\t \n\tif (intel_engine_uses_wa_hold_ccs_switchout(rq->engine))\n\t\tcs = ccs_emit_wa_busywait(rq, cs);\n\n\trq->tail = intel_ring_offset(rq, cs);\n\tassert_ring_tail_valid(rq->ring, rq->tail);\n\n\treturn gen8_emit_wa_tail(rq, cs);\n}\n\nu32 *gen12_emit_fini_breadcrumb_xcs(struct i915_request *rq, u32 *cs)\n{\n\t \n\tcs = emit_xcs_breadcrumb(rq, __gen8_emit_flush_dw(cs, 0, 0, 0));\n\treturn gen12_emit_fini_breadcrumb_tail(rq, cs);\n}\n\nu32 *gen12_emit_fini_breadcrumb_rcs(struct i915_request *rq, u32 *cs)\n{\n\tstruct drm_i915_private *i915 = rq->i915;\n\tu32 flags = (PIPE_CONTROL_CS_STALL |\n\t\t     PIPE_CONTROL_TLB_INVALIDATE |\n\t\t     PIPE_CONTROL_TILE_CACHE_FLUSH |\n\t\t     PIPE_CONTROL_FLUSH_L3 |\n\t\t     PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH |\n\t\t     PIPE_CONTROL_DEPTH_CACHE_FLUSH |\n\t\t     PIPE_CONTROL_DC_FLUSH_ENABLE |\n\t\t     PIPE_CONTROL_FLUSH_ENABLE);\n\n\t \n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0))\n\t\t \n\t\tcs = gen12_emit_pipe_control(cs, 0,\n\t\t\t\t\t     PIPE_CONTROL_DEPTH_CACHE_FLUSH, 0);\n\n\tif (GRAPHICS_VER(i915) == 12 && GRAPHICS_VER_FULL(i915) < IP_VER(12, 50))\n\t\t \n\t\tflags |= PIPE_CONTROL_DEPTH_STALL;\n\n\tif (!HAS_3D_PIPELINE(rq->i915))\n\t\tflags &= ~PIPE_CONTROL_3D_ARCH_FLAGS;\n\telse if (rq->engine->class == COMPUTE_CLASS)\n\t\tflags &= ~PIPE_CONTROL_3D_ENGINE_FLAGS;\n\n\tcs = gen12_emit_pipe_control(cs, PIPE_CONTROL0_HDC_PIPELINE_FLUSH, flags, 0);\n\n\t \n\tcs = gen12_emit_ggtt_write_rcs(cs,\n\t\t\t\t       rq->fence.seqno,\n\t\t\t\t       hwsp_offset(rq),\n\t\t\t\t       0,\n\t\t\t\t       PIPE_CONTROL_FLUSH_ENABLE |\n\t\t\t\t       PIPE_CONTROL_CS_STALL);\n\n\treturn gen12_emit_fini_breadcrumb_tail(rq, cs);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}