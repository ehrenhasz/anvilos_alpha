{
  "module_name": "intel_workarounds.c",
  "hash_id": "9ed469cc227cf632a40737513efde1f4a734ad52af83eeb058eb5e8ce17a891a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/intel_workarounds.c",
  "human_readable_source": "\n \n\n#include \"i915_drv.h\"\n#include \"i915_reg.h\"\n#include \"intel_context.h\"\n#include \"intel_engine_pm.h\"\n#include \"intel_engine_regs.h\"\n#include \"intel_gpu_commands.h\"\n#include \"intel_gt.h\"\n#include \"intel_gt_mcr.h\"\n#include \"intel_gt_regs.h\"\n#include \"intel_ring.h\"\n#include \"intel_workarounds.h\"\n\n \n\nstatic void wa_init_start(struct i915_wa_list *wal, struct intel_gt *gt,\n\t\t\t  const char *name, const char *engine_name)\n{\n\twal->gt = gt;\n\twal->name = name;\n\twal->engine_name = engine_name;\n}\n\n#define WA_LIST_CHUNK (1 << 4)\n\nstatic void wa_init_finish(struct i915_wa_list *wal)\n{\n\t \n\tif (!IS_ALIGNED(wal->count, WA_LIST_CHUNK)) {\n\t\tstruct i915_wa *list = kmemdup(wal->list,\n\t\t\t\t\t       wal->count * sizeof(*list),\n\t\t\t\t\t       GFP_KERNEL);\n\n\t\tif (list) {\n\t\t\tkfree(wal->list);\n\t\t\twal->list = list;\n\t\t}\n\t}\n\n\tif (!wal->count)\n\t\treturn;\n\n\tdrm_dbg(&wal->gt->i915->drm, \"Initialized %u %s workarounds on %s\\n\",\n\t\twal->wa_count, wal->name, wal->engine_name);\n}\n\nstatic enum forcewake_domains\nwal_get_fw_for_rmw(struct intel_uncore *uncore, const struct i915_wa_list *wal)\n{\n\tenum forcewake_domains fw = 0;\n\tstruct i915_wa *wa;\n\tunsigned int i;\n\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++)\n\t\tfw |= intel_uncore_forcewake_for_reg(uncore,\n\t\t\t\t\t\t     wa->reg,\n\t\t\t\t\t\t     FW_REG_READ |\n\t\t\t\t\t\t     FW_REG_WRITE);\n\n\treturn fw;\n}\n\nstatic void _wa_add(struct i915_wa_list *wal, const struct i915_wa *wa)\n{\n\tunsigned int addr = i915_mmio_reg_offset(wa->reg);\n\tstruct drm_i915_private *i915 = wal->gt->i915;\n\tunsigned int start = 0, end = wal->count;\n\tconst unsigned int grow = WA_LIST_CHUNK;\n\tstruct i915_wa *wa_;\n\n\tGEM_BUG_ON(!is_power_of_2(grow));\n\n\tif (IS_ALIGNED(wal->count, grow)) {  \n\t\tstruct i915_wa *list;\n\n\t\tlist = kmalloc_array(ALIGN(wal->count + 1, grow), sizeof(*wa),\n\t\t\t\t     GFP_KERNEL);\n\t\tif (!list) {\n\t\t\tdrm_err(&i915->drm, \"No space for workaround init!\\n\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (wal->list) {\n\t\t\tmemcpy(list, wal->list, sizeof(*wa) * wal->count);\n\t\t\tkfree(wal->list);\n\t\t}\n\n\t\twal->list = list;\n\t}\n\n\twhile (start < end) {\n\t\tunsigned int mid = start + (end - start) / 2;\n\n\t\tif (i915_mmio_reg_offset(wal->list[mid].reg) < addr) {\n\t\t\tstart = mid + 1;\n\t\t} else if (i915_mmio_reg_offset(wal->list[mid].reg) > addr) {\n\t\t\tend = mid;\n\t\t} else {\n\t\t\twa_ = &wal->list[mid];\n\n\t\t\tif ((wa->clr | wa_->clr) && !(wa->clr & ~wa_->clr)) {\n\t\t\t\tdrm_err(&i915->drm,\n\t\t\t\t\t\"Discarding overwritten w/a for reg %04x (clear: %08x, set: %08x)\\n\",\n\t\t\t\t\ti915_mmio_reg_offset(wa_->reg),\n\t\t\t\t\twa_->clr, wa_->set);\n\n\t\t\t\twa_->set &= ~wa->clr;\n\t\t\t}\n\n\t\t\twal->wa_count++;\n\t\t\twa_->set |= wa->set;\n\t\t\twa_->clr |= wa->clr;\n\t\t\twa_->read |= wa->read;\n\t\t\treturn;\n\t\t}\n\t}\n\n\twal->wa_count++;\n\twa_ = &wal->list[wal->count++];\n\t*wa_ = *wa;\n\n\twhile (wa_-- > wal->list) {\n\t\tGEM_BUG_ON(i915_mmio_reg_offset(wa_[0].reg) ==\n\t\t\t   i915_mmio_reg_offset(wa_[1].reg));\n\t\tif (i915_mmio_reg_offset(wa_[1].reg) >\n\t\t    i915_mmio_reg_offset(wa_[0].reg))\n\t\t\tbreak;\n\n\t\tswap(wa_[1], wa_[0]);\n\t}\n}\n\nstatic void wa_add(struct i915_wa_list *wal, i915_reg_t reg,\n\t\t   u32 clear, u32 set, u32 read_mask, bool masked_reg)\n{\n\tstruct i915_wa wa = {\n\t\t.reg  = reg,\n\t\t.clr  = clear,\n\t\t.set  = set,\n\t\t.read = read_mask,\n\t\t.masked_reg = masked_reg,\n\t};\n\n\t_wa_add(wal, &wa);\n}\n\nstatic void wa_mcr_add(struct i915_wa_list *wal, i915_mcr_reg_t reg,\n\t\t       u32 clear, u32 set, u32 read_mask, bool masked_reg)\n{\n\tstruct i915_wa wa = {\n\t\t.mcr_reg = reg,\n\t\t.clr  = clear,\n\t\t.set  = set,\n\t\t.read = read_mask,\n\t\t.masked_reg = masked_reg,\n\t\t.is_mcr = 1,\n\t};\n\n\t_wa_add(wal, &wa);\n}\n\nstatic void\nwa_write_clr_set(struct i915_wa_list *wal, i915_reg_t reg, u32 clear, u32 set)\n{\n\twa_add(wal, reg, clear, set, clear | set, false);\n}\n\nstatic void\nwa_mcr_write_clr_set(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 clear, u32 set)\n{\n\twa_mcr_add(wal, reg, clear, set, clear | set, false);\n}\n\nstatic void\nwa_write(struct i915_wa_list *wal, i915_reg_t reg, u32 set)\n{\n\twa_write_clr_set(wal, reg, ~0, set);\n}\n\nstatic void\nwa_mcr_write(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 set)\n{\n\twa_mcr_write_clr_set(wal, reg, ~0, set);\n}\n\nstatic void\nwa_write_or(struct i915_wa_list *wal, i915_reg_t reg, u32 set)\n{\n\twa_write_clr_set(wal, reg, set, set);\n}\n\nstatic void\nwa_mcr_write_or(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 set)\n{\n\twa_mcr_write_clr_set(wal, reg, set, set);\n}\n\nstatic void\nwa_write_clr(struct i915_wa_list *wal, i915_reg_t reg, u32 clr)\n{\n\twa_write_clr_set(wal, reg, clr, 0);\n}\n\nstatic void\nwa_mcr_write_clr(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 clr)\n{\n\twa_mcr_write_clr_set(wal, reg, clr, 0);\n}\n\n \n\nstatic void\nwa_masked_en(struct i915_wa_list *wal, i915_reg_t reg, u32 val)\n{\n\twa_add(wal, reg, 0, _MASKED_BIT_ENABLE(val), val, true);\n}\n\nstatic void\nwa_mcr_masked_en(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 val)\n{\n\twa_mcr_add(wal, reg, 0, _MASKED_BIT_ENABLE(val), val, true);\n}\n\nstatic void\nwa_masked_dis(struct i915_wa_list *wal, i915_reg_t reg, u32 val)\n{\n\twa_add(wal, reg, 0, _MASKED_BIT_DISABLE(val), val, true);\n}\n\nstatic void\nwa_mcr_masked_dis(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 val)\n{\n\twa_mcr_add(wal, reg, 0, _MASKED_BIT_DISABLE(val), val, true);\n}\n\nstatic void\nwa_masked_field_set(struct i915_wa_list *wal, i915_reg_t reg,\n\t\t    u32 mask, u32 val)\n{\n\twa_add(wal, reg, 0, _MASKED_FIELD(mask, val), mask, true);\n}\n\nstatic void\nwa_mcr_masked_field_set(struct i915_wa_list *wal, i915_mcr_reg_t reg,\n\t\t\tu32 mask, u32 val)\n{\n\twa_mcr_add(wal, reg, 0, _MASKED_FIELD(mask, val), mask, true);\n}\n\nstatic void gen6_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t      struct i915_wa_list *wal)\n{\n\twa_masked_en(wal, INSTPM, INSTPM_FORCE_ORDERING);\n}\n\nstatic void gen7_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t      struct i915_wa_list *wal)\n{\n\twa_masked_en(wal, INSTPM, INSTPM_FORCE_ORDERING);\n}\n\nstatic void gen8_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t      struct i915_wa_list *wal)\n{\n\twa_masked_en(wal, INSTPM, INSTPM_FORCE_ORDERING);\n\n\t \n\twa_masked_en(wal, RING_MI_MODE(RENDER_RING_BASE), ASYNC_FLIP_PERF_DISABLE);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN,\n\t\t\t PARTIAL_INSTRUCTION_SHOOTDOWN_DISABLE);\n\n\t \n\t \n\t \n\twa_masked_en(wal, HDC_CHICKEN0,\n\t\t     HDC_DONOT_FETCH_MEM_WHEN_MASKED |\n\t\t     HDC_FORCE_NON_COHERENT);\n\n\t \n\twa_masked_dis(wal, CACHE_MODE_0_GEN7, HIZ_RAW_STALL_OPT_DISABLE);\n\n\t \n\twa_masked_en(wal, CACHE_MODE_1, GEN8_4x4_STC_OPTIMIZATION_DISABLE);\n\n\t \n\twa_masked_field_set(wal, GEN7_GT_MODE,\n\t\t\t    GEN6_WIZ_HASHING_MASK,\n\t\t\t    GEN6_WIZ_HASHING_16x4);\n}\n\nstatic void bdw_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tgen8_ctx_workarounds_init(engine, wal);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN, STALL_DOP_GATING_DISABLE);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN2,\n\t\t\t DOP_CLOCK_GATING_DISABLE);\n\n\twa_mcr_masked_en(wal, GEN8_HALF_SLICE_CHICKEN3,\n\t\t\t GEN8_SAMPLER_POWER_BYPASS_DIS);\n\n\twa_masked_en(wal, HDC_CHICKEN0,\n\t\t      \n\t\t     HDC_FORCE_CONTEXT_SAVE_RESTORE_NON_COHERENT |\n\t\t      \n\t\t     (IS_BROADWELL_GT3(i915) ? HDC_FENCE_DEST_SLM_DISABLE : 0));\n}\n\nstatic void chv_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tgen8_ctx_workarounds_init(engine, wal);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN, STALL_DOP_GATING_DISABLE);\n\n\t \n\twa_masked_en(wal, HIZ_CHICKEN, CHV_HZ_8X8_MODE_IN_1X);\n}\n\nstatic void gen9_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t      struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tif (HAS_LLC(i915)) {\n\t\t \n\t\twa_masked_en(wal, COMMON_SLICE_CHICKEN2,\n\t\t\t     GEN9_PBE_COMPRESSED_HASH_SELECTION);\n\t\twa_mcr_masked_en(wal, GEN9_HALF_SLICE_CHICKEN7,\n\t\t\t\t GEN9_SAMPLER_HASH_COMPRESSED_READ_ADDR);\n\t}\n\n\t \n\t \n\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN,\n\t\t\t FLOW_CONTROL_ENABLE |\n\t\t\t PARTIAL_INSTRUCTION_SHOOTDOWN_DISABLE);\n\n\t \n\t \n\twa_mcr_masked_en(wal, GEN9_HALF_SLICE_CHICKEN7,\n\t\t\t GEN9_ENABLE_YV12_BUGFIX |\n\t\t\t GEN9_ENABLE_GPGPU_PREEMPTION);\n\n\t \n\t \n\twa_masked_en(wal, CACHE_MODE_1,\n\t\t     GEN8_4x4_STC_OPTIMIZATION_DISABLE |\n\t\t     GEN9_PARTIAL_RESOLVE_IN_VC_DISABLE);\n\n\t \n\twa_mcr_masked_dis(wal, GEN9_HALF_SLICE_CHICKEN5,\n\t\t\t  GEN9_CCS_TLB_PREFETCH_ENABLE);\n\n\t \n\twa_masked_en(wal, HDC_CHICKEN0,\n\t\t     HDC_FORCE_CONTEXT_SAVE_RESTORE_NON_COHERENT |\n\t\t     HDC_FORCE_CSR_NON_COHERENT_OVR_DISABLE);\n\n\t \n\n\t \n\twa_masked_en(wal, HDC_CHICKEN0,\n\t\t     HDC_FORCE_NON_COHERENT);\n\n\t \n\tif (IS_SKYLAKE(i915) ||\n\t    IS_KABYLAKE(i915) ||\n\t    IS_COFFEELAKE(i915) ||\n\t    IS_COMETLAKE(i915))\n\t\twa_mcr_masked_en(wal, GEN8_HALF_SLICE_CHICKEN3,\n\t\t\t\t GEN8_SAMPLER_POWER_BYPASS_DIS);\n\n\t \n\twa_mcr_masked_en(wal, HALF_SLICE_CHICKEN2, GEN8_ST_PO_DISABLE);\n\n\t \n\n\t \n\twa_masked_dis(wal, GEN8_CS_CHICKEN1, GEN9_PREEMPT_3D_OBJECT_LEVEL);\n\n\t \n\twa_masked_field_set(wal, GEN8_CS_CHICKEN1,\n\t\t\t    GEN9_PREEMPT_GPGPU_LEVEL_MASK,\n\t\t\t    GEN9_PREEMPT_GPGPU_COMMAND_LEVEL);\n\n\t \n\tif (IS_GEN9_LP(i915))\n\t\twa_masked_en(wal, GEN9_WM_CHICKEN3, GEN9_FACTOR_IN_CLR_VAL_HIZ);\n}\n\nstatic void skl_tune_iz_hashing(struct intel_engine_cs *engine,\n\t\t\t\tstruct i915_wa_list *wal)\n{\n\tstruct intel_gt *gt = engine->gt;\n\tu8 vals[3] = { 0, 0, 0 };\n\tunsigned int i;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tu8 ss;\n\n\t\t \n\t\tif (!is_power_of_2(gt->info.sseu.subslice_7eu[i]))\n\t\t\tcontinue;\n\n\t\t \n\t\tss = ffs(gt->info.sseu.subslice_7eu[i]) - 1;\n\t\tvals[i] = 3 - ss;\n\t}\n\n\tif (vals[0] == 0 && vals[1] == 0 && vals[2] == 0)\n\t\treturn;\n\n\t \n\twa_masked_field_set(wal, GEN7_GT_MODE,\n\t\t\t    GEN9_IZ_HASHING_MASK(2) |\n\t\t\t    GEN9_IZ_HASHING_MASK(1) |\n\t\t\t    GEN9_IZ_HASHING_MASK(0),\n\t\t\t    GEN9_IZ_HASHING(2, vals[2]) |\n\t\t\t    GEN9_IZ_HASHING(1, vals[1]) |\n\t\t\t    GEN9_IZ_HASHING(0, vals[0]));\n}\n\nstatic void skl_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tgen9_ctx_workarounds_init(engine, wal);\n\tskl_tune_iz_hashing(engine, wal);\n}\n\nstatic void bxt_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tgen9_ctx_workarounds_init(engine, wal);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN,\n\t\t\t STALL_DOP_GATING_DISABLE);\n\n\t \n\twa_masked_en(wal, COMMON_SLICE_CHICKEN2,\n\t\t     GEN8_SBE_DISABLE_REPLAY_BUF_OPTIMIZATION);\n}\n\nstatic void kbl_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tgen9_ctx_workarounds_init(engine, wal);\n\n\t \n\tif (IS_KABYLAKE(i915) && IS_GRAPHICS_STEP(i915, STEP_C0, STEP_FOREVER))\n\t\twa_masked_en(wal, COMMON_SLICE_CHICKEN2,\n\t\t\t     GEN8_SBE_DISABLE_REPLAY_BUF_OPTIMIZATION);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_HALF_SLICE_CHICKEN1,\n\t\t\t GEN7_SBE_SS_CACHE_DISPATCH_PORT_SHARING_DISABLE);\n}\n\nstatic void glk_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tgen9_ctx_workarounds_init(engine, wal);\n\n\t \n\twa_masked_en(wal, COMMON_SLICE_CHICKEN2,\n\t\t     GEN8_SBE_DISABLE_REPLAY_BUF_OPTIMIZATION);\n}\n\nstatic void cfl_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tgen9_ctx_workarounds_init(engine, wal);\n\n\t \n\twa_masked_en(wal, COMMON_SLICE_CHICKEN2,\n\t\t     GEN8_SBE_DISABLE_REPLAY_BUF_OPTIMIZATION);\n\n\t \n\twa_mcr_masked_en(wal, GEN8_HALF_SLICE_CHICKEN1,\n\t\t\t GEN7_SBE_SS_CACHE_DISPATCH_PORT_SHARING_DISABLE);\n}\n\nstatic void icl_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\t \n\twa_write(wal, GEN8_L3CNTLREG, GEN8_ERRDETBCTRL);\n\n\t \n\twa_mcr_masked_en(wal, ICL_HDC_MODE, HDC_FORCE_NON_COHERENT);\n\n\t \n\twa_mcr_add(wal, GEN10_CACHE_MODE_SS, 0,\n\t\t   _MASKED_BIT_ENABLE(FLOAT_BLEND_OPTIMIZATION_ENABLE),\n\t\t   0  ,\n\t\t   true);\n\n\t \n\twa_masked_field_set(wal, GEN8_CS_CHICKEN1,\n\t\t\t    GEN9_PREEMPT_GPGPU_LEVEL_MASK,\n\t\t\t    GEN9_PREEMPT_GPGPU_THREAD_GROUP_LEVEL);\n\n\t \n\twa_mcr_masked_en(wal, GEN10_SAMPLER_MODE,\n\t\t\t GEN11_SAMPLER_ENABLE_HEADLESS_MSG);\n\n\t \n\twa_write(wal, IVB_FBC_RT_BASE, 0xFFFFFFFF & ~ILK_FBC_RT_VALID);\n\twa_write_clr_set(wal, IVB_FBC_RT_BASE_UPPER,\n\t\t\t 0,\n\t\t\t 0xFFFFFFFF);\n\n\t \n\twa_mcr_masked_en(wal, GEN9_ROW_CHICKEN4, GEN11_DIS_PICK_2ND_EU);\n}\n\n \nstatic void dg2_ctx_gt_tuning_init(struct intel_engine_cs *engine,\n\t\t\t\t   struct i915_wa_list *wal)\n{\n\twa_mcr_masked_en(wal, CHICKEN_RASTER_2, TBIMR_FAST_CLIP);\n\twa_mcr_write_clr_set(wal, XEHP_L3SQCREG5, L3_PWM_TIMER_INIT_VAL_MASK,\n\t\t\t     REG_FIELD_PREP(L3_PWM_TIMER_INIT_VAL_MASK, 0x7f));\n\twa_mcr_write_clr_set(wal, XEHP_FF_MODE2, FF_MODE2_TDS_TIMER_MASK,\n\t\t\t     FF_MODE2_TDS_TIMER_128);\n}\n\nstatic void gen12_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t       struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\t \n\twa_masked_en(wal, GEN11_COMMON_SLICE_CHICKEN3,\n\t\t     GEN12_DISABLE_CPS_AWARE_COLOR_PIPE);\n\n\t \n\twa_masked_field_set(wal, GEN8_CS_CHICKEN1,\n\t\t\t    GEN9_PREEMPT_GPGPU_LEVEL_MASK,\n\t\t\t    GEN9_PREEMPT_GPGPU_THREAD_GROUP_LEVEL);\n\n\t \n\twa_add(wal,\n\t       GEN12_FF_MODE2,\n\t       ~0,\n\t       FF_MODE2_TDS_TIMER_128 | FF_MODE2_GS_TIMER_224,\n\t       0, false);\n\n\tif (!IS_DG1(i915)) {\n\t\t \n\t\twa_masked_en(wal, HIZ_CHICKEN, HZ_DEPTH_TEST_LE_GE_OPT_DISABLE);\n\n\t\t \n\t\twa_masked_en(wal, COMMON_SLICE_CHICKEN4, DISABLE_TDC_LOAD_BALANCING_CALC);\n\t}\n}\n\nstatic void dg1_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tgen12_ctx_workarounds_init(engine, wal);\n\n\t \n\twa_masked_dis(wal, GEN11_COMMON_SLICE_CHICKEN3,\n\t\t      DG1_FLOAT_POINT_BLEND_OPT_STRICT_MODE_EN);\n\n\t \n\twa_masked_en(wal, HIZ_CHICKEN,\n\t\t     DG1_HZ_READ_SUPPRESSION_OPTIMIZATION_DISABLE);\n}\n\nstatic void dg2_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tdg2_ctx_gt_tuning_init(engine, wal);\n\n\t \n\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G11, STEP_A0, STEP_B0)) {\n\t\twa_mcr_masked_dis(wal, VFLSKPD, DIS_MULT_MISS_RD_SQUASH);\n\t\twa_mcr_masked_en(wal, VFLSKPD, DIS_OVER_FETCH_CACHE);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G10, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, XEHP_COMMON_SLICE_CHICKEN3,\n\t\t\t\t XEHP_DUAL_SIMD8_SEQ_MERGE_DISABLE);\n\n\t\t \n\t\twa_mcr_masked_en(wal, XEHP_COMMON_SLICE_CHICKEN3,\n\t\t\t\t GEN12_DISABLE_CPS_AWARE_COLOR_PIPE);\n\t}\n\n\t \n\twa_mcr_masked_en(wal, XEHP_SLICE_COMMON_ECO_CHICKEN1,\n\t\t\t MSC_MSAA_REODER_BUF_BYPASS_DISABLE);\n\n\t \n\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G10, STEP_B0, STEP_FOREVER) ||\n\t    IS_DG2_G11(engine->i915) || IS_DG2_G12(engine->i915))\n\t\twa_masked_field_set(wal, VF_PREEMPTION, PREEMPTION_VERTEX_COUNT, 0x4000);\n\n\t \n\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G10, STEP_C0, STEP_FOREVER) ||\n\t    IS_DG2_G11(engine->i915) || IS_DG2_G12(engine->i915))\n\t\twa_mcr_masked_en(wal, XEHP_PSS_MODE2, SCOREBOARD_STALL_FLUSH_CONTROL);\n\n\t \n\twa_mcr_masked_en(wal, CHICKEN_RASTER_1, DIS_SF_ROUND_NEAREST_EVEN);\n\n\t \n\twa_masked_en(wal, CACHE_MODE_1, MSAA_OPTIMIZATION_REDUC_DISABLE);\n}\n\nstatic void mtl_ctx_gt_tuning_init(struct intel_engine_cs *engine,\n\t\t\t\t   struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tdg2_ctx_gt_tuning_init(engine, wal);\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_B0, STEP_FOREVER) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_B0, STEP_FOREVER))\n\t\twa_add(wal, DRAW_WATERMARK, VERT_WM_VAL, 0x3FF, 0, false);\n}\n\nstatic void mtl_ctx_workarounds_init(struct intel_engine_cs *engine,\n\t\t\t\t     struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tmtl_ctx_gt_tuning_init(engine, wal);\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_masked_field_set(wal, VF_PREEMPTION,\n\t\t\t\t    PREEMPTION_VERTEX_COUNT, 0x4000);\n\n\t\t \n\t\twa_mcr_masked_en(wal, XEHP_SLICE_COMMON_ECO_CHICKEN1,\n\t\t\t\t MSC_MSAA_REODER_BUF_BYPASS_DISABLE);\n\n\t\t \n\t\twa_mcr_masked_en(wal, VFLSKPD, VF_PREFETCH_TLB_DIS);\n\n\t\t \n\t\twa_mcr_masked_en(wal, XEHP_PSS_MODE2, SCOREBOARD_STALL_FLUSH_CONTROL);\n\t}\n\n\t \n\twa_masked_en(wal, CACHE_MODE_1, MSAA_OPTIMIZATION_REDUC_DISABLE);\n}\n\nstatic void fakewa_disable_nestedbb_mode(struct intel_engine_cs *engine,\n\t\t\t\t\t struct i915_wa_list *wal)\n{\n\t \n\twa_masked_dis(wal, RING_MI_MODE(engine->mmio_base), TGL_NESTED_BB_EN);\n}\n\nstatic void gen12_ctx_gt_mocs_init(struct intel_engine_cs *engine,\n\t\t\t\t   struct i915_wa_list *wal)\n{\n\tu8 mocs;\n\n\t \n\tif (engine->class == COPY_ENGINE_CLASS) {\n\t\tmocs = engine->gt->mocs.uc_index;\n\t\twa_write_clr_set(wal,\n\t\t\t\t BLIT_CCTL(engine->mmio_base),\n\t\t\t\t BLIT_CCTL_MASK,\n\t\t\t\t BLIT_CCTL_MOCS(mocs, mocs));\n\t}\n}\n\n \nstatic void\ngen12_ctx_gt_fake_wa_init(struct intel_engine_cs *engine,\n\t\t\t  struct i915_wa_list *wal)\n{\n\tif (GRAPHICS_VER_FULL(engine->i915) >= IP_VER(12, 55))\n\t\tfakewa_disable_nestedbb_mode(engine, wal);\n\n\tgen12_ctx_gt_mocs_init(engine, wal);\n}\n\nstatic void\n__intel_engine_init_ctx_wa(struct intel_engine_cs *engine,\n\t\t\t   struct i915_wa_list *wal,\n\t\t\t   const char *name)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\twa_init_start(wal, engine->gt, name, engine->name);\n\n\t \n\t \n\tif (GRAPHICS_VER(i915) >= 12)\n\t\tgen12_ctx_gt_fake_wa_init(engine, wal);\n\n\tif (engine->class != RENDER_CLASS)\n\t\tgoto done;\n\n\tif (IS_METEORLAKE(i915))\n\t\tmtl_ctx_workarounds_init(engine, wal);\n\telse if (IS_PONTEVECCHIO(i915))\n\t\t;  \n\telse if (IS_DG2(i915))\n\t\tdg2_ctx_workarounds_init(engine, wal);\n\telse if (IS_XEHPSDV(i915))\n\t\t;  \n\telse if (IS_DG1(i915))\n\t\tdg1_ctx_workarounds_init(engine, wal);\n\telse if (GRAPHICS_VER(i915) == 12)\n\t\tgen12_ctx_workarounds_init(engine, wal);\n\telse if (GRAPHICS_VER(i915) == 11)\n\t\ticl_ctx_workarounds_init(engine, wal);\n\telse if (IS_COFFEELAKE(i915) || IS_COMETLAKE(i915))\n\t\tcfl_ctx_workarounds_init(engine, wal);\n\telse if (IS_GEMINILAKE(i915))\n\t\tglk_ctx_workarounds_init(engine, wal);\n\telse if (IS_KABYLAKE(i915))\n\t\tkbl_ctx_workarounds_init(engine, wal);\n\telse if (IS_BROXTON(i915))\n\t\tbxt_ctx_workarounds_init(engine, wal);\n\telse if (IS_SKYLAKE(i915))\n\t\tskl_ctx_workarounds_init(engine, wal);\n\telse if (IS_CHERRYVIEW(i915))\n\t\tchv_ctx_workarounds_init(engine, wal);\n\telse if (IS_BROADWELL(i915))\n\t\tbdw_ctx_workarounds_init(engine, wal);\n\telse if (GRAPHICS_VER(i915) == 7)\n\t\tgen7_ctx_workarounds_init(engine, wal);\n\telse if (GRAPHICS_VER(i915) == 6)\n\t\tgen6_ctx_workarounds_init(engine, wal);\n\telse if (GRAPHICS_VER(i915) < 8)\n\t\t;\n\telse\n\t\tMISSING_CASE(GRAPHICS_VER(i915));\n\ndone:\n\twa_init_finish(wal);\n}\n\nvoid intel_engine_init_ctx_wa(struct intel_engine_cs *engine)\n{\n\t__intel_engine_init_ctx_wa(engine, &engine->ctx_wa_list, \"context\");\n}\n\nint intel_engine_emit_ctx_wa(struct i915_request *rq)\n{\n\tstruct i915_wa_list *wal = &rq->engine->ctx_wa_list;\n\tstruct intel_uncore *uncore = rq->engine->uncore;\n\tenum forcewake_domains fw;\n\tunsigned long flags;\n\tstruct i915_wa *wa;\n\tunsigned int i;\n\tu32 *cs;\n\tint ret;\n\n\tif (wal->count == 0)\n\t\treturn 0;\n\n\tret = rq->engine->emit_flush(rq, EMIT_BARRIER);\n\tif (ret)\n\t\treturn ret;\n\n\tcs = intel_ring_begin(rq, (wal->count * 2 + 2));\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\tfw = wal_get_fw_for_rmw(uncore, wal);\n\n\tintel_gt_mcr_lock(wal->gt, &flags);\n\tspin_lock(&uncore->lock);\n\tintel_uncore_forcewake_get__locked(uncore, fw);\n\n\t*cs++ = MI_LOAD_REGISTER_IMM(wal->count);\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++) {\n\t\tu32 val;\n\n\t\t \n\t\tif (wa->masked_reg || (wa->clr | wa->set) == U32_MAX) {\n\t\t\tval = wa->set;\n\t\t} else {\n\t\t\tval = wa->is_mcr ?\n\t\t\t\tintel_gt_mcr_read_any_fw(wal->gt, wa->mcr_reg) :\n\t\t\t\tintel_uncore_read_fw(uncore, wa->reg);\n\t\t\tval &= ~wa->clr;\n\t\t\tval |= wa->set;\n\t\t}\n\n\t\t*cs++ = i915_mmio_reg_offset(wa->reg);\n\t\t*cs++ = val;\n\t}\n\t*cs++ = MI_NOOP;\n\n\tintel_uncore_forcewake_put__locked(uncore, fw);\n\tspin_unlock(&uncore->lock);\n\tintel_gt_mcr_unlock(wal->gt, flags);\n\n\tintel_ring_advance(rq, cs);\n\n\tret = rq->engine->emit_flush(rq, EMIT_BARRIER);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic void\ngen4_gt_workarounds_init(struct intel_gt *gt,\n\t\t\t struct i915_wa_list *wal)\n{\n\t \n\twa_masked_dis(wal, CACHE_MODE_0, RC_OP_FLUSH_ENABLE);\n}\n\nstatic void\ng4x_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tgen4_gt_workarounds_init(gt, wal);\n\n\t \n\twa_masked_en(wal, CACHE_MODE_0, CM0_PIPELINED_RENDER_FLUSH_DISABLE);\n}\n\nstatic void\nilk_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tg4x_gt_workarounds_init(gt, wal);\n\n\twa_masked_en(wal, _3D_CHICKEN2, _3D_CHICKEN2_WM_READ_PIPELINED);\n}\n\nstatic void\nsnb_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n}\n\nstatic void\nivb_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\t \n\twa_masked_dis(wal,\n\t\t      GEN7_COMMON_SLICE_CHICKEN1,\n\t\t      GEN7_CSC1_RHWO_OPT_DISABLE_IN_RCC);\n\n\t \n\twa_write(wal, GEN7_L3CNTLREG1, GEN7_WA_FOR_GEN7_L3_CONTROL);\n\twa_write(wal, GEN7_L3_CHICKEN_MODE_REGISTER, GEN7_WA_L3_CHICKEN_MODE);\n\n\t \n\twa_write_clr(wal, GEN7_L3SQCREG4, L3SQ_URB_READ_CAM_MATCH_DISABLE);\n}\n\nstatic void\nvlv_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\t \n\twa_write_clr(wal, GEN7_L3SQCREG4, L3SQ_URB_READ_CAM_MATCH_DISABLE);\n\n\t \n\twa_write(wal, GEN7_L3SQCREG1, VLV_B0_WA_L3SQCREG1_VALUE);\n}\n\nstatic void\nhsw_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\t \n\twa_write(wal, HSW_SCRATCH1, HSW_SCRATCH1_L3_DATA_ATOMICS_DISABLE);\n\n\twa_add(wal,\n\t       HSW_ROW_CHICKEN3, 0,\n\t       _MASKED_BIT_ENABLE(HSW_ROW_CHICKEN3_L3_GLOBAL_ATOMICS_DISABLE),\n\t       0  , true);\n\n\t \n\twa_write_clr(wal, GEN7_FF_THREAD_MODE, GEN7_FF_VS_REF_CNT_FFME);\n}\n\nstatic void\ngen9_wa_init_mcr(struct drm_i915_private *i915, struct i915_wa_list *wal)\n{\n\tconst struct sseu_dev_info *sseu = &to_gt(i915)->info.sseu;\n\tunsigned int slice, subslice;\n\tu32 mcr, mcr_mask;\n\n\tGEM_BUG_ON(GRAPHICS_VER(i915) != 9);\n\n\t \n\tslice = ffs(sseu->slice_mask) - 1;\n\tGEM_BUG_ON(slice >= ARRAY_SIZE(sseu->subslice_mask.hsw));\n\tsubslice = ffs(intel_sseu_get_hsw_subslices(sseu, slice));\n\tGEM_BUG_ON(!subslice);\n\tsubslice--;\n\n\t \n\tmcr = GEN8_MCR_SLICE(slice) | GEN8_MCR_SUBSLICE(subslice);\n\tmcr_mask = GEN8_MCR_SLICE_MASK | GEN8_MCR_SUBSLICE_MASK;\n\n\tdrm_dbg(&i915->drm, \"MCR slice:%d/subslice:%d = %x\\n\", slice, subslice, mcr);\n\n\twa_write_clr_set(wal, GEN8_MCR_SELECTOR, mcr_mask, mcr);\n}\n\nstatic void\ngen9_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = gt->i915;\n\n\t \n\tgen9_wa_init_mcr(i915, wal);\n\n\t \n\tif (!IS_COFFEELAKE(i915) && !IS_COMETLAKE(i915))\n\t\twa_write_or(wal,\n\t\t\t    GAM_ECOCHK,\n\t\t\t    ECOCHK_DIS_TLB);\n\n\tif (HAS_LLC(i915)) {\n\t\t \n\t\twa_write_or(wal,\n\t\t\t    MMCD_MISC_CTRL,\n\t\t\t    MMCD_PCLA | MMCD_HOTSPOT_EN);\n\t}\n\n\t \n\twa_write_or(wal,\n\t\t    GAM_ECOCHK,\n\t\t    BDW_DISABLE_HDC_INVALIDATION);\n}\n\nstatic void\nskl_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tgen9_gt_workarounds_init(gt, wal);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN7_UCGCTL4,\n\t\t    GEN8_EU_GAUNIT_CLOCK_GATE_DISABLE);\n\n\t \n\tif (IS_SKYLAKE(gt->i915) && IS_GRAPHICS_STEP(gt->i915, STEP_A0, STEP_H0))\n\t\twa_write_or(wal,\n\t\t\t    GEN9_GAMT_ECO_REG_RW_IA,\n\t\t\t    GAMT_ECO_ENABLE_IN_PLACE_DECOMPRESS);\n}\n\nstatic void\nkbl_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tgen9_gt_workarounds_init(gt, wal);\n\n\t \n\tif (IS_KABYLAKE(gt->i915) && IS_GRAPHICS_STEP(gt->i915, 0, STEP_C0))\n\t\twa_write_or(wal,\n\t\t\t    GAMT_CHKN_BIT_REG,\n\t\t\t    GAMT_CHKN_DISABLE_DYNAMIC_CREDIT_SHARING);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN7_UCGCTL4,\n\t\t    GEN8_EU_GAUNIT_CLOCK_GATE_DISABLE);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN9_GAMT_ECO_REG_RW_IA,\n\t\t    GAMT_ECO_ENABLE_IN_PLACE_DECOMPRESS);\n}\n\nstatic void\nglk_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tgen9_gt_workarounds_init(gt, wal);\n}\n\nstatic void\ncfl_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tgen9_gt_workarounds_init(gt, wal);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN7_UCGCTL4,\n\t\t    GEN8_EU_GAUNIT_CLOCK_GATE_DISABLE);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN9_GAMT_ECO_REG_RW_IA,\n\t\t    GAMT_ECO_ENABLE_IN_PLACE_DECOMPRESS);\n}\n\nstatic void __set_mcr_steering(struct i915_wa_list *wal,\n\t\t\t       i915_reg_t steering_reg,\n\t\t\t       unsigned int slice, unsigned int subslice)\n{\n\tu32 mcr, mcr_mask;\n\n\tmcr = GEN11_MCR_SLICE(slice) | GEN11_MCR_SUBSLICE(subslice);\n\tmcr_mask = GEN11_MCR_SLICE_MASK | GEN11_MCR_SUBSLICE_MASK;\n\n\twa_write_clr_set(wal, steering_reg, mcr_mask, mcr);\n}\n\nstatic void debug_dump_steering(struct intel_gt *gt)\n{\n\tstruct drm_printer p = drm_debug_printer(\"MCR Steering:\");\n\n\tif (drm_debug_enabled(DRM_UT_DRIVER))\n\t\tintel_gt_mcr_report_steering(&p, gt, false);\n}\n\nstatic void __add_mcr_wa(struct intel_gt *gt, struct i915_wa_list *wal,\n\t\t\t unsigned int slice, unsigned int subslice)\n{\n\t__set_mcr_steering(wal, GEN8_MCR_SELECTOR, slice, subslice);\n\n\tgt->default_steering.groupid = slice;\n\tgt->default_steering.instanceid = subslice;\n\n\tdebug_dump_steering(gt);\n}\n\nstatic void\nicl_wa_init_mcr(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tconst struct sseu_dev_info *sseu = &gt->info.sseu;\n\tunsigned int subslice;\n\n\tGEM_BUG_ON(GRAPHICS_VER(gt->i915) < 11);\n\tGEM_BUG_ON(hweight8(sseu->slice_mask) > 1);\n\n\t \n\tsubslice = __ffs(intel_sseu_get_hsw_subslices(sseu, 0));\n\n\t \n\tif (gt->info.l3bank_mask & BIT(subslice))\n\t\tgt->steering_table[L3BANK] = NULL;\n\n\t__add_mcr_wa(gt, wal, 0, subslice);\n}\n\nstatic void\nxehp_init_mcr(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tconst struct sseu_dev_info *sseu = &gt->info.sseu;\n\tunsigned long slice, subslice = 0, slice_mask = 0;\n\tu32 lncf_mask = 0;\n\tint i;\n\n\t \n\n\t \n\tslice_mask = intel_slicemask_from_xehp_dssmask(sseu->subslice_mask,\n\t\t\t\t\t\t       GEN_DSS_PER_GSLICE);\n\n\t \n\tfor_each_set_bit(i, &gt->info.mslice_mask, GEN12_MAX_MSLICES)\n\t\tlncf_mask |= (0x3 << (i * 2));\n\n\t \n\tif (slice_mask & lncf_mask) {\n\t\tslice_mask &= lncf_mask;\n\t\tgt->steering_table[LNCF] = NULL;\n\t}\n\n\t \n\tif (slice_mask & gt->info.mslice_mask) {\n\t\tslice_mask &= gt->info.mslice_mask;\n\t\tgt->steering_table[MSLICE] = NULL;\n\t}\n\n\tif (IS_XEHPSDV(gt->i915) && slice_mask & BIT(0))\n\t\tgt->steering_table[GAM] = NULL;\n\n\tslice = __ffs(slice_mask);\n\tsubslice = intel_sseu_find_first_xehp_dss(sseu, GEN_DSS_PER_GSLICE, slice) %\n\t\tGEN_DSS_PER_GSLICE;\n\n\t__add_mcr_wa(gt, wal, slice, subslice);\n\n\t \n\t__set_mcr_steering(wal, MCFG_MCR_SELECTOR, 0, 2);\n\t__set_mcr_steering(wal, SF_MCR_SELECTOR, 0, 2);\n\n\t \n\tif (IS_DG2(gt->i915))\n\t\t__set_mcr_steering(wal, GAM_MCR_SELECTOR, 1, 0);\n}\n\nstatic void\npvc_init_mcr(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tunsigned int dss;\n\n\t \n\tdss = intel_sseu_find_first_xehp_dss(&gt->info.sseu, 0, 0);\n\t__add_mcr_wa(gt, wal, dss / GEN_DSS_PER_CSLICE, dss % GEN_DSS_PER_CSLICE);\n}\n\nstatic void\nicl_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = gt->i915;\n\n\ticl_wa_init_mcr(gt, wal);\n\n\t \n\twa_write_clr_set(wal,\n\t\t\t GEN11_GACB_PERF_CTRL,\n\t\t\t GEN11_HASH_CTRL_MASK,\n\t\t\t GEN11_HASH_CTRL_BIT0 | GEN11_HASH_CTRL_BIT4);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN11_LSN_UNSLCVC,\n\t\t    GEN11_LSN_UNSLCVC_GAFS_HALF_SF_MAXALLOC |\n\t\t    GEN11_LSN_UNSLCVC_GAFS_HALF_CL2_MAXALLOC);\n\n\t \n\twa_write_or(wal,\n\t\t    GEN8_GAMW_ECO_DEV_RW_IA,\n\t\t    GAMW_ECO_DEV_CTX_RELOAD_DISABLE);\n\n\t \n\twa_write_or(wal,\n\t\t    GAMT_CHKN_BIT_REG,\n\t\t    GAMT_CHKN_DISABLE_L3_COH_PIPE);\n\n\t \n\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE,\n\t\t    VSUNIT_CLKGATE_DIS | HSUNIT_CLKGATE_DIS);\n\n\t \n\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE2,\n\t\t    PSDUNIT_CLKGATE_DIS);\n\n\t \n\twa_mcr_write_or(wal,\n\t\t\tGEN11_SUBSLICE_UNIT_LEVEL_CLKGATE,\n\t\t\tGWUNIT_CLKGATE_DIS);\n\n\t \n\tif (IS_ICELAKE(i915) ||\n\t\t((IS_JASPERLAKE(i915) || IS_ELKHARTLAKE(i915)) &&\n\t\tIS_GRAPHICS_STEP(i915, STEP_A0, STEP_B0)))\n\t\twa_write_or(wal,\n\t\t\t    GEN11_SLICE_UNIT_LEVEL_CLKGATE,\n\t\t\t    L3_CLKGATE_DIS | L3_CR2X_CLKGATE_DIS);\n\n\t \n\twa_mcr_write_clr(wal, GEN10_DFR_RATIO_EN_AND_CHICKEN, DFR_DISABLE);\n}\n\n \nstatic void\nwa_14011060649(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tstruct intel_engine_cs *engine;\n\tint id;\n\n\tfor_each_engine(engine, gt, id) {\n\t\tif (engine->class != VIDEO_DECODE_CLASS ||\n\t\t    (engine->instance % 2))\n\t\t\tcontinue;\n\n\t\twa_write_or(wal, VDBOX_CGCTL3F10(engine->mmio_base),\n\t\t\t    IECPUNIT_CLKGATE_DIS);\n\t}\n}\n\nstatic void\ngen12_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\ticl_wa_init_mcr(gt, wal);\n\n\t \n\twa_14011060649(gt, wal);\n\n\t \n\twa_mcr_write_or(wal, GEN10_DFR_RATIO_EN_AND_CHICKEN, DFR_DISABLE);\n\n\t \n\twa_add(wal, GEN7_MISCCPCTL, GEN12_DOP_CLOCK_GATE_RENDER_ENABLE,\n\t       0, 0, false);\n}\n\nstatic void\ndg1_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tgen12_gt_workarounds_init(gt, wal);\n\n\t \n\twa_mcr_write_or(wal, SUBSLICE_UNIT_LEVEL_CLKGATE2,\n\t\t\tCPSSUNIT_CLKGATE_DIS);\n\n\t \n\t \n\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE2, VSUNIT_CLKGATE_DIS_TGL);\n}\n\nstatic void\nxehpsdv_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = gt->i915;\n\n\txehp_init_mcr(gt, wal);\n\n\t \n\twa_mcr_write_or(wal, SCCGCTL94DC, CG3DDISURB);\n\n\t \n\tif (IS_XEHPSDV_GRAPHICS_STEP(i915, STEP_A1, STEP_B0)) {\n\t\twa_mcr_masked_dis(wal, MLTICTXCTL, TDONRENDER);\n\t\twa_mcr_write_or(wal, L3SQCREG1_CCS0, FLUSHALLNONCOH);\n\t}\n\n\t \n\tif (IS_XEHPSDV_GRAPHICS_STEP(i915, STEP_A0, STEP_B0))\n\t\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE,\n\t\t\t    TSGUNIT_CLKGATE_DIS);\n\n\t \n\tif (IS_XEHPSDV_GRAPHICS_STEP(i915, STEP_B0, STEP_FOREVER)) {\n\t\twa_write_or(wal, UNSLCGCTL9440, GAMTLBOACS_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX7_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX6_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX5_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX4_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX3_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX2_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX1_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX0_CLKGATE_DIS |\n\t\t\t    GAMTLBKCR_CLKGATE_DIS |\n\t\t\t    GAMTLBGUC_CLKGATE_DIS |\n\t\t\t    GAMTLBBLT_CLKGATE_DIS);\n\t\twa_write_or(wal, UNSLCGCTL9444, GAMTLBGFXA0_CLKGATE_DIS |\n\t\t\t    GAMTLBGFXA1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPA0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPA1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPB0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPB1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPC0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPC1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPD0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPD1_CLKGATE_DIS |\n\t\t\t    GAMTLBMERT_CLKGATE_DIS   |\n\t\t\t    GAMTLBVEBOX3_CLKGATE_DIS |\n\t\t\t    GAMTLBVEBOX2_CLKGATE_DIS |\n\t\t\t    GAMTLBVEBOX1_CLKGATE_DIS |\n\t\t\t    GAMTLBVEBOX0_CLKGATE_DIS);\n\t}\n\n\t \n\tif (IS_XEHPSDV_GRAPHICS_STEP(i915, STEP_A1, STEP_FOREVER))\n\t\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE, VFUNIT_CLKGATE_DIS);\n\n\t \n\twa_14011060649(gt, wal);\n\n\t \n\twa_mcr_write_or(wal, XEHP_MERT_MOD_CTRL, FORCE_MISS_FTLB);\n\n\t \n\twa_mcr_write_or(wal, XEHP_GAMCNTRL_CTRL,\n\t\t\tINVALIDATION_BROADCAST_MODE_DIS | GLOBAL_INVALIDATION_MODE);\n\n\t \n\twa_mcr_write_or(wal, XEHP_L3NODEARBCFG, XEHP_LNESPARE);\n}\n\nstatic void\ndg2_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tstruct intel_engine_cs *engine;\n\tint id;\n\n\txehp_init_mcr(gt, wal);\n\n\t \n\twa_14011060649(gt, wal);\n\n\t \n\tfor_each_engine(engine, gt, id) {\n\t\tif (engine->class != VIDEO_DECODE_CLASS)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (IS_DG2_GRAPHICS_STEP(gt->i915, G10, STEP_A0, STEP_B0))\n\t\t\twa_write_or(wal, VDBOX_CGCTL3F18(engine->mmio_base),\n\t\t\t\t    ALNUNIT_CLKGATE_DIS);\n\t}\n\n\tif (IS_DG2_G10(gt->i915)) {\n\t\t \n\t\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE,\n\t\t\t    CG3DDISCFEG_CLKGATE_DIS);\n\n\t\t \n\t\twa_mcr_write_or(wal, GEN11_SUBSLICE_UNIT_LEVEL_CLKGATE,\n\t\t\t\tDSS_ROUTER_CLKGATE_DIS);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(gt->i915, G10, STEP_A0, STEP_B0) ||\n\t    IS_DG2_GRAPHICS_STEP(gt->i915, G11, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_write_or(wal, XEHP_MERT_MOD_CTRL, FORCE_MISS_FTLB);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(gt->i915, G10, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_write_or(wal, UNSLCGCTL9430, MSQDUNIT_CLKGATE_DIS);\n\n\t\t \n\t\twa_write_or(wal, UNSLCGCTL9444, LTCDD_CLKGATE_DIS);\n\n\t\t \n\t\twa_mcr_write_or(wal, XEHP_SLICE_UNIT_LEVEL_CLKGATE, NODEDSS_CLKGATE_DIS);\n\n\t\t \n\t\twa_write_or(wal, UNSLCGCTL9440, GAMTLBOACS_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX7_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX6_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX5_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX4_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX3_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX2_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX1_CLKGATE_DIS |\n\t\t\t    GAMTLBVDBOX0_CLKGATE_DIS |\n\t\t\t    GAMTLBKCR_CLKGATE_DIS |\n\t\t\t    GAMTLBGUC_CLKGATE_DIS |\n\t\t\t    GAMTLBBLT_CLKGATE_DIS);\n\t\twa_write_or(wal, UNSLCGCTL9444, GAMTLBGFXA0_CLKGATE_DIS |\n\t\t\t    GAMTLBGFXA1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPA0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPA1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPB0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPB1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPC0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPC1_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPD0_CLKGATE_DIS |\n\t\t\t    GAMTLBCOMPD1_CLKGATE_DIS |\n\t\t\t    GAMTLBMERT_CLKGATE_DIS   |\n\t\t\t    GAMTLBVEBOX3_CLKGATE_DIS |\n\t\t\t    GAMTLBVEBOX2_CLKGATE_DIS |\n\t\t\t    GAMTLBVEBOX1_CLKGATE_DIS |\n\t\t\t    GAMTLBVEBOX0_CLKGATE_DIS);\n\n\t\t \n\t\twa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE,\n\t\t\t    GAMEDIA_CLKGATE_DIS);\n\n\t\t \n\t\twa_mcr_write_or(wal, SSMCGCTL9530, RTFUNIT_CLKGATE_DIS);\n\n\t\t \n\t\twa_mcr_write_or(wal, XEHP_GAMSTLB_CTRL,\n\t\t\t\tCONTROL_BLOCK_CLKGATE_DIS |\n\t\t\t\tEGRESS_BLOCK_CLKGATE_DIS |\n\t\t\t\tTAG_BLOCK_CLKGATE_DIS);\n\t}\n\n\t \n\twa_mcr_write_clr(wal, SARB_CHICKEN1, COMP_CKN_IN);\n\n\t \n\twa_write_clr(wal, GEN7_MISCCPCTL, GEN12_DOP_CLOCK_GATE_RENDER_ENABLE);\n\n\t \n\twa_mcr_write_or(wal, RENDER_MOD_CTRL, FORCE_MISS_FTLB);\n\twa_mcr_write_or(wal, COMP_MOD_CTRL, FORCE_MISS_FTLB);\n\twa_mcr_write_or(wal, XEHP_VDBX_MOD_CTRL, FORCE_MISS_FTLB);\n\twa_mcr_write_or(wal, XEHP_VEBX_MOD_CTRL, FORCE_MISS_FTLB);\n\n\t \n\twa_mcr_write_or(wal, XEHP_GAMCNTRL_CTRL,\n\t\t\tINVALIDATION_BROADCAST_MODE_DIS | GLOBAL_INVALIDATION_MODE);\n\n\t \n\twa_mcr_write_or(wal, XEHP_L3NODEARBCFG, XEHP_LNESPARE);\n}\n\nstatic void\npvc_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tpvc_init_mcr(gt, wal);\n\n\t \n\twa_write_clr(wal, GEN7_MISCCPCTL, GEN12_DOP_CLOCK_GATE_RENDER_ENABLE);\n\n\t \n\twa_mcr_write_or(wal, RENDER_MOD_CTRL, FORCE_MISS_FTLB);\n\twa_mcr_write_or(wal, COMP_MOD_CTRL, FORCE_MISS_FTLB);\n\twa_mcr_write_or(wal, XEHP_VDBX_MOD_CTRL, FORCE_MISS_FTLB);\n\twa_mcr_write_or(wal, XEHP_VEBX_MOD_CTRL, FORCE_MISS_FTLB);\n\n\t \n\twa_mcr_masked_en(wal, XEHPC_LNCFMISCCFGREG0, XEHPC_OVRLSCCC);\n}\n\nstatic void\nxelpg_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\t \n\twa_mcr_write_or(wal, COMP_MOD_CTRL, FORCE_MISS_FTLB);\n\n\t \n\twa_write_or(wal, GEN12_SQCNT1, GEN12_STRICT_RAR_ENABLE);\n\n\tif (IS_MTL_GRAPHICS_STEP(gt->i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(gt->i915, P, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_write_clr(wal, SARB_CHICKEN1, COMP_CKN_IN);\n\n\t\t \n\t\twa_write_clr(wal, GEN7_MISCCPCTL, GEN12_DOP_CLOCK_GATE_RENDER_ENABLE);\n\t}\n\n\t \n\tdebug_dump_steering(gt);\n}\n\nstatic void\nxelpmp_gt_workarounds_init(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\t \n\twa_write_or(wal, XELPMP_GSC_MOD_CTRL, FORCE_MISS_FTLB);\n\n\tdebug_dump_steering(gt);\n}\n\n \nstatic void gt_tuning_settings(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tif (IS_METEORLAKE(gt->i915)) {\n\t\tif (gt->type != GT_MEDIA)\n\t\t\twa_mcr_write_or(wal, XEHP_L3SCQREG7, BLEND_FILL_CACHING_OPT_DIS);\n\n\t\twa_mcr_write_or(wal, XEHP_SQCM, EN_32B_ACCESS);\n\t}\n\n\tif (IS_PONTEVECCHIO(gt->i915)) {\n\t\twa_mcr_write(wal, XEHPC_L3SCRUB,\n\t\t\t     SCRUB_CL_DWNGRADE_SHARED | SCRUB_RATE_4B_PER_CLK);\n\t\twa_mcr_masked_en(wal, XEHPC_LNCFMISCCFGREG0, XEHPC_HOSTCACHEEN);\n\t}\n\n\tif (IS_DG2(gt->i915)) {\n\t\twa_mcr_write_or(wal, XEHP_L3SCQREG7, BLEND_FILL_CACHING_OPT_DIS);\n\t\twa_mcr_write_or(wal, XEHP_SQCM, EN_32B_ACCESS);\n\t}\n}\n\nstatic void\ngt_init_workarounds(struct intel_gt *gt, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = gt->i915;\n\n\tgt_tuning_settings(gt, wal);\n\n\tif (gt->type == GT_MEDIA) {\n\t\tif (MEDIA_VER(i915) >= 13)\n\t\t\txelpmp_gt_workarounds_init(gt, wal);\n\t\telse\n\t\t\tMISSING_CASE(MEDIA_VER(i915));\n\n\t\treturn;\n\t}\n\n\tif (GRAPHICS_VER_FULL(i915) >= IP_VER(12, 70))\n\t\txelpg_gt_workarounds_init(gt, wal);\n\telse if (IS_PONTEVECCHIO(i915))\n\t\tpvc_gt_workarounds_init(gt, wal);\n\telse if (IS_DG2(i915))\n\t\tdg2_gt_workarounds_init(gt, wal);\n\telse if (IS_XEHPSDV(i915))\n\t\txehpsdv_gt_workarounds_init(gt, wal);\n\telse if (IS_DG1(i915))\n\t\tdg1_gt_workarounds_init(gt, wal);\n\telse if (GRAPHICS_VER(i915) == 12)\n\t\tgen12_gt_workarounds_init(gt, wal);\n\telse if (GRAPHICS_VER(i915) == 11)\n\t\ticl_gt_workarounds_init(gt, wal);\n\telse if (IS_COFFEELAKE(i915) || IS_COMETLAKE(i915))\n\t\tcfl_gt_workarounds_init(gt, wal);\n\telse if (IS_GEMINILAKE(i915))\n\t\tglk_gt_workarounds_init(gt, wal);\n\telse if (IS_KABYLAKE(i915))\n\t\tkbl_gt_workarounds_init(gt, wal);\n\telse if (IS_BROXTON(i915))\n\t\tgen9_gt_workarounds_init(gt, wal);\n\telse if (IS_SKYLAKE(i915))\n\t\tskl_gt_workarounds_init(gt, wal);\n\telse if (IS_HASWELL(i915))\n\t\thsw_gt_workarounds_init(gt, wal);\n\telse if (IS_VALLEYVIEW(i915))\n\t\tvlv_gt_workarounds_init(gt, wal);\n\telse if (IS_IVYBRIDGE(i915))\n\t\tivb_gt_workarounds_init(gt, wal);\n\telse if (GRAPHICS_VER(i915) == 6)\n\t\tsnb_gt_workarounds_init(gt, wal);\n\telse if (GRAPHICS_VER(i915) == 5)\n\t\tilk_gt_workarounds_init(gt, wal);\n\telse if (IS_G4X(i915))\n\t\tg4x_gt_workarounds_init(gt, wal);\n\telse if (GRAPHICS_VER(i915) == 4)\n\t\tgen4_gt_workarounds_init(gt, wal);\n\telse if (GRAPHICS_VER(i915) <= 8)\n\t\t;\n\telse\n\t\tMISSING_CASE(GRAPHICS_VER(i915));\n}\n\nvoid intel_gt_init_workarounds(struct intel_gt *gt)\n{\n\tstruct i915_wa_list *wal = &gt->wa_list;\n\n\twa_init_start(wal, gt, \"GT\", \"global\");\n\tgt_init_workarounds(gt, wal);\n\twa_init_finish(wal);\n}\n\nstatic bool\nwa_verify(struct intel_gt *gt, const struct i915_wa *wa, u32 cur,\n\t  const char *name, const char *from)\n{\n\tif ((cur ^ wa->set) & wa->read) {\n\t\tdrm_err(&gt->i915->drm,\n\t\t\t\"%s workaround lost on %s! (reg[%x]=0x%x, relevant bits were 0x%x vs expected 0x%x)\\n\",\n\t\t\tname, from, i915_mmio_reg_offset(wa->reg),\n\t\t\tcur, cur & wa->read, wa->set & wa->read);\n\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void wa_list_apply(const struct i915_wa_list *wal)\n{\n\tstruct intel_gt *gt = wal->gt;\n\tstruct intel_uncore *uncore = gt->uncore;\n\tenum forcewake_domains fw;\n\tunsigned long flags;\n\tstruct i915_wa *wa;\n\tunsigned int i;\n\n\tif (!wal->count)\n\t\treturn;\n\n\tfw = wal_get_fw_for_rmw(uncore, wal);\n\n\tintel_gt_mcr_lock(gt, &flags);\n\tspin_lock(&uncore->lock);\n\tintel_uncore_forcewake_get__locked(uncore, fw);\n\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++) {\n\t\tu32 val, old = 0;\n\n\t\t \n\t\tif (wa->clr)\n\t\t\told = wa->is_mcr ?\n\t\t\t\tintel_gt_mcr_read_any_fw(gt, wa->mcr_reg) :\n\t\t\t\tintel_uncore_read_fw(uncore, wa->reg);\n\t\tval = (old & ~wa->clr) | wa->set;\n\t\tif (val != old || !wa->clr) {\n\t\t\tif (wa->is_mcr)\n\t\t\t\tintel_gt_mcr_multicast_write_fw(gt, wa->mcr_reg, val);\n\t\t\telse\n\t\t\t\tintel_uncore_write_fw(uncore, wa->reg, val);\n\t\t}\n\n\t\tif (IS_ENABLED(CONFIG_DRM_I915_DEBUG_GEM)) {\n\t\t\tu32 val = wa->is_mcr ?\n\t\t\t\tintel_gt_mcr_read_any_fw(gt, wa->mcr_reg) :\n\t\t\t\tintel_uncore_read_fw(uncore, wa->reg);\n\n\t\t\twa_verify(gt, wa, val, wal->name, \"application\");\n\t\t}\n\t}\n\n\tintel_uncore_forcewake_put__locked(uncore, fw);\n\tspin_unlock(&uncore->lock);\n\tintel_gt_mcr_unlock(gt, flags);\n}\n\nvoid intel_gt_apply_workarounds(struct intel_gt *gt)\n{\n\twa_list_apply(&gt->wa_list);\n}\n\nstatic bool wa_list_verify(struct intel_gt *gt,\n\t\t\t   const struct i915_wa_list *wal,\n\t\t\t   const char *from)\n{\n\tstruct intel_uncore *uncore = gt->uncore;\n\tstruct i915_wa *wa;\n\tenum forcewake_domains fw;\n\tunsigned long flags;\n\tunsigned int i;\n\tbool ok = true;\n\n\tfw = wal_get_fw_for_rmw(uncore, wal);\n\n\tintel_gt_mcr_lock(gt, &flags);\n\tspin_lock(&uncore->lock);\n\tintel_uncore_forcewake_get__locked(uncore, fw);\n\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++)\n\t\tok &= wa_verify(wal->gt, wa, wa->is_mcr ?\n\t\t\t\tintel_gt_mcr_read_any_fw(gt, wa->mcr_reg) :\n\t\t\t\tintel_uncore_read_fw(uncore, wa->reg),\n\t\t\t\twal->name, from);\n\n\tintel_uncore_forcewake_put__locked(uncore, fw);\n\tspin_unlock(&uncore->lock);\n\tintel_gt_mcr_unlock(gt, flags);\n\n\treturn ok;\n}\n\nbool intel_gt_verify_workarounds(struct intel_gt *gt, const char *from)\n{\n\treturn wa_list_verify(gt, &gt->wa_list, from);\n}\n\n__maybe_unused\nstatic bool is_nonpriv_flags_valid(u32 flags)\n{\n\t \n\tif (flags & ~RING_FORCE_TO_NONPRIV_MASK_VALID)\n\t\treturn false;\n\n\t \n\tif ((flags & RING_FORCE_TO_NONPRIV_ACCESS_MASK) ==\n\t    RING_FORCE_TO_NONPRIV_ACCESS_INVALID)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic void\nwhitelist_reg_ext(struct i915_wa_list *wal, i915_reg_t reg, u32 flags)\n{\n\tstruct i915_wa wa = {\n\t\t.reg = reg\n\t};\n\n\tif (GEM_DEBUG_WARN_ON(wal->count >= RING_MAX_NONPRIV_SLOTS))\n\t\treturn;\n\n\tif (GEM_DEBUG_WARN_ON(!is_nonpriv_flags_valid(flags)))\n\t\treturn;\n\n\twa.reg.reg |= flags;\n\t_wa_add(wal, &wa);\n}\n\nstatic void\nwhitelist_mcr_reg_ext(struct i915_wa_list *wal, i915_mcr_reg_t reg, u32 flags)\n{\n\tstruct i915_wa wa = {\n\t\t.mcr_reg = reg,\n\t\t.is_mcr = 1,\n\t};\n\n\tif (GEM_DEBUG_WARN_ON(wal->count >= RING_MAX_NONPRIV_SLOTS))\n\t\treturn;\n\n\tif (GEM_DEBUG_WARN_ON(!is_nonpriv_flags_valid(flags)))\n\t\treturn;\n\n\twa.mcr_reg.reg |= flags;\n\t_wa_add(wal, &wa);\n}\n\nstatic void\nwhitelist_reg(struct i915_wa_list *wal, i915_reg_t reg)\n{\n\twhitelist_reg_ext(wal, reg, RING_FORCE_TO_NONPRIV_ACCESS_RW);\n}\n\nstatic void\nwhitelist_mcr_reg(struct i915_wa_list *wal, i915_mcr_reg_t reg)\n{\n\twhitelist_mcr_reg_ext(wal, reg, RING_FORCE_TO_NONPRIV_ACCESS_RW);\n}\n\nstatic void gen9_whitelist_build(struct i915_wa_list *w)\n{\n\t \n\twhitelist_reg(w, GEN9_CTX_PREEMPT_REG);\n\n\t \n\twhitelist_reg(w, GEN8_CS_CHICKEN1);\n\n\t \n\twhitelist_reg(w, GEN8_HDC_CHICKEN1);\n\n\t \n\twhitelist_reg(w, COMMON_SLICE_CHICKEN2);\n}\n\nstatic void skl_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tif (engine->class != RENDER_CLASS)\n\t\treturn;\n\n\tgen9_whitelist_build(w);\n\n\t \n\twhitelist_mcr_reg(w, GEN8_L3SQCREG4);\n}\n\nstatic void bxt_whitelist_build(struct intel_engine_cs *engine)\n{\n\tif (engine->class != RENDER_CLASS)\n\t\treturn;\n\n\tgen9_whitelist_build(&engine->whitelist);\n}\n\nstatic void kbl_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tif (engine->class != RENDER_CLASS)\n\t\treturn;\n\n\tgen9_whitelist_build(w);\n\n\t \n\twhitelist_mcr_reg(w, GEN8_L3SQCREG4);\n}\n\nstatic void glk_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tif (engine->class != RENDER_CLASS)\n\t\treturn;\n\n\tgen9_whitelist_build(w);\n\n\t \n\twhitelist_reg(w, GEN9_SLICE_COMMON_ECO_CHICKEN1);\n}\n\nstatic void cfl_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tif (engine->class != RENDER_CLASS)\n\t\treturn;\n\n\tgen9_whitelist_build(w);\n\n\t \n\twhitelist_reg_ext(w, PS_INVOCATION_COUNT,\n\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD |\n\t\t\t  RING_FORCE_TO_NONPRIV_RANGE_4);\n}\n\nstatic void allow_read_ctx_timestamp(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tif (engine->class != RENDER_CLASS)\n\t\twhitelist_reg_ext(w,\n\t\t\t\t  RING_CTX_TIMESTAMP(engine->mmio_base),\n\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD);\n}\n\nstatic void cml_whitelist_build(struct intel_engine_cs *engine)\n{\n\tallow_read_ctx_timestamp(engine);\n\n\tcfl_whitelist_build(engine);\n}\n\nstatic void icl_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tallow_read_ctx_timestamp(engine);\n\n\tswitch (engine->class) {\n\tcase RENDER_CLASS:\n\t\t \n\t\twhitelist_mcr_reg(w, GEN9_HALF_SLICE_CHICKEN7);\n\n\t\t \n\t\twhitelist_mcr_reg(w, GEN10_SAMPLER_MODE);\n\n\t\t \n\t\twhitelist_reg(w, GEN9_SLICE_COMMON_ECO_CHICKEN1);\n\n\t\t \n\t\twhitelist_reg_ext(w, PS_INVOCATION_COUNT,\n\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD |\n\t\t\t\t  RING_FORCE_TO_NONPRIV_RANGE_4);\n\t\tbreak;\n\n\tcase VIDEO_DECODE_CLASS:\n\t\t \n\t\twhitelist_reg_ext(w, _MMIO(0x2000 + engine->mmio_base),\n\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD);\n\t\t \n\t\twhitelist_reg_ext(w, _MMIO(0x2014 + engine->mmio_base),\n\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD);\n\t\t \n\t\twhitelist_reg_ext(w, _MMIO(0x23B0 + engine->mmio_base),\n\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void tgl_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tallow_read_ctx_timestamp(engine);\n\n\tswitch (engine->class) {\n\tcase RENDER_CLASS:\n\t\t \n\t\twhitelist_reg_ext(w, PS_INVOCATION_COUNT,\n\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD |\n\t\t\t\t  RING_FORCE_TO_NONPRIV_RANGE_4);\n\n\t\t \n\t\twhitelist_reg(w, GEN7_COMMON_SLICE_CHICKEN1);\n\n\t\t \n\t\twhitelist_reg(w, HIZ_CHICKEN);\n\n\t\t \n\t\twhitelist_reg(w, GEN11_COMMON_SLICE_CHICKEN3);\n\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void dg2_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tswitch (engine->class) {\n\tcase RENDER_CLASS:\n\t\t \n\t\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G10, STEP_A0, STEP_B0))\n\t\t\twhitelist_reg_ext(w, PS_INVOCATION_COUNT,\n\t\t\t\t\t  RING_FORCE_TO_NONPRIV_ACCESS_RD |\n\t\t\t\t\t  RING_FORCE_TO_NONPRIV_RANGE_4);\n\n\t\t \n\t\twhitelist_mcr_reg(w, XEHP_COMMON_SLICE_CHICKEN3);\n\n\t\tbreak;\n\tcase COMPUTE_CLASS:\n\t\t \n\t\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G10, STEP_A0, STEP_B0))\n\t\t\twhitelist_reg(w, GEN9_CTX_PREEMPT_REG);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void blacklist_trtt(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\t \n\twhitelist_reg_ext(w, _MMIO(0x4400),\n\t\t\t  RING_FORCE_TO_NONPRIV_DENY |\n\t\t\t  RING_FORCE_TO_NONPRIV_RANGE_64);\n\twhitelist_reg_ext(w, _MMIO(0x4500),\n\t\t\t  RING_FORCE_TO_NONPRIV_DENY |\n\t\t\t  RING_FORCE_TO_NONPRIV_RANGE_64);\n}\n\nstatic void pvc_whitelist_build(struct intel_engine_cs *engine)\n{\n\t \n\tblacklist_trtt(engine);\n}\n\nstatic void mtl_whitelist_build(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\tswitch (engine->class) {\n\tcase RENDER_CLASS:\n\t\t \n\t\twhitelist_mcr_reg(w, XEHP_COMMON_SLICE_CHICKEN3);\n\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nvoid intel_engine_init_whitelist(struct intel_engine_cs *engine)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\tstruct i915_wa_list *w = &engine->whitelist;\n\n\twa_init_start(w, engine->gt, \"whitelist\", engine->name);\n\n\tif (IS_METEORLAKE(i915))\n\t\tmtl_whitelist_build(engine);\n\telse if (IS_PONTEVECCHIO(i915))\n\t\tpvc_whitelist_build(engine);\n\telse if (IS_DG2(i915))\n\t\tdg2_whitelist_build(engine);\n\telse if (IS_XEHPSDV(i915))\n\t\t;  \n\telse if (GRAPHICS_VER(i915) == 12)\n\t\ttgl_whitelist_build(engine);\n\telse if (GRAPHICS_VER(i915) == 11)\n\t\ticl_whitelist_build(engine);\n\telse if (IS_COMETLAKE(i915))\n\t\tcml_whitelist_build(engine);\n\telse if (IS_COFFEELAKE(i915))\n\t\tcfl_whitelist_build(engine);\n\telse if (IS_GEMINILAKE(i915))\n\t\tglk_whitelist_build(engine);\n\telse if (IS_KABYLAKE(i915))\n\t\tkbl_whitelist_build(engine);\n\telse if (IS_BROXTON(i915))\n\t\tbxt_whitelist_build(engine);\n\telse if (IS_SKYLAKE(i915))\n\t\tskl_whitelist_build(engine);\n\telse if (GRAPHICS_VER(i915) <= 8)\n\t\t;\n\telse\n\t\tMISSING_CASE(GRAPHICS_VER(i915));\n\n\twa_init_finish(w);\n}\n\nvoid intel_engine_apply_whitelist(struct intel_engine_cs *engine)\n{\n\tconst struct i915_wa_list *wal = &engine->whitelist;\n\tstruct intel_uncore *uncore = engine->uncore;\n\tconst u32 base = engine->mmio_base;\n\tstruct i915_wa *wa;\n\tunsigned int i;\n\n\tif (!wal->count)\n\t\treturn;\n\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++)\n\t\tintel_uncore_write(uncore,\n\t\t\t\t   RING_FORCE_TO_NONPRIV(base, i),\n\t\t\t\t   i915_mmio_reg_offset(wa->reg));\n\n\t \n\tfor (; i < RING_MAX_NONPRIV_SLOTS; i++)\n\t\tintel_uncore_write(uncore,\n\t\t\t\t   RING_FORCE_TO_NONPRIV(base, i),\n\t\t\t\t   i915_mmio_reg_offset(RING_NOPID(base)));\n}\n\n \nstatic void\nengine_fake_wa_init(struct intel_engine_cs *engine, struct i915_wa_list *wal)\n{\n\tu8 mocs_w, mocs_r;\n\n\t \n\tif (GRAPHICS_VER(engine->i915) >= 12) {\n\t\tmocs_r = engine->gt->mocs.uc_index;\n\t\tmocs_w = engine->gt->mocs.uc_index;\n\n\t\tif (HAS_L3_CCS_READ(engine->i915) &&\n\t\t    engine->class == COMPUTE_CLASS) {\n\t\t\tmocs_r = engine->gt->mocs.wb_index;\n\n\t\t\t \n\t\t\tdrm_WARN_ON(&engine->i915->drm, mocs_r == 0);\n\t\t}\n\n\t\twa_masked_field_set(wal,\n\t\t\t\t    RING_CMD_CCTL(engine->mmio_base),\n\t\t\t\t    CMD_CCTL_MOCS_MASK,\n\t\t\t\t    CMD_CCTL_MOCS_OVERRIDE(mocs_w, mocs_r));\n\t}\n}\n\nstatic bool needs_wa_1308578152(struct intel_engine_cs *engine)\n{\n\treturn intel_sseu_find_first_xehp_dss(&engine->gt->info.sseu, 0, 0) >=\n\t\tGEN_DSS_PER_GSLICE;\n}\n\nstatic void\nrcs_engine_wa_init(struct intel_engine_cs *engine, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN10_CACHE_MODE_SS,\n\t\t\t\t ENABLE_EU_COUNT_FOR_TDL_FLUSH);\n\t}\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0) ||\n\t    IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_FOREVER) ||\n\t    IS_DG2_G11(i915) || IS_DG2_G12(i915)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN10_SAMPLER_MODE,\n\t\t\t\t SC_DISABLE_POWER_OPTIMIZATION_EBB);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_FOREVER) ||\n\t    IS_DG2_G11(i915) || IS_DG2_G12(i915) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN2,\n\t\t\t\t GEN12_DISABLE_READ_SUPPRESSION);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G11, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN2, GEN12_ENABLE_LARGE_GRF_MODE);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_A0, STEP_B0) ||\n\t    IS_DG2_GRAPHICS_STEP(i915, G11, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN9_ROW_CHICKEN4,\n\t\t\t\t GEN12_DISABLE_HDR_PAST_PAYLOAD_HOLD_FIX);\n\t}\n\n\t \n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_C0) &&\n\t    needs_wa_1308578152(engine)) {\n\t\twa_masked_dis(wal, GEN12_CS_DEBUG_MODE1_CCCSUNIT_BE_COMMON,\n\t\t\t      GEN12_REPLAY_MODE_GRANULARITY);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_FOREVER) ||\n\t    IS_DG2_G11(i915) || IS_DG2_G12(i915)) {\n\t\t \n\t\twa_mcr_masked_dis(wal, XEHP_HDC_CHICKEN0,\n\t\t\t\t  LSC_L1_FLUSH_CTL_3D_DATAPORT_FLUSH_EVENTS_MASK);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN,\n\t\t\t\t MDQ_ARBITRATION_MODE | UGM_BACKUP_MODE);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_A0, STEP_B0))\n\t\t \n\t\twa_mcr_masked_en(wal,\n\t\t\t\t GEN9_ROW_CHICKEN4,\n\t\t\t\t GEN12_DISABLE_GRF_CLEAR);\n\n\t \n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_C0) ||\n\t    IS_DG2_GRAPHICS_STEP(i915, G11, STEP_A0, STEP_B0))\n\t\twa_mcr_write_or(wal, RT_CTRL, DIS_NULL_QUERY);\n\n\t \n\tif (IS_DG2_GRAPHICS_STEP(engine->i915, G10, STEP_A0, STEP_C0) ||\n\t    IS_DG2_GRAPHICS_STEP(engine->i915, G11, STEP_A0, STEP_B0))\n\t\twa_mcr_masked_en(wal, GEN9_HALF_SLICE_CHICKEN7,\n\t\t\t\t DG2_DISABLE_ROUND_ENABLE_ALLOW_FOR_SSLA);\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G11, STEP_B0, STEP_FOREVER) ||\n\t    IS_DG2_G10(i915)) {\n\t\t \n\t\twa_mcr_add(wal, GEN10_CACHE_MODE_SS, 0,\n\t\t\t   _MASKED_BIT_ENABLE(ENABLE_EU_COUNT_FOR_TDL_FLUSH),\n\t\t\t   0  ,\n\t\t\t   true);\n\t}\n\n\tif (IS_ALDERLAKE_P(i915) || IS_ALDERLAKE_S(i915) || IS_DG1(i915) ||\n\t    IS_ROCKETLAKE(i915) || IS_TIGERLAKE(i915)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN2, GEN12_DISABLE_EARLY_READ);\n\n\t\t \n\t\twa_write_or(wal, GEN7_FF_THREAD_MODE,\n\t\t\t    GEN12_FF_TESSELATION_DOP_GATE_DISABLE);\n\t}\n\n\tif (IS_ALDERLAKE_P(i915) || IS_DG2(i915) || IS_ALDERLAKE_S(i915) ||\n\t    IS_DG1(i915) || IS_ROCKETLAKE(i915) || IS_TIGERLAKE(i915)) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     GEN9_CS_DEBUG_MODE1,\n\t\t\t     FF_DOP_CLOCK_GATE_DISABLE);\n\t}\n\n\tif (IS_ALDERLAKE_P(i915) || IS_ALDERLAKE_S(i915) ||\n\t    IS_ROCKETLAKE(i915) || IS_TIGERLAKE(i915)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN8_ROW_CHICKEN2,\n\t\t\t\t GEN12_PUSH_CONST_DEREF_HOLD_DIS);\n\n\t\t \n\t\twa_mcr_masked_en(wal, GEN9_ROW_CHICKEN4, GEN12_DISABLE_TDL_PUSH);\n\t}\n\n\tif (IS_ROCKETLAKE(i915) || IS_TIGERLAKE(i915) || IS_ALDERLAKE_P(i915)) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     RING_PSMI_CTL(RENDER_RING_BASE),\n\t\t\t     GEN12_WAIT_FOR_EVENT_POWER_DOWN_DISABLE |\n\t\t\t     GEN8_RC_SEMA_IDLE_MSG_DISABLE);\n\t}\n\n\tif (IS_DG1(i915) || IS_ROCKETLAKE(i915) || IS_TIGERLAKE(i915) ||\n\t    IS_ALDERLAKE_S(i915) || IS_ALDERLAKE_P(i915)) {\n\t\t \n\t\twa_mcr_masked_en(wal,\n\t\t\t\t GEN10_SAMPLER_MODE,\n\t\t\t\t ENABLE_SMALLPL);\n\t}\n\n\tif (GRAPHICS_VER(i915) == 11) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     _3D_CHICKEN3,\n\t\t\t     _3D_CHICKEN3_AA_LINE_QUALITY_FIX_ENABLE);\n\n\t\t \n\t\twa_write_or(wal,\n\t\t\t    GEN8_GARBCNTL,\n\t\t\t    GEN11_ARBITRATION_PRIO_ORDER_MASK);\n\n\t\t \n\t\twa_write_clr_set(wal,\n\t\t\t\t GEN8_GARBCNTL,\n\t\t\t\t GEN11_HASH_CTRL_EXCL_MASK,\n\t\t\t\t GEN11_HASH_CTRL_EXCL_BIT0);\n\t\twa_write_clr_set(wal,\n\t\t\t\t GEN11_GLBLINVL,\n\t\t\t\t GEN11_BANK_HASH_ADDR_EXCL_MASK,\n\t\t\t\t GEN11_BANK_HASH_ADDR_EXCL_BIT0);\n\n\t\t \n\t\twa_mcr_write_or(wal,\n\t\t\t\tGEN8_L3SQCREG4,\n\t\t\t\tGEN11_LQSC_CLEAN_EVICT_DISABLE);\n\n\t\t \n\t\twa_write_or(wal,\n\t\t\t    GEN7_SARCHKMD,\n\t\t\t    GEN7_DISABLE_SAMPLER_PREFETCH);\n\n\t\t \n\t\twa_mcr_write_clr_set(wal,\n\t\t\t\t     GEN11_SCRATCH2,\n\t\t\t\t     GEN11_COHERENT_PARTIAL_WRITE_MERGE_ENABLE,\n\t\t\t\t     0);\n\n\t\t \n\t\twa_masked_en(wal, GEN9_CSFE_CHICKEN1_RCS,\n\t\t\t     GEN11_ENABLE_32_PLANE_MODE);\n\n\t\t \n\t\twa_write_or(wal,\n\t\t\t    GEN7_FF_THREAD_MODE,\n\t\t\t    GEN12_FF_TESSELATION_DOP_GATE_DISABLE);\n\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     GEN9_CS_DEBUG_MODE1,\n\t\t\t     FF_DOP_CLOCK_GATE_DISABLE);\n\t}\n\n\t \n\tif (GRAPHICS_VER(i915) >= 9)\n\t\twa_masked_en(wal,\n\t\t\t     GEN7_FF_SLICE_CS_CHICKEN1,\n\t\t\t     GEN9_FFSC_PERCTX_PREEMPT_CTRL);\n\n\tif (IS_SKYLAKE(i915) ||\n\t    IS_KABYLAKE(i915) ||\n\t    IS_COFFEELAKE(i915) ||\n\t    IS_COMETLAKE(i915)) {\n\t\t \n\t\twa_write_or(wal,\n\t\t\t    GEN8_GARBCNTL,\n\t\t\t    GEN9_GAPS_TSV_CREDIT_DISABLE);\n\t}\n\n\tif (IS_BROXTON(i915)) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     FF_SLICE_CS_CHICKEN2,\n\t\t\t     GEN9_POOLED_EU_LOAD_BALANCING_FIX_DISABLE);\n\t}\n\n\tif (GRAPHICS_VER(i915) == 9) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     GEN9_CSFE_CHICKEN1_RCS,\n\t\t\t     GEN9_PREEMPT_GPGPU_SYNC_SWITCH_DISABLE);\n\n\t\t \n\t\twa_mcr_write_or(wal,\n\t\t\t\tBDW_SCRATCH1,\n\t\t\t\tGEN9_LBS_SLA_RETRY_TIMER_DECREMENT_ENABLE);\n\n\t\t \n\t\tif (IS_GEN9_LP(i915))\n\t\t\twa_mcr_write_clr_set(wal,\n\t\t\t\t\t     GEN8_L3SQCREG1,\n\t\t\t\t\t     L3_PRIO_CREDITS_MASK,\n\t\t\t\t\t     L3_GENERAL_PRIO_CREDITS(62) |\n\t\t\t\t\t     L3_HIGH_PRIO_CREDITS(2));\n\n\t\t \n\t\twa_mcr_write_or(wal,\n\t\t\t\tGEN8_L3SQCREG4,\n\t\t\t\tGEN8_LQSC_FLUSH_COHERENT_LINES);\n\n\t\t \n\t\twa_write_clr_set(wal, GEN9_SCRATCH_LNCF1,\n\t\t\t\t GEN9_LNCF_NONIA_COHERENT_ATOMICS_ENABLE, 0);\n\t\twa_mcr_write_clr_set(wal, GEN8_L3SQCREG4,\n\t\t\t\t     GEN8_LQSQ_NONIA_COHERENT_ATOMICS_ENABLE, 0);\n\t\twa_mcr_write_clr_set(wal, GEN9_SCRATCH1,\n\t\t\t\t     EVICTION_PERF_FIX_ENABLE, 0);\n\t}\n\n\tif (IS_HASWELL(i915)) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     HSW_HALF_SLICE_CHICKEN3, HSW_SAMPLE_C_PERFORMANCE);\n\n\t\twa_masked_dis(wal,\n\t\t\t      CACHE_MODE_0_GEN7,\n\t\t\t       \n\t\t\t      HIZ_RAW_STALL_OPT_DISABLE);\n\t}\n\n\tif (IS_VALLEYVIEW(i915)) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     _3D_CHICKEN3,\n\t\t\t     _3D_CHICKEN_SF_DISABLE_OBJEND_CULL);\n\n\t\t \n\t\twa_write_clr_set(wal,\n\t\t\t\t GEN7_FF_THREAD_MODE,\n\t\t\t\t GEN7_FF_SCHED_MASK,\n\t\t\t\t GEN7_FF_TS_SCHED_HW |\n\t\t\t\t GEN7_FF_VS_SCHED_HW |\n\t\t\t\t GEN7_FF_DS_SCHED_HW);\n\n\t\t \n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     GEN7_HALF_SLICE_CHICKEN1,\n\t\t\t     GEN7_MAX_PS_THREAD_DEP |\n\t\t\t     GEN7_PSD_SINGLE_PORT_DISPATCH_ENABLE);\n\t}\n\n\tif (IS_IVYBRIDGE(i915)) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     _3D_CHICKEN3,\n\t\t\t     _3D_CHICKEN_SF_DISABLE_OBJEND_CULL);\n\n\t\tif (0) {  \n\t\t\t \n\t\t\twa_masked_dis(wal,\n\t\t\t\t      CACHE_MODE_0_GEN7,\n\t\t\t\t      HIZ_RAW_STALL_OPT_DISABLE);\n\t\t}\n\n\t\t \n\t\twa_write_clr_set(wal,\n\t\t\t\t GEN7_FF_THREAD_MODE,\n\t\t\t\t GEN7_FF_SCHED_MASK,\n\t\t\t\t GEN7_FF_TS_SCHED_HW |\n\t\t\t\t GEN7_FF_VS_SCHED_HW |\n\t\t\t\t GEN7_FF_DS_SCHED_HW);\n\n\t\t \n\t\tif (IS_IVB_GT1(i915))\n\t\t\twa_masked_en(wal,\n\t\t\t\t     GEN7_HALF_SLICE_CHICKEN1,\n\t\t\t\t     GEN7_PSD_SINGLE_PORT_DISPATCH_ENABLE);\n\t}\n\n\tif (GRAPHICS_VER(i915) == 7) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     RING_MODE_GEN7(RENDER_RING_BASE),\n\t\t\t     GFX_TLB_INVALIDATE_EXPLICIT | GFX_REPLAY_MODE);\n\n\t\t \n\t\twa_masked_dis(wal, CACHE_MODE_0_GEN7, RC_OP_FLUSH_ENABLE);\n\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     CACHE_MODE_1,\n\t\t\t     PIXEL_SUBSPAN_COLLECT_OPT_DISABLE);\n\n\t\t \n\t\twa_masked_field_set(wal,\n\t\t\t\t    GEN7_GT_MODE,\n\t\t\t\t    GEN6_WIZ_HASHING_MASK,\n\t\t\t\t    GEN6_WIZ_HASHING_16x4);\n\t}\n\n\tif (IS_GRAPHICS_VER(i915, 6, 7))\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     RING_MI_MODE(RENDER_RING_BASE),\n\t\t\t     ASYNC_FLIP_PERF_DISABLE);\n\n\tif (GRAPHICS_VER(i915) == 6) {\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     GFX_MODE,\n\t\t\t     GFX_TLB_INVALIDATE_EXPLICIT);\n\n\t\t \n\t\twa_masked_en(wal,\n\t\t\t     _3D_CHICKEN,\n\t\t\t     _3D_CHICKEN_HIZ_PLANE_DISABLE_MSAA_4X_SNB);\n\n\t\twa_masked_en(wal,\n\t\t\t     _3D_CHICKEN3,\n\t\t\t      \n\t\t\t     _3D_CHICKEN3_SF_DISABLE_FASTCLIP_CULL |\n\t\t\t      \n\t\t\t     _3D_CHICKEN3_SF_DISABLE_PIPELINED_ATTR_FETCH);\n\n\t\t \n\t\twa_masked_field_set(wal,\n\t\t\t\t    GEN6_GT_MODE,\n\t\t\t\t    GEN6_WIZ_HASHING_MASK,\n\t\t\t\t    GEN6_WIZ_HASHING_16x4);\n\n\t\t \n\t\twa_masked_dis(wal, CACHE_MODE_0, RC_OP_FLUSH_ENABLE);\n\n\t\t \n\t\twa_masked_dis(wal,\n\t\t\t      CACHE_MODE_0,\n\t\t\t      CM0_STC_EVICT_DISABLE_LRA_SNB);\n\t}\n\n\tif (IS_GRAPHICS_VER(i915, 4, 6))\n\t\t \n\t\twa_add(wal, RING_MI_MODE(RENDER_RING_BASE),\n\t\t       0, _MASKED_BIT_ENABLE(VS_TIMER_DISPATCH),\n\t\t        \n\t\t       IS_I965G(i915) ? 0 : VS_TIMER_DISPATCH, true);\n\n\tif (GRAPHICS_VER(i915) == 4)\n\t\t \n\t\twa_add(wal, ECOSKPD(RENDER_RING_BASE),\n\t\t       0, _MASKED_BIT_ENABLE(ECO_CONSTANT_BUFFER_SR_DISABLE),\n\t\t       0  ,\n\t\t       true);\n}\n\nstatic void\nxcs_engine_wa_init(struct intel_engine_cs *engine, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\t \n\tif (IS_KABYLAKE(i915) && IS_GRAPHICS_STEP(i915, STEP_A0, STEP_F0)) {\n\t\twa_write(wal,\n\t\t\t RING_SEMA_WAIT_POLL(engine->mmio_base),\n\t\t\t 1);\n\t}\n}\n\nstatic void\nccs_engine_wa_init(struct intel_engine_cs *engine, struct i915_wa_list *wal)\n{\n\tif (IS_PVC_CT_STEP(engine->i915, STEP_A0, STEP_C0)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN10_CACHE_MODE_SS, DISABLE_ECC);\n\t}\n}\n\n \nstatic void\nadd_render_compute_tuning_settings(struct drm_i915_private *i915,\n\t\t\t\t   struct i915_wa_list *wal)\n{\n\tif (IS_METEORLAKE(i915) || IS_DG2(i915))\n\t\twa_mcr_write_clr_set(wal, RT_CTRL, STACKID_CTRL, STACKID_CTRL_512);\n\n\t \n\tif (INTEL_INFO(i915)->tuning_thread_rr_after_dep)\n\t\twa_mcr_masked_field_set(wal, GEN9_ROW_CHICKEN4, THREAD_EX_ARB_MODE,\n\t\t\t\t\tTHREAD_EX_ARB_MODE_RR_AFTER_DEP);\n\n\tif (GRAPHICS_VER(i915) == 12 && GRAPHICS_VER_FULL(i915) < IP_VER(12, 50))\n\t\twa_write_clr(wal, GEN8_GARBCNTL, GEN12_BUS_HASH_CTL_BIT_EXC);\n}\n\n \nstatic void\ngeneral_render_compute_wa_init(struct intel_engine_cs *engine, struct i915_wa_list *wal)\n{\n\tstruct drm_i915_private *i915 = engine->i915;\n\n\tadd_render_compute_tuning_settings(i915, wal);\n\n\tif (GRAPHICS_VER(i915) >= 11) {\n\t\t \n\t\twa_mcr_masked_en(wal,\n\t\t\t\t GEN10_SAMPLER_MODE,\n\t\t\t\t GEN11_INDIRECT_STATE_BASE_ADDR_OVERRIDE);\n\t}\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_B0, STEP_FOREVER) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_B0, STEP_FOREVER))\n\t\t \n\t\twa_mcr_masked_en(wal, GEN9_ROW_CHICKEN3, MTL_DISABLE_FIX_FOR_EOT_FLUSH);\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0))\n\t\t \n\t\twa_mcr_masked_en(wal, GEN10_SAMPLER_MODE,\n\t\t\t\t MTL_DISABLE_SAMPLER_SC_OOO);\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0))\n\t\t \n\t\twa_mcr_masked_en(wal, GEN10_CACHE_MODE_SS,\n\t\t\t\t DISABLE_PREFETCH_INTO_IC);\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0) ||\n\t    IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_FOREVER) ||\n\t    IS_DG2_G11(i915) || IS_DG2_G12(i915)) {\n\t\t \n\t\twa_mcr_write_or(wal, LSC_CHICKEN_BIT_0_UDW,\n\t\t\t\tDISABLE_128B_EVICTION_COMMAND_UDW);\n\t}\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0) ||\n\t    IS_PONTEVECCHIO(i915) ||\n\t    IS_DG2(i915)) {\n\t\t \n\t\twa_mcr_write_or(wal, LSC_CHICKEN_BIT_0, DISABLE_D8_D16_COASLESCE);\n\t}\n\n\tif (IS_MTL_GRAPHICS_STEP(i915, M, STEP_A0, STEP_B0) ||\n\t    IS_MTL_GRAPHICS_STEP(i915, P, STEP_A0, STEP_B0) ||\n\t    IS_DG2(i915)) {\n\t\t \n\t\twa_masked_en(wal, VFG_PREEMPTION_CHICKEN, POLYGON_TRIFAN_LINELOOP_DISABLE);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_B0, STEP_C0) ||\n\t    IS_DG2_G11(i915)) {\n\t\t \n\t\twa_mcr_write_clr_set(wal, LSC_CHICKEN_BIT_0_UDW,\n\t\t\t\t     MAXREQS_PER_BANK,\n\t\t\t\t     REG_FIELD_PREP(MAXREQS_PER_BANK, 2));\n\n\t\t \n\t\twa_mcr_write_or(wal, LSC_CHICKEN_BIT_0,\n\t\t\t\tFORCE_1_SUB_MESSAGE_PER_FRAGMENT);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_A0, STEP_B0)) {\n\t\t \n\t\twa_mcr_add(wal, LSC_CHICKEN_BIT_0_UDW, 0,\n\t\t\t   FORCE_SLM_FENCE_SCOPE_TO_TILE | FORCE_UGM_FENCE_SCOPE_TO_TILE,\n\t\t\t   0, false);\n\t}\n\n\tif (IS_XEHPSDV(i915)) {\n\t\t \n\t\twa_mcr_masked_en(wal,\n\t\t\t\t GEN8_ROW_CHICKEN,\n\t\t\t\t SYSTOLIC_DOP_CLOCK_GATING_DIS);\n\n\t\t \n\t\twa_mcr_masked_en(wal,\n\t\t\t\t GEN9_ROW_CHICKEN4,\n\t\t\t\t GEN12_DISABLE_GRF_CLEAR);\n\n\t\t \n\t\twa_mcr_masked_en(wal, GEN8_HALF_SLICE_CHICKEN1,\n\t\t\t\t GEN7_PSD_SINGLE_PORT_DISPATCH_ENABLE);\n\t}\n\n\tif (IS_DG2(i915) || IS_PONTEVECCHIO(i915)) {\n\t\t \n\t\twa_mcr_masked_en(wal, GEN9_ROW_CHICKEN4, XEHP_DIS_BBL_SYSPIPE);\n\n\t\t \n\t\twa_masked_en(wal, FF_SLICE_CS_CHICKEN2, GEN12_PERF_FIX_BALANCING_CFE_DISABLE);\n\t}\n\n\tif (IS_DG2(i915)) {\n\t\t \n\t\twa_mcr_write_or(wal, LSC_CHICKEN_BIT_0_UDW, DIS_CHAIN_2XSIMD8);\n\t}\n\n\tif (IS_DG2_GRAPHICS_STEP(i915, G10, STEP_A0, STEP_C0) || IS_DG2_G11(i915))\n\t\t \n\t\twa_mcr_add(wal, GEN10_CACHE_MODE_SS, 0,\n\t\t\t   _MASKED_BIT_ENABLE(ENABLE_PREFETCH_INTO_IC),\n\t\t\t   0  ,\n\t\t\t   true);\n}\n\nstatic void\nengine_init_workarounds(struct intel_engine_cs *engine, struct i915_wa_list *wal)\n{\n\tif (GRAPHICS_VER(engine->i915) < 4)\n\t\treturn;\n\n\tengine_fake_wa_init(engine, wal);\n\n\t \n\tif (engine->flags & I915_ENGINE_FIRST_RENDER_COMPUTE)\n\t\tgeneral_render_compute_wa_init(engine, wal);\n\n\tif (engine->class == COMPUTE_CLASS)\n\t\tccs_engine_wa_init(engine, wal);\n\telse if (engine->class == RENDER_CLASS)\n\t\trcs_engine_wa_init(engine, wal);\n\telse\n\t\txcs_engine_wa_init(engine, wal);\n}\n\nvoid intel_engine_init_workarounds(struct intel_engine_cs *engine)\n{\n\tstruct i915_wa_list *wal = &engine->wa_list;\n\n\twa_init_start(wal, engine->gt, \"engine\", engine->name);\n\tengine_init_workarounds(engine, wal);\n\twa_init_finish(wal);\n}\n\nvoid intel_engine_apply_workarounds(struct intel_engine_cs *engine)\n{\n\twa_list_apply(&engine->wa_list);\n}\n\nstatic const struct i915_range mcr_ranges_gen8[] = {\n\t{ .start = 0x5500, .end = 0x55ff },\n\t{ .start = 0x7000, .end = 0x7fff },\n\t{ .start = 0x9400, .end = 0x97ff },\n\t{ .start = 0xb000, .end = 0xb3ff },\n\t{ .start = 0xe000, .end = 0xe7ff },\n\t{},\n};\n\nstatic const struct i915_range mcr_ranges_gen12[] = {\n\t{ .start =  0x8150, .end =  0x815f },\n\t{ .start =  0x9520, .end =  0x955f },\n\t{ .start =  0xb100, .end =  0xb3ff },\n\t{ .start =  0xde80, .end =  0xe8ff },\n\t{ .start = 0x24a00, .end = 0x24a7f },\n\t{},\n};\n\nstatic const struct i915_range mcr_ranges_xehp[] = {\n\t{ .start =  0x4000, .end =  0x4aff },\n\t{ .start =  0x5200, .end =  0x52ff },\n\t{ .start =  0x5400, .end =  0x7fff },\n\t{ .start =  0x8140, .end =  0x815f },\n\t{ .start =  0x8c80, .end =  0x8dff },\n\t{ .start =  0x94d0, .end =  0x955f },\n\t{ .start =  0x9680, .end =  0x96ff },\n\t{ .start =  0xb000, .end =  0xb3ff },\n\t{ .start =  0xc800, .end =  0xcfff },\n\t{ .start =  0xd800, .end =  0xd8ff },\n\t{ .start =  0xdc00, .end =  0xffff },\n\t{ .start = 0x17000, .end = 0x17fff },\n\t{ .start = 0x24a00, .end = 0x24a7f },\n\t{},\n};\n\nstatic bool mcr_range(struct drm_i915_private *i915, u32 offset)\n{\n\tconst struct i915_range *mcr_ranges;\n\tint i;\n\n\tif (GRAPHICS_VER_FULL(i915) >= IP_VER(12, 50))\n\t\tmcr_ranges = mcr_ranges_xehp;\n\telse if (GRAPHICS_VER(i915) >= 12)\n\t\tmcr_ranges = mcr_ranges_gen12;\n\telse if (GRAPHICS_VER(i915) >= 8)\n\t\tmcr_ranges = mcr_ranges_gen8;\n\telse\n\t\treturn false;\n\n\t \n\tfor (i = 0; mcr_ranges[i].start; i++)\n\t\tif (offset >= mcr_ranges[i].start &&\n\t\t    offset <= mcr_ranges[i].end)\n\t\t\treturn true;\n\n\treturn false;\n}\n\nstatic int\nwa_list_srm(struct i915_request *rq,\n\t    const struct i915_wa_list *wal,\n\t    struct i915_vma *vma)\n{\n\tstruct drm_i915_private *i915 = rq->i915;\n\tunsigned int i, count = 0;\n\tconst struct i915_wa *wa;\n\tu32 srm, *cs;\n\n\tsrm = MI_STORE_REGISTER_MEM | MI_SRM_LRM_GLOBAL_GTT;\n\tif (GRAPHICS_VER(i915) >= 8)\n\t\tsrm++;\n\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++) {\n\t\tif (!mcr_range(i915, i915_mmio_reg_offset(wa->reg)))\n\t\t\tcount++;\n\t}\n\n\tcs = intel_ring_begin(rq, 4 * count);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++) {\n\t\tu32 offset = i915_mmio_reg_offset(wa->reg);\n\n\t\tif (mcr_range(i915, offset))\n\t\t\tcontinue;\n\n\t\t*cs++ = srm;\n\t\t*cs++ = offset;\n\t\t*cs++ = i915_ggtt_offset(vma) + sizeof(u32) * i;\n\t\t*cs++ = 0;\n\t}\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nstatic int engine_wa_list_verify(struct intel_context *ce,\n\t\t\t\t const struct i915_wa_list * const wal,\n\t\t\t\t const char *from)\n{\n\tconst struct i915_wa *wa;\n\tstruct i915_request *rq;\n\tstruct i915_vma *vma;\n\tstruct i915_gem_ww_ctx ww;\n\tunsigned int i;\n\tu32 *results;\n\tint err;\n\n\tif (!wal->count)\n\t\treturn 0;\n\n\tvma = __vm_create_scratch_for_read(&ce->engine->gt->ggtt->vm,\n\t\t\t\t\t   wal->count * sizeof(u32));\n\tif (IS_ERR(vma))\n\t\treturn PTR_ERR(vma);\n\n\tintel_engine_pm_get(ce->engine);\n\ti915_gem_ww_ctx_init(&ww, false);\nretry:\n\terr = i915_gem_object_lock(vma->obj, &ww);\n\tif (err == 0)\n\t\terr = intel_context_pin_ww(ce, &ww);\n\tif (err)\n\t\tgoto err_pm;\n\n\terr = i915_vma_pin_ww(vma, &ww, 0, 0,\n\t\t\t   i915_vma_is_ggtt(vma) ? PIN_GLOBAL : PIN_USER);\n\tif (err)\n\t\tgoto err_unpin;\n\n\trq = i915_request_create(ce);\n\tif (IS_ERR(rq)) {\n\t\terr = PTR_ERR(rq);\n\t\tgoto err_vma;\n\t}\n\n\terr = i915_vma_move_to_active(vma, rq, EXEC_OBJECT_WRITE);\n\tif (err == 0)\n\t\terr = wa_list_srm(rq, wal, vma);\n\n\ti915_request_get(rq);\n\tif (err)\n\t\ti915_request_set_error_once(rq, err);\n\ti915_request_add(rq);\n\n\tif (err)\n\t\tgoto err_rq;\n\n\tif (i915_request_wait(rq, 0, HZ / 5) < 0) {\n\t\terr = -ETIME;\n\t\tgoto err_rq;\n\t}\n\n\tresults = i915_gem_object_pin_map(vma->obj, I915_MAP_WB);\n\tif (IS_ERR(results)) {\n\t\terr = PTR_ERR(results);\n\t\tgoto err_rq;\n\t}\n\n\terr = 0;\n\tfor (i = 0, wa = wal->list; i < wal->count; i++, wa++) {\n\t\tif (mcr_range(rq->i915, i915_mmio_reg_offset(wa->reg)))\n\t\t\tcontinue;\n\n\t\tif (!wa_verify(wal->gt, wa, results[i], wal->name, from))\n\t\t\terr = -ENXIO;\n\t}\n\n\ti915_gem_object_unpin_map(vma->obj);\n\nerr_rq:\n\ti915_request_put(rq);\nerr_vma:\n\ti915_vma_unpin(vma);\nerr_unpin:\n\tintel_context_unpin(ce);\nerr_pm:\n\tif (err == -EDEADLK) {\n\t\terr = i915_gem_ww_ctx_backoff(&ww);\n\t\tif (!err)\n\t\t\tgoto retry;\n\t}\n\ti915_gem_ww_ctx_fini(&ww);\n\tintel_engine_pm_put(ce->engine);\n\ti915_vma_put(vma);\n\treturn err;\n}\n\nint intel_engine_verify_workarounds(struct intel_engine_cs *engine,\n\t\t\t\t    const char *from)\n{\n\treturn engine_wa_list_verify(engine->kernel_context,\n\t\t\t\t     &engine->wa_list,\n\t\t\t\t     from);\n}\n\n#if IS_ENABLED(CONFIG_DRM_I915_SELFTEST)\n#include \"selftest_workarounds.c\"\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}