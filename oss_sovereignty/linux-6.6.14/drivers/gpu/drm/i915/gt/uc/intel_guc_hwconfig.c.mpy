{
  "module_name": "intel_guc_hwconfig.c",
  "hash_id": "0d013b5fa987104ac67b7ba52ff5554211b4bfe663b1aa433cbbc7feb47e99ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/uc/intel_guc_hwconfig.c",
  "human_readable_source": "\n \n\n#include \"gt/intel_gt.h\"\n#include \"gt/intel_hwconfig.h\"\n#include \"i915_drv.h\"\n#include \"i915_memcpy.h\"\n\n \n\nstatic int __guc_action_get_hwconfig(struct intel_guc *guc,\n\t\t\t\t     u32 ggtt_offset, u32 ggtt_size)\n{\n\tu32 action[] = {\n\t\tINTEL_GUC_ACTION_GET_HWCONFIG,\n\t\tlower_32_bits(ggtt_offset),\n\t\tupper_32_bits(ggtt_offset),\n\t\tggtt_size,\n\t};\n\tint ret;\n\n\tret = intel_guc_send_mmio(guc, action, ARRAY_SIZE(action), NULL, 0);\n\tif (ret == -ENXIO)\n\t\treturn -ENOENT;\n\n\treturn ret;\n}\n\nstatic int guc_hwconfig_discover_size(struct intel_guc *guc, struct intel_hwconfig *hwconfig)\n{\n\tint ret;\n\n\t \n\tret = __guc_action_get_hwconfig(guc, 0, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (ret == 0)\n\t\treturn -EINVAL;\n\n\thwconfig->size = ret;\n\treturn 0;\n}\n\nstatic int guc_hwconfig_fill_buffer(struct intel_guc *guc, struct intel_hwconfig *hwconfig)\n{\n\tstruct i915_vma *vma;\n\tu32 ggtt_offset;\n\tvoid *vaddr;\n\tint ret;\n\n\tGEM_BUG_ON(!hwconfig->size);\n\n\tret = intel_guc_allocate_and_map_vma(guc, hwconfig->size, &vma, &vaddr);\n\tif (ret)\n\t\treturn ret;\n\n\tggtt_offset = intel_guc_ggtt_offset(guc, vma);\n\n\tret = __guc_action_get_hwconfig(guc, ggtt_offset, hwconfig->size);\n\tif (ret >= 0)\n\t\tmemcpy(hwconfig->ptr, vaddr, hwconfig->size);\n\n\ti915_vma_unpin_and_release(&vma, I915_VMA_RELEASE_MAP);\n\n\treturn ret;\n}\n\nstatic bool has_table(struct drm_i915_private *i915)\n{\n\tif (IS_ALDERLAKE_P(i915) && !IS_ALDERLAKE_P_N(i915))\n\t\treturn true;\n\tif (GRAPHICS_VER_FULL(i915) >= IP_VER(12, 55))\n\t\treturn true;\n\n\treturn false;\n}\n\n \nstatic int guc_hwconfig_init(struct intel_gt *gt)\n{\n\tstruct intel_hwconfig *hwconfig = &gt->info.hwconfig;\n\tstruct intel_guc *guc = &gt->uc.guc;\n\tint ret;\n\n\tif (!has_table(gt->i915))\n\t\treturn 0;\n\n\tret = guc_hwconfig_discover_size(guc, hwconfig);\n\tif (ret)\n\t\treturn ret;\n\n\thwconfig->ptr = kmalloc(hwconfig->size, GFP_KERNEL);\n\tif (!hwconfig->ptr) {\n\t\thwconfig->size = 0;\n\t\treturn -ENOMEM;\n\t}\n\n\tret = guc_hwconfig_fill_buffer(guc, hwconfig);\n\tif (ret < 0) {\n\t\tintel_gt_fini_hwconfig(gt);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\n \nint intel_gt_init_hwconfig(struct intel_gt *gt)\n{\n\tif (!intel_uc_uses_guc(&gt->uc))\n\t\treturn 0;\n\n\treturn guc_hwconfig_init(gt);\n}\n\n \nvoid intel_gt_fini_hwconfig(struct intel_gt *gt)\n{\n\tstruct intel_hwconfig *hwconfig = &gt->info.hwconfig;\n\n\tkfree(hwconfig->ptr);\n\thwconfig->size = 0;\n\thwconfig->ptr = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}