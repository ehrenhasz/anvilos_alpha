{
  "module_name": "selftest_guc_hangcheck.c",
  "hash_id": "62a4e80e7a10f8295957fb93115df30f1d6560e2939cea2955108c69e4e191a5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/uc/selftest_guc_hangcheck.c",
  "human_readable_source": "\n \n\n#include \"gt/intel_gt_print.h\"\n#include \"selftests/igt_spinner.h\"\n#include \"selftests/igt_reset.h\"\n#include \"selftests/intel_scheduler_helpers.h\"\n#include \"gt/intel_engine_heartbeat.h\"\n#include \"gem/selftests/mock_context.h\"\n\n#define BEAT_INTERVAL\t100\n\nstatic struct i915_request *nop_request(struct intel_engine_cs *engine)\n{\n\tstruct i915_request *rq;\n\n\trq = intel_engine_create_kernel_request(engine);\n\tif (IS_ERR(rq))\n\t\treturn rq;\n\n\ti915_request_get(rq);\n\ti915_request_add(rq);\n\n\treturn rq;\n}\n\nstatic int intel_hang_guc(void *arg)\n{\n\tstruct intel_gt *gt = arg;\n\tint ret = 0;\n\tstruct i915_gem_context *ctx;\n\tstruct intel_context *ce;\n\tstruct igt_spinner spin;\n\tstruct i915_request *rq;\n\tintel_wakeref_t wakeref;\n\tstruct i915_gpu_error *global = &gt->i915->gpu_error;\n\tstruct intel_engine_cs *engine = intel_selftest_find_any_engine(gt);\n\tunsigned int reset_count;\n\tu32 guc_status;\n\tu32 old_beat;\n\n\tif (!engine)\n\t\treturn 0;\n\n\tctx = kernel_context(gt->i915, NULL);\n\tif (IS_ERR(ctx)) {\n\t\tgt_err(gt, \"Failed get kernel context: %pe\\n\", ctx);\n\t\treturn PTR_ERR(ctx);\n\t}\n\n\twakeref = intel_runtime_pm_get(gt->uncore->rpm);\n\n\tce = intel_context_create(engine);\n\tif (IS_ERR(ce)) {\n\t\tret = PTR_ERR(ce);\n\t\tgt_err(gt, \"Failed to create spinner request: %pe\\n\", ce);\n\t\tgoto err;\n\t}\n\n\treset_count = i915_reset_count(global);\n\n\told_beat = engine->props.heartbeat_interval_ms;\n\tret = intel_engine_set_heartbeat(engine, BEAT_INTERVAL);\n\tif (ret) {\n\t\tgt_err(gt, \"Failed to boost heatbeat interval: %pe\\n\", ERR_PTR(ret));\n\t\tgoto err;\n\t}\n\n\tret = igt_spinner_init(&spin, engine->gt);\n\tif (ret) {\n\t\tgt_err(gt, \"Failed to create spinner: %pe\\n\", ERR_PTR(ret));\n\t\tgoto err;\n\t}\n\n\trq = igt_spinner_create_request(&spin, ce, MI_NOOP);\n\tintel_context_put(ce);\n\tif (IS_ERR(rq)) {\n\t\tret = PTR_ERR(rq);\n\t\tgt_err(gt, \"Failed to create spinner request: %pe\\n\", rq);\n\t\tgoto err_spin;\n\t}\n\n\tret = request_add_spin(rq, &spin);\n\tif (ret) {\n\t\ti915_request_put(rq);\n\t\tgt_err(gt, \"Failed to add Spinner request: %pe\\n\", ERR_PTR(ret));\n\t\tgoto err_spin;\n\t}\n\n\tret = intel_reset_guc(gt);\n\tif (ret) {\n\t\ti915_request_put(rq);\n\t\tgt_err(gt, \"Failed to reset GuC: %pe\\n\", ERR_PTR(ret));\n\t\tgoto err_spin;\n\t}\n\n\tguc_status = intel_uncore_read(gt->uncore, GUC_STATUS);\n\tif (!(guc_status & GS_MIA_IN_RESET)) {\n\t\ti915_request_put(rq);\n\t\tgt_err(gt, \"Failed to reset GuC: status = 0x%08X\\n\", guc_status);\n\t\tret = -EIO;\n\t\tgoto err_spin;\n\t}\n\n\t \n\tret = intel_selftest_wait_for_rq(rq);\n\ti915_request_put(rq);\n\tif (ret) {\n\t\tgt_err(gt, \"Request failed to complete: %pe\\n\", ERR_PTR(ret));\n\t\tgoto err_spin;\n\t}\n\n\tif (i915_reset_count(global) == reset_count) {\n\t\tgt_err(gt, \"Failed to record a GPU reset\\n\");\n\t\tret = -EINVAL;\n\t\tgoto err_spin;\n\t}\n\nerr_spin:\n\tigt_spinner_end(&spin);\n\tigt_spinner_fini(&spin);\n\tintel_engine_set_heartbeat(engine, old_beat);\n\n\tif (ret == 0) {\n\t\trq = nop_request(engine);\n\t\tif (IS_ERR(rq)) {\n\t\t\tret = PTR_ERR(rq);\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = intel_selftest_wait_for_rq(rq);\n\t\ti915_request_put(rq);\n\t\tif (ret) {\n\t\t\tgt_err(gt, \"No-op failed to complete: %pe\\n\", ERR_PTR(ret));\n\t\t\tgoto err;\n\t\t}\n\t}\n\nerr:\n\tintel_runtime_pm_put(gt->uncore->rpm, wakeref);\n\tkernel_context_close(ctx);\n\n\treturn ret;\n}\n\nint intel_guc_hang_check(struct drm_i915_private *i915)\n{\n\tstatic const struct i915_subtest tests[] = {\n\t\tSUBTEST(intel_hang_guc),\n\t};\n\tstruct intel_gt *gt = to_gt(i915);\n\n\tif (intel_gt_is_wedged(gt))\n\t\treturn 0;\n\n\tif (!intel_uc_uses_guc_submission(&gt->uc))\n\t\treturn 0;\n\n\treturn intel_gt_live_subtests(tests, gt);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}