{
  "module_name": "intel_gsc_uc_heci_cmd_submit.c",
  "hash_id": "6711a80969da29bdef29f8b777fd299fd4040e1a08e01f2db38600b1ea4760ea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/uc/intel_gsc_uc_heci_cmd_submit.c",
  "human_readable_source": "\n \n\n#include \"gt/intel_context.h\"\n#include \"gt/intel_engine_pm.h\"\n#include \"gt/intel_gpu_commands.h\"\n#include \"gt/intel_gt.h\"\n#include \"gt/intel_ring.h\"\n#include \"intel_gsc_uc_heci_cmd_submit.h\"\n\nstruct gsc_heci_pkt {\n\tu64 addr_in;\n\tu32 size_in;\n\tu64 addr_out;\n\tu32 size_out;\n};\n\nstatic int emit_gsc_heci_pkt(struct i915_request *rq, struct gsc_heci_pkt *pkt)\n{\n\tu32 *cs;\n\n\tcs = intel_ring_begin(rq, 8);\n\tif (IS_ERR(cs))\n\t\treturn PTR_ERR(cs);\n\n\t*cs++ = GSC_HECI_CMD_PKT;\n\t*cs++ = lower_32_bits(pkt->addr_in);\n\t*cs++ = upper_32_bits(pkt->addr_in);\n\t*cs++ = pkt->size_in;\n\t*cs++ = lower_32_bits(pkt->addr_out);\n\t*cs++ = upper_32_bits(pkt->addr_out);\n\t*cs++ = pkt->size_out;\n\t*cs++ = 0;\n\n\tintel_ring_advance(rq, cs);\n\n\treturn 0;\n}\n\nint intel_gsc_uc_heci_cmd_submit_packet(struct intel_gsc_uc *gsc, u64 addr_in,\n\t\t\t\t\tu32 size_in, u64 addr_out,\n\t\t\t\t\tu32 size_out)\n{\n\tstruct intel_context *ce = gsc->ce;\n\tstruct i915_request *rq;\n\tstruct gsc_heci_pkt pkt = {\n\t.addr_in = addr_in,\n\t.size_in = size_in,\n\t.addr_out = addr_out,\n\t.size_out = size_out\n\t};\n\tint err;\n\n\tif (!ce)\n\t\treturn -ENODEV;\n\n\trq = i915_request_create(ce);\n\tif (IS_ERR(rq))\n\t\treturn PTR_ERR(rq);\n\n\tif (ce->engine->emit_init_breadcrumb) {\n\t\terr = ce->engine->emit_init_breadcrumb(rq);\n\t\tif (err)\n\t\t\tgoto out_rq;\n\t}\n\n\terr = emit_gsc_heci_pkt(rq, &pkt);\n\n\tif (err)\n\t\tgoto out_rq;\n\n\terr = ce->engine->emit_flush(rq, 0);\n\nout_rq:\n\ti915_request_get(rq);\n\n\tif (unlikely(err))\n\t\ti915_request_set_error_once(rq, err);\n\n\ti915_request_add(rq);\n\n\tif (!err && i915_request_wait(rq, 0, msecs_to_jiffies(500)) < 0)\n\t\terr = -ETIME;\n\n\ti915_request_put(rq);\n\n\tif (err)\n\t\tdrm_err(&gsc_uc_to_gt(gsc)->i915->drm,\n\t\t\t\"Request submission for GSC heci cmd failed (%d)\\n\",\n\t\t\terr);\n\n\treturn err;\n}\n\nvoid intel_gsc_uc_heci_cmd_emit_mtl_header(struct intel_gsc_mtl_header *header,\n\t\t\t\t\t   u8 heci_client_id, u32 message_size,\n\t\t\t\t\t   u64 host_session_id)\n{\n\thost_session_id &= ~HOST_SESSION_MASK;\n\tif (host_session_id && heci_client_id == HECI_MEADDRESS_PXP)\n\t\thost_session_id |= HOST_SESSION_PXP_SINGLE;\n\n\theader->validity_marker = GSC_HECI_VALIDITY_MARKER;\n\theader->heci_client_id = heci_client_id;\n\theader->host_session_handle = host_session_id;\n\theader->header_version = MTL_GSC_HEADER_VERSION;\n\theader->message_size = message_size;\n}\n\nstatic void\nemit_gsc_heci_pkt_nonpriv(u32 *cmd, struct intel_gsc_heci_non_priv_pkt *pkt)\n{\n\t*cmd++ = GSC_HECI_CMD_PKT;\n\t*cmd++ = lower_32_bits(pkt->addr_in);\n\t*cmd++ = upper_32_bits(pkt->addr_in);\n\t*cmd++ = pkt->size_in;\n\t*cmd++ = lower_32_bits(pkt->addr_out);\n\t*cmd++ = upper_32_bits(pkt->addr_out);\n\t*cmd++ = pkt->size_out;\n\t*cmd++ = 0;\n\t*cmd++ = MI_BATCH_BUFFER_END;\n}\n\nint\nintel_gsc_uc_heci_cmd_submit_nonpriv(struct intel_gsc_uc *gsc,\n\t\t\t\t     struct intel_context *ce,\n\t\t\t\t     struct intel_gsc_heci_non_priv_pkt *pkt,\n\t\t\t\t     u32 *cmd, int timeout_ms)\n{\n\tstruct intel_engine_cs *engine;\n\tstruct i915_gem_ww_ctx ww;\n\tstruct i915_request *rq;\n\tint err, trials = 0;\n\n\ti915_gem_ww_ctx_init(&ww, false);\nretry:\n\terr = i915_gem_object_lock(pkt->bb_vma->obj, &ww);\n\tif (err)\n\t\tgoto out_ww;\n\terr = i915_gem_object_lock(pkt->heci_pkt_vma->obj, &ww);\n\tif (err)\n\t\tgoto out_ww;\n\terr = intel_context_pin_ww(ce, &ww);\n\tif (err)\n\t\tgoto out_ww;\n\n\trq = i915_request_create(ce);\n\tif (IS_ERR(rq)) {\n\t\terr = PTR_ERR(rq);\n\t\tgoto out_unpin_ce;\n\t}\n\n\temit_gsc_heci_pkt_nonpriv(cmd, pkt);\n\n\terr = i915_vma_move_to_active(pkt->bb_vma, rq, 0);\n\tif (err)\n\t\tgoto out_rq;\n\terr = i915_vma_move_to_active(pkt->heci_pkt_vma, rq, EXEC_OBJECT_WRITE);\n\tif (err)\n\t\tgoto out_rq;\n\n\tengine = rq->context->engine;\n\tif (engine->emit_init_breadcrumb) {\n\t\terr = engine->emit_init_breadcrumb(rq);\n\t\tif (err)\n\t\t\tgoto out_rq;\n\t}\n\n\terr = engine->emit_bb_start(rq, i915_vma_offset(pkt->bb_vma), PAGE_SIZE, 0);\n\tif (err)\n\t\tgoto out_rq;\n\n\terr = ce->engine->emit_flush(rq, 0);\n\tif (err)\n\t\tdrm_err(&gsc_uc_to_gt(gsc)->i915->drm,\n\t\t\t\"Failed emit-flush for gsc-heci-non-priv-pkterr=%d\\n\", err);\n\nout_rq:\n\ti915_request_get(rq);\n\n\tif (unlikely(err))\n\t\ti915_request_set_error_once(rq, err);\n\n\ti915_request_add(rq);\n\n\tif (!err) {\n\t\tif (i915_request_wait(rq, I915_WAIT_INTERRUPTIBLE,\n\t\t\t\t      msecs_to_jiffies(timeout_ms)) < 0)\n\t\t\terr = -ETIME;\n\t}\n\n\ti915_request_put(rq);\n\nout_unpin_ce:\n\tintel_context_unpin(ce);\nout_ww:\n\tif (err == -EDEADLK) {\n\t\terr = i915_gem_ww_ctx_backoff(&ww);\n\t\tif (!err) {\n\t\t\tif (++trials < 10)\n\t\t\t\tgoto retry;\n\t\t\telse\n\t\t\t\terr = -EAGAIN;\n\t\t}\n\t}\n\ti915_gem_ww_ctx_fini(&ww);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}