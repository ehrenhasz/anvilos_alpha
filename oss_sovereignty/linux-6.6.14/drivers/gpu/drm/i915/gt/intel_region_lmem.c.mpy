{
  "module_name": "intel_region_lmem.c",
  "hash_id": "1edbe00c1c1964342c01944951ea977d9f37810086ae928e8e8a559342d38b3f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gt/intel_region_lmem.c",
  "human_readable_source": "\n \n\n#include \"i915_drv.h\"\n#include \"i915_pci.h\"\n#include \"i915_reg.h\"\n#include \"intel_memory_region.h\"\n#include \"intel_pci_config.h\"\n#include \"intel_region_lmem.h\"\n#include \"intel_region_ttm.h\"\n#include \"gem/i915_gem_lmem.h\"\n#include \"gem/i915_gem_region.h\"\n#include \"gem/i915_gem_ttm.h\"\n#include \"gt/intel_gt.h\"\n#include \"gt/intel_gt_mcr.h\"\n#include \"gt/intel_gt_regs.h\"\n\n#ifdef CONFIG_64BIT\nstatic void _release_bars(struct pci_dev *pdev)\n{\n\tint resno;\n\n\tfor (resno = PCI_STD_RESOURCES; resno < PCI_STD_RESOURCE_END; resno++) {\n\t\tif (pci_resource_len(pdev, resno))\n\t\t\tpci_release_resource(pdev, resno);\n\t}\n}\n\nstatic void\n_resize_bar(struct drm_i915_private *i915, int resno, resource_size_t size)\n{\n\tstruct pci_dev *pdev = to_pci_dev(i915->drm.dev);\n\tint bar_size = pci_rebar_bytes_to_size(size);\n\tint ret;\n\n\t_release_bars(pdev);\n\n\tret = pci_resize_resource(pdev, resno, bar_size);\n\tif (ret) {\n\t\tdrm_info(&i915->drm, \"Failed to resize BAR%d to %dM (%pe)\\n\",\n\t\t\t resno, 1 << bar_size, ERR_PTR(ret));\n\t\treturn;\n\t}\n\n\tdrm_info(&i915->drm, \"BAR%d resized to %dM\\n\", resno, 1 << bar_size);\n}\n\nstatic void i915_resize_lmem_bar(struct drm_i915_private *i915, resource_size_t lmem_size)\n{\n\tstruct pci_dev *pdev = to_pci_dev(i915->drm.dev);\n\tstruct pci_bus *root = pdev->bus;\n\tstruct resource *root_res;\n\tresource_size_t rebar_size;\n\tresource_size_t current_size;\n\tintel_wakeref_t wakeref;\n\tu32 pci_cmd;\n\tint i;\n\n\tcurrent_size = roundup_pow_of_two(pci_resource_len(pdev, GEN12_LMEM_BAR));\n\n\tif (i915->params.lmem_bar_size) {\n\t\tu32 bar_sizes;\n\n\t\trebar_size = i915->params.lmem_bar_size *\n\t\t\t(resource_size_t)SZ_1M;\n\t\tbar_sizes = pci_rebar_get_possible_sizes(pdev, GEN12_LMEM_BAR);\n\n\t\tif (rebar_size == current_size)\n\t\t\treturn;\n\n\t\tif (!(bar_sizes & BIT(pci_rebar_bytes_to_size(rebar_size))) ||\n\t\t    rebar_size >= roundup_pow_of_two(lmem_size)) {\n\t\t\trebar_size = lmem_size;\n\n\t\t\tdrm_info(&i915->drm,\n\t\t\t\t \"Given bar size is not within supported size, setting it to default: %llu\\n\",\n\t\t\t\t (u64)lmem_size >> 20);\n\t\t}\n\t} else {\n\t\trebar_size = current_size;\n\n\t\tif (rebar_size != roundup_pow_of_two(lmem_size))\n\t\t\trebar_size = lmem_size;\n\t\telse\n\t\t\treturn;\n\t}\n\n\t \n\twhile (root->parent)\n\t\troot = root->parent;\n\n\tpci_bus_for_each_resource(root, root_res, i) {\n\t\tif (root_res && root_res->flags & (IORESOURCE_MEM | IORESOURCE_MEM_64) &&\n\t\t    root_res->start > 0x100000000ull)\n\t\t\tbreak;\n\t}\n\n\t \n\tif (!root_res) {\n\t\tdrm_info(&i915->drm, \"Can't resize LMEM BAR - platform support is missing\\n\");\n\t\treturn;\n\t}\n\n\t \n\twith_intel_runtime_pm(i915->uncore.rpm, wakeref) {\n\t\tintel_uncore_forcewake_get(&i915->uncore, FORCEWAKE_ALL);\n\n\t\t \n\t\tpci_read_config_dword(pdev, PCI_COMMAND, &pci_cmd);\n\t\tpci_write_config_dword(pdev, PCI_COMMAND,\n\t\t\t\t       pci_cmd & ~PCI_COMMAND_MEMORY);\n\n\t\t_resize_bar(i915, GEN12_LMEM_BAR, rebar_size);\n\n\t\tpci_assign_unassigned_bus_resources(pdev->bus);\n\t\tpci_write_config_dword(pdev, PCI_COMMAND, pci_cmd);\n\t\tintel_uncore_forcewake_put(&i915->uncore, FORCEWAKE_ALL);\n\t}\n}\n#else\nstatic void i915_resize_lmem_bar(struct drm_i915_private *i915, resource_size_t lmem_size) {}\n#endif\n\nstatic int\nregion_lmem_release(struct intel_memory_region *mem)\n{\n\tint ret;\n\n\tret = intel_region_ttm_fini(mem);\n\tio_mapping_fini(&mem->iomap);\n\n\treturn ret;\n}\n\nstatic int\nregion_lmem_init(struct intel_memory_region *mem)\n{\n\tint ret;\n\n\tif (!io_mapping_init_wc(&mem->iomap,\n\t\t\t\tmem->io_start,\n\t\t\t\tmem->io_size))\n\t\treturn -EIO;\n\n\tret = intel_region_ttm_init(mem);\n\tif (ret)\n\t\tgoto out_no_buddy;\n\n\treturn 0;\n\nout_no_buddy:\n\tio_mapping_fini(&mem->iomap);\n\n\treturn ret;\n}\n\nstatic const struct intel_memory_region_ops intel_region_lmem_ops = {\n\t.init = region_lmem_init,\n\t.release = region_lmem_release,\n\t.init_object = __i915_gem_ttm_object_init,\n};\n\nstatic bool get_legacy_lowmem_region(struct intel_uncore *uncore,\n\t\t\t\t     u64 *start, u32 *size)\n{\n\tif (!IS_DG1(uncore->i915))\n\t\treturn false;\n\n\t*start = 0;\n\t*size = SZ_1M;\n\n\tdrm_dbg(&uncore->i915->drm, \"LMEM: reserved legacy low-memory [0x%llx-0x%llx]\\n\",\n\t\t*start, *start + *size);\n\n\treturn true;\n}\n\nstatic int reserve_lowmem_region(struct intel_uncore *uncore,\n\t\t\t\t struct intel_memory_region *mem)\n{\n\tu64 reserve_start;\n\tu32 reserve_size;\n\tint ret;\n\n\tif (!get_legacy_lowmem_region(uncore, &reserve_start, &reserve_size))\n\t\treturn 0;\n\n\tret = intel_memory_region_reserve(mem, reserve_start, reserve_size);\n\tif (ret)\n\t\tdrm_err(&uncore->i915->drm, \"LMEM: reserving low memory region failed\\n\");\n\n\treturn ret;\n}\n\nstatic struct intel_memory_region *setup_lmem(struct intel_gt *gt)\n{\n\tstruct drm_i915_private *i915 = gt->i915;\n\tstruct intel_uncore *uncore = gt->uncore;\n\tstruct pci_dev *pdev = to_pci_dev(i915->drm.dev);\n\tstruct intel_memory_region *mem;\n\tresource_size_t min_page_size;\n\tresource_size_t io_start;\n\tresource_size_t io_size;\n\tresource_size_t lmem_size;\n\tint err;\n\n\tif (!IS_DGFX(i915))\n\t\treturn ERR_PTR(-ENODEV);\n\n\tif (!i915_pci_resource_valid(pdev, GEN12_LMEM_BAR))\n\t\treturn ERR_PTR(-ENXIO);\n\n\tif (HAS_FLAT_CCS(i915)) {\n\t\tresource_size_t lmem_range;\n\t\tu64 tile_stolen, flat_ccs_base;\n\n\t\tlmem_range = intel_gt_mcr_read_any(to_gt(i915), XEHP_TILE0_ADDR_RANGE) & 0xFFFF;\n\t\tlmem_size = lmem_range >> XEHP_TILE_LMEM_RANGE_SHIFT;\n\t\tlmem_size *= SZ_1G;\n\n\t\tflat_ccs_base = intel_gt_mcr_read_any(gt, XEHP_FLAT_CCS_BASE_ADDR);\n\t\tflat_ccs_base = (flat_ccs_base >> XEHP_CCS_BASE_SHIFT) * SZ_64K;\n\n\t\tif (GEM_WARN_ON(lmem_size < flat_ccs_base))\n\t\t\treturn ERR_PTR(-EIO);\n\n\t\ttile_stolen = lmem_size - flat_ccs_base;\n\n\t\t \n\t\tif (tile_stolen == lmem_size)\n\t\t\tdrm_err(&i915->drm,\n\t\t\t\t\"CCS_BASE_ADDR register did not have expected value\\n\");\n\n\t\tlmem_size -= tile_stolen;\n\t} else {\n\t\t \n\t\tlmem_size = intel_uncore_read64(&i915->uncore, GEN12_GSMBASE);\n\t}\n\n\ti915_resize_lmem_bar(i915, lmem_size);\n\n\tif (i915->params.lmem_size > 0) {\n\t\tlmem_size = min_t(resource_size_t, lmem_size,\n\t\t\t\t  mul_u32_u32(i915->params.lmem_size, SZ_1M));\n\t}\n\n\tio_start = pci_resource_start(pdev, GEN12_LMEM_BAR);\n\tio_size = min(pci_resource_len(pdev, GEN12_LMEM_BAR), lmem_size);\n\tif (!io_size)\n\t\treturn ERR_PTR(-EIO);\n\n\tmin_page_size = HAS_64K_PAGES(i915) ? I915_GTT_PAGE_SIZE_64K :\n\t\t\t\t\t\tI915_GTT_PAGE_SIZE_4K;\n\tmem = intel_memory_region_create(i915,\n\t\t\t\t\t 0,\n\t\t\t\t\t lmem_size,\n\t\t\t\t\t min_page_size,\n\t\t\t\t\t io_start,\n\t\t\t\t\t io_size,\n\t\t\t\t\t INTEL_MEMORY_LOCAL,\n\t\t\t\t\t 0,\n\t\t\t\t\t &intel_region_lmem_ops);\n\tif (IS_ERR(mem))\n\t\treturn mem;\n\n\terr = reserve_lowmem_region(uncore, mem);\n\tif (err)\n\t\tgoto err_region_put;\n\n\tdrm_dbg(&i915->drm, \"Local memory: %pR\\n\", &mem->region);\n\tdrm_dbg(&i915->drm, \"Local memory IO start: %pa\\n\",\n\t\t&mem->io_start);\n\tdrm_info(&i915->drm, \"Local memory IO size: %pa\\n\",\n\t\t &mem->io_size);\n\tdrm_info(&i915->drm, \"Local memory available: %pa\\n\",\n\t\t &lmem_size);\n\n\tif (io_size < lmem_size)\n\t\tdrm_info(&i915->drm, \"Using a reduced BAR size of %lluMiB. Consider enabling 'Resizable BAR' or similar, if available in the BIOS.\\n\",\n\t\t\t (u64)io_size >> 20);\n\n\treturn mem;\n\nerr_region_put:\n\tintel_memory_region_destroy(mem);\n\treturn ERR_PTR(err);\n}\n\nstruct intel_memory_region *intel_gt_setup_lmem(struct intel_gt *gt)\n{\n\treturn setup_lmem(gt);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}