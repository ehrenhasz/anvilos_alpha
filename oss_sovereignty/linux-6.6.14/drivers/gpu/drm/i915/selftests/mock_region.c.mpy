{
  "module_name": "mock_region.c",
  "hash_id": "ee933bf01b186d4cad2d6b113daee21346eed04e182293883be105309bf4f056",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/selftests/mock_region.c",
  "human_readable_source": "\n \n\n#include <drm/ttm/ttm_placement.h>\n#include <linux/scatterlist.h>\n\n#include \"gem/i915_gem_region.h\"\n#include \"intel_memory_region.h\"\n#include \"intel_region_ttm.h\"\n\n#include \"mock_region.h\"\n\nstatic void mock_region_put_pages(struct drm_i915_gem_object *obj,\n\t\t\t\t  struct sg_table *pages)\n{\n\ti915_refct_sgt_put(obj->mm.rsgt);\n\tobj->mm.rsgt = NULL;\n\tintel_region_ttm_resource_free(obj->mm.region, obj->mm.res);\n}\n\nstatic int mock_region_get_pages(struct drm_i915_gem_object *obj)\n{\n\tstruct sg_table *pages;\n\tint err;\n\n\tobj->mm.res = intel_region_ttm_resource_alloc(obj->mm.region,\n\t\t\t\t\t\t      obj->bo_offset,\n\t\t\t\t\t\t      obj->base.size,\n\t\t\t\t\t\t      obj->flags);\n\tif (IS_ERR(obj->mm.res))\n\t\treturn PTR_ERR(obj->mm.res);\n\n\tobj->mm.rsgt = intel_region_ttm_resource_to_rsgt(obj->mm.region,\n\t\t\t\t\t\t\t obj->mm.res,\n\t\t\t\t\t\t\t obj->mm.region->min_page_size);\n\tif (IS_ERR(obj->mm.rsgt)) {\n\t\terr = PTR_ERR(obj->mm.rsgt);\n\t\tgoto err_free_resource;\n\t}\n\n\tpages = &obj->mm.rsgt->table;\n\t__i915_gem_object_set_pages(obj, pages);\n\n\treturn 0;\n\nerr_free_resource:\n\tintel_region_ttm_resource_free(obj->mm.region, obj->mm.res);\n\treturn err;\n}\n\nstatic const struct drm_i915_gem_object_ops mock_region_obj_ops = {\n\t.name = \"mock-region\",\n\t.get_pages = mock_region_get_pages,\n\t.put_pages = mock_region_put_pages,\n\t.release = i915_gem_object_release_memory_region,\n};\n\nstatic int mock_object_init(struct intel_memory_region *mem,\n\t\t\t    struct drm_i915_gem_object *obj,\n\t\t\t    resource_size_t offset,\n\t\t\t    resource_size_t size,\n\t\t\t    resource_size_t page_size,\n\t\t\t    unsigned int flags)\n{\n\tstatic struct lock_class_key lock_class;\n\tstruct drm_i915_private *i915 = mem->i915;\n\n\tif (size > resource_size(&mem->region))\n\t\treturn -E2BIG;\n\n\tdrm_gem_private_object_init(&i915->drm, &obj->base, size);\n\ti915_gem_object_init(obj, &mock_region_obj_ops, &lock_class, flags);\n\n\tobj->bo_offset = offset;\n\n\tobj->read_domains = I915_GEM_DOMAIN_CPU | I915_GEM_DOMAIN_GTT;\n\n\ti915_gem_object_set_cache_coherency(obj, I915_CACHE_NONE);\n\n\ti915_gem_object_init_memory_region(obj, mem);\n\n\treturn 0;\n}\n\nstatic int mock_region_fini(struct intel_memory_region *mem)\n{\n\tstruct drm_i915_private *i915 = mem->i915;\n\tint instance = mem->instance;\n\tint ret;\n\n\tret = intel_region_ttm_fini(mem);\n\tida_free(&i915->selftest.mock_region_instances, instance);\n\n\treturn ret;\n}\n\nstatic const struct intel_memory_region_ops mock_region_ops = {\n\t.init = intel_region_ttm_init,\n\t.release = mock_region_fini,\n\t.init_object = mock_object_init,\n};\n\nstruct intel_memory_region *\nmock_region_create(struct drm_i915_private *i915,\n\t\t   resource_size_t start,\n\t\t   resource_size_t size,\n\t\t   resource_size_t min_page_size,\n\t\t   resource_size_t io_start,\n\t\t   resource_size_t io_size)\n{\n\tint instance = ida_alloc_max(&i915->selftest.mock_region_instances,\n\t\t\t\t     TTM_NUM_MEM_TYPES - TTM_PL_PRIV - 1,\n\t\t\t\t     GFP_KERNEL);\n\n\tif (instance < 0)\n\t\treturn ERR_PTR(instance);\n\n\treturn intel_memory_region_create(i915, start, size, min_page_size,\n\t\t\t\t\t  io_start, io_size,\n\t\t\t\t\t  INTEL_MEMORY_MOCK, instance,\n\t\t\t\t\t  &mock_region_ops);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}