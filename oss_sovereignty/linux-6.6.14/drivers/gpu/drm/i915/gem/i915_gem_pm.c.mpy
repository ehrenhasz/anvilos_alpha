{
  "module_name": "i915_gem_pm.c",
  "hash_id": "93594f4547977a8018d8753b745a16f3b591f54fffe7515831cf9e06e09ad859",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gem/i915_gem_pm.c",
  "human_readable_source": " \n\n#include \"gem/i915_gem_pm.h\"\n#include \"gem/i915_gem_ttm_pm.h\"\n#include \"gt/intel_gt.h\"\n#include \"gt/intel_gt_pm.h\"\n#include \"gt/intel_gt_requests.h\"\n\n#include \"i915_driver.h\"\n#include \"i915_drv.h\"\n\n#if defined(CONFIG_X86)\n#include <asm/smp.h>\n#else\n#define wbinvd_on_all_cpus() \\\n\tpr_warn(DRIVER_NAME \": Missing cache flush in %s\\n\", __func__)\n#endif\n\nvoid i915_gem_suspend(struct drm_i915_private *i915)\n{\n\tstruct intel_gt *gt;\n\tunsigned int i;\n\n\tGEM_TRACE(\"%s\\n\", dev_name(i915->drm.dev));\n\n\tintel_wakeref_auto(&i915->runtime_pm.userfault_wakeref, 0);\n\tflush_workqueue(i915->wq);\n\n\t \n\tfor_each_gt(gt, i915, i)\n\t\tintel_gt_suspend_prepare(gt);\n\n\ti915_gem_drain_freed_objects(i915);\n}\n\nstatic int lmem_restore(struct drm_i915_private *i915, u32 flags)\n{\n\tstruct intel_memory_region *mr;\n\tint ret = 0, id;\n\n\tfor_each_memory_region(mr, i915, id) {\n\t\tif (mr->type == INTEL_MEMORY_LOCAL) {\n\t\t\tret = i915_ttm_restore_region(mr, flags);\n\t\t\tif (ret)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int lmem_suspend(struct drm_i915_private *i915, u32 flags)\n{\n\tstruct intel_memory_region *mr;\n\tint ret = 0, id;\n\n\tfor_each_memory_region(mr, i915, id) {\n\t\tif (mr->type == INTEL_MEMORY_LOCAL) {\n\t\t\tret = i915_ttm_backup_region(mr, flags);\n\t\t\tif (ret)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic void lmem_recover(struct drm_i915_private *i915)\n{\n\tstruct intel_memory_region *mr;\n\tint id;\n\n\tfor_each_memory_region(mr, i915, id)\n\t\tif (mr->type == INTEL_MEMORY_LOCAL)\n\t\t\ti915_ttm_recover_region(mr);\n}\n\nint i915_gem_backup_suspend(struct drm_i915_private *i915)\n{\n\tint ret;\n\n\t \n\tret = lmem_suspend(i915, I915_TTM_BACKUP_ALLOW_GPU);\n\tif (ret)\n\t\tgoto out_recover;\n\n\ti915_gem_suspend(i915);\n\n\t \n\tret = lmem_suspend(i915, I915_TTM_BACKUP_ALLOW_GPU |\n\t\t\t   I915_TTM_BACKUP_PINNED);\n\tif (ret)\n\t\tgoto out_recover;\n\n\t \n\tret = lmem_suspend(i915, I915_TTM_BACKUP_PINNED);\n\tif (ret)\n\t\tgoto out_recover;\n\n\treturn 0;\n\nout_recover:\n\tlmem_recover(i915);\n\n\treturn ret;\n}\n\nvoid i915_gem_suspend_late(struct drm_i915_private *i915)\n{\n\tstruct drm_i915_gem_object *obj;\n\tstruct list_head *phases[] = {\n\t\t&i915->mm.shrink_list,\n\t\t&i915->mm.purge_list,\n\t\tNULL\n\t}, **phase;\n\tstruct intel_gt *gt;\n\tunsigned long flags;\n\tunsigned int i;\n\tbool flush = false;\n\n\t \n\n\tfor_each_gt(gt, i915, i)\n\t\tintel_gt_suspend_late(gt);\n\n\tspin_lock_irqsave(&i915->mm.obj_lock, flags);\n\tfor (phase = phases; *phase; phase++) {\n\t\tlist_for_each_entry(obj, *phase, mm.link) {\n\t\t\tif (!(obj->cache_coherent & I915_BO_CACHE_COHERENT_FOR_READ))\n\t\t\t\tflush |= (obj->read_domains & I915_GEM_DOMAIN_CPU) == 0;\n\t\t\t__start_cpu_write(obj);  \n\t\t}\n\t}\n\tspin_unlock_irqrestore(&i915->mm.obj_lock, flags);\n\tif (flush)\n\t\twbinvd_on_all_cpus();\n}\n\nint i915_gem_freeze(struct drm_i915_private *i915)\n{\n\t \n\ti915_gem_shrink_all(i915);\n\n\treturn 0;\n}\n\nint i915_gem_freeze_late(struct drm_i915_private *i915)\n{\n\tstruct drm_i915_gem_object *obj;\n\tintel_wakeref_t wakeref;\n\n\t \n\n\twith_intel_runtime_pm(&i915->runtime_pm, wakeref)\n\t\ti915_gem_shrink(NULL, i915, -1UL, NULL, ~0);\n\ti915_gem_drain_freed_objects(i915);\n\n\twbinvd_on_all_cpus();\n\tlist_for_each_entry(obj, &i915->mm.shrink_list, mm.link)\n\t\t__start_cpu_write(obj);\n\n\treturn 0;\n}\n\nvoid i915_gem_resume(struct drm_i915_private *i915)\n{\n\tstruct intel_gt *gt;\n\tint ret, i, j;\n\n\tGEM_TRACE(\"%s\\n\", dev_name(i915->drm.dev));\n\n\tret = lmem_restore(i915, 0);\n\tGEM_WARN_ON(ret);\n\n\t \n\tfor_each_gt(gt, i915, i)\n\t\tif (intel_gt_resume(gt))\n\t\t\tgoto err_wedged;\n\n\tret = lmem_restore(i915, I915_TTM_BACKUP_ALLOW_GPU);\n\tGEM_WARN_ON(ret);\n\n\treturn;\n\nerr_wedged:\n\tfor_each_gt(gt, i915, j) {\n\t\tif (!intel_gt_is_wedged(gt)) {\n\t\t\tdev_err(i915->drm.dev,\n\t\t\t\t\"Failed to re-initialize GPU[%u], declaring it wedged!\\n\",\n\t\t\t\tj);\n\t\t\tintel_gt_set_wedged(gt);\n\t\t}\n\n\t\tif (j == i)\n\t\t\tbreak;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}