{
  "module_name": "i915_gem_throttle.c",
  "hash_id": "8ccd46fac2e9eb843886f1b5040540e984fcea2f57926803dc7618e8f2e6714a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/i915/gem/i915_gem_throttle.c",
  "human_readable_source": " \n\n#include <linux/jiffies.h>\n\n#include <drm/drm_file.h>\n\n#include \"i915_drv.h\"\n#include \"i915_file_private.h\"\n#include \"i915_gem_context.h\"\n#include \"i915_gem_ioctls.h\"\n#include \"i915_gem_object.h\"\n\n \n#define DRM_I915_THROTTLE_JIFFIES msecs_to_jiffies(20)\n\n \nint\ni915_gem_throttle_ioctl(struct drm_device *dev, void *data,\n\t\t\tstruct drm_file *file)\n{\n\tconst unsigned long recent_enough = jiffies - DRM_I915_THROTTLE_JIFFIES;\n\tstruct drm_i915_file_private *file_priv = file->driver_priv;\n\tstruct drm_i915_private *i915 = to_i915(dev);\n\tstruct i915_gem_context *ctx;\n\tunsigned long idx;\n\tlong ret;\n\n\t \n\tret = intel_gt_terminally_wedged(to_gt(i915));\n\tif (ret)\n\t\treturn ret;\n\n\trcu_read_lock();\n\txa_for_each(&file_priv->context_xa, idx, ctx) {\n\t\tstruct i915_gem_engines_iter it;\n\t\tstruct intel_context *ce;\n\n\t\tif (!kref_get_unless_zero(&ctx->ref))\n\t\t\tcontinue;\n\t\trcu_read_unlock();\n\n\t\tfor_each_gem_engine(ce,\n\t\t\t\t    i915_gem_context_lock_engines(ctx),\n\t\t\t\t    it) {\n\t\t\tstruct i915_request *rq, *target = NULL;\n\n\t\t\tif (!ce->timeline)\n\t\t\t\tcontinue;\n\n\t\t\tmutex_lock(&ce->timeline->mutex);\n\t\t\tlist_for_each_entry_reverse(rq,\n\t\t\t\t\t\t    &ce->timeline->requests,\n\t\t\t\t\t\t    link) {\n\t\t\t\tif (i915_request_completed(rq))\n\t\t\t\t\tbreak;\n\n\t\t\t\tif (time_after(rq->emitted_jiffies,\n\t\t\t\t\t       recent_enough))\n\t\t\t\t\tcontinue;\n\n\t\t\t\ttarget = i915_request_get(rq);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tmutex_unlock(&ce->timeline->mutex);\n\t\t\tif (!target)\n\t\t\t\tcontinue;\n\n\t\t\tret = i915_request_wait(target,\n\t\t\t\t\t\tI915_WAIT_INTERRUPTIBLE,\n\t\t\t\t\t\tMAX_SCHEDULE_TIMEOUT);\n\t\t\ti915_request_put(target);\n\t\t\tif (ret < 0)\n\t\t\t\tbreak;\n\t\t}\n\t\ti915_gem_context_unlock_engines(ctx);\n\t\ti915_gem_context_put(ctx);\n\n\t\trcu_read_lock();\n\t}\n\trcu_read_unlock();\n\n\treturn ret < 0 ? ret : 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}