{
  "module_name": "build.sh",
  "hash_id": "31209b9e10547e6ba478f184f9b58e0c1a1201d6257db28dcef7a93206df365c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/ci/build.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: MIT\n\nset -ex\n\n# Clean up stale rebases that GitLab might not have removed when reusing a checkout dir\nrm -rf .git/rebase-apply\n\n. .gitlab-ci/container/container_pre_build.sh\n\n# libssl-dev was uninstalled because it was considered an ephemeral package\napt-get update\napt-get install -y libssl-dev\n\nif [[ \"$KERNEL_ARCH\" = \"arm64\" ]]; then\n    GCC_ARCH=\"aarch64-linux-gnu\"\n    DEBIAN_ARCH=\"arm64\"\n    DEVICE_TREES=\"arch/arm64/boot/dts/rockchip/rk3399-gru-kevin.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/amlogic/meson-gxl-s805x-libretech-ac.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/allwinner/sun50i-h6-pine-h64.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/amlogic/meson-gxm-khadas-vim2.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/qcom/apq8016-sbc.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/qcom/apq8096-db820c.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/amlogic/meson-g12b-a311d-khadas-vim3.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/mediatek/mt8173-elm-hana.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/mediatek/mt8183-kukui-jacuzzi-juniper-sku16.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/mediatek/mt8192-asurada-spherion-r0.dtb\"\n    DEVICE_TREES+=\" arch/arm64/boot/dts/qcom/sc7180-trogdor-lazor-limozeen-nots-r5.dtb\"\nelif [[ \"$KERNEL_ARCH\" = \"arm\" ]]; then\n    GCC_ARCH=\"arm-linux-gnueabihf\"\n    DEBIAN_ARCH=\"armhf\"\n    DEVICE_TREES=\"arch/arm/boot/dts/rockchip/rk3288-veyron-jaq.dtb\"\n    DEVICE_TREES+=\" arch/arm/boot/dts/allwinner/sun8i-h3-libretech-all-h3-cc.dtb\"\n    DEVICE_TREES+=\" arch/arm/boot/dts/nxp/imx/imx6q-cubox-i.dtb\"\n    apt-get install -y libssl-dev:armhf\nelse\n    GCC_ARCH=\"x86_64-linux-gnu\"\n    DEBIAN_ARCH=\"x86_64\"\n    DEVICE_TREES=\"\"\nfi\n\nexport ARCH=${KERNEL_ARCH}\nexport CROSS_COMPILE=\"${GCC_ARCH}-\"\n\n# The kernel doesn't like the gold linker (or the old lld in our debians).\n# Sneak in some override symlinks during kernel build until we can update\n# debian.\nmkdir -p ld-links\nfor i in /usr/bin/*-ld /usr/bin/ld; do\n    i=$(basename $i)\n    ln -sf /usr/bin/$i.bfd ld-links/$i\ndone\n\nNEWPATH=$(pwd)/ld-links\nexport PATH=$NEWPATH:$PATH\n\ngit config --global user.email \"fdo@example.com\"\ngit config --global user.name \"freedesktop.org CI\"\ngit config --global pull.rebase true\n\n# Try to merge fixes from target repo\nif [ \"$(git ls-remote --exit-code --heads ${UPSTREAM_REPO} ${TARGET_BRANCH}-external-fixes)\" ]; then\n    git pull ${UPSTREAM_REPO} ${TARGET_BRANCH}-external-fixes\nfi\n\n# Try to merge fixes from local repo if this isn't a merge request\nif [ -z \"$CI_MERGE_REQUEST_PROJECT_PATH\" ]; then\n    if [ \"$(git ls-remote --exit-code --heads origin ${TARGET_BRANCH}-external-fixes)\" ]; then\n        git pull origin ${TARGET_BRANCH}-external-fixes\n    fi\nfi\n\nfor opt in $ENABLE_KCONFIGS; do\n  echo CONFIG_$opt=y >> drivers/gpu/drm/ci/${KERNEL_ARCH}.config\ndone\nfor opt in $DISABLE_KCONFIGS; do\n  echo CONFIG_$opt=n >> drivers/gpu/drm/ci/${KERNEL_ARCH}.config\ndone\n\nif [[ -n \"${MERGE_FRAGMENT}\" ]]; then\n    ./scripts/kconfig/merge_config.sh ${DEFCONFIG} drivers/gpu/drm/ci/${MERGE_FRAGMENT}\nelse\n    make `basename ${DEFCONFIG}`\nfi\n\nmake ${KERNEL_IMAGE_NAME}\n\nmkdir -p /lava-files/\nfor image in ${KERNEL_IMAGE_NAME}; do\n    cp arch/${KERNEL_ARCH}/boot/${image} /lava-files/.\ndone\n\nif [[ -n ${DEVICE_TREES} ]]; then\n    make dtbs\n    cp ${DEVICE_TREES} /lava-files/.\nfi\n\nmake modules\nmkdir -p install/modules/\nINSTALL_MOD_PATH=install/modules/ make modules_install\n\nif [[ ${DEBIAN_ARCH} = \"arm64\" ]]; then\n    make Image.lzma\n    mkimage \\\n        -f auto \\\n        -A arm \\\n        -O linux \\\n        -d arch/arm64/boot/Image.lzma \\\n        -C lzma\\\n        -b arch/arm64/boot/dts/qcom/sdm845-cheza-r3.dtb \\\n        /lava-files/cheza-kernel\n    KERNEL_IMAGE_NAME+=\" cheza-kernel\"\n\n    # Make a gzipped copy of the Image for db410c.\n    gzip -k /lava-files/Image\n    KERNEL_IMAGE_NAME+=\" Image.gz\"\nfi\n\n# Pass needed files to the test stage\nmkdir -p install\ncp -rfv .gitlab-ci/* install/.\ncp -rfv install/common install/ci-common\ncp -rfv drivers/gpu/drm/ci/* install/.\n\n. .gitlab-ci/container/container_post_build.sh\n\nif [[ \"$UPLOAD_TO_MINIO\" = \"1\" ]]; then\n    xz -7 -c -T${FDO_CI_CONCURRENT:-4} vmlinux > /lava-files/vmlinux.xz\n    FILES_TO_UPLOAD=\"$KERNEL_IMAGE_NAME vmlinux.xz\"\n\n    if [[ -n $DEVICE_TREES ]]; then\n        FILES_TO_UPLOAD=\"$FILES_TO_UPLOAD $(basename -a $DEVICE_TREES)\"\n    fi\n\n    for f in $FILES_TO_UPLOAD; do\n        ci-fairy s3cp --token-file \"${CI_JOB_JWT_FILE}\" /lava-files/$f \\\n                https://${PIPELINE_ARTIFACTS_BASE}/${DEBIAN_ARCH}/$f\n    done\n\n    S3_ARTIFACT_NAME=\"kernel-files.tar.zst\"\n    tar --zstd -cf $S3_ARTIFACT_NAME install\n    ci-fairy s3cp --token-file \"${CI_JOB_JWT_FILE}\" ${S3_ARTIFACT_NAME} https://${PIPELINE_ARTIFACTS_BASE}/${DEBIAN_ARCH}/${S3_ARTIFACT_NAME}\n\n    echo \"Download vmlinux.xz from https://${PIPELINE_ARTIFACTS_BASE}/${DEBIAN_ARCH}/vmlinux.xz\"\nfi\n\nmkdir -p artifacts/install/lib\nmv install/* artifacts/install/.\nrm -rf artifacts/install/modules\nln -s common artifacts/install/ci-common\n\nfor image in ${KERNEL_IMAGE_NAME}; do\n    cp /lava-files/$image artifacts/install/.\ndone\n\ntar -C artifacts -cf artifacts/install.tar install\nrm -rf artifacts/install\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}