{
  "module_name": "gitlab-ci.yml",
  "hash_id": "8f2c04f489785a0ed92153f8ec852713bd2890722d941ee4315cdcba315bac97",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/ci/gitlab-ci.yml",
  "human_readable_source": "variables:\n  DRM_CI_PROJECT_PATH: &drm-ci-project-path mesa/mesa\n  DRM_CI_COMMIT_SHA: &drm-ci-commit-sha 0dc961645c4f0241f8512cb0ec3ad59635842072\n\n  UPSTREAM_REPO: git://anongit.freedesktop.org/drm/drm\n  TARGET_BRANCH: drm-next\n\n  IGT_VERSION: 471bfababd070e1dac0ebb87470ac4f2ae85e663\n\n  DEQP_RUNNER_GIT_URL: https://gitlab.freedesktop.org/anholt/deqp-runner.git\n  DEQP_RUNNER_GIT_TAG: v0.15.0\n\n  FDO_UPSTREAM_REPO: helen.fornazier/linux   # The repo where the git-archive daily runs\n  MESA_TEMPLATES_COMMIT: &ci-templates-commit d5aa3941aa03c2f716595116354fb81eb8012acb\n  DRM_CI_PROJECT_URL: https://gitlab.freedesktop.org/${DRM_CI_PROJECT_PATH}\n  CI_PRE_CLONE_SCRIPT: |-\n          set -o xtrace\n          curl -L --retry 4 -f --retry-all-errors --retry-delay 60 -s ${DRM_CI_PROJECT_URL}/-/raw/${DRM_CI_COMMIT_SHA}/.gitlab-ci/download-git-cache.sh -o download-git-cache.sh\n          bash download-git-cache.sh\n          rm download-git-cache.sh\n          set +o xtrace\n  S3_HOST: s3.freedesktop.org\n  # per-pipeline artifact storage on MinIO\n  PIPELINE_ARTIFACTS_BASE: ${S3_HOST}/artifacts/${CI_PROJECT_PATH}/${CI_PIPELINE_ID}\n  # per-job artifact storage on MinIO\n  JOB_ARTIFACTS_BASE: ${PIPELINE_ARTIFACTS_BASE}/${CI_JOB_ID}\n\n  LAVA_JOB_PRIORITY: 30\n\ndefault:\n  before_script:\n    - export SCRIPTS_DIR=$(mktemp -d)\n    - curl -L -s --retry 4 -f --retry-all-errors --retry-delay 60 -O --output-dir \"${SCRIPTS_DIR}\" \"${DRM_CI_PROJECT_URL}/-/raw/${DRM_CI_COMMIT_SHA}/.gitlab-ci/setup-test-env.sh\"\n    - source ${SCRIPTS_DIR}/setup-test-env.sh\n    - echo -e \"\\e[0Ksection_start:$(date +%s):unset_env_vars_section[collapsed=true]\\r\\e[0KUnsetting vulnerable environment variables\"\n    - export CI_JOB_JWT_FILE=\"${CI_JOB_JWT_FILE:-$(mktemp)}\"\n    - echo -n \"${CI_JOB_JWT}\" > \"${CI_JOB_JWT_FILE}\"\n    - unset CI_JOB_JWT\n    - echo -e \"\\e[0Ksection_end:$(date +%s):unset_env_vars_section\\r\\e[0K\"\n\n    - echo -e \"\\e[0Ksection_start:$(date +%s):drm_ci_download_section[collapsed=true]\\r\\e[0KDownloading mesa from $DRM_CI_PROJECT_URL/-/archive/$DRM_CI_COMMIT_SHA/mesa-$DRM_CI_COMMIT_SHA.tar.gz\"\n    - cd $CI_PROJECT_DIR\n    - curl --output - $DRM_CI_PROJECT_URL/-/archive/$DRM_CI_COMMIT_SHA/mesa-$DRM_CI_COMMIT_SHA.tar.gz | tar -xz\n    - mv mesa-$DRM_CI_COMMIT_SHA/.gitlab-ci* .\n    - rm -rf mesa-$DRM_CI_COMMIT_SHA/\n    - echo -e \"\\e[0Ksection_end:$(date +%s):drm_ci_download_section\\r\\e[0K\"\n\n  after_script:\n    - >\n      set +x\n\n      test -e \"${CI_JOB_JWT_FILE}\" &&\n      export CI_JOB_JWT=\"$(<${CI_JOB_JWT_FILE})\" &&\n      rm \"${CI_JOB_JWT_FILE}\"\n\n  # Retry when job fails.\n  retry:\n    max: 1\n    # Ignore runner_unsupported, stale_schedule, archived_failure, or\n    # unmet_prerequisites\n    when:\n      - api_failure\n      - runner_system_failure\n      - script_failure\n      - job_execution_timeout\n      - scheduler_failure\n      - data_integrity_failure\n      - unknown_failure\n\ninclude:\n  - project: 'freedesktop/ci-templates'\n    ref: 16bc29078de5e0a067ff84a1a199a3760d3b3811\n    file:\n      - '/templates/ci-fairy.yml'\n  - project: 'freedesktop/ci-templates'\n    ref: *ci-templates-commit\n    file:\n      - '/templates/alpine.yml'\n      - '/templates/debian.yml'\n      - '/templates/fedora.yml'\n  - project: *drm-ci-project-path\n    ref: *drm-ci-commit-sha\n    file:\n      - '/.gitlab-ci/farm-rules.yml'\n      - '/.gitlab-ci/test-source-dep.yml'\n      - '/.gitlab-ci/container/gitlab-ci.yml'\n      - '/.gitlab-ci/test/gitlab-ci.yml'\n      - '/.gitlab-ci/lava/lava-gitlab-ci.yml'\n  - drivers/gpu/drm/ci/image-tags.yml\n  - drivers/gpu/drm/ci/container.yml\n  - drivers/gpu/drm/ci/static-checks.yml\n  - drivers/gpu/drm/ci/build.yml\n  - drivers/gpu/drm/ci/test.yml\n  - 'https://gitlab.freedesktop.org/gfx-ci/lab-status/-/raw/main/lab-status.yml'\n\n\nstages:\n  - sanity\n  - container\n  - git-archive\n  - build\n  - amdgpu\n  - i915\n  - mediatek\n  - meson\n  - msm\n  - rockchip\n  - virtio-gpu\n  - lint\n\n# YAML anchors for rule conditions\n# --------------------------------\n.rules-anchors:\n  rules:\n    # Pipeline for forked project branch\n    - if: &is-forked-branch '$CI_COMMIT_BRANCH && $CI_PROJECT_NAMESPACE != \"mesa\"'\n      when: manual\n    # Forked project branch / pre-merge pipeline not for Marge bot\n    - if: &is-forked-branch-or-pre-merge-not-for-marge '$CI_PROJECT_NAMESPACE != \"mesa\" || ($GITLAB_USER_LOGIN != \"marge-bot\" && $CI_PIPELINE_SOURCE == \"merge_request_event\")'\n      when: manual\n    # Pipeline runs for the main branch of the upstream Mesa project\n    - if: &is-mesa-main '$CI_PROJECT_NAMESPACE == \"mesa\" && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_COMMIT_BRANCH'\n      when: always\n    # Post-merge pipeline\n    - if: &is-post-merge '$CI_PROJECT_NAMESPACE == \"mesa\" && $CI_COMMIT_BRANCH'\n      when: on_success\n    # Post-merge pipeline, not for Marge Bot\n    - if: &is-post-merge-not-for-marge '$CI_PROJECT_NAMESPACE == \"mesa\" && $GITLAB_USER_LOGIN != \"marge-bot\" && $CI_COMMIT_BRANCH'\n      when: on_success\n    # Pre-merge pipeline\n    - if: &is-pre-merge '$CI_PIPELINE_SOURCE == \"merge_request_event\"'\n      when: on_success\n    # Pre-merge pipeline for Marge Bot\n    - if: &is-pre-merge-for-marge '$GITLAB_USER_LOGIN == \"marge-bot\" && $CI_PIPELINE_SOURCE == \"merge_request_event\"'\n      when: on_success\n\n# Rule to filter for only scheduled pipelines.\n.scheduled_pipeline-rules:\n  rules:\n    - if: &is-scheduled-pipeline '$CI_PIPELINE_SOURCE == \"schedule\"'\n      when: on_success\n\n# Generic rule to not run the job during scheduled pipelines. Jobs that aren't\n# something like a nightly run should include this rule.\n.no_scheduled_pipelines-rules:\n  rules:\n    - if: *is-scheduled-pipeline\n      when: never\n\n# When to automatically run the CI for build jobs\n.build-rules:\n  rules:\n    - !reference [.no_scheduled_pipelines-rules, rules]\n    # Run automatically once all dependency jobs have passed\n    - when: on_success\n\n\n.ci-deqp-artifacts:\n  artifacts:\n    name: \"mesa_${CI_JOB_NAME}\"\n    when: always\n    untracked: false\n    paths:\n      # Watch out!  Artifacts are relative to the build dir.\n      # https://gitlab.com/gitlab-org/gitlab-ce/commit/8788fb925706cad594adf6917a6c5f6587dd1521\n      - artifacts\n      - _build/meson-logs/*.txt\n      - _build/meson-logs/strace\n\n\n.container-rules:\n  rules:\n    - !reference [.no_scheduled_pipelines-rules, rules]\n    # Run pipeline by default in the main project if any CI pipeline\n    # configuration files were changed, to ensure docker images are up to date\n    - if: *is-post-merge\n      changes:\n      - drivers/gpu/drm/ci/**/*\n      when: on_success\n    # Run pipeline by default if it was triggered by Marge Bot, is for a\n    # merge request, and any files affecting the pipeline were changed\n    - if: *is-pre-merge-for-marge\n      when: on_success\n    # Run pipeline by default in the main project if it was not triggered by\n    # Marge Bot, and any files affecting the pipeline were changed\n    - if: *is-post-merge-not-for-marge\n      when: on_success\n    # Allow triggering jobs manually in other cases\n    - when: manual\n\n\n\n# Git archive\n\nmake git archive:\n  extends:\n    - .fdo.ci-fairy\n  stage: git-archive\n  rules:\n    - !reference [.scheduled_pipeline-rules, rules]\n  # ensure we are running on packet\n  tags:\n    - packet.net\n  script:\n    # Remove drm-ci files we just added\n    - rm -rf .gitlab-ci.*\n\n    # Compactify the .git directory\n    - git gc --aggressive\n    # compress the current folder\n    - tar -cvzf ../$CI_PROJECT_NAME.tar.gz .\n\n    # login with the JWT token file\n    - ci-fairy s3cp --token-file \"${CI_JOB_JWT_FILE}\" ../$CI_PROJECT_NAME.tar.gz https://$S3_HOST/git-cache/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PROJECT_NAME.tar.gz\n\n\n# Sanity checks of MR settings and commit logs\nsanity:\n  extends:\n    - .fdo.ci-fairy\n  stage: sanity\n  rules:\n    - if: *is-pre-merge\n      when: on_success\n    # Other cases default to never\n  variables:\n    GIT_STRATEGY: none\n  script:\n    # ci-fairy check-commits --junit-xml=check-commits.xml\n    - ci-fairy check-merge-request --require-allow-collaboration --junit-xml=check-merge-request.xml\n  artifacts:\n    when: on_failure\n    reports:\n      junit: check-*.xml\n\n# Rules for tests that should not block merging, but should be available to\n# optionally run with the \"play\" button in the UI in pre-merge non-marge\n# pipelines.  This should appear in \"extends:\" after any includes of\n# test-source-dep.yml rules, so that these rules replace those.\n.test-manual-mr:\n  rules:\n    - !reference [.no_scheduled_pipelines-rules, rules]\n    - if: *is-forked-branch-or-pre-merge-not-for-marge\n      when: manual\n  variables:\n    JOB_TIMEOUT: 80\n\n\n# Jobs that need to pass before spending hardware resources on further testing\n.required-for-hardware-jobs:\n  needs: []",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}