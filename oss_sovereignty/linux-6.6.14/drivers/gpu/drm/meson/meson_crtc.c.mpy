{
  "module_name": "meson_crtc.c",
  "hash_id": "f79c9d65e28ff6462a79335fa10ca00550af8cc430f3ff38268685d9806ee658",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/meson/meson_crtc.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/soc/amlogic/meson-canvas.h>\n\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_device.h>\n#include <drm/drm_print.h>\n#include <drm/drm_probe_helper.h>\n#include <drm/drm_vblank.h>\n\n#include \"meson_crtc.h\"\n#include \"meson_plane.h\"\n#include \"meson_registers.h\"\n#include \"meson_venc.h\"\n#include \"meson_viu.h\"\n#include \"meson_rdma.h\"\n#include \"meson_vpp.h\"\n#include \"meson_osd_afbcd.h\"\n\n#define MESON_G12A_VIU_OFFSET\t0x5ec0\n\n \n\nstruct meson_crtc {\n\tstruct drm_crtc base;\n\tstruct drm_pending_vblank_event *event;\n\tstruct meson_drm *priv;\n\tvoid (*enable_osd1)(struct meson_drm *priv);\n\tvoid (*enable_vd1)(struct meson_drm *priv);\n\tvoid (*enable_osd1_afbc)(struct meson_drm *priv);\n\tvoid (*disable_osd1_afbc)(struct meson_drm *priv);\n\tunsigned int viu_offset;\n\tbool vsync_forced;\n\tbool vsync_disabled;\n};\n#define to_meson_crtc(x) container_of(x, struct meson_crtc, base)\n\n \n\nstatic int meson_crtc_enable_vblank(struct drm_crtc *crtc)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tmeson_crtc->vsync_disabled = false;\n\tmeson_venc_enable_vsync(priv);\n\n\treturn 0;\n}\n\nstatic void meson_crtc_disable_vblank(struct drm_crtc *crtc)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tif (!meson_crtc->vsync_forced) {\n\t\tmeson_crtc->vsync_disabled = true;\n\t\tmeson_venc_disable_vsync(priv);\n\t}\n}\n\nstatic const struct drm_crtc_funcs meson_crtc_funcs = {\n\t.atomic_destroy_state\t= drm_atomic_helper_crtc_destroy_state,\n\t.atomic_duplicate_state = drm_atomic_helper_crtc_duplicate_state,\n\t.destroy\t\t= drm_crtc_cleanup,\n\t.page_flip\t\t= drm_atomic_helper_page_flip,\n\t.reset\t\t\t= drm_atomic_helper_crtc_reset,\n\t.set_config             = drm_atomic_helper_set_config,\n\t.enable_vblank\t\t= meson_crtc_enable_vblank,\n\t.disable_vblank\t\t= meson_crtc_disable_vblank,\n\n};\n\nstatic void meson_g12a_crtc_atomic_enable(struct drm_crtc *crtc,\n\t\t\t\t\t  struct drm_atomic_state *state)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct drm_crtc_state *crtc_state = crtc->state;\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tDRM_DEBUG_DRIVER(\"\\n\");\n\n\tif (!crtc_state) {\n\t\tDRM_ERROR(\"Invalid crtc_state\\n\");\n\t\treturn;\n\t}\n\n\t \n\twritel(FIELD_PREP(GENMASK(11, 0), 2303),\n\t       priv->io_base + _REG(VPP_PREBLEND_VD1_V_START_END));\n\n\t \n\twritel(crtc_state->mode.hdisplay |\n\t       crtc_state->mode.vdisplay << 16,\n\t       priv->io_base + _REG(VPP_POSTBLEND_H_SIZE));\n\n\twritel_relaxed(0 << 16 |\n\t\t\t(crtc_state->mode.hdisplay - 1),\n\t\t\tpriv->io_base + _REG(VPP_OSD1_BLD_H_SCOPE));\n\twritel_relaxed(0 << 16 |\n\t\t\t(crtc_state->mode.vdisplay - 1),\n\t\t\tpriv->io_base + _REG(VPP_OSD1_BLD_V_SCOPE));\n\twritel_relaxed(crtc_state->mode.hdisplay << 16 |\n\t\t\tcrtc_state->mode.vdisplay,\n\t\t\tpriv->io_base + _REG(VPP_OUT_H_V_SIZE));\n\n\tdrm_crtc_vblank_on(crtc);\n}\n\nstatic void meson_crtc_atomic_enable(struct drm_crtc *crtc,\n\t\t\t\t     struct drm_atomic_state *state)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct drm_crtc_state *crtc_state = crtc->state;\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tDRM_DEBUG_DRIVER(\"\\n\");\n\n\tif (!crtc_state) {\n\t\tDRM_ERROR(\"Invalid crtc_state\\n\");\n\t\treturn;\n\t}\n\n\t \n\twritel(crtc_state->mode.hdisplay,\n\t       priv->io_base + _REG(VPP_POSTBLEND_H_SIZE));\n\n\t \n\twritel(FIELD_PREP(GENMASK(11, 0), 2303),\n\t\t\tpriv->io_base + _REG(VPP_PREBLEND_VD1_V_START_END));\n\n\twritel_bits_relaxed(VPP_POSTBLEND_ENABLE, VPP_POSTBLEND_ENABLE,\n\t\t\t    priv->io_base + _REG(VPP_MISC));\n\n\tdrm_crtc_vblank_on(crtc);\n}\n\nstatic void meson_g12a_crtc_atomic_disable(struct drm_crtc *crtc,\n\t\t\t\t\t   struct drm_atomic_state *state)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tDRM_DEBUG_DRIVER(\"\\n\");\n\n\tdrm_crtc_vblank_off(crtc);\n\n\tpriv->viu.osd1_enabled = false;\n\tpriv->viu.osd1_commit = false;\n\n\tpriv->viu.vd1_enabled = false;\n\tpriv->viu.vd1_commit = false;\n\n\tif (crtc->state->event && !crtc->state->active) {\n\t\tspin_lock_irq(&crtc->dev->event_lock);\n\t\tdrm_crtc_send_vblank_event(crtc, crtc->state->event);\n\t\tspin_unlock_irq(&crtc->dev->event_lock);\n\n\t\tcrtc->state->event = NULL;\n\t}\n}\n\nstatic void meson_crtc_atomic_disable(struct drm_crtc *crtc,\n\t\t\t\t      struct drm_atomic_state *state)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tDRM_DEBUG_DRIVER(\"\\n\");\n\n\tdrm_crtc_vblank_off(crtc);\n\n\tpriv->viu.osd1_enabled = false;\n\tpriv->viu.osd1_commit = false;\n\n\tpriv->viu.vd1_enabled = false;\n\tpriv->viu.vd1_commit = false;\n\n\t \n\twritel_bits_relaxed(VPP_OSD1_POSTBLEND | VPP_VD1_POSTBLEND |\n\t\t\t    VPP_VD1_PREBLEND | VPP_POSTBLEND_ENABLE, 0,\n\t\t\t    priv->io_base + _REG(VPP_MISC));\n\n\tif (crtc->state->event && !crtc->state->active) {\n\t\tspin_lock_irq(&crtc->dev->event_lock);\n\t\tdrm_crtc_send_vblank_event(crtc, crtc->state->event);\n\t\tspin_unlock_irq(&crtc->dev->event_lock);\n\n\t\tcrtc->state->event = NULL;\n\t}\n}\n\nstatic void meson_crtc_atomic_begin(struct drm_crtc *crtc,\n\t\t\t\t    struct drm_atomic_state *state)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tunsigned long flags;\n\n\tif (crtc->state->event) {\n\t\tWARN_ON(drm_crtc_vblank_get(crtc) != 0);\n\n\t\tspin_lock_irqsave(&crtc->dev->event_lock, flags);\n\t\tmeson_crtc->event = crtc->state->event;\n\t\tspin_unlock_irqrestore(&crtc->dev->event_lock, flags);\n\t\tcrtc->state->event = NULL;\n\t}\n}\n\nstatic void meson_crtc_atomic_flush(struct drm_crtc *crtc,\n\t\t\t\t    struct drm_atomic_state *state)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\n\tstruct meson_drm *priv = meson_crtc->priv;\n\n\tpriv->viu.osd1_commit = true;\n\tpriv->viu.vd1_commit = true;\n}\n\nstatic const struct drm_crtc_helper_funcs meson_crtc_helper_funcs = {\n\t.atomic_begin\t= meson_crtc_atomic_begin,\n\t.atomic_flush\t= meson_crtc_atomic_flush,\n\t.atomic_enable\t= meson_crtc_atomic_enable,\n\t.atomic_disable\t= meson_crtc_atomic_disable,\n};\n\nstatic const struct drm_crtc_helper_funcs meson_g12a_crtc_helper_funcs = {\n\t.atomic_begin\t= meson_crtc_atomic_begin,\n\t.atomic_flush\t= meson_crtc_atomic_flush,\n\t.atomic_enable\t= meson_g12a_crtc_atomic_enable,\n\t.atomic_disable\t= meson_g12a_crtc_atomic_disable,\n};\n\nstatic void meson_crtc_enable_osd1(struct meson_drm *priv)\n{\n\twritel_bits_relaxed(VPP_OSD1_POSTBLEND, VPP_OSD1_POSTBLEND,\n\t\t\t    priv->io_base + _REG(VPP_MISC));\n}\n\nstatic void meson_crtc_g12a_enable_osd1_afbc(struct meson_drm *priv)\n{\n\twritel_relaxed(priv->viu.osd1_blk2_cfg4,\n\t\t       priv->io_base + _REG(VIU_OSD1_BLK2_CFG_W4));\n\n\twritel_bits_relaxed(OSD_MEM_LINEAR_ADDR, OSD_MEM_LINEAR_ADDR,\n\t\t\t    priv->io_base + _REG(VIU_OSD1_CTRL_STAT));\n\n\twritel_relaxed(priv->viu.osd1_blk1_cfg4,\n\t\t       priv->io_base + _REG(VIU_OSD1_BLK1_CFG_W4));\n\n\tmeson_viu_g12a_enable_osd1_afbc(priv);\n\n\twritel_bits_relaxed(OSD_MEM_LINEAR_ADDR, OSD_MEM_LINEAR_ADDR,\n\t\t\t    priv->io_base + _REG(VIU_OSD1_CTRL_STAT));\n\n\twritel_bits_relaxed(OSD_MALI_SRC_EN, OSD_MALI_SRC_EN,\n\t\t\t    priv->io_base + _REG(VIU_OSD1_BLK0_CFG_W0));\n}\n\nstatic void meson_g12a_crtc_enable_osd1(struct meson_drm *priv)\n{\n\twritel_relaxed(priv->viu.osd_blend_din0_scope_h,\n\t\t       priv->io_base +\n\t\t       _REG(VIU_OSD_BLEND_DIN0_SCOPE_H));\n\twritel_relaxed(priv->viu.osd_blend_din0_scope_v,\n\t\t       priv->io_base +\n\t\t       _REG(VIU_OSD_BLEND_DIN0_SCOPE_V));\n\twritel_relaxed(priv->viu.osb_blend0_size,\n\t\t       priv->io_base +\n\t\t       _REG(VIU_OSD_BLEND_BLEND0_SIZE));\n\twritel_relaxed(priv->viu.osb_blend1_size,\n\t\t       priv->io_base +\n\t\t       _REG(VIU_OSD_BLEND_BLEND1_SIZE));\n\twritel_bits_relaxed(3 << 8, 3 << 8,\n\t\t\t    priv->io_base + _REG(OSD1_BLEND_SRC_CTRL));\n}\n\nstatic void meson_crtc_enable_vd1(struct meson_drm *priv)\n{\n\twritel_bits_relaxed(VPP_VD1_PREBLEND | VPP_VD1_POSTBLEND |\n\t\t\t    VPP_COLOR_MNG_ENABLE,\n\t\t\t    VPP_VD1_PREBLEND | VPP_VD1_POSTBLEND |\n\t\t\t    VPP_COLOR_MNG_ENABLE,\n\t\t\t    priv->io_base + _REG(VPP_MISC));\n\n\twritel_bits_relaxed(VIU_CTRL0_AFBC_TO_VD1,\n\t\t\t    priv->viu.vd1_afbc ? VIU_CTRL0_AFBC_TO_VD1 : 0,\n\t\t\t    priv->io_base + _REG(VIU_MISC_CTRL0));\n}\n\nstatic void meson_g12a_crtc_enable_vd1(struct meson_drm *priv)\n{\n\twritel_relaxed(VD_BLEND_PREBLD_SRC_VD1 |\n\t\t       VD_BLEND_PREBLD_PREMULT_EN |\n\t\t       VD_BLEND_POSTBLD_SRC_VD1 |\n\t\t       VD_BLEND_POSTBLD_PREMULT_EN,\n\t\t       priv->io_base + _REG(VD1_BLEND_SRC_CTRL));\n\n\twritel_relaxed(priv->viu.vd1_afbc ?\n\t\t       (VD1_AXI_SEL_AFBC | AFBC_VD1_SEL) : 0,\n\t\t       priv->io_base + _REG(VD1_AFBCD0_MISC_CTRL));\n}\n\nvoid meson_crtc_irq(struct meson_drm *priv)\n{\n\tstruct meson_crtc *meson_crtc = to_meson_crtc(priv->crtc);\n\tunsigned long flags;\n\n\t \n\tif (priv->viu.osd1_enabled && priv->viu.osd1_commit) {\n\t\twritel_relaxed(priv->viu.osd1_ctrl_stat,\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_CTRL_STAT));\n\t\twritel_relaxed(priv->viu.osd1_ctrl_stat2,\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_CTRL_STAT2));\n\t\twritel_relaxed(priv->viu.osd1_blk0_cfg[0],\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W0));\n\t\twritel_relaxed(priv->viu.osd1_blk0_cfg[1],\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W1));\n\t\twritel_relaxed(priv->viu.osd1_blk0_cfg[2],\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W2));\n\t\twritel_relaxed(priv->viu.osd1_blk0_cfg[3],\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W3));\n\t\twritel_relaxed(priv->viu.osd1_blk0_cfg[4],\n\t\t\t\tpriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W4));\n\n\t\tif (priv->viu.osd1_afbcd) {\n\t\t\tif (meson_crtc->enable_osd1_afbc)\n\t\t\t\tmeson_crtc->enable_osd1_afbc(priv);\n\t\t} else {\n\t\t\tif (meson_crtc->disable_osd1_afbc)\n\t\t\t\tmeson_crtc->disable_osd1_afbc(priv);\n\t\t\tif (priv->afbcd.ops) {\n\t\t\t\tpriv->afbcd.ops->reset(priv);\n\t\t\t\tpriv->afbcd.ops->disable(priv);\n\t\t\t}\n\t\t\tmeson_crtc->vsync_forced = false;\n\t\t}\n\n\t\twritel_relaxed(priv->viu.osd_sc_ctrl0,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_SC_CTRL0));\n\t\twritel_relaxed(priv->viu.osd_sc_i_wh_m1,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_SCI_WH_M1));\n\t\twritel_relaxed(priv->viu.osd_sc_o_h_start_end,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_SCO_H_START_END));\n\t\twritel_relaxed(priv->viu.osd_sc_o_v_start_end,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_SCO_V_START_END));\n\t\twritel_relaxed(priv->viu.osd_sc_v_ini_phase,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_VSC_INI_PHASE));\n\t\twritel_relaxed(priv->viu.osd_sc_v_phase_step,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_VSC_PHASE_STEP));\n\t\twritel_relaxed(priv->viu.osd_sc_h_ini_phase,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_HSC_INI_PHASE));\n\t\twritel_relaxed(priv->viu.osd_sc_h_phase_step,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_HSC_PHASE_STEP));\n\t\twritel_relaxed(priv->viu.osd_sc_h_ctrl0,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_HSC_CTRL0));\n\t\twritel_relaxed(priv->viu.osd_sc_v_ctrl0,\n\t\t\t\tpriv->io_base + _REG(VPP_OSD_VSC_CTRL0));\n\n\t\tif (!priv->viu.osd1_afbcd)\n\t\t\tmeson_canvas_config(priv->canvas, priv->canvas_id_osd1,\n\t\t\t\t\t    priv->viu.osd1_addr,\n\t\t\t\t\t    priv->viu.osd1_stride,\n\t\t\t\t\t    priv->viu.osd1_height,\n\t\t\t\t\t    MESON_CANVAS_WRAP_NONE,\n\t\t\t\t\t    MESON_CANVAS_BLKMODE_LINEAR, 0);\n\n\t\t \n\t\tif (meson_crtc->enable_osd1)\n\t\t\tmeson_crtc->enable_osd1(priv);\n\n\t\tif (priv->viu.osd1_afbcd) {\n\t\t\tpriv->afbcd.ops->reset(priv);\n\t\t\tpriv->afbcd.ops->setup(priv);\n\t\t\tpriv->afbcd.ops->enable(priv);\n\t\t\tmeson_crtc->vsync_forced = true;\n\t\t}\n\n\t\tpriv->viu.osd1_commit = false;\n\t}\n\n\t \n\tif (priv->viu.vd1_enabled && priv->viu.vd1_commit) {\n\n\t\tif (priv->viu.vd1_afbc) {\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_head_addr,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_HEAD_BADDR));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_body_addr,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_BODY_BADDR));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_en,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_ENABLE));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_mode,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_MODE));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_size_in,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_SIZE_IN));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_dec_def_color,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_DEC_DEF_COLOR));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_conv_ctrl,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_CONV_CTRL));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_size_out,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_SIZE_OUT));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_vd_cfmt_ctrl,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_VD_CFMT_CTRL));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_vd_cfmt_w,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_VD_CFMT_W));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_mif_hor_scope,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_MIF_HOR_SCOPE));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_mif_ver_scope,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_MIF_VER_SCOPE));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_pixel_hor_scope,\n\t\t\t\t       priv->io_base+\n\t\t\t\t       _REG(AFBC_PIXEL_HOR_SCOPE));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_pixel_ver_scope,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_PIXEL_VER_SCOPE));\n\t\t\twritel_relaxed(priv->viu.vd1_afbc_vd_cfmt_h,\n\t\t\t\t       priv->io_base +\n\t\t\t\t       _REG(AFBC_VD_CFMT_H));\n\t\t} else {\n\t\t\tswitch (priv->viu.vd1_planes) {\n\t\t\tcase 3:\n\t\t\t\tmeson_canvas_config(priv->canvas,\n\t\t\t\t\t\t    priv->canvas_id_vd1_2,\n\t\t\t\t\t\t    priv->viu.vd1_addr2,\n\t\t\t\t\t\t    priv->viu.vd1_stride2,\n\t\t\t\t\t\t    priv->viu.vd1_height2,\n\t\t\t\t\t\t    MESON_CANVAS_WRAP_NONE,\n\t\t\t\t\t\t    MESON_CANVAS_BLKMODE_LINEAR,\n\t\t\t\t\t\t    MESON_CANVAS_ENDIAN_SWAP64);\n\t\t\t\tfallthrough;\n\t\t\tcase 2:\n\t\t\t\tmeson_canvas_config(priv->canvas,\n\t\t\t\t\t\t    priv->canvas_id_vd1_1,\n\t\t\t\t\t\t    priv->viu.vd1_addr1,\n\t\t\t\t\t\t    priv->viu.vd1_stride1,\n\t\t\t\t\t\t    priv->viu.vd1_height1,\n\t\t\t\t\t\t    MESON_CANVAS_WRAP_NONE,\n\t\t\t\t\t\t    MESON_CANVAS_BLKMODE_LINEAR,\n\t\t\t\t\t\t    MESON_CANVAS_ENDIAN_SWAP64);\n\t\t\t\tfallthrough;\n\t\t\tcase 1:\n\t\t\t\tmeson_canvas_config(priv->canvas,\n\t\t\t\t\t\t    priv->canvas_id_vd1_0,\n\t\t\t\t\t\t    priv->viu.vd1_addr0,\n\t\t\t\t\t\t    priv->viu.vd1_stride0,\n\t\t\t\t\t\t    priv->viu.vd1_height0,\n\t\t\t\t\t\t    MESON_CANVAS_WRAP_NONE,\n\t\t\t\t\t\t    MESON_CANVAS_BLKMODE_LINEAR,\n\t\t\t\t\t\t    MESON_CANVAS_ENDIAN_SWAP64);\n\t\t\t}\n\n\t\t\twritel_relaxed(0, priv->io_base + _REG(AFBC_ENABLE));\n\t\t}\n\n\t\twritel_relaxed(priv->viu.vd1_if0_gen_reg,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_GEN_REG));\n\t\twritel_relaxed(priv->viu.vd1_if0_gen_reg,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_GEN_REG));\n\t\twritel_relaxed(priv->viu.vd1_if0_gen_reg2,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_GEN_REG2));\n\t\twritel_relaxed(priv->viu.viu_vd1_fmt_ctrl,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VIU_VD1_FMT_CTRL));\n\t\twritel_relaxed(priv->viu.viu_vd1_fmt_ctrl,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VIU_VD2_FMT_CTRL));\n\t\twritel_relaxed(priv->viu.viu_vd1_fmt_w,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VIU_VD1_FMT_W));\n\t\twritel_relaxed(priv->viu.viu_vd1_fmt_w,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VIU_VD2_FMT_W));\n\t\twritel_relaxed(priv->viu.vd1_if0_canvas0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CANVAS0));\n\t\twritel_relaxed(priv->viu.vd1_if0_canvas0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CANVAS1));\n\t\twritel_relaxed(priv->viu.vd1_if0_canvas0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CANVAS0));\n\t\twritel_relaxed(priv->viu.vd1_if0_canvas0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CANVAS1));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA_X0));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA_X1));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA_X0));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA_X1));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA_Y0));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA_Y1));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA_Y0));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA_Y1));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA_X0));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA_X1));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA_X0));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_x0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA_X1));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA_Y0));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA_Y1));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA_Y0));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma_y0,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA_Y1));\n\t\twritel_relaxed(priv->viu.vd1_if0_repeat_loop,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_RPT_LOOP));\n\t\twritel_relaxed(priv->viu.vd1_if0_repeat_loop,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_RPT_LOOP));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA0_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA0_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA1_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_luma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA1_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA0_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA0_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA1_RPT_PAT));\n\t\twritel_relaxed(priv->viu.vd1_if0_chroma0_rpt_pat,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA1_RPT_PAT));\n\t\twritel_relaxed(0, priv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_LUMA_PSEL));\n\t\twritel_relaxed(0, priv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_CHROMA_PSEL));\n\t\twritel_relaxed(0, priv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_LUMA_PSEL));\n\t\twritel_relaxed(0, priv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD2_IF0_CHROMA_PSEL));\n\t\twritel_relaxed(priv->viu.vd1_range_map_y,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_RANGE_MAP_Y));\n\t\twritel_relaxed(priv->viu.vd1_range_map_cb,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_RANGE_MAP_CB));\n\t\twritel_relaxed(priv->viu.vd1_range_map_cr,\n\t\t\t\tpriv->io_base + meson_crtc->viu_offset +\n\t\t\t\t_REG(VD1_IF0_RANGE_MAP_CR));\n\t\twritel_relaxed(VPP_VSC_BANK_LENGTH(4) |\n\t\t\t       VPP_HSC_BANK_LENGTH(4) |\n\t\t\t       VPP_SC_VD_EN_ENABLE |\n\t\t\t       VPP_SC_TOP_EN_ENABLE |\n\t\t\t       VPP_SC_HSC_EN_ENABLE |\n\t\t\t       VPP_SC_VSC_EN_ENABLE,\n\t\t\t\tpriv->io_base + _REG(VPP_SC_MISC));\n\t\twritel_relaxed(priv->viu.vpp_pic_in_height,\n\t\t\t\tpriv->io_base + _REG(VPP_PIC_IN_HEIGHT));\n\t\twritel_relaxed(priv->viu.vpp_postblend_vd1_h_start_end,\n\t\t\tpriv->io_base + _REG(VPP_POSTBLEND_VD1_H_START_END));\n\t\twritel_relaxed(priv->viu.vpp_blend_vd2_h_start_end,\n\t\t\tpriv->io_base + _REG(VPP_BLEND_VD2_H_START_END));\n\t\twritel_relaxed(priv->viu.vpp_postblend_vd1_v_start_end,\n\t\t\tpriv->io_base + _REG(VPP_POSTBLEND_VD1_V_START_END));\n\t\twritel_relaxed(priv->viu.vpp_blend_vd2_v_start_end,\n\t\t\tpriv->io_base + _REG(VPP_BLEND_VD2_V_START_END));\n\t\twritel_relaxed(priv->viu.vpp_hsc_region12_startp,\n\t\t\t\tpriv->io_base + _REG(VPP_HSC_REGION12_STARTP));\n\t\twritel_relaxed(priv->viu.vpp_hsc_region34_startp,\n\t\t\t\tpriv->io_base + _REG(VPP_HSC_REGION34_STARTP));\n\t\twritel_relaxed(priv->viu.vpp_hsc_region4_endp,\n\t\t\t\tpriv->io_base + _REG(VPP_HSC_REGION4_ENDP));\n\t\twritel_relaxed(priv->viu.vpp_hsc_start_phase_step,\n\t\t\t\tpriv->io_base + _REG(VPP_HSC_START_PHASE_STEP));\n\t\twritel_relaxed(priv->viu.vpp_hsc_region1_phase_slope,\n\t\t\tpriv->io_base + _REG(VPP_HSC_REGION1_PHASE_SLOPE));\n\t\twritel_relaxed(priv->viu.vpp_hsc_region3_phase_slope,\n\t\t\tpriv->io_base + _REG(VPP_HSC_REGION3_PHASE_SLOPE));\n\t\twritel_relaxed(priv->viu.vpp_line_in_length,\n\t\t\t\tpriv->io_base + _REG(VPP_LINE_IN_LENGTH));\n\t\twritel_relaxed(priv->viu.vpp_preblend_h_size,\n\t\t\t\tpriv->io_base + _REG(VPP_PREBLEND_H_SIZE));\n\t\twritel_relaxed(priv->viu.vpp_vsc_region12_startp,\n\t\t\t\tpriv->io_base + _REG(VPP_VSC_REGION12_STARTP));\n\t\twritel_relaxed(priv->viu.vpp_vsc_region34_startp,\n\t\t\t\tpriv->io_base + _REG(VPP_VSC_REGION34_STARTP));\n\t\twritel_relaxed(priv->viu.vpp_vsc_region4_endp,\n\t\t\t\tpriv->io_base + _REG(VPP_VSC_REGION4_ENDP));\n\t\twritel_relaxed(priv->viu.vpp_vsc_start_phase_step,\n\t\t\t\tpriv->io_base + _REG(VPP_VSC_START_PHASE_STEP));\n\t\twritel_relaxed(priv->viu.vpp_vsc_ini_phase,\n\t\t\t\tpriv->io_base + _REG(VPP_VSC_INI_PHASE));\n\t\twritel_relaxed(priv->viu.vpp_vsc_phase_ctrl,\n\t\t\t\tpriv->io_base + _REG(VPP_VSC_PHASE_CTRL));\n\t\twritel_relaxed(priv->viu.vpp_hsc_phase_ctrl,\n\t\t\t\tpriv->io_base + _REG(VPP_HSC_PHASE_CTRL));\n\t\twritel_relaxed(0x42, priv->io_base + _REG(VPP_SCALE_COEF_IDX));\n\n\t\t \n\t\tif (meson_crtc->enable_vd1)\n\t\t\tmeson_crtc->enable_vd1(priv);\n\n\t\tpriv->viu.vd1_commit = false;\n\t}\n\n\tif (meson_crtc->vsync_disabled)\n\t\treturn;\n\n\tdrm_crtc_handle_vblank(priv->crtc);\n\n\tspin_lock_irqsave(&priv->drm->event_lock, flags);\n\tif (meson_crtc->event) {\n\t\tdrm_crtc_send_vblank_event(priv->crtc, meson_crtc->event);\n\t\tdrm_crtc_vblank_put(priv->crtc);\n\t\tmeson_crtc->event = NULL;\n\t}\n\tspin_unlock_irqrestore(&priv->drm->event_lock, flags);\n}\n\nint meson_crtc_create(struct meson_drm *priv)\n{\n\tstruct meson_crtc *meson_crtc;\n\tstruct drm_crtc *crtc;\n\tint ret;\n\n\tmeson_crtc = devm_kzalloc(priv->drm->dev, sizeof(*meson_crtc),\n\t\t\t\t  GFP_KERNEL);\n\tif (!meson_crtc)\n\t\treturn -ENOMEM;\n\n\tmeson_crtc->priv = priv;\n\tcrtc = &meson_crtc->base;\n\tret = drm_crtc_init_with_planes(priv->drm, crtc,\n\t\t\t\t\tpriv->primary_plane, NULL,\n\t\t\t\t\t&meson_crtc_funcs, \"meson_crtc\");\n\tif (ret) {\n\t\tdev_err(priv->drm->dev, \"Failed to init CRTC\\n\");\n\t\treturn ret;\n\t}\n\n\tif (meson_vpu_is_compatible(priv, VPU_COMPATIBLE_G12A)) {\n\t\tmeson_crtc->enable_osd1 = meson_g12a_crtc_enable_osd1;\n\t\tmeson_crtc->enable_vd1 = meson_g12a_crtc_enable_vd1;\n\t\tmeson_crtc->viu_offset = MESON_G12A_VIU_OFFSET;\n\t\tmeson_crtc->enable_osd1_afbc =\n\t\t\t\t\tmeson_crtc_g12a_enable_osd1_afbc;\n\t\tmeson_crtc->disable_osd1_afbc =\n\t\t\t\t\tmeson_viu_g12a_disable_osd1_afbc;\n\t\tdrm_crtc_helper_add(crtc, &meson_g12a_crtc_helper_funcs);\n\t} else {\n\t\tmeson_crtc->enable_osd1 = meson_crtc_enable_osd1;\n\t\tmeson_crtc->enable_vd1 = meson_crtc_enable_vd1;\n\t\tif (meson_vpu_is_compatible(priv, VPU_COMPATIBLE_GXM)) {\n\t\t\tmeson_crtc->enable_osd1_afbc =\n\t\t\t\t\tmeson_viu_gxm_enable_osd1_afbc;\n\t\t\tmeson_crtc->disable_osd1_afbc =\n\t\t\t\t\tmeson_viu_gxm_disable_osd1_afbc;\n\t\t}\n\t\tdrm_crtc_helper_add(crtc, &meson_crtc_helper_funcs);\n\t}\n\n\tpriv->crtc = crtc;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}