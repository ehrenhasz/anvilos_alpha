{
  "module_name": "meson_venc.c",
  "hash_id": "62ad150b563fc3b5e1d49ffd305dae174ad3ff7add819aaafc86572c6486363c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/meson/meson_venc.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/export.h>\n#include <linux/iopoll.h>\n\n#include <drm/drm_modes.h>\n\n#include \"meson_drv.h\"\n#include \"meson_registers.h\"\n#include \"meson_venc.h\"\n#include \"meson_vpp.h\"\n\n \n\n \n#define HHI_GCLK_MPEG2\t\t0x148  \n#define HHI_VDAC_CNTL0\t\t0x2F4  \n#define HHI_VDAC_CNTL0_G12A\t0x2EC  \n#define HHI_VDAC_CNTL1\t\t0x2F8  \n#define HHI_VDAC_CNTL1_G12A\t0x2F0  \n#define HHI_HDMI_PHY_CNTL0\t0x3a0  \n\nstruct meson_cvbs_enci_mode meson_cvbs_enci_pal = {\n\t.mode_tag = MESON_VENC_MODE_CVBS_PAL,\n\t.hso_begin = 3,\n\t.hso_end = 129,\n\t.vso_even = 3,\n\t.vso_odd = 260,\n\t.macv_max_amp = 7,\n\t.video_prog_mode = 0xff,\n\t.video_mode = 0x13,\n\t.sch_adjust = 0x28,\n\t.yc_delay = 0x343,\n\t.pixel_start = 251,\n\t.pixel_end = 1691,\n\t.top_field_line_start = 22,\n\t.top_field_line_end = 310,\n\t.bottom_field_line_start = 23,\n\t.bottom_field_line_end = 311,\n\t.video_saturation = 9,\n\t.video_contrast = 0,\n\t.video_brightness = 0,\n\t.video_hue = 0,\n\t.analog_sync_adj = 0x8080,\n};\n\nstruct meson_cvbs_enci_mode meson_cvbs_enci_ntsc = {\n\t.mode_tag = MESON_VENC_MODE_CVBS_NTSC,\n\t.hso_begin = 5,\n\t.hso_end = 129,\n\t.vso_even = 3,\n\t.vso_odd = 260,\n\t.macv_max_amp = 0xb,\n\t.video_prog_mode = 0xf0,\n\t.video_mode = 0x8,\n\t.sch_adjust = 0x20,\n\t.yc_delay = 0x333,\n\t.pixel_start = 227,\n\t.pixel_end = 1667,\n\t.top_field_line_start = 18,\n\t.top_field_line_end = 258,\n\t.bottom_field_line_start = 19,\n\t.bottom_field_line_end = 259,\n\t.video_saturation = 18,\n\t.video_contrast = 3,\n\t.video_brightness = 0,\n\t.video_hue = 0,\n\t.analog_sync_adj = 0x9c00,\n};\n\nunion meson_hdmi_venc_mode {\n\tstruct {\n\t\tunsigned int mode_tag;\n\t\tunsigned int hso_begin;\n\t\tunsigned int hso_end;\n\t\tunsigned int vso_even;\n\t\tunsigned int vso_odd;\n\t\tunsigned int macv_max_amp;\n\t\tunsigned int video_prog_mode;\n\t\tunsigned int video_mode;\n\t\tunsigned int sch_adjust;\n\t\tunsigned int yc_delay;\n\t\tunsigned int pixel_start;\n\t\tunsigned int pixel_end;\n\t\tunsigned int top_field_line_start;\n\t\tunsigned int top_field_line_end;\n\t\tunsigned int bottom_field_line_start;\n\t\tunsigned int bottom_field_line_end;\n\t} enci;\n\tstruct {\n\t\tunsigned int dvi_settings;\n\t\tunsigned int video_mode;\n\t\tunsigned int video_mode_adv;\n\t\tunsigned int video_prog_mode;\n\t\tbool video_prog_mode_present;\n\t\tunsigned int video_sync_mode;\n\t\tbool video_sync_mode_present;\n\t\tunsigned int video_yc_dly;\n\t\tbool video_yc_dly_present;\n\t\tunsigned int video_rgb_ctrl;\n\t\tbool video_rgb_ctrl_present;\n\t\tunsigned int video_filt_ctrl;\n\t\tbool video_filt_ctrl_present;\n\t\tunsigned int video_ofld_voav_ofst;\n\t\tbool video_ofld_voav_ofst_present;\n\t\tunsigned int yfp1_htime;\n\t\tunsigned int yfp2_htime;\n\t\tunsigned int max_pxcnt;\n\t\tunsigned int hspuls_begin;\n\t\tunsigned int hspuls_end;\n\t\tunsigned int hspuls_switch;\n\t\tunsigned int vspuls_begin;\n\t\tunsigned int vspuls_end;\n\t\tunsigned int vspuls_bline;\n\t\tunsigned int vspuls_eline;\n\t\tunsigned int eqpuls_begin;\n\t\tbool eqpuls_begin_present;\n\t\tunsigned int eqpuls_end;\n\t\tbool eqpuls_end_present;\n\t\tunsigned int eqpuls_bline;\n\t\tbool eqpuls_bline_present;\n\t\tunsigned int eqpuls_eline;\n\t\tbool eqpuls_eline_present;\n\t\tunsigned int havon_begin;\n\t\tunsigned int havon_end;\n\t\tunsigned int vavon_bline;\n\t\tunsigned int vavon_eline;\n\t\tunsigned int hso_begin;\n\t\tunsigned int hso_end;\n\t\tunsigned int vso_begin;\n\t\tunsigned int vso_end;\n\t\tunsigned int vso_bline;\n\t\tunsigned int vso_eline;\n\t\tbool vso_eline_present;\n\t\tunsigned int sy_val;\n\t\tbool sy_val_present;\n\t\tunsigned int sy2_val;\n\t\tbool sy2_val_present;\n\t\tunsigned int max_lncnt;\n\t} encp;\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_enci_mode_480i = {\n\t.enci = {\n\t\t.hso_begin = 5,\n\t\t.hso_end = 129,\n\t\t.vso_even = 3,\n\t\t.vso_odd = 260,\n\t\t.macv_max_amp = 0xb,\n\t\t.video_prog_mode = 0xf0,\n\t\t.video_mode = 0x8,\n\t\t.sch_adjust = 0x20,\n\t\t.yc_delay = 0,\n\t\t.pixel_start = 227,\n\t\t.pixel_end = 1667,\n\t\t.top_field_line_start = 18,\n\t\t.top_field_line_end = 258,\n\t\t.bottom_field_line_start = 19,\n\t\t.bottom_field_line_end = 259,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_enci_mode_576i = {\n\t.enci = {\n\t\t.hso_begin = 3,\n\t\t.hso_end = 129,\n\t\t.vso_even = 3,\n\t\t.vso_odd = 260,\n\t\t.macv_max_amp = 0x7,\n\t\t.video_prog_mode = 0xff,\n\t\t.video_mode = 0x13,\n\t\t.sch_adjust = 0x28,\n\t\t.yc_delay = 0x333,\n\t\t.pixel_start = 251,\n\t\t.pixel_end = 1691,\n\t\t.top_field_line_start = 22,\n\t\t.top_field_line_end = 310,\n\t\t.bottom_field_line_start = 23,\n\t\t.bottom_field_line_end = 311,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_480p = {\n\t.encp = {\n\t\t.dvi_settings = 0x21,\n\t\t.video_mode = 0x4000,\n\t\t.video_mode_adv = 0x9,\n\t\t.video_prog_mode = 0,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 7,\n\t\t.video_sync_mode_present = true,\n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x2052,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 244,\n\t\t.yfp2_htime = 1630,\n\t\t.max_pxcnt = 1715,\n\t\t.hspuls_begin = 0x22,\n\t\t.hspuls_end = 0xa0,\n\t\t.hspuls_switch = 88,\n\t\t.vspuls_begin = 0,\n\t\t.vspuls_end = 1589,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 5,\n\t\t.havon_begin = 249,\n\t\t.havon_end = 1689,\n\t\t.vavon_bline = 42,\n\t\t.vavon_eline = 521,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 3,\n\t\t.hso_end = 5,\n\t\t.vso_begin = 3,\n\t\t.vso_end = 5,\n\t\t.vso_bline = 0,\n\t\t \n\t\t.sy_val\t= 8,\n\t\t.sy_val_present = true,\n\t\t.sy2_val = 0x1d8,\n\t\t.sy2_val_present = true,\n\t\t.max_lncnt = 524,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_576p = {\n\t.encp = {\n\t\t.dvi_settings = 0x21,\n\t\t.video_mode = 0x4000,\n\t\t.video_mode_adv = 0x9,\n\t\t.video_prog_mode = 0,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 7,\n\t\t.video_sync_mode_present = true,\n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x52,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 235,\n\t\t.yfp2_htime = 1674,\n\t\t.max_pxcnt = 1727,\n\t\t.hspuls_begin = 0,\n\t\t.hspuls_end = 0x80,\n\t\t.hspuls_switch = 88,\n\t\t.vspuls_begin = 0,\n\t\t.vspuls_end = 1599,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 235,\n\t\t.havon_end = 1674,\n\t\t.vavon_bline = 44,\n\t\t.vavon_eline = 619,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 0x80,\n\t\t.hso_end = 0,\n\t\t.vso_begin = 0,\n\t\t.vso_end = 5,\n\t\t.vso_bline = 0,\n\t\t \n\t\t.sy_val\t= 8,\n\t\t.sy_val_present = true,\n\t\t.sy2_val = 0x1d8,\n\t\t.sy2_val_present = true,\n\t\t.max_lncnt = 624,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_720p60 = {\n\t.encp = {\n\t\t.dvi_settings = 0x2029,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x19,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.yfp1_htime = 648,\n\t\t.yfp2_htime = 3207,\n\t\t.max_pxcnt = 3299,\n\t\t.hspuls_begin = 80,\n\t\t.hspuls_end = 240,\n\t\t.hspuls_switch = 80,\n\t\t.vspuls_begin = 688,\n\t\t.vspuls_end = 3248,\n\t\t.vspuls_bline = 4,\n\t\t.vspuls_eline = 8,\n\t\t.havon_begin = 648,\n\t\t.havon_end = 3207,\n\t\t.vavon_bline = 29,\n\t\t.vavon_eline = 748,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 256,\n\t\t.hso_end = 168,\n\t\t.vso_begin = 168,\n\t\t.vso_end = 256,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 749,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_720p50 = {\n\t.encp = {\n\t\t.dvi_settings = 0x202d,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x19,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 0x407,\n\t\t.video_sync_mode_present = true,\n\t\t.video_yc_dly = 0,\n\t\t.video_yc_dly_present = true,\n\t\t \n\t\t \n\t\t \n\t\t.yfp1_htime = 648,\n\t\t.yfp2_htime = 3207,\n\t\t.max_pxcnt = 3959,\n\t\t.hspuls_begin = 80,\n\t\t.hspuls_end = 240,\n\t\t.hspuls_switch = 80,\n\t\t.vspuls_begin = 688,\n\t\t.vspuls_end = 3248,\n\t\t.vspuls_bline = 4,\n\t\t.vspuls_eline = 8,\n\t\t.havon_begin = 648,\n\t\t.havon_end = 3207,\n\t\t.vavon_bline = 29,\n\t\t.vavon_eline = 748,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 128,\n\t\t.hso_end = 208,\n\t\t.vso_begin = 128,\n\t\t.vso_end = 128,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 749,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_1080i60 = {\n\t.encp = {\n\t\t.dvi_settings = 0x2029,\n\t\t.video_mode = 0x5ffc,\n\t\t.video_mode_adv = 0x19,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 0x207,\n\t\t.video_sync_mode_present = true,\n\t\t \n\t\t \n\t\t \n\t\t.video_ofld_voav_ofst = 0x11,\n\t\t.video_ofld_voav_ofst_present = true,\n\t\t.yfp1_htime = 516,\n\t\t.yfp2_htime = 4355,\n\t\t.max_pxcnt = 4399,\n\t\t.hspuls_begin = 88,\n\t\t.hspuls_end = 264,\n\t\t.hspuls_switch = 88,\n\t\t.vspuls_begin = 440,\n\t\t.vspuls_end = 2200,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 516,\n\t\t.havon_end = 4355,\n\t\t.vavon_bline = 20,\n\t\t.vavon_eline = 559,\n\t\t.eqpuls_begin = 2288,\n\t\t.eqpuls_begin_present = true,\n\t\t.eqpuls_end = 2464,\n\t\t.eqpuls_end_present = true,\n\t\t.eqpuls_bline = 0,\n\t\t.eqpuls_bline_present = true,\n\t\t.eqpuls_eline = 4,\n\t\t.eqpuls_eline_present = true,\n\t\t.hso_begin = 264,\n\t\t.hso_end = 176,\n\t\t.vso_begin = 88,\n\t\t.vso_end = 88,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 1124,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_1080i50 = {\n\t.encp = {\n\t\t.dvi_settings = 0x202d,\n\t\t.video_mode = 0x5ffc,\n\t\t.video_mode_adv = 0x19,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 0x7,\n\t\t.video_sync_mode_present = true,\n\t\t \n\t\t \n\t\t \n\t\t.video_ofld_voav_ofst = 0x11,\n\t\t.video_ofld_voav_ofst_present = true,\n\t\t.yfp1_htime = 526,\n\t\t.yfp2_htime = 4365,\n\t\t.max_pxcnt = 5279,\n\t\t.hspuls_begin = 88,\n\t\t.hspuls_end = 264,\n\t\t.hspuls_switch = 88,\n\t\t.vspuls_begin = 440,\n\t\t.vspuls_end = 2200,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 526,\n\t\t.havon_end = 4365,\n\t\t.vavon_bline = 20,\n\t\t.vavon_eline = 559,\n\t\t.eqpuls_begin = 2288,\n\t\t.eqpuls_begin_present = true,\n\t\t.eqpuls_end = 2464,\n\t\t.eqpuls_end_present = true,\n\t\t.eqpuls_bline = 0,\n\t\t.eqpuls_bline_present = true,\n\t\t.eqpuls_eline = 4,\n\t\t.eqpuls_eline_present = true,\n\t\t.hso_begin = 142,\n\t\t.hso_end = 230,\n\t\t.vso_begin = 142,\n\t\t.vso_end = 142,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 1124,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_1080p24 = {\n\t.encp = {\n\t\t.dvi_settings = 0xd,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x18,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 0x7,\n\t\t.video_sync_mode_present = true,\n\t\t.video_yc_dly = 0,\n\t\t.video_yc_dly_present = true,\n\t\t.video_rgb_ctrl = 2,\n\t\t.video_rgb_ctrl_present = true,\n\t\t.video_filt_ctrl = 0x1052,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 271,\n\t\t.yfp2_htime = 2190,\n\t\t.max_pxcnt = 2749,\n\t\t.hspuls_begin = 44,\n\t\t.hspuls_end = 132,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 220,\n\t\t.vspuls_end = 2140,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 271,\n\t\t.havon_end = 2190,\n\t\t.vavon_bline = 41,\n\t\t.vavon_eline = 1120,\n\t\t \n\t\t \n\t\t.eqpuls_bline = 0,\n\t\t.eqpuls_bline_present = true,\n\t\t.eqpuls_eline = 4,\n\t\t.eqpuls_eline_present = true,\n\t\t.hso_begin = 79,\n\t\t.hso_end = 123,\n\t\t.vso_begin = 79,\n\t\t.vso_end = 79,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 1124,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_1080p30 = {\n\t.encp = {\n\t\t.dvi_settings = 0x1,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x18,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t \n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x1052,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 140,\n\t\t.yfp2_htime = 2060,\n\t\t.max_pxcnt = 2199,\n\t\t.hspuls_begin = 2156,\n\t\t.hspuls_end = 44,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 140,\n\t\t.vspuls_end = 2059,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 148,\n\t\t.havon_end = 2067,\n\t\t.vavon_bline = 41,\n\t\t.vavon_eline = 1120,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 44,\n\t\t.hso_end = 2156,\n\t\t.vso_begin = 2100,\n\t\t.vso_end = 2164,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 1124,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_1080p50 = {\n\t.encp = {\n\t\t.dvi_settings = 0xd,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x18,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t.video_sync_mode = 0x7,\n\t\t.video_sync_mode_present = true,\n\t\t.video_yc_dly = 0,\n\t\t.video_yc_dly_present = true,\n\t\t.video_rgb_ctrl = 2,\n\t\t.video_rgb_ctrl_present = true,\n\t\t \n\t\t \n\t\t.yfp1_htime = 271,\n\t\t.yfp2_htime = 2190,\n\t\t.max_pxcnt = 2639,\n\t\t.hspuls_begin = 44,\n\t\t.hspuls_end = 132,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 220,\n\t\t.vspuls_end = 2140,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 271,\n\t\t.havon_end = 2190,\n\t\t.vavon_bline = 41,\n\t\t.vavon_eline = 1120,\n\t\t \n\t\t \n\t\t.eqpuls_bline = 0,\n\t\t.eqpuls_bline_present = true,\n\t\t.eqpuls_eline = 4,\n\t\t.eqpuls_eline_present = true,\n\t\t.hso_begin = 79,\n\t\t.hso_end = 123,\n\t\t.vso_begin = 79,\n\t\t.vso_end = 79,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 1124,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_1080p60 = {\n\t.encp = {\n\t\t.dvi_settings = 0x1,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x18,\n\t\t.video_prog_mode = 0x100,\n\t\t.video_prog_mode_present = true,\n\t\t \n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x1052,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 140,\n\t\t.yfp2_htime = 2060,\n\t\t.max_pxcnt = 2199,\n\t\t.hspuls_begin = 2156,\n\t\t.hspuls_end = 44,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 140,\n\t\t.vspuls_end = 2059,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 148,\n\t\t.havon_end = 2067,\n\t\t.vavon_bline = 41,\n\t\t.vavon_eline = 1120,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 44,\n\t\t.hso_end = 2156,\n\t\t.vso_begin = 2100,\n\t\t.vso_end = 2164,\n\t\t.vso_bline = 0,\n\t\t.vso_eline = 5,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 1124,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_2160p24 = {\n\t.encp = {\n\t\t.dvi_settings = 0x1,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x8,\n\t\t \n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x1000,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 140,\n\t\t.yfp2_htime = 140+3840,\n\t\t.max_pxcnt = 3840+1660-1,\n\t\t.hspuls_begin = 2156+1920,\n\t\t.hspuls_end = 44,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 140,\n\t\t.vspuls_end = 2059+1920,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 148,\n\t\t.havon_end = 3987,\n\t\t.vavon_bline = 89,\n\t\t.vavon_eline = 2248,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 44,\n\t\t.hso_end = 2156+1920,\n\t\t.vso_begin = 2100+1920,\n\t\t.vso_end = 2164+1920,\n\t\t.vso_bline = 51,\n\t\t.vso_eline = 53,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 2249,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_2160p25 = {\n\t.encp = {\n\t\t.dvi_settings = 0x1,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x8,\n\t\t \n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x1000,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 140,\n\t\t.yfp2_htime = 140+3840,\n\t\t.max_pxcnt = 3840+1440-1,\n\t\t.hspuls_begin = 2156+1920,\n\t\t.hspuls_end = 44,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 140,\n\t\t.vspuls_end = 2059+1920,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 148,\n\t\t.havon_end = 3987,\n\t\t.vavon_bline = 89,\n\t\t.vavon_eline = 2248,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 44,\n\t\t.hso_end = 2156+1920,\n\t\t.vso_begin = 2100+1920,\n\t\t.vso_end = 2164+1920,\n\t\t.vso_bline = 51,\n\t\t.vso_eline = 53,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 2249,\n\t},\n};\n\nstatic union meson_hdmi_venc_mode meson_hdmi_encp_mode_2160p30 = {\n\t.encp = {\n\t\t.dvi_settings = 0x1,\n\t\t.video_mode = 0x4040,\n\t\t.video_mode_adv = 0x8,\n\t\t \n\t\t \n\t\t \n\t\t.video_filt_ctrl = 0x1000,\n\t\t.video_filt_ctrl_present = true,\n\t\t \n\t\t.yfp1_htime = 140,\n\t\t.yfp2_htime = 140+3840,\n\t\t.max_pxcnt = 3840+560-1,\n\t\t.hspuls_begin = 2156+1920,\n\t\t.hspuls_end = 44,\n\t\t.hspuls_switch = 44,\n\t\t.vspuls_begin = 140,\n\t\t.vspuls_end = 2059+1920,\n\t\t.vspuls_bline = 0,\n\t\t.vspuls_eline = 4,\n\t\t.havon_begin = 148,\n\t\t.havon_end = 3987,\n\t\t.vavon_bline = 89,\n\t\t.vavon_eline = 2248,\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t.hso_begin = 44,\n\t\t.hso_end = 2156+1920,\n\t\t.vso_begin = 2100+1920,\n\t\t.vso_end = 2164+1920,\n\t\t.vso_bline = 51,\n\t\t.vso_eline = 53,\n\t\t.vso_eline_present = true,\n\t\t \n\t\t \n\t\t.max_lncnt = 2249,\n\t},\n};\n\nstatic struct meson_hdmi_venc_vic_mode {\n\tunsigned int vic;\n\tunion meson_hdmi_venc_mode *mode;\n} meson_hdmi_venc_vic_modes[] = {\n\t{ 6, &meson_hdmi_enci_mode_480i },\n\t{ 7, &meson_hdmi_enci_mode_480i },\n\t{ 21, &meson_hdmi_enci_mode_576i },\n\t{ 22, &meson_hdmi_enci_mode_576i },\n\t{ 2, &meson_hdmi_encp_mode_480p },\n\t{ 3, &meson_hdmi_encp_mode_480p },\n\t{ 17, &meson_hdmi_encp_mode_576p },\n\t{ 18, &meson_hdmi_encp_mode_576p },\n\t{ 4, &meson_hdmi_encp_mode_720p60 },\n\t{ 19, &meson_hdmi_encp_mode_720p50 },\n\t{ 5, &meson_hdmi_encp_mode_1080i60 },\n\t{ 20, &meson_hdmi_encp_mode_1080i50 },\n\t{ 32, &meson_hdmi_encp_mode_1080p24 },\n\t{ 33, &meson_hdmi_encp_mode_1080p50 },\n\t{ 34, &meson_hdmi_encp_mode_1080p30 },\n\t{ 31, &meson_hdmi_encp_mode_1080p50 },\n\t{ 16, &meson_hdmi_encp_mode_1080p60 },\n\t{ 93, &meson_hdmi_encp_mode_2160p24 },\n\t{ 94, &meson_hdmi_encp_mode_2160p25 },\n\t{ 95, &meson_hdmi_encp_mode_2160p30 },\n\t{ 96, &meson_hdmi_encp_mode_2160p25 },\n\t{ 97, &meson_hdmi_encp_mode_2160p30 },\n\t{ 0, NULL},  \n};\n\nstatic signed int to_signed(unsigned int a)\n{\n\tif (a <= 7)\n\t\treturn a;\n\telse\n\t\treturn a - 16;\n}\n\nstatic unsigned long modulo(unsigned long a, unsigned long b)\n{\n\tif (a >= b)\n\t\treturn a - b;\n\telse\n\t\treturn a;\n}\n\nenum drm_mode_status\nmeson_venc_hdmi_supported_mode(const struct drm_display_mode *mode)\n{\n\tif (mode->flags & ~(DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_NHSYNC |\n\t\t\t    DRM_MODE_FLAG_PVSYNC | DRM_MODE_FLAG_NVSYNC))\n\t\treturn MODE_BAD;\n\n\tif (mode->hdisplay < 400 || mode->hdisplay > 1920)\n\t\treturn MODE_BAD_HVALUE;\n\n\tif (mode->vdisplay < 480 || mode->vdisplay > 1920)\n\t\treturn MODE_BAD_VVALUE;\n\n\treturn MODE_OK;\n}\nEXPORT_SYMBOL_GPL(meson_venc_hdmi_supported_mode);\n\nbool meson_venc_hdmi_supported_vic(int vic)\n{\n\tstruct meson_hdmi_venc_vic_mode *vmode = meson_hdmi_venc_vic_modes;\n\n\twhile (vmode->vic && vmode->mode) {\n\t\tif (vmode->vic == vic)\n\t\t\treturn true;\n\t\tvmode++;\n\t}\n\n\treturn false;\n}\nEXPORT_SYMBOL_GPL(meson_venc_hdmi_supported_vic);\n\nstatic void meson_venc_hdmi_get_dmt_vmode(const struct drm_display_mode *mode,\n\t\t\t\t\t  union meson_hdmi_venc_mode *dmt_mode)\n{\n\tmemset(dmt_mode, 0, sizeof(*dmt_mode));\n\n\tdmt_mode->encp.dvi_settings = 0x21;\n\tdmt_mode->encp.video_mode = 0x4040;\n\tdmt_mode->encp.video_mode_adv = 0x18;\n\tdmt_mode->encp.max_pxcnt = mode->htotal - 1;\n\tdmt_mode->encp.havon_begin = mode->htotal - mode->hsync_start;\n\tdmt_mode->encp.havon_end = dmt_mode->encp.havon_begin +\n\t\t\t\t   mode->hdisplay - 1;\n\tdmt_mode->encp.vavon_bline = mode->vtotal - mode->vsync_start;\n\tdmt_mode->encp.vavon_eline = dmt_mode->encp.vavon_bline +\n\t\t\t\t     mode->vdisplay - 1;\n\tdmt_mode->encp.hso_begin = 0;\n\tdmt_mode->encp.hso_end = mode->hsync_end - mode->hsync_start;\n\tdmt_mode->encp.vso_begin = 30;\n\tdmt_mode->encp.vso_end = 50;\n\tdmt_mode->encp.vso_bline = 0;\n\tdmt_mode->encp.vso_eline = mode->vsync_end - mode->vsync_start;\n\tdmt_mode->encp.vso_eline_present = true;\n\tdmt_mode->encp.max_lncnt = mode->vtotal - 1;\n}\n\nstatic union meson_hdmi_venc_mode *meson_venc_hdmi_get_vic_vmode(int vic)\n{\n\tstruct meson_hdmi_venc_vic_mode *vmode = meson_hdmi_venc_vic_modes;\n\n\twhile (vmode->vic && vmode->mode) {\n\t\tif (vmode->vic == vic)\n\t\t\treturn vmode->mode;\n\t\tvmode++;\n\t}\n\n\treturn NULL;\n}\n\nbool meson_venc_hdmi_venc_repeat(int vic)\n{\n\t \n\tif (vic == 6 || vic == 7 ||  \n\t    vic == 21 || vic == 22 ||  \n\t    vic == 17 || vic == 18 ||  \n\t    vic == 2 || vic == 3 ||  \n\t    vic == 4 ||  \n\t    vic == 19 ||  \n\t    vic == 5 ||  \n\t    vic == 20)\t \n\t\treturn true;\n\n\treturn false;\n}\nEXPORT_SYMBOL_GPL(meson_venc_hdmi_venc_repeat);\n\nvoid meson_venc_hdmi_mode_set(struct meson_drm *priv, int vic,\n\t\t\t      unsigned int ycrcb_map,\n\t\t\t      bool yuv420_mode,\n\t\t\t      const struct drm_display_mode *mode)\n{\n\tunion meson_hdmi_venc_mode *vmode = NULL;\n\tunion meson_hdmi_venc_mode vmode_dmt;\n\tbool use_enci = false;\n\tbool venc_repeat = false;\n\tbool hdmi_repeat = false;\n\tunsigned int venc_hdmi_latency = 2;\n\tunsigned long total_pixels_venc = 0;\n\tunsigned long active_pixels_venc = 0;\n\tunsigned long front_porch_venc = 0;\n\tunsigned long hsync_pixels_venc = 0;\n\tunsigned long de_h_begin = 0;\n\tunsigned long de_h_end = 0;\n\tunsigned long de_v_begin_even = 0;\n\tunsigned long de_v_end_even = 0;\n\tunsigned long de_v_begin_odd = 0;\n\tunsigned long de_v_end_odd = 0;\n\tunsigned long hs_begin = 0;\n\tunsigned long hs_end = 0;\n\tunsigned long vs_adjust = 0;\n\tunsigned long vs_bline_evn = 0;\n\tunsigned long vs_eline_evn = 0;\n\tunsigned long vs_bline_odd = 0;\n\tunsigned long vs_eline_odd = 0;\n\tunsigned long vso_begin_evn = 0;\n\tunsigned long vso_begin_odd = 0;\n\tunsigned int eof_lines;\n\tunsigned int sof_lines;\n\tunsigned int vsync_lines;\n\tu32 reg;\n\n\t \n\tif (mode->flags & DRM_MODE_FLAG_DBLCLK) {\n\t\thdmi_repeat = true;\n\t\tuse_enci = true;\n\t\tvenc_hdmi_latency = 1;\n\t}\n\n\tif (meson_venc_hdmi_supported_vic(vic)) {\n\t\tvmode = meson_venc_hdmi_get_vic_vmode(vic);\n\t\tif (!vmode) {\n\t\t\tdev_err(priv->dev, \"%s: Fatal Error, unsupported mode \"\n\t\t\t\tDRM_MODE_FMT \"\\n\", __func__,\n\t\t\t\tDRM_MODE_ARG(mode));\n\t\t\treturn;\n\t\t}\n\t} else {\n\t\tmeson_venc_hdmi_get_dmt_vmode(mode, &vmode_dmt);\n\t\tvmode = &vmode_dmt;\n\t\tuse_enci = false;\n\t}\n\n\t \n\tif (meson_venc_hdmi_venc_repeat(vic))\n\t\tvenc_repeat = true;\n\n\teof_lines = mode->vsync_start - mode->vdisplay;\n\tif (mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\teof_lines /= 2;\n\tsof_lines = mode->vtotal - mode->vsync_end;\n\tif (mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\tsof_lines /= 2;\n\tvsync_lines = mode->vsync_end - mode->vsync_start;\n\tif (mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\tvsync_lines /= 2;\n\n\ttotal_pixels_venc = mode->htotal;\n\tif (hdmi_repeat)\n\t\ttotal_pixels_venc /= 2;\n\tif (venc_repeat)\n\t\ttotal_pixels_venc *= 2;\n\n\tactive_pixels_venc = mode->hdisplay;\n\tif (hdmi_repeat)\n\t\tactive_pixels_venc /= 2;\n\tif (venc_repeat)\n\t\tactive_pixels_venc *= 2;\n\n\tfront_porch_venc = (mode->hsync_start - mode->hdisplay);\n\tif (hdmi_repeat)\n\t\tfront_porch_venc /= 2;\n\tif (venc_repeat)\n\t\tfront_porch_venc *= 2;\n\n\thsync_pixels_venc = (mode->hsync_end - mode->hsync_start);\n\tif (hdmi_repeat)\n\t\thsync_pixels_venc /= 2;\n\tif (venc_repeat)\n\t\thsync_pixels_venc *= 2;\n\n\t \n\twritel_bits_relaxed(0xff, 0xff,\n\t\t\tpriv->io_base + _REG(VENC_VDAC_SETTING));\n\n\twritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_EN));\n\twritel_relaxed(0, priv->io_base + _REG(ENCP_VIDEO_EN));\n\n\tif (use_enci) {\n\t\tunsigned int lines_f0;\n\t\tunsigned int lines_f1;\n\n\t\t \n\t\twritel_relaxed(ENCI_CFILT_CMPT_SEL_HIGH | 0x10,\n\t\t\t       priv->io_base + _REG(ENCI_CFILT_CTRL));\n\t\twritel_relaxed(ENCI_CFILT_CMPT_CR_DLY(2) |\n\t\t\t       ENCI_CFILT_CMPT_CB_DLY(1),\n\t\t\t       priv->io_base + _REG(ENCI_CFILT_CTRL2));\n\n\t\t \n\t\twritel_relaxed(0, priv->io_base + _REG(VENC_DVI_SETTING));\n\n\t\t \n\t\twritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE));\n\t\twritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\n\n\t\t \n\t\twritel_relaxed(vmode->enci.hso_begin,\n\t\t\t\tpriv->io_base + _REG(ENCI_SYNC_HSO_BEGIN));\n\t\twritel_relaxed(vmode->enci.hso_end,\n\t\t\t\tpriv->io_base + _REG(ENCI_SYNC_HSO_END));\n\n\t\t \n\t\twritel_relaxed(vmode->enci.vso_even,\n\t\t\t\tpriv->io_base + _REG(ENCI_SYNC_VSO_EVNLN));\n\t\twritel_relaxed(vmode->enci.vso_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_SYNC_VSO_ODDLN));\n\n\t\t \n\t\twritel_relaxed(ENCI_MACV_MAX_AMP_ENABLE_CHANGE |\n\t\t\t       ENCI_MACV_MAX_AMP_VAL(vmode->enci.macv_max_amp),\n\t\t\t       priv->io_base + _REG(ENCI_MACV_MAX_AMP));\n\n\t\t \n\t\twritel_relaxed(vmode->enci.video_prog_mode,\n\t\t\t\tpriv->io_base + _REG(VENC_VIDEO_PROG_MODE));\n\t\twritel_relaxed(vmode->enci.video_mode,\n\t\t\t\tpriv->io_base + _REG(ENCI_VIDEO_MODE));\n\n\t\t \n\t\twritel_relaxed(ENCI_VIDEO_MODE_ADV_DMXMD(2) |\n\t\t\t       ENCI_VIDEO_MODE_ADV_VBICTL_LINE_17_22 |\n\t\t\t       ENCI_VIDEO_MODE_ADV_YBW_HIGH,\n\t\t\t       priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\n\n\t\twritel(vmode->enci.sch_adjust,\n\t\t\t\tpriv->io_base + _REG(ENCI_VIDEO_SCH));\n\n\t\t \n\t\twritel_relaxed(0x07, priv->io_base + _REG(ENCI_SYNC_MODE));\n\n\t\tif (vmode->enci.yc_delay)\n\t\t\twritel_relaxed(vmode->enci.yc_delay,\n\t\t\t\t\tpriv->io_base + _REG(ENCI_YC_DELAY));\n\n\n\t\t \n\t\twritel_relaxed(0, priv->io_base + _REG(ENCI_DBG_PX_RST));\n\n\t\t \n\t\twritel_relaxed(ENCI_VFIFO2VD_CTL_ENABLE |\n\t\t\t       ENCI_VFIFO2VD_CTL_VD_SEL(0x4e),\n\t\t\t       priv->io_base + _REG(ENCI_VFIFO2VD_CTL));\n\n\t\t \n\t\twritel_relaxed(vmode->enci.pixel_start,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_START));\n\t\twritel_relaxed(vmode->enci.pixel_end,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_END));\n\n\t\twritel_relaxed(vmode->enci.top_field_line_start,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_START));\n\t\twritel_relaxed(vmode->enci.top_field_line_end,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_END));\n\n\t\twritel_relaxed(vmode->enci.bottom_field_line_start,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_START));\n\t\twritel_relaxed(vmode->enci.bottom_field_line_end,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_END));\n\n\t\t \n\t\tmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCI);\n\n\t\t \n\t\twritel_relaxed(ENCI_VIDEO_EN_ENABLE,\n\t\t\t       priv->io_base + _REG(ENCI_VIDEO_EN));\n\n\t\tlines_f0 = mode->vtotal >> 1;\n\t\tlines_f1 = lines_f0 + 1;\n\n\t\tde_h_begin = modulo(readl_relaxed(priv->io_base +\n\t\t\t\t\t_REG(ENCI_VFIFO2VD_PIXEL_START))\n\t\t\t\t\t+ venc_hdmi_latency,\n\t\t\t\t    total_pixels_venc);\n\t\tde_h_end  = modulo(de_h_begin + active_pixels_venc,\n\t\t\t\t   total_pixels_venc);\n\n\t\twritel_relaxed(de_h_begin,\n\t\t\t\tpriv->io_base + _REG(ENCI_DE_H_BEGIN));\n\t\twritel_relaxed(de_h_end,\n\t\t\t\tpriv->io_base + _REG(ENCI_DE_H_END));\n\n\t\tde_v_begin_even = readl_relaxed(priv->io_base +\n\t\t\t\t\t_REG(ENCI_VFIFO2VD_LINE_TOP_START));\n\t\tde_v_end_even  = de_v_begin_even + mode->vdisplay;\n\t\tde_v_begin_odd = readl_relaxed(priv->io_base +\n\t\t\t\t\t_REG(ENCI_VFIFO2VD_LINE_BOT_START));\n\t\tde_v_end_odd = de_v_begin_odd + mode->vdisplay;\n\n\t\twritel_relaxed(de_v_begin_even,\n\t\t\t\tpriv->io_base + _REG(ENCI_DE_V_BEGIN_EVEN));\n\t\twritel_relaxed(de_v_end_even,\n\t\t\t\tpriv->io_base + _REG(ENCI_DE_V_END_EVEN));\n\t\twritel_relaxed(de_v_begin_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DE_V_BEGIN_ODD));\n\t\twritel_relaxed(de_v_end_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DE_V_END_ODD));\n\n\t\t \n\t\ths_begin = de_h_end + front_porch_venc;\n\t\tif (de_h_end + front_porch_venc >= total_pixels_venc) {\n\t\t\ths_begin -= total_pixels_venc;\n\t\t\tvs_adjust  = 1;\n\t\t} else {\n\t\t\ths_begin = de_h_end + front_porch_venc;\n\t\t\tvs_adjust  = 0;\n\t\t}\n\n\t\ths_end = modulo(hs_begin + hsync_pixels_venc,\n\t\t\t\ttotal_pixels_venc);\n\t\twritel_relaxed(hs_begin,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_HSO_BEGIN));\n\t\twritel_relaxed(hs_end,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_HSO_END));\n\n\t\t \n\t\tif (((de_v_end_odd - 1) + eof_lines + vs_adjust) >= lines_f1) {\n\t\t\tvs_bline_evn = (de_v_end_odd - 1)\n\t\t\t\t\t+ eof_lines\n\t\t\t\t\t+ vs_adjust\n\t\t\t\t\t- lines_f1;\n\t\t\tvs_eline_evn = vs_bline_evn + vsync_lines;\n\n\t\t\twritel_relaxed(vs_bline_evn,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BLINE_EVN));\n\n\t\t\twritel_relaxed(vs_eline_evn,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_ELINE_EVN));\n\n\t\t\twritel_relaxed(hs_begin,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BEGIN_EVN));\n\t\t\twritel_relaxed(hs_begin,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_END_EVN));\n\t\t} else {\n\t\t\tvs_bline_odd = (de_v_end_odd - 1)\n\t\t\t\t\t+ eof_lines\n\t\t\t\t\t+ vs_adjust;\n\n\t\t\twritel_relaxed(vs_bline_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BLINE_ODD));\n\n\t\t\twritel_relaxed(hs_begin,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BEGIN_ODD));\n\n\t\t\tif ((vs_bline_odd + vsync_lines) >= lines_f1) {\n\t\t\t\tvs_eline_evn = vs_bline_odd\n\t\t\t\t\t\t+ vsync_lines\n\t\t\t\t\t\t- lines_f1;\n\n\t\t\t\twritel_relaxed(vs_eline_evn, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_ELINE_EVN));\n\n\t\t\t\twritel_relaxed(hs_begin, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_END_EVN));\n\t\t\t} else {\n\t\t\t\tvs_eline_odd = vs_bline_odd\n\t\t\t\t\t\t+ vsync_lines;\n\n\t\t\t\twritel_relaxed(vs_eline_odd, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_ELINE_ODD));\n\n\t\t\t\twritel_relaxed(hs_begin, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_END_ODD));\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (((de_v_end_even - 1) + (eof_lines + 1)) >= lines_f0) {\n\t\t\tvs_bline_odd = (de_v_end_even - 1)\n\t\t\t\t\t+ (eof_lines + 1)\n\t\t\t\t\t- lines_f0;\n\t\t\tvs_eline_odd = vs_bline_odd + vsync_lines;\n\n\t\t\twritel_relaxed(vs_bline_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BLINE_ODD));\n\n\t\t\twritel_relaxed(vs_eline_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_ELINE_ODD));\n\n\t\t\tvso_begin_odd  = modulo(hs_begin\n\t\t\t\t\t\t+ (total_pixels_venc >> 1),\n\t\t\t\t\t\ttotal_pixels_venc);\n\n\t\t\twritel_relaxed(vso_begin_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BEGIN_ODD));\n\t\t\twritel_relaxed(vso_begin_odd,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_END_ODD));\n\t\t} else {\n\t\t\tvs_bline_evn = (de_v_end_even - 1)\n\t\t\t\t\t+ (eof_lines + 1);\n\n\t\t\twritel_relaxed(vs_bline_evn,\n\t\t\t\tpriv->io_base + _REG(ENCI_DVI_VSO_BLINE_EVN));\n\n\t\t\tvso_begin_evn  = modulo(hs_begin\n\t\t\t\t\t\t+ (total_pixels_venc >> 1),\n\t\t\t\t\t\ttotal_pixels_venc);\n\n\t\t\twritel_relaxed(vso_begin_evn, priv->io_base\n\t\t\t\t\t+ _REG(ENCI_DVI_VSO_BEGIN_EVN));\n\n\t\t\tif (vs_bline_evn + vsync_lines >= lines_f0) {\n\t\t\t\tvs_eline_odd = vs_bline_evn\n\t\t\t\t\t\t+ vsync_lines\n\t\t\t\t\t\t- lines_f0;\n\n\t\t\t\twritel_relaxed(vs_eline_odd, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_ELINE_ODD));\n\n\t\t\t\twritel_relaxed(vso_begin_evn, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_END_ODD));\n\t\t\t} else {\n\t\t\t\tvs_eline_evn = vs_bline_evn + vsync_lines;\n\n\t\t\t\twritel_relaxed(vs_eline_evn, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_ELINE_EVN));\n\n\t\t\t\twritel_relaxed(vso_begin_evn, priv->io_base\n\t\t\t\t\t\t+ _REG(ENCI_DVI_VSO_END_EVN));\n\t\t\t}\n\t\t}\n\t} else {\n\t\twritel_relaxed(vmode->encp.dvi_settings,\n\t\t\t\tpriv->io_base + _REG(VENC_DVI_SETTING));\n\t\twritel_relaxed(vmode->encp.video_mode,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_MODE));\n\t\twritel_relaxed(vmode->encp.video_mode_adv,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_MODE_ADV));\n\t\tif (vmode->encp.video_prog_mode_present)\n\t\t\twritel_relaxed(vmode->encp.video_prog_mode,\n\t\t\t\tpriv->io_base + _REG(VENC_VIDEO_PROG_MODE));\n\t\tif (vmode->encp.video_sync_mode_present)\n\t\t\twritel_relaxed(vmode->encp.video_sync_mode,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_SYNC_MODE));\n\t\tif (vmode->encp.video_yc_dly_present)\n\t\t\twritel_relaxed(vmode->encp.video_yc_dly,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_YC_DLY));\n\t\tif (vmode->encp.video_rgb_ctrl_present)\n\t\t\twritel_relaxed(vmode->encp.video_rgb_ctrl,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_RGB_CTRL));\n\t\tif (vmode->encp.video_filt_ctrl_present)\n\t\t\twritel_relaxed(vmode->encp.video_filt_ctrl,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_FILT_CTRL));\n\t\tif (vmode->encp.video_ofld_voav_ofst_present)\n\t\t\twritel_relaxed(vmode->encp.video_ofld_voav_ofst,\n\t\t\t\tpriv->io_base\n\t\t\t\t+ _REG(ENCP_VIDEO_OFLD_VOAV_OFST));\n\t\twritel_relaxed(vmode->encp.yfp1_htime,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_YFP1_HTIME));\n\t\twritel_relaxed(vmode->encp.yfp2_htime,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_YFP2_HTIME));\n\t\twritel_relaxed(vmode->encp.max_pxcnt,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_MAX_PXCNT));\n\t\twritel_relaxed(vmode->encp.hspuls_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HSPULS_BEGIN));\n\t\twritel_relaxed(vmode->encp.hspuls_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HSPULS_END));\n\t\twritel_relaxed(vmode->encp.hspuls_switch,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HSPULS_SWITCH));\n\t\twritel_relaxed(vmode->encp.vspuls_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSPULS_BEGIN));\n\t\twritel_relaxed(vmode->encp.vspuls_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSPULS_END));\n\t\twritel_relaxed(vmode->encp.vspuls_bline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSPULS_BLINE));\n\t\twritel_relaxed(vmode->encp.vspuls_eline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSPULS_ELINE));\n\t\tif (vmode->encp.eqpuls_begin_present)\n\t\t\twritel_relaxed(vmode->encp.eqpuls_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_EQPULS_BEGIN));\n\t\tif (vmode->encp.eqpuls_end_present)\n\t\t\twritel_relaxed(vmode->encp.eqpuls_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_EQPULS_END));\n\t\tif (vmode->encp.eqpuls_bline_present)\n\t\t\twritel_relaxed(vmode->encp.eqpuls_bline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_EQPULS_BLINE));\n\t\tif (vmode->encp.eqpuls_eline_present)\n\t\t\twritel_relaxed(vmode->encp.eqpuls_eline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_EQPULS_ELINE));\n\t\twritel_relaxed(vmode->encp.havon_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HAVON_BEGIN));\n\t\twritel_relaxed(vmode->encp.havon_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HAVON_END));\n\t\twritel_relaxed(vmode->encp.vavon_bline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VAVON_BLINE));\n\t\twritel_relaxed(vmode->encp.vavon_eline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VAVON_ELINE));\n\t\twritel_relaxed(vmode->encp.hso_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HSO_BEGIN));\n\t\twritel_relaxed(vmode->encp.hso_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_HSO_END));\n\t\twritel_relaxed(vmode->encp.vso_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSO_BEGIN));\n\t\twritel_relaxed(vmode->encp.vso_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSO_END));\n\t\twritel_relaxed(vmode->encp.vso_bline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSO_BLINE));\n\t\tif (vmode->encp.vso_eline_present)\n\t\t\twritel_relaxed(vmode->encp.vso_eline,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_VSO_ELINE));\n\t\tif (vmode->encp.sy_val_present)\n\t\t\twritel_relaxed(vmode->encp.sy_val,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_SY_VAL));\n\t\tif (vmode->encp.sy2_val_present)\n\t\t\twritel_relaxed(vmode->encp.sy2_val,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_SY2_VAL));\n\t\twritel_relaxed(vmode->encp.max_lncnt,\n\t\t\t\tpriv->io_base + _REG(ENCP_VIDEO_MAX_LNCNT));\n\n\t\twritel_relaxed(1, priv->io_base + _REG(ENCP_VIDEO_EN));\n\n\t\t \n\t\twritel_bits_relaxed(ENCP_VIDEO_MODE_DE_V_HIGH,\n\t\t\t\t    ENCP_VIDEO_MODE_DE_V_HIGH,\n\t\t\t\t    priv->io_base + _REG(ENCP_VIDEO_MODE));\n\n\t\t \n\t\tde_h_begin = modulo(readl_relaxed(priv->io_base +\n\t\t\t\t\t_REG(ENCP_VIDEO_HAVON_BEGIN))\n\t\t\t\t\t+ venc_hdmi_latency,\n\t\t\t\t    total_pixels_venc);\n\t\tde_h_end = modulo(de_h_begin + active_pixels_venc,\n\t\t\t\t  total_pixels_venc);\n\n\t\twritel_relaxed(de_h_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_DE_H_BEGIN));\n\t\twritel_relaxed(de_h_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_DE_H_END));\n\n\t\t \n\t\tde_v_begin_even = readl_relaxed(priv->io_base\n\t\t\t\t\t\t+ _REG(ENCP_VIDEO_VAVON_BLINE));\n\t\tif (mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\t\tde_v_end_even = de_v_begin_even +\n\t\t\t\t\t(mode->vdisplay / 2);\n\t\telse\n\t\t\tde_v_end_even = de_v_begin_even + mode->vdisplay;\n\n\t\twritel_relaxed(de_v_begin_even,\n\t\t\t\tpriv->io_base + _REG(ENCP_DE_V_BEGIN_EVEN));\n\t\twritel_relaxed(de_v_end_even,\n\t\t\t\tpriv->io_base + _REG(ENCP_DE_V_END_EVEN));\n\n\t\t \n\t\tif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\n\t\t\tunsigned int ofld_voav_ofst =\n\t\t\t\treadl_relaxed(priv->io_base +\n\t\t\t\t\t_REG(ENCP_VIDEO_OFLD_VOAV_OFST));\n\t\t\tde_v_begin_odd = to_signed((ofld_voav_ofst & 0xf0) >> 4)\n\t\t\t\t\t\t+ de_v_begin_even\n\t\t\t\t\t\t+ ((mode->vtotal - 1) / 2);\n\t\t\tde_v_end_odd = de_v_begin_odd + (mode->vdisplay / 2);\n\n\t\t\twritel_relaxed(de_v_begin_odd,\n\t\t\t\tpriv->io_base + _REG(ENCP_DE_V_BEGIN_ODD));\n\t\t\twritel_relaxed(de_v_end_odd,\n\t\t\t\tpriv->io_base + _REG(ENCP_DE_V_END_ODD));\n\t\t}\n\n\t\t \n\t\tif ((de_h_end + front_porch_venc) >= total_pixels_venc) {\n\t\t\ths_begin = de_h_end\n\t\t\t\t   + front_porch_venc\n\t\t\t\t   - total_pixels_venc;\n\t\t\tvs_adjust  = 1;\n\t\t} else {\n\t\t\ths_begin = de_h_end\n\t\t\t\t   + front_porch_venc;\n\t\t\tvs_adjust  = 0;\n\t\t}\n\n\t\ths_end = modulo(hs_begin + hsync_pixels_venc,\n\t\t\t\ttotal_pixels_venc);\n\n\t\twritel_relaxed(hs_begin,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_HSO_BEGIN));\n\t\twritel_relaxed(hs_end,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_HSO_END));\n\n\t\t \n\t\tif (de_v_begin_even >=\n\t\t\t\t(sof_lines + vsync_lines + (1 - vs_adjust)))\n\t\t\tvs_bline_evn = de_v_begin_even\n\t\t\t\t\t- sof_lines\n\t\t\t\t\t- vsync_lines\n\t\t\t\t\t- (1 - vs_adjust);\n\t\telse\n\t\t\tvs_bline_evn = mode->vtotal\n\t\t\t\t\t+ de_v_begin_even\n\t\t\t\t\t- sof_lines\n\t\t\t\t\t- vsync_lines\n\t\t\t\t\t- (1 - vs_adjust);\n\n\t\tvs_eline_evn = modulo(vs_bline_evn + vsync_lines,\n\t\t\t\t\tmode->vtotal);\n\n\t\twritel_relaxed(vs_bline_evn,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_BLINE_EVN));\n\t\twritel_relaxed(vs_eline_evn,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_ELINE_EVN));\n\n\t\tvso_begin_evn = hs_begin;\n\t\twritel_relaxed(vso_begin_evn,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_BEGIN_EVN));\n\t\twritel_relaxed(vso_begin_evn,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_END_EVN));\n\n\t\t \n\t\tif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\n\t\t\tvs_bline_odd = (de_v_begin_odd - 1)\n\t\t\t\t\t- sof_lines\n\t\t\t\t\t- vsync_lines;\n\t\t\tvs_eline_odd = (de_v_begin_odd - 1)\n\t\t\t\t\t- vsync_lines;\n\t\t\tvso_begin_odd  = modulo(hs_begin\n\t\t\t\t\t\t+ (total_pixels_venc >> 1),\n\t\t\t\t\t\ttotal_pixels_venc);\n\n\t\t\twritel_relaxed(vs_bline_odd,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_BLINE_ODD));\n\t\t\twritel_relaxed(vs_eline_odd,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_ELINE_ODD));\n\t\t\twritel_relaxed(vso_begin_odd,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_BEGIN_ODD));\n\t\t\twritel_relaxed(vso_begin_odd,\n\t\t\t\tpriv->io_base + _REG(ENCP_DVI_VSO_END_ODD));\n\t\t}\n\n\t\t \n\t\tmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCP);\n\t}\n\n\t \n\t \n\tif (use_enci)\n\t\treg = VPU_HDMI_ENCI_DATA_TO_HDMI;\n\telse\n\t\treg = VPU_HDMI_ENCP_DATA_TO_HDMI;\n\n\t \n\tif (mode->flags & DRM_MODE_FLAG_PHSYNC)\n\t\treg |= VPU_HDMI_INV_HSYNC;\n\n\t \n\tif (mode->flags & DRM_MODE_FLAG_PVSYNC)\n\t\treg |= VPU_HDMI_INV_VSYNC;\n\n\t \n\treg |= ycrcb_map;\n\n\t \n\tif (venc_repeat || yuv420_mode)\n\t\treg |= VPU_HDMI_WR_RATE(2);\n\n\t \n\tif (hdmi_repeat)\n\t\treg |= VPU_HDMI_RD_RATE(2);\n\n\twritel_relaxed(reg, priv->io_base + _REG(VPU_HDMI_SETTING));\n\n\tpriv->venc.hdmi_repeat = hdmi_repeat;\n\tpriv->venc.venc_repeat = venc_repeat;\n\tpriv->venc.hdmi_use_enci = use_enci;\n\n\tpriv->venc.current_mode = MESON_VENC_MODE_HDMI;\n}\nEXPORT_SYMBOL_GPL(meson_venc_hdmi_mode_set);\n\nstatic unsigned short meson_encl_gamma_table[256] = {\n\t0, 4, 8, 12, 16, 20, 24, 28, 32, 36, 40, 44, 48, 52, 56, 60,\n\t64, 68, 72, 76, 80, 84, 88, 92, 96, 100, 104, 108, 112, 116, 120, 124,\n\t128, 132, 136, 140, 144, 148, 152, 156, 160, 164, 168, 172, 176, 180, 184, 188,\n\t192, 196, 200, 204, 208, 212, 216, 220, 224, 228, 232, 236, 240, 244, 248, 252,\n\t256, 260, 264, 268, 272, 276, 280, 284, 288, 292, 296, 300, 304, 308, 312, 316,\n\t320, 324, 328, 332, 336, 340, 344, 348, 352, 356, 360, 364, 368, 372, 376, 380,\n\t384, 388, 392, 396, 400, 404, 408, 412, 416, 420, 424, 428, 432, 436, 440, 444,\n\t448, 452, 456, 460, 464, 468, 472, 476, 480, 484, 488, 492, 496, 500, 504, 508,\n\t512, 516, 520, 524, 528, 532, 536, 540, 544, 548, 552, 556, 560, 564, 568, 572,\n\t576, 580, 584, 588, 592, 596, 600, 604, 608, 612, 616, 620, 624, 628, 632, 636,\n\t640, 644, 648, 652, 656, 660, 664, 668, 672, 676, 680, 684, 688, 692, 696, 700,\n\t704, 708, 712, 716, 720, 724, 728, 732, 736, 740, 744, 748, 752, 756, 760, 764,\n\t768, 772, 776, 780, 784, 788, 792, 796, 800, 804, 808, 812, 816, 820, 824, 828,\n\t832, 836, 840, 844, 848, 852, 856, 860, 864, 868, 872, 876, 880, 884, 888, 892,\n\t896, 900, 904, 908, 912, 916, 920, 924, 928, 932, 936, 940, 944, 948, 952, 956,\n\t960, 964, 968, 972, 976, 980, 984, 988, 992, 996, 1000, 1004, 1008, 1012, 1016, 1020,\n};\n\nstatic void meson_encl_set_gamma_table(struct meson_drm *priv, u16 *data,\n\t\t\t\t       u32 rgb_mask)\n{\n\tint i, ret;\n\tu32 reg;\n\n\twritel_bits_relaxed(L_GAMMA_CNTL_PORT_EN, 0,\n\t\t\t    priv->io_base + _REG(L_GAMMA_CNTL_PORT));\n\n\tret = readl_relaxed_poll_timeout(priv->io_base + _REG(L_GAMMA_CNTL_PORT),\n\t\t\t\t\t reg, reg & L_GAMMA_CNTL_PORT_ADR_RDY, 10, 10000);\n\tif (ret)\n\t\tpr_warn(\"%s: GAMMA ADR_RDY timeout\\n\", __func__);\n\n\twritel_relaxed(L_GAMMA_ADDR_PORT_AUTO_INC | rgb_mask |\n\t\t       FIELD_PREP(L_GAMMA_ADDR_PORT_ADDR, 0),\n\t\t       priv->io_base + _REG(L_GAMMA_ADDR_PORT));\n\n\tfor (i = 0; i < 256; i++) {\n\t\tret = readl_relaxed_poll_timeout(priv->io_base + _REG(L_GAMMA_CNTL_PORT),\n\t\t\t\t\t\t reg, reg & L_GAMMA_CNTL_PORT_WR_RDY,\n\t\t\t\t\t\t 10, 10000);\n\t\tif (ret)\n\t\t\tpr_warn_once(\"%s: GAMMA WR_RDY timeout\\n\", __func__);\n\n\t\twritel_relaxed(data[i], priv->io_base + _REG(L_GAMMA_DATA_PORT));\n\t}\n\n\tret = readl_relaxed_poll_timeout(priv->io_base + _REG(L_GAMMA_CNTL_PORT),\n\t\t\t\t\t reg, reg & L_GAMMA_CNTL_PORT_ADR_RDY, 10, 10000);\n\tif (ret)\n\t\tpr_warn(\"%s: GAMMA ADR_RDY timeout\\n\", __func__);\n\n\twritel_relaxed(L_GAMMA_ADDR_PORT_AUTO_INC | rgb_mask |\n\t\t       FIELD_PREP(L_GAMMA_ADDR_PORT_ADDR, 0x23),\n\t\t       priv->io_base + _REG(L_GAMMA_ADDR_PORT));\n}\n\nvoid meson_encl_load_gamma(struct meson_drm *priv)\n{\n\tmeson_encl_set_gamma_table(priv, meson_encl_gamma_table, L_GAMMA_ADDR_PORT_SEL_R);\n\tmeson_encl_set_gamma_table(priv, meson_encl_gamma_table, L_GAMMA_ADDR_PORT_SEL_G);\n\tmeson_encl_set_gamma_table(priv, meson_encl_gamma_table, L_GAMMA_ADDR_PORT_SEL_B);\n\n\twritel_bits_relaxed(L_GAMMA_CNTL_PORT_EN, L_GAMMA_CNTL_PORT_EN,\n\t\t\t    priv->io_base + _REG(L_GAMMA_CNTL_PORT));\n}\n\nvoid meson_venc_mipi_dsi_mode_set(struct meson_drm *priv,\n\t\t\t\t  const struct drm_display_mode *mode)\n{\n\tunsigned int max_pxcnt;\n\tunsigned int max_lncnt;\n\tunsigned int havon_begin;\n\tunsigned int havon_end;\n\tunsigned int vavon_bline;\n\tunsigned int vavon_eline;\n\tunsigned int hso_begin;\n\tunsigned int hso_end;\n\tunsigned int vso_begin;\n\tunsigned int vso_end;\n\tunsigned int vso_bline;\n\tunsigned int vso_eline;\n\n\tmax_pxcnt = mode->htotal - 1;\n\tmax_lncnt = mode->vtotal - 1;\n\thavon_begin = mode->htotal - mode->hsync_start;\n\thavon_end = havon_begin + mode->hdisplay - 1;\n\tvavon_bline = mode->vtotal - mode->vsync_start;\n\tvavon_eline = vavon_bline + mode->vdisplay - 1;\n\thso_begin = 0;\n\thso_end = mode->hsync_end - mode->hsync_start;\n\tvso_begin = 0;\n\tvso_end = 0;\n\tvso_bline = 0;\n\tvso_eline = mode->vsync_end - mode->vsync_start;\n\n\tmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCL);\n\n\twritel_relaxed(0, priv->io_base + _REG(ENCL_VIDEO_EN));\n\n\twritel_relaxed(ENCL_PX_LN_CNT_SHADOW_EN, priv->io_base + _REG(ENCL_VIDEO_MODE));\n\twritel_relaxed(ENCL_VIDEO_MODE_ADV_VFIFO_EN |\n\t\t       ENCL_VIDEO_MODE_ADV_GAIN_HDTV |\n\t\t       ENCL_SEL_GAMMA_RGB_IN, priv->io_base + _REG(ENCL_VIDEO_MODE_ADV));\n\n\twritel_relaxed(ENCL_VIDEO_FILT_CTRL_BYPASS_FILTER,\n\t\t       priv->io_base + _REG(ENCL_VIDEO_FILT_CTRL));\n\twritel_relaxed(max_pxcnt, priv->io_base + _REG(ENCL_VIDEO_MAX_PXCNT));\n\twritel_relaxed(max_lncnt, priv->io_base + _REG(ENCL_VIDEO_MAX_LNCNT));\n\twritel_relaxed(havon_begin, priv->io_base + _REG(ENCL_VIDEO_HAVON_BEGIN));\n\twritel_relaxed(havon_end, priv->io_base + _REG(ENCL_VIDEO_HAVON_END));\n\twritel_relaxed(vavon_bline, priv->io_base + _REG(ENCL_VIDEO_VAVON_BLINE));\n\twritel_relaxed(vavon_eline, priv->io_base + _REG(ENCL_VIDEO_VAVON_ELINE));\n\n\twritel_relaxed(hso_begin, priv->io_base + _REG(ENCL_VIDEO_HSO_BEGIN));\n\twritel_relaxed(hso_end, priv->io_base + _REG(ENCL_VIDEO_HSO_END));\n\twritel_relaxed(vso_begin, priv->io_base + _REG(ENCL_VIDEO_VSO_BEGIN));\n\twritel_relaxed(vso_end, priv->io_base + _REG(ENCL_VIDEO_VSO_END));\n\twritel_relaxed(vso_bline, priv->io_base + _REG(ENCL_VIDEO_VSO_BLINE));\n\twritel_relaxed(vso_eline, priv->io_base + _REG(ENCL_VIDEO_VSO_ELINE));\n\twritel_relaxed(ENCL_VIDEO_RGBIN_RGB | ENCL_VIDEO_RGBIN_ZBLK,\n\t\t       priv->io_base + _REG(ENCL_VIDEO_RGBIN_CTRL));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(ENCL_TST_MDSEL));\n\twritel_relaxed(0, priv->io_base + _REG(ENCL_TST_Y));\n\twritel_relaxed(0, priv->io_base + _REG(ENCL_TST_CB));\n\twritel_relaxed(0, priv->io_base + _REG(ENCL_TST_CR));\n\twritel_relaxed(1, priv->io_base + _REG(ENCL_TST_EN));\n\twritel_bits_relaxed(ENCL_VIDEO_MODE_ADV_VFIFO_EN, 0,\n\t\t\t    priv->io_base + _REG(ENCL_VIDEO_MODE_ADV));\n\n\twritel_relaxed(1, priv->io_base + _REG(ENCL_VIDEO_EN));\n\n\twritel_relaxed(0, priv->io_base + _REG(L_RGB_BASE_ADDR));\n\twritel_relaxed(0x400, priv->io_base + _REG(L_RGB_COEFF_ADDR));  \n\n\twritel_relaxed(L_DITH_CNTL_DITH10_EN, priv->io_base + _REG(L_DITH_CNTL_ADDR));\n\n\t \n\twritel_relaxed(havon_begin, priv->io_base + _REG(L_OEH_HS_ADDR));\n\twritel_relaxed(havon_end + 1, priv->io_base + _REG(L_OEH_HE_ADDR));\n\twritel_relaxed(vavon_bline, priv->io_base + _REG(L_OEH_VS_ADDR));\n\twritel_relaxed(vavon_eline, priv->io_base + _REG(L_OEH_VE_ADDR));\n\n\t \n\twritel_relaxed(havon_begin, priv->io_base + _REG(L_OEV1_HS_ADDR));\n\twritel_relaxed(havon_end + 1, priv->io_base + _REG(L_OEV1_HE_ADDR));\n\twritel_relaxed(vavon_bline, priv->io_base + _REG(L_OEV1_VS_ADDR));\n\twritel_relaxed(vavon_eline, priv->io_base + _REG(L_OEV1_VE_ADDR));\n\n\t \n\tif (mode->flags & DRM_MODE_FLAG_PHSYNC) {\n\t\twritel_relaxed(hso_begin, priv->io_base + _REG(L_STH1_HS_ADDR));\n\t\twritel_relaxed(hso_end, priv->io_base + _REG(L_STH1_HE_ADDR));\n\t} else {\n\t\twritel_relaxed(hso_end, priv->io_base + _REG(L_STH1_HS_ADDR));\n\t\twritel_relaxed(hso_begin, priv->io_base + _REG(L_STH1_HE_ADDR));\n\t}\n\twritel_relaxed(0, priv->io_base + _REG(L_STH1_VS_ADDR));\n\twritel_relaxed(max_lncnt, priv->io_base + _REG(L_STH1_VE_ADDR));\n\n\t \n\twritel_relaxed(vso_begin, priv->io_base + _REG(L_STV1_HS_ADDR));\n\twritel_relaxed(vso_end, priv->io_base + _REG(L_STV1_HE_ADDR));\n\tif (mode->flags & DRM_MODE_FLAG_PVSYNC) {\n\t\twritel_relaxed(vso_bline, priv->io_base + _REG(L_STV1_VS_ADDR));\n\t\twritel_relaxed(vso_eline, priv->io_base + _REG(L_STV1_VE_ADDR));\n\t} else {\n\t\twritel_relaxed(vso_eline, priv->io_base + _REG(L_STV1_VS_ADDR));\n\t\twritel_relaxed(vso_bline, priv->io_base + _REG(L_STV1_VE_ADDR));\n\t}\n\n\t \n\twritel_relaxed(havon_begin, priv->io_base + _REG(L_DE_HS_ADDR));\n\twritel_relaxed(havon_end + 1, priv->io_base + _REG(L_DE_HE_ADDR));\n\twritel_relaxed(vavon_bline, priv->io_base + _REG(L_DE_VS_ADDR));\n\twritel_relaxed(vavon_eline, priv->io_base + _REG(L_DE_VE_ADDR));\n\n\t \n\twritel_relaxed(hso_begin, priv->io_base + _REG(L_HSYNC_HS_ADDR));\n\twritel_relaxed(hso_end, priv->io_base + _REG(L_HSYNC_HE_ADDR));\n\twritel_relaxed(0, priv->io_base + _REG(L_HSYNC_VS_ADDR));\n\twritel_relaxed(max_lncnt, priv->io_base + _REG(L_HSYNC_VE_ADDR));\n\n\t \n\twritel_relaxed(vso_begin, priv->io_base + _REG(L_VSYNC_HS_ADDR));\n\twritel_relaxed(vso_end, priv->io_base + _REG(L_VSYNC_HE_ADDR));\n\twritel_relaxed(vso_bline, priv->io_base + _REG(L_VSYNC_VS_ADDR));\n\twritel_relaxed(vso_eline, priv->io_base + _REG(L_VSYNC_VE_ADDR));\n\n\twritel_relaxed(0, priv->io_base + _REG(L_INV_CNT_ADDR));\n\twritel_relaxed(L_TCON_MISC_SEL_STV1 | L_TCON_MISC_SEL_STV2,\n\t\t       priv->io_base + _REG(L_TCON_MISC_SEL_ADDR));\n\n\tpriv->venc.current_mode = MESON_VENC_MODE_MIPI_DSI;\n}\nEXPORT_SYMBOL_GPL(meson_venc_mipi_dsi_mode_set);\n\nvoid meson_venci_cvbs_mode_set(struct meson_drm *priv,\n\t\t\t       struct meson_cvbs_enci_mode *mode)\n{\n\tu32 reg;\n\n\tif (mode->mode_tag == priv->venc.current_mode)\n\t\treturn;\n\n\t \n\twritel_relaxed(ENCI_CFILT_CMPT_SEL_HIGH | 0x10,\n\t\t       priv->io_base + _REG(ENCI_CFILT_CTRL));\n\twritel_relaxed(ENCI_CFILT_CMPT_CR_DLY(2) |\n\t\t       ENCI_CFILT_CMPT_CB_DLY(1),\n\t\t       priv->io_base + _REG(ENCI_CFILT_CTRL2));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(VENC_DVI_SETTING));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE));\n\twritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\n\n\t \n\twritel_relaxed(mode->hso_begin,\n\t\t\tpriv->io_base + _REG(ENCI_SYNC_HSO_BEGIN));\n\twritel_relaxed(mode->hso_end,\n\t\t\tpriv->io_base + _REG(ENCI_SYNC_HSO_END));\n\n\t \n\twritel_relaxed(mode->vso_even,\n\t\t\tpriv->io_base + _REG(ENCI_SYNC_VSO_EVNLN));\n\twritel_relaxed(mode->vso_odd,\n\t\t\tpriv->io_base + _REG(ENCI_SYNC_VSO_ODDLN));\n\n\t \n\twritel_relaxed(ENCI_MACV_MAX_AMP_ENABLE_CHANGE |\n\t\t       ENCI_MACV_MAX_AMP_VAL(mode->macv_max_amp),\n\t\t       priv->io_base + _REG(ENCI_MACV_MAX_AMP));\n\n\t \n\twritel_relaxed(mode->video_prog_mode,\n\t\t\tpriv->io_base + _REG(VENC_VIDEO_PROG_MODE));\n\twritel_relaxed(mode->video_mode,\n\t\t\tpriv->io_base + _REG(ENCI_VIDEO_MODE));\n\n\t \n\twritel_relaxed(ENCI_VIDEO_MODE_ADV_DMXMD(2) |\n\t\t       ENCI_VIDEO_MODE_ADV_VBICTL_LINE_17_22 |\n\t\t       ENCI_VIDEO_MODE_ADV_YBW_HIGH,\n\t\t       priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\n\n\twritel(mode->sch_adjust, priv->io_base + _REG(ENCI_VIDEO_SCH));\n\n\t \n\twritel_relaxed(0x07, priv->io_base + _REG(ENCI_SYNC_MODE));\n\n\t \n\twritel_relaxed(mode->yc_delay, priv->io_base + _REG(ENCI_YC_DELAY));\n\n\t \n\twritel_relaxed(mode->pixel_start,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_START));\n\twritel_relaxed(mode->pixel_end,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_END));\n\n\twritel_relaxed(mode->top_field_line_start,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_START));\n\twritel_relaxed(mode->top_field_line_end,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_END));\n\n\twritel_relaxed(mode->bottom_field_line_start,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_START));\n\twritel_relaxed(mode->bottom_field_line_end,\n\t\t\tpriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_END));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(VENC_SYNC_ROUTE));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(ENCI_DBG_PX_RST));\n\n\t \n\twritel_relaxed(ENCI_VFIFO2VD_CTL_ENABLE |\n\t\t       ENCI_VFIFO2VD_CTL_VD_SEL(0x4e),\n\t\t       priv->io_base + _REG(ENCI_VFIFO2VD_CTL));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_SETTING));\n\n\t \n\t \n\treg = VENC_UPSAMPLE_CTRL_F0_2_CLK_RATIO | VENC_UPSAMPLE_CTRL_F1_EN |\n\t\tVENC_UPSAMPLE_CTRL_F1_UPSAMPLE_EN;\n\n\t \n\twritel_relaxed(VENC_UPSAMPLE_CTRL_INTERLACE_HIGH_LUMA | reg,\n\t\t       priv->io_base + _REG(VENC_UPSAMPLE_CTRL0));\n\n\t \n\twritel_relaxed(VENC_UPSAMPLE_CTRL_INTERLACE_PB | reg,\n\t\t       priv->io_base + _REG(VENC_UPSAMPLE_CTRL1));\n\n\t \n\twritel_relaxed(VENC_UPSAMPLE_CTRL_INTERLACE_PR | reg,\n\t\t       priv->io_base + _REG(VENC_UPSAMPLE_CTRL2));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL0));\n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL1));\n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL2));\n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL3));\n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL4));\n\twritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL5));\n\n\t \n\tmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCI);\n\n\t \n\twritel_relaxed(VENC_VDAC_FIFO_EN_ENCI_ENABLE,\n\t\t       priv->io_base + _REG(VENC_VDAC_FIFO_CTRL));\n\n\t \n\twritel_relaxed(0x11, priv->io_base + _REG(ENCI_DACSEL_0));\n\twritel_relaxed(0x11, priv->io_base + _REG(ENCI_DACSEL_1));\n\n\t \n\twritel_relaxed(ENCI_VIDEO_EN_ENABLE,\n\t\t       priv->io_base + _REG(ENCI_VIDEO_EN));\n\n\t \n\twritel_relaxed(mode->video_saturation,\n\t\t\tpriv->io_base + _REG(ENCI_VIDEO_SAT));\n\twritel_relaxed(mode->video_contrast,\n\t\t\tpriv->io_base + _REG(ENCI_VIDEO_CONT));\n\twritel_relaxed(mode->video_brightness,\n\t\t\tpriv->io_base + _REG(ENCI_VIDEO_BRIGHT));\n\twritel_relaxed(mode->video_hue,\n\t\t\tpriv->io_base + _REG(ENCI_VIDEO_HUE));\n\n\t \n\twritel_relaxed(VENC_VDAC_DAC0_FILT_CTRL0_EN,\n\t\t       priv->io_base + _REG(VENC_VDAC_DAC0_FILT_CTRL0));\n\twritel_relaxed(0xfc48, priv->io_base + _REG(VENC_VDAC_DAC0_FILT_CTRL1));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(ENCI_MACV_N0));\n\n\t \n\twritel_relaxed(mode->analog_sync_adj,\n\t\t\tpriv->io_base + _REG(ENCI_SYNC_ADJ));\n\n\tpriv->venc.current_mode = mode->mode_tag;\n}\n\n \nunsigned int meson_venci_get_field(struct meson_drm *priv)\n{\n\treturn readl_relaxed(priv->io_base + _REG(ENCI_INFO_READ)) & BIT(29);\n}\n\nvoid meson_venc_enable_vsync(struct meson_drm *priv)\n{\n\tswitch (priv->venc.current_mode) {\n\tcase MESON_VENC_MODE_MIPI_DSI:\n\t\twritel_relaxed(VENC_INTCTRL_ENCP_LNRST_INT_EN,\n\t\t\t       priv->io_base + _REG(VENC_INTCTRL));\n\t\tbreak;\n\tdefault:\n\t\twritel_relaxed(VENC_INTCTRL_ENCI_LNRST_INT_EN,\n\t\t\t       priv->io_base + _REG(VENC_INTCTRL));\n\t}\n\tregmap_update_bits(priv->hhi, HHI_GCLK_MPEG2, BIT(25), BIT(25));\n}\n\nvoid meson_venc_disable_vsync(struct meson_drm *priv)\n{\n\tregmap_update_bits(priv->hhi, HHI_GCLK_MPEG2, BIT(25), 0);\n\twritel_relaxed(0, priv->io_base + _REG(VENC_INTCTRL));\n}\n\nvoid meson_venc_init(struct meson_drm *priv)\n{\n\t \n\tif (meson_vpu_is_compatible(priv, VPU_COMPATIBLE_G12A)) {\n\t\tregmap_write(priv->hhi, HHI_VDAC_CNTL0_G12A, 0);\n\t\tregmap_write(priv->hhi, HHI_VDAC_CNTL1_G12A, 8);\n\t} else {\n\t\tregmap_write(priv->hhi, HHI_VDAC_CNTL0, 0);\n\t\tregmap_write(priv->hhi, HHI_VDAC_CNTL1, 8);\n\t}\n\n\t \n\twritel_relaxed(0xff, priv->io_base + _REG(VENC_VDAC_SETTING));\n\n\t \n\tregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL0, 0);\n\n\t \n\twritel_bits_relaxed(VPU_HDMI_ENCI_DATA_TO_HDMI |\n\t\t\t    VPU_HDMI_ENCP_DATA_TO_HDMI, 0,\n\t\t\t    priv->io_base + _REG(VPU_HDMI_SETTING));\n\n\t \n\twritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_EN));\n\twritel_relaxed(0, priv->io_base + _REG(ENCP_VIDEO_EN));\n\twritel_relaxed(0, priv->io_base + _REG(ENCL_VIDEO_EN));\n\n\t \n\tmeson_venc_disable_vsync(priv);\n\n\tpriv->venc.current_mode = MESON_VENC_MODE_NONE;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}