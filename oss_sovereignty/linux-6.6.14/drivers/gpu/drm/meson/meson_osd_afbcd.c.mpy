{
  "module_name": "meson_osd_afbcd.c",
  "hash_id": "277a8738c42c511ac9c9d0193d81b4eb0c647bbe9b631616b2173f284c08365d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/meson/meson_osd_afbcd.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n\n#include <drm/drm_print.h>\n#include <drm/drm_fourcc.h>\n\n#include \"meson_drv.h\"\n#include \"meson_registers.h\"\n#include \"meson_viu.h\"\n#include \"meson_rdma.h\"\n#include \"meson_osd_afbcd.h\"\n\n \n\n \n\n#define OSD1_AFBCD_RGB32\t0x15\n\nstatic int meson_gxm_afbcd_pixel_fmt(u64 modifier, uint32_t format)\n{\n\tswitch (format) {\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_ABGR8888:\n\t\treturn OSD1_AFBCD_RGB32;\n\t \n\tdefault:\n\t\tDRM_DEBUG(\"unsupported afbc format[%08x]\\n\", format);\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic bool meson_gxm_afbcd_supported_fmt(u64 modifier, uint32_t format)\n{\n\tif (modifier & AFBC_FORMAT_MOD_BLOCK_SIZE_32x8)\n\t\treturn false;\n\n\tif (!(modifier & AFBC_FORMAT_MOD_YTR))\n\t\treturn false;\n\n\treturn meson_gxm_afbcd_pixel_fmt(modifier, format) >= 0;\n}\n\nstatic int meson_gxm_afbcd_reset(struct meson_drm *priv)\n{\n\twritel_relaxed(VIU_SW_RESET_OSD1_AFBCD,\n\t\t       priv->io_base + _REG(VIU_SW_RESET));\n\twritel_relaxed(0, priv->io_base + _REG(VIU_SW_RESET));\n\n\treturn 0;\n}\n\nstatic int meson_gxm_afbcd_init(struct meson_drm *priv)\n{\n\treturn 0;\n}\n\nstatic void meson_gxm_afbcd_exit(struct meson_drm *priv)\n{\n\tmeson_gxm_afbcd_reset(priv);\n}\n\nstatic int meson_gxm_afbcd_enable(struct meson_drm *priv)\n{\n\twritel_relaxed(FIELD_PREP(OSD1_AFBCD_ID_FIFO_THRD, 0x40) |\n\t\t       OSD1_AFBCD_DEC_ENABLE,\n\t\t       priv->io_base + _REG(OSD1_AFBCD_ENABLE));\n\n\treturn 0;\n}\n\nstatic int meson_gxm_afbcd_disable(struct meson_drm *priv)\n{\n\twritel_bits_relaxed(OSD1_AFBCD_DEC_ENABLE, 0,\n\t\t\t    priv->io_base + _REG(OSD1_AFBCD_ENABLE));\n\n\treturn 0;\n}\n\nstatic int meson_gxm_afbcd_setup(struct meson_drm *priv)\n{\n\tu32 conv_lbuf_len;\n\tu32 mode = FIELD_PREP(OSD1_AFBCD_MIF_URGENT, 3) |\n\t\t   FIELD_PREP(OSD1_AFBCD_HOLD_LINE_NUM, 4) |\n\t\t   FIELD_PREP(OSD1_AFBCD_RGBA_EXCHAN_CTRL, 0x34) |\n\t\t   meson_gxm_afbcd_pixel_fmt(priv->afbcd.modifier,\n\t\t\t\t\t     priv->afbcd.format);\n\n\tif (priv->afbcd.modifier & AFBC_FORMAT_MOD_SPARSE)\n\t\tmode |= OSD1_AFBCD_HREG_HALF_BLOCK;\n\n\tif (priv->afbcd.modifier & AFBC_FORMAT_MOD_SPLIT)\n\t\tmode |= OSD1_AFBCD_HREG_BLOCK_SPLIT;\n\n\twritel_relaxed(mode, priv->io_base + _REG(OSD1_AFBCD_MODE));\n\n\twritel_relaxed(FIELD_PREP(OSD1_AFBCD_HREG_VSIZE_IN,\n\t\t\t\t  priv->viu.osd1_width) |\n\t\t       FIELD_PREP(OSD1_AFBCD_HREG_HSIZE_IN,\n\t\t\t\t  priv->viu.osd1_height),\n\t\t       priv->io_base + _REG(OSD1_AFBCD_SIZE_IN));\n\n\twritel_relaxed(priv->viu.osd1_addr >> 4,\n\t\t       priv->io_base + _REG(OSD1_AFBCD_HDR_PTR));\n\twritel_relaxed(priv->viu.osd1_addr >> 4,\n\t\t       priv->io_base + _REG(OSD1_AFBCD_FRAME_PTR));\n\t \n\twritel_relaxed((0xe4 << 24) | (priv->viu.osd1_addr & 0xffffff),\n\t\t       priv->io_base + _REG(OSD1_AFBCD_CHROMA_PTR));\n\n\tif (priv->viu.osd1_width <= 128)\n\t\tconv_lbuf_len = 32;\n\telse if (priv->viu.osd1_width <= 256)\n\t\tconv_lbuf_len = 64;\n\telse if (priv->viu.osd1_width <= 512)\n\t\tconv_lbuf_len = 128;\n\telse if (priv->viu.osd1_width <= 1024)\n\t\tconv_lbuf_len = 256;\n\telse if (priv->viu.osd1_width <= 2048)\n\t\tconv_lbuf_len = 512;\n\telse\n\t\tconv_lbuf_len = 1024;\n\n\twritel_relaxed(conv_lbuf_len,\n\t\t       priv->io_base + _REG(OSD1_AFBCD_CONV_CTRL));\n\n\twritel_relaxed(FIELD_PREP(OSD1_AFBCD_DEC_PIXEL_BGN_H, 0) |\n\t\t       FIELD_PREP(OSD1_AFBCD_DEC_PIXEL_END_H,\n\t\t\t\t  priv->viu.osd1_width - 1),\n\t\t       priv->io_base + _REG(OSD1_AFBCD_PIXEL_HSCOPE));\n\n\twritel_relaxed(FIELD_PREP(OSD1_AFBCD_DEC_PIXEL_BGN_V, 0) |\n\t\t       FIELD_PREP(OSD1_AFBCD_DEC_PIXEL_END_V,\n\t\t\t\t  priv->viu.osd1_height - 1),\n\t\t       priv->io_base + _REG(OSD1_AFBCD_PIXEL_VSCOPE));\n\n\treturn 0;\n}\n\nstruct meson_afbcd_ops meson_afbcd_gxm_ops = {\n\t.init = meson_gxm_afbcd_init,\n\t.exit = meson_gxm_afbcd_exit,\n\t.reset = meson_gxm_afbcd_reset,\n\t.enable = meson_gxm_afbcd_enable,\n\t.disable = meson_gxm_afbcd_disable,\n\t.setup = meson_gxm_afbcd_setup,\n\t.supported_fmt = meson_gxm_afbcd_supported_fmt,\n};\n\n \n\n \nenum {\n\tMAFBC_FMT_RGB565 = 0,\n\tMAFBC_FMT_RGBA5551,\n\tMAFBC_FMT_RGBA1010102,\n\tMAFBC_FMT_YUV420_10B,\n\tMAFBC_FMT_RGB888,\n\tMAFBC_FMT_RGBA8888,\n\tMAFBC_FMT_RGBA4444,\n\tMAFBC_FMT_R8,\n\tMAFBC_FMT_RG88,\n\tMAFBC_FMT_YUV420_8B,\n\tMAFBC_FMT_YUV422_8B = 11,\n\tMAFBC_FMT_YUV422_10B = 14,\n};\n\nstatic int meson_g12a_afbcd_pixel_fmt(u64 modifier, uint32_t format)\n{\n\tswitch (format) {\n\tcase DRM_FORMAT_XRGB8888:\n\tcase DRM_FORMAT_ARGB8888:\n\t\t \n\t\tif (modifier & AFBC_FORMAT_MOD_YTR)\n\t\t\treturn -EINVAL;\n\t\tfallthrough;\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_ABGR8888:\n\t\treturn MAFBC_FMT_RGBA8888;\n\tcase DRM_FORMAT_RGB888:\n\t\t \n\t\tif (modifier & AFBC_FORMAT_MOD_YTR)\n\t\t\treturn -EINVAL;\n\t\treturn MAFBC_FMT_RGB888;\n\tcase DRM_FORMAT_RGB565:\n\t\t \n\t\tif (modifier & AFBC_FORMAT_MOD_YTR)\n\t\t\treturn -EINVAL;\n\t\treturn MAFBC_FMT_RGB565;\n\t \n\tdefault:\n\t\tDRM_DEBUG(\"unsupported afbc format[%08x]\\n\", format);\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int meson_g12a_afbcd_bpp(uint32_t format)\n{\n\tswitch (format) {\n\tcase DRM_FORMAT_XRGB8888:\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_ABGR8888:\n\t\treturn 32;\n\tcase DRM_FORMAT_RGB888:\n\t\treturn 24;\n\tcase DRM_FORMAT_RGB565:\n\t\treturn 16;\n\t \n\tdefault:\n\t\tDRM_ERROR(\"unsupported afbc format[%08x]\\n\", format);\n\t\treturn 0;\n\t}\n}\n\nstatic int meson_g12a_afbcd_fmt_to_blk_mode(u64 modifier, uint32_t format)\n{\n\tswitch (format) {\n\tcase DRM_FORMAT_XRGB8888:\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_ABGR8888:\n\t\treturn OSD_MALI_COLOR_MODE_RGBA8888;\n\tcase DRM_FORMAT_RGB888:\n\t\treturn OSD_MALI_COLOR_MODE_RGB888;\n\tcase DRM_FORMAT_RGB565:\n\t\treturn OSD_MALI_COLOR_MODE_RGB565;\n\t \n\tdefault:\n\t\tDRM_DEBUG(\"unsupported afbc format[%08x]\\n\", format);\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic bool meson_g12a_afbcd_supported_fmt(u64 modifier, uint32_t format)\n{\n\treturn meson_g12a_afbcd_pixel_fmt(modifier, format) >= 0;\n}\n\nstatic int meson_g12a_afbcd_reset(struct meson_drm *priv)\n{\n\tmeson_rdma_reset(priv);\n\n\tmeson_rdma_writel_sync(priv, VIU_SW_RESET_G12A_AFBC_ARB |\n\t\t\t       VIU_SW_RESET_G12A_OSD1_AFBCD,\n\t\t\t       VIU_SW_RESET);\n\tmeson_rdma_writel_sync(priv, 0, VIU_SW_RESET);\n\n\treturn 0;\n}\n\nstatic int meson_g12a_afbcd_init(struct meson_drm *priv)\n{\n\tint ret;\n\n\tret = meson_rdma_init(priv);\n\tif (ret)\n\t\treturn ret;\n\n\tmeson_rdma_setup(priv);\n\n\t \n\twritel_bits_relaxed(MALI_AFBCD_MANUAL_RESET, MALI_AFBCD_MANUAL_RESET,\n\t\t\t    priv->io_base + _REG(MALI_AFBCD_TOP_CTRL));\n\n\treturn 0;\n}\n\nstatic void meson_g12a_afbcd_exit(struct meson_drm *priv)\n{\n\tmeson_g12a_afbcd_reset(priv);\n\tmeson_rdma_free(priv);\n}\n\nstatic int meson_g12a_afbcd_enable(struct meson_drm *priv)\n{\n\tmeson_rdma_writel_sync(priv, VPU_MAFBC_IRQ_SURFACES_COMPLETED |\n\t\t\t       VPU_MAFBC_IRQ_CONFIGURATION_SWAPPED |\n\t\t\t       VPU_MAFBC_IRQ_DECODE_ERROR |\n\t\t\t       VPU_MAFBC_IRQ_DETILING_ERROR,\n\t\t\t       VPU_MAFBC_IRQ_MASK);\n\n\tmeson_rdma_writel_sync(priv, VPU_MAFBC_S0_ENABLE,\n\t\t\t       VPU_MAFBC_SURFACE_CFG);\n\n\tmeson_rdma_writel_sync(priv, VPU_MAFBC_DIRECT_SWAP,\n\t\t\t       VPU_MAFBC_COMMAND);\n\n\t \n\tmeson_rdma_flush(priv);\n\n\treturn 0;\n}\n\nstatic int meson_g12a_afbcd_disable(struct meson_drm *priv)\n{\n\twritel_bits_relaxed(VPU_MAFBC_S0_ENABLE, 0,\n\t\t\t    priv->io_base + _REG(VPU_MAFBC_SURFACE_CFG));\n\n\treturn 0;\n}\n\nstatic int meson_g12a_afbcd_setup(struct meson_drm *priv)\n{\n\tu32 format = meson_g12a_afbcd_pixel_fmt(priv->afbcd.modifier,\n\t\t\t\t\t\tpriv->afbcd.format);\n\n\tif (priv->afbcd.modifier & AFBC_FORMAT_MOD_YTR)\n\t\tformat |= VPU_MAFBC_YUV_TRANSFORM;\n\n\tif (priv->afbcd.modifier & AFBC_FORMAT_MOD_SPLIT)\n\t\tformat |= VPU_MAFBC_BLOCK_SPLIT;\n\n\tif (priv->afbcd.modifier & AFBC_FORMAT_MOD_TILED)\n\t\tformat |= VPU_MAFBC_TILED_HEADER_EN;\n\n\tif ((priv->afbcd.modifier & AFBC_FORMAT_MOD_BLOCK_SIZE_MASK) ==\n\t\tAFBC_FORMAT_MOD_BLOCK_SIZE_32x8)\n\t\tformat |= FIELD_PREP(VPU_MAFBC_SUPER_BLOCK_ASPECT, 1);\n\n\tmeson_rdma_writel_sync(priv, format,\n\t\t\t       VPU_MAFBC_FORMAT_SPECIFIER_S0);\n\n\tmeson_rdma_writel_sync(priv, priv->viu.osd1_addr,\n\t\t\t       VPU_MAFBC_HEADER_BUF_ADDR_LOW_S0);\n\tmeson_rdma_writel_sync(priv, 0,\n\t\t\t       VPU_MAFBC_HEADER_BUF_ADDR_HIGH_S0);\n\n\tmeson_rdma_writel_sync(priv, priv->viu.osd1_width,\n\t\t\t       VPU_MAFBC_BUFFER_WIDTH_S0);\n\tmeson_rdma_writel_sync(priv, ALIGN(priv->viu.osd1_height, 32),\n\t\t\t       VPU_MAFBC_BUFFER_HEIGHT_S0);\n\n\tmeson_rdma_writel_sync(priv, 0,\n\t\t\t       VPU_MAFBC_BOUNDING_BOX_X_START_S0);\n\tmeson_rdma_writel_sync(priv, priv->viu.osd1_width - 1,\n\t\t\t       VPU_MAFBC_BOUNDING_BOX_X_END_S0);\n\tmeson_rdma_writel_sync(priv, 0,\n\t\t\t       VPU_MAFBC_BOUNDING_BOX_Y_START_S0);\n\tmeson_rdma_writel_sync(priv, priv->viu.osd1_height - 1,\n\t\t\t       VPU_MAFBC_BOUNDING_BOX_Y_END_S0);\n\n\tmeson_rdma_writel_sync(priv, MESON_G12A_AFBCD_OUT_ADDR,\n\t\t\t       VPU_MAFBC_OUTPUT_BUF_ADDR_LOW_S0);\n\tmeson_rdma_writel_sync(priv, 0,\n\t\t\t       VPU_MAFBC_OUTPUT_BUF_ADDR_HIGH_S0);\n\n\tmeson_rdma_writel_sync(priv, priv->viu.osd1_width *\n\t\t\t       (meson_g12a_afbcd_bpp(priv->afbcd.format) / 8),\n\t\t\t       VPU_MAFBC_OUTPUT_BUF_STRIDE_S0);\n\n\treturn 0;\n}\n\nstruct meson_afbcd_ops meson_afbcd_g12a_ops = {\n\t.init = meson_g12a_afbcd_init,\n\t.exit = meson_g12a_afbcd_exit,\n\t.reset = meson_g12a_afbcd_reset,\n\t.enable = meson_g12a_afbcd_enable,\n\t.disable = meson_g12a_afbcd_disable,\n\t.setup = meson_g12a_afbcd_setup,\n\t.fmt_to_blk_mode = meson_g12a_afbcd_fmt_to_blk_mode,\n\t.supported_fmt = meson_g12a_afbcd_supported_fmt,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}